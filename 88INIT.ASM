
;	LSX-Dodgers INIT
;	PC-8801mkIISR

	JP	START
	DW	MACW
	DW	VER

START:
	DI
	IM	2
	LD	SP,START
	CALL	INIT		;NZならAUTOEXECを実行
	LD	HL,0
	PUSH	HL
	RET	Z
	LD	DE,AUTOD
	JP	_COMANL

INIT:
	IN	A,(032H)
	RES	4,A		;高速RAMアクセスモード
	OUT	(032H),A

	LD	HL,0F3C8H	;テキストをクリア
	LD	DE,080E8H
	LD	C,' '
	LD	A,25
TVCL1:
	LD	B,80
TVCL2:
	LD	(HL),C
	INC	HL
	DJNZ	TVCL2
	LD	B,20
TVCL3:
	LD	(HL),D
	INC	L
	LD	(HL),E
	INC	HL
	DJNZ	TVCL3
	DEC	A
	JR	NZ,TVCL1

	IN	A,(032H)
	OR	010H		;高速RAMアクセスモードOFF
	OUT	(032H),A

	XOR	A
	LD	(WKE6),A
	CPL
	LD	(WKE4),A

	CALL	INIT_CRTC
BANK:
	IN	A,(0E2H)
	LD	B,0E3H		;拡張RAM バンク選択
	LD	HL,07F00H
	DI
	LD	A,011H
	OUT	(0E2H),A	;拡張RAM リード/ライト制御
	OUT	(C),L
	LD	A,(0)
	CP	0EBH
	JR	NZ,BANK1
	LD	A,02BH
	LD	(BANKDV),A
BANK1:
	LD	A,011H
	OUT	(0E2H),A	;拡張RAM リード/ライト制御
	OUT	(C),L
	LD	E,(HL)
	LD	A,E
	ADD	A,0A5H
	LD	(HL),A
	CP	(HL)
	LD	(HL),E
	JR	NZ,BANK2
	INC	L
	BIT	4,L
	JR	Z,BANK1
BANK2:
	XOR	A
	OUT	(0E2H),A	;拡張RAM リード/ライト制御
	LD	A,L
	OR	A
	JR	Z,NOBANK
	LD	H,0
	ADD	HL,HL	;*2
	ADD	HL,HL	;*4
	ADD	HL,HL	;*8
	ADD	HL,HL	;*16
	ADD	HL,HL	;*32
	DEC	HL	;-1
	DEC	HL	;-2
	DEC	HL	;-3
	LD	(BANKCL),HL
	CALL	CALC_FATLN
	LD	(BANKFL),A
NOBANK:
				;初期化
	XOR	A		;イニシャライズ
	CALL	PUTCOM
	LD	A,16H		;高速レシーブメモリ
	CALL	PUTCOM
	LD	A,DSS/256	;開始アドレスH
	CALL	PUTDAT
	XOR	A		;開始アドレスL
	CALL	PUTDAT
	LD	BC,AT_DSSE-AT_DSS
	BIT	0,C
	JR	Z,SUBPG1
	INC	BC		;偶数にする
SUBPG1:
	LD	A,B		;バイト数H
	CALL	PUTDAT
	LD	A,C
	CALL	PUTDAT
	LD	HL,AT_DSS
	CALL	FPUTDAT

	LD	HL,0
	LD	B,05CH
	LD	A,0FFH		;RST 38H
	CALL	FILL_MEMORY
	LD	B,0A4H
	XOR	A
	CALL	FILL_MEMORY

	LD	A,0C3H		;JP
	LD	HL,CPM_WBOOT
	LD	(00000H),A
	LD	(00001H),HL	;IPL

	LD	HL,MACW		;3 bit7  DPB Compatible LA(1)
	LD	(00003H),HL	;  bit6-0 Machine
;				;4 LSX-Dodgers(01DH)
	LD	HL,BDOS
	LD	(00005H),A
	LD	(00006H),HL	;BDOS

	LD	HL,BIOS
	LD	(00018H),A
	LD	(00019H),HL	;BIOS-ROM

	LD	HL,TRAP38	;TRAP38
	LD	(00038H),A
	LD	(00039H),HL	;RST 038H

	LD	A,CPM_BOOT/256
	LD	(0000BH),A

	LD	A,0E9H		;JP (HL)
	LD	(0000FH),A

	LD	A,(_FATBF+1)
	LD	(00013H),A

	LD	A,(_DTBUF+1)
	LD	(00017H),A

	LD	A,KEYBF/256
	LD	(0001BH),A

	LD	A,KBUF/256
	LD	(0001FH),A

	LD	HL,VER
	LD	(0005AH),HL

	LD	HL,INIMES
	CALL	MSX
INIT1:
	DI
	LD	DE,0FF00H
	LD	B,0
	CALL	ZERO_MEMORY_DE
	LD	HL,EXTBIO
	LD	(HL),0C9H	;RET
	INC	HL
	LD	B,TRAP38-EXTBIO-1
	LD	A,0FFH		;RST 38H
	CALL	FILL_MEMORY
	LD	HL,AT_TRAP38
	LD	DE,TRAP38
	LD	BC,AT_TRAPE-AT_TRAP38
	LDIR

	CALL	CHKEY
	CP	3
	RET

CALC_FATLN:	;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
	LD	E,L
	LD	D,H
	ADD	HL,HL	;*2
	ADD	HL,DE	;*3
	SRL	H	;/2
	RR	L	;1クラスタ辺り1.5バイト必要
	LD	DE,511	;切り上げる
	ADD	HL,DE
	LD	A,H
	SRL	A
	RET

AUTOD:	DB	"AUTOEXEC "
AUTODV:	DB	"A:",0

INIMES:	DB	00CH,"LSX-Dodgers for PC-8801mkIISR v"
	DB	030H + VER_1, '.'
	DB	030H + VER_2 ,030H + VER_3
	DB	"a"
	DB	' Gaku',0DH,0AH
	DB	0

AT_TRAP38:
	ORG	TRAP38,AT_TRAP38-OFFSET
	LD	HL,0
	EX	(SP),HL
	LD	A,'$'
	CALL	MSG_A
	DEC	HL
	LD	A,H
	CALL	PRHX
	LD	A,L
PRHX:
	PUSH	AF
	RLCA
	RLCA
	RLCA
	RLCA
	CALL	PRHX2
	POP	AF
PRHX2:
	AND	00FH
	CP	10
	CCF
	ADC	A,'0'
	DAA
	JP	MSG_A
	DS	4
	ORG	$$+OFFSET	;$DEPHASE
AT_TRAPE:
