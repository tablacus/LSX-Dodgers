0000                ;	LSX-Dodgers for X1/turbo/Z
0000                ;	Programmed by
0000                ;	Gaku (Lovers/Tablacus)
0000                
0000                	INCLUDE	"LDDEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                
0000 00 00 1D 00    MAC	EQU	01D00H		;X1
0000 00 00 00 01    VER_1   EQU	1
0000 00 00 00 04    VER_2   EQU	4
0000 00 00 00 02    VER_3   EQU	2
0000 00 00 01 46    VER	EQU	VER_1 * 256 + VER_2 * 17 + VER_3
0000                
0000 00 00 00 05    SYSTEM	EQU	00005H
0000 00 00 00 0F    JP_HL	EQU	0000FH
0000 00 00 00 5C    FCB1	EQU	0005CH
0000 00 00 00 6C    FCB2	EQU	0006CH
0000 00 00 00 5D    FCB1FN	EQU	FCB1+1
0000 00 00 00 6D    FCB2FN	EQU	FCB2+1
0000 00 00 00 80    DTA1	EQU	00080H
0000                
0000 00 00 CB 00    RUN	EQU	0CB00H
0000 00 00 D1 06    BDOS	EQU	0D106H
0000 00 00 F2 00    FATBF	EQU	0F200H
0000 00 00 FA 00    DTBUF	EQU	0FA00H
0000 00 00 FE 00    KEYBF	EQU	0FE00H
0000 00 00 FF 00    KBUF	EQU	0FF00H
0000 00 00 FF CA    EXTSP	EQU	0FFCAH
0000 00 00 FF CA    EXTBIO	EQU	0FFCAH
0000 00 00 FF D9    TRAP38	EQU	0FFD9H
0000 00 00 00 18    LINE	EQU	24
0000                
0000                	ORG	RUN-7
CAF9                
CAF9                ;	MSX BINARY HEADER
CAF9 FE             	DB	0FEH
CAFA                ;	MSX BINARY START ADDRESS
CAFA 00 CB          	DW	RUN
CAFC                ;	MSX BINARY END ADDRESS
CAFC 00 F2          	DW	LDEND
CAFE                ;	MSX BINARY EXEC ADDRESS
CAFE 00 CB          	DW	RUN
CB00                
CB00                	INCLUDE	"LDINIT.ASM"
CB00                
CB00                ;	LSX-Dodgers INIT
CB00                
CB00 C3 07 CB       	JP	START
CB03 00 1D          MACHINE:DW	MAC
CB05 46 01          VERSION:DW	VER
CB07                
CB07                START:
CB07 F3             	DI
CB08 ED 5E          	IM	2
CB0A 31 CA FF       	LD	SP,EXTSP
CB0D CD 1B CB       	CALL	INIT		;NZならAUTOEXECを実行
CB10 21 00 00       	LD	HL,0
CB13 E5             	PUSH	HL
CB14 C8             	RET	Z
CB15 11 BB CE       	LD	DE,AUTOD
CB18 C3 FD EF       	JP	_COMANL
CB1B                
CB1B                INIT:
CB1B 3E 1E          	LD	A,01EH
CB1D D3 00          	OUT	(0),A
CB1F                
CB1F 01 00 00       	LD	BC,0
CB22 ED 43 8C EF    	LD	(_CTC),BC
CB26 01 04 0A       	LD	BC,00A04H
CB29 CD 65 CE       	CALL	CHKCTC
CB2C 01 04 07       	LD	BC,00704H
CB2F CD 65 CE       	CALL	CHKCTC
CB32 01 A8 1F       	LD	BC,01FA8H
CB35 CD 65 CE       	CALL	CHKCTC
CB38 01 A0 1F       	LD	BC,01FA0H
CB3B CD 65 CE       	CALL	CHKCTC
CB3E                ;
CB3E                INISIO:
CB3E 01 91 1F       	LD	BC,01F91H	;INIT SIO
CB41 16 01          	LD	D,1
CB43 ED 51          	OUT	(C),D
CB45                
CB45 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB47 0E 93          	LD	C,093H
CB49 ED 51          	OUT	(C),D
CB4B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB4D 0E 99          	LD	C,099H		;INIT SIO
CB4F 16 01          	LD	D,1
CB51 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB53 0E 9B          	LD	C,09BH
CB55 ED 51          	OUT	(C),D
CB57 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB59                
CB59 0E 80          	LD	C,080H		;INIT DMA
CB5B 21 06 C3       	LD	HL,0C306H
CB5E                INIDMA:
CB5E ED 61          	OUT	(C),H
CB60 2D             	DEC	L
CB61 20 FB          	JR	NZ,INIDMA
CB63                
CB63 3E E4          	LD	A,0E4H
CB65 CD 3F DF       	CALL	COMOUT
CB68 AF             	XOR	A
CB69 CD 19 DF       	CALL	OT49SB
CB6C                
CB6C 3E EF          	LD	A,INTVEC/256
CB6E ED 47          	LD	I,A
CB70                
CB70 ED 4B 8C EF    	LD	BC,(_CTC)
CB74 0B             	DEC	BC
CB75 0B             	DEC	BC
CB76                
CB76 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB78 3E C0          	LD	A,CTC0
CB7A ED 79          	OUT	(C),A
CB7C                
CB7C 0C             	INC	C
CB7D 3E 47          	LD	A,047H
CB7F ED 79          	OUT	(C),A
CB81 3E 0D          	LD	A,13		;Baudrate 9600-13
CB83 ED 79          	OUT	(C),A
CB85                
CB85 79             	LD	A,C
CB86 D6 10          	SUB	010H
CB88 4F             	LD	C,A
CB89                ;	LD	(SIOAD+1),BC
CB89                ;	LD	(SIOAD0+1),BC
CB89                ;	LD	(SIOAD1+1),BC
CB89                
CB89 21 1D CF       	LD	HL,SIODATA
CB8C                SINIT1:
CB8C 7E             	LD	A,(HL)
CB8D 23             	INC	HL
CB8E FE FF          	CP	0FFH
CB90 28 04          	JR	Z,SINIT2
CB92 ED 79          	OUT	(C),A
CB94 18 F6          	JR	SINIT1
CB96                SINIT2:
CB96 3E E4          	LD	A,0E4H
CB98 CD 3F DF       	CALL	COMOUT
CB9B 3E C8          	LD	A,INTVEC
CB9D CD 19 DF       	CALL	OT49SB
CBA0                ;
CBA0 01 C4 1F       	LD	BC,01FC4H
CBA3 3E 0C          	LD	A,00CH
CBA5 ED 79          	OUT	(C),A
CBA7                
CBA7 0E C0          	LD	C,0C0H
CBA9 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBAB                
CBAB 0C             	INC	C
CBAC 3E 28          	LD	A,40
CBAE ED 79          	OUT	(C),A
CBB0                
CBB0 0C             	INC	C
CBB1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBB3                
CBB3 0C             	INC	C
CBB4 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBB6                
CBB6 0E C5          	LD	C,0C5H
CBB8 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBBA                
CBBA                TEXT:
CBBA 0E B0          	LD	C,0B0H
CBBC 3E 80          	LD	A,080H
CBBE ED 79          	OUT	(C),A
CBC0 16 07          	LD	D,7
CBC2 0E B9          	LD	C,0B9H
CBC4 21 16 CF       	LD	HL,TEXTDT
CBC7                TEXT1:
CBC7 04             	INC	B
CBC8 ED A3          	OUTI
CBCA 0C             	INC	C
CBCB 15             	DEC	D
CBCC 20 F9          	JR	NZ,TEXT1
CBCE 01 B0 1F       	LD	BC,01FB0H
CBD1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBD3                
CBD3 0E C4          	LD	C,0C4H
CBD5 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBD7                
CBD7 01 01 1A       	LD	BC,01A01H
CBDA ED 78          	IN	A,(C)
CBDC E6 08          	AND	8
CBDE 28 09          	JR	Z,PRN
CBE0 0E 03          	LD	C,003H
CBE2 3E 0F          	LD	A,00FH
CBE4 ED 79          	OUT	(C),A
CBE6 01 04 0A       	LD	BC,00A04H
CBE9                PRN:
CBE9 21 00 00       	LD	HL,0
CBEC 06 5C          	LD	B,05CH
CBEE 3E FF          	LD	A,0FFH		;RST 38H
CBF0 CD A7 E1       	CALL	FILL_MEMORY
CBF3 06 A4          	LD	B,0A4H
CBF5 AF             	XOR	A
CBF6 CD A7 E1       	CALL	FILL_MEMORY
CBF9                
CBF9 3E C3          	LD	A,0C3H		;JP
CBFB 21 03 EF       	LD	HL,CPM_WBOOT
CBFE 32 00 00       	LD	(00000H),A
CC01 22 01 00       	LD	(00001H),HL	;IPL
CC04                
CC04 2A 03 CB       	LD	HL,(MACHINE)	;3 bit7  DPB Compatible LA(1)
CC07 22 03 00       	LD	(00003H),HL	;  bit6-0 Machine X1(0)
CC0A                ;				;4 LSX-Dodgers(01DH)
CC0A 21 06 D1       	LD	HL,BDOS
CC0D 32 05 00       	LD	(00005H),A
CC10 22 06 00       	LD	(00006H),HL	;BDOS
CC13                
CC13 21 1B DB       	LD	HL,BIOS
CC16 22 19 00       	LD	(00019H),HL	;BIOS-ROM
CC19                
CC19 21 D9 FF       	LD	HL,TRAP38	;TRAP38
CC1C 32 38 00       	LD	(00038H),A
CC1F 22 39 00       	LD	(00039H),HL	;RST 038H
CC22                
CC22 3E EF          	LD	A,CPM_BOOT/256
CC24 32 0B 00       	LD	(0000BH),A
CC27                
CC27 3E E9          	LD	A,0E9H		;JP (HL)
CC29 32 0F 00       	LD	(0000FH),A
CC2C                
CC2C 3A 7D F0       	LD	A,(_FATBF+1)
CC2F 32 13 00       	LD	(00013H),A
CC32                
CC32 3A 7F F0       	LD	A,(_DTBUF+1)
CC35 32 17 00       	LD	(00017H),A
CC38                
CC38 3E FE          	LD	A,KEYBF/256
CC3A 32 1B 00       	LD	(0001BH),A
CC3D                
CC3D 3E FF          	LD	A,KBUF/256
CC3F 32 1F 00       	LD	(0001FH),A
CC42                
CC42 2A 05 CB       	LD	HL,(VERSION)
CC45 22 5A 00       	LD	(0005AH),HL
CC48                
CC48 3E E6          	LD	A,0E6H
CC4A CD 3F DF       	CALL	COMOUT
CC4D CD 24 DF       	CALL	IN49SB
CC50 F5             	PUSH	AF
CC51 CD 24 DF       	CALL	IN49SB
CC54 F1             	POP	AF
CC55 F5             	PUSH	AF
CC56 E6 12          	AND	012H
CC58 20 05          	JR	NZ,KEYR
CC5A 3E 01          	LD	A,1
CC5C 32 A1 CD       	LD	(KEYREP+1),A
CC5F                KEYR:
CC5F F1             	POP	AF
CC60 E6 03          	AND	3
CC62 28 0E          	JR	Z,NON
CC64                
CC64 01 D0 3F       	LD	BC,03FD0H
CC67 ED 49          	OUT	(C),C
CC69 3E 37          	LD	A,037H
CC6B D3 D0          	OUT	(0D0H),A
CC6D ED 78          	IN	A,(C)
CC6F B9             	CP	C
CC70 28 64          	JR	Z,TURBO
CC72                NON:
CC72 21 29 CF       	LD	HL,AT_SCR1
CC75 11 C9 DF       	LD	DE,SCR1
CC78 01 A1 00       	LD	BC,SCRNX-SCR1	;転送先のサイズ確認用
CC7B 01 9F 00       	LD	BC,AT_SCRE-AT_SCR1
CC7E ED B0          	LDIR
CC80                
CC80 21 C8 CF       	LD	HL,AT_WTTRK
CC83 11 47 EE       	LD	DE,WTTRK
CC86 01 B9 00       	LD	BC,DMAE-WTTRK	;転送先のサイズ確認用
CC89 01 B1 00       	LD	BC,AT_CPUE-AT_WTTRK
CC8C ED B0          	LDIR
CC8E                
CC8E 21 79 D0       	LD	HL,AT_EDWT
CC91 11 CF D7       	LD	DE,EDWT
CC94 01 4C 00       	LD	BC,EMME-EDWT	;転送先のサイズ確認用
CC97 01 48 00       	LD	BC,AT_EMME-AT_EDWT
CC9A ED B0          	LDIR
CC9C                
CC9C 21 A8 EE       	LD	HL,AT_DRD+AT_R
CC9F 22 EC EF       	LD	(_FDRD+1),HL
CCA2 21 4D EE       	LD	HL,AT_DWT+AT_R
CCA5 22 EF EF       	LD	(_FDWT+1),HL
CCA8 21 E3 D7       	LD	HL,AT_EDRD+AT_RE
CCAB 22 82 F1       	LD	(EMMRD),HL
CCAE 21 CF D7       	LD	HL,AT_EDWT+AT_RE
CCB1 22 84 F1       	LD	(EMMWR),HL
CCB4                
CCB4 3E 27          	LD	A,027H			;ノンターボはMFM切り替えを行わない
CCB6 32 12 F1       	LD	(DEVICE+012H),A		;Aドライブ
CCB9 32 32 F1       	LD	(DEVICE+012H+32),A	;Bドライブ
CCBC 32 52 F1       	LD	(DEVICE+012H+32*2),A	;Cドライブ
CCBF 32 72 F1       	LD	(DEVICE+012H+32*3),A	;Dドライブ
CCC2                
CCC2 21 00 00       	LD	HL,0
CCC5 22 6A DF       	LD	(X1PAT),HL
CCC8                
CCC8 3E AF          	LD	A,0AFH		;XOR	A
CCCA 32 89 DD       	LD	(X1KPAT),A
CCCD                
CCCD 21 6A E0       	LD	HL,SCRNX
CCD0 22 D1 EF       	LD	(_SCRN+1),HL
CCD3                
CCD3 C3 5C CD       	JP	NOBANK
CCD6                
CCD6                TURBO:
CCD6 F3             	DI			;Check BIOS
CCD7 06 1D          	LD	B,01DH
CCD9 ED 79          	OUT	(C),A		;BIOS ON
CCDB 3A 51 2F       	LD	A,(02F51H)
CCDE 04             	INC	B		;B=01EH
CCDF ED 79          	OUT	(C),A		;BIOS OFF
CCE1 FB             	EI
CCE2 FE C9          	CP	0C9H
CCE4 28 0D          	JR	Z,BIOSOK
CCE6 3E AF          	LD	A,0AFH		;XOR	A
CCE8 32 89 DD       	LD	(X1KPAT),A
CCEB 21 6A E0       	LD	HL,SCRNX
CCEE 22 D1 EF       	LD	(_SCRN+1),HL
CCF1 18 05          	JR	NOBIOS
CCF3                BIOSOK:
CCF3 3E C3          	LD	A,0C3H		;JP
CCF5 32 18 00       	LD	(00018H),A
CCF8                NOBIOS:
CCF8 3E 1F          	LD	A,01FH		;スタートポート
CCFA DB F0          	IN	A,(0F0H)
CCFC 0F             	RRCA
CCFD 38 0B          	JR	C,CRT1
CCFF 21 06 CF       	LD	HL,_C8025H
CD02 11 B0 EF       	LD	DE,CRTCD
CD05 01 10 00       	LD	BC,16
CD08 ED B0          	LDIR
CD0A                CRT1:
CD0A 3E 1F          	LD	A,01FH		;スタートポート
CD0C DB F0          	IN	A,(0F0H)
CD0E CB 57          	BIT	2,A
CD10 28 18          	JR	Z,BANK
CD12                
CD12 AF             	XOR	A
CD13                TZ1:				;前面スイッチが2HDの場合はMFMモードを2HDにしておく
CD13 F5             	PUSH	AF
CD14 CD DC EF       	CALL	_GETDPB
CD17 DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
CD1A E6 8F          	AND	08FH
CD1C FE 87          	CP	087H		;フロッピーでMEM切り替えがON
CD1E 20 04          	JR	NZ,TZ2
CD20 DD CB 0A 86    	RES	0,(IX+0AH)	;(DPB_0A_FDMODE)
CD24                TZ2:
CD24 F1             	POP	AF
CD25 3C             	INC	A
CD26 FE 08          	CP	8
CD28 38 E9          	JR	C,TZ1
CD2A                
CD2A                BANK:
CD2A 01 00 0B       	LD	BC,00B00H
CD2D 21 00 7F       	LD	HL,07F00H
CD30 F3             	DI
CD31                BANK1:
CD31 ED 69          	OUT	(C),L
CD33 5E             	LD	E,(HL)
CD34 7B             	LD	A,E
CD35 C6 A5          	ADD	A,0A5H
CD37 77             	LD	(HL),A
CD38 BE             	CP	(HL)
CD39 73             	LD	(HL),E
CD3A 20 05          	JR	NZ,BANK2
CD3C 2C             	INC	L
CD3D CB 65          	BIT	4,L
CD3F 28 F0          	JR	Z,BANK1
CD41                BANK2:
CD41 3E 10          	LD	A,010H
CD43 ED 79          	OUT	(C),A
CD45 7D             	LD	A,L
CD46 B7             	OR	A
CD47 28 13          	JR	Z,NOBANK
CD49 26 00          	LD	H,0
CD4B 29             	ADD	HL,HL	;*2
CD4C 29             	ADD	HL,HL	;*4
CD4D 29             	ADD	HL,HL	;*8
CD4E 29             	ADD	HL,HL	;*16
CD4F 29             	ADD	HL,HL	;*32
CD50 2B             	DEC	HL	;-1
CD51 2B             	DEC	HL	;-2
CD52 2B             	DEC	HL	;-3
CD53 22 A8 F1       	LD	(BANKCL),HL
CD56 CD AB CE       	CALL	CALC_FATLN
CD59 32 A0 F1       	LD	(BANKFL),A
CD5C                NOBANK:
CD5C                EMM:
CD5C CD 55 CE       	CALL	EADR0
CD5F ED 78          	IN	A,(C)
CD61 F5             	PUSH	AF
CD62                
CD62 11 00 00       	LD	DE,0
CD65                ECHECK1:
CD65 13             	INC	DE
CD66 CD 38 CE       	CALL	EADR2
CD69 ED 60          	IN	H,(C)
CD6B CD 38 CE       	CALL	EADR2
CD6E 7C             	LD	A,H
CD6F C6 E5          	ADD	A,0E5H
CD71 ED 79          	OUT	(C),A
CD73 3C             	INC	A
CD74 CD 55 CE       	CALL	EADR0
CD77 ED 79          	OUT	(C),A
CD79 3D             	DEC	A
CD7A CD 38 CE       	CALL	EADR2
CD7D ED 68          	IN	L,(C)
CD7F CD 38 CE       	CALL	EADR2
CD82 ED 61          	OUT	(C),H
CD84 BD             	CP	L
CD85 20 04          	JR	NZ,ECHECK2
CD87 CB 5A          	BIT	3,D
CD89 28 DA          	JR	Z,ECHECK1
CD8B                ECHECK2:
CD8B CD 55 CE       	CALL	EADR0
CD8E F1             	POP	AF
CD8F ED 79          	OUT	(C),A
CD91                
CD91 21 F7 FF       	LD	HL,0-9
CD94 19             	ADD	HL,DE
CD95 30 09          	JR	NC,NOEMM
CD97 22 88 F1       	LD	(EMMCL),HL
CD9A CD AB CE       	CALL	CALC_FATLN
CD9D 32 80 F1       	LD	(EMMFL),A
CDA0                NOEMM:
CDA0 3E 00          KEYREP:	LD	A,000H
CDA2 B7             	OR	A
CDA3 28 07          	JR	Z,KEYR1
CDA5 01 00 00       	LD	BC,0
CDA8 ED 43 8C EF    	LD	(_CTC),BC
CDAC                KEYR1:
CDAC CD 8C CE       	CALL	SETCRTC
CDAF 01 AA 10       	LD	BC,010AAH	;PALET
CDB2 ED 49          	OUT	(C),C
CDB4 01 CC 11       	LD	BC,011CCH
CDB7 ED 49          	OUT	(C),C
CDB9 01 F0 12       	LD	BC,012F0H
CDBC ED 49          	OUT	(C),C
CDBE 04             	INC	B
CDBF ED 71          	DB	0EDH,071H
CDC1                
CDC1 01 30 F8       	LD	BC,0-80*25
CDC4 2A BA EF       	LD	HL,(CRTCD+10)
CDC7 ED 43 BA EF    	LD	(CRTCD+10),BC
CDCB 1E 0C          	LD	E,00CH
CDCD CD CD EF       	CALL	_PRINT
CDD0 22 BA EF       	LD	(CRTCD+10),HL
CDD3                
CDD3 21 C7 CE       	LD	HL,INIMES
CDD6 CD 6F D8       	CALL	MSX
CDD9                
CDD9 3A 87 FF       	LD	A,(0FF87H)
CDDC FE 08          	CP	8
CDDE 30 1E          	JR	NC,INIT0
CDE0 5F             	LD	E,A
CDE1 C6 41          	ADD	A,'A'
CDE3 32 C4 CE       	LD	(AUTODV),A
CDE6 0E 0E          	LD	C,00EH
CDE8 CD 05 00       	CALL	SYSTEM
CDEB 1C             	INC	E
CDEC 21 85 EF       	LD	HL,_SEEKSP	;Disk error Ignore
CDEF CB FE          	SET	7,(HL)
CDF1 0E 1B          	LD	C,01BH
CDF3 CD 05 00       	CALL	SYSTEM
CDF6                
CDF6 21 85 EF       	LD	HL,_SEEKSP
CDF9 CB BE          	RES	7,(HL)
CDFB                
CDFB 3C             	INC	A
CDFC 20 08          	JR	NZ,INIT1
CDFE                INIT0:
CDFE 1E 00          	LD	E,0
CE00 0E 0E          	LD	C,00EH
CE02 CD 05 00       	CALL	SYSTEM
CE05 AF             	XOR	A
CE06                INIT1:
CE06 F3             	DI
CE07 08             	EX	AF,AF'
CE08 2E FE          	LD	L,0-2		;CALLのスタック分減らす
CE0A 39             	ADD	HL,SP
CE0B 11 00 FF       	LD	DE,0FF00H
CE0E 45             	LD	B,L
CE0F CD 08 D5       	CALL	ZERO_MEMORY_DE
CE12 21 CA FF       	LD	HL,EXTSP
CE15 06 0F          	LD	B,TRAP38-EXTBIO
CE17 3E FF          	LD	A,0FFH		;RST 38H
CE19 CD A7 E1       	CALL	FILL_MEMORY
CE1C 21 C1 D0       	LD	HL,AT_TRAP38
CE1F 11 D9 FF       	LD	DE,TRAP38
CE22 01 27 00       	LD	BC,AT_TRAPE-AT_TRAP38
CE25 ED B0          	LDIR
CE27 08             	EX	AF,AF'
CE28 B7             	OR	A
CE29 C8             	RET	Z
CE2A                
CE2A 3E E6          	LD	A,0E6H
CE2C CD 3F DF       	CALL	COMOUT
CE2F CD 24 DF       	CALL	IN49SB
CE32 CD 24 DF       	CALL	IN49SB
CE35 FE 1B          	CP	01BH
CE37 C9             	RET
CE38                
CE38                EADR2:
CE38 D5             	PUSH	DE
CE39 EB             	EX	DE,HL
CE3A 29             	ADD	HL,HL
CE3B 29             	ADD	HL,HL
CE3C ED 4B 8B F1    	LD	BC,(EMMBL-1)
CE40 0E 00          	LD	C,0
CE42 09             	ADD	HL,BC
CE43 ED 4B 93 F1    	LD	BC,(EMMDV)
CE47 06 0D          	LD	B,00DH
CE49 ED 49          	OUT	(C),C
CE4B 0C             	INC	C
CE4C ED 69          	OUT	(C),L
CE4E 0C             	INC	C
CE4F ED 61          	OUT	(C),H
CE51 0C             	INC	C
CE52 EB             	EX	DE,HL
CE53 D1             	POP	DE
CE54 C9             	RET
CE55                
CE55                EADR0:
CE55 ED 4B 93 F1    	LD	BC,(EMMDV)
CE59 06 0D          	LD	B,00DH
CE5B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CE5D 0C             	INC	C
CE5E ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CE60 0C             	INC	C
CE61 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CE63 0C             	INC	C
CE64 C9             	RET
CE65                
CE65                CHKCTC:
CE65 C5             	PUSH	BC
CE66 11 03 47       	LD	DE,04703H
CE69                INICTC1:
CE69 0C             	INC	C
CE6A ED 51          	OUT	(C),D
CE6C ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CE6E 1D             	DEC	E
CE6F 20 F8          	JR	NZ,INICTC1
CE71 C1             	POP	BC
CE72                
CE72 11 FA 07       	LD	DE,007FAH
CE75 ED 51          	OUT	(C),D
CE77 ED 59          	OUT	(C),E
CE79 ED 78          	IN	A,(C)
CE7B BB             	CP	E
CE7C C0             	RET	NZ
CE7D ED 51          	OUT	(C),D
CE7F ED 51          	OUT	(C),D
CE81 ED 78          	IN	A,(C)
CE83 BA             	CP	D
CE84 C0             	RET	NZ
CE85 03             	INC	BC
CE86 03             	INC	BC
CE87 ED 43 8C EF    	LD	(_CTC),BC
CE8B C9             	RET
CE8C                
CE8C                SETCRTC:
CE8C 21 B0 EF       	LD	HL,CRTCD
CE8F AF             	XOR	A
CE90                SETCRT1:
CE90 01 00 18       	LD	BC,01800H
CE93 ED 79          	OUT	(C),A
CE95 0C             	INC	C
CE96 04             	INC	B
CE97 ED A3          	OUTI
CE99 3C             	INC	A
CE9A FE 0C          	CP	12
CE9C 20 F2          	JR	NZ,SETCRT1
CE9E 23             	INC	HL
CE9F 23             	INC	HL
CEA0 01 03 1B       	LD	BC,01A03H+00100H
CEA3 ED A3          	OUTI
CEA5 01 D0 20       	LD	BC,01FD0H+00100H
CEA8 ED A3          	OUTI
CEAA C9             	RET
CEAB                
CEAB                CALC_FATLN:	;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
CEAB 5D             	LD	E,L
CEAC 54             	LD	D,H
CEAD 29             	ADD	HL,HL	;*2
CEAE 19             	ADD	HL,DE	;*3
CEAF CB 3C          	SRL	H	;/2
CEB1 CB 1D          	RR	L	;1クラスタ辺り1.5バイト必要
CEB3 11 FF 01       	LD	DE,511	;切り上げる
CEB6 19             	ADD	HL,DE
CEB7 7C             	LD	A,H
CEB8 CB 3F          	SRL	A
CEBA C9             	RET
CEBB                
CEBB 41 55 54 4F    AUTOD:	DB	"AUTOEXEC "
CEBF 45 58 45 43
CEC3 20
CEC4 41 3A 00       AUTODV:	DB	"A:",0
CEC7                
CEC7 4C 53 58 2D    INIMES:	DB	"LSX-Dodgers for X1/turbo version "
CECB 44 6F 64 67
CECF 65 72 73 20
CED3 66 6F 72 20
CED7 58 31 2F 74
CEDB 75 72 62 6F
CEDF 20 76 65 72
CEE3 73 69 6F 6E
CEE7 20
CEE8 31 2E          	DB	030H + VER_1, '.'
CEEA 34 32          	DB	030H + VER_2 ,030H + VER_3
CEEC 20 47 61 6B    	DB	' Gaku (Lovers/Tablacus)',0DH,0AH
CEF0 75 20 28 4C
CEF4 6F 76 65 72
CEF8 73 2F 54 61
CEFC 62 6C 61 63
CF00 75 73 29 0D
CF04 0A
CF05 00             	DB	0
CF06                
CF06                _C8025H:
CF06 6B 50 59 88    	DB	06BH,050H,059H,088H,01BH,001H,019H,01AH
CF0A 1B 01 19 1A
CF0E 00 0F          	DB	000H,00FH
CF10 80 F8 B0 FF    	DW	0-80*LINE,0-80
CF14 0C 23          	DB	00CH,023H
CF16                
CF16 03 0C 0F 30    TEXTDT:	DB	003H,00CH,00FH,030H,033H,03CH,03FH
CF1A 33 3C 3F
CF1D                
CF1D                SIODATA:
CF1D 18             	DB	018H
CF1E 01 00          	DB	1,0
CF20 02 00          	DB	2,0
CF22 03 C1          	DB	3,0C1H
CF24 04 44          	DB	4,044H
CF26 05 E8          	DB	5,0E8H
CF28 FF             	DB	0FFH
CF29                
CF29                ;	ノンターボ用パッチ
CF29                
CF29                AT_SCR1:
CF29 D9             	EXX
CF2A C5             	PUSH	BC
CF2B 01 50 20       	LD	BC,02000H+80
CF2E D9             	EXX
CF2F C5             	PUSH	BC
CF30 01 00 20       	LD	BC,02000H
CF33                
CF33 67             	LD	H,A
CF34 B7             	OR	A
CF35                AT_SCRUP1:
CF35 28 15          	JR	Z,AT_SCRCL
CF37 C5             	PUSH	BC
CF38 CB E0          	SET	4,B
CF3A D9             	EXX
CF3B C5             	PUSH	BC
CF3C CB E0          	SET	4,B
CF3E D9             	EXX
CF3F CD 03 E0       	CALL	AT_UPSUB+AT_RS
CF42 D9             	EXX
CF43 C1             	POP	BC
CF44 D9             	EXX
CF45 C1             	POP	BC
CF46 CD 03 E0       	CALL	AT_UPSUB+AT_RS
CF49 25             	DEC	H
CF4A 18 E9          	JR	AT_SCRUP1
CF4C                
CF4C                AT_SCRCL:
CF4C 21 50 20       	LD	HL,02000H+80
CF4F 3A 96 EF       	LD	A,(_COLORF)
CF52                AT_SCRCL1:
CF52 CB E0          	SET	4,B
CF54 ED 61          	OUT	(C),H
CF56 CB A0          	RES	4,B
CF58 ED 79          	OUT	(C),A
CF5A 03             	INC	BC
CF5B 2D             	DEC	L
CF5C 20 F4          	JR	NZ,AT_SCRCL1
CF5E C1             	POP	BC
CF5F D9             	EXX
CF60 C1             	POP	BC
CF61 D9             	EXX
CF62 C9             	RET
CF63                
CF63                AT_UPSUB:
CF63 2E 28          	LD	L,40
CF65                AT_UPSUB1:
CF65 D9             	EXX
CF66 ED 78          	IN	A,(C)
CF68 03             	INC	BC
CF69 D9             	EXX
CF6A ED 79          	OUT	(C),A
CF6C 03             	INC	BC
CF6D D9             	EXX
CF6E ED 78          	IN	A,(C)
CF70 03             	INC	BC
CF71 D9             	EXX
CF72 ED 79          	OUT	(C),A
CF74 03             	INC	BC
CF75 2D             	DEC	L
CF76 20 ED          	JR	NZ,AT_UPSUB1
CF78 C9             	RET
CF79                
CF79                ;	FLOPPY DISK DRIVER(CPU)
CF79                
CF79                DISKC:
CF79 1B             	DEC	DE
CF7A CB 5F          	BIT	3,A
CF7C C4 40 EE       	CALL	NZ,RNF
CF7F                DISKD:
CF7F E5             	PUSH	HL
CF80 21 46 EE       	LD	HL,RETRY
CF83 35             	DEC	(HL)
CF84 E1             	POP	HL
CF85 20 3E          	JR	NZ,AT_ERR		;Retry
CF87 B7             	OR	A
CF88 28 3B          	JR	Z,AT_ERR		;Error
CF8A                
CF8A                AT_DELP:
CF8A CD 40 EE       	CALL	RNF
CF8D CD 1C EE       	CALL	FDMOFF
CF90 3A 85 EF       	LD	A,(_SEEKSP)
CF93 87             	ADD	A,A
CF94 38 2E          	JR	C,AT_ERRZ
CF96                AT_DELP1:
CF96 D5             	PUSH	DE
CF97 21 C0 F0       	LD	HL,DEMES
CF9A CD 6F D8       	CALL	MSX
CF9D CD ED DB       	CALL	KEYBC
CFA0                AT_DELP2:
CFA0 CD CA EF       	CALL	_INKEY
CFA3 28 FB          	JR	Z,AT_DELP2
CFA5                
CFA5 D1             	POP	DE
CFA6 CD 07 E4       	CALL	CAP
CFA9 FE 52          	CP	'R'		;Retry
CFAB 20 0A          	JR	NZ,AT_DELP3
CFAD 21 00 00       DHLPAT:	LD	HL,0
CFB0 3E 02          	LD	A,2
CFB2 32 46 EE       	LD	(RETRY),A
CFB5 B7             	OR	A
CFB6 C9             	RET
CFB7                AT_DELP3:
CFB7 FE 49          	CP	'I'		;Ignore
CFB9 28 07          	JR	Z,AT_IGNORE
CFBB FE 41          	CP	'A'		;Abort
CFBD 20 D7          	JR	NZ,AT_DELP1
CFBF C3 00 EF       	JP	CPM_BOOT
CFC2                AT_IGNORE:
CFC2 3E FF          	LD	A,0FFH
CFC4                AT_ERRZ:
CFC4 BF             	CP	A
CFC5                AT_ERR:
CFC5 3E FF          	LD	A,0FFH
CFC7 C9             	RET
CFC8                
CFC8                AT_SCRE:
CFC8                
CFC8                AT_WTTRK:
CFC8 06 01          	LD	B,1
CFCA 3E F0          	LD	A,0F0H
CFCC 18 02          	JR	AT_WTTRK1
CFCE                AT_DWT:
CFCE 3E A0          	LD	A,0A0H
CFD0                AT_WTTRK1:
CFD0 32 E4 ED       	LD	(FDCPAT+1),A
CFD3                DWTBL:
CFD3 78             	LD	A,B
CFD4 32 93 EE       	LD	(AT_WTB+1+AT_R),A
CFD7 3E 02          	LD	A,2		;Retry count
CFD9 32 46 EE       	LD	(RETRY),A
CFDC                
CFDC                DWT0:
CFDC D5             	PUSH	DE
CFDD E5             	PUSH	HL
CFDE 22 4E E0       	LD	(DHLPAT+1+AT_RS),HL
CFE1 CD 7E ED       	CALL	SEEK		;Write disk
CFE4 E1             	POP	HL
CFE5 38 38          	JR	C,ERRDW
CFE7 F3             	DI
CFE8 3A E4 ED       	LD	A,(FDCPAT+1)
CFEB CD 28 EE       	CALL	SECSET
CFEE 0E FB          	LD	C,0FBH
CFF0                
CFF0                DWT1:
CFF0 56             	LD	D,(HL)
CFF1                DWT2:
CFF1 78             	LD	A,B
CFF2 DB F8          	IN	A,(0F8H)
CFF4 0F             	RRCA
CFF5 30 08          	JR	NC,DWT4
CFF7 0F             	RRCA
CFF8 30 F7          	JR	NC,DWT2
CFFA                DWT3:
CFFA ED 51          	OUT	(C),D
CFFC 23             	INC	HL
CFFD 18 F1          	JR	DWT1
CFFF                
CFFF                DWT4:
CFFF 3D             	DEC	A
D000 28 F8          	JR	Z,DWT3
D002 3C             	INC	A
D003 FB             	EI
D004 D1             	POP	DE
D005 13             	INC	DE
D006 CD 1C EE       	CALL	FDMOFF
D009 28 08          	JR	Z,DISKOK_WT
D00B CD 19 E0       	CALL	DISKC+AT_RS
D00E 20 CC          	JR	NZ,DWT0
D010 B7             	OR	A
D011 20 05          	JR	NZ,ERRW
D013                
D013                DISKOK_WT:
D013 06 01          AT_WTB:	LD	B,1
D015 10 BC          	DJNZ	DWTBL
D017 C9             	RET
D018                
D018                ERRW:
D018 3E FF          	LD	A,0FFH
D01A                ERRZ:
D01A BF             	CP	A
D01B 37             	SCF
D01C C3 1C EE       	JP	FDMOFF
D01F                
D01F                ERRDW:
D01F D1             	POP	DE
D020 CD 2A E0       	CALL	AT_DELP+AT_RS
D023 20 B7          	JR	NZ,DWT0
D025 B7             	OR	A
D026 20 F0          	JR	NZ,ERRW
D028 C9             	RET
D029                
D029                AT_DRD:
D029 3E 80          	LD	A,080H
D02B 32 E4 ED       	LD	(FDCPAT+1),A
D02E                DRDBL:
D02E 78             	LD	A,B
D02F 32 EA EE       	LD	(AT_RDB+1+AT_R),A
D032 3E 02          	LD	A,2		;Retry count
D034 32 46 EE       	LD	(RETRY),A
D037                DRD0:
D037 D5             	PUSH	DE
D038 E5             	PUSH	HL
D039 22 4E E0       	LD	(DHLPAT+1+AT_RS),HL
D03C CD 7E ED       	CALL	SEEK		;Read disk
D03F E1             	POP	HL
D040 38 2D          	JR	C,ERRDR
D042 F3             	DI
D043 3A E4 ED       	LD	A,(FDCPAT+1)
D046 CD 28 EE       	CALL	SECSET
D049 0E FB          	LD	C,0FBH
D04B                DRD1:
D04B 78             	LD	A,B
D04C DB F8          	IN	A,(0F8H)
D04E 0F             	RRCA
D04F 30 08          	JR	NC,DRD3
D051 0F             	RRCA
D052 30 F7          	JR	NC,DRD1
D054 ED A2          	INI
D056 04             	INC	B
D057 18 F2          	JR	DRD1
D059                
D059                DRD3:
D059 B7             	OR	A
D05A FB             	EI
D05B D1             	POP	DE
D05C 13             	INC	DE
D05D CD 1C EE       	CALL	FDMOFF
D060 28 08          	JR	Z,DISKOK_RD
D062 CD 19 E0       	CALL	DISKC+AT_RS
D065 20 D0          	JR	NZ,DRD0
D067 B7             	OR	A
D068 20 AE          	JR	NZ,ERRW
D06A                
D06A                DISKOK_RD:
D06A 06 01          AT_RDB:	LD	B,1
D06C 10 C0          	DJNZ	DRDBL
D06E C9             	RET
D06F                
D06F                ERRDR:
D06F D1             	POP	DE
D070 CD 2A E0       	CALL	AT_DELP+AT_RS
D073 20 C2          	JR	NZ,DRD0
D075 B7             	OR	A
D076 20 A0          	JR	NZ,ERRW
D078 C9             	RET
D079                
D079                AT_CPUE:
D079                
D079                
D079                ;	EMM DRIVER(CPU)
D079                
D079                
D079                AT_EDWT:
D079 CD F7 D7       	CALL	AT_EADR+AT_RE
D07C                AT_EDWT0:
D07C F5             	PUSH	AF
D07D AF             	XOR	A
D07E                AT_EDWT1:
D07E 04             	INC	B
D07F ED A3          	OUTI
D081 04             	INC	B
D082 ED A3          	OUTI
D084 3D             	DEC	A
D085 20 F7          	JR	NZ,AT_EDWT1
D087 13             	INC	DE
D088 F1             	POP	AF
D089 3D             	DEC	A
D08A 20 F0          	JR	NZ,AT_EDWT0
D08C C9             	RET
D08D                
D08D                AT_EDRD:
D08D CD F7 D7       	CALL	AT_EADR+AT_RE
D090                AT_EDRD0:
D090 F5             	PUSH	AF
D091 AF             	XOR	A
D092                AT_EDRD1:
D092 ED A2          	INI
D094 04             	INC	B
D095 ED A2          	INI
D097 04             	INC	B
D098 3D             	DEC	A
D099 20 F7          	JR	NZ,AT_EDRD1
D09B 13             	INC	DE
D09C F1             	POP	AF
D09D 3D             	DEC	A
D09E 20 F0          	JR	NZ,AT_EDRD0
D0A0 C9             	RET
D0A1                
D0A1                AT_EADR:
D0A1 C5             	PUSH	BC
D0A2 D5             	PUSH	DE
D0A3 EB             	EX	DE,HL
D0A4 29             	ADD	HL,HL
D0A5 29             	ADD	HL,HL
D0A6 0E 00          	LD	C,0
D0A8 3A A1 EF       	LD	A,(_MAXCYL)
D0AB 47             	LD	B,A
D0AC 09             	ADD	HL,BC
D0AD 3A 84 EF       	LD	A,(_DRIVE)
D0B0 4F             	LD	C,A
D0B1 06 0D          	LD	B,00DH
D0B3 ED 49          	OUT	(C),C
D0B5 0C             	INC	C
D0B6 ED 69          	OUT	(C),L
D0B8 0C             	INC	C
D0B9 ED 61          	OUT	(C),H
D0BB 0C             	INC	C
D0BC EB             	EX	DE,HL
D0BD D1             	POP	DE
D0BE F1             	POP	AF
D0BF A7             	AND	A	;CF=0
D0C0 C9             	RET
D0C1                AT_EMME:
D0C1                
D0C1                AT_TRAP38:
D0C1 21 00 00       	LD	HL,0
D0C4 E3             	EX	(SP),HL
D0C5 3E 24          	LD	A,'$'
D0C7 CD 24 DC       	CALL	MSG_A
D0CA 2B             	DEC	HL
D0CB 7C             	LD	A,H
D0CC CD E8 FF       	CALL	PRHX+AT_RT
D0CF 7D             	LD	A,L
D0D0                PRHX:
D0D0 F5             	PUSH	AF
D0D1 07             	RLCA
D0D2 07             	RLCA
D0D3 07             	RLCA
D0D4 07             	RLCA
D0D5 CD F1 FF       	CALL	PRHX2+AT_RT
D0D8 F1             	POP	AF
D0D9                PRHX2:
D0D9 E6 0F          	AND	00FH
D0DB FE 0A          	CP	10
D0DD 38 02          	JR	C,PRHX3
D0DF C6 07          	ADD	A,'A'-'0'-10
D0E1                PRHX3:
D0E1 C6 30          	ADD	A,'0'
D0E3 C3 24 DC       	JP	MSG_A
D0E6                	DS	2
D0E8                AT_TRAPE:
D0E8                
D0E8 00 00 2F 18    AT_RT	EQU	TRAP38-AT_TRAP38
D0E8                
D0E8                INITE:
D0E8                	DS	BDOS-INITE
D106                
D106 C3 1B D8       	JP	BDOS0
D109                	DS	3	;Reserved
D10C                	INCLUDE	"LDCCP.ASM"
D10C                
D10C                ;	LSX-Dodgers CCP
D10C                
D10C                WBOOT1:
D10C F3             	DI
D10D ED 7B 06 00    	LD	SP,(SYSTEM+1)
D111                
D111 3E EF          	LD	A,INTVEC/256
D113 ED 47          	LD	I,A
D115                
D115 3E E4          	LD	A,0E4H
D117 CD 3F DF       	CALL	COMOUT
D11A 3E C8          	LD	A,INTVEC
D11C CD 19 DF       	CALL	OT49SB
D11F                
D11F 3A BC EF       	LD	A,(CRTCD+12)
D122 B7             	OR	A
D123 20 0C          	JR	NZ,SETCRT0
D125 21 80 F8       	LD	HL,0-80*LINE
D128 22 BA EF       	LD	(CRTCD+10),HL
D12B 21 B0 FF       	LD	HL,0-80
D12E 22 BC EF       	LD	(CRTCD+12),HL
D131                SETCRT0:
D131 21 B0 EF       	LD	HL,CRTCD
D134 AF             	XOR	A
D135                SETCRT2:
D135 01 00 18       	LD	BC,01800H
D138 ED 79          	OUT	(C),A
D13A 0C             	INC	C
D13B 56             	LD	D,(HL)
D13C FE 0D          	CP	13
D13E 38 02          	JR	C,SETCRT3
D140 16 00          	LD	D,0
D142                SETCRT3:
D142 ED 51          	OUT	(C),D
D144 23             	INC	HL
D145 3C             	INC	A
D146 FE 0E          	CP	14
D148 20 EB          	JR	NZ,SETCRT2
D14A                
D14A 01 03 1B       	LD	BC,01A03H+00100H
D14D ED A3          	OUTI
D14F 01 D0 20       	LD	BC,01FD0H+00100H
D152 ED A3          	OUTI
D154 21 92 EF       	LD	HL,_KEYD
D157 7E             	LD	A,(HL)
D158 36 00          	LD	(HL),0
D15A CD EA DB       	CALL	KEYBC_IFBREAK
D15D 3E 04          	LD	A,4
D15F CD 24 DC       	CALL	MSG_A
D162                COMMAND:
D162 CD 15 D2       	CALL	SETDTA1
D165 3A 87 EF       	LD	A,(_DVSW)
D168 C6 41          	ADD	A,'A'
D16A CD 24 DC       	CALL	MSG_A
D16D 3E 3E          	LD	A,'>'
D16F CD 24 DC       	CALL	MSG_A
D172 3E 50          	LD	A,80
D174 12             	LD	(DE),A
D175 CD 73 DC       	CALL	_SYS0A		;(BDOS)文字列入力
D178 CD CA D3       	CALL	LTNL
D17B                
D17B 11 82 00       	LD	DE,DTA1+2
D17E CD FD EF       	CALL	_COMANL
D181 30 DF          	JR	NC,COMMAND
D183 11 79 EF       	LD	DE,COMERM
D186 CD 60 D8       	CALL	_SYS09		;(BDOS)文字列出力
D189 C7             	RST	0
D18A                
D18A                COMANL:
D18A CD FB E0       	CALL	FILE
D18D 3A 19 EF       	LD	A,(FNAME+4)
D190 FE 20          	CP	020H
D192 20 1C          	JR	NZ,COMB2
D194 D5             	PUSH	DE
D195 11 15 EF       	LD	DE,FNAME
D198 1A             	LD	A,(DE)
D199 FE 20          	CP	020H
D19B 28 44          	JR	Z,SDVSW
D19D 1B             	DEC	DE
D19E 1A             	LD	A,(DE)
D19F C6 FF          	ADD	A,0FFH
D1A1 38 09          	JR	C,COMB
D1A3 13             	INC	DE
D1A4                
D1A4 21 D5 D6       	LD	HL,COMTB
D1A7 06 09          	LD	B,COMS
D1A9 CD 7F E3       	CALL	CPNAME
D1AC                COMB:
D1AC D1             	POP	DE
D1AD D2 0F 00       	JP	NC,JP_HL
D1B0                COMB2:
D1B0 EB             	EX	DE,HL
D1B1 22 89 D2       	LD	(COMPAT+1),HL
D1B4 F5             	PUSH	AF
D1B5 CD 35 D2       	CALL	CEXE4
D1B8 F1             	POP	AF
D1B9 21 15 EF       	LD	HL,FNAME
D1BC 11 6D 00       	LD	DE,FCB2+1	;COMMAND NAME
D1BF 01 0B 00       	LD	BC,11
D1C2 ED B0          	LDIR
D1C4 11 94 D6       	LD	DE,PATHD
D1C7                CEX1:
D1C7 1A             	LD	A,(DE)
D1C8 FE 20          	CP	020H
D1CA D8             	RET	C
D1CB CD F0 E0       	CALL	FILEC
D1CE D5             	PUSH	DE
D1CF 21 6D 00       	LD	HL,FCB2+1	;COMMAND NAME
D1D2 11 15 EF       	LD	DE,FNAME
D1D5 01 0B 00       	LD	BC,11
D1D8 ED B0          	LDIR
D1DA CD 35 D2       	CALL	CEXE4
D1DD D1             	POP	DE
D1DE 13             	INC	DE
D1DF 18 E6          	JR	CEX1
D1E1                
D1E1                SDVSW:
D1E1 F1             	POP	AF
D1E2 3A 14 EF       	LD	A,(FDRV)
D1E5 3D             	DEC	A
D1E6 5F             	LD	E,A
D1E7 0E 0E          	LD	C,00EH		;(BDOS)カレントドライブの設定
D1E9 18 31          	JR	SYSTEM0
D1EB                
D1EB                OPEN1:
D1EB 21 14 EF       	LD	HL,FDRV
D1EE                OPEN:
D1EE 0E 11          	LD	C,011H		;(BDOS)ファイルの検索
D1F0                OPEN3:
D1F0 D5             	PUSH	DE
D1F1 11 6F D6       	LD	DE,DTA_CCP
D1F4 CD 12 D2       	CALL	SETDTA
D1F7 EB             	EX	DE,HL
D1F8 CD 1C D2       	CALL	SYSTEM0
D1FB D1             	POP	DE
D1FC C9             	RET
D1FD                
D1FD                OPEN2:
D1FD 0E 12          	LD	C,012H
D1FF 18 EF          	JR	OPEN3
D201                
D201                DEFCB:				;Z=Ok NZ=Error
D201 11 6F D6       	LD	DE,DTA_CCP
D204 CD 1A D2       	CALL	SYSC0F
D207                
D207 11 90 D6       	LD	DE,DTA_CCP+33	;(FCB)ランダムレコード
D20A 06 04          	LD	B,4
D20C CD 08 D5       	CALL	ZERO_MEMORY_DE
D20F 11 00 01       	LD	DE,00100H
D212                SETDTA:
D212 C3 64 DA       	JP	_SYS1A		;(BDOS)DTAの設定
D215                
D215                SETDTA1:
D215 11 80 00       	LD	DE,DTA1
D218 18 F8          	JR	SETDTA
D21A                
D21A                SYSC0F:
D21A 0E 0F          	LD	C,00FH		;(BDOS)ファイルのオープン
D21C                SYSTEM0:
D21C CD 05 00       	CALL	SYSTEM
D21F B7             	OR	A
D220 C9             	RET
D221                
D221                C_CD:
D221 0E 5A          	LD	C,5AH
D223 18 F7          	JR	SYSTEM0
D225                
D225                S27BUF:
D225 3A 07 00       	LD	A,(SYSTEM+2)
D228 3D             	DEC	A
D229 E6 F8          	AND	0F8H
D22B 67             	LD	H,A
D22C 2E 00          	LD	L,0
D22E                S27DTA:
D22E 11 6F D6       	LD	DE,DTA_CCP
D231                S27:
D231 0E 27          	LD	C,027H		;(BDOS)ランダムブロック読み込み
D233 18 E7          	JR	SYSTEM0
D235                
D235                CEXE4:
D235 3A 14 EF       	LD	A,(FDRV)
D238 32 57 00       	LD	(00057H),A
D23B 2A 22 EF       	LD	HL,(FDRV+14)
D23E 22 58 00       	LD	(00058H),HL
D241                
D241 21 1D EF       	LD	HL,FNAME+8
D244 7E             	LD	A,(HL)
D245 FE 20          	CP	020H
D247 20 07          	JR	NZ,CEXE7
D249 3E 3F          	LD	A,'?'
D24B 77             	LD	(HL),A
D24C 23             	INC	HL
D24D 77             	LD	(HL),A
D24E 23             	INC	HL
D24F 77             	LD	(HL),A
D250                CEXE7:
D250 CD EB D1       	CALL	OPEN1
D253                CEXE5:
D253 C0             	RET	NZ
D254 2A 79 D6       	LD	HL,(DTA_CCP+1+9)
D257 7C             	LD	A,H
D258 CD 07 E4       	CALL	CAP
D25B 67             	LD	H,A
D25C 7D             	LD	A,L
D25D CD 07 E4       	CALL	CAP
D260 6F             	LD	L,A
D261 3A 78 D6       	LD	A,(DTA_CCP+1+8)
D264 CD 07 E4       	CALL	CAP
D267 D6 42          	SUB	'B'
D269 28 2C          	JR	Z,C_BAT
D26B 3D             	DEC	A		;'C'
D26C 28 05          	JR	Z,C_EXE
D26E                CEXE6:
D26E CD FD D1       	CALL	OPEN2
D271 18 E0          	JR	CEXE5
D273                
D273                C_EXE:
D273 7C             	LD	A,H
D274 FE 4D          	CP	'M'
D276 20 F6          	JR	NZ,CEXE6
D278                
D278 CD 01 D2       	CALL	DEFCB
D27B CD 25 D2       	CALL	S27BUF
D27E 3D             	DEC	A
D27F 37             	SCF
D280 C0             	RET	NZ
D281 7C             	LD	A,H
D282 B5             	OR	L
D283 37             	SCF
D284 C8             	RET	Z
D285 CD 15 D2       	CALL	SETDTA1
D288 11 00 00       COMPAT:	LD	DE,0				; self-modifying code
D28B ED 7B 06 00    	LD	SP,(SYSTEM+1)
D28F 67             	LD	H,A				; A=0 in SETDTA1(_SYS1A)
D290 6F             	LD	L,A
D291 E5             	PUSH	HL				; push $0000 (reboot address)
D292 24             	INC	H
D293 E5             	PUSH	HL				; push $0100 (TPA address)
D294 C3 D3 D4       	JP	SETFCB				; and JP $0100
D297                
D297                C_BAT:
D297 11 41 54       	LD	DE,'A'+'T'*256
D29A ED 52          	SBC	HL,DE
D29C 20 D0          	JR	NZ,CEXE6
D29E                
D29E F1             	POP	AF
D29F F1             	POP	AF
D2A0 CD 01 D2       	CALL	DEFCB
D2A3 21 00 02       	LD	HL,00200H
D2A6 CD 2E D2       	CALL	S27DTA
D2A9 C6 FE          	ADD	A,0FEH
D2AB D8             	RET	C
D2AC 7D             	LD	A,L
D2AD B7             	OR	A
D2AE 37             	SCF
D2AF C8             	RET	Z
D2B0 3C             	INC	A
D2B1 F5             	PUSH	AF
D2B2                
D2B2 CD ED DB       	CALL	KEYBC
D2B5 3E 06          	LD	A,6
D2B7 CD 24 DC       	CALL	MSG_A
D2BA C1             	POP	BC
D2BB 21 00 01       	LD	HL,00100H
D2BE                BAT1:
D2BE A7             	AND	A
D2BF 05             	DEC	B
D2C0 C8             	RET	Z
D2C1 7E             	LD	A,(HL)
D2C2 FE 25          	CP	'%'
D2C4 28 0C          	JR	Z,BAT2
D2C6                BAT1X:
D2C6 7E             	LD	A,(HL)
D2C7 23             	INC	HL
D2C8 FE 1A          	CP	01AH
D2CA C8             	RET	Z
D2CB FE 0A          	CP	00AH
D2CD C4 D2 DB       	CALL	NZ,KEYBS
D2D0 18 EC          	JR	BAT1
D2D2                
D2D2                BAT2:
D2D2 23             	INC	HL
D2D3 7E             	LD	A,(HL)
D2D4 2B             	DEC	HL
D2D5 D6 31          	SUB	'1'
D2D7 38 ED          	JR	C,BAT1X
D2D9 FE 09          	CP	9
D2DB 30 E9          	JR	NC,BAT1X
D2DD 23             	INC	HL
D2DE 23             	INC	HL
D2DF 3C             	INC	A
D2E0 4F             	LD	C,A
D2E1 ED 5B 89 D2    	LD	DE,(COMPAT+1)
D2E5                BAT3:
D2E5 1A             	LD	A,(DE)
D2E6 B7             	OR	A
D2E7 28 D5          	JR	Z,BAT1
D2E9 CD D2 E1       	CALL	SPCUT
D2EC 0D             	DEC	C
D2ED 28 08          	JR	Z,BAT5
D2EF                BAT4:
D2EF 1A             	LD	A,(DE)
D2F0 FE 21          	CP	021H
D2F2 38 F1          	JR	C,BAT3
D2F4 13             	INC	DE
D2F5 18 F8          	JR	BAT4
D2F7                BAT5:
D2F7 1A             	LD	A,(DE)
D2F8 FE 21          	CP	021H
D2FA 38 C2          	JR	C,BAT1
D2FC 13             	INC	DE
D2FD CD D2 DB       	CALL	KEYBS
D300 18 F5          	JR	BAT5
D302                
D302                SWITCH:
D302 1A             	LD	A,(DE)
D303                SW1:
D303 13             	INC	DE
D304 B9             	CP	C
D305 1A             	LD	A,(DE)
D306 C8             	RET	Z
D307 FE 20          	CP	020H
D309 30 F8          	JR	NC,SW1
D30B                C_REM:
D30B AF             	XOR	A
D30C C9             	RET
D30D                
D30D                C_DEL:
D30D CD D3 D4       	CALL	SETFCB
D310 CD 3A DC       	CALL	_SYS08		;(BDOS)エコーなしコンソール入力
D313                
D313 0E 13          	LD	C,013H
D315 18 0A          	JR	CDEL1		;(BDOS)ファイルの削除
D317                
D317                C_REN:
D317 CD D3 D4       	CALL	SETFCB
D31A 3E 10          	LD	A,010H		;ディレクトリも対象にする
D31C 32 69 00       	LD	(FCB1+13),A	;属性
D31F 0E 17          	LD	C,017H		;(BDOS)ファイル名の変更
D321                CDEL1:
D321 11 5C 00       	LD	DE,FCB1
D324 CD 05 00       	CALL	SYSTEM
D327 C6 FF          	ADD	A,0FFH
D329 C9             	RET
D32A                
D32A                C_DIR:
D32A CD F0 E0       	CALL	FILEC
D32D 21 15 EF       	LD	HL,FDRV+1
D330 CD 64 D6       	CALL	CWILD1
D333 3E F1          	LD	A,0F1H
D335 32 21 EF       	LD	(FDRV+13),A
D338 CD EB D1       	CALL	OPEN1
D33B                CDIR1:
D33B B7             	OR	A
D33C 20 08          	JR	NZ,PDSKF
D33E CD 89 D3       	CALL	P_NAME
D341 CD FD D1       	CALL	OPEN2
D344 18 F5          	JR	CDIR1
D346                
D346                PDSKF:
D346 3A 14 EF       	LD	A,(FDRV)
D349 5F             	LD	E,A
D34A 0E 1B          	LD	C,01BH		;(BDOS)ディスク情報の獲得
D34C CD 05 00       	CALL	SYSTEM
D34F 4F             	LD	C,A		;C←1クラスタ辺りの論理セクタ数
D350 C6 01          	ADD	A,001H
D352 D8             	RET	C		;Aが0FFHだった場合
D353 3E 06          	LD	A,8-2
D355                PDS1:				;HL=未使用クラスタの総数
D355 3C             	INC	A
D356 CB 19          	RR	C
D358 30 FB          	JR	NC,PDS1
D35A                PDS2:				;B←論理セクタのサイズの上位8ビット
D35A 3C             	INC	A
D35B CB 18          	RR	B
D35D 30 FB          	JR	NC,PDS2
D35F 47             	LD	B,A
D360                
D360 11 00 00       	LD	DE,0
D363                PDS3:
D363 29             	ADD	HL,HL
D364 CB 13          	RL	E
D366 CB 12          	RL	D
D368 10 F9          	DJNZ	PDS3
D36A                PDSKF1:
D36A CD 02 D4       	CALL	PRDEC_DEHL
D36D 11 0B D7       	LD	DE,FREE
D370 CD 60 D8       	CALL	_SYS09		;(BDOS)文字列出力
D373 CD F1 D3       	CALL	PUTDRV
D376 3E 5C          	LD	A,05CH
D378 CD 24 DC       	CALL	MSG_A
D37B 2A 22 EF       	LD	HL,(FDRV+14)	;ディレクトリのクラスタ番号
D37E AF             	XOR	A
D37F 11 FE FF       	LD	DE,0-2
D382 19             	ADD	HL,DE
D383 23             	INC	HL
D384 DC FE D3       	CALL	C,PRDEC_HL
D387 18 41          	JR	LTNL
D389                
D389                P_NAME:
D389 3A 70 D6       	LD	A,(DTA_CCP+1)
D38C FE 2E          	CP	'.'
D38E C8             	RET	Z
D38F 11 23 D7       	LD	DE,DIRHD
D392 CD 60 D8       	CALL	_SYS09		;(BDOS)文字列出力
D395 3A 7B D6       	LD	A,(DTA_CCP+1+00BH)
D398 F5             	PUSH	AF
D399 0F             	RRCA
D39A 9F             	SBC	A,A
D39B E6 0A          	AND	'*'-020H
D39D C6 20          	ADD	A,020H
D39F CD 24 DC       	CALL	MSG_A
D3A2 CD F1 D3       	CALL	PUTDRV
D3A5 21 70 D6       	LD	HL,DTA_CCP+1
D3A8 CD 42 D4       	CALL	FPRNT
D3AB                
D3AB F1             	POP	AF
D3AC CB 67          	BIT	4,A
D3AE 28 08          	JR	Z,DIR3
D3B0 11 18 D7       	LD	DE,DIRMES
D3B3 CD 60 D8       	CALL	_SYS09		;(BDOS)文字列出力
D3B6 18 0A          	JR	DIR6
D3B8                DIR3:
D3B8 ED 5B 8E D6    	LD	DE,(DTA_CCP+1+01EH)
D3BC 2A 8C D6       	LD	HL,(DTA_CCP+1+01CH)
D3BF CD 02 D4       	CALL	PRDEC_DEHL
D3C2                DIR6:
D3C2 3A B1 EF       	LD	A,(CRTCD+1)
D3C5 FE 29          	CP	40+1
D3C7 D4 64 D4       	CALL	NC,PRTTMS
D3CA                
D3CA                LTNL:
D3CA 1E 03          	LD	E,3
D3CC C3 CD EF       	JP	_PRINT
D3CF                
D3CF                C_PATH:
D3CF CD D2 E1       	CALL	SPCUT
D3D2 21 94 D6       	LD	HL,PATHD
D3D5 FE 21          	CP	021H
D3D7 30 0C          	JR	NC,CPATH0
D3D9                CPATHP:
D3D9 7E             	LD	A,(HL)
D3DA 23             	INC	HL
D3DB FE 20          	CP	020H
D3DD 3F             	CCF
D3DE 30 EA          	JR	NC,LTNL
D3E0 CD 24 DC       	CALL	MSG_A
D3E3 18 F4          	JR	CPATHP
D3E5                CPATH0:
D3E5 FE 3B          	CP	';'
D3E7 20 01          	JR	NZ,CPATH1
D3E9 13             	INC	DE
D3EA                CPATH1:
D3EA EB             	EX	DE,HL
D3EB 01 40 00       	LD	BC,PATHX
D3EE ED B0          	LDIR
D3F0 C9             	RET
D3F1                
D3F1                PUTDRV:
D3F1 3A 14 EF       	LD	A,(FDRV)
D3F4 C6 40          	ADD	A,'A'-1
D3F6 CD 24 DC       	CALL	MSG_A
D3F9 3E 3A          	LD	A,':'
D3FB                MSG_AR:
D3FB C3 24 DC       	JP	MSG_A
D3FE                
D3FE                PRDEC_HL:
D3FE AF             	XOR	A
D3FF                PRDEC_AHL:
D3FF 5F             	LD	E,A
D400 16 00          	LD	D,0
D402                PRDEC_DEHL:
D402 D5             	PUSH	DE
D403 11 0F EF       	LD	DE,DECBF
D406 06 05          	LD	B,5
D408 CD 08 D5       	CALL	ZERO_MEMORY_DE	;A=0
D40B D1             	POP	DE
D40C                
D40C 0E 20          	LD	C,32
D40E                DEC1:
D40E 29             	ADD	HL,HL
D40F EB             	EX	DE,HL
D410 ED 6A          	ADC	HL,HL
D412 EB             	EX	DE,HL
D413 E5             	PUSH	HL
D414 21 13 EF       	LD	HL,DECBF+4
D417 06 05          	LD	B,5
D419                DEC2:
D419 7E             	LD	A,(HL)
D41A 8F             	ADC	A,A
D41B 27             	DAA
D41C 77             	LD	(HL),A
D41D 2B             	DEC	HL
D41E 10 F9          	DJNZ	DEC2
D420 E1             	POP	HL
D421 0D             	DEC	C
D422 20 EA          	JR	NZ,DEC1
D424                
D424 21 0F EF       	LD	HL,DECBF
D427 3E 20          	LD	A,020H
D429 06 04          	LD	B,4
D42B                DEC3:
D42B CD 38 D4       	CALL	DEC4
D42E CD 38 D4       	CALL	DEC4
D431 23             	INC	HL
D432 10 F7          	DJNZ	DEC3
D434                DECX:
D434 CD 38 D4       	CALL	DEC4
D437 AF             	XOR	A
D438                DEC4:
D438 ED 6F          	RLD
D43A FE 20          	CP	020H
D43C 28 02          	JR	Z,DEC5
D43E F6 30          	OR	030H
D440                DEC5:
D440 18 B9          	JR	MSG_AR
D442                
D442                FPRNT:
D442 06 08          	LD	B,8
D444 CD 55 D4       	CALL	P_N1
D447 7E             	LD	A,(HL)
D448 C6 80          	ADD	A,0A0H-020H
D44A FE A0          	CP	0A0H
D44C 28 02          	JR	Z,FPR1
D44E 3E 2E          	LD	A,'.'
D450                FPR1:
D450 CD 24 DC       	CALL	MSG_A
D453 06 03          	LD	B,3
D455                
D455                P_N1:
D455 C5             	PUSH	BC
D456 E5             	PUSH	HL
D457 7E             	LD	A,(HL)
D458 CD 13 E4       	CALL	CAP3
D45B CD 24 DC       	CALL	MSG_A
D45E E1             	POP	HL
D45F C1             	POP	BC
D460 23             	INC	HL
D461 10 F2          	DJNZ	P_N1
D463 C9             	RET
D464                
D464                PRTTMS:
D464 3E 20          	LD	A,020H
D466 CD 24 DC       	CALL	MSG_A
D469                
D469 2A 88 D6       	LD	HL,(DTA_CCP+1+24)
D46C 7D             	LD	A,L
D46D B7             	OR	A
D46E C8             	RET	Z
D46F CB 3C          	SRL	H
D471 17             	RLA
D472 17             	RLA
D473 17             	RLA
D474 17             	RLA
D475 E6 0F          	AND	00FH
D477 57             	LD	D,A
D478 7C             	LD	A,H
D479 C6 50          	ADD	A,80
D47B CD BE D4       	CALL	PRDEC_A
D47E 3E 2D          	LD	A,'-'
D480 CD 24 DC       	CALL	MSG_A
D483 7A             	LD	A,D
D484 CD BE D4       	CALL	PRDEC_A
D487 3E 2D          	LD	A,'-'
D489 CD 24 DC       	CALL	MSG_A
D48C 7D             	LD	A,L
D48D E6 1F          	AND	01FH
D48F CD BE D4       	CALL	PRDEC_A
D492                
D492 2A 86 D6       	LD	HL,(DTA_CCP+1+22)
D495                
D495 3E 20          	LD	A,020H
D497 CD 24 DC       	CALL	MSG_A
D49A 7C             	LD	A,H
D49B 65             	LD	H,L
D49C 06 03          	LD	B,3
D49E                PRTTMS1:
D49E 1F             	RRA
D49F CB 1D          	RR	L
D4A1 10 FB          	DJNZ	PRTTMS1
D4A3 E6 1F          	AND	01FH
D4A5 CD BE D4       	CALL	PRDEC_A
D4A8 3E 3A          	LD	A,':'
D4AA CD 24 DC       	CALL	MSG_A
D4AD 7D             	LD	A,L
D4AE 0F             	RRCA
D4AF 0F             	RRCA
D4B0 E6 3F          	AND	03FH
D4B2 CD BE D4       	CALL	PRDEC_A
D4B5 3E 3A          	LD	A,':'
D4B7 CD 24 DC       	CALL	MSG_A
D4BA 7C             	LD	A,H
D4BB E6 1F          	AND	01FH
D4BD 87             	ADD	A,A
D4BE                
D4BE                ;	PRINT10
D4BE                
D4BE                PRDEC_A:
D4BE E5             	PUSH	HL
D4BF 06 08          	LD	B,8
D4C1 4F             	LD	C,A
D4C2 AF             	XOR	A
D4C3                PRTA1:
D4C3 CB 01          	RLC	C
D4C5 8F             	ADC	A,A
D4C6 27             	DAA
D4C7 10 FA          	DJNZ	PRTA1
D4C9 21 0F EF       	LD	HL,DECBF
D4CC 77             	LD	(HL),A
D4CD AF             	XOR	A
D4CE CD 34 D4       	CALL	DECX
D4D1 E1             	POP	HL
D4D2 C9             	RET
D4D3                
D4D3                SETFCB:
D4D3 CD D2 E1       	CALL	SPCUT
D4D6 1A             	LD	A,(DE)
D4D7 FE 20          	CP	020H
D4D9 38 01          	JR	C,SETFCBA
D4DB 1B             	DEC	DE
D4DC                SETFCBA:
D4DC 06 24          	LD	B,36
D4DE 21 5C 00       	LD	HL,FCB1
D4E1 E5             	PUSH	HL
D4E2 AF             	XOR	A
D4E3 CD A7 E1       	CALL	FILL_MEMORY
D4E6 E1             	POP	HL
D4E7 D5             	PUSH	DE
D4E8 CD C3 DA       	CALL	_SYS5C		;(BDOS)ファイル名の解析
D4EB 21 6C 00       	LD	HL,FCB2
D4EE CD C3 DA       	CALL	_SYS5C		;(BDOS)ファイル名の解析
D4F1 E1             	POP	HL
D4F2 01 00 50       	LD	BC,05000H
D4F5 11 81 00       	LD	DE,00081H
D4F8                SETFCB1:
D4F8 7E             	LD	A,(HL)
D4F9 23             	INC	HL
D4FA FE 20          	CP	020H
D4FC 38 05          	JR	C,SETFCB2
D4FE 12             	LD	(DE),A
D4FF 13             	INC	DE
D500 0C             	INC	C
D501 10 F5          	DJNZ	SETFCB1
D503                SETFCB2:
D503 79             	LD	A,C
D504 32 80 00       	LD	(DTA1),A
D507 04             	INC	B
D508                ZERO_MEMORY_DE:
D508 AF             	XOR	A
D509                FILL_MEMORY_DE:
D509 12             	LD	(DE),A
D50A 13             	INC	DE
D50B 10 FC          	DJNZ	FILL_MEMORY_DE
D50D C9             	RET
D50E                
D50E                C_COPY:
D50E CD D3 D4       	CALL	SETFCB
D511 11 81 00       	LD	DE,DTA1+1
D514 0E 2F          	LD	C,'/'
D516 CD 02 D3       	CALL	SWITCH
D519 CD 07 E4       	CALL	CAP
D51C 32 A4 D5       	LD	(SW+1),A
D51F                
D51F 11 61 EF       	LD	DE,BEEPD
D522 CD F3 E0       	CALL	FILEC2
D525 21 6C 00       	LD	HL,FCB2
D528 CD CA DA       	CALL	S29X1
D52B                
D52B 3E 10          	LD	A,010H
D52D 32 69 00       	LD	(FCB1+13),A
D530 21 6D 00       	LD	HL,FCB2+1
D533 CD 64 D6       	CALL	CWILD1
D536                COPY0:
D536 CD 61 D6       	CALL	CWILD
D539 21 5C 00       	LD	HL,FCB1
D53C CD EE D1       	CALL	OPEN
D53F 37             	SCF
D540                COPY1:
D540 C0             	RET	NZ
D541 CD 01 D2       	CALL	DEFCB
D544                
D544 3A 7C D6       	LD	A,(DTA_CCP+13)
D547 CB 67          	BIT	4,A
D549 28 24          	JR	Z,COPY1A
D54B                
D54B 21 5D 00       	LD	HL,FCB1+1
D54E CD 36 E5       	CALL	CHKWILD
D551 38 17          	JR	C,COPY9
D553                
D553 3E 20          	LD	A,020H
D555 32 5D 00       	LD	(FCB1+1),A
D558 2A 89 D6       	LD	HL,(DTA_CCP+26)
D55B 23             	INC	HL
D55C 22 6A 00       	LD	(FCB1+14),HL
D55F 18 D5          	JR	COPY0
D561                
D561                COPYS:
D561 11 74 EF       	LD	DE,SKIP
D564                COPY8:
D564 CD 60 D8       	CALL	_SYS09		;(BDOS)文字列出力
D567 CD CA D3       	CALL	LTNL
D56A                COPY9:
D56A CD FD D1       	CALL	OPEN2
D56D 18 D1          	JR	COPY1
D56F                
D56F                COPY1A:
D56F 21 6C 00       	LD	HL,FCB2
D572 11 14 EF       	LD	DE,FDRV
D575 01 71 D6       	LD	BC,DTA_CCP+2
D578 ED A0          	LDI
D57A 3E 0B          	LD	A,11
D57C                COPY2:
D57C F5             	PUSH	AF
D57D 7E             	LD	A,(HL)
D57E FE 3F          	CP	'?'
D580 20 01          	JR	NZ,COPY3
D582 0A             	LD	A,(BC)
D583                COPY3:
D583 12             	LD	(DE),A
D584 03             	INC	BC
D585 13             	INC	DE
D586 23             	INC	HL
D587 F1             	POP	AF
D588 3D             	DEC	A
D589 20 F1          	JR	NZ,COPY2
D58B 01 05 00       	LD	BC,16-11
D58E ED B0          	LDIR
D590                PUTNAME:
D590 21 5D 00       	LD	HL,FCB1+1
D593 CD 36 E5       	CALL	CHKWILD
D596 30 0B          	JR	NC,PUTN1
D598 21 15 EF       	LD	HL,FDRV+1
D59B CD 42 D4       	CALL	FPRNT
D59E 3E 20          	LD	A,020H
D5A0 CD 24 DC       	CALL	MSG_A
D5A3                PUTN1:
D5A3 3E 00          SW:	LD	A,000H
D5A5 FE 54          	CP	'T'
D5A7 20 05          	JR	NZ,CSW1
D5A9 21 C3 D5       	LD	HL,SWNE
D5AC 18 07          	JR	SWT1
D5AE                CSW1:
D5AE FE 4E          	CP	'N'
D5B0 20 11          	JR	NZ,SWNE
D5B2 21 61 D5       	LD	HL,COPYS
D5B5                SWT1:
D5B5 11 14 EF       	LD	DE,FDRV
D5B8 CD 1A D2       	CALL	SYSC0F
D5BB 28 01          	JR	Z,SWN1
D5BD E9             	JP	(HL)
D5BE                SWN1:
D5BE CD 17 D6       	CALL	CTIME
D5C1 30 9E          	JR	NC,COPYS
D5C3                SWNE:
D5C3 11 14 EF       	LD	DE,FDRV
D5C6 0E 16          	LD	C,016H		;(BDOS)ファイルの作成
D5C8 CD 1C D2       	CALL	SYSTEM0
D5CB 20 48          	JR	NZ,COPYE2
D5CD 67             	LD	H,A		;A=0
D5CE 6F             	LD	L,A
D5CF 22 35 EF       	LD	(FDRV+33),HL	;(FCB)ランダムレコード
D5D2 22 37 EF       	LD	(FDRV+35),HL
D5D5                COPY6:
D5D5 CD 25 D2       	CALL	S27BUF
D5D8 47             	LD	B,A
D5D9 3C             	INC	A
D5DA 28 31          	JR	Z,COPYE
D5DC 7C             	LD	A,H
D5DD B5             	OR	L
D5DE 28 0C          	JR	Z,COPY7
D5E0 11 14 EF       	LD	DE,FDRV
D5E3 0E 26          	LD	C,026H		;(BDOS)ランダムブロック書き込み
D5E5 CD 1C D2       	CALL	SYSTEM0
D5E8 20 23          	JR	NZ,COPYE
D5EA 10 E9          	DJNZ	COPY6
D5EC                COPY7:
D5EC 3A 7C D6       	LD	A,(DTA_CCP+13)	;(FCB)属性
D5EF 32 21 EF       	LD	(FDRV+13),A
D5F2 21 83 D6       	LD	HL,DTA_CCP+20	;(FCB)タイムスタンプ
D5F5 11 28 EF       	LD	DE,FDRV+20
D5F8 01 04 00       	LD	BC,4
D5FB ED B0          	LDIR
D5FD                
D5FD 11 14 EF       	LD	DE,FDRV
D600 0E 10          	LD	C,010H		;(BDOS)ファイルのクローズ
D602 CD 1C D2       	CALL	SYSTEM0
D605 20 06          	JR	NZ,COPYE
D607                
D607 11 71 EF       	LD	DE,OK
D60A C3 64 D5       	JP	COPY8
D60D                
D60D                COPYE:
D60D 11 14 EF       	LD	DE,FDRV
D610 0E 13          	LD	C,013H		;(BDOS)ファイルの削除
D612 CD 05 00       	CALL	SYSTEM
D615                COPYE2:
D615 37             	SCF
D616 C9             	RET
D617                
D617                CTIME:
D617 ED 5B 83 D6    	LD	DE,(DTA_CCP+20)
D61B 2A 28 EF       	LD	HL,(FDRV+20)
D61E A7             	AND	A
D61F ED 52          	SBC	HL,DE
D621 C0             	RET	NZ
D622 ED 5B 85 D6    	LD	DE,(DTA_CCP+22)
D626 2A 2A EF       	LD	HL,(FDRV+22)
D629 ED 52          	SBC	HL,DE
D62B C9             	RET
D62C                
D62C                C_TYPE:
D62C CD D3 D4       	CALL	SETFCB
D62F 21 5C 00       	LD	HL,FCB1
D632 CD EE D1       	CALL	OPEN
D635 37             	SCF
D636                TYPE1:
D636 C0             	RET	NZ
D637 CD 01 D2       	CALL	DEFCB
D63A 3E 06          	LD	A,6
D63C CD 24 DC       	CALL	MSG_A
D63F                TYPE2:
D63F CD 25 D2       	CALL	S27BUF
D642 C6 FE          	ADD	A,0FEH
D644 D8             	RET	C
D645 7C             	LD	A,H
D646 B5             	OR	L
D647 28 13          	JR	Z,TYPEE
D649 01 00 01       	LD	BC,00100H
D64C                TYPE3:
D64C 0A             	LD	A,(BC)
D64D 03             	INC	BC
D64E FE 1A          	CP	01AH
D650 28 0A          	JR	Z,TYPEE
D652 CD 24 DC       	CALL	MSG_A
D655 2B             	DEC	HL
D656 7C             	LD	A,H
D657 B5             	OR	L
D658 20 F2          	JR	NZ,TYPE3
D65A 18 E3          	JR	TYPE2
D65C                TYPEE:
D65C CD FD D1       	CALL	OPEN2
D65F 18 D5          	JR	TYPE1
D661                
D661                CWILD:
D661 21 5D 00       	LD	HL,FCB1+1
D664                CWILD1:
D664 7E             	LD	A,(HL)
D665 FE 20          	CP	020H
D667 C0             	RET	NZ
D668                CWILD2:
D668 3E 3F          	LD	A,'?'
D66A 06 0B          	LD	B,11
D66C C3 A7 E1       	JP	FILL_MEMORY
D66F                
D66F                DTA_CCP:
D66F                	DS	37
D694                
D694 00 00 00 40    PATHX	EQU	64
D694                PATHD:	DS	PATHX
D6D4 00             PATHE:	DB	0
D6D5                
D6D5 00 00 00 09    COMS	EQU	9
D6D5                COMTB:
D6D5 44 20 20 20    	DB	"D   "	;1
D6D9 2A D3          	DW	C_DIR
D6DB 44 49 52 20    	DB	"DIR "	;2
D6DF 2A D3          	DW	C_DIR
D6E1 43 4F 50 59    	DB	"COPY"	;3
D6E5 0E D5          	DW	C_COPY
D6E7 43 44 20 20    	DB	"CD  "	;4
D6EB 21 D2          	DW	C_CD
D6ED 44 45 4C 20    	DB	"DEL "	;5
D6F1 0D D3          	DW	C_DEL
D6F3 50 41 54 48    	DB	"PATH"	;6
D6F7 CF D3          	DW	C_PATH
D6F9 52 45 4E 20    	DB	"REN "	;7
D6FD 17 D3          	DW	C_REN
D6FF 54 59 50 45    	DB	"TYPE"	;8
D703 2C D6          	DW	C_TYPE
D705 52 45 4D 20    	DB	"REM "	;9
D709 0B D3          	DW	C_REM
D70B                
D70B 20 62 79 74    FREE:	DB	" bytes free",9,'$'
D70F 65 73 20 66
D713 72 65 65 09
D717 24
D718 20 20 20 20    DIRMES:	DB	"     <DIR>$"
D71C 20 3C 44 49
D720 52 3E 24
D723 20 20 3A 24    DIRHD:	DB	"  :$"
D727                	INCLUDE	"LDDISK2.ASM"
D727                
D727                ;	LSX-Dodgers DISK2
D727                
D727                
D727                ;	GRAPHIC RAM DISK DRIVER
D727                
D727                
D727                GDRD:
D727 C5             	PUSH	BC
D728 CD 50 D7       	CALL	GADR
D72B F1             	POP	AF
D72C                GDRD1:
D72C ED A2          	INI
D72E 04             	INC	B
D72F 0C             	INC	C
D730 20 FA          	JR	NZ,GDRD1
D732 04             	INC	B
D733 13             	INC	DE
D734 3D             	DEC	A
D735 20 F5          	JR	NZ,GDRD1
D737                GBANK0:
D737 3A BF EF       	LD	A,(WK1FD0)
D73A E6 EF          	AND	0EFH		;BANK0
D73C 18 1D          	JR	S1FD0
D73E                
D73E                GDWT:
D73E C5             	PUSH	BC
D73F CD 50 D7       	CALL	GADR
D742 F1             	POP	AF
D743                GDWT1:
D743 04             	INC	B
D744 ED A3          	OUTI
D746 0C             	INC	C
D747 20 FA          	JR	NZ,GDWT1
D749 04             	INC	B
D74A 13             	INC	DE
D74B 3D             	DEC	A
D74C 20 F5          	JR	NZ,GDWT1
D74E 18 E7          	JR	GBANK0
D750                
D750                GADR:
D750 0E 00          	LD	C,0
D752 7B             	LD	A,E
D753 C6 40          	ADD	A,040H
D755 47             	LD	B,A
D756 3A BF EF       	LD	A,(WK1FD0)
D759 F6 10          	OR	010H		;BANK1
D75B                S1FD0:
D75B C5             	PUSH	BC
D75C 32 BF EF       	LD	(WK1FD0),A
D75F 01 D0 1F       	LD	BC,01FD0H
D762 ED 79          	OUT	(C),A
D764 C1             	POP	BC
D765 C9             	RET
D766                
D766                
D766                ;	BANK RAM DISK DRIVER
D766                
D766                BDWT:
D766 3E             	DB	03EH	;LD A,??
D767 37             	SCF
D768 18 02          	JR	BRW
D76A                
D76A                BDRD:
D76A 3E             	DB	03EH	;LD A,??
D76B A7             	AND	A
D76C                BRW:
D76C F3             	DI
D76D 32 95 D7       	LD	(BRWPAT),A
D770 ED 73 B5 D7    	LD	(BANKSP+1),SP
D774 3A B6 D7       	LD	A,(BANKSP+2)
D777 87             	ADD	A,A
D778 38 03          	JR	C,BRW0
D77A 31 CA FF       	LD	SP,EXTSP
D77D                BRW0:
D77D D9             	EXX		;裏レジスタ
D77E C5             	 PUSH	 BC
D77F D5             	 PUSH	 DE
D780 01 00 0B       	 LD	 BC,00B00H	 ;バンクメモリ
D783 11 10 10       	 LD	 DE,01010H
D786 D9             	 EXX		;表レジスタ
D787                BRW1:
D787 C5             	PUSH	BC
D788 D5             	PUSH	DE
D789 EB             	EX	DE,HL
D78A 29             	ADD	HL,HL
D78B 29             	ADD	HL,HL
D78C 7C             	LD	A,H
D78D E6 0F          	AND	00FH	;バンク
D78F 65             	LD	H,L
D790 CB 3C          	SRL	H	;/2
D792 2E 00          	LD	L,0
D794 D9             	EXX		;裏レジスタ
D795 A7             BRWPAT:	 AND	 A	;自己書き換え(AND A:読み出し/SCF:書き込み)
D796 38 08          	 JR	 C,BRWT
D798 57             	 LD	 D,A	 ;D=バンク
D799 D9             	 EXX		;表レジスタ
D79A EB             	EX	DE,HL
D79B CD B9 D7       	CALL	BTFR
D79E 18 06          	JR	BRW2
D7A0                BRWT:
D7A0 5F             	 LD	E,A	 ;E=バンク
D7A1 D9             	 EXX		;表レジスタ
D7A2 CD B9 D7       	CALL	BTFR
D7A5 EB             	EX	DE,HL
D7A6                BRW2:
D7A6 D1             	POP	DE
D7A7 C1             	POP	BC
D7A8 13             	INC	DE
D7A9 10 DC          	DJNZ	BRW1
D7AB                
D7AB D9             	EXX		;裏レジスタ
D7AC 3E 10          	 LD	 A,10H
D7AE ED 79          	 OUT	 (C),A		;メインメモリに切り替える
D7B0 D1             	 POP	 DE
D7B1 C1             	 POP	 BC
D7B2 D9             	 EXX		;表レジスタ
D7B3 AF             	XOR	A
D7B4 31 00 00       BANKSP:	LD	SP,0
D7B7 FB             	EI
D7B8 C9             	RET
D7B9                
D7B9                ;メインメモリ←→バンクメモリ 512バイトの転送を行う
D7B9                ; DE:転送元アドレス
D7B9                ; HL:転送先アドレス
D7B9                ; 裏BC:バンク切り替えポート(0B00H)
D7B9                ; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
D7B9                ; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
D7B9                
D7B9                BTFR:
D7B9 06 00          	LD	B,0	;256回ループ(256*2)
D7BB                BTFR1:
D7BB D9             	EXX		;裏レジスタ
D7BC ED 51          	 OUT	 (C),D	 ;BANK(MAIN)
D7BE D9             	 EXX		;表レジスタ
D7BF 1A             	LD	A,(DE)
D7C0 4F             	LD	C,A
D7C1 13             	INC	DE
D7C2 1A             	LD	A,(DE)
D7C3 13             	INC	DE
D7C4 D9             	EXX		;裏レジスタ
D7C5 ED 59          	 OUT	 (C),E	 ;MAIN(BANK)
D7C7 D9             	 EXX		;表レジスタ
D7C8 71             	LD	(HL),C
D7C9 23             	INC	HL
D7CA 77             	LD	(HL),A
D7CB 23             	INC	HL
D7CC 10 ED          	DJNZ	BTFR1
D7CE C9             	RET
D7CF                
D7CF                ;	EMM DRIVER(DMA)
D7CF                
D7CF                
D7CF                EDWT:
D7CF 0E 0F          	LD	C,15
D7D1 18 02          	JR	EDWT1
D7D3                EDRD:
D7D3 0E 0E          	LD	C,14
D7D5                EDWT1:
D7D5 C5             	PUSH	BC
D7D6 D5             	PUSH	DE
D7D7 22 18 D8       	LD	(DMAB),HL
D7DA 78             	LD	A,B
D7DB 87             	ADD	A,A
D7DC 3D             	DEC	A
D7DD 32 11 D8       	LD	(DMALEN+1),A
D7E0 3C             	INC	A
D7E1 84             	ADD	A,H	;HL(アドレス)を先に進めておく
D7E2 67             	LD	H,A
D7E3 EB             	EX	DE,HL
D7E4 29             	ADD	HL,HL
D7E5 3A A1 EF       	LD	A,(_MAXCYL)
D7E8 47             	LD	B,A
D7E9 79             	LD	A,C
D7EA 0E 00          	LD	C,0
D7EC 09             	ADD	HL,BC
D7ED ED 4B 84 EF    	LD	BC,(_DRIVE)
D7F1 06 0D          	LD	B,00DH
D7F3 ED 49          	OUT	(C),C
D7F5 0C             	INC	C
D7F6 ED 69          	OUT	(C),L
D7F8 0C             	INC	C
D7F9 ED 61          	OUT	(C),H
D7FB                
D7FB 21 0C D8       	LD	HL,EDMAD
D7FE CD F5 DF       	CALL	SETDMA
D801 CD 1D E0       	CALL	GO_DMA
D804 EB             	EX	DE,HL
D805 D1             	POP	DE
D806 C1             	POP	BC
D807                DMA_ADD_SEC:
D807 13             	INC	DE
D808 10 FD          	DJNZ	DMA_ADD_SEC
D80A AF             	XOR	A
D80B C9             	RET
D80C                
D80C                EDMAD:
D80C C3             	DB	0C3H	;WR6 リセット
D80D 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
D80E 03 0D          	DW	00D03H	;ポートA開始アドレス EMMリード/ライト
D810 FF 01          DMALEN:	DW	001FFH	;ブロック長(転送サイズ-1)
D812 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
D813 50             	DB	050H	;WR2 ポートBアドレスインクリメント メモリ
D814 02             	DB	002H	;ポートBタイミング
D815 80             	DB	080H	;WR3
D816 9A             	DB	09AH	;WR5 WAIT RDY:HIGH
D817 AD             	DB	0ADH	;WR4 連続 ポートB開始アドレス
D818 00 00          DMAB:	DW	0
D81A 01             	DB	001H	;WR0 ポートA←ポートB 転送
D81B                EMME:
D81B                
D81B 00 00 07 56    AT_RE	EQU	EDWT-AT_EDWT
D81B                
D81B                	INCLUDE	"LDOS.ASM"
D81B                
D81B                ;	LSX-Dodgers OS
D81B                
D81B                BDOS0:
D81B E5             	PUSH	HL
D81C 21 00 01       	LD	HL,00100H
D81F 39             	ADD	HL,SP
D820 38 10          	JR	C,BDOS1X
D822                BDOS2:
D822 E1             	POP	HL
D823 ED 73 2E D8    	LD	(BDSP+1),SP
D827 31 CA FF       	LD	SP,EXTSP
D82A CD 31 D8       	CALL	BDOS1
D82D 31 00 00       BDSP:	LD	SP,0
D830 C9             	RET
D831                BDOS1:
D831 E5             	PUSH	HL
D832                BDOS1X:
D832 79             	LD	A,C
D833 FE 3C          	CP	03CH
D835 38 02          	JR	C,DOS1
D837 3E 3C          	LD	A,03CH
D839                DOS1:
D839 87             	ADD	A,A
D83A 6F             	LD	L,A
D83B 26 F0          	LD	H,STABLE/256
D83D 7E             	LD	A,(HL)
D83E 2C             	INC	L
D83F 66             	LD	H,(HL)
D840 6F             	LD	L,A
D841 E3             	EX	(SP),HL
D842 79             	LD	A,C
D843 C9             	RET
D844                _DOS2:
D844 FE 5A          	CP	05AH		;(BDOS)カレントディレクトリの変更(_CHDIR)
D846 CA 07 DB       	JP	Z,_SYS5A
D849 FE 5C          	CP	05CH		;(BDOS)ファイル名の解析(_PFILE)
D84B CA C3 DA       	JP	Z,_SYS5C
D84E FE 5F          	CP	05FH		;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
D850 CA 62 ED       	JP	Z,_SYS5F
D853 FE 6F          	CP	06FH		;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
D855 20 07          	JR	NZ,_ERROR
D857 01 1D 01       	LD	BC,011DH
D85A 11 46 01       	LD	DE,VER
D85D AF             	XOR	A
D85E                _ERROR:
D85E A7             	AND	A
D85F C9             	RET
D860                
D860                _SYS09:		;文字列出力
D860 D5             	PUSH	DE
D861                _SX09:
D861 1A             	LD	A,(DE)
D862 13             	INC	DE
D863 FE 24          	CP	'$'
D865 28 31          	JR	Z,SX0E2
D867 CD 24 DC       	CALL	MSG_A
D86A 18 F5          	JR	_SX09
D86C                
D86C                MSX1:
D86C CD 24 DC       	CALL	MSG_A
D86F                MSX:
D86F 7E             	LD	A,(HL)
D870 23             	INC	HL
D871 B7             	OR	A
D872 20 F8          	JR	NZ,MSX1
D874 C9             	RET
D875                
D875                _SYS0C:		;(BDOS)バージョン番号の獲得
D875 21 22 00       	LD	HL,00022H
D878 7D             	LD	A,L
D879 C9             	RET
D87A                
D87A                _SYS0D:		;(BDOS)ディスクリセット
D87A CD DF EF       	CALL	_FFLUSH
D87D E5             	PUSH	HL
D87E 21 80 00       	LD	HL,00080H
D881 22 8A EF       	LD	(_DTA),HL
D884 E1             	POP	HL
D885 D5             	PUSH	DE
D886 1E 00          	LD	E,0
D888 3E             	DB	03EH
D889                
D889                _SYS0E:		;(BDOS)カレントドライブの設定
D889 D5             	PUSH	DE
D88A 7B             	LD	A,E
D88B DD E5          	PUSH	IX
D88D CD DC EF       	CALL	_GETDPB
D890 DD E1          	POP	IX
D892 38 04          	JR	C,SX0E2
D894 7B             	LD	A,E
D895 32 87 EF       	LD	(_DVSW),A
D898                SX0E2:
D898 3E 08          	LD	A,8
D89A D1             	POP	DE
D89B C9             	RET
D89C                
D89C                _SYS0F:		;(BDOS)ファイルのオープン
D89C CD E4 E1       	CALL	SETDRV
D89F FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D8A2 C6 02          	ADD	A,002H		;Write
D8A4 28 48          	JR	Z,FEND0F
D8A6 CD 32 E5       	CALL	CHKWILDX
D8A9                
D8A9 D4 04 E2       	CALL	NC,SOPENX
D8AC                _S16XX:
D8AC 38 40          	JR	C,FEND0F
D8AE                				;Directory location
D8AE 3A 9F EF       	LD	A,(_FILEN)
D8B1 FD 77 19       	LD	(IY+25),A	;(FCB)ディレクトリロケーション
D8B4                ;				_DIRF
D8B4 3A A0 EF       	LD	A,(_DIRF)
D8B7 FD 77 1D       	LD	(IY+29),A	;(FCB)ディレクトリモード
D8BA                ;				_FBPS
D8BA FD 73 1E       	LD	(IY+30),E	;(FCB)ディレクトリポジション
D8BD FD 72 1F       	LD	(IY+31),D
D8C0                ;				Open(Read)
D8C0 FD 36 1C FF    	LD	(IY+28),0FFH	;(FCB)オープンモード
D8C4                ;				FILENAME
D8C4 FD E5          	PUSH	IY
D8C6 D1             	POP	DE
D8C7 13             	INC	DE
D8C8 01 0B 00       	LD	BC,11
D8CB ED B0          	LDIR
D8CD                ;				Attribute
D8CD 7E             	LD	A,(HL)
D8CE FD 77 0D       	LD	(IY+13),A	;(FCB)属性(アトリビュート)
D8D1 11 0B 00       	LD	DE,11		;Reserved
D8D4 19             	ADD	HL,DE
D8D5                					;(FCB)ファイルを最後に変更した時刻
D8D5 11 EA F0       	LD	DE,SDDATA		;(FCB)ファイルを最後に変更した日付
D8D8 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
D8DA                S16LOOP:				;(FCB)ファイルのサイズ(バイト単位)
D8DA 1A             	LD	A,(DE)
D8DB 13             	INC	DE
D8DC 32 E3 D8       	LD	(S16PAT+2),A
D8DF 7E             	LD	A,(HL)
D8E0 23             	INC	HL
D8E1 FD 77 00       S16PAT:	LD	(IY+0),A
D8E4 10 F4          	DJNZ	S16LOOP
D8E6                
D8E6 AF             	XOR	A
D8E7 FD 77 0C       	LD	(IY+12),A	;(FCB)カレントブロック
D8EA FD 22 92 D9    	LD	(OFCB+1),IY
D8EE                FEND0F:
D8EE 18 45          	JR	FEND10
D8F0                
D8F0                _SYS10:		;(BDOS)ファイルのクローズ
D8F0 CD E4 E1       	CALL	SETDRV
D8F3 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D8F6 D6 FE          	SUB	0FEH
D8F8 37             	SCF
D8F9 3F             	CCF
D8FA 20 39          	JR	NZ,FEND10
D8FC                _S10A:				;Write
D8FC FD 77 0E       	LD	(IY+14),A	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D8FF FD 77 0F       	LD	(IY+15),A
D902                
D902 FD 34 1C       	INC	(IY+28)		;0FEH->0FFH ;オープンモード
D905 CD 20 E6       	CALL	SETTMS
D908                
D908 FD 7E 1D       	LD	A,(IY+29)	;(FCB)ディレクトリモード
D90B 32 A0 EF       	LD	(_DIRF),A
D90E E6 7F          	AND	07FH
D910 32 8F EA       	LD	(_SECPS+1),A
D913 FD 5E 1E       	LD	E,(IY+30)	;(FCB)ディレクトリポジション
D916 FD 56 1F       	LD	D,(IY+31)
D919 CD 38 E3       	CALL	READ_DIR
D91C 38 17          	JR	C,FEND10
D91E                
D91E 3A 62 E2       SDECM1:	LD	A,(SDECPAT+1)	;1セクタ辺りのディレクトリエントリ数
D921 3D              	DEC	A		;1024=01FH / 512=00FH / 256=7
D922 FD A6 19       	AND	(IY+25)		;(FCB)ディレクトリロケーション
D925 6F             	LD	L,A
D926 26 00          	LD	H,0
D928 29             	ADD	HL,HL		;*2
D929 29             	ADD	HL,HL		;*4
D92A 29             	ADD	HL,HL		;*8
D92B 29             	ADD	HL,HL		;*16
D92C 29             	ADD	HL,HL		;*32
D92D ED 4B 7E F0    	LD	BC,(_DTBUF)
D931 09             	ADD	HL,BC
D932                
D932 CD 42 E5       	CALL	SDIRENT
D935                FEND10:
D935 18 42          	JR	FEND
D937                
D937                _SYS11:		;(BDOS)最初のファイルの検索
D937 CD E4 E1       	CALL	SETDRV
D93A CD 31 E2       	CALL	SOPEN
D93D                _S12X1:
D93D 38 3A          	JR	C,FEND
D93F CD D1 E2       	CALL	SOPENE2
D942 ED 5B 8A EF    	LD	DE,(_DTA)
D946 3A 88 EF       	LD	A,(_DRV)
D949 3C             	INC	A
D94A 12             	LD	(DE),A
D94B D5             	PUSH	DE
D94C 13             	INC	DE
D94D 01 20 00       	LD	BC,32
D950 ED B0          	LDIR
D952 FD 6E 0E       	LD	L,(IY+14)	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D955 FD 66 0F       	LD	H,(IY+15)
D958 22 F4 F0       	LD	(SCDIR),HL
D95B 2A 9A EF       	LD	HL,(_FBPS)
D95E 22 F6 F0       	LD	(SFBPS),HL
D961 2A 9F EF       	LD	HL,(_FILEN)
D964 7C             	LD	A,H
D965 B7             	OR	A
D966 28 06          	JR	Z,_S12DIR
D968 3A 8F EA       	LD	A,(_SECPS+1)
D96B F6 80          	OR	080H
D96D 67             	LD	H,A
D96E                _S12DIR
D96E 22 F8 F0       	LD	(SFNDF),HL	;Directory position and Flags
D971 E1             	POP	HL
D972 11 39 EF       	LD	DE,SFILE
D975 0E 21          	LD	C,33
D977                _S11B:
D977 ED B0          	LDIR
D979                FEND:
D979 9F             	SBC	A,A		;CF=0 A=0 : CF=1 A=0FFH
D97A                FENDE:
D97A FD E1          	POP	IY
D97C C1             	POP	BC
D97D D1             	POP	DE
D97E E1             	POP	HL
D97F C9             	RET
D980                
D980                _SYS12:		;(BDOS)次のファイルの検索
D980 E5             	PUSH	HL
D981 D5             	PUSH	DE
D982 C5             	PUSH	BC
D983 FD E5          	PUSH	IY
D985 CD 95 E2       	CALL	NOPEN
D988 18 B3          	JR	_S12X1
D98A                
D98A                _S16K:
D98A FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D98D FE FD          	CP	0FDH		;Device(0FDH)
D98F 37             	SCF
D990 C8             	RET	Z
D991                
D991 11 00 00       OFCB:	LD	DE,0
D994 D5             	PUSH	DE
D995 06 1A          	LD	B,26		;First cluster
D997                S16K1:
D997 13             	INC	DE
D998 23             	INC	HL
D999 10 FC          	DJNZ	S16K1
D99B                
D99B 1A             	LD	A,(DE)
D99C BE             	CP	(HL)
D99D 20 13          	JR	NZ,S16K2
D99F 13             	INC	DE
D9A0 23             	INC	HL
D9A1 1A             	LD	A,(DE)
D9A2 BE             	CP	(HL)
D9A3 20 0D          	JR	NZ,S16K2
D9A5                
D9A5 E1             	POP	HL
D9A6 FD E5          	PUSH	IY
D9A8 D1             	POP	DE
D9A9 1A             	LD	A,(DE)		;Drive
D9AA BE             	CP	(HL)
D9AB 20 06          	JR	NZ,S16K3
D9AD                				;ここはCFが必ず0
D9AD ED 52          	SBC	HL,DE		;CP HL,DE
D9AF 37             	SCF
D9B0 C0             	RET	NZ
D9B1 E5             	PUSH	HL
D9B2                S16K2:
D9B2 E1             	POP	HL
D9B3                S16K3:
D9B3 FD E5          	PUSH	IY
D9B5 D1             	POP	DE
D9B6                _SYS13:		;(BDOS)ファイルの削除
D9B6 CD E4 E1       	CALL	SETDRV
D9B9 CD 62 E4       	CALL	KILL
D9BC                FEND13:
D9BC 18 BB          	JR	FEND
D9BE                
D9BE                _SYS14:		;(BDOS)シーケンシャルな読み出し
D9BE CD E4 E1       	CALL	SETDRV
D9C1 CD 52 E6       	CALL	PUSHRR
D9C4 CD 93 E6       	CALL	GETSEQ
D9C7                
D9C7 CD A7 E6       	CALL	RB_READ
D9CA E5             	PUSH	HL
D9CB CD 66 E6       	CALL	SETSEQ
D9CE                SREAD:
D9CE E1             	POP	HL
D9CF                
D9CF C6 01          	ADD	A,001H
D9D1 38 A6          	JR	C,FEND
D9D3                
D9D3 7D             	LD	A,L
D9D4 D6 01          	SUB	001H
D9D6                FENDX:
D9D6 9F             	SBC	A,A
D9D7 E6 03          	AND	3
D9D9 1F             	RRA
D9DA 18 9E          	JR	FENDE
D9DC                
D9DC                _SYS15:		;(BDOS)シーケンシャルな書き込み
D9DC CD E4 E1       	CALL	SETDRV
D9DF CD 52 E6       	CALL	PUSHRR
D9E2 CD 93 E6       	CALL	GETSEQ
D9E5                
D9E5 CD A0 E6       	CALL	RB_WRITE
D9E8 E5             	PUSH	HL
D9E9 CD 66 E6       	CALL	SETSEQ
D9EC                SWRITE:
D9EC E1             	POP	HL
D9ED                
D9ED C6 FF          	ADD	A,0FFH
D9EF 18 E5          	JR	FENDX
D9F1                
D9F1                _SYS17:		;(BDOS)ファイル名の変更
D9F1 CD E4 E1       	CALL	SETDRV
D9F4 CD B8 E4       	CALL	NAME
D9F7 18 C3          	JR	FEND13
D9F9                
D9F9                _SYS16:		;(BDOS)ファイルの作成
D9F9 CD E4 E1       	CALL	SETDRV
D9FC                
D9FC CD 32 E5       	CALL	CHKWILDX
D9FF 38 BB          	JR	C,FEND13
DA01 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
DA04 FE 05          	CP	5
DA06 28 05          	JR	Z,_S16X2
DA08 FE 21          	CP	021H
DA0A DA BC D9       	JP	C,FEND13
DA0D                _S16X2:
DA0D                ;				Clear FCB
DA0D FD E5          	PUSH	IY
DA0F E1             	POP	HL
DA10 01 10 00       	LD	BC,16
DA13 09             	ADD	HL,BC
DA14                _S16X1:
DA14 70             	LD	(HL),B		;B=0
DA15 23             	INC	HL
DA16 0D             	DEC	C
DA17 20 FB          	JR	NZ,_S16X1
DA19                
DA19 CD 25 E6       	CALL	SETTMSX
DA1C FD 36 0D FF    	LD	(IY+13),0FFH	;(FCB)Attribute
DA20 CD 04 E2       	CALL	SOPENX
DA23 3F             	CCF
DA24 CC 8A D9       	CALL	Z,_S16K
DA27 D4 E2 E2       	CALL	NC,COPEN
DA2A D4 42 E5       	CALL	NC,SDIRENT
DA2D C3 AC D8       	JP	_S16XX
DA30                
DA30                _SYS21:		;(BDOS)ランダムな読み出し
DA30                
DA30 CD E4 E1       	CALL	SETDRV
DA33 CD 52 E6       	CALL	PUSHRR
DA36 FD 6E 21       	LD	L,(IY+33)	;(FCB)Random record
DA39 FD 66 22       	LD	H,(IY+34)
DA3C                
DA3C CD A7 E6       	CALL	RB_READ
DA3F E5             	PUSH	HL
DA40 CD 7D E6       	CALL	POPRR
DA43 18 89          	JR	SREAD
DA45                
DA45                _SYS22:		;(BDOS)ランダムな書き込み
DA45                _SYS28:		;(BDOS)ランダムな書き込み・その2
DA45 CD E4 E1       	CALL	SETDRV
DA48 CD 52 E6       	CALL	PUSHRR
DA4B FD 6E 21       	LD	L,(IY+33)	;(FCB)Random record
DA4E FD 66 22       	LD	H,(IY+34)
DA51                
DA51 CD A0 E6       	CALL	RB_WRITE
DA54 E5             	PUSH	HL
DA55 CD 7D E6       	CALL	POPRR
DA58 18 92          	JR	SWRITE
DA5A                
DA5A                _SYS18:		;(BDOS)ログインベクトルの獲得
DA5A 21 FF 00       	LD	HL,000FFH
DA5D AF             	XOR	A
DA5E C9             	RET
DA5F                
DA5F                _SYS19:		;(BDOS)カレントドライブ番号の獲得
DA5F 3A 87 EF       	LD	A,(_DVSW)
DA62 A7             	AND	A
DA63 C9             	RET
DA64                
DA64                _SYS1A:		;(BDOS)DTAの設定
DA64 ED 53 8A EF    	LD	(_DTA),DE
DA68 AF             	XOR	A
DA69 C9             	RET
DA6A                
DA6A                _SYS1B:		;(BDOS)ディスク情報の獲得
DA6A 7B             	LD	A,E
DA6B CD F7 E1       	CALL	GETDRV
DA6E CD DC EF       	CALL	_GETDPB
DA71 D4 E2 EF       	CALL	NC,_RDFATX
DA74 21 00 00       	LD	HL,0
DA77 D4 FE E5       	CALL	NC,DSKF
DA7A                
DA7A ED 5B FF E5    	LD	DE,(MAXCLP+1)	;DPB_08_MAXCL-1
DA7E 1B             	DEC	DE		;DE←クラスタの総数
DA7F FD 2A 7C F0    	LD	IY,(_FATBF)	;IY←メモリ上のFATの先頭アドレス
DA83 9F             	SBC	A,A
DA84 D8             	RET	C
DA85 4F             	LD	C,A		;C=0
DA86 DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS
DA89 E6 0F          	AND	00FH
DA8B 47             	LD	B,A
DA8C DD 7E 07       	LD	A,(IX+7)	;DPB_07_SECPCL
DA8F C9             	RET
DA90                
DA90                _SYS1D:		;(BDOS)書き込みが禁止されているディスクの調査
DA90 AF             	XOR	A
DA91 67             	LD	H,A
DA92 6F             	LD	L,A
DA93 C9             	RET
DA94                
DA94                _SYS1F:		;(BDOS)ディスク装置のパラメータの読み出し
DA94 21 00 F1       	LD	HL,DEVICE
DA97 7B             	LD	A,E
DA98 C3 DC EF       	JP	_GETDPB
DA9B                
DA9B                _SYS23:		;(BDOS)ファイルサイズの獲得
DA9B E5             	PUSH	HL
DA9C 2A 1E F0       	LD	HL,(STABLE+2*00FH)	;ファイルのオープン
DA9F CD 0F 00       	CALL	JP_HL
DAA2 38 14          	JR	C,_S23X1
DAA4                
DAA4 D5             	PUSH	DE		;EX DE,IY
DAA5 FD E3          	EX	(SP),IY		;
DAA7                ;	POP	DE		;
DAA7                ;	PUSH	DE		;DEを破壊しないように注意vv
DAA7 CD 83 E6       	CALL	GETSIZE
DAAA                _S24X1:
DAAA FD 75 21       	LD	(IY+33),L	;(FCB)Random record
DAAD FD 74 22       	LD	(IY+34),H
DAB0 FD 36 23 00    	LD	(IY+35),0
DAB4                ;	POP	DE		;^^^^^^^^^^^^^^^^^^^^^^^^
DAB4                ;	PUSH	DE		;EX DE,IY
DAB4 FD E3          	EX	(SP),IY		;
DAB6 D1             	POP	DE		;
DAB7                
DAB7 AF             	XOR	A
DAB8                _S23X1:
DAB8 E1             	POP	HL
DAB9 C9             	RET
DABA                
DABA                _SYS24:		;(BDOS)ランダムレコードフィールドの設定
DABA E5             	PUSH	HL
DABB D5             	PUSH	DE		;EX DE,IY
DABC FD E3          	EX	(SP),IY		;
DABE                ;	POP	DE		;
DABE                ;	PUSH	DE		;DEを破壊しないように注意vv
DABE CD 93 E6       	CALL	GETSEQ
DAC1 18 E7          	JR	_S24X1		;^^^^^^^^^^^^^^^^^^^^^^^^
DAC3                
DAC3                _SYS5C:		;(BDOS)ファイル名の解析
DAC3 C5             	PUSH	BC
DAC4 E5             	PUSH	HL
DAC5 CD FB E0       	CALL	FILE
DAC8 E1             	POP	HL
DAC9 C1             	POP	BC
DACA                S29X1:
DACA C5             	PUSH	BC
DACB D5             	PUSH	DE
DACC E5             	PUSH	HL
DACD EB             	EX	DE,HL
DACE 21 14 EF       	LD	HL,FDRV
DAD1 01 0D 00       	LD	BC,13
DAD4 ED B0          	LDIR
DAD6 70             	LD	(HL),B		;B=0
DAD7 0E 03          	LD	C,3
DAD9 ED B0          	LDIR
DADB E1             	POP	HL
DADC D1             	POP	DE
DADD C1             	POP	BC
DADE AF             	XOR	A
DADF C9             	RET
DAE0                
DAE0                _SYS30:		;(BDOS)論理セクタを用いた書き込み
DAE0 C5             	PUSH	BC
DAE1 01 FD EB       	LD	BC,DWT24B
DAE4 18 04          	JR	S2FX
DAE6                _SYS2F:
DAE6 C5             	PUSH	BC
DAE7 01 ED EB       	LD	BC,DRD24B
DAEA                S2FX:
DAEA ED 43 00 DB    	LD	(S2FPAT+1),BC
DAEE CD DF EF       	CALL	_FFLUSH
DAF1                
DAF1 D5             	PUSH	DE
DAF2 E5             	PUSH	HL
DAF3 7D             	LD	A,L		;Drive
DAF4 CD D9 EF       	CALL	_CHGDRV
DAF7 38 09          	JR	C,S30X2
DAF9 44             	LD	B,H		;Number of clusters
DAFA 2A 8A EF       	LD	HL,(_DTA)
DAFD                
DAFD 0E 00          	LD	C,0
DAFF CD ED EB       S2FPAT:	CALL	DRD24B
DB02                S30X2:
DB02 E1             	POP	HL
DB03 D1             	POP	DE
DB04 C1             	POP	BC
DB05 9F             	SBC	A,A
DB06 C9             	RET
DB07                
DB07                _SYS5A:		;(BDOS)カレントディレクトリの変更
DB07 C5             	PUSH	BC
DB08 D5             	PUSH	DE
DB09 E5             	PUSH	HL
DB0A CD F0 E0       	CALL	FILEC
DB0D 21 00 00       	LD	HL,0
DB10 11 14 EF       	LD	DE,FDRV
DB13 2A 4E F0       	LD	HL,(STABLE+2*027H)	;ランダムブロック読み込み
DB16 CD 0F 00       	CALL	JP_HL
DB19 18 E7          	JR	S30X2
DB1B                	INCLUDE	"LDIO.ASM"
DB1B                
DB1B                ;	LSX-Dodgers IO
DB1B                
DB1B 00 00 D8 5E    _SYS04	EQU	_ERROR		;(BDOS)外部出力
DB1B 00 00 D8 5E    _SYS05	EQU	_ERROR		;(BDOS)プリンタ出力
DB1B 00 00 D8 5E    _SYS1C	EQU	_ERROR		;(BDOS)ディスクの書き込み禁止化
DB1B 00 00 D8 5E    _SYS1E	EQU	_ERROR		;(BDOS)ファイル属性の設定
DB1B 00 00 D8 5E    _SYS20	EQU	_ERROR		;(BDOS)利用者番号の設定と読み出し
DB1B 00 00 D8 5E    _SYS2E	EQU	_ERROR		;(BDOS)ベリファイ・フラグの設定
DB1B                
DB1B                BIOS:
DB1B E5             	PUSH	HL
DB1C 21 10 80       	LD	HL,08010H
DB1F 39             	ADD	HL,SP
DB20 E1             	POP	HL
DB21 30 0E          	JR	NC,BIOS2
DB23                BIOS1:
DB23 CD 2B DB       	CALL	BIOS3
DB26 06 1E          	LD	B,01EH
DB28 ED 79          	OUT	(C),A
DB2A C9             	RET
DB2B                BIOS3:
DB2B C5             	PUSH	BC
DB2C 06 1D          	LD	B,01DH
DB2E ED 79          	OUT	(C),A
DB30 C9             	RET
DB31                BIOS2:
DB31 ED 73 3C DB    	LD	(SPPAT+1),SP	;スタックがBIOS-ROMと被っている場合
DB35 31 CA FF       	LD	SP,EXTSP
DB38 CD 23 DB       	CALL	BIOS1
DB3B 31 00 00       SPPAT:	LD	SP,0
DB3E C9             	RET
DB3F                
DB3F                INT:
DB3F F5             	PUSH	AF
DB40 E5             	PUSH	HL
DB41 ED 73 52 DB    	LD	(INTSP+1),SP
DB45 21 00 01       	LD	HL,00100H
DB48 39             	ADD	HL,SP
DB49 38 03          	JR	C,INTP1X
DB4B 31 CA FF       	LD	SP,EXTSP
DB4E                INTP1X:
DB4E CD 59 DB       	CALL	INTP1
DB51 31 00 00       INTSP:	LD	SP,0
DB54                INTPE:
DB54 E1             	POP	HL
DB55                INTPE2:
DB55 F1             	POP	AF
DB56                INTCTCE:
DB56 FB             	EI
DB57 ED 4D          	RETI
DB59                INTP1:
DB59 C5             	PUSH	BC
DB5A                
DB5A CD 24 DF       	CALL	IN49SB
DB5D 67             	LD	H,A
DB5E CD 24 DF       	CALL	IN49SB
DB61 6F             	LD	L,A
DB62                
DB62 FE 08          	CP	8		;DELキー
DB64 20 05          	JR	NZ,SCEXE
DB66 7C             	LD	A,H
DB67 E6 11          	AND	011H		;CTRLキー + GRAPHキー
DB69 28 08          	JR	Z,RESET
DB6B                SCEXE:
DB6B 22 92 EF       	LD	(_KEYD),HL
DB6E CD 9F DB       	CALL	KEYSET1
DB71                
DB71 C1             	POP	BC
DB72 C9             	RET
DB73                
DB73                RESET:
DB73 3E 1D          	LD	A,01DH
DB75 D3 00          	OUT	(0),A
DB77 C7             	RST	0
DB78                
DB78                INTCTC2:
DB78 F5             	PUSH	AF
DB79 3E 00          INTCPAT:LD	A,000H
DB7B 3D             	DEC	A
DB7C 32 7A DB       	LD	(INTCPAT+1),A
DB7F 20 D4          	JR	NZ,INTPE2
DB81                
DB81 3A 92 EF       	LD	A,(_KEYD)
DB84 B7             	OR	A
DB85 28 CE          	JR	Z,INTPE2
DB87                KEYSET0:
DB87 E5             	PUSH	HL
DB88 2A 90 EF       	LD	HL,(_KEYPS)
DB8B 7C             	LD	A,H
DB8C AD             	XOR	L
DB8D 20 06          	JR	NZ,INTC2A
DB8F                
DB8F 2A 92 EF       	LD	HL,(_KEYD)
DB92 CD C9 DB       	CALL	KEYSET
DB95                INTC2A:
DB95 3A 94 EF       	LD	A,(_KEYSP)
DB98 E6 0F          	AND	00FH
DB9A 32 7A DB       	LD	(INTCPAT+1),A
DB9D                
DB9D 18 B5          	JR	INTPE
DB9F                
DB9F                KEYSET1:
DB9F CB 6C          	BIT	5,H
DBA1 F5             	PUSH	AF
DBA2 ED 4B 8C EF    	LD	BC,(_CTC)
DBA6 78             	LD	A,B
DBA7 B1             	OR	C
DBA8 20 06          	JR	NZ,KEYS10E
DBAA                
DBAA F1             	POP	AF
DBAB 20 1C          	JR	NZ,KEYSET
DBAD F5             	PUSH	AF
DBAE 18 D7          	JR	KEYSET0
DBB0                KEYS10E:
DBB0 F1             	POP	AF
DBB1 C8             	RET	Z
DBB2 F5             	PUSH	AF
DBB3 3E 03          	LD	A,3		;CTC STOP
DBB5 ED 79          	OUT	(C),A
DBB7 F1             	POP	AF
DBB8                
DBB8 B7             	OR	A
DBB9 C8             	RET	Z
DBBA                
DBBA E5             	PUSH	HL
DBBB 2A 94 EF       	LD	HL,(_KEYSP)
DBBE 3E A7          	LD	A,0A7H
DBC0 ED 79          	OUT	(C),A
DBC2 ED 69          	OUT	(C),L
DBC4 7C             	LD	A,H
DBC5 32 7A DB       	LD	(INTCPAT+1),A
DBC8 E1             	POP	HL
DBC9                
DBC9                KEYSET:
DBC9 7D             	LD	A,L
DBCA CB 7C          	BIT	7,H
DBCC CC FA DB       	CALL	Z,FKEY
DBCF CB 74          	BIT	6,H
DBD1 C0             	RET	NZ
DBD2                KEYBS:
DBD2 B7             	OR	A
DBD3 C8             	RET	Z
DBD4                KEYBS1:
DBD4 CD EA DB       	CALL	KEYBC_IFBREAK
DBD7 E5             	PUSH	HL
DBD8 F5             	PUSH	AF
DBD9 2A 90 EF       	LD	HL,(_KEYPS)
DBDC 2C             	INC	L
DBDD 7D             	LD	A,L
DBDE BC             	CP	H
DBDF 28 15          	JR	Z,POP_AF_HL_SCF_RET
DBE1 32 90 EF       	LD	(_KEYPS),A
DBE4 26 FE          	LD	H,KEYBF/256
DBE6 F1             	POP	AF
DBE7 77             	LD	(HL),A
DBE8 E1             	POP	HL
DBE9 C9             	RET
DBEA                KEYBC_IFBREAK:
DBEA FE 03          	CP	3
DBEC C0             	RET	NZ
DBED                KEYBC:
DBED E5             	PUSH	HL
DBEE 21 00 00       	LD	HL,0
DBF1 22 90 EF       	LD	(_KEYPS),HL
DBF4 E1             	POP	HL
DBF5 C9             	RET
DBF6                
DBF6                POP_AF_HL_SCF_RET:
DBF6 F1             	POP	AF
DBF7 E1             	POP	HL
DBF8 37             	SCF
DBF9 C9             	RET
DBFA                
DBFA                FKEY:
DBFA CB 75          	BIT	6,L
DBFC C8             	RET	Z
DBFD 3E 1B          	LD	A,01BH
DBFF CD D4 DB       	CALL	KEYBS1
DC02 7D             	LD	A,L
DC03 C6 AF          	ADD	A,020H-'q'
DC05 CB 7D          	BIT	7,L
DC07 C8             	RET	Z
DC08 2E 50          	LD	L,'P'
DC0A D6 90          	SUB	0E1H+020H-'q'
DC0C 28 10          	JR	Z,KEYBSL
DC0E 2C             	INC	L
DC0F 3D             	DEC	A
DC10 28 0C          	JR	Z,KEYBSL
DC12 2C             	INC	L
DC13 D6 09          	SUB	0EBH-0E2H
DC15 28 07          	JR	Z,KEYBSL
DC17 2E 43          	LD	L,'C'
DC19 3D             	DEC	A
DC1A 28 02          	JR	Z,KEYBSL
DC1C 2E 58          	LD	L,'X'
DC1E                KEYBSL:
DC1E 7D             	LD	A,L
DC1F 18 B3          	JR	KEYBS1
DC21                
DC21                _SYS01:		;(BDOS)コンソール入力
DC21 CD 09 EF       	CALL	_SYS07
DC24                MSG_A:
DC24 F5             	PUSH	AF
DC25 D5             	PUSH	DE
DC26 5F             	LD	E,A
DC27 CD 2D DC       	CALL	_SYS02
DC2A D1             	POP	DE
DC2B F1             	POP	AF
DC2C C9             	RET
DC2D                
DC2D                _SYS02:		;(BDOS)コンソール出力
DC2D CD 3F DC       	CALL	BREAK
DC30 18 05          	JR	PRINTX
DC32                
DC32                _SYS06:		;(BDOS)コンソール直接入出力
DC32 7B             	LD	A,E
DC33 3C             	INC	A
DC34 CA CA EF       	JP	Z,_INKEY
DC37                PRINTX:
DC37 C3 CD EF       	JP	_PRINT
DC3A                
DC3A                _SYS08:		;(BDOS)エコーなしコンソール入力
DC3A CD 09 EF       	CALL	_SYS07
DC3D 18 04          	JR	BREAK1
DC3F                BREAK:
DC3F FB             	EI
DC40 3A 92 EF       	LD	A,(_KEYD)
DC43                BREAK1:
DC43 FE 03          	CP	3		;CTRL+C
DC45 CA 00 EF       	JP	Z,CPM_BOOT
DC48 FE 13          	CP	013H		;CTRL+S
DC4A C0             	RET	NZ
DC4B                
DC4B                PAUSE:
DC4B CD ED DB       	CALL	KEYBC
DC4E                
DC4E                FLGET:
DC4E CD DF EF       	CALL	_FFLUSH
DC51 C5             	PUSH	BC
DC52 E5             	PUSH	HL
DC53 ED 4B 8E EF    	LD	BC,(_TXADR)
DC57 CB E8          	SET	5,B
DC59 ED 60          	IN	H,(C)
DC5B                FLGET1:
DC5B 3A 93 EF       	LD	A,(_KEYD+1)
DC5E 0F             	RRCA
DC5F 0F             	RRCA
DC60 E6 10          	AND	010H
DC62 F6 08          	OR	8
DC64 ED 68          	IN	L,(C)
DC66 B5             	OR	L
DC67 ED 79          	OUT	(C),A
DC69 CD CA EF       	CALL	_INKEY
DC6C 28 ED          	JR	Z,FLGET1
DC6E ED 61          	OUT	(C),H
DC70 E1             	POP	HL
DC71 C1             	POP	BC
DC72 C9             	RET
DC73                
DC73                _SYS0A:		;(BDOS)文字列入力
DC73 C5             	PUSH	BC
DC74 E5             	PUSH	HL
DC75 D5             	PUSH	DE
DC76 CD 81 E0       	CALL	GETL
DC79 11 00 FF       	LD	DE,KBUF
DC7C E1             	POP	HL
DC7D E5             	PUSH	HL
DC7E 0E 00          	LD	C,0
DC80 30 04          	JR	NC,SAX0
DC82 23             	INC	HL
DC83 23             	INC	HL
DC84 18 08          	JR	SAX4
DC86                SAX0:
DC86 46             	LD	B,(HL)
DC87 23             	INC	HL
DC88                SAX1:
DC88 23             	INC	HL
DC89 1A             	LD	A,(DE)
DC8A 13             	INC	DE
DC8B B7             	OR	A
DC8C 20 04          	JR	NZ,SAX2
DC8E                SAX4:
DC8E 36 0D          	LD	(HL),00DH
DC90 18 04          	JR	SAX3
DC92                SAX2:
DC92 77             	LD	(HL),A
DC93 0C             	INC	C
DC94 10 F2          	DJNZ	SAX1
DC96                SAX3:
DC96 D1             	POP	DE
DC97 79             	LD	A,C
DC98 13             	INC	DE
DC99 12             	LD	(DE),A
DC9A 1B             	DEC	DE
DC9B E1             	POP	HL
DC9C C1             	POP	BC
DC9D A7             	AND	A
DC9E C9             	RET
DC9F                
DC9F                _SYS0B:		;(BDOS)コンソール状態のチェック
DC9F CD 3F DC       	CALL	BREAK
DCA2 3A 92 EF       	LD	A,(_KEYD)
DCA5 B7             	OR	A
DCA6 C8             	RET	Z
DCA7                CONSTX:
DCA7 CD DF EF       	CALL	_FFLUSH
DCAA E5             	PUSH	HL
DCAB 2A 90 EF       	LD	HL,(_KEYPS)
DCAE 7C             	LD	A,H
DCAF AD             	XOR	L
DCB0 E1             	POP	HL
DCB1 C6 FF          	ADD	A,0FFH
DCB3 9F             	SBC	A,A
DCB4 C9             	RET
DCB5                
DCB5                _SYS2A:		;(BDOS)日付の獲得
DCB5 C5             	PUSH	BC
DCB6 3E ED          	LD	A,0EDH		;Read calendar
DCB8 CD 3F DF       	CALL	COMOUT
DCBB CD D8 DC       	CALL	IN49SB_BCD	;YY
DCBE 6F             	LD	L,A
DCBF 26 00          	LD	H,0
DCC1                ;	LD	DE,1900		;0076CH
DCC1                ;	CP	90		;90以上は1900年代 1990-1999
DCC1                ;	JR	NC,RDDATE1	;90未満は2000年代 2000-2089
DCC1                ;	LD	E,0D0H		;2000 & 0FFH D=007H
DCC1 11 D0 07       	LD	DE,2000		;すべて2000年代で処理 2000-2099
DCC4                RDDATE1:
DCC4 19             	ADD	HL,DE
DCC5 CD 24 DF       	CALL	IN49SB		;MM
DCC8 57             	LD	D,A
DCC9 CD D8 DC       	CALL	IN49SB_BCD	;DD
DCCC 5F             	LD	E,A
DCCD 7A             	LD	A,D
DCCE E6 07          	AND	7
DCD0 06 04          	LD	B,4
DCD2                RDDATE2:
DCD2 CB 3A          	SRL	D
DCD4 10 FC          	DJNZ	RDDATE2
DCD6 C1             	POP	BC
DCD7 C9             	RET
DCD8                IN49SB_BCD:
DCD8 CD 24 DF       	CALL	IN49SB
DCDB                ;------------------------
DCDB                ;BCDの10進数化
DCDB                ;in
DCDB                ;	A  : BCD
DCDB                ;out
DCDB                ;	A  : 10進数
DCDB                ;------------------------
DCDB 4F             	LD	C,A
DCDC E6 F0          	AND	0F0H	;10の位
DCDE 0F             	RRCA
DCDF 47             	LD	B,A
DCE0 0F             	RRCA
DCE1 0F             	RRCA
DCE2 80             	ADD	A,B
DCE3 47             	LD	B,A
DCE4 79             	LD	A,C
DCE5 E6 0F          	AND	00FH	;1の位
DCE7 80             	ADD	A,B
DCE8 C9             	RET
DCE9                
DCE9                _SYS2C:		;(BDOS)時刻の獲得
DCE9 C5             	PUSH	BC
DCEA 3E EF          	LD	A,0EFH		;Read time
DCEC CD 3F DF       	CALL	COMOUT
DCEF CD D8 DC       	CALL	IN49SB_BCD	;TT
DCF2 67             	LD	H,A
DCF3 CD D8 DC       	CALL	IN49SB_BCD	;MM
DCF6 6F             	LD	L,A
DCF7 CD D8 DC       	CALL	IN49SB_BCD	;SS
DCFA 57             	LD	D,A
DCFB C1             	POP	BC
DCFC AF             	XOR	A
DCFD C9             	RET
DCFE                
DCFE                ESC1:
DCFE 7B             	LD	A,E
DCFF FE 41          	CP	'A'
DD01 CA 42 DE       	JP	Z,CTRL1E
DD04 FE 42          	CP	'B'
DD06 CA AA DF       	JP	Z,CTRL1F
DD09 FE 43          	CP	'C'
DD0B CA 4D DE       	JP	Z,CTRL1C
DD0E FE 44          	CP	'D'
DD10 CA 39 DE       	JP	Z,CTRL1D
DD13 FE 45          	CP	'E'
DD15 28 02          	JR	Z,CT0CX
DD17 FE 6A          	CP	'j'
DD19                CT0CX:
DD19 CA 7D DF       	JP	Z,CTRL0C
DD1C FE 48          	CP	'H'
DD1E CA C5 DE       	JP	Z,CTRL0B
DD21 FE 4A          	CP	'J'
DD23 CA 80 DF       	JP	Z,CTRL06
DD26 FE 4B          	CP	'K'
DD28 CA 86 DE       	JP	Z,CTRL05
DD2B FE 4C          	CP	'L'
DD2D CA BF DF       	JP	Z,CTRL0E
DD30 FE 54          	CP	'T'
DD32 CA 86 DE       	JP	Z,CTRL05
DD35 FE 78          	CP	'x'
DD37 28 04          	JR	Z,ESC1X
DD39 FE 79          	CP	'y'
DD3B 20 02          	JR	NZ,ESC1Y
DD3D                ESC1X:
DD3D 36 01          	LD	(HL),1
DD3F                ESC1Y:
DD3F FE 3D          	CP	'='
DD41 28 04          	JR	Z,ESC1W
DD43 FE 59          	CP	'Y'
DD45 20 02          	JR	NZ,ESC1Z
DD47                ESC1W:
DD47 36 02          	LD	(HL),2
DD49                ESC1Z:
DD49 FE 20          	CP	020H
DD4B 38 02          	JR	C,ESC1C
DD4D 87             	ADD	A,A
DD4E D0             	RET	NC
DD4F                ESC1C:
DD4F E1             	POP	HL
DD50 18 49          	JR	ANK
DD52                
DD52                ESC:
DD52 21 AC DD       	LD	HL,PRINTE5
DD55 E5             	PUSH	HL
DD56 21 78 DD       	LD	HL,ESCFLG+1
DD59 36 00          	LD	(HL),0
DD5B 3D             	DEC	A
DD5C 28 A0          	JR	Z,ESC1
DD5E 3D             	DEC	A
DD5F 20 09          	JR	NZ,ESC2
DD61 36 03          	LD	(HL),3
DD63 7B             	LD	A,E
DD64 D6 20          	SUB	020H
DD66 32 6D DD       	LD	(ESCYP+1),A
DD69 C9             	RET
DD6A                ESC2:
DD6A 3D             	DEC	A
DD6B C0             	RET	NZ
DD6C 26 00          ESCYP:	LD	H,0
DD6E 7B             	LD	A,E
DD6F D6 20          	SUB	020H
DD71 6F             	LD	L,A
DD72 C3 D6 EF       	JP	_LOC
DD75                
DD75                PRINT:
DD75 C5             	PUSH	BC
DD76 E5             	PUSH	HL
DD77 3E 00          ESCFLG:	LD	A,000H
DD79 B7             	OR	A
DD7A 20 D6          	JR	NZ,ESC
DD7C                
DD7C 3E 1F          	LD	A,01FH
DD7E BB             	CP	E
DD7F 30 2F          	JR	NC,CTRL
DD81 01 48 DF       INSFLG:	LD	BC,INSERT
DD84                
DD84 3E 00          KANFLG:	LD	A,000H
DD86 B7             	OR	A
DD87 20 3A          	JR	NZ,KANJI2
DD89 7B             X1KPAT:	LD	A,E
DD8A FE 80          	CP	080H
DD8C 38 0D          	JR	C,ANK
DD8E FE A0          	CP	0A0H
DD90 38 04          	JR	C,KANJI1
DD92 FE E0          	CP	0E0H
DD94 38 05          	JR	C,ANK
DD96                KANJI1:
DD96 32 85 DD       	LD	(KANFLG+1),A
DD99 18 11          	JR	PRINTE5
DD9B                ANK:
DD9B ED 4B 8E EF    	LD	BC,(_TXADR)
DD9F 78             	LD	A,B
DDA0 F6 38          	OR	038H
DDA2 47             	LD	B,A
DDA3 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DDA5 CB 98          	RES	3,B
DDA7 ED 59          	OUT	(C),E		;Text
DDA9                KANJIE:
DDA9 CD 0E DE       	CALL	PRINTE7
DDAC                PRINTE5:
DDAC E1             	POP	HL
DDAD C1             	POP	BC
DDAE AF             	XOR	A
DDAF C9             	RET
DDB0                
DDB0                CTRL:
DDB0 CD F5 DD       	CALL	KANCLR
DDB3 7B             	LD	A,E
DDB4 87             	ADD	A,A
DDB5 F6 80          	OR	080H
DDB7 6F             	LD	L,A
DDB8 26 F0          	LD	H,CTRLTB/256
DDBA 7E             	LD	A,(HL)
DDBB 2C             	INC	L
DDBC 66             	LD	H,(HL)
DDBD 6F             	LD	L,A
DDBE CD 0F 00       	CALL	JP_HL
DDC1 18 E9          	JR	PRINTE5
DDC3                
DDC3                KANJI2:
DDC3 D5             	PUSH	DE
DDC4 57             	LD	D,A
DDC5 01 81 2F       	LD	BC,02F81H	;SFTJIS
DDC8 DF             	RST	018H
DDC9 01 C3 2F       	LD	BC,02FC3H	;Instead or JISVRM
DDCC DF             	RST	018H
DDCD                
DDCD ED 4B 8E EF    	LD	BC,(_TXADR)
DDD1 78             	LD	A,B
DDD2 F6 38          	OR	038H
DDD4 47             	LD	B,A
DDD5 ED 51          	OUT	(C),D		;kanji
DDD7 CB 98          	RES	3,B
DDD9 ED 59          	OUT	(C),E		;Text
DDDB CD 0E DE       	CALL	PRINTE7
DDDE ED 4B 8E EF    	LD	BC,(_TXADR)
DDE2 78             	LD	A,B
DDE3 F6 38          	OR	038H
DDE5 47             	LD	B,A
DDE6 CB F2          	SET	6,D
DDE8 ED 51          	OUT	(C),D		;Kanji
DDEA CB 98          	RES	3,B
DDEC ED 59          	OUT	(C),E		;Text
DDEE D1             	POP	DE
DDEF AF             	XOR	A
DDF0 32 85 DD       	LD	(KANFLG+1),A
DDF3 18 B4          	JR	KANJIE
DDF5                
DDF5                KANCLR:
DDF5 3A 85 DD       	LD	A,(KANFLG+1)
DDF8 B7             	OR	A
DDF9 C8             	RET	Z
DDFA ED 4B 8E EF    	LD	BC,(_TXADR)
DDFE 78             	LD	A,B
DDFF F6 38          	OR	038H
DE01 47             	LD	B,A
DE02 AF             	XOR	A
DE03 32 85 DD       	LD	(KANFLG+1),A
DE06 ED 79          	OUT	(C),A		;Kanji
DE08 CB 98          	RES	3,B
DE0A 3E 20          	LD	A,020H
DE0C ED 79          	OUT	(C),A		;Text
DE0E                PRINTE7:
DE0E CB A0          	RES	4,B
DE10                PRINTE6:
DE10 3A 96 EF       	LD	A,(_COLORF)
DE13                PRINTE4:
DE13 ED 79          	OUT	(C),A		;Color
DE15 78             	LD	A,B
DE16 E6 07          	AND	7
DE18 47             	LD	B,A
DE19                PRINTE2:
DE19 03             	INC	BC
DE1A                PRINTE3:
DE1A 2A BA EF       	LD	HL,(CRTCD+10)
DE1D A7             	AND	A
DE1E ED 4A          	ADC	HL,BC
DE20                PRINTE8:
DE20 28 05          	JR	Z,PRINT2
DE22 ED 43 8E EF    	LD	(_TXADR),BC
DE26                CTRL00:
DE26 C9             	RET
DE27                
DE27                PRINT2:
DE27 CD C5 DF       	CALL	SCR
DE2A 2A BC EF       	LD	HL,(CRTCD+12)
DE2D 09             	ADD	HL,BC
DE2E                SET_TXADR_HL:
DE2E 22 8E EF       	LD	(_TXADR),HL
DE31 C9             	RET
DE32                
DE32                CTRL08:
DE32 3A 81 DD       	LD	A,(INSFLG)
DE35 FE CD          	CP	0CDH		;CALL ????
DE37 28 29          	JR	Z,CTRL02
DE39                CTRL1D:
DE39 2A 8E EF       	LD	HL,(_TXADR)
DE3C 7C             	LD	A,H
DE3D B5             	OR	L
DE3E C8             	RET	Z
DE3F 2B             	DEC	HL
DE40 18 EC          	JR	SET_TXADR_HL
DE42                
DE42                CTRL1E:
DE42 ED 4B 8E EF    	LD	BC,(_TXADR)
DE46 2A BC EF       	LD	HL,(CRTCD+12)
DE49 09             	ADD	HL,BC
DE4A D0             	RET	NC
DE4B 18 E1          	JR	SET_TXADR_HL
DE4D                
DE4D                CTRL1C:
DE4D ED 4B 8E EF    	LD	BC,(_TXADR)
DE51 18 C6          	JR	PRINTE2
DE53                
DE53                CTRL09:
DE53 ED 4B 8E EF    	LD	BC,(_TXADR)
DE57 79             	LD	A,C
DE58 E6 F8          	AND	0F8H
DE5A C6 08          	ADD	A,8
DE5C 4F             	LD	C,A
DE5D 88             	ADC	A,B
DE5E 91             	SUB	C
DE5F 47             	LD	B,A
DE60 18 B8          	JR	PRINTE3
DE62                
DE62                CTRL02:
DE62 CD 39 DE       	CALL	CTRL1D
DE65 C8             	RET	Z
DE66 D5             	PUSH	DE
DE67 CD D3 EF       	CALL	_POS
DE6A 3A B1 EF       	LD	A,(CRTCD+1)
DE6D 95             	SUB	L
DE6E 4F             	LD	C,A
DE6F 0D             	DEC	C
DE70 06 38          	LD	B,038H
DE72 2A 8E EF       	LD	HL,(_TXADR)
DE75 09             	ADD	HL,BC
DE76 44             	LD	B,H
DE77 4D             	LD	C,L
DE78 11 00 20       	LD	DE,02000H	;D:Text E:kanji
DE7B 2A 96 EF       	LD	HL,(_COLORF)	;L:Color
DE7E                C8X1:
DE7E CD 64 DF       	CALL	C12S
DE81 0B             	DEC	BC
DE82 20 FA          	JR	NZ,C8X1
DE84 D1             	POP	DE
DE85 C9             	RET
DE86                
DE86                CTRL05:
DE86 CD D3 EF       	CALL	_POS
DE89 3A B1 EF       	LD	A,(CRTCD+1)
DE8C 95             	SUB	L
DE8D 6F             	LD	L,A
DE8E                C08X1:
DE8E 26 20          	LD	H,020H
DE90 ED 4B 8E EF    	LD	BC,(_TXADR)
DE94                C05X1:
DE94 78             	LD	A,B
DE95 F6 38          	OR	038H
DE97 47             	LD	B,A
DE98 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DE9A CB 98          	RES	3,B
DE9C ED 61          	OUT	(C),H		;Text
DE9E CB A0          	RES	4,B
DEA0 3A 96 EF       	LD	A,(_COLORF)
DEA3 ED 79          	OUT	(C),A		;Color
DEA5 03             	INC	BC
DEA6 2D             	DEC	L
DEA7 20 EB          	JR	NZ,C05X1
DEA9 C9             	RET
DEAA                
DEAA                CTRL0D:
DEAA CD D3 EF       	CALL	_POS
DEAD 2E 00          	LD	L,0
DEAF                LOC:
DEAF C5             	PUSH	BC
DEB0 E5             	PUSH	HL
DEB1 CD F5 DD       	CALL	KANCLR
DEB4 CD D2 DE       	CALL	LOC1
DEB7 22 8E EF       	LD	(_TXADR),HL
DEBA E1             	POP	HL
DEBB C1             	POP	BC
DEBC C9             	RET
DEBD                
DEBD                CTRL12:
DEBD 21 81 DD       	LD	HL,INSFLG
DEC0 7E             	LD	A,(HL)
DEC1 EE CC          	XOR	0CCH		;CD:CALL ???? 1:LD BC,????
DEC3 77             	LD	(HL),A
DEC4 C9             	RET
DEC5                
DEC5                CTRL0B:
DEC5 21 00 00       	LD	HL,0
DEC8 22 8E EF       	LD	(_TXADR),HL
DECB C9             	RET
DECC                
DECC                CTRL1B:
DECC 3E 01          	LD	A,1
DECE 32 78 DD       	LD	(ESCFLG+1),A
DED1 C9             	RET
DED2                
DED2                LOC1:
DED2 D5             	PUSH	DE
DED3 4D             	LD	C,L
DED4 06 08          	LD	B,8
DED6 5C             	LD	E,H
DED7 16 00          	LD	D,0
DED9 2A B0 EF       	LD	HL,(CRTCD)
DEDC 6A             	LD	L,D
DEDD                LOC2:
DEDD 29             	ADD	HL,HL
DEDE 30 01          	JR	NC,LOC3
DEE0 19             	ADD	HL,DE
DEE1                LOC3:
DEE1 10 FA          	DJNZ	LOC2
DEE3 09             	ADD	HL,BC
DEE4 D1             	POP	DE
DEE5 C9             	RET
DEE6                
DEE6                CONOUT1:
DEE6 CD F8 DE       	CALL	CURSOR
DEE9 59             	LD	E,C
DEEA CD CD EF       	CALL	_PRINT
DEED 7B             	LD	A,E
DEEE FE 0A          	CP	00AH
DEF0 20 06          	JR	NZ,CURSOR
DEF2 CD AA DE       	CALL	CTRL0D
DEF5 CD 86 DE       	CALL	CTRL05
DEF8                CURSOR:
DEF8 C5             	PUSH	BC
DEF9 ED 4B 8E EF    	LD	BC,(_TXADR)
DEFD CB E8          	SET	5,B
DEFF ED 78          	IN	A,(C)
DF01 EE 18          	XOR	018H
DF03 ED 79          	OUT	(C),A
DF05 C1             	POP	BC
DF06 C9             	RET
DF07                
DF07                CTRL07:
DF07 21 61 EF       	LD	HL,BEEPD
DF0A                BEEP1:
DF0A 7E             	LD	A,(HL)
DF0B 23             	INC	HL
DF0C FE FF          	CP	0FFH
DF0E C8             	RET	Z
DF0F F3             	DI
DF10 06 1C          	LD	B,01CH
DF12 ED 79          	OUT	(C),A
DF14 ED A3          	OUTI
DF16 FB             	EI
DF17 18 F1          	JR	BEEP1
DF19                
DF19                OT49SB:
DF19 C5             	PUSH	BC
DF1A CD 35 DF       	CALL	CANW
DF1D 01 00 19       	LD	BC,01900H
DF20 ED 79          	OUT	(C),A
DF22 C1             	POP	BC
DF23 C9             	RET
DF24                
DF24                IN49SB:
DF24 C5             	PUSH	BC
DF25 01 01 1A       	LD	BC,01A01H
DF28                CANR:
DF28 ED 78          	IN	A,(C)
DF2A E6 20          	AND	020H
DF2C 20 FA          	JR	NZ,CANR
DF2E 01 00 19       	LD	BC,01900H
DF31 ED 78          	IN	A,(C)
DF33 C1             	POP	BC
DF34 C9             	RET
DF35                
DF35                CANW:
DF35 01 01 1A       	LD	BC,01A01H
DF38 ED 48          	IN	C,(C)
DF3A CB 71          	BIT	6,C
DF3C 20 F7          	JR	NZ,CANW
DF3E C9             	RET
DF3F                
DF3F                COMOUT:
DF3F FB             	EI
DF40 CD 19 DF       	CALL	OT49SB
DF43 CD 35 DF       	CALL	CANW
DF46 F3             	DI
DF47 C9             	RET
DF48                
DF48                INSERT:
DF48 D5             	PUSH	DE
DF49 CD D3 EF       	CALL	_POS
DF4C 3A B1 EF       	LD	A,(CRTCD+1)
DF4F 95             	SUB	L
DF50 ED 4B 8E EF    	LD	BC,(_TXADR)
DF54 11 00 20       	LD	DE,02000H	;D:Text E:Kanji
DF57 2A 96 EF       	LD	HL,(_COLORF)	;L:Color
DF5A CB E8          	SET	5,B
DF5C                C12X1:
DF5C CD 64 DF       	CALL	C12S
DF5F 03             	INC	BC
DF60 20 FA          	JR	NZ,C12X1
DF62 D1             	POP	DE
DF63 C9             	RET
DF64                
DF64                C12S:
DF64 CB E0          	SET	4,B
DF66 CB D8          	SET	3,B
DF68 ED 60          	IN	H,(C)
DF6A ED 59          X1PAT:	OUT	(C),E
DF6C 5C             	LD	E,H
DF6D CB 98          	RES	3,B
DF6F ED 60          	IN	H,(C)
DF71 ED 51          	OUT	(C),D
DF73 54             	LD	D,H
DF74 CB A0          	RES	4,B
DF76 ED 60          	IN	H,(C)
DF78 ED 69          	OUT	(C),L
DF7A 6C             	LD	L,H
DF7B 3D             	DEC	A
DF7C C9             	RET
DF7D                
DF7D                CTRL0C:
DF7D CD C5 DE       	CALL	CTRL0B
DF80                CTRL06:
DF80 ED 4B 8E EF    	LD	BC,(_TXADR)
DF84                C1AX1:
DF84 78             	LD	A,B
DF85 F6 38          	OR	038H
DF87 47             	LD	B,A
DF88 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DF8A CB 98          	RES	3,B
DF8C 3E 20          	LD	A,020H
DF8E ED 79          	OUT	(C),A		;Text
DF90 CB A0          	RES	4,B
DF92 3A 96 EF       	LD	A,(_COLORF)
DF95 ED 79          	OUT	(C),A		;Color
DF97 03             	INC	BC
DF98 CB A8          	RES	5,B
DF9A 2A BA EF       	LD	HL,(CRTCD+10)
DF9D 09             	ADD	HL,BC
DF9E 30 E4          	JR	NC,C1AX1
DFA0 C9             	RET
DFA1                
DFA1                CTRL04:
DFA1 CD D3 EF       	CALL	_POS
DFA4 7D             	LD	A,L
DFA5 B7             	OR	A
DFA6 C8             	RET	Z
DFA7                CTRL03:
DFA7 CD AA DE       	CALL	CTRL0D
DFAA                CTRL0A:
DFAA                CTRL1F:
DFAA ED 4B 8E EF    	LD	BC,(_TXADR)
DFAE 2A B1 EF       	LD	HL,(CRTCD+1)
DFB1 26 00          	LD	H,0
DFB3 09             	ADD	HL,BC
DFB4 44             	LD	B,H
DFB5 4D             	LD	C,L
DFB6 2A BA EF       	LD	HL,(CRTCD+10)
DFB9 09             	ADD	HL,BC
DFBA 3F             	CCF
DFBB 9F             	SBC	A,A
DFBC C3 20 DE       	JP	PRINTE8
DFBF                
DFBF                CTRL0E:
DFBF CD D3 EF       	CALL	_POS
DFC2 7C             	LD	A,H
DFC3 18 04          	JR	SCR1
DFC5                SCR:
DFC5 3A 97 EF       	LD	A,(_LINE)
DFC8 3D             	DEC	A
DFC9                SCR1:
DFC9 C5             	PUSH	BC
DFCA D5             	PUSH	DE
DFCB F5             	PUSH	AF
DFCC 3E 07          	LD	A,7
DFCE 21 FF DF       	LD	HL,SCRDMAD
DFD1 CD F5 DF       	CALL	SETDMA
DFD4 F1             	POP	AF
DFD5 21 00 38       	LD	HL,03800H
DFD8                
DFD8                SCRUP1:
DFD8 B7             	OR	A
DFD9 28 4D          	JR	Z,SCRCL
DFDB F5             	PUSH	AF
DFDC CD 06 E0       	CALL	UPSUB		;kanji
DFDF 3A BC EF       	LD	A,(CRTCD+12)
DFE2 5F             	LD	E,A
DFE3 16 F7          	LD	D,0F7H
DFE5 19             	ADD	HL,DE
DFE6 D5             	PUSH	DE
DFE7 CD 06 E0       	CALL	UPSUB		;Text
DFEA D1             	POP	DE
DFEB 19             	ADD	HL,DE
DFEC CD 06 E0       	CALL	UPSUB		;Color
DFEF CB E4          	SET	4,H
DFF1 F1             	POP	AF
DFF2 3D             	DEC	A
DFF3 18 E3          	JR	SCRUP1
DFF5                
DFF5                SETDMA:
DFF5 01 87 1F       	LD	BC,01F87H
DFF8                SDMA:
DFF8 04             	INC	B
DFF9 ED A3          	OUTI
DFFB 3D             	DEC	A
DFFC 20 FA          	JR	NZ,SDMA
DFFE C9             	RET
DFFF                
DFFF                SCRDMAD:
DFFF C3             	DB	0C3H		;WR6 リセット
E000 9A             	DB	09AH		;WR5 ストップ WAIT READY:HIGH
E001 65             	DB	065H		;WR0 ブロック長(LH)
E002 4F 00          	DW	79
E004 1C             	DB	01CH		;WR1 ポートAインクリメント I/O
E005 18             	DB	018H		;WR0 ポートAアドレス(LH)
E006                
E006                UPSUB:
E006 3A B1 EF       	LD	A,(CRTCD+1)
E009 5F             	LD	E,A
E00A 16 00          	LD	D,0
E00C 3E CD          	LD	A,0CDH		;WR4 バースト ポートB開始アドレス(LH)
E00E ED 79          	OUT	(C),A
E010 ED 69          	OUT	(C),L		;SOURCE
E012 ED 61          	OUT	(C),H
E014 19             	ADD	HL,DE
E015 3E 1D          	LD	A,01DH		;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
E017 ED 79          	OUT	(C),A
E019 ED 69          	OUT	(C),L		;DEST
E01B ED 61          	OUT	(C),H
E01D                GO_DMA:
E01D 3E CF          	LD	A,0CFH
E01F ED 79          	OUT	(C),A		;WR6 ロード
E021 3E B3          	LD	A,0B3H
E023 ED 79          	OUT	(C),A		;WR6 強制RDY
E025 ED 49          	OUT	(C),C		;WR6 イネーブル
E027 C9             	RET
E028                
E028                SCRCL:
E028 44             	LD	B,H
E029 4D             	LD	C,L
E02A 21 50 20       	LD	HL,02000H+80
E02D 3A 96 EF       	LD	A,(_COLORF)
E030                SCRCL1:
E030 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
E032 CB 98          	RES	3,B
E034 ED 61          	OUT	(C),H
E036 CB A0          	RES	4,B
E038 ED 79          	OUT	(C),A
E03A CB D8          	SET	3,B
E03C CB E0          	SET	4,B
E03E 03             	INC	BC
E03F 2D             	DEC	L
E040 20 EE          	JR	NZ,SCRCL1
E042 D1             	POP	DE
E043 C1             	POP	BC
E044 C9             	RET
E045                
E045                SCRN:
E045 D5             	PUSH	DE
E046 ED 58          	IN	E,(C)		;Text
E048 CB D8          	SET	3,B
E04A ED 50          	IN	D,(C)		;Kanji
E04C 28 19          	JR	Z,SCRNE
E04E AF             	XOR	A
E04F C5             	PUSH	BC
E050 01 37 30       	LD	BC,03037H	;VRMJIS
E053 DF             	RST	018H
E054 01 52 2F       	LD	BC,02F52H	;JISSFT
E057 DF             	RST	018H
E058 C1             	POP	BC
E059 ED 78          	IN	A,(C)
E05B CB 98          	RES	3,B
E05D E6 40          	AND	040H
E05F 20 03          	JR	NZ,SCRN1
E061 7A             	LD	A,D
E062 D1             	POP	DE
E063 C9             	RET
E064                SCRN1:
E064 7B             	LD	A,E
E065 D1             	POP	DE
E066 C9             	RET
E067                
E067                SCRNE:
E067 D1             	POP	DE
E068 CB 98          	RES	3,B
E06A                SCRNX:
E06A ED 78          	IN	A,(C)
E06C C9             	RET
E06D                
E06D                POS:
E06D 2A 8E EF       	LD	HL,(_TXADR)
E070 C5             	PUSH	BC
E071 ED 4B BC EF    	LD	BC,(CRTCD+12)
E075 AF             	XOR	A
E076                POS1:
E076 09             	ADD	HL,BC
E077 3C             	INC	A
E078 38 FC          	JR	C,POS1
E07A ED 42          	SBC	HL,BC
E07C 3D             	DEC	A
E07D 67             	LD	H,A
E07E C1             	POP	BC
E07F A7             	AND	A
E080 C9             	RET
E081                
E081                GETL:
E081 CD D3 EF       	CALL	_POS
E084 E5             	PUSH	HL
E085 3E CD          	LD	A,0CDH		;CALL ????
E087 32 81 DD       	LD	(INSFLG),A
E08A                GETL1:
E08A CD 3A DC       	CALL	_SYS08
E08D FE 09          	CP	9
E08F 20 08          	JR	NZ,GETL1V
E091 21 00 FF       	LD	HL,KBUF
E094 CD 6F D8       	CALL	MSX
E097 18 F1          	JR	GETL1
E099                GETL1V:
E099 5F             	LD	E,A
E09A CD CD EF       	CALL	_PRINT
E09D                
E09D 7B             	LD	A,E
E09E FE 0D          	CP	00DH
E0A0 20 E8          	JR	NZ,GETL1
E0A2 3E 01          	LD	A,1		;LD BC,????
E0A4 32 81 DD       	LD	(INSFLG),A
E0A7 11 00 FF       	LD	DE,KBUF
E0AA 3A B1 EF       	LD	A,(CRTCD+1)
E0AD 47             	LD	B,A
E0AE CD 08 D5       	CALL	ZERO_MEMORY_DE
E0B1                
E0B1 D1             	POP	DE
E0B2 CD D3 EF       	CALL	_POS
E0B5 6B             	LD	L,E
E0B6 3A B1 EF       	LD	A,(CRTCD+1)
E0B9 95             	SUB	L
E0BA 57             	LD	D,A
E0BB CD D2 DE       	CALL	LOC1
E0BE 4D             	LD	C,L
E0BF 7C             	LD	A,H
E0C0 F6 30          	OR	030H
E0C2 47             	LD	B,A
E0C3 5A             	LD	E,D
E0C4 21 00 FF       	LD	HL,KBUF
E0C7                GETL2:
E0C7 CD D0 EF       	CALL	_SCRN
E0CA 03             	INC	BC
E0CB 77             	LD	(HL),A
E0CC 23             	INC	HL
E0CD 1D             	DEC	E
E0CE 20 F7          	JR	NZ,GETL2
E0D0                GETL3:
E0D0 2B             	DEC	HL
E0D1 7E             	LD	A,(HL)
E0D2 FE 21          	CP	021H
E0D4 D0             	RET	NC
E0D5 36 00          	LD	(HL),0
E0D7 15             	DEC	D
E0D8 20 F6          	JR	NZ,GETL3
E0DA C9             	RET
E0DB                
E0DB                INKEY:
E0DB FB             	EI
E0DC E5             	PUSH	HL
E0DD 2A 90 EF       	LD	HL,(_KEYPS)
E0E0 7C             	LD	A,H
E0E1 AD             	XOR	L
E0E2 28 09          	JR	Z,INKEY1
E0E4 7C             	LD	A,H
E0E5 3C             	INC	A
E0E6 32 91 EF       	LD	(_KEYPS+1),A
E0E9 6F             	LD	L,A
E0EA 26 FE          	LD	H,KEYBF/256
E0EC 7E             	LD	A,(HL)
E0ED                INKEY1:
E0ED E1             	POP	HL
E0EE B7             	OR	A
E0EF C9             	RET
E0F0                
E0F0 00 00 10 A0    AT_RS	EQU	SCR1-AT_SCR1
E0F0                	INCLUDE	"LDFILE.ASM"
E0F0                
E0F0                ;	LSX-Dodgers FILE
E0F0                
E0F0                FILEC:
E0F0 CD FB E0       	CALL	FILE
E0F3                FILEC2:
E0F3 3A 15 EF       	LD	A,(FDRV+1)
E0F6 FE 20          	CP	020H
E0F8 C8             	RET	Z
E0F9 18 39          	JR	SETDIR1
E0FB                
E0FB                FILE:
E0FB AF             	XOR	A
E0FC 32 14 EF       	LD	(FDRV),A
E0FF 67             	LD	H,A
E100 6F             	LD	L,A
E101 22 22 EF       	LD	(FDRV+14),HL
E104 CD D2 E1       	CALL	SPCUT
E107 CD B7 E1       	CALL	CCHK3
E10A 28 12          	JR	Z,DEVI1
E10C 13             	INC	DE
E10D 1A             	LD	A,(DE)
E10E 1B             	DEC	DE
E10F FE 3A          	CP	':'
E111 20 0B          	JR	NZ,DEVI1
E113 1A             	LD	A,(DE)		;DRIVE
E114 CD 07 E4       	CALL	CAP
E117 D6 40          	SUB	'@'
E119 13             	INC	DE
E11A 13             	INC	DE
E11B 32 14 EF       	LD	(FDRV),A
E11E                DEVI1:
E11E 1A             	LD	A,(DE)
E11F D6 5C          	SUB	05CH		;\
E121 20 09          	JR	NZ,NOROOT
E123 6F             	LD	L,A		;A=0でH=0のはずなのでHL=0
E124 22 2E EF       	LD	(FDRV+26),HL
E127 2C             	INC	L
E128 22 22 EF       	LD	(FDRV+14),HL
E12B 13             	INC	DE
E12C                NOROOT:
E12C                
E12C                SETDIR:
E12C CD 58 E1       	CALL	FILED
E12F 1A             	LD	A,(DE)
E130 FE 5C          	CP	05CH		;\
E132 C0             	RET	NZ
E133 13             	INC	DE
E134                SETDIR1:
E134 3E 10          	LD	A,010H		;Directory
E136 32 21 EF       	LD	(FDRV+13),A
E139 D5             	PUSH	DE
E13A 11 14 EF       	LD	DE,FDRV
E13D 2A 1E F0       	LD	HL,(STABLE+2*00FH)
E140 CD 0F 00       	CALL	JP_HL
E143 D1             	POP	DE
E144 B7             	OR	A
E145 C0             	RET	NZ
E146                
E146 3A 21 EF       	LD	A,(FDRV+13)
E149 CB 67          	BIT	4,A
E14B C8             	RET	Z
E14C                
E14C CD 9F E1       	CALL	FILEI
E14F 2A 2E EF       	LD	HL,(FDRV+26)
E152 23             	INC	HL
E153 22 22 EF       	LD	(FDRV+14),HL
E156 18 D4          	JR	SETDIR
E158                
E158                FILED:
E158 CD 9F E1       	CALL	FILEI
E15B 21 15 EF       	LD	HL,FNAME
E15E                
E15E 06 08          	LD	B,8
E160                FILE2:
E160 CD AC E1       	CALL	CCHKF
E163 C8             	RET	Z
E164 FE 2A          	CP	'*'
E166 28 2E          	JR	Z,FILE9
E168 FE 2E          	CP	'.'
E16A 28 0C          	JR	Z,FILE4
E16C 77             	LD	(HL),A
E16D 23             	INC	HL
E16E 10 F0          	DJNZ	FILE2
E170                
E170                FILE3:
E170 CD AC E1       	CALL	CCHKF
E173 C8             	RET	Z
E174 FE 2E          	CP	'.'
E176 20 F8          	JR	NZ,FILE3
E178                
E178                FILE4:
E178 21 1D EF       	LD	HL,FNAME+8
E17B 06 03          	LD	B,3
E17D                
E17D                FILE4L:
E17D CD AC E1       	CALL	CCHKF
E180 C8             	RET	Z
E181 FE 2E          	CP	'.'
E183 20 08          	JR	NZ,FILE12
E185 32 15 EF       	LD	(FNAME),A	;Parent directory(..)
E188 32 16 EF       	LD	(FNAME+1),A
E18B 3E 20          	LD	A,020H
E18D                FILE12:
E18D FE 2A          	CP	'*'
E18F 28 0A          	JR	Z,FILE10
E191 77             	LD	(HL),A
E192 23             	INC	HL
E193 10 E8          	DJNZ	FILE4L
E195 C9             	RET
E196                
E196                FILE9:				;名前の*処理、名前の残りを?で埋める
E196 CD 9B E1       	CALL	FILE10
E199 18 D5          	JR	FILE3
E19B                
E19B                FILE10:
E19B 3E 3F          	LD	A,'?'
E19D 18 08          	JR	FILL_MEMORY
E19F                FILEI:				;名前＋拡張子をスペースで初期化
E19F 3E 20          	LD	A,020H
E1A1 01 00 0B       	LD	BC,11*256	;C=0にしておく
E1A4 21 15 EF       	LD	HL,FNAME
E1A7                FILL_MEMORY:			;HLからBバイトAで埋める
E1A7 77             	LD	(HL),A
E1A8 23             	INC	HL
E1A9 10 FC          	DJNZ	FILL_MEMORY
E1AB C9             	RET
E1AC                
E1AC                CCHKF:
E1AC 1A             	LD	A,(DE)
E1AD CD B4 E1       	CALL	CCHK2
E1B0 C8             	RET	Z
E1B1 C3 1F E5       	JP	FKAN
E1B4                
E1B4                CCHK2:
E1B4 0C             	INC	C
E1B5 0D             	DEC	C
E1B6 C0             	RET	NZ
E1B7                CCHK3:				;ZF=1 で使えない文字
E1B7 FE 2B          	CP	'+'
E1B9 C8             	RET	Z
E1BA FE 2C          	CP	','
E1BC C8             	RET	Z
E1BD FE 2F          	CP	'/'
E1BF C8             	RET	Z
E1C0 FE 3A          	CP	':'
E1C2 C8             	RET	Z
E1C3 FE 3B          	CP	';'
E1C5 C8             	RET	Z
E1C6 FE 3D          	CP	'='
E1C8 C8             	RET	Z
E1C9 FE 5C          	CP	05CH	;\
E1CB C8             	RET	Z
E1CC FE 20          	CP	020H
E1CE D0             	RET	NC
E1CF BF             	CP	A		;Z=1
E1D0 C9             	RET
E1D1                
E1D1                SS1:
E1D1 13             	INC	DE
E1D2                SPCUT:				;スペースをカット
E1D2 1A             	LD	A,(DE)
E1D3 FE 20          	CP	020H
E1D5 28 FA          	JR	Z,SS1
E1D7 C9             	RET
E1D8                
E1D8                SETDRVF:
E1D8 11 14 EF       	LD	DE,FDRV
E1DB                SETDRV0:
E1DB CD E4 E1       	CALL	SETDRV
E1DE FD E1          	POP	IY
E1E0 C1             	POP	BC
E1E1 D1             	POP	DE
E1E2 E1             	POP	HL
E1E3 C9             	RET
E1E4                
E1E4                SETDRV:
E1E4 E3             	EX	(SP),HL		;HL=RETRN ADDRESS
E1E5 D5             	PUSH	DE		;PUSH HL/DE/BC/IY
E1E6 C5             	PUSH	BC
E1E7 1A             	LD	A,(DE)
E1E8 D5             	PUSH	DE
E1E9 FD E3          	EX	(SP),IY
E1EB                
E1EB CD F7 E1       	CALL	GETDRV
E1EE 3C             	INC	A
E1EF FD 77 00       	LD	(IY+0),A	;(FCB)ドライブ番号
E1F2 3D             	DEC	A
E1F3 CD D9 EF       	CALL	_CHGDRV
E1F6                
E1F6 E9             	JP	(HL)
E1F7                
E1F7                GETDRV:
E1F7 E6 7F          	AND	07FH
E1F9 D6 01          	SUB	001H
E1FB 30 03          	JR	NC,GETDRV1
E1FD 3A 87 EF       	LD	A,(_DVSW)	;Current Drive
E200                GETDRV1:
E200 32 88 EF       	LD	(_DRV),A
E203 C9             	RET
E204                
E204                SOPENX:
E204 11 39 EF       	LD	DE,SFILE
E207 1A             	LD	A,(DE)
E208 FD BE 00       	CP	(IY+0)		;(FCB)ドライブ番号
E20B 20 24          	JR	NZ,SOPEN
E20D 13             	INC	DE
E20E FD E5          	PUSH	IY
E210 E1             	POP	HL
E211 23             	INC	HL
E212 CD 9F E3       	CALL	CPFILE
E215 20 1A          	JR	NZ,SOPEN
E217                
E217 2A F4 F0       	LD	HL,(SCDIR)
E21A FD 75 0E       	LD	(IY+14),L	;(FCB)アクセスするディレクトリのクラスタ番号+1
E21D FD 74 0F       	LD	(IY+15),H
E220                
E220 2A F8 F0       	LD	HL,(SFNDF)	;Direcroty location and Flags
E223 22 9F EF       	LD	(_FILEN),HL
E226                
E226 ED 5B F6 F0    	LD	DE,(SFBPS)
E22A 21 39 EF       	LD	HL,SFILE
E22D 36 FF          	LD	(HL),0FFH
E22F 23             	INC	HL
E230 C9             	RET
E231                SOPEN:
E231 21 47 E3       	LD	HL,FILESE
E234                SOPENC:
E234 22 6D E2       	LD	(OPENPAT+1),HL
E237                
E237 CD E2 EF       	CALL	_RDFATX		;Detect Media
E23A 38 56          	JR	C,RDDERR
E23C                
E23C AF             	XOR	A
E23D 32 9F EF       	LD	(_FILEN),A
E240 CD 4C E4       	CALL	LDDIRX1		;A=0で呼び出す
E243 28 18          	JR	Z,SDIRX1
E245                
E245 CD 38 E3       	CALL	READ_DIR	;Sub Directory
E248 38 08          	JR	C,SDIRX0
E24A 2A 7E F0       	LD	HL,(_DTBUF)
E24D 7E             	LD	A,(HL)
E24E FE 2E          	CP	'.'
E250 28 0F          	JR	Z,SOPEN1
E252                SDIRX0:
E252 AF             	XOR	A
E253 32 A0 EF       	LD	(_DIRF),A
E256 FD 36 0E 01    	LD	(IY+14),1	;(FCB)レコードサイズ
E25A FD 77 0F       	LD	(IY+15),A
E25D                SDIRX1:
E25D ED 5B FC F0    	LD	DE,(_DIRPS)	;Root Directory
E261                SOPEN1:
E261 0E 20          SDECPAT:LD	C,32		;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
E263                SOPEN1X:
E263 CD 38 E3       	CALL	READ_DIR	;FILE SEARCH
E266 38 2A          	JR	C,RDDERR
E268 2A 7E F0       	LD	HL,(_DTBUF)
E26B                SOPEN2:
E26B D5             	PUSH	DE
E26C CD 47 E3       OPENPAT:CALL	FILESE		;(self-modifying code)
E26F D1             	POP	DE
E270 38 6E          	JR	C,SOPENE
E272 28 1B          	JR	Z,SCF_FF_RET
E274                SOPEN3:
E274 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E277 B7             	OR	A
E278 20 0C          	JR	NZ,SOPEN5
E27A 13             	INC	DE		;ルートディレクトリ
E27B E5             	PUSH	HL
E27C 21 0C 00       MD_PAT:	LD	HL,12		;(self-modifying code)MAXDIR
E27F ED 52          	SBC	HL,DE		;CF=0 なので SUB HL,DE
E281 E1             	POP	HL
E282 20 DD          	JR	NZ,SOPEN1
E284 18 07          	JR	SOPEN6
E286                SOPEN5:
E286 CD 97 EA       	CALL	GNCLX		;END DIR
E289 D8             	RET	C
E28A CD FF E3       	CALL	ENDCL
E28D                SOPEN6:
E28D 38 D2          	JR	C,SOPEN1
E28F                SCF_FF_RET:
E28F 37             	SCF			;CF=1
E290 9F             	SBC	A,A		;A=0FFH
E291 C9             	RET
E292                
E292                RDDERR:
E292 BF             	CP	A		;READ ERR CF=1 ZF=1
E293 37             	SCF
E294 C9             	RET
E295                
E295                NOPEN:
E295 21 47 E3       	LD	HL,FILESE
E298 22 6D E2       	LD	(OPENPAT+1),HL
E29B FD 2A 98 EF    	LD	IY,(_FCB)
E29F CD 32 E5       	CALL	CHKWILDX
E2A2 30 EB          	JR	NC,SCF_FF_RET
E2A4 FD 7E 00       	LD	A,(IY+0)	;(FCB)ドライブ番号
E2A7 3D             	DEC	A
E2A8 32 88 EF       	LD	(_DRV),A
E2AB CD D9 EF       	CALL	_CHGDRV
E2AE D8             	RET	C
E2AF 2A F8 F0       	LD	HL,(SFNDF)	;Direcroty location and Flags
E2B2 22 9F EF       	LD	(_FILEN),HL
E2B5                
E2B5 CD 47 E4       	CALL	LDDIRX
E2B8 ED 5B 9A EF    	LD	DE,(_FBPS)
E2BC CD 38 E3       	CALL	READ_DIR
E2BF 38 D1          	JR	C,RDDERR
E2C1 3A 9E EF       	LD	A,(_FBCNT)
E2C4 3D             	DEC	A
E2C5 28 AD          	JR	Z,SOPEN3
E2C7                NOPEN2:
E2C7 2A 9C EF       	LD	HL,(_FBAD)
E2CA 01 20 00       	LD	BC,020H
E2CD 09             	ADD	HL,BC
E2CE 4F             	LD	C,A
E2CF 18 9A          	JR	SOPEN2
E2D1                
E2D1                SOPENE2:
E2D1 22 9C EF       	LD	(_FBAD),HL
E2D4 79             	LD	A,C
E2D5 32 9E EF       	LD	(_FBCNT),A
E2D8 ED 53 9A EF    	LD	(_FBPS),DE
E2DC FD 22 98 EF    	LD	(_FCB),IY
E2E0                SOPENE:
E2E0 AF             	XOR	A
E2E1 C9             	RET
E2E2                
E2E2                COPEN:
E2E2 FD 36 0D 20    	LD	(IY+13),020H	;(FCB)属性(アトリビュート)
E2E6                
E2E6 21 64 E3       	LD	HL,NEXTSE
E2E9 CD 34 E2       	CALL	SOPENC
E2EC D0             	RET	NC
E2ED C8             	RET	Z
E2EE 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E2F1 B7             	OR	A
E2F2 37             	SCF
E2F3 C8             	RET	Z		;ルートディレクトリ
E2F4 06 01          	LD	B,1
E2F6 CD 8E E5       	CALL	WRDF
E2F9 D8             	RET	C
E2FA ED 5B FE F0    	LD	DE,(_CLPS)
E2FE D5             	PUSH	DE
E2FF CD C8 E3       	CALL	DCPAT
E302 CD 22 E9       	CALL	DRDNX
E305 2A 7E F0       	LD	HL,(_DTBUF)	;ディレクトリエントリを0クリア
E308 3A 9D E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E30B 47             	LD	B,A
E30C AF             	XOR	A
E30D 4F             	LD	C,A
E30E                COPENCL:
E30E 77             	LD	(HL),A
E30F ED A1          	CPI			;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
E311 EA 0E E3       	JP	PE,COPENCL
E314                
E314 3A E6 E3       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ数
E317 3D             	DEC	A
E318 28 19          	JR	Z,COPENE
E31A 3E 01          	LD	A,1		;1セクタ辺りのセクタ数が2以上の場合
E31C 32 8F EA       	LD	(_SECPS+1),A
E31F D1             	POP	DE		;DE=(_CLPS)
E320 D5             	PUSH	DE
E321                COPEN1:
E321 D5             	PUSH	DE		;データバッファに入らないセクタもゼロクリア
E322 C5             	PUSH	BC
E323 2A 7E F0       	LD	HL,(_DTBUF)
E326 CD E2 E3       	CALL	CLUSTX
E329 CD FB EB       	CALL	DWT24
E32C C1             	POP	BC
E32D D1             	POP	DE
E32E CD 8E EA       	CALL	NEXTX
E331 20 EE          	JR	NZ,COPEN1
E333                COPENE:
E333 2A 7E F0       	LD	HL,(_DTBUF)
E336 D1             	POP	DE
E337 C9             	RET
E338                
E338                READ_DIR:
E338 ED 53 FE F0    	LD	(_CLPS),DE
E33C C5             	PUSH	BC
E33D D5             	PUSH	DE
E33E CD C8 E3       	CALL	DCPAT
E341 CD 02 E9       	CALL	DRDX
E344 D1             	POP	DE
E345 C1             	POP	BC
E346 C9             	RET
E347                
E347                FILESE:
E347 7E             	LD	A,(HL)
E348 B7             	OR	A
E349 C8             	RET	Z		;END:ZF=1 CF=0
E34A FE E5          	CP	0E5H
E34C 28 0E          	JR	Z,FILESE1
E34E FD E5          	PUSH	IY
E350 D1             	POP	DE
E351 13             	INC	DE
E352 E5             	PUSH	HL
E353 CD 9F E3       	CALL	CPFILE
E356 CC C0 E3       	CALL	Z,CPFILE2
E359 E1             	POP	HL
E35A 37             	SCF
E35B C8             	RET	Z		;!!!:(ZF=1) CF=1
E35C                FILESE1:
E35C CD 73 E3       	CALL	FNEXT
E35F 20 E6          	JR	NZ,FILESE
E361                ZF0_CF0_AFF_RET:
E361 F6 FF          	OR	0FFH		;ZF=0 CF=0
E363 C9             	RET
E364                
E364                NEXTSE:
E364 7E             	LD	A,(HL)
E365 B7             	OR	A
E366 37             	SCF
E367 C8             	RET	Z		;!!!:ZF=1 CF=1
E368 FE E5          	CP	0E5H
E36A 37             	SCF
E36B C8             	RET	Z		;!!!:(ZF=1) CF=1
E36C CD 73 E3       	CALL	FNEXT
E36F 20 F3          	JR	NZ,NEXTSE
E371 18 EE          	JR	ZF0_CF0_AFF_RET
E373                
E373                FNEXT:
E373 E5             	PUSH	HL
E374 21 9F EF       	LD	HL,_FILEN
E377 34             	INC	(HL)
E378 E1             	POP	HL
E379 11 20 00       	LD	DE,020H
E37C 19             	ADD	HL,DE
E37D 0D             	DEC	C
E37E C9             	RET
E37F                
E37F                CPNAME:
E37F C5             	PUSH	BC
E380 D5             	PUSH	DE
E381 E5             	PUSH	HL
E382 CD 99 E3       	CALL	CPFILE4
E385 E1             	POP	HL
E386 23             	INC	HL
E387 23             	INC	HL
E388 23             	INC	HL
E389 23             	INC	HL
E38A D1             	POP	DE
E38B C1             	POP	BC
E38C 20 05          	JR	NZ,CPNAME1
E38E 7E             	LD	A,(HL)
E38F 23             	INC	HL
E390 66             	LD	H,(HL)
E391 6F             	LD	L,A
E392 C9             	RET
E393                CPNAME1:
E393 23             	INC	HL
E394 23             	INC	HL
E395 10 E8          	DJNZ	CPNAME
E397 37             	SCF
E398 C9             	RET
E399                
E399                CPFILE4:
E399 C5             	PUSH	BC
E39A 01 00 04       	LD	BC,00400H
E39D 18 04          	JR	CPSTR1
E39F                CPFILE:
E39F C5             	PUSH	BC
E3A0 01 00 0B       	LD	BC,00B00H
E3A3                CPSTR1:
E3A3 1A             	LD	A,(DE)
E3A4 FE 3F          	CP	'?'		;Wild card
E3A6 28 12          	JR	Z,CPSTR2
E3A8 7E             	LD	A,(HL)
E3A9 CD 18 E5       	CALL	FKANC
E3AC E5             	PUSH	HL
E3AD 67             	LD	H,A
E3AE 1A             	LD	A,(DE)
E3AF CB 01          	RLC	C
E3B1 CD 18 E5       	CALL	FKANC
E3B4 CB 09          	RRC	C
E3B6 BC             	CP	H		;CP (HL),(DE)
E3B7 E1             	POP	HL
E3B8 20 04          	JR	NZ,CPSTR3
E3BA                CPSTR2:
E3BA 13             	INC	DE
E3BB 23             	INC	HL
E3BC 10 E5          	DJNZ	CPSTR1
E3BE                CPSTR3:
E3BE C1             	POP	BC
E3BF C9             	RET
E3C0                
E3C0                CPFILE2:
E3C0 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E3C3 F6 E1          	OR	0E1H
E3C5 2F             	CPL
E3C6 A6             	AND	(HL)
E3C7 C9             	RET
E3C8                
E3C8                DCPAT:
E3C8 0E 00          	LD	C,0
E3CA 2A 7E F0       	LD	HL,(_DTBUF)
E3CD 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E3D0 B7             	OR	A
E3D1 C8             	RET	Z		;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
E3D2 3A E6 E3       	LD	A,(SPCPAT+1)
E3D5 4F             	LD	C,A
E3D6 3A 8F EA       	LD	A,(_SECPS+1)
E3D9 B9             	CP	C
E3DA 38 01          	JR	C,DC1
E3DC AF             	XOR	A
E3DD                DC1:
E3DD F6 80          	OR	080H
E3DF 32 A0 EF       	LD	(_DIRF),A	;bit0-6:セクタインデックス
E3E2                CLUSTX:
E3E2 E5             	PUSH	HL
E3E3 EB             	EX	DE,HL
E3E4 AF             	XOR	A
E3E5 0E 01          SPCPAT:	LD	C,1		;自己書き換え（1クラスタの論理セクタ数）
E3E7                L_CLDBL:
E3E7 CB 19          	RR	C		;->CF
E3E9 38 04          	JR	C,E_CLDBL
E3EB 29             	ADD	HL,HL		;*2
E3EC 8F             	ADC	A,A
E3ED 18 F8          	JR	L_CLDBL
E3EF                E_CLDBL
E3EF 4F             	LD	C,A
E3F0 3A 8F EA       	LD	A,(_SECPS+1)
E3F3 B5             	OR	L
E3F4 6F             	LD	L,A
E3F5 11 08 00       CLSPAT:	LD	DE,8	;+8 (2D)  !ADDCL (self-modifying code)
E3F8 AF             	XOR	A
E3F9 19             	ADD	HL,DE	;データ格納領域の先頭論理セクタ番号
E3FA 89             	ADC	A,C
E3FB 4F             	LD	C,A
E3FC EB             	EX	DE,HL
E3FD E1             	POP	HL
E3FE C9             	RET
E3FF                
E3FF                ENDCL:
E3FF 7A             	LD	A,D	;END CLUSTER
E400 FE 01          CLPAT1:	CP	1	;164=356	(self-modifying code)
E402 C0             	RET	NZ
E403 7B             	LD	A,E
E404 FE 64          CLPAT2:	CP	064H	;		(self-modifying code)
E406 C9             	RET
E407                
E407                CAP:
E407 FE 61          	CP	'a'
E409 D8             	RET	C
E40A FE 7B          	CP	'z'+1
E40C D0             	RET	NC
E40D D6 20          	SUB	020H
E40F C9             	RET
E410                CAP2:
E410 CD 07 E4       	CALL	CAP
E413                CAP3:
E413 CD 1C E4       	CALL	CAP4
E416 FE 21          	CP	021H
E418 D0             	RET	NC
E419 3E A0          	LD	A,0A0H
E41B C9             	RET
E41C                CAP4:
E41C FE 05          	CP	5
E41E C0             	RET	NZ
E41F 3E E5          	LD	A,0E5H
E421 C9             	RET
E422                
E422                CHDIR:
E422 CD 32 ED       	CALL	GETDPBD
E425 38 1D          	JR	C,CHDIR2
E427 DD 75 1A       	LD	(IX+01AH),L		;_SDIR_
E42A DD 74 1B       	LD	(IX+01BH),H		;_SDIR_+1
E42D 18 15          	JR	CHDIR2		;POP_IX_RET
E42F                
E42F                LDDIR:
E42F CD 32 ED       	CALL	GETDPBD
E432 DD 5E 1A       	LD	E,(IX+01AH)		;_SDIR_
E435 DD 56 1B       	LD	D,(IX+01BH)		;_SDIR_+1
E438 13             	INC	DE
E439 FD 73 0E       	LD	(IY+14),E	;(FCB)アクセスするディレクトリのクラスタ番号+1
E43C FD 72 0F       	LD	(IY+15),D
E43F 1B             	DEC	DE
E440 AF             	XOR	A
E441 32 A0 EF       	LD	(_DIRF),A
E444                CHDIR2:
E444 DD E1          	POP	IX
E446 C9             	RET
E447                
E447                LDDIRX:
E447 3A A0 EF       	LD	A,(_DIRF)	;(FCB)アクセスするディレクトリのセクタインデックス
E44A E6 7F          	AND	07FH
E44C                LDDIRX1:
E44C 32 8F EA       	LD	(_SECPS+1),A
E44F FD 5E 0E       	LD	E,(IY+14)	;(FCB)アクセスするディレクトリのクラスタ番号+1
E452 FD 56 0F       	LD	D,(IY+15)
E455 1B             	DEC	DE
E456 CD FF E3       	CALL	ENDCL
E459 D4 2F E4       	CALL	NC,LDDIR
E45C                LDDIRS:
E45C 7A             	LD	A,D
E45D B3             	OR	E
E45E 32 A0 EF       	LD	(_DIRF),A	;ディレクトリか判別
E461 C9             	RET
E462                
E462                KILL:
E462 CD 32 E5       	CALL	CHKWILDX
E465 38 34          	JR	C,KILLW
E467 CD 04 E2       	CALL	SOPENX
E46A                KILLS:
E46A 3E 1F          	LD	A,01FH
E46C D4 AE E4       	CALL	NC,CHKATT
E46F D8             	RET	C
E470                KILLSX:
E470 36 E5          	LD	(HL),0E5H	;DIR
E472 CD 0C E5       	CALL	WTDB
E475 11 1A 00       	LD	DE,01AH
E478 19             	ADD	HL,DE
E479 5E             	LD	E,(HL)
E47A 23             	INC	HL
E47B 56             	LD	D,(HL)
E47C                KILLS1:
E47C CD FF E3       	CALL	ENDCL
E47F D0             	RET	NC		;CF=0
E480 21 FE FF       	LD	HL,0-2
E483 19             	ADD	HL,DE
E484 D0             	RET	NC		;DE= 0 or 1
E485 D5             	PUSH	DE
E486 CD F7 EF       	CALL	_GNCL
E489 ED 53 FE F0    	LD	(_CLPS),DE
E48D D1             	POP	DE
E48E 21 00 00       	LD	HL,0
E491 D4 FA EF       	CALL	NC,_SNCL
E494 D8             	RET	C
E495 ED 5B FE F0    	LD	DE,(_CLPS)	;FAT
E499 18 E1          	JR	KILLS1
E49B                
E49B                KILLW:
E49B CD 31 E2       	CALL	SOPEN
E49E                KILLW1:
E49E 38 0B          	JR	C,KILLW2
E4A0 CD D1 E2       	CALL	SOPENE2
E4A3 CD 6A E4       	CALL	KILLS
E4A6 CD 95 E2       	CALL	NOPEN
E4A9 18 F3          	JR	KILLW1
E4AB                KILLW2:
E4AB C8             	RET	Z
E4AC 3F             	CCF
E4AD C9             	RET
E4AE                
E4AE                CHKATT:
E4AE E5             	PUSH	HL
E4AF 11 0B 00       	LD	DE,00BH
E4B2 19             	ADD	HL,DE
E4B3 A6             	AND	(HL)
E4B4 E1             	POP	HL
E4B5 C8             	RET	Z
E4B6 37             	SCF
E4B7 C9             	RET
E4B8                
E4B8                NAME:
E4B8 CD 32 E5       	CALL	CHKWILDX
E4BB D8             	RET	C
E4BC 11 04 00       	LD	DE,4
E4BF 19             	ADD	HL,DE
E4C0 22 D8 E4       	LD	(NAMEP+2),HL
E4C3 23             	INC	HL
E4C4 CD 36 E5       	CALL	CHKWILD
E4C7 D8             	RET	C
E4C8                
E4C8 CD 04 E2       	CALL	SOPENX
E4CB 3E 0F          	LD	A,00FH
E4CD D4 AE E4       	CALL	NC,CHKATT
E4D0 D8             	RET	C
E4D1                
E4D1 FD 7E 00       	LD	A,(IY+0)
E4D4 FD E5          	PUSH	IY
E4D6 FD 21 00 00    NAMEP:	LD	IY,0		;自己書き換え
E4DA FD 77 00       	LD	(IY+0),A
E4DD CD 04 E2       	CALL	SOPENX
E4E0 FD E3          	EX	(SP),IY
E4E2 3F             	CCF
E4E3 D4 31 E2       	CALL	NC,SOPEN
E4E6 EB             	EX	DE,HL
E4E7 E1             	POP	HL
E4E8 D8             	RET	C
E4E9                
E4E9                SETNAME:
E4E9 01 00 0B       	LD	BC,11*256
E4EC 23             	INC	HL
E4ED 7E             	LD	A,(HL)
E4EE FE E5          	CP	0E5H
E4F0 20 04          	JR	NZ,SNAME1
E4F2 3E 05          	LD	A,5
E4F4 18 0E          	JR	SNAME3
E4F6                SNAME1:
E4F6 7E             	LD	A,(HL)
E4F7 0C             	INC	C
E4F8 0D             	DEC	C
E4F9 20 09          	JR	NZ,SNAME3
E4FB CD 07 E4       	CALL	CAP
E4FE FE A0          	CP	0A0H
E500 20 02          	JR	NZ,SNAME3
E502 3E 20          	LD	A,020H
E504                SNAME3:
E504 12             	LD	(DE),A
E505 7E             	LD	A,(HL)
E506 23             	INC	HL
E507 CD 1F E5       	CALL	FKAN
E50A 10 EA          	DJNZ	SNAME1
E50C                WTDB:
E50C 3E FF          	LD	A,0FFH
E50E 32 39 EF       	LD	(SFILE),A
E511                SWTDBF:
E511 3E 01          	LD	A,1
E513 32 A4 EF       	LD	(_WTDBF),A
E516 AF             	XOR	A
E517 C9             	RET
E518                
E518                FKANC:
E518 CB 41          	BIT	0,C
E51A CC 10 E4       	CALL	Z,CAP2
E51D 18 01          	JR	FKANX
E51F                FKAN:			;漢字チェック
E51F 13             	INC	DE
E520                FKANX:
E520 CB 41          	BIT	0,C
E522 CB 81          	RES	0,C
E524 C0             	RET	NZ
E525 FE 80          	CP	080H
E527 D8             	RET	C
E528 FE A0          	CP	0A0H
E52A 38 03          	JR	C,FKAN1
E52C FE E0          	CP	0E0H
E52E D8             	RET	C
E52F                FKAN1:
E52F 0C             	INC	C
E530 A7             	AND	A
E531 C9             	RET
E532                
E532                CHKWILDX:
E532 FD E5          	PUSH	IY
E534 E1             	POP	HL
E535 23             	INC	HL
E536                CHKWILD:
E536 06 0B          	LD	B,11
E538 3E 3F          	LD	A,'?'
E53A                CHKWIL1:
E53A BE             	CP	(HL)
E53B 23             	INC	HL
E53C 37             	SCF
E53D C8             	RET	Z
E53E 10 FA          	DJNZ	CHKWIL1
E540 AF             	XOR	A
E541 C9             	RET
E542                
E542                SDIRENT:		;IY=FCB HL=DIR
E542 D5             	PUSH	DE
E543 E5             	PUSH	HL
E544 FD E5          	PUSH	IY
E546 D1             	POP	DE
E547 EB             	EX	DE,HL
E548 CD E9 E4       	CALL	SETNAME
E54B                ;				Attribute
E54B FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E54E 12             	LD	(DE),A
E54F 13             	INC	DE
E550                ;				Reserved
E550 AF             	XOR	A
E551 06 0A          	LD	B,10
E553                SDE1:
E553 12             	LD	(DE),A
E554 13             	INC	DE
E555 10 FC          	DJNZ	SDE1
E557                					;(FCB)更新時刻
E557 21 EA F0       	LD	HL,SDDATA		;(FCB)更新年月日
E55A 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
E55C                SDLOOP:					;(FCB)ファイルのサイズ(バイト単位)
E55C 7E             	LD	A,(HL)
E55D 23             	INC	HL
E55E 32 63 E5       	LD	(SDPAT+2),A
E561 FD 7E 00       SDPAT:	LD	A,(IY+0)	;LD A,(IY+A)
E564 12             	LD	(DE),A
E565 13             	INC	DE
E566 10 F4          	DJNZ	SDLOOP
E568                
E568 AF             	XOR	A
E569 E1             	POP	HL
E56A D1             	POP	DE
E56B C9             	RET
E56C                
E56C                WOPEN:
E56C FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E56F E6 1F          	AND	01FH
E571 37             	SCF
E572 C0             	RET	NZ
E573 FD 36 1C FE    	LD	(IY+28),0FEH	;(FCB)オープンモード
E577                TOPEN2:
E577 AF             	XOR	A
E578                TOPEN:				;Initializes the time stamp
E578 FD 36 17 FF    	LD	(IY+23),0FFH	;(FCB)更新時刻
E57C C9             	RET
E57D                
E57D                WRDFX:
E57D 3A E6 E3       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ
E580                L_WRFX:
E580 1F             	RRA		;->CF
E581 38 04          	JR	C,E_WRFX
E583 CB 39          	SRL	C	;C=C/2
E585 18 F9          	JR	L_WRFX
E587                E_WRFX:
E587 41             	LD	B,C
E588 04             	INC	B
E589 3E 37          	LD	A,037H		;SCF
E58B 32 1F E9       	LD	(DRDN1),A
E58E                
E58E                WRDF:				;Bクラスタ分FATを確保する
E58E 11 02 00       	LD	DE,2
E591 AF             	XOR	A
E592 32 8F EA       	LD	(_SECPS+1),A
E595                WRDF1:
E595 C5             	PUSH	BC
E596 D5             	PUSH	DE
E597 CD F7 EF       	CALL	_GNCL
E59A 38 1C          	JR	C,WRDF3
E59C 7A             	LD	A,D		;空いているかチェック
E59D B3             	OR	E
E59E 20 27          	JR	NZ,WRDF4
E5A0 E1             	POP	HL		;HL=空いているクラスタ
E5A1 E5             	PUSH	HL
E5A2 ED 5B FE F0    	LD	DE,(_CLPS)	;DE=元の(_CLPS)
E5A6 22 FE F0       	LD	(_CLPS),HL
E5A9 7A             	LD	A,D		;元の(_CLPS)が 0 か?
E5AA B3             	OR	E
E5AB 20 08          	JR	NZ,WRDF2
E5AD FD 75 1A       	LD	(IY+26),L	;(FCB)ファイルの先頭クラスタ
E5B0 FD 74 1B       	LD	(IY+27),H	;元が空の場合はFCBにクラスタをセットする
E5B3 18 03          	JR	WRDF3
E5B5                WRDF2:
E5B5 CD FA EF       	CALL	_SNCL
E5B8                WRDF3:
E5B8 D1             	POP	DE
E5B9 C1             	POP	BC
E5BA D8             	RET	C
E5BB 10 0C          	DJNZ	WRDF5		;ここでループカウンタチェック
E5BD ED 5B FE F0    	LD	DE,(_CLPS)
E5C1 21 FF FF       	LD	HL,0FFFFH	;FATエントリ終了(EOCマーク)
E5C4 C3 FA EF       	JP	_SNCL
E5C7                
E5C7                WRDF4:				;DEクラスタが空じゃないので次に移動する
E5C7 D1             	POP	DE
E5C8 C1             	POP	BC
E5C9                WRDF5:
E5C9 13             	INC	DE
E5CA CD FF E3       	CALL	ENDCL
E5CD 38 C6          	JR	C,WRDF1
E5CF 37             	SCF
E5D0 C9             	RET
E5D1                
E5D1                RWXR:
E5D1 3A 9D E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E5D4                L_RWX:
E5D4 1F             	RRA		;->CF
E5D5 38 06          	JR	C,E_RWX
E5D7 CB 38          	SRL	B	;BC=BC/2
E5D9 CB 19          	RR	C	;
E5DB 18 F7          	JR	L_RWX
E5DD                E_RWX:
E5DD FD 5E 1A       	LD	E,(IY+26)	;(FCB)ファイルの先頭クラスタ
E5E0 FD 56 1B       	LD	D,(IY+27)
E5E3 AF             	XOR	A
E5E4 32 8F EA       	LD	(_SECPS+1),A
E5E7                RWX1:
E5E7 ED 53 FE F0    	LD	(_CLPS),DE
E5EB 7A             	LD	A,D
E5EC B3             	OR	E
E5ED 28 0D          	JR	Z,SCF_RET	;RET DE==0 => CF=1
E5EF                
E5EF 78             	LD	A,B
E5F0 B1             	OR	C
E5F1 C8             	RET	Z		;RET BC==0 => CF=0
E5F2                
E5F2 CD 97 EA       	CALL	GNCLX
E5F5 D8             	RET	C
E5F6 0B             	DEC	BC
E5F7                
E5F7 CD FF E3       	CALL	ENDCL
E5FA 38 EB          	JR	C,RWX1
E5FC                SCF_RET:
E5FC 37             	SCF
E5FD C9             	RET
E5FE                
E5FE                DSKF:
E5FE 11 00 00       MAXCLP:	LD	DE,0
E601 2A AC EF       	LD	HL,(_FAKEFREE)
E604 7C             	LD	A,H
E605 B5             	OR	L
E606 28 03          	JR	Z,DSKF1
E608 11 01 00       	LD	DE,1
E60B                DSKF1:
E60B D5             	PUSH	DE
E60C CD F7 EF       	CALL	_GNCL
E60F 38 0C          	JR	C,POPSCF
E611 7A             	LD	A,D
E612 B3             	OR	E
E613 20 01          	JR	NZ,DSKF2
E615 23             	INC	HL
E616                DSKF2:
E616 D1             	POP	DE
E617 1B             	DEC	DE
E618 7A             	LD	A,D
E619 B3             	OR	E
E61A 20 EF          	JR	NZ,DSKF1
E61C C9             	RET
E61D                
E61D                POPSCF:
E61D F1             	POP	AF
E61E 37             	SCF
E61F C9             	RET
E620                
E620                SETTMS:
E620 FD 7E 17       	LD	A,(IY+23)	;(FCB)ファイルを最後に変更した時刻
E623 3C             	INC	A
E624 C0             	RET	NZ		;ファイルが更新されていない
E625                SETTMSX:			;FCBに日付時刻をセットする
E625 CD E9 DC       	CALL	_SYS2C		;(BDOS)時刻の獲得
E628                				;H←時  L←分  D←秒
E628 CB 25          	SLA	L		;   *2
E62A CB 25          	SLA	L		;   *4
E62C 29             	ADD	HL,HL		;*2 *8
E62D 29             	ADD	HL,HL		;*4 *16
E62E 29             	ADD	HL,HL		;*8 *32
E62F 7A             	LD	A,D
E630 0F             	RRCA			;bit.0->7->->->0->C
E631 E6 1F          	AND	01FH
E633 B5             	OR	L
E634 FD 77 16       	LD	(IY+22),A	;(FCB)ファイルを最後に変更した時刻
E637 FD 74 17       	LD	(IY+23),H
E63A                
E63A CD B5 DC       	CALL	_SYS2A		;(BDOS)日付の獲得
E63D                				;HL←年  D←月  E←日
E63D 01 44 F8       	LD	BC,0-1980
E640 09             	ADD	HL,BC
E641 65             	LD	H,L
E642                
E642 7A             	LD	A,D
E643 87             	ADD	A,A		;*2
E644 87             	ADD	A,A		;*4
E645 87             	ADD	A,A		;*8
E646 87             	ADD	A,A		;*16
E647 6F             	LD	L,A
E648 29             	ADD	HL,HL		;*32
E649 7D             	LD	A,L
E64A B3             	OR	E
E64B FD 77 14       	LD	(IY+20),A	;(FCB)ファイルを最後に変更した日付
E64E FD 74 15       	LD	(IY+21),H
E651 C9             	RET
E652                
E652                PUSHRR:
E652 CD 58 E6       	CALL	SUBRR
E655                POPRR1:
E655 ED B0          	LDIR
E657 C9             	RET
E658                
E658                SUBRR:
E658 FD E5          	PUSH	IY
E65A E1             	POP	HL
E65B 11 21 00       	LD	DE,33
E65E 19             	ADD	HL,DE
E65F 11 5A EF       	LD	DE,HLBUF
E662 01 03 00       	LD	BC,3
E665 C9             	RET
E666                
E666                SETSEQ:
E666 F5             	PUSH	AF		;AHL=Random record
E667 FD 7E 21       	LD	A,(IY+33)	;(FCB)ランダムレコード
E66A FD 6E 22       	LD	L,(IY+34)
E66D FD 66 23       	LD	H,(IY+35)
E670                
E670 CD 8C E6       	CALL	SSQ1
E673                
E673 29             	ADD	HL,HL
E674 CB 3D          	SRL	L		;L=L/2
E676 FD 75 20       	LD	(IY+32),L	;(FCB)カレントレコード
E679 FD 74 0C       	LD	(IY+12),H	;(FCB)カレントブロック
E67C F1             	POP	AF
E67D                
E67D                POPRR:
E67D CD 58 E6       	CALL	SUBRR
E680 EB             	EX	DE,HL
E681 18 D2          	JR	POPRR1
E683                
E683                GETSIZE:
E683 FD 7E 10       	LD	A,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
E686 FD 6E 11       	LD	L,(IY+17)
E689 FD 66 12       	LD	H,(IY+18)
E68C                SSQ1:				;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
E68C 87             	ADD	A,A		;in HLA => out HL
E68D ED 6A          	ADC	HL,HL
E68F B7             	OR	A
E690 C8             	RET	Z
E691 23             	INC	HL
E692 C9             	RET
E693                
E693                GETSEQ:
E693 FD 6E 20       	LD	L,(IY+32)	;(FCB)カレントレコード
E696 FD 66 0C       	LD	H,(IY+12)	;(FCB)カレントブロック
E699                
E699 CB 25          	SLA	L	;L=L*2
E69B                
E69B CB 3C          	SRL	H	;HL=HL/2
E69D CB 1D          	RR	L	;
E69F C9             	RET
E6A0                
E6A0                RB_WRITE:
E6A0 C5             	PUSH	BC
E6A1 ED 4B 4C F0    	LD	BC,(STABLE+2*026H)	;(BDOS)ランダムブロック書き込み
E6A5 18 05          	JR	RBRW
E6A7                RB_READ:
E6A7 C5             	PUSH	BC
E6A8 ED 4B 4E F0    	LD	BC,(STABLE+2*027H)	;(BDOS)ランダムブロック読み込み
E6AC                RBRW:
E6AC AF             	XOR	A	;HLA = HL*128
E6AD CB 3C          	SRL	H	;HL=HL/2
E6AF CB 1D          	RR	L	;
E6B1 1F             	RRA			;HLA
E6B2 FD 77 21       	LD	(IY+33),A	;(FCB)ランダムレコード
E6B5 FD 75 22       	LD	(IY+34),L
E6B8 FD 74 23       	LD	(IY+35),H
E6BB 21 80 00       	LD	HL,128
E6BE                
E6BE FD E5          	PUSH	IY
E6C0 D1             	POP	DE
E6C1 D5             	PUSH	DE
E6C2 CD C9 E6       	CALL	JP_BC
E6C5 FD E1          	POP	IY
E6C7 C1             	POP	BC
E6C8 C9             	RET
E6C9                JP_BC:
E6C9 C5             	PUSH	BC
E6CA C9             	RET
E6CB                
E6CB 00 00 E2 8F    _SYS03	EQU	SCF_FF_RET	;(BDOS)外部入力
E6CB 00 00 E2 8F    _SYS2B	EQU	SCF_FF_RET	;(BDOS)日付の設定
E6CB 00 00 E2 8F    _SYS2D	EQU	SCF_FF_RET	;(BDOS)時刻の設定
E6CB 00 00 E2 8F    _SYS39	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの作成
E6CB 00 00 E2 8F    _SYS3A	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの削除
E6CB                
E6CB                	INCLUDE	"LDFILE2.ASM"
E6CB                
E6CB                ;	LSX-Dodgers FILE2
E6CB                
E6CB                				;Write random block
E6CB                _SYS26:		;(BDOS)ランダムブロック書き込み
E6CB AF             	XOR	A
E6CC 32 1F E9       	LD	(DRDN1),A	;NOP
E6CF 22 E0 E8       	LD	(LEFT+1),HL	;HL←書き込むレコード数
E6D2 22 5D EF       	LD	(LEFTX),HL
E6D5 CD E4 E1       	CALL	SETDRV
E6D8                
E6D8 CD 48 E8       	CALL	RBX0
E6DB DA 71 E7       	JP	C,RBWERR
E6DE CD 6C E5       	CALL	WOPEN
E6E1 DA 71 E7       	JP	C,RBWERR
E6E4 7C             	LD	A,H
E6E5 B5             	OR	L
E6E6 CA 6A E7       	JP	Z,RBW1
E6E9                
E6E9 2B             	DEC	HL
E6EA                
E6EA CD F8 E8       	CALL	GET_RR_CDE	;CDE=Random record
E6ED                
E6ED AF             	XOR	A	;AHL=HL+CDE
E6EE 19             	ADD	HL,DE
E6EF 89             	ADC	A,C
E6F0                
E6F0 47             	LD	B,A
E6F1 4C             	LD	C,H
E6F2                
E6F2 CD D1 E5       	CALL	RWXR
E6F5 DC 7D E5       	CALL	C,WRDFX
E6F8 DA 71 E7       	JP	C,RBWERR
E6FB                
E6FB CD 71 E8       	CALL	RBX2
E6FE 28 1A          	JR	Z,RBWB		;NZ=セクタ以下の端数がある
E700 CD 85 E8       	CALL	RBXA
E703 38 6C          	JR	C,RBWERR
E705 EB             	EX	DE,HL
E706 C5             	PUSH	BC
E707 ED B0          	LDIR
E709 22 5F EF       	LD	(DTAX),HL
E70C                
E70C CD 11 E5       	CALL	SWTDBF		;バッファデータは更新された
E70F                
E70F 2A 5D EF       	LD	HL,(LEFTX)
E712 D1             	POP	DE
E713 ED 52          	SBC	HL,DE
E715 22 5D EF       	LD	(LEFTX),HL
E718 28 30          	JR	Z,RBWEND
E71A                
E71A                RBWB:
E71A CD BB E8       	CALL	RBXB
E71D 28 13          	JR	Z,RBWC
E71F                RBWB1:
E71F C5             	PUSH	BC
E720 D5             	PUSH	DE
E721 CD E2 E3       	CALL	CLUSTX
E724 CD FB EB       	CALL	DWT24
E727 D1             	POP	DE
E728 C1             	POP	BC
E729 38 46          	JR	C,RBWERR
E72B CD 97 EA       	CALL	GNCLX
E72E 38 41          	JR	C,RBWERR
E730 10 ED          	DJNZ	RBWB1
E732                RBWC:
E732 CD D3 E8       	CALL	RBXC
E735 28 13          	JR	Z,RBWEND
E737 C5             	PUSH	BC
E738 CD E2 E3       	CALL	CLUSTX
E73B CD 1E E9       	CALL	DRDN
E73E C1             	POP	BC
E73F 38 30          	JR	C,RBWERR
E741 ED 5B 7E F0    	LD	DE,(_DTBUF)
E745 ED B0          	LDIR
E747 CD 11 E5       	CALL	SWTDBF		;バッファデータは更新された
E74A                RBWEND:
E74A CD DF E8       	CALL	RBXEND
E74D                
E74D CD 57 E8       	CALL	RBX1
E750 30 18          	JR	NC,RBW1
E752 2A E0 E8       	LD	HL,(LEFT+1)
E755 FD 5E 10       	LD	E,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
E758 FD 56 11       	LD	D,(IY+17)	;CDE=File size
E75B FD 4E 12       	LD	C,(IY+18)
E75E AF             	XOR	A
E75F 19             	ADD	HL,DE
E760 89             	ADC	A,C
E761 FD 75 10       	LD	(IY+16),L	;(FCB)ファイルのサイズ(バイト単位)
E764 FD 74 11       	LD	(IY+17),H
E767 FD 77 12       	LD	(IY+18),A
E76A                RBW1:
E76A FD E1          	POP	IY
E76C C1             	POP	BC
E76D D1             	POP	DE
E76E E1             	POP	HL
E76F                DD_NUL:
E76F AF             	XOR	A
E770 C9             	RET
E771                
E771                RBWERR:
E771 FD E5          	PUSH	IY
E773 D1             	POP	DE
E774 2A 20 F0       	LD	HL,(STABLE+2*010H)
E777 CD 0F 00       	CALL	JP_HL
E77A                RBRERR1:
E77A 3E 01          	LD	A,001H
E77C                RBRERR2:
E77C FD E1          	POP	IY
E77E C1             	POP	BC
E77F D1             	POP	DE
E780 E1             	POP	HL
E781 37             	SCF
E782 21 00 00       	LD	HL,0
E785 C9             	RET
E786                
E786                RBRERR:
E786 3E FF          	LD	A,0FFH
E788 18 F2          	JR	RBRERR2
E78A                
E78A                RBRFL:
E78A 3E 00          RBRFLP:	LD	A,000H
E78C FE 0D          	CP	00DH
E78E 20 05          	JR	NZ,RBRFL1
E790 D5             	PUSH	DE
E791 1E 0A          	LD	E,00AH
E793 18 05          	JR	RBRFL2
E795                RBRFL1:
E795 D5             	PUSH	DE
E796 CD 09 EF       	CALL	_SYS07
E799 5F             	LD	E,A
E79A                RBRFL2:
E79A CD CD EF       	CALL	_PRINT
E79D 7B             	LD	A,E
E79E D1             	POP	DE
E79F 32 8B E7       	LD	(RBRFLP+1),A
E7A2 C9             	RET
E7A3                DDX:
E7A3 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
E7A6 CD 07 E4       	CALL	CAP
E7A9 FE 41          	CP	'A'
E7AB C9             	RET
E7AC                
E7AC                				;Read random block
E7AC                _SYS27:		;(BDOS)ランダムブロック読み込み
E7AC 22 5D EF       	LD	(LEFTX),HL
E7AF CD E4 E1       	CALL	SETDRV
E7B2                
E7B2 FD CB 0D 66    	BIT	4,(IY+13)	;(FCB)属性(アトリビュート)
E7B6 C2 36 E8       	JP	NZ,RBRDIR	;ディレクトリ
E7B9 CD 48 E8       	CALL	RBX0
E7BC DA 86 E7       	JP	C,RBRERR
E7BF CD 57 E8       	CALL	RBX1
E7C2 DA 7A E7       	JP	C,RBRERR1
E7C5 79             	LD	A,C
E7C6 EB             	EX	DE,HL
E7C7 ED 52          	SBC	HL,DE		;CP 0HL,CDE
E7C9 19             	ADD	HL,DE
E7CA DE 00          	SBC	A,000H
E7CC 38 01          	JR	C,RBR1
E7CE EB             	EX	DE,HL
E7CF                RBR1:
E7CF 9F             	SBC	A,A
E7D0 E6 01          	AND	1
E7D2 32 34 E8       	LD	(RBRAP+1),A
E7D5                
E7D5 7C             	LD	A,H
E7D6 B5             	OR	L
E7D7 28 54          	JR	Z,RBREND0
E7D9                
E7D9 22 E0 E8       	LD	(LEFT+1),HL	;Read record byte
E7DC 22 5D EF       	LD	(LEFTX),HL
E7DF                
E7DF CD 71 E8       	CALL	RBX2
E7E2 28 19          	JR	Z,RBRB
E7E4 CD 85 E8       	CALL	RBXA
E7E7 DA 86 E7       	JP	C,RBRERR
E7EA C5             	PUSH	BC
E7EB ED B0          	LDIR
E7ED ED 53 5F EF    	LD	(DTAX),DE
E7F1 2A 5D EF       	LD	HL,(LEFTX)
E7F4 D1             	POP	DE
E7F5 A7             	AND	A
E7F6 ED 52          	SBC	HL,DE
E7F8 22 5D EF       	LD	(LEFTX),HL
E7FB 28 2D          	JR	Z,RBREND
E7FD                
E7FD                RBRB:
E7FD CD BB E8       	CALL	RBXB
E800 28 12          	JR	Z,RBRC
E802                RBRB1:
E802 C5             	PUSH	BC
E803 D5             	PUSH	DE
E804 CD E2 E3       	CALL	CLUSTX
E807 CD EB EB       	CALL	DRD24
E80A D1             	POP	DE
E80B C1             	POP	BC
E80C D4 97 EA       	CALL	NC,GNCLX
E80F DA 86 E7       	JP	C,RBRERR
E812 10 EE          	DJNZ	RBRB1
E814                RBRC:
E814 CD D3 E8       	CALL	RBXC
E817 28 11          	JR	Z,RBREND
E819 C5             	PUSH	BC
E81A CD E2 E3       	CALL	CLUSTX
E81D CD 02 E9       	CALL	DRDX
E820 C1             	POP	BC
E821 DA 86 E7       	JP	C,RBRERR
E824 EB             	EX	DE,HL
E825 2A 7E F0       	LD	HL,(_DTBUF)
E828 ED B0          	LDIR
E82A                RBREND:
E82A CD DF E8       	CALL	RBXEND
E82D                RBREND0:
E82D FD E1          	POP	IY
E82F C1             	POP	BC
E830 D1             	POP	DE
E831 F1             	POP	AF	;(HL)
E832 AF             	XOR	A
E833 3E 00          RBRAP:	LD	A,000H
E835 C9             	RET
E836                
E836                RBRDIR:
E836 FD 6E 1A       	LD	L,(IY+26)	;(FCB)ファイルの先頭クラスタ
E839 FD 66 1B       	LD	H,(IY+27)
E83C CD 22 E4       	CALL	CHDIR
E83F AF             	XOR	A
E840 67             	LD	H,A
E841 6F             	LD	L,A
E842 3C             	INC	A
E843 32 34 E8       	LD	(RBRAP+1),A
E846 18 E5          	JR	RBREND0
E848                
E848                RBX0:
E848 2A 8A EF       	LD	HL,(_DTA)
E84B 22 5F EF       	LD	(DTAX),HL
E84E 2A 5D EF       	LD	HL,(LEFTX)
E851 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
E854 D6 FD          	SUB	0FDH
E856 C9             	RET
E857                
E857                RBX1:
E857 E5             	PUSH	HL		;Record byte
E858                				;AHL=File size
E858 FD 6E 10       	LD	L,(IY+16)	;ファイルのサイズ(バイト単位)
E85B FD 66 11       	LD	H,(IY+17)
E85E FD 7E 12       	LD	A,(IY+18)
E861                
E861 CD F8 E8       	CALL	GET_RR_CDE	;CDE=Random record
E864                
E864 A7             	AND	A
E865 ED 52          	SBC	HL,DE
E867 99             	SBC	A,C
E868 D1             	POP	DE
E869                
E869 D8             	RET	C
E86A 4F             	LD	C,A
E86B EB             	EX	DE,HL	;CDE=File byte	HL=Record byte
E86C B2             	OR	D
E86D B3             	OR	E
E86E C0             	RET	NZ
E86F 37             	SCF
E870 C9             	RET
E871                
E871                RBX2:				;Cluster settings
E871 FD 4E 22       	LD	C,(IY+34)	;(+33)(FCB)ランダムレコード
E874 FD 46 23       	LD	B,(IY+35)
E877 CD D1 E5       	CALL	RWXR
E87A 3A 9D E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E87D 3D             	DEC	A
E87E FD A6 22       	AND	(IY+34)
E881 FD B6 21       	OR	(IY+33)
E884 C9             	RET
E885                
E885                RBXA:
E885 C5             	PUSH	BC
E886 D5             	PUSH	DE
E887 CD E2 E3       	CALL	CLUSTX
E88A CD 02 E9       	CALL	DRDX
E88D D1             	POP	DE
E88E C1             	POP	BC
E88F D8             	RET	C
E890 CD 97 EA       	CALL	GNCLX
E893 D8             	RET	C
E894 ED 53 FE F0    	LD	(_CLPS),DE
E898                
E898 FD 4E 21       	LD	C,(IY+33)	;(FCB)ランダムレコード
E89B 21 00 04       SECSZ:	LD	HL,0400H	;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
E89E 7C             	LD	A,H
E89F 3D             	DEC	A		;1024=3 / 512=1
E8A0 FD A6 22       	AND	(IY+34)		;(FCB)ランダムレコード
E8A3 47             	LD	B,A		;BCに1セクタ以下の端数が入る
E8A4 ED 42          	SBC	HL,BC		;残りを計算
E8A6                
E8A6 ED 5B 5D EF    	LD	DE,(LEFTX)
E8AA ED 52          	SBC	HL,DE		;CP HL,DE
E8AC 19             	ADD	HL,DE		;
E8AD 38 01          	JR	C,RBXA1		;DEとHLを比較して大きい方をHLに
E8AF EB             	EX	DE,HL
E8B0                RBXA1:
E8B0 E5             	PUSH	HL
E8B1 2A 7E F0       	LD	HL,(_DTBUF)
E8B4 09             	ADD	HL,BC
E8B5 ED 5B 5F EF    	LD	DE,(DTAX)
E8B9 C1             	POP	BC
E8BA C9             	RET
E8BB                
E8BB                RBXB:
E8BB 2A 5F EF       	LD	HL,(DTAX)
E8BE ED 5B FE F0    	LD	DE,(_CLPS)
E8C2 3A 5E EF       	LD	A,(LEFTX+1)
E8C5 47             	LD	B,A
E8C6 3A 9D E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8C9                RBXB1:
E8C9 1F             	RRA		;->CF
E8CA 38 04          	JR	C,RBXB2
E8CC CB 38          	SRL	B	;B=B/2
E8CE 18 F9          	JR	RBXB1
E8D0                RBXB2:
E8D0 78             	LD	A,B
E8D1 B7             	OR	A
E8D2 C9             	RET
E8D3                
E8D3                RBXC:
E8D3 ED 4B 5D EF    	LD	BC,(LEFTX)
E8D7 3A 9D E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8DA 3D             	DEC	A
E8DB A0             	AND	B
E8DC 47             	LD	B,A		;1セクタ以下の端数がない場合はZ
E8DD B1             	OR	C
E8DE C9             	RET
E8DF                
E8DF                RBXEND:
E8DF 11 00 00       LEFT:	LD	DE,0
E8E2 AF             	XOR	A
E8E3 FD 6E 21       	LD	L,(IY+33)	;(FCB)ランダムレコード
E8E6 FD 66 22       	LD	H,(IY+34)
E8E9 19             	ADD	HL,DE
E8EA FD 8E 23       	ADC	A,(IY+35)
E8ED FD 75 21       	LD	(IY+33),L	;(FCB)ランダムレコード
E8F0 FD 74 22       	LD	(IY+34),H
E8F3 FD 77 23       	LD	(IY+35),A
E8F6 EB             	EX	DE,HL		;HL=Read byte
E8F7 C9             	RET
E8F8                
E8F8                GET_RR_CDE:			;CDE=Random record
E8F8 FD 5E 21       	LD	E,(IY+33)	;(FCB)ランダムレコード
E8FB FD 56 22       	LD	D,(IY+34)
E8FE FD 4E 23       	LD	C,(IY+35)
E901 C9             	RET
E902                
E902                	INCLUDE	"LDDIO.ASM"
E902                
E902                ;	LSX-Dodgers DIO
E902                
E902                DRDX:
E902 CD 40 E9       	CALL	DRDY
E905 C8             	RET	Z
E906 CD 26 E9       	CALL	DRDX1		;データバッファの情報を保存
E909 D8             	RET	C
E90A E5             	PUSH	HL
E90B C5             	PUSH	BC
E90C D5             	PUSH	DE
E90D 2A 7E F0       	LD	HL,(_DTBUF)
E910 3A 69 E9       	LD	A,(_DBS24+1)
E913 4F             	LD	C,A
E914 CD EB EB       	CALL	DRD24
E917 DC 3B E9       	CALL	C,DRDNE
E91A                POP_DE_BC_HL_RET:
E91A D1             	POP	DE
E91B C1             	POP	BC
E91C E1             	POP	HL
E91D C9             	RET
E91E                
E91E                ;	CDE:セクタ番号
E91E                DRDN:
E91E AF             	XOR	A
E91F 00             DRDN1:	NOP			;自己書き換え NOP / SCF
E920 30 E0          	JR	NC,DRDX
E922                DRDNX:
E922 CD 40 E9       	CALL	DRDY
E925 C8             	RET	Z
E926                DRDX1:
E926 CD 56 E9       	CALL	DWTX
E929                				;データバッファの読み込んだドライブ・セクタ情報を保存
E929 ED 53 A6 EF    	LD	(_DBSEC),DE
E92D 79             	LD	A,C
E92E 32 69 E9       	LD	(_DBS24+1),A
E931                
E931 3A 88 EF       	LD	A,(_DRV)
E934 32 A5 EF       	LD	(_DBDRV),A
E937 CD D9 EF       	CALL	_CHGDRV
E93A D0             	RET	NC
E93B                DRDNE:
E93B 9F             	SBC	A,A		;CF=1ならばA=0FFH
E93C 32 A5 EF       	LD	(_DBDRV),A
E93F C9             	RET
E940                
E940                ;	CDE:セクタ番号
E940                DRDY:
E940 3A 69 E9       	LD	A,(_DBS24+1)
E943 B9             	CP	C
E944 C0             	RET	NZ
E945                
E945 E5             	PUSH	HL
E946 3A 88 EF       	LD	A,(_DRV)
E949 21 A5 EF       	LD	HL,_DBDRV
E94C AE             	XOR	(HL)
E94D 20 05          	JR	NZ,POP_HL_RET
E94F                
E94F 2A A6 EF       	LD	HL,(_DBSEC)
E952 ED 52          	SBC	HL,DE		;CF=0
E954                POP_HL_RET:
E954 E1             	POP	HL
E955 C9             	RET
E956                
E956                DWTX:
E956 3A A4 EF       	LD	A,(_WTDBF)
E959 B7             	OR	A
E95A C8             	RET	Z
E95B AF             	XOR	A
E95C 32 A4 EF       	LD	(_WTDBF),A
E95F                
E95F E5             	PUSH	HL
E960 C5             	PUSH	BC
E961 D5             	PUSH	DE
E962 3A A5 EF       	LD	A,(_DBDRV)
E965 CD D9 EF       	CALL	_CHGDRV
E968 0E 00          _DBS24:	LD	C,0
E96A ED 5B A6 EF    	LD	DE,(_DBSEC)
E96E 2A 7E F0       	LD	HL,(_DTBUF)
E971 D4 FB EB       	CALL	NC,DWT24
E974                POP_DE_BC_HL_RET2:
E974 18 A4          	JR	POP_DE_BC_HL_RET
E976                
E976                RDFATX:
E976 E5             	PUSH	HL
E977 3A 88 EF       	LD	A,(_DRV)
E97A 21 AA EF       	LD	HL,_FATDRV
E97D AE             	XOR	(HL)
E97E 28 D4          	JR	Z,POP_HL_RET
E980                
E980 C5             	PUSH	BC
E981 D5             	PUSH	DE
E982 DD E5          	PUSH	IX
E984 CD A0 E9       	CALL	WTFATX
E987 38 13          	JR	C,POP_IX_DE_BC_HL_RET
E989                
E989 AF             	XOR	A
E98A 32 AB EF       	LD	(_FATIX),A
E98D 3A 88 EF       	LD	A,(_DRV)
E990 32 AA EF       	LD	(_FATDRV),A
E993 CD E5 EF       	CALL	_RDFAT
E996                RDFATE2:
E996 30 04          	JR	NC,POP_IX_DE_BC_HL_RET
E998 9F             	SBC	A,A		;A=0xFF
E999 32 AA EF       	LD	(_FATDRV),A
E99C                POP_IX_DE_BC_HL_RET:
E99C DD E1          	POP	IX
E99E 18 D4          	JR	POP_DE_BC_HL_RET2
E9A0                
E9A0                WTFATX:
E9A0 3A A2 EF       	LD	A,(_WTFATF)
E9A3 B7             	OR	A
E9A4 C8             	RET	Z
E9A5 E5             	PUSH	HL
E9A6 3A AA EF       	LD	A,(_FATDRV)
E9A9 21 A5 EF       	LD	HL,_DBDRV
E9AC AE             	XOR	(HL)
E9AD CC 56 E9       	CALL	Z,DWTX
E9B0 38 A2          	JR	C,POP_HL_RET
E9B2 C5             	PUSH	BC
E9B3 D5             	PUSH	DE
E9B4 DD E5          	PUSH	IX
E9B6 CD 08 EC       	CALL	WTFAT
E9B9 AF             	XOR	A
E9BA 32 A2 EF       	LD	(_WTFATF),A
E9BD 18 DD          	JR	POP_IX_DE_BC_HL_RET
E9BF                
E9BF                NCL1:
E9BF 7A             	LD	A,D
E9C0 B3             	OR	E
E9C1 37             	SCF
E9C2 C8             	RET	Z
E9C3                
E9C3 7A             	LD	A,D
E9C4 CB 3F          	SRL	A	;/2
E9C6 CB 3F          	SRL	A	;/2
E9C8                
E9C8 E5             	PUSH	HL
E9C9 32 E8 E9       	LD	(NCLPAT+2),A	;_FATIX
E9CC 2A AA EF       	LD	HL,(_FATDRV)	;L=_FATDRV H=_FATIX
E9CF BC             	CP	H
E9D0 3A 88 EF       	LD	A,(_DRV)	;この間でフラグは変化しない
E9D3 32 E7 E9       	LD	(NCLPAT+1),A	;_FATDRV
E9D6 20 05          	JR	NZ,NCL2		;FATIXが違う
E9D8 BD             	CP	L
E9D9 20 02          	JR	NZ,NCL2		;ドライブが違う
E9DB E1             	POP	HL
E9DC C9             	RET
E9DD                NCL2:
E9DD C5             	PUSH	BC
E9DE D5             	PUSH	DE
E9DF DD E5          	PUSH	IX
E9E1 CD A0 E9       	CALL	WTFATX
E9E4 38 B6          	JR	C,POP_IX_DE_BC_HL_RET
E9E6 01 00 00       NCLPAT:	LD	BC,0		;自己書き換え C=_FATDRV B=_FATIX
E9E9 ED 43 AA EF    	LD	(_FATDRV),BC
E9ED CD DD EB       	CALL	RDFATS
E9F0 18 A4          	JR	RDFATE2
E9F2                
E9F2                NCL3:
E9F2 CB 9A          	RES	3,D
E9F4 CB 92          	RES	2,D
E9F6 6B             	LD	L,E
E9F7 62             	LD	H,D
E9F8 CB 3C          	SRL	H	;
E9FA CB 1D          	RR	L	;HLA=HLA/2
E9FC 1F             	RRA		;
E9FD F5             	PUSH	AF
E9FE 3A AB EF       	LD	A,(_FATIX)
EA01 0F             	RRCA
EA02 30 0B          	JR	NC,NCL3X1
EA04 3A 9D E8       	LD	A,(SECSZ+2)
EA07 FE 04          	CP	4		;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
EA09 20 04          	JR	NZ,NCL3X1
EA0B 01 00 02       	LD	BC,512
EA0E 09             	ADD	HL,BC
EA0F                NCL3X1:
EA0F F1             	POP	AF
EA10 ED 4B 7C F0    	LD	BC,(_FATBF)
EA14 19             	ADD	HL,DE
EA15 09             	ADD	HL,BC
EA16 17             	RLA
EA17 C9             	RET
EA18                
EA18                GNCL:
EA18 CD BF E9       	CALL	NCL1		;GET NEXT CLUSTER
EA1B D8             	RET	C
EA1C C5             	PUSH	BC
EA1D E5             	PUSH	HL
EA1E CD F2 E9       	CALL	NCL3
EA21 38 09          	JR	C,GNC1
EA23 5E             	LD	E,(HL)
EA24 23             	INC	HL
EA25 7E             	LD	A,(HL)
EA26 E6 0F          	AND	00FH
EA28 57             	LD	D,A
EA29 E1             	POP	HL
EA2A C1             	POP	BC
EA2B C9             	RET
EA2C                GNC1:
EA2C 7E             	LD	A,(HL)
EA2D 23             	INC	HL
EA2E 56             	LD	D,(HL)
EA2F 06 04          	LD	B,4
EA31                GNC1L:
EA31 CB 3A          	SRL	D	;DA=DA/2
EA33 1F             	RRA		;
EA34 10 FB          	DJNZ	GNC1L
EA36                
EA36 5F             	LD	E,A
EA37 E1             	POP	HL
EA38 C1             	POP	BC
EA39 A7             	AND	A
EA3A C9             	RET
EA3B                
EA3B                SNCL:
EA3B CD BF E9       	CALL	NCL1
EA3E D8             	RET	C
EA3F                ;				SET NEXT CLUSTER
EA3F E5             	PUSH	HL
EA40 C5             	PUSH	BC
EA41 D5             	PUSH	DE
EA42 E5             	PUSH	HL
EA43 CD F2 E9       	CALL	NCL3
EA46 D1             	POP	DE
EA47                ;CF=ODD
EA47 7E             	LD	A,(HL)
EA48 73             	LD	(HL),E
EA49 38 06          	JR	C,SNC1
EA4B                ;EVEN
EA4B                ;M[0] = E
EA4B                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
EA4B 23             	INC	HL
EA4C ED 67          	RRD		;M={A[3:0],E[3:0]}
EA4E 7A             	LD	A,D
EA4F 18 04          	JR	SNC11
EA51                SNC1:
EA51                ;ODD
EA51                ;HL[0] = (HL[0]&0x0F) | (E<<4)
EA51                ;HL[1] = DE>>4
EA51 ED 6F          	RLD		;M={D[3:0],E[7:4]}
EA53 23             	INC	HL
EA54 72             	LD	(HL),D	;M={D[3:0],E[7:4]}
EA55                SNC11:
EA55 ED 6F          	RLD		;M={M[7:4],D[3:0]}
EA57 B7             	OR	A
EA58 D1             	POP	DE
EA59 C1             	POP	BC
EA5A E1             	POP	HL
EA5B                FAT_CHANGED:
EA5B 3E 01          	LD	A,1
EA5D 32 A2 EF       	LD	(_WTFATF),A
EA60 C9             	RET
EA61                
EA61                N16CL3:
EA61 C5             	PUSH	BC
EA62 6B             	LD	L,E
EA63 7A             	LD	A,D
EA64 E6 03          	AND	3
EA66 67             	LD	H,A
EA67 29             	ADD	HL,HL
EA68 ED 4B 7C F0    	LD	BC,(_FATBF)
EA6C 09             	ADD	HL,BC
EA6D C1             	POP	BC
EA6E C9             	RET
EA6F                
EA6F                GNCL16:
EA6F CD BF E9       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EA72 D8             	RET	C
EA73 E5             	PUSH	HL
EA74 CD 61 EA       	CALL	N16CL3
EA77 5E             	LD	E,(HL)
EA78 23             	INC	HL
EA79 56             	LD	D,(HL)
EA7A E1             	POP	HL
EA7B C9             	RET
EA7C                
EA7C                SNCL16:
EA7C CD BF E9       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EA7F D8             	RET	C
EA80 D5             	PUSH	DE
EA81 E5             	PUSH	HL
EA82 CD 61 EA       	CALL	N16CL3
EA85 D1             	POP	DE		;HL
EA86 73             	LD	(HL),E
EA87 23             	INC	HL
EA88 72             	LD	(HL),D
EA89 6B             	LD	L,E
EA8A 62             	LD	H,D
EA8B D1             	POP	DE
EA8C 18 CD          	JR	FAT_CHANGED
EA8E                
EA8E                ;------------------------
EA8E                ;次のセクタを探す際に_SECPSの値をチェック
EA8E                ;in
EA8E                ;	DE : セクタ番号
EA8E                ;out
EA8E                ;	DE : 次のセクタ番号
EA8E                ;note
EA8E                ;
EA8E                ;------------------------
EA8E                NEXTX:
EA8E 3E 00          _SECPS:	LD	A,0	;自己書き換え
EA90 3C             	INC	A
EA91 E6 00          NCPAT:	AND	0	;自己書き換え　1クラスタの論理セクタ数-1
EA93 32 8F EA       	LD	(_SECPS+1),A
EA96 C9             	RET
EA97                
EA97                GNCLX:
EA97 CD 8E EA       	CALL	NEXTX
EA9A C0             	RET	NZ	;1クラスタのセクタ未満の場合は戻る
EA9B C3 F7 EF       	JP	_GNCL	;次のクラスタを探す
EA9E                
EA9E                RDFAT:
EA9E 3E 80          	LD	A,080H
EAA0 32 70 EF       	LD	(CHECK),A
EAA3                RDFAT1:
EAA3 3A 88 EF       	LD	A,(_DRV)
EAA6 CD 3B ED       	CALL	CHGDRVR
EAA9 D8             	RET	C
EAAA DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EAAD CB 6F          	BIT	5,A
EAAF 28 43          	JR	Z,RDFAT0X
EAB1 21 70 EF       	LD	HL,CHECK
EAB4 A6             	AND	(HL)
EAB5 77             	LD	(HL),A
EAB6 11 00 00       	LD	DE,0		;BPB
EAB9 2A 7C F0       	LD	HL,(_FATBF)
EABC CD E9 EB       	CALL	DRD16
EABF 30 24          	JR	NC,GETBPB
EAC1 21 70 EF       	LD	HL,CHECK
EAC4 CB 06          	RLC	(HL)
EAC6 3F             	CCF
EAC7 D8             	RET	C
EAC8 DD CB 0A 1E    	RR	(IX+00AH)	;DPB_0A_FDMODE
EACC 3F             	CCF			;フロッピーディスクのMFMモードを切り替える
EACD DD CB 0A 16    	RL	(IX+00AH)	;DPB_0A_FDMODE
EAD1 3E FF          	LD	A,0FFH
EAD3 32 89 EF       	LD	(_DSK),A
EAD6 3A 84 EF       	LD	A,(_DRIVE)
EAD9 E6 03          	AND	3
EADB F6 80          	OR	080H
EADD 6F             	LD	L,A
EADE 26 EF          	LD	H,_CYL0/256
EAE0 3E FF          	LD	A,0FFH
EAE2 77             	LD	(HL),A
EAE3 18 BE          	JR	RDFAT1
EAE5                GETBPB:
EAE5 FD E5          	PUSH	IY
EAE7 FD 2A 7C F0    	LD	IY,(_FATBF)	;BPB
EAEB CD F1 EF       	CALL	_BPB2DPB
EAEE FD E1          	POP	IY
EAF0 D8             	RET	C
EAF1 CD 91 EC       	CALL	CHGDRV2
EAF4                RDFAT0X:
EAF4 CD DD EB       	CALL	RDFATS
EAF7 D8             	RET	C
EAF8 DD BE 06       	CP	(IX+6)		;DPB_06_FATID
EAFB C8             	RET	Z
EAFC DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
EB00 C0             	RET	NZ		;BPBを取得している場合はFATIDをチェックしない
EB01 37             	SCF
EB02 C9             	RET
EB03                
EB03                BPB2DPB:
EB03 FD 7E 00       	LD	A,(IY+0)	;BS_JmpBoot
EB06 FE EB          	CP	0EBH		;Short jump
EB08 28 08          	JR	Z,BPBOK
EB0A FE E9          	CP	0E9H		;Near jump
EB0C 28 04          	JR	Z,BPBOK
EB0E FE 60          	CP	060H		;X68k
EB10 37             	SCF
EB11 C0             	RET	NZ
EB12                BPBOK:
EB12 FD 7E 0D       	LD	A,(IY+13)	;BPB_SecPerClus
EB15 DD 77 07       	LD	(IX+7),A	;DPB_07_SECPCL
EB18                
EB18 FD 7E 16       	LD	A,(IY+22)	;BPB_FATSz16
EB1B DD 77 00       	LD	(IX+0),A	;DPB_00_FATLN
EB1E FD 7E 17       	LD	A,(IY+23)	;BPB_FATSz16
EB21 DD 77 01       	LD	(IX+1),A	;DPB_00_FATLN
EB24                
EB24 FD 6E 0E       	LD	L,(IY+14)	;BPB_RsvdSecCnt
EB27 FD 66 0F       	LD	H,(IY+15)
EB2A DD 75 0E       	LD	(IX+00EH),L	;DPB_0E_FATPS
EB2D FD 5E 16       	LD	E,(IY+22)	;BPB_FATSz16
EB30 FD 56 17       	LD	D,(IY+23)
EB33 FD 46 10       	LD	B,(IY+16)	;BPB_NumFATs
EB36                BPBDP1:				;BPB_FATSz16 * BPB_NumFATs
EB36 19             	ADD	HL,DE
EB37 10 FD          	DJNZ	BPBDP1
EB39                BPBDP2:
EB39 DD 75 10       	LD	(IX+010H),L	;DPB_10_DIRPS
EB3C DD 74 11       	LD	(IX+011H),H
EB3F E5             	PUSH	HL
EB40                
EB40 FD 6E 11       	LD	L,(IY+17)	;BPB_RootEntCnt
EB43 FD 66 12       	LD	H,(IY+18)
EB46 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EB49 06 06          	LD	B,6
EB4B                BPBBPS1:
EB4B 05             	DEC	B
EB4C 0F             	RRCA
EB4D 30 FC          	JR	NC,BPBBPS1
EB4F                BPBDE1:
EB4F 29             	ADD	HL,HL
EB50 10 FD          	DJNZ	BPBDE1
EB52                
EB52 7C             	LD	A,H
EB53 DD 77 0B       	LD	(IX+00BH),A	;DPB_0B_DIRSCNT
EB56                
EB56 D1             	POP	DE		;DPB_10_DIRPS
EB57 6C             	LD	L,H
EB58 26 00          	LD	H,0
EB5A 19             	ADD	HL,DE		;MAXDIR
EB5B E5             	PUSH	HL
EB5C FD 4E 0D       	LD	C,(IY+13)	;BPB_SecPerClus
EB5F CB 21          	SLA	C		;*2
EB61 AF             	XOR	A
EB62 47             	LD	B,A
EB63 ED 42          	SBC	HL,BC
EB65 DD 75 14       	LD	(IX+014H),L	;DPB_14_ADDCL16
EB68 DD 74 15       	LD	(IX+015H),H
EB6B                
EB6B D1             	POP	DE		;DE=DPB_0B_MAXDIR
EB6C FD 6E 13       	LD	L,(IY+19)	;BPB_TotSec16
EB6F FD 66 14       	LD	H,(IY+20)
EB72 7C             	LD	A,H
EB73 B5             	OR	L
EB74 3E 00          	LD	A,0		;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
EB76 20 10          	JR	NZ,BPB16BIT	;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
EB78 FD 7E 23       	LD	A,(IY+35)	;念のために総セクタ数が24ビットを超える場合はエラーを返す
EB7B B7             	OR	A
EB7C 37             	SCF
EB7D C0             	RET	NZ
EB7E FD 6E 20       	LD	L,(IY+32)	;BPB_TotSec32 は AHL の24ビットで扱う
EB81 FD 66 21       	LD	H,(IY+33)	;1クラスタの論理セクタ数(DPB_07_SECPCL)が最大128なので
EB84 FD 7E 22       	LD	A,(IY+34)	;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
EB87 A7             	AND	A		;CF=0
EB88                BPB16BIT:
EB88 ED 52          	SBC	HL,DE
EB8A DE 00          	SBC	A,0
EB8C FD 46 0D       	LD	B,(IY+13)	;BPB_SecPerClus
EB8F                BPBTC1:				;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
EB8F CB 18          	RR	B		;->CY
EB91 38 08          	JR	C,BPBTC2
EB93 CB 3F          	SRL	A
EB95 CB 1C          	RR	H		;AHL=AHL/2
EB97 CB 1D          	RR	L
EB99 18 F4          	JR	BPBTC1
EB9B                BPBTC2:
EB9B B7             	OR	A
EB9C 37             	SCF
EB9D C0             	RET	NZ		;念のため(クラスタ数が16ビットを超える場合)
EB9E 23             	INC	HL
EB9F 23             	INC	HL
EBA0 DD 75 08       	LD	(IX+8),L	;DPB_08_MAXCL
EBA3 DD 74 09       	LD	(IX+9),H
EBA6                
EBA6 FD 7E 15       	LD	A,(IY+21)	;BPB_Media
EBA9 DD 77 06       	LD	(IX+6),A	;DPB_06_FATID
EBAC                
EBAC DD CB 0A 7E    	BIT	7,(IX+00AH)	;DPB_0A_FDMODE
EBB0 28 17          	JR	Z,NOT_FD
EBB2 2E 28          	LD	L,40		;MAXCYLの設定（要検討）ここから下はフロッピーのみ書き換える
EBB4 FE FD          	CP	0FDH	;2D
EBB6 28 08          	JR	Z,SETCYL
EBB8 2E 4D          	LD	L,77
EBBA FE FE          	CP	0FEH	;2HD
EBBC 28 02          	JR	Z,SETCYL
EBBE 2E 50          	LD	L,80	;その他2DD等
EBC0                SETCYL:
EBC0 DD 75 0C       	LD	(IX+00CH),L	;DPB_0C_MAXCYL
EBC3 FD 7E 18       	LD	A,(IY+24)	;BPB_SecPerTr
EBC6 DD 77 0D       	LD	(IX+00DH),A	;DPB_0D_MAXSEC	;ここまでフロッピー専用
EBC9                NOT_FD:
EBC9 FD 7E 10       	LD	A,(IY+16)	;BPB_NumFATs
EBCC FE 02          	CP	2		;>2:NC
EBCE FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EBD1 38 02          	JR	C,BPBFAT1
EBD3 F6 80          	OR	080H
EBD5                BPBFAT1:
EBD5 DD 77 0F       	LD	(IX+00FH),A	;DPB_0F_BPS
EBD8                
EBD8 E6 7F          	AND	07FH		;セクタバッファが1KBしかないので1KBを超える場合はCF=1でエラーにする
EBDA C6 FB          	ADD	A,0-5		;0-4:CF=0 5以上:CF=1
EBDC C9             	RET
EBDD                
EBDD                RDFATS:
EBDD CD 23 EC       	CALL	FATSETUP
EBE0 D8             	RET	C
EBE1 CD ED EB       	CALL	DRD24B
EBE4 2A 7C F0       	LD	HL,(_FATBF)
EBE7 7E             	LD	A,(HL)
EBE8 C9             	RET
EBE9                
EBE9                DRD16:
EBE9 0E 00          	LD	C,0
EBEB                DRD24:
EBEB 06 01          	LD	B,1
EBED                DRD24B:
EBED DD E5          	PUSH	IX
EBEF DD 2A A8 EF    	LD	IX,(_DPB)
EBF3 CD 5B EE       DRDPAT:	CALL	FDRD		;自己書き換え（ディスク読み込み）
EBF6                POP_IX_RET:
EBF6 DD E1          	POP	IX
EBF8 C9             	RET
EBF9                
EBF9                DWT16:
EBF9 0E 00          	LD	C,0
EBFB                DWT24:
EBFB 06 01          	LD	B,1
EBFD                DWT24B:
EBFD DD E5          	PUSH	IX
EBFF DD 2A A8 EF    	LD	IX,(_DPB)
EC03 CD 4D EE       DWTPAT:	CALL	FDWT		;自己書き換え（ディスク書き込み）
EC06 18 EE          	JR	POP_IX_RET
EC08                
EC08                WTFAT:
EC08 CD 23 EC       	CALL	FATSETUP
EC0B D4 FD EB       	CALL	NC,DWT24B
EC0E D8             	RET	C
EC0F DD CB 0F 7E    	BIT	7,(IX+00FH)	;DPB_0F_BPS
EC13 C8             	RET	Z		;予備FATが無い
EC14 CD 2A EC       	CALL	FATS2
EC17 E5             	PUSH	HL		;予備FAT
EC18 DD 6E 00       	LD	L,(IX+0)	;DPB_00_FATLN
EC1B DD 66 01       	LD	H,(IX+1)
EC1E 19             	ADD	HL,DE
EC1F EB             	EX	DE,HL
EC20 E1             	POP	HL
EC21 18 DA          	JR	DWT24B
EC23                ;------------------------
EC23                ;FATのセットアップ
EC23                ;out
EC23                ;	B  : FATセクタ数
EC23                ;	DE : FAT先頭セクタ番号
EC23                ;	HL : FATバッファポインタ
EC23                ;	CF : 1=ドライブ切り替えエラー
EC23                ;note
EC23                ;	FATサイズがFATバッファを超える場合は
EC23                ;	対象クラスタ領域==(_FATIX)によって
EC23                ;	FAT12:対象クラスタ1024毎に1.5KBを切り替える
EC23                ;	FAT16:対象クラスタ1024毎に2KBを切り替える
EC23                ;------------------------
EC23                FATSETUP:
EC23 3A AA EF       	LD	A,(_FATDRV)
EC26 CD 3B ED       	CALL	CHGDRVR		;ドライブ切り替え
EC29 D8             	RET	C
EC2A                FATS2:
EC2A DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS 512=2 1024=4
EC2D 0F             	RRCA
EC2E CD 57 EC       FATSX:	CALL	FATSETUP12	;自己書き換え
EC31 21 00 00       	LD	HL,0
EC34 4A             	LD	C,D
EC35 54             	LD	D,H
EC36 3A AB EF       	LD	A,(_FATIX)	;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
EC39 47             	LD	B,A
EC3A 04             	INC	B
EC3B DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
EC3E                FAT_SKP:
EC3E 05             	DEC	B
EC3F 28 05          	JR	Z,FAT1
EC41 19             	ADD	HL,DE
EC42 93             	SUB	E
EC43 30 F9          	JR	NC,FAT_SKP
EC45 C9             	RET
EC46                FAT1:
EC46 EB             	EX	DE,HL
EC47 B9             	CP	C		;C=FATバッファに読み込めるセクタ数
EC48 38 01          	JR	C,FAT2
EC4A 79             	LD	A,C
EC4B                FAT2:
EC4B 47             	LD	B,A
EC4C                
EC4C 2A FA F0       	LD	HL,(_FATPS)	;fat sector pos
EC4F 19             	ADD	HL,DE
EC50 EB             	EX	DE,HL
EC51 2A 7C F0       	LD	HL,(_FATBF)
EC54 AF             	XOR	A		;CF=0
EC55 4F             	LD	C,A
EC56 C9             	RET
EC57                ;
EC57                ;	FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
EC57                ;	FATSETUP* (FAT12/FAT16)
EC57                ;out
EC57                ;	D : FATバッファに読み込める最大のセクタ数
EC57                ;	E : _FATIXで進めるセクタ数
EC57                FATSETUP12:
EC57 11 06 06       	LD	DE,0606H	;256
EC5A D8             	RET	C
EC5B 11 03 03       	LD	DE,0303H	;512
EC5E 0F             	RRCA
EC5F D8             	RET	C
EC60 11 01 02       	LD	DE,0201H	;1024
EC63 C9             	RET
EC64                
EC64                FATSETUP16:
EC64 11 08 08       	LD	DE,0808H	;256
EC67 D8             	RET	C
EC68 11 04 04       	LD	DE,0404H
EC6B 0F             	RRCA			;512
EC6C D8             	RET	C
EC6D 11 02 02       	LD	DE,0202H	;1024
EC70 C9             	RET
EC71                
EC71                CHGDRV:
EC71 E5             	PUSH	HL
EC72 21 89 EF       	LD	HL,_DSK
EC75 BE             	CP	(HL)
EC76 28 0A          	JR	Z,CHGDRVE
EC78                CHGDRV1:
EC78 DD E5          	PUSH	IX
EC7A CD 84 EC       	CALL	CHGDRV0
EC7D 3A 89 EF       	LD	A,(_DSK)
EC80 DD E1          	POP	IX
EC82                CHGDRVE:
EC82 E1             	POP	HL
EC83 C9             	RET
EC84                
EC84                CHGDRV0:
EC84 6F             	LD	L,A
EC85 CD DC EF       	CALL	_GETDPB
EC88 D8             	RET	C
EC89 DD 22 A8 EF    	LD	(_DPB),IX
EC8D 7D             	LD	A,L
EC8E 32 89 EF       	LD	(_DSK),A
EC91                CHGDRV2:
EC91 C5             	PUSH	BC
EC92 D5             	PUSH	DE
EC93 ED 73 F0 EC    	LD	(SPPAT2+1),SP
EC97 F3             	DI
EC98 DD F9          	LD	SP,IX
EC9A                
EC9A E1             	POP	HL		;DPB_00_FATLN
EC9B E1             	POP	HL		;DPB_02_DRD
EC9C 22 F4 EB       	LD	(DRDPAT+1),HL
EC9F                
EC9F E1             	POP	HL
ECA0 22 04 EC       	LD	(DWTPAT+1),HL	;DPB_04_DWT
ECA3                
ECA3 E1             	POP	HL		;L=DPB_06_FATID H=DPB_07_SECPCL
ECA4 7C             	LD	A,H
ECA5 32 E6 E3       	LD	(SPCPAT+1),A	;1クラスタの論理セクタ数
ECA8 3D             	DEC	A
ECA9 32 92 EA       	LD	(NCPAT+1),A
ECAC                
ECAC E1             	POP	HL		;DPB_08_MAXCL
ECAD 7D             	LD	A,L
ECAE 32 05 E4       	LD	(CLPAT2+1),A
ECB1 7C             	LD	A,H
ECB2 32 01 E4       	LD	(CLPAT1+1),A
ECB5 2B             	DEC	HL
ECB6 22 FF E5       	LD	(MAXCLP+1),HL
ECB9                
ECB9 E1             	POP	HL		;L=DPB_0A_FDMODE H=DPB_0B_DIRSCNT
ECBA 7D             	LD	A,L
ECBB F6 FE          	OR	0FEH
ECBD 32 F6 ED       	LD	(FDMODE+1),A
ECC0 07             	RLCA
ECC1 E6 03          	AND	3
ECC3 32 DE ED       	LD	(FSPAT+1),A
ECC6 4C             	LD	C,H
ECC7                
ECC7 E1             	POP	HL		;L=DPB_0C_MAXCYL H=DPB_0D_MAXSEC
ECC8 7D             	LD	A,L
ECC9 32 A1 EF       	LD	(_MAXCYL),A
ECCC 7C             	LD	A,H
ECCD 32 87 ED       	LD	(MAXSEC+1),A
ECD0                
ECD0 E1             	POP	HL		;L=DPB_0E_FATPS H=DPB_0F_BPS
ECD1 7C             	LD	A,H		;DPB_0F_BPS
ECD2 E6 07          	AND	7
ECD4 32 9D E8       	LD	(SECSZ+2),A	;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
ECD7                				;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM等
ECD7                				;1セクタ1024 2HD/2HDE98
ECD7                				;1セクタ256 GRAM等
ECD7                				;1024	512	256
ECD7                				;4	2	1
ECD7 87             	ADD	A,A		;8	4	2
ECD8 87             	ADD	A,A		;010H	8	4
ECD9 87             	ADD	A,A		;020H	010H	8
ECDA 32 62 E2       	LD	(SDECPAT+1),A	;1セクタ辺りのディレクトリエントリ数
ECDD                
ECDD 26 00          	LD	H,0
ECDF 22 FA F0       	LD	(_FATPS),HL
ECE2                
ECE2 E1             	POP	HL		;L=DPB_10_DIRPS
ECE3 22 FC F0       	LD	(_DIRPS),HL
ECE6                
ECE6 E1             	POP	HL		;L=DPB_12_DEVICE H=DPB_13_UNITNO
ECE7 7C             	LD	A,H
ECE8 32 84 EF       	LD	(_DRIVE),A
ECEB                
ECEB E1             	POP	HL		;DPB_14_ADDCL16
ECEC 22 F6 E3       	LD	(CLSPAT+1),HL
ECEF                
ECEF 31 00 00       SPPAT2:	LD	SP,0		;元のSPを復元
ECF2 FB             	EI
ECF3 2A FC F0       	LD	HL,(_DIRPS)
ECF6 06 00          	LD	B,0
ECF8 09             	ADD	HL,BC
ECF9 22 7D E2       	LD	(MD_PAT+1),HL
ECFC                
ECFC 2A FF E5       	LD	HL,(MAXCLP+1);
ECFF 11 F6 0F       	LD	DE,4086
ED02 B7             	OR	A
ED03 ED 52          	SBC	HL,DE
ED05 30 0F          	JR	NC,SETFAT16
ED07 21 18 EA       	LD	HL,GNCL		;FAT12
ED0A 11 3B EA       	LD	DE,SNCL
ED0D 01 57 EC       	LD	BC,FATSETUP12
ED10 DD CB 0F AE    	RES	5,(IX+00FH)	;DPB_0F_BPS(FAT12)
ED14 18 0D          	JR	EXTRA1
ED16                SETFAT16:
ED16 21 6F EA       	LD	HL,GNCL16	;FAT16
ED19 11 7C EA       	LD	DE,SNCL16
ED1C 01 64 EC       	LD	BC,FATSETUP16
ED1F DD CB 0F EE    	SET	5,(IX+00FH)	;DPB_0F_BPS(FAT16)
ED23                EXTRA1:
ED23 22 F8 EF       	LD	(GNCPAT+1),HL
ED26 ED 53 FB EF    	LD	(SNCPAT+1),DE
ED2A ED 43 2F EC    	LD	(FATSX+1),BC
ED2E D1             	POP	DE
ED2F C1             	POP	BC
ED30 AF             	XOR	A
ED31 C9             	RET
ED32                
ED32                GETDPBD:
ED32 DD E3          	EX	(SP),IX
ED34 DD E5          	PUSH	IX
ED36 3A 88 EF       	LD	A,(_DRV)
ED39 18 07          	JR	GETDPB1
ED3B                
ED3B                CHGDRVR:
ED3B CD D9 EF       	CALL	_CHGDRV
ED3E D8             	RET	C
ED3F 3A 89 EF       	LD	A,(_DSK)
ED42                GETDPB1:
ED42 C3 DC EF       	JP	_GETDPB
ED45                
ED45                GETDPB:
ED45 FE 08          	CP	8
ED47 3F             	CCF
ED48 D8             	RET	C
ED49 0F             	RRCA
ED4A 0F             	RRCA
ED4B 0F             	RRCA
ED4C DD             	DB	0DDH		;Z80未定義命令
ED4D 6F             	LD	L,A		;LD	IXL,A
ED4E DD             	DB	0DDH		;Z80未定義命令
ED4F 26 F1          	LD	H,DEVICE/256	;LD	IXH,DEVICE/256
ED51 DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
ED54 B7             	OR	A		;CF=0の為
ED55 DD CB 0F 6E    	BIT	5,(IX+00FH)	;DPB_0F_BPS
ED59 C0             	RET	NZ		;FAT16
ED5A DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
ED5E C0             	RET	NZ		;BPB
ED5F FE 01          	CP	001H		;A=0 THEN CF=1
ED61 C9             	RET
ED62                
ED62                _SYS5F:
ED62 AF             	XOR	A
ED63                FFLUSH:
ED63 F5             	PUSH	AF
ED64 3E FF          	LD	A,0FFH
ED66 32 39 EF       	LD	(SFILE),A
ED69 CD 56 E9       	CALL	DWTX
ED6C 3E FF          	LD	A,0FFH
ED6E 32 A5 EF       	LD	(_DBDRV),A
ED71 CD A0 E9       	CALL	WTFATX
ED74 AF             	XOR	A
ED75 32 AB EF       	LD	(_FATIX),A
ED78 2F             	CPL
ED79 32 AA EF       	LD	(_FATDRV),A
ED7C F1             	POP	AF
ED7D C9             	RET
ED7E                
ED7E                	INCLUDE	"LDDISK.ASM"
ED7E                
ED7E                ;	LSX-Dodgers DISK
ED7E                
ED7E                
ED7E                SEEK:
ED7E 7A             	LD	A,D
ED7F B3             	OR	E
ED80 3E 01          	LD	A,001H
ED82 28 11          	JR	Z,DIV3
ED84                
ED84 06 10          	LD	B,16
ED86 0E 00          MAXSEC:	LD	C,000H
ED88 AF             	XOR	A
ED89 EB             	EX	DE,HL
ED8A                DIV1:
ED8A 29             	ADD	HL,HL
ED8B 8F             	ADC	A,A
ED8C B9             	CP	C
ED8D 38 02          	JR	C,DIV2
ED8F 91             	SUB	C
ED90 2C             	INC	L
ED91                DIV2:
ED91 10 F7          	DJNZ	DIV1
ED93                
ED93 3C             	INC	A	;最小のセクタは１固定
ED94 55             	LD	D,L	;Quotient(TRACK)
ED95                DIV3:
ED95 5F             	LD	E,A	;Remainder
ED96 CB 3A          	SRL	D	;CYLINDER
ED98 9F             	SBC	A,A
ED99 E6 10          	AND	010H	;SIDE
ED9B 4F             	LD	C,A
ED9C                
ED9C 3A 84 EF       	LD	A,(_DRIVE)
ED9F FE 04          	CP	4
EDA1 3F             	CCF
EDA2 D8             	RET	C
EDA3 B1             	OR	C
EDA4 32 22 EE       	LD	(MOPAT+1),A	;Motor off data
EDA7 01 FC 0F       	LD	BC,00FFCH
EDAA F6 80          	OR	080H		;Mortor on
EDAC ED 79          	OUT	(C),A
EDAE                
EDAE CD F4 ED       	CALL	SETMODE
EDB1 D8             	RET	C
EDB2                
EDB2 CD 37 EE       	CALL	DRIVE
EDB5 FE FF          	CP	0FFH		;A=0FFH Unknown CYLINDER
EDB7 CC 16 EE       	CALL	Z,FDCRES	;Restore
EDBA 0E F9          	LD	C,0F9H
EDBC ED 79          	OUT	(C),A		;Currrent CYLINDER
EDBE 92             	SUB	D
EDBF C8             	RET	Z		;No seek
EDC0                
EDC0 3A 86 EF       	LD	A,(_ISEEK)
EDC3 4F             	LD	C,A
EDC4                
EDC4 3A A1 EF       	LD	A,(_MAXCYL)	;Max CYLINDER
EDC7 3D             	DEC	A
EDC8 BA             	CP	D		;Over CYLINDER
EDC9 D8             	RET	C
EDCA                
EDCA B9             	CP	C		;for Built-in 2DD
EDCB 38 03          	JR	C,SETM2
EDCD 78             	LD	A,B		;B=00FH
EDCE DB FE          	IN	A,(0FEH)		;2HD mode for 2DD seek
EDD0                SETM2:
EDD0 78             	LD	A,B
EDD1 DB FD          	IN	A,(0FDH)		;MFM mode
EDD3                
EDD3 0E FB          	LD	C,0FBH
EDD5 ED 51          	OUT	(C),D
EDD7 72             	LD	(HL),D
EDD8 0E 18          	LD	C,018H		;Seek
EDDA                FDCCMD2:
EDDA 3A 85 EF       	LD	A,(_SEEKSP)
EDDD E6 FF          FSPAT:	AND	0FFH
EDDF B1             	OR	C
EDE0                
EDE0                FDCCMD:
EDE0 CD 2D EE       	CALL	COMSET
EDE3                
EDE3 3E 80          FDCPAT:	LD	A,080H		;FDC COMMAND(Self-rewriting)
EDE5 E6 20          	AND	020H		;Write data Write track
EDE7 3C             	INC	A
EDE8                
EDE8                SST:
EDE8 0E 00          	LD	C,0
EDEA                SST1:
EDEA 0D             	DEC	C		; 4
EDEB 20 FD          	JR	NZ,SST1		;12 * 256 / 4 = About 1ms
EDED 3D             	DEC	A
EDEE 20 FA          	JR	NZ,SST1
EDF0                
EDF0 3C             	INC	A		;A=1
EDF1 CD FF ED       	CALL	READY
EDF4                SETMODE:
EDF4 78             	LD	A,B		;B=00FH
EDF5 DB FF          FDMODE:	IN	A,(0FFH)		;Floppy mode(2D/2HD) (Self-rewriting)
EDF7                
EDF7 78             	LD	A,B
EDF8 DB FD          	IN	A,(0FDH)		;MFM mode
EDFA                
EDFA CD 31 EE       	CALL	DELAY0		;Head select time
EDFD 3E 81          	LD	A,081H
EDFF                READY:
EDFF 32 09 EE       	LD	(WAITA+1),A
EE02 E5             	PUSH	HL
EE03 0E F8          	LD	C,0F8H
EE05 61             	LD	H,C
EE06                READY2:
EE06 ED 78          	IN	A,(C)
EE08 E6 81          WAITA:	AND	081H		;NOT READY,BUSY
EE0A 28 08          	JR	Z,READYE
EE0C E3             	EX	(SP),HL		;wait 19clock
EE0D E3             	EX	(SP),HL		; //
EE0E 2B             	DEC	HL
EE0F 7C             	LD	A,H
EE10 B5             	OR	L
EE11 20 F3          	JR	NZ,READY2
EE13 37             	SCF
EE14                READYE:
EE14 E1             	POP	HL
EE15 C9             	RET
EE16                
EE16                FDCRES:
EE16 36 00          	LD	(HL),0
EE18 0E 08          	LD	C,8
EE1A 18 BE          	JR	FDCCMD2
EE1C                
EE1C                FDMOFF:
EE1C F5             	PUSH	AF
EE1D C5             	PUSH	BC
EE1E 01 FC 0F       	LD	BC,00FFCH	;Motor off
EE21 3E 00          MOPAT:	LD	A,000H		;(Self-rewriting)
EE23 ED 79          	OUT	(C),A
EE25 C1             	POP	BC
EE26 F1             	POP	AF
EE27 C9             	RET
EE28                
EE28                SECSET:
EE28 01 FA 0F       	LD	BC,00FFAH
EE2B ED 59          	OUT	(C),E
EE2D                COMSET:
EE2D 0E F8          	LD	C,0F8H
EE2F ED 79          	OUT	(C),A
EE31                DELAY0:
EE31 3E 1A          	LD	A,26
EE33                DELAY:
EE33 3D             	DEC	A
EE34 20 FD          	JR	NZ,DELAY
EE36 C9             	RET
EE37                
EE37                DRIVE:
EE37 2A 84 EF       	LD	HL,(_DRIVE)
EE3A 26 EF          	LD	H,_CYL0/256
EE3C CB FD          	SET	7,L
EE3E 7E             	LD	A,(HL)
EE3F C9             	RET
EE40                
EE40                RNF:
EE40 CD 37 EE       	CALL	DRIVE
EE43 36 FF          	LD	(HL),0FFH
EE45 C9             	RET
EE46                
EE46 02             RETRY:	DB	2
EE47                
EE47                
EE47                ;	FLOPPY DISK DRIVER(DMA)
EE47                
EE47                
EE47                WTTRK:
EE47 06 01          	LD	B,1
EE49 3E F4          	LD	A,0F4H
EE4B 18 02          	JR	WTTRK1
EE4D                FDWT:
EE4D 3E A0          	LD	A,0A0H
EE4F                WTTRK1:
EE4F 32 E4 ED       	LD	(FDCPAT+1),A
EE52 3E 10          	LD	A,16
EE54 18 0C          	JR	DISK
EE56                
EE56                DISKOK:
EE56 06 01          FDCNT:	LD	B,1
EE58 10 0B          	DJNZ	DISK1
EE5A C9             	RET
EE5B                
EE5B                FDRD:
EE5B 3E 80          	LD	A,080H
EE5D 32 E4 ED       	LD	(FDCPAT+1),A
EE60 3E 0E          	LD	A,14
EE62                
EE62                DISK:
EE62 32 79 EE       	LD	(DMAPAT+1),A
EE65                DISK1:
EE65 78             	LD	A,B
EE66 32 57 EE       	LD	(FDCNT+1),A
EE69 22 FB EE       	LD	(DMAD+11),HL
EE6C                DISKR:
EE6C 3E 02          	LD	A,2		;Retry count
EE6E 32 46 EE       	LD	(RETRY),A
EE71                DISK2:
EE71 D5             	PUSH	DE
EE72 CD 7E ED       	CALL	SEEK
EE75 38 43          	JR	C,ERRF
EE77 F3             	DI
EE78                
EE78 3E 0E          DMAPAT:	LD	A,14		;自己書き換え
EE7A 21 F0 EE       	LD	HL,DMAD
EE7D CD F5 DF       	CALL	SETDMA
EE80 ED 49          	OUT	(C),C		;OUT 01F87H,087H WR6 イネーブル
EE82 3A E4 ED       	LD	A,(FDCPAT+1)
EE85 C5             	PUSH	BC
EE86 CD 28 EE       	CALL	SECSET
EE89 2A FB EE       	LD	HL,(DMAHL)
EE8C 23             	INC	HL
EE8D 11 06 BB       	LD	DE,0BB06H	;READ DMA
EE90                
EE90 3E 03          	LD	A,3
EE92 CD FF ED       	CALL	READY
EE95 ED 78          	IN	A,(C)
EE97                
EE97 C1             	POP	BC
EE98 ED 51          	OUT	(C),D		;読み出しマスク設定
EE9A ED 59          	OUT	(C),E		;バイトカウンタ(LH)
EE9C ED 58          	IN	E,(C)
EE9E ED 50          	IN	D,(C)
EEA0 19             	ADD	HL,DE
EEA1 D1             	POP	DE
EEA2 13             	INC	DE
EEA3 FB             	EI
EEA4 CD 1C EE       	CALL	FDMOFF
EEA7 B7             	OR	A
EEA8 28 AC          	JR	Z,DISKOK
EEAA 1B             	DEC	DE
EEAB CB 67          	BIT	4,A
EEAD C4 40 EE       	CALL	NZ,RNF
EEB0                DISKE2:
EEB0 21 46 EE       	LD	HL,RETRY
EEB3 35             	DEC	(HL)
EEB4 20 BB          	JR	NZ,DISK2
EEB6 B7             	OR	A
EEB7 28 34          	JR	Z,ERR
EEB9 D5             	PUSH	DE
EEBA                ERRF:
EEBA D1             	POP	DE
EEBB                DELP:
EEBB CD 40 EE       	CALL	RNF
EEBE CD 1C EE       	CALL	FDMOFF
EEC1 3A 85 EF       	LD	A,(_SEEKSP)
EEC4 87             	ADD	A,A
EEC5 9F             	SBC	A,A
EEC6 38 25          	JR	C,ERR
EEC8                DELP1:
EEC8 D5             	PUSH	DE
EEC9 21 C0 F0       	LD	HL,DEMES
EECC CD 6F D8       	CALL	MSX
EECF CD ED DB       	CALL	KEYBC
EED2                DELP2:
EED2 CD CA EF       	CALL	_INKEY
EED5 28 FB          	JR	Z,DELP2
EED7                
EED7 D1             	POP	DE
EED8 CD 07 E4       	CALL	CAP
EEDB FE 52          	CP	'R'		;Retry
EEDD CA 6C EE       	JP	Z,DISKR
EEE0 FE 49          	CP	'I'		;Ignore
EEE2 28 07          	JR	Z,IGNORE
EEE4 FE 41          	CP	'A'		;Abort
EEE6 20 E0          	JR	NZ,DELP1
EEE8 C3 00 EF       	JP	CPM_BOOT
EEEB                IGNORE:
EEEB 3E FF          	LD	A,0FFH
EEED                ERR:
EEED BF             	CP	A
EEEE 37             	SCF
EEEF C9             	RET
EEF0                
EEF0                			;X1turbo DISK DMA
EEF0 C3             DMAD:	DB	0C3H	;WR6 リセット
EEF1 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
EEF2 FB 0F          	DW	00FFBH	;ポートA開始アドレス FDC データレジスタ
EEF4 FF FF          	DW	0FFFFH	;ブロック長(転送サイズ-1)
EEF6 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
EEF7 10             	DB	010H	;WR2 ポートBインクリメント
EEF8 80             	DB	080H	;WR3
EEF9 92             	DB	092H	;WR5 WAIT RDY:LOW
EEFA 8D             	DB	08DH	;WR4 バイト ポートB開始アドレス(LH)
EEFB 00 00          DMAHL:	DW	0	;ポートB開始アドレス
EEFD CF             	DB	0CFH	;WR6 ロード
EEFE 01             	DB	001H	;WR0 ポートB←ポートB 転送
EEFF CF             	DB	0CFH	;WR6 ロード
EF00                
EF00                DMAE:
EF00                
EF00 00 00 1E 7F    AT_R	EQU	WTTRK-AT_WTTRK
EF00                
EF00                	INCLUDE	"LDWORK.ASM"
EF00                
EF00                ;	LSX-Dodgers WORK
EF00                ;
EF00                ;	CP/M互換BIOS
EF00                ;	BOOT:アドレス下位1バイトが0になるように
EF00                CPM_BOOT:
EF00 C3 00 00       	JP	0
EF03                _SYS00:		;(BDOS)プログラム終了
EF03                CPM_WBOOT:
EF03 C3 0C D1       	JP	WBOOT1
EF06                CPM_CONST:
EF06 C3 A7 DC       	JP	CONSTX
EF09                _SYS07:		;(BDOS)コンソール直接入力
EF09                CPM_CONIN:
EF09 C3 4E DC       	JP	FLGET
EF0C                CPM_CONOUT:
EF0C C3 E6 DE       	JP	CONOUT1
EF0F                
EF0F                DECBF:
EF0F                	DS	5
EF14 00             FDRV	DB	0
EF15                FNAME	DS	36
EF39                SFILE:	DS	33		;DRV FILENAME
EF5A                HLBUF:	DS	3		;Random record buffer
EF5D                
EF5D 00 00          LEFTX:	DW	0
EF5F 00 00          DTAX:	DW	0
EF61                
EF61 00 8E 01 00    BEEPD:	DB	0,08EH,1,0,00BH,0,00CH,010H
EF65 0B 00 0C 10
EF69 07 3E 08 10    	DB	007H,03EH,008H,010H,00DH,0,0FFH
EF6D 0D 00 FF
EF70                
EF70 00             CHECK:	DB	0
EF71                
EF71 4F 4B 24       OK:	DB	"OK$"
EF74 53 6B 69 70    SKIP:	DB	"Skip$"
EF78 24
EF79 45 72 72 6F    COMERM:	DB	"Error!$"
EF7D 72 21 24
EF80                ;	システムワークエリア
EF80                ;	_CYL0:アドレス下位1バイトが080Hになるように
EF80 FF             _CYL0:	DB	0FFH	;Cylinder
EF81 FF             _CYL1:	DB	0FFH	;Cylinder
EF82 FF             _CYL2:	DB	0FFH	;Cylinder
EF83 FF             _CYL3:	DB	0FFH	;Cylinder
EF84 00             _DRIVE:	DB	0	;unit number
EF85 00             _SEEKSP:DB	0	;Seek speed
EF86 FF             _ISEEK:	DB	0FFH	;
EF87 00             _DVSW:	DB	0
EF88 00             _DRV:	DB	0
EF89 FF             _DSK:	DB	0FFH
EF8A 80 00          _DTA:	DW	00080H
EF8C 00 00          _CTC:	DW	0
EF8E 00 00          _TXADR:	DW	0
EF90 00 00          _KEYPS:	DW	0
EF92 00 FF          _KEYD:	DW	0FF00H	;キーデータ
EF94 C2 10          _KEYSP:	DW	010C2H
EF96 07             _COLORF:DB	7	;色
EF97 18             _LINE:	DB	LINE
EF98                
EF98 00 00          _FCB:	DW	0
EF9A 00 00          _FBPS:	DW	0	;SEARCH FILES
EF9C 00 00          _FBAD:	DW	0	;    //
EF9E 00             _FBCNT:	DB	0	;    //
EF9F 00             _FILEN:	DB	0
EFA0 00             _DIRF:	DB	0	;bit7:ディレクトリ bit0-6:セクタインデックス
EFA1 00             _MAXCYL:DB	0
EFA2 00             _WTFATF:DB	0	;FATバッファの更新フラグ
EFA3                		DS	1
EFA4 00             _WTDBF:	DB	0	;データバッファの更新フラグ
EFA5 FF             _DBDRV:	DB	0FFH	;データバッファにあるデータを読み込んだドライブ
EFA6 00 00          _DBSEC:	DW	0	;データバッファにあるデータを読み込んだセクタ番号
EFA8 00 00          _DPB:	DW	0
EFAA                _FATDRV:
EFAA FF             	DB	0FFH	;FATバッファに読み込んでいるドライブ
EFAB 00             _FATIX:	DB	0	;FATバッファに読み込んでいるインデックス
EFAC                _FAKEFREE:
EFAC 00 00          	DW	0	;偽の残量（FATサイズが大きくなると重くなるのでその対策）
EFAE                
EFAE                	DS	2
EFB0                
EFB0 6F 50 59 38    CRTCD:	DB	06FH,050H,059H,038H,01FH,002H,019H,01CH
EFB4 1F 02 19 1C
EFB8 00 07          	DB	000H,007H
EFBA 80 F8 B0 FF    	DW	0-80*LINE,0-80
EFBE 0C             	DB	00CH
EFBF 20             WK1FD0:	DB	020H
EFC0                
EFC0 56 DB          CTC0:	DW	INTCTCE
EFC2 56 DB          CTC1:	DW	INTCTCE
EFC4 78 DB          CTC2:	DW	INTCTC2
EFC6 56 DB          CTC3:	DW	INTCTCE
EFC8 3F DB          INTVEC:	DW	INT
EFCA                
EFCA                ;	LSX-Dodgers 独自BIOS
EFCA                
EFCA C3 DB E0       _INKEY:	JP	INKEY
EFCD C3 75 DD       _PRINT:	JP	PRINT
EFD0 C3 45 E0       _SCRN:	JP	SCRN
EFD3 C3 6D E0       _POS:	JP	POS
EFD6 C3 AF DE       _LOC:	JP	LOC
EFD9                _CHGDRV:
EFD9 C3 71 EC       	JP	CHGDRV
EFDC                _GETDPB:
EFDC C3 45 ED       	JP	GETDPB
EFDF                _FFLUSH:
EFDF C3 63 ED       	JP	FFLUSH
EFE2                _RDFATX:
EFE2 C3 76 E9       	JP	RDFATX
EFE5 C3 9E EA       _RDFAT:	JP	RDFAT
EFE8 C3 47 EE       _WTTRK:	JP	WTTRK
EFEB C3 5B EE       _FDRD:	JP	FDRD
EFEE C3 4D EE       _FDWT:	JP	FDWT
EFF1                _BPB2DPB:
EFF1 C3 03 EB       	JP	BPB2DPB
EFF4                	DS	3
EFF7                _GNCL:
EFF7 C3 18 EA       GNCPAT:	JP	GNCL		; self-modifying code
EFFA                _SNCL:
EFFA C3 3B EA       SNCPAT:	JP	SNCL		; self-modifying code
EFFD C3 8A D1       _COMANL:JP	COMANL
F000                
F000                _WE:
F000                	INCLUDE	"LDCALL.ASM"
F000                
F000                ;	LSX-Dodgers システムコール(BDOS)
F000                ;
F000                ;	LSX-Dodgers SYSTEM CALL
F000                ;	STABLE:アドレス下位1バイトが0になるように
F000                
F000                STABLE:
F000                ;0
F000 03 EF 21 DC    	DW	_SYS00,_SYS01,_SYS02,_SYS03
F004 2D DC 8F E2
F008 5E D8 5E D8    	DW	_SYS04,_SYS05,_SYS06,_SYS07
F00C 32 DC 09 EF
F010 3A DC 60 D8    	DW	_SYS08,_SYS09,_SYS0A,_SYS0B
F014 73 DC 9F DC
F018 75 D8 7A D8    	DW	_SYS0C,_SYS0D,_SYS0E,_SYS0F
F01C 89 D8 9C D8
F020                ;1
F020 F0 D8 37 D9    	DW	_SYS10,_SYS11,_SYS12,_SYS13
F024 80 D9 B6 D9
F028 BE D9 DC D9    	DW	_SYS14,_SYS15,_SYS16,_SYS17
F02C F9 D9 F1 D9
F030 5A DA 5F DA    	DW	_SYS18,_SYS19,_SYS1A,_SYS1B
F034 64 DA 6A DA
F038 5E D8 90 DA    	DW	_SYS1C,_SYS1D,_SYS1E,_SYS1F
F03C 5E D8 94 DA
F040                ;2
F040 5E D8 30 DA    	DW	_SYS20,_SYS21,_SYS22,_SYS23
F044 45 DA 9B DA
F048 BA DA 5E D8    	DW	_SYS24,_ERROR,_SYS26,_SYS27
F04C CB E6 AC E7
F050 45 DA C3 DA    	DW	_SYS28,_SYS5C,_SYS2A,_SYS2B
F054 B5 DC 8F E2
F058 E9 DC 8F E2    	DW	_SYS2C,_SYS2D,_SYS2E,_SYS2F
F05C 5E D8 E6 DA
F060                ;3
F060 E0 DA 5E D8    	DW	_SYS30,_ERROR,_ERROR,_ERROR
F064 5E D8 5E D8
F068 5E D8 5E D8    	DW	_ERROR,_ERROR,_ERROR,_ERROR
F06C 5E D8 5E D8
F070 5E D8 8F E2    	DW	_ERROR,_SYS39,_SYS3A,_SYS5A
F074 8F E2 07 DB
F078                ;DOS2
F078 44 D8          	DW	_DOS2
F07A                
F07A                	DS	2
F07C 00 F2          _FATBF:	DW	FATBF
F07E 00 FA          _DTBUF:	DW	DTBUF
F080                
F080                ;	コントロールコードテーブル
F080                ;	CTRLTB:アドレス下位1バイトが080Hになるように
F080                
F080                CTRLTB:
F080 26 DE 26 DE    	DW	CTRL00,CTRL00,CTRL02,CTRL03	;  A,B,C
F084 62 DE A7 DF
F088 A1 DF 86 DE    	DW	CTRL04,CTRL05,CTRL06,CTRL07	;D,E,F,G
F08C 80 DF 07 DF
F090 32 DE 53 DE    	DW	CTRL08,CTRL09,CTRL0A,CTRL0B	;H,I,J,K
F094 AA DF C5 DE
F098 7D DF AA DE    	DW	CTRL0C,CTRL0D,CTRL0E,CTRL00	;L,M,N,O
F09C BF DF 26 DE
F0A0 26 DE 26 DE    	DW	CTRL00,CTRL00,CTRL12,CTRL00	;P,Q,R,S
F0A4 BD DE 26 DE
F0A8 26 DE 26 DE    	DW	CTRL00,CTRL00,CTRL00,CTRL00	;T,U,V,W
F0AC 26 DE 26 DE
F0B0 26 DE 26 DE    	DW	CTRL00,CTRL00,CTRL0C,CTRL1B	;X,Y,Z,ESC
F0B4 7D DF CC DE
F0B8 4D DE 39 DE    	DW	CTRL1C,CTRL1D,CTRL1E,CTRL1F	;→,←,↑,↓
F0BC 42 DE AA DF
F0C0                
F0C0 03 07          DEMES:	DB	3,7
F0C2 44 65 76 69    	DB	"Device I/O Error",5,3
F0C6 63 65 20 49
F0CA 2F 4F 20 45
F0CE 72 72 6F 72
F0D2 05 03
F0D4 41 62 6F 72    	DB	"Abort Retry Ignore?",5,3,0
F0D8 74 20 52 65
F0DC 74 72 79 20
F0E0 49 67 6E 6F
F0E4 72 65 3F 05
F0E8 03 00
F0EA                
F0EA 16 17          SDDATA:	DB	22,23		;(FCB)ファイルを最後に変更した時刻
F0EC 14 15          	DB	20,21		;(FCB)ファイルを最後に変更した日付
F0EE 1A 1B          	DB	26,27		;(FCB)ファイルの先頭クラスタ
F0F0 10 11 12 13    	DB	16,17,18,19	;(FCB)ファイルのサイズ(バイト単位)
F0F4                SDDATAE:
F0F4                
F0F4                SCDIR:	DS	2		;+14 +15
F0F6                SFBPS:	DS	2		;FBPS
F0F8                SFNDF:	DS	2		;FILEN DIRF
F0FA                
F0FA 00 00          _FATPS:	DW	0
F0FC 00 00          _DIRPS:	DW	0
F0FE 00 00          _CLPS:	DW	0
F100                
F100                _PE:
F100                	INCLUDE	"LDDPB.ASM"
F100                
F100                ;	LSX-Dodgers DPB
F100                
F100                DEVICE:
F100                
F100                ;	A:
F100                
F100 02 00          	DW	2	;DPB_00_FATLN
F102 EB EF          	DW	_FDRD	;DPB_02_DRD
F104 EE EF          	DW	_FDWT	;DPB_04_DWT
F106 FD             	DB	0FDH	;DPB_06_FATID
F107 02             	DB	2	;DPB_07_SECPCL
F108 64 01          	DW	356	;DPB_08_MAXCL
F10A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F10B 07             	DB	7	;DPB_0B_DIRSCNT
F10C 28             	DB	40	;DPB_0C_MAXCYL
F10D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F10E 01             	DB	1	;DPB_0E_FATPS
F10F 82             	DB	082H	;DPB_0F_BPS
F110 05 00          	DW	5	;DPB_10_DIRPS
F112 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F113 00             	DB	0	;DPB_13_UNITNO
F114 08 00          	DW	8	;DPB_14_ADDCL16
F116 00 00          	DW	0	;DPB_16
F118 00 00          	DW	0	;DPB_18
F11A 00 00          	DW	0	;DPB_1A_SDIR
F11C 46 44 44 30    	DB	"FDD0"	;DPB_1C_NAME
F120                
F120                ;	B:
F120                
F120 02 00          	DW	2	;DPB_00_FATLN
F122 EB EF          	DW	_FDRD	;DPB_02_DRD
F124 EE EF          	DW	_FDWT	;DPB_04_DWT
F126 FD             	DB	0FDH	;DPB_06_FATID
F127 02             	DB	2	;DPB_07_SECPCL
F128 64 01          	DW	356	;DPB_08_MAXCL
F12A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F12B 07             	DB	7	;DPB_0B_DIRSCNT
F12C 28             	DB	40	;DPB_0C_MAXCYL
F12D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F12E 01             	DB	1	;DPB_0E_FATPS
F12F 82             	DB	082H	;DPB_0F_BPS
F130 05 00          	DW	5	;DPB_10_DIRPS
F132 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F133 01             	DB	1	;DPB_13_UNITNO
F134 08 00          	DW	8	;DPB_14_ADDCL16
F136 00 00          	DW	0	;DPB_16
F138 00 00          	DW	0	;DPB_18
F13A 00 00          	DW	0	;DPB_1A_SDIR
F13C 46 44 44 31    	DB	"FDD1"	;DPB_1C_NAME
F140                
F140                ;	C:
F140                
F140 02 00          	DW	2	;DPB_00_FATLN
F142 EB EF          	DW	_FDRD	;DPB_02_DRD
F144 EE EF          	DW	_FDWT	;DPB_04_DWT
F146 FD             	DB	0FDH	;DPB_06_FATID
F147 02             	DB	2	;DPB_07_SECPCL
F148 64 01          	DW	356	;DPB_08_MAXCL
F14A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F14B 07             	DB	7	;DPB_0B_DIRSCNT
F14C 28             	DB	40	;DPB_0C_MAXCYL
F14D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F14E 01             	DB	1	;DPB_0E_FATPS
F14F 82             	DB	082H	;DPB_0F_BPS
F150 05 00          	DW	5	;DPB_10_DIRPS
F152 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F153 02             	DB	2	;DPB_13_UNITNO
F154 08 00          	DW	8	;DPB_14_ADDCL16
F156 00 00          	DW	0	;DPB_16
F158 00 00          	DW	0	;DPB_18
F15A 00 00          	DW	0	;DPB_1A_SDIR
F15C 46 44 44 32    	DB	"FDD2"	;DPB_1C_NAME
F160                
F160                ;	D:
F160                
F160 02 00          	DW	2	;DPB_00_FATLN
F162 EB EF          	DW	_FDRD	;DPB_02_DRD
F164 EE EF          	DW	_FDWT	;DPB_04_DWT
F166 FD             	DB	0FDH	;DPB_06_FATID
F167 02             	DB	2	;DPB_07_SECPCL
F168 64 01          	DW	356	;DPB_08_MAXCL
F16A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F16B 07             	DB	7	;DPB_0B_DIRSCNT
F16C 28             	DB	40	;DPB_0C_MAXCYL
F16D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F16E 01             	DB	1	;DPB_0E_FATPS
F16F 82             	DB	082H	;DPB_0F_BPS
F170 05 00          	DW	5	;DPB_10_DIRPS
F172 A7             	DB	0A7H	;DPB_12_DEVICE
F173 03             	DB	3	;DPB_13_UNITNO
F174 08 00          	DW	8	;DPB_14_ADDCL16
F176 00 00          	DW	0	;DPB_16
F178 00 00          	DW	0	;DPB_18
F17A 00 00          	DW	0	;DPB_1A_SDIR
F17C 46 44 44 33    	DB	"FDD3"	;DPB_1C_NAME
F180                
F180                ;	E:
F180                
F180 00 00          EMMFL:	DW	0	;DPB_00_FATLN
F182 D3 D7          EMMRD:	DW	EDRD	;DPB_02_DRD
F184 CF D7          EMMWR:	DW	EDWT	;DPB_04_DWT
F186 FE             	DB	0FEH	;DPB_06_FATID
F187 02             	DB	2	;DPB_07_SECPCL
F188 00 00          EMMCL:	DW	0	;DPB_08_MAXCL
F18A 00             	DB	0	;DPB_0A_FDMODE
F18B 0C             	DB	12	;DPB_0B_DIRSCNT
F18C 00             EMMBL:	DB	0	;DPB_0C_MAXCYL
F18D 01             	DB	1	;DPB_0D_MAXSEC
F18E 02             	DB	2	;DPB_0E_FATPS
F18F 02             	DB	2	;DPB_0F_BPS
F190 0A 00          	DW	10	;DPB_10_DIRPS
F192 06             	DB	6	;DPB_12_DEVICE
F193 00             EMMDV:	DB	0	;DPB_13_UNITNO
F194 12 00          	DW	18	;DPB_14_ADDCL16
F196 00 00          	DW	0	;DPB_16
F198 00 00          	DW	0	;DPB_18
F19A 00 00          	DW	0	;DPB_1A_SDIR
F19C 45 4D 4D 30    	DB	"EMM0"	;DPB_1C_NAME
F1A0                
F1A0                ;	F:
F1A0                
F1A0 00 00          BANKFL:	DW	0	;DPB_00_FATLN
F1A2 6A D7          	DW	BDRD	;DPB_02_DRD
F1A4 66 D7          	DW	BDWT	;DPB_04_DWT
F1A6 F9             	DB	0F9H	;DPB_06_FATID
F1A7 02             	DB	2	;DPB_07_SECPCL
F1A8 00 00          BANKCL:	DW	0	;DPB_08_MAXCL
F1AA 00             	DB	0	;DPB_0A_FDMODE
F1AB 08             	DB	8	;DPB_0B_DIRSCNT
F1AC 00             	DB	0	;DPB_0C_MAXCYL
F1AD 01             	DB	1	;DPB_0D_MAXSEC
F1AE 00             	DB	0	;DPB_0E_FATPS
F1AF 02             	DB	2	;DPB_0F_BPS
F1B0 02 00          	DW	2	;DPB_10_DIRPS
F1B2 0B             	DB	00BH	;DPB_12_DEVICE
F1B3 00             	DB	0	;DPB_13_UNITNO
F1B4 06 00          	DW	6	;DPB_14_ADDCL16
F1B6 00 00          	DW	0	;DPB_16
F1B8 00 00          	DW	0	;DPB_18
F1BA 00 00          	DW	0	;DPB_1A_SDIR
F1BC 42 52 41 4D    	DB	"BRAM"	;DPB_1C_NAME
F1C0                
F1C0                ;	G:
F1C0                
F1C0 01 00          	DW	1	;DPB_00_FATLN
F1C2 27 D7          	DW	GDRD	;DPB_02_DRD
F1C4 3E D7          	DW	GDWT	;DPB_04_DWT
F1C6 F9             	DB	0F9H	;DPB_06_FATID
F1C7 04             	DB	4	;DPB_07_SECPCL
F1C8 30 00          	DW	48	;DPB_08_MAXCL
F1CA 00             	DB	0	;DPB_0A_FDMODE
F1CB 04             	DB	4	;DPB_0B_DIRSCNT
F1CC 00             	DB	0	;DPB_0C_MAXCYL
F1CD 01             	DB	1	;DPB_0D_MAXSEC
F1CE 00             	DB	0	;DPB_0E_FATPS
F1CF 01             	DB	1	;DPB_0F_BPS
F1D0 04 00          	DW	4	;DPB_10_DIRPS
F1D2 05             	DB	5	;DPB_12_DEVICE
F1D3 01             	DB	1	;DPB_13_UNITNO
F1D4 00 00          	DW	0	;DPB_14_ADDCL16
F1D6 00 00          	DW	0	;DPB_16
F1D8 00 00          	DW	0	;DPB_18
F1DA 00 00          	DW	0	;DPB_1A_SDIR
F1DC 47 52 41 4D    	DB	"GRAM"	;DPB_1C_NAME
F1E0                
F1E0                ;	H:
F1E0                	DS	31
F1FF 00             	DB	0
F200                
F200                LDEND:
F200                
F200                	END
F200                
