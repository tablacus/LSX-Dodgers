                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   LSX-Dodgers for X1/turbo/Z
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
                                MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
                                MACD    EQU MAC + 00000H    ;機種フラグとデバイスフラグ
                                VER EQU VER_1 * 256 + VER_2 * 17 + VER_3
                                
                                SYSTEM  EQU 00005H
                                JP_HL   EQU 0000FH
                                FCB1    EQU 0005CH
                                FCB2    EQU 0006CH
                                FCB1FN  EQU FCB1+1
                                FCB2FN  EQU FCB2+1
                                DTA1    EQU 00080H
                                
                                EXTBIO  EQU 0FFCAH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
                                    ORG RUN-7
                                
                                ;   MSX BINARY HEADER
       0000                         DB  0FEH
                                ;   MSX BINARY START ADDRESS
       0000                         DW  RUN
                                ;   MSX BINARY END ADDRESS
       0000                         DW  LDEND
                                ;   MSX BINARY EXEC ADDRESS
       0000                         DW  RUN
                                
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       0000                     COMMAND:
       0000                 17      CALL    SETDTA1
       0000                 13      LD  A,(_DVSW)
       0000                  7      ADD A,'A'
       0000                 17      CALL    MSG_A
       0000                  7      LD  A,'>'
       0000                 17      CALL    MSG_A
       0000                  7      LD  A,80
       0000                  7      LD  (DE),A
       0000                 17      CALL    _SYS0A      ;(BDOS)文字列入力
       0000                 17      CALL    LTNL
                                
       0000                 10      LD  DE,DTA1+2
       0000                 17      CALL    _COMANL
       0000                 12      JR  NC,COMMAND
       0000                 10      LD  DE,COMERM
       0000                 17      CALL    _SYS09      ;(BDOS)文字列出力
       0000                 12      RST 0
                                
       0000                     COMANL:
       0000                 17      CALL    FILE
       0000                 13      LD  A,(FNAME+4)
       0000                  7      CP  020H
       0000                 12      JR  NZ,COMB2
       0000                 11      PUSH    DE
       0000                 10      LD  DE,FNAME
       0000                  7      LD  A,(DE)
       0000                  7      CP  020H
       0000                 12      JR  Z,SDVSW
       0000                  6      DEC DE
       0000                  7      LD  A,(DE)
       0000                  7      ADD A,0FFH
       0000                 12      JR  C,COMB
       0000                  6      INC DE
                                
       0000                 10      LD  HL,COMTB
       0000                  7      LD  B,COMS
       0000                 17      CALL    CPNAME
       0000                     COMB:
       0000                 10      POP DE
       0000                 10      JP  NC,JP_HL
       0000                     COMB2:
       0000                  4      EX  DE,HL
       0000                 16      LD  (COMPAT+1),HL
       0000                 11      PUSH    AF
       0000                 17      CALL    CEXE4
       0000                 10      POP AF
       0000                 10      LD  HL,FNAME
       0000                 10      LD  DE,FCB2+1   ;COMMAND NAME
       0000                 10      LD  BC,11
       0000                         LDIR
       0000                 10      LD  DE,PATHD
       0000                     CEX1:
       0000                  7      LD  A,(DE)
       0000                  7      CP  020H
       0000                 11      RET C
       0000                 17      CALL    FILEC
       0000                 11      PUSH    DE
       0000                 10      LD  HL,FCB2+1   ;COMMAND NAME
       0000                 10      LD  DE,FNAME
       0000                 10      LD  BC,11
       0000                         LDIR
       0000                 17      CALL    CEXE4
       0000                 10      POP DE
       0000                  6      INC DE
       0000                 12      JR  CEX1
                                
       0000                     SDVSW:
       0000                 10      POP AF
       0000                 13      LD  A,(FDRV)
       0000                  4      DEC A
       0000                  4      LD  E,A
       0000                  7      LD  C,00EH      ;(BDOS)カレントドライブの設定
       0000                 12      JR  SYSTEM0
                                
       0000                     OPEN1:
       0000                 10      LD  HL,FDRV
       0000                     OPEN:
       0000                  7      LD  C,011H      ;(BDOS)ファイルの検索
       0000                     OPEN3:
       0000                 11      PUSH    DE
       0000                 10      LD  DE,DTA_CCP
       0000                 17      CALL    SETDTA
       0000                  4      EX  DE,HL
       0000                 17      CALL    SYSTEM0
       0000                 10      POP DE
       0000                 10      RET
                                
       0000                     OPEN2:
       0000                  7      LD  C,012H
       0000                 12      JR  OPEN3
                                
       0000                     DEFCB:              ;Z=Ok NZ=Error
       0000                 10      LD  DE,DTA_CCP
       0000                 17      CALL    SYSC0F
                                
       0000                 10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
       0000                  7      LD  B,4
       0000                 17      CALL    ZERO_MEMORY_DE
       0000                 10      LD  DE,00100H
       0000                     SETDTA:
       0000                 10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       0000                     SETDTA1:
       0000                 10      LD  DE,DTA1
       0000                 12      JR  SETDTA
                                
       0000                     SYSC0F:
       0000                  7      LD  C,00FH      ;(BDOS)ファイルのオープン
       0000                     SYSTEM0:
       0000                 17      CALL    SYSTEM
       0000                  4      OR  A
       0000                 10      RET
                                
       0000                     C_CD:
       0000                  7      LD  C,5AH
       0000                 12      JR  SYSTEM0
                                
       0000                     S27BUF:
       0000                 13      LD  A,(SYSTEM+2)
       0000                  4      DEC A
       0000                  7      AND 0F8H
       0000                  4      LD  H,A
       0000                  7      LD  L,0
       0000                     S27DTA:
       0000                 10      LD  DE,DTA_CCP
       0000                     S27:
       0000                  7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       0000                 12      JR  SYSTEM0
                                
       0000                     CEXE4:
       0000                 13      LD  A,(FDRV)
       0000                 13      LD  (00057H),A
       0000                 16      LD  HL,(FDRV+14)
       0000                 16      LD  (00058H),HL
                                
       0000                 10      LD  HL,FNAME+8
       0000                  7      LD  A,(HL)
       0000                  7      CP  020H
       0000                 12      JR  NZ,CEXE7
       0000                  7      LD  A,'?'
       0000                  7      LD  (HL),A
       0000                  6      INC HL
       0000                  7      LD  (HL),A
       0000                  6      INC HL
       0000                  7      LD  (HL),A
       0000                     CEXE7:
       0000                 17      CALL    OPEN1
       0000                     CEXE5:
       0000                 11      RET NZ
       0000                 16      LD  HL,(DTA_CCP+1+9)
       0000                  4      LD  A,H
       0000                 17      CALL    CAP
       0000                  4      LD  H,A
       0000                  4      LD  A,L
       0000                 17      CALL    CAP
       0000                  4      LD  L,A
       0000                 13      LD  A,(DTA_CCP+1+8)
       0000                 17      CALL    CAP
       0000                  7      SUB 'B'
       0000                 12      JR  Z,C_BAT
       0000                  4      DEC A       ;'C'
       0000                 12      JR  Z,C_EXE
       0000                     CEXE6:
       0000                 17      CALL    OPEN2
       0000                 12      JR  CEXE5
                                
       0000                     C_EXE:
       0000                  4      LD  A,H
       0000                  7      CP  'M'
       0000                 12      JR  NZ,CEXE6
                                
       0000                 17      CALL    DEFCB
       0000                 17      CALL    S27BUF
       0000                  4      DEC A
       0000                  4      SCF
       0000                 11      RET NZ
       0000                  4      LD  A,H
       0000                  4      OR  L
       0000                  4      SCF
       0000                 11      RET Z
       0000                 17      CALL    SETDTA1
       0000                 10  COMPAT: LD  DE,0                ; self-modifying code
       0000                 20      LD  SP,(SYSTEM+1)
       0000                  4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
       0000                  4      LD  L,A
       0000                 11      PUSH    HL              ; push $0000 (reboot address)
       0000                  4      INC H
       0000                 11      PUSH    HL              ; push $0100 (TPA address)
       0000                 10      JP  SETFCB              ; and JP $0100
                                
       0000                     C_BAT:
       0000                 10      LD  DE,'A'+'T'*256
       0000                 15      SBC HL,DE
       0000                 12      JR  NZ,CEXE6
                                
       0000                 10      POP AF
       0000                 10      POP AF
       0000                 17      CALL    DEFCB
       0000                 10      LD  HL,00200H
       0000                 17      CALL    S27DTA
       0000                  7      ADD A,0FEH
       0000                 11      RET C
       0000                  4      LD  A,L
       0000                  4      OR  A
       0000                  4      SCF
       0000                 11      RET Z
       0000                  4      INC A
       0000                 11      PUSH    AF
                                
       0000                 17      CALL    KEYBC
       0000                  7      LD  A,6
       0000                 17      CALL    MSG_A
       0000                 10      POP BC
       0000                 10      LD  HL,00100H
       0000                     BAT1:
       0000                  4      AND A
       0000                  4      DEC B
       0000                 11      RET Z
       0000                  7      LD  A,(HL)
       0000                  7      CP  '%'
       0000                 12      JR  Z,BAT2
       0000                     BAT1X:
       0000                  7      LD  A,(HL)
       0000                  6      INC HL
       0000                  7      CP  01AH
       0000                 11      RET Z
       0000                  7      CP  00AH
       0000                 17      CALL    NZ,KEYBS
       0000                 12      JR  BAT1
                                
       0000                     BAT2:
       0000                  6      INC HL
       0000                  7      LD  A,(HL)
       0000                  6      DEC HL
       0000                  7      SUB '1'
       0000                 12      JR  C,BAT1X
       0000                  7      CP  9
       0000                 12      JR  NC,BAT1X
       0000                  6      INC HL
       0000                  6      INC HL
       0000                  4      INC A
       0000                  4      LD  C,A
       0000                 20      LD  DE,(COMPAT+1)
       0000                     BAT3:
       0000                  7      LD  A,(DE)
       0000                  4      OR  A
       0000                 12      JR  Z,BAT1
       0000                 17      CALL    SPCUT
       0000                  4      DEC C
       0000                 12      JR  Z,BAT5
       0000                     BAT4:
       0000                  7      LD  A,(DE)
       0000                  7      CP  021H
       0000                 12      JR  C,BAT3
       0000                  6      INC DE
       0000                 12      JR  BAT4
       0000                     BAT5:
       0000                  7      LD  A,(DE)
       0000                  7      CP  021H
       0000                 12      JR  C,BAT1
       0000                  6      INC DE
       0000                 17      CALL    KEYBS
       0000                 12      JR  BAT5
                                
       0000                     SWITCH:
       0000                  7      LD  A,(DE)
       0000                     SW1:
       0000                  6      INC DE
       0000                  4      CP  C
       0000                  7      LD  A,(DE)
       0000                 11      RET Z
       0000                  7      CP  020H
       0000                 12      JR  NC,SW1
       0000                     C_REM:
       0000                  4      XOR A
       0000                 10      RET
                                
       0000                     C_DEL:
       0000                 17      CALL    SETFCB
       0000                 17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
       0000                  7      LD  C,013H
       0000                 12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       0000                     C_REN:
       0000                 17      CALL    SETFCB
       0000                  7      LD  A,010H      ;ディレクトリも対象にする
       0000                 13      LD  (FCB1+13),A ;属性
       0000                  7      LD  C,017H      ;(BDOS)ファイル名の変更
       0000                     CDEL1:
       0000                 10      LD  DE,FCB1
       0000                 17      CALL    SYSTEM
       0000                  7      ADD A,0FFH
       0000                 10      RET
                                
       0000                     C_DIR:
       0000                 17      CALL    FILEC
       0000                 10      LD  HL,FDRV+1
       0000                 17      CALL    CWILD1
       0000                  7      LD  A,0F1H
       0000                 13      LD  (FDRV+13),A
       0000                 17      CALL    OPEN1
       0000                     CDIR1:
       0000                  4      OR  A
       0000                 12      JR  NZ,PDSKF
       0000                 17      CALL    P_NAME
       0000                 17      CALL    OPEN2
       0000                 12      JR  CDIR1
                                
       0000                     PDSKF:
       0000                 13      LD  A,(FDRV)
       0000                  4      LD  E,A
       0000                  7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
       0000                 17      CALL    SYSTEM
       0000                  4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
       0000                  7      ADD A,001H
       0000                 11      RET C       ;Aが0FFHだった場合
       0000                  7      LD  A,8-2
       0000                     PDS1:               ;HL=未使用クラスタの総数
       0000                  4      INC A
       0000                  8      RR  C
       0000                 12      JR  NC,PDS1
       0000                     PDS2:               ;B←論理セクタのサイズの上位8ビット
       0000                  4      INC A
       0000                  8      RR  B
       0000                 12      JR  NC,PDS2
       0000                  4      LD  B,A
                                
       0000                 10      LD  DE,0
       0000                     PDS3:
       0000                 11      ADD HL,HL
       0000                  4      EX  DE,HL
       0000                 15      ADC HL,HL
       0000                  4      EX  DE,HL
       0000                 13      DJNZ    PDS3
       0000                     PDSKF1:
       0000                 17      CALL    PRDEC_DEHL
       0000                 10      LD  DE,FREE
       0000                 17      CALL    _SYS09      ;(BDOS)文字列出力
       0000                 17      CALL    PUTDRV
       0000                  7      LD  A,05CH      ;\
       0000                 17      CALL    MSG_A
       0000                 16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
       0000                  4      XOR A
       0000                 10      LD  DE,0-2
       0000                 11      ADD HL,DE
       0000                  6      INC HL
       0000                 17      CALL    C,PRDEC_HL
       0000                 12      JR  LTNL
                                
       0000                     P_NAME:
       0000                 13      LD  A,(DTA_CCP+1)
       0000                  7      CP  '.'
       0000                 11      RET Z
       0000                 10      LD  DE,DIRHD
       0000                 17      CALL    _SYS09      ;(BDOS)文字列出力
       0000                 13      LD  A,(DTA_CCP+1+00BH)
       0000                 11      PUSH    AF
       0000                  4      RRCA
       0000                  4      SBC A,A
       0000                  7      AND '*'-020H
       0000                  7      ADD A,020H
       0000                 17      CALL    MSG_A
       0000                 17      CALL    PUTDRV
       0000                 10      LD  HL,DTA_CCP+1
       0000                 17      CALL    FPRNT
                                
       0000                 10      POP AF
       0000                  8      BIT 4,A
       0000                 12      JR  Z,DIR3
       0000                 10      LD  DE,DIRMES
       0000                 17      CALL    _SYS09      ;(BDOS)文字列出力
       0000                 12      JR  DIR6
       0000                     DIR3:
       0000                 20      LD  DE,(DTA_CCP+1+01EH)
       0000                 16      LD  HL,(DTA_CCP+1+01CH)
       0000                 17      CALL    PRDEC_DEHL
       0000                     DIR6:
       0000                 13      LD  A,(CRTCD+1)
       0000                  7      CP  40+1
       0000                 17      CALL    NC,PRTTMS
                                
       0000                     LTNL:
       0000                  7      LD  E,3
       0000                 10      JP  _PRINT
                                
       0000                     C_PATH:
       0000                 17      CALL    SPCUT
       0000                 10      LD  HL,PATHD
       0000                  7      CP  021H
       0000                 12      JR  NC,CPATH0
       0000                     CPATHP:
       0000                  7      LD  A,(HL)
       0000                  6      INC HL
       0000                  7      CP  020H
       0000                  4      CCF
       0000                 12      JR  NC,LTNL
       0000                 17      CALL    MSG_A
       0000                 12      JR  CPATHP
       0000                     CPATH0:
       0000                  7      CP  ';'
       0000                 12      JR  NZ,CPATH1
       0000                  6      INC DE
       0000                     CPATH1:
       0000                  4      EX  DE,HL
       0000                 10      LD  BC,PATHX
       0000                         LDIR
       0000                 10      RET
                                
       0000                     PUTDRV:
       0000                 13      LD  A,(FDRV)
       0000                  7      ADD A,'A'-1
       0000                 17      CALL    MSG_A
       0000                  7      LD  A,':'
       0000                     MSG_AR:
       0000                 10      JP  MSG_A
                                
       0000                     PRDEC_HL:
       0000                  4      XOR A
       0000                     PRDEC_AHL:
       0000                  4      LD  E,A
       0000                  7      LD  D,0
       0000                     PRDEC_DEHL:
       0000                 11      PUSH    DE
       0000                 10      LD  DE,DECBF
       0000                  7      LD  B,5
       0000                 17      CALL    ZERO_MEMORY_DE  ;A=0
       0000                 10      POP DE
                                
       0000                  7      LD  C,32
       0000                     DEC1:
       0000                 11      ADD HL,HL
       0000                  4      EX  DE,HL
       0000                 15      ADC HL,HL
       0000                  4      EX  DE,HL
       0000                 11      PUSH    HL
       0000                 10      LD  HL,DECBF+4
       0000                  7      LD  B,5
       0000                     DEC2:
       0000                  7      LD  A,(HL)
       0000                  4      ADC A,A
       0000                  4      DAA
       0000                  7      LD  (HL),A
       0000                  6      DEC HL
       0000                 13      DJNZ    DEC2
       0000                 10      POP HL
       0000                  4      DEC C
       0000                 12      JR  NZ,DEC1
                                
       0000                 10      LD  HL,DECBF
       0000                  7      LD  A,020H
       0000                  7      LD  B,4
       0000                     DEC3:
       0000                 17      CALL    DEC4
       0000                 17      CALL    DEC4
       0000                  6      INC HL
       0000                 13      DJNZ    DEC3
       0000                     DECX:
       0000                 17      CALL    DEC4
       0000                  4      XOR A
       0000                     DEC4:
       0000                 18      RLD
       0000                  7      CP  020H
       0000                 12      JR  Z,DEC5
       0000                  7      OR  030H
       0000                     DEC5:
       0000                 12      JR  MSG_AR
                                
       0000                     FPRNT:
       0000                  7      LD  B,8
       0000                 17      CALL    P_N1
       0000                  7      LD  A,(HL)
       0000                  7      ADD A,0A0H-020H
       0000                  7      CP  0A0H
       0000                 12      JR  Z,FPR1
       0000                  7      LD  A,'.'
       0000                     FPR1:
       0000                 17      CALL    MSG_A
       0000                  7      LD  B,3
                                
       0000                     P_N1:
       0000                 11      PUSH    BC
       0000                 11      PUSH    HL
       0000                  7      LD  A,(HL)
       0000                 17      CALL    CAP3
       0000                 17      CALL    MSG_A
       0000                 10      POP HL
       0000                 10      POP BC
       0000                  6      INC HL
       0000                 13      DJNZ    P_N1
       0000                 10      RET
                                
       0000                     PRTTMS:
       0000                  7      LD  A,020H
       0000                 17      CALL    MSG_A
                                
       0000                 16      LD  HL,(DTA_CCP+1+24)
       0000                  4      LD  A,L
       0000                  4      OR  A
       0000                 11      RET Z
       0000                  8      SRL H
       0000                  4      RLA
       0000                  4      RLA
       0000                  4      RLA
       0000                  4      RLA
       0000                  7      AND 00FH
       0000                  4      LD  D,A
       0000                  4      LD  A,H
       0000                  7      ADD A,80
       0000                 17      CALL    PRDEC_A
       0000                  7      LD  A,'-'
       0000                 17      CALL    MSG_A
       0000                  4      LD  A,D
       0000                 17      CALL    PRDEC_A
       0000                  7      LD  A,'-'
       0000                 17      CALL    MSG_A
       0000                  4      LD  A,L
       0000                  7      AND 01FH
       0000                 17      CALL    PRDEC_A
                                
       0000                 16      LD  HL,(DTA_CCP+1+22)
                                
       0000                  7      LD  A,020H
       0000                 17      CALL    MSG_A
       0000                  4      LD  A,H
       0000                  4      LD  H,L
       0000                  7      LD  B,3
       0000                     PRTTMS1:
       0000                  4      RRA
       0000                  8      RR  L
       0000                 13      DJNZ    PRTTMS1
       0000                  7      AND 01FH
       0000                 17      CALL    PRDEC_A
       0000                  7      LD  A,':'
       0000                 17      CALL    MSG_A
       0000                  4      LD  A,L
       0000                  4      RRCA
       0000                  4      RRCA
       0000                  7      AND 03FH
       0000                 17      CALL    PRDEC_A
       0000                  7      LD  A,':'
       0000                 17      CALL    MSG_A
       0000                  4      LD  A,H
       0000                  7      AND 01FH
       0000                  4      ADD A,A
                                
                                ;   PRINT10
                                
       0000                     PRDEC_A:
       0000                 11      PUSH    HL
       0000                  7      LD  B,8
       0000                  4      LD  C,A
       0000                  4      XOR A
       0000                     PRTA1:
       0000                  4      RLC C
       0000                  4      ADC A,A
       0000                  4      DAA
       0000                 13      DJNZ    PRTA1
       0000                 10      LD  HL,DECBF
       0000                  7      LD  (HL),A
       0000                  4      XOR A
       0000                 17      CALL    DECX
       0000                 10      POP HL
       0000                 10      RET
                                
       0000                     SETFCB:
       0000                 17      CALL    SPCUT
       0000                  7      LD  A,(DE)
       0000                  7      CP  020H
       0000                 12      JR  C,SETFCBA
       0000                  6      DEC DE
       0000                     SETFCBA:
       0000                  7      LD  B,36
       0000                 10      LD  HL,FCB1
       0000                 11      PUSH    HL
       0000                  4      XOR A
       0000                 17      CALL    FILL_MEMORY
       0000                 10      POP HL
       0000                 11      PUSH    DE
       0000                 17      CALL    _SYS5C      ;(BDOS)ファイル名の解析
       0000                 10      LD  HL,FCB2
       0000                 17      CALL    _SYS5C      ;(BDOS)ファイル名の解析
       0000                 10      POP HL
       0000                 10      LD  BC,05000H
       0000                 10      LD  DE,00081H
       0000                     SETFCB1:
       0000                  7      LD  A,(HL)
       0000                  6      INC HL
       0000                  7      CP  020H
       0000                 12      JR  C,SETFCB2
       0000                  7      LD  (DE),A
       0000                  6      INC DE
       0000                  4      INC C
       0000                 13      DJNZ    SETFCB1
       0000                     SETFCB2:
       0000                  4      LD  A,C
       0000                 13      LD  (DTA1),A
       0000                  4      INC B
       0000                     ZERO_MEMORY_DE:
       0000                  4      XOR A
       0000                     FILL_MEMORY_DE:
       0000                  7      LD  (DE),A
       0000                  6      INC DE
       0000                 13      DJNZ    FILL_MEMORY_DE
       0000                 10      RET
                                
       0000                     C_COPY:
       0000                 17      CALL    SETFCB
       0000                 10      LD  DE,DTA1+1
       0000                  7      LD  C,'/'
       0000                 17      CALL    SWITCH
       0000                 17      CALL    CAP
       0000                 13      LD  (SW+1),A
                                
       0000                 10      LD  DE,BEEPD
       0000                 17      CALL    FILEC2
       0000                 10      LD  HL,FCB2
       0000                 17      CALL    S29X1
                                
       0000                  7      LD  A,010H
       0000                 13      LD  (FCB1+13),A
       0000                 10      LD  HL,FCB2+1
       0000                 17      CALL    CWILD1
       0000                     COPY0:
       0000                 17      CALL    CWILD
       0000                 10      LD  HL,FCB1
       0000                 17      CALL    OPEN
       0000                  4      SCF
       0000                     COPY1:
       0000                 11      RET NZ
       0000                 17      CALL    DEFCB
                                
       0000                 13      LD  A,(DTA_CCP+13)
       0000                  8      BIT 4,A
       0000                 12      JR  Z,COPY1A
                                
       0000                 10      LD  HL,FCB1+1
       0000                 17      CALL    CHKWILD
       0000                 12      JR  C,COPY9
                                
       0000                  7      LD  A,020H
       0000                 13      LD  (FCB1+1),A
       0000                 16      LD  HL,(DTA_CCP+26)
       0000                  6      INC HL
       0000                 16      LD  (FCB1+14),HL
       0000                 12      JR  COPY0
                                
       0000                     COPYS:
       0000                 10      LD  DE,SKIP
       0000                     COPY8:
       0000                 17      CALL    _SYS09      ;(BDOS)文字列出力
       0000                 17      CALL    LTNL
       0000                     COPY9:
       0000                 17      CALL    OPEN2
       0000                 12      JR  COPY1
                                
       0000                     COPY1A:
       0000                 10      LD  HL,FCB2
       0000                 10      LD  DE,FDRV
       0000                 10      LD  BC,DTA_CCP+2
       0000                 16      LDI
       0000                  7      LD  A,11
       0000                     COPY2:
       0000                 11      PUSH    AF
       0000                  7      LD  A,(HL)
       0000                  7      CP  '?'
       0000                 12      JR  NZ,COPY3
       0000                  7      LD  A,(BC)
       0000                     COPY3:
       0000                  7      LD  (DE),A
       0000                  6      INC BC
       0000                  6      INC DE
       0000                  6      INC HL
       0000                 10      POP AF
       0000                  4      DEC A
       0000                 12      JR  NZ,COPY2
       0000                 10      LD  BC,16-11
       0000                         LDIR
       0000                     PUTNAME:
       0000                 10      LD  HL,FCB1+1
       0000                 17      CALL    CHKWILD
       0000                 12      JR  NC,PUTN1
       0000                 10      LD  HL,FDRV+1
       0000                 17      CALL    FPRNT
       0000                  7      LD  A,020H
       0000                 17      CALL    MSG_A
       0000                     PUTN1:
       0000                  7  SW: LD  A,000H
       0000                  7      CP  'T'
       0000                 12      JR  NZ,CSW1
       0000                 10      LD  HL,SWNE
       0000                 12      JR  SWT1
       0000                     CSW1:
       0000                  7      CP  'N'
       0000                 12      JR  NZ,SWNE
       0000                 10      LD  HL,COPYS
       0000                     SWT1:
       0000                 10      LD  DE,FDRV
       0000                 17      CALL    SYSC0F
       0000                 12      JR  Z,SWN1
       0000                  4      JP  (HL)
       0000                     SWN1:
       0000                 17      CALL    CTIME
       0000                 12      JR  NC,COPYS
       0000                     SWNE:
       0000                 10      LD  DE,FDRV
       0000                  7      LD  C,016H      ;(BDOS)ファイルの作成
       0000                 17      CALL    SYSTEM0
       0000                 12      JR  NZ,COPYE2
       0000                  4      LD  H,A     ;A=0
       0000                  4      LD  L,A
       0000                 16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
       0000                 16      LD  (FDRV+35),HL
       0000                     COPY6:
       0000                 17      CALL    S27BUF
       0000                  4      LD  B,A
       0000                  4      INC A
       0000                 12      JR  Z,COPYE
       0000                  4      LD  A,H
       0000                  4      OR  L
       0000                 12      JR  Z,COPY7
       0000                 10      LD  DE,FDRV
       0000                  7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
       0000                 17      CALL    SYSTEM0
       0000                 12      JR  NZ,COPYE
       0000                 13      DJNZ    COPY6
       0000                     COPY7:
       0000                 13      LD  A,(DTA_CCP+13)  ;(FCB)属性
       0000                 13      LD  (FDRV+13),A
       0000                 10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
       0000                 10      LD  DE,FDRV+20
       0000                 10      LD  BC,4
       0000                         LDIR
                                
       0000                 10      LD  DE,FDRV
       0000                  7      LD  C,010H      ;(BDOS)ファイルのクローズ
       0000                 17      CALL    SYSTEM0
       0000                 12      JR  NZ,COPYE
                                
       0000                 10      LD  DE,OK
       0000                 10      JP  COPY8
                                
       0000                     COPYE:
       0000                 10      LD  DE,FDRV
       0000                  7      LD  C,013H      ;(BDOS)ファイルの削除
       0000                 17      CALL    SYSTEM
       0000                     COPYE2:
       0000                  4      SCF
       0000                 10      RET
                                
       0000                     CTIME:
       0000                 20      LD  DE,(DTA_CCP+20)
       0000                 16      LD  HL,(FDRV+20)
       0000                  4      AND A
       0000                 15      SBC HL,DE
       0000                 11      RET NZ
       0000                 20      LD  DE,(DTA_CCP+22)
       0000                 16      LD  HL,(FDRV+22)
       0000                 15      SBC HL,DE
       0000                 10      RET
                                
       0000                     C_TYPE:
       0000                 17      CALL    SETFCB
       0000                 10      LD  HL,FCB1
       0000                 17      CALL    OPEN
       0000                  4      SCF
       0000                     TYPE1:
       0000                 11      RET NZ
       0000                 17      CALL    DEFCB
       0000                  7      LD  A,6
       0000                 17      CALL    MSG_A
       0000                     TYPE2:
       0000                 17      CALL    S27BUF
       0000                  7      ADD A,0FEH
       0000                 11      RET C
       0000                  4      LD  A,H
       0000                  4      OR  L
       0000                 12      JR  Z,TYPEE
       0000                 10      LD  BC,00100H
       0000                     TYPE3:
       0000                  7      LD  A,(BC)
       0000                  6      INC BC
       0000                  7      CP  01AH
       0000                 12      JR  Z,TYPEE
       0000                 17      CALL    MSG_A
       0000                  6      DEC HL
       0000                  4      LD  A,H
       0000                  4      OR  L
       0000                 12      JR  NZ,TYPE3
       0000                 12      JR  TYPE2
       0000                     TYPEE:
       0000                 17      CALL    OPEN2
       0000                 12      JR  TYPE1
                                
       0000                     CWILD:
       0000                 10      LD  HL,FCB1+1
       0000                     CWILD1:
       0000                  7      LD  A,(HL)
       0000                  7      CP  020H
       0000                 11      RET NZ
       0000                     CWILD2:
       0000                  7      LD  A,'?'
       0000                  7      LD  B,11
       0000                 10      JP  FILL_MEMORY
                                
       0000                     DTA_CCP:
                                    DS  37
                                
                                PATHX   EQU 64
                                PATHD:  DS  PATHX
       0000                     PATHE:  DB  0
                                
                                COMS    EQU 9
       0000                     COMTB:
       0000                         DB  "D   "  ;1
       0000                         DW  C_DIR
       0000                         DB  "DIR "  ;2
       0000                         DW  C_DIR
       0000                         DB  "COPY"  ;3
       0000                         DW  C_COPY
       0000                         DB  "CD  "  ;4
       0000                         DW  C_CD
       0000                         DB  "DEL "  ;5
       0000                         DW  C_DEL
       0000                         DB  "PATH"  ;6
       0000                         DW  C_PATH
       0000                         DB  "REN "  ;7
       0000                         DW  C_REN
       0000                         DB  "TYPE"  ;8
       0000                         DW  C_TYPE
       0000                         DB  "REM "  ;9
       0000                         DW  C_REM
                                
       0000                     FREE:   DB  " bytes free",9,'$'
       0000                     DIRMES: DB  "     <DIR>$"
       0000                     DIRHD:  DB  "  :$"
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       0000                     BDOS0:
       0000                 11      PUSH    HL
       0000                 10      LD  HL,00100H
       0000                 11      ADD HL,SP
       0000                 12      JR  C,BDOS1X
       0000                     BDOS2:
       0000                 10      POP HL
       0000                 20      LD  (BDSP+1),SP
       0000                 10      LD  SP,EXTSP
       0000                 17      CALL    BDOS1
       0000                 10  BDSP:   LD  SP,0
       0000                 10      RET
       0000                     BDOS1:
       0000                 11      PUSH    HL
       0000                     BDOS1X:
       0000                  4      LD  A,C
       0000                  7      CP  03CH
       0000                 12      JR  C,DOS1
       0000                  7      LD  A,03CH
       0000                     DOS1:
       0000                  4      ADD A,A
       0000                  4      LD  L,A
       0000                  7      LD  H,STABLE/256
       0000                  7      LD  A,(HL)
       0000                  4      INC L
       0000                  7      LD  H,(HL)
       0000                  4      LD  L,A
       0000                 19      EX  (SP),HL
       0000                  4      LD  A,C
       0000                 10      RET
       0000                     _DOS2:
       0000                  7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
       0000                 10      JP  Z,_SYS5A
       0000                  7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
       0000                 10      JP  Z,_SYS5C
       0000                  7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
       0000                 10      JP  Z,_SYS5F
       0000                  7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
       0000                 12      JR  NZ,_ERROR
       0000                 10      LD  BC,011DH
       0000                 10      LD  DE,VER
       0000                 10      LD  HL,MACD
       0000                  4      XOR A
       0000                     _ERROR:
       0000                  4      AND A
       0000                 10      RET
                                
       0000                     _SYS09:     ;文字列出力
       0000                 11      PUSH    DE
       0000                     _SX09:
       0000                  7      LD  A,(DE)
       0000                  6      INC DE
       0000                  7      CP  '$'
       0000                 12      JR  Z,SX0E2
       0000                 17      CALL    MSG_A
       0000                 12      JR  _SX09
                                
       0000                     MSX1:
       0000                 17      CALL    MSG_A
       0000                     MSX:
       0000                  7      LD  A,(HL)
       0000                  6      INC HL
       0000                  4      OR  A
       0000                 12      JR  NZ,MSX1
       0000                 10      RET
                                
       0000                     _SYS0C:     ;(BDOS)バージョン番号の獲得
       0000                 10      LD  HL,00022H
       0000                  4      LD  A,L
       0000                 10      RET
                                
       0000                     _SYS0D:     ;(BDOS)ディスクリセット
       0000                 17      CALL    _FFLUSH
       0000                 11      PUSH    HL
       0000                 10      LD  HL,00080H
       0000                 16      LD  (_DTA),HL
       0000                 10      POP HL
       0000                 11      PUSH    DE
       0000                  7      LD  E,0
       0000                         DB  03EH
                                
       0000                     _SYS0E:     ;(BDOS)カレントドライブの設定
       0000                 11      PUSH    DE
       0000                  4      LD  A,E
       0000                 15      PUSH    IX
       0000                 17      CALL    _GETDPB
       0000                 14      POP IX
       0000                 12      JR  C,SX0E2
       0000                  4      LD  A,E
       0000                 13      LD  (_DVSW),A
       0000                     SX0E2:
       0000                  7      LD  A,8
       0000                 10      POP DE
       0000                 10      RET
                                
       0000                     _SYS0F:     ;(BDOS)ファイルのオープン
       0000                 17      CALL    SETDRV
       0000                 19      LD  A,(IY+28)   ;(FCB)オープンモード
       0000                  7      ADD A,002H      ;Write
       0000                 12      JR  Z,FEND0F
       0000                 17      CALL    CHKWILDX
                                
       0000                 17      CALL    NC,SOPENX
       0000                     _S16XX:
       0000                 12      JR  C,FEND0F
                                                ;Directory location
       0000                 13      LD  A,(_FILEN)
       0000                 19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
       0000                 13      LD  A,(_DIRF)
       0000                 19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
       0000                 19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
       0000                 19      LD  (IY+31),D
                                ;               Open(Read)
       0000                 19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
       0000                 15      PUSH    IY
       0000                 10      POP DE
       0000                  6      INC DE
       0000                 10      LD  BC,11
       0000                         LDIR
                                ;               Attribute
       0000                  7      LD  A,(HL)
       0000                 19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
       0000                 10      LD  DE,11       ;Reserved
       0000                 11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
       0000                 10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
       0000                  7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       0000                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
       0000                  7      LD  A,(DE)
       0000                  6      INC DE
       0000                 13      LD  (S16PAT+2),A
       0000                  7      LD  A,(HL)
       0000                  6      INC HL
       0000                 19  S16PAT: LD  (IY+0),A
       0000                 13      DJNZ    S16LOOP
                                
       0000                  4      XOR A
       0000                 19      LD  (IY+12),A   ;(FCB)カレントブロック
       0000                 20      LD  (OFCB+1),IY
       0000                     FEND0F:
       0000                 12      JR  FEND10
                                
       0000                     _SYS10:     ;(BDOS)ファイルのクローズ
       0000                 17      CALL    SETDRV
       0000                 19      LD  A,(IY+28)   ;(FCB)オープンモード
       0000                  7      SUB 0FEH
       0000                  4      SCF
       0000                  4      CCF
       0000                 12      JR  NZ,FEND10
       0000                     _S10A:              ;Write
       0000                 19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
       0000                 19      LD  (IY+15),A
                                
       0000                 23      INC (IY+28)     ;0FEH->0FFH ;オープンモード
       0000                 17      CALL    SETTMS
                                
       0000                 19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
       0000                 13      LD  (_DIRF),A
       0000                  7      AND 07FH
       0000                 13      LD  (_SECPS+1),A
       0000                 19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
       0000                 19      LD  D,(IY+31)
       0000                 17      CALL    READ_DIR
       0000                 12      JR  C,FEND10
                                
       0000                 13  SDECM1: LD  A,(SDECPAT+1)   ;1セクタ辺りのディレクトリエントリ数
       0000                  4      DEC A       ;1024=01FH / 512=00FH / 256=7
       0000                 19      AND (IY+25)     ;(FCB)ディレクトリロケーション
       0000                  4      LD  L,A
       0000                  7      LD  H,0
       0000                 11      ADD HL,HL       ;*2
       0000                 11      ADD HL,HL       ;*4
       0000                 11      ADD HL,HL       ;*8
       0000                 11      ADD HL,HL       ;*16
       0000                 11      ADD HL,HL       ;*32
       0000                 20      LD  BC,(_DTBUF)
       0000                 11      ADD HL,BC
                                
       0000                 17      CALL    SDIRENT
       0000                     FEND10:
       0000                 12      JR  FEND
                                
       0000                     _SYS11:     ;(BDOS)最初のファイルの検索
       0000                 17      CALL    SETDRV
       0000                 17      CALL    SOPEN
       0000                     _S12X1:
       0000                 12      JR  C,FEND
       0000                 17      CALL    SOPENE2
       0000                 20      LD  DE,(_DTA)
       0000                 13      LD  A,(_DRV)
       0000                  4      INC A
       0000                  7      LD  (DE),A
       0000                 11      PUSH    DE
       0000                  6      INC DE
       0000                 10      LD  BC,32
       0000                         LDIR
       0000                 19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
       0000                 19      LD  H,(IY+15)
       0000                 16      LD  (SCDIR),HL
       0000                 16      LD  HL,(_FBPS)
       0000                 16      LD  (SFBPS),HL
       0000                 16      LD  HL,(_FILEN)
       0000                  4      LD  A,H
       0000                  4      OR  A
       0000                 12      JR  Z,_S12DIR
       0000                 13      LD  A,(_SECPS+1)
       0000                  7      OR  080H
       0000                  4      LD  H,A
       0000                     _S12DIR:
       0000                 16      LD  (SFNDF),HL  ;Directory position and Flags
       0000                 10      POP HL
       0000                 10      LD  DE,SFILE
       0000                  7      LD  C,33
       0000                     _S11B:
       0000                         LDIR
       0000                     FEND:
       0000                  4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       0000                     FENDE:
       0000                 14      POP IY
       0000                 10      POP BC
       0000                 10      POP DE
       0000                 10      POP HL
       0000                 10      RET
                                
       0000                     _SYS12:     ;(BDOS)次のファイルの検索
       0000                 11      PUSH    HL
       0000                 11      PUSH    DE
       0000                 11      PUSH    BC
       0000                 15      PUSH    IY
       0000                 17      CALL    NOPEN
       0000                 12      JR  _S12X1
                                
       0000                     _S16K:
       0000                 19      LD  A,(IY+28)   ;(FCB)オープンモード
       0000                  7      CP  0FDH        ;Device(0FDH)
       0000                  4      SCF
       0000                 11      RET Z
                                
       0000                 10  OFCB:   LD  DE,0
       0000                 11      PUSH    DE
       0000                  7      LD  B,26        ;First cluster
       0000                     S16K1:
       0000                  6      INC DE
       0000                  6      INC HL
       0000                 13      DJNZ    S16K1
                                
       0000                  7      LD  A,(DE)
       0000                  7      CP  (HL)
       0000                 12      JR  NZ,S16K2
       0000                  6      INC DE
       0000                  6      INC HL
       0000                  7      LD  A,(DE)
       0000                  7      CP  (HL)
       0000                 12      JR  NZ,S16K2
                                
       0000                 10      POP HL
       0000                 15      PUSH    IY
       0000                 10      POP DE
       0000                  7      LD  A,(DE)      ;Drive
       0000                  7      CP  (HL)
       0000                 12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
       0000                 15      SBC HL,DE       ;CP HL,DE
       0000                  4      SCF
       0000                 11      RET NZ
       0000                 11      PUSH    HL
       0000                     S16K2:
       0000                 10      POP HL
       0000                     S16K3:
       0000                 15      PUSH    IY
       0000                 10      POP DE
       0000                     _SYS13:     ;(BDOS)ファイルの削除
       0000                 17      CALL    SETDRV
       0000                 17      CALL    KILL
       0000                     FEND13:
       0000                 12      JR  FEND
                                
       0000                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
       0000                 17      CALL    SETDRV
       0000                 17      CALL    PUSHRR
       0000                 17      CALL    GETSEQ
                                
       0000                 17      CALL    RB_READ
       0000                 11      PUSH    HL
       0000                 17      CALL    SETSEQ
       0000                     SREAD:
       0000                 10      POP HL
                                
       0000                  7      ADD A,001H
       0000                 12      JR  C,FEND
                                
       0000                  4      LD  A,L
       0000                  7      SUB 001H
       0000                     FENDX:
       0000                  4      SBC A,A
       0000                  7      AND 3
       0000                  4      RRA
       0000                 12      JR  FENDE
                                
       0000                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
       0000                 17      CALL    SETDRV
       0000                 17      CALL    PUSHRR
       0000                 17      CALL    GETSEQ
                                
       0000                 17      CALL    RB_WRITE
       0000                 11      PUSH    HL
       0000                 17      CALL    SETSEQ
       0000                     SWRITE:
       0000                 10      POP HL
                                
       0000                  7      ADD A,0FFH
       0000                 12      JR  FENDX
                                
       0000                     _SYS17:     ;(BDOS)ファイル名の変更
       0000                 17      CALL    SETDRV
       0000                 17      CALL    NAME
       0000                 12      JR  FEND13
                                
       0000                     _SYS16:     ;(BDOS)ファイルの作成
       0000                 17      CALL    SETDRV
                                
       0000                 17      CALL    CHKWILDX
       0000                 12      JR  C,FEND13
       0000                 19      LD  A,(IY+1)    ;(FCB)主ファイル名
       0000                  7      CP  5
       0000                 12      JR  Z,_S16X2
       0000                  7      CP  021H
       0000                 10      JP  C,FEND13
       0000                     _S16X2:
                                ;               Clear FCB
       0000                 15      PUSH    IY
       0000                 10      POP HL
       0000                 10      LD  BC,16
       0000                 11      ADD HL,BC
       0000                     _S16X1:
       0000                  7      LD  (HL),B      ;B=0
       0000                  6      INC HL
       0000                  4      DEC C
       0000                 12      JR  NZ,_S16X1
                                
       0000                 17      CALL    SETTMSX
       0000                 19      LD  (IY+13),0FFH    ;(FCB)Attribute
       0000                 17      CALL    SOPENX
       0000                  4      CCF
       0000                 17      CALL    Z,_S16K
       0000                 17      CALL    NC,COPEN
       0000                 17      CALL    NC,SDIRENT
       0000                 10      JP  _S16XX
                                
       0000                     _SYS21:     ;(BDOS)ランダムな読み出し
                                
       0000                 17      CALL    SETDRV
       0000                 17      CALL    PUSHRR
       0000                 19      LD  L,(IY+33)   ;(FCB)Random record
       0000                 19      LD  H,(IY+34)
                                
       0000                 17      CALL    RB_READ
       0000                 11      PUSH    HL
       0000                 17      CALL    POPRR
       0000                 12      JR  SREAD
                                
       0000                     _SYS22:     ;(BDOS)ランダムな書き込み
       0000                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
       0000                 17      CALL    SETDRV
       0000                 17      CALL    PUSHRR
       0000                 19      LD  L,(IY+33)   ;(FCB)Random record
       0000                 19      LD  H,(IY+34)
                                
       0000                 17      CALL    RB_WRITE
       0000                 11      PUSH    HL
       0000                 17      CALL    POPRR
       0000                 12      JR  SWRITE
                                
       0000                     _SYS18:     ;(BDOS)ログインベクトルの獲得
       0000                 10      LD  HL,000FFH
       0000                  4      XOR A
       0000                 10      RET
                                
       0000                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
       0000                 13      LD  A,(_DVSW)
       0000                  4      AND A
       0000                 10      RET
                                
       0000                     _SYS1A:     ;(BDOS)DTAの設定
       0000                 20      LD  (_DTA),DE
       0000                  4      XOR A
       0000                 10      RET
                                
       0000                     _SYS1B:     ;(BDOS)ディスク情報の獲得
       0000                  4      LD  A,E
       0000                 17      CALL    GETDRV
       0000                 17      CALL    _GETDPB
       0000                 17      CALL    NC,_RDFATX
       0000                 10      LD  HL,0
       0000                 17      CALL    NC,DSKF
                                
       0000                 20      LD  DE,(MAXCLP+1)   ;DPB_08_MAXCL-1
       0000                  6      DEC DE      ;DE←クラスタの総数
       0000                 20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
       0000                  4      SBC A,A
       0000                 11      RET C
       0000                  4      LD  C,A     ;C=0
       0000                 19      LD  A,(IX+00FH) ;DPB_0F_BPS
       0000                  7      AND 00FH
       0000                  4      LD  B,A
       0000                 19      LD  A,(IX+7)    ;DPB_07_SECPCL
       0000                 10      RET
                                
       0000                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
       0000                  4      XOR A
       0000                  4      LD  H,A
       0000                  4      LD  L,A
       0000                 10      RET
                                
       0000                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
       0000                 10      LD  HL,DEVICE
       0000                  4      LD  A,E
       0000                 10      JP  _GETDPB
                                
       0000                     _SYS23:     ;(BDOS)ファイルサイズの獲得
       0000                 11      PUSH    HL
       0000                 16      LD  HL,(STABLE+2*00FH)  ;ファイルのオープン
       0000                 17      CALL    JP_HL
       0000                 12      JR  C,_S23X1
                                
       0000                 11      PUSH    DE      ;EX DE,IY
       0000                 23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
       0000                 17      CALL    GETSIZE
       0000                     _S24X1:
       0000                 19      LD  (IY+33),L   ;(FCB)Random record
       0000                 19      LD  (IY+34),H
       0000                 19      LD  (IY+35),0
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
       0000                 23      EX  (SP),IY     ;
       0000                 10      POP DE      ;
                                
       0000                  4      XOR A
       0000                     _S23X1:
       0000                 10      POP HL
       0000                 10      RET
                                
       0000                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
       0000                 11      PUSH    HL
       0000                 11      PUSH    DE      ;EX DE,IY
       0000                 23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
       0000                 17      CALL    GETSEQ
       0000                 12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       0000                     _SYS5C:     ;(BDOS)ファイル名の解析
       0000                 11      PUSH    BC
       0000                 11      PUSH    HL
       0000                 17      CALL    FILE
       0000                 10      POP HL
       0000                 10      POP BC
       0000                     S29X1:
       0000                 11      PUSH    BC
       0000                 11      PUSH    DE
       0000                 11      PUSH    HL
       0000                  4      EX  DE,HL
       0000                 10      LD  HL,FDRV
       0000                 10      LD  BC,13
       0000                         LDIR
       0000                  7      LD  (HL),B      ;B=0
       0000                  7      LD  C,3
       0000                         LDIR
       0000                 10      POP HL
       0000                 10      POP DE
       0000                 10      POP BC
       0000                  4      XOR A
       0000                 10      RET
                                
       0000                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
       0000                 11      PUSH    BC
       0000                 10      LD  BC,DWT24B
       0000                 12      JR  S2FX
       0000                     _SYS2F:
       0000                 11      PUSH    BC
       0000                 10      LD  BC,DRD24B
       0000                     S2FX:
       0000                 20      LD  (S2FPAT+1),BC
       0000                 17      CALL    _FFLUSH
                                
       0000                 11      PUSH    DE
       0000                 11      PUSH    HL
       0000                  4      LD  A,L     ;Drive
       0000                 17      CALL    _CHGDRV
       0000                 12      JR  C,S30X2
       0000                  4      LD  B,H     ;Number of clusters
       0000                 16      LD  HL,(_DTA)
                                
       0000                  7      LD  C,0
       0000                 17  S2FPAT: CALL    DRD24B
       0000                     S30X2:
       0000                 10      POP HL
       0000                 10      POP DE
       0000                 10      POP BC
       0000                  4      SBC A,A
       0000                 10      RET
                                
       0000                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
       0000                 11      PUSH    BC
       0000                 11      PUSH    DE
       0000                 11      PUSH    HL
       0000                 17      CALL    FILEC
       0000                 10      LD  HL,0
       0000                 10      LD  DE,FDRV
       0000                 16      LD  HL,(STABLE+2*027H)  ;ランダムブロック読み込み
       0000                 17      CALL    JP_HL
       0000                 12      JR  S30X2
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
       0000                     FILEC:
       0000                 17      CALL    FILE
       0000                     FILEC2:
       0000                 13      LD  A,(FDRV+1)
       0000                  7      CP  020H
       0000                 11      RET Z
       0000                 12      JR  SETDIR1
                                
       0000                     FILE:
       0000                  4      XOR A
       0000                 13      LD  (FDRV),A
       0000                  4      LD  H,A
       0000                  4      LD  L,A
       0000                 16      LD  (FDRV+14),HL
       0000                 17      CALL    SPCUT
       0000                 17      CALL    CCHK3
       0000                 12      JR  Z,DEVI1
       0000                  6      INC DE
       0000                  7      LD  A,(DE)
       0000                  6      DEC DE
       0000                  7      CP  ':'
       0000                 12      JR  NZ,DEVI1
       0000                  7      LD  A,(DE)      ;DRIVE
       0000                 17      CALL    CAP
       0000                  7      SUB '@'
       0000                  6      INC DE
       0000                  6      INC DE
       0000                 13      LD  (FDRV),A
       0000                     DEVI1:
       0000                  7      LD  A,(DE)
       0000                  7      SUB 05CH        ;\
       0000                 12      JR  NZ,NOROOT
       0000                  4      LD  L,A     ;A=0でH=0のはずなのでHL=0
       0000                 16      LD  (FDRV+26),HL
       0000                  4      INC L
       0000                 16      LD  (FDRV+14),HL
       0000                  6      INC DE
       0000                     NOROOT:
                                
       0000                     SETDIR:
       0000                 17      CALL    FILED
       0000                  7      LD  A,(DE)
       0000                  7      CP  05CH        ;\
       0000                 11      RET NZ
       0000                  6      INC DE
       0000                     SETDIR1:
       0000                  7      LD  A,010H      ;Directory
       0000                 13      LD  (FDRV+13),A
       0000                 11      PUSH    DE
       0000                 10      LD  DE,FDRV
       0000                 16      LD  HL,(STABLE+2*00FH)
       0000                 17      CALL    JP_HL
       0000                 10      POP DE
       0000                  4      OR  A
       0000                 11      RET NZ
                                
       0000                 13      LD  A,(FDRV+13)
       0000                  8      BIT 4,A
       0000                 11      RET Z
                                
       0000                 17      CALL    FILEI
       0000                 16      LD  HL,(FDRV+26)
       0000                  6      INC HL
       0000                 16      LD  (FDRV+14),HL
       0000                 12      JR  SETDIR
                                
       0000                     FILED:
       0000                 17      CALL    FILEI
       0000                 10      LD  HL,FNAME
                                
       0000                  7      LD  B,8
       0000                     FILE2:
       0000                 17      CALL    CCHKF
       0000                 11      RET Z
       0000                  7      CP  '*'
       0000                 12      JR  Z,FILE9
       0000                  7      CP  '.'
       0000                 12      JR  Z,FILE4
       0000                  7      LD  (HL),A
       0000                  6      INC HL
       0000                 13      DJNZ    FILE2
                                
       0000                     FILE3:
       0000                 17      CALL    CCHKF
       0000                 11      RET Z
       0000                  7      CP  '.'
       0000                 12      JR  NZ,FILE3
                                
       0000                     FILE4:
       0000                 10      LD  HL,FNAME+8
       0000                  7      LD  B,3
                                
       0000                     FILE4L:
       0000                 17      CALL    CCHKF
       0000                 11      RET Z
       0000                  7      CP  '.'
       0000                 12      JR  NZ,FILE12
       0000                 13      LD  (FNAME),A   ;Parent directory(..)
       0000                 13      LD  (FNAME+1),A
       0000                  7      LD  A,020H
       0000                     FILE12:
       0000                  7      CP  '*'
       0000                 12      JR  Z,FILE10
       0000                  7      LD  (HL),A
       0000                  6      INC HL
       0000                 13      DJNZ    FILE4L
       0000                 10      RET
                                
       0000                     FILE9:              ;名前の*処理、名前の残りを?で埋める
       0000                 17      CALL    FILE10
       0000                 12      JR  FILE3
                                
       0000                     FILE10:
       0000                  7      LD  A,'?'
       0000                 12      JR  FILL_MEMORY
       0000                     FILEI:              ;名前＋拡張子をスペースで初期化
       0000                  7      LD  A,020H
       0000                 10      LD  BC,11*256   ;C=0にしておく
       0000                 10      LD  HL,FNAME
       0000                     FILL_MEMORY:            ;HLからBバイトAで埋める
       0000                  7      LD  (HL),A
       0000                  6      INC HL
       0000                 13      DJNZ    FILL_MEMORY
       0000                 10      RET
                                
       0000                     CCHKF:
       0000                  7      LD  A,(DE)
       0000                 17      CALL    CCHK2
       0000                 11      RET Z
       0000                 10      JP  FKAN
                                
       0000                     CCHK2:
       0000                  4      INC C
       0000                  4      DEC C
       0000                 11      RET NZ
       0000                     CCHK3:              ;ZF=1 で使えない文字
       0000                  7      CP  '+'
       0000                 11      RET Z
       0000                  7      CP  ','
       0000                 11      RET Z
       0000                  7      CP  '/'
       0000                 11      RET Z
       0000                  7      CP  ':'
       0000                 11      RET Z
       0000                  7      CP  ';'
       0000                 11      RET Z
       0000                  7      CP  '='
       0000                 11      RET Z
       0000                  7      CP  05CH    ;\
       0000                 11      RET Z
       0000                  7      CP  020H
       0000                 11      RET NC
       0000                  4      CP  A       ;Z=1
       0000                 10      RET
                                
       0000                     SS1:
       0000                  6      INC DE
       0000                     SPCUT:              ;スペースをカット
       0000                  7      LD  A,(DE)
       0000                  7      CP  020H
       0000                 12      JR  Z,SS1
       0000                 10      RET
                                
       0000                     SETDRVF:
       0000                 10      LD  DE,FDRV
       0000                     SETDRV0:
       0000                 17      CALL    SETDRV
       0000                 14      POP IY
       0000                 10      POP BC
       0000                 10      POP DE
       0000                 10      POP HL
       0000                 10      RET
                                
       0000                     SETDRV:
       0000                 19      EX  (SP),HL     ;HL=RETRN ADDRESS
       0000                 11      PUSH    DE      ;PUSH HL/DE/BC/IY
       0000                 11      PUSH    BC
       0000                  7      LD  A,(DE)
       0000                 11      PUSH    DE
       0000                 23      EX  (SP),IY
                                
       0000                 17      CALL    GETDRV
       0000                  4      INC A
       0000                 19      LD  (IY+0),A    ;(FCB)ドライブ番号
       0000                  4      DEC A
       0000                 17      CALL    _CHGDRV
                                
       0000                  4      JP  (HL)
                                
       0000                     GETDRV:
       0000                  7      AND 07FH
       0000                  7      SUB 001H
       0000                 12      JR  NC,GETDRV1
       0000                 13      LD  A,(_DVSW)   ;Current Drive
       0000                     GETDRV1:
       0000                 13      LD  (_DRV),A
       0000                 10      RET
                                
       0000                     SOPENX:
       0000                 10      LD  DE,SFILE
       0000                  7      LD  A,(DE)
       0000                  7      CP  (IY+0)      ;(FCB)ドライブ番号
       0000                 12      JR  NZ,SOPEN
       0000                  6      INC DE
       0000                 15      PUSH    IY
       0000                 10      POP HL
       0000                  6      INC HL
       0000                 17      CALL    CPFILE
       0000                 12      JR  NZ,SOPEN
                                
       0000                 16      LD  HL,(SCDIR)
       0000                 19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
       0000                 19      LD  (IY+15),H
                                
       0000                 16      LD  HL,(SFNDF)  ;Direcroty location and Flags
       0000                 16      LD  (_FILEN),HL
                                
       0000                 20      LD  DE,(SFBPS)
       0000                 10      LD  HL,SFILE
       0000                 10      LD  (HL),0FFH
       0000                  6      INC HL
       0000                 10      RET
       0000                     SOPEN:
       0000                 10      LD  HL,FILESE
       0000                     SOPENC:
       0000                 16      LD  (OPENPAT+1),HL
                                
       0000                 17      CALL    _RDFATX     ;Detect Media
       0000                 12      JR  C,RDDERR
                                
       0000                  4      XOR A
       0000                 13      LD  (_FILEN),A
       0000                 17      CALL    LDDIRX1     ;A=0で呼び出す
       0000                 12      JR  Z,SDIRX1
                                
       0000                 17      CALL    READ_DIR    ;Sub Directory
       0000                 12      JR  C,SDIRX0
       0000                 16      LD  HL,(_DTBUF)
       0000                  7      LD  A,(HL)
       0000                  7      CP  '.'
       0000                 12      JR  Z,SOPEN1
       0000                     SDIRX0:
       0000                  4      XOR A
       0000                 13      LD  (_DIRF),A
       0000                 19      LD  (IY+14),1   ;(FCB)レコードサイズ
       0000                 19      LD  (IY+15),A
       0000                     SDIRX1:
       0000                 20      LD  DE,(_DIRPS) ;Root Directory
       0000                     SOPEN1:
       0000                  7  SDECPAT:LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       0000                     SOPEN1X:
       0000                 17      CALL    READ_DIR    ;FILE SEARCH
       0000                 12      JR  C,RDDERR
       0000                 16      LD  HL,(_DTBUF)
       0000                     SOPEN2:
       0000                 11      PUSH    DE
       0000                 17  OPENPAT:CALL    FILESE      ;(self-modifying code)
       0000                 10      POP DE
       0000                 12      JR  C,SOPENE
       0000                 12      JR  Z,SCF_FF_RET
       0000                     SOPEN3:
       0000                 13      LD  A,(_DIRF)   ;ディレクトリか判別
       0000                  4      OR  A
       0000                 12      JR  NZ,SOPEN5
       0000                  6      INC DE      ;ルートディレクトリ
       0000                 11      PUSH    HL
       0000                 10  MD_PAT: LD  HL,12       ;(self-modifying code)MAXDIR
       0000                 15      SBC HL,DE       ;CF=0 なので SUB HL,DE
       0000                 10      POP HL
       0000                 12      JR  NZ,SOPEN1
       0000                 12      JR  SOPEN6
       0000                     SOPEN5:
       0000                 17      CALL    GNCLX       ;END DIR
       0000                 11      RET C
       0000                 17      CALL    ENDCL
       0000                     SOPEN6:
       0000                 12      JR  C,SOPEN1
       0000                     SCF_FF_RET:
       0000                  4      SCF         ;CF=1
       0000                  4      SBC A,A     ;A=0FFH
       0000                 10      RET
                                
       0000                     RDDERR:
       0000                  4      CP  A       ;READ ERR CF=1 ZF=1
       0000                  4      SCF
       0000                 10      RET
                                
       0000                     NOPEN:
       0000                 10      LD  HL,FILESE
       0000                 16      LD  (OPENPAT+1),HL
       0000                 20      LD  IY,(_FCB)
       0000                 17      CALL    CHKWILDX
       0000                 12      JR  NC,SCF_FF_RET
       0000                 19      LD  A,(IY+0)    ;(FCB)ドライブ番号
       0000                  4      DEC A
       0000                 13      LD  (_DRV),A
       0000                 17      CALL    _CHGDRV
       0000                 11      RET C
       0000                 16      LD  HL,(SFNDF)  ;Direcroty location and Flags
       0000                 16      LD  (_FILEN),HL
                                
       0000                 17      CALL    LDDIRX
       0000                 20      LD  DE,(_FBPS)
       0000                 17      CALL    READ_DIR
       0000                 12      JR  C,RDDERR
       0000                 13      LD  A,(_FBCNT)
       0000                  4      DEC A
       0000                 12      JR  Z,SOPEN3
       0000                     NOPEN2:
       0000                 16      LD  HL,(_FBAD)
       0000                 10      LD  BC,020H
       0000                 11      ADD HL,BC
       0000                  4      LD  C,A
       0000                 12      JR  SOPEN2
                                
       0000                     SOPENE2:
       0000                 16      LD  (_FBAD),HL
       0000                  4      LD  A,C
       0000                 13      LD  (_FBCNT),A
       0000                 20      LD  (_FBPS),DE
       0000                 20      LD  (_FCB),IY
       0000                     SOPENE:
       0000                  4      XOR A
       0000                 10      RET
                                
       0000                     COPEN:
       0000                 19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
       0000                 10      LD  HL,NEXTSE
       0000                 17      CALL    SOPENC
       0000                 11      RET NC
       0000                 11      RET Z
       0000                 13      LD  A,(_DIRF)   ;ディレクトリか判別
       0000                  4      OR  A
       0000                  4      SCF
       0000                 11      RET Z       ;ルートディレクトリ
       0000                  7      LD  B,1
       0000                 17      CALL    WRDF
       0000                 11      RET C
       0000                 20      LD  DE,(_CLPS)
       0000                 11      PUSH    DE
       0000                 17      CALL    DCPAT
       0000                 17      CALL    DRDNX
       0000                 16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
       0000                 13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       0000                  4      LD  B,A
       0000                  4      XOR A
       0000                  4      LD  C,A
       0000                     COPENCL:
       0000                  7      LD  (HL),A
       0000                 16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
       0000                 10      JP  PE,COPENCL
                                
       0000                 13      LD  A,(SPCPAT+1)    ;1クラスタの論理セクタ数
       0000                  4      DEC A
       0000                 12      JR  Z,COPENE
       0000                  7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
       0000                 13      LD  (_SECPS+1),A
       0000                 10      POP DE      ;DE=(_CLPS)
       0000                 11      PUSH    DE
       0000                     COPEN1:
       0000                 11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
       0000                 11      PUSH    BC
       0000                 16      LD  HL,(_DTBUF)
       0000                 17      CALL    CLUSTX
       0000                 17      CALL    DWT24
       0000                 10      POP BC
       0000                 10      POP DE
       0000                 17      CALL    NEXTX
       0000                 12      JR  NZ,COPEN1
       0000                     COPENE:
       0000                 16      LD  HL,(_DTBUF)
       0000                 10      POP DE
       0000                 10      RET
                                
       0000                     READ_DIR:
       0000                 20      LD  (_CLPS),DE
       0000                 11      PUSH    BC
       0000                 11      PUSH    DE
       0000                 17      CALL    DCPAT
       0000                 17      CALL    DRDX
       0000                 10      POP DE
       0000                 10      POP BC
       0000                 10      RET
                                
       0000                     FILESE:
       0000                  7      LD  A,(HL)
       0000                  4      OR  A
       0000                 11      RET Z       ;END:ZF=1 CF=0
       0000                  7      CP  0E5H
       0000                 12      JR  Z,FILESE1
       0000                 15      PUSH    IY
       0000                 10      POP DE
       0000                  6      INC DE
       0000                 11      PUSH    HL
       0000                 17      CALL    CPFILE
       0000                 17      CALL    Z,CPFILE2
       0000                 10      POP HL
       0000                  4      SCF
       0000                 11      RET Z       ;!!!:(ZF=1) CF=1
       0000                     FILESE1:
       0000                 17      CALL    FNEXT
       0000                 12      JR  NZ,FILESE
       0000                     ZF0_CF0_AFF_RET:
       0000                  7      OR  0FFH        ;ZF=0 CF=0
       0000                 10      RET
                                
       0000                     NEXTSE:
       0000                  7      LD  A,(HL)
       0000                  4      OR  A
       0000                  4      SCF
       0000                 11      RET Z       ;!!!:ZF=1 CF=1
       0000                  7      CP  0E5H
       0000                  4      SCF
       0000                 11      RET Z       ;!!!:(ZF=1) CF=1
       0000                 17      CALL    FNEXT
       0000                 12      JR  NZ,NEXTSE
       0000                 12      JR  ZF0_CF0_AFF_RET
                                
       0000                     FNEXT:
       0000                 11      PUSH    HL
       0000                 10      LD  HL,_FILEN
       0000                 11      INC (HL)
       0000                 10      POP HL
       0000                 10      LD  DE,020H
       0000                 11      ADD HL,DE
       0000                  4      DEC C
       0000                 10      RET
                                
       0000                     CPNAME:
       0000                 11      PUSH    BC
       0000                 11      PUSH    DE
       0000                 11      PUSH    HL
       0000                 17      CALL    CPFILE4
       0000                 10      POP HL
       0000                  6      INC HL
       0000                  6      INC HL
       0000                  6      INC HL
       0000                  6      INC HL
       0000                 10      POP DE
       0000                 10      POP BC
       0000                 12      JR  NZ,CPNAME1
       0000                  7      LD  A,(HL)
       0000                  6      INC HL
       0000                  7      LD  H,(HL)
       0000                  4      LD  L,A
       0000                 10      RET
       0000                     CPNAME1:
       0000                  6      INC HL
       0000                  6      INC HL
       0000                 13      DJNZ    CPNAME
       0000                  4      SCF
       0000                 10      RET
                                
       0000                     CPFILE4:
       0000                 11      PUSH    BC
       0000                 10      LD  BC,00400H
       0000                 12      JR  CPSTR1
       0000                     CPFILE:
       0000                 11      PUSH    BC
       0000                 10      LD  BC,00B00H
       0000                     CPSTR1:
       0000                  7      LD  A,(DE)
       0000                  7      CP  '?'     ;Wild card
       0000                 12      JR  Z,CPSTR2
       0000                  7      LD  A,(HL)
       0000                 17      CALL    FKANC
       0000                 11      PUSH    HL
       0000                  4      LD  H,A
       0000                  7      LD  A,(DE)
       0000                  4      RLC C
       0000                 17      CALL    FKANC
       0000                  4      RRC C
       0000                  4      CP  H       ;CP (HL),(DE)
       0000                 10      POP HL
       0000                 12      JR  NZ,CPSTR3
       0000                     CPSTR2:
       0000                  6      INC DE
       0000                  6      INC HL
       0000                 13      DJNZ    CPSTR1
       0000                     CPSTR3:
       0000                 10      POP BC
       0000                 10      RET
                                
       0000                     CPFILE2:
       0000                 19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
       0000                  7      OR  0E1H
       0000                  4      CPL
       0000                  7      AND (HL)
       0000                 10      RET
                                
       0000                     DCPAT:
       0000                  7      LD  C,0
       0000                 16      LD  HL,(_DTBUF)
       0000                 13      LD  A,(_DIRF)   ;ディレクトリか判別
       0000                  4      OR  A
       0000                 11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
       0000                 13      LD  A,(SPCPAT+1)
       0000                  4      LD  C,A
       0000                 13      LD  A,(_SECPS+1)
       0000                  4      CP  C
       0000                 12      JR  C,DC1
       0000                  4      XOR A
       0000                     DC1:
       0000                  7      OR  080H
       0000                 13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       0000                     CLUSTX:
       0000                 11      PUSH    HL
       0000                  4      EX  DE,HL
       0000                  4      XOR A
       0000                  7  SPCPAT: LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       0000                     L_CLDBL:
       0000                  8      RR  C       ;->CF
       0000                 12      JR  C,E_CLDBL
       0000                 11      ADD HL,HL       ;*2
       0000                  4      ADC A,A
       0000                 12      JR  L_CLDBL
       0000                     E_CLDBL:
       0000                  4      LD  C,A
       0000                 13      LD  A,(_SECPS+1)
       0000                  4      OR  L
       0000                  4      LD  L,A
       0000                 10  CLSPAT: LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       0000                  4      XOR A
       0000                 11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
       0000                  4      ADC A,C
       0000                  4      LD  C,A
       0000                  4      EX  DE,HL
       0000                 10      POP HL
       0000                 10      RET
                                
       0000                     ENDCL:
       0000                  4      LD  A,D ;END CLUSTER
       0000                  7  CLPAT1: CP  1   ;164=356    (self-modifying code)
       0000                 11      RET NZ
       0000                  4      LD  A,E
       0000                  7  CLPAT2: CP  064H    ;       (self-modifying code)
       0000                 10      RET
                                
       0000                     CAP:
       0000                  7      CP  'a'
       0000                 11      RET C
       0000                  7      CP  'z'+1
       0000                 11      RET NC
       0000                  7      SUB 020H
       0000                 10      RET
       0000                     CAP2:
       0000                 17      CALL    CAP
       0000                     CAP3:
       0000                 17      CALL    CAP4
       0000                  7      CP  021H
       0000                 11      RET NC
       0000                  7      LD  A,0A0H
       0000                 10      RET
       0000                     CAP4:
       0000                  7      CP  5
       0000                 11      RET NZ
       0000                  7      LD  A,0E5H
       0000                 10      RET
                                
       0000                     CHDIR:
       0000                 17      CALL    GETDPBD
       0000                 12      JR  C,CHDIR2
       0000                 19      LD  (IX+01AH),L     ;_SDIR_
       0000                 19      LD  (IX+01BH),H     ;_SDIR_+1
       0000                 12      JR  CHDIR2      ;POP_IX_RET
                                
       0000                     LDDIR:
       0000                 17      CALL    GETDPBD
       0000                 19      LD  E,(IX+01AH)     ;_SDIR_
       0000                 19      LD  D,(IX+01BH)     ;_SDIR_+1
       0000                  6      INC DE
       0000                 19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
       0000                 19      LD  (IY+15),D
       0000                  6      DEC DE
       0000                  4      XOR A
       0000                 13      LD  (_DIRF),A
       0000                     CHDIR2:
       0000                 14      POP IX
       0000                 10      RET
                                
       0000                     LDDIRX:
       0000                 13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
       0000                  7      AND 07FH
       0000                     LDDIRX1:
       0000                 13      LD  (_SECPS+1),A
       0000                 19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
       0000                 19      LD  D,(IY+15)
       0000                  6      DEC DE
       0000                 17      CALL    ENDCL
       0000                 17      CALL    NC,LDDIR
       0000                     LDDIRS:
       0000                  4      LD  A,D
       0000                  4      OR  E
       0000                 13      LD  (_DIRF),A   ;ディレクトリか判別
       0000                 10      RET
                                
       0000                     KILL:
       0000                 17      CALL    CHKWILDX
       0000                 12      JR  C,KILLW
       0000                 17      CALL    SOPENX
       0000                     KILLS:
       0000                  7      LD  A,01FH
       0000                 17      CALL    NC,CHKATT
       0000                 11      RET C
       0000                     KILLSX:
       0000                 10      LD  (HL),0E5H   ;DIR
       0000                 17      CALL    WTDB
       0000                 10      LD  DE,01AH
       0000                 11      ADD HL,DE
       0000                  7      LD  E,(HL)
       0000                  6      INC HL
       0000                  7      LD  D,(HL)
       0000                     KILLS1:
       0000                 17      CALL    ENDCL
       0000                 11      RET NC      ;CF=0
       0000                 10      LD  HL,0-2
       0000                 11      ADD HL,DE
       0000                 11      RET NC      ;DE= 0 or 1
       0000                 11      PUSH    DE
       0000                 17      CALL    _GNCL
       0000                 20      LD  (_CLPS),DE
       0000                 10      POP DE
       0000                 10      LD  HL,0
       0000                 17      CALL    NC,_SNCL
       0000                 11      RET C
       0000                 20      LD  DE,(_CLPS)  ;FAT
       0000                 12      JR  KILLS1
                                
       0000                     KILLW:
       0000                 17      CALL    SOPEN
       0000                     KILLW1:
       0000                 12      JR  C,KILLW2
       0000                 17      CALL    SOPENE2
       0000                 17      CALL    KILLS
       0000                 17      CALL    NOPEN
       0000                 12      JR  KILLW1
       0000                     KILLW2:
       0000                 11      RET Z
       0000                  4      CCF
       0000                 10      RET
                                
       0000                     CHKATT:
       0000                 11      PUSH    HL
       0000                 10      LD  DE,00BH
       0000                 11      ADD HL,DE
       0000                  7      AND (HL)
       0000                 10      POP HL
       0000                 11      RET Z
       0000                  4      SCF
       0000                 10      RET
                                
       0000                     NAME:
       0000                 17      CALL    CHKWILDX
       0000                 11      RET C
       0000                 10      LD  DE,4
       0000                 11      ADD HL,DE
       0000                 16      LD  (NAMEP+2),HL
       0000                  6      INC HL
       0000                 17      CALL    CHKWILD
       0000                 11      RET C
                                
       0000                 17      CALL    SOPENX
       0000                  7      LD  A,00FH
       0000                 17      CALL    NC,CHKATT
       0000                 11      RET C
                                
       0000                 19      LD  A,(IY+0)
       0000                 15      PUSH    IY
       0000                 14  NAMEP:  LD  IY,0        ;自己書き換え
       0000                 19      LD  (IY+0),A
       0000                 17      CALL    SOPENX
       0000                 23      EX  (SP),IY
       0000                  4      CCF
       0000                 17      CALL    NC,SOPEN
       0000                  4      EX  DE,HL
       0000                 10      POP HL
       0000                 11      RET C
                                
       0000                     SETNAME:
       0000                 10      LD  BC,11*256
       0000                  6      INC HL
       0000                  7      LD  A,(HL)
       0000                  7      CP  0E5H
       0000                 12      JR  NZ,SNAME1
       0000                  7      LD  A,5
       0000                 12      JR  SNAME3
       0000                     SNAME1:
       0000                  7      LD  A,(HL)
       0000                  4      INC C
       0000                  4      DEC C
       0000                 12      JR  NZ,SNAME3
       0000                 17      CALL    CAP
       0000                  7      CP  0A0H
       0000                 12      JR  NZ,SNAME3
       0000                  7      LD  A,020H
       0000                     SNAME3:
       0000                  7      LD  (DE),A
       0000                  7      LD  A,(HL)
       0000                  6      INC HL
       0000                 17      CALL    FKAN
       0000                 13      DJNZ    SNAME1
       0000                     WTDB:
       0000                  7      LD  A,0FFH
       0000                 13      LD  (SFILE),A
       0000                     SWTDBF:
       0000                  7      LD  A,1
       0000                 13      LD  (_WTDBF),A
       0000                  4      XOR A
       0000                 10      RET
                                
       0000                     FKANC:
       0000                  8      BIT 0,C
       0000                 17      CALL    Z,CAP2
       0000                 12      JR  FKANX
       0000                     FKAN:           ;漢字チェック
       0000                  6      INC DE
       0000                     FKANX:
       0000                  8      BIT 0,C
       0000                  8      RES 0,C
       0000                 11      RET NZ
       0000                  7      CP  080H
       0000                 11      RET C
       0000                  7      CP  0A0H
       0000                 12      JR  C,FKAN1
       0000                  7      CP  0E0H
       0000                 11      RET C
       0000                     FKAN1:
       0000                  4      INC C
       0000                  4      AND A
       0000                 10      RET
                                
       0000                     CHKWILDX:
       0000                 15      PUSH    IY
       0000                 10      POP HL
       0000                  6      INC HL
       0000                     CHKWILD:
       0000                  7      LD  B,11
       0000                  7      LD  A,'?'
       0000                     CHKWIL1:
       0000                  7      CP  (HL)
       0000                  6      INC HL
       0000                  4      SCF
       0000                 11      RET Z
       0000                 13      DJNZ    CHKWIL1
       0000                  4      XOR A
       0000                 10      RET
                                
       0000                     SDIRENT:        ;IY=FCB HL=DIR
       0000                 11      PUSH    DE
       0000                 11      PUSH    HL
       0000                 15      PUSH    IY
       0000                 10      POP DE
       0000                  4      EX  DE,HL
       0000                 17      CALL    SETNAME
                                ;               Attribute
       0000                 19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
       0000                  7      LD  (DE),A
       0000                  6      INC DE
                                ;               Reserved
       0000                  4      XOR A
       0000                  7      LD  B,10
       0000                     SDE1:
       0000                  7      LD  (DE),A
       0000                  6      INC DE
       0000                 13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
       0000                 10      LD  HL,SDDATA       ;(FCB)更新年月日
       0000                  7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       0000                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
       0000                  7      LD  A,(HL)
       0000                  6      INC HL
       0000                 13      LD  (SDPAT+2),A
       0000                 19  SDPAT:  LD  A,(IY+0)    ;LD A,(IY+A)
       0000                  7      LD  (DE),A
       0000                  6      INC DE
       0000                 13      DJNZ    SDLOOP
                                
       0000                  4      XOR A
       0000                 10      POP HL
       0000                 10      POP DE
       0000                 10      RET
                                
       0000                     WOPEN:
       0000                 19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
       0000                  7      AND 01FH
       0000                  4      SCF
       0000                 11      RET NZ
       0000                 19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       0000                     TOPEN2:
       0000                  4      XOR A
       0000                     TOPEN:              ;Initializes the time stamp
       0000                 19      LD  (IY+23),0FFH    ;(FCB)更新時刻
       0000                 10      RET
                                
       0000                     WRDFX:
       0000                 13      LD  A,(SPCPAT+1)    ;1クラスタの論理セクタ
       0000                     L_WRFX:
       0000                  4      RRA     ;->CF
       0000                 12      JR  C,E_WRFX
       0000                  8      SRL C   ;C=C/2
       0000                 12      JR  L_WRFX
       0000                     E_WRFX:
       0000                  4      LD  B,C
       0000                  4      INC B
       0000                  7      LD  A,037H      ;SCF
       0000                 13      LD  (DRDN1),A
                                
       0000                     WRDF:               ;Bクラスタ分FATを確保する
       0000                 10      LD  DE,2
       0000                  4      XOR A
       0000                 13      LD  (_SECPS+1),A
       0000                     WRDF1:
       0000                 11      PUSH    BC
       0000                 11      PUSH    DE
       0000                 17      CALL    _GNCL
       0000                 12      JR  C,WRDF3
       0000                  4      LD  A,D     ;空いているかチェック
       0000                  4      OR  E
       0000                 12      JR  NZ,WRDF4
       0000                 10      POP HL      ;HL=空いているクラスタ
       0000                 11      PUSH    HL
       0000                 20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
       0000                 16      LD  (_CLPS),HL
       0000                  4      LD  A,D     ;元の(_CLPS)が 0 か?
       0000                  4      OR  E
       0000                 12      JR  NZ,WRDF2
       0000                 19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
       0000                 19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
       0000                 12      JR  WRDF3
       0000                     WRDF2:
       0000                 17      CALL    _SNCL
       0000                     WRDF3:
       0000                 10      POP DE
       0000                 10      POP BC
       0000                 11      RET C
       0000                 13      DJNZ    WRDF5       ;ここでループカウンタチェック
       0000                 20      LD  DE,(_CLPS)
       0000                 10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
       0000                 10      JP  _SNCL
                                
       0000                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
       0000                 10      POP DE
       0000                 10      POP BC
       0000                     WRDF5:
       0000                  6      INC DE
       0000                 17      CALL    ENDCL
       0000                 12      JR  C,WRDF1
       0000                  4      SCF
       0000                 10      RET
                                
       0000                     RWXR:
       0000                 13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       0000                     L_RWX:
       0000                  4      RRA     ;->CF
       0000                 12      JR  C,E_RWX
       0000                  8      SRL B   ;BC=BC/2
       0000                  8      RR  C   ;
       0000                 12      JR  L_RWX
       0000                     E_RWX:
       0000                 19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
       0000                 19      LD  D,(IY+27)
       0000                  4      XOR A
       0000                 13      LD  (_SECPS+1),A
       0000                     RWX1:
       0000                 20      LD  (_CLPS),DE
       0000                  4      LD  A,D
       0000                  4      OR  E
       0000                 12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
       0000                  4      LD  A,B
       0000                  4      OR  C
       0000                 11      RET Z       ;RET BC==0 => CF=0
                                
       0000                 17      CALL    GNCLX
       0000                 11      RET C
       0000                  6      DEC BC
                                
       0000                 17      CALL    ENDCL
       0000                 12      JR  C,RWX1
       0000                     SCF_RET:
       0000                  4      SCF
       0000                 10      RET
                                
       0000                     DSKF:
       0000                 10  MAXCLP: LD  DE,0
       0000                 16      LD  HL,(_FAKEFREE)
       0000                  4      LD  A,H
       0000                  4      OR  L
       0000                 12      JR  Z,DSKF1
       0000                 10      LD  DE,1
       0000                     DSKF1:
       0000                 11      PUSH    DE
       0000                 17      CALL    _GNCL
       0000                 12      JR  C,POPSCF
       0000                  4      LD  A,D
       0000                  4      OR  E
       0000                 12      JR  NZ,DSKF2
       0000                  6      INC HL
       0000                     DSKF2:
       0000                 10      POP DE
       0000                  6      DEC DE
       0000                  4      LD  A,D
       0000                  4      OR  E
       0000                 12      JR  NZ,DSKF1
       0000                 10      RET
                                
       0000                     POPSCF:
       0000                 10      POP AF
       0000                  4      SCF
       0000                 10      RET
                                
       0000                     SETTMS:
       0000                 19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
       0000                  4      INC A
       0000                 11      RET NZ      ;ファイルが更新されていない
       0000                     SETTMSX:            ;FCBに日付時刻をセットする
       0000                 17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
       0000                  8      SLA L       ;   *2
       0000                  8      SLA L       ;   *4
       0000                 11      ADD HL,HL       ;*2 *8
       0000                 11      ADD HL,HL       ;*4 *16
       0000                 11      ADD HL,HL       ;*8 *32
       0000                  4      LD  A,D
       0000                  4      RRCA            ;bit.0->7->->->0->C
       0000                  7      AND 01FH
       0000                  4      OR  L
       0000                 19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
       0000                 19      LD  (IY+23),H
                                
       0000                 17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
       0000                 10      LD  BC,0-1980
       0000                 11      ADD HL,BC
       0000                  4      LD  H,L
                                
       0000                  4      LD  A,D
       0000                  4      ADD A,A     ;*2
       0000                  4      ADD A,A     ;*4
       0000                  4      ADD A,A     ;*8
       0000                  4      ADD A,A     ;*16
       0000                  4      LD  L,A
       0000                 11      ADD HL,HL       ;*32
       0000                  4      LD  A,L
       0000                  4      OR  E
       0000                 19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
       0000                 19      LD  (IY+21),H
       0000                 10      RET
                                
       0000                     PUSHRR:
       0000                 17      CALL    SUBRR
       0000                     POPRR1:
       0000                         LDIR
       0000                 10      RET
                                
       0000                     SUBRR:
       0000                 15      PUSH    IY
       0000                 10      POP HL
       0000                 10      LD  DE,33
       0000                 11      ADD HL,DE
       0000                 10      LD  DE,HLBUF
       0000                 10      LD  BC,3
       0000                 10      RET
                                
       0000                     SETSEQ:
       0000                 11      PUSH    AF      ;AHL=Random record
       0000                 19      LD  A,(IY+33)   ;(FCB)ランダムレコード
       0000                 19      LD  L,(IY+34)
       0000                 19      LD  H,(IY+35)
                                
       0000                 17      CALL    SSQ1
                                
       0000                 11      ADD HL,HL
       0000                  8      SRL L       ;L=L/2
       0000                 19      LD  (IY+32),L   ;(FCB)カレントレコード
       0000                 19      LD  (IY+12),H   ;(FCB)カレントブロック
       0000                 10      POP AF
                                
       0000                     POPRR:
       0000                 17      CALL    SUBRR
       0000                  4      EX  DE,HL
       0000                 12      JR  POPRR1
                                
       0000                     GETSIZE:
       0000                 19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
       0000                 19      LD  L,(IY+17)
       0000                 19      LD  H,(IY+18)
       0000                     SSQ1:               ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
       0000                  4      ADD A,A     ;in HLA => out HL
       0000                 15      ADC HL,HL
       0000                  4      OR  A
       0000                 11      RET Z
       0000                  6      INC HL
       0000                 10      RET
                                
       0000                     GETSEQ:
       0000                 19      LD  L,(IY+32)   ;(FCB)カレントレコード
       0000                 19      LD  H,(IY+12)   ;(FCB)カレントブロック
                                
       0000                  8      SLA L   ;L=L*2
                                
       0000                  8      SRL H   ;HL=HL/2
       0000                  8      RR  L   ;
       0000                 10      RET
                                
       0000                     RB_WRITE:
       0000                 11      PUSH    BC
       0000                 20      LD  BC,(STABLE+2*026H)  ;(BDOS)ランダムブロック書き込み
       0000                 12      JR  RBRW
       0000                     RB_READ:
       0000                 11      PUSH    BC
       0000                 20      LD  BC,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       0000                     RBRW:
       0000                  4      XOR A   ;HLA = HL*128
       0000                  8      SRL H   ;HL=HL/2
       0000                  8      RR  L   ;
       0000                  4      RRA         ;HLA
       0000                 19      LD  (IY+33),A   ;(FCB)ランダムレコード
       0000                 19      LD  (IY+34),L
       0000                 19      LD  (IY+35),H
       0000                 10      LD  HL,128
                                
       0000                 15      PUSH    IY
       0000                 10      POP DE
       0000                 11      PUSH    DE
       0000                 17      CALL    JP_BC
       0000                 14      POP IY
       0000                 10      POP BC
       0000                 10      RET
       0000                     JP_BC:
       0000                 11      PUSH    BC
       0000                 10      RET
                                
                                _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
                                _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
                                _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
                                _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
                                _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       0000                     _SYS26:     ;(BDOS)ランダムブロック書き込み
       0000                  4      XOR A
       0000                 13      LD  (DRDN1),A   ;NOP
       0000                 16      LD  (LEFT+1),HL ;HL←書き込むレコード数
       0000                 16      LD  (LEFTX),HL
       0000                 17      CALL    SETDRV
                                
       0000                 17      CALL    RBX0
       0000                 10      JP  C,RBWERR
       0000                 17      CALL    WOPEN
       0000                 10      JP  C,RBWERR
       0000                  4      LD  A,H
       0000                  4      OR  L
       0000                 10      JP  Z,RBW1
                                
       0000                  6      DEC HL
                                
       0000                 17      CALL    GET_RR_CDE  ;CDE=Random record
                                
       0000                  4      XOR A   ;AHL=HL+CDE
       0000                 11      ADD HL,DE
       0000                  4      ADC A,C
                                
       0000                  4      LD  B,A
       0000                  4      LD  C,H
                                
       0000                 17      CALL    RWXR
       0000                 17      CALL    C,WRDFX
       0000                 10      JP  C,RBWERR
                                
       0000                 17      CALL    RBX2
       0000                 12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
       0000                 17      CALL    RBXA
       0000                 12      JR  C,RBWERR
       0000                  4      EX  DE,HL
       0000                 11      PUSH    BC
       0000                         LDIR
       0000                 16      LD  (DTAX),HL
                                
       0000                 17      CALL    SWTDBF      ;バッファデータは更新された
                                
       0000                 16      LD  HL,(LEFTX)
       0000                 10      POP DE
       0000                 15      SBC HL,DE
       0000                 16      LD  (LEFTX),HL
       0000                 12      JR  Z,RBWEND
                                
       0000                     RBWB:
       0000                 17      CALL    RBXB
       0000                 12      JR  Z,RBWC
       0000                     RBWB1:
       0000                 11      PUSH    BC
       0000                 11      PUSH    DE
       0000                 17      CALL    CLUSTX
       0000                 17      CALL    DWT24
       0000                 10      POP DE
       0000                 10      POP BC
       0000                 12      JR  C,RBWERR
       0000                 17      CALL    GNCLX
       0000                 12      JR  C,RBWERR
       0000                 13      DJNZ    RBWB1
       0000                     RBWC:
       0000                 17      CALL    RBXC
       0000                 12      JR  Z,RBWEND
       0000                 11      PUSH    BC
       0000                 17      CALL    CLUSTX
       0000                 17      CALL    DRDN
       0000                 10      POP BC
       0000                 12      JR  C,RBWERR
       0000                 20      LD  DE,(_DTBUF)
       0000                         LDIR
       0000                 17      CALL    SWTDBF      ;バッファデータは更新された
       0000                     RBWEND:
       0000                 17      CALL    RBXEND
                                
       0000                 17      CALL    RBX1
       0000                 12      JR  NC,RBW1
       0000                 16      LD  HL,(LEFT+1)
       0000                 19      LD  E,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
       0000                 19      LD  D,(IY+17)   ;CDE=File size
       0000                 19      LD  C,(IY+18)
       0000                  4      XOR A
       0000                 11      ADD HL,DE
       0000                  4      ADC A,C
       0000                 19      LD  (IY+16),L   ;(FCB)ファイルのサイズ(バイト単位)
       0000                 19      LD  (IY+17),H
       0000                 19      LD  (IY+18),A
       0000                     RBW1:
       0000                 14      POP IY
       0000                 10      POP BC
       0000                 10      POP DE
       0000                 10      POP HL
       0000                     DD_NUL:
       0000                  4      XOR A
       0000                 10      RET
                                
       0000                     RBWERR:
       0000                 15      PUSH    IY
       0000                 10      POP DE
       0000                 16      LD  HL,(STABLE+2*010H)
       0000                 17      CALL    JP_HL
       0000                     RBRERR1:
       0000                  7      LD  A,001H
       0000                     RBRERR2:
       0000                 14      POP IY
       0000                 10      POP BC
       0000                 10      POP DE
       0000                 10      POP HL
       0000                  4      SCF
       0000                 10      LD  HL,0
       0000                 10      RET
                                
       0000                     RBRERR:
       0000                  7      LD  A,0FFH
       0000                 12      JR  RBRERR2
                                
       0000                     RBRFL:
       0000                  7  RBRFLP: LD  A,000H
       0000                  7      CP  00DH
       0000                 12      JR  NZ,RBRFL1
       0000                 11      PUSH    DE
       0000                  7      LD  E,00AH
       0000                 12      JR  RBRFL2
       0000                     RBRFL1:
       0000                 11      PUSH    DE
       0000                 17      CALL    _SYS07
       0000                  4      LD  E,A
       0000                     RBRFL2:
       0000                 17      CALL    _PRINT
       0000                  4      LD  A,E
       0000                 10      POP DE
       0000                 13      LD  (RBRFLP+1),A
       0000                 10      RET
       0000                     DDX:
       0000                 19      LD  A,(IY+1)    ;(FCB)主ファイル名
       0000                 17      CALL    CAP
       0000                  7      CP  'A'
       0000                 10      RET
                                
                                                ;Read random block
       0000                     _SYS27:     ;(BDOS)ランダムブロック読み込み
       0000                 16      LD  (LEFTX),HL
       0000                 17      CALL    SETDRV
                                
       0000                 20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
       0000                 10      JP  NZ,RBRDIR   ;ディレクトリ
       0000                 17      CALL    RBX0
       0000                 10      JP  C,RBRERR
       0000                 17      CALL    RBX1
       0000                 10      JP  C,RBRERR1
       0000                  4      LD  A,C
       0000                  4      EX  DE,HL
       0000                 15      SBC HL,DE       ;CP 0HL,CDE
       0000                 11      ADD HL,DE
       0000                  7      SBC A,000H
       0000                 12      JR  C,RBR1
       0000                  4      EX  DE,HL
       0000                     RBR1:
       0000                  4      SBC A,A
       0000                  7      AND 1
       0000                 13      LD  (RBRAP+1),A
                                
       0000                  4      LD  A,H
       0000                  4      OR  L
       0000                 12      JR  Z,RBREND0
                                
       0000                 16      LD  (LEFT+1),HL ;Read record byte
       0000                 16      LD  (LEFTX),HL
                                
       0000                 17      CALL    RBX2
       0000                 12      JR  Z,RBRB
       0000                 17      CALL    RBXA
       0000                 10      JP  C,RBRERR
       0000                 11      PUSH    BC
       0000                         LDIR
       0000                 20      LD  (DTAX),DE
       0000                 16      LD  HL,(LEFTX)
       0000                 10      POP DE
       0000                  4      AND A
       0000                 15      SBC HL,DE
       0000                 16      LD  (LEFTX),HL
       0000                 12      JR  Z,RBREND
                                
       0000                     RBRB:
       0000                 17      CALL    RBXB
       0000                 12      JR  Z,RBRC
       0000                     RBRB1:
       0000                 11      PUSH    BC
       0000                 11      PUSH    DE
       0000                 17      CALL    CLUSTX
       0000                 17      CALL    DRD24
       0000                 10      POP DE
       0000                 10      POP BC
       0000                 17      CALL    NC,GNCLX
       0000                 10      JP  C,RBRERR
       0000                 13      DJNZ    RBRB1
       0000                     RBRC:
       0000                 17      CALL    RBXC
       0000                 12      JR  Z,RBREND
       0000                 11      PUSH    BC
       0000                 17      CALL    CLUSTX
       0000                 17      CALL    DRDX
       0000                 10      POP BC
       0000                 10      JP  C,RBRERR
       0000                  4      EX  DE,HL
       0000                 16      LD  HL,(_DTBUF)
       0000                         LDIR
       0000                     RBREND:
       0000                 17      CALL    RBXEND
       0000                     RBREND0:
       0000                 14      POP IY
       0000                 10      POP BC
       0000                 10      POP DE
       0000                 10      POP AF  ;(HL)
       0000                  4      XOR A
       0000                  7  RBRAP:  LD  A,000H
       0000                 10      RET
                                
       0000                     RBRDIR:
       0000                 19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
       0000                 19      LD  H,(IY+27)
       0000                 17      CALL    CHDIR
       0000                  4      XOR A
       0000                  4      LD  H,A
       0000                  4      LD  L,A
       0000                  4      INC A
       0000                 13      LD  (RBRAP+1),A
       0000                 12      JR  RBREND0
                                
       0000                     RBX0:
       0000                 16      LD  HL,(_DTA)
       0000                 16      LD  (DTAX),HL
       0000                 16      LD  HL,(LEFTX)
       0000                 19      LD  A,(IY+28)   ;(FCB)オープンモード
       0000                  7      SUB 0FDH
       0000                 10      RET
                                
       0000                     RBX1:
       0000                 11      PUSH    HL      ;Record byte
                                                ;AHL=File size
       0000                 19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
       0000                 19      LD  H,(IY+17)
       0000                 19      LD  A,(IY+18)
                                
       0000                 17      CALL    GET_RR_CDE  ;CDE=Random record
                                
       0000                  4      AND A
       0000                 15      SBC HL,DE
       0000                  4      SBC A,C
       0000                 10      POP DE
                                
       0000                 11      RET C
       0000                  4      LD  C,A
       0000                  4      EX  DE,HL   ;CDE=File byte  HL=Record byte
       0000                  4      OR  D
       0000                  4      OR  E
       0000                 11      RET NZ
       0000                  4      SCF
       0000                 10      RET
                                
       0000                     RBX2:               ;Cluster settings
       0000                 19      LD  C,(IY+34)   ;(+33)(FCB)ランダムレコード
       0000                 19      LD  B,(IY+35)
       0000                 17      CALL    RWXR
       0000                 13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       0000                  4      DEC A
       0000                 19      AND (IY+34)
       0000                 19      OR  (IY+33)
       0000                 10      RET
                                
       0000                     RBXA:
       0000                 11      PUSH    BC
       0000                 11      PUSH    DE
       0000                 17      CALL    CLUSTX
       0000                 17      CALL    DRDX
       0000                 10      POP DE
       0000                 10      POP BC
       0000                 11      RET C
       0000                 17      CALL    GNCLX
       0000                 11      RET C
       0000                 20      LD  (_CLPS),DE
                                
       0000                 19      LD  C,(IY+33)   ;(FCB)ランダムレコード
       0000                 10  SECSZ:  LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       0000                  4      LD  A,H
       0000                  4      DEC A       ;1024=3 / 512=1
       0000                 19      AND (IY+34)     ;(FCB)ランダムレコード
       0000                  4      LD  B,A     ;BCに1セクタ以下の端数が入る
       0000                 15      SBC HL,BC       ;残りを計算
                                
       0000                 20      LD  DE,(LEFTX)
       0000                 15      SBC HL,DE       ;CP HL,DE
       0000                 11      ADD HL,DE       ;
       0000                 12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
       0000                  4      EX  DE,HL
       0000                     RBXA1:
       0000                 11      PUSH    HL
       0000                 16      LD  HL,(_DTBUF)
       0000                 11      ADD HL,BC
       0000                 20      LD  DE,(DTAX)
       0000                 10      POP BC
       0000                 10      RET
                                
       0000                     RBXB:
       0000                 16      LD  HL,(DTAX)
       0000                 20      LD  DE,(_CLPS)
       0000                 13      LD  A,(LEFTX+1)
       0000                  4      LD  B,A
       0000                 13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       0000                     RBXB1:
       0000                  4      RRA     ;->CF
       0000                 12      JR  C,RBXB2
       0000                  8      SRL B   ;B=B/2
       0000                 12      JR  RBXB1
       0000                     RBXB2:
       0000                  4      LD  A,B
       0000                  4      OR  A
       0000                 10      RET
                                
       0000                     RBXC:
       0000                 20      LD  BC,(LEFTX)
       0000                 13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       0000                  4      DEC A
       0000                  4      AND B
       0000                  4      LD  B,A     ;1セクタ以下の端数がない場合はZ
       0000                  4      OR  C
       0000                 10      RET
                                
       0000                     RBXEND:
       0000                 10  LEFT:   LD  DE,0
       0000                  4      XOR A
       0000                 19      LD  L,(IY+33)   ;(FCB)ランダムレコード
       0000                 19      LD  H,(IY+34)
       0000                 11      ADD HL,DE
       0000                 19      ADC A,(IY+35)
       0000                 19      LD  (IY+33),L   ;(FCB)ランダムレコード
       0000                 19      LD  (IY+34),H
       0000                 19      LD  (IY+35),A
       0000                  4      EX  DE,HL       ;HL=Read byte
       0000                 10      RET
                                
       0000                     GET_RR_CDE:         ;CDE=Random record
       0000                 19      LD  E,(IY+33)   ;(FCB)ランダムレコード
       0000                 19      LD  D,(IY+34)
       0000                 19      LD  C,(IY+35)
       0000                 10      RET
                                
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       0000                     DRDX:
       0000                 17      CALL    DRDY
       0000                 11      RET Z
       0000                 17      CALL    DRDX1       ;データバッファの情報を保存
       0000                 11      RET C
       0000                 11      PUSH    HL
       0000                 11      PUSH    BC
       0000                 11      PUSH    DE
       0000                 16      LD  HL,(_DTBUF)
       0000                 13      LD  A,(_DBS24+1)
       0000                  4      LD  C,A
       0000                 17      CALL    DRD24
       0000                 17      CALL    C,DRDNE
       0000                     POP_DE_BC_HL_RET:
       0000                 10      POP DE
       0000                 10      POP BC
       0000                 10      POP HL
       0000                 10      RET
                                
                                ;   CDE:セクタ番号
       0000                     DRDN:
       0000                  4      XOR A
       0000                  4  DRDN1:  NOP         ;自己書き換え NOP / SCF
       0000                 12      JR  NC,DRDX
       0000                     DRDNX:
       0000                 17      CALL    DRDY
       0000                 11      RET Z
       0000                     DRDX1:
       0000                 17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
       0000                 20      LD  (_DBSEC),DE
       0000                  4      LD  A,C
       0000                 13      LD  (_DBS24+1),A
                                
       0000                 13      LD  A,(_DRV)
       0000                 13      LD  (_DBDRV),A
       0000                 17      CALL    _CHGDRV
       0000                 11      RET NC
       0000                     DRDNE:
       0000                  4      SBC A,A     ;CF=1ならばA=0FFH
       0000                 13      LD  (_DBDRV),A
       0000                 10      RET
                                
                                ;   CDE:セクタ番号
       0000                     DRDY:
       0000                 13      LD  A,(_DBS24+1)
       0000                  4      CP  C
       0000                 11      RET NZ
                                
       0000                 11      PUSH    HL
       0000                 13      LD  A,(_DRV)
       0000                 10      LD  HL,_DBDRV
       0000                  7      XOR (HL)
       0000                 12      JR  NZ,POP_HL_RET
                                
       0000                 16      LD  HL,(_DBSEC)
       0000                 15      SBC HL,DE       ;CF=0
       0000                     POP_HL_RET:
       0000                 10      POP HL
       0000                 10      RET
                                
       0000                     DWTX:
       0000                 13      LD  A,(_WTDBF)
       0000                  4      OR  A
       0000                 11      RET Z
       0000                  4      XOR A
       0000                 13      LD  (_WTDBF),A
                                
       0000                 11      PUSH    HL
       0000                 11      PUSH    BC
       0000                 11      PUSH    DE
       0000                 13      LD  A,(_DBDRV)
       0000                 17      CALL    _CHGDRV
       0000                  7  _DBS24: LD  C,0
       0000                 20      LD  DE,(_DBSEC)
       0000                 16      LD  HL,(_DTBUF)
       0000                 17      CALL    NC,DWT24
       0000                     POP_DE_BC_HL_RET2:
       0000                 12      JR  POP_DE_BC_HL_RET
                                
       0000                     RDFATX:
       0000                 11      PUSH    HL
       0000                 13      LD  A,(_DRV)
       0000                 10      LD  HL,_FATDRV
       0000                  7      XOR (HL)
       0000                 12      JR  Z,POP_HL_RET
                                
       0000                 11      PUSH    BC
       0000                 11      PUSH    DE
       0000                 15      PUSH    IX
       0000                 17      CALL    WTFATX
       0000                 12      JR  C,POP_IX_DE_BC_HL_RET
                                
       0000                  4      XOR A
       0000                 13      LD  (_FATIX),A
       0000                 13      LD  A,(_DRV)
       0000                 13      LD  (_FATDRV),A
       0000                 17      CALL    _RDFAT
       0000                     RDFATE2:
       0000                 12      JR  NC,POP_IX_DE_BC_HL_RET
       0000                  4      SBC A,A     ;A=0xFF
       0000                 13      LD  (_FATDRV),A
       0000                     POP_IX_DE_BC_HL_RET:
       0000                 14      POP IX
       0000                 12      JR  POP_DE_BC_HL_RET2
                                
       0000                     WTFATX:
       0000                 13      LD  A,(_WTFATF)
       0000                  4      OR  A
       0000                 11      RET Z
       0000                 11      PUSH    HL
       0000                 13      LD  A,(_FATDRV)
       0000                 10      LD  HL,_DBDRV
       0000                  7      XOR (HL)
       0000                 17      CALL    Z,DWTX
       0000                 12      JR  C,POP_HL_RET
       0000                 11      PUSH    BC
       0000                 11      PUSH    DE
       0000                 15      PUSH    IX
       0000                 17      CALL    WTFAT
       0000                  4      XOR A
       0000                 13      LD  (_WTFATF),A
       0000                 12      JR  POP_IX_DE_BC_HL_RET
                                
       0000                     NCL1:
       0000                  4      LD  A,D
       0000                  4      OR  E
       0000                  4      SCF
       0000                 11      RET Z
                                
       0000                  4      LD  A,D
       0000                  8      SRL A   ;/2
       0000                  8      SRL A   ;/2
                                
       0000                 11      PUSH    HL
       0000                 13      LD  (NCLPAT+2),A    ;_FATIX
       0000                 16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
       0000                  4      CP  H
       0000                 13      LD  A,(_DRV)    ;この間でフラグは変化しない
       0000                 13      LD  (NCLPAT+1),A    ;_FATDRV
       0000                 12      JR  NZ,NCL2     ;FATIXが違う
       0000                  4      CP  L
       0000                 12      JR  NZ,NCL2     ;ドライブが違う
       0000                 10      POP HL
       0000                 10      RET
       0000                     NCL2:
       0000                 11      PUSH    BC
       0000                 11      PUSH    DE
       0000                 15      PUSH    IX
       0000                 17      CALL    WTFATX
       0000                 12      JR  C,POP_IX_DE_BC_HL_RET
       0000                 10  NCLPAT: LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       0000                 20      LD  (_FATDRV),BC
       0000                 17      CALL    RDFATS
       0000                 12      JR  RDFATE2
                                
       0000                     NCL3:
       0000                  8      RES 3,D
       0000                  8      RES 2,D
       0000                  4      LD  L,E
       0000                  4      LD  H,D
       0000                  8      SRL H   ;
       0000                  8      RR  L   ;HLA=HLA/2
       0000                  4      RRA     ;
       0000                 11      PUSH    AF
       0000                 13      LD  A,(_FATIX)
       0000                  4      RRCA
       0000                 12      JR  NC,NCL3X1
       0000                 13      LD  A,(SECSZ+2)
       0000                  7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
       0000                 12      JR  NZ,NCL3X1
       0000                 10      LD  BC,512
       0000                 11      ADD HL,BC
       0000                     NCL3X1:
       0000                 10      POP AF
       0000                 20      LD  BC,(_FATBF)
       0000                 11      ADD HL,DE
       0000                 11      ADD HL,BC
       0000                  4      RLA
       0000                 10      RET
                                
       0000                     GNCL:
       0000                 17      CALL    NCL1        ;GET NEXT CLUSTER
       0000                 11      RET C
       0000                 11      PUSH    BC
       0000                 11      PUSH    HL
       0000                 17      CALL    NCL3
       0000                 12      JR  C,GNC1
       0000                  7      LD  E,(HL)
       0000                  6      INC HL
       0000                  7      LD  A,(HL)
       0000                  7      AND 00FH
       0000                  4      LD  D,A
       0000                 10      POP HL
       0000                 10      POP BC
       0000                 10      RET
       0000                     GNC1:
       0000                  7      LD  A,(HL)
       0000                  6      INC HL
       0000                  7      LD  D,(HL)
       0000                  7      LD  B,4
       0000                     GNC1L:
       0000                  8      SRL D   ;DA=DA/2
       0000                  4      RRA     ;
       0000                 13      DJNZ    GNC1L
                                
       0000                  4      LD  E,A
       0000                 10      POP HL
       0000                 10      POP BC
       0000                  4      AND A
       0000                 10      RET
                                
       0000                     SNCL:
       0000                 17      CALL    NCL1
       0000                 11      RET C
                                ;               SET NEXT CLUSTER
       0000                 11      PUSH    HL
       0000                 11      PUSH    BC
       0000                 11      PUSH    DE
       0000                 11      PUSH    HL
       0000                 17      CALL    NCL3
       0000                 10      POP DE
                                ;CF=ODD
       0000                  7      LD  A,(HL)
       0000                  7      LD  (HL),E
       0000                 12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
       0000                  6      INC HL
       0000                 18      RRD     ;M={A[3:0],E[3:0]}
       0000                  4      LD  A,D
       0000                 12      JR  SNC11
       0000                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
       0000                 18      RLD     ;M={D[3:0],E[7:4]}
       0000                  6      INC HL
       0000                  7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       0000                     SNC11:
       0000                 18      RLD     ;M={M[7:4],D[3:0]}
       0000                  4      OR  A
       0000                 10      POP DE
       0000                 10      POP BC
       0000                 10      POP HL
       0000                     FAT_CHANGED:
       0000                  7      LD  A,1
       0000                 13      LD  (_WTFATF),A
       0000                 10      RET
                                
       0000                     N16CL3:
       0000                 11      PUSH    BC
       0000                  4      LD  L,E
       0000                  4      LD  A,D
       0000                  7      AND 3
       0000                  4      LD  H,A
       0000                 11      ADD HL,HL
       0000                 20      LD  BC,(_FATBF)
       0000                 11      ADD HL,BC
       0000                 10      POP BC
       0000                 10      RET
                                
       0000                     GNCL16:
       0000                 17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
       0000                 11      RET C
       0000                 11      PUSH    HL
       0000                 17      CALL    N16CL3
       0000                  7      LD  E,(HL)
       0000                  6      INC HL
       0000                  7      LD  D,(HL)
       0000                 10      POP HL
       0000                 10      RET
                                
       0000                     SNCL16:
       0000                 17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
       0000                 11      RET C
       0000                 11      PUSH    DE
       0000                 11      PUSH    HL
       0000                 17      CALL    N16CL3
       0000                 10      POP DE      ;HL
       0000                  7      LD  (HL),E
       0000                  6      INC HL
       0000                  7      LD  (HL),D
       0000                  4      LD  L,E
       0000                  4      LD  H,D
       0000                 10      POP DE
       0000                 12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       0000                     NEXTX:
       0000                  7  _SECPS: LD  A,0 ;自己書き換え
       0000                  4      INC A
       0000                  7  NCPAT:  AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       0000                 13      LD  (_SECPS+1),A
       0000                 10      RET
                                
       0000                     GNCLX:
       0000                 17      CALL    NEXTX
       0000                 11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
       0000                 10      JP  _GNCL   ;次のクラスタを探す
                                
       0000                     RDFAT:
       0000                  7      LD  A,080H
       0000                 13      LD  (CHECK),A
       0000                     RDFAT1:
       0000                 13      LD  A,(_DRV)
       0000                 17      CALL    CHGDRVR
       0000                 11      RET C
       0000                 19      LD  A,(IX+012H) ;DPB_12_DEVICE
       0000                  8      BIT 5,A
       0000                 12      JR  Z,RDFAT0X
       0000                 10      LD  HL,CHECK
       0000                  7      AND (HL)
       0000                  7      LD  (HL),A
       0000                 10      LD  DE,0        ;BPB
       0000                 16      LD  HL,(_FATBF)
       0000                 17      CALL    DRD16
       0000                 12      JR  NC,GETBPB
       0000                 10      LD  HL,CHECK
       0000                 15      RLC (HL)
       0000                  4      CCF
       0000                 11      RET C
       0000                 23      RR  (IX+00AH)   ;DPB_0A_FDMODE
       0000                  4      CCF         ;フロッピーディスクのMFMモードを切り替える
       0000                 23      RL  (IX+00AH)   ;DPB_0A_FDMODE
       0000                  7      LD  A,0FFH
       0000                 13      LD  (_DSK),A
       0000                 13      LD  A,(_DRIVE)
       0000                  7      AND 3
       0000                  7      OR  080H
       0000                  4      LD  L,A
       0000                  7      LD  H,_CYL0/256
       0000                  7      LD  A,0FFH
       0000                  7      LD  (HL),A
       0000                 12      JR  RDFAT1
       0000                     GETBPB:
       0000                 15      PUSH    IY
       0000                 20      LD  IY,(_FATBF) ;BPB
       0000                 17      CALL    _BPB2DPB
       0000                 14      POP IY
       0000                 11      RET C
       0000                 17      CALL    CHGDRV2
       0000                     RDFAT0X:
       0000                 17      CALL    RDFATS
       0000                 11      RET C
       0000                  7      CP  (IX+6)      ;DPB_06_FATID
       0000                 11      RET Z
       0000                 20      BIT 5,(IX+012H) ;DPB_12_DEVICE
       0000                 11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       0000                  4      SCF
       0000                 10      RET
                                
       0000                     BPB2DPB:
       0000                 19      LD  A,(IY+0)    ;BS_JmpBoot
       0000                  7      CP  0EBH        ;Short jump
       0000                 12      JR  Z,BPBOK
       0000                  7      CP  0E9H        ;Near jump
       0000                 12      JR  Z,BPBOK
       0000                  7      CP  060H        ;X68k
       0000                  4      SCF
       0000                 11      RET NZ
       0000                     BPBOK:
       0000                 19      LD  A,(IY+13)   ;BPB_SecPerClus
       0000                 19      LD  (IX+7),A    ;DPB_07_SECPCL
                                
       0000                 19      LD  A,(IY+22)   ;BPB_FATSz16
       0000                 19      LD  (IX+0),A    ;DPB_00_FATLN
       0000                 19      LD  A,(IY+23)   ;BPB_FATSz16
       0000                 19      LD  (IX+1),A    ;DPB_00_FATLN
                                
       0000                 19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
       0000                 19      LD  H,(IY+15)
       0000                 19      LD  (IX+00EH),L ;DPB_0E_FATPS
       0000                 19      LD  E,(IY+22)   ;BPB_FATSz16
       0000                 19      LD  D,(IY+23)
       0000                 19      LD  B,(IY+16)   ;BPB_NumFATs
       0000                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
       0000                 11      ADD HL,DE
       0000                 13      DJNZ    BPBDP1
       0000                     BPBDP2:
       0000                 19      LD  (IX+010H),L ;DPB_10_DIRPS
       0000                 19      LD  (IX+011H),H
       0000                 11      PUSH    HL
                                
       0000                 19      LD  L,(IY+17)   ;BPB_RootEntCnt
       0000                 19      LD  H,(IY+18)
       0000                 19      LD  A,(IY+12)   ;BPB_BytsPerSec
       0000                  7      LD  B,6
       0000                     BPBBPS1:
       0000                  4      DEC B
       0000                  4      RRCA
       0000                 12      JR  NC,BPBBPS1
       0000                     BPBDE1:
       0000                 11      ADD HL,HL
       0000                 13      DJNZ    BPBDE1
                                
       0000                  4      LD  A,H
       0000                 19      LD  (IX+00BH),A ;DPB_0B_DIRSCNT
                                
       0000                 10      POP DE      ;DPB_10_DIRPS
       0000                  4      LD  L,H
       0000                  7      LD  H,0
       0000                 11      ADD HL,DE       ;MAXDIR
       0000                 11      PUSH    HL
       0000                 19      LD  C,(IY+13)   ;BPB_SecPerClus
       0000                  8      SLA C       ;*2
       0000                  4      XOR A
       0000                  4      LD  B,A
       0000                 15      SBC HL,BC
       0000                 19      LD  (IX+014H),L ;DPB_14_ADDCL16
       0000                 19      LD  (IX+015H),H
                                
       0000                 10      POP DE      ;DE=DPB_0B_MAXDIR
       0000                 19      LD  L,(IY+19)   ;BPB_TotSec16
       0000                 19      LD  H,(IY+20)
       0000                  4      LD  A,H
       0000                  4      OR  L
       0000                  7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
       0000                 12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
       0000                 19      LD  A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
       0000                  4      OR  A
       0000                  4      SCF
       0000                 11      RET NZ
       0000                 19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
       0000                 19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_07_SECPCL)が最大128なので
       0000                 19      LD  A,(IY+34)   ;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
       0000                  4      AND A       ;CF=0
       0000                     BPB16BIT:
       0000                 15      SBC HL,DE
       0000                  7      SBC A,0
       0000                 19      LD  B,(IY+13)   ;BPB_SecPerClus
       0000                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
       0000                  8      RR  B       ;->CY
       0000                 12      JR  C,BPBTC2
       0000                  8      SRL A
       0000                  8      RR  H       ;AHL=AHL/2
       0000                  8      RR  L
       0000                 12      JR  BPBTC1
       0000                     BPBTC2:
       0000                  4      OR  A
       0000                  4      SCF
       0000                 11      RET NZ      ;念のため(クラスタ数が16ビットを超える場合)
       0000                  6      INC HL
       0000                  6      INC HL
       0000                 19      LD  (IX+8),L    ;DPB_08_MAXCL
       0000                 19      LD  (IX+9),H
                                
       0000                 19      LD  A,(IY+21)   ;BPB_Media
       0000                 19      LD  (IX+6),A    ;DPB_06_FATID
                                
       0000                 20      BIT 7,(IX+00AH) ;DPB_0A_FDMODE
       0000                 12      JR  Z,NOT_FD
       0000                  7      LD  L,40        ;MAXCYLの設定（要検討）ここから下はフロッピーのみ書き換える
       0000                  7      CP  0FDH    ;2D
       0000                 12      JR  Z,SETCYL
       0000                  7      LD  L,77
       0000                  7      CP  0FEH    ;2HD
       0000                 12      JR  Z,SETCYL
       0000                  7      LD  L,80    ;その他2DD等
       0000                     SETCYL:
       0000                 19      LD  (IX+00CH),L ;DPB_0C_MAXCYL
       0000                 19      LD  A,(IY+24)   ;BPB_SecPerTr
       0000                 19      LD  (IX+00DH),A ;DPB_0D_MAXSEC  ;ここまでフロッピー専用
       0000                     NOT_FD:
       0000                 19      LD  A,(IY+16)   ;BPB_NumFATs
       0000                  7      CP  2       ;>2:NC
       0000                 19      LD  A,(IY+12)   ;BPB_BytsPerSec
       0000                 12      JR  C,BPBFAT1
       0000                  7      OR  080H
       0000                     BPBFAT1:
       0000                 19      LD  (IX+00FH),A ;DPB_0F_BPS
                                
       0000                  7      AND 07FH        ;セクタバッファが1KBしかないので1KBを超える場合はCF=1でエラーにする
       0000                  7      ADD A,0-5       ;0-4:CF=0 5以上:CF=1
       0000                 10      RET
                                
       0000                     RDFATS:
       0000                 17      CALL    FATSETUP
       0000                 11      RET C
       0000                 17      CALL    DRD24B
       0000                 16      LD  HL,(_FATBF)
       0000                  7      LD  A,(HL)
       0000                 10      RET
                                
       0000                     DRD16:
       0000                  7      LD  C,0
       0000                     DRD24:
       0000                  7      LD  B,1
       0000                     DRD24B:
       0000                 15      PUSH    IX
       0000                 20      LD  IX,(_DPB)
       0000                 17  DRDPAT: CALL    FDRD        ;自己書き換え（ディスク読み込み）
       0000                     POP_IX_RET:
       0000                 14      POP IX
       0000                 10      RET
                                
       0000                     DWT16:
       0000                  7      LD  C,0
       0000                     DWT24:
       0000                  7      LD  B,1
       0000                     DWT24B:
       0000                 15      PUSH    IX
       0000                 20      LD  IX,(_DPB)
       0000                 17  DWTPAT: CALL    FDWT        ;自己書き換え（ディスク書き込み）
       0000                 12      JR  POP_IX_RET
                                
       0000                     WTFAT:
       0000                 17      CALL    FATSETUP
       0000                 17      CALL    NC,DWT24B
       0000                 11      RET C
       0000                 20      BIT 7,(IX+00FH) ;DPB_0F_BPS
       0000                 11      RET Z       ;予備FATが無い
       0000                 17      CALL    FATS2
       0000                 11      PUSH    HL      ;予備FAT
       0000                 19      LD  L,(IX+0)    ;DPB_00_FATLN
       0000                 19      LD  H,(IX+1)
       0000                 11      ADD HL,DE
       0000                  4      EX  DE,HL
       0000                 10      POP HL
       0000                 12      JR  DWT24B
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ1024毎に2KBを切り替える
                                ;------------------------
       0000                     FATSETUP:
       0000                 13      LD  A,(_FATDRV)
       0000                 17      CALL    CHGDRVR     ;ドライブ切り替え
       0000                 11      RET C
       0000                     FATS2:
       0000                 19      LD  A,(IX+00FH) ;DPB_0F_BPS 512=2 1024=4
       0000                  4      RRCA
       0000                 17  FATSX:  CALL    FATSETUP12  ;自己書き換え
       0000                 10      LD  HL,0
       0000                  4      LD  C,D
       0000                  4      LD  D,H
       0000                 13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
       0000                  4      LD  B,A
       0000                  4      INC B
       0000                 19      LD  A,(IX+0)    ;DPB_00_FATLN
       0000                     FAT_SKP:
       0000                  4      DEC B
       0000                 12      JR  Z,FAT1
       0000                 11      ADD HL,DE
       0000                  4      SUB E
       0000                 12      JR  NC,FAT_SKP
       0000                 10      RET
       0000                     FAT1:
       0000                  4      EX  DE,HL
       0000                  4      CP  C       ;C=FATバッファに読み込めるセクタ数
       0000                 12      JR  C,FAT2
       0000                  4      LD  A,C
       0000                     FAT2:
       0000                  4      LD  B,A
                                
       0000                 16      LD  HL,(_FATPS) ;fat sector pos
       0000                 11      ADD HL,DE
       0000                  4      EX  DE,HL
       0000                 16      LD  HL,(_FATBF)
       0000                  4      XOR A       ;CF=0
       0000                  4      LD  C,A
       0000                 10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       0000                     FATSETUP12:
       0000                 10      LD  DE,0606H    ;256
       0000                 11      RET C
       0000                 10      LD  DE,0303H    ;512
       0000                  4      RRCA
       0000                 11      RET C
       0000                 10      LD  DE,0201H    ;1024
       0000                 10      RET
                                
       0000                     FATSETUP16:
       0000                 10      LD  DE,0808H    ;256
       0000                 11      RET C
       0000                 10      LD  DE,0404H
       0000                  4      RRCA            ;512
       0000                 11      RET C
       0000                 10      LD  DE,0202H    ;1024
       0000                 10      RET
                                
       0000                     CHGDRV:
       0000                 11      PUSH    HL
       0000                 10      LD  HL,_DSK
       0000                  7      CP  (HL)
       0000                 12      JR  Z,CHGDRVE
       0000                     CHGDRV1:
       0000                 15      PUSH    IX
       0000                 17      CALL    CHGDRV0
       0000                 13      LD  A,(_DSK)
       0000                 14      POP IX
       0000                     CHGDRVE:
       0000                 10      POP HL
       0000                 10      RET
                                
       0000                     CHGDRV0:
       0000                  4      LD  L,A
       0000                 17      CALL    _GETDPB
       0000                 11      RET C
       0000                 20      LD  (_DPB),IX
       0000                  4      LD  A,L
       0000                 13      LD  (_DSK),A
       0000                     CHGDRV2:
       0000                 11      PUSH    BC
       0000                 11      PUSH    DE
       0000                 20      LD  (SPPAT2+1),SP
       0000                  4      DI
       0000                 10      LD  SP,IX
                                
       0000                 10      POP HL      ;DPB_00_FATLN
       0000                 10      POP HL      ;DPB_02_DRD
       0000                 16      LD  (DRDPAT+1),HL
                                
       0000                 10      POP HL
       0000                 16      LD  (DWTPAT+1),HL   ;DPB_04_DWT
                                
       0000                 10      POP HL      ;L=DPB_06_FATID H=DPB_07_SECPCL
       0000                  4      LD  A,H
       0000                 13      LD  (SPCPAT+1),A    ;1クラスタの論理セクタ数
       0000                  4      DEC A
       0000                 13      LD  (NCPAT+1),A
                                
       0000                 10      POP HL      ;DPB_08_MAXCL
       0000                  4      LD  A,L
       0000                 13      LD  (CLPAT2+1),A
       0000                  4      LD  A,H
       0000                 13      LD  (CLPAT1+1),A
       0000                  6      DEC HL
       0000                 16      LD  (MAXCLP+1),HL
                                
       0000                 10      POP HL      ;L=DPB_0A_FDMODE H=DPB_0B_DIRSCNT
       0000                  4      LD  A,L
       0000                  7      OR  0FEH
       0000                 13      LD  (FDMODE+1),A
       0000                  4      RLCA
       0000                  7      AND 3
       0000                 13      LD  (FSPAT+1),A
       0000                  4      LD  C,H
                                
       0000                 10      POP HL      ;L=DPB_0C_MAXCYL H=DPB_0D_MAXSEC
       0000                  4      LD  A,L
       0000                 13      LD  (_MAXCYL),A
       0000                  4      LD  A,H
       0000                 13      LD  (MAXSEC+1),A
                                
       0000                 10      POP HL      ;L=DPB_0E_FATPS H=DPB_0F_BPS
       0000                  4      LD  A,H     ;DPB_0F_BPS
       0000                  7      AND 7
       0000                 13      LD  (SECSZ+2),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM等
                                                ;1セクタ1024 2HD/2HDE98
                                                ;1セクタ256 GRAM等
                                                ;1024   512 256
                                                ;4  2   1
       0000                  4      ADD A,A     ;8  4   2
       0000                  4      ADD A,A     ;010H   8   4
       0000                  4      ADD A,A     ;020H   010H    8
       0000                 13      LD  (SDECPAT+1),A   ;1セクタ辺りのディレクトリエントリ数
                                
       0000                  7      LD  H,0
       0000                 16      LD  (_FATPS),HL
                                
       0000                 10      POP HL      ;L=DPB_10_DIRPS
       0000                 16      LD  (_DIRPS),HL
                                
       0000                 10      POP HL      ;L=DPB_12_DEVICE H=DPB_13_UNITNO
       0000                  4      LD  A,H
       0000                 13      LD  (_DRIVE),A
                                
       0000                 10      POP HL      ;DPB_14_ADDCL16
       0000                 16      LD  (CLSPAT+1),HL
                                
       0000                 10  SPPAT2: LD  SP,0        ;元のSPを復元
       0000                  4      EI
       0000                 16      LD  HL,(_DIRPS)
       0000                  7      LD  B,0
       0000                 11      ADD HL,BC
       0000                 16      LD  (MD_PAT+1),HL
                                
       0000                 16      LD  HL,(MAXCLP+1);
       0000                 10      LD  DE,4086
       0000                  4      OR  A
       0000                 15      SBC HL,DE
       0000                 12      JR  NC,SETFAT16
       0000                 10      LD  HL,GNCL     ;FAT12
       0000                 10      LD  DE,SNCL
       0000                 10      LD  BC,FATSETUP12
       0000                 23      RES 5,(IX+00FH) ;DPB_0F_BPS(FAT12)
       0000                 12      JR  EXTRA1
       0000                     SETFAT16:
       0000                 10      LD  HL,GNCL16   ;FAT16
       0000                 10      LD  DE,SNCL16
       0000                 10      LD  BC,FATSETUP16
       0000                 23      SET 5,(IX+00FH) ;DPB_0F_BPS(FAT16)
       0000                     EXTRA1:
       0000                 16      LD  (GNCPAT+1),HL
       0000                 20      LD  (SNCPAT+1),DE
       0000                 20      LD  (FATSX+1),BC
       0000                 10      POP DE
       0000                 10      POP BC
       0000                  4      XOR A
       0000                 10      RET
                                
       0000                     GETDPBD:
       0000                 23      EX  (SP),IX
       0000                 15      PUSH    IX
       0000                 13      LD  A,(_DRV)
       0000                 12      JR  GETDPB1
                                
       0000                     CHGDRVR:
       0000                 17      CALL    _CHGDRV
       0000                 11      RET C
       0000                 13      LD  A,(_DSK)
       0000                     GETDPB1:
       0000                 10      JP  _GETDPB
                                
       0000                     GETDPB:
       0000                  7      CP  8
       0000                  4      CCF
       0000                 11      RET C
       0000                  4      RRCA
       0000                  4      RRCA
       0000                  4      RRCA
       0000                         DB  0DDH        ;Z80未定義命令
       0000                  4      LD  L,A     ;LD IXL,A
       0000                         DB  0DDH        ;Z80未定義命令
       0000                  7      LD  H,DEVICE/256    ;LD IXH,DEVICE/256
       0000                 19      LD  A,(IX+0)    ;DPB_00_FATLN
       0000                  4      OR  A       ;CF=0の為
       0000                 20      BIT 5,(IX+00FH) ;DPB_0F_BPS
       0000                 11      RET NZ      ;FAT16
       0000                 20      BIT 5,(IX+012H) ;DPB_12_DEVICE
       0000                 11      RET NZ      ;BPB
       0000                  7      CP  001H        ;A=0 THEN CF=1
       0000                 10      RET
                                
       0000                     _SYS5F:
       0000                  4      XOR A
       0000                     FFLUSH:
       0000                 11      PUSH    AF
       0000                  7      LD  A,0FFH
       0000                 13      LD  (SFILE),A
       0000                 17      CALL    DWTX
       0000                  7      LD  A,0FFH
       0000                 13      LD  (_DBDRV),A
       0000                 17      CALL    WTFATX
       0000                  4      XOR A
       0000                 13      LD  (_FATIX),A
       0000                  4      CPL
       0000                 13      LD  (_FATDRV),A
       0000                 10      POP AF
       0000                 10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
       0000                     AT_WORK:
                                    DS  WORKAD-AT_WORK
                                
       0000                     CPM_BOOT:
       0000                 10      JP  0
       0000                     _SYS00:     ;(BDOS)プログラム終了
       0000                     CPM_WBOOT:
       0000                 10      JP  WBOOT1
       0000                     CPM_CONST:
       0000                 10      JP  CONSTX
       0000                     _SYS07:     ;(BDOS)コンソール直接入力
       0000                     CPM_CONIN:
       0000                 10      JP  FLGET
       0000                     CPM_CONOUT:
       0000                 10      JP  CONOUT1
                                
       0000                     DECBF:
                                    DS  5
       0000                     FDRV    DB  0
                                FNAME   DS  36
                                SFILE:  DS  33      ;DRV FILENAME
                                HLBUF:  DS  3       ;Random record buffer
                                
       0000                     LEFTX:  DW  0
       0000                     DTAX:   DW  0
                                
       0000                     BEEPD:  DB  0,08EH,1,0,00BH,0,00CH,010H
       0000                         DB  007H,03EH,008H,010H,00DH,0,0FFH
                                
       0000                     CHECK:  DB  0
                                
       0000                     OK: DB  "OK$"
       0000                     SKIP:   DB  "Skip$"
       0000                     COMERM: DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       0000                     _CYL0:  DB  0FFH    ;Cylinder
       0000                     _CYL1:  DB  0FFH    ;Cylinder
       0000                     _CYL2:  DB  0FFH    ;Cylinder
       0000                     _CYL3:  DB  0FFH    ;Cylinder
       0000                     _DRIVE: DB  0   ;unit number
       0000                     _SEEKSP:DB  0   ;Seek speed
       0000                     _ISEEK: DB  0FFH    ;
       0000                     _DVSW:  DB  0
       0000                     _DRV:   DB  0
       0000                     _DSK:   DB  0FFH
       0000                     _DTA:   DW  00080H
       0000                     _CTC:   DW  0
       0000                     _TXADR: DW  0
       0000                     _KEYPS: DW  0
       0000                     _KEYD:  DW  0FF00H  ;キーデータ
       0000                     _KEYSP: DW  010C2H
       0000                     _COLORF:DB  COLORF  ;色
       0000                     _LINE:  DB  LINE
                                
       0000                     _FCB:   DW  0
       0000                     _FBPS:  DW  0   ;SEARCH FILES
       0000                     _FBAD:  DW  0   ;    //
       0000                     _FBCNT: DB  0   ;    //
       0000                     _FILEN: DB  0
       0000                     _DIRF:  DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
       0000                     _MAXCYL:DB  0
       0000                     _WTFATF:DB  0   ;FATバッファの更新フラグ
                                        DS  1
       0000                     _WTDBF: DB  0   ;データバッファの更新フラグ
       0000                     _DBDRV: DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       0000                     _DBSEC: DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       0000                     _DPB:   DW  0
       0000                     _FATDRV:
       0000                         DB  0FFH    ;FATバッファに読み込んでいるドライブ
       0000                     _FATIX: DB  0   ;FATバッファに読み込んでいるインデックス
       0000                     _FAKEFREE:
       0000                         DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
                                    DS  2
                                
       0000                     CRTCD:  DB  06FH,WIDTH,059H,038H,01FH,002H,019H,01CH
       0000                         DB  000H,007H
       0000                         DW  0-WIDTH*LINE,0-WIDTH
       0000                         DB  00CH
       0000                     WK1FD0: DB  020H
                                
       0000                     CTC0:   DW  INTCTCE
       0000                     CTC1:   DW  INTCTCE
       0000                     CTC2:   DW  INTCTC2
       0000                     CTC3:   DW  INTCTCE
       0000                     INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
       0000                 10  _INKEY: JP  INKEY
       0000                 10  _PRINT: JP  PRINT
       0000                 10  _SCRN:  JP  SCRN
       0000                 10  _POS:   JP  POS
       0000                 10  _LOC:   JP  LOC
       0000                     _CHGDRV:
       0000                 10      JP  CHGDRV
       0000                     _GETDPB:
       0000                 10      JP  GETDPB
       0000                     _FFLUSH:
       0000                 10      JP  FFLUSH
       0000                     _RDFATX:
       0000                 10      JP  RDFATX
       0000                 10  _RDFAT: JP  RDFAT
       0000                 10  _WTTRK: JP  WTTRK
       0000                 10  _FDRD:  JP  FDRD
       0000                 10  _FDWT:  JP  FDWT
       0000                     _BPB2DPB:
       0000                 10      JP  BPB2DPB
                                    DS  3
       0000                     _GNCL:
       0000                 10  GNCPAT: JP  GNCL        ; self-modifying code
       0000                     _SNCL:
       0000                 10  SNCPAT: JP  SNCL        ; self-modifying code
       0000                 10  _COMANL:JP  COMANL
                                
       0000                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       0000                     STABLE:
                                ;0
       0000                         DW  _SYS00,_SYS01,_SYS02,_SYS03
       0000                         DW  _SYS04,_SYS05,_SYS06,_SYS07
       0000                         DW  _SYS08,_SYS09,_SYS0A,_SYS0B
       0000                         DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
       0000                         DW  _SYS10,_SYS11,_SYS12,_SYS13
       0000                         DW  _SYS14,_SYS15,_SYS16,_SYS17
       0000                         DW  _SYS18,_SYS19,_SYS1A,_SYS1B
       0000                         DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
       0000                         DW  _SYS20,_SYS21,_SYS22,_SYS23
       0000                         DW  _SYS24,_ERROR,_SYS26,_SYS27
       0000                         DW  _SYS28,_SYS5C,_SYS2A,_SYS2B
       0000                         DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
       0000                         DW  _SYS30,_ERROR,_ERROR,_ERROR
       0000                         DW  _ERROR,_ERROR,_ERROR,_ERROR
       0000                         DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
       0000                         DW  _DOS2
                                
                                    DS  2
       0000                     _FATBF: DW  FATBF
       0000                     _DTBUF: DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       0000                     CTRLTB:
       0000                         DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
       0000                         DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
       0000                         DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
       0000                         DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
       0000                         DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
       0000                         DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
       0000                         DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
       0000                         DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
       0000                     DEMES:  DB  3,7
       0000                         DB  "Device I/O Error",5,3
       0000                         DB  "Abort Retry Ignore?",5,3,0
                                
       0000                     SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
       0000                         DB  20,21       ;(FCB)ファイルを最後に変更した日付
       0000                         DB  26,27       ;(FCB)ファイルの先頭クラスタ
       0000                         DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       0000                     SDDATAE:
                                
                                SCDIR:  DS  2       ;+14 +15
                                SFBPS:  DS  2       ;FBPS
                                SFNDF:  DS  2       ;FILEN DIRF
                                
       0000                     _FATPS: DW  0
       0000                     _DIRPS: DW  0
       0000                     _CLPS:  DW  0
                                
       0000                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                
       0000                     LDEND:
                                
                                    END
[EOF:LD.ASZ:UTF_8]
