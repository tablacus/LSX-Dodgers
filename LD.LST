0000                ;	LSX-Dodgers for X1/turbo/Z
0000                ;	Programmed by
0000                ;	Gaku (Lovers/Tablacus)
0000                
0000                	INCLUDE	"LDDEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                
0000 00 00 1D 00    MAC	EQU	01D00H		;X1
0000 00 00 00 01    VER_1   EQU	1
0000 00 00 00 04    VER_2   EQU	4
0000 00 00 00 01    VER_3   EQU	1
0000 00 00 01 45    VER	EQU	VER_1 * 256 + VER_2 * 17 + VER_3
0000                
0000 00 00 00 05    SYSTEM	EQU	00005H
0000 00 00 00 0F    JP_HL	EQU	0000FH
0000 00 00 00 5C    FCB1	EQU	0005CH
0000 00 00 00 6C    FCB2	EQU	0006CH
0000 00 00 00 5D    FCB1FN	EQU	FCB1+1
0000 00 00 00 6D    FCB2FN	EQU	FCB2+1
0000 00 00 00 80    DTA1	EQU	00080H
0000                
0000 00 00 CB 00    RUN	EQU	0CB00H
0000 00 00 D1 06    BDOS	EQU	0D106H
0000 00 00 F2 00    FATBF	EQU	0F200H
0000 00 00 FA 00    DTBUF	EQU	0FA00H
0000 00 00 FE 00    KEYBF	EQU	0FE00H
0000 00 00 FF 00    KBUF	EQU	0FF00H
0000 00 00 FF CA    EXTSP	EQU	0FFCAH
0000 00 00 FF CA    EXTBIO	EQU	0FFCAH
0000 00 00 FF D9    TRAP38	EQU	0FFD9H
0000 00 00 00 18    LINE	EQU	24
0000                
0000                	ORG	RUN-7
CAF9                
CAF9                ;	MSX BINARY HEADER
CAF9 FE             	DB	0FEH
CAFA                ;	MSX BINARY START ADDRESS
CAFA 00 CB          	DW	RUN
CAFC                ;	MSX BINARY END ADDRESS
CAFC 00 F2          	DW	LDEND
CAFE                ;	MSX BINARY EXEC ADDRESS
CAFE 00 CB          	DW	RUN
CB00                
CB00                	INCLUDE	"LDINIT.ASM"
CB00                
CB00                ;	LSX-Dodgers INIT
CB00                
CB00 C3 07 CB       	JP	START
CB03 00 1D          MACHINE:DW	MAC
CB05 45 01          VERSION:DW	VER
CB07                
CB07                START:
CB07 F3             	DI
CB08 ED 5E          	IM	2
CB0A 31 CA FF       	LD	SP,EXTSP
CB0D CD 1B CB       	CALL	INIT		;NZならAUTOEXECを実行
CB10 21 00 00       	LD	HL,0
CB13 E5             	PUSH	HL
CB14 C8             	RET	Z
CB15 11 CB CE       	LD	DE,AUTOD
CB18 C3 FD EF       	JP	_COMANL
CB1B                
CB1B                INIT:
CB1B 3E 1E          	LD	A,01EH
CB1D D3 00          	OUT	(0),A
CB1F                
CB1F 01 00 00       	LD	BC,0
CB22 ED 43 8C EF    	LD	(_CTC),BC
CB26 01 04 0A       	LD	BC,00A04H
CB29 CD 75 CE       	CALL	CHKCTC
CB2C 01 04 07       	LD	BC,00704H
CB2F CD 75 CE       	CALL	CHKCTC
CB32 01 A8 1F       	LD	BC,01FA8H
CB35 CD 75 CE       	CALL	CHKCTC
CB38 01 A0 1F       	LD	BC,01FA0H
CB3B CD 75 CE       	CALL	CHKCTC
CB3E                ;
CB3E                INISIO:
CB3E 01 91 1F       	LD	BC,01F91H	;INIT SIO
CB41 16 01          	LD	D,1
CB43 ED 51          	OUT	(C),D
CB45                
CB45 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB47 0E 93          	LD	C,093H
CB49 ED 51          	OUT	(C),D
CB4B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB4D 0E 99          	LD	C,099H		;INIT SIO
CB4F 16 01          	LD	D,1
CB51 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB53 0E 9B          	LD	C,09BH
CB55 ED 51          	OUT	(C),D
CB57 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB59                
CB59 0E 80          	LD	C,080H		;INIT DMA
CB5B 21 06 C3       	LD	HL,0C306H
CB5E                INIDMA:
CB5E ED 61          	OUT	(C),H
CB60 2D             	DEC	L
CB61 20 FB          	JR	NZ,INIDMA
CB63                
CB63 3E E4          	LD	A,0E4H
CB65 CD 36 DF       	CALL	COMOUT
CB68 AF             	XOR	A
CB69 CD 10 DF       	CALL	OT49SB
CB6C                
CB6C 3E EF          	LD	A,INTVEC/256
CB6E ED 47          	LD	I,A
CB70                
CB70 ED 4B 8C EF    	LD	BC,(_CTC)
CB74 0B             	DEC	BC
CB75 0B             	DEC	BC
CB76                
CB76 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB78 3E C0          	LD	A,CTC0
CB7A ED 79          	OUT	(C),A
CB7C                
CB7C 0C             	INC	C
CB7D 3E 47          	LD	A,047H
CB7F ED 79          	OUT	(C),A
CB81 3E 0D          	LD	A,13		;Baudrate 9600-13
CB83 ED 79          	OUT	(C),A
CB85                
CB85 79             	LD	A,C
CB86 D6 10          	SUB	010H
CB88 4F             	LD	C,A
CB89                ;	LD	(SIOAD+1),BC
CB89                ;	LD	(SIOAD0+1),BC
CB89                ;	LD	(SIOAD1+1),BC
CB89                
CB89 21 2D CF       	LD	HL,SIODATA
CB8C                SINIT1:
CB8C 7E             	LD	A,(HL)
CB8D 23             	INC	HL
CB8E FE FF          	CP	0FFH
CB90 28 04          	JR	Z,SINIT2
CB92 ED 79          	OUT	(C),A
CB94 18 F6          	JR	SINIT1
CB96                SINIT2:
CB96 3E E4          	LD	A,0E4H
CB98 CD 36 DF       	CALL	COMOUT
CB9B 3E C8          	LD	A,INTVEC
CB9D CD 10 DF       	CALL	OT49SB
CBA0                ;
CBA0 01 C4 1F       	LD	BC,01FC4H
CBA3 3E 0C          	LD	A,00CH
CBA5 ED 79          	OUT	(C),A
CBA7                
CBA7 0E C0          	LD	C,0C0H
CBA9 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBAB                
CBAB 0C             	INC	C
CBAC 3E 28          	LD	A,40
CBAE ED 79          	OUT	(C),A
CBB0                
CBB0 0C             	INC	C
CBB1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBB3                
CBB3 0C             	INC	C
CBB4 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBB6                
CBB6 0E C5          	LD	C,0C5H
CBB8 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBBA                
CBBA                TEXT:
CBBA 0E B0          	LD	C,0B0H
CBBC 3E 80          	LD	A,080H
CBBE ED 79          	OUT	(C),A
CBC0 16 07          	LD	D,7
CBC2 0E B9          	LD	C,0B9H
CBC4 21 26 CF       	LD	HL,TEXTDT
CBC7                TEXT1:
CBC7 04             	INC	B
CBC8 ED A3          	OUTI
CBCA 0C             	INC	C
CBCB 15             	DEC	D
CBCC 20 F9          	JR	NZ,TEXT1
CBCE 01 B0 1F       	LD	BC,01FB0H
CBD1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBD3                
CBD3 0E C4          	LD	C,0C4H
CBD5 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBD7                
CBD7 01 01 1A       	LD	BC,01A01H
CBDA ED 78          	IN	A,(C)
CBDC E6 08          	AND	8
CBDE 28 09          	JR	Z,PRN
CBE0 0E 03          	LD	C,003H
CBE2 3E 0F          	LD	A,00FH
CBE4 ED 79          	OUT	(C),A
CBE6 01 04 0A       	LD	BC,00A04H
CBE9                PRN:
CBE9 21 00 00       	LD	HL,0
CBEC 06 5C          	LD	B,05CH
CBEE 3E FF          	LD	A,0FFH		;RST 38H
CBF0 CD 9E E1       	CALL	FILL_MEMORY
CBF3 06 A4          	LD	B,0A4H
CBF5 AF             	XOR	A
CBF6 CD 9E E1       	CALL	FILL_MEMORY
CBF9                
CBF9 3E C3          	LD	A,0C3H		;JP
CBFB 21 03 EF       	LD	HL,WBOOT
CBFE 32 00 00       	LD	(00000H),A
CC01 22 01 00       	LD	(00001H),HL	;IPL
CC04                
CC04 2A 03 CB       	LD	HL,(MACHINE)	;3 bit7  DPB Compatible LA(1)
CC07 22 03 00       	LD	(00003H),HL	;  bit6-0 Machine X1(0)
CC0A                ;				;4 LSX-Dodgers(01DH)
CC0A 21 06 D1       	LD	HL,BDOS
CC0D 32 05 00       	LD	(00005H),A
CC10 22 06 00       	LD	(00006H),HL	;BDOS
CC13                
CC13 21 13 DB       	LD	HL,BIOS
CC16 32 18 00       	LD	(00018H),A
CC19 22 19 00       	LD	(00019H),HL	;BIOS-ROM
CC1C                
CC1C 21 D9 FF       	LD	HL,TRAP38	;TRAP38
CC1F 32 38 00       	LD	(00038H),A
CC22 22 39 00       	LD	(00039H),HL	;RST 038H
CC25                
CC25 3E EF          	LD	A,BOOT/256
CC27 32 0B 00       	LD	(0000BH),A
CC2A                
CC2A 3E E9          	LD	A,0E9H		;JP (HL)
CC2C 32 0F 00       	LD	(0000FH),A
CC2F                
CC2F 3A 7D F0       	LD	A,(_FATBF+1)
CC32 32 13 00       	LD	(00013H),A
CC35                
CC35 3A 7F F0       	LD	A,(_DTBUF+1)
CC38 32 17 00       	LD	(00017H),A
CC3B                
CC3B 3E FE          	LD	A,KEYBF/256
CC3D 32 1B 00       	LD	(0001BH),A
CC40                
CC40 3E FF          	LD	A,KBUF/256
CC42 32 1F 00       	LD	(0001FH),A
CC45                
CC45 2A 05 CB       	LD	HL,(VERSION)
CC48 22 5A 00       	LD	(0005AH),HL
CC4B                
CC4B 3E E6          	LD	A,0E6H
CC4D CD 36 DF       	CALL	COMOUT
CC50 CD 1B DF       	CALL	IN49SB
CC53 F5             	PUSH	AF
CC54 CD 1B DF       	CALL	IN49SB
CC57 F1             	POP	AF
CC58 F5             	PUSH	AF
CC59 E6 12          	AND	012H
CC5B 20 05          	JR	NZ,KEYR
CC5D 3E 01          	LD	A,1
CC5F 32 C6 CD       	LD	(KEYREP+1),A
CC62                KEYR:
CC62 F1             	POP	AF
CC63 E6 03          	AND	3
CC65 28 0E          	JR	Z,NON
CC67                
CC67 01 D0 3F       	LD	BC,03FD0H
CC6A ED 49          	OUT	(C),C
CC6C 3E 37          	LD	A,037H
CC6E D3 D0          	OUT	(0D0H),A
CC70 ED 78          	IN	A,(C)
CC72 B9             	CP	C
CC73 28 78          	JR	Z,TURBO
CC75                NON:
CC75 3D             	DEC	A		;A=0FFH
CC76 32 18 00       	LD	(00018H),A	;BIOS-ROM
CC79                
CC79 21 39 CF       	LD	HL,AT_SCR1
CC7C 11 C0 DF       	LD	DE,SCR1
CC7F 01 A1 00       	LD	BC,SCRNX-SCR1	;転送先のサイズ確認用
CC82 01 9F 00       	LD	BC,AT_SCRE-AT_SCR1
CC85 ED B0          	LDIR
CC87                
CC87 21 D8 CF       	LD	HL,AT_WTTRK
CC8A 11 47 EE       	LD	DE,WTTRK
CC8D 01 B9 00       	LD	BC,DMAE-WTTRK	;転送先のサイズ確認用
CC90 01 B1 00       	LD	BC,AT_CPUE-AT_WTTRK
CC93 ED B0          	LDIR
CC95                
CC95 21 89 D0       	LD	HL,AT_EDWT
CC98 11 D9 D7       	LD	DE,EDWT
CC9B 01 4C 00       	LD	BC,EMME-EDWT	;転送先のサイズ確認用
CC9E 01 48 00       	LD	BC,AT_EMME-AT_EDWT
CCA1 ED B0          	LDIR
CCA3                
CCA3 21 A8 EE       	LD	HL,AT_DRD+AT_R
CCA6 22 EC EF       	LD	(_FDRD+1),HL
CCA9 21 4D EE       	LD	HL,AT_DWT+AT_R
CCAC 22 EF EF       	LD	(_FDWT+1),HL
CCAF 21 ED D7       	LD	HL,AT_EDRD+AT_RE
CCB2 22 82 F1       	LD	(EMMRD),HL
CCB5 21 D9 D7       	LD	HL,AT_EDWT+AT_RE
CCB8 22 84 F1       	LD	(EMMWR),HL
CCBB                
CCBB 3E 27          	LD	A,027H			;ノンターボはMFM切り替えを行わない
CCBD 32 12 F1       	LD	(DEVICE+012H),A		;Aドライブ
CCC0 32 32 F1       	LD	(DEVICE+012H+32),A	;Bドライブ
CCC3 32 52 F1       	LD	(DEVICE+012H+32*2),A	;Cドライブ
CCC6 32 72 F1       	LD	(DEVICE+012H+32*3),A	;Dドライブ
CCC9                
CCC9 21 00 00       	LD	HL,0
CCCC 22 61 DF       	LD	(X1PAT),HL
CCCF                
CCCF 3E AF          	LD	A,0AFH		;XOR	A
CCD1 32 80 DD       	LD	(X1KPAT),A
CCD4                
CCD4 21 61 E0       	LD	HL,SCRNX
CCD7 22 D1 EF       	LD	(_SCRN+1),HL
CCDA                
CCDA CD 9C CE       	CALL	SETCRTC
CCDD 06 10          	LD	B,010H		;PALET
CCDF ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCE1 04             	INC	B
CCE2 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCE4 04             	INC	B
CCE5 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCE7 04             	INC	B
CCE8 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCEA C3 81 CD       	JP	NOBANK
CCED                
CCED                TURBO:
CCED F3             	DI			;Check BIOS
CCEE 06 1D          	LD	B,01DH
CCF0 ED 79          	OUT	(C),A		;BIOS ON
CCF2 3A 51 2F       	LD	A,(02F51H)
CCF5 04             	INC	B		;B=01EH
CCF6 ED 79          	OUT	(C),A		;BIOS OFF
CCF8 FB             	EI
CCF9 FE C9          	CP	0C9H
CCFB 28 0B          	JR	Z,BIOSOK
CCFD 3E AF          	LD	A,0AFH		;XOR	A
CCFF 32 80 DD       	LD	(X1KPAT),A
CD02 21 61 E0       	LD	HL,SCRNX
CD05 22 D1 EF       	LD	(_SCRN+1),HL
CD08                BIOSOK:
CD08 3E 1F          	LD	A,01FH		;スタートポート
CD0A DB F0          	IN	A,(0F0H)
CD0C 0F             	RRCA
CD0D 38 0B          	JR	C,CRT1
CD0F 21 16 CF       	LD	HL,_C8025H
CD12 11 B0 EF       	LD	DE,CRTCD
CD15 01 10 00       	LD	BC,16
CD18 ED B0          	LDIR
CD1A                CRT1:
CD1A CD 9C CE       	CALL	SETCRTC
CD1D 01 AA 10       	LD	BC,010AAH	;PALET
CD20 ED 49          	OUT	(C),C
CD22 01 CC 11       	LD	BC,011CCH
CD25 ED 49          	OUT	(C),C
CD27 01 F0 12       	LD	BC,012F0H
CD2A ED 49          	OUT	(C),C
CD2C 04             	INC	B
CD2D ED 71          	DB	0EDH,071H
CD2F                
CD2F 3E 1F          	LD	A,01FH		;スタートポート
CD31 DB F0          	IN	A,(0F0H)
CD33 CB 57          	BIT	2,A
CD35 28 18          	JR	Z,BANK
CD37                
CD37 AF             	XOR	A
CD38                TZ1:				;前面スイッチが2HDの場合はMFMモードを2HDにしておく
CD38 F5             	PUSH	AF
CD39 CD DC EF       	CALL	_GETDPB
CD3C DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
CD3F E6 8F          	AND	08FH
CD41 FE 87          	CP	087H		;フロッピーでMEM切り替えがON
CD43 20 04          	JR	NZ,TZ2
CD45 DD CB 0A 86    	RES	0,(IX+0AH)	;(DPB_0A_FDMODE)
CD49                TZ2:
CD49 F1             	POP	AF
CD4A 3C             	INC	A
CD4B FE 08          	CP	8
CD4D 38 E9          	JR	C,TZ1
CD4F                
CD4F                BANK:
CD4F 01 00 0B       	LD	BC,00B00H
CD52 21 00 7F       	LD	HL,07F00H
CD55 F3             	DI
CD56                BANK1:
CD56 ED 69          	OUT	(C),L
CD58 5E             	LD	E,(HL)
CD59 7B             	LD	A,E
CD5A C6 A5          	ADD	A,0A5H
CD5C 77             	LD	(HL),A
CD5D BE             	CP	(HL)
CD5E 73             	LD	(HL),E
CD5F 20 05          	JR	NZ,BANK2
CD61 2C             	INC	L
CD62 CB 65          	BIT	4,L
CD64 28 F0          	JR	Z,BANK1
CD66                BANK2:
CD66 3E 10          	LD	A,010H
CD68 ED 79          	OUT	(C),A
CD6A 7D             	LD	A,L
CD6B B7             	OR	A
CD6C 28 13          	JR	Z,NOBANK
CD6E 26 00          	LD	H,0
CD70 29             	ADD	HL,HL	;*2
CD71 29             	ADD	HL,HL	;*4
CD72 29             	ADD	HL,HL	;*8
CD73 29             	ADD	HL,HL	;*16
CD74 29             	ADD	HL,HL	;*32
CD75 2B             	DEC	HL	;-1
CD76 2B             	DEC	HL	;-2
CD77 2B             	DEC	HL	;-3
CD78 22 A8 F1       	LD	(BANKCL),HL
CD7B CD BB CE       	CALL	CALC_FATLN
CD7E 32 A0 F1       	LD	(BANKFL),A
CD81                NOBANK:
CD81                EMM:
CD81 CD 65 CE       	CALL	EADR0
CD84 ED 78          	IN	A,(C)
CD86 F5             	PUSH	AF
CD87                
CD87 11 00 00       	LD	DE,0
CD8A                ECHECK1:
CD8A 13             	INC	DE
CD8B CD 48 CE       	CALL	EADR2
CD8E ED 60          	IN	H,(C)
CD90 CD 48 CE       	CALL	EADR2
CD93 7C             	LD	A,H
CD94 C6 E5          	ADD	A,0E5H
CD96 ED 79          	OUT	(C),A
CD98 3C             	INC	A
CD99 CD 65 CE       	CALL	EADR0
CD9C ED 79          	OUT	(C),A
CD9E 3D             	DEC	A
CD9F CD 48 CE       	CALL	EADR2
CDA2 ED 68          	IN	L,(C)
CDA4 CD 48 CE       	CALL	EADR2
CDA7 ED 61          	OUT	(C),H
CDA9 BD             	CP	L
CDAA 20 04          	JR	NZ,ECHECK2
CDAC CB 5A          	BIT	3,D
CDAE 28 DA          	JR	Z,ECHECK1
CDB0                ECHECK2:
CDB0 CD 65 CE       	CALL	EADR0
CDB3 F1             	POP	AF
CDB4 ED 79          	OUT	(C),A
CDB6                
CDB6 21 F7 FF       	LD	HL,0-9
CDB9 19             	ADD	HL,DE
CDBA 30 09          	JR	NC,NOEMM
CDBC 22 88 F1       	LD	(EMMCL),HL
CDBF CD BB CE       	CALL	CALC_FATLN
CDC2 32 80 F1       	LD	(EMMFL),A
CDC5                NOEMM:
CDC5 3E 00          KEYREP:	LD	A,000H
CDC7 B7             	OR	A
CDC8 28 07          	JR	Z,KEYR1
CDCA 01 00 00       	LD	BC,0
CDCD ED 43 8C EF    	LD	(_CTC),BC
CDD1                KEYR1:
CDD1 01 30 F8       	LD	BC,0-80*25
CDD4 2A BA EF       	LD	HL,(CRTCD+10)
CDD7 ED 43 BA EF    	LD	(CRTCD+10),BC
CDDB 1E 0C          	LD	E,00CH
CDDD CD CD EF       	CALL	_PRINT
CDE0 22 BA EF       	LD	(CRTCD+10),HL
CDE3                
CDE3 21 D7 CE       	LD	HL,INIMES
CDE6 CD 69 D8       	CALL	MSX
CDE9                
CDE9 3A 87 FF       	LD	A,(0FF87H)
CDEC FE 08          	CP	8
CDEE 30 1E          	JR	NC,INIT0
CDF0 5F             	LD	E,A
CDF1 C6 41          	ADD	A,'A'
CDF3 32 D4 CE       	LD	(AUTODV),A
CDF6 0E 0E          	LD	C,00EH
CDF8 CD 05 00       	CALL	SYSTEM
CDFB 1C             	INC	E
CDFC 21 85 EF       	LD	HL,_SEEKSP	;Disk error Ignore
CDFF CB FE          	SET	7,(HL)
CE01 0E 1B          	LD	C,01BH
CE03 CD 05 00       	CALL	SYSTEM
CE06                
CE06 21 85 EF       	LD	HL,_SEEKSP
CE09 CB BE          	RES	7,(HL)
CE0B                
CE0B 3C             	INC	A
CE0C 20 08          	JR	NZ,INIT1
CE0E                INIT0:
CE0E 1E 00          	LD	E,0
CE10 0E 0E          	LD	C,00EH
CE12 CD 05 00       	CALL	SYSTEM
CE15 AF             	XOR	A
CE16                INIT1:
CE16 F3             	DI
CE17 08             	EX	AF,AF'
CE18 2E FE          	LD	L,0-2		;CALLのスタック分減らす
CE1A 39             	ADD	HL,SP
CE1B 11 00 FF       	LD	DE,0FF00H
CE1E 45             	LD	B,L
CE1F CD 11 D5       	CALL	ZERO_MEMORY_DE
CE22 21 CA FF       	LD	HL,EXTSP
CE25 06 0F          	LD	B,TRAP38-EXTBIO
CE27 3E FF          	LD	A,0FFH		;RST 38H
CE29 CD 9E E1       	CALL	FILL_MEMORY
CE2C 21 D1 D0       	LD	HL,AT_TRAP38
CE2F 11 D9 FF       	LD	DE,TRAP38
CE32 01 27 00       	LD	BC,AT_TRAPE-AT_TRAP38
CE35 ED B0          	LDIR
CE37 08             	EX	AF,AF'
CE38 B7             	OR	A
CE39 C8             	RET	Z
CE3A                
CE3A 3E E6          	LD	A,0E6H
CE3C CD 36 DF       	CALL	COMOUT
CE3F CD 1B DF       	CALL	IN49SB
CE42 CD 1B DF       	CALL	IN49SB
CE45 FE 1B          	CP	01BH
CE47 C9             	RET
CE48                
CE48                EADR2:
CE48 D5             	PUSH	DE
CE49 EB             	EX	DE,HL
CE4A 29             	ADD	HL,HL
CE4B 29             	ADD	HL,HL
CE4C ED 4B 8B F1    	LD	BC,(EMMBL-1)
CE50 0E 00          	LD	C,0
CE52 09             	ADD	HL,BC
CE53 ED 4B 93 F1    	LD	BC,(EMMDV)
CE57 06 0D          	LD	B,00DH
CE59 ED 49          	OUT	(C),C
CE5B 0C             	INC	C
CE5C ED 69          	OUT	(C),L
CE5E 0C             	INC	C
CE5F ED 61          	OUT	(C),H
CE61 0C             	INC	C
CE62 EB             	EX	DE,HL
CE63 D1             	POP	DE
CE64 C9             	RET
CE65                
CE65                EADR0:
CE65 ED 4B 93 F1    	LD	BC,(EMMDV)
CE69 06 0D          	LD	B,00DH
CE6B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CE6D 0C             	INC	C
CE6E ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CE70 0C             	INC	C
CE71 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CE73 0C             	INC	C
CE74 C9             	RET
CE75                
CE75                CHKCTC:
CE75 C5             	PUSH	BC
CE76 11 03 47       	LD	DE,04703H
CE79                INICTC1:
CE79 0C             	INC	C
CE7A ED 51          	OUT	(C),D
CE7C ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CE7E 1D             	DEC	E
CE7F 20 F8          	JR	NZ,INICTC1
CE81 C1             	POP	BC
CE82                
CE82 11 FA 07       	LD	DE,007FAH
CE85 ED 51          	OUT	(C),D
CE87 ED 59          	OUT	(C),E
CE89 ED 78          	IN	A,(C)
CE8B BB             	CP	E
CE8C C0             	RET	NZ
CE8D ED 51          	OUT	(C),D
CE8F ED 51          	OUT	(C),D
CE91 ED 78          	IN	A,(C)
CE93 BA             	CP	D
CE94 C0             	RET	NZ
CE95 03             	INC	BC
CE96 03             	INC	BC
CE97 ED 43 8C EF    	LD	(_CTC),BC
CE9B C9             	RET
CE9C                
CE9C                SETCRTC:
CE9C 21 B0 EF       	LD	HL,CRTCD
CE9F AF             	XOR	A
CEA0                SETCRT1:
CEA0 01 00 18       	LD	BC,01800H
CEA3 ED 79          	OUT	(C),A
CEA5 0C             	INC	C
CEA6 04             	INC	B
CEA7 ED A3          	OUTI
CEA9 3C             	INC	A
CEAA FE 0C          	CP	12
CEAC 20 F2          	JR	NZ,SETCRT1
CEAE 23             	INC	HL
CEAF 23             	INC	HL
CEB0 01 03 1B       	LD	BC,01A03H+00100H
CEB3 ED A3          	OUTI
CEB5 01 D0 20       	LD	BC,01FD0H+00100H
CEB8 ED A3          	OUTI
CEBA C9             	RET
CEBB                
CEBB                CALC_FATLN:	;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
CEBB 5D             	LD	E,L
CEBC 54             	LD	D,H
CEBD 29             	ADD	HL,HL	;*2
CEBE 19             	ADD	HL,DE	;*3
CEBF CB 3C          	SRL	H	;/2
CEC1 CB 1D          	RR	L	;1クラスタ辺り1.5バイト必要
CEC3 11 FF 01       	LD	DE,511	;切り上げる
CEC6 19             	ADD	HL,DE
CEC7 7C             	LD	A,H
CEC8 CB 3F          	SRL	A
CECA C9             	RET
CECB                
CECB 41 55 54 4F    AUTOD:	DB	"AUTOEXEC "
CECF 45 58 45 43
CED3 20
CED4 41 3A 00       AUTODV:	DB	"A:",0
CED7                
CED7 4C 53 58 2D    INIMES:	DB	"LSX-Dodgers for X1/turbo version "
CEDB 44 6F 64 67
CEDF 65 72 73 20
CEE3 66 6F 72 20
CEE7 58 31 2F 74
CEEB 75 72 62 6F
CEEF 20 76 65 72
CEF3 73 69 6F 6E
CEF7 20
CEF8 31 2E          	DB	030H + VER_1, '.'
CEFA 34 31          	DB	030H + VER_2 ,030H + VER_3
CEFC 20 47 61 6B    	DB	' Gaku (Lovers/Tablacus)',0DH,0AH
CF00 75 20 28 4C
CF04 6F 76 65 72
CF08 73 2F 54 61
CF0C 62 6C 61 63
CF10 75 73 29 0D
CF14 0A
CF15 00             	DB	0
CF16                
CF16                _C8025H:
CF16 6B 50 59 88    	DB	06BH,050H,059H,088H,01BH,001H,019H,01AH
CF1A 1B 01 19 1A
CF1E 00 0F          	DB	000H,00FH
CF20 80 F8 B0 FF    	DW	0-80*LINE,0-80
CF24 0C A3          	DB	00CH,0A3H
CF26                
CF26 03 0C 0F 30    TEXTDT:	DB	003H,00CH,00FH,030H,033H,03CH,03FH
CF2A 33 3C 3F
CF2D                
CF2D                SIODATA:
CF2D 18             	DB	018H
CF2E 01 00          	DB	1,0
CF30 02 00          	DB	2,0
CF32 03 C1          	DB	3,0C1H
CF34 04 44          	DB	4,044H
CF36 05 E8          	DB	5,0E8H
CF38 FF             	DB	0FFH
CF39                
CF39                ;	ノンターボ用パッチ
CF39                
CF39                AT_SCR1:
CF39 D9             	EXX
CF3A C5             	PUSH	BC
CF3B 01 50 20       	LD	BC,02000H+80
CF3E D9             	EXX
CF3F C5             	PUSH	BC
CF40 01 00 20       	LD	BC,02000H
CF43                
CF43 67             	LD	H,A
CF44 B7             	OR	A
CF45                AT_SCRUP1:
CF45 28 15          	JR	Z,AT_SCRCL
CF47 C5             	PUSH	BC
CF48 CB E0          	SET	4,B
CF4A D9             	EXX
CF4B C5             	PUSH	BC
CF4C CB E0          	SET	4,B
CF4E D9             	EXX
CF4F CD FA DF       	CALL	AT_UPSUB+AT_RS
CF52 D9             	EXX
CF53 C1             	POP	BC
CF54 D9             	EXX
CF55 C1             	POP	BC
CF56 CD FA DF       	CALL	AT_UPSUB+AT_RS
CF59 25             	DEC	H
CF5A 18 E9          	JR	AT_SCRUP1
CF5C                
CF5C                AT_SCRCL:
CF5C 21 50 20       	LD	HL,02000H+80
CF5F 3A 96 EF       	LD	A,(_COLORF)
CF62                AT_SCRCL1:
CF62 CB E0          	SET	4,B
CF64 ED 61          	OUT	(C),H
CF66 CB A0          	RES	4,B
CF68 ED 79          	OUT	(C),A
CF6A 03             	INC	BC
CF6B 2D             	DEC	L
CF6C 20 F4          	JR	NZ,AT_SCRCL1
CF6E C1             	POP	BC
CF6F D9             	EXX
CF70 C1             	POP	BC
CF71 D9             	EXX
CF72 C9             	RET
CF73                
CF73                AT_UPSUB:
CF73 2E 28          	LD	L,40
CF75                AT_UPSUB1:
CF75 D9             	EXX
CF76 ED 78          	IN	A,(C)
CF78 03             	INC	BC
CF79 D9             	EXX
CF7A ED 79          	OUT	(C),A
CF7C 03             	INC	BC
CF7D D9             	EXX
CF7E ED 78          	IN	A,(C)
CF80 03             	INC	BC
CF81 D9             	EXX
CF82 ED 79          	OUT	(C),A
CF84 03             	INC	BC
CF85 2D             	DEC	L
CF86 20 ED          	JR	NZ,AT_UPSUB1
CF88 C9             	RET
CF89                
CF89                ;	FLOPPY DISK DRIVER(CPU)
CF89                
CF89                DISKC:
CF89 1B             	DEC	DE
CF8A CB 5F          	BIT	3,A
CF8C C4 40 EE       	CALL	NZ,RNF
CF8F                DISKD:
CF8F E5             	PUSH	HL
CF90 21 46 EE       	LD	HL,RETRY
CF93 35             	DEC	(HL)
CF94 E1             	POP	HL
CF95 20 3E          	JR	NZ,AT_ERR		;Retry
CF97 B7             	OR	A
CF98 28 3B          	JR	Z,AT_ERR		;Error
CF9A                
CF9A                AT_DELP:
CF9A CD 40 EE       	CALL	RNF
CF9D CD 1C EE       	CALL	FDMOFF
CFA0 3A 85 EF       	LD	A,(_SEEKSP)
CFA3 87             	ADD	A,A
CFA4 38 2E          	JR	C,AT_ERRZ
CFA6                AT_DELP1:
CFA6 D5             	PUSH	DE
CFA7 21 C0 F0       	LD	HL,DEMES
CFAA CD 69 D8       	CALL	MSX
CFAD CD E4 DB       	CALL	KEYBC
CFB0                AT_DELP2:
CFB0 CD CA EF       	CALL	_INKEY
CFB3 28 FB          	JR	Z,AT_DELP2
CFB5                
CFB5 D1             	POP	DE
CFB6 CD FE E3       	CALL	CAP
CFB9 FE 52          	CP	'R'		;Retry
CFBB 20 0A          	JR	NZ,AT_DELP3
CFBD 21 00 00       DHLPAT:	LD	HL,0
CFC0 3E 02          	LD	A,2
CFC2 32 46 EE       	LD	(RETRY),A
CFC5 B7             	OR	A
CFC6 C9             	RET
CFC7                AT_DELP3:
CFC7 FE 49          	CP	'I'		;Ignore
CFC9 28 07          	JR	Z,AT_IGNORE
CFCB FE 41          	CP	'A'		;Abort
CFCD 20 D7          	JR	NZ,AT_DELP1
CFCF C3 00 EF       	JP	BOOT
CFD2                AT_IGNORE:
CFD2 3E FF          	LD	A,0FFH
CFD4                AT_ERRZ:
CFD4 BF             	CP	A
CFD5                AT_ERR:
CFD5 3E FF          	LD	A,0FFH
CFD7 C9             	RET
CFD8                
CFD8                AT_SCRE:
CFD8                
CFD8                AT_WTTRK:
CFD8 06 01          	LD	B,1
CFDA 3E F0          	LD	A,0F0H
CFDC 18 02          	JR	AT_WTTRK1
CFDE                AT_DWT:
CFDE 3E A0          	LD	A,0A0H
CFE0                AT_WTTRK1:
CFE0 32 E4 ED       	LD	(FDCPAT+1),A
CFE3                DWTBL:
CFE3 78             	LD	A,B
CFE4 32 93 EE       	LD	(AT_WTB+1+AT_R),A
CFE7 3E 02          	LD	A,2		;Retry count
CFE9 32 46 EE       	LD	(RETRY),A
CFEC                
CFEC                DWT0:
CFEC D5             	PUSH	DE
CFED E5             	PUSH	HL
CFEE 22 45 E0       	LD	(DHLPAT+1+AT_RS),HL
CFF1 CD 7E ED       	CALL	SEEK		;Write disk
CFF4 E1             	POP	HL
CFF5 38 38          	JR	C,ERRDW
CFF7 F3             	DI
CFF8 3A E4 ED       	LD	A,(FDCPAT+1)
CFFB CD 28 EE       	CALL	SECSET
CFFE 0E FB          	LD	C,0FBH
D000                
D000                DWT1:
D000 56             	LD	D,(HL)
D001                DWT2:
D001 78             	LD	A,B
D002 DB F8          	IN	A,(0F8H)
D004 0F             	RRCA
D005 30 08          	JR	NC,DWT4
D007 0F             	RRCA
D008 30 F7          	JR	NC,DWT2
D00A                DWT3:
D00A ED 51          	OUT	(C),D
D00C 23             	INC	HL
D00D 18 F1          	JR	DWT1
D00F                
D00F                DWT4:
D00F 3D             	DEC	A
D010 28 F8          	JR	Z,DWT3
D012 3C             	INC	A
D013 FB             	EI
D014 D1             	POP	DE
D015 13             	INC	DE
D016 CD 1C EE       	CALL	FDMOFF
D019 28 08          	JR	Z,DISKOK_WT
D01B CD 10 E0       	CALL	DISKC+AT_RS
D01E 20 CC          	JR	NZ,DWT0
D020 B7             	OR	A
D021 20 05          	JR	NZ,ERRW
D023                
D023                DISKOK_WT:
D023 06 01          AT_WTB:	LD	B,1
D025 10 BC          	DJNZ	DWTBL
D027 C9             	RET
D028                
D028                ERRW:
D028 3E FF          	LD	A,0FFH
D02A                ERRZ:
D02A BF             	CP	A
D02B 37             	SCF
D02C C3 1C EE       	JP	FDMOFF
D02F                
D02F                ERRDW:
D02F D1             	POP	DE
D030 CD 21 E0       	CALL	AT_DELP+AT_RS
D033 20 B7          	JR	NZ,DWT0
D035 B7             	OR	A
D036 20 F0          	JR	NZ,ERRW
D038 C9             	RET
D039                
D039                AT_DRD:
D039 3E 80          	LD	A,080H
D03B 32 E4 ED       	LD	(FDCPAT+1),A
D03E                DRDBL:
D03E 78             	LD	A,B
D03F 32 EA EE       	LD	(AT_RDB+1+AT_R),A
D042 3E 02          	LD	A,2		;Retry count
D044 32 46 EE       	LD	(RETRY),A
D047                DRD0:
D047 D5             	PUSH	DE
D048 E5             	PUSH	HL
D049 22 45 E0       	LD	(DHLPAT+1+AT_RS),HL
D04C CD 7E ED       	CALL	SEEK		;Read disk
D04F E1             	POP	HL
D050 38 2D          	JR	C,ERRDR
D052 F3             	DI
D053 3A E4 ED       	LD	A,(FDCPAT+1)
D056 CD 28 EE       	CALL	SECSET
D059 0E FB          	LD	C,0FBH
D05B                DRD1:
D05B 78             	LD	A,B
D05C DB F8          	IN	A,(0F8H)
D05E 0F             	RRCA
D05F 30 08          	JR	NC,DRD3
D061 0F             	RRCA
D062 30 F7          	JR	NC,DRD1
D064 ED A2          	INI
D066 04             	INC	B
D067 18 F2          	JR	DRD1
D069                
D069                DRD3:
D069 B7             	OR	A
D06A FB             	EI
D06B D1             	POP	DE
D06C 13             	INC	DE
D06D CD 1C EE       	CALL	FDMOFF
D070 28 08          	JR	Z,DISKOK_RD
D072 CD 10 E0       	CALL	DISKC+AT_RS
D075 20 D0          	JR	NZ,DRD0
D077 B7             	OR	A
D078 20 AE          	JR	NZ,ERRW
D07A                
D07A                DISKOK_RD:
D07A 06 01          AT_RDB:	LD	B,1
D07C 10 C0          	DJNZ	DRDBL
D07E C9             	RET
D07F                
D07F                ERRDR:
D07F D1             	POP	DE
D080 CD 21 E0       	CALL	AT_DELP+AT_RS
D083 20 C2          	JR	NZ,DRD0
D085 B7             	OR	A
D086 20 A0          	JR	NZ,ERRW
D088 C9             	RET
D089                
D089                AT_CPUE:
D089                
D089                
D089                ;	EMM DRIVER(CPU)
D089                
D089                
D089                AT_EDWT:
D089 CD 01 D8       	CALL	AT_EADR+AT_RE
D08C                AT_EDWT0:
D08C F5             	PUSH	AF
D08D AF             	XOR	A
D08E                AT_EDWT1:
D08E 04             	INC	B
D08F ED A3          	OUTI
D091 04             	INC	B
D092 ED A3          	OUTI
D094 3D             	DEC	A
D095 20 F7          	JR	NZ,AT_EDWT1
D097 13             	INC	DE
D098 F1             	POP	AF
D099 3D             	DEC	A
D09A 20 F0          	JR	NZ,AT_EDWT0
D09C C9             	RET
D09D                
D09D                AT_EDRD:
D09D CD 01 D8       	CALL	AT_EADR+AT_RE
D0A0                AT_EDRD0:
D0A0 F5             	PUSH	AF
D0A1 AF             	XOR	A
D0A2                AT_EDRD1:
D0A2 ED A2          	INI
D0A4 04             	INC	B
D0A5 ED A2          	INI
D0A7 04             	INC	B
D0A8 3D             	DEC	A
D0A9 20 F7          	JR	NZ,AT_EDRD1
D0AB 13             	INC	DE
D0AC F1             	POP	AF
D0AD 3D             	DEC	A
D0AE 20 F0          	JR	NZ,AT_EDRD0
D0B0 C9             	RET
D0B1                
D0B1                AT_EADR:
D0B1 C5             	PUSH	BC
D0B2 D5             	PUSH	DE
D0B3 EB             	EX	DE,HL
D0B4 29             	ADD	HL,HL
D0B5 29             	ADD	HL,HL
D0B6 0E 00          	LD	C,0
D0B8 3A A1 EF       	LD	A,(_MAXCYL)
D0BB 47             	LD	B,A
D0BC 09             	ADD	HL,BC
D0BD 3A 84 EF       	LD	A,(_DRIVE)
D0C0 4F             	LD	C,A
D0C1 06 0D          	LD	B,00DH
D0C3 ED 49          	OUT	(C),C
D0C5 0C             	INC	C
D0C6 ED 69          	OUT	(C),L
D0C8 0C             	INC	C
D0C9 ED 61          	OUT	(C),H
D0CB 0C             	INC	C
D0CC EB             	EX	DE,HL
D0CD D1             	POP	DE
D0CE F1             	POP	AF
D0CF A7             	AND	A	;CF=0
D0D0 C9             	RET
D0D1                AT_EMME:
D0D1                
D0D1                AT_TRAP38:
D0D1 21 00 00       	LD	HL,0
D0D4 E3             	EX	(SP),HL
D0D5 3E 24          	LD	A,'$'
D0D7 CD 1B DC       	CALL	MSG_A
D0DA 2B             	DEC	HL
D0DB 7C             	LD	A,H
D0DC CD E8 FF       	CALL	PRHX+AT_RT
D0DF 7D             	LD	A,L
D0E0                PRHX:
D0E0 F5             	PUSH	AF
D0E1 07             	RLCA
D0E2 07             	RLCA
D0E3 07             	RLCA
D0E4 07             	RLCA
D0E5 CD F1 FF       	CALL	PRHX2+AT_RT
D0E8 F1             	POP	AF
D0E9                PRHX2:
D0E9 E6 0F          	AND	00FH
D0EB FE 0A          	CP	10
D0ED 38 02          	JR	C,PRHX3
D0EF C6 07          	ADD	A,'A'-'0'-10
D0F1                PRHX3:
D0F1 C6 30          	ADD	A,'0'
D0F3 C3 1B DC       	JP	MSG_A
D0F6                	DS	2
D0F8                AT_TRAPE:
D0F8                
D0F8 00 00 2F 08    AT_RT	EQU	TRAP38-AT_TRAP38
D0F8                
D0F8                INITE:
D0F8                	DS	BDOS-INITE
D106                
D106 C3 25 D8       	JP	BDOS0
D109                	DS	2	;Reserved
D10B                	INCLUDE	"LDCCP.ASM"
D10B                
D10B                ;	LSX-Dodgers CCP
D10B                
D10B                WBOOT1:
D10B F3             	DI
D10C ED 7B 06 00    	LD	SP,(SYSTEM+1)
D110                
D110 3E EF          	LD	A,INTVEC/256
D112 ED 47          	LD	I,A
D114                
D114 3E E4          	LD	A,0E4H
D116 CD 36 DF       	CALL	COMOUT
D119 3E C8          	LD	A,INTVEC
D11B CD 10 DF       	CALL	OT49SB
D11E                
D11E 3A BC EF       	LD	A,(CRTCD+12)
D121 B7             	OR	A
D122 20 0C          	JR	NZ,SETCRT0
D124 21 80 F8       	LD	HL,0-80*LINE
D127 22 BA EF       	LD	(CRTCD+10),HL
D12A 21 B0 FF       	LD	HL,0-80
D12D 22 BC EF       	LD	(CRTCD+12),HL
D130                SETCRT0:
D130 21 B0 EF       	LD	HL,CRTCD
D133 AF             	XOR	A
D134                SETCRT2:
D134 01 00 18       	LD	BC,01800H
D137 ED 79          	OUT	(C),A
D139 0C             	INC	C
D13A 04             	INC	B
D13B ED A3          	OUTI
D13D 3C             	INC	A
D13E FE 0C          	CP	12
D140 20 F2          	JR	NZ,SETCRT2
D142 0D             	DEC	C
D143 ED 79          	OUT	(C),A
D145 0C             	INC	C
D146 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
D148                
D148 0D             	DEC	C
D149 3C             	INC	A
D14A ED 79          	OUT	(C),A
D14C 0C             	INC	C
D14D ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
D14F 23             	INC	HL
D150 23             	INC	HL
D151 01 03 1B       	LD	BC,01A03H+00100H
D154 ED A3          	OUTI
D156 01 D0 20       	LD	BC,01FD0H+00100H
D159 ED A3          	OUTI
D15B 21 92 EF       	LD	HL,_KEYD
D15E 3E 03          	LD	A,3
D160 BE             	CP	(HL)
D161 CC E4 DB       	CALL	Z,KEYBC
D164 36 00          	LD	(HL),0
D166 3E 04          	LD	A,4
D168 CD 1B DC       	CALL	MSG_A
D16B                COMMAND:
D16B CD 1E D2       	CALL	SETDTA1
D16E 3A 87 EF       	LD	A,(_DVSW)
D171 C6 41          	ADD	A,'A'
D173 CD 1B DC       	CALL	MSG_A
D176 3E 3E          	LD	A,'>'
D178 CD 1B DC       	CALL	MSG_A
D17B 3E 50          	LD	A,80
D17D 12             	LD	(DE),A
D17E CD 6A DC       	CALL	_SYS0A		;(BDOS)文字列入力
D181 CD D3 D3       	CALL	LTNL
D184                
D184 11 82 00       	LD	DE,DTA1+2
D187 CD FD EF       	CALL	_COMANL
D18A 30 DF          	JR	NC,COMMAND
D18C 11 79 EF       	LD	DE,COMERM
D18F CD 5A D8       	CALL	_SYS09		;(BDOS)文字列出力
D192 C7             	RST	0
D193                
D193                COMANL:
D193 CD F2 E0       	CALL	FILE
D196 3A 19 EF       	LD	A,(FNAME+4)
D199 FE 20          	CP	020H
D19B 20 1C          	JR	NZ,COMB2
D19D D5             	PUSH	DE
D19E 11 15 EF       	LD	DE,FNAME
D1A1 1A             	LD	A,(DE)
D1A2 FE 20          	CP	020H
D1A4 28 44          	JR	Z,SDVSW
D1A6 1B             	DEC	DE
D1A7 1A             	LD	A,(DE)
D1A8 C6 FF          	ADD	A,0FFH
D1AA 38 09          	JR	C,COMB
D1AC 13             	INC	DE
D1AD                
D1AD 21 DE D6       	LD	HL,COMTB
D1B0 06 09          	LD	B,COMS
D1B2 CD 76 E3       	CALL	CPNAME
D1B5                COMB:
D1B5 D1             	POP	DE
D1B6 D2 0F 00       	JP	NC,JP_HL
D1B9                COMB2:
D1B9 EB             	EX	DE,HL
D1BA 22 92 D2       	LD	(COMPAT+1),HL
D1BD F5             	PUSH	AF
D1BE CD 3E D2       	CALL	CEXE4
D1C1 F1             	POP	AF
D1C2 21 15 EF       	LD	HL,FNAME
D1C5 11 6D 00       	LD	DE,FCB2+1	;COMMAND NAME
D1C8 01 0B 00       	LD	BC,11
D1CB ED B0          	LDIR
D1CD 11 9D D6       	LD	DE,PATHD
D1D0                CEX1:
D1D0 1A             	LD	A,(DE)
D1D1 FE 20          	CP	020H
D1D3 D8             	RET	C
D1D4 CD E7 E0       	CALL	FILEC
D1D7 D5             	PUSH	DE
D1D8 21 6D 00       	LD	HL,FCB2+1	;COMMAND NAME
D1DB 11 15 EF       	LD	DE,FNAME
D1DE 01 0B 00       	LD	BC,11
D1E1 ED B0          	LDIR
D1E3 CD 3E D2       	CALL	CEXE4
D1E6 D1             	POP	DE
D1E7 13             	INC	DE
D1E8 18 E6          	JR	CEX1
D1EA                
D1EA                SDVSW:
D1EA F1             	POP	AF
D1EB 3A 14 EF       	LD	A,(FDRV)
D1EE 3D             	DEC	A
D1EF 5F             	LD	E,A
D1F0 0E 0E          	LD	C,00EH		;(BDOS)カレントドライブの設定
D1F2 18 31          	JR	SYSTEM0
D1F4                
D1F4                OPEN1:
D1F4 21 14 EF       	LD	HL,FDRV
D1F7                OPEN:
D1F7 0E 11          	LD	C,011H		;(BDOS)ファイルの検索
D1F9                OPEN3:
D1F9 D5             	PUSH	DE
D1FA 11 78 D6       	LD	DE,DTA_CCP
D1FD CD 1B D2       	CALL	SETDTA
D200 EB             	EX	DE,HL
D201 CD 25 D2       	CALL	SYSTEM0
D204 D1             	POP	DE
D205 C9             	RET
D206                
D206                OPEN2:
D206 0E 12          	LD	C,012H
D208 18 EF          	JR	OPEN3
D20A                
D20A                DEFCB:				;Z=Ok NZ=Error
D20A 11 78 D6       	LD	DE,DTA_CCP
D20D CD 23 D2       	CALL	SYSC0F
D210                
D210 11 99 D6       	LD	DE,DTA_CCP+33	;(FCB)ランダムレコード
D213 06 04          	LD	B,4
D215 CD 11 D5       	CALL	ZERO_MEMORY_DE
D218 11 00 01       	LD	DE,00100H
D21B                SETDTA:
D21B C3 5C DA       	JP	_SYS1A		;(BDOS)DTAの設定
D21E                
D21E                SETDTA1:
D21E 11 80 00       	LD	DE,DTA1
D221 18 F8          	JR	SETDTA
D223                
D223                SYSC0F:
D223 0E 0F          	LD	C,00FH		;(BDOS)ファイルのオープン
D225                SYSTEM0:
D225 CD 05 00       	CALL	SYSTEM
D228 B7             	OR	A
D229 C9             	RET
D22A                
D22A                C_CD:
D22A 0E 3B          	LD	C,3BH
D22C 18 F7          	JR	SYSTEM0
D22E                
D22E                S27BUF:
D22E 3A 07 00       	LD	A,(SYSTEM+2)
D231 3D             	DEC	A
D232 E6 F8          	AND	0F8H
D234 67             	LD	H,A
D235 2E 00          	LD	L,0
D237                S27DTA:
D237 11 78 D6       	LD	DE,DTA_CCP
D23A                S27:
D23A 0E 27          	LD	C,027H		;(BDOS)ランダムブロック読み込み
D23C 18 E7          	JR	SYSTEM0
D23E                
D23E                CEXE4:
D23E 3A 14 EF       	LD	A,(FDRV)
D241 32 57 00       	LD	(00057H),A
D244 2A 22 EF       	LD	HL,(FDRV+14)
D247 22 58 00       	LD	(00058H),HL
D24A                
D24A 21 1D EF       	LD	HL,FNAME+8
D24D 7E             	LD	A,(HL)
D24E FE 20          	CP	020H
D250 20 07          	JR	NZ,CEXE7
D252 3E 3F          	LD	A,'?'
D254 77             	LD	(HL),A
D255 23             	INC	HL
D256 77             	LD	(HL),A
D257 23             	INC	HL
D258 77             	LD	(HL),A
D259                CEXE7:
D259 CD F4 D1       	CALL	OPEN1
D25C                CEXE5:
D25C C0             	RET	NZ
D25D 2A 82 D6       	LD	HL,(DTA_CCP+1+9)
D260 7C             	LD	A,H
D261 CD FE E3       	CALL	CAP
D264 67             	LD	H,A
D265 7D             	LD	A,L
D266 CD FE E3       	CALL	CAP
D269 6F             	LD	L,A
D26A 3A 81 D6       	LD	A,(DTA_CCP+1+8)
D26D CD FE E3       	CALL	CAP
D270 D6 42          	SUB	'B'
D272 28 2C          	JR	Z,C_BAT
D274 3D             	DEC	A		;'C'
D275 28 05          	JR	Z,C_EXE
D277                CEXE6:
D277 CD 06 D2       	CALL	OPEN2
D27A 18 E0          	JR	CEXE5
D27C                
D27C                C_EXE:
D27C 7C             	LD	A,H
D27D FE 4D          	CP	'M'
D27F 20 F6          	JR	NZ,CEXE6
D281                
D281 CD 0A D2       	CALL	DEFCB
D284 CD 2E D2       	CALL	S27BUF
D287 3D             	DEC	A
D288 37             	SCF
D289 C0             	RET	NZ
D28A 7C             	LD	A,H
D28B B5             	OR	L
D28C 37             	SCF
D28D C8             	RET	Z
D28E CD 1E D2       	CALL	SETDTA1
D291 11 00 00       COMPAT:	LD	DE,0				; self-modifying code
D294 ED 7B 06 00    	LD	SP,(SYSTEM+1)
D298 67             	LD	H,A				; A=0 in SETDTA1(_SYS1A)
D299 6F             	LD	L,A
D29A E5             	PUSH	HL				; push $0000 (reboot address)
D29B 24             	INC	H
D29C E5             	PUSH	HL				; push $0100 (TPA address)
D29D C3 DC D4       	JP	SETFCB				; and JP $0100
D2A0                
D2A0                C_BAT:
D2A0 11 41 54       	LD	DE,'A'+'T'*256
D2A3 ED 52          	SBC	HL,DE
D2A5 20 D0          	JR	NZ,CEXE6
D2A7                
D2A7 F1             	POP	AF
D2A8 F1             	POP	AF
D2A9 CD 0A D2       	CALL	DEFCB
D2AC 21 00 02       	LD	HL,00200H
D2AF CD 37 D2       	CALL	S27DTA
D2B2 C6 FE          	ADD	A,0FEH
D2B4 D8             	RET	C
D2B5 7D             	LD	A,L
D2B6 B7             	OR	A
D2B7 37             	SCF
D2B8 C8             	RET	Z
D2B9 3C             	INC	A
D2BA F5             	PUSH	AF
D2BB                
D2BB CD E4 DB       	CALL	KEYBC
D2BE 3E 06          	LD	A,6
D2C0 CD 1B DC       	CALL	MSG_A
D2C3 C1             	POP	BC
D2C4 21 00 01       	LD	HL,00100H
D2C7                BAT1:
D2C7 A7             	AND	A
D2C8 05             	DEC	B
D2C9 C8             	RET	Z
D2CA 7E             	LD	A,(HL)
D2CB FE 25          	CP	'%'
D2CD 28 0C          	JR	Z,BAT2
D2CF                BAT1X:
D2CF 7E             	LD	A,(HL)
D2D0 23             	INC	HL
D2D1 FE 1A          	CP	01AH
D2D3 C8             	RET	Z
D2D4 FE 0A          	CP	00AH
D2D6 C4 CA DB       	CALL	NZ,KEYBS
D2D9 18 EC          	JR	BAT1
D2DB                
D2DB                BAT2:
D2DB 23             	INC	HL
D2DC 7E             	LD	A,(HL)
D2DD 2B             	DEC	HL
D2DE D6 31          	SUB	'1'
D2E0 38 ED          	JR	C,BAT1X
D2E2 FE 09          	CP	9
D2E4 30 E9          	JR	NC,BAT1X
D2E6 23             	INC	HL
D2E7 23             	INC	HL
D2E8 3C             	INC	A
D2E9 4F             	LD	C,A
D2EA ED 5B 92 D2    	LD	DE,(COMPAT+1)
D2EE                BAT3:
D2EE 1A             	LD	A,(DE)
D2EF B7             	OR	A
D2F0 28 D5          	JR	Z,BAT1
D2F2 CD C9 E1       	CALL	SPCUT
D2F5 0D             	DEC	C
D2F6 28 08          	JR	Z,BAT5
D2F8                BAT4:
D2F8 1A             	LD	A,(DE)
D2F9 FE 21          	CP	021H
D2FB 38 F1          	JR	C,BAT3
D2FD 13             	INC	DE
D2FE 18 F8          	JR	BAT4
D300                BAT5:
D300 1A             	LD	A,(DE)
D301 FE 21          	CP	021H
D303 38 C2          	JR	C,BAT1
D305 13             	INC	DE
D306 CD CA DB       	CALL	KEYBS
D309 18 F5          	JR	BAT5
D30B                
D30B                SWITCH:
D30B 1A             	LD	A,(DE)
D30C                SW1:
D30C 13             	INC	DE
D30D B9             	CP	C
D30E 1A             	LD	A,(DE)
D30F C8             	RET	Z
D310 FE 20          	CP	020H
D312 30 F8          	JR	NC,SW1
D314                C_REM:
D314 AF             	XOR	A
D315 C9             	RET
D316                
D316                C_DEL:
D316 CD DC D4       	CALL	SETFCB
D319 CD 31 DC       	CALL	_SYS08		;(BDOS)エコーなしコンソール入力
D31C                
D31C 0E 13          	LD	C,013H
D31E 18 0A          	JR	CDEL1		;(BDOS)ファイルの削除
D320                
D320                C_REN:
D320 CD DC D4       	CALL	SETFCB
D323 3E 10          	LD	A,010H		;ディレクトリも対象にする
D325 32 69 00       	LD	(FCB1+13),A	;属性
D328 0E 17          	LD	C,017H		;(BDOS)ファイル名の変更
D32A                CDEL1:
D32A 11 5C 00       	LD	DE,FCB1
D32D CD 05 00       	CALL	SYSTEM
D330 C6 FF          	ADD	A,0FFH
D332 C9             	RET
D333                
D333                C_DIR:
D333 CD E7 E0       	CALL	FILEC
D336 21 15 EF       	LD	HL,FDRV+1
D339 CD 6D D6       	CALL	CWILD1
D33C 3E F1          	LD	A,0F1H
D33E 32 21 EF       	LD	(FDRV+13),A
D341 CD F4 D1       	CALL	OPEN1
D344                CDIR1:
D344 B7             	OR	A
D345 20 08          	JR	NZ,PDSKF
D347 CD 92 D3       	CALL	P_NAME
D34A CD 06 D2       	CALL	OPEN2
D34D 18 F5          	JR	CDIR1
D34F                
D34F                PDSKF:
D34F 3A 14 EF       	LD	A,(FDRV)
D352 5F             	LD	E,A
D353 0E 1B          	LD	C,01BH		;(BDOS)ディスク情報の獲得
D355 CD 05 00       	CALL	SYSTEM
D358 4F             	LD	C,A		;C←1クラスタ辺りの論理セクタ数
D359 C6 01          	ADD	A,001H
D35B D8             	RET	C		;Aが0FFHだった場合
D35C AF             	XOR	A
D35D                PDS1:				;HL=未使用クラスタの総数
D35D CB 19          	RR	C
D35F 38 04          	JR	C,PDS2
D361 29             	ADD	HL,HL
D362 8F             	ADC	A,A
D363 18 F8          	JR	PDS1
D365                PDS2:
D365 CB 50          	BIT	2,B		;B←論理セクタのサイズの上位8ビット
D367 20 0A          	JR	NZ,PDSKF1	;K単位(4)になるまで未使用を2で割る
D369 CB 3F          	SRL	A
D36B CB 1C          	RR	H
D36D CB 1D          	RR	L
D36F CB 10          	RL	B
D371 18 F2          	JR	PDS2
D373                PDSKF1:
D373 CD 08 D4       	CALL	PRDEC_AHL
D376 11 14 D7       	LD	DE,KBFREE
D379 CD 5A D8       	CALL	_SYS09		;(BDOS)文字列出力
D37C CD FA D3       	CALL	PUTDRV
D37F 3E 5C          	LD	A,05CH
D381 CD 1B DC       	CALL	MSG_A
D384 2A 22 EF       	LD	HL,(FDRV+14)	;ディレクトリのクラスタ番号
D387 AF             	XOR	A
D388 11 FE FF       	LD	DE,0-2
D38B 19             	ADD	HL,DE
D38C 23             	INC	HL
D38D DC 07 D4       	CALL	C,PRDEC_HL
D390 18 41          	JR	LTNL
D392                
D392                P_NAME:
D392 3A 79 D6       	LD	A,(DTA_CCP+1)
D395 FE 2E          	CP	'.'
D397 C8             	RET	Z
D398 11 2D D7       	LD	DE,DIRHD
D39B CD 5A D8       	CALL	_SYS09		;(BDOS)文字列出力
D39E 3A 84 D6       	LD	A,(DTA_CCP+1+00BH)
D3A1 F5             	PUSH	AF
D3A2 0F             	RRCA
D3A3 9F             	SBC	A,A
D3A4 E6 0A          	AND	'*'-020H
D3A6 C6 20          	ADD	A,020H
D3A8 CD 1B DC       	CALL	MSG_A
D3AB CD FA D3       	CALL	PUTDRV
D3AE 21 79 D6       	LD	HL,DTA_CCP+1
D3B1 CD 4B D4       	CALL	FPRNT
D3B4                
D3B4 F1             	POP	AF
D3B5 CB 67          	BIT	4,A
D3B7 28 08          	JR	Z,DIR3
D3B9 11 22 D7       	LD	DE,DIRMES
D3BC CD 5A D8       	CALL	_SYS09		;(BDOS)文字列出力
D3BF 18 0A          	JR	DIR6
D3C1                DIR3:
D3C1 ED 5B 97 D6    	LD	DE,(DTA_CCP+1+01EH)
D3C5 2A 95 D6       	LD	HL,(DTA_CCP+1+01CH)
D3C8 CD 0B D4       	CALL	PRDEC_DEHL
D3CB                DIR6:
D3CB 3A B1 EF       	LD	A,(CRTCD+1)
D3CE FE 29          	CP	40+1
D3D0 D4 6D D4       	CALL	NC,PRTTMS
D3D3                
D3D3                LTNL:
D3D3 1E 03          	LD	E,3
D3D5 C3 CD EF       	JP	_PRINT
D3D8                
D3D8                C_PATH:
D3D8 CD C9 E1       	CALL	SPCUT
D3DB 21 9D D6       	LD	HL,PATHD
D3DE FE 21          	CP	021H
D3E0 30 0C          	JR	NC,CPATH0
D3E2                CPATHP:
D3E2 7E             	LD	A,(HL)
D3E3 23             	INC	HL
D3E4 FE 20          	CP	020H
D3E6 3F             	CCF
D3E7 30 EA          	JR	NC,LTNL
D3E9 CD 1B DC       	CALL	MSG_A
D3EC 18 F4          	JR	CPATHP
D3EE                CPATH0:
D3EE FE 3B          	CP	';'
D3F0 20 01          	JR	NZ,CPATH1
D3F2 13             	INC	DE
D3F3                CPATH1:
D3F3 EB             	EX	DE,HL
D3F4 01 40 00       	LD	BC,PATHX
D3F7 ED B0          	LDIR
D3F9 C9             	RET
D3FA                
D3FA                PUTDRV:
D3FA 3A 14 EF       	LD	A,(FDRV)
D3FD C6 40          	ADD	A,'A'-1
D3FF CD 1B DC       	CALL	MSG_A
D402 3E 3A          	LD	A,':'
D404                MSG_AR:
D404 C3 1B DC       	JP	MSG_A
D407                
D407                PRDEC_HL:
D407 AF             	XOR	A
D408                PRDEC_AHL:
D408 5F             	LD	E,A
D409 16 00          	LD	D,0
D40B                PRDEC_DEHL:
D40B D5             	PUSH	DE
D40C 11 0F EF       	LD	DE,DECBF
D40F 06 05          	LD	B,5
D411 CD 11 D5       	CALL	ZERO_MEMORY_DE	;A=0
D414 D1             	POP	DE
D415                
D415 0E 20          	LD	C,32
D417                DEC1:
D417 29             	ADD	HL,HL
D418 EB             	EX	DE,HL
D419 ED 6A          	ADC	HL,HL
D41B EB             	EX	DE,HL
D41C E5             	PUSH	HL
D41D 21 13 EF       	LD	HL,DECBF+4
D420 06 05          	LD	B,5
D422                DEC2:
D422 7E             	LD	A,(HL)
D423 8F             	ADC	A,A
D424 27             	DAA
D425 77             	LD	(HL),A
D426 2B             	DEC	HL
D427 10 F9          	DJNZ	DEC2
D429 E1             	POP	HL
D42A 0D             	DEC	C
D42B 20 EA          	JR	NZ,DEC1
D42D                
D42D 21 0F EF       	LD	HL,DECBF
D430 3E 20          	LD	A,020H
D432 06 04          	LD	B,4
D434                DEC3:
D434 CD 41 D4       	CALL	DEC4
D437 CD 41 D4       	CALL	DEC4
D43A 23             	INC	HL
D43B 10 F7          	DJNZ	DEC3
D43D                DECX:
D43D CD 41 D4       	CALL	DEC4
D440 AF             	XOR	A
D441                DEC4:
D441 ED 6F          	RLD
D443 FE 20          	CP	020H
D445 28 02          	JR	Z,DEC5
D447 F6 30          	OR	030H
D449                DEC5:
D449 18 B9          	JR	MSG_AR
D44B                
D44B                FPRNT:
D44B 06 08          	LD	B,8
D44D CD 5E D4       	CALL	P_N1
D450 7E             	LD	A,(HL)
D451 C6 80          	ADD	A,0A0H-020H
D453 FE A0          	CP	0A0H
D455 28 02          	JR	Z,FPR1
D457 3E 2E          	LD	A,'.'
D459                FPR1:
D459 CD 1B DC       	CALL	MSG_A
D45C 06 03          	LD	B,3
D45E                
D45E                P_N1:
D45E C5             	PUSH	BC
D45F E5             	PUSH	HL
D460 7E             	LD	A,(HL)
D461 CD 0A E4       	CALL	CAP3
D464 CD 1B DC       	CALL	MSG_A
D467 E1             	POP	HL
D468 C1             	POP	BC
D469 23             	INC	HL
D46A 10 F2          	DJNZ	P_N1
D46C C9             	RET
D46D                
D46D                PRTTMS:
D46D 3E 20          	LD	A,020H
D46F CD 1B DC       	CALL	MSG_A
D472                
D472 2A 91 D6       	LD	HL,(DTA_CCP+1+24)
D475 7D             	LD	A,L
D476 B7             	OR	A
D477 C8             	RET	Z
D478 CB 3C          	SRL	H
D47A 17             	RLA
D47B 17             	RLA
D47C 17             	RLA
D47D 17             	RLA
D47E E6 0F          	AND	00FH
D480 57             	LD	D,A
D481 7C             	LD	A,H
D482 C6 50          	ADD	A,80
D484 CD C7 D4       	CALL	PRDEC_A
D487 3E 2D          	LD	A,'-'
D489 CD 1B DC       	CALL	MSG_A
D48C 7A             	LD	A,D
D48D CD C7 D4       	CALL	PRDEC_A
D490 3E 2D          	LD	A,'-'
D492 CD 1B DC       	CALL	MSG_A
D495 7D             	LD	A,L
D496 E6 1F          	AND	01FH
D498 CD C7 D4       	CALL	PRDEC_A
D49B                
D49B 2A 8F D6       	LD	HL,(DTA_CCP+1+22)
D49E                
D49E 3E 20          	LD	A,020H
D4A0 CD 1B DC       	CALL	MSG_A
D4A3 7C             	LD	A,H
D4A4 65             	LD	H,L
D4A5 06 03          	LD	B,3
D4A7                PRTTMS1:
D4A7 1F             	RRA
D4A8 CB 1D          	RR	L
D4AA 10 FB          	DJNZ	PRTTMS1
D4AC E6 1F          	AND	01FH
D4AE CD C7 D4       	CALL	PRDEC_A
D4B1 3E 3A          	LD	A,':'
D4B3 CD 1B DC       	CALL	MSG_A
D4B6 7D             	LD	A,L
D4B7 0F             	RRCA
D4B8 0F             	RRCA
D4B9 E6 3F          	AND	03FH
D4BB CD C7 D4       	CALL	PRDEC_A
D4BE 3E 3A          	LD	A,':'
D4C0 CD 1B DC       	CALL	MSG_A
D4C3 7C             	LD	A,H
D4C4 E6 1F          	AND	01FH
D4C6 87             	ADD	A,A
D4C7                
D4C7                ;	PRINT10
D4C7                
D4C7                PRDEC_A:
D4C7 E5             	PUSH	HL
D4C8 06 08          	LD	B,8
D4CA 4F             	LD	C,A
D4CB AF             	XOR	A
D4CC                PRTA1:
D4CC CB 01          	RLC	C
D4CE 8F             	ADC	A,A
D4CF 27             	DAA
D4D0 10 FA          	DJNZ	PRTA1
D4D2 21 0F EF       	LD	HL,DECBF
D4D5 77             	LD	(HL),A
D4D6 AF             	XOR	A
D4D7 CD 3D D4       	CALL	DECX
D4DA E1             	POP	HL
D4DB C9             	RET
D4DC                
D4DC                SETFCB:
D4DC CD C9 E1       	CALL	SPCUT
D4DF 1A             	LD	A,(DE)
D4E0 FE 20          	CP	020H
D4E2 38 01          	JR	C,SETFCBA
D4E4 1B             	DEC	DE
D4E5                SETFCBA:
D4E5 06 24          	LD	B,36
D4E7 21 5C 00       	LD	HL,FCB1
D4EA E5             	PUSH	HL
D4EB AF             	XOR	A
D4EC CD 9E E1       	CALL	FILL_MEMORY
D4EF E1             	POP	HL
D4F0 D5             	PUSH	DE
D4F1 CD BB DA       	CALL	_SYS29		;(BDOS)ファイル名の解析
D4F4 21 6C 00       	LD	HL,FCB2
D4F7 CD BB DA       	CALL	_SYS29		;(BDOS)ファイル名の解析
D4FA E1             	POP	HL
D4FB 01 00 50       	LD	BC,05000H
D4FE 11 81 00       	LD	DE,00081H
D501                SETFCB1:
D501 7E             	LD	A,(HL)
D502 23             	INC	HL
D503 FE 20          	CP	020H
D505 38 05          	JR	C,SETFCB2
D507 12             	LD	(DE),A
D508 13             	INC	DE
D509 0C             	INC	C
D50A 10 F5          	DJNZ	SETFCB1
D50C                SETFCB2:
D50C 79             	LD	A,C
D50D 32 80 00       	LD	(DTA1),A
D510 04             	INC	B
D511                ZERO_MEMORY_DE:
D511 AF             	XOR	A
D512                FILL_MEMORY_DE:
D512 12             	LD	(DE),A
D513 13             	INC	DE
D514 10 FC          	DJNZ	FILL_MEMORY_DE
D516 C9             	RET
D517                
D517                C_COPY:
D517 CD DC D4       	CALL	SETFCB
D51A 11 81 00       	LD	DE,DTA1+1
D51D 0E 2F          	LD	C,'/'
D51F CD 0B D3       	CALL	SWITCH
D522 CD FE E3       	CALL	CAP
D525 32 AD D5       	LD	(SW+1),A
D528                
D528 11 61 EF       	LD	DE,BEEPD
D52B CD EA E0       	CALL	FILEC2
D52E 21 6C 00       	LD	HL,FCB2
D531 CD C2 DA       	CALL	S29X1
D534                
D534 3E 10          	LD	A,010H
D536 32 69 00       	LD	(FCB1+13),A
D539 21 6D 00       	LD	HL,FCB2+1
D53C CD 6D D6       	CALL	CWILD1
D53F                COPY0:
D53F CD 6A D6       	CALL	CWILD
D542 21 5C 00       	LD	HL,FCB1
D545 CD F7 D1       	CALL	OPEN
D548 37             	SCF
D549                COPY1:
D549 C0             	RET	NZ
D54A CD 0A D2       	CALL	DEFCB
D54D                
D54D 3A 85 D6       	LD	A,(DTA_CCP+13)
D550 CB 67          	BIT	4,A
D552 28 24          	JR	Z,COPY1A
D554                
D554 21 5D 00       	LD	HL,FCB1+1
D557 CD 2F E5       	CALL	CHKWILD
D55A 38 17          	JR	C,COPY9
D55C                
D55C 3E 20          	LD	A,020H
D55E 32 5D 00       	LD	(FCB1+1),A
D561 2A 92 D6       	LD	HL,(DTA_CCP+26)
D564 23             	INC	HL
D565 22 6A 00       	LD	(FCB1+14),HL
D568 18 D5          	JR	COPY0
D56A                
D56A                COPYS:
D56A 11 74 EF       	LD	DE,SKIP
D56D                COPY8:
D56D CD 5A D8       	CALL	_SYS09		;(BDOS)文字列出力
D570 CD D3 D3       	CALL	LTNL
D573                COPY9:
D573 CD 06 D2       	CALL	OPEN2
D576 18 D1          	JR	COPY1
D578                
D578                COPY1A:
D578 21 6C 00       	LD	HL,FCB2
D57B 11 14 EF       	LD	DE,FDRV
D57E 01 7A D6       	LD	BC,DTA_CCP+2
D581 ED A0          	LDI
D583 3E 0B          	LD	A,11
D585                COPY2:
D585 F5             	PUSH	AF
D586 7E             	LD	A,(HL)
D587 FE 3F          	CP	'?'
D589 20 01          	JR	NZ,COPY3
D58B 0A             	LD	A,(BC)
D58C                COPY3:
D58C 12             	LD	(DE),A
D58D 03             	INC	BC
D58E 13             	INC	DE
D58F 23             	INC	HL
D590 F1             	POP	AF
D591 3D             	DEC	A
D592 20 F1          	JR	NZ,COPY2
D594 01 05 00       	LD	BC,16-11
D597 ED B0          	LDIR
D599                PUTNAME:
D599 21 5D 00       	LD	HL,FCB1+1
D59C CD 2F E5       	CALL	CHKWILD
D59F 30 0B          	JR	NC,PUTN1
D5A1 21 15 EF       	LD	HL,FDRV+1
D5A4 CD 4B D4       	CALL	FPRNT
D5A7 3E 20          	LD	A,020H
D5A9 CD 1B DC       	CALL	MSG_A
D5AC                PUTN1:
D5AC 3E 00          SW:	LD	A,000H
D5AE FE 54          	CP	'T'
D5B0 20 05          	JR	NZ,CSW1
D5B2 21 CC D5       	LD	HL,SWNE
D5B5 18 07          	JR	SWT1
D5B7                CSW1:
D5B7 FE 4E          	CP	'N'
D5B9 20 11          	JR	NZ,SWNE
D5BB 21 6A D5       	LD	HL,COPYS
D5BE                SWT1:
D5BE 11 14 EF       	LD	DE,FDRV
D5C1 CD 23 D2       	CALL	SYSC0F
D5C4 28 01          	JR	Z,SWN1
D5C6 E9             	JP	(HL)
D5C7                SWN1:
D5C7 CD 20 D6       	CALL	CTIME
D5CA 30 9E          	JR	NC,COPYS
D5CC                SWNE:
D5CC 11 14 EF       	LD	DE,FDRV
D5CF 0E 16          	LD	C,016H		;(BDOS)ファイルの作成
D5D1 CD 25 D2       	CALL	SYSTEM0
D5D4 20 48          	JR	NZ,COPYE2
D5D6 67             	LD	H,A		;A=0
D5D7 6F             	LD	L,A
D5D8 22 35 EF       	LD	(FDRV+33),HL	;(FCB)ランダムレコード
D5DB 22 37 EF       	LD	(FDRV+35),HL
D5DE                COPY6:
D5DE CD 2E D2       	CALL	S27BUF
D5E1 47             	LD	B,A
D5E2 3C             	INC	A
D5E3 28 31          	JR	Z,COPYE
D5E5 7C             	LD	A,H
D5E6 B5             	OR	L
D5E7 28 0C          	JR	Z,COPY7
D5E9 11 14 EF       	LD	DE,FDRV
D5EC 0E 26          	LD	C,026H		;(BDOS)ランダムブロック書き込み
D5EE CD 25 D2       	CALL	SYSTEM0
D5F1 20 23          	JR	NZ,COPYE
D5F3 10 E9          	DJNZ	COPY6
D5F5                COPY7:
D5F5 3A 85 D6       	LD	A,(DTA_CCP+13)	;(FCB)属性
D5F8 32 21 EF       	LD	(FDRV+13),A
D5FB 21 8C D6       	LD	HL,DTA_CCP+20	;(FCB)タイムスタンプ
D5FE 11 28 EF       	LD	DE,FDRV+20
D601 01 04 00       	LD	BC,4
D604 ED B0          	LDIR
D606                
D606 11 14 EF       	LD	DE,FDRV
D609 0E 10          	LD	C,010H		;(BDOS)ファイルのクローズ
D60B CD 25 D2       	CALL	SYSTEM0
D60E 20 06          	JR	NZ,COPYE
D610                
D610 11 71 EF       	LD	DE,OK
D613 C3 6D D5       	JP	COPY8
D616                
D616                COPYE:
D616 11 14 EF       	LD	DE,FDRV
D619 0E 13          	LD	C,013H		;(BDOS)ファイルの削除
D61B CD 05 00       	CALL	SYSTEM
D61E                COPYE2:
D61E 37             	SCF
D61F C9             	RET
D620                
D620                CTIME:
D620 ED 5B 8C D6    	LD	DE,(DTA_CCP+20)
D624 2A 28 EF       	LD	HL,(FDRV+20)
D627 A7             	AND	A
D628 ED 52          	SBC	HL,DE
D62A C0             	RET	NZ
D62B ED 5B 8E D6    	LD	DE,(DTA_CCP+22)
D62F 2A 2A EF       	LD	HL,(FDRV+22)
D632 ED 52          	SBC	HL,DE
D634 C9             	RET
D635                
D635                C_TYPE:
D635 CD DC D4       	CALL	SETFCB
D638 21 5C 00       	LD	HL,FCB1
D63B CD F7 D1       	CALL	OPEN
D63E 37             	SCF
D63F                TYPE1:
D63F C0             	RET	NZ
D640 CD 0A D2       	CALL	DEFCB
D643 3E 06          	LD	A,6
D645 CD 1B DC       	CALL	MSG_A
D648                TYPE2:
D648 CD 2E D2       	CALL	S27BUF
D64B C6 FE          	ADD	A,0FEH
D64D D8             	RET	C
D64E 7C             	LD	A,H
D64F B5             	OR	L
D650 28 13          	JR	Z,TYPEE
D652 01 00 01       	LD	BC,00100H
D655                TYPE3:
D655 0A             	LD	A,(BC)
D656 03             	INC	BC
D657 FE 1A          	CP	01AH
D659 28 0A          	JR	Z,TYPEE
D65B CD 1B DC       	CALL	MSG_A
D65E 2B             	DEC	HL
D65F 7C             	LD	A,H
D660 B5             	OR	L
D661 20 F2          	JR	NZ,TYPE3
D663 18 E3          	JR	TYPE2
D665                TYPEE:
D665 CD 06 D2       	CALL	OPEN2
D668 18 D5          	JR	TYPE1
D66A                
D66A                CWILD:
D66A 21 5D 00       	LD	HL,FCB1+1
D66D                CWILD1:
D66D 7E             	LD	A,(HL)
D66E FE 20          	CP	020H
D670 C0             	RET	NZ
D671                CWILD2:
D671 3E 3F          	LD	A,'?'
D673 06 0B          	LD	B,11
D675 C3 9E E1       	JP	FILL_MEMORY
D678                
D678                DTA_CCP:
D678                	DS	37
D69D                
D69D 00 00 00 40    PATHX	EQU	64
D69D                PATHD:	DS	PATHX
D6DD 00             PATHE:	DB	0
D6DE                
D6DE 00 00 00 09    COMS	EQU	9
D6DE                COMTB:
D6DE 44 20 20 20    	DB	"D   "	;1
D6E2 33 D3          	DW	C_DIR
D6E4 44 49 52 20    	DB	"DIR "	;2
D6E8 33 D3          	DW	C_DIR
D6EA 43 4F 50 59    	DB	"COPY"	;3
D6EE 17 D5          	DW	C_COPY
D6F0 43 44 20 20    	DB	"CD  "	;4
D6F4 2A D2          	DW	C_CD
D6F6 44 45 4C 20    	DB	"DEL "	;5
D6FA 16 D3          	DW	C_DEL
D6FC 50 41 54 48    	DB	"PATH"	;6
D700 D8 D3          	DW	C_PATH
D702 52 45 4E 20    	DB	"REN "	;7
D706 20 D3          	DW	C_REN
D708 54 59 50 45    	DB	"TYPE"	;8
D70C 35 D6          	DW	C_TYPE
D70E 52 45 4D 20    	DB	"REM "	;9
D712 14 D3          	DW	C_REM
D714                
D714 6B 20 62 79    KBFREE:	DB	"k bytes free",9,'$'
D718 74 65 73 20
D71C 66 72 65 65
D720 09 24
D722 20 20 20 20    DIRMES:	DB	"     <DIR>$"
D726 20 3C 44 49
D72A 52 3E 24
D72D 20 20 3A 24    DIRHD:	DB	"  :$"
D731                	INCLUDE	"LDDISK2.ASM"
D731                
D731                ;	LSX-Dodgers DISK2
D731                
D731                
D731                ;	GRAPHIC RAM DISK DRIVER
D731                
D731                
D731                GDRD:
D731 C5             	PUSH	BC
D732 CD 5A D7       	CALL	GADR
D735 F1             	POP	AF
D736                GDRD1:
D736 ED A2          	INI
D738 04             	INC	B
D739 0C             	INC	C
D73A 20 FA          	JR	NZ,GDRD1
D73C 04             	INC	B
D73D 13             	INC	DE
D73E 3D             	DEC	A
D73F 20 F5          	JR	NZ,GDRD1
D741                GBANK0:
D741 3A BF EF       	LD	A,(WK1FD0)
D744 E6 EF          	AND	0EFH		;BANK0
D746 18 1D          	JR	S1FD0
D748                
D748                GDWT:
D748 C5             	PUSH	BC
D749 CD 5A D7       	CALL	GADR
D74C F1             	POP	AF
D74D                GDWT1:
D74D 04             	INC	B
D74E ED A3          	OUTI
D750 0C             	INC	C
D751 20 FA          	JR	NZ,GDWT1
D753 04             	INC	B
D754 13             	INC	DE
D755 3D             	DEC	A
D756 20 F5          	JR	NZ,GDWT1
D758 18 E7          	JR	GBANK0
D75A                
D75A                GADR:
D75A 0E 00          	LD	C,0
D75C 7B             	LD	A,E
D75D C6 40          	ADD	A,040H
D75F 47             	LD	B,A
D760 3A BF EF       	LD	A,(WK1FD0)
D763 F6 10          	OR	010H		;BANK1
D765                S1FD0:
D765 C5             	PUSH	BC
D766 32 BF EF       	LD	(WK1FD0),A
D769 01 D0 1F       	LD	BC,01FD0H
D76C ED 79          	OUT	(C),A
D76E C1             	POP	BC
D76F C9             	RET
D770                
D770                
D770                ;	BANK RAM DISK DRIVER
D770                
D770                BDWT:
D770 3E             	DB	03EH	;LD A,??
D771 37             	SCF
D772 18 02          	JR	BRW
D774                
D774                BDRD:
D774 3E             	DB	03EH	;LD A,??
D775 A7             	AND	A
D776                BRW:
D776 F3             	DI
D777 32 9F D7       	LD	(BRWPAT),A
D77A ED 73 BF D7    	LD	(BANKSP+1),SP
D77E 3A C0 D7       	LD	A,(BANKSP+2)
D781 87             	ADD	A,A
D782 38 03          	JR	C,BRW0
D784 31 CA FF       	LD	SP,EXTSP
D787                BRW0:
D787 D9             	EXX		;裏レジスタ
D788 C5             	 PUSH	 BC
D789 D5             	 PUSH	 DE
D78A 01 00 0B       	 LD	 BC,00B00H	 ;バンクメモリ
D78D 11 10 10       	 LD	 DE,01010H
D790 D9             	 EXX		;表レジスタ
D791                BRW1:
D791 C5             	PUSH	BC
D792 D5             	PUSH	DE
D793 EB             	EX	DE,HL
D794 29             	ADD	HL,HL
D795 29             	ADD	HL,HL
D796 7C             	LD	A,H
D797 E6 0F          	AND	00FH	;バンク
D799 65             	LD	H,L
D79A CB 3C          	SRL	H	;/2
D79C 2E 00          	LD	L,0
D79E D9             	EXX		;裏レジスタ
D79F A7             BRWPAT:	 AND	 A	;自己書き換え(AND A:読み出し/SCF:書き込み)
D7A0 38 08          	 JR	 C,BRWT
D7A2 57             	 LD	 D,A	 ;D=バンク
D7A3 D9             	 EXX		;表レジスタ
D7A4 EB             	EX	DE,HL
D7A5 CD C3 D7       	CALL	BTFR
D7A8 18 06          	JR	BRW2
D7AA                BRWT:
D7AA 5F             	 LD	E,A	 ;E=バンク
D7AB D9             	 EXX		;表レジスタ
D7AC CD C3 D7       	CALL	BTFR
D7AF EB             	EX	DE,HL
D7B0                BRW2:
D7B0 D1             	POP	DE
D7B1 C1             	POP	BC
D7B2 13             	INC	DE
D7B3 10 DC          	DJNZ	BRW1
D7B5                
D7B5 D9             	EXX		;裏レジスタ
D7B6 3E 10          	 LD	 A,10H
D7B8 ED 79          	 OUT	 (C),A		;メインメモリに切り替える
D7BA D1             	 POP	 DE
D7BB C1             	 POP	 BC
D7BC D9             	 EXX		;表レジスタ
D7BD AF             	XOR	A
D7BE 31 00 00       BANKSP:	LD	SP,0
D7C1 FB             	EI
D7C2 C9             	RET
D7C3                
D7C3                ;メインメモリ←→バンクメモリ 512バイトの転送を行う
D7C3                ; DE:転送元アドレス
D7C3                ; HL:転送先アドレス
D7C3                ; 裏BC:バンク切り替えポート(0B00H)
D7C3                ; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
D7C3                ; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
D7C3                
D7C3                BTFR:
D7C3 06 00          	LD	B,0	;256回ループ(256*2)
D7C5                BTFR1:
D7C5 D9             	EXX		;裏レジスタ
D7C6 ED 51          	 OUT	 (C),D	 ;BANK(MAIN)
D7C8 D9             	 EXX		;表レジスタ
D7C9 1A             	LD	A,(DE)
D7CA 4F             	LD	C,A
D7CB 13             	INC	DE
D7CC 1A             	LD	A,(DE)
D7CD 13             	INC	DE
D7CE D9             	EXX		;裏レジスタ
D7CF ED 59          	 OUT	 (C),E	 ;MAIN(BANK)
D7D1 D9             	 EXX		;表レジスタ
D7D2 71             	LD	(HL),C
D7D3 23             	INC	HL
D7D4 77             	LD	(HL),A
D7D5 23             	INC	HL
D7D6 10 ED          	DJNZ	BTFR1
D7D8 C9             	RET
D7D9                
D7D9                ;	EMM DRIVER(DMA)
D7D9                
D7D9                
D7D9                EDWT:
D7D9 0E 0F          	LD	C,15
D7DB 18 02          	JR	EDWT1
D7DD                EDRD:
D7DD 0E 0E          	LD	C,14
D7DF                EDWT1:
D7DF C5             	PUSH	BC
D7E0 D5             	PUSH	DE
D7E1 22 22 D8       	LD	(DMAB),HL
D7E4 78             	LD	A,B
D7E5 87             	ADD	A,A
D7E6 3D             	DEC	A
D7E7 32 1B D8       	LD	(DMALEN+1),A
D7EA 3C             	INC	A
D7EB 84             	ADD	A,H	;HL(アドレス)を先に進めておく
D7EC 67             	LD	H,A
D7ED EB             	EX	DE,HL
D7EE 29             	ADD	HL,HL
D7EF 3A A1 EF       	LD	A,(_MAXCYL)
D7F2 47             	LD	B,A
D7F3 79             	LD	A,C
D7F4 0E 00          	LD	C,0
D7F6 09             	ADD	HL,BC
D7F7 ED 4B 84 EF    	LD	BC,(_DRIVE)
D7FB 06 0D          	LD	B,00DH
D7FD ED 49          	OUT	(C),C
D7FF 0C             	INC	C
D800 ED 69          	OUT	(C),L
D802 0C             	INC	C
D803 ED 61          	OUT	(C),H
D805                
D805 21 16 D8       	LD	HL,EDMAD
D808 CD EC DF       	CALL	SETDMA
D80B CD 14 E0       	CALL	GO_DMA
D80E EB             	EX	DE,HL
D80F D1             	POP	DE
D810 C1             	POP	BC
D811                DMA_ADD_SEC:
D811 13             	INC	DE
D812 10 FD          	DJNZ	DMA_ADD_SEC
D814 AF             	XOR	A
D815 C9             	RET
D816                
D816                EDMAD:
D816 C3             	DB	0C3H	;WR6 リセット
D817 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
D818 03 0D          	DW	00D03H	;ポートA開始アドレス EMMリード/ライト
D81A FF 01          DMALEN:	DW	001FFH	;ブロック長(転送サイズ-1)
D81C 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
D81D 50             	DB	050H	;WR2 ポートBアドレスインクリメント メモリ
D81E 02             	DB	002H	;ポートBタイミング
D81F 80             	DB	080H	;WR3
D820 9A             	DB	09AH	;WR5 WAIT RDY:HIGH
D821 AD             	DB	0ADH	;WR4 連続 ポートB開始アドレス
D822 00 00          DMAB:	DW	0
D824 01             	DB	001H	;WR0 ポートA←ポートB 転送
D825                EMME:
D825                
D825 00 00 07 50    AT_RE	EQU	EDWT-AT_EDWT
D825                
D825                	INCLUDE	"LDOS.ASM"
D825                
D825                ;	LSX-Dodgers OS
D825                
D825                BDOS0:
D825 E5             	PUSH	HL
D826 21 00 01       	LD	HL,00100H
D829 39             	ADD	HL,SP
D82A 38 10          	JR	C,BDOS1X
D82C                BDOS2:
D82C E1             	POP	HL
D82D ED 73 38 D8    	LD	(BDSP+1),SP
D831 31 CA FF       	LD	SP,EXTSP
D834 CD 3B D8       	CALL	BDOS1
D837 31 00 00       BDSP:	LD	SP,0
D83A C9             	RET
D83B                BDOS1:
D83B E5             	PUSH	HL
D83C                BDOS1X:
D83C 79             	LD	A,C
D83D FE 3C          	CP	03CH
D83F 30 0B          	JR	NC,OVERFN
D841 87             	ADD	A,A
D842 6F             	LD	L,A
D843 26 F0          	LD	H,STABLE/256
D845 7E             	LD	A,(HL)
D846 2C             	INC	L
D847 66             	LD	H,(HL)
D848 6F             	LD	L,A
D849 E3             	EX	(SP),HL
D84A 79             	LD	A,C
D84B C9             	RET
D84C                OVERFN
D84C E1             	POP	HL
D84D FE 6F          	CP	06FH		;DOSVER MSX-DOS のバージョン番号の獲得
D84F 20 07          	JR	NZ,_ERROR
D851 01 1D 01       	LD	BC,011DH
D854 11 45 01       	LD	DE,VER
D857 AF             	XOR	A
D858                _ERROR:
D858 A7             	AND	A
D859 C9             	RET
D85A                
D85A                _SYS09:		;文字列出力
D85A D5             	PUSH	DE
D85B                _SX09:
D85B 1A             	LD	A,(DE)
D85C 13             	INC	DE
D85D FE 24          	CP	'$'
D85F 28 31          	JR	Z,SX0E2
D861 CD 1B DC       	CALL	MSG_A
D864 18 F5          	JR	_SX09
D866                
D866                MSX1:
D866 CD 1B DC       	CALL	MSG_A
D869                MSX:
D869 7E             	LD	A,(HL)
D86A 23             	INC	HL
D86B B7             	OR	A
D86C 20 F8          	JR	NZ,MSX1
D86E C9             	RET
D86F                
D86F                _SYS0C:		;(BDOS)バージョン番号の獲得
D86F 21 22 00       	LD	HL,00022H
D872 7D             	LD	A,L
D873 C9             	RET
D874                
D874                _SYS0D:		;(BDOS)ディスクリセット
D874 CD DF EF       	CALL	_FFLUSH
D877 E5             	PUSH	HL
D878 21 80 00       	LD	HL,00080H
D87B 22 8A EF       	LD	(_DTA),HL
D87E E1             	POP	HL
D87F D5             	PUSH	DE
D880 1E 00          	LD	E,0
D882 3E             	DB	03EH
D883                
D883                _SYS0E:		;(BDOS)カレントドライブの設定
D883 D5             	PUSH	DE
D884 7B             	LD	A,E
D885 DD E5          	PUSH	IX
D887 CD DC EF       	CALL	_GETDPB
D88A DD E1          	POP	IX
D88C 38 04          	JR	C,SX0E2
D88E 7B             	LD	A,E
D88F 32 87 EF       	LD	(_DVSW),A
D892                SX0E2:
D892 3E 08          	LD	A,8
D894 D1             	POP	DE
D895 C9             	RET
D896                
D896                _SYS0F:		;(BDOS)ファイルのオープン
D896 CD DB E1       	CALL	SETDRV
D899 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D89C C6 02          	ADD	A,002H		;Write
D89E 28 48          	JR	Z,FEND0F
D8A0 CD 2B E5       	CALL	CHKWILDX
D8A3                
D8A3 D4 FB E1       	CALL	NC,SOPENX
D8A6                _S16XX:
D8A6 38 40          	JR	C,FEND0F
D8A8                				;Directory location
D8A8 3A 9F EF       	LD	A,(_FILEN)
D8AB FD 77 19       	LD	(IY+25),A	;(FCB)ディレクトリロケーション
D8AE                ;				_DIRF
D8AE 3A A0 EF       	LD	A,(_DIRF)
D8B1 FD 77 1D       	LD	(IY+29),A	;(FCB)ディレクトリモード
D8B4                ;				_FBPS
D8B4 FD 73 1E       	LD	(IY+30),E	;(FCB)ディレクトリポジション
D8B7 FD 72 1F       	LD	(IY+31),D
D8BA                ;				Open(Read)
D8BA FD 36 1C FF    	LD	(IY+28),0FFH	;(FCB)オープンモード
D8BE                ;				FILENAME
D8BE FD E5          	PUSH	IY
D8C0 D1             	POP	DE
D8C1 13             	INC	DE
D8C2 01 0B 00       	LD	BC,11
D8C5 ED B0          	LDIR
D8C7                ;				Attribute
D8C7 7E             	LD	A,(HL)
D8C8 FD 77 0D       	LD	(IY+13),A	;(FCB)属性(アトリビュート)
D8CB 11 0B 00       	LD	DE,11		;Reserved
D8CE 19             	ADD	HL,DE
D8CF                					;(FCB)ファイルを最後に変更した時刻
D8CF 11 EA F0       	LD	DE,SDDATA		;(FCB)ファイルを最後に変更した日付
D8D2 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
D8D4                S16LOOP:				;(FCB)ファイルのサイズ(バイト単位)
D8D4 1A             	LD	A,(DE)
D8D5 13             	INC	DE
D8D6 32 DD D8       	LD	(S16PAT+2),A
D8D9 7E             	LD	A,(HL)
D8DA 23             	INC	HL
D8DB FD 77 00       S16PAT:	LD	(IY+0),A
D8DE 10 F4          	DJNZ	S16LOOP
D8E0                
D8E0 AF             	XOR	A
D8E1 FD 77 0C       	LD	(IY+12),A	;(FCB)カレントブロック
D8E4 FD 22 8A D9    	LD	(OFCB+1),IY
D8E8                FEND0F:
D8E8 18 43          	JR	FEND10
D8EA                
D8EA                _SYS10:		;(BDOS)ファイルのクローズ
D8EA CD DB E1       	CALL	SETDRV
D8ED FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D8F0 D6 FE          	SUB	0FEH
D8F2 37             	SCF
D8F3 3F             	CCF
D8F4 20 37          	JR	NZ,FEND10
D8F6                _S10A:				;Write
D8F6 FD 77 0E       	LD	(IY+14),A	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D8F9 FD 77 0F       	LD	(IY+15),A
D8FC                
D8FC FD 34 1C       	INC	(IY+28)		;0FEH->0FFH ;オープンモード
D8FF CD 19 E6       	CALL	SETTMS
D902                
D902 FD 7E 1D       	LD	A,(IY+29)	;(FCB)ディレクトリモード
D905 32 A0 EF       	LD	(_DIRF),A
D908 E6 7F          	AND	07FH
D90A 32 88 EA       	LD	(_SECPS+1),A
D90D FD 5E 1E       	LD	E,(IY+30)	;(FCB)ディレクトリポジション
D910 FD 56 1F       	LD	D,(IY+31)
D913 CD 2F E3       	CALL	READ_DIR
D916 38 15          	JR	C,FEND10
D918                
D918 FD 7E 19       	LD	A,(IY+25)	;(FCB)ディレクトリロケーション
D91B E6 1F          SDECM1:	AND	01FH		;自己書き換え(1セクタ辺りのディレクトリエントリ数-1) 1024=01FH / 512=00FH / 256=7
D91D 6F             	LD	L,A
D91E 26 00          	LD	H,0
D920 29             	ADD	HL,HL		;*2
D921 29             	ADD	HL,HL		;*4
D922 29             	ADD	HL,HL		;*8
D923 29             	ADD	HL,HL		;*16
D924 29             	ADD	HL,HL		;*32
D925 ED 4B 7E F0    	LD	BC,(_DTBUF)
D929 09             	ADD	HL,BC
D92A                
D92A CD 3B E5       	CALL	SDIRENT
D92D                FEND10:
D92D 18 42          	JR	FEND
D92F                
D92F                _SYS11:		;(BDOS)最初のファイルの検索
D92F CD DB E1       	CALL	SETDRV
D932 CD 28 E2       	CALL	SOPEN
D935                _S12X1:
D935 38 3A          	JR	C,FEND
D937 CD C8 E2       	CALL	SOPENE2
D93A ED 5B 8A EF    	LD	DE,(_DTA)
D93E 3A 88 EF       	LD	A,(_DRV)
D941 3C             	INC	A
D942 12             	LD	(DE),A
D943 D5             	PUSH	DE
D944 13             	INC	DE
D945 01 20 00       	LD	BC,32
D948 ED B0          	LDIR
D94A FD 6E 0E       	LD	L,(IY+14)	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D94D FD 66 0F       	LD	H,(IY+15)
D950 22 F4 F0       	LD	(SCDIR),HL
D953 2A 9A EF       	LD	HL,(_FBPS)
D956 22 F6 F0       	LD	(SFBPS),HL
D959 2A 9F EF       	LD	HL,(_FILEN)
D95C 7C             	LD	A,H
D95D B7             	OR	A
D95E 28 06          	JR	Z,_S12DIR
D960 3A 88 EA       	LD	A,(_SECPS+1)
D963 F6 80          	OR	080H
D965 67             	LD	H,A
D966                _S12DIR
D966 22 F8 F0       	LD	(SFNDF),HL	;Directory position and Flags
D969 E1             	POP	HL
D96A 11 39 EF       	LD	DE,SFILE
D96D 0E 21          	LD	C,33
D96F                _S11B:
D96F ED B0          	LDIR
D971                FEND:
D971 9F             	SBC	A,A		;CF=0 A=0 : CF=1 A=0FFH
D972                FENDE:
D972 FD E1          	POP	IY
D974 C1             	POP	BC
D975 D1             	POP	DE
D976 E1             	POP	HL
D977 C9             	RET
D978                
D978                _SYS12:		;(BDOS)次のファイルの検索
D978 E5             	PUSH	HL
D979 D5             	PUSH	DE
D97A C5             	PUSH	BC
D97B FD E5          	PUSH	IY
D97D CD 8C E2       	CALL	NOPEN
D980 18 B3          	JR	_S12X1
D982                
D982                _S16K:
D982 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D985 FE FD          	CP	0FDH		;Device(0FDH)
D987 37             	SCF
D988 C8             	RET	Z
D989                
D989 11 00 00       OFCB:	LD	DE,0
D98C D5             	PUSH	DE
D98D 06 1A          	LD	B,26		;First cluster
D98F                S16K1:
D98F 13             	INC	DE
D990 23             	INC	HL
D991 10 FC          	DJNZ	S16K1
D993                
D993 1A             	LD	A,(DE)
D994 BE             	CP	(HL)
D995 20 13          	JR	NZ,S16K2
D997 13             	INC	DE
D998 23             	INC	HL
D999 1A             	LD	A,(DE)
D99A BE             	CP	(HL)
D99B 20 0D          	JR	NZ,S16K2
D99D                
D99D E1             	POP	HL
D99E FD E5          	PUSH	IY
D9A0 D1             	POP	DE
D9A1 1A             	LD	A,(DE)		;Drive
D9A2 BE             	CP	(HL)
D9A3 20 06          	JR	NZ,S16K3
D9A5                				;ここはCFが必ず0
D9A5 ED 52          	SBC	HL,DE		;CP HL,DE
D9A7 37             	SCF
D9A8 C0             	RET	NZ
D9A9 E5             	PUSH	HL
D9AA                S16K2:
D9AA E1             	POP	HL
D9AB                S16K3:
D9AB FD E5          	PUSH	IY
D9AD D1             	POP	DE
D9AE                _SYS13:		;(BDOS)ファイルの削除
D9AE CD DB E1       	CALL	SETDRV
D9B1 CD 59 E4       	CALL	KILL
D9B4                FEND13:
D9B4 18 BB          	JR	FEND
D9B6                
D9B6                _SYS14:		;(BDOS)シーケンシャルな読み出し
D9B6 CD DB E1       	CALL	SETDRV
D9B9 CD 4B E6       	CALL	PUSHRR
D9BC CD 8C E6       	CALL	GETSEQ
D9BF                
D9BF CD A0 E6       	CALL	RB_READ
D9C2 E5             	PUSH	HL
D9C3 CD 5F E6       	CALL	SETSEQ
D9C6                SREAD:
D9C6 E1             	POP	HL
D9C7                
D9C7 C6 01          	ADD	A,001H
D9C9 38 A6          	JR	C,FEND
D9CB                
D9CB 7D             	LD	A,L
D9CC D6 01          	SUB	001H
D9CE                FENDX:
D9CE 9F             	SBC	A,A
D9CF E6 03          	AND	3
D9D1 1F             	RRA
D9D2 18 9E          	JR	FENDE
D9D4                
D9D4                _SYS15:		;(BDOS)シーケンシャルな書き込み
D9D4 CD DB E1       	CALL	SETDRV
D9D7 CD 4B E6       	CALL	PUSHRR
D9DA CD 8C E6       	CALL	GETSEQ
D9DD                
D9DD CD 99 E6       	CALL	RB_WRITE
D9E0 E5             	PUSH	HL
D9E1 CD 5F E6       	CALL	SETSEQ
D9E4                SWRITE:
D9E4 E1             	POP	HL
D9E5                
D9E5 C6 FF          	ADD	A,0FFH
D9E7 18 E5          	JR	FENDX
D9E9                
D9E9                _SYS17:		;(BDOS)ファイル名の変更
D9E9 CD DB E1       	CALL	SETDRV
D9EC CD B1 E4       	CALL	NAME
D9EF 18 C3          	JR	FEND13
D9F1                
D9F1                _SYS16:		;(BDOS)ファイルの作成
D9F1 CD DB E1       	CALL	SETDRV
D9F4                
D9F4 CD 2B E5       	CALL	CHKWILDX
D9F7 38 BB          	JR	C,FEND13
D9F9 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
D9FC FE 05          	CP	5
D9FE 28 05          	JR	Z,_S16X2
DA00 FE 21          	CP	021H
DA02 DA B4 D9       	JP	C,FEND13
DA05                _S16X2:
DA05                ;				Clear FCB
DA05 FD E5          	PUSH	IY
DA07 E1             	POP	HL
DA08 01 10 00       	LD	BC,16
DA0B 09             	ADD	HL,BC
DA0C                _S16X1:
DA0C 70             	LD	(HL),B		;B=0
DA0D 23             	INC	HL
DA0E 0D             	DEC	C
DA0F 20 FB          	JR	NZ,_S16X1
DA11                
DA11 CD 1E E6       	CALL	SETTMSX
DA14 FD 36 0D FF    	LD	(IY+13),0FFH	;(FCB)Attribute
DA18 CD FB E1       	CALL	SOPENX
DA1B 3F             	CCF
DA1C CC 82 D9       	CALL	Z,_S16K
DA1F D4 D9 E2       	CALL	NC,COPEN
DA22 D4 3B E5       	CALL	NC,SDIRENT
DA25 C3 A6 D8       	JP	_S16XX
DA28                
DA28                _SYS21:		;(BDOS)ランダムな読み出し
DA28                
DA28 CD DB E1       	CALL	SETDRV
DA2B CD 4B E6       	CALL	PUSHRR
DA2E FD 6E 21       	LD	L,(IY+33)	;(FCB)Random record
DA31 FD 66 22       	LD	H,(IY+34)
DA34                
DA34 CD A0 E6       	CALL	RB_READ
DA37 E5             	PUSH	HL
DA38 CD 76 E6       	CALL	POPRR
DA3B 18 89          	JR	SREAD
DA3D                
DA3D                _SYS22:		;(BDOS)ランダムな書き込み
DA3D                _SYS28:		;(BDOS)ランダムな書き込み・その2
DA3D CD DB E1       	CALL	SETDRV
DA40 CD 4B E6       	CALL	PUSHRR
DA43 FD 6E 21       	LD	L,(IY+33)	;(FCB)Random record
DA46 FD 66 22       	LD	H,(IY+34)
DA49                
DA49 CD 99 E6       	CALL	RB_WRITE
DA4C E5             	PUSH	HL
DA4D CD 76 E6       	CALL	POPRR
DA50 18 92          	JR	SWRITE
DA52                
DA52                _SYS18:		;(BDOS)ログインベクトルの獲得
DA52 21 FF 00       	LD	HL,000FFH
DA55 AF             	XOR	A
DA56 C9             	RET
DA57                
DA57                _SYS19:		;(BDOS)カレントドライブ番号の獲得
DA57 3A 87 EF       	LD	A,(_DVSW)
DA5A A7             	AND	A
DA5B C9             	RET
DA5C                
DA5C                _SYS1A:		;(BDOS)DTAの設定
DA5C ED 53 8A EF    	LD	(_DTA),DE
DA60 AF             	XOR	A
DA61 C9             	RET
DA62                
DA62                _SYS1B:		;(BDOS)ディスク情報の獲得
DA62 7B             	LD	A,E
DA63 CD EE E1       	CALL	GETDRV
DA66 CD DC EF       	CALL	_GETDPB
DA69 D4 E2 EF       	CALL	NC,_RDFATX
DA6C 21 00 00       	LD	HL,0
DA6F D4 F7 E5       	CALL	NC,DSKF
DA72                
DA72 ED 5B F8 E5    	LD	DE,(MAXCLP+1)	;DPB_08_MAXCL-1
DA76 1B             	DEC	DE		;DE←クラスタの総数
DA77 FD 2A 7C F0    	LD	IY,(_FATBF)	;IY←メモリ上のFATの先頭アドレス
DA7B 9F             	SBC	A,A
DA7C D8             	RET	C
DA7D 4F             	LD	C,A		;C=0
DA7E DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS
DA81 E6 0F          	AND	00FH
DA83 47             	LD	B,A
DA84 DD 7E 07       	LD	A,(IX+7)	;DPB_07_SECPCL
DA87 C9             	RET
DA88                
DA88                _SYS1D:		;(BDOS)書き込みが禁止されているディスクの調査
DA88 AF             	XOR	A
DA89 67             	LD	H,A
DA8A 6F             	LD	L,A
DA8B C9             	RET
DA8C                
DA8C                _SYS1F:		;(BDOS)ディスク装置のパラメータの読み出し
DA8C 21 00 F1       	LD	HL,DEVICE
DA8F 7B             	LD	A,E
DA90 C3 DC EF       	JP	_GETDPB
DA93                
DA93                _SYS23:		;(BDOS)ファイルサイズの獲得
DA93 E5             	PUSH	HL
DA94 2A 1E F0       	LD	HL,(STABLE+2*00FH)	;ファイルのオープン
DA97 CD 0F 00       	CALL	JP_HL
DA9A 38 14          	JR	C,_S23X1
DA9C                
DA9C D5             	PUSH	DE		;EX DE,IY
DA9D FD E3          	EX	(SP),IY		;
DA9F                ;	POP	DE		;
DA9F                ;	PUSH	DE		;DEを破壊しないように注意vv
DA9F CD 7C E6       	CALL	GETSIZE
DAA2                _S24X1:
DAA2 FD 75 21       	LD	(IY+33),L	;(FCB)Random record
DAA5 FD 74 22       	LD	(IY+34),H
DAA8 FD 36 23 00    	LD	(IY+35),0
DAAC                ;	POP	DE		;^^^^^^^^^^^^^^^^^^^^^^^^
DAAC                ;	PUSH	DE		;EX DE,IY
DAAC FD E3          	EX	(SP),IY		;
DAAE D1             	POP	DE		;
DAAF                
DAAF AF             	XOR	A
DAB0                _S23X1:
DAB0 E1             	POP	HL
DAB1 C9             	RET
DAB2                
DAB2                _SYS24:		;(BDOS)ランダムレコードフィールドの設定
DAB2 E5             	PUSH	HL
DAB3 D5             	PUSH	DE		;EX DE,IY
DAB4 FD E3          	EX	(SP),IY		;
DAB6                ;	POP	DE		;
DAB6                ;	PUSH	DE		;DEを破壊しないように注意vv
DAB6 CD 8C E6       	CALL	GETSEQ
DAB9 18 E7          	JR	_S24X1		;^^^^^^^^^^^^^^^^^^^^^^^^
DABB                
DABB                _SYS29:		;(BDOS)ファイル名の解析
DABB C5             	PUSH	BC
DABC E5             	PUSH	HL
DABD CD F2 E0       	CALL	FILE
DAC0 E1             	POP	HL
DAC1 C1             	POP	BC
DAC2                S29X1:
DAC2 C5             	PUSH	BC
DAC3 D5             	PUSH	DE
DAC4 E5             	PUSH	HL
DAC5 EB             	EX	DE,HL
DAC6 21 14 EF       	LD	HL,FDRV
DAC9 01 0D 00       	LD	BC,13
DACC ED B0          	LDIR
DACE 70             	LD	(HL),B		;B=0
DACF 0E 03          	LD	C,3
DAD1 ED B0          	LDIR
DAD3 E1             	POP	HL
DAD4 D1             	POP	DE
DAD5 C1             	POP	BC
DAD6 AF             	XOR	A
DAD7 C9             	RET
DAD8                
DAD8                _SYS30:		;(BDOS)論理セクタを用いた書き込み
DAD8 C5             	PUSH	BC
DAD9 01 F8 EB       	LD	BC,DWT24B
DADC 18 04          	JR	S2FX
DADE                _SYS2F:
DADE C5             	PUSH	BC
DADF 01 E8 EB       	LD	BC,DRD24B
DAE2                S2FX:
DAE2 ED 43 F8 DA    	LD	(S2FPAT+1),BC
DAE6 CD DF EF       	CALL	_FFLUSH
DAE9                
DAE9 D5             	PUSH	DE
DAEA E5             	PUSH	HL
DAEB 7D             	LD	A,L		;Drive
DAEC CD D9 EF       	CALL	_CHGDRV
DAEF 38 09          	JR	C,S30X2
DAF1 44             	LD	B,H		;Number of clusters
DAF2 2A 8A EF       	LD	HL,(_DTA)
DAF5                
DAF5 0E 00          	LD	C,0
DAF7 CD E8 EB       S2FPAT:	CALL	DRD24B
DAFA                S30X2:
DAFA E1             	POP	HL
DAFB D1             	POP	DE
DAFC C1             	POP	BC
DAFD 9F             	SBC	A,A
DAFE C9             	RET
DAFF                
DAFF                _SYS3B:		;(BDOS)カレントディレクトリの変更
DAFF C5             	PUSH	BC
DB00 D5             	PUSH	DE
DB01 E5             	PUSH	HL
DB02 CD E7 E0       	CALL	FILEC
DB05 21 00 00       	LD	HL,0
DB08 11 14 EF       	LD	DE,FDRV
DB0B 2A 4E F0       	LD	HL,(STABLE+2*027H)	;ランダムブロック読み込み
DB0E CD 0F 00       	CALL	JP_HL
DB11 18 E7          	JR	S30X2
DB13                	INCLUDE	"LDIO.ASM"
DB13                
DB13                ;	LSX-Dodgers IO
DB13                
DB13 00 00 D8 58    _SYS04	EQU	_ERROR		;(BDOS)外部出力
DB13 00 00 D8 58    _SYS05	EQU	_ERROR		;(BDOS)プリンタ出力
DB13 00 00 D8 58    _SYS1C	EQU	_ERROR		;(BDOS)ディスクの書き込み禁止化
DB13 00 00 D8 58    _SYS1E	EQU	_ERROR		;(BDOS)ファイル属性の設定
DB13 00 00 D8 58    _SYS20	EQU	_ERROR		;(BDOS)利用者番号の設定と読み出し
DB13 00 00 D8 58    _SYS2E	EQU	_ERROR		;(BDOS)ベリファイ・フラグの設定
DB13                
DB13                BIOS:
DB13 E5             	PUSH	HL
DB14 21 10 80       	LD	HL,08010H
DB17 39             	ADD	HL,SP
DB18 E1             	POP	HL
DB19 30 0E          	JR	NC,BIOS2
DB1B                BIOS1:
DB1B CD 23 DB       	CALL	BIOS3
DB1E 06 1E          	LD	B,01EH
DB20 ED 79          	OUT	(C),A
DB22 C9             	RET
DB23                BIOS3:
DB23 C5             	PUSH	BC
DB24 06 1D          	LD	B,01DH
DB26 ED 79          	OUT	(C),A
DB28 C9             	RET
DB29                BIOS2:
DB29 ED 73 34 DB    	LD	(SPPAT+1),SP	;スタックがBIOS-ROMと被っている場合
DB2D 31 CA FF       	LD	SP,EXTSP
DB30 CD 1B DB       	CALL	BIOS1
DB33 31 00 00       SPPAT:	LD	SP,0
DB36 C9             	RET
DB37                
DB37                INT:
DB37 F5             	PUSH	AF
DB38 E5             	PUSH	HL
DB39 ED 73 4A DB    	LD	(INTSP+1),SP
DB3D 21 00 01       	LD	HL,00100H
DB40 39             	ADD	HL,SP
DB41 38 03          	JR	C,INTP1X
DB43 31 CA FF       	LD	SP,EXTSP
DB46                INTP1X:
DB46 CD 51 DB       	CALL	INTP1
DB49 31 00 00       INTSP:	LD	SP,0
DB4C                INTPE:
DB4C E1             	POP	HL
DB4D                INTPE2:
DB4D F1             	POP	AF
DB4E                INTCTCE:
DB4E FB             	EI
DB4F ED 4D          	RETI
DB51                INTP1:
DB51 C5             	PUSH	BC
DB52                
DB52 CD 1B DF       	CALL	IN49SB
DB55 67             	LD	H,A
DB56 CD 1B DF       	CALL	IN49SB
DB59 6F             	LD	L,A
DB5A                
DB5A FE 08          	CP	8		;DELキー
DB5C 20 05          	JR	NZ,SCEXE
DB5E 7C             	LD	A,H
DB5F E6 11          	AND	011H		;CTRLキー + GRAPHキー
DB61 28 08          	JR	Z,RESET
DB63                SCEXE:
DB63 22 92 EF       	LD	(_KEYD),HL
DB66 CD 97 DB       	CALL	KEYSET1
DB69                
DB69 C1             	POP	BC
DB6A C9             	RET
DB6B                
DB6B                RESET:
DB6B 3E 1D          	LD	A,01DH
DB6D D3 00          	OUT	(0),A
DB6F C7             	RST	0
DB70                
DB70                INTCTC2:
DB70 F5             	PUSH	AF
DB71 3E 00          INTCPAT:LD	A,000H
DB73 3D             	DEC	A
DB74 32 72 DB       	LD	(INTCPAT+1),A
DB77 20 D4          	JR	NZ,INTPE2
DB79                
DB79 3A 92 EF       	LD	A,(_KEYD)
DB7C B7             	OR	A
DB7D 28 CE          	JR	Z,INTPE2
DB7F                KEYSET0:
DB7F E5             	PUSH	HL
DB80 2A 90 EF       	LD	HL,(_KEYPS)
DB83 7C             	LD	A,H
DB84 AD             	XOR	L
DB85 20 06          	JR	NZ,INTC2A
DB87                
DB87 2A 92 EF       	LD	HL,(_KEYD)
DB8A CD C1 DB       	CALL	KEYSET
DB8D                INTC2A:
DB8D 3A 94 EF       	LD	A,(_KEYSP)
DB90 E6 0F          	AND	00FH
DB92 32 72 DB       	LD	(INTCPAT+1),A
DB95                
DB95 18 B5          	JR	INTPE
DB97                
DB97                KEYSET1:
DB97 CB 6C          	BIT	5,H
DB99 F5             	PUSH	AF
DB9A ED 4B 8C EF    	LD	BC,(_CTC)
DB9E 78             	LD	A,B
DB9F B1             	OR	C
DBA0 20 06          	JR	NZ,KEYS10E
DBA2                
DBA2 F1             	POP	AF
DBA3 20 1C          	JR	NZ,KEYSET
DBA5 F5             	PUSH	AF
DBA6 18 D7          	JR	KEYSET0
DBA8                KEYS10E:
DBA8 F1             	POP	AF
DBA9 C8             	RET	Z
DBAA F5             	PUSH	AF
DBAB 3E 03          	LD	A,3		;CTC STOP
DBAD ED 79          	OUT	(C),A
DBAF F1             	POP	AF
DBB0                
DBB0 B7             	OR	A
DBB1 C8             	RET	Z
DBB2                
DBB2 E5             	PUSH	HL
DBB3 2A 94 EF       	LD	HL,(_KEYSP)
DBB6 3E A7          	LD	A,0A7H
DBB8 ED 79          	OUT	(C),A
DBBA ED 69          	OUT	(C),L
DBBC 7C             	LD	A,H
DBBD 32 72 DB       	LD	(INTCPAT+1),A
DBC0 E1             	POP	HL
DBC1                
DBC1                KEYSET:
DBC1 7D             	LD	A,L
DBC2 CB 7C          	BIT	7,H
DBC4 CC F1 DB       	CALL	Z,FKEY
DBC7 CB 74          	BIT	6,H
DBC9 C0             	RET	NZ
DBCA                KEYBS:
DBCA B7             	OR	A
DBCB C8             	RET	Z
DBCC                KEYBS1:
DBCC FE 03          	CP	3
DBCE CC E4 DB       	CALL	Z,KEYBC
DBD1 E5             	PUSH	HL
DBD2 F5             	PUSH	AF
DBD3 2A 90 EF       	LD	HL,(_KEYPS)
DBD6 2C             	INC	L
DBD7 7D             	LD	A,L
DBD8 BC             	CP	H
DBD9 28 12          	JR	Z,POP_AF_HL_SCF_RET
DBDB 32 90 EF       	LD	(_KEYPS),A
DBDE 26 FE          	LD	H,KEYBF/256
DBE0 F1             	POP	AF
DBE1 77             	LD	(HL),A
DBE2 E1             	POP	HL
DBE3 C9             	RET
DBE4                
DBE4                KEYBC:
DBE4 E5             	PUSH	HL
DBE5 21 00 00       	LD	HL,0
DBE8 22 90 EF       	LD	(_KEYPS),HL
DBEB E1             	POP	HL
DBEC C9             	RET
DBED                
DBED                POP_AF_HL_SCF_RET:
DBED F1             	POP	AF
DBEE E1             	POP	HL
DBEF 37             	SCF
DBF0 C9             	RET
DBF1                
DBF1                FKEY:
DBF1 CB 75          	BIT	6,L
DBF3 C8             	RET	Z
DBF4 3E 1B          	LD	A,01BH
DBF6 CD CC DB       	CALL	KEYBS1
DBF9 7D             	LD	A,L
DBFA C6 AF          	ADD	A,020H-'q'
DBFC CB 7D          	BIT	7,L
DBFE C8             	RET	Z
DBFF 2E 50          	LD	L,'P'
DC01 D6 90          	SUB	0E1H+020H-'q'
DC03 28 10          	JR	Z,KEYBSL
DC05 2C             	INC	L
DC06 3D             	DEC	A
DC07 28 0C          	JR	Z,KEYBSL
DC09 2C             	INC	L
DC0A D6 09          	SUB	0EBH-0E2H
DC0C 28 07          	JR	Z,KEYBSL
DC0E 2E 43          	LD	L,'C'
DC10 3D             	DEC	A
DC11 28 02          	JR	Z,KEYBSL
DC13 2E 58          	LD	L,'X'
DC15                KEYBSL:
DC15 7D             	LD	A,L
DC16 18 B4          	JR	KEYBS1
DC18                
DC18                _SYS01:		;(BDOS)コンソール入力
DC18 CD 09 EF       	CALL	_SYS07
DC1B                MSG_A:
DC1B F5             	PUSH	AF
DC1C D5             	PUSH	DE
DC1D 5F             	LD	E,A
DC1E CD 24 DC       	CALL	_SYS02
DC21 D1             	POP	DE
DC22 F1             	POP	AF
DC23 C9             	RET
DC24                
DC24                _SYS02:		;(BDOS)コンソール出力
DC24 CD 36 DC       	CALL	BREAK
DC27 18 05          	JR	PRINTX
DC29                
DC29                _SYS06:		;(BDOS)コンソール直接入出力
DC29 7B             	LD	A,E
DC2A 3C             	INC	A
DC2B CA CA EF       	JP	Z,_INKEY
DC2E                PRINTX:
DC2E C3 CD EF       	JP	_PRINT
DC31                
DC31                _SYS08:		;(BDOS)エコーなしコンソール入力
DC31 CD 09 EF       	CALL	_SYS07
DC34 18 04          	JR	BREAK1
DC36                BREAK:
DC36 FB             	EI
DC37 3A 92 EF       	LD	A,(_KEYD)
DC3A                BREAK1:
DC3A FE 03          	CP	3
DC3C CA 00 00       	JP	Z,0
DC3F FE 13          	CP	013H
DC41 C0             	RET	NZ
DC42                
DC42                PAUSE:
DC42 CD E4 DB       	CALL	KEYBC
DC45                
DC45                FLGET:
DC45 CD DF EF       	CALL	_FFLUSH
DC48 C5             	PUSH	BC
DC49 E5             	PUSH	HL
DC4A ED 4B 8E EF    	LD	BC,(_TXADR)
DC4E CB E8          	SET	5,B
DC50 ED 60          	IN	H,(C)
DC52                FLGET1:
DC52 3A 93 EF       	LD	A,(_KEYD+1)
DC55 0F             	RRCA
DC56 0F             	RRCA
DC57 E6 10          	AND	010H
DC59 F6 08          	OR	8
DC5B ED 68          	IN	L,(C)
DC5D B5             	OR	L
DC5E ED 79          	OUT	(C),A
DC60 CD CA EF       	CALL	_INKEY
DC63 28 ED          	JR	Z,FLGET1
DC65 ED 61          	OUT	(C),H
DC67 E1             	POP	HL
DC68 C1             	POP	BC
DC69 C9             	RET
DC6A                
DC6A                _SYS0A:		;(BDOS)文字列入力
DC6A C5             	PUSH	BC
DC6B E5             	PUSH	HL
DC6C D5             	PUSH	DE
DC6D CD 78 E0       	CALL	GETL
DC70 11 00 FF       	LD	DE,KBUF
DC73 E1             	POP	HL
DC74 E5             	PUSH	HL
DC75 0E 00          	LD	C,0
DC77 30 04          	JR	NC,SAX0
DC79 23             	INC	HL
DC7A 23             	INC	HL
DC7B 18 08          	JR	SAX4
DC7D                SAX0:
DC7D 46             	LD	B,(HL)
DC7E 23             	INC	HL
DC7F                SAX1:
DC7F 23             	INC	HL
DC80 1A             	LD	A,(DE)
DC81 13             	INC	DE
DC82 B7             	OR	A
DC83 20 04          	JR	NZ,SAX2
DC85                SAX4:
DC85 36 0D          	LD	(HL),00DH
DC87 18 04          	JR	SAX3
DC89                SAX2:
DC89 77             	LD	(HL),A
DC8A 0C             	INC	C
DC8B 10 F2          	DJNZ	SAX1
DC8D                SAX3:
DC8D D1             	POP	DE
DC8E 79             	LD	A,C
DC8F 13             	INC	DE
DC90 12             	LD	(DE),A
DC91 1B             	DEC	DE
DC92 E1             	POP	HL
DC93 C1             	POP	BC
DC94 A7             	AND	A
DC95 C9             	RET
DC96                
DC96                _SYS0B:		;(BDOS)コンソール状態のチェック
DC96 CD 36 DC       	CALL	BREAK
DC99 3A 92 EF       	LD	A,(_KEYD)
DC9C B7             	OR	A
DC9D C8             	RET	Z
DC9E                CONSTX:
DC9E CD DF EF       	CALL	_FFLUSH
DCA1 E5             	PUSH	HL
DCA2 2A 90 EF       	LD	HL,(_KEYPS)
DCA5 7C             	LD	A,H
DCA6 AD             	XOR	L
DCA7 E1             	POP	HL
DCA8 C6 FF          	ADD	A,0FFH
DCAA 9F             	SBC	A,A
DCAB C9             	RET
DCAC                
DCAC                _SYS2A:		;(BDOS)日付の獲得
DCAC C5             	PUSH	BC
DCAD 3E ED          	LD	A,0EDH		;Read calendar
DCAF CD 36 DF       	CALL	COMOUT
DCB2 CD CF DC       	CALL	IN49SB_BCD	;YY
DCB5 6F             	LD	L,A
DCB6 26 00          	LD	H,0
DCB8                ;	LD	DE,1900		;0076CH
DCB8                ;	CP	90		;90以上は1900年代 1990-1999
DCB8                ;	JR	NC,RDDATE1	;90未満は2000年代 2000-2089
DCB8                ;	LD	E,0D0H		;2000 & 0FFH D=007H
DCB8 11 D0 07       	LD	DE,2000		;すべて2000年代で処理 2000-2099
DCBB                RDDATE1:
DCBB 19             	ADD	HL,DE
DCBC CD 1B DF       	CALL	IN49SB		;MM
DCBF 57             	LD	D,A
DCC0 CD CF DC       	CALL	IN49SB_BCD	;DD
DCC3 5F             	LD	E,A
DCC4 7A             	LD	A,D
DCC5 E6 07          	AND	7
DCC7 06 04          	LD	B,4
DCC9                RDDATE2:
DCC9 CB 3A          	SRL	D
DCCB 10 FC          	DJNZ	RDDATE2
DCCD C1             	POP	BC
DCCE C9             	RET
DCCF                IN49SB_BCD:
DCCF CD 1B DF       	CALL	IN49SB
DCD2                ;------------------------
DCD2                ;BCDの10進数化
DCD2                ;in
DCD2                ;	A  : BCD
DCD2                ;out
DCD2                ;	A  : 10進数
DCD2                ;------------------------
DCD2 4F             	LD	C,A
DCD3 E6 F0          	AND	0F0H	;10の位
DCD5 0F             	RRCA
DCD6 47             	LD	B,A
DCD7 0F             	RRCA
DCD8 0F             	RRCA
DCD9 80             	ADD	A,B
DCDA 47             	LD	B,A
DCDB 79             	LD	A,C
DCDC E6 0F          	AND	00FH	;1の位
DCDE 80             	ADD	A,B
DCDF C9             	RET
DCE0                
DCE0                _SYS2C:		;(BDOS)時刻の獲得
DCE0 C5             	PUSH	BC
DCE1 3E EF          	LD	A,0EFH		;Read time
DCE3 CD 36 DF       	CALL	COMOUT
DCE6 CD CF DC       	CALL	IN49SB_BCD	;TT
DCE9 67             	LD	H,A
DCEA CD CF DC       	CALL	IN49SB_BCD	;MM
DCED 6F             	LD	L,A
DCEE CD CF DC       	CALL	IN49SB_BCD	;SS
DCF1 57             	LD	D,A
DCF2 C1             	POP	BC
DCF3 AF             	XOR	A
DCF4 C9             	RET
DCF5                
DCF5                ESC1:
DCF5 7B             	LD	A,E
DCF6 FE 41          	CP	'A'
DCF8 CA 39 DE       	JP	Z,CTRL1E
DCFB FE 42          	CP	'B'
DCFD CA A1 DF       	JP	Z,CTRL1F
DD00 FE 43          	CP	'C'
DD02 CA 44 DE       	JP	Z,CTRL1C
DD05 FE 44          	CP	'D'
DD07 CA 30 DE       	JP	Z,CTRL1D
DD0A FE 45          	CP	'E'
DD0C 28 02          	JR	Z,CT0CX
DD0E FE 6A          	CP	'j'
DD10                CT0CX:
DD10 CA 74 DF       	JP	Z,CTRL0C
DD13 FE 48          	CP	'H'
DD15 CA BC DE       	JP	Z,CTRL0B
DD18 FE 4A          	CP	'J'
DD1A CA 77 DF       	JP	Z,CTRL06
DD1D FE 4B          	CP	'K'
DD1F CA 7D DE       	JP	Z,CTRL05
DD22 FE 4C          	CP	'L'
DD24 CA B6 DF       	JP	Z,CTRL0E
DD27 FE 54          	CP	'T'
DD29 CA 7D DE       	JP	Z,CTRL05
DD2C FE 78          	CP	'x'
DD2E 28 04          	JR	Z,ESC1X
DD30 FE 79          	CP	'y'
DD32 20 02          	JR	NZ,ESC1Y
DD34                ESC1X:
DD34 36 01          	LD	(HL),1
DD36                ESC1Y:
DD36 FE 3D          	CP	'='
DD38 28 04          	JR	Z,ESC1W
DD3A FE 59          	CP	'Y'
DD3C 20 02          	JR	NZ,ESC1Z
DD3E                ESC1W:
DD3E 36 02          	LD	(HL),2
DD40                ESC1Z:
DD40 FE 20          	CP	020H
DD42 38 02          	JR	C,ESC1C
DD44 87             	ADD	A,A
DD45 D0             	RET	NC
DD46                ESC1C:
DD46 E1             	POP	HL
DD47 18 49          	JR	ANK
DD49                
DD49                ESC:
DD49 21 A3 DD       	LD	HL,PRINTE5
DD4C E5             	PUSH	HL
DD4D 21 6F DD       	LD	HL,ESCFLG+1
DD50 36 00          	LD	(HL),0
DD52 3D             	DEC	A
DD53 28 A0          	JR	Z,ESC1
DD55 3D             	DEC	A
DD56 20 09          	JR	NZ,ESC2
DD58 36 03          	LD	(HL),3
DD5A 7B             	LD	A,E
DD5B D6 20          	SUB	020H
DD5D 32 64 DD       	LD	(ESCYP+1),A
DD60 C9             	RET
DD61                ESC2:
DD61 3D             	DEC	A
DD62 C0             	RET	NZ
DD63 26 00          ESCYP:	LD	H,0
DD65 7B             	LD	A,E
DD66 D6 20          	SUB	020H
DD68 6F             	LD	L,A
DD69 C3 D6 EF       	JP	_LOC
DD6C                
DD6C                PRINT:
DD6C C5             	PUSH	BC
DD6D E5             	PUSH	HL
DD6E 3E 00          ESCFLG:	LD	A,000H
DD70 B7             	OR	A
DD71 20 D6          	JR	NZ,ESC
DD73                
DD73 3E 1F          	LD	A,01FH
DD75 BB             	CP	E
DD76 30 2F          	JR	NC,CTRL
DD78 01 3F DF       INSFLG:	LD	BC,INSERT
DD7B                
DD7B 3E 00          KANFLG:	LD	A,000H
DD7D B7             	OR	A
DD7E 20 3A          	JR	NZ,KANJI2
DD80 7B             X1KPAT:	LD	A,E
DD81 FE 80          	CP	080H
DD83 38 0D          	JR	C,ANK
DD85 FE A0          	CP	0A0H
DD87 38 04          	JR	C,KANJI1
DD89 FE E0          	CP	0E0H
DD8B 38 05          	JR	C,ANK
DD8D                KANJI1:
DD8D 32 7C DD       	LD	(KANFLG+1),A
DD90 18 11          	JR	PRINTE5
DD92                ANK:
DD92 ED 4B 8E EF    	LD	BC,(_TXADR)
DD96 78             	LD	A,B
DD97 F6 38          	OR	038H
DD99 47             	LD	B,A
DD9A ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DD9C CB 98          	RES	3,B
DD9E ED 59          	OUT	(C),E		;Text
DDA0                KANJIE:
DDA0 CD 05 DE       	CALL	PRINTE7
DDA3                PRINTE5:
DDA3 E1             	POP	HL
DDA4 C1             	POP	BC
DDA5 AF             	XOR	A
DDA6 C9             	RET
DDA7                
DDA7                CTRL:
DDA7 CD EC DD       	CALL	KANCLR
DDAA 7B             	LD	A,E
DDAB 87             	ADD	A,A
DDAC F6 80          	OR	080H
DDAE 6F             	LD	L,A
DDAF 26 F0          	LD	H,CTRLTB/256
DDB1 7E             	LD	A,(HL)
DDB2 2C             	INC	L
DDB3 66             	LD	H,(HL)
DDB4 6F             	LD	L,A
DDB5 CD 0F 00       	CALL	JP_HL
DDB8 18 E9          	JR	PRINTE5
DDBA                
DDBA                KANJI2:
DDBA D5             	PUSH	DE
DDBB 57             	LD	D,A
DDBC 01 81 2F       	LD	BC,02F81H	;SFTJIS
DDBF DF             	RST	018H
DDC0 01 C3 2F       	LD	BC,02FC3H	;Instead or JISVRM
DDC3 DF             	RST	018H
DDC4                
DDC4 ED 4B 8E EF    	LD	BC,(_TXADR)
DDC8 78             	LD	A,B
DDC9 F6 38          	OR	038H
DDCB 47             	LD	B,A
DDCC ED 51          	OUT	(C),D		;kanji
DDCE CB 98          	RES	3,B
DDD0 ED 59          	OUT	(C),E		;Text
DDD2 CD 05 DE       	CALL	PRINTE7
DDD5 ED 4B 8E EF    	LD	BC,(_TXADR)
DDD9 78             	LD	A,B
DDDA F6 38          	OR	038H
DDDC 47             	LD	B,A
DDDD CB F2          	SET	6,D
DDDF ED 51          	OUT	(C),D		;Kanji
DDE1 CB 98          	RES	3,B
DDE3 ED 59          	OUT	(C),E		;Text
DDE5 D1             	POP	DE
DDE6 AF             	XOR	A
DDE7 32 7C DD       	LD	(KANFLG+1),A
DDEA 18 B4          	JR	KANJIE
DDEC                
DDEC                KANCLR:
DDEC 3A 7C DD       	LD	A,(KANFLG+1)
DDEF B7             	OR	A
DDF0 C8             	RET	Z
DDF1 ED 4B 8E EF    	LD	BC,(_TXADR)
DDF5 78             	LD	A,B
DDF6 F6 38          	OR	038H
DDF8 47             	LD	B,A
DDF9 AF             	XOR	A
DDFA 32 7C DD       	LD	(KANFLG+1),A
DDFD ED 79          	OUT	(C),A		;Kanji
DDFF CB 98          	RES	3,B
DE01 3E 20          	LD	A,020H
DE03 ED 79          	OUT	(C),A		;Text
DE05                PRINTE7:
DE05 CB A0          	RES	4,B
DE07                PRINTE6:
DE07 3A 96 EF       	LD	A,(_COLORF)
DE0A                PRINTE4:
DE0A ED 79          	OUT	(C),A		;Color
DE0C 78             	LD	A,B
DE0D E6 07          	AND	7
DE0F 47             	LD	B,A
DE10                PRINTE2:
DE10 03             	INC	BC
DE11                PRINTE3:
DE11 2A BA EF       	LD	HL,(CRTCD+10)
DE14 A7             	AND	A
DE15 ED 4A          	ADC	HL,BC
DE17                PRINTE8:
DE17 28 05          	JR	Z,PRINT2
DE19 ED 43 8E EF    	LD	(_TXADR),BC
DE1D                CTRL00:
DE1D C9             	RET
DE1E                
DE1E                PRINT2:
DE1E CD BC DF       	CALL	SCR
DE21 2A BC EF       	LD	HL,(CRTCD+12)
DE24 09             	ADD	HL,BC
DE25                SET_TXADR_HL:
DE25 22 8E EF       	LD	(_TXADR),HL
DE28 C9             	RET
DE29                
DE29                CTRL08:
DE29 3A 78 DD       	LD	A,(INSFLG)
DE2C FE CD          	CP	0CDH		;CALL ????
DE2E 28 29          	JR	Z,CTRL02
DE30                CTRL1D:
DE30 2A 8E EF       	LD	HL,(_TXADR)
DE33 7C             	LD	A,H
DE34 B5             	OR	L
DE35 C8             	RET	Z
DE36 2B             	DEC	HL
DE37 18 EC          	JR	SET_TXADR_HL
DE39                
DE39                CTRL1E:
DE39 ED 4B 8E EF    	LD	BC,(_TXADR)
DE3D 2A BC EF       	LD	HL,(CRTCD+12)
DE40 09             	ADD	HL,BC
DE41 D0             	RET	NC
DE42 18 E1          	JR	SET_TXADR_HL
DE44                
DE44                CTRL1C:
DE44 ED 4B 8E EF    	LD	BC,(_TXADR)
DE48 18 C6          	JR	PRINTE2
DE4A                
DE4A                CTRL09:
DE4A ED 4B 8E EF    	LD	BC,(_TXADR)
DE4E 79             	LD	A,C
DE4F E6 F8          	AND	0F8H
DE51 C6 08          	ADD	A,8
DE53 4F             	LD	C,A
DE54 88             	ADC	A,B
DE55 91             	SUB	C
DE56 47             	LD	B,A
DE57 18 B8          	JR	PRINTE3
DE59                
DE59                CTRL02:
DE59 CD 30 DE       	CALL	CTRL1D
DE5C C8             	RET	Z
DE5D D5             	PUSH	DE
DE5E CD D3 EF       	CALL	_POS
DE61 3A B1 EF       	LD	A,(CRTCD+1)
DE64 95             	SUB	L
DE65 4F             	LD	C,A
DE66 0D             	DEC	C
DE67 06 38          	LD	B,038H
DE69 2A 8E EF       	LD	HL,(_TXADR)
DE6C 09             	ADD	HL,BC
DE6D 44             	LD	B,H
DE6E 4D             	LD	C,L
DE6F 11 00 20       	LD	DE,02000H	;D:Text E:kanji
DE72 2A 96 EF       	LD	HL,(_COLORF)	;L:Color
DE75                C8X1:
DE75 CD 5B DF       	CALL	C12S
DE78 0B             	DEC	BC
DE79 20 FA          	JR	NZ,C8X1
DE7B D1             	POP	DE
DE7C C9             	RET
DE7D                
DE7D                CTRL05:
DE7D CD D3 EF       	CALL	_POS
DE80 3A B1 EF       	LD	A,(CRTCD+1)
DE83 95             	SUB	L
DE84 6F             	LD	L,A
DE85                C08X1:
DE85 26 20          	LD	H,020H
DE87 ED 4B 8E EF    	LD	BC,(_TXADR)
DE8B                C05X1:
DE8B 78             	LD	A,B
DE8C F6 38          	OR	038H
DE8E 47             	LD	B,A
DE8F ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DE91 CB 98          	RES	3,B
DE93 ED 61          	OUT	(C),H		;Text
DE95 CB A0          	RES	4,B
DE97 3A 96 EF       	LD	A,(_COLORF)
DE9A ED 79          	OUT	(C),A		;Color
DE9C 03             	INC	BC
DE9D 2D             	DEC	L
DE9E 20 EB          	JR	NZ,C05X1
DEA0 C9             	RET
DEA1                
DEA1                CTRL0D:
DEA1 CD D3 EF       	CALL	_POS
DEA4 2E 00          	LD	L,0
DEA6                LOC:
DEA6 C5             	PUSH	BC
DEA7 E5             	PUSH	HL
DEA8 CD EC DD       	CALL	KANCLR
DEAB CD C9 DE       	CALL	LOC1
DEAE 22 8E EF       	LD	(_TXADR),HL
DEB1 E1             	POP	HL
DEB2 C1             	POP	BC
DEB3 C9             	RET
DEB4                
DEB4                CTRL12:
DEB4 21 78 DD       	LD	HL,INSFLG
DEB7 7E             	LD	A,(HL)
DEB8 EE CC          	XOR	0CCH		;CD:CALL ???? 1:LD BC,????
DEBA 77             	LD	(HL),A
DEBB C9             	RET
DEBC                
DEBC                CTRL0B:
DEBC 21 00 00       	LD	HL,0
DEBF 22 8E EF       	LD	(_TXADR),HL
DEC2 C9             	RET
DEC3                
DEC3                CTRL1B:
DEC3 3E 01          	LD	A,1
DEC5 32 6F DD       	LD	(ESCFLG+1),A
DEC8 C9             	RET
DEC9                
DEC9                LOC1:
DEC9 D5             	PUSH	DE
DECA 4D             	LD	C,L
DECB 06 08          	LD	B,8
DECD 5C             	LD	E,H
DECE 16 00          	LD	D,0
DED0 2A B0 EF       	LD	HL,(CRTCD)
DED3 6A             	LD	L,D
DED4                LOC2:
DED4 29             	ADD	HL,HL
DED5 30 01          	JR	NC,LOC3
DED7 19             	ADD	HL,DE
DED8                LOC3:
DED8 10 FA          	DJNZ	LOC2
DEDA 09             	ADD	HL,BC
DEDB D1             	POP	DE
DEDC C9             	RET
DEDD                
DEDD                CONOUT1:
DEDD CD EF DE       	CALL	CURSOR
DEE0 59             	LD	E,C
DEE1 CD CD EF       	CALL	_PRINT
DEE4 7B             	LD	A,E
DEE5 FE 0A          	CP	00AH
DEE7 20 06          	JR	NZ,CURSOR
DEE9 CD A1 DE       	CALL	CTRL0D
DEEC CD 7D DE       	CALL	CTRL05
DEEF                CURSOR:
DEEF C5             	PUSH	BC
DEF0 ED 4B 8E EF    	LD	BC,(_TXADR)
DEF4 CB E8          	SET	5,B
DEF6 ED 78          	IN	A,(C)
DEF8 EE 18          	XOR	018H
DEFA ED 79          	OUT	(C),A
DEFC C1             	POP	BC
DEFD C9             	RET
DEFE                
DEFE                CTRL07:
DEFE 21 61 EF       	LD	HL,BEEPD
DF01                BEEP1:
DF01 7E             	LD	A,(HL)
DF02 23             	INC	HL
DF03 FE FF          	CP	0FFH
DF05 C8             	RET	Z
DF06 F3             	DI
DF07 06 1C          	LD	B,01CH
DF09 ED 79          	OUT	(C),A
DF0B ED A3          	OUTI
DF0D FB             	EI
DF0E 18 F1          	JR	BEEP1
DF10                
DF10                OT49SB:
DF10 C5             	PUSH	BC
DF11 CD 2C DF       	CALL	CANW
DF14 01 00 19       	LD	BC,01900H
DF17 ED 79          	OUT	(C),A
DF19 C1             	POP	BC
DF1A C9             	RET
DF1B                
DF1B                IN49SB:
DF1B C5             	PUSH	BC
DF1C 01 01 1A       	LD	BC,01A01H
DF1F                CANR:
DF1F ED 78          	IN	A,(C)
DF21 E6 20          	AND	020H
DF23 20 FA          	JR	NZ,CANR
DF25 01 00 19       	LD	BC,01900H
DF28 ED 78          	IN	A,(C)
DF2A C1             	POP	BC
DF2B C9             	RET
DF2C                
DF2C                CANW:
DF2C 01 01 1A       	LD	BC,01A01H
DF2F ED 48          	IN	C,(C)
DF31 CB 71          	BIT	6,C
DF33 20 F7          	JR	NZ,CANW
DF35 C9             	RET
DF36                
DF36                COMOUT:
DF36 FB             	EI
DF37 CD 10 DF       	CALL	OT49SB
DF3A CD 2C DF       	CALL	CANW
DF3D F3             	DI
DF3E C9             	RET
DF3F                
DF3F                INSERT:
DF3F D5             	PUSH	DE
DF40 CD D3 EF       	CALL	_POS
DF43 3A B1 EF       	LD	A,(CRTCD+1)
DF46 95             	SUB	L
DF47 ED 4B 8E EF    	LD	BC,(_TXADR)
DF4B 11 00 20       	LD	DE,02000H	;D:Text E:Kanji
DF4E 2A 96 EF       	LD	HL,(_COLORF)	;L:Color
DF51 CB E8          	SET	5,B
DF53                C12X1:
DF53 CD 5B DF       	CALL	C12S
DF56 03             	INC	BC
DF57 20 FA          	JR	NZ,C12X1
DF59 D1             	POP	DE
DF5A C9             	RET
DF5B                
DF5B                C12S:
DF5B CB E0          	SET	4,B
DF5D CB D8          	SET	3,B
DF5F ED 60          	IN	H,(C)
DF61 ED 59          X1PAT:	OUT	(C),E
DF63 5C             	LD	E,H
DF64 CB 98          	RES	3,B
DF66 ED 60          	IN	H,(C)
DF68 ED 51          	OUT	(C),D
DF6A 54             	LD	D,H
DF6B CB A0          	RES	4,B
DF6D ED 60          	IN	H,(C)
DF6F ED 69          	OUT	(C),L
DF71 6C             	LD	L,H
DF72 3D             	DEC	A
DF73 C9             	RET
DF74                
DF74                CTRL0C:
DF74 CD BC DE       	CALL	CTRL0B
DF77                CTRL06:
DF77 ED 4B 8E EF    	LD	BC,(_TXADR)
DF7B                C1AX1:
DF7B 78             	LD	A,B
DF7C F6 38          	OR	038H
DF7E 47             	LD	B,A
DF7F ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DF81 CB 98          	RES	3,B
DF83 3E 20          	LD	A,020H
DF85 ED 79          	OUT	(C),A		;Text
DF87 CB A0          	RES	4,B
DF89 3A 96 EF       	LD	A,(_COLORF)
DF8C ED 79          	OUT	(C),A		;Color
DF8E 03             	INC	BC
DF8F CB A8          	RES	5,B
DF91 2A BA EF       	LD	HL,(CRTCD+10)
DF94 09             	ADD	HL,BC
DF95 30 E4          	JR	NC,C1AX1
DF97 C9             	RET
DF98                
DF98                CTRL04:
DF98 CD D3 EF       	CALL	_POS
DF9B 7D             	LD	A,L
DF9C B7             	OR	A
DF9D C8             	RET	Z
DF9E                CTRL03:
DF9E CD A1 DE       	CALL	CTRL0D
DFA1                CTRL0A:
DFA1                CTRL1F:
DFA1 ED 4B 8E EF    	LD	BC,(_TXADR)
DFA5 2A B1 EF       	LD	HL,(CRTCD+1)
DFA8 26 00          	LD	H,0
DFAA 09             	ADD	HL,BC
DFAB 44             	LD	B,H
DFAC 4D             	LD	C,L
DFAD 2A BA EF       	LD	HL,(CRTCD+10)
DFB0 09             	ADD	HL,BC
DFB1 3F             	CCF
DFB2 9F             	SBC	A,A
DFB3 C3 17 DE       	JP	PRINTE8
DFB6                
DFB6                CTRL0E:
DFB6 CD D3 EF       	CALL	_POS
DFB9 7C             	LD	A,H
DFBA 18 04          	JR	SCR1
DFBC                SCR:
DFBC 3A 97 EF       	LD	A,(_LINE)
DFBF 3D             	DEC	A
DFC0                SCR1:
DFC0 C5             	PUSH	BC
DFC1 D5             	PUSH	DE
DFC2 F5             	PUSH	AF
DFC3 3E 07          	LD	A,7
DFC5 21 F6 DF       	LD	HL,SCRDMAD
DFC8 CD EC DF       	CALL	SETDMA
DFCB F1             	POP	AF
DFCC 21 00 38       	LD	HL,03800H
DFCF                
DFCF                SCRUP1:
DFCF B7             	OR	A
DFD0 28 4D          	JR	Z,SCRCL
DFD2 F5             	PUSH	AF
DFD3 CD FD DF       	CALL	UPSUB		;kanji
DFD6 3A BC EF       	LD	A,(CRTCD+12)
DFD9 5F             	LD	E,A
DFDA 16 F7          	LD	D,0F7H
DFDC 19             	ADD	HL,DE
DFDD D5             	PUSH	DE
DFDE CD FD DF       	CALL	UPSUB		;Text
DFE1 D1             	POP	DE
DFE2 19             	ADD	HL,DE
DFE3 CD FD DF       	CALL	UPSUB		;Color
DFE6 CB E4          	SET	4,H
DFE8 F1             	POP	AF
DFE9 3D             	DEC	A
DFEA 18 E3          	JR	SCRUP1
DFEC                
DFEC                SETDMA:
DFEC 01 87 1F       	LD	BC,01F87H
DFEF                SDMA:
DFEF 04             	INC	B
DFF0 ED A3          	OUTI
DFF2 3D             	DEC	A
DFF3 20 FA          	JR	NZ,SDMA
DFF5 C9             	RET
DFF6                
DFF6                SCRDMAD:
DFF6 C3             	DB	0C3H		;WR6 リセット
DFF7 9A             	DB	09AH		;WR5 ストップ WAIT READY:HIGH
DFF8 65             	DB	065H		;WR0 ブロック長(LH)
DFF9 4F 00          	DW	79
DFFB 1C             	DB	01CH		;WR1 ポートAインクリメント I/O
DFFC 18             	DB	018H		;WR0 ポートAアドレス(LH)
DFFD                
DFFD                UPSUB:
DFFD 3A B1 EF       	LD	A,(CRTCD+1)
E000 5F             	LD	E,A
E001 16 00          	LD	D,0
E003 3E CD          	LD	A,0CDH		;WR4 バースト ポートB開始アドレス(LH)
E005 ED 79          	OUT	(C),A
E007 ED 69          	OUT	(C),L		;SOURCE
E009 ED 61          	OUT	(C),H
E00B 19             	ADD	HL,DE
E00C 3E 1D          	LD	A,01DH		;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
E00E ED 79          	OUT	(C),A
E010 ED 69          	OUT	(C),L		;DEST
E012 ED 61          	OUT	(C),H
E014                GO_DMA:
E014 3E CF          	LD	A,0CFH
E016 ED 79          	OUT	(C),A		;WR6 ロード
E018 3E B3          	LD	A,0B3H
E01A ED 79          	OUT	(C),A		;WR6 強制RDY
E01C ED 49          	OUT	(C),C		;WR6 イネーブル
E01E C9             	RET
E01F                
E01F                SCRCL:
E01F 44             	LD	B,H
E020 4D             	LD	C,L
E021 21 50 20       	LD	HL,02000H+80
E024 3A 96 EF       	LD	A,(_COLORF)
E027                SCRCL1:
E027 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
E029 CB 98          	RES	3,B
E02B ED 61          	OUT	(C),H
E02D CB A0          	RES	4,B
E02F ED 79          	OUT	(C),A
E031 CB D8          	SET	3,B
E033 CB E0          	SET	4,B
E035 03             	INC	BC
E036 2D             	DEC	L
E037 20 EE          	JR	NZ,SCRCL1
E039 D1             	POP	DE
E03A C1             	POP	BC
E03B C9             	RET
E03C                
E03C                SCRN:
E03C D5             	PUSH	DE
E03D ED 58          	IN	E,(C)		;Text
E03F CB D8          	SET	3,B
E041 ED 50          	IN	D,(C)		;Kanji
E043 28 19          	JR	Z,SCRNE
E045 AF             	XOR	A
E046 C5             	PUSH	BC
E047 01 37 30       	LD	BC,03037H	;VRMJIS
E04A DF             	RST	018H
E04B 01 52 2F       	LD	BC,02F52H	;JISSFT
E04E DF             	RST	018H
E04F C1             	POP	BC
E050 ED 78          	IN	A,(C)
E052 CB 98          	RES	3,B
E054 E6 40          	AND	040H
E056 20 03          	JR	NZ,SCRN1
E058 7A             	LD	A,D
E059 D1             	POP	DE
E05A C9             	RET
E05B                SCRN1:
E05B 7B             	LD	A,E
E05C D1             	POP	DE
E05D C9             	RET
E05E                
E05E                SCRNE:
E05E D1             	POP	DE
E05F CB 98          	RES	3,B
E061                SCRNX:
E061 ED 78          	IN	A,(C)
E063 C9             	RET
E064                
E064                POS:
E064 2A 8E EF       	LD	HL,(_TXADR)
E067 C5             	PUSH	BC
E068 ED 4B BC EF    	LD	BC,(CRTCD+12)
E06C AF             	XOR	A
E06D                POS1:
E06D 09             	ADD	HL,BC
E06E 3C             	INC	A
E06F 38 FC          	JR	C,POS1
E071 ED 42          	SBC	HL,BC
E073 3D             	DEC	A
E074 67             	LD	H,A
E075 C1             	POP	BC
E076 A7             	AND	A
E077 C9             	RET
E078                
E078                GETL:
E078 CD D3 EF       	CALL	_POS
E07B E5             	PUSH	HL
E07C 3E CD          	LD	A,0CDH		;CALL ????
E07E 32 78 DD       	LD	(INSFLG),A
E081                GETL1:
E081 CD 31 DC       	CALL	_SYS08
E084 FE 09          	CP	9
E086 20 08          	JR	NZ,GETL1V
E088 21 00 FF       	LD	HL,KBUF
E08B CD 69 D8       	CALL	MSX
E08E 18 F1          	JR	GETL1
E090                GETL1V:
E090 5F             	LD	E,A
E091 CD CD EF       	CALL	_PRINT
E094                
E094 7B             	LD	A,E
E095 FE 0D          	CP	00DH
E097 20 E8          	JR	NZ,GETL1
E099 3E 01          	LD	A,1		;LD BC,????
E09B 32 78 DD       	LD	(INSFLG),A
E09E 11 00 FF       	LD	DE,KBUF
E0A1 3A B1 EF       	LD	A,(CRTCD+1)
E0A4 47             	LD	B,A
E0A5 CD 11 D5       	CALL	ZERO_MEMORY_DE
E0A8                
E0A8 D1             	POP	DE
E0A9 CD D3 EF       	CALL	_POS
E0AC 6B             	LD	L,E
E0AD 3A B1 EF       	LD	A,(CRTCD+1)
E0B0 95             	SUB	L
E0B1 57             	LD	D,A
E0B2 CD C9 DE       	CALL	LOC1
E0B5 4D             	LD	C,L
E0B6 7C             	LD	A,H
E0B7 F6 30          	OR	030H
E0B9 47             	LD	B,A
E0BA 5A             	LD	E,D
E0BB 21 00 FF       	LD	HL,KBUF
E0BE                GETL2:
E0BE CD D0 EF       	CALL	_SCRN
E0C1 03             	INC	BC
E0C2 77             	LD	(HL),A
E0C3 23             	INC	HL
E0C4 1D             	DEC	E
E0C5 20 F7          	JR	NZ,GETL2
E0C7                GETL3:
E0C7 2B             	DEC	HL
E0C8 7E             	LD	A,(HL)
E0C9 FE 21          	CP	021H
E0CB D0             	RET	NC
E0CC 36 00          	LD	(HL),0
E0CE 15             	DEC	D
E0CF 20 F6          	JR	NZ,GETL3
E0D1 C9             	RET
E0D2                
E0D2                INKEY:
E0D2 FB             	EI
E0D3 E5             	PUSH	HL
E0D4 2A 90 EF       	LD	HL,(_KEYPS)
E0D7 7C             	LD	A,H
E0D8 AD             	XOR	L
E0D9 28 09          	JR	Z,INKEY1
E0DB 7C             	LD	A,H
E0DC 3C             	INC	A
E0DD 32 91 EF       	LD	(_KEYPS+1),A
E0E0 6F             	LD	L,A
E0E1 26 FE          	LD	H,KEYBF/256
E0E3 7E             	LD	A,(HL)
E0E4                INKEY1:
E0E4 E1             	POP	HL
E0E5 B7             	OR	A
E0E6 C9             	RET
E0E7                
E0E7 00 00 10 87    AT_RS	EQU	SCR1-AT_SCR1
E0E7                	INCLUDE	"LDFILE.ASM"
E0E7                
E0E7                ;	LSX-Dodgers FILE
E0E7                
E0E7                FILEC:
E0E7 CD F2 E0       	CALL	FILE
E0EA                FILEC2:
E0EA 3A 15 EF       	LD	A,(FDRV+1)
E0ED FE 20          	CP	020H
E0EF C8             	RET	Z
E0F0 18 39          	JR	SETDIR1
E0F2                
E0F2                FILE:
E0F2 AF             	XOR	A
E0F3 32 14 EF       	LD	(FDRV),A
E0F6 67             	LD	H,A
E0F7 6F             	LD	L,A
E0F8 22 22 EF       	LD	(FDRV+14),HL
E0FB CD C9 E1       	CALL	SPCUT
E0FE CD AE E1       	CALL	CCHK3
E101 28 12          	JR	Z,DEVI1
E103 13             	INC	DE
E104 1A             	LD	A,(DE)
E105 1B             	DEC	DE
E106 FE 3A          	CP	':'
E108 20 0B          	JR	NZ,DEVI1
E10A 1A             	LD	A,(DE)		;DRIVE
E10B CD FE E3       	CALL	CAP
E10E D6 40          	SUB	'@'
E110 13             	INC	DE
E111 13             	INC	DE
E112 32 14 EF       	LD	(FDRV),A
E115                DEVI1:
E115 1A             	LD	A,(DE)
E116 D6 5C          	SUB	05CH		;\
E118 20 09          	JR	NZ,NOROOT
E11A 6F             	LD	L,A		;A=0でH=0のはずなのでHL=0
E11B 22 2E EF       	LD	(FDRV+26),HL
E11E 2C             	INC	L
E11F 22 22 EF       	LD	(FDRV+14),HL
E122 13             	INC	DE
E123                NOROOT:
E123                
E123                SETDIR:
E123 CD 4F E1       	CALL	FILED
E126 1A             	LD	A,(DE)
E127 FE 5C          	CP	05CH		;\
E129 C0             	RET	NZ
E12A 13             	INC	DE
E12B                SETDIR1:
E12B 3E 10          	LD	A,010H		;Directory
E12D 32 21 EF       	LD	(FDRV+13),A
E130 D5             	PUSH	DE
E131 11 14 EF       	LD	DE,FDRV
E134 2A 1E F0       	LD	HL,(STABLE+2*00FH)
E137 CD 0F 00       	CALL	JP_HL
E13A D1             	POP	DE
E13B B7             	OR	A
E13C C0             	RET	NZ
E13D                
E13D 3A 21 EF       	LD	A,(FDRV+13)
E140 CB 67          	BIT	4,A
E142 C8             	RET	Z
E143                
E143 CD 96 E1       	CALL	FILEI
E146 2A 2E EF       	LD	HL,(FDRV+26)
E149 23             	INC	HL
E14A 22 22 EF       	LD	(FDRV+14),HL
E14D 18 D4          	JR	SETDIR
E14F                
E14F                FILED:
E14F CD 96 E1       	CALL	FILEI
E152 21 15 EF       	LD	HL,FNAME
E155                
E155 06 08          	LD	B,8
E157                FILE2:
E157 CD A3 E1       	CALL	CCHKF
E15A C8             	RET	Z
E15B FE 2A          	CP	'*'
E15D 28 2E          	JR	Z,FILE9
E15F FE 2E          	CP	'.'
E161 28 0C          	JR	Z,FILE4
E163 77             	LD	(HL),A
E164 23             	INC	HL
E165 10 F0          	DJNZ	FILE2
E167                
E167                FILE3:
E167 CD A3 E1       	CALL	CCHKF
E16A C8             	RET	Z
E16B FE 2E          	CP	'.'
E16D 20 F8          	JR	NZ,FILE3
E16F                
E16F                FILE4:
E16F 21 1D EF       	LD	HL,FNAME+8
E172 06 03          	LD	B,3
E174                
E174                FILE4L:
E174 CD A3 E1       	CALL	CCHKF
E177 C8             	RET	Z
E178 FE 2E          	CP	'.'
E17A 20 08          	JR	NZ,FILE12
E17C 32 15 EF       	LD	(FNAME),A	;Parent directory(..)
E17F 32 16 EF       	LD	(FNAME+1),A
E182 3E 20          	LD	A,020H
E184                FILE12:
E184 FE 2A          	CP	'*'
E186 28 0A          	JR	Z,FILE10
E188 77             	LD	(HL),A
E189 23             	INC	HL
E18A 10 E8          	DJNZ	FILE4L
E18C C9             	RET
E18D                
E18D                FILE9:				;名前の*処理、名前の残りを?で埋める
E18D CD 92 E1       	CALL	FILE10
E190 18 D5          	JR	FILE3
E192                
E192                FILE10:
E192 3E 3F          	LD	A,'?'
E194 18 08          	JR	FILL_MEMORY
E196                FILEI:				;名前＋拡張子をスペースで初期化
E196 3E 20          	LD	A,020H
E198 01 00 0B       	LD	BC,11*256	;C=0にしておく
E19B 21 15 EF       	LD	HL,FNAME
E19E                FILL_MEMORY:			;HLからBバイトAで埋める
E19E 77             	LD	(HL),A
E19F 23             	INC	HL
E1A0 10 FC          	DJNZ	FILL_MEMORY
E1A2 C9             	RET
E1A3                
E1A3                CCHKF:
E1A3 1A             	LD	A,(DE)
E1A4 CD AB E1       	CALL	CCHK2
E1A7 C8             	RET	Z
E1A8 C3 18 E5       	JP	FKAN
E1AB                
E1AB                CCHK2:
E1AB 0C             	INC	C
E1AC 0D             	DEC	C
E1AD C0             	RET	NZ
E1AE                CCHK3:				;ZF=1 で使えない文字
E1AE FE 2B          	CP	'+'
E1B0 C8             	RET	Z
E1B1 FE 2C          	CP	','
E1B3 C8             	RET	Z
E1B4 FE 2F          	CP	'/'
E1B6 C8             	RET	Z
E1B7 FE 3A          	CP	':'
E1B9 C8             	RET	Z
E1BA FE 3B          	CP	';'
E1BC C8             	RET	Z
E1BD FE 3D          	CP	'='
E1BF C8             	RET	Z
E1C0 FE 5C          	CP	05CH	;\
E1C2 C8             	RET	Z
E1C3 FE 20          	CP	020H
E1C5 D0             	RET	NC
E1C6 BF             	CP	A		;Z=1
E1C7 C9             	RET
E1C8                
E1C8                SS1:
E1C8 13             	INC	DE
E1C9                SPCUT:				;スペースをカット
E1C9 1A             	LD	A,(DE)
E1CA FE 20          	CP	020H
E1CC 28 FA          	JR	Z,SS1
E1CE C9             	RET
E1CF                
E1CF                SETDRVF:
E1CF 11 14 EF       	LD	DE,FDRV
E1D2                SETDRV0:
E1D2 CD DB E1       	CALL	SETDRV
E1D5 FD E1          	POP	IY
E1D7 C1             	POP	BC
E1D8 D1             	POP	DE
E1D9 E1             	POP	HL
E1DA C9             	RET
E1DB                
E1DB                SETDRV:
E1DB E3             	EX	(SP),HL		;HL=RETRN ADDRESS
E1DC D5             	PUSH	DE		;PUSH HL/DE/BC/IY
E1DD C5             	PUSH	BC
E1DE 1A             	LD	A,(DE)
E1DF D5             	PUSH	DE
E1E0 FD E3          	EX	(SP),IY
E1E2                
E1E2 CD EE E1       	CALL	GETDRV
E1E5 3C             	INC	A
E1E6 FD 77 00       	LD	(IY+0),A	;(FCB)ドライブ番号
E1E9 3D             	DEC	A
E1EA CD D9 EF       	CALL	_CHGDRV
E1ED                
E1ED E9             	JP	(HL)
E1EE                
E1EE                GETDRV:
E1EE E6 7F          	AND	07FH
E1F0 D6 01          	SUB	001H
E1F2 30 03          	JR	NC,GETDRV1
E1F4 3A 87 EF       	LD	A,(_DVSW)	;Current Drive
E1F7                GETDRV1:
E1F7 32 88 EF       	LD	(_DRV),A
E1FA C9             	RET
E1FB                
E1FB                SOPENX:
E1FB                SOPENX1:
E1FB 11 39 EF       	LD	DE,SFILE
E1FE 1A             	LD	A,(DE)
E1FF FD BE 00       	CP	(IY+0)		;(FCB)ドライブ番号
E202 20 24          	JR	NZ,SOPEN
E204 13             	INC	DE
E205 FD E5          	PUSH	IY
E207 E1             	POP	HL
E208 23             	INC	HL
E209 CD 96 E3       	CALL	CPFILE
E20C 20 1A          	JR	NZ,SOPEN
E20E                
E20E 2A F4 F0       	LD	HL,(SCDIR)
E211 FD 75 0E       	LD	(IY+14),L	;(FCB)アクセスするディレクトリのクラスタ番号+1
E214 FD 74 0F       	LD	(IY+15),H
E217                
E217 2A F8 F0       	LD	HL,(SFNDF)	;Direcroty location and Flags
E21A 22 9F EF       	LD	(_FILEN),HL
E21D                
E21D ED 5B F6 F0    	LD	DE,(SFBPS)
E221 21 39 EF       	LD	HL,SFILE
E224 36 FF          	LD	(HL),0FFH
E226 23             	INC	HL
E227 C9             	RET
E228                SOPEN:
E228 21 3E E3       	LD	HL,FILESE
E22B                SOPENC:
E22B 22 64 E2       	LD	(OPENPAT+1),HL
E22E                
E22E CD E2 EF       	CALL	_RDFATX		;Detect Media
E231 38 56          	JR	C,RDDERR
E233                
E233 AF             	XOR	A
E234 32 9F EF       	LD	(_FILEN),A
E237 CD 43 E4       	CALL	LDDIRX1		;A=0で呼び出す
E23A 28 18          	JR	Z,SDIRX1
E23C                
E23C CD 2F E3       	CALL	READ_DIR	;Sub Directory
E23F 38 08          	JR	C,SDIRX0
E241 2A 7E F0       	LD	HL,(_DTBUF)
E244 7E             	LD	A,(HL)
E245 FE 2E          	CP	'.'
E247 28 0F          	JR	Z,SOPEN1
E249                SDIRX0:
E249 AF             	XOR	A
E24A 32 A0 EF       	LD	(_DIRF),A
E24D FD 36 0E 01    	LD	(IY+14),1	;(FCB)レコードサイズ
E251 FD 77 0F       	LD	(IY+15),A
E254                SDIRX1:
E254 ED 5B FC F0    	LD	DE,(_DIRPS)	;Root Directory
E258                SOPEN1:
E258 0E 20          SDECPAT:LD	C,32		;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16
E25A                SOPEN1X:
E25A CD 2F E3       	CALL	READ_DIR	;FILE SEARCH
E25D 38 2A          	JR	C,RDDERR
E25F 2A 7E F0       	LD	HL,(_DTBUF)
E262                SOPEN2:
E262 D5             	PUSH	DE
E263 CD 3E E3       OPENPAT:CALL	FILESE		;(Self-rewriting)
E266 D1             	POP	DE
E267 38 6E          	JR	C,SOPENE
E269 28 1B          	JR	Z,SCF_FF_RET
E26B                SOPEN3:
E26B 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E26E B7             	OR	A
E26F 20 0C          	JR	NZ,SOPEN5
E271 13             	INC	DE		;ルートディレクトリ
E272 E5             	PUSH	HL
E273 21 0C 00       MD_PAT:	LD	HL,12		;(Self-rewriting)MAXDIR
E276 ED 52          	SBC	HL,DE		;CF=0 なので SUB HL,DE
E278 E1             	POP	HL
E279 20 DD          	JR	NZ,SOPEN1
E27B 18 07          	JR	SOPEN6
E27D                SOPEN5:
E27D CD 90 EA       	CALL	GNCLX		;END DIR
E280 D8             	RET	C
E281 CD F6 E3       	CALL	ENDCL
E284                SOPEN6:
E284 38 D2          	JR	C,SOPEN1
E286                SCF_FF_RET:
E286 37             	SCF			;CF=1
E287 9F             	SBC	A,A		;A=0FFH
E288 C9             	RET
E289                
E289                RDDERR:
E289 BF             	CP	A		;READ ERR CF=1 ZF=1
E28A 37             	SCF
E28B C9             	RET
E28C                
E28C                NOPEN:
E28C 21 3E E3       	LD	HL,FILESE
E28F 22 64 E2       	LD	(OPENPAT+1),HL
E292 FD 2A 98 EF    	LD	IY,(_FCB)
E296 CD 2B E5       	CALL	CHKWILDX
E299 30 EB          	JR	NC,SCF_FF_RET
E29B FD 7E 00       	LD	A,(IY+0)	;(FCB)ドライブ番号
E29E 3D             	DEC	A
E29F 32 88 EF       	LD	(_DRV),A
E2A2 CD D9 EF       	CALL	_CHGDRV
E2A5 D8             	RET	C
E2A6 2A F8 F0       	LD	HL,(SFNDF)	;Direcroty location and Flags
E2A9 22 9F EF       	LD	(_FILEN),HL
E2AC                
E2AC CD 3E E4       	CALL	LDDIRX
E2AF ED 5B 9A EF    	LD	DE,(_FBPS)
E2B3 CD 2F E3       	CALL	READ_DIR
E2B6 38 D1          	JR	C,RDDERR
E2B8 3A 9E EF       	LD	A,(_FBCNT)
E2BB 3D             	DEC	A
E2BC 28 AD          	JR	Z,SOPEN3
E2BE                NOPEN2:
E2BE 2A 9C EF       	LD	HL,(_FBAD)
E2C1 01 20 00       	LD	BC,020H
E2C4 09             	ADD	HL,BC
E2C5 4F             	LD	C,A
E2C6 18 9A          	JR	SOPEN2
E2C8                
E2C8                SOPENE2:
E2C8 22 9C EF       	LD	(_FBAD),HL
E2CB 79             	LD	A,C
E2CC 32 9E EF       	LD	(_FBCNT),A
E2CF ED 53 9A EF    	LD	(_FBPS),DE
E2D3 FD 22 98 EF    	LD	(_FCB),IY
E2D7                SOPENE:
E2D7 AF             	XOR	A
E2D8 C9             	RET
E2D9                
E2D9                COPEN:
E2D9 FD 36 0D 20    	LD	(IY+13),020H	;(FCB)属性(アトリビュート)
E2DD                
E2DD 21 5B E3       	LD	HL,NEXTSE
E2E0 CD 2B E2       	CALL	SOPENC
E2E3 D0             	RET	NC
E2E4 C8             	RET	Z
E2E5 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E2E8 B7             	OR	A
E2E9 37             	SCF
E2EA C8             	RET	Z		;ルートディレクトリ
E2EB 06 01          	LD	B,1
E2ED CD 87 E5       	CALL	WRDF
E2F0 D8             	RET	C
E2F1 ED 5B FE F0    	LD	DE,(_CLPS)
E2F5 D5             	PUSH	DE
E2F6 CD BF E3       	CALL	DCPAT
E2F9 CD 1B E9       	CALL	DRDNX
E2FC 2A 7E F0       	LD	HL,(_DTBUF)	;ディレクトリエントリを0クリア
E2FF 3A 96 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E302 47             	LD	B,A
E303 AF             	XOR	A
E304 4F             	LD	C,A
E305                COPENCL:
E305 77             	LD	(HL),A
E306 ED A1          	CPI			;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
E308 EA 05 E3       	JP	PE,COPENCL
E30B                
E30B 3A DD E3       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ数
E30E 3D             	DEC	A
E30F 28 19          	JR	Z,COPENE
E311 3E 01          	LD	A,1		;1セクタ辺りのセクタ数が2以上の場合
E313 32 88 EA       	LD	(_SECPS+1),A
E316 D1             	POP	DE		;DE=(_CLPS)
E317 D5             	PUSH	DE
E318                COPEN1:
E318 D5             	PUSH	DE		;データバッファに入らないセクタもゼロクリア
E319 C5             	PUSH	BC
E31A 2A 7E F0       	LD	HL,(_DTBUF)
E31D CD D9 E3       	CALL	CLUSTX
E320 CD F6 EB       	CALL	DWT24
E323 C1             	POP	BC
E324 D1             	POP	DE
E325 CD 87 EA       	CALL	NEXTX
E328 20 EE          	JR	NZ,COPEN1
E32A                COPENE:
E32A 2A 7E F0       	LD	HL,(_DTBUF)
E32D D1             	POP	DE
E32E C9             	RET
E32F                
E32F                READ_DIR:
E32F ED 53 FE F0    	LD	(_CLPS),DE
E333 C5             	PUSH	BC
E334 D5             	PUSH	DE
E335 CD BF E3       	CALL	DCPAT
E338 CD FB E8       	CALL	DRDX
E33B D1             	POP	DE
E33C C1             	POP	BC
E33D C9             	RET
E33E                
E33E                FILESE:
E33E 7E             	LD	A,(HL)
E33F B7             	OR	A
E340 C8             	RET	Z		;END:ZF=1 CF=0
E341 FE E5          	CP	0E5H
E343 28 0E          	JR	Z,FILESE1
E345 FD E5          	PUSH	IY
E347 D1             	POP	DE
E348 13             	INC	DE
E349 E5             	PUSH	HL
E34A CD 96 E3       	CALL	CPFILE
E34D CC B7 E3       	CALL	Z,CPFILE2
E350 E1             	POP	HL
E351 37             	SCF
E352 C8             	RET	Z		;!!!:(ZF=1) CF=1
E353                FILESE1:
E353 CD 6A E3       	CALL	FNEXT
E356 20 E6          	JR	NZ,FILESE
E358                ZF0_CF0_AFF_RET:
E358 F6 FF          	OR	0FFH		;ZF=0 CF=0
E35A C9             	RET
E35B                
E35B                NEXTSE:
E35B 7E             	LD	A,(HL)
E35C B7             	OR	A
E35D 37             	SCF
E35E C8             	RET	Z		;!!!:ZF=1 CF=1
E35F FE E5          	CP	0E5H
E361 37             	SCF
E362 C8             	RET	Z		;!!!:(ZF=1) CF=1
E363 CD 6A E3       	CALL	FNEXT
E366 20 F3          	JR	NZ,NEXTSE
E368 18 EE          	JR	ZF0_CF0_AFF_RET
E36A                
E36A                FNEXT:
E36A E5             	PUSH	HL
E36B 21 9F EF       	LD	HL,_FILEN
E36E 34             	INC	(HL)
E36F E1             	POP	HL
E370 11 20 00       	LD	DE,020H
E373 19             	ADD	HL,DE
E374 0D             	DEC	C
E375 C9             	RET
E376                
E376                CPNAME:
E376 C5             	PUSH	BC
E377 D5             	PUSH	DE
E378 E5             	PUSH	HL
E379 CD 90 E3       	CALL	CPFILE4
E37C E1             	POP	HL
E37D 23             	INC	HL
E37E 23             	INC	HL
E37F 23             	INC	HL
E380 23             	INC	HL
E381 D1             	POP	DE
E382 C1             	POP	BC
E383 20 05          	JR	NZ,CPNAME1
E385 7E             	LD	A,(HL)
E386 23             	INC	HL
E387 66             	LD	H,(HL)
E388 6F             	LD	L,A
E389 C9             	RET
E38A                CPNAME1:
E38A 23             	INC	HL
E38B 23             	INC	HL
E38C 10 E8          	DJNZ	CPNAME
E38E 37             	SCF
E38F C9             	RET
E390                
E390                CPFILE4:
E390 C5             	PUSH	BC
E391 01 00 04       	LD	BC,00400H
E394 18 04          	JR	CPSTR1
E396                CPFILE:
E396 C5             	PUSH	BC
E397 01 00 0B       	LD	BC,00B00H
E39A                CPSTR1:
E39A 1A             	LD	A,(DE)
E39B FE 3F          	CP	'?'		;Wild card
E39D 28 12          	JR	Z,CPSTR2
E39F 7E             	LD	A,(HL)
E3A0 CD 11 E5       	CALL	FKANC
E3A3 E5             	PUSH	HL
E3A4 67             	LD	H,A
E3A5 1A             	LD	A,(DE)
E3A6 CB 01          	RLC	C
E3A8 CD 11 E5       	CALL	FKANC
E3AB CB 09          	RRC	C
E3AD BC             	CP	H		;CP (HL),(DE)
E3AE E1             	POP	HL
E3AF 20 04          	JR	NZ,CPSTR3
E3B1                CPSTR2:
E3B1 13             	INC	DE
E3B2 23             	INC	HL
E3B3 10 E5          	DJNZ	CPSTR1
E3B5                CPSTR3:
E3B5 C1             	POP	BC
E3B6 C9             	RET
E3B7                
E3B7                CPFILE2:
E3B7 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E3BA F6 E1          	OR	0E1H
E3BC 2F             	CPL
E3BD A6             	AND	(HL)
E3BE C9             	RET
E3BF                
E3BF                DCPAT:
E3BF 0E 00          	LD	C,0
E3C1 2A 7E F0       	LD	HL,(_DTBUF)
E3C4 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E3C7 B7             	OR	A
E3C8 C8             	RET	Z		;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
E3C9 3A DD E3       	LD	A,(SPCPAT+1)
E3CC 4F             	LD	C,A
E3CD 3A 88 EA       	LD	A,(_SECPS+1)
E3D0 B9             	CP	C
E3D1 38 01          	JR	C,DC1
E3D3 AF             	XOR	A
E3D4                DC1:
E3D4 F6 80          	OR	080H
E3D6 32 A0 EF       	LD	(_DIRF),A	;bit0-6:セクタインデックス
E3D9                CLUSTX:
E3D9 E5             	PUSH	HL
E3DA EB             	EX	DE,HL
E3DB AF             	XOR	A
E3DC 0E 01          SPCPAT:	LD	C,1		;自己書き換え（1クラスタの論理セクタ数）
E3DE                L_CLDBL:
E3DE CB 19          	RR	C		;->CF
E3E0 38 04          	JR	C,E_CLDBL
E3E2 29             	ADD	HL,HL		;*2
E3E3 8F             	ADC	A,A
E3E4 18 F8          	JR	L_CLDBL
E3E6                E_CLDBL
E3E6 4F             	LD	C,A
E3E7 3A 88 EA       	LD	A,(_SECPS+1)
E3EA B5             	OR	L
E3EB 6F             	LD	L,A
E3EC 11 08 00       CLSPAT:	LD	DE,8	;+8 (2D)  !ADDCL (Self-rewriting)
E3EF AF             	XOR	A
E3F0 19             	ADD	HL,DE	;データ格納領域の先頭論理セクタ番号
E3F1 89             	ADC	A,C
E3F2 4F             	LD	C,A
E3F3 EB             	EX	DE,HL
E3F4 E1             	POP	HL
E3F5 C9             	RET
E3F6                
E3F6                ENDCL:
E3F6 7A             	LD	A,D	;END CLUSTER
E3F7 FE 01          CLPAT1:	CP	1	;164=356	(Self-rewriting)
E3F9 C0             	RET	NZ
E3FA 7B             	LD	A,E
E3FB FE 64          CLPAT2:	CP	064H	;		(Self-rewriting)
E3FD C9             	RET
E3FE                
E3FE                CAP:
E3FE FE 61          	CP	'a'
E400 D8             	RET	C
E401 FE 7B          	CP	'z'+1
E403 D0             	RET	NC
E404 D6 20          	SUB	020H
E406 C9             	RET
E407                CAP2:
E407 CD FE E3       	CALL	CAP
E40A                CAP3:
E40A CD 13 E4       	CALL	CAP4
E40D FE 21          	CP	021H
E40F D0             	RET	NC
E410 3E A0          	LD	A,0A0H
E412 C9             	RET
E413                CAP4:
E413 FE 05          	CP	5
E415 C0             	RET	NZ
E416 3E E5          	LD	A,0E5H
E418 C9             	RET
E419                
E419                CHDIR:
E419 CD 33 ED       	CALL	GETDPBD
E41C 38 1D          	JR	C,CHDIR2
E41E DD 75 1A       	LD	(IX+01AH),L		;_SDIR_
E421 DD 74 1B       	LD	(IX+01BH),H		;_SDIR_+1
E424 18 15          	JR	CHDIR2		;POP_IX_RET
E426                
E426                LDDIR:
E426 CD 33 ED       	CALL	GETDPBD
E429 DD 5E 1A       	LD	E,(IX+01AH)		;_SDIR_
E42C DD 56 1B       	LD	D,(IX+01BH)		;_SDIR_+1
E42F 13             	INC	DE
E430 FD 73 0E       	LD	(IY+14),E	;(FCB)アクセスするディレクトリのクラスタ番号+1
E433 FD 72 0F       	LD	(IY+15),D
E436 1B             	DEC	DE
E437 AF             	XOR	A
E438 32 A0 EF       	LD	(_DIRF),A
E43B                CHDIR2:
E43B DD E1          	POP	IX
E43D C9             	RET
E43E                
E43E                LDDIRX:
E43E 3A A0 EF       	LD	A,(_DIRF)	;(FCB)アクセスするディレクトリのセクタインデックス
E441 E6 7F          	AND	07FH
E443                LDDIRX1:
E443 32 88 EA       	LD	(_SECPS+1),A
E446 FD 5E 0E       	LD	E,(IY+14)	;(FCB)アクセスするディレクトリのクラスタ番号+1
E449 FD 56 0F       	LD	D,(IY+15)
E44C 1B             	DEC	DE
E44D CD F6 E3       	CALL	ENDCL
E450 D4 26 E4       	CALL	NC,LDDIR
E453                LDDIRS:
E453 7A             	LD	A,D
E454 B3             	OR	E
E455 32 A0 EF       	LD	(_DIRF),A	;ディレクトリか判別
E458 C9             	RET
E459                
E459                KILL:
E459 CD 2B E5       	CALL	CHKWILDX
E45C 38 36          	JR	C,KILLW
E45E CD FB E1       	CALL	SOPENX1
E461                KILLS:
E461 3E 1F          	LD	A,01FH
E463 D4 A7 E4       	CALL	NC,CHKATT
E466 D8             	RET	C
E467                KILLSX:
E467 36 E5          	LD	(HL),0E5H	;DIR
E469 CD 05 E5       	CALL	WTDB
E46C 11 1A 00       	LD	DE,01AH
E46F 19             	ADD	HL,DE
E470 5E             	LD	E,(HL)
E471 23             	INC	HL
E472 56             	LD	D,(HL)
E473 18 04          	JR	KILLS2
E475                KILLS1:
E475 ED 5B FE F0    	LD	DE,(_CLPS)	;FAT
E479                KILLS2:
E479 CD F6 E3       	CALL	ENDCL
E47C D0             	RET	NC		;CF=0
E47D 21 FE FF       	LD	HL,0-2
E480 19             	ADD	HL,DE
E481 D0             	RET	NC		;DE= 0 or 1
E482 D5             	PUSH	DE
E483 CD F7 EF       	CALL	_GNCL
E486 ED 53 FE F0    	LD	(_CLPS),DE
E48A D1             	POP	DE
E48B 21 00 00       	LD	HL,0
E48E D4 FA EF       	CALL	NC,_SNCL
E491 30 E2          	JR	NC,KILLS1
E493 C9             	RET
E494                
E494                KILLW:
E494 CD 28 E2       	CALL	SOPEN
E497                KILLW1:
E497 38 0B          	JR	C,KILLW2
E499 CD C8 E2       	CALL	SOPENE2
E49C CD 61 E4       	CALL	KILLS
E49F CD 8C E2       	CALL	NOPEN
E4A2 18 F3          	JR	KILLW1
E4A4                KILLW2:
E4A4 C8             	RET	Z
E4A5 3F             	CCF
E4A6 C9             	RET
E4A7                
E4A7                CHKATT:
E4A7 E5             	PUSH	HL
E4A8 11 0B 00       	LD	DE,00BH
E4AB 19             	ADD	HL,DE
E4AC A6             	AND	(HL)
E4AD E1             	POP	HL
E4AE C8             	RET	Z
E4AF 37             	SCF
E4B0 C9             	RET
E4B1                
E4B1                NAME:
E4B1 CD 2B E5       	CALL	CHKWILDX
E4B4 D8             	RET	C
E4B5 11 04 00       	LD	DE,4
E4B8 19             	ADD	HL,DE
E4B9 22 D1 E4       	LD	(NAMEP+2),HL
E4BC 23             	INC	HL
E4BD CD 2F E5       	CALL	CHKWILD
E4C0 D8             	RET	C
E4C1                
E4C1 CD FB E1       	CALL	SOPENX1
E4C4 3E 0F          	LD	A,00FH
E4C6 D4 A7 E4       	CALL	NC,CHKATT
E4C9 D8             	RET	C
E4CA                
E4CA FD 7E 00       	LD	A,(IY+0)
E4CD FD E5          	PUSH	IY
E4CF FD 21 00 00    NAMEP:	LD	IY,0
E4D3 FD 77 00       	LD	(IY+0),A
E4D6 CD FB E1       	CALL	SOPENX1
E4D9 FD E3          	EX	(SP),IY
E4DB 3F             	CCF
E4DC D4 28 E2       	CALL	NC,SOPEN
E4DF EB             	EX	DE,HL
E4E0 E1             	POP	HL
E4E1 D8             	RET	C
E4E2                
E4E2                SETNAME:
E4E2 01 00 0B       	LD	BC,11*256
E4E5 23             	INC	HL
E4E6 7E             	LD	A,(HL)
E4E7 FE E5          	CP	0E5H
E4E9 20 04          	JR	NZ,SNAME1
E4EB 3E 05          	LD	A,5
E4ED 18 0E          	JR	SNAME3
E4EF                SNAME1:
E4EF 7E             	LD	A,(HL)
E4F0 0C             	INC	C
E4F1 0D             	DEC	C
E4F2 20 09          	JR	NZ,SNAME3
E4F4 CD FE E3       	CALL	CAP
E4F7 FE A0          	CP	0A0H
E4F9 20 02          	JR	NZ,SNAME3
E4FB 3E 20          	LD	A,020H
E4FD                SNAME3:
E4FD 12             	LD	(DE),A
E4FE 7E             	LD	A,(HL)
E4FF 23             	INC	HL
E500 CD 18 E5       	CALL	FKAN
E503 10 EA          	DJNZ	SNAME1
E505                WTDB:
E505 3E FF          	LD	A,0FFH
E507 32 39 EF       	LD	(SFILE),A
E50A                SWTDBF:
E50A 3E 01          	LD	A,1
E50C 32 A4 EF       	LD	(_WTDBF),A
E50F AF             	XOR	A
E510 C9             	RET
E511                
E511                FKANC:
E511 CB 41          	BIT	0,C
E513 CC 07 E4       	CALL	Z,CAP2
E516 18 01          	JR	FKANX
E518                FKAN:			;漢字チェック
E518 13             	INC	DE
E519                FKANX:
E519 CB 41          	BIT	0,C
E51B CB 81          	RES	0,C
E51D C0             	RET	NZ
E51E FE 80          	CP	080H
E520 D8             	RET	C
E521 FE A0          	CP	0A0H
E523 38 03          	JR	C,FKAN1
E525 FE E0          	CP	0E0H
E527 D8             	RET	C
E528                FKAN1:
E528 0C             	INC	C
E529 A7             	AND	A
E52A C9             	RET
E52B                
E52B                CHKWILDX:
E52B FD E5          	PUSH	IY
E52D E1             	POP	HL
E52E 23             	INC	HL
E52F                CHKWILD:
E52F 06 0B          	LD	B,11
E531 3E 3F          	LD	A,'?'
E533                CHKWIL1:
E533 BE             	CP	(HL)
E534 23             	INC	HL
E535 37             	SCF
E536 C8             	RET	Z
E537 10 FA          	DJNZ	CHKWIL1
E539 AF             	XOR	A
E53A C9             	RET
E53B                
E53B                SDIRENT:		;IY=FCB HL=DIR
E53B D5             	PUSH	DE
E53C E5             	PUSH	HL
E53D FD E5          	PUSH	IY
E53F D1             	POP	DE
E540 EB             	EX	DE,HL
E541 CD E2 E4       	CALL	SETNAME
E544                ;				Attribute
E544 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E547 12             	LD	(DE),A
E548 13             	INC	DE
E549                ;				Reserved
E549 AF             	XOR	A
E54A 06 0A          	LD	B,10
E54C                SDE1:
E54C 12             	LD	(DE),A
E54D 13             	INC	DE
E54E 10 FC          	DJNZ	SDE1
E550                					;(FCB)更新時刻
E550 21 EA F0       	LD	HL,SDDATA		;(FCB)更新年月日
E553 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
E555                SDLOOP:					;(FCB)ファイルのサイズ(バイト単位)
E555 7E             	LD	A,(HL)
E556 23             	INC	HL
E557 32 5C E5       	LD	(SDPAT+2),A
E55A FD 7E 00       SDPAT:	LD	A,(IY+0)	;LD A,(IY+A)
E55D 12             	LD	(DE),A
E55E 13             	INC	DE
E55F 10 F4          	DJNZ	SDLOOP
E561                
E561 AF             	XOR	A
E562 E1             	POP	HL
E563 D1             	POP	DE
E564 C9             	RET
E565                
E565                WOPEN:
E565 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E568 E6 1F          	AND	01FH
E56A 37             	SCF
E56B C0             	RET	NZ
E56C FD 36 1C FE    	LD	(IY+28),0FEH	;(FCB)オープンモード
E570                TOPEN2:
E570 AF             	XOR	A
E571                TOPEN:				;Initializes the time stamp
E571 FD 36 17 FF    	LD	(IY+23),0FFH	;(FCB)更新時刻
E575 C9             	RET
E576                
E576                WRDFX:
E576 3A DD E3       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ
E579                L_WRFX:
E579 1F             	RRA		;->CF
E57A 38 04          	JR	C,E_WRFX
E57C CB 39          	SRL	C	;C=C/2
E57E 18 F9          	JR	L_WRFX
E580                E_WRFX:
E580 41             	LD	B,C
E581 04             	INC	B
E582 3E 37          	LD	A,037H		;SCF
E584 32 18 E9       	LD	(DRDN1),A
E587                
E587                WRDF:				;Bクラスタ分FATを確保する
E587 11 02 00       	LD	DE,2
E58A AF             	XOR	A
E58B 32 88 EA       	LD	(_SECPS+1),A
E58E                WRDF1:
E58E C5             	PUSH	BC
E58F D5             	PUSH	DE
E590 CD F7 EF       	CALL	_GNCL
E593 38 1C          	JR	C,WRDF3
E595 7A             	LD	A,D		;空いているかチェック
E596 B3             	OR	E
E597 20 27          	JR	NZ,WRDF4
E599 E1             	POP	HL		;HL=空いているクラスタ
E59A E5             	PUSH	HL
E59B ED 5B FE F0    	LD	DE,(_CLPS)	;DE=元の(_CLPS)
E59F 22 FE F0       	LD	(_CLPS),HL
E5A2 7A             	LD	A,D		;元の(_CLPS)が 0 か?
E5A3 B3             	OR	E
E5A4 20 08          	JR	NZ,WRDF2
E5A6 FD 75 1A       	LD	(IY+26),L	;(FCB)ファイルの先頭クラスタ
E5A9 FD 74 1B       	LD	(IY+27),H	;元が空の場合はFCBにクラスタをセットする
E5AC 18 03          	JR	WRDF3
E5AE                WRDF2:
E5AE CD FA EF       	CALL	_SNCL
E5B1                WRDF3:
E5B1 D1             	POP	DE
E5B2 C1             	POP	BC
E5B3 D8             	RET	C
E5B4 10 0C          	DJNZ	WRDF5		;ここでループカウンタチェック
E5B6 ED 5B FE F0    	LD	DE,(_CLPS)
E5BA 21 FF FF       	LD	HL,0FFFFH	;FATエントリ終了(EOCマーク)
E5BD C3 FA EF       	JP	_SNCL
E5C0                
E5C0                WRDF4:				;DEクラスタが空じゃないので次に移動する
E5C0 D1             	POP	DE
E5C1 C1             	POP	BC
E5C2                WRDF5:
E5C2 13             	INC	DE
E5C3 CD F6 E3       	CALL	ENDCL
E5C6 38 C6          	JR	C,WRDF1
E5C8 37             	SCF
E5C9 C9             	RET
E5CA                
E5CA                RWXR:
E5CA 3A 96 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E5CD                L_RWX:
E5CD 1F             	RRA		;->CF
E5CE 38 06          	JR	C,E_RWX
E5D0 CB 38          	SRL	B	;BC=BC/2
E5D2 CB 19          	RR	C	;
E5D4 18 F7          	JR	L_RWX
E5D6                E_RWX:
E5D6 FD 5E 1A       	LD	E,(IY+26)	;(FCB)ファイルの先頭クラスタ
E5D9 FD 56 1B       	LD	D,(IY+27)
E5DC AF             	XOR	A
E5DD 32 88 EA       	LD	(_SECPS+1),A
E5E0                RWX1:
E5E0 ED 53 FE F0    	LD	(_CLPS),DE
E5E4 7A             	LD	A,D
E5E5 B3             	OR	E
E5E6 28 0D          	JR	Z,SCF_RET	;RET DE==0 => CF=1
E5E8                
E5E8 78             	LD	A,B
E5E9 B1             	OR	C
E5EA C8             	RET	Z		;RET BC==0 => CF=0
E5EB                
E5EB CD 90 EA       	CALL	GNCLX
E5EE D8             	RET	C
E5EF 0B             	DEC	BC
E5F0                
E5F0 CD F6 E3       	CALL	ENDCL
E5F3 38 EB          	JR	C,RWX1
E5F5                SCF_RET:
E5F5 37             	SCF
E5F6 C9             	RET
E5F7                
E5F7                DSKF:
E5F7 11 00 00       MAXCLP:	LD	DE,0
E5FA 2A AC EF       	LD	HL,(_FAKEFREE)
E5FD 7C             	LD	A,H
E5FE B5             	OR	L
E5FF 28 03          	JR	Z,DSKF1
E601 11 01 00       	LD	DE,1
E604                DSKF1:
E604 D5             	PUSH	DE
E605 CD F7 EF       	CALL	_GNCL
E608 38 0C          	JR	C,POPSCF
E60A 7A             	LD	A,D
E60B B3             	OR	E
E60C 20 01          	JR	NZ,DSKF2
E60E 23             	INC	HL
E60F                DSKF2:
E60F D1             	POP	DE
E610 1B             	DEC	DE
E611 7A             	LD	A,D
E612 B3             	OR	E
E613 20 EF          	JR	NZ,DSKF1
E615 C9             	RET
E616                
E616                POPSCF:
E616 F1             	POP	AF
E617 37             	SCF
E618 C9             	RET
E619                
E619                SETTMS:
E619 FD 7E 17       	LD	A,(IY+23)	;(FCB)ファイルを最後に変更した時刻
E61C 3C             	INC	A
E61D C0             	RET	NZ		;ファイルが更新されていない
E61E                SETTMSX:			;FCBに日付時刻をセットする
E61E CD E0 DC       	CALL	_SYS2C		;(BDOS)時刻の獲得
E621                				;H←時  L←分  D←秒
E621 CB 25          	SLA	L		;   *2
E623 CB 25          	SLA	L		;   *4
E625 29             	ADD	HL,HL		;*2 *8
E626 29             	ADD	HL,HL		;*4 *16
E627 29             	ADD	HL,HL		;*8 *32
E628 7A             	LD	A,D
E629 0F             	RRCA			;bit.0->7->->->0->C
E62A E6 1F          	AND	01FH
E62C B5             	OR	L
E62D FD 77 16       	LD	(IY+22),A	;(FCB)ファイルを最後に変更した時刻
E630 FD 74 17       	LD	(IY+23),H
E633                
E633 CD AC DC       	CALL	_SYS2A		;(BDOS)日付の獲得
E636                				;HL←年  D←月  E←日
E636 01 44 F8       	LD	BC,0-1980
E639 09             	ADD	HL,BC
E63A 65             	LD	H,L
E63B                
E63B 7A             	LD	A,D
E63C 87             	ADD	A,A		;*2
E63D 87             	ADD	A,A		;*4
E63E 87             	ADD	A,A		;*8
E63F 87             	ADD	A,A		;*16
E640 6F             	LD	L,A
E641 29             	ADD	HL,HL		;*32
E642 7D             	LD	A,L
E643 B3             	OR	E
E644 FD 77 14       	LD	(IY+20),A	;(FCB)ファイルを最後に変更した日付
E647 FD 74 15       	LD	(IY+21),H
E64A C9             	RET
E64B                
E64B                PUSHRR:
E64B CD 51 E6       	CALL	SUBRR
E64E                POPRR1:
E64E ED B0          	LDIR
E650 C9             	RET
E651                
E651                SUBRR:
E651 FD E5          	PUSH	IY
E653 E1             	POP	HL
E654 11 21 00       	LD	DE,33
E657 19             	ADD	HL,DE
E658 11 5A EF       	LD	DE,HLBUF
E65B 01 03 00       	LD	BC,3
E65E C9             	RET
E65F                
E65F                SETSEQ:
E65F F5             	PUSH	AF		;AHL=Random record
E660 FD 7E 21       	LD	A,(IY+33)	;(FCB)ランダムレコード
E663 FD 6E 22       	LD	L,(IY+34)
E666 FD 66 23       	LD	H,(IY+35)
E669                
E669 CD 85 E6       	CALL	SSQ1
E66C                
E66C 29             	ADD	HL,HL
E66D CB 3D          	SRL	L		;L=L/2
E66F FD 75 20       	LD	(IY+32),L	;(FCB)カレントレコード
E672 FD 74 0C       	LD	(IY+12),H	;(FCB)カレントブロック
E675 F1             	POP	AF
E676                
E676                POPRR:
E676 CD 51 E6       	CALL	SUBRR
E679 EB             	EX	DE,HL
E67A 18 D2          	JR	POPRR1
E67C                
E67C                GETSIZE:
E67C FD 7E 10       	LD	A,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
E67F FD 6E 11       	LD	L,(IY+17)
E682 FD 66 12       	LD	H,(IY+18)
E685                SSQ1:				;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
E685 87             	ADD	A,A		;in HLA => out HL
E686 ED 6A          	ADC	HL,HL
E688 B7             	OR	A
E689 C8             	RET	Z
E68A 23             	INC	HL
E68B C9             	RET
E68C                
E68C                GETSEQ:
E68C FD 6E 20       	LD	L,(IY+32)	;(FCB)カレントレコード
E68F FD 66 0C       	LD	H,(IY+12)	;(FCB)カレントブロック
E692                
E692 CB 25          	SLA	L	;L=L*2
E694                
E694 CB 3C          	SRL	H	;HL=HL/2
E696 CB 1D          	RR	L	;
E698 C9             	RET
E699                
E699                RB_WRITE:
E699 C5             	PUSH	BC
E69A ED 4B 4C F0    	LD	BC,(STABLE+2*026H)	;(BDOS)ランダムブロック書き込み
E69E 18 05          	JR	RBRW
E6A0                RB_READ:
E6A0 C5             	PUSH	BC
E6A1 ED 4B 4E F0    	LD	BC,(STABLE+2*027H)	;(BDOS)ランダムブロック読み込み
E6A5                RBRW:
E6A5 AF             	XOR	A	;HLA = HL*128
E6A6 CB 3C          	SRL	H	;HL=HL/2
E6A8 CB 1D          	RR	L	;
E6AA 1F             	RRA			;HLA
E6AB FD 77 21       	LD	(IY+33),A	;(FCB)ランダムレコード
E6AE FD 75 22       	LD	(IY+34),L
E6B1 FD 74 23       	LD	(IY+35),H
E6B4 21 80 00       	LD	HL,128
E6B7                
E6B7 FD E5          	PUSH	IY
E6B9 D1             	POP	DE
E6BA D5             	PUSH	DE
E6BB CD C2 E6       	CALL	JP_BC
E6BE FD E1          	POP	IY
E6C0 C1             	POP	BC
E6C1 C9             	RET
E6C2                JP_BC:
E6C2 C5             	PUSH	BC
E6C3 C9             	RET
E6C4                
E6C4 00 00 E2 86    _SYS03	EQU	SCF_FF_RET	;(BDOS)外部入力
E6C4 00 00 E2 86    _SYS2B	EQU	SCF_FF_RET	;(BDOS)日付の設定
E6C4 00 00 E2 86    _SYS2D	EQU	SCF_FF_RET	;(BDOS)時刻の設定
E6C4                	INCLUDE	"LDFILE2.ASM"
E6C4                
E6C4                ;	LSX-Dodgers FILE2
E6C4                
E6C4                				;Write random block
E6C4                _SYS26:		;(BDOS)ランダムブロック書き込み
E6C4 AF             	XOR	A
E6C5 32 18 E9       	LD	(DRDN1),A	;NOP
E6C8 22 D9 E8       	LD	(LEFT+1),HL	;HL←書き込むレコード数
E6CB 22 5D EF       	LD	(LEFTX),HL
E6CE CD DB E1       	CALL	SETDRV
E6D1                
E6D1 CD 41 E8       	CALL	RBX0
E6D4 DA 6A E7       	JP	C,RBWERR
E6D7 CD 65 E5       	CALL	WOPEN
E6DA DA 6A E7       	JP	C,RBWERR
E6DD 7C             	LD	A,H
E6DE B5             	OR	L
E6DF CA 63 E7       	JP	Z,RBW1
E6E2                
E6E2 2B             	DEC	HL
E6E3                
E6E3 CD F1 E8       	CALL	GET_RR_CDE	;CDE=Random record
E6E6                
E6E6 AF             	XOR	A	;AHL=HL+CDE
E6E7 19             	ADD	HL,DE
E6E8 89             	ADC	A,C
E6E9                
E6E9 47             	LD	B,A
E6EA 4C             	LD	C,H
E6EB                
E6EB CD CA E5       	CALL	RWXR
E6EE DC 76 E5       	CALL	C,WRDFX
E6F1 DA 6A E7       	JP	C,RBWERR
E6F4                
E6F4 CD 6A E8       	CALL	RBX2
E6F7 28 1A          	JR	Z,RBWB		;NZ=セクタ以下の端数がある
E6F9 CD 7E E8       	CALL	RBXA
E6FC 38 6C          	JR	C,RBWERR
E6FE EB             	EX	DE,HL
E6FF C5             	PUSH	BC
E700 ED B0          	LDIR
E702 22 5F EF       	LD	(DTAX),HL
E705                
E705 CD 0A E5       	CALL	SWTDBF		;バッファデータは更新された
E708                
E708 2A 5D EF       	LD	HL,(LEFTX)
E70B D1             	POP	DE
E70C ED 52          	SBC	HL,DE
E70E 22 5D EF       	LD	(LEFTX),HL
E711 28 30          	JR	Z,RBWEND
E713                
E713                RBWB:
E713 CD B4 E8       	CALL	RBXB
E716 28 13          	JR	Z,RBWC
E718                RBWB1:
E718 C5             	PUSH	BC
E719 D5             	PUSH	DE
E71A CD D9 E3       	CALL	CLUSTX
E71D CD F6 EB       	CALL	DWT24
E720 D1             	POP	DE
E721 C1             	POP	BC
E722 38 46          	JR	C,RBWERR
E724 CD 90 EA       	CALL	GNCLX
E727 38 41          	JR	C,RBWERR
E729 10 ED          	DJNZ	RBWB1
E72B                RBWC:
E72B CD CC E8       	CALL	RBXC
E72E 28 13          	JR	Z,RBWEND
E730 C5             	PUSH	BC
E731 CD D9 E3       	CALL	CLUSTX
E734 CD 17 E9       	CALL	DRDN
E737 C1             	POP	BC
E738 38 30          	JR	C,RBWERR
E73A ED 5B 7E F0    	LD	DE,(_DTBUF)
E73E ED B0          	LDIR
E740 CD 0A E5       	CALL	SWTDBF		;バッファデータは更新された
E743                RBWEND:
E743 CD D8 E8       	CALL	RBXEND
E746                
E746 CD 50 E8       	CALL	RBX1
E749 30 18          	JR	NC,RBW1
E74B 2A D9 E8       	LD	HL,(LEFT+1)
E74E FD 5E 10       	LD	E,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
E751 FD 56 11       	LD	D,(IY+17)	;CDE=File size
E754 FD 4E 12       	LD	C,(IY+18)
E757 AF             	XOR	A
E758 19             	ADD	HL,DE
E759 89             	ADC	A,C
E75A FD 75 10       	LD	(IY+16),L	;(FCB)ファイルのサイズ(バイト単位)
E75D FD 74 11       	LD	(IY+17),H
E760 FD 77 12       	LD	(IY+18),A
E763                RBW1:
E763 FD E1          	POP	IY
E765 C1             	POP	BC
E766 D1             	POP	DE
E767 E1             	POP	HL
E768                DD_NUL:
E768 AF             	XOR	A
E769 C9             	RET
E76A                
E76A                RBWERR:
E76A FD E5          	PUSH	IY
E76C D1             	POP	DE
E76D 2A 20 F0       	LD	HL,(STABLE+2*010H)
E770 CD 0F 00       	CALL	JP_HL
E773                RBRERR1:
E773 3E 01          	LD	A,001H
E775                RBRERR2:
E775 FD E1          	POP	IY
E777 C1             	POP	BC
E778 D1             	POP	DE
E779 E1             	POP	HL
E77A 37             	SCF
E77B 21 00 00       	LD	HL,0
E77E C9             	RET
E77F                
E77F                RBRERR:
E77F 3E FF          	LD	A,0FFH
E781 18 F2          	JR	RBRERR2
E783                
E783                RBRFL:
E783 3E 00          RBRFLP:	LD	A,000H
E785 FE 0D          	CP	00DH
E787 20 05          	JR	NZ,RBRFL1
E789 D5             	PUSH	DE
E78A 1E 0A          	LD	E,00AH
E78C 18 05          	JR	RBRFL2
E78E                RBRFL1:
E78E D5             	PUSH	DE
E78F CD 09 EF       	CALL	_SYS07
E792 5F             	LD	E,A
E793                RBRFL2:
E793 CD CD EF       	CALL	_PRINT
E796 7B             	LD	A,E
E797 D1             	POP	DE
E798 32 84 E7       	LD	(RBRFLP+1),A
E79B C9             	RET
E79C                DDX:
E79C FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
E79F CD FE E3       	CALL	CAP
E7A2 FE 41          	CP	'A'
E7A4 C9             	RET
E7A5                
E7A5                				;Read random block
E7A5                _SYS27:		;(BDOS)ランダムブロック読み込み
E7A5 22 5D EF       	LD	(LEFTX),HL
E7A8 CD DB E1       	CALL	SETDRV
E7AB                
E7AB FD CB 0D 66    	BIT	4,(IY+13)	;(FCB)属性(アトリビュート)
E7AF C2 2F E8       	JP	NZ,RBRDIR	;ディレクトリ
E7B2 CD 41 E8       	CALL	RBX0
E7B5 DA 7F E7       	JP	C,RBRERR
E7B8 CD 50 E8       	CALL	RBX1
E7BB DA 73 E7       	JP	C,RBRERR1
E7BE 79             	LD	A,C
E7BF EB             	EX	DE,HL
E7C0 ED 52          	SBC	HL,DE		;CP 0HL,CDE
E7C2 19             	ADD	HL,DE
E7C3 DE 00          	SBC	A,000H
E7C5 38 01          	JR	C,RBR1
E7C7 EB             	EX	DE,HL
E7C8                RBR1:
E7C8 9F             	SBC	A,A
E7C9 E6 01          	AND	1
E7CB 32 2D E8       	LD	(RBRAP+1),A
E7CE                
E7CE 7C             	LD	A,H
E7CF B5             	OR	L
E7D0 28 54          	JR	Z,RBREND0
E7D2                
E7D2 22 D9 E8       	LD	(LEFT+1),HL	;Read record byte
E7D5 22 5D EF       	LD	(LEFTX),HL
E7D8                
E7D8 CD 6A E8       	CALL	RBX2
E7DB 28 19          	JR	Z,RBRB
E7DD CD 7E E8       	CALL	RBXA
E7E0 DA 7F E7       	JP	C,RBRERR
E7E3 C5             	PUSH	BC
E7E4 ED B0          	LDIR
E7E6 ED 53 5F EF    	LD	(DTAX),DE
E7EA 2A 5D EF       	LD	HL,(LEFTX)
E7ED D1             	POP	DE
E7EE A7             	AND	A
E7EF ED 52          	SBC	HL,DE
E7F1 22 5D EF       	LD	(LEFTX),HL
E7F4 28 2D          	JR	Z,RBREND
E7F6                
E7F6                RBRB:
E7F6 CD B4 E8       	CALL	RBXB
E7F9 28 12          	JR	Z,RBRC
E7FB                RBRB1:
E7FB C5             	PUSH	BC
E7FC D5             	PUSH	DE
E7FD CD D9 E3       	CALL	CLUSTX
E800 CD E6 EB       	CALL	DRD24
E803 D1             	POP	DE
E804 C1             	POP	BC
E805 D4 90 EA       	CALL	NC,GNCLX
E808 DA 7F E7       	JP	C,RBRERR
E80B 10 EE          	DJNZ	RBRB1
E80D                RBRC:
E80D CD CC E8       	CALL	RBXC
E810 28 11          	JR	Z,RBREND
E812 C5             	PUSH	BC
E813 CD D9 E3       	CALL	CLUSTX
E816 CD FB E8       	CALL	DRDX
E819 C1             	POP	BC
E81A DA 7F E7       	JP	C,RBRERR
E81D EB             	EX	DE,HL
E81E 2A 7E F0       	LD	HL,(_DTBUF)
E821 ED B0          	LDIR
E823                RBREND:
E823 CD D8 E8       	CALL	RBXEND
E826                RBREND0:
E826 FD E1          	POP	IY
E828 C1             	POP	BC
E829 D1             	POP	DE
E82A F1             	POP	AF	;(HL)
E82B AF             	XOR	A
E82C 3E 00          RBRAP:	LD	A,000H
E82E C9             	RET
E82F                
E82F                RBRDIR:
E82F FD 6E 1A       	LD	L,(IY+26)	;(FCB)ファイルの先頭クラスタ
E832 FD 66 1B       	LD	H,(IY+27)
E835 CD 19 E4       	CALL	CHDIR
E838 AF             	XOR	A
E839 67             	LD	H,A
E83A 6F             	LD	L,A
E83B 3C             	INC	A
E83C 32 2D E8       	LD	(RBRAP+1),A
E83F 18 E5          	JR	RBREND0
E841                
E841                RBX0:
E841 2A 8A EF       	LD	HL,(_DTA)
E844 22 5F EF       	LD	(DTAX),HL
E847 2A 5D EF       	LD	HL,(LEFTX)
E84A FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
E84D D6 FD          	SUB	0FDH
E84F C9             	RET
E850                
E850                RBX1:
E850 E5             	PUSH	HL		;Record byte
E851                				;AHL=File size
E851 FD 6E 10       	LD	L,(IY+16)	;ファイルのサイズ(バイト単位)
E854 FD 66 11       	LD	H,(IY+17)
E857 FD 7E 12       	LD	A,(IY+18)
E85A                
E85A CD F1 E8       	CALL	GET_RR_CDE	;CDE=Random record
E85D                
E85D A7             	AND	A
E85E ED 52          	SBC	HL,DE
E860 99             	SBC	A,C
E861 D1             	POP	DE
E862                
E862 D8             	RET	C
E863 4F             	LD	C,A
E864 EB             	EX	DE,HL	;CDE=File byte	HL=Record byte
E865 B2             	OR	D
E866 B3             	OR	E
E867 C0             	RET	NZ
E868 37             	SCF
E869 C9             	RET
E86A                
E86A                RBX2:				;Cluster settings
E86A FD 4E 22       	LD	C,(IY+34)	;(+33)(FCB)ランダムレコード
E86D FD 46 23       	LD	B,(IY+35)
E870 CD CA E5       	CALL	RWXR
E873 3A 96 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E876 3D             	DEC	A
E877 FD A6 22       	AND	(IY+34)
E87A FD B6 21       	OR	(IY+33)
E87D C9             	RET
E87E                
E87E                RBXA:
E87E C5             	PUSH	BC
E87F D5             	PUSH	DE
E880 CD D9 E3       	CALL	CLUSTX
E883 CD FB E8       	CALL	DRDX
E886 D1             	POP	DE
E887 C1             	POP	BC
E888 D8             	RET	C
E889 CD 90 EA       	CALL	GNCLX
E88C D8             	RET	C
E88D ED 53 FE F0    	LD	(_CLPS),DE
E891                
E891 FD 4E 21       	LD	C,(IY+33)	;(FCB)ランダムレコード
E894 21 00 04       SECSZ:	LD	HL,0400H	;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
E897 7C             	LD	A,H
E898 3D             	DEC	A		;1024=3 / 512=1
E899 FD A6 22       	AND	(IY+34)		;(FCB)ランダムレコード
E89C 47             	LD	B,A		;BCに1セクタ以下の端数が入る
E89D ED 42          	SBC	HL,BC		;残りを計算
E89F                
E89F ED 5B 5D EF    	LD	DE,(LEFTX)
E8A3 ED 52          	SBC	HL,DE		;CP HL,DE
E8A5 19             	ADD	HL,DE		;
E8A6 38 01          	JR	C,RBXA1		;DEとHLを比較して大きい方をHLに
E8A8 EB             	EX	DE,HL
E8A9                RBXA1:
E8A9 E5             	PUSH	HL
E8AA 2A 7E F0       	LD	HL,(_DTBUF)
E8AD 09             	ADD	HL,BC
E8AE ED 5B 5F EF    	LD	DE,(DTAX)
E8B2 C1             	POP	BC
E8B3 C9             	RET
E8B4                
E8B4                RBXB:
E8B4 2A 5F EF       	LD	HL,(DTAX)
E8B7 ED 5B FE F0    	LD	DE,(_CLPS)
E8BB 3A 5E EF       	LD	A,(LEFTX+1)
E8BE 47             	LD	B,A
E8BF 3A 96 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8C2                RBXB1:
E8C2 1F             	RRA		;->CF
E8C3 38 04          	JR	C,RBXB2
E8C5 CB 38          	SRL	B	;B=B/2
E8C7 18 F9          	JR	RBXB1
E8C9                RBXB2:
E8C9 78             	LD	A,B
E8CA B7             	OR	A
E8CB C9             	RET
E8CC                
E8CC                RBXC:
E8CC ED 4B 5D EF    	LD	BC,(LEFTX)
E8D0 3A 96 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8D3 3D             	DEC	A
E8D4 A0             	AND	B
E8D5 47             	LD	B,A		;1セクタ以下の端数がない場合はZ
E8D6 B1             	OR	C
E8D7 C9             	RET
E8D8                
E8D8                RBXEND:
E8D8 11 00 00       LEFT:	LD	DE,0
E8DB AF             	XOR	A
E8DC FD 6E 21       	LD	L,(IY+33)	;(FCB)ランダムレコード
E8DF FD 66 22       	LD	H,(IY+34)
E8E2 19             	ADD	HL,DE
E8E3 FD 8E 23       	ADC	A,(IY+35)
E8E6 FD 75 21       	LD	(IY+33),L	;(FCB)ランダムレコード
E8E9 FD 74 22       	LD	(IY+34),H
E8EC FD 77 23       	LD	(IY+35),A
E8EF EB             	EX	DE,HL		;HL=Read byte
E8F0 C9             	RET
E8F1                
E8F1                GET_RR_CDE:			;CDE=Random record
E8F1 FD 5E 21       	LD	E,(IY+33)	;(FCB)ランダムレコード
E8F4 FD 56 22       	LD	D,(IY+34)
E8F7 FD 4E 23       	LD	C,(IY+35)
E8FA C9             	RET
E8FB                
E8FB                	INCLUDE	"LDDIO.ASM"
E8FB                
E8FB                ;	LSX-Dodgers DIO
E8FB                
E8FB                DRDX:
E8FB CD 39 E9       	CALL	DRDY
E8FE C8             	RET	Z
E8FF CD 1F E9       	CALL	DRDX1		;データバッファの情報を保存
E902 D8             	RET	C
E903 E5             	PUSH	HL
E904 C5             	PUSH	BC
E905 D5             	PUSH	DE
E906 2A 7E F0       	LD	HL,(_DTBUF)
E909 3A 62 E9       	LD	A,(_DBS24+1)
E90C 4F             	LD	C,A
E90D CD E6 EB       	CALL	DRD24
E910 DC 34 E9       	CALL	C,DRDNE
E913                POP_DE_BC_HL_RET:
E913 D1             	POP	DE
E914 C1             	POP	BC
E915 E1             	POP	HL
E916 C9             	RET
E917                
E917                ;	CDE:セクタ番号
E917                DRDN:
E917 AF             	XOR	A
E918 00             DRDN1:	NOP			;自己書き換え NOP / SCF
E919 30 E0          	JR	NC,DRDX
E91B                DRDNX:
E91B CD 39 E9       	CALL	DRDY
E91E C8             	RET	Z
E91F                DRDX1:
E91F CD 4F E9       	CALL	DWTX
E922                				;データバッファの読み込んだドライブ・セクタ情報を保存
E922 ED 53 A6 EF    	LD	(_DBSEC),DE
E926 79             	LD	A,C
E927 32 62 E9       	LD	(_DBS24+1),A
E92A                
E92A 3A 88 EF       	LD	A,(_DRV)
E92D 32 A5 EF       	LD	(_DBDRV),A
E930 CD D9 EF       	CALL	_CHGDRV
E933 D0             	RET	NC
E934                DRDNE:
E934 9F             	SBC	A,A		;CF=1ならばA=0FFH
E935 32 A5 EF       	LD	(_DBDRV),A
E938 C9             	RET
E939                
E939                ;	CDE:セクタ番号
E939                DRDY:
E939 3A 62 E9       	LD	A,(_DBS24+1)
E93C B9             	CP	C
E93D C0             	RET	NZ
E93E                
E93E E5             	PUSH	HL
E93F 3A 88 EF       	LD	A,(_DRV)
E942 21 A5 EF       	LD	HL,_DBDRV
E945 AE             	XOR	(HL)
E946 20 05          	JR	NZ,POP_HL_RET
E948                
E948 2A A6 EF       	LD	HL,(_DBSEC)
E94B ED 52          	SBC	HL,DE		;CF=0
E94D                POP_HL_RET:
E94D E1             	POP	HL
E94E C9             	RET
E94F                
E94F                DWTX:
E94F 3A A4 EF       	LD	A,(_WTDBF)
E952 B7             	OR	A
E953 C8             	RET	Z
E954 AF             	XOR	A
E955 32 A4 EF       	LD	(_WTDBF),A
E958                
E958 E5             	PUSH	HL
E959 C5             	PUSH	BC
E95A D5             	PUSH	DE
E95B 3A A5 EF       	LD	A,(_DBDRV)
E95E CD D9 EF       	CALL	_CHGDRV
E961 0E 00          _DBS24:	LD	C,0
E963 ED 5B A6 EF    	LD	DE,(_DBSEC)
E967 2A 7E F0       	LD	HL,(_DTBUF)
E96A D4 F6 EB       	CALL	NC,DWT24
E96D                POP_DE_BC_HL_RET2:
E96D 18 A4          	JR	POP_DE_BC_HL_RET
E96F                
E96F                RDFATX:
E96F E5             	PUSH	HL
E970 3A 88 EF       	LD	A,(_DRV)
E973 21 AA EF       	LD	HL,_FATDRV
E976 AE             	XOR	(HL)
E977 28 D4          	JR	Z,POP_HL_RET
E979                
E979 C5             	PUSH	BC
E97A D5             	PUSH	DE
E97B DD E5          	PUSH	IX
E97D CD 99 E9       	CALL	WTFATX
E980 38 13          	JR	C,POP_IX_DE_BC_HL_RET
E982                
E982 AF             	XOR	A
E983 32 AB EF       	LD	(_FATIX),A
E986 3A 88 EF       	LD	A,(_DRV)
E989 32 AA EF       	LD	(_FATDRV),A
E98C CD E5 EF       	CALL	_RDFAT
E98F                RDFATE2:
E98F 30 04          	JR	NC,POP_IX_DE_BC_HL_RET
E991 9F             	SBC	A,A		;A=0xFF
E992 32 AA EF       	LD	(_FATDRV),A
E995                POP_IX_DE_BC_HL_RET:
E995 DD E1          	POP	IX
E997 18 D4          	JR	POP_DE_BC_HL_RET2
E999                
E999                WTFATX:
E999 3A A2 EF       	LD	A,(_WTFATF)
E99C B7             	OR	A
E99D C8             	RET	Z
E99E E5             	PUSH	HL
E99F 3A AA EF       	LD	A,(_FATDRV)
E9A2 21 A5 EF       	LD	HL,_DBDRV
E9A5 AE             	XOR	(HL)
E9A6 CC 4F E9       	CALL	Z,DWTX
E9A9 38 A2          	JR	C,POP_HL_RET
E9AB C5             	PUSH	BC
E9AC D5             	PUSH	DE
E9AD DD E5          	PUSH	IX
E9AF CD 03 EC       	CALL	WTFAT
E9B2 AF             	XOR	A
E9B3 32 A2 EF       	LD	(_WTFATF),A
E9B6 18 DD          	JR	POP_IX_DE_BC_HL_RET
E9B8                
E9B8                NCL1:
E9B8 7A             	LD	A,D
E9B9 B3             	OR	E
E9BA 37             	SCF
E9BB C8             	RET	Z
E9BC                
E9BC 7A             	LD	A,D
E9BD CB 3F          	SRL	A	;/2
E9BF CB 3F          	SRL	A	;/2
E9C1                
E9C1 E5             	PUSH	HL
E9C2 32 E1 E9       	LD	(NCLPAT+2),A	;_FATIX
E9C5 2A AA EF       	LD	HL,(_FATDRV)	;L=_FATDRV H=_FATIX
E9C8 BC             	CP	H
E9C9 3A 88 EF       	LD	A,(_DRV)	;この間でフラグは変化しない
E9CC 32 E0 E9       	LD	(NCLPAT+1),A	;_FATDRV
E9CF 20 05          	JR	NZ,NCL2		;FATIXが違う
E9D1 BD             	CP	L
E9D2 20 02          	JR	NZ,NCL2		;ドライブが違う
E9D4 E1             	POP	HL
E9D5 C9             	RET
E9D6                NCL2:
E9D6 C5             	PUSH	BC
E9D7 D5             	PUSH	DE
E9D8 DD E5          	PUSH	IX
E9DA CD 99 E9       	CALL	WTFATX
E9DD 38 B6          	JR	C,POP_IX_DE_BC_HL_RET
E9DF 01 00 00       NCLPAT:	LD	BC,0		;自己書き換え C=_FATDRV B=_FATIX
E9E2 ED 43 AA EF    	LD	(_FATDRV),BC
E9E6 CD D6 EB       	CALL	RDFATS
E9E9 18 A4          	JR	RDFATE2
E9EB                
E9EB                NCL3:
E9EB CB 9A          	RES	3,D
E9ED CB 92          	RES	2,D
E9EF 6B             	LD	L,E
E9F0 62             	LD	H,D
E9F1 CB 3C          	SRL	H	;
E9F3 CB 1D          	RR	L	;HLA=HLA/2
E9F5 1F             	RRA		;
E9F6 F5             	PUSH	AF
E9F7 3A AB EF       	LD	A,(_FATIX)
E9FA 0F             	RRCA
E9FB 30 0B          	JR	NC,NCL3X1
E9FD 3A 96 E8       	LD	A,(SECSZ+2)
EA00 FE 04          	CP	4		;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
EA02 20 04          	JR	NZ,NCL3X1
EA04 01 00 02       	LD	BC,512
EA07 09             	ADD	HL,BC
EA08                NCL3X1:
EA08 F1             	POP	AF
EA09 ED 4B 7C F0    	LD	BC,(_FATBF)
EA0D 19             	ADD	HL,DE
EA0E 09             	ADD	HL,BC
EA0F 17             	RLA
EA10 C9             	RET
EA11                
EA11                GNCL:
EA11 CD B8 E9       	CALL	NCL1		;GET NEXT CLUSTER
EA14 D8             	RET	C
EA15 C5             	PUSH	BC
EA16 E5             	PUSH	HL
EA17 CD EB E9       	CALL	NCL3
EA1A 38 09          	JR	C,GNC1
EA1C 5E             	LD	E,(HL)
EA1D 23             	INC	HL
EA1E 7E             	LD	A,(HL)
EA1F E6 0F          	AND	00FH
EA21 57             	LD	D,A
EA22 E1             	POP	HL
EA23 C1             	POP	BC
EA24 C9             	RET
EA25                GNC1:
EA25 7E             	LD	A,(HL)
EA26 23             	INC	HL
EA27 56             	LD	D,(HL)
EA28 06 04          	LD	B,4
EA2A                GNC1L:
EA2A CB 3A          	SRL	D	;DA=DA/2
EA2C 1F             	RRA		;
EA2D 10 FB          	DJNZ	GNC1L
EA2F                
EA2F 5F             	LD	E,A
EA30 E1             	POP	HL
EA31 C1             	POP	BC
EA32 A7             	AND	A
EA33 C9             	RET
EA34                
EA34                SNCL:
EA34 CD B8 E9       	CALL	NCL1
EA37 D8             	RET	C
EA38                ;				SET NEXT CLUSTER
EA38 E5             	PUSH	HL
EA39 C5             	PUSH	BC
EA3A D5             	PUSH	DE
EA3B E5             	PUSH	HL
EA3C CD EB E9       	CALL	NCL3
EA3F D1             	POP	DE
EA40                ;CF=ODD
EA40 7E             	LD	A,(HL)
EA41 73             	LD	(HL),E
EA42 38 06          	JR	C,SNC1
EA44                ;EVEN
EA44                ;M[0] = E
EA44                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
EA44 23             	INC	HL
EA45 ED 67          	RRD		;M={A[3:0],E[3:0]}
EA47 7A             	LD	A,D
EA48 18 04          	JR	SNC11
EA4A                SNC1:
EA4A                ;ODD
EA4A                ;HL[0] = (HL[0]&0x0F) | (E<<4)
EA4A                ;HL[1] = DE>>4
EA4A ED 6F          	RLD		;M={D[3:0],E[7:4]}
EA4C 23             	INC	HL
EA4D 72             	LD	(HL),D	;M={D[3:0],E[7:4]}
EA4E                SNC11:
EA4E ED 6F          	RLD		;M={M[7:4],D[3:0]}
EA50 B7             	OR	A
EA51 D1             	POP	DE
EA52 C1             	POP	BC
EA53 E1             	POP	HL
EA54                FAT_CHANGED:
EA54 3E 01          	LD	A,1
EA56 32 A2 EF       	LD	(_WTFATF),A
EA59 C9             	RET
EA5A                
EA5A                N16CL3:
EA5A C5             	PUSH	BC
EA5B 6B             	LD	L,E
EA5C 7A             	LD	A,D
EA5D E6 03          	AND	3
EA5F 67             	LD	H,A
EA60 29             	ADD	HL,HL
EA61 ED 4B 7C F0    	LD	BC,(_FATBF)
EA65 09             	ADD	HL,BC
EA66 C1             	POP	BC
EA67 C9             	RET
EA68                
EA68                GNCL16:
EA68 CD B8 E9       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EA6B D8             	RET	C
EA6C E5             	PUSH	HL
EA6D CD 5A EA       	CALL	N16CL3
EA70 5E             	LD	E,(HL)
EA71 23             	INC	HL
EA72 56             	LD	D,(HL)
EA73 E1             	POP	HL
EA74 C9             	RET
EA75                
EA75                SNCL16:
EA75 CD B8 E9       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EA78 D8             	RET	C
EA79 D5             	PUSH	DE
EA7A E5             	PUSH	HL
EA7B CD 5A EA       	CALL	N16CL3
EA7E D1             	POP	DE		;HL
EA7F 73             	LD	(HL),E
EA80 23             	INC	HL
EA81 72             	LD	(HL),D
EA82 6B             	LD	L,E
EA83 62             	LD	H,D
EA84 D1             	POP	DE
EA85 18 CD          	JR	FAT_CHANGED
EA87                
EA87                ;------------------------
EA87                ;次のセクタを探す際に_SECPSの値をチェック
EA87                ;in
EA87                ;	DE : セクタ番号
EA87                ;out
EA87                ;	DE : 次のセクタ番号
EA87                ;note
EA87                ;
EA87                ;------------------------
EA87                NEXTX:
EA87 3E 00          _SECPS:	LD	A,0	;自己書き換え
EA89 3C             	INC	A
EA8A E6 00          NCPAT:	AND	0	;自己書き換え　1クラスタの論理セクタ数-1
EA8C 32 88 EA       	LD	(_SECPS+1),A
EA8F C9             	RET
EA90                
EA90                GNCLX:
EA90 CD 87 EA       	CALL	NEXTX
EA93 C0             	RET	NZ	;1クラスタのセクタ未満の場合は戻る
EA94 C3 F7 EF       	JP	_GNCL	;次のクラスタを探す
EA97                
EA97                RDFAT:
EA97 3E 80          	LD	A,080H
EA99 32 70 EF       	LD	(CHECK),A
EA9C                RDFAT1:
EA9C 3A 88 EF       	LD	A,(_DRV)
EA9F CD 3C ED       	CALL	CHGDRVR
EAA2 D8             	RET	C
EAA3 DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EAA6 CB 6F          	BIT	5,A
EAA8 28 43          	JR	Z,RDFAT0X
EAAA 21 70 EF       	LD	HL,CHECK
EAAD A6             	AND	(HL)
EAAE 77             	LD	(HL),A
EAAF 11 00 00       	LD	DE,0		;BPB
EAB2 2A 7C F0       	LD	HL,(_FATBF)
EAB5 CD E4 EB       	CALL	DRD16
EAB8 30 24          	JR	NC,GETBPB
EABA 21 70 EF       	LD	HL,CHECK
EABD CB 06          	RLC	(HL)
EABF 3F             	CCF
EAC0 D8             	RET	C
EAC1 DD CB 0A 1E    	RR	(IX+00AH)	;DPB_0A_FDMODE
EAC5 3F             	CCF			;フロッピーディスクのMFMモードを切り替える
EAC6 DD CB 0A 16    	RL	(IX+00AH)	;DPB_0A_FDMODE
EACA 3E FF          	LD	A,0FFH
EACC 32 89 EF       	LD	(_DSK),A
EACF 3A 84 EF       	LD	A,(_DRIVE)
EAD2 E6 03          	AND	3
EAD4 F6 80          	OR	080H
EAD6 6F             	LD	L,A
EAD7 26 EF          	LD	H,_CYL0/256
EAD9 3E FF          	LD	A,0FFH
EADB 77             	LD	(HL),A
EADC 18 BE          	JR	RDFAT1
EADE                GETBPB:
EADE FD E5          	PUSH	IY
EAE0 FD 2A 7C F0    	LD	IY,(_FATBF)	;BPB
EAE4 CD F1 EF       	CALL	_BPB2DPB
EAE7 FD E1          	POP	IY
EAE9 D8             	RET	C
EAEA CD 8E EC       	CALL	CHGDRV2
EAED                RDFAT0X:
EAED CD D6 EB       	CALL	RDFATS
EAF0 D8             	RET	C
EAF1 DD BE 06       	CP	(IX+6)		;DPB_06_FATID
EAF4 C8             	RET	Z
EAF5 DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
EAF9 C0             	RET	NZ		;BPBを取得している場合はFATIDをチェックしない
EAFA 37             	SCF
EAFB C9             	RET
EAFC                
EAFC                BPB2DPB:
EAFC FD 7E 00       	LD	A,(IY+0)	;BS_JmpBoot
EAFF FE EB          	CP	0EBH		;Short jump
EB01 28 08          	JR	Z,BPBOK
EB03 FE E9          	CP	0E9H		;Near jump
EB05 28 04          	JR	Z,BPBOK
EB07 FE 60          	CP	060H		;X68k
EB09 37             	SCF
EB0A C0             	RET	NZ
EB0B                BPBOK:
EB0B FD 7E 0D       	LD	A,(IY+13)	;BPB_SecPerClus
EB0E DD 77 07       	LD	(IX+7),A	;DPB_07_SECPCL
EB11                
EB11 FD 7E 16       	LD	A,(IY+22)	;BPB_FATSz16
EB14 DD 77 00       	LD	(IX+0),A	;DPB_00_FATLN
EB17 FD 7E 17       	LD	A,(IY+23)	;BPB_FATSz16
EB1A DD 77 01       	LD	(IX+1),A	;DPB_00_FATLN
EB1D                
EB1D FD 6E 0E       	LD	L,(IY+14)	;BPB_RsvdSecCnt
EB20 FD 66 0F       	LD	H,(IY+15)
EB23 DD 75 0E       	LD	(IX+00EH),L	;DPB_0E_FATPS
EB26 FD 5E 16       	LD	E,(IY+22)	;BPB_FATSz16
EB29 FD 56 17       	LD	D,(IY+23)
EB2C FD 46 10       	LD	B,(IY+16)	;BPB_NumFATs
EB2F                BPBDP1:				;BPB_FATSz16 * BPB_NumFATs
EB2F 19             	ADD	HL,DE
EB30 10 FD          	DJNZ	BPBDP1
EB32                BPBDP2:
EB32 DD 75 10       	LD	(IX+010H),L	;DPB_10_DIRPS
EB35 DD 74 11       	LD	(IX+011H),H
EB38 E5             	PUSH	HL
EB39                
EB39 FD 6E 11       	LD	L,(IY+17)	;BPB_RootEntCnt
EB3C FD 66 12       	LD	H,(IY+18)
EB3F FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EB42 06 06          	LD	B,6
EB44                BPBBPS1:
EB44 05             	DEC	B
EB45 0F             	RRCA
EB46 30 FC          	JR	NC,BPBBPS1
EB48                BPBDE1:
EB48 29             	ADD	HL,HL
EB49 10 FD          	DJNZ	BPBDE1
EB4B                
EB4B 7C             	LD	A,H
EB4C DD 77 0B       	LD	(IX+00BH),A	;DPB_0B_DIRSCNT
EB4F                
EB4F D1             	POP	DE		;DPB_10_DIRPS
EB50 6C             	LD	L,H
EB51 26 00          	LD	H,0
EB53 19             	ADD	HL,DE		;MAXDIR
EB54 E5             	PUSH	HL
EB55 FD 4E 0D       	LD	C,(IY+13)	;BPB_SecPerClus
EB58 CB 21          	SLA	C		;*2
EB5A AF             	XOR	A
EB5B 47             	LD	B,A
EB5C ED 42          	SBC	HL,BC
EB5E DD 75 14       	LD	(IX+014H),L	;DPB_14_ADDCL16
EB61 DD 74 15       	LD	(IX+015H),H
EB64                
EB64 D1             	POP	DE		;DE=DPB_0B_MAXDIR
EB65 FD 6E 13       	LD	L,(IY+19)	;BPB_TotSec16
EB68 FD 66 14       	LD	H,(IY+20)
EB6B 7C             	LD	A,H
EB6C B5             	OR	L
EB6D 3E 00          	LD	A,0		;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
EB6F 20 10          	JR	NZ,BPB16BIT	;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
EB71 FD 7E 23       	LD	A,(IY+35)	;念のために総セクタ数が24ビットを超える場合はエラーを返す
EB74 B7             	OR	A
EB75 37             	SCF
EB76 C0             	RET	NZ
EB77 FD 6E 20       	LD	L,(IY+32)	;BPB_TotSec32 は AHL の24ビットで扱う
EB7A FD 66 21       	LD	H,(IY+33)	;1クラスタの論理セクタ数(DPB_07_SECPCL)が最大128なので
EB7D FD 7E 22       	LD	A,(IY+34)	;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
EB80 A7             	AND	A		;CF=0
EB81                BPB16BIT:
EB81 ED 52          	SBC	HL,DE
EB83 DE 00          	SBC	A,0
EB85 FD 46 0D       	LD	B,(IY+13)	;BPB_SecPerClus
EB88                BPBTC1:				;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
EB88 CB 18          	RR	B		;->CY
EB8A 38 08          	JR	C,BPBTC2
EB8C CB 3F          	SRL	A
EB8E CB 1C          	RR	H		;AHL=AHL/2
EB90 CB 1D          	RR	L
EB92 18 F4          	JR	BPBTC1
EB94                BPBTC2:
EB94 B7             	OR	A
EB95 37             	SCF
EB96 C0             	RET	NZ		;念のため(クラスタ数が16ビットを超える場合)
EB97 23             	INC	HL
EB98 23             	INC	HL
EB99 DD 75 08       	LD	(IX+8),L	;DPB_08_MAXCL
EB9C DD 74 09       	LD	(IX+9),H
EB9F                
EB9F FD 7E 15       	LD	A,(IY+21)	;BPB_Media
EBA2 DD 77 06       	LD	(IX+6),A	;DPB_06_FATID
EBA5                
EBA5 DD CB 0A 7E    	BIT	7,(IX+00AH)	;DPB_0A_FDMODE
EBA9 28 17          	JR	Z,NOT_FD
EBAB 2E 28          	LD	L,40		;MAXCYLの設定（要検討）ここから下はフロッピーのみ書き換える
EBAD FE FD          	CP	0FDH	;2D
EBAF 28 08          	JR	Z,SETCYL
EBB1 2E 4D          	LD	L,77
EBB3 FE FE          	CP	0FEH	;2HD
EBB5 28 02          	JR	Z,SETCYL
EBB7 2E 50          	LD	L,80	;その他2DD等
EBB9                SETCYL:
EBB9 DD 75 0C       	LD	(IX+00CH),L	;DPB_0C_MAXCYL
EBBC FD 7E 18       	LD	A,(IY+24)	;BPB_SecPerTr
EBBF DD 77 0D       	LD	(IX+00DH),A	;DPB_0D_MAXSEC	;ここまでフロッピー専用
EBC2                NOT_FD:
EBC2 FD 7E 10       	LD	A,(IY+16)	;BPB_NumFATs
EBC5 FE 02          	CP	2		;>2:NC
EBC7 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EBCA 38 02          	JR	C,BPBFAT1
EBCC F6 80          	OR	080H
EBCE                BPBFAT1:
EBCE DD 77 0F       	LD	(IX+00FH),A	;DPB_0F_BPS
EBD1                
EBD1 E6 7F          	AND	07FH		;セクタバッファが1KBしかないので1KBを超える場合はCF=1でエラーにする
EBD3 C6 FB          	ADD	A,0-5		;0-4:NC 5以上:C
EBD5 C9             	RET
EBD6                
EBD6                RDFATS:
EBD6 CD 21 EC       	CALL	FATSETUP
EBD9 D8             	RET	C
EBDA                RDFATL:
EBDA 0E 00          	LD	C,0
EBDC CD E8 EB       	CALL	DRD24B
EBDF 2A 7C F0       	LD	HL,(_FATBF)
EBE2 7E             	LD	A,(HL)
EBE3 C9             	RET
EBE4                
EBE4                DRD16:
EBE4 0E 00          	LD	C,0
EBE6                DRD24:
EBE6 06 01          	LD	B,1
EBE8                DRD24B:
EBE8 DD E5          	PUSH	IX
EBEA DD 2A A8 EF    	LD	IX,(_DPB)
EBEE CD 5B EE       DRDPAT:	CALL	FDRD		;自己書き換え（ディスク読み込み）
EBF1                POP_IX_RET:
EBF1 DD E1          	POP	IX
EBF3 C9             	RET
EBF4                
EBF4                DWT16:
EBF4 0E 00          	LD	C,0
EBF6                DWT24:
EBF6 06 01          	LD	B,1
EBF8                DWT24B:
EBF8 DD E5          	PUSH	IX
EBFA DD 2A A8 EF    	LD	IX,(_DPB)
EBFE CD 4D EE       DWTPAT:	CALL	FDWT		;自己書き換え（ディスク書き込み）
EC01 18 EE          	JR	POP_IX_RET
EC03                
EC03                WTFAT:
EC03 CD 21 EC       	CALL	FATSETUP
EC06 D4 1C EC       	CALL	NC,WTFATL
EC09 D8             	RET	C
EC0A DD CB 0F 7E    	BIT	7,(IX+00FH)	;DPB_0F_BPS
EC0E C8             	RET	Z		;予備FATが無い
EC0F CD 28 EC       	CALL	FATS2
EC12 E5             	PUSH	HL		;予備FAT
EC13 DD 6E 00       	LD	L,(IX+0)	;DPB_00_FATLN
EC16 DD 66 01       	LD	H,(IX+1)
EC19 19             	ADD	HL,DE
EC1A EB             	EX	DE,HL
EC1B E1             	POP	HL
EC1C                WTFATL:
EC1C 0E 00          	LD	C,0
EC1E C3 F8 EB       	JP	DWT24B
EC21                ;------------------------
EC21                ;FATのセットアップ
EC21                ;out
EC21                ;	B  : FATセクタ数
EC21                ;	DE : FAT先頭セクタ番号
EC21                ;	HL : FATバッファポインタ
EC21                ;	CF : 1=ドライブ切り替えエラー
EC21                ;note
EC21                ;	FATサイズがFATバッファを超える場合は
EC21                ;	対象クラスタ領域==(_FATIX)によって
EC21                ;	FAT12:対象クラスタ1024毎に1.5KBを切り替える
EC21                ;	FAT16:対象クラスタ1024毎に2KBを切り替える
EC21                ;------------------------
EC21                FATSETUP:
EC21 3A AA EF       	LD	A,(_FATDRV)
EC24 CD 3C ED       	CALL	CHGDRVR		;ドライブ切り替え
EC27 D8             	RET	C
EC28                FATS2:
EC28 DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS 512=2 1024=4
EC2B 0F             	RRCA
EC2C CD 54 EC       FATSX:	CALL	FATSETUP12	;自己書き換え
EC2F 21 00 00       	LD	HL,0
EC32 4A             	LD	C,D
EC33 54             	LD	D,H
EC34 3A AB EF       	LD	A,(_FATIX)	;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
EC37 47             	LD	B,A
EC38 04             	INC	B
EC39 DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
EC3C                FAT_SKP:
EC3C 05             	DEC	B
EC3D 28 05          	JR	Z,FAT1
EC3F 19             	ADD	HL,DE
EC40 93             	SUB	E
EC41 30 F9          	JR	NC,FAT_SKP
EC43 C9             	RET
EC44                FAT1:
EC44 EB             	EX	DE,HL
EC45 B9             	CP	C		;C=FATバッファに読み込めるセクタ数
EC46 38 01          	JR	C,FAT2
EC48 79             	LD	A,C
EC49                FAT2:
EC49 47             	LD	B,A
EC4A                
EC4A 2A FA F0       	LD	HL,(_FATPS)	;fat sector pos
EC4D 19             	ADD	HL,DE
EC4E EB             	EX	DE,HL
EC4F 2A 7C F0       	LD	HL,(_FATBF)
EC52 AF             	XOR	A		;CF=0
EC53 C9             	RET
EC54                ;
EC54                ;	FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
EC54                ;	FATSETUP* (FAT12/FAT16)
EC54                ;out
EC54                ;	D : FATバッファに読み込める最大のセクタ数
EC54                ;	E : _FATIXで進めるセクタ数
EC54                FATSETUP12:
EC54 11 06 06       	LD	DE,0606H	;256
EC57 D8             	RET	C
EC58 11 03 03       	LD	DE,0303H	;512
EC5B 0F             	RRCA
EC5C D8             	RET	C
EC5D 11 01 02       	LD	DE,0201H	;1024
EC60 C9             	RET
EC61                
EC61                FATSETUP16:
EC61 11 08 08       	LD	DE,0808H	;256
EC64 D8             	RET	C
EC65 11 04 04       	LD	DE,0404H
EC68 0F             	RRCA			;512
EC69 D8             	RET	C
EC6A 11 02 02       	LD	DE,0202H	;1024
EC6D C9             	RET
EC6E                
EC6E                CHGDRV:
EC6E E5             	PUSH	HL
EC6F 21 89 EF       	LD	HL,_DSK
EC72 BE             	CP	(HL)
EC73 28 0A          	JR	Z,CHGDRVE
EC75                CHGDRV1:
EC75 DD E5          	PUSH	IX
EC77 CD 81 EC       	CALL	CHGDRV0
EC7A 3A 89 EF       	LD	A,(_DSK)
EC7D DD E1          	POP	IX
EC7F                CHGDRVE:
EC7F E1             	POP	HL
EC80 C9             	RET
EC81                
EC81                CHGDRV0:
EC81 6F             	LD	L,A
EC82 CD DC EF       	CALL	_GETDPB
EC85 D8             	RET	C
EC86 DD 22 A8 EF    	LD	(_DPB),IX
EC8A 7D             	LD	A,L
EC8B 32 89 EF       	LD	(_DSK),A
EC8E                CHGDRV2:
EC8E F3             	DI
EC8F C5             	PUSH	BC
EC90 D5             	PUSH	DE
EC91 ED 73 F1 EC    	LD	(SPPAT2+1),SP
EC95                
EC95 DD F9          	LD	SP,IX
EC97                
EC97 E1             	POP	HL		;DPB_00_FATLN
EC98 E1             	POP	HL		;DPB_02_DRD
EC99 22 EF EB       	LD	(DRDPAT+1),HL
EC9C                
EC9C E1             	POP	HL
EC9D 22 FF EB       	LD	(DWTPAT+1),HL	;DPB_04_DWT
ECA0                
ECA0 E1             	POP	HL		;L=DPB_06_FATID H=DPB_07_SECPCL
ECA1 7C             	LD	A,H
ECA2 32 DD E3       	LD	(SPCPAT+1),A	;1クラスタの論理セクタ数
ECA5 3D             	DEC	A
ECA6 32 8B EA       	LD	(NCPAT+1),A
ECA9                
ECA9 E1             	POP	HL		;DPB_08_MAXCL
ECAA 7D             	LD	A,L
ECAB 32 FC E3       	LD	(CLPAT2+1),A
ECAE 7C             	LD	A,H
ECAF 32 F8 E3       	LD	(CLPAT1+1),A
ECB2 2B             	DEC	HL
ECB3 22 F8 E5       	LD	(MAXCLP+1),HL
ECB6                
ECB6 E1             	POP	HL		;L=DPB_0A_FDMODE H=DPB_0B_DIRSCNT
ECB7 7D             	LD	A,L
ECB8 F6 FE          	OR	0FEH
ECBA 32 F6 ED       	LD	(FDMODE+1),A
ECBD 07             	RLCA
ECBE E6 03          	AND	3
ECC0 32 DE ED       	LD	(FSPAT+1),A
ECC3 4C             	LD	C,H
ECC4                
ECC4 E1             	POP	HL		;L=DPB_0C_MAXCYL H=DPB_0D_MAXSEC
ECC5 7D             	LD	A,L
ECC6 32 A1 EF       	LD	(_MAXCYL),A
ECC9 7C             	LD	A,H
ECCA 32 87 ED       	LD	(MAXSEC+1),A
ECCD                
ECCD E1             	POP	HL		;L=DPB_0E_FATPS H=DPB_0F_BPS
ECCE 7C             	LD	A,H		;DPB_0F_BPS
ECCF E6 07          	AND	7
ECD1 32 96 E8       	LD	(SECSZ+2),A	;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
ECD4                				;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)等
ECD4                				;1セクタ1024 2HD/EMM/BRAM
ECD4                				;1セクタ256 GRAM等
ECD4                				;1024	512	256
ECD4                				;4	2	1
ECD4 87             	ADD	A,A		;8	4	2
ECD5 87             	ADD	A,A		;010H	8	4
ECD6 87             	ADD	A,A		;020H	010H	8
ECD7 32 59 E2       	LD	(SDECPAT+1),A	;1セクタ辺りのディレクトリエントリ数
ECDA 3D             	DEC	A		;01FH	00FH	7
ECDB 32 1C D9       	LD	(SDECM1+1),A	;1セクタ辺りのディレクトリエントリ数-1
ECDE                
ECDE 26 00          	LD	H,0
ECE0 22 FA F0       	LD	(_FATPS),HL
ECE3                
ECE3 E1             	POP	HL		;L=DPB_10_DIRPS
ECE4 22 FC F0       	LD	(_DIRPS),HL
ECE7                
ECE7 E1             	POP	HL		;L=DPB_12_DEVICE H=DPB_13_UNITNO
ECE8 7C             	LD	A,H
ECE9 32 84 EF       	LD	(_DRIVE),A
ECEC                
ECEC E1             	POP	HL		;DPB_14_ADDCL16
ECED 22 ED E3       	LD	(CLSPAT+1),HL
ECF0                
ECF0 31 00 00       SPPAT2:	LD	SP,0		;元のSPを復元
ECF3 FB             	EI
ECF4 2A FC F0       	LD	HL,(_DIRPS)
ECF7 06 00          	LD	B,0
ECF9 09             	ADD	HL,BC
ECFA 22 74 E2       	LD	(MD_PAT+1),HL
ECFD                
ECFD 2A F8 E5       	LD	HL,(MAXCLP+1);
ED00 11 F6 0F       	LD	DE,4086
ED03 B7             	OR	A
ED04 ED 52          	SBC	HL,DE
ED06 30 0F          	JR	NC,SETFAT16
ED08 21 11 EA       	LD	HL,GNCL		;FAT12
ED0B 11 34 EA       	LD	DE,SNCL
ED0E 01 54 EC       	LD	BC,FATSETUP12
ED11 DD CB 0F AE    	RES	5,(IX+00FH)	;DPB_0F_BPS(FAT12)
ED15 18 0D          	JR	EXTRA1
ED17                SETFAT16:
ED17 21 68 EA       	LD	HL,GNCL16	;FAT16
ED1A 11 75 EA       	LD	DE,SNCL16
ED1D 01 61 EC       	LD	BC,FATSETUP16
ED20 DD CB 0F EE    	SET	5,(IX+00FH)	;DPB_0F_BPS(FAT16)
ED24                EXTRA1:
ED24 22 F8 EF       	LD	(GNCPAT+1),HL
ED27 ED 53 FB EF    	LD	(SNCPAT+1),DE
ED2B ED 43 2D EC    	LD	(FATSX+1),BC
ED2F D1             	POP	DE
ED30 C1             	POP	BC
ED31 AF             	XOR	A
ED32 C9             	RET
ED33                
ED33                GETDPBD:
ED33 DD E3          	EX	(SP),IX
ED35 DD E5          	PUSH	IX
ED37 3A 88 EF       	LD	A,(_DRV)
ED3A 18 07          	JR	GETDPB1
ED3C                
ED3C                CHGDRVR:
ED3C CD D9 EF       	CALL	_CHGDRV
ED3F D8             	RET	C
ED40 3A 89 EF       	LD	A,(_DSK)
ED43                GETDPB1:
ED43 C3 DC EF       	JP	_GETDPB
ED46                
ED46                GETDPB:
ED46 FE 08          	CP	8
ED48 3F             	CCF
ED49 D8             	RET	C
ED4A 0F             	RRCA
ED4B 0F             	RRCA
ED4C 0F             	RRCA
ED4D DD             	DB	0DDH		;Z80未定義命令
ED4E 6F             	LD	L,A		;LD	IXL,A
ED4F DD             	DB	0DDH		;Z80未定義命令
ED50 26 F1          	LD	H,DEVICE/256	;LD	IXH,DEVICE/256
ED52 DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
ED55 B7             	OR	A		;CF=0の為
ED56 DD CB 0F 76    	BIT	6,(IX+00FH)	;DPB_0F_BPS
ED5A C0             	RET	NZ		;FAT16
ED5B DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
ED5F C0             	RET	NZ		;BPB
ED60 FE 01          	CP	001H		;A=0 THEN CF=1
ED62 C9             	RET
ED63                
ED63                FFLUSH:
ED63 F5             	PUSH	AF
ED64 3E FF          	LD	A,0FFH
ED66 32 39 EF       	LD	(SFILE),A
ED69 CD 4F E9       	CALL	DWTX
ED6C 3E FF          	LD	A,0FFH
ED6E 32 A5 EF       	LD	(_DBDRV),A
ED71 CD 99 E9       	CALL	WTFATX
ED74 AF             	XOR	A
ED75 32 AB EF       	LD	(_FATIX),A
ED78 2F             	CPL
ED79 32 AA EF       	LD	(_FATDRV),A
ED7C F1             	POP	AF
ED7D C9             	RET
ED7E                
ED7E                	INCLUDE	"LDDISK.ASM"
ED7E                
ED7E                ;	LSX-Dodgers DISK
ED7E                
ED7E                
ED7E                SEEK:
ED7E 7A             	LD	A,D
ED7F B3             	OR	E
ED80 3E 01          	LD	A,001H
ED82 28 11          	JR	Z,DIV3
ED84                
ED84 06 10          	LD	B,16
ED86 0E 00          MAXSEC:	LD	C,000H
ED88 AF             	XOR	A
ED89 EB             	EX	DE,HL
ED8A                DIV1:
ED8A 29             	ADD	HL,HL
ED8B 8F             	ADC	A,A
ED8C B9             	CP	C
ED8D 38 02          	JR	C,DIV2
ED8F 91             	SUB	C
ED90 2C             	INC	L
ED91                DIV2:
ED91 10 F7          	DJNZ	DIV1
ED93                
ED93 3C             	INC	A	;最小のセクタは１固定
ED94 55             	LD	D,L	;Quotient(TRACK)
ED95                DIV3:
ED95 5F             	LD	E,A	;Remainder
ED96 CB 3A          	SRL	D	;CYLINDER
ED98 9F             	SBC	A,A
ED99 E6 10          	AND	010H	;SIDE
ED9B 4F             	LD	C,A
ED9C                
ED9C 3A 84 EF       	LD	A,(_DRIVE)
ED9F FE 04          	CP	4
EDA1 3F             	CCF
EDA2 D8             	RET	C
EDA3 B1             	OR	C
EDA4 32 22 EE       	LD	(MOPAT+1),A	;Motor off data
EDA7 01 FC 0F       	LD	BC,00FFCH
EDAA F6 80          	OR	080H		;Mortor on
EDAC ED 79          	OUT	(C),A
EDAE                
EDAE CD F4 ED       	CALL	SETMODE
EDB1 D8             	RET	C
EDB2                
EDB2 CD 37 EE       	CALL	DRIVE
EDB5 FE FF          	CP	0FFH		;A=0FFH Unknown CYLINDER
EDB7 CC 16 EE       	CALL	Z,FDCRES	;Restore
EDBA 0E F9          	LD	C,0F9H
EDBC ED 79          	OUT	(C),A		;Currrent CYLINDER
EDBE 92             	SUB	D
EDBF C8             	RET	Z		;No seek
EDC0                
EDC0 3A 86 EF       	LD	A,(_ISEEK)
EDC3 4F             	LD	C,A
EDC4                
EDC4 3A A1 EF       	LD	A,(_MAXCYL)	;Max CYLINDER
EDC7 3D             	DEC	A
EDC8 BA             	CP	D		;Over CYLINDER
EDC9 D8             	RET	C
EDCA                
EDCA B9             	CP	C		;for Built-in 2DD
EDCB 38 03          	JR	C,SETM2
EDCD 78             	LD	A,B		;B=00FH
EDCE DB FE          	IN	A,(0FEH)		;2HD mode for 2DD seek
EDD0                SETM2:
EDD0 78             	LD	A,B
EDD1 DB FD          	IN	A,(0FDH)		;MFM mode
EDD3                
EDD3 0E FB          	LD	C,0FBH
EDD5 ED 51          	OUT	(C),D
EDD7 72             	LD	(HL),D
EDD8 0E 18          	LD	C,018H		;Seek
EDDA                FDCCMD2:
EDDA 3A 85 EF       	LD	A,(_SEEKSP)
EDDD E6 FF          FSPAT:	AND	0FFH
EDDF B1             	OR	C
EDE0                
EDE0                FDCCMD:
EDE0 CD 2D EE       	CALL	COMSET
EDE3                
EDE3 3E 80          FDCPAT:	LD	A,080H		;FDC COMMAND(Self-rewriting)
EDE5 E6 20          	AND	020H		;Write data Write track
EDE7 3C             	INC	A
EDE8                
EDE8                SST:
EDE8 0E 00          	LD	C,0
EDEA                SST1:
EDEA 0D             	DEC	C		; 4
EDEB 20 FD          	JR	NZ,SST1		;12 * 256 / 4 = About 1ms
EDED 3D             	DEC	A
EDEE 20 FA          	JR	NZ,SST1
EDF0                
EDF0 3C             	INC	A		;A=1
EDF1 CD FF ED       	CALL	READY
EDF4                SETMODE:
EDF4 78             	LD	A,B		;B=00FH
EDF5 DB FF          FDMODE:	IN	A,(0FFH)		;Floppy mode(2D/2HD) (Self-rewriting)
EDF7                
EDF7 78             	LD	A,B
EDF8 DB FD          	IN	A,(0FDH)		;MFM mode
EDFA                
EDFA CD 31 EE       	CALL	DELAY0		;Head select time
EDFD 3E 81          	LD	A,081H
EDFF                READY:
EDFF 32 09 EE       	LD	(WAITA+1),A
EE02 E5             	PUSH	HL
EE03 0E F8          	LD	C,0F8H
EE05 61             	LD	H,C
EE06                READY2:
EE06 ED 78          	IN	A,(C)
EE08 E6 81          WAITA:	AND	081H		;NOT READY,BUSY
EE0A 28 08          	JR	Z,READYE
EE0C E3             	EX	(SP),HL		;wait 19clock
EE0D E3             	EX	(SP),HL		; //
EE0E 2B             	DEC	HL
EE0F 7C             	LD	A,H
EE10 B5             	OR	L
EE11 20 F3          	JR	NZ,READY2
EE13 37             	SCF
EE14                READYE:
EE14 E1             	POP	HL
EE15 C9             	RET
EE16                
EE16                FDCRES:
EE16 36 00          	LD	(HL),0
EE18 0E 08          	LD	C,8
EE1A 18 BE          	JR	FDCCMD2
EE1C                
EE1C                FDMOFF:
EE1C F5             	PUSH	AF
EE1D C5             	PUSH	BC
EE1E 01 FC 0F       	LD	BC,00FFCH	;Motor off
EE21 3E 00          MOPAT:	LD	A,000H		;(Self-rewriting)
EE23 ED 79          	OUT	(C),A
EE25 C1             	POP	BC
EE26 F1             	POP	AF
EE27 C9             	RET
EE28                
EE28                SECSET:
EE28 01 FA 0F       	LD	BC,00FFAH
EE2B ED 59          	OUT	(C),E
EE2D                COMSET:
EE2D 0E F8          	LD	C,0F8H
EE2F ED 79          	OUT	(C),A
EE31                DELAY0:
EE31 3E 1A          	LD	A,26
EE33                DELAY:
EE33 3D             	DEC	A
EE34 20 FD          	JR	NZ,DELAY
EE36 C9             	RET
EE37                
EE37                DRIVE:
EE37 2A 84 EF       	LD	HL,(_DRIVE)
EE3A 26 EF          	LD	H,_CYL0/256
EE3C CB FD          	SET	7,L
EE3E 7E             	LD	A,(HL)
EE3F C9             	RET
EE40                
EE40                RNF:
EE40 CD 37 EE       	CALL	DRIVE
EE43 36 FF          	LD	(HL),0FFH
EE45 C9             	RET
EE46                
EE46 02             RETRY:	DB	2
EE47                
EE47                
EE47                ;	FLOPPY DISK DRIVER(DMA)
EE47                
EE47                
EE47                WTTRK:
EE47 06 01          	LD	B,1
EE49 3E F4          	LD	A,0F4H
EE4B 18 02          	JR	WTTRK1
EE4D                FDWT:
EE4D 3E A0          	LD	A,0A0H
EE4F                WTTRK1:
EE4F 32 E4 ED       	LD	(FDCPAT+1),A
EE52 3E 10          	LD	A,16
EE54 18 0C          	JR	DISK
EE56                
EE56                DISKOK:
EE56 06 01          FDCNT:	LD	B,1
EE58 10 0B          	DJNZ	DISK1
EE5A C9             	RET
EE5B                
EE5B                FDRD:
EE5B 3E 80          	LD	A,080H
EE5D 32 E4 ED       	LD	(FDCPAT+1),A
EE60 3E 0E          	LD	A,14
EE62                
EE62                DISK:
EE62 32 79 EE       	LD	(DMAPAT+1),A
EE65                DISK1:
EE65 78             	LD	A,B
EE66 32 57 EE       	LD	(FDCNT+1),A
EE69 22 FB EE       	LD	(DMAD+11),HL
EE6C                DISKR:
EE6C 3E 02          	LD	A,2		;Retry count
EE6E 32 46 EE       	LD	(RETRY),A
EE71                DISK2:
EE71 D5             	PUSH	DE
EE72 CD 7E ED       	CALL	SEEK
EE75 38 43          	JR	C,ERRF
EE77 F3             	DI
EE78                
EE78 3E 0E          DMAPAT:	LD	A,14		;自己書き換え
EE7A 21 F0 EE       	LD	HL,DMAD
EE7D CD EC DF       	CALL	SETDMA
EE80 ED 49          	OUT	(C),C		;OUT 01F87H,087H WR6 イネーブル
EE82 3A E4 ED       	LD	A,(FDCPAT+1)
EE85 C5             	PUSH	BC
EE86 CD 28 EE       	CALL	SECSET
EE89 2A FB EE       	LD	HL,(DMAHL)
EE8C 23             	INC	HL
EE8D 11 06 BB       	LD	DE,0BB06H	;READ DMA
EE90                
EE90 3E 03          	LD	A,3
EE92 CD FF ED       	CALL	READY
EE95 ED 78          	IN	A,(C)
EE97                
EE97 C1             	POP	BC
EE98 ED 51          	OUT	(C),D		;読み出しマスク設定
EE9A ED 59          	OUT	(C),E		;バイトカウンタ(LH)
EE9C ED 58          	IN	E,(C)
EE9E ED 50          	IN	D,(C)
EEA0 19             	ADD	HL,DE
EEA1 D1             	POP	DE
EEA2 13             	INC	DE
EEA3 FB             	EI
EEA4 CD 1C EE       	CALL	FDMOFF
EEA7 B7             	OR	A
EEA8 28 AC          	JR	Z,DISKOK
EEAA 1B             	DEC	DE
EEAB CB 67          	BIT	4,A
EEAD C4 40 EE       	CALL	NZ,RNF
EEB0                DISKE2:
EEB0 21 46 EE       	LD	HL,RETRY
EEB3 35             	DEC	(HL)
EEB4 20 BB          	JR	NZ,DISK2
EEB6 B7             	OR	A
EEB7 28 34          	JR	Z,ERR
EEB9 D5             	PUSH	DE
EEBA                ERRF:
EEBA D1             	POP	DE
EEBB                DELP:
EEBB CD 40 EE       	CALL	RNF
EEBE CD 1C EE       	CALL	FDMOFF
EEC1 3A 85 EF       	LD	A,(_SEEKSP)
EEC4 87             	ADD	A,A
EEC5 9F             	SBC	A,A
EEC6 38 25          	JR	C,ERR
EEC8                DELP1:
EEC8 D5             	PUSH	DE
EEC9 21 C0 F0       	LD	HL,DEMES
EECC CD 69 D8       	CALL	MSX
EECF CD E4 DB       	CALL	KEYBC
EED2                DELP2:
EED2 CD CA EF       	CALL	_INKEY
EED5 28 FB          	JR	Z,DELP2
EED7                
EED7 D1             	POP	DE
EED8 CD FE E3       	CALL	CAP
EEDB FE 52          	CP	'R'		;Retry
EEDD CA 6C EE       	JP	Z,DISKR
EEE0 FE 49          	CP	'I'		;Ignore
EEE2 28 07          	JR	Z,IGNORE
EEE4 FE 41          	CP	'A'		;Abort
EEE6 20 E0          	JR	NZ,DELP1
EEE8 C3 00 EF       	JP	BOOT
EEEB                IGNORE:
EEEB 3E FF          	LD	A,0FFH
EEED                ERR:
EEED BF             	CP	A
EEEE 37             	SCF
EEEF C9             	RET
EEF0                
EEF0                			;X1turbo DISK DMA
EEF0 C3             DMAD:	DB	0C3H	;WR6 リセット
EEF1 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
EEF2 FB 0F          	DW	00FFBH	;ポートA開始アドレス FDC データレジスタ
EEF4 FF FF          	DW	0FFFFH	;ブロック長(転送サイズ-1)
EEF6 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
EEF7 10             	DB	010H	;WR2 ポートBインクリメント
EEF8 80             	DB	080H	;WR3
EEF9 92             	DB	092H	;WR5 WAIT RDY:LOW
EEFA 8D             	DB	08DH	;WR4 バイト ポートB開始アドレス(LH)
EEFB 00 00          DMAHL:	DW	0	;ポートB開始アドレス
EEFD CF             	DB	0CFH	;WR6 ロード
EEFE 01             	DB	001H	;WR0 ポートB←ポートB 転送
EEFF CF             	DB	0CFH	;WR6 ロード
EF00                
EF00                DMAE:
EF00                
EF00 00 00 1E 6F    AT_R	EQU	WTTRK-AT_WTTRK
EF00                
EF00                	INCLUDE	"LDWORK.ASM"
EF00                
EF00                ;	LSX-Dodgers WORK
EF00                ;
EF00                ;	CP/M互換BIOS
EF00                ;	BOOT:アドレス下位1バイトが0になるように
EF00                BOOT:
EF00 C3 00 00       	JP	0
EF03                _SYS00:		;(BDOS)プログラム終了
EF03                WBOOT:
EF03 C3 0B D1       	JP	WBOOT1
EF06                CONST_:
EF06 C3 9E DC       	JP	CONSTX
EF09                _SYS07:		;(BDOS)コンソール直接入力
EF09                CONIN:
EF09 C3 45 DC       	JP	FLGET
EF0C                CONOUT:
EF0C C3 DD DE       	JP	CONOUT1
EF0F                
EF0F                DECBF:
EF0F                	DS	5
EF14 00             FDRV	DB	0
EF15                FNAME	DS	36
EF39                SFILE:	DS	33		;DRV FILENAME
EF5A                HLBUF:	DS	3		;Random record buffer
EF5D                
EF5D 00 00          LEFTX:	DW	0
EF5F 00 00          DTAX:	DW	0
EF61                
EF61 00 8E 01 00    BEEPD:	DB	0,08EH,1,0,00BH,0,00CH,010H
EF65 0B 00 0C 10
EF69 07 3E 08 10    	DB	007H,03EH,008H,010H,00DH,0,0FFH
EF6D 0D 00 FF
EF70                
EF70 00             CHECK:	DB	0
EF71                
EF71 4F 4B 24       OK:	DB	"OK$"
EF74 53 6B 69 70    SKIP:	DB	"Skip$"
EF78 24
EF79 45 72 72 6F    COMERM:	DB	"Error!$"
EF7D 72 21 24
EF80                
EF80                ;	_CYL0:アドレス下位1バイトが080Hになるように
EF80 FF             _CYL0:	DB	0FFH	;Cylinder
EF81 FF             _CYL1:	DB	0FFH	;Cylinder
EF82 FF             _CYL2:	DB	0FFH	;Cylinder
EF83 FF             _CYL3:	DB	0FFH	;Cylinder
EF84 00             _DRIVE:	DB	0	;unit number
EF85 00             _SEEKSP:DB	0	;Seek speed
EF86 FF             _ISEEK:	DB	0FFH	;
EF87 00             _DVSW:	DB	0
EF88 00             _DRV:	DB	0
EF89 FF             _DSK:	DB	0FFH
EF8A 80 00          _DTA:	DW	00080H
EF8C 00 00          _CTC:	DW	0
EF8E 00 00          _TXADR:	DW	0
EF90 00 00          _KEYPS:	DW	0
EF92 00 FF          _KEYD:	DW	0FF00H	;キーデータ
EF94 C2 10          _KEYSP:	DW	010C2H
EF96 07             _COLORF:DB	7	;色
EF97 18             _LINE:	DB	LINE
EF98                
EF98 00 00          _FCB:	DW	0
EF9A 00 00          _FBPS:	DW	0	;SEARCH FILES
EF9C 00 00          _FBAD:	DW	0	;    //
EF9E 00             _FBCNT:	DB	0	;    //
EF9F 00             _FILEN:	DB	0
EFA0 00             _DIRF:	DB	0	;bit7:ディレクトリ bit0-6:セクタインデックス
EFA1 00             _MAXCYL:DB	0
EFA2 00             _WTFATF:DB	0	;FATバッファの更新フラグ
EFA3                		DS	1
EFA4 00             _WTDBF:	DB	0	;データバッファの更新フラグ
EFA5 FF             _DBDRV:	DB	0FFH	;データバッファにあるデータを読み込んだドライブ
EFA6 00 00          _DBSEC:	DW	0	;データバッファにあるデータを読み込んだセクタ番号
EFA8 00 00          _DPB:	DW	0
EFAA                _FATDRV:
EFAA FF             	DB	0FFH	;FATバッファに読み込んでいるドライブ
EFAB 00             _FATIX:	DB	0	;FATバッファに読み込んでいるインデックス
EFAC                _FAKEFREE:
EFAC 00 00          	DW	0	;偽の残量（FATサイズが大きくなると重くなるのでその対策）
EFAE                
EFAE                	DS	2
EFB0                
EFB0 6F 50 59 38    CRTCD:	DB	06FH,050H,059H,038H,01FH,002H,019H,01CH
EFB4 1F 02 19 1C
EFB8 00 07          	DB	000H,007H
EFBA 80 F8 B0 FF    	DW	0-80*LINE,0-80
EFBE 0C             	DB	00CH
EFBF A0             WK1FD0:	DB	0A0H
EFC0                
EFC0 4E DB          CTC0:	DW	INTCTCE
EFC2 4E DB          CTC1:	DW	INTCTCE
EFC4 70 DB          CTC2:	DW	INTCTC2
EFC6 4E DB          CTC3:	DW	INTCTCE
EFC8 37 DB          INTVEC:	DW	INT
EFCA                
EFCA                ;	JUMP
EFCA                
EFCA C3 D2 E0       _INKEY:	JP	INKEY
EFCD C3 6C DD       _PRINT:	JP	PRINT
EFD0 C3 3C E0       _SCRN:	JP	SCRN
EFD3 C3 64 E0       _POS:	JP	POS
EFD6 C3 A6 DE       _LOC:	JP	LOC
EFD9                _CHGDRV:
EFD9 C3 6E EC       	JP	CHGDRV
EFDC                _GETDPB:
EFDC C3 46 ED       	JP	GETDPB
EFDF                _FFLUSH:
EFDF C3 63 ED       	JP	FFLUSH
EFE2                _RDFATX:
EFE2 C3 6F E9       	JP	RDFATX
EFE5 C3 97 EA       _RDFAT:	JP	RDFAT
EFE8 C3 47 EE       _WTTRK:	JP	WTTRK
EFEB C3 5B EE       _FDRD:	JP	FDRD
EFEE C3 4D EE       _FDWT:	JP	FDWT
EFF1                _BPB2DPB:
EFF1 C3 FC EA       	JP	BPB2DPB
EFF4                	DS	3
EFF7                _GNCL:
EFF7 C3 11 EA       GNCPAT:	JP	GNCL		; self-modifying code
EFFA                _SNCL:
EFFA C3 34 EA       SNCPAT:	JP	SNCL		; self-modifying code
EFFD C3 93 D1       _COMANL:JP	COMANL
F000                
F000                _WE:
F000                	INCLUDE	"LDCALL.ASM"
F000                
F000                ;	LSX-Dodgers システムコール(BDOS)
F000                ;
F000                ;	LSX-Dodgers SYSTEM CALL
F000                ;	STABLE:アドレス下位1バイトが0になるように
F000                
F000                STABLE:
F000                ;0
F000 03 EF 18 DC    	DW	_SYS00,_SYS01,_SYS02,_SYS03
F004 24 DC 86 E2
F008 58 D8 58 D8    	DW	_SYS04,_SYS05,_SYS06,_SYS07
F00C 29 DC 09 EF
F010 31 DC 5A D8    	DW	_SYS08,_SYS09,_SYS0A,_SYS0B
F014 6A DC 96 DC
F018 6F D8 74 D8    	DW	_SYS0C,_SYS0D,_SYS0E,_SYS0F
F01C 83 D8 96 D8
F020                ;1
F020 EA D8 2F D9    	DW	_SYS10,_SYS11,_SYS12,_SYS13
F024 78 D9 AE D9
F028 B6 D9 D4 D9    	DW	_SYS14,_SYS15,_SYS16,_SYS17
F02C F1 D9 E9 D9
F030 52 DA 57 DA    	DW	_SYS18,_SYS19,_SYS1A,_SYS1B
F034 5C DA 62 DA
F038 58 D8 88 DA    	DW	_SYS1C,_SYS1D,_SYS1E,_SYS1F
F03C 58 D8 8C DA
F040                ;2
F040 58 D8 28 DA    	DW	_SYS20,_SYS21,_SYS22,_SYS23
F044 3D DA 93 DA
F048 B2 DA 58 D8    	DW	_SYS24,_ERROR,_SYS26,_SYS27
F04C C4 E6 A5 E7
F050 3D DA BB DA    	DW	_SYS28,_SYS29,_SYS2A,_SYS2B
F054 AC DC 86 E2
F058 E0 DC 86 E2    	DW	_SYS2C,_SYS2D,_SYS2E,_SYS2F
F05C 58 D8 DE DA
F060                ;3
F060 D8 DA 58 D8    	DW	_SYS30,_ERROR,_ERROR,_ERROR
F064 58 D8 58 D8
F068 58 D8 58 D8    	DW	_ERROR,_ERROR,_ERROR,_ERROR
F06C 58 D8 58 D8
F070 58 D8 86 E2    	DW	_ERROR,SCF_FF_RET,SCF_FF_RET,_SYS3B
F074 86 E2 FF DA
F078                
F078                	DS	4
F07C 00 F2          _FATBF:	DW	FATBF
F07E 00 FA          _DTBUF:	DW	DTBUF
F080                
F080                ;	CTRLTB:アドレス下位1バイトが080Hになるように
F080                
F080                CTRLTB:
F080 1D DE 1D DE    	DW	CTRL00,CTRL00,CTRL02,CTRL03
F084 59 DE 9E DF
F088 98 DF 7D DE    	DW	CTRL04,CTRL05,CTRL06,CTRL07
F08C 77 DF FE DE
F090 29 DE 4A DE    	DW	CTRL08,CTRL09,CTRL0A,CTRL0B
F094 A1 DF BC DE
F098 74 DF A1 DE    	DW	CTRL0C,CTRL0D,CTRL0E,CTRL00
F09C B6 DF 1D DE
F0A0 1D DE 1D DE    	DW	CTRL00,CTRL00,CTRL12,CTRL00
F0A4 B4 DE 1D DE
F0A8 1D DE 1D DE    	DW	CTRL00,CTRL00,CTRL00,CTRL00
F0AC 1D DE 1D DE
F0B0 1D DE 1D DE    	DW	CTRL00,CTRL00,CTRL0C,CTRL1B
F0B4 74 DF C3 DE
F0B8 44 DE 30 DE    	DW	CTRL1C,CTRL1D,CTRL1E,CTRL1F
F0BC 39 DE A1 DF
F0C0                
F0C0 03 07          DEMES:	DB	3,7
F0C2 44 65 76 69    	DB	"Device I/O Error",5,3
F0C6 63 65 20 49
F0CA 2F 4F 20 45
F0CE 72 72 6F 72
F0D2 05 03
F0D4 41 62 6F 72    	DB	"Abort Retry Ignore?",5,3,0
F0D8 74 20 52 65
F0DC 74 72 79 20
F0E0 49 67 6E 6F
F0E4 72 65 3F 05
F0E8 03 00
F0EA                
F0EA 16 17          SDDATA:	DB	22,23		;(FCB)ファイルを最後に変更した時刻
F0EC 14 15          	DB	20,21		;(FCB)ファイルを最後に変更した日付
F0EE 1A 1B          	DB	26,27		;(FCB)ファイルの先頭クラスタ
F0F0 10 11 12 13    	DB	16,17,18,19	;(FCB)ファイルのサイズ(バイト単位)
F0F4                SDDATAE:
F0F4                
F0F4                SCDIR:	DS	2		;+14 +15
F0F6                SFBPS:	DS	2		;FBPS
F0F8                SFNDF:	DS	2		;FILEN DIRF
F0FA                
F0FA 00 00          _FATPS:	DW	0
F0FC 00 00          _DIRPS:	DW	0
F0FE 00 00          _CLPS:	DW	0
F100                
F100                _PE:
F100                	INCLUDE	"LDDPB.ASM"
F100                
F100                ;	LSX-Dodgers DPB
F100                
F100                DEVICE:
F100                
F100                ;	A:
F100                
F100 02 00          	DW	2	;DPB_00_FATLN
F102 EB EF          	DW	_FDRD	;DPB_02_DRD
F104 EE EF          	DW	_FDWT	;DPB_04_DWT
F106 FD             	DB	0FDH	;DPB_06_FATID
F107 02             	DB	2	;DPB_07_SECPCL
F108 64 01          	DW	356	;DPB_08_MAXCL
F10A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F10B 07             	DB	7	;DPB_0B_DIRSCNT
F10C 28             	DB	40	;DPB_0C_MAXCYL
F10D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F10E 01             	DB	1	;DPB_0E_FATPS
F10F 82             	DB	082H	;DPB_0F_BPS
F110 05 00          	DW	5	;DPB_10_DIRPS
F112 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F113 00             	DB	0	;DPB_13_UNITNO
F114 08 00          	DW	8	;DPB_14_ADDCL16
F116 00 00          	DW	0	;DPB_16
F118 00 00          	DW	0	;DPB_18
F11A 00 00          	DW	0	;DPB_1A_SDIR
F11C 46 44 44 30    	DB	"FDD0"	;DPB_1C_NAME
F120                
F120                ;	B:
F120                
F120 02 00          	DW	2	;DPB_00_FATLN
F122 EB EF          	DW	_FDRD	;DPB_02_DRD
F124 EE EF          	DW	_FDWT	;DPB_04_DWT
F126 FD             	DB	0FDH	;DPB_06_FATID
F127 02             	DB	2	;DPB_07_SECPCL
F128 64 01          	DW	356	;DPB_08_MAXCL
F12A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F12B 07             	DB	7	;DPB_0B_DIRSCNT
F12C 28             	DB	40	;DPB_0C_MAXCYL
F12D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F12E 01             	DB	1	;DPB_0E_FATPS
F12F 82             	DB	082H	;DPB_0F_BPS
F130 05 00          	DW	5	;DPB_10_DIRPS
F132 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F133 01             	DB	1	;DPB_13_UNITNO
F134 08 00          	DW	8	;DPB_14_ADDCL16
F136 00 00          	DW	0	;DPB_16
F138 00 00          	DW	0	;DPB_18
F13A 00 00          	DW	0	;DPB_1A_SDIR
F13C 46 44 44 31    	DB	"FDD1"	;DPB_1C_NAME
F140                
F140                ;	C:
F140                
F140 02 00          	DW	2	;DPB_00_FATLN
F142 EB EF          	DW	_FDRD	;DPB_02_DRD
F144 EE EF          	DW	_FDWT	;DPB_04_DWT
F146 FD             	DB	0FDH	;DPB_06_FATID
F147 02             	DB	2	;DPB_07_SECPCL
F148 64 01          	DW	356	;DPB_08_MAXCL
F14A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F14B 07             	DB	7	;DPB_0B_DIRSCNT
F14C 28             	DB	40	;DPB_0C_MAXCYL
F14D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F14E 01             	DB	1	;DPB_0E_FATPS
F14F 82             	DB	082H	;DPB_0F_BPS
F150 05 00          	DW	5	;DPB_10_DIRPS
F152 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F153 02             	DB	2	;DPB_13_UNITNO
F154 08 00          	DW	8	;DPB_14_ADDCL16
F156 00 00          	DW	0	;DPB_16
F158 00 00          	DW	0	;DPB_18
F15A 00 00          	DW	0	;DPB_1A_SDIR
F15C 46 44 44 32    	DB	"FDD2"	;DPB_1C_NAME
F160                
F160                ;	D:
F160                
F160 02 00          	DW	2	;DPB_00_FATLN
F162 EB EF          	DW	_FDRD	;DPB_02_DRD
F164 EE EF          	DW	_FDWT	;DPB_04_DWT
F166 FD             	DB	0FDH	;DPB_06_FATID
F167 02             	DB	2	;DPB_07_SECPCL
F168 64 01          	DW	356	;DPB_08_MAXCL
F16A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F16B 07             	DB	7	;DPB_0B_DIRSCNT
F16C 28             	DB	40	;DPB_0C_MAXCYL
F16D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F16E 01             	DB	1	;DPB_0E_FATPS
F16F 82             	DB	082H	;DPB_0F_BPS
F170 05 00          	DW	5	;DPB_10_DIRPS
F172 A7             	DB	0A7H	;DPB_12_DEVICE
F173 03             	DB	3	;DPB_13_UNITNO
F174 08 00          	DW	8	;DPB_14_ADDCL16
F176 00 00          	DW	0	;DPB_16
F178 00 00          	DW	0	;DPB_18
F17A 00 00          	DW	0	;DPB_1A_SDIR
F17C 46 44 44 33    	DB	"FDD3"	;DPB_1C_NAME
F180                
F180                ;	E:
F180                
F180 00 00          EMMFL:	DW	0	;DPB_00_FATLN
F182 DD D7          EMMRD:	DW	EDRD	;DPB_02_DRD
F184 D9 D7          EMMWR:	DW	EDWT	;DPB_04_DWT
F186 FE             	DB	0FEH	;DPB_06_FATID
F187 02             	DB	2	;DPB_07_SECPCL
F188 00 00          EMMCL:	DW	0	;DPB_08_MAXCL
F18A 00             	DB	0	;DPB_0A_FDMODE
F18B 0C             	DB	12	;DPB_0B_DIRSCNT
F18C 00             EMMBL:	DB	0	;DPB_0C_MAXCYL
F18D 01             	DB	1	;DPB_0D_MAXSEC
F18E 02             	DB	2	;DPB_0E_FATPS
F18F 02             	DB	2	;DPB_0F_BPS
F190 0A 00          	DW	10	;DPB_10_DIRPS
F192 06             	DB	6	;DPB_12_DEVICE
F193 00             EMMDV:	DB	0	;DPB_13_UNITNO
F194 12 00          	DW	18	;DPB_14_ADDCL16
F196 00 00          	DW	0	;DPB_16
F198 00 00          	DW	0	;DPB_18
F19A 00 00          	DW	0	;DPB_1A_SDIR
F19C 45 4D 4D 30    	DB	"EMM0"	;DPB_1C_NAME
F1A0                
F1A0                ;	F:
F1A0                
F1A0 00 00          BANKFL:	DW	0	;DPB_00_FATLN
F1A2 74 D7          	DW	BDRD	;DPB_02_DRD
F1A4 70 D7          	DW	BDWT	;DPB_04_DWT
F1A6 F9             	DB	0F9H	;DPB_06_FATID
F1A7 02             	DB	2	;DPB_07_SECPCL
F1A8 00 00          BANKCL:	DW	0	;DPB_08_MAXCL
F1AA 00             	DB	0	;DPB_0A_FDMODE
F1AB 08             	DB	8	;DPB_0B_DIRSCNT
F1AC 00             	DB	0	;DPB_0C_MAXCYL
F1AD 01             	DB	1	;DPB_0D_MAXSEC
F1AE 00             	DB	0	;DPB_0E_FATPS
F1AF 02             	DB	2	;DPB_0F_BPS
F1B0 02 00          	DW	2	;DPB_10_DIRPS
F1B2 0B             	DB	00BH	;DPB_12_DEVICE
F1B3 00             	DB	0	;DPB_13_UNITNO
F1B4 06 00          	DW	6	;DPB_14_ADDCL16
F1B6 00 00          	DW	0	;DPB_16
F1B8 00 00          	DW	0	;DPB_18
F1BA 00 00          	DW	0	;DPB_1A_SDIR
F1BC 42 52 41 4D    	DB	"BRAM"	;DPB_1C_NAME
F1C0                
F1C0                ;	G:
F1C0                
F1C0 01 00          	DW	1	;DPB_00_FATLN
F1C2 31 D7          	DW	GDRD	;DPB_02_DRD
F1C4 48 D7          	DW	GDWT	;DPB_04_DWT
F1C6 F9             	DB	0F9H	;DPB_06_FATID
F1C7 04             	DB	4	;DPB_07_SECPCL
F1C8 30 00          	DW	48	;DPB_08_MAXCL
F1CA 00             	DB	0	;DPB_0A_FDMODE
F1CB 04             	DB	4	;DPB_0B_DIRSCNT
F1CC 00             	DB	0	;DPB_0C_MAXCYL
F1CD 01             	DB	1	;DPB_0D_MAXSEC
F1CE 00             	DB	0	;DPB_0E_FATPS
F1CF 01             	DB	1	;DPB_0F_BPS
F1D0 04 00          	DW	4	;DPB_10_DIRPS
F1D2 05             	DB	5	;DPB_12_DEVICE
F1D3 01             	DB	1	;DPB_13_UNITNO
F1D4 00 00          	DW	0	;DPB_14_ADDCL16
F1D6 00 00          	DW	0	;DPB_16
F1D8 00 00          	DW	0	;DPB_18
F1DA 00 00          	DW	0	;DPB_1A_SDIR
F1DC 47 52 41 4D    	DB	"GRAM"	;DPB_1C_NAME
F1E0                
F1E0                ;	H:
F1E0                	DS	31
F1FF 00             	DB	0
F200                
F200                LDEND:
F200                
F200                	END
F200                
