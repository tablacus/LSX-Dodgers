			  Z80 ASSEMBLER - ZASM VER 1.6
                      	;	LSX-Dodgers for X1/turbo/Z
                      	;	Programmed by
                      	;	Gaku (Lovers/Tablacus)
                      	;X1DEF.ASM
                      	
                      	;	LSX-Dodgers DEF
                      	;	X1/turbo/Z
                      	
  0000                	MAC	EQU	0		;X1
  0000                	DEV	EQU	0
                      	
  011D                	VER_6F	EQU	0011DH
                      	
  D100                	RUN	EQU	0D100H
  D706                	BDOS	EQU	0D706H
  F400                	WORKAD	EQU	0F400H
  F700                	FATBF	EQU	0F700H
  FD00                	DTBUF	EQU	0FD00H
  FF00                	KEYBF	EQU	0FF00H
  FF20                	KBUF	EQU	0FF20H
  FFCA                	EXTSP	EQU	0FFCAH
  FFD9                	TRAP38	EQU	0FFD9H
  0050                	WIDTH	EQU	80
  0018                	LINE	EQU	24
  0007                	COLORF	EQU	7
  0010                	KEYSP_H	EQU	16
  00C2                	KEYSP_L	EQU	0C2H
  0008                	COMS	EQU	8
  0002                	MAX_SEC_SZ_H	EQU	2		;1繧ｻ繧ｯ繧ｿ1024繝舌う繝医・繧ｵ繝昴・繝・2:off 4:on)
                      	
                      	;LDDEF.ASM
                      	
                      	;	LSX-Dodgers DEF
                      	
  0001                	VER_1   EQU	1
  0006                	VER_2   EQU	6
  0001                	VER_3   EQU	1
  1D00                	MACW	EQU	MAC + 01D00H	;機種フラグとLD判別フラグ
  0000                	MACD	EQU	MAC + DEV * 256	;機種フラグとデバイスフラグ
  0161                	VER	EQU	VER_1 * 256 + VER_2 * 16 + VER_3
                      	
  0004                	_DVSW	EQU	00004H
  0005                	SYSTEM	EQU	00005H
  000F                	JP_HL	EQU	0000FH
  005C                	FCB1	EQU	0005CH
  006C                	FCB2	EQU	0006CH
  005D                	FCB1FN	EQU	FCB1+1
  006D                	FCB2FN	EQU	FCB2+1
  0080                	DTA1	EQU	00080H
                      	
  FFCA                	EXTBIO	EQU	0FFCAH
                      	
  0000                	DPB_FATLN	EQU	00H
  0002                	DPB_DRD		EQU	02H
  0004                	DPB_DWT		EQU	04H
  0006                	DPB_FATID	EQU	06H
  0007                	DPB_SECPCL	EQU	07H
  0008                	DPB_MAXCL	EQU	08H
  000A                	DPB_FDMODE	EQU	0AH
  000B                	DPB_DIRSCNT	EQU	0BH
  000C                	DPB_MAXCYL	EQU	0CH
  000D                	DPB_MAXSEC	EQU	0DH
  000E                	DPB_FATPS	EQU	0EH
  000F                	DPB_BPS		EQU	0FH
  0010                	DPB_DIRPS	EQU	10H
  0012                	DPB_DEVICE	EQU	12H
  0013                	DPB_UNITNO	EQU	13H
  0014                	DPB_ADDCL	EQU	14H
                      	
  001A                	DPB_SDIR	EQU	1AH
  001C                	DPB_NAME	EQU	1CH
                      	
                      	
                      	
  D0F9                		ORG	RUN-7
                      	
                      	;	MSX BINARY HEADER
  D0F9  FE            		DB	0FEH
                      	;	MSX BINARY START ADDRESS
  D0FA  00D1          		DW	RUN
                      	;	MSX BINARY END ADDRESS
  D0FC  F9F6          		DW	LAST_ADR
                      	;	MSX BINARY EXEC ADDRESS
  D0FE  07D1          		DW	START
                      	;X1INIT.ASM
                      	
                      	;	LSX-Dodgers INIT
                      	;	X1/turbo/Z
                      	
  D100  C307D1        		JP	START
  D103  001D          		DW	MACW
  D105  6101          		DW	VER
                      	
  D107                	START:
  D107  F3            		DI
  D108  ED5E          		IM	2
  D10A  31CAFF        		LD	SP,EXTSP
  D10D  CD58D1        		CALL	INIT		;NZならAUTOEXECを実行
  D110  210000        		LD	HL,0
  D113  E5            		PUSH	HL
  D114  F5            		PUSH	AF
                      					;2HD等1セクタ1024バイトで起動時(Japan2HD)
  D115  3A0CFE        		LD	A,(0FE0CH)
  D118  FE04          		CP	4
  D11A  201B          		JR	NZ,NOT_2HD2014
  D11C  2A0600        		LD	HL,(00006H)
  D11F  5D            		LD	E,L
  D120  54            		LD	D,H
  D121  15            		DEC	D
  D122  15            		DEC	D
  D123  15            		DEC	D
  D124  15            		DEC	D
  D125  ED530600      		LD	(00006H),DE
  D129  010300        		LD	BC,3
  D12C  EDB0          		LDIR
  D12E  3E04          		LD	A,4
  D130  327BF5        		LD	(_MAX_SEC_SZ_H),A
  D133  ED537EF5      		LD	(_DTBUF),DE
  D137                	NOT_2HD2014:
  D137  3A0400        		LD	A,(_DVSW)
  D13A  CDDCF4        		CALL	_GETDPB
  D13D  380A          		JR	C,INIT1
  D13F  3A0400        		LD	A,(_DVSW)
  D142  C641          		ADD	A,'A'
  D144  32A1D4        		LD	(AUTODV),A
  D147  1807          		JR	INIT2
  D149                	INIT1:
  D149  1E00          		LD	E,0
  D14B  0E0E          		LD	C,00EH
  D14D  CD0500        		CALL	SYSTEM
  D150                	INIT2:
  D150  F1            		POP	AF
  D151  C8            		RET	Z
  D152  1198D4        		LD	DE,AUTOD
  D155  C3FDF4        		JP	_COMANL
                      	
  D158                	INIT:
  D158  3E1E          		LD	A,01EH
  D15A  D300          		OUT	(0),A
                      	
  D15C  010000        		LD	BC,0
  D15F  ED438CF4      		LD	(_CTC),BC
  D163  01040A        		LD	BC,00A04H
  D166  CD42D4        		CALL	CHKCTC
  D169  010407        		LD	BC,00704H
  D16C  CD42D4        		CALL	CHKCTC
  D16F  01A81F        		LD	BC,01FA8H
  D172  CD42D4        		CALL	CHKCTC
  D175  01A01F        		LD	BC,01FA0H
  D178  CD42D4        		CALL	CHKCTC
                      	
  D17B                	INISIO:
  D17B  01911F        		LD	BC,01F91H	;INIT SIO
  D17E  1601          		LD	D,1
  D180  ED51          		OUT	(C),D
                      	
  D182  ED71          		DB	0EDH,071H	;OUT (C),0	Z80未定義命令
  D184  0E93          		LD	C,093H
  D186  ED51          		OUT	(C),D
  D188  ED71          		DB	0EDH,071H	;OUT (C),0	Z80未定義命令
  D18A  0E99          		LD	C,099H		;INIT SIO
  D18C  1601          		LD	D,1
  D18E  ED71          		DB	0EDH,071H	;OUT (C),0	Z80未定義命令
  D190  0E9B          		LD	C,09BH
  D192  ED51          		OUT	(C),D
  D194  ED71          		DB	0EDH,071H	;OUT (C),0	Z80未定義命令
                      	
  D196  0E80          		LD	C,080H		;INIT DMA
  D198  2106C3        		LD	HL,0C306H
  D19B                	INIDMA:
  D19B  ED61          		OUT	(C),H
  D19D  2D            		DEC	L
  D19E  20FB          		JR	NZ,INIDMA
                      	
  D1A0  3EE4          		LD	A,0E4H
  D1A2  CDF9E2        		CALL	COMOUT
  D1A5  AF            		XOR	A
  D1A6  CDD3E2        		CALL	OT49SB
                      	
  D1A9  3EF4          		LD	A,INTVEC/256
  D1AB  ED47          		LD	I,A
                      	
  D1AD  ED4B8CF4      		LD	BC,(_CTC)
  D1B1  0D            		DEC	C
  D1B2  0D            		DEC	C
                      	
  D1B3  ED71          		DB	0EDH,071H	;OUT (C),0	Z80未定義命令
  D1B5  3EC0          		LD	A,CTC0-CPM_BOOT
  D1B7  ED79          		OUT	(C),A
                      	
  D1B9  0C            		INC	C
  D1BA  3E47          		LD	A,047H
  D1BC  ED79          		OUT	(C),A
  D1BE  3E0D          		LD	A,13		;Baudrate 9600-13
  D1C0  ED79          		OUT	(C),A
                      	
  D1C2  79            		LD	A,C
  D1C3  D610          		SUB	010H
  D1C5  4F            		LD	C,A
                      	;	LD	(SIOAD+1),BC
                      	;	LD	(SIOAD0+1),BC
                      	;	LD	(SIOAD1+1),BC
                      	
  D1C6  21E8D4        		LD	HL,SIODATA
  D1C9                	SINIT1:
  D1C9  7E            		LD	A,(HL)
  D1CA  23            		INC	HL
  D1CB  FEFF          		CP	0FFH
  D1CD  2804          		JR	Z,SINIT2
  D1CF  ED79          		OUT	(C),A
  D1D1  18F6          		JR	SINIT1
  D1D3                	SINIT2:
  D1D3  3EE4          		LD	A,0E4H
  D1D5  CDF9E2        		CALL	COMOUT
  D1D8  3EC8          		LD	A,INTVEC-CPM_BOOT
  D1DA  CDD3E2        		CALL	OT49SB
                      	;
  D1DD  01C41F        		LD	BC,01FC4H
  D1E0  3E0C          		LD	A,00CH
  D1E2  ED79          		OUT	(C),A
                      	
  D1E4  0EC0          		LD	C,0C0H
  D1E6  ED71          		DB	0EDH,071H	;OUT (C),0	Z80未定義命令
                      	
  D1E8  0C            		INC	C
  D1E9  3E28          		LD	A,40
  D1EB  ED79          		OUT	(C),A
                      	
  D1ED  0C            		INC	C
  D1EE  ED71          		DB	0EDH,071H	;OUT (C),0	Z80未定義命令
                      	
  D1F0  0C            		INC	C
  D1F1  ED71          		DB	0EDH,071H	;OUT (C),0	Z80未定義命令
                      	
  D1F3  0EC5          		LD	C,0C5H
  D1F5  ED71          		DB	0EDH,071H	;OUT (C),0	Z80未定義命令
                      	
  D1F7                	TEXT:
  D1F7  0EB0          		LD	C,0B0H
  D1F9  3E80          		LD	A,080H
  D1FB  ED79          		OUT	(C),A
  D1FD  1607          		LD	D,7
  D1FF  0EB9          		LD	C,0B9H
  D201  21E1D4        		LD	HL,TEXTDT
  D204                	TEXT1:
  D204  04            		INC	B
  D205  EDA3          		OUTI
  D207  0C            		INC	C
  D208  15            		DEC	D
  D209  20F9          		JR	NZ,TEXT1
  D20B  01B01F        		LD	BC,01FB0H
  D20E  ED71          		DB	0EDH,071H	;OUT (C),0	Z80未定義命令
                      	
  D210  0EC4          		LD	C,0C4H
  D212  ED71          		DB	0EDH,071H	;OUT (C),0	Z80未定義命令
                      	
  D214  01011A        		LD	BC,01A01H
  D217  ED78          		IN	A,(C)
  D219  E608          		AND	8
  D21B  2809          		JR	Z,PRN
  D21D  0E03          		LD	C,003H
  D21F  3E0F          		LD	A,00FH
  D221  ED79          		OUT	(C),A
  D223  01040A        		LD	BC,00A04H
  D226                	PRN:
  D226  210000        		LD	HL,0
  D229  065C          		LD	B,05CH
  D22B  3E            		DB	03EH	;LD A,??
  D22C  FF            		RST	38H
  D22D  CD53E5        		CALL	FILL_MEMORY
  D230  06A4          		LD	B,0A4H
  D232  AF            		XOR	A
  D233  CD53E5        		CALL	FILL_MEMORY
                      	
  D236  3A87FF        		LD	A,(0FF87H)	;起動ドライブ
  D239  E66F          		AND	06FH
  D23B  FE08          		CP	8
  D23D  3801          		JR	C,INIDRV
  D23F  AF            		XOR	A
  D240                	INIDRV:
  D240  320400        		LD	(_DVSW),A	;カレントドライブ
                      	
  D243  3EC3          		LD	A,0C3H		;JP
  D245  2103F4        		LD	HL,CPM_WBOOT
  D248  320000        		LD	(00000H),A
  D24B  220100        		LD	(00001H),HL	;IPL
                      	
  D24E  2106D7        		LD	HL,BDOS
  D251  320500        		LD	(00005H),A
  D254  220600        		LD	(00006H),HL	;BDOS
                      	
  D257  212ADF        		LD	HL,BIOS
  D25A  221900        		LD	(00019H),HL	;BIOS-ROM
                      	
  D25D  21D9FF        		LD	HL,TRAP38	;TRAP38
  D260  323800        		LD	(00038H),A
  D263  223900        		LD	(00039H),HL	;RST 038H
                      	
  D266  3EF4          		LD	A,CPM_BOOT/256
  D268  320B00        		LD	(0000BH),A
                      	
  D26B  3E            		DB	03EH	;LD A,??
  D26C  E9            		JP	(HL)
  D26D  320F00        		LD	(0000FH),A
                      					;KEY
  D270  3EE6          		LD	A,0E6H
  D272  CDF9E2        		CALL	COMOUT
  D275  CDDEE2        		CALL	IN49SB
  D278  F5            		PUSH	AF
  D279  CDDEE2        		CALL	IN49SB
  D27C  F1            		POP	AF
  D27D  F5            		PUSH	AF
  D27E  E612          		AND	012H
  D280  2005          		JR	NZ,KEYR
  D282  3E01          		LD	A,1
  D284  32D8D3        		LD	(KEYREP_SWC),A
  D287                	KEYR:
  D287  F1            		POP	AF
  D288  E603          		AND	3
  D28A  280E          		JR	Z,NON
                      	
  D28C  01D03F        		LD	BC,03FD0H
  D28F  ED49          		OUT	(C),C
  D291  3E37          		LD	A,037H
  D293  D3D0          		OUT	(0D0H),A
  D295  ED78          		IN	A,(C)
  D297  B9            		CP	C
  D298  284B          		JR	Z,TURBO
  D29A                	NON:
  D29A  211BD5        		LD	HL,AT_SCR1
  D29D  1183E3        		LD	DE,SCR1
  D2A0  019400        		LD	BC,SCRNE-SCR1	;転送先のサイズ確認用
  D2A3  018500        		LD	BC,AT_SCRE-AT_SCR1
  D2A6  EDB0          		LDIR
                      	
  D2A8  21A0D5        		LD	HL,AT_DWT
  D2AB  11CEF2        		LD	DE,WTTRK
  D2AE  018C00        		LD	BC,DMAE-WTTRK	;転送先のサイズ確認用
  D2B1  018800        		LD	BC,AT_CPUE-AT_DWT
  D2B4  EDB0          		LDIR
                      	
  D2B6  21FEE3        		LD	HL,AT_WTTRK+AT_RS
  D2B9  22E9F4        		LD	(_WTTRK+1),HL
  D2BC  2114F3        		LD	HL,AT_DRD+AT_R
  D2BF  22ECF4        		LD	(_FDRD+1),HL
  D2C2  21CEF2        		LD	HL,AT_DWT+AT_R
  D2C5  22EFF4        		LD	(_FDWT+1),HL
  D2C8  2105E4        		LD	HL,AT_SCRN+AT_RS
  D2CB  22D1F4        		LD	(_SCRN+1),HL
                      	
  D2CE  3E27          		LD	A,027H			;ノンターボはMFM切り替えを行わない
  D2D0  3212F6        		LD	(_DEVICE+012H),A	;Aドライブ
  D2D3  3232F6        		LD	(_DEVICE+012H+32),A	;Bドライブ
  D2D6  3252F6        		LD	(_DEVICE+012H+32*2),A	;Cドライブ
  D2D9  3272F6        		LD	(_DEVICE+012H+32*3),A	;Dドライブ
                      	
  D2DC  210000        		LD	HL,0
  D2DF  2224E3        		LD	(X1PAT),HL
  D2E2  C36CD3        		JP	NOBANK
                      	
  D2E5                	TURBO:
  D2E5  F3            		DI			;Check BIOS
  D2E6  061D          		LD	B,01DH
  D2E8  ED79          		OUT	(C),A		;BIOS ON
  D2EA  3A512F        		LD	A,(02F51H)
  D2ED  04            		INC	B		;B=01EH
  D2EE  ED79          		OUT	(C),A		;BIOS OFF
  D2F0  FB            		EI
  D2F1  FEC9          		CP	0C9H
  D2F3  2802          		JR	Z,BIOSOK
  D2F5  1805          		JR	NOBIOS
  D2F7                	BIOSOK:
  D2F7  3EC3          		LD	A,0C3H		;JP
  D2F9  321800        		LD	(00018H),A
  D2FC                	NOBIOS:
  D2FC  3E1F          		LD	A,01FH		;スタートポート
  D2FE  DBF0          		IN	A,(0F0H)
  D300  0F            		RRCA
  D301  380B          		JR	C,CRT1
  D303  21D1D4        		LD	HL,_C8025H
  D306  11B0F4        		LD	DE,CRTCD
  D309  011000        		LD	BC,16
  D30C  EDB0          		LDIR
  D30E                	CRT1:
  D30E  3A8CFF        		LD	A,(0FF8CH)	;IPL DEVICE (0:2D/1:2DD/2:2HD)
  D311  D602          		SUB	2
  D313  2017          		JR	NZ,BANK
                      	
                      	;	XOR	A		;すでに0のハズ
  D315                	TZ1:				;IPL DEVICEが2HDの場合はMFMモードを2HDにしておく
  D315  F5            		PUSH	AF
  D316  CDDCF4        		CALL	_GETDPB
  D319  DD7E12        		LD	A,(IX+DPB_DEVICE)
  D31C  E68F          		AND	08FH
  D31E  FE87          		CP	087H		;フロッピーで切り替えがON
  D320  2004          		JR	NZ,TZ2
  D322  DDCB0A86      		RES	0,(IX+DPB_FDMODE)
  D326                	TZ2:
  D326  F1            		POP	AF
  D327  3C            		INC	A
  D328  FE08          		CP	8
  D32A  38E9          		JR	C,TZ1
                      	
  D32C                	BANK:
  D32C  01000B        		LD	BC,00B00H
  D32F  21007F        		LD	HL,07F00H
  D332  F3            		DI
  D333  ED69          		OUT	(C),L
  D335  3A0000        		LD	A,(0)
  D338  FEEB          		CP	0EBH
  D33A  2005          		JR	NZ,BANK1
  D33C  3E2B          		LD	A,02BH
  D33E  32B2F6        		LD	(BANKDV),A
  D341                	BANK1:
  D341  ED69          		OUT	(C),L
  D343  5E            		LD	E,(HL)
  D344  7B            		LD	A,E
  D345  C6A5          		ADD	A,0A5H
  D347  77            		LD	(HL),A
  D348  BE            		CP	(HL)
  D349  73            		LD	(HL),E
  D34A  2005          		JR	NZ,BANK2
  D34C  2C            		INC	L
  D34D  CB65          		BIT	4,L
  D34F  28F0          		JR	Z,BANK1
  D351                	BANK2:
  D351  3E10          		LD	A,010H
  D353  ED79          		OUT	(C),A
  D355  7D            		LD	A,L
  D356  B7            		OR	A
  D357  2813          		JR	Z,NOBANK
  D359  2600          		LD	H,0
  D35B  29            		ADD	HL,HL	;*2
  D35C  29            		ADD	HL,HL	;*4
  D35D  29            		ADD	HL,HL	;*8
  D35E  29            		ADD	HL,HL	;*16
  D35F  29            		ADD	HL,HL	;*32
  D360  2B            		DEC	HL	;-1
  D361  2B            		DEC	HL	;-2
  D362  2B            		DEC	HL	;-3
  D363  22A8F6        		LD	(BANKCL),HL
  D366  CD88D4        		CALL	CALC_FATLN
  D369  32A0F6        		LD	(BANKFL),A
  D36C                	NOBANK:
  D36C                	EMM:
  D36C  DD2180F6      		LD	IX,EMMFL
  D370  CD33D4        		CALL	EADR0
  D373  ED78          		IN	A,(C)
  D375  F5            		PUSH	AF
                      	
  D376  110000        		LD	DE,0
  D379                	ECHECK1:
  D379  13            		INC	DE
  D37A  CD3CD4        		CALL	EADRX
  D37D  ED60          		IN	H,(C)
  D37F  CD3CD4        		CALL	EADRX
  D382  7C            		LD	A,H
  D383  C6E5          		ADD	A,0E5H
  D385  ED79          		OUT	(C),A
  D387  3C            		INC	A
  D388  CD33D4        		CALL	EADR0
  D38B  ED79          		OUT	(C),A
  D38D  3D            		DEC	A
  D38E  CD3CD4        		CALL	EADRX
  D391  ED68          		IN	L,(C)
  D393  CD3CD4        		CALL	EADRX
  D396  ED61          		OUT	(C),H
  D398  BD            		CP	L
  D399  2004          		JR	NZ,ECHECK2
  D39B  CB5A          		BIT	3,D
  D39D  28DA          		JR	Z,ECHECK1
  D39F                	ECHECK2:
  D39F  CD33D4        		CALL	EADR0
  D3A2  F1            		POP	AF
  D3A3  ED79          		OUT	(C),A
  D3A5  FEEB          		CP	0EBH
  D3A7  2817          		JR	Z,EMM_BPB
  D3A9  DD360D02      		LD	(IX+DPB_MAXSEC),2	;BPBが512バイト目から始まる場合を調べる
  D3AD  CD33D4        		CALL	EADR0
  D3B0  ED78          		IN	A,(C)
  D3B2  DDBE06        		CP	(IX+DPB_FATID)
  D3B5  280D          		JR	Z,EMM_NOBPB
  D3B7  DD361226      		LD	(IX+DPB_DEVICE),026H	;BPBを使う
  D3BB  21F5FF        		LD	HL,0-11
  D3BE  180B          		JR	EMM_BPB1
  D3C0                	EMM_BPB:
  D3C0  DD361226      		LD	(IX+DPB_DEVICE),026H	;BPBを使う
  D3C4                	EMM_NOBPB:
  D3C4  DD360D00      		LD	(IX+DPB_MAXSEC),0
  D3C8  21F7FF        		LD	HL,0-9
  D3CB                	EMM_BPB1:
  D3CB  19            		ADD	HL,DE
  D3CC  3009          		JR	NC,NOEMM
  D3CE  2288F6        		LD	(EMMCL),HL
  D3D1  CD88D4        		CALL	CALC_FATLN
  D3D4  3280F6        		LD	(EMMFL),A
  D3D7                	NOEMM:
  D3D7  3E00          		LD	A,000H
  D3D8                	KEYREP_SWC	EQU	$-1
  D3D9  B7            		OR	A
  D3DA  2807          		JR	Z,KEYR1
  D3DC  010000        		LD	BC,0
  D3DF  ED438CF4      		LD	(_CTC),BC
  D3E3                	KEYR1:
  D3E3  CD69D4        		CALL	SETCRTC
  D3E6  0130F8        		LD	BC,0-80*25
  D3E9  2ABAF4        		LD	HL,(_PAGE_MINUS)
  D3EC  ED43BAF4      		LD	(_PAGE_MINUS),BC
  D3F0  1E0C          		LD	E,00CH
  D3F2  CDCDF4        		CALL	_PRINT
  D3F5  22BAF4        		LD	(_PAGE_MINUS),HL
                      	
  D3F8  21A4D4        		LD	HL,INIMES
  D3FB  CDA6DC        		CALL	MSX
                      	
  D3FE  F3            		DI
  D3FF  08            		EX	AF,AF'
  D400  2EFE          		LD	L,0-2		;CALLのスタック分減らす
  D402  39            		ADD	HL,SP
  D403  1100FF        		LD	DE,0FF00H
  D406  45            		LD	B,L
  D407  CD59DA        		CALL	ZERO_MEMORY_DE
  D40A  21CAFF        		LD	HL,EXTBIO
  D40D  36C9          		LD	(HL),0C9H	;RET
  D40F  23            		INC	HL
  D410  060E          		LD	B,TRAP38-EXTBIO-1
  D412  3E            		DB	03EH	;LD A,??
  D413  FF            		RST	38H
  D414  CD53E5        		CALL	FILL_MEMORY
  D417  21F4D4        		LD	HL,AT_TRAP38
  D41A  11D9FF        		LD	DE,TRAP38
  D41D  012700        		LD	BC,AT_TRAPE-AT_TRAP38
  D420  EDB0          		LDIR
  D422  08            		EX	AF,AF'
  D423  B7            		OR	A
  D424  C8            		RET	Z
                      	
  D425  3EE6          		LD	A,0E6H
  D427  CDF9E2        		CALL	COMOUT
  D42A  CDDEE2        		CALL	IN49SB
  D42D  CDDEE2        		CALL	IN49SB
  D430  FE1B          		CP	01BH
  D432  C9            		RET
                      	
  D433                	EADR0:
  D433  D5            		PUSH	DE
  D434  110000        		LD	DE,0
  D437  CD3CD4        		CALL	EADRX
  D43A  D1            		POP	DE
  D43B  C9            		RET
                      	
  D43C                	EADRX:
  D43C  F5            		PUSH	AF
  D43D  CD48DC        		CALL	EADR
  D440  F1            		POP	AF
  D441  C9            		RET
                      	
  D442                	CHKCTC:
  D442  C5            		PUSH	BC
  D443  110347        		LD	DE,04703H
  D446                	INICTC1:
  D446  0C            		INC	C
  D447  ED51          		OUT	(C),D
  D449  ED71          		DB	0EDH,071H	;OUT (C),0	Z80未定義命令
  D44B  1D            		DEC	E
  D44C  20F8          		JR	NZ,INICTC1
  D44E  C1            		POP	BC
                      	
  D44F  11FA07        		LD	DE,007FAH
  D452  ED51          		OUT	(C),D
  D454  ED59          		OUT	(C),E
  D456  ED78          		IN	A,(C)
  D458  BB            		CP	E
  D459  C0            		RET	NZ
  D45A  ED51          		OUT	(C),D
  D45C  ED51          		OUT	(C),D
  D45E  ED78          		IN	A,(C)
  D460  BA            		CP	D
  D461  C0            		RET	NZ
  D462  0C            		INC	C
  D463  0C            		INC	C
  D464  ED438CF4      		LD	(_CTC),BC
  D468  C9            		RET
                      	
  D469                	SETCRTC:
  D469  21B0F4        		LD	HL,CRTCD
  D46C  AF            		XOR	A
  D46D                	SETCRT1:
  D46D  010018        		LD	BC,01800H
  D470  ED79          		OUT	(C),A
  D472  0C            		INC	C
  D473  04            		INC	B
  D474  EDA3          		OUTI
  D476  3C            		INC	A
  D477  FE0C          		CP	12
  D479  20F2          		JR	NZ,SETCRT1
  D47B  23            		INC	HL
  D47C  23            		INC	HL
  D47D  01031B        		LD	BC,01A03H+00100H
  D480  EDA3          		OUTI
  D482  01D020        		LD	BC,01FD0H+00100H
  D485  EDA3          		OUTI
  D487  C9            		RET
                      	
  D488                	CALC_FATLN:	;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
  D488  5D            		LD	E,L
  D489  54            		LD	D,H
  D48A  29            		ADD	HL,HL	;*2
  D48B  19            		ADD	HL,DE	;*3
  D48C  CB3C          		SRL	H	;/2
  D48E  CB1D          		RR	L	;1クラスタ辺り1.5バイト必要
  D490  11FF01        		LD	DE,511	;切り上げる
  D493  19            		ADD	HL,DE
  D494  7C            		LD	A,H
  D495  CB3F          		SRL	A
  D497  C9            		RET
                      	
  D498  4155544F455845	AUTOD:	DB	"AUTOEXEC "
  D4A1  413A00        	AUTODV:	DB	"A:",0
                      	
  D4A4  4C53582D446F64	INIMES:	DB	"LSX-Dodgers for X1/turbo version "
  D4C5  312E          		DB	030H + VER_1, '.'
  D4C7  3631          		DB	030H + VER_2 ,030H + VER_3
  D4C9                		DB	''
  D4C9  2047616B750D0A		DB	" Gaku",0DH,0AH
  D4D0  00            		DB	0
                      	
  D4D1                	_C8025H:
  D4D1  6B5059881B0019		DB	06BH,050H,059H,088H,01BH,000H,019H,01AH
  D4D9  000F          		DB	000H,00FH
  D4DB  80F8B0FF      		DW	0-80*LINE,0-80
  D4DF  0C23          		DB	00CH,023H
                      	
  D4E1  030C0F30333C3F	TEXTDT:	DB	003H,00CH,00FH,030H,033H,03CH,03FH
                      	
  D4E8                	SIODATA:
  D4E8  18            		DB	018H
  D4E9  0100          		DB	1,0
  D4EB  0200          		DB	2,0
  D4ED  03C1          		DB	3,0C1H
  D4EF  0444          		DB	4,044H
  D4F1  05E8          		DB	5,0E8H
  D4F3  FF            		DB	0FFH
                      	
  D4F4                	AT_TRAP38:
  D4F4  210000        		LD	HL,0
  D4F7  E3            		EX	(SP),HL
  D4F8  3E24          		LD	A,'$'
  D4FA  CDA8DF        		CALL	MSG_A
  D4FD  2B            		DEC	HL
  D4FE  7C            		LD	A,H
  D4FF  CDE8FF        		CALL	PRHX+AT_RT
  D502  7D            		LD	A,L
  D503                	PRHX:
  D503  F5            		PUSH	AF
  D504  07            		RLCA
  D505  07            		RLCA
  D506  07            		RLCA
  D507  07            		RLCA
  D508  CDF1FF        		CALL	PRHX2+AT_RT
  D50B  F1            		POP	AF
  D50C                	PRHX2:
  D50C  E60F          		AND	00FH
  D50E  FE0A          		CP	10
  D510  3F            		CCF
  D511  CE30          		ADC	A,'0'
  D513  27            		DAA
  D514  C3A8DF        		JP	MSG_A
  D517                		DS	4
  D51B                	AT_TRAPE:
                      	
                      	;X1CPU.ASM
                      	
                      	;	LSX-Dodgers CPU
                      	;	X1/turbo/Z
                      	
                      	;	ノンターボ用パッチ
                      	;	DMAを使って転送している部分をCPUに差し替える
                      	
  D51B                	AT_SCR1:
  D51B  D9            		EXX
  D51C  C5            		PUSH	BC
  D51D  ED4BB1F4      		LD	BC,(_WIDTH)
  D521  0620          		LD	B,020H
  D523  D9            		EXX
  D524  C5            		PUSH	BC
  D525  010020        		LD	BC,02000H
                      	
  D528  67            		LD	H,A
  D529  B7            		OR	A
  D52A                	AT_SCRUP1:
  D52A  2815          		JR	Z,AT_SCRCL
  D52C  C5            		PUSH	BC
  D52D  CBE0          		SET	4,B
  D52F  D9            		EXX
  D530  C5            		PUSH	BC
  D531  CBE0          		SET	4,B
  D533  D9            		EXX
  D534  CDB4E3        		CALL	AT_UPSUB+AT_RS
  D537  D9            		EXX
  D538  C1            		POP	BC
  D539  D9            		EXX
  D53A  C1            		POP	BC
  D53B  CDB4E3        		CALL	AT_UPSUB+AT_RS
  D53E  25            		DEC	H
  D53F  18E9          		JR	AT_SCRUP1
                      	
  D541                	AT_SCRCL:
  D541  2AB1F4        		LD	HL,(_WIDTH)
  D544  CD4CE2        		CALL	LINECL
  D547  C1            		POP	BC
  D548  D9            		EXX
  D549  C1            		POP	BC
  D54A  D9            		EXX
  D54B  C9            		RET
                      	
  D54C                	AT_UPSUB:
  D54C  3AB1F4        		LD	A,(_WIDTH)
  D54F  6F            		LD	L,A
  D550                	AT_UPSUB1:
  D550  D9            		EXX
  D551  ED78          		IN	A,(C)
  D553  03            		INC	BC
  D554  D9            		EXX
  D555  ED79          		OUT	(C),A
  D557  03            		INC	BC
  D558  2D            		DEC	L
  D559  20F5          		JR	NZ,AT_UPSUB1
  D55B  C9            		RET
                      	
                      	;	FLOPPY DISK DRIVER(CPU)
                      	
  D55C                	DISKC:
  D55C  1B            		DEC	DE
  D55D  CB5F          		BIT	3,A
  D55F  C4C7F2        		CALL	NZ,RNF
  D562                	DISKD:
  D562  E5            		PUSH	HL
  D563  21CDF2        		LD	HL,RETRY
  D566  35            		DEC	(HL)
  D567  E1            		POP	HL
  D568  200C          		JR	NZ,AT_ERR		;Retry
  D56A  B7            		OR	A
  D56B  2809          		JR	Z,AT_ERR		;Error
                      	
  D56D                	AT_DELP:
  D56D  CDC7F2        		CALL	RNF
  D570  CD9FF2        		CALL	FDMOFF
  D573  3EFF          		LD	A,0FFH
  D575                	AT_ERRZ:
  D575  BF            		CP	A
  D576                	AT_ERR:
  D576  3EFF          		LD	A,0FFH
  D578  C9            		RET
  D579                	ERRW:
  D579  3EFF          		LD	A,0FFH
  D57B  BF            		CP	A
  D57C  37            		SCF
  D57D  C39FF2        		JP	FDMOFF
                      	
  D580                	ERRDW:
  D580  D1            		POP	DE
  D581  CDD5E3        		CALL	AT_DELP+AT_RS
  D584  C2DCF2        		JP	NZ,DWT0+AT_R
  D587  B7            		OR	A
  D588  20EF          		JR	NZ,ERRW
  D58A  C9            		RET
                      	
  D58B                	ERRDR:
  D58B  D1            		POP	DE
  D58C  CDD5E3        		CALL	AT_DELP+AT_RS
  D58F  C222F3        		JP	NZ,DRD0+AT_R
  D592  B7            		OR	A
  D593  20E4          		JR	NZ,ERRW
  D595  C9            		RET
                      	
  D596                	AT_WTTRK:
  D596  0601          		LD	B,1
  D598  3EF4          		LD	A,0F4H		;FDC TypeIIIコマンド Write Track
  D59A  C3D0F2        		JP	AT_WTTRK1+AT_R
                      	
  D59D                	AT_SCRN:
  D59D  ED78          		IN	A,(C)
  D59F  C9            		RET
  D5A0                	AT_SCRE:
                      	
  D5A0                	AT_DWT:
  D5A0  3EA0          		LD	A,0A0H		;FDC TypeIIコマンド Write Sector
  D5A2                	AT_WTTRK1:
  D5A2  3264F2        		LD	(FDCSWC),A
  D5A5                	DWTBL:
  D5A5  78            		LD	A,B
  D5A6  3210F3        		LD	(AT_WTB+1+AT_R),A
  D5A9  3E02          		LD	A,2		;Retry count
  D5AB  32CDF2        		LD	(RETRY),A
  D5AE                	DWT0:
  D5AE  D5            		PUSH	DE
  D5AF  E5            		PUSH	HL
  D5B0  CD07F2        		CALL	SEEK		;Write disk
  D5B3  E1            		POP	HL
  D5B4  DAE8E3        		JP	C,ERRDW+AT_RS
  D5B7  F3            		DI
  D5B8  CDACF2        		CALL	SECSET_FDCCMD
  D5BB  0EFB          		LD	C,0FBH		;MB8877A データレジスタ
  D5BD                	DWT1:
  D5BD  56            		LD	D,(HL)
  D5BE                	DWT2:
  D5BE  78            		LD	A,B
  D5BF  DBF8          		IN	A,(0F8H)	;MB8877A ステータス／コマンドレジスタ
  D5C1  0F            		RRCA
  D5C2  3008          		JR	NC,DWT4
  D5C4  0F            		RRCA
  D5C5  30F7          		JR	NC,DWT2
  D5C7                	DWT3:
  D5C7  ED51          		OUT	(C),D
  D5C9  23            		INC	HL
  D5CA  18F1          		JR	DWT1
                      	
  D5CC                	DWT4:
  D5CC  3D            		DEC	A
  D5CD  28F8          		JR	Z,DWT3
  D5CF  3C            		INC	A
  D5D0  FB            		EI
  D5D1  D1            		POP	DE
  D5D2  13            		INC	DE
  D5D3  CD9FF2        		CALL	FDMOFF
  D5D6  2809          		JR	Z,DISKOK_WT
  D5D8  CDC4E3        		CALL	DISKC+AT_RS
  D5DB  20D1          		JR	NZ,DWT0
  D5DD  B7            		OR	A
  D5DE  C2E1E3        		JP	NZ,ERRW+AT_RS
                      	
  D5E1                	DISKOK_WT:
  D5E1  0601          	AT_WTB:	LD	B,1
  D5E3  10C0          		DJNZ	DWTBL
  D5E5  C9            		RET
                      	
  D5E6                	AT_DRD:
  D5E6  3E80          		LD	A,080H		;FDC TypeIIコマンド Read Sector
  D5E8  3264F2        		LD	(FDCSWC),A
  D5EB                	DRDBL:
  D5EB  78            		LD	A,B
  D5EC  3252F3        		LD	(AT_RDB+1+AT_R),A
  D5EF  3E02          		LD	A,2		;Retry count
  D5F1  32CDF2        		LD	(RETRY),A
  D5F4                	DRD0:
  D5F4  D5            		PUSH	DE
  D5F5  E5            		PUSH	HL
  D5F6  CD07F2        		CALL	SEEK		;Read disk
  D5F9  E1            		POP	HL
  D5FA  DAF3E3        		JP	C,ERRDR+AT_RS
  D5FD  F3            		DI
  D5FE  CDACF2        		CALL	SECSET_FDCCMD
  D601  0EFB          		LD	C,0FBH		;MB8877A データレジスタ
  D603                	DRD1:
  D603  78            		LD	A,B
  D604  DBF8          		IN	A,(0F8H)	;MB8877A ステータス／コマンドレジスタ
  D606  0F            		RRCA
  D607  3008          		JR	NC,DRD3
  D609  0F            		RRCA
  D60A  30F7          		JR	NC,DRD1
  D60C  EDA2          		INI
  D60E  04            		INC	B
  D60F  18F2          		JR	DRD1
                      	
  D611                	DRD3:
  D611  B7            		OR	A
  D612  FB            		EI
  D613  D1            		POP	DE
  D614  13            		INC	DE
  D615  CD9FF2        		CALL	FDMOFF
  D618  2809          		JR	Z,DISKOK_RD
  D61A  CDC4E3        		CALL	DISKC+AT_RS
  D61D  20D5          		JR	NZ,DRD0
  D61F  B7            		OR	A
  D620  C2E1E3        		JP	NZ,ERRW+AT_RS
                      	
  D623                	DISKOK_RD:
  D623  0601          	AT_RDB:	LD	B,1
  D625  10C4          		DJNZ	DRDBL
  D627  C9            		RET
                      	
  D628                	AT_CPUE:
                      	
  2AE5                	AT_RT	EQU	TRAP38-AT_TRAP38
                      	
  D628                	INITE:
  D628                		DS	BDOS-INITE
  D706  C366DC        		JP	BDOS0
                      	
                      	;X1CCP.ASM
                      	
                      	;	LSX-Dodgers CCP
                      	;	X1/turbo/Z
                      	
  D709                	WBOOT1:
  D709  F3            		DI
  D70A  ED7B0600      		LD	SP,(SYSTEM+1)
                      	
  D70E  3EF4          		LD	A,INTVEC/256
  D710  ED47          		LD	I,A
                      	
  D712  3EE4          		LD	A,0E4H
  D714  CDF9E2        		CALL	COMOUT
  D717  3EC8          		LD	A,INTVEC-CPM_BOOT
  D719  CDD3E2        		CALL	OT49SB
                      	
  D71C  21B0F4        		LD	HL,CRTCD
  D71F  AF            		XOR	A
  D720                	SETCRT2:
  D720  010018        		LD	BC,01800H
  D723  ED79          		OUT	(C),A
  D725  0C            		INC	C
  D726  56            		LD	D,(HL)
  D727  FE0D          		CP	13
  D729  3802          		JR	C,SETCRT3
  D72B  1600          		LD	D,0
  D72D                	SETCRT3:
  D72D  ED51          		OUT	(C),D
  D72F  23            		INC	HL
  D730  3C            		INC	A
  D731  FE0E          		CP	14
  D733  20EB          		JR	NZ,SETCRT2
                      	
  D735  01031B        		LD	BC,01A03H+00100H
  D738  EDA3          		OUTI
  D73A  01D020        		LD	BC,01FD0H+00100H
  D73D  EDA3          		OUTI
  D73F  2192F4        		LD	HL,_KEYD
  D742  7E            		LD	A,(HL)
  D743  3600          		LD	(HL),0
  D745  CD95DF        		CALL	KEYBC_IFBREAK
  D748  3E04          		LD	A,4
  D74A  CDA8DF        		CALL	MSG_A
                      	
                      	;LDCCP.ASM
                      	
                      	;	LSX-Dodgers CCP
                      	
  D74D                	COMMAND:
  D74D  3ABBF3        		LD	A,(FCB_BAT)
  D750  B7            		OR	A
  D751  C293D8        		JP	NZ,C_BAT1
  D754  CD07D8        		CALL	SETDTA1
  D757  3A0400        		LD	A,(_DVSW)
  D75A  C641          		ADD	A,'A'
  D75C  CDA8DF        		CALL	MSG_A
  D75F  3E3E          		LD	A,'>'
  D761  CDA8DF        		CALL	MSG_A
  D764  3E50          		LD	A,80
  D766  12            		LD	(DE),A
  D767  CD29E0        		CALL	_SYS0A		;(BDOS)文字列入力
  D76A  CD88D9        		CALL	LTNL
  D76D                	COMMAND2:
  D76D  118200        		LD	DE,DTA1+2
  D770  CDFDF4        		CALL	_COMANL
  D773  30D8          		JR	NC,COMMAND
  D775  1179F4        		LD	DE,COMERM
  D778  CD97DC        		CALL	_SYS09		;(BDOS)文字列出力
  D77B  C7            		RST	0
                      	
  D77C                	COMANL:
  D77C  CDA7E4        		CALL	FILE
  D77F  3A19F4        		LD	A,(FNAME+4)
  D782  FE20          		CP	020H
  D784  201C          		JR	NZ,COMB2
  D786  D5            		PUSH	DE
  D787  1115F4        		LD	DE,FNAME
  D78A  1A            		LD	A,(DE)
  D78B  FE20          		CP	020H
  D78D  2844          		JR	Z,SDVSW
  D78F  1B            		DEC	DE
  D790  1A            		LD	A,(DE)
  D791  C6FF          		ADD	A,0FFH
  D793  3809          		JR	C,COMB
  D795  13            		INC	DE
                      	
  D796  2145DB        		LD	HL,COMTB
  D799  0608          		LD	B,COMS
  D79B  CD36E7        		CALL	CPNAME
  D79E                	COMB:
  D79E  D1            		POP	DE
  D79F  D20F00        		JP	NC,JP_HL
  D7A2                	COMB2:
  D7A2  EB            		EX	DE,HL
  D7A3  2270D8        		LD	(COMSWC),HL
  D7A6  F5            		PUSH	AF
  D7A7  CD28D8        		CALL	CEXE4
  D7AA  F1            		POP	AF
  D7AB  2115F4        		LD	HL,FNAME
  D7AE  116D00        		LD	DE,FCB2FN	;COMMAND NAME
  D7B1  010B00        		LD	BC,11
  D7B4  EDB0          		LDIR
  D7B6  115AF3        		LD	DE,PATHD
  D7B9                	CEX1:
  D7B9  1A            		LD	A,(DE)
  D7BA  FE20          		CP	020H
  D7BC  D8            		RET	C
  D7BD  CD9CE4        		CALL	FILEC
  D7C0  D5            		PUSH	DE
  D7C1  216D00        		LD	HL,FCB2FN	;COMMAND NAME
  D7C4  1115F4        		LD	DE,FNAME
  D7C7  010B00        		LD	BC,11
  D7CA  EDB0          		LDIR
  D7CC  CD28D8        		CALL	CEXE4
  D7CF  D1            		POP	DE
  D7D0  13            		INC	DE
  D7D1  18E6          		JR	CEX1
                      	
  D7D3                	SDVSW:
  D7D3  F1            		POP	AF
  D7D4  3A14F4        		LD	A,(FDRV)
  D7D7  3D            		DEC	A
  D7D8  5F            		LD	E,A
  D7D9  0E0E          		LD	C,00EH		;(BDOS)カレントドライブの設定
  D7DB  1831          		JR	SYSTEM0
                      	
  D7DD                	OPEN1:
  D7DD  2114F4        		LD	HL,FDRV
  D7E0                	OPEN:
  D7E0  0E11          		LD	C,011H		;(BDOS)ファイルの検索
  D7E2                	OPEN3:
  D7E2  D5            		PUSH	DE
  D7E3  1196F3        		LD	DE,DTA_CCP
  D7E6  CD04D8        		CALL	SETDTA
  D7E9  EB            		EX	DE,HL
  D7EA  CD0ED8        		CALL	SYSTEM0
  D7ED  D1            		POP	DE
  D7EE  C9            		RET
                      	
  D7EF                	OPEN2:
  D7EF  0E12          		LD	C,012H
  D7F1  18EF          		JR	OPEN3
                      	
  D7F3                	DEFCB:				;Z=Ok NZ=Error
  D7F3  1196F3        		LD	DE,DTA_CCP
  D7F6  CD0CD8        		CALL	SYSC0F
                      	
  D7F9  11B7F3        		LD	DE,DTA_CCP+33	;(FCB)ランダムレコード
  D7FC  0604          		LD	B,4
  D7FE  CD59DA        		CALL	ZERO_MEMORY_DE
  D801                	SETDTA100:
  D801  110001        		LD	DE,00100H
  D804                	SETDTA:
  D804  C36ADE        		JP	_SYS1A		;(BDOS)DTAの設定
                      	
  D807                	SETDTA1:
  D807  118000        		LD	DE,DTA1
  D80A  18F8          		JR	SETDTA
                      	
  D80C                	SYSC0F:
  D80C  0E0F          		LD	C,00FH		;(BDOS)ファイルのオープン
  D80E                	SYSTEM0:
  D80E  CD0500        		CALL	SYSTEM
  D811  B7            		OR	A
  D812  C9            		RET
                      	
  D813                	C_CD:
  D813  0E5A          		LD	C,05AH
  D815  18F7          		JR	SYSTEM0
                      	
  D817                	S27BUF:
  D817  2100FE        		LD	HL,0-00200H	;スクラッチエリア(0100H)+スタック予備(0100H)
  D81A  39            		ADD	HL,SP
  D81B  2E00          		LD	L,0
  D81D  7C            		LD	A,H
  D81E  E6F8          		AND	0F8H
  D820  67            		LD	H,A
  D821                	S27DTA:
  D821  1196F3        		LD	DE,DTA_CCP
  D824                	S27:
  D824  0E27          		LD	C,027H		;(BDOS)ランダムブロック読み込み
  D826  18E6          		JR	SYSTEM0
                      	
  D828                	CEXE4:
  D828  211DF4        		LD	HL,FNAME+8
  D82B  7E            		LD	A,(HL)
  D82C  FE20          		CP	020H
  D82E  2007          		JR	NZ,CEXE7
  D830  3E3F          		LD	A,'?'
  D832  77            		LD	(HL),A
  D833  23            		INC	HL
  D834  77            		LD	(HL),A
  D835  23            		INC	HL
  D836  77            		LD	(HL),A
  D837                	CEXE7:
  D837  CDDDD7        		CALL	OPEN1
  D83A                	CEXE5:
  D83A  C0            		RET	NZ
  D83B  2AA0F3        		LD	HL,(DTA_CCP+1+9)
  D83E  7C            		LD	A,H
  D83F  CDBEE7        		CALL	CAP
  D842  67            		LD	H,A
  D843  7D            		LD	A,L
  D844  CDBEE7        		CALL	CAP
  D847  6F            		LD	L,A
  D848  3A9FF3        		LD	A,(DTA_CCP+1+8)
  D84B  CDBEE7        		CALL	CAP
  D84E  D642          		SUB	'B'
  D850  282C          		JR	Z,C_BAT
  D852  3D            		DEC	A		;'C'
  D853  2805          		JR	Z,C_EXE
  D855                	CEXE6:
  D855  CDEFD7        		CALL	OPEN2
  D858  18E0          		JR	CEXE5
                      	
  D85A                	C_EXE:
  D85A  7C            		LD	A,H
  D85B  FE4D          		CP	'M'
  D85D  20F6          		JR	NZ,CEXE6
                      	
  D85F  CDF3D7        		CALL	DEFCB
  D862  CD17D8        		CALL	S27BUF
  D865  3D            		DEC	A
  D866  37            		SCF
  D867  C0            		RET	NZ
  D868  7C            		LD	A,H
  D869  B5            		OR	L
  D86A  37            		SCF
  D86B  C8            		RET	Z
  D86C  CD07D8        		CALL	SETDTA1
  D86F  110000        		LD	DE,0				; self-modifying code
  D870                	COMSWC	EQU	$-2
  D872  ED7B0600      		LD	SP,(SYSTEM+1)
  D876  67            		LD	H,A				; A=0 in SETDTA1(_SYS1A)
  D877  6F            		LD	L,A
  D878  E5            		PUSH	HL				; push $0000 (reboot address)
  D879  24            		INC	H
  D87A  E5            		PUSH	HL				; push $0100 (TPA address)
  D87B  C324DA        		JP	SETFCB				; and JP $0100
                      	
  D87E                	C_BAT:
  D87E  114154        		LD	DE,'A'+'T'*256
  D881  ED52          		SBC	HL,DE
  D883  20D0          		JR	NZ,CEXE6
                      	
  D885  CDF3D7        		CALL	DEFCB
                      	
  D888  2196F3        		LD	HL,DTA_CCP
  D88B  11BBF3        		LD	DE,FCB_BAT
  D88E  012500        		LD	BC,37
  D891  EDB0          		LDIR
  D893                	C_BAT1:
  D893  CD01D8        		CALL	SETDTA100
  D896  CDCAD8        		CALL	FGETC_BAT
  D899  218100        		LD	HL,DTA1+1
  D89C  2025          		JR	NZ,END_BATCH
  D89E  FE21          		CP	021H		;スペースや改行など制御文字を飛ばす
  D8A0  38F1          		JR	C,C_BAT1
  D8A2  3620          		LD	(HL),' '
  D8A4  23            		INC	HL
  D8A5                	C_BAT2:
  D8A5  77            		LD	(HL),A
  D8A6  23            		INC	HL
  D8A7  7D            		LD	A,L
  D8A8  3C            		INC	A		;L==0FFH
  D8A9  2809          		JR	Z,RUN_BATCH
  D8AB  CDCAD8        		CALL	FGETC_BAT
  D8AE  2004          		JR	NZ,RUN_BATCH
  D8B0  FE20          		CP	020H
  D8B2  30F1          		JR	NC,C_BAT2
  D8B4                	RUN_BATCH:
  D8B4  7D            		LD	A,L
  D8B5  D67F          		SUB	DTA1-1
  D8B7  328000        		LD	(DTA1),A
  D8BA  FE04          		CP	4
  D8BC  3805          		JR	C,END_BATCH
  D8BE  3600          		LD	(HL),0
  D8C0  C36DD7        		JP	COMMAND2
  D8C3                	END_BATCH:
  D8C3  AF            		XOR	A		;バッチファイルを閉じる
  D8C4  32BBF3        		LD	(FCB_BAT),A
  D8C7  C300F4        		JP	CPM_BOOT
                      	
  D8CA                	FGETC_BAT:
  D8CA  11BBF3        		LD	DE,FCB_BAT
  D8CD                	FGETC:				;1文字ずつ読み込む
  D8CD  E5            		PUSH	HL		;Z:成功
  D8CE  210100        		LD	HL,1
  D8D1  CD24D8        		CALL	S27
  D8D4  E1            		POP	HL
  D8D5  3A0001        		LD	A,(00100H)
  D8D8  C9            		RET
                      	
  D8D9                	C_DEL:
  D8D9  CD24DA        		CALL	SETFCB
  D8DC  CDBEDF        		CALL	_SYS08		;(BDOS)エコーなしコンソール入力
                      	
  D8DF  0E13          		LD	C,013H
  D8E1  180A          		JR	CDEL1		;(BDOS)ファイルの削除
                      	
  D8E3                	C_REN:
  D8E3  CD24DA        		CALL	SETFCB
  D8E6  3E10          		LD	A,010H		;ディレクトリも対象にする
  D8E8  326900        		LD	(FCB1+13),A	;属性
  D8EB  0E17          		LD	C,017H		;(BDOS)ファイル名の変更
  D8ED                	CDEL1:
  D8ED  115C00        		LD	DE,FCB1
  D8F0  CD0500        		CALL	SYSTEM
  D8F3  C6FF          		ADD	A,0FFH
  D8F5  C9            		RET
                      	
  D8F6                	C_DIR:
  D8F6  CD9CE4        		CALL	FILEC
  D8F9  2115F4        		LD	HL,FDRV+1
  D8FC  CD3ADB        		CALL	CWILD1
  D8FF  3EF1          		LD	A,0F1H
  D901  3221F4        		LD	(FDRV+13),A
  D904  CDDDD7        		CALL	OPEN1
  D907                	CDIR1:
  D907  B7            		OR	A
  D908  2008          		JR	NZ,PDSKF
  D90A  CD55D9        		CALL	P_NAME
  D90D  CDEFD7        		CALL	OPEN2
  D910  18F5          		JR	CDIR1
  D912                	PDSKF:
  D912  3A14F4        		LD	A,(FDRV)
  D915  5F            		LD	E,A
  D916  0E1B          		LD	C,01BH		;(BDOS)ディスク情報の獲得
  D918  CD0500        		CALL	SYSTEM
  D91B  4F            		LD	C,A		;C←1クラスタ辺りの論理セクタ数
  D91C  C601          		ADD	A,001H
  D91E  D8            		RET	C		;Aが0FFHだった場合
  D91F  3E06          		LD	A,8-2
  D921                	PDS1:				;HL=未使用クラスタの総数
  D921  3C            		INC	A
  D922  CB19          		RR	C
  D924  30FB          		JR	NC,PDS1
  D926                	PDS2:				;B←論理セクタのサイズの上位8ビット
  D926  3C            		INC	A
  D927  CB18          		RR	B
  D929  30FB          		JR	NC,PDS2
  D92B  47            		LD	B,A
                      	
  D92C  110000        		LD	DE,0
  D92F                	PDS3:
  D92F  29            		ADD	HL,HL
  D930  EB            		EX	DE,HL
  D931  ED6A          		ADC	HL,HL
  D933  EB            		EX	DE,HL
  D934  10F9          		DJNZ	PDS3
  D936                	PDSKF1:
  D936  CDC2D9        		CALL	PRDEC_DEHL
  D939  11EBF3        		LD	DE,FREE
  D93C  CD97DC        		CALL	_SYS09		;(BDOS)文字列出力
  D93F  CDAFD9        		CALL	PUTDRV
  D942  3E5C          		LD	A,05CH		;\
  D944  CDA8DF        		CALL	MSG_A
  D947  2A22F4        		LD	HL,(FDRV+14)	;ディレクトリのクラスタ番号
  D94A  AF            		XOR	A
  D94B  11FEFF        		LD	DE,0-2
  D94E  19            		ADD	HL,DE
  D94F  23            		INC	HL
  D950  DCBFD9        		CALL	C,PRDEC_HL
  D953  1833          		JR	LTNL
                      	
  D955                	P_NAME:
  D955  3A97F3        		LD	A,(DTA_CCP+1)
  D958  FE2E          		CP	'.'
  D95A  C8            		RET	Z
                      	
  D95B  3AA2F3        		LD	A,(DTA_CCP+1+00BH)
  D95E  F5            		PUSH	AF
  D95F  CB67          		BIT	4,A
  D961  2808          		JR	Z,DIR3
  D963  11E0F3        		LD	DE,DIRMES
  D966  CD97DC        		CALL	_SYS09		;(BDOS)文字列出力
  D969  180A          		JR	DIR6
  D96B                	DIR3:
  D96B  ED5BB5F3      		LD	DE,(DTA_CCP+1+01EH)
  D96F  2AB3F3        		LD	HL,(DTA_CCP+1+01CH)
  D972  CDC2D9        		CALL	PRDEC_DEHL
  D975                	DIR6:
  D975  F1            		POP	AF
  D976  0F            		RRCA
  D977  9F            		SBC	A,A
  D978  E60A          		AND	'*'-020H
  D97A  C620          		ADD	A,020H
  D97C  CDA8DF        		CALL	MSG_A
  D97F  CDAFD9        		CALL	PUTDRV
  D982  2197F3        		LD	HL,DTA_CCP+1
  D985  CD02DA        		CALL	FPRNT
                      	
  D988                	LTNL:
  D988  1E03          		LD	E,3
  D98A  C3CDF4        		JP	_PRINT
                      	
  D98D                	C_PATH:
  D98D  CD7EE5        		CALL	SPCUT
  D990  215AF3        		LD	HL,PATHD
  D993  FE21          		CP	021H
  D995  300C          		JR	NC,CPATH0
  D997                	CPATHP:
  D997  7E            		LD	A,(HL)
  D998  23            		INC	HL
  D999  FE20          		CP	020H
  D99B  3F            		CCF
  D99C  30EA          		JR	NC,LTNL
  D99E  CDA8DF        		CALL	MSG_A
  D9A1  18F4          		JR	CPATHP
  D9A3                	CPATH0:
  D9A3  FE3B          		CP	';'
  D9A5  2001          		JR	NZ,CPATH1
  D9A7  13            		INC	DE
  D9A8                	CPATH1:
  D9A8  EB            		EX	DE,HL
  D9A9  013B00        		LD	BC,PATHX
  D9AC  EDB0          		LDIR
  D9AE  C9            		RET
                      	
  D9AF                	PUTDRV:
  D9AF  3A14F4        		LD	A,(FDRV)
  D9B2  CDB1E5        		CALL	GETDRV1
  D9B5  C641          		ADD	A,'A'
  D9B7  CDA8DF        		CALL	MSG_A
  D9BA  3E3A          		LD	A,':'
  D9BC                	MSG_AR:
  D9BC  C3A8DF        		JP	MSG_A
                      	
  D9BF                	PRDEC_HL:
  D9BF  AF            		XOR	A
  D9C0  5F            		LD	E,A
  D9C1  57            		LD	D,A
  D9C2                	PRDEC_DEHL:
  D9C2  D5            		PUSH	DE
  D9C3  110FF4        		LD	DE,DECBF
  D9C6  0605          		LD	B,5
  D9C8  CD59DA        		CALL	ZERO_MEMORY_DE	;A=0
  D9CB  D1            		POP	DE
                      	
  D9CC  0E20          		LD	C,32
  D9CE                	DEC1:
  D9CE  29            		ADD	HL,HL
  D9CF  EB            		EX	DE,HL
  D9D0  ED6A          		ADC	HL,HL
  D9D2  EB            		EX	DE,HL
  D9D3  E5            		PUSH	HL
  D9D4  2113F4        		LD	HL,DECBF+4
  D9D7  0605          		LD	B,5
  D9D9                	DEC2:
  D9D9  7E            		LD	A,(HL)
  D9DA  8F            		ADC	A,A
  D9DB  27            		DAA
  D9DC  77            		LD	(HL),A
  D9DD  2B            		DEC	HL
  D9DE  10F9          		DJNZ	DEC2
  D9E0  E1            		POP	HL
  D9E1  0D            		DEC	C
  D9E2  20EA          		JR	NZ,DEC1
                      	
  D9E4  210FF4        		LD	HL,DECBF
  D9E7  3E20          		LD	A,020H
  D9E9  0604          		LD	B,4
  D9EB                	DEC3:
  D9EB  CDF8D9        		CALL	DEC4
  D9EE  CDF8D9        		CALL	DEC4
  D9F1  23            		INC	HL
  D9F2  10F7          		DJNZ	DEC3
  D9F4                	DECX:
  D9F4  CDF8D9        		CALL	DEC4
  D9F7  AF            		XOR	A
  D9F8                	DEC4:
  D9F8  ED6F          		RLD
  D9FA  FE20          		CP	020H
  D9FC  2802          		JR	Z,DEC5
  D9FE  F630          		OR	030H
  DA00                	DEC5:
  DA00  18BA          		JR	MSG_AR
                      	
  DA02                	FPRNT:
  DA02  0608          		LD	B,8	;ファイル名を表示
  DA04  CD13DA        		CALL	P_N1
  DA07  7E            		LD	A,(HL)
  DA08  CDCAE7        		CALL	CAP3
  DA0B  D8            		RET	C	;拡張子が無い
                      	
  DA0C  3E2E          		LD	A,'.'
  DA0E  CDA8DF        		CALL	MSG_A
  DA11  0603          		LD	B,3	;拡張子を表示
  DA13                	P_N1:
  DA13  7E            		LD	A,(HL)
  DA14  CDCAE7        		CALL	CAP3
  DA17  3807          		JR	C,P_N2
  DA19  CDA8DF        		CALL	MSG_A
  DA1C  23            		INC	HL
  DA1D  10F4          		DJNZ	P_N1
  DA1F  C9            		RET
  DA20                	P_N2:
  DA20  23            		INC	HL
  DA21  10FD          		DJNZ	P_N2
  DA23  C9            		RET
                      	
  DA24                	SETFCB:
  DA24  CD7EE5        		CALL	SPCUT
  DA27  1A            		LD	A,(DE)
  DA28  FE20          		CP	020H
  DA2A  3801          		JR	C,SETFCBA
  DA2C  1B            		DEC	DE
  DA2D                	SETFCBA:
  DA2D  0624          		LD	B,36
  DA2F  215C00        		LD	HL,FCB1
  DA32  E5            		PUSH	HL
  DA33  AF            		XOR	A
  DA34  CD53E5        		CALL	FILL_MEMORY
  DA37  E1            		POP	HL
  DA38  D5            		PUSH	DE
  DA39  CDD1DE        		CALL	_SYS29		;(BDOS)ファイル名の解析
  DA3C  216C00        		LD	HL,FCB2
  DA3F  CDD1DE        		CALL	_SYS29		;(BDOS)ファイル名の解析
  DA42  E1            		POP	HL
  DA43  010050        		LD	BC,05000H
  DA46  118100        		LD	DE,00081H
  DA49                	SETFCB1:
  DA49  7E            		LD	A,(HL)
  DA4A  23            		INC	HL
  DA4B  FE20          		CP	020H
  DA4D  3805          		JR	C,SETFCB2
  DA4F  12            		LD	(DE),A
  DA50  13            		INC	DE
  DA51  0C            		INC	C
  DA52  10F5          		DJNZ	SETFCB1
  DA54                	SETFCB2:
  DA54  79            		LD	A,C
  DA55  328000        		LD	(DTA1),A
  DA58  04            		INC	B
  DA59                	ZERO_MEMORY_DE:
  DA59  AF            		XOR	A
  DA5A                	FILL_MEMORY_DE:
  DA5A  12            		LD	(DE),A
  DA5B  13            		INC	DE
  DA5C  10FC          		DJNZ	FILL_MEMORY_DE
  DA5E  C9            		RET
                      	
  DA5F                	C_COPY:
  DA5F  CD24DA        		CALL	SETFCB
                      	
  DA62  1161F4        		LD	DE,ZERO
  DA65  CD9FE4        		CALL	FILEC2
  DA68  216C00        		LD	HL,FCB2
  DA6B  CDD8DE        		CALL	S29X1
                      	
  DA6E  3E10          		LD	A,010H
  DA70  326900        		LD	(FCB1+13),A
  DA73  216D00        		LD	HL,FCB2FN
  DA76  CD3ADB        		CALL	CWILD1
  DA79                	COPY0:
  DA79  CD37DB        		CALL	CWILD
  DA7C  215C00        		LD	HL,FCB1
  DA7F  CDE0D7        		CALL	OPEN
  DA82  37            		SCF
  DA83                	COPY1:
  DA83  C0            		RET	NZ
  DA84  CDF3D7        		CALL	DEFCB
                      	
  DA87  3AA3F3        		LD	A,(DTA_CCP+13)
  DA8A  CB67          		BIT	4,A
  DA8C  2821          		JR	Z,COPY1A
                      	
  DA8E  215D00        		LD	HL,FCB1FN
  DA91  CDE2E8        		CALL	CHKWILD
  DA94  3814          		JR	C,COPY9
                      	
  DA96  3E20          		LD	A,020H
  DA98  325D00        		LD	(FCB1FN),A
  DA9B  2AB0F3        		LD	HL,(DTA_CCP+26)
  DA9E  23            		INC	HL
  DA9F  226A00        		LD	(FCB1+14),HL
  DAA2  18D5          		JR	COPY0
                      	
  DAA4                	COPY8:
  DAA4  CD97DC        		CALL	_SYS09		;(BDOS)文字列出力
  DAA7  CD88D9        		CALL	LTNL
  DAAA                	COPY9:
  DAAA  CDEFD7        		CALL	OPEN2
  DAAD  18D4          		JR	COPY1
                      	
  DAAF                	COPY1A:
  DAAF  216C00        		LD	HL,FCB2
  DAB2  1114F4        		LD	DE,FDRV
  DAB5  0198F3        		LD	BC,DTA_CCP+2
  DAB8  EDA0          		LDI
  DABA  3E0B          		LD	A,11
  DABC                	COPY2:
  DABC  F5            		PUSH	AF
  DABD  7E            		LD	A,(HL)
  DABE  FE3F          		CP	'?'
  DAC0  2001          		JR	NZ,COPY3
  DAC2  0A            		LD	A,(BC)
  DAC3                	COPY3:
  DAC3  12            		LD	(DE),A
  DAC4  03            		INC	BC
  DAC5  13            		INC	DE
  DAC6  23            		INC	HL
  DAC7  F1            		POP	AF
  DAC8  3D            		DEC	A
  DAC9  20F1          		JR	NZ,COPY2
  DACB  010500        		LD	BC,16-11
  DACE  EDB0          		LDIR
  DAD0                	PUTNAME:
  DAD0  215D00        		LD	HL,FCB1FN
  DAD3  CDE2E8        		CALL	CHKWILD
  DAD6  300B          		JR	NC,PUTN1
  DAD8  2115F4        		LD	HL,FDRV+1
  DADB  CD02DA        		CALL	FPRNT
  DADE  3E20          		LD	A,020H
  DAE0  CDA8DF        		CALL	MSG_A
  DAE3                	PUTN1:
  DAE3  1114F4        		LD	DE,FDRV
  DAE6  0E16          		LD	C,016H		;(BDOS)ファイルの作成
  DAE8  CD0ED8        		CALL	SYSTEM0
  DAEB  2048          		JR	NZ,COPYE2
  DAED  67            		LD	H,A		;A=0
  DAEE  6F            		LD	L,A
  DAEF  2235F4        		LD	(FDRV+33),HL	;(FCB)ランダムレコード
  DAF2  2237F4        		LD	(FDRV+35),HL
  DAF5                	COPY6:
  DAF5  CD17D8        		CALL	S27BUF
  DAF8  47            		LD	B,A
  DAF9  3C            		INC	A
  DAFA  2831          		JR	Z,COPYE
  DAFC  7C            		LD	A,H
  DAFD  B5            		OR	L
  DAFE  280C          		JR	Z,COPY7
  DB00  1114F4        		LD	DE,FDRV
  DB03  0E26          		LD	C,026H		;(BDOS)ランダムブロック書き込み
  DB05  CD0ED8        		CALL	SYSTEM0
  DB08  2023          		JR	NZ,COPYE
  DB0A  10E9          		DJNZ	COPY6
  DB0C                	COPY7:
  DB0C  3AA3F3        		LD	A,(DTA_CCP+13)	;(FCB)属性
  DB0F  3221F4        		LD	(FDRV+13),A
  DB12  21AAF3        		LD	HL,DTA_CCP+20	;(FCB)タイムスタンプ
  DB15  1128F4        		LD	DE,FDRV+20
  DB18  010400        		LD	BC,4
  DB1B  EDB0          		LDIR
                      	
  DB1D  1114F4        		LD	DE,FDRV
  DB20  0E10          		LD	C,010H		;(BDOS)ファイルのクローズ
  DB22  CD0ED8        		CALL	SYSTEM0
  DB25  2006          		JR	NZ,COPYE
                      	
  DB27  1171F4        		LD	DE,OK
  DB2A  C3A4DA        		JP	COPY8
                      	
  DB2D                	COPYE:
  DB2D  1114F4        		LD	DE,FDRV
  DB30  0E13          		LD	C,013H		;(BDOS)ファイルの削除
  DB32  CD0500        		CALL	SYSTEM
  DB35                	COPYE2:
  DB35  37            		SCF
  DB36  C9            		RET
                      	
  DB37                	CWILD:
  DB37  215D00        		LD	HL,FCB1FN
  DB3A                	CWILD1:
  DB3A  7E            		LD	A,(HL)
  DB3B  FE20          		CP	020H
  DB3D  C0            		RET	NZ
  DB3E                	CWILD2:
  DB3E  3E3F          		LD	A,'?'
  DB40  060B          		LD	B,11
  DB42  C353E5        		JP	FILL_MEMORY
                      	
  DB45                	COMTB:
  DB45  44202020      		DB	"D   "	;1
  DB49  F6D8          		DW	C_DIR
  DB4B  44495220      		DB	"DIR "	;2
  DB4F  F6D8          		DW	C_DIR
  DB51  434F5059      		DB	"COPY"	;3
  DB55  5FDA          		DW	C_COPY
  DB57  43442020      		DB	"CD  "	;4
  DB5B  13D8          		DW	C_CD
  DB5D  44454C20      		DB	"DEL "	;5
  DB61  D9D8          		DW	C_DEL
  DB63  50415448      		DB	"PATH"	;6
  DB67  8DD9          		DW	C_PATH
  DB69  52454E20      		DB	"REN "	;7
  DB6D  E3D8          		DW	C_REN
  DB6F  52454D20      		DB	"REM "	;8
  DB73  94DC          		DW	C_REM
                      	
                      	;X1DISK2.ASM
                      	
                      	;	LSX-Dodgers DISK2
                      	;	X1/turbo/Z
                      	
                      	;	GRAPHIC RAM DISK DRIVER
                      	
                      	
  DB75                	GDRD:
  DB75  C5            		PUSH	BC
  DB76  CD9EDB        		CALL	GADR
  DB79  F1            		POP	AF
  DB7A                	GDRD1:
  DB7A  EDA2          		INI
  DB7C  04            		INC	B
  DB7D  0C            		INC	C
  DB7E  20FA          		JR	NZ,GDRD1
  DB80  04            		INC	B
  DB81  13            		INC	DE
  DB82  3D            		DEC	A
  DB83  20F5          		JR	NZ,GDRD1
  DB85                	GBANK0:
  DB85  3ABFF4        		LD	A,(WK1FD0)
  DB88  E6EF          		AND	0EFH		;BANK0
  DB8A  181D          		JR	S1FD0
                      	
  DB8C                	GDWT:
  DB8C  C5            		PUSH	BC
  DB8D  CD9EDB        		CALL	GADR
  DB90  F1            		POP	AF
  DB91                	GDWT1:
  DB91  04            		INC	B
  DB92  EDA3          		OUTI
  DB94  0C            		INC	C
  DB95  20FA          		JR	NZ,GDWT1
  DB97  04            		INC	B
  DB98  13            		INC	DE
  DB99  3D            		DEC	A
  DB9A  20F5          		JR	NZ,GDWT1
  DB9C  18E7          		JR	GBANK0
                      	
  DB9E                	GADR:
  DB9E  0E00          		LD	C,0
  DBA0  7B            		LD	A,E
  DBA1  C640          		ADD	A,040H
  DBA3  47            		LD	B,A
  DBA4  3ABFF4        		LD	A,(WK1FD0)
  DBA7  F610          		OR	010H		;BANK1
  DBA9                	S1FD0:
  DBA9  C5            		PUSH	BC
  DBAA  32BFF4        		LD	(WK1FD0),A
  DBAD  01D01F        		LD	BC,01FD0H
  DBB0  ED79          		OUT	(C),A
  DBB2  C1            		POP	BC
  DBB3  C9            		RET
                      	
                      	
                      	;	BANK RAM DISK DRIVER
                      	
  DBB4                	BDWT:
  DBB4  3E            		DB	03EH	;LD A,??
  DBB5  37            		SCF
  DBB6  1802          		JR	BRW
                      	
  DBB8                	BDRD:
  DBB8  3E            		DB	03EH	;LD A,??
  DBB9  A7            		AND	A
  DBBA                	BRW:
  DBBA  F3            		DI
  DBBB  32E6DB        		LD	(BRWPAT),A
  DBBE  ED7306DC      		LD	(BANKSP),SP
  DBC2  3A07DC        		LD	A,(BANKSP_H)
  DBC5  87            		ADD	A,A
  DBC6  3803          		JR	C,BRW0
  DBC8  31CAFF        		LD	SP,EXTSP
  DBCB                	BRW0:
  DBCB  D9            		EXX		;裏レジスタ
  DBCC  C5            		 PUSH	 BC
  DBCD  D5            		 PUSH	 DE
  DBCE  01000B        		 LD	 BC,00B00H	 ;バンクメモリ
  DBD1  111010        		 LD	 DE,01010H
  DBD4  D9            		 EXX		;表レジスタ
  DBD5                	BRW1:
  DBD5  C5            		PUSH	BC
  DBD6  D5            		PUSH	DE
  DBD7  EB            		EX	DE,HL
  DBD8  29            		ADD	HL,HL
  DBD9  29            		ADD	HL,HL
  DBDA  7C            		LD	A,H
  DBDB  DD860C        		ADD	A,(IX+DPB_MAXCYL)
  DBDE  E60F          		AND	00FH	;バンク
  DBE0  65            		LD	H,L
  DBE1  CB3C          		SRL	H	;/2
  DBE3  2E00          		LD	L,0
  DBE5  D9            		EXX		;裏レジスタ
  DBE6  A7            	BRWPAT:	 AND	 A	;自己書き換え(AND A:読み出し/SCF:書き込み)
  DBE7  3808          		 JR	 C,BRWT
  DBE9  57            		 LD	 D,A	 ;D=バンク
  DBEA  D9            		 EXX		;表レジスタ
  DBEB  EB            		EX	DE,HL
  DBEC  CD0ADC        		CALL	BTFR
  DBEF  1806          		JR	BRW2
  DBF1                	BRWT:
  DBF1  5F            		 LD	E,A	 ;E=バンク
  DBF2  D9            		 EXX		;表レジスタ
  DBF3  CD0ADC        		CALL	BTFR
  DBF6  EB            		EX	DE,HL
  DBF7                	BRW2:
  DBF7  D1            		POP	DE
  DBF8  C1            		POP	BC
  DBF9  13            		INC	DE
  DBFA  10D9          		DJNZ	BRW1
                      	
  DBFC  D9            		EXX		;裏レジスタ
  DBFD  3E10          		 LD	 A,10H
  DBFF  ED79          		 OUT	 (C),A		;メインメモリに切り替える
  DC01  D1            		 POP	 DE
  DC02  C1            		 POP	 BC
  DC03  D9            		 EXX		;表レジスタ
  DC04  AF            		XOR	A
  DC05  310000        		LD	SP,0
  DC07                	BANKSP_H	EQU	$-1
  DC06                	BANKSP		EQU	$-2
  DC08  FB            		EI
  DC09  C9            		RET
                      	
                      	;メインメモリ←→バンクメモリ 512バイトの転送を行う
                      	; DE:転送元アドレス
                      	; HL:転送先アドレス
                      	; 裏BC:バンク切り替えポート(0B00H)
                      	; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
                      	; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
                      	
  DC0A                	BTFR:
  DC0A  0600          		LD	B,0	;256回ループ(256*2)
  DC0C                	BTFR1:
  DC0C  D9            		EXX		;裏レジスタ
  DC0D  ED51          		 OUT	 (C),D	 ;BANK(MAIN)
  DC0F  D9            		 EXX		;表レジスタ
  DC10  1A            		LD	A,(DE)
  DC11  4F            		LD	C,A
  DC12  13            		INC	DE
  DC13  1A            		LD	A,(DE)
  DC14  13            		INC	DE
  DC15  D9            		EXX		;裏レジスタ
  DC16  ED59          		 OUT	 (C),E	 ;MAIN(BANK)
  DC18  D9            		 EXX		;表レジスタ
  DC19  71            		LD	(HL),C
  DC1A  23            		INC	HL
  DC1B  77            		LD	(HL),A
  DC1C  23            		INC	HL
  DC1D  10ED          		DJNZ	BTFR1
  DC1F  C9            		RET
                      	
                      	;	EMM DRIVER(CPU)
                      	
  DC20                	EDWT:
  DC20  CD48DC        		CALL	EADR
  DC23                	EDWT0:
  DC23  F5            		PUSH	AF
  DC24  AF            		XOR	A
  DC25                	EDWT1:
  DC25  04            		INC	B
  DC26  EDA3          		OUTI
  DC28  04            		INC	B
  DC29  EDA3          		OUTI
  DC2B  3D            		DEC	A
  DC2C  20F7          		JR	NZ,EDWT1
  DC2E  13            		INC	DE
  DC2F  F1            		POP	AF
  DC30  3D            		DEC	A
  DC31  20F0          		JR	NZ,EDWT0
  DC33  C9            		RET
                      	
  DC34                	EDRD:
  DC34  CD48DC        		CALL	EADR
  DC37                	EDRD0:
  DC37  F5            		PUSH	AF
  DC38  AF            		XOR	A
  DC39                	EDRD1:
  DC39  EDA2          		INI
  DC3B  04            		INC	B
  DC3C  EDA2          		INI
  DC3E  04            		INC	B
  DC3F  3D            		DEC	A
  DC40  20F7          		JR	NZ,EDRD1
  DC42  13            		INC	DE
  DC43  F1            		POP	AF
  DC44  3D            		DEC	A
  DC45  20F0          		JR	NZ,EDRD0
  DC47  C9            		RET
                      	
  DC48                	EADR:
  DC48  C5            		PUSH	BC
  DC49  D5            		PUSH	DE
  DC4A  EB            		EX	DE,HL
  DC4B  29            		ADD	HL,HL
  DC4C  DD4E0D        		LD	C,(IX+DPB_MAXSEC)
  DC4F  DD460C        		LD	B,(IX+DPB_MAXCYL)
  DC52  09            		ADD	HL,BC
  DC53  DD4E13        		LD	C,(IX+DPB_UNITNO)
  DC56  060D          		LD	B,00DH
  DC58  ED71          		DB	0EDH,071H	;OUT (C),0	Z80未定義命令
  DC5A  0C            		INC	C
  DC5B  ED69          		OUT	(C),L
  DC5D  0C            		INC	C
  DC5E  ED61          		OUT	(C),H
  DC60  0C            		INC	C
  DC61  EB            		EX	DE,HL
  DC62  D1            		POP	DE
  DC63  F1            		POP	AF
  DC64  A7            		AND	A	;CF=0
  DC65  C9            		RET
                      	
                      	
                      	
                      	;LDOS.ASM
                      	
                      	;	LSX-Dodgers OS
                      	
  DC66                	BDOS0:
  DC66  E5            		PUSH	HL
  DC67  79            		LD	A,C
  DC68  FE3C          		CP	03CH
  DC6A  3802          		JR	C,DOS1
  DC6C  3E3C          		LD	A,03CH
  DC6E                	DOS1:
  DC6E  87            		ADD	A,A
  DC6F  3273DC        		LD	(DOS1_SWC),A
  DC72  2A00F5        		LD	HL,(STABLE)
  DC73                	DOS1_SWC	EQU	$-2
  DC75  E3            		EX	(SP),HL
  DC76  79            		LD	A,C
                      	;確認用
                      	;	LD	(0050H),A
  DC77  C9            		RET
  DC78                	_DOS2:
  DC78  FE5A          		CP	05AH		;(BDOS)カレントディレクトリの変更(_CHDIR)
  DC7A  CA13DF        		JP	Z,_SYS5A
  DC7D  FE5C          		CP	05CH		;(BDOS)ファイル名の解析(_PFILE)
  DC7F  CAD0DE        		JP	Z,_SYS5C
  DC82  FE5F          		CP	05FH		;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
  DC84  CAEBF1        		JP	Z,_SYS5F
  DC87  FE6F          		CP	06FH		;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
  DC89  200A          		JR	NZ,_ERROR
  DC8B  011D01        		LD	BC,VER_6F
  DC8E  116101        		LD	DE,VER
  DC91  210000        		LD	HL,MACD
  DC94                	C_REM:
  DC94  AF            		XOR	A
  DC95                	_ERROR:
  DC95  A7            		AND	A
  DC96  C9            		RET
                      	
  DC97                	_SYS09:		;文字列出力
  DC97  D5            		PUSH	DE
  DC98                	_SX09:
  DC98  1A            		LD	A,(DE)
  DC99  13            		INC	DE
  DC9A  FE24          		CP	'$'
  DC9C  2831          		JR	Z,SX0E2
  DC9E  CDA8DF        		CALL	MSG_A
  DCA1  18F5          		JR	_SX09
                      	
  DCA3                	MSX1:
  DCA3  CDA8DF        		CALL	MSG_A
  DCA6                	MSX:
  DCA6  7E            		LD	A,(HL)
  DCA7  23            		INC	HL
  DCA8  B7            		OR	A
  DCA9  20F8          		JR	NZ,MSX1
  DCAB  C9            		RET
                      	
  DCAC                	_SYS0C:		;(BDOS)バージョン番号の獲得
  DCAC  212200        		LD	HL,00022H
  DCAF  7D            		LD	A,L
  DCB0  C9            		RET
                      	
  DCB1                	_SYS0D:		;(BDOS)ディスクリセット
  DCB1  CDDFF4        		CALL	_FFLUSH
  DCB4  E5            		PUSH	HL
  DCB5  218000        		LD	HL,00080H
  DCB8  228AF4        		LD	(_DTA),HL
  DCBB  E1            		POP	HL
  DCBC  D5            		PUSH	DE
  DCBD  1E00          		LD	E,0
  DCBF  3E            		DB	03EH	;次の PUSH DE をスキップ
                      	
  DCC0                	_SYS0E:		;(BDOS)カレントドライブの設定
  DCC0  D5            		PUSH	DE
  DCC1  7B            		LD	A,E
  DCC2  DDE5          		PUSH	IX
  DCC4  CDDCF4        		CALL	_GETDPB
  DCC7  DDE1          		POP	IX
  DCC9  3804          		JR	C,SX0E2
  DCCB  7B            		LD	A,E
  DCCC  320400        		LD	(_DVSW),A
  DCCF                	SX0E2:
  DCCF  D1            		POP	DE
  DCD0  C9            		RET
                      	
  DCD1                	_SYS0F:		;(BDOS)ファイルのオープン
  DCD1  CD90E5        		CALL	SETDRV
  DCD4  FD7E1C        		LD	A,(IY+28)	;(FCB)オープンモード
  DCD7  C602          		ADD	A,002H		;Write
  DCD9  2848          		JR	Z,FEND0F
  DCDB  CDDEE8        		CALL	CHKWILDX
                      	
  DCDE  D4BAE5        		CALL	NC,SOPENX
  DCE1                	_S16XX:
  DCE1  3840          		JR	C,FEND0F
                      					;Directory location
  DCE3  3A9FF4        		LD	A,(_FILEN)
  DCE6  FD7719        		LD	(IY+25),A	;(FCB)ディレクトリロケーション
                      	;				_DIRF
  DCE9  3AA0F4        		LD	A,(_DIRF)
  DCEC  FD771D        		LD	(IY+29),A	;(FCB)ディレクトリモード
                      	;				_FBPS
  DCEF  FD731E        		LD	(IY+30),E	;(FCB)ディレクトリポジション
  DCF2  FD721F        		LD	(IY+31),D
                      	;				Open(Read)
  DCF5  FD361CFF      		LD	(IY+28),0FFH	;(FCB)オープンモード
                      	;				FILENAME
  DCF9  FDE5          		PUSH	IY
  DCFB  D1            		POP	DE
  DCFC  13            		INC	DE
  DCFD  010B00        		LD	BC,11
  DD00  EDB0          		LDIR
                      	;				Attribute
  DD02  7E            		LD	A,(HL)
  DD03  FD770D        		LD	(IY+13),A	;(FCB)属性(アトリビュート)
  DD06  110B00        		LD	DE,11		;Reserved
  DD09  19            		ADD	HL,DE
                      						;(FCB)ファイルを最後に変更した時刻
  DD0A  11E4F5        		LD	DE,SDDATA		;(FCB)ファイルを最後に変更した日付
  DD0D  060A          		LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
  DD0F                	S16LOOP:				;(FCB)ファイルのサイズ(バイト単位)
  DD0F  1A            		LD	A,(DE)
  DD10  13            		INC	DE
  DD11  3218DD        		LD	(S16PAT),A
  DD14  7E            		LD	A,(HL)
  DD15  23            		INC	HL
  DD16  FD7700        		LD	(IY+0),A
  DD18                	S16PAT	EQU	$-1
  DD19  10F4          		DJNZ	S16LOOP
                      	
  DD1B  AF            		XOR	A
  DD1C  FD770C        		LD	(IY+12),A	;(FCB)カレントブロック
  DD1F  FD22C0DD      		LD	(OFCB_SWC),IY
  DD23                	FEND0F:
  DD23  1845          		JR	FEND10
                      	
  DD25                	_SYS10:		;(BDOS)ファイルのクローズ
  DD25  CD90E5        		CALL	SETDRV
  DD28  FD7E1C        		LD	A,(IY+28)	;(FCB)オープンモード
  DD2B  D6FE          		SUB	0FEH
  DD2D  37            		SCF
  DD2E  3F            		CCF
  DD2F  2039          		JR	NZ,FEND10
  DD31                	_S10A:				;Write
  DD31  FD770E        		LD	(IY+14),A	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
  DD34  FD770F        		LD	(IY+15),A
                      	
  DD37  FD341C        		INC	(IY+28)		;(FCB)オープンモード 0FEH->0FFH
  DD3A  CDDAE9        		CALL	SETTMS
                      	
  DD3D  FD7E1D        		LD	A,(IY+29)	;(FCB)ディレクトリモード
  DD40  32A0F4        		LD	(_DIRF),A
  DD43  E67F          		AND	07FH
  DD45  320CEF        		LD	(_SECPS),A
  DD48  FD5E1E        		LD	E,(IY+30)	;(FCB)ディレクトリポジション
  DD4B  FD561F        		LD	D,(IY+31)
  DD4E  CDEFE6        		CALL	READ_DIR
  DD51  3817          		JR	C,FEND10
                      	
  DD53  3A1AE6        	SDECM1:	LD	A,(SDECPAT)	;1セクタ辺りのディレクトリエントリ数
  DD56  3D            	 	DEC	A		;1024=01FH / 512=00FH / 256=7
  DD57  FDA619        		AND	(IY+25)		;(FCB)ディレクトリロケーション
  DD5A  6F            		LD	L,A
  DD5B  2600          		LD	H,0
  DD5D  29            		ADD	HL,HL		;*2
  DD5E  29            		ADD	HL,HL		;*4
  DD5F  29            		ADD	HL,HL		;*8
  DD60  29            		ADD	HL,HL		;*16
  DD61  29            		ADD	HL,HL		;*32
  DD62  ED4B7EF5      		LD	BC,(_DTBUF)
  DD66  09            		ADD	HL,BC
                      	
  DD67  CDEEE8        		CALL	SDIRENT
  DD6A                	FEND10:
  DD6A  1842          		JR	FEND
                      	
  DD6C                	_SYS11:		;(BDOS)最初のファイルの検索
  DD6C  CD90E5        		CALL	SETDRV
  DD6F  CDE9E5        		CALL	SOPEN
  DD72                	_S12X1:
  DD72  383A          		JR	C,FEND
  DD74  CD88E6        		CALL	SOPENE2
  DD77  ED5B8AF4      		LD	DE,(_DTA)
  DD7B  3A88F4        		LD	A,(_DRV)
  DD7E  3C            		INC	A
  DD7F  12            		LD	(DE),A
  DD80  D5            		PUSH	DE
  DD81  13            		INC	DE
  DD82  012000        		LD	BC,32
  DD85  EDB0          		LDIR
  DD87  FD6E0E        		LD	L,(IY+14)	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
  DD8A  FD660F        		LD	H,(IY+15)
  DD8D  22F4F5        		LD	(SCDIR),HL
  DD90  2A9AF4        		LD	HL,(_FBPS)
  DD93  22F6F5        		LD	(SFBPS),HL
  DD96  2A9FF4        		LD	HL,(_FILEN)
  DD99  7C            		LD	A,H
  DD9A  B7            		OR	A
  DD9B  2806          		JR	Z,_S12DIR
  DD9D  3A0CEF        		LD	A,(_SECPS)
  DDA0  F680          		OR	080H
  DDA2  67            		LD	H,A
  DDA3                	_S12DIR:
  DDA3  22F8F5        		LD	(SFNDF),HL	;Directory position and Flags
  DDA6  E1            		POP	HL
  DDA7  1139F4        		LD	DE,SFILE
  DDAA  0E21          		LD	C,33
  DDAC                	_S11B:
  DDAC  EDB0          		LDIR
  DDAE                	FEND:
  DDAE  9F            		SBC	A,A		;CF=0 A=0 : CF=1 A=0FFH
  DDAF                	FENDE:
  DDAF  FDE1          		POP	IY
  DDB1  C1            		POP	BC
  DDB2  D1            		POP	DE
  DDB3  E1            		POP	HL
  DDB4  C9            		RET
                      	
  DDB5                	_SYS12:		;(BDOS)次のファイルの検索
  DDB5  E5            		PUSH	HL
  DDB6  D5            		PUSH	DE
  DDB7  C5            		PUSH	BC
  DDB8  FDE5          		PUSH	IY
  DDBA  CD4DE6        		CALL	NOPEN
  DDBD  18B3          		JR	_S12X1
                      	
  DDBF                	_S16K:
  DDBF  110000        		LD	DE,0
  DDC0                	OFCB_SWC	EQU	$-2
  DDC2  D5            		PUSH	DE
  DDC3  061A          		LD	B,26		;First cluster
  DDC5                	S16K1:
  DDC5  13            		INC	DE
  DDC6  23            		INC	HL
  DDC7  10FC          		DJNZ	S16K1
                      	
  DDC9  1A            		LD	A,(DE)
  DDCA  BE            		CP	(HL)
  DDCB  2015          		JR	NZ,S16K2
  DDCD  13            		INC	DE
  DDCE  23            		INC	HL
  DDCF  1A            		LD	A,(DE)
  DDD0  BE            		CP	(HL)
  DDD1  200F          		JR	NZ,S16K2
                      	
  DDD3  E1            		POP	HL
  DDD4  FDE5          		PUSH	IY
  DDD6  D1            		POP	DE
  DDD7  7E            		LD	A,(HL)
  DDD8  CDA5E5        		CALL	IS_SAME_DRV_A_DE
  DDDB  2006          		JR	NZ,S16K3
                      					;ここはCFが必ず0
  DDDD  ED52          		SBC	HL,DE		;CP HL,DE
  DDDF  37            		SCF
  DDE0  C0            		RET	NZ
  DDE1  E5            		PUSH	HL
  DDE2                	S16K2:
  DDE2  E1            		POP	HL
  DDE3                	S16K3:
  DDE3  FDE5          		PUSH	IY
  DDE5  D1            		POP	DE
  DDE6                	_SYS13:		;(BDOS)ファイルの削除
  DDE6  CD90E5        		CALL	SETDRV
  DDE9  CD14E8        		CALL	KILL
  DDEC                	FEND13:
  DDEC  18C0          		JR	FEND
                      	
  DDEE                	_SYS14:		;(BDOS)シーケンシャルな読み出し
  DDEE  CD90E5        		CALL	SETDRV
  DDF1  CD3CEA        		CALL	INIT_SEQ
  DDF4                	SREAD:
  DDF4  CD6AEA        		CALL	RB_READ
                      	
  DDF7  C601          		ADD	A,001H
  DDF9  38B3          		JR	C,FEND
                      	
  DDFB  7D            		LD	A,L
  DDFC  D601          		SUB	001H
  DDFE                	FENDX:
  DDFE  9F            		SBC	A,A
  DDFF  E603          		AND	3
  DE01  1F            		RRA
  DE02  18AB          		JR	FENDE
                      	
  DE04                	_SYS15:		;(BDOS)シーケンシャルな書き込み
  DE04  CD90E5        		CALL	SETDRV
  DE07  CD3CEA        		CALL	INIT_SEQ
  DE0A                	SWRITE:
  DE0A  CD63EA        		CALL	RB_WRITE
                      	
  DE0D  C6FF          		ADD	A,0FFH
  DE0F  18ED          		JR	FENDX
                      	
  DE11                	_SYS17:		;(BDOS)ファイル名の変更
  DE11  CD90E5        		CALL	SETDRV
  DE14  CD6AE8        		CALL	NAME
  DE17  18D3          		JR	FEND13
                      	
  DE19                	_SYS16:		;(BDOS)ファイルの作成
  DE19  CD90E5        		CALL	SETDRV
                      	
  DE1C  CDDEE8        		CALL	CHKWILDX
  DE1F  38CB          		JR	C,FEND13
  DE21  FD7E01        		LD	A,(IY+1)	;(FCB)主ファイル名
  DE24  FE05          		CP	5
  DE26  2805          		JR	Z,_S16X2
  DE28  FE21          		CP	021H
  DE2A  DAECDD        		JP	C,FEND13
  DE2D                	_S16X2:
                      	;				Clear FCB
  DE2D  FDE5          		PUSH	IY
  DE2F  E1            		POP	HL
  DE30  011000        		LD	BC,16
  DE33  09            		ADD	HL,BC
  DE34                	_S16X1:
  DE34  70            		LD	(HL),B		;B=0
  DE35  23            		INC	HL
  DE36  0D            		DEC	C
  DE37  20FB          		JR	NZ,_S16X1
                      	
  DE39  CDDFE9        		CALL	SETTMSX
  DE3C  FD360DFF      		LD	(IY+13),0FFH	;(FCB)Attribute
  DE40  CDBAE5        		CALL	SOPENX
  DE43  3F            		CCF
  DE44  CCBFDD        		CALL	Z,_S16K
  DE47  D499E6        		CALL	NC,COPEN
  DE4A  D4EEE8        		CALL	NC,SDIRENT
  DE4D  C3E1DC        		JP	_S16XX
                      	
  DE50                	_SYS21:		;(BDOS)ランダムな読み出し
  DE50  CD90E5        		CALL	SETDRV
  DE53  CD2AEA        		CALL	INIT_RND
  DE56  189C          		JR	SREAD
                      	
  DE58                	_SYS22:		;(BDOS)ランダムな書き込み
  DE58                	_SYS28:		;(BDOS)ランダムな書き込み・その2
  DE58  CD90E5        		CALL	SETDRV
  DE5B  CD2AEA        		CALL	INIT_RND
  DE5E  18AA          		JR	SWRITE
                      	
  DE60                	_SYS18:		;(BDOS)ログインベクトルの獲得
  DE60  21FF00        		LD	HL,000FFH
  DE63  AF            		XOR	A
  DE64  C9            		RET
                      	
  DE65                	_SYS19:		;(BDOS)カレントドライブ番号の獲得
  DE65  3A0400        		LD	A,(_DVSW)
  DE68  A7            		AND	A
  DE69  C9            		RET
                      	
  DE6A                	_SYS1A:		;(BDOS)DTAの設定
  DE6A  ED538AF4      		LD	(_DTA),DE
  DE6E  AF            		XOR	A
  DE6F  C9            		RET
                      	
  DE70                	_SYS1B:		;(BDOS)ディスク情報の獲得
  DE70  7B            		LD	A,E
  DE71  CD9EE5        		CALL	GETDRV
  DE74  CDDCF4        		CALL	_GETDPB
  DE77  D4E2F4        		CALL	NC,_RDFATX
  DE7A  210000        		LD	HL,0
  DE7D  D4B8E9        		CALL	NC,DSKF
                      	
  DE80  ED5BB9E9      		LD	DE,(MAXCLP)	;DPB_MAXCL-1
  DE84  1B            		DEC	DE		;DE←クラスタの総数
  DE85  FD2A7CF5      		LD	IY,(_FATBF)	;IY←メモリ上のFATの先頭アドレス
  DE89  9F            		SBC	A,A
  DE8A  D8            		RET	C
  DE8B  4F            		LD	C,A		;C=0
  DE8C  DD7E0F        		LD	A,(IX+DPB_BPS)
  DE8F  E607          		AND	7
  DE91  47            		LD	B,A
  DE92  DD7E07        		LD	A,(IX+DPB_SECPCL)
  DE95  C9            		RET
                      	
  DE96                	_SYS1D:		;(BDOS)書き込みが禁止されているディスクの調査
  DE96  AF            		XOR	A
  DE97  67            		LD	H,A
  DE98  6F            		LD	L,A
  DE99  C9            		RET
                      	
  DE9A                	_SYS1F:		;(BDOS)ディスク装置のパラメータの読み出し
  DE9A  2100F6        		LD	HL,_DEVICE
  DE9D  7B            		LD	A,E
  DE9E  C3DCF4        		JP	_GETDPB
                      	
  DEA1                	_SYS23:		;(BDOS)ファイルサイズの獲得
  DEA1  E5            		PUSH	HL
  DEA2  2A1EF5        		LD	HL,(STABLE+2*00FH)	;ファイルのオープン
  DEA5  CD0F00        		CALL	JP_HL
  DEA8  381B          		JR	C,_S23X1
                      	
  DEAA  D5            		PUSH	DE		;EX DE,IY
  DEAB  FDE3          		EX	(SP),IY		;
                      	;	POP	DE		;
                      	;	PUSH	DE		;DEを破壊しないように注意vv
  DEAD  FD7E10        		LD	A,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
  DEB0  FD6E11        		LD	L,(IY+17)	;
  DEB3  FD6612        		LD	H,(IY+18)	;
  DEB6  C5            		PUSH	BC		;
  DEB7  FD4613        		LD	B,(IY+19)	;
  DEBA  CD1CEA        		CALL	GET_CPM_R_SIZE
  DEBD  C1            		POP	BC
  DEBE                	_S24X1:
  DEBE  CD54ED        		CALL	SET_RR_AHL
                      	;	POP	DE		;^^^^^^^^^^^^^^^^^^^^^^^^
                      	;	PUSH	DE		;EX DE,IY
  DEC1  FDE3          		EX	(SP),IY		;
  DEC3  D1            		POP	DE		;
                      	
  DEC4  AF            		XOR	A
  DEC5                	_S23X1:
  DEC5  E1            		POP	HL
  DEC6  C9            		RET
                      	
  DEC7                	_SYS24:		;(BDOS)ランダムレコードフィールドの設定
  DEC7  E5            		PUSH	HL
  DEC8  D5            		PUSH	DE		;EX DE,IY
  DEC9  FDE3          		EX	(SP),IY		;
                      	;	POP	DE		;
                      	;	PUSH	DE		;DEを破壊しないように注意vv
  DECB  CD44EA        		CALL	GETSEQ
  DECE  18EE          		JR	_S24X1		;^^^^^^^^^^^^^^^^^^^^^^^^
                      	
  DED0                	_SYS5C:		;(BDOS)ファイル名の解析(_PFILE)
  DED0  2B            		DEC	HL
  DED1                	_SYS29:		;(BDOS)ファイル名の解析(_PPATH)
  DED1  C5            		PUSH	BC
  DED2  E5            		PUSH	HL
  DED3  CDA7E4        		CALL	FILE
  DED6  E1            		POP	HL
  DED7  C1            		POP	BC
  DED8                	S29X1:
  DED8  C5            		PUSH	BC
  DED9  D5            		PUSH	DE
  DEDA  E5            		PUSH	HL
  DEDB  EB            		EX	DE,HL
  DEDC  AF            		XOR	A
  DEDD  3221F4        		LD	(FDRV+13),A
  DEE0  2114F4        		LD	HL,FDRV
  DEE3  011000        		LD	BC,16
  DEE6  EDB0          		LDIR
  DEE8  E1            		POP	HL
  DEE9  D1            		POP	DE
  DEEA  C1            		POP	BC
  DEEB  C9            		RET
                      	
  DEEC                	_SYS30:		;(BDOS)論理セクタを用いた書き込み
  DEEC  C5            		PUSH	BC
  DEED  01AAF0        		LD	BC,DWT24B
  DEF0  1804          		JR	S2FX
  DEF2                	_SYS2F:
  DEF2  C5            		PUSH	BC
  DEF3  019AF0        		LD	BC,DRD24B
  DEF6                	S2FX:
  DEF6  ED430CDF      		LD	(S2F_SWC),BC
  DEFA  CDDFF4        		CALL	_FFLUSH
                      	
  DEFD  D5            		PUSH	DE
  DEFE  E5            		PUSH	HL
  DEFF  7D            		LD	A,L		;Drive
  DF00  CDD9F4        		CALL	_CHGDRV
  DF03  3809          		JR	C,S30X2
  DF05  44            		LD	B,H		;Number of clusters
  DF06  2A8AF4        		LD	HL,(_DTA)
                      	
  DF09  0E00          		LD	C,0
  DF0B  CD9AF0        		CALL	DRD24B
  DF0C                	S2F_SWC	EQU	$-2
  DF0E                	S30X2:
  DF0E  E1            		POP	HL
  DF0F  D1            		POP	DE
  DF10  C1            		POP	BC
  DF11  9F            		SBC	A,A
  DF12  C9            		RET
                      	
  DF13                	_SYS5A:		;(BDOS)カレントディレクトリの変更
  DF13  C5            		PUSH	BC
  DF14  D5            		PUSH	DE
  DF15  E5            		PUSH	HL
  DF16  CD9CE4        		CALL	FILEC
  DF19  210EDF        		LD	HL,S30X2
  DF1C  E5            		PUSH	HL
  DF1D  3A21F4        		LD	A,(FDRV+13)	;(FCB)属性(アトリビュート))
  DF20  E610          		AND	010H		;ディレクトリ
  DF22  C8            		RET	Z
  DF23  1114F4        		LD	DE,FDRV
  DF26  2A4EF5        		LD	HL,(STABLE+2*027H)	;ランダムブロック読み込み
  DF29  E9            		JP	(HL)
                      	
                      	;X1IO.ASM
                      	
                      	;	LSX-Dodgers IO
                      	;	X1/turbo/Z
                      	
  DC95                	_SYS04	EQU	_ERROR		;(BDOS)外部出力
  DC95                	_SYS05	EQU	_ERROR		;(BDOS)プリンタ出力
  DC95                	_SYS1C	EQU	_ERROR		;(BDOS)ディスクの書き込み禁止化
  DC95                	_SYS1E	EQU	_ERROR		;(BDOS)ファイル属性の設定
  DC95                	_SYS20	EQU	_ERROR		;(BDOS)利用者番号の設定と読み出し
  DC95                	_SYS2E	EQU	_ERROR		;(BDOS)ベリファイ・フラグの設定
                      	
  DF2A                	BIOS:
  DF2A  E5            		PUSH	HL
  DF2B  211080        		LD	HL,08010H
  DF2E  39            		ADD	HL,SP
  DF2F  E1            		POP	HL
  DF30  300E          		JR	NC,BIOS2
  DF32                	BIOS1:
  DF32  CD3ADF        		CALL	BIOS3
  DF35  061E          		LD	B,01EH
  DF37  ED79          		OUT	(C),A
  DF39  C9            		RET
  DF3A                	BIOS3:
  DF3A  C5            		PUSH	BC
  DF3B  061D          		LD	B,01DH
  DF3D  ED79          		OUT	(C),A
  DF3F  C9            		RET
  DF40                	BIOS2:
  DF40  ED734BDF      		LD	(BIOS_SP),SP	;スタックがBIOS-ROMと被っている場合
  DF44  31CAFF        		LD	SP,EXTSP
  DF47  CD32DF        		CALL	BIOS1
  DF4A  310000        		LD	SP,0
  DF4B                	BIOS_SP	EQU	$-2
  DF4D  C9            		RET
                      	
  DF4E                	INT:
  DF4E  F5            		PUSH	AF
  DF4F  E5            		PUSH	HL
  DF50  C5            		PUSH	BC
                      	
  DF51  CDDEE2        		CALL	IN49SB
  DF54  67            		LD	H,A
  DF55  CDDEE2        		CALL	IN49SB
  DF58  6F            		LD	L,A
  DF59                	SCEXE:
  DF59  2292F4        		LD	(_KEYD),HL
  DF5C  CD65DF        		CALL	KEYSET1
                      	
  DF5F  C1            		POP	BC
  DF60                	INTPE:
  DF60  E1            		POP	HL
  DF61                	INTPE2:
  DF61  F1            		POP	AF
  DF62                	INTCTCE:
  DF62  FB            		EI
  DF63  ED4D          		RETI
                      	
  DF65                	KEYSET1:
  DF65  F5            		PUSH	AF
  DF66  AF            		XOR	A
  DF67  3202E0        		LD	(FLGET_SWC),A
  DF6A  F1            		POP	AF
  DF6B  B7            		OR	A
  DF6C  C8            		RET	Z
                      	
  DF6D  CB6C          		BIT	5,H
  DF6F  2806          		JR	Z,KEYSET
  DF71  3A95F4        		LD	A,(_KEYSP+1)
  DF74  3217E0        		LD	(KEYREPEAT_SWC),A
  DF77                	KEYSET:
  DF77  7D            		LD	A,L
  DF78  CB74          		BIT	6,H
  DF7A  C0            		RET	NZ
  DF7B                	KEYBS:
  DF7B  B7            		OR	A
  DF7C  C8            		RET	Z
  DF7D                	KEYBS1:
  DF7D  CD95DF        		CALL	KEYBC_IFBREAK
  DF80  E5            		PUSH	HL
  DF81  F5            		PUSH	AF
  DF82  2A90F4        		LD	HL,(_KEYPS)
  DF85  2C            		INC	L
  DF86  CBAD          		RES	5,L
  DF88  7D            		LD	A,L
  DF89  BC            		CP	H
  DF8A  2815          		JR	Z,POP_AF_HL_SCF_RET
  DF8C  3290F4        		LD	(_KEYPS),A
  DF8F  26FF          		LD	H,KEYBF/256
  DF91  F1            		POP	AF
  DF92  77            		LD	(HL),A
  DF93  E1            		POP	HL
  DF94  C9            		RET
  DF95                	KEYBC_IFBREAK:
  DF95  FE03          		CP	3
  DF97  C0            		RET	NZ
  DF98                	KEYBC:
  DF98  E5            		PUSH	HL
  DF99  210000        		LD	HL,0
  DF9C  2290F4        		LD	(_KEYPS),HL
  DF9F  E1            		POP	HL
  DFA0  C9            		RET
                      	
  DFA1                	POP_AF_HL_SCF_RET:
  DFA1  F1            		POP	AF
  DFA2  E1            		POP	HL
  DFA3  37            		SCF
  DFA4  C9            		RET
                      	
  DFA5                	_SYS01:		;(BDOS)コンソール入力
  DFA5  CD09F4        		CALL	_SYS07
  DFA8                	MSG_A:
  DFA8  F5            		PUSH	AF
  DFA9  D5            		PUSH	DE
  DFAA  5F            		LD	E,A
  DFAB  CDB1DF        		CALL	_SYS02
  DFAE  D1            		POP	DE
  DFAF  F1            		POP	AF
  DFB0  C9            		RET
                      	
  DFB1                	_SYS02:		;(BDOS)コンソール出力
  DFB1  CDC3DF        		CALL	BREAK
  DFB4  1805          		JR	PRINTX
                      	
  DFB6                	_SYS06:		;(BDOS)コンソール直接入出力
  DFB6  7B            		LD	A,E
  DFB7  3C            		INC	A
  DFB8  CACAF4        		JP	Z,_INKEY
  DFBB                	PRINTX:
  DFBB  C3CDF4        		JP	_PRINT
                      	
  DFBE                	_SYS08:		;(BDOS)エコーなしコンソール入力
  DFBE  CD09F4        		CALL	_SYS07
  DFC1  1804          		JR	BREAK1
  DFC3                	BREAK:
  DFC3  FB            		EI
  DFC4  3A92F4        		LD	A,(_KEYD)
  DFC7                	BREAK1:
  DFC7  FE03          		CP	3		;CTRL+C
  DFC9  CCF4F4        		CALL	Z,_BREAK
  DFCC  FE13          		CP	013H		;CTRL+S
  DFCE  C0            		RET	NZ
                      	
  DFCF                	PAUSE:
  DFCF  CD98DF        		CALL	KEYBC
                      	
  DFD2                	FLGET:
  DFD2  CDDFF4        		CALL	_FFLUSH
  DFD5  C5            		PUSH	BC
  DFD6  E5            		PUSH	HL
  DFD7  ED4B8EF4      		LD	BC,(_TXADR)
  DFDB  CBE8          		SET	5,B
  DFDD  ED60          		IN	H,(C)
  DFDF                	FLGET1:
  DFDF  3A93F4        		LD	A,(_KEYD+1)
  DFE2  0F            		RRCA
  DFE3  0F            		RRCA
  DFE4  E610          		AND	010H
  DFE6  F608          		OR	8
  DFE8  ED68          		IN	L,(C)
  DFEA  B5            		OR	L
  DFEB  ED79          		OUT	(C),A
  DFED                	FLGETR:
  DFED  CDCAF4        		CALL	_INKEY
  DFF0  2032          		JR	NZ,FLGETE
  DFF2  CB5D          		BIT	3,L
  DFF4  28E9          		JR	Z,FLGET1
  DFF6  3A92F4        		LD	A,(_KEYD)
  DFF9  B7            		OR	A
  DFFA  28E3          		JR	Z,FLGET1
                      	
  DFFC  3E1A          		LD	A,01AH
  DFFE  3202E0        		LD	(FLGET_SWC),A
  E001                	FLGET2:
  E001  3E1A          		LD	A,1AH
  E002                	FLGET_SWC	EQU	$-1
  E003  B7            		OR	A
  E004  28E7          		JR	Z,FLGETR
  E006  DB01          		IN	A,(01H)
  E008  87            		ADD	A,A
  E009  30F6          		JR	NC,FLGET2
  E00B                	FLGET3:
  E00B  3A02E0        		LD	A,(FLGET_SWC)
  E00E  B7            		OR	A
  E00F  28DC          		JR	Z,FLGETR
  E011  DB01          		IN	A,(01H)
  E013  87            		ADD	A,A
  E014  38F5          		JR	C,FLGET3
                      	
  E016  3E00          		LD	A,0
  E017                	KEYREPEAT_SWC	EQU $-1
  E018  B7            		OR	A
  E019  2806          		JR	Z,FLGET4
  E01B  3D            		DEC	A
  E01C  3217E0        		LD	(KEYREPEAT_SWC),A
  E01F  18E0          		JR	FLGET2
  E021                	FLGET4:
  E021  3A92F4        		LD	A,(_KEYD)
  E024                	FLGETE:
  E024  ED61          		OUT	(C),H
  E026  E1            		POP	HL
  E027  C1            		POP	BC
  E028  C9            		RET
                      	
  E029                	_SYS0A:		;(BDOS)文字列入力
  E029  C5            		PUSH	BC
  E02A  E5            		PUSH	HL
  E02B  D5            		PUSH	DE
  E02C  CD2BE4        		CALL	GETL
  E02F  1120FF        		LD	DE,KBUF
  E032  E1            		POP	HL
  E033  E5            		PUSH	HL
  E034  0E00          		LD	C,0
  E036  3004          		JR	NC,SAX0
  E038  23            		INC	HL
  E039  23            		INC	HL
  E03A  1808          		JR	SAX4
  E03C                	SAX0:
  E03C  46            		LD	B,(HL)
  E03D  23            		INC	HL
  E03E                	SAX1:
  E03E  23            		INC	HL
  E03F  1A            		LD	A,(DE)
  E040  13            		INC	DE
  E041  B7            		OR	A
  E042  2004          		JR	NZ,SAX2
  E044                	SAX4:
  E044  360D          		LD	(HL),00DH
  E046  1804          		JR	SAX3
  E048                	SAX2:
  E048  77            		LD	(HL),A
  E049  0C            		INC	C
  E04A  10F2          		DJNZ	SAX1
  E04C                	SAX3:
  E04C  D1            		POP	DE
  E04D  79            		LD	A,C
  E04E  13            		INC	DE
  E04F  12            		LD	(DE),A
  E050  1B            		DEC	DE
  E051  E1            		POP	HL
  E052  C1            		POP	BC
  E053  A7            		AND	A
  E054  C9            		RET
                      	
  E055                	_SYS0B:		;(BDOS)コンソール状態のチェック
  E055  CDC3DF        		CALL	BREAK
  E058  3A92F4        		LD	A,(_KEYD)
  E05B  B7            		OR	A
  E05C  C8            		RET	Z
  E05D                	CONSTX:
  E05D  CDDFF4        		CALL	_FFLUSH
  E060  E5            		PUSH	HL
  E061  2A90F4        		LD	HL,(_KEYPS)
  E064  7C            		LD	A,H
  E065  AD            		XOR	L
  E066  E1            		POP	HL
  E067  C6FF          		ADD	A,0FFH
  E069  9F            		SBC	A,A
  E06A  C9            		RET
                      	
  E06B                	_SYS2A:		;(BDOS)日付の獲得
  E06B  C5            		PUSH	BC
  E06C  3EED          		LD	A,0EDH		;Read calendar
  E06E  CDF9E2        		CALL	COMOUT
  E071  CDA3E0        		CALL	IN49SB_BCD	;YY
  E074  6F            		LD	L,A
  E075  2600          		LD	H,0
                      	;	LD	DE,1900		;0076CH
                      	;	CP	90		;90以上は1900年代 1990-1999
                      	;	JR	NC,RDDATE1	;90未満は2000年代 2000-2089
                      	;	LD	E,0D0H		;2000 & 0FFH D=007H
  E077  11D007        		LD	DE,2000		;すべて2000年代で処理 2000-2099
  E07A                	RDDATE1:
  E07A  19            		ADD	HL,DE
  E07B  CDDEE2        		CALL	IN49SB		;MW
  E07E  57            		LD	D,A
  E07F  CDA3E0        		CALL	IN49SB_BCD	;DD
  E082  5F            		LD	E,A
  E083  7A            		LD	A,D
  E084  0604          		LD	B,4
  E086                	RDDATE2:
  E086  CB3A          		SRL	D
  E088  10FC          		DJNZ	RDDATE2
  E08A  C1            		POP	BC
  E08B  E607          		AND	7
  E08D  C9            		RET
                      	
  E08E                	_SYS2C:		;(BDOS)時刻の獲得
  E08E  C5            		PUSH	BC
  E08F  3EEF          		LD	A,0EFH		;Read time
  E091  CDF9E2        		CALL	COMOUT
  E094  CDA3E0        		CALL	IN49SB_BCD	;TT
  E097  67            		LD	H,A
  E098  CDA3E0        		CALL	IN49SB_BCD	;MM
  E09B  6F            		LD	L,A
  E09C  CDA3E0        		CALL	IN49SB_BCD	;SS
  E09F  57            		LD	D,A
  E0A0  C1            		POP	BC
  E0A1  AF            		XOR	A
  E0A2  C9            		RET
                      	
  E0A3                	IN49SB_BCD:
  E0A3  CDDEE2        		CALL	IN49SB
                      	;------------------------
                      	;BCDの10進数化
                      	;in
                      	;	A  : BCD
                      	;out
                      	;	A  : 10進数
                      	;------------------------
  E0A6  4F            		LD	C,A
  E0A7  E6F0          		AND	0F0H	;10の位
  E0A9  0F            		RRCA
  E0AA  47            		LD	B,A
  E0AB  0F            		RRCA
  E0AC  0F            		RRCA
  E0AD  80            		ADD	A,B
  E0AE  47            		LD	B,A
  E0AF  79            		LD	A,C
  E0B0  E60F          		AND	00FH	;1の位
  E0B2  80            		ADD	A,B
  E0B3  C9            		RET
                      	
  E0B4                	ESC1:
  E0B4  7B            		LD	A,E
  E0B5  FE41          		CP	'A'
  E0B7  CAFCE1        		JP	Z,CTRL1E
  E0BA  FE42          		CP	'B'
  E0BC  CA64E3        		JP	Z,CTRL1F
  E0BF  FE43          		CP	'C'
  E0C1  CA07E2        		JP	Z,CTRL1C
  E0C4  FE44          		CP	'D'
  E0C6  CAF3E1        		JP	Z,CTRL1D
  E0C9  FE45          		CP	'E'
  E0CB  2802          		JR	Z,CT0CX
  E0CD  FE6A          		CP	'j'
  E0CF                	CT0CX:
  E0CF  CA37E3        		JP	Z,CTRL0C
  E0D2  FE48          		CP	'H'
  E0D4  CA81E2        		JP	Z,CTRL0B
  E0D7  FE4A          		CP	'J'
  E0D9  CA3AE3        		JP	Z,CTRL06
  E0DC  FE4B          		CP	'K'
  E0DE  2807          		JR	Z,CT05X
  E0E0  FE4C          		CP	'L'
  E0E2  CA79E3        		JP	Z,CTRL0E
  E0E5  FE54          		CP	'T'
  E0E7                	CT05X:
  E0E7  CA40E2        		JP	Z,CTRL05
  E0EA  FE78          		CP	'x'
  E0EC  2804          		JR	Z,ESC1X
  E0EE  FE79          		CP	'y'
  E0F0  2002          		JR	NZ,ESC1Y
  E0F2                	ESC1X:
  E0F2  3601          		LD	(HL),1
  E0F4                	ESC1Y:
  E0F4  FE3D          		CP	'='
  E0F6  2804          		JR	Z,ESC1W
  E0F8  FE59          		CP	'Y'
  E0FA  2002          		JR	NZ,ESC1Z
  E0FC                	ESC1W:
  E0FC  3602          		LD	(HL),2
  E0FE                	ESC1Z:
  E0FE  FE20          		CP	020H
  E100  3802          		JR	C,ESC1C
  E102  87            		ADD	A,A
  E103  D0            		RET	NC
  E104                	ESC1C:
  E104  E1            		POP	HL
  E105                	ANK:
  E105  ED4B8EF4      		LD	BC,(_TXADR)
  E109  78            		LD	A,B
  E10A  F638          		OR	038H
  E10C  47            		LD	B,A
  E10D  ED71          		DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
  E10F  CB98          		RES	3,B
  E111  ED59          		OUT	(C),E		;Text
  E113                	KANJIE:
  E113  CDC8E1        		CALL	PRINTE7
  E116                	PRINTE5:
  E116  E1            		POP	HL
  E117  C1            		POP	BC
  E118  AF            		XOR	A
  E119  C9            		RET
                      	
  E11A                	ESC:
  E11A  2116E1        		LD	HL,PRINTE5
  E11D  E5            		PUSH	HL
  E11E  2140E1        		LD	HL,ESCFLG+1
  E121  3600          		LD	(HL),0
  E123  3D            		DEC	A
  E124  288E          		JR	Z,ESC1
  E126  3D            		DEC	A
  E127  2009          		JR	NZ,ESC2
  E129  3603          		LD	(HL),3
  E12B  7B            		LD	A,E
  E12C  D620          		SUB	020H
  E12E  3235E1        		LD	(ESCYP+1),A
  E131  C9            		RET
  E132                	ESC2:
  E132  3D            		DEC	A
  E133  C0            		RET	NZ
  E134  2600          	ESCYP:	LD	H,0
  E136  7B            		LD	A,E
  E137  D620          		SUB	020H
  E139  6F            		LD	L,A
  E13A  C3D6F4        		JP	_LOC
                      	
  E13D                	PRINT:
  E13D  C5            		PUSH	BC
  E13E  E5            		PUSH	HL
  E13F  3E00          	ESCFLG:	LD	A,000H
  E141  B7            		OR	A
  E142  20D6          		JR	NZ,ESC
                      	
  E144  3E1F          		LD	A,01FH
  E146  BB            		CP	E
  E147  3020          		JR	NC,CTRL
  E149  0102E3        	INSFLG:	LD	BC,INSERT
                      	
  E14C  3A1800        		LD	A,(00018H)
  E14F  3C            		INC	A
  E150  28B3          		JR	Z,ANK
  E152  3E00          	KANFLG:	LD	A,000H
  E154  B7            		OR	A
  E155  2025          		JR	NZ,KANJI2
  E157  7B            		LD	A,E
  E158  FE80          		CP	080H
  E15A  38A9          		JR	C,ANK
  E15C  FEA0          		CP	0A0H
  E15E  3804          		JR	C,KANJI1
  E160  FEE0          		CP	0E0H
  E162  38A1          		JR	C,ANK
  E164                	KANJI1:
  E164  3253E1        		LD	(KANFLG+1),A
  E167  18AD          		JR	PRINTE5
                      	
  E169                	CTRL:
  E169  CDAFE1        		CALL	KANCLR
  E16C  7B            		LD	A,E
  E16D  87            		ADD	A,A
  E16E  F680          		OR	080H
  E170  6F            		LD	L,A
  E171  26F5          		LD	H,CTRLTB/256
  E173  7E            		LD	A,(HL)
  E174  2C            		INC	L
  E175  66            		LD	H,(HL)
  E176  6F            		LD	L,A
  E177  CD0F00        		CALL	JP_HL
  E17A  189A          		JR	PRINTE5
                      	
  E17C                	KANJI2:
  E17C  D5            		PUSH	DE
  E17D  57            		LD	D,A
  E17E  01812F        		LD	BC,02F81H	;SFTJIS
  E181  DF            		RST	018H
  E182  01C32F        		LD	BC,02FC3H	;Instead or JISVRM
  E185  DF            		RST	018H
                      	
  E186  ED4B8EF4      		LD	BC,(_TXADR)
  E18A  78            		LD	A,B
  E18B  F638          		OR	038H
  E18D  47            		LD	B,A
  E18E  ED51          		OUT	(C),D		;kanji
  E190  CB98          		RES	3,B
  E192  ED59          		OUT	(C),E		;Text
  E194  CDC8E1        		CALL	PRINTE7
  E197  ED4B8EF4      		LD	BC,(_TXADR)
  E19B  78            		LD	A,B
  E19C  F638          		OR	038H
  E19E  47            		LD	B,A
  E19F  CBF2          		SET	6,D
  E1A1  ED51          		OUT	(C),D		;Kanji
  E1A3  CB98          		RES	3,B
  E1A5  ED59          		OUT	(C),E		;Text
  E1A7  D1            		POP	DE
  E1A8  AF            		XOR	A
  E1A9  3253E1        		LD	(KANFLG+1),A
  E1AC  C313E1        		JP	KANJIE
                      	
  E1AF                	KANCLR:
  E1AF  3A53E1        		LD	A,(KANFLG+1)
  E1B2  B7            		OR	A
  E1B3  C8            		RET	Z
  E1B4  ED4B8EF4      		LD	BC,(_TXADR)
  E1B8  78            		LD	A,B
  E1B9  F638          		OR	038H
  E1BB  47            		LD	B,A
  E1BC  AF            		XOR	A
  E1BD  3253E1        		LD	(KANFLG+1),A
  E1C0  ED79          		OUT	(C),A		;Kanji
  E1C2  CB98          		RES	3,B
  E1C4  3E20          		LD	A,020H
  E1C6  ED79          		OUT	(C),A		;Text
  E1C8                	PRINTE7:
  E1C8  CBA0          		RES	4,B
  E1CA                	PRINTE6:
  E1CA  3A96F4        		LD	A,(_COLORF)
  E1CD                	PRINTE4:
  E1CD  ED79          		OUT	(C),A		;Color
  E1CF  78            		LD	A,B
  E1D0  E607          		AND	7
  E1D2  47            		LD	B,A
  E1D3                	PRINTE2:
  E1D3  03            		INC	BC
  E1D4                	PRINTE3:
  E1D4  2ABAF4        		LD	HL,(_PAGE_MINUS)
  E1D7  A7            		AND	A
  E1D8  ED4A          		ADC	HL,BC
  E1DA                	PRINTE8:
  E1DA  2805          		JR	Z,PRINT2
  E1DC  ED438EF4      		LD	(_TXADR),BC
  E1E0                	CTRL00:
  E1E0  C9            		RET
                      	
  E1E1                	PRINT2:
  E1E1  CD7FE3        		CALL	SCR
  E1E4  2ABCF4        		LD	HL,(_WIDTH_MINUS)
  E1E7  09            		ADD	HL,BC
  E1E8                	SET_TXADR_HL:
  E1E8  228EF4        		LD	(_TXADR),HL
  E1EB  C9            		RET
                      	
  E1EC                	CTRL08:
  E1EC  3A49E1        		LD	A,(INSFLG)
  E1EF  FECD          		CP	0CDH		;CALL ????
  E1F1  2829          		JR	Z,CTRL02
  E1F3                	CTRL1D:
  E1F3  2A8EF4        		LD	HL,(_TXADR)
  E1F6  7C            		LD	A,H
  E1F7  B5            		OR	L
  E1F8  C8            		RET	Z
  E1F9  2B            		DEC	HL
  E1FA  18EC          		JR	SET_TXADR_HL
                      	
  E1FC                	CTRL1E:
  E1FC  ED4B8EF4      		LD	BC,(_TXADR)
  E200  2ABCF4        		LD	HL,(_WIDTH_MINUS)
  E203  09            		ADD	HL,BC
  E204  D0            		RET	NC
  E205  18E1          		JR	SET_TXADR_HL
                      	
  E207                	CTRL1C:
  E207  ED4B8EF4      		LD	BC,(_TXADR)
  E20B  18C6          		JR	PRINTE2
                      	
  E20D                	CTRL09:
  E20D  ED4B8EF4      		LD	BC,(_TXADR)
  E211  79            		LD	A,C
  E212  E6F8          		AND	0F8H
  E214  C608          		ADD	A,8
  E216  4F            		LD	C,A
  E217  88            		ADC	A,B
  E218  91            		SUB	C
  E219  47            		LD	B,A
  E21A  18B8          		JR	PRINTE3
                      	
  E21C                	CTRL02:
  E21C  CDF3E1        		CALL	CTRL1D
  E21F  C8            		RET	Z
  E220  D5            		PUSH	DE
  E221  CDD3F4        		CALL	_POS
  E224  3AB1F4        		LD	A,(_WIDTH)
  E227  95            		SUB	L
  E228  4F            		LD	C,A
  E229  0D            		DEC	C
  E22A  0638          		LD	B,038H
  E22C  2A8EF4        		LD	HL,(_TXADR)
  E22F  09            		ADD	HL,BC
  E230  44            		LD	B,H
  E231  4D            		LD	C,L
  E232  110020        		LD	DE,02000H	;D:Text E:kanji
  E235  2A96F4        		LD	HL,(_COLORF)	;L:Color
  E238                	C8X1:
  E238  CD1EE3        		CALL	C12S
  E23B  0B            		DEC	BC
  E23C  20FA          		JR	NZ,C8X1
  E23E  D1            		POP	DE
  E23F  C9            		RET
                      	
  E240                	CTRL05:
  E240  CDD3F4        		CALL	_POS
  E243  3AB1F4        		LD	A,(_WIDTH)
  E246  95            		SUB	L
  E247  6F            		LD	L,A
  E248                	C08X1:
  E248  ED4B8EF4      		LD	BC,(_TXADR)
  E24C                	LINECL:
  E24C  2620          		LD	H,020H
  E24E  3A96F4        		LD	A,(_COLORF)
  E251  CBE8          		SET	5,B
  E253                	LINECL1:
  E253  CBD8          		SET	3,B
  E255  CBE0          		SET	4,B
  E257  ED71          		DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
  E259  CB98          		RES	3,B
  E25B  ED61          		OUT	(C),H		;Text
  E25D  CBA0          		RES	4,B
  E25F  ED79          		OUT	(C),A		;Color
  E261  03            		INC	BC
  E262  2D            		DEC	L
  E263  20EE          		JR	NZ,LINECL1
  E265  C9            		RET
                      	
  E266                	CTRL0D:
  E266  CDD3F4        		CALL	_POS
  E269  2E00          		LD	L,0
  E26B                	LOC:
  E26B  C5            		PUSH	BC
  E26C  E5            		PUSH	HL
  E26D  CDAFE1        		CALL	KANCLR
  E270  CD8EE2        		CALL	LOC1
  E273  228EF4        		LD	(_TXADR),HL
  E276  E1            		POP	HL
  E277  C1            		POP	BC
  E278  C9            		RET
                      	
  E279                	CTRL12:
  E279  2149E1        		LD	HL,INSFLG
  E27C  7E            		LD	A,(HL)
  E27D  EECC          		XOR	0CCH		;CD:CALL ???? 1:LD BC,????
  E27F  77            		LD	(HL),A
  E280  C9            		RET
                      	
  E281                	CTRL0B:
  E281  210000        		LD	HL,0
  E284  228EF4        		LD	(_TXADR),HL
  E287  C9            		RET
                      	
  E288                	CTRL1B:
  E288  3E01          		LD	A,1
  E28A  3240E1        		LD	(ESCFLG+1),A
  E28D  C9            		RET
                      	
  E28E                	LOC1:
  E28E  D5            		PUSH	DE
  E28F  4D            		LD	C,L
  E290  0608          		LD	B,8
  E292  5C            		LD	E,H
  E293  1600          		LD	D,0
  E295  2AB0F4        		LD	HL,(CRTCD)
  E298  6A            		LD	L,D
  E299                	LOC2:
  E299  29            		ADD	HL,HL
  E29A  3001          		JR	NC,LOC3
  E29C  19            		ADD	HL,DE
  E29D                	LOC3:
  E29D  10FA          		DJNZ	LOC2
  E29F  09            		ADD	HL,BC
  E2A0  D1            		POP	DE
  E2A1  C9            		RET
                      	
  E2A2                	CONOUT1:
  E2A2  CDB4E2        		CALL	CURSOR
  E2A5  59            		LD	E,C
  E2A6  CDCDF4        		CALL	_PRINT
  E2A9  7B            		LD	A,E
  E2AA  FE0A          		CP	00AH
  E2AC  2006          		JR	NZ,CURSOR
  E2AE  CD66E2        		CALL	CTRL0D
  E2B1  CD40E2        		CALL	CTRL05
  E2B4                	CURSOR:
  E2B4  C5            		PUSH	BC
  E2B5  ED4B8EF4      		LD	BC,(_TXADR)
  E2B9  CBE8          		SET	5,B
  E2BB  ED78          		IN	A,(C)
  E2BD  EE18          		XOR	018H
  E2BF  ED79          		OUT	(C),A
  E2C1  C1            		POP	BC
  E2C2  C9            		RET
                      	
  E2C3                	CTRL07:
  E2C3  2161F4        		LD	HL,BEEPD
  E2C6                	BEEP1:
  E2C6  7E            		LD	A,(HL)
  E2C7  23            		INC	HL
  E2C8  FEFF          		CP	0FFH
  E2CA  C8            		RET	Z
  E2CB  061C          		LD	B,01CH
  E2CD  ED79          		OUT	(C),A
  E2CF  EDA3          		OUTI
  E2D1  18F3          		JR	BEEP1
                      	
  E2D3                	OT49SB:
  E2D3  C5            		PUSH	BC
  E2D4  CDEFE2        		CALL	CANW
  E2D7  010019        		LD	BC,01900H
  E2DA  ED79          		OUT	(C),A
  E2DC  C1            		POP	BC
  E2DD  C9            		RET
                      	
  E2DE                	IN49SB:
  E2DE  C5            		PUSH	BC
  E2DF  01011A        		LD	BC,01A01H
  E2E2                	CANR:
  E2E2  ED78          		IN	A,(C)
  E2E4  E620          		AND	020H
  E2E6  20FA          		JR	NZ,CANR
  E2E8  010019        		LD	BC,01900H
  E2EB  ED78          		IN	A,(C)
  E2ED  C1            		POP	BC
  E2EE  C9            		RET
                      	
  E2EF                	CANW:
  E2EF  01011A        		LD	BC,01A01H
  E2F2  ED48          		IN	C,(C)
  E2F4  CB71          		BIT	6,C
  E2F6  20F7          		JR	NZ,CANW
  E2F8  C9            		RET
                      	
  E2F9                	COMOUT:
  E2F9  FB            		EI
  E2FA  CDD3E2        		CALL	OT49SB
  E2FD  CDEFE2        		CALL	CANW
  E300  F3            		DI
  E301  C9            		RET
                      	
  E302                	INSERT:
  E302  D5            		PUSH	DE
  E303  CDD3F4        		CALL	_POS
  E306  3AB1F4        		LD	A,(_WIDTH)
  E309  95            		SUB	L
  E30A  ED4B8EF4      		LD	BC,(_TXADR)
  E30E  110020        		LD	DE,02000H	;D:Text E:Kanji
  E311  2A96F4        		LD	HL,(_COLORF)	;L:Color
  E314  CBE8          		SET	5,B
  E316                	C12X1:
  E316  CD1EE3        		CALL	C12S
  E319  03            		INC	BC
  E31A  20FA          		JR	NZ,C12X1
  E31C  D1            		POP	DE
  E31D  C9            		RET
                      	
  E31E                	C12S:
  E31E  CBE0          		SET	4,B
  E320  CBD8          		SET	3,B
  E322  ED60          		IN	H,(C)
  E324  ED59          	X1PAT:	OUT	(C),E
  E326  5C            		LD	E,H
  E327  CB98          		RES	3,B
  E329  ED60          		IN	H,(C)
  E32B  ED51          		OUT	(C),D
  E32D  54            		LD	D,H
  E32E  CBA0          		RES	4,B
  E330  ED60          		IN	H,(C)
  E332  ED69          		OUT	(C),L
  E334  6C            		LD	L,H
  E335  3D            		DEC	A
  E336  C9            		RET
                      	
  E337                	CTRL0C:
  E337  CD81E2        		CALL	CTRL0B
  E33A                	CTRL06:
  E33A  ED4B8EF4      		LD	BC,(_TXADR)
  E33E                	C1AX1:
  E33E  78            		LD	A,B
  E33F  F638          		OR	038H
  E341  47            		LD	B,A
  E342  ED71          		DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
  E344  CB98          		RES	3,B
  E346  3E20          		LD	A,020H
  E348  ED79          		OUT	(C),A		;Text
  E34A  CBA0          		RES	4,B
  E34C  3A96F4        		LD	A,(_COLORF)
  E34F  ED79          		OUT	(C),A		;Color
  E351  03            		INC	BC
  E352  CBA8          		RES	5,B
  E354  2ABAF4        		LD	HL,(_PAGE_MINUS)
  E357  09            		ADD	HL,BC
  E358  30E4          		JR	NC,C1AX1
  E35A  C9            		RET
                      	
  E35B                	CTRL04:
  E35B  CDD3F4        		CALL	_POS
  E35E  7D            		LD	A,L
  E35F  B7            		OR	A
  E360  C8            		RET	Z
  E361                	CTRL03:
  E361  CD66E2        		CALL	CTRL0D
  E364                	CTRL0A:
  E364                	CTRL1F:
  E364  ED4B8EF4      		LD	BC,(_TXADR)
  E368  2AB1F4        		LD	HL,(_WIDTH)
  E36B  2600          		LD	H,0
  E36D  09            		ADD	HL,BC
  E36E  44            		LD	B,H
  E36F  4D            		LD	C,L
  E370  2ABAF4        		LD	HL,(_PAGE_MINUS)
  E373  09            		ADD	HL,BC
  E374  3F            		CCF
  E375  9F            		SBC	A,A
  E376  C3DAE1        		JP	PRINTE8
                      	
  E379                	CTRL0E:
  E379  CDD3F4        		CALL	_POS
  E37C  7C            		LD	A,H
  E37D  1804          		JR	SCR1
  E37F                	SCR:
  E37F  3A97F4        		LD	A,(_LINE)
  E382  3D            		DEC	A
  E383                	SCR1:
  E383  C5            		PUSH	BC
  E384  D5            		PUSH	DE
  E385  F5            		PUSH	AF
  E386  3E07          		LD	A,7
  E388  21B9E3        		LD	HL,SCRDMAD
  E38B  CDAFE3        		CALL	SETDMA
  E38E  F1            		POP	AF
  E38F  210038        		LD	HL,03800H
                      	
  E392                	SCRUP1:
  E392  B7            		OR	A
  E393  284D          		JR	Z,SCRCL
  E395  F5            		PUSH	AF
  E396  CDC0E3        		CALL	UPSUB		;kanji
  E399  3ABCF4        		LD	A,(_WIDTH_MINUS)
  E39C  5F            		LD	E,A
  E39D  16F7          		LD	D,0F7H
  E39F  19            		ADD	HL,DE
  E3A0  D5            		PUSH	DE
  E3A1  CDC0E3        		CALL	UPSUB		;Text
  E3A4  D1            		POP	DE
  E3A5  19            		ADD	HL,DE
  E3A6  CDC0E3        		CALL	UPSUB		;Color
  E3A9  CBE4          		SET	4,H
  E3AB  F1            		POP	AF
  E3AC  3D            		DEC	A
  E3AD  18E3          		JR	SCRUP1
                      	
  E3AF                	SETDMA:
  E3AF  01871F        		LD	BC,01F87H
  E3B2                	SDMA:
  E3B2  04            		INC	B
  E3B3  EDA3          		OUTI
  E3B5  3D            		DEC	A
  E3B6  20FA          		JR	NZ,SDMA
  E3B8  C9            		RET
                      	
  E3B9                	SCRDMAD:
  E3B9  C3            		DB	0C3H		;WR6 リセット
  E3BA  9A            		DB	09AH		;WR5 ストップ WAIT READY:HIGH
  E3BB  65            		DB	065H		;WR0 ブロック長(LH)
  E3BC  4F00          		DW	79
  E3BE  1C            		DB	01CH		;WR1 ポートAインクリメント I/O
  E3BF  18            		DB	018H		;WR0 ポートAアドレス(LH)
                      	
  E3C0                	UPSUB:
  E3C0  3AB1F4        		LD	A,(_WIDTH)
  E3C3  5F            		LD	E,A
  E3C4  1600          		LD	D,0
  E3C6  3EAD          		LD	A,0ADH		;WR4 連続 ポートB開始アドレス(LH)
  E3C8  ED79          		OUT	(C),A
  E3CA  ED69          		OUT	(C),L		;SOURCE
  E3CC  ED61          		OUT	(C),H
  E3CE  19            		ADD	HL,DE
  E3CF  3E1D          		LD	A,01DH		;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
  E3D1  ED79          		OUT	(C),A
  E3D3  ED69          		OUT	(C),L		;DEST
  E3D5  ED61          		OUT	(C),H
  E3D7                	GO_DMA:
  E3D7  3ECF          		LD	A,0CFH
  E3D9  ED79          		OUT	(C),A		;WR6 ロード
  E3DB  3EB3          		LD	A,0B3H
  E3DD  ED79          		OUT	(C),A		;WR6 強制RDY
  E3DF  ED49          		OUT	(C),C		;WR6 イネーブル
  E3E1  C9            		RET
                      	
  E3E2                	SCRCL:
  E3E2  44            		LD	B,H
  E3E3  4D            		LD	C,L
  E3E4  2AB1F4        		LD	HL,(_WIDTH)
  E3E7  CD4CE2        		CALL	LINECL
  E3EA  D1            		POP	DE
  E3EB  C1            		POP	BC
  E3EC  C9            		RET
                      	
  E3ED                	SCRN:
  E3ED  D5            		PUSH	DE
  E3EE  ED58          		IN	E,(C)		;Text
  E3F0  3A1800        		LD	A,(00018H)
  E3F3  3C            		INC	A
  E3F4  281E          		JR	Z,SCRN2
  E3F6  CBD8          		SET	3,B
  E3F8  ED50          		IN	D,(C)		;Kanji
  E3FA  2816          		JR	Z,SCRN1
  E3FC  AF            		XOR	A
  E3FD  C5            		PUSH	BC
  E3FE  013730        		LD	BC,03037H	;VRMJIS
  E401  DF            		RST	018H
  E402  01522F        		LD	BC,02F52H	;JISSFT
  E405  DF            		RST	018H
  E406  C1            		POP	BC
  E407  ED78          		IN	A,(C)
  E409  CB98          		RES	3,B
  E40B  E640          		AND	040H
  E40D  2005          		JR	NZ,SCRN2
  E40F  7A            		LD	A,D
  E410  D1            		POP	DE
  E411  C9            		RET
  E412                	SCRN1:
  E412  CB98          		RES	3,B
  E414                	SCRN2:
  E414  7B            		LD	A,E
  E415  D1            		POP	DE
  E416  C9            		RET
  E417                	SCRNE:
  E417                	POS:
  E417  2A8EF4        		LD	HL,(_TXADR)
  E41A  C5            		PUSH	BC
  E41B  ED4BBCF4      		LD	BC,(_WIDTH_MINUS)
  E41F  AF            		XOR	A
  E420                	POS1:
  E420  09            		ADD	HL,BC
  E421  3C            		INC	A
  E422  38FC          		JR	C,POS1
  E424  ED42          		SBC	HL,BC
  E426  3D            		DEC	A
  E427  67            		LD	H,A
  E428  C1            		POP	BC
  E429  A7            		AND	A
  E42A  C9            		RET
                      	
  E42B                	GETL:
  E42B  CDD3F4        		CALL	_POS
  E42E  E5            		PUSH	HL
  E42F  3ECD          		LD	A,0CDH		;CALL ????
  E431  3249E1        		LD	(INSFLG),A
  E434                	GETL1:
  E434  CDBEDF        		CALL	_SYS08
  E437  FE09          		CP	9
  E439  2008          		JR	NZ,GETL1V
  E43B  2120FF        		LD	HL,KBUF
  E43E  CDA6DC        		CALL	MSX
  E441  18F1          		JR	GETL1
  E443                	GETL1V:
  E443  5F            		LD	E,A
  E444  CDCDF4        		CALL	_PRINT
                      	
  E447  7B            		LD	A,E
  E448  FE0D          		CP	00DH
  E44A  20E8          		JR	NZ,GETL1
  E44C  3E01          		LD	A,1		;LD BC,????
  E44E  3249E1        		LD	(INSFLG),A
  E451  1120FF        		LD	DE,KBUF
  E454  3AB1F4        		LD	A,(_WIDTH)
  E457  47            		LD	B,A
  E458  CD59DA        		CALL	ZERO_MEMORY_DE
                      	
  E45B  D1            		POP	DE
  E45C  CDD3F4        		CALL	_POS
  E45F  6B            		LD	L,E
  E460  3AB1F4        		LD	A,(_WIDTH)
  E463  95            		SUB	L
  E464  57            		LD	D,A
  E465  CD8EE2        		CALL	LOC1
  E468  4D            		LD	C,L
  E469  7C            		LD	A,H
  E46A  F630          		OR	030H
  E46C  47            		LD	B,A
  E46D  5A            		LD	E,D
  E46E  2120FF        		LD	HL,KBUF
  E471                	GETL2:
  E471  CDD0F4        		CALL	_SCRN
  E474  03            		INC	BC
  E475  77            		LD	(HL),A
  E476  23            		INC	HL
  E477  1D            		DEC	E
  E478  20F7          		JR	NZ,GETL2
  E47A                	GETL3:
  E47A  2B            		DEC	HL
  E47B  7E            		LD	A,(HL)
  E47C  FE21          		CP	021H
  E47E  D0            		RET	NC
  E47F  3600          		LD	(HL),0
  E481  15            		DEC	D
  E482  20F6          		JR	NZ,GETL3
  E484  C9            		RET
                      	
  E485                	INKEY:
  E485  FB            		EI
  E486  E5            		PUSH	HL
  E487  2A90F4        		LD	HL,(_KEYPS)
  E48A  7C            		LD	A,H
  E48B  AD            		XOR	L
  E48C  280B          		JR	Z,INKEY1
  E48E  7C            		LD	A,H
  E48F  3C            		INC	A
  E490  E61F          		AND	01FH
  E492  3291F4        		LD	(_KEYPS+1),A
  E495  6F            		LD	L,A
  E496  26FF          		LD	H,KEYBF/256
  E498  7E            		LD	A,(HL)
  E499                	INKEY1:
  E499  E1            		POP	HL
  E49A  B7            		OR	A
  E49B  C9            		RET
                      	
  0E68                	AT_RS	EQU	SCR1-AT_SCR1
                      	
                      	;LDFILE.ASM
                      	
                      	;	LSX-Dodgers FILE
                      	
                      	;	【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり
                      	
  E49C                	FILEC:
  E49C  CDA7E4        		CALL	FILE
  E49F                	FILEC2:
  E49F  3A15F4        		LD	A,(FDRV+1)
  E4A2  FE20          		CP	020H
  E4A4  C8            		RET	Z
  E4A5  1839          		JR	SETDIR1
                      	
  E4A7                	FILE:
  E4A7  AF            		XOR	A
  E4A8  3214F4        		LD	(FDRV),A
  E4AB  67            		LD	H,A
  E4AC  6F            		LD	L,A
  E4AD  2222F4        		LD	(FDRV+14),HL
  E4B0  CD7EE5        		CALL	SPCUT
  E4B3  CD63E5        		CALL	CCHK3
  E4B6  2812          		JR	Z,DEVI1
  E4B8  13            		INC	DE
  E4B9  1A            		LD	A,(DE)
  E4BA  1B            		DEC	DE
  E4BB  FE3A          		CP	':'
  E4BD  200B          		JR	NZ,DEVI1
  E4BF  1A            		LD	A,(DE)		;DRIVE
  E4C0  CDBEE7        		CALL	CAP
  E4C3  D640          		SUB	'@'
  E4C5  13            		INC	DE
  E4C6  13            		INC	DE
  E4C7  3214F4        		LD	(FDRV),A
  E4CA                	DEVI1:
  E4CA  1A            		LD	A,(DE)
  E4CB  D65C          		SUB	05CH		;\
  E4CD  2009          		JR	NZ,NOROOT
  E4CF  6F            		LD	L,A		;A=0でH=0のはずなのでHL=0
  E4D0  222EF4        		LD	(FDRV+26),HL
  E4D3  2C            		INC	L
  E4D4  2222F4        		LD	(FDRV+14),HL
  E4D7  13            		INC	DE
  E4D8                	NOROOT:
                      	
  E4D8                	SETDIR:
  E4D8  CD04E5        		CALL	FILED
  E4DB  1A            		LD	A,(DE)
  E4DC  FE5C          		CP	05CH		;\
  E4DE  C0            		RET	NZ
  E4DF  13            		INC	DE
  E4E0                	SETDIR1:
  E4E0  3E10          		LD	A,010H		;Directory
  E4E2  3221F4        		LD	(FDRV+13),A
  E4E5  D5            		PUSH	DE
  E4E6  1114F4        		LD	DE,FDRV
  E4E9  2A1EF5        		LD	HL,(STABLE+2*00FH)
  E4EC  CD0F00        		CALL	JP_HL
  E4EF  D1            		POP	DE
  E4F0  B7            		OR	A
  E4F1  C0            		RET	NZ
                      	
  E4F2  3A21F4        		LD	A,(FDRV+13)
  E4F5  CB67          		BIT	4,A
  E4F7  C8            		RET	Z
                      	
  E4F8  CD4BE5        		CALL	FILEI
  E4FB  2A2EF4        		LD	HL,(FDRV+26)
  E4FE  23            		INC	HL
  E4FF  2222F4        		LD	(FDRV+14),HL
  E502  18D4          		JR	SETDIR
                      	
  E504                	FILED:
  E504  CD4BE5        		CALL	FILEI
  E507  2115F4        		LD	HL,FNAME
                      	
  E50A  0608          		LD	B,8
  E50C                	FILE2:
  E50C  CD58E5        		CALL	CCHKF
  E50F  C8            		RET	Z
  E510  FE2A          		CP	'*'
  E512  282E          		JR	Z,FILE9
  E514  FE2E          		CP	'.'
  E516  280C          		JR	Z,FILE4
  E518  77            		LD	(HL),A
  E519  23            		INC	HL
  E51A  10F0          		DJNZ	FILE2
                      	
  E51C                	FILE3:
  E51C  CD58E5        		CALL	CCHKF
  E51F  C8            		RET	Z
  E520  FE2E          		CP	'.'
  E522  20F8          		JR	NZ,FILE3
                      	
  E524                	FILE4:
  E524  211DF4        		LD	HL,FNAME+8
  E527  0603          		LD	B,3
                      	
  E529                	FILE4L:
  E529  CD58E5        		CALL	CCHKF
  E52C  C8            		RET	Z
  E52D  FE2E          		CP	'.'
  E52F  2008          		JR	NZ,FILE12
  E531  3215F4        		LD	(FNAME),A	;Parent directory(..)
  E534  3216F4        		LD	(FNAME+1),A
  E537  3E20          		LD	A,020H
  E539                	FILE12:
  E539  FE2A          		CP	'*'
  E53B  280A          		JR	Z,FILE10
  E53D  77            		LD	(HL),A
  E53E  23            		INC	HL
  E53F  10E8          		DJNZ	FILE4L
  E541  C9            		RET
                      	
  E542                	FILE9:				;名前の*処理、名前の残りを?で埋める
  E542  CD47E5        		CALL	FILE10
  E545  18D5          		JR	FILE3
                      	
  E547                	FILE10:
  E547  3E3F          		LD	A,'?'
  E549  1808          		JR	FILL_MEMORY
  E54B                	FILEI:				;名前＋拡張子をスペースで初期化
  E54B  3E20          		LD	A,020H
  E54D  01000B        		LD	BC,11*256	;C=0にしておく
  E550  2115F4        		LD	HL,FNAME
  E553                	FILL_MEMORY:			;HLからBバイトAで埋める
  E553  77            		LD	(HL),A
  E554  23            		INC	HL
  E555  10FC          		DJNZ	FILL_MEMORY
  E557  C9            		RET
                      	
  E558                	CCHKF:
  E558  1A            		LD	A,(DE)
  E559  CD60E5        		CALL	CCHK2
  E55C  C8            		RET	Z
  E55D  C3CBE8        		JP	FKAN
                      	
  E560                	CCHK2:
  E560  0C            		INC	C
  E561  0D            		DEC	C
  E562  C0            		RET	NZ
  E563                	CCHK3:				;ZF=1 で使えない文字
  E563  FE2B          		CP	'+'
  E565  C8            		RET	Z
  E566  FE2C          		CP	','
  E568  C8            		RET	Z
  E569  FE2F          		CP	'/'
  E56B  C8            		RET	Z
  E56C  FE3A          		CP	':'
  E56E  C8            		RET	Z
  E56F  FE3B          		CP	';'
  E571  C8            		RET	Z
  E572  FE3D          		CP	'='
  E574  C8            		RET	Z
  E575  FE5C          		CP	05CH	;\
  E577  C8            		RET	Z
  E578  FE20          		CP	020H
  E57A  D0            		RET	NC
  E57B  BF            		CP	A		;Z=1
  E57C  C9            		RET
                      	
  E57D                	SS1:
  E57D  13            		INC	DE
  E57E                	SPCUT:				;スペースをカット
  E57E  1A            		LD	A,(DE)
  E57F  FE20          		CP	020H
  E581  28FA          		JR	Z,SS1
  E583  C9            		RET
                      	
  E584                	SETDRVF:
  E584  1114F4        		LD	DE,FDRV
  E587                	SETDRV0:
  E587  CD90E5        		CALL	SETDRV
  E58A  FDE1          		POP	IY
  E58C  C1            		POP	BC
  E58D  D1            		POP	DE
  E58E  E1            		POP	HL
  E58F  C9            		RET
                      	
  E590                	SETDRV:
  E590  E3            		EX	(SP),HL		;HL=RETRN ADDRESS
  E591  D5            		PUSH	DE		;PUSH HL/DE/BC/IY
  E592  C5            		PUSH	BC
  E593  1A            		LD	A,(DE)
  E594  D5            		PUSH	DE
  E595  FDE3          		EX	(SP),IY
                      	
  E597  CD9EE5        		CALL	GETDRV
  E59A  CDD9F4        		CALL	_CHGDRV
                      	
  E59D  E9            		JP	(HL)
                      	
  E59E                	GETDRV:
  E59E  CDB1E5        		CALL	GETDRV1
  E5A1  3288F4        		LD	(_DRV),A
  E5A4  C9            		RET
                      	
  E5A5                	IS_SAME_DRV_A_DE:
                      	;	A と (DE) が同じドライブか調べる
                      	;	ZF=1ならば同じドライブ
  E5A5  CDB1E5        		CALL	GETDRV1
  E5A8  C5            		PUSH	BC
  E5A9  4F            		LD	C,A
  E5AA  1A            		LD	A,(DE)
  E5AB  CDB1E5        		CALL	GETDRV1
  E5AE  A9            		XOR	C
  E5AF  C1            		POP	BC
  E5B0  C9            		RET
  E5B1                	GETDRV1:
  E5B1  E67F          		AND	07FH
  E5B3  D601          		SUB	001H
  E5B5  D0            		RET	NC
  E5B6  3A0400        		LD	A,(_DVSW)	;Current Drive
  E5B9  C9            		RET
                      	
  E5BA                	SOPENX:
  E5BA  1139F4        		LD	DE,SFILE
  E5BD  FD7E00        		LD	A,(IY+0)		;(FCB)ドライブ番号
  E5C0  CDA5E5        		CALL	IS_SAME_DRV_A_DE
  E5C3  2024          		JR	NZ,SOPEN
  E5C5  13            		INC	DE
  E5C6  FDE5          		PUSH	IY
  E5C8  E1            		POP	HL
  E5C9  23            		INC	HL
  E5CA  CD56E7        		CALL	CPFILE
  E5CD  201A          		JR	NZ,SOPEN
                      	
  E5CF  2AF4F5        		LD	HL,(SCDIR)
  E5D2  FD750E        		LD	(IY+14),L	;(FCB)アクセスするディレクトリのクラスタ番号+1
  E5D5  FD740F        		LD	(IY+15),H
                      	
  E5D8  2AF8F5        		LD	HL,(SFNDF)	;Direcroty location and Flags
  E5DB  229FF4        		LD	(_FILEN),HL
                      	
  E5DE  ED5BF6F5      		LD	DE,(SFBPS)
  E5E2  2139F4        		LD	HL,SFILE
  E5E5  36FF          		LD	(HL),0FFH
  E5E7  23            		INC	HL
  E5E8  C9            		RET
  E5E9                	SOPEN:
  E5E9  21FEE6        		LD	HL,FILESE
  E5EC                	SOPENC:
  E5EC  2225E6        		LD	(OPENPAT),HL
                      	
  E5EF  CDE2F4        		CALL	_RDFATX		;Detect Media
  E5F2  3856          		JR	C,RDDERR
                      	
  E5F4  AF            		XOR	A
  E5F5  329FF4        		LD	(_FILEN),A
  E5F8  CDFEE7        		CALL	LDDIRX1		;A=0で呼び出す
  E5FB  2818          		JR	Z,SDIRX1
                      	
  E5FD  CDEFE6        		CALL	READ_DIR	;Sub Directory
  E600  3808          		JR	C,SDIRX0
  E602  2A7EF5        		LD	HL,(_DTBUF)
  E605  7E            		LD	A,(HL)
  E606  FE2E          		CP	'.'
  E608  280F          		JR	Z,SOPEN1
  E60A                	SDIRX0:
  E60A  AF            		XOR	A
  E60B  32A0F4        		LD	(_DIRF),A
  E60E  FD360E01      		LD	(IY+14),1	;(FCB)レコードサイズ
  E612  FD770F        		LD	(IY+15),A
  E615                	SDIRX1:
  E615  ED5BFCF5      		LD	DE,(_DIRPS)	;Root Directory
  E619                	SOPEN1:
  E619  0E20          		LD	C,32		;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
  E61A                	SDECPAT	EQU	$-1
  E61B                	SOPEN1X:
  E61B  CDEFE6        		CALL	READ_DIR	;FILE SEARCH
  E61E  382A          		JR	C,RDDERR
  E620  2A7EF5        		LD	HL,(_DTBUF)
  E623                	SOPEN2:
  E623  D5            		PUSH	DE
  E624  CDFEE6        		CALL	FILESE		;(self-modifying code)
  E625                	OPENPAT	EQU	$-2
  E627  D1            		POP	DE
  E628  386D          		JR	C,SOPENE
  E62A  281B          		JR	Z,SCF_FF_RET
  E62C                	SOPEN3:
  E62C  3AA0F4        		LD	A,(_DIRF)	;ディレクトリか判別
  E62F  B7            		OR	A
  E630  200C          		JR	NZ,SOPEN5
  E632  13            		INC	DE		;ルートディレクトリ
  E633  E5            		PUSH	HL
  E634  210C00        		LD	HL,12		;(self-modifying code)MAXDIR
  E635                	MD_PAT	EQU	$-2
  E637  ED52          		SBC	HL,DE		;CF=0 なので SUB HL,DE
  E639  E1            		POP	HL
  E63A  20DD          		JR	NZ,SOPEN1
  E63C  1807          		JR	SOPEN6
  E63E                	SOPEN5:
  E63E  CD14EF        		CALL	GNCLX		;END DIR
  E641  D8            		RET	C
  E642  CDB6E7        		CALL	ENDCL
  E645                	SOPEN6:
  E645  38D2          		JR	C,SOPEN1
  E647                	SCF_FF_RET:
  E647  37            		SCF			;CF=1
  E648  9F            		SBC	A,A		;A=0FFH
  E649  C9            		RET
                      	
  E64A                	RDDERR:
  E64A  BF            		CP	A		;READ ERR CF=1 ZF=1
  E64B  37            		SCF
  E64C  C9            		RET
                      	
  E64D                	NOPEN:
  E64D  21FEE6        		LD	HL,FILESE
  E650  2225E6        		LD	(OPENPAT),HL
  E653  FD2A98F4      		LD	IY,(_FCB)
  E657  CDDEE8        		CALL	CHKWILDX
  E65A  30EB          		JR	NC,SCF_FF_RET
  E65C  FD7E00        		LD	A,(IY+0)
  E65F  CD9EE5        		CALL	GETDRV
  E662  CDD9F4        		CALL	_CHGDRV
  E665  D8            		RET	C
  E666  2AF8F5        		LD	HL,(SFNDF)	;Direcroty location and Flags
  E669  229FF4        		LD	(_FILEN),HL
                      	
  E66C  CDF9E7        		CALL	LDDIRX
  E66F  ED5B9AF4      		LD	DE,(_FBPS)
  E673  CDEFE6        		CALL	READ_DIR
  E676  38D2          		JR	C,RDDERR
  E678  3A9EF4        		LD	A,(_FBCNT)
  E67B  3D            		DEC	A
  E67C  28AE          		JR	Z,SOPEN3
  E67E                	NOPEN2:
  E67E  2A9CF4        		LD	HL,(_FBAD)
  E681  012000        		LD	BC,020H
  E684  09            		ADD	HL,BC
  E685  4F            		LD	C,A
  E686  189B          		JR	SOPEN2
                      	
  E688                	SOPENE2:
  E688  229CF4        		LD	(_FBAD),HL
  E68B  79            		LD	A,C
  E68C  329EF4        		LD	(_FBCNT),A
  E68F  ED539AF4      		LD	(_FBPS),DE
  E693  FD2298F4      		LD	(_FCB),IY
  E697                	SOPENE:
  E697  AF            		XOR	A
  E698  C9            		RET
                      	
  E699                	COPEN:
  E699  FD360D20      		LD	(IY+13),020H	;(FCB)属性(アトリビュート)
                      	
  E69D  211BE7        		LD	HL,NEXTSE
  E6A0  CDECE5        		CALL	SOPENC
  E6A3  D0            		RET	NC
  E6A4  C8            		RET	Z
  E6A5  3AA0F4        		LD	A,(_DIRF)	;ディレクトリか判別
  E6A8  B7            		OR	A
  E6A9  37            		SCF
  E6AA  C8            		RET	Z		;ルートディレクトリ
  E6AB  0601          		LD	B,1
  E6AD  CD3DE9        		CALL	WRDF
  E6B0  D8            		RET	C
  E6B1  ED5BFEF5      		LD	DE,(_CLPS)
  E6B5  D5            		PUSH	DE
  E6B6  CD7FE7        		CALL	DCPAT
  E6B9  CD98ED        		CALL	DRDNX
  E6BC  2A7EF5        		LD	HL,(_DTBUF)	;ディレクトリエントリを0クリア
  E6BF  3A7EEC        		LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
  E6C2  47            		LD	B,A
  E6C3  AF            		XOR	A
  E6C4  4F            		LD	C,A
  E6C5                	COPENCL:
  E6C5  77            		LD	(HL),A
  E6C6  EDA1          		CPI			;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
  E6C8  EAC5E6        		JP	PE,COPENCL
                      	
  E6CB  3A9DE7        		LD	A,(SPCPAT)	;1クラスタの論理セクタ数
  E6CE  3D            		DEC	A
  E6CF  2819          		JR	Z,COPENE
  E6D1  3E01          		LD	A,1		;1セクタ辺りのセクタ数が2以上の場合
  E6D3  320CEF        		LD	(_SECPS),A
  E6D6  D1            		POP	DE		;DE=(_CLPS)
  E6D7  D5            		PUSH	DE
  E6D8                	COPEN1:
  E6D8  D5            		PUSH	DE		;データバッファに入らないセクタもゼロクリア
  E6D9  C5            		PUSH	BC
  E6DA  2A7EF5        		LD	HL,(_DTBUF)
  E6DD  CD99E7        		CALL	CLUSTX
  E6E0  CDA8F0        		CALL	DWT24
  E6E3  C1            		POP	BC
  E6E4  D1            		POP	DE
  E6E5  CD0BEF        		CALL	NEXTX
  E6E8  20EE          		JR	NZ,COPEN1
  E6EA                	COPENE:
  E6EA  2A7EF5        		LD	HL,(_DTBUF)
  E6ED  D1            		POP	DE
  E6EE  C9            		RET
                      	
  E6EF                	READ_DIR:
  E6EF  ED53FEF5      		LD	(_CLPS),DE
  E6F3  C5            		PUSH	BC
  E6F4  D5            		PUSH	DE
  E6F5  CD7FE7        		CALL	DCPAT
  E6F8  CD78ED        		CALL	DRDX
  E6FB  D1            		POP	DE
  E6FC  C1            		POP	BC
  E6FD  C9            		RET
                      	
  E6FE                	FILESE:
  E6FE  7E            		LD	A,(HL)
  E6FF  B7            		OR	A
  E700  C8            		RET	Z		;END:ZF=1 CF=0
  E701  FEE5          		CP	0E5H
  E703  280E          		JR	Z,FILESE1
  E705  FDE5          		PUSH	IY
  E707  D1            		POP	DE
  E708  13            		INC	DE
  E709  E5            		PUSH	HL
  E70A  CD56E7        		CALL	CPFILE
  E70D  CC77E7        		CALL	Z,CPFILE2
  E710  E1            		POP	HL
  E711  37            		SCF
  E712  C8            		RET	Z		;!!!:(ZF=1) CF=1
  E713                	FILESE1:
  E713  CD2AE7        		CALL	FNEXT
  E716  20E6          		JR	NZ,FILESE
  E718                	ZF0_CF0_AFF_RET:
  E718  F6FF          		OR	0FFH		;ZF=0 CF=0
  E71A  C9            		RET
                      	
  E71B                	NEXTSE:
  E71B  7E            		LD	A,(HL)
  E71C  B7            		OR	A
  E71D  37            		SCF
  E71E  C8            		RET	Z		;!!!:ZF=1 CF=1
  E71F  FEE5          		CP	0E5H
  E721  37            		SCF
  E722  C8            		RET	Z		;!!!:(ZF=1) CF=1
  E723  CD2AE7        		CALL	FNEXT
  E726  20F3          		JR	NZ,NEXTSE
  E728  18EE          		JR	ZF0_CF0_AFF_RET
                      	
  E72A                	FNEXT:
  E72A  E5            		PUSH	HL
  E72B  219FF4        		LD	HL,_FILEN
  E72E  34            		INC	(HL)
  E72F  E1            		POP	HL
  E730  112000        		LD	DE,020H
  E733  19            		ADD	HL,DE
  E734  0D            		DEC	C
  E735  C9            		RET
                      	
  E736                	CPNAME:
  E736  C5            		PUSH	BC
  E737  D5            		PUSH	DE
  E738  E5            		PUSH	HL
  E739  CD50E7        		CALL	CPFILE4
  E73C  E1            		POP	HL
  E73D  23            		INC	HL
  E73E  23            		INC	HL
  E73F  23            		INC	HL
  E740  23            		INC	HL
  E741  D1            		POP	DE
  E742  C1            		POP	BC
  E743  2005          		JR	NZ,CPNAME1
  E745  7E            		LD	A,(HL)
  E746  23            		INC	HL
  E747  66            		LD	H,(HL)
  E748  6F            		LD	L,A
  E749  C9            		RET
  E74A                	CPNAME1:
  E74A  23            		INC	HL
  E74B  23            		INC	HL
  E74C  10E8          		DJNZ	CPNAME
  E74E  37            		SCF
  E74F  C9            		RET
                      	
  E750                	CPFILE4:
  E750  C5            		PUSH	BC
  E751  010004        		LD	BC,00400H
  E754  1804          		JR	CPSTR1
  E756                	CPFILE:
  E756  C5            		PUSH	BC
  E757  01000B        		LD	BC,00B00H
  E75A                	CPSTR1:
  E75A  1A            		LD	A,(DE)
  E75B  FE3F          		CP	'?'		;Wild card
  E75D  2812          		JR	Z,CPSTR2
  E75F  7E            		LD	A,(HL)
  E760  CDC4E8        		CALL	FKANC
  E763  E5            		PUSH	HL
  E764  67            		LD	H,A
  E765  1A            		LD	A,(DE)
  E766  CB01          		RLC	C
  E768  CDC4E8        		CALL	FKANC
  E76B  CB09          		RRC	C
  E76D  BC            		CP	H		;CP (HL),(DE)
  E76E  E1            		POP	HL
  E76F  2004          		JR	NZ,CPSTR3
  E771                	CPSTR2:
  E771  13            		INC	DE
  E772  23            		INC	HL
  E773  10E5          		DJNZ	CPSTR1
  E775                	CPSTR3:
  E775  C1            		POP	BC
  E776  C9            		RET
                      	
  E777                	CPFILE2:
  E777  FD7E0D        		LD	A,(IY+13)	;(FCB)属性(アトリビュート)
  E77A  F6E1          		OR	0E1H
  E77C  2F            		CPL
  E77D  A6            		AND	(HL)
  E77E  C9            		RET
                      	
  E77F                	DCPAT:
  E77F  0E00          		LD	C,0
  E781  2A7EF5        		LD	HL,(_DTBUF)
  E784  3AA0F4        		LD	A,(_DIRF)	;ディレクトリか判別
  E787  B7            		OR	A
  E788  C8            		RET	Z		;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
  E789  3A9DE7        		LD	A,(SPCPAT)
  E78C  4F            		LD	C,A
  E78D  3A0CEF        		LD	A,(_SECPS)
  E790  B9            		CP	C
  E791  3801          		JR	C,DC1
  E793  AF            		XOR	A
  E794                	DC1:
  E794  F680          		OR	080H
  E796  32A0F4        		LD	(_DIRF),A	;bit0-6:セクタインデックス
  E799                	CLUSTX:
  E799  E5            		PUSH	HL
  E79A  EB            		EX	DE,HL
  E79B  AF            		XOR	A
  E79C  0E01          		LD	C,1		;自己書き換え（1クラスタの論理セクタ数）
  E79D                	SPCPAT	EQU	$-1
  E79E                	L_CLDBL:
  E79E  CB19          		RR	C		;->CF
  E7A0  3804          		JR	C,E_CLDBL
  E7A2  29            		ADD	HL,HL		;*2
  E7A3  8F            		ADC	A,A
  E7A4  18F8          		JR	L_CLDBL
  E7A6                	E_CLDBL:
  E7A6  4F            		LD	C,A
  E7A7  3A0CEF        		LD	A,(_SECPS)
  E7AA  B5            		OR	L
  E7AB  6F            		LD	L,A
  E7AC  110800        		LD	DE,8	;+8 (2D)  !ADDCL (self-modifying code)
  E7AD                	CLSPAT	EQU	$-2
  E7AF  AF            		XOR	A
  E7B0  19            		ADD	HL,DE	;データ格納領域の先頭論理セクタ番号
  E7B1  89            		ADC	A,C
  E7B2  4F            		LD	C,A
  E7B3  EB            		EX	DE,HL
  E7B4  E1            		POP	HL
  E7B5  C9            		RET
                      	
  E7B6                	ENDCL:
  E7B6  7A            		LD	A,D	;END CLUSTER
  E7B7  FE01          		CP	1	;164=356	(self-modifying code)
  E7B8                	CLPAT1	EQU	$-1
  E7B9  C0            		RET	NZ
  E7BA  7B            		LD	A,E
  E7BB  FE64          		CP	064H	;		(self-modifying code)
  E7BC                	CLPAT2	EQU	$-1
  E7BD  C9            		RET
                      	
  E7BE                	CAP:
  E7BE  FE61          		CP	'a'
  E7C0  D8            		RET	C
  E7C1  FE7B          		CP	'z'+1
  E7C3  D0            		RET	NC
  E7C4  D620          		SUB	020H
  E7C6  C9            		RET
  E7C7                	CAP2:
  E7C7  CDBEE7        		CALL	CAP
  E7CA                	CAP3:				;
  E7CA  FE05          		CP	5
  E7CC  2803          		JR	Z,CAP4
  E7CE  FE21          		CP	021H
  E7D0  C9            		RET
  E7D1                	CAP4:
  E7D1  3EE5          		LD	A,0E5H
  E7D3  C9            		RET
                      	
  E7D4                	CHDIR:
  E7D4  CDBBF1        		CALL	GETDPBD
  E7D7  381D          		JR	C,CHDIR2
  E7D9  DD751A        		LD	(IX+DPB_SDIR),L
  E7DC  DD741B        		LD	(IX+DPB_SDIR+1),H
  E7DF  1815          		JR	CHDIR2		;POP_IX_RET
                      	
  E7E1                	LDDIR:
  E7E1  CDBBF1        		CALL	GETDPBD
  E7E4  DD5E1A        		LD	E,(IX+DPB_SDIR)
  E7E7  DD561B        		LD	D,(IX+DPB_SDIR+1)
  E7EA  13            		INC	DE
  E7EB  FD730E        		LD	(IY+14),E	;(FCB)アクセスするディレクトリのクラスタ番号+1
  E7EE  FD720F        		LD	(IY+15),D
  E7F1  1B            		DEC	DE
  E7F2  AF            		XOR	A
  E7F3  32A0F4        		LD	(_DIRF),A
  E7F6                	CHDIR2:
  E7F6  DDE1          		POP	IX
  E7F8  C9            		RET
                      	
  E7F9                	LDDIRX:
  E7F9  3AA0F4        		LD	A,(_DIRF)	;(FCB)アクセスするディレクトリのセクタインデックス
  E7FC  E67F          		AND	07FH
  E7FE                	LDDIRX1:
  E7FE  320CEF        		LD	(_SECPS),A
  E801  FD5E0E        		LD	E,(IY+14)	;(FCB)アクセスするディレクトリのクラスタ番号+1
  E804  FD560F        		LD	D,(IY+15)
  E807  1B            		DEC	DE
  E808  CDB6E7        		CALL	ENDCL
  E80B  D4E1E7        		CALL	NC,LDDIR
  E80E                	LDDIRS:
  E80E  7A            		LD	A,D
  E80F  B3            		OR	E
  E810  32A0F4        		LD	(_DIRF),A	;ディレクトリか判別
  E813  C9            		RET
                      	
  E814                	KILL:
  E814  CDDEE8        		CALL	CHKWILDX
  E817  3834          		JR	C,KILLW
  E819  CDBAE5        		CALL	SOPENX
  E81C                	KILLS:
  E81C  3E1F          		LD	A,01FH
  E81E  D460E8        		CALL	NC,CHKATT
  E821  D8            		RET	C
  E822                	KILLSX:
  E822  36E5          		LD	(HL),0E5H	;DIR
  E824  CDB8E8        		CALL	WTDB
  E827  111A00        		LD	DE,01AH
  E82A  19            		ADD	HL,DE
  E82B  5E            		LD	E,(HL)
  E82C  23            		INC	HL
  E82D  56            		LD	D,(HL)
  E82E                	KILLS1:
  E82E  CDB6E7        		CALL	ENDCL
  E831  D0            		RET	NC		;CF=0
  E832  21FEFF        		LD	HL,0-2
  E835  19            		ADD	HL,DE
  E836  D0            		RET	NC		;DE= 0 or 1
  E837  D5            		PUSH	DE
  E838  CDF7F4        		CALL	_GNCL
  E83B  ED53FEF5      		LD	(_CLPS),DE
  E83F  D1            		POP	DE
  E840  210000        		LD	HL,0
  E843  D4FAF4        		CALL	NC,_SNCL
  E846  D8            		RET	C
  E847  ED5BFEF5      		LD	DE,(_CLPS)	;FAT
  E84B  18E1          		JR	KILLS1
                      	
  E84D                	KILLW:
  E84D  CDE9E5        		CALL	SOPEN
  E850                	KILLW1:
  E850  380B          		JR	C,KILLW2
  E852  CD88E6        		CALL	SOPENE2
  E855  CD1CE8        		CALL	KILLS
  E858  CD4DE6        		CALL	NOPEN
  E85B  18F3          		JR	KILLW1
  E85D                	KILLW2:
  E85D  C8            		RET	Z
  E85E  3F            		CCF
  E85F  C9            		RET
                      	
  E860                	CHKATT:
  E860  E5            		PUSH	HL
  E861  110B00        		LD	DE,00BH
  E864  19            		ADD	HL,DE
  E865  A6            		AND	(HL)
  E866  E1            		POP	HL
  E867  C8            		RET	Z
  E868  37            		SCF
  E869  C9            		RET
                      	
  E86A                	NAME:
  E86A  CDDEE8        		CALL	CHKWILDX
  E86D  D8            		RET	C
  E86E  110400        		LD	DE,4
  E871  19            		ADD	HL,DE
  E872  2287E8        		LD	(NAMEP),HL
  E875  23            		INC	HL
  E876  CDE2E8        		CALL	CHKWILD
  E879  D8            		RET	C
                      	
  E87A  CDBAE5        		CALL	SOPENX
  E87D  3E0F          		LD	A,00FH
  E87F  D460E8        		CALL	NC,CHKATT
  E882  D8            		RET	C
                      	
  E883  FDE5          		PUSH	IY
  E885  FD210000      		LD	IY,0		;自己書き換え
  E887                	NAMEP	EQU	$-2
  E889  CDBAE5        		CALL	SOPENX
  E88C  FDE3          		EX	(SP),IY
  E88E  3F            		CCF
  E88F  D4E9E5        		CALL	NC,SOPEN
  E892  EB            		EX	DE,HL
  E893  E1            		POP	HL
  E894  D8            		RET	C
                      	
  E895                	SETNAME:
  E895  01000B        		LD	BC,11*256
  E898  23            		INC	HL
  E899  7E            		LD	A,(HL)
  E89A  FEE5          		CP	0E5H
  E89C  2004          		JR	NZ,SNAME1
  E89E  3E05          		LD	A,5
  E8A0  180E          		JR	SNAME3
  E8A2                	SNAME1:
  E8A2  7E            		LD	A,(HL)
  E8A3  0C            		INC	C
  E8A4  0D            		DEC	C
  E8A5  2009          		JR	NZ,SNAME3
  E8A7  CDBEE7        		CALL	CAP
  E8AA  FEA0          		CP	0A0H
  E8AC  2002          		JR	NZ,SNAME3
  E8AE  3E20          		LD	A,020H
  E8B0                	SNAME3:
  E8B0  12            		LD	(DE),A
  E8B1  7E            		LD	A,(HL)
  E8B2  23            		INC	HL
  E8B3  CDCBE8        		CALL	FKAN
  E8B6  10EA          		DJNZ	SNAME1
  E8B8                	WTDB:
  E8B8  3EFF          		LD	A,0FFH
  E8BA  3239F4        		LD	(SFILE),A
  E8BD  3E01          		LD	A,1
  E8BF  32A4F4        		LD	(_WTDBF),A
  E8C2  AF            		XOR	A
  E8C3  C9            		RET
                      	
  E8C4                	FKANC:
  E8C4  CB41          		BIT	0,C
  E8C6  CCC7E7        		CALL	Z,CAP2
  E8C9  1801          		JR	FKANX
  E8CB                	FKAN:			;漢字チェック
  E8CB  13            		INC	DE
  E8CC                	FKANX:
  E8CC  CB41          		BIT	0,C
  E8CE  CB81          		RES	0,C
  E8D0  C0            		RET	NZ
  E8D1  FE80          		CP	080H
  E8D3  D8            		RET	C
  E8D4  FEA0          		CP	0A0H
  E8D6  3803          		JR	C,FKAN1
  E8D8  FEE0          		CP	0E0H
  E8DA  D8            		RET	C
  E8DB                	FKAN1:
  E8DB  0C            		INC	C
  E8DC  A7            		AND	A
  E8DD  C9            		RET
                      	
  E8DE                	CHKWILDX:
  E8DE  FDE5          		PUSH	IY
  E8E0  E1            		POP	HL
  E8E1  23            		INC	HL
  E8E2                	CHKWILD:
  E8E2  060B          		LD	B,11
  E8E4  3E3F          		LD	A,'?'
  E8E6                	CHKWIL1:
  E8E6  BE            		CP	(HL)
  E8E7  23            		INC	HL
  E8E8  37            		SCF
  E8E9  C8            		RET	Z
  E8EA  10FA          		DJNZ	CHKWIL1
  E8EC  AF            		XOR	A
  E8ED  C9            		RET
                      	
  E8EE                	SDIRENT:		;IY=FCB HL=DIR
  E8EE  D5            		PUSH	DE
  E8EF  E5            		PUSH	HL
  E8F0  FDE5          		PUSH	IY
  E8F2  D1            		POP	DE
  E8F3  EB            		EX	DE,HL
  E8F4  CD95E8        		CALL	SETNAME
                      	;				Attribute
  E8F7  FD7E0D        		LD	A,(IY+13)	;(FCB)属性(アトリビュート)
  E8FA  12            		LD	(DE),A
  E8FB  13            		INC	DE
                      	;				Reserved
  E8FC  AF            		XOR	A
  E8FD  060A          		LD	B,10
  E8FF                	SDE1:
  E8FF  12            		LD	(DE),A
  E900  13            		INC	DE
  E901  10FC          		DJNZ	SDE1
                      						;(FCB)更新時刻
  E903  21E4F5        		LD	HL,SDDATA		;(FCB)更新年月日
  E906  060A          		LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
  E908                	SDLOOP:					;(FCB)ファイルのサイズ(バイト単位)
  E908  7E            		LD	A,(HL)
  E909  23            		INC	HL
  E90A  320FE9        		LD	(SDPAT),A
  E90D  FD7E00        		LD	A,(IY+0)	;LD A,(IY+A)
  E90F                	SDPAT	EQU	$-1
  E910  12            		LD	(DE),A
  E911  13            		INC	DE
  E912  10F4          		DJNZ	SDLOOP
                      	
  E914  AF            		XOR	A
  E915  E1            		POP	HL
  E916  D1            		POP	DE
  E917  C9            		RET
                      	
  E918                	WOPEN:
  E918  FD7E0D        		LD	A,(IY+13)	;(FCB)属性(アトリビュート)
  E91B  E61F          		AND	01FH
  E91D  37            		SCF
  E91E  C0            		RET	NZ
  E91F  FD361CFE      		LD	(IY+28),0FEH	;(FCB)オープンモード
  E923                	TOPEN2:
  E923  AF            		XOR	A
  E924                	TOPEN:				;Initializes the time stamp
  E924  FD3617FF      		LD	(IY+23),0FFH	;(FCB)更新時刻
  E928  C9            		RET
                      	
  E929                	WRDFX:
  E929  3A9DE7        		LD	A,(SPCPAT)	;1クラスタの論理セクタ
  E92C                	L_WRFX:
  E92C  1F            		RRA			;->CF
  E92D  3806          		JR	C,E_WRFX
  E92F  CB39          		SRL	C
  E931  CB1C          		RR	H		;CH=CH/2
  E933  18F7          		JR	L_WRFX
  E935                	E_WRFX:
  E935  41            		LD	B,C
  E936  4C            		LD	C,H
  E937  03            		INC	BC
  E938  3E37          		LD	A,037H		;SCF
  E93A  3295ED        		LD	(DRDN1),A
                      	
  E93D                	WRDF:				;BCクラスタ分FATを確保する
  E93D  110200        		LD	DE,2
  E940  AF            		XOR	A
  E941  320CEF        		LD	(_SECPS),A
  E944                	WRDF1:
  E944  C5            		PUSH	BC
  E945  D5            		PUSH	DE
  E946  CDF7F4        		CALL	_GNCL
  E949  381C          		JR	C,WRDF3
  E94B  7A            		LD	A,D		;空いているかチェック
  E94C  B3            		OR	E
  E94D  202A          		JR	NZ,WRDF4
  E94F  E1            		POP	HL		;HL=空いているクラスタ
  E950  E5            		PUSH	HL
  E951  ED5BFEF5      		LD	DE,(_CLPS)	;DE=元の(_CLPS)
  E955  22FEF5        		LD	(_CLPS),HL
  E958  7A            		LD	A,D		;元の(_CLPS)が 0 か?
  E959  B3            		OR	E
  E95A  2008          		JR	NZ,WRDF2
  E95C  FD751A        		LD	(IY+26),L	;(FCB)ファイルの先頭クラスタ
  E95F  FD741B        		LD	(IY+27),H	;元が空の場合はFCBにクラスタをセットする
  E962  1803          		JR	WRDF3
  E964                	WRDF2:
  E964  CDFAF4        		CALL	_SNCL
  E967                	WRDF3:
  E967  D1            		POP	DE
  E968  C1            		POP	BC
  E969  D8            		RET	C
  E96A  0B            		DEC	BC
  E96B  78            		LD	A,B
  E96C  B1            		OR	C
  E96D  200C          		JR	NZ,WRDF5	;ここでループカウンタチェック
  E96F  ED5BFEF5      		LD	DE,(_CLPS)
  E973  21FFFF        		LD	HL,0FFFFH	;FATエントリ終了(EOCマーク)
  E976  C3FAF4        		JP	_SNCL
                      	
  E979                	WRDF4:				;DEクラスタが空じゃないので次に移動する
  E979  D1            		POP	DE
  E97A  C1            		POP	BC
  E97B                	WRDF5:
  E97B  13            		INC	DE
  E97C  CDB6E7        		CALL	ENDCL
  E97F  38C3          		JR	C,WRDF1
  E981  37            		SCF
  E982  C9            		RET
                      	
  E983                	RWXR:
  E983  3A7EEC        		LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
  E986                	L_RWX:
  E986  1F            		RRA		;->CF
  E987  3808          		JR	C,E_RWX
  E989  CB38          		SRL	B	;BCH=BCH/2
  E98B  CB19          		RR	C	;
  E98D  CB1C          		RR	H	;
  E98F  18F5          		JR	L_RWX
  E991                	E_RWX:
  E991  FD5E1A        		LD	E,(IY+26)	;(FCB)ファイルの先頭クラスタ
  E994  FD561B        		LD	D,(IY+27)
  E997  AF            		XOR	A
  E998  320CEF        		LD	(_SECPS),A
  E99B                	RWX1:
  E99B  ED53FEF5      		LD	(_CLPS),DE
  E99F  7A            		LD	A,D
  E9A0  B3            		OR	E
  E9A1  2813          		JR	Z,SCF_RET	;RET DE==0 => CF=1
                      	
  E9A3  78            		LD	A,B
  E9A4  B1            		OR	C
  E9A5  B4            		OR	H
  E9A6  C8            		RET	Z		;RET BCH==0 => CF=0
                      	
  E9A7  CD14EF        		CALL	GNCLX
  E9AA  D8            		RET	C
  E9AB  7C            		LD	A,H		;
  E9AC  25            		DEC	H		;
  E9AD  B7            		OR	A		;DEC BCH
  E9AE  2001          		JR	NZ,RWX2		;
  E9B0  0B            		DEC	BC		;
  E9B1                	RWX2:
  E9B1  CDB6E7        		CALL	ENDCL
  E9B4  38E5          		JR	C,RWX1
  E9B6                	SCF_RET:
  E9B6  37            		SCF
  E9B7  C9            		RET
                      	
  E9B8                	DSKF:
  E9B8  110000        		LD	DE,0
  E9B9                	MAXCLP	EQU	$-2
  E9BB  2AACF4        		LD	HL,(_FAKEFREE)
  E9BE  7C            		LD	A,H
  E9BF  B5            		OR	L
  E9C0  2803          		JR	Z,DSKF1
  E9C2  110100        		LD	DE,1
  E9C5                	DSKF1:
  E9C5  D5            		PUSH	DE
  E9C6  CDF7F4        		CALL	_GNCL
  E9C9  380C          		JR	C,POPSCF
  E9CB  7A            		LD	A,D
  E9CC  B3            		OR	E
  E9CD  2001          		JR	NZ,DSKF2
  E9CF  23            		INC	HL
  E9D0                	DSKF2:
  E9D0  D1            		POP	DE
  E9D1  1B            		DEC	DE
  E9D2  7A            		LD	A,D
  E9D3  B3            		OR	E
  E9D4  20EF          		JR	NZ,DSKF1
  E9D6  C9            		RET
                      	
  E9D7                	POPSCF:
  E9D7  F1            		POP	AF
  E9D8  37            		SCF
  E9D9  C9            		RET
                      	
  E9DA                	SETTMS:
  E9DA  FD7E17        		LD	A,(IY+23)	;(FCB)ファイルを最後に変更した時刻
  E9DD  3C            		INC	A
  E9DE  C0            		RET	NZ		;ファイルが更新されていない
  E9DF                	SETTMSX:			;FCBに日付時刻をセットする
  E9DF  CD8EE0        		CALL	_SYS2C		;(BDOS)時刻の獲得
                      					;H←時  L←分  D←秒
  E9E2  CB25          		SLA	L		;   *2
  E9E4  CB25          		SLA	L		;   *4
  E9E6  29            		ADD	HL,HL		;*2 *8
  E9E7  29            		ADD	HL,HL		;*4 *16
  E9E8  29            		ADD	HL,HL		;*8 *32
  E9E9  7A            		LD	A,D
  E9EA  0F            		RRCA			;bit.0->7->->->0->C
  E9EB  E61F          		AND	01FH
  E9ED  B5            		OR	L
  E9EE  FD7716        		LD	(IY+22),A	;(FCB)ファイルを最後に変更した時刻
  E9F1  FD7417        		LD	(IY+23),H
                      	
  E9F4  CD6BE0        		CALL	_SYS2A		;(BDOS)日付の獲得
                      					;HL←年  D←月  E←日
  E9F7  0144F8        		LD	BC,0-1980
  E9FA  09            		ADD	HL,BC
  E9FB  65            		LD	H,L
                      	
  E9FC  7A            		LD	A,D
  E9FD  87            		ADD	A,A		;*2
  E9FE  87            		ADD	A,A		;*4
  E9FF  87            		ADD	A,A		;*8
  EA00  87            		ADD	A,A		;*16
  EA01  6F            		LD	L,A
  EA02  29            		ADD	HL,HL		;*32
  EA03  7D            		LD	A,L
  EA04  B3            		OR	E
  EA05  FD7714        		LD	(IY+20),A	;(FCB)ファイルを最後に変更した日付
  EA08  FD7415        		LD	(IY+21),H
  EA0B  C9            		RET
                      	
  EA0C                	PUSHRR:
  EA0C  3280EA        		LD	(SETSEQ_SWC_RND),A
  EA0F  2292EA        		LD	(SETSEQ_SWC_SEQ_RR),HL
  EA12  CD32EA        		CALL	GET_RR_AHL
  EA15  220FF4        		LD	(RR_BUF_HL),HL
  EA18  3211F4        		LD	(RR_BUF_A),A
  EA1B  C9            		RET
                      	
  EA1C                	GET_CPM_R_SIZE:		;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
  EA1C  87            		ADD	A,A		;in BHLA => out AHL
  EA1D  ED6A          		ADC	HL,HL
  EA1F  CB18          		RR	B
  EA21  B7            		OR	A
  EA22  78            		LD	A,B		;ここでフラグは変化しない
  EA23  C8            		RET	Z
  EA24  2C            		INC	L		;INC AHL
  EA25  C0            		RET	NZ		;
  EA26  24            		INC	H		;
  EA27  C0            		RET	NZ		;
  EA28  3C            		INC	A		;
  EA29  C9            		RET
                      	
  EA2A                	INIT_RND:
  EA2A  3ECD          		LD	A,0CDH		;CALL ????
  EA2C  2155EA        		LD	HL,POPRR
  EA2F  CD0CEA        		CALL	PUSHRR
  EA32                	GET_RR_AHL:
  EA32  FD6E21        		LD	L,(IY+33)	;(FCB)Random record
  EA35  FD6622        		LD	H,(IY+34)	;
  EA38  FD7E23        		LD	A,(IY+35)	;
  EA3B  C9            		RET
  EA3C                	INIT_SEQ:
  EA3C  3E01          		LD	A,1		;LD BC,????
  EA3E  2152EA        		LD	HL,SETSEQ
  EA41  CD0CEA        		CALL	PUSHRR
  EA44                	GETSEQ:
  EA44  FD6E20        		LD	L,(IY+32)	;(FCB)カレントレコード
  EA47  FD660C        		LD	H,(IY+12)	;(FCB)カレントブロック
  EA4A  AF            		XOR	A
                      	
  EA4B  CB25          		SLA	L	;L=L*2
                      	
  EA4D  CB3C          		SRL	H	;HL=HL/2
  EA4F  CB1D          		RR	L	;
  EA51  C9            		RET
                      	
  EA52                	SETSEQ:
  EA52  CD5EED        		CALL	SETSEQ1
  EA55                	POPRR:
  EA55  F5            		PUSH	AF
  EA56  E5            		PUSH	HL
  EA57  2A0FF4        		LD	HL,(RR_BUF_HL)
  EA5A  3A11F4        		LD	A,(RR_BUF_A)
  EA5D  CD54ED        		CALL	SET_RR_AHL
  EA60  E1            		POP	HL
  EA61  F1            		POP	AF
  EA62  C9            		RET
                      	
  EA63                	RB_WRITE:
  EA63  C5            		PUSH	BC
  EA64  ED4B4CF5      		LD	BC,(STABLE+2*026H)	;(BDOS)ランダムブロック書き込み
  EA68  1805          		JR	RBRW
  EA6A                	RB_READ:
  EA6A  C5            		PUSH	BC
  EA6B  ED4B4EF5      		LD	BC,(STABLE+2*027H)	;(BDOS)ランダムブロック読み込み
  EA6F                	RBRW:
  EA6F  1F            		RRA		;AHL = AHL*128
  EA70  7C            		LD	A,H	;AHL = AHL0/2
  EA71  1F            		RRA		;A
  EA72  65            		LD	H,L	;
  EA73  CB1C          		RR	H	;H
  EA75  2E00          		LD	L,0	;
  EA77  CB1D          		RR	L	;L
  EA79  CD54ED        		CALL	SET_RR_AHL
  EA7C  218000        		LD	HL,128
  EA7F  C5            		PUSH	BC
  EA80                	SETSEQ_SWC_RND:
  EA80  CD5EED        		CALL	SETSEQ1
  EA83  C1            		POP	BC
  EA84  FDCB20FE      		SET	7,(IY+32)	;(FCB)カレントレコード
  EA88  FDE5          		PUSH	IY
  EA8A  D1            		POP	DE
  EA8B  D5            		PUSH	DE
  EA8C  CD9AEA        		CALL	JP_BC
  EA8F  FDE1          		POP	IY
  EA91  CD52EA        		CALL	SETSEQ
  EA92                	SETSEQ_SWC_SEQ_RR	EQU $-2
  EA94  FDCB20BE      		RES	7,(IY+32)	;(FCB)カレントレコード
                      	
  EA98  C1            		POP	BC
  EA99  C9            		RET
  EA9A                	JP_BC:
  EA9A  C5            		PUSH	BC
  EA9B  C9            		RET
                      	
  E647                	_SYS03	EQU	SCF_FF_RET	;(BDOS)外部入力
  E647                	_SYS2B	EQU	SCF_FF_RET	;(BDOS)日付の設定
  E647                	_SYS2D	EQU	SCF_FF_RET	;(BDOS)時刻の設定
  E647                	_SYS39	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの作成
  E647                	_SYS3A	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの削除
                      	
                      	
                      	;LDFILE2.ASM
                      	
                      	;	LSX-Dodgers FILE2
                      	
                      					;Write random block
  EA9C                	_SYS26:		;(BDOS)ランダムブロック書き込み
  EA9C  AF            		XOR	A
  EA9D  3295ED        		LD	(DRDN1),A	;NOP
  EAA0  22C1EC        		LD	(RBSIZE),HL	;HL←書き込むレコード数
  EAA3  225DF4        		LD	(LEFTX),HL
  EAA6  CD90E5        		CALL	SETDRV
                      	
  EAA9  CD19EC        		CALL	RBX0
  EAAC  DA39EB        		JP	C,RBWERR
  EAAF  CD18E9        		CALL	WOPEN
  EAB2  DA39EB        		JP	C,RBWERR
  EAB5  7C            		LD	A,H
  EAB6  B5            		OR	L
  EAB7  CA32EB        		JP	Z,RBW1
                      	
  EABA  2B            		DEC	HL
                      	
  EABB  CDD7EC        		CALL	GET_RR_BCDE	;BCDE=Random record
                      	
  EABE  19            		ADD	HL,DE		;BCHL=HL+BCDE
  EABF  3001          		JR	NC,S26X1	;
  EAC1  03            		INC	BC		;
  EAC2                	S26X1:
  EAC2  CD83E9        		CALL	RWXR
  EAC5  DC29E9        		CALL	C,WRDFX
  EAC8  DA39EB        		JP	C,RBWERR
                      	
  EACB  CD48EC        		CALL	RBX2
  EACE  281A          		JR	Z,RBWB		;NZ=セクタ以下の端数がある
  EAD0  CD67EC        		CALL	RBXA
  EAD3  3864          		JR	C,RBWERR
  EAD5  EB            		EX	DE,HL
  EAD6  C5            		PUSH	BC
  EAD7  EDB0          		LDIR
  EAD9  225FF4        		LD	(DTAX),HL
                      	
  EADC  CDB8E8        		CALL	WTDB		;バッファデータは更新された
                      	
  EADF  2A5DF4        		LD	HL,(LEFTX)
  EAE2  D1            		POP	DE
  EAE3  ED52          		SBC	HL,DE
  EAE5  225DF4        		LD	(LEFTX),HL
  EAE8  2831          		JR	Z,RBWEND
                      	
  EAEA                	RBWB:
  EAEA  CD9CEC        		CALL	RBXB
  EAED  2814          		JR	Z,RBWC
  EAEF                	RBWB1:
  EAEF  C5            		PUSH	BC
  EAF0  D5            		PUSH	DE
  EAF1  CD99E7        		CALL	CLUSTX
  EAF4  CDEBEC        		CALL	DWTC
  EAF7  D1            		POP	DE
  EAF8  C1            		POP	BC
  EAF9  D414EF        		CALL	NC,GNCLX
  EAFC  383B          		JR	C,RBWERR
  EAFE  10EF          		DJNZ	RBWB1
  EB00  CD3BED        		CALL	DRW_FLUSH
  EB03                	RBWC:
  EB03  CDB4EC        		CALL	RBXC
  EB06  2813          		JR	Z,RBWEND
  EB08  C5            		PUSH	BC
  EB09  CD99E7        		CALL	CLUSTX
  EB0C  CD94ED        		CALL	DRDN
  EB0F  C1            		POP	BC
  EB10  3827          		JR	C,RBWERR
  EB12  ED5B7EF5      		LD	DE,(_DTBUF)
  EB16  EDB0          		LDIR
  EB18  CDB8E8        		CALL	WTDB		;バッファデータは更新された
  EB1B                	RBWEND:
  EB1B  CDC0EC        		CALL	RBXEND
                      	
  EB1E  CD28EC        		CALL	RBX1
  EB21  300F          		JR	NC,RBW1		;ランダムレコードの方が大きい場合はサイズを合わせる
  EB23  CDD7EC        		CALL	GET_RR_BCDE	;BCDE=Random record
  EB26  FD7310        		LD	(IY+16),E	;ファイルのサイズ(バイト単位)
  EB29  FD7211        		LD	(IY+17),D	;
  EB2C  FD7112        		LD	(IY+18),C	;
  EB2F  FD7013        		LD	(IY+19),B	;
  EB32                	RBW1:
  EB32  FDE1          		POP	IY
  EB34  C1            		POP	BC
  EB35  D1            		POP	DE
  EB36  E1            		POP	HL
  EB37                	DD_NUL:
  EB37  AF            		XOR	A
  EB38                	DRDF0:
  EB38                	DWTF0:
  EB38  C9            		RET
                      	
  EB39                	RBWERR:
  EB39  FDE5          		PUSH	IY
  EB3B  D1            		POP	DE
  EB3C  2A20F5        		LD	HL,(STABLE+2*010H)
  EB3F  CD0F00        		CALL	JP_HL
  EB42                	RBRERR1:
  EB42  3E01          		LD	A,001H
  EB44                	RBRERR2:
  EB44  FDE1          		POP	IY
  EB46  C1            		POP	BC
  EB47  D1            		POP	DE
  EB48  E1            		POP	HL
  EB49  37            		SCF
  EB4A  210000        		LD	HL,0
  EB4D  C9            		RET
                      	
  EB4E                	RBRERR:
  EB4E  3EFF          		LD	A,0FFH
  EB50  18F2          		JR	RBRERR2
                      	
  EB52                	RBRFL:
  EB52  3E00          	RBRFLP:	LD	A,000H
  EB54  FE0D          		CP	00DH
  EB56  2005          		JR	NZ,RBRFL1
  EB58  D5            		PUSH	DE
  EB59  1E0A          		LD	E,00AH
  EB5B  1805          		JR	RBRFL2
  EB5D                	RBRFL1:
  EB5D  D5            		PUSH	DE
  EB5E  CD09F4        		CALL	_SYS07
  EB61  5F            		LD	E,A
  EB62                	RBRFL2:
  EB62  CDCDF4        		CALL	_PRINT
  EB65  7B            		LD	A,E
  EB66  D1            		POP	DE
  EB67  3253EB        		LD	(RBRFLP+1),A
  EB6A  C9            		RET
  EB6B                	DDX:
  EB6B  FD7E01        		LD	A,(IY+1)	;(FCB)主ファイル名
  EB6E  CDBEE7        		CALL	CAP
  EB71  FE41          		CP	'A'
  EB73  C9            		RET
                      	
                      					;Read random block
  EB74                	_SYS27:		;(BDOS)ランダムブロック読み込み
  EB74  225DF4        		LD	(LEFTX),HL
  EB77  CD90E5        		CALL	SETDRV
                      	
  EB7A  FDCB0D66      		BIT	4,(IY+13)	;(FCB)属性(アトリビュート)
  EB7E  C207EC        		JP	NZ,RBRDIR	;ディレクトリ
  EB81  CD19EC        		CALL	RBX0
  EB84  DA4EEB        		JP	C,RBRERR
  EB87  CD28EC        		CALL	RBX1
  EB8A  D440EC        		CALL	NC,RBX1R
  EB8D  DA42EB        		JP	C,RBRERR1
  EB90  EB            		EX	DE,HL
  EB91  ED52          		SBC	HL,DE		;CP 00HL,BCDE
  EB93  19            		ADD	HL,DE
  EB94  79            		LD	A,C
  EB95  DE00          		SBC	A,0
  EB97  78            		LD	A,B
  EB98  DE00          		SBC	A,0
  EB9A  3801          		JR	C,RBR1
  EB9C  EB            		EX	DE,HL
  EB9D                	RBR1:
  EB9D  9F            		SBC	A,A
  EB9E  E601          		AND	1
  EBA0  3205EC        		LD	(RBRA_SWC),A
                      	
  EBA3  7C            		LD	A,H
  EBA4  B5            		OR	L
  EBA5  2857          		JR	Z,RBREND0
                      	
  EBA7  22C1EC        		LD	(RBSIZE),HL	;HL←読み込むレコード数
  EBAA  225DF4        		LD	(LEFTX),HL
                      	
  EBAD  CD48EC        		CALL	RBX2
  EBB0  2819          		JR	Z,RBRB
  EBB2  CD67EC        		CALL	RBXA
  EBB5  DA4EEB        		JP	C,RBRERR
  EBB8  C5            		PUSH	BC
  EBB9  EDB0          		LDIR
  EBBB  ED535FF4      		LD	(DTAX),DE
  EBBF  2A5DF4        		LD	HL,(LEFTX)
  EBC2  D1            		POP	DE
  EBC3  A7            		AND	A
  EBC4  ED52          		SBC	HL,DE
  EBC6  225DF4        		LD	(LEFTX),HL
  EBC9  2830          		JR	Z,RBREND
                      	
  EBCB                	RBRB:
  EBCB  CD9CEC        		CALL	RBXB
  EBCE  2815          		JR	Z,RBRC
  EBD0                	RBRB1:
  EBD0  C5            		PUSH	BC
  EBD1  D5            		PUSH	DE
  EBD2  CD99E7        		CALL	CLUSTX
  EBD5  CDF1EC        		CALL	DRDC
  EBD8  D1            		POP	DE
  EBD9  C1            		POP	BC
  EBDA  D414EF        		CALL	NC,GNCLX
  EBDD  DA4EEB        		JP	C,RBRERR
  EBE0  10EE          		DJNZ	RBRB1
  EBE2  CD3BED        		CALL	DRW_FLUSH
  EBE5                	RBRC:
  EBE5  CDB4EC        		CALL	RBXC
  EBE8  2811          		JR	Z,RBREND
  EBEA  C5            		PUSH	BC
  EBEB  CD99E7        		CALL	CLUSTX
  EBEE  CD78ED        		CALL	DRDX
  EBF1  C1            		POP	BC
  EBF2  DA4EEB        		JP	C,RBRERR
  EBF5  EB            		EX	DE,HL
  EBF6  2A7EF5        		LD	HL,(_DTBUF)
  EBF9  EDB0          		LDIR
  EBFB                	RBREND:
  EBFB  CDC0EC        		CALL	RBXEND
  EBFE                	RBREND0:
  EBFE  FDE1          		POP	IY
  EC00  C1            		POP	BC
  EC01  D1            		POP	DE
  EC02  F1            		POP	AF	;(HL)
  EC03  AF            		XOR	A
  EC04  3E00          		LD	A,000H
  EC05                	RBRA_SWC	EQU	$-1
  EC06  C9            		RET
                      	
  EC07                	RBRDIR:
  EC07  FD6E1A        		LD	L,(IY+26)	;(FCB)ファイルの先頭クラスタ
  EC0A  FD661B        		LD	H,(IY+27)
  EC0D  CDD4E7        		CALL	CHDIR
  EC10  AF            		XOR	A
  EC11  67            		LD	H,A
  EC12  6F            		LD	L,A
  EC13  3C            		INC	A
  EC14  3205EC        		LD	(RBRA_SWC),A
  EC17  18E5          		JR	RBREND0
                      	
  EC19                	RBX0:
  EC19  2A8AF4        		LD	HL,(_DTA)
  EC1C  225FF4        		LD	(DTAX),HL
  EC1F  2A5DF4        		LD	HL,(LEFTX)
  EC22  FD7E1C        		LD	A,(IY+28)	;(FCB)オープンモード
  EC25  D6FD          		SUB	0FDH
  EC27  C9            		RET
                      	
  EC28                	RBX1:				;ファイルサイズとランダムレコードを比べる
  EC28  E5            		PUSH	HL		;Record byte
                      					;AHL=File size
  EC29  FD6E10        		LD	L,(IY+16)	;ファイルのサイズ(バイト単位)
  EC2C  FD6611        		LD	H,(IY+17)	;
  EC2F  FD7E12        		LD	A,(IY+18)	;
                      	
  EC32  CDD7EC        		CALL	GET_RR_BCDE	;BCDE=Random record
                      	
  EC35  A7            		AND	A
  EC36  ED52          		SBC	HL,DE
  EC38  99            		SBC	A,C
  EC39  4F            		LD	C,A
  EC3A  FD7E13        		LD	A,(IY+19)	;ファイルのサイズ
  EC3D  98            		SBC	A,B
  EC3E  D1            		POP	DE
  EC3F  C9            		RET
  EC40                	RBX1R:
  EC40  47            		LD	B,A
  EC41  B1            		OR	C
  EC42  EB            		EX	DE,HL	;BCDE=File byte	HL=Record byte
  EC43  B2            		OR	D
  EC44  B3            		OR	E
  EC45  C0            		RET	NZ
  EC46  37            		SCF
  EC47  C9            		RET
                      	
  EC48                	RBX2:				;Cluster settings
  EC48  FD6622        		LD	H,(IY+34)	;(+33)(FCB)ランダムレコード
  EC4B  FD4E23        		LD	C,(IY+35)
  EC4E  0600          		LD	B,0
  EC50  FDCB207E      		BIT	7,(IY+32)	;(FCB)カレントレコード
  EC54  2003          		JR	NZ,RBX3
  EC56  FD4624        		LD	B,(IY+36)
  EC59                	RBX3:
  EC59  CD83E9        		CALL	RWXR
  EC5C  3A7EEC        		LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
  EC5F  3D            		DEC	A
  EC60  FDA622        		AND	(IY+34)
  EC63  FDB621        		OR	(IY+33)
  EC66  C9            		RET
                      	
  EC67                	RBXA:
  EC67  C5            		PUSH	BC
  EC68  D5            		PUSH	DE
  EC69  CD99E7        		CALL	CLUSTX
  EC6C  CD78ED        		CALL	DRDX
  EC6F  D1            		POP	DE
  EC70  C1            		POP	BC
  EC71  D414EF        		CALL	NC,GNCLX
  EC74  D8            		RET	C
  EC75  ED53FEF5      		LD	(_CLPS),DE
                      	
  EC79  FD4E21        		LD	C,(IY+33)	;(FCB)ランダムレコード
  EC7C  210004        	SECSZ:	LD	HL,0400H	;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
  EC7F  7C            		LD	A,H
  EC80  3D            		DEC	A		;1024=3 / 512=1
  EC81  FDA622        		AND	(IY+34)		;(FCB)ランダムレコード
  EC84  47            		LD	B,A		;BCに1セクタ以下の端数が入る
  EC85  ED42          		SBC	HL,BC		;残りを計算
                      	
  EC87  ED5B5DF4      		LD	DE,(LEFTX)
  EC8B  ED52          		SBC	HL,DE		;CP HL,DE
  EC8D  19            		ADD	HL,DE		;
  EC8E  3801          		JR	C,RBXA1		;DEとHLを比較して大きい方をHLに
  EC90  EB            		EX	DE,HL
  EC91                	RBXA1:
  EC91  E5            		PUSH	HL
  EC92  2A7EF5        		LD	HL,(_DTBUF)
  EC95  09            		ADD	HL,BC
  EC96  ED5B5FF4      		LD	DE,(DTAX)
  EC9A  C1            		POP	BC
  EC9B  C9            		RET
                      	
  EC9C                	RBXB:
  EC9C  2A5FF4        		LD	HL,(DTAX)
  EC9F  ED5BFEF5      		LD	DE,(_CLPS)
  ECA3  3A5EF4        		LD	A,(LEFTX+1)
  ECA6  47            		LD	B,A
  ECA7  3A7EEC        		LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
  ECAA                	RBXB1:
  ECAA  1F            		RRA		;->CF
  ECAB  3804          		JR	C,RBXB2
  ECAD  CB38          		SRL	B	;B=B/2
  ECAF  18F9          		JR	RBXB1
  ECB1                	RBXB2:
  ECB1  78            		LD	A,B
  ECB2  B7            		OR	A
  ECB3  C9            		RET
                      	
  ECB4                	RBXC:
  ECB4  ED4B5DF4      		LD	BC,(LEFTX)
  ECB8  3A7EEC        		LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
  ECBB  3D            		DEC	A
  ECBC  A0            		AND	B
  ECBD  47            		LD	B,A		;1セクタ以下の端数がない場合はZ
  ECBE  B1            		OR	C
  ECBF  C9            		RET
                      	
  ECC0                	RBXEND:				;レコード数だけランダムレコードを進める
  ECC0  110000        		LD	DE,0		;進めるレコード数(RBSIZE)
  ECC1                	RBSIZE	EQU	$-2
  ECC3  CD32EA        		CALL	GET_RR_AHL
  ECC6  19            		ADD	HL,DE
  ECC7  CE00          		ADC	A,0
  ECC9  CD54ED        		CALL	SET_RR_AHL
  ECCC  EB            		EX	DE,HL		;HL=進めるレコード数
  ECCD  D0            		RET	NC
  ECCE  FDCB207E      		BIT	7,(IY+32)	;(FCB)カレントレコード
  ECD2  C0            		RET	NZ
  ECD3  FD3424        		INC	(IY+36)
  ECD6  C9            		RET
                      	
  ECD7                	GET_RR_BCDE:			;BCDE=Random record
  ECD7  FD5E21        		LD	E,(IY+33)	;(FCB)ランダムレコード
  ECDA  FD5622        		LD	D,(IY+34)
  ECDD  FD4E23        		LD	C,(IY+35)
  ECE0  0600          		LD	B,0		;CP/M互換のアクセスの場合はFCBは36バイト
  ECE2  FDCB207E      		BIT	7,(IY+32)	;(FCB)カレントレコード
  ECE6  C0            		RET	NZ
  ECE7  FD4624        		LD	B,(IY+36)
  ECEA  C9            		RET
                      	
                      	;	ランダムブロックアクセスの連続したセクタをまとめる
                      	
  ECEB                	DWTC:
  ECEB  E5            		PUSH	HL
  ECEC  21AAF0        		LD	HL,DWT24B
  ECEF  1804          		JR	DWTC1
  ECF1                	DRDC:
  ECF1  E5            		PUSH	HL
  ECF2  219AF0        		LD	HL,DRD24B
  ECF5                	DWTC1:
  ECF5  224FED        		LD	(DRWF_MODE),HL
  ECF8  E1            		POP	HL
  ECF9  3A3FED        		LD	A,(DRWF_B)
  ECFC  B7            		OR	A
  ECFD  200F          		JR	NZ,DRDC1
  ECFF                	SAVE_DRWC:
  ECFF  0601          		LD	B,1
  ED01  ED433EED      		LD	(DRWF_C),BC
  ED05  ED5345ED      		LD	(DRWF_E),DE
  ED09  2248ED        		LD	(DRWF_HL),HL
  ED0C  1820          		JR	INC_HL_DRWC
  ED0E                	DRDC1:
  ED0E  E5            		PUSH	HL
  ED0F  2145ED        		LD	HL,DRWF_E
  ED12  86            		ADD	A,(HL)
  ED13  F5            		PUSH	AF
  ED14  BB            		CP	E
  ED15  201D          		JR	NZ,DRDC2
  ED17  F1            		POP	AF
  ED18  23            		INC	HL
  ED19  7E            		LD	A,(HL)
  ED1A  CE00          		ADC	A,0
  ED1C  F5            		PUSH	AF
  ED1D  BA            		CP	D
  ED1E  2014          		JR	NZ,DRDC2
  ED20  F1            		POP	AF
  ED21  3A3EED        		LD	A,(DRWF_C)
  ED24  CE00          		ADC	A,0
  ED26  B9            		CP	C
  ED27  200C          		JR	NZ,DRDC3
  ED29  213FED        		LD	HL,DRWF_B
  ED2C  34            		INC	(HL)
  ED2D  E1            		POP	HL
  ED2E                	INC_HL_DRWC:
  ED2E  3A7EEC        		LD	A,(SECSZ+2)		;1セクタのサイズの上位1バイト
  ED31  84            		ADD	A,H
  ED32  67            		LD	H,A
  ED33  C9            		RET
  ED34                	DRDC2:
  ED34  F1            		POP	AF
  ED35                	DRDC3:
  ED35  CD3BED        		CALL	DRW_FLUSH
  ED38  E1            		POP	HL
  ED39  18C4          		JR	SAVE_DRWC
                      	
                      	;	ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
  ED3B                	DRW_FLUSH:
  ED3B  C5            		PUSH	BC
  ED3C  D5            		PUSH	DE
  ED3D  010000        		LD	BC,0
  ED3E                	DRWF_C	EQU	$-2
  ED3F                	DRWF_B	EQU	$-1
  ED40  78            		LD	A,B
  ED41  B7            		OR	A
  ED42  280D          		JR	Z,DRDF1
  ED44  110000        		LD	DE,0
  ED45                	DRWF_E	EQU	$-2
  ED46                	DRWF_D	EQU	$-1
  ED47  210000        		LD	HL,0
  ED48                	DRWF_HL	EQU	$-2
  ED4A  AF            		XOR	A
  ED4B  323FED        		LD	(DRWF_B),A
  ED4E  CD9AF0        		CALL	DRD24B
  ED4F                	DRWF_MODE	EQU	$-2
  ED51                	DRDF1:
  ED51  D1            		POP	DE
  ED52  C1            		POP	BC
  ED53  C9            		RET
                      	
  ED54                	SET_RR_AHL:
  ED54  FD7521        		LD	(IY+33),L	;(FCB)Random record
  ED57  FD7422        		LD	(IY+34),H
  ED5A  FD7723        		LD	(IY+35),A
  ED5D  C9            		RET
                      	
  ED5E                	SETSEQ1:
  ED5E  F5            		PUSH	AF
  ED5F  E5            		PUSH	HL		;AHL=Random record
  ED60  CD32EA        		CALL	GET_RR_AHL
  ED63  47            		LD	B,A		;AHL→HLA
  ED64  7D            		LD	A,L		;(IY+33)(FCB)ランダムレコード
  ED65  6C            		LD	L,H		;(IY+34)
  ED66  60            		LD	H,B		;(IY+35)
  ED67  0600          		LD	B,0
                      	
  ED69  CD1CEA        		CALL	GET_CPM_R_SIZE
                      	
  ED6C  29            		ADD	HL,HL
  ED6D  CB3D          		SRL	L		;L=L/2
  ED6F  FD7520        		LD	(IY+32),L	;(FCB)カレントレコード
  ED72  FD740C        		LD	(IY+12),H	;(FCB)カレントブロック
  ED75  E1            		POP	HL
  ED76  F1            		POP	AF
  ED77  C9            		RET
                      	
                      	;LDDIO.ASM
                      	
                      	;	LSX-Dodgers DIO
                      	
  ED78                	DRDX:
  ED78  CDB6ED        		CALL	DRDY
  ED7B  C8            		RET	Z
  ED7C  CD9CED        		CALL	DRDX1		;データバッファの情報を保存
  ED7F  D8            		RET	C
  ED80  E5            		PUSH	HL
  ED81  C5            		PUSH	BC
  ED82  D5            		PUSH	DE
  ED83  2A7EF5        		LD	HL,(_DTBUF)
  ED86  3ADFED        		LD	A,(_DBS24)
  ED89  4F            		LD	C,A
  ED8A  CD98F0        		CALL	DRD24
  ED8D  DCB1ED        		CALL	C,DRDNE
  ED90                	POP_DE_BC_HL_RET:
  ED90  D1            		POP	DE
  ED91  C1            		POP	BC
  ED92  E1            		POP	HL
  ED93  C9            		RET
                      	
                      	;	CDE:セクタ番号
  ED94                	DRDN:
  ED94  AF            		XOR	A
  ED95  00            	DRDN1:	NOP			;自己書き換え NOP / SCF
  ED96  30E0          		JR	NC,DRDX
  ED98                	DRDNX:
  ED98  CDB6ED        		CALL	DRDY
  ED9B  C8            		RET	Z
  ED9C                	DRDX1:
  ED9C  CDCCED        		CALL	DWTX
                      					;データバッファの読み込んだドライブ・セクタ情報を保存
  ED9F  ED53A6F4      		LD	(_DBSEC),DE
  EDA3  79            		LD	A,C
  EDA4  32DFED        		LD	(_DBS24),A
                      	
  EDA7  3A88F4        		LD	A,(_DRV)
  EDAA  32A5F4        		LD	(_DBDRV),A
  EDAD  CDD9F4        		CALL	_CHGDRV
  EDB0  D0            		RET	NC
  EDB1                	DRDNE:
  EDB1  9F            		SBC	A,A		;CF=1ならばA=0FFH
  EDB2  32A5F4        		LD	(_DBDRV),A
  EDB5  C9            		RET
                      	
                      	;	CDE:セクタ番号
  EDB6                	DRDY:
  EDB6  3ADFED        		LD	A,(_DBS24)
  EDB9  B9            		CP	C
  EDBA  C0            		RET	NZ
                      	
  EDBB  E5            		PUSH	HL
  EDBC  3A88F4        		LD	A,(_DRV)
  EDBF  21A5F4        		LD	HL,_DBDRV
  EDC2  AE            		XOR	(HL)
  EDC3  2005          		JR	NZ,POP_HL_RET
                      	
  EDC5  2AA6F4        		LD	HL,(_DBSEC)
  EDC8  ED52          		SBC	HL,DE		;上でXORを使っているのでCF=0のはず
  EDCA                	POP_HL_RET:
  EDCA  E1            		POP	HL
  EDCB  C9            		RET
                      	
  EDCC                	DWTX:
  EDCC  3AA4F4        		LD	A,(_WTDBF)
  EDCF  B7            		OR	A
  EDD0  C8            		RET	Z
  EDD1  AF            		XOR	A
  EDD2  32A4F4        		LD	(_WTDBF),A
                      	
  EDD5  E5            		PUSH	HL
  EDD6  C5            		PUSH	BC
  EDD7  D5            		PUSH	DE
  EDD8  3AA5F4        		LD	A,(_DBDRV)
  EDDB  CDD9F4        		CALL	_CHGDRV
  EDDE  0E00          		LD	C,0
  EDDF                	_DBS24	EQU	$-1
  EDE0  ED5BA6F4      		LD	DE,(_DBSEC)
  EDE4  2A7EF5        		LD	HL,(_DTBUF)
  EDE7  D4A8F0        		CALL	NC,DWT24
  EDEA                	POP_DE_BC_HL_RET2:
  EDEA  18A4          		JR	POP_DE_BC_HL_RET
                      	
  EDEC                	RDFATX:
  EDEC  E5            		PUSH	HL
  EDED  3A88F4        		LD	A,(_DRV)
  EDF0  21AAF4        		LD	HL,_FATDRV
  EDF3  AE            		XOR	(HL)
  EDF4  28D4          		JR	Z,POP_HL_RET
                      	
  EDF6  C5            		PUSH	BC
  EDF7  D5            		PUSH	DE
  EDF8  DDE5          		PUSH	IX
  EDFA  CD16EE        		CALL	WTFATX
  EDFD  3813          		JR	C,POP_IX_DE_BC_HL_RET
                      	
  EDFF  AF            		XOR	A
  EE00  32ABF4        		LD	(_FATIX),A
  EE03  3A88F4        		LD	A,(_DRV)
  EE06  32AAF4        		LD	(_FATDRV),A
  EE09  CDE5F4        		CALL	_RDFAT
  EE0C                	RDFATE2:
  EE0C  3004          		JR	NC,POP_IX_DE_BC_HL_RET
  EE0E  9F            		SBC	A,A		;A=0xFF
  EE0F  32AAF4        		LD	(_FATDRV),A
  EE12                	POP_IX_DE_BC_HL_RET:
  EE12  DDE1          		POP	IX
  EE14  18D4          		JR	POP_DE_BC_HL_RET2
                      	
  EE16                	WTFATX:
  EE16  3AA2F4        		LD	A,(_WTFATF)
  EE19  B7            		OR	A
  EE1A  C8            		RET	Z
  EE1B  E5            		PUSH	HL
  EE1C  3AAAF4        		LD	A,(_FATDRV)
  EE1F  21A5F4        		LD	HL,_DBDRV
  EE22  AE            		XOR	(HL)
  EE23  CCCCED        		CALL	Z,DWTX
  EE26  38A2          		JR	C,POP_HL_RET
  EE28  C5            		PUSH	BC
  EE29  D5            		PUSH	DE
  EE2A  DDE5          		PUSH	IX
  EE2C  CDB5F0        		CALL	WTFAT
  EE2F  AF            		XOR	A
  EE30  32A2F4        		LD	(_WTFATF),A
  EE33  18DD          		JR	POP_IX_DE_BC_HL_RET
                      	
  EE35                	N16CL1:
  EE35  7A            		LD	A,D
  EE36  B3            		OR	E
  EE37  37            		SCF
  EE38  C8            		RET	Z
                      	
  EE39  7A            		LD	A,D
  EE3A  1807          		JR	NCL1X
  EE3C                	NCL1:
  EE3C  7A            		LD	A,D
  EE3D  B3            		OR	E
  EE3E  37            		SCF
  EE3F  C8            		RET	Z
                      	
  EE40  7A            		LD	A,D
  EE41  CB3F          		SRL	A	;/2
  EE43                	NCL1X:
  EE43  CB3F          		SRL	A	;/2
                      	
  EE45  E5            		PUSH	HL
  EE46  3265EE        		LD	(NCLPAT_FATIX),A	;_FATIX
  EE49  2AAAF4        		LD	HL,(_FATDRV)	;L=_FATDRV H=_FATIX
  EE4C  BC            		CP	H
  EE4D  3A88F4        		LD	A,(_DRV)	;LDではフラグは変化しない
  EE50  3264EE        		LD	(NCLPAT_FATDRV),A	;_FATDRV
  EE53  2005          		JR	NZ,NCL2		;FATIXが違う
  EE55  BD            		CP	L
  EE56  2002          		JR	NZ,NCL2		;ドライブが違う
  EE58  E1            		POP	HL
  EE59  C9            		RET
  EE5A                	NCL2:
  EE5A  C5            		PUSH	BC
  EE5B  D5            		PUSH	DE
  EE5C  DDE5          		PUSH	IX
  EE5E  CD16EE        		CALL	WTFATX
  EE61  38AF          		JR	C,POP_IX_DE_BC_HL_RET
  EE63  010000        		LD	BC,0		;自己書き換え C=_FATDRV B=_FATIX
  EE65                	NCLPAT_FATIX	EQU	$-1
  EE64                	NCLPAT_FATDRV	EQU	$-2
  EE66  ED43AAF4      		LD	(_FATDRV),BC
  EE6A  CD8AF0        		CALL	RDFATS
  EE6D  189D          		JR	RDFATE2
                      	
  EE6F                	NCL3:
  EE6F  CB9A          		RES	3,D
  EE71  CB92          		RES	2,D
  EE73  6B            		LD	L,E
  EE74  62            		LD	H,D
  EE75  CB3C          		SRL	H	;
  EE77  CB1D          		RR	L	;HLA=HLA/2
  EE79  1F            		RRA		;
  EE7A  F5            		PUSH	AF
  EE7B  3AABF4        		LD	A,(_FATIX)
  EE7E  0F            		RRCA
  EE7F  300B          		JR	NC,NCL3X1
  EE81  3A7EEC        		LD	A,(SECSZ+2)
  EE84  FE04          		CP	4		;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
  EE86  2004          		JR	NZ,NCL3X1
  EE88  010002        		LD	BC,512
  EE8B  09            		ADD	HL,BC
  EE8C                	NCL3X1:
  EE8C  F1            		POP	AF
  EE8D  ED4B7CF5      		LD	BC,(_FATBF)
  EE91  19            		ADD	HL,DE
  EE92  09            		ADD	HL,BC
  EE93  17            		RLA
  EE94  C9            		RET
                      	
  EE95                	GNCL:
  EE95  CD3CEE        		CALL	NCL1		;GET NEXT CLUSTER
  EE98  D8            		RET	C
  EE99  C5            		PUSH	BC
  EE9A  E5            		PUSH	HL
  EE9B  CD6FEE        		CALL	NCL3
  EE9E  3809          		JR	C,GNC1
  EEA0  5E            		LD	E,(HL)
  EEA1  23            		INC	HL
  EEA2  7E            		LD	A,(HL)
  EEA3  E60F          		AND	00FH
  EEA5  57            		LD	D,A
  EEA6  E1            		POP	HL
  EEA7  C1            		POP	BC
  EEA8  C9            		RET
  EEA9                	GNC1:
  EEA9  7E            		LD	A,(HL)
  EEAA  23            		INC	HL
  EEAB  56            		LD	D,(HL)
  EEAC  0604          		LD	B,4
  EEAE                	GNC1L:
  EEAE  CB3A          		SRL	D	;DA=DA/2
  EEB0  1F            		RRA		;
  EEB1  10FB          		DJNZ	GNC1L
                      	
  EEB3  5F            		LD	E,A
  EEB4  E1            		POP	HL
  EEB5  C1            		POP	BC
  EEB6  A7            		AND	A
  EEB7  C9            		RET
                      	
  EEB8                	SNCL:
  EEB8  CD3CEE        		CALL	NCL1
  EEBB  D8            		RET	C
                      	;				SET NEXT CLUSTER
  EEBC  E5            		PUSH	HL
  EEBD  C5            		PUSH	BC
  EEBE  D5            		PUSH	DE
  EEBF  E5            		PUSH	HL
  EEC0  CD6FEE        		CALL	NCL3
  EEC3  D1            		POP	DE
                      	;CF=ODD
  EEC4  7E            		LD	A,(HL)
  EEC5  73            		LD	(HL),E
  EEC6  3806          		JR	C,SNC1
                      	;EVEN
                      	;M[0] = E
                      	;M[1] = (M[1] & 0xF0) | (D & 0x0F)
  EEC8  23            		INC	HL
  EEC9  ED67          		RRD		;M={A[3:0],E[3:0]}
  EECB  7A            		LD	A,D
  EECC  1804          		JR	SNC11
  EECE                	SNC1:
                      	;ODD
                      	;HL[0] = (HL[0]&0x0F) | (E<<4)
                      	;HL[1] = DE>>4
  EECE  ED6F          		RLD		;M={D[3:0],E[7:4]}
  EED0  23            		INC	HL
  EED1  72            		LD	(HL),D	;M={D[3:0],E[7:4]}
  EED2                	SNC11:
  EED2  ED6F          		RLD		;M={M[7:4],D[3:0]}
  EED4  B7            		OR	A
  EED5  D1            		POP	DE
  EED6  C1            		POP	BC
  EED7  E1            		POP	HL
  EED8                	FAT_CHANGED:
  EED8  3E01          		LD	A,1
  EEDA  32A2F4        		LD	(_WTFATF),A
  EEDD  C9            		RET
                      	
  EEDE                	N16CL3:
  EEDE  C5            		PUSH	BC
  EEDF  6B            		LD	L,E
  EEE0  7A            		LD	A,D
  EEE1  E601          		AND	1
  EEE3  67            		LD	H,A
  EEE4  29            		ADD	HL,HL
  EEE5  ED4B7CF5      		LD	BC,(_FATBF)
  EEE9  09            		ADD	HL,BC
  EEEA  C1            		POP	BC
  EEEB  C9            		RET
                      	
  EEEC                	GNCL16:
  EEEC  CD35EE        		CALL	N16CL1		;GET NEXT CLUSTER for FAT16
  EEEF  D8            		RET	C
  EEF0  E5            		PUSH	HL
  EEF1  CDDEEE        		CALL	N16CL3
  EEF4  5E            		LD	E,(HL)
  EEF5  23            		INC	HL
  EEF6  56            		LD	D,(HL)
  EEF7  E1            		POP	HL
  EEF8  C9            		RET
                      	
  EEF9                	SNCL16:
  EEF9  CD35EE        		CALL	N16CL1		;GET NEXT CLUSTER for FAT16
  EEFC  D8            		RET	C
  EEFD  D5            		PUSH	DE
  EEFE  E5            		PUSH	HL
  EEFF  CDDEEE        		CALL	N16CL3
  EF02  D1            		POP	DE		;HL
  EF03  73            		LD	(HL),E
  EF04  23            		INC	HL
  EF05  72            		LD	(HL),D
  EF06  6B            		LD	L,E
  EF07  62            		LD	H,D
  EF08  D1            		POP	DE
  EF09  18CD          		JR	FAT_CHANGED
                      	
                      	;------------------------
                      	;次のセクタを探す際に_SECPSの値をチェック
                      	;in
                      	;	DE : セクタ番号
                      	;out
                      	;	DE : 次のセクタ番号
                      	;note
                      	;
                      	;------------------------
  EF0B                	NEXTX:
  EF0B  3E00          		LD	A,0	;自己書き換え
  EF0C                	_SECPS	EQU	$-1
  EF0D  3C            		INC	A
  EF0E  E600          		AND	0	;自己書き換え　1クラスタの論理セクタ数-1
  EF0F                	_NCPAT	EQU	$-1
  EF10  320CEF        		LD	(_SECPS),A
  EF13  C9            		RET
                      	
  EF14                	GNCLX:
  EF14  CD0BEF        		CALL	NEXTX
  EF17  C0            		RET	NZ	;1クラスタのセクタ未満の場合は戻る
  EF18  C3F7F4        		JP	_GNCL	;次のクラスタを探す
                      	
  EF1B                	RDFAT:
  EF1B  3E80          		LD	A,080H
  EF1D  3270F4        		LD	(CHECK),A
  EF20                	RDFAT1:
  EF20  3A88F4        		LD	A,(_DRV)
  EF23  CDC4F1        		CALL	CHGDRVR
  EF26  D8            		RET	C
  EF27  DD7E12        		LD	A,(IX+DPB_DEVICE)
  EF2A  CB6F          		BIT	5,A
  EF2C  286C          		JR	Z,RDFAT0X
  EF2E  2170F4        		LD	HL,CHECK
  EF31  A6            		AND	(HL)
  EF32  77            		LD	(HL),A
  EF33  110000        		LD	DE,0		;BPB
  EF36  2A7CF5        		LD	HL,(_FATBF)
  EF39  CD96F0        		CALL	DRD16
  EF3C  3024          		JR	NC,GETBPB
  EF3E  2170F4        		LD	HL,CHECK
  EF41  CB06          		RLC	(HL)
  EF43  3F            		CCF
  EF44  D8            		RET	C
  EF45  DDCB0A1E      		RR	(IX+DPB_FDMODE)
  EF49  3F            		CCF			;フロッピーディスクのFDモードを切り替える
  EF4A  DDCB0A16      		RL	(IX+DPB_FDMODE)
  EF4E  3EFF          		LD	A,0FFH
  EF50  3289F4        		LD	(_DSK),A
  EF53  3A84F4        		LD	A,(_DRIVE)
  EF56  E603          		AND	3
  EF58  F680          		OR	080H
  EF5A  6F            		LD	L,A
  EF5B  26F4          		LD	H,_CYL0/256
  EF5D  3EFF          		LD	A,0FFH
  EF5F  77            		LD	(HL),A
  EF60  18BE          		JR	RDFAT1
  EF62                	GETBPB:
  EF62  FDE5          		PUSH	IY
  EF64  FD2A7CF5      		LD	IY,(_FATBF)	;BPB
  EF68  CDF1F4        		CALL	_BPB2DPB
  EF6B  FDE1          		POP	IY
  EF6D  DD7E12        		LD	A,(IX+DPB_DEVICE)
  EF70  3025          		JR	NC,GETBPBOK
  EF72  E60F          		AND	00FH
  EF74  FE07          		CP	7
  EF76  37            		SCF
  EF77  C0            		RET	NZ
  EF78  DDCB0A46      		BIT	0,(IX+DPB_FDMODE)
  EF7C  21C0F5        		LD	HL,M2D
  EF7F  2006          		JR	NZ,SETFDMODE
  EF81  CD6FF0        		CALL	CHECK1024
  EF84  D8            		RET	C
  EF85  2ED2          		LD	L,M2HD-STABLE
  EF87                	SETFDMODE:
  EF87  DDE5          		PUSH	IX
  EF89  D1            		POP	DE
  EF8A  EDA0          		LDI
  EF8C  EDA0          		LDI
  EF8E  13            		INC	DE
  EF8F  13            		INC	DE
  EF90  13            		INC	DE
  EF91  13            		INC	DE
  EF92  010C00        		LD	BC,12
  EF95  EDB0          		LDIR
  EF97                	GETBPBOK:
  EF97  CD30F1        		CALL	CHGDRV2
  EF9A                	RDFAT0X:
  EF9A  CD8AF0        		CALL	RDFATS
  EF9D  D8            		RET	C
  EF9E  DDAE06        		XOR	(IX+DPB_FATID)
  EFA1  C8            		RET	Z
  EFA2  DDCB126E      		BIT	5,(IX+DPB_DEVICE)
  EFA6  C0            		RET	NZ		;BPBを取得している場合はFATIDをチェックしない
  EFA7  37            		SCF
  EFA8  C9            		RET
                      	
  EFA9                	POP_HL_SCF_RET:
  EFA9  E1            		POP	HL
  EFAA  37            		SCF
  EFAB  C9            		RET
                      	
  EFAC                	BPB2DPB:
  EFAC  FD7E0B        		LD	A,(IY+11)	;BPB_BytsPerSec
  EFAF  B7            		OR	A
  EFB0  37            		SCF
  EFB1  C0            		RET	NZ
  EFB2                	BPBOK:
  EFB2  FD7E0D        		LD	A,(IY+13)	;BPB_SecPerClus
  EFB5  DD7707        		LD	(IX+DPB_SECPCL),A
                      	
  EFB8  FD7E16        		LD	A,(IY+22)	;BPB_FATSz16
  EFBB  DD7700        		LD	(IX+DPB_FATLN),A
  EFBE  FD7E17        		LD	A,(IY+23)	;BPB_FATSz16
  EFC1  DD7701        		LD	(IX+DPB_FATLN+1),A
                      	
  EFC4  FD6E0E        		LD	L,(IY+14)	;BPB_RsvdSecCnt
  EFC7  FD660F        		LD	H,(IY+15)
  EFCA  DD750E        		LD	(IX+DPB_FATPS),L
  EFCD  FD5E16        		LD	E,(IY+22)	;BPB_FATSz16
  EFD0  FD5617        		LD	D,(IY+23)
  EFD3  FD4610        		LD	B,(IY+16)	;BPB_NumFATs
  EFD6                	BPBDP1:				;BPB_FATSz16 * BPB_NumFATs
  EFD6  19            		ADD	HL,DE
  EFD7  10FD          		DJNZ	BPBDP1
  EFD9                	BPBDP2:
  EFD9  DD7510        		LD	(IX+DPB_DIRPS),L
  EFDC  DD7411        		LD	(IX+DPB_DIRPS+1),H
  EFDF  E5            		PUSH	HL
                      	
  EFE0  FD6E11        		LD	L,(IY+17)	;BPB_RootEntCnt
  EFE3  FD6612        		LD	H,(IY+18)
  EFE6  FD7E0C        		LD	A,(IY+12)	;BPB_BytsPerSec
  EFE9  B7            		OR	A
  EFEA  28BD          		JR	Z,POP_HL_SCF_RET
  EFEC  0606          		LD	B,6
  EFEE                	BPBBPS1:
  EFEE  05            		DEC	B
  EFEF  0F            		RRCA
  EFF0  30FC          		JR	NC,BPBBPS1
  EFF2                	BPBDE1:
  EFF2  29            		ADD	HL,HL
  EFF3  10FD          		DJNZ	BPBDE1
                      	
  EFF5  7C            		LD	A,H
  EFF6  DD770B        		LD	(IX+DPB_DIRSCNT),A	;
                      	
  EFF9  D1            		POP	DE		;DPB_DIRPS
  EFFA  6C            		LD	L,H
  EFFB  2600          		LD	H,0
  EFFD  19            		ADD	HL,DE		;MAXDIR
  EFFE  E5            		PUSH	HL
  EFFF  FD4E0D        		LD	C,(IY+13)	;BPB_SecPerClus
  F002  CB21          		SLA	C		;*2
  F004  AF            		XOR	A
  F005  47            		LD	B,A
  F006  ED42          		SBC	HL,BC
  F008  DD7514        		LD	(IX+DPB_ADDCL),L
  F00B  DD7415        		LD	(IX+DPB_ADDCL+1),H
                      	
  F00E  D1            		POP	DE		;DE=DPB_MAXDIR
  F00F  FD6E13        		LD	L,(IY+19)	;BPB_TotSec16
  F012  FD6614        		LD	H,(IY+20)
                      	
  F015  DD7E12        		LD	A,(IX+DPB_DEVICE)
  F018  E60F          		AND	00FH
  F01A  FE07          		CP	7		;フロッピー
  F01C  2019          		JR	NZ,NOT_FD
  F01E  E5            		PUSH	HL
  F01F  FD4E18        		LD	C,(IY+24)	;BPB_SecPerTr
  F022  DD710D        		LD	(IX+DPB_MAXSEC),C
  F025  AF            		XOR	A
  F026  CB21          		SLA	C		;両面なのでセクタ数を２倍
  F028  0610          		LD	B,16
  F02A                	DIVSEC:				;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
  F02A  29            		ADD	HL,HL
  F02B  17            		RLA
  F02C  B9            		CP	C
  F02D  3802          	   	JR	C,DIVSEC1
  F02F  91            	   	SUB	C
  F030  2C            		INC	L
  F031                	DIVSEC1:
  F031  10F7          	 	DJNZ	DIVSEC
  F033  DD750C        		LD	(IX+DPB_MAXCYL),L
  F036  E1            		POP	HL	;ここまでフロッピー専用
  F037                	NOT_FD:
  F037  7C            		LD	A,H
  F038  B5            		OR	L
  F039  3E00          		LD	A,0		;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
  F03B  200E          		JR	NZ,BPB16BIT	;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
  F03D  2F            		CPL			;A=0FFH
  F03E  FD8623        		ADD	A,(IY+35)	;念のために総セクタ数が24ビットを超える場合はエラーを返す
  F041  D8            		RET	C
  F042  FD6E20        		LD	L,(IY+32)	;BPB_TotSec32 は AHL の24ビットで扱う
  F045  FD6621        		LD	H,(IY+33)	;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
  F048  FD7E22        		LD	A,(IY+34)	;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
  F04B                	BPB16BIT:
  F04B  ED52          		SBC	HL,DE		;DE=DPB_MAXDIR
  F04D  DE00          		SBC	A,0
  F04F  FD460D        		LD	B,(IY+13)	;BPB_SecPerClus
  F052                	BPBTC1:				;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
  F052  CB18          		RR	B		;->CY
  F054  3808          		JR	C,BPBTC2
  F056  CB3F          		SRL	A
  F058  CB1C          		RR	H		;AHL=AHL/2
  F05A  CB1D          		RR	L
  F05C  18F4          		JR	BPBTC1
  F05E                	BPBTC2:
  F05E  C6FF          		ADD	A,0FFH
  F060  D8            		RET	C		;念のため(クラスタ数が16ビットを超える場合)
  F061  23            		INC	HL
  F062  23            		INC	HL
  F063  DD7508        		LD	(IX+DPB_MAXCL),L
  F066  DD7409        		LD	(IX+DPB_MAXCL+1),H
                      	
  F069  FD7E15        		LD	A,(IY+21)	;BPB_Media
  F06C  DD7706        		LD	(IX+DPB_FATID),A
  F06F                	CHECK1024:
  F06F  FD7E10        		LD	A,(IY+16)	;BPB_NumFATs
  F072  C6FE          		ADD	A,0-2		;>2:CF=1
  F074  FD7E0C        		LD	A,(IY+12)	;BPB_BytsPerSec
  F077  6F            		LD	L,A
  F078  3002          		JR	NC,BPBFAT1
  F07A  F680          		OR	080H
  F07C                	BPBFAT1:			;ここではCF=0
  F07C  DD770F        		LD	(IX+DPB_BPS),A
  F07F  3A7BF5        		LD	A,(_MAX_SEC_SZ_H)
  F082  BD            		CP	L
  F083  C8            		RET	Z		;1セクタ1024バイト
  F084  2D            		DEC	L		;以下のセクタサイズに合致しない場合はCF=1でエラーにする
  F085  C8            		RET	Z		;1セクタ256バイト
  F086  2D            		DEC	L
  F087  C8            		RET	Z		;1セクタ512バイト
  F088  37            		SCF
  F089  C9            		RET
                      	
  F08A                	RDFATS:
  F08A  CDBBF0        		CALL	FATSETUP
  F08D  D8            		RET	C
  F08E  CD9AF0        		CALL	DRD24B
  F091  2A7CF5        		LD	HL,(_FATBF)
  F094  7E            		LD	A,(HL)
  F095  C9            		RET
                      	
  F096                	DRD16:
  F096  0E00          		LD	C,0
  F098                	DRD24:
  F098  0601          		LD	B,1
  F09A                	DRD24B:
  F09A  DDE5          		PUSH	IX
  F09C  DD2AA8F4      		LD	IX,(_DPB)
  F0A0  CDE2F2        		CALL	FDRD		;自己書き換え（ディスク読み込み）
  F0A1                	DRDPAT	EQU	$-2
  F0A3                	POP_IX_RET:
  F0A3  DDE1          		POP	IX
  F0A5  C9            		RET
                      	
  F0A6                	DWT16:
  F0A6  0E00          		LD	C,0
  F0A8                	DWT24:
  F0A8  0601          		LD	B,1
  F0AA                	DWT24B:
  F0AA  DDE5          		PUSH	IX
  F0AC  DD2AA8F4      		LD	IX,(_DPB)
  F0B0  CDD4F2        		CALL	FDWT		;自己書き換え（ディスク書き込み）
  F0B1                	DWTPAT	EQU	$-2
  F0B3  18EE          		JR	POP_IX_RET
                      	
  F0B5                	WTFAT:
  F0B5  CDBBF0        		CALL	FATSETUP
  F0B8  30F0          		JR	NC,DWT24B
  F0BA  C9            		RET
                      	;	CALL	NC,DWT24B	;予備FATの保存ルーチン
                      	;	RET	C
                      	;	BIT	7,(IX+DPB_BPS)
                      	;	RET	Z		;予備FATが無い
                      	;	CALL	FATS2
                      	;	PUSH	HL		;予備FAT
                      	;	LD	L,(IX+DPB_FATLN)
                      	;	LD	H,(IX+DPB_FATLN+1)
                      	;	ADD	HL,DE
                      	;	EX	DE,HL
                      	;	POP	HL
                      	;	JR	DWT24B
                      	;------------------------
                      	;FATのセットアップ
                      	;out
                      	;	B  : FATセクタ数
                      	;	DE : FAT先頭セクタ番号
                      	;	HL : FATバッファポインタ
                      	;	CF : 1=ドライブ切り替えエラー
                      	;note
                      	;	FATサイズがFATバッファを超える場合は
                      	;	対象クラスタ領域==(_FATIX)によって
                      	;	FAT12:対象クラスタ1024毎に1.5KBを切り替える
                      	;	FAT16:対象クラスタ512毎に1KBを切り替える
                      	;------------------------
  F0BB                	FATSETUP:
  F0BB  3AAAF4        		LD	A,(_FATDRV)
  F0BE  CDC4F1        		CALL	CHGDRVR		;ドライブ切り替え
  F0C1  D8            		RET	C
  F0C2                	FATS2:
  F0C2  DD7E0F        		LD	A,(IX+DPB_BPS)	;512=2 1024=4
  F0C5  0F            		RRCA
  F0C6  CDF6F0        		CALL	FATSETUP12	;自己書き換え
  F0C7                	FATSX	EQU	$-2
  F0C9  210000        		LD	HL,0
  F0CC  4A            		LD	C,D
  F0CD  54            		LD	D,H
  F0CE  3AABF4        		LD	A,(_FATIX)	;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
  F0D1  47            		LD	B,A
  F0D2  04            		INC	B
  F0D3  DD7E00        		LD	A,(IX+DPB_FATLN)
  F0D6                	FAT_SKP:
  F0D6  05            		DEC	B
  F0D7  2809          		JR	Z,FAT1
  F0D9  19            		ADD	HL,DE
  F0DA  93            		SUB	E
  F0DB  30F9          		JR	NC,FAT_SKP
  F0DD  DDCB0146      		BIT	0,(IX+DPB_FATLN+1)	;FATサイズが0100H(256)の場合
  F0E1  C8            		RET	Z
  F0E2                	FAT1:
  F0E2  EB            		EX	DE,HL
  F0E3  B7            		OR	A		;0の場合は0100Hとして扱う
  F0E4  2803          		JR	Z,FAT3
  F0E6  B9            		CP	C		;C=FATバッファに読み込めるセクタ数
  F0E7  3801          		JR	C,FAT2
  F0E9                	FAT3:
  F0E9  79            		LD	A,C
  F0EA                	FAT2:
  F0EA  47            		LD	B,A
                      	
  F0EB  2AFAF5        		LD	HL,(_FATPS)	;fat sector pos
  F0EE  19            		ADD	HL,DE
  F0EF  EB            		EX	DE,HL
  F0F0  2A7CF5        		LD	HL,(_FATBF)
  F0F3  AF            		XOR	A		;CF=0
  F0F4  4F            		LD	C,A
  F0F5  C9            		RET
                      	;
                      	;	FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                      	;	FATSETUP* (FAT12/FAT16)
                      	;out
                      	;	D : FATバッファに読み込める最大のセクタ数
                      	;	E : _FATIXで進めるセクタ数
  F0F6                	FATSETUP12:
  F0F6  110606        		LD	DE,0606H	;256
  F0F9  D8            		RET	C
  F0FA  110303        		LD	DE,0303H	;512
  F0FD  0F            		RRCA
  F0FE  D8            		RET	C
  F0FF  110102        		LD	DE,0201H	;1024
  F102  C9            		RET
                      	
  F103                	FATSETUP16:
  F103  110404        		LD	DE,0404H	;256
  F106  D8            		RET	C
  F107  110202        		LD	DE,0202H	;512
  F10A  0F            		RRCA
  F10B  D8            		RET	C
  F10C  110101        		LD	DE,0101H	;1024
  F10F  C9            		RET
                      	
  F110                	CHGDRV:
  F110  E5            		PUSH	HL
  F111  2189F4        		LD	HL,_DSK
  F114  BE            		CP	(HL)
  F115  280A          		JR	Z,CHGDRVE
  F117                	CHGDRV1:
  F117  DDE5          		PUSH	IX
  F119  CD23F1        		CALL	CHGDRV0
  F11C  3A89F4        		LD	A,(_DSK)
  F11F  DDE1          		POP	IX
  F121                	CHGDRVE:
  F121  E1            		POP	HL
  F122  C9            		RET
                      	
  F123                	CHGDRV0:
  F123  6F            		LD	L,A
  F124  CDDCF4        		CALL	_GETDPB
  F127  D8            		RET	C
  F128  DD22A8F4      		LD	(_DPB),IX
  F12C  7D            		LD	A,L
  F12D  3289F4        		LD	(_DSK),A
  F130                	CHGDRV2:
  F130  C5            		PUSH	BC
  F131  D5            		PUSH	DE
  F132  ED737BF1      		LD	(SPPAT2),SP
  F136  F3            		DI
  F137  DDF9          		LD	SP,IX
                      	
  F139  E1            		POP	HL		;00:DPB_FATLN
  F13A  E1            		POP	HL		;02:DPB_DRD
  F13B  22A1F0        		LD	(DRDPAT),HL
                      	
  F13E  E1            		POP	HL
  F13F  22B1F0        		LD	(DWTPAT),HL	;04:DPB_DWT
                      	
  F142  E1            		POP	HL		;L=06:DPB_FATID H=07:DPB_SECPCL
  F143  7C            		LD	A,H
  F144  329DE7        		LD	(SPCPAT),A	;1クラスタの論理セクタ数
  F147  3D            		DEC	A
  F148  320FEF        		LD	(_NCPAT),A
                      	
  F14B  E1            		POP	HL		;08:DPB_MAXCL
  F14C  7D            		LD	A,L
  F14D  32BCE7        		LD	(CLPAT2),A
  F150  7C            		LD	A,H
  F151  32B8E7        		LD	(CLPAT1),A
  F154  2B            		DEC	HL
  F155  22B9E9        		LD	(MAXCLP),HL
                      	
  F158  E1            		POP	HL		;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
  F159  4C            		LD	C,H
                      	
  F15A  E1            		POP	HL		;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                      	
  F15B  E1            		POP	HL		;L=0E:DPB_FATPS H=0F:DPB_BPS
  F15C  7C            		LD	A,H		;DPB_BPS
  F15D  E607          		AND	7
  F15F  327EEC        		LD	(SECSZ+2),A	;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                      					;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                      					;1セクタ1024 2HD/2HDE98等
                      					;1セクタ256 GRAM/RAMF/CMOS等
                      					;1024	512	256
                      					;4	2	1
  F162  87            		ADD	A,A		;8	4	2
  F163  87            		ADD	A,A		;010H	8	4
  F164  87            		ADD	A,A		;020H	010H	8
  F165  321AE6        		LD	(SDECPAT),A	;1セクタ辺りのディレクトリエントリ数
                      	
  F168  2600          		LD	H,0
  F16A  22FAF5        		LD	(_FATPS),HL
                      	
  F16D  E1            		POP	HL		;10:DPB_DIRPS
  F16E  22FCF5        		LD	(_DIRPS),HL
                      	
  F171  E1            		POP	HL		;L=12:DPB_DEVICE H=13:DPB_UNITNO
  F172  7C            		LD	A,H
  F173  3284F4        		LD	(_DRIVE),A
                      	
  F176  E1            		POP	HL		;14:DPB_ADDCL
  F177  22ADE7        		LD	(CLSPAT),HL
                      	
  F17A  310000        		LD	SP,0		;元のSPを復元
  F17B                	SPPAT2	EQU	$-2
  F17D  FB            		EI
  F17E  2AFCF5        		LD	HL,(_DIRPS)
  F181  0600          		LD	B,0
  F183  09            		ADD	HL,BC		;C=DPB_DIRSCNT
  F184  2235E6        		LD	(MD_PAT),HL
                      	
  F187  2AB9E9        		LD	HL,(MAXCLP)
  F18A  110AF0        		LD	DE,0-4086	;クラスタ数が4086未満:FAT12 4086以上:FAT16
  F18D  19            		ADD	HL,DE
  F18E  380F          		JR	C,SETFAT16
  F190  2195EE        		LD	HL,GNCL		;FAT12
  F193  11B8EE        		LD	DE,SNCL
  F196  01F6F0        		LD	BC,FATSETUP12
  F199  DDCB0FAE      		RES	5,(IX+DPB_BPS)	;DPB_BPS(FAT12)
  F19D  180D          		JR	EXTRA1
  F19F                	SETFAT16:
  F19F  21ECEE        		LD	HL,GNCL16	;FAT16
  F1A2  11F9EE        		LD	DE,SNCL16
  F1A5  0103F1        		LD	BC,FATSETUP16
  F1A8  DDCB0FEE      		SET	5,(IX+DPB_BPS)	;DPB_BPS(FAT16)
  F1AC                	EXTRA1:
  F1AC  22F8F4        		LD	(GNCPAT),HL
  F1AF  ED53FBF4      		LD	(SNCPAT),DE
  F1B3  ED43C7F0      		LD	(FATSX),BC
  F1B7  D1            		POP	DE
  F1B8  C1            		POP	BC
  F1B9  AF            		XOR	A
  F1BA  C9            		RET
                      	
  F1BB                	GETDPBD:
  F1BB  DDE3          		EX	(SP),IX
  F1BD  DDE5          		PUSH	IX
  F1BF  3A88F4        		LD	A,(_DRV)
  F1C2  1807          		JR	GETDPB1
                      	
  F1C4                	CHGDRVR:
  F1C4  CDD9F4        		CALL	_CHGDRV
  F1C7  D8            		RET	C
  F1C8  3A89F4        		LD	A,(_DSK)
  F1CB                	GETDPB1:
  F1CB  C3DCF4        		JP	_GETDPB
                      	
  F1CE                	GETDPB:
  F1CE  FE08          		CP	8
  F1D0  3F            		CCF
  F1D1  D8            		RET	C
  F1D2  0F            		RRCA
  F1D3  0F            		RRCA
  F1D4  0F            		RRCA
  F1D5  DD            		DB	0DDH		;Z80未定義命令
  F1D6  6F            		LD	L,A		;LD	IXL,A
  F1D7  DD            		DB	0DDH		;Z80未定義命令
  F1D8  26F6          		LD	H,_DEVICE/256	;LD	IXH,_DEVICE/256
  F1DA  DD7E00        		LD	A,(IX+DPB_FATLN)
  F1DD  A7            		AND	A		;CF=0の為
  F1DE  DDCB0F6E      		BIT	5,(IX+DPB_BPS)
  F1E2  C0            		RET	NZ		;FAT16
  F1E3  DDCB126E      		BIT	5,(IX+DPB_DEVICE)
  F1E7  C0            		RET	NZ		;BPB
  F1E8  FE01          		CP	001H		;A=0 THEN CF=1
  F1EA  C9            		RET
                      	
  F1EB                	_SYS5F:
  F1EB  AF            		XOR	A
  F1EC                	FFLUSH:
  F1EC  F5            		PUSH	AF
  F1ED  CD16EE        		CALL	WTFATX
  F1F0  AF            		XOR	A
  F1F1  32ABF4        		LD	(_FATIX),A
  F1F4  2F            		CPL			;0FFH
  F1F5  32AAF4        		LD	(_FATDRV),A
  F1F8  3E            		DB	03EH		;次のPUSH AFをスキップ
  F1F9                	FFLUSHBUF:
  F1F9  F5            		PUSH	AF
  F1FA  CDCCED        		CALL	DWTX
  F1FD  3EFF          		LD	A,0FFH
  F1FF  3239F4        		LD	(SFILE),A
  F202  32A5F4        		LD	(_DBDRV),A
  F205  F1            		POP	AF
  F206  C9            		RET
                      	
                      	
                      	;X1DISK.ASM
                      	
                      	;	LSX-Dodgers DISK
                      	;	X1/turbo/Z
                      	
  F207                	SEEK:
  F207  0610          		LD	B,16
  F209  DD4E0D        		LD	C,(IX+DPB_MAXSEC)
  F20C  AF            		XOR	A
  F20D  EB            		EX	DE,HL
  F20E                	DIV1:
  F20E  29            		ADD	HL,HL
  F20F  8F            		ADC	A,A
  F210  B9            		CP	C
  F211  3802          		JR	C,DIV2
  F213  91            		SUB	C
  F214  2C            		INC	L
  F215                	DIV2:
  F215  10F7          		DJNZ	DIV1
                      	
  F217  3C            		INC	A	;最小のセクタは１固定
  F218  55            		LD	D,L	;TRACK
  F219  5F            		LD	E,A	;SECTOR
  F21A  CB3A          		SRL	D	;CYLINDER
  F21C  9F            		SBC	A,A
  F21D  E610          		AND	010H	;SIDE
  F21F  4F            		LD	C,A
                      	
  F220  3A84F4        		LD	A,(_DRIVE)
  F223  E603          		AND	3
  F225  B1            		OR	C
  F226  3284F4        		LD	(_DRIVE),A	;サイド選択とドライブを保存
  F229  01FC0F        		LD	BC,00FFCH	;モーター制御、サイド選択、 ドライブ選択
  F22C  F680          		OR	080H		;Motor on
  F22E  ED79          		OUT	(C),A
                      	
  F230  CD74F2        		CALL	SETMODE
  F233  D8            		RET	C
                      	
  F234  CDBEF2        		CALL	DRIVE
  F237  FEFF          		CP	0FFH		;A=0FFH Unknown CYLINDER
  F239  CC99F2        		CALL	Z,FDCRES	;Restore
  F23C  0EF9          		LD	C,0F9H		;MB8877A トラックレジスタ
  F23E  ED79          		OUT	(C),A		;Currrent CYLINDER
  F240  92            		SUB	D
  F241  C8            		RET	Z		;No seek
                      	
  F242  3A86F4        		LD	A,(_ISEEK)
  F245  4F            		LD	C,A
                      	
  F246  DD7E0C        		LD	A,(IX+DPB_MAXCYL)
  F249  3D            		DEC	A
  F24A  BA            		CP	D		;Over CYLINDER
  F24B  D8            		RET	C
                      	
  F24C  B9            		CP	C		;for Built-in 2DD
  F24D  3803          		JR	C,SETM2
  F24F  78            		LD	A,B		;B=00FH
  F250  DBFE          		IN	A,(0FEH)	;2HD mode for 2DD seek/1.6M(2HD) タイプ指定
  F252                	SETM2:
  F252  78            		LD	A,B
  F253  DBFD          		IN	A,(0FDH)	;MFM 方式指定
                      	
  F255  0EFB          		LD	C,0FBH		;MB8877A データレジスタ
  F257  ED51          		OUT	(C),D
  F259  72            		LD	(HL),D
  F25A  0E18          		LD	C,018H		;FDC TypeIコマンド Seek
  F25C                	FDCCMD2:
  F25C  3A85F4        		LD	A,(_SEEKSP)
  F25F  B1            		OR	C
                      	
  F260                	FDCCMD:
  F260  CDB4F2        		CALL	COMSET
                      	
  F263  3E80          		LD	A,080H		;FDC COMMAND(Self-modifying code)
  F264                	FDCSWC	EQU	$-1
  F265  E620          		AND	020H		;Write data Write track
  F267  3C            		INC	A
                      	
  F268                	SST:
  F268  0E00          		LD	C,0
  F26A                	SST1:
  F26A  0D            		DEC	C		; 4
  F26B  20FD          		JR	NZ,SST1		;12 * 256 / 4 = About 1ms
  F26D  3D            		DEC	A
  F26E  20FA          		JR	NZ,SST1
                      	
  F270  3C            		INC	A		;A=1
  F271  CD81F2        		CALL	READY
  F274                	SETMODE:
  F274  DD4E0A        		LD	C,(IX+DPB_FDMODE)	;フロッピーディスクのモード
  F277  ED78          		IN	A,(C)
                      	
  F279  78            		LD	A,B
  F27A  DBFD          		IN	A,(0FDH)	;MFM 方式指定
                      	
  F27C  CDB8F2        		CALL	DELAY0		;Head select time
  F27F  3E81          		LD	A,081H		;NOT READY,BUSY
  F281                	READY:
  F281  E5            		PUSH	HL
  F282  67            		LD	H,A
  F283  0EF8          		LD	C,0F8H		;MB8877A ステータス／コマンドレジスタ
  F285  69            		LD	L,C
  F286                	READY2:
  F286  ED78          		IN	A,(C)
  F288  A4            		AND	H
  F289  280C          		JR	Z,READYE
  F28B  3E1A          		LD	A,1AH
  F28D  DB01          		IN	A,(01H)
  F28F  07            		RLCA
  F290  AD            		XOR	L
  F291  0F            		RRCA
  F292  30F2          		JR	NC,READY2
  F294  2D            		DEC	L
  F295  20EF          		JR	NZ,READY2
  F297                	READYE:
  F297  E1            		POP	HL
  F298  C9            		RET
                      	
  F299                	FDCRES:
  F299  3600          		LD	(HL),0
  F29B  0E08          		LD	C,8
  F29D  18BD          		JR	FDCCMD2
                      	
  F29F                	FDMOFF:
  F29F  F5            		PUSH	AF
  F2A0  C5            		PUSH	BC		;Motor off
  F2A1  01FC0F        		LD	BC,00FFCH	;モーター制御、サイド選択、 ドライブ選択
  F2A4  3A84F4        		LD	A,(_DRIVE)
  F2A7  ED79          		OUT	(C),A
  F2A9  C1            		POP	BC
  F2AA  F1            		POP	AF
  F2AB  C9            		RET
                      	
  F2AC                	SECSET_FDCCMD:
  F2AC  3A64F2        		LD	A,(FDCSWC)
  F2AF                	SECSET:
  F2AF  01FA0F        		LD	BC,00FFAH	;MB8877A セレクタレジスタ
  F2B2  ED59          		OUT	(C),E
  F2B4                	COMSET:
  F2B4  0EF8          		LD	C,0F8H		;MB8877A ステータス／コマンドレジスタ
  F2B6  ED79          		OUT	(C),A
  F2B8                	DELAY0:
  F2B8  3E1A          		LD	A,26
  F2BA                	DELAY:
  F2BA  3D            		DEC	A
  F2BB  20FD          		JR	NZ,DELAY
  F2BD  C9            		RET
                      	
  F2BE                	DRIVE:
  F2BE  DD6E13        		LD	L,(IX+DPB_UNITNO)
  F2C1  26F4          		LD	H,_CYL0/256
  F2C3  CBFD          		SET	7,L
  F2C5  7E            		LD	A,(HL)
  F2C6  C9            		RET
                      	
  F2C7                	RNF:
  F2C7  CDBEF2        		CALL	DRIVE
  F2CA  36FF          		LD	(HL),0FFH
  F2CC  C9            		RET
                      	
  F2CD  02            	RETRY:	DB	2
                      	
                      	
                      	;	FLOPPY DISK DRIVER(DMA)
                      	
                      	
  F2CE                	WTTRK:
  F2CE  0601          		LD	B,1
  F2D0  3EF4          		LD	A,0F4H		;FDC TypeIIIコマンド Write Track
  F2D2  1802          		JR	WTTRK1
  F2D4                	FDWT:
  F2D4  3EA0          		LD	A,0A0H		;FDC TypeIIコマンド Write Sector
  F2D6                	WTTRK1:
  F2D6  3264F2        		LD	(FDCSWC),A
  F2D9  3E10          		LD	A,DMA_WRITE-DMAD
  F2DB  180C          		JR	DISK
                      	
  F2DD                	DISKOK:
  F2DD  0601          		LD	B,1
  F2DE                	FDCNT	EQU	$-1
  F2DF  100B          		DJNZ	DISK1
  F2E1  C9            		RET
                      	
  F2E2                	FDRD:
  F2E2  3E80          		LD	A,080H		;FDC TypeIIコマンド Read Sector
  F2E4  3264F2        		LD	(FDCSWC),A
  F2E7  3E0E          		LD	A,DMA_READ-DMAD
                      	
  F2E9                	DISK:
  F2E9  3200F3        		LD	(DMASWC),A
  F2EC                	DISK1:
  F2EC  78            		LD	A,B
  F2ED  32DEF2        		LD	(FDCNT),A
  F2F0  2255F3        		LD	(DMAHL),HL
  F2F3                	DISKR:
  F2F3  3E02          		LD	A,2		;Retry count
  F2F5  32CDF2        		LD	(RETRY),A
  F2F8                	DISK2:
  F2F8  D5            		PUSH	DE
  F2F9  CD07F2        		CALL	SEEK
  F2FC  3840          		JR	C,ERRF
  F2FE  F3            		DI
                      	
  F2FF  3E0E          		LD	A,14		;自己書き換え
  F300                	DMASWC	EQU	$-1
  F301  214AF3        		LD	HL,DMAD
  F304  CDAFE3        		CALL	SETDMA
  F307  ED49          		OUT	(C),C		;OUT 01F87H,087H WR6 イネーブル
  F309  C5            		PUSH	BC
  F30A  CDACF2        		CALL	SECSET_FDCCMD
  F30D  2A55F3        		LD	HL,(DMAHL)
  F310  23            		INC	HL
  F311  1106BB        		LD	DE,0BB06H	;READ DMA
                      	
  F314  3E03          		LD	A,3
  F316  CD81F2        		CALL	READY
  F319  ED78          		IN	A,(C)
                      	
  F31B  C1            		POP	BC
  F31C  ED51          		OUT	(C),D		;読み出しマスク設定
  F31E  ED59          		OUT	(C),E		;バイトカウンタ(LH)
  F320  ED58          		IN	E,(C)
  F322  ED50          		IN	D,(C)
  F324  19            		ADD	HL,DE
  F325  D1            		POP	DE
  F326  13            		INC	DE
  F327  FB            		EI
  F328  CD9FF2        		CALL	FDMOFF
  F32B  B7            		OR	A
  F32C  28AF          		JR	Z,DISKOK
  F32E  1B            		DEC	DE
  F32F  CB67          		BIT	4,A
  F331  C4C7F2        		CALL	NZ,RNF
  F334                	DISKE2:
  F334  21CDF2        		LD	HL,RETRY
  F337  35            		DEC	(HL)
  F338  20BE          		JR	NZ,DISK2
  F33A  B7            		OR	A
  F33B  280A          		JR	Z,ERR
  F33D  D5            		PUSH	DE
  F33E                	ERRF:
  F33E  D1            		POP	DE
  F33F                	DELP:
  F33F  CDC7F2        		CALL	RNF
  F342  CD9FF2        		CALL	FDMOFF
  F345  3EFF          		LD	A,0FFH
  F347                	ERR:
  F347  BF            		CP	A
  F348  37            		SCF
  F349  C9            		RET
                      	
  F34A                	DMAD:			;X1turbo DISK DMA
  F34A  C3            		DB	0C3H	;WR6 リセット
  F34B  7D            		DB	07DH	;WR0 ポートA→ポートB 転送
  F34C  FB0F          		DW	00FFBH	;ポートA開始アドレス (FDC MB8877A データレジスタ)
  F34E  FFFF          		DW	0FFFFH	;ブロック長(転送サイズ-1)
  F350  2C            		DB	02CH	;WR1 ポートAアドレス固定 I/O
  F351  10            		DB	010H	;WR2 ポートBインクリメント
  F352  80            		DB	080H	;WR3
  F353  92            		DB	092H	;WR5 WAIT RDY:LOW
  F354  8D            		DB	08DH	;WR4 バイト ポートB開始アドレス(LH)
  F355  0000          	DMAHL:	DW	0	;ポートB開始アドレス
  F357  CF            		DB	0CFH	;WR6 ロード
  F358                	DMA_READ:
  F358  01            		DB	001H	;WR0 ポートB←ポートB 転送	（書き込みの際に転送方向を逆にする）
  F359  CF            		DB	0CFH	;WR6 ロード
  F35A                	DMA_WRITE:
  F35A                	DMAE:
                      	
  1D2E                	AT_R	EQU	WTTRK-AT_DWT
  F35A                	AT_TABLE:
                      	
                      	;LDCCPWK.ASM
                      	
                      	;	LSX-Dodgers CCP WORK
                      	
  003B                	PATHX	EQU	59
  F35A                	PATHD:	DS	PATHX
  F395  00            	PATHE:	DB	0
                      	
  F396                	DTA_CCP:
  F396                		DS	37
                      	
  F3BB                	FCB_BAT:
  F3BB                		DS	37
                      	
  F3E0  2020203C444952	DIRMES:	DB	"   <DIR>  $"
  F3EB  20667265652024	FREE:	DB	" free $"
                      	
                      	;LDWORK.ASM
                      	
                      	;	LSX-Dodgers WORK0
                      	;
                      	;	CP/M互換BIOS
                      	;	BOOT:アドレス下位1バイトが0になるように
  F3F2                	AT_WORK:
  F3F2                		DS	WORKAD-AT_WORK
                      	
  F400                	CPM_BOOT:
  F400  C30000        		JP	0
  F403                	_SYS00:		;(BDOS)プログラム終了
  F403                	CPM_WBOOT:
  F403  C309D7        		JP	WBOOT1
  F406                	CPM_CONST:
  F406  C35DE0        		JP	CONSTX
  F409                	_SYS07:		;(BDOS)コンソール直接入力
  F409                	CPM_CONIN:
  F409  C3D2DF        		JP	FLGET
  F40C                	CPM_CONOUT:
  F40C  C3A2E2        		JP	CONOUT1
                      	
  F40F                	DECBF:				;10進数表示時のバッファ(5バイト)
  F40F                		DS	5
  F40F                	RR_BUF_HL	EQU	DECBF	;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
  F411                	RR_BUF_A	EQU	DECBF+2	;計3バイト
                      	
  F414  00            	FDRV:	DB	0
  F415                	FNAME:	DS	36
  F439                	SFILE:	DS	33		;DRV FILENAME
                      	
  F45A                		DS	3
                      	
  F45D  0000          	LEFTX:	DW	0
  F45F  0000          	DTAX:	DW	0
                      	
  F461                	ZERO:
  F461                	BEEPD:
  F461  008E01000B000C		DB	0,08EH,1,0,00BH,0,00CH,010H
  F469  073E08100D00FF		DB	007H,03EH,008H,010H,00DH,0,0FFH
  F462                	RTC_YY	EQU	BEEPD+1
  F463                	RTC_MW	EQU	BEEPD+2
  F464                	RTC_DD	EQU	BEEPD+3
  F465                	RTC_TT	EQU	BEEPD+4
  F466                	RTC_MM	EQU	BEEPD+5
  F467                	RTC_SS	EQU	BEEPD+6
  F462                	ROM_SLT	EQU	BEEPD+1
                      	
  F470  00            	CHECK:	DB	0
                      	
  F471  4F4B24        	OK:	DB	"OK$"
  F474                		DS	5
  F479  4572726F722124	COMERM:	DB	"Error!$"
                      	;	システムワークエリア
                      	;	_CYL0:アドレス下位1バイトが080Hになるように
  F480  FF            	_CYL0:	DB	0FFH	;Cylinder
  F481  FF            	_CYL1:	DB	0FFH	;Cylinder
  F482  FF            	_CYL2:	DB	0FFH	;Cylinder
  F483  FF            	_CYL3:	DB	0FFH	;Cylinder
  F484  00            	_DRIVE:	DB	0	;unit number
  F485                	_SEEKSP:
  F485  00            		DB	0	;Seek speed
  F486  FF            	_ISEEK:	DB	0FFH	;
  F487                		DS	1
  F488  00            	_DRV:	DB	0
  F489  FF            	_DSK:	DB	0FFH
  F48A  8000          	_DTA:	DW	00080H
  F48C  0000          	_CTC:	DW	0
  F48E  0000          	_TXADR:	DW	0
  F490  0000          	_KEYPS:	DW	0
  F492  00FF          	_KEYD:	DW	0FF00H	;キーデータ
  F494  C210          	_KEYSP:	DB	KEYSP_L,KEYSP_H	;オートリピートの速度
  F496                	_COLORF:
  F496  07            		DB	COLORF	;色
  F497  18            	_LINE:	DB	LINE
                      	
  F498  0000          	_FCB:	DW	0	;SEARCH FILES
  F49A  0000          	_FBPS:	DW	0	;    //
  F49C  0000          	_FBAD:	DW	0	;    //
  F49E  00            	_FBCNT:	DB	0	;    //
  F49F  00            	_FILEN:	DB	0	;    //
  F4A0  00            	_DIRF:	DB	0	;bit7:ディレクトリ bit0-6:セクタインデックス
  F4A1                		DS	1
  F4A2                	_WTFATF:
  F4A2  00            		DB	0	;FATバッファの更新フラグ
  F4A3                		DS	1
  F4A4  00            	_WTDBF:	DB	0	;データバッファの更新フラグ
  F4A5  FF            	_DBDRV:	DB	0FFH	;データバッファにあるデータを読み込んだドライブ
  F4A6  0000          	_DBSEC:	DW	0	;データバッファにあるデータを読み込んだセクタ番号
  F4A8  0000          	_DPB:	DW	0
  F4AA                	_FATDRV:
  F4AA  FF            		DB	0FFH	;FATバッファに読み込んでいるドライブ
  F4AB  00            	_FATIX:	DB	0	;FATバッファに読み込んでいるインデックス
  F4AC                	_FAKEFREE:
  F4AC  0000          		DW	0	;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                      	
  F4AE                		DS	2
                      	
  F4B0                	CRTCD:
  F4B0  6F            		DB	06FH
  F4B1                	_WIDTH:
  F4B1  50            		DB	WIDTH
  F4B2                	TVRAMTOP:
  F4B2  5938          		DB	059H,038H
  F4B4  1F02          		DB	01FH,002H
  F4B6                	_LINE2:
  F4B6  19            		DB	019H
  F4B7                	WKE4:
  F4B7  1C            		DB	01CH
  F4B8                	WKE6:
  F4B8  00            		DB	000H
  F4B9                	WK40:
  F4B9  07            		DB	007H
  F4BA                	_PAGE_MINUS:
  F4BA  80F8          		DW	0-WIDTH*LINE
  F4BC                	_WIDTH_MINUS:
  F4BC  B0FF          		DW	0-WIDTH
  F4BE                	WK30:
  F4BE  0C            		DB	00CH
  F4BF                	WK31:
  F4BF                	WK1FD0:
  F4BF  20            		DB	020H
                      	
  F4C0  62DF          	CTC0:	DW	INTCTCE
  F4C2  62DF          	CTC1:	DW	INTCTCE
  F4C4  62DF          	CTC2:	DW	INTCTCE
  F4C6  62DF          	CTC3:	DW	INTCTCE
  F4C8  4EDF          	INTVEC:	DW	INT
                      	
                      	;	LSX-Dodgers 独自BIOS
                      	
  F4CA  C385E4        	_INKEY:	JP	INKEY
  F4CD  C33DE1        	_PRINT:	JP	PRINT
  F4D0  C3EDE3        	_SCRN:	JP	SCRN
  F4D3  C317E4        	_POS:	JP	POS
  F4D6  C36BE2        	_LOC:	JP	LOC
  F4D9                	_CHGDRV:
  F4D9  C310F1        		JP	CHGDRV
  F4DC                	_GETDPB:
  F4DC  C3CEF1        		JP	GETDPB
  F4DF                	_FFLUSH:
  F4DF  C3ECF1        		JP	FFLUSH
  F4E2                	_RDFATX:
  F4E2  C3ECED        		JP	RDFATX
  F4E5  C31BEF        	_RDFAT:	JP	RDFAT
  F4E8  C3CEF2        	_WTTRK:	JP	WTTRK
  F4EB  C3E2F2        	_FDRD:	JP	FDRD
  F4EE  C3D4F2        	_FDWT:	JP	FDWT
  F4F1                	_BPB2DPB:
  F4F1  C3ACEF        		JP	BPB2DPB
  F4F4                	_BREAK:
  F4F4  C3C3D8        		JP	END_BATCH
  F4F7                	_GNCL:
  F4F7  C395EE        		JP	GNCL		; self-modifying code
  F4F8                	GNCPAT	EQU	$-2
  F4FA                	_SNCL:
  F4FA  C3B8EE        		JP	SNCL		; self-modifying code
  F4FB                	SNCPAT	EQU	$-2
  F4FD                	_COMANL:
  F4FD  C37CD7        		JP	COMANL
                      	
  F500                	_WE:
                      	
                      	;LDCALL.ASM
                      	
                      	;	LSX-Dodgers システムコール(BDOS)
                      	;
                      	;	LSX-Dodgers SYSTEM CALL
                      	;	STABLE:アドレス下位1バイトが0になるように
                      	
  F500                	STABLE:
                      	;0
  F500  03F4A5DFB1DF47		DW	_SYS00,_SYS01,_SYS02,_SYS03
  F508  95DC95DCB6DF09		DW	_SYS04,_SYS05,_SYS06,_SYS07
  F510  BEDF97DC29E055		DW	_SYS08,_SYS09,_SYS0A,_SYS0B
  F518  ACDCB1DCC0DCD1		DW	_SYS0C,_SYS0D,_SYS0E,_SYS0F
                      	;1
  F520  25DD6CDDB5DDE6		DW	_SYS10,_SYS11,_SYS12,_SYS13
  F528  EEDD04DE19DE11		DW	_SYS14,_SYS15,_SYS16,_SYS17
  F530  60DE65DE6ADE70		DW	_SYS18,_SYS19,_SYS1A,_SYS1B
  F538  95DC96DE95DC9A		DW	_SYS1C,_SYS1D,_SYS1E,_SYS1F
                      	;2
  F540  95DC50DE58DEA1		DW	_SYS20,_SYS21,_SYS22,_SYS23
  F548  C7DE95DC9CEA74		DW	_SYS24,_ERROR,_SYS26,_SYS27
  F550  58DED1DE6BE047		DW	_SYS28,_SYS29,_SYS2A,_SYS2B
  F558  8EE047E695DCF2		DW	_SYS2C,_SYS2D,_SYS2E,_SYS2F
                      	;3
  F560  ECDE95DC95DC95		DW	_SYS30,_ERROR,_ERROR,_ERROR
  F568  95DC95DC95DC95		DW	_ERROR,_ERROR,_ERROR,_ERROR
  F570  95DC47E647E613		DW	_ERROR,_SYS39,_SYS3A,_SYS5A
                      	;DOS2
  F578  78DC          		DW	_DOS2
                      	
  F57A                		DS	1
  F57B                	_MAX_SEC_SZ_H:
  F57B  02            		DB	MAX_SEC_SZ_H
  F57C                	_FATBF:
  F57C  00F7          		DW	FATBF
  F57E                	_DTBUF:
  F57E  00FD          		DW	DTBUF
                      	
                      	;	コントロールコードテーブル
                      	;	CTRLTB:アドレス下位1バイトが080Hになるように
                      	
  F580                	CTRLTB:
  F580  E0E1E0E11CE261		DW	CTRL00,CTRL00,CTRL02,CTRL03	;  A,B,C
  F588  5BE340E23AE3C3		DW	CTRL04,CTRL05,CTRL06,CTRL07	;D,E,F,G
  F590  ECE10DE264E381		DW	CTRL08,CTRL09,CTRL0A,CTRL0B	;H,I,J,K
  F598  37E366E279E3E0		DW	CTRL0C,CTRL0D,CTRL0E,CTRL00	;L,M,N,O
  F5A0  E0E1E0E179E2E0		DW	CTRL00,CTRL00,CTRL12,CTRL00	;P,Q,R,S
  F5A8  E0E1E0E1E0E1E0		DW	CTRL00,CTRL00,CTRL00,CTRL00	;T,U,V,W
  F5B0  E0E1E0E137E388		DW	CTRL00,CTRL00,CTRL0C,CTRL1B	;X,Y,Z,ESC
  F5B8  07E2F3E1FCE164		DW	CTRL1C,CTRL1D,CTRL1E,CTRL1F	;→,←,↑,↓
                      	
  F5C0  0200          	M2D:	DW	2
  F5C2  FD02          		DB	0FDH,2
  F5C4  6401          		DW	356
  F5C6  FF0728090182  		DB	0FFH,7,40,9,1,082H
  F5CC  0500A7000800  		DW	5,0A7H,8
                      	
  F5D2  0200          	M2HD:	DW	2
  F5D4  FE01          		DB	0FEH,1
  F5D6  C704          		DW	1223
  F5D8  FE064D080184  		DB	0FEH,6,77,8,1,084H
  F5DE  0500A7000900  		DW	5,0A7H,9
                      	
  F5E4  1617          	SDDATA:	DB	22,23		;(FCB)ファイルを最後に変更した時刻
  F5E6  1415          		DB	20,21		;(FCB)ファイルを最後に変更した日付
  F5E8  1A1B          		DB	26,27		;(FCB)ファイルの先頭クラスタ
  F5EA  10111213      		DB	16,17,18,19	;(FCB)ファイルのサイズ(バイト単位)
  F5EE                	SDDATAE:
                      	
  F5EE                		DS	2
  F5F0                	_FCB_BAT:
  F5F0  BBF3          		DW	FCB_BAT
  F5F2                	_PATH:
  F5F2  5AF3          		DW	PATHD
                      	
  F5F4                	SCDIR:	DS	2		;+14 +15
  F5F6                	SFBPS:	DS	2		;FBPS
  F5F8                	SFNDF:	DS	2		;FILEN DIRF
                      	
  F5FA  0000          	_FATPS:	DW	0
  F5FC  0000          	_DIRPS:	DW	0
  F5FE  0000          	_CLPS:	DW	0
                      	
  F600                	_PE:
                      	
                      	;X1DPB.ASM
                      	
                      	;	LSX-Dodgers DPB
                      	;	X1/turbo/Z
                      	
  F600                	_DEVICE:
                      	
                      	;	A:
                      	
  F600  0200          		DW	2	;DPB_FATLN
  F602  EBF4          		DW	_FDRD	;DPB_DRD
  F604  EEF4          		DW	_FDWT	;DPB_DWT
  F606  FD            		DB	0FDH	;DPB_FATID
  F607  02            		DB	2	;DPB_SECPCL
  F608  6401          		DW	356	;DPB_MAXCL
  F60A  FF            		DB	0FFH	;DPB_FDMODE	0FFH=2D / 0FEH=2HD
  F60B  07            		DB	7	;DPB_DIRSCNT
  F60C  28            		DB	40	;DPB_MAXCYL
  F60D  09            		DB	9	;DPB_MAXSEC	Number of sectors
  F60E  01            		DB	1	;DPB_FATPS
  F60F  82            		DB	082H	;DPB_BPS
  F610  0500          		DW	5	;DPB_DIRPS
  F612  A7            		DB	0A7H	;DPB_DEVICE	Device Number
  F613  00            		DB	0	;DPB_UNITNO
  F614  0800          		DW	8	;DPB_ADDCL
  F616  0000          		DW	0	;DPB_16
  F618  0000          		DW	0	;DPB_18
  F61A  0000          		DW	0	;DPB_SDIR
  F61C  46444430      		DB	"FDD0"	;DPB_NAME
                      	
                      	;	B:
                      	
  F620  0200          		DW	2	;DPB_FATLN
  F622  EBF4          		DW	_FDRD	;DPB_DRD
  F624  EEF4          		DW	_FDWT	;DPB_DWT
  F626  FD            		DB	0FDH	;DPB_FATID
  F627  02            		DB	2	;DPB_SECPCL
  F628  6401          		DW	356	;DPB_MAXCL
  F62A  FF            		DB	0FFH	;DPB_FDMODE	0FFH=2D / 0FEH=2HD
  F62B  07            		DB	7	;DPB_DIRSCNT
  F62C  28            		DB	40	;DPB_MAXCYL
  F62D  09            		DB	9	;DPB_MAXSEC	Number of sectors
  F62E  01            		DB	1	;DPB_FATPS
  F62F  82            		DB	082H	;DPB_BPS
  F630  0500          		DW	5	;DPB_DIRPS
  F632  A7            		DB	0A7H	;DPB_DEVICE	Device Number
  F633  01            		DB	1	;DPB_UNITNO
  F634  0800          		DW	8	;DPB_ADDCL
  F636  0000          		DW	0	;DPB_16
  F638  0000          		DW	0	;DPB_18
  F63A  0000          		DW	0	;DPB_SDIR
  F63C  46444431      		DB	"FDD1"	;DPB_NAME
                      	
                      	;	C:
                      	
  F640  0200          		DW	2	;DPB_FATLN
  F642  EBF4          		DW	_FDRD	;DPB_DRD
  F644  EEF4          		DW	_FDWT	;DPB_DWT
  F646  FD            		DB	0FDH	;DPB_FATID
  F647  02            		DB	2	;DPB_SECPCL
  F648  6401          		DW	356	;DPB_MAXCL
  F64A  FF            		DB	0FFH	;DPB_FDMODE	0FFH=2D / 0FEH=2HD
  F64B  07            		DB	7	;DPB_DIRSCNT
  F64C  28            		DB	40	;DPB_MAXCYL
  F64D  09            		DB	9	;DPB_MAXSEC	Number of sectors
  F64E  01            		DB	1	;DPB_FATPS
  F64F  82            		DB	082H	;DPB_BPS
  F650  0500          		DW	5	;DPB_DIRPS
  F652  A7            		DB	0A7H	;DPB_DEVICE	Device Number
  F653  02            		DB	2	;DPB_UNITNO
  F654  0800          		DW	8	;DPB_ADDCL
  F656  0000          		DW	0	;DPB_16
  F658  0000          		DW	0	;DPB_18
  F65A  0000          		DW	0	;DPB_SDIR
  F65C  46444432      		DB	"FDD2"	;DPB_NAME
                      	
                      	;	D:
                      	
  F660  0200          		DW	2	;DPB_FATLN
  F662  EBF4          		DW	_FDRD	;DPB_DRD
  F664  EEF4          		DW	_FDWT	;DPB_DWT
  F666  FD            		DB	0FDH	;DPB_FATID
  F667  02            		DB	2	;DPB_SECPCL
  F668  6401          		DW	356	;DPB_MAXCL
  F66A  FF            		DB	0FFH	;DPB_FDMODE	0FFH=2D / 0FEH=2HD
  F66B  07            		DB	7	;DPB_DIRSCNT
  F66C  28            		DB	40	;DPB_MAXCYL
  F66D  09            		DB	9	;DPB_MAXSEC	Number of sectors
  F66E  01            		DB	1	;DPB_FATPS
  F66F  82            		DB	082H	;DPB_BPS
  F670  0500          		DW	5	;DPB_DIRPS
  F672  A7            		DB	0A7H	;DPB_DEVICE
  F673  03            		DB	3	;DPB_UNITNO
  F674  0800          		DW	8	;DPB_ADDCL
  F676  0000          		DW	0	;DPB_16
  F678  0000          		DW	0	;DPB_18
  F67A  0000          		DW	0	;DPB_SDIR
  F67C  46444433      		DB	"FDD3"	;DPB_NAME
                      	
                      	;	E:
                      	
  F680  0000          	EMMFL:	DW	0	;DPB_FATLN
  F682  34DC          	EMMRD:	DW	EDRD	;DPB_DRD
  F684  20DC          	EMMWR:	DW	EDWT	;DPB_DWT
  F686  FE            		DB	0FEH	;DPB_FATID
  F687  02            		DB	2	;DPB_SECPCL
  F688  0000          	EMMCL:	DW	0	;DPB_MAXCL
  F68A  00            		DB	0	;DPB_FDMODE
  F68B  0C            		DB	12	;DPB_DIRSCNT
  F68C  00            		DB	0	;DPB_MAXCYL
  F68D  00            		DB	0	;DPB_MAXSEC
  F68E  02            		DB	2	;DPB_FATPS
  F68F  02            		DB	2	;DPB_BPS
  F690  0A00          		DW	10	;DPB_DIRPS
  F692  06            		DB	6	;DPB_DEVICE
  F693  00            		DB	0	;DPB_UNITNO
  F694  1200          		DW	18	;DPB_ADDCL
  F696  0000          		DW	0	;DPB_16
  F698  0000          		DW	0	;DPB_18
  F69A  0000          		DW	0	;DPB_SDIR
  F69C  454D4D30      		DB	"EMM0"	;DPB_NAME
                      	
                      	;	F:
                      	
  F6A0  0000          	BANKFL:	DW	0	;DPB_FATLN
  F6A2  B8DB          		DW	BDRD	;DPB_DRD
  F6A4  B4DB          		DW	BDWT	;DPB_DWT
  F6A6  F9            		DB	0F9H	;DPB_FATID
  F6A7  02            		DB	2	;DPB_SECPCL
  F6A8  0000          	BANKCL:	DW	0	;DPB_MAXCL
  F6AA  00            		DB	0	;DPB_FDMODE
  F6AB  08            		DB	8	;DPB_DIRSCNT
  F6AC  00            		DB	0	;DPB_MAXCYL
  F6AD  01            		DB	1	;DPB_MAXSEC
  F6AE  00            		DB	0	;DPB_FATPS
  F6AF  02            		DB	2	;DPB_BPS
  F6B0  0200          		DW	2	;DPB_DIRPS
  F6B2  0B            	BANKDV:	DB	00BH	;DPB_DEVICE
  F6B3  00            		DB	0	;DPB_UNITNO
  F6B4  0600          		DW	6	;DPB_ADDCL
  F6B6  0000          		DW	0	;DPB_16
  F6B8  0000          		DW	0	;DPB_18
  F6BA  0000          		DW	0	;DPB_SDIR
  F6BC  4252414D      		DB	"BRAM"	;DPB_NAME
                      	
                      	;	G:
                      	
  F6C0  0200          		DW	2	;DPB_FATLN
  F6C2  75DB          		DW	GDRD	;DPB_DRD
  F6C4  8CDB          		DW	GDWT	;DPB_DWT
  F6C6  FA            		DB	0FAH	;DPB_FATID
  F6C7  01            		DB	1	;DPB_SECPCL
  F6C8  B800          		DW	184	;DPB_MAXCL
  F6CA  00            		DB	0	;DPB_FDMODE
  F6CB  07            		DB	7	;DPB_DIRSCNT
  F6CC  00            		DB	0	;DPB_MAXCYL
  F6CD  01            		DB	1	;DPB_MAXSEC
  F6CE  01            		DB	1	;DPB_FATPS
  F6CF  01            		DB	1	;DPB_BPS
  F6D0  0300          		DW	3	;DPB_DIRPS
  F6D2  05            		DB	5	;DPB_DEVICE
  F6D3  01            		DB	1	;DPB_UNITNO
  F6D4  0800          		DW	8	;DPB_ADDCL
  F6D6  0000          		DW	0	;DPB_16
  F6D8  0000          		DW	0	;DPB_18
  F6DA  0000          		DW	0	;DPB_SDIR
  F6DC  4752414D      		DB	"GRAM"	;DPB_NAME
                      	
                      	;	H:
  F6E0                		DS	32-8
  F6F8  00            		DB	0
                      	
                      	
  F6F9                	LAST_ADR:
                      	
  F6F9                		END
