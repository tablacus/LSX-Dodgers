                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;
                                ;   FORMAT by Gaku
                                ;
       0003                     OSFLG   EQU $0003
       0005                     SYSTEM  EQU $0005
       000B                     BASE    EQU $000B
       000F                     JP_HL   EQU $000F
       0018                     BIOS    EQU $0018
       005C                     FCB1    EQU $005C
       0080                     DTA EQU $0080
                                
000000 0100                         ORG $0100
000000 0100 C30301          10      JP  START
       0103                     START:
000003 0103 118E05          10      LD  DE,TITLE
000006 0106 0E09             7      LD  C,9     ;文字列出力
000008 0108 CD0500          17      CALL    SYSTEM
00000B 010B 3A0B00          13      LD  A,(BASE)
00000E 010E 32C303          13      LD  (WTTRKP+2),A
000011 0111 3A5C00          13      LD  A,(FCB1)
000014 0114 B7               4      OR  A
000015 0115 200B            12      JR  NZ,MAIN
       0117                     USAGE:
000017 0117 119D05          10      LD  DE,MUSAGE
00001A 011A 0E09             7      LD  C,9     ;文字列出力
00001C 011C CD0500          17      CALL    SYSTEM
00001F 011F C30000          10      JP  0
       0122                     MAIN:
000022 0122 2A0300          16      LD  HL,(OSFLG)
000025 0125 7C               4      LD  A,H
000026 0126 FE1D             7      CP  1DH
000028 0128 C0              11      RET NZ
000029 0129 7D               4      LD  A,L
00002A 012A B7               4      OR  A       ;X1
00002B 012B 2803            12      JR  Z,OK
00002D 012D FE01             7      CP  1       ;MZ-700/1500
00002F 012F C0              11      RET NZ
       0130                     OK:
000030 0130 ED7B0600        20      LD  SP,(SYSTEM+1)
000034 0134 3A5C00          13      LD  A,(FCB1)
000037 0137 3D               4      DEC A
000038 0138 2A0A00          16      LD  HL,(BASE-1)
00003B 013B 2EDC             7      LD  L,$DC       ;GETDPB
00003D 013D CD0F00          17      CALL    JP_HL
000040 0140 38D5            12      JR  C,USAGE
                                
000042 0142 CD8804          17      CALL    SWITCH
000045 0145 FE20             7      CP  $20
000047 0147 3819            12      JR  C,MAIN1
000049 0149 FE4F             7      CP  'O'
00004B 014B 200E            12      JR  NZ,SW1
00004D 014D 1A               7      LD  A,(DE)
00004E 014E D630             7      SUB '0'
000050 0150 38C5            12      JR  C,USAGE
000052 0152 FE0A             7      CP  10
000054 0154 30C1            12      JR  NC,USAGE
000056 0156 329301          13      LD  (OVER+1),A
000059 0159 1807            12      JR  MAIN1
       015B                     SW1:
00005B 015B D643             7      SUB 'C'
00005D 015D 20B8            12      JR  NZ,USAGE
00005F 015F 328D01          13      LD  (LOGSW+1),A
       0162                     MAIN1:
000062 0162 11D205          10      LD  DE,FORMES   ;format
000065 0165 0E09             7      LD  C,9     ;文字列出力
000067 0167 CD0500          17      CALL    SYSTEM
                                
00006A 016A 010604          10      LD  BC,$0406
00006D 016D DDE5            15      PUSH    IX
       016F                     PRNAME:
00006F 016F DD5E1C          19      LD  E,(IX+$1C)  ;デバイスの名前(DPB_1C_NAME)
000072 0172 0E06             7      LD  C,6     ;コンソール直接入出力
000074 0174 C5              11      PUSH    BC
000075 0175 CD0500          17      CALL    SYSTEM
000078 0178 C1              10      POP BC
000079 0179 DD23            10      INC IX
00007B 017B 10F2            13      DJNZ    PRNAME
00007D 017D DDE1            14      POP IX
00007F 017F CD7503          17      CALL    NL
                                
000082 0182 DD7E12          19      LD  A,(IX+$12)  ;デバイス情報(DPB_12_DEVICE)
000085 0185 E60F             7      AND $0F
000087 0187 FE07             7      CP  7       ;FDD
000089 0189 C2EA02          10      JP  NZ,LOGIC
00008C 018C 3E01             7  LOGSW:  LD  A,1
00008E 018E B7               4      OR  A
00008F 018F CAD302          10      JP  Z,LOGICY
                                
000092 0192 3E00             7  OVER:   LD  A,$00
000094 0194 B7               4      OR  A
000095 0195 2057            12      JR  NZ,TYPEO
                                
000097 0197 DDCB0A46        20      BIT 0,(IX+$0A)  ;フロッピーディスクのモード(DPB_0A_FDMODE)
00009B 019B 280B            12      JR  Z,ENABLE_2HD
00009D 019D DDCB127E        20      BIT 7,(IX+$12)  ;デバイス情報(DPB_12_DEVICE)
0000A1 01A1 2005            12      JR  NZ,ENABLE_2HD
0000A3 01A3 110A06          10      LD  DE,FOTMESL  ;format type
0000A6 01A6 1803            12      JR  DISABLE_2HD
       01A8                     ENABLE_2HD:
0000A8 01A8 11DA05          10      LD  DE,FOTMES   ;format type
       01AB                     DISABLE_2HD:
0000AB 01AB 0E09             7      LD  C,9     ;文字列出力
0000AD 01AD CD0500          17      CALL    SYSTEM
       01B0                     TYPE:
0000B0 01B0 0E08             7      LD  C,8     ;エコーなしコンソール入力
0000B2 01B2 CD0500          17      CALL    SYSTEM
0000B5 01B5 CD9604          17      CALL    CAP
0000B8 01B8 FE30             7      CP  '0'
0000BA 01BA 2817            12      JR  Z,TYPE0
0000BC 01BC FE31             7      CP  '1'
0000BE 01BE 281E            12      JR  Z,TYPE1
0000C0 01C0 47               4      LD  B,A
0000C1 01C1 3A1800          13      LD  A,(BIOS)
0000C4 01C4 3C               4      INC A
0000C5 01C5 28E9            12      JR  Z,TYPE
0000C7 01C7 78               4      LD  A,B
0000C8 01C8 FE32             7      CP  '2'
0000CA 01CA 2817            12      JR  Z,TYPE2
0000CC 01CC FE4C             7      CP  'L'
0000CE 01CE CACB02          10      JP  Z,TYPEY
0000D1 01D1 18DD            12      JR  TYPE
       01D3                     TYPE0:
0000D3 01D3 218D06          10      LD  HL,M2D
       01D6                     TYPE1X:
0000D6 01D6 01C306          10      LD  BC,LGAP1
0000D9 01D9 11C606          10      LD  DE,LSEC
0000DC 01DC 1823            12      JR  TYPEX
       01DE                     TYPE1:
0000DE 01DE 219F06          10      LD  HL,M2DD
0000E1 01E1 18F3            12      JR  TYPE1X
       01E3                     TYPE2:
0000E3 01E3 01E006          10      LD  BC,HGAP1
0000E6 01E6 11EB06          10      LD  DE,HSEC
0000E9 01E9 21B106          10      LD  HL,M2HD
0000EC 01EC 1813            12      JR  TYPEX
       01EE                     TYPEO:
0000EE 01EE F5              11      PUSH    AF
0000EF 01EF 117706          10      LD  DE,OVERMES
0000F2 01F2 0E09             7      LD  C,9     ;文字列出力
0000F4 01F4 CD0500          17      CALL    SYSTEM
0000F7 01F7 F1              10      POP AF
0000F8 01F8 C630             7      ADD A,'0'
0000FA 01FA 5F               4      LD  E,A
0000FB 01FB 0E02             7      LD  C,2     ;コンソール出力
0000FD 01FD CD0500          17      CALL    SYSTEM
000100 0200 AF               4      XOR A
                                ;TYPES:
                                ;   LD  BC,HGAP1
                                ;   LD  DE,SSEC
                                ;   LD  HL,M2HS
       0201                     TYPEX:
000101 0201 ED43D203        20      LD  (GAP1+1),BC
000105 0205 ED53D803        20      LD  (SEC+1),DE
                                
000109 0209 5F               4      LD  E,A
00010A 020A 0E02             7      LD  C,2     ;コンソール出力
00010C 020C CD0500          17      CALL    SYSTEM
00010F 020F CD7503          17      CALL    NL
                                
000112 0212 DDE5            15      PUSH    IX
000114 0214 D1              10      POP DE
000115 0215 EDA0            16      LDI
000117 0217 EDA0            16      LDI
000119 0219 13               6      INC DE
00011A 021A 13               6      INC DE
00011B 021B 13               6      INC DE
00011C 021C 13               6      INC DE
00011D 021D 010C00          10      LD  BC,12
000120 0220 EDB0                    LDIR
                                
000122 0222 3A9301          13      LD  A,(OVER+1)
000125 0225 B7               4      OR  A
000126 0226 2819            12      JR  Z,OTFE
                                
000128 0228 C650             7      ADD A,80
00012A 022A DD770C          19      LD  (IX+$0C),A  ;フロッピーディスクのシリンダ数(DPB_0C_MAXCYL)
00012D 022D D650             7      SUB 80
00012F 022F 87               4      ADD A,A ;*2
000130 0230 4F               4      LD  C,A
000131 0231 87               4      ADD A,A ;*4
000132 0232 87               4      ADD A,A ;*8
000133 0233 87               4      ADD A,A ;*16
000134 0234 81               4      ADD A,C ;*18
000135 0235 C698             7      ADD A,$98
000137 0237 DD7708          19      LD  (IX+8),A    ;総クラスタ数(DPB_08_MAXCL)
00013A 023A 3E05             7      LD  A,5
00013C 023C CE00             7      ADC A,0
00013E 023E DD7709          19      LD  (IX+9),A    ;総クラスタ数(DPB_08_MAXCL)
       0241                     OTFE:
000141 0241 DD7E0C          19      LD  A,(IX+$0C)  ;フロッピーディスクのシリンダ数(DPB_0C_MAXCYL)
000144 0244 329E03          13      LD  (MAXCYL+1),A
                                
000147 0247 2A0A00          16      LD  HL,(BASE-1)
00014A 024A 2E89             7      LD  L,$89
00014C 024C 36FF            10      LD  (HL),$FF
                                
00014E 024E 3A5C00          13      LD  A,(FCB1)
000151 0251 3D               4      DEC A
000152 0252 E5              11      PUSH    HL
000153 0253 2ED9             7      LD  L,$D9       ;CHGDRV
000155 0255 CD0F00          17      CALL    JP_HL
000158 0258 E1              10      POP HL
000159 0259 DD7E13          19      LD  A,(IX+$13)  ;デバイスドライバ内におけるユニット番号(DPB_13_UNITNO)
00015C 025C E603             7      AND 3
00015E 025E F680             7      OR  $80
000160 0260 6F               4      LD  L,A
000161 0261 36FF            10      LD  (HL),$FF
000163 0263 CD6403          17      CALL    SURE
                                
000166 0266 113406          10      LD  DE,PHYMES
000169 0269 0E09             7      LD  C,9     ;文字列出力
00016B 026B CD0500          17      CALL    SYSTEM
                                
00016E 026E CD7F03          17      CALL    PHYSIC
000171 0271 CD7503          17      CALL    NL
000174 0274 DABA04          10      JP  C,ERROR
000177 0277 CD2904          17      CALL    VERIFY
00017A 027A CD7503          17      CALL    NL
00017D 027D DABA04          10      JP  C,ERROR
                                
000180 0280 219F07          10      LD  HL,FDATA
000183 0283 11A007          10      LD  DE,FDATA+1
000186 0286 3600            10      LD  (HL),0
000188 0288 010004          10      LD  BC,$400
00018B 028B EDB0                    LDIR
00018D 028D DD7E06          19      LD  A,(IX+6)    ;メディアバイト(DPB_06_FATID)
000190 0290 FEFD             7      CP  $FD
000192 0292 211007          10      LD  HL,LIPL
000195 0295 280A            12      JR  Z,IPL
000197 0297 FEF9             7      CP  $F9
000199 0299 213207          10      LD  HL,DIPL
00019C 029C 2803            12      JR  Z,IPL
                                ;   CP  $FB
                                ;   LD  HL,SIPL
                                ;   JR  Z,IPL
00019E 029E 215407          10      LD  HL,HIPL
       02A1                     IPL:
0001A1 02A1 119F07          10      LD  DE,FDATA
0001A4 02A4 0E22             7      LD  C,$22
0001A6 02A6 EDB0                    LDIR
0001A8 02A8 217607          10      LD  HL,IPLPRG
0001AB 02AB 0E0D             7      LD  C,IPLPEND-IPLPRG
0001AD 02AD EDB0                    LDIR
0001AF 02AF 217F09          10      LD  HL,FDATA+$1E0
0001B2 02B2 0610             7      LD  B,$10
       02B4                     LOW1:
0001B4 02B4 3622            10      LD  (HL),$22
0001B6 02B6 23               6      INC HL
0001B7 02B7 36FE            10      LD  (HL),$FE
0001B9 02B9 23               6      INC HL
0001BA 02BA 10F8            13      DJNZ    LOW1
                                
0001BC 02BC 110000          10      LD  DE,0
0001BF 02BF 219F07          10      LD  HL,FDATA
0001C2 02C2 CD6C04          17      CALL    DWT
0001C5 02C5 B7               4      OR  A
0001C6 02C6 C2BA04          10      JP  NZ,ERROR
                                
0001C9 02C9 1822            12      JR  LOGICX
       02CB                     TYPEY:
0001CB 02CB 119A05          10      LD  DE,CRLF
0001CE 02CE 0E09             7      LD  C,9     ;文字列出力
0001D0 02D0 CD0500          17      CALL    SYSTEM
       02D3                     LOGICY:
0001D3 02D3 3A5C00          13      LD  A,(FCB1)
0001D6 02D6 3D               4      DEC A
0001D7 02D7 2A0A00          16      LD  HL,(BASE-1)
0001DA 02DA 2EDC             7      LD  L,$DC       ;_GETDPB
0001DC 02DC CD0F00          17      CALL    JP_HL
0001DF 02DF 2A0A00          16      LD  HL,(BASE-1)
0001E2 02E2 2EE2             7      LD  L,$E2       ;_RDFATX
0001E4 02E4 CD0F00          17      CALL    JP_HL
0001E7 02E7 DABA04          10      JP  C,ERROR
       02EA                     LOGIC:
0001EA 02EA CD6403          17      CALL    SURE
       02ED                     LOGICX:
0001ED 02ED DD7E12          19      LD  A,(IX+$12)  ;デバイス情報(DPB_12_DEVICE)
0001F0 02F0 FE26             7      CP  $26     ;デバイスはEMMでBPBからDPBを作成する
0001F2 02F2 CCC504          17      CALL    Z,BPB_FROM_EMM
       02F5                     LOGICX1:
0001F5 02F5 114606          10      LD  DE,LOGMES
0001F8 02F8 0E09             7      LD  C,9     ;文字列出力
0001FA 02FA CD0500          17      CALL    SYSTEM
                                
0001FD 02FD 219F07          10      LD  HL,FDATA
000200 0300 5D               4      LD  E,L
000201 0301 54               4      LD  D,H
000202 0302 13               6      INC DE
000203 0303 AF               4      XOR A
000204 0304 77               7      LD  (HL),A
000205 0305 010304          10      LD  BC,$03FF+4
000208 0308 EDB0                    LDIR
                                ;
00020A 030A 219F07          10      LD  HL,FDATA
00020D 030D DD7E06          19      LD  A,(IX+6)    ;メディアバイト(DPB_06_FATID)
000210 0310 77               7      LD  (HL),A      ;FATID
000211 0311 23               6      INC HL
000212 0312 35              11      DEC (HL)        ;LD (HL),$FF
000213 0313 23               6      INC HL
000214 0314 35              11      DEC (HL)        ;LD (HL),$FF
000215 0315 DDCB0F76        20      BIT 6,(IX+$0F)  ;FAT情報と論理セクタのサイズ(DPB_0F_BPS)
000219 0319 2802            12      JR  Z,FAT12
00021B 031B 23               6      INC HL      ;FAT16の場合
00021C 031C 35              11      DEC (HL)        ;LD (HL),$FF
       031D                     FAT12:
00021D 031D DD5E0E          19      LD  E,(IX+$0E)  ;FAT領域の先頭論理セクタ番号(DPB_0E_FATPS)
000220 0320 1600             7      LD  D,0
                                
000222 0322 DD7E0F          19      LD  A,(IX+$0F)  ;FAT情報と論理セクタのサイズ(DPB_0F_BPS)
000225 0325 E680             7      AND $80     ;bit7:予備FAT
       0327                     LOGIC0:
000227 0327 F5              11      PUSH    AF
000228 0328 DD4E00          19      LD  C,(IX+0)    ;FAT領域のセクタ単位でのサイズ(DPB_00_FATLN)
00022B 032B DD4601          19      LD  B,(IX+1)
00022E 032E 219F07          10      LD  HL,FDATA
       0331                     LOGIC1:
000231 0331 CD6C04          17      CALL    DWT
000234 0334 B7               4      OR  A
000235 0335 C2BA04          10      JP  NZ,ERROR
000238 0338 21A307          10      LD  HL,FDATA+4
00023B 033B 0B               6      DEC BC
00023C 033C 78               4      LD  A,B
00023D 033D B1               4      OR  C
00023E 033E 20F1            12      JR  NZ,LOGIC1
                                
000240 0340 F1              10      POP AF
000241 0341 87               4      ADD A,A     ;bit7:予備FAT
000242 0342 38E3            12      JR  C,LOGIC0
       0344                     LOGIC2:             ;ディレクトリエントリ
000244 0344 DD5E10          19      LD  E,(IX+$10)  ;ルートディレクトリ領域の先頭論理セクタ番号(DPB_10_DIRPS)
000247 0347 DD5611          19      LD  D,(IX+$11)
                                
00024A 034A DD460B          19      LD  B,(IX+$0B)  ;ルートディレクトリ領域の論理セクタ数(DPB_0B_DIRSCNT)
       034D                     LOGIC3:
00024D 034D 21A307          10      LD  HL,FDATA+4
000250 0350 CD6C04          17      CALL    DWT
000253 0353 B7               4      OR  A
000254 0354 C2BA04          10      JP  NZ,ERROR
000257 0357 10F4            13      DJNZ    LOGIC3
                                
000259 0359 115806          10      LD  DE,COMMES
00025C 035C 0E09             7      LD  C,9     ;文字列出力
00025E 035E CD0500          17      CALL    SYSTEM
       0361                     LOGICL:
000261 0361 C30000          10      JP  0
       0364                     SURE:
000264 0364 116506          10      LD  DE,HITMES
000267 0367 0E09             7      LD  C,9     ;文字列出力
000269 0369 CD0500          17      CALL    SYSTEM
       036C                     SURE1:
00026C 036C 0E08             7      LD  C,8     ;エコーなしコンソール入力
00026E 036E CD0500          17      CALL    SYSTEM
000271 0371 FE0D             7      CP  $0D
000273 0373 20F7            12      JR  NZ,SURE1
       0375                     NL:
000275 0375 F5              11      PUSH    AF
000276 0376 1E04             7      LD  E,4
000278 0378 0E06             7      LD  C,6     ;コンソール直接入出力
00027A 037A CD0500          17      CALL    SYSTEM
00027D 037D F1              10      POP AF
00027E 037E C9              10      RET
                                
       037F                     PHYSIC:
00027F 037F CD9F04          17      CALL    GUIDE
000282 0382 110000          10      LD  DE,0
000285 0385 D9               4      EXX
000286 0386 2E00             7      LD  L,0     ;CYLINDER
       0388                     PH1:
000288 0388 C5              11      PUSH    BC
000289 0389 D5              11      PUSH    DE
00028A 038A E5              11      PUSH    HL
00028B 038B 1E77             7      LD  E,'w'
00028D 038D 0E02             7      LD  C,2     ;コンソール出力
00028F 038F CD0500          17      CALL    SYSTEM
000292 0392 E1              10      POP HL
000293 0393 D1              10      POP DE
000294 0394 C1              10      POP BC
       0395                     PH2:
000295 0395 D9               4      EXX
000296 0396 CDA203          17      CALL    MAKE
000299 0399 D8              11      RET C
00029A 039A D9               4      EXX
00029B 039B 2C               4      INC L
00029C 039C 7D               4      LD  A,L
00029D 039D FE00             7  MAXCYL: CP  0
00029F 039F 38E7            12      JR  C,PH1
0002A1 03A1 C9              10      RET
                                
       03A2                     MAKE:
0002A2 03A2 FD219F07        14      LD  IY,FDATA
0002A6 03A6 D9               4      EXX
0002A7 03A7 0E00             7      LD  C,0     ;SIDE0
0002A9 03A9 CDCE03          17      CALL    MKDATA
0002AC 03AC FD22BE03        20      LD  (GDATA+1),IY
0002B0 03B0 D9               4      EXX
0002B1 03B1 0E01             7      LD  C,1     ;SIDE1
0002B3 03B3 CDCE03          17      CALL    MKDATA
                                
0002B6 03B6 219F07          10      LD  HL,FDATA
0002B9 03B9 CDC003          17      CALL    WTTRK
0002BC 03BC D8              11      RET C
0002BD 03BD 219F07          10  GDATA:  LD  HL,FDATA
       03C0                     WTTRK:
0002C0 03C0 D5              11      PUSH    DE
0002C1 03C1 CDE800          17  WTTRKP: CALL    $00E8       ;_WTTRK
0002C4 03C4 D1              10      POP DE
                                ;
0002C5 03C5 DD6E0D          19      LD  L,(IX+$0D)  ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
0002C8 03C8 2600             7      LD  H,0
0002CA 03CA 19              11      ADD HL,DE
0002CB 03CB EB               4      EX  DE,HL
0002CC 03CC A7               4      AND A
0002CD 03CD C9              10      RET
                                ;
       03CE                     MKDATA:
0002CE 03CE 2600             7      LD  H,0
0002D0 03D0 D9               4      EXX
0002D1 03D1 21E006          10  GAP1:   LD  HL,HGAP1
0002D4 03D4 CD1904          17      CALL    SETD
       03D7                     MAKE1:
0002D7 03D7 21EB06          10  SEC:    LD  HL,HSEC
0002DA 03DA CD1904          17      CALL    SETD
0002DD 03DD D9               4      EXX
0002DE 03DE FD7500          19      LD  (IY+0),L        ;CYLINDER
0002E1 03E1 FD23            10      INC IY
0002E3 03E3 FD7100          19      LD  (IY+0),C        ;SIDE
0002E6 03E6 FD23            10      INC IY
0002E8 03E8 7D               4      LD  A,L
0002E9 03E9 B1               4      OR  C
0002EA 03EA B4               4      OR  H
0002EB 03EB 3E01             7      LD  A,1
0002ED 03ED 2802            12      JR  Z,MAKES1
0002EF 03EF 7C               4      LD  A,H
0002F0 03F0 3C               4      INC A
       03F1                     MAKES1:
0002F1 03F1 24               4      INC H
0002F2 03F2 FD7700          19      LD  (IY+0),A        ;SECTOR
0002F5 03F5 E5              11      PUSH    HL
0002F6 03F6 FD23            10      INC IY
0002F8 03F8 DD7E07          19      LD  A,(IX+$07)  ;1クラスタの論理セクタ数(DPB_07_SECPCL)
0002FB 03FB FE01             7      CP  1
0002FD 03FD 2806            12      JR  Z,SIZE1024  ;1
0002FF 03FF 3804            12      JR  C,SIZE1024  ;0(v1.29まで)
       0401                     SIZE512:            ;2 or $29(v1.29まで)
000301 0401 3E02             7      LD  A,2
000303 0403 1802            12      JR  SIZE
       0405                     SIZE1024:
000305 0405 3E03             7      LD  A,3
       0407                     SIZE:
000307 0407 FD7700          19      LD  (IY+0),A    ;SIZE
00030A 040A FD23            10      INC IY
00030C 040C D9               4      EXX
00030D 040D CD1904          17      CALL    SETD
000310 0410 F1              10      POP AF      ;AF=HL
000311 0411 DDBE0D           7      CP  (IX+$0D)    ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
000314 0414 38C1            12      JR  C,MAKE1
                                
000316 0416 210907          10      LD  HL,HGAP4
       0419                     SETD:
000319 0419 7E               7      LD  A,(HL)
00031A 041A 23               6      INC HL
00031B 041B 47               4      LD  B,A
00031C 041C 3C               4      INC A
00031D 041D C8              11      RET Z
00031E 041E 7E               7      LD  A,(HL)
00031F 041F 23               6      INC HL
       0420                     SETD1:
000320 0420 FD7700          19      LD  (IY+0),A
000323 0423 FD23            10      INC IY
000325 0425 10F9            13      DJNZ    SETD1
000327 0427 18F0            12      JR  SETD
                                
       0429                     VERIFY:
000329 0429 CD9F04          17      CALL    GUIDE
00032C 042C DD7E0D          19      LD  A,(IX+$0D)  ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
00032F 042F 87               4      ADD A,A
000330 0430 4F               4      LD  C,A
                                
000331 0431 D9               4      EXX
000332 0432 110000          10      LD  DE,0
000335 0435 D9               4      EXX
000336 0436 3A9E03          13      LD  A,(MAXCYL+1)
000339 0439 6F               4      LD  L,A
       043A                     VE2:
00033A 043A C5              11      PUSH    BC
00033B 043B D5              11      PUSH    DE
00033C 043C E5              11      PUSH    HL
00033D 043D 1E76             7      LD  E,'v'
00033F 043F 0E02             7      LD  C,2     ;コンソール出力
000341 0441 CD0500          17      CALL    SYSTEM
000344 0444 E1              10      POP HL
000345 0445 D1              10      POP DE
000346 0446 C1              10      POP BC
000347 0447 C5              11      PUSH    BC
000348 0448 D9               4      EXX
000349 0449 D5              11      PUSH    DE
00034A 044A 119F07          10      LD  DE,FDATA
00034D 044D 0E1A             7      LD  C,$1A       ;DTAの設定
00034F 044F CD0500          17      CALL    SYSTEM
000352 0452 D1              10      POP DE
000353 0453 E1              10      POP HL
000354 0454 E5              11      PUSH    HL
000355 0455 D5              11      PUSH    DE
000356 0456 65               4      LD  H,L
000357 0457 3A5C00          13      LD  A,(FCB1)
00035A 045A 3D               4      DEC A
00035B 045B 6F               4      LD  L,A
00035C 045C 0E2F             7      LD  C,$2F       ;論理セクタを用いた読み出し
00035E 045E CD0500          17      CALL    SYSTEM
000361 0461 D1              10      POP DE
000362 0462 E1              10      POP HL
000363 0463 2600             7      LD  H,0
000365 0465 19              11      ADD HL,DE
000366 0466 EB               4      EX  DE,HL
000367 0467 D9               4      EXX
                                ;
000368 0468 2D               4      DEC L
000369 0469 20CF            12      JR  NZ,VE2
       046B                     VERE:
00036B 046B C9              10      RET
                                
       046C                     DWT:
00036C 046C E5              11      PUSH    HL
00036D 046D C5              11      PUSH    BC
00036E 046E D5              11      PUSH    DE
00036F 046F EB               4      EX  DE,HL
000370 0470 0E1A             7      LD  C,$1A       ;DTAの設定
000372 0472 CD0500          17      CALL    SYSTEM
000375 0475 D1              10      POP DE
000376 0476 D5              11      PUSH    DE
000377 0477 3A5C00          13      LD  A,(FCB1)
00037A 047A 3D               4      DEC A
00037B 047B 6F               4      LD  L,A
00037C 047C 2601             7      LD  H,1
00037E 047E 0E30             7      LD  C,$30       ;論理セクタを用いた書き込み
000380 0480 CD0500          17      CALL    SYSTEM
000383 0483 D1              10      POP DE
000384 0484 13               6      INC DE
000385 0485 C1              10      POP BC
000386 0486 E1              10      POP HL
000387 0487 C9              10      RET
                                
       0488                     SWITCH:
000388 0488 118100          10      LD  DE,DTA+1
       048B                     SWITCH1:
00038B 048B 1A               7      LD  A,(DE)
00038C 048C FE20             7      CP  $20
00038E 048E D8              11      RET C
00038F 048F 13               6      INC DE
000390 0490 FE2F             7      CP  '/'
000392 0492 20F7            12      JR  NZ,SWITCH1
000394 0494 1A               7      LD  A,(DE)
000395 0495 13               6      INC DE
       0496                     CAP:
000396 0496 FE61             7      CP  'a'
000398 0498 D8              11      RET C
000399 0499 FE7B             7      CP  'z'+1
00039B 049B D0              11      RET NC
00039C 049C D620             7      SUB $20
00039E 049E C9              10      RET
                                
       049F                     GUIDE:
00039F 049F 3A9E03          13      LD  A,(MAXCYL+1)
0003A2 04A2 47               4      LD  B,A
0003A3 04A3 0E02             7      LD  C,2
0003A5 04A5 1E2E             7      LD  E,'.'
0003A7 04A7 CDB004          17      CALL    GUIDE1
0003AA 04AA 3A9E03          13      LD  A,(MAXCYL+1)
0003AD 04AD 47               4      LD  B,A
0003AE 04AE 1E08             7      LD  E,8     ;コンソール直接入出力
       04B0                     GUIDE1:
0003B0 04B0 C5              11      PUSH    BC
0003B1 04B1 D5              11      PUSH    DE
0003B2 04B2 CD0500          17      CALL    SYSTEM
0003B5 04B5 D1              10      POP DE
0003B6 04B6 C1              10      POP BC
0003B7 04B7 10F7            13      DJNZ    GUIDE1
0003B9 04B9 C9              10      RET
                                
       04BA                     ERROR:
0003BA 04BA 118306          10      LD  DE,ERRMES
0003BD 04BD 0E09             7      LD  C,9     ;文字列出力
0003BF 04BF CD0500          17      CALL    SYSTEM
0003C2 04C2 C30000          10      JP  0
                                
       04C5                     BPB_FROM_EMM:           ;EMMのサイズからBPBを作成する
0003C5 04C5 DD7E0D          19      LD  A,(IX+$0D)  ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
0003C8 04C8 328507          13      LD  (EMMAL),A
0003CB 04CB DD7E0C          19      LD  A,(IX+$0C)  ;フロッピーディスクのシリンダ数(DPB_0C_MAXCYL)
0003CE 04CE 328607          13      LD  (EMMBL),A
0003D1 04D1 DD7E13          19      LD  A,(IX+$13)  ;デバイスドライバ内におけるユニット番号(DPB_13_UNITNO)
0003D4 04D4 328307          13      LD  (EMMDV),A
                                
0003D7 04D7 CD6D05          17      CALL    EADR0
0003DA 04DA ED78            12      IN  A,(C)
0003DC 04DC F5              11      PUSH    AF
                                
0003DD 04DD 110000          10      LD  DE,0
       04E0                     ECHECK1:
0003E0 04E0 13               6      INC DE
0003E1 04E1 CD5405          17      CALL    EADR2
0003E4 04E4 ED60            12      IN  H,(C)
0003E6 04E6 CD5405          17      CALL    EADR2
0003E9 04E9 7C               4      LD  A,H
0003EA 04EA C6E5             7      ADD A,0E5H
0003EC 04EC ED79            12      OUT (C),A
0003EE 04EE 3C               4      INC A
0003EF 04EF CD6D05          17      CALL    EADR0
0003F2 04F2 ED79            12      OUT (C),A
0003F4 04F4 3D               4      DEC A
0003F5 04F5 CD5405          17      CALL    EADR2
0003F8 04F8 ED68            12      IN  L,(C)
0003FA 04FA CD5405          17      CALL    EADR2
0003FD 04FD ED61            12      OUT (C),H
0003FF 04FF BD               4      CP  L
000400 0500 2004            12      JR  NZ,ECHECK2
000402 0502 CB72             8      BIT 6,D
000404 0504 28DA            12      JR  Z,ECHECK1
       0506                     ECHECK2:
000406 0506 CD6D05          17      CALL    EADR0
000409 0509 F1              10      POP AF
00040A 050A ED79            12      OUT (C),A
                                
00040C 050C 21F7FF          10      LD  HL,0-9
00040F 050F 19              11      ADD HL,DE
000410 0510 D2BA04          10      JP  NC,ERROR
                                
000413 0513 01F60F          10      LD  BC,4086
000416 0516 A7               4      AND A
000417 0517 ED42            15      SBC HL,BC
000419 0519 3806            12      JR  C,EFAT12
00041B 051B 218605          10      LD  HL,CALC_FATLN16
00041E 051E 222905          16      LD  (CALC_FATLN),HL
       0521                     EFAT12:
000421 0521 D5              11      PUSH    DE
000422 0522 E1              10      POP HL
000423 0523 29              11      ADD HL,HL
000424 0524 229A07          16      LD  (EMM_TotSec16),HL   ;総セクタ数
000427 0527 EB               4      EX  DE,HL
       0529                     CALC_FATLN  EQU $+1
000428 0528 CD7605          17      CALL    CALC_FATLN12        ;自己書き換え
00042B 052B 329D07          13      LD  (EMM_FATSz16),A     ;FATのサイズ
00042E 052E DD7700          19      LD  (IX+0),A        ;FAT領域のセクタ単位でのサイズ(DPB_00_FATLN)
                                
000431 0531 219F07          10      LD  HL,FDATA
000434 0534 11A007          10      LD  DE,FDATA+1
000437 0537 3600            10      LD  (HL),0
000439 0539 01E801          10      LD  BC,512-FDATA+EMM_BPB
00043C 053C EDB0                    LDIR
                                
00043E 053E 110000          10      LD  DE,0
000441 0541 218707          10      LD  HL,EMM_BPB
000444 0544 CD6C04          17      CALL    DWT
000447 0547 B7               4      OR  A
000448 0548 C2BA04          10      JP  NZ,ERROR
                                
00044B 054B 3A5C00          13      LD  A,(FCB1)
00044E 054E 5F               4      LD  E,A
00044F 054F 0E1B             7      LD  C,$1B       ;ディスク情報の獲得
000451 0551 C30500          10      JP  SYSTEM
       0554                     EADR2:
000454 0554 D5              11      PUSH    DE
000455 0555 EB               4      EX  DE,HL
000456 0556 29              11      ADD HL,HL
000457 0557 29              11      ADD HL,HL
000458 0558 ED4B8507        20      LD  BC,(EMMAL)
00045C 055C 09              11      ADD HL,BC
00045D 055D ED4B8307        20      LD  BC,(EMMDV)
000461 0561 ED49            12      OUT (C),C
000463 0563 0C               4      INC C
000464 0564 ED69            12      OUT (C),L
000466 0566 0C               4      INC C
000467 0567 ED61            12      OUT (C),H
000469 0569 0C               4      INC C
00046A 056A EB               4      EX  DE,HL
00046B 056B D1              10      POP DE
00046C 056C C9              10      RET
                                
       056D                     EADR0:
00046D 056D D5              11      PUSH    DE
00046E 056E 110000          10      LD  DE,0
000471 0571 CD5405          17      CALL    EADR2
000474 0574 D1              10      POP DE
000475 0575 C9              10      RET
                                
       0576                     CALC_FATLN12:   ;FAT12 - クラスタ数から必要なFATサイズを求める(セクタサイズ512)
000476 0576 5D               4      LD  E,L
000477 0577 54               4      LD  D,H
000478 0578 29              11      ADD HL,HL   ;*2
000479 0579 19              11      ADD HL,DE   ;*3
00047A 057A CB3C             8      SRL H   ;/2
00047C 057C CB1D             8      RR  L   ;1クラスタ辺り1.5バイト必要
00047E 057E 11FF01          10      LD  DE,511  ;切り上げる
000481 0581 19              11      ADD HL,DE
000482 0582 7C               4      LD  A,H
000483 0583 CB3F             8      SRL A
000485 0585 C9              10      RET
                                
       0586                     CALC_FATLN16:   ;FAT16 - クラスタ数から必要なFATサイズを求める(セクタサイズ512)
000486 0586 7D               4      LD  A,L
000487 0587 C6FF             7      ADD A,$FF
000489 0589 9F               4      SBC A,A
00048A 058A E601             7      AND 1
00048C 058C 84               4      ADD A,H
00048D 058D C9              10      RET
                                
       058E                     TITLE:
00048E 058E 666F726D61742076        DB  "format v1.16"
            312E3136            
       059A                     CRLF:
00049A 059A 0D0A                    DB  $0D,$0A
00049C 059C 24                      DB  '$'
       059D                     MUSAGE:
00049D 059D 75736167653A2046        DB  "usage: FORMAT ﾄﾞﾗｲﾌﾞ:[ｽｲｯﾁ]",$0D,$0A
            4F524D415420C4DE    
            D7B2CCDE3A5BBDB2    
            AFC15D0D0A          
0004BA 05BA 092F432020464154        DB  9,"/C  FAT,ﾃﾞｨﾚｸﾄﾘ ｼｮｷｶ",$0D,$0A
            2CC3DEA8DAB8C4D8    
            20BCAEB7B60D0A      
                                ;   DB  9,"/On ｵｰﾊﾞｰﾄﾗｯｸ(n:1-9)",$0D,$0A
0004D1 05D1 24                      DB  '$'
       05D2                     FORMES:
0004D2 05D2 666F726D61742024        DB  "format $"
       05DA                     FOTMES:
0004DA 05DA 666F726D61742074        DB  "format type (2D=0,2DD=1,2HD=2,logical only=L)? $"
            797065202832443D    
            302C3244443D312C    
            3248443D322C6C6F    
            676963616C206F6E    
            6C793D4C293F2024    
       060A                     FOTMESL:
00050A 060A 666F726D61742074        DB  "format type (2D=0,2DD=1,logical only=L)? $"
            797065202832443D    
            302C3244443D312C    
            6C6F676963616C20    
            6F6E6C793D4C293F    
            2024                
       0634                     PHYMES:
000534 0634 706879736963616C        DB  "physical format",$0D,$0A,'$'
            20666F726D61740D    
            0A24                
       0646                     LOGMES:
000546 0646 6C6F676963616C20        DB  "logical  format",$0D,$0A,'$'
            20666F726D61740D    
            0A24                
       0658                     COMMES:
000558 0658 636F6D706C657465        DB  "completed!",$0D,$0A,'$'
            64210D0A24          
       0665                     HITMES:
000565 0665 686974205B43525D        DB  "hit [CR] to start$"
            20746F2073746172    
            7424                
       0677                     OVERMES:
000577 0677 6F76657220747261        DB  "over track:$"
            636B3A24            
       0683                     ERRMES:
000583 0683 074572726F72210D        DB  7,"Error!",$0D,$0A,'$'
            0A24                
                                ;
                                ;   DPB Data
                                ;
                                
00058D 068D 0200                M2D:    DW  2
00058F 068F FD02                    DB  $FD,2
000591 0691 6401                    DW  356
000593 0693 FF0728090182            DB  $FF,7,40,9,1,$82
000599 0699 0500A7000800            DW  5,$A7,8
                                
00059F 069F 0300                M2DD:   DW  3
0005A1 06A1 F902                    DB  $F9,2
0005A3 06A3 CB02                    DW  715
0005A5 06A5 FF0750090182            DB  $FF,7,80,9,1,$82
0005AB 06AB 0700A7000A00            DW  7,$A7,10
                                
0005B1 06B1 0200                M2HD:   DW  2
0005B3 06B3 FE01                    DB  $FE,1
0005B5 06B5 C704                    DW  1223
0005B7 06B7 FE064D080184            DB  $FE,6,77,8,1,$84
0005BD 06BD 0500A7000900            DW  5,$A7,9
                                
                                ;M2HS:  DB  3
                                ;   DW  $FB,8
                                ;   DW  1432
                                ;   DB  $FE,10,80,9,1,4,4,10
                                ;
                                ;   Format Data 2D/2DD
                                ;
0005C3 06C3 204EFF              LGAP1:  DB  32,$4E,255
                                ;
0005C6 06C6 0C0003F501FEFF      LSEC:   DB  12,$00,3,$F5,1,$FE,255
                                ;
0005CD 06CD 01F7164E0C0003F5        DB  1,$F7,22,$4E,12,$00,3,$F5,1,$FB
            01FB                
0005D7 06D7 00E500E5                DB  0,$E5,0,$E5
0005DB 06DB 01F7544EFF              DB  1,$F7,84,$4E,255
                                ;
                                ;   Format Data 2HD
                                ;
0005E0 06E0 504E0C0003F601FC    HGAP1:  DB  80,$4E,12,$00,3,$F6,1,$FC,50,$4E,255
            324EFF              
                                ;
0005EB 06EB 0C0003F501FEFF      HSEC:   DB  12,$00,3,$F5,1,$FE,255
                                ;
0005F2 06F2 01F7164E0C0003F5        DB  1,$F7,22,$4E,12,$00,3,$F5,1,$FB
            01FB                
0005FC 06FC 00E500E500E500E5        DB  0,$E5,0,$E5,0,$E5,0,$E5
000604 0704 01F7744EFF              DB  1,$F7,116,$4E,255
                                ;
000609 0709 004E004E004EFF      HGAP4:  DB  0,$4E,0,$4E,0,$4E,255
                                ;
                                ;   Format Data 2HS
                                ;
                                ;SSEC:  DB  12,$00,3,$F5,1,$FE,255
                                ;
                                ;   DB  1,$F7,22,$4E,12,$00,3,$F5,1,$FB
                                ;   DB  0,$E5,0,$E5,0,$E5,0,$E5
                                ;   DB  1,$F7,53,$4E,255
                                ;
                                ;   BOOT-DATA
                                ;
000610 0710 EBFE904C44202020    LIPL:   DB  $EB,$FE,$90,'L','D',$20,$20,$20
000618 0718 2020200002020100        DB  $20,$20,$20,$00,$02,$02,$01,$00
000620 0720 027000D002FD0200        DB  $02,$70,$00,$D0,$02,$FD,$02,$00
000628 0728 090002000000C900        DB  $09,$00,$02,$00,$00,$00,$C9,$00
000630 0730 0000                    DB  $00,$00
                                
000632 0732 EBFE904C44202020    DIPL:   DB  $EB,$FE,$90,'L','D',$20,$20,$20
00063A 073A 2020200002020100        DB  $20,$20,$20,$00,$02,$02,$01,$00
000642 0742 027000A005F90300        DB  $02,$70,$00,$A0,$05,$F9,$03,$00
00064A 074A 090002000000C900        DB  $09,$00,$02,$00,$00,$00,$C9,$00
000652 0752 0000                    DB  $00,$00
                                
000654 0754 EBFE904C44202020    HIPL:   DB  $EB,$FE,$90,'L','D',$20,$20,$20
00065C 075C 2020200004010100        DB  $20,$20,$20,$00,$04,$01,$01,$00
000664 0764 02C000D004FE0200        DB  $02,$C0,$00,$D0,$04,$FE,$02,$00
00066C 076C 080002000000C900        DB  $08,$00,$02,$00,$00,$00,$C9,$00
000674 0774 0000                    DB  $00,$00
                                
                                ;SIPL:  DB  $EB,$1E,$90,'L','D',$20,$20,$20
                                ;   DB  $20,$20,$20,"2","H","S",$20,$20
                                ;   DB  $20,$20,$04,$00,$01,$03,$00,$01
                                ;   DB  $00,$C0,$05,$A0,$FB,$01,$C9,$00
                                ;   DB  $EB,$FE
                                
       0776                     IPLPRG:
000676 0776 01FC0F          10      LD  BC,$FFC
000679 0779 ED71                    DB  $ED,$71
00067B 077B 3E07             7      LD  A,7
00067D 077D 3286FF          13      LD  ($FF86),A
000680 0780 C3F500          10      JP  $F5
       0783                     IPLPEND:
                                
000683 0783 000B                EMMDV:  DW  $0B00
000685 0785 00                  EMMAL:  DB  0
000686 0786 00                  EMMBL:  DB  0
                                
       0787                     EMM_BPB:
000687 0787 EBFE90                  DB  0EBH,0FEH,090H
       078A                     EMM_OEMName:
00068A 078A 4C442D454D4D2020        DB  "LD-EMM  "
       0792                     EMM_BytsPerSec:
000692 0792 0002                    DW  512
       0794                     EMM_SecPerClus:
000694 0794 02                      DB  2
       0795                     EMM_RsvdSecCnt:
000695 0795 0100                    DW  1
       0797                     EMM_NumFATs:
000697 0797 01                      DB  1
       0798                     EMM_RootEntCnt:
000698 0798 0002                    DW  512
       079A                     EMM_TotSec16:
00069A 079A 0000                    DW  0
       079C                     EMM_Media:
00069C 079C FA                      DB  0FAH
       079D                     EMM_FATSz16:
00069D 079D 0000                    DW  0
                                
       079F                     FDATA:
[EOF:FORMAT.ASM:SHIFT_JIS]
