                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;
                                ;   FORMAT by Gaku
                                ;
       0003                     OSFLG   EQU $0003
       0005                     SYSTEM  EQU $0005
       000B                     BASE    EQU $000B
       000F                     JP_HL   EQU $000F
       0018                     BIOS    EQU $0018
       005C                     FCB1    EQU $005C
       0080                     DTA EQU $0080
                                
000000 0100                         ORG $0100
000000 0100 C30301          10      JP  START
       0103                     START:
000003 0103 11A104          10      LD  DE,TITLE
000006 0106 0E09             7      LD  C,9     ;文字列出力
000008 0108 CD0500          17      CALL    SYSTEM
00000B 010B 3A0B00          13      LD  A,(BASE)
00000E 010E 329F03          13      LD  (WTTRKP+2),A
000011 0111 3A5C00          13      LD  A,(FCB1)
000014 0114 B7               4      OR  A
000015 0115 200B            12      JR  NZ,MAIN
       0117                     USAGE:
000017 0117 11B304          10      LD  DE,MUSAGE
00001A 011A 0E09             7      LD  C,9     ;文字列出力
00001C 011C CD0500          17      CALL    SYSTEM
00001F 011F C30000          10      JP  0
       0122                     MAIN:
000022 0122 2A0300          16      LD  HL,(OSFLG)
000025 0125 7C               4      LD  A,H
000026 0126 FE1D             7      CP  1DH
000028 0128 C0              11      RET NZ
000029 0129 7D               4      LD  A,L
00002A 012A E6F0             7      AND 0F0H
00002C 012C FE90             7      CP  090H
00002E 012E C0              11      RET NZ
                                
00002F 012F ED7B0600        20      LD  SP,(SYSTEM+1)
000033 0133 3A5C00          13      LD  A,(FCB1)
000036 0136 3D               4      DEC A
000037 0137 2A0A00          16      LD  HL,(BASE-1)
00003A 013A 2EDC             7      LD  L,$DC       ;GETDPB
00003C 013C CD0F00          17      CALL    JP_HL
00003F 013F 38D6            12      JR  C,USAGE
                                
000041 0141 CD6404          17      CALL    SWITCH
000044 0144 FE20             7      CP  $20
000046 0146 3819            12      JR  C,MAIN1
000048 0148 FE4F             7      CP  'O'
00004A 014A 200E            12      JR  NZ,SW1
00004C 014C 1A               7      LD  A,(DE)
00004D 014D D630             7      SUB '0'
00004F 014F 38C6            12      JR  C,USAGE
000051 0151 FE0A             7      CP  10
000053 0153 30C2            12      JR  NC,USAGE
000055 0155 329801          13      LD  (OVER+1),A
000058 0158 1807            12      JR  MAIN1
       015A                     SW1:
00005A 015A D643             7      SUB 'C'
00005C 015C 20B9            12      JR  NZ,USAGE
00005E 015E 328C01          13      LD  (LOGSW+1),A
       0161                     MAIN1:
000061 0161 11E804          10      LD  DE,FORMES   ;format
000064 0164 0E09             7      LD  C,9     ;文字列出力
000066 0166 CD0500          17      CALL    SYSTEM
                                
000069 0169 010604          10      LD  BC,$0406
00006C 016C DDE5            15      PUSH    IX
       016E                     PRNAME:
00006E 016E DD5E1C          19      LD  E,(IX+$1C)  ;デバイスの名前(DPB_1C_NAME)
000071 0171 0E06             7      LD  C,6     ;コンソール直接入出力
000073 0173 C5              11      PUSH    BC
000074 0174 CD0500          17      CALL    SYSTEM
000077 0177 C1              10      POP BC
000078 0178 DD23            10      INC IX
00007A 017A 10F2            13      DJNZ    PRNAME
00007C 017C DDE1            14      POP IX
00007E 017E CD4A03          17      CALL    LTNL
                                
000081 0181 DD7E12          19      LD  A,(IX+$12)  ;デバイス情報(DPB_12_DEVICE)
000084 0184 E60F             7      AND $0F
000086 0186 FE07             7      CP  7
000088 0188 C2C702          10      JP  NZ,LOGIC
00008B 018B 3E01             7  LOGSW:  LD  A,1
00008D 018D B7               4      OR  A
00008E 018E CABA02          10      JP  Z,LOGICY
                                
000091 0191 3A1800          13      LD  A,(BIOS)
000094 0194 3C               4      INC A
000095 0195 2805            12      JR  Z,NONT
                                
000097 0197 3E00             7  OVER:   LD  A,$00
000099 0199 B7               4      OR  A
00009A 019A 2041            12      JR  NZ,TYPEO
       019C                     NONT:
00009C 019C 11F004          10      LD  DE,FOTMES   ;format type
00009F 019F 0E09             7      LD  C,9     ;文字列出力
0000A1 01A1 CD0500          17      CALL    SYSTEM
       01A4                     TYPE:
0000A4 01A4 0E08             7      LD  C,8     ;エコーなしコンソール入力
0000A6 01A6 CD0500          17      CALL    SYSTEM
0000A9 01A9 CD7204          17      CALL    CAP
0000AC 01AC FE30             7      CP  '0'
0000AE 01AE 2812            12      JR  Z,TYPE0
0000B0 01B0 FE31             7      CP  '1'
0000B2 01B2 2819            12      JR  Z,TYPE1
0000B4 01B4 47               4      LD  B,A
0000B5 01B5 3A1800          13      LD  A,(BIOS)
0000B8 01B8 3C               4      INC A
0000B9 01B9 28E9            12      JR  Z,TYPE
0000BB 01BB 78               4      LD  A,B
0000BC 01BC FE32             7      CP  '2'
0000BE 01BE 2812            12      JR  Z,TYPE2
                                ;   CP  'S'
                                ;   JR  Z,TYPES
0000C0 01C0 18E2            12      JR  TYPE
       01C2                     TYPE0:
0000C2 01C2 216B05          10      LD  HL,M2D
       01C5                     TYPE1X:
0000C5 01C5 01A105          10      LD  BC,LGAP1
0000C8 01C8 11A405          10      LD  DE,LSEC
0000CB 01CB 1823            12      JR  TYPEX
       01CD                     TYPE1:
0000CD 01CD 217D05          10      LD  HL,M2DD
0000D0 01D0 18F3            12      JR  TYPE1X
       01D2                     TYPE2:
0000D2 01D2 01BE05          10      LD  BC,HGAP1
0000D5 01D5 11C905          10      LD  DE,HSEC
0000D8 01D8 218F05          10      LD  HL,M2HD
0000DB 01DB 1813            12      JR  TYPEX
       01DD                     TYPEO:
0000DD 01DD F5              11      PUSH    AF
0000DE 01DE 115505          10      LD  DE,OVERMES
0000E1 01E1 0E09             7      LD  C,9     ;文字列出力
0000E3 01E3 CD0500          17      CALL    SYSTEM
0000E6 01E6 F1              10      POP AF
0000E7 01E7 C630             7      ADD A,"0"
0000E9 01E9 5F               4      LD  E,A
0000EA 01EA 0E02             7      LD  C,2     ;コンソール出力
0000EC 01EC CD0500          17      CALL    SYSTEM
0000EF 01EF AF               4      XOR A
                                ;TYPES:
                                ;   LD  BC,HGAP1
                                ;   LD  DE,SSEC
                                ;   LD  HL,M2HS
       01F0                     TYPEX:
0000F0 01F0 ED43AE03        20      LD  (GAP1+1),BC
0000F4 01F4 ED53B403        20      LD  (SEC+1),DE
                                
0000F8 01F8 5F               4      LD  E,A
0000F9 01F9 0E02             7      LD  C,2     ;コンソール出力
0000FB 01FB CD0500          17      CALL    SYSTEM
0000FE 01FE CD4A03          17      CALL    LTNL
                                
000101 0201 DDE5            15      PUSH    IX
000103 0203 D1              10      POP DE
000104 0204 EDA0            16      LDI
000106 0206 EDA0            16      LDI
000108 0208 13               6      INC DE
000109 0209 13               6      INC DE
00010A 020A 13               6      INC DE
00010B 020B 13               6      INC DE
00010C 020C 010C00          10      LD  BC,12
00010F 020F EDB0                    LDIR
                                
000111 0211 3A9801          13      LD  A,(OVER+1)
000114 0214 B7               4      OR  A
000115 0215 2819            12      JR  Z,OTFE
                                
000117 0217 C650             7      ADD A,80
000119 0219 DD770C          19      LD  (IX+$0C),A  ;フロッピーディスクのシリンダ数(DPB_0C_MAXCYL)
00011C 021C D650             7      SUB 80
00011E 021E 87               4      ADD A,A ;*2
00011F 021F 4F               4      LD  C,A
000120 0220 87               4      ADD A,A ;*4
000121 0221 87               4      ADD A,A ;*8
000122 0222 87               4      ADD A,A ;*16
000123 0223 81               4      ADD A,C ;*18
000124 0224 C698             7      ADD A,$98
000126 0226 DD7708          19      LD  (IX+8),A    ;総クラスタ数(DPB_08_MAXCL)
000129 0229 3E05             7      LD  A,5
00012B 022B CE00             7      ADC A,0
00012D 022D DD7709          19      LD  (IX+9),A    ;総クラスタ数(DPB_08_MAXCL)
       0230                     OTFE:
000130 0230 DD7E0C          19      LD  A,(IX+$0C)  ;フロッピーディスクのシリンダ数(DPB_0C_MAXCYL)
000133 0233 327A03          13      LD  (MAXCYL+1),A
                                
000136 0236 2A0A00          16      LD  HL,(BASE-1)
000139 0239 2E89             7      LD  L,$89
00013B 023B 36FF            10      LD  (HL),$FF
                                
00013D 023D 3A5C00          13      LD  A,(FCB1)
000140 0240 3D               4      DEC A
000141 0241 E5              11      PUSH    HL
000142 0242 2ED9             7      LD  L,$D9       ;CHGDRV
000144 0244 CD0F00          17      CALL    JP_HL
000147 0247 E1              10      POP HL
000148 0248 DD7E13          19      LD  A,(IX+$13)  ;デバイスドライバ内におけるユニット番号(DPB_13_UNITNO)
00014B 024B E603             7      AND 3
00014D 024D F680             7      OR  $80
00014F 024F 6F               4      LD  L,A
000150 0250 36FF            10      LD  (HL),$FF
000152 0252 CD3903          17      CALL    SURE
                                
000155 0255 111105          10      LD  DE,PHYMES
000158 0258 0E09             7      LD  C,9     ;文字列出力
00015A 025A CD0500          17      CALL    SYSTEM
                                
00015D 025D CD5B03          17      CALL    PHYSIC
000160 0260 CD4A03          17      CALL    LTNL
000163 0263 DA9604          10      JP  C,ERROR
000166 0266 CD0504          17      CALL    VERIFY
000169 0269 CD4A03          17      CALL    LTNL
00016C 026C DA9604          10      JP  C,ERROR
                                
00016F 026F 216106          10      LD  HL,FDATA
000172 0272 116206          10      LD  DE,FDATA+1
000175 0275 3600            10      LD  (HL),0
000177 0277 010004          10      LD  BC,$400
00017A 027A EDB0                    LDIR
00017C 027C DD7E06          19      LD  A,(IX+6)    ;メディアバイト(DPB_06_FATID)
00017F 027F FEFD             7      CP  $FD
000181 0281 21EE05          10      LD  HL,LIPL
000184 0284 280A            12      JR  Z,IPL
000186 0286 FEF9             7      CP  $F9
000188 0288 211006          10      LD  HL,DIPL
00018B 028B 2803            12      JR  Z,IPL
                                ;   CP  $FB
                                ;   LD  HL,SIPL
                                ;   JR  Z,IPL
00018D 028D 213206          10      LD  HL,HIPL
       0290                     IPL:
000190 0290 116106          10      LD  DE,FDATA
000193 0293 0E22             7      LD  C,$22
000195 0295 EDB0                    LDIR
000197 0297 215406          10      LD  HL,IPLPRG
00019A 029A 0E0D             7      LD  C,IPLPEND-IPLPRG
00019C 029C EDB0                    LDIR
00019E 029E 214108          10      LD  HL,FDATA+$1E0
0001A1 02A1 0610             7      LD  B,$10
       02A3                     LOW1:
0001A3 02A3 3622            10      LD  (HL),$22
0001A5 02A5 23               6      INC HL
0001A6 02A6 36FE            10      LD  (HL),$FE
0001A8 02A8 23               6      INC HL
0001A9 02A9 10F8            13      DJNZ    LOW1
                                
0001AB 02AB 110000          10      LD  DE,0
0001AE 02AE 216106          10      LD  HL,FDATA
0001B1 02B1 CD4804          17      CALL    DWT
0001B4 02B4 B7               4      OR  A
0001B5 02B5 C29604          10      JP  NZ,ERROR
                                
0001B8 02B8 1810            12      JR  LOGICX
                                
       02BA                     LOGICY:
0001BA 02BA 3A5C00          13      LD  A,(FCB1)
0001BD 02BD 5F               4      LD  E,A
0001BE 02BE 0E1B             7      LD  C,$1B       ;ディスク情報の獲得
0001C0 02C0 CD0500          17      CALL    SYSTEM
0001C3 02C3 3C               4      INC A
0001C4 02C4 CA9604          10      JP  Z,ERROR
       02C7                     LOGIC:
0001C7 02C7 CD3903          17      CALL    SURE
       02CA                     LOGICX:
0001CA 02CA 112305          10      LD  DE,LOGMES
0001CD 02CD 0E09             7      LD  C,9     ;文字列出力
0001CF 02CF CD0500          17      CALL    SYSTEM
                                
0001D2 02D2 216106          10      LD  HL,FDATA
0001D5 02D5 5D               4      LD  E,L
0001D6 02D6 54               4      LD  D,H
0001D7 02D7 13               6      INC DE
0001D8 02D8 AF               4      XOR A
0001D9 02D9 77               7      LD  (HL),A
0001DA 02DA 010304          10      LD  BC,$03FF+4
0001DD 02DD EDB0                    LDIR
                                ;
0001DF 02DF 216106          10      LD  HL,FDATA
0001E2 02E2 DD7E06          19      LD  A,(IX+6)    ;メディアバイト(DPB_06_FATID)
0001E5 02E5 77               7      LD  (HL),A      ;FATID
0001E6 02E6 23               6      INC HL
0001E7 02E7 35              11      DEC (HL)        ;LD (HL),$FF
0001E8 02E8 23               6      INC HL
0001E9 02E9 35              11      DEC (HL)        ;LD (HL),$FF
0001EA 02EA DDCB0F76        20      BIT 6,(IX+$0F)  ;FAT情報と論理セクタのサイズ(DPB_0F_BPS)
0001EE 02EE 2802            12      JR  Z,FAT12
0001F0 02F0 23               6      INC HL      ;FAT16の場合
0001F1 02F1 35              11      DEC (HL)        ;LD (HL),$FF
       02F2                     FAT12:
0001F2 02F2 DD5E0E          19      LD  E,(IX+$0E)  ;FAT領域の先頭論理セクタ番号(DPB_0E_FATPS)
0001F5 02F5 1600             7      LD  D,0
                                
0001F7 02F7 DD7E0F          19      LD  A,(IX+$0F)  ;FAT情報と論理セクタのサイズ(DPB_0F_BPS)
0001FA 02FA E680             7      AND $80     ;bit7:予備FAT
       02FC                     LOGIC0:
0001FC 02FC F5              11      PUSH    AF
0001FD 02FD DD4E00          19      LD  C,(IX+0)    ;FAT領域のセクタ単位でのサイズ(DPB_00_FATLN)
000200 0300 DD4601          19      LD  B,(IX+1)
000203 0303 216106          10      LD  HL,FDATA
       0306                     LOGIC1:
000206 0306 CD4804          17      CALL    DWT
000209 0309 B7               4      OR  A
00020A 030A C29604          10      JP  NZ,ERROR
00020D 030D 216506          10      LD  HL,FDATA+4
000210 0310 0B               6      DEC BC
000211 0311 78               4      LD  A,B
000212 0312 B1               4      OR  C
000213 0313 20F1            12      JR  NZ,LOGIC1
                                
000215 0315 F1              10      POP AF
000216 0316 87               4      ADD A,A     ;bit7:予備FAT
000217 0317 38E3            12      JR  C,LOGIC0
       0319                     LOGIC2:             ;ディレクトリエントリ
000219 0319 DD5E10          19      LD  E,(IX+$10)  ;ルートディレクトリ領域の先頭論理セクタ番号(DPB_10_DIRPS)
00021C 031C DD5611          19      LD  D,(IX+$11)
                                
00021F 031F DD460B          19      LD  B,(IX+$0B)  ;ルートディレクトリ領域の論理セクタ数(DPB_0B_DIRSCNT)
       0322                     LOGIC3:
000222 0322 216506          10      LD  HL,FDATA+4
000225 0325 CD4804          17      CALL    DWT
000228 0328 B7               4      OR  A
000229 0329 C29604          10      JP  NZ,ERROR
00022C 032C 10F4            13      DJNZ    LOGIC3
                                
00022E 032E 113505          10      LD  DE,COMMES
000231 0331 0E09             7      LD  C,9     ;文字列出力
000233 0333 CD0500          17      CALL    SYSTEM
       0336                     LOGICL:
000236 0336 C30000          10      JP  0
       0339                     SURE:
000239 0339 114305          10      LD  DE,HITMES
00023C 033C 0E09             7      LD  C,9     ;文字列出力
00023E 033E CD0500          17      CALL    SYSTEM
       0341                     SURE1:
000241 0341 0E08             7      LD  C,8     ;エコーなしコンソール入力
000243 0343 CD0500          17      CALL    SYSTEM
000246 0346 FE0D             7      CP  $0D
000248 0348 20F7            12      JR  NZ,SURE1
       034A                     LTNL:
00024A 034A F5              11      PUSH    AF
00024B 034B 1E0D             7      LD  E,$0D
00024D 034D 0E06             7      LD  C,6     ;コンソール直接入出力
00024F 034F CD0500          17      CALL    SYSTEM
000252 0352 1E0A             7      LD  E,$0A
000254 0354 0E06             7      LD  C,6     ;コンソール直接入出力
000256 0356 CD0500          17      CALL    SYSTEM
000259 0359 F1              10      POP AF
00025A 035A C9              10      RET
                                
       035B                     PHYSIC:
00025B 035B CD7B04          17      CALL    GUIDE
00025E 035E 110000          10      LD  DE,0
000261 0361 D9               4      EXX
000262 0362 2E00             7      LD  L,0     ;CYLINDER
       0364                     PH1:
000264 0364 C5              11      PUSH    BC
000265 0365 D5              11      PUSH    DE
000266 0366 E5              11      PUSH    HL
000267 0367 1E77             7      LD  E,"w"
000269 0369 0E02             7      LD  C,2     ;コンソール出力
00026B 036B CD0500          17      CALL    SYSTEM
00026E 036E E1              10      POP HL
00026F 036F D1              10      POP DE
000270 0370 C1              10      POP BC
       0371                     PH2:
000271 0371 D9               4      EXX
000272 0372 CD7E03          17      CALL    MAKE
000275 0375 D8              11      RET C
000276 0376 D9               4      EXX
000277 0377 2C               4      INC L
000278 0378 7D               4      LD  A,L
000279 0379 FE00             7  MAXCYL: CP  0
00027B 037B 38E7            12      JR  C,PH1
00027D 037D C9              10      RET
                                
       037E                     MAKE:
00027E 037E FD216106        14      LD  IY,FDATA
000282 0382 D9               4      EXX
000283 0383 0E00             7      LD  C,0     ;SIDE0
000285 0385 CDAA03          17      CALL    MKDATA
000288 0388 FD229A03        20      LD  (GDATA+1),IY
00028C 038C D9               4      EXX
00028D 038D 0E01             7      LD  C,1     ;SIDE1
00028F 038F CDAA03          17      CALL    MKDATA
                                
000292 0392 216106          10      LD  HL,FDATA
000295 0395 CD9C03          17      CALL    WTTRK
000298 0398 D8              11      RET C
000299 0399 216106          10  GDATA:  LD  HL,FDATA
       039C                     WTTRK:
00029C 039C D5              11      PUSH    DE
00029D 039D CDE800          17  WTTRKP: CALL    $00E8       ;#WTTRK
0002A0 03A0 D1              10      POP DE
                                ;
0002A1 03A1 DD6E0D          19      LD  L,(IX+$0D)  ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
0002A4 03A4 2600             7      LD  H,0
0002A6 03A6 19              11      ADD HL,DE
0002A7 03A7 EB               4      EX  DE,HL
0002A8 03A8 A7               4      AND A
0002A9 03A9 C9              10      RET
                                ;
       03AA                     MKDATA:
0002AA 03AA 2600             7      LD  H,0
0002AC 03AC D9               4      EXX
0002AD 03AD 21BE05          10  GAP1:   LD  HL,HGAP1
0002B0 03B0 CDF503          17      CALL    SETD
       03B3                     MAKE1:
0002B3 03B3 21C905          10  SEC:    LD  HL,HSEC
0002B6 03B6 CDF503          17      CALL    SETD
0002B9 03B9 D9               4      EXX
0002BA 03BA FD7500          19      LD  (IY+0),L        ;CYLINDER
0002BD 03BD FD23            10      INC IY
0002BF 03BF FD7100          19      LD  (IY+0),C        ;SIDE
0002C2 03C2 FD23            10      INC IY
0002C4 03C4 7D               4      LD  A,L
0002C5 03C5 B1               4      OR  C
0002C6 03C6 B4               4      OR  H
0002C7 03C7 3E01             7      LD  A,1
0002C9 03C9 2802            12      JR  Z,MAKES1
0002CB 03CB 7C               4      LD  A,H
0002CC 03CC 3C               4      INC A
       03CD                     MAKES1:
0002CD 03CD 24               4      INC H
0002CE 03CE FD7700          19      LD  (IY+0),A        ;SECTOR
0002D1 03D1 E5              11      PUSH    HL
0002D2 03D2 FD23            10      INC IY
0002D4 03D4 DD7E07          19      LD  A,(IX+$07)  ;1クラスタの論理セクタ数(DPB_07_SECPCL)
0002D7 03D7 FE01             7      CP  1
0002D9 03D9 2806            12      JR  Z,SIZE1024  ;1
0002DB 03DB 3804            12      JR  C,SIZE1024  ;0(v1.29まで)
       03DD                     SIZE512:            ;2 or $29(v1.29まで)
0002DD 03DD 3E02             7      LD  A,2
0002DF 03DF 1802            12      JR  SIZE
       03E1                     SIZE1024:
0002E1 03E1 3E03             7      LD  A,3
       03E3                     SIZE:
0002E3 03E3 FD7700          19      LD  (IY+0),A    ;SIZE
0002E6 03E6 FD23            10      INC IY
0002E8 03E8 D9               4      EXX
0002E9 03E9 CDF503          17      CALL    SETD
0002EC 03EC F1              10      POP AF      ;AF=HL
0002ED 03ED DDBE0D           7      CP  (IX+$0D)    ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
0002F0 03F0 38C1            12      JR  C,MAKE1
                                
0002F2 03F2 21E705          10      LD  HL,HGAP4
       03F5                     SETD:
0002F5 03F5 7E               7      LD  A,(HL)
0002F6 03F6 23               6      INC HL
0002F7 03F7 47               4      LD  B,A
0002F8 03F8 3C               4      INC A
0002F9 03F9 C8              11      RET Z
0002FA 03FA 7E               7      LD  A,(HL)
0002FB 03FB 23               6      INC HL
       03FC                     SETD1:
0002FC 03FC FD7700          19      LD  (IY+0),A
0002FF 03FF FD23            10      INC IY
000301 0401 10F9            13      DJNZ    SETD1
000303 0403 18F0            12      JR  SETD
                                
       0405                     VERIFY:
000305 0405 CD7B04          17      CALL    GUIDE
000308 0408 DD7E0D          19      LD  A,(IX+$0D)  ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
00030B 040B 87               4      ADD A,A
00030C 040C 4F               4      LD  C,A
                                
00030D 040D D9               4      EXX
00030E 040E 110000          10      LD  DE,0
000311 0411 D9               4      EXX
000312 0412 3A7A03          13      LD  A,(MAXCYL+1)
000315 0415 6F               4      LD  L,A
       0416                     VE2:
000316 0416 C5              11      PUSH    BC
000317 0417 D5              11      PUSH    DE
000318 0418 E5              11      PUSH    HL
000319 0419 1E76             7      LD  E,"v"
00031B 041B 0E02             7      LD  C,2     ;コンソール出力
00031D 041D CD0500          17      CALL    SYSTEM
000320 0420 E1              10      POP HL
000321 0421 D1              10      POP DE
000322 0422 C1              10      POP BC
000323 0423 C5              11      PUSH    BC
000324 0424 D9               4      EXX
000325 0425 D5              11      PUSH    DE
000326 0426 116106          10      LD  DE,FDATA
000329 0429 0E1A             7      LD  C,$1A       ;DTAの設定
00032B 042B CD0500          17      CALL    SYSTEM
00032E 042E D1              10      POP DE
00032F 042F E1              10      POP HL
000330 0430 E5              11      PUSH    HL
000331 0431 D5              11      PUSH    DE
000332 0432 65               4      LD  H,L
000333 0433 3A5C00          13      LD  A,(FCB1)
000336 0436 3D               4      DEC A
000337 0437 6F               4      LD  L,A
000338 0438 0E2F             7      LD  C,$2F       ;論理セクタを用いた読み出し
00033A 043A CD0500          17      CALL    SYSTEM
00033D 043D D1              10      POP DE
00033E 043E E1              10      POP HL
00033F 043F 2600             7      LD  H,0
000341 0441 19              11      ADD HL,DE
000342 0442 EB               4      EX  DE,HL
000343 0443 D9               4      EXX
                                ;
000344 0444 2D               4      DEC L
000345 0445 20CF            12      JR  NZ,VE2
       0447                     VERE:
000347 0447 C9              10      RET
                                
       0448                     DWT:
000348 0448 E5              11      PUSH    HL
000349 0449 C5              11      PUSH    BC
00034A 044A D5              11      PUSH    DE
00034B 044B EB               4      EX  DE,HL
00034C 044C 0E1A             7      LD  C,$1A       ;DTAの設定
00034E 044E CD0500          17      CALL    SYSTEM
000351 0451 D1              10      POP DE
000352 0452 D5              11      PUSH    DE
000353 0453 3A5C00          13      LD  A,(FCB1)
000356 0456 3D               4      DEC A
000357 0457 6F               4      LD  L,A
000358 0458 2601             7      LD  H,1
00035A 045A 0E30             7      LD  C,$30       ;論理セクタを用いた書き込み
00035C 045C CD0500          17      CALL    SYSTEM
00035F 045F D1              10      POP DE
000360 0460 13               6      INC DE
000361 0461 C1              10      POP BC
000362 0462 E1              10      POP HL
000363 0463 C9              10      RET
                                
       0464                     SWITCH:
000364 0464 118100          10      LD  DE,DTA+1
       0467                     SWITCH1:
000367 0467 1A               7      LD  A,(DE)
000368 0468 FE20             7      CP  $20
00036A 046A D8              11      RET C
00036B 046B 13               6      INC DE
00036C 046C FE2F             7      CP  "/"
00036E 046E 20F7            12      JR  NZ,SWITCH1
000370 0470 1A               7      LD  A,(DE)
000371 0471 13               6      INC DE
       0472                     CAP:
000372 0472 FE61             7      CP  "a"
000374 0474 D8              11      RET C
000375 0475 FE7B             7      CP  "z"+1
000377 0477 D0              11      RET NC
000378 0478 D620             7      SUB $20
00037A 047A C9              10      RET
                                
       047B                     GUIDE:
00037B 047B 3A7A03          13      LD  A,(MAXCYL+1)
00037E 047E 47               4      LD  B,A
00037F 047F 0E02             7      LD  C,2
000381 0481 1E2E             7      LD  E,"."
000383 0483 CD8C04          17      CALL    GUIDE1
000386 0486 3A7A03          13      LD  A,(MAXCYL+1)
000389 0489 47               4      LD  B,A
00038A 048A 1E08             7      LD  E,8     ;コンソール直接入出力
       048C                     GUIDE1:
00038C 048C C5              11      PUSH    BC
00038D 048D D5              11      PUSH    DE
00038E 048E CD0500          17      CALL    SYSTEM
000391 0491 D1              10      POP DE
000392 0492 C1              10      POP BC
000393 0493 10F7            13      DJNZ    GUIDE1
000395 0495 C9              10      RET
                                
       0496                     ERROR:
000396 0496 116105          10      LD  DE,ERRMES
000399 0499 0E09             7      LD  C,9     ;文字列出力
00039B 049B CD0500          17      CALL    SYSTEM
00039E 049E C30000          10      JP  0
                                
       04A1                     TITLE:
0003A1 04A1 583120666F726D61        DB  "X1 format v1.12",$0D,$0A
            742076312E31320D    
            0A                  
0003B2 04B2 24                      DB  "$"
       04B3                     MUSAGE:
0003B3 04B3 75736167653A2046        DB  "usage: FORMAT ﾄﾞﾗｲﾌﾞ:[ｽｲｯﾁ]",$0D,$0A
            4F524D415420C4DE    
            D7B2CCDE3A5BBDB2    
            AFC15D0D0A          
0003D0 04D0 092F432020464154        DB  9,"/C  FAT･ﾃﾞｨﾚｸﾄﾘ ｼｮｷｶ",$0D,$0A
            A5C3DEA8DAB8C4D8    
            20BCAEB7B60D0A      
                                ;   DB  9,"/On ｵｰﾊﾞｰﾄﾗｯｸ(n:1-9)",$0D,$0A
0003E7 04E7 24                      DB  "$"
       04E8                     FORMES:
0003E8 04E8 666F726D61742024        DB  "format $"
       04F0                     FOTMES:
0003F0 04F0 666F726D61742074        DB  "format type (2D=0,2DD=1,2HD=2)? $"
            797065202832443D    
            302C3244443D312C    
            3248443D32293F20    
            24                  
       0511                     PHYMES:
000411 0511 706879736963616C        DB  "physical format",$0D,$0A,"$"
            20666F726D61740D    
            0A24                
       0523                     LOGMES:
000423 0523 6C6F676963616C20        DB  "logical  format",$0D,$0A,"$"
            20666F726D61740D    
            0A24                
       0535                     COMMES:
000435 0535 636F6D706C657465        DB  "completed !",$0D,$0A,"$"
            6420210D0A24        
       0543                     HITMES:
000443 0543 686974205B43525D        DB  "hit [CR] to start$"
            20746F2073746172    
            7424                
       0555                     OVERMES:
000455 0555 6F76657220747261        DB  "over track:$"
            636B3A24            
       0561                     ERRMES:
000461 0561 074572726F72210D        DB  7,"Error!",$0D,$0A,"$"
            0A24                
                                ;
                                ;   DPB Data
                                ;
                                
00046B 056B 0200                M2D:    DW  2
00046D 056D FD02                    DB  $FD,2
00046F 056F 6401                    DW  356
000471 0571 FF0728090182            DB  $FF,7,40,9,1,$82
000477 0577 0500A7000800            DW  5,$A7,8
                                
00047D 057D 0300                M2DD:   DW  3
00047F 057F F902                    DB  $F9,2
000481 0581 CB02                    DW  715
000483 0583 FF0750090182            DB  $FF,7,80,9,1,$82
000489 0589 0700A7000A00            DW  7,$A7,10
                                
00048F 058F 0200                M2HD:   DW  2
000491 0591 FE01                    DB  $FE,1
000493 0593 C704                    DW  1223
000495 0595 FE064D080184            DB  $FE,6,77,8,1,$84
00049B 059B 0500A7000900            DW  5,$A7,9
                                
                                ;M2HS:  DB  3
                                ;   DW  $FB,8
                                ;   DW  1432
                                ;   DB  $FE,10,80,9,1,4,4,10
                                ;
                                ;   Format Data 2D/2DD
                                ;
0004A1 05A1 204EFF              LGAP1:  DB  32,$4E,255
                                ;
0004A4 05A4 0C0003F501FEFF      LSEC:   DB  12,$00,3,$F5,1,$FE,255
                                ;
0004AB 05AB 01F7164E0C0003F5        DB  1,$F7,22,$4E,12,$00,3,$F5,1,$FB
            01FB                
0004B5 05B5 00E500E5                DB  0,$E5,0,$E5
0004B9 05B9 01F7544EFF              DB  1,$F7,84,$4E,255
                                ;
                                ;   Format Data 2HD
                                ;
0004BE 05BE 504E0C0003F601FC    HGAP1:  DB  80,$4E,12,$00,3,$F6,1,$FC,50,$4E,255
            324EFF              
                                ;
0004C9 05C9 0C0003F501FEFF      HSEC:   DB  12,$00,3,$F5,1,$FE,255
                                ;
0004D0 05D0 01F7164E0C0003F5        DB  1,$F7,22,$4E,12,$00,3,$F5,1,$FB
            01FB                
0004DA 05DA 00E500E500E500E5        DB  0,$E5,0,$E5,0,$E5,0,$E5
0004E2 05E2 01F7744EFF              DB  1,$F7,116,$4E,255
                                ;
0004E7 05E7 004E004E004EFF      HGAP4:  DB  0,$4E,0,$4E,0,$4E,255
                                ;
                                ;   Format Data 2HS
                                ;
                                ;SSEC:  DB  12,$00,3,$F5,1,$FE,255
                                ;
                                ;   DB  1,$F7,22,$4E,12,$00,3,$F5,1,$FB
                                ;   DB  0,$E5,0,$E5,0,$E5,0,$E5
                                ;   DB  1,$F7,53,$4E,255
                                ;
                                ;   BOOT-DATA
                                ;
0004EE 05EE EBFE904C44202020    LIPL:   DB  $EB,$FE,$90,"L","D",$20,$20,$20
0004F6 05F6 2020200002020100        DB  $20,$20,$20,$00,$02,$02,$01,$00
0004FE 05FE 027000D002FD0200        DB  $02,$70,$00,$D0,$02,$FD,$02,$00
000506 0606 09000200000018FE        DB  $09,$00,$02,$00,$00,$00,$18,$FE
00050E 060E 0000                    DB  $00,$00
                                
000510 0610 EBFE904C44202020    DIPL:   DB  $EB,$FE,$90,"L","D",$20,$20,$20
000518 0618 2020200002020100        DB  $20,$20,$20,$00,$02,$02,$01,$00
000520 0620 027000D002F90300        DB  $02,$70,$00,$D0,$02,$F9,$03,$00
000528 0628 09000200000018FE        DB  $09,$00,$02,$00,$00,$00,$18,$FE
000530 0630 0000                    DB  $00,$00
                                
000532 0632 EBFE904C44202020    HIPL:   DB  $EB,$FE,$90,"L","D",$20,$20,$20
00053A 063A 2020200004010100        DB  $20,$20,$20,$00,$04,$01,$01,$00
000542 0642 02C000D004FE0200        DB  $02,$C0,$00,$D0,$04,$FE,$02,$00
00054A 064A 08000200000018FE        DB  $08,$00,$02,$00,$00,$00,$18,$FE
000552 0652 0000                    DB  $00,$00
                                
                                ;SIPL:  DB  $EB,$1E,$90,"L","D",$20,$20,$20
                                ;   DB  $20,$20,$20,"2","H","S",$20,$20
                                ;   DB  $20,$20,$04,$00,$01,$03,$00,$01
                                ;   DB  $00,$C0,$05,$A0,$FB,$01,$18,$FE
                                ;   DB  $EB,$FE
                                
       0654                     IPLPRG:
000554 0654 01FC0F          10      LD  BC,$FFC
000557 0657 ED71                    DB  $ED,$71
000559 0659 3E07             7      LD  A,7
00055B 065B 3286FF          13      LD  ($FF86),A
00055E 065E C3F500          10      JP  $F5
       0661                     IPLPEND:
       0661                     FDATA:
[EOF:FORMAT.ASM:SHIFT_JIS]
