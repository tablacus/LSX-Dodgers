                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;
                                ;   FORMAT by Gaku
                                ;
       0003                     OSFLG   EQU $0003
       0005                     SYSTEM  EQU $0005
       000B                     BASE    EQU $000B
       000F                     JP_HL   EQU $000F
       0018                     BIOS    EQU $0018
       005C                     FCB1    EQU $005C
       0080                     DTA EQU $0080
                                
000000 0100                         ORG $0100
000000 0100 C30301          10      JP  START
       0103                     START:
000003 0103 11AB04          10      LD  DE,TITLE
000006 0106 0E09             7      LD  C,9     ;文字列出力
000008 0108 CD0500          17      CALL    SYSTEM
00000B 010B 3A0B00          13      LD  A,(BASE)
00000E 010E 32A903          13      LD  (WTTRKP+2),A
000011 0111 3A5C00          13      LD  A,(FCB1)
000014 0114 B7               4      OR  A
000015 0115 200B            12      JR  NZ,MAIN
       0117                     USAGE:
000017 0117 11BD04          10      LD  DE,MUSAGE
00001A 011A 0E09             7      LD  C,9     ;文字列出力
00001C 011C CD0500          17      CALL    SYSTEM
00001F 011F C30000          10      JP  0
       0122                     MAIN:
000022 0122 2A0300          16      LD  HL,(OSFLG)
000025 0125 7C               4      LD  A,H
000026 0126 FE1D             7      CP  1DH
000028 0128 C0              11      RET NZ
000029 0129 7D               4      LD  A,L
00002A 012A B7               4      OR  A       ;X1
00002B 012B C0              11      RET NZ
                                
00002C 012C ED7B0600        20      LD  SP,(SYSTEM+1)
000030 0130 3A5C00          13      LD  A,(FCB1)
000033 0133 3D               4      DEC A
000034 0134 2A0A00          16      LD  HL,(BASE-1)
000037 0137 2EDC             7      LD  L,$DC       ;GETDPB
000039 0139 CD0F00          17      CALL    JP_HL
00003C 013C 38D9            12      JR  C,USAGE
                                
00003E 013E CD6E04          17      CALL    SWITCH
000041 0141 FE20             7      CP  $20
000043 0143 3819            12      JR  C,MAIN1
000045 0145 FE4F             7      CP  'O'
000047 0147 200E            12      JR  NZ,SW1
000049 0149 1A               7      LD  A,(DE)
00004A 014A D630             7      SUB '0'
00004C 014C 38C9            12      JR  C,USAGE
00004E 014E FE0A             7      CP  10
000050 0150 30C5            12      JR  NC,USAGE
000052 0152 329501          13      LD  (OVER+1),A
000055 0155 1807            12      JR  MAIN1
       0157                     SW1:
000057 0157 D643             7      SUB 'C'
000059 0159 20BC            12      JR  NZ,USAGE
00005B 015B 328901          13      LD  (LOGSW+1),A
       015E                     MAIN1:
00005E 015E 11F204          10      LD  DE,FORMES   ;format
000061 0161 0E09             7      LD  C,9     ;文字列出力
000063 0163 CD0500          17      CALL    SYSTEM
                                
000066 0166 010604          10      LD  BC,$0406
000069 0169 DDE5            15      PUSH    IX
       016B                     PRNAME:
00006B 016B DD5E1C          19      LD  E,(IX+$1C)  ;デバイスの名前(DPB_1C_NAME)
00006E 016E 0E06             7      LD  C,6     ;コンソール直接入出力
000070 0170 C5              11      PUSH    BC
000071 0171 CD0500          17      CALL    SYSTEM
000074 0174 C1              10      POP BC
000075 0175 DD23            10      INC IX
000077 0177 10F2            13      DJNZ    PRNAME
000079 0179 DDE1            14      POP IX
00007B 017B CD5403          17      CALL    LTNL
                                
00007E 017E DD7E12          19      LD  A,(IX+$12)  ;デバイス情報(DPB_12_DEVICE)
000081 0181 E60F             7      AND $0F
000083 0183 FE07             7      CP  7
000085 0185 C2D102          10      JP  NZ,LOGIC
000088 0188 3E01             7  LOGSW:  LD  A,1
00008A 018A B7               4      OR  A
00008B 018B CAC402          10      JP  Z,LOGICY
                                
00008E 018E 3A1800          13      LD  A,(BIOS)
000091 0191 3C               4      INC A
000092 0192 2805            12      JR  Z,NONT
                                
000094 0194 3E00             7  OVER:   LD  A,$00
000096 0196 B7               4      OR  A
000097 0197 2046            12      JR  NZ,TYPEO
       0199                     NONT:
000099 0199 11FA04          10      LD  DE,FOTMES   ;format type
00009C 019C 0E09             7      LD  C,9     ;文字列出力
00009E 019E CD0500          17      CALL    SYSTEM
       01A1                     TYPE:
0000A1 01A1 0E08             7      LD  C,8     ;エコーなしコンソール入力
0000A3 01A3 CD0500          17      CALL    SYSTEM
0000A6 01A6 CD7C04          17      CALL    CAP
0000A9 01A9 FE30             7      CP  '0'
0000AB 01AB 2817            12      JR  Z,TYPE0
0000AD 01AD FE31             7      CP  '1'
0000AF 01AF 281E            12      JR  Z,TYPE1
0000B1 01B1 47               4      LD  B,A
0000B2 01B2 3A1800          13      LD  A,(BIOS)
0000B5 01B5 3C               4      INC A
0000B6 01B6 28E9            12      JR  Z,TYPE
0000B8 01B8 78               4      LD  A,B
0000B9 01B9 FE32             7      CP  '2'
0000BB 01BB 2817            12      JR  Z,TYPE2
0000BD 01BD FE4C             7      CP  'L'
0000BF 01BF CABC02          10      JP  Z,TYPEY
0000C2 01C2 18DD            12      JR  TYPE
       01C4                     TYPE0:
0000C4 01C4 218405          10      LD  HL,M2D
       01C7                     TYPE1X:
0000C7 01C7 01BA05          10      LD  BC,LGAP1
0000CA 01CA 11BD05          10      LD  DE,LSEC
0000CD 01CD 1823            12      JR  TYPEX
       01CF                     TYPE1:
0000CF 01CF 219605          10      LD  HL,M2DD
0000D2 01D2 18F3            12      JR  TYPE1X
       01D4                     TYPE2:
0000D4 01D4 01D705          10      LD  BC,HGAP1
0000D7 01D7 11E205          10      LD  DE,HSEC
0000DA 01DA 21A805          10      LD  HL,M2HD
0000DD 01DD 1813            12      JR  TYPEX
       01DF                     TYPEO:
0000DF 01DF F5              11      PUSH    AF
0000E0 01E0 116E05          10      LD  DE,OVERMES
0000E3 01E3 0E09             7      LD  C,9     ;文字列出力
0000E5 01E5 CD0500          17      CALL    SYSTEM
0000E8 01E8 F1              10      POP AF
0000E9 01E9 C630             7      ADD A,'0'
0000EB 01EB 5F               4      LD  E,A
0000EC 01EC 0E02             7      LD  C,2     ;コンソール出力
0000EE 01EE CD0500          17      CALL    SYSTEM
0000F1 01F1 AF               4      XOR A
                                ;TYPES:
                                ;   LD  BC,HGAP1
                                ;   LD  DE,SSEC
                                ;   LD  HL,M2HS
       01F2                     TYPEX:
0000F2 01F2 ED43B803        20      LD  (GAP1+1),BC
0000F6 01F6 ED53BE03        20      LD  (SEC+1),DE
                                
0000FA 01FA 5F               4      LD  E,A
0000FB 01FB 0E02             7      LD  C,2     ;コンソール出力
0000FD 01FD CD0500          17      CALL    SYSTEM
000100 0200 CD5403          17      CALL    LTNL
                                
000103 0203 DDE5            15      PUSH    IX
000105 0205 D1              10      POP DE
000106 0206 EDA0            16      LDI
000108 0208 EDA0            16      LDI
00010A 020A 13               6      INC DE
00010B 020B 13               6      INC DE
00010C 020C 13               6      INC DE
00010D 020D 13               6      INC DE
00010E 020E 010C00          10      LD  BC,12
000111 0211 EDB0                    LDIR
                                
000113 0213 3A9501          13      LD  A,(OVER+1)
000116 0216 B7               4      OR  A
000117 0217 2819            12      JR  Z,OTFE
                                
000119 0219 C650             7      ADD A,80
00011B 021B DD770C          19      LD  (IX+$0C),A  ;フロッピーディスクのシリンダ数(DPB_0C_MAXCYL)
00011E 021E D650             7      SUB 80
000120 0220 87               4      ADD A,A ;*2
000121 0221 4F               4      LD  C,A
000122 0222 87               4      ADD A,A ;*4
000123 0223 87               4      ADD A,A ;*8
000124 0224 87               4      ADD A,A ;*16
000125 0225 81               4      ADD A,C ;*18
000126 0226 C698             7      ADD A,$98
000128 0228 DD7708          19      LD  (IX+8),A    ;総クラスタ数(DPB_08_MAXCL)
00012B 022B 3E05             7      LD  A,5
00012D 022D CE00             7      ADC A,0
00012F 022F DD7709          19      LD  (IX+9),A    ;総クラスタ数(DPB_08_MAXCL)
       0232                     OTFE:
000132 0232 DD7E0C          19      LD  A,(IX+$0C)  ;フロッピーディスクのシリンダ数(DPB_0C_MAXCYL)
000135 0235 328403          13      LD  (MAXCYL+1),A
                                
000138 0238 2A0A00          16      LD  HL,(BASE-1)
00013B 023B 2E89             7      LD  L,$89
00013D 023D 36FF            10      LD  (HL),$FF
                                
00013F 023F 3A5C00          13      LD  A,(FCB1)
000142 0242 3D               4      DEC A
000143 0243 E5              11      PUSH    HL
000144 0244 2ED9             7      LD  L,$D9       ;CHGDRV
000146 0246 CD0F00          17      CALL    JP_HL
000149 0249 E1              10      POP HL
00014A 024A DD7E13          19      LD  A,(IX+$13)  ;デバイスドライバ内におけるユニット番号(DPB_13_UNITNO)
00014D 024D E603             7      AND 3
00014F 024F F680             7      OR  $80
000151 0251 6F               4      LD  L,A
000152 0252 36FF            10      LD  (HL),$FF
000154 0254 CD4303          17      CALL    SURE
                                
000157 0257 112A05          10      LD  DE,PHYMES
00015A 025A 0E09             7      LD  C,9     ;文字列出力
00015C 025C CD0500          17      CALL    SYSTEM
                                
00015F 025F CD6503          17      CALL    PHYSIC
000162 0262 CD5403          17      CALL    LTNL
000165 0265 DAA004          10      JP  C,ERROR
000168 0268 CD0F04          17      CALL    VERIFY
00016B 026B CD5403          17      CALL    LTNL
00016E 026E DAA004          10      JP  C,ERROR
                                
000171 0271 217A06          10      LD  HL,FDATA
000174 0274 117B06          10      LD  DE,FDATA+1
000177 0277 3600            10      LD  (HL),0
000179 0279 010004          10      LD  BC,$400
00017C 027C EDB0                    LDIR
00017E 027E DD7E06          19      LD  A,(IX+6)    ;メディアバイト(DPB_06_FATID)
000181 0281 FEFD             7      CP  $FD
000183 0283 210706          10      LD  HL,LIPL
000186 0286 280A            12      JR  Z,IPL
000188 0288 FEF9             7      CP  $F9
00018A 028A 212906          10      LD  HL,DIPL
00018D 028D 2803            12      JR  Z,IPL
                                ;   CP  $FB
                                ;   LD  HL,SIPL
                                ;   JR  Z,IPL
00018F 028F 214B06          10      LD  HL,HIPL
       0292                     IPL:
000192 0292 117A06          10      LD  DE,FDATA
000195 0295 0E22             7      LD  C,$22
000197 0297 EDB0                    LDIR
000199 0299 216D06          10      LD  HL,IPLPRG
00019C 029C 0E0D             7      LD  C,IPLPEND-IPLPRG
00019E 029E EDB0                    LDIR
0001A0 02A0 215A08          10      LD  HL,FDATA+$1E0
0001A3 02A3 0610             7      LD  B,$10
       02A5                     LOW1:
0001A5 02A5 3622            10      LD  (HL),$22
0001A7 02A7 23               6      INC HL
0001A8 02A8 36FE            10      LD  (HL),$FE
0001AA 02AA 23               6      INC HL
0001AB 02AB 10F8            13      DJNZ    LOW1
                                
0001AD 02AD 110000          10      LD  DE,0
0001B0 02B0 217A06          10      LD  HL,FDATA
0001B3 02B3 CD5204          17      CALL    DWT
0001B6 02B6 B7               4      OR  A
0001B7 02B7 C2A004          10      JP  NZ,ERROR
                                
0001BA 02BA 1818            12      JR  LOGICX
       02BC                     TYPEY:
0001BC 02BC 11BA04          10      LD  DE,CRLF
0001BF 02BF 0E09             7      LD  C,9     ;文字列出力
0001C1 02C1 CD0500          17      CALL    SYSTEM
       02C4                     LOGICY:
0001C4 02C4 3A5C00          13      LD  A,(FCB1)
0001C7 02C7 5F               4      LD  E,A
0001C8 02C8 0E1B             7      LD  C,$1B       ;ディスク情報の獲得
0001CA 02CA CD0500          17      CALL    SYSTEM
0001CD 02CD 3C               4      INC A
0001CE 02CE CAA004          10      JP  Z,ERROR
       02D1                     LOGIC:
0001D1 02D1 CD4303          17      CALL    SURE
       02D4                     LOGICX:
0001D4 02D4 113C05          10      LD  DE,LOGMES
0001D7 02D7 0E09             7      LD  C,9     ;文字列出力
0001D9 02D9 CD0500          17      CALL    SYSTEM
                                
0001DC 02DC 217A06          10      LD  HL,FDATA
0001DF 02DF 5D               4      LD  E,L
0001E0 02E0 54               4      LD  D,H
0001E1 02E1 13               6      INC DE
0001E2 02E2 AF               4      XOR A
0001E3 02E3 77               7      LD  (HL),A
0001E4 02E4 010304          10      LD  BC,$03FF+4
0001E7 02E7 EDB0                    LDIR
                                ;
0001E9 02E9 217A06          10      LD  HL,FDATA
0001EC 02EC DD7E06          19      LD  A,(IX+6)    ;メディアバイト(DPB_06_FATID)
0001EF 02EF 77               7      LD  (HL),A      ;FATID
0001F0 02F0 23               6      INC HL
0001F1 02F1 35              11      DEC (HL)        ;LD (HL),$FF
0001F2 02F2 23               6      INC HL
0001F3 02F3 35              11      DEC (HL)        ;LD (HL),$FF
0001F4 02F4 DDCB0F76        20      BIT 6,(IX+$0F)  ;FAT情報と論理セクタのサイズ(DPB_0F_BPS)
0001F8 02F8 2802            12      JR  Z,FAT12
0001FA 02FA 23               6      INC HL      ;FAT16の場合
0001FB 02FB 35              11      DEC (HL)        ;LD (HL),$FF
       02FC                     FAT12:
0001FC 02FC DD5E0E          19      LD  E,(IX+$0E)  ;FAT領域の先頭論理セクタ番号(DPB_0E_FATPS)
0001FF 02FF 1600             7      LD  D,0
                                
000201 0301 DD7E0F          19      LD  A,(IX+$0F)  ;FAT情報と論理セクタのサイズ(DPB_0F_BPS)
000204 0304 E680             7      AND $80     ;bit7:予備FAT
       0306                     LOGIC0:
000206 0306 F5              11      PUSH    AF
000207 0307 DD4E00          19      LD  C,(IX+0)    ;FAT領域のセクタ単位でのサイズ(DPB_00_FATLN)
00020A 030A DD4601          19      LD  B,(IX+1)
00020D 030D 217A06          10      LD  HL,FDATA
       0310                     LOGIC1:
000210 0310 CD5204          17      CALL    DWT
000213 0313 B7               4      OR  A
000214 0314 C2A004          10      JP  NZ,ERROR
000217 0317 217E06          10      LD  HL,FDATA+4
00021A 031A 0B               6      DEC BC
00021B 031B 78               4      LD  A,B
00021C 031C B1               4      OR  C
00021D 031D 20F1            12      JR  NZ,LOGIC1
                                
00021F 031F F1              10      POP AF
000220 0320 87               4      ADD A,A     ;bit7:予備FAT
000221 0321 38E3            12      JR  C,LOGIC0
       0323                     LOGIC2:             ;ディレクトリエントリ
000223 0323 DD5E10          19      LD  E,(IX+$10)  ;ルートディレクトリ領域の先頭論理セクタ番号(DPB_10_DIRPS)
000226 0326 DD5611          19      LD  D,(IX+$11)
                                
000229 0329 DD460B          19      LD  B,(IX+$0B)  ;ルートディレクトリ領域の論理セクタ数(DPB_0B_DIRSCNT)
       032C                     LOGIC3:
00022C 032C 217E06          10      LD  HL,FDATA+4
00022F 032F CD5204          17      CALL    DWT
000232 0332 B7               4      OR  A
000233 0333 C2A004          10      JP  NZ,ERROR
000236 0336 10F4            13      DJNZ    LOGIC3
                                
000238 0338 114E05          10      LD  DE,COMMES
00023B 033B 0E09             7      LD  C,9     ;文字列出力
00023D 033D CD0500          17      CALL    SYSTEM
       0340                     LOGICL:
000240 0340 C30000          10      JP  0
       0343                     SURE:
000243 0343 115C05          10      LD  DE,HITMES
000246 0346 0E09             7      LD  C,9     ;文字列出力
000248 0348 CD0500          17      CALL    SYSTEM
       034B                     SURE1:
00024B 034B 0E08             7      LD  C,8     ;エコーなしコンソール入力
00024D 034D CD0500          17      CALL    SYSTEM
000250 0350 FE0D             7      CP  $0D
000252 0352 20F7            12      JR  NZ,SURE1
       0354                     LTNL:
000254 0354 F5              11      PUSH    AF
000255 0355 1E0D             7      LD  E,$0D
000257 0357 0E06             7      LD  C,6     ;コンソール直接入出力
000259 0359 CD0500          17      CALL    SYSTEM
00025C 035C 1E0A             7      LD  E,$0A
00025E 035E 0E06             7      LD  C,6     ;コンソール直接入出力
000260 0360 CD0500          17      CALL    SYSTEM
000263 0363 F1              10      POP AF
000264 0364 C9              10      RET
                                
       0365                     PHYSIC:
000265 0365 CD8504          17      CALL    GUIDE
000268 0368 110000          10      LD  DE,0
00026B 036B D9               4      EXX
00026C 036C 2E00             7      LD  L,0     ;CYLINDER
       036E                     PH1:
00026E 036E C5              11      PUSH    BC
00026F 036F D5              11      PUSH    DE
000270 0370 E5              11      PUSH    HL
000271 0371 1E77             7      LD  E,'w'
000273 0373 0E02             7      LD  C,2     ;コンソール出力
000275 0375 CD0500          17      CALL    SYSTEM
000278 0378 E1              10      POP HL
000279 0379 D1              10      POP DE
00027A 037A C1              10      POP BC
       037B                     PH2:
00027B 037B D9               4      EXX
00027C 037C CD8803          17      CALL    MAKE
00027F 037F D8              11      RET C
000280 0380 D9               4      EXX
000281 0381 2C               4      INC L
000282 0382 7D               4      LD  A,L
000283 0383 FE00             7  MAXCYL: CP  0
000285 0385 38E7            12      JR  C,PH1
000287 0387 C9              10      RET
                                
       0388                     MAKE:
000288 0388 FD217A06        14      LD  IY,FDATA
00028C 038C D9               4      EXX
00028D 038D 0E00             7      LD  C,0     ;SIDE0
00028F 038F CDB403          17      CALL    MKDATA
000292 0392 FD22A403        20      LD  (GDATA+1),IY
000296 0396 D9               4      EXX
000297 0397 0E01             7      LD  C,1     ;SIDE1
000299 0399 CDB403          17      CALL    MKDATA
                                
00029C 039C 217A06          10      LD  HL,FDATA
00029F 039F CDA603          17      CALL    WTTRK
0002A2 03A2 D8              11      RET C
0002A3 03A3 217A06          10  GDATA:  LD  HL,FDATA
       03A6                     WTTRK:
0002A6 03A6 D5              11      PUSH    DE
0002A7 03A7 CDE800          17  WTTRKP: CALL    $00E8       ;#WTTRK
0002AA 03AA D1              10      POP DE
                                ;
0002AB 03AB DD6E0D          19      LD  L,(IX+$0D)  ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
0002AE 03AE 2600             7      LD  H,0
0002B0 03B0 19              11      ADD HL,DE
0002B1 03B1 EB               4      EX  DE,HL
0002B2 03B2 A7               4      AND A
0002B3 03B3 C9              10      RET
                                ;
       03B4                     MKDATA:
0002B4 03B4 2600             7      LD  H,0
0002B6 03B6 D9               4      EXX
0002B7 03B7 21D705          10  GAP1:   LD  HL,HGAP1
0002BA 03BA CDFF03          17      CALL    SETD
       03BD                     MAKE1:
0002BD 03BD 21E205          10  SEC:    LD  HL,HSEC
0002C0 03C0 CDFF03          17      CALL    SETD
0002C3 03C3 D9               4      EXX
0002C4 03C4 FD7500          19      LD  (IY+0),L        ;CYLINDER
0002C7 03C7 FD23            10      INC IY
0002C9 03C9 FD7100          19      LD  (IY+0),C        ;SIDE
0002CC 03CC FD23            10      INC IY
0002CE 03CE 7D               4      LD  A,L
0002CF 03CF B1               4      OR  C
0002D0 03D0 B4               4      OR  H
0002D1 03D1 3E01             7      LD  A,1
0002D3 03D3 2802            12      JR  Z,MAKES1
0002D5 03D5 7C               4      LD  A,H
0002D6 03D6 3C               4      INC A
       03D7                     MAKES1:
0002D7 03D7 24               4      INC H
0002D8 03D8 FD7700          19      LD  (IY+0),A        ;SECTOR
0002DB 03DB E5              11      PUSH    HL
0002DC 03DC FD23            10      INC IY
0002DE 03DE DD7E07          19      LD  A,(IX+$07)  ;1クラスタの論理セクタ数(DPB_07_SECPCL)
0002E1 03E1 FE01             7      CP  1
0002E3 03E3 2806            12      JR  Z,SIZE1024  ;1
0002E5 03E5 3804            12      JR  C,SIZE1024  ;0(v1.29まで)
       03E7                     SIZE512:            ;2 or $29(v1.29まで)
0002E7 03E7 3E02             7      LD  A,2
0002E9 03E9 1802            12      JR  SIZE
       03EB                     SIZE1024:
0002EB 03EB 3E03             7      LD  A,3
       03ED                     SIZE:
0002ED 03ED FD7700          19      LD  (IY+0),A    ;SIZE
0002F0 03F0 FD23            10      INC IY
0002F2 03F2 D9               4      EXX
0002F3 03F3 CDFF03          17      CALL    SETD
0002F6 03F6 F1              10      POP AF      ;AF=HL
0002F7 03F7 DDBE0D           7      CP  (IX+$0D)    ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
0002FA 03FA 38C1            12      JR  C,MAKE1
                                
0002FC 03FC 210006          10      LD  HL,HGAP4
       03FF                     SETD:
0002FF 03FF 7E               7      LD  A,(HL)
000300 0400 23               6      INC HL
000301 0401 47               4      LD  B,A
000302 0402 3C               4      INC A
000303 0403 C8              11      RET Z
000304 0404 7E               7      LD  A,(HL)
000305 0405 23               6      INC HL
       0406                     SETD1:
000306 0406 FD7700          19      LD  (IY+0),A
000309 0409 FD23            10      INC IY
00030B 040B 10F9            13      DJNZ    SETD1
00030D 040D 18F0            12      JR  SETD
                                
       040F                     VERIFY:
00030F 040F CD8504          17      CALL    GUIDE
000312 0412 DD7E0D          19      LD  A,(IX+$0D)  ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
000315 0415 87               4      ADD A,A
000316 0416 4F               4      LD  C,A
                                
000317 0417 D9               4      EXX
000318 0418 110000          10      LD  DE,0
00031B 041B D9               4      EXX
00031C 041C 3A8403          13      LD  A,(MAXCYL+1)
00031F 041F 6F               4      LD  L,A
       0420                     VE2:
000320 0420 C5              11      PUSH    BC
000321 0421 D5              11      PUSH    DE
000322 0422 E5              11      PUSH    HL
000323 0423 1E76             7      LD  E,'v'
000325 0425 0E02             7      LD  C,2     ;コンソール出力
000327 0427 CD0500          17      CALL    SYSTEM
00032A 042A E1              10      POP HL
00032B 042B D1              10      POP DE
00032C 042C C1              10      POP BC
00032D 042D C5              11      PUSH    BC
00032E 042E D9               4      EXX
00032F 042F D5              11      PUSH    DE
000330 0430 117A06          10      LD  DE,FDATA
000333 0433 0E1A             7      LD  C,$1A       ;DTAの設定
000335 0435 CD0500          17      CALL    SYSTEM
000338 0438 D1              10      POP DE
000339 0439 E1              10      POP HL
00033A 043A E5              11      PUSH    HL
00033B 043B D5              11      PUSH    DE
00033C 043C 65               4      LD  H,L
00033D 043D 3A5C00          13      LD  A,(FCB1)
000340 0440 3D               4      DEC A
000341 0441 6F               4      LD  L,A
000342 0442 0E2F             7      LD  C,$2F       ;論理セクタを用いた読み出し
000344 0444 CD0500          17      CALL    SYSTEM
000347 0447 D1              10      POP DE
000348 0448 E1              10      POP HL
000349 0449 2600             7      LD  H,0
00034B 044B 19              11      ADD HL,DE
00034C 044C EB               4      EX  DE,HL
00034D 044D D9               4      EXX
                                ;
00034E 044E 2D               4      DEC L
00034F 044F 20CF            12      JR  NZ,VE2
       0451                     VERE:
000351 0451 C9              10      RET
                                
       0452                     DWT:
000352 0452 E5              11      PUSH    HL
000353 0453 C5              11      PUSH    BC
000354 0454 D5              11      PUSH    DE
000355 0455 EB               4      EX  DE,HL
000356 0456 0E1A             7      LD  C,$1A       ;DTAの設定
000358 0458 CD0500          17      CALL    SYSTEM
00035B 045B D1              10      POP DE
00035C 045C D5              11      PUSH    DE
00035D 045D 3A5C00          13      LD  A,(FCB1)
000360 0460 3D               4      DEC A
000361 0461 6F               4      LD  L,A
000362 0462 2601             7      LD  H,1
000364 0464 0E30             7      LD  C,$30       ;論理セクタを用いた書き込み
000366 0466 CD0500          17      CALL    SYSTEM
000369 0469 D1              10      POP DE
00036A 046A 13               6      INC DE
00036B 046B C1              10      POP BC
00036C 046C E1              10      POP HL
00036D 046D C9              10      RET
                                
       046E                     SWITCH:
00036E 046E 118100          10      LD  DE,DTA+1
       0471                     SWITCH1:
000371 0471 1A               7      LD  A,(DE)
000372 0472 FE20             7      CP  $20
000374 0474 D8              11      RET C
000375 0475 13               6      INC DE
000376 0476 FE2F             7      CP  '/'
000378 0478 20F7            12      JR  NZ,SWITCH1
00037A 047A 1A               7      LD  A,(DE)
00037B 047B 13               6      INC DE
       047C                     CAP:
00037C 047C FE61             7      CP  'a'
00037E 047E D8              11      RET C
00037F 047F FE7B             7      CP  'z'+1
000381 0481 D0              11      RET NC
000382 0482 D620             7      SUB $20
000384 0484 C9              10      RET
                                
       0485                     GUIDE:
000385 0485 3A8403          13      LD  A,(MAXCYL+1)
000388 0488 47               4      LD  B,A
000389 0489 0E02             7      LD  C,2
00038B 048B 1E2E             7      LD  E,'.'
00038D 048D CD9604          17      CALL    GUIDE1
000390 0490 3A8403          13      LD  A,(MAXCYL+1)
000393 0493 47               4      LD  B,A
000394 0494 1E08             7      LD  E,8     ;コンソール直接入出力
       0496                     GUIDE1:
000396 0496 C5              11      PUSH    BC
000397 0497 D5              11      PUSH    DE
000398 0498 CD0500          17      CALL    SYSTEM
00039B 049B D1              10      POP DE
00039C 049C C1              10      POP BC
00039D 049D 10F7            13      DJNZ    GUIDE1
00039F 049F C9              10      RET
                                
       04A0                     ERROR:
0003A0 04A0 117A05          10      LD  DE,ERRMES
0003A3 04A3 0E09             7      LD  C,9     ;文字列出力
0003A5 04A5 CD0500          17      CALL    SYSTEM
0003A8 04A8 C30000          10      JP  0
                                
       04AB                     TITLE:
0003AB 04AB 583120666F726D61        DB  "X1 format v1.14"
            742076312E3134      
       04BA                     CRLF:
0003BA 04BA 0D0A                    DB  $0D,$0A
0003BC 04BC 24                      DB  '$'
       04BD                     MUSAGE:
0003BD 04BD 75736167653A2046        DB  "usage: FORMAT ﾄﾞﾗｲﾌﾞ:[ｽｲｯﾁ]",$0D,$0A
            4F524D415420C4DE    
            D7B2CCDE3A5BBDB2    
            AFC15D0D0A          
0003DA 04DA 092F432020464154        DB  9,"/C  FAT,ﾃﾞｨﾚｸﾄﾘ ｼｮｷｶ",$0D,$0A
            2CC3DEA8DAB8C4D8    
            20BCAEB7B60D0A      
                                ;   DB  9,"/On ｵｰﾊﾞｰﾄﾗｯｸ(n:1-9)",$0D,$0A
0003F1 04F1 24                      DB  '$'
       04F2                     FORMES:
0003F2 04F2 666F726D61742024        DB  "format $"
       04FA                     FOTMES:
0003FA 04FA 666F726D61742074        DB  "format type (2D=0,2DD=1,2HD=2,logical only=L)? $"
            797065202832443D    
            302C3244443D312C    
            3248443D322C6C6F    
            676963616C206F6E    
            6C793D4C293F2024    
       052A                     PHYMES:
00042A 052A 706879736963616C        DB  "physical format",$0D,$0A,'$'
            20666F726D61740D    
            0A24                
       053C                     LOGMES:
00043C 053C 6C6F676963616C20        DB  "logical  format",$0D,$0A,'$'
            20666F726D61740D    
            0A24                
       054E                     COMMES:
00044E 054E 636F6D706C657465        DB  "completed !",$0D,$0A,'$'
            6420210D0A24        
       055C                     HITMES:
00045C 055C 686974205B43525D        DB  "hit [CR] to start$"
            20746F2073746172    
            7424                
       056E                     OVERMES:
00046E 056E 6F76657220747261        DB  "over track:$"
            636B3A24            
       057A                     ERRMES:
00047A 057A 074572726F72210D        DB  7,"Error!",$0D,$0A,'$'
            0A24                
                                ;
                                ;   DPB Data
                                ;
                                
000484 0584 0200                M2D:    DW  2
000486 0586 FD02                    DB  $FD,2
000488 0588 6401                    DW  356
00048A 058A FF0728090182            DB  $FF,7,40,9,1,$82
000490 0590 0500A7000800            DW  5,$A7,8
                                
000496 0596 0300                M2DD:   DW  3
000498 0598 F902                    DB  $F9,2
00049A 059A CB02                    DW  715
00049C 059C FF0750090182            DB  $FF,7,80,9,1,$82
0004A2 05A2 0700A7000A00            DW  7,$A7,10
                                
0004A8 05A8 0200                M2HD:   DW  2
0004AA 05AA FE01                    DB  $FE,1
0004AC 05AC C704                    DW  1223
0004AE 05AE FE064D080184            DB  $FE,6,77,8,1,$84
0004B4 05B4 0500A7000900            DW  5,$A7,9
                                
                                ;M2HS:  DB  3
                                ;   DW  $FB,8
                                ;   DW  1432
                                ;   DB  $FE,10,80,9,1,4,4,10
                                ;
                                ;   Format Data 2D/2DD
                                ;
0004BA 05BA 204EFF              LGAP1:  DB  32,$4E,255
                                ;
0004BD 05BD 0C0003F501FEFF      LSEC:   DB  12,$00,3,$F5,1,$FE,255
                                ;
0004C4 05C4 01F7164E0C0003F5        DB  1,$F7,22,$4E,12,$00,3,$F5,1,$FB
            01FB                
0004CE 05CE 00E500E5                DB  0,$E5,0,$E5
0004D2 05D2 01F7544EFF              DB  1,$F7,84,$4E,255
                                ;
                                ;   Format Data 2HD
                                ;
0004D7 05D7 504E0C0003F601FC    HGAP1:  DB  80,$4E,12,$00,3,$F6,1,$FC,50,$4E,255
            324EFF              
                                ;
0004E2 05E2 0C0003F501FEFF      HSEC:   DB  12,$00,3,$F5,1,$FE,255
                                ;
0004E9 05E9 01F7164E0C0003F5        DB  1,$F7,22,$4E,12,$00,3,$F5,1,$FB
            01FB                
0004F3 05F3 00E500E500E500E5        DB  0,$E5,0,$E5,0,$E5,0,$E5
0004FB 05FB 01F7744EFF              DB  1,$F7,116,$4E,255
                                ;
000500 0600 004E004E004EFF      HGAP4:  DB  0,$4E,0,$4E,0,$4E,255
                                ;
                                ;   Format Data 2HS
                                ;
                                ;SSEC:  DB  12,$00,3,$F5,1,$FE,255
                                ;
                                ;   DB  1,$F7,22,$4E,12,$00,3,$F5,1,$FB
                                ;   DB  0,$E5,0,$E5,0,$E5,0,$E5
                                ;   DB  1,$F7,53,$4E,255
                                ;
                                ;   BOOT-DATA
                                ;
000507 0607 EBFE904C44202020    LIPL:   DB  $EB,$FE,$90,'L','D',$20,$20,$20
00050F 060F 2020200002020100        DB  $20,$20,$20,$00,$02,$02,$01,$00
000517 0617 027000D002FD0200        DB  $02,$70,$00,$D0,$02,$FD,$02,$00
00051F 061F 09000200000018FE        DB  $09,$00,$02,$00,$00,$00,$18,$FE
000527 0627 0000                    DB  $00,$00
                                
000529 0629 EBFE904C44202020    DIPL:   DB  $EB,$FE,$90,'L','D',$20,$20,$20
000531 0631 2020200002020100        DB  $20,$20,$20,$00,$02,$02,$01,$00
000539 0639 027000A005F90300        DB  $02,$70,$00,$A0,$05,$F9,$03,$00
000541 0641 09000200000018FE        DB  $09,$00,$02,$00,$00,$00,$18,$FE
000549 0649 0000                    DB  $00,$00
                                
00054B 064B EBFE904C44202020    HIPL:   DB  $EB,$FE,$90,'L','D',$20,$20,$20
000553 0653 2020200004010100        DB  $20,$20,$20,$00,$04,$01,$01,$00
00055B 065B 02C000D004FE0200        DB  $02,$C0,$00,$D0,$04,$FE,$02,$00
000563 0663 08000200000018FE        DB  $08,$00,$02,$00,$00,$00,$18,$FE
00056B 066B 0000                    DB  $00,$00
                                
                                ;SIPL:  DB  $EB,$1E,$90,'L','D',$20,$20,$20
                                ;   DB  $20,$20,$20,"2","H","S",$20,$20
                                ;   DB  $20,$20,$04,$00,$01,$03,$00,$01
                                ;   DB  $00,$C0,$05,$A0,$FB,$01,$18,$FE
                                ;   DB  $EB,$FE
                                
       066D                     IPLPRG:
00056D 066D 01FC0F          10      LD  BC,$FFC
000570 0670 ED71                    DB  $ED,$71
000572 0672 3E07             7      LD  A,7
000574 0674 3286FF          13      LD  ($FF86),A
000577 0677 C3F500          10      JP  $F5
       067A                     IPLPEND:
       067A                     FDATA:
[EOF:FORMAT.ASM:SHIFT_JIS]
