                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;
                                ;   FORMAT by Gaku
                                ;
       0003                     OSFLG   EQU $0003
       0005                     SYSTEM  EQU $0005
       000B                     BASE    EQU $000B
       000F                     JP_HL   EQU $000F
       0018                     BIOS    EQU $0018
       005C                     FCB1    EQU $005C
       0080                     DTA EQU $0080
                                
000000 0100                         ORG $0100
000000 0100 C30301          10      JP  START
       0103                     START:
000003 0103 11AE04          10      LD  DE,TITLE
000006 0106 0E09             7      LD  C,9     ;文字列出力
000008 0108 CD0500          17      CALL    SYSTEM
00000B 010B 3A0B00          13      LD  A,(BASE)
00000E 010E 32AC03          13      LD  (WTTRKP+2),A
000011 0111 3A5C00          13      LD  A,(FCB1)
000014 0114 B7               4      OR  A
000015 0115 200B            12      JR  NZ,MAIN
       0117                     USAGE:
000017 0117 11C004          10      LD  DE,MUSAGE
00001A 011A 0E09             7      LD  C,9     ;文字列出力
00001C 011C CD0500          17      CALL    SYSTEM
00001F 011F C30000          10      JP  0
       0122                     MAIN:
000022 0122 2A0300          16      LD  HL,(OSFLG)
000025 0125 7C               4      LD  A,H
000026 0126 FE1D             7      CP  1DH
000028 0128 C0              11      RET NZ
000029 0129 7D               4      LD  A,L
00002A 012A E6F0             7      AND 0F0H
00002C 012C FE90             7      CP  090H
00002E 012E C0              11      RET NZ
                                
00002F 012F ED7B0600        20      LD  SP,(SYSTEM+1)
000033 0133 3A5C00          13      LD  A,(FCB1)
000036 0136 3D               4      DEC A
000037 0137 2A0A00          16      LD  HL,(BASE-1)
00003A 013A 2EDC             7      LD  L,$DC       ;GETDPB
00003C 013C CD0F00          17      CALL    JP_HL
00003F 013F 38D6            12      JR  C,USAGE
                                
000041 0141 CD7104          17      CALL    SWITCH
000044 0144 FE20             7      CP  $20
000046 0146 3819            12      JR  C,MAIN1
000048 0148 FE4F             7      CP  'O'
00004A 014A 200E            12      JR  NZ,SW1
00004C 014C 1A               7      LD  A,(DE)
00004D 014D D630             7      SUB '0'
00004F 014F 38C6            12      JR  C,USAGE
000051 0151 FE0A             7      CP  10
000053 0153 30C2            12      JR  NC,USAGE
000055 0155 329801          13      LD  (OVER+1),A
000058 0158 1807            12      JR  MAIN1
       015A                     SW1:
00005A 015A D643             7      SUB 'C'
00005C 015C 20B9            12      JR  NZ,USAGE
00005E 015E 328C01          13      LD  (LOGSW+1),A
       0161                     MAIN1:
000061 0161 11F504          10      LD  DE,FORMES   ;format
000064 0164 0E09             7      LD  C,9     ;文字列出力
000066 0166 CD0500          17      CALL    SYSTEM
                                
000069 0169 010604          10      LD  BC,$0406
00006C 016C DDE5            15      PUSH    IX
       016E                     PRNAME:
00006E 016E DD5E1C          19      LD  E,(IX+$1C)  ;デバイスの名前(DPB_1C_NAME)
000071 0171 0E06             7      LD  C,6     ;コンソール直接入出力
000073 0173 C5              11      PUSH    BC
000074 0174 CD0500          17      CALL    SYSTEM
000077 0177 C1              10      POP BC
000078 0178 DD23            10      INC IX
00007A 017A 10F2            13      DJNZ    PRNAME
00007C 017C DDE1            14      POP IX
00007E 017E CD5703          17      CALL    LTNL
                                
000081 0181 DD7E12          19      LD  A,(IX+$12)  ;デバイス情報(DPB_12_DEVICE)
000084 0184 E60F             7      AND $0F
000086 0186 FE07             7      CP  7
000088 0188 C2D402          10      JP  NZ,LOGIC
00008B 018B 3E01             7  LOGSW:  LD  A,1
00008D 018D B7               4      OR  A
00008E 018E CAC702          10      JP  Z,LOGICY
                                
000091 0191 3A1800          13      LD  A,(BIOS)
000094 0194 3C               4      INC A
000095 0195 2805            12      JR  Z,NONT
                                
000097 0197 3E00             7  OVER:   LD  A,$00
000099 0199 B7               4      OR  A
00009A 019A 2046            12      JR  NZ,TYPEO
       019C                     NONT:
00009C 019C 11FD04          10      LD  DE,FOTMES   ;format type
00009F 019F 0E09             7      LD  C,9     ;文字列出力
0000A1 01A1 CD0500          17      CALL    SYSTEM
       01A4                     TYPE:
0000A4 01A4 0E08             7      LD  C,8     ;エコーなしコンソール入力
0000A6 01A6 CD0500          17      CALL    SYSTEM
0000A9 01A9 CD7F04          17      CALL    CAP
0000AC 01AC FE30             7      CP  '0'
0000AE 01AE 2817            12      JR  Z,TYPE0
0000B0 01B0 FE31             7      CP  '1'
0000B2 01B2 281E            12      JR  Z,TYPE1
0000B4 01B4 47               4      LD  B,A
0000B5 01B5 3A1800          13      LD  A,(BIOS)
0000B8 01B8 3C               4      INC A
0000B9 01B9 28E9            12      JR  Z,TYPE
0000BB 01BB 78               4      LD  A,B
0000BC 01BC FE32             7      CP  '2'
0000BE 01BE 2817            12      JR  Z,TYPE2
0000C0 01C0 FE4C             7      CP  'L'
0000C2 01C2 CABF02          10      JP  Z,TYPEY
0000C5 01C5 18DD            12      JR  TYPE
       01C7                     TYPE0:
0000C7 01C7 218705          10      LD  HL,M2D
       01CA                     TYPE1X:
0000CA 01CA 01BD05          10      LD  BC,LGAP1
0000CD 01CD 11C005          10      LD  DE,LSEC
0000D0 01D0 1823            12      JR  TYPEX
       01D2                     TYPE1:
0000D2 01D2 219905          10      LD  HL,M2DD
0000D5 01D5 18F3            12      JR  TYPE1X
       01D7                     TYPE2:
0000D7 01D7 01DA05          10      LD  BC,HGAP1
0000DA 01DA 11E505          10      LD  DE,HSEC
0000DD 01DD 21AB05          10      LD  HL,M2HD
0000E0 01E0 1813            12      JR  TYPEX
       01E2                     TYPEO:
0000E2 01E2 F5              11      PUSH    AF
0000E3 01E3 117105          10      LD  DE,OVERMES
0000E6 01E6 0E09             7      LD  C,9     ;文字列出力
0000E8 01E8 CD0500          17      CALL    SYSTEM
0000EB 01EB F1              10      POP AF
0000EC 01EC C630             7      ADD A,'0'
0000EE 01EE 5F               4      LD  E,A
0000EF 01EF 0E02             7      LD  C,2     ;コンソール出力
0000F1 01F1 CD0500          17      CALL    SYSTEM
0000F4 01F4 AF               4      XOR A
                                ;TYPES:
                                ;   LD  BC,HGAP1
                                ;   LD  DE,SSEC
                                ;   LD  HL,M2HS
       01F5                     TYPEX:
0000F5 01F5 ED43BB03        20      LD  (GAP1+1),BC
0000F9 01F9 ED53C103        20      LD  (SEC+1),DE
                                
0000FD 01FD 5F               4      LD  E,A
0000FE 01FE 0E02             7      LD  C,2     ;コンソール出力
000100 0200 CD0500          17      CALL    SYSTEM
000103 0203 CD5703          17      CALL    LTNL
                                
000106 0206 DDE5            15      PUSH    IX
000108 0208 D1              10      POP DE
000109 0209 EDA0            16      LDI
00010B 020B EDA0            16      LDI
00010D 020D 13               6      INC DE
00010E 020E 13               6      INC DE
00010F 020F 13               6      INC DE
000110 0210 13               6      INC DE
000111 0211 010C00          10      LD  BC,12
000114 0214 EDB0                    LDIR
                                
000116 0216 3A9801          13      LD  A,(OVER+1)
000119 0219 B7               4      OR  A
00011A 021A 2819            12      JR  Z,OTFE
                                
00011C 021C C650             7      ADD A,80
00011E 021E DD770C          19      LD  (IX+$0C),A  ;フロッピーディスクのシリンダ数(DPB_0C_MAXCYL)
000121 0221 D650             7      SUB 80
000123 0223 87               4      ADD A,A ;*2
000124 0224 4F               4      LD  C,A
000125 0225 87               4      ADD A,A ;*4
000126 0226 87               4      ADD A,A ;*8
000127 0227 87               4      ADD A,A ;*16
000128 0228 81               4      ADD A,C ;*18
000129 0229 C698             7      ADD A,$98
00012B 022B DD7708          19      LD  (IX+8),A    ;総クラスタ数(DPB_08_MAXCL)
00012E 022E 3E05             7      LD  A,5
000130 0230 CE00             7      ADC A,0
000132 0232 DD7709          19      LD  (IX+9),A    ;総クラスタ数(DPB_08_MAXCL)
       0235                     OTFE:
000135 0235 DD7E0C          19      LD  A,(IX+$0C)  ;フロッピーディスクのシリンダ数(DPB_0C_MAXCYL)
000138 0238 328703          13      LD  (MAXCYL+1),A
                                
00013B 023B 2A0A00          16      LD  HL,(BASE-1)
00013E 023E 2E89             7      LD  L,$89
000140 0240 36FF            10      LD  (HL),$FF
                                
000142 0242 3A5C00          13      LD  A,(FCB1)
000145 0245 3D               4      DEC A
000146 0246 E5              11      PUSH    HL
000147 0247 2ED9             7      LD  L,$D9       ;CHGDRV
000149 0249 CD0F00          17      CALL    JP_HL
00014C 024C E1              10      POP HL
00014D 024D DD7E13          19      LD  A,(IX+$13)  ;デバイスドライバ内におけるユニット番号(DPB_13_UNITNO)
000150 0250 E603             7      AND 3
000152 0252 F680             7      OR  $80
000154 0254 6F               4      LD  L,A
000155 0255 36FF            10      LD  (HL),$FF
000157 0257 CD4603          17      CALL    SURE
                                
00015A 025A 112D05          10      LD  DE,PHYMES
00015D 025D 0E09             7      LD  C,9     ;文字列出力
00015F 025F CD0500          17      CALL    SYSTEM
                                
000162 0262 CD6803          17      CALL    PHYSIC
000165 0265 CD5703          17      CALL    LTNL
000168 0268 DAA304          10      JP  C,ERROR
00016B 026B CD1204          17      CALL    VERIFY
00016E 026E CD5703          17      CALL    LTNL
000171 0271 DAA304          10      JP  C,ERROR
                                
000174 0274 217D06          10      LD  HL,FDATA
000177 0277 117E06          10      LD  DE,FDATA+1
00017A 027A 3600            10      LD  (HL),0
00017C 027C 010004          10      LD  BC,$400
00017F 027F EDB0                    LDIR
000181 0281 DD7E06          19      LD  A,(IX+6)    ;メディアバイト(DPB_06_FATID)
000184 0284 FEFD             7      CP  $FD
000186 0286 210A06          10      LD  HL,LIPL
000189 0289 280A            12      JR  Z,IPL
00018B 028B FEF9             7      CP  $F9
00018D 028D 212C06          10      LD  HL,DIPL
000190 0290 2803            12      JR  Z,IPL
                                ;   CP  $FB
                                ;   LD  HL,SIPL
                                ;   JR  Z,IPL
000192 0292 214E06          10      LD  HL,HIPL
       0295                     IPL:
000195 0295 117D06          10      LD  DE,FDATA
000198 0298 0E22             7      LD  C,$22
00019A 029A EDB0                    LDIR
00019C 029C 217006          10      LD  HL,IPLPRG
00019F 029F 0E0D             7      LD  C,IPLPEND-IPLPRG
0001A1 02A1 EDB0                    LDIR
0001A3 02A3 215D08          10      LD  HL,FDATA+$1E0
0001A6 02A6 0610             7      LD  B,$10
       02A8                     LOW1:
0001A8 02A8 3622            10      LD  (HL),$22
0001AA 02AA 23               6      INC HL
0001AB 02AB 36FE            10      LD  (HL),$FE
0001AD 02AD 23               6      INC HL
0001AE 02AE 10F8            13      DJNZ    LOW1
                                
0001B0 02B0 110000          10      LD  DE,0
0001B3 02B3 217D06          10      LD  HL,FDATA
0001B6 02B6 CD5504          17      CALL    DWT
0001B9 02B9 B7               4      OR  A
0001BA 02BA C2A304          10      JP  NZ,ERROR
                                
0001BD 02BD 1818            12      JR  LOGICX
       02BF                     TYPEY:
0001BF 02BF 11BD04          10      LD  DE,CRLF
0001C2 02C2 0E09             7      LD  C,9     ;文字列出力
0001C4 02C4 CD0500          17      CALL    SYSTEM
       02C7                     LOGICY:
0001C7 02C7 3A5C00          13      LD  A,(FCB1)
0001CA 02CA 5F               4      LD  E,A
0001CB 02CB 0E1B             7      LD  C,$1B       ;ディスク情報の獲得
0001CD 02CD CD0500          17      CALL    SYSTEM
0001D0 02D0 3C               4      INC A
0001D1 02D1 CAA304          10      JP  Z,ERROR
       02D4                     LOGIC:
0001D4 02D4 CD4603          17      CALL    SURE
       02D7                     LOGICX:
0001D7 02D7 113F05          10      LD  DE,LOGMES
0001DA 02DA 0E09             7      LD  C,9     ;文字列出力
0001DC 02DC CD0500          17      CALL    SYSTEM
                                
0001DF 02DF 217D06          10      LD  HL,FDATA
0001E2 02E2 5D               4      LD  E,L
0001E3 02E3 54               4      LD  D,H
0001E4 02E4 13               6      INC DE
0001E5 02E5 AF               4      XOR A
0001E6 02E6 77               7      LD  (HL),A
0001E7 02E7 010304          10      LD  BC,$03FF+4
0001EA 02EA EDB0                    LDIR
                                ;
0001EC 02EC 217D06          10      LD  HL,FDATA
0001EF 02EF DD7E06          19      LD  A,(IX+6)    ;メディアバイト(DPB_06_FATID)
0001F2 02F2 77               7      LD  (HL),A      ;FATID
0001F3 02F3 23               6      INC HL
0001F4 02F4 35              11      DEC (HL)        ;LD (HL),$FF
0001F5 02F5 23               6      INC HL
0001F6 02F6 35              11      DEC (HL)        ;LD (HL),$FF
0001F7 02F7 DDCB0F76        20      BIT 6,(IX+$0F)  ;FAT情報と論理セクタのサイズ(DPB_0F_BPS)
0001FB 02FB 2802            12      JR  Z,FAT12
0001FD 02FD 23               6      INC HL      ;FAT16の場合
0001FE 02FE 35              11      DEC (HL)        ;LD (HL),$FF
       02FF                     FAT12:
0001FF 02FF DD5E0E          19      LD  E,(IX+$0E)  ;FAT領域の先頭論理セクタ番号(DPB_0E_FATPS)
000202 0302 1600             7      LD  D,0
                                
000204 0304 DD7E0F          19      LD  A,(IX+$0F)  ;FAT情報と論理セクタのサイズ(DPB_0F_BPS)
000207 0307 E680             7      AND $80     ;bit7:予備FAT
       0309                     LOGIC0:
000209 0309 F5              11      PUSH    AF
00020A 030A DD4E00          19      LD  C,(IX+0)    ;FAT領域のセクタ単位でのサイズ(DPB_00_FATLN)
00020D 030D DD4601          19      LD  B,(IX+1)
000210 0310 217D06          10      LD  HL,FDATA
       0313                     LOGIC1:
000213 0313 CD5504          17      CALL    DWT
000216 0316 B7               4      OR  A
000217 0317 C2A304          10      JP  NZ,ERROR
00021A 031A 218106          10      LD  HL,FDATA+4
00021D 031D 0B               6      DEC BC
00021E 031E 78               4      LD  A,B
00021F 031F B1               4      OR  C
000220 0320 20F1            12      JR  NZ,LOGIC1
                                
000222 0322 F1              10      POP AF
000223 0323 87               4      ADD A,A     ;bit7:予備FAT
000224 0324 38E3            12      JR  C,LOGIC0
       0326                     LOGIC2:             ;ディレクトリエントリ
000226 0326 DD5E10          19      LD  E,(IX+$10)  ;ルートディレクトリ領域の先頭論理セクタ番号(DPB_10_DIRPS)
000229 0329 DD5611          19      LD  D,(IX+$11)
                                
00022C 032C DD460B          19      LD  B,(IX+$0B)  ;ルートディレクトリ領域の論理セクタ数(DPB_0B_DIRSCNT)
       032F                     LOGIC3:
00022F 032F 218106          10      LD  HL,FDATA+4
000232 0332 CD5504          17      CALL    DWT
000235 0335 B7               4      OR  A
000236 0336 C2A304          10      JP  NZ,ERROR
000239 0339 10F4            13      DJNZ    LOGIC3
                                
00023B 033B 115105          10      LD  DE,COMMES
00023E 033E 0E09             7      LD  C,9     ;文字列出力
000240 0340 CD0500          17      CALL    SYSTEM
       0343                     LOGICL:
000243 0343 C30000          10      JP  0
       0346                     SURE:
000246 0346 115F05          10      LD  DE,HITMES
000249 0349 0E09             7      LD  C,9     ;文字列出力
00024B 034B CD0500          17      CALL    SYSTEM
       034E                     SURE1:
00024E 034E 0E08             7      LD  C,8     ;エコーなしコンソール入力
000250 0350 CD0500          17      CALL    SYSTEM
000253 0353 FE0D             7      CP  $0D
000255 0355 20F7            12      JR  NZ,SURE1
       0357                     LTNL:
000257 0357 F5              11      PUSH    AF
000258 0358 1E0D             7      LD  E,$0D
00025A 035A 0E06             7      LD  C,6     ;コンソール直接入出力
00025C 035C CD0500          17      CALL    SYSTEM
00025F 035F 1E0A             7      LD  E,$0A
000261 0361 0E06             7      LD  C,6     ;コンソール直接入出力
000263 0363 CD0500          17      CALL    SYSTEM
000266 0366 F1              10      POP AF
000267 0367 C9              10      RET
                                
       0368                     PHYSIC:
000268 0368 CD8804          17      CALL    GUIDE
00026B 036B 110000          10      LD  DE,0
00026E 036E D9               4      EXX
00026F 036F 2E00             7      LD  L,0     ;CYLINDER
       0371                     PH1:
000271 0371 C5              11      PUSH    BC
000272 0372 D5              11      PUSH    DE
000273 0373 E5              11      PUSH    HL
000274 0374 1E77             7      LD  E,'w'
000276 0376 0E02             7      LD  C,2     ;コンソール出力
000278 0378 CD0500          17      CALL    SYSTEM
00027B 037B E1              10      POP HL
00027C 037C D1              10      POP DE
00027D 037D C1              10      POP BC
       037E                     PH2:
00027E 037E D9               4      EXX
00027F 037F CD8B03          17      CALL    MAKE
000282 0382 D8              11      RET C
000283 0383 D9               4      EXX
000284 0384 2C               4      INC L
000285 0385 7D               4      LD  A,L
000286 0386 FE00             7  MAXCYL: CP  0
000288 0388 38E7            12      JR  C,PH1
00028A 038A C9              10      RET
                                
       038B                     MAKE:
00028B 038B FD217D06        14      LD  IY,FDATA
00028F 038F D9               4      EXX
000290 0390 0E00             7      LD  C,0     ;SIDE0
000292 0392 CDB703          17      CALL    MKDATA
000295 0395 FD22A703        20      LD  (GDATA+1),IY
000299 0399 D9               4      EXX
00029A 039A 0E01             7      LD  C,1     ;SIDE1
00029C 039C CDB703          17      CALL    MKDATA
                                
00029F 039F 217D06          10      LD  HL,FDATA
0002A2 03A2 CDA903          17      CALL    WTTRK
0002A5 03A5 D8              11      RET C
0002A6 03A6 217D06          10  GDATA:  LD  HL,FDATA
       03A9                     WTTRK:
0002A9 03A9 D5              11      PUSH    DE
0002AA 03AA CDE800          17  WTTRKP: CALL    $00E8       ;#WTTRK
0002AD 03AD D1              10      POP DE
                                ;
0002AE 03AE DD6E0D          19      LD  L,(IX+$0D)  ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
0002B1 03B1 2600             7      LD  H,0
0002B3 03B3 19              11      ADD HL,DE
0002B4 03B4 EB               4      EX  DE,HL
0002B5 03B5 A7               4      AND A
0002B6 03B6 C9              10      RET
                                ;
       03B7                     MKDATA:
0002B7 03B7 2600             7      LD  H,0
0002B9 03B9 D9               4      EXX
0002BA 03BA 21DA05          10  GAP1:   LD  HL,HGAP1
0002BD 03BD CD0204          17      CALL    SETD
       03C0                     MAKE1:
0002C0 03C0 21E505          10  SEC:    LD  HL,HSEC
0002C3 03C3 CD0204          17      CALL    SETD
0002C6 03C6 D9               4      EXX
0002C7 03C7 FD7500          19      LD  (IY+0),L        ;CYLINDER
0002CA 03CA FD23            10      INC IY
0002CC 03CC FD7100          19      LD  (IY+0),C        ;SIDE
0002CF 03CF FD23            10      INC IY
0002D1 03D1 7D               4      LD  A,L
0002D2 03D2 B1               4      OR  C
0002D3 03D3 B4               4      OR  H
0002D4 03D4 3E01             7      LD  A,1
0002D6 03D6 2802            12      JR  Z,MAKES1
0002D8 03D8 7C               4      LD  A,H
0002D9 03D9 3C               4      INC A
       03DA                     MAKES1:
0002DA 03DA 24               4      INC H
0002DB 03DB FD7700          19      LD  (IY+0),A        ;SECTOR
0002DE 03DE E5              11      PUSH    HL
0002DF 03DF FD23            10      INC IY
0002E1 03E1 DD7E07          19      LD  A,(IX+$07)  ;1クラスタの論理セクタ数(DPB_07_SECPCL)
0002E4 03E4 FE01             7      CP  1
0002E6 03E6 2806            12      JR  Z,SIZE1024  ;1
0002E8 03E8 3804            12      JR  C,SIZE1024  ;0(v1.29まで)
       03EA                     SIZE512:            ;2 or $29(v1.29まで)
0002EA 03EA 3E02             7      LD  A,2
0002EC 03EC 1802            12      JR  SIZE
       03EE                     SIZE1024:
0002EE 03EE 3E03             7      LD  A,3
       03F0                     SIZE:
0002F0 03F0 FD7700          19      LD  (IY+0),A    ;SIZE
0002F3 03F3 FD23            10      INC IY
0002F5 03F5 D9               4      EXX
0002F6 03F6 CD0204          17      CALL    SETD
0002F9 03F9 F1              10      POP AF      ;AF=HL
0002FA 03FA DDBE0D           7      CP  (IX+$0D)    ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
0002FD 03FD 38C1            12      JR  C,MAKE1
                                
0002FF 03FF 210306          10      LD  HL,HGAP4
       0402                     SETD:
000302 0402 7E               7      LD  A,(HL)
000303 0403 23               6      INC HL
000304 0404 47               4      LD  B,A
000305 0405 3C               4      INC A
000306 0406 C8              11      RET Z
000307 0407 7E               7      LD  A,(HL)
000308 0408 23               6      INC HL
       0409                     SETD1:
000309 0409 FD7700          19      LD  (IY+0),A
00030C 040C FD23            10      INC IY
00030E 040E 10F9            13      DJNZ    SETD1
000310 0410 18F0            12      JR  SETD
                                
       0412                     VERIFY:
000312 0412 CD8804          17      CALL    GUIDE
000315 0415 DD7E0D          19      LD  A,(IX+$0D)  ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
000318 0418 87               4      ADD A,A
000319 0419 4F               4      LD  C,A
                                
00031A 041A D9               4      EXX
00031B 041B 110000          10      LD  DE,0
00031E 041E D9               4      EXX
00031F 041F 3A8703          13      LD  A,(MAXCYL+1)
000322 0422 6F               4      LD  L,A
       0423                     VE2:
000323 0423 C5              11      PUSH    BC
000324 0424 D5              11      PUSH    DE
000325 0425 E5              11      PUSH    HL
000326 0426 1E76             7      LD  E,'v'
000328 0428 0E02             7      LD  C,2     ;コンソール出力
00032A 042A CD0500          17      CALL    SYSTEM
00032D 042D E1              10      POP HL
00032E 042E D1              10      POP DE
00032F 042F C1              10      POP BC
000330 0430 C5              11      PUSH    BC
000331 0431 D9               4      EXX
000332 0432 D5              11      PUSH    DE
000333 0433 117D06          10      LD  DE,FDATA
000336 0436 0E1A             7      LD  C,$1A       ;DTAの設定
000338 0438 CD0500          17      CALL    SYSTEM
00033B 043B D1              10      POP DE
00033C 043C E1              10      POP HL
00033D 043D E5              11      PUSH    HL
00033E 043E D5              11      PUSH    DE
00033F 043F 65               4      LD  H,L
000340 0440 3A5C00          13      LD  A,(FCB1)
000343 0443 3D               4      DEC A
000344 0444 6F               4      LD  L,A
000345 0445 0E2F             7      LD  C,$2F       ;論理セクタを用いた読み出し
000347 0447 CD0500          17      CALL    SYSTEM
00034A 044A D1              10      POP DE
00034B 044B E1              10      POP HL
00034C 044C 2600             7      LD  H,0
00034E 044E 19              11      ADD HL,DE
00034F 044F EB               4      EX  DE,HL
000350 0450 D9               4      EXX
                                ;
000351 0451 2D               4      DEC L
000352 0452 20CF            12      JR  NZ,VE2
       0454                     VERE:
000354 0454 C9              10      RET
                                
       0455                     DWT:
000355 0455 E5              11      PUSH    HL
000356 0456 C5              11      PUSH    BC
000357 0457 D5              11      PUSH    DE
000358 0458 EB               4      EX  DE,HL
000359 0459 0E1A             7      LD  C,$1A       ;DTAの設定
00035B 045B CD0500          17      CALL    SYSTEM
00035E 045E D1              10      POP DE
00035F 045F D5              11      PUSH    DE
000360 0460 3A5C00          13      LD  A,(FCB1)
000363 0463 3D               4      DEC A
000364 0464 6F               4      LD  L,A
000365 0465 2601             7      LD  H,1
000367 0467 0E30             7      LD  C,$30       ;論理セクタを用いた書き込み
000369 0469 CD0500          17      CALL    SYSTEM
00036C 046C D1              10      POP DE
00036D 046D 13               6      INC DE
00036E 046E C1              10      POP BC
00036F 046F E1              10      POP HL
000370 0470 C9              10      RET
                                
       0471                     SWITCH:
000371 0471 118100          10      LD  DE,DTA+1
       0474                     SWITCH1:
000374 0474 1A               7      LD  A,(DE)
000375 0475 FE20             7      CP  $20
000377 0477 D8              11      RET C
000378 0478 13               6      INC DE
000379 0479 FE2F             7      CP  '/'
00037B 047B 20F7            12      JR  NZ,SWITCH1
00037D 047D 1A               7      LD  A,(DE)
00037E 047E 13               6      INC DE
       047F                     CAP:
00037F 047F FE61             7      CP  'a'
000381 0481 D8              11      RET C
000382 0482 FE7B             7      CP  'z'+1
000384 0484 D0              11      RET NC
000385 0485 D620             7      SUB $20
000387 0487 C9              10      RET
                                
       0488                     GUIDE:
000388 0488 3A8703          13      LD  A,(MAXCYL+1)
00038B 048B 47               4      LD  B,A
00038C 048C 0E02             7      LD  C,2
00038E 048E 1E2E             7      LD  E,'.'
000390 0490 CD9904          17      CALL    GUIDE1
000393 0493 3A8703          13      LD  A,(MAXCYL+1)
000396 0496 47               4      LD  B,A
000397 0497 1E08             7      LD  E,8     ;コンソール直接入出力
       0499                     GUIDE1:
000399 0499 C5              11      PUSH    BC
00039A 049A D5              11      PUSH    DE
00039B 049B CD0500          17      CALL    SYSTEM
00039E 049E D1              10      POP DE
00039F 049F C1              10      POP BC
0003A0 04A0 10F7            13      DJNZ    GUIDE1
0003A2 04A2 C9              10      RET
                                
       04A3                     ERROR:
0003A3 04A3 117D05          10      LD  DE,ERRMES
0003A6 04A6 0E09             7      LD  C,9     ;文字列出力
0003A8 04A8 CD0500          17      CALL    SYSTEM
0003AB 04AB C30000          10      JP  0
                                
       04AE                     TITLE:
0003AE 04AE 583120666F726D61        DB  "X1 format v1.13"
            742076312E3133      
       04BD                     CRLF:
0003BD 04BD 0D0A                    DB  $0D,$0A
0003BF 04BF 24                      DB  '$'
       04C0                     MUSAGE:
0003C0 04C0 75736167653A2046        DB  "usage: FORMAT ﾄﾞﾗｲﾌﾞ:[ｽｲｯﾁ]",$0D,$0A
            4F524D415420C4DE    
            D7B2CCDE3A5BBDB2    
            AFC15D0D0A          
0003DD 04DD 092F432020464154        DB  9,"/C  FAT･ﾃﾞｨﾚｸﾄﾘ ｼｮｷｶ",$0D,$0A
            A5C3DEA8DAB8C4D8    
            20BCAEB7B60D0A      
                                ;   DB  9,"/On ｵｰﾊﾞｰﾄﾗｯｸ(n:1-9)",$0D,$0A
0003F4 04F4 24                      DB  '$'
       04F5                     FORMES:
0003F5 04F5 666F726D61742024        DB  "format $"
       04FD                     FOTMES:
0003FD 04FD 666F726D61742074        DB  "format type (2D=0,2DD=1,2HD=2,logical only=L)? $"
            797065202832443D    
            302C3244443D312C    
            3248443D322C6C6F    
            676963616C206F6E    
            6C793D4C293F2024    
       052D                     PHYMES:
00042D 052D 706879736963616C        DB  "physical format",$0D,$0A,'$'
            20666F726D61740D    
            0A24                
       053F                     LOGMES:
00043F 053F 6C6F676963616C20        DB  "logical  format",$0D,$0A,'$'
            20666F726D61740D    
            0A24                
       0551                     COMMES:
000451 0551 636F6D706C657465        DB  "completed !",$0D,$0A,'$'
            6420210D0A24        
       055F                     HITMES:
00045F 055F 686974205B43525D        DB  "hit [CR] to start$"
            20746F2073746172    
            7424                
       0571                     OVERMES:
000471 0571 6F76657220747261        DB  "over track:$"
            636B3A24            
       057D                     ERRMES:
00047D 057D 074572726F72210D        DB  7,"Error!",$0D,$0A,'$'
            0A24                
                                ;
                                ;   DPB Data
                                ;
                                
000487 0587 0200                M2D:    DW  2
000489 0589 FD02                    DB  $FD,2
00048B 058B 6401                    DW  356
00048D 058D FF0728090182            DB  $FF,7,40,9,1,$82
000493 0593 0500A7000800            DW  5,$A7,8
                                
000499 0599 0300                M2DD:   DW  3
00049B 059B F902                    DB  $F9,2
00049D 059D CB02                    DW  715
00049F 059F FF0750090182            DB  $FF,7,80,9,1,$82
0004A5 05A5 0700A7000A00            DW  7,$A7,10
                                
0004AB 05AB 0200                M2HD:   DW  2
0004AD 05AD FE01                    DB  $FE,1
0004AF 05AF C704                    DW  1223
0004B1 05B1 FE064D080184            DB  $FE,6,77,8,1,$84
0004B7 05B7 0500A7000900            DW  5,$A7,9
                                
                                ;M2HS:  DB  3
                                ;   DW  $FB,8
                                ;   DW  1432
                                ;   DB  $FE,10,80,9,1,4,4,10
                                ;
                                ;   Format Data 2D/2DD
                                ;
0004BD 05BD 204EFF              LGAP1:  DB  32,$4E,255
                                ;
0004C0 05C0 0C0003F501FEFF      LSEC:   DB  12,$00,3,$F5,1,$FE,255
                                ;
0004C7 05C7 01F7164E0C0003F5        DB  1,$F7,22,$4E,12,$00,3,$F5,1,$FB
            01FB                
0004D1 05D1 00E500E5                DB  0,$E5,0,$E5
0004D5 05D5 01F7544EFF              DB  1,$F7,84,$4E,255
                                ;
                                ;   Format Data 2HD
                                ;
0004DA 05DA 504E0C0003F601FC    HGAP1:  DB  80,$4E,12,$00,3,$F6,1,$FC,50,$4E,255
            324EFF              
                                ;
0004E5 05E5 0C0003F501FEFF      HSEC:   DB  12,$00,3,$F5,1,$FE,255
                                ;
0004EC 05EC 01F7164E0C0003F5        DB  1,$F7,22,$4E,12,$00,3,$F5,1,$FB
            01FB                
0004F6 05F6 00E500E500E500E5        DB  0,$E5,0,$E5,0,$E5,0,$E5
0004FE 05FE 01F7744EFF              DB  1,$F7,116,$4E,255
                                ;
000503 0603 004E004E004EFF      HGAP4:  DB  0,$4E,0,$4E,0,$4E,255
                                ;
                                ;   Format Data 2HS
                                ;
                                ;SSEC:  DB  12,$00,3,$F5,1,$FE,255
                                ;
                                ;   DB  1,$F7,22,$4E,12,$00,3,$F5,1,$FB
                                ;   DB  0,$E5,0,$E5,0,$E5,0,$E5
                                ;   DB  1,$F7,53,$4E,255
                                ;
                                ;   BOOT-DATA
                                ;
00050A 060A EBFE904C44202020    LIPL:   DB  $EB,$FE,$90,'L','D',$20,$20,$20
000512 0612 2020200002020100        DB  $20,$20,$20,$00,$02,$02,$01,$00
00051A 061A 027000D002FD0200        DB  $02,$70,$00,$D0,$02,$FD,$02,$00
000522 0622 09000200000018FE        DB  $09,$00,$02,$00,$00,$00,$18,$FE
00052A 062A 0000                    DB  $00,$00
                                
00052C 062C EBFE904C44202020    DIPL:   DB  $EB,$FE,$90,'L','D',$20,$20,$20
000534 0634 2020200002020100        DB  $20,$20,$20,$00,$02,$02,$01,$00
00053C 063C 027000A005F90300        DB  $02,$70,$00,$A0,$05,$F9,$03,$00
000544 0644 09000200000018FE        DB  $09,$00,$02,$00,$00,$00,$18,$FE
00054C 064C 0000                    DB  $00,$00
                                
00054E 064E EBFE904C44202020    HIPL:   DB  $EB,$FE,$90,'L','D',$20,$20,$20
000556 0656 2020200004010100        DB  $20,$20,$20,$00,$04,$01,$01,$00
00055E 065E 02C000D004FE0200        DB  $02,$C0,$00,$D0,$04,$FE,$02,$00
000566 0666 08000200000018FE        DB  $08,$00,$02,$00,$00,$00,$18,$FE
00056E 066E 0000                    DB  $00,$00
                                
                                ;SIPL:  DB  $EB,$1E,$90,'L','D',$20,$20,$20
                                ;   DB  $20,$20,$20,"2","H","S",$20,$20
                                ;   DB  $20,$20,$04,$00,$01,$03,$00,$01
                                ;   DB  $00,$C0,$05,$A0,$FB,$01,$18,$FE
                                ;   DB  $EB,$FE
                                
       0670                     IPLPRG:
000570 0670 01FC0F          10      LD  BC,$FFC
000573 0673 ED71                    DB  $ED,$71
000575 0675 3E07             7      LD  A,7
000577 0677 3286FF          13      LD  ($FF86),A
00057A 067A C3F500          10      JP  $F5
       067D                     IPLPEND:
       067D                     FDATA:
[EOF:FORMAT.ASM:SHIFT_JIS]
