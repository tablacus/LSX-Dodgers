                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.12.0, LST:Full:4
                                ;
                                ;   FORMAT by Gaku
                                ;
       0000                     WBOOT   EQU $0000
       0005                     SYSTEM  EQU $0005
       000F                     JP_HL   EQU $000F
       005C                     FCB1    EQU $005C
       0080                     DTA EQU $0080
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
       001C                     DPB_NAME    EQU 1CH
                                
                                ;   PC-8801mkIISR
       002A                     S_MAIN  EQU $002A
       6000                     DSS EQU $6000
                                
       7C06                     GETPARAMS_N EQU $7C06
       7C09                     SEEK        EQU $7C09
       7C0C                     FDCOMMAND   EQU $7C0C
       7C0F                     CHECKRESULT EQU $7C0F
       7C12                     GETDEVSTAT  EQU $7C12
       7C15                     RDFDC       EQU $7C15
                                
       7C30                     S_PARAMS    EQU $7C30
       7C30                     S_UNITNO    EQU S_PARAMS    ;ユニット番号 0:ドライブA 1:ドライブB
       7C31                     S_DPS       EQU S_PARAMS+1  ;1トラックのセクタ数
       7C32                     S_SECTOR_R  EQU S_PARAMS+2  ;セクタ番号
       7C33                     S_TRACK     EQU S_PARAMS+3  ;トラック番号
       7C34                     S_FDMODE    EQU S_PARAMS+4  ;FDモード切り替え $FF:2D/2DD $FE:2HD
       7C35                     S_SECSIZE_N EQU S_PARAMS+5  ;N セクタサイズ
       7C36                     S_BYTE_H    EQU S_PARAMS+6  ;バイト数H
       7C37                     S_MAXCL     EQU S_PARAMS+7  ;シリンダ数
                                
       7C40                     S_CMD_STATUS    EQU $7C40
       7C41                     S_LEFT      EQU $7C41
       7C42                     S_WKF4      EQU $7C42
                                
       FFBB                     PUTCOM  EQU $FFBB
       FFBE                     PUTDAT  EQU $FFBE
       FFC1                     GETDAT  EQU $FFC1
       FFC4                     FPUTDAT EQU $FFC4
       FFC7                     FGETDAT EQU $FFC7
                                
                                ;   for MSX
       001C                     CALSLT  EQU $001C
       0147                     FORMAT  EQU $0147
       FCC1                     EXPTBL  EQU $FCC1
                                
000000 0100                         ORG $0100
000000 0100 C30301          10      JP  START
       0103                     START:
000003 0103 11AB06          10      LD  DE,TITLE
000006 0106 0E09             7      LD  C,9     ;文字列出力
000008 0108 CD0500          17      CALL    SYSTEM
00000B 010B 3A0200          13      LD  A,(WBOOT+2)
00000E 010E 326104          13      LD  (WTTRKP+2),A
000011 0111 3A5C00          13      LD  A,(FCB1)
000014 0114 B7               4      OR  A
000015 0115 200B            12      JR  NZ,MAIN
       0117                     USAGE:
000017 0117 11BA06          10      LD  DE,MUSAGE
00001A 011A 0E09             7      LD  C,9     ;文字列出力
00001C 011C CD0500          17      CALL    SYSTEM
00001F 011F C30000          10      JP  0
       0122                     MAIN:
000022 0122 0E6F             7      LD  C,$6F       ;MSX-DOS のバージョン番号の獲得(_DOSVER) *1 MSX-DOS
000024 0124 CD0500          17      CALL    SYSTEM
000027 0127 D8              11      RET C       ;CP/M
000028 0128 211D01          10      LD  HL,$011D
00002B 012B A7               4      AND A
00002C 012C ED42            15      SBC HL,BC
00002E 012E C22406          10      JP  NZ,MSX
000031 0131 ED7B0600        20      LD  SP,(SYSTEM+1)
000035 0135 3A5C00          13      LD  A,(FCB1)
000038 0138 3D               4      DEC A
000039 0139 5F               4      LD  E,A
00003A 013A 0E1F             7      LD  C,$1F       ;ディスク装置のパラメータの読み出し
00003C 013C CD0500          17      CALL    SYSTEM
00003F 013F B7               4      OR  A
000040 0140 2007            12      JR  NZ,MAIN0
000042 0142 DD7E12          19      LD  A,(IX+DPB_DEVICE)   ;デバイス情報
000045 0145 FE26             7      CP  $26         ;デバイスはEMMでBPBを使っている
000047 0147 20CE            12      JR  NZ,USAGE
       0149                     MAIN0:
000049 0149 CD1A05          17      CALL    SWITCH
00004C 014C FE20             7      CP  $20
00004E 014E 3807            12      JR  C,MAIN1
000050 0150 D643             7      SUB 'C'
000052 0152 20C3            12      JR  NZ,USAGE
000054 0154 329801          13      LD  (LOGSW),A
       0157                     MAIN1:
000057 0157 11EF06          10      LD  DE,FORMES   ;format
00005A 015A 0E09             7      LD  C,9     ;文字列出力
00005C 015C CD0500          17      CALL    SYSTEM
                                
00005F 015F 010604          10      LD  BC,$0406
000062 0162 DDE5            15      PUSH    IX
       0164                     PRNAME:
000064 0164 DD5E1C          19      LD  E,(IX+DPB_NAME) ;デバイスの名前
000067 0167 0E06             7      LD  C,6     ;コンソール直接入出力
000069 0169 C5              11      PUSH    BC
00006A 016A CD0500          17      CALL    SYSTEM
00006D 016D C1              10      POP BC
00006E 016E DD23            10      INC IX
000070 0170 10F2            13      DJNZ    PRNAME
000072 0172 DDE1            14      POP IX
000074 0174 CDB203          17      CALL    NL
                                
000077 0177 DD7E12          19      LD  A,(IX+DPB_DEVICE)   ;デバイス情報
00007A 017A FE26             7      CP  $26         ;デバイスはEMMでBPBを使っている
00007C 017C 2809            12      JR  Z,EMM
00007E 017E E60F             7      AND $0F
000080 0180 FE07             7      CP  7       ;FDD
000082 0182 2813            12      JR  Z,FDD
000084 0184 C32C03          10      JP  LOGIC
       0187                     EMM:
000087 0187 3A9801          13      LD  A,(LOGSW)
00008A 018A B7               4      OR  A
00008B 018B CA1503          10      JP  Z,LOGICY
00008E 018E CDA103          17      CALL    SURE
000091 0191 CD5705          17      CALL    BPB_FROM_EMM
000094 0194 C32F03          10      JP  LOGICX
       0197                     FDD:
000097 0197 3E01             7      LD  A,1
       0198                     LOGSW   EQU $-1
000099 0199 B7               4      OR  A
00009A 019A CA1503          10      JP  Z,LOGICY
                                
00009D 019D 0E6F             7      LD  C,$6F       ;MSX-DOS のバージョン番号の獲得(_DOSVER) *1 MSX-DOS
00009F 019F CD0500          17      CALL    SYSTEM
0000A2 01A2 7D               4      LD  A,L
0000A3 01A3 B7               4      OR  A       ;X1
0000A4 01A4 283C            12      JR  Z,ENABLE_PHISIC
0000A6 01A6 FE01             7      CP  1       ;MZ-700/1500
0000A8 01A8 2838            12      JR  Z,ENABLE_PHISIC
0000AA 01AA FE02             7      CP  2       ;PC-8801mkIISR
0000AC 01AC 2803            12      JR  Z,ENABLE_PHISIC88
0000AE 01AE C30D03          10      JP  TYPEY
       01B1                     ENABLE_PHISIC88:
0000B1 01B1 3ABBFF          13      LD  A,(PUTCOM)
0000B4 01B4 FEC3             7      CP  $C3     ;JP
0000B6 01B6 C20D03          10      JP  NZ,TYPEY
0000B9 01B9 3E                      DB  $3E     ;LD A,?
0000BA 01BA 37               4      SCF
0000BB 01BB 323D04          13      LD  (MAKE),A
0000BE 01BE 3E16             7      LD  A,16H       ;高速レシーブメモリ
0000C0 01C0 CDBBFF          17      CALL    PUTCOM
0000C3 01C3 3E60             7      LD  A,DSS/256   ;開始アドレスH
0000C5 01C5 CDBEFF          17      CALL    PUTDAT
0000C8 01C8 AF               4      XOR A       ;開始アドレスL
0000C9 01C9 CDBEFF          17      CALL    PUTDAT
0000CC 01CC 017900          10      LD  BC,AT_DSSE-AT_DSS
0000CF 01CF CB41             8      BIT 0,C
0000D1 01D1 2801            12      JR  Z,SUBPG1
0000D3 01D3 03               6      INC BC      ;偶数にする
       01D4                     SUBPG1:
0000D4 01D4 78               4      LD  A,B     ;バイト数H
0000D5 01D5 CDBEFF          17      CALL    PUTDAT
0000D8 01D8 79               4      LD  A,C
0000D9 01D9 CDBEFF          17      CALL    PUTDAT
0000DC 01DC 213206          10      LD  HL,AT_DSS
0000DF 01DF CDC4FF          17      CALL    FPUTDAT
       01E2                     ENABLE_PHISIC:
0000E2 01E2 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)   ;フロッピーディスクのモード
0000E6 01E6 280B            12      JR  Z,ENABLE_2HD
0000E8 01E8 DDCB127E        20      BIT 7,(IX+DPB_DEVICE)   ;デバイス情報
0000EC 01EC 2005            12      JR  NZ,ENABLE_2HD
0000EE 01EE 113307          10      LD  DE,FOTMESL  ;format type
0000F1 01F1 1803            12      JR  DISABLE_2HD
       01F3                     ENABLE_2HD:
0000F3 01F3 11F706          10      LD  DE,FOTMES   ;format type
       01F6                     DISABLE_2HD:
0000F6 01F6 0E09             7      LD  C,9     ;文字列出力
0000F8 01F8 CD0500          17      CALL    SYSTEM
       01FB                     TYPE:
0000FB 01FB 0E08             7      LD  C,8     ;エコーなしコンソール入力
0000FD 01FD CD0500          17      CALL    SYSTEM
000100 0200 CD2805          17      CALL    CAP
000103 0203 FE30             7      CP  '0'
000105 0205 2817            12      JR  Z,TYPE0
000107 0207 FE31             7      CP  '1'
000109 0209 281E            12      JR  Z,TYPE1
00010B 020B FE32             7      CP  '2'
00010D 020D 281F            12      JR  Z,TYPE2
00010F 020F FE33             7      CP  '3'
000111 0211 2826            12      JR  Z,TYPE3
000113 0213 FE34             7      CP  '4'
000115 0215 282D            12      JR  Z,TYPE4
000117 0217 FE4C             7      CP  'L'
000119 0219 CA0D03          10      JP  Z,TYPEY
00011C 021C 18DD            12      JR  TYPE
       021E                     TYPE0:
00011E 021E 21B907          10      LD  HL,M2D
       0221                     TYPE1X:
000121 0221 011808          10      LD  BC,LGAP1
000124 0224 112D08          10      LD  DE,SEC512
000127 0227 1826            12      JR  TYPEX
       0229                     TYPE1:
000129 0229 21CC07          10      LD  HL,M2DD
00012C 022C 18F3            12      JR  TYPE1X
       022E                     TYPE2:
00012E 022E 011B08          10      LD  BC,HGAP1
000131 0231 114708          10      LD  DE,SEC1024
000134 0234 21DF07          10      LD  HL,M2HD
000137 0237 1816            12      JR  TYPEX
       0239                     TYPE3:
000139 0239 011B08          10      LD  BC,HGAP1
00013C 023C 112D08          10      LD  DE,SEC512
00013F 023F 21F207          10      LD  HL,M2HC
000142 0242 180B            12      JR  TYPEX
       0244                     TYPE4:
000144 0244 011B08          10      LD  BC,HGAP1
000147 0247 112D08          10      LD  DE,SEC512
00014A 024A 210508          10      LD  HL,M2HQ
00014D 024D 1800            12      JR  TYPEX
       024F                     TYPEX:
00014F 024F ED437004        20      LD  (GAP1),BC
000153 0253 ED537604        20      LD  (SEC),DE
000157 0257 E5              11      PUSH    HL
000158 0258 FDE1            14      POP IY
                                
00015A 025A 5F               4      LD  E,A
00015B 025B 0E02             7      LD  C,2     ;コンソール出力
00015D 025D CD0500          17      CALL    SYSTEM
000160 0260 CDB203          17      CALL    NL
                                
000163 0263 DDE5            15      PUSH    IX
000165 0265 D1              10      POP DE
000166 0266 EDA0            16      LDI
000168 0268 EDA0            16      LDI
00016A 026A 13               6      INC DE
00016B 026B 13               6      INC DE
00016C 026C 13               6      INC DE
00016D 026D 13               6      INC DE
00016E 026E 010C00          10      LD  BC,12
000171 0271 EDB0                    LDIR
                                
000173 0273 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;フロッピーディスクのシリンダ数
000176 0276 32DB03          13      LD  (MAXCYL),A
                                
000179 0279 2A0100          16      LD  HL,(WBOOT+1)
00017C 027C 2E89             7      LD  L,$89
00017E 027E 36FF            10      LD  (HL),$FF
                                
000180 0280 3A5C00          13      LD  A,(FCB1)
000183 0283 3D               4      DEC A
000184 0284 E5              11      PUSH    HL
000185 0285 2ED9             7      LD  L,$D9       ;CHGDRV
000187 0287 CD0F00          17      CALL    JP_HL
00018A 028A E1              10      POP HL
00018B 028B DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
00018E 028E E603             7      AND 3
000190 0290 F680             7      OR  $80
000192 0292 6F               4      LD  L,A
000193 0293 36FF            10      LD  (HL),$FF
000195 0295 CDA103          17      CALL    SURE
                                
000198 0298 115D07          10      LD  DE,PHYMES
00019B 029B 0E09             7      LD  C,9     ;文字列出力
00019D 029D CD0500          17      CALL    SYSTEM
                                
0001A0 02A0 CDBC03          17      CALL    PHYSIC
0001A3 02A3 CDB203          17      CALL    NL
0001A6 02A6 DA4C05          10      JP  C,ERROR
0001A9 02A9 CDC304          17      CALL    VERIFY
0001AC 02AC CDB203          17      CALL    NL
0001AF 02AF DA4C05          10      JP  C,ERROR
                                
0001B2 02B2 213809          10      LD  HL,FDATA
0001B5 02B5 113909          10      LD  DE,FDATA+1
0001B8 02B8 3600            10      LD  (HL),0
0001BA 02BA 010004          10      LD  BC,$400
0001BD 02BD EDB0                    LDIR
0001BF 02BF DD7E06          19      LD  A,(IX+DPB_FATID)    ;メディアバイト
0001C2 02C2 FEFD             7      CP  $FD
0001C4 02C4 216508          10      LD  HL,BPB_2D
0001C7 02C7 281A            12      JR  Z,IPL
0001C9 02C9 FEFE             7      CP  $FE
0001CB 02CB 21A908          10      LD  HL,BPB_2HD
0001CE 02CE 2813            12      JR  Z,IPL
0001D0 02D0 FEF0             7      CP  $F0
0001D2 02D2 21ED08          10      LD  HL,BPB_2HQ
0001D5 02D5 280C            12      JR  Z,IPL
0001D7 02D7 DD7E0A          19      LD  A,(IX+DPB_FDMODE)   ;フロッピーディスクのモード
0001DA 02DA 218708          10      LD  HL,BPB_2DD
0001DD 02DD 3C               4      INC A
0001DE 02DE 2803            12      JR  Z,IPL
0001E0 02E0 21CB08          10      LD  HL,BPB_2HC
       02E3                     IPL:
0001E3 02E3 113809          10      LD  DE,FDATA
0001E6 02E6 0E22             7      LD  C,$22
0001E8 02E8 EDB0                    LDIR
0001EA 02EA 210F09          10      LD  HL,IPLPRG
0001ED 02ED 0E0D             7      LD  C,IPLPEND-IPLPRG
0001EF 02EF EDB0                    LDIR
0001F1 02F1 21180B          10      LD  HL,FDATA+$1E0
0001F4 02F4 0610             7      LD  B,$10
       02F6                     LOW1:
0001F6 02F6 3622            10      LD  (HL),$22
0001F8 02F8 23               6      INC HL
0001F9 02F9 36FE            10      LD  (HL),$FE
0001FB 02FB 23               6      INC HL
0001FC 02FC 10F8            13      DJNZ    LOW1
                                
0001FE 02FE 110000          10      LD  DE,0
000201 0301 213809          10      LD  HL,FDATA
000204 0304 CDFE04          17      CALL    DWT
000207 0307 B7               4      OR  A
000208 0308 C24C05          10      JP  NZ,ERROR
                                
00020B 030B 1822            12      JR  LOGICX
       030D                     TYPEY:
00020D 030D 11B706          10      LD  DE,CRLF
000210 0310 0E09             7      LD  C,9     ;文字列出力
000212 0312 CD0500          17      CALL    SYSTEM
       0315                     LOGICY:
000215 0315 3A5C00          13      LD  A,(FCB1)
000218 0318 3D               4      DEC A
000219 0319 2A0100          16      LD  HL,(WBOOT+1)
00021C 031C 2EDC             7      LD  L,$DC       ;_GETDPB
00021E 031E CD0F00          17      CALL    JP_HL
000221 0321 2A0100          16      LD  HL,(WBOOT+1)
000224 0324 2EE2             7      LD  L,$E2       ;_RDFATX
000226 0326 CD0F00          17      CALL    JP_HL
000229 0329 DA4C05          10      JP  C,ERROR
       032C                     LOGIC:
00022C 032C CDA103          17      CALL    SURE
       032F                     LOGICX:
00022F 032F 116F07          10      LD  DE,LOGMES
000232 0332 0E09             7      LD  C,9     ;文字列出力
000234 0334 CD0500          17      CALL    SYSTEM
                                
000237 0337 213809          10      LD  HL,FDATA
00023A 033A 5D               4      LD  E,L
00023B 033B 54               4      LD  D,H
00023C 033C 13               6      INC DE
00023D 033D AF               4      XOR A
00023E 033E 77               7      LD  (HL),A
00023F 033F 010304          10      LD  BC,$03FF+4
000242 0342 EDB0                    LDIR
                                ;
000244 0344 213809          10      LD  HL,FDATA
000247 0347 DD7E06          19      LD  A,(IX+DPB_FATID)    ;メディアバイト
00024A 034A 77               7      LD  (HL),A      ;FATID
00024B 034B 23               6      INC HL
00024C 034C 36FF            10      LD  (HL),$FF
00024E 034E 23               6      INC HL
00024F 034F 36FF            10      LD  (HL),$FF
000251 0351 23               6      INC HL
000252 0352 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;FAT情報と論理セクタのサイズ
000255 0355 87               4      ADD A,A
000256 0356 87               4      ADD A,A
000257 0357 87               4      ADD A,A
000258 0358 9F               4      SBC A,A
000259 0359 77               7      LD  (HL),A          ;FAT12=00 FAT16=FF
00025A 035A DD5E0E          19      LD  E,(IX+DPB_FATPS)    ;FAT領域の先頭論理セクタ番号
00025D 035D 1600             7      LD  D,0
                                
00025F 035F DD7E0F          19      LD  A,(IX+DPB_BPS)  ;FAT情報と論理セクタのサイズ
000262 0362 E680             7      AND $80     ;bit7:予備FAT
       0364                     LOGIC0:
000264 0364 F5              11      PUSH    AF
000265 0365 DD4E00          19      LD  C,(IX+DPB_FATLN)    ;FAT領域のセクタ単位でのサイズ
000268 0368 DD4601          19      LD  B,(IX+DPB_FATLN+1)
00026B 036B 213809          10      LD  HL,FDATA
       036E                     LOGIC1:
00026E 036E CDFE04          17      CALL    DWT
000271 0371 B7               4      OR  A
000272 0372 C24C05          10      JP  NZ,ERROR
000275 0375 213C09          10      LD  HL,FDATA+4
000278 0378 0B               6      DEC BC
000279 0379 78               4      LD  A,B
00027A 037A B1               4      OR  C
00027B 037B 20F1            12      JR  NZ,LOGIC1
                                
00027D 037D F1              10      POP AF
00027E 037E 87               4      ADD A,A     ;bit7:予備FAT
00027F 037F 38E3            12      JR  C,LOGIC0
       0381                     LOGIC2:             ;ディレクトリエントリ
000281 0381 DD5E10          19      LD  E,(IX+DPB_DIRPS)    ;ルートディレクトリ領域の先頭論理セクタ番号
000284 0384 DD5611          19      LD  D,(IX+DPB_DIRPS+1)
                                
000287 0387 DD460B          19      LD  B,(IX+DPB_DIRSCNT)  ;ルートディレクトリ領域の論理セクタ数
       038A                     LOGIC3:
00028A 038A 213C09          10      LD  HL,FDATA+4
00028D 038D CDFE04          17      CALL    DWT
000290 0390 B7               4      OR  A
000291 0391 C24C05          10      JP  NZ,ERROR
000294 0394 10F4            13      DJNZ    LOGIC3
                                
000296 0396 119007          10      LD  DE,COMMES
000299 0399 0E09             7      LD  C,9     ;文字列出力
00029B 039B CD0500          17      CALL    SYSTEM
       039E                     LOGICL:
00029E 039E C30000          10      JP  0
       03A1                     SURE:
0002A1 03A1 119D07          10      LD  DE,HITMES
0002A4 03A4 0E09             7      LD  C,9     ;文字列出力
0002A6 03A6 CD0500          17      CALL    SYSTEM
       03A9                     SURE1:
0002A9 03A9 0E08             7      LD  C,8     ;エコーなしコンソール入力
0002AB 03AB CD0500          17      CALL    SYSTEM
0002AE 03AE FE0D             7      CP  $0D
0002B0 03B0 20F7            12      JR  NZ,SURE1
       03B2                     NL:
0002B2 03B2 F5              11      PUSH    AF
0002B3 03B3 1E04             7      LD  E,4
0002B5 03B5 0E06             7      LD  C,6     ;コンソール直接入出力
0002B7 03B7 CD0500          17      CALL    SYSTEM
0002BA 03BA F1              10      POP AF
0002BB 03BB C9              10      RET
                                
       03BC                     PHYSIC:
0002BC 03BC CD3105          17      CALL    GUIDE
0002BF 03BF 110000          10      LD  DE,0
0002C2 03C2 D9               4      EXX
0002C3 03C3 2E00             7      LD  L,0     ;CYLINDER
       03C5                     PH1:
0002C5 03C5 C5              11      PUSH    BC
0002C6 03C6 D5              11      PUSH    DE
0002C7 03C7 E5              11      PUSH    HL
0002C8 03C8 1E77             7      LD  E,'w'
0002CA 03CA 0E02             7      LD  C,2     ;コンソール出力
0002CC 03CC CD0500          17      CALL    SYSTEM
0002CF 03CF E1              10      POP HL
0002D0 03D0 D1              10      POP DE
0002D1 03D1 C1              10      POP BC
       03D2                     PH2:
0002D2 03D2 D9               4      EXX
0002D3 03D3 CD3D04          17      CALL    MAKE
0002D6 03D6 D8              11      RET C
0002D7 03D7 D9               4      EXX
0002D8 03D8 2C               4      INC L
0002D9 03D9 7D               4      LD  A,L
0002DA 03DA FE00             7      CP  0
       03DB                     MAXCYL  EQU $-1
0002DC 03DC 38E7            12      JR  C,PH1
0002DE 03DE C9              10      RET
                                
       03DF                     WRITE_ID88:     ;PC-8801mkIISR
0002DF 03DF 3E0D             7      LD  A,0DH       ;エグゼキュート
0002E1 03E1 CDBBFF          17      CALL    PUTCOM
0002E4 03E4 3E60             7      LD  A,DSS/256
0002E6 03E6 CDBEFF          17      CALL    PUTDAT
0002E9 03E9 AF               4      XOR A
0002EA 03EA CDBEFF          17      CALL    PUTDAT
0002ED 03ED DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
0002F0 03F0 CDBEFF          17      CALL    PUTDAT      ;+0
0002F3 03F3 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
0002F6 03F6 CDBEFF          17      CALL    PUTDAT      ;+1 SC
0002F9 03F9 FD7E12          19      LD  A,(IY+18)   ;GSL
0002FC 03FC CDBEFF          17      CALL    PUTDAT      ;+2 GPL
0002FF 03FF D9               4      EXX
000300 0400 7D               4      LD  A,L     ;シリンダ番号
000301 0401 D9               4      EXX
000302 0402 87               4      ADD A,A     ;トラック番号
000303 0403 CDBEFF          17      CALL    PUTDAT      ;+3
000306 0406 DD7E0A          19      LD  A,(IX+DPB_FDMODE)   ;フロッピーディスクのモード
000309 0409 CDBEFF          17      CALL    PUTDAT      ;+4
00030C 040C DD7E0F          19      LD  A,(IX+DPB_BPS)  ;FAT情報と論理セクタのサイズ
00030F 040F E607             7      AND 7
000311 0411 FE03             7      CP  3
000313 0413 3802            12      JR  C,W88X1
000315 0415 3E03             7      LD  A,3
       0417                     W88X1:
000317 0417 CDBEFF          17      CALL    PUTDAT      ;+5 N
00031A 041A 3E01             7      LD  A,1
00031C 041C CDBEFF          17      CALL    PUTDAT      ;+6
00031F 041F 3ADB03          13      LD  A,(MAXCYL)
000322 0422 CDBEFF          17      CALL    PUTDAT      ;+7
                                
000325 0425 3E0D             7      LD  A,0DH       ;エグゼキュート
000327 0427 CDBBFF          17      CALL    PUTCOM
00032A 042A 3E60             7      LD  A,RESULTEX/256
00032C 042C CDBEFF          17      CALL    PUTDAT
00032F 042F 3E72             7      LD  A,RESULTEX%256
000331 0431 CDBEFF          17      CALL    PUTDAT
                                
000334 0434 CDC1FF          17      CALL    GETDAT
000337 0437 4F               4      LD  C,A
000338 0438 C6FF             7      ADD A,0FFH
00033A 043A D8              11      RET C
00033B 043B AF               4      XOR A
00033C 043C C9              10      RET
                                
       043D                     MAKE:
00033D 043D A7               4      AND A
00033E 043E 389F            12      JR  C,WRITE_ID88
000340 0440 FD213809        14      LD  IY,FDATA
000344 0444 D9               4      EXX
000345 0445 0E00             7      LD  C,0     ;SIDE0
000347 0447 CD6C04          17      CALL    MKDATA
00034A 044A FD225C04        20      LD  (GDATA+1),IY
00034E 044E D9               4      EXX
00034F 044F 0E01             7      LD  C,1     ;SIDE1
000351 0451 CD6C04          17      CALL    MKDATA
                                
000354 0454 213809          10      LD  HL,FDATA
000357 0457 CD5E04          17      CALL    WTTRK
00035A 045A D8              11      RET C
00035B 045B 213809          10  GDATA:  LD  HL,FDATA
       045E                     WTTRK:
00035E 045E D5              11      PUSH    DE
00035F 045F CDE800          17  WTTRKP: CALL    $00E8       ;_WTTRK
000362 0462 D1              10      POP DE
                                ;
000363 0463 DD6E0D          19      LD  L,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
000366 0466 2600             7      LD  H,0
000368 0468 19              11      ADD HL,DE
000369 0469 EB               4      EX  DE,HL
00036A 046A A7               4      AND A
00036B 046B C9              10      RET
                                
       046C                     MKDATA:
00036C 046C 2600             7      LD  H,0
00036E 046E D9               4      EXX
00036F 046F 211808          10      LD  HL,LGAP1
       0470                     GAP1    EQU $-2
000372 0472 CDB304          17      CALL    SETD
       0475                     MAKE1:
000375 0475 212D08          10      LD  HL,SEC512
       0476                     SEC EQU $-2
000378 0478 CDB304          17      CALL    SETD
00037B 047B D9               4      EXX
00037C 047C FD7500          19      LD  (IY+0),L        ;CYLINDER
00037F 047F FD23            10      INC IY
000381 0481 FD7100          19      LD  (IY+0),C        ;SIDE
000384 0484 FD23            10      INC IY
000386 0486 7D               4      LD  A,L
000387 0487 B1               4      OR  C
000388 0488 B4               4      OR  H
000389 0489 3E01             7      LD  A,1
00038B 048B 2802            12      JR  Z,MAKES1
00038D 048D 7C               4      LD  A,H
00038E 048E 3C               4      INC A
       048F                     MAKES1:
00038F 048F 24               4      INC H
000390 0490 FD7700          19      LD  (IY+0),A        ;SECTOR
000393 0493 E5              11      PUSH    HL
000394 0494 FD23            10      INC IY
000396 0496 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;FAT情報と論理セクタのサイズ
000399 0499 E607             7      AND 7
00039B 049B FE03             7      CP  3
00039D 049D 3802            12      JR  C,SIZE
       049F                     SIZE1024:
00039F 049F 3E03             7      LD  A,3
       04A1                     SIZE:
0003A1 04A1 FD7700          19      LD  (IY+0),A    ;SIZE
0003A4 04A4 FD23            10      INC IY
0003A6 04A6 D9               4      EXX
0003A7 04A7 CDB304          17      CALL    SETD
0003AA 04AA F1              10      POP AF      ;AF=HL
0003AB 04AB DDBE0D           7      CP  (IX+DPB_MAXSEC) ;フロッピーディスクの1トラックのセクタ数
0003AE 04AE 38C5            12      JR  C,MAKE1
                                
0003B0 04B0 212608          10      LD  HL,HGAP4
       04B3                     SETD:
0003B3 04B3 7E               7      LD  A,(HL)
0003B4 04B4 23               6      INC HL
0003B5 04B5 47               4      LD  B,A
0003B6 04B6 3C               4      INC A
0003B7 04B7 C8              11      RET Z
0003B8 04B8 7E               7      LD  A,(HL)
0003B9 04B9 23               6      INC HL
       04BA                     SETD1:
0003BA 04BA FD7700          19      LD  (IY+0),A
0003BD 04BD FD23            10      INC IY
0003BF 04BF 10F9            13      DJNZ    SETD1
0003C1 04C1 18F0            12      JR  SETD
                                
       04C3                     VERIFY:
0003C3 04C3 113809          10      LD  DE,FDATA
0003C6 04C6 0E1A             7      LD  C,$1A       ;DTAの設定
0003C8 04C8 CD0500          17      CALL    SYSTEM
                                
0003CB 04CB CD3105          17      CALL    GUIDE
                                
0003CE 04CE 110000          10      LD  DE,0
0003D1 04D1 3ADB03          13      LD  A,(MAXCYL)
0003D4 04D4 47               4      LD  B,A
                                
       04D5                     VE2:
0003D5 04D5 C5              11      PUSH    BC
0003D6 04D6 D5              11      PUSH    DE
0003D7 04D7 1E76             7      LD  E,'v'
0003D9 04D9 0E02             7      LD  C,2     ;コンソール出力
0003DB 04DB CD0500          17      CALL    SYSTEM
0003DE 04DE D1              10      POP DE
0003DF 04DF D5              11      PUSH    DE
0003E0 04E0 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
0003E3 04E3 87               4      ADD A,A
0003E4 04E4 67               4      LD  H,A
0003E5 04E5 3A5C00          13      LD  A,(FCB1)
0003E8 04E8 3D               4      DEC A
0003E9 04E9 6F               4      LD  L,A
0003EA 04EA 0E2F             7      LD  C,$2F       ;論理セクタを用いた読み出し
0003EC 04EC CD0500          17      CALL    SYSTEM
0003EF 04EF D1              10      POP DE
0003F0 04F0 C1              10      POP BC
0003F1 04F1 D8              11      RET C
0003F2 04F2 2600             7      LD  H,0
0003F4 04F4 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
0003F7 04F7 87               4      ADD A,A
0003F8 04F8 6F               4      LD  L,A
0003F9 04F9 19              11      ADD HL,DE
0003FA 04FA EB               4      EX  DE,HL
0003FB 04FB 10D8            13      DJNZ    VE2
       04FD                     VERE:
0003FD 04FD C9              10      RET
                                
       04FE                     DWT:
0003FE 04FE E5              11      PUSH    HL
0003FF 04FF C5              11      PUSH    BC
000400 0500 D5              11      PUSH    DE
000401 0501 EB               4      EX  DE,HL
000402 0502 0E1A             7      LD  C,$1A       ;DTAの設定
000404 0504 CD0500          17      CALL    SYSTEM
000407 0507 D1              10      POP DE
000408 0508 D5              11      PUSH    DE
000409 0509 3A5C00          13      LD  A,(FCB1)
00040C 050C 3D               4      DEC A
00040D 050D 6F               4      LD  L,A
00040E 050E 2601             7      LD  H,1
000410 0510 0E30             7      LD  C,$30       ;論理セクタを用いた書き込み
000412 0512 CD0500          17      CALL    SYSTEM
000415 0515 D1              10      POP DE
000416 0516 13               6      INC DE
000417 0517 C1              10      POP BC
000418 0518 E1              10      POP HL
000419 0519 C9              10      RET
                                
       051A                     SWITCH:
00041A 051A 118100          10      LD  DE,DTA+1
       051D                     SWITCH1:
00041D 051D 1A               7      LD  A,(DE)
00041E 051E FE20             7      CP  $20
000420 0520 D8              11      RET C
000421 0521 13               6      INC DE
000422 0522 FE2F             7      CP  '/'
000424 0524 20F7            12      JR  NZ,SWITCH1
000426 0526 1A               7      LD  A,(DE)
000427 0527 13               6      INC DE
       0528                     CAP:
000428 0528 FE61             7      CP  'a'
00042A 052A D8              11      RET C
00042B 052B FE7B             7      CP  'z'+1
00042D 052D D0              11      RET NC
00042E 052E D620             7      SUB $20
000430 0530 C9              10      RET
                                
       0531                     GUIDE:
000431 0531 3ADB03          13      LD  A,(MAXCYL)
000434 0534 47               4      LD  B,A
000435 0535 0E02             7      LD  C,2
000437 0537 1E2E             7      LD  E,'.'
000439 0539 CD4205          17      CALL    GUIDE1
00043C 053C 3ADB03          13      LD  A,(MAXCYL)
00043F 053F 47               4      LD  B,A
000440 0540 1E08             7      LD  E,8     ;コンソール直接入出力
       0542                     GUIDE1:
000442 0542 C5              11      PUSH    BC
000443 0543 D5              11      PUSH    DE
000444 0544 CD0500          17      CALL    SYSTEM
000447 0547 D1              10      POP DE
000448 0548 C1              10      POP BC
000449 0549 10F7            13      DJNZ    GUIDE1
00044B 054B C9              10      RET
                                
       054C                     ERROR:
00044C 054C 11AF07          10      LD  DE,ERRMES
00044F 054F 0E09             7      LD  C,9     ;文字列出力
000451 0551 CD0500          17      CALL    SYSTEM
000454 0554 C30000          10      JP  0
                                
       0557                     BPB_FROM_EMM:               ;EMMのサイズからBPBを作成する
000457 0557 118107          10      LD  DE,EMMMES
00045A 055A 0E09             7      LD  C,9     ;文字列出力
00045C 055C CD0500          17      CALL    SYSTEM
                                
00045F 055F DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
000462 0562 321E09          13      LD  (EMMAL),A
000465 0565 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;フロッピーディスクのシリンダ数
000468 0568 321F09          13      LD  (EMMBL),A
00046B 056B DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
00046E 056E 321C09          13      LD  (EMMDV),A
                                
000471 0571 CDED05          17      CALL    EADR0
000474 0574 ED78            12      IN  A,(C)
000476 0576 F5              11      PUSH    AF
                                
000477 0577 110000          10      LD  DE,0
       057A                     ECHECK1:
00047A 057A 13               6      INC DE
00047B 057B CDF405          17      CALL    EADR2
00047E 057E ED60            12      IN  H,(C)
000480 0580 CDF405          17      CALL    EADR2
000483 0583 7C               4      LD  A,H
000484 0584 C6E5             7      ADD A,0E5H
000486 0586 ED79            12      OUT (C),A
000488 0588 3C               4      INC A
000489 0589 CDED05          17      CALL    EADR0
00048C 058C ED79            12      OUT (C),A
00048E 058E 3D               4      DEC A
00048F 058F CDF405          17      CALL    EADR2
000492 0592 ED68            12      IN  L,(C)
000494 0594 CDF405          17      CALL    EADR2
000497 0597 ED61            12      OUT (C),H
000499 0599 BD               4      CP  L
00049A 059A 2004            12      JR  NZ,ECHECK2
00049C 059C CB7A             8      BIT 7,D
00049E 059E 28DA            12      JR  Z,ECHECK1
       05A0                     ECHECK2:
0004A0 05A0 CDED05          17      CALL    EADR0
0004A3 05A3 F1              10      POP AF
0004A4 05A4 ED79            12      OUT (C),A
                                
0004A6 05A6 21F7FF          10      LD  HL,0-9
0004A9 05A9 19              11      ADD HL,DE
0004AA 05AA D24C05          10      JP  NC,ERROR
                                
0004AD 05AD 01F60F          10      LD  BC,4086
0004B0 05B0 A7               4      AND A
0004B1 05B1 ED42            15      SBC HL,BC
0004B3 05B3 3806            12      JR  C,EFAT12
0004B5 05B5 211C06          10      LD  HL,CALC_FATLN16
0004B8 05B8 22C205          16      LD  (CALC_FATLN),HL
       05BB                     EFAT12:
0004BB 05BB D5              11      PUSH    DE
0004BC 05BC E1              10      POP HL
0004BD 05BD 223309          16      LD  (EMM_TotSec16),HL   ;総セクタ数
0004C0 05C0 EB               4      EX  DE,HL
       05C2                     CALC_FATLN  EQU $+1
0004C1 05C1 CD0C06          17      CALL    CALC_FATLN12        ;自己書き換え
0004C4 05C4 323609          13      LD  (EMM_FATSz16),A     ;FATのサイズ
0004C7 05C7 DD7700          19      LD  (IX+DPB_FATLN),A    ;FAT領域のセクタ単位でのサイズ
                                
0004CA 05CA 213809          10      LD  HL,FDATA
0004CD 05CD 113909          10      LD  DE,FDATA+1
0004D0 05D0 3600            10      LD  (HL),0
0004D2 05D2 01E801          10      LD  BC,512-FDATA+EMM_BPB
0004D5 05D5 EDB0                    LDIR
                                
0004D7 05D7 110000          10      LD  DE,0
0004DA 05DA 212009          10      LD  HL,EMM_BPB
0004DD 05DD CDFE04          17      CALL    DWT
0004E0 05E0 B7               4      OR  A
0004E1 05E1 C24C05          10      JP  NZ,ERROR
                                
0004E4 05E4 3A5C00          13      LD  A,(FCB1)
0004E7 05E7 5F               4      LD  E,A
0004E8 05E8 0E1B             7      LD  C,$1B       ;ディスク情報の獲得
0004EA 05EA C30500          10      JP  SYSTEM
                                
       05ED                     EADR0:
0004ED 05ED D5              11      PUSH    DE
0004EE 05EE EB               4      EX  DE,HL
0004EF 05EF 210000          10      LD  HL,0
0004F2 05F2 1808            12      JR  EADR1
       05F4                     EADR2:
0004F4 05F4 D5              11      PUSH    DE
0004F5 05F5 EB               4      EX  DE,HL
0004F6 05F6 29              11      ADD HL,HL
0004F7 05F7 ED4B1E09        20      LD  BC,(EMMAL)
0004FB 05FB 09              11      ADD HL,BC
       05FC                     EADR1:
0004FC 05FC ED4B1C09        20      LD  BC,(EMMDV)
000500 0600 ED71            12      OUT (C),0       ;Z80未定義命令
000502 0602 0C               4      INC C
000503 0603 ED69            12      OUT (C),L
000505 0605 0C               4      INC C
000506 0606 ED61            12      OUT (C),H
000508 0608 0C               4      INC C
000509 0609 EB               4      EX  DE,HL
00050A 060A D1              10      POP DE
00050B 060B C9              10      RET
                                
       060C                     CALC_FATLN12:   ;FAT12 - クラスタ数から必要なFATサイズを求める(セクタサイズ512)
00050C 060C 5D               4      LD  E,L
00050D 060D 54               4      LD  D,H
00050E 060E 29              11      ADD HL,HL   ;*2
00050F 060F 19              11      ADD HL,DE   ;*3
000510 0610 CB3C             8      SRL H   ;/2
000512 0612 CB1D             8      RR  L   ;1クラスタ辺り1.5バイト必要
000514 0614 11FF01          10      LD  DE,511  ;切り上げる
000517 0617 19              11      ADD HL,DE
000518 0618 7C               4      LD  A,H
000519 0619 CB3F             8      SRL A
00051B 061B C9              10      RET
                                
       061C                     CALC_FATLN16:   ;FAT16 - クラスタ数から必要なFATサイズを求める(セクタサイズ512)
00051C 061C 7D               4      LD  A,L
00051D 061D C6FF             7      ADD A,$FF
00051F 061F 9F               4      SBC A,A
000520 0620 E601             7      AND 1
000522 0622 84               4      ADD A,H
000523 0623 C9              10      RET
                                
       0624                     MSX:
000524 0624 FD2AC1FC        20      LD  IY,(EXPTBL) ;メインROMスロット
000528 0628 DD214701        14      LD  IX,FORMAT
00052C 062C CD1C00          17      CALL    CALSLT
00052F 062F C30000          10      JP  0
                                
       0632                     AT_DSS:
000532 6000                         ORG DSS,AT_DSS-$0100
                                
000532 6000 0608             7      LD  B,8
000534 6002 CD067C          17      CALL    GETPARAMS_N
       6005                     WRITE_ID1:
000537 6005 CD097C          17      CALL    SEEK
00053A 6008 385E            12      JR  C,FINISH_DISK
00053C 600A 3E4D             7      LD  A,4DH       ;WRITE ID
00053E 600C E7              12      RST 20H
00053F 600D 7A               4      LD  A,D     ;HD US1 US0
000540 600E E601             7      AND 1
000542 6010 87               4      ADD A,A
000543 6011 87               4      ADD A,A
000544 6012 B1               4      OR  C
000545 6013 E7              12      RST 20H
000546 6014 3A357C          13      LD  A,(S_PARAMS+5)  ;N
000549 6017 4F               4      LD  C,A
00054A 6018 E7              12      RST 20H
00054B 6019 3A317C          13      LD  A,(S_PARAMS+1)  ;SC
00054E 601C 47               4      LD  B,A
00054F 601D E7              12      RST 20H
000550 601E 3A327C          13      LD  A,(S_PARAMS+2)  ;GPL
000553 6021 E7              12      RST 20H
000554 6022 3EE5             7      LD  A,0E5H      ;D
000556 6024 E7              12      RST 20H
000557 6025 1E01             7      LD  E,1     ;R
       6027                     WRITE_ID2:
000559 6027 FB               4      EI
00055A 6028 76               4      HALT
00055B 6029 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00055D 602B E620             7      AND 020H        ;NO SERVICE
00055F 602D 2840            12      JR  Z,ERROR_DISK
000561 602F 7A               4      LD  A,D     ;C
000562 6030 CB3F             8      SRL A
000564 6032 D3FB            11      OUT (0FBH),A    ;FDC μPD765A データレジスタ
                                
000566 6034 FB               4      EI
000567 6035 76               4      HALT
000568 6036 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00056A 6038 E620             7      AND 020H        ;NO SERVICE
00056C 603A 2833            12      JR  Z,ERROR_DISK
00056E 603C 7A               4      LD  A,D     ;H
00056F 603D E601             7      AND 1
000571 603F D3FB            11      OUT (0FBH),A    ;FDC μPD765A データレジスタ
                                
000573 6041 FB               4      EI
000574 6042 76               4      HALT
000575 6043 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000577 6045 E620             7      AND 020H        ;NO SERVICE
000579 6047 2826            12      JR  Z,ERROR_DISK
00057B 6049 7B               4      LD  A,E     ;R
00057C 604A D3FB            11      OUT (0FBH),A    ;FDC μPD765A データレジスタ
                                
00057E 604C FB               4      EI
00057F 604D 76               4      HALT
000580 604E DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000582 6050 E620             7      AND 020H        ;NO SERVICE
000584 6052 281B            12      JR  Z,ERROR_DISK
000586 6054 79               4      LD  A,C     ;N
000587 6055 D3FB            11      OUT (0FBH),A    ;FDC μPD765A データレジスタ
                                
000589 6057 1C               4      INC E
00058A 6058 10CD            13      DJNZ    WRITE_ID2
                                
00058C 605A CD0F7C          17      CALL    CHECKRESULT
00058F 605D 3809            12      JR  C,FINISH_DISK
                                
000591 605F 7A               4      LD  A,D
000592 6060 3C               4      INC A
000593 6061 32337C          13      LD  (S_TRACK),A
000596 6064 E601             7      AND 1
000598 6066 209D            12      JR  NZ,WRITE_ID1
                                
       6068                     FINISH_DISK:
00059A 6068 9F               4      SBC A,A
00059B 6069 32407C          13      LD  (S_CMD_STATUS),A
00059E 606C C32A00          10      JP  S_MAIN
       606F                     ERROR_DISK:
0005A1 606F 37               4      SCF
0005A2 6070 18F6            12      JR  FINISH_DISK
                                
       6072                     RESULTEX:
0005A4 6072 3A407C          13      LD  A,(S_CMD_STATUS)
0005A7 6075 DF              12      RST 18H
0005A8 6076 C32A00          10      JP  S_MAIN
                                
0005AB 06AB                         ORG $$+$0100    ;$DEPHASE
       06AB                     AT_DSSE:
                                
       06AB                     TITLE:
0005AB 06AB 666F726D61742076        DB  "format v1.21"
            312E3231            
       06B7                     CRLF:
0005B7 06B7 0D0A                    DB  $0D,$0A
0005B9 06B9 24                      DB  '$'
       06BA                     MUSAGE:
0005BA 06BA 75736167653A2046        DB  "usage: FORMAT ﾄﾞﾗｲﾌﾞ:[ｽｲｯﾁ]",$0D,$0A
            4F524D415420C4DE    
            D7B2CCDE3A5BBDB2    
            AFC15D0D0A          
0005D7 06D7 092F432020464154        DB  9,"/C  FAT,ﾃﾞｨﾚｸﾄﾘ ｼｮｷｶ",$0D,$0A
            2CC3DEA8DAB8C4D8    
            20BCAEB7B60D0A      
0005EE 06EE 24                      DB  '$'
       06EF                     FORMES:
0005EF 06EF 666F726D61742024        DB  "format $"
       06F7                     FOTMES:
0005F7 06F7 666F726D61742074        DB  "format type (2D=0,2DD=1,2HD=2,2HC=3,2HQ=4,logical only=L)? $"
            797065202832443D    
            302C3244443D312C    
            3248443D322C3248    
            433D332C3248513D    
            342C6C6F67696361    
            6C206F6E6C793D4C    
            293F2024            
       0733                     FOTMESL:
000633 0733 666F726D61742074        DB  "format type (2D=0,2DD=1,logical only=L)? $"
            797065202832443D    
            302C3244443D312C    
            6C6F676963616C20    
            6F6E6C793D4C293F    
            2024                
       075D                     PHYMES:
00065D 075D 706879736963616C        DB  "physical format",$0D,$0A,'$'
            20666F726D61740D    
            0A24                
       076F                     LOGMES:
00066F 076F 6C6F676963616C20        DB  "logical  format",$0D,$0A,'$'
            20666F726D61740D    
            0A24                
       0781                     EMMMES:
000681 0781 616E616C79736973        DB  "analysis EMM",$0D,$0A,'$'
            20454D4D0D0A24      
       0790                     COMMES:
000690 0790 636F6D706C657465        DB  "completed!",$0D,$0A,'$'
            64210D0A24          
       079D                     HITMES:
00069D 079D 686974205B43525D        DB  "hit [CR] to start$"
            20746F2073746172    
            7424                
       07AF                     ERRMES:
0006AF 07AF 074572726F72210D        DB  7,"Error!",$0D,$0A,'$'
            0A24                
                                ;
                                ;   DPB Data
                                ;
                                
       07B9                     M2D:
0006B9 07B9 0200                    DW  2
0006BB 07BB FD02                    DB  $FD,2
0006BD 07BD 6401                    DW  356
0006BF 07BF FF0728090182            DB  $FF,7,40,9,1,$82
0006C5 07C5 0500A7000800            DW  5,$A7,8
       07CB                     M2DGSL:
0006CB 07CB 54                      DB  84
                                
       07CC                     M2DD:
0006CC 07CC 0300                    DW  3
0006CE 07CE F902                    DB  $F9,2
0006D0 07D0 CB02                    DW  715
0006D2 07D2 FF0750090182            DB  $FF,7,80,9,1,$82
0006D8 07D8 0700A7000A00            DW  7,$A7,10
       07DE                     M2DDGSL:
0006DE 07DE 54                      DB  84
                                
       07DF                     M2HD:
0006DF 07DF 0200                    DW  2
0006E1 07E1 FE01                    DB  $FE,1
0006E3 07E3 C704                    DW  1223
0006E5 07E5 FE064D080184            DB  $FE,6,77,8,1,$84
0006EB 07EB 0500A7000900            DW  5,$A7,9
       07F1                     M2HDGSL:
0006F1 07F1 74                      DB  116
                                
       07F2                     M2HC:
0006F2 07F2 0700                    DW  7
0006F4 07F4 F901                    DB  $F9,1
0006F6 07F6 4509                    DW  2373
0006F8 07F8 FE0E500F0182            DB  $FE,14,80,15,1,$82
0006FE 07FE 0500A7001B00            DW  5,$A7,27
       0804                     M2HCGSL:
000704 0804 54                      DB  84
                                
       0805                     M2HQ:
000705 0805 0900                    DW  9
000707 0807 F001                    DB  $F0,1
000709 0809 210B                    DW  2849
00070B 080B FE0E50120182            DB  $FE,14,80,18,1,$82
000711 0811 0500A7001F00            DW  5,$A7,31
       0817                     M2HQGSL:
000717 0817 54                      DB  84
                                
                                ;M2HDE:
                                ;   DW  2
                                ;   DB  $03,1
                                ;   DW  1429
                                ;   DB  $FE,6,80,9,1,$84
                                ;   DW  5,$A7,11
                                ;M2HDEGSL:
                                ;   DB  53
                                
                                ;M2HS:  DB  3
                                ;   DW  $FB,8
                                ;   DW  1432
                                ;   DB  $FE,10,80,9,1,4,4,10
                                ;
                                ;   Format Data
                                ;
       0818                     LGAP1:
000718 0818 204EFF                  DB  32,$4E,255
       081B                     HGAP1:
00071B 081B 504E0C0003F601FC        DB  80,$4E,12,$00,3,$F6,1,$FC,50,$4E,255
            324EFF              
       0826                     HGAP4:
000726 0826 004E004E004EFF          DB  0,$4E,0,$4E,0,$4E,255
                                ;
                                ;   Sector Data
                                ;
       082D                     SEC512:
00072D 082D 0C0003F501FEFF          DB  12,$00,3,$F5,1,$FE,255
                                
000734 0834 01F7164E0C0003F5        DB  1,$F7,22,$4E,12,$00,3,$F5,1,$FB
            01FB                
00073E 083E 00E500E5                DB  0,$E5,0,$E5
000742 0842 01F7544EFF              DB  1,$F7,84,$4E,255
       0847                     SEC1024:
000747 0847 0C0003F501FEFF          DB  12,$00,3,$F5,1,$FE,255
                                
00074E 084E 01F7164E0C0003F5        DB  1,$F7,22,$4E,12,$00,3,$F5,1,$FB
            01FB                
000758 0858 00E500E500E500E5        DB  0,$E5,0,$E5,0,$E5,0,$E5
000760 0860 01F7744EFF              DB  1,$F7,116,$4E,255
                                ;SEC1024E:
                                ;   DB  12,$00,3,$F5,1,$FE,255
                                ;
                                ;   DB  1,$F7,22,$4E,12,$00,3,$F5,1,$FB
                                ;   DB  0,$E5,0,$E5,0,$E5,0,$E5
                                ;   DB  1,$F7,53,$4E,255
                                ;
                                ;   Format Data 2HS
                                ;
                                ;SSEC:  DB  12,$00,3,$F5,1,$FE,255
                                ;
                                ;   DB  1,$F7,22,$4E,12,$00,3,$F5,1,$FB
                                ;   DB  0,$E5,0,$E5,0,$E5,0,$E5
                                ;   DB  1,$F7,53,$4E,255
                                ;
                                ;   BOOT-DATA
                                ;
       0865                     BPB_2D:
000765 0865 EBFE90                  DB  0EBH,0FEH,090H  ;BS_JmpBoot
000768 0868 4C44202020202020        DB  "LD      "  ;BS_OEMName
000770 0870 0002                    DW  512     ;BPB_BytsPerSec
000772 0872 02                      DB  2       ;BPB_SecPerClus
000773 0873 0100                    DW  1       ;BPB_RsvdSecCnt
000775 0875 02                      DB  2       ;BPB_NumFATs
000776 0876 7000                    DW  112     ;BPB_RootEntCnt
000778 0878 D002                    DW  720     ;BPB_TotSec16
00077A 087A FD                      DB  0FDH        ;BPB_Media
00077B 087B 0200                    DW  2       ;BPB_FATSz16
00077D 087D 0900                    DW  9       ;BPB_SecPerTrk
00077F 087F 0200                    DW  2       ;BPB_NumHeads
000781 0881 0000                    DW  0       ;BPB_HiddSec(2バイト)
000783 0883 C9              10      RET         ;for MSX
000784 0884 000000                  DB  0,0,0
                                
       0887                     BPB_2DD:
000787 0887 EBFE90                  DB  0EBH,0FEH,090H  ;BS_JmpBoot
00078A 088A 4C44202020202020        DB  "LD      "  ;BS_OEMName
000792 0892 0002                    DW  512     ;BPB_BytsPerSec
000794 0894 02                      DB  2       ;BPB_SecPerClus
000795 0895 0100                    DW  1       ;BPB_RsvdSecCnt
000797 0897 02                      DB  2       ;BPB_NumFATs
000798 0898 7000                    DW  112     ;BPB_RootEntCnt
00079A 089A A005                    DW  1440        ;BPB_TotSec16
00079C 089C F9                      DB  0F9H        ;BPB_Media
00079D 089D 0300                    DW  3       ;BPB_FATSz16
00079F 089F 0900                    DW  9       ;BPB_SecPerTrk
0007A1 08A1 0200                    DW  2       ;BPB_NumHeads
0007A3 08A3 0000                    DW  0       ;BPB_HiddSec(2バイト)
0007A5 08A5 C9              10      RET         ;for MSX
0007A6 08A6 000000                  DB  0,0,0
                                
       08A9                     BPB_2HD:
0007A9 08A9 EBFE90                  DB  0EBH,0FEH,090H  ;BS_JmpBoot
0007AC 08AC 4C44202020202020        DB  "LD      "  ;BS_OEMName
0007B4 08B4 0004                    DW  1024        ;BPB_BytsPerSec
0007B6 08B6 01                      DB  1       ;BPB_SecPerClus
0007B7 08B7 0100                    DW  1       ;BPB_RsvdSecCnt
0007B9 08B9 02                      DB  2       ;BPB_NumFATs
0007BA 08BA C000                    DW  192     ;BPB_RootEntCnt
0007BC 08BC D004                    DW  1232        ;BPB_TotSec16
0007BE 08BE FE                      DB  0FEH        ;BPB_Media
0007BF 08BF 0200                    DW  2       ;BPB_FATSz16
0007C1 08C1 0800                    DW  8       ;BPB_SecPerTrk
0007C3 08C3 0200                    DW  2       ;BPB_NumHeads
0007C5 08C5 0000                    DW  0       ;BPB_HiddSec(2バイト)
0007C7 08C7 C9              10      RET         ;for MSX
0007C8 08C8 000000                  DB  0,0,0
                                
       08CB                     BPB_2HC:
0007CB 08CB EBFE90                  DB  0EBH,0FEH,090H  ;BS_JmpBoot
0007CE 08CE 4C44202020202020        DB  "LD      "  ;BS_OEMName
0007D6 08D6 0002                    DW  512     ;BPB_BytsPerSec
0007D8 08D8 01                      DB  1       ;BPB_SecPerClus
0007D9 08D9 0100                    DW  1       ;BPB_RsvdSecCnt
0007DB 08DB 02                      DB  2       ;BPB_NumFATs
0007DC 08DC E000                    DW  224     ;BPB_RootEntCnt
0007DE 08DE 6009                    DW  2400        ;BPB_TotSec16
0007E0 08E0 F9                      DB  0F9H        ;BPB_Media
0007E1 08E1 0700                    DW  7       ;BPB_FATSz16
0007E3 08E3 0F00                    DW  15      ;BPB_SecPerTrk
0007E5 08E5 0200                    DW  2       ;BPB_NumHeads
0007E7 08E7 0000                    DW  0       ;BPB_HiddSec(2バイト)
0007E9 08E9 C9              10      RET         ;for MSX
0007EA 08EA 000000                  DB  0,0,0
                                
       08ED                     BPB_2HQ:
0007ED 08ED EBFE90                  DB  0EBH,0FEH,090H  ;BS_JmpBoot
0007F0 08F0 4C44202020202020        DB  "LD      "  ;BS_OEMName
0007F8 08F8 0002                    DW  512     ;BPB_BytsPerSec
0007FA 08FA 01                      DB  1       ;BPB_SecPerClus
0007FB 08FB 0100                    DW  1       ;BPB_RsvdSecCnt
0007FD 08FD 02                      DB  2       ;BPB_NumFATs
0007FE 08FE E000                    DW  224     ;BPB_RootEntCnt
000800 0900 400B                    DW  2880        ;BPB_TotSec16
000802 0902 F0                      DB  0F0H        ;BPB_Media
000803 0903 0900                    DW  9       ;BPB_FATSz16
000805 0905 1200                    DW  18      ;BPB_SecPerTrk
000807 0907 0200                    DW  2       ;BPB_NumHeads
000809 0909 0000                    DW  0       ;BPB_HiddSec(2バイト)
00080B 090B C9              10      RET         ;for MSX
00080C 090C 000000                  DB  0,0,0
                                
                                ;SIPL:  DB  $EB,$1E,$90,'L','D',$20,$20,$20
                                ;   DB  $20,$20,$20,"2","H","S",$20,$20
                                ;   DB  $20,$20,$04,$00,$01,$03,$00,$01
                                ;   DB  $00,$C0,$05,$A0,$FB,$01,$C9,$00
                                ;   DB  $EB,$FE
                                
       090F                     IPLPRG:
00080F 090F 01FC0F          10      LD  BC,$FFC
000812 0912 ED71                    DB  $ED,$71
000814 0914 3E07             7      LD  A,7
000816 0916 3286FF          13      LD  ($FF86),A
000819 0919 C3F500          10      JP  $F5
       091C                     IPLPEND:
                                
00081C 091C 000D                EMMDV:  DW  $0D00
00081E 091E 00                  EMMAL:  DB  0
00081F 091F 00                  EMMBL:  DB  0
                                
       0920                     EMM_BPB:
000820 0920 EBFE90                  DB  0EBH,0FEH,090H
       0923                     EMM_OEMName:
000823 0923 4C442D454D4D2020        DB  "LD-EMM  "
       092B                     EMM_BytsPerSec:
00082B 092B 0002                    DW  512
       092D                     EMM_SecPerClus:
00082D 092D 02                      DB  2
       092E                     EMM_RsvdSecCnt:
00082E 092E 0100                    DW  1
       0930                     EMM_NumFATs:
000830 0930 01                      DB  1
       0931                     EMM_RootEntCnt:
000831 0931 0002                    DW  512
       0933                     EMM_TotSec16:
000833 0933 0000                    DW  0
       0935                     EMM_Media:
000835 0935 FA                      DB  0FAH
       0936                     EMM_FATSz16:
000836 0936 0000                    DW  0
                                
       0938                     FDATA:
[EOF:FORMAT.ASM:SHIFT_JIS]
