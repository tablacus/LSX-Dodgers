;
; FAKEFREE Gaku
;
; 偽の残量（FATサイズが大きくなると重くなるのでその対策）
; LSX-Dodgers
;
SYSTEM	EQU	00005H
BASE	EQU	0000BH
JP_HL	EQU	0000FH
FCB1	EQU	0005CH
FCB2	EQU	0006CH
DTA1	EQU	00080H
_FAKEFREE	EQU	0ACH

	ORG 00100H
	JP	START		;0C3HはZ80ではJPだが、i8086ではRETなので
START:				;間違えてMS-DOS環境で実行しても即終了できる
	LD	DE,MSG_TITLE
	LD	C,9		;STROUT 文字列出力 CP/M
	CALL	SYSTEM
MAIN:
	LD	C,06FH		;DOSVER MSX-DOS のバージョン番号の獲得
	CALL	SYSTEM
	OR	A
	JR	NZ,USAGE
	LD	HL,011DH	;LSX-Dodgersかどうか？
	SBC	HL,BC
	JR	NZ,USAGE
	LD	HL,0135H-1	;LSX-Dodgersのバージョンが1.35以上か？
	SBC	HL,DE
	JR	NC,USAGE

	LD	DE,DTA1;
	LD	HL,0
TRIM:
	INC	DE
	LD	A,(DE)
	CP	020H
	JR	Z,TRIM
	LD	A,E
	PUSH	AF
LOOP:
	LD	A,(DE)
	CP	020H
	JR	Z,LOOP
	SUB	'0'
	JR	C,SETFAKE
	CP	10
	JR	NC,SETFAKE
	LD	C,L
	LD	B,H
	ADD	HL,HL	;*2
	ADD	HL,HL	;*4
	ADD	HL,BC	;*5
	ADD	HL,HL	;*10
	LD	C,A
	LD	B,0
	ADD	HL,BC
	INC	DE
	JR	LOOP
SETFAKE:
	POP	AF
	CP	E
	JR	Z,USAGE
	LD	A,(BASE)
	LD	E,_FAKEFREE
	LD	D,A
	EX	DE,HL
	LD	(HL),E
	INC	HL
	LD	(HL),D
	LD	DE,MSG_OK
	LD	C,9		;STROUT 文字列出力 CP/M
	CALL	SYSTEM
	JP	0
USAGE:
	LD	DE,MSG_USAGE
	LD	C,9		;STROUT 文字列出力 CP/M
	CALL	SYSTEM
	JP	0

MSG_TITLE:
	DB	"fakefree v1.00",00DH,00AH
	DB	'$'
CRLF:
	DB	00DH,00AH
	DB	'$'
MSG_USAGE:
	DB	"usage: FAKEFREE number",00DH,00AH
	DB	'$'
MSG_OK:
	DB	"OK"
	DB	00DH,00AH
	DB	'$'
