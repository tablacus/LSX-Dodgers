                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for MZ-700/1500　キー割り込み処理使用
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
       0001                     USE_8253    EQU 1
                                
                                    INCLUDE "M7.ASM"
                                ;   LSX-Dodgers for MZ-700/1500
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "M7DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MZ-700/1500
                                
       0001                     MAC EQU 1   ;MZ-700/1500
       0000                     DEV EQU 0
                                
       011D                     VER_6F  EQU 0011DH
                                
       8080                     RUN EQU 08080H
       8000                     OFFSET  EQU RUN-128
       CF06                     BDOS    EQU 0CF06H
       F000                     WORKAD  EQU 0F000H
       ED40                     TABLEAD EQU 0ED40H
       F300                     KEYBF   EQU 0F300H
       F330                     FATBF   EQU 0F330H
       FB30                     DTBUF   EQU 0FB30H
       FF30                     KBUF    EQU 0FF30H
       FFD9                     TRAP38  EQU 0FFD9H
       0028                     WIDTH   EQU 40
       0019                     LINE    EQU 25
       0070                     COLORF  EQU 070H
       0014                     KEYSP_H EQU 20
       0083                     KEYSP_L EQU 131
       0009                     COMS    EQU 9
       0004                     MAX_SEC_SZ_H    EQU 4       ;1セクタ1024バイトのサポート(2:off 4:on)
       0100                     BUFFER  EQU 00100H
       D0EA                     S27BUF_COM  EQU S27BUF
[EOF:M7DEF.ASM:SHIFT_JIS]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0001                     VER_3   EQU 1
       1D01                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0001                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0161                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 8000                         ORG OFFSET
                                                    ;MZTヘッダ128バイト
000000 8000 01                      DB  1           ;ファイルモード
000001 8001 4C44202020202020        DB  "LD           "     ;ファイル名(13)
            2020202020          
00000E 800E 535953                  DB  "SYS"           ;拡張子(3)
000011 8011 0D                      DB  $0D
000012 8012 4625                    DW  LAST_ADR-RUN        ;サイズ
000014 8014 8080                    DW  RUN         ;開始アドレス
000016 8016 8080                    DW  RUN         ;実行アドレス
000018 8018                         DS  104
                                
                                    INCLUDE "M7INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   MZ-700/1500
                                
000080 8080 C38780          10      JP  START
000083 8083 011D                    DW  MACW
000085 8085 6101                    DW  VER
                                
       8087                     START:
000087 8087 F3               4      DI
000088 8088 ED56             8      IM  1
00008A 808A 318780          10      LD  SP,START
00008D 808D CD9B80          17      CALL    INIT        ;NZならAUTOEXECを実行
000090 8090 210000          10      LD  HL,0
000093 8093 E5              11      PUSH    HL
000094 8094 C8              11      RET Z
000095 8095 118081          10      LD  DE,AUTOD
000098 8098 C3FDF0          10      JP  _COMANL
                                
       809B                     INIT:
00009B 809B D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFFH)
00009D 809D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00009F 809F 21E881          10      LD  HL,INITE
0000A2 80A2 1106CF          10      LD  DE,BDOS
0000A5 80A5 01DE23          10      LD  BC,LAST_ADR-INITE
0000A8 80A8 EDB0                    LDIR
0000AA 80AA 21B781          10      LD  HL,M7BEEPD
0000AD 80AD 1162F0          10      LD  DE,BEEPD+1
0000B0 80B0 010A00          10      LD  BC,M7BEEPE-M7BEEPD
0000B3 80B3 EDB0                    LDIR
                                
0000B5 80B5 210000          10      LD  HL,0
0000B8 80B8 065C             7      LD  B,05CH
0000BA 80BA 3E                      DB  03EH    ;LD A,??
0000BB 80BB EF              12      RST 28H
0000BC 80BC CD7FDC          17      CALL    FILL_MEMORY
0000BF 80BF 06A4             7      LD  B,0A4H
0000C1 80C1 AF               4      XOR A
0000C2 80C2 320400          13      LD  (_DVSW),A
0000C5 80C5 CD7FDC          17      CALL    FILL_MEMORY
                                
0000C8 80C8 3EC3             7      LD  A,0C3H      ;JP
0000CA 80CA 2103F0          10      LD  HL,CPM_WBOOT
0000CD 80CD 320000          13      LD  (00000H),A
0000D0 80D0 220100          16      LD  (00001H),HL ;IPL
                                
0000D3 80D3 2106CF          10      LD  HL,BDOS
0000D6 80D6 320500          13      LD  (00005H),A
0000D9 80D9 220600          16      LD  (00006H),HL ;BDOS
                                
0000DC 80DC 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000DF 80DF 322800          13      LD  (00028H),A
0000E2 80E2 222900          16      LD  (00029H),HL ;RST 028H
                                
0000E5 80E5 323800          13      LD  (00038H),A
0000E8 80E8 210ECF          10      LD  HL,IO_INT8253
0000EB 80EB 223900          16      LD  (00039H),HL
                                
0000EE 80EE 215BF0          10      LD  HL,_DISKE+1
0000F1 80F1 2223F3          16      LD  (DISKVE),HL
0000F4 80F4 21F5F0          10      LD  HL,_BREAK+1
0000F7 80F7 2225F3          16      LD  (BREAKV),HL
                                
0000FA 80FA 3EF0             7      LD  A,CPM_BOOT/256
0000FC 80FC 320B00          13      LD  (0000BH),A
                                
0000FF 80FF 3EE9             7      LD  A,0E9H      ;JP (HL)
000101 8101 320F00          13      LD  (0000FH),A
                                                ;CHECK PCG(MZ-1500)
000104 8104 2100E8          10      LD  HL,0E800H
000107 8107 46               7      LD  B,(HL)
000108 8108 F3               4      DI
000109 8109 3E01             7      LD  A,1
00010B 810B D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00010D 810D 4E               7      LD  C,(HL)
00010E 810E 79               4      LD  A,C
00010F 810F C6A5             7      ADD A,0A5H
000111 8111 5F               4      LD  E,A
000112 8112 73               7      LD  (HL),E
000113 8113 D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
000115 8115 71               7      LD  (HL),C
000116 8116 3E01             7      LD  A,1
000118 8118 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00011A 811A 7E               7      LD  A,(HL)
00011B 811B BB               4      CP  E
00011C 811C D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
00011E 811E 70               7      LD  (HL),B
00011F 811F FB               4      EI
000120 8120 2804            12      JR  Z,MZ1500
000122 8122 AF               4      XOR A       ;MZ-700はPCGバンクが存在しない
000123 8123 32C0F2          13      LD  (GRAMFL),A
       8126                     MZ1500:
000126 8126 DD2180F2        14      LD  IX,EMMFL
00012A 812A CD7581          17      CALL    CHECK_EMM_BPB
00012D 812D FEEB             7      CP  0EBH
00012F 812F 2817            12      JR  Z,EMM_BPB
000131 8131 DD360D02        19      LD  (IX+DPB_MAXSEC),2   ;BPBが512バイト目から始まる場合を調べる
000135 8135 CD7581          17      CALL    CHECK_EMM_BPB
000138 8138 DDBE06          19      CP  (IX+DPB_FATID)
00013B 813B 200B            12      JR  NZ,EMM_BPB
00013D 813D DD360D00        19      LD  (IX+DPB_MAXSEC),0   ;BPBが先頭の場合に戻す
                                
000141 8141 2103E0          10      LD  HL,0E003H       ;SOUND MASK (MZ-1500)
000144 8144 AF               4      XOR A
000145 8145 CD61CF          17      CALL    WRMMIO
       8148                     EMM_BPB:
000148 8148 218C81          10      LD  HL,INIMES
00014B 814B CD8ED4          17      CALL    MSX
       814E                     INIT1:
00014E 814E F3               4      DI
00014F 814F 1100FF          10      LD  DE,0FF00H
000152 8152 0600             7      LD  B,0
000154 8154 CD2CD3          17      CALL    ZERO_MEMORY_DE
000157 8157 21CAFF          10      LD  HL,EXTBIO
00015A 815A 36C9            10      LD  (HL),0C9H   ;RET
00015C 815C 23               6      INC HL
00015D 815D 060E             7      LD  B,TRAP38-EXTBIO-1
00015F 815F 3E                      DB  03EH    ;LD A,??
000160 8160 EF              12      RST 28H
000161 8161 CD7FDC          17      CALL    FILL_MEMORY
000164 8164 21C181          10      LD  HL,AT_TRAP38
000167 8167 11D9FF          10      LD  DE,TRAP38
00016A 816A 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
00016D 816D EDB0                    LDIR
                                
00016F 816F CD32DB          17      CALL    CHKEY
000172 8172 FE03             7      CP  3
000174 8174 C9              10      RET
                                
       8175                     CHECK_EMM_BPB:
000175 8175 D5              11      PUSH    DE
000176 8176 110000          10      LD  DE,0
000179 8179 CDA9EA          17      CALL    EADR
00017C 817C D1              10      POP DE
00017D 817D ED78            12      IN  A,(C)
00017F 817F C9              10      RET
                                
000180 8180 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000189 8189 413A00              AUTODV: DB  "A:",0
                                
00018C 818C 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MZ-700/1500 v"
            6765727320666F72    
            204D5A2D3730302F    
            313530302076        
0001AA 81AA 312E                    DB  030H + VER_1, '.'
0001AC 81AC 3631                    DB  030H + VER_2 ,030H + VER_3
0001AE 81AE 69                      DB  'i'
0001AF 81AF 2047616B750D0A          DB  " Gaku",0DH,0AH
0001B6 81B6 00                      DB  0
                                
       81B7                     M7BEEPD:
0001B7 81B7 0801                    DB  8,1
0001B9 81B9 0736                    DB  7,036H
0001BB 81BB 04F9                    DB  4,0F9H
0001BD 81BD 0403                    DB  4,3
0001BF 81BF 0301                    DB  3,1         ;SOUND MASK(MZ-1500)
       81C1                     M7BEEPE:
                                
       81C1                     AT_TRAP38:
0001C1 FFD9                         ORG TRAP38,AT_TRAP38-OFFSET
0001C1 FFD9 210000          10      LD  HL,0
0001C4 FFDC E3              19      EX  (SP),HL
0001C5 FFDD 3E24             7      LD  A,'$'
0001C7 FFDF CD7ED7          17      CALL    MSG_A
0001CA FFE2 2B               6      DEC HL
0001CB FFE3 7C               4      LD  A,H
0001CC FFE4 CDE8FF          17      CALL    PRHX
0001CF FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
0001D0 FFE8 F5              11      PUSH    AF
0001D1 FFE9 07               4      RLCA
0001D2 FFEA 07               4      RLCA
0001D3 FFEB 07               4      RLCA
0001D4 FFEC 07               4      RLCA
0001D5 FFED CDF1FF          17      CALL    PRHX2
0001D8 FFF0 F1              10      POP AF
       FFF1                     PRHX2:
0001D9 FFF1 E60F             7      AND 00FH
0001DB FFF3 FE0A             7      CP  10
0001DD FFF5 3F               4      CCF
0001DE FFF6 CE30             7      ADC A,'0'
0001E0 FFF8 27               4      DAA
0001E1 FFF9 C37ED7          10      JP  MSG_A
0001E4 FFFC                         DS  4
0001E8 81E8                         ORG $$+OFFSET,$$    ;$DEPHASE
       81E8                     AT_TRAPE:
                                
       81E8                     INITE:
0001E8 CF06                         ORG BDOS,INITE-OFFSET
                                
0001E8 CF06 C309CF          10      JP  IO_BDOS
[EOF:M7INIT.ASM:SHIFT_JIS]
                                    INCLUDE "M7BANK.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                ;   VRAM/KEY/TIMER(0D000H-0EFFFH)にアクセスするので0D000H-0FFFFHに置けない部分
                                ;
                                
       CF09                     IO_BDOS:
0001EB CF09 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001ED CF0B C34ED4          10      JP  BDOS0
                                
                                #IF EXISTS USE_8253
       CF0E                     IO_INT8253:
0001F0 CF0E F5              11      PUSH    AF
0001F1 CF0F 3ACAFF          13      LD  A,(EXTBIO)
0001F4 CF12 3248D7          13      LD  (INTMEM_SWC),A
0001F7 CF15 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001F9 CF17 3E01             7      LD  A,1
0001FB CF19 3206E0          13      LD  (0E006H),A  ;8253 Ch.2 カウンタ
0001FE CF1C AF               4      XOR A
0001FF CF1D 3206E0          13      LD  (0E006H),A  ;8253 Ch.2 カウンタ
000202 CF20 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000204 CF22 C326D7          10      JP  INT8253
       CF25                     ROM8253E:
000207 CF25 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000209 CF27 F1              10      POP AF
00020A CF28 C9              10      RET
                                
       CF29                     INITINT:
00020B CF29 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00020D CF2B 2107E0          10      LD  HL,0E007H   ;HL=0E007H 8253 コントロール
000210 CF2E 36B0            10      LD  (HL),0B0H   ;Ch.2 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 0 16ビットバイナリ
000212 CF30 3674            10      LD  (HL),074H   ;Ch.1 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 2 16ビットバイナリ
000214 CF32 2D               4      DEC L       ;0E006H 8253 Ch.2 カウンタ
000215 CF33 3602            10      LD  (HL),2
000217 CF35 3600            10      LD  (HL),0
000219 CF37 2D               4      DEC L       ;0E005H 8253 Ch.1 カウンタ
00021A CF38 77               7      LD  (HL),A
00021B CF39 3600            10      LD  (HL),0
00021D CF3B 7D               4      LD  A,L     ;L=5
00021E CF3C 3203E0          13      LD  (0E003H),A  ;8255 コントロールポートでポートC(0E002H)のINTMSKを1にする
000221 CF3F D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000223 CF41 C9              10      RET
                                #ENDIF
                                
       CF42                     RDKEYDATA:
000224 CF42 F3               4      DI
000225 CF43 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000227 CF45 3200E0          13      LD  (0E000H),A
00022A CF48 3A01E0          13      LD  A,(E001H)
00022D CF4B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00022F CF4D FB               4      EI
                                #IF EXISTS USE_8253
                                #ELSE
                                IO_INT8253:
                                #ENDIF
000230 CF4E C9              10      RET
                                
       CF4F                     RD556VSYNC:
000231 CF4F F3               4      DI
000232 CF50 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000234 CF52 3A02E0          13      LD  A,(0E002H)
000237 CF55 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000239 CF57 FB               4      EI
00023A CF58 C9              10      RET
                                
       CF59                     RDMMIO:
00023B CF59 F3               4      DI
00023C CF5A D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00023E CF5C 7E               7      LD  A,(HL)
00023F CF5D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000241 CF5F FB               4      EI
000242 CF60 C9              10      RET
                                
       CF61                     WRMMIO:
000243 CF61 F3               4      DI
000244 CF62 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000246 CF64 77               7      LD  (HL),A
000247 CF65 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000249 CF67 FB               4      EI
00024A CF68 C9              10      RET
                                
       CF69                     RDMMIO_BC:
00024B CF69 F3               4      DI
00024C CF6A D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00024E CF6C 0A               7      LD  A,(BC)
00024F CF6D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000251 CF6F FB               4      EI
000252 CF70 C9              10      RET
                                
       CF71                     WRMMIO_BC:
000253 CF71 F3               4      DI
000254 CF72 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000256 CF74 02               7      LD  (BC),A
000257 CF75 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000259 CF77 FB               4      EI
00025A CF78 C9              10      RET
                                
       CF79                     IO_PRINT:
00025B CF79 F3               4      DI
00025C CF7A D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00025E CF7C 77               7      LD  (HL),A
00025F CF7D CBDC             8      SET 3,H
000261 CF7F 71               7      LD  (HL),C
000262 CF80 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000264 CF82 FB               4      EI
000265 CF83 C9              10      RET
                                
       CF84                     IO_CLR:
000266 CF84 F3               4      DI
000267 CF85 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF87                     C1AX1:
000269 CF87 7A               4      LD  A,D
00026A CF88 C6D0             7      ADD A,0D0H
00026C CF8A 57               4      LD  D,A
00026D CF8B AF               4      XOR A
00026E CF8C 12               7      LD  (DE),A      ;Text
00026F CF8D CBDA             8      SET 3,D
       CF90                     ICSMC   EQU $+1
000271 CF8F 3E00             7      LD  A,0     ;自己書き換え
000273 CF91 12               7      LD  (DE),A      ;Color
000274 CF92 13               6      INC DE
000275 CF93 7A               4      LD  A,D
000276 CF94 D6D8             7      SUB 0D8H
000278 CF96 57               4      LD  D,A
000279 CF97 2118FC          10      LD  HL,0-WIDTH*LINE
       CF98                     _NEG_PAGE_SWC   EQU $-2
00027C CF9A 19              11      ADD HL,DE
00027D CF9B 30EA            12      JR  NC,C1AX1
00027F CF9D E1              10      POP HL
000280 CF9E D1              10      POP DE
000281 CF9F D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000283 CFA1 FB               4      EI
000284 CFA2 C9              10      RET
                                
       CFA3                     IO_CLLINE:
000285 CFA3 F3               4      DI
000286 CFA4 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CFA6                     CLLINE1:
000288 CFA6 CB9C             8      RES 3,H
00028A CFA8 77               7      LD  (HL),A      ;Text
00028B CFA9 CBDC             8      SET 3,H
00028D CFAB 71               7      LD  (HL),C      ;Color
00028E CFAC 23               6      INC HL
00028F CFAD 10F7            13      DJNZ    CLLINE1
000291 CFAF D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000293 CFB1 FB               4      EI
000294 CFB2 C9              10      RET
                                
       CFB3                     IO_INSBS:
000295 CFB3 F3               4      DI
000296 CFB4 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CFB6                     IO_INSBS1:
000298 CFB6 CB9C             8      RES 3,H
00029A CFB8 5E               7      LD  E,(HL)
00029B CFB9 77               7      LD  (HL),A
00029C CFBA 7B               4      LD  A,E
00029D CFBB CBDC             8      SET 3,H
00029F CFBD 5E               7      LD  E,(HL)
0002A0 CFBE 71               7      LD  (HL),C
0002A1 CFBF 4B               4      LD  C,E
       CFC0                     IO_INCDEC   EQU $   ; 自己書き換え
0002A2 CFC0 23               6      INC HL      ;INS->INC HL or BS->DEC HL
0002A3 CFC1 10F3            13      DJNZ    IO_INSBS1
0002A5 CFC3 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0002A7 CFC5 FB               4      EI
0002A8 CFC6 C9              10      RET
                                
       CFC7                     IO_SCRUP:
0002A9 CFC7 F3               4      DI
0002AA CFC8 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CFCA                     SCRUP1:
0002AC CFCA 2815            12      JR  Z,SCRCL
0002AE CFCC D5              11      PUSH    DE
0002AF CFCD E5              11      PUSH    HL
0002B0 CFCE CBDA             8      SET 3,D
0002B2 CFD0 CBDC             8      SET 3,H
0002B4 CFD2 012800          10      LD  BC,WIDTH
0002B7 CFD5 EDB0                    LDIR
0002B9 CFD7 E1              10      POP HL
0002BA CFD8 D1              10      POP DE
0002BB CFD9 012800          10      LD  BC,WIDTH
0002BE CFDC EDB0                    LDIR
0002C0 CFDE 3D               4      DEC A
0002C1 CFDF 18E9            12      JR  SCRUP1
                                
       CFE1                     SCRCL:
0002C3 CFE1 0628             7      LD  B,WIDTH
0002C5 CFE3 EB               4      EX  DE,HL
0002C6 CFE4 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0002C8 CFE6 CD74D9          17      CALL    CLLINE
0002CB CFE9 E1              10      POP HL
0002CC CFEA D1              10      POP DE
0002CD CFEB C1              10      POP BC
0002CE CFEC C9              10      RET
                                
       CFED                     RD_PCG:
0002CF CFED F3               4      DI
0002D0 CFEE D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
0002D2 CFF0 4E               7      LD  C,(HL)
       CFF1                     RW_PCG:
0002D3 CFF1 D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
0002D5 CFF3 FB               4      EI
0002D6 CFF4 C9              10      RET
                                
       CFF5                     WR_PCG:
0002D7 CFF5 F3               4      DI
0002D8 CFF6 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
0002DA CFF8 71               7      LD  (HL),C
0002DB CFF9 18F6            12      JR  RW_PCG
                                
       CFFB                     IO_MON:
0002DD CFFB D3E4            11      OUT (0E4H),A    ;MONITOR ROM(0000H-0FFFH) & VRAM/KEY/TIMER(D000H-FFFFH)
0002DF CFFD C7              12      RST 0
                                
       CFFE                     BANKE:
0002E0 CFFE                         DS  0CFFEH-BANKE
[EOF:M7BANK.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MZ-700/1500
                                
       CFFE                     WBOOT1:
0002E0 CFFE D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)　ここは0CFFEH
0002E2 D000 D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFHH)
0002E4 D002 F3               4      DI
0002E5 D003 3A94F0          13      LD  A,(_KEYSP_L)
                                #IF EXISTS USE_8253
0002E8 D006 CD29CF          17      CALL    INITINT
                                #ENDIF
0002EB D009 ED7B0600        20      LD  SP,(SYSTEM+1)
0002EF D00D FB               4      EI
0002F0 D00E 2ABAF0          16      LD  HL,(_PAGE_MINUS)
0002F3 D011 2298CF          16      LD  (_NEG_PAGE_SWC),HL
0002F6 D014 2192F0          10      LD  HL,_KEYD
0002F9 D017 3600            10      LD  (HL),0
0002FB D019 CD32DB          17      CALL    CHKEY
0002FE D01C CD6BD7          17      CALL    KEYBC_IFBREAK
000301 D01F 3E04             7      LD  A,4
000303 D021 CD7ED7          17      CALL    MSG_A
[EOF:M7CCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D024                     COMMAND:
000306 D024 3AA7EB          13      LD  A,(FCB_BAT)
000309 D027 B7               4      OR  A
00030A D028 C266D1          10      JP  NZ,C_BAT1
00030D D02B CDDAD0          17      CALL    SETDTA1
000310 D02E 3A0400          13      LD  A,(_DVSW)
000313 D031 C641             7      ADD A,'A'
000315 D033 CD7ED7          17      CALL    MSG_A
000318 D036 3E3E             7      LD  A,'>'
00031A D038 CD7ED7          17      CALL    MSG_A
00031D D03B 3E50             7      LD  A,80
00031F D03D 12               7      LD  (DE),A
000320 D03E CDDED7          17      CALL    _SYS0A      ;(BDOS)文字列入力
000323 D041 CD5BD2          17      CALL    LTNL
       D044                     COMMAND2:
000326 D044 118200          10      LD  DE,DTA1+2
000329 D047 CDFDF0          17      CALL    _COMANL
00032C D04A DC12D7          17      CALL    C,SHOW_ERROR
00032F D04D 18D5            12      JR  COMMAND
                                
       D04F                     COMANL:
000331 D04F CDD4DB          17      CALL    FILE
000334 D052 3A19F0          13      LD  A,(FNAME+4)
000337 D055 FE20             7      CP  020H
000339 D057 201C            12      JR  NZ,COMB2
00033B D059 D5              11      PUSH    DE
00033C D05A 1115F0          10      LD  DE,FNAME
00033F D05D 1A               7      LD  A,(DE)
000340 D05E FE20             7      CP  020H
000342 D060 2844            12      JR  Z,SDVSW
000344 D062 1B               6      DEC DE
000345 D063 1A               7      LD  A,(DE)
000346 D064 C6FF             7      ADD A,0FFH
000348 D066 3809            12      JR  C,COMB
00034A D068 13               6      INC DE
                                
00034B D069 2118D4          10      LD  HL,COMTB
00034E D06C 0609             7      LD  B,COMS
000350 D06E CD61DE          17      CALL    CPNAME
       D071                     COMB:
000353 D071 D1              10      POP DE
000354 D072 D211D7          10      JP  NC,JPHL
       D075                     COMB2:
000357 D075 EB               4      EX  DE,HL
000358 D076 2243D1          16      LD  (COMSWC),HL
00035B D079 F5              11      PUSH    AF
00035C D07A CDFBD0          17      CALL    CEXE4
00035F D07D F1              10      POP AF
000360 D07E 2115F0          10      LD  HL,FNAME
000363 D081 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
000366 D084 010B00          10      LD  BC,11
000369 D087 EDB0                    LDIR
00036B D089 1146EB          10      LD  DE,PATHD
       D08C                     CEX1:
00036E D08C 1A               7      LD  A,(DE)
00036F D08D FE20             7      CP  020H
000371 D08F D8              11      RET C
000372 D090 CDC9DB          17      CALL    FILEC
000375 D093 D5              11      PUSH    DE
000376 D094 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
000379 D097 1115F0          10      LD  DE,FNAME
00037C D09A 010B00          10      LD  BC,11
00037F D09D EDB0                    LDIR
000381 D09F CDFBD0          17      CALL    CEXE4
000384 D0A2 D1              10      POP DE
000385 D0A3 13               6      INC DE
000386 D0A4 18E6            12      JR  CEX1
                                
       D0A6                     SDVSW:
000388 D0A6 F1              10      POP AF
000389 D0A7 3A14F0          13      LD  A,(FDRV)
00038C D0AA 3D               4      DEC A
00038D D0AB 5F               4      LD  E,A
00038E D0AC 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
000390 D0AE 1831            12      JR  SYSTEM0
                                
       D0B0                     OPEN1:
000392 D0B0 2114F0          10      LD  HL,FDRV
       D0B3                     OPEN:
000395 D0B3 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D0B5                     OPEN3:
000397 D0B5 D5              11      PUSH    DE
000398 D0B6 1182EB          10      LD  DE,DTA_CCP
00039B D0B9 CDD7D0          17      CALL    SETDTA
00039E D0BC EB               4      EX  DE,HL
00039F D0BD CDE1D0          17      CALL    SYSTEM0
0003A2 D0C0 D1              10      POP DE
0003A3 D0C1 C9              10      RET
                                
       D0C2                     OPEN2:
0003A4 D0C2 0E12             7      LD  C,012H
0003A6 D0C4 18EF            12      JR  OPEN3
                                
       D0C6                     DEFCB:              ;Z=Ok NZ=Error
0003A8 D0C6 1182EB          10      LD  DE,DTA_CCP
0003AB D0C9 CDDFD0          17      CALL    SYSC0F
                                
0003AE D0CC 11A3EB          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0003B1 D0CF 0604             7      LD  B,4
0003B3 D0D1 CD2CD3          17      CALL    ZERO_MEMORY_DE
       D0D4                     SETDTA100:
0003B6 D0D4 110001          10      LD  DE,BUFFER
       D0D7                     SETDTA:
0003B9 D0D7 C352D6          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D0DA                     SETDTA1:
0003BC D0DA 118000          10      LD  DE,DTA1
0003BF D0DD 18F8            12      JR  SETDTA
                                
       D0DF                     SYSC0F:
0003C1 D0DF 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D0E1                     SYSTEM0:
0003C3 D0E1 CD0500          17      CALL    SYSTEM
0003C6 D0E4 B7               4      OR  A
0003C7 D0E5 C9              10      RET
                                
       D0E6                     C_CD:
0003C8 D0E6 0E5A             7      LD  C,05AH
0003CA D0E8 18F7            12      JR  SYSTEM0
                                
       D0EA                     S27BUF:
0003CC D0EA 2100FE          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       D0ED                     S27BUF2:
0003CF D0ED 39              11      ADD HL,SP
0003D0 D0EE 2E00             7      LD  L,0
0003D2 D0F0 7C               4      LD  A,H
0003D3 D0F1 E6F8             7      AND 0F8H
0003D5 D0F3 67               4      LD  H,A
       D0F4                     S27DTA:
0003D6 D0F4 1182EB          10      LD  DE,DTA_CCP
       D0F7                     S27:
0003D9 D0F7 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
0003DB D0F9 18E6            12      JR  SYSTEM0
                                
       D0FB                     CEXE4:
0003DD D0FB 211DF0          10      LD  HL,FNAME+8
0003E0 D0FE 7E               7      LD  A,(HL)
0003E1 D0FF FE20             7      CP  020H
0003E3 D101 2007            12      JR  NZ,CEXE7
0003E5 D103 3E3F             7      LD  A,'?'
0003E7 D105 77               7      LD  (HL),A
0003E8 D106 23               6      INC HL
0003E9 D107 77               7      LD  (HL),A
0003EA D108 23               6      INC HL
0003EB D109 77               7      LD  (HL),A
       D10A                     CEXE7:
0003EC D10A CDB0D0          17      CALL    OPEN1
       D10D                     CEXE5:
0003EF D10D C0              11      RET NZ
0003F0 D10E 2A8CEB          16      LD  HL,(DTA_CCP+1+9)
0003F3 D111 7C               4      LD  A,H
0003F4 D112 CDF0DE          17      CALL    CAP
0003F7 D115 67               4      LD  H,A
0003F8 D116 7D               4      LD  A,L
0003F9 D117 CDF0DE          17      CALL    CAP
0003FC D11A 6F               4      LD  L,A
0003FD D11B 3A8BEB          13      LD  A,(DTA_CCP+1+8)
000400 D11E CDF0DE          17      CALL    CAP
000403 D121 D642             7      SUB 'B'
000405 D123 282C            12      JR  Z,C_BAT
000407 D125 3D               4      DEC A       ;'C'
000408 D126 2805            12      JR  Z,C_EXE
       D128                     CEXE6:
00040A D128 CDC2D0          17      CALL    OPEN2
00040D D12B 18E0            12      JR  CEXE5
                                
       D12D                     C_EXE:
00040F D12D 7C               4      LD  A,H
000410 D12E FE4D             7      CP  'M'
000412 D130 20F6            12      JR  NZ,CEXE6
                                
000414 D132 CDC6D0          17      CALL    DEFCB
000417 D135 CDEAD0          17      CALL    S27BUF_COM
00041A D138 3D               4      DEC A
00041B D139 37               4      SCF
00041C D13A C0              11      RET NZ
00041D D13B 7C               4      LD  A,H
00041E D13C B5               4      OR  L
00041F D13D 37               4      SCF
000420 D13E C8              11      RET Z
000421 D13F CDDAD0          17      CALL    SETDTA1
000424 D142 110000          10      LD  DE,0                ; self-modifying code
       D143                     COMSWC  EQU $-2
000427 D145 ED7B0600        20      LD  SP,(SYSTEM+1)
00042B D149 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
00042C D14A 6F               4      LD  L,A
00042D D14B E5              11      PUSH    HL              ; push $0000 (reboot address)
00042E D14C 24               4      INC H
00042F D14D E5              11      PUSH    HL              ; push $0100 (TPA address)
000430 D14E C3F7D2          10      JP  SETFCB              ; and JP $0100
                                
       D151                     C_BAT:
000433 D151 114154          10      LD  DE,'A'+'T'*256
000436 D154 ED52            15      SBC HL,DE
000438 D156 20D0            12      JR  NZ,CEXE6
                                
00043A D158 CDC6D0          17      CALL    DEFCB
                                
00043D D15B 2182EB          10      LD  HL,DTA_CCP
000440 D15E 11A7EB          10      LD  DE,FCB_BAT
000443 D161 012500          10      LD  BC,37
000446 D164 EDB0                    LDIR
       D166                     C_BAT1:
000448 D166 CDD4D0          17      CALL    SETDTA100
00044B D169 CD9DD1          17      CALL    FGETC_BAT
00044E D16C 218100          10      LD  HL,DTA1+1
000451 D16F 2025            12      JR  NZ,END_BATCH
000453 D171 FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
000455 D173 38F1            12      JR  C,C_BAT1
000457 D175 3620            10      LD  (HL),' '
000459 D177 23               6      INC HL
       D178                     C_BAT2:
00045A D178 77               7      LD  (HL),A
00045B D179 23               6      INC HL
00045C D17A 7D               4      LD  A,L
00045D D17B 3C               4      INC A       ;L==0FFH
00045E D17C 2809            12      JR  Z,RUN_BATCH
000460 D17E CD9DD1          17      CALL    FGETC_BAT
000463 D181 2004            12      JR  NZ,RUN_BATCH
000465 D183 FE20             7      CP  020H
000467 D185 30F1            12      JR  NC,C_BAT2
       D187                     RUN_BATCH:
000469 D187 7D               4      LD  A,L
00046A D188 D67F             7      SUB DTA1-1
00046C D18A 328000          13      LD  (DTA1),A
00046F D18D FE04             7      CP  4
000471 D18F 3805            12      JR  C,END_BATCH
000473 D191 3600            10      LD  (HL),0
000475 D193 C344D0          10      JP  COMMAND2
       D196                     END_BATCH:
000478 D196 AF               4      XOR A       ;バッチファイルを閉じる
000479 D197 32A7EB          13      LD  (FCB_BAT),A
00047C D19A C300F0          10      JP  CPM_BOOT
                                
       D19D                     FGETC_BAT:
00047F D19D 11A7EB          10      LD  DE,FCB_BAT
       D1A0                     FGETC:              ;1文字ずつ読み込む
000482 D1A0 E5              11      PUSH    HL      ;Z:成功
000483 D1A1 210100          10      LD  HL,1
000486 D1A4 CDF7D0          17      CALL    S27
000489 D1A7 E1              10      POP HL
00048A D1A8 3A0001          13      LD  A,(BUFFER)
00048D D1AB C9              10      RET
                                
       D1AC                     C_DEL:
00048E D1AC CDF7D2          17      CALL    SETFCB
000491 D1AF CD94D7          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
000494 D1B2 0E13             7      LD  C,013H
000496 D1B4 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D1B6                     C_REN:
000498 D1B6 CDF7D2          17      CALL    SETFCB
00049B D1B9 3E10             7      LD  A,010H      ;ディレクトリも対象にする
00049D D1BB 326900          13      LD  (FCB1+13),A ;属性
0004A0 D1BE 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D1C0                     CDEL1:
0004A2 D1C0 115C00          10      LD  DE,FCB1
0004A5 D1C3 CD0500          17      CALL    SYSTEM
0004A8 D1C6 C6FF             7      ADD A,0FFH
0004AA D1C8 C9              10      RET
                                
       D1C9                     C_DIR:
0004AB D1C9 CDC9DB          17      CALL    FILEC
0004AE D1CC 2115F0          10      LD  HL,FDRV+1
0004B1 D1CF CD0DD4          17      CALL    CWILD1
0004B4 D1D2 3EF1             7      LD  A,0F1H
0004B6 D1D4 3221F0          13      LD  (FDRV+13),A
0004B9 D1D7 CDB0D0          17      CALL    OPEN1
       D1DA                     CDIR1:
0004BC D1DA B7               4      OR  A
0004BD D1DB 2008            12      JR  NZ,PDSKF
0004BF D1DD CD28D2          17      CALL    P_NAME
0004C2 D1E0 CDC2D0          17      CALL    OPEN2
0004C5 D1E3 18F5            12      JR  CDIR1
       D1E5                     PDSKF:
0004C7 D1E5 3A14F0          13      LD  A,(FDRV)
0004CA D1E8 5F               4      LD  E,A
0004CB D1E9 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
0004CD D1EB CD0500          17      CALL    SYSTEM
0004D0 D1EE 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
0004D1 D1EF C601             7      ADD A,001H
0004D3 D1F1 D8              11      RET C       ;Aが0FFHだった場合
0004D4 D1F2 3E06             7      LD  A,8-2
       D1F4                     PDS1:               ;HL=未使用クラスタの総数
0004D6 D1F4 3C               4      INC A
0004D7 D1F5 CB19             8      RR  C
0004D9 D1F7 30FB            12      JR  NC,PDS1
       D1F9                     PDS2:               ;B←論理セクタのサイズの上位8ビット
0004DB D1F9 3C               4      INC A
0004DC D1FA CB18             8      RR  B
0004DE D1FC 30FB            12      JR  NC,PDS2
0004E0 D1FE 47               4      LD  B,A
                                
0004E1 D1FF 110000          10      LD  DE,0
       D202                     PDS3:
0004E4 D202 29              11      ADD HL,HL
0004E5 D203 EB               4      EX  DE,HL
0004E6 D204 ED6A            15      ADC HL,HL
0004E8 D206 EB               4      EX  DE,HL
0004E9 D207 10F9            13      DJNZ    PDS3
       D209                     PDSKF1:
0004EB D209 CD95D2          17      CALL    PRDEC_DEHL
0004EE D20C 11D7EB          10      LD  DE,FREE
0004F1 D20F CD7FD4          17      CALL    _SYS09      ;(BDOS)文字列出力
0004F4 D212 CD82D2          17      CALL    PUTDRV
0004F7 D215 3E5C             7      LD  A,05CH      ;\
0004F9 D217 CD7ED7          17      CALL    MSG_A
0004FC D21A 2A22F0          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
0004FF D21D AF               4      XOR A
000500 D21E 11FEFF          10      LD  DE,0-2
000503 D221 19              11      ADD HL,DE
000504 D222 23               6      INC HL
000505 D223 DC92D2          17      CALL    C,PRDEC_HL
000508 D226 1833            12      JR  LTNL
                                
       D228                     P_NAME:
00050A D228 3A83EB          13      LD  A,(DTA_CCP+1)
00050D D22B FE2E             7      CP  '.'
00050F D22D C8              11      RET Z
                                
000510 D22E 3A8EEB          13      LD  A,(DTA_CCP+1+00BH)
000513 D231 F5              11      PUSH    AF
000514 D232 CB67             8      BIT 4,A
000516 D234 2808            12      JR  Z,DIR3
000518 D236 11CCEB          10      LD  DE,DIRMES
00051B D239 CD7FD4          17      CALL    _SYS09      ;(BDOS)文字列出力
00051E D23C 180A            12      JR  DIR6
       D23E                     DIR3:
000520 D23E ED5BA1EB        20      LD  DE,(DTA_CCP+1+01EH)
000524 D242 2A9FEB          16      LD  HL,(DTA_CCP+1+01CH)
000527 D245 CD95D2          17      CALL    PRDEC_DEHL
       D248                     DIR6:
00052A D248 F1              10      POP AF
00052B D249 0F               4      RRCA
00052C D24A 9F               4      SBC A,A
00052D D24B E60A             7      AND '*'-020H
00052F D24D C620             7      ADD A,020H
000531 D24F CD7ED7          17      CALL    MSG_A
000534 D252 CD82D2          17      CALL    PUTDRV
000537 D255 2183EB          10      LD  HL,DTA_CCP+1
00053A D258 CDD5D2          17      CALL    FPRNT
                                
       D25B                     LTNL:
00053D D25B 1E03             7      LD  E,3
00053F D25D C3CDF0          10      JP  _PRINT
                                
       D260                     C_PATH:
000542 D260 CDAADC          17      CALL    SPCUT
000545 D263 2146EB          10      LD  HL,PATHD
000548 D266 FE21             7      CP  021H
00054A D268 300C            12      JR  NC,CPATH0
       D26A                     CPATHP:
00054C D26A 7E               7      LD  A,(HL)
00054D D26B 23               6      INC HL
00054E D26C FE20             7      CP  020H
000550 D26E 3F               4      CCF
000551 D26F 30EA            12      JR  NC,LTNL
000553 D271 CD7ED7          17      CALL    MSG_A
000556 D274 18F4            12      JR  CPATHP
       D276                     CPATH0:
000558 D276 FE3B             7      CP  ';'
00055A D278 2001            12      JR  NZ,CPATH1
00055C D27A 13               6      INC DE
       D27B                     CPATH1:
00055D D27B EB               4      EX  DE,HL
00055E D27C 013B00          10      LD  BC,PATHX
000561 D27F EDB0                    LDIR
000563 D281 C9              10      RET
                                
       D282                     PUTDRV:
000564 D282 3A14F0          13      LD  A,(FDRV)
000567 D285 CDDDDC          17      CALL    GETDRV1
00056A D288 C641             7      ADD A,'A'
00056C D28A CD7ED7          17      CALL    MSG_A
00056F D28D 3E3A             7      LD  A,':'
       D28F                     MSG_AR:
000571 D28F C37ED7          10      JP  MSG_A
                                
       D292                     PRDEC_HL:
000574 D292 AF               4      XOR A
000575 D293 5F               4      LD  E,A
000576 D294 57               4      LD  D,A
       D295                     PRDEC_DEHL:
000577 D295 D5              11      PUSH    DE
000578 D296 110FF0          10      LD  DE,DECBF
00057B D299 0605             7      LD  B,5
00057D D29B CD2CD3          17      CALL    ZERO_MEMORY_DE  ;A=0
000580 D29E D1              10      POP DE
                                
000581 D29F 0E20             7      LD  C,32
       D2A1                     DEC1:
000583 D2A1 29              11      ADD HL,HL
000584 D2A2 EB               4      EX  DE,HL
000585 D2A3 ED6A            15      ADC HL,HL
000587 D2A5 EB               4      EX  DE,HL
000588 D2A6 E5              11      PUSH    HL
000589 D2A7 2113F0          10      LD  HL,DECBF+4
00058C D2AA 0605             7      LD  B,5
       D2AC                     DEC2:
00058E D2AC 7E               7      LD  A,(HL)
00058F D2AD 8F               4      ADC A,A
000590 D2AE 27               4      DAA
000591 D2AF 77               7      LD  (HL),A
000592 D2B0 2B               6      DEC HL
000593 D2B1 10F9            13      DJNZ    DEC2
000595 D2B3 E1              10      POP HL
000596 D2B4 0D               4      DEC C
000597 D2B5 20EA            12      JR  NZ,DEC1
                                
000599 D2B7 210FF0          10      LD  HL,DECBF
00059C D2BA 3E20             7      LD  A,020H
00059E D2BC 0604             7      LD  B,4
       D2BE                     DEC3:
0005A0 D2BE CDCBD2          17      CALL    DEC4
0005A3 D2C1 CDCBD2          17      CALL    DEC4
0005A6 D2C4 23               6      INC HL
0005A7 D2C5 10F7            13      DJNZ    DEC3
       D2C7                     DECX:
0005A9 D2C7 CDCBD2          17      CALL    DEC4
0005AC D2CA AF               4      XOR A
       D2CB                     DEC4:
0005AD D2CB ED6F            18      RLD
0005AF D2CD FE20             7      CP  020H
0005B1 D2CF 2802            12      JR  Z,DEC5
0005B3 D2D1 F630             7      OR  030H
       D2D3                     DEC5:
0005B5 D2D3 18BA            12      JR  MSG_AR
                                
       D2D5                     FPRNT:
0005B7 D2D5 0608             7      LD  B,8 ;ファイル名を表示
0005B9 D2D7 CDE6D2          17      CALL    P_N1
0005BC D2DA 7E               7      LD  A,(HL)
0005BD D2DB CDFCDE          17      CALL    CAP3
0005C0 D2DE D8              11      RET C   ;拡張子が無い
                                
0005C1 D2DF 3E2E             7      LD  A,'.'
0005C3 D2E1 CD7ED7          17      CALL    MSG_A
0005C6 D2E4 0603             7      LD  B,3 ;拡張子を表示
       D2E6                     P_N1:
0005C8 D2E6 7E               7      LD  A,(HL)
0005C9 D2E7 CDFCDE          17      CALL    CAP3
0005CC D2EA 3807            12      JR  C,P_N2
0005CE D2EC CD7ED7          17      CALL    MSG_A
0005D1 D2EF 23               6      INC HL
0005D2 D2F0 10F4            13      DJNZ    P_N1
0005D4 D2F2 C9              10      RET
       D2F3                     P_N2:
0005D5 D2F3 23               6      INC HL
0005D6 D2F4 10FD            13      DJNZ    P_N2
0005D8 D2F6 C9              10      RET
                                
       D2F7                     SETFCB:
0005D9 D2F7 CDAADC          17      CALL    SPCUT
0005DC D2FA 1A               7      LD  A,(DE)
0005DD D2FB FE20             7      CP  020H
0005DF D2FD 3801            12      JR  C,SETFCBA
0005E1 D2FF 1B               6      DEC DE
       D300                     SETFCBA:
0005E2 D300 0624             7      LD  B,36
0005E4 D302 215C00          10      LD  HL,FCB1
0005E7 D305 E5              11      PUSH    HL
0005E8 D306 AF               4      XOR A
0005E9 D307 CD7FDC          17      CALL    FILL_MEMORY
0005EC D30A E1              10      POP HL
0005ED D30B D5              11      PUSH    DE
0005EE D30C CDB8D6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005F1 D30F 216C00          10      LD  HL,FCB2
0005F4 D312 CDB8D6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005F7 D315 E1              10      POP HL
0005F8 D316 010050          10      LD  BC,05000H
0005FB D319 118100          10      LD  DE,00081H
       D31C                     SETFCB1:
0005FE D31C 7E               7      LD  A,(HL)
0005FF D31D 23               6      INC HL
000600 D31E FE20             7      CP  020H
000602 D320 3805            12      JR  C,SETFCB2
000604 D322 12               7      LD  (DE),A
000605 D323 13               6      INC DE
000606 D324 0C               4      INC C
000607 D325 10F5            13      DJNZ    SETFCB1
       D327                     SETFCB2:
000609 D327 79               4      LD  A,C
00060A D328 328000          13      LD  (DTA1),A
00060D D32B 04               4      INC B
       D32C                     ZERO_MEMORY_DE:
00060E D32C AF               4      XOR A
       D32D                     FILL_MEMORY_DE:
00060F D32D 12               7      LD  (DE),A
000610 D32E 13               6      INC DE
000611 D32F 10FC            13      DJNZ    FILL_MEMORY_DE
000613 D331 C9              10      RET
                                
       D332                     C_COPY:
000614 D332 CDF7D2          17      CALL    SETFCB
                                
000617 D335 1161F0          10      LD  DE,ZERO
00061A D338 CDCCDB          17      CALL    FILEC2
00061D D33B 216C00          10      LD  HL,FCB2
000620 D33E CDBFD6          17      CALL    S29X1
                                
000623 D341 3E10             7      LD  A,010H
000625 D343 326900          13      LD  (FCB1+13),A
000628 D346 216D00          10      LD  HL,FCB2FN
00062B D349 CD0DD4          17      CALL    CWILD1
       D34C                     COPY0:
00062E D34C CD0AD4          17      CALL    CWILD
000631 D34F 215C00          10      LD  HL,FCB1
000634 D352 CDB3D0          17      CALL    OPEN
000637 D355 37               4      SCF
       D356                     COPY1:
000638 D356 C0              11      RET NZ
000639 D357 CDC6D0          17      CALL    DEFCB
                                
00063C D35A 3A8FEB          13      LD  A,(DTA_CCP+13)
00063F D35D CB67             8      BIT 4,A
000641 D35F 2821            12      JR  Z,COPY1A
                                
000643 D361 215D00          10      LD  HL,FCB1FN
000646 D364 CD0FE0          17      CALL    CHKWILD
000649 D367 3814            12      JR  C,COPY9
                                
00064B D369 3E20             7      LD  A,020H
00064D D36B 325D00          13      LD  (FCB1FN),A
000650 D36E 2A9CEB          16      LD  HL,(DTA_CCP+26)
000653 D371 23               6      INC HL
000654 D372 226A00          16      LD  (FCB1+14),HL
000657 D375 18D5            12      JR  COPY0
                                
       D377                     COPY8:
000659 D377 CD7FD4          17      CALL    _SYS09      ;(BDOS)文字列出力
00065C D37A CD5BD2          17      CALL    LTNL
       D37D                     COPY9:
00065F D37D CDC2D0          17      CALL    OPEN2
000662 D380 18D4            12      JR  COPY1
                                
       D382                     COPY1A:
000664 D382 216C00          10      LD  HL,FCB2
000667 D385 1114F0          10      LD  DE,FDRV
00066A D388 0184EB          10      LD  BC,DTA_CCP+2
00066D D38B EDA0            16      LDI
00066F D38D 3E0B             7      LD  A,11
       D38F                     COPY2:
000671 D38F F5              11      PUSH    AF
000672 D390 7E               7      LD  A,(HL)
000673 D391 FE3F             7      CP  '?'
000675 D393 2001            12      JR  NZ,COPY3
000677 D395 0A               7      LD  A,(BC)
       D396                     COPY3:
000678 D396 12               7      LD  (DE),A
000679 D397 03               6      INC BC
00067A D398 13               6      INC DE
00067B D399 23               6      INC HL
00067C D39A F1              10      POP AF
00067D D39B 3D               4      DEC A
00067E D39C 20F1            12      JR  NZ,COPY2
000680 D39E 010500          10      LD  BC,16-11
000683 D3A1 EDB0                    LDIR
       D3A3                     PUTNAME:
000685 D3A3 215D00          10      LD  HL,FCB1FN
000688 D3A6 CD0FE0          17      CALL    CHKWILD
00068B D3A9 300B            12      JR  NC,PUTN1
00068D D3AB 2115F0          10      LD  HL,FDRV+1
000690 D3AE CDD5D2          17      CALL    FPRNT
000693 D3B1 3E20             7      LD  A,020H
000695 D3B3 CD7ED7          17      CALL    MSG_A
       D3B6                     PUTN1:
000698 D3B6 1114F0          10      LD  DE,FDRV
00069B D3B9 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
00069D D3BB CDE1D0          17      CALL    SYSTEM0
0006A0 D3BE 2048            12      JR  NZ,COPYE2
0006A2 D3C0 67               4      LD  H,A     ;A=0
0006A3 D3C1 6F               4      LD  L,A
0006A4 D3C2 2235F0          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0006A7 D3C5 2237F0          16      LD  (FDRV+35),HL
       D3C8                     COPY6:
0006AA D3C8 CDEAD0          17      CALL    S27BUF
0006AD D3CB 47               4      LD  B,A
0006AE D3CC 3C               4      INC A
0006AF D3CD 2831            12      JR  Z,COPYE
0006B1 D3CF 7C               4      LD  A,H
0006B2 D3D0 B5               4      OR  L
0006B3 D3D1 280C            12      JR  Z,COPY7
0006B5 D3D3 1114F0          10      LD  DE,FDRV
0006B8 D3D6 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0006BA D3D8 CDE1D0          17      CALL    SYSTEM0
0006BD D3DB 2023            12      JR  NZ,COPYE
0006BF D3DD 10E9            13      DJNZ    COPY6
       D3DF                     COPY7:
0006C1 D3DF 3A8FEB          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0006C4 D3E2 3221F0          13      LD  (FDRV+13),A
0006C7 D3E5 2196EB          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
0006CA D3E8 1128F0          10      LD  DE,FDRV+20
0006CD D3EB 010400          10      LD  BC,4
0006D0 D3EE EDB0                    LDIR
                                
0006D2 D3F0 1114F0          10      LD  DE,FDRV
0006D5 D3F3 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
0006D7 D3F5 CDE1D0          17      CALL    SYSTEM0
0006DA D3F8 2006            12      JR  NZ,COPYE
                                
0006DC D3FA 1171F0          10      LD  DE,OK
0006DF D3FD C377D3          10      JP  COPY8
                                
       D400                     COPYE:
0006E2 D400 1114F0          10      LD  DE,FDRV
0006E5 D403 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
0006E7 D405 CD0500          17      CALL    SYSTEM
       D408                     COPYE2:
0006EA D408 37               4      SCF
0006EB D409 C9              10      RET
                                
       D40A                     CWILD:
0006EC D40A 215D00          10      LD  HL,FCB1FN
       D40D                     CWILD1:
0006EF D40D 7E               7      LD  A,(HL)
0006F0 D40E FE20             7      CP  020H
0006F2 D410 C0              11      RET NZ
       D411                     CWILD2:
0006F3 D411 3E3F             7      LD  A,'?'
0006F5 D413 060B             7      LD  B,11
0006F7 D415 C37FDC          10      JP  FILL_MEMORY
                                
       D418                     COMTB:
0006FA D418 44202020                DB  "D   "  ;1
0006FE D41C C9D1                    DW  C_DIR
000700 D41E 44495220                DB  "DIR "  ;2
000704 D422 C9D1                    DW  C_DIR
000706 D424 434F5059                DB  "COPY"  ;3
00070A D428 32D3                    DW  C_COPY
00070C D42A 43442020                DB  "CD  "  ;4
000710 D42E E6D0                    DW  C_CD
000712 D430 44454C20                DB  "DEL "  ;5
000716 D434 ACD1                    DW  C_DEL
000718 D436 50415448                DB  "PATH"  ;6
00071C D43A 60D2                    DW  C_PATH
00071E D43C 52454E20                DB  "REN "  ;7
000722 D440 B6D1                    DW  C_REN
000724 D442 52454D20                DB  "REM "  ;8
000728 D446 7CD4                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP2.ASM"
                                
                                ;   LSX-Dodgers CCP2
                                ;   MZ-700/1500
                                
00072A D448 4D4F4E20                DB  "MON "  ;9
00072E D44C B9DB                    DW  C_MON
[EOF:M7CCP2.ASM:UTF_8]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D44E                     BDOS0:
000730 D44E E5              11      PUSH    HL
000731 D44F 79               4      LD  A,C
000732 D450 FE3C             7      CP  03CH
000734 D452 3802            12      JR  C,DOS1
000736 D454 3E3C             7      LD  A,03CH
       D456                     DOS1:
000738 D456 87               4      ADD A,A
000739 D457 325BD4          13      LD  (DOS1_SWC),A
00073C D45A 2A00F1          16      LD  HL,(STABLE)
       D45B                     DOS1_SWC    EQU $-2
00073F D45D E3              19      EX  (SP),HL
000740 D45E 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
000741 D45F C9              10      RET
       D460                     _DOS2:
000742 D460 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000744 D462 CAFAD6          10      JP  Z,_SYS5A
000747 D465 FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000749 D467 CAB7D6          10      JP  Z,_SYS5C
00074C D46A FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
00074E D46C CA0AE9          10      JP  Z,_SYS5F
000751 D46F FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000753 D471 200A            12      JR  NZ,_ERROR
000755 D473 011D01          10      LD  BC,VER_6F
000758 D476 116101          10      LD  DE,VER
00075B D479 210100          10      LD  HL,MACD
       D47C                     C_REM:
00075E D47C AF               4      XOR A
       D47D                     _ERROR:
00075F D47D A7               4      AND A
000760 D47E C9              10      RET
                                
       D47F                     _SYS09:     ;文字列出力
000761 D47F D5              11      PUSH    DE
       D480                     _SX09:
000762 D480 1A               7      LD  A,(DE)
000763 D481 13               6      INC DE
000764 D482 FE24             7      CP  '$'
000766 D484 2831            12      JR  Z,SX0E2
000768 D486 CD7ED7          17      CALL    MSG_A
00076B D489 18F5            12      JR  _SX09
                                
       D48B                     MSX1:
00076D D48B CD7ED7          17      CALL    MSG_A
       D48E                     MSX:
000770 D48E 7E               7      LD  A,(HL)
000771 D48F 23               6      INC HL
000772 D490 B7               4      OR  A
000773 D491 20F8            12      JR  NZ,MSX1
000775 D493 C9              10      RET
                                
       D494                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000776 D494 212200          10      LD  HL,00022H
000779 D497 7D               4      LD  A,L
00077A D498 C9              10      RET
                                
       D499                     _SYS0D:     ;(BDOS)ディスクリセット
00077B D499 CDDFF0          17      CALL    _FFLUSH
00077E D49C E5              11      PUSH    HL
00077F D49D 218000          10      LD  HL,00080H
000782 D4A0 228AF0          16      LD  (_DTA),HL
000785 D4A3 E1              10      POP HL
000786 D4A4 D5              11      PUSH    DE
000787 D4A5 1E00             7      LD  E,0
000789 D4A7 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D4A8                     _SYS0E:     ;(BDOS)カレントドライブの設定
00078A D4A8 D5              11      PUSH    DE
00078B D4A9 7B               4      LD  A,E
00078C D4AA DDE5            15      PUSH    IX
00078E D4AC CDDCF0          17      CALL    _GETDPB
000791 D4AF DDE1            14      POP IX
000793 D4B1 3804            12      JR  C,SX0E2
000795 D4B3 7B               4      LD  A,E
000796 D4B4 320400          13      LD  (_DVSW),A
       D4B7                     SX0E2:
000799 D4B7 D1              10      POP DE
00079A D4B8 C9              10      RET
                                
       D4B9                     _SYS0F:     ;(BDOS)ファイルのオープン
00079B D4B9 CDBCDC          17      CALL    SETDRV
00079E D4BC FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0007A1 D4BF C602             7      ADD A,002H      ;Write
0007A3 D4C1 2848            12      JR  Z,FEND0F
0007A5 D4C3 CD0BE0          17      CALL    CHKWILDX
                                
0007A8 D4C6 D4E6DC          17      CALL    NC,SOPENX
       D4C9                     _S16XX:
0007AB D4C9 3840            12      JR  C,FEND0F
                                                ;Directory location
0007AD D4CB 3A9FF0          13      LD  A,(_FILEN)
0007B0 D4CE FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
0007B3 D4D1 3AA0F0          13      LD  A,(_DIRF)
0007B6 D4D4 FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
0007B9 D4D7 FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
0007BC D4DA FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
0007BF D4DD FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
0007C3 D4E1 FDE5            15      PUSH    IY
0007C5 D4E3 D1              10      POP DE
0007C6 D4E4 13               6      INC DE
0007C7 D4E5 010B00          10      LD  BC,11
0007CA D4E8 EDB0                    LDIR
                                ;               Attribute
0007CC D4EA 7E               7      LD  A,(HL)
0007CD D4EB FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
0007D0 D4EE 110B00          10      LD  DE,11       ;Reserved
0007D3 D4F1 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
0007D4 D4F2 11E4F1          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
0007D7 D4F5 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D4F7                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
0007D9 D4F7 1A               7      LD  A,(DE)
0007DA D4F8 13               6      INC DE
0007DB D4F9 3200D5          13      LD  (S16PAT),A
0007DE D4FC 7E               7      LD  A,(HL)
0007DF D4FD 23               6      INC HL
0007E0 D4FE FD7700          19      LD  (IY+0),A
       D500                     S16PAT  EQU $-1
0007E3 D501 10F4            13      DJNZ    S16LOOP
                                
0007E5 D503 AF               4      XOR A
0007E6 D504 FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
0007E9 D507 FD22A8D5        20      LD  (OFCB_SWC),IY
       D50B                     FEND0F:
0007ED D50B 1845            12      JR  FEND10
                                
       D50D                     _SYS10:     ;(BDOS)ファイルのクローズ
0007EF D50D CDBCDC          17      CALL    SETDRV
0007F2 D510 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0007F5 D513 D6FE             7      SUB 0FEH
0007F7 D515 37               4      SCF
0007F8 D516 3F               4      CCF
0007F9 D517 2039            12      JR  NZ,FEND10
       D519                     _S10A:              ;Write
0007FB D519 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
0007FE D51C FD770F          19      LD  (IY+15),A
                                
000801 D51F FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
000804 D522 CD07E1          17      CALL    SETTMS
                                
000807 D525 FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
00080A D528 32A0F0          13      LD  (_DIRF),A
00080D D52B E67F             7      AND 07FH
00080F D52D 322CE6          13      LD  (_SECPS),A
000812 D530 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000815 D533 FD561F          19      LD  D,(IY+31)
000818 D536 CD1ADE          17      CALL    READ_DIR
00081B D539 3817            12      JR  C,FEND10
                                
00081D D53B 3A46DD          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000820 D53E 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000821 D53F FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000824 D542 6F               4      LD  L,A
000825 D543 2600             7      LD  H,0
000827 D545 29              11      ADD HL,HL       ;*2
000828 D546 29              11      ADD HL,HL       ;*4
000829 D547 29              11      ADD HL,HL       ;*8
00082A D548 29              11      ADD HL,HL       ;*16
00082B D549 29              11      ADD HL,HL       ;*32
00082C D54A ED4B7EF1        20      LD  BC,(_DTBUF)
000830 D54E 09              11      ADD HL,BC
                                
000831 D54F CD1BE0          17      CALL    SDIRENT
       D552                     FEND10:
000834 D552 1842            12      JR  FEND
                                
       D554                     _SYS11:     ;(BDOS)最初のファイルの検索
000836 D554 CDBCDC          17      CALL    SETDRV
000839 D557 CD15DD          17      CALL    SOPEN
       D55A                     _S12X1:
00083C D55A 383A            12      JR  C,FEND
00083E D55C CDB4DD          17      CALL    SOPENE2
000841 D55F ED5B8AF0        20      LD  DE,(_DTA)
000845 D563 3A88F0          13      LD  A,(_DRV)
000848 D566 3C               4      INC A
000849 D567 12               7      LD  (DE),A
00084A D568 D5              11      PUSH    DE
00084B D569 13               6      INC DE
00084C D56A 012000          10      LD  BC,32
00084F D56D EDB0                    LDIR
000851 D56F FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000854 D572 FD660F          19      LD  H,(IY+15)
000857 D575 22F4F1          16      LD  (SCDIR),HL
00085A D578 2A9AF0          16      LD  HL,(_FBPS)
00085D D57B 22F6F1          16      LD  (SFBPS),HL
000860 D57E 2A9FF0          16      LD  HL,(_FILEN)
000863 D581 7C               4      LD  A,H
000864 D582 B7               4      OR  A
000865 D583 2806            12      JR  Z,_S12DIR
000867 D585 3A2CE6          13      LD  A,(_SECPS)
00086A D588 F680             7      OR  080H
00086C D58A 67               4      LD  H,A
       D58B                     _S12DIR:
00086D D58B 22F8F1          16      LD  (SFNDF),HL  ;Directory position and Flags
000870 D58E E1              10      POP HL
000871 D58F 1139F0          10      LD  DE,SFILE
000874 D592 0E21             7      LD  C,33
       D594                     _S11B:
000876 D594 EDB0                    LDIR
       D596                     FEND:
000878 D596 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D597                     FENDE:
000879 D597 FDE1            14      POP IY
00087B D599 C1              10      POP BC
00087C D59A D1              10      POP DE
00087D D59B E1              10      POP HL
00087E D59C C9              10      RET
                                
       D59D                     _SYS12:     ;(BDOS)次のファイルの検索
00087F D59D E5              11      PUSH    HL
000880 D59E D5              11      PUSH    DE
000881 D59F C5              11      PUSH    BC
000882 D5A0 FDE5            15      PUSH    IY
000884 D5A2 CD79DD          17      CALL    NOPEN
000887 D5A5 18B3            12      JR  _S12X1
                                
       D5A7                     _S16K:
000889 D5A7 110000          10      LD  DE,0
       D5A8                     OFCB_SWC    EQU $-2
00088C D5AA D5              11      PUSH    DE
00088D D5AB 061A             7      LD  B,26        ;First cluster
       D5AD                     S16K1:
00088F D5AD 13               6      INC DE
000890 D5AE 23               6      INC HL
000891 D5AF 10FC            13      DJNZ    S16K1
                                
000893 D5B1 1A               7      LD  A,(DE)
000894 D5B2 BE               7      CP  (HL)
000895 D5B3 2015            12      JR  NZ,S16K2
000897 D5B5 13               6      INC DE
000898 D5B6 23               6      INC HL
000899 D5B7 1A               7      LD  A,(DE)
00089A D5B8 BE               7      CP  (HL)
00089B D5B9 200F            12      JR  NZ,S16K2
                                
00089D D5BB E1              10      POP HL
00089E D5BC FDE5            15      PUSH    IY
0008A0 D5BE D1              10      POP DE
0008A1 D5BF 7E               7      LD  A,(HL)
0008A2 D5C0 CDD1DC          17      CALL    IS_SAME_DRV_A_DE
0008A5 D5C3 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
0008A7 D5C5 ED52            15      SBC HL,DE       ;CP HL,DE
0008A9 D5C7 37               4      SCF
0008AA D5C8 C0              11      RET NZ
0008AB D5C9 E5              11      PUSH    HL
       D5CA                     S16K2:
0008AC D5CA E1              10      POP HL
       D5CB                     S16K3:
0008AD D5CB FDE5            15      PUSH    IY
0008AF D5CD D1              10      POP DE
       D5CE                     _SYS13:     ;(BDOS)ファイルの削除
0008B0 D5CE CDBCDC          17      CALL    SETDRV
0008B3 D5D1 CD43DF          17      CALL    KILL
       D5D4                     FEND13:
0008B6 D5D4 18C0            12      JR  FEND
                                
       D5D6                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0008B8 D5D6 CDBCDC          17      CALL    SETDRV
0008BB D5D9 CD7FE4          17      CALL    INIT_SEQ
       D5DC                     SREAD:
0008BE D5DC CD51E4          17      CALL    RB_READ
                                
0008C1 D5DF C601             7      ADD A,001H
0008C3 D5E1 38B3            12      JR  C,FEND
                                
0008C5 D5E3 7D               4      LD  A,L
0008C6 D5E4 D601             7      SUB 001H
       D5E6                     FENDX:
0008C8 D5E6 9F               4      SBC A,A
0008C9 D5E7 E603             7      AND 3
0008CB D5E9 1F               4      RRA
0008CC D5EA 18AB            12      JR  FENDE
                                
       D5EC                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
0008CE D5EC CDBCDC          17      CALL    SETDRV
0008D1 D5EF CD7FE4          17      CALL    INIT_SEQ
       D5F2                     SWRITE:
0008D4 D5F2 CD4CE4          17      CALL    RB_WRITE
                                
0008D7 D5F5 C6FF             7      ADD A,0FFH
0008D9 D5F7 18ED            12      JR  FENDX
                                
       D5F9                     _SYS17:     ;(BDOS)ファイル名の変更
0008DB D5F9 CDBCDC          17      CALL    SETDRV
0008DE D5FC CD99DF          17      CALL    NAME
0008E1 D5FF 18D3            12      JR  FEND13
                                
       D601                     _SYS16:     ;(BDOS)ファイルの作成
0008E3 D601 CDBCDC          17      CALL    SETDRV
                                
0008E6 D604 CD0BE0          17      CALL    CHKWILDX
0008E9 D607 38CB            12      JR  C,FEND13
0008EB D609 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
0008EE D60C FE05             7      CP  5
0008F0 D60E 2805            12      JR  Z,_S16X2
0008F2 D610 FE21             7      CP  021H
0008F4 D612 DAD4D5          10      JP  C,FEND13
       D615                     _S16X2:
                                ;               Clear FCB
0008F7 D615 FDE5            15      PUSH    IY
0008F9 D617 E1              10      POP HL
0008FA D618 011000          10      LD  BC,16
0008FD D61B 09              11      ADD HL,BC
       D61C                     _S16X1:
0008FE D61C 70               7      LD  (HL),B      ;B=0
0008FF D61D 23               6      INC HL
000900 D61E 0D               4      DEC C
000901 D61F 20FB            12      JR  NZ,_S16X1
                                
000903 D621 CD0CE1          17      CALL    SETTMSX
000906 D624 FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
00090A D628 CDE6DC          17      CALL    SOPENX
00090D D62B 3F               4      CCF
00090E D62C CCA7D5          17      CALL    Z,_S16K
000911 D62F D4C5DD          17      CALL    NC,COPEN
000914 D632 D41BE0          17      CALL    NC,SDIRENT
000917 D635 C3C9D4          10      JP  _S16XX
                                
       D638                     _SYS21:     ;(BDOS)ランダムな読み出し
00091A D638 CDBCDC          17      CALL    SETDRV
00091D D63B CD57E1          17      CALL    INIT_RND
000920 D63E 189C            12      JR  SREAD
                                
       D640                     _SYS22:     ;(BDOS)ランダムな書き込み
       D640                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000922 D640 CDBCDC          17      CALL    SETDRV
000925 D643 CD57E1          17      CALL    INIT_RND
000928 D646 18AA            12      JR  SWRITE
                                
       D648                     _SYS18:     ;(BDOS)ログインベクトルの獲得
00092A D648 21FF00          10      LD  HL,000FFH
00092D D64B AF               4      XOR A
00092E D64C C9              10      RET
                                
       D64D                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
00092F D64D 3A0400          13      LD  A,(_DVSW)   ;from LDOS
000932 D650 A7               4      AND A
000933 D651 C9              10      RET
                                
       D652                     _SYS1A:     ;(BDOS)DTAの設定
000934 D652 ED538AF0        20      LD  (_DTA),DE
000938 D656 AF               4      XOR A
000939 D657 C9              10      RET
                                
       D658                     _SYS1B:     ;(BDOS)ディスク情報の獲得
00093A D658 7B               4      LD  A,E
00093B D659 CDCADC          17      CALL    GETDRV
00093E D65C CDDCF0          17      CALL    _GETDPB
000941 D65F D4E2F0          17      CALL    NC,_RDFATX
000944 D662 210000          10      LD  HL,0
000947 D665 D4E5E0          17      CALL    NC,DSKF
                                
00094A D668 ED5BE6E0        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
00094E D66C 1B               6      DEC DE      ;DE←クラスタの総数
00094F D66D FD2A7CF1        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000953 D671 9F               4      SBC A,A
000954 D672 D8              11      RET C
000955 D673 4F               4      LD  C,A     ;C=0
000956 D674 DD7E0F          19      LD  A,(IX+DPB_BPS)
000959 D677 E607             7      AND 7
00095B D679 47               4      LD  B,A
00095C D67A DD7E07          19      LD  A,(IX+DPB_SECPCL)
00095F D67D C9              10      RET
                                
       D67E                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000960 D67E AF               4      XOR A
000961 D67F 67               4      LD  H,A
000962 D680 6F               4      LD  L,A
000963 D681 C9              10      RET
                                
       D682                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000964 D682 2100F2          10      LD  HL,_DEVICE
000967 D685 7B               4      LD  A,E
000968 D686 C3DCF0          10      JP  _GETDPB
                                
       D689                     _SYS23:     ;(BDOS)ファイルサイズの獲得
00096B D689 E5              11      PUSH    HL
00096C D68A 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
00096E D68C CD4ED4          17      CALL    BDOS0
000971 D68F 381B            12      JR  C,_S23X1
                                
000973 D691 D5              11      PUSH    DE      ;EX DE,IY
000974 D692 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000976 D694 FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000979 D697 FD6E11          19      LD  L,(IY+17)   ;
00097C D69A FD6612          19      LD  H,(IY+18)   ;
00097F D69D C5              11      PUSH    BC      ;
000980 D69E FD4613          19      LD  B,(IY+19)   ;
000983 D6A1 CD49E1          17      CALL    GET_CPM_R_SIZE
000986 D6A4 C1              10      POP BC
       D6A5                     _S24X1:
000987 D6A5 CD69E1          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
00098A D6A8 FDE3            23      EX  (SP),IY     ;
00098C D6AA D1              10      POP DE      ;
                                
00098D D6AB AF               4      XOR A
       D6AC                     _S23X1:
00098E D6AC E1              10      POP HL
00098F D6AD C9              10      RET
                                
       D6AE                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000990 D6AE E5              11      PUSH    HL
000991 D6AF D5              11      PUSH    DE      ;EX DE,IY
000992 D6B0 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000994 D6B2 CD87E4          17      CALL    GETSEQ
000997 D6B5 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D6B7                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000999 D6B7 2B               6      DEC HL
       D6B8                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
00099A D6B8 C5              11      PUSH    BC
00099B D6B9 E5              11      PUSH    HL
00099C D6BA CDD4DB          17      CALL    FILE
00099F D6BD E1              10      POP HL
0009A0 D6BE C1              10      POP BC
       D6BF                     S29X1:
0009A1 D6BF C5              11      PUSH    BC
0009A2 D6C0 D5              11      PUSH    DE
0009A3 D6C1 E5              11      PUSH    HL
0009A4 D6C2 EB               4      EX  DE,HL
0009A5 D6C3 AF               4      XOR A
0009A6 D6C4 3221F0          13      LD  (FDRV+13),A
0009A9 D6C7 2114F0          10      LD  HL,FDRV
0009AC D6CA 011000          10      LD  BC,16
0009AF D6CD EDB0                    LDIR
0009B1 D6CF E1              10      POP HL
0009B2 D6D0 D1              10      POP DE
0009B3 D6D1 C1              10      POP BC
0009B4 D6D2 C9              10      RET
                                
       D6D3                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
0009B5 D6D3 C5              11      PUSH    BC
0009B6 D6D4 01CBE7          10      LD  BC,DWT24B
0009B9 D6D7 1804            12      JR  S2FX
       D6D9                     _SYS2F:
0009BB D6D9 C5              11      PUSH    BC
0009BC D6DA 01BDE7          10      LD  BC,DRD24B
       D6DD                     S2FX:
0009BF D6DD ED43F3D6        20      LD  (S2F_SWC),BC
0009C3 D6E1 CDDFF0          17      CALL    _FFLUSH
                                
0009C6 D6E4 D5              11      PUSH    DE
0009C7 D6E5 E5              11      PUSH    HL
0009C8 D6E6 7D               4      LD  A,L     ;Drive
0009C9 D6E7 CDD9F0          17      CALL    _CHGDRV
0009CC D6EA 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
0009CE D6EC 44               4      LD  B,H     ;Number of clusters
0009CF D6ED 2A8AF0          16      LD  HL,(_DTA)
                                
0009D2 D6F0 0E00             7      LD  C,0
0009D4 D6F2 CDBDE7          17      CALL    DRD24B
       D6F3                     S2F_SWC EQU $-2
       D6F5                     POP_HL_DE_BC_SBCAA_RET:
0009D7 D6F5 E1              10      POP HL
0009D8 D6F6 D1              10      POP DE
0009D9 D6F7 C1              10      POP BC
0009DA D6F8 9F               4      SBC A,A
0009DB D6F9 C9              10      RET
                                
       D6FA                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
0009DC D6FA C5              11      PUSH    BC
0009DD D6FB D5              11      PUSH    DE
0009DE D6FC E5              11      PUSH    HL
0009DF D6FD CDC9DB          17      CALL    FILEC
0009E2 D700 21F5D6          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
0009E5 D703 E5              11      PUSH    HL
0009E6 D704 3A21F0          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
0009E9 D707 E610             7      AND 010H        ;ディレクトリ
0009EB D709 37               4      SCF
0009EC D70A C8              11      RET Z
0009ED D70B 1114F0          10      LD  DE,FDRV
0009F0 D70E 2A4EF1          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       D711                     JPHL:
0009F3 D711 E9               4      JP  (HL)
                                
       D712                     SHOW_ERROR:         ;(9)
0009F4 D712 1179F0          10      LD  DE,COMERM
0009F7 D715 CD7FD4          17      CALL    _SYS09      ;(BDOS)文字列出力
0009FA D718 C300F0          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "M7IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                
       D47D                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D47D                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D47D                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D47D                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D47D                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D47D                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
                                #IF EXISTS USE_8253
       D71B                     ARWKEY:
0009FD D71B 3D               4      DEC A
0009FE D71C 3237D7          13      LD  (KEYAR),A
000A01 D71F 1826            12      JR  INT8253E
       D721                     SETKEY1:
000A03 D721 3A95F0          13      LD  A,(_KEYSP_H)
000A06 D724 1815            12      JR  SETKEY
       D726                     INT8253:
000A08 D726 CD32DB          17      CALL    CHKEY
000A0B D729 FE00             7      CP  0
       D72A                     KEYDT   EQU $-1
000A0D D72B 20F4            12      JR  NZ,SETKEY1
000A0F D72D E5              11      PUSH    HL
000A10 D72E 2A90F0          16      LD  HL,(_KEYPS)
000A13 D731 7C               4      LD  A,H
000A14 D732 AD               4      XOR L
000A15 D733 E1              10      POP HL
000A16 D734 2011            12      JR  NZ,INT8253E
000A18 D736 3E00             7      LD  A,0
       D737                     KEYAR   EQU $-1
000A1A D738 B7               4      OR  A
000A1B D739 20E0            12      JR  NZ,ARWKEY
       D73B                     SETKEY:
000A1D D73B 3237D7          13      LD  (KEYAR),A
000A20 D73E CD0CDB          17      CALL    GETKEYD
000A23 D741 322AD7          13      LD  (KEYDT),A
000A26 D744 CD51D7          17      CALL    KEYSET
       D747                     INT8253E:
000A29 D747 3E00             7      LD  A,0
       D748                     INTMEM_SWC  EQU $-1
000A2B D749 FEC9             7      CP  0C9H        ;RAMの場合はEXTBIOにRETが入っている
000A2D D74B C225CF          10      JP  NZ,ROM8253E
000A30 D74E F1              10      POP AF
000A31 D74F FB               4      EI
000A32 D750 C9              10      RET
       D751                     KEYSET:
       D751                     KEYBS:
000A33 D751 B7               4      OR  A
000A34 D752 C8              11      RET Z
       D753                     KEYBS1:
000A35 D753 CD6BD7          17      CALL    KEYBC_IFBREAK
000A38 D756 E5              11      PUSH    HL
000A39 D757 F5              11      PUSH    AF
000A3A D758 2A90F0          16      LD  HL,(_KEYPS)
000A3D D75B 2C               4      INC L
000A3E D75C CBAD             8      RES 5,L
000A40 D75E 7D               4      LD  A,L
000A41 D75F BC               4      CP  H
000A42 D760 2815            12      JR  Z,POP_AF_HL_SCF_RET
000A44 D762 3290F0          13      LD  (_KEYPS),A
000A47 D765 26F3             7      LD  H,HIGH KEYBF
000A49 D767 F1              10      POP AF
000A4A D768 77               7      LD  (HL),A
000A4B D769 E1              10      POP HL
000A4C D76A C9              10      RET
       D76B                     KEYBC_IFBREAK:
000A4D D76B FE03             7      CP  3
000A4F D76D C0              11      RET NZ
       D76E                     KEYBC:
000A50 D76E E5              11      PUSH    HL
000A51 D76F 210000          10      LD  HL,0
000A54 D772 2290F0          16      LD  (_KEYPS),HL
000A57 D775 E1              10      POP HL
000A58 D776 C9              10      RET
                                #ENDIF
                                
       D777                     POP_AF_HL_SCF_RET:
000A59 D777 F1              10      POP AF
000A5A D778 E1              10      POP HL
000A5B D779 37               4      SCF
                                #IF EXISTS USE_8253
                                #ELSE
                                KEYBC_IFBREAK:
                                #ENDIF
000A5C D77A C9              10      RET
                                
       D77B                     _SYS01:     ;(BDOS)コンソール入力
000A5D D77B CD09F0          17      CALL    _SYS07
       D77E                     MSG_A:
000A60 D77E F5              11      PUSH    AF
000A61 D77F D5              11      PUSH    DE
000A62 D780 5F               4      LD  E,A
000A63 D781 CD87D7          17      CALL    _SYS02
000A66 D784 D1              10      POP DE
000A67 D785 F1              10      POP AF
000A68 D786 C9              10      RET
                                
       D787                     _SYS02:     ;(BDOS)コンソール出力
000A69 D787 CD99D7          17      CALL    BREAK
000A6C D78A 1805            12      JR  PRINTX
                                
       D78C                     _SYS06:     ;(BDOS)コンソール直接入出力
000A6E D78C 7B               4      LD  A,E
000A6F D78D 3C               4      INC A
000A70 D78E CACAF0          10      JP  Z,_INKEY
       D791                     PRINTX:
000A73 D791 C3CDF0          10      JP  _PRINT
                                
       D794                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000A76 D794 CD09F0          17      CALL    _SYS07
000A79 D797 1804            12      JR  BREAK1
       D799                     BREAK:
                                #IF EXISTS USE_8253
000A7B D799 FB               4      EI
000A7C D79A 3A92F0          13      LD  A,(_KEYD)
                                #ELSE
                                    CALL    CHKEY
                                #ENDIF
       D79D                     BREAK1:
000A7F D79D FE03             7      CP  3       ;CTRL+C
000A81 D79F CCF4F0          17      CALL    Z,_BREAK
000A84 D7A2 FE13             7      CP  013H        ;CTRL+S
000A86 D7A4 C0              11      RET NZ
                                
       D7A5                     PAUSE:
                                #IF EXISTS USE_8253
000A87 D7A5 CD6ED7          17      CALL    KEYBC
                                #ENDIF
                                
       D7A8                     FLGET:
000A8A D7A8 CDDFF0          17      CALL    _FFLUSH
000A8D D7AB E5              11      PUSH    HL
000A8E D7AC 2A8EF0          16      LD  HL,(_TXADR)
000A91 D7AF 7C               4      LD  A,H
000A92 D7B0 C6D0             7      ADD A,0D0H
000A94 D7B2 67               4      LD  H,A
000A95 D7B3 CD59CF          17      CALL    RDMMIO
000A98 D7B6 32CBD7          13      LD  (FLSMC),A
       D7B9                     FLGET1:
000A9B D7B9 CD4FCF          17      CALL    RD556VSYNC
000A9E D7BC CB77             8      BIT 6,A
000AA0 D7BE 3EEF             7      LD  A,0EFH      ;カーソル
000AA2 D7C0 280A            12      JR  Z,FLGET2
000AA4 D7C2 CD0CDB          17      CALL    GETKEYD
000AA7 D7C5 B7               4      OR  A
000AA8 D7C6 3EEF             7      LD  A,0EFH      ;カーソル
000AAA D7C8 2002            12      JR  NZ,FLGET2
000AAC D7CA 3E00             7      LD  A,0     ;自己書き換え
       D7CB                     FLSMC   EQU $-1
       D7CC                     FLGET2:
000AAE D7CC CD61CF          17      CALL    WRMMIO
000AB1 D7CF CDCAF0          17      CALL    _INKEY
000AB4 D7D2 28E5            12      JR  Z,FLGET1
000AB6 D7D4 F5              11      PUSH    AF
000AB7 D7D5 3ACBD7          13      LD  A,(FLSMC)
000ABA D7D8 CD61CF          17      CALL    WRMMIO
000ABD D7DB F1              10      POP AF
000ABE D7DC E1              10      POP HL
000ABF D7DD C9              10      RET
                                
       D7DE                     _SYS0A:     ;(BDOS)文字列入力
000AC0 D7DE C5              11      PUSH    BC
000AC1 D7DF E5              11      PUSH    HL
000AC2 D7E0 D5              11      PUSH    DE
000AC3 D7E1 CD7FDA          17      CALL    GETL
000AC6 D7E4 1130FF          10      LD  DE,KBUF
000AC9 D7E7 E1              10      POP HL
000ACA D7E8 E5              11      PUSH    HL
000ACB D7E9 0E00             7      LD  C,0
000ACD D7EB 3004            12      JR  NC,SAX0
000ACF D7ED 23               6      INC HL
000AD0 D7EE 23               6      INC HL
000AD1 D7EF 1808            12      JR  SAX4
       D7F1                     SAX0:
000AD3 D7F1 46               7      LD  B,(HL)
000AD4 D7F2 23               6      INC HL
       D7F3                     SAX1:
000AD5 D7F3 23               6      INC HL
000AD6 D7F4 1A               7      LD  A,(DE)
000AD7 D7F5 13               6      INC DE
000AD8 D7F6 B7               4      OR  A
000AD9 D7F7 2004            12      JR  NZ,SAX2
       D7F9                     SAX4:
000ADB D7F9 360D            10      LD  (HL),00DH
000ADD D7FB 1804            12      JR  SAX3
       D7FD                     SAX2:
000ADF D7FD 77               7      LD  (HL),A
000AE0 D7FE 0C               4      INC C
000AE1 D7FF 10F2            13      DJNZ    SAX1
       D801                     SAX3:
000AE3 D801 D1              10      POP DE
000AE4 D802 79               4      LD  A,C
000AE5 D803 13               6      INC DE
000AE6 D804 12               7      LD  (DE),A
000AE7 D805 1B               6      DEC DE
000AE8 D806 E1              10      POP HL
000AE9 D807 C1              10      POP BC
000AEA D808 A7               4      AND A
000AEB D809 C9              10      RET
                                
       D80A                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000AEC D80A CD99D7          17      CALL    BREAK
000AEF D80D B7               4      OR  A
000AF0 D80E C8              11      RET Z
                                
       D80F                     CONSTX:
000AF1 D80F CDDFF0          17      CALL    _FFLUSH
                                #IF EXISTS USE_8253
000AF4 D812 E5              11      PUSH    HL
000AF5 D813 2A90F0          16      LD  HL,(_KEYPS)
000AF8 D816 7C               4      LD  A,H
000AF9 D817 AD               4      XOR L
000AFA D818 E1              10      POP HL
000AFB D819 C6FF             7      ADD A,0FFH
                                #ELSE
                                    XOR A
                                    LD  (SKIP_KEYWAIT),A
                                    CALL    CHKEY
                                    RET Z
                                    SCF
                                #ENDIF
000AFD D81B 9F               4      SBC A,A
000AFE D81C C9              10      RET
                                
       D81D                     _SYS2A:     ;(BDOS)日付の獲得
       D81D                     _SYS2C:     ;(BDOS)時刻の獲得
000AFF D81D AF               4      XOR A
000B00 D81E 57               4      LD  D,A
000B01 D81F 5F               4      LD  E,A
000B02 D820 67               4      LD  H,A
000B03 D821 6F               4      LD  L,A
000B04 D822 C9              10      RET
                                
       D823                     ESC1:
000B05 D823 7B               4      LD  A,E
000B06 D824 FE41             7      CP  'A'
000B08 D826 CA1BD9          10      JP  Z,CTRL1E
000B0B D829 FE42             7      CP  'B'
000B0D D82B CA42DA          10      JP  Z,CTRL1F
000B10 D82E FE43             7      CP  'C'
000B12 D830 CAEED8          10      JP  Z,CTRL1C
000B15 D833 FE44             7      CP  'D'
000B17 D835 CA12D9          10      JP  Z,CTRL1D
000B1A D838 FE45             7      CP  'E'
000B1C D83A 2802            12      JR  Z,CT0CX
000B1E D83C FE6A             7      CP  'j'
       D83E                     CT0CX:
000B20 D83E CA27DA          10      JP  Z,CTRL0C
000B23 D841 FE48             7      CP  'H'
000B25 D843 CA94D9          10      JP  Z,CTRL0B
000B28 D846 FE4A             7      CP  'J'
000B2A D848 CA2ADA          10      JP  Z,CTRL06
000B2D D84B FE4B             7      CP  'K'
000B2F D84D CA66D9          10      JP  Z,CTRL05
000B32 D850 FE4C             7      CP  'L'
000B34 D852 CA54DA          10      JP  Z,CTRL0E
000B37 D855 FE54             7      CP  'T'
000B39 D857 CA66D9          10      JP  Z,CTRL05
000B3C D85A FE78             7      CP  'x'
000B3E D85C 2804            12      JR  Z,ESC1X
000B40 D85E FE79             7      CP  'y'
000B42 D860 2002            12      JR  NZ,ESC1Y
       D862                     ESC1X:
000B44 D862 3601            10      LD  (HL),1
       D864                     ESC1Y:
000B46 D864 FE3D             7      CP  '='
000B48 D866 2804            12      JR  Z,ESC1W
000B4A D868 FE59             7      CP  'Y'
000B4C D86A 2002            12      JR  NZ,ESC1Z
       D86C                     ESC1W:
000B4E D86C 3602            10      LD  (HL),2
       D86E                     ESC1Z:
000B50 D86E FE20             7      CP  020H
000B52 D870 3802            12      JR  C,ESC1C
000B54 D872 87               4      ADD A,A
000B55 D873 D0              11      RET NC
       D874                     ESC1C:
000B56 D874 E1              10      POP HL
000B57 D875 1832            12      JR  ANK
                                
       D877                     ESC:
000B59 D877 21DAD8          10      LD  HL,PRINTE5
000B5C D87A E5              11      PUSH    HL
000B5D D87B 219DD8          10      LD  HL,ESCFLG
000B60 D87E 3600            10      LD  (HL),0
000B62 D880 3D               4      DEC A
000B63 D881 28A0            12      JR  Z,ESC1
000B65 D883 3D               4      DEC A
000B66 D884 2009            12      JR  NZ,ESC2
000B68 D886 3603            10      LD  (HL),3
000B6A D888 7B               4      LD  A,E
000B6B D889 D620             7      SUB 020H
000B6D D88B 3292D8          13      LD  (ESCYP+1),A
000B70 D88E C9              10      RET
       D88F                     ESC2:
000B71 D88F 3D               4      DEC A
000B72 D890 C0              11      RET NZ
000B73 D891 2600             7  ESCYP:  LD  H,0
000B75 D893 7B               4      LD  A,E
000B76 D894 D620             7      SUB 020H
000B78 D896 6F               4      LD  L,A
000B79 D897 C3D6F0          10      JP  _LOC
                                
       D89A                     PRINT:
000B7C D89A C5              11      PUSH    BC
000B7D D89B E5              11      PUSH    HL
000B7E D89C 3E00             7      LD  A,000H      ;自己書き換え
       D89D                     ESCFLG  EQU $-1
000B80 D89E B7               4      OR  A
000B81 D89F 20D6            12      JR  NZ,ESC
                                
000B83 D8A1 3E1F             7      LD  A,01FH
000B85 D8A3 BB               4      CP  E
000B86 D8A4 3038            12      JR  NC,CTRL
       D8A6                     INSFLG  EQU $
000B88 D8A6 01F0D9          10      LD  BC,INSERT   ;自己書き換え
       D8A9                     ANK:
000B8B D8A9 3A96F0          13      LD  A,(_COLORF)
000B8E D8AC 4F               4      LD  C,A
000B8F D8AD 7B               4      LD  A,E
000B90 D8AE FE61             7      CP  'a'     ;英小文字
000B92 D8B0 3806            12      JR  C,PRT1
000B94 D8B2 FE7B             7      CP  'z'+1
000B96 D8B4 3002            12      JR  NC,PRT1
000B98 D8B6 CBF9             8      SET 7,C
       D8B8                     PRT1:
000B9A D8B8 FE86             7      CP  $86     ;ひらがな1(を－そ)
000B9C D8BA 3806            12      JR  C,PRT2
000B9E D8BC FEA0             7      CP  $A0
000BA0 D8BE 3002            12      JR  NC,PRT2
000BA2 D8C0 CBF9             8      SET 7,C
       D8C2                     PRT2:
000BA4 D8C2 FEE0             7      CP  $E0     ;ひらがな2(たーん)
000BA6 D8C4 3802            12      JR  C,PRT3
000BA8 D8C6 CBF9             8      SET 7,C
       D8C8                     PRT3:
000BAA D8C8 2A8EF0          16      LD  HL,(_TXADR)
000BAD D8CB 7C               4      LD  A,H
000BAE D8CC C6D0             7      ADD A,0D0H
000BB0 D8CE 67               4      LD  H,A
000BB1 D8CF 42               4      LD  B,D
000BB2 D8D0 16EE             7      LD  D,HIGH CD_TABLE
000BB4 D8D2 1A               7      LD  A,(DE)
000BB5 D8D3 50               4      LD  D,B
000BB6 D8D4 CD79CF          17      CALL    IO_PRINT
000BB9 D8D7 CDEED8          17      CALL    CTRL1C
       D8DA                     PRINTE5:
000BBC D8DA E1              10      POP HL
000BBD D8DB C1              10      POP BC
000BBE D8DC AF               4      XOR A
000BBF D8DD C9              10      RET
                                
       D8DE                     CTRL:
000BC0 D8DE 7B               4      LD  A,E
000BC1 D8DF 87               4      ADD A,A
000BC2 D8E0 F680             7      OR  080H
000BC4 D8E2 6F               4      LD  L,A
000BC5 D8E3 26F1             7      LD  H,HIGH CTRLTB
000BC7 D8E5 7E               7      LD  A,(HL)
000BC8 D8E6 2C               4      INC L
000BC9 D8E7 66               7      LD  H,(HL)
000BCA D8E8 6F               4      LD  L,A
000BCB D8E9 CD11D7          17      CALL    JPHL
000BCE D8EC 18EC            12      JR  PRINTE5
                                
       D8EE                     CTRL1C:
000BD0 D8EE ED4B8EF0        20      LD  BC,(_TXADR)
000BD4 D8F2 03               6      INC BC
       D8F3                     PRINTE3:
000BD5 D8F3 2ABAF0          16      LD  HL,(_PAGE_MINUS)
000BD8 D8F6 A7               4      AND A
000BD9 D8F7 ED4A            15      ADC HL,BC
       D8F9                     PRINTE8:
000BDB D8F9 2805            12      JR  Z,PRINT2
000BDD D8FB ED438EF0        20      LD  (_TXADR),BC
       D8FF                     CTRL00:
000BE1 D8FF C9              10      RET
                                
       D900                     PRINT2:
000BE2 D900 CD5ADA          17      CALL    SCR
000BE5 D903 21D8FF          10      LD  HL,0-WIDTH
000BE8 D906 09              11      ADD HL,BC
       D907                     SET_TXADR_HL:
000BE9 D907 228EF0          16      LD  (_TXADR),HL
000BEC D90A C9              10      RET
                                
       D90B                     CTRL08:
000BED D90B 3AA6D8          13      LD  A,(INSFLG)
000BF0 D90E FECD             7      CP  0CDH        ;CALL ????
000BF2 D910 2823            12      JR  Z,CTRL02
       D912                     CTRL1D:
000BF4 D912 2A8EF0          16      LD  HL,(_TXADR)
000BF7 D915 7C               4      LD  A,H
000BF8 D916 B5               4      OR  L
000BF9 D917 C8              11      RET Z
000BFA D918 2B               6      DEC HL
000BFB D919 18EC            12      JR  SET_TXADR_HL
                                
       D91B                     CTRL1E:
000BFD D91B ED4B8EF0        20      LD  BC,(_TXADR)
000C01 D91F 21D8FF          10      LD  HL,0-WIDTH
000C04 D922 09              11      ADD HL,BC
000C05 D923 D0              11      RET NC
000C06 D924 18E1            12      JR  SET_TXADR_HL
                                
       D926                     CTRL09:
000C08 D926 ED4B8EF0        20      LD  BC,(_TXADR)
000C0C D92A 79               4      LD  A,C
000C0D D92B E6F8             7      AND 0F8H
000C0F D92D C608             7      ADD A,8
000C11 D92F 4F               4      LD  C,A
000C12 D930 88               4      ADC A,B
000C13 D931 91               4      SUB C
000C14 D932 47               4      LD  B,A
000C15 D933 18BE            12      JR  PRINTE3
                                
       D935                     CTRL02:
000C17 D935 CD12D9          17      CALL    CTRL1D
000C1A D938 C8              11      RET Z
000C1B D939 D5              11      PUSH    DE
000C1C D93A CDD3F0          17      CALL    _POS
000C1F D93D 54               4      LD  D,H
000C20 D93E 3E28             7      LD  A,WIDTH
000C22 D940 95               4      SUB L
000C23 D941 4F               4      LD  C,A
000C24 D942 0D               4      DEC C
000C25 D943 06D0             7      LD  B,0D0H
000C27 D945 2A8EF0          16      LD  HL,(_TXADR)
000C2A D948 09              11      ADD HL,BC
000C2B D949 47               4      LD  B,A
                                
000C2C D94A 3A11DA          13      LD  A,(MULINE)
000C2F D94D BA               4      CP  D
000C30 D94E 2007            12      JR  NZ,C02X1
000C32 D950 112800          10      LD  DE,WIDTH
000C35 D953 19              11      ADD HL,DE
000C36 D954 78               4      LD  A,B
000C37 D955 83               4      ADD A,E
000C38 D956 47               4      LD  B,A
       D957                     C02X1:
000C39 D957 3A96F0          13      LD  A,(_COLORF) ;C:Color
000C3C D95A 4F               4      LD  C,A
000C3D D95B 3E                      DB  03EH        ;LD A,?
000C3E D95C 2B               6      DEC HL
000C3F D95D 32C0CF          13      LD  (IO_INCDEC),A
000C42 D960 AF               4      XOR A       ;A:Text
000C43 D961 CDB3CF          17      CALL    IO_INSBS
000C46 D964 D1              10      POP DE
000C47 D965 C9              10      RET
                                
       D966                     CTRL05:
000C48 D966 CDD3F0          17      CALL    _POS
000C4B D969 3E28             7      LD  A,WIDTH
000C4D D96B 95               4      SUB L
000C4E D96C 47               4      LD  B,A
       D96D                     C08X1:
000C4F D96D 2A8EF0          16      LD  HL,(_TXADR)
000C52 D970 7C               4      LD  A,H
000C53 D971 C6D0             7      ADD A,0D0H
000C55 D973 67               4      LD  H,A
       D974                     CLLINE:
000C56 D974 3A96F0          13      LD  A,(_COLORF)
000C59 D977 4F               4      LD  C,A
000C5A D978 AF               4      XOR A
000C5B D979 C3A3CF          10      JP  IO_CLLINE
                                
       D97C                     CTRL0D:
000C5E D97C CDD3F0          17      CALL    _POS
000C61 D97F 2E00             7      LD  L,0
       D981                     LOC:
000C63 D981 C5              11      PUSH    BC
000C64 D982 E5              11      PUSH    HL
000C65 D983 CDA1D9          17      CALL    LOC1
000C68 D986 228EF0          16      LD  (_TXADR),HL
000C6B D989 E1              10      POP HL
000C6C D98A C1              10      POP BC
000C6D D98B C9              10      RET
                                
       D98C                     CTRL12:
000C6E D98C 21A6D8          10      LD  HL,INSFLG
000C71 D98F 7E               7      LD  A,(HL)
000C72 D990 EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000C74 D992 77               7      LD  (HL),A
000C75 D993 C9              10      RET
                                
       D994                     CTRL0B:
000C76 D994 210000          10      LD  HL,0
000C79 D997 228EF0          16      LD  (_TXADR),HL
000C7C D99A C9              10      RET
                                
       D99B                     CTRL1B:
000C7D D99B 3E01             7      LD  A,1
000C7F D99D 329DD8          13      LD  (ESCFLG),A
000C82 D9A0 C9              10      RET
                                
       D9A1                     LOC1:
000C83 D9A1 D5              11      PUSH    DE
000C84 D9A2 4D               4      LD  C,L
000C85 D9A3 0608             7      LD  B,8
000C87 D9A5 5C               4      LD  E,H
000C88 D9A6 210028          10      LD  HL,WIDTH*256
000C8B D9A9 55               4      LD  D,L ;L=0
       D9AA                     LOC2:
000C8C D9AA 29              11      ADD HL,HL
000C8D D9AB 3001            12      JR  NC,LOC3
000C8F D9AD 19              11      ADD HL,DE
       D9AE                     LOC3:
000C90 D9AE 10FA            13      DJNZ    LOC2
000C92 D9B0 09              11      ADD HL,BC
000C93 D9B1 D1              10      POP DE
000C94 D9B2 C9              10      RET
                                
       D9B3                     CONOUT1:
                                ;   CALL    CURSOR
000C95 D9B3 59               4      LD  E,C
000C96 D9B4 CDCDF0          17      CALL    _PRINT
000C99 D9B7 7B               4      LD  A,E
000C9A D9B8 FE0A             7      CP  00AH
000C9C D9BA 2006            12      JR  NZ,CURSOR
000C9E D9BC CD7CD9          17      CALL    CTRL0D
000CA1 D9BF CD66D9          17      CALL    CTRL05
       D9C2                     CURSOR:
000CA4 D9C2 C9              10      RET
                                
       D9C3                     CTRL07:
000CA5 D9C3 06E0             7      LD  B,0E0H
000CA7 D9C5 2162F0          10      LD  HL,BEEPD+1
       D9C8                     C07X0:
000CAA D9C8 4E               7      LD  C,(HL)
000CAB D9C9 23               6      INC HL
000CAC D9CA 7E               7      LD  A,(HL)
000CAD D9CB 23               6      INC HL
000CAE D9CC CD71CF          17      CALL    WRMMIO_BC
000CB1 D9CF 7D               4      LD  A,L
000CB2 D9D0 FE6C             7      CP  (BEEPD+1+M7BEEPE-M7BEEPD)&255
000CB4 D9D2 20F4            12      JR  NZ,C07X0
000CB6 D9D4 0610             7      LD  B,16
       D9D6                     C07X1:
000CB8 D9D6 CD4FCF          17      CALL    RD556VSYNC
000CBB D9D9 87               4      ADD A,A
000CBC D9DA 30FA            12      JR  NC,C07X1
       D9DC                     C07X2:
000CBE D9DC CD4FCF          17      CALL    RD556VSYNC
000CC1 D9DF 87               4      ADD A,A
000CC2 D9E0 38FA            12      JR  C,C07X2
000CC4 D9E2 10F2            13      DJNZ    C07X1
                                
000CC6 D9E4 AF               4      XOR A
000CC7 D9E5 2108E0          10      LD  HL,0E008H
000CCA D9E8 CD61CF          17      CALL    WRMMIO
000CCD D9EB 2E03             7      LD  L,003H      ;SOUND MASK (MZ-1500)
000CCF D9ED C361CF          10      JP  WRMMIO
                                
       D9F0                     INSERT:
000CD2 D9F0 D5              11      PUSH    DE
000CD3 D9F1 CDD3F0          17      CALL    _POS
000CD6 D9F4 54               4      LD  D,H
000CD7 D9F5 3E28             7      LD  A,WIDTH
000CD9 D9F7 95               4      SUB L
000CDA D9F8 47               4      LD  B,A
000CDB D9F9 2A8EF0          16      LD  HL,(_TXADR)
000CDE D9FC 7C               4      LD  A,H
000CDF D9FD C6D0             7      ADD A,0D0H
000CE1 D9FF 67               4      LD  H,A
000CE2 DA00 3A96F0          13      LD  A,(_COLORF) ;C:Color
000CE5 DA03 4F               4      LD  C,A
000CE6 DA04 3E                      DB  03EH        ;LD A,?
000CE7 DA05 23               6      INC HL
000CE8 DA06 32C0CF          13      LD  (IO_INCDEC),A
000CEB DA09 AF               4      XOR A       ;A:Text
000CEC DA0A CDB3CF          17      CALL    IO_INSBS
000CEF DA0D B7               4      OR  A
000CF0 DA0E 2005            12      JR  NZ,INS1
       DA11                     MULINE  EQU $+1
000CF2 DA10 3EFF             7      LD  A,-1
000CF4 DA12 92               4      SUB D
000CF5 DA13 2010            12      JR  NZ,INS2
       DA15                     INS1:
000CF7 DA15 0628             7      LD  B,WIDTH
000CF9 DA17 F5              11      PUSH    AF
000CFA DA18 3E                      DB  03EH        ;LD A,?
000CFB DA19 23               6      INC HL
000CFC DA1A 32C0CF          13      LD  (IO_INCDEC),A
000CFF DA1D F1              10      POP AF
000D00 DA1E CDB3CF          17      CALL    IO_INSBS
000D03 DA21 7A               4      LD  A,D
000D04 DA22 3211DA          13      LD  (MULINE),A
       DA25                     INS2:
000D07 DA25 D1              10      POP DE
000D08 DA26 C9              10      RET
                                
       DA27                     CTRL0C:
000D09 DA27 CD94D9          17      CALL    CTRL0B
       DA2A                     CTRL06:
000D0C DA2A D5              11      PUSH    DE
000D0D DA2B E5              11      PUSH    HL
000D0E DA2C ED5B8EF0        20      LD  DE,(_TXADR)
000D12 DA30 3A96F0          13      LD  A,(_COLORF)
000D15 DA33 3290CF          13      LD  (ICSMC),A
000D18 DA36 C384CF          10      JP  IO_CLR
                                
       DA39                     CTRL04:
000D1B DA39 CDD3F0          17      CALL    _POS
000D1E DA3C 7D               4      LD  A,L
000D1F DA3D B7               4      OR  A
000D20 DA3E C8              11      RET Z
       DA3F                     CTRL03:
000D21 DA3F CD7CD9          17      CALL    CTRL0D
       DA42                     CTRL0A:
       DA42                     CTRL1F:
000D24 DA42 2A8EF0          16      LD  HL,(_TXADR)
000D27 DA45 012800          10      LD  BC,WIDTH
000D2A DA48 09              11      ADD HL,BC
000D2B DA49 44               4      LD  B,H
000D2C DA4A 4D               4      LD  C,L
000D2D DA4B 2ABAF0          16      LD  HL,(_PAGE_MINUS)
000D30 DA4E 09              11      ADD HL,BC
000D31 DA4F 3F               4      CCF
000D32 DA50 9F               4      SBC A,A
000D33 DA51 C3F9D8          10      JP  PRINTE8
                                
       DA54                     CTRL0E:
000D36 DA54 CDD3F0          17      CALL    _POS
000D39 DA57 7C               4      LD  A,H
000D3A DA58 1804            12      JR  SCR1
       DA5A                     SCR:
000D3C DA5A 3A97F0          13      LD  A,(_LINE)
000D3F DA5D 3D               4      DEC A
       DA5E                     SCR1:
000D40 DA5E C5              11      PUSH    BC
000D41 DA5F D5              11      PUSH    DE
000D42 DA60 E5              11      PUSH    HL
000D43 DA61 1100D0          10      LD  DE,0D000H
000D46 DA64 2128D0          10      LD  HL,0D000H+WIDTH
                                
000D49 DA67 47               4      LD  B,A
000D4A DA68 B7               4      OR  A
000D4B DA69 C3C7CF          10      JP  IO_SCRUP
                                
       DA6C                     POS:
000D4E DA6C 2A8EF0          16      LD  HL,(_TXADR)
000D51 DA6F C5              11      PUSH    BC
000D52 DA70 01D8FF          10      LD  BC,0-WIDTH
000D55 DA73 AF               4      XOR A
       DA74                     POS1:
000D56 DA74 09              11      ADD HL,BC
000D57 DA75 3C               4      INC A
000D58 DA76 38FC            12      JR  C,POS1
000D5A DA78 ED42            15      SBC HL,BC
000D5C DA7A 3D               4      DEC A
000D5D DA7B 67               4      LD  H,A
000D5E DA7C C1              10      POP BC
000D5F DA7D A7               4      AND A
000D60 DA7E C9              10      RET
                                
       DA7F                     GETL:
000D61 DA7F CDD3F0          17      CALL    _POS
000D64 DA82 E5              11      PUSH    HL
000D65 DA83 3ECD             7      LD  A,0CDH      ;CALL ????
000D67 DA85 32A6D8          13      LD  (INSFLG),A
       DA88                     GETL1:
000D6A DA88 CD94D7          17      CALL    _SYS08
000D6D DA8B FE09             7      CP  9
000D6F DA8D 2008            12      JR  NZ,GETL1V
000D71 DA8F 2130FF          10      LD  HL,KBUF
000D74 DA92 CD8ED4          17      CALL    MSX
000D77 DA95 18F1            12      JR  GETL1
       DA97                     GETL1V:
000D79 DA97 5F               4      LD  E,A
000D7A DA98 CDD3F0          17      CALL    _POS
000D7D DA9B CDCDF0          17      CALL    _PRINT
000D80 DA9E 7B               4      LD  A,E
000D81 DA9F FE20             7      CP  $20
000D83 DAA1 3809            12      JR  C,GETL1V1
000D85 DAA3 7D               4      LD  A,L
000D86 DAA4 FE27             7      CP  WIDTH-1
000D88 DAA6 2004            12      JR  NZ,GETL1V1
000D8A DAA8 7C               4      LD  A,H
000D8B DAA9 3211DA          13      LD  (MULINE),A
       DAAC                     GETL1V1:
000D8E DAAC 7B               4      LD  A,E
000D8F DAAD FE0D             7      CP  00DH
000D91 DAAF 20D7            12      JR  NZ,GETL1
000D93 DAB1 3E01             7      LD  A,1     ;LD BC,????
000D95 DAB3 32A6D8          13      LD  (INSFLG),A
000D98 DAB6 1130FF          10      LD  DE,KBUF
000D9B DAB9 0628             7      LD  B,WIDTH
000D9D DABB CD2CD3          17      CALL    ZERO_MEMORY_DE
                                
000DA0 DABE D1              10      POP DE
000DA1 DABF CDD3F0          17      CALL    _POS
000DA4 DAC2 6B               4      LD  L,E
000DA5 DAC3 3E28             7      LD  A,WIDTH
000DA7 DAC5 95               4      SUB L
000DA8 DAC6 57               4      LD  D,A
                                
000DA9 DAC7 3A11DA          13      LD  A,(MULINE)
000DAC DACA 94               4      SUB H
000DAD DACB 280A            12      JR  Z,GL2X
000DAF DACD 3C               4      INC A
000DB0 DACE 2010            12      JR  NZ,GL3X
000DB2 DAD0 7C               4      LD  A,H
000DB3 DAD1 B7               4      OR  A
000DB4 DAD2 280C            12      JR  Z,GL3X
000DB6 DAD4 25               4      DEC H
000DB7 DAD5 1805            12      JR  GL4X
       DAD7                     GL2X:
000DB9 DAD7 3E1F             7      LD  A,$1F
000DBB DAD9 CD7ED7          17      CALL    MSG_A
       DADC                     GL4X:
000DBE DADC 7A               4      LD  A,D
000DBF DADD C628             7      ADD A,WIDTH
000DC1 DADF 57               4      LD  D,A
       DAE0                     GL3X:
000DC2 DAE0 CDA1D9          17      CALL    LOC1
000DC5 DAE3 4D               4      LD  C,L
000DC6 DAE4 7C               4      LD  A,H
000DC7 DAE5 C6D0             7      ADD A,0D0H
000DC9 DAE7 47               4      LD  B,A
000DCA DAE8 5A               4      LD  E,D
000DCB DAE9 2130FF          10      LD  HL,KBUF
       DAEC                     GETL2:
000DCE DAEC CDD0F0          17      CALL    _SCRN
000DD1 DAEF 03               6      INC BC
000DD2 DAF0 77               7      LD  (HL),A
000DD3 DAF1 23               6      INC HL
000DD4 DAF2 1D               4      DEC E
000DD5 DAF3 20F7            12      JR  NZ,GETL2
       DAF5                     GETL3:
000DD7 DAF5 2B               6      DEC HL
000DD8 DAF6 7E               7      LD  A,(HL)
000DD9 DAF7 FE21             7      CP  021H
000DDB DAF9 D0              11      RET NC
000DDC DAFA 3600            10      LD  (HL),0
000DDE DAFC 15               4      DEC D
000DDF DAFD 20F6            12      JR  NZ,GETL3
000DE1 DAFF C9              10      RET
                                
       DB00                     INKEYB:
000DE2 DB00 C1              10      POP BC
000DE3 DB01 CB47             8      BIT 0,A
000DE5 DB03 3E08             7      LD  A,8
000DE7 DB05 2002            12      JR  NZ,SETKEYD
000DE9 DB07 3E03             7      LD  A,3
       DB09                     SETKEYD:
000DEB DB09 3292F0          13      LD  (_KEYD),A
       DB0C                     GETKEYD:
000DEE DB0C 3A92F0          13      LD  A,(_KEYD)
000DF1 DB0F B7               4      OR  A
       DB10                     GETKEYD_SWC:            ;ここがSCFの場合はキーを離すまで戻り値は0になる（自己書き換え）
000DF2 DB10 A7               4      AND A
000DF3 DB11 D0              11      RET NC
000DF4 DB12 2005            12      JR  NZ,GETKEYD1
000DF6 DB14 3E                      DB  03EH
000DF7 DB15 A7               4      AND A
000DF8 DB16 3210DB          13      LD  (GETKEYD_SWC),A
       DB19                     GETKEYD1:
000DFB DB19 AF               4      XOR A
000DFC DB1A C9              10      RET
                                
       DB1B                     INKEY:
                                #IF EXISTS USE_8253
000DFD DB1B FB               4      EI
000DFE DB1C E5              11      PUSH    HL
000DFF DB1D 2A90F0          16      LD  HL,(_KEYPS)
000E02 DB20 7C               4      LD  A,H
000E03 DB21 AD               4      XOR L
000E04 DB22 280B            12      JR  Z,INKEY1
000E06 DB24 7C               4      LD  A,H
000E07 DB25 3C               4      INC A
000E08 DB26 E61F             7      AND 01FH
000E0A DB28 3291F0          13      LD  (_KEYPS+1),A
000E0D DB2B 6F               4      LD  L,A
000E0E DB2C 26F3             7      LD  H,HIGH KEYBF
000E10 DB2E 7E               7      LD  A,(HL)
       DB2F                     INKEY1:
000E11 DB2F E1              10      POP HL
000E12 DB30 B7               4      OR  A
000E13 DB31 C9              10      RET
                                #ELSE
                                    PUSH    HL
                                GETKEY:
                                    CALL    GETKEYD
                                    LD  L,A
                                    LD  H,16
                                GKSMC   EQU $-1
                                GETKEY1:
                                    LD  A,1
                                SKIP_KEYWAIT:   EQU $-1
                                    OR  A
                                    CALL    NZ,CHKEY    ;キーを離すまで待つ
                                    JR  Z,GETKEY2
                                    CP  L
                                    JR  NZ,GETKEY2
                                    CALL    RD556VSYNC
                                    ADD A,A
                                    JR  NC,GETKEY1
                                GETKEY1X:
                                    CALL    CHKEY       ;キーを離すまで待つ
                                    JR  Z,GETKEY2
                                    CP  L
                                    JR  NZ,GETKEY2
                                    CALL    RD556VSYNC
                                    ADD A,A
                                    JR  C,GETKEY1X
                                    DEC H
                                    JR  NZ,GETKEY1
                                    LD  A,1
                                    JR  GETKEY3
                                GETKEY2:
                                    LD  A,16
                                    LD  (SKIP_KEYWAIT),A
                                GETKEY3:
                                    LD  (GKSMC),A
                                    CALL    GETKEYD
                                    POP HL
                                    RET
                                #ENDIF
       DB32                     CHKEY:
000E14 DB32 C5              11      PUSH    BC
000E15 DB33 3E88             7      LD  A,$88
000E17 DB35 CD42CF          17      CALL    RDKEYDATA
000E1A DB38 4F               4      LD  C,A
000E1B DB39 3A93F0          13      LD  A,(_KEYST)
000E1E DB3C B9               4      CP  C
000E1F DB3D 79               4      LD  A,C
000E20 DB3E 3293F0          13      LD  (_KEYST),A
000E23 DB41 280F            12      JR  Z,KEYST2
000E25 DB43 CD0CDB          17      CALL    GETKEYD
000E28 DB46 2809            12      JR  Z,KEYST1
000E2A DB48 AF               4      XOR A
000E2B DB49 3292F0          13      LD  (_KEYD),A
000E2E DB4C 3E                      DB  03EH
000E2F DB4D 37               4      SCF
000E30 DB4E 3210DB          13      LD  (GETKEYD_SWC),A
       DB51                     KEYST1:
000E33 DB51 79               4      LD  A,C
       DB52                     KEYST2:
000E34 DB52 CB7F             8      BIT 7,A
000E36 DB54 28AA            12      JR  Z,INKEYB
000E38 DB56 E5              11      PUSH    HL
000E39 DB57 0E87             7      LD  C,$87
000E3B DB59 2140ED          10      LD  HL,KEY_TABLE
000E3E DB5C CB47             8      BIT 0,A
000E40 DB5E 2003            12      JR  NZ,CHKEY0
000E42 DB60 2180ED          10      LD  HL,SHIFT_TABLE
       DB63                     CHKEY0:
000E45 DB63 CB77             8      BIT 6,A
000E47 DB65 2003            12      JR  NZ,CHKEY1
000E49 DB67 21C0ED          10      LD  HL,CTRL_TABLE
       DB6A                     CHKEY1:
000E4C DB6A 79               4      LD  A,C
000E4D DB6B CD42CF          17      CALL    RDKEYDATA
000E50 DB6E 0608             7      LD  B,8
       DB70                     CHKEY2:
000E52 DB70 87               4      ADD A,A
000E53 DB71 300A            12      JR  NC,CHKEY3
000E55 DB73 23               6      INC HL
000E56 DB74 10FA            13      DJNZ    CHKEY2
000E58 DB76 0D               4      DEC C
000E59 DB77 CB79             8      BIT 7,C
000E5B DB79 20EF            12      JR  NZ,CHKEY1
000E5D DB7B AF               4      XOR A
000E5E DB7C 06                      DB  $06     ;LD B,?? 次の1バイトを飛ばす
       DB7D                     CHKEY3:
000E5F DB7D 7E               7      LD  A,(HL)
000E60 DB7E E1              10      POP HL
000E61 DB7F C1              10      POP BC
000E62 DB80 C309DB          10      JP  SETKEYD
                                
       DB83                     SCRN:
000E65 DB83 E5              11      PUSH    HL
000E66 DB84 CD69CF          17      CALL    RDMMIO_BC
000E69 DB87 6F               4      LD  L,A
000E6A DB88 26EF             7      LD  H,HIGH DC_TABLE
000E6C DB8A 7E               7      LD  A,(HL)
000E6D DB8B FE41             7      CP  'A'     ;英小文字チェック
000E6F DB8D 380E            12      JR  C,SCRN1
000E71 DB8F FE5B             7      CP  'Z'+1
000E73 DB91 DC9FDB          17      CALL    C,SCRNC
000E76 DB94 FEA6             7      CP  $A6     ;ひらがなチェック
000E78 DB96 3805            12      JR  C,SCRN1
000E7A DB98 FEE0             7      CP  $E0
000E7C DB9A DC9FDB          17      CALL    C,SCRNC
       DB9D                     SCRN1:
000E7F DB9D E1              10      POP HL
000E80 DB9E C9              10      RET
                                
       DB9F                     SCRNC:
000E81 DB9F 6F               4      LD  L,A
000E82 DBA0 60               4      LD  H,B
000E83 DBA1 CBD8             8      SET 3,B
000E85 DBA3 CD69CF          17      CALL    RDMMIO_BC
000E88 DBA6 44               4      LD  B,H
000E89 DBA7 CB7F             8      BIT 7,A
000E8B DBA9 7D               4      LD  A,L
000E8C DBAA C8              11      RET Z
000E8D DBAB FE5B             7      CP  'Z'+1
000E8F DBAD 3804            12      JR  C,SCRNC_ADD
000E91 DBAF FEC0             7      CP  $C0
000E93 DBB1 3803            12      JR  C,SCRNC_SUB
       DBB3                     SCRNC_ADD:
000E95 DBB3 C620             7      ADD A,$20
000E97 DBB5 C9              10      RET
       DBB6                     SCRNC_SUB:
000E98 DBB6 D620             7      SUB $20
000E9A DBB8 C9              10      RET
       DBB9                     C_MON:
000E9B DBB9 2100D8          10      LD  HL,0D800H
       DBBC                     MON1:
000E9E DBBC 3E71             7      LD  A,071H
000EA0 DBBE CD61CF          17      CALL    WRMMIO
000EA3 DBC1 23               6      INC HL
000EA4 DBC2 CB54             8      BIT 2,H
000EA6 DBC4 28F6            12      JR  Z,MON1
000EA8 DBC6 C3FBCF          10      JP  IO_MON
[EOF:M7IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       DBC9                     FILEC:
000EAB DBC9 CDD4DB          17      CALL    FILE
       DBCC                     FILEC2:
000EAE DBCC 3A15F0          13      LD  A,(FDRV+1)
000EB1 DBCF FE20             7      CP  020H
000EB3 DBD1 C8              11      RET Z
000EB4 DBD2 1839            12      JR  SETDIR1
                                
       DBD4                     FILE:
000EB6 DBD4 AF               4      XOR A
000EB7 DBD5 3214F0          13      LD  (FDRV),A
000EBA DBD8 67               4      LD  H,A
000EBB DBD9 6F               4      LD  L,A
000EBC DBDA 2222F0          16      LD  (FDRV+14),HL
000EBF DBDD CDAADC          17      CALL    SPCUT
000EC2 DBE0 CD8FDC          17      CALL    CCHK3
000EC5 DBE3 2812            12      JR  Z,DEVI1
000EC7 DBE5 13               6      INC DE
000EC8 DBE6 1A               7      LD  A,(DE)
000EC9 DBE7 1B               6      DEC DE
000ECA DBE8 FE3A             7      CP  ':'
000ECC DBEA 200B            12      JR  NZ,DEVI1
000ECE DBEC 1A               7      LD  A,(DE)      ;DRIVE
000ECF DBED CDF0DE          17      CALL    CAP
000ED2 DBF0 D640             7      SUB '@'
000ED4 DBF2 13               6      INC DE
000ED5 DBF3 13               6      INC DE
000ED6 DBF4 3214F0          13      LD  (FDRV),A
       DBF7                     DEVI1:
000ED9 DBF7 1A               7      LD  A,(DE)
000EDA DBF8 D65C             7      SUB 05CH        ;\
000EDC DBFA 2009            12      JR  NZ,NOROOT
000EDE DBFC 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
000EDF DBFD 222EF0          16      LD  (FDRV+26),HL
000EE2 DC00 2C               4      INC L
000EE3 DC01 2222F0          16      LD  (FDRV+14),HL
000EE6 DC04 13               6      INC DE
       DC05                     NOROOT:
                                
       DC05                     SETDIR:
000EE7 DC05 CD30DC          17      CALL    FILED
000EEA DC08 1A               7      LD  A,(DE)
000EEB DC09 FE5C             7      CP  05CH        ;\
000EED DC0B C0              11      RET NZ
000EEE DC0C 13               6      INC DE
       DC0D                     SETDIR1:
000EEF DC0D 3E10             7      LD  A,010H      ;Directory
000EF1 DC0F 3221F0          13      LD  (FDRV+13),A
000EF4 DC12 D5              11      PUSH    DE
000EF5 DC13 1114F0          10      LD  DE,FDRV
000EF8 DC16 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000EFA DC18 CD4ED4          17      CALL    BDOS0
000EFD DC1B D1              10      POP DE
000EFE DC1C B7               4      OR  A
000EFF DC1D C0              11      RET NZ
                                
000F00 DC1E 3A21F0          13      LD  A,(FDRV+13)
000F03 DC21 E610             7      AND 010H        ;ディレクトリ
000F05 DC23 C8              11      RET Z
                                
000F06 DC24 CD77DC          17      CALL    FILEI
000F09 DC27 2A2EF0          16      LD  HL,(FDRV+26)
000F0C DC2A 23               6      INC HL
000F0D DC2B 2222F0          16      LD  (FDRV+14),HL
000F10 DC2E 18D5            12      JR  SETDIR
                                
       DC30                     FILED:
000F12 DC30 CD77DC          17      CALL    FILEI
000F15 DC33 2115F0          10      LD  HL,FNAME
                                
000F18 DC36 0608             7      LD  B,8
       DC38                     FILE2:
000F1A DC38 CD84DC          17      CALL    CCHKF
000F1D DC3B C8              11      RET Z
000F1E DC3C FE2A             7      CP  '*'
000F20 DC3E 282E            12      JR  Z,FILE9
000F22 DC40 FE2E             7      CP  '.'
000F24 DC42 280C            12      JR  Z,FILE4
000F26 DC44 77               7      LD  (HL),A
000F27 DC45 23               6      INC HL
000F28 DC46 10F0            13      DJNZ    FILE2
                                
       DC48                     FILE3:
000F2A DC48 CD84DC          17      CALL    CCHKF
000F2D DC4B C8              11      RET Z
000F2E DC4C FE2E             7      CP  '.'
000F30 DC4E 20F8            12      JR  NZ,FILE3
                                
       DC50                     FILE4:
000F32 DC50 211DF0          10      LD  HL,FNAME+8
000F35 DC53 0603             7      LD  B,3
                                
       DC55                     FILE4L:
000F37 DC55 CD84DC          17      CALL    CCHKF
000F3A DC58 C8              11      RET Z
000F3B DC59 FE2E             7      CP  '.'
000F3D DC5B 2008            12      JR  NZ,FILE12
000F3F DC5D 3215F0          13      LD  (FNAME),A   ;Parent directory(..)
000F42 DC60 3216F0          13      LD  (FNAME+1),A
000F45 DC63 3E20             7      LD  A,020H
       DC65                     FILE12:
000F47 DC65 FE2A             7      CP  '*'
000F49 DC67 280A            12      JR  Z,FILE10
000F4B DC69 77               7      LD  (HL),A
000F4C DC6A 23               6      INC HL
000F4D DC6B 10E8            13      DJNZ    FILE4L
000F4F DC6D C9              10      RET
                                
       DC6E                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000F50 DC6E CD73DC          17      CALL    FILE10
000F53 DC71 18D5            12      JR  FILE3
                                
       DC73                     FILE10:
000F55 DC73 3E3F             7      LD  A,'?'
000F57 DC75 1808            12      JR  FILL_MEMORY
       DC77                     FILEI:              ;名前＋拡張子をスペースで初期化
000F59 DC77 3E20             7      LD  A,020H
000F5B DC79 01000B          10      LD  BC,11*256   ;C=0にしておく
000F5E DC7C 2115F0          10      LD  HL,FNAME
       DC7F                     FILL_MEMORY:            ;HLからBバイトAで埋める
000F61 DC7F 77               7      LD  (HL),A
000F62 DC80 23               6      INC HL
000F63 DC81 10FC            13      DJNZ    FILL_MEMORY
000F65 DC83 C9              10      RET
                                
       DC84                     CCHKF:
000F66 DC84 1A               7      LD  A,(DE)
000F67 DC85 CD8CDC          17      CALL    CCHK2
000F6A DC88 C8              11      RET Z
000F6B DC89 C3F8DF          10      JP  FKAN
                                
       DC8C                     CCHK2:
000F6E DC8C 0C               4      INC C
000F6F DC8D 0D               4      DEC C
000F70 DC8E C0              11      RET NZ
       DC8F                     CCHK3:              ;ZF=1 で使えない文字
000F71 DC8F FE2B             7      CP  '+'
000F73 DC91 C8              11      RET Z
000F74 DC92 FE2C             7      CP  ','
000F76 DC94 C8              11      RET Z
000F77 DC95 FE2F             7      CP  '/'
000F79 DC97 C8              11      RET Z
000F7A DC98 FE3A             7      CP  ':'
000F7C DC9A C8              11      RET Z
000F7D DC9B FE3B             7      CP  ';'
000F7F DC9D C8              11      RET Z
000F80 DC9E FE3D             7      CP  '='
000F82 DCA0 C8              11      RET Z
000F83 DCA1 FE5C             7      CP  05CH    ;\
000F85 DCA3 C8              11      RET Z
000F86 DCA4 FE20             7      CP  020H
000F88 DCA6 D0              11      RET NC
000F89 DCA7 BF               4      CP  A       ;Z=1
000F8A DCA8 C9              10      RET
                                
       DCA9                     SS1:
000F8B DCA9 13               6      INC DE
       DCAA                     SPCUT:              ;スペースをカット
000F8C DCAA 1A               7      LD  A,(DE)
000F8D DCAB FE20             7      CP  020H
000F8F DCAD 28FA            12      JR  Z,SS1
000F91 DCAF C9              10      RET
                                
       DCB0                     SETDRVF:
000F92 DCB0 1114F0          10      LD  DE,FDRV
       DCB3                     SETDRV0:
000F95 DCB3 CDBCDC          17      CALL    SETDRV
000F98 DCB6 FDE1            14      POP IY
000F9A DCB8 C1              10      POP BC
000F9B DCB9 D1              10      POP DE
000F9C DCBA E1              10      POP HL
000F9D DCBB C9              10      RET
                                
       DCBC                     SETDRV:
000F9E DCBC E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
000F9F DCBD D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
000FA0 DCBE C5              11      PUSH    BC
000FA1 DCBF 1A               7      LD  A,(DE)
000FA2 DCC0 D5              11      PUSH    DE
000FA3 DCC1 FDE3            23      EX  (SP),IY
                                
000FA5 DCC3 CDCADC          17      CALL    GETDRV
000FA8 DCC6 CDD9F0          17      CALL    _CHGDRV
                                
000FAB DCC9 E9               4      JP  (HL)
                                
       DCCA                     GETDRV:
000FAC DCCA CDDDDC          17      CALL    GETDRV1
000FAF DCCD 3288F0          13      LD  (_DRV),A
000FB2 DCD0 C9              10      RET
                                
       DCD1                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
000FB3 DCD1 CDDDDC          17      CALL    GETDRV1
000FB6 DCD4 C5              11      PUSH    BC
000FB7 DCD5 4F               4      LD  C,A
000FB8 DCD6 1A               7      LD  A,(DE)
000FB9 DCD7 CDDDDC          17      CALL    GETDRV1
000FBC DCDA A9               4      XOR C
000FBD DCDB C1              10      POP BC
000FBE DCDC C9              10      RET
       DCDD                     GETDRV1:
000FBF DCDD E67F             7      AND 07FH
000FC1 DCDF D601             7      SUB 001H
000FC3 DCE1 D0              11      RET NC
000FC4 DCE2 3A0400          13      LD  A,(_DVSW)   ;Current Drive
000FC7 DCE5 C9              10      RET
                                
       DCE6                     SOPENX:
000FC8 DCE6 1139F0          10      LD  DE,SFILE
000FCB DCE9 FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
000FCE DCEC CDD1DC          17      CALL    IS_SAME_DRV_A_DE
000FD1 DCEF 2024            12      JR  NZ,SOPEN
000FD3 DCF1 13               6      INC DE
000FD4 DCF2 FDE5            15      PUSH    IY
000FD6 DCF4 E1              10      POP HL
000FD7 DCF5 23               6      INC HL
000FD8 DCF6 CD81DE          17      CALL    CPFILE
000FDB DCF9 201A            12      JR  NZ,SOPEN
                                
000FDD DCFB 2AF4F1          16      LD  HL,(SCDIR)
000FE0 DCFE FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
000FE3 DD01 FD740F          19      LD  (IY+15),H
                                
000FE6 DD04 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
000FE9 DD07 229FF0          16      LD  (_FILEN),HL
                                
000FEC DD0A ED5BF6F1        20      LD  DE,(SFBPS)
000FF0 DD0E 2139F0          10      LD  HL,SFILE
000FF3 DD11 36FF            10      LD  (HL),0FFH
000FF5 DD13 23               6      INC HL
000FF6 DD14 C9              10      RET
       DD15                     SOPEN:
000FF7 DD15 2129DE          10      LD  HL,FILESE
       DD18                     SOPENC:
000FFA DD18 2251DD          16      LD  (OPENPAT),HL
                                
000FFD DD1B CDE2F0          17      CALL    _RDFATX     ;Detect Media
001000 DD1E 3856            12      JR  C,RDDERR
                                
001002 DD20 AF               4      XOR A
001003 DD21 329FF0          13      LD  (_FILEN),A
001006 DD24 CD2DDF          17      CALL    LDDIRX1     ;A=0で呼び出す
001009 DD27 2818            12      JR  Z,SDIRX1
                                
00100B DD29 CD1ADE          17      CALL    READ_DIR    ;Sub Directory
00100E DD2C 3808            12      JR  C,SDIRX0
001010 DD2E 2A7EF1          16      LD  HL,(_DTBUF)
001013 DD31 7E               7      LD  A,(HL)
001014 DD32 FE2E             7      CP  '.'
001016 DD34 280F            12      JR  Z,SOPEN1
       DD36                     SDIRX0:
001018 DD36 AF               4      XOR A
001019 DD37 32A0F0          13      LD  (_DIRF),A
00101C DD3A FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
001020 DD3E FD770F          19      LD  (IY+15),A
       DD41                     SDIRX1:
001023 DD41 ED5BFCF1        20      LD  DE,(_DIRPS) ;Root Directory
       DD45                     SOPEN1:
001027 DD45 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       DD46                     SDECPAT EQU $-1
       DD47                     SOPEN1X:
001029 DD47 CD1ADE          17      CALL    READ_DIR    ;FILE SEARCH
00102C DD4A 382A            12      JR  C,RDDERR
00102E DD4C 2A7EF1          16      LD  HL,(_DTBUF)
       DD4F                     SOPEN2:
001031 DD4F D5              11      PUSH    DE
001032 DD50 CD29DE          17      CALL    FILESE      ;(self-modifying code)
       DD51                     OPENPAT EQU $-2
001035 DD53 D1              10      POP DE
001036 DD54 386D            12      JR  C,SOPENE
001038 DD56 281B            12      JR  Z,SCF_FF_RET
       DD58                     SOPEN3:
00103A DD58 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
00103D DD5B B7               4      OR  A
00103E DD5C 200C            12      JR  NZ,SOPEN5
001040 DD5E 13               6      INC DE      ;ルートディレクトリ
001041 DD5F E5              11      PUSH    HL
001042 DD60 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       DD61                     MD_PAT  EQU $-2
001045 DD63 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
001047 DD65 E1              10      POP HL
001048 DD66 20DD            12      JR  NZ,SOPEN1
00104A DD68 1807            12      JR  SOPEN6
       DD6A                     SOPEN5:
00104C DD6A CD34E6          17      CALL    GNCLX       ;END DIR
00104F DD6D D8              11      RET C
001050 DD6E CDE1DE          17      CALL    ENDCL
       DD71                     SOPEN6:
001053 DD71 38D2            12      JR  C,SOPEN1
       DD73                     SCF_FF_RET:
001055 DD73 37               4      SCF         ;CF=1
001056 DD74 9F               4      SBC A,A     ;A=0FFH
001057 DD75 C9              10      RET
                                
       DD76                     RDDERR:
001058 DD76 BF               4      CP  A       ;READ ERR CF=1 ZF=1
001059 DD77 37               4      SCF
00105A DD78 C9              10      RET
                                
       DD79                     NOPEN:
00105B DD79 2129DE          10      LD  HL,FILESE
00105E DD7C 2251DD          16      LD  (OPENPAT),HL
001061 DD7F FD2A98F0        20      LD  IY,(_FCB)
001065 DD83 CD0BE0          17      CALL    CHKWILDX
001068 DD86 30EB            12      JR  NC,SCF_FF_RET
00106A DD88 FD7E00          19      LD  A,(IY+0)
00106D DD8B CDCADC          17      CALL    GETDRV
001070 DD8E CDD9F0          17      CALL    _CHGDRV
001073 DD91 D8              11      RET C
001074 DD92 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
001077 DD95 229FF0          16      LD  (_FILEN),HL
                                
00107A DD98 CD28DF          17      CALL    LDDIRX
00107D DD9B ED5B9AF0        20      LD  DE,(_FBPS)
001081 DD9F CD1ADE          17      CALL    READ_DIR
001084 DDA2 38D2            12      JR  C,RDDERR
001086 DDA4 3A9EF0          13      LD  A,(_FBCNT)
001089 DDA7 3D               4      DEC A
00108A DDA8 28AE            12      JR  Z,SOPEN3
       DDAA                     NOPEN2:
00108C DDAA 2A9CF0          16      LD  HL,(_FBAD)
00108F DDAD 012000          10      LD  BC,020H
001092 DDB0 09              11      ADD HL,BC
001093 DDB1 4F               4      LD  C,A
001094 DDB2 189B            12      JR  SOPEN2
                                
       DDB4                     SOPENE2:
001096 DDB4 229CF0          16      LD  (_FBAD),HL
001099 DDB7 79               4      LD  A,C
00109A DDB8 329EF0          13      LD  (_FBCNT),A
00109D DDBB ED539AF0        20      LD  (_FBPS),DE
0010A1 DDBF FD2298F0        20      LD  (_FCB),IY
       DDC3                     SOPENE:
0010A5 DDC3 AF               4      XOR A
0010A6 DDC4 C9              10      RET
                                
       DDC5                     COPEN:
0010A7 DDC5 FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
0010AB DDC9 2146DE          10      LD  HL,NEXTSE
0010AE DDCC CD18DD          17      CALL    SOPENC
0010B1 DDCF D0              11      RET NC
0010B2 DDD0 C8              11      RET Z
0010B3 DDD1 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
0010B6 DDD4 B7               4      OR  A
0010B7 DDD5 37               4      SCF
0010B8 DDD6 C8              11      RET Z       ;ルートディレクトリ
0010B9 DDD7 0601             7      LD  B,1
0010BB DDD9 CD6AE0          17      CALL    WRDF
0010BE DDDC D8              11      RET C
0010BF DDDD ED5BFEF1        20      LD  DE,(_CLPS)
0010C3 DDE1 D5              11      PUSH    DE
0010C4 DDE2 CDAADE          17      CALL    DCPAT
0010C7 DDE5 CDB5E4          17      CALL    DRDNX
0010CA DDE8 2A7EF1          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
0010CD DDEB ED4BA0E3        20      LD  BC,(SECSZ)  ;1セクタのサイズ
0010D1 DDEF AF               4      XOR A
       DDF0                     COPENCL:
0010D2 DDF0 77               7      LD  (HL),A
0010D3 DDF1 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0010D5 DDF3 EAF0DD          10      JP  PE,COPENCL
                                
0010D8 DDF6 3AC8DE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
0010DB DDF9 3D               4      DEC A
0010DC DDFA 2819            12      JR  Z,COPENE
0010DE DDFC 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
0010E0 DDFE 322CE6          13      LD  (_SECPS),A
0010E3 DE01 D1              10      POP DE      ;DE=(_CLPS)
0010E4 DE02 D5              11      PUSH    DE
       DE03                     COPEN1:
0010E5 DE03 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
0010E6 DE04 C5              11      PUSH    BC
0010E7 DE05 2A7EF1          16      LD  HL,(_DTBUF)
0010EA DE08 CDC4DE          17      CALL    CLUSTX
0010ED DE0B CDC9E7          17      CALL    DWT24
0010F0 DE0E C1              10      POP BC
0010F1 DE0F D1              10      POP DE
0010F2 DE10 CD2BE6          17      CALL    NEXTX
0010F5 DE13 20EE            12      JR  NZ,COPEN1
       DE15                     COPENE:
0010F7 DE15 2A7EF1          16      LD  HL,(_DTBUF)
0010FA DE18 D1              10      POP DE
0010FB DE19 C9              10      RET
                                
       DE1A                     READ_DIR:
0010FC DE1A ED53FEF1        20      LD  (_CLPS),DE
001100 DE1E C5              11      PUSH    BC
001101 DE1F D5              11      PUSH    DE
001102 DE20 CDAADE          17      CALL    DCPAT
001105 DE23 CD95E4          17      CALL    DRDX
001108 DE26 D1              10      POP DE
001109 DE27 C1              10      POP BC
00110A DE28 C9              10      RET
                                
       DE29                     FILESE:
00110B DE29 7E               7      LD  A,(HL)
00110C DE2A B7               4      OR  A
00110D DE2B C8              11      RET Z       ;END:ZF=1 CF=0
00110E DE2C FEE5             7      CP  0E5H
001110 DE2E 280E            12      JR  Z,FILESE1
001112 DE30 FDE5            15      PUSH    IY
001114 DE32 D1              10      POP DE
001115 DE33 13               6      INC DE
001116 DE34 E5              11      PUSH    HL
001117 DE35 CD81DE          17      CALL    CPFILE
00111A DE38 CCA2DE          17      CALL    Z,CPFILE2
00111D DE3B E1              10      POP HL
00111E DE3C 37               4      SCF
00111F DE3D C8              11      RET Z       ;!!!:(ZF=1) CF=1
       DE3E                     FILESE1:
001120 DE3E CD55DE          17      CALL    FNEXT
001123 DE41 20E6            12      JR  NZ,FILESE
       DE43                     ZF0_CF0_AFF_RET:
001125 DE43 F6FF             7      OR  0FFH        ;ZF=0 CF=0
001127 DE45 C9              10      RET
                                
       DE46                     NEXTSE:
001128 DE46 7E               7      LD  A,(HL)
001129 DE47 B7               4      OR  A
00112A DE48 37               4      SCF
00112B DE49 C8              11      RET Z       ;!!!:ZF=1 CF=1
00112C DE4A FEE5             7      CP  0E5H
00112E DE4C 37               4      SCF
00112F DE4D C8              11      RET Z       ;!!!:(ZF=1) CF=1
001130 DE4E CD55DE          17      CALL    FNEXT
001133 DE51 20F3            12      JR  NZ,NEXTSE
001135 DE53 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       DE55                     FNEXT:
001137 DE55 E5              11      PUSH    HL
001138 DE56 219FF0          10      LD  HL,_FILEN
00113B DE59 34              11      INC (HL)
00113C DE5A E1              10      POP HL
00113D DE5B 112000          10      LD  DE,020H
001140 DE5E 19              11      ADD HL,DE
001141 DE5F 0D               4      DEC C
001142 DE60 C9              10      RET
                                
       DE61                     CPNAME:
001143 DE61 C5              11      PUSH    BC
001144 DE62 D5              11      PUSH    DE
001145 DE63 E5              11      PUSH    HL
001146 DE64 CD7BDE          17      CALL    CPFILE4
001149 DE67 E1              10      POP HL
00114A DE68 23               6      INC HL
00114B DE69 23               6      INC HL
00114C DE6A 23               6      INC HL
00114D DE6B 23               6      INC HL
00114E DE6C D1              10      POP DE
00114F DE6D C1              10      POP BC
001150 DE6E 2005            12      JR  NZ,CPNAME1
001152 DE70 7E               7      LD  A,(HL)
001153 DE71 23               6      INC HL
001154 DE72 66               7      LD  H,(HL)
001155 DE73 6F               4      LD  L,A
001156 DE74 C9              10      RET
       DE75                     CPNAME1:
001157 DE75 23               6      INC HL
001158 DE76 23               6      INC HL
001159 DE77 10E8            13      DJNZ    CPNAME
00115B DE79 37               4      SCF
00115C DE7A C9              10      RET
                                
       DE7B                     CPFILE4:
00115D DE7B C5              11      PUSH    BC
00115E DE7C 010004          10      LD  BC,00400H
001161 DE7F 1804            12      JR  CPSTR1
       DE81                     CPFILE:
001163 DE81 C5              11      PUSH    BC
001164 DE82 01000B          10      LD  BC,00B00H
       DE85                     CPSTR1:
001167 DE85 1A               7      LD  A,(DE)
001168 DE86 FE3F             7      CP  '?'     ;Wild card
00116A DE88 2812            12      JR  Z,CPSTR2
00116C DE8A 7E               7      LD  A,(HL)
00116D DE8B CDF1DF          17      CALL    FKANC
001170 DE8E E5              11      PUSH    HL
001171 DE8F 67               4      LD  H,A
001172 DE90 1A               7      LD  A,(DE)
001173 DE91 CB01             8      RLC C
001175 DE93 CDF1DF          17      CALL    FKANC
001178 DE96 CB09             8      RRC C
00117A DE98 BC               4      CP  H       ;CP (HL),(DE)
00117B DE99 E1              10      POP HL
00117C DE9A 2004            12      JR  NZ,CPSTR3
       DE9C                     CPSTR2:
00117E DE9C 13               6      INC DE
00117F DE9D 23               6      INC HL
001180 DE9E 10E5            13      DJNZ    CPSTR1
       DEA0                     CPSTR3:
001182 DEA0 C1              10      POP BC
001183 DEA1 C9              10      RET
                                
       DEA2                     CPFILE2:
001184 DEA2 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001187 DEA5 F6E1             7      OR  0E1H
001189 DEA7 2F               4      CPL
00118A DEA8 A6               7      AND (HL)
00118B DEA9 C9              10      RET
                                
       DEAA                     DCPAT:
00118C DEAA 0E00             7      LD  C,0
00118E DEAC 2A7EF1          16      LD  HL,(_DTBUF)
001191 DEAF 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
001194 DEB2 B7               4      OR  A
001195 DEB3 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
001196 DEB4 3AC8DE          13      LD  A,(SPCPAT)
001199 DEB7 4F               4      LD  C,A
00119A DEB8 3A2CE6          13      LD  A,(_SECPS)
00119D DEBB B9               4      CP  C
00119E DEBC 3801            12      JR  C,DC1
0011A0 DEBE AF               4      XOR A
       DEBF                     DC1:
0011A1 DEBF F680             7      OR  080H
0011A3 DEC1 32A0F0          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       DEC4                     CLUSTX:
0011A6 DEC4 E5              11      PUSH    HL
0011A7 DEC5 EB               4      EX  DE,HL
0011A8 DEC6 AF               4      XOR A
0011A9 DEC7 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       DEC8                     SPCPAT  EQU $-1
       DEC9                     L_CLDBL:
0011AB DEC9 CB19             8      RR  C       ;->CF
0011AD DECB 3804            12      JR  C,E_CLDBL
0011AF DECD 29              11      ADD HL,HL       ;*2
0011B0 DECE 8F               4      ADC A,A
0011B1 DECF 18F8            12      JR  L_CLDBL
       DED1                     E_CLDBL:
0011B3 DED1 4F               4      LD  C,A
0011B4 DED2 3A2CE6          13      LD  A,(_SECPS)
0011B7 DED5 B5               4      OR  L
0011B8 DED6 6F               4      LD  L,A
0011B9 DED7 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       DED8                     CLSPAT  EQU $-2
0011BC DEDA AF               4      XOR A
0011BD DEDB 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
0011BE DEDC 89               4      ADC A,C
0011BF DEDD 4F               4      LD  C,A
0011C0 DEDE EB               4      EX  DE,HL
0011C1 DEDF E1              10      POP HL
0011C2 DEE0 C9              10      RET
                                ;(8)
       DEE1                     ENDCL:
0011C3 DEE1 7A               4      LD  A,D ;END CLUSTER
0011C4 DEE2 FE01             7      CP  1   ;164=356    (self-modifying code)
       DEE3                     CLPAT1  EQU $-1
0011C6 DEE4 C0              11      RET NZ
0011C7 DEE5 7B               4      LD  A,E
0011C8 DEE6 FE64             7      CP  064H    ;       (self-modifying code)
       DEE7                     CLPAT2  EQU $-1
0011CA DEE8 C9              10      RET
                                ;(3)
       DEE9                     CAP4:
0011CB DEE9 3EE5             7      LD  A,0E5H
0011CD DEEB C9              10      RET
                                                    ;for X1/88 ワークエリア
0011CE DEEC 5BF0                    DW  _DISKE+1        ;DISKVE($F323)
0011D0 DEEE F5F0                    DW  _BREAK+1        ;BREAKV($F325)
                                
       DEF0                     CAP:            ;(9)
0011D2 DEF0 FE61             7      CP  'a'
0011D4 DEF2 D8              11      RET C
0011D5 DEF3 FE7B             7      CP  'z'+1
0011D7 DEF5 D0              11      RET NC
0011D8 DEF6 D620             7      SUB 020H
0011DA DEF8 C9              10      RET
                                ;(10)
       DEF9                     CAP2:
0011DB DEF9 CDF0DE          17      CALL    CAP
       DEFC                     CAP3:               ;
0011DE DEFC FE05             7      CP  5
0011E0 DEFE 28E9            12      JR  Z,CAP4
0011E2 DF00 FE21             7      CP  021H
0011E4 DF02 C9              10      RET
                                                    ;
       DF03                     CHDIR:
0011E5 DF03 CDDAE8          17      CALL    GETDPBD
0011E8 DF06 381D            12      JR  C,CHDIR2
0011EA DF08 DD751A          19      LD  (IX+DPB_SDIR),L
0011ED DF0B DD741B          19      LD  (IX+DPB_SDIR+1),H
0011F0 DF0E 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       DF10                     LDDIR:
0011F2 DF10 CDDAE8          17      CALL    GETDPBD
0011F5 DF13 DD5E1A          19      LD  E,(IX+DPB_SDIR)
0011F8 DF16 DD561B          19      LD  D,(IX+DPB_SDIR+1)
0011FB DF19 13               6      INC DE
0011FC DF1A FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011FF DF1D FD720F          19      LD  (IY+15),D
001202 DF20 1B               6      DEC DE
001203 DF21 AF               4      XOR A
001204 DF22 32A0F0          13      LD  (_DIRF),A
       DF25                     CHDIR2:
001207 DF25 DDE1            14      POP IX
001209 DF27 C9              10      RET
                                
       DF28                     LDDIRX:
00120A DF28 3AA0F0          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
00120D DF2B E67F             7      AND 07FH
       DF2D                     LDDIRX1:
00120F DF2D 322CE6          13      LD  (_SECPS),A
001212 DF30 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
001215 DF33 FD560F          19      LD  D,(IY+15)
001218 DF36 1B               6      DEC DE
001219 DF37 CDE1DE          17      CALL    ENDCL
00121C DF3A D410DF          17      CALL    NC,LDDIR
       DF3D                     LDDIRS:
00121F DF3D 7A               4      LD  A,D
001220 DF3E B3               4      OR  E
001221 DF3F 32A0F0          13      LD  (_DIRF),A   ;ディレクトリか判別
001224 DF42 C9              10      RET
                                
       DF43                     KILL:
001225 DF43 CD0BE0          17      CALL    CHKWILDX
001228 DF46 3834            12      JR  C,KILLW
00122A DF48 CDE6DC          17      CALL    SOPENX
       DF4B                     KILLS:
00122D DF4B 3E1F             7      LD  A,01FH
00122F DF4D D48FDF          17      CALL    NC,CHKATT
001232 DF50 D8              11      RET C
       DF51                     KILLSX:
001233 DF51 36E5            10      LD  (HL),0E5H   ;DIR
001235 DF53 CDE7DF          17      CALL    WTDB
001238 DF56 111A00          10      LD  DE,01AH
00123B DF59 19              11      ADD HL,DE
00123C DF5A 5E               7      LD  E,(HL)
00123D DF5B 23               6      INC HL
00123E DF5C 56               7      LD  D,(HL)
       DF5D                     KILLS1:
00123F DF5D CDE1DE          17      CALL    ENDCL
001242 DF60 D0              11      RET NC      ;CF=0
001243 DF61 21FEFF          10      LD  HL,0-2
001246 DF64 19              11      ADD HL,DE
001247 DF65 D0              11      RET NC      ;DE= 0 or 1
001248 DF66 D5              11      PUSH    DE
001249 DF67 CDF7F0          17      CALL    _GNCL
00124C DF6A ED53FEF1        20      LD  (_CLPS),DE
001250 DF6E D1              10      POP DE
001251 DF6F 210000          10      LD  HL,0
001254 DF72 D4FAF0          17      CALL    NC,_SNCL
001257 DF75 D8              11      RET C
001258 DF76 ED5BFEF1        20      LD  DE,(_CLPS)  ;FAT
00125C DF7A 18E1            12      JR  KILLS1
                                
       DF7C                     KILLW:
00125E DF7C CD15DD          17      CALL    SOPEN
       DF7F                     KILLW1:
001261 DF7F 380B            12      JR  C,KILLW2
001263 DF81 CDB4DD          17      CALL    SOPENE2
001266 DF84 CD4BDF          17      CALL    KILLS
001269 DF87 CD79DD          17      CALL    NOPEN
00126C DF8A 18F3            12      JR  KILLW1
       DF8C                     KILLW2:
00126E DF8C C8              11      RET Z
00126F DF8D 3F               4      CCF
001270 DF8E C9              10      RET
                                
       DF8F                     CHKATT:
001271 DF8F E5              11      PUSH    HL
001272 DF90 110B00          10      LD  DE,00BH
001275 DF93 19              11      ADD HL,DE
001276 DF94 A6               7      AND (HL)
001277 DF95 E1              10      POP HL
001278 DF96 C8              11      RET Z
001279 DF97 37               4      SCF
00127A DF98 C9              10      RET
                                
       DF99                     NAME:
00127B DF99 CD0BE0          17      CALL    CHKWILDX
00127E DF9C D8              11      RET C
00127F DF9D 110400          10      LD  DE,4
001282 DFA0 19              11      ADD HL,DE
001283 DFA1 22B6DF          16      LD  (NAMEP),HL
001286 DFA4 23               6      INC HL
001287 DFA5 CD0FE0          17      CALL    CHKWILD
00128A DFA8 D8              11      RET C
                                
00128B DFA9 CDE6DC          17      CALL    SOPENX
00128E DFAC 3E0F             7      LD  A,00FH
001290 DFAE D48FDF          17      CALL    NC,CHKATT
001293 DFB1 D8              11      RET C
                                
001294 DFB2 FDE5            15      PUSH    IY
001296 DFB4 FD210000        14      LD  IY,0        ;自己書き換え
       DFB6                     NAMEP   EQU $-2
00129A DFB8 CDE6DC          17      CALL    SOPENX
00129D DFBB FDE3            23      EX  (SP),IY
00129F DFBD 3F               4      CCF
0012A0 DFBE D415DD          17      CALL    NC,SOPEN
0012A3 DFC1 EB               4      EX  DE,HL
0012A4 DFC2 E1              10      POP HL
0012A5 DFC3 D8              11      RET C
                                
       DFC4                     SETNAME:
0012A6 DFC4 01000B          10      LD  BC,11*256
0012A9 DFC7 23               6      INC HL
0012AA DFC8 7E               7      LD  A,(HL)
0012AB DFC9 FEE5             7      CP  0E5H
0012AD DFCB 2004            12      JR  NZ,SNAME1
0012AF DFCD 3E05             7      LD  A,5
0012B1 DFCF 180E            12      JR  SNAME3
       DFD1                     SNAME1:
0012B3 DFD1 7E               7      LD  A,(HL)
0012B4 DFD2 0C               4      INC C
0012B5 DFD3 0D               4      DEC C
0012B6 DFD4 2009            12      JR  NZ,SNAME3
0012B8 DFD6 CDF0DE          17      CALL    CAP
0012BB DFD9 FEA0             7      CP  0A0H
0012BD DFDB 2002            12      JR  NZ,SNAME3
0012BF DFDD 3E20             7      LD  A,020H
       DFDF                     SNAME3:
0012C1 DFDF 12               7      LD  (DE),A
0012C2 DFE0 7E               7      LD  A,(HL)
0012C3 DFE1 23               6      INC HL
0012C4 DFE2 CDF8DF          17      CALL    FKAN
0012C7 DFE5 10EA            13      DJNZ    SNAME1
       DFE7                     WTDB:               ;バッファデータが更新された
0012C9 DFE7 3EFF             7      LD  A,0FFH
0012CB DFE9 3239F0          13      LD  (SFILE),A
0012CE DFEC 32A4F0          13      LD  (_WTDBF),A
0012D1 DFEF AF               4      XOR A
0012D2 DFF0 C9              10      RET
                                
       DFF1                     FKANC:
0012D3 DFF1 CB41             8      BIT 0,C
0012D5 DFF3 CCF9DE          17      CALL    Z,CAP2
0012D8 DFF6 1801            12      JR  FKANX
       DFF8                     FKAN:           ;漢字チェック
0012DA DFF8 13               6      INC DE
       DFF9                     FKANX:
0012DB DFF9 CB41             8      BIT 0,C
0012DD DFFB CB81             8      RES 0,C
0012DF DFFD C0              11      RET NZ
0012E0 DFFE FE80             7      CP  080H
0012E2 E000 D8              11      RET C
0012E3 E001 FEA0             7      CP  0A0H
0012E5 E003 3803            12      JR  C,FKAN1
0012E7 E005 FEE0             7      CP  0E0H
0012E9 E007 D8              11      RET C
       E008                     FKAN1:
0012EA E008 0C               4      INC C
0012EB E009 A7               4      AND A
0012EC E00A C9              10      RET
                                
       E00B                     CHKWILDX:
0012ED E00B FDE5            15      PUSH    IY
0012EF E00D E1              10      POP HL
0012F0 E00E 23               6      INC HL
       E00F                     CHKWILD:
0012F1 E00F 060B             7      LD  B,11
0012F3 E011 3E3F             7      LD  A,'?'
       E013                     CHKWIL1:
0012F5 E013 BE               7      CP  (HL)
0012F6 E014 23               6      INC HL
0012F7 E015 37               4      SCF
0012F8 E016 C8              11      RET Z
0012F9 E017 10FA            13      DJNZ    CHKWIL1
0012FB E019 AF               4      XOR A
0012FC E01A C9              10      RET
                                
       E01B                     SDIRENT:        ;IY=FCB HL=DIR
0012FD E01B D5              11      PUSH    DE
0012FE E01C E5              11      PUSH    HL
0012FF E01D FDE5            15      PUSH    IY
001301 E01F D1              10      POP DE
001302 E020 EB               4      EX  DE,HL
001303 E021 CDC4DF          17      CALL    SETNAME
                                ;               Attribute
001306 E024 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001309 E027 12               7      LD  (DE),A
00130A E028 13               6      INC DE
                                ;               Reserved
00130B E029 AF               4      XOR A
00130C E02A 060A             7      LD  B,10
       E02C                     SDE1:
00130E E02C 12               7      LD  (DE),A
00130F E02D 13               6      INC DE
001310 E02E 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
001312 E030 21E4F1          10      LD  HL,SDDATA       ;(FCB)更新年月日
001315 E033 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       E035                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
001317 E035 7E               7      LD  A,(HL)
001318 E036 23               6      INC HL
001319 E037 323CE0          13      LD  (SDPAT),A
00131C E03A FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       E03C                     SDPAT   EQU $-1
00131F E03D 12               7      LD  (DE),A
001320 E03E 13               6      INC DE
001321 E03F 10F4            13      DJNZ    SDLOOP
                                
001323 E041 AF               4      XOR A
001324 E042 E1              10      POP HL
001325 E043 D1              10      POP DE
001326 E044 C9              10      RET
                                
       E045                     WOPEN:
001327 E045 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
00132A E048 E61F             7      AND 01FH
00132C E04A 37               4      SCF
00132D E04B C0              11      RET NZ
00132E E04C FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E050                     TOPEN2:
001332 E050 AF               4      XOR A
       E051                     TOPEN:              ;Initializes the time stamp
001333 E051 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
001337 E055 C9              10      RET
                                
       E056                     WRDFX:
001338 E056 3AC8DE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       E059                     L_WRFX:
00133B E059 1F               4      RRA         ;->CF
00133C E05A 3806            12      JR  C,E_WRFX
00133E E05C CB39             8      SRL C
001340 E05E CB1C             8      RR  H       ;CH=CH/2
001342 E060 18F7            12      JR  L_WRFX
       E062                     E_WRFX:
001344 E062 41               4      LD  B,C
001345 E063 4C               4      LD  C,H
001346 E064 03               6      INC BC
001347 E065 3E37             7      LD  A,037H      ;SCF
001349 E067 32B2E4          13      LD  (DRDN1),A
                                
       E06A                     WRDF:               ;BCクラスタ分FATを確保する
00134C E06A 110200          10      LD  DE,2
00134F E06D AF               4      XOR A
001350 E06E 322CE6          13      LD  (_SECPS),A
       E071                     WRDF1:
001353 E071 C5              11      PUSH    BC
001354 E072 D5              11      PUSH    DE
001355 E073 CDF7F0          17      CALL    _GNCL
001358 E076 381C            12      JR  C,WRDF3
00135A E078 7A               4      LD  A,D     ;空いているかチェック
00135B E079 B3               4      OR  E
00135C E07A 202A            12      JR  NZ,WRDF4
00135E E07C E1              10      POP HL      ;HL=空いているクラスタ
00135F E07D E5              11      PUSH    HL
001360 E07E ED5BFEF1        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
001364 E082 22FEF1          16      LD  (_CLPS),HL
001367 E085 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
001368 E086 B3               4      OR  E
001369 E087 2008            12      JR  NZ,WRDF2
00136B E089 FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
00136E E08C FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
001371 E08F 1803            12      JR  WRDF3
       E091                     WRDF2:
001373 E091 CDFAF0          17      CALL    _SNCL
       E094                     WRDF3:
001376 E094 D1              10      POP DE
001377 E095 C1              10      POP BC
001378 E096 D8              11      RET C
001379 E097 0B               6      DEC BC
00137A E098 78               4      LD  A,B
00137B E099 B1               4      OR  C
00137C E09A 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
00137E E09C ED5BFEF1        20      LD  DE,(_CLPS)
001382 E0A0 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
001385 E0A3 C3FAF0          10      JP  _SNCL
                                
       E0A6                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
001388 E0A6 D1              10      POP DE
001389 E0A7 C1              10      POP BC
       E0A8                     WRDF5:
00138A E0A8 13               6      INC DE
00138B E0A9 CDE1DE          17      CALL    ENDCL
00138E E0AC 38C3            12      JR  C,WRDF1
001390 E0AE 37               4      SCF
001391 E0AF C9              10      RET
                                
       E0B0                     RWXR:
001392 E0B0 3AA1E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E0B3                     L_RWX:
001395 E0B3 1F               4      RRA     ;->CF
001396 E0B4 3808            12      JR  C,E_RWX
001398 E0B6 CB38             8      SRL B   ;BCH=BCH/2
00139A E0B8 CB19             8      RR  C   ;
00139C E0BA CB1C             8      RR  H   ;
00139E E0BC 18F5            12      JR  L_RWX
       E0BE                     E_RWX:
0013A0 E0BE FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0013A3 E0C1 FD561B          19      LD  D,(IY+27)
0013A6 E0C4 AF               4      XOR A
0013A7 E0C5 322CE6          13      LD  (_SECPS),A
       E0C8                     RWX1:
0013AA E0C8 ED53FEF1        20      LD  (_CLPS),DE
0013AE E0CC 7A               4      LD  A,D
0013AF E0CD B3               4      OR  E
0013B0 E0CE 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
0013B2 E0D0 78               4      LD  A,B
0013B3 E0D1 B1               4      OR  C
0013B4 E0D2 B4               4      OR  H
0013B5 E0D3 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
0013B6 E0D4 CD34E6          17      CALL    GNCLX
0013B9 E0D7 D8              11      RET C
0013BA E0D8 7C               4      LD  A,H     ;
0013BB E0D9 25               4      DEC H       ;
0013BC E0DA B7               4      OR  A       ;DEC BCH
0013BD E0DB 2001            12      JR  NZ,RWX2     ;
0013BF E0DD 0B               6      DEC BC      ;
       E0DE                     RWX2:
0013C0 E0DE CDE1DE          17      CALL    ENDCL
0013C3 E0E1 38E5            12      JR  C,RWX1
       E0E3                     SCF_RET:
0013C5 E0E3 37               4      SCF
0013C6 E0E4 C9              10      RET
                                
       E0E5                     DSKF:
0013C7 E0E5 110000          10      LD  DE,0
       E0E6                     MAXCLP  EQU $-2
0013CA E0E8 2AACF0          16      LD  HL,(_FAKEFREE)
0013CD E0EB 7C               4      LD  A,H
0013CE E0EC B5               4      OR  L
0013CF E0ED 2803            12      JR  Z,DSKF1
0013D1 E0EF 110100          10      LD  DE,1
       E0F2                     DSKF1:
0013D4 E0F2 D5              11      PUSH    DE
0013D5 E0F3 CDF7F0          17      CALL    _GNCL
0013D8 E0F6 380C            12      JR  C,POPSCF
0013DA E0F8 7A               4      LD  A,D
0013DB E0F9 B3               4      OR  E
0013DC E0FA 2001            12      JR  NZ,DSKF2
0013DE E0FC 23               6      INC HL
       E0FD                     DSKF2:
0013DF E0FD D1              10      POP DE
0013E0 E0FE 1B               6      DEC DE
0013E1 E0FF 7A               4      LD  A,D
0013E2 E100 B3               4      OR  E
0013E3 E101 20EF            12      JR  NZ,DSKF1
0013E5 E103 C9              10      RET
                                
       E104                     POPSCF:
0013E6 E104 F1              10      POP AF
0013E7 E105 37               4      SCF
0013E8 E106 C9              10      RET
                                
       E107                     SETTMS:
0013E9 E107 FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
0013EC E10A 3C               4      INC A
0013ED E10B C0              11      RET NZ      ;ファイルが更新されていない
       E10C                     SETTMSX:            ;FCBに日付時刻をセットする
0013EE E10C CD1DD8          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
0013F1 E10F CB25             8      SLA L       ;   *2
0013F3 E111 CB25             8      SLA L       ;   *4
0013F5 E113 29              11      ADD HL,HL       ;*2 *8
0013F6 E114 29              11      ADD HL,HL       ;*4 *16
0013F7 E115 29              11      ADD HL,HL       ;*8 *32
0013F8 E116 7A               4      LD  A,D
0013F9 E117 0F               4      RRCA            ;bit.0->7->->->0->C
0013FA E118 E61F             7      AND 01FH
0013FC E11A B5               4      OR  L
0013FD E11B FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
001400 E11E FD7417          19      LD  (IY+23),H
                                
001403 E121 CD1DD8          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
001406 E124 0144F8          10      LD  BC,0-1980
001409 E127 09              11      ADD HL,BC
00140A E128 65               4      LD  H,L
                                
00140B E129 7A               4      LD  A,D
00140C E12A 87               4      ADD A,A     ;*2
00140D E12B 87               4      ADD A,A     ;*4
00140E E12C 87               4      ADD A,A     ;*8
00140F E12D 87               4      ADD A,A     ;*16
001410 E12E 6F               4      LD  L,A
001411 E12F 29              11      ADD HL,HL       ;*32
001412 E130 7D               4      LD  A,L
001413 E131 B3               4      OR  E
001414 E132 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
001417 E135 FD7415          19      LD  (IY+21),H
00141A E138 C9              10      RET
                                ;(16)
       E139                     PUSHRR:
00141B E139 3265E4          13      LD  (SETSEQ_SWC_RND),A
00141E E13C 2277E4          16      LD  (SETSEQ_SWC_SEQ_RR),HL
001421 E13F CD5FE1          17      CALL    GET_RR_AHL
001424 E142 220FF0          16      LD  (RR_BUF_HL),HL
001427 E145 3211F0          13      LD  (RR_BUF_A),A
00142A E148 C9              10      RET
                                ;(14)
       E149                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
00142B E149 87               4      ADD A,A     ;in BHLA => out AHL
00142C E14A ED6A            15      ADC HL,HL
00142E E14C CB18             8      RR  B
001430 E14E B7               4      OR  A
001431 E14F 78               4      LD  A,B     ;ここでフラグは変化しない
001432 E150 C8              11      RET Z
001433 E151 2C               4      INC L       ;INC AHL
001434 E152 C0              11      RET NZ      ;
001435 E153 24               4      INC H       ;
001436 E154 C0              11      RET NZ      ;
001437 E155 3C               4      INC A       ;
001438 E156 C9              10      RET
                                ;(18)
       E157                     INIT_RND:
001439 E157 3ECD             7      LD  A,0CDH      ;CALL ????
00143B E159 2176E1          10      LD  HL,POPRR
00143E E15C CD39E1          17      CALL    PUSHRR
       E15F                     GET_RR_AHL:
001441 E15F FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001444 E162 FD6622          19      LD  H,(IY+34)   ;
001447 E165 FD7E23          19      LD  A,(IY+35)   ;
00144A E168 C9              10      RET
                                ;(10)
       E169                     SET_RR_AHL:
00144B E169 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
00144E E16C FD7422          19      LD  (IY+34),H   ;
001451 E16F FD7723          19      LD  (IY+35),A   ;
001454 E172 C9              10      RET
                                ;(17)
       E173                     SETSEQ:
001455 E173 CD98E1          17      CALL    SETSEQ1
       E176                     POPRR:
001458 E176 F5              11      PUSH    AF
001459 E177 E5              11      PUSH    HL
00145A E178 2A0FF0          16      LD  HL,(RR_BUF_HL)
00145D E17B 3A11F0          13      LD  A,(RR_BUF_A)
001460 E17E CD69E1          17      CALL    SET_RR_AHL
001463 E181 E1              10      POP HL
001464 E182 F1              10      POP AF
001465 E183 C9              10      RET
                                ;(20)
       E184                     GET_RR_BCDE:            ;BCDE=Random record
001466 E184 FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
001469 E187 FD5622          19      LD  D,(IY+34)
00146C E18A FD4E23          19      LD  C,(IY+35)
00146F E18D 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
001471 E18F FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001475 E193 C0              11      RET NZ
001476 E194 FD4624          19      LD  B,(IY+36)
001479 E197 C9              10      RET
                                
       E198                     SETSEQ1:
00147A E198 F5              11      PUSH    AF
00147B E199 E5              11      PUSH    HL      ;AHL=Random record
00147C E19A CD5FE1          17      CALL    GET_RR_AHL
00147F E19D 47               4      LD  B,A     ;AHL→HLA
001480 E19E 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
001481 E19F 6C               4      LD  L,H     ;(IY+34)
001482 E1A0 60               4      LD  H,B     ;(IY+35)
001483 E1A1 0600             7      LD  B,0
                                
001485 E1A3 CD49E1          17      CALL    GET_CPM_R_SIZE
                                
001488 E1A6 29              11      ADD HL,HL
001489 E1A7 CB3D             8      SRL L       ;L=L/2
00148B E1A9 FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
00148E E1AC FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
001491 E1AF E1              10      POP HL
001492 E1B0 F1              10      POP AF
001493 E1B1 C9              10      RET
                                
                                ;(23)
       E1B2                     RBXEND:             ;レコード数だけランダムレコードを進める
001494 E1B2 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       E1B3                     RBSIZE  EQU $-2
001497 E1B5 CD5FE1          17      CALL    GET_RR_AHL
00149A E1B8 19              11      ADD HL,DE
00149B E1B9 CE00             7      ADC A,0
00149D E1BB CD69E1          17      CALL    SET_RR_AHL
0014A0 E1BE EB               4      EX  DE,HL       ;HL=進めるレコード数
0014A1 E1BF D0              11      RET NC
0014A2 E1C0 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0014A6 E1C4 C0              11      RET NZ
0014A7 E1C5 FD3424          23      INC (IY+36)
0014AA E1C8 C9              10      RET
       E1C9                     FILE_E:
                                
       DD73                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       DD73                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       DD73                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       DD73                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       DD73                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E1C9                     _SYS26:     ;(BDOS)ランダムブロック書き込み
0014AB E1C9 AF               4      XOR A
0014AC E1CA 32B2E4          13      LD  (DRDN1),A   ;NOP
0014AF E1CD 22B3E1          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
0014B2 E1D0 225DF0          16      LD  (LEFTX),HL
0014B5 E1D3 CDBCDC          17      CALL    SETDRV
                                
0014B8 E1D6 CD3CE3          17      CALL    RBX0
0014BB E1D9 DA66E2          10      JP  C,RBWERR
0014BE E1DC CD45E0          17      CALL    WOPEN
0014C1 E1DF DA66E2          10      JP  C,RBWERR
0014C4 E1E2 7C               4      LD  A,H
0014C5 E1E3 B5               4      OR  L
0014C6 E1E4 CA5FE2          10      JP  Z,RBW1
                                
0014C9 E1E7 2B               6      DEC HL
                                
0014CA E1E8 CD84E1          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0014CD E1EB 19              11      ADD HL,DE       ;BCHL=HL+BCDE
0014CE E1EC 3001            12      JR  NC,S26X1    ;
0014D0 E1EE 03               6      INC BC      ;
       E1EF                     S26X1:
0014D1 E1EF CDB0E0          17      CALL    RWXR
0014D4 E1F2 DC56E0          17      CALL    C,WRDFX
0014D7 E1F5 DA66E2          10      JP  C,RBWERR
                                
0014DA E1F8 CD6BE3          17      CALL    RBX2
0014DD E1FB 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
0014DF E1FD CD8AE3          17      CALL    RBXA
0014E2 E200 3864            12      JR  C,RBWERR
0014E4 E202 EB               4      EX  DE,HL
0014E5 E203 C5              11      PUSH    BC
0014E6 E204 EDB0                    LDIR
0014E8 E206 225FF0          16      LD  (DTAX),HL
                                
0014EB E209 CDE7DF          17      CALL    WTDB        ;バッファデータは更新された
                                
0014EE E20C 2A5DF0          16      LD  HL,(LEFTX)
0014F1 E20F D1              10      POP DE
0014F2 E210 ED52            15      SBC HL,DE
0014F4 E212 225DF0          16      LD  (LEFTX),HL
0014F7 E215 2831            12      JR  Z,RBWEND
                                
       E217                     RBWB:
0014F9 E217 CDBFE3          17      CALL    RBXB
0014FC E21A 2814            12      JR  Z,RBWC
       E21C                     RBWB1:
0014FE E21C C5              11      PUSH    BC
0014FF E21D D5              11      PUSH    DE
001500 E21E CDC4DE          17      CALL    CLUSTX
001503 E221 CDE3E3          17      CALL    DWTC
001506 E224 D1              10      POP DE
001507 E225 C1              10      POP BC
001508 E226 D434E6          17      CALL    NC,GNCLX
00150B E229 383B            12      JR  C,RBWERR
00150D E22B 10EF            13      DJNZ    RBWB1
00150F E22D CD33E4          17      CALL    DRW_FLUSH
       E230                     RBWC:
001512 E230 CDD7E3          17      CALL    RBXC
001515 E233 2813            12      JR  Z,RBWEND
001517 E235 C5              11      PUSH    BC
001518 E236 CDC4DE          17      CALL    CLUSTX
00151B E239 CDB1E4          17      CALL    DRDN
00151E E23C C1              10      POP BC
00151F E23D 3827            12      JR  C,RBWERR
001521 E23F ED5B7EF1        20      LD  DE,(_DTBUF)
001525 E243 EDB0                    LDIR
001527 E245 CDE7DF          17      CALL    WTDB        ;バッファデータは更新された
       E248                     RBWEND:
00152A E248 CDB2E1          17      CALL    RBXEND
                                
00152D E24B CD4BE3          17      CALL    RBX1
001530 E24E 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
001532 E250 CD84E1          17      CALL    GET_RR_BCDE ;BCDE=Random record
001535 E253 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
001538 E256 FD7211          19      LD  (IY+17),D   ;
00153B E259 FD7112          19      LD  (IY+18),C   ;
00153E E25C FD7013          19      LD  (IY+19),B   ;
       E25F                     RBW1:
001541 E25F FDE1            14      POP IY
001543 E261 C1              10      POP BC
001544 E262 D1              10      POP DE
001545 E263 E1              10      POP HL
       E264                     DD_NUL:
001546 E264 AF               4      XOR A
       E265                     DRDF0:
       E265                     DWTF0:
001547 E265 C9              10      RET
                                
       E266                     RBWERR:
001548 E266 FDE5            15      PUSH    IY
00154A E268 D1              10      POP DE
00154B E269 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
00154D E26B CD4ED4          17      CALL    BDOS0
       E26E                     RBRERR1:
001550 E26E 3E01             7      LD  A,001H
       E270                     RBRERR2:
001552 E270 FDE1            14      POP IY
001554 E272 C1              10      POP BC
001555 E273 D1              10      POP DE
001556 E274 E1              10      POP HL
001557 E275 37               4      SCF
001558 E276 210000          10      LD  HL,0
00155B E279 C9              10      RET
                                
       E27A                     RBRERR:
00155C E27A 3EFF             7      LD  A,0FFH
00155E E27C 18F2            12      JR  RBRERR2
                                
       E27E                     RBRFL:
001560 E27E 3E00             7  RBRFLP: LD  A,000H
001562 E280 FE0D             7      CP  00DH
001564 E282 2005            12      JR  NZ,RBRFL1
001566 E284 D5              11      PUSH    DE
001567 E285 1E0A             7      LD  E,00AH
001569 E287 1805            12      JR  RBRFL2
       E289                     RBRFL1:
00156B E289 D5              11      PUSH    DE
00156C E28A CD09F0          17      CALL    _SYS07
00156F E28D 5F               4      LD  E,A
       E28E                     RBRFL2:
001570 E28E CDCDF0          17      CALL    _PRINT
001573 E291 7B               4      LD  A,E
001574 E292 D1              10      POP DE
001575 E293 327FE2          13      LD  (RBRFLP+1),A
001578 E296 C9              10      RET
                                
                                                ;Read random block
       E297                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001579 E297 225DF0          16      LD  (LEFTX),HL
00157C E29A CDBCDC          17      CALL    SETDRV
                                
00157F E29D FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
001583 E2A1 C22AE3          10      JP  NZ,RBRDIR   ;ディレクトリ
001586 E2A4 CD3CE3          17      CALL    RBX0
001589 E2A7 DA7AE2          10      JP  C,RBRERR
00158C E2AA CD4BE3          17      CALL    RBX1
00158F E2AD D463E3          17      CALL    NC,RBX1R
001592 E2B0 DA6EE2          10      JP  C,RBRERR1
001595 E2B3 EB               4      EX  DE,HL
001596 E2B4 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
001598 E2B6 19              11      ADD HL,DE
001599 E2B7 79               4      LD  A,C
00159A E2B8 DE00             7      SBC A,0
00159C E2BA 78               4      LD  A,B
00159D E2BB DE00             7      SBC A,0
00159F E2BD 3801            12      JR  C,RBR1
0015A1 E2BF EB               4      EX  DE,HL
       E2C0                     RBR1:
0015A2 E2C0 9F               4      SBC A,A
0015A3 E2C1 E601             7      AND 1
0015A5 E2C3 3228E3          13      LD  (RBRA_SWC),A
                                
0015A8 E2C6 7C               4      LD  A,H
0015A9 E2C7 B5               4      OR  L
0015AA E2C8 2857            12      JR  Z,RBREND0
                                
0015AC E2CA 22B3E1          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
0015AF E2CD 225DF0          16      LD  (LEFTX),HL
                                
0015B2 E2D0 CD6BE3          17      CALL    RBX2
0015B5 E2D3 2819            12      JR  Z,RBRB
0015B7 E2D5 CD8AE3          17      CALL    RBXA
0015BA E2D8 DA7AE2          10      JP  C,RBRERR
0015BD E2DB C5              11      PUSH    BC
0015BE E2DC EDB0                    LDIR
0015C0 E2DE ED535FF0        20      LD  (DTAX),DE
0015C4 E2E2 2A5DF0          16      LD  HL,(LEFTX)
0015C7 E2E5 D1              10      POP DE
0015C8 E2E6 A7               4      AND A
0015C9 E2E7 ED52            15      SBC HL,DE
0015CB E2E9 225DF0          16      LD  (LEFTX),HL
0015CE E2EC 2830            12      JR  Z,RBREND
                                
       E2EE                     RBRB:
0015D0 E2EE CDBFE3          17      CALL    RBXB
0015D3 E2F1 2815            12      JR  Z,RBRC
       E2F3                     RBRB1:
0015D5 E2F3 C5              11      PUSH    BC
0015D6 E2F4 D5              11      PUSH    DE
0015D7 E2F5 CDC4DE          17      CALL    CLUSTX
0015DA E2F8 CDE9E3          17      CALL    DRDC
0015DD E2FB D1              10      POP DE
0015DE E2FC C1              10      POP BC
0015DF E2FD D434E6          17      CALL    NC,GNCLX
0015E2 E300 DA7AE2          10      JP  C,RBRERR
0015E5 E303 10EE            13      DJNZ    RBRB1
0015E7 E305 CD33E4          17      CALL    DRW_FLUSH
       E308                     RBRC:
0015EA E308 CDD7E3          17      CALL    RBXC
0015ED E30B 2811            12      JR  Z,RBREND
0015EF E30D C5              11      PUSH    BC
0015F0 E30E CDC4DE          17      CALL    CLUSTX
0015F3 E311 CD95E4          17      CALL    DRDX
0015F6 E314 C1              10      POP BC
0015F7 E315 DA7AE2          10      JP  C,RBRERR
0015FA E318 EB               4      EX  DE,HL
0015FB E319 2A7EF1          16      LD  HL,(_DTBUF)
0015FE E31C EDB0                    LDIR
       E31E                     RBREND:
001600 E31E CDB2E1          17      CALL    RBXEND
       E321                     RBREND0:
001603 E321 FDE1            14      POP IY
001605 E323 C1              10      POP BC
001606 E324 D1              10      POP DE
001607 E325 F1              10      POP AF  ;(HL)
001608 E326 AF               4      XOR A
001609 E327 3E00             7      LD  A,000H
       E328                     RBRA_SWC    EQU $-1
00160B E329 C9              10      RET
                                
       E32A                     RBRDIR:
00160C E32A FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
00160F E32D FD661B          19      LD  H,(IY+27)
001612 E330 CD03DF          17      CALL    CHDIR
001615 E333 AF               4      XOR A
001616 E334 67               4      LD  H,A
001617 E335 6F               4      LD  L,A
001618 E336 3C               4      INC A
001619 E337 3228E3          13      LD  (RBRA_SWC),A
00161C E33A 18E5            12      JR  RBREND0
                                ;(15)
       E33C                     RBX0:
00161E E33C 2A8AF0          16      LD  HL,(_DTA)
001621 E33F 225FF0          16      LD  (DTAX),HL
001624 E342 2A5DF0          16      LD  HL,(LEFTX)
001627 E345 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00162A E348 D6FD             7      SUB 0FDH
00162C E34A C9              10      RET
                                
       E34B                     RBX1:               ;ファイルサイズとランダムレコードを比べる
00162D E34B E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
00162E E34C FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
001631 E34F FD6611          19      LD  H,(IY+17)   ;
001634 E352 FD7E12          19      LD  A,(IY+18)   ;
                                
001637 E355 CD84E1          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
00163A E358 A7               4      AND A
00163B E359 ED52            15      SBC HL,DE
00163D E35B 99               4      SBC A,C
00163E E35C 4F               4      LD  C,A
00163F E35D FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
001642 E360 98               4      SBC A,B
001643 E361 D1              10      POP DE
001644 E362 C9              10      RET
       E363                     RBX1R:              ;(8)
001645 E363 47               4      LD  B,A
001646 E364 B1               4      OR  C
001647 E365 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
001648 E366 B2               4      OR  D
001649 E367 B3               4      OR  E
00164A E368 C0              11      RET NZ
00164B E369 37               4      SCF
00164C E36A C9              10      RET
                                
       E36B                     RBX2:               ;Cluster settings
00164D E36B FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001650 E36E FD4E23          19      LD  C,(IY+35)
001653 E371 0600             7      LD  B,0
001655 E373 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001659 E377 2003            12      JR  NZ,RBX3
00165B E379 FD4624          19      LD  B,(IY+36)
       E37C                     RBX3:
00165E E37C CDB0E0          17      CALL    RWXR
001661 E37F 3AA1E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001664 E382 3D               4      DEC A
001665 E383 FDA622          19      AND (IY+34)
001668 E386 FDB621          19      OR  (IY+33)
00166B E389 C9              10      RET
                                
       E38A                     RBXA:
00166C E38A C5              11      PUSH    BC
00166D E38B D5              11      PUSH    DE
00166E E38C CDC4DE          17      CALL    CLUSTX
001671 E38F CD95E4          17      CALL    DRDX
001674 E392 D1              10      POP DE
001675 E393 C1              10      POP BC
001676 E394 D434E6          17      CALL    NC,GNCLX
001679 E397 D8              11      RET C
00167A E398 ED53FEF1        20      LD  (_CLPS),DE
                                
00167E E39C FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
001681 E39F 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       E3A0                     SECSZ   EQU $-2
       E3A1                     SECSZ_H EQU $-1
001684 E3A2 7C               4      LD  A,H
001685 E3A3 3D               4      DEC A       ;1024=3 / 512=1
001686 E3A4 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
001689 E3A7 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
00168A E3A8 ED42            15      SBC HL,BC       ;残りを計算
                                
00168C E3AA ED5B5DF0        20      LD  DE,(LEFTX)
001690 E3AE ED52            15      SBC HL,DE       ;CP HL,DE
001692 E3B0 19              11      ADD HL,DE       ;
001693 E3B1 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
001695 E3B3 EB               4      EX  DE,HL
       E3B4                     RBXA1:
001696 E3B4 E5              11      PUSH    HL
001697 E3B5 2A7EF1          16      LD  HL,(_DTBUF)
00169A E3B8 09              11      ADD HL,BC
00169B E3B9 ED5B5FF0        20      LD  DE,(DTAX)
00169F E3BD C1              10      POP BC
0016A0 E3BE C9              10      RET
                                
       E3BF                     RBXB:
0016A1 E3BF 2A5FF0          16      LD  HL,(DTAX)
0016A4 E3C2 ED5BFEF1        20      LD  DE,(_CLPS)
0016A8 E3C6 3A5EF0          13      LD  A,(LEFTX+1)
0016AB E3C9 47               4      LD  B,A
0016AC E3CA 3AA1E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E3CD                     RBXB1:
0016AF E3CD 1F               4      RRA     ;->CF
0016B0 E3CE 3804            12      JR  C,RBXB2
0016B2 E3D0 CB38             8      SRL B   ;B=B/2
0016B4 E3D2 18F9            12      JR  RBXB1
       E3D4                     RBXB2:
0016B6 E3D4 78               4      LD  A,B
0016B7 E3D5 B7               4      OR  A
0016B8 E3D6 C9              10      RET
                                ;(12)
       E3D7                     RBXC:
0016B9 E3D7 ED4B5DF0        20      LD  BC,(LEFTX)
0016BD E3DB 3AA1E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
0016C0 E3DE 3D               4      DEC A
0016C1 E3DF A0               4      AND B
0016C2 E3E0 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
0016C3 E3E1 B1               4      OR  C
0016C4 E3E2 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E3E3                     DWTC:
0016C5 E3E3 E5              11      PUSH    HL
0016C6 E3E4 21CBE7          10      LD  HL,DWT24B
0016C9 E3E7 1804            12      JR  DWTC1
       E3E9                     DRDC:
0016CB E3E9 E5              11      PUSH    HL
0016CC E3EA 21BDE7          10      LD  HL,DRD24B
       E3ED                     DWTC1:
0016CF E3ED 2247E4          16      LD  (DRWF_MODE),HL
0016D2 E3F0 E1              10      POP HL
0016D3 E3F1 3A37E4          13      LD  A,(DRWF_B)
0016D6 E3F4 B7               4      OR  A
0016D7 E3F5 200F            12      JR  NZ,DRDC1
       E3F7                     SAVE_DRWC:
0016D9 E3F7 0601             7      LD  B,1
0016DB E3F9 ED4336E4        20      LD  (DRWF_C),BC
0016DF E3FD ED533DE4        20      LD  (DRWF_E),DE
0016E3 E401 2240E4          16      LD  (DRWF_HL),HL
0016E6 E404 1820            12      JR  INC_HL_DRWC
       E406                     DRDC1:
0016E8 E406 E5              11      PUSH    HL
0016E9 E407 213DE4          10      LD  HL,DRWF_E
0016EC E40A 86               7      ADD A,(HL)
0016ED E40B F5              11      PUSH    AF
0016EE E40C BB               4      CP  E
0016EF E40D 201D            12      JR  NZ,DRDC2
0016F1 E40F F1              10      POP AF
0016F2 E410 23               6      INC HL
0016F3 E411 7E               7      LD  A,(HL)
0016F4 E412 CE00             7      ADC A,0
0016F6 E414 F5              11      PUSH    AF
0016F7 E415 BA               4      CP  D
0016F8 E416 2014            12      JR  NZ,DRDC2
0016FA E418 F1              10      POP AF
0016FB E419 3A36E4          13      LD  A,(DRWF_C)
0016FE E41C CE00             7      ADC A,0
001700 E41E B9               4      CP  C
001701 E41F 200C            12      JR  NZ,DRDC3
001703 E421 2137E4          10      LD  HL,DRWF_B
001706 E424 34              11      INC (HL)
001707 E425 E1              10      POP HL
       E426                     INC_HL_DRWC:
001708 E426 3AA1E3          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
00170B E429 84               4      ADD A,H
00170C E42A 67               4      LD  H,A
00170D E42B C9              10      RET
       E42C                     DRDC2:
00170E E42C F1              10      POP AF
       E42D                     DRDC3:
00170F E42D CD33E4          17      CALL    DRW_FLUSH
001712 E430 E1              10      POP HL
001713 E431 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E433                     DRW_FLUSH:
001715 E433 C5              11      PUSH    BC
001716 E434 D5              11      PUSH    DE
001717 E435 010000          10      LD  BC,0
       E436                     DRWF_C  EQU $-2
       E437                     DRWF_B  EQU $-1
00171A E438 78               4      LD  A,B
00171B E439 B7               4      OR  A
00171C E43A 280D            12      JR  Z,DRDF1
00171E E43C 110000          10      LD  DE,0
       E43D                     DRWF_E  EQU $-2
       E43E                     DRWF_D  EQU $-1
001721 E43F 210000          10      LD  HL,0
       E440                     DRWF_HL EQU $-2
001724 E442 AF               4      XOR A
001725 E443 3237E4          13      LD  (DRWF_B),A
001728 E446 CDBDE7          17      CALL    DRD24B
       E447                     DRWF_MODE   EQU $-2
       E449                     DRDF1:
00172B E449 D1              10      POP DE
00172C E44A C1              10      POP BC
00172D E44B C9              10      RET
                                
       E44C                     RB_WRITE:
00172E E44C C5              11      PUSH    BC
00172F E44D 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
001731 E44F 1803            12      JR  RBRW
       E451                     RB_READ:
001733 E451 C5              11      PUSH    BC
001734 E452 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       E454                     RBRW:
001736 E454 1F               4      RRA     ;AHL = AHL*128
001737 E455 7C               4      LD  A,H ;AHL = AHL0/2
001738 E456 1F               4      RRA     ;A
001739 E457 65               4      LD  H,L ;
00173A E458 CB1C             8      RR  H   ;H
00173C E45A 2E00             7      LD  L,0 ;
00173E E45C CB1D             8      RR  L   ;L
001740 E45E CD69E1          17      CALL    SET_RR_AHL
001743 E461 218000          10      LD  HL,128
001746 E464 C5              11      PUSH    BC
       E465                     SETSEQ_SWC_RND:
001747 E465 CD98E1          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
00174A E468 C1              10      POP BC
00174B E469 FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
00174F E46D FDE5            15      PUSH    IY
001751 E46F D1              10      POP DE
001752 E470 D5              11      PUSH    DE
001753 E471 CD4ED4          17      CALL    BDOS0
001756 E474 FDE1            14      POP IY
001758 E476 CD73E1          17      CALL    SETSEQ      ;SETSEQ or POPRR
       E477                     SETSEQ_SWC_SEQ_RR   EQU $-2
00175B E479 FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
00175F E47D C1              10      POP BC
001760 E47E C9              10      RET
                                
                                ;(22)
       E47F                     INIT_SEQ:
001761 E47F 3E01             7      LD  A,1     ;LD BC,????
001763 E481 2173E1          10      LD  HL,SETSEQ
001766 E484 CD39E1          17      CALL    PUSHRR
       E487                     GETSEQ:
001769 E487 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
00176C E48A FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
00176F E48D AF               4      XOR A
                                
001770 E48E CB25             8      SLA L   ;L=L*2
                                
001772 E490 CB3C             8      SRL H   ;HL=HL/2
001774 E492 CB1D             8      RR  L   ;
001776 E494 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E495                     DRDX:
001777 E495 CDD3E4          17      CALL    DRDY
00177A E498 C8              11      RET Z
00177B E499 CDB9E4          17      CALL    DRDX1       ;データバッファの情報を保存
00177E E49C D8              11      RET C
00177F E49D E5              11      PUSH    HL
001780 E49E C5              11      PUSH    BC
001781 E49F D5              11      PUSH    DE
001782 E4A0 2A7EF1          16      LD  HL,(_DTBUF)
001785 E4A3 3AFCE4          13      LD  A,(_DBS24)
001788 E4A6 4F               4      LD  C,A
001789 E4A7 CDBBE7          17      CALL    DRD24
00178C E4AA DCCEE4          17      CALL    C,DRDNE
       E4AD                     POP_DE_BC_HL_RET:
00178F E4AD D1              10      POP DE
001790 E4AE C1              10      POP BC
001791 E4AF E1              10      POP HL
001792 E4B0 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E4B1                     DRDN:
001793 E4B1 AF               4      XOR A
001794 E4B2 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
001795 E4B3 30E0            12      JR  NC,DRDX
       E4B5                     DRDNX:
001797 E4B5 CDD3E4          17      CALL    DRDY
00179A E4B8 C8              11      RET Z
       E4B9                     DRDX1:
00179B E4B9 CDE9E4          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
00179E E4BC ED53A6F0        20      LD  (_DBSEC),DE
0017A2 E4C0 79               4      LD  A,C
0017A3 E4C1 32FCE4          13      LD  (_DBS24),A
                                
0017A6 E4C4 3A88F0          13      LD  A,(_DRV)
0017A9 E4C7 32A5F0          13      LD  (_DBDRV),A
0017AC E4CA CDD9F0          17      CALL    _CHGDRV
0017AF E4CD D0              11      RET NC
       E4CE                     DRDNE:
0017B0 E4CE 9F               4      SBC A,A     ;CF=1ならばA=0FFH
0017B1 E4CF 32A5F0          13      LD  (_DBDRV),A
0017B4 E4D2 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E4D3                     DRDY:
0017B5 E4D3 3AFCE4          13      LD  A,(_DBS24)
0017B8 E4D6 B9               4      CP  C
0017B9 E4D7 C0              11      RET NZ
                                
0017BA E4D8 E5              11      PUSH    HL
0017BB E4D9 3A88F0          13      LD  A,(_DRV)
0017BE E4DC 21A5F0          10      LD  HL,_DBDRV
0017C1 E4DF AE               7      XOR (HL)
0017C2 E4E0 2005            12      JR  NZ,POP_HL_RET
                                
0017C4 E4E2 2AA6F0          16      LD  HL,(_DBSEC)
0017C7 E4E5 ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E4E7                     POP_HL_RET:
0017C9 E4E7 E1              10      POP HL
0017CA E4E8 C9              10      RET
                                
       E4E9                     DWTX:
0017CB E4E9 3AA4F0          13      LD  A,(_WTDBF)
0017CE E4EC B7               4      OR  A
0017CF E4ED C8              11      RET Z
0017D0 E4EE AF               4      XOR A
0017D1 E4EF 32A4F0          13      LD  (_WTDBF),A
                                
0017D4 E4F2 E5              11      PUSH    HL
0017D5 E4F3 C5              11      PUSH    BC
0017D6 E4F4 D5              11      PUSH    DE
0017D7 E4F5 3AA5F0          13      LD  A,(_DBDRV)
0017DA E4F8 CDD9F0          17      CALL    _CHGDRV
0017DD E4FB 0E00             7      LD  C,0
       E4FC                     _DBS24  EQU $-1
0017DF E4FD ED5BA6F0        20      LD  DE,(_DBSEC)
0017E3 E501 2A7EF1          16      LD  HL,(_DTBUF)
0017E6 E504 D4C9E7          17      CALL    NC,DWT24
       E507                     POP_DE_BC_HL_RET2:
0017E9 E507 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E509                     RDFATX:
0017EB E509 E5              11      PUSH    HL
0017EC E50A 3A88F0          13      LD  A,(_DRV)
0017EF E50D 21AAF0          10      LD  HL,_FATDRV
0017F2 E510 AE               7      XOR (HL)
0017F3 E511 28D4            12      JR  Z,POP_HL_RET
                                
0017F5 E513 C5              11      PUSH    BC
0017F6 E514 D5              11      PUSH    DE
0017F7 E515 DDE5            15      PUSH    IX
0017F9 E517 CD33E5          17      CALL    WTFATX
0017FC E51A 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
0017FE E51C AF               4      XOR A
0017FF E51D 32ABF0          13      LD  (_FATIX),A
001802 E520 3A88F0          13      LD  A,(_DRV)
001805 E523 32AAF0          13      LD  (_FATDRV),A
001808 E526 CDE5F0          17      CALL    _RDFAT
       E529                     RDFATE2:
00180B E529 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
00180D E52B 9F               4      SBC A,A     ;A=0xFF
00180E E52C 32AAF0          13      LD  (_FATDRV),A
       E52F                     POP_IX_DE_BC_HL_RET:
001811 E52F DDE1            14      POP IX
001813 E531 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E533                     WTFATX:
001815 E533 3AA2F0          13      LD  A,(_WTFATF)
001818 E536 B7               4      OR  A
001819 E537 C8              11      RET Z
00181A E538 AF               4      XOR A
00181B E539 32A2F0          13      LD  (_WTFATF),A
                                
00181E E53C E5              11      PUSH    HL
00181F E53D 3AAAF0          13      LD  A,(_FATDRV)
001822 E540 21A5F0          10      LD  HL,_DBDRV
001825 E543 AE               7      XOR (HL)
001826 E544 CCE9E4          17      CALL    Z,DWTX
001829 E547 389E            12      JR  C,POP_HL_RET
00182B E549 C5              11      PUSH    BC
00182C E54A D5              11      PUSH    DE
00182D E54B DDE5            15      PUSH    IX
00182F E54D CDDAE7          17      CALL    FATSETUP
001832 E550 D4CBE7          17      CALL    NC,DWT24B
001835 E553 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E555                     N16CL1:
001837 E555 7A               4      LD  A,D
001838 E556 B3               4      OR  E
001839 E557 37               4      SCF
00183A E558 C8              11      RET Z
                                
00183B E559 7A               4      LD  A,D
00183C E55A 1807            12      JR  NCL1X
       E55C                     NCL1:
00183E E55C 7A               4      LD  A,D
00183F E55D B3               4      OR  E
001840 E55E 37               4      SCF
001841 E55F C8              11      RET Z
                                
001842 E560 7A               4      LD  A,D
001843 E561 CB3F             8      SRL A   ;/2
       E563                     NCL1X:
001845 E563 CB3F             8      SRL A   ;/2
                                
001847 E565 E5              11      PUSH    HL
001848 E566 3285E5          13      LD  (NCLPAT_FATIX),A    ;_FATIX
00184B E569 2AAAF0          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
00184E E56C BC               4      CP  H
00184F E56D 3A88F0          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001852 E570 3284E5          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001855 E573 2005            12      JR  NZ,NCL2     ;FATIXが違う
001857 E575 BD               4      CP  L
001858 E576 2002            12      JR  NZ,NCL2     ;ドライブが違う
00185A E578 E1              10      POP HL
00185B E579 C9              10      RET
       E57A                     NCL2:
00185C E57A C5              11      PUSH    BC
00185D E57B D5              11      PUSH    DE
00185E E57C DDE5            15      PUSH    IX
001860 E57E CD33E5          17      CALL    WTFATX
001863 E581 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
001865 E583 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E585                     NCLPAT_FATIX    EQU $-1
       E584                     NCLPAT_FATDRV   EQU $-2
001868 E586 ED43AAF0        20      LD  (_FATDRV),BC
00186C E58A CDAFE7          17      CALL    RDFATS
00186F E58D 189A            12      JR  RDFATE2
                                
       E58F                     NCL3:
001871 E58F CB9A             8      RES 3,D
001873 E591 CB92             8      RES 2,D
001875 E593 6B               4      LD  L,E
001876 E594 62               4      LD  H,D
001877 E595 CB3C             8      SRL H   ;
001879 E597 CB1D             8      RR  L   ;HLA=HLA/2
00187B E599 1F               4      RRA     ;
00187C E59A F5              11      PUSH    AF
00187D E59B 3AABF0          13      LD  A,(_FATIX)
001880 E59E 0F               4      RRCA
001881 E59F 300B            12      JR  NC,NCL3X1
001883 E5A1 3AA1E3          13      LD  A,(SECSZ_H)
001886 E5A4 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの際に先頭を512バイトずらす
001888 E5A6 2004            12      JR  NZ,NCL3X1
00188A E5A8 010002          10      LD  BC,512
00188D E5AB 09              11      ADD HL,BC
       E5AC                     NCL3X1:
00188E E5AC F1              10      POP AF
00188F E5AD ED4B7CF1        20      LD  BC,(_FATBF)
001893 E5B1 19              11      ADD HL,DE
001894 E5B2 09              11      ADD HL,BC
001895 E5B3 17               4      RLA
001896 E5B4 C9              10      RET
                                
       E5B5                     GNCL:
001897 E5B5 CD5CE5          17      CALL    NCL1        ;GET NEXT CLUSTER
00189A E5B8 D8              11      RET C
00189B E5B9 C5              11      PUSH    BC
00189C E5BA E5              11      PUSH    HL
00189D E5BB CD8FE5          17      CALL    NCL3
0018A0 E5BE 3809            12      JR  C,GNC1
0018A2 E5C0 5E               7      LD  E,(HL)
0018A3 E5C1 23               6      INC HL
0018A4 E5C2 7E               7      LD  A,(HL)
0018A5 E5C3 E60F             7      AND 00FH
0018A7 E5C5 57               4      LD  D,A
0018A8 E5C6 E1              10      POP HL
0018A9 E5C7 C1              10      POP BC
0018AA E5C8 C9              10      RET
       E5C9                     GNC1:
0018AB E5C9 7E               7      LD  A,(HL)
0018AC E5CA 23               6      INC HL
0018AD E5CB 56               7      LD  D,(HL)
0018AE E5CC 0604             7      LD  B,4
       E5CE                     GNC1L:
0018B0 E5CE CB3A             8      SRL D   ;DA=DA/2
0018B2 E5D0 1F               4      RRA     ;
0018B3 E5D1 10FB            13      DJNZ    GNC1L
                                
0018B5 E5D3 5F               4      LD  E,A
0018B6 E5D4 E1              10      POP HL
0018B7 E5D5 C1              10      POP BC
0018B8 E5D6 A7               4      AND A
0018B9 E5D7 C9              10      RET
                                
       E5D8                     SNCL:
0018BA E5D8 CD5CE5          17      CALL    NCL1
0018BD E5DB D8              11      RET C
                                ;               SET NEXT CLUSTER
0018BE E5DC E5              11      PUSH    HL
0018BF E5DD C5              11      PUSH    BC
0018C0 E5DE D5              11      PUSH    DE
0018C1 E5DF E5              11      PUSH    HL
0018C2 E5E0 CD8FE5          17      CALL    NCL3
0018C5 E5E3 D1              10      POP DE
                                ;CF=ODD
0018C6 E5E4 7E               7      LD  A,(HL)
0018C7 E5E5 73               7      LD  (HL),E
0018C8 E5E6 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
0018CA E5E8 23               6      INC HL
0018CB E5E9 ED67            18      RRD     ;M={A[3:0],E[3:0]}
0018CD E5EB 7A               4      LD  A,D
0018CE E5EC 1804            12      JR  SNC11
       E5EE                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
0018D0 E5EE ED6F            18      RLD     ;M={D[3:0],E[7:4]}
0018D2 E5F0 23               6      INC HL
0018D3 E5F1 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E5F2                     SNC11:
0018D4 E5F2 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
0018D6 E5F4 B7               4      OR  A
0018D7 E5F5 D1              10      POP DE
0018D8 E5F6 C1              10      POP BC
0018D9 E5F7 E1              10      POP HL
       E5F8                     FAT_CHANGED:
0018DA E5F8 3EFF             7      LD  A,0FFH
0018DC E5FA 32A2F0          13      LD  (_WTFATF),A
0018DF E5FD C9              10      RET
                                
       E5FE                     N16CL3:
0018E0 E5FE C5              11      PUSH    BC
0018E1 E5FF 6B               4      LD  L,E
0018E2 E600 7A               4      LD  A,D
0018E3 E601 E601             7      AND 1
0018E5 E603 67               4      LD  H,A
0018E6 E604 29              11      ADD HL,HL
0018E7 E605 ED4B7CF1        20      LD  BC,(_FATBF)
0018EB E609 09              11      ADD HL,BC
0018EC E60A C1              10      POP BC
0018ED E60B C9              10      RET
                                
       E60C                     GNCL16:
0018EE E60C CD55E5          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
0018F1 E60F D8              11      RET C
0018F2 E610 E5              11      PUSH    HL
0018F3 E611 CDFEE5          17      CALL    N16CL3
0018F6 E614 5E               7      LD  E,(HL)
0018F7 E615 23               6      INC HL
0018F8 E616 56               7      LD  D,(HL)
0018F9 E617 E1              10      POP HL
0018FA E618 C9              10      RET
                                
       E619                     SNCL16:
0018FB E619 CD55E5          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
0018FE E61C D8              11      RET C
0018FF E61D D5              11      PUSH    DE
001900 E61E E5              11      PUSH    HL
001901 E61F CDFEE5          17      CALL    N16CL3
001904 E622 D1              10      POP DE      ;HL
001905 E623 73               7      LD  (HL),E
001906 E624 23               6      INC HL
001907 E625 72               7      LD  (HL),D
001908 E626 6B               4      LD  L,E
001909 E627 62               4      LD  H,D
00190A E628 D1              10      POP DE
00190B E629 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E62B                     NEXTX:
00190D E62B 3E00             7      LD  A,0 ;自己書き換え
       E62C                     _SECPS  EQU $-1
00190F E62D 3C               4      INC A
001910 E62E E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E62F                     _NCPAT  EQU $-1
001912 E630 322CE6          13      LD  (_SECPS),A
001915 E633 C9              10      RET
                                
       E634                     GNCLX:
001916 E634 CD2BE6          17      CALL    NEXTX
001919 E637 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
00191A E638 C3F7F0          10      JP  _GNCL   ;次のクラスタを探す
                                
       E63B                     RDFAT:
00191D E63B 3E80             7      LD  A,080H
00191F E63D 3270F0          13      LD  (CHECK),A
       E640                     RDFAT1:
001922 E640 3A88F0          13      LD  A,(_DRV)
001925 E643 CDE3E8          17      CALL    CHGDRVR
001928 E646 D8              11      RET C
001929 E647 DD7E12          19      LD  A,(IX+DPB_DEVICE)
00192C E64A CB6F             8      BIT 5,A
00192E E64C 286C            12      JR  Z,RDFAT0X
001930 E64E 2170F0          10      LD  HL,CHECK
001933 E651 A6               7      AND (HL)
001934 E652 77               7      LD  (HL),A
001935 E653 110000          10      LD  DE,0        ;BPB
001938 E656 2A7CF1          16      LD  HL,(_FATBF)
00193B E659 0E00             7      LD  C,0
00193D E65B CDBBE7          17      CALL    DRD24
001940 E65E 3022            12      JR  NC,GETBPB
001942 E660 2170F0          10      LD  HL,CHECK
001945 E663 CB06            15      RLC (HL)
001947 E665 3F               4      CCF
001948 E666 D8              11      RET C
001949 E667 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
00194D E66B 3F               4      CCF         ;フロッピーディスクのFDモード(2D/2HD)を切り替える
00194E E66C DDCB0A16        23      RL  (IX+DPB_FDMODE)
001952 E670 3A84F0          13      LD  A,(_DRIVE)
001955 E673 E603             7      AND 3
001957 E675 F680             7      OR  080H
001959 E677 6F               4      LD  L,A
00195A E678 26F0             7      LD  H,_CYL0/256
00195C E67A 3EFF             7      LD  A,0FFH
00195E E67C 3289F0          13      LD  (_DSK),A
001961 E67F 77               7      LD  (HL),A
001962 E680 18BE            12      JR  RDFAT1
       E682                     GETBPB:
001964 E682 FDE5            15      PUSH    IY
001966 E684 FD2A7CF1        20      LD  IY,(_FATBF) ;BPB
00196A E688 CDF1F0          17      CALL    _BPB2DPB
00196D E68B FDE1            14      POP IY
00196F E68D DD7E12          19      LD  A,(IX+DPB_DEVICE)
001972 E690 3025            12      JR  NC,GETBPBOK
001974 E692 E60F             7      AND 00FH
001976 E694 FE07             7      CP  7
001978 E696 37               4      SCF
001979 E697 C0              11      RET NZ
00197A E698 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
00197E E69C 21C0F1          10      LD  HL,M2D
001981 E69F 2006            12      JR  NZ,SETFDMODE
001983 E6A1 CD94E7          17      CALL    CHECK1024
001986 E6A4 D8              11      RET C
001987 E6A5 2ED2             7      LD  L,M2HD-STABLE
       E6A7                     SETFDMODE:
001989 E6A7 DDE5            15      PUSH    IX
00198B E6A9 D1              10      POP DE
00198C E6AA EDA0            16      LDI
00198E E6AC EDA0            16      LDI
001990 E6AE 13               6      INC DE
001991 E6AF 13               6      INC DE
001992 E6B0 13               6      INC DE
001993 E6B1 13               6      INC DE
001994 E6B2 010C00          10      LD  BC,12
001997 E6B5 EDB0                    LDIR
       E6B7                     GETBPBOK:
001999 E6B7 CD4FE8          17      CALL    CHGDRV2
       E6BA                     RDFAT0X:
00199C E6BA CDAFE7          17      CALL    RDFATS
00199F E6BD D8              11      RET C
0019A0 E6BE DDAE06          19      XOR (IX+DPB_FATID)
0019A3 E6C1 C8              11      RET Z
0019A4 E6C2 DD7E12          19      LD  A,(IX+DPB_DEVICE)
0019A7 E6C5 CB5F             8      BIT 3,A
0019A9 E6C7 2803            12      JR  Z,RDFAT0X1
0019AB E6C9 CB6F             8      BIT 5,A
0019AD E6CB C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E6CC                     RDFAT0X1:
0019AE E6CC 37               4      SCF
0019AF E6CD C9              10      RET
                                
       E6CE                     POP_HL_SCF_RET:
0019B0 E6CE E1              10      POP HL
0019B1 E6CF 37               4      SCF
0019B2 E6D0 C9              10      RET
                                
       E6D1                     BPB2DPB:
0019B3 E6D1 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
0019B6 E6D4 B7               4      OR  A
0019B7 E6D5 37               4      SCF
0019B8 E6D6 C0              11      RET NZ
       E6D7                     BPBOK:
0019B9 E6D7 FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
0019BC E6DA DD7707          19      LD  (IX+DPB_SECPCL),A
                                
0019BF E6DD FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
0019C2 E6E0 DD7700          19      LD  (IX+DPB_FATLN),A
0019C5 E6E3 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
0019C8 E6E6 DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
0019CB E6E9 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
0019CE E6EC FD660F          19      LD  H,(IY+15)
0019D1 E6EF DD750E          19      LD  (IX+DPB_FATPS),L
0019D4 E6F2 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
0019D7 E6F5 FD5617          19      LD  D,(IY+23)
0019DA E6F8 FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E6FB                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
0019DD E6FB 19              11      ADD HL,DE
0019DE E6FC 10FD            13      DJNZ    BPBDP1
       E6FE                     BPBDP2:
0019E0 E6FE DD7510          19      LD  (IX+DPB_DIRPS),L
0019E3 E701 DD7411          19      LD  (IX+DPB_DIRPS+1),H
0019E6 E704 E5              11      PUSH    HL
                                
0019E7 E705 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
0019EA E708 FD6612          19      LD  H,(IY+18)
0019ED E70B FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
0019F0 E70E B7               4      OR  A
0019F1 E70F 28BD            12      JR  Z,POP_HL_SCF_RET
0019F3 E711 0606             7      LD  B,6
       E713                     BPBBPS1:
0019F5 E713 05               4      DEC B
0019F6 E714 0F               4      RRCA
0019F7 E715 30FC            12      JR  NC,BPBBPS1
       E717                     BPBDE1:
0019F9 E717 29              11      ADD HL,HL
0019FA E718 10FD            13      DJNZ    BPBDE1
                                
0019FC E71A 7C               4      LD  A,H
0019FD E71B DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
001A00 E71E D1              10      POP DE      ;DPB_DIRPS
001A01 E71F 6C               4      LD  L,H
001A02 E720 2600             7      LD  H,0
001A04 E722 19              11      ADD HL,DE       ;MAXDIR
001A05 E723 E5              11      PUSH    HL
001A06 E724 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001A09 E727 CB21             8      SLA C       ;*2
001A0B E729 AF               4      XOR A
001A0C E72A 47               4      LD  B,A
001A0D E72B ED42            15      SBC HL,BC
001A0F E72D DD7514          19      LD  (IX+DPB_ADDCL),L
001A12 E730 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
001A15 E733 D1              10      POP DE      ;DE=DPB_MAXDIR
001A16 E734 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001A19 E737 FD6614          19      LD  H,(IY+20)
                                
001A1C E73A DD7E12          19      LD  A,(IX+DPB_DEVICE)
001A1F E73D E60F             7      AND 00FH
001A21 E73F FE07             7      CP  7       ;フロッピー
001A23 E741 2019            12      JR  NZ,NOT_FD
001A25 E743 E5              11      PUSH    HL
001A26 E744 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001A29 E747 DD710D          19      LD  (IX+DPB_MAXSEC),C
001A2C E74A AF               4      XOR A
001A2D E74B CB21             8      SLA C       ;両面なのでセクタ数を２倍
001A2F E74D 0610             7      LD  B,16
       E74F                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001A31 E74F 29              11      ADD HL,HL
001A32 E750 17               4      RLA
001A33 E751 B9               4      CP  C
001A34 E752 3802            12      JR  C,DIVSEC1
001A36 E754 91               4      SUB C
001A37 E755 2C               4      INC L
       E756                     DIVSEC1:
001A38 E756 10F7            13      DJNZ    DIVSEC
001A3A E758 DD750C          19      LD  (IX+DPB_MAXCYL),L
001A3D E75B E1              10      POP HL  ;ここまでフロッピー専用
       E75C                     NOT_FD:
001A3E E75C 7C               4      LD  A,H
001A3F E75D B5               4      OR  L
001A40 E75E 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001A42 E760 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001A44 E762 2F               4      CPL         ;A=0FFH
001A45 E763 FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001A48 E766 D8              11      RET C
001A49 E767 FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001A4C E76A FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001A4F E76D FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E770                     BPB16BIT:
001A52 E770 ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001A54 E772 DE00             7      SBC A,0
001A56 E774 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E777                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001A59 E777 CB18             8      RR  B       ;->CY
001A5B E779 3808            12      JR  C,BPBTC2
001A5D E77B CB3F             8      SRL A
001A5F E77D CB1C             8      RR  H       ;AHL=AHL/2
001A61 E77F CB1D             8      RR  L
001A63 E781 18F4            12      JR  BPBTC1
       E783                     BPBTC2:
001A65 E783 C6FF             7      ADD A,0FFH
001A67 E785 D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001A68 E786 23               6      INC HL
001A69 E787 23               6      INC HL
001A6A E788 DD7508          19      LD  (IX+DPB_MAXCL),L
001A6D E78B DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001A70 E78E FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001A73 E791 DD7706          19      LD  (IX+DPB_FATID),A
       E794                     CHECK1024:
001A76 E794 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001A79 E797 C6FE             7      ADD A,0-2       ;>2:CF=1
001A7B E799 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001A7E E79C 6F               4      LD  L,A
001A7F E79D 3002            12      JR  NC,BPBFAT1
001A81 E79F F680             7      OR  080H
       E7A1                     BPBFAT1:            ;ここではCF=0
001A83 E7A1 DD770F          19      LD  (IX+DPB_BPS),A
001A86 E7A4 3A7BF1          13      LD  A,(_MAX_SEC_SZ_H)
001A89 E7A7 BD               4      CP  L
001A8A E7A8 C8              11      RET Z       ;1セクタ1024バイト
001A8B E7A9 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001A8C E7AA C8              11      RET Z       ;1セクタ256バイト
001A8D E7AB 2D               4      DEC L
001A8E E7AC C8              11      RET Z       ;1セクタ512バイト
001A8F E7AD 37               4      SCF
001A90 E7AE C9              10      RET
                                
       E7AF                     RDFATS:
001A91 E7AF CDDAE7          17      CALL    FATSETUP
001A94 E7B2 D8              11      RET C
001A95 E7B3 CDBDE7          17      CALL    DRD24B
001A98 E7B6 2A7CF1          16      LD  HL,(_FATBF)
001A9B E7B9 7E               7      LD  A,(HL)
001A9C E7BA C9              10      RET
                                
       E7BB                     DRD24:
001A9D E7BB 0601             7      LD  B,1
       E7BD                     DRD24B:
001A9F E7BD DDE5            15      PUSH    IX
001AA1 E7BF DD2AA8F0        20      LD  IX,(_DPB)
001AA5 E7C3 CD23EA          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E7C4                     DRDPAT  EQU $-2
001AA8 E7C6 DDE1            14      POP IX
001AAA E7C8 C9              10      RET
                                
       E7C9                     DWT24:
001AAB E7C9 0601             7      LD  B,1
       E7CB                     DWT24B:
001AAD E7CB DDE5            15      PUSH    IX
001AAF E7CD DD2AA8F0        20      LD  IX,(_DPB)
001AB3 E7D1 CDCCE9          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E7D2                     DWTPAT  EQU $-2
001AB6 E7D4 DDE1            14      POP IX
001AB8 E7D6 D0              11      RET NC
001AB9 E7D7 C35AF0          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E7DA                     FATSETUP:
001ABC E7DA 3AAAF0          13      LD  A,(_FATDRV)
001ABF E7DD CDE3E8          17      CALL    CHGDRVR     ;ドライブ切り替え
001AC2 E7E0 D8              11      RET C
       E7E1                     FATS2:
001AC3 E7E1 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001AC6 E7E4 0F               4      RRCA
001AC7 E7E5 CD15E8          17      CALL    FATSETUP12  ;自己書き換え
       E7E6                     FATSX   EQU $-2
001ACA E7E8 210000          10      LD  HL,0
001ACD E7EB 4A               4      LD  C,D
001ACE E7EC 54               4      LD  D,H
001ACF E7ED 3AABF0          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
001AD2 E7F0 47               4      LD  B,A
001AD3 E7F1 04               4      INC B
001AD4 E7F2 DD7E00          19      LD  A,(IX+DPB_FATLN)
       E7F5                     FAT_SKP:
001AD7 E7F5 05               4      DEC B
001AD8 E7F6 2809            12      JR  Z,FAT1
001ADA E7F8 19              11      ADD HL,DE
001ADB E7F9 93               4      SUB E
001ADC E7FA 30F9            12      JR  NC,FAT_SKP
001ADE E7FC DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
001AE2 E800 C8              11      RET Z
       E801                     FAT1:
001AE3 E801 EB               4      EX  DE,HL
001AE4 E802 B7               4      OR  A       ;0の場合は0100Hとして扱う
001AE5 E803 2803            12      JR  Z,FAT3
001AE7 E805 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001AE8 E806 3801            12      JR  C,FAT2
       E808                     FAT3:
001AEA E808 79               4      LD  A,C
       E809                     FAT2:
001AEB E809 47               4      LD  B,A
                                
001AEC E80A 2AFAF1          16      LD  HL,(_FATPS) ;fat sector pos
001AEF E80D 19              11      ADD HL,DE
001AF0 E80E EB               4      EX  DE,HL
001AF1 E80F 2A7CF1          16      LD  HL,(_FATBF)
001AF4 E812 AF               4      XOR A       ;CF=0
001AF5 E813 4F               4      LD  C,A
001AF6 E814 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E815                     FATSETUP12:
001AF7 E815 110606          10      LD  DE,0606H    ;256
001AFA E818 D8              11      RET C
001AFB E819 110303          10      LD  DE,0303H    ;512
001AFE E81C 0F               4      RRCA
001AFF E81D D8              11      RET C
001B00 E81E 110102          10      LD  DE,0201H    ;1024
001B03 E821 C9              10      RET
                                
       E822                     FATSETUP16:
001B04 E822 110404          10      LD  DE,0404H    ;256
001B07 E825 D8              11      RET C
001B08 E826 110202          10      LD  DE,0202H    ;512
001B0B E829 0F               4      RRCA
001B0C E82A D8              11      RET C
001B0D E82B 110101          10      LD  DE,0101H    ;1024
001B10 E82E C9              10      RET
                                
       E82F                     CHGDRV:
001B11 E82F E5              11      PUSH    HL
001B12 E830 2189F0          10      LD  HL,_DSK
001B15 E833 BE               7      CP  (HL)
001B16 E834 280A            12      JR  Z,CHGDRVE
       E836                     CHGDRV1:
001B18 E836 DDE5            15      PUSH    IX
001B1A E838 CD42E8          17      CALL    CHGDRV0
001B1D E83B 3A89F0          13      LD  A,(_DSK)
001B20 E83E DDE1            14      POP IX
       E840                     CHGDRVE:
001B22 E840 E1              10      POP HL
001B23 E841 C9              10      RET
                                
       E842                     CHGDRV0:
001B24 E842 6F               4      LD  L,A
001B25 E843 CDDCF0          17      CALL    _GETDPB
001B28 E846 D8              11      RET C
001B29 E847 DD22A8F0        20      LD  (_DPB),IX
001B2D E84B 7D               4      LD  A,L
001B2E E84C 3289F0          13      LD  (_DSK),A
       E84F                     CHGDRV2:
001B31 E84F C5              11      PUSH    BC
001B32 E850 D5              11      PUSH    DE
001B33 E851 ED739AE8        20      LD  (SPPAT2),SP
001B37 E855 F3               4      DI
001B38 E856 DDF9            10      LD  SP,IX
                                
001B3A E858 E1              10      POP HL      ;00:DPB_FATLN
001B3B E859 E1              10      POP HL      ;02:DPB_DRD
001B3C E85A 22C4E7          16      LD  (DRDPAT),HL
                                
001B3F E85D E1              10      POP HL
001B40 E85E 22D2E7          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001B43 E861 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001B44 E862 7C               4      LD  A,H
001B45 E863 32C8DE          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001B48 E866 3D               4      DEC A
001B49 E867 322FE6          13      LD  (_NCPAT),A
                                
001B4C E86A E1              10      POP HL      ;08:DPB_MAXCL
001B4D E86B 7D               4      LD  A,L
001B4E E86C 32E7DE          13      LD  (CLPAT2),A
001B51 E86F 7C               4      LD  A,H
001B52 E870 32E3DE          13      LD  (CLPAT1),A
001B55 E873 2B               6      DEC HL
001B56 E874 22E6E0          16      LD  (MAXCLP),HL
                                
001B59 E877 E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001B5A E878 4C               4      LD  C,H
                                
001B5B E879 E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001B5C E87A E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001B5D E87B 7C               4      LD  A,H     ;DPB_BPS
001B5E E87C E607             7      AND 7
001B60 E87E 32A1E3          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001B63 E881 87               4      ADD A,A     ;8  4   2
001B64 E882 87               4      ADD A,A     ;010H   8   4
001B65 E883 87               4      ADD A,A     ;020H   010H    8
001B66 E884 3246DD          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001B69 E887 2600             7      LD  H,0
001B6B E889 22FAF1          16      LD  (_FATPS),HL
                                
001B6E E88C E1              10      POP HL      ;10:DPB_DIRPS
001B6F E88D 22FCF1          16      LD  (_DIRPS),HL
                                
001B72 E890 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001B73 E891 7C               4      LD  A,H
001B74 E892 3284F0          13      LD  (_DRIVE),A
                                
001B77 E895 E1              10      POP HL      ;14:DPB_ADDCL
001B78 E896 22D8DE          16      LD  (CLSPAT),HL
                                
001B7B E899 310000          10      LD  SP,0        ;元のSPを復元
       E89A                     SPPAT2  EQU $-2
001B7E E89C FB               4      EI
001B7F E89D 2AFCF1          16      LD  HL,(_DIRPS)
001B82 E8A0 0600             7      LD  B,0
001B84 E8A2 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001B85 E8A3 2261DD          16      LD  (MD_PAT),HL
                                
001B88 E8A6 2AE6E0          16      LD  HL,(MAXCLP)
001B8B E8A9 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001B8E E8AC 19              11      ADD HL,DE
001B8F E8AD 380F            12      JR  C,SETFAT16
001B91 E8AF 21B5E5          10      LD  HL,GNCL     ;FAT12
001B94 E8B2 11D8E5          10      LD  DE,SNCL
001B97 E8B5 0115E8          10      LD  BC,FATSETUP12
001B9A E8B8 DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001B9E E8BC 180D            12      JR  EXTRA1
       E8BE                     SETFAT16:
001BA0 E8BE 210CE6          10      LD  HL,GNCL16   ;FAT16
001BA3 E8C1 1119E6          10      LD  DE,SNCL16
001BA6 E8C4 0122E8          10      LD  BC,FATSETUP16
001BA9 E8C7 DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       E8CB                     EXTRA1:
001BAD E8CB 22F8F0          16      LD  (GNCPAT),HL
001BB0 E8CE ED53FBF0        20      LD  (SNCPAT),DE
001BB4 E8D2 ED43E6E7        20      LD  (FATSX),BC
001BB8 E8D6 D1              10      POP DE
001BB9 E8D7 C1              10      POP BC
001BBA E8D8 AF               4      XOR A
001BBB E8D9 C9              10      RET
                                
       E8DA                     GETDPBD:
001BBC E8DA DDE3            23      EX  (SP),IX
001BBE E8DC DDE5            15      PUSH    IX
001BC0 E8DE 3A88F0          13      LD  A,(_DRV)
001BC3 E8E1 1807            12      JR  GETDPB1
                                
       E8E3                     CHGDRVR:
001BC5 E8E3 CDD9F0          17      CALL    _CHGDRV
001BC8 E8E6 D8              11      RET C
001BC9 E8E7 3A89F0          13      LD  A,(_DSK)
       E8EA                     GETDPB1:
001BCC E8EA C3DCF0          10      JP  _GETDPB
                                
       E8ED                     GETDPB:
001BCF E8ED FE08             7      CP  8
001BD1 E8EF 3F               4      CCF
001BD2 E8F0 D8              11      RET C
001BD3 E8F1 0F               4      RRCA
001BD4 E8F2 0F               4      RRCA
001BD5 E8F3 0F               4      RRCA
001BD6 E8F4 DD                      DB  0DDH        ;Z80未定義命令
001BD7 E8F5 6F               4      LD  L,A     ;LD IXL,A
001BD8 E8F6 DD                      DB  0DDH        ;Z80未定義命令
001BD9 E8F7 26F2             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001BDB E8F9 DD7E00          19      LD  A,(IX+DPB_FATLN)
001BDE E8FC A7               4      AND A       ;CF=0の為
001BDF E8FD DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001BE3 E901 C0              11      RET NZ      ;FAT16
001BE4 E902 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001BE8 E906 C0              11      RET NZ      ;BPB
001BE9 E907 FE01             7      CP  001H        ;A=0 THEN CF=1
001BEB E909 C9              10      RET
                                
       E90A                     _SYS5F:
001BEC E90A AF               4      XOR A
       E90B                     FFLUSH:
001BED E90B F5              11      PUSH    AF
001BEE E90C CD33E5          17      CALL    WTFATX
001BF1 E90F AF               4      XOR A
001BF2 E910 32ABF0          13      LD  (_FATIX),A
001BF5 E913 2F               4      CPL         ;0FFH
001BF6 E914 32AAF0          13      LD  (_FATDRV),A
001BF9 E917 3E                      DB  03EH        ;次のPUSH AFをスキップ
       E918                     FFLUSHBUF:
001BFA E918 F5              11      PUSH    AF
001BFB E919 CDE9E4          17      CALL    DWTX
001BFE E91C 3EFF             7      LD  A,0FFH
001C00 E91E 3239F0          13      LD  (SFILE),A
001C03 E921 32A5F0          13      LD  (_DBDRV),A
001C06 E924 F1              10      POP AF
001C07 E925 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MZ-700/1500
                                
       E926                     SEEK:
001C08 E926 0610             7      LD  B,16
001C0A E928 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001C0D E92B AF               4      XOR A
001C0E E92C EB               4      EX  DE,HL
       E92D                     DIV1:
001C0F E92D 29              11      ADD HL,HL
001C10 E92E 8F               4      ADC A,A
001C11 E92F B9               4      CP  C
001C12 E930 3802            12      JR  C,DIV2
001C14 E932 91               4      SUB C
001C15 E933 2C               4      INC L
       E934                     DIV2:
001C16 E934 10F7            13      DJNZ    DIV1
                                
001C18 E936 3C               4      INC A   ;最小のセクタは１固定
001C19 E937 55               4      LD  D,L ;TRACK
001C1A E938 5F               4      LD  E,A ;SECTOR
                                
001C1B E939 3A84F0          13      LD  A,(_DRIVE)
001C1E E93C FE04             7      CP  4
001C20 E93E 3F               4      CCF
001C21 E93F D8              11      RET C
001C22 E940 F684             7      OR  084H        ;Motor on + ドライブセレクト有効
001C24 E942 D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001C26 E944 CB3A             8      SRL D       ;CYLINDER
001C28 E946 9F               4      SBC A,A
001C29 E947 D3DD            11      OUT (0DDH),A    ;ヘッドセレクト制御レジスタ
                                
001C2B E949 CD81E9          17      CALL    SETMODE
001C2E E94C D8              11      RET C
                                
001C2F E94D CDB6E9          17      CALL    DRIVE
001C32 E950 FEFF             7      CP  0FFH        ;A=0FFH Unknown CYLINDER
001C34 E952 CC98E9          17      CALL    Z,FDCRES    ;Restore
001C37 E955 2F               4      CPL         ;データバスが負論理
001C38 E956 D3D9            11      OUT (0D9H),A    ;MB8876 トラックレジスタ
001C3A E958 2F               4      CPL         ;データバスが負論理
001C3B E959 92               4      SUB D
001C3C E95A C8              11      RET Z       ;No seek
                                
001C3D E95B DD7E0C          19      LD  A,(IX+DPB_MAXCYL)
001C40 E95E 3D               4      DEC A
001C41 E95F BA               4      CP  D       ;Over CYLINDER
001C42 E960 D8              11      RET C
                                
001C43 E961 7A               4      LD  A,D
001C44 E962 2F               4      CPL         ;データバスが負論理
001C45 E963 D3DB            11      OUT (0DBH),A    ;MB8876 データレジスタ
001C47 E965 72               7      LD  (HL),D
                                
001C48 E966 0E18             7      LD  C,018H      ;FDC TypeIコマンド Seek
       E968                     FDCCMD2:
001C4A E968 3A85F0          13      LD  A,(_SEEKSP)
001C4D E96B B1               4      OR  C
                                
       E96C                     FDCCMD:
001C4E E96C CDADE9          17      CALL    COMSET
001C51 E96F 3E80             7      LD  A,080H      ;FDC COMMAND(Self-modifying code)
       E970                     FDCSMC  EQU $-1
001C53 E971 E620             7      AND 020H        ;Write data Write track
001C55 E973 3C               4      INC A
                                
       E974                     SST:
001C56 E974 0E00             7      LD  C,0
       E976                     SST1:
001C58 E976 0D               4      DEC C       ; 4
001C59 E977 20FD            12      JR  NZ,SST1     ;12 * 256 / 4 = About 1ms
001C5B E979 3D               4      DEC A
001C5C E97A 20FA            12      JR  NZ,SST1
                                
001C5E E97C 0E01             7      LD  C,1
001C60 E97E CD86E9          17      CALL    READY
       E981                     SETMODE:
001C63 E981 CDB0E9          17      CALL    DELAY0      ;Head select time
001C66 E984 0E81             7      LD  C,081H
       E986                     READY:
001C68 E986 0680             7      LD  B,128
       E988                     READY2:
001C6A E988 DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001C6C E98A 2F               4      CPL         ;データバスが負論理
001C6D E98B A1               4      AND C       ;NOT READY,BUSY
001C6E E98C C8              11      RET Z
001C6F E98D CD4FCF          17      CALL    RD556VSYNC
001C72 E990 07               4      RLCA
001C73 E991 A8               4      XOR B
001C74 E992 0F               4      RRCA
001C75 E993 30F3            12      JR  NC,READY2
001C77 E995 10F1            13      DJNZ    READY2
001C79 E997 C9              10      RET
                                
       E998                     FDCRES:
001C7A E998 3600            10      LD  (HL),0
001C7C E99A 0E08             7      LD  C,8     ;FDC TypeIコマンド Restore
001C7E E99C 18CA            12      JR  FDCCMD2
                                
       E99E                     FDMOFF:
001C80 E99E F5              11      PUSH    AF
001C81 E99F AF               4      XOR A       ;Motor off(ドライブセレクト無効)
001C82 E9A0 D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001C84 E9A2 F1              10      POP AF
001C85 E9A3 C9              10      RET
                                
       E9A4                     SECSET_FDCCMD:
001C86 E9A4 3A70E9          13      LD  A,(FDCSMC)
       E9A7                     SECSET:
001C89 E9A7 F5              11      PUSH    AF
001C8A E9A8 7B               4      LD  A,E
001C8B E9A9 2F               4      CPL         ;データバスが負論理
001C8C E9AA D3DA            11      OUT (0DAH),A    ;MB8876 セクタレジスタ
001C8E E9AC F1              10      POP AF
       E9AD                     COMSET:
001C8F E9AD 2F               4      CPL         ;データバスが負論理
001C90 E9AE D3D8            11      OUT (0D8H),A    ;MB8876 ステータス/コマンドレジスタ
       E9B0                     DELAY0:
001C92 E9B0 3E1A             7      LD  A,26
       E9B2                     DELAY:
001C94 E9B2 3D               4      DEC A
001C95 E9B3 20FD            12      JR  NZ,DELAY
001C97 E9B5 C9              10      RET
                                
       E9B6                     DRIVE:                  ;ドライブのシリンダを得る
001C98 E9B6 2A84F0          16      LD  HL,(_DRIVE)
001C9B E9B9 26F0             7      LD  H,_CYL0/256
001C9D E9BB CBFD             8      SET 7,L
001C9F E9BD 7E               7      LD  A,(HL)
001CA0 E9BE C9              10      RET
                                
       E9BF                     RNF:                    ;ドライブのシリンダをリセット
001CA1 E9BF CDB6E9          17      CALL    DRIVE
001CA4 E9C2 36FF            10      LD  (HL),0FFH
001CA6 E9C4 C9              10      RET
                                
001CA7 E9C5 02                  RETRY:  DB  2
                                
                                
                                ;   FLOPPY DISK DRIVER
                                
       E9C6                     WTTRK:
001CA8 E9C6 0601             7      LD  B,1
001CAA E9C8 3EF4             7      LD  A,0F4H      ;FDC TypeIIIコマンド Write Track
001CAC E9CA 1802            12      JR  WTTRK1
       E9CC                     FDWT:
001CAE E9CC 3EA0             7      LD  A,0A0H      ;FDC TypeIIコマンド Write Sector
       E9CE                     WTTRK1:
001CB0 E9CE 3270E9          13      LD  (FDCSMC),A
       E9D1                     DWTBL:
001CB3 E9D1 78               4      LD  A,B
001CB4 E9D2 320EEA          13      LD  (WTBSMC),A
001CB7 E9D5 3E02             7      LD  A,2     ;Retry count
001CB9 E9D7 32C5E9          13      LD  (RETRY),A
                                
       E9DA                     DWT0:
001CBC E9DA D5              11      PUSH    DE
001CBD E9DB E5              11      PUSH    HL
001CBE E9DC CD26E9          17      CALL    SEEK        ;Write disk
001CC1 E9DF E1              10      POP HL
001CC2 E9E0 3837            12      JR  C,ERRDW
001CC4 E9E2 F3               4      DI
001CC5 E9E3 CDA4E9          17      CALL    SECSET_FDCCMD
001CC8 E9E6 0EDB             7      LD  C,0DBH      ;MB8876 データレジスタ
       E9E8                     DWT1:
001CCA E9E8 7E               7      LD  A,(HL)
001CCB E9E9 2F               4      CPL         ;データバスが負論理
001CCC E9EA 57               4      LD  D,A
                                
       E9EB                     DWT2:
001CCD E9EB DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001CCF E9ED 2F               4      CPL         ;データバスが負論理
001CD0 E9EE 0F               4      RRCA
001CD1 E9EF 3008            12      JR  NC,DWT4
001CD3 E9F1 0F               4      RRCA
001CD4 E9F2 30F7            12      JR  NC,DWT2
       E9F4                     DWT3:
001CD6 E9F4 ED51            12      OUT (C),D       ;MB8876 データレジスタ
001CD8 E9F6 23               6      INC HL
001CD9 E9F7 18EF            12      JR  DWT1
                                
       E9F9                     DWT4:
001CDB E9F9 3D               4      DEC A
001CDC E9FA 28F8            12      JR  Z,DWT3
001CDE E9FC 3C               4      INC A
001CDF E9FD FB               4      EI
001CE0 E9FE D1              10      POP DE
001CE1 E9FF 13               6      INC DE
001CE2 EA00 CD9EE9          17      CALL    FDMOFF
001CE5 EA03 2808            12      JR  Z,DISKOK_WT
001CE7 EA05 CD6DEA          17      CALL    DISKC
001CEA EA08 20D0            12      JR  NZ,DWT0
001CEC EA0A B7               4      OR  A
001CED EA0B 2005            12      JR  NZ,ERRW
                                
       EA0D                     DISKOK_WT:
001CEF EA0D 0601             7      LD  B,1
       EA0E                     WTBSMC  EQU $-1
001CF1 EA0F 10C0            13      DJNZ    DWTBL
001CF3 EA11 C9              10      RET
                                
       EA12                     ERRW:
001CF4 EA12 3EFF             7      LD  A,0FFH
       EA14                     ERRZ:
001CF6 EA14 BF               4      CP  A       ;ZF=1
001CF7 EA15 37               4      SCF
001CF8 EA16 C39EE9          10      JP  FDMOFF
                                
       EA19                     ERRDW:
001CFB EA19 D1              10      POP DE
001CFC EA1A CD7EEA          17      CALL    DELP
001CFF EA1D 20BB            12      JR  NZ,DWT0
001D01 EA1F B7               4      OR  A
001D02 EA20 20F0            12      JR  NZ,ERRW
001D04 EA22 C9              10      RET
                                
       EA23                     FDRD:
001D05 EA23 3E80             7      LD  A,080H      ;FDC TypeIIコマンド Read Sector
001D07 EA25 3270E9          13      LD  (FDCSMC),A
       EA28                     DRDBL:
001D0A EA28 78               4      LD  A,B
001D0B EA29 325FEA          13      LD  (RDBSMC),A
001D0E EA2C 3E02             7      LD  A,2     ;Retry count
001D10 EA2E 32C5E9          13      LD  (RETRY),A
       EA31                     DRD0:
001D13 EA31 D5              11      PUSH    DE
001D14 EA32 E5              11      PUSH    HL
001D15 EA33 CD26E9          17      CALL    SEEK        ;Read disk
001D18 EA36 E1              10      POP HL
001D19 EA37 382A            12      JR  C,ERRDR
001D1B EA39 F3               4      DI
001D1C EA3A CDA4E9          17      CALL    SECSET_FDCCMD
       EA3D                     DRD1:
001D1F EA3D DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001D21 EA3F 2F               4      CPL         ;データバスが負論理
001D22 EA40 0F               4      RRCA
001D23 EA41 300A            12      JR  NC,DRD3
001D25 EA43 0F               4      RRCA
001D26 EA44 30F7            12      JR  NC,DRD1
001D28 EA46 DBDB            11      IN  A,(0DBH)    ;MB8876 データレジスタ
001D2A EA48 2F               4      CPL         ;データバスが負論理
001D2B EA49 77               7      LD  (HL),A
001D2C EA4A 23               6      INC HL
001D2D EA4B 18F0            12      JR  DRD1
                                
       EA4D                     DRD3:
001D2F EA4D B7               4      OR  A
001D30 EA4E FB               4      EI
001D31 EA4F D1              10      POP DE
001D32 EA50 13               6      INC DE
001D33 EA51 CD9EE9          17      CALL    FDMOFF
001D36 EA54 2808            12      JR  Z,DISKOK_RD
001D38 EA56 CD6DEA          17      CALL    DISKC
001D3B EA59 20D6            12      JR  NZ,DRD0
001D3D EA5B B7               4      OR  A
001D3E EA5C 20B4            12      JR  NZ,ERRW
                                
       EA5E                     DISKOK_RD:
001D40 EA5E 0601             7      LD  B,1
       EA5F                     RDBSMC  EQU $-1
001D42 EA60 10C6            13      DJNZ    DRDBL
001D44 EA62 C9              10      RET
                                
       EA63                     ERRDR:
001D45 EA63 D1              10      POP DE
001D46 EA64 CD7EEA          17      CALL    DELP
001D49 EA67 20C8            12      JR  NZ,DRD0
001D4B EA69 B7               4      OR  A
001D4C EA6A 20A6            12      JR  NZ,ERRW
001D4E EA6C C9              10      RET
       EA6D                     DISKC:
001D4F EA6D 1B               6      DEC DE
001D50 EA6E CB5F             8      BIT 3,A
001D52 EA70 C4BFE9          17      CALL    NZ,RNF
       EA73                     DISKD:
001D55 EA73 E5              11      PUSH    HL
001D56 EA74 21C5E9          10      LD  HL,RETRY
001D59 EA77 35              11      DEC (HL)
001D5A EA78 E1              10      POP HL
001D5B EA79 200C            12      JR  NZ,ERR      ;Retry
001D5D EA7B B7               4      OR  A
001D5E EA7C 2809            12      JR  Z,ERR       ;Error
                                
       EA7E                     DELP:
001D60 EA7E CDBFE9          17      CALL    RNF
001D63 EA81 CD9EE9          17      CALL    FDMOFF
001D66 EA84 3EFF             7      LD  A,0FFH
       EA86                     AERRZ:
001D68 EA86 BF               4      CP  A
       EA87                     ERR:
001D69 EA87 3EFF             7      LD  A,0FFH
001D6B EA89 C9              10      RET
[EOF:M7DISK.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MZ-700/1500
                                
                                ;   EMM DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       EA8A                     EDWT:
001D6C EA8A F5              11      PUSH    AF
001D6D EA8B CDA9EA          17      CALL    EADR
001D70 EA8E 0600             7      LD  B,0
       EA90                     EDWT1:
001D72 EA90 EDB3                    OTIR
001D74 EA92 3D               4      DEC A
001D75 EA93 20FB            12      JR  NZ,EDWT1
001D77 EA95 180B            12      JR  EDRW1
                                
       EA97                     EDRD:
001D79 EA97 C5              11      PUSH    BC
001D7A EA98 CDA9EA          17      CALL    EADR
001D7D EA9B 0600             7      LD  B,0
       EA9D                     EDRD1:
001D7F EA9D EDB2                    INIR
001D81 EA9F 3D               4      DEC A
001D82 EAA0 20FB            12      JR  NZ,EDRD1
       EAA2                     EDRW1:
001D84 EAA2 F1              10      POP AF
001D85 EAA3 83               4      ADD A,E ;セクタを進める
001D86 EAA4 5F               4      LD  E,A
001D87 EAA5 8A               4      ADC A,D
001D88 EAA6 93               4      SUB E
001D89 EAA7 57               4      LD  D,A
001D8A EAA8 C9              10      RET
                                
       EAA9                     EADR:
001D8B EAA9 D5              11      PUSH    DE
001D8C EAAA EB               4      EX  DE,HL
001D8D EAAB 78               4      LD  A,B
001D8E EAAC DD460F          19      LD  B,(IX+DPB_BPS)
       EAAF                     EADR1:              ;読み込むセクタ数と1クラスタのセクタ数を掛ける
001D91 EAAF CB18             8      RR  B
001D93 EAB1 3804            12      JR  C,EADR2
001D95 EAB3 87               4      ADD A,A
001D96 EAB4 29              11      ADD HL,HL
001D97 EAB5 18F8            12      JR  EADR1
       EAB7                     EADR2:
001D99 EAB7 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001D9C EABA DD460C          19      LD  B,(IX+DPB_MAXCYL)
001D9F EABD 09              11      ADD HL,BC
001DA0 EABE DD4E13          19      LD  C,(IX+DPB_UNITNO)
001DA3 EAC1 ED71            12      OUT (C),0       ;Z80未定義命令
001DA5 EAC3 0C               4      INC C
001DA6 EAC4 ED69            12      OUT (C),L
001DA8 EAC6 0C               4      INC C
001DA9 EAC7 ED61            12      OUT (C),H
001DAB EAC9 0C               4      INC C
001DAC EACA EB               4      EX  DE,HL
001DAD EACB D1              10      POP DE
001DAE EACC C9              10      RET
                                
                                ;   CMOS BACKUP MEMORY DRIVER(32KB)
                                ;   1セクタ256
                                
       EACD                     CDWT:
001DAF EACD 78               4      LD  A,B
001DB0 EACE DD4E13          19      LD  C,(IX+DPB_UNITNO)
001DB3 EAD1 ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001DB5 EAD3 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001DB7 EAD5 01FA00          10      LD  BC,000FAH
       EAD8                     CDWT1:
001DBA EAD8 EDB3                    OTIR            ;W)データ書き込み・アドレスカウンタ+1
001DBC EADA 13               6      INC DE
001DBD EADB 3D               4      DEC A
001DBE EADC 20FA            12      JR  NZ,CDWT1
001DC0 EADE A7               4      AND A
001DC1 EADF C9              10      RET
                                
       EAE0                     CDRD:
001DC2 EAE0 78               4      LD  A,B
001DC3 EAE1 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001DC6 EAE4 ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001DC8 EAE6 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001DCA EAE8 01F900          10      LD  BC,000F9H
       EAEB                     CDRD1:
001DCD EAEB EDB2                    INIR            ;R)データ読み出し・アドレスカウンタ+1
001DCF EAED 13               6      INC DE
001DD0 EAEE 3D               4      DEC A
001DD1 EAEF 20FA            12      JR  NZ,CDRD1
001DD3 EAF1 A7               4      AND A
001DD4 EAF2 C9              10      RET
                                
                                ;   RAM DISK DRIVER (64KB)
                                ;   1セクタ256
                                
       EAF3                     RDWT:
001DD5 EAF3 3EB3             7      LD  A,0B3H      ;OTIR
001DD7 EAF5 1802            12      JR  RDRW
       EAF7                     RDRD:
001DD9 EAF7 3EB2             7      LD  A,0B2H      ;INIR
       EAF9                     RDRW:
001DDB EAF9 3206EB          13      LD  (RDRW_SWC),A
                                
001DDE EAFC 78               4      LD  A,B
001DDF EAFD 43               4      LD  B,E     ;B=アドレスカウンタ上位(X1の様な16bitのI/Oアクセス)
001DE0 EAFE 0EEB             7      LD  C,0EBH
001DE2 EB00 ED71            12      OUT (C),0       ;0=アドレスカウンタ下位
001DE4 EB02 0D               4      DEC C       ;EA(R)データ読み出し・アドレスカウンタ+1
001DE5 EB03 0600             7      LD  B,0
       EB05                     RDRW1:
001DE7 EB05 EDB2                    INIR            ;自己書き換え(INIR/OTIR)
       EB06                     RDRW_SWC    EQU $-1
001DE9 EB07 13               6      INC DE
001DEA EB08 3D               4      DEC A
001DEB EB09 20FA            12      JR  NZ,RDRW1
001DED EB0B A7               4      AND A
001DEE EB0C C9              10      RET
                                
                                ;   G-RAM(PCG) DISK DRIVER (24KB)
                                ;   1セクタ256
                                
       EB0D                     GDWT:
001DEF EB0D C5              11      PUSH    BC
001DF0 EB0E D5              11      PUSH    DE
001DF1 EB0F CD37EB          17      CALL    GADR
       EB12                     GDWT2:
001DF4 EB12 4E               7      LD  C,(HL)
001DF5 EB13 23               6      INC HL
001DF6 EB14 EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001DF7 EB15 CDF5CF          17      CALL    WR_PCG
001DFA EB18 23               6      INC HL
001DFB EB19 EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001DFC EB1A 10F6            13      DJNZ    GDWT2
001DFE EB1C D1              10      POP DE
001DFF EB1D 1C               4      INC E
001E00 EB1E C1              10      POP BC
001E01 EB1F 10EC            13      DJNZ    GDWT
001E03 EB21 C9              10      RET
       EB22                     GDRD:
001E04 EB22 C5              11      PUSH    BC
001E05 EB23 D5              11      PUSH    DE
001E06 EB24 CD37EB          17      CALL    GADR
       EB27                     GDRD2:
001E09 EB27 EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001E0A EB28 CDEDCF          17      CALL    RD_PCG
001E0D EB2B 23               6      INC HL
001E0E EB2C EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001E0F EB2D 71               7      LD  (HL),C
001E10 EB2E 23               6      INC HL
001E11 EB2F 10F6            13      DJNZ    GDRD2
001E13 EB31 D1              10      POP DE
001E14 EB32 1C               4      INC E
001E15 EB33 C1              10      POP BC
001E16 EB34 10EC            13      DJNZ    GDRD
001E18 EB36 C9              10      RET
                                
       EB37                     GADR:
001E19 EB37 7B               4      LD  A,E
001E1A EB38 E61F             7      AND 01FH
001E1C EB3A C6D0             7      ADD A,0D0H
001E1E EB3C 57               4      LD  D,A
001E1F EB3D 7B               4      LD  A,E
001E20 EB3E 07               4      RLCA
001E21 EB3F 07               4      RLCA
001E22 EB40 07               4      RLCA
001E23 EB41 3C               4      INC A
001E24 EB42 0600             7      LD  B,0
001E26 EB44 58               4      LD  E,B
001E27 EB45 C9              10      RET
[EOF:M7DISK2.ASM:UTF_8]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001E28 EB46                     PATHD:  DS  PATHX
001E63 EB81 00                  PATHE:  DB  0
                                
       EB82                     DTA_CCP:
001E64 EB82                         DS  37
                                
       EBA7                     FCB_BAT:
001E89 EBA7                         DS  37
                                
001EAE EBCC 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001EB9 EBD7 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "M7TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE 表示関連のテーブル
                                ;   MZ-700/1500
                                
       EBDE                     AT_TABLE:
001EC0 EBDE                         DS  TABLEAD-AT_TABLE
                                
       ED40                     KEY_TABLE:
002022 ED40 12081E1F1C1D5C2F        DB  12H,08H,1EH,1FH,1CH,1DH,5CH,'/'
00202A ED48 5C5E2D2030392C2E        DB  5CH,'^','-',20H,'0','9',',','.'
002032 ED50 3132333435363738        DB  '1','2','3','4','5','6','7','8'
00203A ED58 6162636465666768        DB  'a','b','c','d','e','f','g','h'
002042 ED60 696A6B6C6D6E6F70        DB  'i','j','k','l','m','n','o','p'
00204A ED68 7172737475767778        DB  'q','r','s','t','u','v','w','x'
002052 ED70 797A405B5D000000        DB  'y','z','@','[',']',00H,00H,00H
00205A ED78 001B3D09003B3A0D        DB  00H,1BH,'=',09H,00H,';',':',0DH
       ED80                     SHIFT_TABLE:
002062 ED80 12081E1F1C1D5F3F        DB  12H,08H,1EH,1FH,1CH,1DH,'_','?'
00206A ED88 7C7E3D2030293C3E        DB  '|','~','=',20H,'0',')','<','>'
002072 ED90 2122232425262728        DB  '!','"','#','$','%','&',27H,'('
00207A ED98 4142434445464748        DB  'A','B','C','D','E','F','G','H'
002082 EDA0 494A4B4C4D4E4F50        DB  'I','J','K','L','M','N','O','P'
00208A EDA8 5152535455565758        DB  'Q','R','S','T','U','V','W','X'
002092 EDB0 595A607B7D000000        DB  'Y','Z','`','{','}',00H,00H,00H
00209A EDB8 00003D09002B2A0D        DB  00H,00H,'=',09H,00H,'+','*',0DH
       EDC0                     CTRL_TABLE:
0020A2 EDC0 12081E1F1C1D3F2F        DB  12H,08H,1EH,1FH,1CH,1DH,'?','/'
0020AA EDC8 2A2B2D2030392C2E        DB  '*','+','-',20H,'0','9',',','.'
0020B2 EDD0 3132333435363738        DB  '1','2','3','4','5','6','7','8'
0020BA EDD8 0102030405060708        DB  01H,02H,03H,04H,05H,06H,07H,08H
0020C2 EDE0 090A0B0C0D0E0F10        DB  09H,0AH,0BH,0CH,0DH,0EH,0FH,10H
0020CA EDE8 1112131415161718        DB  11H,12H,13H,14H,15H,16H,17H,18H
0020D2 EDF0 191A1B5B5D000000        DB  19H,1AH,1BH,'[',']',00H,00H,00H
0020DA EDF8 00003D09003B3A0D        DB  00H,00H,'=',09H,00H,';',':',0DH
                                
                                ;   アドレス下位1バイトが0になるように
       EE00                     CD_TABLE:
0020E2 EE00 00D1D2D3D4D5D6D0        DB  $00,$D1,$D2,$D3,$D4,$D5,$D6,$D0 ;月火水木金土日
0020EA EE08 D8DCD9DADBD7CFCE        DB  $D8,$DC,$D9,$DA,$DB,$D7,$CF,$CE ;年円時分秒
0020F2 EE10 601F5F5E1E1B7978        DB  $60,$1F,$5F,$5E,$1E,$1B,$79,$78 ;
0020FA EE18 5C5D1C1D6DCACDC7        DB  $5C,$5D,$1C,$1D,$6D,$CA,$CD,$C7 ;
002102 EE20 0061626364656667        DB  $00,$61,$62,$63,$64,$65,$66,$67 ; !"#$%&'
00210A EE28 68696B6A2F2A2E2D        DB  $68,$69,$6B,$6A,$2F,$2A,$2E,$2D ;()*+,-./
002112 EE30 2021222324252627        DB  $20,$21,$22,$23,$24,$25,$26,$27 ;01234567
00211A EE38 28294F2C512B5749        DB  $28,$29,$4F,$2C,$51,$2B,$57,$49 ;89:;<=>?
002122 EE40 5501020304050607        DB  $55,$01,$02,$03,$04,$05,$06,$07 ;@ABCDEFG
00212A EE48 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;HIJKLMNO
002132 EE50 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;PQRSTUVW
00213A EE58 18191A52DD54E37C        DB  $18,$19,$1A,$52,$DD,$54,$E3,$7C ;XYZ[\]^_
002142 EE60 5901020304050607        DB  $59,$01,$02,$03,$04,$05,$06,$07 ;`abcdefg   ATB:1
00214A EE68 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;hijklmno   ATB:1
002152 EE70 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;pqrstuvw   ATB:1
00215A EE78 18191ACB35CC705A        DB  $18,$19,$1A,$CB,$35,$CC,$70,$5A ;xyz{|}~    ATB:1
002162 EE80 415346444847B49E        DB  $41,$53,$46,$44,$48,$47,$B4,$9E ;トランプ〇●をぁ   ATB:1
00216A EE88 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ぃぅぇぉゃゅょっ   ATB:1
002172 EE90 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーあいうえおかき   ATB:1
00217A EE98 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;くけこさしすせそ   ATB:1
002182 EEA0 F0BD9DB1B5B9B49E        DB  $F0,$BD,$9D,$B1,$B5,$B9,$B4,$9E ;　。「」、・ヲァ
00218A EEA8 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ィゥェォャョュッ
002192 EEB0 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーアイウエオカキ
00219A EEB8 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;クケコサシスセソ
0021A2 EEC0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;タチツテトナニヌ
0021AA EEC8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ネノハヒフヘホマ
0021B2 EED0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;ミムメモヤユヨラ
0021BA EED8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;リルレロワン゛゜
0021C2 EEE0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;たちつてとねにぬ   ATB:1
0021CA EEE8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ねのはひふへほま   ATB:1
0021D2 EEF0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;みむめもやゆよら   ATB:1
0021DA EEF8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;りるれろわん゛゜   ATB:1
       EF00                     DC_TABLE:
0021E2 EF00 2041424344454647        DB  $20,$41,$42,$43,$44,$45,$46,$47 ;0
0021EA EF08 48494A4B4C4D4E4F        DB  $48,$49,$4A,$4B,$4C,$4D,$4E,$4F
0021F2 EF10 5051525354555657        DB  $50,$51,$52,$53,$54,$55,$56,$57 ;1
0021FA EF18 58595A151A1B1411        DB  $58,$59,$5A,$15,$1A,$1B,$14,$11
002202 EF20 3031323334353637        DB  $30,$31,$32,$33,$34,$35,$36,$37 ;2
00220A EF28 38392D3D3B2F2E2C        DB  $38,$39,$2D,$3D,$3B,$2F,$2E,$2C
002212 EF30 00000000007C0000        DB  $00,$00,$00,$00,$00,$7C,$00,$00 ;3
00221A EF38 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
002222 EF40 0080000083008285        DB  $00,$80,$00,$00,$83,$00,$82,$85 ;4
00222A EF48 843F00000000003A        DB  $84,$3F,$00,$00,$00,$00,$00,$3A
002232 EF50 5E3C5B815D40003E        DB  $5E,$3C,$5B,$81,$5D,$40,$00,$3E ;5
00223A EF58 00607F0018191312        DB  $00,$60,$7F,$00,$18,$19,$13,$12
002242 EF60 1021222324252627        DB  $10,$21,$22,$23,$24,$25,$26,$27 ;6
00224A EF68 28292B2A001C0000        DB  $28,$29,$2B,$2A,$00,$1C,$00,$00
002252 EF70 7E00000000000000        DB  $7E,$00,$00,$00,$00,$00,$00,$00 ;7
00225A EF78 171600005F000000        DB  $17,$16,$00,$00,$5F,$00,$00,$00
002262 EF80 00C19A9F9C92CA97        DB  $00,$C1,$9A,$9F,$9C,$92,$CA,$97 ;8
00226A EF88 98C6CFC9D8D3D0D7        DB  $98,$C6,$CF,$C9,$D8,$D3,$D0,$D7
002272 EF90 9EC09DC496C5CBC3        DB  $9E,$C0,$9D,$C4,$96,$C5,$CB,$C3 ;9
00227A EF98 9BDDC2DB99A2878C        DB  $9B,$DD,$C2,$DB,$99,$A2,$87,$8C
002282 EFA0 DCC7CC91939495D4        DB  $DC,$C7,$CC,$91,$93,$94,$95,$D4 ;A
00228A EFA8 D5D6CECDDAD2D9C8        DB  $D5,$D6,$CE,$CD,$DA,$D2,$D9,$C8
002292 EFB0 D1A3888D86A4898E        DB  $D1,$A3,$88,$8D,$86,$A4,$89,$8E ;B
00229A EFB8 DFA58A8FDEA18B90        DB  $DF,$A5,$8A,$8F,$DE,$A1,$8B,$90
0022A2 EFC0 000000000000001F        DB  $00,$00,$00,$00,$00,$00,$00,$1F ;C
0022AA EFC8 00001D7B7D1E0F0E        DB  $00,$00,$1D,$7B,$7D,$1E,$0F,$0E
0022B2 EFD0 070102030405060D        DB  $07,$01,$02,$03,$04,$05,$06,$0D ;D
0022BA EFD8 080A0B0C095C0000        DB  $08,$0A,$0B,$0C,$09,$5C,$00,$00
0022C2 EFE0 0000005E00000000        DB  $00,$00,$00,$5E,$00,$00,$00,$00 ;E
0022CA EFE8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
0022D2 EFF0 A000000000000000        DB  $A0,$00,$00,$00,$00,$00,$00,$00 ;F
0022DA EFF8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
[EOF:M7TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
                                ;   ALIGN   256
       F000                     AT_WORK:
0022E2 F000                         DS  WORKAD-AT_WORK
                                
       F000                     CPM_BOOT:
0022E2 F000 C30000          10      JP  0
       F003                     _SYS00:     ;(BDOS)プログラム終了
       F003                     CPM_WBOOT:
0022E5 F003 C3FECF          10      JP  WBOOT1
       F006                     CPM_CONST:
0022E8 F006 C30FD8          10      JP  CONSTX
       F009                     _SYS07:     ;(BDOS)コンソール直接入力
       F009                     CPM_CONIN:
0022EB F009 C3A8D7          10      JP  FLGET
       F00C                     CPM_CONOUT:
0022EE F00C C3B3D9          10      JP  CONOUT1
                                
       F00F                     DECBF:              ;10進数表示時のバッファ(5バイト)
0022F1 F00F                         DS  5
       F00F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       F011                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       F014                     FDRV:
0022F6 F014 00                      DB  0
       F015                     FNAME:
0022F7 F015                         DS  36
       F039                     SFILE:
00231B F039                         DS  33      ;DRV FILENAME
       F05A                     _DISKE:
00233C F05A C312D7          10      JP  SHOW_ERROR
                                
00233F F05D 0000                LEFTX:  DW  0
002341 F05F 0000                DTAX:   DW  0
                                
                                ;   PSGのビープ音のデータ(X1)
       F061                     BEEPD:
002343 F061 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
00234B F069 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                ;
       F062                     RTC_YY  EQU BEEPD+1 ;RTCのバッファ年(88)
       F063                     RTC_MW  EQU BEEPD+2 ;RTCのバッファ月(88)
       F064                     RTC_DD  EQU BEEPD+3 ;RTCのバッファ日(88)
       F065                     RTC_TT  EQU BEEPD+4 ;RTCのバッファ時(88)
       F066                     RTC_MM  EQU BEEPD+5 ;RTCのバッファ分(88)
       F067                     RTC_SS  EQU BEEPD+6 ;RTCのバッファ秒(88)
       F062                     ROM_SLT EQU BEEPD+1 ;ROMのスロット(MSX)
       F061                     ZERO    EQU BEEPD
                                
       F070                     CHECK:
002352 F070 00                      DB  0
                                
       F071                     OK:
002353 F071 4F4B24                  DB  "OK$"
002356 F074                         DS  5
       F079                     COMERM:
00235B F079 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       F080                     _CYL0:
002362 F080 FF                      DB  0FFH    ;Cylinder
       F081                     _CYL1:
002363 F081 FF                      DB  0FFH    ;Cylinder
       F082                     _CYL2:
002364 F082 FF                      DB  0FFH    ;Cylinder
       F083                     _CYL3:
002365 F083 FF                      DB  0FFH    ;Cylinder
       F084                     _DRIVE:
002366 F084 00                      DB  0   ;unit number
       F085                     _SEEKSP:
002367 F085 00                      DB  0   ;Seek speed
       F086                     _ISEEK:
002368 F086 32                      DB  50  ;
002369 F087                         DS  1
       F088                     _DRV:
00236A F088 00                      DB  0
       F089                     _DSK:
00236B F089 FF                      DB  0FFH
       F08A                     _DTA:
00236C F08A 8000                    DW  00080H
       F08C                     _CTC:
00236E F08C 0000                    DW  0
       F08E                     _TXADR:
002370 F08E 0000                    DW  0
       F090                     _KEYPS:
002372 F090 0000                    DW  0
       F092                     _KEYD:
002374 F092 00                      DB  000H    ;キーデータ
       F093                     _KEYST:
002375 F093 FF                      DB  0FFH    ;キーステータス(SHIFT,CTRLの状態)
       F094                     _KEYSP_L:
002376 F094 83                      DB  KEYSP_L ;オートリピートの速度
       F095                     _KEYSP_H:
002377 F095 14                      DB  KEYSP_H ;オートリピートの速度
       F096                     _COLORF:
002378 F096 70                      DB  COLORF  ;色
       F097                     _LINE:
002379 F097 19                      DB  LINE
                                
                                            ;次のファイルの検索(C=12)で使用するFCB
       F098                     _FCB:
00237A F098 0000                    DW  0   ;SEARCH FILES
       F09A                     _FBPS:
00237C F09A 0000                    DW  0   ;    //
       F09C                     _FBAD:
00237E F09C 0000                    DW  0   ;    //
       F09E                     _FBCNT:
002380 F09E 00                      DB  0   ;    //
       F09F                     _FILEN:
002381 F09F 00                      DB  0   ;    //
       F0A0                     _DIRF:
002382 F0A0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
002383 F0A1                         DS  1
       F0A2                     _WTFATF:
002384 F0A2 00                      DB  0   ;FATバッファの更新フラグ
002385 F0A3                         DS  1
       F0A4                     _WTDBF:
002386 F0A4 00                      DB  0   ;データバッファの更新フラグ
       F0A5                     _DBDRV:
002387 F0A5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       F0A6                     _DBSEC:
002388 F0A6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       F0A8                     _DPB:
00238A F0A8 0000                    DW  0
       F0AA                     _FATDRV:
00238C F0AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       F0AB                     _FATIX:
00238D F0AB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       F0AC                     _FAKEFREE:
00238E F0AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
002390 F0AE                         DS  2
                                ;   画面周りのデータ
       F0B0                     CRTCD:
002392 F0B0 6F                      DB  06FH
       F0B1                     _WIDTH:
002393 F0B1 28                      DB  WIDTH
       F0B2                     TVRAMTOP:
002394 F0B2 5938                    DB  059H,038H
002396 F0B4 1F02                    DB  01FH,002H
       F0B6                     _LINE2:
002398 F0B6 19                      DB  019H
       F0B7                     WKE4:
002399 F0B7 1C                      DB  01CH
       F0B8                     WKE6:
00239A F0B8 00                      DB  000H
       F0B9                     WK40:
00239B F0B9 07                      DB  007H
       F0BA                     _PAGE_MINUS:
00239C F0BA 18FC                    DW  0-WIDTH*LINE
       F0BC                     _WIDTH_MINUS:
00239E F0BC D8FF                    DW  0-WIDTH
       F0BE                     WK30:
0023A0 F0BE 0C                      DB  00CH
       F0BF                     WK31:
       F0BF                     WK1FD0:
0023A1 F0BF 20                      DB  020H
                                
                                ;   割り込みベクタ(X1)
0023A2 F0C0 0000                CTC0:   DW  INTCTCE
0023A4 F0C2 0000                CTC1:   DW  INTCTCE
0023A6 F0C4 0000                CTC2:   DW  INTCTCE
0023A8 F0C6 0000                CTC3:   DW  INTCTCE
0023AA F0C8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
0023AC F0CA C31BDB          10  _INKEY: JP  INKEY
0023AF F0CD C39AD8          10  _PRINT: JP  PRINT
0023B2 F0D0 C383DB          10  _SCRN:  JP  SCRN
0023B5 F0D3 C36CDA          10  _POS:   JP  POS
0023B8 F0D6 C381D9          10  _LOC:   JP  LOC
       F0D9                     _CHGDRV:
0023BB F0D9 C32FE8          10      JP  CHGDRV
       F0DC                     _GETDPB:
0023BE F0DC C3EDE8          10      JP  GETDPB
       F0DF                     _FFLUSH:
0023C1 F0DF C30BE9          10      JP  FFLUSH
       F0E2                     _RDFATX:
0023C4 F0E2 C309E5          10      JP  RDFATX
0023C7 F0E5 C33BE6          10  _RDFAT: JP  RDFAT
0023CA F0E8 C3C6E9          10  _WTTRK: JP  WTTRK
0023CD F0EB C323EA          10  _FDRD:  JP  FDRD
0023D0 F0EE C3CCE9          10  _FDWT:  JP  FDWT
       F0F1                     _BPB2DPB:
0023D3 F0F1 C3D1E6          10      JP  BPB2DPB
       F0F4                     _BREAK:
0023D6 F0F4 C396D1          10      JP  END_BATCH
       F0F7                     _GNCL:
0023D9 F0F7 C3B5E5          10      JP  GNCL        ; self-modifying code
       F0F8                     GNCPAT  EQU $-2
       F0FA                     _SNCL:
0023DC F0FA C3D8E5          10      JP  SNCL        ; self-modifying code
       F0FB                     SNCPAT  EQU $-2
       F0FD                     _COMANL:
0023DF F0FD C34FD0          10      JP  COMANL
                                
       F100                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F100                     STABLE:
                                ;0
0023E2 F100 03F07BD787D773DD        DW  _SYS00,_SYS01,_SYS02,_SYS03
0023EA F108 7DD47DD48CD709F0        DW  _SYS04,_SYS05,_SYS06,_SYS07
0023F2 F110 94D77FD4DED70AD8        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
0023FA F118 94D499D4A8D4B9D4        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
002402 F120 0DD554D59DD5CED5        DW  _SYS10,_SYS11,_SYS12,_SYS13
00240A F128 D6D5ECD501D6F9D5        DW  _SYS14,_SYS15,_SYS16,_SYS17
002412 F130 48D64DD652D658D6        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
00241A F138 7DD47ED67DD482D6        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
002422 F140 7DD438D640D689D6        DW  _SYS20,_SYS21,_SYS22,_SYS23
00242A F148 AED67DD4C9E197E2        DW  _SYS24,_ERROR,_SYS26,_SYS27
002432 F150 40D6B8D61DD873DD        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
00243A F158 1DD873DD7DD4D9D6        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
002442 F160 D3D67DD47DD47DD4        DW  _SYS30,_ERROR,_ERROR,_ERROR
00244A F168 7DD47DD47DD47DD4        DW  _ERROR,_ERROR,_ERROR,_ERROR
002452 F170 7DD473DD73DDFAD6        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
00245A F178 60D4                    DW  _DOS2
                                
00245C F17A                         DS  1
       F17B                     _MAX_SEC_SZ_H:
00245D F17B 04                      DB  MAX_SEC_SZ_H
                                
                                ;   FATバッファのアドレス
       F17C                     _FATBF:
00245E F17C 30F3                    DW  FATBF
                                
                                ;   データバッファのアドレス
       F17E                     _DTBUF:
002460 F17E 30FB                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F180                     CTRLTB:
002462 F180 FFD8FFD835D93FDA        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
00246A F188 39DA66D92ADAC3D9        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002472 F190 0BD926D942DA94D9        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
00247A F198 27DA7CD954DAFFD8        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
002482 F1A0 FFD8FFD88CD9FFD8        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
00248A F1A8 FFD8FFD8FFD8FFD8        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
002492 F1B0 FFD8FFD827DA9BD9        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
00249A F1B8 EED812D91BD942DA        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
                                ;   2D/2DDでBPBがない場合のデフォルト値(2D/360KB/9セクタ1024バイト)
0024A2 F1C0 0200                M2D:    DW  2
0024A4 F1C2 FD02                    DB  0FDH,2
0024A6 F1C4 6401                    DW  356
0024A8 F1C6 FF0728090182            DB  0FFH,7,40,9,1,082H
0024AE F1CC 0500A7000800            DW  5,0A7H,8
                                
                                ;   2HDでBPBがない場合のデフォルト値(2HD/1.23MB/8セクタ1024バイト)
0024B4 F1D2 0200                M2HD:   DW  2
0024B6 F1D4 FE01                    DB  0FEH,1
0024B8 F1D6 C704                    DW  1223
0024BA F1D8 FE064D080184            DB  0FEH,6,77,8,1,084H
0024C0 F1DE 0500A7000900            DW  5,0A7H,9
                                
                                ;   ディレクトリエントリとFCBの変換テーブル(日付+時刻+サイズ)
0024C6 F1E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
0024C8 F1E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
0024CA F1E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
0024CC F1EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F1EE                     SDDATAE:
                                
0024D0 F1EE                         DS  2
                                
                                ;   バッチファイルのFCB
       F1F0                     _FCB_BAT:
0024D2 F1F0 A7EB                    DW  FCB_BAT
       F1F2                     _PATH:
0024D4 F1F2 46EB                    DW  PATHD
                                
0024D6 F1F4                     SCDIR:  DS  2       ;+14 +15
0024D8 F1F6                     SFBPS:  DS  2       ;FBPS
0024DA F1F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
0024DC F1FA 0000                _FATPS: DW  0
0024DE F1FC 0000                _DIRPS: DW  0
0024E0 F1FE 0000                _CLPS:  DW  0
                                
       F200                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "M7DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MZ-700/1500
                                
       F200                     _DEVICE:
                                
                                ;   A:
                                
0024E2 F200 0200                    DW  2   ;DPB_FATLN
0024E4 F202 EBF0                    DW  _FDRD   ;DPB_DRD
0024E6 F204 EEF0                    DW  _FDWT   ;DPB_DWT
0024E8 F206 FD                      DB  0FDH    ;DPB_FATID
0024E9 F207 02                      DB  2   ;DPB_SECPCL
0024EA F208 6401                    DW  356 ;DPB_MAXCL
0024EC F20A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
0024ED F20B 07                      DB  7   ;DPB_DIRSCNT
0024EE F20C 28                      DB  40  ;DPB_MAXCYL
0024EF F20D 09                      DB  9   ;DPB_MAXSEC Number of sectors
0024F0 F20E 01                      DB  1   ;DPB_FATPS
0024F1 F20F 82                      DB  082H    ;DPB_BPS
0024F2 F210 0500                    DW  5   ;DPB_DIRPS
0024F4 F212 27                      DB  027H    ;DPB_DEVICE Device Number
0024F5 F213 00                      DB  0   ;DPB_UNITNO
0024F6 F214 0800                    DW  8   ;DPB_ADDCL
0024F8 F216 0000                    DW  0   ;DPB_16
0024FA F218 0000                    DW  0   ;DPB_18
0024FC F21A 0000                    DW  0   ;DPB_SDIR
0024FE F21C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002502 F220 0200                    DW  2   ;DPB_FATLN
002504 F222 EBF0                    DW  _FDRD   ;DPB_DRD
002506 F224 EEF0                    DW  _FDWT   ;DPB_DWT
002508 F226 FD                      DB  0FDH    ;DPB_FATID
002509 F227 02                      DB  2   ;DPB_SECPCL
00250A F228 6401                    DW  356 ;DPB_MAXCL
00250C F22A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
00250D F22B 07                      DB  7   ;DPB_DIRSCNT
00250E F22C 28                      DB  40  ;DPB_MAXCYL
00250F F22D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002510 F22E 01                      DB  1   ;DPB_FATPS
002511 F22F 82                      DB  082H    ;DPB_BPS
002512 F230 0500                    DW  5   ;DPB_DIRPS
002514 F232 27                      DB  027H    ;DPB_DEVICE Device Number
002515 F233 01                      DB  1   ;DPB_UNITNO
002516 F234 0800                    DW  8   ;DPB_ADDCL
002518 F236 0000                    DW  0   ;DPB_16
00251A F238 0000                    DW  0   ;DPB_18
00251C F23A 0000                    DW  0   ;DPB_SDIR
00251E F23C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002522 F240 0100                    DW  1   ;DPB_FATLN
002524 F242 E0EA                    DW  CDRD    ;DPB_DRD
002526 F244 CDEA                    DW  CDWT    ;DPB_DWT
002528 F246 FA                      DB  0FAH    ;DPB_FATID
002529 F247 01                      DB  1   ;DPB_SECPCL
00252A F248 7A00                    DW  122 ;DPB_MAXCL
00252C F24A 00                      DB  0   ;DPB_FDMODE
00252D F24B 06                      DB  6   ;DPB_DIRSCNT
00252E F24C 00                      DB  0   ;DPB_MAXCYL
00252F F24D 00                      DB  0   ;DPB_MAXSEC
002530 F24E 01                      DB  1   ;DPB_FATPS
002531 F24F 01                      DB  1   ;DPB_BPS
002532 F250 0200                    DW  2   ;DPB_DIRPS
002534 F252 0C                      DB  00CH    ;DPB_DEVICE
002535 F253 F8                      DB  0F8H    ;DPB_UNITNO
002536 F254 0600                    DW  6   ;DPB_ADDCL
002538 F256 0000                    DW  0   ;DPB_16
00253A F258 0000                    DW  0   ;DPB_18
00253C F25A 0000                    DW  0   ;DPB_SDIR
00253E F25C 434D4F53                DB  "CMOS"  ;DPB_NAME
                                
                                ;   D:
                                
002542 F260                         DS  32
                                
                                ;   E:
                                
       F280                     EMMFL:
002562 F280 0000                    DW  0   ;DPB_FATLN
002564 F282 97EA                    DW  EDRD    ;DPB_DRD
002566 F284 8AEA                    DW  EDWT    ;DPB_DWT
002568 F286 FA                      DB  0FAH    ;DPB_FATID
002569 F287 02                      DB  2   ;DPB_SECPCL
00256A F288 0000                    DW  0   ;DPB_MAXCL
00256C F28A 00                      DB  0   ;DPB_FDMODE
00256D F28B 10                      DB  16  ;DPB_DIRSCNT
00256E F28C 00                      DB  0   ;DPB_MAXCYL
00256F F28D 00                      DB  0   ;DPB_MAXSEC
002570 F28E 01                      DB  1   ;DPB_FATPS
002571 F28F 01                      DB  1   ;DPB_BPS
002572 F290 0000                    DW  0   ;DPB_DIRPS
002574 F292 26                      DB  026H    ;DPB_DEVICE
002575 F293 00                      DB  0   ;DPB_UNITNO
002576 F294 0000                    DW  0   ;DPB_ADDCL
002578 F296 0000                    DW  0   ;DPB_16
00257A F298 0000                    DW  0   ;DPB_18
00257C F29A 0000                    DW  0   ;DPB_SDIR
00257E F29C 454D4D30                DB  "EMM0"  ;DPB_NAME
                                
                                ;   F:
                                
002582 F2A0 0200                    DW  2   ;DPB_FATLN
002584 F2A2 F7EA                    DW  RDRD    ;DPB_DRD
002586 F2A4 F3EA                    DW  RDWT    ;DPB_DWT
002588 F2A6 FA                      DB  0FAH    ;DPB_FATID
002589 F2A7 01                      DB  1   ;DPB_SECPCL
00258A F2A8 F600                    DW  246 ;DPB_MAXCL
00258C F2AA 00                      DB  0   ;DPB_FDMODE
00258D F2AB 09                      DB  9   ;DPB_DIRSCNT
00258E F2AC 00                      DB  0   ;DPB_MAXCYL
00258F F2AD 00                      DB  0   ;DPB_MAXSEC
002590 F2AE 01                      DB  1   ;DPB_FATPS
002591 F2AF 01                      DB  1   ;DPB_BPS
002592 F2B0 0300                    DW  3   ;DPB_DIRPS
002594 F2B2 0F                      DB  00FH    ;DPB_DEVICE
002595 F2B3 00                      DB  0   ;DPB_UNITNO
002596 F2B4 0A00                    DW  10  ;DPB_ADDCL
002598 F2B6 0000                    DW  0   ;DPB_16
00259A F2B8 0000                    DW  0   ;DPB_18
00259C F2BA 0000                    DW  0   ;DPB_SDIR
00259E F2BC 52414D46                DB  "RAMF"  ;DPB_NAME
                                
                                ;   G:
       F2C0                     GRAMFL:
0025A2 F2C0 0100                    DW  1   ;DPB_FATLN
0025A4 F2C2 22EB                    DW  GDRD    ;DPB_DRD
0025A6 F2C4 0DEB                    DW  GDWT    ;DPB_DWT
0025A8 F2C6 FA                      DB  0FAH    ;DPB_FATID
0025A9 F2C7 01                      DB  1   ;DPB_SECPCL
0025AA F2C8 5A00                    DW  90  ;DPB_MAXCL
0025AC F2CA 00                      DB  0   ;DPB_FDMODE
0025AD F2CB 06                      DB  6   ;DPB_DIRSCNT
0025AE F2CC 00                      DB  0   ;DPB_MAXCYL
0025AF F2CD 00                      DB  0   ;DPB_MAXSEC
0025B0 F2CE 01                      DB  1   ;DPB_FATPS
0025B1 F2CF 01                      DB  1   ;DPB_BPS
0025B2 F2D0 0200                    DW  2   ;DPB_DIRPS
0025B4 F2D2 05                      DB  005H    ;DPB_DEVICE
0025B5 F2D3 F8                      DB  0F8H    ;DPB_UNITNO
0025B6 F2D4 0600                    DW  6   ;DPB_ADDCL
0025B8 F2D6 0000                    DW  0   ;DPB_16
0025BA F2D8 0000                    DW  0   ;DPB_18
0025BC F2DA 0000                    DW  0   ;DPB_SDIR
0025BE F2DC 4752414D                DB  "GRAM"  ;DPB_NAME
                                
                                ;   H:
0025C2 F2E0                         DS  3
0025C5 F2E3 00                      DB  0
[EOF:M7DPB.ASM:UTF_8]
                                
       A5C6                     LAST_ADR    EQU $$+OFFSET
                                
                                    END
[EOF:M7.ASM:UTF_8]
[EOF:M7I.ASM:UTF_8]
