                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for MZ-700/1500　キー割り込み処理使用
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
       0001                     USE_8253    EQU 1
                                
                                    INCLUDE "M7.ASM"
                                ;   LSX-Dodgers for MZ-700/1500
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "M7DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MZ-700/1500
                                
       0001                     MAC EQU 1   ;MZ-700/1500
       0000                     DEV EQU 0
                                
       011D                     VER_6F  EQU 0011DH
                                
       8080                     RUN EQU 08080H
       8000                     OFFSET  EQU RUN-128
       CF06                     BDOS    EQU 0CF06H
       F000                     WORKAD  EQU 0F000H
       ED40                     TABLEAD EQU 0ED40H
       F300                     KEYBF   EQU 0F300H
       F330                     FATBF   EQU 0F330H
       FB30                     DTBUF   EQU 0FB30H
       FF30                     KBUF    EQU 0FF30H
       FFD9                     TRAP38  EQU 0FFD9H
       0028                     WIDTH   EQU 40
       0019                     LINE    EQU 25
       0070                     COLORF  EQU 070H
       0014                     KEYSP_H EQU 20
       0083                     KEYSP_L EQU 131
       0009                     COMS    EQU 9
       0004                     MAX_SEC_SZ_H    EQU 4       ;1セクタ1024バイトのサポート(2:off 4:on)
       0100                     BUFFER  EQU 00100H
       D0EA                     S27BUF_COM  EQU S27BUF
[EOF:M7DEF.ASM:SHIFT_JIS]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0002                     VER_3   EQU 2
       1D01                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0001                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0162                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 8000                         ORG OFFSET
                                                    ;MZTヘッダ128バイト
000000 8000 01                      DB  1           ;ファイルモード
000001 8001 4C44202020202020        DB  "LD           "     ;ファイル名(13)
            2020202020          
00000E 800E 535953                  DB  "SYS"           ;拡張子(3)
000011 8011 0D                      DB  $0D
000012 8012 4525                    DW  LAST_ADR-RUN        ;サイズ
000014 8014 8080                    DW  RUN         ;開始アドレス
000016 8016 8080                    DW  RUN         ;実行アドレス
000018 8018                         DS  104
                                
                                    INCLUDE "M7INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   MZ-700/1500
                                
000080 8080 C38780          10      JP  START
000083 8083 011D                    DW  MACW
000085 8085 6201                    DW  VER
                                
       8087                     START:
000087 8087 F3               4      DI
000088 8088 ED56             8      IM  1
00008A 808A 318780          10      LD  SP,START
00008D 808D CD9B80          17      CALL    INIT        ;NZならAUTOEXECを実行
000090 8090 210000          10      LD  HL,0
000093 8093 E5              11      PUSH    HL
000094 8094 C8              11      RET Z
000095 8095 118081          10      LD  DE,AUTOD
000098 8098 C3FDF0          10      JP  _COMANL
                                
       809B                     INIT:
00009B 809B D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFFH)
00009D 809D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00009F 809F 21E781          10      LD  HL,INITE
0000A2 80A2 1106CF          10      LD  DE,BDOS
0000A5 80A5 01DE23          10      LD  BC,LAST_ADR-INITE
0000A8 80A8 EDB0                    LDIR
0000AA 80AA 21B681          10      LD  HL,M7BEEPD
0000AD 80AD 1162F0          10      LD  DE,BEEPD+1
0000B0 80B0 010A00          10      LD  BC,M7BEEPE-M7BEEPD
0000B3 80B3 EDB0                    LDIR
                                
0000B5 80B5 210000          10      LD  HL,0
0000B8 80B8 065C             7      LD  B,05CH
0000BA 80BA 3E                      DB  03EH    ;LD A,??
0000BB 80BB EF              12      RST 28H
0000BC 80BC CD80DC          17      CALL    FILL_MEMORY
0000BF 80BF 06A4             7      LD  B,0A4H
0000C1 80C1 AF               4      XOR A
0000C2 80C2 320400          13      LD  (_DVSW),A
0000C5 80C5 CD80DC          17      CALL    FILL_MEMORY
                                
0000C8 80C8 3EC3             7      LD  A,0C3H      ;JP
0000CA 80CA 2103F0          10      LD  HL,CPM_WBOOT
0000CD 80CD 320000          13      LD  (00000H),A
0000D0 80D0 220100          16      LD  (00001H),HL ;IPL
                                
0000D3 80D3 2106CF          10      LD  HL,BDOS
0000D6 80D6 320500          13      LD  (00005H),A
0000D9 80D9 220600          16      LD  (00006H),HL ;BDOS
                                
0000DC 80DC 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000DF 80DF 322800          13      LD  (00028H),A
0000E2 80E2 222900          16      LD  (00029H),HL ;RST 028H
                                
0000E5 80E5 323800          13      LD  (00038H),A
0000E8 80E8 21E2CF          10      LD  HL,IO_INT8253
0000EB 80EB 223900          16      LD  (00039H),HL
                                
0000EE 80EE 215BF0          10      LD  HL,_DISKE+1
0000F1 80F1 2223F3          16      LD  (DISKVE),HL
0000F4 80F4 21F5F0          10      LD  HL,_BREAK+1
0000F7 80F7 2225F3          16      LD  (BREAKV),HL
                                
0000FA 80FA 3EF0             7      LD  A,CPM_BOOT/256
0000FC 80FC 320B00          13      LD  (0000BH),A
                                
0000FF 80FF 3EE9             7      LD  A,0E9H      ;JP (HL)
000101 8101 320F00          13      LD  (0000FH),A
                                                ;CHECK PCG(MZ-1500)
000104 8104 2100E8          10      LD  HL,0E800H
000107 8107 46               7      LD  B,(HL)
000108 8108 F3               4      DI
000109 8109 3E01             7      LD  A,1
00010B 810B D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00010D 810D 4E               7      LD  C,(HL)
00010E 810E 79               4      LD  A,C
00010F 810F C6A5             7      ADD A,0A5H
000111 8111 5F               4      LD  E,A
000112 8112 73               7      LD  (HL),E
000113 8113 D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
000115 8115 71               7      LD  (HL),C
000116 8116 3E01             7      LD  A,1
000118 8118 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00011A 811A 7E               7      LD  A,(HL)
00011B 811B BB               4      CP  E
00011C 811C D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
00011E 811E 70               7      LD  (HL),B
00011F 811F FB               4      EI
000120 8120 2804            12      JR  Z,MZ1500
000122 8122 AF               4      XOR A       ;MZ-700はPCGバンクが存在しない
000123 8123 32C0F2          13      LD  (GRAMFL),A
       8126                     MZ1500:
000126 8126 DD2180F2        14      LD  IX,EMMFL
00012A 812A CD7581          17      CALL    CHECK_EMM_BPB
00012D 812D FEEB             7      CP  0EBH
00012F 812F 2817            12      JR  Z,EMM_BPB
000131 8131 DD360D02        19      LD  (IX+DPB_MAXSEC),2   ;BPBが512バイト目から始まる場合を調べる
000135 8135 CD7581          17      CALL    CHECK_EMM_BPB
000138 8138 DDBE06          19      CP  (IX+DPB_FATID)
00013B 813B 200B            12      JR  NZ,EMM_BPB
00013D 813D DD360D00        19      LD  (IX+DPB_MAXSEC),0   ;BPBが先頭の場合に戻す
                                
000141 8141 2103E0          10      LD  HL,0E003H       ;SOUND MASK (MZ-1500)
000144 8144 AF               4      XOR A
000145 8145 CD4BCF          17      CALL    WRMMIO
       8148                     EMM_BPB:
000148 8148 218C81          10      LD  HL,INIMES
00014B 814B CD8ED4          17      CALL    MSX
       814E                     INIT1:
00014E 814E F3               4      DI
00014F 814F 1100FF          10      LD  DE,0FF00H
000152 8152 0600             7      LD  B,0
000154 8154 CD2CD3          17      CALL    ZERO_MEMORY_DE
000157 8157 21CAFF          10      LD  HL,EXTBIO
00015A 815A 36C9            10      LD  (HL),0C9H   ;RET
00015C 815C 23               6      INC HL
00015D 815D 060E             7      LD  B,TRAP38-EXTBIO-1
00015F 815F 3E                      DB  03EH    ;LD A,??
000160 8160 EF              12      RST 28H
000161 8161 CD80DC          17      CALL    FILL_MEMORY
000164 8164 21C081          10      LD  HL,AT_TRAP38
000167 8167 11D9FF          10      LD  DE,TRAP38
00016A 816A 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
00016D 816D EDB0                    LDIR
                                
00016F 816F CD33DB          17      CALL    CHKEY
000172 8172 FE03             7      CP  3
000174 8174 C9              10      RET
                                
       8175                     CHECK_EMM_BPB:
000175 8175 D5              11      PUSH    DE
000176 8176 110000          10      LD  DE,0
000179 8179 CDACEA          17      CALL    EADR
00017C 817C D1              10      POP DE
00017D 817D ED78            12      IN  A,(C)
00017F 817F C9              10      RET
                                
000180 8180 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000189 8189 413A00              AUTODV: DB  "A:",0
                                
00018C 818C 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MZ-700/1500 v"
            6765727320666F72    
            204D5A2D3730302F    
            313530302076        
0001AA 81AA 312E                    DB  030H + VER_1, '.'
0001AC 81AC 3632                    DB  030H + VER_2 ,030H + VER_3
0001AE 81AE                         DB  ''
0001AE 81AE 2047616B750D0A          DB  " Gaku",0DH,0AH
0001B5 81B5 00                      DB  0
                                
       81B6                     M7BEEPD:
0001B6 81B6 0801                    DB  8,1
0001B8 81B8 0736                    DB  7,036H
0001BA 81BA 04F9                    DB  4,0F9H
0001BC 81BC 0403                    DB  4,3
0001BE 81BE 0301                    DB  3,1         ;SOUND MASK(MZ-1500)
       81C0                     M7BEEPE:
                                
       81C0                     AT_TRAP38:
0001C0 FFD9                         ORG TRAP38,AT_TRAP38-OFFSET
0001C0 FFD9 210000          10      LD  HL,0
0001C3 FFDC E3              19      EX  (SP),HL
0001C4 FFDD 3E24             7      LD  A,'$'
0001C6 FFDF CD7ED7          17      CALL    MSG_A
0001C9 FFE2 2B               6      DEC HL
0001CA FFE3 7C               4      LD  A,H
0001CB FFE4 CDE8FF          17      CALL    PRHX
0001CE FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
0001CF FFE8 F5              11      PUSH    AF
0001D0 FFE9 07               4      RLCA
0001D1 FFEA 07               4      RLCA
0001D2 FFEB 07               4      RLCA
0001D3 FFEC 07               4      RLCA
0001D4 FFED CDF1FF          17      CALL    PRHX2
0001D7 FFF0 F1              10      POP AF
       FFF1                     PRHX2:
0001D8 FFF1 E60F             7      AND 00FH
0001DA FFF3 FE0A             7      CP  10
0001DC FFF5 3F               4      CCF
0001DD FFF6 CE30             7      ADC A,'0'
0001DF FFF8 27               4      DAA
0001E0 FFF9 C37ED7          10      JP  MSG_A
0001E3 FFFC                         DS  4
0001E7 81E7                         ORG $$+OFFSET,$$    ;$DEPHASE
       81E7                     AT_TRAPE:
                                
       81E7                     INITE:
0001E7 CF06                         ORG BDOS,INITE-OFFSET
                                
0001E7 CF06 C309CF          10      JP  IO_BDOS
[EOF:M7INIT.ASM:SHIFT_JIS]
                                    INCLUDE "M7BANK.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                ;   VRAM/KEY/TIMER(0D000H-0EFFFH)にアクセスするので0D000H-0FFFFHに置けない部分
                                ;
                                
       CF09                     IO_BDOS:
0001EA CF09 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001EC CF0B C34ED4          10      JP  BDOS0
                                
       CF0E                     IO_CLR:
0001EF CF0E D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF10                     C1AX1:
0001F1 CF10 7A               4      LD  A,D
0001F2 CF11 C6D0             7      ADD A,0D0H
0001F4 CF13 57               4      LD  D,A
0001F5 CF14 AF               4      XOR A
0001F6 CF15 12               7      LD  (DE),A      ;Text
0001F7 CF16 CBDA             8      SET 3,D
0001F9 CF18 3E00             7      LD  A,0     ;自己書き換え
                                                ;BDOS0+13Hが外部から書き換えされても動くようにする
       CF19                     ICSMC   EQU $-1
0001FB CF1A 12               7      LD  (DE),A      ;Color
0001FC CF1B 13               6      INC DE
0001FD CF1C 7A               4      LD  A,D
0001FE CF1D D6D8             7      SUB 0D8H
000200 CF1F 57               4      LD  D,A
000201 CF20 2118FC          10      LD  HL,0-WIDTH*LINE
       CF21                     _NEG_PAGE_SWC   EQU $-2
000204 CF23 19              11      ADD HL,DE
000205 CF24 30EA            12      JR  NC,C1AX1
000207 CF26 E1              10      POP HL
000208 CF27 D1              10      POP DE
000209 CF28 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00020B CF2A FB               4      EI
00020C CF2B C9              10      RET
                                
       CF2C                     RDKEYDATA:
00020D CF2C F3               4      DI
00020E CF2D D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000210 CF2F 3200E0          13      LD  (0E000H),A
000213 CF32 3A01E0          13      LD  A,(E001H)
000216 CF35 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000218 CF37 FB               4      EI
000219 CF38 C9              10      RET
                                
       CF39                     RD556VSYNC:
00021A CF39 F3               4      DI
00021B CF3A D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00021D CF3C 3A02E0          13      LD  A,(0E002H)
000220 CF3F D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000222 CF41 FB               4      EI
000223 CF42 C9              10      RET
                                
       CF43                     RDMMIO:
000224 CF43 F3               4      DI
000225 CF44 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000227 CF46 7E               7      LD  A,(HL)
000228 CF47 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00022A CF49 FB               4      EI
00022B CF4A C9              10      RET
                                
       CF4B                     WRMMIO:
00022C CF4B F3               4      DI
00022D CF4C D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00022F CF4E 77               7      LD  (HL),A
000230 CF4F D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000232 CF51 FB               4      EI
000233 CF52 C9              10      RET
                                
       CF53                     RDMMIO_BC:
000234 CF53 F3               4      DI
000235 CF54 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000237 CF56 0A               7      LD  A,(BC)
000238 CF57 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00023A CF59 FB               4      EI
00023B CF5A C9              10      RET
                                
       CF5B                     WRMMIO_BC:
00023C CF5B F3               4      DI
00023D CF5C D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00023F CF5E 02               7      LD  (BC),A
000240 CF5F D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000242 CF61 FB               4      EI
000243 CF62 C9              10      RET
                                
       CF63                     IO_PRINT:
000244 CF63 F3               4      DI
000245 CF64 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000247 CF66 77               7      LD  (HL),A
000248 CF67 CBDC             8      SET 3,H
00024A CF69 71               7      LD  (HL),C
00024B CF6A D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00024D CF6C FB               4      EI
00024E CF6D C9              10      RET
                                
       CF6E                     IO_CLLINE:
00024F CF6E F3               4      DI
000250 CF6F D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF71                     CLLINE1:
000252 CF71 CB9C             8      RES 3,H
000254 CF73 77               7      LD  (HL),A      ;Text
000255 CF74 CBDC             8      SET 3,H
000257 CF76 71               7      LD  (HL),C      ;Color
000258 CF77 23               6      INC HL
000259 CF78 10F7            13      DJNZ    CLLINE1
00025B CF7A D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00025D CF7C FB               4      EI
00025E CF7D C9              10      RET
                                
       CF7E                     IO_INSBS:
00025F CF7E F3               4      DI
000260 CF7F D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF81                     IO_INSBS1:
000262 CF81 CB9C             8      RES 3,H
000264 CF83 5E               7      LD  E,(HL)
000265 CF84 77               7      LD  (HL),A
000266 CF85 7B               4      LD  A,E
000267 CF86 CBDC             8      SET 3,H
000269 CF88 5E               7      LD  E,(HL)
00026A CF89 71               7      LD  (HL),C
00026B CF8A 4B               4      LD  C,E
       CF8B                     IO_INCDEC   EQU $   ; 自己書き換え
00026C CF8B 23               6      INC HL      ;INS->INC HL or BS->DEC HL
00026D CF8C 10F3            13      DJNZ    IO_INSBS1
00026F CF8E D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000271 CF90 FB               4      EI
000272 CF91 C9              10      RET
                                
       CF92                     IO_SCRUP:
000273 CF92 F3               4      DI
000274 CF93 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF95                     SCRUP1:
000276 CF95 2815            12      JR  Z,SCRCL
000278 CF97 D5              11      PUSH    DE
000279 CF98 E5              11      PUSH    HL
00027A CF99 CBDA             8      SET 3,D
00027C CF9B CBDC             8      SET 3,H
00027E CF9D 012800          10      LD  BC,WIDTH
000281 CFA0 EDB0                    LDIR
000283 CFA2 E1              10      POP HL
000284 CFA3 D1              10      POP DE
000285 CFA4 012800          10      LD  BC,WIDTH
000288 CFA7 EDB0                    LDIR
00028A CFA9 3D               4      DEC A
00028B CFAA 18E9            12      JR  SCRUP1
                                
       CFAC                     SCRCL:
00028D CFAC 0628             7      LD  B,WIDTH
00028F CFAE EB               4      EX  DE,HL
000290 CFAF D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000292 CFB1 CD74D9          17      CALL    CLLINE
000295 CFB4 E1              10      POP HL
000296 CFB5 D1              10      POP DE
000297 CFB6 C1              10      POP BC
000298 CFB7 C9              10      RET
                                
       CFB8                     RD_PCG:
000299 CFB8 F3               4      DI
00029A CFB9 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00029C CFBB 4E               7      LD  C,(HL)
       CFBC                     RW_PCG:
00029D CFBC D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
00029F CFBE FB               4      EI
0002A0 CFBF C9              10      RET
                                
       CFC0                     WR_PCG:
0002A1 CFC0 F3               4      DI
0002A2 CFC1 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
0002A4 CFC3 71               7      LD  (HL),C
0002A5 CFC4 18F6            12      JR  RW_PCG
                                
       CFC6                     IO_MON:
0002A7 CFC6 D3E4            11      OUT (0E4H),A    ;MONITOR ROM(0000H-0FFFH) & VRAM/KEY/TIMER(D000H-FFFFH)
0002A9 CFC8 C7              12      RST 0
                                
                                #IF EXISTS USE_8253
       CFC9                     INITINT:
0002AA CFC9 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0002AC CFCB 2107E0          10      LD  HL,0E007H   ;HL=0E007H 8253 コントロール
0002AF CFCE 36B0            10      LD  (HL),0B0H   ;Ch.2 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 0 16ビットバイナリ
0002B1 CFD0 3674            10      LD  (HL),074H   ;Ch.1 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 2 16ビットバイナリ
0002B3 CFD2 2D               4      DEC L       ;0E006H 8253 Ch.2 カウンタ
0002B4 CFD3 3602            10      LD  (HL),2
0002B6 CFD5 3600            10      LD  (HL),0
0002B8 CFD7 2D               4      DEC L       ;0E005H 8253 Ch.1 カウンタ
0002B9 CFD8 77               7      LD  (HL),A
0002BA CFD9 3600            10      LD  (HL),0
0002BC CFDB 7D               4      LD  A,L     ;L=5
0002BD CFDC 3203E0          13      LD  (0E003H),A  ;8255 コントロールポートでポートC(0E002H)のINTMSKを1にする
0002C0 CFDF D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0002C2 CFE1 C9              10      RET
                                #ENDIF
                                
       CFE2                     IO_INT8253:
                                #IF EXISTS USE_8253
0002C3 CFE2 F5              11      PUSH    AF
0002C4 CFE3 3ACAFF          13      LD  A,(EXTBIO)
0002C7 CFE6 3248D7          13      LD  (INTMEM_SWC),A
0002CA CFE9 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0002CC CFEB 3E01             7      LD  A,1
0002CE CFED 3206E0          13      LD  (0E006H),A  ;8253 Ch.2 カウンタ
0002D1 CFF0 AF               4      XOR A
0002D2 CFF1 3206E0          13      LD  (0E006H),A  ;8253 Ch.2 カウンタ
0002D5 CFF4 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0002D7 CFF6 C326D7          10      JP  INT8253
       CFF9                     ROM8253E:
0002DA CFF9 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0002DC CFFB F1              10      POP AF
                                #ENDIF
0002DD CFFC C9              10      RET
                                
       CFFD                     BANKE:
0002DE CFFD                         DS  0CFFEH-BANKE
[EOF:M7BANK.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MZ-700/1500
                                
       CFFE                     WBOOT1:
0002DF CFFE D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)　ここは0CFFEH
0002E1 D000 D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFHH)
0002E3 D002 F3               4      DI
0002E4 D003 3A94F0          13      LD  A,(_KEYSP_L)
                                #IF EXISTS USE_8253
0002E7 D006 CDC9CF          17      CALL    INITINT
                                #ENDIF
0002EA D009 ED7B0600        20      LD  SP,(SYSTEM+1)
0002EE D00D FB               4      EI
0002EF D00E 2ABAF0          16      LD  HL,(_PAGE_MINUS)
0002F2 D011 2221CF          16      LD  (_NEG_PAGE_SWC),HL
0002F5 D014 2192F0          10      LD  HL,_KEYD
0002F8 D017 3600            10      LD  (HL),0
0002FA D019 CD33DB          17      CALL    CHKEY
0002FD D01C CD6BD7          17      CALL    KEYBC_IFBREAK
000300 D01F 3E04             7      LD  A,4
000302 D021 CD7ED7          17      CALL    MSG_A
[EOF:M7CCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D024                     COMMAND:
000305 D024 3AAAEB          13      LD  A,(FCB_BAT)
000308 D027 B7               4      OR  A
000309 D028 C266D1          10      JP  NZ,C_BAT1
00030C D02B CDDAD0          17      CALL    SETDTA1
00030F D02E 3A0400          13      LD  A,(_DVSW)
000312 D031 C641             7      ADD A,'A'
000314 D033 CD7ED7          17      CALL    MSG_A
000317 D036 3E3E             7      LD  A,'>'
000319 D038 CD7ED7          17      CALL    MSG_A
00031C D03B 3E50             7      LD  A,80
00031E D03D 12               7      LD  (DE),A
00031F D03E CDDED7          17      CALL    _SYS0A      ;(BDOS)文字列入力
000322 D041 CD5BD2          17      CALL    LTNL
       D044                     COMMAND2:
000325 D044 118200          10      LD  DE,DTA1+2
000328 D047 CDFDF0          17      CALL    _COMANL
00032B D04A DC12D7          17      CALL    C,SHOW_ERROR
00032E D04D 18D5            12      JR  COMMAND
                                
       D04F                     COMANL:
000330 D04F CDD5DB          17      CALL    FILE
000333 D052 3A19F0          13      LD  A,(FNAME+4)
000336 D055 FE20             7      CP  020H
000338 D057 201C            12      JR  NZ,COMB2
00033A D059 D5              11      PUSH    DE
00033B D05A 1115F0          10      LD  DE,FNAME
00033E D05D 1A               7      LD  A,(DE)
00033F D05E FE20             7      CP  020H
000341 D060 2844            12      JR  Z,SDVSW
000343 D062 1B               6      DEC DE
000344 D063 1A               7      LD  A,(DE)
000345 D064 C6FF             7      ADD A,0FFH
000347 D066 3809            12      JR  C,COMB
000349 D068 13               6      INC DE
                                
00034A D069 2118D4          10      LD  HL,COMTB
00034D D06C 0609             7      LD  B,COMS
00034F D06E CD62DE          17      CALL    CPNAME
       D071                     COMB:
000352 D071 D1              10      POP DE
000353 D072 D211D7          10      JP  NC,JPHL
       D075                     COMB2:
000356 D075 EB               4      EX  DE,HL
000357 D076 2243D1          16      LD  (COMSWC),HL
00035A D079 F5              11      PUSH    AF
00035B D07A CDFBD0          17      CALL    CEXE4
00035E D07D F1              10      POP AF
00035F D07E 2115F0          10      LD  HL,FNAME
000362 D081 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
000365 D084 010B00          10      LD  BC,11
000368 D087 EDB0                    LDIR
00036A D089 1149EB          10      LD  DE,PATHD
       D08C                     CEX1:
00036D D08C 1A               7      LD  A,(DE)
00036E D08D FE20             7      CP  020H
000370 D08F D8              11      RET C
000371 D090 CDCADB          17      CALL    FILEC
000374 D093 D5              11      PUSH    DE
000375 D094 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
000378 D097 1115F0          10      LD  DE,FNAME
00037B D09A 010B00          10      LD  BC,11
00037E D09D EDB0                    LDIR
000380 D09F CDFBD0          17      CALL    CEXE4
000383 D0A2 D1              10      POP DE
000384 D0A3 13               6      INC DE
000385 D0A4 18E6            12      JR  CEX1
                                
       D0A6                     SDVSW:
000387 D0A6 F1              10      POP AF
000388 D0A7 3A14F0          13      LD  A,(FDRV)
00038B D0AA 3D               4      DEC A
00038C D0AB 5F               4      LD  E,A
00038D D0AC 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
00038F D0AE 1831            12      JR  SYSTEM0
                                
       D0B0                     OPEN1:
000391 D0B0 2114F0          10      LD  HL,FDRV
       D0B3                     OPEN:
000394 D0B3 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D0B5                     OPEN3:
000396 D0B5 D5              11      PUSH    DE
000397 D0B6 1185EB          10      LD  DE,DTA_CCP
00039A D0B9 CDD7D0          17      CALL    SETDTA
00039D D0BC EB               4      EX  DE,HL
00039E D0BD CDE1D0          17      CALL    SYSTEM0
0003A1 D0C0 D1              10      POP DE
0003A2 D0C1 C9              10      RET
                                
       D0C2                     OPEN2:
0003A3 D0C2 0E12             7      LD  C,012H
0003A5 D0C4 18EF            12      JR  OPEN3
                                
       D0C6                     DEFCB:              ;Z=Ok NZ=Error
0003A7 D0C6 1185EB          10      LD  DE,DTA_CCP
0003AA D0C9 CDDFD0          17      CALL    SYSC0F
                                
0003AD D0CC 11A6EB          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0003B0 D0CF 0604             7      LD  B,4
0003B2 D0D1 CD2CD3          17      CALL    ZERO_MEMORY_DE
       D0D4                     SETDTA100:
0003B5 D0D4 110001          10      LD  DE,BUFFER
       D0D7                     SETDTA:
0003B8 D0D7 C352D6          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D0DA                     SETDTA1:
0003BB D0DA 118000          10      LD  DE,DTA1
0003BE D0DD 18F8            12      JR  SETDTA
                                
       D0DF                     SYSC0F:
0003C0 D0DF 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D0E1                     SYSTEM0:
0003C2 D0E1 CD0500          17      CALL    SYSTEM
0003C5 D0E4 B7               4      OR  A
0003C6 D0E5 C9              10      RET
                                
       D0E6                     C_CD:
0003C7 D0E6 0E5A             7      LD  C,05AH
0003C9 D0E8 18F7            12      JR  SYSTEM0
                                
       D0EA                     S27BUF:
0003CB D0EA 2100FE          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       D0ED                     S27BUF2:
0003CE D0ED 39              11      ADD HL,SP
0003CF D0EE 2E00             7      LD  L,0
0003D1 D0F0 7C               4      LD  A,H
0003D2 D0F1 E6F8             7      AND 0F8H
0003D4 D0F3 67               4      LD  H,A
       D0F4                     S27DTA:
0003D5 D0F4 1185EB          10      LD  DE,DTA_CCP
       D0F7                     S27:
0003D8 D0F7 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
0003DA D0F9 18E6            12      JR  SYSTEM0
                                
       D0FB                     CEXE4:
0003DC D0FB 211DF0          10      LD  HL,FNAME+8
0003DF D0FE 7E               7      LD  A,(HL)
0003E0 D0FF FE20             7      CP  020H
0003E2 D101 2007            12      JR  NZ,CEXE7
0003E4 D103 3E3F             7      LD  A,'?'
0003E6 D105 77               7      LD  (HL),A
0003E7 D106 23               6      INC HL
0003E8 D107 77               7      LD  (HL),A
0003E9 D108 23               6      INC HL
0003EA D109 77               7      LD  (HL),A
       D10A                     CEXE7:
0003EB D10A CDB0D0          17      CALL    OPEN1
       D10D                     CEXE5:
0003EE D10D C0              11      RET NZ
0003EF D10E 2A8FEB          16      LD  HL,(DTA_CCP+1+9)
0003F2 D111 7C               4      LD  A,H
0003F3 D112 CDF1DE          17      CALL    CAP
0003F6 D115 67               4      LD  H,A
0003F7 D116 7D               4      LD  A,L
0003F8 D117 CDF1DE          17      CALL    CAP
0003FB D11A 6F               4      LD  L,A
0003FC D11B 3A8EEB          13      LD  A,(DTA_CCP+1+8)
0003FF D11E CDF1DE          17      CALL    CAP
000402 D121 D642             7      SUB 'B'
000404 D123 282C            12      JR  Z,C_BAT
000406 D125 3D               4      DEC A       ;'C'
000407 D126 2805            12      JR  Z,C_EXE
       D128                     CEXE6:
000409 D128 CDC2D0          17      CALL    OPEN2
00040C D12B 18E0            12      JR  CEXE5
                                
       D12D                     C_EXE:
00040E D12D 7C               4      LD  A,H
00040F D12E FE4D             7      CP  'M'
000411 D130 20F6            12      JR  NZ,CEXE6
                                
000413 D132 CDC6D0          17      CALL    DEFCB
000416 D135 CDEAD0          17      CALL    S27BUF_COM
000419 D138 3D               4      DEC A
00041A D139 37               4      SCF
00041B D13A C0              11      RET NZ
00041C D13B 7C               4      LD  A,H
00041D D13C B5               4      OR  L
00041E D13D 37               4      SCF
00041F D13E C8              11      RET Z
000420 D13F CDDAD0          17      CALL    SETDTA1
000423 D142 110000          10      LD  DE,0                ; self-modifying code
       D143                     COMSWC  EQU $-2
000426 D145 ED7B0600        20      LD  SP,(SYSTEM+1)
00042A D149 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
00042B D14A 6F               4      LD  L,A
00042C D14B E5              11      PUSH    HL              ; push $0000 (reboot address)
00042D D14C 24               4      INC H
00042E D14D E5              11      PUSH    HL              ; push $0100 (TPA address)
00042F D14E C3F7D2          10      JP  SETFCB              ; and JP $0100
                                
       D151                     C_BAT:
000432 D151 114154          10      LD  DE,'A'+'T'*256
000435 D154 ED52            15      SBC HL,DE
000437 D156 20D0            12      JR  NZ,CEXE6
                                
000439 D158 CDC6D0          17      CALL    DEFCB
                                
00043C D15B 2185EB          10      LD  HL,DTA_CCP
00043F D15E 11AAEB          10      LD  DE,FCB_BAT
000442 D161 012500          10      LD  BC,37
000445 D164 EDB0                    LDIR
       D166                     C_BAT1:
000447 D166 CDD4D0          17      CALL    SETDTA100
00044A D169 CD9DD1          17      CALL    FGETC_BAT
00044D D16C 218100          10      LD  HL,DTA1+1
000450 D16F 2025            12      JR  NZ,END_BATCH
000452 D171 FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
000454 D173 38F1            12      JR  C,C_BAT1
000456 D175 3620            10      LD  (HL),' '
000458 D177 23               6      INC HL
       D178                     C_BAT2:
000459 D178 77               7      LD  (HL),A
00045A D179 23               6      INC HL
00045B D17A 7D               4      LD  A,L
00045C D17B 3C               4      INC A       ;L==0FFH
00045D D17C 2809            12      JR  Z,RUN_BATCH
00045F D17E CD9DD1          17      CALL    FGETC_BAT
000462 D181 2004            12      JR  NZ,RUN_BATCH
000464 D183 FE20             7      CP  020H
000466 D185 30F1            12      JR  NC,C_BAT2
       D187                     RUN_BATCH:
000468 D187 7D               4      LD  A,L
000469 D188 D67F             7      SUB DTA1-1
00046B D18A 328000          13      LD  (DTA1),A
00046E D18D FE04             7      CP  4
000470 D18F 3805            12      JR  C,END_BATCH
000472 D191 3600            10      LD  (HL),0
000474 D193 C344D0          10      JP  COMMAND2
       D196                     END_BATCH:
000477 D196 AF               4      XOR A       ;バッチファイルを閉じる
000478 D197 32AAEB          13      LD  (FCB_BAT),A
00047B D19A C300F0          10      JP  CPM_BOOT
                                
       D19D                     FGETC_BAT:
00047E D19D 11AAEB          10      LD  DE,FCB_BAT
       D1A0                     FGETC:              ;1文字ずつ読み込む
000481 D1A0 E5              11      PUSH    HL      ;Z:成功
000482 D1A1 210100          10      LD  HL,1
000485 D1A4 CDF7D0          17      CALL    S27
000488 D1A7 E1              10      POP HL
000489 D1A8 3A0001          13      LD  A,(BUFFER)
00048C D1AB C9              10      RET
                                
       D1AC                     C_DEL:
00048D D1AC CDF7D2          17      CALL    SETFCB
000490 D1AF CD94D7          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
000493 D1B2 0E13             7      LD  C,013H
000495 D1B4 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D1B6                     C_REN:
000497 D1B6 CDF7D2          17      CALL    SETFCB
00049A D1B9 3E10             7      LD  A,010H      ;ディレクトリも対象にする
00049C D1BB 326900          13      LD  (FCB1+13),A ;属性
00049F D1BE 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D1C0                     CDEL1:
0004A1 D1C0 115C00          10      LD  DE,FCB1
0004A4 D1C3 CD0500          17      CALL    SYSTEM
0004A7 D1C6 C6FF             7      ADD A,0FFH
0004A9 D1C8 C9              10      RET
                                
       D1C9                     C_DIR:
0004AA D1C9 CDCADB          17      CALL    FILEC
0004AD D1CC 2115F0          10      LD  HL,FDRV+1
0004B0 D1CF CD0DD4          17      CALL    CWILD1
0004B3 D1D2 3EF1             7      LD  A,0F1H
0004B5 D1D4 3221F0          13      LD  (FDRV+13),A
0004B8 D1D7 CDB0D0          17      CALL    OPEN1
       D1DA                     CDIR1:
0004BB D1DA B7               4      OR  A
0004BC D1DB 2008            12      JR  NZ,PDSKF
0004BE D1DD CD28D2          17      CALL    P_NAME
0004C1 D1E0 CDC2D0          17      CALL    OPEN2
0004C4 D1E3 18F5            12      JR  CDIR1
       D1E5                     PDSKF:
0004C6 D1E5 3A14F0          13      LD  A,(FDRV)
0004C9 D1E8 5F               4      LD  E,A
0004CA D1E9 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
0004CC D1EB CD0500          17      CALL    SYSTEM
0004CF D1EE 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
0004D0 D1EF C601             7      ADD A,001H
0004D2 D1F1 D8              11      RET C       ;Aが0FFHだった場合
0004D3 D1F2 3E06             7      LD  A,8-2
       D1F4                     PDS1:               ;HL=未使用クラスタの総数
0004D5 D1F4 3C               4      INC A
0004D6 D1F5 CB19             8      RR  C
0004D8 D1F7 30FB            12      JR  NC,PDS1
       D1F9                     PDS2:               ;B←論理セクタのサイズの上位8ビット
0004DA D1F9 3C               4      INC A
0004DB D1FA CB18             8      RR  B
0004DD D1FC 30FB            12      JR  NC,PDS2
0004DF D1FE 47               4      LD  B,A
                                
0004E0 D1FF 110000          10      LD  DE,0
       D202                     PDS3:
0004E3 D202 29              11      ADD HL,HL
0004E4 D203 EB               4      EX  DE,HL
0004E5 D204 ED6A            15      ADC HL,HL
0004E7 D206 EB               4      EX  DE,HL
0004E8 D207 10F9            13      DJNZ    PDS3
       D209                     PDSKF1:
0004EA D209 CD95D2          17      CALL    PRDEC_DEHL
0004ED D20C 11DAEB          10      LD  DE,FREE
0004F0 D20F CD7FD4          17      CALL    _SYS09      ;(BDOS)文字列出力
0004F3 D212 CD82D2          17      CALL    PUTDRV
0004F6 D215 3E5C             7      LD  A,05CH      ;\
0004F8 D217 CD7ED7          17      CALL    MSG_A
0004FB D21A 2A22F0          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
0004FE D21D AF               4      XOR A
0004FF D21E 11FEFF          10      LD  DE,0-2
000502 D221 19              11      ADD HL,DE
000503 D222 23               6      INC HL
000504 D223 DC92D2          17      CALL    C,PRDEC_HL
000507 D226 1833            12      JR  LTNL
                                
       D228                     P_NAME:
000509 D228 3A86EB          13      LD  A,(DTA_CCP+1)
00050C D22B FE2E             7      CP  '.'
00050E D22D C8              11      RET Z
                                
00050F D22E 3A91EB          13      LD  A,(DTA_CCP+1+00BH)
000512 D231 F5              11      PUSH    AF
000513 D232 CB67             8      BIT 4,A
000515 D234 2808            12      JR  Z,DIR3
000517 D236 11CFEB          10      LD  DE,DIRMES
00051A D239 CD7FD4          17      CALL    _SYS09      ;(BDOS)文字列出力
00051D D23C 180A            12      JR  DIR6
       D23E                     DIR3:
00051F D23E ED5BA4EB        20      LD  DE,(DTA_CCP+1+01EH)
000523 D242 2AA2EB          16      LD  HL,(DTA_CCP+1+01CH)
000526 D245 CD95D2          17      CALL    PRDEC_DEHL
       D248                     DIR6:
000529 D248 F1              10      POP AF
00052A D249 0F               4      RRCA
00052B D24A 9F               4      SBC A,A
00052C D24B E60A             7      AND '*'-020H
00052E D24D C620             7      ADD A,020H
000530 D24F CD7ED7          17      CALL    MSG_A
000533 D252 CD82D2          17      CALL    PUTDRV
000536 D255 2186EB          10      LD  HL,DTA_CCP+1
000539 D258 CDD5D2          17      CALL    FPRNT
                                
       D25B                     LTNL:
00053C D25B 1E03             7      LD  E,3
00053E D25D C3CDF0          10      JP  _PRINT
                                
       D260                     C_PATH:
000541 D260 CDABDC          17      CALL    SPCUT
000544 D263 2149EB          10      LD  HL,PATHD
000547 D266 FE21             7      CP  021H
000549 D268 300C            12      JR  NC,CPATH0
       D26A                     CPATHP:
00054B D26A 7E               7      LD  A,(HL)
00054C D26B 23               6      INC HL
00054D D26C FE20             7      CP  020H
00054F D26E 3F               4      CCF
000550 D26F 30EA            12      JR  NC,LTNL
000552 D271 CD7ED7          17      CALL    MSG_A
000555 D274 18F4            12      JR  CPATHP
       D276                     CPATH0:
000557 D276 FE3B             7      CP  ';'
000559 D278 2001            12      JR  NZ,CPATH1
00055B D27A 13               6      INC DE
       D27B                     CPATH1:
00055C D27B EB               4      EX  DE,HL
00055D D27C 013B00          10      LD  BC,PATHX
000560 D27F EDB0                    LDIR
000562 D281 C9              10      RET
                                
       D282                     PUTDRV:
000563 D282 3A14F0          13      LD  A,(FDRV)
000566 D285 CDDEDC          17      CALL    GETDRV1
000569 D288 C641             7      ADD A,'A'
00056B D28A CD7ED7          17      CALL    MSG_A
00056E D28D 3E3A             7      LD  A,':'
       D28F                     MSG_AR:
000570 D28F C37ED7          10      JP  MSG_A
                                
       D292                     PRDEC_HL:
000573 D292 AF               4      XOR A
000574 D293 5F               4      LD  E,A
000575 D294 57               4      LD  D,A
       D295                     PRDEC_DEHL:
000576 D295 D5              11      PUSH    DE
000577 D296 110FF0          10      LD  DE,DECBF
00057A D299 0605             7      LD  B,5
00057C D29B CD2CD3          17      CALL    ZERO_MEMORY_DE  ;A=0
00057F D29E D1              10      POP DE
                                
000580 D29F 0E20             7      LD  C,32
       D2A1                     DEC1:
000582 D2A1 29              11      ADD HL,HL
000583 D2A2 EB               4      EX  DE,HL
000584 D2A3 ED6A            15      ADC HL,HL
000586 D2A5 EB               4      EX  DE,HL
000587 D2A6 E5              11      PUSH    HL
000588 D2A7 2113F0          10      LD  HL,DECBF+4
00058B D2AA 0605             7      LD  B,5
       D2AC                     DEC2:
00058D D2AC 7E               7      LD  A,(HL)
00058E D2AD 8F               4      ADC A,A
00058F D2AE 27               4      DAA
000590 D2AF 77               7      LD  (HL),A
000591 D2B0 2B               6      DEC HL
000592 D2B1 10F9            13      DJNZ    DEC2
000594 D2B3 E1              10      POP HL
000595 D2B4 0D               4      DEC C
000596 D2B5 20EA            12      JR  NZ,DEC1
                                
000598 D2B7 210FF0          10      LD  HL,DECBF
00059B D2BA 3E20             7      LD  A,020H
00059D D2BC 0604             7      LD  B,4
       D2BE                     DEC3:
00059F D2BE CDCBD2          17      CALL    DEC4
0005A2 D2C1 CDCBD2          17      CALL    DEC4
0005A5 D2C4 23               6      INC HL
0005A6 D2C5 10F7            13      DJNZ    DEC3
       D2C7                     DECX:
0005A8 D2C7 CDCBD2          17      CALL    DEC4
0005AB D2CA AF               4      XOR A
       D2CB                     DEC4:
0005AC D2CB ED6F            18      RLD
0005AE D2CD FE20             7      CP  020H
0005B0 D2CF 2802            12      JR  Z,DEC5
0005B2 D2D1 F630             7      OR  030H
       D2D3                     DEC5:
0005B4 D2D3 18BA            12      JR  MSG_AR
                                
       D2D5                     FPRNT:
0005B6 D2D5 0608             7      LD  B,8 ;ファイル名を表示
0005B8 D2D7 CDE6D2          17      CALL    P_N1
0005BB D2DA 7E               7      LD  A,(HL)
0005BC D2DB CDFDDE          17      CALL    CAP3
0005BF D2DE D8              11      RET C   ;拡張子が無い
                                
0005C0 D2DF 3E2E             7      LD  A,'.'
0005C2 D2E1 CD7ED7          17      CALL    MSG_A
0005C5 D2E4 0603             7      LD  B,3 ;拡張子を表示
       D2E6                     P_N1:
0005C7 D2E6 7E               7      LD  A,(HL)
0005C8 D2E7 CDFDDE          17      CALL    CAP3
0005CB D2EA 3807            12      JR  C,P_N2
0005CD D2EC CD7ED7          17      CALL    MSG_A
0005D0 D2EF 23               6      INC HL
0005D1 D2F0 10F4            13      DJNZ    P_N1
0005D3 D2F2 C9              10      RET
       D2F3                     P_N2:
0005D4 D2F3 23               6      INC HL
0005D5 D2F4 10FD            13      DJNZ    P_N2
0005D7 D2F6 C9              10      RET
                                
       D2F7                     SETFCB:
0005D8 D2F7 CDABDC          17      CALL    SPCUT
0005DB D2FA 1A               7      LD  A,(DE)
0005DC D2FB FE20             7      CP  020H
0005DE D2FD 3801            12      JR  C,SETFCBA
0005E0 D2FF 1B               6      DEC DE
       D300                     SETFCBA:
0005E1 D300 0624             7      LD  B,36
0005E3 D302 215C00          10      LD  HL,FCB1
0005E6 D305 E5              11      PUSH    HL
0005E7 D306 AF               4      XOR A
0005E8 D307 CD80DC          17      CALL    FILL_MEMORY
0005EB D30A E1              10      POP HL
0005EC D30B D5              11      PUSH    DE
0005ED D30C CDB8D6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005F0 D30F 216C00          10      LD  HL,FCB2
0005F3 D312 CDB8D6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005F6 D315 E1              10      POP HL
0005F7 D316 010050          10      LD  BC,05000H
0005FA D319 118100          10      LD  DE,00081H
       D31C                     SETFCB1:
0005FD D31C 7E               7      LD  A,(HL)
0005FE D31D 23               6      INC HL
0005FF D31E FE20             7      CP  020H
000601 D320 3805            12      JR  C,SETFCB2
000603 D322 12               7      LD  (DE),A
000604 D323 13               6      INC DE
000605 D324 0C               4      INC C
000606 D325 10F5            13      DJNZ    SETFCB1
       D327                     SETFCB2:
000608 D327 79               4      LD  A,C
000609 D328 328000          13      LD  (DTA1),A
00060C D32B 04               4      INC B
       D32C                     ZERO_MEMORY_DE:
00060D D32C AF               4      XOR A
       D32D                     FILL_MEMORY_DE:
00060E D32D 12               7      LD  (DE),A
00060F D32E 13               6      INC DE
000610 D32F 10FC            13      DJNZ    FILL_MEMORY_DE
000612 D331 C9              10      RET
                                
       D332                     C_COPY:
000613 D332 CDF7D2          17      CALL    SETFCB
                                
000616 D335 1161F0          10      LD  DE,ZERO
000619 D338 CDCDDB          17      CALL    FILEC2
00061C D33B 216C00          10      LD  HL,FCB2
00061F D33E CDBFD6          17      CALL    S29X1
                                
000622 D341 3E10             7      LD  A,010H
000624 D343 326900          13      LD  (FCB1+13),A
000627 D346 216D00          10      LD  HL,FCB2FN
00062A D349 CD0DD4          17      CALL    CWILD1
       D34C                     COPY0:
00062D D34C CD0AD4          17      CALL    CWILD
000630 D34F 215C00          10      LD  HL,FCB1
000633 D352 CDB3D0          17      CALL    OPEN
000636 D355 37               4      SCF
       D356                     COPY1:
000637 D356 C0              11      RET NZ
000638 D357 CDC6D0          17      CALL    DEFCB
                                
00063B D35A 3A92EB          13      LD  A,(DTA_CCP+13)
00063E D35D CB67             8      BIT 4,A
000640 D35F 2821            12      JR  Z,COPY1A
                                
000642 D361 215D00          10      LD  HL,FCB1FN
000645 D364 CD10E0          17      CALL    CHKWILD
000648 D367 3814            12      JR  C,COPY9
                                
00064A D369 3E20             7      LD  A,020H
00064C D36B 325D00          13      LD  (FCB1FN),A
00064F D36E 2A9FEB          16      LD  HL,(DTA_CCP+26)
000652 D371 23               6      INC HL
000653 D372 226A00          16      LD  (FCB1+14),HL
000656 D375 18D5            12      JR  COPY0
                                
       D377                     COPY8:
000658 D377 CD7FD4          17      CALL    _SYS09      ;(BDOS)文字列出力
00065B D37A CD5BD2          17      CALL    LTNL
       D37D                     COPY9:
00065E D37D CDC2D0          17      CALL    OPEN2
000661 D380 18D4            12      JR  COPY1
                                
       D382                     COPY1A:
000663 D382 216C00          10      LD  HL,FCB2
000666 D385 1114F0          10      LD  DE,FDRV
000669 D388 0187EB          10      LD  BC,DTA_CCP+2
00066C D38B EDA0            16      LDI
00066E D38D 3E0B             7      LD  A,11
       D38F                     COPY2:
000670 D38F F5              11      PUSH    AF
000671 D390 7E               7      LD  A,(HL)
000672 D391 FE3F             7      CP  '?'
000674 D393 2001            12      JR  NZ,COPY3
000676 D395 0A               7      LD  A,(BC)
       D396                     COPY3:
000677 D396 12               7      LD  (DE),A
000678 D397 03               6      INC BC
000679 D398 13               6      INC DE
00067A D399 23               6      INC HL
00067B D39A F1              10      POP AF
00067C D39B 3D               4      DEC A
00067D D39C 20F1            12      JR  NZ,COPY2
00067F D39E 010500          10      LD  BC,16-11
000682 D3A1 EDB0                    LDIR
       D3A3                     PUTNAME:
000684 D3A3 215D00          10      LD  HL,FCB1FN
000687 D3A6 CD10E0          17      CALL    CHKWILD
00068A D3A9 300B            12      JR  NC,PUTN1
00068C D3AB 2115F0          10      LD  HL,FDRV+1
00068F D3AE CDD5D2          17      CALL    FPRNT
000692 D3B1 3E20             7      LD  A,020H
000694 D3B3 CD7ED7          17      CALL    MSG_A
       D3B6                     PUTN1:
000697 D3B6 1114F0          10      LD  DE,FDRV
00069A D3B9 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
00069C D3BB CDE1D0          17      CALL    SYSTEM0
00069F D3BE 2048            12      JR  NZ,COPYE2
0006A1 D3C0 67               4      LD  H,A     ;A=0
0006A2 D3C1 6F               4      LD  L,A
0006A3 D3C2 2235F0          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0006A6 D3C5 2237F0          16      LD  (FDRV+35),HL
       D3C8                     COPY6:
0006A9 D3C8 CDEAD0          17      CALL    S27BUF
0006AC D3CB 47               4      LD  B,A
0006AD D3CC 3C               4      INC A
0006AE D3CD 2831            12      JR  Z,COPYE
0006B0 D3CF 7C               4      LD  A,H
0006B1 D3D0 B5               4      OR  L
0006B2 D3D1 280C            12      JR  Z,COPY7
0006B4 D3D3 1114F0          10      LD  DE,FDRV
0006B7 D3D6 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0006B9 D3D8 CDE1D0          17      CALL    SYSTEM0
0006BC D3DB 2023            12      JR  NZ,COPYE
0006BE D3DD 10E9            13      DJNZ    COPY6
       D3DF                     COPY7:
0006C0 D3DF 3A92EB          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0006C3 D3E2 3221F0          13      LD  (FDRV+13),A
0006C6 D3E5 2199EB          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
0006C9 D3E8 1128F0          10      LD  DE,FDRV+20
0006CC D3EB 010400          10      LD  BC,4
0006CF D3EE EDB0                    LDIR
                                
0006D1 D3F0 1114F0          10      LD  DE,FDRV
0006D4 D3F3 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
0006D6 D3F5 CDE1D0          17      CALL    SYSTEM0
0006D9 D3F8 2006            12      JR  NZ,COPYE
                                
0006DB D3FA 1171F0          10      LD  DE,OK
0006DE D3FD C377D3          10      JP  COPY8
                                
       D400                     COPYE:
0006E1 D400 1114F0          10      LD  DE,FDRV
0006E4 D403 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
0006E6 D405 CD0500          17      CALL    SYSTEM
       D408                     COPYE2:
0006E9 D408 37               4      SCF
0006EA D409 C9              10      RET
                                
       D40A                     CWILD:
0006EB D40A 215D00          10      LD  HL,FCB1FN
       D40D                     CWILD1:
0006EE D40D 7E               7      LD  A,(HL)
0006EF D40E FE20             7      CP  020H
0006F1 D410 C0              11      RET NZ
       D411                     CWILD2:
0006F2 D411 3E3F             7      LD  A,'?'
0006F4 D413 060B             7      LD  B,11
0006F6 D415 C380DC          10      JP  FILL_MEMORY
                                
       D418                     COMTB:
0006F9 D418 44202020                DB  "D   "  ;1
0006FD D41C C9D1                    DW  C_DIR
0006FF D41E 44495220                DB  "DIR "  ;2
000703 D422 C9D1                    DW  C_DIR
000705 D424 434F5059                DB  "COPY"  ;3
000709 D428 32D3                    DW  C_COPY
00070B D42A 43442020                DB  "CD  "  ;4
00070F D42E E6D0                    DW  C_CD
000711 D430 44454C20                DB  "DEL "  ;5
000715 D434 ACD1                    DW  C_DEL
000717 D436 50415448                DB  "PATH"  ;6
00071B D43A 60D2                    DW  C_PATH
00071D D43C 52454E20                DB  "REN "  ;7
000721 D440 B6D1                    DW  C_REN
000723 D442 52454D20                DB  "REM "  ;8
000727 D446 7CD4                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP2.ASM"
                                
                                ;   LSX-Dodgers CCP2
                                ;   MZ-700/1500
                                
000729 D448 4D4F4E20                DB  "MON "  ;9
00072D D44C BADB                    DW  C_MON
[EOF:M7CCP2.ASM:UTF_8]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D44E                     BDOS0:
00072F D44E E5              11      PUSH    HL
000730 D44F 79               4      LD  A,C
000731 D450 FE3C             7      CP  03CH
000733 D452 3802            12      JR  C,DOS1
000735 D454 3E3C             7      LD  A,03CH
       D456                     DOS1:
000737 D456 87               4      ADD A,A
000738 D457 325BD4          13      LD  (DOS1_SWC),A
00073B D45A 2A00F1          16      LD  HL,(STABLE)
       D45B                     DOS1_SWC    EQU $-2
00073E D45D E3              19      EX  (SP),HL
00073F D45E 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
000740 D45F C9              10      RET
       D460                     _DOS2:
000741 D460 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000743 D462 CAFAD6          10      JP  Z,_SYS5A
000746 D465 FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000748 D467 CAB7D6          10      JP  Z,_SYS5C
00074B D46A FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
00074D D46C CA0DE9          10      JP  Z,_SYS5F
000750 D46F FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000752 D471 200A            12      JR  NZ,_ERROR
000754 D473 011D01          10      LD  BC,VER_6F
000757 D476 116201          10      LD  DE,VER
00075A D479 210100          10      LD  HL,MACD
       D47C                     C_REM:
00075D D47C AF               4      XOR A
       D47D                     _ERROR:
00075E D47D A7               4      AND A
00075F D47E C9              10      RET
                                
       D47F                     _SYS09:     ;文字列出力
000760 D47F D5              11      PUSH    DE
       D480                     _SX09:
000761 D480 1A               7      LD  A,(DE)
000762 D481 13               6      INC DE
000763 D482 FE24             7      CP  '$'
000765 D484 2831            12      JR  Z,SX0E2
000767 D486 CD7ED7          17      CALL    MSG_A
00076A D489 18F5            12      JR  _SX09
                                
       D48B                     MSX1:
00076C D48B CD7ED7          17      CALL    MSG_A
       D48E                     MSX:
00076F D48E 7E               7      LD  A,(HL)
000770 D48F 23               6      INC HL
000771 D490 B7               4      OR  A
000772 D491 20F8            12      JR  NZ,MSX1
000774 D493 C9              10      RET
                                
       D494                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000775 D494 212200          10      LD  HL,00022H
000778 D497 7D               4      LD  A,L
000779 D498 C9              10      RET
                                
       D499                     _SYS0D:     ;(BDOS)ディスクリセット
00077A D499 CDDFF0          17      CALL    _FFLUSH
00077D D49C E5              11      PUSH    HL
00077E D49D 218000          10      LD  HL,00080H
000781 D4A0 228AF0          16      LD  (_DTA),HL
000784 D4A3 E1              10      POP HL
000785 D4A4 D5              11      PUSH    DE
000786 D4A5 1E00             7      LD  E,0
000788 D4A7 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D4A8                     _SYS0E:     ;(BDOS)カレントドライブの設定
000789 D4A8 D5              11      PUSH    DE
00078A D4A9 7B               4      LD  A,E
00078B D4AA DDE5            15      PUSH    IX
00078D D4AC CDDCF0          17      CALL    _GETDPB
000790 D4AF DDE1            14      POP IX
000792 D4B1 3804            12      JR  C,SX0E2
000794 D4B3 7B               4      LD  A,E
000795 D4B4 320400          13      LD  (_DVSW),A
       D4B7                     SX0E2:
000798 D4B7 D1              10      POP DE
000799 D4B8 C9              10      RET
                                
       D4B9                     _SYS0F:     ;(BDOS)ファイルのオープン
00079A D4B9 CDBDDC          17      CALL    SETDRV
00079D D4BC FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0007A0 D4BF C602             7      ADD A,002H      ;Write
0007A2 D4C1 2848            12      JR  Z,FEND0F
0007A4 D4C3 CD0CE0          17      CALL    CHKWILDX
                                
0007A7 D4C6 D4E7DC          17      CALL    NC,SOPENX
       D4C9                     _S16XX:
0007AA D4C9 3840            12      JR  C,FEND0F
                                                ;Directory location
0007AC D4CB 3A9FF0          13      LD  A,(_FILEN)
0007AF D4CE FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
0007B2 D4D1 3AA0F0          13      LD  A,(_DIRF)
0007B5 D4D4 FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
0007B8 D4D7 FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
0007BB D4DA FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
0007BE D4DD FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
0007C2 D4E1 FDE5            15      PUSH    IY
0007C4 D4E3 D1              10      POP DE
0007C5 D4E4 13               6      INC DE
0007C6 D4E5 010B00          10      LD  BC,11
0007C9 D4E8 EDB0                    LDIR
                                ;               Attribute
0007CB D4EA 7E               7      LD  A,(HL)
0007CC D4EB FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
0007CF D4EE 110B00          10      LD  DE,11       ;Reserved
0007D2 D4F1 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
0007D3 D4F2 11E4F1          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
0007D6 D4F5 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D4F7                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
0007D8 D4F7 1A               7      LD  A,(DE)
0007D9 D4F8 13               6      INC DE
0007DA D4F9 3200D5          13      LD  (S16PAT),A
0007DD D4FC 7E               7      LD  A,(HL)
0007DE D4FD 23               6      INC HL
0007DF D4FE FD7700          19      LD  (IY+0),A
       D500                     S16PAT  EQU $-1
0007E2 D501 10F4            13      DJNZ    S16LOOP
                                
0007E4 D503 AF               4      XOR A
0007E5 D504 FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
0007E8 D507 FD22A8D5        20      LD  (OFCB_SWC),IY
       D50B                     FEND0F:
0007EC D50B 1845            12      JR  FEND10
                                
       D50D                     _SYS10:     ;(BDOS)ファイルのクローズ
0007EE D50D CDBDDC          17      CALL    SETDRV
0007F1 D510 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0007F4 D513 D6FE             7      SUB 0FEH
0007F6 D515 37               4      SCF
0007F7 D516 3F               4      CCF
0007F8 D517 2039            12      JR  NZ,FEND10
       D519                     _S10A:              ;Write
0007FA D519 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
0007FD D51C FD770F          19      LD  (IY+15),A
                                
000800 D51F FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
000803 D522 CD08E1          17      CALL    SETTMS
                                
000806 D525 FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000809 D528 32A0F0          13      LD  (_DIRF),A
00080C D52B E67F             7      AND 07FH
00080E D52D 322DE6          13      LD  (_SECPS),A
000811 D530 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000814 D533 FD561F          19      LD  D,(IY+31)
000817 D536 CD1BDE          17      CALL    READ_DIR
00081A D539 3817            12      JR  C,FEND10
                                
00081C D53B 3A47DD          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
00081F D53E 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000820 D53F FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000823 D542 6F               4      LD  L,A
000824 D543 2600             7      LD  H,0
000826 D545 29              11      ADD HL,HL       ;*2
000827 D546 29              11      ADD HL,HL       ;*4
000828 D547 29              11      ADD HL,HL       ;*8
000829 D548 29              11      ADD HL,HL       ;*16
00082A D549 29              11      ADD HL,HL       ;*32
00082B D54A ED4B7EF1        20      LD  BC,(_DTBUF)
00082F D54E 09              11      ADD HL,BC
                                
000830 D54F CD1CE0          17      CALL    SDIRENT
       D552                     FEND10:
000833 D552 1842            12      JR  FEND
                                
       D554                     _SYS11:     ;(BDOS)最初のファイルの検索
000835 D554 CDBDDC          17      CALL    SETDRV
000838 D557 CD16DD          17      CALL    SOPEN
       D55A                     _S12X1:
00083B D55A 383A            12      JR  C,FEND
00083D D55C CDB5DD          17      CALL    SOPENE2
000840 D55F ED5B8AF0        20      LD  DE,(_DTA)
000844 D563 3A88F0          13      LD  A,(_DRV)
000847 D566 3C               4      INC A
000848 D567 12               7      LD  (DE),A
000849 D568 D5              11      PUSH    DE
00084A D569 13               6      INC DE
00084B D56A 012000          10      LD  BC,32
00084E D56D EDB0                    LDIR
000850 D56F FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000853 D572 FD660F          19      LD  H,(IY+15)
000856 D575 22F4F1          16      LD  (SCDIR),HL
000859 D578 2A9AF0          16      LD  HL,(_FBPS)
00085C D57B 22F6F1          16      LD  (SFBPS),HL
00085F D57E 2A9FF0          16      LD  HL,(_FILEN)
000862 D581 7C               4      LD  A,H
000863 D582 B7               4      OR  A
000864 D583 2806            12      JR  Z,_S12DIR
000866 D585 3A2DE6          13      LD  A,(_SECPS)
000869 D588 F680             7      OR  080H
00086B D58A 67               4      LD  H,A
       D58B                     _S12DIR:
00086C D58B 22F8F1          16      LD  (SFNDF),HL  ;Directory position and Flags
00086F D58E E1              10      POP HL
000870 D58F 1139F0          10      LD  DE,SFILE
000873 D592 0E21             7      LD  C,33
       D594                     _S11B:
000875 D594 EDB0                    LDIR
       D596                     FEND:
000877 D596 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D597                     FENDE:
000878 D597 FDE1            14      POP IY
00087A D599 C1              10      POP BC
00087B D59A D1              10      POP DE
00087C D59B E1              10      POP HL
00087D D59C C9              10      RET
                                
       D59D                     _SYS12:     ;(BDOS)次のファイルの検索
00087E D59D E5              11      PUSH    HL
00087F D59E D5              11      PUSH    DE
000880 D59F C5              11      PUSH    BC
000881 D5A0 FDE5            15      PUSH    IY
000883 D5A2 CD7ADD          17      CALL    NOPEN
000886 D5A5 18B3            12      JR  _S12X1
                                
       D5A7                     _S16K:
000888 D5A7 110000          10      LD  DE,0
       D5A8                     OFCB_SWC    EQU $-2
00088B D5AA D5              11      PUSH    DE
00088C D5AB 061A             7      LD  B,26        ;First cluster
       D5AD                     S16K1:
00088E D5AD 13               6      INC DE
00088F D5AE 23               6      INC HL
000890 D5AF 10FC            13      DJNZ    S16K1
                                
000892 D5B1 1A               7      LD  A,(DE)
000893 D5B2 BE               7      CP  (HL)
000894 D5B3 2015            12      JR  NZ,S16K2
000896 D5B5 13               6      INC DE
000897 D5B6 23               6      INC HL
000898 D5B7 1A               7      LD  A,(DE)
000899 D5B8 BE               7      CP  (HL)
00089A D5B9 200F            12      JR  NZ,S16K2
                                
00089C D5BB E1              10      POP HL
00089D D5BC FDE5            15      PUSH    IY
00089F D5BE D1              10      POP DE
0008A0 D5BF 7E               7      LD  A,(HL)
0008A1 D5C0 CDD2DC          17      CALL    IS_SAME_DRV_A_DE
0008A4 D5C3 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
0008A6 D5C5 ED52            15      SBC HL,DE       ;CP HL,DE
0008A8 D5C7 37               4      SCF
0008A9 D5C8 C0              11      RET NZ
0008AA D5C9 E5              11      PUSH    HL
       D5CA                     S16K2:
0008AB D5CA E1              10      POP HL
       D5CB                     S16K3:
0008AC D5CB FDE5            15      PUSH    IY
0008AE D5CD D1              10      POP DE
       D5CE                     _SYS13:     ;(BDOS)ファイルの削除
0008AF D5CE CDBDDC          17      CALL    SETDRV
0008B2 D5D1 CD44DF          17      CALL    KILL
       D5D4                     FEND13:
0008B5 D5D4 18C0            12      JR  FEND
                                
       D5D6                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0008B7 D5D6 CDBDDC          17      CALL    SETDRV
0008BA D5D9 CD80E4          17      CALL    INIT_SEQ
       D5DC                     SREAD:
0008BD D5DC CD52E4          17      CALL    RB_READ
                                
0008C0 D5DF C601             7      ADD A,001H
0008C2 D5E1 38B3            12      JR  C,FEND
                                
0008C4 D5E3 7D               4      LD  A,L
0008C5 D5E4 D601             7      SUB 001H
       D5E6                     FENDX:
0008C7 D5E6 9F               4      SBC A,A
0008C8 D5E7 E603             7      AND 3
0008CA D5E9 1F               4      RRA
0008CB D5EA 18AB            12      JR  FENDE
                                
       D5EC                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
0008CD D5EC CDBDDC          17      CALL    SETDRV
0008D0 D5EF CD80E4          17      CALL    INIT_SEQ
       D5F2                     SWRITE:
0008D3 D5F2 CD4DE4          17      CALL    RB_WRITE
                                
0008D6 D5F5 C6FF             7      ADD A,0FFH
0008D8 D5F7 18ED            12      JR  FENDX
                                
       D5F9                     _SYS17:     ;(BDOS)ファイル名の変更
0008DA D5F9 CDBDDC          17      CALL    SETDRV
0008DD D5FC CD9ADF          17      CALL    NAME
0008E0 D5FF 18D3            12      JR  FEND13
                                
       D601                     _SYS16:     ;(BDOS)ファイルの作成
0008E2 D601 CDBDDC          17      CALL    SETDRV
                                
0008E5 D604 CD0CE0          17      CALL    CHKWILDX
0008E8 D607 38CB            12      JR  C,FEND13
0008EA D609 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
0008ED D60C FE05             7      CP  5
0008EF D60E 2805            12      JR  Z,_S16X2
0008F1 D610 FE21             7      CP  021H
0008F3 D612 DAD4D5          10      JP  C,FEND13
       D615                     _S16X2:
                                ;               Clear FCB
0008F6 D615 FDE5            15      PUSH    IY
0008F8 D617 E1              10      POP HL
0008F9 D618 011000          10      LD  BC,16
0008FC D61B 09              11      ADD HL,BC
       D61C                     _S16X1:
0008FD D61C 70               7      LD  (HL),B      ;B=0
0008FE D61D 23               6      INC HL
0008FF D61E 0D               4      DEC C
000900 D61F 20FB            12      JR  NZ,_S16X1
                                
000902 D621 CD0DE1          17      CALL    SETTMSX
000905 D624 FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000909 D628 CDE7DC          17      CALL    SOPENX
00090C D62B 3F               4      CCF
00090D D62C CCA7D5          17      CALL    Z,_S16K
000910 D62F D4C6DD          17      CALL    NC,COPEN
000913 D632 D41CE0          17      CALL    NC,SDIRENT
000916 D635 C3C9D4          10      JP  _S16XX
                                
       D638                     _SYS21:     ;(BDOS)ランダムな読み出し
000919 D638 CDBDDC          17      CALL    SETDRV
00091C D63B CD58E1          17      CALL    INIT_RND
00091F D63E 189C            12      JR  SREAD
                                
       D640                     _SYS22:     ;(BDOS)ランダムな書き込み
       D640                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000921 D640 CDBDDC          17      CALL    SETDRV
000924 D643 CD58E1          17      CALL    INIT_RND
000927 D646 18AA            12      JR  SWRITE
                                
       D648                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000929 D648 21FF00          10      LD  HL,000FFH
00092C D64B AF               4      XOR A
00092D D64C C9              10      RET
                                
       D64D                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
00092E D64D 3A0400          13      LD  A,(_DVSW)   ;from LDOS
000931 D650 A7               4      AND A
000932 D651 C9              10      RET
                                
       D652                     _SYS1A:     ;(BDOS)DTAの設定
000933 D652 ED538AF0        20      LD  (_DTA),DE
000937 D656 AF               4      XOR A
000938 D657 C9              10      RET
                                
       D658                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000939 D658 7B               4      LD  A,E
00093A D659 CDCBDC          17      CALL    GETDRV
00093D D65C CDDCF0          17      CALL    _GETDPB
000940 D65F D4E2F0          17      CALL    NC,_RDFATX
000943 D662 210000          10      LD  HL,0
000946 D665 D4E6E0          17      CALL    NC,DSKF
                                
000949 D668 ED5BE7E0        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
00094D D66C 1B               6      DEC DE      ;DE←クラスタの総数
00094E D66D FD2A7CF1        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000952 D671 9F               4      SBC A,A
000953 D672 D8              11      RET C
000954 D673 4F               4      LD  C,A     ;C=0
000955 D674 DD7E0F          19      LD  A,(IX+DPB_BPS)
000958 D677 E607             7      AND 7
00095A D679 47               4      LD  B,A
00095B D67A DD7E07          19      LD  A,(IX+DPB_SECPCL)
00095E D67D C9              10      RET
                                
       D67E                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
00095F D67E AF               4      XOR A
000960 D67F 67               4      LD  H,A
000961 D680 6F               4      LD  L,A
000962 D681 C9              10      RET
                                
       D682                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000963 D682 2100F2          10      LD  HL,_DEVICE
000966 D685 7B               4      LD  A,E
000967 D686 C3DCF0          10      JP  _GETDPB
                                
       D689                     _SYS23:     ;(BDOS)ファイルサイズの獲得
00096A D689 E5              11      PUSH    HL
00096B D68A 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
00096D D68C CD4ED4          17      CALL    BDOS0
000970 D68F 381B            12      JR  C,_S23X1
                                
000972 D691 D5              11      PUSH    DE      ;EX DE,IY
000973 D692 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000975 D694 FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000978 D697 FD6E11          19      LD  L,(IY+17)   ;
00097B D69A FD6612          19      LD  H,(IY+18)   ;
00097E D69D C5              11      PUSH    BC      ;
00097F D69E FD4613          19      LD  B,(IY+19)   ;
000982 D6A1 CD4AE1          17      CALL    GET_CPM_R_SIZE
000985 D6A4 C1              10      POP BC
       D6A5                     _S24X1:
000986 D6A5 CD6AE1          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000989 D6A8 FDE3            23      EX  (SP),IY     ;
00098B D6AA D1              10      POP DE      ;
                                
00098C D6AB AF               4      XOR A
       D6AC                     _S23X1:
00098D D6AC E1              10      POP HL
00098E D6AD C9              10      RET
                                
       D6AE                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
00098F D6AE E5              11      PUSH    HL
000990 D6AF D5              11      PUSH    DE      ;EX DE,IY
000991 D6B0 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000993 D6B2 CD88E4          17      CALL    GETSEQ
000996 D6B5 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D6B7                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000998 D6B7 2B               6      DEC HL
       D6B8                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000999 D6B8 C5              11      PUSH    BC
00099A D6B9 E5              11      PUSH    HL
00099B D6BA CDD5DB          17      CALL    FILE
00099E D6BD E1              10      POP HL
00099F D6BE C1              10      POP BC
       D6BF                     S29X1:
0009A0 D6BF C5              11      PUSH    BC
0009A1 D6C0 D5              11      PUSH    DE
0009A2 D6C1 E5              11      PUSH    HL
0009A3 D6C2 EB               4      EX  DE,HL
0009A4 D6C3 AF               4      XOR A
0009A5 D6C4 3221F0          13      LD  (FDRV+13),A
0009A8 D6C7 2114F0          10      LD  HL,FDRV
0009AB D6CA 011000          10      LD  BC,16
0009AE D6CD EDB0                    LDIR
0009B0 D6CF E1              10      POP HL
0009B1 D6D0 D1              10      POP DE
0009B2 D6D1 C1              10      POP BC
0009B3 D6D2 C9              10      RET
                                
       D6D3                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
0009B4 D6D3 C5              11      PUSH    BC
0009B5 D6D4 01CEE7          10      LD  BC,DWT24B
0009B8 D6D7 1804            12      JR  S2FX
       D6D9                     _SYS2F:
0009BA D6D9 C5              11      PUSH    BC
0009BB D6DA 01C0E7          10      LD  BC,DRD24B
       D6DD                     S2FX:
0009BE D6DD ED43F3D6        20      LD  (S2F_SWC),BC
0009C2 D6E1 CDDFF0          17      CALL    _FFLUSH
                                
0009C5 D6E4 D5              11      PUSH    DE
0009C6 D6E5 E5              11      PUSH    HL
0009C7 D6E6 7D               4      LD  A,L     ;Drive
0009C8 D6E7 CDD9F0          17      CALL    _CHGDRV
0009CB D6EA 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
0009CD D6EC 44               4      LD  B,H     ;Number of clusters
0009CE D6ED 2A8AF0          16      LD  HL,(_DTA)
                                
0009D1 D6F0 0E00             7      LD  C,0
0009D3 D6F2 CDC0E7          17      CALL    DRD24B
       D6F3                     S2F_SWC EQU $-2
       D6F5                     POP_HL_DE_BC_SBCAA_RET:
0009D6 D6F5 E1              10      POP HL
0009D7 D6F6 D1              10      POP DE
0009D8 D6F7 C1              10      POP BC
0009D9 D6F8 9F               4      SBC A,A
0009DA D6F9 C9              10      RET
                                
       D6FA                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
0009DB D6FA C5              11      PUSH    BC
0009DC D6FB D5              11      PUSH    DE
0009DD D6FC E5              11      PUSH    HL
0009DE D6FD CDCADB          17      CALL    FILEC
0009E1 D700 21F5D6          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
0009E4 D703 E5              11      PUSH    HL
0009E5 D704 3A21F0          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
0009E8 D707 E610             7      AND 010H        ;ディレクトリ
0009EA D709 37               4      SCF
0009EB D70A C8              11      RET Z
0009EC D70B 1114F0          10      LD  DE,FDRV
0009EF D70E 2A4EF1          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       D711                     JPHL:
0009F2 D711 E9               4      JP  (HL)
                                
       D712                     SHOW_ERROR:         ;(9)
0009F3 D712 1179F0          10      LD  DE,COMERM
0009F6 D715 CD7FD4          17      CALL    _SYS09      ;(BDOS)文字列出力
0009F9 D718 C300F0          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "M7IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                
       D47D                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D47D                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D47D                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D47D                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D47D                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D47D                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
                                #IF EXISTS USE_8253
       D71B                     ARWKEY:
0009FC D71B 3D               4      DEC A
0009FD D71C 3237D7          13      LD  (KEYAR),A
000A00 D71F 1826            12      JR  INT8253E
       D721                     SETKEY1:
000A02 D721 3A95F0          13      LD  A,(_KEYSP_H)
000A05 D724 1815            12      JR  SETKEY
       D726                     INT8253:
000A07 D726 CD33DB          17      CALL    CHKEY
000A0A D729 FE00             7      CP  0
       D72A                     KEYDT   EQU $-1
000A0C D72B 20F4            12      JR  NZ,SETKEY1
000A0E D72D E5              11      PUSH    HL
000A0F D72E 2A90F0          16      LD  HL,(_KEYPS)
000A12 D731 7C               4      LD  A,H
000A13 D732 AD               4      XOR L
000A14 D733 E1              10      POP HL
000A15 D734 2011            12      JR  NZ,INT8253E
000A17 D736 3E00             7      LD  A,0
       D737                     KEYAR   EQU $-1
000A19 D738 B7               4      OR  A
000A1A D739 20E0            12      JR  NZ,ARWKEY
       D73B                     SETKEY:
000A1C D73B 3237D7          13      LD  (KEYAR),A
000A1F D73E CD0DDB          17      CALL    GETKEYD
000A22 D741 322AD7          13      LD  (KEYDT),A
000A25 D744 CD51D7          17      CALL    KEYSET
       D747                     INT8253E:
000A28 D747 3E00             7      LD  A,0
       D748                     INTMEM_SWC  EQU $-1
000A2A D749 FEC9             7      CP  0C9H        ;RAMの場合はEXTBIOにRETが入っている
000A2C D74B C2F9CF          10      JP  NZ,ROM8253E
000A2F D74E F1              10      POP AF
000A30 D74F FB               4      EI
000A31 D750 C9              10      RET
       D751                     KEYSET:
       D751                     KEYBS:
000A32 D751 B7               4      OR  A
000A33 D752 C8              11      RET Z
       D753                     KEYBS1:
000A34 D753 CD6BD7          17      CALL    KEYBC_IFBREAK
000A37 D756 E5              11      PUSH    HL
000A38 D757 F5              11      PUSH    AF
000A39 D758 2A90F0          16      LD  HL,(_KEYPS)
000A3C D75B 2C               4      INC L
000A3D D75C CBAD             8      RES 5,L
000A3F D75E 7D               4      LD  A,L
000A40 D75F BC               4      CP  H
000A41 D760 2815            12      JR  Z,POP_AF_HL_SCF_RET
000A43 D762 3290F0          13      LD  (_KEYPS),A
000A46 D765 26F3             7      LD  H,HIGH KEYBF
000A48 D767 F1              10      POP AF
000A49 D768 77               7      LD  (HL),A
000A4A D769 E1              10      POP HL
000A4B D76A C9              10      RET
       D76B                     KEYBC_IFBREAK:
000A4C D76B FE03             7      CP  3
000A4E D76D C0              11      RET NZ
       D76E                     KEYBC:
000A4F D76E E5              11      PUSH    HL
000A50 D76F 210000          10      LD  HL,0
000A53 D772 2290F0          16      LD  (_KEYPS),HL
000A56 D775 E1              10      POP HL
000A57 D776 C9              10      RET
                                #ENDIF
                                
       D777                     POP_AF_HL_SCF_RET:
000A58 D777 F1              10      POP AF
000A59 D778 E1              10      POP HL
000A5A D779 37               4      SCF
                                #IF EXISTS USE_8253
                                #ELSE
                                KEYBC_IFBREAK:
                                #ENDIF
000A5B D77A C9              10      RET
                                
       D77B                     _SYS01:     ;(BDOS)コンソール入力
000A5C D77B CD09F0          17      CALL    _SYS07
       D77E                     MSG_A:
000A5F D77E F5              11      PUSH    AF
000A60 D77F D5              11      PUSH    DE
000A61 D780 5F               4      LD  E,A
000A62 D781 CD87D7          17      CALL    _SYS02
000A65 D784 D1              10      POP DE
000A66 D785 F1              10      POP AF
000A67 D786 C9              10      RET
                                
       D787                     _SYS02:     ;(BDOS)コンソール出力
000A68 D787 CD99D7          17      CALL    BREAK
000A6B D78A 1805            12      JR  PRINTX
                                
       D78C                     _SYS06:     ;(BDOS)コンソール直接入出力
000A6D D78C 7B               4      LD  A,E
000A6E D78D 3C               4      INC A
000A6F D78E CACAF0          10      JP  Z,_INKEY
       D791                     PRINTX:
000A72 D791 C3CDF0          10      JP  _PRINT
                                
       D794                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000A75 D794 CD09F0          17      CALL    _SYS07
000A78 D797 1804            12      JR  BREAK1
       D799                     BREAK:
                                #IF EXISTS USE_8253
000A7A D799 FB               4      EI
000A7B D79A 3A92F0          13      LD  A,(_KEYD)
                                #ELSE
                                    CALL    CHKEY
                                #ENDIF
       D79D                     BREAK1:
000A7E D79D FE03             7      CP  3       ;CTRL+C
000A80 D79F CCF4F0          17      CALL    Z,_BREAK
000A83 D7A2 FE13             7      CP  013H        ;CTRL+S
000A85 D7A4 C0              11      RET NZ
                                
       D7A5                     PAUSE:
                                #IF EXISTS USE_8253
000A86 D7A5 CD6ED7          17      CALL    KEYBC
                                #ENDIF
                                
       D7A8                     FLGET:
000A89 D7A8 CDDFF0          17      CALL    _FFLUSH
000A8C D7AB E5              11      PUSH    HL
000A8D D7AC 2A8EF0          16      LD  HL,(_TXADR)
000A90 D7AF 7C               4      LD  A,H
000A91 D7B0 C6D0             7      ADD A,0D0H
000A93 D7B2 67               4      LD  H,A
000A94 D7B3 CD43CF          17      CALL    RDMMIO
000A97 D7B6 32CBD7          13      LD  (FLSMC),A
       D7B9                     FLGET1:
000A9A D7B9 CD39CF          17      CALL    RD556VSYNC
000A9D D7BC CB77             8      BIT 6,A
000A9F D7BE 3EEF             7      LD  A,0EFH      ;カーソル
000AA1 D7C0 280A            12      JR  Z,FLGET2
000AA3 D7C2 CD0DDB          17      CALL    GETKEYD
000AA6 D7C5 B7               4      OR  A
000AA7 D7C6 3EEF             7      LD  A,0EFH      ;カーソル
000AA9 D7C8 2002            12      JR  NZ,FLGET2
000AAB D7CA 3E00             7      LD  A,0     ;自己書き換え
       D7CB                     FLSMC   EQU $-1
       D7CC                     FLGET2:
000AAD D7CC CD4BCF          17      CALL    WRMMIO
000AB0 D7CF CDCAF0          17      CALL    _INKEY
000AB3 D7D2 28E5            12      JR  Z,FLGET1
000AB5 D7D4 F5              11      PUSH    AF
000AB6 D7D5 3ACBD7          13      LD  A,(FLSMC)
000AB9 D7D8 CD4BCF          17      CALL    WRMMIO
000ABC D7DB F1              10      POP AF
000ABD D7DC E1              10      POP HL
000ABE D7DD C9              10      RET
                                
       D7DE                     _SYS0A:     ;(BDOS)文字列入力
000ABF D7DE C5              11      PUSH    BC
000AC0 D7DF E5              11      PUSH    HL
000AC1 D7E0 D5              11      PUSH    DE
000AC2 D7E1 CD80DA          17      CALL    GETL
000AC5 D7E4 1130FF          10      LD  DE,KBUF
000AC8 D7E7 E1              10      POP HL
000AC9 D7E8 E5              11      PUSH    HL
000ACA D7E9 0E00             7      LD  C,0
000ACC D7EB 3004            12      JR  NC,SAX0
000ACE D7ED 23               6      INC HL
000ACF D7EE 23               6      INC HL
000AD0 D7EF 1808            12      JR  SAX4
       D7F1                     SAX0:
000AD2 D7F1 46               7      LD  B,(HL)
000AD3 D7F2 23               6      INC HL
       D7F3                     SAX1:
000AD4 D7F3 23               6      INC HL
000AD5 D7F4 1A               7      LD  A,(DE)
000AD6 D7F5 13               6      INC DE
000AD7 D7F6 B7               4      OR  A
000AD8 D7F7 2004            12      JR  NZ,SAX2
       D7F9                     SAX4:
000ADA D7F9 360D            10      LD  (HL),00DH
000ADC D7FB 1804            12      JR  SAX3
       D7FD                     SAX2:
000ADE D7FD 77               7      LD  (HL),A
000ADF D7FE 0C               4      INC C
000AE0 D7FF 10F2            13      DJNZ    SAX1
       D801                     SAX3:
000AE2 D801 D1              10      POP DE
000AE3 D802 79               4      LD  A,C
000AE4 D803 13               6      INC DE
000AE5 D804 12               7      LD  (DE),A
000AE6 D805 1B               6      DEC DE
000AE7 D806 E1              10      POP HL
000AE8 D807 C1              10      POP BC
000AE9 D808 A7               4      AND A
000AEA D809 C9              10      RET
                                
       D80A                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000AEB D80A CD99D7          17      CALL    BREAK
000AEE D80D B7               4      OR  A
000AEF D80E C8              11      RET Z
                                
       D80F                     CONSTX:
000AF0 D80F CDDFF0          17      CALL    _FFLUSH
                                #IF EXISTS USE_8253
000AF3 D812 E5              11      PUSH    HL
000AF4 D813 2A90F0          16      LD  HL,(_KEYPS)
000AF7 D816 7C               4      LD  A,H
000AF8 D817 AD               4      XOR L
000AF9 D818 E1              10      POP HL
000AFA D819 C6FF             7      ADD A,0FFH
                                #ELSE
                                    CALL    INKEY
                                    RET Z
                                    XOR A
                                    LD  (SKIP_KEYWAIT),A
                                    SCF
                                #ENDIF
000AFC D81B 9F               4      SBC A,A
000AFD D81C C9              10      RET
                                
       D81D                     _SYS2A:     ;(BDOS)日付の獲得
       D81D                     _SYS2C:     ;(BDOS)時刻の獲得
000AFE D81D AF               4      XOR A
000AFF D81E 57               4      LD  D,A
000B00 D81F 5F               4      LD  E,A
000B01 D820 67               4      LD  H,A
000B02 D821 6F               4      LD  L,A
000B03 D822 C9              10      RET
                                
       D823                     ESC1:
000B04 D823 7B               4      LD  A,E
000B05 D824 FE41             7      CP  'A'
000B07 D826 CA1BD9          10      JP  Z,CTRL1E
000B0A D829 FE42             7      CP  'B'
000B0C D82B CA43DA          10      JP  Z,CTRL1F
000B0F D82E FE43             7      CP  'C'
000B11 D830 CAEED8          10      JP  Z,CTRL1C
000B14 D833 FE44             7      CP  'D'
000B16 D835 CA12D9          10      JP  Z,CTRL1D
000B19 D838 FE45             7      CP  'E'
000B1B D83A 2802            12      JR  Z,CT0CX
000B1D D83C FE6A             7      CP  'j'
       D83E                     CT0CX:
000B1F D83E CA27DA          10      JP  Z,CTRL0C
000B22 D841 FE48             7      CP  'H'
000B24 D843 CA94D9          10      JP  Z,CTRL0B
000B27 D846 FE4A             7      CP  'J'
000B29 D848 CA2ADA          10      JP  Z,CTRL06
000B2C D84B FE4B             7      CP  'K'
000B2E D84D CA66D9          10      JP  Z,CTRL05
000B31 D850 FE4C             7      CP  'L'
000B33 D852 CA55DA          10      JP  Z,CTRL0E
000B36 D855 FE54             7      CP  'T'
000B38 D857 CA66D9          10      JP  Z,CTRL05
000B3B D85A FE78             7      CP  'x'
000B3D D85C 2804            12      JR  Z,ESC1X
000B3F D85E FE79             7      CP  'y'
000B41 D860 2002            12      JR  NZ,ESC1Y
       D862                     ESC1X:
000B43 D862 3601            10      LD  (HL),1
       D864                     ESC1Y:
000B45 D864 FE3D             7      CP  '='
000B47 D866 2804            12      JR  Z,ESC1W
000B49 D868 FE59             7      CP  'Y'
000B4B D86A 2002            12      JR  NZ,ESC1Z
       D86C                     ESC1W:
000B4D D86C 3602            10      LD  (HL),2
       D86E                     ESC1Z:
000B4F D86E FE20             7      CP  020H
000B51 D870 3802            12      JR  C,ESC1C
000B53 D872 87               4      ADD A,A
000B54 D873 D0              11      RET NC
       D874                     ESC1C:
000B55 D874 E1              10      POP HL
000B56 D875 1832            12      JR  ANK
                                
       D877                     ESC:
000B58 D877 21DAD8          10      LD  HL,PRINTE5
000B5B D87A E5              11      PUSH    HL
000B5C D87B 219DD8          10      LD  HL,ESCFLG
000B5F D87E 3600            10      LD  (HL),0
000B61 D880 3D               4      DEC A
000B62 D881 28A0            12      JR  Z,ESC1
000B64 D883 3D               4      DEC A
000B65 D884 2009            12      JR  NZ,ESC2
000B67 D886 3603            10      LD  (HL),3
000B69 D888 7B               4      LD  A,E
000B6A D889 D620             7      SUB 020H
000B6C D88B 3292D8          13      LD  (ESCYP+1),A
000B6F D88E C9              10      RET
       D88F                     ESC2:
000B70 D88F 3D               4      DEC A
000B71 D890 C0              11      RET NZ
000B72 D891 2600             7  ESCYP:  LD  H,0
000B74 D893 7B               4      LD  A,E
000B75 D894 D620             7      SUB 020H
000B77 D896 6F               4      LD  L,A
000B78 D897 C3D6F0          10      JP  _LOC
                                
       D89A                     PRINT:
000B7B D89A C5              11      PUSH    BC
000B7C D89B E5              11      PUSH    HL
000B7D D89C 3E00             7      LD  A,000H      ;自己書き換え
       D89D                     ESCFLG  EQU $-1
000B7F D89E B7               4      OR  A
000B80 D89F 20D6            12      JR  NZ,ESC
                                
000B82 D8A1 3E1F             7      LD  A,01FH
000B84 D8A3 BB               4      CP  E
000B85 D8A4 3038            12      JR  NC,CTRL
       D8A6                     INSFLG  EQU $
000B87 D8A6 01F0D9          10      LD  BC,INSERT   ;自己書き換え
       D8A9                     ANK:
000B8A D8A9 3A96F0          13      LD  A,(_COLORF)
000B8D D8AC 4F               4      LD  C,A
000B8E D8AD 7B               4      LD  A,E
000B8F D8AE FE61             7      CP  'a'     ;英小文字
000B91 D8B0 3806            12      JR  C,PRT1
000B93 D8B2 FE7B             7      CP  'z'+1
000B95 D8B4 3002            12      JR  NC,PRT1
000B97 D8B6 CBF9             8      SET 7,C
       D8B8                     PRT1:
000B99 D8B8 FE86             7      CP  $86     ;ひらがな1(を－そ)
000B9B D8BA 3806            12      JR  C,PRT2
000B9D D8BC FEA0             7      CP  $A0
000B9F D8BE 3002            12      JR  NC,PRT2
000BA1 D8C0 CBF9             8      SET 7,C
       D8C2                     PRT2:
000BA3 D8C2 FEE0             7      CP  $E0     ;ひらがな2(たーん)
000BA5 D8C4 3802            12      JR  C,PRT3
000BA7 D8C6 CBF9             8      SET 7,C
       D8C8                     PRT3:
000BA9 D8C8 2A8EF0          16      LD  HL,(_TXADR)
000BAC D8CB 7C               4      LD  A,H
000BAD D8CC C6D0             7      ADD A,0D0H
000BAF D8CE 67               4      LD  H,A
000BB0 D8CF 42               4      LD  B,D
000BB1 D8D0 16EE             7      LD  D,HIGH CD_TABLE
000BB3 D8D2 1A               7      LD  A,(DE)
000BB4 D8D3 50               4      LD  D,B
000BB5 D8D4 CD63CF          17      CALL    IO_PRINT
000BB8 D8D7 CDEED8          17      CALL    CTRL1C
       D8DA                     PRINTE5:
000BBB D8DA E1              10      POP HL
000BBC D8DB C1              10      POP BC
000BBD D8DC AF               4      XOR A
000BBE D8DD C9              10      RET
                                
       D8DE                     CTRL:
000BBF D8DE 7B               4      LD  A,E
000BC0 D8DF 87               4      ADD A,A
000BC1 D8E0 F680             7      OR  080H
000BC3 D8E2 6F               4      LD  L,A
000BC4 D8E3 26F1             7      LD  H,HIGH CTRLTB
000BC6 D8E5 7E               7      LD  A,(HL)
000BC7 D8E6 2C               4      INC L
000BC8 D8E7 66               7      LD  H,(HL)
000BC9 D8E8 6F               4      LD  L,A
000BCA D8E9 CD11D7          17      CALL    JPHL
000BCD D8EC 18EC            12      JR  PRINTE5
                                
       D8EE                     CTRL1C:
000BCF D8EE ED4B8EF0        20      LD  BC,(_TXADR)
000BD3 D8F2 03               6      INC BC
       D8F3                     PRINTE3:
000BD4 D8F3 2ABAF0          16      LD  HL,(_PAGE_MINUS)
000BD7 D8F6 A7               4      AND A
000BD8 D8F7 ED4A            15      ADC HL,BC
       D8F9                     PRINTE8:
000BDA D8F9 2805            12      JR  Z,PRINT2
000BDC D8FB ED438EF0        20      LD  (_TXADR),BC
       D8FF                     CTRL00:
000BE0 D8FF C9              10      RET
                                
       D900                     PRINT2:
000BE1 D900 CD5BDA          17      CALL    SCR
000BE4 D903 21D8FF          10      LD  HL,0-WIDTH
000BE7 D906 09              11      ADD HL,BC
       D907                     SET_TXADR_HL:
000BE8 D907 228EF0          16      LD  (_TXADR),HL
000BEB D90A C9              10      RET
                                
       D90B                     CTRL08:
000BEC D90B 3AA6D8          13      LD  A,(INSFLG)
000BEF D90E FECD             7      CP  0CDH        ;CALL ????
000BF1 D910 2823            12      JR  Z,CTRL02
       D912                     CTRL1D:
000BF3 D912 2A8EF0          16      LD  HL,(_TXADR)
000BF6 D915 7C               4      LD  A,H
000BF7 D916 B5               4      OR  L
000BF8 D917 C8              11      RET Z
000BF9 D918 2B               6      DEC HL
000BFA D919 18EC            12      JR  SET_TXADR_HL
                                
       D91B                     CTRL1E:
000BFC D91B ED4B8EF0        20      LD  BC,(_TXADR)
000C00 D91F 21D8FF          10      LD  HL,0-WIDTH
000C03 D922 09              11      ADD HL,BC
000C04 D923 D0              11      RET NC
000C05 D924 18E1            12      JR  SET_TXADR_HL
                                
       D926                     CTRL09:
000C07 D926 ED4B8EF0        20      LD  BC,(_TXADR)
000C0B D92A 79               4      LD  A,C
000C0C D92B E6F8             7      AND 0F8H
000C0E D92D C608             7      ADD A,8
000C10 D92F 4F               4      LD  C,A
000C11 D930 88               4      ADC A,B
000C12 D931 91               4      SUB C
000C13 D932 47               4      LD  B,A
000C14 D933 18BE            12      JR  PRINTE3
                                
       D935                     CTRL02:
000C16 D935 CD12D9          17      CALL    CTRL1D
000C19 D938 C8              11      RET Z
000C1A D939 D5              11      PUSH    DE
000C1B D93A CDD3F0          17      CALL    _POS
000C1E D93D 54               4      LD  D,H
000C1F D93E 3E28             7      LD  A,WIDTH
000C21 D940 95               4      SUB L
000C22 D941 4F               4      LD  C,A
000C23 D942 0D               4      DEC C
000C24 D943 06D0             7      LD  B,0D0H
000C26 D945 2A8EF0          16      LD  HL,(_TXADR)
000C29 D948 09              11      ADD HL,BC
000C2A D949 47               4      LD  B,A
                                
000C2B D94A 3A11DA          13      LD  A,(MULINE)
000C2E D94D BA               4      CP  D
000C2F D94E 2007            12      JR  NZ,C02X1
000C31 D950 112800          10      LD  DE,WIDTH
000C34 D953 19              11      ADD HL,DE
000C35 D954 78               4      LD  A,B
000C36 D955 83               4      ADD A,E
000C37 D956 47               4      LD  B,A
       D957                     C02X1:
000C38 D957 3A96F0          13      LD  A,(_COLORF) ;C:Color
000C3B D95A 4F               4      LD  C,A
000C3C D95B 3E                      DB  03EH        ;LD A,?
000C3D D95C 2B               6      DEC HL
000C3E D95D 328BCF          13      LD  (IO_INCDEC),A
000C41 D960 AF               4      XOR A       ;A:Text
000C42 D961 CD7ECF          17      CALL    IO_INSBS
000C45 D964 D1              10      POP DE
000C46 D965 C9              10      RET
                                
       D966                     CTRL05:
000C47 D966 CDD3F0          17      CALL    _POS
000C4A D969 3E28             7      LD  A,WIDTH
000C4C D96B 95               4      SUB L
000C4D D96C 47               4      LD  B,A
       D96D                     C08X1:
000C4E D96D 2A8EF0          16      LD  HL,(_TXADR)
000C51 D970 7C               4      LD  A,H
000C52 D971 C6D0             7      ADD A,0D0H
000C54 D973 67               4      LD  H,A
       D974                     CLLINE:
000C55 D974 3A96F0          13      LD  A,(_COLORF)
000C58 D977 4F               4      LD  C,A
000C59 D978 AF               4      XOR A
000C5A D979 C36ECF          10      JP  IO_CLLINE
                                
       D97C                     CTRL0D:
000C5D D97C CDD3F0          17      CALL    _POS
000C60 D97F 2E00             7      LD  L,0
       D981                     LOC:
000C62 D981 C5              11      PUSH    BC
000C63 D982 E5              11      PUSH    HL
000C64 D983 CDA1D9          17      CALL    LOC1
000C67 D986 228EF0          16      LD  (_TXADR),HL
000C6A D989 E1              10      POP HL
000C6B D98A C1              10      POP BC
000C6C D98B C9              10      RET
                                
       D98C                     CTRL12:
000C6D D98C 21A6D8          10      LD  HL,INSFLG
000C70 D98F 7E               7      LD  A,(HL)
000C71 D990 EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000C73 D992 77               7      LD  (HL),A
000C74 D993 C9              10      RET
                                
       D994                     CTRL0B:
000C75 D994 210000          10      LD  HL,0
000C78 D997 228EF0          16      LD  (_TXADR),HL
000C7B D99A C9              10      RET
                                
       D99B                     CTRL1B:
000C7C D99B 3E01             7      LD  A,1
000C7E D99D 329DD8          13      LD  (ESCFLG),A
000C81 D9A0 C9              10      RET
                                
       D9A1                     LOC1:
000C82 D9A1 D5              11      PUSH    DE
000C83 D9A2 4D               4      LD  C,L
000C84 D9A3 0608             7      LD  B,8
000C86 D9A5 5C               4      LD  E,H
000C87 D9A6 210028          10      LD  HL,WIDTH*256
000C8A D9A9 55               4      LD  D,L ;L=0
       D9AA                     LOC2:
000C8B D9AA 29              11      ADD HL,HL
000C8C D9AB 3001            12      JR  NC,LOC3
000C8E D9AD 19              11      ADD HL,DE
       D9AE                     LOC3:
000C8F D9AE 10FA            13      DJNZ    LOC2
000C91 D9B0 09              11      ADD HL,BC
000C92 D9B1 D1              10      POP DE
000C93 D9B2 C9              10      RET
                                
       D9B3                     CONOUT1:
                                ;   CALL    CURSOR
000C94 D9B3 59               4      LD  E,C
000C95 D9B4 CDCDF0          17      CALL    _PRINT
000C98 D9B7 7B               4      LD  A,E
000C99 D9B8 FE0A             7      CP  00AH
000C9B D9BA 2006            12      JR  NZ,CURSOR
000C9D D9BC CD7CD9          17      CALL    CTRL0D
000CA0 D9BF CD66D9          17      CALL    CTRL05
       D9C2                     CURSOR:
000CA3 D9C2 C9              10      RET
                                
       D9C3                     CTRL07:
000CA4 D9C3 06E0             7      LD  B,0E0H
000CA6 D9C5 2162F0          10      LD  HL,BEEPD+1
       D9C8                     C07X0:
000CA9 D9C8 4E               7      LD  C,(HL)
000CAA D9C9 23               6      INC HL
000CAB D9CA 7E               7      LD  A,(HL)
000CAC D9CB 23               6      INC HL
000CAD D9CC CD5BCF          17      CALL    WRMMIO_BC
000CB0 D9CF 7D               4      LD  A,L
000CB1 D9D0 FE6C             7      CP  (BEEPD+1+M7BEEPE-M7BEEPD)&255
000CB3 D9D2 20F4            12      JR  NZ,C07X0
000CB5 D9D4 0610             7      LD  B,16
       D9D6                     C07X1:
000CB7 D9D6 CD39CF          17      CALL    RD556VSYNC
000CBA D9D9 87               4      ADD A,A
000CBB D9DA 30FA            12      JR  NC,C07X1
       D9DC                     C07X2:
000CBD D9DC CD39CF          17      CALL    RD556VSYNC
000CC0 D9DF 87               4      ADD A,A
000CC1 D9E0 38FA            12      JR  C,C07X2
000CC3 D9E2 10F2            13      DJNZ    C07X1
                                
000CC5 D9E4 AF               4      XOR A
000CC6 D9E5 2108E0          10      LD  HL,0E008H
000CC9 D9E8 CD4BCF          17      CALL    WRMMIO
000CCC D9EB 2E03             7      LD  L,003H      ;SOUND MASK (MZ-1500)
000CCE D9ED C34BCF          10      JP  WRMMIO
                                
       D9F0                     INSERT:
000CD1 D9F0 D5              11      PUSH    DE
000CD2 D9F1 CDD3F0          17      CALL    _POS
000CD5 D9F4 54               4      LD  D,H
000CD6 D9F5 3E28             7      LD  A,WIDTH
000CD8 D9F7 95               4      SUB L
000CD9 D9F8 47               4      LD  B,A
000CDA D9F9 2A8EF0          16      LD  HL,(_TXADR)
000CDD D9FC 7C               4      LD  A,H
000CDE D9FD C6D0             7      ADD A,0D0H
000CE0 D9FF 67               4      LD  H,A
000CE1 DA00 3A96F0          13      LD  A,(_COLORF) ;C:Color
000CE4 DA03 4F               4      LD  C,A
000CE5 DA04 3E                      DB  03EH        ;LD A,?
000CE6 DA05 23               6      INC HL
000CE7 DA06 328BCF          13      LD  (IO_INCDEC),A
000CEA DA09 AF               4      XOR A       ;A:Text
000CEB DA0A CD7ECF          17      CALL    IO_INSBS
000CEE DA0D B7               4      OR  A
000CEF DA0E 2005            12      JR  NZ,INS1
       DA11                     MULINE  EQU $+1
000CF1 DA10 3EFF             7      LD  A,-1
000CF3 DA12 92               4      SUB D
000CF4 DA13 2010            12      JR  NZ,INS2
       DA15                     INS1:
000CF6 DA15 0628             7      LD  B,WIDTH
000CF8 DA17 F5              11      PUSH    AF
000CF9 DA18 3E                      DB  03EH        ;LD A,?
000CFA DA19 23               6      INC HL
000CFB DA1A 328BCF          13      LD  (IO_INCDEC),A
000CFE DA1D F1              10      POP AF
000CFF DA1E CD7ECF          17      CALL    IO_INSBS
000D02 DA21 7A               4      LD  A,D
000D03 DA22 3211DA          13      LD  (MULINE),A
       DA25                     INS2:
000D06 DA25 D1              10      POP DE
000D07 DA26 C9              10      RET
                                
       DA27                     CTRL0C:
000D08 DA27 CD94D9          17      CALL    CTRL0B
       DA2A                     CTRL06:
000D0B DA2A D5              11      PUSH    DE
000D0C DA2B E5              11      PUSH    HL
000D0D DA2C ED5B8EF0        20      LD  DE,(_TXADR)
000D11 DA30 3A96F0          13      LD  A,(_COLORF)
000D14 DA33 3219CF          13      LD  (ICSMC),A
000D17 DA36 F3               4      DI
000D18 DA37 C30ECF          10      JP  IO_CLR
                                
       DA3A                     CTRL04:
000D1B DA3A CDD3F0          17      CALL    _POS
000D1E DA3D 7D               4      LD  A,L
000D1F DA3E B7               4      OR  A
000D20 DA3F C8              11      RET Z
       DA40                     CTRL03:
000D21 DA40 CD7CD9          17      CALL    CTRL0D
       DA43                     CTRL0A:
       DA43                     CTRL1F:
000D24 DA43 2A8EF0          16      LD  HL,(_TXADR)
000D27 DA46 012800          10      LD  BC,WIDTH
000D2A DA49 09              11      ADD HL,BC
000D2B DA4A 44               4      LD  B,H
000D2C DA4B 4D               4      LD  C,L
000D2D DA4C 2ABAF0          16      LD  HL,(_PAGE_MINUS)
000D30 DA4F 09              11      ADD HL,BC
000D31 DA50 3F               4      CCF
000D32 DA51 9F               4      SBC A,A
000D33 DA52 C3F9D8          10      JP  PRINTE8
                                
       DA55                     CTRL0E:
000D36 DA55 CDD3F0          17      CALL    _POS
000D39 DA58 7C               4      LD  A,H
000D3A DA59 1804            12      JR  SCR1
       DA5B                     SCR:
000D3C DA5B 3A97F0          13      LD  A,(_LINE)
000D3F DA5E 3D               4      DEC A
       DA5F                     SCR1:
000D40 DA5F C5              11      PUSH    BC
000D41 DA60 D5              11      PUSH    DE
000D42 DA61 E5              11      PUSH    HL
000D43 DA62 1100D0          10      LD  DE,0D000H
000D46 DA65 2128D0          10      LD  HL,0D000H+WIDTH
                                
000D49 DA68 47               4      LD  B,A
000D4A DA69 B7               4      OR  A
000D4B DA6A C392CF          10      JP  IO_SCRUP
                                
       DA6D                     POS:
000D4E DA6D 2A8EF0          16      LD  HL,(_TXADR)
000D51 DA70 C5              11      PUSH    BC
000D52 DA71 01D8FF          10      LD  BC,0-WIDTH
000D55 DA74 AF               4      XOR A
       DA75                     POS1:
000D56 DA75 09              11      ADD HL,BC
000D57 DA76 3C               4      INC A
000D58 DA77 38FC            12      JR  C,POS1
000D5A DA79 ED42            15      SBC HL,BC
000D5C DA7B 3D               4      DEC A
000D5D DA7C 67               4      LD  H,A
000D5E DA7D C1              10      POP BC
000D5F DA7E A7               4      AND A
000D60 DA7F C9              10      RET
                                
       DA80                     GETL:
000D61 DA80 CDD3F0          17      CALL    _POS
000D64 DA83 E5              11      PUSH    HL
000D65 DA84 3ECD             7      LD  A,0CDH      ;CALL ????
000D67 DA86 32A6D8          13      LD  (INSFLG),A
       DA89                     GETL1:
000D6A DA89 CD94D7          17      CALL    _SYS08
000D6D DA8C FE09             7      CP  9
000D6F DA8E 2008            12      JR  NZ,GETL1V
000D71 DA90 2130FF          10      LD  HL,KBUF
000D74 DA93 CD8ED4          17      CALL    MSX
000D77 DA96 18F1            12      JR  GETL1
       DA98                     GETL1V:
000D79 DA98 5F               4      LD  E,A
000D7A DA99 CDD3F0          17      CALL    _POS
000D7D DA9C CDCDF0          17      CALL    _PRINT
000D80 DA9F 7B               4      LD  A,E
000D81 DAA0 FE20             7      CP  $20
000D83 DAA2 3809            12      JR  C,GETL1V1
000D85 DAA4 7D               4      LD  A,L
000D86 DAA5 FE27             7      CP  WIDTH-1
000D88 DAA7 2004            12      JR  NZ,GETL1V1
000D8A DAA9 7C               4      LD  A,H
000D8B DAAA 3211DA          13      LD  (MULINE),A
       DAAD                     GETL1V1:
000D8E DAAD 7B               4      LD  A,E
000D8F DAAE FE0D             7      CP  00DH
000D91 DAB0 20D7            12      JR  NZ,GETL1
000D93 DAB2 3E01             7      LD  A,1     ;LD BC,????
000D95 DAB4 32A6D8          13      LD  (INSFLG),A
000D98 DAB7 1130FF          10      LD  DE,KBUF
000D9B DABA 0628             7      LD  B,WIDTH
000D9D DABC CD2CD3          17      CALL    ZERO_MEMORY_DE
                                
000DA0 DABF D1              10      POP DE
000DA1 DAC0 CDD3F0          17      CALL    _POS
000DA4 DAC3 6B               4      LD  L,E
000DA5 DAC4 3E28             7      LD  A,WIDTH
000DA7 DAC6 95               4      SUB L
000DA8 DAC7 57               4      LD  D,A
                                
000DA9 DAC8 3A11DA          13      LD  A,(MULINE)
000DAC DACB 94               4      SUB H
000DAD DACC 280A            12      JR  Z,GL2X
000DAF DACE 3C               4      INC A
000DB0 DACF 2010            12      JR  NZ,GL3X
000DB2 DAD1 7C               4      LD  A,H
000DB3 DAD2 B7               4      OR  A
000DB4 DAD3 280C            12      JR  Z,GL3X
000DB6 DAD5 25               4      DEC H
000DB7 DAD6 1805            12      JR  GL4X
       DAD8                     GL2X:
000DB9 DAD8 3E1F             7      LD  A,$1F
000DBB DADA CD7ED7          17      CALL    MSG_A
       DADD                     GL4X:
000DBE DADD 7A               4      LD  A,D
000DBF DADE C628             7      ADD A,WIDTH
000DC1 DAE0 57               4      LD  D,A
       DAE1                     GL3X:
000DC2 DAE1 CDA1D9          17      CALL    LOC1
000DC5 DAE4 4D               4      LD  C,L
000DC6 DAE5 7C               4      LD  A,H
000DC7 DAE6 C6D0             7      ADD A,0D0H
000DC9 DAE8 47               4      LD  B,A
000DCA DAE9 5A               4      LD  E,D
000DCB DAEA 2130FF          10      LD  HL,KBUF
       DAED                     GETL2:
000DCE DAED CDD0F0          17      CALL    _SCRN
000DD1 DAF0 03               6      INC BC
000DD2 DAF1 77               7      LD  (HL),A
000DD3 DAF2 23               6      INC HL
000DD4 DAF3 1D               4      DEC E
000DD5 DAF4 20F7            12      JR  NZ,GETL2
       DAF6                     GETL3:
000DD7 DAF6 2B               6      DEC HL
000DD8 DAF7 7E               7      LD  A,(HL)
000DD9 DAF8 FE21             7      CP  021H
000DDB DAFA D0              11      RET NC
000DDC DAFB 3600            10      LD  (HL),0
000DDE DAFD 15               4      DEC D
000DDF DAFE 20F6            12      JR  NZ,GETL3
000DE1 DB00 C9              10      RET
                                
       DB01                     INKEYB:
000DE2 DB01 C1              10      POP BC
000DE3 DB02 CB47             8      BIT 0,A
000DE5 DB04 3E08             7      LD  A,8
000DE7 DB06 2002            12      JR  NZ,SETKEYD
000DE9 DB08 3E03             7      LD  A,3
       DB0A                     SETKEYD:
000DEB DB0A 3292F0          13      LD  (_KEYD),A
       DB0D                     GETKEYD:
000DEE DB0D 3A92F0          13      LD  A,(_KEYD)
000DF1 DB10 B7               4      OR  A
       DB11                     GETKEYD_SWC:            ;ここがSCFの場合はキーを離すまで戻り値は0になる（自己書き換え）
000DF2 DB11 A7               4      AND A
000DF3 DB12 D0              11      RET NC
000DF4 DB13 2005            12      JR  NZ,GETKEYD1
000DF6 DB15 3E                      DB  03EH
000DF7 DB16 A7               4      AND A
000DF8 DB17 3211DB          13      LD  (GETKEYD_SWC),A
       DB1A                     GETKEYD1:
000DFB DB1A AF               4      XOR A
000DFC DB1B C9              10      RET
                                
       DB1C                     INKEY:
                                #IF EXISTS USE_8253
000DFD DB1C FB               4      EI
000DFE DB1D E5              11      PUSH    HL
000DFF DB1E 2A90F0          16      LD  HL,(_KEYPS)
000E02 DB21 7C               4      LD  A,H
000E03 DB22 AD               4      XOR L
000E04 DB23 280B            12      JR  Z,INKEY1
000E06 DB25 7C               4      LD  A,H
000E07 DB26 3C               4      INC A
000E08 DB27 E61F             7      AND 01FH
000E0A DB29 3291F0          13      LD  (_KEYPS+1),A
000E0D DB2C 6F               4      LD  L,A
000E0E DB2D 26F3             7      LD  H,HIGH KEYBF
000E10 DB2F 7E               7      LD  A,(HL)
       DB30                     INKEY1:
000E11 DB30 E1              10      POP HL
000E12 DB31 B7               4      OR  A
000E13 DB32 C9              10      RET
                                #ELSE
                                    PUSH    HL
                                GETKEY:
                                    CALL    GETKEYD
                                    LD  L,A
                                    LD  H,16
                                GKSMC   EQU $-1
                                GETKEY1:
                                    LD  A,1
                                SKIP_KEYWAIT:   EQU $-1
                                    OR  A
                                    CALL    NZ,CHKEY    ;キーを離すまで待つ
                                    JR  Z,GETKEY2
                                    CP  L
                                    JR  NZ,GETKEY2
                                    CALL    RD556VSYNC
                                    ADD A,A
                                    JR  NC,GETKEY1
                                GETKEY1X:
                                    CALL    CHKEY       ;キーを離すまで待つ
                                    JR  Z,GETKEY2
                                    CP  L
                                    JR  NZ,GETKEY2
                                    CALL    RD556VSYNC
                                    ADD A,A
                                    JR  C,GETKEY1X
                                    DEC H
                                    JR  NZ,GETKEY1
                                    LD  A,1
                                    JR  GETKEY3
                                GETKEY2:
                                    LD  A,16
                                    LD  (SKIP_KEYWAIT),A
                                GETKEY3:
                                    LD  (GKSMC),A
                                    CALL    GETKEYD
                                    POP HL
                                    RET
                                #ENDIF
       DB33                     CHKEY:
000E14 DB33 C5              11      PUSH    BC
000E15 DB34 3E88             7      LD  A,$88
000E17 DB36 CD2CCF          17      CALL    RDKEYDATA
000E1A DB39 4F               4      LD  C,A
000E1B DB3A 3A93F0          13      LD  A,(_KEYST)
000E1E DB3D B9               4      CP  C
000E1F DB3E 79               4      LD  A,C
000E20 DB3F 3293F0          13      LD  (_KEYST),A
000E23 DB42 280F            12      JR  Z,KEYST2
000E25 DB44 CD0DDB          17      CALL    GETKEYD
000E28 DB47 2809            12      JR  Z,KEYST1
000E2A DB49 AF               4      XOR A
000E2B DB4A 3292F0          13      LD  (_KEYD),A
000E2E DB4D 3E                      DB  03EH
000E2F DB4E 37               4      SCF
000E30 DB4F 3211DB          13      LD  (GETKEYD_SWC),A
       DB52                     KEYST1:
000E33 DB52 79               4      LD  A,C
       DB53                     KEYST2:
000E34 DB53 CB7F             8      BIT 7,A
000E36 DB55 28AA            12      JR  Z,INKEYB
000E38 DB57 E5              11      PUSH    HL
000E39 DB58 0E87             7      LD  C,$87
000E3B DB5A 2140ED          10      LD  HL,KEY_TABLE
000E3E DB5D CB47             8      BIT 0,A
000E40 DB5F 2003            12      JR  NZ,CHKEY0
000E42 DB61 2180ED          10      LD  HL,SHIFT_TABLE
       DB64                     CHKEY0:
000E45 DB64 CB77             8      BIT 6,A
000E47 DB66 2003            12      JR  NZ,CHKEY1
000E49 DB68 21C0ED          10      LD  HL,CTRL_TABLE
       DB6B                     CHKEY1:
000E4C DB6B 79               4      LD  A,C
000E4D DB6C CD2CCF          17      CALL    RDKEYDATA
000E50 DB6F 0608             7      LD  B,8
       DB71                     CHKEY2:
000E52 DB71 87               4      ADD A,A
000E53 DB72 300A            12      JR  NC,CHKEY3
000E55 DB74 23               6      INC HL
000E56 DB75 10FA            13      DJNZ    CHKEY2
000E58 DB77 0D               4      DEC C
000E59 DB78 CB79             8      BIT 7,C
000E5B DB7A 20EF            12      JR  NZ,CHKEY1
000E5D DB7C AF               4      XOR A
000E5E DB7D 06                      DB  $06     ;LD B,?? 次の1バイトを飛ばす
       DB7E                     CHKEY3:
000E5F DB7E 7E               7      LD  A,(HL)
000E60 DB7F E1              10      POP HL
000E61 DB80 C1              10      POP BC
000E62 DB81 C30ADB          10      JP  SETKEYD
                                
       DB84                     SCRN:
000E65 DB84 E5              11      PUSH    HL
000E66 DB85 CD53CF          17      CALL    RDMMIO_BC
000E69 DB88 6F               4      LD  L,A
000E6A DB89 26EF             7      LD  H,HIGH DC_TABLE
000E6C DB8B 7E               7      LD  A,(HL)
000E6D DB8C FE41             7      CP  'A'     ;英小文字チェック
000E6F DB8E 380E            12      JR  C,SCRN1
000E71 DB90 FE5B             7      CP  'Z'+1
000E73 DB92 DCA0DB          17      CALL    C,SCRNC
000E76 DB95 FEA6             7      CP  $A6     ;ひらがなチェック
000E78 DB97 3805            12      JR  C,SCRN1
000E7A DB99 FEE0             7      CP  $E0
000E7C DB9B DCA0DB          17      CALL    C,SCRNC
       DB9E                     SCRN1:
000E7F DB9E E1              10      POP HL
000E80 DB9F C9              10      RET
                                
       DBA0                     SCRNC:
000E81 DBA0 6F               4      LD  L,A
000E82 DBA1 60               4      LD  H,B
000E83 DBA2 CBD8             8      SET 3,B
000E85 DBA4 CD53CF          17      CALL    RDMMIO_BC
000E88 DBA7 44               4      LD  B,H
000E89 DBA8 CB7F             8      BIT 7,A
000E8B DBAA 7D               4      LD  A,L
000E8C DBAB C8              11      RET Z
000E8D DBAC FE5B             7      CP  'Z'+1
000E8F DBAE 3804            12      JR  C,SCRNC_ADD
000E91 DBB0 FEC0             7      CP  $C0
000E93 DBB2 3803            12      JR  C,SCRNC_SUB
       DBB4                     SCRNC_ADD:
000E95 DBB4 C620             7      ADD A,$20
000E97 DBB6 C9              10      RET
       DBB7                     SCRNC_SUB:
000E98 DBB7 D620             7      SUB $20
000E9A DBB9 C9              10      RET
       DBBA                     C_MON:
000E9B DBBA 2100D8          10      LD  HL,0D800H
       DBBD                     MON1:
000E9E DBBD 3E71             7      LD  A,071H
000EA0 DBBF CD4BCF          17      CALL    WRMMIO
000EA3 DBC2 23               6      INC HL
000EA4 DBC3 CB54             8      BIT 2,H
000EA6 DBC5 28F6            12      JR  Z,MON1
000EA8 DBC7 C3C6CF          10      JP  IO_MON
[EOF:M7IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       DBCA                     FILEC:
000EAB DBCA CDD5DB          17      CALL    FILE
       DBCD                     FILEC2:
000EAE DBCD 3A15F0          13      LD  A,(FDRV+1)
000EB1 DBD0 FE20             7      CP  020H
000EB3 DBD2 C8              11      RET Z
000EB4 DBD3 1839            12      JR  SETDIR1
                                
       DBD5                     FILE:
000EB6 DBD5 AF               4      XOR A
000EB7 DBD6 3214F0          13      LD  (FDRV),A
000EBA DBD9 67               4      LD  H,A
000EBB DBDA 6F               4      LD  L,A
000EBC DBDB 2222F0          16      LD  (FDRV+14),HL
000EBF DBDE CDABDC          17      CALL    SPCUT
000EC2 DBE1 CD90DC          17      CALL    CCHK3
000EC5 DBE4 2812            12      JR  Z,DEVI1
000EC7 DBE6 13               6      INC DE
000EC8 DBE7 1A               7      LD  A,(DE)
000EC9 DBE8 1B               6      DEC DE
000ECA DBE9 FE3A             7      CP  ':'
000ECC DBEB 200B            12      JR  NZ,DEVI1
000ECE DBED 1A               7      LD  A,(DE)      ;DRIVE
000ECF DBEE CDF1DE          17      CALL    CAP
000ED2 DBF1 D640             7      SUB '@'
000ED4 DBF3 13               6      INC DE
000ED5 DBF4 13               6      INC DE
000ED6 DBF5 3214F0          13      LD  (FDRV),A
       DBF8                     DEVI1:
000ED9 DBF8 1A               7      LD  A,(DE)
000EDA DBF9 D65C             7      SUB 05CH        ;\
000EDC DBFB 2009            12      JR  NZ,NOROOT
000EDE DBFD 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
000EDF DBFE 222EF0          16      LD  (FDRV+26),HL
000EE2 DC01 2C               4      INC L
000EE3 DC02 2222F0          16      LD  (FDRV+14),HL
000EE6 DC05 13               6      INC DE
       DC06                     NOROOT:
                                
       DC06                     SETDIR:
000EE7 DC06 CD31DC          17      CALL    FILED
000EEA DC09 1A               7      LD  A,(DE)
000EEB DC0A FE5C             7      CP  05CH        ;\
000EED DC0C C0              11      RET NZ
000EEE DC0D 13               6      INC DE
       DC0E                     SETDIR1:
000EEF DC0E 3E10             7      LD  A,010H      ;Directory
000EF1 DC10 3221F0          13      LD  (FDRV+13),A
000EF4 DC13 D5              11      PUSH    DE
000EF5 DC14 1114F0          10      LD  DE,FDRV
000EF8 DC17 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000EFA DC19 CD4ED4          17      CALL    BDOS0
000EFD DC1C D1              10      POP DE
000EFE DC1D B7               4      OR  A
000EFF DC1E C0              11      RET NZ
                                
000F00 DC1F 3A21F0          13      LD  A,(FDRV+13)
000F03 DC22 E610             7      AND 010H        ;ディレクトリ
000F05 DC24 C8              11      RET Z
                                
000F06 DC25 CD78DC          17      CALL    FILEI
000F09 DC28 2A2EF0          16      LD  HL,(FDRV+26)
000F0C DC2B 23               6      INC HL
000F0D DC2C 2222F0          16      LD  (FDRV+14),HL
000F10 DC2F 18D5            12      JR  SETDIR
                                
       DC31                     FILED:
000F12 DC31 CD78DC          17      CALL    FILEI
000F15 DC34 2115F0          10      LD  HL,FNAME
                                
000F18 DC37 0608             7      LD  B,8
       DC39                     FILE2:
000F1A DC39 CD85DC          17      CALL    CCHKF
000F1D DC3C C8              11      RET Z
000F1E DC3D FE2A             7      CP  '*'
000F20 DC3F 282E            12      JR  Z,FILE9
000F22 DC41 FE2E             7      CP  '.'
000F24 DC43 280C            12      JR  Z,FILE4
000F26 DC45 77               7      LD  (HL),A
000F27 DC46 23               6      INC HL
000F28 DC47 10F0            13      DJNZ    FILE2
                                
       DC49                     FILE3:
000F2A DC49 CD85DC          17      CALL    CCHKF
000F2D DC4C C8              11      RET Z
000F2E DC4D FE2E             7      CP  '.'
000F30 DC4F 20F8            12      JR  NZ,FILE3
                                
       DC51                     FILE4:
000F32 DC51 211DF0          10      LD  HL,FNAME+8
000F35 DC54 0603             7      LD  B,3
                                
       DC56                     FILE4L:
000F37 DC56 CD85DC          17      CALL    CCHKF
000F3A DC59 C8              11      RET Z
000F3B DC5A FE2E             7      CP  '.'
000F3D DC5C 2008            12      JR  NZ,FILE12
000F3F DC5E 3215F0          13      LD  (FNAME),A   ;Parent directory(..)
000F42 DC61 3216F0          13      LD  (FNAME+1),A
000F45 DC64 3E20             7      LD  A,020H
       DC66                     FILE12:
000F47 DC66 FE2A             7      CP  '*'
000F49 DC68 280A            12      JR  Z,FILE10
000F4B DC6A 77               7      LD  (HL),A
000F4C DC6B 23               6      INC HL
000F4D DC6C 10E8            13      DJNZ    FILE4L
000F4F DC6E C9              10      RET
                                
       DC6F                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000F50 DC6F CD74DC          17      CALL    FILE10
000F53 DC72 18D5            12      JR  FILE3
                                
       DC74                     FILE10:
000F55 DC74 3E3F             7      LD  A,'?'
000F57 DC76 1808            12      JR  FILL_MEMORY
       DC78                     FILEI:              ;名前＋拡張子をスペースで初期化
000F59 DC78 3E20             7      LD  A,020H
000F5B DC7A 01000B          10      LD  BC,11*256   ;C=0にしておく
000F5E DC7D 2115F0          10      LD  HL,FNAME
       DC80                     FILL_MEMORY:            ;HLからBバイトAで埋める
000F61 DC80 77               7      LD  (HL),A
000F62 DC81 23               6      INC HL
000F63 DC82 10FC            13      DJNZ    FILL_MEMORY
000F65 DC84 C9              10      RET
                                
       DC85                     CCHKF:
000F66 DC85 1A               7      LD  A,(DE)
000F67 DC86 CD8DDC          17      CALL    CCHK2
000F6A DC89 C8              11      RET Z
000F6B DC8A C3F9DF          10      JP  FKAN
                                
       DC8D                     CCHK2:
000F6E DC8D 0C               4      INC C
000F6F DC8E 0D               4      DEC C
000F70 DC8F C0              11      RET NZ
       DC90                     CCHK3:              ;ZF=1 で使えない文字
000F71 DC90 FE2B             7      CP  '+'
000F73 DC92 C8              11      RET Z
000F74 DC93 FE2C             7      CP  ','
000F76 DC95 C8              11      RET Z
000F77 DC96 FE2F             7      CP  '/'
000F79 DC98 C8              11      RET Z
000F7A DC99 FE3A             7      CP  ':'
000F7C DC9B C8              11      RET Z
000F7D DC9C FE3B             7      CP  ';'
000F7F DC9E C8              11      RET Z
000F80 DC9F FE3D             7      CP  '='
000F82 DCA1 C8              11      RET Z
000F83 DCA2 FE5C             7      CP  05CH    ;\
000F85 DCA4 C8              11      RET Z
000F86 DCA5 FE20             7      CP  020H
000F88 DCA7 D0              11      RET NC
000F89 DCA8 BF               4      CP  A       ;Z=1
000F8A DCA9 C9              10      RET
                                
       DCAA                     SS1:
000F8B DCAA 13               6      INC DE
       DCAB                     SPCUT:              ;スペースをカット
000F8C DCAB 1A               7      LD  A,(DE)
000F8D DCAC FE20             7      CP  020H
000F8F DCAE 28FA            12      JR  Z,SS1
000F91 DCB0 C9              10      RET
                                
       DCB1                     SETDRVF:
000F92 DCB1 1114F0          10      LD  DE,FDRV
       DCB4                     SETDRV0:
000F95 DCB4 CDBDDC          17      CALL    SETDRV
000F98 DCB7 FDE1            14      POP IY
000F9A DCB9 C1              10      POP BC
000F9B DCBA D1              10      POP DE
000F9C DCBB E1              10      POP HL
000F9D DCBC C9              10      RET
                                
       DCBD                     SETDRV:
000F9E DCBD E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
000F9F DCBE D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
000FA0 DCBF C5              11      PUSH    BC
000FA1 DCC0 1A               7      LD  A,(DE)
000FA2 DCC1 D5              11      PUSH    DE
000FA3 DCC2 FDE3            23      EX  (SP),IY
                                
000FA5 DCC4 CDCBDC          17      CALL    GETDRV
000FA8 DCC7 CDD9F0          17      CALL    _CHGDRV
                                
000FAB DCCA E9               4      JP  (HL)
                                
       DCCB                     GETDRV:
000FAC DCCB CDDEDC          17      CALL    GETDRV1
000FAF DCCE 3288F0          13      LD  (_DRV),A
000FB2 DCD1 C9              10      RET
                                
       DCD2                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
000FB3 DCD2 CDDEDC          17      CALL    GETDRV1
000FB6 DCD5 C5              11      PUSH    BC
000FB7 DCD6 4F               4      LD  C,A
000FB8 DCD7 1A               7      LD  A,(DE)
000FB9 DCD8 CDDEDC          17      CALL    GETDRV1
000FBC DCDB A9               4      XOR C
000FBD DCDC C1              10      POP BC
000FBE DCDD C9              10      RET
       DCDE                     GETDRV1:
000FBF DCDE E67F             7      AND 07FH
000FC1 DCE0 D601             7      SUB 001H
000FC3 DCE2 D0              11      RET NC
000FC4 DCE3 3A0400          13      LD  A,(_DVSW)   ;Current Drive
000FC7 DCE6 C9              10      RET
                                
       DCE7                     SOPENX:
000FC8 DCE7 1139F0          10      LD  DE,SFILE
000FCB DCEA FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
000FCE DCED CDD2DC          17      CALL    IS_SAME_DRV_A_DE
000FD1 DCF0 2024            12      JR  NZ,SOPEN
000FD3 DCF2 13               6      INC DE
000FD4 DCF3 FDE5            15      PUSH    IY
000FD6 DCF5 E1              10      POP HL
000FD7 DCF6 23               6      INC HL
000FD8 DCF7 CD82DE          17      CALL    CPFILE
000FDB DCFA 201A            12      JR  NZ,SOPEN
                                
000FDD DCFC 2AF4F1          16      LD  HL,(SCDIR)
000FE0 DCFF FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
000FE3 DD02 FD740F          19      LD  (IY+15),H
                                
000FE6 DD05 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
000FE9 DD08 229FF0          16      LD  (_FILEN),HL
                                
000FEC DD0B ED5BF6F1        20      LD  DE,(SFBPS)
000FF0 DD0F 2139F0          10      LD  HL,SFILE
000FF3 DD12 36FF            10      LD  (HL),0FFH
000FF5 DD14 23               6      INC HL
000FF6 DD15 C9              10      RET
       DD16                     SOPEN:
000FF7 DD16 212ADE          10      LD  HL,FILESE
       DD19                     SOPENC:
000FFA DD19 2252DD          16      LD  (OPENPAT),HL
                                
000FFD DD1C CDE2F0          17      CALL    _RDFATX     ;Detect Media
001000 DD1F 3856            12      JR  C,RDDERR
                                
001002 DD21 AF               4      XOR A
001003 DD22 329FF0          13      LD  (_FILEN),A
001006 DD25 CD2EDF          17      CALL    LDDIRX1     ;A=0で呼び出す
001009 DD28 2818            12      JR  Z,SDIRX1
                                
00100B DD2A CD1BDE          17      CALL    READ_DIR    ;Sub Directory
00100E DD2D 3808            12      JR  C,SDIRX0
001010 DD2F 2A7EF1          16      LD  HL,(_DTBUF)
001013 DD32 7E               7      LD  A,(HL)
001014 DD33 FE2E             7      CP  '.'
001016 DD35 280F            12      JR  Z,SOPEN1
       DD37                     SDIRX0:
001018 DD37 AF               4      XOR A
001019 DD38 32A0F0          13      LD  (_DIRF),A
00101C DD3B FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
001020 DD3F FD770F          19      LD  (IY+15),A
       DD42                     SDIRX1:
001023 DD42 ED5BFCF1        20      LD  DE,(_DIRPS) ;Root Directory
       DD46                     SOPEN1:
001027 DD46 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       DD47                     SDECPAT EQU $-1
       DD48                     SOPEN1X:
001029 DD48 CD1BDE          17      CALL    READ_DIR    ;FILE SEARCH
00102C DD4B 382A            12      JR  C,RDDERR
00102E DD4D 2A7EF1          16      LD  HL,(_DTBUF)
       DD50                     SOPEN2:
001031 DD50 D5              11      PUSH    DE
001032 DD51 CD2ADE          17      CALL    FILESE      ;(self-modifying code)
       DD52                     OPENPAT EQU $-2
001035 DD54 D1              10      POP DE
001036 DD55 386D            12      JR  C,SOPENE
001038 DD57 281B            12      JR  Z,SCF_FF_RET
       DD59                     SOPEN3:
00103A DD59 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
00103D DD5C B7               4      OR  A
00103E DD5D 200C            12      JR  NZ,SOPEN5
001040 DD5F 13               6      INC DE      ;ルートディレクトリ
001041 DD60 E5              11      PUSH    HL
001042 DD61 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       DD62                     MD_PAT  EQU $-2
001045 DD64 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
001047 DD66 E1              10      POP HL
001048 DD67 20DD            12      JR  NZ,SOPEN1
00104A DD69 1807            12      JR  SOPEN6
       DD6B                     SOPEN5:
00104C DD6B CD35E6          17      CALL    GNCLX       ;END DIR
00104F DD6E D8              11      RET C
001050 DD6F CDE2DE          17      CALL    ENDCL
       DD72                     SOPEN6:
001053 DD72 38D2            12      JR  C,SOPEN1
       DD74                     SCF_FF_RET:
001055 DD74 37               4      SCF         ;CF=1
001056 DD75 9F               4      SBC A,A     ;A=0FFH
001057 DD76 C9              10      RET
                                
       DD77                     RDDERR:
001058 DD77 BF               4      CP  A       ;READ ERR CF=1 ZF=1
001059 DD78 37               4      SCF
00105A DD79 C9              10      RET
                                
       DD7A                     NOPEN:
00105B DD7A 212ADE          10      LD  HL,FILESE
00105E DD7D 2252DD          16      LD  (OPENPAT),HL
001061 DD80 FD2A98F0        20      LD  IY,(_FCB)
001065 DD84 CD0CE0          17      CALL    CHKWILDX
001068 DD87 30EB            12      JR  NC,SCF_FF_RET
00106A DD89 FD7E00          19      LD  A,(IY+0)
00106D DD8C CDCBDC          17      CALL    GETDRV
001070 DD8F CDD9F0          17      CALL    _CHGDRV
001073 DD92 D8              11      RET C
001074 DD93 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
001077 DD96 229FF0          16      LD  (_FILEN),HL
                                
00107A DD99 CD29DF          17      CALL    LDDIRX
00107D DD9C ED5B9AF0        20      LD  DE,(_FBPS)
001081 DDA0 CD1BDE          17      CALL    READ_DIR
001084 DDA3 38D2            12      JR  C,RDDERR
001086 DDA5 3A9EF0          13      LD  A,(_FBCNT)
001089 DDA8 3D               4      DEC A
00108A DDA9 28AE            12      JR  Z,SOPEN3
       DDAB                     NOPEN2:
00108C DDAB 2A9CF0          16      LD  HL,(_FBAD)
00108F DDAE 012000          10      LD  BC,020H
001092 DDB1 09              11      ADD HL,BC
001093 DDB2 4F               4      LD  C,A
001094 DDB3 189B            12      JR  SOPEN2
                                
       DDB5                     SOPENE2:
001096 DDB5 229CF0          16      LD  (_FBAD),HL
001099 DDB8 79               4      LD  A,C
00109A DDB9 329EF0          13      LD  (_FBCNT),A
00109D DDBC ED539AF0        20      LD  (_FBPS),DE
0010A1 DDC0 FD2298F0        20      LD  (_FCB),IY
       DDC4                     SOPENE:
0010A5 DDC4 AF               4      XOR A
0010A6 DDC5 C9              10      RET
                                
       DDC6                     COPEN:
0010A7 DDC6 FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
0010AB DDCA 2147DE          10      LD  HL,NEXTSE
0010AE DDCD CD19DD          17      CALL    SOPENC
0010B1 DDD0 D0              11      RET NC
0010B2 DDD1 C8              11      RET Z
0010B3 DDD2 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
0010B6 DDD5 B7               4      OR  A
0010B7 DDD6 37               4      SCF
0010B8 DDD7 C8              11      RET Z       ;ルートディレクトリ
0010B9 DDD8 0601             7      LD  B,1
0010BB DDDA CD6BE0          17      CALL    WRDF
0010BE DDDD D8              11      RET C
0010BF DDDE ED5BFEF1        20      LD  DE,(_CLPS)
0010C3 DDE2 D5              11      PUSH    DE
0010C4 DDE3 CDABDE          17      CALL    DCPAT
0010C7 DDE6 CDB6E4          17      CALL    DRDNX
0010CA DDE9 2A7EF1          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
0010CD DDEC ED4BA1E3        20      LD  BC,(SECSZ)  ;1セクタのサイズ
0010D1 DDF0 AF               4      XOR A
       DDF1                     COPENCL:
0010D2 DDF1 77               7      LD  (HL),A
0010D3 DDF2 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0010D5 DDF4 EAF1DD          10      JP  PE,COPENCL
                                
0010D8 DDF7 3AC9DE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
0010DB DDFA 3D               4      DEC A
0010DC DDFB 2819            12      JR  Z,COPENE
0010DE DDFD 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
0010E0 DDFF 322DE6          13      LD  (_SECPS),A
0010E3 DE02 D1              10      POP DE      ;DE=(_CLPS)
0010E4 DE03 D5              11      PUSH    DE
       DE04                     COPEN1:
0010E5 DE04 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
0010E6 DE05 C5              11      PUSH    BC
0010E7 DE06 2A7EF1          16      LD  HL,(_DTBUF)
0010EA DE09 CDC5DE          17      CALL    CLUSTX
0010ED DE0C CDCCE7          17      CALL    DWT24
0010F0 DE0F C1              10      POP BC
0010F1 DE10 D1              10      POP DE
0010F2 DE11 CD2CE6          17      CALL    NEXTX
0010F5 DE14 20EE            12      JR  NZ,COPEN1
       DE16                     COPENE:
0010F7 DE16 2A7EF1          16      LD  HL,(_DTBUF)
0010FA DE19 D1              10      POP DE
0010FB DE1A C9              10      RET
                                
       DE1B                     READ_DIR:
0010FC DE1B ED53FEF1        20      LD  (_CLPS),DE
001100 DE1F C5              11      PUSH    BC
001101 DE20 D5              11      PUSH    DE
001102 DE21 CDABDE          17      CALL    DCPAT
001105 DE24 CD96E4          17      CALL    DRDX
001108 DE27 D1              10      POP DE
001109 DE28 C1              10      POP BC
00110A DE29 C9              10      RET
                                
       DE2A                     FILESE:
00110B DE2A 7E               7      LD  A,(HL)
00110C DE2B B7               4      OR  A
00110D DE2C C8              11      RET Z       ;END:ZF=1 CF=0
00110E DE2D FEE5             7      CP  0E5H
001110 DE2F 280E            12      JR  Z,FILESE1
001112 DE31 FDE5            15      PUSH    IY
001114 DE33 D1              10      POP DE
001115 DE34 13               6      INC DE
001116 DE35 E5              11      PUSH    HL
001117 DE36 CD82DE          17      CALL    CPFILE
00111A DE39 CCA3DE          17      CALL    Z,CPFILE2
00111D DE3C E1              10      POP HL
00111E DE3D 37               4      SCF
00111F DE3E C8              11      RET Z       ;!!!:(ZF=1) CF=1
       DE3F                     FILESE1:
001120 DE3F CD56DE          17      CALL    FNEXT
001123 DE42 20E6            12      JR  NZ,FILESE
       DE44                     ZF0_CF0_AFF_RET:
001125 DE44 F6FF             7      OR  0FFH        ;ZF=0 CF=0
001127 DE46 C9              10      RET
                                
       DE47                     NEXTSE:
001128 DE47 7E               7      LD  A,(HL)
001129 DE48 B7               4      OR  A
00112A DE49 37               4      SCF
00112B DE4A C8              11      RET Z       ;!!!:ZF=1 CF=1
00112C DE4B FEE5             7      CP  0E5H
00112E DE4D 37               4      SCF
00112F DE4E C8              11      RET Z       ;!!!:(ZF=1) CF=1
001130 DE4F CD56DE          17      CALL    FNEXT
001133 DE52 20F3            12      JR  NZ,NEXTSE
001135 DE54 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       DE56                     FNEXT:
001137 DE56 E5              11      PUSH    HL
001138 DE57 219FF0          10      LD  HL,_FILEN
00113B DE5A 34              11      INC (HL)
00113C DE5B E1              10      POP HL
00113D DE5C 112000          10      LD  DE,020H
001140 DE5F 19              11      ADD HL,DE
001141 DE60 0D               4      DEC C
001142 DE61 C9              10      RET
                                
       DE62                     CPNAME:
001143 DE62 C5              11      PUSH    BC
001144 DE63 D5              11      PUSH    DE
001145 DE64 E5              11      PUSH    HL
001146 DE65 CD7CDE          17      CALL    CPFILE4
001149 DE68 E1              10      POP HL
00114A DE69 23               6      INC HL
00114B DE6A 23               6      INC HL
00114C DE6B 23               6      INC HL
00114D DE6C 23               6      INC HL
00114E DE6D D1              10      POP DE
00114F DE6E C1              10      POP BC
001150 DE6F 2005            12      JR  NZ,CPNAME1
001152 DE71 7E               7      LD  A,(HL)
001153 DE72 23               6      INC HL
001154 DE73 66               7      LD  H,(HL)
001155 DE74 6F               4      LD  L,A
001156 DE75 C9              10      RET
       DE76                     CPNAME1:
001157 DE76 23               6      INC HL
001158 DE77 23               6      INC HL
001159 DE78 10E8            13      DJNZ    CPNAME
00115B DE7A 37               4      SCF
00115C DE7B C9              10      RET
                                
       DE7C                     CPFILE4:
00115D DE7C C5              11      PUSH    BC
00115E DE7D 010004          10      LD  BC,00400H
001161 DE80 1804            12      JR  CPSTR1
       DE82                     CPFILE:
001163 DE82 C5              11      PUSH    BC
001164 DE83 01000B          10      LD  BC,00B00H
       DE86                     CPSTR1:
001167 DE86 1A               7      LD  A,(DE)
001168 DE87 FE3F             7      CP  '?'     ;Wild card
00116A DE89 2812            12      JR  Z,CPSTR2
00116C DE8B 7E               7      LD  A,(HL)
00116D DE8C CDF2DF          17      CALL    FKANC
001170 DE8F E5              11      PUSH    HL
001171 DE90 67               4      LD  H,A
001172 DE91 1A               7      LD  A,(DE)
001173 DE92 CB01             8      RLC C
001175 DE94 CDF2DF          17      CALL    FKANC
001178 DE97 CB09             8      RRC C
00117A DE99 BC               4      CP  H       ;CP (HL),(DE)
00117B DE9A E1              10      POP HL
00117C DE9B 2004            12      JR  NZ,CPSTR3
       DE9D                     CPSTR2:
00117E DE9D 13               6      INC DE
00117F DE9E 23               6      INC HL
001180 DE9F 10E5            13      DJNZ    CPSTR1
       DEA1                     CPSTR3:
001182 DEA1 C1              10      POP BC
001183 DEA2 C9              10      RET
                                
       DEA3                     CPFILE2:
001184 DEA3 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001187 DEA6 F6E1             7      OR  0E1H
001189 DEA8 2F               4      CPL
00118A DEA9 A6               7      AND (HL)
00118B DEAA C9              10      RET
                                
       DEAB                     DCPAT:
00118C DEAB 0E00             7      LD  C,0
00118E DEAD 2A7EF1          16      LD  HL,(_DTBUF)
001191 DEB0 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
001194 DEB3 B7               4      OR  A
001195 DEB4 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
001196 DEB5 3AC9DE          13      LD  A,(SPCPAT)
001199 DEB8 4F               4      LD  C,A
00119A DEB9 3A2DE6          13      LD  A,(_SECPS)
00119D DEBC B9               4      CP  C
00119E DEBD 3801            12      JR  C,DC1
0011A0 DEBF AF               4      XOR A
       DEC0                     DC1:
0011A1 DEC0 F680             7      OR  080H
0011A3 DEC2 32A0F0          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       DEC5                     CLUSTX:
0011A6 DEC5 E5              11      PUSH    HL
0011A7 DEC6 EB               4      EX  DE,HL
0011A8 DEC7 AF               4      XOR A
0011A9 DEC8 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       DEC9                     SPCPAT  EQU $-1
       DECA                     L_CLDBL:
0011AB DECA CB19             8      RR  C       ;->CF
0011AD DECC 3804            12      JR  C,E_CLDBL
0011AF DECE 29              11      ADD HL,HL       ;*2
0011B0 DECF 8F               4      ADC A,A
0011B1 DED0 18F8            12      JR  L_CLDBL
       DED2                     E_CLDBL:
0011B3 DED2 4F               4      LD  C,A
0011B4 DED3 3A2DE6          13      LD  A,(_SECPS)
0011B7 DED6 B5               4      OR  L
0011B8 DED7 6F               4      LD  L,A
0011B9 DED8 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       DED9                     CLSPAT  EQU $-2
0011BC DEDB AF               4      XOR A
0011BD DEDC 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
0011BE DEDD 89               4      ADC A,C
0011BF DEDE 4F               4      LD  C,A
0011C0 DEDF EB               4      EX  DE,HL
0011C1 DEE0 E1              10      POP HL
0011C2 DEE1 C9              10      RET
                                ;(8)
       DEE2                     ENDCL:
0011C3 DEE2 7A               4      LD  A,D ;END CLUSTER
0011C4 DEE3 FE01             7      CP  1   ;164=356    (self-modifying code)
       DEE4                     CLPAT1  EQU $-1
0011C6 DEE5 C0              11      RET NZ
0011C7 DEE6 7B               4      LD  A,E
0011C8 DEE7 FE64             7      CP  064H    ;       (self-modifying code)
       DEE8                     CLPAT2  EQU $-1
0011CA DEE9 C9              10      RET
                                ;(3)
       DEEA                     CAP4:
0011CB DEEA 3EE5             7      LD  A,0E5H
0011CD DEEC C9              10      RET
                                                    ;for X1/88 ワークエリア
0011CE DEED 5BF0                    DW  _DISKE+1        ;DISKVE($F323)
0011D0 DEEF F5F0                    DW  _BREAK+1        ;BREAKV($F325)
                                
       DEF1                     CAP:            ;(9)
0011D2 DEF1 FE61             7      CP  'a'
0011D4 DEF3 D8              11      RET C
0011D5 DEF4 FE7B             7      CP  'z'+1
0011D7 DEF6 D0              11      RET NC
0011D8 DEF7 D620             7      SUB 020H
0011DA DEF9 C9              10      RET
                                ;(10)
       DEFA                     CAP2:
0011DB DEFA CDF1DE          17      CALL    CAP
       DEFD                     CAP3:               ;
0011DE DEFD FE05             7      CP  5
0011E0 DEFF 28E9            12      JR  Z,CAP4
0011E2 DF01 FE21             7      CP  021H
0011E4 DF03 C9              10      RET
                                                    ;
       DF04                     CHDIR:
0011E5 DF04 CDDDE8          17      CALL    GETDPBD
0011E8 DF07 381D            12      JR  C,CHDIR2
0011EA DF09 DD751A          19      LD  (IX+DPB_SDIR),L
0011ED DF0C DD741B          19      LD  (IX+DPB_SDIR+1),H
0011F0 DF0F 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       DF11                     LDDIR:
0011F2 DF11 CDDDE8          17      CALL    GETDPBD
0011F5 DF14 DD5E1A          19      LD  E,(IX+DPB_SDIR)
0011F8 DF17 DD561B          19      LD  D,(IX+DPB_SDIR+1)
0011FB DF1A 13               6      INC DE
0011FC DF1B FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011FF DF1E FD720F          19      LD  (IY+15),D
001202 DF21 1B               6      DEC DE
001203 DF22 AF               4      XOR A
001204 DF23 32A0F0          13      LD  (_DIRF),A
       DF26                     CHDIR2:
001207 DF26 DDE1            14      POP IX
001209 DF28 C9              10      RET
                                
       DF29                     LDDIRX:
00120A DF29 3AA0F0          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
00120D DF2C E67F             7      AND 07FH
       DF2E                     LDDIRX1:
00120F DF2E 322DE6          13      LD  (_SECPS),A
001212 DF31 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
001215 DF34 FD560F          19      LD  D,(IY+15)
001218 DF37 1B               6      DEC DE
001219 DF38 CDE2DE          17      CALL    ENDCL
00121C DF3B D411DF          17      CALL    NC,LDDIR
       DF3E                     LDDIRS:
00121F DF3E 7A               4      LD  A,D
001220 DF3F B3               4      OR  E
001221 DF40 32A0F0          13      LD  (_DIRF),A   ;ディレクトリか判別
001224 DF43 C9              10      RET
                                
       DF44                     KILL:
001225 DF44 CD0CE0          17      CALL    CHKWILDX
001228 DF47 3834            12      JR  C,KILLW
00122A DF49 CDE7DC          17      CALL    SOPENX
       DF4C                     KILLS:
00122D DF4C 3E1F             7      LD  A,01FH
00122F DF4E D490DF          17      CALL    NC,CHKATT
001232 DF51 D8              11      RET C
       DF52                     KILLSX:
001233 DF52 36E5            10      LD  (HL),0E5H   ;DIR
001235 DF54 CDE8DF          17      CALL    WTDB
001238 DF57 111A00          10      LD  DE,01AH
00123B DF5A 19              11      ADD HL,DE
00123C DF5B 5E               7      LD  E,(HL)
00123D DF5C 23               6      INC HL
00123E DF5D 56               7      LD  D,(HL)
       DF5E                     KILLS1:
00123F DF5E CDE2DE          17      CALL    ENDCL
001242 DF61 D0              11      RET NC      ;CF=0
001243 DF62 21FEFF          10      LD  HL,0-2
001246 DF65 19              11      ADD HL,DE
001247 DF66 D0              11      RET NC      ;DE= 0 or 1
001248 DF67 D5              11      PUSH    DE
001249 DF68 CDF7F0          17      CALL    _GNCL
00124C DF6B ED53FEF1        20      LD  (_CLPS),DE
001250 DF6F D1              10      POP DE
001251 DF70 210000          10      LD  HL,0
001254 DF73 D4FAF0          17      CALL    NC,_SNCL
001257 DF76 D8              11      RET C
001258 DF77 ED5BFEF1        20      LD  DE,(_CLPS)  ;FAT
00125C DF7B 18E1            12      JR  KILLS1
                                
       DF7D                     KILLW:
00125E DF7D CD16DD          17      CALL    SOPEN
       DF80                     KILLW1:
001261 DF80 380B            12      JR  C,KILLW2
001263 DF82 CDB5DD          17      CALL    SOPENE2
001266 DF85 CD4CDF          17      CALL    KILLS
001269 DF88 CD7ADD          17      CALL    NOPEN
00126C DF8B 18F3            12      JR  KILLW1
       DF8D                     KILLW2:
00126E DF8D C8              11      RET Z
00126F DF8E 3F               4      CCF
001270 DF8F C9              10      RET
                                
       DF90                     CHKATT:
001271 DF90 E5              11      PUSH    HL
001272 DF91 110B00          10      LD  DE,00BH
001275 DF94 19              11      ADD HL,DE
001276 DF95 A6               7      AND (HL)
001277 DF96 E1              10      POP HL
001278 DF97 C8              11      RET Z
001279 DF98 37               4      SCF
00127A DF99 C9              10      RET
                                
       DF9A                     NAME:
00127B DF9A CD0CE0          17      CALL    CHKWILDX
00127E DF9D D8              11      RET C
00127F DF9E 110400          10      LD  DE,4
001282 DFA1 19              11      ADD HL,DE
001283 DFA2 22B7DF          16      LD  (NAMEP),HL
001286 DFA5 23               6      INC HL
001287 DFA6 CD10E0          17      CALL    CHKWILD
00128A DFA9 D8              11      RET C
                                
00128B DFAA CDE7DC          17      CALL    SOPENX
00128E DFAD 3E0F             7      LD  A,00FH
001290 DFAF D490DF          17      CALL    NC,CHKATT
001293 DFB2 D8              11      RET C
                                
001294 DFB3 FDE5            15      PUSH    IY
001296 DFB5 FD210000        14      LD  IY,0        ;自己書き換え
       DFB7                     NAMEP   EQU $-2
00129A DFB9 CDE7DC          17      CALL    SOPENX
00129D DFBC FDE3            23      EX  (SP),IY
00129F DFBE 3F               4      CCF
0012A0 DFBF D416DD          17      CALL    NC,SOPEN
0012A3 DFC2 EB               4      EX  DE,HL
0012A4 DFC3 E1              10      POP HL
0012A5 DFC4 D8              11      RET C
                                
       DFC5                     SETNAME:
0012A6 DFC5 01000B          10      LD  BC,11*256
0012A9 DFC8 23               6      INC HL
0012AA DFC9 7E               7      LD  A,(HL)
0012AB DFCA FEE5             7      CP  0E5H
0012AD DFCC 2004            12      JR  NZ,SNAME1
0012AF DFCE 3E05             7      LD  A,5
0012B1 DFD0 180E            12      JR  SNAME3
       DFD2                     SNAME1:
0012B3 DFD2 7E               7      LD  A,(HL)
0012B4 DFD3 0C               4      INC C
0012B5 DFD4 0D               4      DEC C
0012B6 DFD5 2009            12      JR  NZ,SNAME3
0012B8 DFD7 CDF1DE          17      CALL    CAP
0012BB DFDA FEA0             7      CP  0A0H
0012BD DFDC 2002            12      JR  NZ,SNAME3
0012BF DFDE 3E20             7      LD  A,020H
       DFE0                     SNAME3:
0012C1 DFE0 12               7      LD  (DE),A
0012C2 DFE1 7E               7      LD  A,(HL)
0012C3 DFE2 23               6      INC HL
0012C4 DFE3 CDF9DF          17      CALL    FKAN
0012C7 DFE6 10EA            13      DJNZ    SNAME1
       DFE8                     WTDB:               ;バッファデータが更新された
0012C9 DFE8 3EFF             7      LD  A,0FFH
0012CB DFEA 3239F0          13      LD  (SFILE),A
0012CE DFED 32A4F0          13      LD  (_WTDBF),A
0012D1 DFF0 AF               4      XOR A
0012D2 DFF1 C9              10      RET
                                
       DFF2                     FKANC:
0012D3 DFF2 CB41             8      BIT 0,C
0012D5 DFF4 CCFADE          17      CALL    Z,CAP2
0012D8 DFF7 1801            12      JR  FKANX
       DFF9                     FKAN:           ;漢字チェック
0012DA DFF9 13               6      INC DE
       DFFA                     FKANX:
0012DB DFFA CB41             8      BIT 0,C
0012DD DFFC CB81             8      RES 0,C
0012DF DFFE C0              11      RET NZ
0012E0 DFFF FE80             7      CP  080H
0012E2 E001 D8              11      RET C
0012E3 E002 FEA0             7      CP  0A0H
0012E5 E004 3803            12      JR  C,FKAN1
0012E7 E006 FEE0             7      CP  0E0H
0012E9 E008 D8              11      RET C
       E009                     FKAN1:
0012EA E009 0C               4      INC C
0012EB E00A A7               4      AND A
0012EC E00B C9              10      RET
                                
       E00C                     CHKWILDX:
0012ED E00C FDE5            15      PUSH    IY
0012EF E00E E1              10      POP HL
0012F0 E00F 23               6      INC HL
       E010                     CHKWILD:
0012F1 E010 060B             7      LD  B,11
0012F3 E012 3E3F             7      LD  A,'?'
       E014                     CHKWIL1:
0012F5 E014 BE               7      CP  (HL)
0012F6 E015 23               6      INC HL
0012F7 E016 37               4      SCF
0012F8 E017 C8              11      RET Z
0012F9 E018 10FA            13      DJNZ    CHKWIL1
0012FB E01A AF               4      XOR A
0012FC E01B C9              10      RET
                                
       E01C                     SDIRENT:        ;IY=FCB HL=DIR
0012FD E01C D5              11      PUSH    DE
0012FE E01D E5              11      PUSH    HL
0012FF E01E FDE5            15      PUSH    IY
001301 E020 D1              10      POP DE
001302 E021 EB               4      EX  DE,HL
001303 E022 CDC5DF          17      CALL    SETNAME
                                ;               Attribute
001306 E025 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001309 E028 12               7      LD  (DE),A
00130A E029 13               6      INC DE
                                ;               Reserved
00130B E02A AF               4      XOR A
00130C E02B 060A             7      LD  B,10
       E02D                     SDE1:
00130E E02D 12               7      LD  (DE),A
00130F E02E 13               6      INC DE
001310 E02F 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
001312 E031 21E4F1          10      LD  HL,SDDATA       ;(FCB)更新年月日
001315 E034 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       E036                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
001317 E036 7E               7      LD  A,(HL)
001318 E037 23               6      INC HL
001319 E038 323DE0          13      LD  (SDPAT),A
00131C E03B FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       E03D                     SDPAT   EQU $-1
00131F E03E 12               7      LD  (DE),A
001320 E03F 13               6      INC DE
001321 E040 10F4            13      DJNZ    SDLOOP
                                
001323 E042 AF               4      XOR A
001324 E043 E1              10      POP HL
001325 E044 D1              10      POP DE
001326 E045 C9              10      RET
                                
       E046                     WOPEN:
001327 E046 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
00132A E049 E61F             7      AND 01FH
00132C E04B 37               4      SCF
00132D E04C C0              11      RET NZ
00132E E04D FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E051                     TOPEN2:
001332 E051 AF               4      XOR A
       E052                     TOPEN:              ;Initializes the time stamp
001333 E052 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
001337 E056 C9              10      RET
                                
       E057                     WRDFX:
001338 E057 3AC9DE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       E05A                     L_WRFX:
00133B E05A 1F               4      RRA         ;->CF
00133C E05B 3806            12      JR  C,E_WRFX
00133E E05D CB39             8      SRL C
001340 E05F CB1C             8      RR  H       ;CH=CH/2
001342 E061 18F7            12      JR  L_WRFX
       E063                     E_WRFX:
001344 E063 41               4      LD  B,C
001345 E064 4C               4      LD  C,H
001346 E065 03               6      INC BC
001347 E066 3E37             7      LD  A,037H      ;SCF
001349 E068 32B3E4          13      LD  (DRDN1),A
                                
       E06B                     WRDF:               ;BCクラスタ分FATを確保する
00134C E06B 110200          10      LD  DE,2
00134F E06E AF               4      XOR A
001350 E06F 322DE6          13      LD  (_SECPS),A
       E072                     WRDF1:
001353 E072 C5              11      PUSH    BC
001354 E073 D5              11      PUSH    DE
001355 E074 CDF7F0          17      CALL    _GNCL
001358 E077 381C            12      JR  C,WRDF3
00135A E079 7A               4      LD  A,D     ;空いているかチェック
00135B E07A B3               4      OR  E
00135C E07B 202A            12      JR  NZ,WRDF4
00135E E07D E1              10      POP HL      ;HL=空いているクラスタ
00135F E07E E5              11      PUSH    HL
001360 E07F ED5BFEF1        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
001364 E083 22FEF1          16      LD  (_CLPS),HL
001367 E086 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
001368 E087 B3               4      OR  E
001369 E088 2008            12      JR  NZ,WRDF2
00136B E08A FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
00136E E08D FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
001371 E090 1803            12      JR  WRDF3
       E092                     WRDF2:
001373 E092 CDFAF0          17      CALL    _SNCL
       E095                     WRDF3:
001376 E095 D1              10      POP DE
001377 E096 C1              10      POP BC
001378 E097 D8              11      RET C
001379 E098 0B               6      DEC BC
00137A E099 78               4      LD  A,B
00137B E09A B1               4      OR  C
00137C E09B 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
00137E E09D ED5BFEF1        20      LD  DE,(_CLPS)
001382 E0A1 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
001385 E0A4 C3FAF0          10      JP  _SNCL
                                
       E0A7                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
001388 E0A7 D1              10      POP DE
001389 E0A8 C1              10      POP BC
       E0A9                     WRDF5:
00138A E0A9 13               6      INC DE
00138B E0AA CDE2DE          17      CALL    ENDCL
00138E E0AD 38C3            12      JR  C,WRDF1
001390 E0AF 37               4      SCF
001391 E0B0 C9              10      RET
                                
       E0B1                     RWXR:
001392 E0B1 3AA2E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E0B4                     L_RWX:
001395 E0B4 1F               4      RRA     ;->CF
001396 E0B5 3808            12      JR  C,E_RWX
001398 E0B7 CB38             8      SRL B   ;BCH=BCH/2
00139A E0B9 CB19             8      RR  C   ;
00139C E0BB CB1C             8      RR  H   ;
00139E E0BD 18F5            12      JR  L_RWX
       E0BF                     E_RWX:
0013A0 E0BF FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0013A3 E0C2 FD561B          19      LD  D,(IY+27)
0013A6 E0C5 AF               4      XOR A
0013A7 E0C6 322DE6          13      LD  (_SECPS),A
       E0C9                     RWX1:
0013AA E0C9 ED53FEF1        20      LD  (_CLPS),DE
0013AE E0CD 7A               4      LD  A,D
0013AF E0CE B3               4      OR  E
0013B0 E0CF 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
0013B2 E0D1 78               4      LD  A,B
0013B3 E0D2 B1               4      OR  C
0013B4 E0D3 B4               4      OR  H
0013B5 E0D4 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
0013B6 E0D5 CD35E6          17      CALL    GNCLX
0013B9 E0D8 D8              11      RET C
0013BA E0D9 7C               4      LD  A,H     ;
0013BB E0DA 25               4      DEC H       ;
0013BC E0DB B7               4      OR  A       ;DEC BCH
0013BD E0DC 2001            12      JR  NZ,RWX2     ;
0013BF E0DE 0B               6      DEC BC      ;
       E0DF                     RWX2:
0013C0 E0DF CDE2DE          17      CALL    ENDCL
0013C3 E0E2 38E5            12      JR  C,RWX1
       E0E4                     SCF_RET:
0013C5 E0E4 37               4      SCF
0013C6 E0E5 C9              10      RET
                                
       E0E6                     DSKF:
0013C7 E0E6 110000          10      LD  DE,0
       E0E7                     MAXCLP  EQU $-2
0013CA E0E9 2AACF0          16      LD  HL,(_FAKEFREE)
0013CD E0EC 7C               4      LD  A,H
0013CE E0ED B5               4      OR  L
0013CF E0EE 2803            12      JR  Z,DSKF1
0013D1 E0F0 110100          10      LD  DE,1
       E0F3                     DSKF1:
0013D4 E0F3 D5              11      PUSH    DE
0013D5 E0F4 CDF7F0          17      CALL    _GNCL
0013D8 E0F7 380C            12      JR  C,POPSCF
0013DA E0F9 7A               4      LD  A,D
0013DB E0FA B3               4      OR  E
0013DC E0FB 2001            12      JR  NZ,DSKF2
0013DE E0FD 23               6      INC HL
       E0FE                     DSKF2:
0013DF E0FE D1              10      POP DE
0013E0 E0FF 1B               6      DEC DE
0013E1 E100 7A               4      LD  A,D
0013E2 E101 B3               4      OR  E
0013E3 E102 20EF            12      JR  NZ,DSKF1
0013E5 E104 C9              10      RET
                                
       E105                     POPSCF:
0013E6 E105 F1              10      POP AF
0013E7 E106 37               4      SCF
0013E8 E107 C9              10      RET
                                
       E108                     SETTMS:
0013E9 E108 FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
0013EC E10B 3C               4      INC A
0013ED E10C C0              11      RET NZ      ;ファイルが更新されていない
       E10D                     SETTMSX:            ;FCBに日付時刻をセットする
0013EE E10D CD1DD8          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
0013F1 E110 CB25             8      SLA L       ;   *2
0013F3 E112 CB25             8      SLA L       ;   *4
0013F5 E114 29              11      ADD HL,HL       ;*2 *8
0013F6 E115 29              11      ADD HL,HL       ;*4 *16
0013F7 E116 29              11      ADD HL,HL       ;*8 *32
0013F8 E117 7A               4      LD  A,D
0013F9 E118 0F               4      RRCA            ;bit.0->7->->->0->C
0013FA E119 E61F             7      AND 01FH
0013FC E11B B5               4      OR  L
0013FD E11C FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
001400 E11F FD7417          19      LD  (IY+23),H
                                
001403 E122 CD1DD8          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
001406 E125 0144F8          10      LD  BC,0-1980
001409 E128 09              11      ADD HL,BC
00140A E129 65               4      LD  H,L
                                
00140B E12A 7A               4      LD  A,D
00140C E12B 87               4      ADD A,A     ;*2
00140D E12C 87               4      ADD A,A     ;*4
00140E E12D 87               4      ADD A,A     ;*8
00140F E12E 87               4      ADD A,A     ;*16
001410 E12F 6F               4      LD  L,A
001411 E130 29              11      ADD HL,HL       ;*32
001412 E131 7D               4      LD  A,L
001413 E132 B3               4      OR  E
001414 E133 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
001417 E136 FD7415          19      LD  (IY+21),H
00141A E139 C9              10      RET
                                ;(16)
       E13A                     PUSHRR:
00141B E13A 3266E4          13      LD  (SETSEQ_SWC_RND),A
00141E E13D 2278E4          16      LD  (SETSEQ_SWC_SEQ_RR),HL
001421 E140 CD60E1          17      CALL    GET_RR_AHL
001424 E143 220FF0          16      LD  (RR_BUF_HL),HL
001427 E146 3211F0          13      LD  (RR_BUF_A),A
00142A E149 C9              10      RET
                                ;(14)
       E14A                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
00142B E14A 87               4      ADD A,A     ;in BHLA => out AHL
00142C E14B ED6A            15      ADC HL,HL
00142E E14D CB18             8      RR  B
001430 E14F B7               4      OR  A
001431 E150 78               4      LD  A,B     ;ここでフラグは変化しない
001432 E151 C8              11      RET Z
001433 E152 2C               4      INC L       ;INC AHL
001434 E153 C0              11      RET NZ      ;
001435 E154 24               4      INC H       ;
001436 E155 C0              11      RET NZ      ;
001437 E156 3C               4      INC A       ;
001438 E157 C9              10      RET
                                ;(18)
       E158                     INIT_RND:
001439 E158 3ECD             7      LD  A,0CDH      ;CALL ????
00143B E15A 2177E1          10      LD  HL,POPRR
00143E E15D CD3AE1          17      CALL    PUSHRR
       E160                     GET_RR_AHL:
001441 E160 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001444 E163 FD6622          19      LD  H,(IY+34)   ;
001447 E166 FD7E23          19      LD  A,(IY+35)   ;
00144A E169 C9              10      RET
                                ;(10)
       E16A                     SET_RR_AHL:
00144B E16A FD7521          19      LD  (IY+33),L   ;(FCB)Random record
00144E E16D FD7422          19      LD  (IY+34),H   ;
001451 E170 FD7723          19      LD  (IY+35),A   ;
001454 E173 C9              10      RET
                                ;(17)
       E174                     SETSEQ:
001455 E174 CD99E1          17      CALL    SETSEQ1
       E177                     POPRR:
001458 E177 F5              11      PUSH    AF
001459 E178 E5              11      PUSH    HL
00145A E179 2A0FF0          16      LD  HL,(RR_BUF_HL)
00145D E17C 3A11F0          13      LD  A,(RR_BUF_A)
001460 E17F CD6AE1          17      CALL    SET_RR_AHL
001463 E182 E1              10      POP HL
001464 E183 F1              10      POP AF
001465 E184 C9              10      RET
                                ;(20)
       E185                     GET_RR_BCDE:            ;BCDE=Random record
001466 E185 FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
001469 E188 FD5622          19      LD  D,(IY+34)
00146C E18B FD4E23          19      LD  C,(IY+35)
00146F E18E 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
001471 E190 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001475 E194 C0              11      RET NZ
001476 E195 FD4624          19      LD  B,(IY+36)
001479 E198 C9              10      RET
                                
       E199                     SETSEQ1:
00147A E199 F5              11      PUSH    AF
00147B E19A E5              11      PUSH    HL      ;AHL=Random record
00147C E19B CD60E1          17      CALL    GET_RR_AHL
00147F E19E 47               4      LD  B,A     ;AHL→HLA
001480 E19F 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
001481 E1A0 6C               4      LD  L,H     ;(IY+34)
001482 E1A1 60               4      LD  H,B     ;(IY+35)
001483 E1A2 0600             7      LD  B,0
                                
001485 E1A4 CD4AE1          17      CALL    GET_CPM_R_SIZE
                                
001488 E1A7 29              11      ADD HL,HL
001489 E1A8 CB3D             8      SRL L       ;L=L/2
00148B E1AA FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
00148E E1AD FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
001491 E1B0 E1              10      POP HL
001492 E1B1 F1              10      POP AF
001493 E1B2 C9              10      RET
                                
                                ;(23)
       E1B3                     RBXEND:             ;レコード数だけランダムレコードを進める
001494 E1B3 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       E1B4                     RBSIZE  EQU $-2
001497 E1B6 CD60E1          17      CALL    GET_RR_AHL
00149A E1B9 19              11      ADD HL,DE
00149B E1BA CE00             7      ADC A,0
00149D E1BC CD6AE1          17      CALL    SET_RR_AHL
0014A0 E1BF EB               4      EX  DE,HL       ;HL=進めるレコード数
0014A1 E1C0 D0              11      RET NC
0014A2 E1C1 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0014A6 E1C5 C0              11      RET NZ
0014A7 E1C6 FD3424          23      INC (IY+36)
0014AA E1C9 C9              10      RET
       E1CA                     FILE_E:
                                
       DD74                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       DD74                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       DD74                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       DD74                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       DD74                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E1CA                     _SYS26:     ;(BDOS)ランダムブロック書き込み
0014AB E1CA AF               4      XOR A
0014AC E1CB 32B3E4          13      LD  (DRDN1),A   ;NOP
0014AF E1CE 22B4E1          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
0014B2 E1D1 225DF0          16      LD  (LEFTX),HL
0014B5 E1D4 CDBDDC          17      CALL    SETDRV
                                
0014B8 E1D7 CD3DE3          17      CALL    RBX0
0014BB E1DA DA67E2          10      JP  C,RBWERR
0014BE E1DD CD46E0          17      CALL    WOPEN
0014C1 E1E0 DA67E2          10      JP  C,RBWERR
0014C4 E1E3 7C               4      LD  A,H
0014C5 E1E4 B5               4      OR  L
0014C6 E1E5 CA60E2          10      JP  Z,RBW1
                                
0014C9 E1E8 2B               6      DEC HL
                                
0014CA E1E9 CD85E1          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0014CD E1EC 19              11      ADD HL,DE       ;BCHL=HL+BCDE
0014CE E1ED 3001            12      JR  NC,S26X1    ;
0014D0 E1EF 03               6      INC BC      ;
       E1F0                     S26X1:
0014D1 E1F0 CDB1E0          17      CALL    RWXR
0014D4 E1F3 DC57E0          17      CALL    C,WRDFX
0014D7 E1F6 DA67E2          10      JP  C,RBWERR
                                
0014DA E1F9 CD6CE3          17      CALL    RBX2
0014DD E1FC 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
0014DF E1FE CD8BE3          17      CALL    RBXA
0014E2 E201 3864            12      JR  C,RBWERR
0014E4 E203 EB               4      EX  DE,HL
0014E5 E204 C5              11      PUSH    BC
0014E6 E205 EDB0                    LDIR
0014E8 E207 225FF0          16      LD  (DTAX),HL
                                
0014EB E20A CDE8DF          17      CALL    WTDB        ;バッファデータは更新された
                                
0014EE E20D 2A5DF0          16      LD  HL,(LEFTX)
0014F1 E210 D1              10      POP DE
0014F2 E211 ED52            15      SBC HL,DE
0014F4 E213 225DF0          16      LD  (LEFTX),HL
0014F7 E216 2831            12      JR  Z,RBWEND
                                
       E218                     RBWB:
0014F9 E218 CDC0E3          17      CALL    RBXB
0014FC E21B 2814            12      JR  Z,RBWC
       E21D                     RBWB1:
0014FE E21D C5              11      PUSH    BC
0014FF E21E D5              11      PUSH    DE
001500 E21F CDC5DE          17      CALL    CLUSTX
001503 E222 CDE4E3          17      CALL    DWTC
001506 E225 D1              10      POP DE
001507 E226 C1              10      POP BC
001508 E227 D435E6          17      CALL    NC,GNCLX
00150B E22A 383B            12      JR  C,RBWERR
00150D E22C 10EF            13      DJNZ    RBWB1
00150F E22E CD34E4          17      CALL    DRW_FLUSH
       E231                     RBWC:
001512 E231 CDD8E3          17      CALL    RBXC
001515 E234 2813            12      JR  Z,RBWEND
001517 E236 C5              11      PUSH    BC
001518 E237 CDC5DE          17      CALL    CLUSTX
00151B E23A CDB2E4          17      CALL    DRDN
00151E E23D C1              10      POP BC
00151F E23E 3827            12      JR  C,RBWERR
001521 E240 ED5B7EF1        20      LD  DE,(_DTBUF)
001525 E244 EDB0                    LDIR
001527 E246 CDE8DF          17      CALL    WTDB        ;バッファデータは更新された
       E249                     RBWEND:
00152A E249 CDB3E1          17      CALL    RBXEND
                                
00152D E24C CD4CE3          17      CALL    RBX1
001530 E24F 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
001532 E251 CD85E1          17      CALL    GET_RR_BCDE ;BCDE=Random record
001535 E254 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
001538 E257 FD7211          19      LD  (IY+17),D   ;
00153B E25A FD7112          19      LD  (IY+18),C   ;
00153E E25D FD7013          19      LD  (IY+19),B   ;
       E260                     RBW1:
001541 E260 FDE1            14      POP IY
001543 E262 C1              10      POP BC
001544 E263 D1              10      POP DE
001545 E264 E1              10      POP HL
       E265                     DD_NUL:
001546 E265 AF               4      XOR A
       E266                     DRDF0:
       E266                     DWTF0:
001547 E266 C9              10      RET
                                
       E267                     RBWERR:
001548 E267 FDE5            15      PUSH    IY
00154A E269 D1              10      POP DE
00154B E26A 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
00154D E26C CD4ED4          17      CALL    BDOS0
       E26F                     RBRERR1:
001550 E26F 3E01             7      LD  A,001H
       E271                     RBRERR2:
001552 E271 FDE1            14      POP IY
001554 E273 C1              10      POP BC
001555 E274 D1              10      POP DE
001556 E275 E1              10      POP HL
001557 E276 37               4      SCF
001558 E277 210000          10      LD  HL,0
00155B E27A C9              10      RET
                                
       E27B                     RBRERR:
00155C E27B 3EFF             7      LD  A,0FFH
00155E E27D 18F2            12      JR  RBRERR2
                                
       E27F                     RBRFL:
001560 E27F 3E00             7  RBRFLP: LD  A,000H
001562 E281 FE0D             7      CP  00DH
001564 E283 2005            12      JR  NZ,RBRFL1
001566 E285 D5              11      PUSH    DE
001567 E286 1E0A             7      LD  E,00AH
001569 E288 1805            12      JR  RBRFL2
       E28A                     RBRFL1:
00156B E28A D5              11      PUSH    DE
00156C E28B CD09F0          17      CALL    _SYS07
00156F E28E 5F               4      LD  E,A
       E28F                     RBRFL2:
001570 E28F CDCDF0          17      CALL    _PRINT
001573 E292 7B               4      LD  A,E
001574 E293 D1              10      POP DE
001575 E294 3280E2          13      LD  (RBRFLP+1),A
001578 E297 C9              10      RET
                                
                                                ;Read random block
       E298                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001579 E298 225DF0          16      LD  (LEFTX),HL
00157C E29B CDBDDC          17      CALL    SETDRV
                                
00157F E29E FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
001583 E2A2 C22BE3          10      JP  NZ,RBRDIR   ;ディレクトリ
001586 E2A5 CD3DE3          17      CALL    RBX0
001589 E2A8 DA7BE2          10      JP  C,RBRERR
00158C E2AB CD4CE3          17      CALL    RBX1
00158F E2AE D464E3          17      CALL    NC,RBX1R
001592 E2B1 DA6FE2          10      JP  C,RBRERR1
001595 E2B4 EB               4      EX  DE,HL
001596 E2B5 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
001598 E2B7 19              11      ADD HL,DE
001599 E2B8 79               4      LD  A,C
00159A E2B9 DE00             7      SBC A,0
00159C E2BB 78               4      LD  A,B
00159D E2BC DE00             7      SBC A,0
00159F E2BE 3801            12      JR  C,RBR1
0015A1 E2C0 EB               4      EX  DE,HL
       E2C1                     RBR1:
0015A2 E2C1 9F               4      SBC A,A
0015A3 E2C2 E601             7      AND 1
0015A5 E2C4 3229E3          13      LD  (RBRA_SWC),A
                                
0015A8 E2C7 7C               4      LD  A,H
0015A9 E2C8 B5               4      OR  L
0015AA E2C9 2857            12      JR  Z,RBREND0
                                
0015AC E2CB 22B4E1          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
0015AF E2CE 225DF0          16      LD  (LEFTX),HL
                                
0015B2 E2D1 CD6CE3          17      CALL    RBX2
0015B5 E2D4 2819            12      JR  Z,RBRB
0015B7 E2D6 CD8BE3          17      CALL    RBXA
0015BA E2D9 DA7BE2          10      JP  C,RBRERR
0015BD E2DC C5              11      PUSH    BC
0015BE E2DD EDB0                    LDIR
0015C0 E2DF ED535FF0        20      LD  (DTAX),DE
0015C4 E2E3 2A5DF0          16      LD  HL,(LEFTX)
0015C7 E2E6 D1              10      POP DE
0015C8 E2E7 A7               4      AND A
0015C9 E2E8 ED52            15      SBC HL,DE
0015CB E2EA 225DF0          16      LD  (LEFTX),HL
0015CE E2ED 2830            12      JR  Z,RBREND
                                
       E2EF                     RBRB:
0015D0 E2EF CDC0E3          17      CALL    RBXB
0015D3 E2F2 2815            12      JR  Z,RBRC
       E2F4                     RBRB1:
0015D5 E2F4 C5              11      PUSH    BC
0015D6 E2F5 D5              11      PUSH    DE
0015D7 E2F6 CDC5DE          17      CALL    CLUSTX
0015DA E2F9 CDEAE3          17      CALL    DRDC
0015DD E2FC D1              10      POP DE
0015DE E2FD C1              10      POP BC
0015DF E2FE D435E6          17      CALL    NC,GNCLX
0015E2 E301 DA7BE2          10      JP  C,RBRERR
0015E5 E304 10EE            13      DJNZ    RBRB1
0015E7 E306 CD34E4          17      CALL    DRW_FLUSH
       E309                     RBRC:
0015EA E309 CDD8E3          17      CALL    RBXC
0015ED E30C 2811            12      JR  Z,RBREND
0015EF E30E C5              11      PUSH    BC
0015F0 E30F CDC5DE          17      CALL    CLUSTX
0015F3 E312 CD96E4          17      CALL    DRDX
0015F6 E315 C1              10      POP BC
0015F7 E316 DA7BE2          10      JP  C,RBRERR
0015FA E319 EB               4      EX  DE,HL
0015FB E31A 2A7EF1          16      LD  HL,(_DTBUF)
0015FE E31D EDB0                    LDIR
       E31F                     RBREND:
001600 E31F CDB3E1          17      CALL    RBXEND
       E322                     RBREND0:
001603 E322 FDE1            14      POP IY
001605 E324 C1              10      POP BC
001606 E325 D1              10      POP DE
001607 E326 F1              10      POP AF  ;(HL)
001608 E327 AF               4      XOR A
001609 E328 3E00             7      LD  A,000H
       E329                     RBRA_SWC    EQU $-1
00160B E32A C9              10      RET
                                
       E32B                     RBRDIR:
00160C E32B FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
00160F E32E FD661B          19      LD  H,(IY+27)
001612 E331 CD04DF          17      CALL    CHDIR
001615 E334 AF               4      XOR A
001616 E335 67               4      LD  H,A
001617 E336 6F               4      LD  L,A
001618 E337 3C               4      INC A
001619 E338 3229E3          13      LD  (RBRA_SWC),A
00161C E33B 18E5            12      JR  RBREND0
                                ;(15)
       E33D                     RBX0:
00161E E33D 2A8AF0          16      LD  HL,(_DTA)
001621 E340 225FF0          16      LD  (DTAX),HL
001624 E343 2A5DF0          16      LD  HL,(LEFTX)
001627 E346 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00162A E349 D6FD             7      SUB 0FDH
00162C E34B C9              10      RET
                                
       E34C                     RBX1:               ;ファイルサイズとランダムレコードを比べる
00162D E34C E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
00162E E34D FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
001631 E350 FD6611          19      LD  H,(IY+17)   ;
001634 E353 FD7E12          19      LD  A,(IY+18)   ;
                                
001637 E356 CD85E1          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
00163A E359 A7               4      AND A
00163B E35A ED52            15      SBC HL,DE
00163D E35C 99               4      SBC A,C
00163E E35D 4F               4      LD  C,A
00163F E35E FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
001642 E361 98               4      SBC A,B
001643 E362 D1              10      POP DE
001644 E363 C9              10      RET
       E364                     RBX1R:              ;(8)
001645 E364 47               4      LD  B,A
001646 E365 B1               4      OR  C
001647 E366 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
001648 E367 B2               4      OR  D
001649 E368 B3               4      OR  E
00164A E369 C0              11      RET NZ
00164B E36A 37               4      SCF
00164C E36B C9              10      RET
                                
       E36C                     RBX2:               ;Cluster settings
00164D E36C FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001650 E36F FD4E23          19      LD  C,(IY+35)
001653 E372 0600             7      LD  B,0
001655 E374 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001659 E378 2003            12      JR  NZ,RBX3
00165B E37A FD4624          19      LD  B,(IY+36)
       E37D                     RBX3:
00165E E37D CDB1E0          17      CALL    RWXR
001661 E380 3AA2E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001664 E383 3D               4      DEC A
001665 E384 FDA622          19      AND (IY+34)
001668 E387 FDB621          19      OR  (IY+33)
00166B E38A C9              10      RET
                                
       E38B                     RBXA:
00166C E38B C5              11      PUSH    BC
00166D E38C D5              11      PUSH    DE
00166E E38D CDC5DE          17      CALL    CLUSTX
001671 E390 CD96E4          17      CALL    DRDX
001674 E393 D1              10      POP DE
001675 E394 C1              10      POP BC
001676 E395 D435E6          17      CALL    NC,GNCLX
001679 E398 D8              11      RET C
00167A E399 ED53FEF1        20      LD  (_CLPS),DE
                                
00167E E39D FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
001681 E3A0 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       E3A1                     SECSZ   EQU $-2
       E3A2                     SECSZ_H EQU $-1
001684 E3A3 7C               4      LD  A,H
001685 E3A4 3D               4      DEC A       ;1024=3 / 512=1
001686 E3A5 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
001689 E3A8 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
00168A E3A9 ED42            15      SBC HL,BC       ;残りを計算
                                
00168C E3AB ED5B5DF0        20      LD  DE,(LEFTX)
001690 E3AF ED52            15      SBC HL,DE       ;CP HL,DE
001692 E3B1 19              11      ADD HL,DE       ;
001693 E3B2 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
001695 E3B4 EB               4      EX  DE,HL
       E3B5                     RBXA1:
001696 E3B5 E5              11      PUSH    HL
001697 E3B6 2A7EF1          16      LD  HL,(_DTBUF)
00169A E3B9 09              11      ADD HL,BC
00169B E3BA ED5B5FF0        20      LD  DE,(DTAX)
00169F E3BE C1              10      POP BC
0016A0 E3BF C9              10      RET
                                
       E3C0                     RBXB:
0016A1 E3C0 2A5FF0          16      LD  HL,(DTAX)
0016A4 E3C3 ED5BFEF1        20      LD  DE,(_CLPS)
0016A8 E3C7 3A5EF0          13      LD  A,(LEFTX+1)
0016AB E3CA 47               4      LD  B,A
0016AC E3CB 3AA2E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E3CE                     RBXB1:
0016AF E3CE 1F               4      RRA     ;->CF
0016B0 E3CF 3804            12      JR  C,RBXB2
0016B2 E3D1 CB38             8      SRL B   ;B=B/2
0016B4 E3D3 18F9            12      JR  RBXB1
       E3D5                     RBXB2:
0016B6 E3D5 78               4      LD  A,B
0016B7 E3D6 B7               4      OR  A
0016B8 E3D7 C9              10      RET
                                ;(12)
       E3D8                     RBXC:
0016B9 E3D8 ED4B5DF0        20      LD  BC,(LEFTX)
0016BD E3DC 3AA2E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
0016C0 E3DF 3D               4      DEC A
0016C1 E3E0 A0               4      AND B
0016C2 E3E1 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
0016C3 E3E2 B1               4      OR  C
0016C4 E3E3 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E3E4                     DWTC:
0016C5 E3E4 E5              11      PUSH    HL
0016C6 E3E5 21CEE7          10      LD  HL,DWT24B
0016C9 E3E8 1804            12      JR  DWTC1
       E3EA                     DRDC:
0016CB E3EA E5              11      PUSH    HL
0016CC E3EB 21C0E7          10      LD  HL,DRD24B
       E3EE                     DWTC1:
0016CF E3EE 2248E4          16      LD  (DRWF_MODE),HL
0016D2 E3F1 E1              10      POP HL
0016D3 E3F2 3A38E4          13      LD  A,(DRWF_B)
0016D6 E3F5 B7               4      OR  A
0016D7 E3F6 200F            12      JR  NZ,DRDC1
       E3F8                     SAVE_DRWC:
0016D9 E3F8 0601             7      LD  B,1
0016DB E3FA ED4337E4        20      LD  (DRWF_C),BC
0016DF E3FE ED533EE4        20      LD  (DRWF_E),DE
0016E3 E402 2241E4          16      LD  (DRWF_HL),HL
0016E6 E405 1820            12      JR  INC_HL_DRWC
       E407                     DRDC1:
0016E8 E407 E5              11      PUSH    HL
0016E9 E408 213EE4          10      LD  HL,DRWF_E
0016EC E40B 86               7      ADD A,(HL)
0016ED E40C F5              11      PUSH    AF
0016EE E40D BB               4      CP  E
0016EF E40E 201D            12      JR  NZ,DRDC2
0016F1 E410 F1              10      POP AF
0016F2 E411 23               6      INC HL
0016F3 E412 7E               7      LD  A,(HL)
0016F4 E413 CE00             7      ADC A,0
0016F6 E415 F5              11      PUSH    AF
0016F7 E416 BA               4      CP  D
0016F8 E417 2014            12      JR  NZ,DRDC2
0016FA E419 F1              10      POP AF
0016FB E41A 3A37E4          13      LD  A,(DRWF_C)
0016FE E41D CE00             7      ADC A,0
001700 E41F B9               4      CP  C
001701 E420 200C            12      JR  NZ,DRDC3
001703 E422 2138E4          10      LD  HL,DRWF_B
001706 E425 34              11      INC (HL)
001707 E426 E1              10      POP HL
       E427                     INC_HL_DRWC:
001708 E427 3AA2E3          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
00170B E42A 84               4      ADD A,H
00170C E42B 67               4      LD  H,A
00170D E42C C9              10      RET
       E42D                     DRDC2:
00170E E42D F1              10      POP AF
       E42E                     DRDC3:
00170F E42E CD34E4          17      CALL    DRW_FLUSH
001712 E431 E1              10      POP HL
001713 E432 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E434                     DRW_FLUSH:
001715 E434 C5              11      PUSH    BC
001716 E435 D5              11      PUSH    DE
001717 E436 010000          10      LD  BC,0
       E437                     DRWF_C  EQU $-2
       E438                     DRWF_B  EQU $-1
00171A E439 78               4      LD  A,B
00171B E43A B7               4      OR  A
00171C E43B 280D            12      JR  Z,DRDF1
00171E E43D 110000          10      LD  DE,0
       E43E                     DRWF_E  EQU $-2
       E43F                     DRWF_D  EQU $-1
001721 E440 210000          10      LD  HL,0
       E441                     DRWF_HL EQU $-2
001724 E443 AF               4      XOR A
001725 E444 3238E4          13      LD  (DRWF_B),A
001728 E447 CDC0E7          17      CALL    DRD24B
       E448                     DRWF_MODE   EQU $-2
       E44A                     DRDF1:
00172B E44A D1              10      POP DE
00172C E44B C1              10      POP BC
00172D E44C C9              10      RET
                                
       E44D                     RB_WRITE:
00172E E44D C5              11      PUSH    BC
00172F E44E 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
001731 E450 1803            12      JR  RBRW
       E452                     RB_READ:
001733 E452 C5              11      PUSH    BC
001734 E453 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       E455                     RBRW:
001736 E455 1F               4      RRA     ;AHL = AHL*128
001737 E456 7C               4      LD  A,H ;AHL = AHL0/2
001738 E457 1F               4      RRA     ;A
001739 E458 65               4      LD  H,L ;
00173A E459 CB1C             8      RR  H   ;H
00173C E45B 2E00             7      LD  L,0 ;
00173E E45D CB1D             8      RR  L   ;L
001740 E45F CD6AE1          17      CALL    SET_RR_AHL
001743 E462 218000          10      LD  HL,128
001746 E465 C5              11      PUSH    BC
       E466                     SETSEQ_SWC_RND:
001747 E466 CD99E1          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
00174A E469 C1              10      POP BC
00174B E46A FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
00174F E46E FDE5            15      PUSH    IY
001751 E470 D1              10      POP DE
001752 E471 D5              11      PUSH    DE
001753 E472 CD4ED4          17      CALL    BDOS0
001756 E475 FDE1            14      POP IY
001758 E477 CD74E1          17      CALL    SETSEQ      ;SETSEQ or POPRR
       E478                     SETSEQ_SWC_SEQ_RR   EQU $-2
00175B E47A FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
00175F E47E C1              10      POP BC
001760 E47F C9              10      RET
                                
                                ;(22)
       E480                     INIT_SEQ:
001761 E480 3E01             7      LD  A,1     ;LD BC,????
001763 E482 2174E1          10      LD  HL,SETSEQ
001766 E485 CD3AE1          17      CALL    PUSHRR
       E488                     GETSEQ:
001769 E488 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
00176C E48B FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
00176F E48E AF               4      XOR A
                                
001770 E48F CB25             8      SLA L   ;L=L*2
                                
001772 E491 CB3C             8      SRL H   ;HL=HL/2
001774 E493 CB1D             8      RR  L   ;
001776 E495 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E496                     DRDX:
001777 E496 CDD4E4          17      CALL    DRDY
00177A E499 C8              11      RET Z
00177B E49A CDBAE4          17      CALL    DRDX1       ;データバッファの情報を保存
00177E E49D D8              11      RET C
00177F E49E E5              11      PUSH    HL
001780 E49F C5              11      PUSH    BC
001781 E4A0 D5              11      PUSH    DE
001782 E4A1 2A7EF1          16      LD  HL,(_DTBUF)
001785 E4A4 3AFDE4          13      LD  A,(_DBS24)
001788 E4A7 4F               4      LD  C,A
001789 E4A8 CDBEE7          17      CALL    DRD24
00178C E4AB DCCFE4          17      CALL    C,DRDNE
       E4AE                     POP_DE_BC_HL_RET:
00178F E4AE D1              10      POP DE
001790 E4AF C1              10      POP BC
001791 E4B0 E1              10      POP HL
001792 E4B1 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E4B2                     DRDN:
001793 E4B2 AF               4      XOR A
001794 E4B3 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
001795 E4B4 30E0            12      JR  NC,DRDX
       E4B6                     DRDNX:
001797 E4B6 CDD4E4          17      CALL    DRDY
00179A E4B9 C8              11      RET Z
       E4BA                     DRDX1:
00179B E4BA CDEAE4          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
00179E E4BD ED53A6F0        20      LD  (_DBSEC),DE
0017A2 E4C1 79               4      LD  A,C
0017A3 E4C2 32FDE4          13      LD  (_DBS24),A
                                
0017A6 E4C5 3A88F0          13      LD  A,(_DRV)
0017A9 E4C8 32A5F0          13      LD  (_DBDRV),A
0017AC E4CB CDD9F0          17      CALL    _CHGDRV
0017AF E4CE D0              11      RET NC
       E4CF                     DRDNE:
0017B0 E4CF 9F               4      SBC A,A     ;CF=1ならばA=0FFH
0017B1 E4D0 32A5F0          13      LD  (_DBDRV),A
0017B4 E4D3 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E4D4                     DRDY:
0017B5 E4D4 3AFDE4          13      LD  A,(_DBS24)
0017B8 E4D7 B9               4      CP  C
0017B9 E4D8 C0              11      RET NZ
                                
0017BA E4D9 E5              11      PUSH    HL
0017BB E4DA 3A88F0          13      LD  A,(_DRV)
0017BE E4DD 21A5F0          10      LD  HL,_DBDRV
0017C1 E4E0 AE               7      XOR (HL)
0017C2 E4E1 2005            12      JR  NZ,POP_HL_RET
                                
0017C4 E4E3 2AA6F0          16      LD  HL,(_DBSEC)
0017C7 E4E6 ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E4E8                     POP_HL_RET:
0017C9 E4E8 E1              10      POP HL
0017CA E4E9 C9              10      RET
                                
       E4EA                     DWTX:
0017CB E4EA 3AA4F0          13      LD  A,(_WTDBF)
0017CE E4ED B7               4      OR  A
0017CF E4EE C8              11      RET Z
0017D0 E4EF AF               4      XOR A
0017D1 E4F0 32A4F0          13      LD  (_WTDBF),A
                                
0017D4 E4F3 E5              11      PUSH    HL
0017D5 E4F4 C5              11      PUSH    BC
0017D6 E4F5 D5              11      PUSH    DE
0017D7 E4F6 3AA5F0          13      LD  A,(_DBDRV)
0017DA E4F9 CDD9F0          17      CALL    _CHGDRV
0017DD E4FC 0E00             7      LD  C,0
       E4FD                     _DBS24  EQU $-1
0017DF E4FE ED5BA6F0        20      LD  DE,(_DBSEC)
0017E3 E502 2A7EF1          16      LD  HL,(_DTBUF)
0017E6 E505 D4CCE7          17      CALL    NC,DWT24
       E508                     POP_DE_BC_HL_RET2:
0017E9 E508 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E50A                     RDFATX:
0017EB E50A E5              11      PUSH    HL
0017EC E50B 3A88F0          13      LD  A,(_DRV)
0017EF E50E 21AAF0          10      LD  HL,_FATDRV
0017F2 E511 AE               7      XOR (HL)
0017F3 E512 28D4            12      JR  Z,POP_HL_RET
                                
0017F5 E514 C5              11      PUSH    BC
0017F6 E515 D5              11      PUSH    DE
0017F7 E516 DDE5            15      PUSH    IX
0017F9 E518 CD34E5          17      CALL    WTFATX
0017FC E51B 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
0017FE E51D AF               4      XOR A
0017FF E51E 32ABF0          13      LD  (_FATIX),A
001802 E521 3A88F0          13      LD  A,(_DRV)
001805 E524 32AAF0          13      LD  (_FATDRV),A
001808 E527 CDE5F0          17      CALL    _RDFAT
       E52A                     RDFATE2:
00180B E52A 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
00180D E52C 9F               4      SBC A,A     ;A=0xFF
00180E E52D 32AAF0          13      LD  (_FATDRV),A
       E530                     POP_IX_DE_BC_HL_RET:
001811 E530 DDE1            14      POP IX
001813 E532 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E534                     WTFATX:
001815 E534 3AA2F0          13      LD  A,(_WTFATF)
001818 E537 B7               4      OR  A
001819 E538 C8              11      RET Z
00181A E539 AF               4      XOR A
00181B E53A 32A2F0          13      LD  (_WTFATF),A
                                
00181E E53D E5              11      PUSH    HL
00181F E53E 3AAAF0          13      LD  A,(_FATDRV)
001822 E541 21A5F0          10      LD  HL,_DBDRV
001825 E544 AE               7      XOR (HL)
001826 E545 CCEAE4          17      CALL    Z,DWTX
001829 E548 389E            12      JR  C,POP_HL_RET
00182B E54A C5              11      PUSH    BC
00182C E54B D5              11      PUSH    DE
00182D E54C DDE5            15      PUSH    IX
00182F E54E CDDDE7          17      CALL    FATSETUP
001832 E551 D4CEE7          17      CALL    NC,DWT24B
001835 E554 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E556                     N16CL1:
001837 E556 7A               4      LD  A,D
001838 E557 B3               4      OR  E
001839 E558 37               4      SCF
00183A E559 C8              11      RET Z
                                
00183B E55A 7A               4      LD  A,D
00183C E55B 1807            12      JR  NCL1X
       E55D                     NCL1:
00183E E55D 7A               4      LD  A,D
00183F E55E B3               4      OR  E
001840 E55F 37               4      SCF
001841 E560 C8              11      RET Z
                                
001842 E561 7A               4      LD  A,D
001843 E562 CB3F             8      SRL A   ;/2
       E564                     NCL1X:
001845 E564 CB3F             8      SRL A   ;/2
                                
001847 E566 E5              11      PUSH    HL
001848 E567 3286E5          13      LD  (NCLPAT_FATIX),A    ;_FATIX
00184B E56A 2AAAF0          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
00184E E56D BC               4      CP  H
00184F E56E 3A88F0          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001852 E571 3285E5          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001855 E574 2005            12      JR  NZ,NCL2     ;FATIXが違う
001857 E576 BD               4      CP  L
001858 E577 2002            12      JR  NZ,NCL2     ;ドライブが違う
00185A E579 E1              10      POP HL
00185B E57A C9              10      RET
       E57B                     NCL2:
00185C E57B C5              11      PUSH    BC
00185D E57C D5              11      PUSH    DE
00185E E57D DDE5            15      PUSH    IX
001860 E57F CD34E5          17      CALL    WTFATX
001863 E582 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
001865 E584 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E586                     NCLPAT_FATIX    EQU $-1
       E585                     NCLPAT_FATDRV   EQU $-2
001868 E587 ED43AAF0        20      LD  (_FATDRV),BC
00186C E58B CDB2E7          17      CALL    RDFATS
00186F E58E 189A            12      JR  RDFATE2
                                
       E590                     NCL3:
001871 E590 CB9A             8      RES 3,D
001873 E592 CB92             8      RES 2,D
001875 E594 6B               4      LD  L,E
001876 E595 62               4      LD  H,D
001877 E596 CB3C             8      SRL H   ;
001879 E598 CB1D             8      RR  L   ;HLA=HLA/2
00187B E59A 1F               4      RRA     ;
00187C E59B F5              11      PUSH    AF
00187D E59C 3AABF0          13      LD  A,(_FATIX)
001880 E59F 0F               4      RRCA
001881 E5A0 300B            12      JR  NC,NCL3X1
001883 E5A2 3AA2E3          13      LD  A,(SECSZ_H)
001886 E5A5 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの際に先頭を512バイトずらす
001888 E5A7 2004            12      JR  NZ,NCL3X1
00188A E5A9 010002          10      LD  BC,512
00188D E5AC 09              11      ADD HL,BC
       E5AD                     NCL3X1:
00188E E5AD F1              10      POP AF
00188F E5AE ED4B7CF1        20      LD  BC,(_FATBF)
001893 E5B2 19              11      ADD HL,DE
001894 E5B3 09              11      ADD HL,BC
001895 E5B4 17               4      RLA
001896 E5B5 C9              10      RET
                                
       E5B6                     GNCL:
001897 E5B6 CD5DE5          17      CALL    NCL1        ;GET NEXT CLUSTER
00189A E5B9 D8              11      RET C
00189B E5BA C5              11      PUSH    BC
00189C E5BB E5              11      PUSH    HL
00189D E5BC CD90E5          17      CALL    NCL3
0018A0 E5BF 3809            12      JR  C,GNC1
0018A2 E5C1 5E               7      LD  E,(HL)
0018A3 E5C2 23               6      INC HL
0018A4 E5C3 7E               7      LD  A,(HL)
0018A5 E5C4 E60F             7      AND 00FH
0018A7 E5C6 57               4      LD  D,A
0018A8 E5C7 E1              10      POP HL
0018A9 E5C8 C1              10      POP BC
0018AA E5C9 C9              10      RET
       E5CA                     GNC1:
0018AB E5CA 7E               7      LD  A,(HL)
0018AC E5CB 23               6      INC HL
0018AD E5CC 56               7      LD  D,(HL)
0018AE E5CD 0604             7      LD  B,4
       E5CF                     GNC1L:
0018B0 E5CF CB3A             8      SRL D   ;DA=DA/2
0018B2 E5D1 1F               4      RRA     ;
0018B3 E5D2 10FB            13      DJNZ    GNC1L
                                
0018B5 E5D4 5F               4      LD  E,A
0018B6 E5D5 E1              10      POP HL
0018B7 E5D6 C1              10      POP BC
0018B8 E5D7 A7               4      AND A
0018B9 E5D8 C9              10      RET
                                
       E5D9                     SNCL:
0018BA E5D9 CD5DE5          17      CALL    NCL1
0018BD E5DC D8              11      RET C
                                ;               SET NEXT CLUSTER
0018BE E5DD E5              11      PUSH    HL
0018BF E5DE C5              11      PUSH    BC
0018C0 E5DF D5              11      PUSH    DE
0018C1 E5E0 E5              11      PUSH    HL
0018C2 E5E1 CD90E5          17      CALL    NCL3
0018C5 E5E4 D1              10      POP DE
                                ;CF=ODD
0018C6 E5E5 7E               7      LD  A,(HL)
0018C7 E5E6 73               7      LD  (HL),E
0018C8 E5E7 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
0018CA E5E9 23               6      INC HL
0018CB E5EA ED67            18      RRD     ;M={A[3:0],E[3:0]}
0018CD E5EC 7A               4      LD  A,D
0018CE E5ED 1804            12      JR  SNC11
       E5EF                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
0018D0 E5EF ED6F            18      RLD     ;M={D[3:0],E[7:4]}
0018D2 E5F1 23               6      INC HL
0018D3 E5F2 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E5F3                     SNC11:
0018D4 E5F3 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
0018D6 E5F5 B7               4      OR  A
0018D7 E5F6 D1              10      POP DE
0018D8 E5F7 C1              10      POP BC
0018D9 E5F8 E1              10      POP HL
       E5F9                     FAT_CHANGED:
0018DA E5F9 3EFF             7      LD  A,0FFH
0018DC E5FB 32A2F0          13      LD  (_WTFATF),A
0018DF E5FE C9              10      RET
                                
       E5FF                     N16CL3:
0018E0 E5FF C5              11      PUSH    BC
0018E1 E600 6B               4      LD  L,E
0018E2 E601 7A               4      LD  A,D
0018E3 E602 E601             7      AND 1
0018E5 E604 67               4      LD  H,A
0018E6 E605 29              11      ADD HL,HL
0018E7 E606 ED4B7CF1        20      LD  BC,(_FATBF)
0018EB E60A 09              11      ADD HL,BC
0018EC E60B C1              10      POP BC
0018ED E60C C9              10      RET
                                
       E60D                     GNCL16:
0018EE E60D CD56E5          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
0018F1 E610 D8              11      RET C
0018F2 E611 E5              11      PUSH    HL
0018F3 E612 CDFFE5          17      CALL    N16CL3
0018F6 E615 5E               7      LD  E,(HL)
0018F7 E616 23               6      INC HL
0018F8 E617 56               7      LD  D,(HL)
0018F9 E618 E1              10      POP HL
0018FA E619 C9              10      RET
                                
       E61A                     SNCL16:
0018FB E61A CD56E5          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
0018FE E61D D8              11      RET C
0018FF E61E D5              11      PUSH    DE
001900 E61F E5              11      PUSH    HL
001901 E620 CDFFE5          17      CALL    N16CL3
001904 E623 D1              10      POP DE      ;HL
001905 E624 73               7      LD  (HL),E
001906 E625 23               6      INC HL
001907 E626 72               7      LD  (HL),D
001908 E627 6B               4      LD  L,E
001909 E628 62               4      LD  H,D
00190A E629 D1              10      POP DE
00190B E62A 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E62C                     NEXTX:
00190D E62C 3E00             7      LD  A,0 ;自己書き換え
       E62D                     _SECPS  EQU $-1
00190F E62E 3C               4      INC A
001910 E62F E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E630                     _NCPAT  EQU $-1
001912 E631 322DE6          13      LD  (_SECPS),A
001915 E634 C9              10      RET
                                
       E635                     GNCLX:
001916 E635 CD2CE6          17      CALL    NEXTX
001919 E638 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
00191A E639 C3F7F0          10      JP  _GNCL   ;次のクラスタを探す
                                
       E63C                     RDFAT:
00191D E63C 3E80             7      LD  A,080H
00191F E63E 3270F0          13      LD  (CHECK),A
       E641                     RDFAT1:
001922 E641 3A88F0          13      LD  A,(_DRV)
001925 E644 CDE6E8          17      CALL    CHGDRVR
001928 E647 D8              11      RET C
001929 E648 DD7E12          19      LD  A,(IX+DPB_DEVICE)
00192C E64B CB6F             8      BIT 5,A
00192E E64D 286E            12      JR  Z,RDFAT0X
001930 E64F 2170F0          10      LD  HL,CHECK
001933 E652 A6               7      AND (HL)
001934 E653 77               7      LD  (HL),A
001935 E654 110000          10      LD  DE,0        ;BPB
001938 E657 2A7CF1          16      LD  HL,(_FATBF)
00193B E65A 0E00             7      LD  C,0
00193D E65C CDBEE7          17      CALL    DRD24
001940 E65F 3022            12      JR  NC,GETBPB
001942 E661 2170F0          10      LD  HL,CHECK
001945 E664 CB06            15      RLC (HL)
001947 E666 3F               4      CCF
001948 E667 D8              11      RET C
001949 E668 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
00194D E66C 3F               4      CCF         ;フロッピーディスクのFDモード(2D/2HD)を切り替える
00194E E66D DDCB0A16        23      RL  (IX+DPB_FDMODE)
001952 E671 3A84F0          13      LD  A,(_DRIVE)
001955 E674 E603             7      AND 3
001957 E676 F680             7      OR  080H
001959 E678 6F               4      LD  L,A
00195A E679 26F0             7      LD  H,_CYL0/256
00195C E67B 3EFF             7      LD  A,0FFH
00195E E67D 3289F0          13      LD  (_DSK),A
001961 E680 77               7      LD  (HL),A
001962 E681 18BE            12      JR  RDFAT1
       E683                     GETBPB:
001964 E683 FDE5            15      PUSH    IY
001966 E685 FD2A7CF1        20      LD  IY,(_FATBF) ;BPB
00196A E689 CDF1F0          17      CALL    _BPB2DPB
00196D E68C FDE1            14      POP IY
00196F E68E DD7E12          19      LD  A,(IX+DPB_DEVICE)
001972 E691 3027            12      JR  NC,GETBPBOK
001974 E693 E60F             7      AND 00FH
001976 E695 FE07             7      CP  7
001978 E697 37               4      SCF
001979 E698 C0              11      RET NZ
00197A E699 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
00197E E69D 21C0F1          10      LD  HL,M2D
001981 E6A0 2008            12      JR  NZ,SETFDMODE
001983 E6A2 2E04             7      LD  L,4
001985 E6A4 CDA7E7          17      CALL    CHECK_MAXSECSZ
001988 E6A7 D8              11      RET C
001989 E6A8 2ED2             7      LD  L,M2HD-STABLE
       E6AA                     SETFDMODE:
00198B E6AA DDE5            15      PUSH    IX
00198D E6AC D1              10      POP DE
00198E E6AD EDA0            16      LDI
001990 E6AF EDA0            16      LDI
001992 E6B1 13               6      INC DE
001993 E6B2 13               6      INC DE
001994 E6B3 13               6      INC DE
001995 E6B4 13               6      INC DE
001996 E6B5 010C00          10      LD  BC,12
001999 E6B8 EDB0                    LDIR
       E6BA                     GETBPBOK:
00199B E6BA CD52E8          17      CALL    CHGDRV2
       E6BD                     RDFAT0X:
00199E E6BD CDB2E7          17      CALL    RDFATS
0019A1 E6C0 D8              11      RET C
0019A2 E6C1 DDAE06          19      XOR (IX+DPB_FATID)
0019A5 E6C4 C8              11      RET Z
0019A6 E6C5 DD7E12          19      LD  A,(IX+DPB_DEVICE)
0019A9 E6C8 CB5F             8      BIT 3,A
0019AB E6CA 2803            12      JR  Z,RDFAT0X1
0019AD E6CC CB6F             8      BIT 5,A
0019AF E6CE C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E6CF                     RDFAT0X1:
0019B0 E6CF 37               4      SCF
0019B1 E6D0 C9              10      RET
                                
       E6D1                     POP_HL_SCF_RET:
0019B2 E6D1 E1              10      POP HL
0019B3 E6D2 37               4      SCF
0019B4 E6D3 C9              10      RET
                                
       E6D4                     BPB2DPB:
0019B5 E6D4 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
0019B8 E6D7 B7               4      OR  A
0019B9 E6D8 37               4      SCF
0019BA E6D9 C0              11      RET NZ
       E6DA                     BPBOK:
0019BB E6DA FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
0019BE E6DD DD7707          19      LD  (IX+DPB_SECPCL),A
                                
0019C1 E6E0 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
0019C4 E6E3 DD7700          19      LD  (IX+DPB_FATLN),A
0019C7 E6E6 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
0019CA E6E9 DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
0019CD E6EC FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
0019D0 E6EF FD660F          19      LD  H,(IY+15)
0019D3 E6F2 DD750E          19      LD  (IX+DPB_FATPS),L
0019D6 E6F5 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
0019D9 E6F8 FD5617          19      LD  D,(IY+23)
0019DC E6FB FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E6FE                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
0019DF E6FE 19              11      ADD HL,DE
0019E0 E6FF 10FD            13      DJNZ    BPBDP1
       E701                     BPBDP2:
0019E2 E701 DD7510          19      LD  (IX+DPB_DIRPS),L
0019E5 E704 DD7411          19      LD  (IX+DPB_DIRPS+1),H
0019E8 E707 E5              11      PUSH    HL
                                
0019E9 E708 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
0019EC E70B FD6612          19      LD  H,(IY+18)
0019EF E70E FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
0019F2 E711 B7               4      OR  A
0019F3 E712 28BD            12      JR  Z,POP_HL_SCF_RET
0019F5 E714 0606             7      LD  B,6
       E716                     BPBBPS1:
0019F7 E716 05               4      DEC B
0019F8 E717 0F               4      RRCA
0019F9 E718 30FC            12      JR  NC,BPBBPS1
       E71A                     BPBDE1:
0019FB E71A 29              11      ADD HL,HL
0019FC E71B 10FD            13      DJNZ    BPBDE1
                                
0019FE E71D 7C               4      LD  A,H
0019FF E71E DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
001A02 E721 D1              10      POP DE      ;DPB_DIRPS
001A03 E722 6C               4      LD  L,H
001A04 E723 2600             7      LD  H,0
001A06 E725 19              11      ADD HL,DE       ;MAXDIR
001A07 E726 E5              11      PUSH    HL
001A08 E727 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001A0B E72A CB21             8      SLA C       ;*2
001A0D E72C AF               4      XOR A
001A0E E72D 47               4      LD  B,A
001A0F E72E ED42            15      SBC HL,BC
001A11 E730 DD7514          19      LD  (IX+DPB_ADDCL),L
001A14 E733 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
001A17 E736 D1              10      POP DE      ;DE=DPB_MAXDIR
001A18 E737 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001A1B E73A FD6614          19      LD  H,(IY+20)
                                
001A1E E73D DD7E12          19      LD  A,(IX+DPB_DEVICE)
001A21 E740 E60F             7      AND 00FH
001A23 E742 FE07             7      CP  7       ;フロッピー
001A25 E744 2019            12      JR  NZ,NOT_FD
001A27 E746 E5              11      PUSH    HL
001A28 E747 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001A2B E74A DD710D          19      LD  (IX+DPB_MAXSEC),C
001A2E E74D AF               4      XOR A
001A2F E74E CB21             8      SLA C       ;両面なのでセクタ数を２倍
001A31 E750 0610             7      LD  B,16
       E752                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001A33 E752 29              11      ADD HL,HL
001A34 E753 17               4      RLA
001A35 E754 B9               4      CP  C
001A36 E755 3802            12      JR  C,DIVSEC1
001A38 E757 91               4      SUB C
001A39 E758 2C               4      INC L
       E759                     DIVSEC1:
001A3A E759 10F7            13      DJNZ    DIVSEC
001A3C E75B DD750C          19      LD  (IX+DPB_MAXCYL),L
001A3F E75E E1              10      POP HL  ;ここまでフロッピー専用
       E75F                     NOT_FD:
001A40 E75F 7C               4      LD  A,H
001A41 E760 B5               4      OR  L
001A42 E761 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001A44 E763 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001A46 E765 2F               4      CPL         ;A=0FFH
001A47 E766 FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001A4A E769 D8              11      RET C
001A4B E76A FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001A4E E76D FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001A51 E770 FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E773                     BPB16BIT:
001A54 E773 ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001A56 E775 DE00             7      SBC A,0
001A58 E777 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E77A                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001A5B E77A CB18             8      RR  B       ;->CY
001A5D E77C 3808            12      JR  C,BPBTC2
001A5F E77E CB3F             8      SRL A
001A61 E780 CB1C             8      RR  H       ;AHL=AHL/2
001A63 E782 CB1D             8      RR  L
001A65 E784 18F4            12      JR  BPBTC1
       E786                     BPBTC2:
001A67 E786 C6FF             7      ADD A,0FFH
001A69 E788 D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001A6A E789 23               6      INC HL
001A6B E78A 23               6      INC HL
001A6C E78B DD7508          19      LD  (IX+DPB_MAXCL),L
001A6F E78E DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001A72 E791 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001A75 E794 DD7706          19      LD  (IX+DPB_FATID),A
                                
001A78 E797 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001A7B E79A C6FE             7      ADD A,0-2       ;>2:CF=1
001A7D E79C FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001A80 E79F 6F               4      LD  L,A
001A81 E7A0 3002            12      JR  NC,BPBFAT1
001A83 E7A2 F680             7      OR  080H
       E7A4                     BPBFAT1:            ;ここではCF=0
001A85 E7A4 DD770F          19      LD  (IX+DPB_BPS),A
       E7A7                     CHECK_MAXSECSZ:
001A88 E7A7 3A7BF1          13      LD  A,(_MAX_SEC_SZ_H)
001A8B E7AA BD               4      CP  L
001A8C E7AB C8              11      RET Z       ;1セクタ1024バイト
001A8D E7AC 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001A8E E7AD C8              11      RET Z       ;1セクタ256バイト
001A8F E7AE 2D               4      DEC L
001A90 E7AF C8              11      RET Z       ;1セクタ512バイト
001A91 E7B0 37               4      SCF
001A92 E7B1 C9              10      RET
                                
       E7B2                     RDFATS:
001A93 E7B2 CDDDE7          17      CALL    FATSETUP
001A96 E7B5 D8              11      RET C
001A97 E7B6 CDC0E7          17      CALL    DRD24B
001A9A E7B9 2A7CF1          16      LD  HL,(_FATBF)
001A9D E7BC 7E               7      LD  A,(HL)
001A9E E7BD C9              10      RET
                                
       E7BE                     DRD24:
001A9F E7BE 0601             7      LD  B,1
       E7C0                     DRD24B:
001AA1 E7C0 DDE5            15      PUSH    IX
001AA3 E7C2 DD2AA8F0        20      LD  IX,(_DPB)
001AA7 E7C6 CD26EA          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E7C7                     DRDPAT  EQU $-2
001AAA E7C9 DDE1            14      POP IX
001AAC E7CB C9              10      RET
                                
       E7CC                     DWT24:
001AAD E7CC 0601             7      LD  B,1
       E7CE                     DWT24B:
001AAF E7CE DDE5            15      PUSH    IX
001AB1 E7D0 DD2AA8F0        20      LD  IX,(_DPB)
001AB5 E7D4 CDCFE9          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E7D5                     DWTPAT  EQU $-2
001AB8 E7D7 DDE1            14      POP IX
001ABA E7D9 D0              11      RET NC
001ABB E7DA C35AF0          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E7DD                     FATSETUP:
001ABE E7DD 3AAAF0          13      LD  A,(_FATDRV)
001AC1 E7E0 CDE6E8          17      CALL    CHGDRVR     ;ドライブ切り替え
001AC4 E7E3 D8              11      RET C
       E7E4                     FATS2:
001AC5 E7E4 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001AC8 E7E7 0F               4      RRCA
001AC9 E7E8 CD18E8          17      CALL    FATSETUP12  ;自己書き換え
       E7E9                     FATSX   EQU $-2
001ACC E7EB 210000          10      LD  HL,0
001ACF E7EE 4A               4      LD  C,D
001AD0 E7EF 54               4      LD  D,H
001AD1 E7F0 3AABF0          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
001AD4 E7F3 47               4      LD  B,A
001AD5 E7F4 04               4      INC B
001AD6 E7F5 DD7E00          19      LD  A,(IX+DPB_FATLN)
       E7F8                     FAT_SKP:
001AD9 E7F8 05               4      DEC B
001ADA E7F9 2809            12      JR  Z,FAT1
001ADC E7FB 19              11      ADD HL,DE
001ADD E7FC 93               4      SUB E
001ADE E7FD 30F9            12      JR  NC,FAT_SKP
001AE0 E7FF DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
001AE4 E803 C8              11      RET Z
       E804                     FAT1:
001AE5 E804 EB               4      EX  DE,HL
001AE6 E805 B7               4      OR  A       ;0の場合は0100Hとして扱う
001AE7 E806 2803            12      JR  Z,FAT3
001AE9 E808 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001AEA E809 3801            12      JR  C,FAT2
       E80B                     FAT3:
001AEC E80B 79               4      LD  A,C
       E80C                     FAT2:
001AED E80C 47               4      LD  B,A
                                
001AEE E80D 2AFAF1          16      LD  HL,(_FATPS) ;fat sector pos
001AF1 E810 19              11      ADD HL,DE
001AF2 E811 EB               4      EX  DE,HL
001AF3 E812 2A7CF1          16      LD  HL,(_FATBF)
001AF6 E815 AF               4      XOR A       ;CF=0
001AF7 E816 4F               4      LD  C,A
001AF8 E817 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E818                     FATSETUP12:
001AF9 E818 110606          10      LD  DE,0606H    ;256
001AFC E81B D8              11      RET C
001AFD E81C 110303          10      LD  DE,0303H    ;512
001B00 E81F 0F               4      RRCA
001B01 E820 D8              11      RET C
001B02 E821 110102          10      LD  DE,0201H    ;1024
001B05 E824 C9              10      RET
                                
       E825                     FATSETUP16:
001B06 E825 110404          10      LD  DE,0404H    ;256
001B09 E828 D8              11      RET C
001B0A E829 110202          10      LD  DE,0202H    ;512
001B0D E82C 0F               4      RRCA
001B0E E82D D8              11      RET C
001B0F E82E 110101          10      LD  DE,0101H    ;1024
001B12 E831 C9              10      RET
                                
       E832                     CHGDRV:
001B13 E832 E5              11      PUSH    HL
001B14 E833 2189F0          10      LD  HL,_DSK
001B17 E836 BE               7      CP  (HL)
001B18 E837 280A            12      JR  Z,CHGDRVE
       E839                     CHGDRV1:
001B1A E839 DDE5            15      PUSH    IX
001B1C E83B CD45E8          17      CALL    CHGDRV0
001B1F E83E 3A89F0          13      LD  A,(_DSK)
001B22 E841 DDE1            14      POP IX
       E843                     CHGDRVE:
001B24 E843 E1              10      POP HL
001B25 E844 C9              10      RET
                                
       E845                     CHGDRV0:
001B26 E845 6F               4      LD  L,A
001B27 E846 CDDCF0          17      CALL    _GETDPB
001B2A E849 D8              11      RET C
001B2B E84A DD22A8F0        20      LD  (_DPB),IX
001B2F E84E 7D               4      LD  A,L
001B30 E84F 3289F0          13      LD  (_DSK),A
       E852                     CHGDRV2:
001B33 E852 C5              11      PUSH    BC
001B34 E853 D5              11      PUSH    DE
001B35 E854 ED739DE8        20      LD  (SPPAT2),SP
001B39 E858 F3               4      DI
001B3A E859 DDF9            10      LD  SP,IX
                                
001B3C E85B E1              10      POP HL      ;00:DPB_FATLN
001B3D E85C E1              10      POP HL      ;02:DPB_DRD
001B3E E85D 22C7E7          16      LD  (DRDPAT),HL
                                
001B41 E860 E1              10      POP HL
001B42 E861 22D5E7          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001B45 E864 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001B46 E865 7C               4      LD  A,H
001B47 E866 32C9DE          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001B4A E869 3D               4      DEC A
001B4B E86A 3230E6          13      LD  (_NCPAT),A
                                
001B4E E86D E1              10      POP HL      ;08:DPB_MAXCL
001B4F E86E 7D               4      LD  A,L
001B50 E86F 32E8DE          13      LD  (CLPAT2),A
001B53 E872 7C               4      LD  A,H
001B54 E873 32E4DE          13      LD  (CLPAT1),A
001B57 E876 2B               6      DEC HL
001B58 E877 22E7E0          16      LD  (MAXCLP),HL
                                
001B5B E87A E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001B5C E87B 4C               4      LD  C,H
                                
001B5D E87C E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001B5E E87D E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001B5F E87E 7C               4      LD  A,H     ;DPB_BPS
001B60 E87F E607             7      AND 7
001B62 E881 32A2E3          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001B65 E884 87               4      ADD A,A     ;8  4   2
001B66 E885 87               4      ADD A,A     ;010H   8   4
001B67 E886 87               4      ADD A,A     ;020H   010H    8
001B68 E887 3247DD          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001B6B E88A 2600             7      LD  H,0
001B6D E88C 22FAF1          16      LD  (_FATPS),HL
                                
001B70 E88F E1              10      POP HL      ;10:DPB_DIRPS
001B71 E890 22FCF1          16      LD  (_DIRPS),HL
                                
001B74 E893 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001B75 E894 7C               4      LD  A,H
001B76 E895 3284F0          13      LD  (_DRIVE),A
                                
001B79 E898 E1              10      POP HL      ;14:DPB_ADDCL
001B7A E899 22D9DE          16      LD  (CLSPAT),HL
                                
001B7D E89C 310000          10      LD  SP,0        ;元のSPを復元
       E89D                     SPPAT2  EQU $-2
001B80 E89F FB               4      EI
001B81 E8A0 2AFCF1          16      LD  HL,(_DIRPS)
001B84 E8A3 0600             7      LD  B,0
001B86 E8A5 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001B87 E8A6 2262DD          16      LD  (MD_PAT),HL
                                
001B8A E8A9 2AE7E0          16      LD  HL,(MAXCLP)
001B8D E8AC 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001B90 E8AF 19              11      ADD HL,DE
001B91 E8B0 380F            12      JR  C,SETFAT16
001B93 E8B2 21B6E5          10      LD  HL,GNCL     ;FAT12
001B96 E8B5 11D9E5          10      LD  DE,SNCL
001B99 E8B8 0118E8          10      LD  BC,FATSETUP12
001B9C E8BB DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001BA0 E8BF 180D            12      JR  EXTRA1
       E8C1                     SETFAT16:
001BA2 E8C1 210DE6          10      LD  HL,GNCL16   ;FAT16
001BA5 E8C4 111AE6          10      LD  DE,SNCL16
001BA8 E8C7 0125E8          10      LD  BC,FATSETUP16
001BAB E8CA DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       E8CE                     EXTRA1:
001BAF E8CE 22F8F0          16      LD  (GNCPAT),HL
001BB2 E8D1 ED53FBF0        20      LD  (SNCPAT),DE
001BB6 E8D5 ED43E9E7        20      LD  (FATSX),BC
001BBA E8D9 D1              10      POP DE
001BBB E8DA C1              10      POP BC
001BBC E8DB AF               4      XOR A
001BBD E8DC C9              10      RET
                                
       E8DD                     GETDPBD:
001BBE E8DD DDE3            23      EX  (SP),IX
001BC0 E8DF DDE5            15      PUSH    IX
001BC2 E8E1 3A88F0          13      LD  A,(_DRV)
001BC5 E8E4 1807            12      JR  GETDPB1
                                
       E8E6                     CHGDRVR:
001BC7 E8E6 CDD9F0          17      CALL    _CHGDRV
001BCA E8E9 D8              11      RET C
001BCB E8EA 3A89F0          13      LD  A,(_DSK)
       E8ED                     GETDPB1:
001BCE E8ED C3DCF0          10      JP  _GETDPB
                                
       E8F0                     GETDPB:
001BD1 E8F0 FE08             7      CP  8
001BD3 E8F2 3F               4      CCF
001BD4 E8F3 D8              11      RET C
001BD5 E8F4 0F               4      RRCA
001BD6 E8F5 0F               4      RRCA
001BD7 E8F6 0F               4      RRCA
001BD8 E8F7 DD                      DB  0DDH        ;Z80未定義命令
001BD9 E8F8 6F               4      LD  L,A     ;LD IXL,A
001BDA E8F9 DD                      DB  0DDH        ;Z80未定義命令
001BDB E8FA 26F2             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001BDD E8FC DD7E00          19      LD  A,(IX+DPB_FATLN)
001BE0 E8FF A7               4      AND A       ;CF=0の為
001BE1 E900 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001BE5 E904 C0              11      RET NZ      ;FAT16
001BE6 E905 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001BEA E909 C0              11      RET NZ      ;BPB
001BEB E90A FE01             7      CP  001H        ;A=0 THEN CF=1
001BED E90C C9              10      RET
                                
       E90D                     _SYS5F:
001BEE E90D AF               4      XOR A
       E90E                     FFLUSH:
001BEF E90E F5              11      PUSH    AF
001BF0 E90F CD34E5          17      CALL    WTFATX
001BF3 E912 AF               4      XOR A
001BF4 E913 32ABF0          13      LD  (_FATIX),A
001BF7 E916 2F               4      CPL         ;0FFH
001BF8 E917 32AAF0          13      LD  (_FATDRV),A
001BFB E91A 3E                      DB  03EH        ;次のPUSH AFをスキップ
       E91B                     FFLUSHBUF:
001BFC E91B F5              11      PUSH    AF
001BFD E91C CDEAE4          17      CALL    DWTX
001C00 E91F 3EFF             7      LD  A,0FFH
001C02 E921 3239F0          13      LD  (SFILE),A
001C05 E924 32A5F0          13      LD  (_DBDRV),A
001C08 E927 F1              10      POP AF
001C09 E928 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MZ-700/1500
                                
       E929                     SEEK:
001C0A E929 0610             7      LD  B,16
001C0C E92B DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001C0F E92E AF               4      XOR A
001C10 E92F EB               4      EX  DE,HL
       E930                     DIV1:
001C11 E930 29              11      ADD HL,HL
001C12 E931 8F               4      ADC A,A
001C13 E932 B9               4      CP  C
001C14 E933 3802            12      JR  C,DIV2
001C16 E935 91               4      SUB C
001C17 E936 2C               4      INC L
       E937                     DIV2:
001C18 E937 10F7            13      DJNZ    DIV1
                                
001C1A E939 3C               4      INC A   ;最小のセクタは１固定
001C1B E93A 55               4      LD  D,L ;TRACK
001C1C E93B 5F               4      LD  E,A ;SECTOR
                                
001C1D E93C 3A84F0          13      LD  A,(_DRIVE)
001C20 E93F FE04             7      CP  4
001C22 E941 3F               4      CCF
001C23 E942 D8              11      RET C
001C24 E943 F684             7      OR  084H        ;Motor on + ドライブセレクト有効
001C26 E945 D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001C28 E947 CB3A             8      SRL D       ;CYLINDER
001C2A E949 9F               4      SBC A,A
001C2B E94A D3DD            11      OUT (0DDH),A    ;ヘッドセレクト制御レジスタ
                                
001C2D E94C CD84E9          17      CALL    SETMODE
001C30 E94F D8              11      RET C
                                
001C31 E950 CDB9E9          17      CALL    DRIVE
001C34 E953 FEFF             7      CP  0FFH        ;A=0FFH Unknown CYLINDER
001C36 E955 CC9BE9          17      CALL    Z,FDCRES    ;Restore
001C39 E958 2F               4      CPL         ;データバスが負論理
001C3A E959 D3D9            11      OUT (0D9H),A    ;MB8876 トラックレジスタ
001C3C E95B 2F               4      CPL         ;データバスが負論理
001C3D E95C 92               4      SUB D
001C3E E95D C8              11      RET Z       ;No seek
                                
001C3F E95E DD7E0C          19      LD  A,(IX+DPB_MAXCYL)
001C42 E961 3D               4      DEC A
001C43 E962 BA               4      CP  D       ;Over CYLINDER
001C44 E963 D8              11      RET C
                                
001C45 E964 7A               4      LD  A,D
001C46 E965 2F               4      CPL         ;データバスが負論理
001C47 E966 D3DB            11      OUT (0DBH),A    ;MB8876 データレジスタ
001C49 E968 72               7      LD  (HL),D
                                
001C4A E969 0E18             7      LD  C,018H      ;FDC TypeIコマンド Seek
       E96B                     FDCCMD2:
001C4C E96B 3A85F0          13      LD  A,(_SEEKSP)
001C4F E96E B1               4      OR  C
                                
       E96F                     FDCCMD:
001C50 E96F CDB0E9          17      CALL    COMSET
001C53 E972 3E80             7      LD  A,080H      ;FDC COMMAND(Self-modifying code)
       E973                     FDCSMC  EQU $-1
001C55 E974 E620             7      AND 020H        ;Write data Write track
001C57 E976 3C               4      INC A
                                
       E977                     SST:
001C58 E977 0E00             7      LD  C,0
       E979                     SST1:
001C5A E979 0D               4      DEC C       ; 4
001C5B E97A 20FD            12      JR  NZ,SST1     ;12 * 256 / 4 = About 1ms
001C5D E97C 3D               4      DEC A
001C5E E97D 20FA            12      JR  NZ,SST1
                                
001C60 E97F 0E01             7      LD  C,1
001C62 E981 CD89E9          17      CALL    READY
       E984                     SETMODE:
001C65 E984 CDB3E9          17      CALL    DELAY0      ;Head select time
001C68 E987 0E81             7      LD  C,081H
       E989                     READY:
001C6A E989 0680             7      LD  B,128
       E98B                     READY2:
001C6C E98B DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001C6E E98D 2F               4      CPL         ;データバスが負論理
001C6F E98E A1               4      AND C       ;NOT READY,BUSY
001C70 E98F C8              11      RET Z
001C71 E990 CD39CF          17      CALL    RD556VSYNC
001C74 E993 07               4      RLCA
001C75 E994 A8               4      XOR B
001C76 E995 0F               4      RRCA
001C77 E996 30F3            12      JR  NC,READY2
001C79 E998 10F1            13      DJNZ    READY2
001C7B E99A C9              10      RET
                                
       E99B                     FDCRES:
001C7C E99B 3600            10      LD  (HL),0
001C7E E99D 0E08             7      LD  C,8     ;FDC TypeIコマンド Restore
001C80 E99F 18CA            12      JR  FDCCMD2
                                
       E9A1                     FDMOFF:
001C82 E9A1 F5              11      PUSH    AF
001C83 E9A2 AF               4      XOR A       ;Motor off(ドライブセレクト無効)
001C84 E9A3 D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001C86 E9A5 F1              10      POP AF
001C87 E9A6 C9              10      RET
                                
       E9A7                     SECSET_FDCCMD:
001C88 E9A7 3A73E9          13      LD  A,(FDCSMC)
       E9AA                     SECSET:
001C8B E9AA F5              11      PUSH    AF
001C8C E9AB 7B               4      LD  A,E
001C8D E9AC 2F               4      CPL         ;データバスが負論理
001C8E E9AD D3DA            11      OUT (0DAH),A    ;MB8876 セクタレジスタ
001C90 E9AF F1              10      POP AF
       E9B0                     COMSET:
001C91 E9B0 2F               4      CPL         ;データバスが負論理
001C92 E9B1 D3D8            11      OUT (0D8H),A    ;MB8876 ステータス/コマンドレジスタ
       E9B3                     DELAY0:
001C94 E9B3 3E1A             7      LD  A,26
       E9B5                     DELAY:
001C96 E9B5 3D               4      DEC A
001C97 E9B6 20FD            12      JR  NZ,DELAY
001C99 E9B8 C9              10      RET
                                
       E9B9                     DRIVE:                  ;ドライブのシリンダを得る
001C9A E9B9 2A84F0          16      LD  HL,(_DRIVE)
001C9D E9BC 26F0             7      LD  H,_CYL0/256
001C9F E9BE CBFD             8      SET 7,L
001CA1 E9C0 7E               7      LD  A,(HL)
001CA2 E9C1 C9              10      RET
                                
       E9C2                     RNF:                    ;ドライブのシリンダをリセット
001CA3 E9C2 CDB9E9          17      CALL    DRIVE
001CA6 E9C5 36FF            10      LD  (HL),0FFH
001CA8 E9C7 C9              10      RET
                                
001CA9 E9C8 02                  RETRY:  DB  2
                                
                                
                                ;   FLOPPY DISK DRIVER
                                
       E9C9                     WTTRK:
001CAA E9C9 0601             7      LD  B,1
001CAC E9CB 3EF4             7      LD  A,0F4H      ;FDC TypeIIIコマンド Write Track
001CAE E9CD 1802            12      JR  WTTRK1
       E9CF                     FDWT:
001CB0 E9CF 3EA0             7      LD  A,0A0H      ;FDC TypeIIコマンド Write Sector
       E9D1                     WTTRK1:
001CB2 E9D1 3273E9          13      LD  (FDCSMC),A
       E9D4                     DWTBL:
001CB5 E9D4 78               4      LD  A,B
001CB6 E9D5 3211EA          13      LD  (WTBSMC),A
001CB9 E9D8 3E02             7      LD  A,2     ;Retry count
001CBB E9DA 32C8E9          13      LD  (RETRY),A
                                
       E9DD                     DWT0:
001CBE E9DD D5              11      PUSH    DE
001CBF E9DE E5              11      PUSH    HL
001CC0 E9DF CD29E9          17      CALL    SEEK        ;Write disk
001CC3 E9E2 E1              10      POP HL
001CC4 E9E3 3837            12      JR  C,ERRDW
001CC6 E9E5 F3               4      DI
001CC7 E9E6 CDA7E9          17      CALL    SECSET_FDCCMD
001CCA E9E9 0EDB             7      LD  C,0DBH      ;MB8876 データレジスタ
       E9EB                     DWT1:
001CCC E9EB 7E               7      LD  A,(HL)
001CCD E9EC 2F               4      CPL         ;データバスが負論理
001CCE E9ED 57               4      LD  D,A
                                
       E9EE                     DWT2:
001CCF E9EE DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001CD1 E9F0 2F               4      CPL         ;データバスが負論理
001CD2 E9F1 0F               4      RRCA
001CD3 E9F2 3008            12      JR  NC,DWT4
001CD5 E9F4 0F               4      RRCA
001CD6 E9F5 30F7            12      JR  NC,DWT2
       E9F7                     DWT3:
001CD8 E9F7 ED51            12      OUT (C),D       ;MB8876 データレジスタ
001CDA E9F9 23               6      INC HL
001CDB E9FA 18EF            12      JR  DWT1
                                
       E9FC                     DWT4:
001CDD E9FC 3D               4      DEC A
001CDE E9FD 28F8            12      JR  Z,DWT3
001CE0 E9FF 3C               4      INC A
001CE1 EA00 FB               4      EI
001CE2 EA01 D1              10      POP DE
001CE3 EA02 13               6      INC DE
001CE4 EA03 CDA1E9          17      CALL    FDMOFF
001CE7 EA06 2808            12      JR  Z,DISKOK_WT
001CE9 EA08 CD70EA          17      CALL    DISKC
001CEC EA0B 20D0            12      JR  NZ,DWT0
001CEE EA0D B7               4      OR  A
001CEF EA0E 2005            12      JR  NZ,ERRW
                                
       EA10                     DISKOK_WT:
001CF1 EA10 0601             7      LD  B,1
       EA11                     WTBSMC  EQU $-1
001CF3 EA12 10C0            13      DJNZ    DWTBL
001CF5 EA14 C9              10      RET
                                
       EA15                     ERRW:
001CF6 EA15 3EFF             7      LD  A,0FFH
       EA17                     ERRZ:
001CF8 EA17 BF               4      CP  A       ;ZF=1
001CF9 EA18 37               4      SCF
001CFA EA19 C3A1E9          10      JP  FDMOFF
                                
       EA1C                     ERRDW:
001CFD EA1C D1              10      POP DE
001CFE EA1D CD81EA          17      CALL    DELP
001D01 EA20 20BB            12      JR  NZ,DWT0
001D03 EA22 B7               4      OR  A
001D04 EA23 20F0            12      JR  NZ,ERRW
001D06 EA25 C9              10      RET
                                
       EA26                     FDRD:
001D07 EA26 3E80             7      LD  A,080H      ;FDC TypeIIコマンド Read Sector
001D09 EA28 3273E9          13      LD  (FDCSMC),A
       EA2B                     DRDBL:
001D0C EA2B 78               4      LD  A,B
001D0D EA2C 3262EA          13      LD  (RDBSMC),A
001D10 EA2F 3E02             7      LD  A,2     ;Retry count
001D12 EA31 32C8E9          13      LD  (RETRY),A
       EA34                     DRD0:
001D15 EA34 D5              11      PUSH    DE
001D16 EA35 E5              11      PUSH    HL
001D17 EA36 CD29E9          17      CALL    SEEK        ;Read disk
001D1A EA39 E1              10      POP HL
001D1B EA3A 382A            12      JR  C,ERRDR
001D1D EA3C F3               4      DI
001D1E EA3D CDA7E9          17      CALL    SECSET_FDCCMD
       EA40                     DRD1:
001D21 EA40 DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001D23 EA42 2F               4      CPL         ;データバスが負論理
001D24 EA43 0F               4      RRCA
001D25 EA44 300A            12      JR  NC,DRD3
001D27 EA46 0F               4      RRCA
001D28 EA47 30F7            12      JR  NC,DRD1
001D2A EA49 DBDB            11      IN  A,(0DBH)    ;MB8876 データレジスタ
001D2C EA4B 2F               4      CPL         ;データバスが負論理
001D2D EA4C 77               7      LD  (HL),A
001D2E EA4D 23               6      INC HL
001D2F EA4E 18F0            12      JR  DRD1
                                
       EA50                     DRD3:
001D31 EA50 B7               4      OR  A
001D32 EA51 FB               4      EI
001D33 EA52 D1              10      POP DE
001D34 EA53 13               6      INC DE
001D35 EA54 CDA1E9          17      CALL    FDMOFF
001D38 EA57 2808            12      JR  Z,DISKOK_RD
001D3A EA59 CD70EA          17      CALL    DISKC
001D3D EA5C 20D6            12      JR  NZ,DRD0
001D3F EA5E B7               4      OR  A
001D40 EA5F 20B4            12      JR  NZ,ERRW
                                
       EA61                     DISKOK_RD:
001D42 EA61 0601             7      LD  B,1
       EA62                     RDBSMC  EQU $-1
001D44 EA63 10C6            13      DJNZ    DRDBL
001D46 EA65 C9              10      RET
                                
       EA66                     ERRDR:
001D47 EA66 D1              10      POP DE
001D48 EA67 CD81EA          17      CALL    DELP
001D4B EA6A 20C8            12      JR  NZ,DRD0
001D4D EA6C B7               4      OR  A
001D4E EA6D 20A6            12      JR  NZ,ERRW
001D50 EA6F C9              10      RET
       EA70                     DISKC:
001D51 EA70 1B               6      DEC DE
001D52 EA71 CB5F             8      BIT 3,A
001D54 EA73 C4C2E9          17      CALL    NZ,RNF
       EA76                     DISKD:
001D57 EA76 E5              11      PUSH    HL
001D58 EA77 21C8E9          10      LD  HL,RETRY
001D5B EA7A 35              11      DEC (HL)
001D5C EA7B E1              10      POP HL
001D5D EA7C 200C            12      JR  NZ,ERR      ;Retry
001D5F EA7E B7               4      OR  A
001D60 EA7F 2809            12      JR  Z,ERR       ;Error
                                
       EA81                     DELP:
001D62 EA81 CDC2E9          17      CALL    RNF
001D65 EA84 CDA1E9          17      CALL    FDMOFF
001D68 EA87 3EFF             7      LD  A,0FFH
       EA89                     AERRZ:
001D6A EA89 BF               4      CP  A
       EA8A                     ERR:
001D6B EA8A 3EFF             7      LD  A,0FFH
001D6D EA8C C9              10      RET
[EOF:M7DISK.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MZ-700/1500
                                
                                ;   EMM DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       EA8D                     EDWT:
001D6E EA8D F5              11      PUSH    AF
001D6F EA8E CDACEA          17      CALL    EADR
001D72 EA91 0600             7      LD  B,0
       EA93                     EDWT1:
001D74 EA93 EDB3                    OTIR
001D76 EA95 3D               4      DEC A
001D77 EA96 20FB            12      JR  NZ,EDWT1
001D79 EA98 180B            12      JR  EDRW1
                                
       EA9A                     EDRD:
001D7B EA9A C5              11      PUSH    BC
001D7C EA9B CDACEA          17      CALL    EADR
001D7F EA9E 0600             7      LD  B,0
       EAA0                     EDRD1:
001D81 EAA0 EDB2                    INIR
001D83 EAA2 3D               4      DEC A
001D84 EAA3 20FB            12      JR  NZ,EDRD1
       EAA5                     EDRW1:
001D86 EAA5 F1              10      POP AF
001D87 EAA6 83               4      ADD A,E ;セクタを進める
001D88 EAA7 5F               4      LD  E,A
001D89 EAA8 8A               4      ADC A,D
001D8A EAA9 93               4      SUB E
001D8B EAAA 57               4      LD  D,A
001D8C EAAB C9              10      RET
                                
       EAAC                     EADR:
001D8D EAAC D5              11      PUSH    DE
001D8E EAAD EB               4      EX  DE,HL
001D8F EAAE 78               4      LD  A,B
001D90 EAAF DD460F          19      LD  B,(IX+DPB_BPS)
       EAB2                     EADR1:              ;読み込むセクタ数と1クラスタのセクタ数を掛ける
001D93 EAB2 CB18             8      RR  B
001D95 EAB4 3804            12      JR  C,EADR2
001D97 EAB6 87               4      ADD A,A
001D98 EAB7 29              11      ADD HL,HL
001D99 EAB8 18F8            12      JR  EADR1
       EABA                     EADR2:
001D9B EABA DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001D9E EABD DD460C          19      LD  B,(IX+DPB_MAXCYL)
001DA1 EAC0 09              11      ADD HL,BC
001DA2 EAC1 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001DA5 EAC4 ED71            12      OUT (C),0       ;Z80未定義命令
001DA7 EAC6 0C               4      INC C
001DA8 EAC7 ED69            12      OUT (C),L
001DAA EAC9 0C               4      INC C
001DAB EACA ED61            12      OUT (C),H
001DAD EACC 0C               4      INC C
001DAE EACD EB               4      EX  DE,HL
001DAF EACE D1              10      POP DE
001DB0 EACF C9              10      RET
                                
                                ;   CMOS BACKUP MEMORY DRIVER(32KB)
                                ;   1セクタ256
                                
       EAD0                     CDWT:
001DB1 EAD0 78               4      LD  A,B
001DB2 EAD1 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001DB5 EAD4 ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001DB7 EAD6 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001DB9 EAD8 01FA00          10      LD  BC,000FAH
       EADB                     CDWT1:
001DBC EADB EDB3                    OTIR            ;W)データ書き込み・アドレスカウンタ+1
001DBE EADD 13               6      INC DE
001DBF EADE 3D               4      DEC A
001DC0 EADF 20FA            12      JR  NZ,CDWT1
001DC2 EAE1 A7               4      AND A
001DC3 EAE2 C9              10      RET
                                
       EAE3                     CDRD:
001DC4 EAE3 78               4      LD  A,B
001DC5 EAE4 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001DC8 EAE7 ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001DCA EAE9 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001DCC EAEB 01F900          10      LD  BC,000F9H
       EAEE                     CDRD1:
001DCF EAEE EDB2                    INIR            ;R)データ読み出し・アドレスカウンタ+1
001DD1 EAF0 13               6      INC DE
001DD2 EAF1 3D               4      DEC A
001DD3 EAF2 20FA            12      JR  NZ,CDRD1
001DD5 EAF4 A7               4      AND A
001DD6 EAF5 C9              10      RET
                                
                                ;   RAM DISK DRIVER (64KB)
                                ;   1セクタ256
                                
       EAF6                     RDWT:
001DD7 EAF6 3EB3             7      LD  A,0B3H      ;OTIR
001DD9 EAF8 1802            12      JR  RDRW
       EAFA                     RDRD:
001DDB EAFA 3EB2             7      LD  A,0B2H      ;INIR
       EAFC                     RDRW:
001DDD EAFC 3209EB          13      LD  (RDRW_SWC),A
                                
001DE0 EAFF 78               4      LD  A,B
001DE1 EB00 43               4      LD  B,E     ;B=アドレスカウンタ上位(X1の様な16bitのI/Oアクセス)
001DE2 EB01 0EEB             7      LD  C,0EBH
001DE4 EB03 ED71            12      OUT (C),0       ;0=アドレスカウンタ下位
001DE6 EB05 0D               4      DEC C       ;EA(R)データ読み出し・アドレスカウンタ+1
001DE7 EB06 0600             7      LD  B,0
       EB08                     RDRW1:
001DE9 EB08 EDB2                    INIR            ;自己書き換え(INIR/OTIR)
       EB09                     RDRW_SWC    EQU $-1
001DEB EB0A 13               6      INC DE
001DEC EB0B 3D               4      DEC A
001DED EB0C 20FA            12      JR  NZ,RDRW1
001DEF EB0E A7               4      AND A
001DF0 EB0F C9              10      RET
                                
                                ;   G-RAM(PCG) DISK DRIVER (24KB)
                                ;   1セクタ256
                                
       EB10                     GDWT:
001DF1 EB10 C5              11      PUSH    BC
001DF2 EB11 D5              11      PUSH    DE
001DF3 EB12 CD3AEB          17      CALL    GADR
       EB15                     GDWT2:
001DF6 EB15 4E               7      LD  C,(HL)
001DF7 EB16 23               6      INC HL
001DF8 EB17 EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001DF9 EB18 CDC0CF          17      CALL    WR_PCG
001DFC EB1B 23               6      INC HL
001DFD EB1C EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001DFE EB1D 10F6            13      DJNZ    GDWT2
001E00 EB1F D1              10      POP DE
001E01 EB20 1C               4      INC E
001E02 EB21 C1              10      POP BC
001E03 EB22 10EC            13      DJNZ    GDWT
001E05 EB24 C9              10      RET
       EB25                     GDRD:
001E06 EB25 C5              11      PUSH    BC
001E07 EB26 D5              11      PUSH    DE
001E08 EB27 CD3AEB          17      CALL    GADR
       EB2A                     GDRD2:
001E0B EB2A EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001E0C EB2B CDB8CF          17      CALL    RD_PCG
001E0F EB2E 23               6      INC HL
001E10 EB2F EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001E11 EB30 71               7      LD  (HL),C
001E12 EB31 23               6      INC HL
001E13 EB32 10F6            13      DJNZ    GDRD2
001E15 EB34 D1              10      POP DE
001E16 EB35 1C               4      INC E
001E17 EB36 C1              10      POP BC
001E18 EB37 10EC            13      DJNZ    GDRD
001E1A EB39 C9              10      RET
                                
       EB3A                     GADR:
001E1B EB3A 7B               4      LD  A,E
001E1C EB3B E61F             7      AND 01FH
001E1E EB3D C6D0             7      ADD A,0D0H
001E20 EB3F 57               4      LD  D,A
001E21 EB40 7B               4      LD  A,E
001E22 EB41 07               4      RLCA
001E23 EB42 07               4      RLCA
001E24 EB43 07               4      RLCA
001E25 EB44 3C               4      INC A
001E26 EB45 0600             7      LD  B,0
001E28 EB47 58               4      LD  E,B
001E29 EB48 C9              10      RET
[EOF:M7DISK2.ASM:UTF_8]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001E2A EB49                     PATHD:  DS  PATHX
001E65 EB84 00                  PATHE:  DB  0
                                
       EB85                     DTA_CCP:
001E66 EB85                         DS  37
                                
       EBAA                     FCB_BAT:
001E8B EBAA                         DS  37
                                
001EB0 EBCF 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001EBB EBDA 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "M7TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE 表示関連のテーブル
                                ;   MZ-700/1500
                                
       EBE1                     AT_TABLE:
001EC2 EBE1                         DS  TABLEAD-AT_TABLE
                                
       ED40                     KEY_TABLE:
002021 ED40 12081E1F1C1D5C2F        DB  12H,08H,1EH,1FH,1CH,1DH,5CH,'/'
002029 ED48 5C5E2D2030392C2E        DB  5CH,'^','-',20H,'0','9',',','.'
002031 ED50 3132333435363738        DB  '1','2','3','4','5','6','7','8'
002039 ED58 6162636465666768        DB  'a','b','c','d','e','f','g','h'
002041 ED60 696A6B6C6D6E6F70        DB  'i','j','k','l','m','n','o','p'
002049 ED68 7172737475767778        DB  'q','r','s','t','u','v','w','x'
002051 ED70 797A405B5D000000        DB  'y','z','@','[',']',00H,00H,00H
002059 ED78 001B3D09003B3A0D        DB  00H,1BH,'=',09H,00H,';',':',0DH
       ED80                     SHIFT_TABLE:
002061 ED80 12081E1F1C1D5F3F        DB  12H,08H,1EH,1FH,1CH,1DH,'_','?'
002069 ED88 7C7E3D2030293C3E        DB  '|','~','=',20H,'0',')','<','>'
002071 ED90 2122232425262728        DB  '!','"','#','$','%','&',27H,'('
002079 ED98 4142434445464748        DB  'A','B','C','D','E','F','G','H'
002081 EDA0 494A4B4C4D4E4F50        DB  'I','J','K','L','M','N','O','P'
002089 EDA8 5152535455565758        DB  'Q','R','S','T','U','V','W','X'
002091 EDB0 595A607B7D000000        DB  'Y','Z','`','{','}',00H,00H,00H
002099 EDB8 00003D09002B2A0D        DB  00H,00H,'=',09H,00H,'+','*',0DH
       EDC0                     CTRL_TABLE:
0020A1 EDC0 12081E1F1C1D3F2F        DB  12H,08H,1EH,1FH,1CH,1DH,'?','/'
0020A9 EDC8 2A2B2D2030392C2E        DB  '*','+','-',20H,'0','9',',','.'
0020B1 EDD0 3132333435363738        DB  '1','2','3','4','5','6','7','8'
0020B9 EDD8 0102030405060708        DB  01H,02H,03H,04H,05H,06H,07H,08H
0020C1 EDE0 090A0B0C0D0E0F10        DB  09H,0AH,0BH,0CH,0DH,0EH,0FH,10H
0020C9 EDE8 1112131415161718        DB  11H,12H,13H,14H,15H,16H,17H,18H
0020D1 EDF0 191A1B5B5D000000        DB  19H,1AH,1BH,'[',']',00H,00H,00H
0020D9 EDF8 00003D09003B3A0D        DB  00H,00H,'=',09H,00H,';',':',0DH
                                
                                ;   アドレス下位1バイトが0になるように
       EE00                     CD_TABLE:
0020E1 EE00 00D1D2D3D4D5D6D0        DB  $00,$D1,$D2,$D3,$D4,$D5,$D6,$D0 ;月火水木金土日
0020E9 EE08 D8DCD9DADBD7CFCE        DB  $D8,$DC,$D9,$DA,$DB,$D7,$CF,$CE ;年円時分秒
0020F1 EE10 601F5F5E1E1B7978        DB  $60,$1F,$5F,$5E,$1E,$1B,$79,$78 ;
0020F9 EE18 5C5D1C1D6DCACDC7        DB  $5C,$5D,$1C,$1D,$6D,$CA,$CD,$C7 ;
002101 EE20 0061626364656667        DB  $00,$61,$62,$63,$64,$65,$66,$67 ; !"#$%&'
002109 EE28 68696B6A2F2A2E2D        DB  $68,$69,$6B,$6A,$2F,$2A,$2E,$2D ;()*+,-./
002111 EE30 2021222324252627        DB  $20,$21,$22,$23,$24,$25,$26,$27 ;01234567
002119 EE38 28294F2C512B5749        DB  $28,$29,$4F,$2C,$51,$2B,$57,$49 ;89:;<=>?
002121 EE40 5501020304050607        DB  $55,$01,$02,$03,$04,$05,$06,$07 ;@ABCDEFG
002129 EE48 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;HIJKLMNO
002131 EE50 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;PQRSTUVW
002139 EE58 18191A52DD54E37C        DB  $18,$19,$1A,$52,$DD,$54,$E3,$7C ;XYZ[\]^_
002141 EE60 5901020304050607        DB  $59,$01,$02,$03,$04,$05,$06,$07 ;`abcdefg   ATB:1
002149 EE68 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;hijklmno   ATB:1
002151 EE70 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;pqrstuvw   ATB:1
002159 EE78 18191ACB35CC705A        DB  $18,$19,$1A,$CB,$35,$CC,$70,$5A ;xyz{|}~    ATB:1
002161 EE80 415346444847B49E        DB  $41,$53,$46,$44,$48,$47,$B4,$9E ;トランプ〇●をぁ   ATB:1
002169 EE88 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ぃぅぇぉゃゅょっ   ATB:1
002171 EE90 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーあいうえおかき   ATB:1
002179 EE98 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;くけこさしすせそ   ATB:1
002181 EEA0 F0BD9DB1B5B9B49E        DB  $F0,$BD,$9D,$B1,$B5,$B9,$B4,$9E ;　。「」、・ヲァ
002189 EEA8 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ィゥェォャョュッ
002191 EEB0 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーアイウエオカキ
002199 EEB8 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;クケコサシスセソ
0021A1 EEC0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;タチツテトナニヌ
0021A9 EEC8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ネノハヒフヘホマ
0021B1 EED0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;ミムメモヤユヨラ
0021B9 EED8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;リルレロワン゛゜
0021C1 EEE0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;たちつてとねにぬ   ATB:1
0021C9 EEE8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ねのはひふへほま   ATB:1
0021D1 EEF0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;みむめもやゆよら   ATB:1
0021D9 EEF8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;りるれろわん゛゜   ATB:1
       EF00                     DC_TABLE:
0021E1 EF00 2041424344454647        DB  $20,$41,$42,$43,$44,$45,$46,$47 ;0
0021E9 EF08 48494A4B4C4D4E4F        DB  $48,$49,$4A,$4B,$4C,$4D,$4E,$4F
0021F1 EF10 5051525354555657        DB  $50,$51,$52,$53,$54,$55,$56,$57 ;1
0021F9 EF18 58595A151A1B1411        DB  $58,$59,$5A,$15,$1A,$1B,$14,$11
002201 EF20 3031323334353637        DB  $30,$31,$32,$33,$34,$35,$36,$37 ;2
002209 EF28 38392D3D3B2F2E2C        DB  $38,$39,$2D,$3D,$3B,$2F,$2E,$2C
002211 EF30 00000000007C0000        DB  $00,$00,$00,$00,$00,$7C,$00,$00 ;3
002219 EF38 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
002221 EF40 0080000083008285        DB  $00,$80,$00,$00,$83,$00,$82,$85 ;4
002229 EF48 843F00000000003A        DB  $84,$3F,$00,$00,$00,$00,$00,$3A
002231 EF50 5E3C5B815D40003E        DB  $5E,$3C,$5B,$81,$5D,$40,$00,$3E ;5
002239 EF58 00607F0018191312        DB  $00,$60,$7F,$00,$18,$19,$13,$12
002241 EF60 1021222324252627        DB  $10,$21,$22,$23,$24,$25,$26,$27 ;6
002249 EF68 28292B2A001C0000        DB  $28,$29,$2B,$2A,$00,$1C,$00,$00
002251 EF70 7E00000000000000        DB  $7E,$00,$00,$00,$00,$00,$00,$00 ;7
002259 EF78 171600005F000000        DB  $17,$16,$00,$00,$5F,$00,$00,$00
002261 EF80 00C19A9F9C92CA97        DB  $00,$C1,$9A,$9F,$9C,$92,$CA,$97 ;8
002269 EF88 98C6CFC9D8D3D0D7        DB  $98,$C6,$CF,$C9,$D8,$D3,$D0,$D7
002271 EF90 9EC09DC496C5CBC3        DB  $9E,$C0,$9D,$C4,$96,$C5,$CB,$C3 ;9
002279 EF98 9BDDC2DB99A2878C        DB  $9B,$DD,$C2,$DB,$99,$A2,$87,$8C
002281 EFA0 DCC7CC91939495D4        DB  $DC,$C7,$CC,$91,$93,$94,$95,$D4 ;A
002289 EFA8 D5D6CECDDAD2D9C8        DB  $D5,$D6,$CE,$CD,$DA,$D2,$D9,$C8
002291 EFB0 D1A3888D86A4898E        DB  $D1,$A3,$88,$8D,$86,$A4,$89,$8E ;B
002299 EFB8 DFA58A8FDEA18B90        DB  $DF,$A5,$8A,$8F,$DE,$A1,$8B,$90
0022A1 EFC0 000000000000001F        DB  $00,$00,$00,$00,$00,$00,$00,$1F ;C
0022A9 EFC8 00001D7B7D1E0F0E        DB  $00,$00,$1D,$7B,$7D,$1E,$0F,$0E
0022B1 EFD0 070102030405060D        DB  $07,$01,$02,$03,$04,$05,$06,$0D ;D
0022B9 EFD8 080A0B0C095C0000        DB  $08,$0A,$0B,$0C,$09,$5C,$00,$00
0022C1 EFE0 0000005E00000000        DB  $00,$00,$00,$5E,$00,$00,$00,$00 ;E
0022C9 EFE8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
0022D1 EFF0 A000000000000000        DB  $A0,$00,$00,$00,$00,$00,$00,$00 ;F
0022D9 EFF8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
[EOF:M7TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
                                ;   ALIGN   256
       F000                     AT_WORK:
0022E1 F000                         DS  WORKAD-AT_WORK
                                
       F000                     CPM_BOOT:
0022E1 F000 C30000          10      JP  0
       F003                     _SYS00:     ;(BDOS)プログラム終了
       F003                     CPM_WBOOT:
0022E4 F003 C3FECF          10      JP  WBOOT1
       F006                     CPM_CONST:
0022E7 F006 C30FD8          10      JP  CONSTX
       F009                     _SYS07:     ;(BDOS)コンソール直接入力
       F009                     CPM_CONIN:
0022EA F009 C3A8D7          10      JP  FLGET
       F00C                     CPM_CONOUT:
0022ED F00C C3B3D9          10      JP  CONOUT1
                                
       F00F                     DECBF:              ;10進数表示時のバッファ(5バイト)
0022F0 F00F                         DS  5
       F00F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       F011                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       F014                     FDRV:
0022F5 F014 00                      DB  0
       F015                     FNAME:
0022F6 F015                         DS  36
       F039                     SFILE:
00231A F039                         DS  33      ;DRV FILENAME
       F05A                     _DISKE:
00233B F05A C312D7          10      JP  SHOW_ERROR
                                
00233E F05D 0000                LEFTX:  DW  0
002340 F05F 0000                DTAX:   DW  0
                                
                                ;   PSGのビープ音のデータ(X1)
       F061                     BEEPD:
002342 F061 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
00234A F069 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                ;
       F062                     RTC_YY  EQU BEEPD+1 ;RTCのバッファ年(88)
       F063                     RTC_MW  EQU BEEPD+2 ;RTCのバッファ月(88)
       F064                     RTC_DD  EQU BEEPD+3 ;RTCのバッファ日(88)
       F065                     RTC_TT  EQU BEEPD+4 ;RTCのバッファ時(88)
       F066                     RTC_MM  EQU BEEPD+5 ;RTCのバッファ分(88)
       F067                     RTC_SS  EQU BEEPD+6 ;RTCのバッファ秒(88)
       F062                     ROM_SLT EQU BEEPD+1 ;ROMのスロット(MSX)
       F061                     ZERO    EQU BEEPD
                                
       F070                     CHECK:
002351 F070 00                      DB  0
                                
       F071                     OK:
002352 F071 4F4B24                  DB  "OK$"
002355 F074                         DS  5
       F079                     COMERM:
00235A F079 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       F080                     _CYL0:
002361 F080 FF                      DB  0FFH    ;Cylinder
       F081                     _CYL1:
002362 F081 FF                      DB  0FFH    ;Cylinder
       F082                     _CYL2:
002363 F082 FF                      DB  0FFH    ;Cylinder
       F083                     _CYL3:
002364 F083 FF                      DB  0FFH    ;Cylinder
       F084                     _DRIVE:
002365 F084 00                      DB  0   ;unit number
       F085                     _SEEKSP:
002366 F085 00                      DB  0   ;Seek speed
       F086                     _ISEEK:
002367 F086 32                      DB  50  ;
002368 F087                         DS  1
       F088                     _DRV:
002369 F088 00                      DB  0
       F089                     _DSK:
00236A F089 FF                      DB  0FFH
       F08A                     _DTA:
00236B F08A 8000                    DW  00080H
       F08C                     _CTC:
00236D F08C 0000                    DW  0
       F08E                     _TXADR:
00236F F08E 0000                    DW  0
       F090                     _KEYPS:
002371 F090 0000                    DW  0
       F092                     _KEYD:
002373 F092 00                      DB  000H    ;キーデータ
       F093                     _KEYST:
002374 F093 FF                      DB  0FFH    ;キーステータス(SHIFT,CTRLの状態)
       F094                     _KEYSP_L:
002375 F094 83                      DB  KEYSP_L ;オートリピートの速度
       F095                     _KEYSP_H:
002376 F095 14                      DB  KEYSP_H ;オートリピートの速度
       F096                     _COLORF:
002377 F096 70                      DB  COLORF  ;色
       F097                     _LINE:
002378 F097 19                      DB  LINE
                                
                                            ;次のファイルの検索(C=12)で使用するFCB
       F098                     _FCB:
002379 F098 0000                    DW  0   ;SEARCH FILES
       F09A                     _FBPS:
00237B F09A 0000                    DW  0   ;    //
       F09C                     _FBAD:
00237D F09C 0000                    DW  0   ;    //
       F09E                     _FBCNT:
00237F F09E 00                      DB  0   ;    //
       F09F                     _FILEN:
002380 F09F 00                      DB  0   ;    //
       F0A0                     _DIRF:
002381 F0A0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
002382 F0A1                         DS  1
       F0A2                     _WTFATF:
002383 F0A2 00                      DB  0   ;FATバッファの更新フラグ
002384 F0A3                         DS  1
       F0A4                     _WTDBF:
002385 F0A4 00                      DB  0   ;データバッファの更新フラグ
       F0A5                     _DBDRV:
002386 F0A5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       F0A6                     _DBSEC:
002387 F0A6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       F0A8                     _DPB:
002389 F0A8 0000                    DW  0
       F0AA                     _FATDRV:
00238B F0AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       F0AB                     _FATIX:
00238C F0AB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       F0AC                     _FAKEFREE:
00238D F0AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
00238F F0AE                         DS  2
                                ;   画面周りのデータ
       F0B0                     CRTCD:
002391 F0B0 6F                      DB  06FH
       F0B1                     _WIDTH:
002392 F0B1 28                      DB  WIDTH
       F0B2                     TVRAMTOP:
002393 F0B2 5938                    DB  059H,038H
002395 F0B4 1F02                    DB  01FH,002H
       F0B6                     _LINE2:
002397 F0B6 19                      DB  019H
       F0B7                     WKE4:
002398 F0B7 1C                      DB  01CH
       F0B8                     WKE6:
002399 F0B8 00                      DB  000H
       F0B9                     WK40:
00239A F0B9 07                      DB  007H
       F0BA                     _PAGE_MINUS:
00239B F0BA 18FC                    DW  0-WIDTH*LINE
       F0BC                     _WIDTH_MINUS:
00239D F0BC D8FF                    DW  0-WIDTH
       F0BE                     WK30:
00239F F0BE 0C                      DB  00CH
       F0BF                     WK31:
       F0BF                     WK1FD0:
0023A0 F0BF 20                      DB  020H
                                
                                ;   割り込みベクタ(X1)
0023A1 F0C0 0000                CTC0:   DW  INTCTCE
0023A3 F0C2 0000                CTC1:   DW  INTCTCE
0023A5 F0C4 0000                CTC2:   DW  INTCTCE
0023A7 F0C6 0000                CTC3:   DW  INTCTCE
0023A9 F0C8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
0023AB F0CA C31CDB          10  _INKEY: JP  INKEY
0023AE F0CD C39AD8          10  _PRINT: JP  PRINT
0023B1 F0D0 C384DB          10  _SCRN:  JP  SCRN
0023B4 F0D3 C36DDA          10  _POS:   JP  POS
0023B7 F0D6 C381D9          10  _LOC:   JP  LOC
       F0D9                     _CHGDRV:
0023BA F0D9 C332E8          10      JP  CHGDRV
       F0DC                     _GETDPB:
0023BD F0DC C3F0E8          10      JP  GETDPB
       F0DF                     _FFLUSH:
0023C0 F0DF C30EE9          10      JP  FFLUSH
       F0E2                     _RDFATX:
0023C3 F0E2 C30AE5          10      JP  RDFATX
0023C6 F0E5 C33CE6          10  _RDFAT: JP  RDFAT
0023C9 F0E8 C3C9E9          10  _WTTRK: JP  WTTRK
0023CC F0EB C326EA          10  _FDRD:  JP  FDRD
0023CF F0EE C3CFE9          10  _FDWT:  JP  FDWT
       F0F1                     _BPB2DPB:
0023D2 F0F1 C3D4E6          10      JP  BPB2DPB
       F0F4                     _BREAK:
0023D5 F0F4 C396D1          10      JP  END_BATCH
       F0F7                     _GNCL:
0023D8 F0F7 C3B6E5          10      JP  GNCL        ; self-modifying code
       F0F8                     GNCPAT  EQU $-2
       F0FA                     _SNCL:
0023DB F0FA C3D9E5          10      JP  SNCL        ; self-modifying code
       F0FB                     SNCPAT  EQU $-2
       F0FD                     _COMANL:
0023DE F0FD C34FD0          10      JP  COMANL
                                
       F100                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F100                     STABLE:
                                ;0
0023E1 F100 03F07BD787D774DD        DW  _SYS00,_SYS01,_SYS02,_SYS03
0023E9 F108 7DD47DD48CD709F0        DW  _SYS04,_SYS05,_SYS06,_SYS07
0023F1 F110 94D77FD4DED70AD8        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
0023F9 F118 94D499D4A8D4B9D4        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
002401 F120 0DD554D59DD5CED5        DW  _SYS10,_SYS11,_SYS12,_SYS13
002409 F128 D6D5ECD501D6F9D5        DW  _SYS14,_SYS15,_SYS16,_SYS17
002411 F130 48D64DD652D658D6        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
002419 F138 7DD47ED67DD482D6        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
002421 F140 7DD438D640D689D6        DW  _SYS20,_SYS21,_SYS22,_SYS23
002429 F148 AED67DD4CAE198E2        DW  _SYS24,_ERROR,_SYS26,_SYS27
002431 F150 40D6B8D61DD874DD        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
002439 F158 1DD874DD7DD4D9D6        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
002441 F160 D3D67DD47DD47DD4        DW  _SYS30,_ERROR,_ERROR,_ERROR
002449 F168 7DD47DD47DD47DD4        DW  _ERROR,_ERROR,_ERROR,_ERROR
002451 F170 7DD474DD74DDFAD6        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
002459 F178 60D4                    DW  _DOS2
                                
00245B F17A                         DS  1
       F17B                     _MAX_SEC_SZ_H:
00245C F17B 04                      DB  MAX_SEC_SZ_H
                                
                                ;   FATバッファのアドレス
       F17C                     _FATBF:
00245D F17C 30F3                    DW  FATBF
                                
                                ;   データバッファのアドレス
       F17E                     _DTBUF:
00245F F17E 30FB                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F180                     CTRLTB:
002461 F180 FFD8FFD835D940DA        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
002469 F188 3ADA66D92ADAC3D9        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002471 F190 0BD926D943DA94D9        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
002479 F198 27DA7CD955DAFFD8        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
002481 F1A0 FFD8FFD88CD9FFD8        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
002489 F1A8 FFD8FFD8FFD8FFD8        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
002491 F1B0 FFD8FFD827DA9BD9        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
002499 F1B8 EED812D91BD943DA        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
                                ;   2D/2DDでBPBがない場合のデフォルト値(2D/360KB/9セクタ1024バイト)
0024A1 F1C0 0200                M2D:    DW  2
0024A3 F1C2 FD02                    DB  0FDH,2
0024A5 F1C4 6401                    DW  356
0024A7 F1C6 FF0728090182            DB  0FFH,7,40,9,1,082H
0024AD F1CC 0500A7000800            DW  5,0A7H,8
                                
                                ;   2HDでBPBがない場合のデフォルト値(2HD/1.23MB/8セクタ1024バイト)
0024B3 F1D2 0200                M2HD:   DW  2
0024B5 F1D4 FE01                    DB  0FEH,1
0024B7 F1D6 C704                    DW  1223
0024B9 F1D8 FE064D080184            DB  0FEH,6,77,8,1,084H
0024BF F1DE 0500A7000900            DW  5,0A7H,9
                                
                                ;   ディレクトリエントリとFCBの変換テーブル(日付+時刻+サイズ)
0024C5 F1E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
0024C7 F1E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
0024C9 F1E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
0024CB F1EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F1EE                     SDDATAE:
                                
0024CF F1EE                         DS  2
                                
                                ;   バッチファイルのFCB
       F1F0                     _FCB_BAT:
0024D1 F1F0 AAEB                    DW  FCB_BAT
       F1F2                     _PATH:
0024D3 F1F2 49EB                    DW  PATHD
                                
0024D5 F1F4                     SCDIR:  DS  2       ;+14 +15
0024D7 F1F6                     SFBPS:  DS  2       ;FBPS
0024D9 F1F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
0024DB F1FA 0000                _FATPS: DW  0
0024DD F1FC 0000                _DIRPS: DW  0
0024DF F1FE 0000                _CLPS:  DW  0
                                
       F200                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "M7DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MZ-700/1500
                                
       F200                     _DEVICE:
                                
                                ;   A:
                                
0024E1 F200 0200                    DW  2   ;DPB_FATLN
0024E3 F202 EBF0                    DW  _FDRD   ;DPB_DRD
0024E5 F204 EEF0                    DW  _FDWT   ;DPB_DWT
0024E7 F206 FD                      DB  0FDH    ;DPB_FATID
0024E8 F207 02                      DB  2   ;DPB_SECPCL
0024E9 F208 6401                    DW  356 ;DPB_MAXCL
0024EB F20A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
0024EC F20B 07                      DB  7   ;DPB_DIRSCNT
0024ED F20C 28                      DB  40  ;DPB_MAXCYL
0024EE F20D 09                      DB  9   ;DPB_MAXSEC Number of sectors
0024EF F20E 01                      DB  1   ;DPB_FATPS
0024F0 F20F 82                      DB  082H    ;DPB_BPS
0024F1 F210 0500                    DW  5   ;DPB_DIRPS
0024F3 F212 27                      DB  027H    ;DPB_DEVICE Device Number
0024F4 F213 00                      DB  0   ;DPB_UNITNO
0024F5 F214 0800                    DW  8   ;DPB_ADDCL
0024F7 F216 0000                    DW  0   ;DPB_16
0024F9 F218 0000                    DW  0   ;DPB_18
0024FB F21A 0000                    DW  0   ;DPB_SDIR
0024FD F21C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002501 F220 0200                    DW  2   ;DPB_FATLN
002503 F222 EBF0                    DW  _FDRD   ;DPB_DRD
002505 F224 EEF0                    DW  _FDWT   ;DPB_DWT
002507 F226 FD                      DB  0FDH    ;DPB_FATID
002508 F227 02                      DB  2   ;DPB_SECPCL
002509 F228 6401                    DW  356 ;DPB_MAXCL
00250B F22A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
00250C F22B 07                      DB  7   ;DPB_DIRSCNT
00250D F22C 28                      DB  40  ;DPB_MAXCYL
00250E F22D 09                      DB  9   ;DPB_MAXSEC Number of sectors
00250F F22E 01                      DB  1   ;DPB_FATPS
002510 F22F 82                      DB  082H    ;DPB_BPS
002511 F230 0500                    DW  5   ;DPB_DIRPS
002513 F232 27                      DB  027H    ;DPB_DEVICE Device Number
002514 F233 01                      DB  1   ;DPB_UNITNO
002515 F234 0800                    DW  8   ;DPB_ADDCL
002517 F236 0000                    DW  0   ;DPB_16
002519 F238 0000                    DW  0   ;DPB_18
00251B F23A 0000                    DW  0   ;DPB_SDIR
00251D F23C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002521 F240 0100                    DW  1   ;DPB_FATLN
002523 F242 E3EA                    DW  CDRD    ;DPB_DRD
002525 F244 D0EA                    DW  CDWT    ;DPB_DWT
002527 F246 FA                      DB  0FAH    ;DPB_FATID
002528 F247 01                      DB  1   ;DPB_SECPCL
002529 F248 7A00                    DW  122 ;DPB_MAXCL
00252B F24A 00                      DB  0   ;DPB_FDMODE
00252C F24B 06                      DB  6   ;DPB_DIRSCNT
00252D F24C 00                      DB  0   ;DPB_MAXCYL
00252E F24D 00                      DB  0   ;DPB_MAXSEC
00252F F24E 01                      DB  1   ;DPB_FATPS
002530 F24F 01                      DB  1   ;DPB_BPS
002531 F250 0200                    DW  2   ;DPB_DIRPS
002533 F252 0C                      DB  00CH    ;DPB_DEVICE
002534 F253 F8                      DB  0F8H    ;DPB_UNITNO
002535 F254 0600                    DW  6   ;DPB_ADDCL
002537 F256 0000                    DW  0   ;DPB_16
002539 F258 0000                    DW  0   ;DPB_18
00253B F25A 0000                    DW  0   ;DPB_SDIR
00253D F25C 434D4F53                DB  "CMOS"  ;DPB_NAME
                                
                                ;   D:
                                
002541 F260                         DS  32
                                
                                ;   E:
                                
       F280                     EMMFL:
002561 F280 0000                    DW  0   ;DPB_FATLN
002563 F282 9AEA                    DW  EDRD    ;DPB_DRD
002565 F284 8DEA                    DW  EDWT    ;DPB_DWT
002567 F286 FA                      DB  0FAH    ;DPB_FATID
002568 F287 02                      DB  2   ;DPB_SECPCL
002569 F288 0000                    DW  0   ;DPB_MAXCL
00256B F28A 00                      DB  0   ;DPB_FDMODE
00256C F28B 10                      DB  16  ;DPB_DIRSCNT
00256D F28C 00                      DB  0   ;DPB_MAXCYL
00256E F28D 00                      DB  0   ;DPB_MAXSEC
00256F F28E 01                      DB  1   ;DPB_FATPS
002570 F28F 01                      DB  1   ;DPB_BPS
002571 F290 0000                    DW  0   ;DPB_DIRPS
002573 F292 26                      DB  026H    ;DPB_DEVICE
002574 F293 00                      DB  0   ;DPB_UNITNO
002575 F294 0000                    DW  0   ;DPB_ADDCL
002577 F296 0000                    DW  0   ;DPB_16
002579 F298 0000                    DW  0   ;DPB_18
00257B F29A 0000                    DW  0   ;DPB_SDIR
00257D F29C 454D4D30                DB  "EMM0"  ;DPB_NAME
                                
                                ;   F:
                                
002581 F2A0 0200                    DW  2   ;DPB_FATLN
002583 F2A2 FAEA                    DW  RDRD    ;DPB_DRD
002585 F2A4 F6EA                    DW  RDWT    ;DPB_DWT
002587 F2A6 FA                      DB  0FAH    ;DPB_FATID
002588 F2A7 01                      DB  1   ;DPB_SECPCL
002589 F2A8 F600                    DW  246 ;DPB_MAXCL
00258B F2AA 00                      DB  0   ;DPB_FDMODE
00258C F2AB 09                      DB  9   ;DPB_DIRSCNT
00258D F2AC 00                      DB  0   ;DPB_MAXCYL
00258E F2AD 00                      DB  0   ;DPB_MAXSEC
00258F F2AE 01                      DB  1   ;DPB_FATPS
002590 F2AF 01                      DB  1   ;DPB_BPS
002591 F2B0 0300                    DW  3   ;DPB_DIRPS
002593 F2B2 0F                      DB  00FH    ;DPB_DEVICE
002594 F2B3 00                      DB  0   ;DPB_UNITNO
002595 F2B4 0A00                    DW  10  ;DPB_ADDCL
002597 F2B6 0000                    DW  0   ;DPB_16
002599 F2B8 0000                    DW  0   ;DPB_18
00259B F2BA 0000                    DW  0   ;DPB_SDIR
00259D F2BC 52414D46                DB  "RAMF"  ;DPB_NAME
                                
                                ;   G:
       F2C0                     GRAMFL:
0025A1 F2C0 0100                    DW  1   ;DPB_FATLN
0025A3 F2C2 25EB                    DW  GDRD    ;DPB_DRD
0025A5 F2C4 10EB                    DW  GDWT    ;DPB_DWT
0025A7 F2C6 FA                      DB  0FAH    ;DPB_FATID
0025A8 F2C7 01                      DB  1   ;DPB_SECPCL
0025A9 F2C8 5A00                    DW  90  ;DPB_MAXCL
0025AB F2CA 00                      DB  0   ;DPB_FDMODE
0025AC F2CB 06                      DB  6   ;DPB_DIRSCNT
0025AD F2CC 00                      DB  0   ;DPB_MAXCYL
0025AE F2CD 00                      DB  0   ;DPB_MAXSEC
0025AF F2CE 01                      DB  1   ;DPB_FATPS
0025B0 F2CF 01                      DB  1   ;DPB_BPS
0025B1 F2D0 0200                    DW  2   ;DPB_DIRPS
0025B3 F2D2 05                      DB  005H    ;DPB_DEVICE
0025B4 F2D3 F8                      DB  0F8H    ;DPB_UNITNO
0025B5 F2D4 0600                    DW  6   ;DPB_ADDCL
0025B7 F2D6 0000                    DW  0   ;DPB_16
0025B9 F2D8 0000                    DW  0   ;DPB_18
0025BB F2DA 0000                    DW  0   ;DPB_SDIR
0025BD F2DC 4752414D                DB  "GRAM"  ;DPB_NAME
                                
                                ;   H:
0025C1 F2E0                         DS  3
0025C4 F2E3 00                      DB  0
[EOF:M7DPB.ASM:UTF_8]
                                
       A5C5                     LAST_ADR    EQU $$+OFFSET
                                
                                    END
[EOF:M7.ASM:UTF_8]
[EOF:M7I.ASM:UTF_8]
