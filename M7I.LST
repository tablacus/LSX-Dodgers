                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for MZ-700/1500　キー割り込み処理使用
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
       0001                     USE_8253    EQU 1
                                
                                    INCLUDE "M7.ASM"
                                ;   LSX-Dodgers for MZ-700/1500
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "M7DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MZ-700/1500
                                
       0001                     MAC EQU 1   ;MZ-700/1500
       0000                     DEV EQU 0
                                
       011D                     VER_6F  EQU 0011DH
                                
       8080                     RUN EQU 08080H
       8000                     OFFSET  EQU RUN-128
       CF06                     BDOS    EQU 0CF06H
       F000                     WORKAD  EQU 0F000H
       ED40                     TABLEAD EQU 0ED40H
       F300                     KEYBF   EQU 0F300H
       F330                     FATBF   EQU 0F330H
       FB30                     DTBUF   EQU 0FB30H
       FF30                     KBUF    EQU 0FF30H
       FFD9                     TRAP38  EQU 0FFD9H
       0028                     WIDTH   EQU 40
       0019                     LINE    EQU 25
       0070                     COLORF  EQU 070H
       0014                     KEYSP_H EQU 20
       0083                     KEYSP_L EQU 131
       0009                     COMS    EQU 9
       0004                     MAX_SEC_SZ_H    EQU 4       ;1セクタ1024バイトのサポート(2:off 4:on)
       0100                     BUFFER  EQU 00100H
       D0E4                     S27BUF_COM  EQU S27BUF
[EOF:M7DEF.ASM:SHIFT_JIS]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0001                     VER_3   EQU 1
       1D01                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0001                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0161                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 8000                         ORG OFFSET
                                                    ;MZTヘッダ128バイト
000000 8000 01                      DB  1           ;ファイルモード
000001 8001 4C44202020202020        DB  "LD           "     ;ファイル名(13)
            2020202020          
00000E 800E 535953                  DB  "SYS"           ;拡張子(3)
000011 8011 0D                      DB  $0D
000012 8012 4625                    DW  LAST_ADR-RUN        ;サイズ
000014 8014 8080                    DW  RUN         ;開始アドレス
000016 8016 8080                    DW  RUN         ;実行アドレス
000018 8018                         DS  104
                                
                                    INCLUDE "M7INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   MZ-700/1500
                                
000080 8080 C38780          10      JP  START
000083 8083 011D                    DW  MACW
000085 8085 6101                    DW  VER
                                
       8087                     START:
000087 8087 F3               4      DI
000088 8088 ED56             8      IM  1
00008A 808A 318780          10      LD  SP,START
00008D 808D CD9B80          17      CALL    INIT        ;NZならAUTOEXECを実行
000090 8090 210000          10      LD  HL,0
000093 8093 E5              11      PUSH    HL
000094 8094 C8              11      RET Z
000095 8095 118081          10      LD  DE,AUTOD
000098 8098 C3FDF0          10      JP  _COMANL
                                
       809B                     INIT:
00009B 809B D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFFH)
00009D 809D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00009F 809F 21E881          10      LD  HL,INITE
0000A2 80A2 1106CF          10      LD  DE,BDOS
0000A5 80A5 01DE23          10      LD  BC,LAST_ADR-INITE
0000A8 80A8 EDB0                    LDIR
0000AA 80AA 21B781          10      LD  HL,M7BEEPD
0000AD 80AD 1162F0          10      LD  DE,BEEPD+1
0000B0 80B0 010A00          10      LD  BC,M7BEEPE-M7BEEPD
0000B3 80B3 EDB0                    LDIR
                                
0000B5 80B5 210000          10      LD  HL,0
0000B8 80B8 065C             7      LD  B,05CH
0000BA 80BA 3E                      DB  03EH    ;LD A,??
0000BB 80BB EF              12      RST 28H
0000BC 80BC CD75DC          17      CALL    FILL_MEMORY
0000BF 80BF 06A4             7      LD  B,0A4H
0000C1 80C1 AF               4      XOR A
0000C2 80C2 320400          13      LD  (_DVSW),A
0000C5 80C5 CD75DC          17      CALL    FILL_MEMORY
                                
0000C8 80C8 3EC3             7      LD  A,0C3H      ;JP
0000CA 80CA 2103F0          10      LD  HL,CPM_WBOOT
0000CD 80CD 320000          13      LD  (00000H),A
0000D0 80D0 220100          16      LD  (00001H),HL ;IPL
                                
0000D3 80D3 2106CF          10      LD  HL,BDOS
0000D6 80D6 320500          13      LD  (00005H),A
0000D9 80D9 220600          16      LD  (00006H),HL ;BDOS
                                
0000DC 80DC 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000DF 80DF 322800          13      LD  (00028H),A
0000E2 80E2 222900          16      LD  (00029H),HL ;RST 028H
                                
0000E5 80E5 323800          13      LD  (00038H),A
0000E8 80E8 210ECF          10      LD  HL,IO_INT8253
0000EB 80EB 223900          16      LD  (00039H),HL
                                
0000EE 80EE 215BF0          10      LD  HL,_DISKE+1
0000F1 80F1 2223F3          16      LD  (DISKVE),HL
0000F4 80F4 21F5F0          10      LD  HL,_BREAK+1
0000F7 80F7 2225F3          16      LD  (BREAKV),HL
                                
0000FA 80FA 3EF0             7      LD  A,CPM_BOOT/256
0000FC 80FC 320B00          13      LD  (0000BH),A
                                
0000FF 80FF 3EE9             7      LD  A,0E9H      ;JP (HL)
000101 8101 320F00          13      LD  (0000FH),A
                                                ;CHECK PCG(MZ-1500)
000104 8104 2100E8          10      LD  HL,0E800H
000107 8107 46               7      LD  B,(HL)
000108 8108 F3               4      DI
000109 8109 3E01             7      LD  A,1
00010B 810B D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00010D 810D 4E               7      LD  C,(HL)
00010E 810E 79               4      LD  A,C
00010F 810F C6A5             7      ADD A,0A5H
000111 8111 5F               4      LD  E,A
000112 8112 73               7      LD  (HL),E
000113 8113 D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
000115 8115 71               7      LD  (HL),C
000116 8116 3E01             7      LD  A,1
000118 8118 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00011A 811A 7E               7      LD  A,(HL)
00011B 811B BB               4      CP  E
00011C 811C D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
00011E 811E 70               7      LD  (HL),B
00011F 811F FB               4      EI
000120 8120 2804            12      JR  Z,MZ1500
000122 8122 AF               4      XOR A       ;MZ-700はPCGバンクが存在しない
000123 8123 32C0F2          13      LD  (GRAMFL),A
       8126                     MZ1500:
000126 8126 DD2180F2        14      LD  IX,EMMFL
00012A 812A CD7581          17      CALL    CHECK_EMM_BPB
00012D 812D FEEB             7      CP  0EBH
00012F 812F 2817            12      JR  Z,EMM_BPB
000131 8131 DD360D02        19      LD  (IX+DPB_MAXSEC),2   ;BPBが512バイト目から始まる場合を調べる
000135 8135 CD7581          17      CALL    CHECK_EMM_BPB
000138 8138 DDBE06          19      CP  (IX+DPB_FATID)
00013B 813B 200B            12      JR  NZ,EMM_BPB
00013D 813D DD360D00        19      LD  (IX+DPB_MAXSEC),0   ;BPBが先頭の場合に戻す
                                
000141 8141 2103E0          10      LD  HL,0E003H       ;SOUND MASK (MZ-1500)
000144 8144 AF               4      XOR A
000145 8145 CD61CF          17      CALL    WRMMIO
       8148                     EMM_BPB:
000148 8148 218C81          10      LD  HL,INIMES
00014B 814B CD88D4          17      CALL    MSX
       814E                     INIT1:
00014E 814E F3               4      DI
00014F 814F 1100FF          10      LD  DE,0FF00H
000152 8152 0600             7      LD  B,0
000154 8154 CD26D3          17      CALL    ZERO_MEMORY_DE
000157 8157 21CAFF          10      LD  HL,EXTBIO
00015A 815A 36C9            10      LD  (HL),0C9H   ;RET
00015C 815C 23               6      INC HL
00015D 815D 060E             7      LD  B,TRAP38-EXTBIO-1
00015F 815F 3E                      DB  03EH    ;LD A,??
000160 8160 EF              12      RST 28H
000161 8161 CD75DC          17      CALL    FILL_MEMORY
000164 8164 21C181          10      LD  HL,AT_TRAP38
000167 8167 11D9FF          10      LD  DE,TRAP38
00016A 816A 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
00016D 816D EDB0                    LDIR
                                
00016F 816F CD28DB          17      CALL    CHKEY
000172 8172 FE03             7      CP  3
000174 8174 C9              10      RET
                                
       8175                     CHECK_EMM_BPB:
000175 8175 D5              11      PUSH    DE
000176 8176 110000          10      LD  DE,0
000179 8179 CD9FEA          17      CALL    EADR
00017C 817C D1              10      POP DE
00017D 817D ED78            12      IN  A,(C)
00017F 817F C9              10      RET
                                
000180 8180 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000189 8189 413A00              AUTODV: DB  "A:",0
                                
00018C 818C 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MZ-700/1500 v"
            6765727320666F72    
            204D5A2D3730302F    
            313530302076        
0001AA 81AA 312E                    DB  030H + VER_1, '.'
0001AC 81AC 3631                    DB  030H + VER_2 ,030H + VER_3
0001AE 81AE 68                      DB  'h'
0001AF 81AF 2047616B750D0A          DB  " Gaku",0DH,0AH
0001B6 81B6 00                      DB  0
                                
       81B7                     M7BEEPD:
0001B7 81B7 0801                    DB  8,1
0001B9 81B9 0736                    DB  7,036H
0001BB 81BB 04F9                    DB  4,0F9H
0001BD 81BD 0403                    DB  4,3
0001BF 81BF 0301                    DB  3,1         ;SOUND MASK(MZ-1500)
       81C1                     M7BEEPE:
                                
       81C1                     AT_TRAP38:
0001C1 FFD9                         ORG TRAP38,AT_TRAP38-OFFSET
0001C1 FFD9 210000          10      LD  HL,0
0001C4 FFDC E3              19      EX  (SP),HL
0001C5 FFDD 3E24             7      LD  A,'$'
0001C7 FFDF CD78D7          17      CALL    MSG_A
0001CA FFE2 2B               6      DEC HL
0001CB FFE3 7C               4      LD  A,H
0001CC FFE4 CDE8FF          17      CALL    PRHX
0001CF FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
0001D0 FFE8 F5              11      PUSH    AF
0001D1 FFE9 07               4      RLCA
0001D2 FFEA 07               4      RLCA
0001D3 FFEB 07               4      RLCA
0001D4 FFEC 07               4      RLCA
0001D5 FFED CDF1FF          17      CALL    PRHX2
0001D8 FFF0 F1              10      POP AF
       FFF1                     PRHX2:
0001D9 FFF1 E60F             7      AND 00FH
0001DB FFF3 FE0A             7      CP  10
0001DD FFF5 3F               4      CCF
0001DE FFF6 CE30             7      ADC A,'0'
0001E0 FFF8 27               4      DAA
0001E1 FFF9 C378D7          10      JP  MSG_A
0001E4 FFFC                         DS  4
0001E8 81E8                         ORG $$+OFFSET,$$    ;$DEPHASE
       81E8                     AT_TRAPE:
                                
       81E8                     INITE:
0001E8 CF06                         ORG BDOS,INITE-OFFSET
                                
0001E8 CF06 C309CF          10      JP  IO_BDOS
[EOF:M7INIT.ASM:SHIFT_JIS]
                                    INCLUDE "M7BANK.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                ;   VRAM/KEY/TIMER(0D000H-0EFFFH)にアクセスするので0D000H-0FFFFHに置けない部分
                                ;
                                
       CF09                     IO_BDOS:
0001EB CF09 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001ED CF0B C348D4          10      JP  BDOS0
                                
                                #IF EXISTS USE_8253
       CF0E                     IO_INT8253:
0001F0 CF0E F5              11      PUSH    AF
0001F1 CF0F 3ACAFF          13      LD  A,(EXTBIO)
0001F4 CF12 3242D7          13      LD  (INTMEM_SWC),A
0001F7 CF15 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001F9 CF17 3E01             7      LD  A,1
0001FB CF19 3206E0          13      LD  (0E006H),A  ;8253 Ch.2 カウンタ
0001FE CF1C AF               4      XOR A
0001FF CF1D 3206E0          13      LD  (0E006H),A  ;8253 Ch.2 カウンタ
000202 CF20 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000204 CF22 C320D7          10      JP  INT8253
       CF25                     ROM8253E:
000207 CF25 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000209 CF27 F1              10      POP AF
00020A CF28 C9              10      RET
                                
       CF29                     INITINT:
00020B CF29 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00020D CF2B 2107E0          10      LD  HL,0E007H   ;HL=0E007H 8253 コントロール
000210 CF2E 36B0            10      LD  (HL),0B0H   ;Ch.2 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 0 16ビットバイナリ
000212 CF30 3674            10      LD  (HL),074H   ;Ch.1 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 2 16ビットバイナリ
000214 CF32 2D               4      DEC L       ;0E006H 8253 Ch.2 カウンタ
000215 CF33 3602            10      LD  (HL),2
000217 CF35 3600            10      LD  (HL),0
000219 CF37 2D               4      DEC L       ;0E005H 8253 Ch.1 カウンタ
00021A CF38 77               7      LD  (HL),A
00021B CF39 3600            10      LD  (HL),0
00021D CF3B 7D               4      LD  A,L     ;L=5
00021E CF3C 3203E0          13      LD  (0E003H),A  ;8255 コントロールポートでポートC(0E002H)のINTMSKを1にする
000221 CF3F D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000223 CF41 C9              10      RET
                                #ENDIF
                                
       CF42                     RDKEYDATA:
000224 CF42 F3               4      DI
000225 CF43 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000227 CF45 3200E0          13      LD  (0E000H),A
00022A CF48 3A01E0          13      LD  A,(E001H)
00022D CF4B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00022F CF4D FB               4      EI
                                #IF EXISTS USE_8253
                                #ELSE
                                IO_INT8253:
                                #ENDIF
000230 CF4E C9              10      RET
                                
       CF4F                     RD556VSYNC:
000231 CF4F F3               4      DI
000232 CF50 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000234 CF52 3A02E0          13      LD  A,(0E002H)
000237 CF55 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000239 CF57 FB               4      EI
00023A CF58 C9              10      RET
                                
       CF59                     RDMMIO:
00023B CF59 F3               4      DI
00023C CF5A D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00023E CF5C 7E               7      LD  A,(HL)
00023F CF5D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000241 CF5F FB               4      EI
000242 CF60 C9              10      RET
                                
       CF61                     WRMMIO:
000243 CF61 F3               4      DI
000244 CF62 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000246 CF64 77               7      LD  (HL),A
000247 CF65 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000249 CF67 FB               4      EI
00024A CF68 C9              10      RET
                                
       CF69                     RDMMIO_BC:
00024B CF69 F3               4      DI
00024C CF6A D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00024E CF6C 0A               7      LD  A,(BC)
00024F CF6D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000251 CF6F FB               4      EI
000252 CF70 C9              10      RET
                                
       CF71                     WRMMIO_BC:
000253 CF71 F3               4      DI
000254 CF72 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000256 CF74 02               7      LD  (BC),A
000257 CF75 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000259 CF77 FB               4      EI
00025A CF78 C9              10      RET
                                
       CF79                     IO_PRINT:
00025B CF79 F3               4      DI
00025C CF7A D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00025E CF7C 77               7      LD  (HL),A
00025F CF7D CBDC             8      SET 3,H
000261 CF7F 71               7      LD  (HL),C
000262 CF80 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000264 CF82 FB               4      EI
000265 CF83 C9              10      RET
                                
       CF84                     IO_CLR:
000266 CF84 F3               4      DI
000267 CF85 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF87                     C1AX1:
000269 CF87 7A               4      LD  A,D
00026A CF88 C6D0             7      ADD A,0D0H
00026C CF8A 57               4      LD  D,A
00026D CF8B AF               4      XOR A
00026E CF8C 12               7      LD  (DE),A      ;Text
00026F CF8D CBDA             8      SET 3,D
       CF90                     ICSMC   EQU $+1
000271 CF8F 3E00             7      LD  A,0     ;自己書き換え
000273 CF91 12               7      LD  (DE),A      ;Color
000274 CF92 13               6      INC DE
000275 CF93 7A               4      LD  A,D
000276 CF94 D6D8             7      SUB 0D8H
000278 CF96 57               4      LD  D,A
000279 CF97 2118FC          10      LD  HL,0-WIDTH*LINE
00027C CF9A 19              11      ADD HL,DE
00027D CF9B 30EA            12      JR  NC,C1AX1
00027F CF9D E1              10      POP HL
000280 CF9E D1              10      POP DE
000281 CF9F D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000283 CFA1 FB               4      EI
000284 CFA2 C9              10      RET
                                
       CFA3                     IO_CLLINE:
000285 CFA3 F3               4      DI
000286 CFA4 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CFA6                     CLLINE1:
000288 CFA6 CB9C             8      RES 3,H
00028A CFA8 77               7      LD  (HL),A      ;Text
00028B CFA9 CBDC             8      SET 3,H
00028D CFAB 71               7      LD  (HL),C      ;Color
00028E CFAC 23               6      INC HL
00028F CFAD 10F7            13      DJNZ    CLLINE1
000291 CFAF D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000293 CFB1 FB               4      EI
000294 CFB2 C9              10      RET
                                
       CFB3                     IO_INSBS:
000295 CFB3 F3               4      DI
000296 CFB4 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CFB6                     IO_INSBS1:
000298 CFB6 CB9C             8      RES 3,H
00029A CFB8 5E               7      LD  E,(HL)
00029B CFB9 77               7      LD  (HL),A
00029C CFBA 7B               4      LD  A,E
00029D CFBB CBDC             8      SET 3,H
00029F CFBD 5E               7      LD  E,(HL)
0002A0 CFBE 71               7      LD  (HL),C
0002A1 CFBF 4B               4      LD  C,E
       CFC0                     IO_INCDEC   EQU $   ; 自己書き換え
0002A2 CFC0 23               6      INC HL      ;INS->INC HL or BS->DEC HL
0002A3 CFC1 10F3            13      DJNZ    IO_INSBS1
0002A5 CFC3 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0002A7 CFC5 FB               4      EI
0002A8 CFC6 C9              10      RET
                                
       CFC7                     IO_SCRUP:
0002A9 CFC7 F3               4      DI
0002AA CFC8 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CFCA                     SCRUP1:
0002AC CFCA 2815            12      JR  Z,SCRCL
0002AE CFCC D5              11      PUSH    DE
0002AF CFCD E5              11      PUSH    HL
0002B0 CFCE CBDA             8      SET 3,D
0002B2 CFD0 CBDC             8      SET 3,H
0002B4 CFD2 012800          10      LD  BC,WIDTH
0002B7 CFD5 EDB0                    LDIR
0002B9 CFD7 E1              10      POP HL
0002BA CFD8 D1              10      POP DE
0002BB CFD9 012800          10      LD  BC,WIDTH
0002BE CFDC EDB0                    LDIR
0002C0 CFDE 3D               4      DEC A
0002C1 CFDF 18E9            12      JR  SCRUP1
                                
       CFE1                     SCRCL:
0002C3 CFE1 0628             7      LD  B,WIDTH
0002C5 CFE3 EB               4      EX  DE,HL
0002C6 CFE4 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0002C8 CFE6 CD6ED9          17      CALL    CLLINE
0002CB CFE9 E1              10      POP HL
0002CC CFEA D1              10      POP DE
0002CD CFEB C1              10      POP BC
0002CE CFEC C9              10      RET
                                
       CFED                     RD_PCG:
0002CF CFED F3               4      DI
0002D0 CFEE D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
0002D2 CFF0 4E               7      LD  C,(HL)
       CFF1                     RW_PCG:
0002D3 CFF1 D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
0002D5 CFF3 FB               4      EI
0002D6 CFF4 C9              10      RET
                                
       CFF5                     WR_PCG:
0002D7 CFF5 F3               4      DI
0002D8 CFF6 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
0002DA CFF8 71               7      LD  (HL),C
0002DB CFF9 18F6            12      JR  RW_PCG
                                
       CFFB                     IO_MON:
0002DD CFFB D3E4            11      OUT (0E4H),A    ;MONITOR ROM(0000H-0FFFH) & VRAM/KEY/TIMER(D000H-FFFFH)
0002DF CFFD C7              12      RST 0
                                
       CFFE                     BANKE:
0002E0 CFFE                         DS  0CFFEH-BANKE
[EOF:M7BANK.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MZ-700/1500
                                
       CFFE                     WBOOT1:
0002E0 CFFE D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)　ここは0CFFEH
0002E2 D000 D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFHH)
0002E4 D002 F3               4      DI
0002E5 D003 3A94F0          13      LD  A,(_KEYSP_L)
                                #IF EXISTS USE_8253
0002E8 D006 CD29CF          17      CALL    INITINT
                                #ENDIF
0002EB D009 ED7B0600        20      LD  SP,(SYSTEM+1)
0002EF D00D FB               4      EI
0002F0 D00E 2192F0          10      LD  HL,_KEYD
0002F3 D011 3600            10      LD  (HL),0
0002F5 D013 CD28DB          17      CALL    CHKEY
0002F8 D016 CD65D7          17      CALL    KEYBC_IFBREAK
0002FB D019 3E04             7      LD  A,4
0002FD D01B CD78D7          17      CALL    MSG_A
[EOF:M7CCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D01E                     COMMAND:
000300 D01E 3A9DEB          13      LD  A,(FCB_BAT)
000303 D021 B7               4      OR  A
000304 D022 C260D1          10      JP  NZ,C_BAT1
000307 D025 CDD4D0          17      CALL    SETDTA1
00030A D028 3A0400          13      LD  A,(_DVSW)
00030D D02B C641             7      ADD A,'A'
00030F D02D CD78D7          17      CALL    MSG_A
000312 D030 3E3E             7      LD  A,'>'
000314 D032 CD78D7          17      CALL    MSG_A
000317 D035 3E50             7      LD  A,80
000319 D037 12               7      LD  (DE),A
00031A D038 CDD8D7          17      CALL    _SYS0A      ;(BDOS)文字列入力
00031D D03B CD55D2          17      CALL    LTNL
       D03E                     COMMAND2:
000320 D03E 118200          10      LD  DE,DTA1+2
000323 D041 CDFDF0          17      CALL    _COMANL
000326 D044 DC0CD7          17      CALL    C,SHOW_ERROR
000329 D047 18D5            12      JR  COMMAND
                                
       D049                     COMANL:
00032B D049 CDCADB          17      CALL    FILE
00032E D04C 3A19F0          13      LD  A,(FNAME+4)
000331 D04F FE20             7      CP  020H
000333 D051 201C            12      JR  NZ,COMB2
000335 D053 D5              11      PUSH    DE
000336 D054 1115F0          10      LD  DE,FNAME
000339 D057 1A               7      LD  A,(DE)
00033A D058 FE20             7      CP  020H
00033C D05A 2844            12      JR  Z,SDVSW
00033E D05C 1B               6      DEC DE
00033F D05D 1A               7      LD  A,(DE)
000340 D05E C6FF             7      ADD A,0FFH
000342 D060 3809            12      JR  C,COMB
000344 D062 13               6      INC DE
                                
000345 D063 2112D4          10      LD  HL,COMTB
000348 D066 0609             7      LD  B,COMS
00034A D068 CD57DE          17      CALL    CPNAME
       D06B                     COMB:
00034D D06B D1              10      POP DE
00034E D06C D20BD7          10      JP  NC,JPHL
       D06F                     COMB2:
000351 D06F EB               4      EX  DE,HL
000352 D070 223DD1          16      LD  (COMSWC),HL
000355 D073 F5              11      PUSH    AF
000356 D074 CDF5D0          17      CALL    CEXE4
000359 D077 F1              10      POP AF
00035A D078 2115F0          10      LD  HL,FNAME
00035D D07B 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
000360 D07E 010B00          10      LD  BC,11
000363 D081 EDB0                    LDIR
000365 D083 113CEB          10      LD  DE,PATHD
       D086                     CEX1:
000368 D086 1A               7      LD  A,(DE)
000369 D087 FE20             7      CP  020H
00036B D089 D8              11      RET C
00036C D08A CDBFDB          17      CALL    FILEC
00036F D08D D5              11      PUSH    DE
000370 D08E 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
000373 D091 1115F0          10      LD  DE,FNAME
000376 D094 010B00          10      LD  BC,11
000379 D097 EDB0                    LDIR
00037B D099 CDF5D0          17      CALL    CEXE4
00037E D09C D1              10      POP DE
00037F D09D 13               6      INC DE
000380 D09E 18E6            12      JR  CEX1
                                
       D0A0                     SDVSW:
000382 D0A0 F1              10      POP AF
000383 D0A1 3A14F0          13      LD  A,(FDRV)
000386 D0A4 3D               4      DEC A
000387 D0A5 5F               4      LD  E,A
000388 D0A6 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
00038A D0A8 1831            12      JR  SYSTEM0
                                
       D0AA                     OPEN1:
00038C D0AA 2114F0          10      LD  HL,FDRV
       D0AD                     OPEN:
00038F D0AD 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D0AF                     OPEN3:
000391 D0AF D5              11      PUSH    DE
000392 D0B0 1178EB          10      LD  DE,DTA_CCP
000395 D0B3 CDD1D0          17      CALL    SETDTA
000398 D0B6 EB               4      EX  DE,HL
000399 D0B7 CDDBD0          17      CALL    SYSTEM0
00039C D0BA D1              10      POP DE
00039D D0BB C9              10      RET
                                
       D0BC                     OPEN2:
00039E D0BC 0E12             7      LD  C,012H
0003A0 D0BE 18EF            12      JR  OPEN3
                                
       D0C0                     DEFCB:              ;Z=Ok NZ=Error
0003A2 D0C0 1178EB          10      LD  DE,DTA_CCP
0003A5 D0C3 CDD9D0          17      CALL    SYSC0F
                                
0003A8 D0C6 1199EB          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0003AB D0C9 0604             7      LD  B,4
0003AD D0CB CD26D3          17      CALL    ZERO_MEMORY_DE
       D0CE                     SETDTA100:
0003B0 D0CE 110001          10      LD  DE,BUFFER
       D0D1                     SETDTA:
0003B3 D0D1 C34CD6          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D0D4                     SETDTA1:
0003B6 D0D4 118000          10      LD  DE,DTA1
0003B9 D0D7 18F8            12      JR  SETDTA
                                
       D0D9                     SYSC0F:
0003BB D0D9 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D0DB                     SYSTEM0:
0003BD D0DB CD0500          17      CALL    SYSTEM
0003C0 D0DE B7               4      OR  A
0003C1 D0DF C9              10      RET
                                
       D0E0                     C_CD:
0003C2 D0E0 0E5A             7      LD  C,05AH
0003C4 D0E2 18F7            12      JR  SYSTEM0
                                
       D0E4                     S27BUF:
0003C6 D0E4 2100FE          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       D0E7                     S27BUF2:
0003C9 D0E7 39              11      ADD HL,SP
0003CA D0E8 2E00             7      LD  L,0
0003CC D0EA 7C               4      LD  A,H
0003CD D0EB E6F8             7      AND 0F8H
0003CF D0ED 67               4      LD  H,A
       D0EE                     S27DTA:
0003D0 D0EE 1178EB          10      LD  DE,DTA_CCP
       D0F1                     S27:
0003D3 D0F1 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
0003D5 D0F3 18E6            12      JR  SYSTEM0
                                
       D0F5                     CEXE4:
0003D7 D0F5 211DF0          10      LD  HL,FNAME+8
0003DA D0F8 7E               7      LD  A,(HL)
0003DB D0F9 FE20             7      CP  020H
0003DD D0FB 2007            12      JR  NZ,CEXE7
0003DF D0FD 3E3F             7      LD  A,'?'
0003E1 D0FF 77               7      LD  (HL),A
0003E2 D100 23               6      INC HL
0003E3 D101 77               7      LD  (HL),A
0003E4 D102 23               6      INC HL
0003E5 D103 77               7      LD  (HL),A
       D104                     CEXE7:
0003E6 D104 CDAAD0          17      CALL    OPEN1
       D107                     CEXE5:
0003E9 D107 C0              11      RET NZ
0003EA D108 2A82EB          16      LD  HL,(DTA_CCP+1+9)
0003ED D10B 7C               4      LD  A,H
0003EE D10C CDE6DE          17      CALL    CAP
0003F1 D10F 67               4      LD  H,A
0003F2 D110 7D               4      LD  A,L
0003F3 D111 CDE6DE          17      CALL    CAP
0003F6 D114 6F               4      LD  L,A
0003F7 D115 3A81EB          13      LD  A,(DTA_CCP+1+8)
0003FA D118 CDE6DE          17      CALL    CAP
0003FD D11B D642             7      SUB 'B'
0003FF D11D 282C            12      JR  Z,C_BAT
000401 D11F 3D               4      DEC A       ;'C'
000402 D120 2805            12      JR  Z,C_EXE
       D122                     CEXE6:
000404 D122 CDBCD0          17      CALL    OPEN2
000407 D125 18E0            12      JR  CEXE5
                                
       D127                     C_EXE:
000409 D127 7C               4      LD  A,H
00040A D128 FE4D             7      CP  'M'
00040C D12A 20F6            12      JR  NZ,CEXE6
                                
00040E D12C CDC0D0          17      CALL    DEFCB
000411 D12F CDE4D0          17      CALL    S27BUF_COM
000414 D132 3D               4      DEC A
000415 D133 37               4      SCF
000416 D134 C0              11      RET NZ
000417 D135 7C               4      LD  A,H
000418 D136 B5               4      OR  L
000419 D137 37               4      SCF
00041A D138 C8              11      RET Z
00041B D139 CDD4D0          17      CALL    SETDTA1
00041E D13C 110000          10      LD  DE,0                ; self-modifying code
       D13D                     COMSWC  EQU $-2
000421 D13F ED7B0600        20      LD  SP,(SYSTEM+1)
000425 D143 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000426 D144 6F               4      LD  L,A
000427 D145 E5              11      PUSH    HL              ; push $0000 (reboot address)
000428 D146 24               4      INC H
000429 D147 E5              11      PUSH    HL              ; push $0100 (TPA address)
00042A D148 C3F1D2          10      JP  SETFCB              ; and JP $0100
                                
       D14B                     C_BAT:
00042D D14B 114154          10      LD  DE,'A'+'T'*256
000430 D14E ED52            15      SBC HL,DE
000432 D150 20D0            12      JR  NZ,CEXE6
                                
000434 D152 CDC0D0          17      CALL    DEFCB
                                
000437 D155 2178EB          10      LD  HL,DTA_CCP
00043A D158 119DEB          10      LD  DE,FCB_BAT
00043D D15B 012500          10      LD  BC,37
000440 D15E EDB0                    LDIR
       D160                     C_BAT1:
000442 D160 CDCED0          17      CALL    SETDTA100
000445 D163 CD97D1          17      CALL    FGETC_BAT
000448 D166 218100          10      LD  HL,DTA1+1
00044B D169 2025            12      JR  NZ,END_BATCH
00044D D16B FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
00044F D16D 38F1            12      JR  C,C_BAT1
000451 D16F 3620            10      LD  (HL),' '
000453 D171 23               6      INC HL
       D172                     C_BAT2:
000454 D172 77               7      LD  (HL),A
000455 D173 23               6      INC HL
000456 D174 7D               4      LD  A,L
000457 D175 3C               4      INC A       ;L==0FFH
000458 D176 2809            12      JR  Z,RUN_BATCH
00045A D178 CD97D1          17      CALL    FGETC_BAT
00045D D17B 2004            12      JR  NZ,RUN_BATCH
00045F D17D FE20             7      CP  020H
000461 D17F 30F1            12      JR  NC,C_BAT2
       D181                     RUN_BATCH:
000463 D181 7D               4      LD  A,L
000464 D182 D67F             7      SUB DTA1-1
000466 D184 328000          13      LD  (DTA1),A
000469 D187 FE04             7      CP  4
00046B D189 3805            12      JR  C,END_BATCH
00046D D18B 3600            10      LD  (HL),0
00046F D18D C33ED0          10      JP  COMMAND2
       D190                     END_BATCH:
000472 D190 AF               4      XOR A       ;バッチファイルを閉じる
000473 D191 329DEB          13      LD  (FCB_BAT),A
000476 D194 C300F0          10      JP  CPM_BOOT
                                
       D197                     FGETC_BAT:
000479 D197 119DEB          10      LD  DE,FCB_BAT
       D19A                     FGETC:              ;1文字ずつ読み込む
00047C D19A E5              11      PUSH    HL      ;Z:成功
00047D D19B 210100          10      LD  HL,1
000480 D19E CDF1D0          17      CALL    S27
000483 D1A1 E1              10      POP HL
000484 D1A2 3A0001          13      LD  A,(BUFFER)
000487 D1A5 C9              10      RET
                                
       D1A6                     C_DEL:
000488 D1A6 CDF1D2          17      CALL    SETFCB
00048B D1A9 CD8ED7          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
00048E D1AC 0E13             7      LD  C,013H
000490 D1AE 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D1B0                     C_REN:
000492 D1B0 CDF1D2          17      CALL    SETFCB
000495 D1B3 3E10             7      LD  A,010H      ;ディレクトリも対象にする
000497 D1B5 326900          13      LD  (FCB1+13),A ;属性
00049A D1B8 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D1BA                     CDEL1:
00049C D1BA 115C00          10      LD  DE,FCB1
00049F D1BD CD0500          17      CALL    SYSTEM
0004A2 D1C0 C6FF             7      ADD A,0FFH
0004A4 D1C2 C9              10      RET
                                
       D1C3                     C_DIR:
0004A5 D1C3 CDBFDB          17      CALL    FILEC
0004A8 D1C6 2115F0          10      LD  HL,FDRV+1
0004AB D1C9 CD07D4          17      CALL    CWILD1
0004AE D1CC 3EF1             7      LD  A,0F1H
0004B0 D1CE 3221F0          13      LD  (FDRV+13),A
0004B3 D1D1 CDAAD0          17      CALL    OPEN1
       D1D4                     CDIR1:
0004B6 D1D4 B7               4      OR  A
0004B7 D1D5 2008            12      JR  NZ,PDSKF
0004B9 D1D7 CD22D2          17      CALL    P_NAME
0004BC D1DA CDBCD0          17      CALL    OPEN2
0004BF D1DD 18F5            12      JR  CDIR1
       D1DF                     PDSKF:
0004C1 D1DF 3A14F0          13      LD  A,(FDRV)
0004C4 D1E2 5F               4      LD  E,A
0004C5 D1E3 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
0004C7 D1E5 CD0500          17      CALL    SYSTEM
0004CA D1E8 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
0004CB D1E9 C601             7      ADD A,001H
0004CD D1EB D8              11      RET C       ;Aが0FFHだった場合
0004CE D1EC 3E06             7      LD  A,8-2
       D1EE                     PDS1:               ;HL=未使用クラスタの総数
0004D0 D1EE 3C               4      INC A
0004D1 D1EF CB19             8      RR  C
0004D3 D1F1 30FB            12      JR  NC,PDS1
       D1F3                     PDS2:               ;B←論理セクタのサイズの上位8ビット
0004D5 D1F3 3C               4      INC A
0004D6 D1F4 CB18             8      RR  B
0004D8 D1F6 30FB            12      JR  NC,PDS2
0004DA D1F8 47               4      LD  B,A
                                
0004DB D1F9 110000          10      LD  DE,0
       D1FC                     PDS3:
0004DE D1FC 29              11      ADD HL,HL
0004DF D1FD EB               4      EX  DE,HL
0004E0 D1FE ED6A            15      ADC HL,HL
0004E2 D200 EB               4      EX  DE,HL
0004E3 D201 10F9            13      DJNZ    PDS3
       D203                     PDSKF1:
0004E5 D203 CD8FD2          17      CALL    PRDEC_DEHL
0004E8 D206 11CDEB          10      LD  DE,FREE
0004EB D209 CD79D4          17      CALL    _SYS09      ;(BDOS)文字列出力
0004EE D20C CD7CD2          17      CALL    PUTDRV
0004F1 D20F 3E5C             7      LD  A,05CH      ;\
0004F3 D211 CD78D7          17      CALL    MSG_A
0004F6 D214 2A22F0          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
0004F9 D217 AF               4      XOR A
0004FA D218 11FEFF          10      LD  DE,0-2
0004FD D21B 19              11      ADD HL,DE
0004FE D21C 23               6      INC HL
0004FF D21D DC8CD2          17      CALL    C,PRDEC_HL
000502 D220 1833            12      JR  LTNL
                                
       D222                     P_NAME:
000504 D222 3A79EB          13      LD  A,(DTA_CCP+1)
000507 D225 FE2E             7      CP  '.'
000509 D227 C8              11      RET Z
                                
00050A D228 3A84EB          13      LD  A,(DTA_CCP+1+00BH)
00050D D22B F5              11      PUSH    AF
00050E D22C CB67             8      BIT 4,A
000510 D22E 2808            12      JR  Z,DIR3
000512 D230 11C2EB          10      LD  DE,DIRMES
000515 D233 CD79D4          17      CALL    _SYS09      ;(BDOS)文字列出力
000518 D236 180A            12      JR  DIR6
       D238                     DIR3:
00051A D238 ED5B97EB        20      LD  DE,(DTA_CCP+1+01EH)
00051E D23C 2A95EB          16      LD  HL,(DTA_CCP+1+01CH)
000521 D23F CD8FD2          17      CALL    PRDEC_DEHL
       D242                     DIR6:
000524 D242 F1              10      POP AF
000525 D243 0F               4      RRCA
000526 D244 9F               4      SBC A,A
000527 D245 E60A             7      AND '*'-020H
000529 D247 C620             7      ADD A,020H
00052B D249 CD78D7          17      CALL    MSG_A
00052E D24C CD7CD2          17      CALL    PUTDRV
000531 D24F 2179EB          10      LD  HL,DTA_CCP+1
000534 D252 CDCFD2          17      CALL    FPRNT
                                
       D255                     LTNL:
000537 D255 1E03             7      LD  E,3
000539 D257 C3CDF0          10      JP  _PRINT
                                
       D25A                     C_PATH:
00053C D25A CDA0DC          17      CALL    SPCUT
00053F D25D 213CEB          10      LD  HL,PATHD
000542 D260 FE21             7      CP  021H
000544 D262 300C            12      JR  NC,CPATH0
       D264                     CPATHP:
000546 D264 7E               7      LD  A,(HL)
000547 D265 23               6      INC HL
000548 D266 FE20             7      CP  020H
00054A D268 3F               4      CCF
00054B D269 30EA            12      JR  NC,LTNL
00054D D26B CD78D7          17      CALL    MSG_A
000550 D26E 18F4            12      JR  CPATHP
       D270                     CPATH0:
000552 D270 FE3B             7      CP  ';'
000554 D272 2001            12      JR  NZ,CPATH1
000556 D274 13               6      INC DE
       D275                     CPATH1:
000557 D275 EB               4      EX  DE,HL
000558 D276 013B00          10      LD  BC,PATHX
00055B D279 EDB0                    LDIR
00055D D27B C9              10      RET
                                
       D27C                     PUTDRV:
00055E D27C 3A14F0          13      LD  A,(FDRV)
000561 D27F CDD3DC          17      CALL    GETDRV1
000564 D282 C641             7      ADD A,'A'
000566 D284 CD78D7          17      CALL    MSG_A
000569 D287 3E3A             7      LD  A,':'
       D289                     MSG_AR:
00056B D289 C378D7          10      JP  MSG_A
                                
       D28C                     PRDEC_HL:
00056E D28C AF               4      XOR A
00056F D28D 5F               4      LD  E,A
000570 D28E 57               4      LD  D,A
       D28F                     PRDEC_DEHL:
000571 D28F D5              11      PUSH    DE
000572 D290 110FF0          10      LD  DE,DECBF
000575 D293 0605             7      LD  B,5
000577 D295 CD26D3          17      CALL    ZERO_MEMORY_DE  ;A=0
00057A D298 D1              10      POP DE
                                
00057B D299 0E20             7      LD  C,32
       D29B                     DEC1:
00057D D29B 29              11      ADD HL,HL
00057E D29C EB               4      EX  DE,HL
00057F D29D ED6A            15      ADC HL,HL
000581 D29F EB               4      EX  DE,HL
000582 D2A0 E5              11      PUSH    HL
000583 D2A1 2113F0          10      LD  HL,DECBF+4
000586 D2A4 0605             7      LD  B,5
       D2A6                     DEC2:
000588 D2A6 7E               7      LD  A,(HL)
000589 D2A7 8F               4      ADC A,A
00058A D2A8 27               4      DAA
00058B D2A9 77               7      LD  (HL),A
00058C D2AA 2B               6      DEC HL
00058D D2AB 10F9            13      DJNZ    DEC2
00058F D2AD E1              10      POP HL
000590 D2AE 0D               4      DEC C
000591 D2AF 20EA            12      JR  NZ,DEC1
                                
000593 D2B1 210FF0          10      LD  HL,DECBF
000596 D2B4 3E20             7      LD  A,020H
000598 D2B6 0604             7      LD  B,4
       D2B8                     DEC3:
00059A D2B8 CDC5D2          17      CALL    DEC4
00059D D2BB CDC5D2          17      CALL    DEC4
0005A0 D2BE 23               6      INC HL
0005A1 D2BF 10F7            13      DJNZ    DEC3
       D2C1                     DECX:
0005A3 D2C1 CDC5D2          17      CALL    DEC4
0005A6 D2C4 AF               4      XOR A
       D2C5                     DEC4:
0005A7 D2C5 ED6F            18      RLD
0005A9 D2C7 FE20             7      CP  020H
0005AB D2C9 2802            12      JR  Z,DEC5
0005AD D2CB F630             7      OR  030H
       D2CD                     DEC5:
0005AF D2CD 18BA            12      JR  MSG_AR
                                
       D2CF                     FPRNT:
0005B1 D2CF 0608             7      LD  B,8 ;ファイル名を表示
0005B3 D2D1 CDE0D2          17      CALL    P_N1
0005B6 D2D4 7E               7      LD  A,(HL)
0005B7 D2D5 CDF2DE          17      CALL    CAP3
0005BA D2D8 D8              11      RET C   ;拡張子が無い
                                
0005BB D2D9 3E2E             7      LD  A,'.'
0005BD D2DB CD78D7          17      CALL    MSG_A
0005C0 D2DE 0603             7      LD  B,3 ;拡張子を表示
       D2E0                     P_N1:
0005C2 D2E0 7E               7      LD  A,(HL)
0005C3 D2E1 CDF2DE          17      CALL    CAP3
0005C6 D2E4 3807            12      JR  C,P_N2
0005C8 D2E6 CD78D7          17      CALL    MSG_A
0005CB D2E9 23               6      INC HL
0005CC D2EA 10F4            13      DJNZ    P_N1
0005CE D2EC C9              10      RET
       D2ED                     P_N2:
0005CF D2ED 23               6      INC HL
0005D0 D2EE 10FD            13      DJNZ    P_N2
0005D2 D2F0 C9              10      RET
                                
       D2F1                     SETFCB:
0005D3 D2F1 CDA0DC          17      CALL    SPCUT
0005D6 D2F4 1A               7      LD  A,(DE)
0005D7 D2F5 FE20             7      CP  020H
0005D9 D2F7 3801            12      JR  C,SETFCBA
0005DB D2F9 1B               6      DEC DE
       D2FA                     SETFCBA:
0005DC D2FA 0624             7      LD  B,36
0005DE D2FC 215C00          10      LD  HL,FCB1
0005E1 D2FF E5              11      PUSH    HL
0005E2 D300 AF               4      XOR A
0005E3 D301 CD75DC          17      CALL    FILL_MEMORY
0005E6 D304 E1              10      POP HL
0005E7 D305 D5              11      PUSH    DE
0005E8 D306 CDB2D6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005EB D309 216C00          10      LD  HL,FCB2
0005EE D30C CDB2D6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005F1 D30F E1              10      POP HL
0005F2 D310 010050          10      LD  BC,05000H
0005F5 D313 118100          10      LD  DE,00081H
       D316                     SETFCB1:
0005F8 D316 7E               7      LD  A,(HL)
0005F9 D317 23               6      INC HL
0005FA D318 FE20             7      CP  020H
0005FC D31A 3805            12      JR  C,SETFCB2
0005FE D31C 12               7      LD  (DE),A
0005FF D31D 13               6      INC DE
000600 D31E 0C               4      INC C
000601 D31F 10F5            13      DJNZ    SETFCB1
       D321                     SETFCB2:
000603 D321 79               4      LD  A,C
000604 D322 328000          13      LD  (DTA1),A
000607 D325 04               4      INC B
       D326                     ZERO_MEMORY_DE:
000608 D326 AF               4      XOR A
       D327                     FILL_MEMORY_DE:
000609 D327 12               7      LD  (DE),A
00060A D328 13               6      INC DE
00060B D329 10FC            13      DJNZ    FILL_MEMORY_DE
00060D D32B C9              10      RET
                                
       D32C                     C_COPY:
00060E D32C CDF1D2          17      CALL    SETFCB
                                
000611 D32F 1161F0          10      LD  DE,ZERO
000614 D332 CDC2DB          17      CALL    FILEC2
000617 D335 216C00          10      LD  HL,FCB2
00061A D338 CDB9D6          17      CALL    S29X1
                                
00061D D33B 3E10             7      LD  A,010H
00061F D33D 326900          13      LD  (FCB1+13),A
000622 D340 216D00          10      LD  HL,FCB2FN
000625 D343 CD07D4          17      CALL    CWILD1
       D346                     COPY0:
000628 D346 CD04D4          17      CALL    CWILD
00062B D349 215C00          10      LD  HL,FCB1
00062E D34C CDADD0          17      CALL    OPEN
000631 D34F 37               4      SCF
       D350                     COPY1:
000632 D350 C0              11      RET NZ
000633 D351 CDC0D0          17      CALL    DEFCB
                                
000636 D354 3A85EB          13      LD  A,(DTA_CCP+13)
000639 D357 CB67             8      BIT 4,A
00063B D359 2821            12      JR  Z,COPY1A
                                
00063D D35B 215D00          10      LD  HL,FCB1FN
000640 D35E CD05E0          17      CALL    CHKWILD
000643 D361 3814            12      JR  C,COPY9
                                
000645 D363 3E20             7      LD  A,020H
000647 D365 325D00          13      LD  (FCB1FN),A
00064A D368 2A92EB          16      LD  HL,(DTA_CCP+26)
00064D D36B 23               6      INC HL
00064E D36C 226A00          16      LD  (FCB1+14),HL
000651 D36F 18D5            12      JR  COPY0
                                
       D371                     COPY8:
000653 D371 CD79D4          17      CALL    _SYS09      ;(BDOS)文字列出力
000656 D374 CD55D2          17      CALL    LTNL
       D377                     COPY9:
000659 D377 CDBCD0          17      CALL    OPEN2
00065C D37A 18D4            12      JR  COPY1
                                
       D37C                     COPY1A:
00065E D37C 216C00          10      LD  HL,FCB2
000661 D37F 1114F0          10      LD  DE,FDRV
000664 D382 017AEB          10      LD  BC,DTA_CCP+2
000667 D385 EDA0            16      LDI
000669 D387 3E0B             7      LD  A,11
       D389                     COPY2:
00066B D389 F5              11      PUSH    AF
00066C D38A 7E               7      LD  A,(HL)
00066D D38B FE3F             7      CP  '?'
00066F D38D 2001            12      JR  NZ,COPY3
000671 D38F 0A               7      LD  A,(BC)
       D390                     COPY3:
000672 D390 12               7      LD  (DE),A
000673 D391 03               6      INC BC
000674 D392 13               6      INC DE
000675 D393 23               6      INC HL
000676 D394 F1              10      POP AF
000677 D395 3D               4      DEC A
000678 D396 20F1            12      JR  NZ,COPY2
00067A D398 010500          10      LD  BC,16-11
00067D D39B EDB0                    LDIR
       D39D                     PUTNAME:
00067F D39D 215D00          10      LD  HL,FCB1FN
000682 D3A0 CD05E0          17      CALL    CHKWILD
000685 D3A3 300B            12      JR  NC,PUTN1
000687 D3A5 2115F0          10      LD  HL,FDRV+1
00068A D3A8 CDCFD2          17      CALL    FPRNT
00068D D3AB 3E20             7      LD  A,020H
00068F D3AD CD78D7          17      CALL    MSG_A
       D3B0                     PUTN1:
000692 D3B0 1114F0          10      LD  DE,FDRV
000695 D3B3 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
000697 D3B5 CDDBD0          17      CALL    SYSTEM0
00069A D3B8 2048            12      JR  NZ,COPYE2
00069C D3BA 67               4      LD  H,A     ;A=0
00069D D3BB 6F               4      LD  L,A
00069E D3BC 2235F0          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0006A1 D3BF 2237F0          16      LD  (FDRV+35),HL
       D3C2                     COPY6:
0006A4 D3C2 CDE4D0          17      CALL    S27BUF
0006A7 D3C5 47               4      LD  B,A
0006A8 D3C6 3C               4      INC A
0006A9 D3C7 2831            12      JR  Z,COPYE
0006AB D3C9 7C               4      LD  A,H
0006AC D3CA B5               4      OR  L
0006AD D3CB 280C            12      JR  Z,COPY7
0006AF D3CD 1114F0          10      LD  DE,FDRV
0006B2 D3D0 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0006B4 D3D2 CDDBD0          17      CALL    SYSTEM0
0006B7 D3D5 2023            12      JR  NZ,COPYE
0006B9 D3D7 10E9            13      DJNZ    COPY6
       D3D9                     COPY7:
0006BB D3D9 3A85EB          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0006BE D3DC 3221F0          13      LD  (FDRV+13),A
0006C1 D3DF 218CEB          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
0006C4 D3E2 1128F0          10      LD  DE,FDRV+20
0006C7 D3E5 010400          10      LD  BC,4
0006CA D3E8 EDB0                    LDIR
                                
0006CC D3EA 1114F0          10      LD  DE,FDRV
0006CF D3ED 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
0006D1 D3EF CDDBD0          17      CALL    SYSTEM0
0006D4 D3F2 2006            12      JR  NZ,COPYE
                                
0006D6 D3F4 1171F0          10      LD  DE,OK
0006D9 D3F7 C371D3          10      JP  COPY8
                                
       D3FA                     COPYE:
0006DC D3FA 1114F0          10      LD  DE,FDRV
0006DF D3FD 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
0006E1 D3FF CD0500          17      CALL    SYSTEM
       D402                     COPYE2:
0006E4 D402 37               4      SCF
0006E5 D403 C9              10      RET
                                
       D404                     CWILD:
0006E6 D404 215D00          10      LD  HL,FCB1FN
       D407                     CWILD1:
0006E9 D407 7E               7      LD  A,(HL)
0006EA D408 FE20             7      CP  020H
0006EC D40A C0              11      RET NZ
       D40B                     CWILD2:
0006ED D40B 3E3F             7      LD  A,'?'
0006EF D40D 060B             7      LD  B,11
0006F1 D40F C375DC          10      JP  FILL_MEMORY
                                
       D412                     COMTB:
0006F4 D412 44202020                DB  "D   "  ;1
0006F8 D416 C3D1                    DW  C_DIR
0006FA D418 44495220                DB  "DIR "  ;2
0006FE D41C C3D1                    DW  C_DIR
000700 D41E 434F5059                DB  "COPY"  ;3
000704 D422 2CD3                    DW  C_COPY
000706 D424 43442020                DB  "CD  "  ;4
00070A D428 E0D0                    DW  C_CD
00070C D42A 44454C20                DB  "DEL "  ;5
000710 D42E A6D1                    DW  C_DEL
000712 D430 50415448                DB  "PATH"  ;6
000716 D434 5AD2                    DW  C_PATH
000718 D436 52454E20                DB  "REN "  ;7
00071C D43A B0D1                    DW  C_REN
00071E D43C 52454D20                DB  "REM "  ;8
000722 D440 76D4                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP2.ASM"
                                
                                ;   LSX-Dodgers CCP2
                                ;   MZ-700/1500
                                
000724 D442 4D4F4E20                DB  "MON "  ;9
000728 D446 AFDB                    DW  C_MON
[EOF:M7CCP2.ASM:UTF_8]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D448                     BDOS0:
00072A D448 E5              11      PUSH    HL
00072B D449 79               4      LD  A,C
00072C D44A FE3C             7      CP  03CH
00072E D44C 3802            12      JR  C,DOS1
000730 D44E 3E3C             7      LD  A,03CH
       D450                     DOS1:
000732 D450 87               4      ADD A,A
000733 D451 3255D4          13      LD  (DOS1_SWC),A
000736 D454 2A00F1          16      LD  HL,(STABLE)
       D455                     DOS1_SWC    EQU $-2
000739 D457 E3              19      EX  (SP),HL
00073A D458 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
00073B D459 C9              10      RET
       D45A                     _DOS2:
00073C D45A FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
00073E D45C CAF4D6          10      JP  Z,_SYS5A
000741 D45F FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000743 D461 CAB1D6          10      JP  Z,_SYS5C
000746 D464 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
000748 D466 CA00E9          10      JP  Z,_SYS5F
00074B D469 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
00074D D46B 200A            12      JR  NZ,_ERROR
00074F D46D 011D01          10      LD  BC,VER_6F
000752 D470 116101          10      LD  DE,VER
000755 D473 210100          10      LD  HL,MACD
       D476                     C_REM:
000758 D476 AF               4      XOR A
       D477                     _ERROR:
000759 D477 A7               4      AND A
00075A D478 C9              10      RET
                                
       D479                     _SYS09:     ;文字列出力
00075B D479 D5              11      PUSH    DE
       D47A                     _SX09:
00075C D47A 1A               7      LD  A,(DE)
00075D D47B 13               6      INC DE
00075E D47C FE24             7      CP  '$'
000760 D47E 2831            12      JR  Z,SX0E2
000762 D480 CD78D7          17      CALL    MSG_A
000765 D483 18F5            12      JR  _SX09
                                
       D485                     MSX1:
000767 D485 CD78D7          17      CALL    MSG_A
       D488                     MSX:
00076A D488 7E               7      LD  A,(HL)
00076B D489 23               6      INC HL
00076C D48A B7               4      OR  A
00076D D48B 20F8            12      JR  NZ,MSX1
00076F D48D C9              10      RET
                                
       D48E                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000770 D48E 212200          10      LD  HL,00022H
000773 D491 7D               4      LD  A,L
000774 D492 C9              10      RET
                                
       D493                     _SYS0D:     ;(BDOS)ディスクリセット
000775 D493 CDDFF0          17      CALL    _FFLUSH
000778 D496 E5              11      PUSH    HL
000779 D497 218000          10      LD  HL,00080H
00077C D49A 228AF0          16      LD  (_DTA),HL
00077F D49D E1              10      POP HL
000780 D49E D5              11      PUSH    DE
000781 D49F 1E00             7      LD  E,0
000783 D4A1 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D4A2                     _SYS0E:     ;(BDOS)カレントドライブの設定
000784 D4A2 D5              11      PUSH    DE
000785 D4A3 7B               4      LD  A,E
000786 D4A4 DDE5            15      PUSH    IX
000788 D4A6 CDDCF0          17      CALL    _GETDPB
00078B D4A9 DDE1            14      POP IX
00078D D4AB 3804            12      JR  C,SX0E2
00078F D4AD 7B               4      LD  A,E
000790 D4AE 320400          13      LD  (_DVSW),A
       D4B1                     SX0E2:
000793 D4B1 D1              10      POP DE
000794 D4B2 C9              10      RET
                                
       D4B3                     _SYS0F:     ;(BDOS)ファイルのオープン
000795 D4B3 CDB2DC          17      CALL    SETDRV
000798 D4B6 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00079B D4B9 C602             7      ADD A,002H      ;Write
00079D D4BB 2848            12      JR  Z,FEND0F
00079F D4BD CD01E0          17      CALL    CHKWILDX
                                
0007A2 D4C0 D4DCDC          17      CALL    NC,SOPENX
       D4C3                     _S16XX:
0007A5 D4C3 3840            12      JR  C,FEND0F
                                                ;Directory location
0007A7 D4C5 3A9FF0          13      LD  A,(_FILEN)
0007AA D4C8 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
0007AD D4CB 3AA0F0          13      LD  A,(_DIRF)
0007B0 D4CE FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
0007B3 D4D1 FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
0007B6 D4D4 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
0007B9 D4D7 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
0007BD D4DB FDE5            15      PUSH    IY
0007BF D4DD D1              10      POP DE
0007C0 D4DE 13               6      INC DE
0007C1 D4DF 010B00          10      LD  BC,11
0007C4 D4E2 EDB0                    LDIR
                                ;               Attribute
0007C6 D4E4 7E               7      LD  A,(HL)
0007C7 D4E5 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
0007CA D4E8 110B00          10      LD  DE,11       ;Reserved
0007CD D4EB 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
0007CE D4EC 11E4F1          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
0007D1 D4EF 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D4F1                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
0007D3 D4F1 1A               7      LD  A,(DE)
0007D4 D4F2 13               6      INC DE
0007D5 D4F3 32FAD4          13      LD  (S16PAT),A
0007D8 D4F6 7E               7      LD  A,(HL)
0007D9 D4F7 23               6      INC HL
0007DA D4F8 FD7700          19      LD  (IY+0),A
       D4FA                     S16PAT  EQU $-1
0007DD D4FB 10F4            13      DJNZ    S16LOOP
                                
0007DF D4FD AF               4      XOR A
0007E0 D4FE FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
0007E3 D501 FD22A2D5        20      LD  (OFCB_SWC),IY
       D505                     FEND0F:
0007E7 D505 1845            12      JR  FEND10
                                
       D507                     _SYS10:     ;(BDOS)ファイルのクローズ
0007E9 D507 CDB2DC          17      CALL    SETDRV
0007EC D50A FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0007EF D50D D6FE             7      SUB 0FEH
0007F1 D50F 37               4      SCF
0007F2 D510 3F               4      CCF
0007F3 D511 2039            12      JR  NZ,FEND10
       D513                     _S10A:              ;Write
0007F5 D513 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
0007F8 D516 FD770F          19      LD  (IY+15),A
                                
0007FB D519 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
0007FE D51C CDFDE0          17      CALL    SETTMS
                                
000801 D51F FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000804 D522 32A0F0          13      LD  (_DIRF),A
000807 D525 E67F             7      AND 07FH
000809 D527 3222E6          13      LD  (_SECPS),A
00080C D52A FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
00080F D52D FD561F          19      LD  D,(IY+31)
000812 D530 CD10DE          17      CALL    READ_DIR
000815 D533 3817            12      JR  C,FEND10
                                
000817 D535 3A3CDD          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
00081A D538 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
00081B D539 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
00081E D53C 6F               4      LD  L,A
00081F D53D 2600             7      LD  H,0
000821 D53F 29              11      ADD HL,HL       ;*2
000822 D540 29              11      ADD HL,HL       ;*4
000823 D541 29              11      ADD HL,HL       ;*8
000824 D542 29              11      ADD HL,HL       ;*16
000825 D543 29              11      ADD HL,HL       ;*32
000826 D544 ED4B7EF1        20      LD  BC,(_DTBUF)
00082A D548 09              11      ADD HL,BC
                                
00082B D549 CD11E0          17      CALL    SDIRENT
       D54C                     FEND10:
00082E D54C 1842            12      JR  FEND
                                
       D54E                     _SYS11:     ;(BDOS)最初のファイルの検索
000830 D54E CDB2DC          17      CALL    SETDRV
000833 D551 CD0BDD          17      CALL    SOPEN
       D554                     _S12X1:
000836 D554 383A            12      JR  C,FEND
000838 D556 CDAADD          17      CALL    SOPENE2
00083B D559 ED5B8AF0        20      LD  DE,(_DTA)
00083F D55D 3A88F0          13      LD  A,(_DRV)
000842 D560 3C               4      INC A
000843 D561 12               7      LD  (DE),A
000844 D562 D5              11      PUSH    DE
000845 D563 13               6      INC DE
000846 D564 012000          10      LD  BC,32
000849 D567 EDB0                    LDIR
00084B D569 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
00084E D56C FD660F          19      LD  H,(IY+15)
000851 D56F 22F4F1          16      LD  (SCDIR),HL
000854 D572 2A9AF0          16      LD  HL,(_FBPS)
000857 D575 22F6F1          16      LD  (SFBPS),HL
00085A D578 2A9FF0          16      LD  HL,(_FILEN)
00085D D57B 7C               4      LD  A,H
00085E D57C B7               4      OR  A
00085F D57D 2806            12      JR  Z,_S12DIR
000861 D57F 3A22E6          13      LD  A,(_SECPS)
000864 D582 F680             7      OR  080H
000866 D584 67               4      LD  H,A
       D585                     _S12DIR:
000867 D585 22F8F1          16      LD  (SFNDF),HL  ;Directory position and Flags
00086A D588 E1              10      POP HL
00086B D589 1139F0          10      LD  DE,SFILE
00086E D58C 0E21             7      LD  C,33
       D58E                     _S11B:
000870 D58E EDB0                    LDIR
       D590                     FEND:
000872 D590 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D591                     FENDE:
000873 D591 FDE1            14      POP IY
000875 D593 C1              10      POP BC
000876 D594 D1              10      POP DE
000877 D595 E1              10      POP HL
000878 D596 C9              10      RET
                                
       D597                     _SYS12:     ;(BDOS)次のファイルの検索
000879 D597 E5              11      PUSH    HL
00087A D598 D5              11      PUSH    DE
00087B D599 C5              11      PUSH    BC
00087C D59A FDE5            15      PUSH    IY
00087E D59C CD6FDD          17      CALL    NOPEN
000881 D59F 18B3            12      JR  _S12X1
                                
       D5A1                     _S16K:
000883 D5A1 110000          10      LD  DE,0
       D5A2                     OFCB_SWC    EQU $-2
000886 D5A4 D5              11      PUSH    DE
000887 D5A5 061A             7      LD  B,26        ;First cluster
       D5A7                     S16K1:
000889 D5A7 13               6      INC DE
00088A D5A8 23               6      INC HL
00088B D5A9 10FC            13      DJNZ    S16K1
                                
00088D D5AB 1A               7      LD  A,(DE)
00088E D5AC BE               7      CP  (HL)
00088F D5AD 2015            12      JR  NZ,S16K2
000891 D5AF 13               6      INC DE
000892 D5B0 23               6      INC HL
000893 D5B1 1A               7      LD  A,(DE)
000894 D5B2 BE               7      CP  (HL)
000895 D5B3 200F            12      JR  NZ,S16K2
                                
000897 D5B5 E1              10      POP HL
000898 D5B6 FDE5            15      PUSH    IY
00089A D5B8 D1              10      POP DE
00089B D5B9 7E               7      LD  A,(HL)
00089C D5BA CDC7DC          17      CALL    IS_SAME_DRV_A_DE
00089F D5BD 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
0008A1 D5BF ED52            15      SBC HL,DE       ;CP HL,DE
0008A3 D5C1 37               4      SCF
0008A4 D5C2 C0              11      RET NZ
0008A5 D5C3 E5              11      PUSH    HL
       D5C4                     S16K2:
0008A6 D5C4 E1              10      POP HL
       D5C5                     S16K3:
0008A7 D5C5 FDE5            15      PUSH    IY
0008A9 D5C7 D1              10      POP DE
       D5C8                     _SYS13:     ;(BDOS)ファイルの削除
0008AA D5C8 CDB2DC          17      CALL    SETDRV
0008AD D5CB CD39DF          17      CALL    KILL
       D5CE                     FEND13:
0008B0 D5CE 18C0            12      JR  FEND
                                
       D5D0                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0008B2 D5D0 CDB2DC          17      CALL    SETDRV
0008B5 D5D3 CD75E4          17      CALL    INIT_SEQ
       D5D6                     SREAD:
0008B8 D5D6 CD47E4          17      CALL    RB_READ
                                
0008BB D5D9 C601             7      ADD A,001H
0008BD D5DB 38B3            12      JR  C,FEND
                                
0008BF D5DD 7D               4      LD  A,L
0008C0 D5DE D601             7      SUB 001H
       D5E0                     FENDX:
0008C2 D5E0 9F               4      SBC A,A
0008C3 D5E1 E603             7      AND 3
0008C5 D5E3 1F               4      RRA
0008C6 D5E4 18AB            12      JR  FENDE
                                
       D5E6                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
0008C8 D5E6 CDB2DC          17      CALL    SETDRV
0008CB D5E9 CD75E4          17      CALL    INIT_SEQ
       D5EC                     SWRITE:
0008CE D5EC CD42E4          17      CALL    RB_WRITE
                                
0008D1 D5EF C6FF             7      ADD A,0FFH
0008D3 D5F1 18ED            12      JR  FENDX
                                
       D5F3                     _SYS17:     ;(BDOS)ファイル名の変更
0008D5 D5F3 CDB2DC          17      CALL    SETDRV
0008D8 D5F6 CD8FDF          17      CALL    NAME
0008DB D5F9 18D3            12      JR  FEND13
                                
       D5FB                     _SYS16:     ;(BDOS)ファイルの作成
0008DD D5FB CDB2DC          17      CALL    SETDRV
                                
0008E0 D5FE CD01E0          17      CALL    CHKWILDX
0008E3 D601 38CB            12      JR  C,FEND13
0008E5 D603 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
0008E8 D606 FE05             7      CP  5
0008EA D608 2805            12      JR  Z,_S16X2
0008EC D60A FE21             7      CP  021H
0008EE D60C DACED5          10      JP  C,FEND13
       D60F                     _S16X2:
                                ;               Clear FCB
0008F1 D60F FDE5            15      PUSH    IY
0008F3 D611 E1              10      POP HL
0008F4 D612 011000          10      LD  BC,16
0008F7 D615 09              11      ADD HL,BC
       D616                     _S16X1:
0008F8 D616 70               7      LD  (HL),B      ;B=0
0008F9 D617 23               6      INC HL
0008FA D618 0D               4      DEC C
0008FB D619 20FB            12      JR  NZ,_S16X1
                                
0008FD D61B CD02E1          17      CALL    SETTMSX
000900 D61E FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000904 D622 CDDCDC          17      CALL    SOPENX
000907 D625 3F               4      CCF
000908 D626 CCA1D5          17      CALL    Z,_S16K
00090B D629 D4BBDD          17      CALL    NC,COPEN
00090E D62C D411E0          17      CALL    NC,SDIRENT
000911 D62F C3C3D4          10      JP  _S16XX
                                
       D632                     _SYS21:     ;(BDOS)ランダムな読み出し
000914 D632 CDB2DC          17      CALL    SETDRV
000917 D635 CD4DE1          17      CALL    INIT_RND
00091A D638 189C            12      JR  SREAD
                                
       D63A                     _SYS22:     ;(BDOS)ランダムな書き込み
       D63A                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
00091C D63A CDB2DC          17      CALL    SETDRV
00091F D63D CD4DE1          17      CALL    INIT_RND
000922 D640 18AA            12      JR  SWRITE
                                
       D642                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000924 D642 21FF00          10      LD  HL,000FFH
000927 D645 AF               4      XOR A
000928 D646 C9              10      RET
                                
       D647                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000929 D647 3A0400          13      LD  A,(_DVSW)   ;from LDOS
00092C D64A A7               4      AND A
00092D D64B C9              10      RET
                                
       D64C                     _SYS1A:     ;(BDOS)DTAの設定
00092E D64C ED538AF0        20      LD  (_DTA),DE
000932 D650 AF               4      XOR A
000933 D651 C9              10      RET
                                
       D652                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000934 D652 7B               4      LD  A,E
000935 D653 CDC0DC          17      CALL    GETDRV
000938 D656 CDDCF0          17      CALL    _GETDPB
00093B D659 D4E2F0          17      CALL    NC,_RDFATX
00093E D65C 210000          10      LD  HL,0
000941 D65F D4DBE0          17      CALL    NC,DSKF
                                
000944 D662 ED5BDCE0        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000948 D666 1B               6      DEC DE      ;DE←クラスタの総数
000949 D667 FD2A7CF1        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
00094D D66B 9F               4      SBC A,A
00094E D66C D8              11      RET C
00094F D66D 4F               4      LD  C,A     ;C=0
000950 D66E DD7E0F          19      LD  A,(IX+DPB_BPS)
000953 D671 E607             7      AND 7
000955 D673 47               4      LD  B,A
000956 D674 DD7E07          19      LD  A,(IX+DPB_SECPCL)
000959 D677 C9              10      RET
                                
       D678                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
00095A D678 AF               4      XOR A
00095B D679 67               4      LD  H,A
00095C D67A 6F               4      LD  L,A
00095D D67B C9              10      RET
                                
       D67C                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
00095E D67C 2100F2          10      LD  HL,_DEVICE
000961 D67F 7B               4      LD  A,E
000962 D680 C3DCF0          10      JP  _GETDPB
                                
       D683                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000965 D683 E5              11      PUSH    HL
000966 D684 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000968 D686 CD48D4          17      CALL    BDOS0
00096B D689 381B            12      JR  C,_S23X1
                                
00096D D68B D5              11      PUSH    DE      ;EX DE,IY
00096E D68C FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000970 D68E FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000973 D691 FD6E11          19      LD  L,(IY+17)   ;
000976 D694 FD6612          19      LD  H,(IY+18)   ;
000979 D697 C5              11      PUSH    BC      ;
00097A D698 FD4613          19      LD  B,(IY+19)   ;
00097D D69B CD3FE1          17      CALL    GET_CPM_R_SIZE
000980 D69E C1              10      POP BC
       D69F                     _S24X1:
000981 D69F CD5FE1          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000984 D6A2 FDE3            23      EX  (SP),IY     ;
000986 D6A4 D1              10      POP DE      ;
                                
000987 D6A5 AF               4      XOR A
       D6A6                     _S23X1:
000988 D6A6 E1              10      POP HL
000989 D6A7 C9              10      RET
                                
       D6A8                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
00098A D6A8 E5              11      PUSH    HL
00098B D6A9 D5              11      PUSH    DE      ;EX DE,IY
00098C D6AA FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00098E D6AC CD7DE4          17      CALL    GETSEQ
000991 D6AF 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D6B1                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000993 D6B1 2B               6      DEC HL
       D6B2                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000994 D6B2 C5              11      PUSH    BC
000995 D6B3 E5              11      PUSH    HL
000996 D6B4 CDCADB          17      CALL    FILE
000999 D6B7 E1              10      POP HL
00099A D6B8 C1              10      POP BC
       D6B9                     S29X1:
00099B D6B9 C5              11      PUSH    BC
00099C D6BA D5              11      PUSH    DE
00099D D6BB E5              11      PUSH    HL
00099E D6BC EB               4      EX  DE,HL
00099F D6BD AF               4      XOR A
0009A0 D6BE 3221F0          13      LD  (FDRV+13),A
0009A3 D6C1 2114F0          10      LD  HL,FDRV
0009A6 D6C4 011000          10      LD  BC,16
0009A9 D6C7 EDB0                    LDIR
0009AB D6C9 E1              10      POP HL
0009AC D6CA D1              10      POP DE
0009AD D6CB C1              10      POP BC
0009AE D6CC C9              10      RET
                                
       D6CD                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
0009AF D6CD C5              11      PUSH    BC
0009B0 D6CE 01C1E7          10      LD  BC,DWT24B
0009B3 D6D1 1804            12      JR  S2FX
       D6D3                     _SYS2F:
0009B5 D6D3 C5              11      PUSH    BC
0009B6 D6D4 01B3E7          10      LD  BC,DRD24B
       D6D7                     S2FX:
0009B9 D6D7 ED43EDD6        20      LD  (S2F_SWC),BC
0009BD D6DB CDDFF0          17      CALL    _FFLUSH
                                
0009C0 D6DE D5              11      PUSH    DE
0009C1 D6DF E5              11      PUSH    HL
0009C2 D6E0 7D               4      LD  A,L     ;Drive
0009C3 D6E1 CDD9F0          17      CALL    _CHGDRV
0009C6 D6E4 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
0009C8 D6E6 44               4      LD  B,H     ;Number of clusters
0009C9 D6E7 2A8AF0          16      LD  HL,(_DTA)
                                
0009CC D6EA 0E00             7      LD  C,0
0009CE D6EC CDB3E7          17      CALL    DRD24B
       D6ED                     S2F_SWC EQU $-2
       D6EF                     POP_HL_DE_BC_SBCAA_RET:
0009D1 D6EF E1              10      POP HL
0009D2 D6F0 D1              10      POP DE
0009D3 D6F1 C1              10      POP BC
0009D4 D6F2 9F               4      SBC A,A
0009D5 D6F3 C9              10      RET
                                
       D6F4                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
0009D6 D6F4 C5              11      PUSH    BC
0009D7 D6F5 D5              11      PUSH    DE
0009D8 D6F6 E5              11      PUSH    HL
0009D9 D6F7 CDBFDB          17      CALL    FILEC
0009DC D6FA 21EFD6          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
0009DF D6FD E5              11      PUSH    HL
0009E0 D6FE 3A21F0          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
0009E3 D701 E610             7      AND 010H        ;ディレクトリ
0009E5 D703 37               4      SCF
0009E6 D704 C8              11      RET Z
0009E7 D705 1114F0          10      LD  DE,FDRV
0009EA D708 2A4EF1          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       D70B                     JPHL:
0009ED D70B E9               4      JP  (HL)
                                
       D70C                     SHOW_ERROR:         ;(9)
0009EE D70C 1179F0          10      LD  DE,COMERM
0009F1 D70F CD79D4          17      CALL    _SYS09      ;(BDOS)文字列出力
0009F4 D712 C300F0          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "M7IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                
       D477                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D477                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D477                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D477                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D477                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D477                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
                                #IF EXISTS USE_8253
       D715                     ARWKEY:
0009F7 D715 3D               4      DEC A
0009F8 D716 3231D7          13      LD  (KEYAR),A
0009FB D719 1826            12      JR  INT8253E
       D71B                     SETKEY1:
0009FD D71B 3A95F0          13      LD  A,(_KEYSP_H)
000A00 D71E 1815            12      JR  SETKEY
       D720                     INT8253:
000A02 D720 CD28DB          17      CALL    CHKEY
000A05 D723 FE00             7      CP  0
       D724                     KEYDT   EQU $-1
000A07 D725 20F4            12      JR  NZ,SETKEY1
000A09 D727 E5              11      PUSH    HL
000A0A D728 2A90F0          16      LD  HL,(_KEYPS)
000A0D D72B 7C               4      LD  A,H
000A0E D72C AD               4      XOR L
000A0F D72D E1              10      POP HL
000A10 D72E 2011            12      JR  NZ,INT8253E
000A12 D730 3E00             7      LD  A,0
       D731                     KEYAR   EQU $-1
000A14 D732 B7               4      OR  A
000A15 D733 20E0            12      JR  NZ,ARWKEY
       D735                     SETKEY:
000A17 D735 3231D7          13      LD  (KEYAR),A
000A1A D738 CD02DB          17      CALL    GETKEYD
000A1D D73B 3224D7          13      LD  (KEYDT),A
000A20 D73E CD4BD7          17      CALL    KEYSET
       D741                     INT8253E:
000A23 D741 3E00             7      LD  A,0
       D742                     INTMEM_SWC  EQU $-1
000A25 D743 FEC9             7      CP  0C9H        ;RAMの場合はEXTBIOにRETが入っている
000A27 D745 C225CF          10      JP  NZ,ROM8253E
000A2A D748 F1              10      POP AF
000A2B D749 FB               4      EI
000A2C D74A C9              10      RET
       D74B                     KEYSET:
       D74B                     KEYBS:
000A2D D74B B7               4      OR  A
000A2E D74C C8              11      RET Z
       D74D                     KEYBS1:
000A2F D74D CD65D7          17      CALL    KEYBC_IFBREAK
000A32 D750 E5              11      PUSH    HL
000A33 D751 F5              11      PUSH    AF
000A34 D752 2A90F0          16      LD  HL,(_KEYPS)
000A37 D755 2C               4      INC L
000A38 D756 CBAD             8      RES 5,L
000A3A D758 7D               4      LD  A,L
000A3B D759 BC               4      CP  H
000A3C D75A 2815            12      JR  Z,POP_AF_HL_SCF_RET
000A3E D75C 3290F0          13      LD  (_KEYPS),A
000A41 D75F 26F3             7      LD  H,HIGH KEYBF
000A43 D761 F1              10      POP AF
000A44 D762 77               7      LD  (HL),A
000A45 D763 E1              10      POP HL
000A46 D764 C9              10      RET
       D765                     KEYBC_IFBREAK:
000A47 D765 FE03             7      CP  3
000A49 D767 C0              11      RET NZ
       D768                     KEYBC:
000A4A D768 E5              11      PUSH    HL
000A4B D769 210000          10      LD  HL,0
000A4E D76C 2290F0          16      LD  (_KEYPS),HL
000A51 D76F E1              10      POP HL
000A52 D770 C9              10      RET
                                #ENDIF
                                
       D771                     POP_AF_HL_SCF_RET:
000A53 D771 F1              10      POP AF
000A54 D772 E1              10      POP HL
000A55 D773 37               4      SCF
                                #IF EXISTS USE_8253
                                #ELSE
                                KEYBC_IFBREAK:
                                #ENDIF
000A56 D774 C9              10      RET
                                
       D775                     _SYS01:     ;(BDOS)コンソール入力
000A57 D775 CD09F0          17      CALL    _SYS07
       D778                     MSG_A:
000A5A D778 F5              11      PUSH    AF
000A5B D779 D5              11      PUSH    DE
000A5C D77A 5F               4      LD  E,A
000A5D D77B CD81D7          17      CALL    _SYS02
000A60 D77E D1              10      POP DE
000A61 D77F F1              10      POP AF
000A62 D780 C9              10      RET
                                
       D781                     _SYS02:     ;(BDOS)コンソール出力
000A63 D781 CD93D7          17      CALL    BREAK
000A66 D784 1805            12      JR  PRINTX
                                
       D786                     _SYS06:     ;(BDOS)コンソール直接入出力
000A68 D786 7B               4      LD  A,E
000A69 D787 3C               4      INC A
000A6A D788 CACAF0          10      JP  Z,_INKEY
       D78B                     PRINTX:
000A6D D78B C3CDF0          10      JP  _PRINT
                                
       D78E                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000A70 D78E CD09F0          17      CALL    _SYS07
000A73 D791 1804            12      JR  BREAK1
       D793                     BREAK:
                                #IF EXISTS USE_8253
000A75 D793 FB               4      EI
000A76 D794 3A92F0          13      LD  A,(_KEYD)
                                #ELSE
                                    CALL    CHKEY
                                #ENDIF
       D797                     BREAK1:
000A79 D797 FE03             7      CP  3       ;CTRL+C
000A7B D799 CCF4F0          17      CALL    Z,_BREAK
000A7E D79C FE13             7      CP  013H        ;CTRL+S
000A80 D79E C0              11      RET NZ
                                
       D79F                     PAUSE:
                                #IF EXISTS USE_8253
000A81 D79F CD68D7          17      CALL    KEYBC
                                #ENDIF
                                
       D7A2                     FLGET:
000A84 D7A2 CDDFF0          17      CALL    _FFLUSH
000A87 D7A5 E5              11      PUSH    HL
000A88 D7A6 2A8EF0          16      LD  HL,(_TXADR)
000A8B D7A9 7C               4      LD  A,H
000A8C D7AA C6D0             7      ADD A,0D0H
000A8E D7AC 67               4      LD  H,A
000A8F D7AD CD59CF          17      CALL    RDMMIO
000A92 D7B0 32C5D7          13      LD  (FLSMC),A
       D7B3                     FLGET1:
000A95 D7B3 CD4FCF          17      CALL    RD556VSYNC
000A98 D7B6 CB77             8      BIT 6,A
000A9A D7B8 3EEF             7      LD  A,0EFH      ;カーソル
000A9C D7BA 280A            12      JR  Z,FLGET2
000A9E D7BC CD02DB          17      CALL    GETKEYD
000AA1 D7BF B7               4      OR  A
000AA2 D7C0 3EEF             7      LD  A,0EFH      ;カーソル
000AA4 D7C2 2002            12      JR  NZ,FLGET2
000AA6 D7C4 3E00             7      LD  A,0     ;自己書き換え
       D7C5                     FLSMC   EQU $-1
       D7C6                     FLGET2:
000AA8 D7C6 CD61CF          17      CALL    WRMMIO
000AAB D7C9 CDCAF0          17      CALL    _INKEY
000AAE D7CC 28E5            12      JR  Z,FLGET1
000AB0 D7CE F5              11      PUSH    AF
000AB1 D7CF 3AC5D7          13      LD  A,(FLSMC)
000AB4 D7D2 CD61CF          17      CALL    WRMMIO
000AB7 D7D5 F1              10      POP AF
000AB8 D7D6 E1              10      POP HL
000AB9 D7D7 C9              10      RET
                                
       D7D8                     _SYS0A:     ;(BDOS)文字列入力
000ABA D7D8 C5              11      PUSH    BC
000ABB D7D9 E5              11      PUSH    HL
000ABC D7DA D5              11      PUSH    DE
000ABD D7DB CD79DA          17      CALL    GETL
000AC0 D7DE 1130FF          10      LD  DE,KBUF
000AC3 D7E1 E1              10      POP HL
000AC4 D7E2 E5              11      PUSH    HL
000AC5 D7E3 0E00             7      LD  C,0
000AC7 D7E5 3004            12      JR  NC,SAX0
000AC9 D7E7 23               6      INC HL
000ACA D7E8 23               6      INC HL
000ACB D7E9 1808            12      JR  SAX4
       D7EB                     SAX0:
000ACD D7EB 46               7      LD  B,(HL)
000ACE D7EC 23               6      INC HL
       D7ED                     SAX1:
000ACF D7ED 23               6      INC HL
000AD0 D7EE 1A               7      LD  A,(DE)
000AD1 D7EF 13               6      INC DE
000AD2 D7F0 B7               4      OR  A
000AD3 D7F1 2004            12      JR  NZ,SAX2
       D7F3                     SAX4:
000AD5 D7F3 360D            10      LD  (HL),00DH
000AD7 D7F5 1804            12      JR  SAX3
       D7F7                     SAX2:
000AD9 D7F7 77               7      LD  (HL),A
000ADA D7F8 0C               4      INC C
000ADB D7F9 10F2            13      DJNZ    SAX1
       D7FB                     SAX3:
000ADD D7FB D1              10      POP DE
000ADE D7FC 79               4      LD  A,C
000ADF D7FD 13               6      INC DE
000AE0 D7FE 12               7      LD  (DE),A
000AE1 D7FF 1B               6      DEC DE
000AE2 D800 E1              10      POP HL
000AE3 D801 C1              10      POP BC
000AE4 D802 A7               4      AND A
000AE5 D803 C9              10      RET
                                
       D804                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000AE6 D804 CD93D7          17      CALL    BREAK
000AE9 D807 B7               4      OR  A
000AEA D808 C8              11      RET Z
                                
       D809                     CONSTX:
000AEB D809 CDDFF0          17      CALL    _FFLUSH
                                #IF EXISTS USE_8253
000AEE D80C E5              11      PUSH    HL
000AEF D80D 2A90F0          16      LD  HL,(_KEYPS)
000AF2 D810 7C               4      LD  A,H
000AF3 D811 AD               4      XOR L
000AF4 D812 E1              10      POP HL
000AF5 D813 C6FF             7      ADD A,0FFH
                                #ELSE
                                    XOR A
                                    LD  (SKIP_KEYWAIT),A
                                    CALL    CHKEY
                                    RET Z
                                    SCF
                                #ENDIF
000AF7 D815 9F               4      SBC A,A
000AF8 D816 C9              10      RET
                                
       D817                     _SYS2A:     ;(BDOS)日付の獲得
       D817                     _SYS2C:     ;(BDOS)時刻の獲得
000AF9 D817 AF               4      XOR A
000AFA D818 57               4      LD  D,A
000AFB D819 5F               4      LD  E,A
000AFC D81A 67               4      LD  H,A
000AFD D81B 6F               4      LD  L,A
000AFE D81C C9              10      RET
                                
       D81D                     ESC1:
000AFF D81D 7B               4      LD  A,E
000B00 D81E FE41             7      CP  'A'
000B02 D820 CA15D9          10      JP  Z,CTRL1E
000B05 D823 FE42             7      CP  'B'
000B07 D825 CA3CDA          10      JP  Z,CTRL1F
000B0A D828 FE43             7      CP  'C'
000B0C D82A CAE8D8          10      JP  Z,CTRL1C
000B0F D82D FE44             7      CP  'D'
000B11 D82F CA0CD9          10      JP  Z,CTRL1D
000B14 D832 FE45             7      CP  'E'
000B16 D834 2802            12      JR  Z,CT0CX
000B18 D836 FE6A             7      CP  'j'
       D838                     CT0CX:
000B1A D838 CA21DA          10      JP  Z,CTRL0C
000B1D D83B FE48             7      CP  'H'
000B1F D83D CA8ED9          10      JP  Z,CTRL0B
000B22 D840 FE4A             7      CP  'J'
000B24 D842 CA24DA          10      JP  Z,CTRL06
000B27 D845 FE4B             7      CP  'K'
000B29 D847 CA60D9          10      JP  Z,CTRL05
000B2C D84A FE4C             7      CP  'L'
000B2E D84C CA4EDA          10      JP  Z,CTRL0E
000B31 D84F FE54             7      CP  'T'
000B33 D851 CA60D9          10      JP  Z,CTRL05
000B36 D854 FE78             7      CP  'x'
000B38 D856 2804            12      JR  Z,ESC1X
000B3A D858 FE79             7      CP  'y'
000B3C D85A 2002            12      JR  NZ,ESC1Y
       D85C                     ESC1X:
000B3E D85C 3601            10      LD  (HL),1
       D85E                     ESC1Y:
000B40 D85E FE3D             7      CP  '='
000B42 D860 2804            12      JR  Z,ESC1W
000B44 D862 FE59             7      CP  'Y'
000B46 D864 2002            12      JR  NZ,ESC1Z
       D866                     ESC1W:
000B48 D866 3602            10      LD  (HL),2
       D868                     ESC1Z:
000B4A D868 FE20             7      CP  020H
000B4C D86A 3802            12      JR  C,ESC1C
000B4E D86C 87               4      ADD A,A
000B4F D86D D0              11      RET NC
       D86E                     ESC1C:
000B50 D86E E1              10      POP HL
000B51 D86F 1832            12      JR  ANK
                                
       D871                     ESC:
000B53 D871 21D4D8          10      LD  HL,PRINTE5
000B56 D874 E5              11      PUSH    HL
000B57 D875 2197D8          10      LD  HL,ESCFLG
000B5A D878 3600            10      LD  (HL),0
000B5C D87A 3D               4      DEC A
000B5D D87B 28A0            12      JR  Z,ESC1
000B5F D87D 3D               4      DEC A
000B60 D87E 2009            12      JR  NZ,ESC2
000B62 D880 3603            10      LD  (HL),3
000B64 D882 7B               4      LD  A,E
000B65 D883 D620             7      SUB 020H
000B67 D885 328CD8          13      LD  (ESCYP+1),A
000B6A D888 C9              10      RET
       D889                     ESC2:
000B6B D889 3D               4      DEC A
000B6C D88A C0              11      RET NZ
000B6D D88B 2600             7  ESCYP:  LD  H,0
000B6F D88D 7B               4      LD  A,E
000B70 D88E D620             7      SUB 020H
000B72 D890 6F               4      LD  L,A
000B73 D891 C3D6F0          10      JP  _LOC
                                
       D894                     PRINT:
000B76 D894 C5              11      PUSH    BC
000B77 D895 E5              11      PUSH    HL
000B78 D896 3E00             7      LD  A,000H      ;自己書き換え
       D897                     ESCFLG  EQU $-1
000B7A D898 B7               4      OR  A
000B7B D899 20D6            12      JR  NZ,ESC
                                
000B7D D89B 3E1F             7      LD  A,01FH
000B7F D89D BB               4      CP  E
000B80 D89E 3038            12      JR  NC,CTRL
       D8A0                     INSFLG  EQU $
000B82 D8A0 01EAD9          10      LD  BC,INSERT   ;自己書き換え
       D8A3                     ANK:
000B85 D8A3 3A96F0          13      LD  A,(_COLORF)
000B88 D8A6 4F               4      LD  C,A
000B89 D8A7 7B               4      LD  A,E
000B8A D8A8 FE61             7      CP  'a'     ;英小文字
000B8C D8AA 3806            12      JR  C,PRT1
000B8E D8AC FE7B             7      CP  'z'+1
000B90 D8AE 3002            12      JR  NC,PRT1
000B92 D8B0 CBF9             8      SET 7,C
       D8B2                     PRT1:
000B94 D8B2 FE86             7      CP  $86     ;ひらがな1(を－そ)
000B96 D8B4 3806            12      JR  C,PRT2
000B98 D8B6 FEA0             7      CP  $A0
000B9A D8B8 3002            12      JR  NC,PRT2
000B9C D8BA CBF9             8      SET 7,C
       D8BC                     PRT2:
000B9E D8BC FEE0             7      CP  $E0     ;ひらがな2(たーん)
000BA0 D8BE 3802            12      JR  C,PRT3
000BA2 D8C0 CBF9             8      SET 7,C
       D8C2                     PRT3:
000BA4 D8C2 2A8EF0          16      LD  HL,(_TXADR)
000BA7 D8C5 7C               4      LD  A,H
000BA8 D8C6 C6D0             7      ADD A,0D0H
000BAA D8C8 67               4      LD  H,A
000BAB D8C9 42               4      LD  B,D
000BAC D8CA 16EE             7      LD  D,HIGH CD_TABLE
000BAE D8CC 1A               7      LD  A,(DE)
000BAF D8CD 50               4      LD  D,B
000BB0 D8CE CD79CF          17      CALL    IO_PRINT
000BB3 D8D1 CDE8D8          17      CALL    CTRL1C
       D8D4                     PRINTE5:
000BB6 D8D4 E1              10      POP HL
000BB7 D8D5 C1              10      POP BC
000BB8 D8D6 AF               4      XOR A
000BB9 D8D7 C9              10      RET
                                
       D8D8                     CTRL:
000BBA D8D8 7B               4      LD  A,E
000BBB D8D9 87               4      ADD A,A
000BBC D8DA F680             7      OR  080H
000BBE D8DC 6F               4      LD  L,A
000BBF D8DD 26F1             7      LD  H,HIGH CTRLTB
000BC1 D8DF 7E               7      LD  A,(HL)
000BC2 D8E0 2C               4      INC L
000BC3 D8E1 66               7      LD  H,(HL)
000BC4 D8E2 6F               4      LD  L,A
000BC5 D8E3 CD0BD7          17      CALL    JPHL
000BC8 D8E6 18EC            12      JR  PRINTE5
                                
       D8E8                     CTRL1C:
000BCA D8E8 ED4B8EF0        20      LD  BC,(_TXADR)
000BCE D8EC 03               6      INC BC
       D8ED                     PRINTE3:
000BCF D8ED 2118FC          10      LD  HL,0-WIDTH*LINE
000BD2 D8F0 A7               4      AND A
000BD3 D8F1 ED4A            15      ADC HL,BC
       D8F3                     PRINTE8:
000BD5 D8F3 2805            12      JR  Z,PRINT2
000BD7 D8F5 ED438EF0        20      LD  (_TXADR),BC
       D8F9                     CTRL00:
000BDB D8F9 C9              10      RET
                                
       D8FA                     PRINT2:
000BDC D8FA CD54DA          17      CALL    SCR
000BDF D8FD 21D8FF          10      LD  HL,0-WIDTH
000BE2 D900 09              11      ADD HL,BC
       D901                     SET_TXADR_HL:
000BE3 D901 228EF0          16      LD  (_TXADR),HL
000BE6 D904 C9              10      RET
                                
       D905                     CTRL08:
000BE7 D905 3AA0D8          13      LD  A,(INSFLG)
000BEA D908 FECD             7      CP  0CDH        ;CALL ????
000BEC D90A 2823            12      JR  Z,CTRL02
       D90C                     CTRL1D:
000BEE D90C 2A8EF0          16      LD  HL,(_TXADR)
000BF1 D90F 7C               4      LD  A,H
000BF2 D910 B5               4      OR  L
000BF3 D911 C8              11      RET Z
000BF4 D912 2B               6      DEC HL
000BF5 D913 18EC            12      JR  SET_TXADR_HL
                                
       D915                     CTRL1E:
000BF7 D915 ED4B8EF0        20      LD  BC,(_TXADR)
000BFB D919 21D8FF          10      LD  HL,0-WIDTH
000BFE D91C 09              11      ADD HL,BC
000BFF D91D D0              11      RET NC
000C00 D91E 18E1            12      JR  SET_TXADR_HL
                                
       D920                     CTRL09:
000C02 D920 ED4B8EF0        20      LD  BC,(_TXADR)
000C06 D924 79               4      LD  A,C
000C07 D925 E6F8             7      AND 0F8H
000C09 D927 C608             7      ADD A,8
000C0B D929 4F               4      LD  C,A
000C0C D92A 88               4      ADC A,B
000C0D D92B 91               4      SUB C
000C0E D92C 47               4      LD  B,A
000C0F D92D 18BE            12      JR  PRINTE3
                                
       D92F                     CTRL02:
000C11 D92F CD0CD9          17      CALL    CTRL1D
000C14 D932 C8              11      RET Z
000C15 D933 D5              11      PUSH    DE
000C16 D934 CDD3F0          17      CALL    _POS
000C19 D937 54               4      LD  D,H
000C1A D938 3E28             7      LD  A,WIDTH
000C1C D93A 95               4      SUB L
000C1D D93B 4F               4      LD  C,A
000C1E D93C 0D               4      DEC C
000C1F D93D 06D0             7      LD  B,0D0H
000C21 D93F 2A8EF0          16      LD  HL,(_TXADR)
000C24 D942 09              11      ADD HL,BC
000C25 D943 47               4      LD  B,A
                                
000C26 D944 3A0BDA          13      LD  A,(MULINE)
000C29 D947 BA               4      CP  D
000C2A D948 2007            12      JR  NZ,C02X1
000C2C D94A 112800          10      LD  DE,WIDTH
000C2F D94D 19              11      ADD HL,DE
000C30 D94E 78               4      LD  A,B
000C31 D94F 83               4      ADD A,E
000C32 D950 47               4      LD  B,A
       D951                     C02X1:
000C33 D951 3A96F0          13      LD  A,(_COLORF) ;C:Color
000C36 D954 4F               4      LD  C,A
000C37 D955 3E                      DB  03EH        ;LD A,?
000C38 D956 2B               6      DEC HL
000C39 D957 32C0CF          13      LD  (IO_INCDEC),A
000C3C D95A AF               4      XOR A       ;A:Text
000C3D D95B CDB3CF          17      CALL    IO_INSBS
000C40 D95E D1              10      POP DE
000C41 D95F C9              10      RET
                                
       D960                     CTRL05:
000C42 D960 CDD3F0          17      CALL    _POS
000C45 D963 3E28             7      LD  A,WIDTH
000C47 D965 95               4      SUB L
000C48 D966 47               4      LD  B,A
       D967                     C08X1:
000C49 D967 2A8EF0          16      LD  HL,(_TXADR)
000C4C D96A 7C               4      LD  A,H
000C4D D96B C6D0             7      ADD A,0D0H
000C4F D96D 67               4      LD  H,A
       D96E                     CLLINE:
000C50 D96E 3A96F0          13      LD  A,(_COLORF)
000C53 D971 4F               4      LD  C,A
000C54 D972 AF               4      XOR A
000C55 D973 C3A3CF          10      JP  IO_CLLINE
                                
       D976                     CTRL0D:
000C58 D976 CDD3F0          17      CALL    _POS
000C5B D979 2E00             7      LD  L,0
       D97B                     LOC:
000C5D D97B C5              11      PUSH    BC
000C5E D97C E5              11      PUSH    HL
000C5F D97D CD9BD9          17      CALL    LOC1
000C62 D980 228EF0          16      LD  (_TXADR),HL
000C65 D983 E1              10      POP HL
000C66 D984 C1              10      POP BC
000C67 D985 C9              10      RET
                                
       D986                     CTRL12:
000C68 D986 21A0D8          10      LD  HL,INSFLG
000C6B D989 7E               7      LD  A,(HL)
000C6C D98A EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000C6E D98C 77               7      LD  (HL),A
000C6F D98D C9              10      RET
                                
       D98E                     CTRL0B:
000C70 D98E 210000          10      LD  HL,0
000C73 D991 228EF0          16      LD  (_TXADR),HL
000C76 D994 C9              10      RET
                                
       D995                     CTRL1B:
000C77 D995 3E01             7      LD  A,1
000C79 D997 3297D8          13      LD  (ESCFLG),A
000C7C D99A C9              10      RET
                                
       D99B                     LOC1:
000C7D D99B D5              11      PUSH    DE
000C7E D99C 4D               4      LD  C,L
000C7F D99D 0608             7      LD  B,8
000C81 D99F 5C               4      LD  E,H
000C82 D9A0 210028          10      LD  HL,WIDTH*256
000C85 D9A3 55               4      LD  D,L ;L=0
       D9A4                     LOC2:
000C86 D9A4 29              11      ADD HL,HL
000C87 D9A5 3001            12      JR  NC,LOC3
000C89 D9A7 19              11      ADD HL,DE
       D9A8                     LOC3:
000C8A D9A8 10FA            13      DJNZ    LOC2
000C8C D9AA 09              11      ADD HL,BC
000C8D D9AB D1              10      POP DE
000C8E D9AC C9              10      RET
                                
       D9AD                     CONOUT1:
                                ;   CALL    CURSOR
000C8F D9AD 59               4      LD  E,C
000C90 D9AE CDCDF0          17      CALL    _PRINT
000C93 D9B1 7B               4      LD  A,E
000C94 D9B2 FE0A             7      CP  00AH
000C96 D9B4 2006            12      JR  NZ,CURSOR
000C98 D9B6 CD76D9          17      CALL    CTRL0D
000C9B D9B9 CD60D9          17      CALL    CTRL05
       D9BC                     CURSOR:
000C9E D9BC C9              10      RET
                                
       D9BD                     CTRL07:
000C9F D9BD 06E0             7      LD  B,0E0H
000CA1 D9BF 2162F0          10      LD  HL,BEEPD+1
       D9C2                     C07X0:
000CA4 D9C2 4E               7      LD  C,(HL)
000CA5 D9C3 23               6      INC HL
000CA6 D9C4 7E               7      LD  A,(HL)
000CA7 D9C5 23               6      INC HL
000CA8 D9C6 CD71CF          17      CALL    WRMMIO_BC
000CAB D9C9 7D               4      LD  A,L
000CAC D9CA FE6C             7      CP  (BEEPD+1+M7BEEPE-M7BEEPD)&255
000CAE D9CC 20F4            12      JR  NZ,C07X0
000CB0 D9CE 0610             7      LD  B,16
       D9D0                     C07X1:
000CB2 D9D0 CD4FCF          17      CALL    RD556VSYNC
000CB5 D9D3 87               4      ADD A,A
000CB6 D9D4 30FA            12      JR  NC,C07X1
       D9D6                     C07X2:
000CB8 D9D6 CD4FCF          17      CALL    RD556VSYNC
000CBB D9D9 87               4      ADD A,A
000CBC D9DA 38FA            12      JR  C,C07X2
000CBE D9DC 10F2            13      DJNZ    C07X1
                                
000CC0 D9DE AF               4      XOR A
000CC1 D9DF 2108E0          10      LD  HL,0E008H
000CC4 D9E2 CD61CF          17      CALL    WRMMIO
000CC7 D9E5 2E03             7      LD  L,003H      ;SOUND MASK (MZ-1500)
000CC9 D9E7 C361CF          10      JP  WRMMIO
                                
       D9EA                     INSERT:
000CCC D9EA D5              11      PUSH    DE
000CCD D9EB CDD3F0          17      CALL    _POS
000CD0 D9EE 54               4      LD  D,H
000CD1 D9EF 3E28             7      LD  A,WIDTH
000CD3 D9F1 95               4      SUB L
000CD4 D9F2 47               4      LD  B,A
000CD5 D9F3 2A8EF0          16      LD  HL,(_TXADR)
000CD8 D9F6 7C               4      LD  A,H
000CD9 D9F7 C6D0             7      ADD A,0D0H
000CDB D9F9 67               4      LD  H,A
000CDC D9FA 3A96F0          13      LD  A,(_COLORF) ;C:Color
000CDF D9FD 4F               4      LD  C,A
000CE0 D9FE 3E                      DB  03EH        ;LD A,?
000CE1 D9FF 23               6      INC HL
000CE2 DA00 32C0CF          13      LD  (IO_INCDEC),A
000CE5 DA03 AF               4      XOR A       ;A:Text
000CE6 DA04 CDB3CF          17      CALL    IO_INSBS
000CE9 DA07 B7               4      OR  A
000CEA DA08 2005            12      JR  NZ,INS1
       DA0B                     MULINE  EQU $+1
000CEC DA0A 3EFF             7      LD  A,-1
000CEE DA0C 92               4      SUB D
000CEF DA0D 2010            12      JR  NZ,INS2
       DA0F                     INS1:
000CF1 DA0F 0628             7      LD  B,WIDTH
000CF3 DA11 F5              11      PUSH    AF
000CF4 DA12 3E                      DB  03EH        ;LD A,?
000CF5 DA13 23               6      INC HL
000CF6 DA14 32C0CF          13      LD  (IO_INCDEC),A
000CF9 DA17 F1              10      POP AF
000CFA DA18 CDB3CF          17      CALL    IO_INSBS
000CFD DA1B 7A               4      LD  A,D
000CFE DA1C 320BDA          13      LD  (MULINE),A
       DA1F                     INS2:
000D01 DA1F D1              10      POP DE
000D02 DA20 C9              10      RET
                                
       DA21                     CTRL0C:
000D03 DA21 CD8ED9          17      CALL    CTRL0B
       DA24                     CTRL06:
000D06 DA24 D5              11      PUSH    DE
000D07 DA25 E5              11      PUSH    HL
000D08 DA26 ED5B8EF0        20      LD  DE,(_TXADR)
000D0C DA2A 3A96F0          13      LD  A,(_COLORF)
000D0F DA2D 3290CF          13      LD  (ICSMC),A
000D12 DA30 C384CF          10      JP  IO_CLR
                                
       DA33                     CTRL04:
000D15 DA33 CDD3F0          17      CALL    _POS
000D18 DA36 7D               4      LD  A,L
000D19 DA37 B7               4      OR  A
000D1A DA38 C8              11      RET Z
       DA39                     CTRL03:
000D1B DA39 CD76D9          17      CALL    CTRL0D
       DA3C                     CTRL0A:
       DA3C                     CTRL1F:
000D1E DA3C 2A8EF0          16      LD  HL,(_TXADR)
000D21 DA3F 012800          10      LD  BC,WIDTH
000D24 DA42 09              11      ADD HL,BC
000D25 DA43 44               4      LD  B,H
000D26 DA44 4D               4      LD  C,L
000D27 DA45 2118FC          10      LD  HL,0-WIDTH*LINE
000D2A DA48 09              11      ADD HL,BC
000D2B DA49 3F               4      CCF
000D2C DA4A 9F               4      SBC A,A
000D2D DA4B C3F3D8          10      JP  PRINTE8
                                
       DA4E                     CTRL0E:
000D30 DA4E CDD3F0          17      CALL    _POS
000D33 DA51 7C               4      LD  A,H
000D34 DA52 1804            12      JR  SCR1
       DA54                     SCR:
000D36 DA54 3A97F0          13      LD  A,(_LINE)
000D39 DA57 3D               4      DEC A
       DA58                     SCR1:
000D3A DA58 C5              11      PUSH    BC
000D3B DA59 D5              11      PUSH    DE
000D3C DA5A E5              11      PUSH    HL
000D3D DA5B 1100D0          10      LD  DE,0D000H
000D40 DA5E 2128D0          10      LD  HL,0D000H+WIDTH
                                
000D43 DA61 47               4      LD  B,A
000D44 DA62 B7               4      OR  A
000D45 DA63 C3C7CF          10      JP  IO_SCRUP
                                
       DA66                     POS:
000D48 DA66 2A8EF0          16      LD  HL,(_TXADR)
000D4B DA69 C5              11      PUSH    BC
000D4C DA6A 01D8FF          10      LD  BC,0-WIDTH
000D4F DA6D AF               4      XOR A
       DA6E                     POS1:
000D50 DA6E 09              11      ADD HL,BC
000D51 DA6F 3C               4      INC A
000D52 DA70 38FC            12      JR  C,POS1
000D54 DA72 ED42            15      SBC HL,BC
000D56 DA74 3D               4      DEC A
000D57 DA75 67               4      LD  H,A
000D58 DA76 C1              10      POP BC
000D59 DA77 A7               4      AND A
000D5A DA78 C9              10      RET
                                
       DA79                     GETL:
000D5B DA79 CDD3F0          17      CALL    _POS
000D5E DA7C E5              11      PUSH    HL
000D5F DA7D 3ECD             7      LD  A,0CDH      ;CALL ????
000D61 DA7F 32A0D8          13      LD  (INSFLG),A
       DA82                     GETL1:
000D64 DA82 CD8ED7          17      CALL    _SYS08
000D67 DA85 FE09             7      CP  9
000D69 DA87 2008            12      JR  NZ,GETL1V
000D6B DA89 2130FF          10      LD  HL,KBUF
000D6E DA8C CD88D4          17      CALL    MSX
000D71 DA8F 18F1            12      JR  GETL1
       DA91                     GETL1V:
000D73 DA91 5F               4      LD  E,A
000D74 DA92 CDD3F0          17      CALL    _POS
000D77 DA95 CDCDF0          17      CALL    _PRINT
000D7A DA98 7B               4      LD  A,E
000D7B DA99 FE20             7      CP  $20
000D7D DA9B 3809            12      JR  C,GETL1V1
000D7F DA9D 7D               4      LD  A,L
000D80 DA9E FE27             7      CP  WIDTH-1
000D82 DAA0 2004            12      JR  NZ,GETL1V1
000D84 DAA2 7C               4      LD  A,H
000D85 DAA3 320BDA          13      LD  (MULINE),A
       DAA6                     GETL1V1:
000D88 DAA6 7B               4      LD  A,E
000D89 DAA7 FE0D             7      CP  00DH
000D8B DAA9 20D7            12      JR  NZ,GETL1
000D8D DAAB 3E01             7      LD  A,1     ;LD BC,????
000D8F DAAD 32A0D8          13      LD  (INSFLG),A
000D92 DAB0 1130FF          10      LD  DE,KBUF
000D95 DAB3 0628             7      LD  B,WIDTH
000D97 DAB5 CD26D3          17      CALL    ZERO_MEMORY_DE
                                
000D9A DAB8 D1              10      POP DE
000D9B DAB9 CDD3F0          17      CALL    _POS
000D9E DABC 6B               4      LD  L,E
000D9F DABD 3E28             7      LD  A,WIDTH
000DA1 DABF 95               4      SUB L
000DA2 DAC0 57               4      LD  D,A
                                
000DA3 DAC1 3A0BDA          13      LD  A,(MULINE)
000DA6 DAC4 94               4      SUB H
000DA7 DAC5 2806            12      JR  Z,GL2X
000DA9 DAC7 3C               4      INC A
000DAA DAC8 200C            12      JR  NZ,GL3X
000DAC DACA 25               4      DEC H
000DAD DACB 1805            12      JR  GL4X
       DACD                     GL2X:
000DAF DACD 3E1F             7      LD  A,$1F
000DB1 DACF CD78D7          17      CALL    MSG_A
       DAD2                     GL4X:
000DB4 DAD2 7A               4      LD  A,D
000DB5 DAD3 C628             7      ADD A,WIDTH
000DB7 DAD5 57               4      LD  D,A
       DAD6                     GL3X:
000DB8 DAD6 CD9BD9          17      CALL    LOC1
000DBB DAD9 4D               4      LD  C,L
000DBC DADA 7C               4      LD  A,H
000DBD DADB C6D0             7      ADD A,0D0H
000DBF DADD 47               4      LD  B,A
000DC0 DADE 5A               4      LD  E,D
000DC1 DADF 2130FF          10      LD  HL,KBUF
       DAE2                     GETL2:
000DC4 DAE2 CDD0F0          17      CALL    _SCRN
000DC7 DAE5 03               6      INC BC
000DC8 DAE6 77               7      LD  (HL),A
000DC9 DAE7 23               6      INC HL
000DCA DAE8 1D               4      DEC E
000DCB DAE9 20F7            12      JR  NZ,GETL2
       DAEB                     GETL3:
000DCD DAEB 2B               6      DEC HL
000DCE DAEC 7E               7      LD  A,(HL)
000DCF DAED FE21             7      CP  021H
000DD1 DAEF D0              11      RET NC
000DD2 DAF0 3600            10      LD  (HL),0
000DD4 DAF2 15               4      DEC D
000DD5 DAF3 20F6            12      JR  NZ,GETL3
000DD7 DAF5 C9              10      RET
                                
       DAF6                     INKEYB:
000DD8 DAF6 C1              10      POP BC
000DD9 DAF7 CB47             8      BIT 0,A
000DDB DAF9 3E08             7      LD  A,8
000DDD DAFB 2002            12      JR  NZ,SETKEYD
000DDF DAFD 3E03             7      LD  A,3
       DAFF                     SETKEYD:
000DE1 DAFF 3292F0          13      LD  (_KEYD),A
       DB02                     GETKEYD:
000DE4 DB02 3A92F0          13      LD  A,(_KEYD)
000DE7 DB05 B7               4      OR  A
       DB06                     GETKEYD_SWC:            ;ここがSCFの場合はキーを離すまで戻り値は0になる（自己書き換え）
000DE8 DB06 A7               4      AND A
000DE9 DB07 D0              11      RET NC
000DEA DB08 2005            12      JR  NZ,GETKEYD1
000DEC DB0A 3E                      DB  03EH
000DED DB0B A7               4      AND A
000DEE DB0C 3206DB          13      LD  (GETKEYD_SWC),A
       DB0F                     GETKEYD1:
000DF1 DB0F AF               4      XOR A
000DF2 DB10 C9              10      RET
                                
       DB11                     INKEY:
                                #IF EXISTS USE_8253
000DF3 DB11 FB               4      EI
000DF4 DB12 E5              11      PUSH    HL
000DF5 DB13 2A90F0          16      LD  HL,(_KEYPS)
000DF8 DB16 7C               4      LD  A,H
000DF9 DB17 AD               4      XOR L
000DFA DB18 280B            12      JR  Z,INKEY1
000DFC DB1A 7C               4      LD  A,H
000DFD DB1B 3C               4      INC A
000DFE DB1C E61F             7      AND 01FH
000E00 DB1E 3291F0          13      LD  (_KEYPS+1),A
000E03 DB21 6F               4      LD  L,A
000E04 DB22 26F3             7      LD  H,HIGH KEYBF
000E06 DB24 7E               7      LD  A,(HL)
       DB25                     INKEY1:
000E07 DB25 E1              10      POP HL
000E08 DB26 B7               4      OR  A
000E09 DB27 C9              10      RET
                                #ELSE
                                    PUSH    HL
                                GETKEY:
                                    CALL    GETKEYD
                                    LD  L,A
                                    LD  H,16
                                GKSMC   EQU $-1
                                GETKEY1:
                                    LD  A,1
                                SKIP_KEYWAIT:   EQU $-1
                                    OR  A
                                    CALL    NZ,CHKEY    ;キーを離すまで待つ
                                    JR  Z,GETKEY2
                                    CP  L
                                    JR  NZ,GETKEY2
                                    CALL    RD556VSYNC
                                    ADD A,A
                                    JR  NC,GETKEY1
                                GETKEY1X:
                                    CALL    CHKEY       ;キーを離すまで待つ
                                    JR  Z,GETKEY2
                                    CP  L
                                    JR  NZ,GETKEY2
                                    CALL    RD556VSYNC
                                    ADD A,A
                                    JR  C,GETKEY1X
                                    DEC H
                                    JR  NZ,GETKEY1
                                    LD  A,1
                                    JR  GETKEY3
                                GETKEY2:
                                    LD  A,16
                                    LD  (SKIP_KEYWAIT),A
                                GETKEY3:
                                    LD  (GKSMC),A
                                    CALL    GETKEYD
                                    POP HL
                                    RET
                                #ENDIF
       DB28                     CHKEY:
000E0A DB28 C5              11      PUSH    BC
000E0B DB29 3E88             7      LD  A,$88
000E0D DB2B CD42CF          17      CALL    RDKEYDATA
000E10 DB2E 4F               4      LD  C,A
000E11 DB2F 3A93F0          13      LD  A,(_KEYST)
000E14 DB32 B9               4      CP  C
000E15 DB33 79               4      LD  A,C
000E16 DB34 3293F0          13      LD  (_KEYST),A
000E19 DB37 280F            12      JR  Z,KEYST2
000E1B DB39 CD02DB          17      CALL    GETKEYD
000E1E DB3C 2809            12      JR  Z,KEYST1
000E20 DB3E AF               4      XOR A
000E21 DB3F 3292F0          13      LD  (_KEYD),A
000E24 DB42 3E                      DB  03EH
000E25 DB43 37               4      SCF
000E26 DB44 3206DB          13      LD  (GETKEYD_SWC),A
       DB47                     KEYST1:
000E29 DB47 79               4      LD  A,C
       DB48                     KEYST2:
000E2A DB48 CB7F             8      BIT 7,A
000E2C DB4A 28AA            12      JR  Z,INKEYB
000E2E DB4C E5              11      PUSH    HL
000E2F DB4D 0E87             7      LD  C,$87
000E31 DB4F 2140ED          10      LD  HL,KEY_TABLE
000E34 DB52 CB47             8      BIT 0,A
000E36 DB54 2003            12      JR  NZ,CHKEY0
000E38 DB56 2180ED          10      LD  HL,SHIFT_TABLE
       DB59                     CHKEY0:
000E3B DB59 CB77             8      BIT 6,A
000E3D DB5B 2003            12      JR  NZ,CHKEY1
000E3F DB5D 21C0ED          10      LD  HL,CTRL_TABLE
       DB60                     CHKEY1:
000E42 DB60 79               4      LD  A,C
000E43 DB61 CD42CF          17      CALL    RDKEYDATA
000E46 DB64 0608             7      LD  B,8
       DB66                     CHKEY2:
000E48 DB66 87               4      ADD A,A
000E49 DB67 300A            12      JR  NC,CHKEY3
000E4B DB69 23               6      INC HL
000E4C DB6A 10FA            13      DJNZ    CHKEY2
000E4E DB6C 0D               4      DEC C
000E4F DB6D CB79             8      BIT 7,C
000E51 DB6F 20EF            12      JR  NZ,CHKEY1
000E53 DB71 AF               4      XOR A
000E54 DB72 06                      DB  $06     ;LD B,?? 次の1バイトを飛ばす
       DB73                     CHKEY3:
000E55 DB73 7E               7      LD  A,(HL)
000E56 DB74 E1              10      POP HL
000E57 DB75 C1              10      POP BC
000E58 DB76 C3FFDA          10      JP  SETKEYD
                                
       DB79                     SCRN:
000E5B DB79 E5              11      PUSH    HL
000E5C DB7A CD69CF          17      CALL    RDMMIO_BC
000E5F DB7D 6F               4      LD  L,A
000E60 DB7E 26EF             7      LD  H,HIGH DC_TABLE
000E62 DB80 7E               7      LD  A,(HL)
000E63 DB81 FE41             7      CP  'A'     ;英小文字チェック
000E65 DB83 380E            12      JR  C,SCRN1
000E67 DB85 FE5B             7      CP  'Z'+1
000E69 DB87 DC95DB          17      CALL    C,SCRNC
000E6C DB8A FEA6             7      CP  $A6     ;ひらがなチェック
000E6E DB8C 3805            12      JR  C,SCRN1
000E70 DB8E FEE0             7      CP  $E0
000E72 DB90 DC95DB          17      CALL    C,SCRNC
       DB93                     SCRN1:
000E75 DB93 E1              10      POP HL
000E76 DB94 C9              10      RET
                                
       DB95                     SCRNC:
000E77 DB95 6F               4      LD  L,A
000E78 DB96 60               4      LD  H,B
000E79 DB97 CBD8             8      SET 3,B
000E7B DB99 CD69CF          17      CALL    RDMMIO_BC
000E7E DB9C 44               4      LD  B,H
000E7F DB9D CB7F             8      BIT 7,A
000E81 DB9F 7D               4      LD  A,L
000E82 DBA0 C8              11      RET Z
000E83 DBA1 FE5B             7      CP  'Z'+1
000E85 DBA3 3804            12      JR  C,SCRNC_ADD
000E87 DBA5 FEC0             7      CP  $C0
000E89 DBA7 3803            12      JR  C,SCRNC_SUB
       DBA9                     SCRNC_ADD:
000E8B DBA9 C620             7      ADD A,$20
000E8D DBAB C9              10      RET
       DBAC                     SCRNC_SUB:
000E8E DBAC D620             7      SUB $20
000E90 DBAE C9              10      RET
       DBAF                     C_MON:
000E91 DBAF 2100D8          10      LD  HL,0D800H
       DBB2                     MON1:
000E94 DBB2 3E71             7      LD  A,071H
000E96 DBB4 CD61CF          17      CALL    WRMMIO
000E99 DBB7 23               6      INC HL
000E9A DBB8 CB54             8      BIT 2,H
000E9C DBBA 28F6            12      JR  Z,MON1
000E9E DBBC C3FBCF          10      JP  IO_MON
[EOF:M7IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       DBBF                     FILEC:
000EA1 DBBF CDCADB          17      CALL    FILE
       DBC2                     FILEC2:
000EA4 DBC2 3A15F0          13      LD  A,(FDRV+1)
000EA7 DBC5 FE20             7      CP  020H
000EA9 DBC7 C8              11      RET Z
000EAA DBC8 1839            12      JR  SETDIR1
                                
       DBCA                     FILE:
000EAC DBCA AF               4      XOR A
000EAD DBCB 3214F0          13      LD  (FDRV),A
000EB0 DBCE 67               4      LD  H,A
000EB1 DBCF 6F               4      LD  L,A
000EB2 DBD0 2222F0          16      LD  (FDRV+14),HL
000EB5 DBD3 CDA0DC          17      CALL    SPCUT
000EB8 DBD6 CD85DC          17      CALL    CCHK3
000EBB DBD9 2812            12      JR  Z,DEVI1
000EBD DBDB 13               6      INC DE
000EBE DBDC 1A               7      LD  A,(DE)
000EBF DBDD 1B               6      DEC DE
000EC0 DBDE FE3A             7      CP  ':'
000EC2 DBE0 200B            12      JR  NZ,DEVI1
000EC4 DBE2 1A               7      LD  A,(DE)      ;DRIVE
000EC5 DBE3 CDE6DE          17      CALL    CAP
000EC8 DBE6 D640             7      SUB '@'
000ECA DBE8 13               6      INC DE
000ECB DBE9 13               6      INC DE
000ECC DBEA 3214F0          13      LD  (FDRV),A
       DBED                     DEVI1:
000ECF DBED 1A               7      LD  A,(DE)
000ED0 DBEE D65C             7      SUB 05CH        ;\
000ED2 DBF0 2009            12      JR  NZ,NOROOT
000ED4 DBF2 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
000ED5 DBF3 222EF0          16      LD  (FDRV+26),HL
000ED8 DBF6 2C               4      INC L
000ED9 DBF7 2222F0          16      LD  (FDRV+14),HL
000EDC DBFA 13               6      INC DE
       DBFB                     NOROOT:
                                
       DBFB                     SETDIR:
000EDD DBFB CD26DC          17      CALL    FILED
000EE0 DBFE 1A               7      LD  A,(DE)
000EE1 DBFF FE5C             7      CP  05CH        ;\
000EE3 DC01 C0              11      RET NZ
000EE4 DC02 13               6      INC DE
       DC03                     SETDIR1:
000EE5 DC03 3E10             7      LD  A,010H      ;Directory
000EE7 DC05 3221F0          13      LD  (FDRV+13),A
000EEA DC08 D5              11      PUSH    DE
000EEB DC09 1114F0          10      LD  DE,FDRV
000EEE DC0C 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000EF0 DC0E CD48D4          17      CALL    BDOS0
000EF3 DC11 D1              10      POP DE
000EF4 DC12 B7               4      OR  A
000EF5 DC13 C0              11      RET NZ
                                
000EF6 DC14 3A21F0          13      LD  A,(FDRV+13)
000EF9 DC17 E610             7      AND 010H        ;ディレクトリ
000EFB DC19 C8              11      RET Z
                                
000EFC DC1A CD6DDC          17      CALL    FILEI
000EFF DC1D 2A2EF0          16      LD  HL,(FDRV+26)
000F02 DC20 23               6      INC HL
000F03 DC21 2222F0          16      LD  (FDRV+14),HL
000F06 DC24 18D5            12      JR  SETDIR
                                
       DC26                     FILED:
000F08 DC26 CD6DDC          17      CALL    FILEI
000F0B DC29 2115F0          10      LD  HL,FNAME
                                
000F0E DC2C 0608             7      LD  B,8
       DC2E                     FILE2:
000F10 DC2E CD7ADC          17      CALL    CCHKF
000F13 DC31 C8              11      RET Z
000F14 DC32 FE2A             7      CP  '*'
000F16 DC34 282E            12      JR  Z,FILE9
000F18 DC36 FE2E             7      CP  '.'
000F1A DC38 280C            12      JR  Z,FILE4
000F1C DC3A 77               7      LD  (HL),A
000F1D DC3B 23               6      INC HL
000F1E DC3C 10F0            13      DJNZ    FILE2
                                
       DC3E                     FILE3:
000F20 DC3E CD7ADC          17      CALL    CCHKF
000F23 DC41 C8              11      RET Z
000F24 DC42 FE2E             7      CP  '.'
000F26 DC44 20F8            12      JR  NZ,FILE3
                                
       DC46                     FILE4:
000F28 DC46 211DF0          10      LD  HL,FNAME+8
000F2B DC49 0603             7      LD  B,3
                                
       DC4B                     FILE4L:
000F2D DC4B CD7ADC          17      CALL    CCHKF
000F30 DC4E C8              11      RET Z
000F31 DC4F FE2E             7      CP  '.'
000F33 DC51 2008            12      JR  NZ,FILE12
000F35 DC53 3215F0          13      LD  (FNAME),A   ;Parent directory(..)
000F38 DC56 3216F0          13      LD  (FNAME+1),A
000F3B DC59 3E20             7      LD  A,020H
       DC5B                     FILE12:
000F3D DC5B FE2A             7      CP  '*'
000F3F DC5D 280A            12      JR  Z,FILE10
000F41 DC5F 77               7      LD  (HL),A
000F42 DC60 23               6      INC HL
000F43 DC61 10E8            13      DJNZ    FILE4L
000F45 DC63 C9              10      RET
                                
       DC64                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000F46 DC64 CD69DC          17      CALL    FILE10
000F49 DC67 18D5            12      JR  FILE3
                                
       DC69                     FILE10:
000F4B DC69 3E3F             7      LD  A,'?'
000F4D DC6B 1808            12      JR  FILL_MEMORY
       DC6D                     FILEI:              ;名前＋拡張子をスペースで初期化
000F4F DC6D 3E20             7      LD  A,020H
000F51 DC6F 01000B          10      LD  BC,11*256   ;C=0にしておく
000F54 DC72 2115F0          10      LD  HL,FNAME
       DC75                     FILL_MEMORY:            ;HLからBバイトAで埋める
000F57 DC75 77               7      LD  (HL),A
000F58 DC76 23               6      INC HL
000F59 DC77 10FC            13      DJNZ    FILL_MEMORY
000F5B DC79 C9              10      RET
                                
       DC7A                     CCHKF:
000F5C DC7A 1A               7      LD  A,(DE)
000F5D DC7B CD82DC          17      CALL    CCHK2
000F60 DC7E C8              11      RET Z
000F61 DC7F C3EEDF          10      JP  FKAN
                                
       DC82                     CCHK2:
000F64 DC82 0C               4      INC C
000F65 DC83 0D               4      DEC C
000F66 DC84 C0              11      RET NZ
       DC85                     CCHK3:              ;ZF=1 で使えない文字
000F67 DC85 FE2B             7      CP  '+'
000F69 DC87 C8              11      RET Z
000F6A DC88 FE2C             7      CP  ','
000F6C DC8A C8              11      RET Z
000F6D DC8B FE2F             7      CP  '/'
000F6F DC8D C8              11      RET Z
000F70 DC8E FE3A             7      CP  ':'
000F72 DC90 C8              11      RET Z
000F73 DC91 FE3B             7      CP  ';'
000F75 DC93 C8              11      RET Z
000F76 DC94 FE3D             7      CP  '='
000F78 DC96 C8              11      RET Z
000F79 DC97 FE5C             7      CP  05CH    ;\
000F7B DC99 C8              11      RET Z
000F7C DC9A FE20             7      CP  020H
000F7E DC9C D0              11      RET NC
000F7F DC9D BF               4      CP  A       ;Z=1
000F80 DC9E C9              10      RET
                                
       DC9F                     SS1:
000F81 DC9F 13               6      INC DE
       DCA0                     SPCUT:              ;スペースをカット
000F82 DCA0 1A               7      LD  A,(DE)
000F83 DCA1 FE20             7      CP  020H
000F85 DCA3 28FA            12      JR  Z,SS1
000F87 DCA5 C9              10      RET
                                
       DCA6                     SETDRVF:
000F88 DCA6 1114F0          10      LD  DE,FDRV
       DCA9                     SETDRV0:
000F8B DCA9 CDB2DC          17      CALL    SETDRV
000F8E DCAC FDE1            14      POP IY
000F90 DCAE C1              10      POP BC
000F91 DCAF D1              10      POP DE
000F92 DCB0 E1              10      POP HL
000F93 DCB1 C9              10      RET
                                
       DCB2                     SETDRV:
000F94 DCB2 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
000F95 DCB3 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
000F96 DCB4 C5              11      PUSH    BC
000F97 DCB5 1A               7      LD  A,(DE)
000F98 DCB6 D5              11      PUSH    DE
000F99 DCB7 FDE3            23      EX  (SP),IY
                                
000F9B DCB9 CDC0DC          17      CALL    GETDRV
000F9E DCBC CDD9F0          17      CALL    _CHGDRV
                                
000FA1 DCBF E9               4      JP  (HL)
                                
       DCC0                     GETDRV:
000FA2 DCC0 CDD3DC          17      CALL    GETDRV1
000FA5 DCC3 3288F0          13      LD  (_DRV),A
000FA8 DCC6 C9              10      RET
                                
       DCC7                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
000FA9 DCC7 CDD3DC          17      CALL    GETDRV1
000FAC DCCA C5              11      PUSH    BC
000FAD DCCB 4F               4      LD  C,A
000FAE DCCC 1A               7      LD  A,(DE)
000FAF DCCD CDD3DC          17      CALL    GETDRV1
000FB2 DCD0 A9               4      XOR C
000FB3 DCD1 C1              10      POP BC
000FB4 DCD2 C9              10      RET
       DCD3                     GETDRV1:
000FB5 DCD3 E67F             7      AND 07FH
000FB7 DCD5 D601             7      SUB 001H
000FB9 DCD7 D0              11      RET NC
000FBA DCD8 3A0400          13      LD  A,(_DVSW)   ;Current Drive
000FBD DCDB C9              10      RET
                                
       DCDC                     SOPENX:
000FBE DCDC 1139F0          10      LD  DE,SFILE
000FC1 DCDF FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
000FC4 DCE2 CDC7DC          17      CALL    IS_SAME_DRV_A_DE
000FC7 DCE5 2024            12      JR  NZ,SOPEN
000FC9 DCE7 13               6      INC DE
000FCA DCE8 FDE5            15      PUSH    IY
000FCC DCEA E1              10      POP HL
000FCD DCEB 23               6      INC HL
000FCE DCEC CD77DE          17      CALL    CPFILE
000FD1 DCEF 201A            12      JR  NZ,SOPEN
                                
000FD3 DCF1 2AF4F1          16      LD  HL,(SCDIR)
000FD6 DCF4 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
000FD9 DCF7 FD740F          19      LD  (IY+15),H
                                
000FDC DCFA 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
000FDF DCFD 229FF0          16      LD  (_FILEN),HL
                                
000FE2 DD00 ED5BF6F1        20      LD  DE,(SFBPS)
000FE6 DD04 2139F0          10      LD  HL,SFILE
000FE9 DD07 36FF            10      LD  (HL),0FFH
000FEB DD09 23               6      INC HL
000FEC DD0A C9              10      RET
       DD0B                     SOPEN:
000FED DD0B 211FDE          10      LD  HL,FILESE
       DD0E                     SOPENC:
000FF0 DD0E 2247DD          16      LD  (OPENPAT),HL
                                
000FF3 DD11 CDE2F0          17      CALL    _RDFATX     ;Detect Media
000FF6 DD14 3856            12      JR  C,RDDERR
                                
000FF8 DD16 AF               4      XOR A
000FF9 DD17 329FF0          13      LD  (_FILEN),A
000FFC DD1A CD23DF          17      CALL    LDDIRX1     ;A=0で呼び出す
000FFF DD1D 2818            12      JR  Z,SDIRX1
                                
001001 DD1F CD10DE          17      CALL    READ_DIR    ;Sub Directory
001004 DD22 3808            12      JR  C,SDIRX0
001006 DD24 2A7EF1          16      LD  HL,(_DTBUF)
001009 DD27 7E               7      LD  A,(HL)
00100A DD28 FE2E             7      CP  '.'
00100C DD2A 280F            12      JR  Z,SOPEN1
       DD2C                     SDIRX0:
00100E DD2C AF               4      XOR A
00100F DD2D 32A0F0          13      LD  (_DIRF),A
001012 DD30 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
001016 DD34 FD770F          19      LD  (IY+15),A
       DD37                     SDIRX1:
001019 DD37 ED5BFCF1        20      LD  DE,(_DIRPS) ;Root Directory
       DD3B                     SOPEN1:
00101D DD3B 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       DD3C                     SDECPAT EQU $-1
       DD3D                     SOPEN1X:
00101F DD3D CD10DE          17      CALL    READ_DIR    ;FILE SEARCH
001022 DD40 382A            12      JR  C,RDDERR
001024 DD42 2A7EF1          16      LD  HL,(_DTBUF)
       DD45                     SOPEN2:
001027 DD45 D5              11      PUSH    DE
001028 DD46 CD1FDE          17      CALL    FILESE      ;(self-modifying code)
       DD47                     OPENPAT EQU $-2
00102B DD49 D1              10      POP DE
00102C DD4A 386D            12      JR  C,SOPENE
00102E DD4C 281B            12      JR  Z,SCF_FF_RET
       DD4E                     SOPEN3:
001030 DD4E 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
001033 DD51 B7               4      OR  A
001034 DD52 200C            12      JR  NZ,SOPEN5
001036 DD54 13               6      INC DE      ;ルートディレクトリ
001037 DD55 E5              11      PUSH    HL
001038 DD56 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       DD57                     MD_PAT  EQU $-2
00103B DD59 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
00103D DD5B E1              10      POP HL
00103E DD5C 20DD            12      JR  NZ,SOPEN1
001040 DD5E 1807            12      JR  SOPEN6
       DD60                     SOPEN5:
001042 DD60 CD2AE6          17      CALL    GNCLX       ;END DIR
001045 DD63 D8              11      RET C
001046 DD64 CDD7DE          17      CALL    ENDCL
       DD67                     SOPEN6:
001049 DD67 38D2            12      JR  C,SOPEN1
       DD69                     SCF_FF_RET:
00104B DD69 37               4      SCF         ;CF=1
00104C DD6A 9F               4      SBC A,A     ;A=0FFH
00104D DD6B C9              10      RET
                                
       DD6C                     RDDERR:
00104E DD6C BF               4      CP  A       ;READ ERR CF=1 ZF=1
00104F DD6D 37               4      SCF
001050 DD6E C9              10      RET
                                
       DD6F                     NOPEN:
001051 DD6F 211FDE          10      LD  HL,FILESE
001054 DD72 2247DD          16      LD  (OPENPAT),HL
001057 DD75 FD2A98F0        20      LD  IY,(_FCB)
00105B DD79 CD01E0          17      CALL    CHKWILDX
00105E DD7C 30EB            12      JR  NC,SCF_FF_RET
001060 DD7E FD7E00          19      LD  A,(IY+0)
001063 DD81 CDC0DC          17      CALL    GETDRV
001066 DD84 CDD9F0          17      CALL    _CHGDRV
001069 DD87 D8              11      RET C
00106A DD88 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
00106D DD8B 229FF0          16      LD  (_FILEN),HL
                                
001070 DD8E CD1EDF          17      CALL    LDDIRX
001073 DD91 ED5B9AF0        20      LD  DE,(_FBPS)
001077 DD95 CD10DE          17      CALL    READ_DIR
00107A DD98 38D2            12      JR  C,RDDERR
00107C DD9A 3A9EF0          13      LD  A,(_FBCNT)
00107F DD9D 3D               4      DEC A
001080 DD9E 28AE            12      JR  Z,SOPEN3
       DDA0                     NOPEN2:
001082 DDA0 2A9CF0          16      LD  HL,(_FBAD)
001085 DDA3 012000          10      LD  BC,020H
001088 DDA6 09              11      ADD HL,BC
001089 DDA7 4F               4      LD  C,A
00108A DDA8 189B            12      JR  SOPEN2
                                
       DDAA                     SOPENE2:
00108C DDAA 229CF0          16      LD  (_FBAD),HL
00108F DDAD 79               4      LD  A,C
001090 DDAE 329EF0          13      LD  (_FBCNT),A
001093 DDB1 ED539AF0        20      LD  (_FBPS),DE
001097 DDB5 FD2298F0        20      LD  (_FCB),IY
       DDB9                     SOPENE:
00109B DDB9 AF               4      XOR A
00109C DDBA C9              10      RET
                                
       DDBB                     COPEN:
00109D DDBB FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
0010A1 DDBF 213CDE          10      LD  HL,NEXTSE
0010A4 DDC2 CD0EDD          17      CALL    SOPENC
0010A7 DDC5 D0              11      RET NC
0010A8 DDC6 C8              11      RET Z
0010A9 DDC7 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
0010AC DDCA B7               4      OR  A
0010AD DDCB 37               4      SCF
0010AE DDCC C8              11      RET Z       ;ルートディレクトリ
0010AF DDCD 0601             7      LD  B,1
0010B1 DDCF CD60E0          17      CALL    WRDF
0010B4 DDD2 D8              11      RET C
0010B5 DDD3 ED5BFEF1        20      LD  DE,(_CLPS)
0010B9 DDD7 D5              11      PUSH    DE
0010BA DDD8 CDA0DE          17      CALL    DCPAT
0010BD DDDB CDABE4          17      CALL    DRDNX
0010C0 DDDE 2A7EF1          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
0010C3 DDE1 ED4B96E3        20      LD  BC,(SECSZ)  ;1セクタのサイズ
0010C7 DDE5 AF               4      XOR A
       DDE6                     COPENCL:
0010C8 DDE6 77               7      LD  (HL),A
0010C9 DDE7 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0010CB DDE9 EAE6DD          10      JP  PE,COPENCL
                                
0010CE DDEC 3ABEDE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
0010D1 DDEF 3D               4      DEC A
0010D2 DDF0 2819            12      JR  Z,COPENE
0010D4 DDF2 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
0010D6 DDF4 3222E6          13      LD  (_SECPS),A
0010D9 DDF7 D1              10      POP DE      ;DE=(_CLPS)
0010DA DDF8 D5              11      PUSH    DE
       DDF9                     COPEN1:
0010DB DDF9 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
0010DC DDFA C5              11      PUSH    BC
0010DD DDFB 2A7EF1          16      LD  HL,(_DTBUF)
0010E0 DDFE CDBADE          17      CALL    CLUSTX
0010E3 DE01 CDBFE7          17      CALL    DWT24
0010E6 DE04 C1              10      POP BC
0010E7 DE05 D1              10      POP DE
0010E8 DE06 CD21E6          17      CALL    NEXTX
0010EB DE09 20EE            12      JR  NZ,COPEN1
       DE0B                     COPENE:
0010ED DE0B 2A7EF1          16      LD  HL,(_DTBUF)
0010F0 DE0E D1              10      POP DE
0010F1 DE0F C9              10      RET
                                
       DE10                     READ_DIR:
0010F2 DE10 ED53FEF1        20      LD  (_CLPS),DE
0010F6 DE14 C5              11      PUSH    BC
0010F7 DE15 D5              11      PUSH    DE
0010F8 DE16 CDA0DE          17      CALL    DCPAT
0010FB DE19 CD8BE4          17      CALL    DRDX
0010FE DE1C D1              10      POP DE
0010FF DE1D C1              10      POP BC
001100 DE1E C9              10      RET
                                
       DE1F                     FILESE:
001101 DE1F 7E               7      LD  A,(HL)
001102 DE20 B7               4      OR  A
001103 DE21 C8              11      RET Z       ;END:ZF=1 CF=0
001104 DE22 FEE5             7      CP  0E5H
001106 DE24 280E            12      JR  Z,FILESE1
001108 DE26 FDE5            15      PUSH    IY
00110A DE28 D1              10      POP DE
00110B DE29 13               6      INC DE
00110C DE2A E5              11      PUSH    HL
00110D DE2B CD77DE          17      CALL    CPFILE
001110 DE2E CC98DE          17      CALL    Z,CPFILE2
001113 DE31 E1              10      POP HL
001114 DE32 37               4      SCF
001115 DE33 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       DE34                     FILESE1:
001116 DE34 CD4BDE          17      CALL    FNEXT
001119 DE37 20E6            12      JR  NZ,FILESE
       DE39                     ZF0_CF0_AFF_RET:
00111B DE39 F6FF             7      OR  0FFH        ;ZF=0 CF=0
00111D DE3B C9              10      RET
                                
       DE3C                     NEXTSE:
00111E DE3C 7E               7      LD  A,(HL)
00111F DE3D B7               4      OR  A
001120 DE3E 37               4      SCF
001121 DE3F C8              11      RET Z       ;!!!:ZF=1 CF=1
001122 DE40 FEE5             7      CP  0E5H
001124 DE42 37               4      SCF
001125 DE43 C8              11      RET Z       ;!!!:(ZF=1) CF=1
001126 DE44 CD4BDE          17      CALL    FNEXT
001129 DE47 20F3            12      JR  NZ,NEXTSE
00112B DE49 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       DE4B                     FNEXT:
00112D DE4B E5              11      PUSH    HL
00112E DE4C 219FF0          10      LD  HL,_FILEN
001131 DE4F 34              11      INC (HL)
001132 DE50 E1              10      POP HL
001133 DE51 112000          10      LD  DE,020H
001136 DE54 19              11      ADD HL,DE
001137 DE55 0D               4      DEC C
001138 DE56 C9              10      RET
                                
       DE57                     CPNAME:
001139 DE57 C5              11      PUSH    BC
00113A DE58 D5              11      PUSH    DE
00113B DE59 E5              11      PUSH    HL
00113C DE5A CD71DE          17      CALL    CPFILE4
00113F DE5D E1              10      POP HL
001140 DE5E 23               6      INC HL
001141 DE5F 23               6      INC HL
001142 DE60 23               6      INC HL
001143 DE61 23               6      INC HL
001144 DE62 D1              10      POP DE
001145 DE63 C1              10      POP BC
001146 DE64 2005            12      JR  NZ,CPNAME1
001148 DE66 7E               7      LD  A,(HL)
001149 DE67 23               6      INC HL
00114A DE68 66               7      LD  H,(HL)
00114B DE69 6F               4      LD  L,A
00114C DE6A C9              10      RET
       DE6B                     CPNAME1:
00114D DE6B 23               6      INC HL
00114E DE6C 23               6      INC HL
00114F DE6D 10E8            13      DJNZ    CPNAME
001151 DE6F 37               4      SCF
001152 DE70 C9              10      RET
                                
       DE71                     CPFILE4:
001153 DE71 C5              11      PUSH    BC
001154 DE72 010004          10      LD  BC,00400H
001157 DE75 1804            12      JR  CPSTR1
       DE77                     CPFILE:
001159 DE77 C5              11      PUSH    BC
00115A DE78 01000B          10      LD  BC,00B00H
       DE7B                     CPSTR1:
00115D DE7B 1A               7      LD  A,(DE)
00115E DE7C FE3F             7      CP  '?'     ;Wild card
001160 DE7E 2812            12      JR  Z,CPSTR2
001162 DE80 7E               7      LD  A,(HL)
001163 DE81 CDE7DF          17      CALL    FKANC
001166 DE84 E5              11      PUSH    HL
001167 DE85 67               4      LD  H,A
001168 DE86 1A               7      LD  A,(DE)
001169 DE87 CB01             8      RLC C
00116B DE89 CDE7DF          17      CALL    FKANC
00116E DE8C CB09             8      RRC C
001170 DE8E BC               4      CP  H       ;CP (HL),(DE)
001171 DE8F E1              10      POP HL
001172 DE90 2004            12      JR  NZ,CPSTR3
       DE92                     CPSTR2:
001174 DE92 13               6      INC DE
001175 DE93 23               6      INC HL
001176 DE94 10E5            13      DJNZ    CPSTR1
       DE96                     CPSTR3:
001178 DE96 C1              10      POP BC
001179 DE97 C9              10      RET
                                
       DE98                     CPFILE2:
00117A DE98 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
00117D DE9B F6E1             7      OR  0E1H
00117F DE9D 2F               4      CPL
001180 DE9E A6               7      AND (HL)
001181 DE9F C9              10      RET
                                
       DEA0                     DCPAT:
001182 DEA0 0E00             7      LD  C,0
001184 DEA2 2A7EF1          16      LD  HL,(_DTBUF)
001187 DEA5 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
00118A DEA8 B7               4      OR  A
00118B DEA9 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
00118C DEAA 3ABEDE          13      LD  A,(SPCPAT)
00118F DEAD 4F               4      LD  C,A
001190 DEAE 3A22E6          13      LD  A,(_SECPS)
001193 DEB1 B9               4      CP  C
001194 DEB2 3801            12      JR  C,DC1
001196 DEB4 AF               4      XOR A
       DEB5                     DC1:
001197 DEB5 F680             7      OR  080H
001199 DEB7 32A0F0          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       DEBA                     CLUSTX:
00119C DEBA E5              11      PUSH    HL
00119D DEBB EB               4      EX  DE,HL
00119E DEBC AF               4      XOR A
00119F DEBD 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       DEBE                     SPCPAT  EQU $-1
       DEBF                     L_CLDBL:
0011A1 DEBF CB19             8      RR  C       ;->CF
0011A3 DEC1 3804            12      JR  C,E_CLDBL
0011A5 DEC3 29              11      ADD HL,HL       ;*2
0011A6 DEC4 8F               4      ADC A,A
0011A7 DEC5 18F8            12      JR  L_CLDBL
       DEC7                     E_CLDBL:
0011A9 DEC7 4F               4      LD  C,A
0011AA DEC8 3A22E6          13      LD  A,(_SECPS)
0011AD DECB B5               4      OR  L
0011AE DECC 6F               4      LD  L,A
0011AF DECD 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       DECE                     CLSPAT  EQU $-2
0011B2 DED0 AF               4      XOR A
0011B3 DED1 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
0011B4 DED2 89               4      ADC A,C
0011B5 DED3 4F               4      LD  C,A
0011B6 DED4 EB               4      EX  DE,HL
0011B7 DED5 E1              10      POP HL
0011B8 DED6 C9              10      RET
                                ;(8)
       DED7                     ENDCL:
0011B9 DED7 7A               4      LD  A,D ;END CLUSTER
0011BA DED8 FE01             7      CP  1   ;164=356    (self-modifying code)
       DED9                     CLPAT1  EQU $-1
0011BC DEDA C0              11      RET NZ
0011BD DEDB 7B               4      LD  A,E
0011BE DEDC FE64             7      CP  064H    ;       (self-modifying code)
       DEDD                     CLPAT2  EQU $-1
0011C0 DEDE C9              10      RET
                                ;(3)
       DEDF                     CAP4:
0011C1 DEDF 3EE5             7      LD  A,0E5H
0011C3 DEE1 C9              10      RET
                                                    ;for X1/88 ワークエリア
0011C4 DEE2 5BF0                    DW  _DISKE+1        ;DISKVE($F323)
0011C6 DEE4 F5F0                    DW  _BREAK+1        ;BREAKV($F325)
                                
       DEE6                     CAP:            ;(9)
0011C8 DEE6 FE61             7      CP  'a'
0011CA DEE8 D8              11      RET C
0011CB DEE9 FE7B             7      CP  'z'+1
0011CD DEEB D0              11      RET NC
0011CE DEEC D620             7      SUB 020H
0011D0 DEEE C9              10      RET
                                ;(10)
       DEEF                     CAP2:
0011D1 DEEF CDE6DE          17      CALL    CAP
       DEF2                     CAP3:               ;
0011D4 DEF2 FE05             7      CP  5
0011D6 DEF4 28E9            12      JR  Z,CAP4
0011D8 DEF6 FE21             7      CP  021H
0011DA DEF8 C9              10      RET
                                                    ;
       DEF9                     CHDIR:
0011DB DEF9 CDD0E8          17      CALL    GETDPBD
0011DE DEFC 381D            12      JR  C,CHDIR2
0011E0 DEFE DD751A          19      LD  (IX+DPB_SDIR),L
0011E3 DF01 DD741B          19      LD  (IX+DPB_SDIR+1),H
0011E6 DF04 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       DF06                     LDDIR:
0011E8 DF06 CDD0E8          17      CALL    GETDPBD
0011EB DF09 DD5E1A          19      LD  E,(IX+DPB_SDIR)
0011EE DF0C DD561B          19      LD  D,(IX+DPB_SDIR+1)
0011F1 DF0F 13               6      INC DE
0011F2 DF10 FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011F5 DF13 FD720F          19      LD  (IY+15),D
0011F8 DF16 1B               6      DEC DE
0011F9 DF17 AF               4      XOR A
0011FA DF18 32A0F0          13      LD  (_DIRF),A
       DF1B                     CHDIR2:
0011FD DF1B DDE1            14      POP IX
0011FF DF1D C9              10      RET
                                
       DF1E                     LDDIRX:
001200 DF1E 3AA0F0          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
001203 DF21 E67F             7      AND 07FH
       DF23                     LDDIRX1:
001205 DF23 3222E6          13      LD  (_SECPS),A
001208 DF26 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00120B DF29 FD560F          19      LD  D,(IY+15)
00120E DF2C 1B               6      DEC DE
00120F DF2D CDD7DE          17      CALL    ENDCL
001212 DF30 D406DF          17      CALL    NC,LDDIR
       DF33                     LDDIRS:
001215 DF33 7A               4      LD  A,D
001216 DF34 B3               4      OR  E
001217 DF35 32A0F0          13      LD  (_DIRF),A   ;ディレクトリか判別
00121A DF38 C9              10      RET
                                
       DF39                     KILL:
00121B DF39 CD01E0          17      CALL    CHKWILDX
00121E DF3C 3834            12      JR  C,KILLW
001220 DF3E CDDCDC          17      CALL    SOPENX
       DF41                     KILLS:
001223 DF41 3E1F             7      LD  A,01FH
001225 DF43 D485DF          17      CALL    NC,CHKATT
001228 DF46 D8              11      RET C
       DF47                     KILLSX:
001229 DF47 36E5            10      LD  (HL),0E5H   ;DIR
00122B DF49 CDDDDF          17      CALL    WTDB
00122E DF4C 111A00          10      LD  DE,01AH
001231 DF4F 19              11      ADD HL,DE
001232 DF50 5E               7      LD  E,(HL)
001233 DF51 23               6      INC HL
001234 DF52 56               7      LD  D,(HL)
       DF53                     KILLS1:
001235 DF53 CDD7DE          17      CALL    ENDCL
001238 DF56 D0              11      RET NC      ;CF=0
001239 DF57 21FEFF          10      LD  HL,0-2
00123C DF5A 19              11      ADD HL,DE
00123D DF5B D0              11      RET NC      ;DE= 0 or 1
00123E DF5C D5              11      PUSH    DE
00123F DF5D CDF7F0          17      CALL    _GNCL
001242 DF60 ED53FEF1        20      LD  (_CLPS),DE
001246 DF64 D1              10      POP DE
001247 DF65 210000          10      LD  HL,0
00124A DF68 D4FAF0          17      CALL    NC,_SNCL
00124D DF6B D8              11      RET C
00124E DF6C ED5BFEF1        20      LD  DE,(_CLPS)  ;FAT
001252 DF70 18E1            12      JR  KILLS1
                                
       DF72                     KILLW:
001254 DF72 CD0BDD          17      CALL    SOPEN
       DF75                     KILLW1:
001257 DF75 380B            12      JR  C,KILLW2
001259 DF77 CDAADD          17      CALL    SOPENE2
00125C DF7A CD41DF          17      CALL    KILLS
00125F DF7D CD6FDD          17      CALL    NOPEN
001262 DF80 18F3            12      JR  KILLW1
       DF82                     KILLW2:
001264 DF82 C8              11      RET Z
001265 DF83 3F               4      CCF
001266 DF84 C9              10      RET
                                
       DF85                     CHKATT:
001267 DF85 E5              11      PUSH    HL
001268 DF86 110B00          10      LD  DE,00BH
00126B DF89 19              11      ADD HL,DE
00126C DF8A A6               7      AND (HL)
00126D DF8B E1              10      POP HL
00126E DF8C C8              11      RET Z
00126F DF8D 37               4      SCF
001270 DF8E C9              10      RET
                                
       DF8F                     NAME:
001271 DF8F CD01E0          17      CALL    CHKWILDX
001274 DF92 D8              11      RET C
001275 DF93 110400          10      LD  DE,4
001278 DF96 19              11      ADD HL,DE
001279 DF97 22ACDF          16      LD  (NAMEP),HL
00127C DF9A 23               6      INC HL
00127D DF9B CD05E0          17      CALL    CHKWILD
001280 DF9E D8              11      RET C
                                
001281 DF9F CDDCDC          17      CALL    SOPENX
001284 DFA2 3E0F             7      LD  A,00FH
001286 DFA4 D485DF          17      CALL    NC,CHKATT
001289 DFA7 D8              11      RET C
                                
00128A DFA8 FDE5            15      PUSH    IY
00128C DFAA FD210000        14      LD  IY,0        ;自己書き換え
       DFAC                     NAMEP   EQU $-2
001290 DFAE CDDCDC          17      CALL    SOPENX
001293 DFB1 FDE3            23      EX  (SP),IY
001295 DFB3 3F               4      CCF
001296 DFB4 D40BDD          17      CALL    NC,SOPEN
001299 DFB7 EB               4      EX  DE,HL
00129A DFB8 E1              10      POP HL
00129B DFB9 D8              11      RET C
                                
       DFBA                     SETNAME:
00129C DFBA 01000B          10      LD  BC,11*256
00129F DFBD 23               6      INC HL
0012A0 DFBE 7E               7      LD  A,(HL)
0012A1 DFBF FEE5             7      CP  0E5H
0012A3 DFC1 2004            12      JR  NZ,SNAME1
0012A5 DFC3 3E05             7      LD  A,5
0012A7 DFC5 180E            12      JR  SNAME3
       DFC7                     SNAME1:
0012A9 DFC7 7E               7      LD  A,(HL)
0012AA DFC8 0C               4      INC C
0012AB DFC9 0D               4      DEC C
0012AC DFCA 2009            12      JR  NZ,SNAME3
0012AE DFCC CDE6DE          17      CALL    CAP
0012B1 DFCF FEA0             7      CP  0A0H
0012B3 DFD1 2002            12      JR  NZ,SNAME3
0012B5 DFD3 3E20             7      LD  A,020H
       DFD5                     SNAME3:
0012B7 DFD5 12               7      LD  (DE),A
0012B8 DFD6 7E               7      LD  A,(HL)
0012B9 DFD7 23               6      INC HL
0012BA DFD8 CDEEDF          17      CALL    FKAN
0012BD DFDB 10EA            13      DJNZ    SNAME1
       DFDD                     WTDB:               ;バッファデータが更新された
0012BF DFDD 3EFF             7      LD  A,0FFH
0012C1 DFDF 3239F0          13      LD  (SFILE),A
0012C4 DFE2 32A4F0          13      LD  (_WTDBF),A
0012C7 DFE5 AF               4      XOR A
0012C8 DFE6 C9              10      RET
                                
       DFE7                     FKANC:
0012C9 DFE7 CB41             8      BIT 0,C
0012CB DFE9 CCEFDE          17      CALL    Z,CAP2
0012CE DFEC 1801            12      JR  FKANX
       DFEE                     FKAN:           ;漢字チェック
0012D0 DFEE 13               6      INC DE
       DFEF                     FKANX:
0012D1 DFEF CB41             8      BIT 0,C
0012D3 DFF1 CB81             8      RES 0,C
0012D5 DFF3 C0              11      RET NZ
0012D6 DFF4 FE80             7      CP  080H
0012D8 DFF6 D8              11      RET C
0012D9 DFF7 FEA0             7      CP  0A0H
0012DB DFF9 3803            12      JR  C,FKAN1
0012DD DFFB FEE0             7      CP  0E0H
0012DF DFFD D8              11      RET C
       DFFE                     FKAN1:
0012E0 DFFE 0C               4      INC C
0012E1 DFFF A7               4      AND A
0012E2 E000 C9              10      RET
                                
       E001                     CHKWILDX:
0012E3 E001 FDE5            15      PUSH    IY
0012E5 E003 E1              10      POP HL
0012E6 E004 23               6      INC HL
       E005                     CHKWILD:
0012E7 E005 060B             7      LD  B,11
0012E9 E007 3E3F             7      LD  A,'?'
       E009                     CHKWIL1:
0012EB E009 BE               7      CP  (HL)
0012EC E00A 23               6      INC HL
0012ED E00B 37               4      SCF
0012EE E00C C8              11      RET Z
0012EF E00D 10FA            13      DJNZ    CHKWIL1
0012F1 E00F AF               4      XOR A
0012F2 E010 C9              10      RET
                                
       E011                     SDIRENT:        ;IY=FCB HL=DIR
0012F3 E011 D5              11      PUSH    DE
0012F4 E012 E5              11      PUSH    HL
0012F5 E013 FDE5            15      PUSH    IY
0012F7 E015 D1              10      POP DE
0012F8 E016 EB               4      EX  DE,HL
0012F9 E017 CDBADF          17      CALL    SETNAME
                                ;               Attribute
0012FC E01A FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0012FF E01D 12               7      LD  (DE),A
001300 E01E 13               6      INC DE
                                ;               Reserved
001301 E01F AF               4      XOR A
001302 E020 060A             7      LD  B,10
       E022                     SDE1:
001304 E022 12               7      LD  (DE),A
001305 E023 13               6      INC DE
001306 E024 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
001308 E026 21E4F1          10      LD  HL,SDDATA       ;(FCB)更新年月日
00130B E029 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       E02B                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
00130D E02B 7E               7      LD  A,(HL)
00130E E02C 23               6      INC HL
00130F E02D 3232E0          13      LD  (SDPAT),A
001312 E030 FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       E032                     SDPAT   EQU $-1
001315 E033 12               7      LD  (DE),A
001316 E034 13               6      INC DE
001317 E035 10F4            13      DJNZ    SDLOOP
                                
001319 E037 AF               4      XOR A
00131A E038 E1              10      POP HL
00131B E039 D1              10      POP DE
00131C E03A C9              10      RET
                                
       E03B                     WOPEN:
00131D E03B FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001320 E03E E61F             7      AND 01FH
001322 E040 37               4      SCF
001323 E041 C0              11      RET NZ
001324 E042 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E046                     TOPEN2:
001328 E046 AF               4      XOR A
       E047                     TOPEN:              ;Initializes the time stamp
001329 E047 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
00132D E04B C9              10      RET
                                
       E04C                     WRDFX:
00132E E04C 3ABEDE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       E04F                     L_WRFX:
001331 E04F 1F               4      RRA         ;->CF
001332 E050 3806            12      JR  C,E_WRFX
001334 E052 CB39             8      SRL C
001336 E054 CB1C             8      RR  H       ;CH=CH/2
001338 E056 18F7            12      JR  L_WRFX
       E058                     E_WRFX:
00133A E058 41               4      LD  B,C
00133B E059 4C               4      LD  C,H
00133C E05A 03               6      INC BC
00133D E05B 3E37             7      LD  A,037H      ;SCF
00133F E05D 32A8E4          13      LD  (DRDN1),A
                                
       E060                     WRDF:               ;BCクラスタ分FATを確保する
001342 E060 110200          10      LD  DE,2
001345 E063 AF               4      XOR A
001346 E064 3222E6          13      LD  (_SECPS),A
       E067                     WRDF1:
001349 E067 C5              11      PUSH    BC
00134A E068 D5              11      PUSH    DE
00134B E069 CDF7F0          17      CALL    _GNCL
00134E E06C 381C            12      JR  C,WRDF3
001350 E06E 7A               4      LD  A,D     ;空いているかチェック
001351 E06F B3               4      OR  E
001352 E070 202A            12      JR  NZ,WRDF4
001354 E072 E1              10      POP HL      ;HL=空いているクラスタ
001355 E073 E5              11      PUSH    HL
001356 E074 ED5BFEF1        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
00135A E078 22FEF1          16      LD  (_CLPS),HL
00135D E07B 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
00135E E07C B3               4      OR  E
00135F E07D 2008            12      JR  NZ,WRDF2
001361 E07F FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
001364 E082 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
001367 E085 1803            12      JR  WRDF3
       E087                     WRDF2:
001369 E087 CDFAF0          17      CALL    _SNCL
       E08A                     WRDF3:
00136C E08A D1              10      POP DE
00136D E08B C1              10      POP BC
00136E E08C D8              11      RET C
00136F E08D 0B               6      DEC BC
001370 E08E 78               4      LD  A,B
001371 E08F B1               4      OR  C
001372 E090 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
001374 E092 ED5BFEF1        20      LD  DE,(_CLPS)
001378 E096 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
00137B E099 C3FAF0          10      JP  _SNCL
                                
       E09C                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
00137E E09C D1              10      POP DE
00137F E09D C1              10      POP BC
       E09E                     WRDF5:
001380 E09E 13               6      INC DE
001381 E09F CDD7DE          17      CALL    ENDCL
001384 E0A2 38C3            12      JR  C,WRDF1
001386 E0A4 37               4      SCF
001387 E0A5 C9              10      RET
                                
       E0A6                     RWXR:
001388 E0A6 3A97E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E0A9                     L_RWX:
00138B E0A9 1F               4      RRA     ;->CF
00138C E0AA 3808            12      JR  C,E_RWX
00138E E0AC CB38             8      SRL B   ;BCH=BCH/2
001390 E0AE CB19             8      RR  C   ;
001392 E0B0 CB1C             8      RR  H   ;
001394 E0B2 18F5            12      JR  L_RWX
       E0B4                     E_RWX:
001396 E0B4 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001399 E0B7 FD561B          19      LD  D,(IY+27)
00139C E0BA AF               4      XOR A
00139D E0BB 3222E6          13      LD  (_SECPS),A
       E0BE                     RWX1:
0013A0 E0BE ED53FEF1        20      LD  (_CLPS),DE
0013A4 E0C2 7A               4      LD  A,D
0013A5 E0C3 B3               4      OR  E
0013A6 E0C4 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
0013A8 E0C6 78               4      LD  A,B
0013A9 E0C7 B1               4      OR  C
0013AA E0C8 B4               4      OR  H
0013AB E0C9 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
0013AC E0CA CD2AE6          17      CALL    GNCLX
0013AF E0CD D8              11      RET C
0013B0 E0CE 7C               4      LD  A,H     ;
0013B1 E0CF 25               4      DEC H       ;
0013B2 E0D0 B7               4      OR  A       ;DEC BCH
0013B3 E0D1 2001            12      JR  NZ,RWX2     ;
0013B5 E0D3 0B               6      DEC BC      ;
       E0D4                     RWX2:
0013B6 E0D4 CDD7DE          17      CALL    ENDCL
0013B9 E0D7 38E5            12      JR  C,RWX1
       E0D9                     SCF_RET:
0013BB E0D9 37               4      SCF
0013BC E0DA C9              10      RET
                                
       E0DB                     DSKF:
0013BD E0DB 110000          10      LD  DE,0
       E0DC                     MAXCLP  EQU $-2
0013C0 E0DE 2AACF0          16      LD  HL,(_FAKEFREE)
0013C3 E0E1 7C               4      LD  A,H
0013C4 E0E2 B5               4      OR  L
0013C5 E0E3 2803            12      JR  Z,DSKF1
0013C7 E0E5 110100          10      LD  DE,1
       E0E8                     DSKF1:
0013CA E0E8 D5              11      PUSH    DE
0013CB E0E9 CDF7F0          17      CALL    _GNCL
0013CE E0EC 380C            12      JR  C,POPSCF
0013D0 E0EE 7A               4      LD  A,D
0013D1 E0EF B3               4      OR  E
0013D2 E0F0 2001            12      JR  NZ,DSKF2
0013D4 E0F2 23               6      INC HL
       E0F3                     DSKF2:
0013D5 E0F3 D1              10      POP DE
0013D6 E0F4 1B               6      DEC DE
0013D7 E0F5 7A               4      LD  A,D
0013D8 E0F6 B3               4      OR  E
0013D9 E0F7 20EF            12      JR  NZ,DSKF1
0013DB E0F9 C9              10      RET
                                
       E0FA                     POPSCF:
0013DC E0FA F1              10      POP AF
0013DD E0FB 37               4      SCF
0013DE E0FC C9              10      RET
                                
       E0FD                     SETTMS:
0013DF E0FD FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
0013E2 E100 3C               4      INC A
0013E3 E101 C0              11      RET NZ      ;ファイルが更新されていない
       E102                     SETTMSX:            ;FCBに日付時刻をセットする
0013E4 E102 CD17D8          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
0013E7 E105 CB25             8      SLA L       ;   *2
0013E9 E107 CB25             8      SLA L       ;   *4
0013EB E109 29              11      ADD HL,HL       ;*2 *8
0013EC E10A 29              11      ADD HL,HL       ;*4 *16
0013ED E10B 29              11      ADD HL,HL       ;*8 *32
0013EE E10C 7A               4      LD  A,D
0013EF E10D 0F               4      RRCA            ;bit.0->7->->->0->C
0013F0 E10E E61F             7      AND 01FH
0013F2 E110 B5               4      OR  L
0013F3 E111 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
0013F6 E114 FD7417          19      LD  (IY+23),H
                                
0013F9 E117 CD17D8          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
0013FC E11A 0144F8          10      LD  BC,0-1980
0013FF E11D 09              11      ADD HL,BC
001400 E11E 65               4      LD  H,L
                                
001401 E11F 7A               4      LD  A,D
001402 E120 87               4      ADD A,A     ;*2
001403 E121 87               4      ADD A,A     ;*4
001404 E122 87               4      ADD A,A     ;*8
001405 E123 87               4      ADD A,A     ;*16
001406 E124 6F               4      LD  L,A
001407 E125 29              11      ADD HL,HL       ;*32
001408 E126 7D               4      LD  A,L
001409 E127 B3               4      OR  E
00140A E128 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
00140D E12B FD7415          19      LD  (IY+21),H
001410 E12E C9              10      RET
                                ;(16)
       E12F                     PUSHRR:
001411 E12F 325BE4          13      LD  (SETSEQ_SWC_RND),A
001414 E132 226DE4          16      LD  (SETSEQ_SWC_SEQ_RR),HL
001417 E135 CD55E1          17      CALL    GET_RR_AHL
00141A E138 220FF0          16      LD  (RR_BUF_HL),HL
00141D E13B 3211F0          13      LD  (RR_BUF_A),A
001420 E13E C9              10      RET
                                ;(14)
       E13F                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
001421 E13F 87               4      ADD A,A     ;in BHLA => out AHL
001422 E140 ED6A            15      ADC HL,HL
001424 E142 CB18             8      RR  B
001426 E144 B7               4      OR  A
001427 E145 78               4      LD  A,B     ;ここでフラグは変化しない
001428 E146 C8              11      RET Z
001429 E147 2C               4      INC L       ;INC AHL
00142A E148 C0              11      RET NZ      ;
00142B E149 24               4      INC H       ;
00142C E14A C0              11      RET NZ      ;
00142D E14B 3C               4      INC A       ;
00142E E14C C9              10      RET
                                ;(18)
       E14D                     INIT_RND:
00142F E14D 3ECD             7      LD  A,0CDH      ;CALL ????
001431 E14F 216CE1          10      LD  HL,POPRR
001434 E152 CD2FE1          17      CALL    PUSHRR
       E155                     GET_RR_AHL:
001437 E155 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00143A E158 FD6622          19      LD  H,(IY+34)   ;
00143D E15B FD7E23          19      LD  A,(IY+35)   ;
001440 E15E C9              10      RET
                                ;(10)
       E15F                     SET_RR_AHL:
001441 E15F FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001444 E162 FD7422          19      LD  (IY+34),H   ;
001447 E165 FD7723          19      LD  (IY+35),A   ;
00144A E168 C9              10      RET
                                ;(17)
       E169                     SETSEQ:
00144B E169 CD8EE1          17      CALL    SETSEQ1
       E16C                     POPRR:
00144E E16C F5              11      PUSH    AF
00144F E16D E5              11      PUSH    HL
001450 E16E 2A0FF0          16      LD  HL,(RR_BUF_HL)
001453 E171 3A11F0          13      LD  A,(RR_BUF_A)
001456 E174 CD5FE1          17      CALL    SET_RR_AHL
001459 E177 E1              10      POP HL
00145A E178 F1              10      POP AF
00145B E179 C9              10      RET
                                ;(20)
       E17A                     GET_RR_BCDE:            ;BCDE=Random record
00145C E17A FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
00145F E17D FD5622          19      LD  D,(IY+34)
001462 E180 FD4E23          19      LD  C,(IY+35)
001465 E183 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
001467 E185 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00146B E189 C0              11      RET NZ
00146C E18A FD4624          19      LD  B,(IY+36)
00146F E18D C9              10      RET
                                
       E18E                     SETSEQ1:
001470 E18E F5              11      PUSH    AF
001471 E18F E5              11      PUSH    HL      ;AHL=Random record
001472 E190 CD55E1          17      CALL    GET_RR_AHL
001475 E193 47               4      LD  B,A     ;AHL→HLA
001476 E194 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
001477 E195 6C               4      LD  L,H     ;(IY+34)
001478 E196 60               4      LD  H,B     ;(IY+35)
001479 E197 0600             7      LD  B,0
                                
00147B E199 CD3FE1          17      CALL    GET_CPM_R_SIZE
                                
00147E E19C 29              11      ADD HL,HL
00147F E19D CB3D             8      SRL L       ;L=L/2
001481 E19F FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
001484 E1A2 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
001487 E1A5 E1              10      POP HL
001488 E1A6 F1              10      POP AF
001489 E1A7 C9              10      RET
                                
                                ;(23)
       E1A8                     RBXEND:             ;レコード数だけランダムレコードを進める
00148A E1A8 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       E1A9                     RBSIZE  EQU $-2
00148D E1AB CD55E1          17      CALL    GET_RR_AHL
001490 E1AE 19              11      ADD HL,DE
001491 E1AF CE00             7      ADC A,0
001493 E1B1 CD5FE1          17      CALL    SET_RR_AHL
001496 E1B4 EB               4      EX  DE,HL       ;HL=進めるレコード数
001497 E1B5 D0              11      RET NC
001498 E1B6 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00149C E1BA C0              11      RET NZ
00149D E1BB FD3424          23      INC (IY+36)
0014A0 E1BE C9              10      RET
       E1BF                     FILE_E:
                                
       DD69                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       DD69                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       DD69                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       DD69                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       DD69                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E1BF                     _SYS26:     ;(BDOS)ランダムブロック書き込み
0014A1 E1BF AF               4      XOR A
0014A2 E1C0 32A8E4          13      LD  (DRDN1),A   ;NOP
0014A5 E1C3 22A9E1          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
0014A8 E1C6 225DF0          16      LD  (LEFTX),HL
0014AB E1C9 CDB2DC          17      CALL    SETDRV
                                
0014AE E1CC CD32E3          17      CALL    RBX0
0014B1 E1CF DA5CE2          10      JP  C,RBWERR
0014B4 E1D2 CD3BE0          17      CALL    WOPEN
0014B7 E1D5 DA5CE2          10      JP  C,RBWERR
0014BA E1D8 7C               4      LD  A,H
0014BB E1D9 B5               4      OR  L
0014BC E1DA CA55E2          10      JP  Z,RBW1
                                
0014BF E1DD 2B               6      DEC HL
                                
0014C0 E1DE CD7AE1          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0014C3 E1E1 19              11      ADD HL,DE       ;BCHL=HL+BCDE
0014C4 E1E2 3001            12      JR  NC,S26X1    ;
0014C6 E1E4 03               6      INC BC      ;
       E1E5                     S26X1:
0014C7 E1E5 CDA6E0          17      CALL    RWXR
0014CA E1E8 DC4CE0          17      CALL    C,WRDFX
0014CD E1EB DA5CE2          10      JP  C,RBWERR
                                
0014D0 E1EE CD61E3          17      CALL    RBX2
0014D3 E1F1 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
0014D5 E1F3 CD80E3          17      CALL    RBXA
0014D8 E1F6 3864            12      JR  C,RBWERR
0014DA E1F8 EB               4      EX  DE,HL
0014DB E1F9 C5              11      PUSH    BC
0014DC E1FA EDB0                    LDIR
0014DE E1FC 225FF0          16      LD  (DTAX),HL
                                
0014E1 E1FF CDDDDF          17      CALL    WTDB        ;バッファデータは更新された
                                
0014E4 E202 2A5DF0          16      LD  HL,(LEFTX)
0014E7 E205 D1              10      POP DE
0014E8 E206 ED52            15      SBC HL,DE
0014EA E208 225DF0          16      LD  (LEFTX),HL
0014ED E20B 2831            12      JR  Z,RBWEND
                                
       E20D                     RBWB:
0014EF E20D CDB5E3          17      CALL    RBXB
0014F2 E210 2814            12      JR  Z,RBWC
       E212                     RBWB1:
0014F4 E212 C5              11      PUSH    BC
0014F5 E213 D5              11      PUSH    DE
0014F6 E214 CDBADE          17      CALL    CLUSTX
0014F9 E217 CDD9E3          17      CALL    DWTC
0014FC E21A D1              10      POP DE
0014FD E21B C1              10      POP BC
0014FE E21C D42AE6          17      CALL    NC,GNCLX
001501 E21F 383B            12      JR  C,RBWERR
001503 E221 10EF            13      DJNZ    RBWB1
001505 E223 CD29E4          17      CALL    DRW_FLUSH
       E226                     RBWC:
001508 E226 CDCDE3          17      CALL    RBXC
00150B E229 2813            12      JR  Z,RBWEND
00150D E22B C5              11      PUSH    BC
00150E E22C CDBADE          17      CALL    CLUSTX
001511 E22F CDA7E4          17      CALL    DRDN
001514 E232 C1              10      POP BC
001515 E233 3827            12      JR  C,RBWERR
001517 E235 ED5B7EF1        20      LD  DE,(_DTBUF)
00151B E239 EDB0                    LDIR
00151D E23B CDDDDF          17      CALL    WTDB        ;バッファデータは更新された
       E23E                     RBWEND:
001520 E23E CDA8E1          17      CALL    RBXEND
                                
001523 E241 CD41E3          17      CALL    RBX1
001526 E244 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
001528 E246 CD7AE1          17      CALL    GET_RR_BCDE ;BCDE=Random record
00152B E249 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
00152E E24C FD7211          19      LD  (IY+17),D   ;
001531 E24F FD7112          19      LD  (IY+18),C   ;
001534 E252 FD7013          19      LD  (IY+19),B   ;
       E255                     RBW1:
001537 E255 FDE1            14      POP IY
001539 E257 C1              10      POP BC
00153A E258 D1              10      POP DE
00153B E259 E1              10      POP HL
       E25A                     DD_NUL:
00153C E25A AF               4      XOR A
       E25B                     DRDF0:
       E25B                     DWTF0:
00153D E25B C9              10      RET
                                
       E25C                     RBWERR:
00153E E25C FDE5            15      PUSH    IY
001540 E25E D1              10      POP DE
001541 E25F 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
001543 E261 CD48D4          17      CALL    BDOS0
       E264                     RBRERR1:
001546 E264 3E01             7      LD  A,001H
       E266                     RBRERR2:
001548 E266 FDE1            14      POP IY
00154A E268 C1              10      POP BC
00154B E269 D1              10      POP DE
00154C E26A E1              10      POP HL
00154D E26B 37               4      SCF
00154E E26C 210000          10      LD  HL,0
001551 E26F C9              10      RET
                                
       E270                     RBRERR:
001552 E270 3EFF             7      LD  A,0FFH
001554 E272 18F2            12      JR  RBRERR2
                                
       E274                     RBRFL:
001556 E274 3E00             7  RBRFLP: LD  A,000H
001558 E276 FE0D             7      CP  00DH
00155A E278 2005            12      JR  NZ,RBRFL1
00155C E27A D5              11      PUSH    DE
00155D E27B 1E0A             7      LD  E,00AH
00155F E27D 1805            12      JR  RBRFL2
       E27F                     RBRFL1:
001561 E27F D5              11      PUSH    DE
001562 E280 CD09F0          17      CALL    _SYS07
001565 E283 5F               4      LD  E,A
       E284                     RBRFL2:
001566 E284 CDCDF0          17      CALL    _PRINT
001569 E287 7B               4      LD  A,E
00156A E288 D1              10      POP DE
00156B E289 3275E2          13      LD  (RBRFLP+1),A
00156E E28C C9              10      RET
                                
                                                ;Read random block
       E28D                     _SYS27:     ;(BDOS)ランダムブロック読み込み
00156F E28D 225DF0          16      LD  (LEFTX),HL
001572 E290 CDB2DC          17      CALL    SETDRV
                                
001575 E293 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
001579 E297 C220E3          10      JP  NZ,RBRDIR   ;ディレクトリ
00157C E29A CD32E3          17      CALL    RBX0
00157F E29D DA70E2          10      JP  C,RBRERR
001582 E2A0 CD41E3          17      CALL    RBX1
001585 E2A3 D459E3          17      CALL    NC,RBX1R
001588 E2A6 DA64E2          10      JP  C,RBRERR1
00158B E2A9 EB               4      EX  DE,HL
00158C E2AA ED52            15      SBC HL,DE       ;CP 00HL,BCDE
00158E E2AC 19              11      ADD HL,DE
00158F E2AD 79               4      LD  A,C
001590 E2AE DE00             7      SBC A,0
001592 E2B0 78               4      LD  A,B
001593 E2B1 DE00             7      SBC A,0
001595 E2B3 3801            12      JR  C,RBR1
001597 E2B5 EB               4      EX  DE,HL
       E2B6                     RBR1:
001598 E2B6 9F               4      SBC A,A
001599 E2B7 E601             7      AND 1
00159B E2B9 321EE3          13      LD  (RBRA_SWC),A
                                
00159E E2BC 7C               4      LD  A,H
00159F E2BD B5               4      OR  L
0015A0 E2BE 2857            12      JR  Z,RBREND0
                                
0015A2 E2C0 22A9E1          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
0015A5 E2C3 225DF0          16      LD  (LEFTX),HL
                                
0015A8 E2C6 CD61E3          17      CALL    RBX2
0015AB E2C9 2819            12      JR  Z,RBRB
0015AD E2CB CD80E3          17      CALL    RBXA
0015B0 E2CE DA70E2          10      JP  C,RBRERR
0015B3 E2D1 C5              11      PUSH    BC
0015B4 E2D2 EDB0                    LDIR
0015B6 E2D4 ED535FF0        20      LD  (DTAX),DE
0015BA E2D8 2A5DF0          16      LD  HL,(LEFTX)
0015BD E2DB D1              10      POP DE
0015BE E2DC A7               4      AND A
0015BF E2DD ED52            15      SBC HL,DE
0015C1 E2DF 225DF0          16      LD  (LEFTX),HL
0015C4 E2E2 2830            12      JR  Z,RBREND
                                
       E2E4                     RBRB:
0015C6 E2E4 CDB5E3          17      CALL    RBXB
0015C9 E2E7 2815            12      JR  Z,RBRC
       E2E9                     RBRB1:
0015CB E2E9 C5              11      PUSH    BC
0015CC E2EA D5              11      PUSH    DE
0015CD E2EB CDBADE          17      CALL    CLUSTX
0015D0 E2EE CDDFE3          17      CALL    DRDC
0015D3 E2F1 D1              10      POP DE
0015D4 E2F2 C1              10      POP BC
0015D5 E2F3 D42AE6          17      CALL    NC,GNCLX
0015D8 E2F6 DA70E2          10      JP  C,RBRERR
0015DB E2F9 10EE            13      DJNZ    RBRB1
0015DD E2FB CD29E4          17      CALL    DRW_FLUSH
       E2FE                     RBRC:
0015E0 E2FE CDCDE3          17      CALL    RBXC
0015E3 E301 2811            12      JR  Z,RBREND
0015E5 E303 C5              11      PUSH    BC
0015E6 E304 CDBADE          17      CALL    CLUSTX
0015E9 E307 CD8BE4          17      CALL    DRDX
0015EC E30A C1              10      POP BC
0015ED E30B DA70E2          10      JP  C,RBRERR
0015F0 E30E EB               4      EX  DE,HL
0015F1 E30F 2A7EF1          16      LD  HL,(_DTBUF)
0015F4 E312 EDB0                    LDIR
       E314                     RBREND:
0015F6 E314 CDA8E1          17      CALL    RBXEND
       E317                     RBREND0:
0015F9 E317 FDE1            14      POP IY
0015FB E319 C1              10      POP BC
0015FC E31A D1              10      POP DE
0015FD E31B F1              10      POP AF  ;(HL)
0015FE E31C AF               4      XOR A
0015FF E31D 3E00             7      LD  A,000H
       E31E                     RBRA_SWC    EQU $-1
001601 E31F C9              10      RET
                                
       E320                     RBRDIR:
001602 E320 FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001605 E323 FD661B          19      LD  H,(IY+27)
001608 E326 CDF9DE          17      CALL    CHDIR
00160B E329 AF               4      XOR A
00160C E32A 67               4      LD  H,A
00160D E32B 6F               4      LD  L,A
00160E E32C 3C               4      INC A
00160F E32D 321EE3          13      LD  (RBRA_SWC),A
001612 E330 18E5            12      JR  RBREND0
                                ;(15)
       E332                     RBX0:
001614 E332 2A8AF0          16      LD  HL,(_DTA)
001617 E335 225FF0          16      LD  (DTAX),HL
00161A E338 2A5DF0          16      LD  HL,(LEFTX)
00161D E33B FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
001620 E33E D6FD             7      SUB 0FDH
001622 E340 C9              10      RET
                                
       E341                     RBX1:               ;ファイルサイズとランダムレコードを比べる
001623 E341 E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
001624 E342 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
001627 E345 FD6611          19      LD  H,(IY+17)   ;
00162A E348 FD7E12          19      LD  A,(IY+18)   ;
                                
00162D E34B CD7AE1          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001630 E34E A7               4      AND A
001631 E34F ED52            15      SBC HL,DE
001633 E351 99               4      SBC A,C
001634 E352 4F               4      LD  C,A
001635 E353 FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
001638 E356 98               4      SBC A,B
001639 E357 D1              10      POP DE
00163A E358 C9              10      RET
       E359                     RBX1R:              ;(8)
00163B E359 47               4      LD  B,A
00163C E35A B1               4      OR  C
00163D E35B EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
00163E E35C B2               4      OR  D
00163F E35D B3               4      OR  E
001640 E35E C0              11      RET NZ
001641 E35F 37               4      SCF
001642 E360 C9              10      RET
                                
       E361                     RBX2:               ;Cluster settings
001643 E361 FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001646 E364 FD4E23          19      LD  C,(IY+35)
001649 E367 0600             7      LD  B,0
00164B E369 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00164F E36D 2003            12      JR  NZ,RBX3
001651 E36F FD4624          19      LD  B,(IY+36)
       E372                     RBX3:
001654 E372 CDA6E0          17      CALL    RWXR
001657 E375 3A97E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
00165A E378 3D               4      DEC A
00165B E379 FDA622          19      AND (IY+34)
00165E E37C FDB621          19      OR  (IY+33)
001661 E37F C9              10      RET
                                
       E380                     RBXA:
001662 E380 C5              11      PUSH    BC
001663 E381 D5              11      PUSH    DE
001664 E382 CDBADE          17      CALL    CLUSTX
001667 E385 CD8BE4          17      CALL    DRDX
00166A E388 D1              10      POP DE
00166B E389 C1              10      POP BC
00166C E38A D42AE6          17      CALL    NC,GNCLX
00166F E38D D8              11      RET C
001670 E38E ED53FEF1        20      LD  (_CLPS),DE
                                
001674 E392 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
001677 E395 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       E396                     SECSZ   EQU $-2
       E397                     SECSZ_H EQU $-1
00167A E398 7C               4      LD  A,H
00167B E399 3D               4      DEC A       ;1024=3 / 512=1
00167C E39A FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
00167F E39D 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
001680 E39E ED42            15      SBC HL,BC       ;残りを計算
                                
001682 E3A0 ED5B5DF0        20      LD  DE,(LEFTX)
001686 E3A4 ED52            15      SBC HL,DE       ;CP HL,DE
001688 E3A6 19              11      ADD HL,DE       ;
001689 E3A7 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
00168B E3A9 EB               4      EX  DE,HL
       E3AA                     RBXA1:
00168C E3AA E5              11      PUSH    HL
00168D E3AB 2A7EF1          16      LD  HL,(_DTBUF)
001690 E3AE 09              11      ADD HL,BC
001691 E3AF ED5B5FF0        20      LD  DE,(DTAX)
001695 E3B3 C1              10      POP BC
001696 E3B4 C9              10      RET
                                
       E3B5                     RBXB:
001697 E3B5 2A5FF0          16      LD  HL,(DTAX)
00169A E3B8 ED5BFEF1        20      LD  DE,(_CLPS)
00169E E3BC 3A5EF0          13      LD  A,(LEFTX+1)
0016A1 E3BF 47               4      LD  B,A
0016A2 E3C0 3A97E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E3C3                     RBXB1:
0016A5 E3C3 1F               4      RRA     ;->CF
0016A6 E3C4 3804            12      JR  C,RBXB2
0016A8 E3C6 CB38             8      SRL B   ;B=B/2
0016AA E3C8 18F9            12      JR  RBXB1
       E3CA                     RBXB2:
0016AC E3CA 78               4      LD  A,B
0016AD E3CB B7               4      OR  A
0016AE E3CC C9              10      RET
                                ;(12)
       E3CD                     RBXC:
0016AF E3CD ED4B5DF0        20      LD  BC,(LEFTX)
0016B3 E3D1 3A97E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
0016B6 E3D4 3D               4      DEC A
0016B7 E3D5 A0               4      AND B
0016B8 E3D6 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
0016B9 E3D7 B1               4      OR  C
0016BA E3D8 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E3D9                     DWTC:
0016BB E3D9 E5              11      PUSH    HL
0016BC E3DA 21C1E7          10      LD  HL,DWT24B
0016BF E3DD 1804            12      JR  DWTC1
       E3DF                     DRDC:
0016C1 E3DF E5              11      PUSH    HL
0016C2 E3E0 21B3E7          10      LD  HL,DRD24B
       E3E3                     DWTC1:
0016C5 E3E3 223DE4          16      LD  (DRWF_MODE),HL
0016C8 E3E6 E1              10      POP HL
0016C9 E3E7 3A2DE4          13      LD  A,(DRWF_B)
0016CC E3EA B7               4      OR  A
0016CD E3EB 200F            12      JR  NZ,DRDC1
       E3ED                     SAVE_DRWC:
0016CF E3ED 0601             7      LD  B,1
0016D1 E3EF ED432CE4        20      LD  (DRWF_C),BC
0016D5 E3F3 ED5333E4        20      LD  (DRWF_E),DE
0016D9 E3F7 2236E4          16      LD  (DRWF_HL),HL
0016DC E3FA 1820            12      JR  INC_HL_DRWC
       E3FC                     DRDC1:
0016DE E3FC E5              11      PUSH    HL
0016DF E3FD 2133E4          10      LD  HL,DRWF_E
0016E2 E400 86               7      ADD A,(HL)
0016E3 E401 F5              11      PUSH    AF
0016E4 E402 BB               4      CP  E
0016E5 E403 201D            12      JR  NZ,DRDC2
0016E7 E405 F1              10      POP AF
0016E8 E406 23               6      INC HL
0016E9 E407 7E               7      LD  A,(HL)
0016EA E408 CE00             7      ADC A,0
0016EC E40A F5              11      PUSH    AF
0016ED E40B BA               4      CP  D
0016EE E40C 2014            12      JR  NZ,DRDC2
0016F0 E40E F1              10      POP AF
0016F1 E40F 3A2CE4          13      LD  A,(DRWF_C)
0016F4 E412 CE00             7      ADC A,0
0016F6 E414 B9               4      CP  C
0016F7 E415 200C            12      JR  NZ,DRDC3
0016F9 E417 212DE4          10      LD  HL,DRWF_B
0016FC E41A 34              11      INC (HL)
0016FD E41B E1              10      POP HL
       E41C                     INC_HL_DRWC:
0016FE E41C 3A97E3          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
001701 E41F 84               4      ADD A,H
001702 E420 67               4      LD  H,A
001703 E421 C9              10      RET
       E422                     DRDC2:
001704 E422 F1              10      POP AF
       E423                     DRDC3:
001705 E423 CD29E4          17      CALL    DRW_FLUSH
001708 E426 E1              10      POP HL
001709 E427 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E429                     DRW_FLUSH:
00170B E429 C5              11      PUSH    BC
00170C E42A D5              11      PUSH    DE
00170D E42B 010000          10      LD  BC,0
       E42C                     DRWF_C  EQU $-2
       E42D                     DRWF_B  EQU $-1
001710 E42E 78               4      LD  A,B
001711 E42F B7               4      OR  A
001712 E430 280D            12      JR  Z,DRDF1
001714 E432 110000          10      LD  DE,0
       E433                     DRWF_E  EQU $-2
       E434                     DRWF_D  EQU $-1
001717 E435 210000          10      LD  HL,0
       E436                     DRWF_HL EQU $-2
00171A E438 AF               4      XOR A
00171B E439 322DE4          13      LD  (DRWF_B),A
00171E E43C CDB3E7          17      CALL    DRD24B
       E43D                     DRWF_MODE   EQU $-2
       E43F                     DRDF1:
001721 E43F D1              10      POP DE
001722 E440 C1              10      POP BC
001723 E441 C9              10      RET
                                
       E442                     RB_WRITE:
001724 E442 C5              11      PUSH    BC
001725 E443 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
001727 E445 1803            12      JR  RBRW
       E447                     RB_READ:
001729 E447 C5              11      PUSH    BC
00172A E448 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       E44A                     RBRW:
00172C E44A 1F               4      RRA     ;AHL = AHL*128
00172D E44B 7C               4      LD  A,H ;AHL = AHL0/2
00172E E44C 1F               4      RRA     ;A
00172F E44D 65               4      LD  H,L ;
001730 E44E CB1C             8      RR  H   ;H
001732 E450 2E00             7      LD  L,0 ;
001734 E452 CB1D             8      RR  L   ;L
001736 E454 CD5FE1          17      CALL    SET_RR_AHL
001739 E457 218000          10      LD  HL,128
00173C E45A C5              11      PUSH    BC
       E45B                     SETSEQ_SWC_RND:
00173D E45B CD8EE1          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
001740 E45E C1              10      POP BC
001741 E45F FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
001745 E463 FDE5            15      PUSH    IY
001747 E465 D1              10      POP DE
001748 E466 D5              11      PUSH    DE
001749 E467 CD48D4          17      CALL    BDOS0
00174C E46A FDE1            14      POP IY
00174E E46C CD69E1          17      CALL    SETSEQ      ;SETSEQ or POPRR
       E46D                     SETSEQ_SWC_SEQ_RR   EQU $-2
001751 E46F FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
001755 E473 C1              10      POP BC
001756 E474 C9              10      RET
                                
                                ;(22)
       E475                     INIT_SEQ:
001757 E475 3E01             7      LD  A,1     ;LD BC,????
001759 E477 2169E1          10      LD  HL,SETSEQ
00175C E47A CD2FE1          17      CALL    PUSHRR
       E47D                     GETSEQ:
00175F E47D FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
001762 E480 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
001765 E483 AF               4      XOR A
                                
001766 E484 CB25             8      SLA L   ;L=L*2
                                
001768 E486 CB3C             8      SRL H   ;HL=HL/2
00176A E488 CB1D             8      RR  L   ;
00176C E48A C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E48B                     DRDX:
00176D E48B CDC9E4          17      CALL    DRDY
001770 E48E C8              11      RET Z
001771 E48F CDAFE4          17      CALL    DRDX1       ;データバッファの情報を保存
001774 E492 D8              11      RET C
001775 E493 E5              11      PUSH    HL
001776 E494 C5              11      PUSH    BC
001777 E495 D5              11      PUSH    DE
001778 E496 2A7EF1          16      LD  HL,(_DTBUF)
00177B E499 3AF2E4          13      LD  A,(_DBS24)
00177E E49C 4F               4      LD  C,A
00177F E49D CDB1E7          17      CALL    DRD24
001782 E4A0 DCC4E4          17      CALL    C,DRDNE
       E4A3                     POP_DE_BC_HL_RET:
001785 E4A3 D1              10      POP DE
001786 E4A4 C1              10      POP BC
001787 E4A5 E1              10      POP HL
001788 E4A6 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E4A7                     DRDN:
001789 E4A7 AF               4      XOR A
00178A E4A8 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
00178B E4A9 30E0            12      JR  NC,DRDX
       E4AB                     DRDNX:
00178D E4AB CDC9E4          17      CALL    DRDY
001790 E4AE C8              11      RET Z
       E4AF                     DRDX1:
001791 E4AF CDDFE4          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
001794 E4B2 ED53A6F0        20      LD  (_DBSEC),DE
001798 E4B6 79               4      LD  A,C
001799 E4B7 32F2E4          13      LD  (_DBS24),A
                                
00179C E4BA 3A88F0          13      LD  A,(_DRV)
00179F E4BD 32A5F0          13      LD  (_DBDRV),A
0017A2 E4C0 CDD9F0          17      CALL    _CHGDRV
0017A5 E4C3 D0              11      RET NC
       E4C4                     DRDNE:
0017A6 E4C4 9F               4      SBC A,A     ;CF=1ならばA=0FFH
0017A7 E4C5 32A5F0          13      LD  (_DBDRV),A
0017AA E4C8 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E4C9                     DRDY:
0017AB E4C9 3AF2E4          13      LD  A,(_DBS24)
0017AE E4CC B9               4      CP  C
0017AF E4CD C0              11      RET NZ
                                
0017B0 E4CE E5              11      PUSH    HL
0017B1 E4CF 3A88F0          13      LD  A,(_DRV)
0017B4 E4D2 21A5F0          10      LD  HL,_DBDRV
0017B7 E4D5 AE               7      XOR (HL)
0017B8 E4D6 2005            12      JR  NZ,POP_HL_RET
                                
0017BA E4D8 2AA6F0          16      LD  HL,(_DBSEC)
0017BD E4DB ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E4DD                     POP_HL_RET:
0017BF E4DD E1              10      POP HL
0017C0 E4DE C9              10      RET
                                
       E4DF                     DWTX:
0017C1 E4DF 3AA4F0          13      LD  A,(_WTDBF)
0017C4 E4E2 B7               4      OR  A
0017C5 E4E3 C8              11      RET Z
0017C6 E4E4 AF               4      XOR A
0017C7 E4E5 32A4F0          13      LD  (_WTDBF),A
                                
0017CA E4E8 E5              11      PUSH    HL
0017CB E4E9 C5              11      PUSH    BC
0017CC E4EA D5              11      PUSH    DE
0017CD E4EB 3AA5F0          13      LD  A,(_DBDRV)
0017D0 E4EE CDD9F0          17      CALL    _CHGDRV
0017D3 E4F1 0E00             7      LD  C,0
       E4F2                     _DBS24  EQU $-1
0017D5 E4F3 ED5BA6F0        20      LD  DE,(_DBSEC)
0017D9 E4F7 2A7EF1          16      LD  HL,(_DTBUF)
0017DC E4FA D4BFE7          17      CALL    NC,DWT24
       E4FD                     POP_DE_BC_HL_RET2:
0017DF E4FD 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E4FF                     RDFATX:
0017E1 E4FF E5              11      PUSH    HL
0017E2 E500 3A88F0          13      LD  A,(_DRV)
0017E5 E503 21AAF0          10      LD  HL,_FATDRV
0017E8 E506 AE               7      XOR (HL)
0017E9 E507 28D4            12      JR  Z,POP_HL_RET
                                
0017EB E509 C5              11      PUSH    BC
0017EC E50A D5              11      PUSH    DE
0017ED E50B DDE5            15      PUSH    IX
0017EF E50D CD29E5          17      CALL    WTFATX
0017F2 E510 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
0017F4 E512 AF               4      XOR A
0017F5 E513 32ABF0          13      LD  (_FATIX),A
0017F8 E516 3A88F0          13      LD  A,(_DRV)
0017FB E519 32AAF0          13      LD  (_FATDRV),A
0017FE E51C CDE5F0          17      CALL    _RDFAT
       E51F                     RDFATE2:
001801 E51F 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
001803 E521 9F               4      SBC A,A     ;A=0xFF
001804 E522 32AAF0          13      LD  (_FATDRV),A
       E525                     POP_IX_DE_BC_HL_RET:
001807 E525 DDE1            14      POP IX
001809 E527 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E529                     WTFATX:
00180B E529 3AA2F0          13      LD  A,(_WTFATF)
00180E E52C B7               4      OR  A
00180F E52D C8              11      RET Z
001810 E52E AF               4      XOR A
001811 E52F 32A2F0          13      LD  (_WTFATF),A
                                
001814 E532 E5              11      PUSH    HL
001815 E533 3AAAF0          13      LD  A,(_FATDRV)
001818 E536 21A5F0          10      LD  HL,_DBDRV
00181B E539 AE               7      XOR (HL)
00181C E53A CCDFE4          17      CALL    Z,DWTX
00181F E53D 389E            12      JR  C,POP_HL_RET
001821 E53F C5              11      PUSH    BC
001822 E540 D5              11      PUSH    DE
001823 E541 DDE5            15      PUSH    IX
001825 E543 CDD0E7          17      CALL    FATSETUP
001828 E546 D4C1E7          17      CALL    NC,DWT24B
00182B E549 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E54B                     N16CL1:
00182D E54B 7A               4      LD  A,D
00182E E54C B3               4      OR  E
00182F E54D 37               4      SCF
001830 E54E C8              11      RET Z
                                
001831 E54F 7A               4      LD  A,D
001832 E550 1807            12      JR  NCL1X
       E552                     NCL1:
001834 E552 7A               4      LD  A,D
001835 E553 B3               4      OR  E
001836 E554 37               4      SCF
001837 E555 C8              11      RET Z
                                
001838 E556 7A               4      LD  A,D
001839 E557 CB3F             8      SRL A   ;/2
       E559                     NCL1X:
00183B E559 CB3F             8      SRL A   ;/2
                                
00183D E55B E5              11      PUSH    HL
00183E E55C 327BE5          13      LD  (NCLPAT_FATIX),A    ;_FATIX
001841 E55F 2AAAF0          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001844 E562 BC               4      CP  H
001845 E563 3A88F0          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001848 E566 327AE5          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
00184B E569 2005            12      JR  NZ,NCL2     ;FATIXが違う
00184D E56B BD               4      CP  L
00184E E56C 2002            12      JR  NZ,NCL2     ;ドライブが違う
001850 E56E E1              10      POP HL
001851 E56F C9              10      RET
       E570                     NCL2:
001852 E570 C5              11      PUSH    BC
001853 E571 D5              11      PUSH    DE
001854 E572 DDE5            15      PUSH    IX
001856 E574 CD29E5          17      CALL    WTFATX
001859 E577 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
00185B E579 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E57B                     NCLPAT_FATIX    EQU $-1
       E57A                     NCLPAT_FATDRV   EQU $-2
00185E E57C ED43AAF0        20      LD  (_FATDRV),BC
001862 E580 CDA5E7          17      CALL    RDFATS
001865 E583 189A            12      JR  RDFATE2
                                
       E585                     NCL3:
001867 E585 CB9A             8      RES 3,D
001869 E587 CB92             8      RES 2,D
00186B E589 6B               4      LD  L,E
00186C E58A 62               4      LD  H,D
00186D E58B CB3C             8      SRL H   ;
00186F E58D CB1D             8      RR  L   ;HLA=HLA/2
001871 E58F 1F               4      RRA     ;
001872 E590 F5              11      PUSH    AF
001873 E591 3AABF0          13      LD  A,(_FATIX)
001876 E594 0F               4      RRCA
001877 E595 300B            12      JR  NC,NCL3X1
001879 E597 3A97E3          13      LD  A,(SECSZ_H)
00187C E59A FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの際に先頭を512バイトずらす
00187E E59C 2004            12      JR  NZ,NCL3X1
001880 E59E 010002          10      LD  BC,512
001883 E5A1 09              11      ADD HL,BC
       E5A2                     NCL3X1:
001884 E5A2 F1              10      POP AF
001885 E5A3 ED4B7CF1        20      LD  BC,(_FATBF)
001889 E5A7 19              11      ADD HL,DE
00188A E5A8 09              11      ADD HL,BC
00188B E5A9 17               4      RLA
00188C E5AA C9              10      RET
                                
       E5AB                     GNCL:
00188D E5AB CD52E5          17      CALL    NCL1        ;GET NEXT CLUSTER
001890 E5AE D8              11      RET C
001891 E5AF C5              11      PUSH    BC
001892 E5B0 E5              11      PUSH    HL
001893 E5B1 CD85E5          17      CALL    NCL3
001896 E5B4 3809            12      JR  C,GNC1
001898 E5B6 5E               7      LD  E,(HL)
001899 E5B7 23               6      INC HL
00189A E5B8 7E               7      LD  A,(HL)
00189B E5B9 E60F             7      AND 00FH
00189D E5BB 57               4      LD  D,A
00189E E5BC E1              10      POP HL
00189F E5BD C1              10      POP BC
0018A0 E5BE C9              10      RET
       E5BF                     GNC1:
0018A1 E5BF 7E               7      LD  A,(HL)
0018A2 E5C0 23               6      INC HL
0018A3 E5C1 56               7      LD  D,(HL)
0018A4 E5C2 0604             7      LD  B,4
       E5C4                     GNC1L:
0018A6 E5C4 CB3A             8      SRL D   ;DA=DA/2
0018A8 E5C6 1F               4      RRA     ;
0018A9 E5C7 10FB            13      DJNZ    GNC1L
                                
0018AB E5C9 5F               4      LD  E,A
0018AC E5CA E1              10      POP HL
0018AD E5CB C1              10      POP BC
0018AE E5CC A7               4      AND A
0018AF E5CD C9              10      RET
                                
       E5CE                     SNCL:
0018B0 E5CE CD52E5          17      CALL    NCL1
0018B3 E5D1 D8              11      RET C
                                ;               SET NEXT CLUSTER
0018B4 E5D2 E5              11      PUSH    HL
0018B5 E5D3 C5              11      PUSH    BC
0018B6 E5D4 D5              11      PUSH    DE
0018B7 E5D5 E5              11      PUSH    HL
0018B8 E5D6 CD85E5          17      CALL    NCL3
0018BB E5D9 D1              10      POP DE
                                ;CF=ODD
0018BC E5DA 7E               7      LD  A,(HL)
0018BD E5DB 73               7      LD  (HL),E
0018BE E5DC 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
0018C0 E5DE 23               6      INC HL
0018C1 E5DF ED67            18      RRD     ;M={A[3:0],E[3:0]}
0018C3 E5E1 7A               4      LD  A,D
0018C4 E5E2 1804            12      JR  SNC11
       E5E4                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
0018C6 E5E4 ED6F            18      RLD     ;M={D[3:0],E[7:4]}
0018C8 E5E6 23               6      INC HL
0018C9 E5E7 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E5E8                     SNC11:
0018CA E5E8 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
0018CC E5EA B7               4      OR  A
0018CD E5EB D1              10      POP DE
0018CE E5EC C1              10      POP BC
0018CF E5ED E1              10      POP HL
       E5EE                     FAT_CHANGED:
0018D0 E5EE 3EFF             7      LD  A,0FFH
0018D2 E5F0 32A2F0          13      LD  (_WTFATF),A
0018D5 E5F3 C9              10      RET
                                
       E5F4                     N16CL3:
0018D6 E5F4 C5              11      PUSH    BC
0018D7 E5F5 6B               4      LD  L,E
0018D8 E5F6 7A               4      LD  A,D
0018D9 E5F7 E601             7      AND 1
0018DB E5F9 67               4      LD  H,A
0018DC E5FA 29              11      ADD HL,HL
0018DD E5FB ED4B7CF1        20      LD  BC,(_FATBF)
0018E1 E5FF 09              11      ADD HL,BC
0018E2 E600 C1              10      POP BC
0018E3 E601 C9              10      RET
                                
       E602                     GNCL16:
0018E4 E602 CD4BE5          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
0018E7 E605 D8              11      RET C
0018E8 E606 E5              11      PUSH    HL
0018E9 E607 CDF4E5          17      CALL    N16CL3
0018EC E60A 5E               7      LD  E,(HL)
0018ED E60B 23               6      INC HL
0018EE E60C 56               7      LD  D,(HL)
0018EF E60D E1              10      POP HL
0018F0 E60E C9              10      RET
                                
       E60F                     SNCL16:
0018F1 E60F CD4BE5          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
0018F4 E612 D8              11      RET C
0018F5 E613 D5              11      PUSH    DE
0018F6 E614 E5              11      PUSH    HL
0018F7 E615 CDF4E5          17      CALL    N16CL3
0018FA E618 D1              10      POP DE      ;HL
0018FB E619 73               7      LD  (HL),E
0018FC E61A 23               6      INC HL
0018FD E61B 72               7      LD  (HL),D
0018FE E61C 6B               4      LD  L,E
0018FF E61D 62               4      LD  H,D
001900 E61E D1              10      POP DE
001901 E61F 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E621                     NEXTX:
001903 E621 3E00             7      LD  A,0 ;自己書き換え
       E622                     _SECPS  EQU $-1
001905 E623 3C               4      INC A
001906 E624 E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E625                     _NCPAT  EQU $-1
001908 E626 3222E6          13      LD  (_SECPS),A
00190B E629 C9              10      RET
                                
       E62A                     GNCLX:
00190C E62A CD21E6          17      CALL    NEXTX
00190F E62D C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001910 E62E C3F7F0          10      JP  _GNCL   ;次のクラスタを探す
                                
       E631                     RDFAT:
001913 E631 3E80             7      LD  A,080H
001915 E633 3270F0          13      LD  (CHECK),A
       E636                     RDFAT1:
001918 E636 3A88F0          13      LD  A,(_DRV)
00191B E639 CDD9E8          17      CALL    CHGDRVR
00191E E63C D8              11      RET C
00191F E63D DD7E12          19      LD  A,(IX+DPB_DEVICE)
001922 E640 CB6F             8      BIT 5,A
001924 E642 286C            12      JR  Z,RDFAT0X
001926 E644 2170F0          10      LD  HL,CHECK
001929 E647 A6               7      AND (HL)
00192A E648 77               7      LD  (HL),A
00192B E649 110000          10      LD  DE,0        ;BPB
00192E E64C 2A7CF1          16      LD  HL,(_FATBF)
001931 E64F 0E00             7      LD  C,0
001933 E651 CDB1E7          17      CALL    DRD24
001936 E654 3022            12      JR  NC,GETBPB
001938 E656 2170F0          10      LD  HL,CHECK
00193B E659 CB06            15      RLC (HL)
00193D E65B 3F               4      CCF
00193E E65C D8              11      RET C
00193F E65D DDCB0A1E        23      RR  (IX+DPB_FDMODE)
001943 E661 3F               4      CCF         ;フロッピーディスクのFDモード(2D/2HD)を切り替える
001944 E662 DDCB0A16        23      RL  (IX+DPB_FDMODE)
001948 E666 3A84F0          13      LD  A,(_DRIVE)
00194B E669 E603             7      AND 3
00194D E66B F680             7      OR  080H
00194F E66D 6F               4      LD  L,A
001950 E66E 26F0             7      LD  H,_CYL0/256
001952 E670 3EFF             7      LD  A,0FFH
001954 E672 3289F0          13      LD  (_DSK),A
001957 E675 77               7      LD  (HL),A
001958 E676 18BE            12      JR  RDFAT1
       E678                     GETBPB:
00195A E678 FDE5            15      PUSH    IY
00195C E67A FD2A7CF1        20      LD  IY,(_FATBF) ;BPB
001960 E67E CDF1F0          17      CALL    _BPB2DPB
001963 E681 FDE1            14      POP IY
001965 E683 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001968 E686 3025            12      JR  NC,GETBPBOK
00196A E688 E60F             7      AND 00FH
00196C E68A FE07             7      CP  7
00196E E68C 37               4      SCF
00196F E68D C0              11      RET NZ
001970 E68E DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001974 E692 21C0F1          10      LD  HL,M2D
001977 E695 2006            12      JR  NZ,SETFDMODE
001979 E697 CD8AE7          17      CALL    CHECK1024
00197C E69A D8              11      RET C
00197D E69B 2ED2             7      LD  L,M2HD-STABLE
       E69D                     SETFDMODE:
00197F E69D DDE5            15      PUSH    IX
001981 E69F D1              10      POP DE
001982 E6A0 EDA0            16      LDI
001984 E6A2 EDA0            16      LDI
001986 E6A4 13               6      INC DE
001987 E6A5 13               6      INC DE
001988 E6A6 13               6      INC DE
001989 E6A7 13               6      INC DE
00198A E6A8 010C00          10      LD  BC,12
00198D E6AB EDB0                    LDIR
       E6AD                     GETBPBOK:
00198F E6AD CD45E8          17      CALL    CHGDRV2
       E6B0                     RDFAT0X:
001992 E6B0 CDA5E7          17      CALL    RDFATS
001995 E6B3 D8              11      RET C
001996 E6B4 DDAE06          19      XOR (IX+DPB_FATID)
001999 E6B7 C8              11      RET Z
00199A E6B8 DD7E12          19      LD  A,(IX+DPB_DEVICE)
00199D E6BB CB5F             8      BIT 3,A
00199F E6BD 2803            12      JR  Z,RDFAT0X1
0019A1 E6BF CB6F             8      BIT 5,A
0019A3 E6C1 C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E6C2                     RDFAT0X1:
0019A4 E6C2 37               4      SCF
0019A5 E6C3 C9              10      RET
                                
       E6C4                     POP_HL_SCF_RET:
0019A6 E6C4 E1              10      POP HL
0019A7 E6C5 37               4      SCF
0019A8 E6C6 C9              10      RET
                                
       E6C7                     BPB2DPB:
0019A9 E6C7 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
0019AC E6CA B7               4      OR  A
0019AD E6CB 37               4      SCF
0019AE E6CC C0              11      RET NZ
       E6CD                     BPBOK:
0019AF E6CD FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
0019B2 E6D0 DD7707          19      LD  (IX+DPB_SECPCL),A
                                
0019B5 E6D3 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
0019B8 E6D6 DD7700          19      LD  (IX+DPB_FATLN),A
0019BB E6D9 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
0019BE E6DC DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
0019C1 E6DF FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
0019C4 E6E2 FD660F          19      LD  H,(IY+15)
0019C7 E6E5 DD750E          19      LD  (IX+DPB_FATPS),L
0019CA E6E8 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
0019CD E6EB FD5617          19      LD  D,(IY+23)
0019D0 E6EE FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E6F1                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
0019D3 E6F1 19              11      ADD HL,DE
0019D4 E6F2 10FD            13      DJNZ    BPBDP1
       E6F4                     BPBDP2:
0019D6 E6F4 DD7510          19      LD  (IX+DPB_DIRPS),L
0019D9 E6F7 DD7411          19      LD  (IX+DPB_DIRPS+1),H
0019DC E6FA E5              11      PUSH    HL
                                
0019DD E6FB FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
0019E0 E6FE FD6612          19      LD  H,(IY+18)
0019E3 E701 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
0019E6 E704 B7               4      OR  A
0019E7 E705 28BD            12      JR  Z,POP_HL_SCF_RET
0019E9 E707 0606             7      LD  B,6
       E709                     BPBBPS1:
0019EB E709 05               4      DEC B
0019EC E70A 0F               4      RRCA
0019ED E70B 30FC            12      JR  NC,BPBBPS1
       E70D                     BPBDE1:
0019EF E70D 29              11      ADD HL,HL
0019F0 E70E 10FD            13      DJNZ    BPBDE1
                                
0019F2 E710 7C               4      LD  A,H
0019F3 E711 DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
0019F6 E714 D1              10      POP DE      ;DPB_DIRPS
0019F7 E715 6C               4      LD  L,H
0019F8 E716 2600             7      LD  H,0
0019FA E718 19              11      ADD HL,DE       ;MAXDIR
0019FB E719 E5              11      PUSH    HL
0019FC E71A FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
0019FF E71D CB21             8      SLA C       ;*2
001A01 E71F AF               4      XOR A
001A02 E720 47               4      LD  B,A
001A03 E721 ED42            15      SBC HL,BC
001A05 E723 DD7514          19      LD  (IX+DPB_ADDCL),L
001A08 E726 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
001A0B E729 D1              10      POP DE      ;DE=DPB_MAXDIR
001A0C E72A FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001A0F E72D FD6614          19      LD  H,(IY+20)
                                
001A12 E730 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001A15 E733 E60F             7      AND 00FH
001A17 E735 FE07             7      CP  7       ;フロッピー
001A19 E737 2019            12      JR  NZ,NOT_FD
001A1B E739 E5              11      PUSH    HL
001A1C E73A FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001A1F E73D DD710D          19      LD  (IX+DPB_MAXSEC),C
001A22 E740 AF               4      XOR A
001A23 E741 CB21             8      SLA C       ;両面なのでセクタ数を２倍
001A25 E743 0610             7      LD  B,16
       E745                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001A27 E745 29              11      ADD HL,HL
001A28 E746 17               4      RLA
001A29 E747 B9               4      CP  C
001A2A E748 3802            12      JR  C,DIVSEC1
001A2C E74A 91               4      SUB C
001A2D E74B 2C               4      INC L
       E74C                     DIVSEC1:
001A2E E74C 10F7            13      DJNZ    DIVSEC
001A30 E74E DD750C          19      LD  (IX+DPB_MAXCYL),L
001A33 E751 E1              10      POP HL  ;ここまでフロッピー専用
       E752                     NOT_FD:
001A34 E752 7C               4      LD  A,H
001A35 E753 B5               4      OR  L
001A36 E754 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001A38 E756 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001A3A E758 2F               4      CPL         ;A=0FFH
001A3B E759 FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001A3E E75C D8              11      RET C
001A3F E75D FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001A42 E760 FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001A45 E763 FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E766                     BPB16BIT:
001A48 E766 ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001A4A E768 DE00             7      SBC A,0
001A4C E76A FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E76D                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001A4F E76D CB18             8      RR  B       ;->CY
001A51 E76F 3808            12      JR  C,BPBTC2
001A53 E771 CB3F             8      SRL A
001A55 E773 CB1C             8      RR  H       ;AHL=AHL/2
001A57 E775 CB1D             8      RR  L
001A59 E777 18F4            12      JR  BPBTC1
       E779                     BPBTC2:
001A5B E779 C6FF             7      ADD A,0FFH
001A5D E77B D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001A5E E77C 23               6      INC HL
001A5F E77D 23               6      INC HL
001A60 E77E DD7508          19      LD  (IX+DPB_MAXCL),L
001A63 E781 DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001A66 E784 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001A69 E787 DD7706          19      LD  (IX+DPB_FATID),A
       E78A                     CHECK1024:
001A6C E78A FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001A6F E78D C6FE             7      ADD A,0-2       ;>2:CF=1
001A71 E78F FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001A74 E792 6F               4      LD  L,A
001A75 E793 3002            12      JR  NC,BPBFAT1
001A77 E795 F680             7      OR  080H
       E797                     BPBFAT1:            ;ここではCF=0
001A79 E797 DD770F          19      LD  (IX+DPB_BPS),A
001A7C E79A 3A7BF1          13      LD  A,(_MAX_SEC_SZ_H)
001A7F E79D BD               4      CP  L
001A80 E79E C8              11      RET Z       ;1セクタ1024バイト
001A81 E79F 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001A82 E7A0 C8              11      RET Z       ;1セクタ256バイト
001A83 E7A1 2D               4      DEC L
001A84 E7A2 C8              11      RET Z       ;1セクタ512バイト
001A85 E7A3 37               4      SCF
001A86 E7A4 C9              10      RET
                                
       E7A5                     RDFATS:
001A87 E7A5 CDD0E7          17      CALL    FATSETUP
001A8A E7A8 D8              11      RET C
001A8B E7A9 CDB3E7          17      CALL    DRD24B
001A8E E7AC 2A7CF1          16      LD  HL,(_FATBF)
001A91 E7AF 7E               7      LD  A,(HL)
001A92 E7B0 C9              10      RET
                                
       E7B1                     DRD24:
001A93 E7B1 0601             7      LD  B,1
       E7B3                     DRD24B:
001A95 E7B3 DDE5            15      PUSH    IX
001A97 E7B5 DD2AA8F0        20      LD  IX,(_DPB)
001A9B E7B9 CD19EA          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E7BA                     DRDPAT  EQU $-2
001A9E E7BC DDE1            14      POP IX
001AA0 E7BE C9              10      RET
                                
       E7BF                     DWT24:
001AA1 E7BF 0601             7      LD  B,1
       E7C1                     DWT24B:
001AA3 E7C1 DDE5            15      PUSH    IX
001AA5 E7C3 DD2AA8F0        20      LD  IX,(_DPB)
001AA9 E7C7 CDC2E9          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E7C8                     DWTPAT  EQU $-2
001AAC E7CA DDE1            14      POP IX
001AAE E7CC D0              11      RET NC
001AAF E7CD C35AF0          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E7D0                     FATSETUP:
001AB2 E7D0 3AAAF0          13      LD  A,(_FATDRV)
001AB5 E7D3 CDD9E8          17      CALL    CHGDRVR     ;ドライブ切り替え
001AB8 E7D6 D8              11      RET C
       E7D7                     FATS2:
001AB9 E7D7 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001ABC E7DA 0F               4      RRCA
001ABD E7DB CD0BE8          17      CALL    FATSETUP12  ;自己書き換え
       E7DC                     FATSX   EQU $-2
001AC0 E7DE 210000          10      LD  HL,0
001AC3 E7E1 4A               4      LD  C,D
001AC4 E7E2 54               4      LD  D,H
001AC5 E7E3 3AABF0          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
001AC8 E7E6 47               4      LD  B,A
001AC9 E7E7 04               4      INC B
001ACA E7E8 DD7E00          19      LD  A,(IX+DPB_FATLN)
       E7EB                     FAT_SKP:
001ACD E7EB 05               4      DEC B
001ACE E7EC 2809            12      JR  Z,FAT1
001AD0 E7EE 19              11      ADD HL,DE
001AD1 E7EF 93               4      SUB E
001AD2 E7F0 30F9            12      JR  NC,FAT_SKP
001AD4 E7F2 DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
001AD8 E7F6 C8              11      RET Z
       E7F7                     FAT1:
001AD9 E7F7 EB               4      EX  DE,HL
001ADA E7F8 B7               4      OR  A       ;0の場合は0100Hとして扱う
001ADB E7F9 2803            12      JR  Z,FAT3
001ADD E7FB B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001ADE E7FC 3801            12      JR  C,FAT2
       E7FE                     FAT3:
001AE0 E7FE 79               4      LD  A,C
       E7FF                     FAT2:
001AE1 E7FF 47               4      LD  B,A
                                
001AE2 E800 2AFAF1          16      LD  HL,(_FATPS) ;fat sector pos
001AE5 E803 19              11      ADD HL,DE
001AE6 E804 EB               4      EX  DE,HL
001AE7 E805 2A7CF1          16      LD  HL,(_FATBF)
001AEA E808 AF               4      XOR A       ;CF=0
001AEB E809 4F               4      LD  C,A
001AEC E80A C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E80B                     FATSETUP12:
001AED E80B 110606          10      LD  DE,0606H    ;256
001AF0 E80E D8              11      RET C
001AF1 E80F 110303          10      LD  DE,0303H    ;512
001AF4 E812 0F               4      RRCA
001AF5 E813 D8              11      RET C
001AF6 E814 110102          10      LD  DE,0201H    ;1024
001AF9 E817 C9              10      RET
                                
       E818                     FATSETUP16:
001AFA E818 110404          10      LD  DE,0404H    ;256
001AFD E81B D8              11      RET C
001AFE E81C 110202          10      LD  DE,0202H    ;512
001B01 E81F 0F               4      RRCA
001B02 E820 D8              11      RET C
001B03 E821 110101          10      LD  DE,0101H    ;1024
001B06 E824 C9              10      RET
                                
       E825                     CHGDRV:
001B07 E825 E5              11      PUSH    HL
001B08 E826 2189F0          10      LD  HL,_DSK
001B0B E829 BE               7      CP  (HL)
001B0C E82A 280A            12      JR  Z,CHGDRVE
       E82C                     CHGDRV1:
001B0E E82C DDE5            15      PUSH    IX
001B10 E82E CD38E8          17      CALL    CHGDRV0
001B13 E831 3A89F0          13      LD  A,(_DSK)
001B16 E834 DDE1            14      POP IX
       E836                     CHGDRVE:
001B18 E836 E1              10      POP HL
001B19 E837 C9              10      RET
                                
       E838                     CHGDRV0:
001B1A E838 6F               4      LD  L,A
001B1B E839 CDDCF0          17      CALL    _GETDPB
001B1E E83C D8              11      RET C
001B1F E83D DD22A8F0        20      LD  (_DPB),IX
001B23 E841 7D               4      LD  A,L
001B24 E842 3289F0          13      LD  (_DSK),A
       E845                     CHGDRV2:
001B27 E845 C5              11      PUSH    BC
001B28 E846 D5              11      PUSH    DE
001B29 E847 ED7390E8        20      LD  (SPPAT2),SP
001B2D E84B F3               4      DI
001B2E E84C DDF9            10      LD  SP,IX
                                
001B30 E84E E1              10      POP HL      ;00:DPB_FATLN
001B31 E84F E1              10      POP HL      ;02:DPB_DRD
001B32 E850 22BAE7          16      LD  (DRDPAT),HL
                                
001B35 E853 E1              10      POP HL
001B36 E854 22C8E7          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001B39 E857 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001B3A E858 7C               4      LD  A,H
001B3B E859 32BEDE          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001B3E E85C 3D               4      DEC A
001B3F E85D 3225E6          13      LD  (_NCPAT),A
                                
001B42 E860 E1              10      POP HL      ;08:DPB_MAXCL
001B43 E861 7D               4      LD  A,L
001B44 E862 32DDDE          13      LD  (CLPAT2),A
001B47 E865 7C               4      LD  A,H
001B48 E866 32D9DE          13      LD  (CLPAT1),A
001B4B E869 2B               6      DEC HL
001B4C E86A 22DCE0          16      LD  (MAXCLP),HL
                                
001B4F E86D E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001B50 E86E 4C               4      LD  C,H
                                
001B51 E86F E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001B52 E870 E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001B53 E871 7C               4      LD  A,H     ;DPB_BPS
001B54 E872 E607             7      AND 7
001B56 E874 3297E3          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001B59 E877 87               4      ADD A,A     ;8  4   2
001B5A E878 87               4      ADD A,A     ;010H   8   4
001B5B E879 87               4      ADD A,A     ;020H   010H    8
001B5C E87A 323CDD          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001B5F E87D 2600             7      LD  H,0
001B61 E87F 22FAF1          16      LD  (_FATPS),HL
                                
001B64 E882 E1              10      POP HL      ;10:DPB_DIRPS
001B65 E883 22FCF1          16      LD  (_DIRPS),HL
                                
001B68 E886 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001B69 E887 7C               4      LD  A,H
001B6A E888 3284F0          13      LD  (_DRIVE),A
                                
001B6D E88B E1              10      POP HL      ;14:DPB_ADDCL
001B6E E88C 22CEDE          16      LD  (CLSPAT),HL
                                
001B71 E88F 310000          10      LD  SP,0        ;元のSPを復元
       E890                     SPPAT2  EQU $-2
001B74 E892 FB               4      EI
001B75 E893 2AFCF1          16      LD  HL,(_DIRPS)
001B78 E896 0600             7      LD  B,0
001B7A E898 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001B7B E899 2257DD          16      LD  (MD_PAT),HL
                                
001B7E E89C 2ADCE0          16      LD  HL,(MAXCLP)
001B81 E89F 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001B84 E8A2 19              11      ADD HL,DE
001B85 E8A3 380F            12      JR  C,SETFAT16
001B87 E8A5 21ABE5          10      LD  HL,GNCL     ;FAT12
001B8A E8A8 11CEE5          10      LD  DE,SNCL
001B8D E8AB 010BE8          10      LD  BC,FATSETUP12
001B90 E8AE DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001B94 E8B2 180D            12      JR  EXTRA1
       E8B4                     SETFAT16:
001B96 E8B4 2102E6          10      LD  HL,GNCL16   ;FAT16
001B99 E8B7 110FE6          10      LD  DE,SNCL16
001B9C E8BA 0118E8          10      LD  BC,FATSETUP16
001B9F E8BD DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       E8C1                     EXTRA1:
001BA3 E8C1 22F8F0          16      LD  (GNCPAT),HL
001BA6 E8C4 ED53FBF0        20      LD  (SNCPAT),DE
001BAA E8C8 ED43DCE7        20      LD  (FATSX),BC
001BAE E8CC D1              10      POP DE
001BAF E8CD C1              10      POP BC
001BB0 E8CE AF               4      XOR A
001BB1 E8CF C9              10      RET
                                
       E8D0                     GETDPBD:
001BB2 E8D0 DDE3            23      EX  (SP),IX
001BB4 E8D2 DDE5            15      PUSH    IX
001BB6 E8D4 3A88F0          13      LD  A,(_DRV)
001BB9 E8D7 1807            12      JR  GETDPB1
                                
       E8D9                     CHGDRVR:
001BBB E8D9 CDD9F0          17      CALL    _CHGDRV
001BBE E8DC D8              11      RET C
001BBF E8DD 3A89F0          13      LD  A,(_DSK)
       E8E0                     GETDPB1:
001BC2 E8E0 C3DCF0          10      JP  _GETDPB
                                
       E8E3                     GETDPB:
001BC5 E8E3 FE08             7      CP  8
001BC7 E8E5 3F               4      CCF
001BC8 E8E6 D8              11      RET C
001BC9 E8E7 0F               4      RRCA
001BCA E8E8 0F               4      RRCA
001BCB E8E9 0F               4      RRCA
001BCC E8EA DD                      DB  0DDH        ;Z80未定義命令
001BCD E8EB 6F               4      LD  L,A     ;LD IXL,A
001BCE E8EC DD                      DB  0DDH        ;Z80未定義命令
001BCF E8ED 26F2             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001BD1 E8EF DD7E00          19      LD  A,(IX+DPB_FATLN)
001BD4 E8F2 A7               4      AND A       ;CF=0の為
001BD5 E8F3 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001BD9 E8F7 C0              11      RET NZ      ;FAT16
001BDA E8F8 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001BDE E8FC C0              11      RET NZ      ;BPB
001BDF E8FD FE01             7      CP  001H        ;A=0 THEN CF=1
001BE1 E8FF C9              10      RET
                                
       E900                     _SYS5F:
001BE2 E900 AF               4      XOR A
       E901                     FFLUSH:
001BE3 E901 F5              11      PUSH    AF
001BE4 E902 CD29E5          17      CALL    WTFATX
001BE7 E905 AF               4      XOR A
001BE8 E906 32ABF0          13      LD  (_FATIX),A
001BEB E909 2F               4      CPL         ;0FFH
001BEC E90A 32AAF0          13      LD  (_FATDRV),A
001BEF E90D 3E                      DB  03EH        ;次のPUSH AFをスキップ
       E90E                     FFLUSHBUF:
001BF0 E90E F5              11      PUSH    AF
001BF1 E90F CDDFE4          17      CALL    DWTX
001BF4 E912 3EFF             7      LD  A,0FFH
001BF6 E914 3239F0          13      LD  (SFILE),A
001BF9 E917 32A5F0          13      LD  (_DBDRV),A
001BFC E91A F1              10      POP AF
001BFD E91B C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MZ-700/1500
                                
       E91C                     SEEK:
001BFE E91C 0610             7      LD  B,16
001C00 E91E DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001C03 E921 AF               4      XOR A
001C04 E922 EB               4      EX  DE,HL
       E923                     DIV1:
001C05 E923 29              11      ADD HL,HL
001C06 E924 8F               4      ADC A,A
001C07 E925 B9               4      CP  C
001C08 E926 3802            12      JR  C,DIV2
001C0A E928 91               4      SUB C
001C0B E929 2C               4      INC L
       E92A                     DIV2:
001C0C E92A 10F7            13      DJNZ    DIV1
                                
001C0E E92C 3C               4      INC A   ;最小のセクタは１固定
001C0F E92D 55               4      LD  D,L ;TRACK
001C10 E92E 5F               4      LD  E,A ;SECTOR
                                
001C11 E92F 3A84F0          13      LD  A,(_DRIVE)
001C14 E932 FE04             7      CP  4
001C16 E934 3F               4      CCF
001C17 E935 D8              11      RET C
001C18 E936 F684             7      OR  084H        ;Motor on + ドライブセレクト有効
001C1A E938 D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001C1C E93A CB3A             8      SRL D       ;CYLINDER
001C1E E93C 9F               4      SBC A,A
001C1F E93D D3DD            11      OUT (0DDH),A    ;ヘッドセレクト制御レジスタ
                                
001C21 E93F CD77E9          17      CALL    SETMODE
001C24 E942 D8              11      RET C
                                
001C25 E943 CDACE9          17      CALL    DRIVE
001C28 E946 FEFF             7      CP  0FFH        ;A=0FFH Unknown CYLINDER
001C2A E948 CC8EE9          17      CALL    Z,FDCRES    ;Restore
001C2D E94B 2F               4      CPL         ;データバスが負論理
001C2E E94C D3D9            11      OUT (0D9H),A    ;MB8876 トラックレジスタ
001C30 E94E 2F               4      CPL         ;データバスが負論理
001C31 E94F 92               4      SUB D
001C32 E950 C8              11      RET Z       ;No seek
                                
001C33 E951 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)
001C36 E954 3D               4      DEC A
001C37 E955 BA               4      CP  D       ;Over CYLINDER
001C38 E956 D8              11      RET C
                                
001C39 E957 7A               4      LD  A,D
001C3A E958 2F               4      CPL         ;データバスが負論理
001C3B E959 D3DB            11      OUT (0DBH),A    ;MB8876 データレジスタ
001C3D E95B 72               7      LD  (HL),D
                                
001C3E E95C 0E18             7      LD  C,018H      ;FDC TypeIコマンド Seek
       E95E                     FDCCMD2:
001C40 E95E 3A85F0          13      LD  A,(_SEEKSP)
001C43 E961 B1               4      OR  C
                                
       E962                     FDCCMD:
001C44 E962 CDA3E9          17      CALL    COMSET
001C47 E965 3E80             7      LD  A,080H      ;FDC COMMAND(Self-modifying code)
       E966                     FDCSMC  EQU $-1
001C49 E967 E620             7      AND 020H        ;Write data Write track
001C4B E969 3C               4      INC A
                                
       E96A                     SST:
001C4C E96A 0E00             7      LD  C,0
       E96C                     SST1:
001C4E E96C 0D               4      DEC C       ; 4
001C4F E96D 20FD            12      JR  NZ,SST1     ;12 * 256 / 4 = About 1ms
001C51 E96F 3D               4      DEC A
001C52 E970 20FA            12      JR  NZ,SST1
                                
001C54 E972 0E01             7      LD  C,1
001C56 E974 CD7CE9          17      CALL    READY
       E977                     SETMODE:
001C59 E977 CDA6E9          17      CALL    DELAY0      ;Head select time
001C5C E97A 0E81             7      LD  C,081H
       E97C                     READY:
001C5E E97C 0680             7      LD  B,128
       E97E                     READY2:
001C60 E97E DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001C62 E980 2F               4      CPL         ;データバスが負論理
001C63 E981 A1               4      AND C       ;NOT READY,BUSY
001C64 E982 C8              11      RET Z
001C65 E983 CD4FCF          17      CALL    RD556VSYNC
001C68 E986 07               4      RLCA
001C69 E987 A8               4      XOR B
001C6A E988 0F               4      RRCA
001C6B E989 30F3            12      JR  NC,READY2
001C6D E98B 10F1            13      DJNZ    READY2
001C6F E98D C9              10      RET
                                
       E98E                     FDCRES:
001C70 E98E 3600            10      LD  (HL),0
001C72 E990 0E08             7      LD  C,8     ;FDC TypeIコマンド Restore
001C74 E992 18CA            12      JR  FDCCMD2
                                
       E994                     FDMOFF:
001C76 E994 F5              11      PUSH    AF
001C77 E995 AF               4      XOR A       ;Motor off(ドライブセレクト無効)
001C78 E996 D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001C7A E998 F1              10      POP AF
001C7B E999 C9              10      RET
                                
       E99A                     SECSET_FDCCMD:
001C7C E99A 3A66E9          13      LD  A,(FDCSMC)
       E99D                     SECSET:
001C7F E99D F5              11      PUSH    AF
001C80 E99E 7B               4      LD  A,E
001C81 E99F 2F               4      CPL         ;データバスが負論理
001C82 E9A0 D3DA            11      OUT (0DAH),A    ;MB8876 セクタレジスタ
001C84 E9A2 F1              10      POP AF
       E9A3                     COMSET:
001C85 E9A3 2F               4      CPL         ;データバスが負論理
001C86 E9A4 D3D8            11      OUT (0D8H),A    ;MB8876 ステータス/コマンドレジスタ
       E9A6                     DELAY0:
001C88 E9A6 3E1A             7      LD  A,26
       E9A8                     DELAY:
001C8A E9A8 3D               4      DEC A
001C8B E9A9 20FD            12      JR  NZ,DELAY
001C8D E9AB C9              10      RET
                                
       E9AC                     DRIVE:                  ;ドライブのシリンダを得る
001C8E E9AC 2A84F0          16      LD  HL,(_DRIVE)
001C91 E9AF 26F0             7      LD  H,_CYL0/256
001C93 E9B1 CBFD             8      SET 7,L
001C95 E9B3 7E               7      LD  A,(HL)
001C96 E9B4 C9              10      RET
                                
       E9B5                     RNF:                    ;ドライブのシリンダをリセット
001C97 E9B5 CDACE9          17      CALL    DRIVE
001C9A E9B8 36FF            10      LD  (HL),0FFH
001C9C E9BA C9              10      RET
                                
001C9D E9BB 02                  RETRY:  DB  2
                                
                                
                                ;   FLOPPY DISK DRIVER
                                
       E9BC                     WTTRK:
001C9E E9BC 0601             7      LD  B,1
001CA0 E9BE 3EF4             7      LD  A,0F4H      ;FDC TypeIIIコマンド Write Track
001CA2 E9C0 1802            12      JR  WTTRK1
       E9C2                     FDWT:
001CA4 E9C2 3EA0             7      LD  A,0A0H      ;FDC TypeIIコマンド Write Sector
       E9C4                     WTTRK1:
001CA6 E9C4 3266E9          13      LD  (FDCSMC),A
       E9C7                     DWTBL:
001CA9 E9C7 78               4      LD  A,B
001CAA E9C8 3204EA          13      LD  (WTBSMC),A
001CAD E9CB 3E02             7      LD  A,2     ;Retry count
001CAF E9CD 32BBE9          13      LD  (RETRY),A
                                
       E9D0                     DWT0:
001CB2 E9D0 D5              11      PUSH    DE
001CB3 E9D1 E5              11      PUSH    HL
001CB4 E9D2 CD1CE9          17      CALL    SEEK        ;Write disk
001CB7 E9D5 E1              10      POP HL
001CB8 E9D6 3837            12      JR  C,ERRDW
001CBA E9D8 F3               4      DI
001CBB E9D9 CD9AE9          17      CALL    SECSET_FDCCMD
001CBE E9DC 0EDB             7      LD  C,0DBH      ;MB8876 データレジスタ
       E9DE                     DWT1:
001CC0 E9DE 7E               7      LD  A,(HL)
001CC1 E9DF 2F               4      CPL         ;データバスが負論理
001CC2 E9E0 57               4      LD  D,A
                                
       E9E1                     DWT2:
001CC3 E9E1 DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001CC5 E9E3 2F               4      CPL         ;データバスが負論理
001CC6 E9E4 0F               4      RRCA
001CC7 E9E5 3008            12      JR  NC,DWT4
001CC9 E9E7 0F               4      RRCA
001CCA E9E8 30F7            12      JR  NC,DWT2
       E9EA                     DWT3:
001CCC E9EA ED51            12      OUT (C),D       ;MB8876 データレジスタ
001CCE E9EC 23               6      INC HL
001CCF E9ED 18EF            12      JR  DWT1
                                
       E9EF                     DWT4:
001CD1 E9EF 3D               4      DEC A
001CD2 E9F0 28F8            12      JR  Z,DWT3
001CD4 E9F2 3C               4      INC A
001CD5 E9F3 FB               4      EI
001CD6 E9F4 D1              10      POP DE
001CD7 E9F5 13               6      INC DE
001CD8 E9F6 CD94E9          17      CALL    FDMOFF
001CDB E9F9 2808            12      JR  Z,DISKOK_WT
001CDD E9FB CD63EA          17      CALL    DISKC
001CE0 E9FE 20D0            12      JR  NZ,DWT0
001CE2 EA00 B7               4      OR  A
001CE3 EA01 2005            12      JR  NZ,ERRW
                                
       EA03                     DISKOK_WT:
001CE5 EA03 0601             7      LD  B,1
       EA04                     WTBSMC  EQU $-1
001CE7 EA05 10C0            13      DJNZ    DWTBL
001CE9 EA07 C9              10      RET
                                
       EA08                     ERRW:
001CEA EA08 3EFF             7      LD  A,0FFH
       EA0A                     ERRZ:
001CEC EA0A BF               4      CP  A       ;ZF=1
001CED EA0B 37               4      SCF
001CEE EA0C C394E9          10      JP  FDMOFF
                                
       EA0F                     ERRDW:
001CF1 EA0F D1              10      POP DE
001CF2 EA10 CD74EA          17      CALL    DELP
001CF5 EA13 20BB            12      JR  NZ,DWT0
001CF7 EA15 B7               4      OR  A
001CF8 EA16 20F0            12      JR  NZ,ERRW
001CFA EA18 C9              10      RET
                                
       EA19                     FDRD:
001CFB EA19 3E80             7      LD  A,080H      ;FDC TypeIIコマンド Read Sector
001CFD EA1B 3266E9          13      LD  (FDCSMC),A
       EA1E                     DRDBL:
001D00 EA1E 78               4      LD  A,B
001D01 EA1F 3255EA          13      LD  (RDBSMC),A
001D04 EA22 3E02             7      LD  A,2     ;Retry count
001D06 EA24 32BBE9          13      LD  (RETRY),A
       EA27                     DRD0:
001D09 EA27 D5              11      PUSH    DE
001D0A EA28 E5              11      PUSH    HL
001D0B EA29 CD1CE9          17      CALL    SEEK        ;Read disk
001D0E EA2C E1              10      POP HL
001D0F EA2D 382A            12      JR  C,ERRDR
001D11 EA2F F3               4      DI
001D12 EA30 CD9AE9          17      CALL    SECSET_FDCCMD
       EA33                     DRD1:
001D15 EA33 DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001D17 EA35 2F               4      CPL         ;データバスが負論理
001D18 EA36 0F               4      RRCA
001D19 EA37 300A            12      JR  NC,DRD3
001D1B EA39 0F               4      RRCA
001D1C EA3A 30F7            12      JR  NC,DRD1
001D1E EA3C DBDB            11      IN  A,(0DBH)    ;MB8876 データレジスタ
001D20 EA3E 2F               4      CPL         ;データバスが負論理
001D21 EA3F 77               7      LD  (HL),A
001D22 EA40 23               6      INC HL
001D23 EA41 18F0            12      JR  DRD1
                                
       EA43                     DRD3:
001D25 EA43 B7               4      OR  A
001D26 EA44 FB               4      EI
001D27 EA45 D1              10      POP DE
001D28 EA46 13               6      INC DE
001D29 EA47 CD94E9          17      CALL    FDMOFF
001D2C EA4A 2808            12      JR  Z,DISKOK_RD
001D2E EA4C CD63EA          17      CALL    DISKC
001D31 EA4F 20D6            12      JR  NZ,DRD0
001D33 EA51 B7               4      OR  A
001D34 EA52 20B4            12      JR  NZ,ERRW
                                
       EA54                     DISKOK_RD:
001D36 EA54 0601             7      LD  B,1
       EA55                     RDBSMC  EQU $-1
001D38 EA56 10C6            13      DJNZ    DRDBL
001D3A EA58 C9              10      RET
                                
       EA59                     ERRDR:
001D3B EA59 D1              10      POP DE
001D3C EA5A CD74EA          17      CALL    DELP
001D3F EA5D 20C8            12      JR  NZ,DRD0
001D41 EA5F B7               4      OR  A
001D42 EA60 20A6            12      JR  NZ,ERRW
001D44 EA62 C9              10      RET
       EA63                     DISKC:
001D45 EA63 1B               6      DEC DE
001D46 EA64 CB5F             8      BIT 3,A
001D48 EA66 C4B5E9          17      CALL    NZ,RNF
       EA69                     DISKD:
001D4B EA69 E5              11      PUSH    HL
001D4C EA6A 21BBE9          10      LD  HL,RETRY
001D4F EA6D 35              11      DEC (HL)
001D50 EA6E E1              10      POP HL
001D51 EA6F 200C            12      JR  NZ,ERR      ;Retry
001D53 EA71 B7               4      OR  A
001D54 EA72 2809            12      JR  Z,ERR       ;Error
                                
       EA74                     DELP:
001D56 EA74 CDB5E9          17      CALL    RNF
001D59 EA77 CD94E9          17      CALL    FDMOFF
001D5C EA7A 3EFF             7      LD  A,0FFH
       EA7C                     AERRZ:
001D5E EA7C BF               4      CP  A
       EA7D                     ERR:
001D5F EA7D 3EFF             7      LD  A,0FFH
001D61 EA7F C9              10      RET
[EOF:M7DISK.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MZ-700/1500
                                
                                ;   EMM DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       EA80                     EDWT:
001D62 EA80 F5              11      PUSH    AF
001D63 EA81 CD9FEA          17      CALL    EADR
001D66 EA84 0600             7      LD  B,0
       EA86                     EDWT1:
001D68 EA86 EDB3                    OTIR
001D6A EA88 3D               4      DEC A
001D6B EA89 20FB            12      JR  NZ,EDWT1
001D6D EA8B 180B            12      JR  EDRW1
                                
       EA8D                     EDRD:
001D6F EA8D C5              11      PUSH    BC
001D70 EA8E CD9FEA          17      CALL    EADR
001D73 EA91 0600             7      LD  B,0
       EA93                     EDRD1:
001D75 EA93 EDB2                    INIR
001D77 EA95 3D               4      DEC A
001D78 EA96 20FB            12      JR  NZ,EDRD1
       EA98                     EDRW1:
001D7A EA98 F1              10      POP AF
001D7B EA99 83               4      ADD A,E ;セクタを進める
001D7C EA9A 5F               4      LD  E,A
001D7D EA9B 8A               4      ADC A,D
001D7E EA9C 93               4      SUB E
001D7F EA9D 57               4      LD  D,A
001D80 EA9E C9              10      RET
                                
       EA9F                     EADR:
001D81 EA9F D5              11      PUSH    DE
001D82 EAA0 EB               4      EX  DE,HL
001D83 EAA1 78               4      LD  A,B
001D84 EAA2 DD460F          19      LD  B,(IX+DPB_BPS)
       EAA5                     EADR1:              ;読み込むセクタ数と1クラスタのセクタ数を掛ける
001D87 EAA5 CB18             8      RR  B
001D89 EAA7 3804            12      JR  C,EADR2
001D8B EAA9 87               4      ADD A,A
001D8C EAAA 29              11      ADD HL,HL
001D8D EAAB 18F8            12      JR  EADR1
       EAAD                     EADR2:
001D8F EAAD DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001D92 EAB0 DD460C          19      LD  B,(IX+DPB_MAXCYL)
001D95 EAB3 09              11      ADD HL,BC
001D96 EAB4 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D99 EAB7 ED71            12      OUT (C),0       ;Z80未定義命令
001D9B EAB9 0C               4      INC C
001D9C EABA ED69            12      OUT (C),L
001D9E EABC 0C               4      INC C
001D9F EABD ED61            12      OUT (C),H
001DA1 EABF 0C               4      INC C
001DA2 EAC0 EB               4      EX  DE,HL
001DA3 EAC1 D1              10      POP DE
001DA4 EAC2 C9              10      RET
                                
                                ;   CMOS BACKUP MEMORY DRIVER(32KB)
                                ;   1セクタ256
                                
       EAC3                     CDWT:
001DA5 EAC3 78               4      LD  A,B
001DA6 EAC4 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001DA9 EAC7 ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001DAB EAC9 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001DAD EACB 01FA00          10      LD  BC,000FAH
       EACE                     CDWT1:
001DB0 EACE EDB3                    OTIR            ;W)データ書き込み・アドレスカウンタ+1
001DB2 EAD0 13               6      INC DE
001DB3 EAD1 3D               4      DEC A
001DB4 EAD2 20FA            12      JR  NZ,CDWT1
001DB6 EAD4 A7               4      AND A
001DB7 EAD5 C9              10      RET
                                
       EAD6                     CDRD:
001DB8 EAD6 78               4      LD  A,B
001DB9 EAD7 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001DBC EADA ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001DBE EADC ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001DC0 EADE 01F900          10      LD  BC,000F9H
       EAE1                     CDRD1:
001DC3 EAE1 EDB2                    INIR            ;R)データ読み出し・アドレスカウンタ+1
001DC5 EAE3 13               6      INC DE
001DC6 EAE4 3D               4      DEC A
001DC7 EAE5 20FA            12      JR  NZ,CDRD1
001DC9 EAE7 A7               4      AND A
001DCA EAE8 C9              10      RET
                                
                                ;   RAM DISK DRIVER (64KB)
                                ;   1セクタ256
                                
       EAE9                     RDWT:
001DCB EAE9 3EB3             7      LD  A,0B3H      ;OTIR
001DCD EAEB 1802            12      JR  RDRW
       EAED                     RDRD:
001DCF EAED 3EB2             7      LD  A,0B2H      ;INIR
       EAEF                     RDRW:
001DD1 EAEF 32FCEA          13      LD  (RDRW_SWC),A
                                
001DD4 EAF2 78               4      LD  A,B
001DD5 EAF3 43               4      LD  B,E     ;B=アドレスカウンタ上位(X1の様な16bitのI/Oアクセス)
001DD6 EAF4 0EEB             7      LD  C,0EBH
001DD8 EAF6 ED71            12      OUT (C),0       ;0=アドレスカウンタ下位
001DDA EAF8 0D               4      DEC C       ;EA(R)データ読み出し・アドレスカウンタ+1
001DDB EAF9 0600             7      LD  B,0
       EAFB                     RDRW1:
001DDD EAFB EDB2                    INIR            ;自己書き換え(INIR/OTIR)
       EAFC                     RDRW_SWC    EQU $-1
001DDF EAFD 13               6      INC DE
001DE0 EAFE 3D               4      DEC A
001DE1 EAFF 20FA            12      JR  NZ,RDRW1
001DE3 EB01 A7               4      AND A
001DE4 EB02 C9              10      RET
                                
                                ;   G-RAM(PCG) DISK DRIVER (24KB)
                                ;   1セクタ256
                                
       EB03                     GDWT:
001DE5 EB03 C5              11      PUSH    BC
001DE6 EB04 D5              11      PUSH    DE
001DE7 EB05 CD2DEB          17      CALL    GADR
       EB08                     GDWT2:
001DEA EB08 4E               7      LD  C,(HL)
001DEB EB09 23               6      INC HL
001DEC EB0A EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001DED EB0B CDF5CF          17      CALL    WR_PCG
001DF0 EB0E 23               6      INC HL
001DF1 EB0F EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001DF2 EB10 10F6            13      DJNZ    GDWT2
001DF4 EB12 D1              10      POP DE
001DF5 EB13 1C               4      INC E
001DF6 EB14 C1              10      POP BC
001DF7 EB15 10EC            13      DJNZ    GDWT
001DF9 EB17 C9              10      RET
       EB18                     GDRD:
001DFA EB18 C5              11      PUSH    BC
001DFB EB19 D5              11      PUSH    DE
001DFC EB1A CD2DEB          17      CALL    GADR
       EB1D                     GDRD2:
001DFF EB1D EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001E00 EB1E CDEDCF          17      CALL    RD_PCG
001E03 EB21 23               6      INC HL
001E04 EB22 EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001E05 EB23 71               7      LD  (HL),C
001E06 EB24 23               6      INC HL
001E07 EB25 10F6            13      DJNZ    GDRD2
001E09 EB27 D1              10      POP DE
001E0A EB28 1C               4      INC E
001E0B EB29 C1              10      POP BC
001E0C EB2A 10EC            13      DJNZ    GDRD
001E0E EB2C C9              10      RET
                                
       EB2D                     GADR:
001E0F EB2D 7B               4      LD  A,E
001E10 EB2E E61F             7      AND 01FH
001E12 EB30 C6D0             7      ADD A,0D0H
001E14 EB32 57               4      LD  D,A
001E15 EB33 7B               4      LD  A,E
001E16 EB34 07               4      RLCA
001E17 EB35 07               4      RLCA
001E18 EB36 07               4      RLCA
001E19 EB37 3C               4      INC A
001E1A EB38 0600             7      LD  B,0
001E1C EB3A 58               4      LD  E,B
001E1D EB3B C9              10      RET
[EOF:M7DISK2.ASM:UTF_8]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001E1E EB3C                     PATHD:  DS  PATHX
001E59 EB77 00                  PATHE:  DB  0
                                
       EB78                     DTA_CCP:
001E5A EB78                         DS  37
                                
       EB9D                     FCB_BAT:
001E7F EB9D                         DS  37
                                
001EA4 EBC2 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001EAF EBCD 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "M7TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE 表示関連のテーブル
                                ;   MZ-700/1500
                                
       EBD4                     AT_TABLE:
001EB6 EBD4                         DS  TABLEAD-AT_TABLE
                                
       ED40                     KEY_TABLE:
002022 ED40 12081E1F1C1D5C2F        DB  12H,08H,1EH,1FH,1CH,1DH,5CH,'/'
00202A ED48 5C5E2D2030392C2E        DB  5CH,'^','-',20H,'0','9',',','.'
002032 ED50 3132333435363738        DB  '1','2','3','4','5','6','7','8'
00203A ED58 6162636465666768        DB  'a','b','c','d','e','f','g','h'
002042 ED60 696A6B6C6D6E6F70        DB  'i','j','k','l','m','n','o','p'
00204A ED68 7172737475767778        DB  'q','r','s','t','u','v','w','x'
002052 ED70 797A405B5D000000        DB  'y','z','@','[',']',00H,00H,00H
00205A ED78 001B3D09003B3A0D        DB  00H,1BH,'=',09H,00H,';',':',0DH
       ED80                     SHIFT_TABLE:
002062 ED80 12081E1F1C1D5F3F        DB  12H,08H,1EH,1FH,1CH,1DH,'_','?'
00206A ED88 7C7E3D2030293C3E        DB  '|','~','=',20H,'0',')','<','>'
002072 ED90 2122232425262728        DB  '!','"','#','$','%','&',27H,'('
00207A ED98 4142434445464748        DB  'A','B','C','D','E','F','G','H'
002082 EDA0 494A4B4C4D4E4F50        DB  'I','J','K','L','M','N','O','P'
00208A EDA8 5152535455565758        DB  'Q','R','S','T','U','V','W','X'
002092 EDB0 595A607B7D000000        DB  'Y','Z','`','{','}',00H,00H,00H
00209A EDB8 00003D09002B2A0D        DB  00H,00H,'=',09H,00H,'+','*',0DH
       EDC0                     CTRL_TABLE:
0020A2 EDC0 12081E1F1C1D3F2F        DB  12H,08H,1EH,1FH,1CH,1DH,'?','/'
0020AA EDC8 2A2B2D2030392C2E        DB  '*','+','-',20H,'0','9',',','.'
0020B2 EDD0 3132333435363738        DB  '1','2','3','4','5','6','7','8'
0020BA EDD8 0102030405060708        DB  01H,02H,03H,04H,05H,06H,07H,08H
0020C2 EDE0 090A0B0C0D0E0F10        DB  09H,0AH,0BH,0CH,0DH,0EH,0FH,10H
0020CA EDE8 1112131415161718        DB  11H,12H,13H,14H,15H,16H,17H,18H
0020D2 EDF0 191A1B5B5D000000        DB  19H,1AH,1BH,'[',']',00H,00H,00H
0020DA EDF8 00003D09003B3A0D        DB  00H,00H,'=',09H,00H,';',':',0DH
                                
                                ;   アドレス下位1バイトが0になるように
       EE00                     CD_TABLE:
0020E2 EE00 00D1D2D3D4D5D6D0        DB  $00,$D1,$D2,$D3,$D4,$D5,$D6,$D0 ;月火水木金土日
0020EA EE08 D8DCD9DADBD7CFCE        DB  $D8,$DC,$D9,$DA,$DB,$D7,$CF,$CE ;年円時分秒
0020F2 EE10 601F5F5E1E1B7978        DB  $60,$1F,$5F,$5E,$1E,$1B,$79,$78 ;
0020FA EE18 5C5D1C1D6DCACDC7        DB  $5C,$5D,$1C,$1D,$6D,$CA,$CD,$C7 ;
002102 EE20 0061626364656667        DB  $00,$61,$62,$63,$64,$65,$66,$67 ; !"#$%&'
00210A EE28 68696B6A2F2A2E2D        DB  $68,$69,$6B,$6A,$2F,$2A,$2E,$2D ;()*+,-./
002112 EE30 2021222324252627        DB  $20,$21,$22,$23,$24,$25,$26,$27 ;01234567
00211A EE38 28294F2C512B5749        DB  $28,$29,$4F,$2C,$51,$2B,$57,$49 ;89:;<=>?
002122 EE40 5501020304050607        DB  $55,$01,$02,$03,$04,$05,$06,$07 ;@ABCDEFG
00212A EE48 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;HIJKLMNO
002132 EE50 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;PQRSTUVW
00213A EE58 18191A52DD54E37C        DB  $18,$19,$1A,$52,$DD,$54,$E3,$7C ;XYZ[\]^_
002142 EE60 5901020304050607        DB  $59,$01,$02,$03,$04,$05,$06,$07 ;`abcdefg   ATB:1
00214A EE68 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;hijklmno   ATB:1
002152 EE70 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;pqrstuvw   ATB:1
00215A EE78 18191ACB35CC705A        DB  $18,$19,$1A,$CB,$35,$CC,$70,$5A ;xyz{|}~    ATB:1
002162 EE80 415346444847B49E        DB  $41,$53,$46,$44,$48,$47,$B4,$9E ;トランプ〇●をぁ   ATB:1
00216A EE88 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ぃぅぇぉゃゅょっ   ATB:1
002172 EE90 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーあいうえおかき   ATB:1
00217A EE98 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;くけこさしすせそ   ATB:1
002182 EEA0 F0BD9DB1B5B9B49E        DB  $F0,$BD,$9D,$B1,$B5,$B9,$B4,$9E ;　。「」、・ヲァ
00218A EEA8 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ィゥェォャョュッ
002192 EEB0 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーアイウエオカキ
00219A EEB8 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;クケコサシスセソ
0021A2 EEC0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;タチツテトナニヌ
0021AA EEC8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ネノハヒフヘホマ
0021B2 EED0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;ミムメモヤユヨラ
0021BA EED8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;リルレロワン゛゜
0021C2 EEE0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;たちつてとねにぬ   ATB:1
0021CA EEE8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ねのはひふへほま   ATB:1
0021D2 EEF0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;みむめもやゆよら   ATB:1
0021DA EEF8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;りるれろわん゛゜   ATB:1
       EF00                     DC_TABLE:
0021E2 EF00 2041424344454647        DB  $20,$41,$42,$43,$44,$45,$46,$47 ;0
0021EA EF08 48494A4B4C4D4E4F        DB  $48,$49,$4A,$4B,$4C,$4D,$4E,$4F
0021F2 EF10 5051525354555657        DB  $50,$51,$52,$53,$54,$55,$56,$57 ;1
0021FA EF18 58595A151A1B1411        DB  $58,$59,$5A,$15,$1A,$1B,$14,$11
002202 EF20 3031323334353637        DB  $30,$31,$32,$33,$34,$35,$36,$37 ;2
00220A EF28 38392D3D3B2F2E2C        DB  $38,$39,$2D,$3D,$3B,$2F,$2E,$2C
002212 EF30 00000000007C0000        DB  $00,$00,$00,$00,$00,$7C,$00,$00 ;3
00221A EF38 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
002222 EF40 0080000083008285        DB  $00,$80,$00,$00,$83,$00,$82,$85 ;4
00222A EF48 843F00000000003A        DB  $84,$3F,$00,$00,$00,$00,$00,$3A
002232 EF50 5E3C5B815D40003E        DB  $5E,$3C,$5B,$81,$5D,$40,$00,$3E ;5
00223A EF58 00607F0018191312        DB  $00,$60,$7F,$00,$18,$19,$13,$12
002242 EF60 1021222324252627        DB  $10,$21,$22,$23,$24,$25,$26,$27 ;6
00224A EF68 28292B2A001C0000        DB  $28,$29,$2B,$2A,$00,$1C,$00,$00
002252 EF70 7E00000000000000        DB  $7E,$00,$00,$00,$00,$00,$00,$00 ;7
00225A EF78 171600005F000000        DB  $17,$16,$00,$00,$5F,$00,$00,$00
002262 EF80 00C19A9F9C92CA97        DB  $00,$C1,$9A,$9F,$9C,$92,$CA,$97 ;8
00226A EF88 98C6CFC9D8D3D0D7        DB  $98,$C6,$CF,$C9,$D8,$D3,$D0,$D7
002272 EF90 9EC09DC496C5CBC3        DB  $9E,$C0,$9D,$C4,$96,$C5,$CB,$C3 ;9
00227A EF98 9BDDC2DB99A2878C        DB  $9B,$DD,$C2,$DB,$99,$A2,$87,$8C
002282 EFA0 DCC7CC91939495D4        DB  $DC,$C7,$CC,$91,$93,$94,$95,$D4 ;A
00228A EFA8 D5D6CECDDAD2D9C8        DB  $D5,$D6,$CE,$CD,$DA,$D2,$D9,$C8
002292 EFB0 D1A3888D86A4898E        DB  $D1,$A3,$88,$8D,$86,$A4,$89,$8E ;B
00229A EFB8 DFA58A8FDEA18B90        DB  $DF,$A5,$8A,$8F,$DE,$A1,$8B,$90
0022A2 EFC0 000000000000001F        DB  $00,$00,$00,$00,$00,$00,$00,$1F ;C
0022AA EFC8 00001D7B7D1E0F0E        DB  $00,$00,$1D,$7B,$7D,$1E,$0F,$0E
0022B2 EFD0 070102030405060D        DB  $07,$01,$02,$03,$04,$05,$06,$0D ;D
0022BA EFD8 080A0B0C095C0000        DB  $08,$0A,$0B,$0C,$09,$5C,$00,$00
0022C2 EFE0 0000005E00000000        DB  $00,$00,$00,$5E,$00,$00,$00,$00 ;E
0022CA EFE8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
0022D2 EFF0 A000000000000000        DB  $A0,$00,$00,$00,$00,$00,$00,$00 ;F
0022DA EFF8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
[EOF:M7TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
                                ;   ALIGN   256
       F000                     AT_WORK:
0022E2 F000                         DS  WORKAD-AT_WORK
                                
       F000                     CPM_BOOT:
0022E2 F000 C30000          10      JP  0
       F003                     _SYS00:     ;(BDOS)プログラム終了
       F003                     CPM_WBOOT:
0022E5 F003 C3FECF          10      JP  WBOOT1
       F006                     CPM_CONST:
0022E8 F006 C309D8          10      JP  CONSTX
       F009                     _SYS07:     ;(BDOS)コンソール直接入力
       F009                     CPM_CONIN:
0022EB F009 C3A2D7          10      JP  FLGET
       F00C                     CPM_CONOUT:
0022EE F00C C3ADD9          10      JP  CONOUT1
                                
       F00F                     DECBF:              ;10進数表示時のバッファ(5バイト)
0022F1 F00F                         DS  5
       F00F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       F011                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       F014                     FDRV:
0022F6 F014 00                      DB  0
       F015                     FNAME:
0022F7 F015                         DS  36
       F039                     SFILE:
00231B F039                         DS  33      ;DRV FILENAME
       F05A                     _DISKE:
00233C F05A C30CD7          10      JP  SHOW_ERROR
                                
00233F F05D 0000                LEFTX:  DW  0
002341 F05F 0000                DTAX:   DW  0
                                
                                ;   PSGのビープ音のデータ(X1)
       F061                     BEEPD:
002343 F061 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
00234B F069 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                ;
       F062                     RTC_YY  EQU BEEPD+1 ;RTCのバッファ年(88)
       F063                     RTC_MW  EQU BEEPD+2 ;RTCのバッファ月(88)
       F064                     RTC_DD  EQU BEEPD+3 ;RTCのバッファ日(88)
       F065                     RTC_TT  EQU BEEPD+4 ;RTCのバッファ時(88)
       F066                     RTC_MM  EQU BEEPD+5 ;RTCのバッファ分(88)
       F067                     RTC_SS  EQU BEEPD+6 ;RTCのバッファ秒(88)
       F062                     ROM_SLT EQU BEEPD+1 ;ROMのスロット(MSX)
       F061                     ZERO    EQU BEEPD
                                
       F070                     CHECK:
002352 F070 00                      DB  0
                                
       F071                     OK:
002353 F071 4F4B24                  DB  "OK$"
002356 F074                         DS  5
       F079                     COMERM:
00235B F079 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       F080                     _CYL0:
002362 F080 FF                      DB  0FFH    ;Cylinder
       F081                     _CYL1:
002363 F081 FF                      DB  0FFH    ;Cylinder
       F082                     _CYL2:
002364 F082 FF                      DB  0FFH    ;Cylinder
       F083                     _CYL3:
002365 F083 FF                      DB  0FFH    ;Cylinder
       F084                     _DRIVE:
002366 F084 00                      DB  0   ;unit number
       F085                     _SEEKSP:
002367 F085 00                      DB  0   ;Seek speed
       F086                     _ISEEK:
002368 F086 32                      DB  50  ;
002369 F087                         DS  1
       F088                     _DRV:
00236A F088 00                      DB  0
       F089                     _DSK:
00236B F089 FF                      DB  0FFH
       F08A                     _DTA:
00236C F08A 8000                    DW  00080H
       F08C                     _CTC:
00236E F08C 0000                    DW  0
       F08E                     _TXADR:
002370 F08E 0000                    DW  0
       F090                     _KEYPS:
002372 F090 0000                    DW  0
       F092                     _KEYD:
002374 F092 00                      DB  000H    ;キーデータ
       F093                     _KEYST:
002375 F093 FF                      DB  0FFH    ;キーステータス(SHIFT,CTRLの状態)
       F094                     _KEYSP_L:
002376 F094 83                      DB  KEYSP_L ;オートリピートの速度
       F095                     _KEYSP_H:
002377 F095 14                      DB  KEYSP_H ;オートリピートの速度
       F096                     _COLORF:
002378 F096 70                      DB  COLORF  ;色
       F097                     _LINE:
002379 F097 19                      DB  LINE
                                
                                            ;次のファイルの検索(C=12)で使用するFCB
       F098                     _FCB:
00237A F098 0000                    DW  0   ;SEARCH FILES
       F09A                     _FBPS:
00237C F09A 0000                    DW  0   ;    //
       F09C                     _FBAD:
00237E F09C 0000                    DW  0   ;    //
       F09E                     _FBCNT:
002380 F09E 00                      DB  0   ;    //
       F09F                     _FILEN:
002381 F09F 00                      DB  0   ;    //
       F0A0                     _DIRF:
002382 F0A0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
002383 F0A1                         DS  1
       F0A2                     _WTFATF:
002384 F0A2 00                      DB  0   ;FATバッファの更新フラグ
002385 F0A3                         DS  1
       F0A4                     _WTDBF:
002386 F0A4 00                      DB  0   ;データバッファの更新フラグ
       F0A5                     _DBDRV:
002387 F0A5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       F0A6                     _DBSEC:
002388 F0A6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       F0A8                     _DPB:
00238A F0A8 0000                    DW  0
       F0AA                     _FATDRV:
00238C F0AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       F0AB                     _FATIX:
00238D F0AB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       F0AC                     _FAKEFREE:
00238E F0AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
002390 F0AE                         DS  2
                                ;   画面周りのデータ
       F0B0                     CRTCD:
002392 F0B0 6F                      DB  06FH
       F0B1                     _WIDTH:
002393 F0B1 28                      DB  WIDTH
       F0B2                     TVRAMTOP:
002394 F0B2 5938                    DB  059H,038H
002396 F0B4 1F02                    DB  01FH,002H
       F0B6                     _LINE2:
002398 F0B6 19                      DB  019H
       F0B7                     WKE4:
002399 F0B7 1C                      DB  01CH
       F0B8                     WKE6:
00239A F0B8 00                      DB  000H
       F0B9                     WK40:
00239B F0B9 07                      DB  007H
       F0BA                     _PAGE_MINUS:
00239C F0BA 18FC                    DW  0-WIDTH*LINE
       F0BC                     _WIDTH_MINUS:
00239E F0BC D8FF                    DW  0-WIDTH
       F0BE                     WK30:
0023A0 F0BE 0C                      DB  00CH
       F0BF                     WK31:
       F0BF                     WK1FD0:
0023A1 F0BF 20                      DB  020H
                                
                                ;   割り込みベクタ(X1)
0023A2 F0C0 0000                CTC0:   DW  INTCTCE
0023A4 F0C2 0000                CTC1:   DW  INTCTCE
0023A6 F0C4 0000                CTC2:   DW  INTCTCE
0023A8 F0C6 0000                CTC3:   DW  INTCTCE
0023AA F0C8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
0023AC F0CA C311DB          10  _INKEY: JP  INKEY
0023AF F0CD C394D8          10  _PRINT: JP  PRINT
0023B2 F0D0 C379DB          10  _SCRN:  JP  SCRN
0023B5 F0D3 C366DA          10  _POS:   JP  POS
0023B8 F0D6 C37BD9          10  _LOC:   JP  LOC
       F0D9                     _CHGDRV:
0023BB F0D9 C325E8          10      JP  CHGDRV
       F0DC                     _GETDPB:
0023BE F0DC C3E3E8          10      JP  GETDPB
       F0DF                     _FFLUSH:
0023C1 F0DF C301E9          10      JP  FFLUSH
       F0E2                     _RDFATX:
0023C4 F0E2 C3FFE4          10      JP  RDFATX
0023C7 F0E5 C331E6          10  _RDFAT: JP  RDFAT
0023CA F0E8 C3BCE9          10  _WTTRK: JP  WTTRK
0023CD F0EB C319EA          10  _FDRD:  JP  FDRD
0023D0 F0EE C3C2E9          10  _FDWT:  JP  FDWT
       F0F1                     _BPB2DPB:
0023D3 F0F1 C3C7E6          10      JP  BPB2DPB
       F0F4                     _BREAK:
0023D6 F0F4 C390D1          10      JP  END_BATCH
       F0F7                     _GNCL:
0023D9 F0F7 C3ABE5          10      JP  GNCL        ; self-modifying code
       F0F8                     GNCPAT  EQU $-2
       F0FA                     _SNCL:
0023DC F0FA C3CEE5          10      JP  SNCL        ; self-modifying code
       F0FB                     SNCPAT  EQU $-2
       F0FD                     _COMANL:
0023DF F0FD C349D0          10      JP  COMANL
                                
       F100                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F100                     STABLE:
                                ;0
0023E2 F100 03F075D781D769DD        DW  _SYS00,_SYS01,_SYS02,_SYS03
0023EA F108 77D477D486D709F0        DW  _SYS04,_SYS05,_SYS06,_SYS07
0023F2 F110 8ED779D4D8D704D8        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
0023FA F118 8ED493D4A2D4B3D4        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
002402 F120 07D54ED597D5C8D5        DW  _SYS10,_SYS11,_SYS12,_SYS13
00240A F128 D0D5E6D5FBD5F3D5        DW  _SYS14,_SYS15,_SYS16,_SYS17
002412 F130 42D647D64CD652D6        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
00241A F138 77D478D677D47CD6        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
002422 F140 77D432D63AD683D6        DW  _SYS20,_SYS21,_SYS22,_SYS23
00242A F148 A8D677D4BFE18DE2        DW  _SYS24,_ERROR,_SYS26,_SYS27
002432 F150 3AD6B2D617D869DD        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
00243A F158 17D869DD77D4D3D6        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
002442 F160 CDD677D477D477D4        DW  _SYS30,_ERROR,_ERROR,_ERROR
00244A F168 77D477D477D477D4        DW  _ERROR,_ERROR,_ERROR,_ERROR
002452 F170 77D469DD69DDF4D6        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
00245A F178 5AD4                    DW  _DOS2
                                
00245C F17A                         DS  1
       F17B                     _MAX_SEC_SZ_H:
00245D F17B 04                      DB  MAX_SEC_SZ_H
                                
                                ;   FATバッファのアドレス
       F17C                     _FATBF:
00245E F17C 30F3                    DW  FATBF
                                
                                ;   データバッファのアドレス
       F17E                     _DTBUF:
002460 F17E 30FB                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F180                     CTRLTB:
002462 F180 F9D8F9D82FD939DA        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
00246A F188 33DA60D924DABDD9        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002472 F190 05D920D93CDA8ED9        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
00247A F198 21DA76D94EDAF9D8        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
002482 F1A0 F9D8F9D886D9F9D8        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
00248A F1A8 F9D8F9D8F9D8F9D8        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
002492 F1B0 F9D8F9D821DA95D9        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
00249A F1B8 E8D80CD915D93CDA        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
                                ;   2D/2DDでBPBがない場合のデフォルト値(2D/360KB/9セクタ1024バイト)
0024A2 F1C0 0200                M2D:    DW  2
0024A4 F1C2 FD02                    DB  0FDH,2
0024A6 F1C4 6401                    DW  356
0024A8 F1C6 FF0728090182            DB  0FFH,7,40,9,1,082H
0024AE F1CC 0500A7000800            DW  5,0A7H,8
                                
                                ;   2HDでBPBがない場合のデフォルト値(2HD/1.23MB/8セクタ1024バイト)
0024B4 F1D2 0200                M2HD:   DW  2
0024B6 F1D4 FE01                    DB  0FEH,1
0024B8 F1D6 C704                    DW  1223
0024BA F1D8 FE064D080184            DB  0FEH,6,77,8,1,084H
0024C0 F1DE 0500A7000900            DW  5,0A7H,9
                                
                                ;   ディレクトリエントリとFCBの変換テーブル(日付+時刻+サイズ)
0024C6 F1E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
0024C8 F1E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
0024CA F1E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
0024CC F1EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F1EE                     SDDATAE:
                                
0024D0 F1EE                         DS  2
                                
                                ;   バッチファイルのFCB
       F1F0                     _FCB_BAT:
0024D2 F1F0 9DEB                    DW  FCB_BAT
       F1F2                     _PATH:
0024D4 F1F2 3CEB                    DW  PATHD
                                
0024D6 F1F4                     SCDIR:  DS  2       ;+14 +15
0024D8 F1F6                     SFBPS:  DS  2       ;FBPS
0024DA F1F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
0024DC F1FA 0000                _FATPS: DW  0
0024DE F1FC 0000                _DIRPS: DW  0
0024E0 F1FE 0000                _CLPS:  DW  0
                                
       F200                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "M7DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MZ-700/1500
                                
       F200                     _DEVICE:
                                
                                ;   A:
                                
0024E2 F200 0200                    DW  2   ;DPB_FATLN
0024E4 F202 EBF0                    DW  _FDRD   ;DPB_DRD
0024E6 F204 EEF0                    DW  _FDWT   ;DPB_DWT
0024E8 F206 FD                      DB  0FDH    ;DPB_FATID
0024E9 F207 02                      DB  2   ;DPB_SECPCL
0024EA F208 6401                    DW  356 ;DPB_MAXCL
0024EC F20A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
0024ED F20B 07                      DB  7   ;DPB_DIRSCNT
0024EE F20C 28                      DB  40  ;DPB_MAXCYL
0024EF F20D 09                      DB  9   ;DPB_MAXSEC Number of sectors
0024F0 F20E 01                      DB  1   ;DPB_FATPS
0024F1 F20F 82                      DB  082H    ;DPB_BPS
0024F2 F210 0500                    DW  5   ;DPB_DIRPS
0024F4 F212 27                      DB  027H    ;DPB_DEVICE Device Number
0024F5 F213 00                      DB  0   ;DPB_UNITNO
0024F6 F214 0800                    DW  8   ;DPB_ADDCL
0024F8 F216 0000                    DW  0   ;DPB_16
0024FA F218 0000                    DW  0   ;DPB_18
0024FC F21A 0000                    DW  0   ;DPB_SDIR
0024FE F21C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002502 F220 0200                    DW  2   ;DPB_FATLN
002504 F222 EBF0                    DW  _FDRD   ;DPB_DRD
002506 F224 EEF0                    DW  _FDWT   ;DPB_DWT
002508 F226 FD                      DB  0FDH    ;DPB_FATID
002509 F227 02                      DB  2   ;DPB_SECPCL
00250A F228 6401                    DW  356 ;DPB_MAXCL
00250C F22A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
00250D F22B 07                      DB  7   ;DPB_DIRSCNT
00250E F22C 28                      DB  40  ;DPB_MAXCYL
00250F F22D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002510 F22E 01                      DB  1   ;DPB_FATPS
002511 F22F 82                      DB  082H    ;DPB_BPS
002512 F230 0500                    DW  5   ;DPB_DIRPS
002514 F232 27                      DB  027H    ;DPB_DEVICE Device Number
002515 F233 01                      DB  1   ;DPB_UNITNO
002516 F234 0800                    DW  8   ;DPB_ADDCL
002518 F236 0000                    DW  0   ;DPB_16
00251A F238 0000                    DW  0   ;DPB_18
00251C F23A 0000                    DW  0   ;DPB_SDIR
00251E F23C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002522 F240 0100                    DW  1   ;DPB_FATLN
002524 F242 D6EA                    DW  CDRD    ;DPB_DRD
002526 F244 C3EA                    DW  CDWT    ;DPB_DWT
002528 F246 FA                      DB  0FAH    ;DPB_FATID
002529 F247 01                      DB  1   ;DPB_SECPCL
00252A F248 7A00                    DW  122 ;DPB_MAXCL
00252C F24A 00                      DB  0   ;DPB_FDMODE
00252D F24B 06                      DB  6   ;DPB_DIRSCNT
00252E F24C 00                      DB  0   ;DPB_MAXCYL
00252F F24D 00                      DB  0   ;DPB_MAXSEC
002530 F24E 01                      DB  1   ;DPB_FATPS
002531 F24F 01                      DB  1   ;DPB_BPS
002532 F250 0200                    DW  2   ;DPB_DIRPS
002534 F252 0C                      DB  00CH    ;DPB_DEVICE
002535 F253 F8                      DB  0F8H    ;DPB_UNITNO
002536 F254 0600                    DW  6   ;DPB_ADDCL
002538 F256 0000                    DW  0   ;DPB_16
00253A F258 0000                    DW  0   ;DPB_18
00253C F25A 0000                    DW  0   ;DPB_SDIR
00253E F25C 434D4F53                DB  "CMOS"  ;DPB_NAME
                                
                                ;   D:
                                
002542 F260                         DS  32
                                
                                ;   E:
                                
       F280                     EMMFL:
002562 F280 0000                    DW  0   ;DPB_FATLN
002564 F282 8DEA                    DW  EDRD    ;DPB_DRD
002566 F284 80EA                    DW  EDWT    ;DPB_DWT
002568 F286 FA                      DB  0FAH    ;DPB_FATID
002569 F287 02                      DB  2   ;DPB_SECPCL
00256A F288 0000                    DW  0   ;DPB_MAXCL
00256C F28A 00                      DB  0   ;DPB_FDMODE
00256D F28B 10                      DB  16  ;DPB_DIRSCNT
00256E F28C 00                      DB  0   ;DPB_MAXCYL
00256F F28D 00                      DB  0   ;DPB_MAXSEC
002570 F28E 01                      DB  1   ;DPB_FATPS
002571 F28F 01                      DB  1   ;DPB_BPS
002572 F290 0000                    DW  0   ;DPB_DIRPS
002574 F292 26                      DB  026H    ;DPB_DEVICE
002575 F293 00                      DB  0   ;DPB_UNITNO
002576 F294 0000                    DW  0   ;DPB_ADDCL
002578 F296 0000                    DW  0   ;DPB_16
00257A F298 0000                    DW  0   ;DPB_18
00257C F29A 0000                    DW  0   ;DPB_SDIR
00257E F29C 454D4D30                DB  "EMM0"  ;DPB_NAME
                                
                                ;   F:
                                
002582 F2A0 0200                    DW  2   ;DPB_FATLN
002584 F2A2 EDEA                    DW  RDRD    ;DPB_DRD
002586 F2A4 E9EA                    DW  RDWT    ;DPB_DWT
002588 F2A6 FA                      DB  0FAH    ;DPB_FATID
002589 F2A7 01                      DB  1   ;DPB_SECPCL
00258A F2A8 F600                    DW  246 ;DPB_MAXCL
00258C F2AA 00                      DB  0   ;DPB_FDMODE
00258D F2AB 09                      DB  9   ;DPB_DIRSCNT
00258E F2AC 00                      DB  0   ;DPB_MAXCYL
00258F F2AD 00                      DB  0   ;DPB_MAXSEC
002590 F2AE 01                      DB  1   ;DPB_FATPS
002591 F2AF 01                      DB  1   ;DPB_BPS
002592 F2B0 0300                    DW  3   ;DPB_DIRPS
002594 F2B2 0F                      DB  00FH    ;DPB_DEVICE
002595 F2B3 00                      DB  0   ;DPB_UNITNO
002596 F2B4 0A00                    DW  10  ;DPB_ADDCL
002598 F2B6 0000                    DW  0   ;DPB_16
00259A F2B8 0000                    DW  0   ;DPB_18
00259C F2BA 0000                    DW  0   ;DPB_SDIR
00259E F2BC 52414D46                DB  "RAMF"  ;DPB_NAME
                                
                                ;   G:
       F2C0                     GRAMFL:
0025A2 F2C0 0100                    DW  1   ;DPB_FATLN
0025A4 F2C2 18EB                    DW  GDRD    ;DPB_DRD
0025A6 F2C4 03EB                    DW  GDWT    ;DPB_DWT
0025A8 F2C6 FA                      DB  0FAH    ;DPB_FATID
0025A9 F2C7 01                      DB  1   ;DPB_SECPCL
0025AA F2C8 5A00                    DW  90  ;DPB_MAXCL
0025AC F2CA 00                      DB  0   ;DPB_FDMODE
0025AD F2CB 06                      DB  6   ;DPB_DIRSCNT
0025AE F2CC 00                      DB  0   ;DPB_MAXCYL
0025AF F2CD 00                      DB  0   ;DPB_MAXSEC
0025B0 F2CE 01                      DB  1   ;DPB_FATPS
0025B1 F2CF 01                      DB  1   ;DPB_BPS
0025B2 F2D0 0200                    DW  2   ;DPB_DIRPS
0025B4 F2D2 05                      DB  005H    ;DPB_DEVICE
0025B5 F2D3 F8                      DB  0F8H    ;DPB_UNITNO
0025B6 F2D4 0600                    DW  6   ;DPB_ADDCL
0025B8 F2D6 0000                    DW  0   ;DPB_16
0025BA F2D8 0000                    DW  0   ;DPB_18
0025BC F2DA 0000                    DW  0   ;DPB_SDIR
0025BE F2DC 4752414D                DB  "GRAM"  ;DPB_NAME
                                
                                ;   H:
0025C2 F2E0                         DS  3
0025C5 F2E3 00                      DB  0
[EOF:M7DPB.ASM:UTF_8]
                                
       A5C6                     LAST_ADR    EQU $$+OFFSET
                                
                                    END
[EOF:M7.ASM:UTF_8]
[EOF:M7I.ASM:UTF_8]
