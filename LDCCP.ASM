
;	LSX-Dodgers CCP

WBOOT1:
	DI
	LD	SP,STACK

	LD	A,INTVEC/256
	LD	I,A

	LD	A,0E4H
	CALL	COMOUT
	LD	A,INTVEC
	CALL	OT49SB

	LD	A,(CRTCD+12)
	OR	A
	JR	NZ,SETCRT0
	LD	HL,0-80*LINE
	LD	(CRTCD+10),HL
	LD	HL,0-80
	LD	(CRTCD+12),HL
SETCRT0:
	LD	HL,CRTCD
	XOR	A
SETCRT2:
	LD	BC,01800H
	OUT	(C),A
	INC	C
	INC	B
	OUTI
	INC	A
	CP	12
	JR	NZ,SETCRT2
	DEC	C
	OUT	(C),A
	INC	C
;	OUT	(C),0		;未定義命令ニーモニック
	DB	0EDH,071H
	DEC	C
	INC	A
	OUT	(C),A
	INC	C
;	OUT	(C),0		;未定義命令ニーモニック
	DB	0EDH,071H
	INC	HL
	INC	HL
	LD	BC,01A03H+00100H
	OUTI
	LD	BC,01FD0H+00100H
	OUTI
	CALL	LTNL
COMMAND:
	CALL	SETDTA1
	PUSH	DE
	LD	A,(_DVSW)
	ADD	A,'A'
	LD	E,A
	CALL	_PRINT
	LD	E,'>'
	CALL	_PRINT
	POP	DE		;DE=DTA1
	LD	A,80
	LD	(DE),A
	CALL	_SYS0A		;(BDOS)文字列入力
	CALL	LTNL

	LD	DE,DTA1+2
	CALL	_COMANL
	JR	NC,COMMAND
	CALL	KEYBC
	LD	DE,COMERM
	CALL	_SYS09		;(BDOS)文字列出力
	RST	0

COMANL:
	CALL	FILE
	PUSH	DE
	LD	DE,FNAME
	LD	A,(DE)
	CP	020H
	JR	Z,SDVSW
	DEC	DE
	LD	A,(DE)
	ADD	A,0FFH
	JR	C,COMB
	INC	DE

	LD	HL,COMTB
	LD	A,COMS
	LD	B,A
	CALL	CPNAME
COMB:
	POP	DE
	JP	NC,JP_HL
	EX	DE,HL
	LD	(COMPAT+1),HL
	LD	(BATPAT+1),HL
	PUSH	AF
	CALL	CEXE4
	POP	AF
	LD	HL,FNAME
	LD	DE,FCB2+1	;COMMAND NAME
	LD	BC,11
	LDIR
	LD	DE,PATHD
CEX1:
	LD	A,(DE)
	CP	020H
	RET	C
	CALL	FILEC
	PUSH	DE
	LD	HL,FCB2+1	;COMMAND NAME
	LD	DE,FNAME
	LD	BC,11
	LDIR
	CALL	CEXE4
	POP	DE
	INC	DE
	JR	CEX1

SDVSW:
	POP	AF
	LD	A,(FDRV)
	DEC	A
	LD	E,A
	LD	C,00EH		;(BDOS)カレント・ドライブの設定
	JR	SYSTEM0

OPEN1:
	LD	HL,FDRV
OPEN:
	LD	C,011H		;(BDOS)最初のファイルの検索
OPEN3:
	PUSH	DE
	LD	DE,DTA
	CALL	SETDTA
	EX	DE,HL
	CALL	SYSTEM
	POP	DE
	OR	A
	RET

OPEN2:
	LD	C,012H
	JR	OPEN3

DEFCB:				;Z=Ok NZ=Error
	LD	DE,DTA
	CALL	SYSC0F

	LD	HL,0
	LD	(DTA+33),HL
	LD	(DTA+35),HL
	LD	DE,00100H
SETDTA:
	JP	_SYS1A		;(BDOS)DTAの設定

SETDTA1:
	LD	DE,DTA1
	JR	SETDTA

SYSC0F:
	LD	C,00FH		;(BDOS)ファイルのオープン
SYSTEM0:
	CALL	SYSTEM
	OR	A
	RET

C_CD:
	CALL	FILEC
	LD	HL,0
	LD	DE,FDRV
	JR	S27

S27DTA:
	LD	DE,DTA
S27:
	LD	C,027H		;(BDOS)ランダム・ブロック・リード
	JR	SYSTEM0

CEXE4:
	LD	A,(FDRV)
	LD	(00057H),A
	LD	HL,(FDRV+14)
	LD	(00058H),HL

	LD	HL,FNAME+8
	LD	A,(HL)
	CP	020H
	JR	NZ,CEXE7
	LD	A,'?'
	LD	(HL),A
	INC	HL
	LD	(HL),A
	INC	HL
	LD	(HL),A
CEXE7:
	CALL	OPEN1
CEXE5:
	RET	NZ
	LD	HL,(DTA+1+9)
	LD	A,H
	CALL	CAP
	LD	H,A
	LD	A,L
	CALL	CAP
	LD	L,A
	LD	A,(DTA+1+8)
	CALL	CAP
	SUB	'B'
	JR	Z,C_BAT
	DEC	A		;'C'
	JR	Z,C_EXE
CEXE6:
	CALL	OPEN2
	JR	CEXE5

C_EXE:
	LD	A,H
	CP	'M'
	JR	NZ,CEXE6

	CALL	DEFCB
	LD	HL,(SYSTEM+1)
	DEC	H
	CALL	S27DTA
	DEC	A
	SCF
	RET	NZ
	LD	A,H
	OR	L
	SCF
	RET	Z
	CALL	SETDTA1
COMPAT:	LD	DE,0
	CALL	SETFCB
	XOR	A
	LD	H,A
	LD	L,A	;HL=0x0000
	LD	SP,HL	;STACK=0
	PUSH	HL
	INC	H	;HL=0x0100
	JP	(HL)

C_BAT:
	LD	DE,'A'+'T'*256
	SBC	HL,DE
	JR	NZ,CEXE6

	POP	AF
	POP	AF
	CALL	DEFCB
	LD	HL,00200H
	CALL	S27DTA
	ADD	A,0FEH
	RET	C
	LD	A,L
	OR	A
	SCF
	RET	Z
	INC	A
	PUSH	AF

	CALL	KEYBC
	LD	E,01AH
	CALL	_PRINT
	POP	BC
	LD	HL,00100H
BAT1:
	AND	A
	DEC	B
	RET	Z
	LD	A,(HL)
	CP	'%'
	JR	Z,BAT2
BAT1X:
	LD	A,(HL)
	INC	HL
	CP	01AH
	RET	Z
	CP	00AH
	CALL	NZ,KEYBS
	JR	BAT1

BAT2:
	INC	HL
	LD	A,(HL)
	DEC	HL
	SUB	'1'
	JR	C,BAT1X
	CP	9
	JR	NC,BAT1X
	INC	HL
	INC	HL
	INC	A
	LD	C,A
BATPAT:	LD	DE,0
BAT3:
	LD	A,(DE)
	OR	A
	JR	Z,BAT1
	CALL	SPCUT
	DEC	C
	JR	Z,BAT5
BAT4:
	LD	A,(DE)
	CP	021H
	JR	C,BAT3
	INC	DE
	JR	BAT4
BAT5:
	LD	A,(DE)
	CP	021H
	JR	C,BAT1
	INC	DE
	CALL	KEYBS
	JR	BAT5

SWITCH:
	LD	A,(DE)
SW1:
	INC	DE
	CP	C
	LD	A,(DE)
	RET	Z
	CP	020H
	JR	NC,SW1
C_REM:
	XOR	A
	RET

C_DEL:
	CALL	SETFCB
	CALL	_SYS08		;(BDOS)エコーなしコンソール入力

	LD	C,013H
	JR	CDEL1

C_REN:
	CALL	SETFCB
	LD	A,010H		;ディレクトリも対象にする
	LD	(FCB1+13),A	;属性
	LD	C,017H		;(BDOS)ファイル名の変更
CDEL1:
	LD	DE,FCB1
	CALL	SYSTEM
	ADD	A,0FFH
	RET

C_DIR:
	CALL	FILEC
	LD	HL,FDRV+1
	CALL	CWILD1
	LD	A,0F1H
	LD	(FDRV+13),A
	CALL	OPEN1
CDIR1:
	OR	A
	JR	NZ,PDSKF
	CALL	P_NAME
	CALL	OPEN2
	JR	CDIR1

PDSKF:
	LD	A,(FDRV)
	LD	E,A
	LD	C,01BH		;(BDOS)ディスク情報の獲得
	CALL	SYSTEM
	LD	C,A
	ADD	A,001H
	RET	C
	XOR	A
PDS1:
	RR	C
	JR	C,PDS2
	ADD	HL,HL
	ADC	A,A
	JR	PDS1
PDS2:
	BIT	2,B
	JR	NZ,PDSKF1
	SRL	A
	RR	H
	RR	L
	RL	B
	JR	PDS2
PDSKF1:
	CALL	PRDEC
	LD	DE,KBFREE
	CALL	_SYS09		;(BDOS)文字列出力
	CALL	PUTDRV
	LD	A,05CH
	CALL	MSG_
	LD	HL,(FDRV+14)
	LD	A,H
	OR	L
	JR	Z,LTNL
	DEC	HL
	LD	A,H
	OR	L
	CALL	NZ,PRDEC0
	JR	LTNL

P_NAME:
	LD	A,(DTA+1)
	CP	'.'
	RET	Z
	LD	A,020H
	CALL	MSG_
	CALL	MSG_
	LD	A,':'
	CALL	MSG_
	LD	A,(DTA+1+00BH)
	PUSH	AF
	RRCA
	SBC	A,A
	AND	'*'-020H
	ADD	A,020H
	CALL	MSG_
	CALL	PUTDRV
	LD	HL,DTA+1
	CALL	FPRNT

	POP	AF
	BIT	4,A
	JR	Z,DIR3
	LD	DE,DIRMES
	CALL	_SYS09		;(BDOS)文字列出力
	JR	DIR6
DIR3:
	LD	A,(DTA+1+01EH)
	LD	HL,(DTA+1+01CH)
	CALL	PRDEC
DIR6:
	LD	A,(CRTCD+1)
	CP	40+1
	CALL	NC,PRTTMS

LTNL:
	LD	E,00DH
	CALL	PRINTX
	LD	E,00AH
	JP	PRINTX

C_PATH:
	CALL	SPCUT
	LD	HL,PATHD
	CP	021H
	JR	NC,CPATH0
	DEC	HL
	DEC	HL
CPATHP:
	LD	A,(HL)
	INC	HL
	CP	020H
	CCF
	JR	NC,LTNL
	CALL	MSG_
	JR	CPATHP
CPATH0:
	CP	';'
	JR	NZ,CPATH1
	INC	DE
CPATH1:
	EX	DE,HL
	LD	BC,PATHX
	LDIR
	RET

PUTDRV:
	LD	A,(FDRV)
	ADD	A,'A'-1
	CALL	MSG_
	LD	A,':'
MSGR:
	JP	MSG_

PRDEC0:
	XOR	A
PRDEC:
	LD	E,A
	LD	BC,0
	LD	(DECBF),BC
	LD	(DECBF+2),BC

	LD	C,24
DEC1:
	ADD	HL,HL
	LD	A,E
	ADC	A,A
	LD	E,A
	PUSH	HL
	LD	HL,DECBF+3
	LD	B,4
DEC2:
	LD	A,(HL)
	ADC	A,A
	DAA
	LD	(HL),A
	DEC	HL
	DJNZ	DEC2
	POP	HL
	DEC	C
	JR	NZ,DEC1

	LD	HL,DECBF
	LD	A,020H
	LD	B,3
DEC3:
	CALL	DEC4
	CALL	DEC4
	INC	HL
	DJNZ	DEC3
DECX:
	CALL	DEC4
	XOR	A
DEC4:
	RLD
	CP	020H
	JR	Z,DEC5
	OR	030H
DEC5:
	JR	MSGR

FPRNT:
	LD	B,8
	CALL	P_N1
	LD	A,(HL)
	ADD	A,0A0H-020H
	CP	0A0H
	JR	Z,FPR1
	LD	A,'.'
FPR1:
	CALL	MSG_
	LD	B,3

P_N1:
	PUSH	BC
	PUSH	HL
	LD	A,(HL)
	CALL	CAP3
	CALL	MSG_
	POP	HL
	POP	BC
	INC	HL
	DJNZ	P_N1
	RET

PRTTMS:
	LD	A,020H
	CALL	MSG_

	LD	HL,(DTA+1+24)
	LD	A,L
	OR	A
	RET	Z
	SRL	H
	RLA
	RLA
	RLA
	RLA
	AND	00FH
	LD	D,A
	LD	A,H
	ADD	A,80
	CALL	PRTA
	LD	A,'-'
	CALL	MSG_
	LD	A,D
	CALL	PRTA
	LD	A,'-'
	CALL	MSG_
	LD	A,L
	AND	01FH
	CALL	PRTA

	LD	HL,(DTA+1+22)

	LD	A,020H
	CALL	MSG_
	LD	A,H
	LD	H,L
	RRA
	RR	L
	RRA
	RR	L
	RRA
	RR	L
	AND	01FH
	CALL	PRTA
	LD	A,':'
	CALL	MSG_
	LD	A,L
	RRCA
	RRCA
	AND	03FH
	CALL	PRTA
	LD	A,':'
	CALL	MSG_
	LD	A,H
	AND	01FH
	ADD	A,A

;	PRINT10

PRTA:
	PUSH	HL
	LD	B,8
	LD	C,A
	XOR	A
PRTA1:
	RLC	C
	ADC	A,A
	DAA
	DJNZ	PRTA1
	LD	HL,DECBF
	LD	(HL),A
	XOR	A
	CALL	DECX
	POP	HL
	RET

SETFCB:
	CALL	SPCUT
	LD	A,(DE)
	CP	020H
	JR	C,SETFCBA
	DEC	DE
SETFCBA:
	PUSH	DE
	LD	HL,FCB1
	LD	DE,FCB1+1
	LD	BC,00023H
	LD	(HL),B		;B=0
	LDIR
	POP	DE
	PUSH	DE
	LD	HL,FCB1
	CALL	_SYS29		;(BDOS)ファイル名の解析
	LD	HL,FCB2
	CALL	_SYS29		;(BDOS)ファイル名の解析
	POP	HL
	LD	BC,05000H
	LD	DE,00081H
SETFCB1:
	LD	A,(HL)
	INC	HL
	CP	020H
	JR	C,SETFCB2
	LD	(DE),A
	INC	DE
	INC	C
	DJNZ	SETFCB1
SETFCB2:
	LD	A,C
	LD	(DTA1),A
	INC	B
	XOR	A
SETFCB3:
	LD	(DE),A
	INC	DE
	DJNZ	SETFCB3
	RET

C_COPY:
	CALL	SETFCB
	LD	DE,DTA1+1
	LD	C,'/'
	CALL	SWITCH
	CALL	CAP
	LD	(SW+1),A

	LD	DE,BEEPD
	CALL	FILEC2
	LD	HL,FCB2
	CALL	S29X1

	LD	A,010H
	LD	(FCB1+13),A
	LD	HL,FCB2+1
	CALL	CWILD1
COPY0:
	CALL	CWILD
	LD	HL,FCB1
	CALL	OPEN
	SCF
COPY1:
	RET	NZ
	CALL	DEFCB

	LD	A,(DTA+13)
	BIT	4,A
	JR	Z,COPY1A

	LD	HL,FCB1+1
	CALL	CHKWILD
	JR	C,COPY9

	LD	A,020H
	LD	(FCB1+1),A
	LD	HL,(DTA+26)
	INC	HL
	LD	(FCB1+14),HL
	JR	COPY0

COPYS:
	LD	DE,SKIP
COPY8:
	CALL	_SYS09		;(BDOS)文字列出力
	CALL	LTNL
COPY9:
	CALL	OPEN2
	JR	COPY1

COPY1A:
	LD	HL,FCB2
	LD	DE,FDRV
	LD	BC,DTA+2
	LDI
	LD	A,11
COPY2:
	PUSH	AF
	LD	A,(HL)
	CP	'?'
	JR	NZ,COPY3
	LD	A,(BC)
COPY3:
	LD	(DE),A
	INC	BC
	INC	DE
	INC	HL
	POP	AF
	DEC	A
	JR	NZ,COPY2
	LD	BC,16-11
	LDIR
PUTNAME:
	LD	HL,FCB1+1
	CALL	CHKWILD
	JR	NC,PUTN1
	LD	HL,FDRV+1
	CALL	FPRNT
	LD	A,020H
	CALL	MSG_
PUTN1:
SW:	LD	A,000H
	CP	'T'
	JR	NZ,CSW1
	LD	HL,SWNE
	JR	SWT1
CSW1:
	CP	'N'
	JR	NZ,SWNE
	LD	HL,COPYS
SWT1:
	LD	DE,FDRV
	CALL	SYSC0F
	JR	Z,SWN1
	JP	(HL)
SWN1:
	CALL	CTIME
	JR	NC,COPYS
SWNE:
	LD	DE,FDRV
	LD	C,016H		;(BDOS)ファイルの作成
	CALL	SYSTEM0
	JR	NZ,COPYE2
	LD	H,A		;A=0
	LD	L,A
	LD	(FDRV+33),HL
	LD	(FDRV+35),A
COPY6:
	CALL	BUFSIZ
	CALL	S27DTA
	LD	B,A
	INC	A
	JR	Z,COPYE
	LD	A,H
	OR	L
	JR	Z,COPY7
	LD	DE,FDRV
	LD	C,026H		;(BDOS)ランダム・ブロック・ライト
	CALL	SYSTEM
	OR	A
	JR	NZ,COPYE
	DEC	B
	JR	NZ,COPY6
COPY7:
	LD	A,(DTA+13)
	LD	(FDRV+13),A
	LD	HL,DTA+20
	LD	DE,FDRV+20
	LD	BC,4
	LDIR

	LD	DE,FDRV
	LD	C,010H		;(BDOS)ファイルのクローズ
	CALL	SYSTEM0
	JR	NZ,COPYE

	LD	DE,OK
	JP	COPY8

COPYE:
	LD	DE,FDRV
	LD	C,013H		;(BDOS)ファイルの削除
	CALL	SYSTEM
COPYE2:
	SCF
	RET

CTIME:
	LD	DE,(DTA+20)
	LD	HL,(FDRV+20)
	AND	A
	SBC	HL,DE
	RET	NZ
	LD	DE,(DTA+22)
	LD	HL,(FDRV+22)
	SBC	HL,DE
	RET

C_TYPE:
	CALL	SETFCB
	LD	HL,FCB1
	CALL	OPEN
	SCF
TYPE1:
	RET	NZ
	CALL	DEFCB
	LD	E,01AH
	CALL	_PRINT
TYPE2:
	CALL	BUFSIZ
	CALL	S27DTA
	ADD	A,0FEH
	RET	C
	LD	A,H
	OR	L
	JR	Z,TYPEE
	LD	BC,00100H
TYPE3:
	LD	A,(BC)
	INC	BC
	CP	01AH
	JR	Z,TYPEE
	LD	E,A
	CALL	_SYS02		;(BDOS)コンソール出力
	DEC	HL
	LD	A,H
	OR	L
	JR	NZ,TYPE3
	JR	TYPE2
TYPEE:
	CALL	OPEN2
	JR	TYPE1

CWILD:
	LD	HL,FCB1+1
CWILD1:
	LD	A,(HL)
	CP	020H
	RET	NZ
CWILD2:
	LD	D,H
	LD	E,L
	INC	DE
	LD	BC,10
	LD	(HL),'?'
	LDIR
	RET

BUFSIZ:
	LD	A,(SYSTEM+2)
	SUB	3
	AND	0F8H
	LD	H,A
	LD	L,0
	RET

PATHX	EQU	64
PATHD:	DS	PATHX
PATHE:	DB	0

COMS	EQU	9
COMTB:
	DB	"D   "	;1
	DW	C_DIR
	DB	"DIR "	;2
	DW	C_DIR
	DB	"COPY"	;3
	DW	C_COPY
	DB	"CD  "	;4
	DW	C_CD
	DB	"DEL "	;5
	DW	C_DEL
	DB	"PATH"	;6
	DW	C_PATH
	DB	"REN "	;7
	DW	C_REN
	DB	"TYPE"	;8
	DW	C_TYPE
	DB	"REM "	;9
	DW	C_REM

KBFREE:	DB	"k bytes free",9,'$'
DIRMES:	DB	"   <DIR>$"
OK:	DB	"OK$"
SKIP:	DB	"Skip$"
COMERM:	DB	"Error!$"
