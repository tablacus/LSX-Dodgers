                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   LSX-Dodgers for X1/turbo/Z
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "88DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   PC-8001mkIISR
                                
       0002                     MAC EQU 2   ;PC-8001mkIISR
       0001                     DEV EQU 1
                                
                                
       CD00                     RUN EQU 0CD00H
       CCF9                     OFFSET  EQU RUN-7
                                
       D006                     BDOS    EQU 0D006H
       EDC8                     TABLEAD EQU 0EDC8H
       EF00                     WORKAD  EQU 0EF00H
       F200                     FATBF   EQU 0F200H
       FA00                     DTBUF   EQU 0FA00H
       FE00                     KEYBF   EQU 0FE00H
       FF00                     KBUF    EQU 0FF00H
       FFD9                     TRAP38  EQU 0FFD9H
       0050                     WIDTH   EQU 80
       0018                     LINE    EQU 24
       0000                     COLORF  EQU 0
       0009                     COMS    EQU 9
                                
                                ; ディスクサブシステム
       002A                     MAIN        EQU 0002AH
       0045                     CHECKRESULT EQU 00045H
       01AA                     SEEK        EQU 01AAh
       03E9                     GETDEVSTAT  EQU 003E9H
       040E                     MAPDRV      EQU 0040EH
       06A6                     GETPARAM    EQU 006A6H
       07D6                     SEEK_AND_WAIT   EQU 007D6H
                                
       4000                     DSS_DATA    EQU 04000H
                                
       7C00                     DSS     EQU 07C00H
[EOF:88DEF.ASM:SHIFT_JIS]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0004                     VER_2   EQU 4
       0007                     VER_3   EQU 7
       1D02                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0102                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0147                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       FFCA                     EXTBIO  EQU 0FFCAH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 CCF9                         ORG OFFSET
                                
                                ;   MSX BINARY HEADER
000000 CCF9 FE                      DB  0FEH
                                ;   MSX BINARY START ADDRESS
000001 CCFA 00CD                    DW  RUN
                                ;   MSX BINARY END ADDRESS
000003 CCFC F9F1                    DW  LAST_ADR
                                ;   MSX BINARY EXEC ADDRESS
000005 CCFE 07CD                    DW  START
                                
                                    INCLUDE "88INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   PC-8801mkIISR
                                
000007 CD00 C307CD          10      JP  START
00000A CD03 021D                    DW  MACW
00000C CD05 4701                    DW  VER
                                
       CD07                     START:
00000E CD07 F3               4      DI
00000F CD08 ED5E             8      IM  2
000011 CD0A 3107CD          10      LD  SP,START
000014 CD0D CD1CCD          17      CALL    INIT        ;NZならAUTOEXECを実行
000017 CD10 210000          10      LD  HL,0
00001A CD13 E5              11      PUSH    HL
                                
00001B CD14 C9              10      RET
                                
00001C CD15 C8              11      RET Z
00001D CD16 1134CE          10      LD  DE,AUTOD
000020 CD19 C3FDEF          10      JP  _COMANL
                                
       CD1C                     INIT:
000023 CD1C DB32            11      IN  A,(032H)
000025 CD1E CBA7             8      RES 4,A     ;高速RAMアクセスモード
000027 CD20 D332            11      OUT (032H),A
                                
000029 CD22 21C8F3          10      LD  HL,0F3C8H   ;テキストをクリア
00002C CD25 11E880          10      LD  DE,080E8H
00002F CD28 0E20             7      LD  C,' '
000031 CD2A 3E19             7      LD  A,25
       CD2C                     TVCL1:
000033 CD2C 0650             7      LD  B,80
       CD2E                     TVCL2:
000035 CD2E 71               7      LD  (HL),C
000036 CD2F 23               6      INC HL
000037 CD30 10FC            13      DJNZ    TVCL2
000039 CD32 0614             7      LD  B,20
       CD34                     TVCL3:
00003B CD34 72               7      LD  (HL),D
00003C CD35 2C               4      INC L
00003D CD36 73               7      LD  (HL),E
00003E CD37 23               6      INC HL
00003F CD38 10FA            13      DJNZ    TVCL3
000041 CD3A 3D               4      DEC A
000042 CD3B 20EF            12      JR  NZ,TVCL1
                                
000044 CD3D DB32            11      IN  A,(032H)
000046 CD3F F610             7      OR  010H        ;高速RAMアクセスモードOFF
000048 CD41 D332            11      OUT (032H),A
                                
00004A CD43 CDADDD          17      CALL    INIT_CRTC
       CD46                     BANK:
00004D CD46 DBE2            11      IN  A,(0E2H)
00004F CD48 06E3             7      LD  B,0E3H      ;拡張RAM バンク選択
000051 CD4A 21007F          10      LD  HL,07F00H
000054 CD4D F3               4      DI
       CD4E                     BANK1:
000055 CD4E 3E11             7      LD  A,011H
000057 CD50 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000059 CD52 ED69            12      OUT (C),L
00005B CD54 5E               7      LD  E,(HL)
00005C CD55 7B               4      LD  A,E
00005D CD56 C6A5             7      ADD A,0A5H
00005F CD58 77               7      LD  (HL),A
000060 CD59 BE               7      CP  (HL)
000061 CD5A 73               7      LD  (HL),E
000062 CD5B 2005            12      JR  NZ,BANK2
000064 CD5D 2C               4      INC L
000065 CD5E CB65             8      BIT 4,L
000067 CD60 28EC            12      JR  Z,BANK1
       CD62                     BANK2:
000069 CD62 AF               4      XOR A
00006A CD63 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
00006C CD65 7D               4      LD  A,L
00006D CD66 B7               4      OR  A
00006E CD67 2813            12      JR  Z,NOBANK
000070 CD69 2600             7      LD  H,0
000072 CD6B 29              11      ADD HL,HL   ;*2
000073 CD6C 29              11      ADD HL,HL   ;*4
000074 CD6D 29              11      ADD HL,HL   ;*8
000075 CD6E 29              11      ADD HL,HL   ;*16
000076 CD6F 29              11      ADD HL,HL   ;*32
000077 CD70 2B               6      DEC HL  ;-1
000078 CD71 2B               6      DEC HL  ;-2
000079 CD72 2B               6      DEC HL  ;-3
00007A CD73 22A8F1          16      LD  (BANKCL),HL
00007D CD76 CD24CE          17      CALL    CALC_FATLN
000080 CD79 32A0F1          13      LD  (BANKFL),A
       CD7C                     NOBANK:
000083 CD7C 3E0C             7      LD  A,0CH       ;レシーブメモリ
000085 CD7E CD66EB          17      CALL    PUTCOM
000088 CD81 3E7C             7      LD  A,DSS/256   ;開始アドレスH
00008A CD83 CD6FEB          17      CALL    PUTDAT
00008D CD86 AF               4      XOR A       ;開始アドレスL
00008E CD87 CD6FEB          17      CALL    PUTDAT
000091 CD8A 015A01          10      LD  BC,AT_DSSE-AT_DSS
000094 CD8D 78               4      LD  A,B     ;バイト数H
000095 CD8E CD6FEB          17      CALL    PUTDAT
000098 CD91 79               4      LD  A,C     ;バイト数H
000099 CD92 CD6FEB          17      CALL    PUTDAT
00009C CD95 2196CE          10      LD  HL,AT_DSS
       CD98                     SUBPG1:
00009F CD98 7E               7      LD  A,(HL)
0000A0 CD99 CD6FEB          17      CALL    PUTDAT
0000A3 CD9C EDA1            16      CPI
0000A5 CD9E EA98CD          10      JP  PE,SUBPG1
                                
0000A8 CDA1 210000          10      LD  HL,0
0000AB CDA4 065C             7      LD  B,05CH
0000AD CDA6 3EFF             7      LD  A,0FFH      ;RST 38H
0000AF CDA8 CDDDDE          17      CALL    FILL_MEMORY
0000B2 CDAB 06A4             7      LD  B,0A4H
0000B4 CDAD AF               4      XOR A
0000B5 CDAE CDDDDE          17      CALL    FILL_MEMORY
                                
0000B8 CDB1 3EC3             7      LD  A,0C3H      ;JP
0000BA CDB3 2103EF          10      LD  HL,CPM_WBOOT
0000BD CDB6 320000          13      LD  (00000H),A
0000C0 CDB9 220100          16      LD  (00001H),HL ;IPL
                                
0000C3 CDBC 21021D          10      LD  HL,MACW     ;3 bit7  DPB Compatible LA(1)
0000C6 CDBF 220300          16      LD  (00003H),HL ;  bit6-0 Machine
                                ;               ;4 LSX-Dodgers(01DH)
0000C9 CDC2 2106D0          10      LD  HL,BDOS
0000CC CDC5 320500          13      LD  (00005H),A
0000CF CDC8 220600          16      LD  (00006H),HL ;BDOS
                                
0000D2 CDCB 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000D5 CDCE 323800          13      LD  (00038H),A
0000D8 CDD1 223900          16      LD  (00039H),HL ;RST 038H
                                
0000DB CDD4 3EEF             7      LD  A,CPM_BOOT/256
0000DD CDD6 320B00          13      LD  (0000BH),A
                                
0000E0 CDD9 3EE9             7      LD  A,0E9H      ;JP (HL)
0000E2 CDDB 320F00          13      LD  (0000FH),A
                                
0000E5 CDDE 3A7DF0          13      LD  A,(_FATBF+1)
0000E8 CDE1 321300          13      LD  (00013H),A
                                
0000EB CDE4 3A7FF0          13      LD  A,(_DTBUF+1)
0000EE CDE7 321700          13      LD  (00017H),A
                                
0000F1 CDEA 3EFE             7      LD  A,KEYBF/256
0000F3 CDEC 321B00          13      LD  (0001BH),A
                                
0000F6 CDEF 3EFF             7      LD  A,KBUF/256
0000F8 CDF1 321F00          13      LD  (0001FH),A
                                
0000FB CDF4 214701          10      LD  HL,VER
0000FE CDF7 225A00          16      LD  (0005AH),HL
                                
000101 CDFA 2140CE          10      LD  HL,INIMES
000104 CDFD CD34D6          17      CALL    MSX
       CE00                     INIT1:
000107 CE00 F3               4      DI
000108 CE01 1100FF          10      LD  DE,0FF00H
00010B CE04 0600             7      LD  B,0
00010D CE06 CDBFD3          17      CALL    ZERO_MEMORY_DE
000110 CE09 21CAFF          10      LD  HL,EXTBIO
000113 CE0C 060F             7      LD  B,TRAP38-EXTBIO
000115 CE0E 3EFF             7      LD  A,0FFH      ;RST 38H
000117 CE10 CDDDDE          17      CALL    FILL_MEMORY
00011A CE13 216FCE          10      LD  HL,AT_TRAP38
00011D CE16 11D9FF          10      LD  DE,TRAP38
000120 CE19 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
000123 CE1C EDB0                    LDIR
                                
000125 CE1E CD4FDD          17      CALL    CHKEY
000128 CE21 FE03             7      CP  3
00012A CE23 C9              10      RET
                                
       CE24                     CALC_FATLN: ;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
00012B CE24 5D               4      LD  E,L
00012C CE25 54               4      LD  D,H
00012D CE26 29              11      ADD HL,HL   ;*2
00012E CE27 19              11      ADD HL,DE   ;*3
00012F CE28 CB3C             8      SRL H   ;/2
000131 CE2A CB1D             8      RR  L   ;1クラスタ辺り1.5バイト必要
000133 CE2C 11FF01          10      LD  DE,511  ;切り上げる
000136 CE2F 19              11      ADD HL,DE
000137 CE30 7C               4      LD  A,H
000138 CE31 CB3F             8      SRL A
00013A CE33 C9              10      RET
                                
00013B CE34 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000144 CE3D 413A00              AUTODV: DB  "A:",0
                                
000147 CE40 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for PC-8801mkIISR v"
            6765727320666F72    
            2050432D38383031    
            6D6B494953522076    
000167 CE60 312E                    DB  030H + VER_1, '.'
000169 CE62 3437                    DB  030H + VER_2 ,030H + VER_3
00016B CE64 505231                  DB  "PR1"
00016E CE67 2047616B750D0A          DB  ' Gaku',0DH,0AH
000175 CE6E 00                      DB  0
                                
       CE6F                     AT_TRAP38:
000176 FFD9                         ORG TRAP38,AT_TRAP38-OFFSET
000176 FFD9 210000          10      LD  HL,0
000179 FFDC E3              19      EX  (SP),HL
00017A FFDD 3E24             7      LD  A,'$'
00017C FFDF CD1BD9          17      CALL    MSG_A
00017F FFE2 2B               6      DEC HL
000180 FFE3 7C               4      LD  A,H
000181 FFE4 CDE8FF          17      CALL    PRHX
000184 FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
000185 FFE8 F5              11      PUSH    AF
000186 FFE9 07               4      RLCA
000187 FFEA 07               4      RLCA
000188 FFEB 07               4      RLCA
000189 FFEC 07               4      RLCA
00018A FFED CDF1FF          17      CALL    PRHX2
00018D FFF0 F1              10      POP AF
       FFF1                     PRHX2:
00018E FFF1 E60F             7      AND 00FH
000190 FFF3 FE0A             7      CP  10
000192 FFF5 3F               4      CCF
000193 FFF6 CE30             7      ADC A,'0'
000195 FFF8 27               4      DAA
000196 FFF9 C31BD9          10      JP  MSG_A
000199 FFFC                         DS  4
00019D CE96                         ORG $$+OFFSET   ;$DEPHASE
       CE96                     AT_TRAPE:
                                
       CE96                     AT_DSS:
00019D 7C00                         ORG DSS,AT_DSS-OFFSET
       7C00                     READDISKEX:
00019D 7C00 CDC57C          17      CALL    GETPARAMS
0001A0 7C03 AF               4      XOR A
0001A1 7C04 32787C          13      LD  (RETRY_RDDISK),A
0001A4 7C07 2A517D          16      LD  HL,(S_PARAMS+2)
0001A7 7C0A 7D               4      LD  A,L
0001A8 7C0B 3D               4      DEC A
0001A9 7C0C B4               4      OR  H
0001AA 7C0D 200C            12      JR  NZ,RDDISK0
0001AC 7C0F 2A547D          16      LD  HL,(S_PARAMS+5)
0001AF 7C12 7C               4      LD  A,H
0001B0 7C13 BD               4      CP  L
0001B1 7C14 2005            12      JR  NZ,RDDISK0
0001B3 7C16 3E03             7      LD  A,3
0001B5 7C18 32787C          13      LD  (RETRY_RDDISK),A
       7C1B                     RDDISK0:
0001B8 7C1B 3E46             7      LD  A,46H       ;READ DATA
0001BA 7C1D CDD27C          17      CALL    FDCOMMAND
0001BD 7C20 3877            12      JR  C,FINISH_DISK
       7C22                     RDDISK1:
0001BF 7C22 FB               4      EI
0001C0 7C23 76               4      HALT
0001C1 7C24 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0001C3 7C26 E620             7      AND 20H     ;NO SERVICE
0001C5 7C28 2808            12      JR  Z,RDDISK2
0001C7 7C2A DBFB            11      IN  A,(0FBH)    ;FDC μPD765A データレジスタ
0001C9 7C2C 77               7      LD  (HL),A
0001CA 7C2D EDA1            16      CPI
0001CC 7C2F EA227C          10      JP  PE,RDDISK1
       7C32                     RDDISK2:
0001CF 7C32 78               4      LD  A,B
0001D0 7C33 B1               4      OR  C
0001D1 7C34 32587D          13      LD  (S_LEFT),A
0001D4 7C37 7B               4      LD  A,E
0001D5 7C38 3D               4      DEC A
0001D6 7C39 B2               4      OR  D
0001D7 7C3A 2032            12      JR  NZ,WRDISK3
                                                ;2D/2DDを見分ける
                                                ;BPB
0001D9 7C3C 3A0040          13      LD  A,(DSS_DATA)
0001DC 7C3F FEEB             7      CP  0EBH        ;Short jump
0001DE 7C41 2810            12      JR  Z,S_BPBOK
0001E0 7C43 FEE9             7      CP  0E9H        ;Near jump
0001E2 7C45 280C            12      JR  Z,S_BPBOK
0001E4 7C47 FE60             7      CP  060H        ;X68k
0001E6 7C49 2808            12      JR  Z,S_BPBOK
0001E8 7C4B 3A567D          13      LD  A,(S_PARAMS+7)  ;シリンダ数
0001EB 7C4E D64D             7      SUB 77
0001ED 7C50 3F               4      CCF
0001EE 7C51 1813            12      JR  DSSBPB3
       7C53                     S_BPBOK:
0001F0 7C53 3A0C40          13      LD  A,(DSS_DATA+12) ;BPB_BytsPerSec
0001F3 7C56 2A1340          16      LD  HL,(DSS_DATA+19);BPB_TotSec16
0001F6 7C59 F604             7      OR  4
       7C5B                     DSSBPB1:
0001F8 7C5B 0F               4      RRCA
0001F9 7C5C 3803            12      JR  C,DSSBPB2
0001FB 7C5E 29              11      ADD HL,HL
0001FC 7C5F 18FA            12      JR  DSSBPB1
       7C61                     DSSBPB2:
0001FE 7C61 11C1F9          10      LD  DE,-(40*2*5*4+1)
000201 7C64 AF               4      XOR A
000202 7C65 19              11      ADD HL,DE
       7C66                     DSSBPB3:
000203 7C66 8F               4      ADC A,A
000204 7C67 87               4      ADD A,A
000205 7C68 87               4      ADD A,A
000206 7C69 0EFB             7      LD  C,0FBH
000208 7C6B CD3B7D          17      CALL    SET_WKF4
       7C6E                     WRDISK3:
00020B 7C6E DBF8            11      IN  A,(0F8H)    ;FDC μPD765A TC入力
00020D 7C70 FB               4      EI
00020E 7C71 76               4      HALT
00020F 7C72 CD4500          17      CALL    CHECKRESULT
000212 7C75 301C            12      JR  NC,FINISH_DISK0
       7C78                     RETRY_RDDISK    EQU $+1
000214 7C77 3E00             7      LD  A,0
000216 7C79 B7               4      OR  A
000217 7C7A 2817            12      JR  Z,FINISH_DISK0
000219 7C7C 3D               4      DEC A
00021A 7C7D 32787C          13      LD  (RETRY_RDDISK),A
00021D 7C80 3A547D          13      LD  A,(S_PARAMS+5)
000220 7C83 FE04             7      CP  4
000222 7C85 3003            12      JR  NC,RETRY_RDDISK1
000224 7C87 87               4      ADD A,A
000225 7C88 1802            12      JR  RETRY_RDDISK2
       7C8A                     RETRY_RDDISK1:
000227 7C8A 3E01             7      LD  A,1
       7C8C                     RETRY_RDDISK2:
000229 7C8C 67               4      LD  H,A
00022A 7C8D 6F               4      LD  L,A
00022B 7C8E 22547D          16      LD  (S_PARAMS+5),HL
00022E 7C91 1888            12      JR  RDDISK0
       7C93                     FINISH_DISK0:
000230 7C93 3A587D          13      LD  A,(S_LEFT)
000233 7C96 D601             7      SUB 1
000235 7C98 3F               4      CCF
       7C99                     FINISH_DISK:
000236 7C99 9F               4      SBC A,A
000237 7C9A 32577D          13      LD  (S_CMD_STATUS),A
00023A 7C9D C32A00          10      JP  MAIN
                                
       7CA0                     WRITEDISKEX:
00023D 7CA0 AF               4      XOR A
00023E 7CA1 32787C          13      LD  (RETRY_RDDISK),A
000241 7CA4 CDC57C          17      CALL    GETPARAMS
000244 7CA7 3E45             7      LD  A,45H       ;WRITE DATA
000246 7CA9 CDD27C          17      CALL    FDCOMMAND
000249 7CAC 38EB            12      JR  C,FINISH_DISK
       7CAE                     WRDISK1:
00024B 7CAE FB               4      EI
00024C 7CAF 76               4      HALT
00024D 7CB0 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00024F 7CB2 E620             7      AND 20H
000251 7CB4 2808            12      JR  Z,WRDISK2
000253 7CB6 7E               7      LD  A,(HL)
000254 7CB7 D3FB            11      OUT (0FBH),A    ;FDC μPD765A データレジスタ
000256 7CB9 EDA1            16      CPI
000258 7CBB EAAE7C          10      JP  PE,WRDISK1
       7CBE                     WRDISK2:
00025B 7CBE 78               4      LD  A,B
00025C 7CBF B1               4      OR  C
00025D 7CC0 32587D          13      LD  (S_LEFT),A
000260 7CC3 18A9            12      JR  WRDISK3
                                
       7CC5                     GETPARAMS:
000262 7CC5 0608             7      LD  B,8
000264 7CC7 E5              11      PUSH    HL
000265 7CC8 214F7D          10      LD  HL,S_PARAMS
       7CCB                     GETPARAMS1:
000268 7CCB D7              12      RST 10H
000269 7CCC 77               7      LD  (HL),A
00026A 7CCD 23               6      INC HL
00026B 7CCE 10FB            13      DJNZ    GETPARAMS1
00026D 7CD0 E1              10      POP HL
00026E 7CD1 C9              10      RET
                                
       7CD2                     FDCOMMAND:
00026F 7CD2 F5              11      PUSH    AF
000270 7CD3 3A537D          13      LD  A,(S_PARAMS+4)  ;MFMモード切り替え $FF:2D/2DD $FE:2HD
000273 7CD6 1F               4      RRA
000274 7CD7 3F               4      CCF
000275 7CD8 9F               4      SBC A,A
000276 7CD9 E605             7      AND 5
000278 7CDB 0EFE             7      LD  C,0FEH  ;マスク
00027A 7CDD CD3B7D          17      CALL    SET_WKF4
00027D 7CE0 D3F4            11      OUT (0F4H),A    ;ドライブ制御
                                
00027F 7CE2 ED4B4F7D        20      LD  BC,(S_PARAMS)
000283 7CE6 ED5B517D        20      LD  DE,(S_PARAMS+2)
000287 7CEA CDAA01          17      CALL    SEEK
00028A 7CED E5              11      PUSH    HL
00028B 7CEE 210040          10      LD  HL,04000H
       7CF1                     WAIT_SEEK:
00028E 7CF1 CDE903          17      CALL    GETDEVSTAT
000291 7CF4 E608             7      AND 8
000293 7CF6 2009            12      JR  NZ,SEEK_OK
000295 7CF8 2B               6      DEC HL
000296 7CF9 7C               4      LD  A,H
000297 7CFA B5               4      OR  L
000298 7CFB 20F4            12      JR  NZ,WAIT_SEEK
00029A 7CFD E1              10      POP HL
00029B 7CFE F1              10      POP AF
00029C 7CFF 37               4      SCF
00029D 7D00 C9              10      RET
       7D01                     SEEK_OK:
00029E 7D01 E1              10      POP HL
00029F 7D02 F1              10      POP AF
0002A0 7D03 E7              12      RST 20H
0002A1 7D04 CD0E04          17      CALL    MAPDRV      ;HD US1 US0
0002A4 7D07 E7              12      RST 20H
0002A5 7D08 7A               4      LD  A,D     ;C
0002A6 7D09 CB3F             8      SRL A
0002A8 7D0B E7              12      RST 20H
0002A9 7D0C 7A               4      LD  A,D     ;H
0002AA 7D0D E601             7      AND 1
0002AC 7D0F E7              12      RST 20H
0002AD 7D10 7B               4      LD  A,E     ;R
0002AE 7D11 E7              12      RST 20H
0002AF 7D12 3A547D          13      LD  A,(S_PARAMS+5)  ;N
0002B2 7D15 FE04             7      CP  4
0002B4 7D17 3802            12      JR  C,FDCOMMAND2
0002B6 7D19 3E03             7      LD  A,3
       7D1B                     FDCOMMAND2:
0002B8 7D1B E7              12      RST 20H
0002B9 7D1C 78               4      LD  A,B     ;EOT
0002BA 7D1D E7              12      RST 20H
0002BB 7D1E 3E54             7      LD  A,054H      ;GSL
0002BD 7D20 E7              12      RST 20H
0002BE 7D21 AF               4      XOR A       ;DTL
0002BF 7D22 E7              12      RST 20H
0002C0 7D23 0E00             7      LD  C,0
0002C2 7D25 3A557D          13      LD  A,(S_PARAMS+6)
0002C5 7D28 47               4      LD  B,A     ;バイト数H
0002C6 7D29 210040          10      LD  HL,DSS_DATA ;開始アドレス
0002C9 7D2C A7               4      AND A
0002CA 7D2D C9              10      RET
                                
       7D2E                     RESULTEX:
0002CB 7D2E 3A577D          13      LD  A,(S_CMD_STATUS)
0002CE 7D31 3C               4      INC A
0002CF 7D32 2803            12      JR  Z,RESULTEX1
0002D1 7D34 3A557D          13      LD  A,(S_PARAMS+6)  ;バイト数H
       7D37                     RESULTEX1:
0002D4 7D37 DF              12      RST 18H
0002D5 7D38 C32A00          10      JP  MAIN
                                
       7D3B                     SET_WKF4:
0002D8 7D3B 47               4      LD  B,A
0002D9 7D3C 3A4F7D          13      LD  A,(S_PARAMS)    ;0:ドライブA 1:ドライブB
0002DC 7D3F B7               4      OR  A
0002DD 7D40 2804            12      JR  Z,SET_WKF4_1
0002DF 7D42 CB20             8      SLA B
0002E1 7D44 CB21             8      SLA C
       7D46                     SET_WKF4_1:
0002E3 7D46 3A597D          13      LD  A,(S_WKF4)
0002E6 7D49 A1               4      AND C
0002E7 7D4A B0               4      OR  B
0002E8 7D4B 32597D          13      LD  (S_WKF4),A
0002EB 7D4E C9              10      RET
                                
       7D4F                     S_PARAMS:
0002EC 7D4F                         DS  8
       7D57                     S_CMD_STATUS:
0002F4 7D57 00                      DB  0
       7D58                     S_LEFT:
0002F5 7D58 00                      DB  0
       7D59                     S_WKF4:
0002F6 7D59 00                      DB  0
                                
0002F7 CFF0                         ORG $$+OFFSET   ;$DEPHASE
       CFF0                     AT_DSSE:
                                
       CFF0                     INITE:
                                ;   ORG BDOS,INITE-OFFSET
0002F7 CFF0                         DS  BDOS-INITE
00030D D006 C3E7D8          10      JP  BDOS_RF
[EOF:88INIT.ASM:SHIFT_JIS]
                                    INCLUDE "88CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   PC-8801mkIISR
                                
       D009                     WBOOT1:
000310 D009 ED7B0600        20      LD  SP,(SYSTEM+1)
000314 D00D DB32            11      IN  A,(032H)
000316 D00F F610             7      OR  10H     ;高速RAMアクセスモードOFF
000318 D011 D332            11      OUT (032H),A
00031A D013 FB               4      EI
00031B D014 2192EF          10      LD  HL,_KEYD
00031E D017 3600            10      LD  (HL),0
000320 D019 CD4FDD          17      CALL    CHKEY
000323 D01C CD08D9          17      CALL    KEYBC_IFBREAK
000326 D01F 3E04             7      LD  A,4
000328 D021 CD1BD9          17      CALL    MSG_A
[EOF:88CCP.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D024                     COMMAND:
00032B D024 CDD7D0          17      CALL    SETDTA1
00032E D027 3A87EF          13      LD  A,(_DVSW)
000331 D02A C641             7      ADD A,'A'
000333 D02C CD1BD9          17      CALL    MSG_A
000336 D02F 3E3E             7      LD  A,'>'
000338 D031 CD1BD9          17      CALL    MSG_A
00033B D034 3E50             7      LD  A,80
00033D D036 12               7      LD  (DE),A
00033E D037 CD58D9          17      CALL    _SYS0A      ;(BDOS)文字列入力
000341 D03A CD81D2          17      CALL    LTNL
                                
000344 D03D 118200          10      LD  DE,DTA1+2
000347 D040 CDFDEF          17      CALL    _COMANL
00034A D043 30DF            12      JR  NC,COMMAND
00034C D045 1179EF          10      LD  DE,COMERM
00034F D048 CD25D6          17      CALL    _SYS09      ;(BDOS)文字列出力
000352 D04B C7              12      RST 0
                                
       D04C                     COMANL:
000353 D04C CD31DE          17      CALL    FILE
000356 D04F 3A19EF          13      LD  A,(FNAME+4)
000359 D052 FE20             7      CP  020H
00035B D054 201C            12      JR  NZ,COMB2
00035D D056 D5              11      PUSH    DE
00035E D057 1115EF          10      LD  DE,FNAME
000361 D05A 1A               7      LD  A,(DE)
000362 D05B FE20             7      CP  020H
000364 D05D 2844            12      JR  Z,SDVSW
000366 D05F 1B               6      DEC DE
000367 D060 1A               7      LD  A,(DE)
000368 D061 C6FF             7      ADD A,0FFH
00036A D063 3809            12      JR  C,COMB
00036C D065 13               6      INC DE
                                
00036D D066 2162D5          10      LD  HL,COMTB
000370 D069 0609             7      LD  B,COMS
000372 D06B CDB5E0          17      CALL    CPNAME
       D06E                     COMB:
000375 D06E D1              10      POP DE
000376 D06F D20F00          10      JP  NC,JP_HL
       D072                     COMB2:
000379 D072 EB               4      EX  DE,HL
00037A D073 224BD1          16      LD  (COMPAT+1),HL
00037D D076 F5              11      PUSH    AF
00037E D077 CDF7D0          17      CALL    CEXE4
000381 D07A F1              10      POP AF
000382 D07B 2115EF          10      LD  HL,FNAME
000385 D07E 116D00          10      LD  DE,FCB2+1   ;COMMAND NAME
000388 D081 010B00          10      LD  BC,11
00038B D084 EDB0                    LDIR
00038D D086 1105D5          10      LD  DE,PATHD
       D089                     CEX1:
000390 D089 1A               7      LD  A,(DE)
000391 D08A FE20             7      CP  020H
000393 D08C D8              11      RET C
000394 D08D CD26DE          17      CALL    FILEC
000397 D090 D5              11      PUSH    DE
000398 D091 216D00          10      LD  HL,FCB2+1   ;COMMAND NAME
00039B D094 1115EF          10      LD  DE,FNAME
00039E D097 010B00          10      LD  BC,11
0003A1 D09A EDB0                    LDIR
0003A3 D09C CDF7D0          17      CALL    CEXE4
0003A6 D09F D1              10      POP DE
0003A7 D0A0 13               6      INC DE
0003A8 D0A1 18E6            12      JR  CEX1
                                
       D0A3                     SDVSW:
0003AA D0A3 F1              10      POP AF
0003AB D0A4 3A14EF          13      LD  A,(FDRV)
0003AE D0A7 3D               4      DEC A
0003AF D0A8 5F               4      LD  E,A
0003B0 D0A9 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
0003B2 D0AB 1831            12      JR  SYSTEM0
                                
       D0AD                     OPEN1:
0003B4 D0AD 2114EF          10      LD  HL,FDRV
       D0B0                     OPEN:
0003B7 D0B0 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D0B2                     OPEN3:
0003B9 D0B2 D5              11      PUSH    DE
0003BA D0B3 11E0D4          10      LD  DE,DTA_CCP
0003BD D0B6 CDD4D0          17      CALL    SETDTA
0003C0 D0B9 EB               4      EX  DE,HL
0003C1 D0BA CDDED0          17      CALL    SYSTEM0
0003C4 D0BD D1              10      POP DE
0003C5 D0BE C9              10      RET
                                
       D0BF                     OPEN2:
0003C6 D0BF 0E12             7      LD  C,012H
0003C8 D0C1 18EF            12      JR  OPEN3
                                
       D0C3                     DEFCB:              ;Z=Ok NZ=Error
0003CA D0C3 11E0D4          10      LD  DE,DTA_CCP
0003CD D0C6 CDDCD0          17      CALL    SYSC0F
                                
0003D0 D0C9 1101D5          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0003D3 D0CC 0604             7      LD  B,4
0003D5 D0CE CDBFD3          17      CALL    ZERO_MEMORY_DE
0003D8 D0D1 110001          10      LD  DE,00100H
       D0D4                     SETDTA:
0003DB D0D4 C323D8          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D0D7                     SETDTA1:
0003DE D0D7 118000          10      LD  DE,DTA1
0003E1 D0DA 18F8            12      JR  SETDTA
                                
       D0DC                     SYSC0F:
0003E3 D0DC 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D0DE                     SYSTEM0:
0003E5 D0DE CD0500          17      CALL    SYSTEM
0003E8 D0E1 B7               4      OR  A
0003E9 D0E2 C9              10      RET
                                
       D0E3                     C_CD:
0003EA D0E3 0E5A             7      LD  C,5AH
0003EC D0E5 18F7            12      JR  SYSTEM0
                                
       D0E7                     S27BUF:
0003EE D0E7 3A0700          13      LD  A,(SYSTEM+2)
0003F1 D0EA 3D               4      DEC A
0003F2 D0EB E6F8             7      AND 0F8H
0003F4 D0ED 67               4      LD  H,A
0003F5 D0EE 2E00             7      LD  L,0
       D0F0                     S27DTA:
0003F7 D0F0 11E0D4          10      LD  DE,DTA_CCP
       D0F3                     S27:
0003FA D0F3 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
0003FC D0F5 18E7            12      JR  SYSTEM0
                                
       D0F7                     CEXE4:
0003FE D0F7 3A14EF          13      LD  A,(FDRV)
000401 D0FA 325700          13      LD  (00057H),A
000404 D0FD 2A22EF          16      LD  HL,(FDRV+14)
000407 D100 225800          16      LD  (00058H),HL
                                
00040A D103 211DEF          10      LD  HL,FNAME+8
00040D D106 7E               7      LD  A,(HL)
00040E D107 FE20             7      CP  020H
000410 D109 2007            12      JR  NZ,CEXE7
000412 D10B 3E3F             7      LD  A,'?'
000414 D10D 77               7      LD  (HL),A
000415 D10E 23               6      INC HL
000416 D10F 77               7      LD  (HL),A
000417 D110 23               6      INC HL
000418 D111 77               7      LD  (HL),A
       D112                     CEXE7:
000419 D112 CDADD0          17      CALL    OPEN1
       D115                     CEXE5:
00041C D115 C0              11      RET NZ
00041D D116 2AEAD4          16      LD  HL,(DTA_CCP+1+9)
000420 D119 7C               4      LD  A,H
000421 D11A CD3DE1          17      CALL    CAP
000424 D11D 67               4      LD  H,A
000425 D11E 7D               4      LD  A,L
000426 D11F CD3DE1          17      CALL    CAP
000429 D122 6F               4      LD  L,A
00042A D123 3AE9D4          13      LD  A,(DTA_CCP+1+8)
00042D D126 CD3DE1          17      CALL    CAP
000430 D129 D642             7      SUB 'B'
000432 D12B 282C            12      JR  Z,C_BAT
000434 D12D 3D               4      DEC A       ;'C'
000435 D12E 2805            12      JR  Z,C_EXE
       D130                     CEXE6:
000437 D130 CDBFD0          17      CALL    OPEN2
00043A D133 18E0            12      JR  CEXE5
                                
       D135                     C_EXE:
00043C D135 7C               4      LD  A,H
00043D D136 FE4D             7      CP  'M'
00043F D138 20F6            12      JR  NZ,CEXE6
                                
000441 D13A CDC3D0          17      CALL    DEFCB
000444 D13D CDE7D0          17      CALL    S27BUF
000447 D140 3D               4      DEC A
000448 D141 37               4      SCF
000449 D142 C0              11      RET NZ
00044A D143 7C               4      LD  A,H
00044B D144 B5               4      OR  L
00044C D145 37               4      SCF
00044D D146 C8              11      RET Z
00044E D147 CDD7D0          17      CALL    SETDTA1
000451 D14A 110000          10  COMPAT: LD  DE,0                ; self-modifying code
000454 D14D ED7B0600        20      LD  SP,(SYSTEM+1)
000458 D151 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000459 D152 6F               4      LD  L,A
00045A D153 E5              11      PUSH    HL              ; push $0000 (reboot address)
00045B D154 24               4      INC H
00045C D155 E5              11      PUSH    HL              ; push $0100 (TPA address)
00045D D156 C38AD3          10      JP  SETFCB              ; and JP $0100
                                
       D159                     C_BAT:
000460 D159 114154          10      LD  DE,'A'+'T'*256
000463 D15C ED52            15      SBC HL,DE
000465 D15E 20D0            12      JR  NZ,CEXE6
                                
000467 D160 F1              10      POP AF
000468 D161 F1              10      POP AF
000469 D162 CDC3D0          17      CALL    DEFCB
00046C D165 210002          10      LD  HL,00200H
00046F D168 CDF0D0          17      CALL    S27DTA
000472 D16B C6FE             7      ADD A,0FEH
000474 D16D D8              11      RET C
000475 D16E 7D               4      LD  A,L
000476 D16F B7               4      OR  A
000477 D170 37               4      SCF
000478 D171 C8              11      RET Z
000479 D172 3C               4      INC A
00047A D173 F5              11      PUSH    AF
                                
00047B D174 CD0BD9          17      CALL    KEYBC
00047E D177 3E06             7      LD  A,6
000480 D179 CD1BD9          17      CALL    MSG_A
000483 D17C C1              10      POP BC
000484 D17D 210001          10      LD  HL,00100H
       D180                     BAT1:
000487 D180 A7               4      AND A
000488 D181 05               4      DEC B
000489 D182 C8              11      RET Z
00048A D183 7E               7      LD  A,(HL)
00048B D184 FE25             7      CP  '%'
00048D D186 280C            12      JR  Z,BAT2
       D188                     BAT1X:
00048F D188 7E               7      LD  A,(HL)
000490 D189 23               6      INC HL
000491 D18A FE1A             7      CP  01AH
000493 D18C C8              11      RET Z
000494 D18D FE0A             7      CP  00AH
000496 D18F C4F0D8          17      CALL    NZ,KEYBS
000499 D192 18EC            12      JR  BAT1
                                
       D194                     BAT2:
00049B D194 23               6      INC HL
00049C D195 7E               7      LD  A,(HL)
00049D D196 2B               6      DEC HL
00049E D197 D631             7      SUB '1'
0004A0 D199 38ED            12      JR  C,BAT1X
0004A2 D19B FE09             7      CP  9
0004A4 D19D 30E9            12      JR  NC,BAT1X
0004A6 D19F 23               6      INC HL
0004A7 D1A0 23               6      INC HL
0004A8 D1A1 3C               4      INC A
0004A9 D1A2 4F               4      LD  C,A
0004AA D1A3 ED5B4BD1        20      LD  DE,(COMPAT+1)
       D1A7                     BAT3:
0004AE D1A7 1A               7      LD  A,(DE)
0004AF D1A8 B7               4      OR  A
0004B0 D1A9 28D5            12      JR  Z,BAT1
0004B2 D1AB CD08DF          17      CALL    SPCUT
0004B5 D1AE 0D               4      DEC C
0004B6 D1AF 2808            12      JR  Z,BAT5
       D1B1                     BAT4:
0004B8 D1B1 1A               7      LD  A,(DE)
0004B9 D1B2 FE21             7      CP  021H
0004BB D1B4 38F1            12      JR  C,BAT3
0004BD D1B6 13               6      INC DE
0004BE D1B7 18F8            12      JR  BAT4
       D1B9                     BAT5:
0004C0 D1B9 1A               7      LD  A,(DE)
0004C1 D1BA FE21             7      CP  021H
0004C3 D1BC 38C2            12      JR  C,BAT1
0004C5 D1BE 13               6      INC DE
0004C6 D1BF CDF0D8          17      CALL    KEYBS
0004C9 D1C2 18F5            12      JR  BAT5
                                
       D1C4                     C_DEL:
0004CB D1C4 CD8AD3          17      CALL    SETFCB
0004CE D1C7 CD31D9          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
0004D1 D1CA 0E13             7      LD  C,013H
0004D3 D1CC 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D1CE                     C_REN:
0004D5 D1CE CD8AD3          17      CALL    SETFCB
0004D8 D1D1 3E10             7      LD  A,010H      ;ディレクトリも対象にする
0004DA D1D3 326900          13      LD  (FCB1+13),A ;属性
0004DD D1D6 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D1D8                     CDEL1:
0004DF D1D8 115C00          10      LD  DE,FCB1
0004E2 D1DB CD0500          17      CALL    SYSTEM
0004E5 D1DE C6FF             7      ADD A,0FFH
0004E7 D1E0 C9              10      RET
                                
       D1E1                     C_DIR:
0004E8 D1E1 CD26DE          17      CALL    FILEC
0004EB D1E4 2115EF          10      LD  HL,FDRV+1
0004EE D1E7 CDD5D4          17      CALL    CWILD1
0004F1 D1EA 3EF1             7      LD  A,0F1H
0004F3 D1EC 3221EF          13      LD  (FDRV+13),A
0004F6 D1EF CDADD0          17      CALL    OPEN1
       D1F2                     CDIR1:
0004F9 D1F2 B7               4      OR  A
0004FA D1F3 2008            12      JR  NZ,PDSKF
0004FC D1F5 CD40D2          17      CALL    P_NAME
0004FF D1F8 CDBFD0          17      CALL    OPEN2
000502 D1FB 18F5            12      JR  CDIR1
                                
       D1FD                     PDSKF:
000504 D1FD 3A14EF          13      LD  A,(FDRV)
000507 D200 5F               4      LD  E,A
000508 D201 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
00050A D203 CD0500          17      CALL    SYSTEM
00050D D206 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
00050E D207 C601             7      ADD A,001H
000510 D209 D8              11      RET C       ;Aが0FFHだった場合
000511 D20A 3E06             7      LD  A,8-2
       D20C                     PDS1:               ;HL=未使用クラスタの総数
000513 D20C 3C               4      INC A
000514 D20D CB19             8      RR  C
000516 D20F 30FB            12      JR  NC,PDS1
       D211                     PDS2:               ;B←論理セクタのサイズの上位8ビット
000518 D211 3C               4      INC A
000519 D212 CB18             8      RR  B
00051B D214 30FB            12      JR  NC,PDS2
00051D D216 47               4      LD  B,A
                                
00051E D217 110000          10      LD  DE,0
       D21A                     PDS3:
000521 D21A 29              11      ADD HL,HL
000522 D21B EB               4      EX  DE,HL
000523 D21C ED6A            15      ADC HL,HL
000525 D21E EB               4      EX  DE,HL
000526 D21F 10F9            13      DJNZ    PDS3
       D221                     PDSKF1:
000528 D221 CDB9D2          17      CALL    PRDEC_DEHL
00052B D224 1146D5          10      LD  DE,FREE
00052E D227 CD25D6          17      CALL    _SYS09      ;(BDOS)文字列出力
000531 D22A CDA8D2          17      CALL    PUTDRV
000534 D22D 3E5C             7      LD  A,05CH      ;\
000536 D22F CD1BD9          17      CALL    MSG_A
000539 D232 2A22EF          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
00053C D235 AF               4      XOR A
00053D D236 11FEFF          10      LD  DE,0-2
000540 D239 19              11      ADD HL,DE
000541 D23A 23               6      INC HL
000542 D23B DCB5D2          17      CALL    C,PRDEC_HL
000545 D23E 1841            12      JR  LTNL
                                
       D240                     P_NAME:
000547 D240 3AE1D4          13      LD  A,(DTA_CCP+1)
00054A D243 FE2E             7      CP  '.'
00054C D245 C8              11      RET Z
00054D D246 115ED5          10      LD  DE,DIRHD
000550 D249 CD25D6          17      CALL    _SYS09      ;(BDOS)文字列出力
000553 D24C 3AECD4          13      LD  A,(DTA_CCP+1+00BH)
000556 D24F F5              11      PUSH    AF
000557 D250 0F               4      RRCA
000558 D251 9F               4      SBC A,A
000559 D252 E60A             7      AND '*'-020H
00055B D254 C620             7      ADD A,020H
00055D D256 CD1BD9          17      CALL    MSG_A
000560 D259 CDA8D2          17      CALL    PUTDRV
000563 D25C 21E1D4          10      LD  HL,DTA_CCP+1
000566 D25F CDF9D2          17      CALL    FPRNT
                                
000569 D262 F1              10      POP AF
00056A D263 CB67             8      BIT 4,A
00056C D265 2808            12      JR  Z,DIR3
00056E D267 1153D5          10      LD  DE,DIRMES
000571 D26A CD25D6          17      CALL    _SYS09      ;(BDOS)文字列出力
000574 D26D 180A            12      JR  DIR6
       D26F                     DIR3:
000576 D26F ED5BFFD4        20      LD  DE,(DTA_CCP+1+01EH)
00057A D273 2AFDD4          16      LD  HL,(DTA_CCP+1+01CH)
00057D D276 CDB9D2          17      CALL    PRDEC_DEHL
       D279                     DIR6:
000580 D279 3AB1EF          13      LD  A,(_WIDTH)
000583 D27C FE29             7      CP  40+1
000585 D27E D41BD3          17      CALL    NC,PRTTMS
                                
       D281                     LTNL:
000588 D281 1E03             7      LD  E,3
00058A D283 C3CDEF          10      JP  _PRINT
                                
       D286                     C_PATH:
00058D D286 CD08DF          17      CALL    SPCUT
000590 D289 2105D5          10      LD  HL,PATHD
000593 D28C FE21             7      CP  021H
000595 D28E 300C            12      JR  NC,CPATH0
       D290                     CPATHP:
000597 D290 7E               7      LD  A,(HL)
000598 D291 23               6      INC HL
000599 D292 FE20             7      CP  020H
00059B D294 3F               4      CCF
00059C D295 30EA            12      JR  NC,LTNL
00059E D297 CD1BD9          17      CALL    MSG_A
0005A1 D29A 18F4            12      JR  CPATHP
       D29C                     CPATH0:
0005A3 D29C FE3B             7      CP  ';'
0005A5 D29E 2001            12      JR  NZ,CPATH1
0005A7 D2A0 13               6      INC DE
       D2A1                     CPATH1:
0005A8 D2A1 EB               4      EX  DE,HL
0005A9 D2A2 014000          10      LD  BC,PATHX
0005AC D2A5 EDB0                    LDIR
0005AE D2A7 C9              10      RET
                                
       D2A8                     PUTDRV:
0005AF D2A8 3A14EF          13      LD  A,(FDRV)
0005B2 D2AB C640             7      ADD A,'A'-1
0005B4 D2AD CD1BD9          17      CALL    MSG_A
0005B7 D2B0 3E3A             7      LD  A,':'
       D2B2                     MSG_AR:
0005B9 D2B2 C31BD9          10      JP  MSG_A
                                
       D2B5                     PRDEC_HL:
0005BC D2B5 AF               4      XOR A
       D2B6                     PRDEC_AHL:
0005BD D2B6 5F               4      LD  E,A
0005BE D2B7 1600             7      LD  D,0
       D2B9                     PRDEC_DEHL:
0005C0 D2B9 D5              11      PUSH    DE
0005C1 D2BA 110FEF          10      LD  DE,DECBF
0005C4 D2BD 0605             7      LD  B,5
0005C6 D2BF CDBFD3          17      CALL    ZERO_MEMORY_DE  ;A=0
0005C9 D2C2 D1              10      POP DE
                                
0005CA D2C3 0E20             7      LD  C,32
       D2C5                     DEC1:
0005CC D2C5 29              11      ADD HL,HL
0005CD D2C6 EB               4      EX  DE,HL
0005CE D2C7 ED6A            15      ADC HL,HL
0005D0 D2C9 EB               4      EX  DE,HL
0005D1 D2CA E5              11      PUSH    HL
0005D2 D2CB 2113EF          10      LD  HL,DECBF+4
0005D5 D2CE 0605             7      LD  B,5
       D2D0                     DEC2:
0005D7 D2D0 7E               7      LD  A,(HL)
0005D8 D2D1 8F               4      ADC A,A
0005D9 D2D2 27               4      DAA
0005DA D2D3 77               7      LD  (HL),A
0005DB D2D4 2B               6      DEC HL
0005DC D2D5 10F9            13      DJNZ    DEC2
0005DE D2D7 E1              10      POP HL
0005DF D2D8 0D               4      DEC C
0005E0 D2D9 20EA            12      JR  NZ,DEC1
                                
0005E2 D2DB 210FEF          10      LD  HL,DECBF
0005E5 D2DE 3E20             7      LD  A,020H
0005E7 D2E0 0604             7      LD  B,4
       D2E2                     DEC3:
0005E9 D2E2 CDEFD2          17      CALL    DEC4
0005EC D2E5 CDEFD2          17      CALL    DEC4
0005EF D2E8 23               6      INC HL
0005F0 D2E9 10F7            13      DJNZ    DEC3
       D2EB                     DECX:
0005F2 D2EB CDEFD2          17      CALL    DEC4
0005F5 D2EE AF               4      XOR A
       D2EF                     DEC4:
0005F6 D2EF ED6F            18      RLD
0005F8 D2F1 FE20             7      CP  020H
0005FA D2F3 2802            12      JR  Z,DEC5
0005FC D2F5 F630             7      OR  030H
       D2F7                     DEC5:
0005FE D2F7 18B9            12      JR  MSG_AR
                                
       D2F9                     FPRNT:
000600 D2F9 0608             7      LD  B,8
000602 D2FB CD0CD3          17      CALL    P_N1
000605 D2FE 7E               7      LD  A,(HL)
000606 D2FF C680             7      ADD A,0A0H-020H
000608 D301 FEA0             7      CP  0A0H
00060A D303 2802            12      JR  Z,FPR1
00060C D305 3E2E             7      LD  A,'.'
       D307                     FPR1:
00060E D307 CD1BD9          17      CALL    MSG_A
000611 D30A 0603             7      LD  B,3
                                
       D30C                     P_N1:
000613 D30C C5              11      PUSH    BC
000614 D30D E5              11      PUSH    HL
000615 D30E 7E               7      LD  A,(HL)
000616 D30F CD49E1          17      CALL    CAP3
000619 D312 CD1BD9          17      CALL    MSG_A
00061C D315 E1              10      POP HL
00061D D316 C1              10      POP BC
00061E D317 23               6      INC HL
00061F D318 10F2            13      DJNZ    P_N1
000621 D31A C9              10      RET
                                
       D31B                     PRTTMS:
000622 D31B 3E20             7      LD  A,020H
000624 D31D CD1BD9          17      CALL    MSG_A
                                
000627 D320 2AF9D4          16      LD  HL,(DTA_CCP+1+24)
00062A D323 7D               4      LD  A,L
00062B D324 B7               4      OR  A
00062C D325 C8              11      RET Z
00062D D326 CB3C             8      SRL H
00062F D328 17               4      RLA
000630 D329 17               4      RLA
000631 D32A 17               4      RLA
000632 D32B 17               4      RLA
000633 D32C E60F             7      AND 00FH
000635 D32E 57               4      LD  D,A
000636 D32F 7C               4      LD  A,H
000637 D330 C650             7      ADD A,80
000639 D332 CD75D3          17      CALL    PRDEC_A
00063C D335 3E2D             7      LD  A,'-'
00063E D337 CD1BD9          17      CALL    MSG_A
000641 D33A 7A               4      LD  A,D
000642 D33B CD75D3          17      CALL    PRDEC_A
000645 D33E 3E2D             7      LD  A,'-'
000647 D340 CD1BD9          17      CALL    MSG_A
00064A D343 7D               4      LD  A,L
00064B D344 E61F             7      AND 01FH
00064D D346 CD75D3          17      CALL    PRDEC_A
                                
000650 D349 2AF7D4          16      LD  HL,(DTA_CCP+1+22)
                                
000653 D34C 3E20             7      LD  A,020H
000655 D34E CD1BD9          17      CALL    MSG_A
000658 D351 7C               4      LD  A,H
000659 D352 65               4      LD  H,L
00065A D353 0603             7      LD  B,3
       D355                     PRTTMS1:
00065C D355 1F               4      RRA
00065D D356 CB1D             8      RR  L
00065F D358 10FB            13      DJNZ    PRTTMS1
000661 D35A E61F             7      AND 01FH
000663 D35C CD75D3          17      CALL    PRDEC_A
000666 D35F 3E3A             7      LD  A,':'
000668 D361 CD1BD9          17      CALL    MSG_A
00066B D364 7D               4      LD  A,L
00066C D365 0F               4      RRCA
00066D D366 0F               4      RRCA
00066E D367 E63F             7      AND 03FH
000670 D369 CD75D3          17      CALL    PRDEC_A
000673 D36C 3E3A             7      LD  A,':'
000675 D36E CD1BD9          17      CALL    MSG_A
000678 D371 7C               4      LD  A,H
000679 D372 E61F             7      AND 01FH
00067B D374 87               4      ADD A,A
                                
                                ;   PRINT10
                                
       D375                     PRDEC_A:
00067C D375 E5              11      PUSH    HL
00067D D376 0608             7      LD  B,8
00067F D378 4F               4      LD  C,A
000680 D379 AF               4      XOR A
       D37A                     PRTA1:
000681 D37A CB01             4      RLC C
000683 D37C 8F               4      ADC A,A
000684 D37D 27               4      DAA
000685 D37E 10FA            13      DJNZ    PRTA1
000687 D380 210FEF          10      LD  HL,DECBF
00068A D383 77               7      LD  (HL),A
00068B D384 AF               4      XOR A
00068C D385 CDEBD2          17      CALL    DECX
00068F D388 E1              10      POP HL
000690 D389 C9              10      RET
                                
       D38A                     SETFCB:
000691 D38A CD08DF          17      CALL    SPCUT
000694 D38D 1A               7      LD  A,(DE)
000695 D38E FE20             7      CP  020H
000697 D390 3801            12      JR  C,SETFCBA
000699 D392 1B               6      DEC DE
       D393                     SETFCBA:
00069A D393 0624             7      LD  B,36
00069C D395 215C00          10      LD  HL,FCB1
00069F D398 E5              11      PUSH    HL
0006A0 D399 AF               4      XOR A
0006A1 D39A CDDDDE          17      CALL    FILL_MEMORY
0006A4 D39D E1              10      POP HL
0006A5 D39E D5              11      PUSH    DE
0006A6 D39F CD8FD8          17      CALL    _SYS5C      ;(BDOS)ファイル名の解析
0006A9 D3A2 216C00          10      LD  HL,FCB2
0006AC D3A5 CD8FD8          17      CALL    _SYS5C      ;(BDOS)ファイル名の解析
0006AF D3A8 E1              10      POP HL
0006B0 D3A9 010050          10      LD  BC,05000H
0006B3 D3AC 118100          10      LD  DE,00081H
       D3AF                     SETFCB1:
0006B6 D3AF 7E               7      LD  A,(HL)
0006B7 D3B0 23               6      INC HL
0006B8 D3B1 FE20             7      CP  020H
0006BA D3B3 3805            12      JR  C,SETFCB2
0006BC D3B5 12               7      LD  (DE),A
0006BD D3B6 13               6      INC DE
0006BE D3B7 0C               4      INC C
0006BF D3B8 10F5            13      DJNZ    SETFCB1
       D3BA                     SETFCB2:
0006C1 D3BA 79               4      LD  A,C
0006C2 D3BB 328000          13      LD  (DTA1),A
0006C5 D3BE 04               4      INC B
       D3BF                     ZERO_MEMORY_DE:
0006C6 D3BF AF               4      XOR A
       D3C0                     FILL_MEMORY_DE:
0006C7 D3C0 12               7      LD  (DE),A
0006C8 D3C1 13               6      INC DE
0006C9 D3C2 10FC            13      DJNZ    FILL_MEMORY_DE
0006CB D3C4 C9              10      RET
                                
       D3C5                     C_COPY:
0006CC D3C5 CD8AD3          17      CALL    SETFCB
                                
0006CF D3C8 1161EF          10      LD  DE,ZERO
0006D2 D3CB CD29DE          17      CALL    FILEC2
0006D5 D3CE 216C00          10      LD  HL,FCB2
0006D8 D3D1 CD96D8          17      CALL    S29X1
                                
0006DB D3D4 3E10             7      LD  A,010H
0006DD D3D6 326900          13      LD  (FCB1+13),A
0006E0 D3D9 216D00          10      LD  HL,FCB2+1
0006E3 D3DC CDD5D4          17      CALL    CWILD1
       D3DF                     COPY0:
0006E6 D3DF CDD2D4          17      CALL    CWILD
0006E9 D3E2 215C00          10      LD  HL,FCB1
0006EC D3E5 CDB0D0          17      CALL    OPEN
0006EF D3E8 37               4      SCF
       D3E9                     COPY1:
0006F0 D3E9 C0              11      RET NZ
0006F1 D3EA CDC3D0          17      CALL    DEFCB
                                
0006F4 D3ED 3AEDD4          13      LD  A,(DTA_CCP+13)
0006F7 D3F0 CB67             8      BIT 4,A
0006F9 D3F2 2821            12      JR  Z,COPY1A
                                
0006FB D3F4 215D00          10      LD  HL,FCB1+1
0006FE D3F7 CD6CE2          17      CALL    CHKWILD
000701 D3FA 3814            12      JR  C,COPY9
                                
000703 D3FC 3E20             7      LD  A,020H
000705 D3FE 325D00          13      LD  (FCB1+1),A
000708 D401 2AFAD4          16      LD  HL,(DTA_CCP+26)
00070B D404 23               6      INC HL
00070C D405 226A00          16      LD  (FCB1+14),HL
00070F D408 18D5            12      JR  COPY0
                                
       D40A                     COPY8:
000711 D40A CD25D6          17      CALL    _SYS09      ;(BDOS)文字列出力
000714 D40D CD81D2          17      CALL    LTNL
       D410                     COPY9:
000717 D410 CDBFD0          17      CALL    OPEN2
00071A D413 18D4            12      JR  COPY1
                                
       D415                     COPY1A:
00071C D415 216C00          10      LD  HL,FCB2
00071F D418 1114EF          10      LD  DE,FDRV
000722 D41B 01E2D4          10      LD  BC,DTA_CCP+2
000725 D41E EDA0            16      LDI
000727 D420 3E0B             7      LD  A,11
       D422                     COPY2:
000729 D422 F5              11      PUSH    AF
00072A D423 7E               7      LD  A,(HL)
00072B D424 FE3F             7      CP  '?'
00072D D426 2001            12      JR  NZ,COPY3
00072F D428 0A               7      LD  A,(BC)
       D429                     COPY3:
000730 D429 12               7      LD  (DE),A
000731 D42A 03               6      INC BC
000732 D42B 13               6      INC DE
000733 D42C 23               6      INC HL
000734 D42D F1              10      POP AF
000735 D42E 3D               4      DEC A
000736 D42F 20F1            12      JR  NZ,COPY2
000738 D431 010500          10      LD  BC,16-11
00073B D434 EDB0                    LDIR
       D436                     PUTNAME:
00073D D436 215D00          10      LD  HL,FCB1+1
000740 D439 CD6CE2          17      CALL    CHKWILD
000743 D43C 300B            12      JR  NC,PUTN1
000745 D43E 2115EF          10      LD  HL,FDRV+1
000748 D441 CDF9D2          17      CALL    FPRNT
00074B D444 3E20             7      LD  A,020H
00074D D446 CD1BD9          17      CALL    MSG_A
       D449                     PUTN1:
000750 D449 1114EF          10      LD  DE,FDRV
000753 D44C 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
000755 D44E CDDED0          17      CALL    SYSTEM0
000758 D451 2048            12      JR  NZ,COPYE2
00075A D453 67               4      LD  H,A     ;A=0
00075B D454 6F               4      LD  L,A
00075C D455 2235EF          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
00075F D458 2237EF          16      LD  (FDRV+35),HL
       D45B                     COPY6:
000762 D45B CDE7D0          17      CALL    S27BUF
000765 D45E 47               4      LD  B,A
000766 D45F 3C               4      INC A
000767 D460 2831            12      JR  Z,COPYE
000769 D462 7C               4      LD  A,H
00076A D463 B5               4      OR  L
00076B D464 280C            12      JR  Z,COPY7
00076D D466 1114EF          10      LD  DE,FDRV
000770 D469 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
000772 D46B CDDED0          17      CALL    SYSTEM0
000775 D46E 2023            12      JR  NZ,COPYE
000777 D470 10E9            13      DJNZ    COPY6
       D472                     COPY7:
000779 D472 3AEDD4          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
00077C D475 3221EF          13      LD  (FDRV+13),A
00077F D478 21F4D4          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
000782 D47B 1128EF          10      LD  DE,FDRV+20
000785 D47E 010400          10      LD  BC,4
000788 D481 EDB0                    LDIR
                                
00078A D483 1114EF          10      LD  DE,FDRV
00078D D486 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
00078F D488 CDDED0          17      CALL    SYSTEM0
000792 D48B 2006            12      JR  NZ,COPYE
                                
000794 D48D 1171EF          10      LD  DE,OK
000797 D490 C30AD4          10      JP  COPY8
                                
       D493                     COPYE:
00079A D493 1114EF          10      LD  DE,FDRV
00079D D496 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
00079F D498 CD0500          17      CALL    SYSTEM
       D49B                     COPYE2:
0007A2 D49B 37               4      SCF
0007A3 D49C C9              10      RET
                                
       D49D                     C_TYPE:
0007A4 D49D CD8AD3          17      CALL    SETFCB
0007A7 D4A0 215C00          10      LD  HL,FCB1
0007AA D4A3 CDB0D0          17      CALL    OPEN
0007AD D4A6 37               4      SCF
       D4A7                     TYPE1:
0007AE D4A7 C0              11      RET NZ
0007AF D4A8 CDC3D0          17      CALL    DEFCB
0007B2 D4AB 3E06             7      LD  A,6
0007B4 D4AD CD1BD9          17      CALL    MSG_A
       D4B0                     TYPE2:
0007B7 D4B0 CDE7D0          17      CALL    S27BUF
0007BA D4B3 C6FE             7      ADD A,0FEH
0007BC D4B5 D8              11      RET C
0007BD D4B6 7C               4      LD  A,H
0007BE D4B7 B5               4      OR  L
0007BF D4B8 2813            12      JR  Z,TYPEE
0007C1 D4BA 010001          10      LD  BC,00100H
       D4BD                     TYPE3:
0007C4 D4BD 0A               7      LD  A,(BC)
0007C5 D4BE 03               6      INC BC
0007C6 D4BF FE1A             7      CP  01AH
0007C8 D4C1 280A            12      JR  Z,TYPEE
0007CA D4C3 CD1BD9          17      CALL    MSG_A
0007CD D4C6 2B               6      DEC HL
0007CE D4C7 7C               4      LD  A,H
0007CF D4C8 B5               4      OR  L
0007D0 D4C9 20F2            12      JR  NZ,TYPE3
0007D2 D4CB 18E3            12      JR  TYPE2
       D4CD                     TYPEE:
0007D4 D4CD CDBFD0          17      CALL    OPEN2
0007D7 D4D0 18D5            12      JR  TYPE1
                                
       D4D2                     CWILD:
0007D9 D4D2 215D00          10      LD  HL,FCB1+1
       D4D5                     CWILD1:
0007DC D4D5 7E               7      LD  A,(HL)
0007DD D4D6 FE20             7      CP  020H
0007DF D4D8 C0              11      RET NZ
       D4D9                     CWILD2:
0007E0 D4D9 3E3F             7      LD  A,'?'
0007E2 D4DB 060B             7      LD  B,11
0007E4 D4DD C3DDDE          10      JP  FILL_MEMORY
                                
       D4E0                     DTA_CCP:
0007E7 D4E0                         DS  37
                                
       0040                     PATHX   EQU 64
00080C D505                     PATHD:  DS  PATHX
00084C D545 00                  PATHE:  DB  0
                                
00084D D546 2062797465732066    FREE:   DB  " bytes free",9,'$'
            7265650924          
00085A D553 20202020203C4449    DIRMES: DB  "     <DIR>$"
            523E24              
000865 D55E 20203A24            DIRHD:  DB  "  :$"
                                
       D562                     COMTB:
000869 D562 44202020                DB  "D   "  ;1
00086D D566 E1D1                    DW  C_DIR
00086F D568 44495220                DB  "DIR "  ;2
000873 D56C E1D1                    DW  C_DIR
000875 D56E 434F5059                DB  "COPY"  ;3
000879 D572 C5D3                    DW  C_COPY
00087B D574 43442020                DB  "CD  "  ;4
00087F D578 E3D0                    DW  C_CD
000881 D57A 44454C20                DB  "DEL "  ;5
000885 D57E C4D1                    DW  C_DEL
000887 D580 50415448                DB  "PATH"  ;6
00088B D584 86D2                    DW  C_PATH
00088D D586 52454E20                DB  "REN "  ;7
000891 D58A CED1                    DW  C_REN
000893 D58C 54595045                DB  "TYPE"  ;8
000897 D590 9DD4                    DW  C_TYPE
000899 D592 52454D20                DB  "REM "  ;9
00089D D596 22D6                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "88DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   PC-8801mkIISR
                                
                                ;   BANK RAM DISK DRIVER
                                
       D598                     BDWT:
00089F D598 3E10             7      LD  A,010H  ;ライト可　リード不可
0008A1 D59A 1802            12  JR  BRW
                                
       D59C                     BDRD:
0008A3 D59C 3E01             7      LD  A,001H  ;ライト不可　リード可
       D59E                     BRW:
0008A5 D59E F3               4      DI
0008A6 D59F D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
0008A8 D5A1 ED73D7D5        20      LD  (BANKSP+1),SP
0008AC D5A5 3AD8D5          13      LD  A,(BANKSP+2)
0008AF D5A8 87               4      ADD A,A
0008B0 D5A9 3803            12      JR  C,BRW1
0008B2 D5AB 31C8ED          10      LD  SP,EXTSP
       D5AE                     BRW1:
0008B5 D5AE C5              11      PUSH    BC
0008B6 D5AF D5              11      PUSH    DE
0008B7 D5B0 EB               4      EX  DE,HL
0008B8 D5B1 29              11      ADD HL,HL
0008B9 D5B2 29              11      ADD HL,HL
0008BA D5B3 7C               4      LD  A,H
0008BB D5B4 E60F             7      AND 00FH        ;バンク
0008BD D5B6 D3E3            11      OUT (0E3H),A    ;拡張RAM バンク選択
0008BF D5B8 65               4      LD  H,L
0008C0 D5B9 CB3C             8      SRL H   ;/2
0008C2 D5BB 2E00             7      LD  L,0
0008C4 D5BD DBE2            11      IN  A,(0E2H)    ;拡張RAM リード/ライト制御
0008C6 D5BF 0F               4      RRCA
0008C7 D5C0 3001            12      JR  NC,BRW2
0008C9 D5C2 EB               4      EX  DE,HL
       D5C3                     BRW2:
0008CA D5C3 010002          10      LD  BC,512
0008CD D5C6 EDB0                    LDIR
                                
0008CF D5C8 DBE2            11      IN  A,(0E2H)    ;拡張RAM リード/ライト制御
0008D1 D5CA 0F               4      RRCA
0008D2 D5CB 3801            12      JR  C,BRW3
0008D4 D5CD EB               4      EX  DE,HL
       D5CE                     BRW3:
0008D5 D5CE D1              10      POP DE
0008D6 D5CF C1              10      POP BC
0008D7 D5D0 13               6      INC DE
0008D8 D5D1 10DB            13      DJNZ    BRW1
                                
0008DA D5D3 AF               4      XOR A
0008DB D5D4 D3E2            11      OUT (0E2H),A    ;メインメモリに切り替える
0008DD D5D6 310000          10  BANKSP: LD  SP,0
0008E0 D5D9 FB               4      EI
0008E1 D5DA C9              10      RET
                                
[EOF:88DISK2.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D5DB                     BDOS0:
0008E2 D5DB ED73EFD5        20      LD  (BDSP+1),SP
0008E6 D5DF F5              11      PUSH    AF
0008E7 D5E0 3AF0D5          13      LD  A,(BDSP+2)
0008EA D5E3 FEED             7      CP  EXTSP/256
0008EC D5E5 280B            12      JR  Z,BDOS1X
       D5E7                     BDOS2:
0008EE D5E7 F1              10      POP AF
0008EF D5E8 31C8ED          10      LD  SP,EXTSP
0008F2 D5EB CDF3D5          17      CALL    BDOS1
0008F5 D5EE 310000          10  BDSP:   LD  SP,0
0008F8 D5F1 C9              10      RET
       D5F2                     BDOS1X:
0008F9 D5F2 F1              10      POP AF
       D5F3                     BDOS1:
0008FA D5F3 E5              11      PUSH    HL
0008FB D5F4 79               4      LD  A,C
0008FC D5F5 FE3C             7      CP  03CH
0008FE D5F7 3802            12      JR  C,DOS1
000900 D5F9 3E3C             7      LD  A,03CH
       D5FB                     DOS1:
000902 D5FB 87               4      ADD A,A
000903 D5FC 6F               4      LD  L,A
000904 D5FD 26F0             7      LD  H,STABLE/256
000906 D5FF 7E               7      LD  A,(HL)
000907 D600 2C               4      INC L
000908 D601 66               7      LD  H,(HL)
000909 D602 6F               4      LD  L,A
00090A D603 E3              19      EX  (SP),HL
00090B D604 79               4      LD  A,C
00090C D605 C9              10      RET
       D606                     _DOS2:
00090D D606 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
00090F D608 CAD3D8          10      JP  Z,_SYS5A
000912 D60B FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000914 D60D CA8FD8          10      JP  Z,_SYS5C
000917 D610 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
000919 D612 CA4AEB          10      JP  Z,_SYS5F
00091C D615 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
00091E D617 200A            12      JR  NZ,_ERROR
000920 D619 011D01          10      LD  BC,011DH
000923 D61C 114701          10      LD  DE,VER
000926 D61F 210201          10      LD  HL,MACD
       D622                     C_REM:
000929 D622 AF               4      XOR A
       D623                     _ERROR:
00092A D623 A7               4      AND A
00092B D624 C9              10      RET
                                
       D625                     _SYS09:     ;文字列出力
00092C D625 D5              11      PUSH    DE
       D626                     _SX09:
00092D D626 1A               7      LD  A,(DE)
00092E D627 13               6      INC DE
00092F D628 FE24             7      CP  '$'
000931 D62A 2831            12      JR  Z,SX0E2
000933 D62C CD1BD9          17      CALL    MSG_A
000936 D62F 18F5            12      JR  _SX09
                                
       D631                     MSX1:
000938 D631 CD1BD9          17      CALL    MSG_A
       D634                     MSX:
00093B D634 7E               7      LD  A,(HL)
00093C D635 23               6      INC HL
00093D D636 B7               4      OR  A
00093E D637 20F8            12      JR  NZ,MSX1
000940 D639 C9              10      RET
                                
       D63A                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000941 D63A 212200          10      LD  HL,00022H
000944 D63D 7D               4      LD  A,L
000945 D63E C9              10      RET
                                
       D63F                     _SYS0D:     ;(BDOS)ディスクリセット
000946 D63F CDDFEF          17      CALL    _FFLUSH
000949 D642 E5              11      PUSH    HL
00094A D643 218000          10      LD  HL,00080H
00094D D646 228AEF          16      LD  (_DTA),HL
000950 D649 E1              10      POP HL
000951 D64A D5              11      PUSH    DE
000952 D64B 1E00             7      LD  E,0
000954 D64D 3E                      DB  03EH
                                
       D64E                     _SYS0E:     ;(BDOS)カレントドライブの設定
000955 D64E D5              11      PUSH    DE
000956 D64F 7B               4      LD  A,E
000957 D650 DDE5            15      PUSH    IX
000959 D652 CDDCEF          17      CALL    _GETDPB
00095C D655 DDE1            14      POP IX
00095E D657 3804            12      JR  C,SX0E2
000960 D659 7B               4      LD  A,E
000961 D65A 3287EF          13      LD  (_DVSW),A
       D65D                     SX0E2:
000964 D65D 3E08             7      LD  A,8
000966 D65F D1              10      POP DE
000967 D660 C9              10      RET
                                
       D661                     _SYS0F:     ;(BDOS)ファイルのオープン
000968 D661 CD1ADF          17      CALL    SETDRV
00096B D664 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00096E D667 C602             7      ADD A,002H      ;Write
000970 D669 2848            12      JR  Z,FEND0F
000972 D66B CD68E2          17      CALL    CHKWILDX
                                
000975 D66E D43ADF          17      CALL    NC,SOPENX
       D671                     _S16XX:
000978 D671 3840            12      JR  C,FEND0F
                                                ;Directory location
00097A D673 3A9FEF          13      LD  A,(_FILEN)
00097D D676 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
000980 D679 3AA0EF          13      LD  A,(_DIRF)
000983 D67C FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000986 D67F FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
000989 D682 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
00098C D685 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
000990 D689 FDE5            15      PUSH    IY
000992 D68B D1              10      POP DE
000993 D68C 13               6      INC DE
000994 D68D 010B00          10      LD  BC,11
000997 D690 EDB0                    LDIR
                                ;               Attribute
000999 D692 7E               7      LD  A,(HL)
00099A D693 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
00099D D696 110B00          10      LD  DE,11       ;Reserved
0009A0 D699 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
0009A1 D69A 11EAF0          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
0009A4 D69D 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D69F                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
0009A6 D69F 1A               7      LD  A,(DE)
0009A7 D6A0 13               6      INC DE
0009A8 D6A1 32A8D6          13      LD  (S16PAT+2),A
0009AB D6A4 7E               7      LD  A,(HL)
0009AC D6A5 23               6      INC HL
0009AD D6A6 FD7700          19  S16PAT: LD  (IY+0),A
0009B0 D6A9 10F4            13      DJNZ    S16LOOP
                                
0009B2 D6AB AF               4      XOR A
0009B3 D6AC FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
0009B6 D6AF FD2257D7        20      LD  (OFCB+1),IY
       D6B3                     FEND0F:
0009BA D6B3 1845            12      JR  FEND10
                                
       D6B5                     _SYS10:     ;(BDOS)ファイルのクローズ
0009BC D6B5 CD1ADF          17      CALL    SETDRV
0009BF D6B8 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0009C2 D6BB D6FE             7      SUB 0FEH
0009C4 D6BD 37               4      SCF
0009C5 D6BE 3F               4      CCF
0009C6 D6BF 2039            12      JR  NZ,FEND10
       D6C1                     _S10A:              ;Write
0009C8 D6C1 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
0009CB D6C4 FD770F          19      LD  (IY+15),A
                                
0009CE D6C7 FD341C          23      INC (IY+28)     ;0FEH->0FFH ;オープンモード
0009D1 D6CA CD60E3          17      CALL    SETTMS
                                
0009D4 D6CD FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
0009D7 D6D0 32A0EF          13      LD  (_DIRF),A
0009DA D6D3 E67F             7      AND 07FH
0009DC D6D5 327FE8          13      LD  (_SECPS+1),A
0009DF D6D8 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
0009E2 D6DB FD561F          19      LD  D,(IY+31)
0009E5 D6DE CD6EE0          17      CALL    READ_DIR
0009E8 D6E1 3817            12      JR  C,FEND10
                                
0009EA D6E3 3A98DF          13  SDECM1: LD  A,(SDECPAT+1)   ;1セクタ辺りのディレクトリエントリ数
0009ED D6E6 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
0009EE D6E7 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
0009F1 D6EA 6F               4      LD  L,A
0009F2 D6EB 2600             7      LD  H,0
0009F4 D6ED 29              11      ADD HL,HL       ;*2
0009F5 D6EE 29              11      ADD HL,HL       ;*4
0009F6 D6EF 29              11      ADD HL,HL       ;*8
0009F7 D6F0 29              11      ADD HL,HL       ;*16
0009F8 D6F1 29              11      ADD HL,HL       ;*32
0009F9 D6F2 ED4B7EF0        20      LD  BC,(_DTBUF)
0009FD D6F6 09              11      ADD HL,BC
                                
0009FE D6F7 CD78E2          17      CALL    SDIRENT
       D6FA                     FEND10:
000A01 D6FA 1842            12      JR  FEND
                                
       D6FC                     _SYS11:     ;(BDOS)最初のファイルの検索
000A03 D6FC CD1ADF          17      CALL    SETDRV
000A06 D6FF CD67DF          17      CALL    SOPEN
       D702                     _S12X1:
000A09 D702 383A            12      JR  C,FEND
000A0B D704 CD07E0          17      CALL    SOPENE2
000A0E D707 ED5B8AEF        20      LD  DE,(_DTA)
000A12 D70B 3A88EF          13      LD  A,(_DRV)
000A15 D70E 3C               4      INC A
000A16 D70F 12               7      LD  (DE),A
000A17 D710 D5              11      PUSH    DE
000A18 D711 13               6      INC DE
000A19 D712 012000          10      LD  BC,32
000A1C D715 EDB0                    LDIR
000A1E D717 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000A21 D71A FD660F          19      LD  H,(IY+15)
000A24 D71D 22F4F0          16      LD  (SCDIR),HL
000A27 D720 2A9AEF          16      LD  HL,(_FBPS)
000A2A D723 22F6F0          16      LD  (SFBPS),HL
000A2D D726 2A9FEF          16      LD  HL,(_FILEN)
000A30 D729 7C               4      LD  A,H
000A31 D72A B7               4      OR  A
000A32 D72B 2806            12      JR  Z,_S12DIR
000A34 D72D 3A7FE8          13      LD  A,(_SECPS+1)
000A37 D730 F680             7      OR  080H
000A39 D732 67               4      LD  H,A
       D733                     _S12DIR:
000A3A D733 22F8F0          16      LD  (SFNDF),HL  ;Directory position and Flags
000A3D D736 E1              10      POP HL
000A3E D737 1139EF          10      LD  DE,SFILE
000A41 D73A 0E21             7      LD  C,33
       D73C                     _S11B:
000A43 D73C EDB0                    LDIR
       D73E                     FEND:
000A45 D73E 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D73F                     FENDE:
000A46 D73F FDE1            14      POP IY
000A48 D741 C1              10      POP BC
000A49 D742 D1              10      POP DE
000A4A D743 E1              10      POP HL
000A4B D744 C9              10      RET
                                
       D745                     _SYS12:     ;(BDOS)次のファイルの検索
000A4C D745 E5              11      PUSH    HL
000A4D D746 D5              11      PUSH    DE
000A4E D747 C5              11      PUSH    BC
000A4F D748 FDE5            15      PUSH    IY
000A51 D74A CDCBDF          17      CALL    NOPEN
000A54 D74D 18B3            12      JR  _S12X1
                                
       D74F                     _S16K:
000A56 D74F FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000A59 D752 FEFD             7      CP  0FDH        ;Device(0FDH)
000A5B D754 37               4      SCF
000A5C D755 C8              11      RET Z
                                
000A5D D756 110000          10  OFCB:   LD  DE,0
000A60 D759 D5              11      PUSH    DE
000A61 D75A 061A             7      LD  B,26        ;First cluster
       D75C                     S16K1:
000A63 D75C 13               6      INC DE
000A64 D75D 23               6      INC HL
000A65 D75E 10FC            13      DJNZ    S16K1
                                
000A67 D760 1A               7      LD  A,(DE)
000A68 D761 BE               7      CP  (HL)
000A69 D762 2013            12      JR  NZ,S16K2
000A6B D764 13               6      INC DE
000A6C D765 23               6      INC HL
000A6D D766 1A               7      LD  A,(DE)
000A6E D767 BE               7      CP  (HL)
000A6F D768 200D            12      JR  NZ,S16K2
                                
000A71 D76A E1              10      POP HL
000A72 D76B FDE5            15      PUSH    IY
000A74 D76D D1              10      POP DE
000A75 D76E 1A               7      LD  A,(DE)      ;Drive
000A76 D76F BE               7      CP  (HL)
000A77 D770 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000A79 D772 ED52            15      SBC HL,DE       ;CP HL,DE
000A7B D774 37               4      SCF
000A7C D775 C0              11      RET NZ
000A7D D776 E5              11      PUSH    HL
       D777                     S16K2:
000A7E D777 E1              10      POP HL
       D778                     S16K3:
000A7F D778 FDE5            15      PUSH    IY
000A81 D77A D1              10      POP DE
       D77B                     _SYS13:     ;(BDOS)ファイルの削除
000A82 D77B CD1ADF          17      CALL    SETDRV
000A85 D77E CD98E1          17      CALL    KILL
       D781                     FEND13:
000A88 D781 18BB            12      JR  FEND
                                
       D783                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000A8A D783 CD1ADF          17      CALL    SETDRV
000A8D D786 CD92E3          17      CALL    PUSHRR
000A90 D789 CDD5E3          17      CALL    GETSEQ
                                
000A93 D78C CDEAE3          17      CALL    RB_READ
000A96 D78F E5              11      PUSH    HL
000A97 D790 CDA6E3          17      CALL    SETSEQ
       D793                     SREAD:
000A9A D793 E1              10      POP HL
                                
000A9B D794 C601             7      ADD A,001H
000A9D D796 38A6            12      JR  C,FEND
                                
000A9F D798 7D               4      LD  A,L
000AA0 D799 D601             7      SUB 001H
       D79B                     FENDX:
000AA2 D79B 9F               4      SBC A,A
000AA3 D79C E603             7      AND 3
000AA5 D79E 1F               4      RRA
000AA6 D79F 189E            12      JR  FENDE
                                
       D7A1                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000AA8 D7A1 CD1ADF          17      CALL    SETDRV
000AAB D7A4 CD92E3          17      CALL    PUSHRR
000AAE D7A7 CDD5E3          17      CALL    GETSEQ
                                
000AB1 D7AA CDE3E3          17      CALL    RB_WRITE
000AB4 D7AD E5              11      PUSH    HL
000AB5 D7AE CDA6E3          17      CALL    SETSEQ
       D7B1                     SWRITE:
000AB8 D7B1 E1              10      POP HL
                                
000AB9 D7B2 C6FF             7      ADD A,0FFH
000ABB D7B4 18E5            12      JR  FENDX
                                
       D7B6                     _SYS17:     ;(BDOS)ファイル名の変更
000ABD D7B6 CD1ADF          17      CALL    SETDRV
000AC0 D7B9 CDEEE1          17      CALL    NAME
000AC3 D7BC 18C3            12      JR  FEND13
                                
       D7BE                     _SYS16:     ;(BDOS)ファイルの作成
000AC5 D7BE CD1ADF          17      CALL    SETDRV
                                
000AC8 D7C1 CD68E2          17      CALL    CHKWILDX
000ACB D7C4 38BB            12      JR  C,FEND13
000ACD D7C6 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000AD0 D7C9 FE05             7      CP  5
000AD2 D7CB 2805            12      JR  Z,_S16X2
000AD4 D7CD FE21             7      CP  021H
000AD6 D7CF DA81D7          10      JP  C,FEND13
       D7D2                     _S16X2:
                                ;               Clear FCB
000AD9 D7D2 FDE5            15      PUSH    IY
000ADB D7D4 E1              10      POP HL
000ADC D7D5 011000          10      LD  BC,16
000ADF D7D8 09              11      ADD HL,BC
       D7D9                     _S16X1:
000AE0 D7D9 70               7      LD  (HL),B      ;B=0
000AE1 D7DA 23               6      INC HL
000AE2 D7DB 0D               4      DEC C
000AE3 D7DC 20FB            12      JR  NZ,_S16X1
                                
000AE5 D7DE CD65E3          17      CALL    SETTMSX
000AE8 D7E1 FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000AEC D7E5 CD3ADF          17      CALL    SOPENX
000AEF D7E8 3F               4      CCF
000AF0 D7E9 CC4FD7          17      CALL    Z,_S16K
000AF3 D7EC D418E0          17      CALL    NC,COPEN
000AF6 D7EF D478E2          17      CALL    NC,SDIRENT
000AF9 D7F2 C371D6          10      JP  _S16XX
                                
       D7F5                     _SYS21:     ;(BDOS)ランダムな読み出し
                                
000AFC D7F5 CD1ADF          17      CALL    SETDRV
000AFF D7F8 CD92E3          17      CALL    PUSHRR
000B02 D7FB CD6BE6          17      CALL    GET_RR_AHL
                                
000B05 D7FE CDEAE3          17      CALL    RB_READ
000B08 D801 E5              11      PUSH    HL
000B09 D802 CDC1E3          17      CALL    POPRR
000B0C D805 188C            12      JR  SREAD
                                
       D807                     _SYS22:     ;(BDOS)ランダムな書き込み
       D807                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000B0E D807 CD1ADF          17      CALL    SETDRV
000B11 D80A CD92E3          17      CALL    PUSHRR
000B14 D80D CD6BE6          17      CALL    GET_RR_AHL
                                
000B17 D810 CDE3E3          17      CALL    RB_WRITE
000B1A D813 E5              11      PUSH    HL
000B1B D814 CDC1E3          17      CALL    POPRR
000B1E D817 1898            12      JR  SWRITE
                                
       D819                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000B20 D819 21FF00          10      LD  HL,000FFH
000B23 D81C AF               4      XOR A
000B24 D81D C9              10      RET
                                
       D81E                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000B25 D81E 3A87EF          13      LD  A,(_DVSW)
000B28 D821 A7               4      AND A
000B29 D822 C9              10      RET
                                
       D823                     _SYS1A:     ;(BDOS)DTAの設定
000B2A D823 ED538AEF        20      LD  (_DTA),DE
000B2E D827 AF               4      XOR A
000B2F D828 C9              10      RET
                                
       D829                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000B30 D829 7B               4      LD  A,E
000B31 D82A CD2DDF          17      CALL    GETDRV
000B34 D82D CDDCEF          17      CALL    _GETDPB
000B37 D830 D4E2EF          17      CALL    NC,_RDFATX
000B3A D833 210000          10      LD  HL,0
000B3D D836 D43EE3          17      CALL    NC,DSKF
                                
000B40 D839 ED5B3FE3        20      LD  DE,(MAXCLP+1)   ;DPB_08_MAXCL-1
000B44 D83D 1B               6      DEC DE      ;DE←クラスタの総数
000B45 D83E FD2A7CF0        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000B49 D842 9F               4      SBC A,A
000B4A D843 D8              11      RET C
000B4B D844 4F               4      LD  C,A     ;C=0
000B4C D845 DD7E0F          19      LD  A,(IX+00FH) ;DPB_0F_BPS
000B4F D848 E60F             7      AND 00FH
000B51 D84A 47               4      LD  B,A
000B52 D84B DD7E07          19      LD  A,(IX+7)    ;DPB_07_SECPCL
000B55 D84E C9              10      RET
                                
       D84F                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000B56 D84F AF               4      XOR A
000B57 D850 67               4      LD  H,A
000B58 D851 6F               4      LD  L,A
000B59 D852 C9              10      RET
                                
       D853                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000B5A D853 2100F1          10      LD  HL,DEVICE
000B5D D856 7B               4      LD  A,E
000B5E D857 C3DCEF          10      JP  _GETDPB
                                
       D85A                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000B61 D85A E5              11      PUSH    HL
000B62 D85B 2A1EF0          16      LD  HL,(STABLE+2*00FH)  ;ファイルのオープン
000B65 D85E CD0F00          17      CALL    JP_HL
000B68 D861 3821            12      JR  C,_S23X1
                                
000B6A D863 D5              11      PUSH    DE      ;EX DE,IY
000B6B D864 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000B6D D866 FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000B70 D869 FD6E11          19      LD  L,(IY+17)   ;
000B73 D86C FD6612          19      LD  H,(IY+18)   ;
000B76 D86F C5              11      PUSH    BC      ;
000B77 D870 FD4613          19      LD  B,(IY+19)   ;
000B7A D873 CDC7E3          17      CALL    GET_CPM_R_SIZE
000B7D D876 C1              10      POP BC
       D877                     _S24X1:
000B7E D877 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
000B81 D87A FD7422          19      LD  (IY+34),H
000B84 D87D FD7723          19      LD  (IY+35),A
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000B87 D880 FDE3            23      EX  (SP),IY     ;
000B89 D882 D1              10      POP DE      ;
                                
000B8A D883 AF               4      XOR A
       D884                     _S23X1:
000B8B D884 E1              10      POP HL
000B8C D885 C9              10      RET
                                
       D886                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000B8D D886 E5              11      PUSH    HL
000B8E D887 D5              11      PUSH    DE      ;EX DE,IY
000B8F D888 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000B91 D88A CDD5E3          17      CALL    GETSEQ
000B94 D88D 18E8            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D88F                     _SYS5C:     ;(BDOS)ファイル名の解析
000B96 D88F C5              11      PUSH    BC
000B97 D890 E5              11      PUSH    HL
000B98 D891 CD31DE          17      CALL    FILE
000B9B D894 E1              10      POP HL
000B9C D895 C1              10      POP BC
       D896                     S29X1:
000B9D D896 C5              11      PUSH    BC
000B9E D897 D5              11      PUSH    DE
000B9F D898 E5              11      PUSH    HL
000BA0 D899 EB               4      EX  DE,HL
000BA1 D89A 2114EF          10      LD  HL,FDRV
000BA4 D89D 010D00          10      LD  BC,13
000BA7 D8A0 EDB0                    LDIR
000BA9 D8A2 70               7      LD  (HL),B      ;B=0
000BAA D8A3 0E03             7      LD  C,3
000BAC D8A5 EDB0                    LDIR
000BAE D8A7 E1              10      POP HL
000BAF D8A8 D1              10      POP DE
000BB0 D8A9 C1              10      POP BC
000BB1 D8AA AF               4      XOR A
000BB2 D8AB C9              10      RET
                                
       D8AC                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000BB3 D8AC C5              11      PUSH    BC
000BB4 D8AD 01EDE9          10      LD  BC,DWT24B
000BB7 D8B0 1804            12      JR  S2FX
       D8B2                     _SYS2F:
000BB9 D8B2 C5              11      PUSH    BC
000BBA D8B3 01DDE9          10      LD  BC,DRD24B
       D8B6                     S2FX:
000BBD D8B6 ED43CCD8        20      LD  (S2FPAT+1),BC
000BC1 D8BA CDDFEF          17      CALL    _FFLUSH
                                
000BC4 D8BD D5              11      PUSH    DE
000BC5 D8BE E5              11      PUSH    HL
000BC6 D8BF 7D               4      LD  A,L     ;Drive
000BC7 D8C0 CDD9EF          17      CALL    _CHGDRV
000BCA D8C3 3809            12      JR  C,S30X2
000BCC D8C5 44               4      LD  B,H     ;Number of clusters
000BCD D8C6 2A8AEF          16      LD  HL,(_DTA)
                                
000BD0 D8C9 0E00             7      LD  C,0
000BD2 D8CB CDDDE9          17  S2FPAT: CALL    DRD24B
       D8CE                     S30X2:
000BD5 D8CE E1              10      POP HL
000BD6 D8CF D1              10      POP DE
000BD7 D8D0 C1              10      POP BC
000BD8 D8D1 9F               4      SBC A,A
000BD9 D8D2 C9              10      RET
                                
       D8D3                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000BDA D8D3 C5              11      PUSH    BC
000BDB D8D4 D5              11      PUSH    DE
000BDC D8D5 E5              11      PUSH    HL
000BDD D8D6 CD26DE          17      CALL    FILEC
000BE0 D8D9 210000          10      LD  HL,0
000BE3 D8DC 1114EF          10      LD  DE,FDRV
000BE6 D8DF 2A4EF0          16      LD  HL,(STABLE+2*027H)  ;ランダムブロック読み込み
000BE9 D8E2 CD0F00          17      CALL    JP_HL
000BEC D8E5 18E7            12      JR  S30X2
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "88IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   PC-8801mkIISR
                                
       D623                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D623                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D623                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D623                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D623                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D623                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       D8E7                     BDOS_RF:
000BEE D8E7 DB32            11      IN  A,(032H)
000BF0 D8E9 F610             7      OR  010H        ;高速RAMアクセスモードOFF
000BF2 D8EB D332            11      OUT (032H),A
000BF4 D8ED C3DBD5          10      JP  BDOS0
                                
       D8F0                     KEYSET:
       D8F0                     KEYBS:
000BF7 D8F0 B7               4      OR  A
000BF8 D8F1 C8              11      RET Z
       D8F2                     KEYBS1:
000BF9 D8F2 CD08D9          17      CALL    KEYBC_IFBREAK
000BFC D8F5 E5              11      PUSH    HL
000BFD D8F6 F5              11      PUSH    AF
000BFE D8F7 2A90EF          16      LD  HL,(_KEYPS)
000C01 D8FA 2C               4      INC L
000C02 D8FB 7D               4      LD  A,L
000C03 D8FC BC               4      CP  H
000C04 D8FD 2815            12      JR  Z,POP_AF_HL_SCF_RET
000C06 D8FF 3290EF          13      LD  (_KEYPS),A
000C09 D902 26FE             7      LD  H,KEYBF/256
000C0B D904 F1              10      POP AF
000C0C D905 77               7      LD  (HL),A
000C0D D906 E1              10      POP HL
000C0E D907 C9              10      RET
       D908                     KEYBC_IFBREAK:
000C0F D908 FE03             7      CP  3
000C11 D90A C0              11      RET NZ
       D90B                     KEYBC:
000C12 D90B E5              11      PUSH    HL
000C13 D90C 210000          10      LD  HL,0
000C16 D90F 2290EF          16      LD  (_KEYPS),HL
000C19 D912 E1              10      POP HL
000C1A D913 C9              10      RET
                                
       D914                     POP_AF_HL_SCF_RET:
000C1B D914 F1              10      POP AF
000C1C D915 E1              10      POP HL
000C1D D916 37               4      SCF
000C1E D917 C9              10      RET
                                
       D918                     _SYS01:     ;(BDOS)コンソール入力
000C1F D918 CD09EF          17      CALL    _SYS07
       D91B                     MSG_A:
000C22 D91B F5              11      PUSH    AF
000C23 D91C D5              11      PUSH    DE
000C24 D91D 5F               4      LD  E,A
000C25 D91E CD24D9          17      CALL    _SYS02
000C28 D921 D1              10      POP DE
000C29 D922 F1              10      POP AF
000C2A D923 C9              10      RET
                                
       D924                     _SYS02:     ;(BDOS)コンソール出力
000C2B D924 CD36D9          17      CALL    BREAK
000C2E D927 1805            12      JR  PRINTX
                                
       D929                     _SYS06:     ;(BDOS)コンソール直接入出力
000C30 D929 7B               4      LD  A,E
000C31 D92A 3C               4      INC A
000C32 D92B CACAEF          10      JP  Z,_INKEY
       D92E                     PRINTX:
000C35 D92E C3CDEF          10      JP  _PRINT
                                
       D931                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000C38 D931 CD09EF          17      CALL    _SYS07
000C3B D934 1803            12      JR  BREAK1
       D936                     BREAK:
000C3D D936 CD4FDD          17      CALL    CHKEY
       D939                     BREAK1:
000C40 D939 FE03             7      CP  3       ;CTRL+C
000C42 D93B CA00EF          10      JP  Z,CPM_BOOT
000C45 D93E FE13             7      CP  013H        ;CTRL+S
000C47 D940 C0              11      RET NZ
                                
       D941                     PAUSE:
000C48 D941 CD0BD9          17      CALL    KEYBC
                                
       D944                     FLGET:
000C4B D944 CDDFEF          17      CALL    _FFLUSH
000C4E D947 E5              11      PUSH    HL
000C4F D948 2A8EEF          16      LD  HL,(_TXADR)
000C52 D94B CDEADB          17      CALL    CURSOR_ON
       D94E                     FLGET1:
000C55 D94E CDCAEF          17      CALL    _INKEY
000C58 D951 28FB            12      JR  Z,FLGET1
000C5A D953 CDD9DB          17      CALL    CURSOR_OFF
000C5D D956 E1              10      POP HL
000C5E D957 C9              10      RET
                                
       D958                     _SYS0A:     ;(BDOS)文字列入力
000C5F D958 C5              11      PUSH    BC
000C60 D959 E5              11      PUSH    HL
000C61 D95A D5              11      PUSH    DE
000C62 D95B CDA9DC          17      CALL    GETL
000C65 D95E 1100FF          10      LD  DE,KBUF
000C68 D961 E1              10      POP HL
000C69 D962 E5              11      PUSH    HL
000C6A D963 0E00             7      LD  C,0
000C6C D965 3004            12      JR  NC,SAX0
000C6E D967 23               6      INC HL
000C6F D968 23               6      INC HL
000C70 D969 1808            12      JR  SAX4
       D96B                     SAX0:
000C72 D96B 46               7      LD  B,(HL)
000C73 D96C 23               6      INC HL
       D96D                     SAX1:
000C74 D96D 23               6      INC HL
000C75 D96E 1A               7      LD  A,(DE)
000C76 D96F 13               6      INC DE
000C77 D970 B7               4      OR  A
000C78 D971 2004            12      JR  NZ,SAX2
       D973                     SAX4:
000C7A D973 360D            10      LD  (HL),00DH
000C7C D975 1804            12      JR  SAX3
       D977                     SAX2:
000C7E D977 77               7      LD  (HL),A
000C7F D978 0C               4      INC C
000C80 D979 10F2            13      DJNZ    SAX1
       D97B                     SAX3:
000C82 D97B D1              10      POP DE
000C83 D97C 79               4      LD  A,C
000C84 D97D 13               6      INC DE
000C85 D97E 12               7      LD  (DE),A
000C86 D97F 1B               6      DEC DE
000C87 D980 E1              10      POP HL
000C88 D981 C1              10      POP BC
000C89 D982 A7               4      AND A
000C8A D983 C9              10      RET
                                
       D984                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000C8B D984 CD36D9          17      CALL    BREAK
000C8E D987 3A92EF          13      LD  A,(_KEYD)
000C91 D98A B7               4      OR  A
000C92 D98B C8              11      RET Z
       D98C                     CONSTX:
000C93 D98C CDDFEF          17      CALL    _FFLUSH
000C96 D98F E5              11      PUSH    HL
000C97 D990 2A90EF          16      LD  HL,(_KEYPS)
000C9A D993 7C               4      LD  A,H
000C9B D994 AD               4      XOR L
000C9C D995 E1              10      POP HL
000C9D D996 CC4FDD          17      CALL    Z,CHKEY
000CA0 D999 C6FF             7      ADD A,0FFH
000CA2 D99B 9F               4      SBC A,A
000CA3 D99C C9              10      RET
                                
       D99D                     _SYS2A:     ;(BDOS)日付の獲得
000CA4 D99D C5              11      PUSH    BC
000CA5 D99E CDDDD9          17      CALL    RTCREAD
000CA8 D9A1 3A62EF          13      LD  A,(RTC_YY)
000CAB D9A4 CD40DA          17      CALL    BCD
000CAE D9A7 6F               4      LD  L,A
000CAF D9A8 2600             7      LD  H,0
                                ;   LD  DE,1900     ;0076CH
                                ;   CP  90      ;90以上は1900年代 1990-1999
                                ;   JR  NC,RDDATE1  ;90未満は2000年代 2000-2089
                                ;   LD  E,0D0H      ;2000 & 0FFH D=007H
000CB1 D9AA 11D007          10      LD  DE,2000     ;すべて2000年代で処理 2000-2099
       D9AD                     RDDATE1:
000CB4 D9AD 19              11      ADD HL,DE
000CB5 D9AE 3A63EF          13      LD  A,(RTC_MW)
000CB8 D9B1 57               4      LD  D,A
000CB9 D9B2 3A64EF          13      LD  A,(RTC_DD)
000CBC D9B5 CD40DA          17      CALL    BCD
000CBF D9B8 5F               4      LD  E,A
000CC0 D9B9 7A               4      LD  A,D
000CC1 D9BA 0604             7      LD  B,4
       D9BC                     RDDATE2:
000CC3 D9BC CB3A             8      SRL D
000CC5 D9BE 10FC            13      DJNZ    RDDATE2
000CC7 D9C0 C1              10      POP BC
000CC8 D9C1 E607             7      AND 7
000CCA D9C3 C9              10      RET
                                
       D9C4                     _SYS2C:     ;(BDOS)時刻の獲得
000CCB D9C4 C5              11      PUSH    BC
000CCC D9C5 CDDDD9          17      CALL    RTCREAD
000CCF D9C8 3A65EF          13      LD  A,(RTC_TT)
000CD2 D9CB CD40DA          17      CALL    BCD
000CD5 D9CE 67               4      LD  H,A
000CD6 D9CF 3A66EF          13      LD  A,(RTC_MM)
000CD9 D9D2 CD40DA          17      CALL    BCD
000CDC D9D5 6F               4      LD  L,A
000CDD D9D6 3A67EF          13      LD  A,(RTC_SS)
000CE0 D9D9 57               4      LD  D,A
000CE1 D9DA C1              10      POP BC
000CE2 D9DB AF               4      XOR A
000CE3 D9DC C9              10      RET
                                
       D9DD                     RTCREAD:
000CE4 D9DD 0EF9             7      LD  C,0F9H
000CE6 D9DF 3AB9EF          13      LD  A,(WK40)
000CE9 D9E2 5F               4      LD  E,A
000CEA D9E3 3E03             7      LD  A,3     ;コマンド３：タイムリードにセット
000CEC D9E5 CD0FDA          17      CALL    RTCCMD
000CEF D9E8 3E01             7      LD  A,1     ;コマンド１：レジスタシフトにセット
000CF1 D9EA CD0FDA          17      CALL    RTCCMD
000CF4 D9ED 0606             7      LD  B,6
000CF6 D9EF 2167EF          10      LD  HL,RTC_SS
       D9F2                     RTCREAD1:
000CF9 D9F2 C5              11      PUSH    BC
000CFA D9F3 0608             7      LD  B,8
       D9F5                     RTCREAD2:
000CFC D9F5 DB40            11      IN  A,(40H)     ;システムモードセンス BIT4:CDI
000CFE D9F7 87               4      ADD A,A
000CFF D9F8 87               4      ADD A,A
000D00 D9F9 87               4      ADD A,A
000D01 D9FA 87               4      ADD A,A
000D02 D9FB CB1E            15      RR  (HL)
000D04 D9FD CD34DA          17      CALL    RTCCLK
000D07 DA00 10F3            13      DJNZ    RTCREAD2
000D09 DA02 C1              10      POP BC
000D0A DA03 2B               6      DEC HL
000D0B DA04 10EC            13      DJNZ    RTCREAD1
000D0D DA06 AF               4      XOR A
000D0E DA07 CD0FDA          17      CALL    RTCCMD
000D11 DA0A 7B               4      LD  A,E
000D12 DA0B 32B9EF          13      LD  (WK40),A
000D15 DA0E C9              10      RET
                                
       DA0F                     RTCCMD:
000D16 DA0F 0604             7      LD  B,4
000D18 DA11 07               4      RLCA
000D19 DA12 07               4      RLCA
000D1A DA13 07               4      RLCA
       DA14                     RTCCMD1:
000D1B DA14 F5              11      PUSH    AF
000D1C DA15 F607             7      OR  7
000D1E DA17 D310            11      OUT (10H),A     ;プリンタデータ出力 兼 カレンダクロック(μPD1990AC)出力
000D20 DA19 CD34DA          17      CALL    RTCCLK
000D23 DA1C F1              10      POP AF
000D24 DA1D 0F               4      RRCA
000D25 DA1E 10F4            13      DJNZ    RTCCMD1
000D27 DA20 3E07             7      LD  A,7
000D29 DA22 D310            11      OUT (10H),A     ;プリンタデータ出力 兼 カレンダクロック(μPD1990AC)出力
000D2B DA24 7B               4      LD  A,E
000D2C DA25 A1               4      AND C
000D2D DA26 F602             7      OR  2
000D2F DA28 D340            11      OUT (40H),A     ;ストローブポート
000D31 DA2A A1               4      AND C
000D32 DA2B 00               4      NOP
000D33 DA2C D340            11      OUT (40H),A     ;ストローブポート
000D35 DA2E 5F               4      LD  E,A
000D36 DA2F 060D             7      LD  B,13
       DA31                     RTCCMD3:
000D38 DA31 10FE            13      DJNZ    RTCCMD3
000D3A DA33 C9              10      RET
                                
       DA34                     RTCCLK:
000D3B DA34 7B               4      LD  A,E
000D3C DA35 A1               4      AND C
000D3D DA36 F604             7      OR  04H
000D3F DA38 D340            11      OUT (40H),A
000D41 DA3A A1               4      AND C
000D42 DA3B 00               4      NOP
000D43 DA3C D340            11      OUT (40H),A
000D45 DA3E 5F               4      LD  E,A
000D46 DA3F C9              10      RET
                                
                                ;------------------------
                                ;BCDの10進数化
                                ;in
                                ;   A  : BCD
                                ;out
                                ;   A  : 10進数
                                ;------------------------
       DA40                     BCD:
000D47 DA40 4F               4      LD  C,A
000D48 DA41 E6F0             7      AND 0F0H    ;10の位
000D4A DA43 0F               4      RRCA
000D4B DA44 47               4      LD  B,A
000D4C DA45 0F               4      RRCA
000D4D DA46 0F               4      RRCA
000D4E DA47 80               4      ADD A,B
000D4F DA48 47               4      LD  B,A
000D50 DA49 79               4      LD  A,C
000D51 DA4A E60F             7      AND 00FH    ;1の位
000D53 DA4C 80               4      ADD A,B
000D54 DA4D C9              10      RET
                                
       DA4E                     ESC1:
000D55 DA4E 7B               4      LD  A,E
000D56 DA4F FE41             7      CP  'A'
000D58 DA51 CA33DB          10      JP  Z,CTRL1E
000D5B DA54 FE42             7      CP  'B'
000D5D DA56 CA53DC          10      JP  Z,CTRL1F
000D60 DA59 FE43             7      CP  'C'
000D62 DA5B CAF9DA          10      JP  Z,CTRL1C
000D65 DA5E FE44             7      CP  'D'
000D67 DA60 CA1EDB          10      JP  Z,CTRL1D
000D6A DA63 FE45             7      CP  'E'
000D6C DA65 2802            12      JR  Z,CT0CX
000D6E DA67 FE6A             7      CP  'j'
       DA69                     CT0CX:
000D70 DA69 CA20DC          10      JP  Z,CTRL0C
000D73 DA6C FE48             7      CP  'H'
000D75 DA6E CA9EDB          10      JP  Z,CTRL0B
000D78 DA71 FE4A             7      CP  'J'
000D7A DA73 CA23DC          10      JP  Z,CTRL06
000D7D DA76 FE4B             7      CP  'K'
000D7F DA78 CA72DB          10      JP  Z,CTRL05
000D82 DA7B FE4C             7      CP  'L'
000D84 DA7D CA5ADC          10      JP  Z,CTRL0E
000D87 DA80 FE54             7      CP  'T'
000D89 DA82 CA72DB          10      JP  Z,CTRL05
000D8C DA85 FE78             7      CP  'x'
000D8E DA87 2804            12      JR  Z,ESC1X
000D90 DA89 FE79             7      CP  'y'
000D92 DA8B 2002            12      JR  NZ,ESC1Y
       DA8D                     ESC1X:
000D94 DA8D 3601            10      LD  (HL),1
       DA8F                     ESC1Y:
000D96 DA8F FE3D             7      CP  '='
000D98 DA91 2804            12      JR  Z,ESC1W
000D9A DA93 FE59             7      CP  'Y'
000D9C DA95 2002            12      JR  NZ,ESC1Z
       DA97                     ESC1W:
000D9E DA97 3602            10      LD  (HL),2
       DA99                     ESC1Z:
000DA0 DA99 FE20             7      CP  020H
000DA2 DA9B 3802            12      JR  C,ESC1C
000DA4 DA9D 87               4      ADD A,A
000DA5 DA9E D0              11      RET NC
       DA9F                     ESC1C:
000DA6 DA9F E1              10      POP HL
000DA7 DAA0 1832            12      JR  ANK
                                
       DAA2                     ESC:
000DA9 DAA2 21E5DA          10      LD  HL,PRINTE5
000DAC DAA5 E5              11      PUSH    HL
000DAD DAA6 21C8DA          10      LD  HL,ESCFLG
000DB0 DAA9 3600            10      LD  (HL),0
000DB2 DAAB 3D               4      DEC A
000DB3 DAAC 28A0            12      JR  Z,ESC1
000DB5 DAAE 3D               4      DEC A
000DB6 DAAF 2009            12      JR  NZ,ESC2
000DB8 DAB1 3603            10      LD  (HL),3
000DBA DAB3 7B               4      LD  A,E
000DBB DAB4 D620             7      SUB 020H
000DBD DAB6 32BDDA          13      LD  (ESCYP+1),A
000DC0 DAB9 C9              10      RET
       DABA                     ESC2:
000DC1 DABA 3D               4      DEC A
000DC2 DABB C0              11      RET NZ
000DC3 DABC 2600             7  ESCYP:  LD  H,0
000DC5 DABE 7B               4      LD  A,E
000DC6 DABF D620             7      SUB 020H
000DC8 DAC1 6F               4      LD  L,A
000DC9 DAC2 C3D6EF          10      JP  _LOC
                                
       DAC5                     PRINT:
000DCC DAC5 C5              11      PUSH    BC
000DCD DAC6 E5              11      PUSH    HL
       DAC8                     ESCFLG  EQU $+1
000DCE DAC7 3E00             7      LD  A,000H      ;自己書き換え
000DD0 DAC9 B7               4      OR  A
000DD1 DACA 20D6            12      JR  NZ,ESC
                                
000DD3 DACC 3E1F             7      LD  A,01FH
000DD5 DACE BB               4      CP  E
000DD6 DACF 3018            12      JR  NC,CTRL
       DAD1                     INSFLG  EQU $
000DD8 DAD1 0102DC          10      LD  BC,INSERT   ;自己書き換え
       DAD4                     ANK:
000DDB DAD4 CDABDB          17      CALL    LOC0
000DDE DAD7 DB32            11      IN  A,(032H)
000DE0 DAD9 F5              11      PUSH    AF
000DE1 DADA CBA7             8      RES 4,A     ;高速RAMアクセスモード
000DE3 DADC D332            11      OUT (032H),A
000DE5 DADE 73               7      LD  (HL),E
000DE6 DADF F1              10      POP AF
000DE7 DAE0 D332            11      OUT (032H),A
000DE9 DAE2 CDF9DA          17      CALL    CTRL1C
       DAE5                     PRINTE5:
000DEC DAE5 E1              10      POP HL
000DED DAE6 C1              10      POP BC
000DEE DAE7 AF               4      XOR A
000DEF DAE8 C9              10      RET
                                
       DAE9                     CTRL:
000DF0 DAE9 7B               4      LD  A,E
000DF1 DAEA 87               4      ADD A,A
000DF2 DAEB F680             7      OR  080H
000DF4 DAED 6F               4      LD  L,A
000DF5 DAEE 26F0             7      LD  H,CTRLTB/256
000DF7 DAF0 7E               7      LD  A,(HL)
000DF8 DAF1 2C               4      INC L
000DF9 DAF2 66               7      LD  H,(HL)
000DFA DAF3 6F               4      LD  L,A
000DFB DAF4 CD0F00          17      CALL    JP_HL
000DFE DAF7 18EC            12      JR  PRINTE5
                                
       DAF9                     CTRL1C:
000E00 DAF9 2A8EEF          16      LD  HL,(_TXADR)
000E03 DAFC 2C               4      INC L
       DAFD                     PRINTE3:
000E04 DAFD 3AB1EF          13      LD  A,(_WIDTH)
000E07 DB00 3D               4      DEC A
000E08 DB01 BD               4      CP  L
000E09 DB02 3009            12      JR  NC,SET_TXADR_HL
000E0B DB04 2E00             7      LD  L,0
000E0D DB06 24               4      INC H
       DB07                     PRINTE8:
000E0E DB07 3A97EF          13      LD  A,(_LINE)
000E11 DB0A BC               4      CP  H
000E12 DB0B 2804            12      JR  Z,PRINT2
       DB0D                     LOC:
       DB0D                     SET_TXADR_HL:
000E14 DB0D 228EEF          16      LD  (_TXADR),HL
       DB10                     CTRL00:
000E17 DB10 C9              10      RET
                                
       DB11                     PRINT2:
000E18 DB11 CD60DC          17      CALL    SCR
000E1B DB14 25               4      DEC H
000E1C DB15 18F6            12      JR  SET_TXADR_HL
                                
       DB17                     CTRL08:
000E1E DB17 3AD1DA          13      LD  A,(INSFLG)
000E21 DB1A FECD             7      CP  0CDH        ;CALL ????
000E23 DB1C 2829            12      JR  Z,CTRL02
       DB1E                     CTRL1D:
000E25 DB1E 2A8EEF          16      LD  HL,(_TXADR)
000E28 DB21 7C               4      LD  A,H
000E29 DB22 B5               4      OR  L
000E2A DB23 C8              11      RET Z
000E2B DB24 7D               4      LD  A,L
000E2C DB25 B7               4      OR  A
000E2D DB26 2803            12      JR  Z,CTRL1DX1
000E2F DB28 2D               4      DEC L
000E30 DB29 18E2            12      JR  SET_TXADR_HL
       DB2B                     CTRL1DX1:
000E32 DB2B 3AB1EF          13      LD  A,(_WIDTH)
000E35 DB2E 3D               4      DEC A
000E36 DB2F 6F               4      LD  L,A
000E37 DB30 25               4      DEC H
000E38 DB31 18DA            12      JR  SET_TXADR_HL
       DB33                     CTRL1E:
000E3A DB33 2A8EEF          16      LD  HL,(_TXADR)
000E3D DB36 7C               4      LD  A,H
000E3E DB37 B7               4      OR  A
000E3F DB38 C8              11      RET Z
000E40 DB39 25               4      DEC H
000E41 DB3A 18D1            12      JR  SET_TXADR_HL
                                
       DB3C                     CTRL09:
000E43 DB3C 2A8EEF          16      LD  HL,(_TXADR)
000E46 DB3F 7D               4      LD  A,L
000E47 DB40 E6F8             7      AND 0F8H
000E49 DB42 C608             7      ADD A,8
000E4B DB44 6F               4      LD  L,A
000E4C DB45 18B6            12      JR  PRINTE3
                                
       DB47                     CTRL02:
000E4E DB47 3A8EEF          13      LD  A,(_TXADR)
000E51 DB4A B7               4      OR  A
000E52 DB4B 28D1            12      JR  Z,CTRL1D
000E54 DB4D CD1EDB          17      CALL    CTRL1D
000E57 DB50 2A8EEF          16      LD  HL,(_TXADR)
000E5A DB53 3AB1EF          13      LD  A,(_WIDTH)
000E5D DB56 4F               4      LD  C,A
000E5E DB57 95               4      SUB L
000E5F DB58 47               4      LD  B,A
000E60 DB59 79               4      LD  A,C
000E61 DB5A 3D               4      DEC A
000E62 DB5B 6F               4      LD  L,A
000E63 DB5C CDAEDB          17      CALL    LOC1
                                
000E66 DB5F DB32            11      IN  A,(032H)
000E68 DB61 F5              11      PUSH    AF
000E69 DB62 CBA7             8      RES 4,A     ;高速RAMアクセスモード
000E6B DB64 D332            11      OUT (032H),A
                                
000E6D DB66 3E20             7      LD  A,020H
       DB68                     C8X1:
000E6F DB68 4E               7      LD  C,(HL)
000E70 DB69 77               7      LD  (HL),A
000E71 DB6A 2B               6      DEC HL
000E72 DB6B 79               4      LD  A,C
000E73 DB6C 10FA            13      DJNZ    C8X1
                                
000E75 DB6E F1              10      POP AF
000E76 DB6F D332            11      OUT (032H),A
000E78 DB71 C9              10      RET
                                
       DB72                     CTRL05:
000E79 DB72 CDD3EF          17      CALL    _POS
000E7C DB75 2A8EEF          16      LD  HL,(_TXADR)
000E7F DB78 3AB1EF          13      LD  A,(_WIDTH)
000E82 DB7B 95               4      SUB L
000E83 DB7C 47               4      LD  B,A
000E84 DB7D CDABDB          17      CALL    LOC0
       DB80                     CLLINE:
000E87 DB80 DB32            11      IN  A,(032H)
000E89 DB82 F5              11      PUSH    AF
000E8A DB83 CBA7             8      RES 4,A     ;高速RAMアクセスモード
000E8C DB85 D332            11      OUT (032H),A
000E8E DB87 3E20             7      LD  A,020H
       DB89                     CLLINE1:
000E90 DB89 77               7      LD  (HL),A
000E91 DB8A 23               6      INC HL
000E92 DB8B 10FC            13      DJNZ    CLLINE1
                                
000E94 DB8D F1              10      POP AF
000E95 DB8E D332            11      OUT (032H),A
000E97 DB90 C9              10      RET
                                
       DB91                     CTRL0D:
000E98 DB91 AF               4      XOR A
000E99 DB92 328EEF          13      LD  (_TXADR),A
000E9C DB95 C9              10      RET
                                
       DB96                     CTRL12:
000E9D DB96 21D1DA          10      LD  HL,INSFLG
000EA0 DB99 7E               7      LD  A,(HL)
000EA1 DB9A EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000EA3 DB9C 77               7      LD  (HL),A
000EA4 DB9D C9              10      RET
                                
       DB9E                     CTRL0B:
000EA5 DB9E 210000          10      LD  HL,0
000EA8 DBA1 228EEF          16      LD  (_TXADR),HL
000EAB DBA4 C9              10      RET
                                
       DBA5                     CTRL1B:
000EAC DBA5 3E01             7      LD  A,1
000EAE DBA7 32C8DA          13      LD  (ESCFLG),A
000EB1 DBAA C9              10      RET
       DBAB                     LOC0:
000EB2 DBAB 2A8EEF          16      LD  HL,(_TXADR)
       DBAE                     LOC1:
000EB5 DBAE C5              11      PUSH    BC
000EB6 DBAF D5              11      PUSH    DE
000EB7 DBB0 4D               4      LD  C,L
000EB8 DBB1 0608             7      LD  B,8
000EBA DBB3 5C               4      LD  E,H
000EBB DBB4 210078          10      LD  HL,120*256
000EBE DBB7 55               4      LD  D,L
       DBB8                     LOC2:
000EBF DBB8 29              11      ADD HL,HL
000EC0 DBB9 3001            12      JR  NC,LOC3
000EC2 DBBB 19              11      ADD HL,DE
       DBBC                     LOC3:
000EC3 DBBC 10FA            13      DJNZ    LOC2
000EC5 DBBE 09              11      ADD HL,BC
000EC6 DBBF ED5BB2EF        20      LD  DE,(TVRAMTOP)
000ECA DBC3 19              11      ADD HL,DE
000ECB DBC4 D1              10      POP DE
000ECC DBC5 C1              10      POP BC
000ECD DBC6 C9              10      RET
                                
       DBC7                     CONOUT1:
000ECE DBC7 CDEADB          17      CALL    CURSOR_ON
000ED1 DBCA 59               4      LD  E,C
000ED2 DBCB CDCDEF          17      CALL    _PRINT
000ED5 DBCE 7B               4      LD  A,E
000ED6 DBCF FE0A             7      CP  00AH
000ED8 DBD1 2006            12      JR  NZ,CURSOR_OFF
000EDA DBD3 CD91DB          17      CALL    CTRL0D
000EDD DBD6 CD72DB          17      CALL    CTRL05
       DBD9                     CURSOR_OFF:
000EE0 DBD9 F5              11      PUSH    AF
000EE1 DBDA 3E80             7      LD  A,080H
       DBDC                     CURSOR0:
000EE3 DBDC D351            11      OUT (051H),A
000EE5 DBDE 3A8EEF          13      LD  A,(_TXADR)
000EE8 DBE1 D350            11      OUT (050H),A
000EEA DBE3 3A8FEF          13      LD  A,(_TXADR+1)
000EED DBE6 D350            11      OUT (050H),A
000EEF DBE8 F1              10      POP AF
000EF0 DBE9 C9              10      RET
       DBEA                     CURSOR_ON:
000EF1 DBEA F5              11      PUSH    AF
000EF2 DBEB 3E81             7      LD  A,081H
000EF4 DBED 18ED            12      JR  CURSOR0
                                
       DBEF                     CTRL07:
000EF6 DBEF 3AB9EF          13      LD  A,(WK40)
000EF9 DBF2 F5              11      PUSH    AF
000EFA DBF3 F620             7      OR  20H
000EFC DBF5 D340            11      OUT (040H),A
000EFE DBF7 0610             7      LD  B,16
       DBF9                     C07X1:
000F00 DBF9 CD9EDD          17      CALL    VBLANK
000F03 DBFC 10FB            13      DJNZ    C07X1
000F05 DBFE F1              10      POP AF
000F06 DBFF D340            11      OUT (040H),A
000F08 DC01 C9              10      RET
                                
       DC02                     INSERT:
000F09 DC02 2A8EEF          16      LD  HL,(_TXADR)
000F0C DC05 3AB1EF          13      LD  A,(_WIDTH)
000F0F DC08 95               4      SUB L
000F10 DC09 47               4      LD  B,A
                                
000F11 DC0A CDABDB          17      CALL    LOC0
                                
000F14 DC0D DB32            11      IN  A,(032H)
000F16 DC0F F5              11      PUSH    AF
000F17 DC10 CBA7             8      RES 4,A     ;高速RAMアクセスモード
000F19 DC12 D332            11      OUT (032H),A
                                
000F1B DC14 3E20             7      LD  A,020H
       DC16                     INS1:
000F1D DC16 4E               7      LD  C,(HL)
000F1E DC17 77               7      LD  (HL),A
000F1F DC18 79               4      LD  A,C
000F20 DC19 23               6      INC HL
000F21 DC1A 10FA            13      DJNZ    INS1
                                
000F23 DC1C F1              10      POP AF
000F24 DC1D D332            11      OUT (032H),A
000F26 DC1F C9              10      RET
                                
       DC20                     CTRL0C:
000F27 DC20 CD9EDB          17      CALL    CTRL0B
       DC23                     CTRL06:
000F2A DC23 2A8EEF          16      LD  HL,(_TXADR)
       DC26                     CLS1:
000F2D DC26 DB32            11      IN  A,(032H)
000F2F DC28 F5              11      PUSH    AF
000F30 DC29 CBA7             8      RES 4,A     ;高速RAMアクセスモード
000F32 DC2B D332            11      OUT (032H),A
       DC2D                     CLS2:
000F34 DC2D E5              11      PUSH    HL
000F35 DC2E 3AB1EF          13      LD  A,(_WIDTH)
000F38 DC31 95               4      SUB L
000F39 DC32 47               4      LD  B,A
000F3A DC33 CDAEDB          17      CALL    LOC1
000F3D DC36 3E20             7      LD  A,020H
       DC38                     CLS3:
000F3F DC38 77               7      LD  (HL),A
000F40 DC39 23               6      INC HL
000F41 DC3A 10FC            13      DJNZ    CLS3
000F43 DC3C E1              10      POP HL
000F44 DC3D 2E00             7      LD  L,0
000F46 DC3F 24               4      INC H
000F47 DC40 3A97EF          13      LD  A,(_LINE)
000F4A DC43 BC               4      CP  H
000F4B DC44 20E7            12      JR  NZ,CLS2
000F4D DC46 F1              10      POP AF
000F4E DC47 D332            11      OUT (032H),A
000F50 DC49 C9              10      RET
                                
       DC4A                     CTRL04:
000F51 DC4A CDD3EF          17      CALL    _POS
000F54 DC4D 7D               4      LD  A,L
000F55 DC4E B7               4      OR  A
000F56 DC4F C8              11      RET Z
       DC50                     CTRL03:
000F57 DC50 CD91DB          17      CALL    CTRL0D
       DC53                     CTRL0A:
       DC53                     CTRL1F:
000F5A DC53 2A8EEF          16      LD  HL,(_TXADR)
000F5D DC56 24               4      INC H
000F5E DC57 C307DB          10      JP  PRINTE8
                                
       DC5A                     CTRL0E:
000F61 DC5A CDD3EF          17      CALL    _POS
000F64 DC5D 7C               4      LD  A,H
000F65 DC5E 1804            12      JR  SCR1
       DC60                     SCR:
000F67 DC60 3A97EF          13      LD  A,(_LINE)
000F6A DC63 3D               4      DEC A
       DC64                     SCR1:
000F6B DC64 C5              11      PUSH    BC
000F6C DC65 D5              11      PUSH    DE
000F6D DC66 E5              11      PUSH    HL
000F6E DC67 F5              11      PUSH    AF
000F6F DC68 210000          10      LD  HL,0
000F72 DC6B CDAEDB          17      CALL    LOC1
000F75 DC6E EB               4      EX  DE,HL
000F76 DC6F 210001          10      LD  HL,0100H
000F79 DC72 CDAEDB          17      CALL    LOC1
000F7C DC75 C1              10      POP BC
000F7D DC76 DB32            11      IN  A,(032H)
000F7F DC78 F5              11      PUSH    AF
000F80 DC79 CBA7             8      RES 4,A     ;高速RAMアクセスモード
000F82 DC7B D332            11      OUT (032H),A
000F84 DC7D 78               4      LD  A,B
000F85 DC7E B7               4      OR  A
       DC7F                     SCRUP1:
000F86 DC7F 2815            12      JR  Z,SCRCL
000F88 DC81 E5              11      PUSH    HL
000F89 DC82 D5              11      PUSH    DE
000F8A DC83 0608             7      LD  B,8
000F8C DC85 5F               4      LD  E,A
000F8D DC86 210078          10      LD  HL,120*256
000F90 DC89 55               4      LD  D,L
       DC8A                     SCRH2:
000F91 DC8A 29              11      ADD HL,HL
000F92 DC8B 3001            12      JR  NC,SCRH3
000F94 DC8D 19              11      ADD HL,DE
       DC8E                     SCRH3:
000F95 DC8E 10FA            13      DJNZ    SCRH2
000F97 DC90 4D               4      LD  C,L
000F98 DC91 44               4      LD  B,H
000F99 DC92 D1              10      POP DE
000F9A DC93 E1              10      POP HL
000F9B DC94 EDB0                    LDIR
                                
       DC96                     SCRCL:
000F9D DC96 F1              10      POP AF
000F9E DC97 D332            11      OUT (032H),A
                                
000FA0 DC99 3AB1EF          13      LD  A,(_WIDTH)
000FA3 DC9C 47               4      LD  B,A
000FA4 DC9D EB               4      EX  DE,HL
000FA5 DC9E CD80DB          17      CALL    CLLINE
000FA8 DCA1 E1              10      POP HL
000FA9 DCA2 D1              10      POP DE
000FAA DCA3 C1              10      POP BC
000FAB DCA4 C9              10      RET
       DCA5                     POS:
000FAC DCA5 2A8EEF          16      LD  HL,(_TXADR)
000FAF DCA8 C9              10      RET
                                
       DCA9                     GETL:
000FB0 DCA9 CDD3EF          17      CALL    _POS
000FB3 DCAC E5              11      PUSH    HL
000FB4 DCAD 3ECD             7      LD  A,0CDH      ;CALL ????
000FB6 DCAF 32D1DA          13      LD  (INSFLG),A
       DCB2                     GETL1:
000FB9 DCB2 CD31D9          17      CALL    _SYS08
000FBC DCB5 FE09             7      CP  9
000FBE DCB7 2008            12      JR  NZ,GETL1V
000FC0 DCB9 2100FF          10      LD  HL,KBUF
000FC3 DCBC CD34D6          17      CALL    MSX
000FC6 DCBF 18F1            12      JR  GETL1
       DCC1                     GETL1V:
000FC8 DCC1 5F               4      LD  E,A
000FC9 DCC2 CDCDEF          17      CALL    _PRINT
                                
000FCC DCC5 7B               4      LD  A,E
000FCD DCC6 FE0D             7      CP  00DH
000FCF DCC8 20E8            12      JR  NZ,GETL1
000FD1 DCCA 3E01             7      LD  A,1     ;LD BC,????
000FD3 DCCC 32D1DA          13      LD  (INSFLG),A
000FD6 DCCF 1100FF          10      LD  DE,KBUF
000FD9 DCD2 3AB1EF          13      LD  A,(_WIDTH)
000FDC DCD5 47               4      LD  B,A
000FDD DCD6 CDBFD3          17      CALL    ZERO_MEMORY_DE
                                
000FE0 DCD9 D1              10      POP DE
000FE1 DCDA CDD3EF          17      CALL    _POS
000FE4 DCDD 6B               4      LD  L,E
000FE5 DCDE 3AB1EF          13      LD  A,(_WIDTH)
000FE8 DCE1 95               4      SUB L
000FE9 DCE2 57               4      LD  D,A
000FEA DCE3 CDAEDB          17      CALL    LOC1
000FED DCE6 4D               4      LD  C,L
000FEE DCE7 7C               4      LD  A,H
000FEF DCE8 F630             7      OR  030H
000FF1 DCEA 47               4      LD  B,A
000FF2 DCEB 5A               4      LD  E,D
000FF3 DCEC 2100FF          10      LD  HL,KBUF
       DCEF                     GETL2:
000FF6 DCEF CDD0EF          17      CALL    _SCRN
000FF9 DCF2 03               6      INC BC
000FFA DCF3 77               7      LD  (HL),A
000FFB DCF4 23               6      INC HL
000FFC DCF5 1D               4      DEC E
000FFD DCF6 20F7            12      JR  NZ,GETL2
       DCF8                     GETL3:
000FFF DCF8 2B               6      DEC HL
001000 DCF9 7E               7      LD  A,(HL)
001001 DCFA FE21             7      CP  021H
001003 DCFC D0              11      RET NC
001004 DCFD 3600            10      LD  (HL),0
001006 DCFF 15               4      DEC D
001007 DD00 20F6            12      JR  NZ,GETL3
001009 DD02 C9              10      RET
                                
       DD03                     INKEY:
00100A DD03 E5              11      PUSH    HL
00100B DD04 2A90EF          16      LD  HL,(_KEYPS)
00100E DD07 7C               4      LD  A,H
00100F DD08 AD               4      XOR L
001010 DD09 280F            12      JR  Z,GETKEY
001012 DD0B 7C               4      LD  A,H
001013 DD0C 3C               4      INC A
001014 DD0D 3291EF          13      LD  (_KEYPS+1),A
001017 DD10 6F               4      LD  L,A
001018 DD11 26FE             7      LD  H,KEYBF/256
00101A DD13 7E               7      LD  A,(HL)
00101B DD14 E1              10      POP HL
       DD15                     INKEYD:
00101C DD15 B7               4      OR  A
00101D DD16 3292EF          13      LD  (_KEYD),A
001020 DD19 C9              10      RET
       DD1A                     GETKEY:
001021 DD1A 3A92EF          13      LD  A,(_KEYD)
001024 DD1D B7               4      OR  A
001025 DD1E 6F               4      LD  L,A
001026 DD1F 2610             7  GKSMC:  LD  H,16
       DD21                     GETKEY1:
001028 DD21 CD4FDD          17      CALL    CHKEY       ;キーを離すまで待つ
00102B DD24 281E            12      JR  Z,GETKEY2
00102D DD26 BD               4      CP  L
00102E DD27 201B            12      JR  NZ,GETKEY2
001030 DD29 DB40            11      IN  A,(040H)
001032 DD2B CB6F             8      BIT 5,A
001034 DD2D 28F2            12      JR  Z,GETKEY1
       DD2F                     GETKEY1X:
001036 DD2F CD4FDD          17      CALL    CHKEY       ;キーを離すまで待つ
001039 DD32 2810            12      JR  Z,GETKEY2
00103B DD34 BD               4      CP  L
00103C DD35 200D            12      JR  NZ,GETKEY2
00103E DD37 DB40            11      IN  A,(040H)
001040 DD39 CB6F             8      BIT 5,A
001042 DD3B 20F2            12      JR  NZ,GETKEY1X
001044 DD3D 25               4      DEC H
001045 DD3E 20E1            12      JR  NZ,GETKEY1
001047 DD40 3E01             7      LD  A,1
001049 DD42 1802            12      JR  GETKEY3
       DD44                     GETKEY2:
00104B DD44 3E10             7      LD  A,16
       DD46                     GETKEY3:
00104D DD46 3220DD          13      LD  (GKSMC+1),A
001050 DD49 3A92EF          13      LD  A,(_KEYD)
001053 DD4C B7               4      OR  A
001054 DD4D E1              10      POP HL
001055 DD4E C0              11      RET NZ
       DD4F                     CHKEY:
001056 DD4F C5              11      PUSH    BC
001057 DD50 DB08            11      IN  A,(8)       ;6:SHIFT,7:CTRL
001059 DD52 4F               4      LD  C,A
00105A DD53 3A0E00          13      LD  A,(00EH)
00105D DD56 CB5F             8      BIT 3,A
00105F DD58 2002            12      JR  NZ,CHKEYRSHIFT
001061 DD5A CBB1             8      RES 6,C
       DD5C                     CHKEYRSHIFT:
001063 DD5C 79               4      LD  A,C
001064 DD5D 3293EF          13      LD  (_KEYD+1),A
001067 DD60 E5              11      PUSH    HL
001068 DD61 0E00             7      LD  C,0
00106A DD63 21C8ED          10      LD  HL,KEY_TABLE
00106D DD66 CB77             8      BIT 6,A
00106F DD68 2003            12      JR  NZ,INKEY0
001071 DD6A 2130EE          10      LD  HL,SHIFT_TABLE
       DD6D                     INKEY0:
001074 DD6D CB7F             8      BIT 7,A
001076 DD6F 2003            12      JR  NZ,INKEY1
001078 DD71 2198EE          10      LD  HL,CTRL_TABLE
       DD74                     INKEY1:
00107B DD74 ED78            12      IN  A,(C)
00107D DD76 0608             7      LD  B,8
       DD78                     INKEY2:
00107F DD78 0F               4      RRCA
001080 DD79 300B            12      JR  NC,INKEY4
       DD7B                     INKEY3:
001082 DD7B 23               6      INC HL
001083 DD7C 10FA            13      DJNZ    INKEY2
001085 DD7E 0C               4      INC C
001086 DD7F 79               4      LD  A,C
001087 DD80 D60D             7      SUB 00DH
001089 DD82 20F0            12      JR  NZ,INKEY1
00108B DD84 1804            12      JR  INKEY5
       DD86                     INKEY4:
00108D DD86 7E               7      LD  A,(HL)
00108E DD87 B7               4      OR  A
00108F DD88 28F1            12      JR  Z,INKEY3
       DD8A                     INKEY5:
001091 DD8A E1              10      POP HL
001092 DD8B C1              10      POP BC
001093 DD8C 1887            12      JR  INKEYD
                                
       DD8E                     SCRN:
001095 DD8E E5              11      PUSH    HL
001096 DD8F DB32            11      IN  A,(032H)
001098 DD91 67               4      LD  H,A
001099 DD92 CBA7             8      RES 4,A     ;高速RAMアクセスモード
00109B DD94 D332            11      OUT (032H),A
00109D DD96 0A               7      LD  A,(BC)
00109E DD97 6F               4      LD  L,A
00109F DD98 7C               4      LD  A,H
0010A0 DD99 D332            11      OUT (032H),A
0010A2 DD9B 7D               4      LD  A,L
0010A3 DD9C E1              10      POP HL
0010A4 DD9D C9              10      RET
                                
       DD9E                     VBLANK:
0010A5 DD9E F5              11      PUSH    AF
       DD9F                     VBLANK0:
0010A6 DD9F DB40            11      IN  A,(040H)
0010A8 DDA1 E620             7      AND 020H
0010AA DDA3 20FA            12      JR  NZ,VBLANK0
       DDA5                     VBLANK1:
0010AC DDA5 DB40            11      IN  A,(040H)
0010AE DDA7 E620             7      AND 020H
0010B0 DDA9 28FA            12      JR  Z,VBLANK1
0010B2 DDAB F1              10      POP AF
0010B3 DDAC C9              10      RET
                                
       DDAD                     INIT_CRTC:
0010B4 DDAD 3E03             7      LD  A,3     ;80桁
0010B6 DDAF D330            11      OUT (030H),A
0010B8 DDB1 32BEEF          13      LD  (WK30),A
                                
0010BB DDB4 3E22             7      LD  A,022H      ;25行 64K RAM
0010BD DDB6 D331            11      OUT (031H),A
0010BF DDB8 32BFEF          13      LD  (WK31),A
                                
0010C2 DDBB 3EFF             7      LD  A,0FFH
0010C4 DDBD D3E4            11      OUT (0E4H),A    ;割り込みレベル設定
0010C6 DDBF 32B8EF          13      LD  (WKE4),A
0010C9 DDC2 3E00             7      LD  A,0
0010CB DDC4 D3E6            11      OUT (0E6H),A    ;割り込みマスク
                                
0010CD DDC6 3E19             7      LD  A,019H
0010CF DDC8 D340            11      OUT (040H),A    ;CRT I/F 同期ビットオン
0010D1 DDCA 32B9EF          13      LD  (WK40),A
0010D4 DDCD CD9EDD          17      CALL    VBLANK
                                
0010D7 DDD0 AF               4      XOR A
0010D8 DDD1 D351            11      OUT (051H),A    ;Reset CRTC
0010DA DDD3 3EA0             7      LD  A,0A0H
0010DC DDD5 D368            11      OUT (068H),A    ;DMAC: Mode Set(Reset)
0010DE DDD7 21C8F3          10      LD  HL,0F3C8H
0010E1 DDDA 22B2EF          16      LD  (TVRAMTOP),HL
0010E4 DDDD 0E64             7      LD  C,064H
0010E6 DDDF ED69            12      OUT (C),L       ;TVRAM LOW
0010E8 DDE1 ED61            12      OUT (C),H       ;TVRAM HIGH
0010EA DDE3 21B78B          10      LD  HL,08000H+120*25-1
0010ED DDE6 0C               4      INC C       ;65H
0010EE DDE7 ED69            12      OUT (C),L
0010F0 DDE9 ED61            12      OUT (C),H
0010F2 DDEB 3ECE             7      LD  A,080H+80-2
0010F4 DDED D350            11      OUT (050H),A
0010F6 DDEF 3E98             7      LD  A,080H+25-1
0010F8 DDF1 D350            11      OUT (050H),A
0010FA DDF3 DB40            11      IN  A,(040H)
0010FC DDF5 CB4F             8      BIT 1,A
0010FE DDF7 21DE67          10      LD  HL,067DEH
001101 DDFA 2003            12      JR  NZ,RESO1
001103 DDFC 21586F          10      LD  HL,06F58H
       DDFF                     RESO1:
001106 DDFF 0E50             7      LD  C,050H
001108 DE01 ED61            12      OUT (C),H
00110A DE03 ED69            12      OUT (C),L
                                
00110C DE05 3E53             7      LD  A,053H
00110E DE07 D350            11      OUT (050H),A
                                
001110 DE09 3E43             7      LD  A,043H
001112 DE0B D351            11      OUT (051H),A
                                
001114 DE0D 3EE4             7      LD  A,0E4H
001116 DE0F D368            11      OUT (068H),A
                                
001118 DE11 3E20             7      LD  A,020H
00111A DE13 D351            11      OUT (051H),A
                                
00111C DE15 CD9EDD          17      CALL    VBLANK
       DE18                     IVBL1:
00111F DE18 DB40            11      IN  A,(040H)
001121 DE1A CB6F             8      BIT 5,A
001123 DE1C 20FA            12      JR  NZ,IVBL1
                                
001125 DE1E 3E11             7      LD  A,011H
001127 DE20 D340            11      OUT (040H),A    ;CRT I/F 同期ビットオフ
001129 DE22 32B9EF          13      LD  (WK40),A
00112C DE25 C9              10      RET
[EOF:88IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
       DE26                     FILEC:
00112D DE26 CD31DE          17      CALL    FILE
       DE29                     FILEC2:
001130 DE29 3A15EF          13      LD  A,(FDRV+1)
001133 DE2C FE20             7      CP  020H
001135 DE2E C8              11      RET Z
001136 DE2F 1839            12      JR  SETDIR1
                                
       DE31                     FILE:
001138 DE31 AF               4      XOR A
001139 DE32 3214EF          13      LD  (FDRV),A
00113C DE35 67               4      LD  H,A
00113D DE36 6F               4      LD  L,A
00113E DE37 2222EF          16      LD  (FDRV+14),HL
001141 DE3A CD08DF          17      CALL    SPCUT
001144 DE3D CDEDDE          17      CALL    CCHK3
001147 DE40 2812            12      JR  Z,DEVI1
001149 DE42 13               6      INC DE
00114A DE43 1A               7      LD  A,(DE)
00114B DE44 1B               6      DEC DE
00114C DE45 FE3A             7      CP  ':'
00114E DE47 200B            12      JR  NZ,DEVI1
001150 DE49 1A               7      LD  A,(DE)      ;DRIVE
001151 DE4A CD3DE1          17      CALL    CAP
001154 DE4D D640             7      SUB '@'
001156 DE4F 13               6      INC DE
001157 DE50 13               6      INC DE
001158 DE51 3214EF          13      LD  (FDRV),A
       DE54                     DEVI1:
00115B DE54 1A               7      LD  A,(DE)
00115C DE55 D65C             7      SUB 05CH        ;\
00115E DE57 2009            12      JR  NZ,NOROOT
001160 DE59 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
001161 DE5A 222EEF          16      LD  (FDRV+26),HL
001164 DE5D 2C               4      INC L
001165 DE5E 2222EF          16      LD  (FDRV+14),HL
001168 DE61 13               6      INC DE
       DE62                     NOROOT:
                                
       DE62                     SETDIR:
001169 DE62 CD8EDE          17      CALL    FILED
00116C DE65 1A               7      LD  A,(DE)
00116D DE66 FE5C             7      CP  05CH        ;\
00116F DE68 C0              11      RET NZ
001170 DE69 13               6      INC DE
       DE6A                     SETDIR1:
001171 DE6A 3E10             7      LD  A,010H      ;Directory
001173 DE6C 3221EF          13      LD  (FDRV+13),A
001176 DE6F D5              11      PUSH    DE
001177 DE70 1114EF          10      LD  DE,FDRV
00117A DE73 2A1EF0          16      LD  HL,(STABLE+2*00FH)
00117D DE76 CD0F00          17      CALL    JP_HL
001180 DE79 D1              10      POP DE
001181 DE7A B7               4      OR  A
001182 DE7B C0              11      RET NZ
                                
001183 DE7C 3A21EF          13      LD  A,(FDRV+13)
001186 DE7F CB67             8      BIT 4,A
001188 DE81 C8              11      RET Z
                                
001189 DE82 CDD5DE          17      CALL    FILEI
00118C DE85 2A2EEF          16      LD  HL,(FDRV+26)
00118F DE88 23               6      INC HL
001190 DE89 2222EF          16      LD  (FDRV+14),HL
001193 DE8C 18D4            12      JR  SETDIR
                                
       DE8E                     FILED:
001195 DE8E CDD5DE          17      CALL    FILEI
001198 DE91 2115EF          10      LD  HL,FNAME
                                
00119B DE94 0608             7      LD  B,8
       DE96                     FILE2:
00119D DE96 CDE2DE          17      CALL    CCHKF
0011A0 DE99 C8              11      RET Z
0011A1 DE9A FE2A             7      CP  '*'
0011A3 DE9C 282E            12      JR  Z,FILE9
0011A5 DE9E FE2E             7      CP  '.'
0011A7 DEA0 280C            12      JR  Z,FILE4
0011A9 DEA2 77               7      LD  (HL),A
0011AA DEA3 23               6      INC HL
0011AB DEA4 10F0            13      DJNZ    FILE2
                                
       DEA6                     FILE3:
0011AD DEA6 CDE2DE          17      CALL    CCHKF
0011B0 DEA9 C8              11      RET Z
0011B1 DEAA FE2E             7      CP  '.'
0011B3 DEAC 20F8            12      JR  NZ,FILE3
                                
       DEAE                     FILE4:
0011B5 DEAE 211DEF          10      LD  HL,FNAME+8
0011B8 DEB1 0603             7      LD  B,3
                                
       DEB3                     FILE4L:
0011BA DEB3 CDE2DE          17      CALL    CCHKF
0011BD DEB6 C8              11      RET Z
0011BE DEB7 FE2E             7      CP  '.'
0011C0 DEB9 2008            12      JR  NZ,FILE12
0011C2 DEBB 3215EF          13      LD  (FNAME),A   ;Parent directory(..)
0011C5 DEBE 3216EF          13      LD  (FNAME+1),A
0011C8 DEC1 3E20             7      LD  A,020H
       DEC3                     FILE12:
0011CA DEC3 FE2A             7      CP  '*'
0011CC DEC5 280A            12      JR  Z,FILE10
0011CE DEC7 77               7      LD  (HL),A
0011CF DEC8 23               6      INC HL
0011D0 DEC9 10E8            13      DJNZ    FILE4L
0011D2 DECB C9              10      RET
                                
       DECC                     FILE9:              ;名前の*処理、名前の残りを?で埋める
0011D3 DECC CDD1DE          17      CALL    FILE10
0011D6 DECF 18D5            12      JR  FILE3
                                
       DED1                     FILE10:
0011D8 DED1 3E3F             7      LD  A,'?'
0011DA DED3 1808            12      JR  FILL_MEMORY
       DED5                     FILEI:              ;名前＋拡張子をスペースで初期化
0011DC DED5 3E20             7      LD  A,020H
0011DE DED7 01000B          10      LD  BC,11*256   ;C=0にしておく
0011E1 DEDA 2115EF          10      LD  HL,FNAME
       DEDD                     FILL_MEMORY:            ;HLからBバイトAで埋める
0011E4 DEDD 77               7      LD  (HL),A
0011E5 DEDE 23               6      INC HL
0011E6 DEDF 10FC            13      DJNZ    FILL_MEMORY
0011E8 DEE1 C9              10      RET
                                
       DEE2                     CCHKF:
0011E9 DEE2 1A               7      LD  A,(DE)
0011EA DEE3 CDEADE          17      CALL    CCHK2
0011ED DEE6 C8              11      RET Z
0011EE DEE7 C355E2          10      JP  FKAN
                                
       DEEA                     CCHK2:
0011F1 DEEA 0C               4      INC C
0011F2 DEEB 0D               4      DEC C
0011F3 DEEC C0              11      RET NZ
       DEED                     CCHK3:              ;ZF=1 で使えない文字
0011F4 DEED FE2B             7      CP  '+'
0011F6 DEEF C8              11      RET Z
0011F7 DEF0 FE2C             7      CP  ','
0011F9 DEF2 C8              11      RET Z
0011FA DEF3 FE2F             7      CP  '/'
0011FC DEF5 C8              11      RET Z
0011FD DEF6 FE3A             7      CP  ':'
0011FF DEF8 C8              11      RET Z
001200 DEF9 FE3B             7      CP  ';'
001202 DEFB C8              11      RET Z
001203 DEFC FE3D             7      CP  '='
001205 DEFE C8              11      RET Z
001206 DEFF FE5C             7      CP  05CH    ;\
001208 DF01 C8              11      RET Z
001209 DF02 FE20             7      CP  020H
00120B DF04 D0              11      RET NC
00120C DF05 BF               4      CP  A       ;Z=1
00120D DF06 C9              10      RET
                                
       DF07                     SS1:
00120E DF07 13               6      INC DE
       DF08                     SPCUT:              ;スペースをカット
00120F DF08 1A               7      LD  A,(DE)
001210 DF09 FE20             7      CP  020H
001212 DF0B 28FA            12      JR  Z,SS1
001214 DF0D C9              10      RET
                                
       DF0E                     SETDRVF:
001215 DF0E 1114EF          10      LD  DE,FDRV
       DF11                     SETDRV0:
001218 DF11 CD1ADF          17      CALL    SETDRV
00121B DF14 FDE1            14      POP IY
00121D DF16 C1              10      POP BC
00121E DF17 D1              10      POP DE
00121F DF18 E1              10      POP HL
001220 DF19 C9              10      RET
                                
       DF1A                     SETDRV:
001221 DF1A E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
001222 DF1B D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
001223 DF1C C5              11      PUSH    BC
001224 DF1D 1A               7      LD  A,(DE)
001225 DF1E D5              11      PUSH    DE
001226 DF1F FDE3            23      EX  (SP),IY
                                
001228 DF21 CD2DDF          17      CALL    GETDRV
00122B DF24 3C               4      INC A
00122C DF25 FD7700          19      LD  (IY+0),A    ;(FCB)ドライブ番号
00122F DF28 3D               4      DEC A
001230 DF29 CDD9EF          17      CALL    _CHGDRV
                                
001233 DF2C E9               4      JP  (HL)
                                
       DF2D                     GETDRV:
001234 DF2D E67F             7      AND 07FH
001236 DF2F D601             7      SUB 001H
001238 DF31 3003            12      JR  NC,GETDRV1
00123A DF33 3A87EF          13      LD  A,(_DVSW)   ;Current Drive
       DF36                     GETDRV1:
00123D DF36 3288EF          13      LD  (_DRV),A
001240 DF39 C9              10      RET
                                
       DF3A                     SOPENX:
001241 DF3A 1139EF          10      LD  DE,SFILE
001244 DF3D 1A               7      LD  A,(DE)
001245 DF3E FDBE00           7      CP  (IY+0)      ;(FCB)ドライブ番号
001248 DF41 2024            12      JR  NZ,SOPEN
00124A DF43 13               6      INC DE
00124B DF44 FDE5            15      PUSH    IY
00124D DF46 E1              10      POP HL
00124E DF47 23               6      INC HL
00124F DF48 CDD5E0          17      CALL    CPFILE
001252 DF4B 201A            12      JR  NZ,SOPEN
                                
001254 DF4D 2AF4F0          16      LD  HL,(SCDIR)
001257 DF50 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00125A DF53 FD740F          19      LD  (IY+15),H
                                
00125D DF56 2AF8F0          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
001260 DF59 229FEF          16      LD  (_FILEN),HL
                                
001263 DF5C ED5BF6F0        20      LD  DE,(SFBPS)
001267 DF60 2139EF          10      LD  HL,SFILE
00126A DF63 36FF            10      LD  (HL),0FFH
00126C DF65 23               6      INC HL
00126D DF66 C9              10      RET
       DF67                     SOPEN:
00126E DF67 217DE0          10      LD  HL,FILESE
       DF6A                     SOPENC:
001271 DF6A 22A3DF          16      LD  (OPENPAT+1),HL
                                
001274 DF6D CDE2EF          17      CALL    _RDFATX     ;Detect Media
001277 DF70 3856            12      JR  C,RDDERR
                                
001279 DF72 AF               4      XOR A
00127A DF73 329FEF          13      LD  (_FILEN),A
00127D DF76 CD82E1          17      CALL    LDDIRX1     ;A=0で呼び出す
001280 DF79 2818            12      JR  Z,SDIRX1
                                
001282 DF7B CD6EE0          17      CALL    READ_DIR    ;Sub Directory
001285 DF7E 3808            12      JR  C,SDIRX0
001287 DF80 2A7EF0          16      LD  HL,(_DTBUF)
00128A DF83 7E               7      LD  A,(HL)
00128B DF84 FE2E             7      CP  '.'
00128D DF86 280F            12      JR  Z,SOPEN1
       DF88                     SDIRX0:
00128F DF88 AF               4      XOR A
001290 DF89 32A0EF          13      LD  (_DIRF),A
001293 DF8C FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
001297 DF90 FD770F          19      LD  (IY+15),A
       DF93                     SDIRX1:
00129A DF93 ED5BFCF0        20      LD  DE,(_DIRPS) ;Root Directory
       DF97                     SOPEN1:
00129E DF97 0E20             7  SDECPAT:LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       DF99                     SOPEN1X:
0012A0 DF99 CD6EE0          17      CALL    READ_DIR    ;FILE SEARCH
0012A3 DF9C 382A            12      JR  C,RDDERR
0012A5 DF9E 2A7EF0          16      LD  HL,(_DTBUF)
       DFA1                     SOPEN2:
0012A8 DFA1 D5              11      PUSH    DE
0012A9 DFA2 CD7DE0          17  OPENPAT:CALL    FILESE      ;(self-modifying code)
0012AC DFA5 D1              10      POP DE
0012AD DFA6 386E            12      JR  C,SOPENE
0012AF DFA8 281B            12      JR  Z,SCF_FF_RET
       DFAA                     SOPEN3:
0012B1 DFAA 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
0012B4 DFAD B7               4      OR  A
0012B5 DFAE 200C            12      JR  NZ,SOPEN5
0012B7 DFB0 13               6      INC DE      ;ルートディレクトリ
0012B8 DFB1 E5              11      PUSH    HL
0012B9 DFB2 210C00          10  MD_PAT: LD  HL,12       ;(self-modifying code)MAXDIR
0012BC DFB5 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
0012BE DFB7 E1              10      POP HL
0012BF DFB8 20DD            12      JR  NZ,SOPEN1
0012C1 DFBA 1807            12      JR  SOPEN6
       DFBC                     SOPEN5:
0012C3 DFBC CD87E8          17      CALL    GNCLX       ;END DIR
0012C6 DFBF D8              11      RET C
0012C7 DFC0 CD35E1          17      CALL    ENDCL
       DFC3                     SOPEN6:
0012CA DFC3 38D2            12      JR  C,SOPEN1
       DFC5                     SCF_FF_RET:
0012CC DFC5 37               4      SCF         ;CF=1
0012CD DFC6 9F               4      SBC A,A     ;A=0FFH
0012CE DFC7 C9              10      RET
                                
       DFC8                     RDDERR:
0012CF DFC8 BF               4      CP  A       ;READ ERR CF=1 ZF=1
0012D0 DFC9 37               4      SCF
0012D1 DFCA C9              10      RET
                                
       DFCB                     NOPEN:
0012D2 DFCB 217DE0          10      LD  HL,FILESE
0012D5 DFCE 22A3DF          16      LD  (OPENPAT+1),HL
0012D8 DFD1 FD2A98EF        20      LD  IY,(_FCB)
0012DC DFD5 CD68E2          17      CALL    CHKWILDX
0012DF DFD8 30EB            12      JR  NC,SCF_FF_RET
0012E1 DFDA FD7E00          19      LD  A,(IY+0)    ;(FCB)ドライブ番号
0012E4 DFDD 3D               4      DEC A
0012E5 DFDE 3288EF          13      LD  (_DRV),A
0012E8 DFE1 CDD9EF          17      CALL    _CHGDRV
0012EB DFE4 D8              11      RET C
0012EC DFE5 2AF8F0          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
0012EF DFE8 229FEF          16      LD  (_FILEN),HL
                                
0012F2 DFEB CD7DE1          17      CALL    LDDIRX
0012F5 DFEE ED5B9AEF        20      LD  DE,(_FBPS)
0012F9 DFF2 CD6EE0          17      CALL    READ_DIR
0012FC DFF5 38D1            12      JR  C,RDDERR
0012FE DFF7 3A9EEF          13      LD  A,(_FBCNT)
001301 DFFA 3D               4      DEC A
001302 DFFB 28AD            12      JR  Z,SOPEN3
       DFFD                     NOPEN2:
001304 DFFD 2A9CEF          16      LD  HL,(_FBAD)
001307 E000 012000          10      LD  BC,020H
00130A E003 09              11      ADD HL,BC
00130B E004 4F               4      LD  C,A
00130C E005 189A            12      JR  SOPEN2
                                
       E007                     SOPENE2:
00130E E007 229CEF          16      LD  (_FBAD),HL
001311 E00A 79               4      LD  A,C
001312 E00B 329EEF          13      LD  (_FBCNT),A
001315 E00E ED539AEF        20      LD  (_FBPS),DE
001319 E012 FD2298EF        20      LD  (_FCB),IY
       E016                     SOPENE:
00131D E016 AF               4      XOR A
00131E E017 C9              10      RET
                                
       E018                     COPEN:
00131F E018 FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
001323 E01C 219AE0          10      LD  HL,NEXTSE
001326 E01F CD6ADF          17      CALL    SOPENC
001329 E022 D0              11      RET NC
00132A E023 C8              11      RET Z
00132B E024 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
00132E E027 B7               4      OR  A
00132F E028 37               4      SCF
001330 E029 C8              11      RET Z       ;ルートディレクトリ
001331 E02A 0601             7      LD  B,1
001333 E02C CDC6E2          17      CALL    WRDF
001336 E02F D8              11      RET C
001337 E030 ED5BFEF0        20      LD  DE,(_CLPS)
00133B E034 D5              11      PUSH    DE
00133C E035 CDFEE0          17      CALL    DCPAT
00133F E038 CD12E7          17      CALL    DRDNX
001342 E03B 2A7EF0          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
001345 E03E 3A06E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
001348 E041 47               4      LD  B,A
001349 E042 AF               4      XOR A
00134A E043 4F               4      LD  C,A
       E044                     COPENCL:
00134B E044 77               7      LD  (HL),A
00134C E045 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00134E E047 EA44E0          10      JP  PE,COPENCL
                                
001351 E04A 3A1CE1          13      LD  A,(SPCPAT+1)    ;1クラスタの論理セクタ数
001354 E04D 3D               4      DEC A
001355 E04E 2819            12      JR  Z,COPENE
001357 E050 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
001359 E052 327FE8          13      LD  (_SECPS+1),A
00135C E055 D1              10      POP DE      ;DE=(_CLPS)
00135D E056 D5              11      PUSH    DE
       E057                     COPEN1:
00135E E057 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
00135F E058 C5              11      PUSH    BC
001360 E059 2A7EF0          16      LD  HL,(_DTBUF)
001363 E05C CD18E1          17      CALL    CLUSTX
001366 E05F CDEBE9          17      CALL    DWT24
001369 E062 C1              10      POP BC
00136A E063 D1              10      POP DE
00136B E064 CD7EE8          17      CALL    NEXTX
00136E E067 20EE            12      JR  NZ,COPEN1
       E069                     COPENE:
001370 E069 2A7EF0          16      LD  HL,(_DTBUF)
001373 E06C D1              10      POP DE
001374 E06D C9              10      RET
                                
       E06E                     READ_DIR:
001375 E06E ED53FEF0        20      LD  (_CLPS),DE
001379 E072 C5              11      PUSH    BC
00137A E073 D5              11      PUSH    DE
00137B E074 CDFEE0          17      CALL    DCPAT
00137E E077 CDF2E6          17      CALL    DRDX
001381 E07A D1              10      POP DE
001382 E07B C1              10      POP BC
001383 E07C C9              10      RET
                                
       E07D                     FILESE:
001384 E07D 7E               7      LD  A,(HL)
001385 E07E B7               4      OR  A
001386 E07F C8              11      RET Z       ;END:ZF=1 CF=0
001387 E080 FEE5             7      CP  0E5H
001389 E082 280E            12      JR  Z,FILESE1
00138B E084 FDE5            15      PUSH    IY
00138D E086 D1              10      POP DE
00138E E087 13               6      INC DE
00138F E088 E5              11      PUSH    HL
001390 E089 CDD5E0          17      CALL    CPFILE
001393 E08C CCF6E0          17      CALL    Z,CPFILE2
001396 E08F E1              10      POP HL
001397 E090 37               4      SCF
001398 E091 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       E092                     FILESE1:
001399 E092 CDA9E0          17      CALL    FNEXT
00139C E095 20E6            12      JR  NZ,FILESE
       E097                     ZF0_CF0_AFF_RET:
00139E E097 F6FF             7      OR  0FFH        ;ZF=0 CF=0
0013A0 E099 C9              10      RET
                                
       E09A                     NEXTSE:
0013A1 E09A 7E               7      LD  A,(HL)
0013A2 E09B B7               4      OR  A
0013A3 E09C 37               4      SCF
0013A4 E09D C8              11      RET Z       ;!!!:ZF=1 CF=1
0013A5 E09E FEE5             7      CP  0E5H
0013A7 E0A0 37               4      SCF
0013A8 E0A1 C8              11      RET Z       ;!!!:(ZF=1) CF=1
0013A9 E0A2 CDA9E0          17      CALL    FNEXT
0013AC E0A5 20F3            12      JR  NZ,NEXTSE
0013AE E0A7 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       E0A9                     FNEXT:
0013B0 E0A9 E5              11      PUSH    HL
0013B1 E0AA 219FEF          10      LD  HL,_FILEN
0013B4 E0AD 34              11      INC (HL)
0013B5 E0AE E1              10      POP HL
0013B6 E0AF 112000          10      LD  DE,020H
0013B9 E0B2 19              11      ADD HL,DE
0013BA E0B3 0D               4      DEC C
0013BB E0B4 C9              10      RET
                                
       E0B5                     CPNAME:
0013BC E0B5 C5              11      PUSH    BC
0013BD E0B6 D5              11      PUSH    DE
0013BE E0B7 E5              11      PUSH    HL
0013BF E0B8 CDCFE0          17      CALL    CPFILE4
0013C2 E0BB E1              10      POP HL
0013C3 E0BC 23               6      INC HL
0013C4 E0BD 23               6      INC HL
0013C5 E0BE 23               6      INC HL
0013C6 E0BF 23               6      INC HL
0013C7 E0C0 D1              10      POP DE
0013C8 E0C1 C1              10      POP BC
0013C9 E0C2 2005            12      JR  NZ,CPNAME1
0013CB E0C4 7E               7      LD  A,(HL)
0013CC E0C5 23               6      INC HL
0013CD E0C6 66               7      LD  H,(HL)
0013CE E0C7 6F               4      LD  L,A
0013CF E0C8 C9              10      RET
       E0C9                     CPNAME1:
0013D0 E0C9 23               6      INC HL
0013D1 E0CA 23               6      INC HL
0013D2 E0CB 10E8            13      DJNZ    CPNAME
0013D4 E0CD 37               4      SCF
0013D5 E0CE C9              10      RET
                                
       E0CF                     CPFILE4:
0013D6 E0CF C5              11      PUSH    BC
0013D7 E0D0 010004          10      LD  BC,00400H
0013DA E0D3 1804            12      JR  CPSTR1
       E0D5                     CPFILE:
0013DC E0D5 C5              11      PUSH    BC
0013DD E0D6 01000B          10      LD  BC,00B00H
       E0D9                     CPSTR1:
0013E0 E0D9 1A               7      LD  A,(DE)
0013E1 E0DA FE3F             7      CP  '?'     ;Wild card
0013E3 E0DC 2812            12      JR  Z,CPSTR2
0013E5 E0DE 7E               7      LD  A,(HL)
0013E6 E0DF CD4EE2          17      CALL    FKANC
0013E9 E0E2 E5              11      PUSH    HL
0013EA E0E3 67               4      LD  H,A
0013EB E0E4 1A               7      LD  A,(DE)
0013EC E0E5 CB01             4      RLC C
0013EE E0E7 CD4EE2          17      CALL    FKANC
0013F1 E0EA CB09             4      RRC C
0013F3 E0EC BC               4      CP  H       ;CP (HL),(DE)
0013F4 E0ED E1              10      POP HL
0013F5 E0EE 2004            12      JR  NZ,CPSTR3
       E0F0                     CPSTR2:
0013F7 E0F0 13               6      INC DE
0013F8 E0F1 23               6      INC HL
0013F9 E0F2 10E5            13      DJNZ    CPSTR1
       E0F4                     CPSTR3:
0013FB E0F4 C1              10      POP BC
0013FC E0F5 C9              10      RET
                                
       E0F6                     CPFILE2:
0013FD E0F6 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001400 E0F9 F6E1             7      OR  0E1H
001402 E0FB 2F               4      CPL
001403 E0FC A6               7      AND (HL)
001404 E0FD C9              10      RET
                                
       E0FE                     DCPAT:
001405 E0FE 0E00             7      LD  C,0
001407 E100 2A7EF0          16      LD  HL,(_DTBUF)
00140A E103 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
00140D E106 B7               4      OR  A
00140E E107 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
00140F E108 3A1CE1          13      LD  A,(SPCPAT+1)
001412 E10B 4F               4      LD  C,A
001413 E10C 3A7FE8          13      LD  A,(_SECPS+1)
001416 E10F B9               4      CP  C
001417 E110 3801            12      JR  C,DC1
001419 E112 AF               4      XOR A
       E113                     DC1:
00141A E113 F680             7      OR  080H
00141C E115 32A0EF          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       E118                     CLUSTX:
00141F E118 E5              11      PUSH    HL
001420 E119 EB               4      EX  DE,HL
001421 E11A AF               4      XOR A
001422 E11B 0E01             7  SPCPAT: LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       E11D                     L_CLDBL:
001424 E11D CB19             8      RR  C       ;->CF
001426 E11F 3804            12      JR  C,E_CLDBL
001428 E121 29              11      ADD HL,HL       ;*2
001429 E122 8F               4      ADC A,A
00142A E123 18F8            12      JR  L_CLDBL
       E125                     E_CLDBL:
00142C E125 4F               4      LD  C,A
00142D E126 3A7FE8          13      LD  A,(_SECPS+1)
001430 E129 B5               4      OR  L
001431 E12A 6F               4      LD  L,A
001432 E12B 110800          10  CLSPAT: LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
001435 E12E AF               4      XOR A
001436 E12F 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
001437 E130 89               4      ADC A,C
001438 E131 4F               4      LD  C,A
001439 E132 EB               4      EX  DE,HL
00143A E133 E1              10      POP HL
00143B E134 C9              10      RET
                                
       E135                     ENDCL:
00143C E135 7A               4      LD  A,D ;END CLUSTER
00143D E136 FE01             7  CLPAT1: CP  1   ;164=356    (self-modifying code)
00143F E138 C0              11      RET NZ
001440 E139 7B               4      LD  A,E
001441 E13A FE64             7  CLPAT2: CP  064H    ;       (self-modifying code)
001443 E13C C9              10      RET
                                
       E13D                     CAP:
001444 E13D FE61             7      CP  'a'
001446 E13F D8              11      RET C
001447 E140 FE7B             7      CP  'z'+1
001449 E142 D0              11      RET NC
00144A E143 D620             7      SUB 020H
00144C E145 C9              10      RET
       E146                     CAP2:
00144D E146 CD3DE1          17      CALL    CAP
       E149                     CAP3:
001450 E149 CD52E1          17      CALL    CAP4
001453 E14C FE21             7      CP  021H
001455 E14E D0              11      RET NC
001456 E14F 3EA0             7      LD  A,0A0H
001458 E151 C9              10      RET
       E152                     CAP4:
001459 E152 FE05             7      CP  5
00145B E154 C0              11      RET NZ
00145C E155 3EE5             7      LD  A,0E5H
00145E E157 C9              10      RET
                                
       E158                     CHDIR:
00145F E158 CD1AEB          17      CALL    GETDPBD
001462 E15B 381D            12      JR  C,CHDIR2
001464 E15D DD751A          19      LD  (IX+01AH),L     ;_SDIR_
001467 E160 DD741B          19      LD  (IX+01BH),H     ;_SDIR_+1
00146A E163 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       E165                     LDDIR:
00146C E165 CD1AEB          17      CALL    GETDPBD
00146F E168 DD5E1A          19      LD  E,(IX+01AH)     ;_SDIR_
001472 E16B DD561B          19      LD  D,(IX+01BH)     ;_SDIR_+1
001475 E16E 13               6      INC DE
001476 E16F FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
001479 E172 FD720F          19      LD  (IY+15),D
00147C E175 1B               6      DEC DE
00147D E176 AF               4      XOR A
00147E E177 32A0EF          13      LD  (_DIRF),A
       E17A                     CHDIR2:
001481 E17A DDE1            14      POP IX
001483 E17C C9              10      RET
                                
       E17D                     LDDIRX:
001484 E17D 3AA0EF          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
001487 E180 E67F             7      AND 07FH
       E182                     LDDIRX1:
001489 E182 327FE8          13      LD  (_SECPS+1),A
00148C E185 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00148F E188 FD560F          19      LD  D,(IY+15)
001492 E18B 1B               6      DEC DE
001493 E18C CD35E1          17      CALL    ENDCL
001496 E18F D465E1          17      CALL    NC,LDDIR
       E192                     LDDIRS:
001499 E192 7A               4      LD  A,D
00149A E193 B3               4      OR  E
00149B E194 32A0EF          13      LD  (_DIRF),A   ;ディレクトリか判別
00149E E197 C9              10      RET
                                
       E198                     KILL:
00149F E198 CD68E2          17      CALL    CHKWILDX
0014A2 E19B 3834            12      JR  C,KILLW
0014A4 E19D CD3ADF          17      CALL    SOPENX
       E1A0                     KILLS:
0014A7 E1A0 3E1F             7      LD  A,01FH
0014A9 E1A2 D4E4E1          17      CALL    NC,CHKATT
0014AC E1A5 D8              11      RET C
       E1A6                     KILLSX:
0014AD E1A6 36E5            10      LD  (HL),0E5H   ;DIR
0014AF E1A8 CD42E2          17      CALL    WTDB
0014B2 E1AB 111A00          10      LD  DE,01AH
0014B5 E1AE 19              11      ADD HL,DE
0014B6 E1AF 5E               7      LD  E,(HL)
0014B7 E1B0 23               6      INC HL
0014B8 E1B1 56               7      LD  D,(HL)
       E1B2                     KILLS1:
0014B9 E1B2 CD35E1          17      CALL    ENDCL
0014BC E1B5 D0              11      RET NC      ;CF=0
0014BD E1B6 21FEFF          10      LD  HL,0-2
0014C0 E1B9 19              11      ADD HL,DE
0014C1 E1BA D0              11      RET NC      ;DE= 0 or 1
0014C2 E1BB D5              11      PUSH    DE
0014C3 E1BC CDF7EF          17      CALL    _GNCL
0014C6 E1BF ED53FEF0        20      LD  (_CLPS),DE
0014CA E1C3 D1              10      POP DE
0014CB E1C4 210000          10      LD  HL,0
0014CE E1C7 D4FAEF          17      CALL    NC,_SNCL
0014D1 E1CA D8              11      RET C
0014D2 E1CB ED5BFEF0        20      LD  DE,(_CLPS)  ;FAT
0014D6 E1CF 18E1            12      JR  KILLS1
                                
       E1D1                     KILLW:
0014D8 E1D1 CD67DF          17      CALL    SOPEN
       E1D4                     KILLW1:
0014DB E1D4 380B            12      JR  C,KILLW2
0014DD E1D6 CD07E0          17      CALL    SOPENE2
0014E0 E1D9 CDA0E1          17      CALL    KILLS
0014E3 E1DC CDCBDF          17      CALL    NOPEN
0014E6 E1DF 18F3            12      JR  KILLW1
       E1E1                     KILLW2:
0014E8 E1E1 C8              11      RET Z
0014E9 E1E2 3F               4      CCF
0014EA E1E3 C9              10      RET
                                
       E1E4                     CHKATT:
0014EB E1E4 E5              11      PUSH    HL
0014EC E1E5 110B00          10      LD  DE,00BH
0014EF E1E8 19              11      ADD HL,DE
0014F0 E1E9 A6               7      AND (HL)
0014F1 E1EA E1              10      POP HL
0014F2 E1EB C8              11      RET Z
0014F3 E1EC 37               4      SCF
0014F4 E1ED C9              10      RET
                                
       E1EE                     NAME:
0014F5 E1EE CD68E2          17      CALL    CHKWILDX
0014F8 E1F1 D8              11      RET C
0014F9 E1F2 110400          10      LD  DE,4
0014FC E1F5 19              11      ADD HL,DE
0014FD E1F6 220EE2          16      LD  (NAMEP+2),HL
001500 E1F9 23               6      INC HL
001501 E1FA CD6CE2          17      CALL    CHKWILD
001504 E1FD D8              11      RET C
                                
001505 E1FE CD3ADF          17      CALL    SOPENX
001508 E201 3E0F             7      LD  A,00FH
00150A E203 D4E4E1          17      CALL    NC,CHKATT
00150D E206 D8              11      RET C
                                
00150E E207 FD7E00          19      LD  A,(IY+0)
001511 E20A FDE5            15      PUSH    IY
001513 E20C FD210000        14  NAMEP:  LD  IY,0        ;自己書き換え
001517 E210 FD7700          19      LD  (IY+0),A
00151A E213 CD3ADF          17      CALL    SOPENX
00151D E216 FDE3            23      EX  (SP),IY
00151F E218 3F               4      CCF
001520 E219 D467DF          17      CALL    NC,SOPEN
001523 E21C EB               4      EX  DE,HL
001524 E21D E1              10      POP HL
001525 E21E D8              11      RET C
                                
       E21F                     SETNAME:
001526 E21F 01000B          10      LD  BC,11*256
001529 E222 23               6      INC HL
00152A E223 7E               7      LD  A,(HL)
00152B E224 FEE5             7      CP  0E5H
00152D E226 2004            12      JR  NZ,SNAME1
00152F E228 3E05             7      LD  A,5
001531 E22A 180E            12      JR  SNAME3
       E22C                     SNAME1:
001533 E22C 7E               7      LD  A,(HL)
001534 E22D 0C               4      INC C
001535 E22E 0D               4      DEC C
001536 E22F 2009            12      JR  NZ,SNAME3
001538 E231 CD3DE1          17      CALL    CAP
00153B E234 FEA0             7      CP  0A0H
00153D E236 2002            12      JR  NZ,SNAME3
00153F E238 3E20             7      LD  A,020H
       E23A                     SNAME3:
001541 E23A 12               7      LD  (DE),A
001542 E23B 7E               7      LD  A,(HL)
001543 E23C 23               6      INC HL
001544 E23D CD55E2          17      CALL    FKAN
001547 E240 10EA            13      DJNZ    SNAME1
       E242                     WTDB:
001549 E242 3EFF             7      LD  A,0FFH
00154B E244 3239EF          13      LD  (SFILE),A
       E247                     SWTDBF:
00154E E247 3E01             7      LD  A,1
001550 E249 32A4EF          13      LD  (_WTDBF),A
001553 E24C AF               4      XOR A
001554 E24D C9              10      RET
                                
       E24E                     FKANC:
001555 E24E CB41             8      BIT 0,C
001557 E250 CC46E1          17      CALL    Z,CAP2
00155A E253 1801            12      JR  FKANX
       E255                     FKAN:           ;漢字チェック
00155C E255 13               6      INC DE
       E256                     FKANX:
00155D E256 CB41             8      BIT 0,C
00155F E258 CB81             8      RES 0,C
001561 E25A C0              11      RET NZ
001562 E25B FE80             7      CP  080H
001564 E25D D8              11      RET C
001565 E25E FEA0             7      CP  0A0H
001567 E260 3803            12      JR  C,FKAN1
001569 E262 FEE0             7      CP  0E0H
00156B E264 D8              11      RET C
       E265                     FKAN1:
00156C E265 0C               4      INC C
00156D E266 A7               4      AND A
00156E E267 C9              10      RET
                                
       E268                     CHKWILDX:
00156F E268 FDE5            15      PUSH    IY
001571 E26A E1              10      POP HL
001572 E26B 23               6      INC HL
       E26C                     CHKWILD:
001573 E26C 060B             7      LD  B,11
001575 E26E 3E3F             7      LD  A,'?'
       E270                     CHKWIL1:
001577 E270 BE               7      CP  (HL)
001578 E271 23               6      INC HL
001579 E272 37               4      SCF
00157A E273 C8              11      RET Z
00157B E274 10FA            13      DJNZ    CHKWIL1
00157D E276 AF               4      XOR A
00157E E277 C9              10      RET
                                
       E278                     SDIRENT:        ;IY=FCB HL=DIR
00157F E278 D5              11      PUSH    DE
001580 E279 E5              11      PUSH    HL
001581 E27A FDE5            15      PUSH    IY
001583 E27C D1              10      POP DE
001584 E27D EB               4      EX  DE,HL
001585 E27E CD1FE2          17      CALL    SETNAME
                                ;               Attribute
001588 E281 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
00158B E284 12               7      LD  (DE),A
00158C E285 13               6      INC DE
                                ;               Reserved
00158D E286 AF               4      XOR A
00158E E287 060A             7      LD  B,10
       E289                     SDE1:
001590 E289 12               7      LD  (DE),A
001591 E28A 13               6      INC DE
001592 E28B 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
001594 E28D 21EAF0          10      LD  HL,SDDATA       ;(FCB)更新年月日
001597 E290 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       E292                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
001599 E292 7E               7      LD  A,(HL)
00159A E293 23               6      INC HL
00159B E294 3299E2          13      LD  (SDPAT+2),A
00159E E297 FD7E00          19  SDPAT:  LD  A,(IY+0)    ;LD A,(IY+A)
0015A1 E29A 12               7      LD  (DE),A
0015A2 E29B 13               6      INC DE
0015A3 E29C 10F4            13      DJNZ    SDLOOP
                                
0015A5 E29E AF               4      XOR A
0015A6 E29F E1              10      POP HL
0015A7 E2A0 D1              10      POP DE
0015A8 E2A1 C9              10      RET
                                
       E2A2                     WOPEN:
0015A9 E2A2 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0015AC E2A5 E61F             7      AND 01FH
0015AE E2A7 37               4      SCF
0015AF E2A8 C0              11      RET NZ
0015B0 E2A9 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E2AD                     TOPEN2:
0015B4 E2AD AF               4      XOR A
       E2AE                     TOPEN:              ;Initializes the time stamp
0015B5 E2AE FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
0015B9 E2B2 C9              10      RET
                                
       E2B3                     WRDFX:
0015BA E2B3 3A1CE1          13      LD  A,(SPCPAT+1)    ;1クラスタの論理セクタ
       E2B6                     L_WRFX:
0015BD E2B6 1F               4      RRA         ;->CF
0015BE E2B7 3806            12      JR  C,E_WRFX
0015C0 E2B9 CB39             8      SRL C
0015C2 E2BB CB1C             8      RR  H       ;CH=CH/2
0015C4 E2BD 18F7            12      JR  L_WRFX
       E2BF                     E_WRFX:
0015C6 E2BF 44               4      LD  B,H
0015C7 E2C0 04               4      INC B
0015C8 E2C1 3E37             7      LD  A,037H      ;SCF
0015CA E2C3 320FE7          13      LD  (DRDN1),A
                                
       E2C6                     WRDF:               ;Bクラスタ分FATを確保する
0015CD E2C6 110200          10      LD  DE,2
0015D0 E2C9 AF               4      XOR A
0015D1 E2CA 327FE8          13      LD  (_SECPS+1),A
       E2CD                     WRDF1:
0015D4 E2CD C5              11      PUSH    BC
0015D5 E2CE D5              11      PUSH    DE
0015D6 E2CF CDF7EF          17      CALL    _GNCL
0015D9 E2D2 381C            12      JR  C,WRDF3
0015DB E2D4 7A               4      LD  A,D     ;空いているかチェック
0015DC E2D5 B3               4      OR  E
0015DD E2D6 2027            12      JR  NZ,WRDF4
0015DF E2D8 E1              10      POP HL      ;HL=空いているクラスタ
0015E0 E2D9 E5              11      PUSH    HL
0015E1 E2DA ED5BFEF0        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
0015E5 E2DE 22FEF0          16      LD  (_CLPS),HL
0015E8 E2E1 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
0015E9 E2E2 B3               4      OR  E
0015EA E2E3 2008            12      JR  NZ,WRDF2
0015EC E2E5 FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
0015EF E2E8 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
0015F2 E2EB 1803            12      JR  WRDF3
       E2ED                     WRDF2:
0015F4 E2ED CDFAEF          17      CALL    _SNCL
       E2F0                     WRDF3:
0015F7 E2F0 D1              10      POP DE
0015F8 E2F1 C1              10      POP BC
0015F9 E2F2 D8              11      RET C
0015FA E2F3 100C            13      DJNZ    WRDF5       ;ここでループカウンタチェック
0015FC E2F5 ED5BFEF0        20      LD  DE,(_CLPS)
001600 E2F9 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
001603 E2FC C3FAEF          10      JP  _SNCL
                                
       E2FF                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
001606 E2FF D1              10      POP DE
001607 E300 C1              10      POP BC
       E301                     WRDF5:
001608 E301 13               6      INC DE
001609 E302 CD35E1          17      CALL    ENDCL
00160C E305 38C6            12      JR  C,WRDF1
00160E E307 37               4      SCF
00160F E308 C9              10      RET
                                
       E309                     RWXR:
001610 E309 3A06E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E30C                     L_RWX:
001613 E30C 1F               4      RRA     ;->CF
001614 E30D 3808            12      JR  C,E_RWX
001616 E30F CB38             8      SRL B   ;BCH=BCH/2
001618 E311 CB19             8      RR  C   ;
00161A E313 CB1C             8      RR  H   ;
00161C E315 18F5            12      JR  L_RWX
       E317                     E_RWX:
00161E E317 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001621 E31A FD561B          19      LD  D,(IY+27)
001624 E31D AF               4      XOR A
001625 E31E 327FE8          13      LD  (_SECPS+1),A
       E321                     RWX1:
001628 E321 ED53FEF0        20      LD  (_CLPS),DE
00162C E325 7A               4      LD  A,D
00162D E326 B3               4      OR  E
00162E E327 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
001630 E329 78               4      LD  A,B
001631 E32A B1               4      OR  C
001632 E32B B4               4      OR  H
001633 E32C C8              11      RET Z       ;RET BCH==0 => CF=0
                                
001634 E32D CD87E8          17      CALL    GNCLX
001637 E330 D8              11      RET C
001638 E331 7C               4      LD  A,H     ;
001639 E332 25               4      DEC H       ;
00163A E333 B7               4      OR  A       ;DEC BCH
00163B E334 2001            12      JR  NZ,RWX2     ;
00163D E336 0B               6      DEC BC      ;
       E337                     RWX2:
00163E E337 CD35E1          17      CALL    ENDCL
001641 E33A 38E5            12      JR  C,RWX1
       E33C                     SCF_RET:
001643 E33C 37               4      SCF
001644 E33D C9              10      RET
                                
       E33E                     DSKF:
001645 E33E 110000          10  MAXCLP: LD  DE,0
001648 E341 2AACEF          16      LD  HL,(_FAKEFREE)
00164B E344 7C               4      LD  A,H
00164C E345 B5               4      OR  L
00164D E346 2803            12      JR  Z,DSKF1
00164F E348 110100          10      LD  DE,1
       E34B                     DSKF1:
001652 E34B D5              11      PUSH    DE
001653 E34C CDF7EF          17      CALL    _GNCL
001656 E34F 380C            12      JR  C,POPSCF
001658 E351 7A               4      LD  A,D
001659 E352 B3               4      OR  E
00165A E353 2001            12      JR  NZ,DSKF2
00165C E355 23               6      INC HL
       E356                     DSKF2:
00165D E356 D1              10      POP DE
00165E E357 1B               6      DEC DE
00165F E358 7A               4      LD  A,D
001660 E359 B3               4      OR  E
001661 E35A 20EF            12      JR  NZ,DSKF1
001663 E35C C9              10      RET
                                
       E35D                     POPSCF:
001664 E35D F1              10      POP AF
001665 E35E 37               4      SCF
001666 E35F C9              10      RET
                                
       E360                     SETTMS:
001667 E360 FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
00166A E363 3C               4      INC A
00166B E364 C0              11      RET NZ      ;ファイルが更新されていない
       E365                     SETTMSX:            ;FCBに日付時刻をセットする
00166C E365 CDC4D9          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
00166F E368 CB25             8      SLA L       ;   *2
001671 E36A CB25             8      SLA L       ;   *4
001673 E36C 29              11      ADD HL,HL       ;*2 *8
001674 E36D 29              11      ADD HL,HL       ;*4 *16
001675 E36E 29              11      ADD HL,HL       ;*8 *32
001676 E36F 7A               4      LD  A,D
001677 E370 0F               4      RRCA            ;bit.0->7->->->0->C
001678 E371 E61F             7      AND 01FH
00167A E373 B5               4      OR  L
00167B E374 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
00167E E377 FD7417          19      LD  (IY+23),H
                                
001681 E37A CD9DD9          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
001684 E37D 0144F8          10      LD  BC,0-1980
001687 E380 09              11      ADD HL,BC
001688 E381 65               4      LD  H,L
                                
001689 E382 7A               4      LD  A,D
00168A E383 87               4      ADD A,A     ;*2
00168B E384 87               4      ADD A,A     ;*4
00168C E385 87               4      ADD A,A     ;*8
00168D E386 87               4      ADD A,A     ;*16
00168E E387 6F               4      LD  L,A
00168F E388 29              11      ADD HL,HL       ;*32
001690 E389 7D               4      LD  A,L
001691 E38A B3               4      OR  E
001692 E38B FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
001695 E38E FD7415          19      LD  (IY+21),H
001698 E391 C9              10      RET
                                
       E392                     PUSHRR:
001699 E392 CD98E3          17      CALL    SUBRR
       E395                     POPRR1:
00169C E395 EDB0                    LDIR
00169E E397 C9              10      RET
                                
       E398                     SUBRR:
00169F E398 FDE5            15      PUSH    IY
0016A1 E39A E1              10      POP HL
0016A2 E39B 112100          10      LD  DE,33
0016A5 E39E 19              11      ADD HL,DE
0016A6 E39F 115AEF          10      LD  DE,HLBUF
0016A9 E3A2 010300          10      LD  BC,3
0016AC E3A5 C9              10      RET
                                
       E3A6                     SETSEQ:
0016AD E3A6 F5              11      PUSH    AF      ;AHL=Random record
0016AE E3A7 C5              11      PUSH    BC
0016AF E3A8 FD7E21          19      LD  A,(IY+33)   ;(FCB)ランダムレコード
0016B2 E3AB FD6E22          19      LD  L,(IY+34)
0016B5 E3AE FD6623          19      LD  H,(IY+35)
0016B8 E3B1 0600             7      LD  B,0
                                
0016BA E3B3 CDC7E3          17      CALL    GET_CPM_R_SIZE
                                
0016BD E3B6 29              11      ADD HL,HL
0016BE E3B7 CB3D             8      SRL L       ;L=L/2
0016C0 E3B9 FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
0016C3 E3BC FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
0016C6 E3BF C1              10      POP BC
0016C7 E3C0 F1              10      POP AF
                                
       E3C1                     POPRR:
0016C8 E3C1 CD98E3          17      CALL    SUBRR
0016CB E3C4 EB               4      EX  DE,HL
0016CC E3C5 18CE            12      JR  POPRR1
                                
       E3C7                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
0016CE E3C7 87               4      ADD A,A     ;in BHLA => out AHL
0016CF E3C8 ED6A            15      ADC HL,HL
0016D1 E3CA CB18             8      RR  B
0016D3 E3CC B7               4      OR  A
0016D4 E3CD 78               4      LD  A,B     ;ここでフラグは変化しない
0016D5 E3CE C8              11      RET Z
0016D6 E3CF 2C               4      INC L       ;INC AHL
0016D7 E3D0 C0              11      RET NZ      ;
0016D8 E3D1 24               4      INC H       ;
0016D9 E3D2 C0              11      RET NZ      ;
0016DA E3D3 3C               4      INC A       ;
0016DB E3D4 C9              10      RET
                                
       E3D5                     GETSEQ:
0016DC E3D5 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
0016DF E3D8 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
0016E2 E3DB AF               4      XOR A
                                
0016E3 E3DC CB25             8      SLA L   ;L=L*2
                                
0016E5 E3DE CB3C             8      SRL H   ;HL=HL/2
0016E7 E3E0 CB1D             8      RR  L   ;
0016E9 E3E2 C9              10      RET
                                
       E3E3                     RB_WRITE:
0016EA E3E3 C5              11      PUSH    BC
0016EB E3E4 ED4B4CF0        20      LD  BC,(STABLE+2*026H)  ;(BDOS)ランダムブロック書き込み
0016EF E3E8 1805            12      JR  RBRW
       E3EA                     RB_READ:
0016F1 E3EA C5              11      PUSH    BC
0016F2 E3EB ED4B4EF0        20      LD  BC,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       E3EF                     RBRW:
0016F6 E3EF CB3F             8      SRL A   ;AHLA' = HL*128
0016F8 E3F1 CB1C             8      RR  H   ;AHL=AHL/2
0016FA E3F3 CB1D             8      RR  L   ;
0016FC E3F5 3E00             7      LD  A,0
0016FE E3F7 1F               4      RRA     ;A'HLA
0016FF E3F8 FD7721          19      LD  (IY+33),A   ;(FCB)ランダムレコード
001702 E3FB FD7522          19      LD  (IY+34),L
001705 E3FE FD7423          19      LD  (IY+35),H
001708 E401 FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
00170C E405 218000          10      LD  HL,128
                                
00170F E408 FDE5            15      PUSH    IY
001711 E40A D1              10      POP DE
001712 E40B D5              11      PUSH    DE
001713 E40C CD17E4          17      CALL    JP_BC
001716 E40F FDE1            14      POP IY
001718 E411 C1              10      POP BC
001719 E412 FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
00171D E416 C9              10      RET
       E417                     JP_BC:
00171E E417 C5              11      PUSH    BC
00171F E418 C9              10      RET
                                
       DFC5                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       DFC5                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       DFC5                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       DFC5                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       DFC5                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E419                     _SYS26:     ;(BDOS)ランダムブロック書き込み
001720 E419 AF               4      XOR A
001721 E41A 320FE7          13      LD  (DRDN1),A   ;NOP
001724 E41D 2249E6          16      LD  (LEFT+1),HL ;HL←書き込むレコード数
001727 E420 225DEF          16      LD  (LEFTX),HL
00172A E423 CD1ADF          17      CALL    SETDRV
                                
00172D E426 CDA0E5          17      CALL    RBX0
001730 E429 DAC3E4          10      JP  C,RBWERR
001733 E42C CDA2E2          17      CALL    WOPEN
001736 E42F DAC3E4          10      JP  C,RBWERR
001739 E432 7C               4      LD  A,H
00173A E433 B5               4      OR  L
00173B E434 CABCE4          10      JP  Z,RBW1
                                
00173E E437 2B               6      DEC HL
                                
00173F E438 CD75E6          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001742 E43B 19              11      ADD HL,DE       ;BCHL=HL+BCDE
001743 E43C 3001            12      JR  NC,S26X1    ;
001745 E43E 03               6      INC BC      ;
       E43F                     S26X1:
001746 E43F CD09E3          17      CALL    RWXR
001749 E442 DCB3E2          17      CALL    C,WRDFX
00174C E445 DAC3E4          10      JP  C,RBWERR
                                
00174F E448 CDCFE5          17      CALL    RBX2
001752 E44B 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
001754 E44D CDEEE5          17      CALL    RBXA
001757 E450 3871            12      JR  C,RBWERR
001759 E452 EB               4      EX  DE,HL
00175A E453 C5              11      PUSH    BC
00175B E454 EDB0                    LDIR
00175D E456 225FEF          16      LD  (DTAX),HL
                                
001760 E459 CD47E2          17      CALL    SWTDBF      ;バッファデータは更新された
                                
001763 E45C 2A5DEF          16      LD  HL,(LEFTX)
001766 E45F D1              10      POP DE
001767 E460 ED52            15      SBC HL,DE
001769 E462 225DEF          16      LD  (LEFTX),HL
00176C E465 2833            12      JR  Z,RBWEND
                                
       E467                     RBWB:
00176E E467 CD24E6          17      CALL    RBXB
001771 E46A 2816            12      JR  Z,RBWC
       E46C                     RBWB1:
001773 E46C C5              11      PUSH    BC
001774 E46D D5              11      PUSH    DE
001775 E46E CD18E1          17      CALL    CLUSTX
001778 E471 CD89E6          17      CALL    DWTC
00177B E474 D1              10      POP DE
00177C E475 C1              10      POP BC
00177D E476 384B            12      JR  C,RBWERR
00177F E478 CD87E8          17      CALL    GNCLX
001782 E47B 3846            12      JR  C,RBWERR
001784 E47D 10ED            13      DJNZ    RBWB1
001786 E47F CDD9E6          17      CALL    DRW_FLUSH
       E482                     RBWC:
001789 E482 CD3CE6          17      CALL    RBXC
00178C E485 2813            12      JR  Z,RBWEND
00178E E487 C5              11      PUSH    BC
00178F E488 CD18E1          17      CALL    CLUSTX
001792 E48B CD0EE7          17      CALL    DRDN
001795 E48E C1              10      POP BC
001796 E48F 3832            12      JR  C,RBWERR
001798 E491 ED5B7EF0        20      LD  DE,(_DTBUF)
00179C E495 EDB0                    LDIR
00179E E497 CD47E2          17      CALL    SWTDBF      ;バッファデータは更新された
       E49A                     RBWEND:
0017A1 E49A CD48E6          17      CALL    RBXEND
                                
0017A4 E49D CDAFE5          17      CALL    RBX1
0017A7 E4A0 301A            12      JR  NC,RBW1
0017A9 E4A2 2A49E6          16      LD  HL,(LEFT+1)
0017AC E4A5 FD5E10          19      LD  E,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
0017AF E4A8 FD5611          19      LD  D,(IY+17)   ;DE=File size
0017B2 E4AB 19              11      ADD HL,DE
0017B3 E4AC FD7510          19      LD  (IY+16),L   ;(FCB)ファイルのサイズ(バイト単位)
0017B6 E4AF FD7411          19      LD  (IY+17),H
0017B9 E4B2 3008            12      JR  NC,RBW1
0017BB E4B4 FD3412          23      INC (IY+18)
0017BE E4B7 2003            12      JR  NZ,RBW1
0017C0 E4B9 FD3413          23      INC (IY+19)
       E4BC                     RBW1:
0017C3 E4BC FDE1            14      POP IY
0017C5 E4BE C1              10      POP BC
0017C6 E4BF D1              10      POP DE
0017C7 E4C0 E1              10      POP HL
       E4C1                     DD_NUL:
0017C8 E4C1 AF               4      XOR A
       E4C2                     DRDF0:
       E4C2                     DWTF0:
0017C9 E4C2 C9              10      RET
                                
       E4C3                     RBWERR:
0017CA E4C3 FDE5            15      PUSH    IY
0017CC E4C5 D1              10      POP DE
0017CD E4C6 2A20F0          16      LD  HL,(STABLE+2*010H)
0017D0 E4C9 CD0F00          17      CALL    JP_HL
       E4CC                     RBRERR1:
0017D3 E4CC 3E01             7      LD  A,001H
       E4CE                     RBRERR2:
0017D5 E4CE FDE1            14      POP IY
0017D7 E4D0 C1              10      POP BC
0017D8 E4D1 D1              10      POP DE
0017D9 E4D2 E1              10      POP HL
0017DA E4D3 37               4      SCF
0017DB E4D4 210000          10      LD  HL,0
0017DE E4D7 C9              10      RET
                                
       E4D8                     RBRERR:
0017DF E4D8 3EFF             7      LD  A,0FFH
0017E1 E4DA 18F2            12      JR  RBRERR2
                                
       E4DC                     RBRFL:
0017E3 E4DC 3E00             7  RBRFLP: LD  A,000H
0017E5 E4DE FE0D             7      CP  00DH
0017E7 E4E0 2005            12      JR  NZ,RBRFL1
0017E9 E4E2 D5              11      PUSH    DE
0017EA E4E3 1E0A             7      LD  E,00AH
0017EC E4E5 1805            12      JR  RBRFL2
       E4E7                     RBRFL1:
0017EE E4E7 D5              11      PUSH    DE
0017EF E4E8 CD09EF          17      CALL    _SYS07
0017F2 E4EB 5F               4      LD  E,A
       E4EC                     RBRFL2:
0017F3 E4EC CDCDEF          17      CALL    _PRINT
0017F6 E4EF 7B               4      LD  A,E
0017F7 E4F0 D1              10      POP DE
0017F8 E4F1 32DDE4          13      LD  (RBRFLP+1),A
0017FB E4F4 C9              10      RET
       E4F5                     DDX:
0017FC E4F5 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
0017FF E4F8 CD3DE1          17      CALL    CAP
001802 E4FB FE41             7      CP  'A'
001804 E4FD C9              10      RET
                                
                                                ;Read random block
       E4FE                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001805 E4FE 225DEF          16      LD  (LEFTX),HL
001808 E501 CD1ADF          17      CALL    SETDRV
                                
00180B E504 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
00180F E508 C28EE5          10      JP  NZ,RBRDIR   ;ディレクトリ
001812 E50B CDA0E5          17      CALL    RBX0
001815 E50E DAD8E4          10      JP  C,RBRERR
001818 E511 CDAFE5          17      CALL    RBX1
00181B E514 DACCE4          10      JP  C,RBRERR1
00181E E517 EB               4      EX  DE,HL
00181F E518 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
001821 E51A 19              11      ADD HL,DE
001822 E51B 79               4      LD  A,C
001823 E51C DE00             7      SBC A,0
001825 E51E 78               4      LD  A,B
001826 E51F DE00             7      SBC A,0
001828 E521 3801            12      JR  C,RBR1
00182A E523 EB               4      EX  DE,HL
       E524                     RBR1:
00182B E524 9F               4      SBC A,A
00182C E525 E601             7      AND 1
00182E E527 328CE5          13      LD  (RBRAP+1),A
                                
001831 E52A 7C               4      LD  A,H
001832 E52B B5               4      OR  L
001833 E52C 2857            12      JR  Z,RBREND0
                                
001835 E52E 2249E6          16      LD  (LEFT+1),HL ;Read record byte
001838 E531 225DEF          16      LD  (LEFTX),HL
                                
00183B E534 CDCFE5          17      CALL    RBX2
00183E E537 2819            12      JR  Z,RBRB
001840 E539 CDEEE5          17      CALL    RBXA
001843 E53C DAD8E4          10      JP  C,RBRERR
001846 E53F C5              11      PUSH    BC
001847 E540 EDB0                    LDIR
001849 E542 ED535FEF        20      LD  (DTAX),DE
00184D E546 2A5DEF          16      LD  HL,(LEFTX)
001850 E549 D1              10      POP DE
001851 E54A A7               4      AND A
001852 E54B ED52            15      SBC HL,DE
001854 E54D 225DEF          16      LD  (LEFTX),HL
001857 E550 2830            12      JR  Z,RBREND
                                
       E552                     RBRB:
001859 E552 CD24E6          17      CALL    RBXB
00185C E555 2815            12      JR  Z,RBRC
       E557                     RBRB1:
00185E E557 C5              11      PUSH    BC
00185F E558 D5              11      PUSH    DE
001860 E559 CD18E1          17      CALL    CLUSTX
001863 E55C CD8FE6          17      CALL    DRDC
001866 E55F D1              10      POP DE
001867 E560 C1              10      POP BC
001868 E561 D487E8          17      CALL    NC,GNCLX
00186B E564 DAD8E4          10      JP  C,RBRERR
00186E E567 10EE            13      DJNZ    RBRB1
001870 E569 CDD9E6          17      CALL    DRW_FLUSH
       E56C                     RBRC:
001873 E56C CD3CE6          17      CALL    RBXC
001876 E56F 2811            12      JR  Z,RBREND
001878 E571 C5              11      PUSH    BC
001879 E572 CD18E1          17      CALL    CLUSTX
00187C E575 CDF2E6          17      CALL    DRDX
00187F E578 C1              10      POP BC
001880 E579 DAD8E4          10      JP  C,RBRERR
001883 E57C EB               4      EX  DE,HL
001884 E57D 2A7EF0          16      LD  HL,(_DTBUF)
001887 E580 EDB0                    LDIR
       E582                     RBREND:
001889 E582 CD48E6          17      CALL    RBXEND
       E585                     RBREND0:
00188C E585 FDE1            14      POP IY
00188E E587 C1              10      POP BC
00188F E588 D1              10      POP DE
001890 E589 F1              10      POP AF  ;(HL)
001891 E58A AF               4      XOR A
001892 E58B 3E00             7  RBRAP:  LD  A,000H
001894 E58D C9              10      RET
                                
       E58E                     RBRDIR:
001895 E58E FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001898 E591 FD661B          19      LD  H,(IY+27)
00189B E594 CD58E1          17      CALL    CHDIR
00189E E597 AF               4      XOR A
00189F E598 67               4      LD  H,A
0018A0 E599 6F               4      LD  L,A
0018A1 E59A 3C               4      INC A
0018A2 E59B 328CE5          13      LD  (RBRAP+1),A
0018A5 E59E 18E5            12      JR  RBREND0
                                
       E5A0                     RBX0:
0018A7 E5A0 2A8AEF          16      LD  HL,(_DTA)
0018AA E5A3 225FEF          16      LD  (DTAX),HL
0018AD E5A6 2A5DEF          16      LD  HL,(LEFTX)
0018B0 E5A9 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0018B3 E5AC D6FD             7      SUB 0FDH
0018B5 E5AE C9              10      RET
                                
       E5AF                     RBX1:
0018B6 E5AF E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
0018B7 E5B0 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
0018BA E5B3 FD6611          19      LD  H,(IY+17)   ;
0018BD E5B6 FD7E12          19      LD  A,(IY+18)   ;
                                
0018C0 E5B9 CD75E6          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0018C3 E5BC A7               4      AND A
0018C4 E5BD ED52            15      SBC HL,DE
0018C6 E5BF 99               4      SBC A,C
0018C7 E5C0 4F               4      LD  C,A
0018C8 E5C1 FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
0018CB E5C4 98               4      SBC A,B
0018CC E5C5 D1              10      POP DE
                                
0018CD E5C6 D8              11      RET C
0018CE E5C7 47               4      LD  B,A
0018CF E5C8 B1               4      OR  C
0018D0 E5C9 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
0018D1 E5CA B2               4      OR  D
0018D2 E5CB B3               4      OR  E
0018D3 E5CC C0              11      RET NZ
0018D4 E5CD 37               4      SCF
0018D5 E5CE C9              10      RET
                                
       E5CF                     RBX2:               ;Cluster settings
0018D6 E5CF FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
0018D9 E5D2 FD4E23          19      LD  C,(IY+35)
0018DC E5D5 0600             7      LD  B,0
0018DE E5D7 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0018E2 E5DB 2003            12      JR  NZ,RBX3
0018E4 E5DD FD4624          19      LD  B,(IY+36)
       E5E0                     RBX3:
0018E7 E5E0 CD09E3          17      CALL    RWXR
0018EA E5E3 3A06E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
0018ED E5E6 3D               4      DEC A
0018EE E5E7 FDA622          19      AND (IY+34)
0018F1 E5EA FDB621          19      OR  (IY+33)
0018F4 E5ED C9              10      RET
                                
       E5EE                     RBXA:
0018F5 E5EE C5              11      PUSH    BC
0018F6 E5EF D5              11      PUSH    DE
0018F7 E5F0 CD18E1          17      CALL    CLUSTX
0018FA E5F3 CDF2E6          17      CALL    DRDX
0018FD E5F6 D1              10      POP DE
0018FE E5F7 C1              10      POP BC
0018FF E5F8 D8              11      RET C
001900 E5F9 CD87E8          17      CALL    GNCLX
001903 E5FC D8              11      RET C
001904 E5FD ED53FEF0        20      LD  (_CLPS),DE
                                
001908 E601 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
00190B E604 210004          10  SECSZ:  LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
00190E E607 7C               4      LD  A,H
00190F E608 3D               4      DEC A       ;1024=3 / 512=1
001910 E609 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
001913 E60C 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
001914 E60D ED42            15      SBC HL,BC       ;残りを計算
                                
001916 E60F ED5B5DEF        20      LD  DE,(LEFTX)
00191A E613 ED52            15      SBC HL,DE       ;CP HL,DE
00191C E615 19              11      ADD HL,DE       ;
00191D E616 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
00191F E618 EB               4      EX  DE,HL
       E619                     RBXA1:
001920 E619 E5              11      PUSH    HL
001921 E61A 2A7EF0          16      LD  HL,(_DTBUF)
001924 E61D 09              11      ADD HL,BC
001925 E61E ED5B5FEF        20      LD  DE,(DTAX)
001929 E622 C1              10      POP BC
00192A E623 C9              10      RET
                                
       E624                     RBXB:
00192B E624 2A5FEF          16      LD  HL,(DTAX)
00192E E627 ED5BFEF0        20      LD  DE,(_CLPS)
001932 E62B 3A5EEF          13      LD  A,(LEFTX+1)
001935 E62E 47               4      LD  B,A
001936 E62F 3A06E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E632                     RBXB1:
001939 E632 1F               4      RRA     ;->CF
00193A E633 3804            12      JR  C,RBXB2
00193C E635 CB38             8      SRL B   ;B=B/2
00193E E637 18F9            12      JR  RBXB1
       E639                     RBXB2:
001940 E639 78               4      LD  A,B
001941 E63A B7               4      OR  A
001942 E63B C9              10      RET
                                
       E63C                     RBXC:
001943 E63C ED4B5DEF        20      LD  BC,(LEFTX)
001947 E640 3A06E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
00194A E643 3D               4      DEC A
00194B E644 A0               4      AND B
00194C E645 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
00194D E646 B1               4      OR  C
00194E E647 C9              10      RET
                                
       E648                     RBXEND:
00194F E648 110000          10  LEFT:   LD  DE,0
001952 E64B AF               4      XOR A
001953 E64C FD6E21          19      LD  L,(IY+33)   ;(FCB)ランダムレコード
001956 E64F FD6622          19      LD  H,(IY+34)
001959 E652 19              11      ADD HL,DE
00195A E653 FD7521          19      LD  (IY+33),L   ;(FCB)ランダムレコード
00195D E656 FD7422          19      LD  (IY+34),H
001960 E659 300E            12      JR  NC,RBXEND1
001962 E65B FD3423          23      INC (IY+35)
001965 E65E 2009            12      JR  NZ,RBXEND1
001967 E660 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00196B E664 2003            12      JR  NZ,RBXEND1
00196D E666 FD3424          23      INC (IY+36)
       E669                     RBXEND1:
001970 E669 EB               4      EX  DE,HL       ;HL=Read byte
001971 E66A C9              10      RET
                                
       E66B                     GET_RR_AHL:
001972 E66B FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001975 E66E FD6622          19      LD  H,(IY+34)   ;
001978 E671 FD7E23          19      LD  A,(IY+35)   ;
00197B E674 C9              10      RET
                                
       E675                     GET_RR_BCDE:            ;BCDE=Random record
00197C E675 FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
00197F E678 FD5622          19      LD  D,(IY+34)
001982 E67B FD4E23          19      LD  C,(IY+35)
001985 E67E FD4624          19      LD  B,(IY+36)
001988 E681 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00198C E685 C8              11      RET Z
00198D E686 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
00198F E688 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E689                     DWTC:
001990 E689 E5              11      PUSH    HL
001991 E68A 21EDE9          10      LD  HL,DWT24B
001994 E68D 1804            12      JR  DWTC1
       E68F                     DRDC:
001996 E68F E5              11      PUSH    HL
001997 E690 21DDE9          10      LD  HL,DRD24B
       E693                     DWTC1:
00199A E693 22EDE6          16      LD  (DRWF_MODE),HL
00199D E696 E1              10      POP HL
00199E E697 3ADDE6          13      LD  A,(DRWF_B)
0019A1 E69A B7               4      OR  A
0019A2 E69B 200F            12      JR  NZ,DRDC1
       E69D                     SAVE_DRWC:
0019A4 E69D 0601             7      LD  B,1
0019A6 E69F ED43DCE6        20      LD  (DRWF_C),BC
0019AA E6A3 ED53E3E6        20      LD  (DRWF_E),DE
0019AE E6A7 22E6E6          16      LD  (DRWF_HL),HL
0019B1 E6AA 1820            12      JR  INC_HL_DRWC
       E6AC                     DRDC1:
0019B3 E6AC E5              11      PUSH    HL
0019B4 E6AD 21E3E6          10      LD  HL,DRWF_E
0019B7 E6B0 86               7      ADD A,(HL)
0019B8 E6B1 F5              11      PUSH    AF
0019B9 E6B2 BB               4      CP  E
0019BA E6B3 201D            12      JR  NZ,DRDC2
0019BC E6B5 F1              10      POP AF
0019BD E6B6 23               6      INC HL
0019BE E6B7 7E               7      LD  A,(HL)
0019BF E6B8 CE00             7      ADC A,0
0019C1 E6BA F5              11      PUSH    AF
0019C2 E6BB BA               4      CP  D
0019C3 E6BC 2014            12      JR  NZ,DRDC2
0019C5 E6BE F1              10      POP AF
0019C6 E6BF 3ADCE6          13      LD  A,(DRWF_C)
0019C9 E6C2 CE00             7      ADC A,0
0019CB E6C4 B9               4      CP  C
0019CC E6C5 200C            12      JR  NZ,DRDC3
0019CE E6C7 21DDE6          10      LD  HL,DRWF_B
0019D1 E6CA 34              11      INC (HL)
0019D2 E6CB E1              10      POP HL
       E6CC                     INC_HL_DRWC:
0019D3 E6CC 3A06E6          13      LD  A,(SECSZ+2)     ;1セクタのサイズの上位1バイト
0019D6 E6CF 84               4      ADD A,H
0019D7 E6D0 67               4      LD  H,A
0019D8 E6D1 C9              10      RET
       E6D2                     DRDC2:
0019D9 E6D2 F1              10      POP AF
       E6D3                     DRDC3:
0019DA E6D3 CDD9E6          17      CALL    DRW_FLUSH
0019DD E6D6 E1              10      POP HL
0019DE E6D7 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E6D9                     DRW_FLUSH:
0019E0 E6D9 C5              11      PUSH    BC
0019E1 E6DA D5              11      PUSH    DE
       E6DC                     DRWF_C  EQU $+1
       E6DD                     DRWF_B  EQU $+2
0019E2 E6DB 010000          10      LD  BC,0
0019E5 E6DE 78               4      LD  A,B
0019E6 E6DF B7               4      OR  A
0019E7 E6E0 280D            12      JR  Z,DRDF1
       E6E3                     DRWF_E  EQU $+1
       E6E4                     DRWF_D  EQU $+2
0019E9 E6E2 110000          10      LD  DE,0
       E6E6                     DRWF_HL EQU $+1
0019EC E6E5 210000          10      LD  HL,0
0019EF E6E8 AF               4      XOR A
0019F0 E6E9 32DDE6          13      LD  (DRWF_B),A
       E6ED                     DRWF_MODE   EQU $+1
0019F3 E6EC CDDDE9          17      CALL    DRD24B
       E6EF                     DRDF1:
0019F6 E6EF D1              10      POP DE
0019F7 E6F0 C1              10      POP BC
0019F8 E6F1 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E6F2                     DRDX:
0019F9 E6F2 CD30E7          17      CALL    DRDY
0019FC E6F5 C8              11      RET Z
0019FD E6F6 CD16E7          17      CALL    DRDX1       ;データバッファの情報を保存
001A00 E6F9 D8              11      RET C
001A01 E6FA E5              11      PUSH    HL
001A02 E6FB C5              11      PUSH    BC
001A03 E6FC D5              11      PUSH    DE
001A04 E6FD 2A7EF0          16      LD  HL,(_DTBUF)
001A07 E700 3A59E7          13      LD  A,(_DBS24+1)
001A0A E703 4F               4      LD  C,A
001A0B E704 CDDBE9          17      CALL    DRD24
001A0E E707 DC2BE7          17      CALL    C,DRDNE
       E70A                     POP_DE_BC_HL_RET:
001A11 E70A D1              10      POP DE
001A12 E70B C1              10      POP BC
001A13 E70C E1              10      POP HL
001A14 E70D C9              10      RET
                                
                                ;   CDE:セクタ番号
       E70E                     DRDN:
001A15 E70E AF               4      XOR A
001A16 E70F 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
001A17 E710 30E0            12      JR  NC,DRDX
       E712                     DRDNX:
001A19 E712 CD30E7          17      CALL    DRDY
001A1C E715 C8              11      RET Z
       E716                     DRDX1:
001A1D E716 CD46E7          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
001A20 E719 ED53A6EF        20      LD  (_DBSEC),DE
001A24 E71D 79               4      LD  A,C
001A25 E71E 3259E7          13      LD  (_DBS24+1),A
                                
001A28 E721 3A88EF          13      LD  A,(_DRV)
001A2B E724 32A5EF          13      LD  (_DBDRV),A
001A2E E727 CDD9EF          17      CALL    _CHGDRV
001A31 E72A D0              11      RET NC
       E72B                     DRDNE:
001A32 E72B 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001A33 E72C 32A5EF          13      LD  (_DBDRV),A
001A36 E72F C9              10      RET
                                
                                ;   CDE:セクタ番号
       E730                     DRDY:
001A37 E730 3A59E7          13      LD  A,(_DBS24+1)
001A3A E733 B9               4      CP  C
001A3B E734 C0              11      RET NZ
                                
001A3C E735 E5              11      PUSH    HL
001A3D E736 3A88EF          13      LD  A,(_DRV)
001A40 E739 21A5EF          10      LD  HL,_DBDRV
001A43 E73C AE               7      XOR (HL)
001A44 E73D 2005            12      JR  NZ,POP_HL_RET
                                
001A46 E73F 2AA6EF          16      LD  HL,(_DBSEC)
001A49 E742 ED52            15      SBC HL,DE       ;CF=0
       E744                     POP_HL_RET:
001A4B E744 E1              10      POP HL
001A4C E745 C9              10      RET
                                
       E746                     DWTX:
001A4D E746 3AA4EF          13      LD  A,(_WTDBF)
001A50 E749 B7               4      OR  A
001A51 E74A C8              11      RET Z
001A52 E74B AF               4      XOR A
001A53 E74C 32A4EF          13      LD  (_WTDBF),A
                                
001A56 E74F E5              11      PUSH    HL
001A57 E750 C5              11      PUSH    BC
001A58 E751 D5              11      PUSH    DE
001A59 E752 3AA5EF          13      LD  A,(_DBDRV)
001A5C E755 CDD9EF          17      CALL    _CHGDRV
001A5F E758 0E00             7  _DBS24: LD  C,0
001A61 E75A ED5BA6EF        20      LD  DE,(_DBSEC)
001A65 E75E 2A7EF0          16      LD  HL,(_DTBUF)
001A68 E761 D4EBE9          17      CALL    NC,DWT24
       E764                     POP_DE_BC_HL_RET2:
001A6B E764 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E766                     RDFATX:
001A6D E766 E5              11      PUSH    HL
001A6E E767 3A88EF          13      LD  A,(_DRV)
001A71 E76A 21AAEF          10      LD  HL,_FATDRV
001A74 E76D AE               7      XOR (HL)
001A75 E76E 28D4            12      JR  Z,POP_HL_RET
                                
001A77 E770 C5              11      PUSH    BC
001A78 E771 D5              11      PUSH    DE
001A79 E772 DDE5            15      PUSH    IX
001A7B E774 CD90E7          17      CALL    WTFATX
001A7E E777 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
001A80 E779 AF               4      XOR A
001A81 E77A 32ABEF          13      LD  (_FATIX),A
001A84 E77D 3A88EF          13      LD  A,(_DRV)
001A87 E780 32AAEF          13      LD  (_FATDRV),A
001A8A E783 CDE5EF          17      CALL    _RDFAT
       E786                     RDFATE2:
001A8D E786 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
001A8F E788 9F               4      SBC A,A     ;A=0xFF
001A90 E789 32AAEF          13      LD  (_FATDRV),A
       E78C                     POP_IX_DE_BC_HL_RET:
001A93 E78C DDE1            14      POP IX
001A95 E78E 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E790                     WTFATX:
001A97 E790 3AA2EF          13      LD  A,(_WTFATF)
001A9A E793 B7               4      OR  A
001A9B E794 C8              11      RET Z
001A9C E795 E5              11      PUSH    HL
001A9D E796 3AAAEF          13      LD  A,(_FATDRV)
001AA0 E799 21A5EF          10      LD  HL,_DBDRV
001AA3 E79C AE               7      XOR (HL)
001AA4 E79D CC46E7          17      CALL    Z,DWTX
001AA7 E7A0 38A2            12      JR  C,POP_HL_RET
001AA9 E7A2 C5              11      PUSH    BC
001AAA E7A3 D5              11      PUSH    DE
001AAB E7A4 DDE5            15      PUSH    IX
001AAD E7A6 CDF8E9          17      CALL    WTFAT
001AB0 E7A9 AF               4      XOR A
001AB1 E7AA 32A2EF          13      LD  (_WTFATF),A
001AB4 E7AD 18DD            12      JR  POP_IX_DE_BC_HL_RET
                                
       E7AF                     NCL1:
001AB6 E7AF 7A               4      LD  A,D
001AB7 E7B0 B3               4      OR  E
001AB8 E7B1 37               4      SCF
001AB9 E7B2 C8              11      RET Z
                                
001ABA E7B3 7A               4      LD  A,D
001ABB E7B4 CB3F             8      SRL A   ;/2
001ABD E7B6 CB3F             8      SRL A   ;/2
                                
001ABF E7B8 E5              11      PUSH    HL
001AC0 E7B9 32D8E7          13      LD  (NCLPAT+2),A    ;_FATIX
001AC3 E7BC 2AAAEF          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001AC6 E7BF BC               4      CP  H
001AC7 E7C0 3A88EF          13      LD  A,(_DRV)    ;この間でフラグは変化しない
001ACA E7C3 32D7E7          13      LD  (NCLPAT+1),A    ;_FATDRV
001ACD E7C6 2005            12      JR  NZ,NCL2     ;FATIXが違う
001ACF E7C8 BD               4      CP  L
001AD0 E7C9 2002            12      JR  NZ,NCL2     ;ドライブが違う
001AD2 E7CB E1              10      POP HL
001AD3 E7CC C9              10      RET
       E7CD                     NCL2:
001AD4 E7CD C5              11      PUSH    BC
001AD5 E7CE D5              11      PUSH    DE
001AD6 E7CF DDE5            15      PUSH    IX
001AD8 E7D1 CD90E7          17      CALL    WTFATX
001ADB E7D4 38B6            12      JR  C,POP_IX_DE_BC_HL_RET
001ADD E7D6 010000          10  NCLPAT: LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
001AE0 E7D9 ED43AAEF        20      LD  (_FATDRV),BC
001AE4 E7DD CDCDE9          17      CALL    RDFATS
001AE7 E7E0 18A4            12      JR  RDFATE2
                                
       E7E2                     NCL3:
001AE9 E7E2 CB9A             8      RES 3,D
001AEB E7E4 CB92             8      RES 2,D
001AED E7E6 6B               4      LD  L,E
001AEE E7E7 62               4      LD  H,D
001AEF E7E8 CB3C             8      SRL H   ;
001AF1 E7EA CB1D             8      RR  L   ;HLA=HLA/2
001AF3 E7EC 1F               4      RRA     ;
001AF4 E7ED F5              11      PUSH    AF
001AF5 E7EE 3AABEF          13      LD  A,(_FATIX)
001AF8 E7F1 0F               4      RRCA
001AF9 E7F2 300B            12      JR  NC,NCL3X1
001AFB E7F4 3A06E6          13      LD  A,(SECSZ+2)
001AFE E7F7 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
001B00 E7F9 2004            12      JR  NZ,NCL3X1
001B02 E7FB 010002          10      LD  BC,512
001B05 E7FE 09              11      ADD HL,BC
       E7FF                     NCL3X1:
001B06 E7FF F1              10      POP AF
001B07 E800 ED4B7CF0        20      LD  BC,(_FATBF)
001B0B E804 19              11      ADD HL,DE
001B0C E805 09              11      ADD HL,BC
001B0D E806 17               4      RLA
001B0E E807 C9              10      RET
                                
       E808                     GNCL:
001B0F E808 CDAFE7          17      CALL    NCL1        ;GET NEXT CLUSTER
001B12 E80B D8              11      RET C
001B13 E80C C5              11      PUSH    BC
001B14 E80D E5              11      PUSH    HL
001B15 E80E CDE2E7          17      CALL    NCL3
001B18 E811 3809            12      JR  C,GNC1
001B1A E813 5E               7      LD  E,(HL)
001B1B E814 23               6      INC HL
001B1C E815 7E               7      LD  A,(HL)
001B1D E816 E60F             7      AND 00FH
001B1F E818 57               4      LD  D,A
001B20 E819 E1              10      POP HL
001B21 E81A C1              10      POP BC
001B22 E81B C9              10      RET
       E81C                     GNC1:
001B23 E81C 7E               7      LD  A,(HL)
001B24 E81D 23               6      INC HL
001B25 E81E 56               7      LD  D,(HL)
001B26 E81F 0604             7      LD  B,4
       E821                     GNC1L:
001B28 E821 CB3A             8      SRL D   ;DA=DA/2
001B2A E823 1F               4      RRA     ;
001B2B E824 10FB            13      DJNZ    GNC1L
                                
001B2D E826 5F               4      LD  E,A
001B2E E827 E1              10      POP HL
001B2F E828 C1              10      POP BC
001B30 E829 A7               4      AND A
001B31 E82A C9              10      RET
                                
       E82B                     SNCL:
001B32 E82B CDAFE7          17      CALL    NCL1
001B35 E82E D8              11      RET C
                                ;               SET NEXT CLUSTER
001B36 E82F E5              11      PUSH    HL
001B37 E830 C5              11      PUSH    BC
001B38 E831 D5              11      PUSH    DE
001B39 E832 E5              11      PUSH    HL
001B3A E833 CDE2E7          17      CALL    NCL3
001B3D E836 D1              10      POP DE
                                ;CF=ODD
001B3E E837 7E               7      LD  A,(HL)
001B3F E838 73               7      LD  (HL),E
001B40 E839 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
001B42 E83B 23               6      INC HL
001B43 E83C ED67            18      RRD     ;M={A[3:0],E[3:0]}
001B45 E83E 7A               4      LD  A,D
001B46 E83F 1804            12      JR  SNC11
       E841                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
001B48 E841 ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001B4A E843 23               6      INC HL
001B4B E844 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E845                     SNC11:
001B4C E845 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
001B4E E847 B7               4      OR  A
001B4F E848 D1              10      POP DE
001B50 E849 C1              10      POP BC
001B51 E84A E1              10      POP HL
       E84B                     FAT_CHANGED:
001B52 E84B 3E01             7      LD  A,1
001B54 E84D 32A2EF          13      LD  (_WTFATF),A
001B57 E850 C9              10      RET
                                
       E851                     N16CL3:
001B58 E851 C5              11      PUSH    BC
001B59 E852 6B               4      LD  L,E
001B5A E853 7A               4      LD  A,D
001B5B E854 E603             7      AND 3
001B5D E856 67               4      LD  H,A
001B5E E857 29              11      ADD HL,HL
001B5F E858 ED4B7CF0        20      LD  BC,(_FATBF)
001B63 E85C 09              11      ADD HL,BC
001B64 E85D C1              10      POP BC
001B65 E85E C9              10      RET
                                
       E85F                     GNCL16:
001B66 E85F CDAFE7          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
001B69 E862 D8              11      RET C
001B6A E863 E5              11      PUSH    HL
001B6B E864 CD51E8          17      CALL    N16CL3
001B6E E867 5E               7      LD  E,(HL)
001B6F E868 23               6      INC HL
001B70 E869 56               7      LD  D,(HL)
001B71 E86A E1              10      POP HL
001B72 E86B C9              10      RET
                                
       E86C                     SNCL16:
001B73 E86C CDAFE7          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
001B76 E86F D8              11      RET C
001B77 E870 D5              11      PUSH    DE
001B78 E871 E5              11      PUSH    HL
001B79 E872 CD51E8          17      CALL    N16CL3
001B7C E875 D1              10      POP DE      ;HL
001B7D E876 73               7      LD  (HL),E
001B7E E877 23               6      INC HL
001B7F E878 72               7      LD  (HL),D
001B80 E879 6B               4      LD  L,E
001B81 E87A 62               4      LD  H,D
001B82 E87B D1              10      POP DE
001B83 E87C 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E87E                     NEXTX:
001B85 E87E 3E00             7  _SECPS: LD  A,0 ;自己書き換え
001B87 E880 3C               4      INC A
001B88 E881 E600             7  NCPAT:  AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
001B8A E883 327FE8          13      LD  (_SECPS+1),A
001B8D E886 C9              10      RET
                                
       E887                     GNCLX:
001B8E E887 CD7EE8          17      CALL    NEXTX
001B91 E88A C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001B92 E88B C3F7EF          10      JP  _GNCL   ;次のクラスタを探す
                                
       E88E                     RDFAT:
001B95 E88E 3E80             7      LD  A,080H
001B97 E890 3270EF          13      LD  (CHECK),A
       E893                     RDFAT1:
001B9A E893 3A88EF          13      LD  A,(_DRV)
001B9D E896 CD23EB          17      CALL    CHGDRVR
001BA0 E899 D8              11      RET C
001BA1 E89A DD7E12          19      LD  A,(IX+012H) ;DPB_12_DEVICE
001BA4 E89D CB6F             8      BIT 5,A
001BA6 E89F 2843            12      JR  Z,RDFAT0X
001BA8 E8A1 2170EF          10      LD  HL,CHECK
001BAB E8A4 A6               7      AND (HL)
001BAC E8A5 77               7      LD  (HL),A
001BAD E8A6 110000          10      LD  DE,0        ;BPB
001BB0 E8A9 2A7CF0          16      LD  HL,(_FATBF)
001BB3 E8AC CDD9E9          17      CALL    DRD16
001BB6 E8AF 3024            12      JR  NC,GETBPB
001BB8 E8B1 2170EF          10      LD  HL,CHECK
001BBB E8B4 CB06            15      RLC (HL)
001BBD E8B6 3F               4      CCF
001BBE E8B7 D8              11      RET C
001BBF E8B8 DDCB0A1E        23      RR  (IX+00AH)   ;DPB_0A_FDMODE
001BC3 E8BC 3F               4      CCF         ;フロッピーディスクのMFMモードを切り替える
001BC4 E8BD DDCB0A16        23      RL  (IX+00AH)   ;DPB_0A_FDMODE
001BC8 E8C1 3EFF             7      LD  A,0FFH
001BCA E8C3 3289EF          13      LD  (_DSK),A
001BCD E8C6 3A84EF          13      LD  A,(_DRIVE)
001BD0 E8C9 E603             7      AND 3
001BD2 E8CB F680             7      OR  080H
001BD4 E8CD 6F               4      LD  L,A
001BD5 E8CE 26EF             7      LD  H,_CYL0/256
001BD7 E8D0 3EFF             7      LD  A,0FFH
001BD9 E8D2 77               7      LD  (HL),A
001BDA E8D3 18BE            12      JR  RDFAT1
       E8D5                     GETBPB:
001BDC E8D5 FDE5            15      PUSH    IY
001BDE E8D7 FD2A7CF0        20      LD  IY,(_FATBF) ;BPB
001BE2 E8DB CDF1EF          17      CALL    _BPB2DPB
001BE5 E8DE FDE1            14      POP IY
001BE7 E8E0 D8              11      RET C
001BE8 E8E1 CD81EA          17      CALL    CHGDRV2
       E8E4                     RDFAT0X:
001BEB E8E4 CDCDE9          17      CALL    RDFATS
001BEE E8E7 D8              11      RET C
001BEF E8E8 DDBE06           7      CP  (IX+6)      ;DPB_06_FATID
001BF2 E8EB C8              11      RET Z
001BF3 E8EC DDCB126E        20      BIT 5,(IX+012H) ;DPB_12_DEVICE
001BF7 E8F0 C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
001BF8 E8F1 37               4      SCF
001BF9 E8F2 C9              10      RET
                                
       E8F3                     BPB2DPB:
001BFA E8F3 FD7E00          19      LD  A,(IY+0)    ;BS_JmpBoot
001BFD E8F6 FEEB             7      CP  0EBH        ;Short jump
001BFF E8F8 2808            12      JR  Z,BPBOK
001C01 E8FA FEE9             7      CP  0E9H        ;Near jump
001C03 E8FC 2804            12      JR  Z,BPBOK
001C05 E8FE FE60             7      CP  060H        ;X68k
001C07 E900 37               4      SCF
001C08 E901 C0              11      RET NZ
       E902                     BPBOK:
001C09 E902 FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001C0C E905 DD7707          19      LD  (IX+7),A    ;DPB_07_SECPCL
                                
001C0F E908 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001C12 E90B DD7700          19      LD  (IX+0),A    ;DPB_00_FATLN
001C15 E90E FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
001C18 E911 DD7701          19      LD  (IX+1),A    ;DPB_00_FATLN
                                
001C1B E914 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001C1E E917 FD660F          19      LD  H,(IY+15)
001C21 E91A DD750E          19      LD  (IX+00EH),L ;DPB_0E_FATPS
001C24 E91D FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001C27 E920 FD5617          19      LD  D,(IY+23)
001C2A E923 FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E926                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001C2D E926 19              11      ADD HL,DE
001C2E E927 10FD            13      DJNZ    BPBDP1
       E929                     BPBDP2:
001C30 E929 DD7510          19      LD  (IX+010H),L ;DPB_10_DIRPS
001C33 E92C DD7411          19      LD  (IX+011H),H
001C36 E92F E5              11      PUSH    HL
                                
001C37 E930 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
001C3A E933 FD6612          19      LD  H,(IY+18)
001C3D E936 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001C40 E939 0606             7      LD  B,6
       E93B                     BPBBPS1:
001C42 E93B 05               4      DEC B
001C43 E93C 0F               4      RRCA
001C44 E93D 30FC            12      JR  NC,BPBBPS1
       E93F                     BPBDE1:
001C46 E93F 29              11      ADD HL,HL
001C47 E940 10FD            13      DJNZ    BPBDE1
                                
001C49 E942 7C               4      LD  A,H
001C4A E943 DD770B          19      LD  (IX+00BH),A ;DPB_0B_DIRSCNT
                                
001C4D E946 D1              10      POP DE      ;DPB_10_DIRPS
001C4E E947 6C               4      LD  L,H
001C4F E948 2600             7      LD  H,0
001C51 E94A 19              11      ADD HL,DE       ;MAXDIR
001C52 E94B E5              11      PUSH    HL
001C53 E94C FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001C56 E94F CB21             8      SLA C       ;*2
001C58 E951 AF               4      XOR A
001C59 E952 47               4      LD  B,A
001C5A E953 ED42            15      SBC HL,BC
001C5C E955 DD7514          19      LD  (IX+014H),L ;DPB_14_ADDCL16
001C5F E958 DD7415          19      LD  (IX+015H),H
                                
001C62 E95B D1              10      POP DE      ;DE=DPB_0B_MAXDIR
001C63 E95C FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001C66 E95F FD6614          19      LD  H,(IY+20)
001C69 E962 7C               4      LD  A,H
001C6A E963 B5               4      OR  L
001C6B E964 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001C6D E966 2010            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001C6F E968 FD7E23          19      LD  A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001C72 E96B B7               4      OR  A
001C73 E96C 37               4      SCF
001C74 E96D C0              11      RET NZ
001C75 E96E FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001C78 E971 FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_07_SECPCL)が最大128なので
001C7B E974 FD7E22          19      LD  A,(IY+34)   ;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
001C7E E977 A7               4      AND A       ;CF=0
       E978                     BPB16BIT:
001C7F E978 ED52            15      SBC HL,DE
001C81 E97A DE00             7      SBC A,0
001C83 E97C FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E97F                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001C86 E97F CB18             8      RR  B       ;->CY
001C88 E981 3808            12      JR  C,BPBTC2
001C8A E983 CB3F             8      SRL A
001C8C E985 CB1C             8      RR  H       ;AHL=AHL/2
001C8E E987 CB1D             8      RR  L
001C90 E989 18F4            12      JR  BPBTC1
       E98B                     BPBTC2:
001C92 E98B B7               4      OR  A
001C93 E98C 37               4      SCF
001C94 E98D C0              11      RET NZ      ;念のため(クラスタ数が16ビットを超える場合)
001C95 E98E 23               6      INC HL
001C96 E98F 23               6      INC HL
001C97 E990 DD7508          19      LD  (IX+8),L    ;DPB_08_MAXCL
001C9A E993 DD7409          19      LD  (IX+9),H
                                
001C9D E996 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001CA0 E999 DD7706          19      LD  (IX+6),A    ;DPB_06_FATID
                                
001CA3 E99C DDCB0A7E        20      BIT 7,(IX+00AH) ;DPB_0A_FDMODE
001CA7 E9A0 2817            12      JR  Z,NOT_FD
001CA9 E9A2 2E28             7      LD  L,40        ;MAXCYLの設定（要検討）ここから下はフロッピーのみ書き換える
001CAB E9A4 FEFD             7      CP  0FDH    ;2D
001CAD E9A6 2808            12      JR  Z,SETCYL
001CAF E9A8 2E4D             7      LD  L,77
001CB1 E9AA FEFE             7      CP  0FEH    ;2HD
001CB3 E9AC 2802            12      JR  Z,SETCYL
001CB5 E9AE 2E50             7      LD  L,80    ;その他2DD等
       E9B0                     SETCYL:
001CB7 E9B0 DD750C          19      LD  (IX+00CH),L ;DPB_0C_MAXCYL
001CBA E9B3 FD7E18          19      LD  A,(IY+24)   ;BPB_SecPerTr
001CBD E9B6 DD770D          19      LD  (IX+00DH),A ;DPB_0D_MAXSEC  ;ここまでフロッピー専用
       E9B9                     NOT_FD:
001CC0 E9B9 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001CC3 E9BC FE02             7      CP  2       ;>2:NC
001CC5 E9BE FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001CC8 E9C1 3802            12      JR  C,BPBFAT1
001CCA E9C3 F680             7      OR  080H
       E9C5                     BPBFAT1:
001CCC E9C5 DD770F          19      LD  (IX+00FH),A ;DPB_0F_BPS
                                
001CCF E9C8 E67F             7      AND 07FH        ;セクタバッファが1KBしかないので1KBを超える場合はCF=1でエラーにする
001CD1 E9CA C6FB             7      ADD A,0-5       ;0-4:CF=0 5以上:CF=1
001CD3 E9CC C9              10      RET
                                
       E9CD                     RDFATS:
001CD4 E9CD CD13EA          17      CALL    FATSETUP
001CD7 E9D0 D8              11      RET C
001CD8 E9D1 CDDDE9          17      CALL    DRD24B
001CDB E9D4 2A7CF0          16      LD  HL,(_FATBF)
001CDE E9D7 7E               7      LD  A,(HL)
001CDF E9D8 C9              10      RET
                                
       E9D9                     DRD16:
001CE0 E9D9 0E00             7      LD  C,0
       E9DB                     DRD24:
001CE2 E9DB 0601             7      LD  B,1
       E9DD                     DRD24B:
001CE4 E9DD DDE5            15      PUSH    IX
001CE6 E9DF DD2AA8EF        20      LD  IX,(_DPB)
001CEA E9E3 CD9FEC          17  DRDPAT: CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E9E6                     POP_IX_RET:
001CED E9E6 DDE1            14      POP IX
001CEF E9E8 C9              10      RET
                                
       E9E9                     DWT16:
001CF0 E9E9 0E00             7      LD  C,0
       E9EB                     DWT24:
001CF2 E9EB 0601             7      LD  B,1
       E9ED                     DWT24B:
001CF4 E9ED DDE5            15      PUSH    IX
001CF6 E9EF DD2AA8EF        20      LD  IX,(_DPB)
001CFA E9F3 CD03EC          17  DWTPAT: CALL    FDWT        ;自己書き換え（ディスク書き込み）
001CFD E9F6 18EE            12      JR  POP_IX_RET
                                
       E9F8                     WTFAT:
001CFF E9F8 CD13EA          17      CALL    FATSETUP
001D02 E9FB D4EDE9          17      CALL    NC,DWT24B
001D05 E9FE D8              11      RET C
001D06 E9FF DDCB0F7E        20      BIT 7,(IX+00FH) ;DPB_0F_BPS
001D0A EA03 C8              11      RET Z       ;予備FATが無い
001D0B EA04 CD1AEA          17      CALL    FATS2
001D0E EA07 E5              11      PUSH    HL      ;予備FAT
001D0F EA08 DD6E00          19      LD  L,(IX+0)    ;DPB_00_FATLN
001D12 EA0B DD6601          19      LD  H,(IX+1)
001D15 EA0E 19              11      ADD HL,DE
001D16 EA0F EB               4      EX  DE,HL
001D17 EA10 E1              10      POP HL
001D18 EA11 18DA            12      JR  DWT24B
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ1024毎に2KBを切り替える
                                ;------------------------
       EA13                     FATSETUP:
001D1A EA13 3AAAEF          13      LD  A,(_FATDRV)
001D1D EA16 CD23EB          17      CALL    CHGDRVR     ;ドライブ切り替え
001D20 EA19 D8              11      RET C
       EA1A                     FATS2:
001D21 EA1A DD7E0F          19      LD  A,(IX+00FH) ;DPB_0F_BPS 512=2 1024=4
001D24 EA1D 0F               4      RRCA
001D25 EA1E CD47EA          17  FATSX:  CALL    FATSETUP12  ;自己書き換え
001D28 EA21 210000          10      LD  HL,0
001D2B EA24 4A               4      LD  C,D
001D2C EA25 54               4      LD  D,H
001D2D EA26 3AABEF          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
001D30 EA29 47               4      LD  B,A
001D31 EA2A 04               4      INC B
001D32 EA2B DD7E00          19      LD  A,(IX+0)    ;DPB_00_FATLN
       EA2E                     FAT_SKP:
001D35 EA2E 05               4      DEC B
001D36 EA2F 2805            12      JR  Z,FAT1
001D38 EA31 19              11      ADD HL,DE
001D39 EA32 93               4      SUB E
001D3A EA33 30F9            12      JR  NC,FAT_SKP
001D3C EA35 C9              10      RET
       EA36                     FAT1:
001D3D EA36 EB               4      EX  DE,HL
001D3E EA37 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001D3F EA38 3801            12      JR  C,FAT2
001D41 EA3A 79               4      LD  A,C
       EA3B                     FAT2:
001D42 EA3B 47               4      LD  B,A
                                
001D43 EA3C 2AFAF0          16      LD  HL,(_FATPS) ;fat sector pos
001D46 EA3F 19              11      ADD HL,DE
001D47 EA40 EB               4      EX  DE,HL
001D48 EA41 2A7CF0          16      LD  HL,(_FATBF)
001D4B EA44 AF               4      XOR A       ;CF=0
001D4C EA45 4F               4      LD  C,A
001D4D EA46 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       EA47                     FATSETUP12:
001D4E EA47 110606          10      LD  DE,0606H    ;256
001D51 EA4A D8              11      RET C
001D52 EA4B 110303          10      LD  DE,0303H    ;512
001D55 EA4E 0F               4      RRCA
001D56 EA4F D8              11      RET C
001D57 EA50 110102          10      LD  DE,0201H    ;1024
001D5A EA53 C9              10      RET
                                
       EA54                     FATSETUP16:
001D5B EA54 110808          10      LD  DE,0808H    ;256
001D5E EA57 D8              11      RET C
001D5F EA58 110404          10      LD  DE,0404H
001D62 EA5B 0F               4      RRCA            ;512
001D63 EA5C D8              11      RET C
001D64 EA5D 110202          10      LD  DE,0202H    ;1024
001D67 EA60 C9              10      RET
                                
       EA61                     CHGDRV:
001D68 EA61 E5              11      PUSH    HL
001D69 EA62 2189EF          10      LD  HL,_DSK
001D6C EA65 BE               7      CP  (HL)
001D6D EA66 280A            12      JR  Z,CHGDRVE
       EA68                     CHGDRV1:
001D6F EA68 DDE5            15      PUSH    IX
001D71 EA6A CD74EA          17      CALL    CHGDRV0
001D74 EA6D 3A89EF          13      LD  A,(_DSK)
001D77 EA70 DDE1            14      POP IX
       EA72                     CHGDRVE:
001D79 EA72 E1              10      POP HL
001D7A EA73 C9              10      RET
                                
       EA74                     CHGDRV0:
001D7B EA74 6F               4      LD  L,A
001D7C EA75 CDDCEF          17      CALL    _GETDPB
001D7F EA78 D8              11      RET C
001D80 EA79 DD22A8EF        20      LD  (_DPB),IX
001D84 EA7D 7D               4      LD  A,L
001D85 EA7E 3289EF          13      LD  (_DSK),A
       EA81                     CHGDRV2:
001D88 EA81 C5              11      PUSH    BC
001D89 EA82 D5              11      PUSH    DE
001D8A EA83 ED73D8EA        20      LD  (SPPAT2+1),SP
001D8E EA87 F3               4      DI
001D8F EA88 DDF9            10      LD  SP,IX
                                
001D91 EA8A E1              10      POP HL      ;DPB_00_FATLN
001D92 EA8B E1              10      POP HL      ;DPB_02_DRD
001D93 EA8C 22E4E9          16      LD  (DRDPAT+1),HL
                                
001D96 EA8F E1              10      POP HL
001D97 EA90 22F4E9          16      LD  (DWTPAT+1),HL   ;DPB_04_DWT
                                
001D9A EA93 E1              10      POP HL      ;L=DPB_06_FATID H=DPB_07_SECPCL
001D9B EA94 7C               4      LD  A,H
001D9C EA95 321CE1          13      LD  (SPCPAT+1),A    ;1クラスタの論理セクタ数
001D9F EA98 3D               4      DEC A
001DA0 EA99 3282E8          13      LD  (NCPAT+1),A
                                
001DA3 EA9C E1              10      POP HL      ;DPB_08_MAXCL
001DA4 EA9D 7D               4      LD  A,L
001DA5 EA9E 323BE1          13      LD  (CLPAT2+1),A
001DA8 EAA1 7C               4      LD  A,H
001DA9 EAA2 3237E1          13      LD  (CLPAT1+1),A
001DAC EAA5 2B               6      DEC HL
001DAD EAA6 223FE3          16      LD  (MAXCLP+1),HL
                                
001DB0 EAA9 E1              10      POP HL      ;L=DPB_0A_FDMODE H=DPB_0B_DIRSCNT
001DB1 EAAA 7D               4      LD  A,L
001DB2 EAAB F6FE             7      OR  0FEH
001DB4 EAAD 3269EF          13      LD  (FDMODE+1),A
001DB7 EAB0 07               4      RLCA
001DB8 EAB1 E603             7      AND 3
001DBA EAB3 326BEF          13      LD  (FSPAT+1),A
001DBD EAB6 4C               4      LD  C,H
                                
001DBE EAB7 E1              10      POP HL      ;L=DPB_0C_MAXCYL H=DPB_0D_MAXSEC
                                
001DBF EAB8 E1              10      POP HL      ;L=DPB_0E_FATPS H=DPB_0F_BPS
001DC0 EAB9 7C               4      LD  A,H     ;DPB_0F_BPS
001DC1 EABA E607             7      AND 7
001DC3 EABC 3206E6          13      LD  (SECSZ+2),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM等
                                                ;1セクタ1024 2HD/2HDE98
                                                ;1セクタ256 GRAM/RAMF/CMOS/等
                                                ;1024   512 256
                                                ;4  2   1
001DC6 EABF 87               4      ADD A,A     ;8  4   2
001DC7 EAC0 87               4      ADD A,A     ;010H   8   4
001DC8 EAC1 87               4      ADD A,A     ;020H   010H    8
001DC9 EAC2 3298DF          13      LD  (SDECPAT+1),A   ;1セクタ辺りのディレクトリエントリ数
                                
001DCC EAC5 2600             7      LD  H,0
001DCE EAC7 22FAF0          16      LD  (_FATPS),HL
                                
001DD1 EACA E1              10      POP HL      ;L=DPB_10_DIRPS
001DD2 EACB 22FCF0          16      LD  (_DIRPS),HL
                                
001DD5 EACE E1              10      POP HL      ;L=DPB_12_DEVICE H=DPB_13_UNITNO
001DD6 EACF 7C               4      LD  A,H
001DD7 EAD0 3284EF          13      LD  (_DRIVE),A
                                
001DDA EAD3 E1              10      POP HL      ;DPB_14_ADDCL16
001DDB EAD4 222CE1          16      LD  (CLSPAT+1),HL
                                
001DDE EAD7 310000          10  SPPAT2: LD  SP,0        ;元のSPを復元
001DE1 EADA FB               4      EI
001DE2 EADB 2AFCF0          16      LD  HL,(_DIRPS)
001DE5 EADE 0600             7      LD  B,0
001DE7 EAE0 09              11      ADD HL,BC
001DE8 EAE1 22B3DF          16      LD  (MD_PAT+1),HL
                                
001DEB EAE4 2A3FE3          16      LD  HL,(MAXCLP+1);
001DEE EAE7 11F60F          10      LD  DE,4086
001DF1 EAEA B7               4      OR  A
001DF2 EAEB ED52            15      SBC HL,DE
001DF4 EAED 300F            12      JR  NC,SETFAT16
001DF6 EAEF 2108E8          10      LD  HL,GNCL     ;FAT12
001DF9 EAF2 112BE8          10      LD  DE,SNCL
001DFC EAF5 0147EA          10      LD  BC,FATSETUP12
001DFF EAF8 DDCB0FAE        23      RES 5,(IX+00FH) ;DPB_0F_BPS(FAT12)
001E03 EAFC 180D            12      JR  EXTRA1
       EAFE                     SETFAT16:
001E05 EAFE 215FE8          10      LD  HL,GNCL16   ;FAT16
001E08 EB01 116CE8          10      LD  DE,SNCL16
001E0B EB04 0154EA          10      LD  BC,FATSETUP16
001E0E EB07 DDCB0FEE        23      SET 5,(IX+00FH) ;DPB_0F_BPS(FAT16)
       EB0B                     EXTRA1:
001E12 EB0B 22F8EF          16      LD  (GNCPAT+1),HL
001E15 EB0E ED53FBEF        20      LD  (SNCPAT+1),DE
001E19 EB12 ED431FEA        20      LD  (FATSX+1),BC
001E1D EB16 D1              10      POP DE
001E1E EB17 C1              10      POP BC
001E1F EB18 AF               4      XOR A
001E20 EB19 C9              10      RET
                                
       EB1A                     GETDPBD:
001E21 EB1A DDE3            23      EX  (SP),IX
001E23 EB1C DDE5            15      PUSH    IX
001E25 EB1E 3A88EF          13      LD  A,(_DRV)
001E28 EB21 1807            12      JR  GETDPB1
                                
       EB23                     CHGDRVR:
001E2A EB23 CDD9EF          17      CALL    _CHGDRV
001E2D EB26 D8              11      RET C
001E2E EB27 3A89EF          13      LD  A,(_DSK)
       EB2A                     GETDPB1:
001E31 EB2A C3DCEF          10      JP  _GETDPB
                                
       EB2D                     GETDPB:
001E34 EB2D FE08             7      CP  8
001E36 EB2F 3F               4      CCF
001E37 EB30 D8              11      RET C
001E38 EB31 0F               4      RRCA
001E39 EB32 0F               4      RRCA
001E3A EB33 0F               4      RRCA
001E3B EB34 DD                      DB  0DDH        ;Z80未定義命令
001E3C EB35 6F               4      LD  L,A     ;LD IXL,A
001E3D EB36 DD                      DB  0DDH        ;Z80未定義命令
001E3E EB37 26F1             7      LD  H,DEVICE/256    ;LD IXH,DEVICE/256
001E40 EB39 DD7E00          19      LD  A,(IX+0)    ;DPB_00_FATLN
001E43 EB3C B7               4      OR  A       ;CF=0の為
001E44 EB3D DDCB0F6E        20      BIT 5,(IX+00FH) ;DPB_0F_BPS
001E48 EB41 C0              11      RET NZ      ;FAT16
001E49 EB42 DDCB126E        20      BIT 5,(IX+012H) ;DPB_12_DEVICE
001E4D EB46 C0              11      RET NZ      ;BPB
001E4E EB47 FE01             7      CP  001H        ;A=0 THEN CF=1
001E50 EB49 C9              10      RET
                                
       EB4A                     _SYS5F:
001E51 EB4A AF               4      XOR A
       EB4B                     FFLUSH:
001E52 EB4B F5              11      PUSH    AF
001E53 EB4C 3EFF             7      LD  A,0FFH
001E55 EB4E 3239EF          13      LD  (SFILE),A
001E58 EB51 CD46E7          17      CALL    DWTX
001E5B EB54 3EFF             7      LD  A,0FFH
001E5D EB56 32A5EF          13      LD  (_DBDRV),A
001E60 EB59 CD90E7          17      CALL    WTFATX
001E63 EB5C AF               4      XOR A
001E64 EB5D 32ABEF          13      LD  (_FATIX),A
001E67 EB60 2F               4      CPL
001E68 EB61 32AAEF          13      LD  (_FATDRV),A
001E6B EB64 F1              10      POP AF
001E6C EB65 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "88DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   PC-8801mkIISR
                                
                                ;   FLOPPY DISK DRIVER
                                
       EB66                     PUTCOM:
001E6D EB66 C5              11      PUSH    BC
001E6E EB67 01CC37          10      LD  BC,037CCH
001E71 EB6A CD81EB          17      CALL    CALLROM
001E74 EB6D C1              10      POP BC
001E75 EB6E C9              10      RET
                                
       EB6F                     PUTDAT:
001E76 EB6F C5              11      PUSH    BC
001E77 EB70 01D237          10      LD  BC,037D2H
001E7A EB73 CD81EB          17      CALL    CALLROM
001E7D EB76 C1              10      POP BC
001E7E EB77 C9              10      RET
                                
       EB78                     GETDAT:
001E7F EB78 C5              11      PUSH    BC
001E80 EB79 014738          10      LD  BC,03847H
001E83 EB7C CD81EB          17      CALL    CALLROM
001E86 EB7F C1              10      POP BC
001E87 EB80 C9              10      RET
                                
       EB81                     CALLROM:
001E88 EB81 F3               4      DI
001E89 EB82 F5              11      PUSH    AF
001E8A EB83 3ABFEF          13      LD  A,(WK31)
001E8D EB86 CB8F             8      RES 1,A
001E8F EB88 D331            11      OUT (031H),A
001E91 EB8A F1              10      POP AF
001E92 EB8B CD17E4          17      CALL    JP_BC
001E95 EB8E F5              11      PUSH    AF
001E96 EB8F 3ABFEF          13      LD  A,(WK31)
001E99 EB92 D331            11      OUT (031H),A
001E9B EB94 F1              10      POP AF
001E9C EB95 FB               4      EI
001E9D EB96 C9              10      RET
                                
                                ;   高速ハンドシェイク（ホストが送信）
                                ;   HL:アドレス BC:受信サイズ（必ず偶数にする）
       EB97                     FPUTDAT:
       EB97                     FPUTDAT1:
001E9E EB97 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001EA0 EB99 E602             7      AND 2       ;RFD
001EA2 EB9B 28FA            12      JR  Z,FPUTDAT1
001EA4 EB9D 3E0E             7      LD  A,00EH      ;ATN=0
001EA6 EB9F D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001EA8 EBA1 7E               7      LD  A,(HL)
001EA9 EBA2 D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
                                
001EAB EBA4 3E09             7      LD  A,9     ;DAV=1
001EAD EBA6 D3FF            11      OUT (0FFH),A
001EAF EBA8 23               6      INC HL
001EB0 EBA9 0B               6      DEC BC
       EBAA                     FPUTDAT2:
001EB1 EBAA DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001EB3 EBAC E604             7      AND 4       ;DAC
001EB5 EBAE 28FA            12      JR  Z,FPUTDAT2
                                
001EB7 EBB0 7E               7      LD  A,(HL)
001EB8 EBB1 D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
                                
001EBA EBB3 3E08             7      LD  A,8     ;DAV=0
001EBC EBB5 D3FF            11      OUT (0FFH),A
       EBB7                     FPUTDAT3:
001EBE EBB7 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001EC0 EBB9 E604             7      AND 4       ;DAC
001EC2 EBBB 20FA            12      JR  NZ,FPUTDAT3
                                
001EC4 EBBD EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001EC6 EBBF EA97EB          10      JP  PE,FPUTDAT
001EC9 EBC2 C9              10      RET
                                
                                
                                ;   高速ハンドシェイク（ホストが受信）
                                ;   HL:アドレス BC:受信サイズ（必ず偶数にする）
       EBC3                     FGETDAT:
001ECA EBC3 3E0B             7      LD  A,00BH      ;RFD=1
001ECC EBC5 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
       EBC7                     FGETDAT1:
001ECE EBC7 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001ED0 EBC9 0F               4      RRCA            ;DAV
001ED1 EBCA 30FB            12      JR  NC,FGETDAT1
                                    
001ED3 EBCC 3E0A             7      LD  A,00AH      ;RFD=0
001ED5 EBCE D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                    
001ED7 EBD0 DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001ED9 EBD2 77               7      LD  (HL),A
                                
001EDA EBD3 3E0D             7      LD  A,00DH      ;DAC=1
001EDC EBD5 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
001EDE EBD7 23               6      INC HL
001EDF EBD8 0B               6      DEC BC
       EBD9                     FGETDAT2:
001EE0 EBD9 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001EE2 EBDB 0F               4      RRCA            ;DAV
001EE3 EBDC 38FB            12      JR  C,FGETDAT2
                                
001EE5 EBDE DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001EE7 EBE0 77               7      LD  (HL),A
                                
001EE8 EBE1 3E0C             7      LD  A,00CH      ;DAC=0
001EEA EBE3 D3FF            11      OUT (0FFH),A
                                
001EEC EBE5 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001EEE EBE7 EAC3EB          10      JP  PE,FGETDAT
001EF1 EBEA C9              10      RET
                                
                                ;   論理セクタ番号からトラック番号とセクタ番号を得る
                                ;   in 
                                ;   DE:論理セクタ
       EBEB                     CALC_SECTOR:
001EF2 EBEB C5              11      PUSH    BC
001EF3 EBEC DD4E0D          19      LD  C,(IX+00DH) ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
001EF6 EBEF 0610             7      LD  B,16
001EF8 EBF1 AF               4      XOR A
001EF9 EBF2 EB               4      EX  DE,HL
       EBF3                     DIV1:
001EFA EBF3 29              11      ADD HL,HL
001EFB EBF4 8F               4      ADC A,A
001EFC EBF5 B9               4      CP  C
001EFD EBF6 3802            12      JR  C,DIV2
001EFF EBF8 91               4      SUB C
001F00 EBF9 2C               4      INC L
       EBFA                     DIV2:
001F01 EBFA 10F7            13      DJNZ    DIV1
                                
001F03 EBFC 3C               4      INC A   ;最小のセクタは１固定
001F04 EBFD 55               4      LD  D,L ;TRACK
       EBFE                     DIV3:
001F05 EBFE 5F               4      LD  E,A ;SECTOR
001F06 EBFF C1              10      POP BC
001F07 EC00 C9              10      RET
                                
       EC01                     WTTRK:
001F08 EC01 37               4      SCF
001F09 EC02 C9              10      RET
       EC03                     FDWT:
001F0A EC03 E5              11      PUSH    HL
001F0B EC04 D5              11      PUSH    DE
001F0C EC05 CDEBEB          17      CALL    CALC_SECTOR
001F0F EC08 7A               4      LD  A,D     ;トラック
001F10 EC09 3269EC          13      LD  (FDWT_TRACK),A
001F13 EC0C 7B               4      LD  A,E     ;セクタ
001F14 EC0D 3264EC          13      LD  (FDWT_SECTOR),A
001F17 EC10 DD7E0D          19      LD  A,(IX+00DH) ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
001F1A EC13 93               4      SUB E
001F1B EC14 3C               4      INC A
001F1C EC15 67               4      LD  H,A
001F1D EC16 D1              10      POP DE
001F1E EC17 3A06E6          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
001F21 EC1A 4F               4      LD  C,A
001F22 EC1B AF               4      XOR A
       EC1C                     FDWT2:
001F23 EC1C 81               4      ADD A,C
001F24 EC1D 13               6      INC DE
001F25 EC1E 05               4      DEC B
001F26 EC1F 2807            12      JR  Z,FDWT3
001F28 EC21 25               4      DEC H       ;トラック、ヘッドを跨がない
001F29 EC22 2804            12      JR  Z,FDWT3
001F2B EC24 FE3A             7      CP  03AH        ;バッファとして04000H-07BFFHまで使える
001F2D EC26 38F4            12      JR  C,FDWT2
       EC28                     FDWT3:
001F2F EC28 4F               4      LD  C,A
001F30 EC29 E1              10      POP HL
001F31 EC2A 3E16             7      LD  A,16H       ;高速レシーブメモリ
001F33 EC2C CD66EB          17      CALL    PUTCOM
001F36 EC2F 3E40             7      LD  A,DSS_DATA/256  ;開始アドレスH
001F38 EC31 CD6FEB          17      CALL    PUTDAT
001F3B EC34 AF               4      XOR A       ;開始アドレスL
001F3C EC35 CD6FEB          17      CALL    PUTDAT
001F3F EC38 79               4      LD  A,C     ;バイト数H
001F40 EC39 CD6FEB          17      CALL    PUTDAT
001F43 EC3C AF               4      XOR A       ;バイト数L
001F44 EC3D CD6FEB          17      CALL    PUTDAT
001F47 EC40 C5              11      PUSH    BC
001F48 EC41 41               4      LD  B,C
001F49 EC42 0E00             7      LD  C,0
001F4B EC44 CD97EB          17      CALL    FPUTDAT
001F4E EC47 C1              10      POP BC
001F4F EC48 3E0D             7      LD  A,0DH       ;エグゼキュート
001F51 EC4A CD66EB          17      CALL    PUTCOM
001F54 EC4D 3E7C             7      LD  A,WRITEDISKEX/256
001F56 EC4F CD6FEB          17      CALL    PUTDAT
001F59 EC52 3EA0             7      LD  A,WRITEDISKEX%256
001F5B EC54 CD6FEB          17      CALL    PUTDAT
001F5E EC57 DD7E13          19      LD  A,(IX+013H) ;デバイスドライバ内におけるユニット番号(DPB_13_UNITNO)
001F61 EC5A CD6FEB          17      CALL    PUTDAT
001F64 EC5D DD7E0D          19      LD  A,(IX+00DH) ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
001F67 EC60 CD6FEB          17      CALL    PUTDAT
       EC64                     FDWT_SECTOR EQU $+1
001F6A EC63 3E00             7      LD  A,0     ;セクタ
001F6C EC65 CD6FEB          17      CALL    PUTDAT
       EC69                     FDWT_TRACK  EQU $+1
001F6F EC68 3E00             7      LD  A,0     ;トラック
001F71 EC6A CD6FEB          17      CALL    PUTDAT
001F74 EC6D DD7E0A          19      LD  A,(IX+00AH) ;フロッピーディスクのモード(DPB_0A_FDMODE)
001F77 EC70 CD6FEB          17      CALL    PUTDAT
001F7A EC73 3A06E6          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
001F7D EC76 CD6FEB          17      CALL    PUTDAT
001F80 EC79 79               4      LD  A,C
001F81 EC7A CD6FEB          17      CALL    PUTDAT      ;バイト数H
001F84 EC7D DD7E0C          19      LD  A,(IX+$0C)  ;フロッピーディスクのシリンダ数(DPB_0C_MAXCYL)
001F87 EC80 CD6FEB          17      CALL    PUTDAT
                                
001F8A EC83 3E0D             7      LD  A,0DH       ;エグゼキュート
001F8C EC85 CD66EB          17      CALL    PUTCOM
001F8F EC88 3E7D             7      LD  A,RESULTEX/256
001F91 EC8A CD6FEB          17      CALL    PUTDAT
001F94 EC8D 3E2E             7      LD  A,RESULTEX%256
001F96 EC8F CD6FEB          17      CALL    PUTDAT
                                
001F99 EC92 CD78EB          17      CALL    GETDAT
001F9C EC95 4F               4      LD  C,A
001F9D EC96 FE01             7      CP  1
001F9F EC98 D8              11      RET C
                                
001FA0 EC99 78               4      LD  A,B
001FA1 EC9A B7               4      OR  A
001FA2 EC9B C203EC          10      JP  NZ,FDWT
001FA5 EC9E C9              10      RET
                                
       EC9F                     FDRD:
001FA6 EC9F 7A               4      LD  A,D
001FA7 ECA0 B3               4      OR  E
001FA8 ECA1 200E            12      JR  NZ,FDRD1
                                                ;初期化
001FAA ECA3 AF               4      XOR A       ;イニシャライズ
001FAB ECA4 CD66EB          17      CALL    PUTCOM
001FAE ECA7 3E17             7      LD  A,017H      ;セットサーフィスモード
001FB0 ECA9 CD66EB          17      CALL    PUTCOM
001FB3 ECAC 3E07             7      LD  A,7     ;Bit3～Bit0 0:片面 1:両面
001FB5 ECAE CD6FEB          17      CALL    PUTDAT
       ECB1                     FDRD1:
001FB8 ECB1 3E0D             7      LD  A,0DH       ;エグゼキュート
001FBA ECB3 CD66EB          17      CALL    PUTCOM
001FBD ECB6 3E7C             7      LD  A,READDISKEX/256
001FBF ECB8 CD6FEB          17      CALL    PUTDAT
001FC2 ECBB AF               4      XOR A
001FC3 ECBC CD6FEB          17      CALL    PUTDAT
001FC6 ECBF DD7E13          19      LD  A,(IX+013H) ;デバイスドライバ内におけるユニット番号(DPB_13_UNITNO)
001FC9 ECC2 CD6FEB          17      CALL    PUTDAT
001FCC ECC5 DD7E0D          19      LD  A,(IX+00DH) ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
001FCF ECC8 CD6FEB          17      CALL    PUTDAT
001FD2 ECCB E5              11      PUSH    HL
001FD3 ECCC D5              11      PUSH    DE
001FD4 ECCD CDEBEB          17      CALL    CALC_SECTOR
001FD7 ECD0 7B               4      LD  A,E     ;セクタ
001FD8 ECD1 CD6FEB          17      CALL    PUTDAT
001FDB ECD4 7A               4      LD  A,D     ;トラック
001FDC ECD5 CD6FEB          17      CALL    PUTDAT
001FDF ECD8 DD7E0D          19      LD  A,(IX+00DH) ;フロッピーディスクの1トラックのセクタ数(DPB_0D_MAXSEC)
001FE2 ECDB 93               4      SUB E
001FE3 ECDC 3C               4      INC A
001FE4 ECDD 67               4      LD  H,A
001FE5 ECDE D1              10      POP DE
001FE6 ECDF DD7E0A          19      LD  A,(IX+00AH) ;フロッピーディスクのモード(DPB_0A_FDMODE)
001FE9 ECE2 CD6FEB          17      CALL    PUTDAT
001FEC ECE5 3A06E6          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
001FEF ECE8 CD6FEB          17      CALL    PUTDAT
001FF2 ECEB 4F               4      LD  C,A
001FF3 ECEC AF               4      XOR A
       ECED                     FDRD2:
001FF4 ECED 81               4      ADD A,C
001FF5 ECEE 13               6      INC DE
001FF6 ECEF 05               4      DEC B
001FF7 ECF0 2807            12      JR  Z,FDRD3
001FF9 ECF2 25               4      DEC H       ;トラック、ヘッドを跨がない
001FFA ECF3 2804            12      JR  Z,FDRD3
001FFC ECF5 FE3A             7      CP  03AH        ;バッファとして04000H-07BFFHまで使える
001FFE ECF7 38F4            12      JR  C,FDRD2
       ECF9                     FDRD3:
002000 ECF9 E1              10      POP HL
002001 ECFA 4F               4      LD  C,A
002002 ECFB CD6FEB          17      CALL    PUTDAT      ;バイト数H
002005 ECFE DD7E0C          19      LD  A,(IX+$0C)  ;フロッピーディスクのシリンダ数(DPB_0C_MAXCYL)
002008 ED01 CD6FEB          17      CALL    PUTDAT
                                
00200B ED04 3E0D             7      LD  A,0DH       ;エグゼキュート
00200D ED06 CD66EB          17      CALL    PUTCOM
002010 ED09 3E7D             7      LD  A,RESULTEX/256
002012 ED0B CD6FEB          17      CALL    PUTDAT
002015 ED0E 3E2E             7      LD  A,RESULTEX%256
002017 ED10 CD6FEB          17      CALL    PUTDAT
                                
00201A ED13 CD78EB          17      CALL    GETDAT
00201D ED16 4F               4      LD  C,A
00201E ED17 FE01             7      CP  1
002020 ED19 D8              11      RET C
                                
002021 ED1A 3E15             7      LD  A,15H       ;高速センドメモリ
002023 ED1C CD66EB          17      CALL    PUTCOM
002026 ED1F 3E40             7      LD  A,DSS_DATA/256  ;開始アドレスH
002028 ED21 CD6FEB          17      CALL    PUTDAT
00202B ED24 AF               4      XOR A       ;開始アドレスL
00202C ED25 CD6FEB          17      CALL    PUTDAT
00202F ED28 79               4      LD  A,C     ;バイト数H
002030 ED29 CD6FEB          17      CALL    PUTDAT
002033 ED2C AF               4      XOR A       ;バイト数L
002034 ED2D CD6FEB          17      CALL    PUTDAT
002037 ED30 C5              11      PUSH    BC
002038 ED31 41               4      LD  B,C
002039 ED32 0E00             7      LD  C,0
00203B ED34 CDC3EB          17      CALL    FGETDAT
00203E ED37 C1              10      POP BC
00203F ED38 78               4      LD  A,B
002040 ED39 B7               4      OR  A
002041 ED3A C2B1EC          10      JP  NZ,FDRD1
002044 ED3D C9              10      RET
                                
       EF68                     FDMODE  EQU BEEPD+7
       EF6A                     FSPAT   EQU BEEPD+9
                                
[EOF:88DISK.ASM:UTF_8]
                                
                                    INCLUDE "88TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE キーのテーブル
                                
       ED3E                     AT_TABLE:
002045 ED3E                         DS  TABLEAD-AT_TABLE
       EDC8                     EXTSP:
                                
       EDC8                     KEY_TABLE:
0020CF EDC8 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
0020D7 EDD0 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
0020DF EDD8 4061626364656667        DB  '@','a','b','c','d','e','f','g' ;2
0020E7 EDE0 68696A6B6C6D6E6F        DB  'h','i','j','k','l','m','n','o' ;3
0020EF EDE8 7071727374757677        DB  'p','q','r','s','t','u','v','w' ;4
0020F7 EDF0 78797A5B5C5D5E2D        DB  'x','y','z','[',5CH,']','^','-' ;5
0020FF EDF8 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;6
002107 EE00 38393A3B2C2E2F5C        DB  '8','9',':',';',',','.','/',5CH ;7
00210F EE08 0C1E1C0800000000        DB  0CH,1EH,1CH,08H,00H,00H,00H,00H ;8
002117 EE10 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
00211F EE18 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
002127 EE20 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
00212F EE28 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
                                
       EE30                     SHIFT_TABLE:
002137 EE30 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
00213F EE38 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
002147 EE40 4041424344454647        DB  '@','A','B','C','D','E','F','G' ;2
00214F EE48 48494A4B4C4D4E4F        DB  'H','I','J','K','L','M','N','O' ;3
002157 EE50 5051525354555657        DB  'P','Q','R','S','T','U','V','W' ;4
00215F EE58 58595A7B7C7D7E3D        DB  'X','Y','Z','{','|','}','~','=' ;5
002167 EE60 3021222324252627        DB  '0','!','"','#','$','%','&',27H ;6
00216F EE68 28292A2B3C3E3F5F        DB  '(',')','*','+','<','>','?','_' ;7
002177 EE70 0B1E1C0800000000        DB  0BH,1EH,1CH,08H,00H,00H,00H,00H ;8
00217F EE78 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
002187 EE80 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
00218F EE88 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
002197 EE90 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
                                
       EE98                     CTRL_TABLE:
00219F EE98 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
0021A7 EEA0 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
0021AF EEA8 4001020304050607        DB  '@',01H,02H,03H,04H,05H,06H,07H ;2
0021B7 EEB0 08090A0B0C0D0E0F        DB  08H,09H,0AH,0BH,0CH,0DH,0EH,0FH ;3
0021BF EEB8 1011121314151617        DB  10H,11H,12H,13H,14H,15H,16H,17H ;4
0021C7 EEC0 18191A5B5C5D5E2D        DB  18H,19H,1AH,'[',5CH,']','^','-' ;5
0021CF EEC8 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;6
0021D7 EED0 38393A3B2C2E2F5F        DB  '8','9',':',';',',','.','/','_' ;7
0021DF EED8 0C1E1C0800000000        DB  0CH,1EH,1CH,08H,00H,00H,00H,00H ;8
0021E7 EEE0 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
0021EF EEE8 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
0021F7 EEF0 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
0021FF EEF8 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
[EOF:88TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
       EF00                     AT_WORK:
002207 EF00                         DS  WORKAD-AT_WORK
                                
       EF00                     CPM_BOOT:
002207 EF00 C30000          10      JP  0
       EF03                     _SYS00:     ;(BDOS)プログラム終了
       EF03                     CPM_WBOOT:
00220A EF03 C309D0          10      JP  WBOOT1
       EF06                     CPM_CONST:
00220D EF06 C38CD9          10      JP  CONSTX
       EF09                     _SYS07:     ;(BDOS)コンソール直接入力
       EF09                     CPM_CONIN:
002210 EF09 C344D9          10      JP  FLGET
       EF0C                     CPM_CONOUT:
002213 EF0C C3C7DB          10      JP  CONOUT1
                                
       EF0F                     DECBF:
002216 EF0F                         DS  5
00221B EF14 00                  FDRV    DB  0
00221C EF15                     FNAME   DS  36
002240 EF39                     SFILE:  DS  33      ;DRV FILENAME
002261 EF5A                     HLBUF:  DS  3       ;Random record buffer
                                
002264 EF5D 0000                LEFTX:  DW  0
002266 EF5F 0000                DTAX:   DW  0
                                
       EF61                     ZERO:
       EF61                     BEEPD:
002268 EF61 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
002270 EF69 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
       EF62                     RTC_YY  EQU BEEPD+1
       EF63                     RTC_MW  EQU BEEPD+2
       EF64                     RTC_DD  EQU BEEPD+3
       EF65                     RTC_TT  EQU BEEPD+4
       EF66                     RTC_MM  EQU BEEPD+5
       EF67                     RTC_SS  EQU BEEPD+6
                                
002277 EF70 00                  CHECK:  DB  0
                                
002278 EF71 4F4B24              OK: DB  "OK$"
00227B EF74                         DS  5
002280 EF79 4572726F722124      COMERM: DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
002287 EF80 FF                  _CYL0:  DB  0FFH    ;Cylinder
002288 EF81 FF                  _CYL1:  DB  0FFH    ;Cylinder
002289 EF82 FF                  _CYL2:  DB  0FFH    ;Cylinder
00228A EF83 FF                  _CYL3:  DB  0FFH    ;Cylinder
00228B EF84 00                  _DRIVE: DB  0   ;unit number
00228C EF85 00                  _SEEKSP:DB  0   ;Seek speed
00228D EF86 FF                  _ISEEK: DB  0FFH    ;
00228E EF87 00                  _DVSW:  DB  0
00228F EF88 00                  _DRV:   DB  0
002290 EF89 FF                  _DSK:   DB  0FFH
002291 EF8A 8000                _DTA:   DW  00080H
002293 EF8C 0000                _CTC:   DW  0
002295 EF8E 0000                _TXADR: DW  0
002297 EF90 0000                _KEYPS: DW  0
002299 EF92 00FF                _KEYD:  DW  0FF00H  ;キーデータ
00229B EF94 C210                _KEYSP: DW  010C2H
00229D EF96 00                  _COLORF:DB  COLORF  ;色
00229E EF97 18                  _LINE:  DB  LINE
                                
00229F EF98 0000                _FCB:   DW  0
0022A1 EF9A 0000                _FBPS:  DW  0   ;SEARCH FILES
0022A3 EF9C 0000                _FBAD:  DW  0   ;    //
0022A5 EF9E 00                  _FBCNT: DB  0   ;    //
0022A6 EF9F 00                  _FILEN: DB  0
0022A7 EFA0 00                  _DIRF:  DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
0022A8 EFA1                         DS  1
0022A9 EFA2 00                  _WTFATF:DB  0   ;FATバッファの更新フラグ
0022AA EFA3                         DS  1
0022AB EFA4 00                  _WTDBF: DB  0   ;データバッファの更新フラグ
0022AC EFA5 FF                  _DBDRV: DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
0022AD EFA6 0000                _DBSEC: DW  0   ;データバッファにあるデータを読み込んだセクタ番号
0022AF EFA8 0000                _DPB:   DW  0
       EFAA                     _FATDRV:
0022B1 EFAA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
0022B2 EFAB 00                  _FATIX: DB  0   ;FATバッファに読み込んでいるインデックス
       EFAC                     _FAKEFREE:
0022B3 EFAC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
0022B5 EFAE                         DS  2
                                
       EFB0                     CRTCD:  
0022B7 EFB0 6F                      DB  06FH
       EFB1                     _WIDTH: 
0022B8 EFB1 50                      DB  WIDTH
       EFB2                     TVRAMTOP:
0022B9 EFB2 5938                    DB  059H,038H
0022BB EFB4 1F02                    DB  01FH,002H
       EFB6                     _LINE2:
0022BD EFB6 19                      DB  019H
0022BE EFB7 1C                      DB  01CH
       EFB8                     WKE4:
0022BF EFB8 00                      DB  000H
       EFB9                     WK40:
0022C0 EFB9 07                      DB  007H
       EFBA                     _PAGE_MINUS:
0022C1 EFBA 80F8                    DW  0-WIDTH*LINE
       EFBC                     _WIDTH_MINUS:
0022C3 EFBC B0FF                    DW  0-WIDTH
       EFBE                     WK30:
0022C5 EFBE 0C                      DB  00CH
       EFBF                     WK31:
       EFBF                     WK1FD0:
0022C6 EFBF 20                      DB  020H
                                
0022C7 EFC0 0000                CTC0:   DW  INTCTCE
0022C9 EFC2 0000                CTC1:   DW  INTCTCE
0022CB EFC4 0000                CTC2:   DW  INTCTC2
0022CD EFC6 0000                CTC3:   DW  INTCTCE
0022CF EFC8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
0022D1 EFCA C303DD          10  _INKEY: JP  INKEY
0022D4 EFCD C3C5DA          10  _PRINT: JP  PRINT
0022D7 EFD0 C38EDD          10  _SCRN:  JP  SCRN
0022DA EFD3 C3A5DC          10  _POS:   JP  POS
0022DD EFD6 C30DDB          10  _LOC:   JP  LOC
       EFD9                     _CHGDRV:
0022E0 EFD9 C361EA          10      JP  CHGDRV
       EFDC                     _GETDPB:
0022E3 EFDC C32DEB          10      JP  GETDPB
       EFDF                     _FFLUSH:
0022E6 EFDF C34BEB          10      JP  FFLUSH
       EFE2                     _RDFATX:
0022E9 EFE2 C366E7          10      JP  RDFATX
0022EC EFE5 C38EE8          10  _RDFAT: JP  RDFAT
0022EF EFE8 C301EC          10  _WTTRK: JP  WTTRK
0022F2 EFEB C39FEC          10  _FDRD:  JP  FDRD
0022F5 EFEE C303EC          10  _FDWT:  JP  FDWT
       EFF1                     _BPB2DPB:
0022F8 EFF1 C3F3E8          10      JP  BPB2DPB
0022FB EFF4                         DS  3
       EFF7                     _GNCL:
0022FE EFF7 C308E8          10  GNCPAT: JP  GNCL        ; self-modifying code
       EFFA                     _SNCL:
002301 EFFA C32BE8          10  SNCPAT: JP  SNCL        ; self-modifying code
002304 EFFD C34CD0          10  _COMANL:JP  COMANL
                                
       F000                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F000                     STABLE:
                                ;0
002307 F000 03EF18D924D9C5DF        DW  _SYS00,_SYS01,_SYS02,_SYS03
00230F F008 23D623D629D909EF        DW  _SYS04,_SYS05,_SYS06,_SYS07
002317 F010 31D925D658D984D9        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
00231F F018 3AD63FD64ED661D6        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
002327 F020 B5D6FCD645D77BD7        DW  _SYS10,_SYS11,_SYS12,_SYS13
00232F F028 83D7A1D7BED7B6D7        DW  _SYS14,_SYS15,_SYS16,_SYS17
002337 F030 19D81ED823D829D8        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
00233F F038 23D64FD823D653D8        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
002347 F040 23D6F5D707D85AD8        DW  _SYS20,_SYS21,_SYS22,_SYS23
00234F F048 86D823D619E4FEE4        DW  _SYS24,_ERROR,_SYS26,_SYS27
002357 F050 07D88FD89DD9C5DF        DW  _SYS28,_SYS5C,_SYS2A,_SYS2B
00235F F058 C4D9C5DF23D6B2D8        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
002367 F060 ACD823D623D623D6        DW  _SYS30,_ERROR,_ERROR,_ERROR
00236F F068 23D623D623D623D6        DW  _ERROR,_ERROR,_ERROR,_ERROR
002377 F070 23D6C5DFC5DFD3D8        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
00237F F078 06D6                    DW  _DOS2
                                
002381 F07A                         DS  2
002383 F07C 00F2                _FATBF: DW  FATBF
002385 F07E 00FA                _DTBUF: DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F080                     CTRLTB:
002387 F080 10DB10DB47DB50DC        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
00238F F088 4ADC72DB23DCEFDB        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002397 F090 17DB3CDB53DC9EDB        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
00239F F098 20DC91DB5ADC10DB        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
0023A7 F0A0 10DB10DB96DB10DB        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
0023AF F0A8 10DB10DB10DB10DB        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
0023B7 F0B0 10DB10DB20DCA5DB        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
0023BF F0B8 F9DA1EDB33DB53DC        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
0023C7 F0C0                         DS  02AH
                                
0023F1 F0EA 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
0023F3 F0EC 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
0023F5 F0EE 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
0023F7 F0F0 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F0F4                     SDDATAE:
                                
0023FB F0F4                     SCDIR:  DS  2       ;+14 +15
0023FD F0F6                     SFBPS:  DS  2       ;FBPS
0023FF F0F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
002401 F0FA 0000                _FATPS: DW  0
002403 F0FC 0000                _DIRPS: DW  0
002405 F0FE 0000                _CLPS:  DW  0
                                
       F100                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "88DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   PC-8801mkIISR
                                
       F100                     DEVICE:
                                
                                ;   A:
                                
002407 F100 0200                    DW  2   ;DPB_00_FATLN
002409 F102 EBEF                    DW  _FDRD   ;DPB_02_DRD
00240B F104 EEEF                    DW  _FDWT   ;DPB_04_DWT
00240D F106 FD                      DB  0FDH    ;DPB_06_FATID
00240E F107 02                      DB  2   ;DPB_07_SECPCL
00240F F108 6401                    DW  356 ;DPB_08_MAXCL
002411 F10A FF                      DB  0FFH    ;DPB_0A_FDMODE  0FFH=2D / 0FEH=2HD
002412 F10B 07                      DB  7   ;DPB_0B_DIRSCNT
002413 F10C 28                      DB  40  ;DPB_0C_MAXCYL
002414 F10D 09                      DB  9   ;DPB_0D_MAXSEC  Number of sectors
002415 F10E 01                      DB  1   ;DPB_0E_FATPS
002416 F10F 82                      DB  082H    ;DPB_0F_BPS
002417 F110 0500                    DW  5   ;DPB_10_DIRPS
002419 F112 A7                      DB  0A7H    ;DPB_12_DEVICE  Device Number
00241A F113 00                      DB  0   ;DPB_13_UNITNO
00241B F114 0800                    DW  8   ;DPB_14_ADDCL16
00241D F116 0000                    DW  0   ;DPB_16
00241F F118 0000                    DW  0   ;DPB_18
002421 F11A 0000                    DW  0   ;DPB_1A_SDIR
002423 F11C 46444430                DB  "FDD0"  ;DPB_1C_NAME
                                
                                ;   B:
                                
002427 F120 0200                    DW  2   ;DPB_00_FATLN
002429 F122 EBEF                    DW  _FDRD   ;DPB_02_DRD
00242B F124 EEEF                    DW  _FDWT   ;DPB_04_DWT
00242D F126 FD                      DB  0FDH    ;DPB_06_FATID
00242E F127 02                      DB  2   ;DPB_07_SECPCL
00242F F128 6401                    DW  356 ;DPB_08_MAXCL
002431 F12A FF                      DB  0FFH    ;DPB_0A_FDMODE  0FFH=2D / 0FEH=2HD
002432 F12B 07                      DB  7   ;DPB_0B_DIRSCNT
002433 F12C 28                      DB  40  ;DPB_0C_MAXCYL
002434 F12D 09                      DB  9   ;DPB_0D_MAXSEC  Number of sectors
002435 F12E 01                      DB  1   ;DPB_0E_FATPS
002436 F12F 82                      DB  082H    ;DPB_0F_BPS
002437 F130 0500                    DW  5   ;DPB_10_DIRPS
002439 F132 A7                      DB  0A7H    ;DPB_12_DEVICE  Device Number
00243A F133 01                      DB  1   ;DPB_13_UNITNO
00243B F134 0800                    DW  8   ;DPB_14_ADDCL16
00243D F136 0000                    DW  0   ;DPB_16
00243F F138 0000                    DW  0   ;DPB_18
002441 F13A 0000                    DW  0   ;DPB_1A_SDIR
002443 F13C 46444431                DB  "FDD1"  ;DPB_1C_NAME
                                
                                ;   C:
                                
002447 F140                         DS  32
                                
                                ;   D:
                                
002467 F160                         DS  32
                                
                                ;   E:
                                
002487 F180                         DS  32
                                
                                ;   F:
                                
0024A7 F1A0 0000                BANKFL: DW  0   ;DPB_00_FATLN
0024A9 F1A2 9CD5                    DW  BDRD    ;DPB_02_DRD
0024AB F1A4 98D5                    DW  BDWT    ;DPB_04_DWT
0024AD F1A6 F9                      DB  0F9H    ;DPB_06_FATID
0024AE F1A7 02                      DB  2   ;DPB_07_SECPCL
0024AF F1A8 0000                BANKCL: DW  0   ;DPB_08_MAXCL
0024B1 F1AA 00                      DB  0   ;DPB_0A_FDMODE
0024B2 F1AB 08                      DB  8   ;DPB_0B_DIRSCNT
0024B3 F1AC 00                      DB  0   ;DPB_0C_MAXCYL
0024B4 F1AD 01                      DB  1   ;DPB_0D_MAXSEC
0024B5 F1AE 00                      DB  0   ;DPB_0E_FATPS
0024B6 F1AF 02                      DB  2   ;DPB_0F_BPS
0024B7 F1B0 0200                    DW  2   ;DPB_10_DIRPS
0024B9 F1B2 0B                      DB  00BH    ;DPB_12_DEVICE
0024BA F1B3 00                      DB  0   ;DPB_13_UNITNO
0024BB F1B4 0600                    DW  6   ;DPB_14_ADDCL16
0024BD F1B6 0000                    DW  0   ;DPB_16
0024BF F1B8 0000                    DW  0   ;DPB_18
0024C1 F1BA 0000                    DW  0   ;DPB_1A_SDIR
0024C3 F1BC 454D454D                DB  "EMEM"  ;DPB_1C_NAME
                                
                                ;   G:
                                
0024C7 F1C0                         DS  32
                                
                                ;   H:
0024E7 F1E0                         DS  32-8
0024FF F1F8 00                      DB  0
[EOF:88DPB.ASM:UTF_8]
                                
       F1F9                     LAST_ADR:
                                
                                    END
[EOF:88.ASM:UTF_8]
