                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   LSX-Dodgers for PC-8801mkIISR
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "88DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   PC-8001mkIISR
                                
       0002                     MAC EQU 2   ;PC-8001mkIISR
       0001                     DEV EQU 1
                                
       011D                     VER_6F  EQU 0011DH
                                
       CE00                     RUN EQU 0CE00H
       CDF9                     OFFSET  EQU RUN-7
                                
       D206                     BDOS    EQU 0D206H
       EE00                     INTAD   EQU 0EE00H
       EF00                     WORKAD  EQU 0EF00H
       F300                     FATBF   EQU 0F300H
       FB00                     DTBUF   EQU 0FB00H
       FF00                     KEYBF   EQU 0FF00H
       FF20                     KBUF    EQU 0FF20H
       FFBB                     SUBSYS  EQU EXTBIO-5*3
       FFD9                     TRAP38  EQU 0FFD9H
       0050                     WIDTH   EQU 80
       0018                     LINE    EQU 24
       0000                     COLORF  EQU 0
       0010                     KEYSP_H EQU 16
       0000                     KEYSP_L EQU 0
       0008                     COMS    EQU 8
                                
                                ; ディスクサブシステム
       002A                     MAIN        EQU 0002AH
                                
       4000                     DSS_DATA    EQU 04000H
                                
       7C00                     DSS     EQU 07C00H
[EOF:88DEF.ASM:SHIFT_JIS]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0005                     VER_2   EQU 5
       0009                     VER_3   EQU 9
       1D02                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0102                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0159                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 CDF9                         ORG OFFSET
                                
                                ;   MSX BINARY HEADER
000000 CDF9 FE                      DB  0FEH
                                ;   MSX BINARY START ADDRESS
000001 CDFA 00CE                    DW  RUN
                                ;   MSX BINARY END ADDRESS
000003 CDFC F9F2                    DW  LAST_ADR
                                ;   MSX BINARY EXEC ADDRESS
000005 CDFE 07CE                    DW  START
                                
                                    INCLUDE "88INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   PC-8801mkIISR
                                
000007 CE00 C307CE          10      JP  START
00000A CE03 021D                    DW  MACW
00000C CE05 5901                    DW  VER
                                
       CE07                     START:
00000E CE07 F3               4      DI
00000F CE08 ED5E             8      IM  2
000011 CE0A 3107CE          10      LD  SP,START
000014 CE0D CD1BCE          17      CALL    INIT        ;NZならAUTOEXECを実行
000017 CE10 210000          10      LD  HL,0
00001A CE13 E5              11      PUSH    HL
00001B CE14 C8              11      RET Z
00001C CE15 1137CF          10      LD  DE,AUTOD
00001F CE18 C3FDEF          10      JP  _COMANL
                                
       CE1B                     INIT:
000022 CE1B DB32            11      IN  A,(032H)
000024 CE1D CBA7             8      RES 4,A     ;高速RAMアクセスモード
000026 CE1F D332            11      OUT (032H),A
                                
000028 CE21 21C8F3          10      LD  HL,0F3C8H   ;テキストをクリア
00002B CE24 11E880          10      LD  DE,080E8H
00002E CE27 0E20             7      LD  C,' '
000030 CE29 3E19             7      LD  A,25
       CE2B                     TVCL1:
000032 CE2B 0650             7      LD  B,80
       CE2D                     TVCL2:
000034 CE2D 71               7      LD  (HL),C
000035 CE2E 23               6      INC HL
000036 CE2F 10FC            13      DJNZ    TVCL2
000038 CE31 0614             7      LD  B,20
       CE33                     TVCL3:
00003A CE33 72               7      LD  (HL),D
00003B CE34 2C               4      INC L
00003C CE35 73               7      LD  (HL),E
00003D CE36 23               6      INC HL
00003E CE37 10FA            13      DJNZ    TVCL3
000040 CE39 3D               4      DEC A
000041 CE3A 20EF            12      JR  NZ,TVCL1
                                
000043 CE3C DB32            11      IN  A,(032H)
000045 CE3E F610             7      OR  010H        ;高速RAMアクセスモードOFF
000047 CE40 D332            11      OUT (032H),A
                                
000049 CE42 AF               4      XOR A
00004A CE43 32B8EF          13      LD  (WKE6),A
00004D CE46 2F               4      CPL
00004E CE47 32B7EF          13      LD  (WKE4),A
                                
000051 CE4A CD32DE          17      CALL    INIT_CRTC
       CE4D                     BANK:
000054 CE4D 01E300          10      LD  BC,000E3H   ;拡張RAM バンク選択
000057 CE50 21007F          10      LD  HL,07F00H
00005A CE53 56               7      LD  D,(HL)
00005B CE54 F3               4      DI
00005C CE55 3E01             7      LD  A,1     ;リード可
00005E CE57 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000060 CE59 ED41            12      OUT (C),B       ;拡張RAM バンク選択
000062 CE5B 3A0000          13      LD  A,(0)
000065 CE5E FEEB             7      CP  0EBH
000067 CE60 2005            12      JR  NZ,BANK1
000069 CE62 3E2B             7      LD  A,02BH
00006B CE64 32B2F2          13      LD  (BANKDV),A
       CE67                     BANK1:
00006E CE67 3E01             7      LD  A,1     ;リード可
000070 CE69 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000072 CE6B ED41            12      OUT (C),B       ;拡張RAM バンク選択
000074 CE6D 5E               7      LD  E,(HL)
000075 CE6E 7B               4      LD  A,E
000076 CE6F C6A5             7      ADD A,0A5H
000078 CE71 77               7      LD  (HL),A      ;メインメモリに書き込む
000079 CE72 BE               7      CP  (HL)
00007A CE73 2811            12      JR  Z,BANK2     ;メインメモリが反映されているか？
00007C CE75 3E11             7      LD  A,011H      ;ライト/リード可
00007E CE77 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000080 CE79 7B               4      LD  A,E
000081 CE7A C6A5             7      ADD A,0A5H
000083 CE7C 77               7      LD  (HL),A
000084 CE7D BE               7      CP  (HL)
000085 CE7E 73               7      LD  (HL),E      ;拡張RAM に元の値を戻す
000086 CE7F 2005            12      JR  NZ,BANK2    ;拡張RAM に反映しているか？
000088 CE81 04               4      INC B
000089 CE82 CB60             8      BIT 4,B
00008B CE84 28E1            12      JR  Z,BANK1
       CE86                     BANK2:
00008D CE86 AF               4      XOR A       ;ライト/リード不可
00008E CE87 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000090 CE89 72               7      LD  (HL),D      ;メインメモリ に元の値を戻す
000091 CE8A 78               4      LD  A,B
000092 CE8B B7               4      OR  A
000093 CE8C 2814            12      JR  Z,NOBANK
000095 CE8E 68               4      LD  L,B
000096 CE8F 2600             7      LD  H,0
000098 CE91 29              11      ADD HL,HL   ;*2
000099 CE92 29              11      ADD HL,HL   ;*4
00009A CE93 29              11      ADD HL,HL   ;*8
00009B CE94 29              11      ADD HL,HL   ;*16
00009C CE95 29              11      ADD HL,HL   ;*32
00009D CE96 2B               6      DEC HL  ;-1
00009E CE97 2B               6      DEC HL  ;-2
00009F CE98 2B               6      DEC HL  ;-3
0000A0 CE99 22A8F2          16      LD  (BANKCL),HL
0000A3 CE9C CD27CF          17      CALL    CALC_FATLN
0000A6 CE9F 32A0F2          13      LD  (BANKFL),A
       CEA2                     NOBANK:
                                                ;初期化
0000A9 CEA2 AF               4      XOR A       ;イニシャライズ
0000AA CEA3 CD1CEC          17      CALL    PUTCOM
0000AD CEA6 3E16             7      LD  A,16H       ;高速レシーブメモリ
0000AF CEA8 CD1CEC          17      CALL    PUTCOM
0000B2 CEAB 3E7C             7      LD  A,DSS/256   ;開始アドレスH
0000B4 CEAD CD22EC          17      CALL    PUTDAT
0000B7 CEB0 AF               4      XOR A       ;開始アドレスL
0000B8 CEB1 CD22EC          17      CALL    PUTDAT
0000BB CEB4 015102          10      LD  BC,AT_DSSE-AT_DSS
0000BE CEB7 CB41             8      BIT 0,C
0000C0 CEB9 2801            12      JR  Z,SUBPG1
0000C2 CEBB 03               6      INC BC      ;偶数にする
       CEBC                     SUBPG1:
0000C3 CEBC 78               4      LD  A,B     ;バイト数H
0000C4 CEBD CD22EC          17      CALL    PUTDAT
0000C7 CEC0 79               4      LD  A,C
0000C8 CEC1 CD22EC          17      CALL    PUTDAT
0000CB CEC4 21B4CF          10      LD  HL,AT_DSS
0000CE CEC7 CD66EC          17      CALL    FPUTDAT
                                
0000D1 CECA 210000          10      LD  HL,0
0000D4 CECD 065C             7      LD  B,05CH
0000D6 CECF 3E                      DB  03EH    ;LD A,??
0000D7 CED0 FF              12      RST 38H
0000D8 CED1 CD62DF          17      CALL    FILL_MEMORY
0000DB CED4 06A4             7      LD  B,0A4H
0000DD CED6 AF               4      XOR A
0000DE CED7 CD62DF          17      CALL    FILL_MEMORY
                                
0000E1 CEDA 3EC3             7      LD  A,0C3H      ;JP
0000E3 CEDC 2103EF          10      LD  HL,CPM_WBOOT
0000E6 CEDF 320000          13      LD  (00000H),A
0000E9 CEE2 220100          16      LD  (00001H),HL ;IPL
                                
0000EC CEE5 21021D          10      LD  HL,MACW     ;3 bit7  DPB Compatible LA(1)
0000EF CEE8 220300          16      LD  (00003H),HL ;  bit6-0 Machine
                                ;               ;4 LSX-Dodgers(01DH)
0000F2 CEEB 2106D2          10      LD  HL,BDOS
0000F5 CEEE 320500          13      LD  (00005H),A
0000F8 CEF1 220600          16      LD  (00006H),HL ;BDOS
                                
0000FB CEF4 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000FE CEF7 323800          13      LD  (00038H),A
000101 CEFA 223900          16      LD  (00039H),HL ;RST 038H
                                
000104 CEFD 3EEF             7      LD  A,CPM_BOOT/256
000106 CEFF 320B00          13      LD  (0000BH),A
                                
000109 CF02 3E                      DB  03EH    ;LD A,??
00010A CF03 E9               4      JP  (HL)
00010B CF04 320F00          13      LD  (0000FH),A
                                
00010E CF07 2143CF          10      LD  HL,INIMES
000111 CF0A CDE1D6          17      CALL    MSX
       CF0D                     INIT1:
000114 CF0D F3               4      DI
000115 CF0E 1100FF          10      LD  DE,0FF00H
000118 CF11 06BB             7      LD  B,SUBSYS%256
00011A CF13 CD40D5          17      CALL    ZERO_MEMORY_DE
                                
00011D CF16 216FCF          10      LD  HL,AT_SUBSYS
000120 CF19 11BBFF          10      LD  DE,SUBSYS
000123 CF1C 014500          10      LD  BC,AT_TRAPE-AT_SUBSYS
000126 CF1F EDB0                    LDIR
                                
000128 CF21 CDD1DD          17      CALL    CHKEY
00012B CF24 FE03             7      CP  3
00012D CF26 C9              10      RET
                                
       CF27                     CALC_FATLN: ;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
00012E CF27 5D               4      LD  E,L
00012F CF28 54               4      LD  D,H
000130 CF29 29              11      ADD HL,HL   ;*2
000131 CF2A 19              11      ADD HL,DE   ;*3
000132 CF2B CB3C             8      SRL H   ;/2
000134 CF2D CB1D             8      RR  L   ;1クラスタ辺り1.5バイト必要
000136 CF2F 11FF01          10      LD  DE,511  ;切り上げる
000139 CF32 19              11      ADD HL,DE
00013A CF33 7C               4      LD  A,H
00013B CF34 CB3F             8      SRL A
00013D CF36 C9              10      RET
                                
00013E CF37 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000147 CF40 413A00              AUTODV: DB  "A:",0
                                
00014A CF43 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for PC-8801mkIISR v"
            6765727320666F72    
            2050432D38383031    
            6D6B494953522076    
00016A CF63 312E                    DB  030H + VER_1, '.'
00016C CF65 3539                    DB  030H + VER_2 ,030H + VER_3
                                ;   DB  ""
00016E CF67 2047616B750D0A          DB  ' Gaku',0DH,0AH
000175 CF6E 00                      DB  0
                                
       CF6F                     AT_SUBSYS:
000176 FFBB                         ORG SUBSYS,AT_SUBSYS-OFFSET
000176 FFBB C31CEC          10      JP  PUTCOM
000179 FFBE C322EC          10      JP  PUTDAT
00017C FFC1 C347EC          10      JP  GETDAT
00017F FFC4 C366EC          10      JP  FPUTDAT
000182 FFC7 C391EC          10      JP  FGETDAT
                                ;EXTBIO
000185 FFCA C9              10      RET
000186 FFCB                         DS  14,0FFH
                                ;TRAP38:
000194 FFD9 210000          10      LD  HL,0
000197 FFDC E3              19      EX  (SP),HL
000198 FFDD 3E24             7      LD  A,'$'
00019A FFDF CDD5D9          17      CALL    MSG_A
00019D FFE2 2B               6      DEC HL
00019E FFE3 7C               4      LD  A,H
00019F FFE4 CDE8FF          17      CALL    PRHX
0001A2 FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
0001A3 FFE8 F5              11      PUSH    AF
0001A4 FFE9 07               4      RLCA
0001A5 FFEA 07               4      RLCA
0001A6 FFEB 07               4      RLCA
0001A7 FFEC 07               4      RLCA
0001A8 FFED CDF1FF          17      CALL    PRHX2
0001AB FFF0 F1              10      POP AF
       FFF1                     PRHX2:
0001AC FFF1 E60F             7      AND 00FH
0001AE FFF3 FE0A             7      CP  10
0001B0 FFF5 3F               4      CCF
0001B1 FFF6 CE30             7      ADC A,'0'
0001B3 FFF8 27               4      DAA
0001B4 FFF9 C3D5D9          10      JP  MSG_A
0001B7 FFFC                         DS  4
0001BB CFB4                         ORG $$+OFFSET   ;$DEPHASE
       CFB4                     AT_TRAPE:
[EOF:88INIT.ASM:SHIFT_JIS]
                                    INCLUDE "88SUB.ASM"
                                
                                ;   LSX-Dodgers SUB DISK SYSTEM
                                ;   PC-8801mkIISR
                                
       CFB4                     AT_DSS:
0001BB 7C00                         ORG DSS,AT_DSS-OFFSET
0001BB 7C00 C3437C          10      JP  READDISKEX
0001BE 7C03 C3A37C          10      JP  WRITEDISKEX
0001C1 7C06 C3BB7C          10      JP  GETPARAMS_N
0001C4 7C09 C3C67C          10      JP  SEEK
0001C7 7C0C C3547D          10      JP  FDCOMMAND
0001CA 7C0F C3207E          10      JP  CHECKRESULT
0001CD 7C12 C3427E          10      JP  GETDEVSTAT
0001D0 7C15 C3477E          10      JP  RDFDC
                                
0001D3 7C18                         DS  8*3
                                
       7C30                     S_PARAMS:
0001EB 7C30                         DS  16
       7C30                     S_UNITNO    EQU S_PARAMS    ;ユニット番号 0:ドライブA 1:ドライブB
       7C31                     S_DPS       EQU S_PARAMS+1  ;1トラックのセクタ数
       7C32                     S_SECTOR_R  EQU S_PARAMS+2  ;セクタ番号
       7C33                     S_TRACK     EQU S_PARAMS+3  ;トラック番号
       7C34                     S_FDMODE    EQU S_PARAMS+4  ;FDモード切り替え $FF:2D/2DD $FE:2HD
       7C35                     S_SECSIZE_N EQU S_PARAMS+5  ;N セクタサイズ
       7C36                     S_BYTE_H    EQU S_PARAMS+6  ;バイト数H
       7C37                     S_MAXCL     EQU S_PARAMS+7  ;シリンダ数
                                
       7C40                     S_CMD_STATUS:
0001FB 7C40 00                      DB  0
       7C41                     S_LEFT:
0001FC 7C41 00                      DB  0
       7C42                     S_WKF4:
0001FD 7C42 00                      DB  0
                                
       7C43                     READDISKEX:
0001FE 7C43 CDB97C          17      CALL    GETPARAMS
000201 7C46 AF               4      XOR A
000202 7C47 327A7C          13      LD  (RETRY_RDDISK),A
000205 7C4A 2A327C          16      LD  HL,(S_PARAMS+2)
000208 7C4D 7D               4      LD  A,L
000209 7C4E 3D               4      DEC A
00020A 7C4F B4               4      OR  H
00020B 7C50 200C            12      JR  NZ,RDDISK0
00020D 7C52 2A357C          16      LD  HL,(S_PARAMS+5)
000210 7C55 7C               4      LD  A,H
000211 7C56 BD               4      CP  L
000212 7C57 2005            12      JR  NZ,RDDISK0
000214 7C59 3E03             7      LD  A,3
000216 7C5B 327A7C          13      LD  (RETRY_RDDISK),A
       7C5E                     RDDISK0:
000219 7C5E CDC67C          17      CALL    SEEK
00021C 7C61 3E46             7      LD  A,46H       ;READ DATA
00021E 7C63 CD547D          17      CALL    FDCOMMAND
000221 7C66 3834            12      JR  C,FINISH_DISK
000223 7C68 CD857D          17      CALL    RDDISK1
       7C6B                     WRDISK3:
000226 7C6B 78               4      LD  A,B
000227 7C6C B2               4      OR  D
000228 7C6D 32417C          13      LD  (S_LEFT),A
00022B 7C70 DBF8            11      IN  A,(0F8H)    ;FDC μPD765A TC入力
00022D 7C72 FB               4      EI
00022E 7C73 76               4      HALT
00022F 7C74 CD207E          17      CALL    CHECKRESULT
000232 7C77 301D            12      JR  NC,FINISH_DISK0
       7C7A                     RETRY_RDDISK    EQU $+1
000234 7C79 3E00             7      LD  A,0
000236 7C7B B7               4      OR  A
000237 7C7C 2818            12      JR  Z,FINISH_DISK0
000239 7C7E 3D               4      DEC A
00023A 7C7F 327A7C          13      LD  (RETRY_RDDISK),A
00023D 7C82 3A357C          13      LD  A,(S_PARAMS+5)
000240 7C85 FE04             7      CP  4
000242 7C87 3003            12      JR  NC,RETRY_RDDISK1
000244 7C89 87               4      ADD A,A
000245 7C8A 1802            12      JR  RETRY_RDDISK2
       7C8C                     RETRY_RDDISK1:
000247 7C8C 3E01             7      LD  A,1
       7C8E                     RETRY_RDDISK2:
000249 7C8E 67               4      LD  H,A
00024A 7C8F 6F               4      LD  L,A
00024B 7C90 22357C          16      LD  (S_PARAMS+5),HL
00024E 7C93 C35E7C          10      JP  RDDISK0
       7C96                     FINISH_DISK0:
000251 7C96 3A417C          13      LD  A,(S_LEFT)
000254 7C99 D601             7      SUB 1
000256 7C9B 3F               4      CCF
       7C9C                     FINISH_DISK:
000257 7C9C 9F               4      SBC A,A
000258 7C9D 32407C          13      LD  (S_CMD_STATUS),A
00025B 7CA0 C32A00          10      JP  MAIN
                                
       7CA3                     WRITEDISKEX:
00025E 7CA3 AF               4      XOR A
00025F 7CA4 327A7C          13      LD  (RETRY_RDDISK),A
000262 7CA7 CDB97C          17      CALL    GETPARAMS
000265 7CAA CDC67C          17      CALL    SEEK
000268 7CAD 3E45             7      LD  A,45H       ;WRITE DATA
00026A 7CAF CD547D          17      CALL    FDCOMMAND
00026D 7CB2 38E8            12      JR  C,FINISH_DISK
00026F 7CB4 CDCC7D          17      CALL    WRDISK1
000272 7CB7 18B2            12      JR  WRDISK3
                                
       7CB9                     GETPARAMS:
000274 7CB9 0608             7      LD  B,8
       7CBB                     GETPARAMS_N:
000276 7CBB E5              11      PUSH    HL
000277 7CBC 21307C          10      LD  HL,S_PARAMS
       7CBF                     GETPARAMS1:
00027A 7CBF D7              12      RST 10H
00027B 7CC0 77               7      LD  (HL),A
00027C 7CC1 23               6      INC HL
00027D 7CC2 10FB            13      DJNZ    GETPARAMS1
00027F 7CC4 E1              10      POP HL
000280 7CC5 C9              10      RET
                                
       7CC6                     SEEK:
000281 7CC6 E5              11      PUSH    HL
000282 7CC7 3A347C          13      LD  A,(S_FDMODE)    ;FDモード切り替え $FF:2D/2DD $FE:2HD
000285 7CCA 1F               4      RRA
000286 7CCB 3F               4      CCF
000287 7CCC 9F               4      SBC A,A
000288 7CCD F5              11      PUSH    AF
000289 7CCE E605             7      AND 5
00028B 7CD0 4F               4      LD  C,A
00028C 7CD1 3A377C          13      LD  A,(S_MAXCL) ;シリンダ数
00028F 7CD4 C6D3             7      ADD A,0-45      ;オーバートラックを考慮して40+α
000291 7CD6 9F               4      SBC A,A
000292 7CD7 E604             7      AND 4
000294 7CD9 B1               4      OR  C
000295 7CDA 0EFA             7      LD  C,0FFH-5    ;マスク
000297 7CDC 47               4      LD  B,A
000298 7CDD 3A307C          13      LD  A,(S_UNITNO)    ;0:ドライブA 1:ドライブB
00029B 7CE0 B7               4      OR  A
00029C 7CE1 2804            12      JR  Z,SET_WKF4
00029E 7CE3 CB20             8      SLA B
0002A0 7CE5 CB01             4      RLC C
       7CE7                     SET_WKF4:
0002A2 7CE7 3A427C          13      LD  A,(S_WKF4)
0002A5 7CEA A1               4      AND C
0002A6 7CEB B0               4      OR  B
0002A7 7CEC 4F               4      LD  C,A
0002A8 7CED D3F4            11      OUT (0F4H),A    ;ドライブ制御
0002AA 7CEF E6DF             7      AND 0FFH-020H   ;CLKの分は抜いておく
0002AC 7CF1 47               4      LD  B,A
0002AD 7CF2 F1              10      POP AF
0002AE 7CF3 E620             7      AND 020H        ;bit5:CLK
0002B0 7CF5 B0               4      OR  B
0002B1 7CF6 D3F4            11      OUT (0F4H),A    ;ドライブ制御
0002B3 7CF8 32427C          13      LD  (S_WKF4),A
0002B6 7CFB 47               4      LD  B,A
0002B7 7CFC A9               4      XOR C
0002B8 7CFD E620             7      AND 020H        ;CLKが変化したら一定時間待つ
0002BA 7CFF 2808            12      JR  Z,NOCHGCLK
0002BC 7D01 2160F0          10      LD  HL,0F060H
       7D04                     WAIT_CLK:
0002BF 7D04 2B               6      DEC HL
0002C0 7D05 7C               4      LD  A,H
0002C1 7D06 B5               4      OR  L
0002C2 7D07 20FB            12      JR  NZ,WAIT_CLK
       7D09                     NOCHGCLK:
0002C4 7D09 78               4      LD  A,B
0002C5 7D0A E620             7      AND 020H
0002C7 7D0C 2805            12      JR  Z,SPECIFY2D
0002C9 7D0E 1131DF          10      LD  DE,0DF31H   ;SPECIFY 2HD / SRT:13 HUT:15 HLT:24 NON-DMA
0002CC 7D11 1803            12      JR  SPECIFYOK
       7D13                     SPECIFY2D:
0002CE 7D13 1119DA          10      LD  DE,0DA19H   ;SPECIFY 2D/2DD / SRT:13 HUT 10 HLT:12 NON-DMA
       7D16                     SPECIFYOK:
0002D1 7D16 3E03             7      LD  A,3     ;SPECIFY
0002D3 7D18 E7              12      RST 20H
0002D4 7D19 7A               4      LD  A,D
0002D5 7D1A E7              12      RST 20H
0002D6 7D1B 7B               4      LD  A,E
0002D7 7D1C E7              12      RST 20H
       7D1D                     NOSPECIFY:
0002D8 7D1D ED4B307C        20      LD  BC,(S_PARAMS)
0002DC 7D21 ED5B327C        20      LD  DE,(S_PARAMS+2)
0002E0 7D25 7A               4      LD  A,D     ;TRACK
0002E1 7D26 CB3F             8      SRL A       ;CYLINDER
0002E3 7D28 3E0F             7      LD  A,00FH      ;SEEK
0002E5 7D2A 2002            12      JR  NZ,SEEK1    ;0シリンダの場合はRECALIBRATE、それ以外はSEEKを使う
0002E7 7D2C 3E07             7      LD  A,7     ;RECALIBRATE
       7D2E                     SEEK1:
0002E9 7D2E E7              12      RST 20H
0002EA 7D2F 79               4      LD  A,C     ;DR/HD
0002EB 7D30 E7              12      RST 20H
0002EC 7D31 7A               4      LD  A,D     ;TRACK
0002ED 7D32 CB3F             8      SRL A       ;CYLINDER
0002EF 7D34 C42000          17      CALL    NZ,20H      ;SEEKの場合だけ呼ぶ(0シリンダの場合はRECALIBRATEを使うのでシリンダの設定は不要)
0002F2 7D37 FB               4      EI
0002F3 7D38 76               4      HALT
0002F4 7D39 3E08             7      LD  A,8     ;SENSE
0002F6 7D3B E7              12      RST 20H
0002F7 7D3C CD477E          17      CALL    RDFDC       ;ST0
0002FA 7D3F CD477E          17      CALL    RDFDC       ;PCN(CYLINDER)
0002FD 7D42 210040          10      LD  HL,04000H
       7D45                     WAIT_SEEK:
000300 7D45 CD427E          17      CALL    GETDEVSTAT
000303 7D48 E608             7      AND 8
000305 7D4A 2006            12      JR  NZ,SEEK_OK
000307 7D4C 2B               6      DEC HL
000308 7D4D 7C               4      LD  A,H
000309 7D4E B5               4      OR  L
00030A 7D4F 20F4            12      JR  NZ,WAIT_SEEK
00030C 7D51 37               4      SCF
       7D52                     SEEK_OK:
00030D 7D52 E1              10      POP HL
00030E 7D53 C9              10      RET
                                
       7D54                     FDCOMMAND:
00030F 7D54 E7              12      RST 20H
000310 7D55 7A               4      LD  A,D     ;HD US1 US0
000311 7D56 E601             7      AND 1
000313 7D58 87               4      ADD A,A
000314 7D59 87               4      ADD A,A
000315 7D5A B1               4      OR  C
000316 7D5B E7              12      RST 20H
000317 7D5C 7A               4      LD  A,D     ;C
000318 7D5D CB3F             8      SRL A
00031A 7D5F E7              12      RST 20H
00031B 7D60 7A               4      LD  A,D     ;H
00031C 7D61 E601             7      AND 1
00031E 7D63 E7              12      RST 20H
00031F 7D64 7B               4      LD  A,E     ;R
000320 7D65 E7              12      RST 20H
000321 7D66 3A357C          13      LD  A,(S_PARAMS+5)  ;N
000324 7D69 FE04             7      CP  4
000326 7D6B 3802            12      JR  C,FDCOMMAND2
                                
000328 7D6D 3E03             7      LD  A,3
       7D6F                     FDCOMMAND2:
00032A 7D6F 1E20             7      LD  E,020H      ;NO SERVICE
00032C 7D71 E7              12      RST 20H
                                
00032D 7D72 210040          10      LD  HL,DSS_DATA ;開始アドレス
000330 7D75 78               4      LD  A,B     ;EOT
000331 7D76 E7              12      RST 20H
                                
000332 7D77 01FB00          10      LD  BC,000FBH   ;B:バイト数L C:FDC μPD765A データレジスタ
000335 7D7A 3E54             7      LD  A,054H      ;GSL
000337 7D7C E7              12      RST 20H
                                
000338 7D7D 3A367C          13      LD  A,(S_BYTE_H)
00033B 7D80 57               4      LD  D,A     ;バイト数H
                                
00033C 7D81 AF               4      XOR A       ;DTL
00033D 7D82 E7              12      RST 20H
00033E 7D83 A7               4      AND A
00033F 7D84 C9              10      RET
                                
       7D85                     RDDISK1:            ;高速化の為にループ展開x8
000340 7D85 FB               4      EI
000341 7D86 76               4      HALT
000342 7D87 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000344 7D89 A3               4      AND E       ;NO SERVICE
000345 7D8A C8              11      RET Z
000346 7D8B EDA2            16      INI
                                
000348 7D8D FB               4      EI
000349 7D8E 76               4      HALT
00034A 7D8F DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00034C 7D91 A3               4      AND E       ;NO SERVICE
00034D 7D92 C8              11      RET Z
00034E 7D93 EDA2            16      INI
                                
000350 7D95 FB               4      EI
000351 7D96 76               4      HALT
000352 7D97 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000354 7D99 A3               4      AND E       ;NO SERVICE
000355 7D9A C8              11      RET Z
000356 7D9B EDA2            16      INI
                                
000358 7D9D FB               4      EI
000359 7D9E 76               4      HALT
00035A 7D9F DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00035C 7DA1 A3               4      AND E       ;NO SERVICE
00035D 7DA2 C8              11      RET Z
00035E 7DA3 EDA2            16      INI
                                
000360 7DA5 FB               4      EI
000361 7DA6 76               4      HALT
000362 7DA7 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000364 7DA9 A3               4      AND E       ;NO SERVICE
000365 7DAA C8              11      RET Z
000366 7DAB EDA2            16      INI
                                
000368 7DAD FB               4      EI
000369 7DAE 76               4      HALT
00036A 7DAF DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00036C 7DB1 A3               4      AND E       ;NO SERVICE
00036D 7DB2 C8              11      RET Z
00036E 7DB3 EDA2            16      INI
                                
000370 7DB5 FB               4      EI
000371 7DB6 76               4      HALT
000372 7DB7 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000374 7DB9 A3               4      AND E       ;NO SERVICE
000375 7DBA C8              11      RET Z
000376 7DBB EDA2            16      INI
                                
000378 7DBD FB               4      EI
000379 7DBE 76               4      HALT
00037A 7DBF DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00037C 7DC1 A3               4      AND E       ;NO SERVICE
00037D 7DC2 C8              11      RET Z
00037E 7DC3 EDA2            16      INI
                                
000380 7DC5 20BE            12      JR  NZ,RDDISK1
000382 7DC7 15               4      DEC D
000383 7DC8 C2857D          10      JP  NZ,RDDISK1
000386 7DCB C9              10      RET
                                
       7DCC                     WRDISK1:            ;高速化の為にループ展開x8
000387 7DCC FB               4      EI
000388 7DCD 76               4      HALT
000389 7DCE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00038B 7DD0 A3               4      AND E
00038C 7DD1 C8              11      RET Z
00038D 7DD2 EDA3            16      OUTI
                                
00038F 7DD4 FB               4      EI
000390 7DD5 76               4      HALT
000391 7DD6 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000393 7DD8 A3               4      AND E
000394 7DD9 C8              11      RET Z
000395 7DDA EDA3            16      OUTI
                                
000397 7DDC FB               4      EI
000398 7DDD 76               4      HALT
000399 7DDE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00039B 7DE0 A3               4      AND E
00039C 7DE1 C8              11      RET Z
00039D 7DE2 EDA3            16      OUTI
                                
00039F 7DE4 FB               4      EI
0003A0 7DE5 76               4      HALT
0003A1 7DE6 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003A3 7DE8 A3               4      AND E
0003A4 7DE9 C8              11      RET Z
0003A5 7DEA EDA3            16      OUTI
                                
0003A7 7DEC FB               4      EI
0003A8 7DED 76               4      HALT
0003A9 7DEE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003AB 7DF0 A3               4      AND E
0003AC 7DF1 C8              11      RET Z
0003AD 7DF2 EDA3            16      OUTI
                                
0003AF 7DF4 FB               4      EI
0003B0 7DF5 76               4      HALT
0003B1 7DF6 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003B3 7DF8 A3               4      AND E
0003B4 7DF9 C8              11      RET Z
0003B5 7DFA EDA3            16      OUTI
                                
0003B7 7DFC FB               4      EI
0003B8 7DFD 76               4      HALT
0003B9 7DFE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003BB 7E00 A3               4      AND E
0003BC 7E01 C8              11      RET Z
0003BD 7E02 EDA3            16      OUTI
                                
0003BF 7E04 FB               4      EI
0003C0 7E05 76               4      HALT
0003C1 7E06 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003C3 7E08 A3               4      AND E
0003C4 7E09 C8              11      RET Z
0003C5 7E0A EDA3            16      OUTI
                                
0003C7 7E0C 20BE            12      JR  NZ,WRDISK1
0003C9 7E0E 15               4      DEC D
0003CA 7E0F C2CC7D          10      JP  NZ,WRDISK1
0003CD 7E12 C9              10      RET
                                
       7E13                     RESULTEX:
0003CE 7E13 3A407C          13      LD  A,(S_CMD_STATUS)
0003D1 7E16 3C               4      INC A
0003D2 7E17 2803            12      JR  Z,RESULTEX1
0003D4 7E19 3A367C          13      LD  A,(S_BYTE_H)    ;バイト数H
       7E1C                     RESULTEX1:
0003D7 7E1C DF              12      RST 18H
0003D8 7E1D C32A00          10      JP  MAIN
                                
       7E20                     CHECKRESULT:
0003DB 7E20 C5              11      PUSH    BC
0003DC 7E21 CD477E          17      CALL    RDFDC       ;ST0
0003DF 7E24 E6D8             7      AND 0D8H
0003E1 7E26 4F               4      LD  C,A
0003E2 7E27 CD477E          17      CALL    RDFDC       ;ST1
0003E5 7E2A E6B7             7      AND 0B7H
0003E7 7E2C B1               4      OR  C
0003E8 7E2D 4F               4      LD  C,A
0003E9 7E2E CD477E          17      CALL    RDFDC       ;ST2
0003EC 7E31 E673             7      AND 073H
0003EE 7E33 B1               4      OR  C
0003EF 7E34 4F               4      LD  C,A
0003F0 7E35 0604             7      LD  B,4
       7E37                     CHECKRESULT1:           ;C H R N
0003F2 7E37 CD477E          17      CALL    RDFDC
0003F5 7E3A 10FB            13      DJNZ    CHECKRESULT1
0003F7 7E3C 79               4      LD  A,C
0003F8 7E3D A7               4      AND A
0003F9 7E3E C1              10      POP BC
0003FA 7E3F C8              11      RET Z
0003FB 7E40 37               4      SCF
0003FC 7E41 C9              10      RET
                                
       7E42                     GETDEVSTAT:
0003FD 7E42 3E04             7      LD  A,4
0003FF 7E44 E7              12      RST 20H
000400 7E45 79               4      LD  A,C
000401 7E46 E7              12      RST 20H
                                
       7E47                     RDFDC:
000402 7E47 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000404 7E49 2F               4      CPL
000405 7E4A E6C0             7      AND 0C0H        ;RQMとDIOが両方1になるまで待つ
000407 7E4C 20F9            12      JR  NZ,RDFDC
000409 7E4E DBFB            11      IN  A,(0FBH)    ;FDC μPD765A データレジスタリード
00040B 7E50 C9              10      RET
                                
00040C D205                         ORG $$+OFFSET   ;$DEPHASE
       D205                     AT_DSSE:
       D205                     INITE:
00040C D205                         DS  BDOS-INITE
00040D D206 C361D9          10      JP  BDOS_RF
[EOF:88SUB.ASM:SHIFT_JIS]
                                    INCLUDE "88CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   PC-8801mkIISR
                                
       D209                     WBOOT1:
000410 D209 ED7B0600        20      LD  SP,(SYSTEM+1)
000414 D20D DB32            11      IN  A,(032H)
000416 D20F F610             7      OR  10H     ;高速RAMアクセスモードOFF
000418 D211 D332            11      OUT (032H),A
                                
00041A D213 3EEE             7      LD  A,IVRTC/256
00041C D215 ED47             9      LD  I,A
00041E D217 3AB8EF          13      LD  A,(WKE6)
000421 D21A F602             7      OR  2       ;VRTC割り込みマスク
000423 D21C D3E6            11      OUT (0E6H),A    ;割り込みマスク
000425 D21E 32B8EF          13      LD  (WKE6),A
000428 D221 3AB7EF          13      LD  A,(WKE4)
00042B D224 D3E4            11      OUT (0E4H),A    ;割り込みレベル設定 
                                
00042D D226 FB               4      EI
00042E D227 2192EF          10      LD  HL,_KEYD
000431 D22A 3600            10      LD  (HL),0
000433 D22C CDD1DD          17      CALL    CHKEY
000436 D22F CDC2D9          17      CALL    KEYBC_IFBREAK
000439 D232 3E04             7      LD  A,4
00043B D234 CDD5D9          17      CALL    MSG_A
[EOF:88CCP.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D237                     COMMAND:
00043E D237 3A61F1          13      LD  A,(FCB_BAT)
000441 D23A B7               4      OR  A
000442 D23B C27DD3          10      JP  NZ,C_BAT1
000445 D23E CDF1D2          17      CALL    SETDTA1
000448 D241 3A87EF          13      LD  A,(_DVSW)
00044B D244 C641             7      ADD A,'A'
00044D D246 CDD5D9          17      CALL    MSG_A
000450 D249 3E3E             7      LD  A,'>'
000452 D24B CDD5D9          17      CALL    MSG_A
000455 D24E 3E50             7      LD  A,80
000457 D250 12               7      LD  (DE),A
000458 D251 CD13DA          17      CALL    _SYS0A      ;(BDOS)文字列入力
00045B D254 CD72D4          17      CALL    LTNL
       D257                     COMMAND2:
00045E D257 118200          10      LD  DE,DTA1+2
000461 D25A CDFDEF          17      CALL    _COMANL
000464 D25D 30D8            12      JR  NC,COMMAND
000466 D25F 1179EF          10      LD  DE,COMERM
000469 D262 CDD2D6          17      CALL    _SYS09      ;(BDOS)文字列出力
00046C D265 C7              12      RST 0
                                
       D266                     COMANL:
00046D D266 CDB6DE          17      CALL    FILE
000470 D269 3A19EF          13      LD  A,(FNAME+4)
000473 D26C FE20             7      CP  020H
000475 D26E 201C            12      JR  NZ,COMB2
000477 D270 D5              11      PUSH    DE
000478 D271 1115EF          10      LD  DE,FNAME
00047B D274 1A               7      LD  A,(DE)
00047C D275 FE20             7      CP  020H
00047E D277 2844            12      JR  Z,SDVSW
000480 D279 1B               6      DEC DE
000481 D27A 1A               7      LD  A,(DE)
000482 D27B C6FF             7      ADD A,0FFH
000484 D27D 3809            12      JR  C,COMB
000486 D27F 13               6      INC DE
                                
000487 D280 212CD6          10      LD  HL,COMTB
00048A D283 0608             7      LD  B,COMS
00048C D285 CD45E1          17      CALL    CPNAME
       D288                     COMB:
00048F D288 D1              10      POP DE
000490 D289 D20F00          10      JP  NC,JP_HL
       D28C                     COMB2:
000493 D28C EB               4      EX  DE,HL
000494 D28D 225AD3          16      LD  (COMSWC),HL
000497 D290 F5              11      PUSH    AF
000498 D291 CD12D3          17      CALL    CEXE4
00049B D294 F1              10      POP AF
00049C D295 2115EF          10      LD  HL,FNAME
00049F D298 116D00          10      LD  DE,FCB2+1   ;COMMAND NAME
0004A2 D29B 010B00          10      LD  BC,11
0004A5 D29E EDB0                    LDIR
0004A7 D2A0 1100F1          10      LD  DE,PATHD
       D2A3                     CEX1:
0004AA D2A3 1A               7      LD  A,(DE)
0004AB D2A4 FE20             7      CP  020H
0004AD D2A6 D8              11      RET C
0004AE D2A7 CDABDE          17      CALL    FILEC
0004B1 D2AA D5              11      PUSH    DE
0004B2 D2AB 216D00          10      LD  HL,FCB2+1   ;COMMAND NAME
0004B5 D2AE 1115EF          10      LD  DE,FNAME
0004B8 D2B1 010B00          10      LD  BC,11
0004BB D2B4 EDB0                    LDIR
0004BD D2B6 CD12D3          17      CALL    CEXE4
0004C0 D2B9 D1              10      POP DE
0004C1 D2BA 13               6      INC DE
0004C2 D2BB 18E6            12      JR  CEX1
                                
       D2BD                     SDVSW:
0004C4 D2BD F1              10      POP AF
0004C5 D2BE 3A14EF          13      LD  A,(FDRV)
0004C8 D2C1 3D               4      DEC A
0004C9 D2C2 5F               4      LD  E,A
0004CA D2C3 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
0004CC D2C5 1831            12      JR  SYSTEM0
                                
       D2C7                     OPEN1:
0004CE D2C7 2114EF          10      LD  HL,FDRV
       D2CA                     OPEN:
0004D1 D2CA 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D2CC                     OPEN3:
0004D3 D2CC D5              11      PUSH    DE
0004D4 D2CD 113CF1          10      LD  DE,DTA_CCP
0004D7 D2D0 CDEED2          17      CALL    SETDTA
0004DA D2D3 EB               4      EX  DE,HL
0004DB D2D4 CDF8D2          17      CALL    SYSTEM0
0004DE D2D7 D1              10      POP DE
0004DF D2D8 C9              10      RET
                                
       D2D9                     OPEN2:
0004E0 D2D9 0E12             7      LD  C,012H
0004E2 D2DB 18EF            12      JR  OPEN3
                                
       D2DD                     DEFCB:              ;Z=Ok NZ=Error
0004E4 D2DD 113CF1          10      LD  DE,DTA_CCP
0004E7 D2E0 CDF6D2          17      CALL    SYSC0F
                                
0004EA D2E3 115DF1          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0004ED D2E6 0604             7      LD  B,4
0004EF D2E8 CD40D5          17      CALL    ZERO_MEMORY_DE
       D2EB                     SETDTA100:
0004F2 D2EB 110001          10      LD  DE,00100H
       D2EE                     SETDTA:
0004F5 D2EE C3A5D8          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D2F1                     SETDTA1:
0004F8 D2F1 118000          10      LD  DE,DTA1
0004FB D2F4 18F8            12      JR  SETDTA
                                
       D2F6                     SYSC0F:
0004FD D2F6 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D2F8                     SYSTEM0:
0004FF D2F8 CD0500          17      CALL    SYSTEM
000502 D2FB B7               4      OR  A
000503 D2FC C9              10      RET
                                
       D2FD                     C_CD:
000504 D2FD 0E5A             7      LD  C,05AH
000506 D2FF 18F7            12      JR  SYSTEM0
                                
       D301                     S27BUF:
000508 D301 2100FE          10      LD  HL,-00200H  ;スクラッチエリア(0100H)+スタック予備(0100H)
00050B D304 39              11      ADD HL,SP
00050C D305 2E00             7      LD  L,0
00050E D307 7C               4      LD  A,H
00050F D308 E6F8             7      AND 0F8H
000511 D30A 67               4      LD  H,A
       D30B                     S27DTA:
000512 D30B 113CF1          10      LD  DE,DTA_CCP
       D30E                     S27:
000515 D30E 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
000517 D310 18E6            12      JR  SYSTEM0
                                
       D312                     CEXE4:
000519 D312 211DEF          10      LD  HL,FNAME+8
00051C D315 7E               7      LD  A,(HL)
00051D D316 FE20             7      CP  020H
00051F D318 2007            12      JR  NZ,CEXE7
000521 D31A 3E3F             7      LD  A,'?'
000523 D31C 77               7      LD  (HL),A
000524 D31D 23               6      INC HL
000525 D31E 77               7      LD  (HL),A
000526 D31F 23               6      INC HL
000527 D320 77               7      LD  (HL),A
       D321                     CEXE7:
000528 D321 CDC7D2          17      CALL    OPEN1
       D324                     CEXE5:
00052B D324 C0              11      RET NZ
00052C D325 2A46F1          16      LD  HL,(DTA_CCP+1+9)
00052F D328 7C               4      LD  A,H
000530 D329 CDCDE1          17      CALL    CAP
000533 D32C 67               4      LD  H,A
000534 D32D 7D               4      LD  A,L
000535 D32E CDCDE1          17      CALL    CAP
000538 D331 6F               4      LD  L,A
000539 D332 3A45F1          13      LD  A,(DTA_CCP+1+8)
00053C D335 CDCDE1          17      CALL    CAP
00053F D338 D642             7      SUB 'B'
000541 D33A 282C            12      JR  Z,C_BAT
000543 D33C 3D               4      DEC A       ;'C'
000544 D33D 2805            12      JR  Z,C_EXE
       D33F                     CEXE6:
000546 D33F CDD9D2          17      CALL    OPEN2
000549 D342 18E0            12      JR  CEXE5
                                
       D344                     C_EXE:
00054B D344 7C               4      LD  A,H
00054C D345 FE4D             7      CP  'M'
00054E D347 20F6            12      JR  NZ,CEXE6
                                
000550 D349 CDDDD2          17      CALL    DEFCB
000553 D34C CD01D3          17      CALL    S27BUF
000556 D34F 3D               4      DEC A
000557 D350 37               4      SCF
000558 D351 C0              11      RET NZ
000559 D352 7C               4      LD  A,H
00055A D353 B5               4      OR  L
00055B D354 37               4      SCF
00055C D355 C8              11      RET Z
00055D D356 CDF1D2          17      CALL    SETDTA1
000560 D359 110000          10      LD  DE,0                ; self-modifying code
       D35A                     COMSWC  EQU $-2
000563 D35C ED7B0600        20      LD  SP,(SYSTEM+1)
000567 D360 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000568 D361 6F               4      LD  L,A
000569 D362 E5              11      PUSH    HL              ; push $0000 (reboot address)
00056A D363 24               4      INC H
00056B D364 E5              11      PUSH    HL              ; push $0100 (TPA address)
00056C D365 C30BD5          10      JP  SETFCB              ; and JP $0100
                                
       D368                     C_BAT:
00056F D368 114154          10      LD  DE,'A'+'T'*256
000572 D36B ED52            15      SBC HL,DE
000574 D36D 20D0            12      JR  NZ,CEXE6
                                
000576 D36F CDDDD2          17      CALL    DEFCB
                                
000579 D372 213CF1          10      LD  HL,DTA_CCP
00057C D375 1161F1          10      LD  DE,FCB_BAT
00057F D378 012500          10      LD  BC,37
000582 D37B EDB0                    LDIR
       D37D                     C_BAT1:
000584 D37D CDEBD2          17      CALL    SETDTA100
000587 D380 CDB4D3          17      CALL    FGETC_BAT
00058A D383 218100          10      LD  HL,DTA1+1
00058D D386 2025            12      JR  NZ,END_BATCH
00058F D388 FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
000591 D38A 38F1            12      JR  C,C_BAT1
000593 D38C 3620            10      LD  (HL),' '
000595 D38E 23               6      INC HL
       D38F                     C_BAT2:
000596 D38F 77               7      LD  (HL),A
000597 D390 23               6      INC HL
000598 D391 7D               4      LD  A,L
000599 D392 3C               4      INC A       ;L==0FFH
00059A D393 2809            12      JR  Z,RUN_BATCH
00059C D395 CDB4D3          17      CALL    FGETC_BAT
00059F D398 2004            12      JR  NZ,RUN_BATCH
0005A1 D39A FE20             7      CP  020H
0005A3 D39C 30F1            12      JR  NC,C_BAT2
       D39E                     RUN_BATCH:
0005A5 D39E 7D               4      LD  A,L
0005A6 D39F D67F             7      SUB DTA1-1
0005A8 D3A1 328000          13      LD  (DTA1),A
0005AB D3A4 FE04             7      CP  4
0005AD D3A6 3805            12      JR  C,END_BATCH
0005AF D3A8 3600            10      LD  (HL),0
0005B1 D3AA C357D2          10      JP  COMMAND2
       D3AD                     END_BATCH:
0005B4 D3AD AF               4      XOR A       ;バッチファイルを閉じる
0005B5 D3AE 3261F1          13      LD  (FCB_BAT),A
0005B8 D3B1 C300EF          10      JP  CPM_BOOT
                                
       D3B4                     FGETC_BAT:
0005BB D3B4 1161F1          10      LD  DE,FCB_BAT
       D3B7                     FGETC:              ;1文字ずつ読み込む
0005BE D3B7 E5              11      PUSH    HL      ;Z:成功
0005BF D3B8 210100          10      LD  HL,1
0005C2 D3BB CD0ED3          17      CALL    S27
0005C5 D3BE E1              10      POP HL
0005C6 D3BF 3A0001          13      LD  A,(00100H)
0005C9 D3C2 C9              10      RET
                                
       D3C3                     C_DEL:
0005CA D3C3 CD0BD5          17      CALL    SETFCB
0005CD D3C6 CDEBD9          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
0005D0 D3C9 0E13             7      LD  C,013H
0005D2 D3CB 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D3CD                     C_REN:
0005D4 D3CD CD0BD5          17      CALL    SETFCB
0005D7 D3D0 3E10             7      LD  A,010H      ;ディレクトリも対象にする
0005D9 D3D2 326900          13      LD  (FCB1+13),A ;属性
0005DC D3D5 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D3D7                     CDEL1:
0005DE D3D7 115C00          10      LD  DE,FCB1
0005E1 D3DA CD0500          17      CALL    SYSTEM
0005E4 D3DD C6FF             7      ADD A,0FFH
0005E6 D3DF C9              10      RET
                                
       D3E0                     C_DIR:
0005E7 D3E0 CDABDE          17      CALL    FILEC
0005EA D3E3 2115EF          10      LD  HL,FDRV+1
0005ED D3E6 CD21D6          17      CALL    CWILD1
0005F0 D3E9 3EF1             7      LD  A,0F1H
0005F2 D3EB 3221EF          13      LD  (FDRV+13),A
0005F5 D3EE CDC7D2          17      CALL    OPEN1
       D3F1                     CDIR1:
0005F8 D3F1 B7               4      OR  A
0005F9 D3F2 2008            12      JR  NZ,PDSKF
0005FB D3F4 CD3FD4          17      CALL    P_NAME
0005FE D3F7 CDD9D2          17      CALL    OPEN2
000601 D3FA 18F5            12      JR  CDIR1
       D3FC                     PDSKF:
000603 D3FC 3A14EF          13      LD  A,(FDRV)
000606 D3FF 5F               4      LD  E,A
000607 D400 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
000609 D402 CD0500          17      CALL    SYSTEM
00060C D405 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
00060D D406 C601             7      ADD A,001H
00060F D408 D8              11      RET C       ;Aが0FFHだった場合
000610 D409 3E06             7      LD  A,8-2
       D40B                     PDS1:               ;HL=未使用クラスタの総数
000612 D40B 3C               4      INC A
000613 D40C CB19             8      RR  C
000615 D40E 30FB            12      JR  NC,PDS1
       D410                     PDS2:               ;B←論理セクタのサイズの上位8ビット
000617 D410 3C               4      INC A
000618 D411 CB18             8      RR  B
00061A D413 30FB            12      JR  NC,PDS2
00061C D415 47               4      LD  B,A
                                
00061D D416 110000          10      LD  DE,0
       D419                     PDS3:
000620 D419 29              11      ADD HL,HL
000621 D41A EB               4      EX  DE,HL
000622 D41B ED6A            15      ADC HL,HL
000624 D41D EB               4      EX  DE,HL
000625 D41E 10F9            13      DJNZ    PDS3
       D420                     PDSKF1:
000627 D420 CDA9D4          17      CALL    PRDEC_DEHL
00062A D423 1191F1          10      LD  DE,FREE
00062D D426 CDD2D6          17      CALL    _SYS09      ;(BDOS)文字列出力
000630 D429 CD99D4          17      CALL    PUTDRV
000633 D42C 3E5C             7      LD  A,05CH      ;\
000635 D42E CDD5D9          17      CALL    MSG_A
000638 D431 2A22EF          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
00063B D434 AF               4      XOR A
00063C D435 11FEFF          10      LD  DE,0-2
00063F D438 19              11      ADD HL,DE
000640 D439 23               6      INC HL
000641 D43A DCA6D4          17      CALL    C,PRDEC_HL
000644 D43D 1833            12      JR  LTNL
                                
       D43F                     P_NAME:
000646 D43F 3A3DF1          13      LD  A,(DTA_CCP+1)
000649 D442 FE2E             7      CP  '.'
00064B D444 C8              11      RET Z
                                
00064C D445 3A48F1          13      LD  A,(DTA_CCP+1+00BH)
00064F D448 F5              11      PUSH    AF
000650 D449 CB67             8      BIT 4,A
000652 D44B 2808            12      JR  Z,DIR3
000654 D44D 1186F1          10      LD  DE,DIRMES
000657 D450 CDD2D6          17      CALL    _SYS09      ;(BDOS)文字列出力
00065A D453 180A            12      JR  DIR6
       D455                     DIR3:
00065C D455 ED5B5BF1        20      LD  DE,(DTA_CCP+1+01EH)
000660 D459 2A59F1          16      LD  HL,(DTA_CCP+1+01CH)
000663 D45C CDA9D4          17      CALL    PRDEC_DEHL
       D45F                     DIR6:
000666 D45F F1              10      POP AF
000667 D460 0F               4      RRCA
000668 D461 9F               4      SBC A,A
000669 D462 E60A             7      AND '*'-020H
00066B D464 C620             7      ADD A,020H
00066D D466 CDD5D9          17      CALL    MSG_A
000670 D469 CD99D4          17      CALL    PUTDRV
000673 D46C 213DF1          10      LD  HL,DTA_CCP+1
000676 D46F CDE9D4          17      CALL    FPRNT
                                
       D472                     LTNL:
000679 D472 1E03             7      LD  E,3
00067B D474 C3CDEF          10      JP  _PRINT
                                
       D477                     C_PATH:
00067E D477 CD8DDF          17      CALL    SPCUT
000681 D47A 2100F1          10      LD  HL,PATHD
000684 D47D FE21             7      CP  021H
000686 D47F 300C            12      JR  NC,CPATH0
       D481                     CPATHP:
000688 D481 7E               7      LD  A,(HL)
000689 D482 23               6      INC HL
00068A D483 FE20             7      CP  020H
00068C D485 3F               4      CCF
00068D D486 30EA            12      JR  NC,LTNL
00068F D488 CDD5D9          17      CALL    MSG_A
000692 D48B 18F4            12      JR  CPATHP
       D48D                     CPATH0:
000694 D48D FE3B             7      CP  ';'
000696 D48F 2001            12      JR  NZ,CPATH1
000698 D491 13               6      INC DE
       D492                     CPATH1:
000699 D492 EB               4      EX  DE,HL
00069A D493 013B00          10      LD  BC,PATHX
00069D D496 EDB0                    LDIR
00069F D498 C9              10      RET
                                
       D499                     PUTDRV:
0006A0 D499 3A89EF          13      LD  A,(_DSK)
0006A3 D49C C641             7      ADD A,'A'
0006A5 D49E CDD5D9          17      CALL    MSG_A
0006A8 D4A1 3E3A             7      LD  A,':'
       D4A3                     MSG_AR:
0006AA D4A3 C3D5D9          10      JP  MSG_A
                                
       D4A6                     PRDEC_HL:
0006AD D4A6 AF               4      XOR A
0006AE D4A7 5F               4      LD  E,A
0006AF D4A8 57               4      LD  D,A
       D4A9                     PRDEC_DEHL:
0006B0 D4A9 D5              11      PUSH    DE
0006B1 D4AA 110FEF          10      LD  DE,DECBF
0006B4 D4AD 0605             7      LD  B,5
0006B6 D4AF CD40D5          17      CALL    ZERO_MEMORY_DE  ;A=0
0006B9 D4B2 D1              10      POP DE
                                
0006BA D4B3 0E20             7      LD  C,32
       D4B5                     DEC1:
0006BC D4B5 29              11      ADD HL,HL
0006BD D4B6 EB               4      EX  DE,HL
0006BE D4B7 ED6A            15      ADC HL,HL
0006C0 D4B9 EB               4      EX  DE,HL
0006C1 D4BA E5              11      PUSH    HL
0006C2 D4BB 2113EF          10      LD  HL,DECBF+4
0006C5 D4BE 0605             7      LD  B,5
       D4C0                     DEC2:
0006C7 D4C0 7E               7      LD  A,(HL)
0006C8 D4C1 8F               4      ADC A,A
0006C9 D4C2 27               4      DAA
0006CA D4C3 77               7      LD  (HL),A
0006CB D4C4 2B               6      DEC HL
0006CC D4C5 10F9            13      DJNZ    DEC2
0006CE D4C7 E1              10      POP HL
0006CF D4C8 0D               4      DEC C
0006D0 D4C9 20EA            12      JR  NZ,DEC1
                                
0006D2 D4CB 210FEF          10      LD  HL,DECBF
0006D5 D4CE 3E20             7      LD  A,020H
0006D7 D4D0 0604             7      LD  B,4
       D4D2                     DEC3:
0006D9 D4D2 CDDFD4          17      CALL    DEC4
0006DC D4D5 CDDFD4          17      CALL    DEC4
0006DF D4D8 23               6      INC HL
0006E0 D4D9 10F7            13      DJNZ    DEC3
       D4DB                     DECX:
0006E2 D4DB CDDFD4          17      CALL    DEC4
0006E5 D4DE AF               4      XOR A
       D4DF                     DEC4:
0006E6 D4DF ED6F            18      RLD
0006E8 D4E1 FE20             7      CP  020H
0006EA D4E3 2802            12      JR  Z,DEC5
0006EC D4E5 F630             7      OR  030H
       D4E7                     DEC5:
0006EE D4E7 18BA            12      JR  MSG_AR
                                
       D4E9                     FPRNT:
0006F0 D4E9 0608             7      LD  B,8 ;ファイル名を表示
0006F2 D4EB CDFAD4          17      CALL    P_N1
0006F5 D4EE 7E               7      LD  A,(HL)
0006F6 D4EF CDD9E1          17      CALL    CAP3
0006F9 D4F2 D8              11      RET C   ;拡張子が無い
                                
0006FA D4F3 3E2E             7      LD  A,'.'
0006FC D4F5 CDD5D9          17      CALL    MSG_A
0006FF D4F8 0603             7      LD  B,3 ;拡張子を表示
       D4FA                     P_N1:
000701 D4FA 7E               7      LD  A,(HL)
000702 D4FB CDD9E1          17      CALL    CAP3
000705 D4FE 3807            12      JR  C,P_N2
000707 D500 CDD5D9          17      CALL    MSG_A
00070A D503 23               6      INC HL
00070B D504 10F4            13      DJNZ    P_N1
00070D D506 C9              10      RET
       D507                     P_N2:
00070E D507 23               6      INC HL
00070F D508 10FD            13      DJNZ    P_N2
000711 D50A C9              10      RET
                                
       D50B                     SETFCB:
000712 D50B CD8DDF          17      CALL    SPCUT
000715 D50E 1A               7      LD  A,(DE)
000716 D50F FE20             7      CP  020H
000718 D511 3801            12      JR  C,SETFCBA
00071A D513 1B               6      DEC DE
       D514                     SETFCBA:
00071B D514 0624             7      LD  B,36
00071D D516 215C00          10      LD  HL,FCB1
000720 D519 E5              11      PUSH    HL
000721 D51A AF               4      XOR A
000722 D51B CD62DF          17      CALL    FILL_MEMORY
000725 D51E E1              10      POP HL
000726 D51F D5              11      PUSH    DE
000727 D520 CD0BD9          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
00072A D523 216C00          10      LD  HL,FCB2
00072D D526 CD0BD9          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000730 D529 E1              10      POP HL
000731 D52A 010050          10      LD  BC,05000H
000734 D52D 118100          10      LD  DE,00081H
       D530                     SETFCB1:
000737 D530 7E               7      LD  A,(HL)
000738 D531 23               6      INC HL
000739 D532 FE20             7      CP  020H
00073B D534 3805            12      JR  C,SETFCB2
00073D D536 12               7      LD  (DE),A
00073E D537 13               6      INC DE
00073F D538 0C               4      INC C
000740 D539 10F5            13      DJNZ    SETFCB1
       D53B                     SETFCB2:
000742 D53B 79               4      LD  A,C
000743 D53C 328000          13      LD  (DTA1),A
000746 D53F 04               4      INC B
       D540                     ZERO_MEMORY_DE:
000747 D540 AF               4      XOR A
       D541                     FILL_MEMORY_DE:
000748 D541 12               7      LD  (DE),A
000749 D542 13               6      INC DE
00074A D543 10FC            13      DJNZ    FILL_MEMORY_DE
00074C D545 C9              10      RET
                                
       D546                     C_COPY:
00074D D546 CD0BD5          17      CALL    SETFCB
                                
000750 D549 1161EF          10      LD  DE,ZERO
000753 D54C CDAEDE          17      CALL    FILEC2
000756 D54F 216C00          10      LD  HL,FCB2
000759 D552 CD12D9          17      CALL    S29X1
                                
00075C D555 3E10             7      LD  A,010H
00075E D557 326900          13      LD  (FCB1+13),A
000761 D55A 216D00          10      LD  HL,FCB2+1
000764 D55D CD21D6          17      CALL    CWILD1
       D560                     COPY0:
000767 D560 CD1ED6          17      CALL    CWILD
00076A D563 215C00          10      LD  HL,FCB1
00076D D566 CDCAD2          17      CALL    OPEN
000770 D569 37               4      SCF
       D56A                     COPY1:
000771 D56A C0              11      RET NZ
000772 D56B CDDDD2          17      CALL    DEFCB
                                
000775 D56E 3A49F1          13      LD  A,(DTA_CCP+13)
000778 D571 CB67             8      BIT 4,A
00077A D573 2821            12      JR  Z,COPY1A
                                
00077C D575 215D00          10      LD  HL,FCB1+1
00077F D578 CDF1E2          17      CALL    CHKWILD
000782 D57B 3814            12      JR  C,COPY9
                                
000784 D57D 3E20             7      LD  A,020H
000786 D57F 325D00          13      LD  (FCB1+1),A
000789 D582 2A56F1          16      LD  HL,(DTA_CCP+26)
00078C D585 23               6      INC HL
00078D D586 226A00          16      LD  (FCB1+14),HL
000790 D589 18D5            12      JR  COPY0
                                
       D58B                     COPY8:
000792 D58B CDD2D6          17      CALL    _SYS09      ;(BDOS)文字列出力
000795 D58E CD72D4          17      CALL    LTNL
       D591                     COPY9:
000798 D591 CDD9D2          17      CALL    OPEN2
00079B D594 18D4            12      JR  COPY1
                                
       D596                     COPY1A:
00079D D596 216C00          10      LD  HL,FCB2
0007A0 D599 1114EF          10      LD  DE,FDRV
0007A3 D59C 013EF1          10      LD  BC,DTA_CCP+2
0007A6 D59F EDA0            16      LDI
0007A8 D5A1 3E0B             7      LD  A,11
       D5A3                     COPY2:
0007AA D5A3 F5              11      PUSH    AF
0007AB D5A4 7E               7      LD  A,(HL)
0007AC D5A5 FE3F             7      CP  '?'
0007AE D5A7 2001            12      JR  NZ,COPY3
0007B0 D5A9 0A               7      LD  A,(BC)
       D5AA                     COPY3:
0007B1 D5AA 12               7      LD  (DE),A
0007B2 D5AB 03               6      INC BC
0007B3 D5AC 13               6      INC DE
0007B4 D5AD 23               6      INC HL
0007B5 D5AE F1              10      POP AF
0007B6 D5AF 3D               4      DEC A
0007B7 D5B0 20F1            12      JR  NZ,COPY2
0007B9 D5B2 010500          10      LD  BC,16-11
0007BC D5B5 EDB0                    LDIR
       D5B7                     PUTNAME:
0007BE D5B7 215D00          10      LD  HL,FCB1+1
0007C1 D5BA CDF1E2          17      CALL    CHKWILD
0007C4 D5BD 300B            12      JR  NC,PUTN1
0007C6 D5BF 2115EF          10      LD  HL,FDRV+1
0007C9 D5C2 CDE9D4          17      CALL    FPRNT
0007CC D5C5 3E20             7      LD  A,020H
0007CE D5C7 CDD5D9          17      CALL    MSG_A
       D5CA                     PUTN1:
0007D1 D5CA 1114EF          10      LD  DE,FDRV
0007D4 D5CD 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
0007D6 D5CF CDF8D2          17      CALL    SYSTEM0
0007D9 D5D2 2048            12      JR  NZ,COPYE2
0007DB D5D4 67               4      LD  H,A     ;A=0
0007DC D5D5 6F               4      LD  L,A
0007DD D5D6 2235EF          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0007E0 D5D9 2237EF          16      LD  (FDRV+35),HL
       D5DC                     COPY6:
0007E3 D5DC CD01D3          17      CALL    S27BUF
0007E6 D5DF 47               4      LD  B,A
0007E7 D5E0 3C               4      INC A
0007E8 D5E1 2831            12      JR  Z,COPYE
0007EA D5E3 7C               4      LD  A,H
0007EB D5E4 B5               4      OR  L
0007EC D5E5 280C            12      JR  Z,COPY7
0007EE D5E7 1114EF          10      LD  DE,FDRV
0007F1 D5EA 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0007F3 D5EC CDF8D2          17      CALL    SYSTEM0
0007F6 D5EF 2023            12      JR  NZ,COPYE
0007F8 D5F1 10E9            13      DJNZ    COPY6
       D5F3                     COPY7:
0007FA D5F3 3A49F1          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0007FD D5F6 3221EF          13      LD  (FDRV+13),A
000800 D5F9 2150F1          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
000803 D5FC 1128EF          10      LD  DE,FDRV+20
000806 D5FF 010400          10      LD  BC,4
000809 D602 EDB0                    LDIR
                                
00080B D604 1114EF          10      LD  DE,FDRV
00080E D607 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
000810 D609 CDF8D2          17      CALL    SYSTEM0
000813 D60C 2006            12      JR  NZ,COPYE
                                
000815 D60E 1171EF          10      LD  DE,OK
000818 D611 C38BD5          10      JP  COPY8
                                
       D614                     COPYE:
00081B D614 1114EF          10      LD  DE,FDRV
00081E D617 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
000820 D619 CD0500          17      CALL    SYSTEM
       D61C                     COPYE2:
000823 D61C 37               4      SCF
000824 D61D C9              10      RET
                                
       D61E                     CWILD:
000825 D61E 215D00          10      LD  HL,FCB1+1
       D621                     CWILD1:
000828 D621 7E               7      LD  A,(HL)
000829 D622 FE20             7      CP  020H
00082B D624 C0              11      RET NZ
       D625                     CWILD2:
00082C D625 3E3F             7      LD  A,'?'
00082E D627 060B             7      LD  B,11
000830 D629 C362DF          10      JP  FILL_MEMORY
                                
       D62C                     COMTB:
000833 D62C 44202020                DB  "D   "  ;1
000837 D630 E0D3                    DW  C_DIR
000839 D632 44495220                DB  "DIR "  ;2
00083D D636 E0D3                    DW  C_DIR
00083F D638 434F5059                DB  "COPY"  ;3
000843 D63C 46D5                    DW  C_COPY
000845 D63E 43442020                DB  "CD  "  ;4
000849 D642 FDD2                    DW  C_CD
00084B D644 44454C20                DB  "DEL "  ;5
00084F D648 C3D3                    DW  C_DEL
000851 D64A 50415448                DB  "PATH"  ;6
000855 D64E 77D4                    DW  C_PATH
000857 D650 52454E20                DB  "REN "  ;7
00085B D654 CDD3                    DW  C_REN
00085D D656 52454D20                DB  "REM "  ;8
000861 D65A CFD6                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "88DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   PC-8801mkIISR
                                
                                ;   BANK RAM DISK DRIVER
                                
       D65C                     BDWT:
000863 D65C 3E10             7      LD  A,010H  ;ライト可　リード不可
000865 D65E 1802            12  JR  BRW
                                
       D660                     BDRD:
000867 D660 3E01             7      LD  A,001H  ;ライト不可　リード可
       D662                     BRW:
000869 D662 F3               4      DI
00086A D663 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
00086C D665 ED739CD6        20      LD  (BANKSP),SP
000870 D669 3A9DD6          13      LD  A,(BANKSPH)
000873 D66C 87               4      ADD A,A
000874 D66D 3803            12      JR  C,BRW1
000876 D66F 312EEE          10      LD  SP,EXTSP    ;拡張メモリにスタックが重なる場合
       D672                     BRW1:
000879 D672 C5              11      PUSH    BC
00087A D673 D5              11      PUSH    DE
00087B D674 EB               4      EX  DE,HL       ;DE=メインメモリ
00087C D675 29              11      ADD HL,HL
00087D D676 29              11      ADD HL,HL
00087E D677 7C               4      LD  A,H
00087F D678 DD860C          19      ADD A,(IX+DPB_MAXCYL)
000882 D67B D3E3            11      OUT (0E3H),A    ;拡張RAM バンク選択
000884 D67D 65               4      LD  H,L
000885 D67E CB3C             8      SRL H   ;/2
000887 D680 2E00             7      LD  L,0
000889 D682 DBE2            11      IN  A,(0E2H)    ;拡張RAM リード/ライト制御
00088B D684 0F               4      RRCA
00088C D685 3001            12      JR  NC,BRW2     ;0: リード可
00088E D687 EB               4      EX  DE,HL       ;DE=拡張メモリ HL=メインメモリ
       D688                     BRW2:
00088F D688 010002          10      LD  BC,512
000892 D68B EDB0                    LDIR
                                
000894 D68D DBE2            11      IN  A,(0E2H)    ;拡張RAM リード/ライト制御
000896 D68F 0F               4      RRCA
000897 D690 3801            12      JR  C,BRW3      ;1: リード不可
000899 D692 EB               4      EX  DE,HL       ;DE=拡張メモリ HL=メインメモリ
       D693                     BRW3:
00089A D693 D1              10      POP DE
00089B D694 C1              10      POP BC
00089C D695 13               6      INC DE
00089D D696 10DA            13      DJNZ    BRW1
                                
00089F D698 AF               4      XOR A
0008A0 D699 D3E2            11      OUT (0E2H),A    ;メインメモリに切り替える
0008A2 D69B 310000          10      LD  SP,0
       D69C                     BANKSP  EQU $-2
       D69D                     BANKSPH EQU $-1
0008A5 D69E FB               4      EI
0008A6 D69F C9              10      RET
                                
[EOF:88DISK2.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D6A0                     BDOS0:
0008A7 D6A0 E5              11      PUSH    HL
0008A8 D6A1 79               4      LD  A,C
0008A9 D6A2 FE3C             7      CP  03CH
0008AB D6A4 3802            12      JR  C,DOS1
0008AD D6A6 3E3C             7      LD  A,03CH
       D6A8                     DOS1:
0008AF D6A8 87               4      ADD A,A
0008B0 D6A9 6F               4      LD  L,A
0008B1 D6AA 26F0             7      LD  H,STABLE/256
0008B3 D6AC 7E               7      LD  A,(HL)
0008B4 D6AD 2C               4      INC L
0008B5 D6AE 66               7      LD  H,(HL)
0008B6 D6AF 6F               4      LD  L,A
0008B7 D6B0 E3              19      EX  (SP),HL
0008B8 D6B1 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
0008B9 D6B2 C9              10      RET
       D6B3                     _DOS2:
0008BA D6B3 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
0008BC D6B5 CA4DD9          10      JP  Z,_SYS5A
0008BF D6B8 FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
0008C1 D6BA CA0BD9          10      JP  Z,_SYS29
0008C4 D6BD FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
0008C6 D6BF CAFEEB          10      JP  Z,_SYS5F
0008C9 D6C2 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
0008CB D6C4 200A            12      JR  NZ,_ERROR
0008CD D6C6 011D01          10      LD  BC,VER_6F
0008D0 D6C9 115901          10      LD  DE,VER
0008D3 D6CC 210201          10      LD  HL,MACD
       D6CF                     C_REM:
0008D6 D6CF AF               4      XOR A
       D6D0                     _ERROR:
0008D7 D6D0 A7               4      AND A
0008D8 D6D1 C9              10      RET
                                
       D6D2                     _SYS09:     ;文字列出力
0008D9 D6D2 D5              11      PUSH    DE
       D6D3                     _SX09:
0008DA D6D3 1A               7      LD  A,(DE)
0008DB D6D4 13               6      INC DE
0008DC D6D5 FE24             7      CP  '$'
0008DE D6D7 2831            12      JR  Z,SX0E2
0008E0 D6D9 CDD5D9          17      CALL    MSG_A
0008E3 D6DC 18F5            12      JR  _SX09
                                
       D6DE                     MSX1:
0008E5 D6DE CDD5D9          17      CALL    MSG_A
       D6E1                     MSX:
0008E8 D6E1 7E               7      LD  A,(HL)
0008E9 D6E2 23               6      INC HL
0008EA D6E3 B7               4      OR  A
0008EB D6E4 20F8            12      JR  NZ,MSX1
0008ED D6E6 C9              10      RET
                                
       D6E7                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0008EE D6E7 212200          10      LD  HL,00022H
0008F1 D6EA 7D               4      LD  A,L
0008F2 D6EB C9              10      RET
                                
       D6EC                     _SYS0D:     ;(BDOS)ディスクリセット
0008F3 D6EC CDDFEF          17      CALL    _FFLUSH
0008F6 D6EF E5              11      PUSH    HL
0008F7 D6F0 218000          10      LD  HL,00080H
0008FA D6F3 228AEF          16      LD  (_DTA),HL
0008FD D6F6 E1              10      POP HL
0008FE D6F7 D5              11      PUSH    DE
0008FF D6F8 1E00             7      LD  E,0
000901 D6FA 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D6FB                     _SYS0E:     ;(BDOS)カレントドライブの設定
000902 D6FB D5              11      PUSH    DE
000903 D6FC 7B               4      LD  A,E
000904 D6FD DDE5            15      PUSH    IX
000906 D6FF CDDCEF          17      CALL    _GETDPB
000909 D702 DDE1            14      POP IX
00090B D704 3804            12      JR  C,SX0E2
00090D D706 7B               4      LD  A,E
00090E D707 3287EF          13      LD  (_DVSW),A
       D70A                     SX0E2:
000911 D70A D1              10      POP DE
000912 D70B C9              10      RET
                                
       D70C                     _SYS0F:     ;(BDOS)ファイルのオープン
000913 D70C CD9FDF          17      CALL    SETDRV
000916 D70F FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000919 D712 C602             7      ADD A,002H      ;Write
00091B D714 2848            12      JR  Z,FEND0F
00091D D716 CDEDE2          17      CALL    CHKWILDX
                                
000920 D719 D4C9DF          17      CALL    NC,SOPENX
       D71C                     _S16XX:
000923 D71C 3840            12      JR  C,FEND0F
                                                ;Directory location
000925 D71E 3A9FEF          13      LD  A,(_FILEN)
000928 D721 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
00092B D724 3AA0EF          13      LD  A,(_DIRF)
00092E D727 FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000931 D72A FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
000934 D72D FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
000937 D730 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
00093B D734 FDE5            15      PUSH    IY
00093D D736 D1              10      POP DE
00093E D737 13               6      INC DE
00093F D738 010B00          10      LD  BC,11
000942 D73B EDB0                    LDIR
                                ;               Attribute
000944 D73D 7E               7      LD  A,(HL)
000945 D73E FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
000948 D741 110B00          10      LD  DE,11       ;Reserved
00094B D744 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
00094C D745 11E4F0          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
00094F D748 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D74A                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000951 D74A 1A               7      LD  A,(DE)
000952 D74B 13               6      INC DE
000953 D74C 3253D7          13      LD  (S16PAT),A
000956 D74F 7E               7      LD  A,(HL)
000957 D750 23               6      INC HL
000958 D751 FD7700          19      LD  (IY+0),A
       D753                     S16PAT  EQU $-1
00095B D754 10F4            13      DJNZ    S16LOOP
                                
00095D D756 AF               4      XOR A
00095E D757 FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000961 D75A FD22FBD7        20      LD  (OFCB_SWC),IY
       D75E                     FEND0F:
000965 D75E 1845            12      JR  FEND10
                                
       D760                     _SYS10:     ;(BDOS)ファイルのクローズ
000967 D760 CD9FDF          17      CALL    SETDRV
00096A D763 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00096D D766 D6FE             7      SUB 0FEH
00096F D768 37               4      SCF
000970 D769 3F               4      CCF
000971 D76A 2039            12      JR  NZ,FEND10
       D76C                     _S10A:              ;Write
000973 D76C FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000976 D76F FD770F          19      LD  (IY+15),A
                                
000979 D772 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
00097C D775 CDE9E3          17      CALL    SETTMS
                                
00097F D778 FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000982 D77B 32A0EF          13      LD  (_DIRF),A
000985 D77E E67F             7      AND 07FH
000987 D780 3214E9          13      LD  (_SECPS),A
00098A D783 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
00098D D786 FD561F          19      LD  D,(IY+31)
000990 D789 CDFEE0          17      CALL    READ_DIR
000993 D78C 3817            12      JR  C,FEND10
                                
000995 D78E 3A29E0          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000998 D791 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000999 D792 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
00099C D795 6F               4      LD  L,A
00099D D796 2600             7      LD  H,0
00099F D798 29              11      ADD HL,HL       ;*2
0009A0 D799 29              11      ADD HL,HL       ;*4
0009A1 D79A 29              11      ADD HL,HL       ;*8
0009A2 D79B 29              11      ADD HL,HL       ;*16
0009A3 D79C 29              11      ADD HL,HL       ;*32
0009A4 D79D ED4B7EF0        20      LD  BC,(_DTBUF)
0009A8 D7A1 09              11      ADD HL,BC
                                
0009A9 D7A2 CDFDE2          17      CALL    SDIRENT
       D7A5                     FEND10:
0009AC D7A5 1842            12      JR  FEND
                                
       D7A7                     _SYS11:     ;(BDOS)最初のファイルの検索
0009AE D7A7 CD9FDF          17      CALL    SETDRV
0009B1 D7AA CDF8DF          17      CALL    SOPEN
       D7AD                     _S12X1:
0009B4 D7AD 383A            12      JR  C,FEND
0009B6 D7AF CD97E0          17      CALL    SOPENE2
0009B9 D7B2 ED5B8AEF        20      LD  DE,(_DTA)
0009BD D7B6 3A88EF          13      LD  A,(_DRV)
0009C0 D7B9 3C               4      INC A
0009C1 D7BA 12               7      LD  (DE),A
0009C2 D7BB D5              11      PUSH    DE
0009C3 D7BC 13               6      INC DE
0009C4 D7BD 012000          10      LD  BC,32
0009C7 D7C0 EDB0                    LDIR
0009C9 D7C2 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
0009CC D7C5 FD660F          19      LD  H,(IY+15)
0009CF D7C8 22F4F0          16      LD  (SCDIR),HL
0009D2 D7CB 2A9AEF          16      LD  HL,(_FBPS)
0009D5 D7CE 22F6F0          16      LD  (SFBPS),HL
0009D8 D7D1 2A9FEF          16      LD  HL,(_FILEN)
0009DB D7D4 7C               4      LD  A,H
0009DC D7D5 B7               4      OR  A
0009DD D7D6 2806            12      JR  Z,_S12DIR
0009DF D7D8 3A14E9          13      LD  A,(_SECPS)
0009E2 D7DB F680             7      OR  080H
0009E4 D7DD 67               4      LD  H,A
       D7DE                     _S12DIR:
0009E5 D7DE 22F8F0          16      LD  (SFNDF),HL  ;Directory position and Flags
0009E8 D7E1 E1              10      POP HL
0009E9 D7E2 1139EF          10      LD  DE,SFILE
0009EC D7E5 0E21             7      LD  C,33
       D7E7                     _S11B:
0009EE D7E7 EDB0                    LDIR
       D7E9                     FEND:
0009F0 D7E9 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D7EA                     FENDE:
0009F1 D7EA FDE1            14      POP IY
0009F3 D7EC C1              10      POP BC
0009F4 D7ED D1              10      POP DE
0009F5 D7EE E1              10      POP HL
0009F6 D7EF C9              10      RET
                                
       D7F0                     _SYS12:     ;(BDOS)次のファイルの検索
0009F7 D7F0 E5              11      PUSH    HL
0009F8 D7F1 D5              11      PUSH    DE
0009F9 D7F2 C5              11      PUSH    BC
0009FA D7F3 FDE5            15      PUSH    IY
0009FC D7F5 CD5CE0          17      CALL    NOPEN
0009FF D7F8 18B3            12      JR  _S12X1
                                
       D7FA                     _S16K:
000A01 D7FA 110000          10      LD  DE,0
       D7FB                     OFCB_SWC    EQU $-2
000A04 D7FD D5              11      PUSH    DE
000A05 D7FE 061A             7      LD  B,26        ;First cluster
       D800                     S16K1:
000A07 D800 13               6      INC DE
000A08 D801 23               6      INC HL
000A09 D802 10FC            13      DJNZ    S16K1
                                
000A0B D804 1A               7      LD  A,(DE)
000A0C D805 BE               7      CP  (HL)
000A0D D806 2015            12      JR  NZ,S16K2
000A0F D808 13               6      INC DE
000A10 D809 23               6      INC HL
000A11 D80A 1A               7      LD  A,(DE)
000A12 D80B BE               7      CP  (HL)
000A13 D80C 200F            12      JR  NZ,S16K2
                                
000A15 D80E E1              10      POP HL
000A16 D80F FDE5            15      PUSH    IY
000A18 D811 D1              10      POP DE
000A19 D812 7E               7      LD  A,(HL)
000A1A D813 CDB4DF          17      CALL    IS_SAME_DRV_A_DE
000A1D D816 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000A1F D818 ED52            15      SBC HL,DE       ;CP HL,DE
000A21 D81A 37               4      SCF
000A22 D81B C0              11      RET NZ
000A23 D81C E5              11      PUSH    HL
       D81D                     S16K2:
000A24 D81D E1              10      POP HL
       D81E                     S16K3:
000A25 D81E FDE5            15      PUSH    IY
000A27 D820 D1              10      POP DE
       D821                     _SYS13:     ;(BDOS)ファイルの削除
000A28 D821 CD9FDF          17      CALL    SETDRV
000A2B D824 CD23E2          17      CALL    KILL
       D827                     FEND13:
000A2E D827 18C0            12      JR  FEND
                                
       D829                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000A30 D829 CD9FDF          17      CALL    SETDRV
000A33 D82C CD55E4          17      CALL    INIT_SEQ
       D82F                     SREAD:
000A36 D82F CD9DE4          17      CALL    RB_READ
                                
000A39 D832 C601             7      ADD A,001H
000A3B D834 38B3            12      JR  C,FEND
                                
000A3D D836 7D               4      LD  A,L
000A3E D837 D601             7      SUB 001H
       D839                     FENDX:
000A40 D839 9F               4      SBC A,A
000A41 D83A E603             7      AND 3
000A43 D83C 1F               4      RRA
000A44 D83D 18AB            12      JR  FENDE
                                
       D83F                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000A46 D83F CD9FDF          17      CALL    SETDRV
000A49 D842 CD55E4          17      CALL    INIT_SEQ
       D845                     SWRITE:
000A4C D845 CD96E4          17      CALL    RB_WRITE
                                
000A4F D848 C6FF             7      ADD A,0FFH
000A51 D84A 18ED            12      JR  FENDX
                                
       D84C                     _SYS17:     ;(BDOS)ファイル名の変更
000A53 D84C CD9FDF          17      CALL    SETDRV
000A56 D84F CD79E2          17      CALL    NAME
000A59 D852 18D3            12      JR  FEND13
                                
       D854                     _SYS16:     ;(BDOS)ファイルの作成
000A5B D854 CD9FDF          17      CALL    SETDRV
                                
000A5E D857 CDEDE2          17      CALL    CHKWILDX
000A61 D85A 38CB            12      JR  C,FEND13
000A63 D85C FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000A66 D85F FE05             7      CP  5
000A68 D861 2805            12      JR  Z,_S16X2
000A6A D863 FE21             7      CP  021H
000A6C D865 DA27D8          10      JP  C,FEND13
       D868                     _S16X2:
                                ;               Clear FCB
000A6F D868 FDE5            15      PUSH    IY
000A71 D86A E1              10      POP HL
000A72 D86B 011000          10      LD  BC,16
000A75 D86E 09              11      ADD HL,BC
       D86F                     _S16X1:
000A76 D86F 70               7      LD  (HL),B      ;B=0
000A77 D870 23               6      INC HL
000A78 D871 0D               4      DEC C
000A79 D872 20FB            12      JR  NZ,_S16X1
                                
000A7B D874 CDEEE3          17      CALL    SETTMSX
000A7E D877 FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000A82 D87B CDC9DF          17      CALL    SOPENX
000A85 D87E 3F               4      CCF
000A86 D87F CCFAD7          17      CALL    Z,_S16K
000A89 D882 D4A8E0          17      CALL    NC,COPEN
000A8C D885 D4FDE2          17      CALL    NC,SDIRENT
000A8F D888 C31CD7          10      JP  _S16XX
                                
       D88B                     _SYS21:     ;(BDOS)ランダムな読み出し
000A92 D88B CD9FDF          17      CALL    SETDRV
000A95 D88E CD39E4          17      CALL    INIT_RND
000A98 D891 189C            12      JR  SREAD
                                
       D893                     _SYS22:     ;(BDOS)ランダムな書き込み
       D893                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000A9A D893 CD9FDF          17      CALL    SETDRV
000A9D D896 CD39E4          17      CALL    INIT_RND
000AA0 D899 18AA            12      JR  SWRITE
                                
       D89B                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000AA2 D89B 21FF00          10      LD  HL,000FFH
000AA5 D89E AF               4      XOR A
000AA6 D89F C9              10      RET
                                
       D8A0                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000AA7 D8A0 3A87EF          13      LD  A,(_DVSW)
000AAA D8A3 A7               4      AND A
000AAB D8A4 C9              10      RET
                                
       D8A5                     _SYS1A:     ;(BDOS)DTAの設定
000AAC D8A5 ED538AEF        20      LD  (_DTA),DE
000AB0 D8A9 AF               4      XOR A
000AB1 D8AA C9              10      RET
                                
       D8AB                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000AB2 D8AB 7B               4      LD  A,E
000AB3 D8AC CDADDF          17      CALL    GETDRV
000AB6 D8AF CDDCEF          17      CALL    _GETDPB
000AB9 D8B2 D4E2EF          17      CALL    NC,_RDFATX
000ABC D8B5 210000          10      LD  HL,0
000ABF D8B8 D4C7E3          17      CALL    NC,DSKF
                                
000AC2 D8BB ED5BC8E3        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000AC6 D8BF 1B               6      DEC DE      ;DE←クラスタの総数
000AC7 D8C0 FD2A7CF0        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000ACB D8C4 9F               4      SBC A,A
000ACC D8C5 D8              11      RET C
000ACD D8C6 4F               4      LD  C,A     ;C=0
000ACE D8C7 DD7E0F          19      LD  A,(IX+DPB_BPS)
000AD1 D8CA E607             7      AND 7
000AD3 D8CC 47               4      LD  B,A
000AD4 D8CD DD7E07          19      LD  A,(IX+DPB_SECPCL)
000AD7 D8D0 C9              10      RET
                                
       D8D1                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000AD8 D8D1 AF               4      XOR A
000AD9 D8D2 67               4      LD  H,A
000ADA D8D3 6F               4      LD  L,A
000ADB D8D4 C9              10      RET
                                
       D8D5                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000ADC D8D5 2100F2          10      LD  HL,_DEVICE
000ADF D8D8 7B               4      LD  A,E
000AE0 D8D9 C3DCEF          10      JP  _GETDPB
                                
       D8DC                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000AE3 D8DC E5              11      PUSH    HL
000AE4 D8DD 2A1EF0          16      LD  HL,(STABLE+2*00FH)  ;ファイルのオープン
000AE7 D8E0 CD0F00          17      CALL    JP_HL
000AEA D8E3 381B            12      JR  C,_S23X1
                                
000AEC D8E5 D5              11      PUSH    DE      ;EX DE,IY
000AED D8E6 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000AEF D8E8 FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000AF2 D8EB FD6E11          19      LD  L,(IY+17)   ;
000AF5 D8EE FD6612          19      LD  H,(IY+18)   ;
000AF8 D8F1 C5              11      PUSH    BC      ;
000AF9 D8F2 FD4613          19      LD  B,(IY+19)   ;
000AFC D8F5 CD2BE4          17      CALL    GET_CPM_R_SIZE
000AFF D8F8 C1              10      POP BC
       D8F9                     _S24X1:
000B00 D8F9 CD4BE4          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000B03 D8FC FDE3            23      EX  (SP),IY     ;
000B05 D8FE D1              10      POP DE      ;
                                
000B06 D8FF AF               4      XOR A
       D900                     _S23X1:
000B07 D900 E1              10      POP HL
000B08 D901 C9              10      RET
                                
       D902                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000B09 D902 E5              11      PUSH    HL
000B0A D903 D5              11      PUSH    DE      ;EX DE,IY
000B0B D904 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000B0D D906 CD5DE4          17      CALL    GETSEQ
000B10 D909 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D90B                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000B12 D90B C5              11      PUSH    BC
000B13 D90C E5              11      PUSH    HL
000B14 D90D CDB6DE          17      CALL    FILE
000B17 D910 E1              10      POP HL
000B18 D911 C1              10      POP BC
       D912                     S29X1:
000B19 D912 C5              11      PUSH    BC
000B1A D913 D5              11      PUSH    DE
000B1B D914 E5              11      PUSH    HL
000B1C D915 EB               4      EX  DE,HL
000B1D D916 AF               4      XOR A
000B1E D917 3221EF          13      LD  (FDRV+13),A
000B21 D91A 2114EF          10      LD  HL,FDRV
000B24 D91D 011000          10      LD  BC,16
000B27 D920 EDB0                    LDIR
000B29 D922 E1              10      POP HL
000B2A D923 D1              10      POP DE
000B2B D924 C1              10      POP BC
000B2C D925 C9              10      RET
                                
       D926                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000B2D D926 C5              11      PUSH    BC
000B2E D927 01AEEA          10      LD  BC,DWT24B
000B31 D92A 1804            12      JR  S2FX
       D92C                     _SYS2F:
000B33 D92C C5              11      PUSH    BC
000B34 D92D 019EEA          10      LD  BC,DRD24B
       D930                     S2FX:
000B37 D930 ED4346D9        20      LD  (S2FPAT+1),BC
000B3B D934 CDDFEF          17      CALL    _FFLUSH
                                
000B3E D937 D5              11      PUSH    DE
000B3F D938 E5              11      PUSH    HL
000B40 D939 7D               4      LD  A,L     ;Drive
000B41 D93A CDD9EF          17      CALL    _CHGDRV
000B44 D93D 3809            12      JR  C,S30X2
000B46 D93F 44               4      LD  B,H     ;Number of clusters
000B47 D940 2A8AEF          16      LD  HL,(_DTA)
                                
000B4A D943 0E00             7      LD  C,0
000B4C D945 CD9EEA          17  S2FPAT: CALL    DRD24B
       D948                     S30X2:
000B4F D948 E1              10      POP HL
000B50 D949 D1              10      POP DE
000B51 D94A C1              10      POP BC
000B52 D94B 9F               4      SBC A,A
000B53 D94C C9              10      RET
                                
       D94D                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000B54 D94D C5              11      PUSH    BC
000B55 D94E D5              11      PUSH    DE
000B56 D94F E5              11      PUSH    HL
000B57 D950 CDABDE          17      CALL    FILEC
000B5A D953 210000          10      LD  HL,0
000B5D D956 1114EF          10      LD  DE,FDRV
000B60 D959 2A4EF0          16      LD  HL,(STABLE+2*027H)  ;ランダムブロック読み込み
000B63 D95C CD0F00          17      CALL    JP_HL
000B66 D95F 18E7            12      JR  S30X2
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "88IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   PC-8801mkIISR
                                
       D6D0                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D6D0                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D6D0                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D6D0                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D6D0                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D6D0                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       D961                     BDOS_RF:
000B68 D961 DB32            11      IN  A,(032H)
000B6A D963 F610             7      OR  010H        ;高速RAMアクセスモードOFF
000B6C D965 D332            11      OUT (032H),A
000B6E D967 C3A0D6          10      JP  BDOS0
                                
       D96A                     INTVRTC:
000B71 D96A F3               4      DI
000B72 D96B F5              11      PUSH    AF
000B73 D96C CDD1DD          17      CALL    CHKEY
000B76 D96F FE00             7      CP  0
       D970                     KEYDT   EQU $-1
000B78 D971 2028            12      JR  NZ,SETKEY1
000B7A D973 E5              11      PUSH    HL
000B7B D974 2A90EF          16      LD  HL,(_KEYPS)
000B7E D977 7C               4      LD  A,H
000B7F D978 AD               4      XOR L
000B80 D979 E1              10      POP HL
000B81 D97A 2011            12      JR  NZ,ENDKEY
000B83 D97C 3E00             7      LD  A,0
       D97D                     KEYAR   EQU $-1
000B85 D97E B7               4      OR  A
000B86 D97F 2014            12      JR  NZ,ARWKEY
       D981                     SETKEY:
000B88 D981 327DD9          13      LD  (KEYAR),A
000B8B D984 3A92EF          13      LD  A,(_KEYD)
000B8E D987 3270D9          13      LD  (KEYDT),A
000B91 D98A CDA8D9          17      CALL    KEYSET
       D98D                     ENDKEY:
000B94 D98D 3AB7EF          13      LD  A,(WKE4)
000B97 D990 D3E4            11      OUT (0E4H),A
000B99 D992 F1              10      POP AF
000B9A D993 FB               4      EI
000B9B D994 C9              10      RET
       D995                     ARWKEY:
000B9C D995 3D               4      DEC A
000B9D D996 327DD9          13      LD  (KEYAR),A
000BA0 D999 18F2            12      JR  ENDKEY
       D99B                     SETKEY1:
000BA2 D99B 3A95EF          13      LD  A,(_KEYSP+1)
000BA5 D99E 18E1            12      JR  SETKEY
                                
       D9A0                     INTE88:
000BA7 D9A0 F5              11      PUSH    AF
000BA8 D9A1 3AB7EF          13      LD  A,(WKE4)
000BAB D9A4 D3E4            11      OUT (0E4H),A
000BAD D9A6 F1              10      POP AF
000BAE D9A7 C9              10      RET
       D9A8                     KEYSET:
       D9A8                     KEYBS:
000BAF D9A8 B7               4      OR  A
000BB0 D9A9 C8              11      RET Z
       D9AA                     KEYBS1:
000BB1 D9AA CDC2D9          17      CALL    KEYBC_IFBREAK
000BB4 D9AD E5              11      PUSH    HL
000BB5 D9AE F5              11      PUSH    AF
000BB6 D9AF 2A90EF          16      LD  HL,(_KEYPS)
000BB9 D9B2 2C               4      INC L
000BBA D9B3 CBAD             8      RES 5,L
000BBC D9B5 7D               4      LD  A,L
000BBD D9B6 BC               4      CP  H
000BBE D9B7 2815            12      JR  Z,POP_AF_HL_SCF_RET
000BC0 D9B9 3290EF          13      LD  (_KEYPS),A
000BC3 D9BC 26FF             7      LD  H,KEYBF/256
000BC5 D9BE F1              10      POP AF
000BC6 D9BF 77               7      LD  (HL),A
000BC7 D9C0 E1              10      POP HL
000BC8 D9C1 C9              10      RET
       D9C2                     KEYBC_IFBREAK:
000BC9 D9C2 FE03             7      CP  3
000BCB D9C4 C0              11      RET NZ
       D9C5                     KEYBC:
000BCC D9C5 E5              11      PUSH    HL
000BCD D9C6 210000          10      LD  HL,0
000BD0 D9C9 2290EF          16      LD  (_KEYPS),HL
000BD3 D9CC E1              10      POP HL
000BD4 D9CD C9              10      RET
                                
       D9CE                     POP_AF_HL_SCF_RET:
000BD5 D9CE F1              10      POP AF
000BD6 D9CF E1              10      POP HL
000BD7 D9D0 37               4      SCF
000BD8 D9D1 C9              10      RET
                                
       D9D2                     _SYS01:     ;(BDOS)コンソール入力
000BD9 D9D2 CD09EF          17      CALL    _SYS07
       D9D5                     MSG_A:
000BDC D9D5 F5              11      PUSH    AF
000BDD D9D6 D5              11      PUSH    DE
000BDE D9D7 5F               4      LD  E,A
000BDF D9D8 CDDED9          17      CALL    _SYS02
000BE2 D9DB D1              10      POP DE
000BE3 D9DC F1              10      POP AF
000BE4 D9DD C9              10      RET
                                
       D9DE                     _SYS02:     ;(BDOS)コンソール出力
000BE5 D9DE CDF0D9          17      CALL    BREAK
000BE8 D9E1 1805            12      JR  PRINTX
                                
       D9E3                     _SYS06:     ;(BDOS)コンソール直接入出力
000BEA D9E3 7B               4      LD  A,E
000BEB D9E4 3C               4      INC A
000BEC D9E5 CACAEF          10      JP  Z,_INKEY
       D9E8                     PRINTX:
000BEF D9E8 C3CDEF          10      JP  _PRINT
                                
       D9EB                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000BF2 D9EB CD09EF          17      CALL    _SYS07
000BF5 D9EE 1804            12      JR  BREAK1
       D9F0                     BREAK:
000BF7 D9F0 FB               4      EI
000BF8 D9F1 3A92EF          13      LD  A,(_KEYD)
       D9F4                     BREAK1:
000BFB D9F4 FE03             7      CP  3       ;CTRL+C
000BFD D9F6 CA00EF          10      JP  Z,CPM_BOOT
000C00 D9F9 FE13             7      CP  013H        ;CTRL+S
000C02 D9FB C0              11      RET NZ
                                
       D9FC                     PAUSE:
000C03 D9FC CDC5D9          17      CALL    KEYBC
                                
       D9FF                     FLGET:
000C06 D9FF CDDFEF          17      CALL    _FFLUSH
000C09 DA02 E5              11      PUSH    HL
000C0A DA03 2A8EEF          16      LD  HL,(_TXADR)
000C0D DA06 CD90DC          17      CALL    CURSOR_ON
       DA09                     FLGET1:
000C10 DA09 CDCAEF          17      CALL    _INKEY
000C13 DA0C 28FB            12      JR  Z,FLGET1
000C15 DA0E CDA1DC          17      CALL    CURSOR_OFF
000C18 DA11 E1              10      POP HL
000C19 DA12 C9              10      RET
                                
       DA13                     _SYS0A:     ;(BDOS)文字列入力
000C1A DA13 C5              11      PUSH    BC
000C1B DA14 E5              11      PUSH    HL
000C1C DA15 D5              11      PUSH    DE
000C1D DA16 CD60DD          17      CALL    GETL
000C20 DA19 1120FF          10      LD  DE,KBUF
000C23 DA1C E1              10      POP HL
000C24 DA1D E5              11      PUSH    HL
000C25 DA1E 0E00             7      LD  C,0
000C27 DA20 3004            12      JR  NC,SAX0
000C29 DA22 23               6      INC HL
000C2A DA23 23               6      INC HL
000C2B DA24 1808            12      JR  SAX4
       DA26                     SAX0:
000C2D DA26 46               7      LD  B,(HL)
000C2E DA27 23               6      INC HL
       DA28                     SAX1:
000C2F DA28 23               6      INC HL
000C30 DA29 1A               7      LD  A,(DE)
000C31 DA2A 13               6      INC DE
000C32 DA2B B7               4      OR  A
000C33 DA2C 2004            12      JR  NZ,SAX2
       DA2E                     SAX4:
000C35 DA2E 360D            10      LD  (HL),00DH
000C37 DA30 1804            12      JR  SAX3
       DA32                     SAX2:
000C39 DA32 77               7      LD  (HL),A
000C3A DA33 0C               4      INC C
000C3B DA34 10F2            13      DJNZ    SAX1
       DA36                     SAX3:
000C3D DA36 D1              10      POP DE
000C3E DA37 79               4      LD  A,C
000C3F DA38 13               6      INC DE
000C40 DA39 12               7      LD  (DE),A
000C41 DA3A 1B               6      DEC DE
000C42 DA3B E1              10      POP HL
000C43 DA3C C1              10      POP BC
000C44 DA3D A7               4      AND A
000C45 DA3E C9              10      RET
                                
       DA3F                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000C46 DA3F CDF0D9          17      CALL    BREAK
000C49 DA42 3A92EF          13      LD  A,(_KEYD)
000C4C DA45 B7               4      OR  A
000C4D DA46 C8              11      RET Z
       DA47                     CONSTX:
000C4E DA47 CDDFEF          17      CALL    _FFLUSH
000C51 DA4A E5              11      PUSH    HL
000C52 DA4B 2A90EF          16      LD  HL,(_KEYPS)
000C55 DA4E 7C               4      LD  A,H
000C56 DA4F AD               4      XOR L
000C57 DA50 E1              10      POP HL
000C58 DA51 C6FF             7      ADD A,0FFH
000C5A DA53 9F               4      SBC A,A
000C5B DA54 C9              10      RET
                                
       DA55                     _SYS2A:     ;(BDOS)日付の獲得
000C5C DA55 C5              11      PUSH    BC
000C5D DA56 CD95DA          17      CALL    RTCREAD
000C60 DA59 3A62EF          13      LD  A,(RTC_YY)
000C63 DA5C CDF8DA          17      CALL    BCD
000C66 DA5F 6F               4      LD  L,A
000C67 DA60 2600             7      LD  H,0
                                ;   LD  DE,1900     ;0076CH
                                ;   CP  90      ;90以上は1900年代 1990-1999
                                ;   JR  NC,RDDATE1  ;90未満は2000年代 2000-2089
                                ;   LD  E,0D0H      ;2000 & 0FFH D=007H
000C69 DA62 11D007          10      LD  DE,2000     ;すべて2000年代で処理 2000-2099
       DA65                     RDDATE1:
000C6C DA65 19              11      ADD HL,DE
000C6D DA66 3A63EF          13      LD  A,(RTC_MW)
000C70 DA69 57               4      LD  D,A
000C71 DA6A 3A64EF          13      LD  A,(RTC_DD)
000C74 DA6D CDF8DA          17      CALL    BCD
000C77 DA70 5F               4      LD  E,A
000C78 DA71 7A               4      LD  A,D
000C79 DA72 0604             7      LD  B,4
       DA74                     RDDATE2:
000C7B DA74 CB3A             8      SRL D
000C7D DA76 10FC            13      DJNZ    RDDATE2
000C7F DA78 C1              10      POP BC
000C80 DA79 E607             7      AND 7
000C82 DA7B C9              10      RET
                                
       DA7C                     _SYS2C:     ;(BDOS)時刻の獲得
000C83 DA7C C5              11      PUSH    BC
000C84 DA7D CD95DA          17      CALL    RTCREAD
000C87 DA80 3A65EF          13      LD  A,(RTC_TT)
000C8A DA83 CDF8DA          17      CALL    BCD
000C8D DA86 67               4      LD  H,A
000C8E DA87 3A66EF          13      LD  A,(RTC_MM)
000C91 DA8A CDF8DA          17      CALL    BCD
000C94 DA8D 6F               4      LD  L,A
000C95 DA8E 3A67EF          13      LD  A,(RTC_SS)
000C98 DA91 57               4      LD  D,A
000C99 DA92 C1              10      POP BC
000C9A DA93 AF               4      XOR A
000C9B DA94 C9              10      RET
                                
       DA95                     RTCREAD:
000C9C DA95 0EF9             7      LD  C,0F9H
000C9E DA97 3AB9EF          13      LD  A,(WK40)
000CA1 DA9A 5F               4      LD  E,A
000CA2 DA9B 3E03             7      LD  A,3     ;コマンド３：タイムリードにセット
000CA4 DA9D CDC7DA          17      CALL    RTCCMD
000CA7 DAA0 3E01             7      LD  A,1     ;コマンド１：レジスタシフトにセット
000CA9 DAA2 CDC7DA          17      CALL    RTCCMD
000CAC DAA5 0606             7      LD  B,6
000CAE DAA7 2167EF          10      LD  HL,RTC_SS
       DAAA                     RTCREAD1:
000CB1 DAAA C5              11      PUSH    BC
000CB2 DAAB 0608             7      LD  B,8
       DAAD                     RTCREAD2:
000CB4 DAAD DB40            11      IN  A,(40H)     ;システムモードセンス BIT4:CDI
000CB6 DAAF 87               4      ADD A,A
000CB7 DAB0 87               4      ADD A,A
000CB8 DAB1 87               4      ADD A,A
000CB9 DAB2 87               4      ADD A,A
000CBA DAB3 CB1E            15      RR  (HL)
000CBC DAB5 CDECDA          17      CALL    RTCCLK
000CBF DAB8 10F3            13      DJNZ    RTCREAD2
000CC1 DABA C1              10      POP BC
000CC2 DABB 2B               6      DEC HL
000CC3 DABC 10EC            13      DJNZ    RTCREAD1
000CC5 DABE AF               4      XOR A
000CC6 DABF CDC7DA          17      CALL    RTCCMD
000CC9 DAC2 7B               4      LD  A,E
000CCA DAC3 32B9EF          13      LD  (WK40),A
000CCD DAC6 C9              10      RET
                                
       DAC7                     RTCCMD:
000CCE DAC7 0604             7      LD  B,4
000CD0 DAC9 07               4      RLCA
000CD1 DACA 07               4      RLCA
000CD2 DACB 07               4      RLCA
       DACC                     RTCCMD1:
000CD3 DACC F5              11      PUSH    AF
000CD4 DACD F607             7      OR  7
000CD6 DACF D310            11      OUT (10H),A     ;プリンタデータ出力 兼 カレンダクロック(μPD1990AC)出力
000CD8 DAD1 CDECDA          17      CALL    RTCCLK
000CDB DAD4 F1              10      POP AF
000CDC DAD5 0F               4      RRCA
000CDD DAD6 10F4            13      DJNZ    RTCCMD1
000CDF DAD8 3E07             7      LD  A,7
000CE1 DADA D310            11      OUT (10H),A     ;プリンタデータ出力 兼 カレンダクロック(μPD1990AC)出力
000CE3 DADC 7B               4      LD  A,E
000CE4 DADD A1               4      AND C
000CE5 DADE F602             7      OR  2
000CE7 DAE0 D340            11      OUT (40H),A     ;ストローブポート
000CE9 DAE2 A1               4      AND C
000CEA DAE3 00               4      NOP
000CEB DAE4 D340            11      OUT (40H),A     ;ストローブポート
000CED DAE6 5F               4      LD  E,A
000CEE DAE7 060D             7      LD  B,13
       DAE9                     RTCCMD3:
000CF0 DAE9 10FE            13      DJNZ    RTCCMD3
000CF2 DAEB C9              10      RET
                                
       DAEC                     RTCCLK:
000CF3 DAEC 7B               4      LD  A,E
000CF4 DAED A1               4      AND C
000CF5 DAEE F604             7      OR  04H
000CF7 DAF0 D340            11      OUT (40H),A
000CF9 DAF2 A1               4      AND C
000CFA DAF3 00               4      NOP
000CFB DAF4 D340            11      OUT (40H),A
000CFD DAF6 5F               4      LD  E,A
000CFE DAF7 C9              10      RET
                                
                                ;------------------------
                                ;BCDの10進数化
                                ;in
                                ;   A  : BCD
                                ;out
                                ;   A  : 10進数
                                ;------------------------
       DAF8                     BCD:
000CFF DAF8 4F               4      LD  C,A
000D00 DAF9 E6F0             7      AND 0F0H    ;10の位
000D02 DAFB 0F               4      RRCA
000D03 DAFC 47               4      LD  B,A
000D04 DAFD 0F               4      RRCA
000D05 DAFE 0F               4      RRCA
000D06 DAFF 80               4      ADD A,B
000D07 DB00 47               4      LD  B,A
000D08 DB01 79               4      LD  A,C
000D09 DB02 E60F             7      AND 00FH    ;1の位
000D0B DB04 80               4      ADD A,B
000D0C DB05 C9              10      RET
                                
       DB06                     ESC1:
000D0D DB06 7B               4      LD  A,E
000D0E DB07 FE41             7      CP  'A'
000D10 DB09 CAEBDB          10      JP  Z,CTRL1E
000D13 DB0C FE42             7      CP  'B'
000D15 DB0E CA0ADD          10      JP  Z,CTRL1F
000D18 DB11 FE43             7      CP  'C'
000D1A DB13 CAB1DB          10      JP  Z,CTRL1C
000D1D DB16 FE44             7      CP  'D'
000D1F DB18 CAD6DB          10      JP  Z,CTRL1D
000D22 DB1B FE45             7      CP  'E'
000D24 DB1D 2802            12      JR  Z,CT0CX
000D26 DB1F FE6A             7      CP  'j'
       DB21                     CT0CX:
000D28 DB21 CAD7DC          10      JP  Z,CTRL0C
000D2B DB24 FE48             7      CP  'H'
000D2D DB26 CA56DC          10      JP  Z,CTRL0B
000D30 DB29 FE4A             7      CP  'J'
000D32 DB2B CADADC          10      JP  Z,CTRL06
000D35 DB2E FE4B             7      CP  'K'
000D37 DB30 CA2ADC          10      JP  Z,CTRL05
000D3A DB33 FE4C             7      CP  'L'
000D3C DB35 CA11DD          10      JP  Z,CTRL0E
000D3F DB38 FE54             7      CP  'T'
000D41 DB3A CA2ADC          10      JP  Z,CTRL05
000D44 DB3D FE78             7      CP  'x'
000D46 DB3F 2804            12      JR  Z,ESC1X
000D48 DB41 FE79             7      CP  'y'
000D4A DB43 2002            12      JR  NZ,ESC1Y
       DB45                     ESC1X:
000D4C DB45 3601            10      LD  (HL),1
       DB47                     ESC1Y:
000D4E DB47 FE3D             7      CP  '='
000D50 DB49 2804            12      JR  Z,ESC1W
000D52 DB4B FE59             7      CP  'Y'
000D54 DB4D 2002            12      JR  NZ,ESC1Z
       DB4F                     ESC1W:
000D56 DB4F 3602            10      LD  (HL),2
       DB51                     ESC1Z:
000D58 DB51 FE20             7      CP  020H
000D5A DB53 3802            12      JR  C,ESC1C
000D5C DB55 87               4      ADD A,A
000D5D DB56 D0              11      RET NC
       DB57                     ESC1C:
000D5E DB57 E1              10      POP HL
000D5F DB58 1832            12      JR  ANK
                                
       DB5A                     ESC:
000D61 DB5A 219DDB          10      LD  HL,PRINTE5
000D64 DB5D E5              11      PUSH    HL
000D65 DB5E 2180DB          10      LD  HL,ESCFLG
000D68 DB61 3600            10      LD  (HL),0
000D6A DB63 3D               4      DEC A
000D6B DB64 28A0            12      JR  Z,ESC1
000D6D DB66 3D               4      DEC A
000D6E DB67 2009            12      JR  NZ,ESC2
000D70 DB69 3603            10      LD  (HL),3
000D72 DB6B 7B               4      LD  A,E
000D73 DB6C D620             7      SUB 020H
000D75 DB6E 3275DB          13      LD  (ESCYP+1),A
000D78 DB71 C9              10      RET
       DB72                     ESC2:
000D79 DB72 3D               4      DEC A
000D7A DB73 C0              11      RET NZ
000D7B DB74 2600             7  ESCYP:  LD  H,0
000D7D DB76 7B               4      LD  A,E
000D7E DB77 D620             7      SUB 020H
000D80 DB79 6F               4      LD  L,A
000D81 DB7A C3D6EF          10      JP  _LOC
                                
       DB7D                     PRINT:
000D84 DB7D C5              11      PUSH    BC
000D85 DB7E E5              11      PUSH    HL
000D86 DB7F 3E00             7      LD  A,000H      ;自己書き換え
       DB80                     ESCFLG  EQU $-1
000D88 DB81 B7               4      OR  A
000D89 DB82 20D6            12      JR  NZ,ESC
                                
000D8B DB84 3E1F             7      LD  A,01FH
000D8D DB86 BB               4      CP  E
000D8E DB87 3018            12      JR  NC,CTRL
       DB89                     INSFLG  EQU $
000D90 DB89 01B9DC          10      LD  BC,INSERT   ;自己書き換え
       DB8C                     ANK:
000D93 DB8C CD63DC          17      CALL    LOC0
000D96 DB8F DB32            11      IN  A,(032H)
000D98 DB91 F5              11      PUSH    AF
000D99 DB92 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000D9B DB94 D332            11      OUT (032H),A
000D9D DB96 73               7      LD  (HL),E
000D9E DB97 F1              10      POP AF
000D9F DB98 D332            11      OUT (032H),A
000DA1 DB9A CDB1DB          17      CALL    CTRL1C
       DB9D                     PRINTE5:
000DA4 DB9D E1              10      POP HL
000DA5 DB9E C1              10      POP BC
000DA6 DB9F AF               4      XOR A
000DA7 DBA0 C9              10      RET
                                
       DBA1                     CTRL:
000DA8 DBA1 7B               4      LD  A,E
000DA9 DBA2 87               4      ADD A,A
000DAA DBA3 F680             7      OR  080H
000DAC DBA5 6F               4      LD  L,A
000DAD DBA6 26F0             7      LD  H,CTRLTB/256
000DAF DBA8 7E               7      LD  A,(HL)
000DB0 DBA9 2C               4      INC L
000DB1 DBAA 66               7      LD  H,(HL)
000DB2 DBAB 6F               4      LD  L,A
000DB3 DBAC CD0F00          17      CALL    JP_HL
000DB6 DBAF 18EC            12      JR  PRINTE5
                                
       DBB1                     CTRL1C:
000DB8 DBB1 2A8EEF          16      LD  HL,(_TXADR)
000DBB DBB4 2C               4      INC L
       DBB5                     PRINTE3:
000DBC DBB5 3AB1EF          13      LD  A,(_WIDTH)
000DBF DBB8 3D               4      DEC A
000DC0 DBB9 BD               4      CP  L
000DC1 DBBA 3009            12      JR  NC,SET_TXADR_HL
000DC3 DBBC 2E00             7      LD  L,0
000DC5 DBBE 24               4      INC H
       DBBF                     PRINTE8:
000DC6 DBBF 3A97EF          13      LD  A,(_LINE)
000DC9 DBC2 BC               4      CP  H
000DCA DBC3 2804            12      JR  Z,PRINT2
       DBC5                     LOC:
       DBC5                     SET_TXADR_HL:
000DCC DBC5 228EEF          16      LD  (_TXADR),HL
       DBC8                     CTRL00:
000DCF DBC8 C9              10      RET
                                
       DBC9                     PRINT2:
000DD0 DBC9 CD17DD          17      CALL    SCR
000DD3 DBCC 25               4      DEC H
000DD4 DBCD 18F6            12      JR  SET_TXADR_HL
                                
       DBCF                     CTRL08:
000DD6 DBCF 3A89DB          13      LD  A,(INSFLG)
000DD9 DBD2 FECD             7      CP  0CDH        ;CALL ????
000DDB DBD4 2829            12      JR  Z,CTRL02
       DBD6                     CTRL1D:
000DDD DBD6 2A8EEF          16      LD  HL,(_TXADR)
000DE0 DBD9 7C               4      LD  A,H
000DE1 DBDA B5               4      OR  L
000DE2 DBDB C8              11      RET Z
000DE3 DBDC 7D               4      LD  A,L
000DE4 DBDD B7               4      OR  A
000DE5 DBDE 2803            12      JR  Z,CTRL1DX1
000DE7 DBE0 2D               4      DEC L
000DE8 DBE1 18E2            12      JR  SET_TXADR_HL
       DBE3                     CTRL1DX1:
000DEA DBE3 3AB1EF          13      LD  A,(_WIDTH)
000DED DBE6 3D               4      DEC A
000DEE DBE7 6F               4      LD  L,A
000DEF DBE8 25               4      DEC H
000DF0 DBE9 18DA            12      JR  SET_TXADR_HL
       DBEB                     CTRL1E:
000DF2 DBEB 2A8EEF          16      LD  HL,(_TXADR)
000DF5 DBEE 7C               4      LD  A,H
000DF6 DBEF B7               4      OR  A
000DF7 DBF0 C8              11      RET Z
000DF8 DBF1 25               4      DEC H
000DF9 DBF2 18D1            12      JR  SET_TXADR_HL
                                
       DBF4                     CTRL09:
000DFB DBF4 2A8EEF          16      LD  HL,(_TXADR)
000DFE DBF7 7D               4      LD  A,L
000DFF DBF8 E6F8             7      AND 0F8H
000E01 DBFA C608             7      ADD A,8
000E03 DBFC 6F               4      LD  L,A
000E04 DBFD 18B6            12      JR  PRINTE3
                                
       DBFF                     CTRL02:
000E06 DBFF 3A8EEF          13      LD  A,(_TXADR)
000E09 DC02 B7               4      OR  A
000E0A DC03 28D1            12      JR  Z,CTRL1D
000E0C DC05 CDD6DB          17      CALL    CTRL1D
000E0F DC08 2A8EEF          16      LD  HL,(_TXADR)
000E12 DC0B 3AB1EF          13      LD  A,(_WIDTH)
000E15 DC0E 4F               4      LD  C,A
000E16 DC0F 95               4      SUB L
000E17 DC10 47               4      LD  B,A
000E18 DC11 79               4      LD  A,C
000E19 DC12 3D               4      DEC A
000E1A DC13 6F               4      LD  L,A
000E1B DC14 CD66DC          17      CALL    LOC1
                                
000E1E DC17 DB32            11      IN  A,(032H)
000E20 DC19 F5              11      PUSH    AF
000E21 DC1A E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000E23 DC1C D332            11      OUT (032H),A
                                
000E25 DC1E 3E20             7      LD  A,020H
       DC20                     C8X1:
000E27 DC20 4E               7      LD  C,(HL)
000E28 DC21 77               7      LD  (HL),A
000E29 DC22 2B               6      DEC HL
000E2A DC23 79               4      LD  A,C
000E2B DC24 10FA            13      DJNZ    C8X1
                                
000E2D DC26 F1              10      POP AF
000E2E DC27 D332            11      OUT (032H),A
000E30 DC29 C9              10      RET
                                
       DC2A                     CTRL05:
000E31 DC2A CDD3EF          17      CALL    _POS
000E34 DC2D 2A8EEF          16      LD  HL,(_TXADR)
000E37 DC30 3AB1EF          13      LD  A,(_WIDTH)
000E3A DC33 95               4      SUB L
000E3B DC34 47               4      LD  B,A
000E3C DC35 CD63DC          17      CALL    LOC0
       DC38                     CLLINE:
000E3F DC38 DB32            11      IN  A,(032H)
000E41 DC3A F5              11      PUSH    AF
000E42 DC3B E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000E44 DC3D D332            11      OUT (032H),A
000E46 DC3F 3E20             7      LD  A,020H
       DC41                     CLLINE1:
000E48 DC41 77               7      LD  (HL),A
000E49 DC42 23               6      INC HL
000E4A DC43 10FC            13      DJNZ    CLLINE1
                                
000E4C DC45 F1              10      POP AF
000E4D DC46 D332            11      OUT (032H),A
000E4F DC48 C9              10      RET
                                
       DC49                     CTRL0D:
000E50 DC49 AF               4      XOR A
000E51 DC4A 328EEF          13      LD  (_TXADR),A
000E54 DC4D C9              10      RET
                                
       DC4E                     CTRL12:
000E55 DC4E 2189DB          10      LD  HL,INSFLG
000E58 DC51 7E               7      LD  A,(HL)
000E59 DC52 EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000E5B DC54 77               7      LD  (HL),A
000E5C DC55 C9              10      RET
                                
       DC56                     CTRL0B:
000E5D DC56 210000          10      LD  HL,0
000E60 DC59 228EEF          16      LD  (_TXADR),HL
000E63 DC5C C9              10      RET
                                
       DC5D                     CTRL1B:
000E64 DC5D 3E01             7      LD  A,1
000E66 DC5F 3280DB          13      LD  (ESCFLG),A
000E69 DC62 C9              10      RET
       DC63                     LOC0:
000E6A DC63 2A8EEF          16      LD  HL,(_TXADR)
       DC66                     LOC1:
000E6D DC66 D5              11      PUSH    DE
000E6E DC67 E5              11      PUSH    HL
000E6F DC68 6C               4      LD  L,H ;Y
000E70 DC69 5C               4      LD  E,H
000E71 DC6A 2600             7      LD  H,0
000E73 DC6C 54               4      LD  D,H
000E74 DC6D 29              11      ADD HL,HL   ;*2
000E75 DC6E 29              11      ADD HL,HL   ;*4
000E76 DC6F 29              11      ADD HL,HL   ;*8
000E77 DC70 29              11      ADD HL,HL   ;*16
000E78 DC71 ED52            15      SBC HL,DE   ;*15
000E7A DC73 29              11      ADD HL,HL   ;*30
000E7B DC74 29              11      ADD HL,HL   ;*60
000E7C DC75 29              11      ADD HL,HL   ;*120
000E7D DC76 D1              10      POP DE
000E7E DC77 1600             7      LD  D,0
000E80 DC79 19              11      ADD HL,DE   ;X
000E81 DC7A ED5BB2EF        20      LD  DE,(TVRAMTOP)
000E85 DC7E 19              11      ADD HL,DE
000E86 DC7F D1              10      POP DE
000E87 DC80 C9              10      RET
                                
       DC81                     CONOUT1:
000E88 DC81 59               4      LD  E,C
000E89 DC82 CDCDEF          17      CALL    _PRINT
000E8C DC85 7B               4      LD  A,E
000E8D DC86 FE0A             7      CP  00AH
000E8F DC88 2006            12      JR  NZ,CURSOR_ON
000E91 DC8A CD49DC          17      CALL    CTRL0D
000E94 DC8D CD2ADC          17      CALL    CTRL05
       DC90                     CURSOR_ON:
000E97 DC90 F5              11      PUSH    AF
000E98 DC91 3E81             7      LD  A,081H
       DC93                     CURSOR0:
000E9A DC93 D351            11      OUT (051H),A
000E9C DC95 3A8EEF          13      LD  A,(_TXADR)
000E9F DC98 D350            11      OUT (050H),A
000EA1 DC9A 3A8FEF          13      LD  A,(_TXADR+1)
000EA4 DC9D D350            11      OUT (050H),A
000EA6 DC9F F1              10      POP AF
000EA7 DCA0 C9              10      RET
       DCA1                     CURSOR_OFF:
000EA8 DCA1 F5              11      PUSH    AF
000EA9 DCA2 3E80             7      LD  A,080H
000EAB DCA4 18ED            12      JR  CURSOR0
                                
       DCA6                     CTRL07:
000EAD DCA6 3AB9EF          13      LD  A,(WK40)
000EB0 DCA9 F5              11      PUSH    AF
000EB1 DCAA F620             7      OR  20H
000EB3 DCAC D340            11      OUT (040H),A
000EB5 DCAE 0610             7      LD  B,16
       DCB0                     C07X1:
000EB7 DCB0 CD23DE          17      CALL    VBLANK
000EBA DCB3 10FB            13      DJNZ    C07X1
000EBC DCB5 F1              10      POP AF
000EBD DCB6 D340            11      OUT (040H),A
000EBF DCB8 C9              10      RET
                                
       DCB9                     INSERT:
000EC0 DCB9 2A8EEF          16      LD  HL,(_TXADR)
000EC3 DCBC 3AB1EF          13      LD  A,(_WIDTH)
000EC6 DCBF 95               4      SUB L
000EC7 DCC0 47               4      LD  B,A
                                
000EC8 DCC1 CD63DC          17      CALL    LOC0
                                
000ECB DCC4 DB32            11      IN  A,(032H)
000ECD DCC6 F5              11      PUSH    AF
000ECE DCC7 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000ED0 DCC9 D332            11      OUT (032H),A
                                
000ED2 DCCB 3E20             7      LD  A,020H
       DCCD                     INS1:
000ED4 DCCD 4E               7      LD  C,(HL)
000ED5 DCCE 77               7      LD  (HL),A
000ED6 DCCF 79               4      LD  A,C
000ED7 DCD0 23               6      INC HL
000ED8 DCD1 10FA            13      DJNZ    INS1
                                
000EDA DCD3 F1              10      POP AF
000EDB DCD4 D332            11      OUT (032H),A
000EDD DCD6 C9              10      RET
                                
       DCD7                     CTRL0C:
000EDE DCD7 CD56DC          17      CALL    CTRL0B
       DCDA                     CTRL06:
000EE1 DCDA 2A8EEF          16      LD  HL,(_TXADR)
       DCDD                     CLS1:
000EE4 DCDD DB32            11      IN  A,(032H)
000EE6 DCDF F5              11      PUSH    AF
000EE7 DCE0 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000EE9 DCE2 D332            11      OUT (032H),A
       DCE4                     CLS2:
000EEB DCE4 E5              11      PUSH    HL
000EEC DCE5 3AB1EF          13      LD  A,(_WIDTH)
000EEF DCE8 95               4      SUB L
000EF0 DCE9 47               4      LD  B,A
000EF1 DCEA CD66DC          17      CALL    LOC1
000EF4 DCED 3E20             7      LD  A,020H
       DCEF                     CLS3:
000EF6 DCEF 77               7      LD  (HL),A
000EF7 DCF0 23               6      INC HL
000EF8 DCF1 10FC            13      DJNZ    CLS3
000EFA DCF3 E1              10      POP HL
000EFB DCF4 2E00             7      LD  L,0
000EFD DCF6 24               4      INC H
000EFE DCF7 3A97EF          13      LD  A,(_LINE)
000F01 DCFA BC               4      CP  H
000F02 DCFB 20E7            12      JR  NZ,CLS2
000F04 DCFD F1              10      POP AF
000F05 DCFE D332            11      OUT (032H),A
000F07 DD00 C9              10      RET
                                
       DD01                     CTRL04:
000F08 DD01 CDD3EF          17      CALL    _POS
000F0B DD04 7D               4      LD  A,L
000F0C DD05 B7               4      OR  A
000F0D DD06 C8              11      RET Z
       DD07                     CTRL03:
000F0E DD07 CD49DC          17      CALL    CTRL0D
       DD0A                     CTRL0A:
       DD0A                     CTRL1F:
000F11 DD0A 2A8EEF          16      LD  HL,(_TXADR)
000F14 DD0D 24               4      INC H
000F15 DD0E C3BFDB          10      JP  PRINTE8
                                
       DD11                     CTRL0E:
000F18 DD11 CDD3EF          17      CALL    _POS
000F1B DD14 7C               4      LD  A,H
000F1C DD15 1804            12      JR  SCR1
       DD17                     SCR:
000F1E DD17 3A97EF          13      LD  A,(_LINE)
000F21 DD1A 3D               4      DEC A
       DD1B                     SCR1:
000F22 DD1B C5              11      PUSH    BC
000F23 DD1C D5              11      PUSH    DE
000F24 DD1D E5              11      PUSH    HL
000F25 DD1E F5              11      PUSH    AF
000F26 DD1F 210000          10      LD  HL,0
000F29 DD22 CD66DC          17      CALL    LOC1
000F2C DD25 EB               4      EX  DE,HL
000F2D DD26 210001          10      LD  HL,0100H
000F30 DD29 CD66DC          17      CALL    LOC1
000F33 DD2C C1              10      POP BC
000F34 DD2D DB32            11      IN  A,(032H)
000F36 DD2F F5              11      PUSH    AF
000F37 DD30 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000F39 DD32 D332            11      OUT (032H),A
000F3B DD34 78               4      LD  A,B
000F3C DD35 B7               4      OR  A
       DD36                     SCRUP1:
000F3D DD36 2815            12      JR  Z,SCRCL
000F3F DD38 E5              11      PUSH    HL
000F40 DD39 D5              11      PUSH    DE
000F41 DD3A 0608             7      LD  B,8
000F43 DD3C 5F               4      LD  E,A
000F44 DD3D 210078          10      LD  HL,120*256
000F47 DD40 55               4      LD  D,L
       DD41                     SCRH2:
000F48 DD41 29              11      ADD HL,HL
000F49 DD42 3001            12      JR  NC,SCRH3
000F4B DD44 19              11      ADD HL,DE
       DD45                     SCRH3:
000F4C DD45 10FA            13      DJNZ    SCRH2
000F4E DD47 4D               4      LD  C,L
000F4F DD48 44               4      LD  B,H
000F50 DD49 D1              10      POP DE
000F51 DD4A E1              10      POP HL
000F52 DD4B EDB0                    LDIR
                                
       DD4D                     SCRCL:
000F54 DD4D F1              10      POP AF
000F55 DD4E D332            11      OUT (032H),A
                                
000F57 DD50 3AB1EF          13      LD  A,(_WIDTH)
000F5A DD53 47               4      LD  B,A
000F5B DD54 EB               4      EX  DE,HL
000F5C DD55 CD38DC          17      CALL    CLLINE
000F5F DD58 E1              10      POP HL
000F60 DD59 D1              10      POP DE
000F61 DD5A C1              10      POP BC
000F62 DD5B C9              10      RET
       DD5C                     POS:
000F63 DD5C 2A8EEF          16      LD  HL,(_TXADR)
000F66 DD5F C9              10      RET
                                
       DD60                     GETL:
000F67 DD60 CDD3EF          17      CALL    _POS
000F6A DD63 E5              11      PUSH    HL
000F6B DD64 3ECD             7      LD  A,0CDH      ;CALL ????
000F6D DD66 3289DB          13      LD  (INSFLG),A
       DD69                     GETL1:
000F70 DD69 CDEBD9          17      CALL    _SYS08
000F73 DD6C FE09             7      CP  9
000F75 DD6E 2008            12      JR  NZ,GETL1V
000F77 DD70 2120FF          10      LD  HL,KBUF
000F7A DD73 CDE1D6          17      CALL    MSX
000F7D DD76 18F1            12      JR  GETL1
       DD78                     GETL1V:
000F7F DD78 5F               4      LD  E,A
000F80 DD79 CDCDEF          17      CALL    _PRINT
                                
000F83 DD7C 7B               4      LD  A,E
000F84 DD7D FE0D             7      CP  00DH
000F86 DD7F 20E8            12      JR  NZ,GETL1
000F88 DD81 3E01             7      LD  A,1     ;LD BC,????
000F8A DD83 3289DB          13      LD  (INSFLG),A
000F8D DD86 1120FF          10      LD  DE,KBUF
000F90 DD89 3AB1EF          13      LD  A,(_WIDTH)
000F93 DD8C 47               4      LD  B,A
000F94 DD8D CD40D5          17      CALL    ZERO_MEMORY_DE
                                
000F97 DD90 D1              10      POP DE
000F98 DD91 CDD3EF          17      CALL    _POS
000F9B DD94 6B               4      LD  L,E
000F9C DD95 3AB1EF          13      LD  A,(_WIDTH)
000F9F DD98 95               4      SUB L
000FA0 DD99 57               4      LD  D,A
000FA1 DD9A CD66DC          17      CALL    LOC1
000FA4 DD9D 4D               4      LD  C,L
000FA5 DD9E 7C               4      LD  A,H
000FA6 DD9F F630             7      OR  030H
000FA8 DDA1 47               4      LD  B,A
000FA9 DDA2 5A               4      LD  E,D
000FAA DDA3 2120FF          10      LD  HL,KBUF
       DDA6                     GETL2:
000FAD DDA6 CDD0EF          17      CALL    _SCRN
000FB0 DDA9 03               6      INC BC
000FB1 DDAA 77               7      LD  (HL),A
000FB2 DDAB 23               6      INC HL
000FB3 DDAC 1D               4      DEC E
000FB4 DDAD 20F7            12      JR  NZ,GETL2
       DDAF                     GETL3:
000FB6 DDAF 2B               6      DEC HL
000FB7 DDB0 7E               7      LD  A,(HL)
000FB8 DDB1 FE21             7      CP  021H
000FBA DDB3 D0              11      RET NC
000FBB DDB4 3600            10      LD  (HL),0
000FBD DDB6 15               4      DEC D
000FBE DDB7 20F6            12      JR  NZ,GETL3
000FC0 DDB9 C9              10      RET
                                
       DDBA                     INKEY:
000FC1 DDBA FB               4      EI
000FC2 DDBB E5              11      PUSH    HL
000FC3 DDBC 2A90EF          16      LD  HL,(_KEYPS)
000FC6 DDBF 7C               4      LD  A,H
000FC7 DDC0 AD               4      XOR L
000FC8 DDC1 280C            12      JR  Z,INKEY1
000FCA DDC3 7C               4      LD  A,H
000FCB DDC4 3C               4      INC A
000FCC DDC5 E61F             7      AND 01FH
000FCE DDC7 3291EF          13      LD  (_KEYPS+1),A
000FD1 DDCA 6F               4      LD  L,A
000FD2 DDCB 26FF             7      LD  H,KEYBF/256
000FD4 DDCD 7E               7      LD  A,(HL)
000FD5 DDCE B7               4      OR  A
       DDCF                     INKEY1:
000FD6 DDCF E1              10      POP HL
000FD7 DDD0 C9              10      RET
                                
       DDD1                     CHKEY:
000FD8 DDD1 C5              11      PUSH    BC
000FD9 DDD2 DB08            11      IN  A,(8)       ;6:SHIFT,7:CTRL
000FDB DDD4 4F               4      LD  C,A
000FDC DDD5 3A0E00          13      LD  A,(00EH)
000FDF DDD8 CB5F             8      BIT 3,A
000FE1 DDDA 2002            12      JR  NZ,CHKEYRSHIFT
000FE3 DDDC CBB1             8      RES 6,C
       DDDE                     CHKEYRSHIFT:
000FE5 DDDE 79               4      LD  A,C
000FE6 DDDF 3293EF          13      LD  (_KEYD+1),A
000FE9 DDE2 E5              11      PUSH    HL
000FEA DDE3 0E00             7      LD  C,0
000FEC DDE5 2198F1          10      LD  HL,KEY_TABLE
000FEF DDE8 CB77             8      BIT 6,A
000FF1 DDEA 2003            12      JR  NZ,CHKEY0
000FF3 DDEC 212EEE          10      LD  HL,SHIFT_TABLE
       DDEF                     CHKEY0:
000FF6 DDEF CB7F             8      BIT 7,A
000FF8 DDF1 2003            12      JR  NZ,CHKEY1
000FFA DDF3 2196EE          10      LD  HL,CTRL_TABLE
       DDF6                     CHKEY1:
000FFD DDF6 ED78            12      IN  A,(C)
000FFF DDF8 0608             7      LD  B,8
       DDFA                     CHKEY2:
001001 DDFA 0F               4      RRCA
001002 DDFB 300B            12      JR  NC,CHKEY4
       DDFD                     CHKEY3:
001004 DDFD 23               6      INC HL
001005 DDFE 10FA            13      DJNZ    CHKEY2
001007 DE00 0C               4      INC C
001008 DE01 79               4      LD  A,C
001009 DE02 D60D             7      SUB 00DH
00100B DE04 20F0            12      JR  NZ,CHKEY1
00100D DE06 1804            12      JR  CHKEY5
       DE08                     CHKEY4:
00100F DE08 7E               7      LD  A,(HL)
001010 DE09 B7               4      OR  A
001011 DE0A 28F1            12      JR  Z,CHKEY3
       DE0C                     CHKEY5:
001013 DE0C E1              10      POP HL
001014 DE0D C1              10      POP BC
001015 DE0E B7               4      OR  A
001016 DE0F 3292EF          13      LD  (_KEYD),A
001019 DE12 C9              10      RET
                                
       DE13                     SCRN:
00101A DE13 E5              11      PUSH    HL
00101B DE14 DB32            11      IN  A,(032H)
00101D DE16 67               4      LD  H,A
00101E DE17 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
001020 DE19 D332            11      OUT (032H),A
001022 DE1B 0A               7      LD  A,(BC)
001023 DE1C 6F               4      LD  L,A
001024 DE1D 7C               4      LD  A,H
001025 DE1E D332            11      OUT (032H),A
001027 DE20 7D               4      LD  A,L
001028 DE21 E1              10      POP HL
001029 DE22 C9              10      RET
                                
       DE23                     VBLANK:
00102A DE23 F5              11      PUSH    AF
       DE24                     VBLANK0:
00102B DE24 DB40            11      IN  A,(040H)
00102D DE26 E620             7      AND 020H
00102F DE28 20FA            12      JR  NZ,VBLANK0
       DE2A                     VBLANK1:
001031 DE2A DB40            11      IN  A,(040H)
001033 DE2C E620             7      AND 020H
001035 DE2E 28FA            12      JR  Z,VBLANK1
001037 DE30 F1              10      POP AF
001038 DE31 C9              10      RET
                                
       DE32                     INIT_CRTC:
001039 DE32 3E03             7      LD  A,3     ;80桁
00103B DE34 D330            11      OUT (030H),A
00103D DE36 32BEEF          13      LD  (WK30),A
                                
001040 DE39 3E22             7      LD  A,022H      ;25行 64K RAM
001042 DE3B D331            11      OUT (031H),A
001044 DE3D 32BFEF          13      LD  (WK31),A
                                
001047 DE40 3EFF             7      LD  A,0FFH
001049 DE42 D3E4            11      OUT (0E4H),A    ;割り込みレベル設定
00104B DE44 32B7EF          13      LD  (WKE4),A
00104E DE47 3E00             7      LD  A,0
001050 DE49 D3E6            11      OUT (0E6H),A    ;割り込みマスク
                                
001052 DE4B 3E19             7      LD  A,019H
001054 DE4D D340            11      OUT (040H),A    ;CRT I/F 同期ビットオン
001056 DE4F 32B9EF          13      LD  (WK40),A
001059 DE52 CD23DE          17      CALL    VBLANK
                                
00105C DE55 AF               4      XOR A
00105D DE56 D351            11      OUT (051H),A    ;Reset CRTC
00105F DE58 3EA0             7      LD  A,0A0H
001061 DE5A D368            11      OUT (068H),A    ;DMAC: Mode Set(Reset)
001063 DE5C 21C8F3          10      LD  HL,0F3C8H
001066 DE5F 22B2EF          16      LD  (TVRAMTOP),HL
001069 DE62 0E64             7      LD  C,064H
00106B DE64 ED69            12      OUT (C),L       ;TVRAM LOW
00106D DE66 ED61            12      OUT (C),H       ;TVRAM HIGH
00106F DE68 21B78B          10      LD  HL,08000H+120*25-1
001072 DE6B 0C               4      INC C       ;65H
001073 DE6C ED69            12      OUT (C),L
001075 DE6E ED61            12      OUT (C),H
001077 DE70 3ECE             7      LD  A,080H+80-2
001079 DE72 D350            11      OUT (050H),A
00107B DE74 3E98             7      LD  A,080H+25-1
00107D DE76 D350            11      OUT (050H),A
00107F DE78 DB40            11      IN  A,(040H)
001081 DE7A CB4F             8      BIT 1,A
001083 DE7C 21DE67          10      LD  HL,067DEH
001086 DE7F 2003            12      JR  NZ,RESO1
001088 DE81 21586F          10      LD  HL,06F58H
       DE84                     RESO1:
00108B DE84 0E50             7      LD  C,050H
00108D DE86 ED61            12      OUT (C),H
00108F DE88 ED69            12      OUT (C),L
                                
001091 DE8A 3E53             7      LD  A,053H
001093 DE8C D350            11      OUT (050H),A
                                
001095 DE8E 3E43             7      LD  A,043H
001097 DE90 D351            11      OUT (051H),A
                                
001099 DE92 3EE4             7      LD  A,0E4H
00109B DE94 D368            11      OUT (068H),A
                                
00109D DE96 3E20             7      LD  A,020H
00109F DE98 D351            11      OUT (051H),A
                                
0010A1 DE9A CD23DE          17      CALL    VBLANK
       DE9D                     IVBL1:
0010A4 DE9D DB40            11      IN  A,(040H)
0010A6 DE9F CB6F             8      BIT 5,A
0010A8 DEA1 20FA            12      JR  NZ,IVBL1
                                
0010AA DEA3 3E11             7      LD  A,011H
0010AC DEA5 D340            11      OUT (040H),A    ;CRT I/F 同期ビットオフ
0010AE DEA7 32B9EF          13      LD  (WK40),A
0010B1 DEAA C9              10      RET
[EOF:88IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
       DEAB                     FILEC:
0010B2 DEAB CDB6DE          17      CALL    FILE
       DEAE                     FILEC2:
0010B5 DEAE 3A15EF          13      LD  A,(FDRV+1)
0010B8 DEB1 FE20             7      CP  020H
0010BA DEB3 C8              11      RET Z
0010BB DEB4 1839            12      JR  SETDIR1
                                
       DEB6                     FILE:
0010BD DEB6 AF               4      XOR A
0010BE DEB7 3214EF          13      LD  (FDRV),A
0010C1 DEBA 67               4      LD  H,A
0010C2 DEBB 6F               4      LD  L,A
0010C3 DEBC 2222EF          16      LD  (FDRV+14),HL
0010C6 DEBF CD8DDF          17      CALL    SPCUT
0010C9 DEC2 CD72DF          17      CALL    CCHK3
0010CC DEC5 2812            12      JR  Z,DEVI1
0010CE DEC7 13               6      INC DE
0010CF DEC8 1A               7      LD  A,(DE)
0010D0 DEC9 1B               6      DEC DE
0010D1 DECA FE3A             7      CP  ':'
0010D3 DECC 200B            12      JR  NZ,DEVI1
0010D5 DECE 1A               7      LD  A,(DE)      ;DRIVE
0010D6 DECF CDCDE1          17      CALL    CAP
0010D9 DED2 D640             7      SUB '@'
0010DB DED4 13               6      INC DE
0010DC DED5 13               6      INC DE
0010DD DED6 3214EF          13      LD  (FDRV),A
       DED9                     DEVI1:
0010E0 DED9 1A               7      LD  A,(DE)
0010E1 DEDA D65C             7      SUB 05CH        ;\
0010E3 DEDC 2009            12      JR  NZ,NOROOT
0010E5 DEDE 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
0010E6 DEDF 222EEF          16      LD  (FDRV+26),HL
0010E9 DEE2 2C               4      INC L
0010EA DEE3 2222EF          16      LD  (FDRV+14),HL
0010ED DEE6 13               6      INC DE
       DEE7                     NOROOT:
                                
       DEE7                     SETDIR:
0010EE DEE7 CD13DF          17      CALL    FILED
0010F1 DEEA 1A               7      LD  A,(DE)
0010F2 DEEB FE5C             7      CP  05CH        ;\
0010F4 DEED C0              11      RET NZ
0010F5 DEEE 13               6      INC DE
       DEEF                     SETDIR1:
0010F6 DEEF 3E10             7      LD  A,010H      ;Directory
0010F8 DEF1 3221EF          13      LD  (FDRV+13),A
0010FB DEF4 D5              11      PUSH    DE
0010FC DEF5 1114EF          10      LD  DE,FDRV
0010FF DEF8 2A1EF0          16      LD  HL,(STABLE+2*00FH)
001102 DEFB CD0F00          17      CALL    JP_HL
001105 DEFE D1              10      POP DE
001106 DEFF B7               4      OR  A
001107 DF00 C0              11      RET NZ
                                
001108 DF01 3A21EF          13      LD  A,(FDRV+13)
00110B DF04 CB67             8      BIT 4,A
00110D DF06 C8              11      RET Z
                                
00110E DF07 CD5ADF          17      CALL    FILEI
001111 DF0A 2A2EEF          16      LD  HL,(FDRV+26)
001114 DF0D 23               6      INC HL
001115 DF0E 2222EF          16      LD  (FDRV+14),HL
001118 DF11 18D4            12      JR  SETDIR
                                
       DF13                     FILED:
00111A DF13 CD5ADF          17      CALL    FILEI
00111D DF16 2115EF          10      LD  HL,FNAME
                                
001120 DF19 0608             7      LD  B,8
       DF1B                     FILE2:
001122 DF1B CD67DF          17      CALL    CCHKF
001125 DF1E C8              11      RET Z
001126 DF1F FE2A             7      CP  '*'
001128 DF21 282E            12      JR  Z,FILE9
00112A DF23 FE2E             7      CP  '.'
00112C DF25 280C            12      JR  Z,FILE4
00112E DF27 77               7      LD  (HL),A
00112F DF28 23               6      INC HL
001130 DF29 10F0            13      DJNZ    FILE2
                                
       DF2B                     FILE3:
001132 DF2B CD67DF          17      CALL    CCHKF
001135 DF2E C8              11      RET Z
001136 DF2F FE2E             7      CP  '.'
001138 DF31 20F8            12      JR  NZ,FILE3
                                
       DF33                     FILE4:
00113A DF33 211DEF          10      LD  HL,FNAME+8
00113D DF36 0603             7      LD  B,3
                                
       DF38                     FILE4L:
00113F DF38 CD67DF          17      CALL    CCHKF
001142 DF3B C8              11      RET Z
001143 DF3C FE2E             7      CP  '.'
001145 DF3E 2008            12      JR  NZ,FILE12
001147 DF40 3215EF          13      LD  (FNAME),A   ;Parent directory(..)
00114A DF43 3216EF          13      LD  (FNAME+1),A
00114D DF46 3E20             7      LD  A,020H
       DF48                     FILE12:
00114F DF48 FE2A             7      CP  '*'
001151 DF4A 280A            12      JR  Z,FILE10
001153 DF4C 77               7      LD  (HL),A
001154 DF4D 23               6      INC HL
001155 DF4E 10E8            13      DJNZ    FILE4L
001157 DF50 C9              10      RET
                                
       DF51                     FILE9:              ;名前の*処理、名前の残りを?で埋める
001158 DF51 CD56DF          17      CALL    FILE10
00115B DF54 18D5            12      JR  FILE3
                                
       DF56                     FILE10:
00115D DF56 3E3F             7      LD  A,'?'
00115F DF58 1808            12      JR  FILL_MEMORY
       DF5A                     FILEI:              ;名前＋拡張子をスペースで初期化
001161 DF5A 3E20             7      LD  A,020H
001163 DF5C 01000B          10      LD  BC,11*256   ;C=0にしておく
001166 DF5F 2115EF          10      LD  HL,FNAME
       DF62                     FILL_MEMORY:            ;HLからBバイトAで埋める
001169 DF62 77               7      LD  (HL),A
00116A DF63 23               6      INC HL
00116B DF64 10FC            13      DJNZ    FILL_MEMORY
00116D DF66 C9              10      RET
                                
       DF67                     CCHKF:
00116E DF67 1A               7      LD  A,(DE)
00116F DF68 CD6FDF          17      CALL    CCHK2
001172 DF6B C8              11      RET Z
001173 DF6C C3DAE2          10      JP  FKAN
                                
       DF6F                     CCHK2:
001176 DF6F 0C               4      INC C
001177 DF70 0D               4      DEC C
001178 DF71 C0              11      RET NZ
       DF72                     CCHK3:              ;ZF=1 で使えない文字
001179 DF72 FE2B             7      CP  '+'
00117B DF74 C8              11      RET Z
00117C DF75 FE2C             7      CP  ','
00117E DF77 C8              11      RET Z
00117F DF78 FE2F             7      CP  '/'
001181 DF7A C8              11      RET Z
001182 DF7B FE3A             7      CP  ':'
001184 DF7D C8              11      RET Z
001185 DF7E FE3B             7      CP  ';'
001187 DF80 C8              11      RET Z
001188 DF81 FE3D             7      CP  '='
00118A DF83 C8              11      RET Z
00118B DF84 FE5C             7      CP  05CH    ;\
00118D DF86 C8              11      RET Z
00118E DF87 FE20             7      CP  020H
001190 DF89 D0              11      RET NC
001191 DF8A BF               4      CP  A       ;Z=1
001192 DF8B C9              10      RET
                                
       DF8C                     SS1:
001193 DF8C 13               6      INC DE
       DF8D                     SPCUT:              ;スペースをカット
001194 DF8D 1A               7      LD  A,(DE)
001195 DF8E FE20             7      CP  020H
001197 DF90 28FA            12      JR  Z,SS1
001199 DF92 C9              10      RET
                                
       DF93                     SETDRVF:
00119A DF93 1114EF          10      LD  DE,FDRV
       DF96                     SETDRV0:
00119D DF96 CD9FDF          17      CALL    SETDRV
0011A0 DF99 FDE1            14      POP IY
0011A2 DF9B C1              10      POP BC
0011A3 DF9C D1              10      POP DE
0011A4 DF9D E1              10      POP HL
0011A5 DF9E C9              10      RET
                                
       DF9F                     SETDRV:
0011A6 DF9F E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
0011A7 DFA0 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
0011A8 DFA1 C5              11      PUSH    BC
0011A9 DFA2 1A               7      LD  A,(DE)
0011AA DFA3 D5              11      PUSH    DE
0011AB DFA4 FDE3            23      EX  (SP),IY
                                
0011AD DFA6 CDADDF          17      CALL    GETDRV
0011B0 DFA9 CDD9EF          17      CALL    _CHGDRV
                                
0011B3 DFAC E9               4      JP  (HL)
                                
       DFAD                     GETDRV:
0011B4 DFAD CDC0DF          17      CALL    GETDRV1
0011B7 DFB0 3288EF          13      LD  (_DRV),A
0011BA DFB3 C9              10      RET
                                
       DFB4                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
0011BB DFB4 CDC0DF          17      CALL    GETDRV1
0011BE DFB7 C5              11      PUSH    BC
0011BF DFB8 4F               4      LD  C,A
0011C0 DFB9 1A               7      LD  A,(DE)
0011C1 DFBA CDC0DF          17      CALL    GETDRV1
0011C4 DFBD A9               4      XOR C
0011C5 DFBE C1              10      POP BC
0011C6 DFBF C9              10      RET
       DFC0                     GETDRV1:
0011C7 DFC0 E67F             7      AND 07FH
0011C9 DFC2 D601             7      SUB 001H
0011CB DFC4 D0              11      RET NC
0011CC DFC5 3A87EF          13      LD  A,(_DVSW)   ;Current Drive
0011CF DFC8 C9              10      RET
                                
       DFC9                     SOPENX:
0011D0 DFC9 1139EF          10      LD  DE,SFILE
0011D3 DFCC FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
0011D6 DFCF CDB4DF          17      CALL    IS_SAME_DRV_A_DE
0011D9 DFD2 2024            12      JR  NZ,SOPEN
0011DB DFD4 13               6      INC DE
0011DC DFD5 FDE5            15      PUSH    IY
0011DE DFD7 E1              10      POP HL
0011DF DFD8 23               6      INC HL
0011E0 DFD9 CD65E1          17      CALL    CPFILE
0011E3 DFDC 201A            12      JR  NZ,SOPEN
                                
0011E5 DFDE 2AF4F0          16      LD  HL,(SCDIR)
0011E8 DFE1 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011EB DFE4 FD740F          19      LD  (IY+15),H
                                
0011EE DFE7 2AF8F0          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
0011F1 DFEA 229FEF          16      LD  (_FILEN),HL
                                
0011F4 DFED ED5BF6F0        20      LD  DE,(SFBPS)
0011F8 DFF1 2139EF          10      LD  HL,SFILE
0011FB DFF4 36FF            10      LD  (HL),0FFH
0011FD DFF6 23               6      INC HL
0011FE DFF7 C9              10      RET
       DFF8                     SOPEN:
0011FF DFF8 210DE1          10      LD  HL,FILESE
       DFFB                     SOPENC:
001202 DFFB 2234E0          16      LD  (OPENPAT),HL
                                
001205 DFFE CDE2EF          17      CALL    _RDFATX     ;Detect Media
001208 E001 3856            12      JR  C,RDDERR
                                
00120A E003 AF               4      XOR A
00120B E004 329FEF          13      LD  (_FILEN),A
00120E E007 CD0DE2          17      CALL    LDDIRX1     ;A=0で呼び出す
001211 E00A 2818            12      JR  Z,SDIRX1
                                
001213 E00C CDFEE0          17      CALL    READ_DIR    ;Sub Directory
001216 E00F 3808            12      JR  C,SDIRX0
001218 E011 2A7EF0          16      LD  HL,(_DTBUF)
00121B E014 7E               7      LD  A,(HL)
00121C E015 FE2E             7      CP  '.'
00121E E017 280F            12      JR  Z,SOPEN1
       E019                     SDIRX0:
001220 E019 AF               4      XOR A
001221 E01A 32A0EF          13      LD  (_DIRF),A
001224 E01D FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
001228 E021 FD770F          19      LD  (IY+15),A
       E024                     SDIRX1:
00122B E024 ED5BFCF0        20      LD  DE,(_DIRPS) ;Root Directory
       E028                     SOPEN1:
00122F E028 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       E029                     SDECPAT EQU $-1
       E02A                     SOPEN1X:
001231 E02A CDFEE0          17      CALL    READ_DIR    ;FILE SEARCH
001234 E02D 382A            12      JR  C,RDDERR
001236 E02F 2A7EF0          16      LD  HL,(_DTBUF)
       E032                     SOPEN2:
001239 E032 D5              11      PUSH    DE
00123A E033 CD0DE1          17      CALL    FILESE      ;(self-modifying code)
       E034                     OPENPAT EQU $-2
00123D E036 D1              10      POP DE
00123E E037 386D            12      JR  C,SOPENE
001240 E039 281B            12      JR  Z,SCF_FF_RET
       E03B                     SOPEN3:
001242 E03B 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
001245 E03E B7               4      OR  A
001246 E03F 200C            12      JR  NZ,SOPEN5
001248 E041 13               6      INC DE      ;ルートディレクトリ
001249 E042 E5              11      PUSH    HL
00124A E043 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       E044                     MD_PAT  EQU $-2
00124D E046 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
00124F E048 E1              10      POP HL
001250 E049 20DD            12      JR  NZ,SOPEN1
001252 E04B 1807            12      JR  SOPEN6
       E04D                     SOPEN5:
001254 E04D CD1CE9          17      CALL    GNCLX       ;END DIR
001257 E050 D8              11      RET C
001258 E051 CDC5E1          17      CALL    ENDCL
       E054                     SOPEN6:
00125B E054 38D2            12      JR  C,SOPEN1
       E056                     SCF_FF_RET:
00125D E056 37               4      SCF         ;CF=1
00125E E057 9F               4      SBC A,A     ;A=0FFH
00125F E058 C9              10      RET
                                
       E059                     RDDERR:
001260 E059 BF               4      CP  A       ;READ ERR CF=1 ZF=1
001261 E05A 37               4      SCF
001262 E05B C9              10      RET
                                
       E05C                     NOPEN:
001263 E05C 210DE1          10      LD  HL,FILESE
001266 E05F 2234E0          16      LD  (OPENPAT),HL
001269 E062 FD2A98EF        20      LD  IY,(_FCB)
00126D E066 CDEDE2          17      CALL    CHKWILDX
001270 E069 30EB            12      JR  NC,SCF_FF_RET
001272 E06B FD7E00          19      LD  A,(IY+0)
001275 E06E CDADDF          17      CALL    GETDRV
001278 E071 CDD9EF          17      CALL    _CHGDRV
00127B E074 D8              11      RET C
00127C E075 2AF8F0          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
00127F E078 229FEF          16      LD  (_FILEN),HL
                                
001282 E07B CD08E2          17      CALL    LDDIRX
001285 E07E ED5B9AEF        20      LD  DE,(_FBPS)
001289 E082 CDFEE0          17      CALL    READ_DIR
00128C E085 38D2            12      JR  C,RDDERR
00128E E087 3A9EEF          13      LD  A,(_FBCNT)
001291 E08A 3D               4      DEC A
001292 E08B 28AE            12      JR  Z,SOPEN3
       E08D                     NOPEN2:
001294 E08D 2A9CEF          16      LD  HL,(_FBAD)
001297 E090 012000          10      LD  BC,020H
00129A E093 09              11      ADD HL,BC
00129B E094 4F               4      LD  C,A
00129C E095 189B            12      JR  SOPEN2
                                
       E097                     SOPENE2:
00129E E097 229CEF          16      LD  (_FBAD),HL
0012A1 E09A 79               4      LD  A,C
0012A2 E09B 329EEF          13      LD  (_FBCNT),A
0012A5 E09E ED539AEF        20      LD  (_FBPS),DE
0012A9 E0A2 FD2298EF        20      LD  (_FCB),IY
       E0A6                     SOPENE:
0012AD E0A6 AF               4      XOR A
0012AE E0A7 C9              10      RET
                                
       E0A8                     COPEN:
0012AF E0A8 FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
0012B3 E0AC 212AE1          10      LD  HL,NEXTSE
0012B6 E0AF CDFBDF          17      CALL    SOPENC
0012B9 E0B2 D0              11      RET NC
0012BA E0B3 C8              11      RET Z
0012BB E0B4 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
0012BE E0B7 B7               4      OR  A
0012BF E0B8 37               4      SCF
0012C0 E0B9 C8              11      RET Z       ;ルートディレクトリ
0012C1 E0BA 0601             7      LD  B,1
0012C3 E0BC CD4CE3          17      CALL    WRDF
0012C6 E0BF D8              11      RET C
0012C7 E0C0 ED5BFEF0        20      LD  DE,(_CLPS)
0012CB E0C4 D5              11      PUSH    DE
0012CC E0C5 CD8EE1          17      CALL    DCPAT
0012CF E0C8 CDA7E7          17      CALL    DRDNX
0012D2 E0CB 2A7EF0          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
0012D5 E0CE 3AB1E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
0012D8 E0D1 47               4      LD  B,A
0012D9 E0D2 AF               4      XOR A
0012DA E0D3 4F               4      LD  C,A
       E0D4                     COPENCL:
0012DB E0D4 77               7      LD  (HL),A
0012DC E0D5 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0012DE E0D7 EAD4E0          10      JP  PE,COPENCL
                                
0012E1 E0DA 3AACE1          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
0012E4 E0DD 3D               4      DEC A
0012E5 E0DE 2819            12      JR  Z,COPENE
0012E7 E0E0 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
0012E9 E0E2 3214E9          13      LD  (_SECPS),A
0012EC E0E5 D1              10      POP DE      ;DE=(_CLPS)
0012ED E0E6 D5              11      PUSH    DE
       E0E7                     COPEN1:
0012EE E0E7 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
0012EF E0E8 C5              11      PUSH    BC
0012F0 E0E9 2A7EF0          16      LD  HL,(_DTBUF)
0012F3 E0EC CDA8E1          17      CALL    CLUSTX
0012F6 E0EF CDACEA          17      CALL    DWT24
0012F9 E0F2 C1              10      POP BC
0012FA E0F3 D1              10      POP DE
0012FB E0F4 CD13E9          17      CALL    NEXTX
0012FE E0F7 20EE            12      JR  NZ,COPEN1
       E0F9                     COPENE:
001300 E0F9 2A7EF0          16      LD  HL,(_DTBUF)
001303 E0FC D1              10      POP DE
001304 E0FD C9              10      RET
                                
       E0FE                     READ_DIR:
001305 E0FE ED53FEF0        20      LD  (_CLPS),DE
001309 E102 C5              11      PUSH    BC
00130A E103 D5              11      PUSH    DE
00130B E104 CD8EE1          17      CALL    DCPAT
00130E E107 CD87E7          17      CALL    DRDX
001311 E10A D1              10      POP DE
001312 E10B C1              10      POP BC
001313 E10C C9              10      RET
                                
       E10D                     FILESE:
001314 E10D 7E               7      LD  A,(HL)
001315 E10E B7               4      OR  A
001316 E10F C8              11      RET Z       ;END:ZF=1 CF=0
001317 E110 FEE5             7      CP  0E5H
001319 E112 280E            12      JR  Z,FILESE1
00131B E114 FDE5            15      PUSH    IY
00131D E116 D1              10      POP DE
00131E E117 13               6      INC DE
00131F E118 E5              11      PUSH    HL
001320 E119 CD65E1          17      CALL    CPFILE
001323 E11C CC86E1          17      CALL    Z,CPFILE2
001326 E11F E1              10      POP HL
001327 E120 37               4      SCF
001328 E121 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       E122                     FILESE1:
001329 E122 CD39E1          17      CALL    FNEXT
00132C E125 20E6            12      JR  NZ,FILESE
       E127                     ZF0_CF0_AFF_RET:
00132E E127 F6FF             7      OR  0FFH        ;ZF=0 CF=0
001330 E129 C9              10      RET
                                
       E12A                     NEXTSE:
001331 E12A 7E               7      LD  A,(HL)
001332 E12B B7               4      OR  A
001333 E12C 37               4      SCF
001334 E12D C8              11      RET Z       ;!!!:ZF=1 CF=1
001335 E12E FEE5             7      CP  0E5H
001337 E130 37               4      SCF
001338 E131 C8              11      RET Z       ;!!!:(ZF=1) CF=1
001339 E132 CD39E1          17      CALL    FNEXT
00133C E135 20F3            12      JR  NZ,NEXTSE
00133E E137 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       E139                     FNEXT:
001340 E139 E5              11      PUSH    HL
001341 E13A 219FEF          10      LD  HL,_FILEN
001344 E13D 34              11      INC (HL)
001345 E13E E1              10      POP HL
001346 E13F 112000          10      LD  DE,020H
001349 E142 19              11      ADD HL,DE
00134A E143 0D               4      DEC C
00134B E144 C9              10      RET
                                
       E145                     CPNAME:
00134C E145 C5              11      PUSH    BC
00134D E146 D5              11      PUSH    DE
00134E E147 E5              11      PUSH    HL
00134F E148 CD5FE1          17      CALL    CPFILE4
001352 E14B E1              10      POP HL
001353 E14C 23               6      INC HL
001354 E14D 23               6      INC HL
001355 E14E 23               6      INC HL
001356 E14F 23               6      INC HL
001357 E150 D1              10      POP DE
001358 E151 C1              10      POP BC
001359 E152 2005            12      JR  NZ,CPNAME1
00135B E154 7E               7      LD  A,(HL)
00135C E155 23               6      INC HL
00135D E156 66               7      LD  H,(HL)
00135E E157 6F               4      LD  L,A
00135F E158 C9              10      RET
       E159                     CPNAME1:
001360 E159 23               6      INC HL
001361 E15A 23               6      INC HL
001362 E15B 10E8            13      DJNZ    CPNAME
001364 E15D 37               4      SCF
001365 E15E C9              10      RET
                                
       E15F                     CPFILE4:
001366 E15F C5              11      PUSH    BC
001367 E160 010004          10      LD  BC,00400H
00136A E163 1804            12      JR  CPSTR1
       E165                     CPFILE:
00136C E165 C5              11      PUSH    BC
00136D E166 01000B          10      LD  BC,00B00H
       E169                     CPSTR1:
001370 E169 1A               7      LD  A,(DE)
001371 E16A FE3F             7      CP  '?'     ;Wild card
001373 E16C 2812            12      JR  Z,CPSTR2
001375 E16E 7E               7      LD  A,(HL)
001376 E16F CDD3E2          17      CALL    FKANC
001379 E172 E5              11      PUSH    HL
00137A E173 67               4      LD  H,A
00137B E174 1A               7      LD  A,(DE)
00137C E175 CB01             4      RLC C
00137E E177 CDD3E2          17      CALL    FKANC
001381 E17A CB09             4      RRC C
001383 E17C BC               4      CP  H       ;CP (HL),(DE)
001384 E17D E1              10      POP HL
001385 E17E 2004            12      JR  NZ,CPSTR3
       E180                     CPSTR2:
001387 E180 13               6      INC DE
001388 E181 23               6      INC HL
001389 E182 10E5            13      DJNZ    CPSTR1
       E184                     CPSTR3:
00138B E184 C1              10      POP BC
00138C E185 C9              10      RET
                                
       E186                     CPFILE2:
00138D E186 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001390 E189 F6E1             7      OR  0E1H
001392 E18B 2F               4      CPL
001393 E18C A6               7      AND (HL)
001394 E18D C9              10      RET
                                
       E18E                     DCPAT:
001395 E18E 0E00             7      LD  C,0
001397 E190 2A7EF0          16      LD  HL,(_DTBUF)
00139A E193 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
00139D E196 B7               4      OR  A
00139E E197 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
00139F E198 3AACE1          13      LD  A,(SPCPAT)
0013A2 E19B 4F               4      LD  C,A
0013A3 E19C 3A14E9          13      LD  A,(_SECPS)
0013A6 E19F B9               4      CP  C
0013A7 E1A0 3801            12      JR  C,DC1
0013A9 E1A2 AF               4      XOR A
       E1A3                     DC1:
0013AA E1A3 F680             7      OR  080H
0013AC E1A5 32A0EF          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       E1A8                     CLUSTX:
0013AF E1A8 E5              11      PUSH    HL
0013B0 E1A9 EB               4      EX  DE,HL
0013B1 E1AA AF               4      XOR A
0013B2 E1AB 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       E1AC                     SPCPAT  EQU $-1
       E1AD                     L_CLDBL:
0013B4 E1AD CB19             8      RR  C       ;->CF
0013B6 E1AF 3804            12      JR  C,E_CLDBL
0013B8 E1B1 29              11      ADD HL,HL       ;*2
0013B9 E1B2 8F               4      ADC A,A
0013BA E1B3 18F8            12      JR  L_CLDBL
       E1B5                     E_CLDBL:
0013BC E1B5 4F               4      LD  C,A
0013BD E1B6 3A14E9          13      LD  A,(_SECPS)
0013C0 E1B9 B5               4      OR  L
0013C1 E1BA 6F               4      LD  L,A
0013C2 E1BB 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       E1BC                     CLSPAT  EQU $-2
0013C5 E1BE AF               4      XOR A
0013C6 E1BF 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
0013C7 E1C0 89               4      ADC A,C
0013C8 E1C1 4F               4      LD  C,A
0013C9 E1C2 EB               4      EX  DE,HL
0013CA E1C3 E1              10      POP HL
0013CB E1C4 C9              10      RET
                                
       E1C5                     ENDCL:
0013CC E1C5 7A               4      LD  A,D ;END CLUSTER
0013CD E1C6 FE01             7      CP  1   ;164=356    (self-modifying code)
       E1C7                     CLPAT1  EQU $-1
0013CF E1C8 C0              11      RET NZ
0013D0 E1C9 7B               4      LD  A,E
0013D1 E1CA FE64             7      CP  064H    ;       (self-modifying code)
       E1CB                     CLPAT2  EQU $-1
0013D3 E1CC C9              10      RET
                                
       E1CD                     CAP:
0013D4 E1CD FE61             7      CP  'a'
0013D6 E1CF D8              11      RET C
0013D7 E1D0 FE7B             7      CP  'z'+1
0013D9 E1D2 D0              11      RET NC
0013DA E1D3 D620             7      SUB 020H
0013DC E1D5 C9              10      RET
       E1D6                     CAP2:
0013DD E1D6 CDCDE1          17      CALL    CAP
       E1D9                     CAP3:               ;
0013E0 E1D9 FE05             7      CP  5
0013E2 E1DB 2803            12      JR  Z,CAP4
0013E4 E1DD FE21             7      CP  021H
0013E6 E1DF C9              10      RET
       E1E0                     CAP4:
0013E7 E1E0 3EE5             7      LD  A,0E5H
0013E9 E1E2 C9              10      RET
                                
       E1E3                     CHDIR:
0013EA E1E3 CDCEEB          17      CALL    GETDPBD
0013ED E1E6 381D            12      JR  C,CHDIR2
0013EF E1E8 DD751A          19      LD  (IX+DPB_SDIR),L
0013F2 E1EB DD741B          19      LD  (IX+DPB_SDIR+1),H
0013F5 E1EE 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       E1F0                     LDDIR:
0013F7 E1F0 CDCEEB          17      CALL    GETDPBD
0013FA E1F3 DD5E1A          19      LD  E,(IX+DPB_SDIR)
0013FD E1F6 DD561B          19      LD  D,(IX+DPB_SDIR+1)
001400 E1F9 13               6      INC DE
001401 E1FA FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
001404 E1FD FD720F          19      LD  (IY+15),D
001407 E200 1B               6      DEC DE
001408 E201 AF               4      XOR A
001409 E202 32A0EF          13      LD  (_DIRF),A
       E205                     CHDIR2:
00140C E205 DDE1            14      POP IX
00140E E207 C9              10      RET
                                
       E208                     LDDIRX:
00140F E208 3AA0EF          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
001412 E20B E67F             7      AND 07FH
       E20D                     LDDIRX1:
001414 E20D 3214E9          13      LD  (_SECPS),A
001417 E210 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00141A E213 FD560F          19      LD  D,(IY+15)
00141D E216 1B               6      DEC DE
00141E E217 CDC5E1          17      CALL    ENDCL
001421 E21A D4F0E1          17      CALL    NC,LDDIR
       E21D                     LDDIRS:
001424 E21D 7A               4      LD  A,D
001425 E21E B3               4      OR  E
001426 E21F 32A0EF          13      LD  (_DIRF),A   ;ディレクトリか判別
001429 E222 C9              10      RET
                                
       E223                     KILL:
00142A E223 CDEDE2          17      CALL    CHKWILDX
00142D E226 3834            12      JR  C,KILLW
00142F E228 CDC9DF          17      CALL    SOPENX
       E22B                     KILLS:
001432 E22B 3E1F             7      LD  A,01FH
001434 E22D D46FE2          17      CALL    NC,CHKATT
001437 E230 D8              11      RET C
       E231                     KILLSX:
001438 E231 36E5            10      LD  (HL),0E5H   ;DIR
00143A E233 CDC7E2          17      CALL    WTDB
00143D E236 111A00          10      LD  DE,01AH
001440 E239 19              11      ADD HL,DE
001441 E23A 5E               7      LD  E,(HL)
001442 E23B 23               6      INC HL
001443 E23C 56               7      LD  D,(HL)
       E23D                     KILLS1:
001444 E23D CDC5E1          17      CALL    ENDCL
001447 E240 D0              11      RET NC      ;CF=0
001448 E241 21FEFF          10      LD  HL,0-2
00144B E244 19              11      ADD HL,DE
00144C E245 D0              11      RET NC      ;DE= 0 or 1
00144D E246 D5              11      PUSH    DE
00144E E247 CDF7EF          17      CALL    _GNCL
001451 E24A ED53FEF0        20      LD  (_CLPS),DE
001455 E24E D1              10      POP DE
001456 E24F 210000          10      LD  HL,0
001459 E252 D4FAEF          17      CALL    NC,_SNCL
00145C E255 D8              11      RET C
00145D E256 ED5BFEF0        20      LD  DE,(_CLPS)  ;FAT
001461 E25A 18E1            12      JR  KILLS1
                                
       E25C                     KILLW:
001463 E25C CDF8DF          17      CALL    SOPEN
       E25F                     KILLW1:
001466 E25F 380B            12      JR  C,KILLW2
001468 E261 CD97E0          17      CALL    SOPENE2
00146B E264 CD2BE2          17      CALL    KILLS
00146E E267 CD5CE0          17      CALL    NOPEN
001471 E26A 18F3            12      JR  KILLW1
       E26C                     KILLW2:
001473 E26C C8              11      RET Z
001474 E26D 3F               4      CCF
001475 E26E C9              10      RET
                                
       E26F                     CHKATT:
001476 E26F E5              11      PUSH    HL
001477 E270 110B00          10      LD  DE,00BH
00147A E273 19              11      ADD HL,DE
00147B E274 A6               7      AND (HL)
00147C E275 E1              10      POP HL
00147D E276 C8              11      RET Z
00147E E277 37               4      SCF
00147F E278 C9              10      RET
                                
       E279                     NAME:
001480 E279 CDEDE2          17      CALL    CHKWILDX
001483 E27C D8              11      RET C
001484 E27D 110400          10      LD  DE,4
001487 E280 19              11      ADD HL,DE
001488 E281 2296E2          16      LD  (NAMEP),HL
00148B E284 23               6      INC HL
00148C E285 CDF1E2          17      CALL    CHKWILD
00148F E288 D8              11      RET C
                                
001490 E289 CDC9DF          17      CALL    SOPENX
001493 E28C 3E0F             7      LD  A,00FH
001495 E28E D46FE2          17      CALL    NC,CHKATT
001498 E291 D8              11      RET C
                                
001499 E292 FDE5            15      PUSH    IY
00149B E294 FD210000        14      LD  IY,0        ;自己書き換え
       E296                     NAMEP   EQU $-2
00149F E298 CDC9DF          17      CALL    SOPENX
0014A2 E29B FDE3            23      EX  (SP),IY
0014A4 E29D 3F               4      CCF
0014A5 E29E D4F8DF          17      CALL    NC,SOPEN
0014A8 E2A1 EB               4      EX  DE,HL
0014A9 E2A2 E1              10      POP HL
0014AA E2A3 D8              11      RET C
                                
       E2A4                     SETNAME:
0014AB E2A4 01000B          10      LD  BC,11*256
0014AE E2A7 23               6      INC HL
0014AF E2A8 7E               7      LD  A,(HL)
0014B0 E2A9 FEE5             7      CP  0E5H
0014B2 E2AB 2004            12      JR  NZ,SNAME1
0014B4 E2AD 3E05             7      LD  A,5
0014B6 E2AF 180E            12      JR  SNAME3
       E2B1                     SNAME1:
0014B8 E2B1 7E               7      LD  A,(HL)
0014B9 E2B2 0C               4      INC C
0014BA E2B3 0D               4      DEC C
0014BB E2B4 2009            12      JR  NZ,SNAME3
0014BD E2B6 CDCDE1          17      CALL    CAP
0014C0 E2B9 FEA0             7      CP  0A0H
0014C2 E2BB 2002            12      JR  NZ,SNAME3
0014C4 E2BD 3E20             7      LD  A,020H
       E2BF                     SNAME3:
0014C6 E2BF 12               7      LD  (DE),A
0014C7 E2C0 7E               7      LD  A,(HL)
0014C8 E2C1 23               6      INC HL
0014C9 E2C2 CDDAE2          17      CALL    FKAN
0014CC E2C5 10EA            13      DJNZ    SNAME1
       E2C7                     WTDB:
0014CE E2C7 3EFF             7      LD  A,0FFH
0014D0 E2C9 3239EF          13      LD  (SFILE),A
       E2CC                     SWTDBF:
0014D3 E2CC 3E01             7      LD  A,1
0014D5 E2CE 32A4EF          13      LD  (_WTDBF),A
0014D8 E2D1 AF               4      XOR A
0014D9 E2D2 C9              10      RET
                                
       E2D3                     FKANC:
0014DA E2D3 CB41             8      BIT 0,C
0014DC E2D5 CCD6E1          17      CALL    Z,CAP2
0014DF E2D8 1801            12      JR  FKANX
       E2DA                     FKAN:           ;漢字チェック
0014E1 E2DA 13               6      INC DE
       E2DB                     FKANX:
0014E2 E2DB CB41             8      BIT 0,C
0014E4 E2DD CB81             8      RES 0,C
0014E6 E2DF C0              11      RET NZ
0014E7 E2E0 FE80             7      CP  080H
0014E9 E2E2 D8              11      RET C
0014EA E2E3 FEA0             7      CP  0A0H
0014EC E2E5 3803            12      JR  C,FKAN1
0014EE E2E7 FEE0             7      CP  0E0H
0014F0 E2E9 D8              11      RET C
       E2EA                     FKAN1:
0014F1 E2EA 0C               4      INC C
0014F2 E2EB A7               4      AND A
0014F3 E2EC C9              10      RET
                                
       E2ED                     CHKWILDX:
0014F4 E2ED FDE5            15      PUSH    IY
0014F6 E2EF E1              10      POP HL
0014F7 E2F0 23               6      INC HL
       E2F1                     CHKWILD:
0014F8 E2F1 060B             7      LD  B,11
0014FA E2F3 3E3F             7      LD  A,'?'
       E2F5                     CHKWIL1:
0014FC E2F5 BE               7      CP  (HL)
0014FD E2F6 23               6      INC HL
0014FE E2F7 37               4      SCF
0014FF E2F8 C8              11      RET Z
001500 E2F9 10FA            13      DJNZ    CHKWIL1
001502 E2FB AF               4      XOR A
001503 E2FC C9              10      RET
                                
       E2FD                     SDIRENT:        ;IY=FCB HL=DIR
001504 E2FD D5              11      PUSH    DE
001505 E2FE E5              11      PUSH    HL
001506 E2FF FDE5            15      PUSH    IY
001508 E301 D1              10      POP DE
001509 E302 EB               4      EX  DE,HL
00150A E303 CDA4E2          17      CALL    SETNAME
                                ;               Attribute
00150D E306 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001510 E309 12               7      LD  (DE),A
001511 E30A 13               6      INC DE
                                ;               Reserved
001512 E30B AF               4      XOR A
001513 E30C 060A             7      LD  B,10
       E30E                     SDE1:
001515 E30E 12               7      LD  (DE),A
001516 E30F 13               6      INC DE
001517 E310 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
001519 E312 21E4F0          10      LD  HL,SDDATA       ;(FCB)更新年月日
00151C E315 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       E317                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
00151E E317 7E               7      LD  A,(HL)
00151F E318 23               6      INC HL
001520 E319 321EE3          13      LD  (SDPAT),A
001523 E31C FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       E31E                     SDPAT   EQU $-1
001526 E31F 12               7      LD  (DE),A
001527 E320 13               6      INC DE
001528 E321 10F4            13      DJNZ    SDLOOP
                                
00152A E323 AF               4      XOR A
00152B E324 E1              10      POP HL
00152C E325 D1              10      POP DE
00152D E326 C9              10      RET
                                
       E327                     WOPEN:
00152E E327 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001531 E32A E61F             7      AND 01FH
001533 E32C 37               4      SCF
001534 E32D C0              11      RET NZ
001535 E32E FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E332                     TOPEN2:
001539 E332 AF               4      XOR A
       E333                     TOPEN:              ;Initializes the time stamp
00153A E333 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
00153E E337 C9              10      RET
                                
       E338                     WRDFX:
00153F E338 3AACE1          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       E33B                     L_WRFX:
001542 E33B 1F               4      RRA         ;->CF
001543 E33C 3806            12      JR  C,E_WRFX
001545 E33E CB39             8      SRL C
001547 E340 CB1C             8      RR  H       ;CH=CH/2
001549 E342 18F7            12      JR  L_WRFX
       E344                     E_WRFX:
00154B E344 41               4      LD  B,C
00154C E345 4C               4      LD  C,H
00154D E346 03               6      INC BC
00154E E347 3E37             7      LD  A,037H      ;SCF
001550 E349 32A4E7          13      LD  (DRDN1),A
                                
       E34C                     WRDF:               ;BCクラスタ分FATを確保する
001553 E34C 110200          10      LD  DE,2
001556 E34F AF               4      XOR A
001557 E350 3214E9          13      LD  (_SECPS),A
       E353                     WRDF1:
00155A E353 C5              11      PUSH    BC
00155B E354 D5              11      PUSH    DE
00155C E355 CDF7EF          17      CALL    _GNCL
00155F E358 381C            12      JR  C,WRDF3
001561 E35A 7A               4      LD  A,D     ;空いているかチェック
001562 E35B B3               4      OR  E
001563 E35C 202A            12      JR  NZ,WRDF4
001565 E35E E1              10      POP HL      ;HL=空いているクラスタ
001566 E35F E5              11      PUSH    HL
001567 E360 ED5BFEF0        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
00156B E364 22FEF0          16      LD  (_CLPS),HL
00156E E367 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
00156F E368 B3               4      OR  E
001570 E369 2008            12      JR  NZ,WRDF2
001572 E36B FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
001575 E36E FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
001578 E371 1803            12      JR  WRDF3
       E373                     WRDF2:
00157A E373 CDFAEF          17      CALL    _SNCL
       E376                     WRDF3:
00157D E376 D1              10      POP DE
00157E E377 C1              10      POP BC
00157F E378 D8              11      RET C
001580 E379 0B               6      DEC BC
001581 E37A 78               4      LD  A,B
001582 E37B B1               4      OR  C
001583 E37C 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
001585 E37E ED5BFEF0        20      LD  DE,(_CLPS)
001589 E382 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
00158C E385 C3FAEF          10      JP  _SNCL
                                
       E388                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
00158F E388 D1              10      POP DE
001590 E389 C1              10      POP BC
       E38A                     WRDF5:
001591 E38A 13               6      INC DE
001592 E38B CDC5E1          17      CALL    ENDCL
001595 E38E 38C3            12      JR  C,WRDF1
001597 E390 37               4      SCF
001598 E391 C9              10      RET
                                
       E392                     RWXR:
001599 E392 3AB1E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E395                     L_RWX:
00159C E395 1F               4      RRA     ;->CF
00159D E396 3808            12      JR  C,E_RWX
00159F E398 CB38             8      SRL B   ;BCH=BCH/2
0015A1 E39A CB19             8      RR  C   ;
0015A3 E39C CB1C             8      RR  H   ;
0015A5 E39E 18F5            12      JR  L_RWX
       E3A0                     E_RWX:
0015A7 E3A0 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0015AA E3A3 FD561B          19      LD  D,(IY+27)
0015AD E3A6 AF               4      XOR A
0015AE E3A7 3214E9          13      LD  (_SECPS),A
       E3AA                     RWX1:
0015B1 E3AA ED53FEF0        20      LD  (_CLPS),DE
0015B5 E3AE 7A               4      LD  A,D
0015B6 E3AF B3               4      OR  E
0015B7 E3B0 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
0015B9 E3B2 78               4      LD  A,B
0015BA E3B3 B1               4      OR  C
0015BB E3B4 B4               4      OR  H
0015BC E3B5 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
0015BD E3B6 CD1CE9          17      CALL    GNCLX
0015C0 E3B9 D8              11      RET C
0015C1 E3BA 7C               4      LD  A,H     ;
0015C2 E3BB 25               4      DEC H       ;
0015C3 E3BC B7               4      OR  A       ;DEC BCH
0015C4 E3BD 2001            12      JR  NZ,RWX2     ;
0015C6 E3BF 0B               6      DEC BC      ;
       E3C0                     RWX2:
0015C7 E3C0 CDC5E1          17      CALL    ENDCL
0015CA E3C3 38E5            12      JR  C,RWX1
       E3C5                     SCF_RET:
0015CC E3C5 37               4      SCF
0015CD E3C6 C9              10      RET
                                
       E3C7                     DSKF:
0015CE E3C7 110000          10      LD  DE,0
       E3C8                     MAXCLP  EQU $-2
0015D1 E3CA 2AACEF          16      LD  HL,(_FAKEFREE)
0015D4 E3CD 7C               4      LD  A,H
0015D5 E3CE B5               4      OR  L
0015D6 E3CF 2803            12      JR  Z,DSKF1
0015D8 E3D1 110100          10      LD  DE,1
       E3D4                     DSKF1:
0015DB E3D4 D5              11      PUSH    DE
0015DC E3D5 CDF7EF          17      CALL    _GNCL
0015DF E3D8 380C            12      JR  C,POPSCF
0015E1 E3DA 7A               4      LD  A,D
0015E2 E3DB B3               4      OR  E
0015E3 E3DC 2001            12      JR  NZ,DSKF2
0015E5 E3DE 23               6      INC HL
       E3DF                     DSKF2:
0015E6 E3DF D1              10      POP DE
0015E7 E3E0 1B               6      DEC DE
0015E8 E3E1 7A               4      LD  A,D
0015E9 E3E2 B3               4      OR  E
0015EA E3E3 20EF            12      JR  NZ,DSKF1
0015EC E3E5 C9              10      RET
                                
       E3E6                     POPSCF:
0015ED E3E6 F1              10      POP AF
0015EE E3E7 37               4      SCF
0015EF E3E8 C9              10      RET
                                
       E3E9                     SETTMS:
0015F0 E3E9 FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
0015F3 E3EC 3C               4      INC A
0015F4 E3ED C0              11      RET NZ      ;ファイルが更新されていない
       E3EE                     SETTMSX:            ;FCBに日付時刻をセットする
0015F5 E3EE CD7CDA          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
0015F8 E3F1 CB25             8      SLA L       ;   *2
0015FA E3F3 CB25             8      SLA L       ;   *4
0015FC E3F5 29              11      ADD HL,HL       ;*2 *8
0015FD E3F6 29              11      ADD HL,HL       ;*4 *16
0015FE E3F7 29              11      ADD HL,HL       ;*8 *32
0015FF E3F8 7A               4      LD  A,D
001600 E3F9 0F               4      RRCA            ;bit.0->7->->->0->C
001601 E3FA E61F             7      AND 01FH
001603 E3FC B5               4      OR  L
001604 E3FD FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
001607 E400 FD7417          19      LD  (IY+23),H
                                
00160A E403 CD55DA          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
00160D E406 0144F8          10      LD  BC,0-1980
001610 E409 09              11      ADD HL,BC
001611 E40A 65               4      LD  H,L
                                
001612 E40B 7A               4      LD  A,D
001613 E40C 87               4      ADD A,A     ;*2
001614 E40D 87               4      ADD A,A     ;*4
001615 E40E 87               4      ADD A,A     ;*8
001616 E40F 87               4      ADD A,A     ;*16
001617 E410 6F               4      LD  L,A
001618 E411 29              11      ADD HL,HL       ;*32
001619 E412 7D               4      LD  A,L
00161A E413 B3               4      OR  E
00161B E414 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
00161E E417 FD7415          19      LD  (IY+21),H
001621 E41A C9              10      RET
                                
       E41B                     PUSHRR:
001622 E41B 32B3E4          13      LD  (SETSEQ_SWC_RND),A
001625 E41E 22C5E4          16      LD  (SETSEQ_SWC_SEQ_RR),HL
001628 E421 CD41E4          17      CALL    GET_RR_AHL
00162B E424 220FEF          16      LD  (RR_BUF_HL),HL
00162E E427 3211EF          13      LD  (RR_BUF_A),A
001631 E42A C9              10      RET
                                
       E42B                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
001632 E42B 87               4      ADD A,A     ;in BHLA => out AHL
001633 E42C ED6A            15      ADC HL,HL
001635 E42E CB18             8      RR  B
001637 E430 B7               4      OR  A
001638 E431 78               4      LD  A,B     ;ここでフラグは変化しない
001639 E432 C8              11      RET Z
00163A E433 2C               4      INC L       ;INC AHL
00163B E434 C0              11      RET NZ      ;
00163C E435 24               4      INC H       ;
00163D E436 C0              11      RET NZ      ;
00163E E437 3C               4      INC A       ;
00163F E438 C9              10      RET
                                
       E439                     INIT_RND:
001640 E439 3ECD             7      LD  A,0CDH      ;CALL ????
001642 E43B 2188E4          10      LD  HL,POPRR
001645 E43E CD1BE4          17      CALL    PUSHRR
       E441                     GET_RR_AHL:
001648 E441 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00164B E444 FD6622          19      LD  H,(IY+34)   ;
00164E E447 FD7E23          19      LD  A,(IY+35)   ;
001651 E44A C9              10      RET
       E44B                     SET_RR_AHL:
001652 E44B FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001655 E44E FD7422          19      LD  (IY+34),H
001658 E451 FD7723          19      LD  (IY+35),A
00165B E454 C9              10      RET
       E455                     INIT_SEQ:
00165C E455 3E01             7      LD  A,1     ;LD BC,????
00165E E457 2185E4          10      LD  HL,SETSEQ
001661 E45A CD1BE4          17      CALL    PUSHRR
       E45D                     GETSEQ:
001664 E45D FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
001667 E460 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
00166A E463 AF               4      XOR A
                                
00166B E464 CB25             8      SLA L   ;L=L*2
                                
00166D E466 CB3C             8      SRL H   ;HL=HL/2
00166F E468 CB1D             8      RR  L   ;
001671 E46A C9              10      RET
                                
       E46B                     SETSEQ1:
001672 E46B F5              11      PUSH    AF
001673 E46C E5              11      PUSH    HL      ;AHL=Random record
001674 E46D CD41E4          17      CALL    GET_RR_AHL
001677 E470 47               4      LD  B,A     ;AHL→HLA
001678 E471 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
001679 E472 6C               4      LD  L,H     ;(IY+34)
00167A E473 60               4      LD  H,B     ;(IY+35)
00167B E474 0600             7      LD  B,0
                                
00167D E476 CD2BE4          17      CALL    GET_CPM_R_SIZE
                                
001680 E479 29              11      ADD HL,HL
001681 E47A CB3D             8      SRL L       ;L=L/2
001683 E47C FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
001686 E47F FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
001689 E482 E1              10      POP HL
00168A E483 F1              10      POP AF
00168B E484 C9              10      RET
       E485                     SETSEQ:
00168C E485 CD6BE4          17      CALL    SETSEQ1
       E488                     POPRR:
00168F E488 F5              11      PUSH    AF
001690 E489 E5              11      PUSH    HL
001691 E48A 2A0FEF          16      LD  HL,(RR_BUF_HL)
001694 E48D 3A11EF          13      LD  A,(RR_BUF_A)
001697 E490 CD4BE4          17      CALL    SET_RR_AHL
00169A E493 E1              10      POP HL
00169B E494 F1              10      POP AF
00169C E495 C9              10      RET
                                
       E496                     RB_WRITE:
00169D E496 C5              11      PUSH    BC
00169E E497 ED4B4CF0        20      LD  BC,(STABLE+2*026H)  ;(BDOS)ランダムブロック書き込み
0016A2 E49B 1805            12      JR  RBRW
       E49D                     RB_READ:
0016A4 E49D C5              11      PUSH    BC
0016A5 E49E ED4B4EF0        20      LD  BC,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       E4A2                     RBRW:
0016A9 E4A2 1F               4      RRA     ;AHL = AHL*128
0016AA E4A3 7C               4      LD  A,H ;AHL = AHL0/2
0016AB E4A4 1F               4      RRA     ;A
0016AC E4A5 65               4      LD  H,L ;
0016AD E4A6 CB1C             8      RR  H   ;H
0016AF E4A8 2E00             7      LD  L,0 ;
0016B1 E4AA CB1D             8      RR  L   ;L
0016B3 E4AC CD4BE4          17      CALL    SET_RR_AHL
0016B6 E4AF 218000          10      LD  HL,128
0016B9 E4B2 C5              11      PUSH    BC
       E4B3                     SETSEQ_SWC_RND:
0016BA E4B3 CD6BE4          17      CALL    SETSEQ1
0016BD E4B6 C1              10      POP BC
0016BE E4B7 FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
0016C2 E4BB FDE5            15      PUSH    IY
0016C4 E4BD D1              10      POP DE
0016C5 E4BE D5              11      PUSH    DE
0016C6 E4BF CDCDE4          17      CALL    JP_BC
0016C9 E4C2 FDE1            14      POP IY
0016CB E4C4 CD85E4          17      CALL    SETSEQ
       E4C5                     SETSEQ_SWC_SEQ_RR   EQU $-2
0016CE E4C7 FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
0016D2 E4CB C1              10      POP BC
0016D3 E4CC C9              10      RET
       E4CD                     JP_BC:
0016D4 E4CD C5              11      PUSH    BC
0016D5 E4CE C9              10      RET
                                
       E056                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       E056                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       E056                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       E056                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       E056                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E4CF                     _SYS26:     ;(BDOS)ランダムブロック書き込み
0016D6 E4CF AF               4      XOR A
0016D7 E4D0 32A4E7          13      LD  (DRDN1),A   ;NOP
0016DA E4D3 22F4E6          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
0016DD E4D6 225DEF          16      LD  (LEFTX),HL
0016E0 E4D9 CD9FDF          17      CALL    SETDRV
                                
0016E3 E4DC CD4CE6          17      CALL    RBX0
0016E6 E4DF DA6CE5          10      JP  C,RBWERR
0016E9 E4E2 CD27E3          17      CALL    WOPEN
0016EC E4E5 DA6CE5          10      JP  C,RBWERR
0016EF E4E8 7C               4      LD  A,H
0016F0 E4E9 B5               4      OR  L
0016F1 E4EA CA65E5          10      JP  Z,RBW1
                                
0016F4 E4ED 2B               6      DEC HL
                                
0016F5 E4EE CD0AE7          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0016F8 E4F1 19              11      ADD HL,DE       ;BCHL=HL+BCDE
0016F9 E4F2 3001            12      JR  NC,S26X1    ;
0016FB E4F4 03               6      INC BC      ;
       E4F5                     S26X1:
0016FC E4F5 CD92E3          17      CALL    RWXR
0016FF E4F8 DC38E3          17      CALL    C,WRDFX
001702 E4FB DA6CE5          10      JP  C,RBWERR
                                
001705 E4FE CD7BE6          17      CALL    RBX2
001708 E501 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
00170A E503 CD9AE6          17      CALL    RBXA
00170D E506 3864            12      JR  C,RBWERR
00170F E508 EB               4      EX  DE,HL
001710 E509 C5              11      PUSH    BC
001711 E50A EDB0                    LDIR
001713 E50C 225FEF          16      LD  (DTAX),HL
                                
001716 E50F CDCCE2          17      CALL    SWTDBF      ;バッファデータは更新された
                                
001719 E512 2A5DEF          16      LD  HL,(LEFTX)
00171C E515 D1              10      POP DE
00171D E516 ED52            15      SBC HL,DE
00171F E518 225DEF          16      LD  (LEFTX),HL
001722 E51B 2831            12      JR  Z,RBWEND
                                
       E51D                     RBWB:
001724 E51D CDCFE6          17      CALL    RBXB
001727 E520 2814            12      JR  Z,RBWC
       E522                     RBWB1:
001729 E522 C5              11      PUSH    BC
00172A E523 D5              11      PUSH    DE
00172B E524 CDA8E1          17      CALL    CLUSTX
00172E E527 CD1EE7          17      CALL    DWTC
001731 E52A D1              10      POP DE
001732 E52B C1              10      POP BC
001733 E52C D41CE9          17      CALL    NC,GNCLX
001736 E52F 383B            12      JR  C,RBWERR
001738 E531 10EF            13      DJNZ    RBWB1
00173A E533 CD6EE7          17      CALL    DRW_FLUSH
       E536                     RBWC:
00173D E536 CDE7E6          17      CALL    RBXC
001740 E539 2813            12      JR  Z,RBWEND
001742 E53B C5              11      PUSH    BC
001743 E53C CDA8E1          17      CALL    CLUSTX
001746 E53F CDA3E7          17      CALL    DRDN
001749 E542 C1              10      POP BC
00174A E543 3827            12      JR  C,RBWERR
00174C E545 ED5B7EF0        20      LD  DE,(_DTBUF)
001750 E549 EDB0                    LDIR
001752 E54B CDCCE2          17      CALL    SWTDBF      ;バッファデータは更新された
       E54E                     RBWEND:
001755 E54E CDF3E6          17      CALL    RBXEND
                                
001758 E551 CD5BE6          17      CALL    RBX1
00175B E554 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
00175D E556 CD0AE7          17      CALL    GET_RR_BCDE ;BCDE=Random record
001760 E559 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
001763 E55C FD7211          19      LD  (IY+17),D   ;
001766 E55F FD7112          19      LD  (IY+18),C   ;
001769 E562 FD7013          19      LD  (IY+19),B   ;
       E565                     RBW1:
00176C E565 FDE1            14      POP IY
00176E E567 C1              10      POP BC
00176F E568 D1              10      POP DE
001770 E569 E1              10      POP HL
       E56A                     DD_NUL:
001771 E56A AF               4      XOR A
       E56B                     DRDF0:
       E56B                     DWTF0:
001772 E56B C9              10      RET
                                
       E56C                     RBWERR:
001773 E56C FDE5            15      PUSH    IY
001775 E56E D1              10      POP DE
001776 E56F 2A20F0          16      LD  HL,(STABLE+2*010H)
001779 E572 CD0F00          17      CALL    JP_HL
       E575                     RBRERR1:
00177C E575 3E01             7      LD  A,001H
       E577                     RBRERR2:
00177E E577 FDE1            14      POP IY
001780 E579 C1              10      POP BC
001781 E57A D1              10      POP DE
001782 E57B E1              10      POP HL
001783 E57C 37               4      SCF
001784 E57D 210000          10      LD  HL,0
001787 E580 C9              10      RET
                                
       E581                     RBRERR:
001788 E581 3EFF             7      LD  A,0FFH
00178A E583 18F2            12      JR  RBRERR2
                                
       E585                     RBRFL:
00178C E585 3E00             7  RBRFLP: LD  A,000H
00178E E587 FE0D             7      CP  00DH
001790 E589 2005            12      JR  NZ,RBRFL1
001792 E58B D5              11      PUSH    DE
001793 E58C 1E0A             7      LD  E,00AH
001795 E58E 1805            12      JR  RBRFL2
       E590                     RBRFL1:
001797 E590 D5              11      PUSH    DE
001798 E591 CD09EF          17      CALL    _SYS07
00179B E594 5F               4      LD  E,A
       E595                     RBRFL2:
00179C E595 CDCDEF          17      CALL    _PRINT
00179F E598 7B               4      LD  A,E
0017A0 E599 D1              10      POP DE
0017A1 E59A 3286E5          13      LD  (RBRFLP+1),A
0017A4 E59D C9              10      RET
       E59E                     DDX:
0017A5 E59E FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
0017A8 E5A1 CDCDE1          17      CALL    CAP
0017AB E5A4 FE41             7      CP  'A'
0017AD E5A6 C9              10      RET
                                
                                                ;Read random block
       E5A7                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0017AE E5A7 225DEF          16      LD  (LEFTX),HL
0017B1 E5AA CD9FDF          17      CALL    SETDRV
                                
0017B4 E5AD FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
0017B8 E5B1 C23AE6          10      JP  NZ,RBRDIR   ;ディレクトリ
0017BB E5B4 CD4CE6          17      CALL    RBX0
0017BE E5B7 DA81E5          10      JP  C,RBRERR
0017C1 E5BA CD5BE6          17      CALL    RBX1
0017C4 E5BD D473E6          17      CALL    NC,RBX1R
0017C7 E5C0 DA75E5          10      JP  C,RBRERR1
0017CA E5C3 EB               4      EX  DE,HL
0017CB E5C4 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
0017CD E5C6 19              11      ADD HL,DE
0017CE E5C7 79               4      LD  A,C
0017CF E5C8 DE00             7      SBC A,0
0017D1 E5CA 78               4      LD  A,B
0017D2 E5CB DE00             7      SBC A,0
0017D4 E5CD 3801            12      JR  C,RBR1
0017D6 E5CF EB               4      EX  DE,HL
       E5D0                     RBR1:
0017D7 E5D0 9F               4      SBC A,A
0017D8 E5D1 E601             7      AND 1
0017DA E5D3 3238E6          13      LD  (RBRAP+1),A
                                
0017DD E5D6 7C               4      LD  A,H
0017DE E5D7 B5               4      OR  L
0017DF E5D8 2857            12      JR  Z,RBREND0
                                
0017E1 E5DA 22F4E6          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
0017E4 E5DD 225DEF          16      LD  (LEFTX),HL
                                
0017E7 E5E0 CD7BE6          17      CALL    RBX2
0017EA E5E3 2819            12      JR  Z,RBRB
0017EC E5E5 CD9AE6          17      CALL    RBXA
0017EF E5E8 DA81E5          10      JP  C,RBRERR
0017F2 E5EB C5              11      PUSH    BC
0017F3 E5EC EDB0                    LDIR
0017F5 E5EE ED535FEF        20      LD  (DTAX),DE
0017F9 E5F2 2A5DEF          16      LD  HL,(LEFTX)
0017FC E5F5 D1              10      POP DE
0017FD E5F6 A7               4      AND A
0017FE E5F7 ED52            15      SBC HL,DE
001800 E5F9 225DEF          16      LD  (LEFTX),HL
001803 E5FC 2830            12      JR  Z,RBREND
                                
       E5FE                     RBRB:
001805 E5FE CDCFE6          17      CALL    RBXB
001808 E601 2815            12      JR  Z,RBRC
       E603                     RBRB1:
00180A E603 C5              11      PUSH    BC
00180B E604 D5              11      PUSH    DE
00180C E605 CDA8E1          17      CALL    CLUSTX
00180F E608 CD24E7          17      CALL    DRDC
001812 E60B D1              10      POP DE
001813 E60C C1              10      POP BC
001814 E60D D41CE9          17      CALL    NC,GNCLX
001817 E610 DA81E5          10      JP  C,RBRERR
00181A E613 10EE            13      DJNZ    RBRB1
00181C E615 CD6EE7          17      CALL    DRW_FLUSH
       E618                     RBRC:
00181F E618 CDE7E6          17      CALL    RBXC
001822 E61B 2811            12      JR  Z,RBREND
001824 E61D C5              11      PUSH    BC
001825 E61E CDA8E1          17      CALL    CLUSTX
001828 E621 CD87E7          17      CALL    DRDX
00182B E624 C1              10      POP BC
00182C E625 DA81E5          10      JP  C,RBRERR
00182F E628 EB               4      EX  DE,HL
001830 E629 2A7EF0          16      LD  HL,(_DTBUF)
001833 E62C EDB0                    LDIR
       E62E                     RBREND:
001835 E62E CDF3E6          17      CALL    RBXEND
       E631                     RBREND0:
001838 E631 FDE1            14      POP IY
00183A E633 C1              10      POP BC
00183B E634 D1              10      POP DE
00183C E635 F1              10      POP AF  ;(HL)
00183D E636 AF               4      XOR A
00183E E637 3E00             7  RBRAP:  LD  A,000H
001840 E639 C9              10      RET
                                
       E63A                     RBRDIR:
001841 E63A FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001844 E63D FD661B          19      LD  H,(IY+27)
001847 E640 CDE3E1          17      CALL    CHDIR
00184A E643 AF               4      XOR A
00184B E644 67               4      LD  H,A
00184C E645 6F               4      LD  L,A
00184D E646 3C               4      INC A
00184E E647 3238E6          13      LD  (RBRAP+1),A
001851 E64A 18E5            12      JR  RBREND0
                                
       E64C                     RBX0:
001853 E64C 2A8AEF          16      LD  HL,(_DTA)
001856 E64F 225FEF          16      LD  (DTAX),HL
001859 E652 2A5DEF          16      LD  HL,(LEFTX)
00185C E655 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00185F E658 D6FD             7      SUB 0FDH
001861 E65A C9              10      RET
                                
       E65B                     RBX1:               ;ファイルサイズとランダムレコードを比べる
001862 E65B E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
001863 E65C FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
001866 E65F FD6611          19      LD  H,(IY+17)   ;
001869 E662 FD7E12          19      LD  A,(IY+18)   ;
                                
00186C E665 CD0AE7          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
00186F E668 A7               4      AND A
001870 E669 ED52            15      SBC HL,DE
001872 E66B 99               4      SBC A,C
001873 E66C 4F               4      LD  C,A
001874 E66D FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
001877 E670 98               4      SBC A,B
001878 E671 D1              10      POP DE
001879 E672 C9              10      RET
       E673                     RBX1R:
00187A E673 47               4      LD  B,A
00187B E674 B1               4      OR  C
00187C E675 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
00187D E676 B2               4      OR  D
00187E E677 B3               4      OR  E
00187F E678 C0              11      RET NZ
001880 E679 37               4      SCF
001881 E67A C9              10      RET
                                
       E67B                     RBX2:               ;Cluster settings
001882 E67B FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001885 E67E FD4E23          19      LD  C,(IY+35)
001888 E681 0600             7      LD  B,0
00188A E683 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00188E E687 2003            12      JR  NZ,RBX3
001890 E689 FD4624          19      LD  B,(IY+36)
       E68C                     RBX3:
001893 E68C CD92E3          17      CALL    RWXR
001896 E68F 3AB1E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
001899 E692 3D               4      DEC A
00189A E693 FDA622          19      AND (IY+34)
00189D E696 FDB621          19      OR  (IY+33)
0018A0 E699 C9              10      RET
                                
       E69A                     RBXA:
0018A1 E69A C5              11      PUSH    BC
0018A2 E69B D5              11      PUSH    DE
0018A3 E69C CDA8E1          17      CALL    CLUSTX
0018A6 E69F CD87E7          17      CALL    DRDX
0018A9 E6A2 D1              10      POP DE
0018AA E6A3 C1              10      POP BC
0018AB E6A4 D41CE9          17      CALL    NC,GNCLX
0018AE E6A7 D8              11      RET C
0018AF E6A8 ED53FEF0        20      LD  (_CLPS),DE
                                
0018B3 E6AC FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
0018B6 E6AF 210004          10  SECSZ:  LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
0018B9 E6B2 7C               4      LD  A,H
0018BA E6B3 3D               4      DEC A       ;1024=3 / 512=1
0018BB E6B4 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
0018BE E6B7 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
0018BF E6B8 ED42            15      SBC HL,BC       ;残りを計算
                                
0018C1 E6BA ED5B5DEF        20      LD  DE,(LEFTX)
0018C5 E6BE ED52            15      SBC HL,DE       ;CP HL,DE
0018C7 E6C0 19              11      ADD HL,DE       ;
0018C8 E6C1 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
0018CA E6C3 EB               4      EX  DE,HL
       E6C4                     RBXA1:
0018CB E6C4 E5              11      PUSH    HL
0018CC E6C5 2A7EF0          16      LD  HL,(_DTBUF)
0018CF E6C8 09              11      ADD HL,BC
0018D0 E6C9 ED5B5FEF        20      LD  DE,(DTAX)
0018D4 E6CD C1              10      POP BC
0018D5 E6CE C9              10      RET
                                
       E6CF                     RBXB:
0018D6 E6CF 2A5FEF          16      LD  HL,(DTAX)
0018D9 E6D2 ED5BFEF0        20      LD  DE,(_CLPS)
0018DD E6D6 3A5EEF          13      LD  A,(LEFTX+1)
0018E0 E6D9 47               4      LD  B,A
0018E1 E6DA 3AB1E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E6DD                     RBXB1:
0018E4 E6DD 1F               4      RRA     ;->CF
0018E5 E6DE 3804            12      JR  C,RBXB2
0018E7 E6E0 CB38             8      SRL B   ;B=B/2
0018E9 E6E2 18F9            12      JR  RBXB1
       E6E4                     RBXB2:
0018EB E6E4 78               4      LD  A,B
0018EC E6E5 B7               4      OR  A
0018ED E6E6 C9              10      RET
                                
       E6E7                     RBXC:
0018EE E6E7 ED4B5DEF        20      LD  BC,(LEFTX)
0018F2 E6EB 3AB1E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
0018F5 E6EE 3D               4      DEC A
0018F6 E6EF A0               4      AND B
0018F7 E6F0 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
0018F8 E6F1 B1               4      OR  C
0018F9 E6F2 C9              10      RET
                                
       E6F3                     RBXEND:             ;レコード数だけランダムレコードを進める
0018FA E6F3 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       E6F4                     RBSIZE  EQU $-2
0018FD E6F6 CD41E4          17      CALL    GET_RR_AHL
001900 E6F9 19              11      ADD HL,DE
001901 E6FA CE00             7      ADC A,0
001903 E6FC CD4BE4          17      CALL    SET_RR_AHL
001906 E6FF EB               4      EX  DE,HL       ;HL=進めるレコード数
001907 E700 D0              11      RET NC
001908 E701 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00190C E705 C0              11      RET NZ
00190D E706 FD3424          23      INC (IY+36)
001910 E709 C9              10      RET
                                
       E70A                     GET_RR_BCDE:            ;BCDE=Random record
001911 E70A FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
001914 E70D FD5622          19      LD  D,(IY+34)
001917 E710 FD4E23          19      LD  C,(IY+35)
00191A E713 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
00191C E715 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001920 E719 C0              11      RET NZ
001921 E71A FD4624          19      LD  B,(IY+36)
001924 E71D C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E71E                     DWTC:
001925 E71E E5              11      PUSH    HL
001926 E71F 21AEEA          10      LD  HL,DWT24B
001929 E722 1804            12      JR  DWTC1
       E724                     DRDC:
00192B E724 E5              11      PUSH    HL
00192C E725 219EEA          10      LD  HL,DRD24B
       E728                     DWTC1:
00192F E728 2282E7          16      LD  (DRWF_MODE),HL
001932 E72B E1              10      POP HL
001933 E72C 3A72E7          13      LD  A,(DRWF_B)
001936 E72F B7               4      OR  A
001937 E730 200F            12      JR  NZ,DRDC1
       E732                     SAVE_DRWC:
001939 E732 0601             7      LD  B,1
00193B E734 ED4371E7        20      LD  (DRWF_C),BC
00193F E738 ED5378E7        20      LD  (DRWF_E),DE
001943 E73C 227BE7          16      LD  (DRWF_HL),HL
001946 E73F 1820            12      JR  INC_HL_DRWC
       E741                     DRDC1:
001948 E741 E5              11      PUSH    HL
001949 E742 2178E7          10      LD  HL,DRWF_E
00194C E745 86               7      ADD A,(HL)
00194D E746 F5              11      PUSH    AF
00194E E747 BB               4      CP  E
00194F E748 201D            12      JR  NZ,DRDC2
001951 E74A F1              10      POP AF
001952 E74B 23               6      INC HL
001953 E74C 7E               7      LD  A,(HL)
001954 E74D CE00             7      ADC A,0
001956 E74F F5              11      PUSH    AF
001957 E750 BA               4      CP  D
001958 E751 2014            12      JR  NZ,DRDC2
00195A E753 F1              10      POP AF
00195B E754 3A71E7          13      LD  A,(DRWF_C)
00195E E757 CE00             7      ADC A,0
001960 E759 B9               4      CP  C
001961 E75A 200C            12      JR  NZ,DRDC3
001963 E75C 2172E7          10      LD  HL,DRWF_B
001966 E75F 34              11      INC (HL)
001967 E760 E1              10      POP HL
       E761                     INC_HL_DRWC:
001968 E761 3AB1E6          13      LD  A,(SECSZ+2)     ;1セクタのサイズの上位1バイト
00196B E764 84               4      ADD A,H
00196C E765 67               4      LD  H,A
00196D E766 C9              10      RET
       E767                     DRDC2:
00196E E767 F1              10      POP AF
       E768                     DRDC3:
00196F E768 CD6EE7          17      CALL    DRW_FLUSH
001972 E76B E1              10      POP HL
001973 E76C 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E76E                     DRW_FLUSH:
001975 E76E C5              11      PUSH    BC
001976 E76F D5              11      PUSH    DE
001977 E770 010000          10      LD  BC,0
       E771                     DRWF_C  EQU $-2
       E772                     DRWF_B  EQU $-1
00197A E773 78               4      LD  A,B
00197B E774 B7               4      OR  A
00197C E775 280D            12      JR  Z,DRDF1
00197E E777 110000          10      LD  DE,0
       E778                     DRWF_E  EQU $-2
       E779                     DRWF_D  EQU $-1
001981 E77A 210000          10      LD  HL,0
       E77B                     DRWF_HL EQU $-2
001984 E77D AF               4      XOR A
001985 E77E 3272E7          13      LD  (DRWF_B),A
001988 E781 CD9EEA          17      CALL    DRD24B
       E782                     DRWF_MODE   EQU $-2
       E784                     DRDF1:
00198B E784 D1              10      POP DE
00198C E785 C1              10      POP BC
00198D E786 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E787                     DRDX:
00198E E787 CDC5E7          17      CALL    DRDY
001991 E78A C8              11      RET Z
001992 E78B CDABE7          17      CALL    DRDX1       ;データバッファの情報を保存
001995 E78E D8              11      RET C
001996 E78F E5              11      PUSH    HL
001997 E790 C5              11      PUSH    BC
001998 E791 D5              11      PUSH    DE
001999 E792 2A7EF0          16      LD  HL,(_DTBUF)
00199C E795 3AEEE7          13      LD  A,(_DBS24)
00199F E798 4F               4      LD  C,A
0019A0 E799 CD9CEA          17      CALL    DRD24
0019A3 E79C DCC0E7          17      CALL    C,DRDNE
       E79F                     POP_DE_BC_HL_RET:
0019A6 E79F D1              10      POP DE
0019A7 E7A0 C1              10      POP BC
0019A8 E7A1 E1              10      POP HL
0019A9 E7A2 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E7A3                     DRDN:
0019AA E7A3 AF               4      XOR A
0019AB E7A4 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
0019AC E7A5 30E0            12      JR  NC,DRDX
       E7A7                     DRDNX:
0019AE E7A7 CDC5E7          17      CALL    DRDY
0019B1 E7AA C8              11      RET Z
       E7AB                     DRDX1:
0019B2 E7AB CDDBE7          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
0019B5 E7AE ED53A6EF        20      LD  (_DBSEC),DE
0019B9 E7B2 79               4      LD  A,C
0019BA E7B3 32EEE7          13      LD  (_DBS24),A
                                
0019BD E7B6 3A88EF          13      LD  A,(_DRV)
0019C0 E7B9 32A5EF          13      LD  (_DBDRV),A
0019C3 E7BC CDD9EF          17      CALL    _CHGDRV
0019C6 E7BF D0              11      RET NC
       E7C0                     DRDNE:
0019C7 E7C0 9F               4      SBC A,A     ;CF=1ならばA=0FFH
0019C8 E7C1 32A5EF          13      LD  (_DBDRV),A
0019CB E7C4 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E7C5                     DRDY:
0019CC E7C5 3AEEE7          13      LD  A,(_DBS24)
0019CF E7C8 B9               4      CP  C
0019D0 E7C9 C0              11      RET NZ
                                
0019D1 E7CA E5              11      PUSH    HL
0019D2 E7CB 3A88EF          13      LD  A,(_DRV)
0019D5 E7CE 21A5EF          10      LD  HL,_DBDRV
0019D8 E7D1 AE               7      XOR (HL)
0019D9 E7D2 2005            12      JR  NZ,POP_HL_RET
                                
0019DB E7D4 2AA6EF          16      LD  HL,(_DBSEC)
0019DE E7D7 ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E7D9                     POP_HL_RET:
0019E0 E7D9 E1              10      POP HL
0019E1 E7DA C9              10      RET
                                
       E7DB                     DWTX:
0019E2 E7DB 3AA4EF          13      LD  A,(_WTDBF)
0019E5 E7DE B7               4      OR  A
0019E6 E7DF C8              11      RET Z
0019E7 E7E0 AF               4      XOR A
0019E8 E7E1 32A4EF          13      LD  (_WTDBF),A
                                
0019EB E7E4 E5              11      PUSH    HL
0019EC E7E5 C5              11      PUSH    BC
0019ED E7E6 D5              11      PUSH    DE
0019EE E7E7 3AA5EF          13      LD  A,(_DBDRV)
0019F1 E7EA CDD9EF          17      CALL    _CHGDRV
0019F4 E7ED 0E00             7      LD  C,0
       E7EE                     _DBS24  EQU $-1
0019F6 E7EF ED5BA6EF        20      LD  DE,(_DBSEC)
0019FA E7F3 2A7EF0          16      LD  HL,(_DTBUF)
0019FD E7F6 D4ACEA          17      CALL    NC,DWT24
       E7F9                     POP_DE_BC_HL_RET2:
001A00 E7F9 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E7FB                     RDFATX:
001A02 E7FB E5              11      PUSH    HL
001A03 E7FC 3A88EF          13      LD  A,(_DRV)
001A06 E7FF 21AAEF          10      LD  HL,_FATDRV
001A09 E802 AE               7      XOR (HL)
001A0A E803 28D4            12      JR  Z,POP_HL_RET
                                
001A0C E805 C5              11      PUSH    BC
001A0D E806 D5              11      PUSH    DE
001A0E E807 DDE5            15      PUSH    IX
001A10 E809 CD25E8          17      CALL    WTFATX
001A13 E80C 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
001A15 E80E AF               4      XOR A
001A16 E80F 32ABEF          13      LD  (_FATIX),A
001A19 E812 3A88EF          13      LD  A,(_DRV)
001A1C E815 32AAEF          13      LD  (_FATDRV),A
001A1F E818 CDE5EF          17      CALL    _RDFAT
       E81B                     RDFATE2:
001A22 E81B 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
001A24 E81D 9F               4      SBC A,A     ;A=0xFF
001A25 E81E 32AAEF          13      LD  (_FATDRV),A
       E821                     POP_IX_DE_BC_HL_RET:
001A28 E821 DDE1            14      POP IX
001A2A E823 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E825                     WTFATX:
001A2C E825 3AA2EF          13      LD  A,(_WTFATF)
001A2F E828 B7               4      OR  A
001A30 E829 C8              11      RET Z
001A31 E82A E5              11      PUSH    HL
001A32 E82B 3AAAEF          13      LD  A,(_FATDRV)
001A35 E82E 21A5EF          10      LD  HL,_DBDRV
001A38 E831 AE               7      XOR (HL)
001A39 E832 CCDBE7          17      CALL    Z,DWTX
001A3C E835 38A2            12      JR  C,POP_HL_RET
001A3E E837 C5              11      PUSH    BC
001A3F E838 D5              11      PUSH    DE
001A40 E839 DDE5            15      PUSH    IX
001A42 E83B CDB9EA          17      CALL    WTFAT
001A45 E83E AF               4      XOR A
001A46 E83F 32A2EF          13      LD  (_WTFATF),A
001A49 E842 18DD            12      JR  POP_IX_DE_BC_HL_RET
                                
       E844                     NCL1:
001A4B E844 7A               4      LD  A,D
001A4C E845 B3               4      OR  E
001A4D E846 37               4      SCF
001A4E E847 C8              11      RET Z
                                
001A4F E848 7A               4      LD  A,D
001A50 E849 CB3F             8      SRL A   ;/2
001A52 E84B CB3F             8      SRL A   ;/2
                                
001A54 E84D E5              11      PUSH    HL
001A55 E84E 326DE8          13      LD  (NCLPAT_FATIX),A    ;_FATIX
001A58 E851 2AAAEF          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001A5B E854 BC               4      CP  H
001A5C E855 3A88EF          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001A5F E858 326CE8          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001A62 E85B 2005            12      JR  NZ,NCL2     ;FATIXが違う
001A64 E85D BD               4      CP  L
001A65 E85E 2002            12      JR  NZ,NCL2     ;ドライブが違う
001A67 E860 E1              10      POP HL
001A68 E861 C9              10      RET
       E862                     NCL2:
001A69 E862 C5              11      PUSH    BC
001A6A E863 D5              11      PUSH    DE
001A6B E864 DDE5            15      PUSH    IX
001A6D E866 CD25E8          17      CALL    WTFATX
001A70 E869 38B6            12      JR  C,POP_IX_DE_BC_HL_RET
001A72 E86B 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E86D                     NCLPAT_FATIX    EQU $-1
       E86C                     NCLPAT_FATDRV   EQU $-2
001A75 E86E ED43AAEF        20      LD  (_FATDRV),BC
001A79 E872 CD8EEA          17      CALL    RDFATS
001A7C E875 18A4            12      JR  RDFATE2
                                
       E877                     NCL3:
001A7E E877 CB9A             8      RES 3,D
001A80 E879 CB92             8      RES 2,D
001A82 E87B 6B               4      LD  L,E
001A83 E87C 62               4      LD  H,D
001A84 E87D CB3C             8      SRL H   ;
001A86 E87F CB1D             8      RR  L   ;HLA=HLA/2
001A88 E881 1F               4      RRA     ;
001A89 E882 F5              11      PUSH    AF
001A8A E883 3AABEF          13      LD  A,(_FATIX)
001A8D E886 0F               4      RRCA
001A8E E887 300B            12      JR  NC,NCL3X1
001A90 E889 3AB1E6          13      LD  A,(SECSZ+2)
001A93 E88C FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
001A95 E88E 2004            12      JR  NZ,NCL3X1
001A97 E890 010002          10      LD  BC,512
001A9A E893 09              11      ADD HL,BC
       E894                     NCL3X1:
001A9B E894 F1              10      POP AF
001A9C E895 ED4B7CF0        20      LD  BC,(_FATBF)
001AA0 E899 19              11      ADD HL,DE
001AA1 E89A 09              11      ADD HL,BC
001AA2 E89B 17               4      RLA
001AA3 E89C C9              10      RET
                                
       E89D                     GNCL:
001AA4 E89D CD44E8          17      CALL    NCL1        ;GET NEXT CLUSTER
001AA7 E8A0 D8              11      RET C
001AA8 E8A1 C5              11      PUSH    BC
001AA9 E8A2 E5              11      PUSH    HL
001AAA E8A3 CD77E8          17      CALL    NCL3
001AAD E8A6 3809            12      JR  C,GNC1
001AAF E8A8 5E               7      LD  E,(HL)
001AB0 E8A9 23               6      INC HL
001AB1 E8AA 7E               7      LD  A,(HL)
001AB2 E8AB E60F             7      AND 00FH
001AB4 E8AD 57               4      LD  D,A
001AB5 E8AE E1              10      POP HL
001AB6 E8AF C1              10      POP BC
001AB7 E8B0 C9              10      RET
       E8B1                     GNC1:
001AB8 E8B1 7E               7      LD  A,(HL)
001AB9 E8B2 23               6      INC HL
001ABA E8B3 56               7      LD  D,(HL)
001ABB E8B4 0604             7      LD  B,4
       E8B6                     GNC1L:
001ABD E8B6 CB3A             8      SRL D   ;DA=DA/2
001ABF E8B8 1F               4      RRA     ;
001AC0 E8B9 10FB            13      DJNZ    GNC1L
                                
001AC2 E8BB 5F               4      LD  E,A
001AC3 E8BC E1              10      POP HL
001AC4 E8BD C1              10      POP BC
001AC5 E8BE A7               4      AND A
001AC6 E8BF C9              10      RET
                                
       E8C0                     SNCL:
001AC7 E8C0 CD44E8          17      CALL    NCL1
001ACA E8C3 D8              11      RET C
                                ;               SET NEXT CLUSTER
001ACB E8C4 E5              11      PUSH    HL
001ACC E8C5 C5              11      PUSH    BC
001ACD E8C6 D5              11      PUSH    DE
001ACE E8C7 E5              11      PUSH    HL
001ACF E8C8 CD77E8          17      CALL    NCL3
001AD2 E8CB D1              10      POP DE
                                ;CF=ODD
001AD3 E8CC 7E               7      LD  A,(HL)
001AD4 E8CD 73               7      LD  (HL),E
001AD5 E8CE 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
001AD7 E8D0 23               6      INC HL
001AD8 E8D1 ED67            18      RRD     ;M={A[3:0],E[3:0]}
001ADA E8D3 7A               4      LD  A,D
001ADB E8D4 1804            12      JR  SNC11
       E8D6                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
001ADD E8D6 ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001ADF E8D8 23               6      INC HL
001AE0 E8D9 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E8DA                     SNC11:
001AE1 E8DA ED6F            18      RLD     ;M={M[7:4],D[3:0]}
001AE3 E8DC B7               4      OR  A
001AE4 E8DD D1              10      POP DE
001AE5 E8DE C1              10      POP BC
001AE6 E8DF E1              10      POP HL
       E8E0                     FAT_CHANGED:
001AE7 E8E0 3E01             7      LD  A,1
001AE9 E8E2 32A2EF          13      LD  (_WTFATF),A
001AEC E8E5 C9              10      RET
                                
       E8E6                     N16CL3:
001AED E8E6 C5              11      PUSH    BC
001AEE E8E7 6B               4      LD  L,E
001AEF E8E8 7A               4      LD  A,D
001AF0 E8E9 E603             7      AND 3
001AF2 E8EB 67               4      LD  H,A
001AF3 E8EC 29              11      ADD HL,HL
001AF4 E8ED ED4B7CF0        20      LD  BC,(_FATBF)
001AF8 E8F1 09              11      ADD HL,BC
001AF9 E8F2 C1              10      POP BC
001AFA E8F3 C9              10      RET
                                
       E8F4                     GNCL16:
001AFB E8F4 CD44E8          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
001AFE E8F7 D8              11      RET C
001AFF E8F8 E5              11      PUSH    HL
001B00 E8F9 CDE6E8          17      CALL    N16CL3
001B03 E8FC 5E               7      LD  E,(HL)
001B04 E8FD 23               6      INC HL
001B05 E8FE 56               7      LD  D,(HL)
001B06 E8FF E1              10      POP HL
001B07 E900 C9              10      RET
                                
       E901                     SNCL16:
001B08 E901 CD44E8          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
001B0B E904 D8              11      RET C
001B0C E905 D5              11      PUSH    DE
001B0D E906 E5              11      PUSH    HL
001B0E E907 CDE6E8          17      CALL    N16CL3
001B11 E90A D1              10      POP DE      ;HL
001B12 E90B 73               7      LD  (HL),E
001B13 E90C 23               6      INC HL
001B14 E90D 72               7      LD  (HL),D
001B15 E90E 6B               4      LD  L,E
001B16 E90F 62               4      LD  H,D
001B17 E910 D1              10      POP DE
001B18 E911 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E913                     NEXTX:
001B1A E913 3E00             7      LD  A,0 ;自己書き換え
       E914                     _SECPS  EQU $-1
001B1C E915 3C               4      INC A
001B1D E916 E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E917                     _NCPAT  EQU $-1
001B1F E918 3214E9          13      LD  (_SECPS),A
001B22 E91B C9              10      RET
                                
       E91C                     GNCLX:
001B23 E91C CD13E9          17      CALL    NEXTX
001B26 E91F C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001B27 E920 C3F7EF          10      JP  _GNCL   ;次のクラスタを探す
                                
       E923                     RDFAT:
001B2A E923 3E80             7      LD  A,080H
001B2C E925 3270EF          13      LD  (CHECK),A
       E928                     RDFAT1:
001B2F E928 3A88EF          13      LD  A,(_DRV)
001B32 E92B CDD7EB          17      CALL    CHGDRVR
001B35 E92E D8              11      RET C
001B36 E92F DD7E12          19      LD  A,(IX+DPB_DEVICE)
001B39 E932 CB6F             8      BIT 5,A
001B3B E934 2868            12      JR  Z,RDFAT0X
001B3D E936 2170EF          10      LD  HL,CHECK
001B40 E939 A6               7      AND (HL)
001B41 E93A 77               7      LD  (HL),A
001B42 E93B 110000          10      LD  DE,0        ;BPB
001B45 E93E 2A7CF0          16      LD  HL,(_FATBF)
001B48 E941 CD9AEA          17      CALL    DRD16
001B4B E944 3024            12      JR  NC,GETBPB
001B4D E946 2170EF          10      LD  HL,CHECK
001B50 E949 CB06            15      RLC (HL)
001B52 E94B 3F               4      CCF
001B53 E94C D8              11      RET C
001B54 E94D DDCB0A1E        23      RR  (IX+DPB_FDMODE)
001B58 E951 3F               4      CCF         ;フロッピーディスクのFDモードを切り替える
001B59 E952 DDCB0A16        23      RL  (IX+DPB_FDMODE)
001B5D E956 3EFF             7      LD  A,0FFH
001B5F E958 3289EF          13      LD  (_DSK),A
001B62 E95B 3A84EF          13      LD  A,(_DRIVE)
001B65 E95E E603             7      AND 3
001B67 E960 F680             7      OR  080H
001B69 E962 6F               4      LD  L,A
001B6A E963 26EF             7      LD  H,_CYL0/256
001B6C E965 3EFF             7      LD  A,0FFH
001B6E E967 77               7      LD  (HL),A
001B6F E968 18BE            12      JR  RDFAT1
       E96A                     GETBPB:
001B71 E96A FDE5            15      PUSH    IY
001B73 E96C FD2A7CF0        20      LD  IY,(_FATBF) ;BPB
001B77 E970 CDF1EF          17      CALL    _BPB2DPB
001B7A E973 FDE1            14      POP IY
001B7C E975 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001B7F E978 3021            12      JR  NC,GETBPBOK
001B81 E97A E60F             7      AND 00FH
001B83 E97C FE07             7      CP  7
001B85 E97E 37               4      SCF
001B86 E97F C0              11      RET NZ
001B87 E980 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001B8B E984 21C0F0          10      LD  HL,M2D
001B8E E987 2002            12      JR  NZ,SETFDMODE
001B90 E989 2ED2             7      LD  L,M2HD-STABLE
       E98B                     SETFDMODE:
001B92 E98B DDE5            15      PUSH    IX
001B94 E98D D1              10      POP DE
001B95 E98E EDA0            16      LDI
001B97 E990 EDA0            16      LDI
001B99 E992 13               6      INC DE
001B9A E993 13               6      INC DE
001B9B E994 13               6      INC DE
001B9C E995 13               6      INC DE
001B9D E996 010C00          10      LD  BC,12
001BA0 E999 EDB0                    LDIR
       E99B                     GETBPBOK:
001BA2 E99B CD42EB          17      CALL    CHGDRV2
       E99E                     RDFAT0X:
001BA5 E99E CD8EEA          17      CALL    RDFATS
001BA8 E9A1 D8              11      RET C
001BA9 E9A2 DDAE06          19      XOR (IX+DPB_FATID)
001BAC E9A5 C8              11      RET Z
001BAD E9A6 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001BB1 E9AA C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
001BB2 E9AB 37               4      SCF
001BB3 E9AC C9              10      RET
                                
       E9AD                     POP_HL_SCF_RET:
001BB4 E9AD E1              10      POP HL
001BB5 E9AE 37               4      SCF
001BB6 E9AF C9              10      RET
                                
       E9B0                     BPB2DPB:
001BB7 E9B0 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
001BBA E9B3 B7               4      OR  A
001BBB E9B4 37               4      SCF
001BBC E9B5 C0              11      RET NZ
       E9B6                     BPBOK:
001BBD E9B6 FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001BC0 E9B9 DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001BC3 E9BC FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001BC6 E9BF DD7700          19      LD  (IX+DPB_FATLN),A
001BC9 E9C2 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
001BCC E9C5 DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
001BCF E9C8 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001BD2 E9CB FD660F          19      LD  H,(IY+15)
001BD5 E9CE DD750E          19      LD  (IX+DPB_FATPS),L
001BD8 E9D1 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001BDB E9D4 FD5617          19      LD  D,(IY+23)
001BDE E9D7 FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E9DA                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001BE1 E9DA 19              11      ADD HL,DE
001BE2 E9DB 10FD            13      DJNZ    BPBDP1
       E9DD                     BPBDP2:
001BE4 E9DD DD7510          19      LD  (IX+DPB_DIRPS),L
001BE7 E9E0 DD7411          19      LD  (IX+DPB_DIRPS+1),H
001BEA E9E3 E5              11      PUSH    HL
                                
001BEB E9E4 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
001BEE E9E7 FD6612          19      LD  H,(IY+18)
001BF1 E9EA FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001BF4 E9ED B7               4      OR  A
001BF5 E9EE 28BD            12      JR  Z,POP_HL_SCF_RET
001BF7 E9F0 0606             7      LD  B,6
       E9F2                     BPBBPS1:
001BF9 E9F2 05               4      DEC B
001BFA E9F3 0F               4      RRCA
001BFB E9F4 30FC            12      JR  NC,BPBBPS1
       E9F6                     BPBDE1:
001BFD E9F6 29              11      ADD HL,HL
001BFE E9F7 10FD            13      DJNZ    BPBDE1
                                
001C00 E9F9 7C               4      LD  A,H
001C01 E9FA DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
001C04 E9FD D1              10      POP DE      ;DPB_DIRPS
001C05 E9FE 6C               4      LD  L,H
001C06 E9FF 2600             7      LD  H,0
001C08 EA01 19              11      ADD HL,DE       ;MAXDIR
001C09 EA02 E5              11      PUSH    HL
001C0A EA03 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001C0D EA06 CB21             8      SLA C       ;*2
001C0F EA08 AF               4      XOR A
001C10 EA09 47               4      LD  B,A
001C11 EA0A ED42            15      SBC HL,BC
001C13 EA0C DD7514          19      LD  (IX+DPB_ADDCL),L
001C16 EA0F DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
001C19 EA12 D1              10      POP DE      ;DE=DPB_MAXDIR
001C1A EA13 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001C1D EA16 FD6614          19      LD  H,(IY+20)
                                
001C20 EA19 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001C23 EA1C E60F             7      AND 00FH
001C25 EA1E FE07             7      CP  7       ;フロッピー
001C27 EA20 2019            12      JR  NZ,NOT_FD
001C29 EA22 E5              11      PUSH    HL
001C2A EA23 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001C2D EA26 DD710D          19      LD  (IX+DPB_MAXSEC),C
001C30 EA29 AF               4      XOR A
001C31 EA2A CB21             8      SLA C       ;両面なのでセクタ数を２倍
001C33 EA2C 0610             7      LD  B,16
       EA2E                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001C35 EA2E 29              11      ADD HL,HL
001C36 EA2F 17               4      RLA
001C37 EA30 B9               4      CP  C
001C38 EA31 3802            12      JR  C,DIVSEC1
001C3A EA33 91               4      SUB C
001C3B EA34 2C               4      INC L
       EA35                     DIVSEC1:
001C3C EA35 10F7            13      DJNZ    DIVSEC
001C3E EA37 DD750C          19      LD  (IX+DPB_MAXCYL),L
001C41 EA3A E1              10      POP HL  ;ここまでフロッピー専用
       EA3B                     NOT_FD:
001C42 EA3B 7C               4      LD  A,H
001C43 EA3C B5               4      OR  L
001C44 EA3D 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001C46 EA3F 2010            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001C48 EA41 FD7E23          19      LD  A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001C4B EA44 B7               4      OR  A
001C4C EA45 37               4      SCF
001C4D EA46 C0              11      RET NZ
001C4E EA47 FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001C51 EA4A FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので
001C54 EA4D FD7E22          19      LD  A,(IY+34)   ;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
001C57 EA50 A7               4      AND A       ;CF=0
       EA51                     BPB16BIT:
001C58 EA51 ED52            15      SBC HL,DE
001C5A EA53 DE00             7      SBC A,0
001C5C EA55 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       EA58                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001C5F EA58 CB18             8      RR  B       ;->CY
001C61 EA5A 3808            12      JR  C,BPBTC2
001C63 EA5C CB3F             8      SRL A
001C65 EA5E CB1C             8      RR  H       ;AHL=AHL/2
001C67 EA60 CB1D             8      RR  L
001C69 EA62 18F4            12      JR  BPBTC1
       EA64                     BPBTC2:
001C6B EA64 B7               4      OR  A
001C6C EA65 37               4      SCF
001C6D EA66 C0              11      RET NZ      ;念のため(クラスタ数が16ビットを超える場合)
001C6E EA67 23               6      INC HL
001C6F EA68 23               6      INC HL
001C70 EA69 DD7508          19      LD  (IX+DPB_MAXCL),L
001C73 EA6C DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001C76 EA6F FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001C79 EA72 DD7706          19      LD  (IX+DPB_FATID),A
                                
001C7C EA75 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001C7F EA78 C6FE             7      ADD A,0-2       ;>2:CF=1
001C81 EA7A FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001C84 EA7D 6F               4      LD  L,A
001C85 EA7E 3002            12      JR  NC,BPBFAT1
001C87 EA80 F680             7      OR  080H
       EA82                     BPBFAT1:            ;ここではCF=0
001C89 EA82 DD770F          19      LD  (IX+DPB_BPS),A
001C8C EA85 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001C8D EA86 C8              11      RET Z       ;1セクタ256バイト
001C8E EA87 2D               4      DEC L
001C8F EA88 C8              11      RET Z       ;1セクタ512バイト
001C90 EA89 2D               4      DEC L
001C91 EA8A 2D               4      DEC L
001C92 EA8B C8              11      RET Z       ;1セクタ1024バイト
001C93 EA8C 37               4      SCF
001C94 EA8D C9              10      RET
                                
       EA8E                     RDFATS:
001C95 EA8E CDD4EA          17      CALL    FATSETUP
001C98 EA91 D8              11      RET C
001C99 EA92 CD9EEA          17      CALL    DRD24B
001C9C EA95 2A7CF0          16      LD  HL,(_FATBF)
001C9F EA98 7E               7      LD  A,(HL)
001CA0 EA99 C9              10      RET
                                
       EA9A                     DRD16:
001CA1 EA9A 0E00             7      LD  C,0
       EA9C                     DRD24:
001CA3 EA9C 0601             7      LD  B,1
       EA9E                     DRD24B:
001CA5 EA9E DDE5            15      PUSH    IX
001CA7 EAA0 DD2AA8EF        20      LD  IX,(_DPB)
001CAB EAA4 CD68ED          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       EAA5                     DRDPAT  EQU $-2
       EAA7                     POP_IX_RET:
001CAE EAA7 DDE1            14      POP IX
001CB0 EAA9 C9              10      RET
                                
       EAAA                     DWT16:
001CB1 EAAA 0E00             7      LD  C,0
       EAAC                     DWT24:
001CB3 EAAC 0601             7      LD  B,1
       EAAE                     DWT24B:
001CB5 EAAE DDE5            15      PUSH    IX
001CB7 EAB0 DD2AA8EF        20      LD  IX,(_DPB)
001CBB EAB4 CDD0EC          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       EAB5                     DWTPAT  EQU $-2
001CBE EAB7 18EE            12      JR  POP_IX_RET
                                
       EAB9                     WTFAT:
001CC0 EAB9 CDD4EA          17      CALL    FATSETUP
001CC3 EABC D4AEEA          17      CALL    NC,DWT24B
001CC6 EABF D8              11      RET C
001CC7 EAC0 DDCB0F7E        20      BIT 7,(IX+DPB_BPS)
001CCB EAC4 C8              11      RET Z       ;予備FATが無い
001CCC EAC5 CDDBEA          17      CALL    FATS2
001CCF EAC8 E5              11      PUSH    HL      ;予備FAT
001CD0 EAC9 DD6E00          19      LD  L,(IX+DPB_FATLN)
001CD3 EACC DD6601          19      LD  H,(IX+DPB_FATLN+1)
001CD6 EACF 19              11      ADD HL,DE
001CD7 EAD0 EB               4      EX  DE,HL
001CD8 EAD1 E1              10      POP HL
001CD9 EAD2 18DA            12      JR  DWT24B
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ1024毎に2KBを切り替える
                                ;------------------------
       EAD4                     FATSETUP:
001CDB EAD4 3AAAEF          13      LD  A,(_FATDRV)
001CDE EAD7 CDD7EB          17      CALL    CHGDRVR     ;ドライブ切り替え
001CE1 EADA D8              11      RET C
       EADB                     FATS2:
001CE2 EADB DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001CE5 EADE 0F               4      RRCA
001CE6 EADF CD08EB          17      CALL    FATSETUP12  ;自己書き換え
       EAE0                     FATSX   EQU $-2
001CE9 EAE2 210000          10      LD  HL,0
001CEC EAE5 4A               4      LD  C,D
001CED EAE6 54               4      LD  D,H
001CEE EAE7 3AABEF          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
001CF1 EAEA 47               4      LD  B,A
001CF2 EAEB 04               4      INC B
001CF3 EAEC DD7E00          19      LD  A,(IX+DPB_FATLN)
       EAEF                     FAT_SKP:
001CF6 EAEF 05               4      DEC B
001CF7 EAF0 2805            12      JR  Z,FAT1
001CF9 EAF2 19              11      ADD HL,DE
001CFA EAF3 93               4      SUB E
001CFB EAF4 30F9            12      JR  NC,FAT_SKP
001CFD EAF6 C9              10      RET
       EAF7                     FAT1:
001CFE EAF7 EB               4      EX  DE,HL
001CFF EAF8 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001D00 EAF9 3801            12      JR  C,FAT2
001D02 EAFB 79               4      LD  A,C
       EAFC                     FAT2:
001D03 EAFC 47               4      LD  B,A
                                
001D04 EAFD 2AFAF0          16      LD  HL,(_FATPS) ;fat sector pos
001D07 EB00 19              11      ADD HL,DE
001D08 EB01 EB               4      EX  DE,HL
001D09 EB02 2A7CF0          16      LD  HL,(_FATBF)
001D0C EB05 AF               4      XOR A       ;CF=0
001D0D EB06 4F               4      LD  C,A
001D0E EB07 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       EB08                     FATSETUP12:
001D0F EB08 110606          10      LD  DE,0606H    ;256
001D12 EB0B D8              11      RET C
001D13 EB0C 110303          10      LD  DE,0303H    ;512
001D16 EB0F 0F               4      RRCA
001D17 EB10 D8              11      RET C
001D18 EB11 110102          10      LD  DE,0201H    ;1024
001D1B EB14 C9              10      RET
                                
       EB15                     FATSETUP16:
001D1C EB15 110808          10      LD  DE,0808H    ;256
001D1F EB18 D8              11      RET C
001D20 EB19 110404          10      LD  DE,0404H
001D23 EB1C 0F               4      RRCA            ;512
001D24 EB1D D8              11      RET C
001D25 EB1E 110202          10      LD  DE,0202H    ;1024
001D28 EB21 C9              10      RET
                                
       EB22                     CHGDRV:
001D29 EB22 E5              11      PUSH    HL
001D2A EB23 2189EF          10      LD  HL,_DSK
001D2D EB26 BE               7      CP  (HL)
001D2E EB27 280A            12      JR  Z,CHGDRVE
       EB29                     CHGDRV1:
001D30 EB29 DDE5            15      PUSH    IX
001D32 EB2B CD35EB          17      CALL    CHGDRV0
001D35 EB2E 3A89EF          13      LD  A,(_DSK)
001D38 EB31 DDE1            14      POP IX
       EB33                     CHGDRVE:
001D3A EB33 E1              10      POP HL
001D3B EB34 C9              10      RET
                                
       EB35                     CHGDRV0:
001D3C EB35 6F               4      LD  L,A
001D3D EB36 CDDCEF          17      CALL    _GETDPB
001D40 EB39 D8              11      RET C
001D41 EB3A DD22A8EF        20      LD  (_DPB),IX
001D45 EB3E 7D               4      LD  A,L
001D46 EB3F 3289EF          13      LD  (_DSK),A
       EB42                     CHGDRV2:
001D49 EB42 C5              11      PUSH    BC
001D4A EB43 D5              11      PUSH    DE
001D4B EB44 ED738DEB        20      LD  (SPPAT2),SP
001D4F EB48 F3               4      DI
001D50 EB49 DDF9            10      LD  SP,IX
                                
001D52 EB4B E1              10      POP HL      ;00:DPB_FATLN
001D53 EB4C E1              10      POP HL      ;02:DPB_DRD
001D54 EB4D 22A5EA          16      LD  (DRDPAT),HL
                                
001D57 EB50 E1              10      POP HL
001D58 EB51 22B5EA          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001D5B EB54 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001D5C EB55 7C               4      LD  A,H
001D5D EB56 32ACE1          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001D60 EB59 3D               4      DEC A
001D61 EB5A 3217E9          13      LD  (_NCPAT),A
                                
001D64 EB5D E1              10      POP HL      ;08:DPB_MAXCL
001D65 EB5E 7D               4      LD  A,L
001D66 EB5F 32CBE1          13      LD  (CLPAT2),A
001D69 EB62 7C               4      LD  A,H
001D6A EB63 32C7E1          13      LD  (CLPAT1),A
001D6D EB66 2B               6      DEC HL
001D6E EB67 22C8E3          16      LD  (MAXCLP),HL
                                
001D71 EB6A E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001D72 EB6B 4C               4      LD  C,H
                                
001D73 EB6C E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001D74 EB6D E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001D75 EB6E 7C               4      LD  A,H     ;DPB_BPS
001D76 EB6F E607             7      AND 7
001D78 EB71 32B1E6          13      LD  (SECSZ+2),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98
                                                ;1セクタ256 GRAM/RAMF/CMOS/等
                                                ;1024   512 256
                                                ;4  2   1
001D7B EB74 87               4      ADD A,A     ;8  4   2
001D7C EB75 87               4      ADD A,A     ;010H   8   4
001D7D EB76 87               4      ADD A,A     ;020H   010H    8
001D7E EB77 3229E0          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001D81 EB7A 2600             7      LD  H,0
001D83 EB7C 22FAF0          16      LD  (_FATPS),HL
                                
001D86 EB7F E1              10      POP HL      ;10:DPB_DIRPS
001D87 EB80 22FCF0          16      LD  (_DIRPS),HL
                                
001D8A EB83 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001D8B EB84 7C               4      LD  A,H
001D8C EB85 3284EF          13      LD  (_DRIVE),A
                                
001D8F EB88 E1              10      POP HL      ;14:DPB_ADDCL
001D90 EB89 22BCE1          16      LD  (CLSPAT),HL
                                
001D93 EB8C 310000          10      LD  SP,0        ;元のSPを復元
       EB8D                     SPPAT2  EQU $-2
001D96 EB8F FB               4      EI
001D97 EB90 2AFCF0          16      LD  HL,(_DIRPS)
001D9A EB93 0600             7      LD  B,0
001D9C EB95 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001D9D EB96 2244E0          16      LD  (MD_PAT),HL
                                
001DA0 EB99 2AC8E3          16      LD  HL,(MAXCLP);
001DA3 EB9C 11F60F          10      LD  DE,4086     ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001DA6 EB9F ED52            15      SBC HL,DE       ;CF=0のはず
001DA8 EBA1 300F            12      JR  NC,SETFAT16
001DAA EBA3 219DE8          10      LD  HL,GNCL     ;FAT12
001DAD EBA6 11C0E8          10      LD  DE,SNCL
001DB0 EBA9 0108EB          10      LD  BC,FATSETUP12
001DB3 EBAC DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001DB7 EBB0 180D            12      JR  EXTRA1
       EBB2                     SETFAT16:
001DB9 EBB2 21F4E8          10      LD  HL,GNCL16   ;FAT16
001DBC EBB5 1101E9          10      LD  DE,SNCL16
001DBF EBB8 0115EB          10      LD  BC,FATSETUP16
001DC2 EBBB DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       EBBF                     EXTRA1:
001DC6 EBBF 22F8EF          16      LD  (GNCPAT),HL
001DC9 EBC2 ED53FBEF        20      LD  (SNCPAT),DE
001DCD EBC6 ED43E0EA        20      LD  (FATSX),BC
001DD1 EBCA D1              10      POP DE
001DD2 EBCB C1              10      POP BC
001DD3 EBCC AF               4      XOR A
001DD4 EBCD C9              10      RET
                                
       EBCE                     GETDPBD:
001DD5 EBCE DDE3            23      EX  (SP),IX
001DD7 EBD0 DDE5            15      PUSH    IX
001DD9 EBD2 3A88EF          13      LD  A,(_DRV)
001DDC EBD5 1807            12      JR  GETDPB1
                                
       EBD7                     CHGDRVR:
001DDE EBD7 CDD9EF          17      CALL    _CHGDRV
001DE1 EBDA D8              11      RET C
001DE2 EBDB 3A89EF          13      LD  A,(_DSK)
       EBDE                     GETDPB1:
001DE5 EBDE C3DCEF          10      JP  _GETDPB
                                
       EBE1                     GETDPB:
001DE8 EBE1 FE08             7      CP  8
001DEA EBE3 3F               4      CCF
001DEB EBE4 D8              11      RET C
001DEC EBE5 0F               4      RRCA
001DED EBE6 0F               4      RRCA
001DEE EBE7 0F               4      RRCA
001DEF EBE8 DD                      DB  0DDH        ;Z80未定義命令
001DF0 EBE9 6F               4      LD  L,A     ;LD IXL,A
001DF1 EBEA DD                      DB  0DDH        ;Z80未定義命令
001DF2 EBEB 26F2             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001DF4 EBED DD7E00          19      LD  A,(IX+DPB_FATLN)
001DF7 EBF0 A7               4      AND A       ;CF=0の為
001DF8 EBF1 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001DFC EBF5 C0              11      RET NZ      ;FAT16
001DFD EBF6 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001E01 EBFA C0              11      RET NZ      ;BPB
001E02 EBFB FE01             7      CP  001H        ;A=0 THEN CF=1
001E04 EBFD C9              10      RET
                                
       EBFE                     _SYS5F:
001E05 EBFE AF               4      XOR A
       EBFF                     FFLUSH:
001E06 EBFF F5              11      PUSH    AF
001E07 EC00 CD25E8          17      CALL    WTFATX
001E0A EC03 AF               4      XOR A
001E0B EC04 32ABEF          13      LD  (_FATIX),A
001E0E EC07 2F               4      CPL         ;0FFH
001E0F EC08 32AAEF          13      LD  (_FATDRV),A
001E12 EC0B 3E                      DB  03EH        ;次のPUSH AFをスキップ
       EC0C                     FFLUSHBUF:
001E13 EC0C F5              11      PUSH    AF
001E14 EC0D CDDBE7          17      CALL    DWTX
001E17 EC10 3EFF             7      LD  A,0FFH
001E19 EC12 3239EF          13      LD  (SFILE),A
001E1C EC15 32A5EF          13      LD  (_DBDRV),A
001E1F EC18 F1              10      POP AF
001E20 EC19 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "88DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   PC-8801mkIISR
                                
                                ;   FLOPPY DISK DRIVER
                                ;
       EC1A                     PUTCOM_EXECUTE:
001E21 EC1A 3E0D             7      LD  A,0DH       ;エグゼキュート
                                ;   コマンド送信
       EC1C                     PUTCOM:
001E23 EC1C F5              11      PUSH    AF
001E24 EC1D 3E0F             7      LD  A,00FH
001E26 EC1F D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
001E28 EC21 F1              10      POP AF
                                ;   通常ハンドシェイク（ホストが送信）
       EC22                     PUTDAT:
001E29 EC22 F5              11      PUSH    AF
       EC23                     PUTDAT1:
001E2A EC23 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E2C EC25 E602             7      AND 2       ;RFD
001E2E EC27 28FA            12      JR  Z,PUTDAT1
001E30 EC29 3E0E             7      LD  A,00EH      ;ATN=0
001E32 EC2B D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
001E34 EC2D F1              10      POP AF
001E35 EC2E D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
001E37 EC30 F5              11      PUSH    AF
001E38 EC31 3E09             7      LD  A,9     ;DAV=1
001E3A EC33 D3FF            11      OUT (0FFH),A
       EC35                     PUTDAT2:
001E3C EC35 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E3E EC37 E604             7      AND 4       ;DAC
001E40 EC39 28FA            12      JR  Z,PUTDAT2
                                
001E42 EC3B 3E08             7      LD  A,8     ;DAV=0
001E44 EC3D D3FF            11      OUT (0FFH),A
       EC3F                     PUTDAT3:
001E46 EC3F DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E48 EC41 E604             7      AND 4       ;DAC
001E4A EC43 20FA            12      JR  NZ,PUTDAT3
001E4C EC45 F1              10      POP AF
001E4D EC46 C9              10      RET
                                
                                ;   通常ハンドシェイク（ホストが受信）
       EC47                     GETDAT:
001E4E EC47 3E0B             7      LD  A,00BH      ;RFD=1
001E50 EC49 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
       EC4B                     GETDAT1:
001E52 EC4B DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E54 EC4D 0F               4      RRCA            ;DAV
001E55 EC4E 30FB            12      JR  NC,GETDAT1
                                
001E57 EC50 3E0A             7      LD  A,00AH      ;RFD=0
001E59 EC52 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001E5B EC54 DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001E5D EC56 F5              11      PUSH    AF
001E5E EC57 3E0D             7      LD  A,00DH      ;DAC=1
001E60 EC59 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
       EC5B                     GETDAT2:
001E62 EC5B DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E64 EC5D 0F               4      RRCA            ;DAV
001E65 EC5E 38FB            12      JR  C,GETDAT2
                                
001E67 EC60 3E0C             7      LD  A,00CH      ;DAC=0
001E69 EC62 D3FF            11      OUT (0FFH),A
001E6B EC64 F1              10      POP AF
001E6C EC65 C9              10      RET
                                
                                ;   高速ハンドシェイク（ホストが送信）
                                ;   HL:アドレス BC:受信サイズ（必ず偶数にする）
       EC66                     FPUTDAT:
       EC66                     FPUTDAT1:
001E6D EC66 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E6F EC68 E602             7      AND 2       ;RFD
001E71 EC6A 28FA            12      JR  Z,FPUTDAT1
001E73 EC6C 3E0E             7      LD  A,00EH      ;ATN=0
001E75 EC6E D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001E77 EC70 7E               7      LD  A,(HL)
001E78 EC71 D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
                                
001E7A EC73 3E09             7      LD  A,9     ;DAV=1
001E7C EC75 D3FF            11      OUT (0FFH),A
001E7E EC77 23               6      INC HL
001E7F EC78 0B               6      DEC BC
       EC79                     FPUTDAT2:
001E80 EC79 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E82 EC7B E604             7      AND 4       ;DAC
001E84 EC7D 28FA            12      JR  Z,FPUTDAT2
                                
001E86 EC7F 7E               7      LD  A,(HL)
001E87 EC80 D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
                                
001E89 EC82 3E08             7      LD  A,8     ;DAV=0
001E8B EC84 D3FF            11      OUT (0FFH),A
       EC86                     FPUTDAT3:
001E8D EC86 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E8F EC88 E604             7      AND 4       ;DAC
001E91 EC8A 20FA            12      JR  NZ,FPUTDAT3
                                
001E93 EC8C EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001E95 EC8E E0              11      RET PO
001E96 EC8F 18D5            12      JR  FPUTDAT
                                
                                
                                ;   高速ハンドシェイク（ホストが受信）
                                ;   HL:アドレス BC:受信サイズ（必ず偶数にする）
       EC91                     FGETDAT:
001E98 EC91 3E0B             7      LD  A,00BH      ;RFD=1
001E9A EC93 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
       EC95                     FGETDAT1:
001E9C EC95 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E9E EC97 0F               4      RRCA            ;DAV
001E9F EC98 30FB            12      JR  NC,FGETDAT1
                                
001EA1 EC9A 3E0A             7      LD  A,00AH      ;RFD=0
001EA3 EC9C D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001EA5 EC9E DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001EA7 ECA0 77               7      LD  (HL),A
                                
001EA8 ECA1 3E0D             7      LD  A,00DH      ;DAC=1
001EAA ECA3 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
001EAC ECA5 23               6      INC HL
001EAD ECA6 0B               6      DEC BC
       ECA7                     FGETDAT2:
001EAE ECA7 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001EB0 ECA9 0F               4      RRCA            ;DAV
001EB1 ECAA 38FB            12      JR  C,FGETDAT2
                                
001EB3 ECAC DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001EB5 ECAE 77               7      LD  (HL),A
                                
001EB6 ECAF 3E0C             7      LD  A,00CH      ;DAC=0
001EB8 ECB1 D3FF            11      OUT (0FFH),A
                                
001EBA ECB3 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001EBC ECB5 E0              11      RET PO
001EBD ECB6 18D9            12      JR  FGETDAT
                                
                                ;   論理セクタ番号からトラック番号とセクタ番号を得る
                                ;   in
                                ;   DE:論理セクタ
       ECB8                     CALC_SECTOR:
001EBF ECB8 C5              11      PUSH    BC
001EC0 ECB9 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001EC3 ECBC 0610             7      LD  B,16
001EC5 ECBE AF               4      XOR A
001EC6 ECBF EB               4      EX  DE,HL
       ECC0                     DIV1:
001EC7 ECC0 29              11      ADD HL,HL
001EC8 ECC1 8F               4      ADC A,A
001EC9 ECC2 B9               4      CP  C
001ECA ECC3 3802            12      JR  C,DIV2
001ECC ECC5 91               4      SUB C
001ECD ECC6 2C               4      INC L
       ECC7                     DIV2:
001ECE ECC7 10F7            13      DJNZ    DIV1
                                
001ED0 ECC9 3C               4      INC A   ;最小のセクタは１固定
001ED1 ECCA 55               4      LD  D,L ;TRACK
       ECCB                     DIV3:
001ED2 ECCB 5F               4      LD  E,A ;SECTOR
001ED3 ECCC C1              10      POP BC
001ED4 ECCD C9              10      RET
                                
       ECCE                     WTTRK:
001ED5 ECCE 37               4      SCF
001ED6 ECCF C9              10      RET
       ECD0                     FDWT:
001ED7 ECD0 E5              11      PUSH    HL
001ED8 ECD1 D5              11      PUSH    DE
001ED9 ECD2 CDB8EC          17      CALL    CALC_SECTOR
001EDC ECD5 7A               4      LD  A,D     ;トラック
001EDD ECD6 3234ED          13      LD  (FDWT_TRACK),A
001EE0 ECD9 7B               4      LD  A,E     ;セクタ
001EE1 ECDA 322FED          13      LD  (FDWT_SECTOR),A
001EE4 ECDD DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001EE7 ECE0 93               4      SUB E
001EE8 ECE1 3C               4      INC A
001EE9 ECE2 67               4      LD  H,A
001EEA ECE3 D1              10      POP DE
001EEB ECE4 3AB1E6          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
001EEE ECE7 4F               4      LD  C,A
001EEF ECE8 AF               4      XOR A
       ECE9                     FDWT2:
001EF0 ECE9 81               4      ADD A,C
001EF1 ECEA 13               6      INC DE
001EF2 ECEB 05               4      DEC B
001EF3 ECEC 2807            12      JR  Z,FDWT3
001EF5 ECEE 25               4      DEC H       ;トラック、ヘッドを跨がない
001EF6 ECEF 2804            12      JR  Z,FDWT3
001EF8 ECF1 FE3A             7      CP  03AH        ;バッファとして04000H-07BFFHまで使える
001EFA ECF3 38F4            12      JR  C,FDWT2
       ECF5                     FDWT3:
001EFC ECF5 4F               4      LD  C,A
001EFD ECF6 E1              10      POP HL
001EFE ECF7 3E16             7      LD  A,16H       ;高速レシーブメモリ
001F00 ECF9 CD1CEC          17      CALL    PUTCOM
001F03 ECFC 3E40             7      LD  A,DSS_DATA/256  ;開始アドレスH
001F05 ECFE CD22EC          17      CALL    PUTDAT
001F08 ED01 AF               4      XOR A       ;開始アドレスL
001F09 ED02 CD22EC          17      CALL    PUTDAT
001F0C ED05 79               4      LD  A,C     ;バイト数H
001F0D ED06 CD22EC          17      CALL    PUTDAT
001F10 ED09 AF               4      XOR A       ;バイト数L
001F11 ED0A CD22EC          17      CALL    PUTDAT
001F14 ED0D C5              11      PUSH    BC
001F15 ED0E 41               4      LD  B,C
001F16 ED0F 0E00             7      LD  C,0
001F18 ED11 CD66EC          17      CALL    FPUTDAT
001F1B ED14 C1              10      POP BC
001F1C ED15 CD1AEC          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001F1F ED18 3E7C             7      LD  A,WRITEDISKEX/256
001F21 ED1A CD22EC          17      CALL    PUTDAT
001F24 ED1D 3EA3             7      LD  A,WRITEDISKEX%256
001F26 ED1F CD22EC          17      CALL    PUTDAT
001F29 ED22 DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
001F2C ED25 CD22EC          17      CALL    PUTDAT
001F2F ED28 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001F32 ED2B CD22EC          17      CALL    PUTDAT
       ED2F                     FDWT_SECTOR EQU $+1
001F35 ED2E 3E00             7      LD  A,0     ;セクタ
001F37 ED30 CD22EC          17      CALL    PUTDAT
001F3A ED33 3E00             7      LD  A,0     ;トラック
       ED34                     FDWT_TRACK  EQU $-1
001F3C ED35 CD22EC          17      CALL    PUTDAT
001F3F ED38 DD7E0A          19      LD  A,(IX+DPB_FDMODE)   ;フロッピーディスクのモード
001F42 ED3B CD22EC          17      CALL    PUTDAT
001F45 ED3E 3AB1E6          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
001F48 ED41 CD22EC          17      CALL    PUTDAT
001F4B ED44 79               4      LD  A,C
001F4C ED45 CD22EC          17      CALL    PUTDAT      ;バイト数H
001F4F ED48 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;フロッピーディスクのシリンダ数
001F52 ED4B CD22EC          17      CALL    PUTDAT
                                
001F55 ED4E CD1AEC          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001F58 ED51 3E7E             7      LD  A,RESULTEX/256
001F5A ED53 CD22EC          17      CALL    PUTDAT
001F5D ED56 3E13             7      LD  A,RESULTEX%256
001F5F ED58 CD22EC          17      CALL    PUTDAT
                                
001F62 ED5B CD47EC          17      CALL    GETDAT
001F65 ED5E 4F               4      LD  C,A
001F66 ED5F FE01             7      CP  1
001F68 ED61 D8              11      RET C
                                
001F69 ED62 78               4      LD  A,B
001F6A ED63 B7               4      OR  A
001F6B ED64 C2D0EC          10      JP  NZ,FDWT
001F6E ED67 C9              10      RET
                                
       ED68                     FDRD:
001F6F ED68 CD1AEC          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001F72 ED6B 3E7C             7      LD  A,READDISKEX/256
001F74 ED6D CD22EC          17      CALL    PUTDAT
001F77 ED70 AF               4      XOR A
001F78 ED71 CD22EC          17      CALL    PUTDAT
001F7B ED74 DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
001F7E ED77 CD22EC          17      CALL    PUTDAT
001F81 ED7A DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001F84 ED7D CD22EC          17      CALL    PUTDAT
001F87 ED80 E5              11      PUSH    HL
001F88 ED81 D5              11      PUSH    DE
001F89 ED82 CDB8EC          17      CALL    CALC_SECTOR
001F8C ED85 7B               4      LD  A,E     ;セクタ
001F8D ED86 CD22EC          17      CALL    PUTDAT
001F90 ED89 7A               4      LD  A,D     ;トラック
001F91 ED8A CD22EC          17      CALL    PUTDAT
001F94 ED8D DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001F97 ED90 93               4      SUB E
001F98 ED91 3C               4      INC A
001F99 ED92 67               4      LD  H,A
001F9A ED93 D1              10      POP DE
001F9B ED94 DD7E0A          19      LD  A,(IX+DPB_FDMODE)   ;フロッピーディスクのモード
001F9E ED97 CD22EC          17      CALL    PUTDAT
001FA1 ED9A 3AB1E6          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
001FA4 ED9D CD22EC          17      CALL    PUTDAT
001FA7 EDA0 4F               4      LD  C,A
001FA8 EDA1 AF               4      XOR A
       EDA2                     FDRD2:
001FA9 EDA2 81               4      ADD A,C
001FAA EDA3 13               6      INC DE
001FAB EDA4 05               4      DEC B
001FAC EDA5 2807            12      JR  Z,FDRD3
001FAE EDA7 25               4      DEC H       ;トラック、ヘッドを跨がない
001FAF EDA8 2804            12      JR  Z,FDRD3
001FB1 EDAA FE3A             7      CP  03AH        ;バッファとして04000H-07BFFHまで使える
001FB3 EDAC 38F4            12      JR  C,FDRD2
       EDAE                     FDRD3:
001FB5 EDAE E1              10      POP HL
001FB6 EDAF 4F               4      LD  C,A
001FB7 EDB0 CD22EC          17      CALL    PUTDAT      ;バイト数H
001FBA EDB3 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;フロッピーディスクのシリンダ数
001FBD EDB6 CD22EC          17      CALL    PUTDAT
                                
001FC0 EDB9 CD1AEC          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001FC3 EDBC 3E7E             7      LD  A,RESULTEX/256
001FC5 EDBE CD22EC          17      CALL    PUTDAT
001FC8 EDC1 3E13             7      LD  A,RESULTEX%256
001FCA EDC3 CD22EC          17      CALL    PUTDAT
                                
001FCD EDC6 CD47EC          17      CALL    GETDAT
001FD0 EDC9 4F               4      LD  C,A
001FD1 EDCA FE01             7      CP  1
001FD3 EDCC D8              11      RET C
                                
001FD4 EDCD 3E15             7      LD  A,15H       ;高速センドメモリ
001FD6 EDCF CD1CEC          17      CALL    PUTCOM
001FD9 EDD2 3E40             7      LD  A,DSS_DATA/256  ;開始アドレスH
001FDB EDD4 CD22EC          17      CALL    PUTDAT
001FDE EDD7 AF               4      XOR A       ;開始アドレスL
001FDF EDD8 CD22EC          17      CALL    PUTDAT
001FE2 EDDB 79               4      LD  A,C     ;バイト数H
001FE3 EDDC CD22EC          17      CALL    PUTDAT
001FE6 EDDF AF               4      XOR A       ;バイト数L
001FE7 EDE0 CD22EC          17      CALL    PUTDAT
001FEA EDE3 C5              11      PUSH    BC
001FEB EDE4 41               4      LD  B,C
001FEC EDE5 0E00             7      LD  C,0
001FEE EDE7 CD91EC          17      CALL    FGETDAT
001FF1 EDEA C1              10      POP BC
001FF2 EDEB 78               4      LD  A,B
001FF3 EDEC B7               4      OR  A
001FF4 EDED C268ED          10      JP  NZ,FDRD
001FF7 EDF0 C9              10      RET
                                
[EOF:88DISK.ASM:UTF_8]
                                    INCLUDE "88INTVEC.ASM"
                                
                                ;   LSX-Dodgers TABLE 割り込みベクタとキーのテーブル(Shift/Ctrl)
                                
       EDF1                     AT_TABLE:
001FF8 EDF1                         DS  INTAD-AT_TABLE
                                
                                ;
                                ;   割り込みベクタ:アドレス下位1バイトが0になるように
                                ;
       EE00                     IRXRDY:
002007 EE00 A0D9                    DW  INTE88
       EE02                     IVRTC:
002009 EE02 6AD9                    DW  INTVRTC
       EE04                     ICLOCK:
00200B EE04 A0D9                    DW  INTE88
       EE06                     IINT4:
00200D EE06 A0D9                    DW  INTE88
       EE08                     IINT3:
00200F EE08 A0D9                    DW  INTE88
       EE0A                     IINT2:
002011 EE0A A0D9                    DW  INTE88
       EE0C                     IFDINT1:
002013 EE0C A0D9                    DW  INTE88
       EE0E                     IFDINT2:
002015 EE0E A0D9                    DW  INTE88
                                
002017 EE10                         DS  030H-18
       EE2E                     EXTSP:
                                
       EE2E                     SHIFT_TABLE:
002035 EE2E 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
00203D EE36 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
002045 EE3E 4041424344454647        DB  '@','A','B','C','D','E','F','G' ;2
00204D EE46 48494A4B4C4D4E4F        DB  'H','I','J','K','L','M','N','O' ;3
002055 EE4E 5051525354555657        DB  'P','Q','R','S','T','U','V','W' ;4
00205D EE56 58595A7B7C7D7E3D        DB  'X','Y','Z','{','|','}','~','=' ;5
002065 EE5E 3021222324252627        DB  '0','!','"','#','$','%','&',27H ;6
00206D EE66 28292A2B3C3E3F5F        DB  '(',')','*','+','<','>','?','_' ;7
002075 EE6E 0B1E1C0800000000        DB  0BH,1EH,1CH,08H,00H,00H,00H,00H ;8
00207D EE76 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
002085 EE7E 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
00208D EE86 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
002095 EE8E 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
                                
       EE96                     CTRL_TABLE:
00209D EE96 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
0020A5 EE9E 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
0020AD EEA6 4001020304050607        DB  '@',01H,02H,03H,04H,05H,06H,07H ;2
0020B5 EEAE 08090A0B0C0D0E0F        DB  08H,09H,0AH,0BH,0CH,0DH,0EH,0FH ;3
0020BD EEB6 1011121314151617        DB  10H,11H,12H,13H,14H,15H,16H,17H ;4
0020C5 EEBE 18191A5B5C5D5E2D        DB  18H,19H,1AH,'[',5CH,']','^','-' ;5
0020CD EEC6 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;6
0020D5 EECE 38393A3B2C2E2F5F        DB  '8','9',':',';',',','.','/','_' ;7
0020DD EED6 0C1E1C0800000000        DB  0CH,1EH,1CH,08H,00H,00H,00H,00H ;8
0020E5 EEDE 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
0020ED EEE6 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
0020F5 EEEE 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
0020FD EEF6 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
[EOF:88INTVEC.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
       EEFE                     AT_WORK:
002105 EEFE                         DS  WORKAD-AT_WORK
                                
       EF00                     CPM_BOOT:
002107 EF00 C30000          10      JP  0
       EF03                     _SYS00:     ;(BDOS)プログラム終了
       EF03                     CPM_WBOOT:
00210A EF03 C309D2          10      JP  WBOOT1
       EF06                     CPM_CONST:
00210D EF06 C347DA          10      JP  CONSTX
       EF09                     _SYS07:     ;(BDOS)コンソール直接入力
       EF09                     CPM_CONIN:
002110 EF09 C3FFD9          10      JP  FLGET
       EF0C                     CPM_CONOUT:
002113 EF0C C381DC          10      JP  CONOUT1
                                
       EF0F                     DECBF:              ;10進数表示時のバッファ(5バイト)
002116 EF0F                         DS  5
       EF0F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       EF11                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
00211B EF14 00                  FDRV:   DB  0
00211C EF15                     FNAME:  DS  36
002140 EF39                     SFILE:  DS  33      ;DRV FILENAME
                                
002161 EF5A                         DS  3
                                
002164 EF5D 0000                LEFTX:  DW  0
002166 EF5F 0000                DTAX:   DW  0
                                
       EF61                     ZERO:
       EF61                     BEEPD:
002168 EF61 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
002170 EF69 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
       EF62                     RTC_YY  EQU BEEPD+1
       EF63                     RTC_MW  EQU BEEPD+2
       EF64                     RTC_DD  EQU BEEPD+3
       EF65                     RTC_TT  EQU BEEPD+4
       EF66                     RTC_MM  EQU BEEPD+5
       EF67                     RTC_SS  EQU BEEPD+6
       EF62                     ROM_SLT EQU BEEPD+1
                                
002177 EF70 00                  CHECK:  DB  0
                                
002178 EF71 4F4B24              OK: DB  "OK$"
00217B EF74                         DS  5
002180 EF79 4572726F722124      COMERM: DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
002187 EF80 FF                  _CYL0:  DB  0FFH    ;Cylinder
002188 EF81 FF                  _CYL1:  DB  0FFH    ;Cylinder
002189 EF82 FF                  _CYL2:  DB  0FFH    ;Cylinder
00218A EF83 FF                  _CYL3:  DB  0FFH    ;Cylinder
00218B EF84 00                  _DRIVE: DB  0   ;unit number
00218C EF85 00                  _SEEKSP:DB  0   ;Seek speed
00218D EF86 FF                  _ISEEK: DB  0FFH    ;
00218E EF87 00                  _DVSW:  DB  0
00218F EF88 00                  _DRV:   DB  0
002190 EF89 FF                  _DSK:   DB  0FFH
002191 EF8A 8000                _DTA:   DW  00080H
002193 EF8C 0000                _CTC:   DW  0
002195 EF8E 0000                _TXADR: DW  0
002197 EF90 0000                _KEYPS: DW  0
002199 EF92 00FF                _KEYD:  DW  0FF00H  ;キーデータ
00219B EF94 0010                _KEYSP: DB  KEYSP_L,KEYSP_H ;オートリピートの速度
00219D EF96 00                  _COLORF:DB  COLORF  ;色
00219E EF97 18                  _LINE:  DB  LINE
                                
00219F EF98 0000                _FCB:   DW  0   ;SEARCH FILES
0021A1 EF9A 0000                _FBPS:  DW  0   ;    //
0021A3 EF9C 0000                _FBAD:  DW  0   ;    //
0021A5 EF9E 00                  _FBCNT: DB  0   ;    //
0021A6 EF9F 00                  _FILEN: DB  0   ;    //
0021A7 EFA0 00                  _DIRF:  DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
0021A8 EFA1                         DS  1
0021A9 EFA2 00                  _WTFATF:DB  0   ;FATバッファの更新フラグ
0021AA EFA3                         DS  1
0021AB EFA4 00                  _WTDBF: DB  0   ;データバッファの更新フラグ
0021AC EFA5 FF                  _DBDRV: DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
0021AD EFA6 0000                _DBSEC: DW  0   ;データバッファにあるデータを読み込んだセクタ番号
0021AF EFA8 0000                _DPB:   DW  0
       EFAA                     _FATDRV:
0021B1 EFAA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
0021B2 EFAB 00                  _FATIX: DB  0   ;FATバッファに読み込んでいるインデックス
       EFAC                     _FAKEFREE:
0021B3 EFAC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
0021B5 EFAE                         DS  2
                                
       EFB0                     CRTCD:
0021B7 EFB0 6F                      DB  06FH
       EFB1                     _WIDTH:
0021B8 EFB1 50                      DB  WIDTH
       EFB2                     TVRAMTOP:
0021B9 EFB2 5938                    DB  059H,038H
0021BB EFB4 1F02                    DB  01FH,002H
       EFB6                     _LINE2:
0021BD EFB6 19                      DB  019H
       EFB7                     WKE4:
0021BE EFB7 1C                      DB  01CH
       EFB8                     WKE6:
0021BF EFB8 00                      DB  000H
       EFB9                     WK40:
0021C0 EFB9 07                      DB  007H
       EFBA                     _PAGE_MINUS:
0021C1 EFBA 80F8                    DW  0-WIDTH*LINE
       EFBC                     _WIDTH_MINUS:
0021C3 EFBC B0FF                    DW  0-WIDTH
       EFBE                     WK30:
0021C5 EFBE 0C                      DB  00CH
       EFBF                     WK31:
       EFBF                     WK1FD0:
0021C6 EFBF 20                      DB  020H
                                
0021C7 EFC0 0000                CTC0:   DW  INTCTCE
0021C9 EFC2 0000                CTC1:   DW  INTCTCE
0021CB EFC4 0000                CTC2:   DW  INTCTCE
0021CD EFC6 0000                CTC3:   DW  INTCTCE
0021CF EFC8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
0021D1 EFCA C3BADD          10  _INKEY: JP  INKEY
0021D4 EFCD C37DDB          10  _PRINT: JP  PRINT
0021D7 EFD0 C313DE          10  _SCRN:  JP  SCRN
0021DA EFD3 C35CDD          10  _POS:   JP  POS
0021DD EFD6 C3C5DB          10  _LOC:   JP  LOC
       EFD9                     _CHGDRV:
0021E0 EFD9 C322EB          10      JP  CHGDRV
       EFDC                     _GETDPB:
0021E3 EFDC C3E1EB          10      JP  GETDPB
       EFDF                     _FFLUSH:
0021E6 EFDF C3FFEB          10      JP  FFLUSH
       EFE2                     _RDFATX:
0021E9 EFE2 C3FBE7          10      JP  RDFATX
0021EC EFE5 C323E9          10  _RDFAT: JP  RDFAT
0021EF EFE8 C3CEEC          10  _WTTRK: JP  WTTRK
0021F2 EFEB C368ED          10  _FDRD:  JP  FDRD
0021F5 EFEE C3D0EC          10  _FDWT:  JP  FDWT
       EFF1                     _BPB2DPB:
0021F8 EFF1 C3B0E9          10      JP  BPB2DPB
       EFF4                     _BREAK:
0021FB EFF4 C3ADD3          10      JP  END_BATCH
       EFF7                     _GNCL:
0021FE EFF7 C39DE8          10      JP  GNCL        ; self-modifying code
       EFF8                     GNCPAT  EQU $-2
       EFFA                     _SNCL:
002201 EFFA C3C0E8          10      JP  SNCL        ; self-modifying code
       EFFB                     SNCPAT  EQU $-2
002204 EFFD C366D2          10  _COMANL:JP  COMANL
                                
       F000                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F000                     STABLE:
                                ;0
002207 F000 03EFD2D9DED956E0        DW  _SYS00,_SYS01,_SYS02,_SYS03
00220F F008 D0D6D0D6E3D909EF        DW  _SYS04,_SYS05,_SYS06,_SYS07
002217 F010 EBD9D2D613DA3FDA        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
00221F F018 E7D6ECD6FBD60CD7        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
002227 F020 60D7A7D7F0D721D8        DW  _SYS10,_SYS11,_SYS12,_SYS13
00222F F028 29D83FD854D84CD8        DW  _SYS14,_SYS15,_SYS16,_SYS17
002237 F030 9BD8A0D8A5D8ABD8        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
00223F F038 D0D6D1D8D0D6D5D8        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
002247 F040 D0D68BD893D8DCD8        DW  _SYS20,_SYS21,_SYS22,_SYS23
00224F F048 02D9D0D6CFE4A7E5        DW  _SYS24,_ERROR,_SYS26,_SYS27
002257 F050 93D80BD955DA56E0        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
00225F F058 7CDA56E0D0D62CD9        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
002267 F060 26D9D0D6D0D6D0D6        DW  _SYS30,_ERROR,_ERROR,_ERROR
00226F F068 D0D6D0D6D0D6D0D6        DW  _ERROR,_ERROR,_ERROR,_ERROR
002277 F070 D0D656E056E04DD9        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
00227F F078 B3D6                    DW  _DOS2
                                
002281 F07A                         DS  2
002283 F07C 00F3                _FATBF: DW  FATBF
002285 F07E 00FB                _DTBUF: DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F080                     CTRLTB:
002287 F080 C8DBC8DBFFDB07DD        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
00228F F088 01DD2ADCDADCA6DC        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002297 F090 CFDBF4DB0ADD56DC        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
00229F F098 D7DC49DC11DDC8DB        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
0022A7 F0A0 C8DBC8DB4EDCC8DB        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
0022AF F0A8 C8DBC8DBC8DBC8DB        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
0022B7 F0B0 C8DBC8DBD7DC5DDC        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
0022BF F0B8 B1DBD6DBEBDB0ADD        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
0022C7 F0C0 0200                M2D:    DW  2
0022C9 F0C2 FD02                    DB  0FDH,2
0022CB F0C4 6401                    DW  356
0022CD F0C6 FF0728090182            DB  0FFH,7,40,9,1,082H
0022D3 F0CC 0500A7000800            DW  5,0A7H,8
                                
0022D9 F0D2 0200                M2HD:   DW  2
0022DB F0D4 FE01                    DB  0FEH,1
0022DD F0D6 C704                    DW  1223
0022DF F0D8 FE064D080184            DB  0FEH,6,77,8,1,084H
0022E5 F0DE 0500A7000900            DW  5,0A7H,9
                                
0022EB F0E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
0022ED F0E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
0022EF F0E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
0022F1 F0EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F0EE                     SDDATAE:
                                
0022F5 F0EE                         DS  2
       F0F0                     _FCB_BAT:
0022F7 F0F0 61F1                    DW  FCB_BAT
       F0F2                     _PATH:
0022F9 F0F2 00F1                    DW  PATHD
                                
0022FB F0F4                     SCDIR:  DS  2       ;+14 +15
0022FD F0F6                     SFBPS:  DS  2       ;FBPS
0022FF F0F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
002301 F0FA 0000                _FATPS: DW  0
002303 F0FC 0000                _DIRPS: DW  0
002305 F0FE 0000                _CLPS:  DW  0
                                
       F100                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
002307 F100                     PATHD:  DS  PATHX
002342 F13B 00                  PATHE:  DB  0
                                
       F13C                     DTA_CCP:
002343 F13C                         DS  37
                                
       F161                     FCB_BAT:
002368 F161                         DS  37
                                
00238D F186 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
002398 F191 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "88TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE キーのテーブル
                                
       F198                     KEY_TABLE:
00239F F198 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
0023A7 F1A0 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
0023AF F1A8 4061626364656667        DB  '@','a','b','c','d','e','f','g' ;2
0023B7 F1B0 68696A6B6C6D6E6F        DB  'h','i','j','k','l','m','n','o' ;3
0023BF F1B8 7071727374757677        DB  'p','q','r','s','t','u','v','w' ;4
0023C7 F1C0 78797A5B5C5D5E2D        DB  'x','y','z','[',5CH,']','^','-' ;5
0023CF F1C8 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;6
0023D7 F1D0 38393A3B2C2E2F5C        DB  '8','9',':',';',',','.','/',5CH ;7
0023DF F1D8 0C1E1C0800000000        DB  0CH,1EH,1CH,08H,00H,00H,00H,00H ;8
0023E7 F1E0 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
0023EF F1E8 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
0023F7 F1F0 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
0023FF F1F8 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
[EOF:88TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "88DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   PC-8801mkIISR
                                
       F200                     _DEVICE:
                                
                                ;   A:
                                
002407 F200 0200                    DW  2   ;DPB_FATLN
002409 F202 EBEF                    DW  _FDRD   ;DPB_DRD
00240B F204 EEEF                    DW  _FDWT   ;DPB_DWT
00240D F206 FD                      DB  0FDH    ;DPB_FATID
00240E F207 02                      DB  2   ;DPB_SECPCL
00240F F208 6401                    DW  356 ;DPB_MAXCL
002411 F20A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002412 F20B 07                      DB  7   ;DPB_DIRSCNT
002413 F20C 28                      DB  40  ;DPB_MAXCYL
002414 F20D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002415 F20E 01                      DB  1   ;DPB_FATPS
002416 F20F 82                      DB  082H    ;DPB_BPS
002417 F210 0500                    DW  5   ;DPB_DIRPS
002419 F212 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00241A F213 00                      DB  0   ;DPB_UNITNO
00241B F214 0800                    DW  8   ;DPB_ADDCL
00241D F216 0000                    DW  0   ;DPB_16
00241F F218 0000                    DW  0   ;DPB_18
002421 F21A 0000                    DW  0   ;DPB_SDIR
002423 F21C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002427 F220 0200                    DW  2   ;DPB_FATLN
002429 F222 EBEF                    DW  _FDRD   ;DPB_DRD
00242B F224 EEEF                    DW  _FDWT   ;DPB_DWT
00242D F226 FD                      DB  0FDH    ;DPB_FATID
00242E F227 02                      DB  2   ;DPB_SECPCL
00242F F228 6401                    DW  356 ;DPB_MAXCL
002431 F22A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002432 F22B 07                      DB  7   ;DPB_DIRSCNT
002433 F22C 28                      DB  40  ;DPB_MAXCYL
002434 F22D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002435 F22E 01                      DB  1   ;DPB_FATPS
002436 F22F 82                      DB  082H    ;DPB_BPS
002437 F230 0500                    DW  5   ;DPB_DIRPS
002439 F232 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00243A F233 01                      DB  1   ;DPB_UNITNO
00243B F234 0800                    DW  8   ;DPB_ADDCL
00243D F236 0000                    DW  0   ;DPB_16
00243F F238 0000                    DW  0   ;DPB_18
002441 F23A 0000                    DW  0   ;DPB_SDIR
002443 F23C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002447 F240                         DS  32
                                
                                ;   D:
                                
002467 F260                         DS  32
                                
                                ;   E:
                                
002487 F280                         DS  32
                                
                                ;   F:
                                
0024A7 F2A0 0000                BANKFL: DW  0   ;DPB_FATLN
0024A9 F2A2 60D6                    DW  BDRD    ;DPB_DRD
0024AB F2A4 5CD6                    DW  BDWT    ;DPB_DWT
0024AD F2A6 F9                      DB  0F9H    ;DPB_FATID
0024AE F2A7 02                      DB  2   ;DPB_SECPCL
0024AF F2A8 0000                BANKCL: DW  0   ;DPB_MAXCL
0024B1 F2AA 00                      DB  0   ;DPB_FDMODE
0024B2 F2AB 08                      DB  8   ;DPB_DIRSCNT
0024B3 F2AC 00                      DB  0   ;DPB_MAXCYL
0024B4 F2AD 01                      DB  1   ;DPB_MAXSEC
0024B5 F2AE 00                      DB  0   ;DPB_FATPS
0024B6 F2AF 02                      DB  2   ;DPB_BPS
0024B7 F2B0 0200                    DW  2   ;DPB_DIRPS
0024B9 F2B2 0B                  BANKDV: DB  00BH    ;DPB_DEVICE
0024BA F2B3 00                      DB  0   ;DPB_UNITNO
0024BB F2B4 0600                    DW  6   ;DPB_ADDCL
0024BD F2B6 0000                    DW  0   ;DPB_16
0024BF F2B8 0000                    DW  0   ;DPB_18
0024C1 F2BA 0000                    DW  0   ;DPB_SDIR
0024C3 F2BC 454D454D                DB  "EMEM"  ;DPB_NAME
                                
                                ;   G:
                                
0024C7 F2C0                         DS  32
                                
                                ;   H:
0024E7 F2E0                         DS  32-8
0024FF F2F8 00                      DB  0
[EOF:88DPB.ASM:UTF_8]
                                
       F2F9                     LAST_ADR:
                                
                                    END
[EOF:88.ASM:UTF_8]
