                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   LSX-Dodgers for PC-8801mkIISR
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "88DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   PC-8001mkIISR
                                
       0002                     MAC EQU 2   ;PC-8001mkIISR
       0001                     DEV EQU 1
                                
       011D                     VER_6F  EQU 0011DH
                                
       CE00                     RUN EQU 0CE00H
       CDF9                     OFFSET  EQU RUN-7
                                
       D206                     BDOS    EQU 0D206H
       EE00                     INTAD   EQU 0EE00H
       EF00                     WORKAD  EQU 0EF00H
       F300                     FATBF   EQU 0F300H
       FB00                     DTBUF   EQU 0FB00H
       FF00                     KEYBF   EQU 0FF00H
       FF20                     KBUF    EQU 0FF20H
       FFBB                     SUBSYS  EQU EXTBIO-5*3
       FFD9                     TRAP38  EQU 0FFD9H
       0050                     WIDTH   EQU 80
       0018                     LINE    EQU 24
       0000                     COLORF  EQU 0
       0010                     KEYSP_H EQU 16
       0000                     KEYSP_L EQU 0
       0008                     COMS    EQU 8
                                
                                ; ディスクサブシステム
       002A                     MAIN        EQU 0002AH
                                
       4000                     DSS_DATA    EQU 04000H
                                
       7C00                     DSS     EQU 07C00H
[EOF:88DEF.ASM:SHIFT_JIS]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0005                     VER_2   EQU 5
       0008                     VER_3   EQU 8
       1D02                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0102                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0158                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 CDF9                         ORG OFFSET
                                
                                ;   MSX BINARY HEADER
000000 CDF9 FE                      DB  0FEH
                                ;   MSX BINARY START ADDRESS
000001 CDFA 00CE                    DW  RUN
                                ;   MSX BINARY END ADDRESS
000003 CDFC F9F2                    DW  LAST_ADR
                                ;   MSX BINARY EXEC ADDRESS
000005 CDFE 07CE                    DW  START
                                
                                    INCLUDE "88INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   PC-8801mkIISR
                                
000007 CE00 C307CE          10      JP  START
00000A CE03 021D                    DW  MACW
00000C CE05 5801                    DW  VER
                                
       CE07                     START:
00000E CE07 F3               4      DI
00000F CE08 ED5E             8      IM  2
000011 CE0A 3107CE          10      LD  SP,START
000014 CE0D CD1BCE          17      CALL    INIT        ;NZならAUTOEXECを実行
000017 CE10 210000          10      LD  HL,0
00001A CE13 E5              11      PUSH    HL
00001B CE14 C8              11      RET Z
00001C CE15 112ACF          10      LD  DE,AUTOD
00001F CE18 C3FDEF          10      JP  _COMANL
                                
       CE1B                     INIT:
000022 CE1B DB32            11      IN  A,(032H)
000024 CE1D CBA7             8      RES 4,A     ;高速RAMアクセスモード
000026 CE1F D332            11      OUT (032H),A
                                
000028 CE21 21C8F3          10      LD  HL,0F3C8H   ;テキストをクリア
00002B CE24 11E880          10      LD  DE,080E8H
00002E CE27 0E20             7      LD  C,' '
000030 CE29 3E19             7      LD  A,25
       CE2B                     TVCL1:
000032 CE2B 0650             7      LD  B,80
       CE2D                     TVCL2:
000034 CE2D 71               7      LD  (HL),C
000035 CE2E 23               6      INC HL
000036 CE2F 10FC            13      DJNZ    TVCL2
000038 CE31 0614             7      LD  B,20
       CE33                     TVCL3:
00003A CE33 72               7      LD  (HL),D
00003B CE34 2C               4      INC L
00003C CE35 73               7      LD  (HL),E
00003D CE36 23               6      INC HL
00003E CE37 10FA            13      DJNZ    TVCL3
000040 CE39 3D               4      DEC A
000041 CE3A 20EF            12      JR  NZ,TVCL1
                                
000043 CE3C DB32            11      IN  A,(032H)
000045 CE3E F610             7      OR  010H        ;高速RAMアクセスモードOFF
000047 CE40 D332            11      OUT (032H),A
                                
000049 CE42 AF               4      XOR A
00004A CE43 32B8EF          13      LD  (WKE6),A
00004D CE46 2F               4      CPL
00004E CE47 32B7EF          13      LD  (WKE4),A
                                
000051 CE4A CD38DE          17      CALL    INIT_CRTC
       CE4D                     BANK:
000054 CE4D DBE2            11      IN  A,(0E2H)
000056 CE4F 06E3             7      LD  B,0E3H      ;拡張RAM バンク選択
000058 CE51 21007F          10      LD  HL,07F00H
00005B CE54 F3               4      DI
00005C CE55 3E11             7      LD  A,011H
00005E CE57 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000060 CE59 ED69            12      OUT (C),L
000062 CE5B 3A0000          13      LD  A,(0)
000065 CE5E FEEB             7      CP  0EBH
000067 CE60 2005            12      JR  NZ,BANK1
000069 CE62 3E2B             7      LD  A,02BH
00006B CE64 32B2F2          13      LD  (BANKDV),A
       CE67                     BANK1:
00006E CE67 3E11             7      LD  A,011H
000070 CE69 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000072 CE6B ED69            12      OUT (C),L
000074 CE6D 5E               7      LD  E,(HL)
000075 CE6E 7B               4      LD  A,E
000076 CE6F C6A5             7      ADD A,0A5H
000078 CE71 77               7      LD  (HL),A
000079 CE72 BE               7      CP  (HL)
00007A CE73 73               7      LD  (HL),E
00007B CE74 2005            12      JR  NZ,BANK2
00007D CE76 2C               4      INC L
00007E CE77 CB65             8      BIT 4,L
000080 CE79 28EC            12      JR  Z,BANK1
       CE7B                     BANK2:
000082 CE7B AF               4      XOR A
000083 CE7C D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000085 CE7E 7D               4      LD  A,L
000086 CE7F B7               4      OR  A
000087 CE80 2813            12      JR  Z,NOBANK
000089 CE82 2600             7      LD  H,0
00008B CE84 29              11      ADD HL,HL   ;*2
00008C CE85 29              11      ADD HL,HL   ;*4
00008D CE86 29              11      ADD HL,HL   ;*8
00008E CE87 29              11      ADD HL,HL   ;*16
00008F CE88 29              11      ADD HL,HL   ;*32
000090 CE89 2B               6      DEC HL  ;-1
000091 CE8A 2B               6      DEC HL  ;-2
000092 CE8B 2B               6      DEC HL  ;-3
000093 CE8C 22A8F2          16      LD  (BANKCL),HL
000096 CE8F CD1ACF          17      CALL    CALC_FATLN
000099 CE92 32A0F2          13      LD  (BANKFL),A
       CE95                     NOBANK:
                                                ;初期化
00009C CE95 AF               4      XOR A       ;イニシャライズ
00009D CE96 CD29EC          17      CALL    PUTCOM
0000A0 CE99 3E16             7      LD  A,16H       ;高速レシーブメモリ
0000A2 CE9B CD29EC          17      CALL    PUTCOM
0000A5 CE9E 3E7C             7      LD  A,DSS/256   ;開始アドレスH
0000A7 CEA0 CD2FEC          17      CALL    PUTDAT
0000AA CEA3 AF               4      XOR A       ;開始アドレスL
0000AB CEA4 CD2FEC          17      CALL    PUTDAT
0000AE CEA7 015102          10      LD  BC,AT_DSSE-AT_DSS
0000B1 CEAA CB41             8      BIT 0,C
0000B3 CEAC 2801            12      JR  Z,SUBPG1
0000B5 CEAE 03               6      INC BC      ;偶数にする
       CEAF                     SUBPG1:
0000B6 CEAF 78               4      LD  A,B     ;バイト数H
0000B7 CEB0 CD2FEC          17      CALL    PUTDAT
0000BA CEB3 79               4      LD  A,C
0000BB CEB4 CD2FEC          17      CALL    PUTDAT
0000BE CEB7 21A7CF          10      LD  HL,AT_DSS
0000C1 CEBA CD73EC          17      CALL    FPUTDAT
                                
0000C4 CEBD 210000          10      LD  HL,0
0000C7 CEC0 065C             7      LD  B,05CH
0000C9 CEC2 3E                      DB  03EH    ;LD A,??
0000CA CEC3 FF              12      RST 38H
0000CB CEC4 CD68DF          17      CALL    FILL_MEMORY
0000CE CEC7 06A4             7      LD  B,0A4H
0000D0 CEC9 AF               4      XOR A
0000D1 CECA CD68DF          17      CALL    FILL_MEMORY
                                
0000D4 CECD 3EC3             7      LD  A,0C3H      ;JP
0000D6 CECF 2103EF          10      LD  HL,CPM_WBOOT
0000D9 CED2 320000          13      LD  (00000H),A
0000DC CED5 220100          16      LD  (00001H),HL ;IPL
                                
0000DF CED8 21021D          10      LD  HL,MACW     ;3 bit7  DPB Compatible LA(1)
0000E2 CEDB 220300          16      LD  (00003H),HL ;  bit6-0 Machine
                                ;               ;4 LSX-Dodgers(01DH)
0000E5 CEDE 2106D2          10      LD  HL,BDOS
0000E8 CEE1 320500          13      LD  (00005H),A
0000EB CEE4 220600          16      LD  (00006H),HL ;BDOS
                                
0000EE CEE7 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000F1 CEEA 323800          13      LD  (00038H),A
0000F4 CEED 223900          16      LD  (00039H),HL ;RST 038H
                                
0000F7 CEF0 3EEF             7      LD  A,CPM_BOOT/256
0000F9 CEF2 320B00          13      LD  (0000BH),A
                                
0000FC CEF5 3E                      DB  03EH    ;LD A,??
0000FD CEF6 E9               4      JP  (HL)
0000FE CEF7 320F00          13      LD  (0000FH),A
                                
000101 CEFA 2136CF          10      LD  HL,INIMES
000104 CEFD CDE2D6          17      CALL    MSX
       CF00                     INIT1:
000107 CF00 F3               4      DI
000108 CF01 1100FF          10      LD  DE,0FF00H
00010B CF04 06BB             7      LD  B,SUBSYS%256
00010D CF06 CD3FD5          17      CALL    ZERO_MEMORY_DE
                                
000110 CF09 2162CF          10      LD  HL,AT_SUBSYS
000113 CF0C 11BBFF          10      LD  DE,SUBSYS
000116 CF0F 014500          10      LD  BC,AT_TRAPE-AT_SUBSYS
000119 CF12 EDB0                    LDIR
                                
00011B CF14 CDD7DD          17      CALL    CHKEY
00011E CF17 FE03             7      CP  3
000120 CF19 C9              10      RET
                                
       CF1A                     CALC_FATLN: ;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
000121 CF1A 5D               4      LD  E,L
000122 CF1B 54               4      LD  D,H
000123 CF1C 29              11      ADD HL,HL   ;*2
000124 CF1D 19              11      ADD HL,DE   ;*3
000125 CF1E CB3C             8      SRL H   ;/2
000127 CF20 CB1D             8      RR  L   ;1クラスタ辺り1.5バイト必要
000129 CF22 11FF01          10      LD  DE,511  ;切り上げる
00012C CF25 19              11      ADD HL,DE
00012D CF26 7C               4      LD  A,H
00012E CF27 CB3F             8      SRL A
000130 CF29 C9              10      RET
                                
000131 CF2A 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
00013A CF33 413A00              AUTODV: DB  "A:",0
                                
00013D CF36 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for PC-8801mkIISR v"
            6765727320666F72    
            2050432D38383031    
            6D6B494953522076    
00015D CF56 312E                    DB  030H + VER_1, '.'
00015F CF58 3538                    DB  030H + VER_2 ,030H + VER_3
                                ;   DB  ""
000161 CF5A 2047616B750D0A          DB  ' Gaku',0DH,0AH
000168 CF61 00                      DB  0
                                
       CF62                     AT_SUBSYS:
000169 FFBB                         ORG SUBSYS,AT_SUBSYS-OFFSET
000169 FFBB C329EC          10      JP  PUTCOM
00016C FFBE C32FEC          10      JP  PUTDAT
00016F FFC1 C354EC          10      JP  GETDAT
000172 FFC4 C373EC          10      JP  FPUTDAT
000175 FFC7 C39FEC          10      JP  FGETDAT
                                ;EXTBIO
000178 FFCA C9              10      RET
000179 FFCB                         DS  14,0FFH
                                ;TRAP38:
000187 FFD9 210000          10      LD  HL,0
00018A FFDC E3              19      EX  (SP),HL
00018B FFDD 3E24             7      LD  A,'$'
00018D FFDF CDDBD9          17      CALL    MSG_A
000190 FFE2 2B               6      DEC HL
000191 FFE3 7C               4      LD  A,H
000192 FFE4 CDE8FF          17      CALL    PRHX
000195 FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
000196 FFE8 F5              11      PUSH    AF
000197 FFE9 07               4      RLCA
000198 FFEA 07               4      RLCA
000199 FFEB 07               4      RLCA
00019A FFEC 07               4      RLCA
00019B FFED CDF1FF          17      CALL    PRHX2
00019E FFF0 F1              10      POP AF
       FFF1                     PRHX2:
00019F FFF1 E60F             7      AND 00FH
0001A1 FFF3 FE0A             7      CP  10
0001A3 FFF5 3F               4      CCF
0001A4 FFF6 CE30             7      ADC A,'0'
0001A6 FFF8 27               4      DAA
0001A7 FFF9 C3DBD9          10      JP  MSG_A
0001AA FFFC                         DS  4
0001AE CFA7                         ORG $$+OFFSET   ;$DEPHASE
       CFA7                     AT_TRAPE:
[EOF:88INIT.ASM:SHIFT_JIS]
                                    INCLUDE "88SUB.ASM"
                                
                                ;   LSX-Dodgers SUB DISK SYSTEM
                                ;   PC-8801mkIISR
                                
       CFA7                     AT_DSS:
0001AE 7C00                         ORG DSS,AT_DSS-OFFSET
0001AE 7C00 C3437C          10      JP  READDISKEX
0001B1 7C03 C3A37C          10      JP  WRITEDISKEX
0001B4 7C06 C3BB7C          10      JP  GETPARAMS_N
0001B7 7C09 C3C67C          10      JP  SEEK
0001BA 7C0C C3547D          10      JP  FDCOMMAND
0001BD 7C0F C3207E          10      JP  CHECKRESULT
0001C0 7C12 C3427E          10      JP  GETDEVSTAT
0001C3 7C15 C3477E          10      JP  RDFDC
                                
0001C6 7C18                         DS  8*3
                                
       7C30                     S_PARAMS:
0001DE 7C30                         DS  16
       7C30                     S_UNITNO    EQU S_PARAMS    ;ユニット番号 0:ドライブA 1:ドライブB
       7C31                     S_DPS       EQU S_PARAMS+1  ;1トラックのセクタ数
       7C32                     S_SECTOR_R  EQU S_PARAMS+2  ;セクタ番号
       7C33                     S_TRACK     EQU S_PARAMS+3  ;トラック番号
       7C34                     S_FDMODE    EQU S_PARAMS+4  ;FDモード切り替え $FF:2D/2DD $FE:2HD
       7C35                     S_SECSIZE_N EQU S_PARAMS+5  ;N セクタサイズ
       7C36                     S_BYTE_H    EQU S_PARAMS+6  ;バイト数H
       7C37                     S_MAXCL     EQU S_PARAMS+7  ;シリンダ数
                                
       7C40                     S_CMD_STATUS:
0001EE 7C40 00                      DB  0
       7C41                     S_LEFT:
0001EF 7C41 00                      DB  0
       7C42                     S_WKF4:
0001F0 7C42 00                      DB  0
                                
       7C43                     READDISKEX:
0001F1 7C43 CDB97C          17      CALL    GETPARAMS
0001F4 7C46 AF               4      XOR A
0001F5 7C47 327A7C          13      LD  (RETRY_RDDISK),A
0001F8 7C4A 2A327C          16      LD  HL,(S_PARAMS+2)
0001FB 7C4D 7D               4      LD  A,L
0001FC 7C4E 3D               4      DEC A
0001FD 7C4F B4               4      OR  H
0001FE 7C50 200C            12      JR  NZ,RDDISK0
000200 7C52 2A357C          16      LD  HL,(S_PARAMS+5)
000203 7C55 7C               4      LD  A,H
000204 7C56 BD               4      CP  L
000205 7C57 2005            12      JR  NZ,RDDISK0
000207 7C59 3E03             7      LD  A,3
000209 7C5B 327A7C          13      LD  (RETRY_RDDISK),A
       7C5E                     RDDISK0:
00020C 7C5E CDC67C          17      CALL    SEEK
00020F 7C61 3E46             7      LD  A,46H       ;READ DATA
000211 7C63 CD547D          17      CALL    FDCOMMAND
000214 7C66 3834            12      JR  C,FINISH_DISK
000216 7C68 CD857D          17      CALL    RDDISK1
       7C6B                     WRDISK3:
000219 7C6B 78               4      LD  A,B
00021A 7C6C B2               4      OR  D
00021B 7C6D 32417C          13      LD  (S_LEFT),A
00021E 7C70 DBF8            11      IN  A,(0F8H)    ;FDC μPD765A TC入力
000220 7C72 FB               4      EI
000221 7C73 76               4      HALT
000222 7C74 CD207E          17      CALL    CHECKRESULT
000225 7C77 301D            12      JR  NC,FINISH_DISK0
       7C7A                     RETRY_RDDISK    EQU $+1
000227 7C79 3E00             7      LD  A,0
000229 7C7B B7               4      OR  A
00022A 7C7C 2818            12      JR  Z,FINISH_DISK0
00022C 7C7E 3D               4      DEC A
00022D 7C7F 327A7C          13      LD  (RETRY_RDDISK),A
000230 7C82 3A357C          13      LD  A,(S_PARAMS+5)
000233 7C85 FE04             7      CP  4
000235 7C87 3003            12      JR  NC,RETRY_RDDISK1
000237 7C89 87               4      ADD A,A
000238 7C8A 1802            12      JR  RETRY_RDDISK2
       7C8C                     RETRY_RDDISK1:
00023A 7C8C 3E01             7      LD  A,1
       7C8E                     RETRY_RDDISK2:
00023C 7C8E 67               4      LD  H,A
00023D 7C8F 6F               4      LD  L,A
00023E 7C90 22357C          16      LD  (S_PARAMS+5),HL
000241 7C93 C35E7C          10      JP  RDDISK0
       7C96                     FINISH_DISK0:
000244 7C96 3A417C          13      LD  A,(S_LEFT)
000247 7C99 D601             7      SUB 1
000249 7C9B 3F               4      CCF
       7C9C                     FINISH_DISK:
00024A 7C9C 9F               4      SBC A,A
00024B 7C9D 32407C          13      LD  (S_CMD_STATUS),A
00024E 7CA0 C32A00          10      JP  MAIN
                                
       7CA3                     WRITEDISKEX:
000251 7CA3 AF               4      XOR A
000252 7CA4 327A7C          13      LD  (RETRY_RDDISK),A
000255 7CA7 CDB97C          17      CALL    GETPARAMS
000258 7CAA CDC67C          17      CALL    SEEK
00025B 7CAD 3E45             7      LD  A,45H       ;WRITE DATA
00025D 7CAF CD547D          17      CALL    FDCOMMAND
000260 7CB2 38E8            12      JR  C,FINISH_DISK
000262 7CB4 CDCC7D          17      CALL    WRDISK1
000265 7CB7 18B2            12      JR  WRDISK3
                                
       7CB9                     GETPARAMS:
000267 7CB9 0608             7      LD  B,8
       7CBB                     GETPARAMS_N:
000269 7CBB E5              11      PUSH    HL
00026A 7CBC 21307C          10      LD  HL,S_PARAMS
       7CBF                     GETPARAMS1:
00026D 7CBF D7              12      RST 10H
00026E 7CC0 77               7      LD  (HL),A
00026F 7CC1 23               6      INC HL
000270 7CC2 10FB            13      DJNZ    GETPARAMS1
000272 7CC4 E1              10      POP HL
000273 7CC5 C9              10      RET
                                
       7CC6                     SEEK:
000274 7CC6 E5              11      PUSH    HL
000275 7CC7 3A347C          13      LD  A,(S_FDMODE)    ;FDモード切り替え $FF:2D/2DD $FE:2HD
000278 7CCA 1F               4      RRA
000279 7CCB 3F               4      CCF
00027A 7CCC 9F               4      SBC A,A
00027B 7CCD F5              11      PUSH    AF
00027C 7CCE E605             7      AND 5
00027E 7CD0 4F               4      LD  C,A
00027F 7CD1 3A377C          13      LD  A,(S_MAXCL) ;シリンダ数
000282 7CD4 C6D3             7      ADD A,0-45      ;オーバートラックを考慮して40+α
000284 7CD6 9F               4      SBC A,A
000285 7CD7 E604             7      AND 4
000287 7CD9 B1               4      OR  C
000288 7CDA 0EFA             7      LD  C,0FFH-5    ;マスク
00028A 7CDC 47               4      LD  B,A
00028B 7CDD 3A307C          13      LD  A,(S_UNITNO)    ;0:ドライブA 1:ドライブB
00028E 7CE0 B7               4      OR  A
00028F 7CE1 2804            12      JR  Z,SET_WKF4
000291 7CE3 CB20             8      SLA B
000293 7CE5 CB01             4      RLC C
       7CE7                     SET_WKF4:
000295 7CE7 3A427C          13      LD  A,(S_WKF4)
000298 7CEA A1               4      AND C
000299 7CEB B0               4      OR  B
00029A 7CEC 4F               4      LD  C,A
00029B 7CED D3F4            11      OUT (0F4H),A    ;ドライブ制御
00029D 7CEF E6DF             7      AND 0FFH-020H   ;CLKの分は抜いておく
00029F 7CF1 47               4      LD  B,A
0002A0 7CF2 F1              10      POP AF
0002A1 7CF3 E620             7      AND 020H        ;bit5:CLK
0002A3 7CF5 B0               4      OR  B
0002A4 7CF6 D3F4            11      OUT (0F4H),A    ;ドライブ制御
0002A6 7CF8 32427C          13      LD  (S_WKF4),A
0002A9 7CFB 47               4      LD  B,A
0002AA 7CFC A9               4      XOR C
0002AB 7CFD E620             7      AND 020H        ;CLKが変化したら一定時間待つ
0002AD 7CFF 2808            12      JR  Z,NOCHGCLK
0002AF 7D01 2160F0          10      LD  HL,0F060H
       7D04                     WAIT_CLK:
0002B2 7D04 2B               6      DEC HL
0002B3 7D05 7C               4      LD  A,H
0002B4 7D06 B5               4      OR  L
0002B5 7D07 20FB            12      JR  NZ,WAIT_CLK
       7D09                     NOCHGCLK:
0002B7 7D09 78               4      LD  A,B
0002B8 7D0A E620             7      AND 020H
0002BA 7D0C 2805            12      JR  Z,SPECIFY2D
0002BC 7D0E 1131DF          10      LD  DE,0DF31H   ;SPECIFY 2HD / SRT:13 HUT:15 HLT:24 NON-DMA
0002BF 7D11 1803            12      JR  SPECIFYOK
       7D13                     SPECIFY2D:
0002C1 7D13 1119DA          10      LD  DE,0DA19H   ;SPECIFY 2D/2DD / SRT:13 HUT 10 HLT:12 NON-DMA
       7D16                     SPECIFYOK:
0002C4 7D16 3E03             7      LD  A,3     ;SPECIFY
0002C6 7D18 E7              12      RST 20H
0002C7 7D19 7A               4      LD  A,D
0002C8 7D1A E7              12      RST 20H
0002C9 7D1B 7B               4      LD  A,E
0002CA 7D1C E7              12      RST 20H
       7D1D                     NOSPECIFY:
0002CB 7D1D ED4B307C        20      LD  BC,(S_PARAMS)
0002CF 7D21 ED5B327C        20      LD  DE,(S_PARAMS+2)
0002D3 7D25 7A               4      LD  A,D     ;TRACK
0002D4 7D26 CB3F             8      SRL A       ;CYLINDER
0002D6 7D28 3E0F             7      LD  A,00FH      ;SEEK
0002D8 7D2A 2002            12      JR  NZ,SEEK1    ;0シリンダの場合はRECALIBRATE、それ以外はSEEKを使う
0002DA 7D2C 3E07             7      LD  A,7     ;RECALIBRATE
       7D2E                     SEEK1:
0002DC 7D2E E7              12      RST 20H
0002DD 7D2F 79               4      LD  A,C     ;DR/HD
0002DE 7D30 E7              12      RST 20H
0002DF 7D31 7A               4      LD  A,D     ;TRACK
0002E0 7D32 CB3F             8      SRL A       ;CYLINDER
0002E2 7D34 C42000          17      CALL    NZ,20H      ;SEEKの場合だけ呼ぶ(0シリンダの場合はRECALIBRATEを使うのでシリンダの設定は不要)
0002E5 7D37 FB               4      EI
0002E6 7D38 76               4      HALT
0002E7 7D39 3E08             7      LD  A,8     ;SENSE
0002E9 7D3B E7              12      RST 20H
0002EA 7D3C CD477E          17      CALL    RDFDC       ;ST0
0002ED 7D3F CD477E          17      CALL    RDFDC       ;PCN(CYLINDER)
0002F0 7D42 210040          10      LD  HL,04000H
       7D45                     WAIT_SEEK:
0002F3 7D45 CD427E          17      CALL    GETDEVSTAT
0002F6 7D48 E608             7      AND 8
0002F8 7D4A 2006            12      JR  NZ,SEEK_OK
0002FA 7D4C 2B               6      DEC HL
0002FB 7D4D 7C               4      LD  A,H
0002FC 7D4E B5               4      OR  L
0002FD 7D4F 20F4            12      JR  NZ,WAIT_SEEK
0002FF 7D51 37               4      SCF
       7D52                     SEEK_OK:
000300 7D52 E1              10      POP HL
000301 7D53 C9              10      RET
                                
       7D54                     FDCOMMAND:
000302 7D54 E7              12      RST 20H
000303 7D55 7A               4      LD  A,D     ;HD US1 US0
000304 7D56 E601             7      AND 1
000306 7D58 87               4      ADD A,A
000307 7D59 87               4      ADD A,A
000308 7D5A B1               4      OR  C
000309 7D5B E7              12      RST 20H
00030A 7D5C 7A               4      LD  A,D     ;C
00030B 7D5D CB3F             8      SRL A
00030D 7D5F E7              12      RST 20H
00030E 7D60 7A               4      LD  A,D     ;H
00030F 7D61 E601             7      AND 1
000311 7D63 E7              12      RST 20H
000312 7D64 7B               4      LD  A,E     ;R
000313 7D65 E7              12      RST 20H
000314 7D66 3A357C          13      LD  A,(S_PARAMS+5)  ;N
000317 7D69 FE04             7      CP  4
000319 7D6B 3802            12      JR  C,FDCOMMAND2
                                
00031B 7D6D 3E03             7      LD  A,3
       7D6F                     FDCOMMAND2:
00031D 7D6F 1E20             7      LD  E,020H      ;NO SERVICE
00031F 7D71 E7              12      RST 20H
                                
000320 7D72 210040          10      LD  HL,DSS_DATA ;開始アドレス
000323 7D75 78               4      LD  A,B     ;EOT
000324 7D76 E7              12      RST 20H
                                
000325 7D77 01FB00          10      LD  BC,000FBH   ;B:バイト数L C:FDC μPD765A データレジスタ
000328 7D7A 3E54             7      LD  A,054H      ;GSL
00032A 7D7C E7              12      RST 20H
                                
00032B 7D7D 3A367C          13      LD  A,(S_BYTE_H)
00032E 7D80 57               4      LD  D,A     ;バイト数H
                                
00032F 7D81 AF               4      XOR A       ;DTL
000330 7D82 E7              12      RST 20H
000331 7D83 A7               4      AND A
000332 7D84 C9              10      RET
                                
       7D85                     RDDISK1:            ;高速化の為にループ展開x8
000333 7D85 FB               4      EI
000334 7D86 76               4      HALT
000335 7D87 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000337 7D89 A3               4      AND E       ;NO SERVICE
000338 7D8A C8              11      RET Z
000339 7D8B EDA2            16      INI
                                
00033B 7D8D FB               4      EI
00033C 7D8E 76               4      HALT
00033D 7D8F DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00033F 7D91 A3               4      AND E       ;NO SERVICE
000340 7D92 C8              11      RET Z
000341 7D93 EDA2            16      INI
                                
000343 7D95 FB               4      EI
000344 7D96 76               4      HALT
000345 7D97 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000347 7D99 A3               4      AND E       ;NO SERVICE
000348 7D9A C8              11      RET Z
000349 7D9B EDA2            16      INI
                                
00034B 7D9D FB               4      EI
00034C 7D9E 76               4      HALT
00034D 7D9F DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00034F 7DA1 A3               4      AND E       ;NO SERVICE
000350 7DA2 C8              11      RET Z
000351 7DA3 EDA2            16      INI
                                
000353 7DA5 FB               4      EI
000354 7DA6 76               4      HALT
000355 7DA7 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000357 7DA9 A3               4      AND E       ;NO SERVICE
000358 7DAA C8              11      RET Z
000359 7DAB EDA2            16      INI
                                
00035B 7DAD FB               4      EI
00035C 7DAE 76               4      HALT
00035D 7DAF DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00035F 7DB1 A3               4      AND E       ;NO SERVICE
000360 7DB2 C8              11      RET Z
000361 7DB3 EDA2            16      INI
                                
000363 7DB5 FB               4      EI
000364 7DB6 76               4      HALT
000365 7DB7 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000367 7DB9 A3               4      AND E       ;NO SERVICE
000368 7DBA C8              11      RET Z
000369 7DBB EDA2            16      INI
                                
00036B 7DBD FB               4      EI
00036C 7DBE 76               4      HALT
00036D 7DBF DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00036F 7DC1 A3               4      AND E       ;NO SERVICE
000370 7DC2 C8              11      RET Z
000371 7DC3 EDA2            16      INI
                                
000373 7DC5 20BE            12      JR  NZ,RDDISK1
000375 7DC7 15               4      DEC D
000376 7DC8 C2857D          10      JP  NZ,RDDISK1
000379 7DCB C9              10      RET
                                
       7DCC                     WRDISK1:            ;高速化の為にループ展開x8
00037A 7DCC FB               4      EI
00037B 7DCD 76               4      HALT
00037C 7DCE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00037E 7DD0 A3               4      AND E
00037F 7DD1 C8              11      RET Z
000380 7DD2 EDA3            16      OUTI
                                
000382 7DD4 FB               4      EI
000383 7DD5 76               4      HALT
000384 7DD6 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000386 7DD8 A3               4      AND E
000387 7DD9 C8              11      RET Z
000388 7DDA EDA3            16      OUTI
                                
00038A 7DDC FB               4      EI
00038B 7DDD 76               4      HALT
00038C 7DDE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00038E 7DE0 A3               4      AND E
00038F 7DE1 C8              11      RET Z
000390 7DE2 EDA3            16      OUTI
                                
000392 7DE4 FB               4      EI
000393 7DE5 76               4      HALT
000394 7DE6 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000396 7DE8 A3               4      AND E
000397 7DE9 C8              11      RET Z
000398 7DEA EDA3            16      OUTI
                                
00039A 7DEC FB               4      EI
00039B 7DED 76               4      HALT
00039C 7DEE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00039E 7DF0 A3               4      AND E
00039F 7DF1 C8              11      RET Z
0003A0 7DF2 EDA3            16      OUTI
                                
0003A2 7DF4 FB               4      EI
0003A3 7DF5 76               4      HALT
0003A4 7DF6 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003A6 7DF8 A3               4      AND E
0003A7 7DF9 C8              11      RET Z
0003A8 7DFA EDA3            16      OUTI
                                
0003AA 7DFC FB               4      EI
0003AB 7DFD 76               4      HALT
0003AC 7DFE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003AE 7E00 A3               4      AND E
0003AF 7E01 C8              11      RET Z
0003B0 7E02 EDA3            16      OUTI
                                
0003B2 7E04 FB               4      EI
0003B3 7E05 76               4      HALT
0003B4 7E06 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003B6 7E08 A3               4      AND E
0003B7 7E09 C8              11      RET Z
0003B8 7E0A EDA3            16      OUTI
                                
0003BA 7E0C 20BE            12      JR  NZ,WRDISK1
0003BC 7E0E 15               4      DEC D
0003BD 7E0F C2CC7D          10      JP  NZ,WRDISK1
0003C0 7E12 C9              10      RET
                                
       7E13                     RESULTEX:
0003C1 7E13 3A407C          13      LD  A,(S_CMD_STATUS)
0003C4 7E16 3C               4      INC A
0003C5 7E17 2803            12      JR  Z,RESULTEX1
0003C7 7E19 3A367C          13      LD  A,(S_BYTE_H)    ;バイト数H
       7E1C                     RESULTEX1:
0003CA 7E1C DF              12      RST 18H
0003CB 7E1D C32A00          10      JP  MAIN
                                
       7E20                     CHECKRESULT:
0003CE 7E20 C5              11      PUSH    BC
0003CF 7E21 CD477E          17      CALL    RDFDC       ;ST0
0003D2 7E24 E6D8             7      AND 0D8H
0003D4 7E26 4F               4      LD  C,A
0003D5 7E27 CD477E          17      CALL    RDFDC       ;ST1
0003D8 7E2A E6B7             7      AND 0B7H
0003DA 7E2C B1               4      OR  C
0003DB 7E2D 4F               4      LD  C,A
0003DC 7E2E CD477E          17      CALL    RDFDC       ;ST2
0003DF 7E31 E673             7      AND 073H
0003E1 7E33 B1               4      OR  C
0003E2 7E34 4F               4      LD  C,A
0003E3 7E35 0604             7      LD  B,4
       7E37                     CHECKRESULT1:           ;C H R N
0003E5 7E37 CD477E          17      CALL    RDFDC
0003E8 7E3A 10FB            13      DJNZ    CHECKRESULT1
0003EA 7E3C 79               4      LD  A,C
0003EB 7E3D A7               4      AND A
0003EC 7E3E C1              10      POP BC
0003ED 7E3F C8              11      RET Z
0003EE 7E40 37               4      SCF
0003EF 7E41 C9              10      RET
                                
       7E42                     GETDEVSTAT:
0003F0 7E42 3E04             7      LD  A,4
0003F2 7E44 E7              12      RST 20H
0003F3 7E45 79               4      LD  A,C
0003F4 7E46 E7              12      RST 20H
                                
       7E47                     RDFDC:
0003F5 7E47 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003F7 7E49 2F               4      CPL
0003F8 7E4A E6C0             7      AND 0C0H        ;RQMとDIOが両方1になるまで待つ
0003FA 7E4C 20F9            12      JR  NZ,RDFDC
0003FC 7E4E DBFB            11      IN  A,(0FBH)    ;FDC μPD765A データレジスタリード
0003FE 7E50 C9              10      RET
                                
0003FF D1F8                         ORG $$+OFFSET   ;$DEPHASE
       D1F8                     AT_DSSE:
       D1F8                     INITE:
0003FF D1F8                         DS  BDOS-INITE
00040D D206 C367D9          10      JP  BDOS_RF
[EOF:88SUB.ASM:SHIFT_JIS]
                                    INCLUDE "88CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   PC-8801mkIISR
                                
       D209                     WBOOT1:
000410 D209 ED7B0600        20      LD  SP,(SYSTEM+1)
000414 D20D DB32            11      IN  A,(032H)
000416 D20F F610             7      OR  10H     ;高速RAMアクセスモードOFF
000418 D211 D332            11      OUT (032H),A
                                
00041A D213 3EEE             7      LD  A,IVRTC/256
00041C D215 ED47             9      LD  I,A
00041E D217 3AB8EF          13      LD  A,(WKE6)
000421 D21A F602             7      OR  2       ;VRTC割り込みマスク
000423 D21C D3E6            11      OUT (0E6H),A    ;割り込みマスク
000425 D21E 32B8EF          13      LD  (WKE6),A
000428 D221 3AB7EF          13      LD  A,(WKE4)
00042B D224 D3E4            11      OUT (0E4H),A    ;割り込みレベル設定 
                                
00042D D226 FB               4      EI
00042E D227 2192EF          10      LD  HL,_KEYD
000431 D22A 3600            10      LD  (HL),0
000433 D22C CDD7DD          17      CALL    CHKEY
000436 D22F CDC8D9          17      CALL    KEYBC_IFBREAK
000439 D232 3E04             7      LD  A,4
00043B D234 CDDBD9          17      CALL    MSG_A
[EOF:88CCP.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D237                     COMMAND:
00043E D237 3A61F1          13      LD  A,(FCB_BAT)
000441 D23A B7               4      OR  A
000442 D23B C27CD3          10      JP  NZ,C_BAT1
000445 D23E CDF1D2          17      CALL    SETDTA1
000448 D241 3A87EF          13      LD  A,(_DVSW)
00044B D244 C641             7      ADD A,'A'
00044D D246 CDDBD9          17      CALL    MSG_A
000450 D249 3E3E             7      LD  A,'>'
000452 D24B CDDBD9          17      CALL    MSG_A
000455 D24E 3E50             7      LD  A,80
000457 D250 12               7      LD  (DE),A
000458 D251 CD19DA          17      CALL    _SYS0A      ;(BDOS)文字列入力
00045B D254 CD71D4          17      CALL    LTNL
       D257                     COMMAND2:
00045E D257 118200          10      LD  DE,DTA1+2
000461 D25A CDFDEF          17      CALL    _COMANL
000464 D25D 30D8            12      JR  NC,COMMAND
000466 D25F 1179EF          10      LD  DE,COMERM
000469 D262 CDD3D6          17      CALL    _SYS09      ;(BDOS)文字列出力
00046C D265 C7              12      RST 0
                                
       D266                     COMANL:
00046D D266 CDBCDE          17      CALL    FILE
000470 D269 3A19EF          13      LD  A,(FNAME+4)
000473 D26C FE20             7      CP  020H
000475 D26E 201C            12      JR  NZ,COMB2
000477 D270 D5              11      PUSH    DE
000478 D271 1115EF          10      LD  DE,FNAME
00047B D274 1A               7      LD  A,(DE)
00047C D275 FE20             7      CP  020H
00047E D277 2844            12      JR  Z,SDVSW
000480 D279 1B               6      DEC DE
000481 D27A 1A               7      LD  A,(DE)
000482 D27B C6FF             7      ADD A,0FFH
000484 D27D 3809            12      JR  C,COMB
000486 D27F 13               6      INC DE
                                
000487 D280 212BD6          10      LD  HL,COMTB
00048A D283 0608             7      LD  B,COMS
00048C D285 CD40E1          17      CALL    CPNAME
       D288                     COMB:
00048F D288 D1              10      POP DE
000490 D289 D20F00          10      JP  NC,JP_HL
       D28C                     COMB2:
000493 D28C EB               4      EX  DE,HL
000494 D28D 2259D3          16      LD  (COMPAT+1),HL
000497 D290 F5              11      PUSH    AF
000498 D291 CD11D3          17      CALL    CEXE4
00049B D294 F1              10      POP AF
00049C D295 2115EF          10      LD  HL,FNAME
00049F D298 116D00          10      LD  DE,FCB2+1   ;COMMAND NAME
0004A2 D29B 010B00          10      LD  BC,11
0004A5 D29E EDB0                    LDIR
0004A7 D2A0 1100F1          10      LD  DE,PATHD
       D2A3                     CEX1:
0004AA D2A3 1A               7      LD  A,(DE)
0004AB D2A4 FE20             7      CP  020H
0004AD D2A6 D8              11      RET C
0004AE D2A7 CDB1DE          17      CALL    FILEC
0004B1 D2AA D5              11      PUSH    DE
0004B2 D2AB 216D00          10      LD  HL,FCB2+1   ;COMMAND NAME
0004B5 D2AE 1115EF          10      LD  DE,FNAME
0004B8 D2B1 010B00          10      LD  BC,11
0004BB D2B4 EDB0                    LDIR
0004BD D2B6 CD11D3          17      CALL    CEXE4
0004C0 D2B9 D1              10      POP DE
0004C1 D2BA 13               6      INC DE
0004C2 D2BB 18E6            12      JR  CEX1
                                
       D2BD                     SDVSW:
0004C4 D2BD F1              10      POP AF
0004C5 D2BE 3A14EF          13      LD  A,(FDRV)
0004C8 D2C1 3D               4      DEC A
0004C9 D2C2 5F               4      LD  E,A
0004CA D2C3 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
0004CC D2C5 1831            12      JR  SYSTEM0
                                
       D2C7                     OPEN1:
0004CE D2C7 2114EF          10      LD  HL,FDRV
       D2CA                     OPEN:
0004D1 D2CA 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D2CC                     OPEN3:
0004D3 D2CC D5              11      PUSH    DE
0004D4 D2CD 113CF1          10      LD  DE,DTA_CCP
0004D7 D2D0 CDEED2          17      CALL    SETDTA
0004DA D2D3 EB               4      EX  DE,HL
0004DB D2D4 CDF8D2          17      CALL    SYSTEM0
0004DE D2D7 D1              10      POP DE
0004DF D2D8 C9              10      RET
                                
       D2D9                     OPEN2:
0004E0 D2D9 0E12             7      LD  C,012H
0004E2 D2DB 18EF            12      JR  OPEN3
                                
       D2DD                     DEFCB:              ;Z=Ok NZ=Error
0004E4 D2DD 113CF1          10      LD  DE,DTA_CCP
0004E7 D2E0 CDF6D2          17      CALL    SYSC0F
                                
0004EA D2E3 115DF1          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0004ED D2E6 0604             7      LD  B,4
0004EF D2E8 CD3FD5          17      CALL    ZERO_MEMORY_DE
       D2EB                     SETDTA100:
0004F2 D2EB 110001          10      LD  DE,00100H
       D2EE                     SETDTA:
0004F5 D2EE C3ABD8          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D2F1                     SETDTA1:
0004F8 D2F1 118000          10      LD  DE,DTA1
0004FB D2F4 18F8            12      JR  SETDTA
                                
       D2F6                     SYSC0F:
0004FD D2F6 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D2F8                     SYSTEM0:
0004FF D2F8 CD0500          17      CALL    SYSTEM
000502 D2FB B7               4      OR  A
000503 D2FC C9              10      RET
                                
       D2FD                     C_CD:
000504 D2FD 0E5A             7      LD  C,5AH
000506 D2FF 18F7            12      JR  SYSTEM0
                                
       D301                     S27BUF:
000508 D301 3A0700          13      LD  A,(SYSTEM+2)
00050B D304 3D               4      DEC A
00050C D305 E6F8             7      AND 0F8H
00050E D307 67               4      LD  H,A
00050F D308 2E00             7      LD  L,0
       D30A                     S27DTA:
000511 D30A 113CF1          10      LD  DE,DTA_CCP
       D30D                     S27:
000514 D30D 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
000516 D30F 18E7            12      JR  SYSTEM0
                                
       D311                     CEXE4:
000518 D311 211DEF          10      LD  HL,FNAME+8
00051B D314 7E               7      LD  A,(HL)
00051C D315 FE20             7      CP  020H
00051E D317 2007            12      JR  NZ,CEXE7
000520 D319 3E3F             7      LD  A,'?'
000522 D31B 77               7      LD  (HL),A
000523 D31C 23               6      INC HL
000524 D31D 77               7      LD  (HL),A
000525 D31E 23               6      INC HL
000526 D31F 77               7      LD  (HL),A
       D320                     CEXE7:
000527 D320 CDC7D2          17      CALL    OPEN1
       D323                     CEXE5:
00052A D323 C0              11      RET NZ
00052B D324 2A46F1          16      LD  HL,(DTA_CCP+1+9)
00052E D327 7C               4      LD  A,H
00052F D328 CDC8E1          17      CALL    CAP
000532 D32B 67               4      LD  H,A
000533 D32C 7D               4      LD  A,L
000534 D32D CDC8E1          17      CALL    CAP
000537 D330 6F               4      LD  L,A
000538 D331 3A45F1          13      LD  A,(DTA_CCP+1+8)
00053B D334 CDC8E1          17      CALL    CAP
00053E D337 D642             7      SUB 'B'
000540 D339 282C            12      JR  Z,C_BAT
000542 D33B 3D               4      DEC A       ;'C'
000543 D33C 2805            12      JR  Z,C_EXE
       D33E                     CEXE6:
000545 D33E CDD9D2          17      CALL    OPEN2
000548 D341 18E0            12      JR  CEXE5
                                
       D343                     C_EXE:
00054A D343 7C               4      LD  A,H
00054B D344 FE4D             7      CP  'M'
00054D D346 20F6            12      JR  NZ,CEXE6
                                
00054F D348 CDDDD2          17      CALL    DEFCB
000552 D34B CD01D3          17      CALL    S27BUF
000555 D34E 3D               4      DEC A
000556 D34F 37               4      SCF
000557 D350 C0              11      RET NZ
000558 D351 7C               4      LD  A,H
000559 D352 B5               4      OR  L
00055A D353 37               4      SCF
00055B D354 C8              11      RET Z
00055C D355 CDF1D2          17      CALL    SETDTA1
00055F D358 110000          10  COMPAT: LD  DE,0                ; self-modifying code
000562 D35B ED7B0600        20      LD  SP,(SYSTEM+1)
000566 D35F 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000567 D360 6F               4      LD  L,A
000568 D361 E5              11      PUSH    HL              ; push $0000 (reboot address)
000569 D362 24               4      INC H
00056A D363 E5              11      PUSH    HL              ; push $0100 (TPA address)
00056B D364 C30AD5          10      JP  SETFCB              ; and JP $0100
                                
       D367                     C_BAT:
00056E D367 114154          10      LD  DE,'A'+'T'*256
000571 D36A ED52            15      SBC HL,DE
000573 D36C 20D0            12      JR  NZ,CEXE6
                                
000575 D36E CDDDD2          17      CALL    DEFCB
                                
000578 D371 213CF1          10      LD  HL,DTA_CCP
00057B D374 1161F1          10      LD  DE,FCB_BAT
00057E D377 012500          10      LD  BC,37
000581 D37A EDB0                    LDIR
       D37C                     C_BAT1:
000583 D37C CDEBD2          17      CALL    SETDTA100
000586 D37F CDB3D3          17      CALL    FGETC_BAT
000589 D382 218100          10      LD  HL,DTA1+1
00058C D385 2025            12      JR  NZ,END_BATCH
00058E D387 FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
000590 D389 38F1            12      JR  C,C_BAT1
000592 D38B 3620            10      LD  (HL),' '
000594 D38D 23               6      INC HL
       D38E                     C_BAT2:
000595 D38E 77               7      LD  (HL),A
000596 D38F 23               6      INC HL
000597 D390 7D               4      LD  A,L
000598 D391 3C               4      INC A       ;L==0FFH
000599 D392 2809            12      JR  Z,RUN_BATCH
00059B D394 CDB3D3          17      CALL    FGETC_BAT
00059E D397 2004            12      JR  NZ,RUN_BATCH
0005A0 D399 FE20             7      CP  020H
0005A2 D39B 30F1            12      JR  NC,C_BAT2
       D39D                     RUN_BATCH:
0005A4 D39D 7D               4      LD  A,L
0005A5 D39E D67F             7      SUB DTA1-1
0005A7 D3A0 328000          13      LD  (DTA1),A
0005AA D3A3 FE04             7      CP  4
0005AC D3A5 3805            12      JR  C,END_BATCH
0005AE D3A7 3600            10      LD  (HL),0
0005B0 D3A9 C357D2          10      JP  COMMAND2
       D3AC                     END_BATCH:
0005B3 D3AC AF               4      XOR A       ;バッチファイルを閉じる
0005B4 D3AD 3261F1          13      LD  (FCB_BAT),A
0005B7 D3B0 C300EF          10      JP  CPM_BOOT
                                
       D3B3                     FGETC_BAT:
0005BA D3B3 1161F1          10      LD  DE,FCB_BAT
       D3B6                     FGETC:              ;1文字ずつ読み込む
0005BD D3B6 E5              11      PUSH    HL      ;Z:成功
0005BE D3B7 210100          10      LD  HL,1
0005C1 D3BA CD0DD3          17      CALL    S27
0005C4 D3BD E1              10      POP HL
0005C5 D3BE 3A0001          13      LD  A,(00100H)
0005C8 D3C1 C9              10      RET
                                
       D3C2                     C_DEL:
0005C9 D3C2 CD0AD5          17      CALL    SETFCB
0005CC D3C5 CDF1D9          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
0005CF D3C8 0E13             7      LD  C,013H
0005D1 D3CA 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D3CC                     C_REN:
0005D3 D3CC CD0AD5          17      CALL    SETFCB
0005D6 D3CF 3E10             7      LD  A,010H      ;ディレクトリも対象にする
0005D8 D3D1 326900          13      LD  (FCB1+13),A ;属性
0005DB D3D4 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D3D6                     CDEL1:
0005DD D3D6 115C00          10      LD  DE,FCB1
0005E0 D3D9 CD0500          17      CALL    SYSTEM
0005E3 D3DC C6FF             7      ADD A,0FFH
0005E5 D3DE C9              10      RET
                                
       D3DF                     C_DIR:
0005E6 D3DF CDB1DE          17      CALL    FILEC
0005E9 D3E2 2115EF          10      LD  HL,FDRV+1
0005EC D3E5 CD20D6          17      CALL    CWILD1
0005EF D3E8 3EF1             7      LD  A,0F1H
0005F1 D3EA 3221EF          13      LD  (FDRV+13),A
0005F4 D3ED CDC7D2          17      CALL    OPEN1
       D3F0                     CDIR1:
0005F7 D3F0 B7               4      OR  A
0005F8 D3F1 2008            12      JR  NZ,PDSKF
0005FA D3F3 CD3ED4          17      CALL    P_NAME
0005FD D3F6 CDD9D2          17      CALL    OPEN2
000600 D3F9 18F5            12      JR  CDIR1
       D3FB                     PDSKF:
000602 D3FB 3A14EF          13      LD  A,(FDRV)
000605 D3FE 5F               4      LD  E,A
000606 D3FF 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
000608 D401 CD0500          17      CALL    SYSTEM
00060B D404 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
00060C D405 C601             7      ADD A,001H
00060E D407 D8              11      RET C       ;Aが0FFHだった場合
00060F D408 3E06             7      LD  A,8-2
       D40A                     PDS1:               ;HL=未使用クラスタの総数
000611 D40A 3C               4      INC A
000612 D40B CB19             8      RR  C
000614 D40D 30FB            12      JR  NC,PDS1
       D40F                     PDS2:               ;B←論理セクタのサイズの上位8ビット
000616 D40F 3C               4      INC A
000617 D410 CB18             8      RR  B
000619 D412 30FB            12      JR  NC,PDS2
00061B D414 47               4      LD  B,A
                                
00061C D415 110000          10      LD  DE,0
       D418                     PDS3:
00061F D418 29              11      ADD HL,HL
000620 D419 EB               4      EX  DE,HL
000621 D41A ED6A            15      ADC HL,HL
000623 D41C EB               4      EX  DE,HL
000624 D41D 10F9            13      DJNZ    PDS3
       D41F                     PDSKF1:
000626 D41F CDA8D4          17      CALL    PRDEC_DEHL
000629 D422 1191F1          10      LD  DE,FREE
00062C D425 CDD3D6          17      CALL    _SYS09      ;(BDOS)文字列出力
00062F D428 CD98D4          17      CALL    PUTDRV
000632 D42B 3E5C             7      LD  A,05CH      ;\
000634 D42D CDDBD9          17      CALL    MSG_A
000637 D430 2A22EF          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
00063A D433 AF               4      XOR A
00063B D434 11FEFF          10      LD  DE,0-2
00063E D437 19              11      ADD HL,DE
00063F D438 23               6      INC HL
000640 D439 DCA5D4          17      CALL    C,PRDEC_HL
000643 D43C 1833            12      JR  LTNL
                                
       D43E                     P_NAME:
000645 D43E 3A3DF1          13      LD  A,(DTA_CCP+1)
000648 D441 FE2E             7      CP  '.'
00064A D443 C8              11      RET Z
                                
00064B D444 3A48F1          13      LD  A,(DTA_CCP+1+00BH)
00064E D447 F5              11      PUSH    AF
00064F D448 CB67             8      BIT 4,A
000651 D44A 2808            12      JR  Z,DIR3
000653 D44C 1186F1          10      LD  DE,DIRMES
000656 D44F CDD3D6          17      CALL    _SYS09      ;(BDOS)文字列出力
000659 D452 180A            12      JR  DIR6
       D454                     DIR3:
00065B D454 ED5B5BF1        20      LD  DE,(DTA_CCP+1+01EH)
00065F D458 2A59F1          16      LD  HL,(DTA_CCP+1+01CH)
000662 D45B CDA8D4          17      CALL    PRDEC_DEHL
       D45E                     DIR6:
000665 D45E F1              10      POP AF
000666 D45F 0F               4      RRCA
000667 D460 9F               4      SBC A,A
000668 D461 E60A             7      AND '*'-020H
00066A D463 C620             7      ADD A,020H
00066C D465 CDDBD9          17      CALL    MSG_A
00066F D468 CD98D4          17      CALL    PUTDRV
000672 D46B 213DF1          10      LD  HL,DTA_CCP+1
000675 D46E CDE8D4          17      CALL    FPRNT
                                
       D471                     LTNL:
000678 D471 1E03             7      LD  E,3
00067A D473 C3CDEF          10      JP  _PRINT
                                
       D476                     C_PATH:
00067D D476 CD93DF          17      CALL    SPCUT
000680 D479 2100F1          10      LD  HL,PATHD
000683 D47C FE21             7      CP  021H
000685 D47E 300C            12      JR  NC,CPATH0
       D480                     CPATHP:
000687 D480 7E               7      LD  A,(HL)
000688 D481 23               6      INC HL
000689 D482 FE20             7      CP  020H
00068B D484 3F               4      CCF
00068C D485 30EA            12      JR  NC,LTNL
00068E D487 CDDBD9          17      CALL    MSG_A
000691 D48A 18F4            12      JR  CPATHP
       D48C                     CPATH0:
000693 D48C FE3B             7      CP  ';'
000695 D48E 2001            12      JR  NZ,CPATH1
000697 D490 13               6      INC DE
       D491                     CPATH1:
000698 D491 EB               4      EX  DE,HL
000699 D492 013B00          10      LD  BC,PATHX
00069C D495 EDB0                    LDIR
00069E D497 C9              10      RET
                                
       D498                     PUTDRV:
00069F D498 3A14EF          13      LD  A,(FDRV)
0006A2 D49B C640             7      ADD A,'A'-1
0006A4 D49D CDDBD9          17      CALL    MSG_A
0006A7 D4A0 3E3A             7      LD  A,':'
       D4A2                     MSG_AR:
0006A9 D4A2 C3DBD9          10      JP  MSG_A
                                
       D4A5                     PRDEC_HL:
0006AC D4A5 AF               4      XOR A
0006AD D4A6 5F               4      LD  E,A
0006AE D4A7 57               4      LD  D,A
       D4A8                     PRDEC_DEHL:
0006AF D4A8 D5              11      PUSH    DE
0006B0 D4A9 110FEF          10      LD  DE,DECBF
0006B3 D4AC 0605             7      LD  B,5
0006B5 D4AE CD3FD5          17      CALL    ZERO_MEMORY_DE  ;A=0
0006B8 D4B1 D1              10      POP DE
                                
0006B9 D4B2 0E20             7      LD  C,32
       D4B4                     DEC1:
0006BB D4B4 29              11      ADD HL,HL
0006BC D4B5 EB               4      EX  DE,HL
0006BD D4B6 ED6A            15      ADC HL,HL
0006BF D4B8 EB               4      EX  DE,HL
0006C0 D4B9 E5              11      PUSH    HL
0006C1 D4BA 2113EF          10      LD  HL,DECBF+4
0006C4 D4BD 0605             7      LD  B,5
       D4BF                     DEC2:
0006C6 D4BF 7E               7      LD  A,(HL)
0006C7 D4C0 8F               4      ADC A,A
0006C8 D4C1 27               4      DAA
0006C9 D4C2 77               7      LD  (HL),A
0006CA D4C3 2B               6      DEC HL
0006CB D4C4 10F9            13      DJNZ    DEC2
0006CD D4C6 E1              10      POP HL
0006CE D4C7 0D               4      DEC C
0006CF D4C8 20EA            12      JR  NZ,DEC1
                                
0006D1 D4CA 210FEF          10      LD  HL,DECBF
0006D4 D4CD 3E20             7      LD  A,020H
0006D6 D4CF 0604             7      LD  B,4
       D4D1                     DEC3:
0006D8 D4D1 CDDED4          17      CALL    DEC4
0006DB D4D4 CDDED4          17      CALL    DEC4
0006DE D4D7 23               6      INC HL
0006DF D4D8 10F7            13      DJNZ    DEC3
       D4DA                     DECX:
0006E1 D4DA CDDED4          17      CALL    DEC4
0006E4 D4DD AF               4      XOR A
       D4DE                     DEC4:
0006E5 D4DE ED6F            18      RLD
0006E7 D4E0 FE20             7      CP  020H
0006E9 D4E2 2802            12      JR  Z,DEC5
0006EB D4E4 F630             7      OR  030H
       D4E6                     DEC5:
0006ED D4E6 18BA            12      JR  MSG_AR
                                
       D4E8                     FPRNT:
0006EF D4E8 0608             7      LD  B,8 ;ファイル名を表示
0006F1 D4EA CDF9D4          17      CALL    P_N1
0006F4 D4ED 7E               7      LD  A,(HL)
0006F5 D4EE CDD4E1          17      CALL    CAP3
0006F8 D4F1 D8              11      RET C   ;拡張子が無い
                                
0006F9 D4F2 3E2E             7      LD  A,'.'
0006FB D4F4 CDDBD9          17      CALL    MSG_A
0006FE D4F7 0603             7      LD  B,3 ;拡張子を表示
       D4F9                     P_N1:
000700 D4F9 7E               7      LD  A,(HL)
000701 D4FA CDD4E1          17      CALL    CAP3
000704 D4FD 3807            12      JR  C,P_N2
000706 D4FF CDDBD9          17      CALL    MSG_A
000709 D502 23               6      INC HL
00070A D503 10F4            13      DJNZ    P_N1
00070C D505 C9              10      RET
       D506                     P_N2:
00070D D506 23               6      INC HL
00070E D507 10FD            13      DJNZ    P_N2
000710 D509 C9              10      RET
                                
       D50A                     SETFCB:
000711 D50A CD93DF          17      CALL    SPCUT
000714 D50D 1A               7      LD  A,(DE)
000715 D50E FE20             7      CP  020H
000717 D510 3801            12      JR  C,SETFCBA
000719 D512 1B               6      DEC DE
       D513                     SETFCBA:
00071A D513 0624             7      LD  B,36
00071C D515 215C00          10      LD  HL,FCB1
00071F D518 E5              11      PUSH    HL
000720 D519 AF               4      XOR A
000721 D51A CD68DF          17      CALL    FILL_MEMORY
000724 D51D E1              10      POP HL
000725 D51E D5              11      PUSH    DE
000726 D51F CD11D9          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000729 D522 216C00          10      LD  HL,FCB2
00072C D525 CD11D9          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
00072F D528 E1              10      POP HL
000730 D529 010050          10      LD  BC,05000H
000733 D52C 118100          10      LD  DE,00081H
       D52F                     SETFCB1:
000736 D52F 7E               7      LD  A,(HL)
000737 D530 23               6      INC HL
000738 D531 FE20             7      CP  020H
00073A D533 3805            12      JR  C,SETFCB2
00073C D535 12               7      LD  (DE),A
00073D D536 13               6      INC DE
00073E D537 0C               4      INC C
00073F D538 10F5            13      DJNZ    SETFCB1
       D53A                     SETFCB2:
000741 D53A 79               4      LD  A,C
000742 D53B 328000          13      LD  (DTA1),A
000745 D53E 04               4      INC B
       D53F                     ZERO_MEMORY_DE:
000746 D53F AF               4      XOR A
       D540                     FILL_MEMORY_DE:
000747 D540 12               7      LD  (DE),A
000748 D541 13               6      INC DE
000749 D542 10FC            13      DJNZ    FILL_MEMORY_DE
00074B D544 C9              10      RET
                                
       D545                     C_COPY:
00074C D545 CD0AD5          17      CALL    SETFCB
                                
00074F D548 1161EF          10      LD  DE,ZERO
000752 D54B CDB4DE          17      CALL    FILEC2
000755 D54E 216C00          10      LD  HL,FCB2
000758 D551 CD18D9          17      CALL    S29X1
                                
00075B D554 3E10             7      LD  A,010H
00075D D556 326900          13      LD  (FCB1+13),A
000760 D559 216D00          10      LD  HL,FCB2+1
000763 D55C CD20D6          17      CALL    CWILD1
       D55F                     COPY0:
000766 D55F CD1DD6          17      CALL    CWILD
000769 D562 215C00          10      LD  HL,FCB1
00076C D565 CDCAD2          17      CALL    OPEN
00076F D568 37               4      SCF
       D569                     COPY1:
000770 D569 C0              11      RET NZ
000771 D56A CDDDD2          17      CALL    DEFCB
                                
000774 D56D 3A49F1          13      LD  A,(DTA_CCP+13)
000777 D570 CB67             8      BIT 4,A
000779 D572 2821            12      JR  Z,COPY1A
                                
00077B D574 215D00          10      LD  HL,FCB1+1
00077E D577 CDF2E2          17      CALL    CHKWILD
000781 D57A 3814            12      JR  C,COPY9
                                
000783 D57C 3E20             7      LD  A,020H
000785 D57E 325D00          13      LD  (FCB1+1),A
000788 D581 2A56F1          16      LD  HL,(DTA_CCP+26)
00078B D584 23               6      INC HL
00078C D585 226A00          16      LD  (FCB1+14),HL
00078F D588 18D5            12      JR  COPY0
                                
       D58A                     COPY8:
000791 D58A CDD3D6          17      CALL    _SYS09      ;(BDOS)文字列出力
000794 D58D CD71D4          17      CALL    LTNL
       D590                     COPY9:
000797 D590 CDD9D2          17      CALL    OPEN2
00079A D593 18D4            12      JR  COPY1
                                
       D595                     COPY1A:
00079C D595 216C00          10      LD  HL,FCB2
00079F D598 1114EF          10      LD  DE,FDRV
0007A2 D59B 013EF1          10      LD  BC,DTA_CCP+2
0007A5 D59E EDA0            16      LDI
0007A7 D5A0 3E0B             7      LD  A,11
       D5A2                     COPY2:
0007A9 D5A2 F5              11      PUSH    AF
0007AA D5A3 7E               7      LD  A,(HL)
0007AB D5A4 FE3F             7      CP  '?'
0007AD D5A6 2001            12      JR  NZ,COPY3
0007AF D5A8 0A               7      LD  A,(BC)
       D5A9                     COPY3:
0007B0 D5A9 12               7      LD  (DE),A
0007B1 D5AA 03               6      INC BC
0007B2 D5AB 13               6      INC DE
0007B3 D5AC 23               6      INC HL
0007B4 D5AD F1              10      POP AF
0007B5 D5AE 3D               4      DEC A
0007B6 D5AF 20F1            12      JR  NZ,COPY2
0007B8 D5B1 010500          10      LD  BC,16-11
0007BB D5B4 EDB0                    LDIR
       D5B6                     PUTNAME:
0007BD D5B6 215D00          10      LD  HL,FCB1+1
0007C0 D5B9 CDF2E2          17      CALL    CHKWILD
0007C3 D5BC 300B            12      JR  NC,PUTN1
0007C5 D5BE 2115EF          10      LD  HL,FDRV+1
0007C8 D5C1 CDE8D4          17      CALL    FPRNT
0007CB D5C4 3E20             7      LD  A,020H
0007CD D5C6 CDDBD9          17      CALL    MSG_A
       D5C9                     PUTN1:
0007D0 D5C9 1114EF          10      LD  DE,FDRV
0007D3 D5CC 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
0007D5 D5CE CDF8D2          17      CALL    SYSTEM0
0007D8 D5D1 2048            12      JR  NZ,COPYE2
0007DA D5D3 67               4      LD  H,A     ;A=0
0007DB D5D4 6F               4      LD  L,A
0007DC D5D5 2235EF          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0007DF D5D8 2237EF          16      LD  (FDRV+35),HL
       D5DB                     COPY6:
0007E2 D5DB CD01D3          17      CALL    S27BUF
0007E5 D5DE 47               4      LD  B,A
0007E6 D5DF 3C               4      INC A
0007E7 D5E0 2831            12      JR  Z,COPYE
0007E9 D5E2 7C               4      LD  A,H
0007EA D5E3 B5               4      OR  L
0007EB D5E4 280C            12      JR  Z,COPY7
0007ED D5E6 1114EF          10      LD  DE,FDRV
0007F0 D5E9 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0007F2 D5EB CDF8D2          17      CALL    SYSTEM0
0007F5 D5EE 2023            12      JR  NZ,COPYE
0007F7 D5F0 10E9            13      DJNZ    COPY6
       D5F2                     COPY7:
0007F9 D5F2 3A49F1          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0007FC D5F5 3221EF          13      LD  (FDRV+13),A
0007FF D5F8 2150F1          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
000802 D5FB 1128EF          10      LD  DE,FDRV+20
000805 D5FE 010400          10      LD  BC,4
000808 D601 EDB0                    LDIR
                                
00080A D603 1114EF          10      LD  DE,FDRV
00080D D606 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
00080F D608 CDF8D2          17      CALL    SYSTEM0
000812 D60B 2006            12      JR  NZ,COPYE
                                
000814 D60D 1171EF          10      LD  DE,OK
000817 D610 C38AD5          10      JP  COPY8
                                
       D613                     COPYE:
00081A D613 1114EF          10      LD  DE,FDRV
00081D D616 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
00081F D618 CD0500          17      CALL    SYSTEM
       D61B                     COPYE2:
000822 D61B 37               4      SCF
000823 D61C C9              10      RET
                                
       D61D                     CWILD:
000824 D61D 215D00          10      LD  HL,FCB1+1
       D620                     CWILD1:
000827 D620 7E               7      LD  A,(HL)
000828 D621 FE20             7      CP  020H
00082A D623 C0              11      RET NZ
       D624                     CWILD2:
00082B D624 3E3F             7      LD  A,'?'
00082D D626 060B             7      LD  B,11
00082F D628 C368DF          10      JP  FILL_MEMORY
                                
       D62B                     COMTB:
000832 D62B 44202020                DB  "D   "  ;1
000836 D62F DFD3                    DW  C_DIR
000838 D631 44495220                DB  "DIR "  ;2
00083C D635 DFD3                    DW  C_DIR
00083E D637 434F5059                DB  "COPY"  ;3
000842 D63B 45D5                    DW  C_COPY
000844 D63D 43442020                DB  "CD  "  ;4
000848 D641 FDD2                    DW  C_CD
00084A D643 44454C20                DB  "DEL "  ;5
00084E D647 C2D3                    DW  C_DEL
000850 D649 50415448                DB  "PATH"  ;6
000854 D64D 76D4                    DW  C_PATH
000856 D64F 52454E20                DB  "REN "  ;7
00085A D653 CCD3                    DW  C_REN
00085C D655 52454D20                DB  "REM "  ;8
000860 D659 D0D6                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "88DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   PC-8801mkIISR
                                
                                ;   BANK RAM DISK DRIVER
                                
       D65B                     BDWT:
000862 D65B 3E10             7      LD  A,010H  ;ライト可　リード不可
000864 D65D 1802            12  JR  BRW
                                
       D65F                     BDRD:
000866 D65F 3E01             7      LD  A,001H  ;ライト不可　リード可
       D661                     BRW:
000868 D661 F3               4      DI
000869 D662 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
00086B D664 ED739DD6        20      LD  (BANKSP+1),SP
00086F D668 3A9ED6          13      LD  A,(BANKSP+2)
000872 D66B 87               4      ADD A,A
000873 D66C 3803            12      JR  C,BRW1
000875 D66E 312EEE          10      LD  SP,EXTSP
       D671                     BRW1:
000878 D671 C5              11      PUSH    BC
000879 D672 D5              11      PUSH    DE
00087A D673 EB               4      EX  DE,HL
00087B D674 29              11      ADD HL,HL
00087C D675 29              11      ADD HL,HL
00087D D676 7C               4      LD  A,H
00087E D677 DD860C          19      ADD A,(IX+DPB_MAXCYL)
000881 D67A E60F             7      AND 00FH        ;バンク
000883 D67C D3E3            11      OUT (0E3H),A    ;拡張RAM バンク選択
000885 D67E 65               4      LD  H,L
000886 D67F CB3C             8      SRL H   ;/2
000888 D681 2E00             7      LD  L,0
00088A D683 DBE2            11      IN  A,(0E2H)    ;拡張RAM リード/ライト制御
00088C D685 0F               4      RRCA
00088D D686 3001            12      JR  NC,BRW2
00088F D688 EB               4      EX  DE,HL
       D689                     BRW2:
000890 D689 010002          10      LD  BC,512
000893 D68C EDB0                    LDIR
                                
000895 D68E DBE2            11      IN  A,(0E2H)    ;拡張RAM リード/ライト制御
000897 D690 0F               4      RRCA
000898 D691 3801            12      JR  C,BRW3
00089A D693 EB               4      EX  DE,HL
       D694                     BRW3:
00089B D694 D1              10      POP DE
00089C D695 C1              10      POP BC
00089D D696 13               6      INC DE
00089E D697 10D8            13      DJNZ    BRW1
                                
0008A0 D699 AF               4      XOR A
0008A1 D69A D3E2            11      OUT (0E2H),A    ;メインメモリに切り替える
0008A3 D69C 310000          10  BANKSP: LD  SP,0
0008A6 D69F FB               4      EI
0008A7 D6A0 C9              10      RET
                                
[EOF:88DISK2.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D6A1                     BDOS0:
0008A8 D6A1 E5              11      PUSH    HL
0008A9 D6A2 79               4      LD  A,C
0008AA D6A3 FE3C             7      CP  03CH
0008AC D6A5 3802            12      JR  C,DOS1
0008AE D6A7 3E3C             7      LD  A,03CH
       D6A9                     DOS1:
0008B0 D6A9 87               4      ADD A,A
0008B1 D6AA 6F               4      LD  L,A
0008B2 D6AB 26F0             7      LD  H,STABLE/256
0008B4 D6AD 7E               7      LD  A,(HL)
0008B5 D6AE 2C               4      INC L
0008B6 D6AF 66               7      LD  H,(HL)
0008B7 D6B0 6F               4      LD  L,A
0008B8 D6B1 E3              19      EX  (SP),HL
0008B9 D6B2 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
0008BA D6B3 C9              10      RET
       D6B4                     _DOS2:
0008BB D6B4 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
0008BD D6B6 CA53D9          10      JP  Z,_SYS5A
0008C0 D6B9 FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
0008C2 D6BB CA11D9          10      JP  Z,_SYS29
0008C5 D6BE FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
0008C7 D6C0 CA0BEC          10      JP  Z,_SYS5F
0008CA D6C3 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
0008CC D6C5 200A            12      JR  NZ,_ERROR
0008CE D6C7 011D01          10      LD  BC,VER_6F
0008D1 D6CA 115801          10      LD  DE,VER
0008D4 D6CD 210201          10      LD  HL,MACD
       D6D0                     C_REM:
0008D7 D6D0 AF               4      XOR A
       D6D1                     _ERROR:
0008D8 D6D1 A7               4      AND A
0008D9 D6D2 C9              10      RET
                                
       D6D3                     _SYS09:     ;文字列出力
0008DA D6D3 D5              11      PUSH    DE
       D6D4                     _SX09:
0008DB D6D4 1A               7      LD  A,(DE)
0008DC D6D5 13               6      INC DE
0008DD D6D6 FE24             7      CP  '$'
0008DF D6D8 2831            12      JR  Z,SX0E2
0008E1 D6DA CDDBD9          17      CALL    MSG_A
0008E4 D6DD 18F5            12      JR  _SX09
                                
       D6DF                     MSX1:
0008E6 D6DF CDDBD9          17      CALL    MSG_A
       D6E2                     MSX:
0008E9 D6E2 7E               7      LD  A,(HL)
0008EA D6E3 23               6      INC HL
0008EB D6E4 B7               4      OR  A
0008EC D6E5 20F8            12      JR  NZ,MSX1
0008EE D6E7 C9              10      RET
                                
       D6E8                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0008EF D6E8 212200          10      LD  HL,00022H
0008F2 D6EB 7D               4      LD  A,L
0008F3 D6EC C9              10      RET
                                
       D6ED                     _SYS0D:     ;(BDOS)ディスクリセット
0008F4 D6ED CDDFEF          17      CALL    _FFLUSH
0008F7 D6F0 E5              11      PUSH    HL
0008F8 D6F1 218000          10      LD  HL,00080H
0008FB D6F4 228AEF          16      LD  (_DTA),HL
0008FE D6F7 E1              10      POP HL
0008FF D6F8 D5              11      PUSH    DE
000900 D6F9 1E00             7      LD  E,0
000902 D6FB 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D6FC                     _SYS0E:     ;(BDOS)カレントドライブの設定
000903 D6FC D5              11      PUSH    DE
000904 D6FD 7B               4      LD  A,E
000905 D6FE DDE5            15      PUSH    IX
000907 D700 CDDCEF          17      CALL    _GETDPB
00090A D703 DDE1            14      POP IX
00090C D705 3804            12      JR  C,SX0E2
00090E D707 7B               4      LD  A,E
00090F D708 3287EF          13      LD  (_DVSW),A
       D70B                     SX0E2:
000912 D70B D1              10      POP DE
000913 D70C C9              10      RET
                                
       D70D                     _SYS0F:     ;(BDOS)ファイルのオープン
000914 D70D CDA5DF          17      CALL    SETDRV
000917 D710 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00091A D713 C602             7      ADD A,002H      ;Write
00091C D715 2848            12      JR  Z,FEND0F
00091E D717 CDEEE2          17      CALL    CHKWILDX
                                
000921 D71A D4C5DF          17      CALL    NC,SOPENX
       D71D                     _S16XX:
000924 D71D 3840            12      JR  C,FEND0F
                                                ;Directory location
000926 D71F 3A9FEF          13      LD  A,(_FILEN)
000929 D722 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
00092C D725 3AA0EF          13      LD  A,(_DIRF)
00092F D728 FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000932 D72B FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
000935 D72E FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
000938 D731 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
00093C D735 FDE5            15      PUSH    IY
00093E D737 D1              10      POP DE
00093F D738 13               6      INC DE
000940 D739 010B00          10      LD  BC,11
000943 D73C EDB0                    LDIR
                                ;               Attribute
000945 D73E 7E               7      LD  A,(HL)
000946 D73F FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
000949 D742 110B00          10      LD  DE,11       ;Reserved
00094C D745 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
00094D D746 11E4F0          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
000950 D749 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D74B                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000952 D74B 1A               7      LD  A,(DE)
000953 D74C 13               6      INC DE
000954 D74D 3254D7          13      LD  (S16PAT+2),A
000957 D750 7E               7      LD  A,(HL)
000958 D751 23               6      INC HL
000959 D752 FD7700          19  S16PAT: LD  (IY+0),A
00095C D755 10F4            13      DJNZ    S16LOOP
                                
00095E D757 AF               4      XOR A
00095F D758 FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000962 D75B FD2203D8        20      LD  (OFCB+1),IY
       D75F                     FEND0F:
000966 D75F 1845            12      JR  FEND10
                                
       D761                     _SYS10:     ;(BDOS)ファイルのクローズ
000968 D761 CDA5DF          17      CALL    SETDRV
00096B D764 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00096E D767 D6FE             7      SUB 0FEH
000970 D769 37               4      SCF
000971 D76A 3F               4      CCF
000972 D76B 2039            12      JR  NZ,FEND10
       D76D                     _S10A:              ;Write
000974 D76D FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000977 D770 FD770F          19      LD  (IY+15),A
                                
00097A D773 FD341C          23      INC (IY+28)     ;0FEH->0FFH ;オープンモード
00097D D776 CDEAE3          17      CALL    SETTMS
                                
000980 D779 FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000983 D77C 32A0EF          13      LD  (_DIRF),A
000986 D77F E67F             7      AND 07FH
000988 D781 3215E9          13      LD  (_SECPS),A
00098B D784 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
00098E D787 FD561F          19      LD  D,(IY+31)
000991 D78A CDF9E0          17      CALL    READ_DIR
000994 D78D 3817            12      JR  C,FEND10
                                
000996 D78F 3A23E0          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000999 D792 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
00099A D793 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
00099D D796 6F               4      LD  L,A
00099E D797 2600             7      LD  H,0
0009A0 D799 29              11      ADD HL,HL       ;*2
0009A1 D79A 29              11      ADD HL,HL       ;*4
0009A2 D79B 29              11      ADD HL,HL       ;*8
0009A3 D79C 29              11      ADD HL,HL       ;*16
0009A4 D79D 29              11      ADD HL,HL       ;*32
0009A5 D79E ED4B7EF0        20      LD  BC,(_DTBUF)
0009A9 D7A2 09              11      ADD HL,BC
                                
0009AA D7A3 CDFEE2          17      CALL    SDIRENT
       D7A6                     FEND10:
0009AD D7A6 1842            12      JR  FEND
                                
       D7A8                     _SYS11:     ;(BDOS)最初のファイルの検索
0009AF D7A8 CDA5DF          17      CALL    SETDRV
0009B2 D7AB CDF2DF          17      CALL    SOPEN
       D7AE                     _S12X1:
0009B5 D7AE 383A            12      JR  C,FEND
0009B7 D7B0 CD92E0          17      CALL    SOPENE2
0009BA D7B3 ED5B8AEF        20      LD  DE,(_DTA)
0009BE D7B7 3A88EF          13      LD  A,(_DRV)
0009C1 D7BA 3C               4      INC A
0009C2 D7BB 12               7      LD  (DE),A
0009C3 D7BC D5              11      PUSH    DE
0009C4 D7BD 13               6      INC DE
0009C5 D7BE 012000          10      LD  BC,32
0009C8 D7C1 EDB0                    LDIR
0009CA D7C3 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
0009CD D7C6 FD660F          19      LD  H,(IY+15)
0009D0 D7C9 22F4F0          16      LD  (SCDIR),HL
0009D3 D7CC 2A9AEF          16      LD  HL,(_FBPS)
0009D6 D7CF 22F6F0          16      LD  (SFBPS),HL
0009D9 D7D2 2A9FEF          16      LD  HL,(_FILEN)
0009DC D7D5 7C               4      LD  A,H
0009DD D7D6 B7               4      OR  A
0009DE D7D7 2806            12      JR  Z,_S12DIR
0009E0 D7D9 3A15E9          13      LD  A,(_SECPS)
0009E3 D7DC F680             7      OR  080H
0009E5 D7DE 67               4      LD  H,A
       D7DF                     _S12DIR:
0009E6 D7DF 22F8F0          16      LD  (SFNDF),HL  ;Directory position and Flags
0009E9 D7E2 E1              10      POP HL
0009EA D7E3 1139EF          10      LD  DE,SFILE
0009ED D7E6 0E21             7      LD  C,33
       D7E8                     _S11B:
0009EF D7E8 EDB0                    LDIR
       D7EA                     FEND:
0009F1 D7EA 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D7EB                     FENDE:
0009F2 D7EB FDE1            14      POP IY
0009F4 D7ED C1              10      POP BC
0009F5 D7EE D1              10      POP DE
0009F6 D7EF E1              10      POP HL
0009F7 D7F0 C9              10      RET
                                
       D7F1                     _SYS12:     ;(BDOS)次のファイルの検索
0009F8 D7F1 E5              11      PUSH    HL
0009F9 D7F2 D5              11      PUSH    DE
0009FA D7F3 C5              11      PUSH    BC
0009FB D7F4 FDE5            15      PUSH    IY
0009FD D7F6 CD56E0          17      CALL    NOPEN
000A00 D7F9 18B3            12      JR  _S12X1
                                
       D7FB                     _S16K:
000A02 D7FB FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000A05 D7FE FEFD             7      CP  0FDH        ;Device(0FDH)
000A07 D800 37               4      SCF
000A08 D801 C8              11      RET Z
                                
000A09 D802 110000          10  OFCB:   LD  DE,0
000A0C D805 D5              11      PUSH    DE
000A0D D806 061A             7      LD  B,26        ;First cluster
       D808                     S16K1:
000A0F D808 13               6      INC DE
000A10 D809 23               6      INC HL
000A11 D80A 10FC            13      DJNZ    S16K1
                                
000A13 D80C 1A               7      LD  A,(DE)
000A14 D80D BE               7      CP  (HL)
000A15 D80E 2013            12      JR  NZ,S16K2
000A17 D810 13               6      INC DE
000A18 D811 23               6      INC HL
000A19 D812 1A               7      LD  A,(DE)
000A1A D813 BE               7      CP  (HL)
000A1B D814 200D            12      JR  NZ,S16K2
                                
000A1D D816 E1              10      POP HL
000A1E D817 FDE5            15      PUSH    IY
000A20 D819 D1              10      POP DE
000A21 D81A 1A               7      LD  A,(DE)      ;Drive
000A22 D81B BE               7      CP  (HL)
000A23 D81C 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000A25 D81E ED52            15      SBC HL,DE       ;CP HL,DE
000A27 D820 37               4      SCF
000A28 D821 C0              11      RET NZ
000A29 D822 E5              11      PUSH    HL
       D823                     S16K2:
000A2A D823 E1              10      POP HL
       D824                     S16K3:
000A2B D824 FDE5            15      PUSH    IY
000A2D D826 D1              10      POP DE
       D827                     _SYS13:     ;(BDOS)ファイルの削除
000A2E D827 CDA5DF          17      CALL    SETDRV
000A31 D82A CD1EE2          17      CALL    KILL
       D82D                     FEND13:
000A34 D82D 18BB            12      JR  FEND
                                
       D82F                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000A36 D82F CDA5DF          17      CALL    SETDRV
000A39 D832 CD56E4          17      CALL    INIT_SEQ
       D835                     SREAD:
000A3C D835 CD9EE4          17      CALL    RB_READ
                                
000A3F D838 C601             7      ADD A,001H
000A41 D83A 38AE            12      JR  C,FEND
                                
000A43 D83C 7D               4      LD  A,L
000A44 D83D D601             7      SUB 001H
       D83F                     FENDX:
000A46 D83F 9F               4      SBC A,A
000A47 D840 E603             7      AND 3
000A49 D842 1F               4      RRA
000A4A D843 18A6            12      JR  FENDE
                                
       D845                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000A4C D845 CDA5DF          17      CALL    SETDRV
000A4F D848 CD56E4          17      CALL    INIT_SEQ
       D84B                     SWRITE:
000A52 D84B CD97E4          17      CALL    RB_WRITE
                                
000A55 D84E C6FF             7      ADD A,0FFH
000A57 D850 18ED            12      JR  FENDX
                                
       D852                     _SYS17:     ;(BDOS)ファイル名の変更
000A59 D852 CDA5DF          17      CALL    SETDRV
000A5C D855 CD74E2          17      CALL    NAME
000A5F D858 18D3            12      JR  FEND13
                                
       D85A                     _SYS16:     ;(BDOS)ファイルの作成
000A61 D85A CDA5DF          17      CALL    SETDRV
                                
000A64 D85D CDEEE2          17      CALL    CHKWILDX
000A67 D860 38CB            12      JR  C,FEND13
000A69 D862 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000A6C D865 FE05             7      CP  5
000A6E D867 2805            12      JR  Z,_S16X2
000A70 D869 FE21             7      CP  021H
000A72 D86B DA2DD8          10      JP  C,FEND13
       D86E                     _S16X2:
                                ;               Clear FCB
000A75 D86E FDE5            15      PUSH    IY
000A77 D870 E1              10      POP HL
000A78 D871 011000          10      LD  BC,16
000A7B D874 09              11      ADD HL,BC
       D875                     _S16X1:
000A7C D875 70               7      LD  (HL),B      ;B=0
000A7D D876 23               6      INC HL
000A7E D877 0D               4      DEC C
000A7F D878 20FB            12      JR  NZ,_S16X1
                                
000A81 D87A CDEFE3          17      CALL    SETTMSX
000A84 D87D FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000A88 D881 CDC5DF          17      CALL    SOPENX
000A8B D884 3F               4      CCF
000A8C D885 CCFBD7          17      CALL    Z,_S16K
000A8F D888 D4A3E0          17      CALL    NC,COPEN
000A92 D88B D4FEE2          17      CALL    NC,SDIRENT
000A95 D88E C31DD7          10      JP  _S16XX
                                
       D891                     _SYS21:     ;(BDOS)ランダムな読み出し
000A98 D891 CDA5DF          17      CALL    SETDRV
000A9B D894 CD3AE4          17      CALL    INIT_RND
000A9E D897 189C            12      JR  SREAD
                                
       D899                     _SYS22:     ;(BDOS)ランダムな書き込み
       D899                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000AA0 D899 CDA5DF          17      CALL    SETDRV
000AA3 D89C CD3AE4          17      CALL    INIT_RND
000AA6 D89F 18AA            12      JR  SWRITE
                                
       D8A1                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000AA8 D8A1 21FF00          10      LD  HL,000FFH
000AAB D8A4 AF               4      XOR A
000AAC D8A5 C9              10      RET
                                
       D8A6                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000AAD D8A6 3A87EF          13      LD  A,(_DVSW)
000AB0 D8A9 A7               4      AND A
000AB1 D8AA C9              10      RET
                                
       D8AB                     _SYS1A:     ;(BDOS)DTAの設定
000AB2 D8AB ED538AEF        20      LD  (_DTA),DE
000AB6 D8AF AF               4      XOR A
000AB7 D8B0 C9              10      RET
                                
       D8B1                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000AB8 D8B1 7B               4      LD  A,E
000AB9 D8B2 CDB8DF          17      CALL    GETDRV
000ABC D8B5 CDDCEF          17      CALL    _GETDPB
000ABF D8B8 D4E2EF          17      CALL    NC,_RDFATX
000AC2 D8BB 210000          10      LD  HL,0
000AC5 D8BE D4C8E3          17      CALL    NC,DSKF
                                
000AC8 D8C1 ED5BC9E3        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000ACC D8C5 1B               6      DEC DE      ;DE←クラスタの総数
000ACD D8C6 FD2A7CF0        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000AD1 D8CA 9F               4      SBC A,A
000AD2 D8CB D8              11      RET C
000AD3 D8CC 4F               4      LD  C,A     ;C=0
000AD4 D8CD DD7E0F          19      LD  A,(IX+DPB_BPS)
000AD7 D8D0 E607             7      AND 7
000AD9 D8D2 47               4      LD  B,A
000ADA D8D3 DD7E07          19      LD  A,(IX+DPB_SECPCL)
000ADD D8D6 C9              10      RET
                                
       D8D7                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000ADE D8D7 AF               4      XOR A
000ADF D8D8 67               4      LD  H,A
000AE0 D8D9 6F               4      LD  L,A
000AE1 D8DA C9              10      RET
                                
       D8DB                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000AE2 D8DB 2100F2          10      LD  HL,_DEVICE
000AE5 D8DE 7B               4      LD  A,E
000AE6 D8DF C3DCEF          10      JP  _GETDPB
                                
       D8E2                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000AE9 D8E2 E5              11      PUSH    HL
000AEA D8E3 2A1EF0          16      LD  HL,(STABLE+2*00FH)  ;ファイルのオープン
000AED D8E6 CD0F00          17      CALL    JP_HL
000AF0 D8E9 381B            12      JR  C,_S23X1
                                
000AF2 D8EB D5              11      PUSH    DE      ;EX DE,IY
000AF3 D8EC FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000AF5 D8EE FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000AF8 D8F1 FD6E11          19      LD  L,(IY+17)   ;
000AFB D8F4 FD6612          19      LD  H,(IY+18)   ;
000AFE D8F7 C5              11      PUSH    BC      ;
000AFF D8F8 FD4613          19      LD  B,(IY+19)   ;
000B02 D8FB CD2CE4          17      CALL    GET_CPM_R_SIZE
000B05 D8FE C1              10      POP BC
       D8FF                     _S24X1:
000B06 D8FF CD4CE4          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000B09 D902 FDE3            23      EX  (SP),IY     ;
000B0B D904 D1              10      POP DE      ;
                                
000B0C D905 AF               4      XOR A
       D906                     _S23X1:
000B0D D906 E1              10      POP HL
000B0E D907 C9              10      RET
                                
       D908                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000B0F D908 E5              11      PUSH    HL
000B10 D909 D5              11      PUSH    DE      ;EX DE,IY
000B11 D90A FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000B13 D90C CD5EE4          17      CALL    GETSEQ
000B16 D90F 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D911                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000B18 D911 C5              11      PUSH    BC
000B19 D912 E5              11      PUSH    HL
000B1A D913 CDBCDE          17      CALL    FILE
000B1D D916 E1              10      POP HL
000B1E D917 C1              10      POP BC
       D918                     S29X1:
000B1F D918 C5              11      PUSH    BC
000B20 D919 D5              11      PUSH    DE
000B21 D91A E5              11      PUSH    HL
000B22 D91B EB               4      EX  DE,HL
000B23 D91C AF               4      XOR A
000B24 D91D 3221EF          13      LD  (FDRV+13),A
000B27 D920 2114EF          10      LD  HL,FDRV
000B2A D923 011000          10      LD  BC,16
000B2D D926 EDB0                    LDIR
000B2F D928 E1              10      POP HL
000B30 D929 D1              10      POP DE
000B31 D92A C1              10      POP BC
000B32 D92B C9              10      RET
                                
       D92C                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000B33 D92C C5              11      PUSH    BC
000B34 D92D 01AFEA          10      LD  BC,DWT24B
000B37 D930 1804            12      JR  S2FX
       D932                     _SYS2F:
000B39 D932 C5              11      PUSH    BC
000B3A D933 019FEA          10      LD  BC,DRD24B
       D936                     S2FX:
000B3D D936 ED434CD9        20      LD  (S2FPAT+1),BC
000B41 D93A CDDFEF          17      CALL    _FFLUSH
                                
000B44 D93D D5              11      PUSH    DE
000B45 D93E E5              11      PUSH    HL
000B46 D93F 7D               4      LD  A,L     ;Drive
000B47 D940 CDD9EF          17      CALL    _CHGDRV
000B4A D943 3809            12      JR  C,S30X2
000B4C D945 44               4      LD  B,H     ;Number of clusters
000B4D D946 2A8AEF          16      LD  HL,(_DTA)
                                
000B50 D949 0E00             7      LD  C,0
000B52 D94B CD9FEA          17  S2FPAT: CALL    DRD24B
       D94E                     S30X2:
000B55 D94E E1              10      POP HL
000B56 D94F D1              10      POP DE
000B57 D950 C1              10      POP BC
000B58 D951 9F               4      SBC A,A
000B59 D952 C9              10      RET
                                
       D953                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000B5A D953 C5              11      PUSH    BC
000B5B D954 D5              11      PUSH    DE
000B5C D955 E5              11      PUSH    HL
000B5D D956 CDB1DE          17      CALL    FILEC
000B60 D959 210000          10      LD  HL,0
000B63 D95C 1114EF          10      LD  DE,FDRV
000B66 D95F 2A4EF0          16      LD  HL,(STABLE+2*027H)  ;ランダムブロック読み込み
000B69 D962 CD0F00          17      CALL    JP_HL
000B6C D965 18E7            12      JR  S30X2
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "88IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   PC-8801mkIISR
                                
       D6D1                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D6D1                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D6D1                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D6D1                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D6D1                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D6D1                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       D967                     BDOS_RF:
000B6E D967 DB32            11      IN  A,(032H)
000B70 D969 F610             7      OR  010H        ;高速RAMアクセスモードOFF
000B72 D96B D332            11      OUT (032H),A
000B74 D96D C3A1D6          10      JP  BDOS0
                                
       D970                     INTVRTC:
000B77 D970 F3               4      DI
000B78 D971 F5              11      PUSH    AF
000B79 D972 CDD7DD          17      CALL    CHKEY
000B7C D975 FE00             7      CP  0
       D976                     KEYDT   EQU $-1
000B7E D977 2028            12      JR  NZ,SETKEY1
000B80 D979 E5              11      PUSH    HL
000B81 D97A 2A90EF          16      LD  HL,(_KEYPS)
000B84 D97D 7C               4      LD  A,H
000B85 D97E AD               4      XOR L
000B86 D97F E1              10      POP HL
000B87 D980 2011            12      JR  NZ,ENDKEY
000B89 D982 3E00             7      LD  A,0
       D983                     KEYAR   EQU $-1
000B8B D984 B7               4      OR  A
000B8C D985 2014            12      JR  NZ,ARWKEY
       D987                     SETKEY:
000B8E D987 3283D9          13      LD  (KEYAR),A
000B91 D98A 3A92EF          13      LD  A,(_KEYD)
000B94 D98D 3276D9          13      LD  (KEYDT),A
000B97 D990 CDAED9          17      CALL    KEYSET
       D993                     ENDKEY:
000B9A D993 3AB7EF          13      LD  A,(WKE4)
000B9D D996 D3E4            11      OUT (0E4H),A
000B9F D998 F1              10      POP AF
000BA0 D999 FB               4      EI
000BA1 D99A C9              10      RET
       D99B                     ARWKEY:
000BA2 D99B 3D               4      DEC A
000BA3 D99C 3283D9          13      LD  (KEYAR),A
000BA6 D99F 18F2            12      JR  ENDKEY
       D9A1                     SETKEY1:
000BA8 D9A1 3A95EF          13      LD  A,(_KEYSP+1)
000BAB D9A4 18E1            12      JR  SETKEY
                                
       D9A6                     INTE88:
000BAD D9A6 F5              11      PUSH    AF
000BAE D9A7 3AB7EF          13      LD  A,(WKE4)
000BB1 D9AA D3E4            11      OUT (0E4H),A
000BB3 D9AC F1              10      POP AF
000BB4 D9AD C9              10      RET
       D9AE                     KEYSET:
       D9AE                     KEYBS:
000BB5 D9AE B7               4      OR  A
000BB6 D9AF C8              11      RET Z
       D9B0                     KEYBS1:
000BB7 D9B0 CDC8D9          17      CALL    KEYBC_IFBREAK
000BBA D9B3 E5              11      PUSH    HL
000BBB D9B4 F5              11      PUSH    AF
000BBC D9B5 2A90EF          16      LD  HL,(_KEYPS)
000BBF D9B8 2C               4      INC L
000BC0 D9B9 CBAD             8      RES 5,L
000BC2 D9BB 7D               4      LD  A,L
000BC3 D9BC BC               4      CP  H
000BC4 D9BD 2815            12      JR  Z,POP_AF_HL_SCF_RET
000BC6 D9BF 3290EF          13      LD  (_KEYPS),A
000BC9 D9C2 26FF             7      LD  H,KEYBF/256
000BCB D9C4 F1              10      POP AF
000BCC D9C5 77               7      LD  (HL),A
000BCD D9C6 E1              10      POP HL
000BCE D9C7 C9              10      RET
       D9C8                     KEYBC_IFBREAK:
000BCF D9C8 FE03             7      CP  3
000BD1 D9CA C0              11      RET NZ
       D9CB                     KEYBC:
000BD2 D9CB E5              11      PUSH    HL
000BD3 D9CC 210000          10      LD  HL,0
000BD6 D9CF 2290EF          16      LD  (_KEYPS),HL
000BD9 D9D2 E1              10      POP HL
000BDA D9D3 C9              10      RET
                                
       D9D4                     POP_AF_HL_SCF_RET:
000BDB D9D4 F1              10      POP AF
000BDC D9D5 E1              10      POP HL
000BDD D9D6 37               4      SCF
000BDE D9D7 C9              10      RET
                                
       D9D8                     _SYS01:     ;(BDOS)コンソール入力
000BDF D9D8 CD09EF          17      CALL    _SYS07
       D9DB                     MSG_A:
000BE2 D9DB F5              11      PUSH    AF
000BE3 D9DC D5              11      PUSH    DE
000BE4 D9DD 5F               4      LD  E,A
000BE5 D9DE CDE4D9          17      CALL    _SYS02
000BE8 D9E1 D1              10      POP DE
000BE9 D9E2 F1              10      POP AF
000BEA D9E3 C9              10      RET
                                
       D9E4                     _SYS02:     ;(BDOS)コンソール出力
000BEB D9E4 CDF6D9          17      CALL    BREAK
000BEE D9E7 1805            12      JR  PRINTX
                                
       D9E9                     _SYS06:     ;(BDOS)コンソール直接入出力
000BF0 D9E9 7B               4      LD  A,E
000BF1 D9EA 3C               4      INC A
000BF2 D9EB CACAEF          10      JP  Z,_INKEY
       D9EE                     PRINTX:
000BF5 D9EE C3CDEF          10      JP  _PRINT
                                
       D9F1                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000BF8 D9F1 CD09EF          17      CALL    _SYS07
000BFB D9F4 1804            12      JR  BREAK1
       D9F6                     BREAK:
000BFD D9F6 FB               4      EI
000BFE D9F7 3A92EF          13      LD  A,(_KEYD)
       D9FA                     BREAK1:
000C01 D9FA FE03             7      CP  3       ;CTRL+C
000C03 D9FC CA00EF          10      JP  Z,CPM_BOOT
000C06 D9FF FE13             7      CP  013H        ;CTRL+S
000C08 DA01 C0              11      RET NZ
                                
       DA02                     PAUSE:
000C09 DA02 CDCBD9          17      CALL    KEYBC
                                
       DA05                     FLGET:
000C0C DA05 CDDFEF          17      CALL    _FFLUSH
000C0F DA08 E5              11      PUSH    HL
000C10 DA09 2A8EEF          16      LD  HL,(_TXADR)
000C13 DA0C CD96DC          17      CALL    CURSOR_ON
       DA0F                     FLGET1:
000C16 DA0F CDCAEF          17      CALL    _INKEY
000C19 DA12 28FB            12      JR  Z,FLGET1
000C1B DA14 CDA7DC          17      CALL    CURSOR_OFF
000C1E DA17 E1              10      POP HL
000C1F DA18 C9              10      RET
                                
       DA19                     _SYS0A:     ;(BDOS)文字列入力
000C20 DA19 C5              11      PUSH    BC
000C21 DA1A E5              11      PUSH    HL
000C22 DA1B D5              11      PUSH    DE
000C23 DA1C CD66DD          17      CALL    GETL
000C26 DA1F 1120FF          10      LD  DE,KBUF
000C29 DA22 E1              10      POP HL
000C2A DA23 E5              11      PUSH    HL
000C2B DA24 0E00             7      LD  C,0
000C2D DA26 3004            12      JR  NC,SAX0
000C2F DA28 23               6      INC HL
000C30 DA29 23               6      INC HL
000C31 DA2A 1808            12      JR  SAX4
       DA2C                     SAX0:
000C33 DA2C 46               7      LD  B,(HL)
000C34 DA2D 23               6      INC HL
       DA2E                     SAX1:
000C35 DA2E 23               6      INC HL
000C36 DA2F 1A               7      LD  A,(DE)
000C37 DA30 13               6      INC DE
000C38 DA31 B7               4      OR  A
000C39 DA32 2004            12      JR  NZ,SAX2
       DA34                     SAX4:
000C3B DA34 360D            10      LD  (HL),00DH
000C3D DA36 1804            12      JR  SAX3
       DA38                     SAX2:
000C3F DA38 77               7      LD  (HL),A
000C40 DA39 0C               4      INC C
000C41 DA3A 10F2            13      DJNZ    SAX1
       DA3C                     SAX3:
000C43 DA3C D1              10      POP DE
000C44 DA3D 79               4      LD  A,C
000C45 DA3E 13               6      INC DE
000C46 DA3F 12               7      LD  (DE),A
000C47 DA40 1B               6      DEC DE
000C48 DA41 E1              10      POP HL
000C49 DA42 C1              10      POP BC
000C4A DA43 A7               4      AND A
000C4B DA44 C9              10      RET
                                
       DA45                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000C4C DA45 CDF6D9          17      CALL    BREAK
000C4F DA48 3A92EF          13      LD  A,(_KEYD)
000C52 DA4B B7               4      OR  A
000C53 DA4C C8              11      RET Z
       DA4D                     CONSTX:
000C54 DA4D CDDFEF          17      CALL    _FFLUSH
000C57 DA50 E5              11      PUSH    HL
000C58 DA51 2A90EF          16      LD  HL,(_KEYPS)
000C5B DA54 7C               4      LD  A,H
000C5C DA55 AD               4      XOR L
000C5D DA56 E1              10      POP HL
000C5E DA57 C6FF             7      ADD A,0FFH
000C60 DA59 9F               4      SBC A,A
000C61 DA5A C9              10      RET
                                
       DA5B                     _SYS2A:     ;(BDOS)日付の獲得
000C62 DA5B C5              11      PUSH    BC
000C63 DA5C CD9BDA          17      CALL    RTCREAD
000C66 DA5F 3A62EF          13      LD  A,(RTC_YY)
000C69 DA62 CDFEDA          17      CALL    BCD
000C6C DA65 6F               4      LD  L,A
000C6D DA66 2600             7      LD  H,0
                                ;   LD  DE,1900     ;0076CH
                                ;   CP  90      ;90以上は1900年代 1990-1999
                                ;   JR  NC,RDDATE1  ;90未満は2000年代 2000-2089
                                ;   LD  E,0D0H      ;2000 & 0FFH D=007H
000C6F DA68 11D007          10      LD  DE,2000     ;すべて2000年代で処理 2000-2099
       DA6B                     RDDATE1:
000C72 DA6B 19              11      ADD HL,DE
000C73 DA6C 3A63EF          13      LD  A,(RTC_MW)
000C76 DA6F 57               4      LD  D,A
000C77 DA70 3A64EF          13      LD  A,(RTC_DD)
000C7A DA73 CDFEDA          17      CALL    BCD
000C7D DA76 5F               4      LD  E,A
000C7E DA77 7A               4      LD  A,D
000C7F DA78 0604             7      LD  B,4
       DA7A                     RDDATE2:
000C81 DA7A CB3A             8      SRL D
000C83 DA7C 10FC            13      DJNZ    RDDATE2
000C85 DA7E C1              10      POP BC
000C86 DA7F E607             7      AND 7
000C88 DA81 C9              10      RET
                                
       DA82                     _SYS2C:     ;(BDOS)時刻の獲得
000C89 DA82 C5              11      PUSH    BC
000C8A DA83 CD9BDA          17      CALL    RTCREAD
000C8D DA86 3A65EF          13      LD  A,(RTC_TT)
000C90 DA89 CDFEDA          17      CALL    BCD
000C93 DA8C 67               4      LD  H,A
000C94 DA8D 3A66EF          13      LD  A,(RTC_MM)
000C97 DA90 CDFEDA          17      CALL    BCD
000C9A DA93 6F               4      LD  L,A
000C9B DA94 3A67EF          13      LD  A,(RTC_SS)
000C9E DA97 57               4      LD  D,A
000C9F DA98 C1              10      POP BC
000CA0 DA99 AF               4      XOR A
000CA1 DA9A C9              10      RET
                                
       DA9B                     RTCREAD:
000CA2 DA9B 0EF9             7      LD  C,0F9H
000CA4 DA9D 3AB9EF          13      LD  A,(WK40)
000CA7 DAA0 5F               4      LD  E,A
000CA8 DAA1 3E03             7      LD  A,3     ;コマンド３：タイムリードにセット
000CAA DAA3 CDCDDA          17      CALL    RTCCMD
000CAD DAA6 3E01             7      LD  A,1     ;コマンド１：レジスタシフトにセット
000CAF DAA8 CDCDDA          17      CALL    RTCCMD
000CB2 DAAB 0606             7      LD  B,6
000CB4 DAAD 2167EF          10      LD  HL,RTC_SS
       DAB0                     RTCREAD1:
000CB7 DAB0 C5              11      PUSH    BC
000CB8 DAB1 0608             7      LD  B,8
       DAB3                     RTCREAD2:
000CBA DAB3 DB40            11      IN  A,(40H)     ;システムモードセンス BIT4:CDI
000CBC DAB5 87               4      ADD A,A
000CBD DAB6 87               4      ADD A,A
000CBE DAB7 87               4      ADD A,A
000CBF DAB8 87               4      ADD A,A
000CC0 DAB9 CB1E            15      RR  (HL)
000CC2 DABB CDF2DA          17      CALL    RTCCLK
000CC5 DABE 10F3            13      DJNZ    RTCREAD2
000CC7 DAC0 C1              10      POP BC
000CC8 DAC1 2B               6      DEC HL
000CC9 DAC2 10EC            13      DJNZ    RTCREAD1
000CCB DAC4 AF               4      XOR A
000CCC DAC5 CDCDDA          17      CALL    RTCCMD
000CCF DAC8 7B               4      LD  A,E
000CD0 DAC9 32B9EF          13      LD  (WK40),A
000CD3 DACC C9              10      RET
                                
       DACD                     RTCCMD:
000CD4 DACD 0604             7      LD  B,4
000CD6 DACF 07               4      RLCA
000CD7 DAD0 07               4      RLCA
000CD8 DAD1 07               4      RLCA
       DAD2                     RTCCMD1:
000CD9 DAD2 F5              11      PUSH    AF
000CDA DAD3 F607             7      OR  7
000CDC DAD5 D310            11      OUT (10H),A     ;プリンタデータ出力 兼 カレンダクロック(μPD1990AC)出力
000CDE DAD7 CDF2DA          17      CALL    RTCCLK
000CE1 DADA F1              10      POP AF
000CE2 DADB 0F               4      RRCA
000CE3 DADC 10F4            13      DJNZ    RTCCMD1
000CE5 DADE 3E07             7      LD  A,7
000CE7 DAE0 D310            11      OUT (10H),A     ;プリンタデータ出力 兼 カレンダクロック(μPD1990AC)出力
000CE9 DAE2 7B               4      LD  A,E
000CEA DAE3 A1               4      AND C
000CEB DAE4 F602             7      OR  2
000CED DAE6 D340            11      OUT (40H),A     ;ストローブポート
000CEF DAE8 A1               4      AND C
000CF0 DAE9 00               4      NOP
000CF1 DAEA D340            11      OUT (40H),A     ;ストローブポート
000CF3 DAEC 5F               4      LD  E,A
000CF4 DAED 060D             7      LD  B,13
       DAEF                     RTCCMD3:
000CF6 DAEF 10FE            13      DJNZ    RTCCMD3
000CF8 DAF1 C9              10      RET
                                
       DAF2                     RTCCLK:
000CF9 DAF2 7B               4      LD  A,E
000CFA DAF3 A1               4      AND C
000CFB DAF4 F604             7      OR  04H
000CFD DAF6 D340            11      OUT (40H),A
000CFF DAF8 A1               4      AND C
000D00 DAF9 00               4      NOP
000D01 DAFA D340            11      OUT (40H),A
000D03 DAFC 5F               4      LD  E,A
000D04 DAFD C9              10      RET
                                
                                ;------------------------
                                ;BCDの10進数化
                                ;in
                                ;   A  : BCD
                                ;out
                                ;   A  : 10進数
                                ;------------------------
       DAFE                     BCD:
000D05 DAFE 4F               4      LD  C,A
000D06 DAFF E6F0             7      AND 0F0H    ;10の位
000D08 DB01 0F               4      RRCA
000D09 DB02 47               4      LD  B,A
000D0A DB03 0F               4      RRCA
000D0B DB04 0F               4      RRCA
000D0C DB05 80               4      ADD A,B
000D0D DB06 47               4      LD  B,A
000D0E DB07 79               4      LD  A,C
000D0F DB08 E60F             7      AND 00FH    ;1の位
000D11 DB0A 80               4      ADD A,B
000D12 DB0B C9              10      RET
                                
       DB0C                     ESC1:
000D13 DB0C 7B               4      LD  A,E
000D14 DB0D FE41             7      CP  'A'
000D16 DB0F CAF1DB          10      JP  Z,CTRL1E
000D19 DB12 FE42             7      CP  'B'
000D1B DB14 CA10DD          10      JP  Z,CTRL1F
000D1E DB17 FE43             7      CP  'C'
000D20 DB19 CAB7DB          10      JP  Z,CTRL1C
000D23 DB1C FE44             7      CP  'D'
000D25 DB1E CADCDB          10      JP  Z,CTRL1D
000D28 DB21 FE45             7      CP  'E'
000D2A DB23 2802            12      JR  Z,CT0CX
000D2C DB25 FE6A             7      CP  'j'
       DB27                     CT0CX:
000D2E DB27 CADDDC          10      JP  Z,CTRL0C
000D31 DB2A FE48             7      CP  'H'
000D33 DB2C CA5CDC          10      JP  Z,CTRL0B
000D36 DB2F FE4A             7      CP  'J'
000D38 DB31 CAE0DC          10      JP  Z,CTRL06
000D3B DB34 FE4B             7      CP  'K'
000D3D DB36 CA30DC          10      JP  Z,CTRL05
000D40 DB39 FE4C             7      CP  'L'
000D42 DB3B CA17DD          10      JP  Z,CTRL0E
000D45 DB3E FE54             7      CP  'T'
000D47 DB40 CA30DC          10      JP  Z,CTRL05
000D4A DB43 FE78             7      CP  'x'
000D4C DB45 2804            12      JR  Z,ESC1X
000D4E DB47 FE79             7      CP  'y'
000D50 DB49 2002            12      JR  NZ,ESC1Y
       DB4B                     ESC1X:
000D52 DB4B 3601            10      LD  (HL),1
       DB4D                     ESC1Y:
000D54 DB4D FE3D             7      CP  '='
000D56 DB4F 2804            12      JR  Z,ESC1W
000D58 DB51 FE59             7      CP  'Y'
000D5A DB53 2002            12      JR  NZ,ESC1Z
       DB55                     ESC1W:
000D5C DB55 3602            10      LD  (HL),2
       DB57                     ESC1Z:
000D5E DB57 FE20             7      CP  020H
000D60 DB59 3802            12      JR  C,ESC1C
000D62 DB5B 87               4      ADD A,A
000D63 DB5C D0              11      RET NC
       DB5D                     ESC1C:
000D64 DB5D E1              10      POP HL
000D65 DB5E 1832            12      JR  ANK
                                
       DB60                     ESC:
000D67 DB60 21A3DB          10      LD  HL,PRINTE5
000D6A DB63 E5              11      PUSH    HL
000D6B DB64 2186DB          10      LD  HL,ESCFLG
000D6E DB67 3600            10      LD  (HL),0
000D70 DB69 3D               4      DEC A
000D71 DB6A 28A0            12      JR  Z,ESC1
000D73 DB6C 3D               4      DEC A
000D74 DB6D 2009            12      JR  NZ,ESC2
000D76 DB6F 3603            10      LD  (HL),3
000D78 DB71 7B               4      LD  A,E
000D79 DB72 D620             7      SUB 020H
000D7B DB74 327BDB          13      LD  (ESCYP+1),A
000D7E DB77 C9              10      RET
       DB78                     ESC2:
000D7F DB78 3D               4      DEC A
000D80 DB79 C0              11      RET NZ
000D81 DB7A 2600             7  ESCYP:  LD  H,0
000D83 DB7C 7B               4      LD  A,E
000D84 DB7D D620             7      SUB 020H
000D86 DB7F 6F               4      LD  L,A
000D87 DB80 C3D6EF          10      JP  _LOC
                                
       DB83                     PRINT:
000D8A DB83 C5              11      PUSH    BC
000D8B DB84 E5              11      PUSH    HL
000D8C DB85 3E00             7      LD  A,000H      ;自己書き換え
       DB86                     ESCFLG  EQU $-1
000D8E DB87 B7               4      OR  A
000D8F DB88 20D6            12      JR  NZ,ESC
                                
000D91 DB8A 3E1F             7      LD  A,01FH
000D93 DB8C BB               4      CP  E
000D94 DB8D 3018            12      JR  NC,CTRL
       DB8F                     INSFLG  EQU $
000D96 DB8F 01BFDC          10      LD  BC,INSERT   ;自己書き換え
       DB92                     ANK:
000D99 DB92 CD69DC          17      CALL    LOC0
000D9C DB95 DB32            11      IN  A,(032H)
000D9E DB97 F5              11      PUSH    AF
000D9F DB98 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000DA1 DB9A D332            11      OUT (032H),A
000DA3 DB9C 73               7      LD  (HL),E
000DA4 DB9D F1              10      POP AF
000DA5 DB9E D332            11      OUT (032H),A
000DA7 DBA0 CDB7DB          17      CALL    CTRL1C
       DBA3                     PRINTE5:
000DAA DBA3 E1              10      POP HL
000DAB DBA4 C1              10      POP BC
000DAC DBA5 AF               4      XOR A
000DAD DBA6 C9              10      RET
                                
       DBA7                     CTRL:
000DAE DBA7 7B               4      LD  A,E
000DAF DBA8 87               4      ADD A,A
000DB0 DBA9 F680             7      OR  080H
000DB2 DBAB 6F               4      LD  L,A
000DB3 DBAC 26F0             7      LD  H,CTRLTB/256
000DB5 DBAE 7E               7      LD  A,(HL)
000DB6 DBAF 2C               4      INC L
000DB7 DBB0 66               7      LD  H,(HL)
000DB8 DBB1 6F               4      LD  L,A
000DB9 DBB2 CD0F00          17      CALL    JP_HL
000DBC DBB5 18EC            12      JR  PRINTE5
                                
       DBB7                     CTRL1C:
000DBE DBB7 2A8EEF          16      LD  HL,(_TXADR)
000DC1 DBBA 2C               4      INC L
       DBBB                     PRINTE3:
000DC2 DBBB 3AB1EF          13      LD  A,(_WIDTH)
000DC5 DBBE 3D               4      DEC A
000DC6 DBBF BD               4      CP  L
000DC7 DBC0 3009            12      JR  NC,SET_TXADR_HL
000DC9 DBC2 2E00             7      LD  L,0
000DCB DBC4 24               4      INC H
       DBC5                     PRINTE8:
000DCC DBC5 3A97EF          13      LD  A,(_LINE)
000DCF DBC8 BC               4      CP  H
000DD0 DBC9 2804            12      JR  Z,PRINT2
       DBCB                     LOC:
       DBCB                     SET_TXADR_HL:
000DD2 DBCB 228EEF          16      LD  (_TXADR),HL
       DBCE                     CTRL00:
000DD5 DBCE C9              10      RET
                                
       DBCF                     PRINT2:
000DD6 DBCF CD1DDD          17      CALL    SCR
000DD9 DBD2 25               4      DEC H
000DDA DBD3 18F6            12      JR  SET_TXADR_HL
                                
       DBD5                     CTRL08:
000DDC DBD5 3A8FDB          13      LD  A,(INSFLG)
000DDF DBD8 FECD             7      CP  0CDH        ;CALL ????
000DE1 DBDA 2829            12      JR  Z,CTRL02
       DBDC                     CTRL1D:
000DE3 DBDC 2A8EEF          16      LD  HL,(_TXADR)
000DE6 DBDF 7C               4      LD  A,H
000DE7 DBE0 B5               4      OR  L
000DE8 DBE1 C8              11      RET Z
000DE9 DBE2 7D               4      LD  A,L
000DEA DBE3 B7               4      OR  A
000DEB DBE4 2803            12      JR  Z,CTRL1DX1
000DED DBE6 2D               4      DEC L
000DEE DBE7 18E2            12      JR  SET_TXADR_HL
       DBE9                     CTRL1DX1:
000DF0 DBE9 3AB1EF          13      LD  A,(_WIDTH)
000DF3 DBEC 3D               4      DEC A
000DF4 DBED 6F               4      LD  L,A
000DF5 DBEE 25               4      DEC H
000DF6 DBEF 18DA            12      JR  SET_TXADR_HL
       DBF1                     CTRL1E:
000DF8 DBF1 2A8EEF          16      LD  HL,(_TXADR)
000DFB DBF4 7C               4      LD  A,H
000DFC DBF5 B7               4      OR  A
000DFD DBF6 C8              11      RET Z
000DFE DBF7 25               4      DEC H
000DFF DBF8 18D1            12      JR  SET_TXADR_HL
                                
       DBFA                     CTRL09:
000E01 DBFA 2A8EEF          16      LD  HL,(_TXADR)
000E04 DBFD 7D               4      LD  A,L
000E05 DBFE E6F8             7      AND 0F8H
000E07 DC00 C608             7      ADD A,8
000E09 DC02 6F               4      LD  L,A
000E0A DC03 18B6            12      JR  PRINTE3
                                
       DC05                     CTRL02:
000E0C DC05 3A8EEF          13      LD  A,(_TXADR)
000E0F DC08 B7               4      OR  A
000E10 DC09 28D1            12      JR  Z,CTRL1D
000E12 DC0B CDDCDB          17      CALL    CTRL1D
000E15 DC0E 2A8EEF          16      LD  HL,(_TXADR)
000E18 DC11 3AB1EF          13      LD  A,(_WIDTH)
000E1B DC14 4F               4      LD  C,A
000E1C DC15 95               4      SUB L
000E1D DC16 47               4      LD  B,A
000E1E DC17 79               4      LD  A,C
000E1F DC18 3D               4      DEC A
000E20 DC19 6F               4      LD  L,A
000E21 DC1A CD6CDC          17      CALL    LOC1
                                
000E24 DC1D DB32            11      IN  A,(032H)
000E26 DC1F F5              11      PUSH    AF
000E27 DC20 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000E29 DC22 D332            11      OUT (032H),A
                                
000E2B DC24 3E20             7      LD  A,020H
       DC26                     C8X1:
000E2D DC26 4E               7      LD  C,(HL)
000E2E DC27 77               7      LD  (HL),A
000E2F DC28 2B               6      DEC HL
000E30 DC29 79               4      LD  A,C
000E31 DC2A 10FA            13      DJNZ    C8X1
                                
000E33 DC2C F1              10      POP AF
000E34 DC2D D332            11      OUT (032H),A
000E36 DC2F C9              10      RET
                                
       DC30                     CTRL05:
000E37 DC30 CDD3EF          17      CALL    _POS
000E3A DC33 2A8EEF          16      LD  HL,(_TXADR)
000E3D DC36 3AB1EF          13      LD  A,(_WIDTH)
000E40 DC39 95               4      SUB L
000E41 DC3A 47               4      LD  B,A
000E42 DC3B CD69DC          17      CALL    LOC0
       DC3E                     CLLINE:
000E45 DC3E DB32            11      IN  A,(032H)
000E47 DC40 F5              11      PUSH    AF
000E48 DC41 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000E4A DC43 D332            11      OUT (032H),A
000E4C DC45 3E20             7      LD  A,020H
       DC47                     CLLINE1:
000E4E DC47 77               7      LD  (HL),A
000E4F DC48 23               6      INC HL
000E50 DC49 10FC            13      DJNZ    CLLINE1
                                
000E52 DC4B F1              10      POP AF
000E53 DC4C D332            11      OUT (032H),A
000E55 DC4E C9              10      RET
                                
       DC4F                     CTRL0D:
000E56 DC4F AF               4      XOR A
000E57 DC50 328EEF          13      LD  (_TXADR),A
000E5A DC53 C9              10      RET
                                
       DC54                     CTRL12:
000E5B DC54 218FDB          10      LD  HL,INSFLG
000E5E DC57 7E               7      LD  A,(HL)
000E5F DC58 EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000E61 DC5A 77               7      LD  (HL),A
000E62 DC5B C9              10      RET
                                
       DC5C                     CTRL0B:
000E63 DC5C 210000          10      LD  HL,0
000E66 DC5F 228EEF          16      LD  (_TXADR),HL
000E69 DC62 C9              10      RET
                                
       DC63                     CTRL1B:
000E6A DC63 3E01             7      LD  A,1
000E6C DC65 3286DB          13      LD  (ESCFLG),A
000E6F DC68 C9              10      RET
       DC69                     LOC0:
000E70 DC69 2A8EEF          16      LD  HL,(_TXADR)
       DC6C                     LOC1:
000E73 DC6C D5              11      PUSH    DE
000E74 DC6D E5              11      PUSH    HL
000E75 DC6E 6C               4      LD  L,H ;Y
000E76 DC6F 5C               4      LD  E,H
000E77 DC70 2600             7      LD  H,0
000E79 DC72 54               4      LD  D,H
000E7A DC73 29              11      ADD HL,HL   ;*2
000E7B DC74 29              11      ADD HL,HL   ;*4
000E7C DC75 29              11      ADD HL,HL   ;*8
000E7D DC76 29              11      ADD HL,HL   ;*16
000E7E DC77 ED52            15      SBC HL,DE   ;*15
000E80 DC79 29              11      ADD HL,HL   ;*30
000E81 DC7A 29              11      ADD HL,HL   ;*60
000E82 DC7B 29              11      ADD HL,HL   ;*120
000E83 DC7C D1              10      POP DE
000E84 DC7D 1600             7      LD  D,0
000E86 DC7F 19              11      ADD HL,DE   ;X
000E87 DC80 ED5BB2EF        20      LD  DE,(TVRAMTOP)
000E8B DC84 19              11      ADD HL,DE
000E8C DC85 D1              10      POP DE
000E8D DC86 C9              10      RET
                                
       DC87                     CONOUT1:
000E8E DC87 59               4      LD  E,C
000E8F DC88 CDCDEF          17      CALL    _PRINT
000E92 DC8B 7B               4      LD  A,E
000E93 DC8C FE0A             7      CP  00AH
000E95 DC8E 2006            12      JR  NZ,CURSOR_ON
000E97 DC90 CD4FDC          17      CALL    CTRL0D
000E9A DC93 CD30DC          17      CALL    CTRL05
       DC96                     CURSOR_ON:
000E9D DC96 F5              11      PUSH    AF
000E9E DC97 3E81             7      LD  A,081H
       DC99                     CURSOR0:
000EA0 DC99 D351            11      OUT (051H),A
000EA2 DC9B 3A8EEF          13      LD  A,(_TXADR)
000EA5 DC9E D350            11      OUT (050H),A
000EA7 DCA0 3A8FEF          13      LD  A,(_TXADR+1)
000EAA DCA3 D350            11      OUT (050H),A
000EAC DCA5 F1              10      POP AF
000EAD DCA6 C9              10      RET
       DCA7                     CURSOR_OFF:
000EAE DCA7 F5              11      PUSH    AF
000EAF DCA8 3E80             7      LD  A,080H
000EB1 DCAA 18ED            12      JR  CURSOR0
                                
       DCAC                     CTRL07:
000EB3 DCAC 3AB9EF          13      LD  A,(WK40)
000EB6 DCAF F5              11      PUSH    AF
000EB7 DCB0 F620             7      OR  20H
000EB9 DCB2 D340            11      OUT (040H),A
000EBB DCB4 0610             7      LD  B,16
       DCB6                     C07X1:
000EBD DCB6 CD29DE          17      CALL    VBLANK
000EC0 DCB9 10FB            13      DJNZ    C07X1
000EC2 DCBB F1              10      POP AF
000EC3 DCBC D340            11      OUT (040H),A
000EC5 DCBE C9              10      RET
                                
       DCBF                     INSERT:
000EC6 DCBF 2A8EEF          16      LD  HL,(_TXADR)
000EC9 DCC2 3AB1EF          13      LD  A,(_WIDTH)
000ECC DCC5 95               4      SUB L
000ECD DCC6 47               4      LD  B,A
                                
000ECE DCC7 CD69DC          17      CALL    LOC0
                                
000ED1 DCCA DB32            11      IN  A,(032H)
000ED3 DCCC F5              11      PUSH    AF
000ED4 DCCD E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000ED6 DCCF D332            11      OUT (032H),A
                                
000ED8 DCD1 3E20             7      LD  A,020H
       DCD3                     INS1:
000EDA DCD3 4E               7      LD  C,(HL)
000EDB DCD4 77               7      LD  (HL),A
000EDC DCD5 79               4      LD  A,C
000EDD DCD6 23               6      INC HL
000EDE DCD7 10FA            13      DJNZ    INS1
                                
000EE0 DCD9 F1              10      POP AF
000EE1 DCDA D332            11      OUT (032H),A
000EE3 DCDC C9              10      RET
                                
       DCDD                     CTRL0C:
000EE4 DCDD CD5CDC          17      CALL    CTRL0B
       DCE0                     CTRL06:
000EE7 DCE0 2A8EEF          16      LD  HL,(_TXADR)
       DCE3                     CLS1:
000EEA DCE3 DB32            11      IN  A,(032H)
000EEC DCE5 F5              11      PUSH    AF
000EED DCE6 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000EEF DCE8 D332            11      OUT (032H),A
       DCEA                     CLS2:
000EF1 DCEA E5              11      PUSH    HL
000EF2 DCEB 3AB1EF          13      LD  A,(_WIDTH)
000EF5 DCEE 95               4      SUB L
000EF6 DCEF 47               4      LD  B,A
000EF7 DCF0 CD6CDC          17      CALL    LOC1
000EFA DCF3 3E20             7      LD  A,020H
       DCF5                     CLS3:
000EFC DCF5 77               7      LD  (HL),A
000EFD DCF6 23               6      INC HL
000EFE DCF7 10FC            13      DJNZ    CLS3
000F00 DCF9 E1              10      POP HL
000F01 DCFA 2E00             7      LD  L,0
000F03 DCFC 24               4      INC H
000F04 DCFD 3A97EF          13      LD  A,(_LINE)
000F07 DD00 BC               4      CP  H
000F08 DD01 20E7            12      JR  NZ,CLS2
000F0A DD03 F1              10      POP AF
000F0B DD04 D332            11      OUT (032H),A
000F0D DD06 C9              10      RET
                                
       DD07                     CTRL04:
000F0E DD07 CDD3EF          17      CALL    _POS
000F11 DD0A 7D               4      LD  A,L
000F12 DD0B B7               4      OR  A
000F13 DD0C C8              11      RET Z
       DD0D                     CTRL03:
000F14 DD0D CD4FDC          17      CALL    CTRL0D
       DD10                     CTRL0A:
       DD10                     CTRL1F:
000F17 DD10 2A8EEF          16      LD  HL,(_TXADR)
000F1A DD13 24               4      INC H
000F1B DD14 C3C5DB          10      JP  PRINTE8
                                
       DD17                     CTRL0E:
000F1E DD17 CDD3EF          17      CALL    _POS
000F21 DD1A 7C               4      LD  A,H
000F22 DD1B 1804            12      JR  SCR1
       DD1D                     SCR:
000F24 DD1D 3A97EF          13      LD  A,(_LINE)
000F27 DD20 3D               4      DEC A
       DD21                     SCR1:
000F28 DD21 C5              11      PUSH    BC
000F29 DD22 D5              11      PUSH    DE
000F2A DD23 E5              11      PUSH    HL
000F2B DD24 F5              11      PUSH    AF
000F2C DD25 210000          10      LD  HL,0
000F2F DD28 CD6CDC          17      CALL    LOC1
000F32 DD2B EB               4      EX  DE,HL
000F33 DD2C 210001          10      LD  HL,0100H
000F36 DD2F CD6CDC          17      CALL    LOC1
000F39 DD32 C1              10      POP BC
000F3A DD33 DB32            11      IN  A,(032H)
000F3C DD35 F5              11      PUSH    AF
000F3D DD36 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000F3F DD38 D332            11      OUT (032H),A
000F41 DD3A 78               4      LD  A,B
000F42 DD3B B7               4      OR  A
       DD3C                     SCRUP1:
000F43 DD3C 2815            12      JR  Z,SCRCL
000F45 DD3E E5              11      PUSH    HL
000F46 DD3F D5              11      PUSH    DE
000F47 DD40 0608             7      LD  B,8
000F49 DD42 5F               4      LD  E,A
000F4A DD43 210078          10      LD  HL,120*256
000F4D DD46 55               4      LD  D,L
       DD47                     SCRH2:
000F4E DD47 29              11      ADD HL,HL
000F4F DD48 3001            12      JR  NC,SCRH3
000F51 DD4A 19              11      ADD HL,DE
       DD4B                     SCRH3:
000F52 DD4B 10FA            13      DJNZ    SCRH2
000F54 DD4D 4D               4      LD  C,L
000F55 DD4E 44               4      LD  B,H
000F56 DD4F D1              10      POP DE
000F57 DD50 E1              10      POP HL
000F58 DD51 EDB0                    LDIR
                                
       DD53                     SCRCL:
000F5A DD53 F1              10      POP AF
000F5B DD54 D332            11      OUT (032H),A
                                
000F5D DD56 3AB1EF          13      LD  A,(_WIDTH)
000F60 DD59 47               4      LD  B,A
000F61 DD5A EB               4      EX  DE,HL
000F62 DD5B CD3EDC          17      CALL    CLLINE
000F65 DD5E E1              10      POP HL
000F66 DD5F D1              10      POP DE
000F67 DD60 C1              10      POP BC
000F68 DD61 C9              10      RET
       DD62                     POS:
000F69 DD62 2A8EEF          16      LD  HL,(_TXADR)
000F6C DD65 C9              10      RET
                                
       DD66                     GETL:
000F6D DD66 CDD3EF          17      CALL    _POS
000F70 DD69 E5              11      PUSH    HL
000F71 DD6A 3ECD             7      LD  A,0CDH      ;CALL ????
000F73 DD6C 328FDB          13      LD  (INSFLG),A
       DD6F                     GETL1:
000F76 DD6F CDF1D9          17      CALL    _SYS08
000F79 DD72 FE09             7      CP  9
000F7B DD74 2008            12      JR  NZ,GETL1V
000F7D DD76 2120FF          10      LD  HL,KBUF
000F80 DD79 CDE2D6          17      CALL    MSX
000F83 DD7C 18F1            12      JR  GETL1
       DD7E                     GETL1V:
000F85 DD7E 5F               4      LD  E,A
000F86 DD7F CDCDEF          17      CALL    _PRINT
                                
000F89 DD82 7B               4      LD  A,E
000F8A DD83 FE0D             7      CP  00DH
000F8C DD85 20E8            12      JR  NZ,GETL1
000F8E DD87 3E01             7      LD  A,1     ;LD BC,????
000F90 DD89 328FDB          13      LD  (INSFLG),A
000F93 DD8C 1120FF          10      LD  DE,KBUF
000F96 DD8F 3AB1EF          13      LD  A,(_WIDTH)
000F99 DD92 47               4      LD  B,A
000F9A DD93 CD3FD5          17      CALL    ZERO_MEMORY_DE
                                
000F9D DD96 D1              10      POP DE
000F9E DD97 CDD3EF          17      CALL    _POS
000FA1 DD9A 6B               4      LD  L,E
000FA2 DD9B 3AB1EF          13      LD  A,(_WIDTH)
000FA5 DD9E 95               4      SUB L
000FA6 DD9F 57               4      LD  D,A
000FA7 DDA0 CD6CDC          17      CALL    LOC1
000FAA DDA3 4D               4      LD  C,L
000FAB DDA4 7C               4      LD  A,H
000FAC DDA5 F630             7      OR  030H
000FAE DDA7 47               4      LD  B,A
000FAF DDA8 5A               4      LD  E,D
000FB0 DDA9 2120FF          10      LD  HL,KBUF
       DDAC                     GETL2:
000FB3 DDAC CDD0EF          17      CALL    _SCRN
000FB6 DDAF 03               6      INC BC
000FB7 DDB0 77               7      LD  (HL),A
000FB8 DDB1 23               6      INC HL
000FB9 DDB2 1D               4      DEC E
000FBA DDB3 20F7            12      JR  NZ,GETL2
       DDB5                     GETL3:
000FBC DDB5 2B               6      DEC HL
000FBD DDB6 7E               7      LD  A,(HL)
000FBE DDB7 FE21             7      CP  021H
000FC0 DDB9 D0              11      RET NC
000FC1 DDBA 3600            10      LD  (HL),0
000FC3 DDBC 15               4      DEC D
000FC4 DDBD 20F6            12      JR  NZ,GETL3
000FC6 DDBF C9              10      RET
                                
       DDC0                     INKEY:
000FC7 DDC0 FB               4      EI
000FC8 DDC1 E5              11      PUSH    HL
000FC9 DDC2 2A90EF          16      LD  HL,(_KEYPS)
000FCC DDC5 7C               4      LD  A,H
000FCD DDC6 AD               4      XOR L
000FCE DDC7 280C            12      JR  Z,INKEY1
000FD0 DDC9 7C               4      LD  A,H
000FD1 DDCA 3C               4      INC A
000FD2 DDCB E61F             7      AND 01FH
000FD4 DDCD 3291EF          13      LD  (_KEYPS+1),A
000FD7 DDD0 6F               4      LD  L,A
000FD8 DDD1 26FF             7      LD  H,KEYBF/256
000FDA DDD3 7E               7      LD  A,(HL)
000FDB DDD4 B7               4      OR  A
       DDD5                     INKEY1:
000FDC DDD5 E1              10      POP HL
000FDD DDD6 C9              10      RET
                                
       DDD7                     CHKEY:
000FDE DDD7 C5              11      PUSH    BC
000FDF DDD8 DB08            11      IN  A,(8)       ;6:SHIFT,7:CTRL
000FE1 DDDA 4F               4      LD  C,A
000FE2 DDDB 3A0E00          13      LD  A,(00EH)
000FE5 DDDE CB5F             8      BIT 3,A
000FE7 DDE0 2002            12      JR  NZ,CHKEYRSHIFT
000FE9 DDE2 CBB1             8      RES 6,C
       DDE4                     CHKEYRSHIFT:
000FEB DDE4 79               4      LD  A,C
000FEC DDE5 3293EF          13      LD  (_KEYD+1),A
000FEF DDE8 E5              11      PUSH    HL
000FF0 DDE9 0E00             7      LD  C,0
000FF2 DDEB 2198F1          10      LD  HL,KEY_TABLE
000FF5 DDEE CB77             8      BIT 6,A
000FF7 DDF0 2003            12      JR  NZ,CHKEY0
000FF9 DDF2 212EEE          10      LD  HL,SHIFT_TABLE
       DDF5                     CHKEY0:
000FFC DDF5 CB7F             8      BIT 7,A
000FFE DDF7 2003            12      JR  NZ,CHKEY1
001000 DDF9 2196EE          10      LD  HL,CTRL_TABLE
       DDFC                     CHKEY1:
001003 DDFC ED78            12      IN  A,(C)
001005 DDFE 0608             7      LD  B,8
       DE00                     CHKEY2:
001007 DE00 0F               4      RRCA
001008 DE01 300B            12      JR  NC,CHKEY4
       DE03                     CHKEY3:
00100A DE03 23               6      INC HL
00100B DE04 10FA            13      DJNZ    CHKEY2
00100D DE06 0C               4      INC C
00100E DE07 79               4      LD  A,C
00100F DE08 D60D             7      SUB 00DH
001011 DE0A 20F0            12      JR  NZ,CHKEY1
001013 DE0C 1804            12      JR  CHKEY5
       DE0E                     CHKEY4:
001015 DE0E 7E               7      LD  A,(HL)
001016 DE0F B7               4      OR  A
001017 DE10 28F1            12      JR  Z,CHKEY3
       DE12                     CHKEY5:
001019 DE12 E1              10      POP HL
00101A DE13 C1              10      POP BC
00101B DE14 B7               4      OR  A
00101C DE15 3292EF          13      LD  (_KEYD),A
00101F DE18 C9              10      RET
                                
       DE19                     SCRN:
001020 DE19 E5              11      PUSH    HL
001021 DE1A DB32            11      IN  A,(032H)
001023 DE1C 67               4      LD  H,A
001024 DE1D E6EF             7      AND 0EFH        ;高速RAMアクセスモード
001026 DE1F D332            11      OUT (032H),A
001028 DE21 0A               7      LD  A,(BC)
001029 DE22 6F               4      LD  L,A
00102A DE23 7C               4      LD  A,H
00102B DE24 D332            11      OUT (032H),A
00102D DE26 7D               4      LD  A,L
00102E DE27 E1              10      POP HL
00102F DE28 C9              10      RET
                                
       DE29                     VBLANK:
001030 DE29 F5              11      PUSH    AF
       DE2A                     VBLANK0:
001031 DE2A DB40            11      IN  A,(040H)
001033 DE2C E620             7      AND 020H
001035 DE2E 20FA            12      JR  NZ,VBLANK0
       DE30                     VBLANK1:
001037 DE30 DB40            11      IN  A,(040H)
001039 DE32 E620             7      AND 020H
00103B DE34 28FA            12      JR  Z,VBLANK1
00103D DE36 F1              10      POP AF
00103E DE37 C9              10      RET
                                
       DE38                     INIT_CRTC:
00103F DE38 3E03             7      LD  A,3     ;80桁
001041 DE3A D330            11      OUT (030H),A
001043 DE3C 32BEEF          13      LD  (WK30),A
                                
001046 DE3F 3E22             7      LD  A,022H      ;25行 64K RAM
001048 DE41 D331            11      OUT (031H),A
00104A DE43 32BFEF          13      LD  (WK31),A
                                
00104D DE46 3EFF             7      LD  A,0FFH
00104F DE48 D3E4            11      OUT (0E4H),A    ;割り込みレベル設定
001051 DE4A 32B7EF          13      LD  (WKE4),A
001054 DE4D 3E00             7      LD  A,0
001056 DE4F D3E6            11      OUT (0E6H),A    ;割り込みマスク
                                
001058 DE51 3E19             7      LD  A,019H
00105A DE53 D340            11      OUT (040H),A    ;CRT I/F 同期ビットオン
00105C DE55 32B9EF          13      LD  (WK40),A
00105F DE58 CD29DE          17      CALL    VBLANK
                                
001062 DE5B AF               4      XOR A
001063 DE5C D351            11      OUT (051H),A    ;Reset CRTC
001065 DE5E 3EA0             7      LD  A,0A0H
001067 DE60 D368            11      OUT (068H),A    ;DMAC: Mode Set(Reset)
001069 DE62 21C8F3          10      LD  HL,0F3C8H
00106C DE65 22B2EF          16      LD  (TVRAMTOP),HL
00106F DE68 0E64             7      LD  C,064H
001071 DE6A ED69            12      OUT (C),L       ;TVRAM LOW
001073 DE6C ED61            12      OUT (C),H       ;TVRAM HIGH
001075 DE6E 21B78B          10      LD  HL,08000H+120*25-1
001078 DE71 0C               4      INC C       ;65H
001079 DE72 ED69            12      OUT (C),L
00107B DE74 ED61            12      OUT (C),H
00107D DE76 3ECE             7      LD  A,080H+80-2
00107F DE78 D350            11      OUT (050H),A
001081 DE7A 3E98             7      LD  A,080H+25-1
001083 DE7C D350            11      OUT (050H),A
001085 DE7E DB40            11      IN  A,(040H)
001087 DE80 CB4F             8      BIT 1,A
001089 DE82 21DE67          10      LD  HL,067DEH
00108C DE85 2003            12      JR  NZ,RESO1
00108E DE87 21586F          10      LD  HL,06F58H
       DE8A                     RESO1:
001091 DE8A 0E50             7      LD  C,050H
001093 DE8C ED61            12      OUT (C),H
001095 DE8E ED69            12      OUT (C),L
                                
001097 DE90 3E53             7      LD  A,053H
001099 DE92 D350            11      OUT (050H),A
                                
00109B DE94 3E43             7      LD  A,043H
00109D DE96 D351            11      OUT (051H),A
                                
00109F DE98 3EE4             7      LD  A,0E4H
0010A1 DE9A D368            11      OUT (068H),A
                                
0010A3 DE9C 3E20             7      LD  A,020H
0010A5 DE9E D351            11      OUT (051H),A
                                
0010A7 DEA0 CD29DE          17      CALL    VBLANK
       DEA3                     IVBL1:
0010AA DEA3 DB40            11      IN  A,(040H)
0010AC DEA5 CB6F             8      BIT 5,A
0010AE DEA7 20FA            12      JR  NZ,IVBL1
                                
0010B0 DEA9 3E11             7      LD  A,011H
0010B2 DEAB D340            11      OUT (040H),A    ;CRT I/F 同期ビットオフ
0010B4 DEAD 32B9EF          13      LD  (WK40),A
0010B7 DEB0 C9              10      RET
[EOF:88IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
       DEB1                     FILEC:
0010B8 DEB1 CDBCDE          17      CALL    FILE
       DEB4                     FILEC2:
0010BB DEB4 3A15EF          13      LD  A,(FDRV+1)
0010BE DEB7 FE20             7      CP  020H
0010C0 DEB9 C8              11      RET Z
0010C1 DEBA 1839            12      JR  SETDIR1
                                
       DEBC                     FILE:
0010C3 DEBC AF               4      XOR A
0010C4 DEBD 3214EF          13      LD  (FDRV),A
0010C7 DEC0 67               4      LD  H,A
0010C8 DEC1 6F               4      LD  L,A
0010C9 DEC2 2222EF          16      LD  (FDRV+14),HL
0010CC DEC5 CD93DF          17      CALL    SPCUT
0010CF DEC8 CD78DF          17      CALL    CCHK3
0010D2 DECB 2812            12      JR  Z,DEVI1
0010D4 DECD 13               6      INC DE
0010D5 DECE 1A               7      LD  A,(DE)
0010D6 DECF 1B               6      DEC DE
0010D7 DED0 FE3A             7      CP  ':'
0010D9 DED2 200B            12      JR  NZ,DEVI1
0010DB DED4 1A               7      LD  A,(DE)      ;DRIVE
0010DC DED5 CDC8E1          17      CALL    CAP
0010DF DED8 D640             7      SUB '@'
0010E1 DEDA 13               6      INC DE
0010E2 DEDB 13               6      INC DE
0010E3 DEDC 3214EF          13      LD  (FDRV),A
       DEDF                     DEVI1:
0010E6 DEDF 1A               7      LD  A,(DE)
0010E7 DEE0 D65C             7      SUB 05CH        ;\
0010E9 DEE2 2009            12      JR  NZ,NOROOT
0010EB DEE4 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
0010EC DEE5 222EEF          16      LD  (FDRV+26),HL
0010EF DEE8 2C               4      INC L
0010F0 DEE9 2222EF          16      LD  (FDRV+14),HL
0010F3 DEEC 13               6      INC DE
       DEED                     NOROOT:
                                
       DEED                     SETDIR:
0010F4 DEED CD19DF          17      CALL    FILED
0010F7 DEF0 1A               7      LD  A,(DE)
0010F8 DEF1 FE5C             7      CP  05CH        ;\
0010FA DEF3 C0              11      RET NZ
0010FB DEF4 13               6      INC DE
       DEF5                     SETDIR1:
0010FC DEF5 3E10             7      LD  A,010H      ;Directory
0010FE DEF7 3221EF          13      LD  (FDRV+13),A
001101 DEFA D5              11      PUSH    DE
001102 DEFB 1114EF          10      LD  DE,FDRV
001105 DEFE 2A1EF0          16      LD  HL,(STABLE+2*00FH)
001108 DF01 CD0F00          17      CALL    JP_HL
00110B DF04 D1              10      POP DE
00110C DF05 B7               4      OR  A
00110D DF06 C0              11      RET NZ
                                
00110E DF07 3A21EF          13      LD  A,(FDRV+13)
001111 DF0A CB67             8      BIT 4,A
001113 DF0C C8              11      RET Z
                                
001114 DF0D CD60DF          17      CALL    FILEI
001117 DF10 2A2EEF          16      LD  HL,(FDRV+26)
00111A DF13 23               6      INC HL
00111B DF14 2222EF          16      LD  (FDRV+14),HL
00111E DF17 18D4            12      JR  SETDIR
                                
       DF19                     FILED:
001120 DF19 CD60DF          17      CALL    FILEI
001123 DF1C 2115EF          10      LD  HL,FNAME
                                
001126 DF1F 0608             7      LD  B,8
       DF21                     FILE2:
001128 DF21 CD6DDF          17      CALL    CCHKF
00112B DF24 C8              11      RET Z
00112C DF25 FE2A             7      CP  '*'
00112E DF27 282E            12      JR  Z,FILE9
001130 DF29 FE2E             7      CP  '.'
001132 DF2B 280C            12      JR  Z,FILE4
001134 DF2D 77               7      LD  (HL),A
001135 DF2E 23               6      INC HL
001136 DF2F 10F0            13      DJNZ    FILE2
                                
       DF31                     FILE3:
001138 DF31 CD6DDF          17      CALL    CCHKF
00113B DF34 C8              11      RET Z
00113C DF35 FE2E             7      CP  '.'
00113E DF37 20F8            12      JR  NZ,FILE3
                                
       DF39                     FILE4:
001140 DF39 211DEF          10      LD  HL,FNAME+8
001143 DF3C 0603             7      LD  B,3
                                
       DF3E                     FILE4L:
001145 DF3E CD6DDF          17      CALL    CCHKF
001148 DF41 C8              11      RET Z
001149 DF42 FE2E             7      CP  '.'
00114B DF44 2008            12      JR  NZ,FILE12
00114D DF46 3215EF          13      LD  (FNAME),A   ;Parent directory(..)
001150 DF49 3216EF          13      LD  (FNAME+1),A
001153 DF4C 3E20             7      LD  A,020H
       DF4E                     FILE12:
001155 DF4E FE2A             7      CP  '*'
001157 DF50 280A            12      JR  Z,FILE10
001159 DF52 77               7      LD  (HL),A
00115A DF53 23               6      INC HL
00115B DF54 10E8            13      DJNZ    FILE4L
00115D DF56 C9              10      RET
                                
       DF57                     FILE9:              ;名前の*処理、名前の残りを?で埋める
00115E DF57 CD5CDF          17      CALL    FILE10
001161 DF5A 18D5            12      JR  FILE3
                                
       DF5C                     FILE10:
001163 DF5C 3E3F             7      LD  A,'?'
001165 DF5E 1808            12      JR  FILL_MEMORY
       DF60                     FILEI:              ;名前＋拡張子をスペースで初期化
001167 DF60 3E20             7      LD  A,020H
001169 DF62 01000B          10      LD  BC,11*256   ;C=0にしておく
00116C DF65 2115EF          10      LD  HL,FNAME
       DF68                     FILL_MEMORY:            ;HLからBバイトAで埋める
00116F DF68 77               7      LD  (HL),A
001170 DF69 23               6      INC HL
001171 DF6A 10FC            13      DJNZ    FILL_MEMORY
001173 DF6C C9              10      RET
                                
       DF6D                     CCHKF:
001174 DF6D 1A               7      LD  A,(DE)
001175 DF6E CD75DF          17      CALL    CCHK2
001178 DF71 C8              11      RET Z
001179 DF72 C3DBE2          10      JP  FKAN
                                
       DF75                     CCHK2:
00117C DF75 0C               4      INC C
00117D DF76 0D               4      DEC C
00117E DF77 C0              11      RET NZ
       DF78                     CCHK3:              ;ZF=1 で使えない文字
00117F DF78 FE2B             7      CP  '+'
001181 DF7A C8              11      RET Z
001182 DF7B FE2C             7      CP  ','
001184 DF7D C8              11      RET Z
001185 DF7E FE2F             7      CP  '/'
001187 DF80 C8              11      RET Z
001188 DF81 FE3A             7      CP  ':'
00118A DF83 C8              11      RET Z
00118B DF84 FE3B             7      CP  ';'
00118D DF86 C8              11      RET Z
00118E DF87 FE3D             7      CP  '='
001190 DF89 C8              11      RET Z
001191 DF8A FE5C             7      CP  05CH    ;\
001193 DF8C C8              11      RET Z
001194 DF8D FE20             7      CP  020H
001196 DF8F D0              11      RET NC
001197 DF90 BF               4      CP  A       ;Z=1
001198 DF91 C9              10      RET
                                
       DF92                     SS1:
001199 DF92 13               6      INC DE
       DF93                     SPCUT:              ;スペースをカット
00119A DF93 1A               7      LD  A,(DE)
00119B DF94 FE20             7      CP  020H
00119D DF96 28FA            12      JR  Z,SS1
00119F DF98 C9              10      RET
                                
       DF99                     SETDRVF:
0011A0 DF99 1114EF          10      LD  DE,FDRV
       DF9C                     SETDRV0:
0011A3 DF9C CDA5DF          17      CALL    SETDRV
0011A6 DF9F FDE1            14      POP IY
0011A8 DFA1 C1              10      POP BC
0011A9 DFA2 D1              10      POP DE
0011AA DFA3 E1              10      POP HL
0011AB DFA4 C9              10      RET
                                
       DFA5                     SETDRV:
0011AC DFA5 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
0011AD DFA6 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
0011AE DFA7 C5              11      PUSH    BC
0011AF DFA8 1A               7      LD  A,(DE)
0011B0 DFA9 D5              11      PUSH    DE
0011B1 DFAA FDE3            23      EX  (SP),IY
                                
0011B3 DFAC CDB8DF          17      CALL    GETDRV
0011B6 DFAF 3C               4      INC A
0011B7 DFB0 FD7700          19      LD  (IY+0),A    ;(FCB)ドライブ番号
0011BA DFB3 3D               4      DEC A
0011BB DFB4 CDD9EF          17      CALL    _CHGDRV
                                
0011BE DFB7 E9               4      JP  (HL)
                                
       DFB8                     GETDRV:
0011BF DFB8 E67F             7      AND 07FH
0011C1 DFBA D601             7      SUB 001H
0011C3 DFBC 3003            12      JR  NC,GETDRV1
0011C5 DFBE 3A87EF          13      LD  A,(_DVSW)   ;Current Drive
       DFC1                     GETDRV1:
0011C8 DFC1 3288EF          13      LD  (_DRV),A
0011CB DFC4 C9              10      RET
                                
       DFC5                     SOPENX:
0011CC DFC5 1139EF          10      LD  DE,SFILE
0011CF DFC8 1A               7      LD  A,(DE)
0011D0 DFC9 FDBE00           7      CP  (IY+0)      ;(FCB)ドライブ番号
0011D3 DFCC 2024            12      JR  NZ,SOPEN
0011D5 DFCE 13               6      INC DE
0011D6 DFCF FDE5            15      PUSH    IY
0011D8 DFD1 E1              10      POP HL
0011D9 DFD2 23               6      INC HL
0011DA DFD3 CD60E1          17      CALL    CPFILE
0011DD DFD6 201A            12      JR  NZ,SOPEN
                                
0011DF DFD8 2AF4F0          16      LD  HL,(SCDIR)
0011E2 DFDB FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011E5 DFDE FD740F          19      LD  (IY+15),H
                                
0011E8 DFE1 2AF8F0          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
0011EB DFE4 229FEF          16      LD  (_FILEN),HL
                                
0011EE DFE7 ED5BF6F0        20      LD  DE,(SFBPS)
0011F2 DFEB 2139EF          10      LD  HL,SFILE
0011F5 DFEE 36FF            10      LD  (HL),0FFH
0011F7 DFF0 23               6      INC HL
0011F8 DFF1 C9              10      RET
       DFF2                     SOPEN:
0011F9 DFF2 2108E1          10      LD  HL,FILESE
       DFF5                     SOPENC:
0011FC DFF5 222EE0          16      LD  (OPENPAT+1),HL
                                
0011FF DFF8 CDE2EF          17      CALL    _RDFATX     ;Detect Media
001202 DFFB 3856            12      JR  C,RDDERR
                                
001204 DFFD AF               4      XOR A
001205 DFFE 329FEF          13      LD  (_FILEN),A
001208 E001 CD08E2          17      CALL    LDDIRX1     ;A=0で呼び出す
00120B E004 2818            12      JR  Z,SDIRX1
                                
00120D E006 CDF9E0          17      CALL    READ_DIR    ;Sub Directory
001210 E009 3808            12      JR  C,SDIRX0
001212 E00B 2A7EF0          16      LD  HL,(_DTBUF)
001215 E00E 7E               7      LD  A,(HL)
001216 E00F FE2E             7      CP  '.'
001218 E011 280F            12      JR  Z,SOPEN1
       E013                     SDIRX0:
00121A E013 AF               4      XOR A
00121B E014 32A0EF          13      LD  (_DIRF),A
00121E E017 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
001222 E01B FD770F          19      LD  (IY+15),A
       E01E                     SDIRX1:
001225 E01E ED5BFCF0        20      LD  DE,(_DIRPS) ;Root Directory
       E022                     SOPEN1:
001229 E022 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       E023                     SDECPAT EQU $-1
       E024                     SOPEN1X:
00122B E024 CDF9E0          17      CALL    READ_DIR    ;FILE SEARCH
00122E E027 382A            12      JR  C,RDDERR
001230 E029 2A7EF0          16      LD  HL,(_DTBUF)
       E02C                     SOPEN2:
001233 E02C D5              11      PUSH    DE
001234 E02D CD08E1          17  OPENPAT:CALL    FILESE      ;(self-modifying code)
001237 E030 D1              10      POP DE
001238 E031 386E            12      JR  C,SOPENE
00123A E033 281B            12      JR  Z,SCF_FF_RET
       E035                     SOPEN3:
00123C E035 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
00123F E038 B7               4      OR  A
001240 E039 200C            12      JR  NZ,SOPEN5
001242 E03B 13               6      INC DE      ;ルートディレクトリ
001243 E03C E5              11      PUSH    HL
001244 E03D 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       E03E                     MD_PAT  EQU $-2
001247 E040 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
001249 E042 E1              10      POP HL
00124A E043 20DD            12      JR  NZ,SOPEN1
00124C E045 1807            12      JR  SOPEN6
       E047                     SOPEN5:
00124E E047 CD1DE9          17      CALL    GNCLX       ;END DIR
001251 E04A D8              11      RET C
001252 E04B CDC0E1          17      CALL    ENDCL
       E04E                     SOPEN6:
001255 E04E 38D2            12      JR  C,SOPEN1
       E050                     SCF_FF_RET:
001257 E050 37               4      SCF         ;CF=1
001258 E051 9F               4      SBC A,A     ;A=0FFH
001259 E052 C9              10      RET
                                
       E053                     RDDERR:
00125A E053 BF               4      CP  A       ;READ ERR CF=1 ZF=1
00125B E054 37               4      SCF
00125C E055 C9              10      RET
                                
       E056                     NOPEN:
00125D E056 2108E1          10      LD  HL,FILESE
001260 E059 222EE0          16      LD  (OPENPAT+1),HL
001263 E05C FD2A98EF        20      LD  IY,(_FCB)
001267 E060 CDEEE2          17      CALL    CHKWILDX
00126A E063 30EB            12      JR  NC,SCF_FF_RET
00126C E065 FD7E00          19      LD  A,(IY+0)    ;(FCB)ドライブ番号
00126F E068 3D               4      DEC A
001270 E069 3288EF          13      LD  (_DRV),A
001273 E06C CDD9EF          17      CALL    _CHGDRV
001276 E06F D8              11      RET C
001277 E070 2AF8F0          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
00127A E073 229FEF          16      LD  (_FILEN),HL
                                
00127D E076 CD03E2          17      CALL    LDDIRX
001280 E079 ED5B9AEF        20      LD  DE,(_FBPS)
001284 E07D CDF9E0          17      CALL    READ_DIR
001287 E080 38D1            12      JR  C,RDDERR
001289 E082 3A9EEF          13      LD  A,(_FBCNT)
00128C E085 3D               4      DEC A
00128D E086 28AD            12      JR  Z,SOPEN3
       E088                     NOPEN2:
00128F E088 2A9CEF          16      LD  HL,(_FBAD)
001292 E08B 012000          10      LD  BC,020H
001295 E08E 09              11      ADD HL,BC
001296 E08F 4F               4      LD  C,A
001297 E090 189A            12      JR  SOPEN2
                                
       E092                     SOPENE2:
001299 E092 229CEF          16      LD  (_FBAD),HL
00129C E095 79               4      LD  A,C
00129D E096 329EEF          13      LD  (_FBCNT),A
0012A0 E099 ED539AEF        20      LD  (_FBPS),DE
0012A4 E09D FD2298EF        20      LD  (_FCB),IY
       E0A1                     SOPENE:
0012A8 E0A1 AF               4      XOR A
0012A9 E0A2 C9              10      RET
                                
       E0A3                     COPEN:
0012AA E0A3 FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
0012AE E0A7 2125E1          10      LD  HL,NEXTSE
0012B1 E0AA CDF5DF          17      CALL    SOPENC
0012B4 E0AD D0              11      RET NC
0012B5 E0AE C8              11      RET Z
0012B6 E0AF 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
0012B9 E0B2 B7               4      OR  A
0012BA E0B3 37               4      SCF
0012BB E0B4 C8              11      RET Z       ;ルートディレクトリ
0012BC E0B5 0601             7      LD  B,1
0012BE E0B7 CD4DE3          17      CALL    WRDF
0012C1 E0BA D8              11      RET C
0012C2 E0BB ED5BFEF0        20      LD  DE,(_CLPS)
0012C6 E0BF D5              11      PUSH    DE
0012C7 E0C0 CD89E1          17      CALL    DCPAT
0012CA E0C3 CDA8E7          17      CALL    DRDNX
0012CD E0C6 2A7EF0          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
0012D0 E0C9 3AB2E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
0012D3 E0CC 47               4      LD  B,A
0012D4 E0CD AF               4      XOR A
0012D5 E0CE 4F               4      LD  C,A
       E0CF                     COPENCL:
0012D6 E0CF 77               7      LD  (HL),A
0012D7 E0D0 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0012D9 E0D2 EACFE0          10      JP  PE,COPENCL
                                
0012DC E0D5 3AA7E1          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
0012DF E0D8 3D               4      DEC A
0012E0 E0D9 2819            12      JR  Z,COPENE
0012E2 E0DB 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
0012E4 E0DD 3215E9          13      LD  (_SECPS),A
0012E7 E0E0 D1              10      POP DE      ;DE=(_CLPS)
0012E8 E0E1 D5              11      PUSH    DE
       E0E2                     COPEN1:
0012E9 E0E2 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
0012EA E0E3 C5              11      PUSH    BC
0012EB E0E4 2A7EF0          16      LD  HL,(_DTBUF)
0012EE E0E7 CDA3E1          17      CALL    CLUSTX
0012F1 E0EA CDADEA          17      CALL    DWT24
0012F4 E0ED C1              10      POP BC
0012F5 E0EE D1              10      POP DE
0012F6 E0EF CD14E9          17      CALL    NEXTX
0012F9 E0F2 20EE            12      JR  NZ,COPEN1
       E0F4                     COPENE:
0012FB E0F4 2A7EF0          16      LD  HL,(_DTBUF)
0012FE E0F7 D1              10      POP DE
0012FF E0F8 C9              10      RET
                                
       E0F9                     READ_DIR:
001300 E0F9 ED53FEF0        20      LD  (_CLPS),DE
001304 E0FD C5              11      PUSH    BC
001305 E0FE D5              11      PUSH    DE
001306 E0FF CD89E1          17      CALL    DCPAT
001309 E102 CD88E7          17      CALL    DRDX
00130C E105 D1              10      POP DE
00130D E106 C1              10      POP BC
00130E E107 C9              10      RET
                                
       E108                     FILESE:
00130F E108 7E               7      LD  A,(HL)
001310 E109 B7               4      OR  A
001311 E10A C8              11      RET Z       ;END:ZF=1 CF=0
001312 E10B FEE5             7      CP  0E5H
001314 E10D 280E            12      JR  Z,FILESE1
001316 E10F FDE5            15      PUSH    IY
001318 E111 D1              10      POP DE
001319 E112 13               6      INC DE
00131A E113 E5              11      PUSH    HL
00131B E114 CD60E1          17      CALL    CPFILE
00131E E117 CC81E1          17      CALL    Z,CPFILE2
001321 E11A E1              10      POP HL
001322 E11B 37               4      SCF
001323 E11C C8              11      RET Z       ;!!!:(ZF=1) CF=1
       E11D                     FILESE1:
001324 E11D CD34E1          17      CALL    FNEXT
001327 E120 20E6            12      JR  NZ,FILESE
       E122                     ZF0_CF0_AFF_RET:
001329 E122 F6FF             7      OR  0FFH        ;ZF=0 CF=0
00132B E124 C9              10      RET
                                
       E125                     NEXTSE:
00132C E125 7E               7      LD  A,(HL)
00132D E126 B7               4      OR  A
00132E E127 37               4      SCF
00132F E128 C8              11      RET Z       ;!!!:ZF=1 CF=1
001330 E129 FEE5             7      CP  0E5H
001332 E12B 37               4      SCF
001333 E12C C8              11      RET Z       ;!!!:(ZF=1) CF=1
001334 E12D CD34E1          17      CALL    FNEXT
001337 E130 20F3            12      JR  NZ,NEXTSE
001339 E132 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       E134                     FNEXT:
00133B E134 E5              11      PUSH    HL
00133C E135 219FEF          10      LD  HL,_FILEN
00133F E138 34              11      INC (HL)
001340 E139 E1              10      POP HL
001341 E13A 112000          10      LD  DE,020H
001344 E13D 19              11      ADD HL,DE
001345 E13E 0D               4      DEC C
001346 E13F C9              10      RET
                                
       E140                     CPNAME:
001347 E140 C5              11      PUSH    BC
001348 E141 D5              11      PUSH    DE
001349 E142 E5              11      PUSH    HL
00134A E143 CD5AE1          17      CALL    CPFILE4
00134D E146 E1              10      POP HL
00134E E147 23               6      INC HL
00134F E148 23               6      INC HL
001350 E149 23               6      INC HL
001351 E14A 23               6      INC HL
001352 E14B D1              10      POP DE
001353 E14C C1              10      POP BC
001354 E14D 2005            12      JR  NZ,CPNAME1
001356 E14F 7E               7      LD  A,(HL)
001357 E150 23               6      INC HL
001358 E151 66               7      LD  H,(HL)
001359 E152 6F               4      LD  L,A
00135A E153 C9              10      RET
       E154                     CPNAME1:
00135B E154 23               6      INC HL
00135C E155 23               6      INC HL
00135D E156 10E8            13      DJNZ    CPNAME
00135F E158 37               4      SCF
001360 E159 C9              10      RET
                                
       E15A                     CPFILE4:
001361 E15A C5              11      PUSH    BC
001362 E15B 010004          10      LD  BC,00400H
001365 E15E 1804            12      JR  CPSTR1
       E160                     CPFILE:
001367 E160 C5              11      PUSH    BC
001368 E161 01000B          10      LD  BC,00B00H
       E164                     CPSTR1:
00136B E164 1A               7      LD  A,(DE)
00136C E165 FE3F             7      CP  '?'     ;Wild card
00136E E167 2812            12      JR  Z,CPSTR2
001370 E169 7E               7      LD  A,(HL)
001371 E16A CDD4E2          17      CALL    FKANC
001374 E16D E5              11      PUSH    HL
001375 E16E 67               4      LD  H,A
001376 E16F 1A               7      LD  A,(DE)
001377 E170 CB01             4      RLC C
001379 E172 CDD4E2          17      CALL    FKANC
00137C E175 CB09             4      RRC C
00137E E177 BC               4      CP  H       ;CP (HL),(DE)
00137F E178 E1              10      POP HL
001380 E179 2004            12      JR  NZ,CPSTR3
       E17B                     CPSTR2:
001382 E17B 13               6      INC DE
001383 E17C 23               6      INC HL
001384 E17D 10E5            13      DJNZ    CPSTR1
       E17F                     CPSTR3:
001386 E17F C1              10      POP BC
001387 E180 C9              10      RET
                                
       E181                     CPFILE2:
001388 E181 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
00138B E184 F6E1             7      OR  0E1H
00138D E186 2F               4      CPL
00138E E187 A6               7      AND (HL)
00138F E188 C9              10      RET
                                
       E189                     DCPAT:
001390 E189 0E00             7      LD  C,0
001392 E18B 2A7EF0          16      LD  HL,(_DTBUF)
001395 E18E 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
001398 E191 B7               4      OR  A
001399 E192 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
00139A E193 3AA7E1          13      LD  A,(SPCPAT)
00139D E196 4F               4      LD  C,A
00139E E197 3A15E9          13      LD  A,(_SECPS)
0013A1 E19A B9               4      CP  C
0013A2 E19B 3801            12      JR  C,DC1
0013A4 E19D AF               4      XOR A
       E19E                     DC1:
0013A5 E19E F680             7      OR  080H
0013A7 E1A0 32A0EF          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       E1A3                     CLUSTX:
0013AA E1A3 E5              11      PUSH    HL
0013AB E1A4 EB               4      EX  DE,HL
0013AC E1A5 AF               4      XOR A
0013AD E1A6 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       E1A7                     SPCPAT  EQU $-1
       E1A8                     L_CLDBL:
0013AF E1A8 CB19             8      RR  C       ;->CF
0013B1 E1AA 3804            12      JR  C,E_CLDBL
0013B3 E1AC 29              11      ADD HL,HL       ;*2
0013B4 E1AD 8F               4      ADC A,A
0013B5 E1AE 18F8            12      JR  L_CLDBL
       E1B0                     E_CLDBL:
0013B7 E1B0 4F               4      LD  C,A
0013B8 E1B1 3A15E9          13      LD  A,(_SECPS)
0013BB E1B4 B5               4      OR  L
0013BC E1B5 6F               4      LD  L,A
0013BD E1B6 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       E1B7                     CLSPAT  EQU $-2
0013C0 E1B9 AF               4      XOR A
0013C1 E1BA 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
0013C2 E1BB 89               4      ADC A,C
0013C3 E1BC 4F               4      LD  C,A
0013C4 E1BD EB               4      EX  DE,HL
0013C5 E1BE E1              10      POP HL
0013C6 E1BF C9              10      RET
                                
       E1C0                     ENDCL:
0013C7 E1C0 7A               4      LD  A,D ;END CLUSTER
0013C8 E1C1 FE01             7      CP  1   ;164=356    (self-modifying code)
       E1C2                     CLPAT1  EQU $-1
0013CA E1C3 C0              11      RET NZ
0013CB E1C4 7B               4      LD  A,E
0013CC E1C5 FE64             7      CP  064H    ;       (self-modifying code)
       E1C6                     CLPAT2  EQU $-1
0013CE E1C7 C9              10      RET
                                
       E1C8                     CAP:
0013CF E1C8 FE61             7      CP  'a'
0013D1 E1CA D8              11      RET C
0013D2 E1CB FE7B             7      CP  'z'+1
0013D4 E1CD D0              11      RET NC
0013D5 E1CE D620             7      SUB 020H
0013D7 E1D0 C9              10      RET
       E1D1                     CAP2:
0013D8 E1D1 CDC8E1          17      CALL    CAP
       E1D4                     CAP3:               ;
0013DB E1D4 FE05             7      CP  5
0013DD E1D6 2803            12      JR  Z,CAP4
0013DF E1D8 FE21             7      CP  021H
0013E1 E1DA C9              10      RET
       E1DB                     CAP4:
0013E2 E1DB 3EE5             7      LD  A,0E5H
0013E4 E1DD C9              10      RET
                                
       E1DE                     CHDIR:
0013E5 E1DE CDDBEB          17      CALL    GETDPBD
0013E8 E1E1 381D            12      JR  C,CHDIR2
0013EA E1E3 DD751A          19      LD  (IX+DPB_SDIR),L
0013ED E1E6 DD741B          19      LD  (IX+DPB_SDIR+1),H
0013F0 E1E9 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       E1EB                     LDDIR:
0013F2 E1EB CDDBEB          17      CALL    GETDPBD
0013F5 E1EE DD5E1A          19      LD  E,(IX+DPB_SDIR)
0013F8 E1F1 DD561B          19      LD  D,(IX+DPB_SDIR+1)
0013FB E1F4 13               6      INC DE
0013FC E1F5 FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0013FF E1F8 FD720F          19      LD  (IY+15),D
001402 E1FB 1B               6      DEC DE
001403 E1FC AF               4      XOR A
001404 E1FD 32A0EF          13      LD  (_DIRF),A
       E200                     CHDIR2:
001407 E200 DDE1            14      POP IX
001409 E202 C9              10      RET
                                
       E203                     LDDIRX:
00140A E203 3AA0EF          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
00140D E206 E67F             7      AND 07FH
       E208                     LDDIRX1:
00140F E208 3215E9          13      LD  (_SECPS),A
001412 E20B FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
001415 E20E FD560F          19      LD  D,(IY+15)
001418 E211 1B               6      DEC DE
001419 E212 CDC0E1          17      CALL    ENDCL
00141C E215 D4EBE1          17      CALL    NC,LDDIR
       E218                     LDDIRS:
00141F E218 7A               4      LD  A,D
001420 E219 B3               4      OR  E
001421 E21A 32A0EF          13      LD  (_DIRF),A   ;ディレクトリか判別
001424 E21D C9              10      RET
                                
       E21E                     KILL:
001425 E21E CDEEE2          17      CALL    CHKWILDX
001428 E221 3834            12      JR  C,KILLW
00142A E223 CDC5DF          17      CALL    SOPENX
       E226                     KILLS:
00142D E226 3E1F             7      LD  A,01FH
00142F E228 D46AE2          17      CALL    NC,CHKATT
001432 E22B D8              11      RET C
       E22C                     KILLSX:
001433 E22C 36E5            10      LD  (HL),0E5H   ;DIR
001435 E22E CDC8E2          17      CALL    WTDB
001438 E231 111A00          10      LD  DE,01AH
00143B E234 19              11      ADD HL,DE
00143C E235 5E               7      LD  E,(HL)
00143D E236 23               6      INC HL
00143E E237 56               7      LD  D,(HL)
       E238                     KILLS1:
00143F E238 CDC0E1          17      CALL    ENDCL
001442 E23B D0              11      RET NC      ;CF=0
001443 E23C 21FEFF          10      LD  HL,0-2
001446 E23F 19              11      ADD HL,DE
001447 E240 D0              11      RET NC      ;DE= 0 or 1
001448 E241 D5              11      PUSH    DE
001449 E242 CDF7EF          17      CALL    _GNCL
00144C E245 ED53FEF0        20      LD  (_CLPS),DE
001450 E249 D1              10      POP DE
001451 E24A 210000          10      LD  HL,0
001454 E24D D4FAEF          17      CALL    NC,_SNCL
001457 E250 D8              11      RET C
001458 E251 ED5BFEF0        20      LD  DE,(_CLPS)  ;FAT
00145C E255 18E1            12      JR  KILLS1
                                
       E257                     KILLW:
00145E E257 CDF2DF          17      CALL    SOPEN
       E25A                     KILLW1:
001461 E25A 380B            12      JR  C,KILLW2
001463 E25C CD92E0          17      CALL    SOPENE2
001466 E25F CD26E2          17      CALL    KILLS
001469 E262 CD56E0          17      CALL    NOPEN
00146C E265 18F3            12      JR  KILLW1
       E267                     KILLW2:
00146E E267 C8              11      RET Z
00146F E268 3F               4      CCF
001470 E269 C9              10      RET
                                
       E26A                     CHKATT:
001471 E26A E5              11      PUSH    HL
001472 E26B 110B00          10      LD  DE,00BH
001475 E26E 19              11      ADD HL,DE
001476 E26F A6               7      AND (HL)
001477 E270 E1              10      POP HL
001478 E271 C8              11      RET Z
001479 E272 37               4      SCF
00147A E273 C9              10      RET
                                
       E274                     NAME:
00147B E274 CDEEE2          17      CALL    CHKWILDX
00147E E277 D8              11      RET C
00147F E278 110400          10      LD  DE,4
001482 E27B 19              11      ADD HL,DE
001483 E27C 2294E2          16      LD  (NAMEP+2),HL
001486 E27F 23               6      INC HL
001487 E280 CDF2E2          17      CALL    CHKWILD
00148A E283 D8              11      RET C
                                
00148B E284 CDC5DF          17      CALL    SOPENX
00148E E287 3E0F             7      LD  A,00FH
001490 E289 D46AE2          17      CALL    NC,CHKATT
001493 E28C D8              11      RET C
                                
001494 E28D FD7E00          19      LD  A,(IY+0)
001497 E290 FDE5            15      PUSH    IY
001499 E292 FD210000        14  NAMEP:  LD  IY,0        ;自己書き換え
00149D E296 FD7700          19      LD  (IY+0),A
0014A0 E299 CDC5DF          17      CALL    SOPENX
0014A3 E29C FDE3            23      EX  (SP),IY
0014A5 E29E 3F               4      CCF
0014A6 E29F D4F2DF          17      CALL    NC,SOPEN
0014A9 E2A2 EB               4      EX  DE,HL
0014AA E2A3 E1              10      POP HL
0014AB E2A4 D8              11      RET C
                                
       E2A5                     SETNAME:
0014AC E2A5 01000B          10      LD  BC,11*256
0014AF E2A8 23               6      INC HL
0014B0 E2A9 7E               7      LD  A,(HL)
0014B1 E2AA FEE5             7      CP  0E5H
0014B3 E2AC 2004            12      JR  NZ,SNAME1
0014B5 E2AE 3E05             7      LD  A,5
0014B7 E2B0 180E            12      JR  SNAME3
       E2B2                     SNAME1:
0014B9 E2B2 7E               7      LD  A,(HL)
0014BA E2B3 0C               4      INC C
0014BB E2B4 0D               4      DEC C
0014BC E2B5 2009            12      JR  NZ,SNAME3
0014BE E2B7 CDC8E1          17      CALL    CAP
0014C1 E2BA FEA0             7      CP  0A0H
0014C3 E2BC 2002            12      JR  NZ,SNAME3
0014C5 E2BE 3E20             7      LD  A,020H
       E2C0                     SNAME3:
0014C7 E2C0 12               7      LD  (DE),A
0014C8 E2C1 7E               7      LD  A,(HL)
0014C9 E2C2 23               6      INC HL
0014CA E2C3 CDDBE2          17      CALL    FKAN
0014CD E2C6 10EA            13      DJNZ    SNAME1
       E2C8                     WTDB:
0014CF E2C8 3EFF             7      LD  A,0FFH
0014D1 E2CA 3239EF          13      LD  (SFILE),A
       E2CD                     SWTDBF:
0014D4 E2CD 3E01             7      LD  A,1
0014D6 E2CF 32A4EF          13      LD  (_WTDBF),A
0014D9 E2D2 AF               4      XOR A
0014DA E2D3 C9              10      RET
                                
       E2D4                     FKANC:
0014DB E2D4 CB41             8      BIT 0,C
0014DD E2D6 CCD1E1          17      CALL    Z,CAP2
0014E0 E2D9 1801            12      JR  FKANX
       E2DB                     FKAN:           ;漢字チェック
0014E2 E2DB 13               6      INC DE
       E2DC                     FKANX:
0014E3 E2DC CB41             8      BIT 0,C
0014E5 E2DE CB81             8      RES 0,C
0014E7 E2E0 C0              11      RET NZ
0014E8 E2E1 FE80             7      CP  080H
0014EA E2E3 D8              11      RET C
0014EB E2E4 FEA0             7      CP  0A0H
0014ED E2E6 3803            12      JR  C,FKAN1
0014EF E2E8 FEE0             7      CP  0E0H
0014F1 E2EA D8              11      RET C
       E2EB                     FKAN1:
0014F2 E2EB 0C               4      INC C
0014F3 E2EC A7               4      AND A
0014F4 E2ED C9              10      RET
                                
       E2EE                     CHKWILDX:
0014F5 E2EE FDE5            15      PUSH    IY
0014F7 E2F0 E1              10      POP HL
0014F8 E2F1 23               6      INC HL
       E2F2                     CHKWILD:
0014F9 E2F2 060B             7      LD  B,11
0014FB E2F4 3E3F             7      LD  A,'?'
       E2F6                     CHKWIL1:
0014FD E2F6 BE               7      CP  (HL)
0014FE E2F7 23               6      INC HL
0014FF E2F8 37               4      SCF
001500 E2F9 C8              11      RET Z
001501 E2FA 10FA            13      DJNZ    CHKWIL1
001503 E2FC AF               4      XOR A
001504 E2FD C9              10      RET
                                
       E2FE                     SDIRENT:        ;IY=FCB HL=DIR
001505 E2FE D5              11      PUSH    DE
001506 E2FF E5              11      PUSH    HL
001507 E300 FDE5            15      PUSH    IY
001509 E302 D1              10      POP DE
00150A E303 EB               4      EX  DE,HL
00150B E304 CDA5E2          17      CALL    SETNAME
                                ;               Attribute
00150E E307 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001511 E30A 12               7      LD  (DE),A
001512 E30B 13               6      INC DE
                                ;               Reserved
001513 E30C AF               4      XOR A
001514 E30D 060A             7      LD  B,10
       E30F                     SDE1:
001516 E30F 12               7      LD  (DE),A
001517 E310 13               6      INC DE
001518 E311 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
00151A E313 21E4F0          10      LD  HL,SDDATA       ;(FCB)更新年月日
00151D E316 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       E318                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
00151F E318 7E               7      LD  A,(HL)
001520 E319 23               6      INC HL
001521 E31A 321FE3          13      LD  (SDPAT+2),A
001524 E31D FD7E00          19  SDPAT:  LD  A,(IY+0)    ;LD A,(IY+A)
001527 E320 12               7      LD  (DE),A
001528 E321 13               6      INC DE
001529 E322 10F4            13      DJNZ    SDLOOP
                                
00152B E324 AF               4      XOR A
00152C E325 E1              10      POP HL
00152D E326 D1              10      POP DE
00152E E327 C9              10      RET
                                
       E328                     WOPEN:
00152F E328 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001532 E32B E61F             7      AND 01FH
001534 E32D 37               4      SCF
001535 E32E C0              11      RET NZ
001536 E32F FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E333                     TOPEN2:
00153A E333 AF               4      XOR A
       E334                     TOPEN:              ;Initializes the time stamp
00153B E334 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
00153F E338 C9              10      RET
                                
       E339                     WRDFX:
001540 E339 3AA7E1          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       E33C                     L_WRFX:
001543 E33C 1F               4      RRA         ;->CF
001544 E33D 3806            12      JR  C,E_WRFX
001546 E33F CB39             8      SRL C
001548 E341 CB1C             8      RR  H       ;CH=CH/2
00154A E343 18F7            12      JR  L_WRFX
       E345                     E_WRFX:
00154C E345 41               4      LD  B,C
00154D E346 4C               4      LD  C,H
00154E E347 03               6      INC BC
00154F E348 3E37             7      LD  A,037H      ;SCF
001551 E34A 32A5E7          13      LD  (DRDN1),A
                                
       E34D                     WRDF:               ;BCクラスタ分FATを確保する
001554 E34D 110200          10      LD  DE,2
001557 E350 AF               4      XOR A
001558 E351 3215E9          13      LD  (_SECPS),A
       E354                     WRDF1:
00155B E354 C5              11      PUSH    BC
00155C E355 D5              11      PUSH    DE
00155D E356 CDF7EF          17      CALL    _GNCL
001560 E359 381C            12      JR  C,WRDF3
001562 E35B 7A               4      LD  A,D     ;空いているかチェック
001563 E35C B3               4      OR  E
001564 E35D 202A            12      JR  NZ,WRDF4
001566 E35F E1              10      POP HL      ;HL=空いているクラスタ
001567 E360 E5              11      PUSH    HL
001568 E361 ED5BFEF0        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
00156C E365 22FEF0          16      LD  (_CLPS),HL
00156F E368 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
001570 E369 B3               4      OR  E
001571 E36A 2008            12      JR  NZ,WRDF2
001573 E36C FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
001576 E36F FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
001579 E372 1803            12      JR  WRDF3
       E374                     WRDF2:
00157B E374 CDFAEF          17      CALL    _SNCL
       E377                     WRDF3:
00157E E377 D1              10      POP DE
00157F E378 C1              10      POP BC
001580 E379 D8              11      RET C
001581 E37A 0B               6      DEC BC
001582 E37B 78               4      LD  A,B
001583 E37C B1               4      OR  C
001584 E37D 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
001586 E37F ED5BFEF0        20      LD  DE,(_CLPS)
00158A E383 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
00158D E386 C3FAEF          10      JP  _SNCL
                                
       E389                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
001590 E389 D1              10      POP DE
001591 E38A C1              10      POP BC
       E38B                     WRDF5:
001592 E38B 13               6      INC DE
001593 E38C CDC0E1          17      CALL    ENDCL
001596 E38F 38C3            12      JR  C,WRDF1
001598 E391 37               4      SCF
001599 E392 C9              10      RET
                                
       E393                     RWXR:
00159A E393 3AB2E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E396                     L_RWX:
00159D E396 1F               4      RRA     ;->CF
00159E E397 3808            12      JR  C,E_RWX
0015A0 E399 CB38             8      SRL B   ;BCH=BCH/2
0015A2 E39B CB19             8      RR  C   ;
0015A4 E39D CB1C             8      RR  H   ;
0015A6 E39F 18F5            12      JR  L_RWX
       E3A1                     E_RWX:
0015A8 E3A1 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0015AB E3A4 FD561B          19      LD  D,(IY+27)
0015AE E3A7 AF               4      XOR A
0015AF E3A8 3215E9          13      LD  (_SECPS),A
       E3AB                     RWX1:
0015B2 E3AB ED53FEF0        20      LD  (_CLPS),DE
0015B6 E3AF 7A               4      LD  A,D
0015B7 E3B0 B3               4      OR  E
0015B8 E3B1 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
0015BA E3B3 78               4      LD  A,B
0015BB E3B4 B1               4      OR  C
0015BC E3B5 B4               4      OR  H
0015BD E3B6 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
0015BE E3B7 CD1DE9          17      CALL    GNCLX
0015C1 E3BA D8              11      RET C
0015C2 E3BB 7C               4      LD  A,H     ;
0015C3 E3BC 25               4      DEC H       ;
0015C4 E3BD B7               4      OR  A       ;DEC BCH
0015C5 E3BE 2001            12      JR  NZ,RWX2     ;
0015C7 E3C0 0B               6      DEC BC      ;
       E3C1                     RWX2:
0015C8 E3C1 CDC0E1          17      CALL    ENDCL
0015CB E3C4 38E5            12      JR  C,RWX1
       E3C6                     SCF_RET:
0015CD E3C6 37               4      SCF
0015CE E3C7 C9              10      RET
                                
       E3C8                     DSKF:
0015CF E3C8 110000          10      LD  DE,0
       E3C9                     MAXCLP  EQU $-2
0015D2 E3CB 2AACEF          16      LD  HL,(_FAKEFREE)
0015D5 E3CE 7C               4      LD  A,H
0015D6 E3CF B5               4      OR  L
0015D7 E3D0 2803            12      JR  Z,DSKF1
0015D9 E3D2 110100          10      LD  DE,1
       E3D5                     DSKF1:
0015DC E3D5 D5              11      PUSH    DE
0015DD E3D6 CDF7EF          17      CALL    _GNCL
0015E0 E3D9 380C            12      JR  C,POPSCF
0015E2 E3DB 7A               4      LD  A,D
0015E3 E3DC B3               4      OR  E
0015E4 E3DD 2001            12      JR  NZ,DSKF2
0015E6 E3DF 23               6      INC HL
       E3E0                     DSKF2:
0015E7 E3E0 D1              10      POP DE
0015E8 E3E1 1B               6      DEC DE
0015E9 E3E2 7A               4      LD  A,D
0015EA E3E3 B3               4      OR  E
0015EB E3E4 20EF            12      JR  NZ,DSKF1
0015ED E3E6 C9              10      RET
                                
       E3E7                     POPSCF:
0015EE E3E7 F1              10      POP AF
0015EF E3E8 37               4      SCF
0015F0 E3E9 C9              10      RET
                                
       E3EA                     SETTMS:
0015F1 E3EA FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
0015F4 E3ED 3C               4      INC A
0015F5 E3EE C0              11      RET NZ      ;ファイルが更新されていない
       E3EF                     SETTMSX:            ;FCBに日付時刻をセットする
0015F6 E3EF CD82DA          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
0015F9 E3F2 CB25             8      SLA L       ;   *2
0015FB E3F4 CB25             8      SLA L       ;   *4
0015FD E3F6 29              11      ADD HL,HL       ;*2 *8
0015FE E3F7 29              11      ADD HL,HL       ;*4 *16
0015FF E3F8 29              11      ADD HL,HL       ;*8 *32
001600 E3F9 7A               4      LD  A,D
001601 E3FA 0F               4      RRCA            ;bit.0->7->->->0->C
001602 E3FB E61F             7      AND 01FH
001604 E3FD B5               4      OR  L
001605 E3FE FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
001608 E401 FD7417          19      LD  (IY+23),H
                                
00160B E404 CD5BDA          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
00160E E407 0144F8          10      LD  BC,0-1980
001611 E40A 09              11      ADD HL,BC
001612 E40B 65               4      LD  H,L
                                
001613 E40C 7A               4      LD  A,D
001614 E40D 87               4      ADD A,A     ;*2
001615 E40E 87               4      ADD A,A     ;*4
001616 E40F 87               4      ADD A,A     ;*8
001617 E410 87               4      ADD A,A     ;*16
001618 E411 6F               4      LD  L,A
001619 E412 29              11      ADD HL,HL       ;*32
00161A E413 7D               4      LD  A,L
00161B E414 B3               4      OR  E
00161C E415 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
00161F E418 FD7415          19      LD  (IY+21),H
001622 E41B C9              10      RET
                                
       E41C                     PUSHRR:
001623 E41C 32B4E4          13      LD  (SETSEQ_SWC_RND),A
001626 E41F 22C6E4          16      LD  (SETSEQ_SWC_SEQ_RR),HL
001629 E422 CD42E4          17      CALL    GET_RR_AHL
00162C E425 220FEF          16      LD  (RR_BUF_HL),HL
00162F E428 3211EF          13      LD  (RR_BUF_A),A
001632 E42B C9              10      RET
                                
       E42C                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
001633 E42C 87               4      ADD A,A     ;in BHLA => out AHL
001634 E42D ED6A            15      ADC HL,HL
001636 E42F CB18             8      RR  B
001638 E431 B7               4      OR  A
001639 E432 78               4      LD  A,B     ;ここでフラグは変化しない
00163A E433 C8              11      RET Z
00163B E434 2C               4      INC L       ;INC AHL
00163C E435 C0              11      RET NZ      ;
00163D E436 24               4      INC H       ;
00163E E437 C0              11      RET NZ      ;
00163F E438 3C               4      INC A       ;
001640 E439 C9              10      RET
                                
       E43A                     INIT_RND:
001641 E43A 3ECD             7      LD  A,0CDH      ;CALL ????
001643 E43C 2189E4          10      LD  HL,POPRR
001646 E43F CD1CE4          17      CALL    PUSHRR
       E442                     GET_RR_AHL:
001649 E442 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00164C E445 FD6622          19      LD  H,(IY+34)   ;
00164F E448 FD7E23          19      LD  A,(IY+35)   ;
001652 E44B C9              10      RET
       E44C                     SET_RR_AHL:
001653 E44C FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001656 E44F FD7422          19      LD  (IY+34),H
001659 E452 FD7723          19      LD  (IY+35),A
00165C E455 C9              10      RET
       E456                     INIT_SEQ:
00165D E456 3E01             7      LD  A,1     ;LD BC,????
00165F E458 2186E4          10      LD  HL,SETSEQ
001662 E45B CD1CE4          17      CALL    PUSHRR
       E45E                     GETSEQ:
001665 E45E FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
001668 E461 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
00166B E464 AF               4      XOR A
                                
00166C E465 CB25             8      SLA L   ;L=L*2
                                
00166E E467 CB3C             8      SRL H   ;HL=HL/2
001670 E469 CB1D             8      RR  L   ;
001672 E46B C9              10      RET
                                
       E46C                     SETSEQ1:
001673 E46C F5              11      PUSH    AF
001674 E46D E5              11      PUSH    HL      ;AHL=Random record
001675 E46E CD42E4          17      CALL    GET_RR_AHL
001678 E471 47               4      LD  B,A     ;AHL→HLA
001679 E472 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
00167A E473 6C               4      LD  L,H     ;(IY+34)
00167B E474 60               4      LD  H,B     ;(IY+35)
00167C E475 0600             7      LD  B,0
                                
00167E E477 CD2CE4          17      CALL    GET_CPM_R_SIZE
                                
001681 E47A 29              11      ADD HL,HL
001682 E47B CB3D             8      SRL L       ;L=L/2
001684 E47D FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
001687 E480 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
00168A E483 E1              10      POP HL
00168B E484 F1              10      POP AF
00168C E485 C9              10      RET
       E486                     SETSEQ:
00168D E486 CD6CE4          17      CALL    SETSEQ1
       E489                     POPRR:
001690 E489 F5              11      PUSH    AF
001691 E48A E5              11      PUSH    HL
001692 E48B 2A0FEF          16      LD  HL,(RR_BUF_HL)
001695 E48E 3A11EF          13      LD  A,(RR_BUF_A)
001698 E491 CD4CE4          17      CALL    SET_RR_AHL
00169B E494 E1              10      POP HL
00169C E495 F1              10      POP AF
00169D E496 C9              10      RET
                                
       E497                     RB_WRITE:
00169E E497 C5              11      PUSH    BC
00169F E498 ED4B4CF0        20      LD  BC,(STABLE+2*026H)  ;(BDOS)ランダムブロック書き込み
0016A3 E49C 1805            12      JR  RBRW
       E49E                     RB_READ:
0016A5 E49E C5              11      PUSH    BC
0016A6 E49F ED4B4EF0        20      LD  BC,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       E4A3                     RBRW:
0016AA E4A3 1F               4      RRA     ;AHL = AHL*128
0016AB E4A4 7C               4      LD  A,H ;AHL = AHL0/2
0016AC E4A5 1F               4      RRA     ;A
0016AD E4A6 65               4      LD  H,L ;
0016AE E4A7 CB1C             8      RR  H   ;H
0016B0 E4A9 2E00             7      LD  L,0 ;
0016B2 E4AB CB1D             8      RR  L   ;L
0016B4 E4AD CD4CE4          17      CALL    SET_RR_AHL
0016B7 E4B0 218000          10      LD  HL,128
0016BA E4B3 C5              11      PUSH    BC
       E4B4                     SETSEQ_SWC_RND:
0016BB E4B4 CD6CE4          17      CALL    SETSEQ1
0016BE E4B7 C1              10      POP BC
0016BF E4B8 FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
0016C3 E4BC FDE5            15      PUSH    IY
0016C5 E4BE D1              10      POP DE
0016C6 E4BF D5              11      PUSH    DE
0016C7 E4C0 CDCEE4          17      CALL    JP_BC
0016CA E4C3 FDE1            14      POP IY
0016CC E4C5 CD86E4          17      CALL    SETSEQ
       E4C6                     SETSEQ_SWC_SEQ_RR   EQU $-2
0016CF E4C8 FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
0016D3 E4CC C1              10      POP BC
0016D4 E4CD C9              10      RET
       E4CE                     JP_BC:
0016D5 E4CE C5              11      PUSH    BC
0016D6 E4CF C9              10      RET
                                
       E050                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       E050                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       E050                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       E050                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       E050                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E4D0                     _SYS26:     ;(BDOS)ランダムブロック書き込み
0016D7 E4D0 AF               4      XOR A
0016D8 E4D1 32A5E7          13      LD  (DRDN1),A   ;NOP
0016DB E4D4 22F5E6          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
0016DE E4D7 225DEF          16      LD  (LEFTX),HL
0016E1 E4DA CDA5DF          17      CALL    SETDRV
                                
0016E4 E4DD CD4DE6          17      CALL    RBX0
0016E7 E4E0 DA6DE5          10      JP  C,RBWERR
0016EA E4E3 CD28E3          17      CALL    WOPEN
0016ED E4E6 DA6DE5          10      JP  C,RBWERR
0016F0 E4E9 7C               4      LD  A,H
0016F1 E4EA B5               4      OR  L
0016F2 E4EB CA66E5          10      JP  Z,RBW1
                                
0016F5 E4EE 2B               6      DEC HL
                                
0016F6 E4EF CD0BE7          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0016F9 E4F2 19              11      ADD HL,DE       ;BCHL=HL+BCDE
0016FA E4F3 3001            12      JR  NC,S26X1    ;
0016FC E4F5 03               6      INC BC      ;
       E4F6                     S26X1:
0016FD E4F6 CD93E3          17      CALL    RWXR
001700 E4F9 DC39E3          17      CALL    C,WRDFX
001703 E4FC DA6DE5          10      JP  C,RBWERR
                                
001706 E4FF CD7CE6          17      CALL    RBX2
001709 E502 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
00170B E504 CD9BE6          17      CALL    RBXA
00170E E507 3864            12      JR  C,RBWERR
001710 E509 EB               4      EX  DE,HL
001711 E50A C5              11      PUSH    BC
001712 E50B EDB0                    LDIR
001714 E50D 225FEF          16      LD  (DTAX),HL
                                
001717 E510 CDCDE2          17      CALL    SWTDBF      ;バッファデータは更新された
                                
00171A E513 2A5DEF          16      LD  HL,(LEFTX)
00171D E516 D1              10      POP DE
00171E E517 ED52            15      SBC HL,DE
001720 E519 225DEF          16      LD  (LEFTX),HL
001723 E51C 2831            12      JR  Z,RBWEND
                                
       E51E                     RBWB:
001725 E51E CDD0E6          17      CALL    RBXB
001728 E521 2814            12      JR  Z,RBWC
       E523                     RBWB1:
00172A E523 C5              11      PUSH    BC
00172B E524 D5              11      PUSH    DE
00172C E525 CDA3E1          17      CALL    CLUSTX
00172F E528 CD1FE7          17      CALL    DWTC
001732 E52B D1              10      POP DE
001733 E52C C1              10      POP BC
001734 E52D D41DE9          17      CALL    NC,GNCLX
001737 E530 383B            12      JR  C,RBWERR
001739 E532 10EF            13      DJNZ    RBWB1
00173B E534 CD6FE7          17      CALL    DRW_FLUSH
       E537                     RBWC:
00173E E537 CDE8E6          17      CALL    RBXC
001741 E53A 2813            12      JR  Z,RBWEND
001743 E53C C5              11      PUSH    BC
001744 E53D CDA3E1          17      CALL    CLUSTX
001747 E540 CDA4E7          17      CALL    DRDN
00174A E543 C1              10      POP BC
00174B E544 3827            12      JR  C,RBWERR
00174D E546 ED5B7EF0        20      LD  DE,(_DTBUF)
001751 E54A EDB0                    LDIR
001753 E54C CDCDE2          17      CALL    SWTDBF      ;バッファデータは更新された
       E54F                     RBWEND:
001756 E54F CDF4E6          17      CALL    RBXEND
                                
001759 E552 CD5CE6          17      CALL    RBX1
00175C E555 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
00175E E557 CD0BE7          17      CALL    GET_RR_BCDE ;BCDE=Random record
001761 E55A FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
001764 E55D FD7211          19      LD  (IY+17),D   ;
001767 E560 FD7112          19      LD  (IY+18),C   ;
00176A E563 FD7013          19      LD  (IY+19),B   ;
       E566                     RBW1:
00176D E566 FDE1            14      POP IY
00176F E568 C1              10      POP BC
001770 E569 D1              10      POP DE
001771 E56A E1              10      POP HL
       E56B                     DD_NUL:
001772 E56B AF               4      XOR A
       E56C                     DRDF0:
       E56C                     DWTF0:
001773 E56C C9              10      RET
                                
       E56D                     RBWERR:
001774 E56D FDE5            15      PUSH    IY
001776 E56F D1              10      POP DE
001777 E570 2A20F0          16      LD  HL,(STABLE+2*010H)
00177A E573 CD0F00          17      CALL    JP_HL
       E576                     RBRERR1:
00177D E576 3E01             7      LD  A,001H
       E578                     RBRERR2:
00177F E578 FDE1            14      POP IY
001781 E57A C1              10      POP BC
001782 E57B D1              10      POP DE
001783 E57C E1              10      POP HL
001784 E57D 37               4      SCF
001785 E57E 210000          10      LD  HL,0
001788 E581 C9              10      RET
                                
       E582                     RBRERR:
001789 E582 3EFF             7      LD  A,0FFH
00178B E584 18F2            12      JR  RBRERR2
                                
       E586                     RBRFL:
00178D E586 3E00             7  RBRFLP: LD  A,000H
00178F E588 FE0D             7      CP  00DH
001791 E58A 2005            12      JR  NZ,RBRFL1
001793 E58C D5              11      PUSH    DE
001794 E58D 1E0A             7      LD  E,00AH
001796 E58F 1805            12      JR  RBRFL2
       E591                     RBRFL1:
001798 E591 D5              11      PUSH    DE
001799 E592 CD09EF          17      CALL    _SYS07
00179C E595 5F               4      LD  E,A
       E596                     RBRFL2:
00179D E596 CDCDEF          17      CALL    _PRINT
0017A0 E599 7B               4      LD  A,E
0017A1 E59A D1              10      POP DE
0017A2 E59B 3287E5          13      LD  (RBRFLP+1),A
0017A5 E59E C9              10      RET
       E59F                     DDX:
0017A6 E59F FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
0017A9 E5A2 CDC8E1          17      CALL    CAP
0017AC E5A5 FE41             7      CP  'A'
0017AE E5A7 C9              10      RET
                                
                                                ;Read random block
       E5A8                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0017AF E5A8 225DEF          16      LD  (LEFTX),HL
0017B2 E5AB CDA5DF          17      CALL    SETDRV
                                
0017B5 E5AE FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
0017B9 E5B2 C23BE6          10      JP  NZ,RBRDIR   ;ディレクトリ
0017BC E5B5 CD4DE6          17      CALL    RBX0
0017BF E5B8 DA82E5          10      JP  C,RBRERR
0017C2 E5BB CD5CE6          17      CALL    RBX1
0017C5 E5BE D474E6          17      CALL    NC,RBX1R
0017C8 E5C1 DA76E5          10      JP  C,RBRERR1
0017CB E5C4 EB               4      EX  DE,HL
0017CC E5C5 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
0017CE E5C7 19              11      ADD HL,DE
0017CF E5C8 79               4      LD  A,C
0017D0 E5C9 DE00             7      SBC A,0
0017D2 E5CB 78               4      LD  A,B
0017D3 E5CC DE00             7      SBC A,0
0017D5 E5CE 3801            12      JR  C,RBR1
0017D7 E5D0 EB               4      EX  DE,HL
       E5D1                     RBR1:
0017D8 E5D1 9F               4      SBC A,A
0017D9 E5D2 E601             7      AND 1
0017DB E5D4 3239E6          13      LD  (RBRAP+1),A
                                
0017DE E5D7 7C               4      LD  A,H
0017DF E5D8 B5               4      OR  L
0017E0 E5D9 2857            12      JR  Z,RBREND0
                                
0017E2 E5DB 22F5E6          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
0017E5 E5DE 225DEF          16      LD  (LEFTX),HL
                                
0017E8 E5E1 CD7CE6          17      CALL    RBX2
0017EB E5E4 2819            12      JR  Z,RBRB
0017ED E5E6 CD9BE6          17      CALL    RBXA
0017F0 E5E9 DA82E5          10      JP  C,RBRERR
0017F3 E5EC C5              11      PUSH    BC
0017F4 E5ED EDB0                    LDIR
0017F6 E5EF ED535FEF        20      LD  (DTAX),DE
0017FA E5F3 2A5DEF          16      LD  HL,(LEFTX)
0017FD E5F6 D1              10      POP DE
0017FE E5F7 A7               4      AND A
0017FF E5F8 ED52            15      SBC HL,DE
001801 E5FA 225DEF          16      LD  (LEFTX),HL
001804 E5FD 2830            12      JR  Z,RBREND
                                
       E5FF                     RBRB:
001806 E5FF CDD0E6          17      CALL    RBXB
001809 E602 2815            12      JR  Z,RBRC
       E604                     RBRB1:
00180B E604 C5              11      PUSH    BC
00180C E605 D5              11      PUSH    DE
00180D E606 CDA3E1          17      CALL    CLUSTX
001810 E609 CD25E7          17      CALL    DRDC
001813 E60C D1              10      POP DE
001814 E60D C1              10      POP BC
001815 E60E D41DE9          17      CALL    NC,GNCLX
001818 E611 DA82E5          10      JP  C,RBRERR
00181B E614 10EE            13      DJNZ    RBRB1
00181D E616 CD6FE7          17      CALL    DRW_FLUSH
       E619                     RBRC:
001820 E619 CDE8E6          17      CALL    RBXC
001823 E61C 2811            12      JR  Z,RBREND
001825 E61E C5              11      PUSH    BC
001826 E61F CDA3E1          17      CALL    CLUSTX
001829 E622 CD88E7          17      CALL    DRDX
00182C E625 C1              10      POP BC
00182D E626 DA82E5          10      JP  C,RBRERR
001830 E629 EB               4      EX  DE,HL
001831 E62A 2A7EF0          16      LD  HL,(_DTBUF)
001834 E62D EDB0                    LDIR
       E62F                     RBREND:
001836 E62F CDF4E6          17      CALL    RBXEND
       E632                     RBREND0:
001839 E632 FDE1            14      POP IY
00183B E634 C1              10      POP BC
00183C E635 D1              10      POP DE
00183D E636 F1              10      POP AF  ;(HL)
00183E E637 AF               4      XOR A
00183F E638 3E00             7  RBRAP:  LD  A,000H
001841 E63A C9              10      RET
                                
       E63B                     RBRDIR:
001842 E63B FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001845 E63E FD661B          19      LD  H,(IY+27)
001848 E641 CDDEE1          17      CALL    CHDIR
00184B E644 AF               4      XOR A
00184C E645 67               4      LD  H,A
00184D E646 6F               4      LD  L,A
00184E E647 3C               4      INC A
00184F E648 3239E6          13      LD  (RBRAP+1),A
001852 E64B 18E5            12      JR  RBREND0
                                
       E64D                     RBX0:
001854 E64D 2A8AEF          16      LD  HL,(_DTA)
001857 E650 225FEF          16      LD  (DTAX),HL
00185A E653 2A5DEF          16      LD  HL,(LEFTX)
00185D E656 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
001860 E659 D6FD             7      SUB 0FDH
001862 E65B C9              10      RET
                                
       E65C                     RBX1:               ;ファイルサイズとランダムレコードを比べる
001863 E65C E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
001864 E65D FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
001867 E660 FD6611          19      LD  H,(IY+17)   ;
00186A E663 FD7E12          19      LD  A,(IY+18)   ;
                                
00186D E666 CD0BE7          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001870 E669 A7               4      AND A
001871 E66A ED52            15      SBC HL,DE
001873 E66C 99               4      SBC A,C
001874 E66D 4F               4      LD  C,A
001875 E66E FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
001878 E671 98               4      SBC A,B
001879 E672 D1              10      POP DE
00187A E673 C9              10      RET
       E674                     RBX1R:
00187B E674 47               4      LD  B,A
00187C E675 B1               4      OR  C
00187D E676 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
00187E E677 B2               4      OR  D
00187F E678 B3               4      OR  E
001880 E679 C0              11      RET NZ
001881 E67A 37               4      SCF
001882 E67B C9              10      RET
                                
       E67C                     RBX2:               ;Cluster settings
001883 E67C FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001886 E67F FD4E23          19      LD  C,(IY+35)
001889 E682 0600             7      LD  B,0
00188B E684 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00188F E688 2003            12      JR  NZ,RBX3
001891 E68A FD4624          19      LD  B,(IY+36)
       E68D                     RBX3:
001894 E68D CD93E3          17      CALL    RWXR
001897 E690 3AB2E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
00189A E693 3D               4      DEC A
00189B E694 FDA622          19      AND (IY+34)
00189E E697 FDB621          19      OR  (IY+33)
0018A1 E69A C9              10      RET
                                
       E69B                     RBXA:
0018A2 E69B C5              11      PUSH    BC
0018A3 E69C D5              11      PUSH    DE
0018A4 E69D CDA3E1          17      CALL    CLUSTX
0018A7 E6A0 CD88E7          17      CALL    DRDX
0018AA E6A3 D1              10      POP DE
0018AB E6A4 C1              10      POP BC
0018AC E6A5 D41DE9          17      CALL    NC,GNCLX
0018AF E6A8 D8              11      RET C
0018B0 E6A9 ED53FEF0        20      LD  (_CLPS),DE
                                
0018B4 E6AD FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
0018B7 E6B0 210004          10  SECSZ:  LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
0018BA E6B3 7C               4      LD  A,H
0018BB E6B4 3D               4      DEC A       ;1024=3 / 512=1
0018BC E6B5 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
0018BF E6B8 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
0018C0 E6B9 ED42            15      SBC HL,BC       ;残りを計算
                                
0018C2 E6BB ED5B5DEF        20      LD  DE,(LEFTX)
0018C6 E6BF ED52            15      SBC HL,DE       ;CP HL,DE
0018C8 E6C1 19              11      ADD HL,DE       ;
0018C9 E6C2 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
0018CB E6C4 EB               4      EX  DE,HL
       E6C5                     RBXA1:
0018CC E6C5 E5              11      PUSH    HL
0018CD E6C6 2A7EF0          16      LD  HL,(_DTBUF)
0018D0 E6C9 09              11      ADD HL,BC
0018D1 E6CA ED5B5FEF        20      LD  DE,(DTAX)
0018D5 E6CE C1              10      POP BC
0018D6 E6CF C9              10      RET
                                
       E6D0                     RBXB:
0018D7 E6D0 2A5FEF          16      LD  HL,(DTAX)
0018DA E6D3 ED5BFEF0        20      LD  DE,(_CLPS)
0018DE E6D7 3A5EEF          13      LD  A,(LEFTX+1)
0018E1 E6DA 47               4      LD  B,A
0018E2 E6DB 3AB2E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E6DE                     RBXB1:
0018E5 E6DE 1F               4      RRA     ;->CF
0018E6 E6DF 3804            12      JR  C,RBXB2
0018E8 E6E1 CB38             8      SRL B   ;B=B/2
0018EA E6E3 18F9            12      JR  RBXB1
       E6E5                     RBXB2:
0018EC E6E5 78               4      LD  A,B
0018ED E6E6 B7               4      OR  A
0018EE E6E7 C9              10      RET
                                
       E6E8                     RBXC:
0018EF E6E8 ED4B5DEF        20      LD  BC,(LEFTX)
0018F3 E6EC 3AB2E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
0018F6 E6EF 3D               4      DEC A
0018F7 E6F0 A0               4      AND B
0018F8 E6F1 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
0018F9 E6F2 B1               4      OR  C
0018FA E6F3 C9              10      RET
                                
       E6F4                     RBXEND:             ;レコード数だけランダムレコードを進める
0018FB E6F4 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       E6F5                     RBSIZE  EQU $-2
0018FE E6F7 CD42E4          17      CALL    GET_RR_AHL
001901 E6FA 19              11      ADD HL,DE
001902 E6FB CE00             7      ADC A,0
001904 E6FD CD4CE4          17      CALL    SET_RR_AHL
001907 E700 EB               4      EX  DE,HL       ;HL=進めるレコード数
001908 E701 D0              11      RET NC
001909 E702 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00190D E706 C0              11      RET NZ
00190E E707 FD3424          23      INC (IY+36)
001911 E70A C9              10      RET
                                
       E70B                     GET_RR_BCDE:            ;BCDE=Random record
001912 E70B FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
001915 E70E FD5622          19      LD  D,(IY+34)
001918 E711 FD4E23          19      LD  C,(IY+35)
00191B E714 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
00191D E716 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001921 E71A C0              11      RET NZ
001922 E71B FD4624          19      LD  B,(IY+36)
001925 E71E C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E71F                     DWTC:
001926 E71F E5              11      PUSH    HL
001927 E720 21AFEA          10      LD  HL,DWT24B
00192A E723 1804            12      JR  DWTC1
       E725                     DRDC:
00192C E725 E5              11      PUSH    HL
00192D E726 219FEA          10      LD  HL,DRD24B
       E729                     DWTC1:
001930 E729 2283E7          16      LD  (DRWF_MODE),HL
001933 E72C E1              10      POP HL
001934 E72D 3A73E7          13      LD  A,(DRWF_B)
001937 E730 B7               4      OR  A
001938 E731 200F            12      JR  NZ,DRDC1
       E733                     SAVE_DRWC:
00193A E733 0601             7      LD  B,1
00193C E735 ED4372E7        20      LD  (DRWF_C),BC
001940 E739 ED5379E7        20      LD  (DRWF_E),DE
001944 E73D 227CE7          16      LD  (DRWF_HL),HL
001947 E740 1820            12      JR  INC_HL_DRWC
       E742                     DRDC1:
001949 E742 E5              11      PUSH    HL
00194A E743 2179E7          10      LD  HL,DRWF_E
00194D E746 86               7      ADD A,(HL)
00194E E747 F5              11      PUSH    AF
00194F E748 BB               4      CP  E
001950 E749 201D            12      JR  NZ,DRDC2
001952 E74B F1              10      POP AF
001953 E74C 23               6      INC HL
001954 E74D 7E               7      LD  A,(HL)
001955 E74E CE00             7      ADC A,0
001957 E750 F5              11      PUSH    AF
001958 E751 BA               4      CP  D
001959 E752 2014            12      JR  NZ,DRDC2
00195B E754 F1              10      POP AF
00195C E755 3A72E7          13      LD  A,(DRWF_C)
00195F E758 CE00             7      ADC A,0
001961 E75A B9               4      CP  C
001962 E75B 200C            12      JR  NZ,DRDC3
001964 E75D 2173E7          10      LD  HL,DRWF_B
001967 E760 34              11      INC (HL)
001968 E761 E1              10      POP HL
       E762                     INC_HL_DRWC:
001969 E762 3AB2E6          13      LD  A,(SECSZ+2)     ;1セクタのサイズの上位1バイト
00196C E765 84               4      ADD A,H
00196D E766 67               4      LD  H,A
00196E E767 C9              10      RET
       E768                     DRDC2:
00196F E768 F1              10      POP AF
       E769                     DRDC3:
001970 E769 CD6FE7          17      CALL    DRW_FLUSH
001973 E76C E1              10      POP HL
001974 E76D 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E76F                     DRW_FLUSH:
001976 E76F C5              11      PUSH    BC
001977 E770 D5              11      PUSH    DE
001978 E771 010000          10      LD  BC,0
       E772                     DRWF_C  EQU $-2
       E773                     DRWF_B  EQU $-1
00197B E774 78               4      LD  A,B
00197C E775 B7               4      OR  A
00197D E776 280D            12      JR  Z,DRDF1
00197F E778 110000          10      LD  DE,0
       E779                     DRWF_E  EQU $-2
       E77A                     DRWF_D  EQU $-1
001982 E77B 210000          10      LD  HL,0
       E77C                     DRWF_HL EQU $-2
001985 E77E AF               4      XOR A
001986 E77F 3273E7          13      LD  (DRWF_B),A
001989 E782 CD9FEA          17      CALL    DRD24B
       E783                     DRWF_MODE   EQU $-2
       E785                     DRDF1:
00198C E785 D1              10      POP DE
00198D E786 C1              10      POP BC
00198E E787 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E788                     DRDX:
00198F E788 CDC6E7          17      CALL    DRDY
001992 E78B C8              11      RET Z
001993 E78C CDACE7          17      CALL    DRDX1       ;データバッファの情報を保存
001996 E78F D8              11      RET C
001997 E790 E5              11      PUSH    HL
001998 E791 C5              11      PUSH    BC
001999 E792 D5              11      PUSH    DE
00199A E793 2A7EF0          16      LD  HL,(_DTBUF)
00199D E796 3AEFE7          13      LD  A,(_DBS24)
0019A0 E799 4F               4      LD  C,A
0019A1 E79A CD9DEA          17      CALL    DRD24
0019A4 E79D DCC1E7          17      CALL    C,DRDNE
       E7A0                     POP_DE_BC_HL_RET:
0019A7 E7A0 D1              10      POP DE
0019A8 E7A1 C1              10      POP BC
0019A9 E7A2 E1              10      POP HL
0019AA E7A3 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E7A4                     DRDN:
0019AB E7A4 AF               4      XOR A
0019AC E7A5 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
0019AD E7A6 30E0            12      JR  NC,DRDX
       E7A8                     DRDNX:
0019AF E7A8 CDC6E7          17      CALL    DRDY
0019B2 E7AB C8              11      RET Z
       E7AC                     DRDX1:
0019B3 E7AC CDDCE7          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
0019B6 E7AF ED53A6EF        20      LD  (_DBSEC),DE
0019BA E7B3 79               4      LD  A,C
0019BB E7B4 32EFE7          13      LD  (_DBS24),A
                                
0019BE E7B7 3A88EF          13      LD  A,(_DRV)
0019C1 E7BA 32A5EF          13      LD  (_DBDRV),A
0019C4 E7BD CDD9EF          17      CALL    _CHGDRV
0019C7 E7C0 D0              11      RET NC
       E7C1                     DRDNE:
0019C8 E7C1 9F               4      SBC A,A     ;CF=1ならばA=0FFH
0019C9 E7C2 32A5EF          13      LD  (_DBDRV),A
0019CC E7C5 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E7C6                     DRDY:
0019CD E7C6 3AEFE7          13      LD  A,(_DBS24)
0019D0 E7C9 B9               4      CP  C
0019D1 E7CA C0              11      RET NZ
                                
0019D2 E7CB E5              11      PUSH    HL
0019D3 E7CC 3A88EF          13      LD  A,(_DRV)
0019D6 E7CF 21A5EF          10      LD  HL,_DBDRV
0019D9 E7D2 AE               7      XOR (HL)
0019DA E7D3 2005            12      JR  NZ,POP_HL_RET
                                
0019DC E7D5 2AA6EF          16      LD  HL,(_DBSEC)
0019DF E7D8 ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E7DA                     POP_HL_RET:
0019E1 E7DA E1              10      POP HL
0019E2 E7DB C9              10      RET
                                
       E7DC                     DWTX:
0019E3 E7DC 3AA4EF          13      LD  A,(_WTDBF)
0019E6 E7DF B7               4      OR  A
0019E7 E7E0 C8              11      RET Z
0019E8 E7E1 AF               4      XOR A
0019E9 E7E2 32A4EF          13      LD  (_WTDBF),A
                                
0019EC E7E5 E5              11      PUSH    HL
0019ED E7E6 C5              11      PUSH    BC
0019EE E7E7 D5              11      PUSH    DE
0019EF E7E8 3AA5EF          13      LD  A,(_DBDRV)
0019F2 E7EB CDD9EF          17      CALL    _CHGDRV
0019F5 E7EE 0E00             7      LD  C,0
       E7EF                     _DBS24  EQU $-1
0019F7 E7F0 ED5BA6EF        20      LD  DE,(_DBSEC)
0019FB E7F4 2A7EF0          16      LD  HL,(_DTBUF)
0019FE E7F7 D4ADEA          17      CALL    NC,DWT24
       E7FA                     POP_DE_BC_HL_RET2:
001A01 E7FA 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E7FC                     RDFATX:
001A03 E7FC E5              11      PUSH    HL
001A04 E7FD 3A88EF          13      LD  A,(_DRV)
001A07 E800 21AAEF          10      LD  HL,_FATDRV
001A0A E803 AE               7      XOR (HL)
001A0B E804 28D4            12      JR  Z,POP_HL_RET
                                
001A0D E806 C5              11      PUSH    BC
001A0E E807 D5              11      PUSH    DE
001A0F E808 DDE5            15      PUSH    IX
001A11 E80A CD26E8          17      CALL    WTFATX
001A14 E80D 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
001A16 E80F AF               4      XOR A
001A17 E810 32ABEF          13      LD  (_FATIX),A
001A1A E813 3A88EF          13      LD  A,(_DRV)
001A1D E816 32AAEF          13      LD  (_FATDRV),A
001A20 E819 CDE5EF          17      CALL    _RDFAT
       E81C                     RDFATE2:
001A23 E81C 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
001A25 E81E 9F               4      SBC A,A     ;A=0xFF
001A26 E81F 32AAEF          13      LD  (_FATDRV),A
       E822                     POP_IX_DE_BC_HL_RET:
001A29 E822 DDE1            14      POP IX
001A2B E824 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E826                     WTFATX:
001A2D E826 3AA2EF          13      LD  A,(_WTFATF)
001A30 E829 B7               4      OR  A
001A31 E82A C8              11      RET Z
001A32 E82B E5              11      PUSH    HL
001A33 E82C 3AAAEF          13      LD  A,(_FATDRV)
001A36 E82F 21A5EF          10      LD  HL,_DBDRV
001A39 E832 AE               7      XOR (HL)
001A3A E833 CCDCE7          17      CALL    Z,DWTX
001A3D E836 38A2            12      JR  C,POP_HL_RET
001A3F E838 C5              11      PUSH    BC
001A40 E839 D5              11      PUSH    DE
001A41 E83A DDE5            15      PUSH    IX
001A43 E83C CDBAEA          17      CALL    WTFAT
001A46 E83F AF               4      XOR A
001A47 E840 32A2EF          13      LD  (_WTFATF),A
001A4A E843 18DD            12      JR  POP_IX_DE_BC_HL_RET
                                
       E845                     NCL1:
001A4C E845 7A               4      LD  A,D
001A4D E846 B3               4      OR  E
001A4E E847 37               4      SCF
001A4F E848 C8              11      RET Z
                                
001A50 E849 7A               4      LD  A,D
001A51 E84A CB3F             8      SRL A   ;/2
001A53 E84C CB3F             8      SRL A   ;/2
                                
001A55 E84E E5              11      PUSH    HL
001A56 E84F 326EE8          13      LD  (NCLPAT_FATIX),A    ;_FATIX
001A59 E852 2AAAEF          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001A5C E855 BC               4      CP  H
001A5D E856 3A88EF          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001A60 E859 326DE8          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001A63 E85C 2005            12      JR  NZ,NCL2     ;FATIXが違う
001A65 E85E BD               4      CP  L
001A66 E85F 2002            12      JR  NZ,NCL2     ;ドライブが違う
001A68 E861 E1              10      POP HL
001A69 E862 C9              10      RET
       E863                     NCL2:
001A6A E863 C5              11      PUSH    BC
001A6B E864 D5              11      PUSH    DE
001A6C E865 DDE5            15      PUSH    IX
001A6E E867 CD26E8          17      CALL    WTFATX
001A71 E86A 38B6            12      JR  C,POP_IX_DE_BC_HL_RET
001A73 E86C 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E86E                     NCLPAT_FATIX    EQU $-1
       E86D                     NCLPAT_FATDRV   EQU $-2
001A76 E86F ED43AAEF        20      LD  (_FATDRV),BC
001A7A E873 CD8FEA          17      CALL    RDFATS
001A7D E876 18A4            12      JR  RDFATE2
                                
       E878                     NCL3:
001A7F E878 CB9A             8      RES 3,D
001A81 E87A CB92             8      RES 2,D
001A83 E87C 6B               4      LD  L,E
001A84 E87D 62               4      LD  H,D
001A85 E87E CB3C             8      SRL H   ;
001A87 E880 CB1D             8      RR  L   ;HLA=HLA/2
001A89 E882 1F               4      RRA     ;
001A8A E883 F5              11      PUSH    AF
001A8B E884 3AABEF          13      LD  A,(_FATIX)
001A8E E887 0F               4      RRCA
001A8F E888 300B            12      JR  NC,NCL3X1
001A91 E88A 3AB2E6          13      LD  A,(SECSZ+2)
001A94 E88D FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
001A96 E88F 2004            12      JR  NZ,NCL3X1
001A98 E891 010002          10      LD  BC,512
001A9B E894 09              11      ADD HL,BC
       E895                     NCL3X1:
001A9C E895 F1              10      POP AF
001A9D E896 ED4B7CF0        20      LD  BC,(_FATBF)
001AA1 E89A 19              11      ADD HL,DE
001AA2 E89B 09              11      ADD HL,BC
001AA3 E89C 17               4      RLA
001AA4 E89D C9              10      RET
                                
       E89E                     GNCL:
001AA5 E89E CD45E8          17      CALL    NCL1        ;GET NEXT CLUSTER
001AA8 E8A1 D8              11      RET C
001AA9 E8A2 C5              11      PUSH    BC
001AAA E8A3 E5              11      PUSH    HL
001AAB E8A4 CD78E8          17      CALL    NCL3
001AAE E8A7 3809            12      JR  C,GNC1
001AB0 E8A9 5E               7      LD  E,(HL)
001AB1 E8AA 23               6      INC HL
001AB2 E8AB 7E               7      LD  A,(HL)
001AB3 E8AC E60F             7      AND 00FH
001AB5 E8AE 57               4      LD  D,A
001AB6 E8AF E1              10      POP HL
001AB7 E8B0 C1              10      POP BC
001AB8 E8B1 C9              10      RET
       E8B2                     GNC1:
001AB9 E8B2 7E               7      LD  A,(HL)
001ABA E8B3 23               6      INC HL
001ABB E8B4 56               7      LD  D,(HL)
001ABC E8B5 0604             7      LD  B,4
       E8B7                     GNC1L:
001ABE E8B7 CB3A             8      SRL D   ;DA=DA/2
001AC0 E8B9 1F               4      RRA     ;
001AC1 E8BA 10FB            13      DJNZ    GNC1L
                                
001AC3 E8BC 5F               4      LD  E,A
001AC4 E8BD E1              10      POP HL
001AC5 E8BE C1              10      POP BC
001AC6 E8BF A7               4      AND A
001AC7 E8C0 C9              10      RET
                                
       E8C1                     SNCL:
001AC8 E8C1 CD45E8          17      CALL    NCL1
001ACB E8C4 D8              11      RET C
                                ;               SET NEXT CLUSTER
001ACC E8C5 E5              11      PUSH    HL
001ACD E8C6 C5              11      PUSH    BC
001ACE E8C7 D5              11      PUSH    DE
001ACF E8C8 E5              11      PUSH    HL
001AD0 E8C9 CD78E8          17      CALL    NCL3
001AD3 E8CC D1              10      POP DE
                                ;CF=ODD
001AD4 E8CD 7E               7      LD  A,(HL)
001AD5 E8CE 73               7      LD  (HL),E
001AD6 E8CF 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
001AD8 E8D1 23               6      INC HL
001AD9 E8D2 ED67            18      RRD     ;M={A[3:0],E[3:0]}
001ADB E8D4 7A               4      LD  A,D
001ADC E8D5 1804            12      JR  SNC11
       E8D7                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
001ADE E8D7 ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001AE0 E8D9 23               6      INC HL
001AE1 E8DA 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E8DB                     SNC11:
001AE2 E8DB ED6F            18      RLD     ;M={M[7:4],D[3:0]}
001AE4 E8DD B7               4      OR  A
001AE5 E8DE D1              10      POP DE
001AE6 E8DF C1              10      POP BC
001AE7 E8E0 E1              10      POP HL
       E8E1                     FAT_CHANGED:
001AE8 E8E1 3E01             7      LD  A,1
001AEA E8E3 32A2EF          13      LD  (_WTFATF),A
001AED E8E6 C9              10      RET
                                
       E8E7                     N16CL3:
001AEE E8E7 C5              11      PUSH    BC
001AEF E8E8 6B               4      LD  L,E
001AF0 E8E9 7A               4      LD  A,D
001AF1 E8EA E603             7      AND 3
001AF3 E8EC 67               4      LD  H,A
001AF4 E8ED 29              11      ADD HL,HL
001AF5 E8EE ED4B7CF0        20      LD  BC,(_FATBF)
001AF9 E8F2 09              11      ADD HL,BC
001AFA E8F3 C1              10      POP BC
001AFB E8F4 C9              10      RET
                                
       E8F5                     GNCL16:
001AFC E8F5 CD45E8          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
001AFF E8F8 D8              11      RET C
001B00 E8F9 E5              11      PUSH    HL
001B01 E8FA CDE7E8          17      CALL    N16CL3
001B04 E8FD 5E               7      LD  E,(HL)
001B05 E8FE 23               6      INC HL
001B06 E8FF 56               7      LD  D,(HL)
001B07 E900 E1              10      POP HL
001B08 E901 C9              10      RET
                                
       E902                     SNCL16:
001B09 E902 CD45E8          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
001B0C E905 D8              11      RET C
001B0D E906 D5              11      PUSH    DE
001B0E E907 E5              11      PUSH    HL
001B0F E908 CDE7E8          17      CALL    N16CL3
001B12 E90B D1              10      POP DE      ;HL
001B13 E90C 73               7      LD  (HL),E
001B14 E90D 23               6      INC HL
001B15 E90E 72               7      LD  (HL),D
001B16 E90F 6B               4      LD  L,E
001B17 E910 62               4      LD  H,D
001B18 E911 D1              10      POP DE
001B19 E912 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E914                     NEXTX:
001B1B E914 3E00             7      LD  A,0 ;自己書き換え
       E915                     _SECPS  EQU $-1
001B1D E916 3C               4      INC A
001B1E E917 E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E918                     _NCPAT  EQU $-1
001B20 E919 3215E9          13      LD  (_SECPS),A
001B23 E91C C9              10      RET
                                
       E91D                     GNCLX:
001B24 E91D CD14E9          17      CALL    NEXTX
001B27 E920 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001B28 E921 C3F7EF          10      JP  _GNCL   ;次のクラスタを探す
                                
       E924                     RDFAT:
001B2B E924 3E80             7      LD  A,080H
001B2D E926 3270EF          13      LD  (CHECK),A
       E929                     RDFAT1:
001B30 E929 3A88EF          13      LD  A,(_DRV)
001B33 E92C CDE4EB          17      CALL    CHGDRVR
001B36 E92F D8              11      RET C
001B37 E930 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001B3A E933 CB6F             8      BIT 5,A
001B3C E935 2868            12      JR  Z,RDFAT0X
001B3E E937 2170EF          10      LD  HL,CHECK
001B41 E93A A6               7      AND (HL)
001B42 E93B 77               7      LD  (HL),A
001B43 E93C 110000          10      LD  DE,0        ;BPB
001B46 E93F 2A7CF0          16      LD  HL,(_FATBF)
001B49 E942 CD9BEA          17      CALL    DRD16
001B4C E945 3024            12      JR  NC,GETBPB
001B4E E947 2170EF          10      LD  HL,CHECK
001B51 E94A CB06            15      RLC (HL)
001B53 E94C 3F               4      CCF
001B54 E94D D8              11      RET C
001B55 E94E DDCB0A1E        23      RR  (IX+DPB_FDMODE)
001B59 E952 3F               4      CCF         ;フロッピーディスクのFDモードを切り替える
001B5A E953 DDCB0A16        23      RL  (IX+DPB_FDMODE)
001B5E E957 3EFF             7      LD  A,0FFH
001B60 E959 3289EF          13      LD  (_DSK),A
001B63 E95C 3A84EF          13      LD  A,(_DRIVE)
001B66 E95F E603             7      AND 3
001B68 E961 F680             7      OR  080H
001B6A E963 6F               4      LD  L,A
001B6B E964 26EF             7      LD  H,_CYL0/256
001B6D E966 3EFF             7      LD  A,0FFH
001B6F E968 77               7      LD  (HL),A
001B70 E969 18BE            12      JR  RDFAT1
       E96B                     GETBPB:
001B72 E96B FDE5            15      PUSH    IY
001B74 E96D FD2A7CF0        20      LD  IY,(_FATBF) ;BPB
001B78 E971 CDF1EF          17      CALL    _BPB2DPB
001B7B E974 FDE1            14      POP IY
001B7D E976 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001B80 E979 3021            12      JR  NC,GETBPBOK
001B82 E97B E60F             7      AND 00FH
001B84 E97D FE07             7      CP  7
001B86 E97F 37               4      SCF
001B87 E980 C0              11      RET NZ
001B88 E981 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001B8C E985 21C0F0          10      LD  HL,M2D
001B8F E988 2002            12      JR  NZ,SETFDMODE
001B91 E98A 2ED2             7      LD  L,M2HD-STABLE
       E98C                     SETFDMODE:
001B93 E98C DDE5            15      PUSH    IX
001B95 E98E D1              10      POP DE
001B96 E98F EDA0            16      LDI
001B98 E991 EDA0            16      LDI
001B9A E993 13               6      INC DE
001B9B E994 13               6      INC DE
001B9C E995 13               6      INC DE
001B9D E996 13               6      INC DE
001B9E E997 010C00          10      LD  BC,12
001BA1 E99A EDB0                    LDIR
       E99C                     GETBPBOK:
001BA3 E99C CD43EB          17      CALL    CHGDRV2
       E99F                     RDFAT0X:
001BA6 E99F CD8FEA          17      CALL    RDFATS
001BA9 E9A2 D8              11      RET C
001BAA E9A3 DDAE06          19      XOR (IX+DPB_FATID)
001BAD E9A6 C8              11      RET Z
001BAE E9A7 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001BB2 E9AB C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
001BB3 E9AC 37               4      SCF
001BB4 E9AD C9              10      RET
                                
       E9AE                     POP_HL_SCF_RET:
001BB5 E9AE E1              10      POP HL
001BB6 E9AF 37               4      SCF
001BB7 E9B0 C9              10      RET
                                
       E9B1                     BPB2DPB:
001BB8 E9B1 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
001BBB E9B4 B7               4      OR  A
001BBC E9B5 37               4      SCF
001BBD E9B6 C0              11      RET NZ
       E9B7                     BPBOK:
001BBE E9B7 FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001BC1 E9BA DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001BC4 E9BD FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001BC7 E9C0 DD7700          19      LD  (IX+DPB_FATLN),A
001BCA E9C3 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
001BCD E9C6 DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
001BD0 E9C9 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001BD3 E9CC FD660F          19      LD  H,(IY+15)
001BD6 E9CF DD750E          19      LD  (IX+DPB_FATPS),L
001BD9 E9D2 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001BDC E9D5 FD5617          19      LD  D,(IY+23)
001BDF E9D8 FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E9DB                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001BE2 E9DB 19              11      ADD HL,DE
001BE3 E9DC 10FD            13      DJNZ    BPBDP1
       E9DE                     BPBDP2:
001BE5 E9DE DD7510          19      LD  (IX+DPB_DIRPS),L
001BE8 E9E1 DD7411          19      LD  (IX+DPB_DIRPS+1),H
001BEB E9E4 E5              11      PUSH    HL
                                
001BEC E9E5 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
001BEF E9E8 FD6612          19      LD  H,(IY+18)
001BF2 E9EB FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001BF5 E9EE B7               4      OR  A
001BF6 E9EF 28BD            12      JR  Z,POP_HL_SCF_RET
001BF8 E9F1 0606             7      LD  B,6
       E9F3                     BPBBPS1:
001BFA E9F3 05               4      DEC B
001BFB E9F4 0F               4      RRCA
001BFC E9F5 30FC            12      JR  NC,BPBBPS1
       E9F7                     BPBDE1:
001BFE E9F7 29              11      ADD HL,HL
001BFF E9F8 10FD            13      DJNZ    BPBDE1
                                
001C01 E9FA 7C               4      LD  A,H
001C02 E9FB DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
001C05 E9FE D1              10      POP DE      ;DPB_DIRPS
001C06 E9FF 6C               4      LD  L,H
001C07 EA00 2600             7      LD  H,0
001C09 EA02 19              11      ADD HL,DE       ;MAXDIR
001C0A EA03 E5              11      PUSH    HL
001C0B EA04 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001C0E EA07 CB21             8      SLA C       ;*2
001C10 EA09 AF               4      XOR A
001C11 EA0A 47               4      LD  B,A
001C12 EA0B ED42            15      SBC HL,BC
001C14 EA0D DD7514          19      LD  (IX+DPB_ADDCL),L
001C17 EA10 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
001C1A EA13 D1              10      POP DE      ;DE=DPB_MAXDIR
001C1B EA14 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001C1E EA17 FD6614          19      LD  H,(IY+20)
                                
001C21 EA1A DD7E12          19      LD  A,(IX+DPB_DEVICE)
001C24 EA1D E60F             7      AND 00FH
001C26 EA1F FE07             7      CP  7       ;フロッピー
001C28 EA21 2019            12      JR  NZ,NOT_FD
001C2A EA23 E5              11      PUSH    HL
001C2B EA24 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001C2E EA27 DD710D          19      LD  (IX+DPB_MAXSEC),C
001C31 EA2A AF               4      XOR A
001C32 EA2B CB21             8      SLA C       ;両面なのでセクタ数を２倍
001C34 EA2D 0610             7      LD  B,16
       EA2F                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001C36 EA2F 29              11      ADD HL,HL
001C37 EA30 17               4      RLA
001C38 EA31 B9               4      CP  C
001C39 EA32 3802            12      JR  C,DIVSEC1
001C3B EA34 91               4      SUB C
001C3C EA35 2C               4      INC L
       EA36                     DIVSEC1:
001C3D EA36 10F7            13      DJNZ    DIVSEC
001C3F EA38 DD750C          19      LD  (IX+DPB_MAXCYL),L
001C42 EA3B E1              10      POP HL  ;ここまでフロッピー専用
       EA3C                     NOT_FD:
001C43 EA3C 7C               4      LD  A,H
001C44 EA3D B5               4      OR  L
001C45 EA3E 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001C47 EA40 2010            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001C49 EA42 FD7E23          19      LD  A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001C4C EA45 B7               4      OR  A
001C4D EA46 37               4      SCF
001C4E EA47 C0              11      RET NZ
001C4F EA48 FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001C52 EA4B FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので
001C55 EA4E FD7E22          19      LD  A,(IY+34)   ;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
001C58 EA51 A7               4      AND A       ;CF=0
       EA52                     BPB16BIT:
001C59 EA52 ED52            15      SBC HL,DE
001C5B EA54 DE00             7      SBC A,0
001C5D EA56 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       EA59                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001C60 EA59 CB18             8      RR  B       ;->CY
001C62 EA5B 3808            12      JR  C,BPBTC2
001C64 EA5D CB3F             8      SRL A
001C66 EA5F CB1C             8      RR  H       ;AHL=AHL/2
001C68 EA61 CB1D             8      RR  L
001C6A EA63 18F4            12      JR  BPBTC1
       EA65                     BPBTC2:
001C6C EA65 B7               4      OR  A
001C6D EA66 37               4      SCF
001C6E EA67 C0              11      RET NZ      ;念のため(クラスタ数が16ビットを超える場合)
001C6F EA68 23               6      INC HL
001C70 EA69 23               6      INC HL
001C71 EA6A DD7508          19      LD  (IX+DPB_MAXCL),L
001C74 EA6D DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001C77 EA70 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001C7A EA73 DD7706          19      LD  (IX+DPB_FATID),A
                                
001C7D EA76 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001C80 EA79 C6FE             7      ADD A,0-2       ;>2:CF=1
001C82 EA7B FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001C85 EA7E 6F               4      LD  L,A
001C86 EA7F 3002            12      JR  NC,BPBFAT1
001C88 EA81 F680             7      OR  080H
       EA83                     BPBFAT1:            ;ここではCF=0
001C8A EA83 DD770F          19      LD  (IX+DPB_BPS),A
001C8D EA86 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001C8E EA87 C8              11      RET Z       ;1セクタ256バイト
001C8F EA88 2D               4      DEC L
001C90 EA89 C8              11      RET Z       ;1セクタ512バイト
001C91 EA8A 2D               4      DEC L
001C92 EA8B 2D               4      DEC L
001C93 EA8C C8              11      RET Z       ;1セクタ1024バイト
001C94 EA8D 37               4      SCF
001C95 EA8E C9              10      RET
                                
       EA8F                     RDFATS:
001C96 EA8F CDD5EA          17      CALL    FATSETUP
001C99 EA92 D8              11      RET C
001C9A EA93 CD9FEA          17      CALL    DRD24B
001C9D EA96 2A7CF0          16      LD  HL,(_FATBF)
001CA0 EA99 7E               7      LD  A,(HL)
001CA1 EA9A C9              10      RET
                                
       EA9B                     DRD16:
001CA2 EA9B 0E00             7      LD  C,0
       EA9D                     DRD24:
001CA4 EA9D 0601             7      LD  B,1
       EA9F                     DRD24B:
001CA6 EA9F DDE5            15      PUSH    IX
001CA8 EAA1 DD2AA8EF        20      LD  IX,(_DPB)
001CAC EAA5 CD77ED          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       EAA6                     DRDPAT  EQU $-2
       EAA8                     POP_IX_RET:
001CAF EAA8 DDE1            14      POP IX
001CB1 EAAA C9              10      RET
                                
       EAAB                     DWT16:
001CB2 EAAB 0E00             7      LD  C,0
       EAAD                     DWT24:
001CB4 EAAD 0601             7      LD  B,1
       EAAF                     DWT24B:
001CB6 EAAF DDE5            15      PUSH    IX
001CB8 EAB1 DD2AA8EF        20      LD  IX,(_DPB)
001CBC EAB5 CDDFEC          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       EAB6                     DWTPAT  EQU $-2
001CBF EAB8 18EE            12      JR  POP_IX_RET
                                
       EABA                     WTFAT:
001CC1 EABA CDD5EA          17      CALL    FATSETUP
001CC4 EABD D4AFEA          17      CALL    NC,DWT24B
001CC7 EAC0 D8              11      RET C
001CC8 EAC1 DDCB0F7E        20      BIT 7,(IX+DPB_BPS)
001CCC EAC5 C8              11      RET Z       ;予備FATが無い
001CCD EAC6 CDDCEA          17      CALL    FATS2
001CD0 EAC9 E5              11      PUSH    HL      ;予備FAT
001CD1 EACA DD6E00          19      LD  L,(IX+DPB_FATLN)
001CD4 EACD DD6601          19      LD  H,(IX+DPB_FATLN+1)
001CD7 EAD0 19              11      ADD HL,DE
001CD8 EAD1 EB               4      EX  DE,HL
001CD9 EAD2 E1              10      POP HL
001CDA EAD3 18DA            12      JR  DWT24B
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ1024毎に2KBを切り替える
                                ;------------------------
       EAD5                     FATSETUP:
001CDC EAD5 3AAAEF          13      LD  A,(_FATDRV)
001CDF EAD8 CDE4EB          17      CALL    CHGDRVR     ;ドライブ切り替え
001CE2 EADB D8              11      RET C
       EADC                     FATS2:
001CE3 EADC DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001CE6 EADF 0F               4      RRCA
001CE7 EAE0 CD09EB          17      CALL    FATSETUP12  ;自己書き換え
       EAE1                     FATSX   EQU $-2
001CEA EAE3 210000          10      LD  HL,0
001CED EAE6 4A               4      LD  C,D
001CEE EAE7 54               4      LD  D,H
001CEF EAE8 3AABEF          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
001CF2 EAEB 47               4      LD  B,A
001CF3 EAEC 04               4      INC B
001CF4 EAED DD7E00          19      LD  A,(IX+DPB_FATLN)
       EAF0                     FAT_SKP:
001CF7 EAF0 05               4      DEC B
001CF8 EAF1 2805            12      JR  Z,FAT1
001CFA EAF3 19              11      ADD HL,DE
001CFB EAF4 93               4      SUB E
001CFC EAF5 30F9            12      JR  NC,FAT_SKP
001CFE EAF7 C9              10      RET
       EAF8                     FAT1:
001CFF EAF8 EB               4      EX  DE,HL
001D00 EAF9 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001D01 EAFA 3801            12      JR  C,FAT2
001D03 EAFC 79               4      LD  A,C
       EAFD                     FAT2:
001D04 EAFD 47               4      LD  B,A
                                
001D05 EAFE 2AFAF0          16      LD  HL,(_FATPS) ;fat sector pos
001D08 EB01 19              11      ADD HL,DE
001D09 EB02 EB               4      EX  DE,HL
001D0A EB03 2A7CF0          16      LD  HL,(_FATBF)
001D0D EB06 AF               4      XOR A       ;CF=0
001D0E EB07 4F               4      LD  C,A
001D0F EB08 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       EB09                     FATSETUP12:
001D10 EB09 110606          10      LD  DE,0606H    ;256
001D13 EB0C D8              11      RET C
001D14 EB0D 110303          10      LD  DE,0303H    ;512
001D17 EB10 0F               4      RRCA
001D18 EB11 D8              11      RET C
001D19 EB12 110102          10      LD  DE,0201H    ;1024
001D1C EB15 C9              10      RET
                                
       EB16                     FATSETUP16:
001D1D EB16 110808          10      LD  DE,0808H    ;256
001D20 EB19 D8              11      RET C
001D21 EB1A 110404          10      LD  DE,0404H
001D24 EB1D 0F               4      RRCA            ;512
001D25 EB1E D8              11      RET C
001D26 EB1F 110202          10      LD  DE,0202H    ;1024
001D29 EB22 C9              10      RET
                                
       EB23                     CHGDRV:
001D2A EB23 E5              11      PUSH    HL
001D2B EB24 2189EF          10      LD  HL,_DSK
001D2E EB27 BE               7      CP  (HL)
001D2F EB28 280A            12      JR  Z,CHGDRVE
       EB2A                     CHGDRV1:
001D31 EB2A DDE5            15      PUSH    IX
001D33 EB2C CD36EB          17      CALL    CHGDRV0
001D36 EB2F 3A89EF          13      LD  A,(_DSK)
001D39 EB32 DDE1            14      POP IX
       EB34                     CHGDRVE:
001D3B EB34 E1              10      POP HL
001D3C EB35 C9              10      RET
                                
       EB36                     CHGDRV0:
001D3D EB36 6F               4      LD  L,A
001D3E EB37 CDDCEF          17      CALL    _GETDPB
001D41 EB3A D8              11      RET C
001D42 EB3B DD22A8EF        20      LD  (_DPB),IX
001D46 EB3F 7D               4      LD  A,L
001D47 EB40 3289EF          13      LD  (_DSK),A
       EB43                     CHGDRV2:
001D4A EB43 C5              11      PUSH    BC
001D4B EB44 D5              11      PUSH    DE
001D4C EB45 ED739AEB        20      LD  (SPPAT2),SP
001D50 EB49 F3               4      DI
001D51 EB4A DDF9            10      LD  SP,IX
                                
001D53 EB4C E1              10      POP HL      ;00:DPB_FATLN
001D54 EB4D E1              10      POP HL      ;02:DPB_DRD
001D55 EB4E 22A6EA          16      LD  (DRDPAT),HL
                                
001D58 EB51 E1              10      POP HL
001D59 EB52 22B6EA          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001D5C EB55 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001D5D EB56 7C               4      LD  A,H
001D5E EB57 32A7E1          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001D61 EB5A 3D               4      DEC A
001D62 EB5B 3218E9          13      LD  (_NCPAT),A
                                
001D65 EB5E E1              10      POP HL      ;08:DPB_MAXCL
001D66 EB5F 7D               4      LD  A,L
001D67 EB60 32C6E1          13      LD  (CLPAT2),A
001D6A EB63 7C               4      LD  A,H
001D6B EB64 32C2E1          13      LD  (CLPAT1),A
001D6E EB67 2B               6      DEC HL
001D6F EB68 22C9E3          16      LD  (MAXCLP),HL
                                
001D72 EB6B E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001D73 EB6C 7D               4      LD  A,L
001D74 EB6D F6FE             7      OR  0FEH
001D76 EB6F 32A4ED          13      LD  (FDMODE+1),A
001D79 EB72 07               4      RLCA
001D7A EB73 E603             7      AND 3
001D7C EB75 326BEF          13      LD  (FSPAT+1),A
001D7F EB78 4C               4      LD  C,H
                                
001D80 EB79 E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001D81 EB7A E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001D82 EB7B 7C               4      LD  A,H     ;DPB_BPS
001D83 EB7C E607             7      AND 7
001D85 EB7E 32B2E6          13      LD  (SECSZ+2),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98
                                                ;1セクタ256 GRAM/RAMF/CMOS/等
                                                ;1024   512 256
                                                ;4  2   1
001D88 EB81 87               4      ADD A,A     ;8  4   2
001D89 EB82 87               4      ADD A,A     ;010H   8   4
001D8A EB83 87               4      ADD A,A     ;020H   010H    8
001D8B EB84 3223E0          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001D8E EB87 2600             7      LD  H,0
001D90 EB89 22FAF0          16      LD  (_FATPS),HL
                                
001D93 EB8C E1              10      POP HL      ;10:DPB_DIRPS
001D94 EB8D 22FCF0          16      LD  (_DIRPS),HL
                                
001D97 EB90 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001D98 EB91 7C               4      LD  A,H
001D99 EB92 3284EF          13      LD  (_DRIVE),A
                                
001D9C EB95 E1              10      POP HL      ;14:DPB_ADDCL
001D9D EB96 22B7E1          16      LD  (CLSPAT),HL
                                
001DA0 EB99 310000          10      LD  SP,0        ;元のSPを復元
       EB9A                     SPPAT2  EQU $-2
001DA3 EB9C FB               4      EI
001DA4 EB9D 2AFCF0          16      LD  HL,(_DIRPS)
001DA7 EBA0 0600             7      LD  B,0
001DA9 EBA2 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001DAA EBA3 223EE0          16      LD  (MD_PAT),HL
                                
001DAD EBA6 2AC9E3          16      LD  HL,(MAXCLP);
001DB0 EBA9 11F60F          10      LD  DE,4086     ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001DB3 EBAC ED52            15      SBC HL,DE       ;CF=0のはず
001DB5 EBAE 300F            12      JR  NC,SETFAT16
001DB7 EBB0 219EE8          10      LD  HL,GNCL     ;FAT12
001DBA EBB3 11C1E8          10      LD  DE,SNCL
001DBD EBB6 0109EB          10      LD  BC,FATSETUP12
001DC0 EBB9 DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001DC4 EBBD 180D            12      JR  EXTRA1
       EBBF                     SETFAT16:
001DC6 EBBF 21F5E8          10      LD  HL,GNCL16   ;FAT16
001DC9 EBC2 1102E9          10      LD  DE,SNCL16
001DCC EBC5 0116EB          10      LD  BC,FATSETUP16
001DCF EBC8 DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       EBCC                     EXTRA1:
001DD3 EBCC 22F8EF          16      LD  (GNCPAT),HL
001DD6 EBCF ED53FBEF        20      LD  (SNCPAT),DE
001DDA EBD3 ED43E1EA        20      LD  (FATSX),BC
001DDE EBD7 D1              10      POP DE
001DDF EBD8 C1              10      POP BC
001DE0 EBD9 AF               4      XOR A
001DE1 EBDA C9              10      RET
                                
       EBDB                     GETDPBD:
001DE2 EBDB DDE3            23      EX  (SP),IX
001DE4 EBDD DDE5            15      PUSH    IX
001DE6 EBDF 3A88EF          13      LD  A,(_DRV)
001DE9 EBE2 1807            12      JR  GETDPB1
                                
       EBE4                     CHGDRVR:
001DEB EBE4 CDD9EF          17      CALL    _CHGDRV
001DEE EBE7 D8              11      RET C
001DEF EBE8 3A89EF          13      LD  A,(_DSK)
       EBEB                     GETDPB1:
001DF2 EBEB C3DCEF          10      JP  _GETDPB
                                
       EBEE                     GETDPB:
001DF5 EBEE FE08             7      CP  8
001DF7 EBF0 3F               4      CCF
001DF8 EBF1 D8              11      RET C
001DF9 EBF2 0F               4      RRCA
001DFA EBF3 0F               4      RRCA
001DFB EBF4 0F               4      RRCA
001DFC EBF5 DD                      DB  0DDH        ;Z80未定義命令
001DFD EBF6 6F               4      LD  L,A     ;LD IXL,A
001DFE EBF7 DD                      DB  0DDH        ;Z80未定義命令
001DFF EBF8 26F2             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001E01 EBFA DD7E00          19      LD  A,(IX+DPB_FATLN)
001E04 EBFD A7               4      AND A       ;CF=0の為
001E05 EBFE DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001E09 EC02 C0              11      RET NZ      ;FAT16
001E0A EC03 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001E0E EC07 C0              11      RET NZ      ;BPB
001E0F EC08 FE01             7      CP  001H        ;A=0 THEN CF=1
001E11 EC0A C9              10      RET
                                
       EC0B                     _SYS5F:
001E12 EC0B AF               4      XOR A
       EC0C                     FFLUSH:
001E13 EC0C F5              11      PUSH    AF
001E14 EC0D CD26E8          17      CALL    WTFATX
001E17 EC10 AF               4      XOR A
001E18 EC11 32ABEF          13      LD  (_FATIX),A
001E1B EC14 2F               4      CPL         ;0FFH
001E1C EC15 32AAEF          13      LD  (_FATDRV),A
001E1F EC18 3E                      DB  03EH        ;次のPUSH AFをスキップ
       EC19                     FFLUSHBUF:
001E20 EC19 F5              11      PUSH    AF
001E21 EC1A CDDCE7          17      CALL    DWTX
001E24 EC1D 3EFF             7      LD  A,0FFH
001E26 EC1F 3239EF          13      LD  (SFILE),A
001E29 EC22 32A5EF          13      LD  (_DBDRV),A
001E2C EC25 F1              10      POP AF
001E2D EC26 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "88DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   PC-8801mkIISR
                                
                                ;   FLOPPY DISK DRIVER
                                ;
       EC27                     PUTCOM_EXECUTE:
001E2E EC27 3E0D             7      LD  A,0DH       ;エグゼキュート
                                ;   コマンド送信
       EC29                     PUTCOM:
001E30 EC29 F5              11      PUSH    AF
001E31 EC2A 3E0F             7      LD  A,00FH
001E33 EC2C D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
001E35 EC2E F1              10      POP AF
                                ;   通常ハンドシェイク（ホストが送信）
       EC2F                     PUTDAT:
001E36 EC2F F5              11      PUSH    AF
       EC30                     PUTDAT1:
001E37 EC30 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E39 EC32 E602             7      AND 2       ;RFD
001E3B EC34 28FA            12      JR  Z,PUTDAT1
001E3D EC36 3E0E             7      LD  A,00EH      ;ATN=0
001E3F EC38 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
001E41 EC3A F1              10      POP AF
001E42 EC3B D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
001E44 EC3D F5              11      PUSH    AF
001E45 EC3E 3E09             7      LD  A,9     ;DAV=1
001E47 EC40 D3FF            11      OUT (0FFH),A
       EC42                     PUTDAT2:
001E49 EC42 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E4B EC44 E604             7      AND 4       ;DAC
001E4D EC46 28FA            12      JR  Z,PUTDAT2
                                
001E4F EC48 3E08             7      LD  A,8     ;DAV=0
001E51 EC4A D3FF            11      OUT (0FFH),A
       EC4C                     PUTDAT3:
001E53 EC4C DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E55 EC4E E604             7      AND 4       ;DAC
001E57 EC50 20FA            12      JR  NZ,PUTDAT3
001E59 EC52 F1              10      POP AF
001E5A EC53 C9              10      RET
                                
                                ;   通常ハンドシェイク（ホストが受信）
       EC54                     GETDAT:
001E5B EC54 3E0B             7      LD  A,00BH      ;RFD=1
001E5D EC56 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
       EC58                     GETDAT1:
001E5F EC58 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E61 EC5A 0F               4      RRCA            ;DAV
001E62 EC5B 30FB            12      JR  NC,GETDAT1
                                
001E64 EC5D 3E0A             7      LD  A,00AH      ;RFD=0
001E66 EC5F D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001E68 EC61 DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001E6A EC63 F5              11      PUSH    AF
001E6B EC64 3E0D             7      LD  A,00DH      ;DAC=1
001E6D EC66 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
       EC68                     GETDAT2:
001E6F EC68 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E71 EC6A 0F               4      RRCA            ;DAV
001E72 EC6B 38FB            12      JR  C,GETDAT2
                                
001E74 EC6D 3E0C             7      LD  A,00CH      ;DAC=0
001E76 EC6F D3FF            11      OUT (0FFH),A
001E78 EC71 F1              10      POP AF
001E79 EC72 C9              10      RET
                                
                                ;   高速ハンドシェイク（ホストが送信）
                                ;   HL:アドレス BC:受信サイズ（必ず偶数にする）
       EC73                     FPUTDAT:
       EC73                     FPUTDAT1:
001E7A EC73 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E7C EC75 E602             7      AND 2       ;RFD
001E7E EC77 28FA            12      JR  Z,FPUTDAT1
001E80 EC79 3E0E             7      LD  A,00EH      ;ATN=0
001E82 EC7B D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001E84 EC7D 7E               7      LD  A,(HL)
001E85 EC7E D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
                                
001E87 EC80 3E09             7      LD  A,9     ;DAV=1
001E89 EC82 D3FF            11      OUT (0FFH),A
001E8B EC84 23               6      INC HL
001E8C EC85 0B               6      DEC BC
       EC86                     FPUTDAT2:
001E8D EC86 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E8F EC88 E604             7      AND 4       ;DAC
001E91 EC8A 28FA            12      JR  Z,FPUTDAT2
                                
001E93 EC8C 7E               7      LD  A,(HL)
001E94 EC8D D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
                                
001E96 EC8F 3E08             7      LD  A,8     ;DAV=0
001E98 EC91 D3FF            11      OUT (0FFH),A
       EC93                     FPUTDAT3:
001E9A EC93 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E9C EC95 E604             7      AND 4       ;DAC
001E9E EC97 20FA            12      JR  NZ,FPUTDAT3
                                
001EA0 EC99 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001EA2 EC9B EA73EC          10      JP  PE,FPUTDAT
001EA5 EC9E C9              10      RET
                                
                                
                                ;   高速ハンドシェイク（ホストが受信）
                                ;   HL:アドレス BC:受信サイズ（必ず偶数にする）
       EC9F                     FGETDAT:
001EA6 EC9F 3E0B             7      LD  A,00BH      ;RFD=1
001EA8 ECA1 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
       ECA3                     FGETDAT1:
001EAA ECA3 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001EAC ECA5 0F               4      RRCA            ;DAV
001EAD ECA6 30FB            12      JR  NC,FGETDAT1
                                
001EAF ECA8 3E0A             7      LD  A,00AH      ;RFD=0
001EB1 ECAA D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001EB3 ECAC DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001EB5 ECAE 77               7      LD  (HL),A
                                
001EB6 ECAF 3E0D             7      LD  A,00DH      ;DAC=1
001EB8 ECB1 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
001EBA ECB3 23               6      INC HL
001EBB ECB4 0B               6      DEC BC
       ECB5                     FGETDAT2:
001EBC ECB5 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001EBE ECB7 0F               4      RRCA            ;DAV
001EBF ECB8 38FB            12      JR  C,FGETDAT2
                                
001EC1 ECBA DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001EC3 ECBC 77               7      LD  (HL),A
                                
001EC4 ECBD 3E0C             7      LD  A,00CH      ;DAC=0
001EC6 ECBF D3FF            11      OUT (0FFH),A
                                
001EC8 ECC1 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001ECA ECC3 EA9FEC          10      JP  PE,FGETDAT
001ECD ECC6 C9              10      RET
                                
                                ;   論理セクタ番号からトラック番号とセクタ番号を得る
                                ;   in
                                ;   DE:論理セクタ
       ECC7                     CALC_SECTOR:
001ECE ECC7 C5              11      PUSH    BC
001ECF ECC8 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001ED2 ECCB 0610             7      LD  B,16
001ED4 ECCD AF               4      XOR A
001ED5 ECCE EB               4      EX  DE,HL
       ECCF                     DIV1:
001ED6 ECCF 29              11      ADD HL,HL
001ED7 ECD0 8F               4      ADC A,A
001ED8 ECD1 B9               4      CP  C
001ED9 ECD2 3802            12      JR  C,DIV2
001EDB ECD4 91               4      SUB C
001EDC ECD5 2C               4      INC L
       ECD6                     DIV2:
001EDD ECD6 10F7            13      DJNZ    DIV1
                                
001EDF ECD8 3C               4      INC A   ;最小のセクタは１固定
001EE0 ECD9 55               4      LD  D,L ;TRACK
       ECDA                     DIV3:
001EE1 ECDA 5F               4      LD  E,A ;SECTOR
001EE2 ECDB C1              10      POP BC
001EE3 ECDC C9              10      RET
                                
       ECDD                     WTTRK:
001EE4 ECDD 37               4      SCF
001EE5 ECDE C9              10      RET
       ECDF                     FDWT:
001EE6 ECDF E5              11      PUSH    HL
001EE7 ECE0 D5              11      PUSH    DE
001EE8 ECE1 CDC7EC          17      CALL    CALC_SECTOR
001EEB ECE4 7A               4      LD  A,D     ;トラック
001EEC ECE5 3243ED          13      LD  (FDWT_TRACK),A
001EEF ECE8 7B               4      LD  A,E     ;セクタ
001EF0 ECE9 323EED          13      LD  (FDWT_SECTOR),A
001EF3 ECEC DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001EF6 ECEF 93               4      SUB E
001EF7 ECF0 3C               4      INC A
001EF8 ECF1 67               4      LD  H,A
001EF9 ECF2 D1              10      POP DE
001EFA ECF3 3AB2E6          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
001EFD ECF6 4F               4      LD  C,A
001EFE ECF7 AF               4      XOR A
       ECF8                     FDWT2:
001EFF ECF8 81               4      ADD A,C
001F00 ECF9 13               6      INC DE
001F01 ECFA 05               4      DEC B
001F02 ECFB 2807            12      JR  Z,FDWT3
001F04 ECFD 25               4      DEC H       ;トラック、ヘッドを跨がない
001F05 ECFE 2804            12      JR  Z,FDWT3
001F07 ED00 FE3A             7      CP  03AH        ;バッファとして04000H-07BFFHまで使える
001F09 ED02 38F4            12      JR  C,FDWT2
       ED04                     FDWT3:
001F0B ED04 4F               4      LD  C,A
001F0C ED05 E1              10      POP HL
001F0D ED06 3E16             7      LD  A,16H       ;高速レシーブメモリ
001F0F ED08 CD29EC          17      CALL    PUTCOM
001F12 ED0B 3E40             7      LD  A,DSS_DATA/256  ;開始アドレスH
001F14 ED0D CD2FEC          17      CALL    PUTDAT
001F17 ED10 AF               4      XOR A       ;開始アドレスL
001F18 ED11 CD2FEC          17      CALL    PUTDAT
001F1B ED14 79               4      LD  A,C     ;バイト数H
001F1C ED15 CD2FEC          17      CALL    PUTDAT
001F1F ED18 AF               4      XOR A       ;バイト数L
001F20 ED19 CD2FEC          17      CALL    PUTDAT
001F23 ED1C C5              11      PUSH    BC
001F24 ED1D 41               4      LD  B,C
001F25 ED1E 0E00             7      LD  C,0
001F27 ED20 CD73EC          17      CALL    FPUTDAT
001F2A ED23 C1              10      POP BC
001F2B ED24 CD27EC          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001F2E ED27 3E7C             7      LD  A,WRITEDISKEX/256
001F30 ED29 CD2FEC          17      CALL    PUTDAT
001F33 ED2C 3EA3             7      LD  A,WRITEDISKEX%256
001F35 ED2E CD2FEC          17      CALL    PUTDAT
001F38 ED31 DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
001F3B ED34 CD2FEC          17      CALL    PUTDAT
001F3E ED37 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001F41 ED3A CD2FEC          17      CALL    PUTDAT
       ED3E                     FDWT_SECTOR EQU $+1
001F44 ED3D 3E00             7      LD  A,0     ;セクタ
001F46 ED3F CD2FEC          17      CALL    PUTDAT
       ED43                     FDWT_TRACK  EQU $+1
001F49 ED42 3E00             7      LD  A,0     ;トラック
001F4B ED44 CD2FEC          17      CALL    PUTDAT
001F4E ED47 3AA4ED          13      LD  A,(FDMODE+1)    ;フロッピーディスクのモード(DPB_FDMODE)
001F51 ED4A CD2FEC          17      CALL    PUTDAT
001F54 ED4D 3AB2E6          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
001F57 ED50 CD2FEC          17      CALL    PUTDAT
001F5A ED53 79               4      LD  A,C
001F5B ED54 CD2FEC          17      CALL    PUTDAT      ;バイト数H
001F5E ED57 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;フロッピーディスクのシリンダ数
001F61 ED5A CD2FEC          17      CALL    PUTDAT
                                
001F64 ED5D CD27EC          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001F67 ED60 3E7E             7      LD  A,RESULTEX/256
001F69 ED62 CD2FEC          17      CALL    PUTDAT
001F6C ED65 3E13             7      LD  A,RESULTEX%256
001F6E ED67 CD2FEC          17      CALL    PUTDAT
                                
001F71 ED6A CD54EC          17      CALL    GETDAT
001F74 ED6D 4F               4      LD  C,A
001F75 ED6E FE01             7      CP  1
001F77 ED70 D8              11      RET C
                                
001F78 ED71 78               4      LD  A,B
001F79 ED72 B7               4      OR  A
001F7A ED73 C2DFEC          10      JP  NZ,FDWT
001F7D ED76 C9              10      RET
                                
       ED77                     FDRD:
001F7E ED77 CD27EC          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001F81 ED7A 3E7C             7      LD  A,READDISKEX/256
001F83 ED7C CD2FEC          17      CALL    PUTDAT
001F86 ED7F AF               4      XOR A
001F87 ED80 CD2FEC          17      CALL    PUTDAT
001F8A ED83 DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
001F8D ED86 CD2FEC          17      CALL    PUTDAT
001F90 ED89 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001F93 ED8C CD2FEC          17      CALL    PUTDAT
001F96 ED8F E5              11      PUSH    HL
001F97 ED90 D5              11      PUSH    DE
001F98 ED91 CDC7EC          17      CALL    CALC_SECTOR
001F9B ED94 7B               4      LD  A,E     ;セクタ
001F9C ED95 CD2FEC          17      CALL    PUTDAT
001F9F ED98 7A               4      LD  A,D     ;トラック
001FA0 ED99 CD2FEC          17      CALL    PUTDAT
001FA3 ED9C DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001FA6 ED9F 93               4      SUB E
001FA7 EDA0 3C               4      INC A
001FA8 EDA1 67               4      LD  H,A
001FA9 EDA2 D1              10      POP DE
001FAA EDA3 3EFF             7  FDMODE: LD  A,0FFH      ;フロッピーディスクのモード(DPB_FDMODE)
001FAC EDA5 CD2FEC          17      CALL    PUTDAT
001FAF EDA8 3AB2E6          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
001FB2 EDAB CD2FEC          17      CALL    PUTDAT
001FB5 EDAE 4F               4      LD  C,A
001FB6 EDAF AF               4      XOR A
       EDB0                     FDRD2:
001FB7 EDB0 81               4      ADD A,C
001FB8 EDB1 13               6      INC DE
001FB9 EDB2 05               4      DEC B
001FBA EDB3 2807            12      JR  Z,FDRD3
001FBC EDB5 25               4      DEC H       ;トラック、ヘッドを跨がない
001FBD EDB6 2804            12      JR  Z,FDRD3
001FBF EDB8 FE3A             7      CP  03AH        ;バッファとして04000H-07BFFHまで使える
001FC1 EDBA 38F4            12      JR  C,FDRD2
       EDBC                     FDRD3:
001FC3 EDBC E1              10      POP HL
001FC4 EDBD 4F               4      LD  C,A
001FC5 EDBE CD2FEC          17      CALL    PUTDAT      ;バイト数H
001FC8 EDC1 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;フロッピーディスクのシリンダ数
001FCB EDC4 CD2FEC          17      CALL    PUTDAT
                                
001FCE EDC7 CD27EC          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001FD1 EDCA 3E7E             7      LD  A,RESULTEX/256
001FD3 EDCC CD2FEC          17      CALL    PUTDAT
001FD6 EDCF 3E13             7      LD  A,RESULTEX%256
001FD8 EDD1 CD2FEC          17      CALL    PUTDAT
                                
001FDB EDD4 CD54EC          17      CALL    GETDAT
001FDE EDD7 4F               4      LD  C,A
001FDF EDD8 FE01             7      CP  1
001FE1 EDDA D8              11      RET C
                                
001FE2 EDDB 3E15             7      LD  A,15H       ;高速センドメモリ
001FE4 EDDD CD29EC          17      CALL    PUTCOM
001FE7 EDE0 3E40             7      LD  A,DSS_DATA/256  ;開始アドレスH
001FE9 EDE2 CD2FEC          17      CALL    PUTDAT
001FEC EDE5 AF               4      XOR A       ;開始アドレスL
001FED EDE6 CD2FEC          17      CALL    PUTDAT
001FF0 EDE9 79               4      LD  A,C     ;バイト数H
001FF1 EDEA CD2FEC          17      CALL    PUTDAT
001FF4 EDED AF               4      XOR A       ;バイト数L
001FF5 EDEE CD2FEC          17      CALL    PUTDAT
001FF8 EDF1 C5              11      PUSH    BC
001FF9 EDF2 41               4      LD  B,C
001FFA EDF3 0E00             7      LD  C,0
001FFC EDF5 CD9FEC          17      CALL    FGETDAT
001FFF EDF8 C1              10      POP BC
002000 EDF9 78               4      LD  A,B
002001 EDFA B7               4      OR  A
002002 EDFB C277ED          10      JP  NZ,FDRD
002005 EDFE C9              10      RET
                                
       EF6A                     FSPAT   EQU BEEPD+9
                                
[EOF:88DISK.ASM:UTF_8]
                                    INCLUDE "88INTVEC.ASM"
                                
                                ;   LSX-Dodgers TABLE 割り込みベクタとキーのテーブル(Shift/Ctrl)
                                
       EDFF                     AT_TABLE:
002006 EDFF                         DS  INTAD-AT_TABLE
                                
                                ;
                                ;   割り込みベクタ:アドレス下位1バイトが0になるように
                                ;
       EE00                     IRXRDY:
002007 EE00 A6D9                    DW  INTE88
       EE02                     IVRTC:
002009 EE02 70D9                    DW  INTVRTC
       EE04                     ICLOCK:
00200B EE04 A6D9                    DW  INTE88
       EE06                     IINT4:
00200D EE06 A6D9                    DW  INTE88
       EE08                     IINT3:
00200F EE08 A6D9                    DW  INTE88
       EE0A                     IINT2:
002011 EE0A A6D9                    DW  INTE88
       EE0C                     IFDINT1:
002013 EE0C A6D9                    DW  INTE88
       EE0E                     IFDINT2:
002015 EE0E A6D9                    DW  INTE88
                                
002017 EE10                         DS  030H-18
       EE2E                     EXTSP:
                                
       EE2E                     SHIFT_TABLE:
002035 EE2E 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
00203D EE36 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
002045 EE3E 4041424344454647        DB  '@','A','B','C','D','E','F','G' ;2
00204D EE46 48494A4B4C4D4E4F        DB  'H','I','J','K','L','M','N','O' ;3
002055 EE4E 5051525354555657        DB  'P','Q','R','S','T','U','V','W' ;4
00205D EE56 58595A7B7C7D7E3D        DB  'X','Y','Z','{','|','}','~','=' ;5
002065 EE5E 3021222324252627        DB  '0','!','"','#','$','%','&',27H ;6
00206D EE66 28292A2B3C3E3F5F        DB  '(',')','*','+','<','>','?','_' ;7
002075 EE6E 0B1E1C0800000000        DB  0BH,1EH,1CH,08H,00H,00H,00H,00H ;8
00207D EE76 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
002085 EE7E 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
00208D EE86 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
002095 EE8E 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
                                
       EE96                     CTRL_TABLE:
00209D EE96 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
0020A5 EE9E 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
0020AD EEA6 4001020304050607        DB  '@',01H,02H,03H,04H,05H,06H,07H ;2
0020B5 EEAE 08090A0B0C0D0E0F        DB  08H,09H,0AH,0BH,0CH,0DH,0EH,0FH ;3
0020BD EEB6 1011121314151617        DB  10H,11H,12H,13H,14H,15H,16H,17H ;4
0020C5 EEBE 18191A5B5C5D5E2D        DB  18H,19H,1AH,'[',5CH,']','^','-' ;5
0020CD EEC6 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;6
0020D5 EECE 38393A3B2C2E2F5F        DB  '8','9',':',';',',','.','/','_' ;7
0020DD EED6 0C1E1C0800000000        DB  0CH,1EH,1CH,08H,00H,00H,00H,00H ;8
0020E5 EEDE 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
0020ED EEE6 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
0020F5 EEEE 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
0020FD EEF6 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
[EOF:88INTVEC.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
       EEFE                     AT_WORK:
002105 EEFE                         DS  WORKAD-AT_WORK
                                
       EF00                     CPM_BOOT:
002107 EF00 C30000          10      JP  0
       EF03                     _SYS00:     ;(BDOS)プログラム終了
       EF03                     CPM_WBOOT:
00210A EF03 C309D2          10      JP  WBOOT1
       EF06                     CPM_CONST:
00210D EF06 C34DDA          10      JP  CONSTX
       EF09                     _SYS07:     ;(BDOS)コンソール直接入力
       EF09                     CPM_CONIN:
002110 EF09 C305DA          10      JP  FLGET
       EF0C                     CPM_CONOUT:
002113 EF0C C387DC          10      JP  CONOUT1
                                
       EF0F                     DECBF:              ;10進数表示時のバッファ(5バイト)
002116 EF0F                         DS  5
       EF0F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       EF11                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
00211B EF14 00                  FDRV:   DB  0
00211C EF15                     FNAME:  DS  36
002140 EF39                     SFILE:  DS  33      ;DRV FILENAME
                                
002161 EF5A                         DS  3
                                
002164 EF5D 0000                LEFTX:  DW  0
002166 EF5F 0000                DTAX:   DW  0
                                
       EF61                     ZERO:
       EF61                     BEEPD:
002168 EF61 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
002170 EF69 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
       EF62                     RTC_YY  EQU BEEPD+1
       EF63                     RTC_MW  EQU BEEPD+2
       EF64                     RTC_DD  EQU BEEPD+3
       EF65                     RTC_TT  EQU BEEPD+4
       EF66                     RTC_MM  EQU BEEPD+5
       EF67                     RTC_SS  EQU BEEPD+6
       EF62                     ROM_SLT EQU BEEPD+1
                                
002177 EF70 00                  CHECK:  DB  0
                                
002178 EF71 4F4B24              OK: DB  "OK$"
00217B EF74                         DS  5
002180 EF79 4572726F722124      COMERM: DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
002187 EF80 FF                  _CYL0:  DB  0FFH    ;Cylinder
002188 EF81 FF                  _CYL1:  DB  0FFH    ;Cylinder
002189 EF82 FF                  _CYL2:  DB  0FFH    ;Cylinder
00218A EF83 FF                  _CYL3:  DB  0FFH    ;Cylinder
00218B EF84 00                  _DRIVE: DB  0   ;unit number
00218C EF85 00                  _SEEKSP:DB  0   ;Seek speed
00218D EF86 FF                  _ISEEK: DB  0FFH    ;
00218E EF87 00                  _DVSW:  DB  0
00218F EF88 00                  _DRV:   DB  0
002190 EF89 FF                  _DSK:   DB  0FFH
002191 EF8A 8000                _DTA:   DW  00080H
002193 EF8C 0000                _CTC:   DW  0
002195 EF8E 0000                _TXADR: DW  0
002197 EF90 0000                _KEYPS: DW  0
002199 EF92 00FF                _KEYD:  DW  0FF00H  ;キーデータ
00219B EF94 0010                _KEYSP: DB  KEYSP_L,KEYSP_H ;オートリピートの速度
00219D EF96 00                  _COLORF:DB  COLORF  ;色
00219E EF97 18                  _LINE:  DB  LINE
                                
00219F EF98 0000                _FCB:   DW  0   ;SEARCH FILES
0021A1 EF9A 0000                _FBPS:  DW  0   ;    //
0021A3 EF9C 0000                _FBAD:  DW  0   ;    //
0021A5 EF9E 00                  _FBCNT: DB  0   ;    //
0021A6 EF9F 00                  _FILEN: DB  0   ;    //
0021A7 EFA0 00                  _DIRF:  DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
0021A8 EFA1                         DS  1
0021A9 EFA2 00                  _WTFATF:DB  0   ;FATバッファの更新フラグ
0021AA EFA3                         DS  1
0021AB EFA4 00                  _WTDBF: DB  0   ;データバッファの更新フラグ
0021AC EFA5 FF                  _DBDRV: DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
0021AD EFA6 0000                _DBSEC: DW  0   ;データバッファにあるデータを読み込んだセクタ番号
0021AF EFA8 0000                _DPB:   DW  0
       EFAA                     _FATDRV:
0021B1 EFAA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
0021B2 EFAB 00                  _FATIX: DB  0   ;FATバッファに読み込んでいるインデックス
       EFAC                     _FAKEFREE:
0021B3 EFAC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
0021B5 EFAE                         DS  2
                                
       EFB0                     CRTCD:
0021B7 EFB0 6F                      DB  06FH
       EFB1                     _WIDTH:
0021B8 EFB1 50                      DB  WIDTH
       EFB2                     TVRAMTOP:
0021B9 EFB2 5938                    DB  059H,038H
0021BB EFB4 1F02                    DB  01FH,002H
       EFB6                     _LINE2:
0021BD EFB6 19                      DB  019H
       EFB7                     WKE4:
0021BE EFB7 1C                      DB  01CH
       EFB8                     WKE6:
0021BF EFB8 00                      DB  000H
       EFB9                     WK40:
0021C0 EFB9 07                      DB  007H
       EFBA                     _PAGE_MINUS:
0021C1 EFBA 80F8                    DW  0-WIDTH*LINE
       EFBC                     _WIDTH_MINUS:
0021C3 EFBC B0FF                    DW  0-WIDTH
       EFBE                     WK30:
0021C5 EFBE 0C                      DB  00CH
       EFBF                     WK31:
       EFBF                     WK1FD0:
0021C6 EFBF 20                      DB  020H
                                
0021C7 EFC0 0000                CTC0:   DW  INTCTCE
0021C9 EFC2 0000                CTC1:   DW  INTCTCE
0021CB EFC4 0000                CTC2:   DW  INTCTCE
0021CD EFC6 0000                CTC3:   DW  INTCTCE
0021CF EFC8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
0021D1 EFCA C3C0DD          10  _INKEY: JP  INKEY
0021D4 EFCD C383DB          10  _PRINT: JP  PRINT
0021D7 EFD0 C319DE          10  _SCRN:  JP  SCRN
0021DA EFD3 C362DD          10  _POS:   JP  POS
0021DD EFD6 C3CBDB          10  _LOC:   JP  LOC
       EFD9                     _CHGDRV:
0021E0 EFD9 C323EB          10      JP  CHGDRV
       EFDC                     _GETDPB:
0021E3 EFDC C3EEEB          10      JP  GETDPB
       EFDF                     _FFLUSH:
0021E6 EFDF C30CEC          10      JP  FFLUSH
       EFE2                     _RDFATX:
0021E9 EFE2 C3FCE7          10      JP  RDFATX
0021EC EFE5 C324E9          10  _RDFAT: JP  RDFAT
0021EF EFE8 C3DDEC          10  _WTTRK: JP  WTTRK
0021F2 EFEB C377ED          10  _FDRD:  JP  FDRD
0021F5 EFEE C3DFEC          10  _FDWT:  JP  FDWT
       EFF1                     _BPB2DPB:
0021F8 EFF1 C3B1E9          10      JP  BPB2DPB
       EFF4                     _BREAK:
0021FB EFF4 C3ACD3          10      JP  END_BATCH
       EFF7                     _GNCL:
0021FE EFF7 C39EE8          10      JP  GNCL        ; self-modifying code
       EFF8                     GNCPAT  EQU $-2
       EFFA                     _SNCL:
002201 EFFA C3C1E8          10      JP  SNCL        ; self-modifying code
       EFFB                     SNCPAT  EQU $-2
002204 EFFD C366D2          10  _COMANL:JP  COMANL
                                
       F000                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F000                     STABLE:
                                ;0
002207 F000 03EFD8D9E4D950E0        DW  _SYS00,_SYS01,_SYS02,_SYS03
00220F F008 D1D6D1D6E9D909EF        DW  _SYS04,_SYS05,_SYS06,_SYS07
002217 F010 F1D9D3D619DA45DA        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
00221F F018 E8D6EDD6FCD60DD7        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
002227 F020 61D7A8D7F1D727D8        DW  _SYS10,_SYS11,_SYS12,_SYS13
00222F F028 2FD845D85AD852D8        DW  _SYS14,_SYS15,_SYS16,_SYS17
002237 F030 A1D8A6D8ABD8B1D8        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
00223F F038 D1D6D7D8D1D6DBD8        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
002247 F040 D1D691D899D8E2D8        DW  _SYS20,_SYS21,_SYS22,_SYS23
00224F F048 08D9D1D6D0E4A8E5        DW  _SYS24,_ERROR,_SYS26,_SYS27
002257 F050 99D811D95BDA50E0        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
00225F F058 82DA50E0D1D632D9        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
002267 F060 2CD9D1D6D1D6D1D6        DW  _SYS30,_ERROR,_ERROR,_ERROR
00226F F068 D1D6D1D6D1D6D1D6        DW  _ERROR,_ERROR,_ERROR,_ERROR
002277 F070 D1D650E050E053D9        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
00227F F078 B4D6                    DW  _DOS2
                                
002281 F07A                         DS  2
002283 F07C 00F3                _FATBF: DW  FATBF
002285 F07E 00FB                _DTBUF: DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F080                     CTRLTB:
002287 F080 CEDBCEDB05DC0DDD        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
00228F F088 07DD30DCE0DCACDC        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002297 F090 D5DBFADB10DD5CDC        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
00229F F098 DDDC4FDC17DDCEDB        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
0022A7 F0A0 CEDBCEDB54DCCEDB        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
0022AF F0A8 CEDBCEDBCEDBCEDB        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
0022B7 F0B0 CEDBCEDBDDDC63DC        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
0022BF F0B8 B7DBDCDBF1DB10DD        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
0022C7 F0C0 0200                M2D:    DW  2
0022C9 F0C2 FD02                    DB  0FDH,2
0022CB F0C4 6401                    DW  356
0022CD F0C6 FF0728090182            DB  0FFH,7,40,9,1,082H
0022D3 F0CC 0500A7000800            DW  5,0A7H,8
                                
0022D9 F0D2 0200                M2HD:   DW  2
0022DB F0D4 FE01                    DB  0FEH,1
0022DD F0D6 C704                    DW  1223
0022DF F0D8 FE064D080184            DB  0FEH,6,77,8,1,084H
0022E5 F0DE 0500A7000900            DW  5,0A7H,9
                                
0022EB F0E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
0022ED F0E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
0022EF F0E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
0022F1 F0EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F0EE                     SDDATAE:
                                
0022F5 F0EE                         DS  2
       F0F0                     _FCB_BAT:
0022F7 F0F0 61F1                    DW  FCB_BAT
       F0F2                     _PATH:
0022F9 F0F2 00F1                    DW  PATHD
                                
0022FB F0F4                     SCDIR:  DS  2       ;+14 +15
0022FD F0F6                     SFBPS:  DS  2       ;FBPS
0022FF F0F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
002301 F0FA 0000                _FATPS: DW  0
002303 F0FC 0000                _DIRPS: DW  0
002305 F0FE 0000                _CLPS:  DW  0
                                
       F100                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
002307 F100                     PATHD:  DS  PATHX
002342 F13B 00                  PATHE:  DB  0
                                
       F13C                     DTA_CCP:
002343 F13C                         DS  37
                                
       F161                     FCB_BAT:
002368 F161                         DS  37
                                
00238D F186 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
002398 F191 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "88TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE キーのテーブル
                                
       F198                     KEY_TABLE:
00239F F198 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
0023A7 F1A0 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
0023AF F1A8 4061626364656667        DB  '@','a','b','c','d','e','f','g' ;2
0023B7 F1B0 68696A6B6C6D6E6F        DB  'h','i','j','k','l','m','n','o' ;3
0023BF F1B8 7071727374757677        DB  'p','q','r','s','t','u','v','w' ;4
0023C7 F1C0 78797A5B5C5D5E2D        DB  'x','y','z','[',5CH,']','^','-' ;5
0023CF F1C8 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;6
0023D7 F1D0 38393A3B2C2E2F5C        DB  '8','9',':',';',',','.','/',5CH ;7
0023DF F1D8 0C1E1C0800000000        DB  0CH,1EH,1CH,08H,00H,00H,00H,00H ;8
0023E7 F1E0 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
0023EF F1E8 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
0023F7 F1F0 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
0023FF F1F8 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
[EOF:88TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "88DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   PC-8801mkIISR
                                
       F200                     _DEVICE:
                                
                                ;   A:
                                
002407 F200 0200                    DW  2   ;DPB_FATLN
002409 F202 EBEF                    DW  _FDRD   ;DPB_DRD
00240B F204 EEEF                    DW  _FDWT   ;DPB_DWT
00240D F206 FD                      DB  0FDH    ;DPB_FATID
00240E F207 02                      DB  2   ;DPB_SECPCL
00240F F208 6401                    DW  356 ;DPB_MAXCL
002411 F20A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002412 F20B 07                      DB  7   ;DPB_DIRSCNT
002413 F20C 28                      DB  40  ;DPB_MAXCYL
002414 F20D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002415 F20E 01                      DB  1   ;DPB_FATPS
002416 F20F 82                      DB  082H    ;DPB_BPS
002417 F210 0500                    DW  5   ;DPB_DIRPS
002419 F212 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00241A F213 00                      DB  0   ;DPB_UNITNO
00241B F214 0800                    DW  8   ;DPB_ADDCL
00241D F216 0000                    DW  0   ;DPB_16
00241F F218 0000                    DW  0   ;DPB_18
002421 F21A 0000                    DW  0   ;DPB_SDIR
002423 F21C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002427 F220 0200                    DW  2   ;DPB_FATLN
002429 F222 EBEF                    DW  _FDRD   ;DPB_DRD
00242B F224 EEEF                    DW  _FDWT   ;DPB_DWT
00242D F226 FD                      DB  0FDH    ;DPB_FATID
00242E F227 02                      DB  2   ;DPB_SECPCL
00242F F228 6401                    DW  356 ;DPB_MAXCL
002431 F22A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002432 F22B 07                      DB  7   ;DPB_DIRSCNT
002433 F22C 28                      DB  40  ;DPB_MAXCYL
002434 F22D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002435 F22E 01                      DB  1   ;DPB_FATPS
002436 F22F 82                      DB  082H    ;DPB_BPS
002437 F230 0500                    DW  5   ;DPB_DIRPS
002439 F232 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00243A F233 01                      DB  1   ;DPB_UNITNO
00243B F234 0800                    DW  8   ;DPB_ADDCL
00243D F236 0000                    DW  0   ;DPB_16
00243F F238 0000                    DW  0   ;DPB_18
002441 F23A 0000                    DW  0   ;DPB_SDIR
002443 F23C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002447 F240                         DS  32
                                
                                ;   D:
                                
002467 F260                         DS  32
                                
                                ;   E:
                                
002487 F280                         DS  32
                                
                                ;   F:
                                
0024A7 F2A0 0000                BANKFL: DW  0   ;DPB_FATLN
0024A9 F2A2 5FD6                    DW  BDRD    ;DPB_DRD
0024AB F2A4 5BD6                    DW  BDWT    ;DPB_DWT
0024AD F2A6 F9                      DB  0F9H    ;DPB_FATID
0024AE F2A7 02                      DB  2   ;DPB_SECPCL
0024AF F2A8 0000                BANKCL: DW  0   ;DPB_MAXCL
0024B1 F2AA 00                      DB  0   ;DPB_FDMODE
0024B2 F2AB 08                      DB  8   ;DPB_DIRSCNT
0024B3 F2AC 00                      DB  0   ;DPB_MAXCYL
0024B4 F2AD 01                      DB  1   ;DPB_MAXSEC
0024B5 F2AE 00                      DB  0   ;DPB_FATPS
0024B6 F2AF 02                      DB  2   ;DPB_BPS
0024B7 F2B0 0200                    DW  2   ;DPB_DIRPS
0024B9 F2B2 0B                  BANKDV: DB  00BH    ;DPB_DEVICE
0024BA F2B3 00                      DB  0   ;DPB_UNITNO
0024BB F2B4 0600                    DW  6   ;DPB_ADDCL
0024BD F2B6 0000                    DW  0   ;DPB_16
0024BF F2B8 0000                    DW  0   ;DPB_18
0024C1 F2BA 0000                    DW  0   ;DPB_SDIR
0024C3 F2BC 454D454D                DB  "EMEM"  ;DPB_NAME
                                
                                ;   G:
                                
0024C7 F2C0                         DS  32
                                
                                ;   H:
0024E7 F2E0                         DS  32-8
0024FF F2F8 00                      DB  0
[EOF:88DPB.ASM:UTF_8]
                                
       F2F9                     LAST_ADR:
                                
                                    END
[EOF:88.ASM:UTF_8]
