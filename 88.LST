                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for PC-8801mkIISR
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "88DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   PC-8001mkIISR
                                
       0002                     MAC EQU 2   ;PC-8001mkIISR
       0001                     DEV EQU 1
                                
       011D                     VER_6F  EQU 0011DH
                                
       D100                     RUN EQU 0D100H
       D0F9                     OFFSET  EQU RUN-7
                                
       D906                     BDOS    EQU 0D906H
       EE00                     WORKAD  EQU 0EE00H
       F700                     FATBF   EQU 0F700H
       FD00                     DTBUF   EQU 0FD00H
       FF20                     KBUF    EQU 0FF20H
       FFBB                     SUBSYS  EQU EXTBIO-5*3
       FFD9                     TRAP38  EQU 0FFD9H
       0050                     WIDTH   EQU 80
       0018                     LINE    EQU 24
       0000                     COLORF  EQU 0
       0014                     KEYSP_H EQU 20
       0000                     KEYSP_L EQU 0
       0008                     COMS    EQU 8
       0002                     MAX_SEC_SZ_H    EQU 2       ;1セクタ1024バイトのサポート(2:off 4:on)
       0100                     BUFFER  EQU 00100H
       D9FD                     S27BUF_COM  EQU S27BUF
                                
                                ; ディスクサブシステム
       002A                     MAIN        EQU 0002AH
                                
       4000                     DSS_DATA    EQU 04000H
                                
       7C00                     DSS     EQU 07C00H
[EOF:88DEF.ASM:SHIFT_JIS]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0002                     VER_3   EQU 2
       1D02                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0102                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0162                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 D0F9                         ORG OFFSET
                                
                                ;   MSX BINARY HEADER
000000 D0F9 FE                      DB  0FEH
                                ;   MSX BINARY START ADDRESS
000001 D0FA 00D1                    DW  RUN
                                ;   MSX BINARY END ADDRESS
000003 D0FC F9F6                    DW  LAST_ADR
                                ;   MSX BINARY EXEC ADDRESS
000005 D0FE 07D1                    DW  START
                                
                                    INCLUDE "88INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   PC-8801mkIISR
                                
000007 D100 C307D1          10      JP  START
00000A D103 021D                    DW  MACW
00000C D105 6201                    DW  VER
                                
       D107                     START:
00000E D107 F3               4      DI
00000F D108 ED5E             8      IM  2
000011 D10A 3107D1          10      LD  SP,START
000014 D10D CD1BD1          17      CALL    INIT        ;NZならAUTOEXECを実行
000017 D110 210000          10      LD  HL,0
00001A D113 E5              11      PUSH    HL
00001B D114 C8              11      RET Z
00001C D115 11B3D2          10      LD  DE,AUTOD
00001F D118 C3FDEE          10      JP  _COMANL
                                
       D11B                     INIT:
000022 D11B DB32            11      IN  A,(032H)
000024 D11D E6EF             7      AND 0EFH        ;高速RAMアクセスモード/高速RAM
000026 D11F D332            11      OUT (032H),A
                                
000028 D121 21C8F3          10      LD  HL,0F3C8H   ;テキストをクリア
00002B D124 11E880          10      LD  DE,080E8H
00002E D127 0E20             7      LD  C,' '
000030 D129 3E19             7      LD  A,25
       D12B                     TVCL1:
000032 D12B 0650             7      LD  B,80
       D12D                     TVCL2:
000034 D12D 71               7      LD  (HL),C
000035 D12E 23               6      INC HL
000036 D12F 10FC            13      DJNZ    TVCL2
000038 D131 0614             7      LD  B,20
       D133                     TVCL3:
00003A D133 72               7      LD  (HL),D
00003B D134 2C               4      INC L
00003C D135 73               7      LD  (HL),E
00003D D136 23               6      INC HL
00003E D137 10FA            13      DJNZ    TVCL3
000040 D139 3D               4      DEC A
000041 D13A 20EF            12      JR  NZ,TVCL1
                                
000043 D13C 2131D3          10      LD  HL,AT_VRAM
000046 D13F 1100F0          10      LD  DE,0F000H
000049 D142 01F002          10      LD  BC,AT_VRAME-AT_VRAM
00004C D145 EDB0                    LDIR
                                
00004E D147 DB32            11      IN  A,(032H)
000050 D149 F610             7      OR  010H        ;高速RAMアクセスモード/メインRAM
000052 D14B D332            11      OUT (032H),A
       D14D                     INIT_CRTC:
000054 D14D 3E03             7      LD  A,3     ;80桁
000056 D14F D330            11      OUT (030H),A
000058 D151 32BEEE          13      LD  (WK30),A
                                
00005B D154 3E22             7      LD  A,022H      ;25行 64K RAM
00005D D156 D331            11      OUT (031H),A
00005F D158 32BFEE          13      LD  (WK31),A
                                
000062 D15B 3EFF             7      LD  A,0FFH
000064 D15D D3E4            11      OUT (0E4H),A    ;割り込みレベル設定
000066 D15F 32B7EE          13      LD  (WKE4),A
000069 D162 3E00             7      LD  A,0
00006B D164 D3E6            11      OUT (0E6H),A    ;割り込みマスク
                                
00006D D166 3EED             7      LD  A,IVRTC/256 ;割り込みベクタ
00006F D168 ED47             9      LD  I,A
                                
000071 D16A 3E19             7      LD  A,019H
000073 D16C D340            11      OUT (040H),A    ;CRT I/F 同期ビットオン
000075 D16E 32B9EE          13      LD  (WK40),A
000078 D171 CD93E2          17      CALL    VBLANK
                                
00007B D174 AF               4      XOR A
00007C D175 D351            11      OUT (051H),A    ;Reset CRTC
00007E D177 3EA0             7      LD  A,0A0H
000080 D179 D368            11      OUT (068H),A    ;DMAC: Mode Set(Reset)
000082 D17B 21C8F3          10      LD  HL,0F3C8H
000085 D17E 22B2EE          16      LD  (TVRAMTOP),HL
000088 D181 0E64             7      LD  C,064H
00008A D183 ED69            12      OUT (C),L       ;TVRAM LOW
00008C D185 ED61            12      OUT (C),H       ;TVRAM HIGH
00008E D187 21B78B          10      LD  HL,08000H+120*25-1
000091 D18A 0C               4      INC C       ;65H
000092 D18B ED69            12      OUT (C),L
000094 D18D ED61            12      OUT (C),H
000096 D18F 3ECE             7      LD  A,080H+80-2
000098 D191 D350            11      OUT (050H),A
00009A D193 3E98             7      LD  A,080H+25-1
00009C D195 D350            11      OUT (050H),A
00009E D197 DB40            11      IN  A,(040H)
0000A0 D199 CB4F             8      BIT 1,A
0000A2 D19B 21DE67          10      LD  HL,067DEH
0000A5 D19E 2003            12      JR  NZ,RESO1
0000A7 D1A0 21586F          10      LD  HL,06F58H
       D1A3                     RESO1:
0000AA D1A3 0E50             7      LD  C,050H
0000AC D1A5 ED61            12      OUT (C),H
0000AE D1A7 ED69            12      OUT (C),L
                                
0000B0 D1A9 3E53             7      LD  A,053H
0000B2 D1AB D350            11      OUT (050H),A
                                
0000B4 D1AD 3E43             7      LD  A,043H
0000B6 D1AF D351            11      OUT (051H),A
                                
0000B8 D1B1 3EE4             7      LD  A,0E4H
0000BA D1B3 D368            11      OUT (068H),A
                                
0000BC D1B5 3E20             7      LD  A,020H
0000BE D1B7 D351            11      OUT (051H),A
                                
0000C0 D1B9 CD93E2          17      CALL    VBLANK
       D1BC                     IVBL1:
0000C3 D1BC DB40            11      IN  A,(040H)
0000C5 D1BE CB6F             8      BIT 5,A
0000C7 D1C0 20FA            12      JR  NZ,IVBL1
                                
0000C9 D1C2 3E11             7      LD  A,011H
0000CB D1C4 D340            11      OUT (040H),A    ;CRT I/F 同期ビットオフ
0000CD D1C6 32B9EE          13      LD  (WK40),A
                                
0000D0 D1C9 CDA8E1          17      CALL    CURSOR_OFF
       D1CC                     BANK:
0000D3 D1CC 01E300          10      LD  BC,000E3H   ;拡張RAM バンク選択
0000D6 D1CF 21007F          10      LD  HL,07F00H
0000D9 D1D2 56               7      LD  D,(HL)
0000DA D1D3 F3               4      DI
0000DB D1D4 3E01             7      LD  A,1     ;リード可
0000DD D1D6 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
0000DF D1D8 ED41            12      OUT (C),B       ;拡張RAM バンク選択
0000E1 D1DA 3A0000          13      LD  A,(0)
0000E4 D1DD FEEB             7      CP  0EBH
0000E6 D1DF 2005            12      JR  NZ,BANK1
0000E8 D1E1 3E2B             7      LD  A,02BH
0000EA D1E3 32B2F6          13      LD  (BANKDV),A
       D1E6                     BANK1:
0000ED D1E6 3E01             7      LD  A,1     ;リード可
0000EF D1E8 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
0000F1 D1EA ED41            12      OUT (C),B       ;拡張RAM バンク選択
0000F3 D1EC 5E               7      LD  E,(HL)
0000F4 D1ED 7B               4      LD  A,E
0000F5 D1EE C6A5             7      ADD A,0A5H
0000F7 D1F0 77               7      LD  (HL),A      ;メインメモリに書き込む
0000F8 D1F1 BE               7      CP  (HL)
0000F9 D1F2 2811            12      JR  Z,BANK2     ;メインメモリが反映されているか？
0000FB D1F4 3E11             7      LD  A,011H      ;ライト/リード可
0000FD D1F6 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
0000FF D1F8 7B               4      LD  A,E
000100 D1F9 C6A5             7      ADD A,0A5H
000102 D1FB 77               7      LD  (HL),A
000103 D1FC BE               7      CP  (HL)
000104 D1FD 73               7      LD  (HL),E      ;拡張RAM に元の値を戻す
000105 D1FE 2005            12      JR  NZ,BANK2    ;拡張RAM に反映しているか？
000107 D200 04               4      INC B
000108 D201 CB60             8      BIT 4,B
00010A D203 28E1            12      JR  Z,BANK1
       D205                     BANK2:
00010C D205 AF               4      XOR A       ;ライト/リード不可
00010D D206 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
00010F D208 72               7      LD  (HL),D      ;メインメモリ に元の値を戻す
000110 D209 78               4      LD  A,B
000111 D20A B7               4      OR  A
000112 D20B 2814            12      JR  Z,NOBANK
000114 D20D 68               4      LD  L,B
000115 D20E 2600             7      LD  H,0
000117 D210 29              11      ADD HL,HL   ;*2
000118 D211 29              11      ADD HL,HL   ;*4
000119 D212 29              11      ADD HL,HL   ;*8
00011A D213 29              11      ADD HL,HL   ;*16
00011B D214 29              11      ADD HL,HL   ;*32
00011C D215 2B               6      DEC HL  ;-1
00011D D216 2B               6      DEC HL  ;-2
00011E D217 2B               6      DEC HL  ;-3
00011F D218 22A8F6          16      LD  (BANKCL),HL
000122 D21B CDA3D2          17      CALL    CALC_FATLN
000125 D21E 32A0F6          13      LD  (BANKFL),A
       D221                     NOBANK:
                                                ;初期化
000128 D221 AF               4      XOR A       ;イニシャライズ
000129 D222 CDD5EA          17      CALL    PUTCOM
00012C D225 3E16             7      LD  A,16H       ;高速レシーブメモリ
00012E D227 CDD5EA          17      CALL    PUTCOM
000131 D22A 3E7C             7      LD  A,DSS/256   ;開始アドレスH
000133 D22C CDDBEA          17      CALL    PUTDAT
000136 D22F AF               4      XOR A       ;開始アドレスL
000137 D230 CDDBEA          17      CALL    PUTDAT
00013A D233 015F02          10      LD  BC,AT_DSSE-AT_DSS
00013D D236 CB41             8      BIT 0,C
00013F D238 2801            12      JR  Z,SUBPG1
000141 D23A 03               6      INC BC      ;偶数にする
       D23B                     SUBPG1:
000142 D23B 78               4      LD  A,B     ;バイト数H
000143 D23C CDDBEA          17      CALL    PUTDAT
000146 D23F 79               4      LD  A,C
000147 D240 CDDBEA          17      CALL    PUTDAT
00014A D243 2121D6          10      LD  HL,AT_DSS
00014D D246 CD1FEB          17      CALL    FPUTDAT
                                
000150 D249 210000          10      LD  HL,0
000153 D24C 065C             7      LD  B,05CH
000155 D24E 3E                      DB  03EH    ;LD A,??
000156 D24F FF              12      RST 38H
000157 D250 CDB6F0          17      CALL    FILL_MEMORY
00015A D253 06A4             7      LD  B,0A4H
00015C D255 AF               4      XOR A
00015D D256 320400          13      LD  (_DVSW),A
000160 D259 CDB6F0          17      CALL    FILL_MEMORY
                                
000163 D25C 3EC3             7      LD  A,0C3H      ;JP
000165 D25E 2103EE          10      LD  HL,CPM_WBOOT
000168 D261 320000          13      LD  (00000H),A
00016B D264 220100          16      LD  (00001H),HL ;IPL
                                
00016E D267 2106D9          10      LD  HL,BDOS
000171 D26A 320500          13      LD  (00005H),A
000174 D26D 220600          16      LD  (00006H),HL ;BDOS
                                
000177 D270 21D9FF          10      LD  HL,TRAP38   ;TRAP38
00017A D273 323800          13      LD  (00038H),A
00017D D276 223900          16      LD  (00039H),HL ;RST 038H
                                
000180 D279 3EEE             7      LD  A,CPM_BOOT/256
000182 D27B 320B00          13      LD  (0000BH),A
                                
000185 D27E 3E                      DB  03EH    ;LD A,??
000186 D27F E9               4      JP  (HL)
000187 D280 320F00          13      LD  (0000FH),A
                                
00018A D283 21BFD2          10      LD  HL,INIMES
00018D D286 CDDEDD          17      CALL    MSX
       D289                     INIT1:
000190 D289 F3               4      DI
000191 D28A 1100FF          10      LD  DE,0FF00H
000194 D28D 06BB             7      LD  B,SUBSYS%256
000196 D28F CD3FDC          17      CALL    ZERO_MEMORY_DE
                                
000199 D292 21ECD2          10      LD  HL,AT_SUBSYS
00019C D295 11BBFF          10      LD  DE,SUBSYS
00019F D298 014500          10      LD  BC,AT_TRAPE-AT_SUBSYS
0001A2 D29B EDB0                    LDIR
                                
0001A4 D29D CD22E2          17      CALL    CHKEY
0001A7 D2A0 FE03             7      CP  3
0001A9 D2A2 C9              10      RET
                                
       D2A3                     CALC_FATLN: ;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
0001AA D2A3 5D               4      LD  E,L
0001AB D2A4 54               4      LD  D,H
0001AC D2A5 29              11      ADD HL,HL   ;*2
0001AD D2A6 19              11      ADD HL,DE   ;*3
0001AE D2A7 CB3C             8      SRL H   ;/2
0001B0 D2A9 CB1D             8      RR  L   ;1クラスタ辺り1.5バイト必要
0001B2 D2AB 11FF01          10      LD  DE,511  ;切り上げる
0001B5 D2AE 19              11      ADD HL,DE
0001B6 D2AF 7C               4      LD  A,H
0001B7 D2B0 CB3F             8      SRL A
0001B9 D2B2 C9              10      RET
                                
0001BA D2B3 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
0001C3 D2BC 413A00              AUTODV: DB  "A:",0
                                
0001C6 D2BF 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for PC-8801mkIISR v"
            6765727320666F72    
            2050432D38383031    
            6D6B494953522076    
0001E6 D2DF 312E                    DB  030H + VER_1, '.'
0001E8 D2E1 3632                    DB  030H + VER_2 ,030H + VER_3
0001EA D2E3 62                      DB  'b'
0001EB D2E4 2047616B750D0A          DB  " Gaku",0DH,0AH
0001F2 D2EB 00                      DB  0
                                
       D2EC                     AT_SUBSYS:
0001F3 FFBB                         ORG SUBSYS,AT_SUBSYS-OFFSET
0001F3 FFBB C3D5EA          10      JP  PUTCOM
0001F6 FFBE C3DBEA          10      JP  PUTDAT
0001F9 FFC1 C300EB          10      JP  GETDAT
0001FC FFC4 C31FEB          10      JP  FPUTDAT
0001FF FFC7 C34AEB          10      JP  FGETDAT
                                ;EXTBIO
000202 FFCA C9              10      RET
000203 FFCB                         DS  14,0FFH
                                ;TRAP38:
000211 FFD9 210000          10      LD  HL,0
000214 FFDC E3              19      EX  (SP),HL
000215 FFDD 3E24             7      LD  A,'$'
000217 FFDF CD12E3          17      CALL    MSG_A
00021A FFE2 2B               6      DEC HL
00021B FFE3 7C               4      LD  A,H
00021C FFE4 CDE8FF          17      CALL    PRHX
00021F FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
000220 FFE8 F5              11      PUSH    AF
000221 FFE9 07               4      RLCA
000222 FFEA 07               4      RLCA
000223 FFEB 07               4      RLCA
000224 FFEC 07               4      RLCA
000225 FFED CDF1FF          17      CALL    PRHX2
000228 FFF0 F1              10      POP AF
       FFF1                     PRHX2:
000229 FFF1 E60F             7      AND 00FH
00022B FFF3 FE0A             7      CP  10
00022D FFF5 3F               4      CCF
00022E FFF6 CE30             7      ADC A,'0'
000230 FFF8 27               4      DAA
000231 FFF9 C312E3          10      JP  MSG_A
000234 FFFC                         DS  4
000238 D331                         ORG $$+OFFSET,$$    ;$DEPHASE
       D331                     AT_TRAPE:
[EOF:88INIT.ASM:SHIFT_JIS]
                                    INCLUDE "88VRAM.ASM"
                                
                                ;   LSX-Dodgers VRAM
                                ;   PC-8801mkIISR
                                
       D331                     AT_VRAM:
000238 F000                         ORG 0F000H,AT_VRAM-OFFSET
       F000                     ESC1:
000238 F000 7B               4      LD  A,E
000239 F001 FE41             7      CP  'A'
00023B F003 CAC1F0          10      JP  Z,CTRL1E
00023E F006 FE42             7      CP  'B'
000240 F008 CA71F1          10      JP  Z,CTRL1F
000243 F00B FE43             7      CP  'C'
000245 F00D CA89F0          10      JP  Z,CTRL1C
000248 F010 FE44             7      CP  'D'
00024A F012 CAADF0          10      JP  Z,CTRL1D
00024D F015 FE45             7      CP  'E'
00024F F017 2802            12      JR  Z,CT0CX
000251 F019 FE6A             7      CP  'j'
       F01B                     CT0CX:
000253 F01B CA49F1          10      JP  Z,CTRL0C
000256 F01E FE48             7      CP  'H'
000258 F020 CA16F1          10      JP  Z,CTRL0B
00025B F023 FE4A             7      CP  'J'
00025D F025 CA4CF1          10      JP  Z,CTRL06
000260 F028 FE4B             7      CP  'K'
000262 F02A CAF5F0          10      JP  Z,CTRL05
000265 F02D FE4C             7      CP  'L'
000267 F02F CA78F1          10      JP  Z,CTRL0E
00026A F032 FE54             7      CP  'T'
00026C F034 CAF5F0          10      JP  Z,CTRL05
00026F F037 FE78             7      CP  'x'
000271 F039 2804            12      JR  Z,ESC1X
000273 F03B FE79             7      CP  'y'
000275 F03D 2002            12      JR  NZ,ESC1Y
       F03F                     ESC1X:
000277 F03F 3601            10      LD  (HL),1
       F041                     ESC1Y:
000279 F041 FE3D             7      CP  '='
00027B F043 2804            12      JR  Z,ESC1W
00027D F045 FE59             7      CP  'Y'
00027F F047 2002            12      JR  NZ,ESC1Z
       F049                     ESC1W:
000281 F049 3602            10      LD  (HL),2
       F04B                     ESC1Z:
000283 F04B FE20             7      CP  020H
000285 F04D 3802            12      JR  C,ESC1C
000287 F04F 87               4      ADD A,A
000288 F050 D0              11      RET NC
       F051                     ESC1C:
000289 F051 E1              10      POP HL
00028A F052 C35FE1          10      JP  ANK
                                
       F055                     ESC:
00028D F055 2166E1          10      LD  HL,PRINTE5
000290 F058 E5              11      PUSH    HL
000291 F059 2151E1          10      LD  HL,ESCFLG
000294 F05C 3600            10      LD  (HL),0
000296 F05E 3D               4      DEC A
000297 F05F 289F            12      JR  Z,ESC1
000299 F061 3D               4      DEC A
00029A F062 2009            12      JR  NZ,ESC2
00029C F064 3603            10      LD  (HL),3
00029E F066 7B               4      LD  A,E
00029F F067 D620             7      SUB 020H
0002A1 F069 3270F0          13      LD  (ESCYP+1),A
0002A4 F06C C9              10      RET
       F06D                     ESC2:
0002A5 F06D 3D               4      DEC A
0002A6 F06E C0              11      RET NZ
0002A7 F06F 2600             7  ESCYP:  LD  H,0
0002A9 F071 7B               4      LD  A,E
0002AA F072 D620             7      SUB 020H
0002AC F074 6F               4      LD  L,A
0002AD F075 C3D6EE          10      JP  _LOC
                                
       F078                     CTRL:
0002B0 F078 7B               4      LD  A,E
0002B1 F079 87               4      ADD A,A
0002B2 F07A F680             7      OR  080H
0002B4 F07C 6F               4      LD  L,A
0002B5 F07D 26EF             7      LD  H,CTRLTB/256
0002B7 F07F 7E               7      LD  A,(HL)
0002B8 F080 2C               4      INC L
0002B9 F081 66               7      LD  H,(HL)
0002BA F082 6F               4      LD  L,A
0002BB F083 CD61E0          17      CALL    JPHL
0002BE F086 C366E1          10      JP  PRINTE5
                                
       F089                     CTRL1C:
0002C1 F089 2A8EEE          16      LD  HL,(_TXADR)
0002C4 F08C 2C               4      INC L
       F08D                     PRINTE3:
0002C5 F08D 3E50             7      LD  A,WIDTH
0002C7 F08F 3D               4      DEC A
0002C8 F090 BD               4      CP  L
0002C9 F091 3009            12      JR  NC,SET_TXADR_HL
0002CB F093 2E00             7      LD  L,0
0002CD F095 24               4      INC H
       F096                     PRINTE8:
0002CE F096 3A97EE          13      LD  A,(_LINE)
0002D1 F099 BC               4      CP  H
0002D2 F09A 2804            12      JR  Z,PRINT2
       F09C                     LOC:
       F09C                     SET_TXADR_HL:
0002D4 F09C 228EEE          16      LD  (_TXADR),HL
       F09F                     CTRL00:
0002D7 F09F C9              10      RET
                                
       F0A0                     PRINT2:
0002D8 F0A0 CD7EF1          17      CALL    SCR
0002DB F0A3 25               4      DEC H
0002DC F0A4 18F6            12      JR  SET_TXADR_HL
                                
       F0A6                     CTRL08:
0002DE F0A6 3A5CE1          13      LD  A,(INSFLG)
0002E1 F0A9 FECD             7      CP  0CDH        ;CALL ????
0002E3 F0AB 2828            12      JR  Z,CTRL02
       F0AD                     CTRL1D:
0002E5 F0AD 2A8EEE          16      LD  HL,(_TXADR)
0002E8 F0B0 7C               4      LD  A,H
0002E9 F0B1 B5               4      OR  L
0002EA F0B2 C8              11      RET Z
0002EB F0B3 7D               4      LD  A,L
0002EC F0B4 B7               4      OR  A
0002ED F0B5 2803            12      JR  Z,CTRL1DX1
0002EF F0B7 2D               4      DEC L
0002F0 F0B8 18E2            12      JR  SET_TXADR_HL
       F0BA                     CTRL1DX1:
0002F2 F0BA 3E50             7      LD  A,WIDTH
0002F4 F0BC 3D               4      DEC A
0002F5 F0BD 6F               4      LD  L,A
0002F6 F0BE 25               4      DEC H
0002F7 F0BF 18DB            12      JR  SET_TXADR_HL
       F0C1                     CTRL1E:
0002F9 F0C1 2A8EEE          16      LD  HL,(_TXADR)
0002FC F0C4 7C               4      LD  A,H
0002FD F0C5 B7               4      OR  A
0002FE F0C6 C8              11      RET Z
0002FF F0C7 25               4      DEC H
000300 F0C8 18D2            12      JR  SET_TXADR_HL
                                
       F0CA                     CTRL09:
000302 F0CA 2A8EEE          16      LD  HL,(_TXADR)
000305 F0CD 7D               4      LD  A,L
000306 F0CE E6F8             7      AND 0F8H
000308 F0D0 C608             7      ADD A,8
00030A F0D2 6F               4      LD  L,A
00030B F0D3 18B8            12      JR  PRINTE3
                                
       F0D5                     CTRL02:
00030D F0D5 3A8EEE          13      LD  A,(_TXADR)
000310 F0D8 B7               4      OR  A
000311 F0D9 28D2            12      JR  Z,CTRL1D
000313 F0DB CDADF0          17      CALL    CTRL1D
000316 F0DE 2A8EEE          16      LD  HL,(_TXADR)
000319 F0E1 3E50             7      LD  A,WIDTH
00031B F0E3 4F               4      LD  C,A
00031C F0E4 95               4      SUB L
00031D F0E5 47               4      LD  B,A
00031E F0E6 79               4      LD  A,C
00031F F0E7 3D               4      DEC A
000320 F0E8 6F               4      LD  L,A
000321 F0E9 CD70E1          17      CALL    LOC1
                                
000324 F0EC 3E20             7      LD  A,020H
       F0EE                     C8X1:
000326 F0EE 4E               7      LD  C,(HL)
000327 F0EF 77               7      LD  (HL),A
000328 F0F0 2B               6      DEC HL
000329 F0F1 79               4      LD  A,C
00032A F0F2 10FA            13      DJNZ    C8X1
00032C F0F4 C9              10      RET
                                
       F0F5                     CTRL05:
00032D F0F5 CDD3EE          17      CALL    _POS
000330 F0F8 2A8EEE          16      LD  HL,(_TXADR)
000333 F0FB 3E50             7      LD  A,WIDTH
000335 F0FD 95               4      SUB L
000336 F0FE 47               4      LD  B,A
000337 F0FF CD6DE1          17      CALL    LOC0
       F102                     CLLINE:
00033A F102 3E20             7      LD  A,020H
       F104                     CLLINE1:
00033C F104 77               7      LD  (HL),A
00033D F105 23               6      INC HL
00033E F106 10FC            13      DJNZ    CLLINE1
000340 F108 C9              10      RET
                                
       F109                     CTRL0D:
000341 F109 AF               4      XOR A
000342 F10A 328EEE          13      LD  (_TXADR),A
000345 F10D C9              10      RET
                                
       F10E                     CTRL12:
000346 F10E 215CE1          10      LD  HL,INSFLG
000349 F111 7E               7      LD  A,(HL)
00034A F112 EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
00034C F114 77               7      LD  (HL),A
00034D F115 C9              10      RET
                                
       F116                     CTRL0B:
00034E F116 210000          10      LD  HL,0
000351 F119 228EEE          16      LD  (_TXADR),HL
000354 F11C C9              10      RET
                                
       F11D                     CTRL1B:
000355 F11D 3E01             7      LD  A,1
000357 F11F 3251E1          13      LD  (ESCFLG),A
00035A F122 C9              10      RET
                                
       F123                     CTRL07:
00035B F123 3AB9EE          13      LD  A,(WK40)
00035E F126 F5              11      PUSH    AF
00035F F127 F620             7      OR  20H
000361 F129 D340            11      OUT (040H),A
000363 F12B 0610             7      LD  B,16
       F12D                     C07X1:
000365 F12D CD93E2          17      CALL    VBLANK
000368 F130 10FB            13      DJNZ    C07X1
00036A F132 F1              10      POP AF
00036B F133 D340            11      OUT (040H),A
00036D F135 C9              10      RET
                                
       F136                     INSERT:
00036E F136 2A8EEE          16      LD  HL,(_TXADR)
000371 F139 3E50             7      LD  A,WIDTH
000373 F13B 95               4      SUB L
000374 F13C 47               4      LD  B,A
                                
000375 F13D CD6DE1          17      CALL    LOC0
                                
000378 F140 3E20             7      LD  A,020H
       F142                     INS1:
00037A F142 4E               7      LD  C,(HL)
00037B F143 77               7      LD  (HL),A
00037C F144 79               4      LD  A,C
00037D F145 23               6      INC HL
00037E F146 10FA            13      DJNZ    INS1
000380 F148 C9              10      RET
                                
       F149                     CTRL0C:
000381 F149 CD16F1          17      CALL    CTRL0B
       F14C                     CTRL06:
000384 F14C 2A8EEE          16      LD  HL,(_TXADR)
       F14F                     CLS1:
       F14F                     CLS2:
000387 F14F E5              11      PUSH    HL
000388 F150 3E50             7      LD  A,WIDTH
00038A F152 95               4      SUB L
00038B F153 47               4      LD  B,A
00038C F154 CD70E1          17      CALL    LOC1
00038F F157 3E20             7      LD  A,020H
       F159                     CLS3:
000391 F159 77               7      LD  (HL),A
000392 F15A 23               6      INC HL
000393 F15B 10FC            13      DJNZ    CLS3
000395 F15D E1              10      POP HL
000396 F15E 2E00             7      LD  L,0
000398 F160 24               4      INC H
000399 F161 3A97EE          13      LD  A,(_LINE)
00039C F164 BC               4      CP  H
00039D F165 20E8            12      JR  NZ,CLS2
00039F F167 C9              10      RET
                                
       F168                     CTRL04:
0003A0 F168 CDD3EE          17      CALL    _POS
0003A3 F16B 7D               4      LD  A,L
0003A4 F16C B7               4      OR  A
0003A5 F16D C8              11      RET Z
       F16E                     CTRL03:
0003A6 F16E CD09F1          17      CALL    CTRL0D
       F171                     CTRL0A:
       F171                     CTRL1F:
0003A9 F171 2A8EEE          16      LD  HL,(_TXADR)
0003AC F174 24               4      INC H
0003AD F175 C396F0          10      JP  PRINTE8
                                
       F178                     CTRL0E:
0003B0 F178 CDD3EE          17      CALL    _POS
0003B3 F17B 7C               4      LD  A,H
0003B4 F17C 1804            12      JR  SCR1
       F17E                     SCR:
0003B6 F17E 3A97EE          13      LD  A,(_LINE)
0003B9 F181 3D               4      DEC A
       F182                     SCR1:
0003BA F182 C5              11      PUSH    BC
0003BB F183 D5              11      PUSH    DE
0003BC F184 E5              11      PUSH    HL
0003BD F185 F5              11      PUSH    AF
0003BE F186 210000          10      LD  HL,0
0003C1 F189 CD70E1          17      CALL    LOC1
0003C4 F18C EB               4      EX  DE,HL
0003C5 F18D 210001          10      LD  HL,0100H
0003C8 F190 CD70E1          17      CALL    LOC1
0003CB F193 C1              10      POP BC
0003CC F194 78               4      LD  A,B
0003CD F195 B7               4      OR  A
       F196                     SCRUP1:
0003CE F196 2815            12      JR  Z,SCRCL
0003D0 F198 E5              11      PUSH    HL
0003D1 F199 D5              11      PUSH    DE
0003D2 F19A 0608             7      LD  B,8
0003D4 F19C 5F               4      LD  E,A
0003D5 F19D 210078          10      LD  HL,120*256
0003D8 F1A0 55               4      LD  D,L
       F1A1                     SCRH2:
0003D9 F1A1 29              11      ADD HL,HL
0003DA F1A2 3001            12      JR  NC,SCRH3
0003DC F1A4 19              11      ADD HL,DE
       F1A5                     SCRH3:
0003DD F1A5 10FA            13      DJNZ    SCRH2
0003DF F1A7 4D               4      LD  C,L
0003E0 F1A8 44               4      LD  B,H
0003E1 F1A9 D1              10      POP DE
0003E2 F1AA E1              10      POP HL
0003E3 F1AB EDB0                    LDIR
                                
       F1AD                     SCRCL:
0003E5 F1AD 3E50             7      LD  A,WIDTH
0003E7 F1AF 47               4      LD  B,A
0003E8 F1B0 EB               4      EX  DE,HL
0003E9 F1B1 CD02F1          17      CALL    CLLINE
0003EC F1B4 E1              10      POP HL
0003ED F1B5 D1              10      POP DE
0003EE F1B6 C1              10      POP BC
0003EF F1B7 C9              10      RET
[EOF:88VRAM.ASM:UTF_8]
                                    INCLUDE "88TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE キーのテーブル
                                
       F1B8                     KEY_TABLE:
0003F0 F1B8 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
0003F8 F1C0 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
000400 F1C8 4061626364656667        DB  '@','a','b','c','d','e','f','g' ;2
000408 F1D0 68696A6B6C6D6E6F        DB  'h','i','j','k','l','m','n','o' ;3
000410 F1D8 7071727374757677        DB  'p','q','r','s','t','u','v','w' ;4
000418 F1E0 78797A5B5C5D5E2D        DB  'x','y','z','[',5CH,']','^','-' ;5
000420 F1E8 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;6
000428 F1F0 38393A3B2C2E2F5C        DB  '8','9',':',';',',','.','/',5CH ;7
000430 F1F8 0C1E1C0800000000        DB  0CH,1EH,1CH,08H,00H,00H,00H,00H ;8
000438 F200 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
000440 F208 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
000448 F210 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
000450 F218 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
                                
       F220                     SHIFT_TABLE:
000458 F220 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
000460 F228 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
000468 F230 4041424344454647        DB  '@','A','B','C','D','E','F','G' ;2
000470 F238 48494A4B4C4D4E4F        DB  'H','I','J','K','L','M','N','O' ;3
000478 F240 5051525354555657        DB  'P','Q','R','S','T','U','V','W' ;4
000480 F248 58595A7B7C7D7E3D        DB  'X','Y','Z','{','|','}','~','=' ;5
000488 F250 3021222324252627        DB  '0','!','"','#','$','%','&',27H ;6
000490 F258 28292A2B3C3E3F5F        DB  '(',')','*','+','<','>','?','_' ;7
000498 F260 0B1E1C0800000000        DB  0BH,1EH,1CH,08H,00H,00H,00H,00H ;8
0004A0 F268 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
0004A8 F270 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
0004B0 F278 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
0004B8 F280 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
                                
       F288                     CTRL_TABLE:
0004C0 F288 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
0004C8 F290 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
0004D0 F298 4001020304050607        DB  '@',01H,02H,03H,04H,05H,06H,07H ;2
0004D8 F2A0 08090A0B0C0D0E0F        DB  08H,09H,0AH,0BH,0CH,0DH,0EH,0FH ;3
0004E0 F2A8 1011121314151617        DB  10H,11H,12H,13H,14H,15H,16H,17H ;4
0004E8 F2B0 18191A5B5C5D5E2D        DB  18H,19H,1AH,'[',5CH,']','^','-' ;5
0004F0 F2B8 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;6
0004F8 F2C0 38393A3B2C2E2F5F        DB  '8','9',':',';',',','.','/','_' ;7
000500 F2C8 0C1E1C0800000000        DB  0CH,1EH,1CH,08H,00H,00H,00H,00H ;8
000508 F2D0 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
000510 F2D8 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
000518 F2E0 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
000520 F2E8 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
       F2F0                     VRAME:
000528 D621                         ORG $$+OFFSET,$$    ;$DEPHASE
       D621                     AT_VRAME:
[EOF:88TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "88SUB.ASM"
                                
                                ;   LSX-Dodgers SUB DISK SYSTEM
                                ;   PC-8801mkIISR
                                
       D621                     AT_DSS:
000528 7C00                         ORG DSS,AT_DSS-OFFSET
000528 7C00 C3437C          10      JP  READDISKEX
00052B 7C03 C3B17C          10      JP  WRITEDISKEX
00052E 7C06 C3C97C          10      JP  GETPARAMS_N
000531 7C09 C3D47C          10      JP  SEEK
000534 7C0C C3627D          10      JP  FDCOMMAND
000537 7C0F C32E7E          10      JP  CHECKRESULT
00053A 7C12 C3507E          10      JP  GETDEVSTAT
00053D 7C15 C3557E          10      JP  RDFDC
                                
000540 7C18                         DS  8*3
                                
       7C30                     S_PARAMS:
000558 7C30                         DS  16
       7C30                     S_UNITNO    EQU S_PARAMS    ;最大セクタサイズ << 1 + ユニット番号 0:ドライブA 1:ドライブB
       7C31                     S_DPS       EQU S_PARAMS+1  ;1トラックのセクタ数
       7C32                     S_SECTOR_R  EQU S_PARAMS+2  ;セクタ番号
       7C33                     S_TRACK     EQU S_PARAMS+3  ;トラック番号
       7C34                     S_FDMODE    EQU S_PARAMS+4  ;FDモード切り替え $FF:2D/2DD $FE:2HD
       7C35                     S_SECSIZE_N EQU S_PARAMS+5  ;N セクタサイズ
       7C36                     S_BYTE_H    EQU S_PARAMS+6  ;バイト数H
       7C37                     S_MAXCL     EQU S_PARAMS+7  ;シリンダ数
                                
       7C40                     S_CMD_STATUS:
000568 7C40 00                      DB  0
       7C41                     S_LEFT:
000569 7C41 00                      DB  0
       7C42                     S_WKF4:
00056A 7C42 00                      DB  0
                                
       7C43                     READDISKEX:
00056B 7C43 CDC77C          17      CALL    GETPARAMS
00056E 7C46 AF               4      XOR A
00056F 7C47 32887C          13      LD  (RETRY_RDDISK),A
000572 7C4A 2A327C          16      LD  HL,(S_PARAMS+2)
000575 7C4D 7D               4      LD  A,L
000576 7C4E 3D               4      DEC A
000577 7C4F B4               4      OR  H
000578 7C50 2012            12      JR  NZ,RDDISKA1
00057A 7C52 2A357C          16      LD  HL,(S_SECSIZE_N)
00057D 7C55 7C               4      LD  A,H
00057E 7C56 BD               4      CP  L
00057F 7C57 200B            12      JR  NZ,RDDISKA1
000581 7C59 3A307C          13      LD  A,(S_UNITNO)    ;(MAX_SEC_SZ_H << 1) + UNITNO
000584 7C5C 32887C          13      LD  (RETRY_RDDISK),A
000587 7C5F CB3F             8      SRL A
000589 7C61 32947C          13      LD  (RETRY_MAX_SEC_H),A
       7C64                     RDDISKA1:
00058C 7C64 3A307C          13      LD  A,(S_UNITNO)
00058F 7C67 E601             7      AND 1
000591 7C69 32307C          13      LD  (S_UNITNO),A
       7C6C                     RDDISK0:
000594 7C6C CDD47C          17      CALL    SEEK
000597 7C6F 3E46             7      LD  A,46H       ;READ DATA
000599 7C71 CD627D          17      CALL    FDCOMMAND
00059C 7C74 3834            12      JR  C,FINISH_DISK
00059E 7C76 CD937D          17      CALL    RDDISK1
       7C79                     WRDISK3:
0005A1 7C79 78               4      LD  A,B
0005A2 7C7A B2               4      OR  D
0005A3 7C7B 32417C          13      LD  (S_LEFT),A
0005A6 7C7E DBF8            11      IN  A,(0F8H)    ;FDC μPD765A TC入力
0005A8 7C80 FB               4      EI
0005A9 7C81 76               4      HALT
0005AA 7C82 CD2E7E          17      CALL    CHECKRESULT
0005AD 7C85 301D            12      JR  NC,FINISH_DISK0
0005AF 7C87 3E00             7      LD  A,0
       7C88                     RETRY_RDDISK    EQU $-1
0005B1 7C89 CB3F             8      SRL A
0005B3 7C8B 2817            12      JR  Z,FINISH_DISK0
0005B5 7C8D 32887C          13      LD  (RETRY_RDDISK),A
0005B8 7C90 3A357C          13      LD  A,(S_SECSIZE_N)
0005BB 7C93 FE04             7      CP  4
       7C94                     RETRY_MAX_SEC_H EQU $-1
0005BD 7C95 3003            12      JR  NC,RETRY_RDDISK1
0005BF 7C97 87               4      ADD A,A
0005C0 7C98 1802            12      JR  RETRY_RDDISK2
       7C9A                     RETRY_RDDISK1:
0005C2 7C9A 3E01             7      LD  A,1
       7C9C                     RETRY_RDDISK2:
0005C4 7C9C 67               4      LD  H,A
0005C5 7C9D 6F               4      LD  L,A
0005C6 7C9E 22357C          16      LD  (S_SECSIZE_N),HL
0005C9 7CA1 C36C7C          10      JP  RDDISK0
       7CA4                     FINISH_DISK0:
0005CC 7CA4 3A417C          13      LD  A,(S_LEFT)
0005CF 7CA7 D601             7      SUB 1
0005D1 7CA9 3F               4      CCF
       7CAA                     FINISH_DISK:
0005D2 7CAA 9F               4      SBC A,A
0005D3 7CAB 32407C          13      LD  (S_CMD_STATUS),A
0005D6 7CAE C32A00          10      JP  MAIN
                                
       7CB1                     WRITEDISKEX:
0005D9 7CB1 AF               4      XOR A
0005DA 7CB2 32887C          13      LD  (RETRY_RDDISK),A
0005DD 7CB5 CDC77C          17      CALL    GETPARAMS
0005E0 7CB8 CDD47C          17      CALL    SEEK
0005E3 7CBB 3E45             7      LD  A,45H       ;WRITE DATA
0005E5 7CBD CD627D          17      CALL    FDCOMMAND
0005E8 7CC0 38E8            12      JR  C,FINISH_DISK
0005EA 7CC2 CDDA7D          17      CALL    WRDISK1
0005ED 7CC5 18B2            12      JR  WRDISK3
                                
       7CC7                     GETPARAMS:
0005EF 7CC7 0608             7      LD  B,8
       7CC9                     GETPARAMS_N:
0005F1 7CC9 E5              11      PUSH    HL
0005F2 7CCA 21307C          10      LD  HL,S_PARAMS
       7CCD                     GETPARAMS1:
0005F5 7CCD D7              12      RST 10H
0005F6 7CCE 77               7      LD  (HL),A
0005F7 7CCF 23               6      INC HL
0005F8 7CD0 10FB            13      DJNZ    GETPARAMS1
0005FA 7CD2 E1              10      POP HL
0005FB 7CD3 C9              10      RET
                                
       7CD4                     SEEK:
0005FC 7CD4 E5              11      PUSH    HL
0005FD 7CD5 3A347C          13      LD  A,(S_FDMODE)    ;FDモード切り替え $FF:2D/2DD $FE:2HD
000600 7CD8 1F               4      RRA
000601 7CD9 3F               4      CCF
000602 7CDA 9F               4      SBC A,A
000603 7CDB F5              11      PUSH    AF
000604 7CDC E605             7      AND 5
000606 7CDE 4F               4      LD  C,A
000607 7CDF 3A377C          13      LD  A,(S_MAXCL) ;シリンダ数
00060A 7CE2 C6D3             7      ADD A,0-45      ;オーバートラックを考慮して40+α
00060C 7CE4 9F               4      SBC A,A
00060D 7CE5 E604             7      AND 4
00060F 7CE7 B1               4      OR  C
000610 7CE8 0EFA             7      LD  C,0FFH-5    ;マスク
000612 7CEA 47               4      LD  B,A
000613 7CEB 3A307C          13      LD  A,(S_UNITNO)    ;(MAX_SEC_SZ_H << 1) + UNITNO(0:ドライブA 1:ドライブB)
000616 7CEE B7               4      OR  A
000617 7CEF 2804            12      JR  Z,SET_WKF4
000619 7CF1 CB20             8      SLA B
00061B 7CF3 CB01             8      RLC C
       7CF5                     SET_WKF4:
00061D 7CF5 3A427C          13      LD  A,(S_WKF4)
000620 7CF8 A1               4      AND C
000621 7CF9 B0               4      OR  B
000622 7CFA 4F               4      LD  C,A
000623 7CFB D3F4            11      OUT (0F4H),A    ;ドライブ制御
000625 7CFD E6DF             7      AND 0FFH-020H   ;CLKの分は抜いておく
000627 7CFF 47               4      LD  B,A
000628 7D00 F1              10      POP AF
000629 7D01 E620             7      AND 020H        ;bit5:CLK
00062B 7D03 B0               4      OR  B
00062C 7D04 D3F4            11      OUT (0F4H),A    ;ドライブ制御
00062E 7D06 32427C          13      LD  (S_WKF4),A
000631 7D09 47               4      LD  B,A
000632 7D0A A9               4      XOR C
000633 7D0B E620             7      AND 020H        ;CLKが変化したら一定時間待つ
000635 7D0D 2808            12      JR  Z,NOCHGCLK
000637 7D0F 2160F0          10      LD  HL,0F060H
       7D12                     WAIT_CLK:
00063A 7D12 2B               6      DEC HL
00063B 7D13 7C               4      LD  A,H
00063C 7D14 B5               4      OR  L
00063D 7D15 20FB            12      JR  NZ,WAIT_CLK
       7D17                     NOCHGCLK:
00063F 7D17 78               4      LD  A,B
000640 7D18 E620             7      AND 020H
000642 7D1A 2805            12      JR  Z,SPECIFY2D
000644 7D1C 1131DF          10      LD  DE,0DF31H   ;SPECIFY 2HD / SRT:13 HUT:15 HLT:24 NON-DMA
000647 7D1F 1803            12      JR  SPECIFYOK
       7D21                     SPECIFY2D:
000649 7D21 1119DA          10      LD  DE,0DA19H   ;SPECIFY 2D/2DD / SRT:13 HUT 10 HLT:12 NON-DMA
       7D24                     SPECIFYOK:
00064C 7D24 3E03             7      LD  A,3     ;SPECIFY
00064E 7D26 E7              12      RST 20H
00064F 7D27 7A               4      LD  A,D
000650 7D28 E7              12      RST 20H
000651 7D29 7B               4      LD  A,E
000652 7D2A E7              12      RST 20H
       7D2B                     NOSPECIFY:
000653 7D2B ED4B307C        20      LD  BC,(S_PARAMS)
000657 7D2F ED5B327C        20      LD  DE,(S_PARAMS+2)
00065B 7D33 7A               4      LD  A,D     ;TRACK
00065C 7D34 CB3F             8      SRL A       ;CYLINDER
00065E 7D36 3E0F             7      LD  A,00FH      ;SEEK
000660 7D38 2002            12      JR  NZ,SEEK1    ;0シリンダの場合はRECALIBRATE、それ以外はSEEKを使う
000662 7D3A 3E07             7      LD  A,7     ;RECALIBRATE
       7D3C                     SEEK1:
000664 7D3C E7              12      RST 20H
000665 7D3D 79               4      LD  A,C     ;DR/HD
000666 7D3E E7              12      RST 20H
000667 7D3F 7A               4      LD  A,D     ;TRACK
000668 7D40 CB3F             8      SRL A       ;CYLINDER
00066A 7D42 C42000          17      CALL    NZ,20H      ;SEEKの場合だけ呼ぶ(0シリンダの場合はRECALIBRATEを使うのでシリンダの設定は不要)
00066D 7D45 FB               4      EI
00066E 7D46 76               4      HALT
00066F 7D47 3E08             7      LD  A,8     ;SENSE
000671 7D49 E7              12      RST 20H
000672 7D4A CD557E          17      CALL    RDFDC       ;ST0
000675 7D4D CD557E          17      CALL    RDFDC       ;PCN(CYLINDER)
000678 7D50 210040          10      LD  HL,04000H
       7D53                     WAIT_SEEK:
00067B 7D53 CD507E          17      CALL    GETDEVSTAT
00067E 7D56 E608             7      AND 8
000680 7D58 2006            12      JR  NZ,SEEK_OK
000682 7D5A 2B               6      DEC HL
000683 7D5B 7C               4      LD  A,H
000684 7D5C B5               4      OR  L
000685 7D5D 20F4            12      JR  NZ,WAIT_SEEK
000687 7D5F 37               4      SCF
       7D60                     SEEK_OK:
000688 7D60 E1              10      POP HL
000689 7D61 C9              10      RET
                                
       7D62                     FDCOMMAND:
00068A 7D62 E7              12      RST 20H
00068B 7D63 7A               4      LD  A,D     ;HD US1 US0
00068C 7D64 E601             7      AND 1
00068E 7D66 87               4      ADD A,A
00068F 7D67 87               4      ADD A,A
000690 7D68 B1               4      OR  C
000691 7D69 E7              12      RST 20H
000692 7D6A 7A               4      LD  A,D     ;C
000693 7D6B CB3F             8      SRL A
000695 7D6D E7              12      RST 20H
000696 7D6E 7A               4      LD  A,D     ;H
000697 7D6F E601             7      AND 1
000699 7D71 E7              12      RST 20H
00069A 7D72 7B               4      LD  A,E     ;R
00069B 7D73 E7              12      RST 20H
00069C 7D74 3A357C          13      LD  A,(S_SECSIZE_N) ;N
00069F 7D77 FE04             7      CP  4
0006A1 7D79 3802            12      JR  C,FDCOMMAND2    ;N:1=>1 2=>2 4=>3
0006A3 7D7B 3E03             7      LD  A,3
       7D7D                     FDCOMMAND2:
0006A5 7D7D 1E20             7      LD  E,020H      ;NO SERVICE
0006A7 7D7F E7              12      RST 20H
                                
0006A8 7D80 210040          10      LD  HL,DSS_DATA ;開始アドレス
0006AB 7D83 78               4      LD  A,B     ;EOT
0006AC 7D84 E7              12      RST 20H
                                
0006AD 7D85 01FB00          10      LD  BC,000FBH   ;B:バイト数L C:FDC μPD765A データレジスタ
0006B0 7D88 3E54             7      LD  A,054H      ;GSL
0006B2 7D8A E7              12      RST 20H
                                
0006B3 7D8B 3A367C          13      LD  A,(S_BYTE_H)
0006B6 7D8E 57               4      LD  D,A     ;バイト数H
                                
0006B7 7D8F AF               4      XOR A       ;DTL
0006B8 7D90 E7              12      RST 20H
0006B9 7D91 A7               4      AND A
0006BA 7D92 C9              10      RET
                                
       7D93                     RDDISK1:            ;高速化の為にループ展開x8
0006BB 7D93 FB               4      EI
0006BC 7D94 76               4      HALT
0006BD 7D95 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006BF 7D97 A3               4      AND E       ;NO SERVICE
0006C0 7D98 C8              11      RET Z
0006C1 7D99 EDA2            16      INI
                                
0006C3 7D9B FB               4      EI
0006C4 7D9C 76               4      HALT
0006C5 7D9D DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006C7 7D9F A3               4      AND E       ;NO SERVICE
0006C8 7DA0 C8              11      RET Z
0006C9 7DA1 EDA2            16      INI
                                
0006CB 7DA3 FB               4      EI
0006CC 7DA4 76               4      HALT
0006CD 7DA5 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006CF 7DA7 A3               4      AND E       ;NO SERVICE
0006D0 7DA8 C8              11      RET Z
0006D1 7DA9 EDA2            16      INI
                                
0006D3 7DAB FB               4      EI
0006D4 7DAC 76               4      HALT
0006D5 7DAD DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006D7 7DAF A3               4      AND E       ;NO SERVICE
0006D8 7DB0 C8              11      RET Z
0006D9 7DB1 EDA2            16      INI
                                
0006DB 7DB3 FB               4      EI
0006DC 7DB4 76               4      HALT
0006DD 7DB5 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006DF 7DB7 A3               4      AND E       ;NO SERVICE
0006E0 7DB8 C8              11      RET Z
0006E1 7DB9 EDA2            16      INI
                                
0006E3 7DBB FB               4      EI
0006E4 7DBC 76               4      HALT
0006E5 7DBD DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006E7 7DBF A3               4      AND E       ;NO SERVICE
0006E8 7DC0 C8              11      RET Z
0006E9 7DC1 EDA2            16      INI
                                
0006EB 7DC3 FB               4      EI
0006EC 7DC4 76               4      HALT
0006ED 7DC5 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006EF 7DC7 A3               4      AND E       ;NO SERVICE
0006F0 7DC8 C8              11      RET Z
0006F1 7DC9 EDA2            16      INI
                                
0006F3 7DCB FB               4      EI
0006F4 7DCC 76               4      HALT
0006F5 7DCD DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006F7 7DCF A3               4      AND E       ;NO SERVICE
0006F8 7DD0 C8              11      RET Z
0006F9 7DD1 EDA2            16      INI
                                
0006FB 7DD3 20BE            12      JR  NZ,RDDISK1
0006FD 7DD5 15               4      DEC D
0006FE 7DD6 C2937D          10      JP  NZ,RDDISK1
000701 7DD9 C9              10      RET
                                
       7DDA                     WRDISK1:            ;高速化の為にループ展開x8
000702 7DDA FB               4      EI
000703 7DDB 76               4      HALT
000704 7DDC DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000706 7DDE A3               4      AND E
000707 7DDF C8              11      RET Z
000708 7DE0 EDA3            16      OUTI
                                
00070A 7DE2 FB               4      EI
00070B 7DE3 76               4      HALT
00070C 7DE4 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00070E 7DE6 A3               4      AND E
00070F 7DE7 C8              11      RET Z
000710 7DE8 EDA3            16      OUTI
                                
000712 7DEA FB               4      EI
000713 7DEB 76               4      HALT
000714 7DEC DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000716 7DEE A3               4      AND E
000717 7DEF C8              11      RET Z
000718 7DF0 EDA3            16      OUTI
                                
00071A 7DF2 FB               4      EI
00071B 7DF3 76               4      HALT
00071C 7DF4 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00071E 7DF6 A3               4      AND E
00071F 7DF7 C8              11      RET Z
000720 7DF8 EDA3            16      OUTI
                                
000722 7DFA FB               4      EI
000723 7DFB 76               4      HALT
000724 7DFC DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000726 7DFE A3               4      AND E
000727 7DFF C8              11      RET Z
000728 7E00 EDA3            16      OUTI
                                
00072A 7E02 FB               4      EI
00072B 7E03 76               4      HALT
00072C 7E04 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00072E 7E06 A3               4      AND E
00072F 7E07 C8              11      RET Z
000730 7E08 EDA3            16      OUTI
                                
000732 7E0A FB               4      EI
000733 7E0B 76               4      HALT
000734 7E0C DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000736 7E0E A3               4      AND E
000737 7E0F C8              11      RET Z
000738 7E10 EDA3            16      OUTI
                                
00073A 7E12 FB               4      EI
00073B 7E13 76               4      HALT
00073C 7E14 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00073E 7E16 A3               4      AND E
00073F 7E17 C8              11      RET Z
000740 7E18 EDA3            16      OUTI
                                
000742 7E1A 20BE            12      JR  NZ,WRDISK1
000744 7E1C 15               4      DEC D
000745 7E1D C2DA7D          10      JP  NZ,WRDISK1
000748 7E20 C9              10      RET
                                
       7E21                     RESULTEX:
000749 7E21 3A407C          13      LD  A,(S_CMD_STATUS)
00074C 7E24 3C               4      INC A
00074D 7E25 2803            12      JR  Z,RESULTEX1
00074F 7E27 3A367C          13      LD  A,(S_BYTE_H)    ;バイト数H
       7E2A                     RESULTEX1:
000752 7E2A DF              12      RST 18H
000753 7E2B C32A00          10      JP  MAIN
                                
       7E2E                     CHECKRESULT:
000756 7E2E C5              11      PUSH    BC
000757 7E2F CD557E          17      CALL    RDFDC       ;ST0
00075A 7E32 E6D8             7      AND 0D8H
00075C 7E34 4F               4      LD  C,A
00075D 7E35 CD557E          17      CALL    RDFDC       ;ST1
000760 7E38 E6B7             7      AND 0B7H
000762 7E3A B1               4      OR  C
000763 7E3B 4F               4      LD  C,A
000764 7E3C CD557E          17      CALL    RDFDC       ;ST2
000767 7E3F E673             7      AND 073H
000769 7E41 B1               4      OR  C
00076A 7E42 4F               4      LD  C,A
00076B 7E43 0604             7      LD  B,4
       7E45                     CHECKRESULT1:           ;C H R N
00076D 7E45 CD557E          17      CALL    RDFDC
000770 7E48 10FB            13      DJNZ    CHECKRESULT1
000772 7E4A 79               4      LD  A,C
000773 7E4B A7               4      AND A
000774 7E4C C1              10      POP BC
000775 7E4D C8              11      RET Z
000776 7E4E 37               4      SCF
000777 7E4F C9              10      RET
                                
       7E50                     GETDEVSTAT:
000778 7E50 3E04             7      LD  A,4
00077A 7E52 E7              12      RST 20H
00077B 7E53 79               4      LD  A,C
00077C 7E54 E7              12      RST 20H
                                
       7E55                     RDFDC:
00077D 7E55 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00077F 7E57 2F               4      CPL
000780 7E58 E6C0             7      AND 0C0H        ;RQMとDIOが両方1になるまで待つ
000782 7E5A 20F9            12      JR  NZ,RDFDC
000784 7E5C DBFB            11      IN  A,(0FBH)    ;FDC μPD765A データレジスタリード
000786 7E5E C9              10      RET
                                
000787 D880                         ORG $$+OFFSET,$$    ;$DEPHASE
       D880                     AT_DSSE:
       D880                     INITE:
000787 D880                         DS  BDOS-INITE
00080D D906 C36BE0          10      JP  BDOS_RF
[EOF:88SUB.ASM:SHIFT_JIS]
                                    INCLUDE "88CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   PC-8801mkIISR
                                
       D909                     WBOOT1:
000810 D909 ED7B0600        20      LD  SP,(SYSTEM+1)
000814 D90D DB32            11      IN  A,(032H)
000816 D90F F610             7      OR  10H     ;高速RAMアクセスモードOFF
000818 D911 D332            11      OUT (032H),A
                                
00081A D913 3EED             7      LD  A,IVRTC/256
00081C D915 2192EE          10      LD  HL,_KEYD
00081F D918 3600            10      LD  (HL),0      ;必ずBDOS0+13Hが「0」になるようにする
000821 D91A ED47             9      LD  I,A
000823 D91C 3AB8EE          13      LD  A,(WKE6)
000826 D91F F602             7      OR  2       ;VRTC割り込みマスク
000828 D921 D3E6            11      OUT (0E6H),A    ;割り込みマスク
00082A D923 32B8EE          13      LD  (WKE6),A
00082D D926 3AB7EE          13      LD  A,(WKE4)
000830 D929 D3E4            11      OUT (0E4H),A    ;割り込みレベル設定
                                
000832 D92B FB               4      EI
000833 D92C CD22E2          17      CALL    CHKEY
000836 D92F CDFFE2          17      CALL    KEYBC_IFBREAK
000839 D932 3E04             7      LD  A,4
00083B D934 CD12E3          17      CALL    MSG_A
[EOF:88CCP.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D937                     COMMAND:
00083E D937 3AAFED          13      LD  A,(FCB_BAT)
000841 D93A B7               4      OR  A
000842 D93B C279DA          10      JP  NZ,C_BAT1
000845 D93E CDEDD9          17      CALL    SETDTA1
000848 D941 3A0400          13      LD  A,(_DVSW)
00084B D944 C641             7      ADD A,'A'
00084D D946 CD12E3          17      CALL    MSG_A
000850 D949 3E3E             7      LD  A,'>'
000852 D94B CD12E3          17      CALL    MSG_A
000855 D94E 3E50             7      LD  A,80
000857 D950 12               7      LD  (DE),A
000858 D951 CD74E0          17      CALL    _SYS0A      ;(BDOS)文字列入力
00085B D954 CD6EDB          17      CALL    LTNL
       D957                     COMMAND2:
00085E D957 118200          10      LD  DE,DTA1+2
000861 D95A CDFDEE          17      CALL    _COMANL
000864 D95D DC62E0          17      CALL    C,SHOW_ERROR
000867 D960 18D5            12      JR  COMMAND
                                
       D962                     COMANL:
000869 D962 CD0BF0          17      CALL    FILE
00086C D965 3A19EE          13      LD  A,(FNAME+4)
00086F D968 FE20             7      CP  020H
000871 D96A 201C            12      JR  NZ,COMB2
000873 D96C D5              11      PUSH    DE
000874 D96D 1115EE          10      LD  DE,FNAME
000877 D970 1A               7      LD  A,(DE)
000878 D971 FE20             7      CP  020H
00087A D973 2844            12      JR  Z,SDVSW
00087C D975 1B               6      DEC DE
00087D D976 1A               7      LD  A,(DE)
00087E D977 C6FF             7      ADD A,0FFH
000880 D979 3809            12      JR  C,COMB
000882 D97B 13               6      INC DE
                                
000883 D97C 212BDD          10      LD  HL,COMTB
000886 D97F 0608             7      LD  B,COMS
000888 D981 CD98F2          17      CALL    CPNAME
       D984                     COMB:
00088B D984 D1              10      POP DE
00088C D985 D261E0          10      JP  NC,JPHL
       D988                     COMB2:
00088F D988 EB               4      EX  DE,HL
000890 D989 2256DA          16      LD  (COMSWC),HL
000893 D98C F5              11      PUSH    AF
000894 D98D CD0EDA          17      CALL    CEXE4
000897 D990 F1              10      POP AF
000898 D991 2115EE          10      LD  HL,FNAME
00089B D994 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
00089E D997 010B00          10      LD  BC,11
0008A1 D99A EDB0                    LDIR
0008A3 D99C 114EED          10      LD  DE,PATHD
       D99F                     CEX1:
0008A6 D99F 1A               7      LD  A,(DE)
0008A7 D9A0 FE20             7      CP  020H
0008A9 D9A2 D8              11      RET C
0008AA D9A3 CD00F0          17      CALL    FILEC
0008AD D9A6 D5              11      PUSH    DE
0008AE D9A7 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
0008B1 D9AA 1115EE          10      LD  DE,FNAME
0008B4 D9AD 010B00          10      LD  BC,11
0008B7 D9B0 EDB0                    LDIR
0008B9 D9B2 CD0EDA          17      CALL    CEXE4
0008BC D9B5 D1              10      POP DE
0008BD D9B6 13               6      INC DE
0008BE D9B7 18E6            12      JR  CEX1
                                
       D9B9                     SDVSW:
0008C0 D9B9 F1              10      POP AF
0008C1 D9BA 3A14EE          13      LD  A,(FDRV)
0008C4 D9BD 3D               4      DEC A
0008C5 D9BE 5F               4      LD  E,A
0008C6 D9BF 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
0008C8 D9C1 1831            12      JR  SYSTEM0
                                
       D9C3                     OPEN1:
0008CA D9C3 2114EE          10      LD  HL,FDRV
       D9C6                     OPEN:
0008CD D9C6 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D9C8                     OPEN3:
0008CF D9C8 D5              11      PUSH    DE
0008D0 D9C9 118AED          10      LD  DE,DTA_CCP
0008D3 D9CC CDEAD9          17      CALL    SETDTA
0008D6 D9CF EB               4      EX  DE,HL
0008D7 D9D0 CDF4D9          17      CALL    SYSTEM0
0008DA D9D3 D1              10      POP DE
0008DB D9D4 C9              10      RET
                                
       D9D5                     OPEN2:
0008DC D9D5 0E12             7      LD  C,012H
0008DE D9D7 18EF            12      JR  OPEN3
                                
       D9D9                     DEFCB:              ;Z=Ok NZ=Error
0008E0 D9D9 118AED          10      LD  DE,DTA_CCP
0008E3 D9DC CDF2D9          17      CALL    SYSC0F
                                
0008E6 D9DF 11ABED          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0008E9 D9E2 0604             7      LD  B,4
0008EB D9E4 CD3FDC          17      CALL    ZERO_MEMORY_DE
       D9E7                     SETDTA100:
0008EE D9E7 110001          10      LD  DE,BUFFER
       D9EA                     SETDTA:
0008F1 D9EA C3A2DF          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D9ED                     SETDTA1:
0008F4 D9ED 118000          10      LD  DE,DTA1
0008F7 D9F0 18F8            12      JR  SETDTA
                                
       D9F2                     SYSC0F:
0008F9 D9F2 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D9F4                     SYSTEM0:
0008FB D9F4 CD0500          17      CALL    SYSTEM
0008FE D9F7 B7               4      OR  A
0008FF D9F8 C9              10      RET
                                
       D9F9                     C_CD:
000900 D9F9 0E5A             7      LD  C,05AH
000902 D9FB 18F7            12      JR  SYSTEM0
                                
       D9FD                     S27BUF:
000904 D9FD 2100FE          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       DA00                     S27BUF2:
000907 DA00 39              11      ADD HL,SP
000908 DA01 2E00             7      LD  L,0
00090A DA03 7C               4      LD  A,H
00090B DA04 E6F8             7      AND 0F8H
00090D DA06 67               4      LD  H,A
       DA07                     S27DTA:
00090E DA07 118AED          10      LD  DE,DTA_CCP
       DA0A                     S27:
000911 DA0A 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
000913 DA0C 18E6            12      JR  SYSTEM0
                                
       DA0E                     CEXE4:
000915 DA0E 211DEE          10      LD  HL,FNAME+8
000918 DA11 7E               7      LD  A,(HL)
000919 DA12 FE20             7      CP  020H
00091B DA14 2007            12      JR  NZ,CEXE7
00091D DA16 3E3F             7      LD  A,'?'
00091F DA18 77               7      LD  (HL),A
000920 DA19 23               6      INC HL
000921 DA1A 77               7      LD  (HL),A
000922 DA1B 23               6      INC HL
000923 DA1C 77               7      LD  (HL),A
       DA1D                     CEXE7:
000924 DA1D CDC3D9          17      CALL    OPEN1
       DA20                     CEXE5:
000927 DA20 C0              11      RET NZ
000928 DA21 2A94ED          16      LD  HL,(DTA_CCP+1+9)
00092B DA24 7C               4      LD  A,H
00092C DA25 CD27F3          17      CALL    CAP
00092F DA28 67               4      LD  H,A
000930 DA29 7D               4      LD  A,L
000931 DA2A CD27F3          17      CALL    CAP
000934 DA2D 6F               4      LD  L,A
000935 DA2E 3A93ED          13      LD  A,(DTA_CCP+1+8)
000938 DA31 CD27F3          17      CALL    CAP
00093B DA34 D642             7      SUB 'B'
00093D DA36 282C            12      JR  Z,C_BAT
00093F DA38 3D               4      DEC A       ;'C'
000940 DA39 2805            12      JR  Z,C_EXE
       DA3B                     CEXE6:
000942 DA3B CDD5D9          17      CALL    OPEN2
000945 DA3E 18E0            12      JR  CEXE5
                                
       DA40                     C_EXE:
000947 DA40 7C               4      LD  A,H
000948 DA41 FE4D             7      CP  'M'
00094A DA43 20F6            12      JR  NZ,CEXE6
                                
00094C DA45 CDD9D9          17      CALL    DEFCB
00094F DA48 CDFDD9          17      CALL    S27BUF_COM
000952 DA4B 3D               4      DEC A
000953 DA4C 37               4      SCF
000954 DA4D C0              11      RET NZ
000955 DA4E 7C               4      LD  A,H
000956 DA4F B5               4      OR  L
000957 DA50 37               4      SCF
000958 DA51 C8              11      RET Z
000959 DA52 CDEDD9          17      CALL    SETDTA1
00095C DA55 110000          10      LD  DE,0                ; self-modifying code
       DA56                     COMSWC  EQU $-2
00095F DA58 ED7B0600        20      LD  SP,(SYSTEM+1)
000963 DA5C 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000964 DA5D 6F               4      LD  L,A
000965 DA5E E5              11      PUSH    HL              ; push $0000 (reboot address)
000966 DA5F 24               4      INC H
000967 DA60 E5              11      PUSH    HL              ; push $0100 (TPA address)
000968 DA61 C30ADC          10      JP  SETFCB              ; and JP $0100
                                
       DA64                     C_BAT:
00096B DA64 114154          10      LD  DE,'A'+'T'*256
00096E DA67 ED52            15      SBC HL,DE
000970 DA69 20D0            12      JR  NZ,CEXE6
                                
000972 DA6B CDD9D9          17      CALL    DEFCB
                                
000975 DA6E 218AED          10      LD  HL,DTA_CCP
000978 DA71 11AFED          10      LD  DE,FCB_BAT
00097B DA74 012500          10      LD  BC,37
00097E DA77 EDB0                    LDIR
       DA79                     C_BAT1:
000980 DA79 CDE7D9          17      CALL    SETDTA100
000983 DA7C CDB0DA          17      CALL    FGETC_BAT
000986 DA7F 218100          10      LD  HL,DTA1+1
000989 DA82 2025            12      JR  NZ,END_BATCH
00098B DA84 FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
00098D DA86 38F1            12      JR  C,C_BAT1
00098F DA88 3620            10      LD  (HL),' '
000991 DA8A 23               6      INC HL
       DA8B                     C_BAT2:
000992 DA8B 77               7      LD  (HL),A
000993 DA8C 23               6      INC HL
000994 DA8D 7D               4      LD  A,L
000995 DA8E 3C               4      INC A       ;L==0FFH
000996 DA8F 2809            12      JR  Z,RUN_BATCH
000998 DA91 CDB0DA          17      CALL    FGETC_BAT
00099B DA94 2004            12      JR  NZ,RUN_BATCH
00099D DA96 FE20             7      CP  020H
00099F DA98 30F1            12      JR  NC,C_BAT2
       DA9A                     RUN_BATCH:
0009A1 DA9A 7D               4      LD  A,L
0009A2 DA9B D67F             7      SUB DTA1-1
0009A4 DA9D 328000          13      LD  (DTA1),A
0009A7 DAA0 FE04             7      CP  4
0009A9 DAA2 3805            12      JR  C,END_BATCH
0009AB DAA4 3600            10      LD  (HL),0
0009AD DAA6 C357D9          10      JP  COMMAND2
       DAA9                     END_BATCH:
0009B0 DAA9 AF               4      XOR A       ;バッチファイルを閉じる
0009B1 DAAA 32AFED          13      LD  (FCB_BAT),A
0009B4 DAAD C300EE          10      JP  CPM_BOOT
                                
       DAB0                     FGETC_BAT:
0009B7 DAB0 11AFED          10      LD  DE,FCB_BAT
       DAB3                     FGETC:              ;1文字ずつ読み込む
0009BA DAB3 E5              11      PUSH    HL      ;Z:成功
0009BB DAB4 210100          10      LD  HL,1
0009BE DAB7 CD0ADA          17      CALL    S27
0009C1 DABA E1              10      POP HL
0009C2 DABB 3A0001          13      LD  A,(BUFFER)
0009C5 DABE C9              10      RET
                                
       DABF                     C_DEL:
0009C6 DABF CD0ADC          17      CALL    SETFCB
0009C9 DAC2 CD28E3          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
0009CC DAC5 0E13             7      LD  C,013H
0009CE DAC7 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       DAC9                     C_REN:
0009D0 DAC9 CD0ADC          17      CALL    SETFCB
0009D3 DACC 3E10             7      LD  A,010H      ;ディレクトリも対象にする
0009D5 DACE 326900          13      LD  (FCB1+13),A ;属性
0009D8 DAD1 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       DAD3                     CDEL1:
0009DA DAD3 115C00          10      LD  DE,FCB1
0009DD DAD6 CD0500          17      CALL    SYSTEM
0009E0 DAD9 C6FF             7      ADD A,0FFH
0009E2 DADB C9              10      RET
                                
       DADC                     C_DIR:
0009E3 DADC CD00F0          17      CALL    FILEC
0009E6 DADF 2115EE          10      LD  HL,FDRV+1
0009E9 DAE2 CD20DD          17      CALL    CWILD1
0009EC DAE5 3EF1             7      LD  A,0F1H
0009EE DAE7 3221EE          13      LD  (FDRV+13),A
0009F1 DAEA CDC3D9          17      CALL    OPEN1
       DAED                     CDIR1:
0009F4 DAED B7               4      OR  A
0009F5 DAEE 2008            12      JR  NZ,PDSKF
0009F7 DAF0 CD3BDB          17      CALL    P_NAME
0009FA DAF3 CDD5D9          17      CALL    OPEN2
0009FD DAF6 18F5            12      JR  CDIR1
       DAF8                     PDSKF:
0009FF DAF8 3A14EE          13      LD  A,(FDRV)
000A02 DAFB 5F               4      LD  E,A
000A03 DAFC 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
000A05 DAFE CD0500          17      CALL    SYSTEM
000A08 DB01 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
000A09 DB02 C601             7      ADD A,001H
000A0B DB04 D8              11      RET C       ;Aが0FFHだった場合
000A0C DB05 3E06             7      LD  A,8-2
       DB07                     PDS1:               ;HL=未使用クラスタの総数
000A0E DB07 3C               4      INC A
000A0F DB08 CB19             8      RR  C
000A11 DB0A 30FB            12      JR  NC,PDS1
       DB0C                     PDS2:               ;B←論理セクタのサイズの上位8ビット
000A13 DB0C 3C               4      INC A
000A14 DB0D CB18             8      RR  B
000A16 DB0F 30FB            12      JR  NC,PDS2
000A18 DB11 47               4      LD  B,A
                                
000A19 DB12 110000          10      LD  DE,0
       DB15                     PDS3:
000A1C DB15 29              11      ADD HL,HL
000A1D DB16 EB               4      EX  DE,HL
000A1E DB17 ED6A            15      ADC HL,HL
000A20 DB19 EB               4      EX  DE,HL
000A21 DB1A 10F9            13      DJNZ    PDS3
       DB1C                     PDSKF1:
000A23 DB1C CDA8DB          17      CALL    PRDEC_DEHL
000A26 DB1F 11DFED          10      LD  DE,FREE
000A29 DB22 CDCFDD          17      CALL    _SYS09      ;(BDOS)文字列出力
000A2C DB25 CD95DB          17      CALL    PUTDRV
000A2F DB28 3E5C             7      LD  A,05CH      ;\
000A31 DB2A CD12E3          17      CALL    MSG_A
000A34 DB2D 2A22EE          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
000A37 DB30 AF               4      XOR A
000A38 DB31 11FEFF          10      LD  DE,0-2
000A3B DB34 19              11      ADD HL,DE
000A3C DB35 23               6      INC HL
000A3D DB36 DCA5DB          17      CALL    C,PRDEC_HL
000A40 DB39 1833            12      JR  LTNL
                                
       DB3B                     P_NAME:
000A42 DB3B 3A8BED          13      LD  A,(DTA_CCP+1)
000A45 DB3E FE2E             7      CP  '.'
000A47 DB40 C8              11      RET Z
                                
000A48 DB41 3A96ED          13      LD  A,(DTA_CCP+1+00BH)
000A4B DB44 F5              11      PUSH    AF
000A4C DB45 CB67             8      BIT 4,A
000A4E DB47 2808            12      JR  Z,DIR3
000A50 DB49 11D4ED          10      LD  DE,DIRMES
000A53 DB4C CDCFDD          17      CALL    _SYS09      ;(BDOS)文字列出力
000A56 DB4F 180A            12      JR  DIR6
       DB51                     DIR3:
000A58 DB51 ED5BA9ED        20      LD  DE,(DTA_CCP+1+01EH)
000A5C DB55 2AA7ED          16      LD  HL,(DTA_CCP+1+01CH)
000A5F DB58 CDA8DB          17      CALL    PRDEC_DEHL
       DB5B                     DIR6:
000A62 DB5B F1              10      POP AF
000A63 DB5C 0F               4      RRCA
000A64 DB5D 9F               4      SBC A,A
000A65 DB5E E60A             7      AND '*'-020H
000A67 DB60 C620             7      ADD A,020H
000A69 DB62 CD12E3          17      CALL    MSG_A
000A6C DB65 CD95DB          17      CALL    PUTDRV
000A6F DB68 218BED          10      LD  HL,DTA_CCP+1
000A72 DB6B CDE8DB          17      CALL    FPRNT
                                
       DB6E                     LTNL:
000A75 DB6E 1E03             7      LD  E,3
000A77 DB70 C3CDEE          10      JP  _PRINT
                                
       DB73                     C_PATH:
000A7A DB73 CDE1F0          17      CALL    SPCUT
000A7D DB76 214EED          10      LD  HL,PATHD
000A80 DB79 FE21             7      CP  021H
000A82 DB7B 300C            12      JR  NC,CPATH0
       DB7D                     CPATHP:
000A84 DB7D 7E               7      LD  A,(HL)
000A85 DB7E 23               6      INC HL
000A86 DB7F FE20             7      CP  020H
000A88 DB81 3F               4      CCF
000A89 DB82 30EA            12      JR  NC,LTNL
000A8B DB84 CD12E3          17      CALL    MSG_A
000A8E DB87 18F4            12      JR  CPATHP
       DB89                     CPATH0:
000A90 DB89 FE3B             7      CP  ';'
000A92 DB8B 2001            12      JR  NZ,CPATH1
000A94 DB8D 13               6      INC DE
       DB8E                     CPATH1:
000A95 DB8E EB               4      EX  DE,HL
000A96 DB8F 013B00          10      LD  BC,PATHX
000A99 DB92 EDB0                    LDIR
000A9B DB94 C9              10      RET
                                
       DB95                     PUTDRV:
000A9C DB95 3A14EE          13      LD  A,(FDRV)
000A9F DB98 CD14F1          17      CALL    GETDRV1
000AA2 DB9B C641             7      ADD A,'A'
000AA4 DB9D CD12E3          17      CALL    MSG_A
000AA7 DBA0 3E3A             7      LD  A,':'
       DBA2                     MSG_AR:
000AA9 DBA2 C312E3          10      JP  MSG_A
                                
       DBA5                     PRDEC_HL:
000AAC DBA5 AF               4      XOR A
000AAD DBA6 5F               4      LD  E,A
000AAE DBA7 57               4      LD  D,A
       DBA8                     PRDEC_DEHL:
000AAF DBA8 D5              11      PUSH    DE
000AB0 DBA9 110FEE          10      LD  DE,DECBF
000AB3 DBAC 0605             7      LD  B,5
000AB5 DBAE CD3FDC          17      CALL    ZERO_MEMORY_DE  ;A=0
000AB8 DBB1 D1              10      POP DE
                                
000AB9 DBB2 0E20             7      LD  C,32
       DBB4                     DEC1:
000ABB DBB4 29              11      ADD HL,HL
000ABC DBB5 EB               4      EX  DE,HL
000ABD DBB6 ED6A            15      ADC HL,HL
000ABF DBB8 EB               4      EX  DE,HL
000AC0 DBB9 E5              11      PUSH    HL
000AC1 DBBA 2113EE          10      LD  HL,DECBF+4
000AC4 DBBD 0605             7      LD  B,5
       DBBF                     DEC2:
000AC6 DBBF 7E               7      LD  A,(HL)
000AC7 DBC0 8F               4      ADC A,A
000AC8 DBC1 27               4      DAA
000AC9 DBC2 77               7      LD  (HL),A
000ACA DBC3 2B               6      DEC HL
000ACB DBC4 10F9            13      DJNZ    DEC2
000ACD DBC6 E1              10      POP HL
000ACE DBC7 0D               4      DEC C
000ACF DBC8 20EA            12      JR  NZ,DEC1
                                
000AD1 DBCA 210FEE          10      LD  HL,DECBF
000AD4 DBCD 3E20             7      LD  A,020H
000AD6 DBCF 0604             7      LD  B,4
       DBD1                     DEC3:
000AD8 DBD1 CDDEDB          17      CALL    DEC4
000ADB DBD4 CDDEDB          17      CALL    DEC4
000ADE DBD7 23               6      INC HL
000ADF DBD8 10F7            13      DJNZ    DEC3
       DBDA                     DECX:
000AE1 DBDA CDDEDB          17      CALL    DEC4
000AE4 DBDD AF               4      XOR A
       DBDE                     DEC4:
000AE5 DBDE ED6F            18      RLD
000AE7 DBE0 FE20             7      CP  020H
000AE9 DBE2 2802            12      JR  Z,DEC5
000AEB DBE4 F630             7      OR  030H
       DBE6                     DEC5:
000AED DBE6 18BA            12      JR  MSG_AR
                                
       DBE8                     FPRNT:
000AEF DBE8 0608             7      LD  B,8 ;ファイル名を表示
000AF1 DBEA CDF9DB          17      CALL    P_N1
000AF4 DBED 7E               7      LD  A,(HL)
000AF5 DBEE CD33F3          17      CALL    CAP3
000AF8 DBF1 D8              11      RET C   ;拡張子が無い
                                
000AF9 DBF2 3E2E             7      LD  A,'.'
000AFB DBF4 CD12E3          17      CALL    MSG_A
000AFE DBF7 0603             7      LD  B,3 ;拡張子を表示
       DBF9                     P_N1:
000B00 DBF9 7E               7      LD  A,(HL)
000B01 DBFA CD33F3          17      CALL    CAP3
000B04 DBFD 3807            12      JR  C,P_N2
000B06 DBFF CD12E3          17      CALL    MSG_A
000B09 DC02 23               6      INC HL
000B0A DC03 10F4            13      DJNZ    P_N1
000B0C DC05 C9              10      RET
       DC06                     P_N2:
000B0D DC06 23               6      INC HL
000B0E DC07 10FD            13      DJNZ    P_N2
000B10 DC09 C9              10      RET
                                
       DC0A                     SETFCB:
000B11 DC0A CDE1F0          17      CALL    SPCUT
000B14 DC0D 1A               7      LD  A,(DE)
000B15 DC0E FE20             7      CP  020H
000B17 DC10 3801            12      JR  C,SETFCBA
000B19 DC12 1B               6      DEC DE
       DC13                     SETFCBA:
000B1A DC13 0624             7      LD  B,36
000B1C DC15 215C00          10      LD  HL,FCB1
000B1F DC18 E5              11      PUSH    HL
000B20 DC19 AF               4      XOR A
000B21 DC1A CDB6F0          17      CALL    FILL_MEMORY
000B24 DC1D E1              10      POP HL
000B25 DC1E D5              11      PUSH    DE
000B26 DC1F CD08E0          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000B29 DC22 216C00          10      LD  HL,FCB2
000B2C DC25 CD08E0          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000B2F DC28 E1              10      POP HL
000B30 DC29 010050          10      LD  BC,05000H
000B33 DC2C 118100          10      LD  DE,00081H
       DC2F                     SETFCB1:
000B36 DC2F 7E               7      LD  A,(HL)
000B37 DC30 23               6      INC HL
000B38 DC31 FE20             7      CP  020H
000B3A DC33 3805            12      JR  C,SETFCB2
000B3C DC35 12               7      LD  (DE),A
000B3D DC36 13               6      INC DE
000B3E DC37 0C               4      INC C
000B3F DC38 10F5            13      DJNZ    SETFCB1
       DC3A                     SETFCB2:
000B41 DC3A 79               4      LD  A,C
000B42 DC3B 328000          13      LD  (DTA1),A
000B45 DC3E 04               4      INC B
       DC3F                     ZERO_MEMORY_DE:
000B46 DC3F AF               4      XOR A
       DC40                     FILL_MEMORY_DE:
000B47 DC40 12               7      LD  (DE),A
000B48 DC41 13               6      INC DE
000B49 DC42 10FC            13      DJNZ    FILL_MEMORY_DE
000B4B DC44 C9              10      RET
                                
       DC45                     C_COPY:
000B4C DC45 CD0ADC          17      CALL    SETFCB
                                
000B4F DC48 1161EE          10      LD  DE,ZERO
000B52 DC4B CD03F0          17      CALL    FILEC2
000B55 DC4E 216C00          10      LD  HL,FCB2
000B58 DC51 CD0FE0          17      CALL    S29X1
                                
000B5B DC54 3E10             7      LD  A,010H
000B5D DC56 326900          13      LD  (FCB1+13),A
000B60 DC59 216D00          10      LD  HL,FCB2FN
000B63 DC5C CD20DD          17      CALL    CWILD1
       DC5F                     COPY0:
000B66 DC5F CD1DDD          17      CALL    CWILD
000B69 DC62 215C00          10      LD  HL,FCB1
000B6C DC65 CDC6D9          17      CALL    OPEN
000B6F DC68 37               4      SCF
       DC69                     COPY1:
000B70 DC69 C0              11      RET NZ
000B71 DC6A CDD9D9          17      CALL    DEFCB
                                
000B74 DC6D 3A97ED          13      LD  A,(DTA_CCP+13)
000B77 DC70 CB67             8      BIT 4,A
000B79 DC72 2821            12      JR  Z,COPY1A
                                
000B7B DC74 215D00          10      LD  HL,FCB1FN
000B7E DC77 CD46F4          17      CALL    CHKWILD
000B81 DC7A 3814            12      JR  C,COPY9
                                
000B83 DC7C 3E20             7      LD  A,020H
000B85 DC7E 325D00          13      LD  (FCB1FN),A
000B88 DC81 2AA4ED          16      LD  HL,(DTA_CCP+26)
000B8B DC84 23               6      INC HL
000B8C DC85 226A00          16      LD  (FCB1+14),HL
000B8F DC88 18D5            12      JR  COPY0
                                
       DC8A                     COPY8:
000B91 DC8A CDCFDD          17      CALL    _SYS09      ;(BDOS)文字列出力
000B94 DC8D CD6EDB          17      CALL    LTNL
       DC90                     COPY9:
000B97 DC90 CDD5D9          17      CALL    OPEN2
000B9A DC93 18D4            12      JR  COPY1
                                
       DC95                     COPY1A:
000B9C DC95 216C00          10      LD  HL,FCB2
000B9F DC98 1114EE          10      LD  DE,FDRV
000BA2 DC9B 018CED          10      LD  BC,DTA_CCP+2
000BA5 DC9E EDA0            16      LDI
000BA7 DCA0 3E0B             7      LD  A,11
       DCA2                     COPY2:
000BA9 DCA2 F5              11      PUSH    AF
000BAA DCA3 7E               7      LD  A,(HL)
000BAB DCA4 FE3F             7      CP  '?'
000BAD DCA6 2001            12      JR  NZ,COPY3
000BAF DCA8 0A               7      LD  A,(BC)
       DCA9                     COPY3:
000BB0 DCA9 12               7      LD  (DE),A
000BB1 DCAA 03               6      INC BC
000BB2 DCAB 13               6      INC DE
000BB3 DCAC 23               6      INC HL
000BB4 DCAD F1              10      POP AF
000BB5 DCAE 3D               4      DEC A
000BB6 DCAF 20F1            12      JR  NZ,COPY2
000BB8 DCB1 010500          10      LD  BC,16-11
000BBB DCB4 EDB0                    LDIR
       DCB6                     PUTNAME:
000BBD DCB6 215D00          10      LD  HL,FCB1FN
000BC0 DCB9 CD46F4          17      CALL    CHKWILD
000BC3 DCBC 300B            12      JR  NC,PUTN1
000BC5 DCBE 2115EE          10      LD  HL,FDRV+1
000BC8 DCC1 CDE8DB          17      CALL    FPRNT
000BCB DCC4 3E20             7      LD  A,020H
000BCD DCC6 CD12E3          17      CALL    MSG_A
       DCC9                     PUTN1:
000BD0 DCC9 1114EE          10      LD  DE,FDRV
000BD3 DCCC 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
000BD5 DCCE CDF4D9          17      CALL    SYSTEM0
000BD8 DCD1 2048            12      JR  NZ,COPYE2
000BDA DCD3 67               4      LD  H,A     ;A=0
000BDB DCD4 6F               4      LD  L,A
000BDC DCD5 2235EE          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
000BDF DCD8 2237EE          16      LD  (FDRV+35),HL
       DCDB                     COPY6:
000BE2 DCDB CDFDD9          17      CALL    S27BUF
000BE5 DCDE 47               4      LD  B,A
000BE6 DCDF 3C               4      INC A
000BE7 DCE0 2831            12      JR  Z,COPYE
000BE9 DCE2 7C               4      LD  A,H
000BEA DCE3 B5               4      OR  L
000BEB DCE4 280C            12      JR  Z,COPY7
000BED DCE6 1114EE          10      LD  DE,FDRV
000BF0 DCE9 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
000BF2 DCEB CDF4D9          17      CALL    SYSTEM0
000BF5 DCEE 2023            12      JR  NZ,COPYE
000BF7 DCF0 10E9            13      DJNZ    COPY6
       DCF2                     COPY7:
000BF9 DCF2 3A97ED          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
000BFC DCF5 3221EE          13      LD  (FDRV+13),A
000BFF DCF8 219EED          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
000C02 DCFB 1128EE          10      LD  DE,FDRV+20
000C05 DCFE 010400          10      LD  BC,4
000C08 DD01 EDB0                    LDIR
                                
000C0A DD03 1114EE          10      LD  DE,FDRV
000C0D DD06 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
000C0F DD08 CDF4D9          17      CALL    SYSTEM0
000C12 DD0B 2006            12      JR  NZ,COPYE
                                
000C14 DD0D 1171EE          10      LD  DE,OK
000C17 DD10 C38ADC          10      JP  COPY8
                                
       DD13                     COPYE:
000C1A DD13 1114EE          10      LD  DE,FDRV
000C1D DD16 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
000C1F DD18 CD0500          17      CALL    SYSTEM
       DD1B                     COPYE2:
000C22 DD1B 37               4      SCF
000C23 DD1C C9              10      RET
                                
       DD1D                     CWILD:
000C24 DD1D 215D00          10      LD  HL,FCB1FN
       DD20                     CWILD1:
000C27 DD20 7E               7      LD  A,(HL)
000C28 DD21 FE20             7      CP  020H
000C2A DD23 C0              11      RET NZ
       DD24                     CWILD2:
000C2B DD24 3E3F             7      LD  A,'?'
000C2D DD26 060B             7      LD  B,11
000C2F DD28 C3B6F0          10      JP  FILL_MEMORY
                                
       DD2B                     COMTB:
000C32 DD2B 44202020                DB  "D   "  ;1
000C36 DD2F DCDA                    DW  C_DIR
000C38 DD31 44495220                DB  "DIR "  ;2
000C3C DD35 DCDA                    DW  C_DIR
000C3E DD37 434F5059                DB  "COPY"  ;3
000C42 DD3B 45DC                    DW  C_COPY
000C44 DD3D 43442020                DB  "CD  "  ;4
000C48 DD41 F9D9                    DW  C_CD
000C4A DD43 44454C20                DB  "DEL "  ;5
000C4E DD47 BFDA                    DW  C_DEL
000C50 DD49 50415448                DB  "PATH"  ;6
000C54 DD4D 73DB                    DW  C_PATH
000C56 DD4F 52454E20                DB  "REN "  ;7
000C5A DD53 C9DA                    DW  C_REN
000C5C DD55 52454D20                DB  "REM "  ;8
000C60 DD59 CDDD                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "88DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   PC-8801mkIISR
                                
                                ;   BANK RAM DISK DRIVER
                                
       DD5B                     BDWT:
000C62 DD5B 3E10             7      LD  A,010H  ;ライト可　リード不可
000C64 DD5D 1802            12  JR  BRW
                                
       DD5F                     BDRD:
000C66 DD5F 3E01             7      LD  A,001H  ;ライト不可　リード可
       DD61                     BRW:
000C68 DD61 F3               4      DI
000C69 DD62 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000C6B DD64 ED739BDD        20      LD  (BANKSP),SP
000C6F DD68 3A9CDD          13      LD  A,(BANKSPH)
000C72 DD6B 87               4      ADD A,A
000C73 DD6C 3803            12      JR  C,BRW1
000C75 DD6E 314EED          10      LD  SP,EXTSP    ;拡張メモリにスタックが重なる場合
       DD71                     BRW1:
000C78 DD71 C5              11      PUSH    BC
000C79 DD72 D5              11      PUSH    DE
000C7A DD73 EB               4      EX  DE,HL       ;DE=メインメモリ
000C7B DD74 29              11      ADD HL,HL
000C7C DD75 29              11      ADD HL,HL
000C7D DD76 7C               4      LD  A,H
000C7E DD77 DD860C          19      ADD A,(IX+DPB_MAXCYL)
000C81 DD7A D3E3            11      OUT (0E3H),A    ;拡張RAM バンク選択
000C83 DD7C 65               4      LD  H,L
000C84 DD7D CB3C             8      SRL H   ;/2
000C86 DD7F 2E00             7      LD  L,0
000C88 DD81 DBE2            11      IN  A,(0E2H)    ;拡張RAM リード/ライト制御
000C8A DD83 0F               4      RRCA
000C8B DD84 3001            12      JR  NC,BRW2     ;0: リード可
000C8D DD86 EB               4      EX  DE,HL       ;DE=拡張メモリ HL=メインメモリ
       DD87                     BRW2:
000C8E DD87 010002          10      LD  BC,512
000C91 DD8A EDB0                    LDIR
                                
000C93 DD8C DBE2            11      IN  A,(0E2H)    ;拡張RAM リード/ライト制御
000C95 DD8E 0F               4      RRCA
000C96 DD8F 3801            12      JR  C,BRW3      ;1: リード不可
000C98 DD91 EB               4      EX  DE,HL       ;DE=拡張メモリ HL=メインメモリ
       DD92                     BRW3:
000C99 DD92 D1              10      POP DE
000C9A DD93 C1              10      POP BC
000C9B DD94 13               6      INC DE
000C9C DD95 10DA            13      DJNZ    BRW1
                                
000C9E DD97 AF               4      XOR A
000C9F DD98 D3E2            11      OUT (0E2H),A    ;メインメモリに切り替える
000CA1 DD9A 310000          10      LD  SP,0
       DD9B                     BANKSP  EQU $-2
       DD9C                     BANKSPH EQU $-1
000CA4 DD9D FB               4      EI
000CA5 DD9E C9              10      RET
                                
[EOF:88DISK2.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       DD9F                     BDOS0:
000CA6 DD9F E5              11      PUSH    HL
000CA7 DDA0 79               4      LD  A,C
000CA8 DDA1 FE3C             7      CP  03CH
000CAA DDA3 3802            12      JR  C,DOS1
000CAC DDA5 3E3C             7      LD  A,03CH
       DDA7                     DOS1:
000CAE DDA7 87               4      ADD A,A
000CAF DDA8 32ACDD          13      LD  (DOS1_SWC),A
000CB2 DDAB 2A00EF          16      LD  HL,(STABLE)
       DDAC                     DOS1_SWC    EQU $-2
000CB5 DDAE E3              19      EX  (SP),HL
000CB6 DDAF 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
000CB7 DDB0 C9              10      RET
       DDB1                     _DOS2:
000CB8 DDB1 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000CBA DDB3 CA4AE0          10      JP  Z,_SYS5A
000CBD DDB6 FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000CBF DDB8 CA07E0          10      JP  Z,_SYS5C
000CC2 DDBB FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
000CC4 DDBD CAB7EA          10      JP  Z,_SYS5F
000CC7 DDC0 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000CC9 DDC2 2009            12      JR  NZ,_ERROR
000CCB DDC4 011D01          10      LD  BC,VER_6F
000CCE DDC7 116201          10      LD  DE,VER
000CD1 DDCA 210201          10      LD  HL,MACD
       DDCD                     C_REM:
       DDCD                     _ERROR:
000CD4 DDCD AF               4      XOR A
000CD5 DDCE C9              10      RET
                                
       DDCF                     _SYS09:     ;文字列出力
000CD6 DDCF D5              11      PUSH    DE
       DDD0                     _SX09:
000CD7 DDD0 1A               7      LD  A,(DE)
000CD8 DDD1 13               6      INC DE
000CD9 DDD2 FE24             7      CP  '$'
000CDB DDD4 2831            12      JR  Z,SX0E2
000CDD DDD6 CD12E3          17      CALL    MSG_A
000CE0 DDD9 18F5            12      JR  _SX09
                                
       DDDB                     MSX1:
000CE2 DDDB CD12E3          17      CALL    MSG_A
       DDDE                     MSX:
000CE5 DDDE 7E               7      LD  A,(HL)
000CE6 DDDF 23               6      INC HL
000CE7 DDE0 B7               4      OR  A
000CE8 DDE1 20F8            12      JR  NZ,MSX1
000CEA DDE3 C9              10      RET
                                
       DDE4                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000CEB DDE4 212200          10      LD  HL,00022H
000CEE DDE7 7D               4      LD  A,L
000CEF DDE8 C9              10      RET
                                
       DDE9                     _SYS0D:     ;(BDOS)ディスクリセット
000CF0 DDE9 CDDFEE          17      CALL    _FFLUSH
000CF3 DDEC E5              11      PUSH    HL
000CF4 DDED 218000          10      LD  HL,00080H
000CF7 DDF0 228AEE          16      LD  (_DTA),HL
000CFA DDF3 E1              10      POP HL
000CFB DDF4 D5              11      PUSH    DE
000CFC DDF5 1E00             7      LD  E,0
000CFE DDF7 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       DDF8                     _SYS0E:     ;(BDOS)カレントドライブの設定
000CFF DDF8 D5              11      PUSH    DE
000D00 DDF9 7B               4      LD  A,E
000D01 DDFA DDE5            15      PUSH    IX
000D03 DDFC CDDCEE          17      CALL    _GETDPB
000D06 DDFF DDE1            14      POP IX
000D08 DE01 3804            12      JR  C,SX0E2
000D0A DE03 7B               4      LD  A,E
000D0B DE04 320400          13      LD  (_DVSW),A
       DE07                     SX0E2:
000D0E DE07 D1              10      POP DE
000D0F DE08 C9              10      RET
                                
       DE09                     _SYS0F:     ;(BDOS)ファイルのオープン
000D10 DE09 CDF3F0          17      CALL    SETDRV
000D13 DE0C FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000D16 DE0F C602             7      ADD A,002H      ;Write
000D18 DE11 2848            12      JR  Z,FEND0F
000D1A DE13 CD42F4          17      CALL    CHKWILDX
                                
000D1D DE16 D41DF1          17      CALL    NC,SOPENX
       DE19                     _S16XX:
000D20 DE19 3840            12      JR  C,FEND0F
                                                ;Directory location
000D22 DE1B 3A9FEE          13      LD  A,(_FILEN)
000D25 DE1E FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
000D28 DE21 3AA0EE          13      LD  A,(_DIRF)
000D2B DE24 FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000D2E DE27 FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
000D31 DE2A FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
000D34 DE2D FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
000D38 DE31 FDE5            15      PUSH    IY
000D3A DE33 D1              10      POP DE
000D3B DE34 13               6      INC DE
000D3C DE35 010B00          10      LD  BC,11
000D3F DE38 EDB0                    LDIR
                                ;               Attribute
000D41 DE3A 7E               7      LD  A,(HL)
000D42 DE3B FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
000D45 DE3E 110B00          10      LD  DE,11       ;Reserved
000D48 DE41 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
000D49 DE42 11E4EF          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
000D4C DE45 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DE47                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000D4E DE47 1A               7      LD  A,(DE)
000D4F DE48 13               6      INC DE
000D50 DE49 3250DE          13      LD  (S16PAT),A
000D53 DE4C 7E               7      LD  A,(HL)
000D54 DE4D 23               6      INC HL
000D55 DE4E FD7700          19      LD  (IY+0),A
       DE50                     S16PAT  EQU $-1
000D58 DE51 10F4            13      DJNZ    S16LOOP
                                
000D5A DE53 AF               4      XOR A
000D5B DE54 FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000D5E DE57 FD22F8DE        20      LD  (OFCB_SWC),IY
       DE5B                     FEND0F:
000D62 DE5B 1845            12      JR  FEND10
                                
       DE5D                     _SYS10:     ;(BDOS)ファイルのクローズ
000D64 DE5D CDF3F0          17      CALL    SETDRV
000D67 DE60 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000D6A DE63 D6FE             7      SUB 0FEH
000D6C DE65 37               4      SCF
000D6D DE66 3F               4      CCF
000D6E DE67 2039            12      JR  NZ,FEND10
       DE69                     _S10A:              ;Write
000D70 DE69 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000D73 DE6C FD770F          19      LD  (IY+15),A
                                
000D76 DE6F FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
000D79 DE72 CD3EF5          17      CALL    SETTMS
                                
000D7C DE75 FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000D7F DE78 32A0EE          13      LD  (_DIRF),A
000D82 DE7B E67F             7      AND 07FH
000D84 DE7D 32D7E7          13      LD  (_SECPS),A
000D87 DE80 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000D8A DE83 FD561F          19      LD  D,(IY+31)
000D8D DE86 CD51F2          17      CALL    READ_DIR
000D90 DE89 3817            12      JR  C,FEND10
                                
000D92 DE8B 3A7DF1          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000D95 DE8E 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000D96 DE8F FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000D99 DE92 6F               4      LD  L,A
000D9A DE93 2600             7      LD  H,0
000D9C DE95 29              11      ADD HL,HL       ;*2
000D9D DE96 29              11      ADD HL,HL       ;*4
000D9E DE97 29              11      ADD HL,HL       ;*8
000D9F DE98 29              11      ADD HL,HL       ;*16
000DA0 DE99 29              11      ADD HL,HL       ;*32
000DA1 DE9A ED4B7EEF        20      LD  BC,(_DTBUF)
000DA5 DE9E 09              11      ADD HL,BC
                                
000DA6 DE9F CD52F4          17      CALL    SDIRENT
       DEA2                     FEND10:
000DA9 DEA2 1842            12      JR  FEND
                                
       DEA4                     _SYS11:     ;(BDOS)最初のファイルの検索
000DAB DEA4 CDF3F0          17      CALL    SETDRV
000DAE DEA7 CD4CF1          17      CALL    SOPEN
       DEAA                     _S12X1:
000DB1 DEAA 383A            12      JR  C,FEND
000DB3 DEAC CDEBF1          17      CALL    SOPENE2
000DB6 DEAF ED5B8AEE        20      LD  DE,(_DTA)
000DBA DEB3 3A88EE          13      LD  A,(_DRV)
000DBD DEB6 3C               4      INC A
000DBE DEB7 12               7      LD  (DE),A
000DBF DEB8 D5              11      PUSH    DE
000DC0 DEB9 13               6      INC DE
000DC1 DEBA 012000          10      LD  BC,32
000DC4 DEBD EDB0                    LDIR
000DC6 DEBF FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000DC9 DEC2 FD660F          19      LD  H,(IY+15)
000DCC DEC5 22F4EF          16      LD  (SCDIR),HL
000DCF DEC8 2A9AEE          16      LD  HL,(_FBPS)
000DD2 DECB 22F6EF          16      LD  (SFBPS),HL
000DD5 DECE 2A9FEE          16      LD  HL,(_FILEN)
000DD8 DED1 7C               4      LD  A,H
000DD9 DED2 B7               4      OR  A
000DDA DED3 2806            12      JR  Z,_S12DIR
000DDC DED5 3AD7E7          13      LD  A,(_SECPS)
000DDF DED8 F680             7      OR  080H
000DE1 DEDA 67               4      LD  H,A
       DEDB                     _S12DIR:
000DE2 DEDB 22F8EF          16      LD  (SFNDF),HL  ;Directory position and Flags
000DE5 DEDE E1              10      POP HL
000DE6 DEDF 1139EE          10      LD  DE,SFILE
000DE9 DEE2 0E21             7      LD  C,33
       DEE4                     _S11B:
000DEB DEE4 EDB0                    LDIR
       DEE6                     FEND:
000DED DEE6 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       DEE7                     FENDE:
000DEE DEE7 FDE1            14      POP IY
000DF0 DEE9 C1              10      POP BC
000DF1 DEEA D1              10      POP DE
000DF2 DEEB E1              10      POP HL
000DF3 DEEC C9              10      RET
                                
       DEED                     _SYS12:     ;(BDOS)次のファイルの検索
000DF4 DEED E5              11      PUSH    HL
000DF5 DEEE D5              11      PUSH    DE
000DF6 DEEF C5              11      PUSH    BC
000DF7 DEF0 FDE5            15      PUSH    IY
000DF9 DEF2 CDB0F1          17      CALL    NOPEN
000DFC DEF5 18B3            12      JR  _S12X1
                                
       DEF7                     _S16K:
000DFE DEF7 110000          10      LD  DE,0
       DEF8                     OFCB_SWC    EQU $-2
000E01 DEFA D5              11      PUSH    DE
000E02 DEFB 061A             7      LD  B,26        ;First cluster
       DEFD                     S16K1:
000E04 DEFD 13               6      INC DE
000E05 DEFE 23               6      INC HL
000E06 DEFF 10FC            13      DJNZ    S16K1
                                
000E08 DF01 1A               7      LD  A,(DE)
000E09 DF02 BE               7      CP  (HL)
000E0A DF03 2015            12      JR  NZ,S16K2
000E0C DF05 13               6      INC DE
000E0D DF06 23               6      INC HL
000E0E DF07 1A               7      LD  A,(DE)
000E0F DF08 BE               7      CP  (HL)
000E10 DF09 200F            12      JR  NZ,S16K2
                                
000E12 DF0B E1              10      POP HL
000E13 DF0C FDE5            15      PUSH    IY
000E15 DF0E D1              10      POP DE
000E16 DF0F 7E               7      LD  A,(HL)
000E17 DF10 CD08F1          17      CALL    IS_SAME_DRV_A_DE
000E1A DF13 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000E1C DF15 ED52            15      SBC HL,DE       ;CP HL,DE
000E1E DF17 37               4      SCF
000E1F DF18 C0              11      RET NZ
000E20 DF19 E5              11      PUSH    HL
       DF1A                     S16K2:
000E21 DF1A E1              10      POP HL
       DF1B                     S16K3:
000E22 DF1B FDE5            15      PUSH    IY
000E24 DF1D D1              10      POP DE
       DF1E                     _SYS13:     ;(BDOS)ファイルの削除
000E25 DF1E CDF3F0          17      CALL    SETDRV
000E28 DF21 CD7AF3          17      CALL    KILL
       DF24                     FEND13:
000E2B DF24 18C0            12      JR  FEND
                                
       DF26                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000E2D DF26 CDF3F0          17      CALL    SETDRV
000E30 DF29 CD2AE6          17      CALL    INIT_SEQ
       DF2C                     SREAD:
000E33 DF2C CDFCE5          17      CALL    RB_READ
                                
000E36 DF2F C601             7      ADD A,001H
000E38 DF31 38B3            12      JR  C,FEND
                                
000E3A DF33 7D               4      LD  A,L
000E3B DF34 D601             7      SUB 001H
       DF36                     FENDX:
000E3D DF36 9F               4      SBC A,A
000E3E DF37 E603             7      AND 3
000E40 DF39 1F               4      RRA
000E41 DF3A 18AB            12      JR  FENDE
                                
       DF3C                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000E43 DF3C CDF3F0          17      CALL    SETDRV
000E46 DF3F CD2AE6          17      CALL    INIT_SEQ
       DF42                     SWRITE:
000E49 DF42 CDF7E5          17      CALL    RB_WRITE
                                
000E4C DF45 C6FF             7      ADD A,0FFH
000E4E DF47 18ED            12      JR  FENDX
                                
       DF49                     _SYS17:     ;(BDOS)ファイル名の変更
000E50 DF49 CDF3F0          17      CALL    SETDRV
000E53 DF4C CDD0F3          17      CALL    NAME
000E56 DF4F 18D3            12      JR  FEND13
                                
       DF51                     _SYS16:     ;(BDOS)ファイルの作成
000E58 DF51 CDF3F0          17      CALL    SETDRV
                                
000E5B DF54 CD42F4          17      CALL    CHKWILDX
000E5E DF57 38CB            12      JR  C,FEND13
000E60 DF59 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000E63 DF5C FE05             7      CP  5
000E65 DF5E 2805            12      JR  Z,_S16X2
000E67 DF60 FE21             7      CP  021H
000E69 DF62 DA24DF          10      JP  C,FEND13
       DF65                     _S16X2:
                                ;               Clear FCB
000E6C DF65 FDE5            15      PUSH    IY
000E6E DF67 E1              10      POP HL
000E6F DF68 011000          10      LD  BC,16
000E72 DF6B 09              11      ADD HL,BC
       DF6C                     _S16X1:
000E73 DF6C 70               7      LD  (HL),B      ;B=0
000E74 DF6D 23               6      INC HL
000E75 DF6E 0D               4      DEC C
000E76 DF6F 20FB            12      JR  NZ,_S16X1
                                
000E78 DF71 CD43F5          17      CALL    SETTMSX
000E7B DF74 FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000E7F DF78 CD1DF1          17      CALL    SOPENX
000E82 DF7B 3F               4      CCF
000E83 DF7C CCF7DE          17      CALL    Z,_S16K
000E86 DF7F D4FCF1          17      CALL    NC,COPEN
000E89 DF82 D452F4          17      CALL    NC,SDIRENT
000E8C DF85 C319DE          10      JP  _S16XX
                                
       DF88                     _SYS21:     ;(BDOS)ランダムな読み出し
000E8F DF88 CDF3F0          17      CALL    SETDRV
000E92 DF8B CD8EF5          17      CALL    INIT_RND
000E95 DF8E 189C            12      JR  SREAD
                                
       DF90                     _SYS22:     ;(BDOS)ランダムな書き込み
       DF90                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000E97 DF90 CDF3F0          17      CALL    SETDRV
000E9A DF93 CD8EF5          17      CALL    INIT_RND
000E9D DF96 18AA            12      JR  SWRITE
                                
       DF98                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000E9F DF98 21FF00          10      LD  HL,000FFH
000EA2 DF9B AF               4      XOR A
000EA3 DF9C C9              10      RET
                                
       DF9D                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000EA4 DF9D 3A0400          13      LD  A,(_DVSW)   ;from LDOS
000EA7 DFA0 A7               4      AND A
000EA8 DFA1 C9              10      RET
                                
       DFA2                     _SYS1A:     ;(BDOS)DTAの設定
000EA9 DFA2 ED538AEE        20      LD  (_DTA),DE
000EAD DFA6 AF               4      XOR A
000EAE DFA7 C9              10      RET
                                
       DFA8                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000EAF DFA8 7B               4      LD  A,E
000EB0 DFA9 CD01F1          17      CALL    GETDRV
000EB3 DFAC CDDCEE          17      CALL    _GETDPB
000EB6 DFAF D4E2EE          17      CALL    NC,_RDFATX
000EB9 DFB2 210000          10      LD  HL,0
000EBC DFB5 D41CF5          17      CALL    NC,DSKF
                                
000EBF DFB8 ED5B1DF5        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000EC3 DFBC 1B               6      DEC DE      ;DE←クラスタの総数
000EC4 DFBD FD2A7CEF        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000EC8 DFC1 9F               4      SBC A,A
000EC9 DFC2 D8              11      RET C
000ECA DFC3 4F               4      LD  C,A     ;C=0
000ECB DFC4 DD7E0F          19      LD  A,(IX+DPB_BPS)
000ECE DFC7 E607             7      AND 7
000ED0 DFC9 47               4      LD  B,A
000ED1 DFCA DD7E07          19      LD  A,(IX+DPB_SECPCL)
000ED4 DFCD C9              10      RET
                                
       DFCE                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000ED5 DFCE AF               4      XOR A
000ED6 DFCF 67               4      LD  H,A
000ED7 DFD0 6F               4      LD  L,A
000ED8 DFD1 C9              10      RET
                                
       DFD2                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000ED9 DFD2 2100F6          10      LD  HL,_DEVICE
000EDC DFD5 7B               4      LD  A,E
000EDD DFD6 C3DCEE          10      JP  _GETDPB
                                
       DFD9                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000EE0 DFD9 E5              11      PUSH    HL
000EE1 DFDA 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000EE3 DFDC CD9FDD          17      CALL    BDOS0
000EE6 DFDF 381B            12      JR  C,_S23X1
                                
000EE8 DFE1 D5              11      PUSH    DE      ;EX DE,IY
000EE9 DFE2 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000EEB DFE4 FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000EEE DFE7 FD6E11          19      LD  L,(IY+17)   ;
000EF1 DFEA FD6612          19      LD  H,(IY+18)   ;
000EF4 DFED C5              11      PUSH    BC      ;
000EF5 DFEE FD4613          19      LD  B,(IY+19)   ;
000EF8 DFF1 CD80F5          17      CALL    GET_CPM_R_SIZE
000EFB DFF4 C1              10      POP BC
       DFF5                     _S24X1:
000EFC DFF5 CDA0F5          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000EFF DFF8 FDE3            23      EX  (SP),IY     ;
000F01 DFFA D1              10      POP DE      ;
                                
000F02 DFFB AF               4      XOR A
       DFFC                     _S23X1:
000F03 DFFC E1              10      POP HL
000F04 DFFD C9              10      RET
                                
       DFFE                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000F05 DFFE E5              11      PUSH    HL
000F06 DFFF D5              11      PUSH    DE      ;EX DE,IY
000F07 E000 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000F09 E002 CD32E6          17      CALL    GETSEQ
000F0C E005 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       E007                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000F0E E007 2B               6      DEC HL
       E008                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000F0F E008 C5              11      PUSH    BC
000F10 E009 E5              11      PUSH    HL
000F11 E00A CD0BF0          17      CALL    FILE
000F14 E00D E1              10      POP HL
000F15 E00E C1              10      POP BC
       E00F                     S29X1:
000F16 E00F C5              11      PUSH    BC
000F17 E010 D5              11      PUSH    DE
000F18 E011 E5              11      PUSH    HL
000F19 E012 EB               4      EX  DE,HL
000F1A E013 AF               4      XOR A
000F1B E014 3221EE          13      LD  (FDRV+13),A
000F1E E017 2114EE          10      LD  HL,FDRV
000F21 E01A 011000          10      LD  BC,16
000F24 E01D EDB0                    LDIR
000F26 E01F E1              10      POP HL
000F27 E020 D1              10      POP DE
000F28 E021 C1              10      POP BC
000F29 E022 C9              10      RET
                                
       E023                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000F2A E023 C5              11      PUSH    BC
000F2B E024 0178E9          10      LD  BC,DWT24B
000F2E E027 1804            12      JR  S2FX
       E029                     _SYS2F:
000F30 E029 C5              11      PUSH    BC
000F31 E02A 016AE9          10      LD  BC,DRD24B
       E02D                     S2FX:
000F34 E02D ED4343E0        20      LD  (S2F_SWC),BC
000F38 E031 CDDFEE          17      CALL    _FFLUSH
                                
000F3B E034 D5              11      PUSH    DE
000F3C E035 E5              11      PUSH    HL
000F3D E036 7D               4      LD  A,L     ;Drive
000F3E E037 CDD9EE          17      CALL    _CHGDRV
000F41 E03A 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
000F43 E03C 44               4      LD  B,H     ;Number of clusters
000F44 E03D 2A8AEE          16      LD  HL,(_DTA)
                                
000F47 E040 0E00             7      LD  C,0
000F49 E042 CD6AE9          17      CALL    DRD24B
       E043                     S2F_SWC EQU $-2
       E045                     POP_HL_DE_BC_SBCAA_RET:
000F4C E045 E1              10      POP HL
000F4D E046 D1              10      POP DE
000F4E E047 C1              10      POP BC
000F4F E048 9F               4      SBC A,A
000F50 E049 C9              10      RET
                                
       E04A                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000F51 E04A C5              11      PUSH    BC
000F52 E04B D5              11      PUSH    DE
000F53 E04C E5              11      PUSH    HL
000F54 E04D CD00F0          17      CALL    FILEC
000F57 E050 2145E0          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
000F5A E053 E5              11      PUSH    HL
000F5B E054 3A21EE          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
000F5E E057 E610             7      AND 010H        ;ディレクトリ
000F60 E059 37               4      SCF
000F61 E05A C8              11      RET Z
000F62 E05B 1114EE          10      LD  DE,FDRV
000F65 E05E 2A4EEF          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       E061                     JPHL:
000F68 E061 E9               4      JP  (HL)
                                
       E062                     SHOW_ERROR:         ;(9)
000F69 E062 1179EE          10      LD  DE,COMERM
000F6C E065 CDCFDD          17      CALL    _SYS09      ;(BDOS)文字列出力
000F6F E068 C300EE          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "88IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   PC-8801mkIISR
                                ;   割り込み処理は0F000Hより前にする
                                
       DDCD                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       DDCD                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       DDCD                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       DDCD                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       DDCD                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       DDCD                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       E06B                     BDOS_RF:
000F72 E06B DB32            11      IN  A,(032H)
000F74 E06D F610             7      OR  010H        ;高速RAMアクセスモード/メインRAM
000F76 E06F D332            11      OUT (032H),A
000F78 E071 C39FDD          10      JP  BDOS0
                                
       E074                     _SYS0A:     ;(BDOS)文字列入力
000F7B E074 C5              11      PUSH    BC
000F7C E075 E5              11      PUSH    HL
000F7D E076 D5              11      PUSH    DE
000F7E E077 CDB1E1          17      CALL    GETL
000F81 E07A 1120FF          10      LD  DE,KBUF
000F84 E07D E1              10      POP HL
000F85 E07E E5              11      PUSH    HL
000F86 E07F 0E00             7      LD  C,0
000F88 E081 3004            12      JR  NC,SAX0
000F8A E083 23               6      INC HL
000F8B E084 23               6      INC HL
000F8C E085 1808            12      JR  SAX4
       E087                     SAX0:
000F8E E087 46               7      LD  B,(HL)
000F8F E088 23               6      INC HL
       E089                     SAX1:
000F90 E089 23               6      INC HL
000F91 E08A 1A               7      LD  A,(DE)
000F92 E08B 13               6      INC DE
000F93 E08C B7               4      OR  A
000F94 E08D 2004            12      JR  NZ,SAX2
       E08F                     SAX4:
000F96 E08F 360D            10      LD  (HL),00DH
000F98 E091 1804            12      JR  SAX3
       E093                     SAX2:
000F9A E093 77               7      LD  (HL),A
000F9B E094 0C               4      INC C
000F9C E095 10F2            13      DJNZ    SAX1
       E097                     SAX3:
000F9E E097 D1              10      POP DE
000F9F E098 79               4      LD  A,C
000FA0 E099 13               6      INC DE
000FA1 E09A 12               7      LD  (DE),A
000FA2 E09B 1B               6      DEC DE
000FA3 E09C E1              10      POP HL
000FA4 E09D C1              10      POP BC
000FA5 E09E A7               4      AND A
000FA6 E09F C9              10      RET
                                
       E0A0                     _SYS2A:     ;(BDOS)日付の獲得
000FA7 E0A0 C5              11      PUSH    BC
000FA8 E0A1 CDE4E0          17      CALL    RTCREAD
000FAB E0A4 3A62EE          13      LD  A,(RTC_YY)
000FAE E0A7 CD66E3          17      CALL    BCD
000FB1 E0AA 6F               4      LD  L,A
000FB2 E0AB 2600             7      LD  H,0
                                ;   LD  DE,1900     ;0076CH
                                ;   CP  90      ;90以上は1900年代 1990-1999
                                ;   JR  NC,RDDATE1  ;90未満は2000年代 2000-2089
                                ;   LD  E,0D0H      ;2000 & 0FFH D=007H
000FB4 E0AD 11D007          10      LD  DE,2000     ;すべて2000年代で処理 2000-2099
       E0B0                     RDDATE1:
000FB7 E0B0 19              11      ADD HL,DE
000FB8 E0B1 3A63EE          13      LD  A,(RTC_MW)
000FBB E0B4 57               4      LD  D,A
000FBC E0B5 3A64EE          13      LD  A,(RTC_DD)
000FBF E0B8 CD66E3          17      CALL    BCD
000FC2 E0BB 5F               4      LD  E,A
000FC3 E0BC 7A               4      LD  A,D
000FC4 E0BD 0604             7      LD  B,4
       E0BF                     RDDATE2:
000FC6 E0BF CB3A             8      SRL D
000FC8 E0C1 10FC            13      DJNZ    RDDATE2
000FCA E0C3 C1              10      POP BC
000FCB E0C4 E607             7      AND 7
000FCD E0C6 C9              10      RET
                                
       E0C7                     _SYS2C:     ;(BDOS)時刻の獲得
000FCE E0C7 C5              11      PUSH    BC
000FCF E0C8 CDE4E0          17      CALL    RTCREAD
000FD2 E0CB 3A65EE          13      LD  A,(RTC_TT)
000FD5 E0CE CD66E3          17      CALL    BCD
000FD8 E0D1 67               4      LD  H,A
000FD9 E0D2 3A66EE          13      LD  A,(RTC_MM)
000FDC E0D5 CD66E3          17      CALL    BCD
000FDF E0D8 6F               4      LD  L,A
000FE0 E0D9 3A67EE          13      LD  A,(RTC_SS)
000FE3 E0DC CD66E3          17      CALL    BCD
000FE6 E0DF 57               4      LD  D,A
000FE7 E0E0 C1              10      POP BC
000FE8 E0E1 AF               4      XOR A
000FE9 E0E2 5F               4      LD  E,A
000FEA E0E3 C9              10      RET
                                
       E0E4                     RTCREAD:
000FEB E0E4 0EF9             7      LD  C,0F9H
000FED E0E6 3AB9EE          13      LD  A,(WK40)
000FF0 E0E9 5F               4      LD  E,A
000FF1 E0EA 3E03             7      LD  A,3     ;コマンド３：タイムリードにセット
000FF3 E0EC CD16E1          17      CALL    RTCCMD
000FF6 E0EF 3E01             7      LD  A,1     ;コマンド１：レジスタシフトにセット
000FF8 E0F1 CD16E1          17      CALL    RTCCMD
000FFB E0F4 0606             7      LD  B,6
000FFD E0F6 2167EE          10      LD  HL,RTC_SS
       E0F9                     RTCREAD1:
001000 E0F9 C5              11      PUSH    BC
001001 E0FA 0608             7      LD  B,8
       E0FC                     RTCREAD2:
001003 E0FC DB40            11      IN  A,(40H)     ;システムモードセンス BIT4:CDI
001005 E0FE 87               4      ADD A,A
001006 E0FF 87               4      ADD A,A
001007 E100 87               4      ADD A,A
001008 E101 87               4      ADD A,A
001009 E102 CB1E            15      RR  (HL)
00100B E104 CD3BE1          17      CALL    RTCCLK
00100E E107 10F3            13      DJNZ    RTCREAD2
001010 E109 C1              10      POP BC
001011 E10A 2B               6      DEC HL
001012 E10B 10EC            13      DJNZ    RTCREAD1
001014 E10D AF               4      XOR A
001015 E10E CD16E1          17      CALL    RTCCMD
001018 E111 7B               4      LD  A,E
001019 E112 32B9EE          13      LD  (WK40),A
00101C E115 C9              10      RET
                                
       E116                     RTCCMD:
00101D E116 0604             7      LD  B,4
00101F E118 07               4      RLCA
001020 E119 07               4      RLCA
001021 E11A 07               4      RLCA
       E11B                     RTCCMD1:
001022 E11B F5              11      PUSH    AF
001023 E11C F607             7      OR  7
001025 E11E D310            11      OUT (10H),A     ;プリンタデータ出力 兼 カレンダクロック(μPD1990AC)出力
001027 E120 CD3BE1          17      CALL    RTCCLK
00102A E123 F1              10      POP AF
00102B E124 0F               4      RRCA
00102C E125 10F4            13      DJNZ    RTCCMD1
00102E E127 3E07             7      LD  A,7
001030 E129 D310            11      OUT (10H),A     ;プリンタデータ出力 兼 カレンダクロック(μPD1990AC)出力
001032 E12B 7B               4      LD  A,E
001033 E12C A1               4      AND C
001034 E12D F602             7      OR  2
001036 E12F D340            11      OUT (40H),A     ;ストローブポート
001038 E131 A1               4      AND C
001039 E132 00               4      NOP
00103A E133 D340            11      OUT (40H),A     ;ストローブポート
00103C E135 5F               4      LD  E,A
00103D E136 060D             7      LD  B,13
       E138                     RTCCMD3:
00103F E138 10FE            13      DJNZ    RTCCMD3
001041 E13A C9              10      RET
                                
       E13B                     RTCCLK:
001042 E13B 7B               4      LD  A,E
001043 E13C A1               4      AND C
001044 E13D F604             7      OR  04H
001046 E13F D340            11      OUT (40H),A
001048 E141 A1               4      AND C
001049 E142 00               4      NOP
00104A E143 D340            11      OUT (40H),A
00104C E145 5F               4      LD  E,A
00104D E146 C9              10      RET
                                
       E147                     PRINT:
00104E E147 DB32            11      IN  A,(032H)
001050 E149 F5              11      PUSH    AF
001051 E14A E6EF             7      AND 0EFH        ;高速RAMアクセスモード/高速RAM
001053 E14C D332            11      OUT (032H),A
001055 E14E C5              11      PUSH    BC
001056 E14F E5              11      PUSH    HL
001057 E150 3E00             7      LD  A,000H      ;自己書き換え
       E151                     ESCFLG  EQU $-1
001059 E152 B7               4      OR  A
00105A E153 C255F0          10      JP  NZ,ESC
                                
00105D E156 3E1F             7      LD  A,01FH
00105F E158 BB               4      CP  E
001060 E159 D278F0          10      JP  NC,CTRL
       E15C                     INSFLG  EQU $
001063 E15C 0136F1          10      LD  BC,INSERT   ;自己書き換え
       E15F                     ANK:
001066 E15F CD6DE1          17      CALL    LOC0
001069 E162 73               7      LD  (HL),E
00106A E163 CD89F0          17      CALL    CTRL1C
       E166                     PRINTE5:
00106D E166 E1              10      POP HL
00106E E167 C1              10      POP BC
00106F E168 F1              10      POP AF
001070 E169 D332            11      OUT (032H),A
001072 E16B AF               4      XOR A
001073 E16C C9              10      RET
                                
       E16D                     LOC0:
001074 E16D 2A8EEE          16      LD  HL,(_TXADR) ;L=x H=y
       E170                     LOC1:
001077 E170 D5              11      PUSH    DE
001078 E171 7C               4      LD  A,H
001079 E172 CB15             8      RL  L
00107B E174 CB3C             8      SRL H   ;*128
00107D E176 CB1D             8      RR  L
                                
00107F E178 87               4      ADD A,A ;*2
001080 E179 87               4      ADD A,A ;*4
001081 E17A 87               4      ADD A,A ;*8
001082 E17B 5F               4      LD  E,A
001083 E17C 7D               4      LD  A,L
001084 E17D 93               4      SUB E
001085 E17E 5F               4      LD  E,A
                                
001086 E17F 9F               4      SBC A,A
001087 E180 84               4      ADD A,H
001088 E181 57               4      LD  D,A
                                
001089 E182 2AB2EE          16      LD  HL,(TVRAMTOP)
00108C E185 19              11      ADD HL,DE
00108D E186 D1              10      POP DE
00108E E187 C9              10      RET
                                
       E188                     CONOUT1:
00108F E188 59               4      LD  E,C
001090 E189 CDCDEE          17      CALL    _PRINT
001093 E18C 7B               4      LD  A,E
001094 E18D FE0A             7      CP  00AH
001096 E18F 2006            12      JR  NZ,CURSOR_ON
001098 E191 CD09F1          17      CALL    CTRL0D
00109B E194 CDF5F0          17      CALL    CTRL05
       E197                     CURSOR_ON:
00109E E197 F5              11      PUSH    AF
00109F E198 3E81             7      LD  A,081H
       E19A                     CURSOR0:
0010A1 E19A D351            11      OUT (051H),A
0010A3 E19C 3A8EEE          13      LD  A,(_TXADR)
0010A6 E19F D350            11      OUT (050H),A
0010A8 E1A1 3A8FEE          13      LD  A,(_TXADR+1)
0010AB E1A4 D350            11      OUT (050H),A
0010AD E1A6 F1              10      POP AF
0010AE E1A7 C9              10      RET
       E1A8                     CURSOR_OFF:
0010AF E1A8 F5              11      PUSH    AF
0010B0 E1A9 3E80             7      LD  A,080H
0010B2 E1AB 18ED            12      JR  CURSOR0
                                
       E1AD                     POS:
0010B4 E1AD 2A8EEE          16      LD  HL,(_TXADR)
0010B7 E1B0 C9              10      RET
                                
       E1B1                     GETL:
0010B8 E1B1 CDD3EE          17      CALL    _POS
0010BB E1B4 E5              11      PUSH    HL
0010BC E1B5 3ECD             7      LD  A,0CDH      ;CALL ????
0010BE E1B7 325CE1          13      LD  (INSFLG),A
       E1BA                     GETL1:
0010C1 E1BA CD28E3          17      CALL    _SYS08
0010C4 E1BD FE09             7      CP  9
0010C6 E1BF 2008            12      JR  NZ,GETL1V
0010C8 E1C1 2120FF          10      LD  HL,KBUF
0010CB E1C4 CDDEDD          17      CALL    MSX
0010CE E1C7 18F1            12      JR  GETL1
       E1C9                     GETL1V:
0010D0 E1C9 5F               4      LD  E,A
0010D1 E1CA CDCDEE          17      CALL    _PRINT
                                
0010D4 E1CD 7B               4      LD  A,E
0010D5 E1CE FE0D             7      CP  00DH
0010D7 E1D0 20E8            12      JR  NZ,GETL1
0010D9 E1D2 3E01             7      LD  A,1     ;LD BC,????
0010DB E1D4 325CE1          13      LD  (INSFLG),A
0010DE E1D7 1120FF          10      LD  DE,KBUF
0010E1 E1DA 3E50             7      LD  A,WIDTH
0010E3 E1DC 47               4      LD  B,A
0010E4 E1DD CD3FDC          17      CALL    ZERO_MEMORY_DE
                                
0010E7 E1E0 D1              10      POP DE
0010E8 E1E1 CDD3EE          17      CALL    _POS
0010EB E1E4 6B               4      LD  L,E
0010EC E1E5 3E50             7      LD  A,WIDTH
0010EE E1E7 95               4      SUB L
0010EF E1E8 57               4      LD  D,A
0010F0 E1E9 CD70E1          17      CALL    LOC1
0010F3 E1EC 4D               4      LD  C,L
0010F4 E1ED 7C               4      LD  A,H
0010F5 E1EE F630             7      OR  030H
0010F7 E1F0 47               4      LD  B,A
0010F8 E1F1 5A               4      LD  E,D
0010F9 E1F2 2120FF          10      LD  HL,KBUF
       E1F5                     GETL2:
0010FC E1F5 CDD0EE          17      CALL    _SCRN
0010FF E1F8 03               6      INC BC
001100 E1F9 77               7      LD  (HL),A
001101 E1FA 23               6      INC HL
001102 E1FB 1D               4      DEC E
001103 E1FC 20F7            12      JR  NZ,GETL2
       E1FE                     GETL3:
001105 E1FE 2B               6      DEC HL
001106 E1FF 7E               7      LD  A,(HL)
001107 E200 FE21             7      CP  021H
001109 E202 D0              11      RET NC
00110A E203 3600            10      LD  (HL),0
00110C E205 15               4      DEC D
00110D E206 20F6            12      JR  NZ,GETL3
00110F E208 C9              10      RET
                                
       E209                     INKEY:
001110 E209 FB               4      EI
001111 E20A E5              11      PUSH    HL
001112 E20B 2A90EE          16      LD  HL,(_KEYPS)
001115 E20E 7C               4      LD  A,H
001116 E20F AD               4      XOR L
001117 E210 280E            12      JR  Z,INKEY1
001119 E212 7C               4      LD  A,H
00111A E213 3C               4      INC A
00111B E214 E61F             7      AND 01FH
00111D E216 3291EE          13      LD  (_KEYPS+1),A
001120 E219 C610             7      ADD A,LOW KEYBF
001122 E21B 6F               4      LD  L,A
001123 E21C 26ED             7      LD  H,HIGH KEYBF
001125 E21E 7E               7      LD  A,(HL)
001126 E21F B7               4      OR  A
       E220                     INKEY1:
001127 E220 E1              10      POP HL
001128 E221 C9              10      RET
                                
       E222                     CHKEY:
001129 E222 C5              11      PUSH    BC
00112A E223 DB32            11      IN  A,(032H)
00112C E225 F5              11      PUSH    AF
00112D E226 E6EF             7      AND 0EFH        ;高速RAMアクセスモード/高速RAM
00112F E228 D332            11      OUT (032H),A
001131 E22A DB08            11      IN  A,(8)       ;6:SHIFT,7:CTRL
001133 E22C 4F               4      LD  C,A
001134 E22D 3A0E00          13      LD  A,(00EH)
001137 E230 CB5F             8      BIT 3,A
001139 E232 2002            12      JR  NZ,CHKEYRSHIFT
00113B E234 CBB1             8      RES 6,C
       E236                     CHKEYRSHIFT:
00113D E236 79               4      LD  A,C
00113E E237 3A93EE          13      LD  A,(_KEYST)
001141 E23A B9               4      CP  C
001142 E23B 3293EE          13      LD  (_KEYST),A
001145 E23E 280C            12      JR  Z,KEYST1
001147 E240 3A92EE          13      LD  A,(_KEYD)
00114A E243 B7               4      OR  A
00114B E244 2805            12      JR  Z,KEYST0
00114D E246 3E20             7      LD  A,020H      ;JR NZ,?
00114F E248 32DBE2          13      LD  (SETKEY1_SWC),A
       E24B                     KEYST0:
001152 E24B 79               4      LD  A,C
       E24C                     KEYST1:
001153 E24C E5              11      PUSH    HL
001154 E24D 0E00             7      LD  C,0
001156 E24F 21B8F1          10      LD  HL,KEY_TABLE
001159 E252 CB77             8      BIT 6,A
00115B E254 2003            12      JR  NZ,CHKEY0
00115D E256 2120F2          10      LD  HL,SHIFT_TABLE
       E259                     CHKEY0:
001160 E259 CB7F             8      BIT 7,A
001162 E25B 2003            12      JR  NZ,CHKEY1
001164 E25D 2188F2          10      LD  HL,CTRL_TABLE
       E260                     CHKEY1:
001167 E260 ED78            12      IN  A,(C)
001169 E262 0608             7      LD  B,8
       E264                     CHKEY2:
00116B E264 0F               4      RRCA
00116C E265 300B            12      JR  NC,CHKEY4
       E267                     CHKEY3:
00116E E267 23               6      INC HL
00116F E268 10FA            13      DJNZ    CHKEY2
001171 E26A 0C               4      INC C
001172 E26B 79               4      LD  A,C
001173 E26C D60D             7      SUB 00DH
001175 E26E 20F0            12      JR  NZ,CHKEY1
001177 E270 1804            12      JR  CHKEY5
       E272                     CHKEY4:
001179 E272 7E               7      LD  A,(HL)
00117A E273 B7               4      OR  A
00117B E274 28F1            12      JR  Z,CHKEY3
       E276                     CHKEY5:
00117D E276 E1              10      POP HL
00117E E277 C1              10      POP BC
00117F E278 4F               4      LD  C,A
001180 E279 78               4      LD  A,B
001181 E27A D332            11      OUT (032H),A
001183 E27C 79               4      LD  A,C
001184 E27D C1              10      POP BC
001185 E27E B7               4      OR  A
001186 E27F 3292EE          13      LD  (_KEYD),A
001189 E282 C9              10      RET
                                
       E283                     SCRN:
00118A E283 E5              11      PUSH    HL
00118B E284 DB32            11      IN  A,(032H)
00118D E286 67               4      LD  H,A
00118E E287 E6EF             7      AND 0EFH        ;高速RAMアクセスモード/高速RAM
001190 E289 D332            11      OUT (032H),A
001192 E28B 0A               7      LD  A,(BC)
001193 E28C 6F               4      LD  L,A
001194 E28D 7C               4      LD  A,H
001195 E28E D332            11      OUT (032H),A
001197 E290 7D               4      LD  A,L
001198 E291 E1              10      POP HL
001199 E292 C9              10      RET
                                
       E293                     VBLANK:
00119A E293 F5              11      PUSH    AF
       E294                     VBLANK0:
00119B E294 DB40            11      IN  A,(040H)
00119D E296 E620             7      AND 020H
00119F E298 20FA            12      JR  NZ,VBLANK0
       E29A                     VBLANK1:
0011A1 E29A DB40            11      IN  A,(040H)
0011A3 E29C E620             7      AND 020H
0011A5 E29E 28FA            12      JR  Z,VBLANK1
0011A7 E2A0 F1              10      POP AF
0011A8 E2A1 C9              10      RET
                                
       E2A2                     INTVRTC:
0011A9 E2A2 F3               4      DI
0011AA E2A3 F5              11      PUSH    AF
0011AB E2A4 CD22E2          17      CALL    CHKEY
0011AE E2A7 FE00             7      CP  0
       E2A8                     KEYDT   EQU $-1
0011B0 E2A9 202F            12      JR  NZ,SETKEY1
0011B2 E2AB 3E3E             7      LD  A,03EH      ;LD A,?
0011B4 E2AD 32DBE2          13      LD  (SETKEY1_SWC),A
0011B7 E2B0 E5              11      PUSH    HL
0011B8 E2B1 2A90EE          16      LD  HL,(_KEYPS)
0011BB E2B4 7C               4      LD  A,H
0011BC E2B5 AD               4      XOR L
0011BD E2B6 E1              10      POP HL
0011BE E2B7 2013            12      JR  NZ,ENDKEY
0011C0 E2B9 3E00             7      LD  A,0
       E2BA                     KEYAR   EQU $-1
0011C2 E2BB B7               4      OR  A
0011C3 E2BC 2016            12      JR  NZ,ARWKEY
       E2BE                     SETKEY:
0011C5 E2BE 32BAE2          13      LD  (KEYAR),A
0011C8 E2C1 3A92EE          13      LD  A,(_KEYD)
0011CB E2C4 32A8E2          13      LD  (KEYDT),A
0011CE E2C7 CDE2E2          17      CALL    KEYSET
0011D1 E2CA 3E                      DB  03EH        ;LD A,?
       E2CB                     INTE88:
0011D2 E2CB F5              11      PUSH    AF
       E2CC                     ENDKEY:
0011D3 E2CC 3AB7EE          13      LD  A,(WKE4)
0011D6 E2CF D3E4            11      OUT (0E4H),A
0011D8 E2D1 F1              10      POP AF
0011D9 E2D2 FB               4      EI
0011DA E2D3 C9              10      RET
       E2D4                     ARWKEY:
0011DB E2D4 3D               4      DEC A
0011DC E2D5 32BAE2          13      LD  (KEYAR),A
0011DF E2D8 18F2            12      JR  ENDKEY
       E2DA                     SETKEY1:
0011E1 E2DA B7               4      OR  A
       E2DB                     SETKEY1_SWC:
0011E2 E2DB 20EF            12      JR  NZ,ENDKEY
0011E4 E2DD 3A95EE          13      LD  A,(_KEYSP_H)
0011E7 E2E0 18DC            12      JR  SETKEY
                                
       E2E2                     KEYSET:
       E2E2                     KEYBS:
0011E9 E2E2 B7               4      OR  A
0011EA E2E3 C8              11      RET Z
       E2E4                     KEYBS1:
0011EB E2E4 CDFFE2          17      CALL    KEYBC_IFBREAK
0011EE E2E7 E5              11      PUSH    HL
0011EF E2E8 F5              11      PUSH    AF
0011F0 E2E9 2A90EE          16      LD  HL,(_KEYPS)
0011F3 E2EC 2C               4      INC L
0011F4 E2ED CBAD             8      RES 5,L
0011F6 E2EF 7D               4      LD  A,L
0011F7 E2F0 BC               4      CP  H
0011F8 E2F1 2818            12      JR  Z,POP_AF_HL_SCF_RET
0011FA E2F3 3290EE          13      LD  (_KEYPS),A
0011FD E2F6 C610             7      ADD A,LOW KEYBF
0011FF E2F8 6F               4      LD  L,A
001200 E2F9 26ED             7      LD  H,HIGH KEYBF
001202 E2FB F1              10      POP AF
001203 E2FC 77               7      LD  (HL),A
001204 E2FD E1              10      POP HL
001205 E2FE C9              10      RET
       E2FF                     KEYBC_IFBREAK:
001206 E2FF FE03             7      CP  3
001208 E301 C0              11      RET NZ
       E302                     KEYBC:
001209 E302 E5              11      PUSH    HL
00120A E303 210000          10      LD  HL,0
00120D E306 2290EE          16      LD  (_KEYPS),HL
001210 E309 E1              10      POP HL
001211 E30A C9              10      RET
                                
       E30B                     POP_AF_HL_SCF_RET:
001212 E30B F1              10      POP AF
001213 E30C E1              10      POP HL
001214 E30D 37               4      SCF
001215 E30E C9              10      RET
                                
       E30F                     _SYS01:     ;(BDOS)コンソール入力
001216 E30F CD09EE          17      CALL    _SYS07
       E312                     MSG_A:
001219 E312 F5              11      PUSH    AF
00121A E313 D5              11      PUSH    DE
00121B E314 5F               4      LD  E,A
00121C E315 CD1BE3          17      CALL    _SYS02
00121F E318 D1              10      POP DE
001220 E319 F1              10      POP AF
001221 E31A C9              10      RET
                                
       E31B                     _SYS02:     ;(BDOS)コンソール出力
001222 E31B CD2DE3          17      CALL    BREAK
001225 E31E 1805            12      JR  PRINTX
                                
       E320                     _SYS06:     ;(BDOS)コンソール直接入出力
001227 E320 7B               4      LD  A,E
001228 E321 3C               4      INC A
001229 E322 CACAEE          10      JP  Z,_INKEY
       E325                     PRINTX:
00122C E325 C3CDEE          10      JP  _PRINT
                                
       E328                     _SYS08:     ;(BDOS)エコーなしコンソール入力
00122F E328 CD09EE          17      CALL    _SYS07
001232 E32B 1804            12      JR  BREAK1
       E32D                     BREAK:
001234 E32D FB               4      EI
001235 E32E 3A92EE          13      LD  A,(_KEYD)
       E331                     BREAK1:
001238 E331 FE03             7      CP  3       ;CTRL+C
00123A E333 CCF4EE          17      CALL    Z,_BREAK
00123D E336 FE13             7      CP  013H        ;CTRL+S
00123F E338 C0              11      RET NZ
                                
       E339                     PAUSE:
001240 E339 CD02E3          17      CALL    KEYBC
                                
       E33C                     FLGET:
001243 E33C CDDFEE          17      CALL    _FFLUSH
001246 E33F E5              11      PUSH    HL
001247 E340 2A8EEE          16      LD  HL,(_TXADR)
00124A E343 CD97E1          17      CALL    CURSOR_ON
       E346                     FLGET1:
00124D E346 CDCAEE          17      CALL    _INKEY
001250 E349 28FB            12      JR  Z,FLGET1
001252 E34B CDA8E1          17      CALL    CURSOR_OFF
001255 E34E E1              10      POP HL
001256 E34F C9              10      RET
                                
       E350                     _SYS0B:     ;(BDOS)コンソール状態のチェック
001257 E350 CD2DE3          17      CALL    BREAK
00125A E353 3A92EE          13      LD  A,(_KEYD)
00125D E356 B7               4      OR  A
00125E E357 C8              11      RET Z
       E358                     CONSTX:
00125F E358 CDDFEE          17      CALL    _FFLUSH
001262 E35B E5              11      PUSH    HL
001263 E35C 2A90EE          16      LD  HL,(_KEYPS)
001266 E35F 7C               4      LD  A,H
001267 E360 AD               4      XOR L
001268 E361 E1              10      POP HL
001269 E362 C6FF             7      ADD A,0FFH
00126B E364 9F               4      SBC A,A
00126C E365 C9              10      RET
                                
                                ;------------------------
                                ;BCDの10進数化
                                ;in
                                ;   A  : BCD
                                ;out
                                ;   A  : 10進数
                                ;------------------------
       E366                     BCD:
00126D E366 4F               4      LD  C,A
00126E E367 E6F0             7      AND 0F0H    ;10の位
001270 E369 0F               4      RRCA
001271 E36A 47               4      LD  B,A
001272 E36B 0F               4      RRCA
001273 E36C 0F               4      RRCA
001274 E36D 80               4      ADD A,B
001275 E36E 47               4      LD  B,A
001276 E36F 79               4      LD  A,C
001277 E370 E60F             7      AND 00FH    ;1の位
001279 E372 80               4      ADD A,B
00127A E373 C9              10      RET
[EOF:88IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E374                     _SYS26:     ;(BDOS)ランダムブロック書き込み
00127B E374 AF               4      XOR A
00127C E375 325DE6          13      LD  (DRDN1),A   ;NOP
00127F E378 22EAF5          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
001282 E37B 225DEE          16      LD  (LEFTX),HL
001285 E37E CDF3F0          17      CALL    SETDRV
                                
001288 E381 CDE7E4          17      CALL    RBX0
00128B E384 DA11E4          10      JP  C,RBWERR
00128E E387 CD7CF4          17      CALL    WOPEN
001291 E38A DA11E4          10      JP  C,RBWERR
001294 E38D 7C               4      LD  A,H
001295 E38E B5               4      OR  L
001296 E38F CA0AE4          10      JP  Z,RBW1
                                
001299 E392 2B               6      DEC HL
                                
00129A E393 CDBBF5          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
00129D E396 19              11      ADD HL,DE       ;BCHL=HL+BCDE
00129E E397 3001            12      JR  NC,S26X1    ;
0012A0 E399 03               6      INC BC      ;
       E39A                     S26X1:
0012A1 E39A CDE7F4          17      CALL    RWXR
0012A4 E39D DC8DF4          17      CALL    C,WRDFX
0012A7 E3A0 DA11E4          10      JP  C,RBWERR
                                
0012AA E3A3 CD16E5          17      CALL    RBX2
0012AD E3A6 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
0012AF E3A8 CD35E5          17      CALL    RBXA
0012B2 E3AB 3864            12      JR  C,RBWERR
0012B4 E3AD EB               4      EX  DE,HL
0012B5 E3AE C5              11      PUSH    BC
0012B6 E3AF EDB0                    LDIR
0012B8 E3B1 225FEE          16      LD  (DTAX),HL
                                
0012BB E3B4 CD1EF4          17      CALL    WTDB        ;バッファデータは更新された
                                
0012BE E3B7 2A5DEE          16      LD  HL,(LEFTX)
0012C1 E3BA D1              10      POP DE
0012C2 E3BB ED52            15      SBC HL,DE
0012C4 E3BD 225DEE          16      LD  (LEFTX),HL
0012C7 E3C0 2831            12      JR  Z,RBWEND
                                
       E3C2                     RBWB:
0012C9 E3C2 CD6AE5          17      CALL    RBXB
0012CC E3C5 2814            12      JR  Z,RBWC
       E3C7                     RBWB1:
0012CE E3C7 C5              11      PUSH    BC
0012CF E3C8 D5              11      PUSH    DE
0012D0 E3C9 CDFBF2          17      CALL    CLUSTX
0012D3 E3CC CD8EE5          17      CALL    DWTC
0012D6 E3CF D1              10      POP DE
0012D7 E3D0 C1              10      POP BC
0012D8 E3D1 D4DFE7          17      CALL    NC,GNCLX
0012DB E3D4 383B            12      JR  C,RBWERR
0012DD E3D6 10EF            13      DJNZ    RBWB1
0012DF E3D8 CDDEE5          17      CALL    DRW_FLUSH
       E3DB                     RBWC:
0012E2 E3DB CD82E5          17      CALL    RBXC
0012E5 E3DE 2813            12      JR  Z,RBWEND
0012E7 E3E0 C5              11      PUSH    BC
0012E8 E3E1 CDFBF2          17      CALL    CLUSTX
0012EB E3E4 CD5CE6          17      CALL    DRDN
0012EE E3E7 C1              10      POP BC
0012EF E3E8 3827            12      JR  C,RBWERR
0012F1 E3EA ED5B7EEF        20      LD  DE,(_DTBUF)
0012F5 E3EE EDB0                    LDIR
0012F7 E3F0 CD1EF4          17      CALL    WTDB        ;バッファデータは更新された
       E3F3                     RBWEND:
0012FA E3F3 CDE9F5          17      CALL    RBXEND
                                
0012FD E3F6 CDF6E4          17      CALL    RBX1
001300 E3F9 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
001302 E3FB CDBBF5          17      CALL    GET_RR_BCDE ;BCDE=Random record
001305 E3FE FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
001308 E401 FD7211          19      LD  (IY+17),D   ;
00130B E404 FD7112          19      LD  (IY+18),C   ;
00130E E407 FD7013          19      LD  (IY+19),B   ;
       E40A                     RBW1:
001311 E40A FDE1            14      POP IY
001313 E40C C1              10      POP BC
001314 E40D D1              10      POP DE
001315 E40E E1              10      POP HL
       E40F                     DD_NUL:
001316 E40F AF               4      XOR A
       E410                     DRDF0:
       E410                     DWTF0:
001317 E410 C9              10      RET
                                
       E411                     RBWERR:
001318 E411 FDE5            15      PUSH    IY
00131A E413 D1              10      POP DE
00131B E414 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
00131D E416 CD9FDD          17      CALL    BDOS0
       E419                     RBRERR1:
001320 E419 3E01             7      LD  A,001H
       E41B                     RBRERR2:
001322 E41B FDE1            14      POP IY
001324 E41D C1              10      POP BC
001325 E41E D1              10      POP DE
001326 E41F E1              10      POP HL
001327 E420 37               4      SCF
001328 E421 210000          10      LD  HL,0
00132B E424 C9              10      RET
                                
       E425                     RBRERR:
00132C E425 3EFF             7      LD  A,0FFH
00132E E427 18F2            12      JR  RBRERR2
                                
       E429                     RBRFL:
001330 E429 3E00             7  RBRFLP: LD  A,000H
001332 E42B FE0D             7      CP  00DH
001334 E42D 2005            12      JR  NZ,RBRFL1
001336 E42F D5              11      PUSH    DE
001337 E430 1E0A             7      LD  E,00AH
001339 E432 1805            12      JR  RBRFL2
       E434                     RBRFL1:
00133B E434 D5              11      PUSH    DE
00133C E435 CD09EE          17      CALL    _SYS07
00133F E438 5F               4      LD  E,A
       E439                     RBRFL2:
001340 E439 CDCDEE          17      CALL    _PRINT
001343 E43C 7B               4      LD  A,E
001344 E43D D1              10      POP DE
001345 E43E 322AE4          13      LD  (RBRFLP+1),A
001348 E441 C9              10      RET
                                
                                                ;Read random block
       E442                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001349 E442 225DEE          16      LD  (LEFTX),HL
00134C E445 CDF3F0          17      CALL    SETDRV
                                
00134F E448 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
001353 E44C C2D5E4          10      JP  NZ,RBRDIR   ;ディレクトリ
001356 E44F CDE7E4          17      CALL    RBX0
001359 E452 DA25E4          10      JP  C,RBRERR
00135C E455 CDF6E4          17      CALL    RBX1
00135F E458 D40EE5          17      CALL    NC,RBX1R
001362 E45B DA19E4          10      JP  C,RBRERR1
001365 E45E EB               4      EX  DE,HL
001366 E45F ED52            15      SBC HL,DE       ;CP 00HL,BCDE
001368 E461 19              11      ADD HL,DE
001369 E462 79               4      LD  A,C
00136A E463 DE00             7      SBC A,0
00136C E465 78               4      LD  A,B
00136D E466 DE00             7      SBC A,0
00136F E468 3801            12      JR  C,RBR1
001371 E46A EB               4      EX  DE,HL
       E46B                     RBR1:
001372 E46B 9F               4      SBC A,A
001373 E46C E601             7      AND 1
001375 E46E 32D3E4          13      LD  (RBRA_SWC),A
                                
001378 E471 7C               4      LD  A,H
001379 E472 B5               4      OR  L
00137A E473 2857            12      JR  Z,RBREND0
                                
00137C E475 22EAF5          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
00137F E478 225DEE          16      LD  (LEFTX),HL
                                
001382 E47B CD16E5          17      CALL    RBX2
001385 E47E 2819            12      JR  Z,RBRB
001387 E480 CD35E5          17      CALL    RBXA
00138A E483 DA25E4          10      JP  C,RBRERR
00138D E486 C5              11      PUSH    BC
00138E E487 EDB0                    LDIR
001390 E489 ED535FEE        20      LD  (DTAX),DE
001394 E48D 2A5DEE          16      LD  HL,(LEFTX)
001397 E490 D1              10      POP DE
001398 E491 A7               4      AND A
001399 E492 ED52            15      SBC HL,DE
00139B E494 225DEE          16      LD  (LEFTX),HL
00139E E497 2830            12      JR  Z,RBREND
                                
       E499                     RBRB:
0013A0 E499 CD6AE5          17      CALL    RBXB
0013A3 E49C 2815            12      JR  Z,RBRC
       E49E                     RBRB1:
0013A5 E49E C5              11      PUSH    BC
0013A6 E49F D5              11      PUSH    DE
0013A7 E4A0 CDFBF2          17      CALL    CLUSTX
0013AA E4A3 CD94E5          17      CALL    DRDC
0013AD E4A6 D1              10      POP DE
0013AE E4A7 C1              10      POP BC
0013AF E4A8 D4DFE7          17      CALL    NC,GNCLX
0013B2 E4AB DA25E4          10      JP  C,RBRERR
0013B5 E4AE 10EE            13      DJNZ    RBRB1
0013B7 E4B0 CDDEE5          17      CALL    DRW_FLUSH
       E4B3                     RBRC:
0013BA E4B3 CD82E5          17      CALL    RBXC
0013BD E4B6 2811            12      JR  Z,RBREND
0013BF E4B8 C5              11      PUSH    BC
0013C0 E4B9 CDFBF2          17      CALL    CLUSTX
0013C3 E4BC CD40E6          17      CALL    DRDX
0013C6 E4BF C1              10      POP BC
0013C7 E4C0 DA25E4          10      JP  C,RBRERR
0013CA E4C3 EB               4      EX  DE,HL
0013CB E4C4 2A7EEF          16      LD  HL,(_DTBUF)
0013CE E4C7 EDB0                    LDIR
       E4C9                     RBREND:
0013D0 E4C9 CDE9F5          17      CALL    RBXEND
       E4CC                     RBREND0:
0013D3 E4CC FDE1            14      POP IY
0013D5 E4CE C1              10      POP BC
0013D6 E4CF D1              10      POP DE
0013D7 E4D0 F1              10      POP AF  ;(HL)
0013D8 E4D1 AF               4      XOR A
0013D9 E4D2 3E00             7      LD  A,000H
       E4D3                     RBRA_SWC    EQU $-1
0013DB E4D4 C9              10      RET
                                
       E4D5                     RBRDIR:
0013DC E4D5 FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0013DF E4D8 FD661B          19      LD  H,(IY+27)
0013E2 E4DB CD3AF3          17      CALL    CHDIR
0013E5 E4DE AF               4      XOR A
0013E6 E4DF 67               4      LD  H,A
0013E7 E4E0 6F               4      LD  L,A
0013E8 E4E1 3C               4      INC A
0013E9 E4E2 32D3E4          13      LD  (RBRA_SWC),A
0013EC E4E5 18E5            12      JR  RBREND0
                                ;(15)
       E4E7                     RBX0:
0013EE E4E7 2A8AEE          16      LD  HL,(_DTA)
0013F1 E4EA 225FEE          16      LD  (DTAX),HL
0013F4 E4ED 2A5DEE          16      LD  HL,(LEFTX)
0013F7 E4F0 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0013FA E4F3 D6FD             7      SUB 0FDH
0013FC E4F5 C9              10      RET
                                
       E4F6                     RBX1:               ;ファイルサイズとランダムレコードを比べる
0013FD E4F6 E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
0013FE E4F7 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
001401 E4FA FD6611          19      LD  H,(IY+17)   ;
001404 E4FD FD7E12          19      LD  A,(IY+18)   ;
                                
001407 E500 CDBBF5          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
00140A E503 A7               4      AND A
00140B E504 ED52            15      SBC HL,DE
00140D E506 99               4      SBC A,C
00140E E507 4F               4      LD  C,A
00140F E508 FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
001412 E50B 98               4      SBC A,B
001413 E50C D1              10      POP DE
001414 E50D C9              10      RET
       E50E                     RBX1R:              ;(8)
001415 E50E 47               4      LD  B,A
001416 E50F B1               4      OR  C
001417 E510 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
001418 E511 B2               4      OR  D
001419 E512 B3               4      OR  E
00141A E513 C0              11      RET NZ
00141B E514 37               4      SCF
00141C E515 C9              10      RET
                                
       E516                     RBX2:               ;Cluster settings
00141D E516 FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001420 E519 FD4E23          19      LD  C,(IY+35)
001423 E51C 0600             7      LD  B,0
001425 E51E FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001429 E522 2003            12      JR  NZ,RBX3
00142B E524 FD4624          19      LD  B,(IY+36)
       E527                     RBX3:
00142E E527 CDE7F4          17      CALL    RWXR
001431 E52A 3A4CE5          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001434 E52D 3D               4      DEC A
001435 E52E FDA622          19      AND (IY+34)
001438 E531 FDB621          19      OR  (IY+33)
00143B E534 C9              10      RET
                                
       E535                     RBXA:
00143C E535 C5              11      PUSH    BC
00143D E536 D5              11      PUSH    DE
00143E E537 CDFBF2          17      CALL    CLUSTX
001441 E53A CD40E6          17      CALL    DRDX
001444 E53D D1              10      POP DE
001445 E53E C1              10      POP BC
001446 E53F D4DFE7          17      CALL    NC,GNCLX
001449 E542 D8              11      RET C
00144A E543 ED53FEEF        20      LD  (_CLPS),DE
                                
00144E E547 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
001451 E54A 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       E54B                     SECSZ   EQU $-2
       E54C                     SECSZ_H EQU $-1
001454 E54D 7C               4      LD  A,H
001455 E54E 3D               4      DEC A       ;1024=3 / 512=1
001456 E54F FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
001459 E552 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
00145A E553 ED42            15      SBC HL,BC       ;残りを計算
                                
00145C E555 ED5B5DEE        20      LD  DE,(LEFTX)
001460 E559 ED52            15      SBC HL,DE       ;CP HL,DE
001462 E55B 19              11      ADD HL,DE       ;
001463 E55C 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
001465 E55E EB               4      EX  DE,HL
       E55F                     RBXA1:
001466 E55F E5              11      PUSH    HL
001467 E560 2A7EEF          16      LD  HL,(_DTBUF)
00146A E563 09              11      ADD HL,BC
00146B E564 ED5B5FEE        20      LD  DE,(DTAX)
00146F E568 C1              10      POP BC
001470 E569 C9              10      RET
                                
       E56A                     RBXB:
001471 E56A 2A5FEE          16      LD  HL,(DTAX)
001474 E56D ED5BFEEF        20      LD  DE,(_CLPS)
001478 E571 3A5EEE          13      LD  A,(LEFTX+1)
00147B E574 47               4      LD  B,A
00147C E575 3A4CE5          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E578                     RBXB1:
00147F E578 1F               4      RRA     ;->CF
001480 E579 3804            12      JR  C,RBXB2
001482 E57B CB38             8      SRL B   ;B=B/2
001484 E57D 18F9            12      JR  RBXB1
       E57F                     RBXB2:
001486 E57F 78               4      LD  A,B
001487 E580 B7               4      OR  A
001488 E581 C9              10      RET
                                ;(12)
       E582                     RBXC:
001489 E582 ED4B5DEE        20      LD  BC,(LEFTX)
00148D E586 3A4CE5          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001490 E589 3D               4      DEC A
001491 E58A A0               4      AND B
001492 E58B 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
001493 E58C B1               4      OR  C
001494 E58D C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E58E                     DWTC:
001495 E58E E5              11      PUSH    HL
001496 E58F 2178E9          10      LD  HL,DWT24B
001499 E592 1804            12      JR  DWTC1
       E594                     DRDC:
00149B E594 E5              11      PUSH    HL
00149C E595 216AE9          10      LD  HL,DRD24B
       E598                     DWTC1:
00149F E598 22F2E5          16      LD  (DRWF_MODE),HL
0014A2 E59B E1              10      POP HL
0014A3 E59C 3AE2E5          13      LD  A,(DRWF_B)
0014A6 E59F B7               4      OR  A
0014A7 E5A0 200F            12      JR  NZ,DRDC1
       E5A2                     SAVE_DRWC:
0014A9 E5A2 0601             7      LD  B,1
0014AB E5A4 ED43E1E5        20      LD  (DRWF_C),BC
0014AF E5A8 ED53E8E5        20      LD  (DRWF_E),DE
0014B3 E5AC 22EBE5          16      LD  (DRWF_HL),HL
0014B6 E5AF 1820            12      JR  INC_HL_DRWC
       E5B1                     DRDC1:
0014B8 E5B1 E5              11      PUSH    HL
0014B9 E5B2 21E8E5          10      LD  HL,DRWF_E
0014BC E5B5 86               7      ADD A,(HL)
0014BD E5B6 F5              11      PUSH    AF
0014BE E5B7 BB               4      CP  E
0014BF E5B8 201D            12      JR  NZ,DRDC2
0014C1 E5BA F1              10      POP AF
0014C2 E5BB 23               6      INC HL
0014C3 E5BC 7E               7      LD  A,(HL)
0014C4 E5BD CE00             7      ADC A,0
0014C6 E5BF F5              11      PUSH    AF
0014C7 E5C0 BA               4      CP  D
0014C8 E5C1 2014            12      JR  NZ,DRDC2
0014CA E5C3 F1              10      POP AF
0014CB E5C4 3AE1E5          13      LD  A,(DRWF_C)
0014CE E5C7 CE00             7      ADC A,0
0014D0 E5C9 B9               4      CP  C
0014D1 E5CA 200C            12      JR  NZ,DRDC3
0014D3 E5CC 21E2E5          10      LD  HL,DRWF_B
0014D6 E5CF 34              11      INC (HL)
0014D7 E5D0 E1              10      POP HL
       E5D1                     INC_HL_DRWC:
0014D8 E5D1 3A4CE5          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
0014DB E5D4 84               4      ADD A,H
0014DC E5D5 67               4      LD  H,A
0014DD E5D6 C9              10      RET
       E5D7                     DRDC2:
0014DE E5D7 F1              10      POP AF
       E5D8                     DRDC3:
0014DF E5D8 CDDEE5          17      CALL    DRW_FLUSH
0014E2 E5DB E1              10      POP HL
0014E3 E5DC 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E5DE                     DRW_FLUSH:
0014E5 E5DE C5              11      PUSH    BC
0014E6 E5DF D5              11      PUSH    DE
0014E7 E5E0 010000          10      LD  BC,0
       E5E1                     DRWF_C  EQU $-2
       E5E2                     DRWF_B  EQU $-1
0014EA E5E3 78               4      LD  A,B
0014EB E5E4 B7               4      OR  A
0014EC E5E5 280D            12      JR  Z,DRDF1
0014EE E5E7 110000          10      LD  DE,0
       E5E8                     DRWF_E  EQU $-2
       E5E9                     DRWF_D  EQU $-1
0014F1 E5EA 210000          10      LD  HL,0
       E5EB                     DRWF_HL EQU $-2
0014F4 E5ED AF               4      XOR A
0014F5 E5EE 32E2E5          13      LD  (DRWF_B),A
0014F8 E5F1 CD6AE9          17      CALL    DRD24B
       E5F2                     DRWF_MODE   EQU $-2
       E5F4                     DRDF1:
0014FB E5F4 D1              10      POP DE
0014FC E5F5 C1              10      POP BC
0014FD E5F6 C9              10      RET
                                
       E5F7                     RB_WRITE:
0014FE E5F7 C5              11      PUSH    BC
0014FF E5F8 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
001501 E5FA 1803            12      JR  RBRW
       E5FC                     RB_READ:
001503 E5FC C5              11      PUSH    BC
001504 E5FD 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       E5FF                     RBRW:
001506 E5FF 1F               4      RRA     ;AHL = AHL*128
001507 E600 7C               4      LD  A,H ;AHL = AHL0/2
001508 E601 1F               4      RRA     ;A
001509 E602 65               4      LD  H,L ;
00150A E603 CB1C             8      RR  H   ;H
00150C E605 2E00             7      LD  L,0 ;
00150E E607 CB1D             8      RR  L   ;L
001510 E609 CDA0F5          17      CALL    SET_RR_AHL
001513 E60C 218000          10      LD  HL,128
001516 E60F C5              11      PUSH    BC
       E610                     SETSEQ_SWC_RND:
001517 E610 CDCFF5          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
00151A E613 C1              10      POP BC
00151B E614 FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
00151F E618 FDE5            15      PUSH    IY
001521 E61A D1              10      POP DE
001522 E61B D5              11      PUSH    DE
001523 E61C CD9FDD          17      CALL    BDOS0
001526 E61F FDE1            14      POP IY
001528 E621 CDAAF5          17      CALL    SETSEQ      ;SETSEQ or POPRR
       E622                     SETSEQ_SWC_SEQ_RR   EQU $-2
00152B E624 FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
00152F E628 C1              10      POP BC
001530 E629 C9              10      RET
                                
                                ;(22)
       E62A                     INIT_SEQ:
001531 E62A 3E01             7      LD  A,1     ;LD BC,????
001533 E62C 21AAF5          10      LD  HL,SETSEQ
001536 E62F CD70F5          17      CALL    PUSHRR
       E632                     GETSEQ:
001539 E632 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
00153C E635 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
00153F E638 AF               4      XOR A
                                
001540 E639 CB25             8      SLA L   ;L=L*2
                                
001542 E63B CB3C             8      SRL H   ;HL=HL/2
001544 E63D CB1D             8      RR  L   ;
001546 E63F C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E640                     DRDX:
001547 E640 CD7EE6          17      CALL    DRDY
00154A E643 C8              11      RET Z
00154B E644 CD64E6          17      CALL    DRDX1       ;データバッファの情報を保存
00154E E647 D8              11      RET C
00154F E648 E5              11      PUSH    HL
001550 E649 C5              11      PUSH    BC
001551 E64A D5              11      PUSH    DE
001552 E64B 2A7EEF          16      LD  HL,(_DTBUF)
001555 E64E 3AA7E6          13      LD  A,(_DBS24)
001558 E651 4F               4      LD  C,A
001559 E652 CD68E9          17      CALL    DRD24
00155C E655 DC79E6          17      CALL    C,DRDNE
       E658                     POP_DE_BC_HL_RET:
00155F E658 D1              10      POP DE
001560 E659 C1              10      POP BC
001561 E65A E1              10      POP HL
001562 E65B C9              10      RET
                                
                                ;   CDE:セクタ番号
       E65C                     DRDN:
001563 E65C AF               4      XOR A
001564 E65D 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
001565 E65E 30E0            12      JR  NC,DRDX
       E660                     DRDNX:
001567 E660 CD7EE6          17      CALL    DRDY
00156A E663 C8              11      RET Z
       E664                     DRDX1:
00156B E664 CD94E6          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
00156E E667 ED53A6EE        20      LD  (_DBSEC),DE
001572 E66B 79               4      LD  A,C
001573 E66C 32A7E6          13      LD  (_DBS24),A
                                
001576 E66F 3A88EE          13      LD  A,(_DRV)
001579 E672 32A5EE          13      LD  (_DBDRV),A
00157C E675 CDD9EE          17      CALL    _CHGDRV
00157F E678 D0              11      RET NC
       E679                     DRDNE:
001580 E679 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001581 E67A 32A5EE          13      LD  (_DBDRV),A
001584 E67D C9              10      RET
                                
                                ;   CDE:セクタ番号
       E67E                     DRDY:
001585 E67E 3AA7E6          13      LD  A,(_DBS24)
001588 E681 B9               4      CP  C
001589 E682 C0              11      RET NZ
                                
00158A E683 E5              11      PUSH    HL
00158B E684 3A88EE          13      LD  A,(_DRV)
00158E E687 21A5EE          10      LD  HL,_DBDRV
001591 E68A AE               7      XOR (HL)
001592 E68B 2005            12      JR  NZ,POP_HL_RET
                                
001594 E68D 2AA6EE          16      LD  HL,(_DBSEC)
001597 E690 ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E692                     POP_HL_RET:
001599 E692 E1              10      POP HL
00159A E693 C9              10      RET
                                
       E694                     DWTX:
00159B E694 3AA4EE          13      LD  A,(_WTDBF)
00159E E697 B7               4      OR  A
00159F E698 C8              11      RET Z
0015A0 E699 AF               4      XOR A
0015A1 E69A 32A4EE          13      LD  (_WTDBF),A
                                
0015A4 E69D E5              11      PUSH    HL
0015A5 E69E C5              11      PUSH    BC
0015A6 E69F D5              11      PUSH    DE
0015A7 E6A0 3AA5EE          13      LD  A,(_DBDRV)
0015AA E6A3 CDD9EE          17      CALL    _CHGDRV
0015AD E6A6 0E00             7      LD  C,0
       E6A7                     _DBS24  EQU $-1
0015AF E6A8 ED5BA6EE        20      LD  DE,(_DBSEC)
0015B3 E6AC 2A7EEF          16      LD  HL,(_DTBUF)
0015B6 E6AF D476E9          17      CALL    NC,DWT24
       E6B2                     POP_DE_BC_HL_RET2:
0015B9 E6B2 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E6B4                     RDFATX:
0015BB E6B4 E5              11      PUSH    HL
0015BC E6B5 3A88EE          13      LD  A,(_DRV)
0015BF E6B8 21AAEE          10      LD  HL,_FATDRV
0015C2 E6BB AE               7      XOR (HL)
0015C3 E6BC 28D4            12      JR  Z,POP_HL_RET
                                
0015C5 E6BE C5              11      PUSH    BC
0015C6 E6BF D5              11      PUSH    DE
0015C7 E6C0 DDE5            15      PUSH    IX
0015C9 E6C2 CDDEE6          17      CALL    WTFATX
0015CC E6C5 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
0015CE E6C7 AF               4      XOR A
0015CF E6C8 32ABEE          13      LD  (_FATIX),A
0015D2 E6CB 3A88EE          13      LD  A,(_DRV)
0015D5 E6CE 32AAEE          13      LD  (_FATDRV),A
0015D8 E6D1 CDE5EE          17      CALL    _RDFAT
       E6D4                     RDFATE2:
0015DB E6D4 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
0015DD E6D6 9F               4      SBC A,A     ;A=0xFF
0015DE E6D7 32AAEE          13      LD  (_FATDRV),A
       E6DA                     POP_IX_DE_BC_HL_RET:
0015E1 E6DA DDE1            14      POP IX
0015E3 E6DC 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E6DE                     WTFATX:
0015E5 E6DE 3AA2EE          13      LD  A,(_WTFATF)
0015E8 E6E1 B7               4      OR  A
0015E9 E6E2 C8              11      RET Z
0015EA E6E3 AF               4      XOR A
0015EB E6E4 32A2EE          13      LD  (_WTFATF),A
                                
0015EE E6E7 E5              11      PUSH    HL
0015EF E6E8 3AAAEE          13      LD  A,(_FATDRV)
0015F2 E6EB 21A5EE          10      LD  HL,_DBDRV
0015F5 E6EE AE               7      XOR (HL)
0015F6 E6EF CC94E6          17      CALL    Z,DWTX
0015F9 E6F2 389E            12      JR  C,POP_HL_RET
0015FB E6F4 C5              11      PUSH    BC
0015FC E6F5 D5              11      PUSH    DE
0015FD E6F6 DDE5            15      PUSH    IX
0015FF E6F8 CD87E9          17      CALL    FATSETUP
001602 E6FB D478E9          17      CALL    NC,DWT24B
001605 E6FE 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E700                     N16CL1:
001607 E700 7A               4      LD  A,D
001608 E701 B3               4      OR  E
001609 E702 37               4      SCF
00160A E703 C8              11      RET Z
                                
00160B E704 7A               4      LD  A,D
00160C E705 1807            12      JR  NCL1X
       E707                     NCL1:
00160E E707 7A               4      LD  A,D
00160F E708 B3               4      OR  E
001610 E709 37               4      SCF
001611 E70A C8              11      RET Z
                                
001612 E70B 7A               4      LD  A,D
001613 E70C CB3F             8      SRL A   ;/2
       E70E                     NCL1X:
001615 E70E CB3F             8      SRL A   ;/2
                                
001617 E710 E5              11      PUSH    HL
001618 E711 3230E7          13      LD  (NCLPAT_FATIX),A    ;_FATIX
00161B E714 2AAAEE          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
00161E E717 BC               4      CP  H
00161F E718 3A88EE          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001622 E71B 322FE7          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001625 E71E 2005            12      JR  NZ,NCL2     ;FATIXが違う
001627 E720 BD               4      CP  L
001628 E721 2002            12      JR  NZ,NCL2     ;ドライブが違う
00162A E723 E1              10      POP HL
00162B E724 C9              10      RET
       E725                     NCL2:
00162C E725 C5              11      PUSH    BC
00162D E726 D5              11      PUSH    DE
00162E E727 DDE5            15      PUSH    IX
001630 E729 CDDEE6          17      CALL    WTFATX
001633 E72C 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
001635 E72E 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E730                     NCLPAT_FATIX    EQU $-1
       E72F                     NCLPAT_FATDRV   EQU $-2
001638 E731 ED43AAEE        20      LD  (_FATDRV),BC
00163C E735 CD5CE9          17      CALL    RDFATS
00163F E738 189A            12      JR  RDFATE2
                                
       E73A                     NCL3:
001641 E73A CB9A             8      RES 3,D
001643 E73C CB92             8      RES 2,D
001645 E73E 6B               4      LD  L,E
001646 E73F 62               4      LD  H,D
001647 E740 CB3C             8      SRL H   ;
001649 E742 CB1D             8      RR  L   ;HLA=HLA/2
00164B E744 1F               4      RRA     ;
00164C E745 F5              11      PUSH    AF
00164D E746 3AABEE          13      LD  A,(_FATIX)
001650 E749 0F               4      RRCA
001651 E74A 300B            12      JR  NC,NCL3X1
001653 E74C 3A4CE5          13      LD  A,(SECSZ_H)
001656 E74F FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの際に先頭を512バイトずらす
001658 E751 2004            12      JR  NZ,NCL3X1
00165A E753 010002          10      LD  BC,512
00165D E756 09              11      ADD HL,BC
       E757                     NCL3X1:
00165E E757 F1              10      POP AF
00165F E758 ED4B7CEF        20      LD  BC,(_FATBF)
001663 E75C 19              11      ADD HL,DE
001664 E75D 09              11      ADD HL,BC
001665 E75E 17               4      RLA
001666 E75F C9              10      RET
                                
       E760                     GNCL:
001667 E760 CD07E7          17      CALL    NCL1        ;GET NEXT CLUSTER
00166A E763 D8              11      RET C
00166B E764 C5              11      PUSH    BC
00166C E765 E5              11      PUSH    HL
00166D E766 CD3AE7          17      CALL    NCL3
001670 E769 3809            12      JR  C,GNC1
001672 E76B 5E               7      LD  E,(HL)
001673 E76C 23               6      INC HL
001674 E76D 7E               7      LD  A,(HL)
001675 E76E E60F             7      AND 00FH
001677 E770 57               4      LD  D,A
001678 E771 E1              10      POP HL
001679 E772 C1              10      POP BC
00167A E773 C9              10      RET
       E774                     GNC1:
00167B E774 7E               7      LD  A,(HL)
00167C E775 23               6      INC HL
00167D E776 56               7      LD  D,(HL)
00167E E777 0604             7      LD  B,4
       E779                     GNC1L:
001680 E779 CB3A             8      SRL D   ;DA=DA/2
001682 E77B 1F               4      RRA     ;
001683 E77C 10FB            13      DJNZ    GNC1L
                                
001685 E77E 5F               4      LD  E,A
001686 E77F E1              10      POP HL
001687 E780 C1              10      POP BC
001688 E781 A7               4      AND A
001689 E782 C9              10      RET
                                
       E783                     SNCL:
00168A E783 CD07E7          17      CALL    NCL1
00168D E786 D8              11      RET C
                                ;               SET NEXT CLUSTER
00168E E787 E5              11      PUSH    HL
00168F E788 C5              11      PUSH    BC
001690 E789 D5              11      PUSH    DE
001691 E78A E5              11      PUSH    HL
001692 E78B CD3AE7          17      CALL    NCL3
001695 E78E D1              10      POP DE
                                ;CF=ODD
001696 E78F 7E               7      LD  A,(HL)
001697 E790 73               7      LD  (HL),E
001698 E791 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
00169A E793 23               6      INC HL
00169B E794 ED67            18      RRD     ;M={A[3:0],E[3:0]}
00169D E796 7A               4      LD  A,D
00169E E797 1804            12      JR  SNC11
       E799                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
0016A0 E799 ED6F            18      RLD     ;M={D[3:0],E[7:4]}
0016A2 E79B 23               6      INC HL
0016A3 E79C 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E79D                     SNC11:
0016A4 E79D ED6F            18      RLD     ;M={M[7:4],D[3:0]}
0016A6 E79F B7               4      OR  A
0016A7 E7A0 D1              10      POP DE
0016A8 E7A1 C1              10      POP BC
0016A9 E7A2 E1              10      POP HL
       E7A3                     FAT_CHANGED:
0016AA E7A3 3EFF             7      LD  A,0FFH
0016AC E7A5 32A2EE          13      LD  (_WTFATF),A
0016AF E7A8 C9              10      RET
                                
       E7A9                     N16CL3:
0016B0 E7A9 C5              11      PUSH    BC
0016B1 E7AA 6B               4      LD  L,E
0016B2 E7AB 7A               4      LD  A,D
0016B3 E7AC E601             7      AND 1
0016B5 E7AE 67               4      LD  H,A
0016B6 E7AF 29              11      ADD HL,HL
0016B7 E7B0 ED4B7CEF        20      LD  BC,(_FATBF)
0016BB E7B4 09              11      ADD HL,BC
0016BC E7B5 C1              10      POP BC
0016BD E7B6 C9              10      RET
                                
       E7B7                     GNCL16:
0016BE E7B7 CD00E7          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
0016C1 E7BA D8              11      RET C
0016C2 E7BB E5              11      PUSH    HL
0016C3 E7BC CDA9E7          17      CALL    N16CL3
0016C6 E7BF 5E               7      LD  E,(HL)
0016C7 E7C0 23               6      INC HL
0016C8 E7C1 56               7      LD  D,(HL)
0016C9 E7C2 E1              10      POP HL
0016CA E7C3 C9              10      RET
                                
       E7C4                     SNCL16:
0016CB E7C4 CD00E7          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
0016CE E7C7 D8              11      RET C
0016CF E7C8 D5              11      PUSH    DE
0016D0 E7C9 E5              11      PUSH    HL
0016D1 E7CA CDA9E7          17      CALL    N16CL3
0016D4 E7CD D1              10      POP DE      ;HL
0016D5 E7CE 73               7      LD  (HL),E
0016D6 E7CF 23               6      INC HL
0016D7 E7D0 72               7      LD  (HL),D
0016D8 E7D1 6B               4      LD  L,E
0016D9 E7D2 62               4      LD  H,D
0016DA E7D3 D1              10      POP DE
0016DB E7D4 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E7D6                     NEXTX:
0016DD E7D6 3E00             7      LD  A,0 ;自己書き換え
       E7D7                     _SECPS  EQU $-1
0016DF E7D8 3C               4      INC A
0016E0 E7D9 E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E7DA                     _NCPAT  EQU $-1
0016E2 E7DB 32D7E7          13      LD  (_SECPS),A
0016E5 E7DE C9              10      RET
                                
       E7DF                     GNCLX:
0016E6 E7DF CDD6E7          17      CALL    NEXTX
0016E9 E7E2 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
0016EA E7E3 C3F7EE          10      JP  _GNCL   ;次のクラスタを探す
                                
       E7E6                     RDFAT:
0016ED E7E6 3E80             7      LD  A,080H
0016EF E7E8 3270EE          13      LD  (CHECK),A
       E7EB                     RDFAT1:
0016F2 E7EB 3A88EE          13      LD  A,(_DRV)
0016F5 E7EE CD90EA          17      CALL    CHGDRVR
0016F8 E7F1 D8              11      RET C
0016F9 E7F2 DD7E12          19      LD  A,(IX+DPB_DEVICE)
0016FC E7F5 CB6F             8      BIT 5,A
0016FE E7F7 286E            12      JR  Z,RDFAT0X
001700 E7F9 2170EE          10      LD  HL,CHECK
001703 E7FC A6               7      AND (HL)
001704 E7FD 77               7      LD  (HL),A
001705 E7FE 110000          10      LD  DE,0        ;BPB
001708 E801 2A7CEF          16      LD  HL,(_FATBF)
00170B E804 0E00             7      LD  C,0
00170D E806 CD68E9          17      CALL    DRD24
001710 E809 3022            12      JR  NC,GETBPB
001712 E80B 2170EE          10      LD  HL,CHECK
001715 E80E CB06            15      RLC (HL)
001717 E810 3F               4      CCF
001718 E811 D8              11      RET C
001719 E812 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
00171D E816 3F               4      CCF         ;フロッピーディスクのFDモード(2D/2HD)を切り替える
00171E E817 DDCB0A16        23      RL  (IX+DPB_FDMODE)
001722 E81B 3A84EE          13      LD  A,(_DRIVE)
001725 E81E E603             7      AND 3
001727 E820 F680             7      OR  080H
001729 E822 6F               4      LD  L,A
00172A E823 26EE             7      LD  H,_CYL0/256
00172C E825 3EFF             7      LD  A,0FFH
00172E E827 3289EE          13      LD  (_DSK),A
001731 E82A 77               7      LD  (HL),A
001732 E82B 18BE            12      JR  RDFAT1
       E82D                     GETBPB:
001734 E82D FDE5            15      PUSH    IY
001736 E82F FD2A7CEF        20      LD  IY,(_FATBF) ;BPB
00173A E833 CDF1EE          17      CALL    _BPB2DPB
00173D E836 FDE1            14      POP IY
00173F E838 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001742 E83B 3027            12      JR  NC,GETBPBOK
001744 E83D E60F             7      AND 00FH
001746 E83F FE07             7      CP  7
001748 E841 37               4      SCF
001749 E842 C0              11      RET NZ
00174A E843 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
00174E E847 21C0EF          10      LD  HL,M2D
001751 E84A 2008            12      JR  NZ,SETFDMODE
001753 E84C 2E04             7      LD  L,4
001755 E84E CD51E9          17      CALL    CHECK_MAXSECSZ
001758 E851 D8              11      RET C
001759 E852 2ED2             7      LD  L,M2HD-STABLE
       E854                     SETFDMODE:
00175B E854 DDE5            15      PUSH    IX
00175D E856 D1              10      POP DE
00175E E857 EDA0            16      LDI
001760 E859 EDA0            16      LDI
001762 E85B 13               6      INC DE
001763 E85C 13               6      INC DE
001764 E85D 13               6      INC DE
001765 E85E 13               6      INC DE
001766 E85F 010C00          10      LD  BC,12
001769 E862 EDB0                    LDIR
       E864                     GETBPBOK:
00176B E864 CDFCE9          17      CALL    CHGDRV2
       E867                     RDFAT0X:
00176E E867 CD5CE9          17      CALL    RDFATS
001771 E86A D8              11      RET C
001772 E86B DDAE06          19      XOR (IX+DPB_FATID)
001775 E86E C8              11      RET Z
001776 E86F DD7E12          19      LD  A,(IX+DPB_DEVICE)
001779 E872 CB5F             8      BIT 3,A
00177B E874 2803            12      JR  Z,RDFAT0X1
00177D E876 CB6F             8      BIT 5,A
00177F E878 C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E879                     RDFAT0X1:
001780 E879 37               4      SCF
001781 E87A C9              10      RET
                                
       E87B                     POP_HL_SCF_RET:
001782 E87B E1              10      POP HL
001783 E87C 37               4      SCF
001784 E87D C9              10      RET
                                
       E87E                     BPB2DPB:
001785 E87E FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
001788 E881 B7               4      OR  A
001789 E882 37               4      SCF
00178A E883 C0              11      RET NZ
       E884                     BPBOK:
00178B E884 FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
00178E E887 DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001791 E88A FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001794 E88D DD7700          19      LD  (IX+DPB_FATLN),A
001797 E890 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
00179A E893 DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
00179D E896 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
0017A0 E899 FD660F          19      LD  H,(IY+15)
0017A3 E89C DD750E          19      LD  (IX+DPB_FATPS),L
0017A6 E89F FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
0017A9 E8A2 FD5617          19      LD  D,(IY+23)
0017AC E8A5 FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E8A8                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
0017AF E8A8 19              11      ADD HL,DE
0017B0 E8A9 10FD            13      DJNZ    BPBDP1
       E8AB                     BPBDP2:
0017B2 E8AB DD7510          19      LD  (IX+DPB_DIRPS),L
0017B5 E8AE DD7411          19      LD  (IX+DPB_DIRPS+1),H
0017B8 E8B1 E5              11      PUSH    HL
                                
0017B9 E8B2 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
0017BC E8B5 FD6612          19      LD  H,(IY+18)
0017BF E8B8 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
0017C2 E8BB B7               4      OR  A
0017C3 E8BC 28BD            12      JR  Z,POP_HL_SCF_RET
0017C5 E8BE 0606             7      LD  B,6
       E8C0                     BPBBPS1:
0017C7 E8C0 05               4      DEC B
0017C8 E8C1 0F               4      RRCA
0017C9 E8C2 30FC            12      JR  NC,BPBBPS1
       E8C4                     BPBDE1:
0017CB E8C4 29              11      ADD HL,HL
0017CC E8C5 10FD            13      DJNZ    BPBDE1
                                
0017CE E8C7 7C               4      LD  A,H
0017CF E8C8 DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
0017D2 E8CB D1              10      POP DE      ;DPB_DIRPS
0017D3 E8CC 6C               4      LD  L,H
0017D4 E8CD 2600             7      LD  H,0
0017D6 E8CF 19              11      ADD HL,DE       ;MAXDIR
0017D7 E8D0 E5              11      PUSH    HL
0017D8 E8D1 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
0017DB E8D4 CB21             8      SLA C       ;*2
0017DD E8D6 AF               4      XOR A
0017DE E8D7 47               4      LD  B,A
0017DF E8D8 ED42            15      SBC HL,BC
0017E1 E8DA DD7514          19      LD  (IX+DPB_ADDCL),L
0017E4 E8DD DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
0017E7 E8E0 D1              10      POP DE      ;DE=DPB_MAXDIR
0017E8 E8E1 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
0017EB E8E4 FD6614          19      LD  H,(IY+20)
                                
0017EE E8E7 DD7E12          19      LD  A,(IX+DPB_DEVICE)
0017F1 E8EA E60F             7      AND 00FH
0017F3 E8EC FE07             7      CP  7       ;フロッピー
0017F5 E8EE 2019            12      JR  NZ,NOT_FD
0017F7 E8F0 E5              11      PUSH    HL
0017F8 E8F1 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
0017FB E8F4 DD710D          19      LD  (IX+DPB_MAXSEC),C
0017FE E8F7 AF               4      XOR A
0017FF E8F8 CB21             8      SLA C       ;両面なのでセクタ数を２倍
001801 E8FA 0610             7      LD  B,16
       E8FC                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001803 E8FC 29              11      ADD HL,HL
001804 E8FD 17               4      RLA
001805 E8FE B9               4      CP  C
001806 E8FF 3802            12      JR  C,DIVSEC1
001808 E901 91               4      SUB C
001809 E902 2C               4      INC L
       E903                     DIVSEC1:
00180A E903 10F7            13      DJNZ    DIVSEC
00180C E905 DD750C          19      LD  (IX+DPB_MAXCYL),L
00180F E908 E1              10      POP HL  ;ここまでフロッピー専用
       E909                     NOT_FD:
001810 E909 7C               4      LD  A,H
001811 E90A B5               4      OR  L
001812 E90B 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001814 E90D 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001816 E90F 2F               4      CPL         ;A=0FFH
001817 E910 FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
00181A E913 D8              11      RET C
00181B E914 FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
00181E E917 FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001821 E91A FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E91D                     BPB16BIT:
001824 E91D ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001826 E91F DE00             7      SBC A,0
001828 E921 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E924                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
00182B E924 CB18             8      RR  B       ;->CY
00182D E926 3808            12      JR  C,BPBTC2
00182F E928 CB3F             8      SRL A
001831 E92A CB1C             8      RR  H       ;AHL=AHL/2
001833 E92C CB1D             8      RR  L
001835 E92E 18F4            12      JR  BPBTC1
       E930                     BPBTC2:
001837 E930 C6FF             7      ADD A,0FFH
001839 E932 D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
00183A E933 23               6      INC HL
00183B E934 23               6      INC HL
00183C E935 DD7508          19      LD  (IX+DPB_MAXCL),L
00183F E938 DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001842 E93B FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001845 E93E DD7706          19      LD  (IX+DPB_FATID),A
                                
001848 E941 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
00184B E944 C6FE             7      ADD A,0-2       ;>2:CF=1
00184D E946 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001850 E949 6F               4      LD  L,A
001851 E94A 3002            12      JR  NC,BPBFAT1
001853 E94C F680             7      OR  080H
       E94E                     BPBFAT1:            ;ここではCF=0
001855 E94E DD770F          19      LD  (IX+DPB_BPS),A
       E951                     CHECK_MAXSECSZ:
001858 E951 3A7BEF          13      LD  A,(_MAX_SEC_SZ_H)
00185B E954 BD               4      CP  L
00185C E955 C8              11      RET Z       ;1セクタ1024バイト
00185D E956 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
00185E E957 C8              11      RET Z       ;1セクタ256バイト
00185F E958 2D               4      DEC L
001860 E959 C8              11      RET Z       ;1セクタ512バイト
001861 E95A 37               4      SCF
001862 E95B C9              10      RET
                                
       E95C                     RDFATS:
001863 E95C CD87E9          17      CALL    FATSETUP
001866 E95F D8              11      RET C
001867 E960 CD6AE9          17      CALL    DRD24B
00186A E963 2A7CEF          16      LD  HL,(_FATBF)
00186D E966 7E               7      LD  A,(HL)
00186E E967 C9              10      RET
                                
       E968                     DRD24:
00186F E968 0601             7      LD  B,1
       E96A                     DRD24B:
001871 E96A DDE5            15      PUSH    IX
001873 E96C DD2AA8EE        20      LD  IX,(_DPB)
001877 E970 CD21EC          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E971                     DRDPAT  EQU $-2
00187A E973 DDE1            14      POP IX
00187C E975 C9              10      RET
                                
       E976                     DWT24:
00187D E976 0601             7      LD  B,1
       E978                     DWT24B:
00187F E978 DDE5            15      PUSH    IX
001881 E97A DD2AA8EE        20      LD  IX,(_DPB)
001885 E97E CD89EB          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E97F                     DWTPAT  EQU $-2
001888 E981 DDE1            14      POP IX
00188A E983 D0              11      RET NC
00188B E984 C35AEE          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E987                     FATSETUP:
00188E E987 3AAAEE          13      LD  A,(_FATDRV)
001891 E98A CD90EA          17      CALL    CHGDRVR     ;ドライブ切り替え
001894 E98D D8              11      RET C
       E98E                     FATS2:
001895 E98E DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001898 E991 0F               4      RRCA
001899 E992 CDC2E9          17      CALL    FATSETUP12  ;自己書き換え
       E993                     FATSX   EQU $-2
00189C E995 210000          10      LD  HL,0
00189F E998 4A               4      LD  C,D
0018A0 E999 54               4      LD  D,H
0018A1 E99A 3AABEE          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
0018A4 E99D 47               4      LD  B,A
0018A5 E99E 04               4      INC B
0018A6 E99F DD7E00          19      LD  A,(IX+DPB_FATLN)
       E9A2                     FAT_SKP:
0018A9 E9A2 05               4      DEC B
0018AA E9A3 2809            12      JR  Z,FAT1
0018AC E9A5 19              11      ADD HL,DE
0018AD E9A6 93               4      SUB E
0018AE E9A7 30F9            12      JR  NC,FAT_SKP
0018B0 E9A9 DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
0018B4 E9AD C8              11      RET Z
       E9AE                     FAT1:
0018B5 E9AE EB               4      EX  DE,HL
0018B6 E9AF B7               4      OR  A       ;0の場合は0100Hとして扱う
0018B7 E9B0 2803            12      JR  Z,FAT3
0018B9 E9B2 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
0018BA E9B3 3801            12      JR  C,FAT2
       E9B5                     FAT3:
0018BC E9B5 79               4      LD  A,C
       E9B6                     FAT2:
0018BD E9B6 47               4      LD  B,A
                                
0018BE E9B7 2AFAEF          16      LD  HL,(_FATPS) ;fat sector pos
0018C1 E9BA 19              11      ADD HL,DE
0018C2 E9BB EB               4      EX  DE,HL
0018C3 E9BC 2A7CEF          16      LD  HL,(_FATBF)
0018C6 E9BF AF               4      XOR A       ;CF=0
0018C7 E9C0 4F               4      LD  C,A
0018C8 E9C1 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E9C2                     FATSETUP12:
0018C9 E9C2 110606          10      LD  DE,0606H    ;256
0018CC E9C5 D8              11      RET C
0018CD E9C6 110303          10      LD  DE,0303H    ;512
0018D0 E9C9 0F               4      RRCA
0018D1 E9CA D8              11      RET C
0018D2 E9CB 110102          10      LD  DE,0201H    ;1024
0018D5 E9CE C9              10      RET
                                
       E9CF                     FATSETUP16:
0018D6 E9CF 110404          10      LD  DE,0404H    ;256
0018D9 E9D2 D8              11      RET C
0018DA E9D3 110202          10      LD  DE,0202H    ;512
0018DD E9D6 0F               4      RRCA
0018DE E9D7 D8              11      RET C
0018DF E9D8 110101          10      LD  DE,0101H    ;1024
0018E2 E9DB C9              10      RET
                                
       E9DC                     CHGDRV:
0018E3 E9DC E5              11      PUSH    HL
0018E4 E9DD 2189EE          10      LD  HL,_DSK
0018E7 E9E0 BE               7      CP  (HL)
0018E8 E9E1 280A            12      JR  Z,CHGDRVE
       E9E3                     CHGDRV1:
0018EA E9E3 DDE5            15      PUSH    IX
0018EC E9E5 CDEFE9          17      CALL    CHGDRV0
0018EF E9E8 3A89EE          13      LD  A,(_DSK)
0018F2 E9EB DDE1            14      POP IX
       E9ED                     CHGDRVE:
0018F4 E9ED E1              10      POP HL
0018F5 E9EE C9              10      RET
                                
       E9EF                     CHGDRV0:
0018F6 E9EF 6F               4      LD  L,A
0018F7 E9F0 CDDCEE          17      CALL    _GETDPB
0018FA E9F3 D8              11      RET C
0018FB E9F4 DD22A8EE        20      LD  (_DPB),IX
0018FF E9F8 7D               4      LD  A,L
001900 E9F9 3289EE          13      LD  (_DSK),A
       E9FC                     CHGDRV2:
001903 E9FC C5              11      PUSH    BC
001904 E9FD D5              11      PUSH    DE
001905 E9FE ED7347EA        20      LD  (SPPAT2),SP
001909 EA02 F3               4      DI
00190A EA03 DDF9            10      LD  SP,IX
                                
00190C EA05 E1              10      POP HL      ;00:DPB_FATLN
00190D EA06 E1              10      POP HL      ;02:DPB_DRD
00190E EA07 2271E9          16      LD  (DRDPAT),HL
                                
001911 EA0A E1              10      POP HL
001912 EA0B 227FE9          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001915 EA0E E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001916 EA0F 7C               4      LD  A,H
001917 EA10 32FFF2          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
00191A EA13 3D               4      DEC A
00191B EA14 32DAE7          13      LD  (_NCPAT),A
                                
00191E EA17 E1              10      POP HL      ;08:DPB_MAXCL
00191F EA18 7D               4      LD  A,L
001920 EA19 321EF3          13      LD  (CLPAT2),A
001923 EA1C 7C               4      LD  A,H
001924 EA1D 321AF3          13      LD  (CLPAT1),A
001927 EA20 2B               6      DEC HL
001928 EA21 221DF5          16      LD  (MAXCLP),HL
                                
00192B EA24 E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
00192C EA25 4C               4      LD  C,H
                                
00192D EA26 E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
00192E EA27 E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
00192F EA28 7C               4      LD  A,H     ;DPB_BPS
001930 EA29 E607             7      AND 7
001932 EA2B 324CE5          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001935 EA2E 87               4      ADD A,A     ;8  4   2
001936 EA2F 87               4      ADD A,A     ;010H   8   4
001937 EA30 87               4      ADD A,A     ;020H   010H    8
001938 EA31 327DF1          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
00193B EA34 2600             7      LD  H,0
00193D EA36 22FAEF          16      LD  (_FATPS),HL
                                
001940 EA39 E1              10      POP HL      ;10:DPB_DIRPS
001941 EA3A 22FCEF          16      LD  (_DIRPS),HL
                                
001944 EA3D E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001945 EA3E 7C               4      LD  A,H
001946 EA3F 3284EE          13      LD  (_DRIVE),A
                                
001949 EA42 E1              10      POP HL      ;14:DPB_ADDCL
00194A EA43 220FF3          16      LD  (CLSPAT),HL
                                
00194D EA46 310000          10      LD  SP,0        ;元のSPを復元
       EA47                     SPPAT2  EQU $-2
001950 EA49 FB               4      EI
001951 EA4A 2AFCEF          16      LD  HL,(_DIRPS)
001954 EA4D 0600             7      LD  B,0
001956 EA4F 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001957 EA50 2298F1          16      LD  (MD_PAT),HL
                                
00195A EA53 2A1DF5          16      LD  HL,(MAXCLP)
00195D EA56 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001960 EA59 19              11      ADD HL,DE
001961 EA5A 380F            12      JR  C,SETFAT16
001963 EA5C 2160E7          10      LD  HL,GNCL     ;FAT12
001966 EA5F 1183E7          10      LD  DE,SNCL
001969 EA62 01C2E9          10      LD  BC,FATSETUP12
00196C EA65 DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001970 EA69 180D            12      JR  EXTRA1
       EA6B                     SETFAT16:
001972 EA6B 21B7E7          10      LD  HL,GNCL16   ;FAT16
001975 EA6E 11C4E7          10      LD  DE,SNCL16
001978 EA71 01CFE9          10      LD  BC,FATSETUP16
00197B EA74 DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       EA78                     EXTRA1:
00197F EA78 22F8EE          16      LD  (GNCPAT),HL
001982 EA7B ED53FBEE        20      LD  (SNCPAT),DE
001986 EA7F ED4393E9        20      LD  (FATSX),BC
00198A EA83 D1              10      POP DE
00198B EA84 C1              10      POP BC
00198C EA85 AF               4      XOR A
00198D EA86 C9              10      RET
                                
       EA87                     GETDPBD:
00198E EA87 DDE3            23      EX  (SP),IX
001990 EA89 DDE5            15      PUSH    IX
001992 EA8B 3A88EE          13      LD  A,(_DRV)
001995 EA8E 1807            12      JR  GETDPB1
                                
       EA90                     CHGDRVR:
001997 EA90 CDD9EE          17      CALL    _CHGDRV
00199A EA93 D8              11      RET C
00199B EA94 3A89EE          13      LD  A,(_DSK)
       EA97                     GETDPB1:
00199E EA97 C3DCEE          10      JP  _GETDPB
                                
       EA9A                     GETDPB:
0019A1 EA9A FE08             7      CP  8
0019A3 EA9C 3F               4      CCF
0019A4 EA9D D8              11      RET C
0019A5 EA9E 0F               4      RRCA
0019A6 EA9F 0F               4      RRCA
0019A7 EAA0 0F               4      RRCA
0019A8 EAA1 DD                      DB  0DDH        ;Z80未定義命令
0019A9 EAA2 6F               4      LD  L,A     ;LD IXL,A
0019AA EAA3 DD                      DB  0DDH        ;Z80未定義命令
0019AB EAA4 26F6             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
0019AD EAA6 DD7E00          19      LD  A,(IX+DPB_FATLN)
0019B0 EAA9 A7               4      AND A       ;CF=0の為
0019B1 EAAA DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
0019B5 EAAE C0              11      RET NZ      ;FAT16
0019B6 EAAF DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
0019BA EAB3 C0              11      RET NZ      ;BPB
0019BB EAB4 FE01             7      CP  001H        ;A=0 THEN CF=1
0019BD EAB6 C9              10      RET
                                
       EAB7                     _SYS5F:
0019BE EAB7 AF               4      XOR A
       EAB8                     FFLUSH:
0019BF EAB8 F5              11      PUSH    AF
0019C0 EAB9 CDDEE6          17      CALL    WTFATX
0019C3 EABC AF               4      XOR A
0019C4 EABD 32ABEE          13      LD  (_FATIX),A
0019C7 EAC0 2F               4      CPL         ;0FFH
0019C8 EAC1 32AAEE          13      LD  (_FATDRV),A
0019CB EAC4 3E                      DB  03EH        ;次のPUSH AFをスキップ
       EAC5                     FFLUSHBUF:
0019CC EAC5 F5              11      PUSH    AF
0019CD EAC6 CD94E6          17      CALL    DWTX
0019D0 EAC9 3EFF             7      LD  A,0FFH
0019D2 EACB 3239EE          13      LD  (SFILE),A
0019D5 EACE 32A5EE          13      LD  (_DBDRV),A
0019D8 EAD1 F1              10      POP AF
0019D9 EAD2 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "88DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   PC-8801mkIISR
                                
                                ;   FLOPPY DISK DRIVER
                                ;
       EAD3                     PUTCOM_EXECUTE:
0019DA EAD3 3E0D             7      LD  A,0DH       ;エグゼキュート
                                ;   コマンド送信
       EAD5                     PUTCOM:
0019DC EAD5 F5              11      PUSH    AF
0019DD EAD6 3E0F             7      LD  A,00FH
0019DF EAD8 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
0019E1 EADA F1              10      POP AF
                                ;   通常ハンドシェイク（ホストが送信）
       EADB                     PUTDAT:
0019E2 EADB F5              11      PUSH    AF
       EADC                     PUTDAT1:
0019E3 EADC DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
0019E5 EADE E602             7      AND 2       ;RFD
0019E7 EAE0 28FA            12      JR  Z,PUTDAT1
0019E9 EAE2 3E0E             7      LD  A,00EH      ;ATN=0
0019EB EAE4 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
0019ED EAE6 F1              10      POP AF
0019EE EAE7 D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
0019F0 EAE9 F5              11      PUSH    AF
0019F1 EAEA 3E09             7      LD  A,9     ;DAV=1
0019F3 EAEC D3FF            11      OUT (0FFH),A
       EAEE                     PUTDAT2:
0019F5 EAEE DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
0019F7 EAF0 E604             7      AND 4       ;DAC
0019F9 EAF2 28FA            12      JR  Z,PUTDAT2
                                
0019FB EAF4 3E08             7      LD  A,8     ;DAV=0
0019FD EAF6 D3FF            11      OUT (0FFH),A
       EAF8                     PUTDAT3:
0019FF EAF8 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A01 EAFA E604             7      AND 4       ;DAC
001A03 EAFC 20FA            12      JR  NZ,PUTDAT3
001A05 EAFE F1              10      POP AF
001A06 EAFF C9              10      RET
                                
                                ;   通常ハンドシェイク（ホストが受信）
       EB00                     GETDAT:
001A07 EB00 3E0B             7      LD  A,00BH      ;RFD=1
001A09 EB02 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
       EB04                     GETDAT1:
001A0B EB04 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A0D EB06 0F               4      RRCA            ;DAV
001A0E EB07 30FB            12      JR  NC,GETDAT1
                                
001A10 EB09 3E0A             7      LD  A,00AH      ;RFD=0
001A12 EB0B D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001A14 EB0D DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001A16 EB0F F5              11      PUSH    AF
001A17 EB10 3E0D             7      LD  A,00DH      ;DAC=1
001A19 EB12 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
       EB14                     GETDAT2:
001A1B EB14 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A1D EB16 0F               4      RRCA            ;DAV
001A1E EB17 38FB            12      JR  C,GETDAT2
                                
001A20 EB19 3E0C             7      LD  A,00CH      ;DAC=0
001A22 EB1B D3FF            11      OUT (0FFH),A
001A24 EB1D F1              10      POP AF
001A25 EB1E C9              10      RET
                                
                                ;   高速ハンドシェイク（ホストが送信）
                                ;   HL:アドレス BC:受信サイズ（必ず偶数にする）
       EB1F                     FPUTDAT:
       EB1F                     FPUTDAT1:
001A26 EB1F DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A28 EB21 E602             7      AND 2       ;RFD
001A2A EB23 28FA            12      JR  Z,FPUTDAT1
001A2C EB25 3E0E             7      LD  A,00EH      ;ATN=0
001A2E EB27 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001A30 EB29 7E               7      LD  A,(HL)
001A31 EB2A D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
                                
001A33 EB2C 3E09             7      LD  A,9     ;DAV=1
001A35 EB2E D3FF            11      OUT (0FFH),A
001A37 EB30 23               6      INC HL
001A38 EB31 0B               6      DEC BC
       EB32                     FPUTDAT2:
001A39 EB32 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A3B EB34 E604             7      AND 4       ;DAC
001A3D EB36 28FA            12      JR  Z,FPUTDAT2
                                
001A3F EB38 7E               7      LD  A,(HL)
001A40 EB39 D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
                                
001A42 EB3B 3E08             7      LD  A,8     ;DAV=0
001A44 EB3D D3FF            11      OUT (0FFH),A
       EB3F                     FPUTDAT3:
001A46 EB3F DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A48 EB41 E604             7      AND 4       ;DAC
001A4A EB43 20FA            12      JR  NZ,FPUTDAT3
                                
001A4C EB45 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001A4E EB47 E0              11      RET PO
001A4F EB48 18D5            12      JR  FPUTDAT
                                
                                
                                ;   高速ハンドシェイク（ホストが受信）
                                ;   HL:アドレス BC:受信サイズ（必ず偶数にする）
       EB4A                     FGETDAT:
001A51 EB4A 3E0B             7      LD  A,00BH      ;RFD=1
001A53 EB4C D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
       EB4E                     FGETDAT1:
001A55 EB4E DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A57 EB50 0F               4      RRCA            ;DAV
001A58 EB51 30FB            12      JR  NC,FGETDAT1
                                
001A5A EB53 3E0A             7      LD  A,00AH      ;RFD=0
001A5C EB55 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001A5E EB57 DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001A60 EB59 77               7      LD  (HL),A
                                
001A61 EB5A 3E0D             7      LD  A,00DH      ;DAC=1
001A63 EB5C D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
001A65 EB5E 23               6      INC HL
001A66 EB5F 0B               6      DEC BC
       EB60                     FGETDAT2:
001A67 EB60 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A69 EB62 0F               4      RRCA            ;DAV
001A6A EB63 38FB            12      JR  C,FGETDAT2
                                
001A6C EB65 DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001A6E EB67 77               7      LD  (HL),A
                                
001A6F EB68 3E0C             7      LD  A,00CH      ;DAC=0
001A71 EB6A D3FF            11      OUT (0FFH),A
                                
001A73 EB6C EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001A75 EB6E E0              11      RET PO
001A76 EB6F 18D9            12      JR  FGETDAT
                                
                                ;   論理セクタ番号からトラック番号とセクタ番号を得る
                                ;   in
                                ;   DE:論理セクタ
       EB71                     CALC_SECTOR:
001A78 EB71 C5              11      PUSH    BC
001A79 EB72 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001A7C EB75 0610             7      LD  B,16
001A7E EB77 AF               4      XOR A
001A7F EB78 EB               4      EX  DE,HL
       EB79                     DIV1:
001A80 EB79 29              11      ADD HL,HL
001A81 EB7A 8F               4      ADC A,A
001A82 EB7B B9               4      CP  C
001A83 EB7C 3802            12      JR  C,DIV2
001A85 EB7E 91               4      SUB C
001A86 EB7F 2C               4      INC L
       EB80                     DIV2:
001A87 EB80 10F7            13      DJNZ    DIV1
                                
001A89 EB82 3C               4      INC A   ;最小のセクタは１固定
001A8A EB83 55               4      LD  D,L ;TRACK
       EB84                     DIV3:
001A8B EB84 5F               4      LD  E,A ;SECTOR
001A8C EB85 C1              10      POP BC
001A8D EB86 C9              10      RET
                                
       EB87                     WTTRK:
001A8E EB87 37               4      SCF
001A8F EB88 C9              10      RET
       EB89                     FDWT:
001A90 EB89 E5              11      PUSH    HL
001A91 EB8A D5              11      PUSH    DE
001A92 EB8B CD71EB          17      CALL    CALC_SECTOR
001A95 EB8E 7A               4      LD  A,D     ;トラック
001A96 EB8F 32EDEB          13      LD  (FDWT_TRACK),A
001A99 EB92 7B               4      LD  A,E     ;セクタ
001A9A EB93 32E8EB          13      LD  (FDWT_SECTOR),A
001A9D EB96 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001AA0 EB99 93               4      SUB E
001AA1 EB9A 3C               4      INC A
001AA2 EB9B 67               4      LD  H,A
001AA3 EB9C D1              10      POP DE
001AA4 EB9D 3A4CE5          13      LD  A,(SECSZ_H) ;1セクタのサイズの上位1バイト
001AA7 EBA0 4F               4      LD  C,A
001AA8 EBA1 AF               4      XOR A
       EBA2                     FDWT2:
001AA9 EBA2 81               4      ADD A,C
001AAA EBA3 13               6      INC DE
001AAB EBA4 05               4      DEC B
001AAC EBA5 2807            12      JR  Z,FDWT3
001AAE EBA7 25               4      DEC H       ;トラック、ヘッドを跨がない
001AAF EBA8 2804            12      JR  Z,FDWT3
001AB1 EBAA FE3A             7      CP  03AH        ;バッファとして04000H-07BFFHまで使える
001AB3 EBAC 38F4            12      JR  C,FDWT2
       EBAE                     FDWT3:
001AB5 EBAE 4F               4      LD  C,A
001AB6 EBAF E1              10      POP HL
001AB7 EBB0 3E16             7      LD  A,16H       ;高速レシーブメモリ
001AB9 EBB2 CDD5EA          17      CALL    PUTCOM
001ABC EBB5 3E40             7      LD  A,HIGH DSS_DATA ;開始アドレスH
001ABE EBB7 CDDBEA          17      CALL    PUTDAT
001AC1 EBBA AF               4      XOR A       ;開始アドレスL
001AC2 EBBB CDDBEA          17      CALL    PUTDAT
001AC5 EBBE 79               4      LD  A,C     ;バイト数H
001AC6 EBBF CDDBEA          17      CALL    PUTDAT
001AC9 EBC2 AF               4      XOR A       ;バイト数L
001ACA EBC3 CDDBEA          17      CALL    PUTDAT
001ACD EBC6 C5              11      PUSH    BC
001ACE EBC7 41               4      LD  B,C
001ACF EBC8 0E00             7      LD  C,0
001AD1 EBCA CD1FEB          17      CALL    FPUTDAT
001AD4 EBCD C1              10      POP BC
001AD5 EBCE CDD3EA          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001AD8 EBD1 3E7C             7      LD  A,HIGH WRITEDISKEX
001ADA EBD3 CDDBEA          17      CALL    PUTDAT
001ADD EBD6 3EB1             7      LD  A,LOW WRITEDISKEX
001ADF EBD8 CDDBEA          17      CALL    PUTDAT
001AE2 EBDB DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
001AE5 EBDE CDDBEA          17      CALL    PUTDAT
001AE8 EBE1 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001AEB EBE4 CDDBEA          17      CALL    PUTDAT
001AEE EBE7 3E00             7      LD  A,0     ;セクタ
       EBE8                     FDWT_SECTOR EQU $-1
001AF0 EBE9 CDDBEA          17      CALL    PUTDAT
001AF3 EBEC 3E00             7      LD  A,0     ;トラック
       EBED                     FDWT_TRACK  EQU $-1
001AF5 EBEE CDDBEA          17      CALL    PUTDAT
001AF8 EBF1 DD7E0A          19      LD  A,(IX+DPB_FDMODE)   ;フロッピーディスクのモード
001AFB EBF4 CDDBEA          17      CALL    PUTDAT
001AFE EBF7 3A4CE5          13      LD  A,(SECSZ_H) ;1セクタのサイズの上位1バイト
001B01 EBFA CDDBEA          17      CALL    PUTDAT
001B04 EBFD 79               4      LD  A,C
001B05 EBFE CDDBEA          17      CALL    PUTDAT      ;バイト数H
001B08 EC01 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;フロッピーディスクのシリンダ数
001B0B EC04 CDDBEA          17      CALL    PUTDAT
                                
001B0E EC07 CDD3EA          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001B11 EC0A 3E7E             7      LD  A,HIGH RESULTEX
001B13 EC0C CDDBEA          17      CALL    PUTDAT
001B16 EC0F 3E21             7      LD  A,LOW RESULTEX
001B18 EC11 CDDBEA          17      CALL    PUTDAT
                                
001B1B EC14 CD00EB          17      CALL    GETDAT
001B1E EC17 4F               4      LD  C,A
001B1F EC18 FE01             7      CP  1
001B21 EC1A D8              11      RET C
                                
001B22 EC1B 78               4      LD  A,B
001B23 EC1C B7               4      OR  A
001B24 EC1D C289EB          10      JP  NZ,FDWT
001B27 EC20 C9              10      RET
                                
       EC21                     FDRD:
001B28 EC21 CDD3EA          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001B2B EC24 3E7C             7      LD  A,HIGH READDISKEX
001B2D EC26 CDDBEA          17      CALL    PUTDAT
001B30 EC29 AF               4      XOR A
001B31 EC2A CDDBEA          17      CALL    PUTDAT
001B34 EC2D 3A7BEF          13      LD  A,(_MAX_SEC_SZ_H)
001B37 EC30 87               4      ADD A,A
001B38 EC31 DDB613          19      OR  (IX+DPB_UNITNO)     ;デバイスドライバ内におけるユニット番号
001B3B EC34 CDDBEA          17      CALL    PUTDAT
001B3E EC37 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001B41 EC3A CDDBEA          17      CALL    PUTDAT
001B44 EC3D E5              11      PUSH    HL
001B45 EC3E D5              11      PUSH    DE
001B46 EC3F CD71EB          17      CALL    CALC_SECTOR
001B49 EC42 7B               4      LD  A,E     ;セクタ
001B4A EC43 CDDBEA          17      CALL    PUTDAT
001B4D EC46 7A               4      LD  A,D     ;トラック
001B4E EC47 CDDBEA          17      CALL    PUTDAT
001B51 EC4A DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001B54 EC4D 93               4      SUB E
001B55 EC4E 3C               4      INC A
001B56 EC4F 67               4      LD  H,A
001B57 EC50 D1              10      POP DE
001B58 EC51 DD7E0A          19      LD  A,(IX+DPB_FDMODE)   ;フロッピーディスクのモード
001B5B EC54 CDDBEA          17      CALL    PUTDAT
001B5E EC57 3A4CE5          13      LD  A,(SECSZ_H) ;1セクタのサイズの上位1バイト
001B61 EC5A CDDBEA          17      CALL    PUTDAT
001B64 EC5D 4F               4      LD  C,A
001B65 EC5E AF               4      XOR A
       EC5F                     FDRD2:
001B66 EC5F 81               4      ADD A,C
001B67 EC60 13               6      INC DE
001B68 EC61 05               4      DEC B
001B69 EC62 2807            12      JR  Z,FDRD3
001B6B EC64 25               4      DEC H       ;トラック、ヘッドを跨がない
001B6C EC65 2804            12      JR  Z,FDRD3
001B6E EC67 FE3A             7      CP  03AH        ;バッファとして04000H-07BFFHまで使える
001B70 EC69 38F4            12      JR  C,FDRD2
       EC6B                     FDRD3:
001B72 EC6B E1              10      POP HL
001B73 EC6C 4F               4      LD  C,A
001B74 EC6D CDDBEA          17      CALL    PUTDAT      ;バイト数H
001B77 EC70 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;フロッピーディスクのシリンダ数
001B7A EC73 CDDBEA          17      CALL    PUTDAT
                                
001B7D EC76 CDD3EA          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001B80 EC79 3E7E             7      LD  A,HIGH RESULTEX
001B82 EC7B CDDBEA          17      CALL    PUTDAT
001B85 EC7E 3E21             7      LD  A,LOW RESULTEX
001B87 EC80 CDDBEA          17      CALL    PUTDAT
                                
001B8A EC83 CD00EB          17      CALL    GETDAT
001B8D EC86 4F               4      LD  C,A
001B8E EC87 FE01             7      CP  1
001B90 EC89 D8              11      RET C
                                
001B91 EC8A 3E15             7      LD  A,15H       ;高速センドメモリ
001B93 EC8C CDD5EA          17      CALL    PUTCOM
001B96 EC8F 3E40             7      LD  A,HIGH DSS_DATA ;開始アドレスH
001B98 EC91 CDDBEA          17      CALL    PUTDAT
001B9B EC94 AF               4      XOR A       ;開始アドレスL
001B9C EC95 CDDBEA          17      CALL    PUTDAT
001B9F EC98 79               4      LD  A,C     ;バイト数H
001BA0 EC99 CDDBEA          17      CALL    PUTDAT
001BA3 EC9C AF               4      XOR A       ;バイト数L
001BA4 EC9D CDDBEA          17      CALL    PUTDAT
001BA7 ECA0 C5              11      PUSH    BC
001BA8 ECA1 41               4      LD  B,C
001BA9 ECA2 0E00             7      LD  C,0
001BAB ECA4 CD4AEB          17      CALL    FGETDAT
001BAE ECA7 C1              10      POP BC
001BAF ECA8 78               4      LD  A,B
001BB0 ECA9 B7               4      OR  A
001BB1 ECAA C221EC          10      JP  NZ,FDRD
001BB4 ECAD C9              10      RET
                                
[EOF:88DISK.ASM:UTF_8]
                                    INCLUDE "88INTVEC.ASM"
                                
                                ;   LSX-Dodgers TABLE 割り込みベクタとI/Oルーチン
                                
001BB5 ECAE                         ALIGN   256
                                
                                ;
                                ;   割り込みベクタ:アドレス下位1バイトが0になるように
                                ;   高速RAM(0F000H-0FFFFH)と被らないようにする
                                ;
       ED00                     IRXRDY:
001C07 ED00 CBE2                    DW  INTE88
       ED02                     IVRTC:
001C09 ED02 A2E2                    DW  INTVRTC
       ED04                     ICLOCK:
001C0B ED04 CBE2                    DW  INTE88
       ED06                     IINT4:
001C0D ED06 CBE2                    DW  INTE88
       ED08                     IINT3:
001C0F ED08 CBE2                    DW  INTE88
       ED0A                     IINT2:
001C11 ED0A CBE2                    DW  INTE88
       ED0C                     IFDINT1:
001C13 ED0C CBE2                    DW  INTE88
       ED0E                     IFDINT2:
001C15 ED0E CBE2                    DW  INTE88
                                
                                ;   先行キー入力バッファ
       ED10                     KEYBF:
001C17 ED10                         DS  020H
                                
                                ;   バンク切り替え時のスタック
001C37 ED30                         DS  030H-18
       ED4E                     EXTSP:
                                
[EOF:88INTVEC.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001C55 ED4E                     PATHD:  DS  PATHX
001C90 ED89 00                  PATHE:  DB  0
                                
       ED8A                     DTA_CCP:
001C91 ED8A                         DS  37
                                
       EDAF                     FCB_BAT:
001CB6 EDAF                         DS  37
                                
001CDB EDD4 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001CE6 EDDF 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
                                ;   ALIGN   256
       EDE6                     AT_WORK:
001CED EDE6                         DS  WORKAD-AT_WORK
                                
       EE00                     CPM_BOOT:
001D07 EE00 C30000          10      JP  0
       EE03                     _SYS00:     ;(BDOS)プログラム終了
       EE03                     CPM_WBOOT:
001D0A EE03 C309D9          10      JP  WBOOT1
       EE06                     CPM_CONST:
001D0D EE06 C358E3          10      JP  CONSTX
       EE09                     _SYS07:     ;(BDOS)コンソール直接入力
       EE09                     CPM_CONIN:
001D10 EE09 C33CE3          10      JP  FLGET
       EE0C                     CPM_CONOUT:
001D13 EE0C C388E1          10      JP  CONOUT1
                                
       EE0F                     DECBF:              ;10進数表示時のバッファ(5バイト)
001D16 EE0F                         DS  5
       EE0F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       EE11                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       EE14                     FDRV:
001D1B EE14 00                      DB  0
       EE15                     FNAME:
001D1C EE15                         DS  36
       EE39                     SFILE:
001D40 EE39                         DS  33      ;DRV FILENAME
       EE5A                     _DISKE:
001D61 EE5A C362E0          10      JP  SHOW_ERROR
                                
001D64 EE5D 0000                LEFTX:  DW  0
001D66 EE5F 0000                DTAX:   DW  0
                                
                                ;   PSGのビープ音のデータ(X1)
       EE61                     BEEPD:
001D68 EE61 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
001D70 EE69 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                ;
       EE62                     RTC_YY  EQU BEEPD+1 ;RTCのバッファ年(88)
       EE63                     RTC_MW  EQU BEEPD+2 ;RTCのバッファ月(88)
       EE64                     RTC_DD  EQU BEEPD+3 ;RTCのバッファ日(88)
       EE65                     RTC_TT  EQU BEEPD+4 ;RTCのバッファ時(88)
       EE66                     RTC_MM  EQU BEEPD+5 ;RTCのバッファ分(88)
       EE67                     RTC_SS  EQU BEEPD+6 ;RTCのバッファ秒(88)
       EE62                     ROM_SLT EQU BEEPD+1 ;ROMのスロット(MSX)
       EE61                     ZERO    EQU BEEPD
                                
       EE70                     CHECK:
001D77 EE70 00                      DB  0
                                
       EE71                     OK:
001D78 EE71 4F4B24                  DB  "OK$"
001D7B EE74                         DS  5
       EE79                     COMERM:
001D80 EE79 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       EE80                     _CYL0:
001D87 EE80 FF                      DB  0FFH    ;Cylinder
       EE81                     _CYL1:
001D88 EE81 FF                      DB  0FFH    ;Cylinder
       EE82                     _CYL2:
001D89 EE82 FF                      DB  0FFH    ;Cylinder
       EE83                     _CYL3:
001D8A EE83 FF                      DB  0FFH    ;Cylinder
       EE84                     _DRIVE:
001D8B EE84 00                      DB  0   ;unit number
       EE85                     _SEEKSP:
001D8C EE85 00                      DB  0   ;Seek speed
       EE86                     _ISEEK:
001D8D EE86 32                      DB  50  ;
001D8E EE87                         DS  1
       EE88                     _DRV:
001D8F EE88 00                      DB  0
       EE89                     _DSK:
001D90 EE89 FF                      DB  0FFH
       EE8A                     _DTA:
001D91 EE8A 8000                    DW  00080H
       EE8C                     _CTC:
001D93 EE8C 0000                    DW  0
       EE8E                     _TXADR:
001D95 EE8E 0000                    DW  0
       EE90                     _KEYPS:
001D97 EE90 0000                    DW  0
       EE92                     _KEYD:
001D99 EE92 00                      DB  000H    ;キーデータ
       EE93                     _KEYST:
001D9A EE93 FF                      DB  0FFH    ;キーステータス(SHIFT,CTRLの状態)
       EE94                     _KEYSP_L:
001D9B EE94 00                      DB  KEYSP_L ;オートリピートの速度
       EE95                     _KEYSP_H:
001D9C EE95 14                      DB  KEYSP_H ;オートリピートの速度
       EE96                     _COLORF:
001D9D EE96 00                      DB  COLORF  ;色
       EE97                     _LINE:
001D9E EE97 18                      DB  LINE
                                
                                            ;次のファイルの検索(C=12)で使用するFCB
       EE98                     _FCB:
001D9F EE98 0000                    DW  0   ;SEARCH FILES
       EE9A                     _FBPS:
001DA1 EE9A 0000                    DW  0   ;    //
       EE9C                     _FBAD:
001DA3 EE9C 0000                    DW  0   ;    //
       EE9E                     _FBCNT:
001DA5 EE9E 00                      DB  0   ;    //
       EE9F                     _FILEN:
001DA6 EE9F 00                      DB  0   ;    //
       EEA0                     _DIRF:
001DA7 EEA0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
001DA8 EEA1                         DS  1
       EEA2                     _WTFATF:
001DA9 EEA2 00                      DB  0   ;FATバッファの更新フラグ
001DAA EEA3                         DS  1
       EEA4                     _WTDBF:
001DAB EEA4 00                      DB  0   ;データバッファの更新フラグ
       EEA5                     _DBDRV:
001DAC EEA5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       EEA6                     _DBSEC:
001DAD EEA6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       EEA8                     _DPB:
001DAF EEA8 0000                    DW  0
       EEAA                     _FATDRV:
001DB1 EEAA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       EEAB                     _FATIX:
001DB2 EEAB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       EEAC                     _FAKEFREE:
001DB3 EEAC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
001DB5 EEAE                         DS  2
                                ;   画面周りのデータ
       EEB0                     CRTCD:
001DB7 EEB0 6F                      DB  06FH
       EEB1                     _WIDTH:
001DB8 EEB1 50                      DB  WIDTH
       EEB2                     TVRAMTOP:
001DB9 EEB2 5938                    DB  059H,038H
001DBB EEB4 1F02                    DB  01FH,002H
       EEB6                     _LINE2:
001DBD EEB6 19                      DB  019H
       EEB7                     WKE4:
001DBE EEB7 1C                      DB  01CH
       EEB8                     WKE6:
001DBF EEB8 00                      DB  000H
       EEB9                     WK40:
001DC0 EEB9 07                      DB  007H
       EEBA                     _PAGE_MINUS:
001DC1 EEBA 80F8                    DW  0-WIDTH*LINE
       EEBC                     _WIDTH_MINUS:
001DC3 EEBC B0FF                    DW  0-WIDTH
       EEBE                     WK30:
001DC5 EEBE 0C                      DB  00CH
       EEBF                     WK31:
       EEBF                     WK1FD0:
001DC6 EEBF 20                      DB  020H
                                
                                ;   割り込みベクタ(X1)
001DC7 EEC0 0000                CTC0:   DW  INTCTCE
001DC9 EEC2 0000                CTC1:   DW  INTCTCE
001DCB EEC4 0000                CTC2:   DW  INTCTCE
001DCD EEC6 0000                CTC3:   DW  INTCTCE
001DCF EEC8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
001DD1 EECA C309E2          10  _INKEY: JP  INKEY
001DD4 EECD C347E1          10  _PRINT: JP  PRINT
001DD7 EED0 C383E2          10  _SCRN:  JP  SCRN
001DDA EED3 C3ADE1          10  _POS:   JP  POS
001DDD EED6 C39CF0          10  _LOC:   JP  LOC
       EED9                     _CHGDRV:
001DE0 EED9 C3DCE9          10      JP  CHGDRV
       EEDC                     _GETDPB:
001DE3 EEDC C39AEA          10      JP  GETDPB
       EEDF                     _FFLUSH:
001DE6 EEDF C3B8EA          10      JP  FFLUSH
       EEE2                     _RDFATX:
001DE9 EEE2 C3B4E6          10      JP  RDFATX
001DEC EEE5 C3E6E7          10  _RDFAT: JP  RDFAT
001DEF EEE8 C387EB          10  _WTTRK: JP  WTTRK
001DF2 EEEB C321EC          10  _FDRD:  JP  FDRD
001DF5 EEEE C389EB          10  _FDWT:  JP  FDWT
       EEF1                     _BPB2DPB:
001DF8 EEF1 C37EE8          10      JP  BPB2DPB
       EEF4                     _BREAK:
001DFB EEF4 C3A9DA          10      JP  END_BATCH
       EEF7                     _GNCL:
001DFE EEF7 C360E7          10      JP  GNCL        ; self-modifying code
       EEF8                     GNCPAT  EQU $-2
       EEFA                     _SNCL:
001E01 EEFA C383E7          10      JP  SNCL        ; self-modifying code
       EEFB                     SNCPAT  EQU $-2
       EEFD                     _COMANL:
001E04 EEFD C362D9          10      JP  COMANL
                                
       EF00                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       EF00                     STABLE:
                                ;0
001E07 EF00 03EE0FE31BE3AAF1        DW  _SYS00,_SYS01,_SYS02,_SYS03
001E0F EF08 CDDDCDDD20E309EE        DW  _SYS04,_SYS05,_SYS06,_SYS07
001E17 EF10 28E3CFDD74E050E3        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
001E1F EF18 E4DDE9DDF8DD09DE        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001E27 EF20 5DDEA4DEEDDE1EDF        DW  _SYS10,_SYS11,_SYS12,_SYS13
001E2F EF28 26DF3CDF51DF49DF        DW  _SYS14,_SYS15,_SYS16,_SYS17
001E37 EF30 98DF9DDFA2DFA8DF        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001E3F EF38 CDDDCEDFCDDDD2DF        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
001E47 EF40 CDDD88DF90DFD9DF        DW  _SYS20,_SYS21,_SYS22,_SYS23
001E4F EF48 FEDFCDDD74E342E4        DW  _SYS24,_ERROR,_SYS26,_SYS27
001E57 EF50 90DF08E0A0E0AAF1        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
001E5F EF58 C7E0AAF1CDDD29E0        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
001E67 EF60 23E0CDDDCDDDCDDD        DW  _SYS30,_ERROR,_ERROR,_ERROR
001E6F EF68 CDDDCDDDCDDDCDDD        DW  _ERROR,_ERROR,_ERROR,_ERROR
001E77 EF70 CDDDAAF1AAF14AE0        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
001E7F EF78 B1DD                    DW  _DOS2
                                
001E81 EF7A                         DS  1
       EF7B                     _MAX_SEC_SZ_H:
001E82 EF7B 02                      DB  MAX_SEC_SZ_H
                                
                                ;   FATバッファのアドレス
       EF7C                     _FATBF:
001E83 EF7C 00F7                    DW  FATBF
                                
                                ;   データバッファのアドレス
       EF7E                     _DTBUF:
001E85 EF7E 00FD                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       EF80                     CTRLTB:
001E87 EF80 9FF09FF0D5F06EF1        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
001E8F EF88 68F1F5F04CF123F1        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
001E97 EF90 A6F0CAF071F116F1        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
001E9F EF98 49F109F178F19FF0        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
001EA7 EFA0 9FF09FF00EF19FF0        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
001EAF EFA8 9FF09FF09FF09FF0        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
001EB7 EFB0 9FF09FF049F11DF1        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
001EBF EFB8 89F0ADF0C1F071F1        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
                                ;   2D/2DDでBPBがない場合のデフォルト値(2D/360KB/9セクタ1024バイト)
001EC7 EFC0 0200                M2D:    DW  2
001EC9 EFC2 FD02                    DB  0FDH,2
001ECB EFC4 6401                    DW  356
001ECD EFC6 FF0728090182            DB  0FFH,7,40,9,1,082H
001ED3 EFCC 0500A7000800            DW  5,0A7H,8
                                
                                ;   2HDでBPBがない場合のデフォルト値(2HD/1.23MB/8セクタ1024バイト)
001ED9 EFD2 0200                M2HD:   DW  2
001EDB EFD4 FE01                    DB  0FEH,1
001EDD EFD6 C704                    DW  1223
001EDF EFD8 FE064D080184            DB  0FEH,6,77,8,1,084H
001EE5 EFDE 0500A7000900            DW  5,0A7H,9
                                
                                ;   ディレクトリエントリとFCBの変換テーブル(日付+時刻+サイズ)
001EEB EFE4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
001EED EFE6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
001EEF EFE8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
001EF1 EFEA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       EFEE                     SDDATAE:
                                
001EF5 EFEE                         DS  2
                                
                                ;   バッチファイルのFCB
       EFF0                     _FCB_BAT:
001EF7 EFF0 AFED                    DW  FCB_BAT
       EFF2                     _PATH:
001EF9 EFF2 4EED                    DW  PATHD
                                
001EFB EFF4                     SCDIR:  DS  2       ;+14 +15
001EFD EFF6                     SFBPS:  DS  2       ;FBPS
001EFF EFF8                     SFNDF:  DS  2       ;FILEN DIRF
                                
001F01 EFFA 0000                _FATPS: DW  0
001F03 EFFC 0000                _DIRPS: DW  0
001F05 EFFE 0000                _CLPS:  DW  0
                                
       F000                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       F000                     FILEC:
001F07 F000 CD0BF0          17      CALL    FILE
       F003                     FILEC2:
001F0A F003 3A15EE          13      LD  A,(FDRV+1)
001F0D F006 FE20             7      CP  020H
001F0F F008 C8              11      RET Z
001F10 F009 1839            12      JR  SETDIR1
                                
       F00B                     FILE:
001F12 F00B AF               4      XOR A
001F13 F00C 3214EE          13      LD  (FDRV),A
001F16 F00F 67               4      LD  H,A
001F17 F010 6F               4      LD  L,A
001F18 F011 2222EE          16      LD  (FDRV+14),HL
001F1B F014 CDE1F0          17      CALL    SPCUT
001F1E F017 CDC6F0          17      CALL    CCHK3
001F21 F01A 2812            12      JR  Z,DEVI1
001F23 F01C 13               6      INC DE
001F24 F01D 1A               7      LD  A,(DE)
001F25 F01E 1B               6      DEC DE
001F26 F01F FE3A             7      CP  ':'
001F28 F021 200B            12      JR  NZ,DEVI1
001F2A F023 1A               7      LD  A,(DE)      ;DRIVE
001F2B F024 CD27F3          17      CALL    CAP
001F2E F027 D640             7      SUB '@'
001F30 F029 13               6      INC DE
001F31 F02A 13               6      INC DE
001F32 F02B 3214EE          13      LD  (FDRV),A
       F02E                     DEVI1:
001F35 F02E 1A               7      LD  A,(DE)
001F36 F02F D65C             7      SUB 05CH        ;\
001F38 F031 2009            12      JR  NZ,NOROOT
001F3A F033 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
001F3B F034 222EEE          16      LD  (FDRV+26),HL
001F3E F037 2C               4      INC L
001F3F F038 2222EE          16      LD  (FDRV+14),HL
001F42 F03B 13               6      INC DE
       F03C                     NOROOT:
                                
       F03C                     SETDIR:
001F43 F03C CD67F0          17      CALL    FILED
001F46 F03F 1A               7      LD  A,(DE)
001F47 F040 FE5C             7      CP  05CH        ;\
001F49 F042 C0              11      RET NZ
001F4A F043 13               6      INC DE
       F044                     SETDIR1:
001F4B F044 3E10             7      LD  A,010H      ;Directory
001F4D F046 3221EE          13      LD  (FDRV+13),A
001F50 F049 D5              11      PUSH    DE
001F51 F04A 1114EE          10      LD  DE,FDRV
001F54 F04D 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
001F56 F04F CD9FDD          17      CALL    BDOS0
001F59 F052 D1              10      POP DE
001F5A F053 B7               4      OR  A
001F5B F054 C0              11      RET NZ
                                
001F5C F055 3A21EE          13      LD  A,(FDRV+13)
001F5F F058 E610             7      AND 010H        ;ディレクトリ
001F61 F05A C8              11      RET Z
                                
001F62 F05B CDAEF0          17      CALL    FILEI
001F65 F05E 2A2EEE          16      LD  HL,(FDRV+26)
001F68 F061 23               6      INC HL
001F69 F062 2222EE          16      LD  (FDRV+14),HL
001F6C F065 18D5            12      JR  SETDIR
                                
       F067                     FILED:
001F6E F067 CDAEF0          17      CALL    FILEI
001F71 F06A 2115EE          10      LD  HL,FNAME
                                
001F74 F06D 0608             7      LD  B,8
       F06F                     FILE2:
001F76 F06F CDBBF0          17      CALL    CCHKF
001F79 F072 C8              11      RET Z
001F7A F073 FE2A             7      CP  '*'
001F7C F075 282E            12      JR  Z,FILE9
001F7E F077 FE2E             7      CP  '.'
001F80 F079 280C            12      JR  Z,FILE4
001F82 F07B 77               7      LD  (HL),A
001F83 F07C 23               6      INC HL
001F84 F07D 10F0            13      DJNZ    FILE2
                                
       F07F                     FILE3:
001F86 F07F CDBBF0          17      CALL    CCHKF
001F89 F082 C8              11      RET Z
001F8A F083 FE2E             7      CP  '.'
001F8C F085 20F8            12      JR  NZ,FILE3
                                
       F087                     FILE4:
001F8E F087 211DEE          10      LD  HL,FNAME+8
001F91 F08A 0603             7      LD  B,3
                                
       F08C                     FILE4L:
001F93 F08C CDBBF0          17      CALL    CCHKF
001F96 F08F C8              11      RET Z
001F97 F090 FE2E             7      CP  '.'
001F99 F092 2008            12      JR  NZ,FILE12
001F9B F094 3215EE          13      LD  (FNAME),A   ;Parent directory(..)
001F9E F097 3216EE          13      LD  (FNAME+1),A
001FA1 F09A 3E20             7      LD  A,020H
       F09C                     FILE12:
001FA3 F09C FE2A             7      CP  '*'
001FA5 F09E 280A            12      JR  Z,FILE10
001FA7 F0A0 77               7      LD  (HL),A
001FA8 F0A1 23               6      INC HL
001FA9 F0A2 10E8            13      DJNZ    FILE4L
001FAB F0A4 C9              10      RET
                                
       F0A5                     FILE9:              ;名前の*処理、名前の残りを?で埋める
001FAC F0A5 CDAAF0          17      CALL    FILE10
001FAF F0A8 18D5            12      JR  FILE3
                                
       F0AA                     FILE10:
001FB1 F0AA 3E3F             7      LD  A,'?'
001FB3 F0AC 1808            12      JR  FILL_MEMORY
       F0AE                     FILEI:              ;名前＋拡張子をスペースで初期化
001FB5 F0AE 3E20             7      LD  A,020H
001FB7 F0B0 01000B          10      LD  BC,11*256   ;C=0にしておく
001FBA F0B3 2115EE          10      LD  HL,FNAME
       F0B6                     FILL_MEMORY:            ;HLからBバイトAで埋める
001FBD F0B6 77               7      LD  (HL),A
001FBE F0B7 23               6      INC HL
001FBF F0B8 10FC            13      DJNZ    FILL_MEMORY
001FC1 F0BA C9              10      RET
                                
       F0BB                     CCHKF:
001FC2 F0BB 1A               7      LD  A,(DE)
001FC3 F0BC CDC3F0          17      CALL    CCHK2
001FC6 F0BF C8              11      RET Z
001FC7 F0C0 C32FF4          10      JP  FKAN
                                
       F0C3                     CCHK2:
001FCA F0C3 0C               4      INC C
001FCB F0C4 0D               4      DEC C
001FCC F0C5 C0              11      RET NZ
       F0C6                     CCHK3:              ;ZF=1 で使えない文字
001FCD F0C6 FE2B             7      CP  '+'
001FCF F0C8 C8              11      RET Z
001FD0 F0C9 FE2C             7      CP  ','
001FD2 F0CB C8              11      RET Z
001FD3 F0CC FE2F             7      CP  '/'
001FD5 F0CE C8              11      RET Z
001FD6 F0CF FE3A             7      CP  ':'
001FD8 F0D1 C8              11      RET Z
001FD9 F0D2 FE3B             7      CP  ';'
001FDB F0D4 C8              11      RET Z
001FDC F0D5 FE3D             7      CP  '='
001FDE F0D7 C8              11      RET Z
001FDF F0D8 FE5C             7      CP  05CH    ;\
001FE1 F0DA C8              11      RET Z
001FE2 F0DB FE20             7      CP  020H
001FE4 F0DD D0              11      RET NC
001FE5 F0DE BF               4      CP  A       ;Z=1
001FE6 F0DF C9              10      RET
                                
       F0E0                     SS1:
001FE7 F0E0 13               6      INC DE
       F0E1                     SPCUT:              ;スペースをカット
001FE8 F0E1 1A               7      LD  A,(DE)
001FE9 F0E2 FE20             7      CP  020H
001FEB F0E4 28FA            12      JR  Z,SS1
001FED F0E6 C9              10      RET
                                
       F0E7                     SETDRVF:
001FEE F0E7 1114EE          10      LD  DE,FDRV
       F0EA                     SETDRV0:
001FF1 F0EA CDF3F0          17      CALL    SETDRV
001FF4 F0ED FDE1            14      POP IY
001FF6 F0EF C1              10      POP BC
001FF7 F0F0 D1              10      POP DE
001FF8 F0F1 E1              10      POP HL
001FF9 F0F2 C9              10      RET
                                
       F0F3                     SETDRV:
001FFA F0F3 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
001FFB F0F4 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
001FFC F0F5 C5              11      PUSH    BC
001FFD F0F6 1A               7      LD  A,(DE)
001FFE F0F7 D5              11      PUSH    DE
001FFF F0F8 FDE3            23      EX  (SP),IY
                                
002001 F0FA CD01F1          17      CALL    GETDRV
002004 F0FD CDD9EE          17      CALL    _CHGDRV
                                
002007 F100 E9               4      JP  (HL)
                                
       F101                     GETDRV:
002008 F101 CD14F1          17      CALL    GETDRV1
00200B F104 3288EE          13      LD  (_DRV),A
00200E F107 C9              10      RET
                                
       F108                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
00200F F108 CD14F1          17      CALL    GETDRV1
002012 F10B C5              11      PUSH    BC
002013 F10C 4F               4      LD  C,A
002014 F10D 1A               7      LD  A,(DE)
002015 F10E CD14F1          17      CALL    GETDRV1
002018 F111 A9               4      XOR C
002019 F112 C1              10      POP BC
00201A F113 C9              10      RET
       F114                     GETDRV1:
00201B F114 E67F             7      AND 07FH
00201D F116 D601             7      SUB 001H
00201F F118 D0              11      RET NC
002020 F119 3A0400          13      LD  A,(_DVSW)   ;Current Drive
002023 F11C C9              10      RET
                                
       F11D                     SOPENX:
002024 F11D 1139EE          10      LD  DE,SFILE
002027 F120 FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
00202A F123 CD08F1          17      CALL    IS_SAME_DRV_A_DE
00202D F126 2024            12      JR  NZ,SOPEN
00202F F128 13               6      INC DE
002030 F129 FDE5            15      PUSH    IY
002032 F12B E1              10      POP HL
002033 F12C 23               6      INC HL
002034 F12D CDB8F2          17      CALL    CPFILE
002037 F130 201A            12      JR  NZ,SOPEN
                                
002039 F132 2AF4EF          16      LD  HL,(SCDIR)
00203C F135 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00203F F138 FD740F          19      LD  (IY+15),H
                                
002042 F13B 2AF8EF          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
002045 F13E 229FEE          16      LD  (_FILEN),HL
                                
002048 F141 ED5BF6EF        20      LD  DE,(SFBPS)
00204C F145 2139EE          10      LD  HL,SFILE
00204F F148 36FF            10      LD  (HL),0FFH
002051 F14A 23               6      INC HL
002052 F14B C9              10      RET
       F14C                     SOPEN:
002053 F14C 2160F2          10      LD  HL,FILESE
       F14F                     SOPENC:
002056 F14F 2288F1          16      LD  (OPENPAT),HL
                                
002059 F152 CDE2EE          17      CALL    _RDFATX     ;Detect Media
00205C F155 3856            12      JR  C,RDDERR
                                
00205E F157 AF               4      XOR A
00205F F158 329FEE          13      LD  (_FILEN),A
002062 F15B CD64F3          17      CALL    LDDIRX1     ;A=0で呼び出す
002065 F15E 2818            12      JR  Z,SDIRX1
                                
002067 F160 CD51F2          17      CALL    READ_DIR    ;Sub Directory
00206A F163 3808            12      JR  C,SDIRX0
00206C F165 2A7EEF          16      LD  HL,(_DTBUF)
00206F F168 7E               7      LD  A,(HL)
002070 F169 FE2E             7      CP  '.'
002072 F16B 280F            12      JR  Z,SOPEN1
       F16D                     SDIRX0:
002074 F16D AF               4      XOR A
002075 F16E 32A0EE          13      LD  (_DIRF),A
002078 F171 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
00207C F175 FD770F          19      LD  (IY+15),A
       F178                     SDIRX1:
00207F F178 ED5BFCEF        20      LD  DE,(_DIRPS) ;Root Directory
       F17C                     SOPEN1:
002083 F17C 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       F17D                     SDECPAT EQU $-1
       F17E                     SOPEN1X:
002085 F17E CD51F2          17      CALL    READ_DIR    ;FILE SEARCH
002088 F181 382A            12      JR  C,RDDERR
00208A F183 2A7EEF          16      LD  HL,(_DTBUF)
       F186                     SOPEN2:
00208D F186 D5              11      PUSH    DE
00208E F187 CD60F2          17      CALL    FILESE      ;(self-modifying code)
       F188                     OPENPAT EQU $-2
002091 F18A D1              10      POP DE
002092 F18B 386D            12      JR  C,SOPENE
002094 F18D 281B            12      JR  Z,SCF_FF_RET
       F18F                     SOPEN3:
002096 F18F 3AA0EE          13      LD  A,(_DIRF)   ;ディレクトリか判別
002099 F192 B7               4      OR  A
00209A F193 200C            12      JR  NZ,SOPEN5
00209C F195 13               6      INC DE      ;ルートディレクトリ
00209D F196 E5              11      PUSH    HL
00209E F197 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       F198                     MD_PAT  EQU $-2
0020A1 F19A ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
0020A3 F19C E1              10      POP HL
0020A4 F19D 20DD            12      JR  NZ,SOPEN1
0020A6 F19F 1807            12      JR  SOPEN6
       F1A1                     SOPEN5:
0020A8 F1A1 CDDFE7          17      CALL    GNCLX       ;END DIR
0020AB F1A4 D8              11      RET C
0020AC F1A5 CD18F3          17      CALL    ENDCL
       F1A8                     SOPEN6:
0020AF F1A8 38D2            12      JR  C,SOPEN1
       F1AA                     SCF_FF_RET:
0020B1 F1AA 37               4      SCF         ;CF=1
0020B2 F1AB 9F               4      SBC A,A     ;A=0FFH
0020B3 F1AC C9              10      RET
                                
       F1AD                     RDDERR:
0020B4 F1AD BF               4      CP  A       ;READ ERR CF=1 ZF=1
0020B5 F1AE 37               4      SCF
0020B6 F1AF C9              10      RET
                                
       F1B0                     NOPEN:
0020B7 F1B0 2160F2          10      LD  HL,FILESE
0020BA F1B3 2288F1          16      LD  (OPENPAT),HL
0020BD F1B6 FD2A98EE        20      LD  IY,(_FCB)
0020C1 F1BA CD42F4          17      CALL    CHKWILDX
0020C4 F1BD 30EB            12      JR  NC,SCF_FF_RET
0020C6 F1BF FD7E00          19      LD  A,(IY+0)
0020C9 F1C2 CD01F1          17      CALL    GETDRV
0020CC F1C5 CDD9EE          17      CALL    _CHGDRV
0020CF F1C8 D8              11      RET C
0020D0 F1C9 2AF8EF          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
0020D3 F1CC 229FEE          16      LD  (_FILEN),HL
                                
0020D6 F1CF CD5FF3          17      CALL    LDDIRX
0020D9 F1D2 ED5B9AEE        20      LD  DE,(_FBPS)
0020DD F1D6 CD51F2          17      CALL    READ_DIR
0020E0 F1D9 38D2            12      JR  C,RDDERR
0020E2 F1DB 3A9EEE          13      LD  A,(_FBCNT)
0020E5 F1DE 3D               4      DEC A
0020E6 F1DF 28AE            12      JR  Z,SOPEN3
       F1E1                     NOPEN2:
0020E8 F1E1 2A9CEE          16      LD  HL,(_FBAD)
0020EB F1E4 012000          10      LD  BC,020H
0020EE F1E7 09              11      ADD HL,BC
0020EF F1E8 4F               4      LD  C,A
0020F0 F1E9 189B            12      JR  SOPEN2
                                
       F1EB                     SOPENE2:
0020F2 F1EB 229CEE          16      LD  (_FBAD),HL
0020F5 F1EE 79               4      LD  A,C
0020F6 F1EF 329EEE          13      LD  (_FBCNT),A
0020F9 F1F2 ED539AEE        20      LD  (_FBPS),DE
0020FD F1F6 FD2298EE        20      LD  (_FCB),IY
       F1FA                     SOPENE:
002101 F1FA AF               4      XOR A
002102 F1FB C9              10      RET
                                
       F1FC                     COPEN:
002103 F1FC FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
002107 F200 217DF2          10      LD  HL,NEXTSE
00210A F203 CD4FF1          17      CALL    SOPENC
00210D F206 D0              11      RET NC
00210E F207 C8              11      RET Z
00210F F208 3AA0EE          13      LD  A,(_DIRF)   ;ディレクトリか判別
002112 F20B B7               4      OR  A
002113 F20C 37               4      SCF
002114 F20D C8              11      RET Z       ;ルートディレクトリ
002115 F20E 0601             7      LD  B,1
002117 F210 CDA1F4          17      CALL    WRDF
00211A F213 D8              11      RET C
00211B F214 ED5BFEEF        20      LD  DE,(_CLPS)
00211F F218 D5              11      PUSH    DE
002120 F219 CDE1F2          17      CALL    DCPAT
002123 F21C CD60E6          17      CALL    DRDNX
002126 F21F 2A7EEF          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
002129 F222 ED4B4BE5        20      LD  BC,(SECSZ)  ;1セクタのサイズ
00212D F226 AF               4      XOR A
       F227                     COPENCL:
00212E F227 77               7      LD  (HL),A
00212F F228 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
002131 F22A EA27F2          10      JP  PE,COPENCL
                                
002134 F22D 3AFFF2          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
002137 F230 3D               4      DEC A
002138 F231 2819            12      JR  Z,COPENE
00213A F233 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
00213C F235 32D7E7          13      LD  (_SECPS),A
00213F F238 D1              10      POP DE      ;DE=(_CLPS)
002140 F239 D5              11      PUSH    DE
       F23A                     COPEN1:
002141 F23A D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
002142 F23B C5              11      PUSH    BC
002143 F23C 2A7EEF          16      LD  HL,(_DTBUF)
002146 F23F CDFBF2          17      CALL    CLUSTX
002149 F242 CD76E9          17      CALL    DWT24
00214C F245 C1              10      POP BC
00214D F246 D1              10      POP DE
00214E F247 CDD6E7          17      CALL    NEXTX
002151 F24A 20EE            12      JR  NZ,COPEN1
       F24C                     COPENE:
002153 F24C 2A7EEF          16      LD  HL,(_DTBUF)
002156 F24F D1              10      POP DE
002157 F250 C9              10      RET
                                
       F251                     READ_DIR:
002158 F251 ED53FEEF        20      LD  (_CLPS),DE
00215C F255 C5              11      PUSH    BC
00215D F256 D5              11      PUSH    DE
00215E F257 CDE1F2          17      CALL    DCPAT
002161 F25A CD40E6          17      CALL    DRDX
002164 F25D D1              10      POP DE
002165 F25E C1              10      POP BC
002166 F25F C9              10      RET
                                
       F260                     FILESE:
002167 F260 7E               7      LD  A,(HL)
002168 F261 B7               4      OR  A
002169 F262 C8              11      RET Z       ;END:ZF=1 CF=0
00216A F263 FEE5             7      CP  0E5H
00216C F265 280E            12      JR  Z,FILESE1
00216E F267 FDE5            15      PUSH    IY
002170 F269 D1              10      POP DE
002171 F26A 13               6      INC DE
002172 F26B E5              11      PUSH    HL
002173 F26C CDB8F2          17      CALL    CPFILE
002176 F26F CCD9F2          17      CALL    Z,CPFILE2
002179 F272 E1              10      POP HL
00217A F273 37               4      SCF
00217B F274 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       F275                     FILESE1:
00217C F275 CD8CF2          17      CALL    FNEXT
00217F F278 20E6            12      JR  NZ,FILESE
       F27A                     ZF0_CF0_AFF_RET:
002181 F27A F6FF             7      OR  0FFH        ;ZF=0 CF=0
002183 F27C C9              10      RET
                                
       F27D                     NEXTSE:
002184 F27D 7E               7      LD  A,(HL)
002185 F27E B7               4      OR  A
002186 F27F 37               4      SCF
002187 F280 C8              11      RET Z       ;!!!:ZF=1 CF=1
002188 F281 FEE5             7      CP  0E5H
00218A F283 37               4      SCF
00218B F284 C8              11      RET Z       ;!!!:(ZF=1) CF=1
00218C F285 CD8CF2          17      CALL    FNEXT
00218F F288 20F3            12      JR  NZ,NEXTSE
002191 F28A 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       F28C                     FNEXT:
002193 F28C E5              11      PUSH    HL
002194 F28D 219FEE          10      LD  HL,_FILEN
002197 F290 34              11      INC (HL)
002198 F291 E1              10      POP HL
002199 F292 112000          10      LD  DE,020H
00219C F295 19              11      ADD HL,DE
00219D F296 0D               4      DEC C
00219E F297 C9              10      RET
                                
       F298                     CPNAME:
00219F F298 C5              11      PUSH    BC
0021A0 F299 D5              11      PUSH    DE
0021A1 F29A E5              11      PUSH    HL
0021A2 F29B CDB2F2          17      CALL    CPFILE4
0021A5 F29E E1              10      POP HL
0021A6 F29F 23               6      INC HL
0021A7 F2A0 23               6      INC HL
0021A8 F2A1 23               6      INC HL
0021A9 F2A2 23               6      INC HL
0021AA F2A3 D1              10      POP DE
0021AB F2A4 C1              10      POP BC
0021AC F2A5 2005            12      JR  NZ,CPNAME1
0021AE F2A7 7E               7      LD  A,(HL)
0021AF F2A8 23               6      INC HL
0021B0 F2A9 66               7      LD  H,(HL)
0021B1 F2AA 6F               4      LD  L,A
0021B2 F2AB C9              10      RET
       F2AC                     CPNAME1:
0021B3 F2AC 23               6      INC HL
0021B4 F2AD 23               6      INC HL
0021B5 F2AE 10E8            13      DJNZ    CPNAME
0021B7 F2B0 37               4      SCF
0021B8 F2B1 C9              10      RET
                                
       F2B2                     CPFILE4:
0021B9 F2B2 C5              11      PUSH    BC
0021BA F2B3 010004          10      LD  BC,00400H
0021BD F2B6 1804            12      JR  CPSTR1
       F2B8                     CPFILE:
0021BF F2B8 C5              11      PUSH    BC
0021C0 F2B9 01000B          10      LD  BC,00B00H
       F2BC                     CPSTR1:
0021C3 F2BC 1A               7      LD  A,(DE)
0021C4 F2BD FE3F             7      CP  '?'     ;Wild card
0021C6 F2BF 2812            12      JR  Z,CPSTR2
0021C8 F2C1 7E               7      LD  A,(HL)
0021C9 F2C2 CD28F4          17      CALL    FKANC
0021CC F2C5 E5              11      PUSH    HL
0021CD F2C6 67               4      LD  H,A
0021CE F2C7 1A               7      LD  A,(DE)
0021CF F2C8 CB01             8      RLC C
0021D1 F2CA CD28F4          17      CALL    FKANC
0021D4 F2CD CB09             8      RRC C
0021D6 F2CF BC               4      CP  H       ;CP (HL),(DE)
0021D7 F2D0 E1              10      POP HL
0021D8 F2D1 2004            12      JR  NZ,CPSTR3
       F2D3                     CPSTR2:
0021DA F2D3 13               6      INC DE
0021DB F2D4 23               6      INC HL
0021DC F2D5 10E5            13      DJNZ    CPSTR1
       F2D7                     CPSTR3:
0021DE F2D7 C1              10      POP BC
0021DF F2D8 C9              10      RET
                                
       F2D9                     CPFILE2:
0021E0 F2D9 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0021E3 F2DC F6E1             7      OR  0E1H
0021E5 F2DE 2F               4      CPL
0021E6 F2DF A6               7      AND (HL)
0021E7 F2E0 C9              10      RET
                                
       F2E1                     DCPAT:
0021E8 F2E1 0E00             7      LD  C,0
0021EA F2E3 2A7EEF          16      LD  HL,(_DTBUF)
0021ED F2E6 3AA0EE          13      LD  A,(_DIRF)   ;ディレクトリか判別
0021F0 F2E9 B7               4      OR  A
0021F1 F2EA C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
0021F2 F2EB 3AFFF2          13      LD  A,(SPCPAT)
0021F5 F2EE 4F               4      LD  C,A
0021F6 F2EF 3AD7E7          13      LD  A,(_SECPS)
0021F9 F2F2 B9               4      CP  C
0021FA F2F3 3801            12      JR  C,DC1
0021FC F2F5 AF               4      XOR A
       F2F6                     DC1:
0021FD F2F6 F680             7      OR  080H
0021FF F2F8 32A0EE          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       F2FB                     CLUSTX:
002202 F2FB E5              11      PUSH    HL
002203 F2FC EB               4      EX  DE,HL
002204 F2FD AF               4      XOR A
002205 F2FE 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       F2FF                     SPCPAT  EQU $-1
       F300                     L_CLDBL:
002207 F300 CB19             8      RR  C       ;->CF
002209 F302 3804            12      JR  C,E_CLDBL
00220B F304 29              11      ADD HL,HL       ;*2
00220C F305 8F               4      ADC A,A
00220D F306 18F8            12      JR  L_CLDBL
       F308                     E_CLDBL:
00220F F308 4F               4      LD  C,A
002210 F309 3AD7E7          13      LD  A,(_SECPS)
002213 F30C B5               4      OR  L
002214 F30D 6F               4      LD  L,A
002215 F30E 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       F30F                     CLSPAT  EQU $-2
002218 F311 AF               4      XOR A
002219 F312 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
00221A F313 89               4      ADC A,C
00221B F314 4F               4      LD  C,A
00221C F315 EB               4      EX  DE,HL
00221D F316 E1              10      POP HL
00221E F317 C9              10      RET
                                ;(8)
       F318                     ENDCL:
00221F F318 7A               4      LD  A,D ;END CLUSTER
002220 F319 FE01             7      CP  1   ;164=356    (self-modifying code)
       F31A                     CLPAT1  EQU $-1
002222 F31B C0              11      RET NZ
002223 F31C 7B               4      LD  A,E
002224 F31D FE64             7      CP  064H    ;       (self-modifying code)
       F31E                     CLPAT2  EQU $-1
002226 F31F C9              10      RET
                                ;(3)
       F320                     CAP4:
002227 F320 3EE5             7      LD  A,0E5H
002229 F322 C9              10      RET
                                                    ;for X1/88 ワークエリア
00222A F323 5BEE                    DW  _DISKE+1        ;DISKVE($F323)
00222C F325 F5EE                    DW  _BREAK+1        ;BREAKV($F325)
                                
       F327                     CAP:            ;(9)
00222E F327 FE61             7      CP  'a'
002230 F329 D8              11      RET C
002231 F32A FE7B             7      CP  'z'+1
002233 F32C D0              11      RET NC
002234 F32D D620             7      SUB 020H
002236 F32F C9              10      RET
                                ;(10)
       F330                     CAP2:
002237 F330 CD27F3          17      CALL    CAP
       F333                     CAP3:               ;
00223A F333 FE05             7      CP  5
00223C F335 28E9            12      JR  Z,CAP4
00223E F337 FE21             7      CP  021H
002240 F339 C9              10      RET
                                                    ;
       F33A                     CHDIR:
002241 F33A CD87EA          17      CALL    GETDPBD
002244 F33D 381D            12      JR  C,CHDIR2
002246 F33F DD751A          19      LD  (IX+DPB_SDIR),L
002249 F342 DD741B          19      LD  (IX+DPB_SDIR+1),H
00224C F345 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       F347                     LDDIR:
00224E F347 CD87EA          17      CALL    GETDPBD
002251 F34A DD5E1A          19      LD  E,(IX+DPB_SDIR)
002254 F34D DD561B          19      LD  D,(IX+DPB_SDIR+1)
002257 F350 13               6      INC DE
002258 F351 FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00225B F354 FD720F          19      LD  (IY+15),D
00225E F357 1B               6      DEC DE
00225F F358 AF               4      XOR A
002260 F359 32A0EE          13      LD  (_DIRF),A
       F35C                     CHDIR2:
002263 F35C DDE1            14      POP IX
002265 F35E C9              10      RET
                                
       F35F                     LDDIRX:
002266 F35F 3AA0EE          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
002269 F362 E67F             7      AND 07FH
       F364                     LDDIRX1:
00226B F364 32D7E7          13      LD  (_SECPS),A
00226E F367 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
002271 F36A FD560F          19      LD  D,(IY+15)
002274 F36D 1B               6      DEC DE
002275 F36E CD18F3          17      CALL    ENDCL
002278 F371 D447F3          17      CALL    NC,LDDIR
       F374                     LDDIRS:
00227B F374 7A               4      LD  A,D
00227C F375 B3               4      OR  E
00227D F376 32A0EE          13      LD  (_DIRF),A   ;ディレクトリか判別
002280 F379 C9              10      RET
                                
       F37A                     KILL:
002281 F37A CD42F4          17      CALL    CHKWILDX
002284 F37D 3834            12      JR  C,KILLW
002286 F37F CD1DF1          17      CALL    SOPENX
       F382                     KILLS:
002289 F382 3E1F             7      LD  A,01FH
00228B F384 D4C6F3          17      CALL    NC,CHKATT
00228E F387 D8              11      RET C
       F388                     KILLSX:
00228F F388 36E5            10      LD  (HL),0E5H   ;DIR
002291 F38A CD1EF4          17      CALL    WTDB
002294 F38D 111A00          10      LD  DE,01AH
002297 F390 19              11      ADD HL,DE
002298 F391 5E               7      LD  E,(HL)
002299 F392 23               6      INC HL
00229A F393 56               7      LD  D,(HL)
       F394                     KILLS1:
00229B F394 CD18F3          17      CALL    ENDCL
00229E F397 D0              11      RET NC      ;CF=0
00229F F398 21FEFF          10      LD  HL,0-2
0022A2 F39B 19              11      ADD HL,DE
0022A3 F39C D0              11      RET NC      ;DE= 0 or 1
0022A4 F39D D5              11      PUSH    DE
0022A5 F39E CDF7EE          17      CALL    _GNCL
0022A8 F3A1 ED53FEEF        20      LD  (_CLPS),DE
0022AC F3A5 D1              10      POP DE
0022AD F3A6 210000          10      LD  HL,0
0022B0 F3A9 D4FAEE          17      CALL    NC,_SNCL
0022B3 F3AC D8              11      RET C
0022B4 F3AD ED5BFEEF        20      LD  DE,(_CLPS)  ;FAT
0022B8 F3B1 18E1            12      JR  KILLS1
                                
       F3B3                     KILLW:
0022BA F3B3 CD4CF1          17      CALL    SOPEN
       F3B6                     KILLW1:
0022BD F3B6 380B            12      JR  C,KILLW2
0022BF F3B8 CDEBF1          17      CALL    SOPENE2
0022C2 F3BB CD82F3          17      CALL    KILLS
0022C5 F3BE CDB0F1          17      CALL    NOPEN
0022C8 F3C1 18F3            12      JR  KILLW1
       F3C3                     KILLW2:
0022CA F3C3 C8              11      RET Z
0022CB F3C4 3F               4      CCF
0022CC F3C5 C9              10      RET
                                
       F3C6                     CHKATT:
0022CD F3C6 E5              11      PUSH    HL
0022CE F3C7 110B00          10      LD  DE,00BH
0022D1 F3CA 19              11      ADD HL,DE
0022D2 F3CB A6               7      AND (HL)
0022D3 F3CC E1              10      POP HL
0022D4 F3CD C8              11      RET Z
0022D5 F3CE 37               4      SCF
0022D6 F3CF C9              10      RET
                                
       F3D0                     NAME:
0022D7 F3D0 CD42F4          17      CALL    CHKWILDX
0022DA F3D3 D8              11      RET C
0022DB F3D4 110400          10      LD  DE,4
0022DE F3D7 19              11      ADD HL,DE
0022DF F3D8 22EDF3          16      LD  (NAMEP),HL
0022E2 F3DB 23               6      INC HL
0022E3 F3DC CD46F4          17      CALL    CHKWILD
0022E6 F3DF D8              11      RET C
                                
0022E7 F3E0 CD1DF1          17      CALL    SOPENX
0022EA F3E3 3E0F             7      LD  A,00FH
0022EC F3E5 D4C6F3          17      CALL    NC,CHKATT
0022EF F3E8 D8              11      RET C
                                
0022F0 F3E9 FDE5            15      PUSH    IY
0022F2 F3EB FD210000        14      LD  IY,0        ;自己書き換え
       F3ED                     NAMEP   EQU $-2
0022F6 F3EF CD1DF1          17      CALL    SOPENX
0022F9 F3F2 FDE3            23      EX  (SP),IY
0022FB F3F4 3F               4      CCF
0022FC F3F5 D44CF1          17      CALL    NC,SOPEN
0022FF F3F8 EB               4      EX  DE,HL
002300 F3F9 E1              10      POP HL
002301 F3FA D8              11      RET C
                                
       F3FB                     SETNAME:
002302 F3FB 01000B          10      LD  BC,11*256
002305 F3FE 23               6      INC HL
002306 F3FF 7E               7      LD  A,(HL)
002307 F400 FEE5             7      CP  0E5H
002309 F402 2004            12      JR  NZ,SNAME1
00230B F404 3E05             7      LD  A,5
00230D F406 180E            12      JR  SNAME3
       F408                     SNAME1:
00230F F408 7E               7      LD  A,(HL)
002310 F409 0C               4      INC C
002311 F40A 0D               4      DEC C
002312 F40B 2009            12      JR  NZ,SNAME3
002314 F40D CD27F3          17      CALL    CAP
002317 F410 FEA0             7      CP  0A0H
002319 F412 2002            12      JR  NZ,SNAME3
00231B F414 3E20             7      LD  A,020H
       F416                     SNAME3:
00231D F416 12               7      LD  (DE),A
00231E F417 7E               7      LD  A,(HL)
00231F F418 23               6      INC HL
002320 F419 CD2FF4          17      CALL    FKAN
002323 F41C 10EA            13      DJNZ    SNAME1
       F41E                     WTDB:               ;バッファデータが更新された
002325 F41E 3EFF             7      LD  A,0FFH
002327 F420 3239EE          13      LD  (SFILE),A
00232A F423 32A4EE          13      LD  (_WTDBF),A
00232D F426 AF               4      XOR A
00232E F427 C9              10      RET
                                
       F428                     FKANC:
00232F F428 CB41             8      BIT 0,C
002331 F42A CC30F3          17      CALL    Z,CAP2
002334 F42D 1801            12      JR  FKANX
       F42F                     FKAN:           ;漢字チェック
002336 F42F 13               6      INC DE
       F430                     FKANX:
002337 F430 CB41             8      BIT 0,C
002339 F432 CB81             8      RES 0,C
00233B F434 C0              11      RET NZ
00233C F435 FE80             7      CP  080H
00233E F437 D8              11      RET C
00233F F438 FEA0             7      CP  0A0H
002341 F43A 3803            12      JR  C,FKAN1
002343 F43C FEE0             7      CP  0E0H
002345 F43E D8              11      RET C
       F43F                     FKAN1:
002346 F43F 0C               4      INC C
002347 F440 A7               4      AND A
002348 F441 C9              10      RET
                                
       F442                     CHKWILDX:
002349 F442 FDE5            15      PUSH    IY
00234B F444 E1              10      POP HL
00234C F445 23               6      INC HL
       F446                     CHKWILD:
00234D F446 060B             7      LD  B,11
00234F F448 3E3F             7      LD  A,'?'
       F44A                     CHKWIL1:
002351 F44A BE               7      CP  (HL)
002352 F44B 23               6      INC HL
002353 F44C 37               4      SCF
002354 F44D C8              11      RET Z
002355 F44E 10FA            13      DJNZ    CHKWIL1
002357 F450 AF               4      XOR A
002358 F451 C9              10      RET
                                
       F452                     SDIRENT:        ;IY=FCB HL=DIR
002359 F452 D5              11      PUSH    DE
00235A F453 E5              11      PUSH    HL
00235B F454 FDE5            15      PUSH    IY
00235D F456 D1              10      POP DE
00235E F457 EB               4      EX  DE,HL
00235F F458 CDFBF3          17      CALL    SETNAME
                                ;               Attribute
002362 F45B FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
002365 F45E 12               7      LD  (DE),A
002366 F45F 13               6      INC DE
                                ;               Reserved
002367 F460 AF               4      XOR A
002368 F461 060A             7      LD  B,10
       F463                     SDE1:
00236A F463 12               7      LD  (DE),A
00236B F464 13               6      INC DE
00236C F465 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
00236E F467 21E4EF          10      LD  HL,SDDATA       ;(FCB)更新年月日
002371 F46A 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       F46C                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
002373 F46C 7E               7      LD  A,(HL)
002374 F46D 23               6      INC HL
002375 F46E 3273F4          13      LD  (SDPAT),A
002378 F471 FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       F473                     SDPAT   EQU $-1
00237B F474 12               7      LD  (DE),A
00237C F475 13               6      INC DE
00237D F476 10F4            13      DJNZ    SDLOOP
                                
00237F F478 AF               4      XOR A
002380 F479 E1              10      POP HL
002381 F47A D1              10      POP DE
002382 F47B C9              10      RET
                                
       F47C                     WOPEN:
002383 F47C FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
002386 F47F E61F             7      AND 01FH
002388 F481 37               4      SCF
002389 F482 C0              11      RET NZ
00238A F483 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       F487                     TOPEN2:
00238E F487 AF               4      XOR A
       F488                     TOPEN:              ;Initializes the time stamp
00238F F488 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
002393 F48C C9              10      RET
                                
       F48D                     WRDFX:
002394 F48D 3AFFF2          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       F490                     L_WRFX:
002397 F490 1F               4      RRA         ;->CF
002398 F491 3806            12      JR  C,E_WRFX
00239A F493 CB39             8      SRL C
00239C F495 CB1C             8      RR  H       ;CH=CH/2
00239E F497 18F7            12      JR  L_WRFX
       F499                     E_WRFX:
0023A0 F499 41               4      LD  B,C
0023A1 F49A 4C               4      LD  C,H
0023A2 F49B 03               6      INC BC
0023A3 F49C 3E37             7      LD  A,037H      ;SCF
0023A5 F49E 325DE6          13      LD  (DRDN1),A
                                
       F4A1                     WRDF:               ;BCクラスタ分FATを確保する
0023A8 F4A1 110200          10      LD  DE,2
0023AB F4A4 AF               4      XOR A
0023AC F4A5 32D7E7          13      LD  (_SECPS),A
       F4A8                     WRDF1:
0023AF F4A8 C5              11      PUSH    BC
0023B0 F4A9 D5              11      PUSH    DE
0023B1 F4AA CDF7EE          17      CALL    _GNCL
0023B4 F4AD 381C            12      JR  C,WRDF3
0023B6 F4AF 7A               4      LD  A,D     ;空いているかチェック
0023B7 F4B0 B3               4      OR  E
0023B8 F4B1 202A            12      JR  NZ,WRDF4
0023BA F4B3 E1              10      POP HL      ;HL=空いているクラスタ
0023BB F4B4 E5              11      PUSH    HL
0023BC F4B5 ED5BFEEF        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
0023C0 F4B9 22FEEF          16      LD  (_CLPS),HL
0023C3 F4BC 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
0023C4 F4BD B3               4      OR  E
0023C5 F4BE 2008            12      JR  NZ,WRDF2
0023C7 F4C0 FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
0023CA F4C3 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
0023CD F4C6 1803            12      JR  WRDF3
       F4C8                     WRDF2:
0023CF F4C8 CDFAEE          17      CALL    _SNCL
       F4CB                     WRDF3:
0023D2 F4CB D1              10      POP DE
0023D3 F4CC C1              10      POP BC
0023D4 F4CD D8              11      RET C
0023D5 F4CE 0B               6      DEC BC
0023D6 F4CF 78               4      LD  A,B
0023D7 F4D0 B1               4      OR  C
0023D8 F4D1 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
0023DA F4D3 ED5BFEEF        20      LD  DE,(_CLPS)
0023DE F4D7 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
0023E1 F4DA C3FAEE          10      JP  _SNCL
                                
       F4DD                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
0023E4 F4DD D1              10      POP DE
0023E5 F4DE C1              10      POP BC
       F4DF                     WRDF5:
0023E6 F4DF 13               6      INC DE
0023E7 F4E0 CD18F3          17      CALL    ENDCL
0023EA F4E3 38C3            12      JR  C,WRDF1
0023EC F4E5 37               4      SCF
0023ED F4E6 C9              10      RET
                                
       F4E7                     RWXR:
0023EE F4E7 3A4CE5          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       F4EA                     L_RWX:
0023F1 F4EA 1F               4      RRA     ;->CF
0023F2 F4EB 3808            12      JR  C,E_RWX
0023F4 F4ED CB38             8      SRL B   ;BCH=BCH/2
0023F6 F4EF CB19             8      RR  C   ;
0023F8 F4F1 CB1C             8      RR  H   ;
0023FA F4F3 18F5            12      JR  L_RWX
       F4F5                     E_RWX:
0023FC F4F5 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0023FF F4F8 FD561B          19      LD  D,(IY+27)
002402 F4FB AF               4      XOR A
002403 F4FC 32D7E7          13      LD  (_SECPS),A
       F4FF                     RWX1:
002406 F4FF ED53FEEF        20      LD  (_CLPS),DE
00240A F503 7A               4      LD  A,D
00240B F504 B3               4      OR  E
00240C F505 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
00240E F507 78               4      LD  A,B
00240F F508 B1               4      OR  C
002410 F509 B4               4      OR  H
002411 F50A C8              11      RET Z       ;RET BCH==0 => CF=0
                                
002412 F50B CDDFE7          17      CALL    GNCLX
002415 F50E D8              11      RET C
002416 F50F 7C               4      LD  A,H     ;
002417 F510 25               4      DEC H       ;
002418 F511 B7               4      OR  A       ;DEC BCH
002419 F512 2001            12      JR  NZ,RWX2     ;
00241B F514 0B               6      DEC BC      ;
       F515                     RWX2:
00241C F515 CD18F3          17      CALL    ENDCL
00241F F518 38E5            12      JR  C,RWX1
       F51A                     SCF_RET:
002421 F51A 37               4      SCF
002422 F51B C9              10      RET
                                
       F51C                     DSKF:
002423 F51C 110000          10      LD  DE,0
       F51D                     MAXCLP  EQU $-2
002426 F51F 2AACEE          16      LD  HL,(_FAKEFREE)
002429 F522 7C               4      LD  A,H
00242A F523 B5               4      OR  L
00242B F524 2803            12      JR  Z,DSKF1
00242D F526 110100          10      LD  DE,1
       F529                     DSKF1:
002430 F529 D5              11      PUSH    DE
002431 F52A CDF7EE          17      CALL    _GNCL
002434 F52D 380C            12      JR  C,POPSCF
002436 F52F 7A               4      LD  A,D
002437 F530 B3               4      OR  E
002438 F531 2001            12      JR  NZ,DSKF2
00243A F533 23               6      INC HL
       F534                     DSKF2:
00243B F534 D1              10      POP DE
00243C F535 1B               6      DEC DE
00243D F536 7A               4      LD  A,D
00243E F537 B3               4      OR  E
00243F F538 20EF            12      JR  NZ,DSKF1
002441 F53A C9              10      RET
                                
       F53B                     POPSCF:
002442 F53B F1              10      POP AF
002443 F53C 37               4      SCF
002444 F53D C9              10      RET
                                
       F53E                     SETTMS:
002445 F53E FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
002448 F541 3C               4      INC A
002449 F542 C0              11      RET NZ      ;ファイルが更新されていない
       F543                     SETTMSX:            ;FCBに日付時刻をセットする
00244A F543 CDC7E0          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
00244D F546 CB25             8      SLA L       ;   *2
00244F F548 CB25             8      SLA L       ;   *4
002451 F54A 29              11      ADD HL,HL       ;*2 *8
002452 F54B 29              11      ADD HL,HL       ;*4 *16
002453 F54C 29              11      ADD HL,HL       ;*8 *32
002454 F54D 7A               4      LD  A,D
002455 F54E 0F               4      RRCA            ;bit.0->7->->->0->C
002456 F54F E61F             7      AND 01FH
002458 F551 B5               4      OR  L
002459 F552 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
00245C F555 FD7417          19      LD  (IY+23),H
                                
00245F F558 CDA0E0          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
002462 F55B 0144F8          10      LD  BC,0-1980
002465 F55E 09              11      ADD HL,BC
002466 F55F 65               4      LD  H,L
                                
002467 F560 7A               4      LD  A,D
002468 F561 87               4      ADD A,A     ;*2
002469 F562 87               4      ADD A,A     ;*4
00246A F563 87               4      ADD A,A     ;*8
00246B F564 87               4      ADD A,A     ;*16
00246C F565 6F               4      LD  L,A
00246D F566 29              11      ADD HL,HL       ;*32
00246E F567 7D               4      LD  A,L
00246F F568 B3               4      OR  E
002470 F569 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
002473 F56C FD7415          19      LD  (IY+21),H
002476 F56F C9              10      RET
                                ;(16)
       F570                     PUSHRR:
002477 F570 3210E6          13      LD  (SETSEQ_SWC_RND),A
00247A F573 2222E6          16      LD  (SETSEQ_SWC_SEQ_RR),HL
00247D F576 CD96F5          17      CALL    GET_RR_AHL
002480 F579 220FEE          16      LD  (RR_BUF_HL),HL
002483 F57C 3211EE          13      LD  (RR_BUF_A),A
002486 F57F C9              10      RET
                                ;(14)
       F580                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
002487 F580 87               4      ADD A,A     ;in BHLA => out AHL
002488 F581 ED6A            15      ADC HL,HL
00248A F583 CB18             8      RR  B
00248C F585 B7               4      OR  A
00248D F586 78               4      LD  A,B     ;ここでフラグは変化しない
00248E F587 C8              11      RET Z
00248F F588 2C               4      INC L       ;INC AHL
002490 F589 C0              11      RET NZ      ;
002491 F58A 24               4      INC H       ;
002492 F58B C0              11      RET NZ      ;
002493 F58C 3C               4      INC A       ;
002494 F58D C9              10      RET
                                ;(18)
       F58E                     INIT_RND:
002495 F58E 3ECD             7      LD  A,0CDH      ;CALL ????
002497 F590 21ADF5          10      LD  HL,POPRR
00249A F593 CD70F5          17      CALL    PUSHRR
       F596                     GET_RR_AHL:
00249D F596 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0024A0 F599 FD6622          19      LD  H,(IY+34)   ;
0024A3 F59C FD7E23          19      LD  A,(IY+35)   ;
0024A6 F59F C9              10      RET
                                ;(10)
       F5A0                     SET_RR_AHL:
0024A7 F5A0 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0024AA F5A3 FD7422          19      LD  (IY+34),H   ;
0024AD F5A6 FD7723          19      LD  (IY+35),A   ;
0024B0 F5A9 C9              10      RET
                                ;(17)
       F5AA                     SETSEQ:
0024B1 F5AA CDCFF5          17      CALL    SETSEQ1
       F5AD                     POPRR:
0024B4 F5AD F5              11      PUSH    AF
0024B5 F5AE E5              11      PUSH    HL
0024B6 F5AF 2A0FEE          16      LD  HL,(RR_BUF_HL)
0024B9 F5B2 3A11EE          13      LD  A,(RR_BUF_A)
0024BC F5B5 CDA0F5          17      CALL    SET_RR_AHL
0024BF F5B8 E1              10      POP HL
0024C0 F5B9 F1              10      POP AF
0024C1 F5BA C9              10      RET
                                ;(20)
       F5BB                     GET_RR_BCDE:            ;BCDE=Random record
0024C2 F5BB FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
0024C5 F5BE FD5622          19      LD  D,(IY+34)
0024C8 F5C1 FD4E23          19      LD  C,(IY+35)
0024CB F5C4 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
0024CD F5C6 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0024D1 F5CA C0              11      RET NZ
0024D2 F5CB FD4624          19      LD  B,(IY+36)
0024D5 F5CE C9              10      RET
                                
       F5CF                     SETSEQ1:
0024D6 F5CF F5              11      PUSH    AF
0024D7 F5D0 E5              11      PUSH    HL      ;AHL=Random record
0024D8 F5D1 CD96F5          17      CALL    GET_RR_AHL
0024DB F5D4 47               4      LD  B,A     ;AHL→HLA
0024DC F5D5 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
0024DD F5D6 6C               4      LD  L,H     ;(IY+34)
0024DE F5D7 60               4      LD  H,B     ;(IY+35)
0024DF F5D8 0600             7      LD  B,0
                                
0024E1 F5DA CD80F5          17      CALL    GET_CPM_R_SIZE
                                
0024E4 F5DD 29              11      ADD HL,HL
0024E5 F5DE CB3D             8      SRL L       ;L=L/2
0024E7 F5E0 FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
0024EA F5E3 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
0024ED F5E6 E1              10      POP HL
0024EE F5E7 F1              10      POP AF
0024EF F5E8 C9              10      RET
                                
                                ;(23)
       F5E9                     RBXEND:             ;レコード数だけランダムレコードを進める
0024F0 F5E9 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       F5EA                     RBSIZE  EQU $-2
0024F3 F5EC CD96F5          17      CALL    GET_RR_AHL
0024F6 F5EF 19              11      ADD HL,DE
0024F7 F5F0 CE00             7      ADC A,0
0024F9 F5F2 CDA0F5          17      CALL    SET_RR_AHL
0024FC F5F5 EB               4      EX  DE,HL       ;HL=進めるレコード数
0024FD F5F6 D0              11      RET NC
0024FE F5F7 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
002502 F5FB C0              11      RET NZ
002503 F5FC FD3424          23      INC (IY+36)
002506 F5FF C9              10      RET
       F600                     FILE_E:
                                
       F1AA                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       F1AA                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       F1AA                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       F1AA                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       F1AA                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "88DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   PC-8801mkIISR
                                
       F600                     _DEVICE:
                                
                                ;   A:
                                
002507 F600 0200                    DW  2   ;DPB_FATLN
002509 F602 EBEE                    DW  _FDRD   ;DPB_DRD
00250B F604 EEEE                    DW  _FDWT   ;DPB_DWT
00250D F606 FD                      DB  0FDH    ;DPB_FATID
00250E F607 02                      DB  2   ;DPB_SECPCL
00250F F608 6401                    DW  356 ;DPB_MAXCL
002511 F60A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002512 F60B 07                      DB  7   ;DPB_DIRSCNT
002513 F60C 28                      DB  40  ;DPB_MAXCYL
002514 F60D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002515 F60E 01                      DB  1   ;DPB_FATPS
002516 F60F 82                      DB  082H    ;DPB_BPS
002517 F610 0500                    DW  5   ;DPB_DIRPS
002519 F612 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00251A F613 00                      DB  0   ;DPB_UNITNO
00251B F614 0800                    DW  8   ;DPB_ADDCL
00251D F616 0000                    DW  0   ;DPB_16
00251F F618 0000                    DW  0   ;DPB_18
002521 F61A 0000                    DW  0   ;DPB_SDIR
002523 F61C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002527 F620 0200                    DW  2   ;DPB_FATLN
002529 F622 EBEE                    DW  _FDRD   ;DPB_DRD
00252B F624 EEEE                    DW  _FDWT   ;DPB_DWT
00252D F626 FD                      DB  0FDH    ;DPB_FATID
00252E F627 02                      DB  2   ;DPB_SECPCL
00252F F628 6401                    DW  356 ;DPB_MAXCL
002531 F62A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002532 F62B 07                      DB  7   ;DPB_DIRSCNT
002533 F62C 28                      DB  40  ;DPB_MAXCYL
002534 F62D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002535 F62E 01                      DB  1   ;DPB_FATPS
002536 F62F 82                      DB  082H    ;DPB_BPS
002537 F630 0500                    DW  5   ;DPB_DIRPS
002539 F632 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00253A F633 01                      DB  1   ;DPB_UNITNO
00253B F634 0800                    DW  8   ;DPB_ADDCL
00253D F636 0000                    DW  0   ;DPB_16
00253F F638 0000                    DW  0   ;DPB_18
002541 F63A 0000                    DW  0   ;DPB_SDIR
002543 F63C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002547 F640                         DS  32
                                
                                ;   D:
                                
002567 F660                         DS  32
                                
                                ;   E:
                                
002587 F680                         DS  32
                                
                                ;   F:
                                
0025A7 F6A0 0000                BANKFL: DW  0   ;DPB_FATLN
0025A9 F6A2 5FDD                    DW  BDRD    ;DPB_DRD
0025AB F6A4 5BDD                    DW  BDWT    ;DPB_DWT
0025AD F6A6 F9                      DB  0F9H    ;DPB_FATID
0025AE F6A7 02                      DB  2   ;DPB_SECPCL
0025AF F6A8 0000                BANKCL: DW  0   ;DPB_MAXCL
0025B1 F6AA 00                      DB  0   ;DPB_FDMODE
0025B2 F6AB 08                      DB  8   ;DPB_DIRSCNT
0025B3 F6AC 00                      DB  0   ;DPB_MAXCYL
0025B4 F6AD 01                      DB  1   ;DPB_MAXSEC
0025B5 F6AE 00                      DB  0   ;DPB_FATPS
0025B6 F6AF 02                      DB  2   ;DPB_BPS
0025B7 F6B0 0200                    DW  2   ;DPB_DIRPS
0025B9 F6B2 0B                  BANKDV: DB  00BH    ;DPB_DEVICE
0025BA F6B3 00                      DB  0   ;DPB_UNITNO
0025BB F6B4 0600                    DW  6   ;DPB_ADDCL
0025BD F6B6 0000                    DW  0   ;DPB_16
0025BF F6B8 0000                    DW  0   ;DPB_18
0025C1 F6BA 0000                    DW  0   ;DPB_SDIR
0025C3 F6BC 454D454D                DB  "EMEM"  ;DPB_NAME
                                
                                ;   G:
                                
0025C7 F6C0                         DS  32
                                
                                ;   H:
0025E7 F6E0                         DS  32-8
0025FF F6F8 00                      DB  0
[EOF:88DPB.ASM:UTF_8]
                                
       F6F9                     LAST_ADR:
                                
                                    END
[EOF:88.ASM:UTF_8]
