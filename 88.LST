                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for PC-8801mkIISR
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "88DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   PC-8001mkIISR
                                
       0002                     MAC EQU 2   ;PC-8001mkIISR
       0001                     DEV EQU 1
                                
       011D                     VER_6F  EQU 0011DH
                                
       D100                     RUN EQU 0D100H
       D0F9                     OFFSET  EQU RUN-7
                                
       D906                     BDOS    EQU 0D906H
       EE00                     WORKAD  EQU 0EE00H
       F700                     FATBF   EQU 0F700H
       FD00                     DTBUF   EQU 0FD00H
       FF20                     KBUF    EQU 0FF20H
       FFBB                     SUBSYS  EQU EXTBIO-5*3
       FFD9                     TRAP38  EQU 0FFD9H
       0050                     WIDTH   EQU 80
       0018                     LINE    EQU 24
       0000                     COLORF  EQU 0
       0014                     KEYSP_H EQU 20
       0000                     KEYSP_L EQU 0
       0008                     COMS    EQU 8
       0002                     MAX_SEC_SZ_H    EQU 2       ;1セクタ1024バイトのサポート(2:off 4:on)
       0100                     BUFFER  EQU 00100H
       D9FD                     S27BUF_COM  EQU S27BUF
                                
                                ; ディスクサブシステム
       002A                     MAIN        EQU 0002AH
                                
       4000                     DSS_DATA    EQU 04000H
                                
       7C00                     DSS     EQU 07C00H
[EOF:88DEF.ASM:SHIFT_JIS]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0002                     VER_3   EQU 2
       1D02                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0102                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0162                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 D0F9                         ORG OFFSET
                                
                                ;   MSX BINARY HEADER
000000 D0F9 FE                      DB  0FEH
                                ;   MSX BINARY START ADDRESS
000001 D0FA 00D1                    DW  RUN
                                ;   MSX BINARY END ADDRESS
000003 D0FC F9F6                    DW  LAST_ADR
                                ;   MSX BINARY EXEC ADDRESS
000005 D0FE 07D1                    DW  START
                                
                                    INCLUDE "88INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   PC-8801mkIISR
                                
000007 D100 C307D1          10      JP  START
00000A D103 021D                    DW  MACW
00000C D105 6201                    DW  VER
                                
       D107                     START:
00000E D107 F3               4      DI
00000F D108 ED5E             8      IM  2
000011 D10A 3107D1          10      LD  SP,START
000014 D10D CD1BD1          17      CALL    INIT        ;NZならAUTOEXECを実行
000017 D110 210000          10      LD  HL,0
00001A D113 E5              11      PUSH    HL
00001B D114 C8              11      RET Z
00001C D115 11ACD2          10      LD  DE,AUTOD
00001F D118 C3FDEE          10      JP  _COMANL
                                
       D11B                     INIT:
000022 D11B DB32            11      IN  A,(032H)
000024 D11D E6EF             7      AND 0EFH        ;高速RAMアクセスモード/高速RAM
000026 D11F D332            11      OUT (032H),A
                                
000028 D121 21C8F3          10      LD  HL,0F3C8H   ;テキストをクリア
00002B D124 11E880          10      LD  DE,080E8H
00002E D127 0E20             7      LD  C,' '
000030 D129 3E19             7      LD  A,25
       D12B                     TVCL1:
000032 D12B 0650             7      LD  B,80
       D12D                     TVCL2:
000034 D12D 71               7      LD  (HL),C
000035 D12E 23               6      INC HL
000036 D12F 10FC            13      DJNZ    TVCL2
000038 D131 0614             7      LD  B,20
       D133                     TVCL3:
00003A D133 72               7      LD  (HL),D
00003B D134 2C               4      INC L
00003C D135 73               7      LD  (HL),E
00003D D136 23               6      INC HL
00003E D137 10FA            13      DJNZ    TVCL3
000040 D139 3D               4      DEC A
000041 D13A 20EF            12      JR  NZ,TVCL1
                                
000043 D13C 2129D3          10      LD  HL,AT_VRAM
000046 D13F 1100F0          10      LD  DE,0F000H
000049 D142 01F002          10      LD  BC,AT_VRAME-AT_VRAM
00004C D145 EDB0                    LDIR
                                
00004E D147 DB32            11      IN  A,(032H)
000050 D149 F610             7      OR  010H        ;高速RAMアクセスモード/メインRAM
000052 D14B D332            11      OUT (032H),A
       D14D                     INIT_CRTC:
000054 D14D 3E03             7      LD  A,3     ;80桁
000056 D14F D330            11      OUT (030H),A
000058 D151 32BEEE          13      LD  (WK30),A
                                
00005B D154 3E22             7      LD  A,022H      ;25行 64K RAM
00005D D156 D331            11      OUT (031H),A
00005F D158 32BFEE          13      LD  (WK31),A
                                
000062 D15B 3EFF             7      LD  A,0FFH
000064 D15D D3E4            11      OUT (0E4H),A    ;割り込みレベル設定
000066 D15F 32B7EE          13      LD  (WKE4),A
000069 D162 3E00             7      LD  A,0
00006B D164 D3E6            11      OUT (0E6H),A    ;割り込みマスク
                                
00006D D166 3E19             7      LD  A,019H
00006F D168 D340            11      OUT (040H),A    ;CRT I/F 同期ビットオン
000071 D16A 32B9EE          13      LD  (WK40),A
000074 D16D CD94E2          17      CALL    VBLANK
                                
000077 D170 AF               4      XOR A
000078 D171 D351            11      OUT (051H),A    ;Reset CRTC
00007A D173 3EA0             7      LD  A,0A0H
00007C D175 D368            11      OUT (068H),A    ;DMAC: Mode Set(Reset)
00007E D177 21C8F3          10      LD  HL,0F3C8H
000081 D17A 22B2EE          16      LD  (TVRAMTOP),HL
000084 D17D 0E64             7      LD  C,064H
000086 D17F ED69            12      OUT (C),L       ;TVRAM LOW
000088 D181 ED61            12      OUT (C),H       ;TVRAM HIGH
00008A D183 21B78B          10      LD  HL,08000H+120*25-1
00008D D186 0C               4      INC C       ;65H
00008E D187 ED69            12      OUT (C),L
000090 D189 ED61            12      OUT (C),H
000092 D18B 3ECE             7      LD  A,080H+80-2
000094 D18D D350            11      OUT (050H),A
000096 D18F 3E98             7      LD  A,080H+25-1
000098 D191 D350            11      OUT (050H),A
00009A D193 DB40            11      IN  A,(040H)
00009C D195 CB4F             8      BIT 1,A
00009E D197 21DE67          10      LD  HL,067DEH
0000A1 D19A 2003            12      JR  NZ,RESO1
0000A3 D19C 21586F          10      LD  HL,06F58H
       D19F                     RESO1:
0000A6 D19F 0E50             7      LD  C,050H
0000A8 D1A1 ED61            12      OUT (C),H
0000AA D1A3 ED69            12      OUT (C),L
                                
0000AC D1A5 3E53             7      LD  A,053H
0000AE D1A7 D350            11      OUT (050H),A
                                
0000B0 D1A9 3E43             7      LD  A,043H
0000B2 D1AB D351            11      OUT (051H),A
                                
0000B4 D1AD 3EE4             7      LD  A,0E4H
0000B6 D1AF D368            11      OUT (068H),A
                                
0000B8 D1B1 3E20             7      LD  A,020H
0000BA D1B3 D351            11      OUT (051H),A
                                
0000BC D1B5 CD94E2          17      CALL    VBLANK
       D1B8                     IVBL1:
0000BF D1B8 DB40            11      IN  A,(040H)
0000C1 D1BA CB6F             8      BIT 5,A
0000C3 D1BC 20FA            12      JR  NZ,IVBL1
                                
0000C5 D1BE 3E11             7      LD  A,011H
0000C7 D1C0 D340            11      OUT (040H),A    ;CRT I/F 同期ビットオフ
0000C9 D1C2 32B9EE          13      LD  (WK40),A
       D1C5                     BANK:
0000CC D1C5 01E300          10      LD  BC,000E3H   ;拡張RAM バンク選択
0000CF D1C8 21007F          10      LD  HL,07F00H
0000D2 D1CB 56               7      LD  D,(HL)
0000D3 D1CC F3               4      DI
0000D4 D1CD 3E01             7      LD  A,1     ;リード可
0000D6 D1CF D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
0000D8 D1D1 ED41            12      OUT (C),B       ;拡張RAM バンク選択
0000DA D1D3 3A0000          13      LD  A,(0)
0000DD D1D6 FEEB             7      CP  0EBH
0000DF D1D8 2005            12      JR  NZ,BANK1
0000E1 D1DA 3E2B             7      LD  A,02BH
0000E3 D1DC 32B2F6          13      LD  (BANKDV),A
       D1DF                     BANK1:
0000E6 D1DF 3E01             7      LD  A,1     ;リード可
0000E8 D1E1 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
0000EA D1E3 ED41            12      OUT (C),B       ;拡張RAM バンク選択
0000EC D1E5 5E               7      LD  E,(HL)
0000ED D1E6 7B               4      LD  A,E
0000EE D1E7 C6A5             7      ADD A,0A5H
0000F0 D1E9 77               7      LD  (HL),A      ;メインメモリに書き込む
0000F1 D1EA BE               7      CP  (HL)
0000F2 D1EB 2811            12      JR  Z,BANK2     ;メインメモリが反映されているか？
0000F4 D1ED 3E11             7      LD  A,011H      ;ライト/リード可
0000F6 D1EF D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
0000F8 D1F1 7B               4      LD  A,E
0000F9 D1F2 C6A5             7      ADD A,0A5H
0000FB D1F4 77               7      LD  (HL),A
0000FC D1F5 BE               7      CP  (HL)
0000FD D1F6 73               7      LD  (HL),E      ;拡張RAM に元の値を戻す
0000FE D1F7 2005            12      JR  NZ,BANK2    ;拡張RAM に反映しているか？
000100 D1F9 04               4      INC B
000101 D1FA CB60             8      BIT 4,B
000103 D1FC 28E1            12      JR  Z,BANK1
       D1FE                     BANK2:
000105 D1FE AF               4      XOR A       ;ライト/リード不可
000106 D1FF D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000108 D201 72               7      LD  (HL),D      ;メインメモリ に元の値を戻す
000109 D202 78               4      LD  A,B
00010A D203 B7               4      OR  A
00010B D204 2814            12      JR  Z,NOBANK
00010D D206 68               4      LD  L,B
00010E D207 2600             7      LD  H,0
000110 D209 29              11      ADD HL,HL   ;*2
000111 D20A 29              11      ADD HL,HL   ;*4
000112 D20B 29              11      ADD HL,HL   ;*8
000113 D20C 29              11      ADD HL,HL   ;*16
000114 D20D 29              11      ADD HL,HL   ;*32
000115 D20E 2B               6      DEC HL  ;-1
000116 D20F 2B               6      DEC HL  ;-2
000117 D210 2B               6      DEC HL  ;-3
000118 D211 22A8F6          16      LD  (BANKCL),HL
00011B D214 CD9CD2          17      CALL    CALC_FATLN
00011E D217 32A0F6          13      LD  (BANKFL),A
       D21A                     NOBANK:
                                                ;初期化
000121 D21A AF               4      XOR A       ;イニシャライズ
000122 D21B CDDCEA          17      CALL    PUTCOM
000125 D21E 3E16             7      LD  A,16H       ;高速レシーブメモリ
000127 D220 CDDCEA          17      CALL    PUTCOM
00012A D223 3E7C             7      LD  A,DSS/256   ;開始アドレスH
00012C D225 CDE2EA          17      CALL    PUTDAT
00012F D228 AF               4      XOR A       ;開始アドレスL
000130 D229 CDE2EA          17      CALL    PUTDAT
000133 D22C 015F02          10      LD  BC,AT_DSSE-AT_DSS
000136 D22F CB41             8      BIT 0,C
000138 D231 2801            12      JR  Z,SUBPG1
00013A D233 03               6      INC BC      ;偶数にする
       D234                     SUBPG1:
00013B D234 78               4      LD  A,B     ;バイト数H
00013C D235 CDE2EA          17      CALL    PUTDAT
00013F D238 79               4      LD  A,C
000140 D239 CDE2EA          17      CALL    PUTDAT
000143 D23C 2119D6          10      LD  HL,AT_DSS
000146 D23F CD26EB          17      CALL    FPUTDAT
                                
000149 D242 210000          10      LD  HL,0
00014C D245 065C             7      LD  B,05CH
00014E D247 3E                      DB  03EH    ;LD A,??
00014F D248 FF              12      RST 38H
000150 D249 CDB6F0          17      CALL    FILL_MEMORY
000153 D24C 06A4             7      LD  B,0A4H
000155 D24E AF               4      XOR A
000156 D24F 320400          13      LD  (_DVSW),A
000159 D252 CDB6F0          17      CALL    FILL_MEMORY
                                
00015C D255 3EC3             7      LD  A,0C3H      ;JP
00015E D257 2103EE          10      LD  HL,CPM_WBOOT
000161 D25A 320000          13      LD  (00000H),A
000164 D25D 220100          16      LD  (00001H),HL ;IPL
                                
000167 D260 2106D9          10      LD  HL,BDOS
00016A D263 320500          13      LD  (00005H),A
00016D D266 220600          16      LD  (00006H),HL ;BDOS
                                
000170 D269 21D9FF          10      LD  HL,TRAP38   ;TRAP38
000173 D26C 323800          13      LD  (00038H),A
000176 D26F 223900          16      LD  (00039H),HL ;RST 038H
                                
000179 D272 3EEE             7      LD  A,CPM_BOOT/256
00017B D274 320B00          13      LD  (0000BH),A
                                
00017E D277 3E                      DB  03EH    ;LD A,??
00017F D278 E9               4      JP  (HL)
000180 D279 320F00          13      LD  (0000FH),A
                                
000183 D27C 21B8D2          10      LD  HL,INIMES
000186 D27F CDDFDD          17      CALL    MSX
       D282                     INIT1:
000189 D282 F3               4      DI
00018A D283 1100FF          10      LD  DE,0FF00H
00018D D286 06BB             7      LD  B,SUBSYS%256
00018F D288 CD3FDC          17      CALL    ZERO_MEMORY_DE
                                
000192 D28B 21E4D2          10      LD  HL,AT_SUBSYS
000195 D28E 11BBFF          10      LD  DE,SUBSYS
000198 D291 014500          10      LD  BC,AT_TRAPE-AT_SUBSYS
00019B D294 EDB0                    LDIR
                                
00019D D296 CD23E2          17      CALL    CHKEY
0001A0 D299 FE03             7      CP  3
0001A2 D29B C9              10      RET
                                
       D29C                     CALC_FATLN: ;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
0001A3 D29C 5D               4      LD  E,L
0001A4 D29D 54               4      LD  D,H
0001A5 D29E 29              11      ADD HL,HL   ;*2
0001A6 D29F 19              11      ADD HL,DE   ;*3
0001A7 D2A0 CB3C             8      SRL H   ;/2
0001A9 D2A2 CB1D             8      RR  L   ;1クラスタ辺り1.5バイト必要
0001AB D2A4 11FF01          10      LD  DE,511  ;切り上げる
0001AE D2A7 19              11      ADD HL,DE
0001AF D2A8 7C               4      LD  A,H
0001B0 D2A9 CB3F             8      SRL A
0001B2 D2AB C9              10      RET
                                
0001B3 D2AC 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
0001BC D2B5 413A00              AUTODV: DB  "A:",0
                                
0001BF D2B8 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for PC-8801mkIISR v"
            6765727320666F72    
            2050432D38383031    
            6D6B494953522076    
0001DF D2D8 312E                    DB  030H + VER_1, '.'
0001E1 D2DA 3632                    DB  030H + VER_2 ,030H + VER_3
0001E3 D2DC                         DB  ''
0001E3 D2DC 2047616B750D0A          DB  " Gaku",0DH,0AH
0001EA D2E3 00                      DB  0
                                
       D2E4                     AT_SUBSYS:
0001EB FFBB                         ORG SUBSYS,AT_SUBSYS-OFFSET
0001EB FFBB C3DCEA          10      JP  PUTCOM
0001EE FFBE C3E2EA          10      JP  PUTDAT
0001F1 FFC1 C307EB          10      JP  GETDAT
0001F4 FFC4 C326EB          10      JP  FPUTDAT
0001F7 FFC7 C351EB          10      JP  FGETDAT
                                ;EXTBIO
0001FA FFCA C9              10      RET
0001FB FFCB                         DS  14,0FFH
                                ;TRAP38:
000209 FFD9 210000          10      LD  HL,0
00020C FFDC E3              19      EX  (SP),HL
00020D FFDD 3E24             7      LD  A,'$'
00020F FFDF CD19E3          17      CALL    MSG_A
000212 FFE2 2B               6      DEC HL
000213 FFE3 7C               4      LD  A,H
000214 FFE4 CDE8FF          17      CALL    PRHX
000217 FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
000218 FFE8 F5              11      PUSH    AF
000219 FFE9 07               4      RLCA
00021A FFEA 07               4      RLCA
00021B FFEB 07               4      RLCA
00021C FFEC 07               4      RLCA
00021D FFED CDF1FF          17      CALL    PRHX2
000220 FFF0 F1              10      POP AF
       FFF1                     PRHX2:
000221 FFF1 E60F             7      AND 00FH
000223 FFF3 FE0A             7      CP  10
000225 FFF5 3F               4      CCF
000226 FFF6 CE30             7      ADC A,'0'
000228 FFF8 27               4      DAA
000229 FFF9 C319E3          10      JP  MSG_A
00022C FFFC                         DS  4
000230 D329                         ORG $$+OFFSET,$$    ;$DEPHASE
       D329                     AT_TRAPE:
[EOF:88INIT.ASM:SHIFT_JIS]
                                    INCLUDE "88VRAM.ASM"
                                
                                ;   LSX-Dodgers VRAM
                                ;   PC-8801mkIISR
                                
       D329                     AT_VRAM:
000230 F000                         ORG 0F000H,AT_VRAM-OFFSET
       F000                     ESC1:
000230 F000 7B               4      LD  A,E
000231 F001 FE41             7      CP  'A'
000233 F003 CAC1F0          10      JP  Z,CTRL1E
000236 F006 FE42             7      CP  'B'
000238 F008 CA71F1          10      JP  Z,CTRL1F
00023B F00B FE43             7      CP  'C'
00023D F00D CA89F0          10      JP  Z,CTRL1C
000240 F010 FE44             7      CP  'D'
000242 F012 CAADF0          10      JP  Z,CTRL1D
000245 F015 FE45             7      CP  'E'
000247 F017 2802            12      JR  Z,CT0CX
000249 F019 FE6A             7      CP  'j'
       F01B                     CT0CX:
00024B F01B CA49F1          10      JP  Z,CTRL0C
00024E F01E FE48             7      CP  'H'
000250 F020 CA16F1          10      JP  Z,CTRL0B
000253 F023 FE4A             7      CP  'J'
000255 F025 CA4CF1          10      JP  Z,CTRL06
000258 F028 FE4B             7      CP  'K'
00025A F02A CAF5F0          10      JP  Z,CTRL05
00025D F02D FE4C             7      CP  'L'
00025F F02F CA78F1          10      JP  Z,CTRL0E
000262 F032 FE54             7      CP  'T'
000264 F034 CAF5F0          10      JP  Z,CTRL05
000267 F037 FE78             7      CP  'x'
000269 F039 2804            12      JR  Z,ESC1X
00026B F03B FE79             7      CP  'y'
00026D F03D 2002            12      JR  NZ,ESC1Y
       F03F                     ESC1X:
00026F F03F 3601            10      LD  (HL),1
       F041                     ESC1Y:
000271 F041 FE3D             7      CP  '='
000273 F043 2804            12      JR  Z,ESC1W
000275 F045 FE59             7      CP  'Y'
000277 F047 2002            12      JR  NZ,ESC1Z
       F049                     ESC1W:
000279 F049 3602            10      LD  (HL),2
       F04B                     ESC1Z:
00027B F04B FE20             7      CP  020H
00027D F04D 3802            12      JR  C,ESC1C
00027F F04F 87               4      ADD A,A
000280 F050 D0              11      RET NC
       F051                     ESC1C:
000281 F051 E1              10      POP HL
000282 F052 C360E1          10      JP  ANK
                                
       F055                     ESC:
000285 F055 2167E1          10      LD  HL,PRINTE5
000288 F058 E5              11      PUSH    HL
000289 F059 2152E1          10      LD  HL,ESCFLG
00028C F05C 3600            10      LD  (HL),0
00028E F05E 3D               4      DEC A
00028F F05F 289F            12      JR  Z,ESC1
000291 F061 3D               4      DEC A
000292 F062 2009            12      JR  NZ,ESC2
000294 F064 3603            10      LD  (HL),3
000296 F066 7B               4      LD  A,E
000297 F067 D620             7      SUB 020H
000299 F069 3270F0          13      LD  (ESCYP+1),A
00029C F06C C9              10      RET
       F06D                     ESC2:
00029D F06D 3D               4      DEC A
00029E F06E C0              11      RET NZ
00029F F06F 2600             7  ESCYP:  LD  H,0
0002A1 F071 7B               4      LD  A,E
0002A2 F072 D620             7      SUB 020H
0002A4 F074 6F               4      LD  L,A
0002A5 F075 C3D6EE          10      JP  _LOC
                                
       F078                     CTRL:
0002A8 F078 7B               4      LD  A,E
0002A9 F079 87               4      ADD A,A
0002AA F07A F680             7      OR  080H
0002AC F07C 6F               4      LD  L,A
0002AD F07D 26EF             7      LD  H,CTRLTB/256
0002AF F07F 7E               7      LD  A,(HL)
0002B0 F080 2C               4      INC L
0002B1 F081 66               7      LD  H,(HL)
0002B2 F082 6F               4      LD  L,A
0002B3 F083 CD62E0          17      CALL    JPHL
0002B6 F086 C367E1          10      JP  PRINTE5
                                
       F089                     CTRL1C:
0002B9 F089 2A8EEE          16      LD  HL,(_TXADR)
0002BC F08C 2C               4      INC L
       F08D                     PRINTE3:
0002BD F08D 3E50             7      LD  A,WIDTH
0002BF F08F 3D               4      DEC A
0002C0 F090 BD               4      CP  L
0002C1 F091 3009            12      JR  NC,SET_TXADR_HL
0002C3 F093 2E00             7      LD  L,0
0002C5 F095 24               4      INC H
       F096                     PRINTE8:
0002C6 F096 3A97EE          13      LD  A,(_LINE)
0002C9 F099 BC               4      CP  H
0002CA F09A 2804            12      JR  Z,PRINT2
       F09C                     LOC:
       F09C                     SET_TXADR_HL:
0002CC F09C 228EEE          16      LD  (_TXADR),HL
       F09F                     CTRL00:
0002CF F09F C9              10      RET
                                
       F0A0                     PRINT2:
0002D0 F0A0 CD7EF1          17      CALL    SCR
0002D3 F0A3 25               4      DEC H
0002D4 F0A4 18F6            12      JR  SET_TXADR_HL
                                
       F0A6                     CTRL08:
0002D6 F0A6 3A5DE1          13      LD  A,(INSFLG)
0002D9 F0A9 FECD             7      CP  0CDH        ;CALL ????
0002DB F0AB 2828            12      JR  Z,CTRL02
       F0AD                     CTRL1D:
0002DD F0AD 2A8EEE          16      LD  HL,(_TXADR)
0002E0 F0B0 7C               4      LD  A,H
0002E1 F0B1 B5               4      OR  L
0002E2 F0B2 C8              11      RET Z
0002E3 F0B3 7D               4      LD  A,L
0002E4 F0B4 B7               4      OR  A
0002E5 F0B5 2803            12      JR  Z,CTRL1DX1
0002E7 F0B7 2D               4      DEC L
0002E8 F0B8 18E2            12      JR  SET_TXADR_HL
       F0BA                     CTRL1DX1:
0002EA F0BA 3E50             7      LD  A,WIDTH
0002EC F0BC 3D               4      DEC A
0002ED F0BD 6F               4      LD  L,A
0002EE F0BE 25               4      DEC H
0002EF F0BF 18DB            12      JR  SET_TXADR_HL
       F0C1                     CTRL1E:
0002F1 F0C1 2A8EEE          16      LD  HL,(_TXADR)
0002F4 F0C4 7C               4      LD  A,H
0002F5 F0C5 B7               4      OR  A
0002F6 F0C6 C8              11      RET Z
0002F7 F0C7 25               4      DEC H
0002F8 F0C8 18D2            12      JR  SET_TXADR_HL
                                
       F0CA                     CTRL09:
0002FA F0CA 2A8EEE          16      LD  HL,(_TXADR)
0002FD F0CD 7D               4      LD  A,L
0002FE F0CE E6F8             7      AND 0F8H
000300 F0D0 C608             7      ADD A,8
000302 F0D2 6F               4      LD  L,A
000303 F0D3 18B8            12      JR  PRINTE3
                                
       F0D5                     CTRL02:
000305 F0D5 3A8EEE          13      LD  A,(_TXADR)
000308 F0D8 B7               4      OR  A
000309 F0D9 28D2            12      JR  Z,CTRL1D
00030B F0DB CDADF0          17      CALL    CTRL1D
00030E F0DE 2A8EEE          16      LD  HL,(_TXADR)
000311 F0E1 3E50             7      LD  A,WIDTH
000313 F0E3 4F               4      LD  C,A
000314 F0E4 95               4      SUB L
000315 F0E5 47               4      LD  B,A
000316 F0E6 79               4      LD  A,C
000317 F0E7 3D               4      DEC A
000318 F0E8 6F               4      LD  L,A
000319 F0E9 CD71E1          17      CALL    LOC1
                                
00031C F0EC 3E20             7      LD  A,020H
       F0EE                     C8X1:
00031E F0EE 4E               7      LD  C,(HL)
00031F F0EF 77               7      LD  (HL),A
000320 F0F0 2B               6      DEC HL
000321 F0F1 79               4      LD  A,C
000322 F0F2 10FA            13      DJNZ    C8X1
000324 F0F4 C9              10      RET
                                
       F0F5                     CTRL05:
000325 F0F5 CDD3EE          17      CALL    _POS
000328 F0F8 2A8EEE          16      LD  HL,(_TXADR)
00032B F0FB 3E50             7      LD  A,WIDTH
00032D F0FD 95               4      SUB L
00032E F0FE 47               4      LD  B,A
00032F F0FF CD6EE1          17      CALL    LOC0
       F102                     CLLINE:
000332 F102 3E20             7      LD  A,020H
       F104                     CLLINE1:
000334 F104 77               7      LD  (HL),A
000335 F105 23               6      INC HL
000336 F106 10FC            13      DJNZ    CLLINE1
000338 F108 C9              10      RET
                                
       F109                     CTRL0D:
000339 F109 AF               4      XOR A
00033A F10A 328EEE          13      LD  (_TXADR),A
00033D F10D C9              10      RET
                                
       F10E                     CTRL12:
00033E F10E 215DE1          10      LD  HL,INSFLG
000341 F111 7E               7      LD  A,(HL)
000342 F112 EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000344 F114 77               7      LD  (HL),A
000345 F115 C9              10      RET
                                
       F116                     CTRL0B:
000346 F116 210000          10      LD  HL,0
000349 F119 228EEE          16      LD  (_TXADR),HL
00034C F11C C9              10      RET
                                
       F11D                     CTRL1B:
00034D F11D 3E01             7      LD  A,1
00034F F11F 3252E1          13      LD  (ESCFLG),A
000352 F122 C9              10      RET
                                
       F123                     CTRL07:
000353 F123 3AB9EE          13      LD  A,(WK40)
000356 F126 F5              11      PUSH    AF
000357 F127 F620             7      OR  20H
000359 F129 D340            11      OUT (040H),A
00035B F12B 0610             7      LD  B,16
       F12D                     C07X1:
00035D F12D CD94E2          17      CALL    VBLANK
000360 F130 10FB            13      DJNZ    C07X1
000362 F132 F1              10      POP AF
000363 F133 D340            11      OUT (040H),A
000365 F135 C9              10      RET
                                
       F136                     INSERT:
000366 F136 2A8EEE          16      LD  HL,(_TXADR)
000369 F139 3E50             7      LD  A,WIDTH
00036B F13B 95               4      SUB L
00036C F13C 47               4      LD  B,A
                                
00036D F13D CD6EE1          17      CALL    LOC0
                                
000370 F140 3E20             7      LD  A,020H
       F142                     INS1:
000372 F142 4E               7      LD  C,(HL)
000373 F143 77               7      LD  (HL),A
000374 F144 79               4      LD  A,C
000375 F145 23               6      INC HL
000376 F146 10FA            13      DJNZ    INS1
000378 F148 C9              10      RET
                                
       F149                     CTRL0C:
000379 F149 CD16F1          17      CALL    CTRL0B
       F14C                     CTRL06:
00037C F14C 2A8EEE          16      LD  HL,(_TXADR)
       F14F                     CLS1:
       F14F                     CLS2:
00037F F14F E5              11      PUSH    HL
000380 F150 3E50             7      LD  A,WIDTH
000382 F152 95               4      SUB L
000383 F153 47               4      LD  B,A
000384 F154 CD71E1          17      CALL    LOC1
000387 F157 3E20             7      LD  A,020H
       F159                     CLS3:
000389 F159 77               7      LD  (HL),A
00038A F15A 23               6      INC HL
00038B F15B 10FC            13      DJNZ    CLS3
00038D F15D E1              10      POP HL
00038E F15E 2E00             7      LD  L,0
000390 F160 24               4      INC H
000391 F161 3A97EE          13      LD  A,(_LINE)
000394 F164 BC               4      CP  H
000395 F165 20E8            12      JR  NZ,CLS2
000397 F167 C9              10      RET
                                
       F168                     CTRL04:
000398 F168 CDD3EE          17      CALL    _POS
00039B F16B 7D               4      LD  A,L
00039C F16C B7               4      OR  A
00039D F16D C8              11      RET Z
       F16E                     CTRL03:
00039E F16E CD09F1          17      CALL    CTRL0D
       F171                     CTRL0A:
       F171                     CTRL1F:
0003A1 F171 2A8EEE          16      LD  HL,(_TXADR)
0003A4 F174 24               4      INC H
0003A5 F175 C396F0          10      JP  PRINTE8
                                
       F178                     CTRL0E:
0003A8 F178 CDD3EE          17      CALL    _POS
0003AB F17B 7C               4      LD  A,H
0003AC F17C 1804            12      JR  SCR1
       F17E                     SCR:
0003AE F17E 3A97EE          13      LD  A,(_LINE)
0003B1 F181 3D               4      DEC A
       F182                     SCR1:
0003B2 F182 C5              11      PUSH    BC
0003B3 F183 D5              11      PUSH    DE
0003B4 F184 E5              11      PUSH    HL
0003B5 F185 F5              11      PUSH    AF
0003B6 F186 210000          10      LD  HL,0
0003B9 F189 CD71E1          17      CALL    LOC1
0003BC F18C EB               4      EX  DE,HL
0003BD F18D 210001          10      LD  HL,0100H
0003C0 F190 CD71E1          17      CALL    LOC1
0003C3 F193 C1              10      POP BC
0003C4 F194 78               4      LD  A,B
0003C5 F195 B7               4      OR  A
       F196                     SCRUP1:
0003C6 F196 2815            12      JR  Z,SCRCL
0003C8 F198 E5              11      PUSH    HL
0003C9 F199 D5              11      PUSH    DE
0003CA F19A 0608             7      LD  B,8
0003CC F19C 5F               4      LD  E,A
0003CD F19D 210078          10      LD  HL,120*256
0003D0 F1A0 55               4      LD  D,L
       F1A1                     SCRH2:
0003D1 F1A1 29              11      ADD HL,HL
0003D2 F1A2 3001            12      JR  NC,SCRH3
0003D4 F1A4 19              11      ADD HL,DE
       F1A5                     SCRH3:
0003D5 F1A5 10FA            13      DJNZ    SCRH2
0003D7 F1A7 4D               4      LD  C,L
0003D8 F1A8 44               4      LD  B,H
0003D9 F1A9 D1              10      POP DE
0003DA F1AA E1              10      POP HL
0003DB F1AB EDB0                    LDIR
                                
       F1AD                     SCRCL:
0003DD F1AD 3E50             7      LD  A,WIDTH
0003DF F1AF 47               4      LD  B,A
0003E0 F1B0 EB               4      EX  DE,HL
0003E1 F1B1 CD02F1          17      CALL    CLLINE
0003E4 F1B4 E1              10      POP HL
0003E5 F1B5 D1              10      POP DE
0003E6 F1B6 C1              10      POP BC
0003E7 F1B7 C9              10      RET
[EOF:88VRAM.ASM:UTF_8]
                                    INCLUDE "88TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE キーのテーブル
                                
       F1B8                     KEY_TABLE:
0003E8 F1B8 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
0003F0 F1C0 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
0003F8 F1C8 4061626364656667        DB  '@','a','b','c','d','e','f','g' ;2
000400 F1D0 68696A6B6C6D6E6F        DB  'h','i','j','k','l','m','n','o' ;3
000408 F1D8 7071727374757677        DB  'p','q','r','s','t','u','v','w' ;4
000410 F1E0 78797A5B5C5D5E2D        DB  'x','y','z','[',5CH,']','^','-' ;5
000418 F1E8 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;6
000420 F1F0 38393A3B2C2E2F5C        DB  '8','9',':',';',',','.','/',5CH ;7
000428 F1F8 0C1E1C0800000000        DB  0CH,1EH,1CH,08H,00H,00H,00H,00H ;8
000430 F200 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
000438 F208 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
000440 F210 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
000448 F218 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
                                
       F220                     SHIFT_TABLE:
000450 F220 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
000458 F228 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
000460 F230 4041424344454647        DB  '@','A','B','C','D','E','F','G' ;2
000468 F238 48494A4B4C4D4E4F        DB  'H','I','J','K','L','M','N','O' ;3
000470 F240 5051525354555657        DB  'P','Q','R','S','T','U','V','W' ;4
000478 F248 58595A7B7C7D7E3D        DB  'X','Y','Z','{','|','}','~','=' ;5
000480 F250 3021222324252627        DB  '0','!','"','#','$','%','&',27H ;6
000488 F258 28292A2B3C3E3F5F        DB  '(',')','*','+','<','>','?','_' ;7
000490 F260 0B1E1C0800000000        DB  0BH,1EH,1CH,08H,00H,00H,00H,00H ;8
000498 F268 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
0004A0 F270 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
0004A8 F278 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
0004B0 F280 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
                                
       F288                     CTRL_TABLE:
0004B8 F288 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
0004C0 F290 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
0004C8 F298 4001020304050607        DB  '@',01H,02H,03H,04H,05H,06H,07H ;2
0004D0 F2A0 08090A0B0C0D0E0F        DB  08H,09H,0AH,0BH,0CH,0DH,0EH,0FH ;3
0004D8 F2A8 1011121314151617        DB  10H,11H,12H,13H,14H,15H,16H,17H ;4
0004E0 F2B0 18191A5B5C5D5E2D        DB  18H,19H,1AH,'[',5CH,']','^','-' ;5
0004E8 F2B8 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;6
0004F0 F2C0 38393A3B2C2E2F5F        DB  '8','9',':',';',',','.','/','_' ;7
0004F8 F2C8 0C1E1C0800000000        DB  0CH,1EH,1CH,08H,00H,00H,00H,00H ;8
000500 F2D0 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
000508 F2D8 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
000510 F2E0 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
000518 F2E8 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
       F2F0                     VRAME:
000520 D619                         ORG $$+OFFSET,$$    ;$DEPHASE
       D619                     AT_VRAME:
[EOF:88TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "88SUB.ASM"
                                
                                ;   LSX-Dodgers SUB DISK SYSTEM
                                ;   PC-8801mkIISR
                                
       D619                     AT_DSS:
000520 7C00                         ORG DSS,AT_DSS-OFFSET
000520 7C00 C3437C          10      JP  READDISKEX
000523 7C03 C3B17C          10      JP  WRITEDISKEX
000526 7C06 C3C97C          10      JP  GETPARAMS_N
000529 7C09 C3D47C          10      JP  SEEK
00052C 7C0C C3627D          10      JP  FDCOMMAND
00052F 7C0F C32E7E          10      JP  CHECKRESULT
000532 7C12 C3507E          10      JP  GETDEVSTAT
000535 7C15 C3557E          10      JP  RDFDC
                                
000538 7C18                         DS  8*3
                                
       7C30                     S_PARAMS:
000550 7C30                         DS  16
       7C30                     S_UNITNO    EQU S_PARAMS    ;最大セクタサイズ << 1 + ユニット番号 0:ドライブA 1:ドライブB
       7C31                     S_DPS       EQU S_PARAMS+1  ;1トラックのセクタ数
       7C32                     S_SECTOR_R  EQU S_PARAMS+2  ;セクタ番号
       7C33                     S_TRACK     EQU S_PARAMS+3  ;トラック番号
       7C34                     S_FDMODE    EQU S_PARAMS+4  ;FDモード切り替え $FF:2D/2DD $FE:2HD
       7C35                     S_SECSIZE_N EQU S_PARAMS+5  ;N セクタサイズ
       7C36                     S_BYTE_H    EQU S_PARAMS+6  ;バイト数H
       7C37                     S_MAXCL     EQU S_PARAMS+7  ;シリンダ数
                                
       7C40                     S_CMD_STATUS:
000560 7C40 00                      DB  0
       7C41                     S_LEFT:
000561 7C41 00                      DB  0
       7C42                     S_WKF4:
000562 7C42 00                      DB  0
                                
       7C43                     READDISKEX:
000563 7C43 CDC77C          17      CALL    GETPARAMS
000566 7C46 AF               4      XOR A
000567 7C47 32887C          13      LD  (RETRY_RDDISK),A
00056A 7C4A 2A327C          16      LD  HL,(S_PARAMS+2)
00056D 7C4D 7D               4      LD  A,L
00056E 7C4E 3D               4      DEC A
00056F 7C4F B4               4      OR  H
000570 7C50 2012            12      JR  NZ,RDDISKA1
000572 7C52 2A357C          16      LD  HL,(S_SECSIZE_N)
000575 7C55 7C               4      LD  A,H
000576 7C56 BD               4      CP  L
000577 7C57 200B            12      JR  NZ,RDDISKA1
000579 7C59 3A307C          13      LD  A,(S_UNITNO)    ;(MAX_SEC_SZ_H << 1) + UNITNO
00057C 7C5C 32887C          13      LD  (RETRY_RDDISK),A
00057F 7C5F CB3F             8      SRL A
000581 7C61 32947C          13      LD  (RETRY_MAX_SEC_H),A
       7C64                     RDDISKA1:
000584 7C64 3A307C          13      LD  A,(S_UNITNO)
000587 7C67 E601             7      AND 1
000589 7C69 32307C          13      LD  (S_UNITNO),A
       7C6C                     RDDISK0:
00058C 7C6C CDD47C          17      CALL    SEEK
00058F 7C6F 3E46             7      LD  A,46H       ;READ DATA
000591 7C71 CD627D          17      CALL    FDCOMMAND
000594 7C74 3834            12      JR  C,FINISH_DISK
000596 7C76 CD937D          17      CALL    RDDISK1
       7C79                     WRDISK3:
000599 7C79 78               4      LD  A,B
00059A 7C7A B2               4      OR  D
00059B 7C7B 32417C          13      LD  (S_LEFT),A
00059E 7C7E DBF8            11      IN  A,(0F8H)    ;FDC μPD765A TC入力
0005A0 7C80 FB               4      EI
0005A1 7C81 76               4      HALT
0005A2 7C82 CD2E7E          17      CALL    CHECKRESULT
0005A5 7C85 301D            12      JR  NC,FINISH_DISK0
0005A7 7C87 3E00             7      LD  A,0
       7C88                     RETRY_RDDISK    EQU $-1
0005A9 7C89 CB3F             8      SRL A
0005AB 7C8B 2817            12      JR  Z,FINISH_DISK0
0005AD 7C8D 32887C          13      LD  (RETRY_RDDISK),A
0005B0 7C90 3A357C          13      LD  A,(S_SECSIZE_N)
0005B3 7C93 FE04             7      CP  4
       7C94                     RETRY_MAX_SEC_H EQU $-1
0005B5 7C95 3003            12      JR  NC,RETRY_RDDISK1
0005B7 7C97 87               4      ADD A,A
0005B8 7C98 1802            12      JR  RETRY_RDDISK2
       7C9A                     RETRY_RDDISK1:
0005BA 7C9A 3E01             7      LD  A,1
       7C9C                     RETRY_RDDISK2:
0005BC 7C9C 67               4      LD  H,A
0005BD 7C9D 6F               4      LD  L,A
0005BE 7C9E 22357C          16      LD  (S_SECSIZE_N),HL
0005C1 7CA1 C36C7C          10      JP  RDDISK0
       7CA4                     FINISH_DISK0:
0005C4 7CA4 3A417C          13      LD  A,(S_LEFT)
0005C7 7CA7 D601             7      SUB 1
0005C9 7CA9 3F               4      CCF
       7CAA                     FINISH_DISK:
0005CA 7CAA 9F               4      SBC A,A
0005CB 7CAB 32407C          13      LD  (S_CMD_STATUS),A
0005CE 7CAE C32A00          10      JP  MAIN
                                
       7CB1                     WRITEDISKEX:
0005D1 7CB1 AF               4      XOR A
0005D2 7CB2 32887C          13      LD  (RETRY_RDDISK),A
0005D5 7CB5 CDC77C          17      CALL    GETPARAMS
0005D8 7CB8 CDD47C          17      CALL    SEEK
0005DB 7CBB 3E45             7      LD  A,45H       ;WRITE DATA
0005DD 7CBD CD627D          17      CALL    FDCOMMAND
0005E0 7CC0 38E8            12      JR  C,FINISH_DISK
0005E2 7CC2 CDDA7D          17      CALL    WRDISK1
0005E5 7CC5 18B2            12      JR  WRDISK3
                                
       7CC7                     GETPARAMS:
0005E7 7CC7 0608             7      LD  B,8
       7CC9                     GETPARAMS_N:
0005E9 7CC9 E5              11      PUSH    HL
0005EA 7CCA 21307C          10      LD  HL,S_PARAMS
       7CCD                     GETPARAMS1:
0005ED 7CCD D7              12      RST 10H
0005EE 7CCE 77               7      LD  (HL),A
0005EF 7CCF 23               6      INC HL
0005F0 7CD0 10FB            13      DJNZ    GETPARAMS1
0005F2 7CD2 E1              10      POP HL
0005F3 7CD3 C9              10      RET
                                
       7CD4                     SEEK:
0005F4 7CD4 E5              11      PUSH    HL
0005F5 7CD5 3A347C          13      LD  A,(S_FDMODE)    ;FDモード切り替え $FF:2D/2DD $FE:2HD
0005F8 7CD8 1F               4      RRA
0005F9 7CD9 3F               4      CCF
0005FA 7CDA 9F               4      SBC A,A
0005FB 7CDB F5              11      PUSH    AF
0005FC 7CDC E605             7      AND 5
0005FE 7CDE 4F               4      LD  C,A
0005FF 7CDF 3A377C          13      LD  A,(S_MAXCL) ;シリンダ数
000602 7CE2 C6D3             7      ADD A,0-45      ;オーバートラックを考慮して40+α
000604 7CE4 9F               4      SBC A,A
000605 7CE5 E604             7      AND 4
000607 7CE7 B1               4      OR  C
000608 7CE8 0EFA             7      LD  C,0FFH-5    ;マスク
00060A 7CEA 47               4      LD  B,A
00060B 7CEB 3A307C          13      LD  A,(S_UNITNO)    ;(MAX_SEC_SZ_H << 1) + UNITNO(0:ドライブA 1:ドライブB)
00060E 7CEE B7               4      OR  A
00060F 7CEF 2804            12      JR  Z,SET_WKF4
000611 7CF1 CB20             8      SLA B
000613 7CF3 CB01             8      RLC C
       7CF5                     SET_WKF4:
000615 7CF5 3A427C          13      LD  A,(S_WKF4)
000618 7CF8 A1               4      AND C
000619 7CF9 B0               4      OR  B
00061A 7CFA 4F               4      LD  C,A
00061B 7CFB D3F4            11      OUT (0F4H),A    ;ドライブ制御
00061D 7CFD E6DF             7      AND 0FFH-020H   ;CLKの分は抜いておく
00061F 7CFF 47               4      LD  B,A
000620 7D00 F1              10      POP AF
000621 7D01 E620             7      AND 020H        ;bit5:CLK
000623 7D03 B0               4      OR  B
000624 7D04 D3F4            11      OUT (0F4H),A    ;ドライブ制御
000626 7D06 32427C          13      LD  (S_WKF4),A
000629 7D09 47               4      LD  B,A
00062A 7D0A A9               4      XOR C
00062B 7D0B E620             7      AND 020H        ;CLKが変化したら一定時間待つ
00062D 7D0D 2808            12      JR  Z,NOCHGCLK
00062F 7D0F 2160F0          10      LD  HL,0F060H
       7D12                     WAIT_CLK:
000632 7D12 2B               6      DEC HL
000633 7D13 7C               4      LD  A,H
000634 7D14 B5               4      OR  L
000635 7D15 20FB            12      JR  NZ,WAIT_CLK
       7D17                     NOCHGCLK:
000637 7D17 78               4      LD  A,B
000638 7D18 E620             7      AND 020H
00063A 7D1A 2805            12      JR  Z,SPECIFY2D
00063C 7D1C 1131DF          10      LD  DE,0DF31H   ;SPECIFY 2HD / SRT:13 HUT:15 HLT:24 NON-DMA
00063F 7D1F 1803            12      JR  SPECIFYOK
       7D21                     SPECIFY2D:
000641 7D21 1119DA          10      LD  DE,0DA19H   ;SPECIFY 2D/2DD / SRT:13 HUT 10 HLT:12 NON-DMA
       7D24                     SPECIFYOK:
000644 7D24 3E03             7      LD  A,3     ;SPECIFY
000646 7D26 E7              12      RST 20H
000647 7D27 7A               4      LD  A,D
000648 7D28 E7              12      RST 20H
000649 7D29 7B               4      LD  A,E
00064A 7D2A E7              12      RST 20H
       7D2B                     NOSPECIFY:
00064B 7D2B ED4B307C        20      LD  BC,(S_PARAMS)
00064F 7D2F ED5B327C        20      LD  DE,(S_PARAMS+2)
000653 7D33 7A               4      LD  A,D     ;TRACK
000654 7D34 CB3F             8      SRL A       ;CYLINDER
000656 7D36 3E0F             7      LD  A,00FH      ;SEEK
000658 7D38 2002            12      JR  NZ,SEEK1    ;0シリンダの場合はRECALIBRATE、それ以外はSEEKを使う
00065A 7D3A 3E07             7      LD  A,7     ;RECALIBRATE
       7D3C                     SEEK1:
00065C 7D3C E7              12      RST 20H
00065D 7D3D 79               4      LD  A,C     ;DR/HD
00065E 7D3E E7              12      RST 20H
00065F 7D3F 7A               4      LD  A,D     ;TRACK
000660 7D40 CB3F             8      SRL A       ;CYLINDER
000662 7D42 C42000          17      CALL    NZ,20H      ;SEEKの場合だけ呼ぶ(0シリンダの場合はRECALIBRATEを使うのでシリンダの設定は不要)
000665 7D45 FB               4      EI
000666 7D46 76               4      HALT
000667 7D47 3E08             7      LD  A,8     ;SENSE
000669 7D49 E7              12      RST 20H
00066A 7D4A CD557E          17      CALL    RDFDC       ;ST0
00066D 7D4D CD557E          17      CALL    RDFDC       ;PCN(CYLINDER)
000670 7D50 210040          10      LD  HL,04000H
       7D53                     WAIT_SEEK:
000673 7D53 CD507E          17      CALL    GETDEVSTAT
000676 7D56 E608             7      AND 8
000678 7D58 2006            12      JR  NZ,SEEK_OK
00067A 7D5A 2B               6      DEC HL
00067B 7D5B 7C               4      LD  A,H
00067C 7D5C B5               4      OR  L
00067D 7D5D 20F4            12      JR  NZ,WAIT_SEEK
00067F 7D5F 37               4      SCF
       7D60                     SEEK_OK:
000680 7D60 E1              10      POP HL
000681 7D61 C9              10      RET
                                
       7D62                     FDCOMMAND:
000682 7D62 E7              12      RST 20H
000683 7D63 7A               4      LD  A,D     ;HD US1 US0
000684 7D64 E601             7      AND 1
000686 7D66 87               4      ADD A,A
000687 7D67 87               4      ADD A,A
000688 7D68 B1               4      OR  C
000689 7D69 E7              12      RST 20H
00068A 7D6A 7A               4      LD  A,D     ;C
00068B 7D6B CB3F             8      SRL A
00068D 7D6D E7              12      RST 20H
00068E 7D6E 7A               4      LD  A,D     ;H
00068F 7D6F E601             7      AND 1
000691 7D71 E7              12      RST 20H
000692 7D72 7B               4      LD  A,E     ;R
000693 7D73 E7              12      RST 20H
000694 7D74 3A357C          13      LD  A,(S_SECSIZE_N) ;N
000697 7D77 FE04             7      CP  4
000699 7D79 3802            12      JR  C,FDCOMMAND2    ;N:1=>1 2=>2 4=>3
00069B 7D7B 3E03             7      LD  A,3
       7D7D                     FDCOMMAND2:
00069D 7D7D 1E20             7      LD  E,020H      ;NO SERVICE
00069F 7D7F E7              12      RST 20H
                                
0006A0 7D80 210040          10      LD  HL,DSS_DATA ;開始アドレス
0006A3 7D83 78               4      LD  A,B     ;EOT
0006A4 7D84 E7              12      RST 20H
                                
0006A5 7D85 01FB00          10      LD  BC,000FBH   ;B:バイト数L C:FDC μPD765A データレジスタ
0006A8 7D88 3E54             7      LD  A,054H      ;GSL
0006AA 7D8A E7              12      RST 20H
                                
0006AB 7D8B 3A367C          13      LD  A,(S_BYTE_H)
0006AE 7D8E 57               4      LD  D,A     ;バイト数H
                                
0006AF 7D8F AF               4      XOR A       ;DTL
0006B0 7D90 E7              12      RST 20H
0006B1 7D91 A7               4      AND A
0006B2 7D92 C9              10      RET
                                
       7D93                     RDDISK1:            ;高速化の為にループ展開x8
0006B3 7D93 FB               4      EI
0006B4 7D94 76               4      HALT
0006B5 7D95 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006B7 7D97 A3               4      AND E       ;NO SERVICE
0006B8 7D98 C8              11      RET Z
0006B9 7D99 EDA2            16      INI
                                
0006BB 7D9B FB               4      EI
0006BC 7D9C 76               4      HALT
0006BD 7D9D DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006BF 7D9F A3               4      AND E       ;NO SERVICE
0006C0 7DA0 C8              11      RET Z
0006C1 7DA1 EDA2            16      INI
                                
0006C3 7DA3 FB               4      EI
0006C4 7DA4 76               4      HALT
0006C5 7DA5 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006C7 7DA7 A3               4      AND E       ;NO SERVICE
0006C8 7DA8 C8              11      RET Z
0006C9 7DA9 EDA2            16      INI
                                
0006CB 7DAB FB               4      EI
0006CC 7DAC 76               4      HALT
0006CD 7DAD DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006CF 7DAF A3               4      AND E       ;NO SERVICE
0006D0 7DB0 C8              11      RET Z
0006D1 7DB1 EDA2            16      INI
                                
0006D3 7DB3 FB               4      EI
0006D4 7DB4 76               4      HALT
0006D5 7DB5 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006D7 7DB7 A3               4      AND E       ;NO SERVICE
0006D8 7DB8 C8              11      RET Z
0006D9 7DB9 EDA2            16      INI
                                
0006DB 7DBB FB               4      EI
0006DC 7DBC 76               4      HALT
0006DD 7DBD DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006DF 7DBF A3               4      AND E       ;NO SERVICE
0006E0 7DC0 C8              11      RET Z
0006E1 7DC1 EDA2            16      INI
                                
0006E3 7DC3 FB               4      EI
0006E4 7DC4 76               4      HALT
0006E5 7DC5 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006E7 7DC7 A3               4      AND E       ;NO SERVICE
0006E8 7DC8 C8              11      RET Z
0006E9 7DC9 EDA2            16      INI
                                
0006EB 7DCB FB               4      EI
0006EC 7DCC 76               4      HALT
0006ED 7DCD DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006EF 7DCF A3               4      AND E       ;NO SERVICE
0006F0 7DD0 C8              11      RET Z
0006F1 7DD1 EDA2            16      INI
                                
0006F3 7DD3 20BE            12      JR  NZ,RDDISK1
0006F5 7DD5 15               4      DEC D
0006F6 7DD6 C2937D          10      JP  NZ,RDDISK1
0006F9 7DD9 C9              10      RET
                                
       7DDA                     WRDISK1:            ;高速化の為にループ展開x8
0006FA 7DDA FB               4      EI
0006FB 7DDB 76               4      HALT
0006FC 7DDC DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006FE 7DDE A3               4      AND E
0006FF 7DDF C8              11      RET Z
000700 7DE0 EDA3            16      OUTI
                                
000702 7DE2 FB               4      EI
000703 7DE3 76               4      HALT
000704 7DE4 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000706 7DE6 A3               4      AND E
000707 7DE7 C8              11      RET Z
000708 7DE8 EDA3            16      OUTI
                                
00070A 7DEA FB               4      EI
00070B 7DEB 76               4      HALT
00070C 7DEC DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00070E 7DEE A3               4      AND E
00070F 7DEF C8              11      RET Z
000710 7DF0 EDA3            16      OUTI
                                
000712 7DF2 FB               4      EI
000713 7DF3 76               4      HALT
000714 7DF4 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000716 7DF6 A3               4      AND E
000717 7DF7 C8              11      RET Z
000718 7DF8 EDA3            16      OUTI
                                
00071A 7DFA FB               4      EI
00071B 7DFB 76               4      HALT
00071C 7DFC DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00071E 7DFE A3               4      AND E
00071F 7DFF C8              11      RET Z
000720 7E00 EDA3            16      OUTI
                                
000722 7E02 FB               4      EI
000723 7E03 76               4      HALT
000724 7E04 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000726 7E06 A3               4      AND E
000727 7E07 C8              11      RET Z
000728 7E08 EDA3            16      OUTI
                                
00072A 7E0A FB               4      EI
00072B 7E0B 76               4      HALT
00072C 7E0C DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00072E 7E0E A3               4      AND E
00072F 7E0F C8              11      RET Z
000730 7E10 EDA3            16      OUTI
                                
000732 7E12 FB               4      EI
000733 7E13 76               4      HALT
000734 7E14 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000736 7E16 A3               4      AND E
000737 7E17 C8              11      RET Z
000738 7E18 EDA3            16      OUTI
                                
00073A 7E1A 20BE            12      JR  NZ,WRDISK1
00073C 7E1C 15               4      DEC D
00073D 7E1D C2DA7D          10      JP  NZ,WRDISK1
000740 7E20 C9              10      RET
                                
       7E21                     RESULTEX:
000741 7E21 3A407C          13      LD  A,(S_CMD_STATUS)
000744 7E24 3C               4      INC A
000745 7E25 2803            12      JR  Z,RESULTEX1
000747 7E27 3A367C          13      LD  A,(S_BYTE_H)    ;バイト数H
       7E2A                     RESULTEX1:
00074A 7E2A DF              12      RST 18H
00074B 7E2B C32A00          10      JP  MAIN
                                
       7E2E                     CHECKRESULT:
00074E 7E2E C5              11      PUSH    BC
00074F 7E2F CD557E          17      CALL    RDFDC       ;ST0
000752 7E32 E6D8             7      AND 0D8H
000754 7E34 4F               4      LD  C,A
000755 7E35 CD557E          17      CALL    RDFDC       ;ST1
000758 7E38 E6B7             7      AND 0B7H
00075A 7E3A B1               4      OR  C
00075B 7E3B 4F               4      LD  C,A
00075C 7E3C CD557E          17      CALL    RDFDC       ;ST2
00075F 7E3F E673             7      AND 073H
000761 7E41 B1               4      OR  C
000762 7E42 4F               4      LD  C,A
000763 7E43 0604             7      LD  B,4
       7E45                     CHECKRESULT1:           ;C H R N
000765 7E45 CD557E          17      CALL    RDFDC
000768 7E48 10FB            13      DJNZ    CHECKRESULT1
00076A 7E4A 79               4      LD  A,C
00076B 7E4B A7               4      AND A
00076C 7E4C C1              10      POP BC
00076D 7E4D C8              11      RET Z
00076E 7E4E 37               4      SCF
00076F 7E4F C9              10      RET
                                
       7E50                     GETDEVSTAT:
000770 7E50 3E04             7      LD  A,4
000772 7E52 E7              12      RST 20H
000773 7E53 79               4      LD  A,C
000774 7E54 E7              12      RST 20H
                                
       7E55                     RDFDC:
000775 7E55 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000777 7E57 2F               4      CPL
000778 7E58 E6C0             7      AND 0C0H        ;RQMとDIOが両方1になるまで待つ
00077A 7E5A 20F9            12      JR  NZ,RDFDC
00077C 7E5C DBFB            11      IN  A,(0FBH)    ;FDC μPD765A データレジスタリード
00077E 7E5E C9              10      RET
                                
00077F D878                         ORG $$+OFFSET,$$    ;$DEPHASE
       D878                     AT_DSSE:
       D878                     INITE:
00077F D878                         DS  BDOS-INITE
00080D D906 C36CE0          10      JP  BDOS_RF
[EOF:88SUB.ASM:SHIFT_JIS]
                                    INCLUDE "88CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   PC-8801mkIISR
                                
       D909                     WBOOT1:
000810 D909 ED7B0600        20      LD  SP,(SYSTEM+1)
000814 D90D DB32            11      IN  A,(032H)
000816 D90F F610             7      OR  10H     ;高速RAMアクセスモードOFF
000818 D911 D332            11      OUT (032H),A
                                
00081A D913 3EED             7      LD  A,IVRTC/256
00081C D915 2192EE          10      LD  HL,_KEYD
00081F D918 3600            10      LD  (HL),0      ;必ずBDOS0+13Hが「0」になるようにする
000821 D91A ED47             9      LD  I,A
000823 D91C 3AB8EE          13      LD  A,(WKE6)
000826 D91F F602             7      OR  2       ;VRTC割り込みマスク
000828 D921 D3E6            11      OUT (0E6H),A    ;割り込みマスク
00082A D923 32B8EE          13      LD  (WKE6),A
00082D D926 3AB7EE          13      LD  A,(WKE4)
000830 D929 D3E4            11      OUT (0E4H),A    ;割り込みレベル設定
                                
000832 D92B FB               4      EI
000833 D92C CD23E2          17      CALL    CHKEY
000836 D92F CD06E3          17      CALL    KEYBC_IFBREAK
000839 D932 3E04             7      LD  A,4
00083B D934 CD19E3          17      CALL    MSG_A
[EOF:88CCP.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D937                     COMMAND:
00083E D937 3AAFED          13      LD  A,(FCB_BAT)
000841 D93A B7               4      OR  A
000842 D93B C279DA          10      JP  NZ,C_BAT1
000845 D93E CDEDD9          17      CALL    SETDTA1
000848 D941 3A0400          13      LD  A,(_DVSW)
00084B D944 C641             7      ADD A,'A'
00084D D946 CD19E3          17      CALL    MSG_A
000850 D949 3E3E             7      LD  A,'>'
000852 D94B CD19E3          17      CALL    MSG_A
000855 D94E 3E50             7      LD  A,80
000857 D950 12               7      LD  (DE),A
000858 D951 CD75E0          17      CALL    _SYS0A      ;(BDOS)文字列入力
00085B D954 CD6EDB          17      CALL    LTNL
       D957                     COMMAND2:
00085E D957 118200          10      LD  DE,DTA1+2
000861 D95A CDFDEE          17      CALL    _COMANL
000864 D95D DC63E0          17      CALL    C,SHOW_ERROR
000867 D960 18D5            12      JR  COMMAND
                                
       D962                     COMANL:
000869 D962 CD0BF0          17      CALL    FILE
00086C D965 3A19EE          13      LD  A,(FNAME+4)
00086F D968 FE20             7      CP  020H
000871 D96A 201C            12      JR  NZ,COMB2
000873 D96C D5              11      PUSH    DE
000874 D96D 1115EE          10      LD  DE,FNAME
000877 D970 1A               7      LD  A,(DE)
000878 D971 FE20             7      CP  020H
00087A D973 2844            12      JR  Z,SDVSW
00087C D975 1B               6      DEC DE
00087D D976 1A               7      LD  A,(DE)
00087E D977 C6FF             7      ADD A,0FFH
000880 D979 3809            12      JR  C,COMB
000882 D97B 13               6      INC DE
                                
000883 D97C 212BDD          10      LD  HL,COMTB
000886 D97F 0608             7      LD  B,COMS
000888 D981 CD98F2          17      CALL    CPNAME
       D984                     COMB:
00088B D984 D1              10      POP DE
00088C D985 D262E0          10      JP  NC,JPHL
       D988                     COMB2:
00088F D988 EB               4      EX  DE,HL
000890 D989 2256DA          16      LD  (COMSWC),HL
000893 D98C F5              11      PUSH    AF
000894 D98D CD0EDA          17      CALL    CEXE4
000897 D990 F1              10      POP AF
000898 D991 2115EE          10      LD  HL,FNAME
00089B D994 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
00089E D997 010B00          10      LD  BC,11
0008A1 D99A EDB0                    LDIR
0008A3 D99C 114EED          10      LD  DE,PATHD
       D99F                     CEX1:
0008A6 D99F 1A               7      LD  A,(DE)
0008A7 D9A0 FE20             7      CP  020H
0008A9 D9A2 D8              11      RET C
0008AA D9A3 CD00F0          17      CALL    FILEC
0008AD D9A6 D5              11      PUSH    DE
0008AE D9A7 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
0008B1 D9AA 1115EE          10      LD  DE,FNAME
0008B4 D9AD 010B00          10      LD  BC,11
0008B7 D9B0 EDB0                    LDIR
0008B9 D9B2 CD0EDA          17      CALL    CEXE4
0008BC D9B5 D1              10      POP DE
0008BD D9B6 13               6      INC DE
0008BE D9B7 18E6            12      JR  CEX1
                                
       D9B9                     SDVSW:
0008C0 D9B9 F1              10      POP AF
0008C1 D9BA 3A14EE          13      LD  A,(FDRV)
0008C4 D9BD 3D               4      DEC A
0008C5 D9BE 5F               4      LD  E,A
0008C6 D9BF 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
0008C8 D9C1 1831            12      JR  SYSTEM0
                                
       D9C3                     OPEN1:
0008CA D9C3 2114EE          10      LD  HL,FDRV
       D9C6                     OPEN:
0008CD D9C6 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D9C8                     OPEN3:
0008CF D9C8 D5              11      PUSH    DE
0008D0 D9C9 118AED          10      LD  DE,DTA_CCP
0008D3 D9CC CDEAD9          17      CALL    SETDTA
0008D6 D9CF EB               4      EX  DE,HL
0008D7 D9D0 CDF4D9          17      CALL    SYSTEM0
0008DA D9D3 D1              10      POP DE
0008DB D9D4 C9              10      RET
                                
       D9D5                     OPEN2:
0008DC D9D5 0E12             7      LD  C,012H
0008DE D9D7 18EF            12      JR  OPEN3
                                
       D9D9                     DEFCB:              ;Z=Ok NZ=Error
0008E0 D9D9 118AED          10      LD  DE,DTA_CCP
0008E3 D9DC CDF2D9          17      CALL    SYSC0F
                                
0008E6 D9DF 11ABED          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0008E9 D9E2 0604             7      LD  B,4
0008EB D9E4 CD3FDC          17      CALL    ZERO_MEMORY_DE
       D9E7                     SETDTA100:
0008EE D9E7 110001          10      LD  DE,BUFFER
       D9EA                     SETDTA:
0008F1 D9EA C3A3DF          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D9ED                     SETDTA1:
0008F4 D9ED 118000          10      LD  DE,DTA1
0008F7 D9F0 18F8            12      JR  SETDTA
                                
       D9F2                     SYSC0F:
0008F9 D9F2 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D9F4                     SYSTEM0:
0008FB D9F4 CD0500          17      CALL    SYSTEM
0008FE D9F7 B7               4      OR  A
0008FF D9F8 C9              10      RET
                                
       D9F9                     C_CD:
000900 D9F9 0E5A             7      LD  C,05AH
000902 D9FB 18F7            12      JR  SYSTEM0
                                
       D9FD                     S27BUF:
000904 D9FD 2100FE          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       DA00                     S27BUF2:
000907 DA00 39              11      ADD HL,SP
000908 DA01 2E00             7      LD  L,0
00090A DA03 7C               4      LD  A,H
00090B DA04 E6F8             7      AND 0F8H
00090D DA06 67               4      LD  H,A
       DA07                     S27DTA:
00090E DA07 118AED          10      LD  DE,DTA_CCP
       DA0A                     S27:
000911 DA0A 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
000913 DA0C 18E6            12      JR  SYSTEM0
                                
       DA0E                     CEXE4:
000915 DA0E 211DEE          10      LD  HL,FNAME+8
000918 DA11 7E               7      LD  A,(HL)
000919 DA12 FE20             7      CP  020H
00091B DA14 2007            12      JR  NZ,CEXE7
00091D DA16 3E3F             7      LD  A,'?'
00091F DA18 77               7      LD  (HL),A
000920 DA19 23               6      INC HL
000921 DA1A 77               7      LD  (HL),A
000922 DA1B 23               6      INC HL
000923 DA1C 77               7      LD  (HL),A
       DA1D                     CEXE7:
000924 DA1D CDC3D9          17      CALL    OPEN1
       DA20                     CEXE5:
000927 DA20 C0              11      RET NZ
000928 DA21 2A94ED          16      LD  HL,(DTA_CCP+1+9)
00092B DA24 7C               4      LD  A,H
00092C DA25 CD27F3          17      CALL    CAP
00092F DA28 67               4      LD  H,A
000930 DA29 7D               4      LD  A,L
000931 DA2A CD27F3          17      CALL    CAP
000934 DA2D 6F               4      LD  L,A
000935 DA2E 3A93ED          13      LD  A,(DTA_CCP+1+8)
000938 DA31 CD27F3          17      CALL    CAP
00093B DA34 D642             7      SUB 'B'
00093D DA36 282C            12      JR  Z,C_BAT
00093F DA38 3D               4      DEC A       ;'C'
000940 DA39 2805            12      JR  Z,C_EXE
       DA3B                     CEXE6:
000942 DA3B CDD5D9          17      CALL    OPEN2
000945 DA3E 18E0            12      JR  CEXE5
                                
       DA40                     C_EXE:
000947 DA40 7C               4      LD  A,H
000948 DA41 FE4D             7      CP  'M'
00094A DA43 20F6            12      JR  NZ,CEXE6
                                
00094C DA45 CDD9D9          17      CALL    DEFCB
00094F DA48 CDFDD9          17      CALL    S27BUF_COM
000952 DA4B 3D               4      DEC A
000953 DA4C 37               4      SCF
000954 DA4D C0              11      RET NZ
000955 DA4E 7C               4      LD  A,H
000956 DA4F B5               4      OR  L
000957 DA50 37               4      SCF
000958 DA51 C8              11      RET Z
000959 DA52 CDEDD9          17      CALL    SETDTA1
00095C DA55 110000          10      LD  DE,0                ; self-modifying code
       DA56                     COMSWC  EQU $-2
00095F DA58 ED7B0600        20      LD  SP,(SYSTEM+1)
000963 DA5C 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000964 DA5D 6F               4      LD  L,A
000965 DA5E E5              11      PUSH    HL              ; push $0000 (reboot address)
000966 DA5F 24               4      INC H
000967 DA60 E5              11      PUSH    HL              ; push $0100 (TPA address)
000968 DA61 C30ADC          10      JP  SETFCB              ; and JP $0100
                                
       DA64                     C_BAT:
00096B DA64 114154          10      LD  DE,'A'+'T'*256
00096E DA67 ED52            15      SBC HL,DE
000970 DA69 20D0            12      JR  NZ,CEXE6
                                
000972 DA6B CDD9D9          17      CALL    DEFCB
                                
000975 DA6E 218AED          10      LD  HL,DTA_CCP
000978 DA71 11AFED          10      LD  DE,FCB_BAT
00097B DA74 012500          10      LD  BC,37
00097E DA77 EDB0                    LDIR
       DA79                     C_BAT1:
000980 DA79 CDE7D9          17      CALL    SETDTA100
000983 DA7C CDB0DA          17      CALL    FGETC_BAT
000986 DA7F 218100          10      LD  HL,DTA1+1
000989 DA82 2025            12      JR  NZ,END_BATCH
00098B DA84 FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
00098D DA86 38F1            12      JR  C,C_BAT1
00098F DA88 3620            10      LD  (HL),' '
000991 DA8A 23               6      INC HL
       DA8B                     C_BAT2:
000992 DA8B 77               7      LD  (HL),A
000993 DA8C 23               6      INC HL
000994 DA8D 7D               4      LD  A,L
000995 DA8E 3C               4      INC A       ;L==0FFH
000996 DA8F 2809            12      JR  Z,RUN_BATCH
000998 DA91 CDB0DA          17      CALL    FGETC_BAT
00099B DA94 2004            12      JR  NZ,RUN_BATCH
00099D DA96 FE20             7      CP  020H
00099F DA98 30F1            12      JR  NC,C_BAT2
       DA9A                     RUN_BATCH:
0009A1 DA9A 7D               4      LD  A,L
0009A2 DA9B D67F             7      SUB DTA1-1
0009A4 DA9D 328000          13      LD  (DTA1),A
0009A7 DAA0 FE04             7      CP  4
0009A9 DAA2 3805            12      JR  C,END_BATCH
0009AB DAA4 3600            10      LD  (HL),0
0009AD DAA6 C357D9          10      JP  COMMAND2
       DAA9                     END_BATCH:
0009B0 DAA9 AF               4      XOR A       ;バッチファイルを閉じる
0009B1 DAAA 32AFED          13      LD  (FCB_BAT),A
0009B4 DAAD C300EE          10      JP  CPM_BOOT
                                
       DAB0                     FGETC_BAT:
0009B7 DAB0 11AFED          10      LD  DE,FCB_BAT
       DAB3                     FGETC:              ;1文字ずつ読み込む
0009BA DAB3 E5              11      PUSH    HL      ;Z:成功
0009BB DAB4 210100          10      LD  HL,1
0009BE DAB7 CD0ADA          17      CALL    S27
0009C1 DABA E1              10      POP HL
0009C2 DABB 3A0001          13      LD  A,(BUFFER)
0009C5 DABE C9              10      RET
                                
       DABF                     C_DEL:
0009C6 DABF CD0ADC          17      CALL    SETFCB
0009C9 DAC2 CD2FE3          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
0009CC DAC5 0E13             7      LD  C,013H
0009CE DAC7 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       DAC9                     C_REN:
0009D0 DAC9 CD0ADC          17      CALL    SETFCB
0009D3 DACC 3E10             7      LD  A,010H      ;ディレクトリも対象にする
0009D5 DACE 326900          13      LD  (FCB1+13),A ;属性
0009D8 DAD1 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       DAD3                     CDEL1:
0009DA DAD3 115C00          10      LD  DE,FCB1
0009DD DAD6 CD0500          17      CALL    SYSTEM
0009E0 DAD9 C6FF             7      ADD A,0FFH
0009E2 DADB C9              10      RET
                                
       DADC                     C_DIR:
0009E3 DADC CD00F0          17      CALL    FILEC
0009E6 DADF 2115EE          10      LD  HL,FDRV+1
0009E9 DAE2 CD20DD          17      CALL    CWILD1
0009EC DAE5 3EF1             7      LD  A,0F1H
0009EE DAE7 3221EE          13      LD  (FDRV+13),A
0009F1 DAEA CDC3D9          17      CALL    OPEN1
       DAED                     CDIR1:
0009F4 DAED B7               4      OR  A
0009F5 DAEE 2008            12      JR  NZ,PDSKF
0009F7 DAF0 CD3BDB          17      CALL    P_NAME
0009FA DAF3 CDD5D9          17      CALL    OPEN2
0009FD DAF6 18F5            12      JR  CDIR1
       DAF8                     PDSKF:
0009FF DAF8 3A14EE          13      LD  A,(FDRV)
000A02 DAFB 5F               4      LD  E,A
000A03 DAFC 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
000A05 DAFE CD0500          17      CALL    SYSTEM
000A08 DB01 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
000A09 DB02 C601             7      ADD A,001H
000A0B DB04 D8              11      RET C       ;Aが0FFHだった場合
000A0C DB05 3E06             7      LD  A,8-2
       DB07                     PDS1:               ;HL=未使用クラスタの総数
000A0E DB07 3C               4      INC A
000A0F DB08 CB19             8      RR  C
000A11 DB0A 30FB            12      JR  NC,PDS1
       DB0C                     PDS2:               ;B←論理セクタのサイズの上位8ビット
000A13 DB0C 3C               4      INC A
000A14 DB0D CB18             8      RR  B
000A16 DB0F 30FB            12      JR  NC,PDS2
000A18 DB11 47               4      LD  B,A
                                
000A19 DB12 110000          10      LD  DE,0
       DB15                     PDS3:
000A1C DB15 29              11      ADD HL,HL
000A1D DB16 EB               4      EX  DE,HL
000A1E DB17 ED6A            15      ADC HL,HL
000A20 DB19 EB               4      EX  DE,HL
000A21 DB1A 10F9            13      DJNZ    PDS3
       DB1C                     PDSKF1:
000A23 DB1C CDA8DB          17      CALL    PRDEC_DEHL
000A26 DB1F 11DFED          10      LD  DE,FREE
000A29 DB22 CDD0DD          17      CALL    _SYS09      ;(BDOS)文字列出力
000A2C DB25 CD95DB          17      CALL    PUTDRV
000A2F DB28 3E5C             7      LD  A,05CH      ;\
000A31 DB2A CD19E3          17      CALL    MSG_A
000A34 DB2D 2A22EE          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
000A37 DB30 AF               4      XOR A
000A38 DB31 11FEFF          10      LD  DE,0-2
000A3B DB34 19              11      ADD HL,DE
000A3C DB35 23               6      INC HL
000A3D DB36 DCA5DB          17      CALL    C,PRDEC_HL
000A40 DB39 1833            12      JR  LTNL
                                
       DB3B                     P_NAME:
000A42 DB3B 3A8BED          13      LD  A,(DTA_CCP+1)
000A45 DB3E FE2E             7      CP  '.'
000A47 DB40 C8              11      RET Z
                                
000A48 DB41 3A96ED          13      LD  A,(DTA_CCP+1+00BH)
000A4B DB44 F5              11      PUSH    AF
000A4C DB45 CB67             8      BIT 4,A
000A4E DB47 2808            12      JR  Z,DIR3
000A50 DB49 11D4ED          10      LD  DE,DIRMES
000A53 DB4C CDD0DD          17      CALL    _SYS09      ;(BDOS)文字列出力
000A56 DB4F 180A            12      JR  DIR6
       DB51                     DIR3:
000A58 DB51 ED5BA9ED        20      LD  DE,(DTA_CCP+1+01EH)
000A5C DB55 2AA7ED          16      LD  HL,(DTA_CCP+1+01CH)
000A5F DB58 CDA8DB          17      CALL    PRDEC_DEHL
       DB5B                     DIR6:
000A62 DB5B F1              10      POP AF
000A63 DB5C 0F               4      RRCA
000A64 DB5D 9F               4      SBC A,A
000A65 DB5E E60A             7      AND '*'-020H
000A67 DB60 C620             7      ADD A,020H
000A69 DB62 CD19E3          17      CALL    MSG_A
000A6C DB65 CD95DB          17      CALL    PUTDRV
000A6F DB68 218BED          10      LD  HL,DTA_CCP+1
000A72 DB6B CDE8DB          17      CALL    FPRNT
                                
       DB6E                     LTNL:
000A75 DB6E 1E03             7      LD  E,3
000A77 DB70 C3CDEE          10      JP  _PRINT
                                
       DB73                     C_PATH:
000A7A DB73 CDE1F0          17      CALL    SPCUT
000A7D DB76 214EED          10      LD  HL,PATHD
000A80 DB79 FE21             7      CP  021H
000A82 DB7B 300C            12      JR  NC,CPATH0
       DB7D                     CPATHP:
000A84 DB7D 7E               7      LD  A,(HL)
000A85 DB7E 23               6      INC HL
000A86 DB7F FE20             7      CP  020H
000A88 DB81 3F               4      CCF
000A89 DB82 30EA            12      JR  NC,LTNL
000A8B DB84 CD19E3          17      CALL    MSG_A
000A8E DB87 18F4            12      JR  CPATHP
       DB89                     CPATH0:
000A90 DB89 FE3B             7      CP  ';'
000A92 DB8B 2001            12      JR  NZ,CPATH1
000A94 DB8D 13               6      INC DE
       DB8E                     CPATH1:
000A95 DB8E EB               4      EX  DE,HL
000A96 DB8F 013B00          10      LD  BC,PATHX
000A99 DB92 EDB0                    LDIR
000A9B DB94 C9              10      RET
                                
       DB95                     PUTDRV:
000A9C DB95 3A14EE          13      LD  A,(FDRV)
000A9F DB98 CD14F1          17      CALL    GETDRV1
000AA2 DB9B C641             7      ADD A,'A'
000AA4 DB9D CD19E3          17      CALL    MSG_A
000AA7 DBA0 3E3A             7      LD  A,':'
       DBA2                     MSG_AR:
000AA9 DBA2 C319E3          10      JP  MSG_A
                                
       DBA5                     PRDEC_HL:
000AAC DBA5 AF               4      XOR A
000AAD DBA6 5F               4      LD  E,A
000AAE DBA7 57               4      LD  D,A
       DBA8                     PRDEC_DEHL:
000AAF DBA8 D5              11      PUSH    DE
000AB0 DBA9 110FEE          10      LD  DE,DECBF
000AB3 DBAC 0605             7      LD  B,5
000AB5 DBAE CD3FDC          17      CALL    ZERO_MEMORY_DE  ;A=0
000AB8 DBB1 D1              10      POP DE
                                
000AB9 DBB2 0E20             7      LD  C,32
       DBB4                     DEC1:
000ABB DBB4 29              11      ADD HL,HL
000ABC DBB5 EB               4      EX  DE,HL
000ABD DBB6 ED6A            15      ADC HL,HL
000ABF DBB8 EB               4      EX  DE,HL
000AC0 DBB9 E5              11      PUSH    HL
000AC1 DBBA 2113EE          10      LD  HL,DECBF+4
000AC4 DBBD 0605             7      LD  B,5
       DBBF                     DEC2:
000AC6 DBBF 7E               7      LD  A,(HL)
000AC7 DBC0 8F               4      ADC A,A
000AC8 DBC1 27               4      DAA
000AC9 DBC2 77               7      LD  (HL),A
000ACA DBC3 2B               6      DEC HL
000ACB DBC4 10F9            13      DJNZ    DEC2
000ACD DBC6 E1              10      POP HL
000ACE DBC7 0D               4      DEC C
000ACF DBC8 20EA            12      JR  NZ,DEC1
                                
000AD1 DBCA 210FEE          10      LD  HL,DECBF
000AD4 DBCD 3E20             7      LD  A,020H
000AD6 DBCF 0604             7      LD  B,4
       DBD1                     DEC3:
000AD8 DBD1 CDDEDB          17      CALL    DEC4
000ADB DBD4 CDDEDB          17      CALL    DEC4
000ADE DBD7 23               6      INC HL
000ADF DBD8 10F7            13      DJNZ    DEC3
       DBDA                     DECX:
000AE1 DBDA CDDEDB          17      CALL    DEC4
000AE4 DBDD AF               4      XOR A
       DBDE                     DEC4:
000AE5 DBDE ED6F            18      RLD
000AE7 DBE0 FE20             7      CP  020H
000AE9 DBE2 2802            12      JR  Z,DEC5
000AEB DBE4 F630             7      OR  030H
       DBE6                     DEC5:
000AED DBE6 18BA            12      JR  MSG_AR
                                
       DBE8                     FPRNT:
000AEF DBE8 0608             7      LD  B,8 ;ファイル名を表示
000AF1 DBEA CDF9DB          17      CALL    P_N1
000AF4 DBED 7E               7      LD  A,(HL)
000AF5 DBEE CD33F3          17      CALL    CAP3
000AF8 DBF1 D8              11      RET C   ;拡張子が無い
                                
000AF9 DBF2 3E2E             7      LD  A,'.'
000AFB DBF4 CD19E3          17      CALL    MSG_A
000AFE DBF7 0603             7      LD  B,3 ;拡張子を表示
       DBF9                     P_N1:
000B00 DBF9 7E               7      LD  A,(HL)
000B01 DBFA CD33F3          17      CALL    CAP3
000B04 DBFD 3807            12      JR  C,P_N2
000B06 DBFF CD19E3          17      CALL    MSG_A
000B09 DC02 23               6      INC HL
000B0A DC03 10F4            13      DJNZ    P_N1
000B0C DC05 C9              10      RET
       DC06                     P_N2:
000B0D DC06 23               6      INC HL
000B0E DC07 10FD            13      DJNZ    P_N2
000B10 DC09 C9              10      RET
                                
       DC0A                     SETFCB:
000B11 DC0A CDE1F0          17      CALL    SPCUT
000B14 DC0D 1A               7      LD  A,(DE)
000B15 DC0E FE20             7      CP  020H
000B17 DC10 3801            12      JR  C,SETFCBA
000B19 DC12 1B               6      DEC DE
       DC13                     SETFCBA:
000B1A DC13 0624             7      LD  B,36
000B1C DC15 215C00          10      LD  HL,FCB1
000B1F DC18 E5              11      PUSH    HL
000B20 DC19 AF               4      XOR A
000B21 DC1A CDB6F0          17      CALL    FILL_MEMORY
000B24 DC1D E1              10      POP HL
000B25 DC1E D5              11      PUSH    DE
000B26 DC1F CD09E0          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000B29 DC22 216C00          10      LD  HL,FCB2
000B2C DC25 CD09E0          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000B2F DC28 E1              10      POP HL
000B30 DC29 010050          10      LD  BC,05000H
000B33 DC2C 118100          10      LD  DE,00081H
       DC2F                     SETFCB1:
000B36 DC2F 7E               7      LD  A,(HL)
000B37 DC30 23               6      INC HL
000B38 DC31 FE20             7      CP  020H
000B3A DC33 3805            12      JR  C,SETFCB2
000B3C DC35 12               7      LD  (DE),A
000B3D DC36 13               6      INC DE
000B3E DC37 0C               4      INC C
000B3F DC38 10F5            13      DJNZ    SETFCB1
       DC3A                     SETFCB2:
000B41 DC3A 79               4      LD  A,C
000B42 DC3B 328000          13      LD  (DTA1),A
000B45 DC3E 04               4      INC B
       DC3F                     ZERO_MEMORY_DE:
000B46 DC3F AF               4      XOR A
       DC40                     FILL_MEMORY_DE:
000B47 DC40 12               7      LD  (DE),A
000B48 DC41 13               6      INC DE
000B49 DC42 10FC            13      DJNZ    FILL_MEMORY_DE
000B4B DC44 C9              10      RET
                                
       DC45                     C_COPY:
000B4C DC45 CD0ADC          17      CALL    SETFCB
                                
000B4F DC48 1161EE          10      LD  DE,ZERO
000B52 DC4B CD03F0          17      CALL    FILEC2
000B55 DC4E 216C00          10      LD  HL,FCB2
000B58 DC51 CD10E0          17      CALL    S29X1
                                
000B5B DC54 3E10             7      LD  A,010H
000B5D DC56 326900          13      LD  (FCB1+13),A
000B60 DC59 216D00          10      LD  HL,FCB2FN
000B63 DC5C CD20DD          17      CALL    CWILD1
       DC5F                     COPY0:
000B66 DC5F CD1DDD          17      CALL    CWILD
000B69 DC62 215C00          10      LD  HL,FCB1
000B6C DC65 CDC6D9          17      CALL    OPEN
000B6F DC68 37               4      SCF
       DC69                     COPY1:
000B70 DC69 C0              11      RET NZ
000B71 DC6A CDD9D9          17      CALL    DEFCB
                                
000B74 DC6D 3A97ED          13      LD  A,(DTA_CCP+13)
000B77 DC70 CB67             8      BIT 4,A
000B79 DC72 2821            12      JR  Z,COPY1A
                                
000B7B DC74 215D00          10      LD  HL,FCB1FN
000B7E DC77 CD46F4          17      CALL    CHKWILD
000B81 DC7A 3814            12      JR  C,COPY9
                                
000B83 DC7C 3E20             7      LD  A,020H
000B85 DC7E 325D00          13      LD  (FCB1FN),A
000B88 DC81 2AA4ED          16      LD  HL,(DTA_CCP+26)
000B8B DC84 23               6      INC HL
000B8C DC85 226A00          16      LD  (FCB1+14),HL
000B8F DC88 18D5            12      JR  COPY0
                                
       DC8A                     COPY8:
000B91 DC8A CDD0DD          17      CALL    _SYS09      ;(BDOS)文字列出力
000B94 DC8D CD6EDB          17      CALL    LTNL
       DC90                     COPY9:
000B97 DC90 CDD5D9          17      CALL    OPEN2
000B9A DC93 18D4            12      JR  COPY1
                                
       DC95                     COPY1A:
000B9C DC95 216C00          10      LD  HL,FCB2
000B9F DC98 1114EE          10      LD  DE,FDRV
000BA2 DC9B 018CED          10      LD  BC,DTA_CCP+2
000BA5 DC9E EDA0            16      LDI
000BA7 DCA0 3E0B             7      LD  A,11
       DCA2                     COPY2:
000BA9 DCA2 F5              11      PUSH    AF
000BAA DCA3 7E               7      LD  A,(HL)
000BAB DCA4 FE3F             7      CP  '?'
000BAD DCA6 2001            12      JR  NZ,COPY3
000BAF DCA8 0A               7      LD  A,(BC)
       DCA9                     COPY3:
000BB0 DCA9 12               7      LD  (DE),A
000BB1 DCAA 03               6      INC BC
000BB2 DCAB 13               6      INC DE
000BB3 DCAC 23               6      INC HL
000BB4 DCAD F1              10      POP AF
000BB5 DCAE 3D               4      DEC A
000BB6 DCAF 20F1            12      JR  NZ,COPY2
000BB8 DCB1 010500          10      LD  BC,16-11
000BBB DCB4 EDB0                    LDIR
       DCB6                     PUTNAME:
000BBD DCB6 215D00          10      LD  HL,FCB1FN
000BC0 DCB9 CD46F4          17      CALL    CHKWILD
000BC3 DCBC 300B            12      JR  NC,PUTN1
000BC5 DCBE 2115EE          10      LD  HL,FDRV+1
000BC8 DCC1 CDE8DB          17      CALL    FPRNT
000BCB DCC4 3E20             7      LD  A,020H
000BCD DCC6 CD19E3          17      CALL    MSG_A
       DCC9                     PUTN1:
000BD0 DCC9 1114EE          10      LD  DE,FDRV
000BD3 DCCC 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
000BD5 DCCE CDF4D9          17      CALL    SYSTEM0
000BD8 DCD1 2048            12      JR  NZ,COPYE2
000BDA DCD3 67               4      LD  H,A     ;A=0
000BDB DCD4 6F               4      LD  L,A
000BDC DCD5 2235EE          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
000BDF DCD8 2237EE          16      LD  (FDRV+35),HL
       DCDB                     COPY6:
000BE2 DCDB CDFDD9          17      CALL    S27BUF
000BE5 DCDE 47               4      LD  B,A
000BE6 DCDF 3C               4      INC A
000BE7 DCE0 2831            12      JR  Z,COPYE
000BE9 DCE2 7C               4      LD  A,H
000BEA DCE3 B5               4      OR  L
000BEB DCE4 280C            12      JR  Z,COPY7
000BED DCE6 1114EE          10      LD  DE,FDRV
000BF0 DCE9 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
000BF2 DCEB CDF4D9          17      CALL    SYSTEM0
000BF5 DCEE 2023            12      JR  NZ,COPYE
000BF7 DCF0 10E9            13      DJNZ    COPY6
       DCF2                     COPY7:
000BF9 DCF2 3A97ED          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
000BFC DCF5 3221EE          13      LD  (FDRV+13),A
000BFF DCF8 219EED          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
000C02 DCFB 1128EE          10      LD  DE,FDRV+20
000C05 DCFE 010400          10      LD  BC,4
000C08 DD01 EDB0                    LDIR
                                
000C0A DD03 1114EE          10      LD  DE,FDRV
000C0D DD06 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
000C0F DD08 CDF4D9          17      CALL    SYSTEM0
000C12 DD0B 2006            12      JR  NZ,COPYE
                                
000C14 DD0D 1171EE          10      LD  DE,OK
000C17 DD10 C38ADC          10      JP  COPY8
                                
       DD13                     COPYE:
000C1A DD13 1114EE          10      LD  DE,FDRV
000C1D DD16 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
000C1F DD18 CD0500          17      CALL    SYSTEM
       DD1B                     COPYE2:
000C22 DD1B 37               4      SCF
000C23 DD1C C9              10      RET
                                
       DD1D                     CWILD:
000C24 DD1D 215D00          10      LD  HL,FCB1FN
       DD20                     CWILD1:
000C27 DD20 7E               7      LD  A,(HL)
000C28 DD21 FE20             7      CP  020H
000C2A DD23 C0              11      RET NZ
       DD24                     CWILD2:
000C2B DD24 3E3F             7      LD  A,'?'
000C2D DD26 060B             7      LD  B,11
000C2F DD28 C3B6F0          10      JP  FILL_MEMORY
                                
       DD2B                     COMTB:
000C32 DD2B 44202020                DB  "D   "  ;1
000C36 DD2F DCDA                    DW  C_DIR
000C38 DD31 44495220                DB  "DIR "  ;2
000C3C DD35 DCDA                    DW  C_DIR
000C3E DD37 434F5059                DB  "COPY"  ;3
000C42 DD3B 45DC                    DW  C_COPY
000C44 DD3D 43442020                DB  "CD  "  ;4
000C48 DD41 F9D9                    DW  C_CD
000C4A DD43 44454C20                DB  "DEL "  ;5
000C4E DD47 BFDA                    DW  C_DEL
000C50 DD49 50415448                DB  "PATH"  ;6
000C54 DD4D 73DB                    DW  C_PATH
000C56 DD4F 52454E20                DB  "REN "  ;7
000C5A DD53 C9DA                    DW  C_REN
000C5C DD55 52454D20                DB  "REM "  ;8
000C60 DD59 CDDD                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "88DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   PC-8801mkIISR
                                
                                ;   BANK RAM DISK DRIVER
                                
       DD5B                     BDWT:
000C62 DD5B 3E10             7      LD  A,010H  ;ライト可　リード不可
000C64 DD5D 1802            12  JR  BRW
                                
       DD5F                     BDRD:
000C66 DD5F 3E01             7      LD  A,001H  ;ライト不可　リード可
       DD61                     BRW:
000C68 DD61 F3               4      DI
000C69 DD62 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000C6B DD64 ED739BDD        20      LD  (BANKSP),SP
000C6F DD68 3A9CDD          13      LD  A,(BANKSPH)
000C72 DD6B 87               4      ADD A,A
000C73 DD6C 3803            12      JR  C,BRW1
000C75 DD6E 314EED          10      LD  SP,EXTSP    ;拡張メモリにスタックが重なる場合
       DD71                     BRW1:
000C78 DD71 C5              11      PUSH    BC
000C79 DD72 D5              11      PUSH    DE
000C7A DD73 EB               4      EX  DE,HL       ;DE=メインメモリ
000C7B DD74 29              11      ADD HL,HL
000C7C DD75 29              11      ADD HL,HL
000C7D DD76 7C               4      LD  A,H
000C7E DD77 DD860C          19      ADD A,(IX+DPB_MAXCYL)
000C81 DD7A D3E3            11      OUT (0E3H),A    ;拡張RAM バンク選択
000C83 DD7C 65               4      LD  H,L
000C84 DD7D CB3C             8      SRL H   ;/2
000C86 DD7F 2E00             7      LD  L,0
000C88 DD81 DBE2            11      IN  A,(0E2H)    ;拡張RAM リード/ライト制御
000C8A DD83 0F               4      RRCA
000C8B DD84 3001            12      JR  NC,BRW2     ;0: リード可
000C8D DD86 EB               4      EX  DE,HL       ;DE=拡張メモリ HL=メインメモリ
       DD87                     BRW2:
000C8E DD87 010002          10      LD  BC,512
000C91 DD8A EDB0                    LDIR
                                
000C93 DD8C DBE2            11      IN  A,(0E2H)    ;拡張RAM リード/ライト制御
000C95 DD8E 0F               4      RRCA
000C96 DD8F 3801            12      JR  C,BRW3      ;1: リード不可
000C98 DD91 EB               4      EX  DE,HL       ;DE=拡張メモリ HL=メインメモリ
       DD92                     BRW3:
000C99 DD92 D1              10      POP DE
000C9A DD93 C1              10      POP BC
000C9B DD94 13               6      INC DE
000C9C DD95 10DA            13      DJNZ    BRW1
                                
000C9E DD97 AF               4      XOR A
000C9F DD98 D3E2            11      OUT (0E2H),A    ;メインメモリに切り替える
000CA1 DD9A 310000          10      LD  SP,0
       DD9B                     BANKSP  EQU $-2
       DD9C                     BANKSPH EQU $-1
000CA4 DD9D FB               4      EI
000CA5 DD9E C9              10      RET
                                
[EOF:88DISK2.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       DD9F                     BDOS0:
000CA6 DD9F E5              11      PUSH    HL
000CA7 DDA0 79               4      LD  A,C
000CA8 DDA1 FE3C             7      CP  03CH
000CAA DDA3 3802            12      JR  C,DOS1
000CAC DDA5 3E3C             7      LD  A,03CH
       DDA7                     DOS1:
000CAE DDA7 87               4      ADD A,A
000CAF DDA8 32ACDD          13      LD  (DOS1_SWC),A
000CB2 DDAB 2A00EF          16      LD  HL,(STABLE)
       DDAC                     DOS1_SWC    EQU $-2
000CB5 DDAE E3              19      EX  (SP),HL
000CB6 DDAF 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
000CB7 DDB0 C9              10      RET
       DDB1                     _DOS2:
000CB8 DDB1 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000CBA DDB3 CA4BE0          10      JP  Z,_SYS5A
000CBD DDB6 FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000CBF DDB8 CA08E0          10      JP  Z,_SYS5C
000CC2 DDBB FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
000CC4 DDBD CABEEA          10      JP  Z,_SYS5F
000CC7 DDC0 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000CC9 DDC2 200A            12      JR  NZ,_ERROR
000CCB DDC4 011D01          10      LD  BC,VER_6F
000CCE DDC7 116201          10      LD  DE,VER
000CD1 DDCA 210201          10      LD  HL,MACD
       DDCD                     C_REM:
000CD4 DDCD AF               4      XOR A
       DDCE                     _ERROR:
000CD5 DDCE A7               4      AND A
000CD6 DDCF C9              10      RET
                                
       DDD0                     _SYS09:     ;文字列出力
000CD7 DDD0 D5              11      PUSH    DE
       DDD1                     _SX09:
000CD8 DDD1 1A               7      LD  A,(DE)
000CD9 DDD2 13               6      INC DE
000CDA DDD3 FE24             7      CP  '$'
000CDC DDD5 2831            12      JR  Z,SX0E2
000CDE DDD7 CD19E3          17      CALL    MSG_A
000CE1 DDDA 18F5            12      JR  _SX09
                                
       DDDC                     MSX1:
000CE3 DDDC CD19E3          17      CALL    MSG_A
       DDDF                     MSX:
000CE6 DDDF 7E               7      LD  A,(HL)
000CE7 DDE0 23               6      INC HL
000CE8 DDE1 B7               4      OR  A
000CE9 DDE2 20F8            12      JR  NZ,MSX1
000CEB DDE4 C9              10      RET
                                
       DDE5                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000CEC DDE5 212200          10      LD  HL,00022H
000CEF DDE8 7D               4      LD  A,L
000CF0 DDE9 C9              10      RET
                                
       DDEA                     _SYS0D:     ;(BDOS)ディスクリセット
000CF1 DDEA CDDFEE          17      CALL    _FFLUSH
000CF4 DDED E5              11      PUSH    HL
000CF5 DDEE 218000          10      LD  HL,00080H
000CF8 DDF1 228AEE          16      LD  (_DTA),HL
000CFB DDF4 E1              10      POP HL
000CFC DDF5 D5              11      PUSH    DE
000CFD DDF6 1E00             7      LD  E,0
000CFF DDF8 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       DDF9                     _SYS0E:     ;(BDOS)カレントドライブの設定
000D00 DDF9 D5              11      PUSH    DE
000D01 DDFA 7B               4      LD  A,E
000D02 DDFB DDE5            15      PUSH    IX
000D04 DDFD CDDCEE          17      CALL    _GETDPB
000D07 DE00 DDE1            14      POP IX
000D09 DE02 3804            12      JR  C,SX0E2
000D0B DE04 7B               4      LD  A,E
000D0C DE05 320400          13      LD  (_DVSW),A
       DE08                     SX0E2:
000D0F DE08 D1              10      POP DE
000D10 DE09 C9              10      RET
                                
       DE0A                     _SYS0F:     ;(BDOS)ファイルのオープン
000D11 DE0A CDF3F0          17      CALL    SETDRV
000D14 DE0D FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000D17 DE10 C602             7      ADD A,002H      ;Write
000D19 DE12 2848            12      JR  Z,FEND0F
000D1B DE14 CD42F4          17      CALL    CHKWILDX
                                
000D1E DE17 D41DF1          17      CALL    NC,SOPENX
       DE1A                     _S16XX:
000D21 DE1A 3840            12      JR  C,FEND0F
                                                ;Directory location
000D23 DE1C 3A9FEE          13      LD  A,(_FILEN)
000D26 DE1F FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
000D29 DE22 3AA0EE          13      LD  A,(_DIRF)
000D2C DE25 FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000D2F DE28 FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
000D32 DE2B FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
000D35 DE2E FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
000D39 DE32 FDE5            15      PUSH    IY
000D3B DE34 D1              10      POP DE
000D3C DE35 13               6      INC DE
000D3D DE36 010B00          10      LD  BC,11
000D40 DE39 EDB0                    LDIR
                                ;               Attribute
000D42 DE3B 7E               7      LD  A,(HL)
000D43 DE3C FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
000D46 DE3F 110B00          10      LD  DE,11       ;Reserved
000D49 DE42 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
000D4A DE43 11E4EF          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
000D4D DE46 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DE48                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000D4F DE48 1A               7      LD  A,(DE)
000D50 DE49 13               6      INC DE
000D51 DE4A 3251DE          13      LD  (S16PAT),A
000D54 DE4D 7E               7      LD  A,(HL)
000D55 DE4E 23               6      INC HL
000D56 DE4F FD7700          19      LD  (IY+0),A
       DE51                     S16PAT  EQU $-1
000D59 DE52 10F4            13      DJNZ    S16LOOP
                                
000D5B DE54 AF               4      XOR A
000D5C DE55 FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000D5F DE58 FD22F9DE        20      LD  (OFCB_SWC),IY
       DE5C                     FEND0F:
000D63 DE5C 1845            12      JR  FEND10
                                
       DE5E                     _SYS10:     ;(BDOS)ファイルのクローズ
000D65 DE5E CDF3F0          17      CALL    SETDRV
000D68 DE61 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000D6B DE64 D6FE             7      SUB 0FEH
000D6D DE66 37               4      SCF
000D6E DE67 3F               4      CCF
000D6F DE68 2039            12      JR  NZ,FEND10
       DE6A                     _S10A:              ;Write
000D71 DE6A FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000D74 DE6D FD770F          19      LD  (IY+15),A
                                
000D77 DE70 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
000D7A DE73 CD3EF5          17      CALL    SETTMS
                                
000D7D DE76 FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000D80 DE79 32A0EE          13      LD  (_DIRF),A
000D83 DE7C E67F             7      AND 07FH
000D85 DE7E 32DEE7          13      LD  (_SECPS),A
000D88 DE81 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000D8B DE84 FD561F          19      LD  D,(IY+31)
000D8E DE87 CD51F2          17      CALL    READ_DIR
000D91 DE8A 3817            12      JR  C,FEND10
                                
000D93 DE8C 3A7DF1          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000D96 DE8F 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000D97 DE90 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000D9A DE93 6F               4      LD  L,A
000D9B DE94 2600             7      LD  H,0
000D9D DE96 29              11      ADD HL,HL       ;*2
000D9E DE97 29              11      ADD HL,HL       ;*4
000D9F DE98 29              11      ADD HL,HL       ;*8
000DA0 DE99 29              11      ADD HL,HL       ;*16
000DA1 DE9A 29              11      ADD HL,HL       ;*32
000DA2 DE9B ED4B7EEF        20      LD  BC,(_DTBUF)
000DA6 DE9F 09              11      ADD HL,BC
                                
000DA7 DEA0 CD52F4          17      CALL    SDIRENT
       DEA3                     FEND10:
000DAA DEA3 1842            12      JR  FEND
                                
       DEA5                     _SYS11:     ;(BDOS)最初のファイルの検索
000DAC DEA5 CDF3F0          17      CALL    SETDRV
000DAF DEA8 CD4CF1          17      CALL    SOPEN
       DEAB                     _S12X1:
000DB2 DEAB 383A            12      JR  C,FEND
000DB4 DEAD CDEBF1          17      CALL    SOPENE2
000DB7 DEB0 ED5B8AEE        20      LD  DE,(_DTA)
000DBB DEB4 3A88EE          13      LD  A,(_DRV)
000DBE DEB7 3C               4      INC A
000DBF DEB8 12               7      LD  (DE),A
000DC0 DEB9 D5              11      PUSH    DE
000DC1 DEBA 13               6      INC DE
000DC2 DEBB 012000          10      LD  BC,32
000DC5 DEBE EDB0                    LDIR
000DC7 DEC0 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000DCA DEC3 FD660F          19      LD  H,(IY+15)
000DCD DEC6 22F4EF          16      LD  (SCDIR),HL
000DD0 DEC9 2A9AEE          16      LD  HL,(_FBPS)
000DD3 DECC 22F6EF          16      LD  (SFBPS),HL
000DD6 DECF 2A9FEE          16      LD  HL,(_FILEN)
000DD9 DED2 7C               4      LD  A,H
000DDA DED3 B7               4      OR  A
000DDB DED4 2806            12      JR  Z,_S12DIR
000DDD DED6 3ADEE7          13      LD  A,(_SECPS)
000DE0 DED9 F680             7      OR  080H
000DE2 DEDB 67               4      LD  H,A
       DEDC                     _S12DIR:
000DE3 DEDC 22F8EF          16      LD  (SFNDF),HL  ;Directory position and Flags
000DE6 DEDF E1              10      POP HL
000DE7 DEE0 1139EE          10      LD  DE,SFILE
000DEA DEE3 0E21             7      LD  C,33
       DEE5                     _S11B:
000DEC DEE5 EDB0                    LDIR
       DEE7                     FEND:
000DEE DEE7 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       DEE8                     FENDE:
000DEF DEE8 FDE1            14      POP IY
000DF1 DEEA C1              10      POP BC
000DF2 DEEB D1              10      POP DE
000DF3 DEEC E1              10      POP HL
000DF4 DEED C9              10      RET
                                
       DEEE                     _SYS12:     ;(BDOS)次のファイルの検索
000DF5 DEEE E5              11      PUSH    HL
000DF6 DEEF D5              11      PUSH    DE
000DF7 DEF0 C5              11      PUSH    BC
000DF8 DEF1 FDE5            15      PUSH    IY
000DFA DEF3 CDB0F1          17      CALL    NOPEN
000DFD DEF6 18B3            12      JR  _S12X1
                                
       DEF8                     _S16K:
000DFF DEF8 110000          10      LD  DE,0
       DEF9                     OFCB_SWC    EQU $-2
000E02 DEFB D5              11      PUSH    DE
000E03 DEFC 061A             7      LD  B,26        ;First cluster
       DEFE                     S16K1:
000E05 DEFE 13               6      INC DE
000E06 DEFF 23               6      INC HL
000E07 DF00 10FC            13      DJNZ    S16K1
                                
000E09 DF02 1A               7      LD  A,(DE)
000E0A DF03 BE               7      CP  (HL)
000E0B DF04 2015            12      JR  NZ,S16K2
000E0D DF06 13               6      INC DE
000E0E DF07 23               6      INC HL
000E0F DF08 1A               7      LD  A,(DE)
000E10 DF09 BE               7      CP  (HL)
000E11 DF0A 200F            12      JR  NZ,S16K2
                                
000E13 DF0C E1              10      POP HL
000E14 DF0D FDE5            15      PUSH    IY
000E16 DF0F D1              10      POP DE
000E17 DF10 7E               7      LD  A,(HL)
000E18 DF11 CD08F1          17      CALL    IS_SAME_DRV_A_DE
000E1B DF14 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000E1D DF16 ED52            15      SBC HL,DE       ;CP HL,DE
000E1F DF18 37               4      SCF
000E20 DF19 C0              11      RET NZ
000E21 DF1A E5              11      PUSH    HL
       DF1B                     S16K2:
000E22 DF1B E1              10      POP HL
       DF1C                     S16K3:
000E23 DF1C FDE5            15      PUSH    IY
000E25 DF1E D1              10      POP DE
       DF1F                     _SYS13:     ;(BDOS)ファイルの削除
000E26 DF1F CDF3F0          17      CALL    SETDRV
000E29 DF22 CD7AF3          17      CALL    KILL
       DF25                     FEND13:
000E2C DF25 18C0            12      JR  FEND
                                
       DF27                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000E2E DF27 CDF3F0          17      CALL    SETDRV
000E31 DF2A CD31E6          17      CALL    INIT_SEQ
       DF2D                     SREAD:
000E34 DF2D CD03E6          17      CALL    RB_READ
                                
000E37 DF30 C601             7      ADD A,001H
000E39 DF32 38B3            12      JR  C,FEND
                                
000E3B DF34 7D               4      LD  A,L
000E3C DF35 D601             7      SUB 001H
       DF37                     FENDX:
000E3E DF37 9F               4      SBC A,A
000E3F DF38 E603             7      AND 3
000E41 DF3A 1F               4      RRA
000E42 DF3B 18AB            12      JR  FENDE
                                
       DF3D                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000E44 DF3D CDF3F0          17      CALL    SETDRV
000E47 DF40 CD31E6          17      CALL    INIT_SEQ
       DF43                     SWRITE:
000E4A DF43 CDFEE5          17      CALL    RB_WRITE
                                
000E4D DF46 C6FF             7      ADD A,0FFH
000E4F DF48 18ED            12      JR  FENDX
                                
       DF4A                     _SYS17:     ;(BDOS)ファイル名の変更
000E51 DF4A CDF3F0          17      CALL    SETDRV
000E54 DF4D CDD0F3          17      CALL    NAME
000E57 DF50 18D3            12      JR  FEND13
                                
       DF52                     _SYS16:     ;(BDOS)ファイルの作成
000E59 DF52 CDF3F0          17      CALL    SETDRV
                                
000E5C DF55 CD42F4          17      CALL    CHKWILDX
000E5F DF58 38CB            12      JR  C,FEND13
000E61 DF5A FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000E64 DF5D FE05             7      CP  5
000E66 DF5F 2805            12      JR  Z,_S16X2
000E68 DF61 FE21             7      CP  021H
000E6A DF63 DA25DF          10      JP  C,FEND13
       DF66                     _S16X2:
                                ;               Clear FCB
000E6D DF66 FDE5            15      PUSH    IY
000E6F DF68 E1              10      POP HL
000E70 DF69 011000          10      LD  BC,16
000E73 DF6C 09              11      ADD HL,BC
       DF6D                     _S16X1:
000E74 DF6D 70               7      LD  (HL),B      ;B=0
000E75 DF6E 23               6      INC HL
000E76 DF6F 0D               4      DEC C
000E77 DF70 20FB            12      JR  NZ,_S16X1
                                
000E79 DF72 CD43F5          17      CALL    SETTMSX
000E7C DF75 FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000E80 DF79 CD1DF1          17      CALL    SOPENX
000E83 DF7C 3F               4      CCF
000E84 DF7D CCF8DE          17      CALL    Z,_S16K
000E87 DF80 D4FCF1          17      CALL    NC,COPEN
000E8A DF83 D452F4          17      CALL    NC,SDIRENT
000E8D DF86 C31ADE          10      JP  _S16XX
                                
       DF89                     _SYS21:     ;(BDOS)ランダムな読み出し
000E90 DF89 CDF3F0          17      CALL    SETDRV
000E93 DF8C CD8EF5          17      CALL    INIT_RND
000E96 DF8F 189C            12      JR  SREAD
                                
       DF91                     _SYS22:     ;(BDOS)ランダムな書き込み
       DF91                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000E98 DF91 CDF3F0          17      CALL    SETDRV
000E9B DF94 CD8EF5          17      CALL    INIT_RND
000E9E DF97 18AA            12      JR  SWRITE
                                
       DF99                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000EA0 DF99 21FF00          10      LD  HL,000FFH
000EA3 DF9C AF               4      XOR A
000EA4 DF9D C9              10      RET
                                
       DF9E                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000EA5 DF9E 3A0400          13      LD  A,(_DVSW)   ;from LDOS
000EA8 DFA1 A7               4      AND A
000EA9 DFA2 C9              10      RET
                                
       DFA3                     _SYS1A:     ;(BDOS)DTAの設定
000EAA DFA3 ED538AEE        20      LD  (_DTA),DE
000EAE DFA7 AF               4      XOR A
000EAF DFA8 C9              10      RET
                                
       DFA9                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000EB0 DFA9 7B               4      LD  A,E
000EB1 DFAA CD01F1          17      CALL    GETDRV
000EB4 DFAD CDDCEE          17      CALL    _GETDPB
000EB7 DFB0 D4E2EE          17      CALL    NC,_RDFATX
000EBA DFB3 210000          10      LD  HL,0
000EBD DFB6 D41CF5          17      CALL    NC,DSKF
                                
000EC0 DFB9 ED5B1DF5        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000EC4 DFBD 1B               6      DEC DE      ;DE←クラスタの総数
000EC5 DFBE FD2A7CEF        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000EC9 DFC2 9F               4      SBC A,A
000ECA DFC3 D8              11      RET C
000ECB DFC4 4F               4      LD  C,A     ;C=0
000ECC DFC5 DD7E0F          19      LD  A,(IX+DPB_BPS)
000ECF DFC8 E607             7      AND 7
000ED1 DFCA 47               4      LD  B,A
000ED2 DFCB DD7E07          19      LD  A,(IX+DPB_SECPCL)
000ED5 DFCE C9              10      RET
                                
       DFCF                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000ED6 DFCF AF               4      XOR A
000ED7 DFD0 67               4      LD  H,A
000ED8 DFD1 6F               4      LD  L,A
000ED9 DFD2 C9              10      RET
                                
       DFD3                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000EDA DFD3 2100F6          10      LD  HL,_DEVICE
000EDD DFD6 7B               4      LD  A,E
000EDE DFD7 C3DCEE          10      JP  _GETDPB
                                
       DFDA                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000EE1 DFDA E5              11      PUSH    HL
000EE2 DFDB 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000EE4 DFDD CD9FDD          17      CALL    BDOS0
000EE7 DFE0 381B            12      JR  C,_S23X1
                                
000EE9 DFE2 D5              11      PUSH    DE      ;EX DE,IY
000EEA DFE3 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000EEC DFE5 FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000EEF DFE8 FD6E11          19      LD  L,(IY+17)   ;
000EF2 DFEB FD6612          19      LD  H,(IY+18)   ;
000EF5 DFEE C5              11      PUSH    BC      ;
000EF6 DFEF FD4613          19      LD  B,(IY+19)   ;
000EF9 DFF2 CD80F5          17      CALL    GET_CPM_R_SIZE
000EFC DFF5 C1              10      POP BC
       DFF6                     _S24X1:
000EFD DFF6 CDA0F5          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000F00 DFF9 FDE3            23      EX  (SP),IY     ;
000F02 DFFB D1              10      POP DE      ;
                                
000F03 DFFC AF               4      XOR A
       DFFD                     _S23X1:
000F04 DFFD E1              10      POP HL
000F05 DFFE C9              10      RET
                                
       DFFF                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000F06 DFFF E5              11      PUSH    HL
000F07 E000 D5              11      PUSH    DE      ;EX DE,IY
000F08 E001 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000F0A E003 CD39E6          17      CALL    GETSEQ
000F0D E006 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       E008                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000F0F E008 2B               6      DEC HL
       E009                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000F10 E009 C5              11      PUSH    BC
000F11 E00A E5              11      PUSH    HL
000F12 E00B CD0BF0          17      CALL    FILE
000F15 E00E E1              10      POP HL
000F16 E00F C1              10      POP BC
       E010                     S29X1:
000F17 E010 C5              11      PUSH    BC
000F18 E011 D5              11      PUSH    DE
000F19 E012 E5              11      PUSH    HL
000F1A E013 EB               4      EX  DE,HL
000F1B E014 AF               4      XOR A
000F1C E015 3221EE          13      LD  (FDRV+13),A
000F1F E018 2114EE          10      LD  HL,FDRV
000F22 E01B 011000          10      LD  BC,16
000F25 E01E EDB0                    LDIR
000F27 E020 E1              10      POP HL
000F28 E021 D1              10      POP DE
000F29 E022 C1              10      POP BC
000F2A E023 C9              10      RET
                                
       E024                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000F2B E024 C5              11      PUSH    BC
000F2C E025 017FE9          10      LD  BC,DWT24B
000F2F E028 1804            12      JR  S2FX
       E02A                     _SYS2F:
000F31 E02A C5              11      PUSH    BC
000F32 E02B 0171E9          10      LD  BC,DRD24B
       E02E                     S2FX:
000F35 E02E ED4344E0        20      LD  (S2F_SWC),BC
000F39 E032 CDDFEE          17      CALL    _FFLUSH
                                
000F3C E035 D5              11      PUSH    DE
000F3D E036 E5              11      PUSH    HL
000F3E E037 7D               4      LD  A,L     ;Drive
000F3F E038 CDD9EE          17      CALL    _CHGDRV
000F42 E03B 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
000F44 E03D 44               4      LD  B,H     ;Number of clusters
000F45 E03E 2A8AEE          16      LD  HL,(_DTA)
                                
000F48 E041 0E00             7      LD  C,0
000F4A E043 CD71E9          17      CALL    DRD24B
       E044                     S2F_SWC EQU $-2
       E046                     POP_HL_DE_BC_SBCAA_RET:
000F4D E046 E1              10      POP HL
000F4E E047 D1              10      POP DE
000F4F E048 C1              10      POP BC
000F50 E049 9F               4      SBC A,A
000F51 E04A C9              10      RET
                                
       E04B                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000F52 E04B C5              11      PUSH    BC
000F53 E04C D5              11      PUSH    DE
000F54 E04D E5              11      PUSH    HL
000F55 E04E CD00F0          17      CALL    FILEC
000F58 E051 2146E0          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
000F5B E054 E5              11      PUSH    HL
000F5C E055 3A21EE          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
000F5F E058 E610             7      AND 010H        ;ディレクトリ
000F61 E05A 37               4      SCF
000F62 E05B C8              11      RET Z
000F63 E05C 1114EE          10      LD  DE,FDRV
000F66 E05F 2A4EEF          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       E062                     JPHL:
000F69 E062 E9               4      JP  (HL)
                                
       E063                     SHOW_ERROR:         ;(9)
000F6A E063 1179EE          10      LD  DE,COMERM
000F6D E066 CDD0DD          17      CALL    _SYS09      ;(BDOS)文字列出力
000F70 E069 C300EE          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "88IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   PC-8801mkIISR
                                ;   割り込み処理は0F000Hより前にする
                                
       DDCE                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       DDCE                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       DDCE                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       DDCE                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       DDCE                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       DDCE                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       E06C                     BDOS_RF:
000F73 E06C DB32            11      IN  A,(032H)
000F75 E06E F610             7      OR  010H        ;高速RAMアクセスモード/メインRAM
000F77 E070 D332            11      OUT (032H),A
000F79 E072 C39FDD          10      JP  BDOS0
                                
       E075                     _SYS0A:     ;(BDOS)文字列入力
000F7C E075 C5              11      PUSH    BC
000F7D E076 E5              11      PUSH    HL
000F7E E077 D5              11      PUSH    DE
000F7F E078 CDB2E1          17      CALL    GETL
000F82 E07B 1120FF          10      LD  DE,KBUF
000F85 E07E E1              10      POP HL
000F86 E07F E5              11      PUSH    HL
000F87 E080 0E00             7      LD  C,0
000F89 E082 3004            12      JR  NC,SAX0
000F8B E084 23               6      INC HL
000F8C E085 23               6      INC HL
000F8D E086 1808            12      JR  SAX4
       E088                     SAX0:
000F8F E088 46               7      LD  B,(HL)
000F90 E089 23               6      INC HL
       E08A                     SAX1:
000F91 E08A 23               6      INC HL
000F92 E08B 1A               7      LD  A,(DE)
000F93 E08C 13               6      INC DE
000F94 E08D B7               4      OR  A
000F95 E08E 2004            12      JR  NZ,SAX2
       E090                     SAX4:
000F97 E090 360D            10      LD  (HL),00DH
000F99 E092 1804            12      JR  SAX3
       E094                     SAX2:
000F9B E094 77               7      LD  (HL),A
000F9C E095 0C               4      INC C
000F9D E096 10F2            13      DJNZ    SAX1
       E098                     SAX3:
000F9F E098 D1              10      POP DE
000FA0 E099 79               4      LD  A,C
000FA1 E09A 13               6      INC DE
000FA2 E09B 12               7      LD  (DE),A
000FA3 E09C 1B               6      DEC DE
000FA4 E09D E1              10      POP HL
000FA5 E09E C1              10      POP BC
000FA6 E09F A7               4      AND A
000FA7 E0A0 C9              10      RET
                                
       E0A1                     _SYS2A:     ;(BDOS)日付の獲得
000FA8 E0A1 C5              11      PUSH    BC
000FA9 E0A2 CDE5E0          17      CALL    RTCREAD
000FAC E0A5 3A62EE          13      LD  A,(RTC_YY)
000FAF E0A8 CD6DE3          17      CALL    BCD
000FB2 E0AB 6F               4      LD  L,A
000FB3 E0AC 2600             7      LD  H,0
                                ;   LD  DE,1900     ;0076CH
                                ;   CP  90      ;90以上は1900年代 1990-1999
                                ;   JR  NC,RDDATE1  ;90未満は2000年代 2000-2089
                                ;   LD  E,0D0H      ;2000 & 0FFH D=007H
000FB5 E0AE 11D007          10      LD  DE,2000     ;すべて2000年代で処理 2000-2099
       E0B1                     RDDATE1:
000FB8 E0B1 19              11      ADD HL,DE
000FB9 E0B2 3A63EE          13      LD  A,(RTC_MW)
000FBC E0B5 57               4      LD  D,A
000FBD E0B6 3A64EE          13      LD  A,(RTC_DD)
000FC0 E0B9 CD6DE3          17      CALL    BCD
000FC3 E0BC 5F               4      LD  E,A
000FC4 E0BD 7A               4      LD  A,D
000FC5 E0BE 0604             7      LD  B,4
       E0C0                     RDDATE2:
000FC7 E0C0 CB3A             8      SRL D
000FC9 E0C2 10FC            13      DJNZ    RDDATE2
000FCB E0C4 C1              10      POP BC
000FCC E0C5 E607             7      AND 7
000FCE E0C7 C9              10      RET
                                
       E0C8                     _SYS2C:     ;(BDOS)時刻の獲得
000FCF E0C8 C5              11      PUSH    BC
000FD0 E0C9 CDE5E0          17      CALL    RTCREAD
000FD3 E0CC 3A65EE          13      LD  A,(RTC_TT)
000FD6 E0CF CD6DE3          17      CALL    BCD
000FD9 E0D2 67               4      LD  H,A
000FDA E0D3 3A66EE          13      LD  A,(RTC_MM)
000FDD E0D6 CD6DE3          17      CALL    BCD
000FE0 E0D9 6F               4      LD  L,A
000FE1 E0DA 3A67EE          13      LD  A,(RTC_SS)
000FE4 E0DD CD6DE3          17      CALL    BCD
000FE7 E0E0 57               4      LD  D,A
000FE8 E0E1 C1              10      POP BC
000FE9 E0E2 AF               4      XOR A
000FEA E0E3 5F               4      LD  E,A
000FEB E0E4 C9              10      RET
                                
       E0E5                     RTCREAD:
000FEC E0E5 0EF9             7      LD  C,0F9H
000FEE E0E7 3AB9EE          13      LD  A,(WK40)
000FF1 E0EA 5F               4      LD  E,A
000FF2 E0EB 3E03             7      LD  A,3     ;コマンド３：タイムリードにセット
000FF4 E0ED CD17E1          17      CALL    RTCCMD
000FF7 E0F0 3E01             7      LD  A,1     ;コマンド１：レジスタシフトにセット
000FF9 E0F2 CD17E1          17      CALL    RTCCMD
000FFC E0F5 0606             7      LD  B,6
000FFE E0F7 2167EE          10      LD  HL,RTC_SS
       E0FA                     RTCREAD1:
001001 E0FA C5              11      PUSH    BC
001002 E0FB 0608             7      LD  B,8
       E0FD                     RTCREAD2:
001004 E0FD DB40            11      IN  A,(40H)     ;システムモードセンス BIT4:CDI
001006 E0FF 87               4      ADD A,A
001007 E100 87               4      ADD A,A
001008 E101 87               4      ADD A,A
001009 E102 87               4      ADD A,A
00100A E103 CB1E            15      RR  (HL)
00100C E105 CD3CE1          17      CALL    RTCCLK
00100F E108 10F3            13      DJNZ    RTCREAD2
001011 E10A C1              10      POP BC
001012 E10B 2B               6      DEC HL
001013 E10C 10EC            13      DJNZ    RTCREAD1
001015 E10E AF               4      XOR A
001016 E10F CD17E1          17      CALL    RTCCMD
001019 E112 7B               4      LD  A,E
00101A E113 32B9EE          13      LD  (WK40),A
00101D E116 C9              10      RET
                                
       E117                     RTCCMD:
00101E E117 0604             7      LD  B,4
001020 E119 07               4      RLCA
001021 E11A 07               4      RLCA
001022 E11B 07               4      RLCA
       E11C                     RTCCMD1:
001023 E11C F5              11      PUSH    AF
001024 E11D F607             7      OR  7
001026 E11F D310            11      OUT (10H),A     ;プリンタデータ出力 兼 カレンダクロック(μPD1990AC)出力
001028 E121 CD3CE1          17      CALL    RTCCLK
00102B E124 F1              10      POP AF
00102C E125 0F               4      RRCA
00102D E126 10F4            13      DJNZ    RTCCMD1
00102F E128 3E07             7      LD  A,7
001031 E12A D310            11      OUT (10H),A     ;プリンタデータ出力 兼 カレンダクロック(μPD1990AC)出力
001033 E12C 7B               4      LD  A,E
001034 E12D A1               4      AND C
001035 E12E F602             7      OR  2
001037 E130 D340            11      OUT (40H),A     ;ストローブポート
001039 E132 A1               4      AND C
00103A E133 00               4      NOP
00103B E134 D340            11      OUT (40H),A     ;ストローブポート
00103D E136 5F               4      LD  E,A
00103E E137 060D             7      LD  B,13
       E139                     RTCCMD3:
001040 E139 10FE            13      DJNZ    RTCCMD3
001042 E13B C9              10      RET
                                
       E13C                     RTCCLK:
001043 E13C 7B               4      LD  A,E
001044 E13D A1               4      AND C
001045 E13E F604             7      OR  04H
001047 E140 D340            11      OUT (40H),A
001049 E142 A1               4      AND C
00104A E143 00               4      NOP
00104B E144 D340            11      OUT (40H),A
00104D E146 5F               4      LD  E,A
00104E E147 C9              10      RET
                                
       E148                     PRINT:
00104F E148 DB32            11      IN  A,(032H)
001051 E14A F5              11      PUSH    AF
001052 E14B E6EF             7      AND 0EFH        ;高速RAMアクセスモード/高速RAM
001054 E14D D332            11      OUT (032H),A
001056 E14F C5              11      PUSH    BC
001057 E150 E5              11      PUSH    HL
001058 E151 3E00             7      LD  A,000H      ;自己書き換え
       E152                     ESCFLG  EQU $-1
00105A E153 B7               4      OR  A
00105B E154 C255F0          10      JP  NZ,ESC
                                
00105E E157 3E1F             7      LD  A,01FH
001060 E159 BB               4      CP  E
001061 E15A D278F0          10      JP  NC,CTRL
       E15D                     INSFLG  EQU $
001064 E15D 0136F1          10      LD  BC,INSERT   ;自己書き換え
       E160                     ANK:
001067 E160 CD6EE1          17      CALL    LOC0
00106A E163 73               7      LD  (HL),E
00106B E164 CD89F0          17      CALL    CTRL1C
       E167                     PRINTE5:
00106E E167 E1              10      POP HL
00106F E168 C1              10      POP BC
001070 E169 F1              10      POP AF
001071 E16A D332            11      OUT (032H),A
001073 E16C AF               4      XOR A
001074 E16D C9              10      RET
                                
       E16E                     LOC0:
001075 E16E 2A8EEE          16      LD  HL,(_TXADR) ;L=x H=y
       E171                     LOC1:
001078 E171 D5              11      PUSH    DE
001079 E172 7C               4      LD  A,H
00107A E173 CB15             8      RL  L
00107C E175 CB3C             8      SRL H   ;*128
00107E E177 CB1D             8      RR  L
                                
001080 E179 87               4      ADD A,A ;*2
001081 E17A 87               4      ADD A,A ;*4
001082 E17B 87               4      ADD A,A ;*8
001083 E17C 5F               4      LD  E,A
001084 E17D 7D               4      LD  A,L
001085 E17E 93               4      SUB E
001086 E17F 5F               4      LD  E,A
                                
001087 E180 9F               4      SBC A,A
001088 E181 84               4      ADD A,H
001089 E182 57               4      LD  D,A
                                
00108A E183 2AB2EE          16      LD  HL,(TVRAMTOP)
00108D E186 19              11      ADD HL,DE
00108E E187 D1              10      POP DE
00108F E188 C9              10      RET
                                
       E189                     CONOUT1:
001090 E189 59               4      LD  E,C
001091 E18A CDCDEE          17      CALL    _PRINT
001094 E18D 7B               4      LD  A,E
001095 E18E FE0A             7      CP  00AH
001097 E190 2006            12      JR  NZ,CURSOR_ON
001099 E192 CD09F1          17      CALL    CTRL0D
00109C E195 CDF5F0          17      CALL    CTRL05
       E198                     CURSOR_ON:
00109F E198 F5              11      PUSH    AF
0010A0 E199 3E81             7      LD  A,081H
       E19B                     CURSOR0:
0010A2 E19B D351            11      OUT (051H),A
0010A4 E19D 3A8EEE          13      LD  A,(_TXADR)
0010A7 E1A0 D350            11      OUT (050H),A
0010A9 E1A2 3A8FEE          13      LD  A,(_TXADR+1)
0010AC E1A5 D350            11      OUT (050H),A
0010AE E1A7 F1              10      POP AF
0010AF E1A8 C9              10      RET
       E1A9                     CURSOR_OFF:
0010B0 E1A9 F5              11      PUSH    AF
0010B1 E1AA 3E80             7      LD  A,080H
0010B3 E1AC 18ED            12      JR  CURSOR0
                                
       E1AE                     POS:
0010B5 E1AE 2A8EEE          16      LD  HL,(_TXADR)
0010B8 E1B1 C9              10      RET
                                
       E1B2                     GETL:
0010B9 E1B2 CDD3EE          17      CALL    _POS
0010BC E1B5 E5              11      PUSH    HL
0010BD E1B6 3ECD             7      LD  A,0CDH      ;CALL ????
0010BF E1B8 325DE1          13      LD  (INSFLG),A
       E1BB                     GETL1:
0010C2 E1BB CD2FE3          17      CALL    _SYS08
0010C5 E1BE FE09             7      CP  9
0010C7 E1C0 2008            12      JR  NZ,GETL1V
0010C9 E1C2 2120FF          10      LD  HL,KBUF
0010CC E1C5 CDDFDD          17      CALL    MSX
0010CF E1C8 18F1            12      JR  GETL1
       E1CA                     GETL1V:
0010D1 E1CA 5F               4      LD  E,A
0010D2 E1CB CDCDEE          17      CALL    _PRINT
                                
0010D5 E1CE 7B               4      LD  A,E
0010D6 E1CF FE0D             7      CP  00DH
0010D8 E1D1 20E8            12      JR  NZ,GETL1
0010DA E1D3 3E01             7      LD  A,1     ;LD BC,????
0010DC E1D5 325DE1          13      LD  (INSFLG),A
0010DF E1D8 1120FF          10      LD  DE,KBUF
0010E2 E1DB 3E50             7      LD  A,WIDTH
0010E4 E1DD 47               4      LD  B,A
0010E5 E1DE CD3FDC          17      CALL    ZERO_MEMORY_DE
                                
0010E8 E1E1 D1              10      POP DE
0010E9 E1E2 CDD3EE          17      CALL    _POS
0010EC E1E5 6B               4      LD  L,E
0010ED E1E6 3E50             7      LD  A,WIDTH
0010EF E1E8 95               4      SUB L
0010F0 E1E9 57               4      LD  D,A
0010F1 E1EA CD71E1          17      CALL    LOC1
0010F4 E1ED 4D               4      LD  C,L
0010F5 E1EE 7C               4      LD  A,H
0010F6 E1EF F630             7      OR  030H
0010F8 E1F1 47               4      LD  B,A
0010F9 E1F2 5A               4      LD  E,D
0010FA E1F3 2120FF          10      LD  HL,KBUF
       E1F6                     GETL2:
0010FD E1F6 CDD0EE          17      CALL    _SCRN
001100 E1F9 03               6      INC BC
001101 E1FA 77               7      LD  (HL),A
001102 E1FB 23               6      INC HL
001103 E1FC 1D               4      DEC E
001104 E1FD 20F7            12      JR  NZ,GETL2
       E1FF                     GETL3:
001106 E1FF 2B               6      DEC HL
001107 E200 7E               7      LD  A,(HL)
001108 E201 FE21             7      CP  021H
00110A E203 D0              11      RET NC
00110B E204 3600            10      LD  (HL),0
00110D E206 15               4      DEC D
00110E E207 20F6            12      JR  NZ,GETL3
001110 E209 C9              10      RET
                                
       E20A                     INKEY:
001111 E20A FB               4      EI
001112 E20B E5              11      PUSH    HL
001113 E20C 2A90EE          16      LD  HL,(_KEYPS)
001116 E20F 7C               4      LD  A,H
001117 E210 AD               4      XOR L
001118 E211 280E            12      JR  Z,INKEY1
00111A E213 7C               4      LD  A,H
00111B E214 3C               4      INC A
00111C E215 E61F             7      AND 01FH
00111E E217 3291EE          13      LD  (_KEYPS+1),A
001121 E21A C610             7      ADD A,LOW KEYBF
001123 E21C 6F               4      LD  L,A
001124 E21D 26ED             7      LD  H,HIGH KEYBF
001126 E21F 7E               7      LD  A,(HL)
001127 E220 B7               4      OR  A
       E221                     INKEY1:
001128 E221 E1              10      POP HL
001129 E222 C9              10      RET
                                
       E223                     CHKEY:
00112A E223 C5              11      PUSH    BC
00112B E224 DB32            11      IN  A,(032H)
00112D E226 F5              11      PUSH    AF
00112E E227 E6EF             7      AND 0EFH        ;高速RAMアクセスモード/高速RAM
001130 E229 D332            11      OUT (032H),A
001132 E22B DB08            11      IN  A,(8)       ;6:SHIFT,7:CTRL
001134 E22D 4F               4      LD  C,A
001135 E22E 3A0E00          13      LD  A,(00EH)
001138 E231 CB5F             8      BIT 3,A
00113A E233 2002            12      JR  NZ,CHKEYRSHIFT
00113C E235 CBB1             8      RES 6,C
       E237                     CHKEYRSHIFT:
00113E E237 79               4      LD  A,C
00113F E238 3A93EE          13      LD  A,(_KEYST)
001142 E23B B9               4      CP  C
001143 E23C 3293EE          13      LD  (_KEYST),A
001146 E23F 280C            12      JR  Z,KEYST1
001148 E241 3A92EE          13      LD  A,(_KEYD)
00114B E244 B7               4      OR  A
00114C E245 2805            12      JR  Z,KEYST0
00114E E247 3E20             7      LD  A,020H      ;JR NZ,?
001150 E249 32DAE2          13      LD  (SETKEY1_SWC),A
       E24C                     KEYST0:
001153 E24C 79               4      LD  A,C
       E24D                     KEYST1:
001154 E24D E5              11      PUSH    HL
001155 E24E 0E00             7      LD  C,0
001157 E250 21B8F1          10      LD  HL,KEY_TABLE
00115A E253 CB77             8      BIT 6,A
00115C E255 2003            12      JR  NZ,CHKEY0
00115E E257 2120F2          10      LD  HL,SHIFT_TABLE
       E25A                     CHKEY0:
001161 E25A CB7F             8      BIT 7,A
001163 E25C 2003            12      JR  NZ,CHKEY1
001165 E25E 2188F2          10      LD  HL,CTRL_TABLE
       E261                     CHKEY1:
001168 E261 ED78            12      IN  A,(C)
00116A E263 0608             7      LD  B,8
       E265                     CHKEY2:
00116C E265 0F               4      RRCA
00116D E266 300B            12      JR  NC,CHKEY4
       E268                     CHKEY3:
00116F E268 23               6      INC HL
001170 E269 10FA            13      DJNZ    CHKEY2
001172 E26B 0C               4      INC C
001173 E26C 79               4      LD  A,C
001174 E26D D60D             7      SUB 00DH
001176 E26F 20F0            12      JR  NZ,CHKEY1
001178 E271 1804            12      JR  CHKEY5
       E273                     CHKEY4:
00117A E273 7E               7      LD  A,(HL)
00117B E274 B7               4      OR  A
00117C E275 28F1            12      JR  Z,CHKEY3
       E277                     CHKEY5:
00117E E277 E1              10      POP HL
00117F E278 C1              10      POP BC
001180 E279 4F               4      LD  C,A
001181 E27A 78               4      LD  A,B
001182 E27B D332            11      OUT (032H),A
001184 E27D 79               4      LD  A,C
001185 E27E C1              10      POP BC
001186 E27F B7               4      OR  A
001187 E280 3292EE          13      LD  (_KEYD),A
00118A E283 C9              10      RET
                                
       E284                     SCRN:
00118B E284 E5              11      PUSH    HL
00118C E285 DB32            11      IN  A,(032H)
00118E E287 67               4      LD  H,A
00118F E288 E6EF             7      AND 0EFH        ;高速RAMアクセスモード/高速RAM
001191 E28A D332            11      OUT (032H),A
001193 E28C 0A               7      LD  A,(BC)
001194 E28D 6F               4      LD  L,A
001195 E28E 7C               4      LD  A,H
001196 E28F D332            11      OUT (032H),A
001198 E291 7D               4      LD  A,L
001199 E292 E1              10      POP HL
00119A E293 C9              10      RET
                                
       E294                     VBLANK:
00119B E294 F5              11      PUSH    AF
       E295                     VBLANK0:
00119C E295 DB40            11      IN  A,(040H)
00119E E297 E620             7      AND 020H
0011A0 E299 20FA            12      JR  NZ,VBLANK0
       E29B                     VBLANK1:
0011A2 E29B DB40            11      IN  A,(040H)
0011A4 E29D E620             7      AND 020H
0011A6 E29F 28FA            12      JR  Z,VBLANK1
0011A8 E2A1 F1              10      POP AF
0011A9 E2A2 C9              10      RET
                                
       E2A3                     INTVRTC:
0011AA E2A3 F3               4      DI
0011AB E2A4 F5              11      PUSH    AF
0011AC E2A5 CD23E2          17      CALL    CHKEY
0011AF E2A8 FE00             7      CP  0
       E2A9                     KEYDT   EQU $-1
0011B1 E2AA 202D            12      JR  NZ,SETKEY1
0011B3 E2AC 3E3E             7      LD  A,03EH      ;LD A,?
0011B5 E2AE 32DAE2          13      LD  (SETKEY1_SWC),A
0011B8 E2B1 E5              11      PUSH    HL
0011B9 E2B2 2A90EE          16      LD  HL,(_KEYPS)
0011BC E2B5 7C               4      LD  A,H
0011BD E2B6 AD               4      XOR L
0011BE E2B7 E1              10      POP HL
0011BF E2B8 2011            12      JR  NZ,ENDKEY
0011C1 E2BA 3E00             7      LD  A,0
       E2BB                     KEYAR   EQU $-1
0011C3 E2BC B7               4      OR  A
0011C4 E2BD 2014            12      JR  NZ,ARWKEY
       E2BF                     SETKEY:
0011C6 E2BF 32BBE2          13      LD  (KEYAR),A
0011C9 E2C2 3A92EE          13      LD  A,(_KEYD)
0011CC E2C5 32A9E2          13      LD  (KEYDT),A
0011CF E2C8 CDE9E2          17      CALL    KEYSET
       E2CB                     ENDKEY:
0011D2 E2CB 3AB7EE          13      LD  A,(WKE4)
0011D5 E2CE D3E4            11      OUT (0E4H),A
0011D7 E2D0 F1              10      POP AF
0011D8 E2D1 FB               4      EI
0011D9 E2D2 C9              10      RET
       E2D3                     ARWKEY:
0011DA E2D3 3D               4      DEC A
0011DB E2D4 32BBE2          13      LD  (KEYAR),A
0011DE E2D7 18F2            12      JR  ENDKEY
       E2D9                     SETKEY1:
0011E0 E2D9 B7               4      OR  A
       E2DA                     SETKEY1_SWC:
0011E1 E2DA 20EF            12      JR  NZ,ENDKEY
0011E3 E2DC 3A95EE          13      LD  A,(_KEYSP_H)
0011E6 E2DF 18DE            12      JR  SETKEY
                                
       E2E1                     INTE88:
0011E8 E2E1 F5              11      PUSH    AF
0011E9 E2E2 3AB7EE          13      LD  A,(WKE4)
0011EC E2E5 D3E4            11      OUT (0E4H),A
0011EE E2E7 F1              10      POP AF
0011EF E2E8 C9              10      RET
       E2E9                     KEYSET:
       E2E9                     KEYBS:
0011F0 E2E9 B7               4      OR  A
0011F1 E2EA C8              11      RET Z
       E2EB                     KEYBS1:
0011F2 E2EB CD06E3          17      CALL    KEYBC_IFBREAK
0011F5 E2EE E5              11      PUSH    HL
0011F6 E2EF F5              11      PUSH    AF
0011F7 E2F0 2A90EE          16      LD  HL,(_KEYPS)
0011FA E2F3 2C               4      INC L
0011FB E2F4 CBAD             8      RES 5,L
0011FD E2F6 7D               4      LD  A,L
0011FE E2F7 BC               4      CP  H
0011FF E2F8 2818            12      JR  Z,POP_AF_HL_SCF_RET
001201 E2FA 3290EE          13      LD  (_KEYPS),A
001204 E2FD C610             7      ADD A,LOW KEYBF
001206 E2FF 6F               4      LD  L,A
001207 E300 26ED             7      LD  H,HIGH KEYBF
001209 E302 F1              10      POP AF
00120A E303 77               7      LD  (HL),A
00120B E304 E1              10      POP HL
00120C E305 C9              10      RET
       E306                     KEYBC_IFBREAK:
00120D E306 FE03             7      CP  3
00120F E308 C0              11      RET NZ
       E309                     KEYBC:
001210 E309 E5              11      PUSH    HL
001211 E30A 210000          10      LD  HL,0
001214 E30D 2290EE          16      LD  (_KEYPS),HL
001217 E310 E1              10      POP HL
001218 E311 C9              10      RET
                                
       E312                     POP_AF_HL_SCF_RET:
001219 E312 F1              10      POP AF
00121A E313 E1              10      POP HL
00121B E314 37               4      SCF
00121C E315 C9              10      RET
                                
       E316                     _SYS01:     ;(BDOS)コンソール入力
00121D E316 CD09EE          17      CALL    _SYS07
       E319                     MSG_A:
001220 E319 F5              11      PUSH    AF
001221 E31A D5              11      PUSH    DE
001222 E31B 5F               4      LD  E,A
001223 E31C CD22E3          17      CALL    _SYS02
001226 E31F D1              10      POP DE
001227 E320 F1              10      POP AF
001228 E321 C9              10      RET
                                
       E322                     _SYS02:     ;(BDOS)コンソール出力
001229 E322 CD34E3          17      CALL    BREAK
00122C E325 1805            12      JR  PRINTX
                                
       E327                     _SYS06:     ;(BDOS)コンソール直接入出力
00122E E327 7B               4      LD  A,E
00122F E328 3C               4      INC A
001230 E329 CACAEE          10      JP  Z,_INKEY
       E32C                     PRINTX:
001233 E32C C3CDEE          10      JP  _PRINT
                                
       E32F                     _SYS08:     ;(BDOS)エコーなしコンソール入力
001236 E32F CD09EE          17      CALL    _SYS07
001239 E332 1804            12      JR  BREAK1
       E334                     BREAK:
00123B E334 FB               4      EI
00123C E335 3A92EE          13      LD  A,(_KEYD)
       E338                     BREAK1:
00123F E338 FE03             7      CP  3       ;CTRL+C
001241 E33A CCF4EE          17      CALL    Z,_BREAK
001244 E33D FE13             7      CP  013H        ;CTRL+S
001246 E33F C0              11      RET NZ
                                
       E340                     PAUSE:
001247 E340 CD09E3          17      CALL    KEYBC
                                
       E343                     FLGET:
00124A E343 CDDFEE          17      CALL    _FFLUSH
00124D E346 E5              11      PUSH    HL
00124E E347 2A8EEE          16      LD  HL,(_TXADR)
001251 E34A CD98E1          17      CALL    CURSOR_ON
       E34D                     FLGET1:
001254 E34D CDCAEE          17      CALL    _INKEY
001257 E350 28FB            12      JR  Z,FLGET1
001259 E352 CDA9E1          17      CALL    CURSOR_OFF
00125C E355 E1              10      POP HL
00125D E356 C9              10      RET
                                
       E357                     _SYS0B:     ;(BDOS)コンソール状態のチェック
00125E E357 CD34E3          17      CALL    BREAK
001261 E35A 3A92EE          13      LD  A,(_KEYD)
001264 E35D B7               4      OR  A
001265 E35E C8              11      RET Z
       E35F                     CONSTX:
001266 E35F CDDFEE          17      CALL    _FFLUSH
001269 E362 E5              11      PUSH    HL
00126A E363 2A90EE          16      LD  HL,(_KEYPS)
00126D E366 7C               4      LD  A,H
00126E E367 AD               4      XOR L
00126F E368 E1              10      POP HL
001270 E369 C6FF             7      ADD A,0FFH
001272 E36B 9F               4      SBC A,A
001273 E36C C9              10      RET
                                
                                ;------------------------
                                ;BCDの10進数化
                                ;in
                                ;   A  : BCD
                                ;out
                                ;   A  : 10進数
                                ;------------------------
       E36D                     BCD:
001274 E36D 4F               4      LD  C,A
001275 E36E E6F0             7      AND 0F0H    ;10の位
001277 E370 0F               4      RRCA
001278 E371 47               4      LD  B,A
001279 E372 0F               4      RRCA
00127A E373 0F               4      RRCA
00127B E374 80               4      ADD A,B
00127C E375 47               4      LD  B,A
00127D E376 79               4      LD  A,C
00127E E377 E60F             7      AND 00FH    ;1の位
001280 E379 80               4      ADD A,B
001281 E37A C9              10      RET
[EOF:88IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E37B                     _SYS26:     ;(BDOS)ランダムブロック書き込み
001282 E37B AF               4      XOR A
001283 E37C 3264E6          13      LD  (DRDN1),A   ;NOP
001286 E37F 22EAF5          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
001289 E382 225DEE          16      LD  (LEFTX),HL
00128C E385 CDF3F0          17      CALL    SETDRV
                                
00128F E388 CDEEE4          17      CALL    RBX0
001292 E38B DA18E4          10      JP  C,RBWERR
001295 E38E CD7CF4          17      CALL    WOPEN
001298 E391 DA18E4          10      JP  C,RBWERR
00129B E394 7C               4      LD  A,H
00129C E395 B5               4      OR  L
00129D E396 CA11E4          10      JP  Z,RBW1
                                
0012A0 E399 2B               6      DEC HL
                                
0012A1 E39A CDBBF5          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0012A4 E39D 19              11      ADD HL,DE       ;BCHL=HL+BCDE
0012A5 E39E 3001            12      JR  NC,S26X1    ;
0012A7 E3A0 03               6      INC BC      ;
       E3A1                     S26X1:
0012A8 E3A1 CDE7F4          17      CALL    RWXR
0012AB E3A4 DC8DF4          17      CALL    C,WRDFX
0012AE E3A7 DA18E4          10      JP  C,RBWERR
                                
0012B1 E3AA CD1DE5          17      CALL    RBX2
0012B4 E3AD 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
0012B6 E3AF CD3CE5          17      CALL    RBXA
0012B9 E3B2 3864            12      JR  C,RBWERR
0012BB E3B4 EB               4      EX  DE,HL
0012BC E3B5 C5              11      PUSH    BC
0012BD E3B6 EDB0                    LDIR
0012BF E3B8 225FEE          16      LD  (DTAX),HL
                                
0012C2 E3BB CD1EF4          17      CALL    WTDB        ;バッファデータは更新された
                                
0012C5 E3BE 2A5DEE          16      LD  HL,(LEFTX)
0012C8 E3C1 D1              10      POP DE
0012C9 E3C2 ED52            15      SBC HL,DE
0012CB E3C4 225DEE          16      LD  (LEFTX),HL
0012CE E3C7 2831            12      JR  Z,RBWEND
                                
       E3C9                     RBWB:
0012D0 E3C9 CD71E5          17      CALL    RBXB
0012D3 E3CC 2814            12      JR  Z,RBWC
       E3CE                     RBWB1:
0012D5 E3CE C5              11      PUSH    BC
0012D6 E3CF D5              11      PUSH    DE
0012D7 E3D0 CDFBF2          17      CALL    CLUSTX
0012DA E3D3 CD95E5          17      CALL    DWTC
0012DD E3D6 D1              10      POP DE
0012DE E3D7 C1              10      POP BC
0012DF E3D8 D4E6E7          17      CALL    NC,GNCLX
0012E2 E3DB 383B            12      JR  C,RBWERR
0012E4 E3DD 10EF            13      DJNZ    RBWB1
0012E6 E3DF CDE5E5          17      CALL    DRW_FLUSH
       E3E2                     RBWC:
0012E9 E3E2 CD89E5          17      CALL    RBXC
0012EC E3E5 2813            12      JR  Z,RBWEND
0012EE E3E7 C5              11      PUSH    BC
0012EF E3E8 CDFBF2          17      CALL    CLUSTX
0012F2 E3EB CD63E6          17      CALL    DRDN
0012F5 E3EE C1              10      POP BC
0012F6 E3EF 3827            12      JR  C,RBWERR
0012F8 E3F1 ED5B7EEF        20      LD  DE,(_DTBUF)
0012FC E3F5 EDB0                    LDIR
0012FE E3F7 CD1EF4          17      CALL    WTDB        ;バッファデータは更新された
       E3FA                     RBWEND:
001301 E3FA CDE9F5          17      CALL    RBXEND
                                
001304 E3FD CDFDE4          17      CALL    RBX1
001307 E400 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
001309 E402 CDBBF5          17      CALL    GET_RR_BCDE ;BCDE=Random record
00130C E405 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
00130F E408 FD7211          19      LD  (IY+17),D   ;
001312 E40B FD7112          19      LD  (IY+18),C   ;
001315 E40E FD7013          19      LD  (IY+19),B   ;
       E411                     RBW1:
001318 E411 FDE1            14      POP IY
00131A E413 C1              10      POP BC
00131B E414 D1              10      POP DE
00131C E415 E1              10      POP HL
       E416                     DD_NUL:
00131D E416 AF               4      XOR A
       E417                     DRDF0:
       E417                     DWTF0:
00131E E417 C9              10      RET
                                
       E418                     RBWERR:
00131F E418 FDE5            15      PUSH    IY
001321 E41A D1              10      POP DE
001322 E41B 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
001324 E41D CD9FDD          17      CALL    BDOS0
       E420                     RBRERR1:
001327 E420 3E01             7      LD  A,001H
       E422                     RBRERR2:
001329 E422 FDE1            14      POP IY
00132B E424 C1              10      POP BC
00132C E425 D1              10      POP DE
00132D E426 E1              10      POP HL
00132E E427 37               4      SCF
00132F E428 210000          10      LD  HL,0
001332 E42B C9              10      RET
                                
       E42C                     RBRERR:
001333 E42C 3EFF             7      LD  A,0FFH
001335 E42E 18F2            12      JR  RBRERR2
                                
       E430                     RBRFL:
001337 E430 3E00             7  RBRFLP: LD  A,000H
001339 E432 FE0D             7      CP  00DH
00133B E434 2005            12      JR  NZ,RBRFL1
00133D E436 D5              11      PUSH    DE
00133E E437 1E0A             7      LD  E,00AH
001340 E439 1805            12      JR  RBRFL2
       E43B                     RBRFL1:
001342 E43B D5              11      PUSH    DE
001343 E43C CD09EE          17      CALL    _SYS07
001346 E43F 5F               4      LD  E,A
       E440                     RBRFL2:
001347 E440 CDCDEE          17      CALL    _PRINT
00134A E443 7B               4      LD  A,E
00134B E444 D1              10      POP DE
00134C E445 3231E4          13      LD  (RBRFLP+1),A
00134F E448 C9              10      RET
                                
                                                ;Read random block
       E449                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001350 E449 225DEE          16      LD  (LEFTX),HL
001353 E44C CDF3F0          17      CALL    SETDRV
                                
001356 E44F FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
00135A E453 C2DCE4          10      JP  NZ,RBRDIR   ;ディレクトリ
00135D E456 CDEEE4          17      CALL    RBX0
001360 E459 DA2CE4          10      JP  C,RBRERR
001363 E45C CDFDE4          17      CALL    RBX1
001366 E45F D415E5          17      CALL    NC,RBX1R
001369 E462 DA20E4          10      JP  C,RBRERR1
00136C E465 EB               4      EX  DE,HL
00136D E466 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
00136F E468 19              11      ADD HL,DE
001370 E469 79               4      LD  A,C
001371 E46A DE00             7      SBC A,0
001373 E46C 78               4      LD  A,B
001374 E46D DE00             7      SBC A,0
001376 E46F 3801            12      JR  C,RBR1
001378 E471 EB               4      EX  DE,HL
       E472                     RBR1:
001379 E472 9F               4      SBC A,A
00137A E473 E601             7      AND 1
00137C E475 32DAE4          13      LD  (RBRA_SWC),A
                                
00137F E478 7C               4      LD  A,H
001380 E479 B5               4      OR  L
001381 E47A 2857            12      JR  Z,RBREND0
                                
001383 E47C 22EAF5          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
001386 E47F 225DEE          16      LD  (LEFTX),HL
                                
001389 E482 CD1DE5          17      CALL    RBX2
00138C E485 2819            12      JR  Z,RBRB
00138E E487 CD3CE5          17      CALL    RBXA
001391 E48A DA2CE4          10      JP  C,RBRERR
001394 E48D C5              11      PUSH    BC
001395 E48E EDB0                    LDIR
001397 E490 ED535FEE        20      LD  (DTAX),DE
00139B E494 2A5DEE          16      LD  HL,(LEFTX)
00139E E497 D1              10      POP DE
00139F E498 A7               4      AND A
0013A0 E499 ED52            15      SBC HL,DE
0013A2 E49B 225DEE          16      LD  (LEFTX),HL
0013A5 E49E 2830            12      JR  Z,RBREND
                                
       E4A0                     RBRB:
0013A7 E4A0 CD71E5          17      CALL    RBXB
0013AA E4A3 2815            12      JR  Z,RBRC
       E4A5                     RBRB1:
0013AC E4A5 C5              11      PUSH    BC
0013AD E4A6 D5              11      PUSH    DE
0013AE E4A7 CDFBF2          17      CALL    CLUSTX
0013B1 E4AA CD9BE5          17      CALL    DRDC
0013B4 E4AD D1              10      POP DE
0013B5 E4AE C1              10      POP BC
0013B6 E4AF D4E6E7          17      CALL    NC,GNCLX
0013B9 E4B2 DA2CE4          10      JP  C,RBRERR
0013BC E4B5 10EE            13      DJNZ    RBRB1
0013BE E4B7 CDE5E5          17      CALL    DRW_FLUSH
       E4BA                     RBRC:
0013C1 E4BA CD89E5          17      CALL    RBXC
0013C4 E4BD 2811            12      JR  Z,RBREND
0013C6 E4BF C5              11      PUSH    BC
0013C7 E4C0 CDFBF2          17      CALL    CLUSTX
0013CA E4C3 CD47E6          17      CALL    DRDX
0013CD E4C6 C1              10      POP BC
0013CE E4C7 DA2CE4          10      JP  C,RBRERR
0013D1 E4CA EB               4      EX  DE,HL
0013D2 E4CB 2A7EEF          16      LD  HL,(_DTBUF)
0013D5 E4CE EDB0                    LDIR
       E4D0                     RBREND:
0013D7 E4D0 CDE9F5          17      CALL    RBXEND
       E4D3                     RBREND0:
0013DA E4D3 FDE1            14      POP IY
0013DC E4D5 C1              10      POP BC
0013DD E4D6 D1              10      POP DE
0013DE E4D7 F1              10      POP AF  ;(HL)
0013DF E4D8 AF               4      XOR A
0013E0 E4D9 3E00             7      LD  A,000H
       E4DA                     RBRA_SWC    EQU $-1
0013E2 E4DB C9              10      RET
                                
       E4DC                     RBRDIR:
0013E3 E4DC FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0013E6 E4DF FD661B          19      LD  H,(IY+27)
0013E9 E4E2 CD3AF3          17      CALL    CHDIR
0013EC E4E5 AF               4      XOR A
0013ED E4E6 67               4      LD  H,A
0013EE E4E7 6F               4      LD  L,A
0013EF E4E8 3C               4      INC A
0013F0 E4E9 32DAE4          13      LD  (RBRA_SWC),A
0013F3 E4EC 18E5            12      JR  RBREND0
                                ;(15)
       E4EE                     RBX0:
0013F5 E4EE 2A8AEE          16      LD  HL,(_DTA)
0013F8 E4F1 225FEE          16      LD  (DTAX),HL
0013FB E4F4 2A5DEE          16      LD  HL,(LEFTX)
0013FE E4F7 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
001401 E4FA D6FD             7      SUB 0FDH
001403 E4FC C9              10      RET
                                
       E4FD                     RBX1:               ;ファイルサイズとランダムレコードを比べる
001404 E4FD E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
001405 E4FE FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
001408 E501 FD6611          19      LD  H,(IY+17)   ;
00140B E504 FD7E12          19      LD  A,(IY+18)   ;
                                
00140E E507 CDBBF5          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001411 E50A A7               4      AND A
001412 E50B ED52            15      SBC HL,DE
001414 E50D 99               4      SBC A,C
001415 E50E 4F               4      LD  C,A
001416 E50F FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
001419 E512 98               4      SBC A,B
00141A E513 D1              10      POP DE
00141B E514 C9              10      RET
       E515                     RBX1R:              ;(8)
00141C E515 47               4      LD  B,A
00141D E516 B1               4      OR  C
00141E E517 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
00141F E518 B2               4      OR  D
001420 E519 B3               4      OR  E
001421 E51A C0              11      RET NZ
001422 E51B 37               4      SCF
001423 E51C C9              10      RET
                                
       E51D                     RBX2:               ;Cluster settings
001424 E51D FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001427 E520 FD4E23          19      LD  C,(IY+35)
00142A E523 0600             7      LD  B,0
00142C E525 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001430 E529 2003            12      JR  NZ,RBX3
001432 E52B FD4624          19      LD  B,(IY+36)
       E52E                     RBX3:
001435 E52E CDE7F4          17      CALL    RWXR
001438 E531 3A53E5          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
00143B E534 3D               4      DEC A
00143C E535 FDA622          19      AND (IY+34)
00143F E538 FDB621          19      OR  (IY+33)
001442 E53B C9              10      RET
                                
       E53C                     RBXA:
001443 E53C C5              11      PUSH    BC
001444 E53D D5              11      PUSH    DE
001445 E53E CDFBF2          17      CALL    CLUSTX
001448 E541 CD47E6          17      CALL    DRDX
00144B E544 D1              10      POP DE
00144C E545 C1              10      POP BC
00144D E546 D4E6E7          17      CALL    NC,GNCLX
001450 E549 D8              11      RET C
001451 E54A ED53FEEF        20      LD  (_CLPS),DE
                                
001455 E54E FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
001458 E551 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       E552                     SECSZ   EQU $-2
       E553                     SECSZ_H EQU $-1
00145B E554 7C               4      LD  A,H
00145C E555 3D               4      DEC A       ;1024=3 / 512=1
00145D E556 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
001460 E559 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
001461 E55A ED42            15      SBC HL,BC       ;残りを計算
                                
001463 E55C ED5B5DEE        20      LD  DE,(LEFTX)
001467 E560 ED52            15      SBC HL,DE       ;CP HL,DE
001469 E562 19              11      ADD HL,DE       ;
00146A E563 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
00146C E565 EB               4      EX  DE,HL
       E566                     RBXA1:
00146D E566 E5              11      PUSH    HL
00146E E567 2A7EEF          16      LD  HL,(_DTBUF)
001471 E56A 09              11      ADD HL,BC
001472 E56B ED5B5FEE        20      LD  DE,(DTAX)
001476 E56F C1              10      POP BC
001477 E570 C9              10      RET
                                
       E571                     RBXB:
001478 E571 2A5FEE          16      LD  HL,(DTAX)
00147B E574 ED5BFEEF        20      LD  DE,(_CLPS)
00147F E578 3A5EEE          13      LD  A,(LEFTX+1)
001482 E57B 47               4      LD  B,A
001483 E57C 3A53E5          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E57F                     RBXB1:
001486 E57F 1F               4      RRA     ;->CF
001487 E580 3804            12      JR  C,RBXB2
001489 E582 CB38             8      SRL B   ;B=B/2
00148B E584 18F9            12      JR  RBXB1
       E586                     RBXB2:
00148D E586 78               4      LD  A,B
00148E E587 B7               4      OR  A
00148F E588 C9              10      RET
                                ;(12)
       E589                     RBXC:
001490 E589 ED4B5DEE        20      LD  BC,(LEFTX)
001494 E58D 3A53E5          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001497 E590 3D               4      DEC A
001498 E591 A0               4      AND B
001499 E592 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
00149A E593 B1               4      OR  C
00149B E594 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E595                     DWTC:
00149C E595 E5              11      PUSH    HL
00149D E596 217FE9          10      LD  HL,DWT24B
0014A0 E599 1804            12      JR  DWTC1
       E59B                     DRDC:
0014A2 E59B E5              11      PUSH    HL
0014A3 E59C 2171E9          10      LD  HL,DRD24B
       E59F                     DWTC1:
0014A6 E59F 22F9E5          16      LD  (DRWF_MODE),HL
0014A9 E5A2 E1              10      POP HL
0014AA E5A3 3AE9E5          13      LD  A,(DRWF_B)
0014AD E5A6 B7               4      OR  A
0014AE E5A7 200F            12      JR  NZ,DRDC1
       E5A9                     SAVE_DRWC:
0014B0 E5A9 0601             7      LD  B,1
0014B2 E5AB ED43E8E5        20      LD  (DRWF_C),BC
0014B6 E5AF ED53EFE5        20      LD  (DRWF_E),DE
0014BA E5B3 22F2E5          16      LD  (DRWF_HL),HL
0014BD E5B6 1820            12      JR  INC_HL_DRWC
       E5B8                     DRDC1:
0014BF E5B8 E5              11      PUSH    HL
0014C0 E5B9 21EFE5          10      LD  HL,DRWF_E
0014C3 E5BC 86               7      ADD A,(HL)
0014C4 E5BD F5              11      PUSH    AF
0014C5 E5BE BB               4      CP  E
0014C6 E5BF 201D            12      JR  NZ,DRDC2
0014C8 E5C1 F1              10      POP AF
0014C9 E5C2 23               6      INC HL
0014CA E5C3 7E               7      LD  A,(HL)
0014CB E5C4 CE00             7      ADC A,0
0014CD E5C6 F5              11      PUSH    AF
0014CE E5C7 BA               4      CP  D
0014CF E5C8 2014            12      JR  NZ,DRDC2
0014D1 E5CA F1              10      POP AF
0014D2 E5CB 3AE8E5          13      LD  A,(DRWF_C)
0014D5 E5CE CE00             7      ADC A,0
0014D7 E5D0 B9               4      CP  C
0014D8 E5D1 200C            12      JR  NZ,DRDC3
0014DA E5D3 21E9E5          10      LD  HL,DRWF_B
0014DD E5D6 34              11      INC (HL)
0014DE E5D7 E1              10      POP HL
       E5D8                     INC_HL_DRWC:
0014DF E5D8 3A53E5          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
0014E2 E5DB 84               4      ADD A,H
0014E3 E5DC 67               4      LD  H,A
0014E4 E5DD C9              10      RET
       E5DE                     DRDC2:
0014E5 E5DE F1              10      POP AF
       E5DF                     DRDC3:
0014E6 E5DF CDE5E5          17      CALL    DRW_FLUSH
0014E9 E5E2 E1              10      POP HL
0014EA E5E3 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E5E5                     DRW_FLUSH:
0014EC E5E5 C5              11      PUSH    BC
0014ED E5E6 D5              11      PUSH    DE
0014EE E5E7 010000          10      LD  BC,0
       E5E8                     DRWF_C  EQU $-2
       E5E9                     DRWF_B  EQU $-1
0014F1 E5EA 78               4      LD  A,B
0014F2 E5EB B7               4      OR  A
0014F3 E5EC 280D            12      JR  Z,DRDF1
0014F5 E5EE 110000          10      LD  DE,0
       E5EF                     DRWF_E  EQU $-2
       E5F0                     DRWF_D  EQU $-1
0014F8 E5F1 210000          10      LD  HL,0
       E5F2                     DRWF_HL EQU $-2
0014FB E5F4 AF               4      XOR A
0014FC E5F5 32E9E5          13      LD  (DRWF_B),A
0014FF E5F8 CD71E9          17      CALL    DRD24B
       E5F9                     DRWF_MODE   EQU $-2
       E5FB                     DRDF1:
001502 E5FB D1              10      POP DE
001503 E5FC C1              10      POP BC
001504 E5FD C9              10      RET
                                
       E5FE                     RB_WRITE:
001505 E5FE C5              11      PUSH    BC
001506 E5FF 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
001508 E601 1803            12      JR  RBRW
       E603                     RB_READ:
00150A E603 C5              11      PUSH    BC
00150B E604 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       E606                     RBRW:
00150D E606 1F               4      RRA     ;AHL = AHL*128
00150E E607 7C               4      LD  A,H ;AHL = AHL0/2
00150F E608 1F               4      RRA     ;A
001510 E609 65               4      LD  H,L ;
001511 E60A CB1C             8      RR  H   ;H
001513 E60C 2E00             7      LD  L,0 ;
001515 E60E CB1D             8      RR  L   ;L
001517 E610 CDA0F5          17      CALL    SET_RR_AHL
00151A E613 218000          10      LD  HL,128
00151D E616 C5              11      PUSH    BC
       E617                     SETSEQ_SWC_RND:
00151E E617 CDCFF5          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
001521 E61A C1              10      POP BC
001522 E61B FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
001526 E61F FDE5            15      PUSH    IY
001528 E621 D1              10      POP DE
001529 E622 D5              11      PUSH    DE
00152A E623 CD9FDD          17      CALL    BDOS0
00152D E626 FDE1            14      POP IY
00152F E628 CDAAF5          17      CALL    SETSEQ      ;SETSEQ or POPRR
       E629                     SETSEQ_SWC_SEQ_RR   EQU $-2
001532 E62B FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
001536 E62F C1              10      POP BC
001537 E630 C9              10      RET
                                
                                ;(22)
       E631                     INIT_SEQ:
001538 E631 3E01             7      LD  A,1     ;LD BC,????
00153A E633 21AAF5          10      LD  HL,SETSEQ
00153D E636 CD70F5          17      CALL    PUSHRR
       E639                     GETSEQ:
001540 E639 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
001543 E63C FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
001546 E63F AF               4      XOR A
                                
001547 E640 CB25             8      SLA L   ;L=L*2
                                
001549 E642 CB3C             8      SRL H   ;HL=HL/2
00154B E644 CB1D             8      RR  L   ;
00154D E646 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E647                     DRDX:
00154E E647 CD85E6          17      CALL    DRDY
001551 E64A C8              11      RET Z
001552 E64B CD6BE6          17      CALL    DRDX1       ;データバッファの情報を保存
001555 E64E D8              11      RET C
001556 E64F E5              11      PUSH    HL
001557 E650 C5              11      PUSH    BC
001558 E651 D5              11      PUSH    DE
001559 E652 2A7EEF          16      LD  HL,(_DTBUF)
00155C E655 3AAEE6          13      LD  A,(_DBS24)
00155F E658 4F               4      LD  C,A
001560 E659 CD6FE9          17      CALL    DRD24
001563 E65C DC80E6          17      CALL    C,DRDNE
       E65F                     POP_DE_BC_HL_RET:
001566 E65F D1              10      POP DE
001567 E660 C1              10      POP BC
001568 E661 E1              10      POP HL
001569 E662 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E663                     DRDN:
00156A E663 AF               4      XOR A
00156B E664 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
00156C E665 30E0            12      JR  NC,DRDX
       E667                     DRDNX:
00156E E667 CD85E6          17      CALL    DRDY
001571 E66A C8              11      RET Z
       E66B                     DRDX1:
001572 E66B CD9BE6          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
001575 E66E ED53A6EE        20      LD  (_DBSEC),DE
001579 E672 79               4      LD  A,C
00157A E673 32AEE6          13      LD  (_DBS24),A
                                
00157D E676 3A88EE          13      LD  A,(_DRV)
001580 E679 32A5EE          13      LD  (_DBDRV),A
001583 E67C CDD9EE          17      CALL    _CHGDRV
001586 E67F D0              11      RET NC
       E680                     DRDNE:
001587 E680 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001588 E681 32A5EE          13      LD  (_DBDRV),A
00158B E684 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E685                     DRDY:
00158C E685 3AAEE6          13      LD  A,(_DBS24)
00158F E688 B9               4      CP  C
001590 E689 C0              11      RET NZ
                                
001591 E68A E5              11      PUSH    HL
001592 E68B 3A88EE          13      LD  A,(_DRV)
001595 E68E 21A5EE          10      LD  HL,_DBDRV
001598 E691 AE               7      XOR (HL)
001599 E692 2005            12      JR  NZ,POP_HL_RET
                                
00159B E694 2AA6EE          16      LD  HL,(_DBSEC)
00159E E697 ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E699                     POP_HL_RET:
0015A0 E699 E1              10      POP HL
0015A1 E69A C9              10      RET
                                
       E69B                     DWTX:
0015A2 E69B 3AA4EE          13      LD  A,(_WTDBF)
0015A5 E69E B7               4      OR  A
0015A6 E69F C8              11      RET Z
0015A7 E6A0 AF               4      XOR A
0015A8 E6A1 32A4EE          13      LD  (_WTDBF),A
                                
0015AB E6A4 E5              11      PUSH    HL
0015AC E6A5 C5              11      PUSH    BC
0015AD E6A6 D5              11      PUSH    DE
0015AE E6A7 3AA5EE          13      LD  A,(_DBDRV)
0015B1 E6AA CDD9EE          17      CALL    _CHGDRV
0015B4 E6AD 0E00             7      LD  C,0
       E6AE                     _DBS24  EQU $-1
0015B6 E6AF ED5BA6EE        20      LD  DE,(_DBSEC)
0015BA E6B3 2A7EEF          16      LD  HL,(_DTBUF)
0015BD E6B6 D47DE9          17      CALL    NC,DWT24
       E6B9                     POP_DE_BC_HL_RET2:
0015C0 E6B9 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E6BB                     RDFATX:
0015C2 E6BB E5              11      PUSH    HL
0015C3 E6BC 3A88EE          13      LD  A,(_DRV)
0015C6 E6BF 21AAEE          10      LD  HL,_FATDRV
0015C9 E6C2 AE               7      XOR (HL)
0015CA E6C3 28D4            12      JR  Z,POP_HL_RET
                                
0015CC E6C5 C5              11      PUSH    BC
0015CD E6C6 D5              11      PUSH    DE
0015CE E6C7 DDE5            15      PUSH    IX
0015D0 E6C9 CDE5E6          17      CALL    WTFATX
0015D3 E6CC 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
0015D5 E6CE AF               4      XOR A
0015D6 E6CF 32ABEE          13      LD  (_FATIX),A
0015D9 E6D2 3A88EE          13      LD  A,(_DRV)
0015DC E6D5 32AAEE          13      LD  (_FATDRV),A
0015DF E6D8 CDE5EE          17      CALL    _RDFAT
       E6DB                     RDFATE2:
0015E2 E6DB 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
0015E4 E6DD 9F               4      SBC A,A     ;A=0xFF
0015E5 E6DE 32AAEE          13      LD  (_FATDRV),A
       E6E1                     POP_IX_DE_BC_HL_RET:
0015E8 E6E1 DDE1            14      POP IX
0015EA E6E3 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E6E5                     WTFATX:
0015EC E6E5 3AA2EE          13      LD  A,(_WTFATF)
0015EF E6E8 B7               4      OR  A
0015F0 E6E9 C8              11      RET Z
0015F1 E6EA AF               4      XOR A
0015F2 E6EB 32A2EE          13      LD  (_WTFATF),A
                                
0015F5 E6EE E5              11      PUSH    HL
0015F6 E6EF 3AAAEE          13      LD  A,(_FATDRV)
0015F9 E6F2 21A5EE          10      LD  HL,_DBDRV
0015FC E6F5 AE               7      XOR (HL)
0015FD E6F6 CC9BE6          17      CALL    Z,DWTX
001600 E6F9 389E            12      JR  C,POP_HL_RET
001602 E6FB C5              11      PUSH    BC
001603 E6FC D5              11      PUSH    DE
001604 E6FD DDE5            15      PUSH    IX
001606 E6FF CD8EE9          17      CALL    FATSETUP
001609 E702 D47FE9          17      CALL    NC,DWT24B
00160C E705 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E707                     N16CL1:
00160E E707 7A               4      LD  A,D
00160F E708 B3               4      OR  E
001610 E709 37               4      SCF
001611 E70A C8              11      RET Z
                                
001612 E70B 7A               4      LD  A,D
001613 E70C 1807            12      JR  NCL1X
       E70E                     NCL1:
001615 E70E 7A               4      LD  A,D
001616 E70F B3               4      OR  E
001617 E710 37               4      SCF
001618 E711 C8              11      RET Z
                                
001619 E712 7A               4      LD  A,D
00161A E713 CB3F             8      SRL A   ;/2
       E715                     NCL1X:
00161C E715 CB3F             8      SRL A   ;/2
                                
00161E E717 E5              11      PUSH    HL
00161F E718 3237E7          13      LD  (NCLPAT_FATIX),A    ;_FATIX
001622 E71B 2AAAEE          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001625 E71E BC               4      CP  H
001626 E71F 3A88EE          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001629 E722 3236E7          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
00162C E725 2005            12      JR  NZ,NCL2     ;FATIXが違う
00162E E727 BD               4      CP  L
00162F E728 2002            12      JR  NZ,NCL2     ;ドライブが違う
001631 E72A E1              10      POP HL
001632 E72B C9              10      RET
       E72C                     NCL2:
001633 E72C C5              11      PUSH    BC
001634 E72D D5              11      PUSH    DE
001635 E72E DDE5            15      PUSH    IX
001637 E730 CDE5E6          17      CALL    WTFATX
00163A E733 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
00163C E735 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E737                     NCLPAT_FATIX    EQU $-1
       E736                     NCLPAT_FATDRV   EQU $-2
00163F E738 ED43AAEE        20      LD  (_FATDRV),BC
001643 E73C CD63E9          17      CALL    RDFATS
001646 E73F 189A            12      JR  RDFATE2
                                
       E741                     NCL3:
001648 E741 CB9A             8      RES 3,D
00164A E743 CB92             8      RES 2,D
00164C E745 6B               4      LD  L,E
00164D E746 62               4      LD  H,D
00164E E747 CB3C             8      SRL H   ;
001650 E749 CB1D             8      RR  L   ;HLA=HLA/2
001652 E74B 1F               4      RRA     ;
001653 E74C F5              11      PUSH    AF
001654 E74D 3AABEE          13      LD  A,(_FATIX)
001657 E750 0F               4      RRCA
001658 E751 300B            12      JR  NC,NCL3X1
00165A E753 3A53E5          13      LD  A,(SECSZ_H)
00165D E756 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの際に先頭を512バイトずらす
00165F E758 2004            12      JR  NZ,NCL3X1
001661 E75A 010002          10      LD  BC,512
001664 E75D 09              11      ADD HL,BC
       E75E                     NCL3X1:
001665 E75E F1              10      POP AF
001666 E75F ED4B7CEF        20      LD  BC,(_FATBF)
00166A E763 19              11      ADD HL,DE
00166B E764 09              11      ADD HL,BC
00166C E765 17               4      RLA
00166D E766 C9              10      RET
                                
       E767                     GNCL:
00166E E767 CD0EE7          17      CALL    NCL1        ;GET NEXT CLUSTER
001671 E76A D8              11      RET C
001672 E76B C5              11      PUSH    BC
001673 E76C E5              11      PUSH    HL
001674 E76D CD41E7          17      CALL    NCL3
001677 E770 3809            12      JR  C,GNC1
001679 E772 5E               7      LD  E,(HL)
00167A E773 23               6      INC HL
00167B E774 7E               7      LD  A,(HL)
00167C E775 E60F             7      AND 00FH
00167E E777 57               4      LD  D,A
00167F E778 E1              10      POP HL
001680 E779 C1              10      POP BC
001681 E77A C9              10      RET
       E77B                     GNC1:
001682 E77B 7E               7      LD  A,(HL)
001683 E77C 23               6      INC HL
001684 E77D 56               7      LD  D,(HL)
001685 E77E 0604             7      LD  B,4
       E780                     GNC1L:
001687 E780 CB3A             8      SRL D   ;DA=DA/2
001689 E782 1F               4      RRA     ;
00168A E783 10FB            13      DJNZ    GNC1L
                                
00168C E785 5F               4      LD  E,A
00168D E786 E1              10      POP HL
00168E E787 C1              10      POP BC
00168F E788 A7               4      AND A
001690 E789 C9              10      RET
                                
       E78A                     SNCL:
001691 E78A CD0EE7          17      CALL    NCL1
001694 E78D D8              11      RET C
                                ;               SET NEXT CLUSTER
001695 E78E E5              11      PUSH    HL
001696 E78F C5              11      PUSH    BC
001697 E790 D5              11      PUSH    DE
001698 E791 E5              11      PUSH    HL
001699 E792 CD41E7          17      CALL    NCL3
00169C E795 D1              10      POP DE
                                ;CF=ODD
00169D E796 7E               7      LD  A,(HL)
00169E E797 73               7      LD  (HL),E
00169F E798 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
0016A1 E79A 23               6      INC HL
0016A2 E79B ED67            18      RRD     ;M={A[3:0],E[3:0]}
0016A4 E79D 7A               4      LD  A,D
0016A5 E79E 1804            12      JR  SNC11
       E7A0                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
0016A7 E7A0 ED6F            18      RLD     ;M={D[3:0],E[7:4]}
0016A9 E7A2 23               6      INC HL
0016AA E7A3 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E7A4                     SNC11:
0016AB E7A4 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
0016AD E7A6 B7               4      OR  A
0016AE E7A7 D1              10      POP DE
0016AF E7A8 C1              10      POP BC
0016B0 E7A9 E1              10      POP HL
       E7AA                     FAT_CHANGED:
0016B1 E7AA 3EFF             7      LD  A,0FFH
0016B3 E7AC 32A2EE          13      LD  (_WTFATF),A
0016B6 E7AF C9              10      RET
                                
       E7B0                     N16CL3:
0016B7 E7B0 C5              11      PUSH    BC
0016B8 E7B1 6B               4      LD  L,E
0016B9 E7B2 7A               4      LD  A,D
0016BA E7B3 E601             7      AND 1
0016BC E7B5 67               4      LD  H,A
0016BD E7B6 29              11      ADD HL,HL
0016BE E7B7 ED4B7CEF        20      LD  BC,(_FATBF)
0016C2 E7BB 09              11      ADD HL,BC
0016C3 E7BC C1              10      POP BC
0016C4 E7BD C9              10      RET
                                
       E7BE                     GNCL16:
0016C5 E7BE CD07E7          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
0016C8 E7C1 D8              11      RET C
0016C9 E7C2 E5              11      PUSH    HL
0016CA E7C3 CDB0E7          17      CALL    N16CL3
0016CD E7C6 5E               7      LD  E,(HL)
0016CE E7C7 23               6      INC HL
0016CF E7C8 56               7      LD  D,(HL)
0016D0 E7C9 E1              10      POP HL
0016D1 E7CA C9              10      RET
                                
       E7CB                     SNCL16:
0016D2 E7CB CD07E7          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
0016D5 E7CE D8              11      RET C
0016D6 E7CF D5              11      PUSH    DE
0016D7 E7D0 E5              11      PUSH    HL
0016D8 E7D1 CDB0E7          17      CALL    N16CL3
0016DB E7D4 D1              10      POP DE      ;HL
0016DC E7D5 73               7      LD  (HL),E
0016DD E7D6 23               6      INC HL
0016DE E7D7 72               7      LD  (HL),D
0016DF E7D8 6B               4      LD  L,E
0016E0 E7D9 62               4      LD  H,D
0016E1 E7DA D1              10      POP DE
0016E2 E7DB 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E7DD                     NEXTX:
0016E4 E7DD 3E00             7      LD  A,0 ;自己書き換え
       E7DE                     _SECPS  EQU $-1
0016E6 E7DF 3C               4      INC A
0016E7 E7E0 E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E7E1                     _NCPAT  EQU $-1
0016E9 E7E2 32DEE7          13      LD  (_SECPS),A
0016EC E7E5 C9              10      RET
                                
       E7E6                     GNCLX:
0016ED E7E6 CDDDE7          17      CALL    NEXTX
0016F0 E7E9 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
0016F1 E7EA C3F7EE          10      JP  _GNCL   ;次のクラスタを探す
                                
       E7ED                     RDFAT:
0016F4 E7ED 3E80             7      LD  A,080H
0016F6 E7EF 3270EE          13      LD  (CHECK),A
       E7F2                     RDFAT1:
0016F9 E7F2 3A88EE          13      LD  A,(_DRV)
0016FC E7F5 CD97EA          17      CALL    CHGDRVR
0016FF E7F8 D8              11      RET C
001700 E7F9 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001703 E7FC CB6F             8      BIT 5,A
001705 E7FE 286E            12      JR  Z,RDFAT0X
001707 E800 2170EE          10      LD  HL,CHECK
00170A E803 A6               7      AND (HL)
00170B E804 77               7      LD  (HL),A
00170C E805 110000          10      LD  DE,0        ;BPB
00170F E808 2A7CEF          16      LD  HL,(_FATBF)
001712 E80B 0E00             7      LD  C,0
001714 E80D CD6FE9          17      CALL    DRD24
001717 E810 3022            12      JR  NC,GETBPB
001719 E812 2170EE          10      LD  HL,CHECK
00171C E815 CB06            15      RLC (HL)
00171E E817 3F               4      CCF
00171F E818 D8              11      RET C
001720 E819 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
001724 E81D 3F               4      CCF         ;フロッピーディスクのFDモード(2D/2HD)を切り替える
001725 E81E DDCB0A16        23      RL  (IX+DPB_FDMODE)
001729 E822 3A84EE          13      LD  A,(_DRIVE)
00172C E825 E603             7      AND 3
00172E E827 F680             7      OR  080H
001730 E829 6F               4      LD  L,A
001731 E82A 26EE             7      LD  H,_CYL0/256
001733 E82C 3EFF             7      LD  A,0FFH
001735 E82E 3289EE          13      LD  (_DSK),A
001738 E831 77               7      LD  (HL),A
001739 E832 18BE            12      JR  RDFAT1
       E834                     GETBPB:
00173B E834 FDE5            15      PUSH    IY
00173D E836 FD2A7CEF        20      LD  IY,(_FATBF) ;BPB
001741 E83A CDF1EE          17      CALL    _BPB2DPB
001744 E83D FDE1            14      POP IY
001746 E83F DD7E12          19      LD  A,(IX+DPB_DEVICE)
001749 E842 3027            12      JR  NC,GETBPBOK
00174B E844 E60F             7      AND 00FH
00174D E846 FE07             7      CP  7
00174F E848 37               4      SCF
001750 E849 C0              11      RET NZ
001751 E84A DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001755 E84E 21C0EF          10      LD  HL,M2D
001758 E851 2008            12      JR  NZ,SETFDMODE
00175A E853 2E04             7      LD  L,4
00175C E855 CD58E9          17      CALL    CHECK_MAXSECSZ
00175F E858 D8              11      RET C
001760 E859 2ED2             7      LD  L,M2HD-STABLE
       E85B                     SETFDMODE:
001762 E85B DDE5            15      PUSH    IX
001764 E85D D1              10      POP DE
001765 E85E EDA0            16      LDI
001767 E860 EDA0            16      LDI
001769 E862 13               6      INC DE
00176A E863 13               6      INC DE
00176B E864 13               6      INC DE
00176C E865 13               6      INC DE
00176D E866 010C00          10      LD  BC,12
001770 E869 EDB0                    LDIR
       E86B                     GETBPBOK:
001772 E86B CD03EA          17      CALL    CHGDRV2
       E86E                     RDFAT0X:
001775 E86E CD63E9          17      CALL    RDFATS
001778 E871 D8              11      RET C
001779 E872 DDAE06          19      XOR (IX+DPB_FATID)
00177C E875 C8              11      RET Z
00177D E876 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001780 E879 CB5F             8      BIT 3,A
001782 E87B 2803            12      JR  Z,RDFAT0X1
001784 E87D CB6F             8      BIT 5,A
001786 E87F C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E880                     RDFAT0X1:
001787 E880 37               4      SCF
001788 E881 C9              10      RET
                                
       E882                     POP_HL_SCF_RET:
001789 E882 E1              10      POP HL
00178A E883 37               4      SCF
00178B E884 C9              10      RET
                                
       E885                     BPB2DPB:
00178C E885 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
00178F E888 B7               4      OR  A
001790 E889 37               4      SCF
001791 E88A C0              11      RET NZ
       E88B                     BPBOK:
001792 E88B FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001795 E88E DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001798 E891 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
00179B E894 DD7700          19      LD  (IX+DPB_FATLN),A
00179E E897 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
0017A1 E89A DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
0017A4 E89D FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
0017A7 E8A0 FD660F          19      LD  H,(IY+15)
0017AA E8A3 DD750E          19      LD  (IX+DPB_FATPS),L
0017AD E8A6 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
0017B0 E8A9 FD5617          19      LD  D,(IY+23)
0017B3 E8AC FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E8AF                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
0017B6 E8AF 19              11      ADD HL,DE
0017B7 E8B0 10FD            13      DJNZ    BPBDP1
       E8B2                     BPBDP2:
0017B9 E8B2 DD7510          19      LD  (IX+DPB_DIRPS),L
0017BC E8B5 DD7411          19      LD  (IX+DPB_DIRPS+1),H
0017BF E8B8 E5              11      PUSH    HL
                                
0017C0 E8B9 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
0017C3 E8BC FD6612          19      LD  H,(IY+18)
0017C6 E8BF FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
0017C9 E8C2 B7               4      OR  A
0017CA E8C3 28BD            12      JR  Z,POP_HL_SCF_RET
0017CC E8C5 0606             7      LD  B,6
       E8C7                     BPBBPS1:
0017CE E8C7 05               4      DEC B
0017CF E8C8 0F               4      RRCA
0017D0 E8C9 30FC            12      JR  NC,BPBBPS1
       E8CB                     BPBDE1:
0017D2 E8CB 29              11      ADD HL,HL
0017D3 E8CC 10FD            13      DJNZ    BPBDE1
                                
0017D5 E8CE 7C               4      LD  A,H
0017D6 E8CF DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
0017D9 E8D2 D1              10      POP DE      ;DPB_DIRPS
0017DA E8D3 6C               4      LD  L,H
0017DB E8D4 2600             7      LD  H,0
0017DD E8D6 19              11      ADD HL,DE       ;MAXDIR
0017DE E8D7 E5              11      PUSH    HL
0017DF E8D8 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
0017E2 E8DB CB21             8      SLA C       ;*2
0017E4 E8DD AF               4      XOR A
0017E5 E8DE 47               4      LD  B,A
0017E6 E8DF ED42            15      SBC HL,BC
0017E8 E8E1 DD7514          19      LD  (IX+DPB_ADDCL),L
0017EB E8E4 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
0017EE E8E7 D1              10      POP DE      ;DE=DPB_MAXDIR
0017EF E8E8 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
0017F2 E8EB FD6614          19      LD  H,(IY+20)
                                
0017F5 E8EE DD7E12          19      LD  A,(IX+DPB_DEVICE)
0017F8 E8F1 E60F             7      AND 00FH
0017FA E8F3 FE07             7      CP  7       ;フロッピー
0017FC E8F5 2019            12      JR  NZ,NOT_FD
0017FE E8F7 E5              11      PUSH    HL
0017FF E8F8 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001802 E8FB DD710D          19      LD  (IX+DPB_MAXSEC),C
001805 E8FE AF               4      XOR A
001806 E8FF CB21             8      SLA C       ;両面なのでセクタ数を２倍
001808 E901 0610             7      LD  B,16
       E903                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
00180A E903 29              11      ADD HL,HL
00180B E904 17               4      RLA
00180C E905 B9               4      CP  C
00180D E906 3802            12      JR  C,DIVSEC1
00180F E908 91               4      SUB C
001810 E909 2C               4      INC L
       E90A                     DIVSEC1:
001811 E90A 10F7            13      DJNZ    DIVSEC
001813 E90C DD750C          19      LD  (IX+DPB_MAXCYL),L
001816 E90F E1              10      POP HL  ;ここまでフロッピー専用
       E910                     NOT_FD:
001817 E910 7C               4      LD  A,H
001818 E911 B5               4      OR  L
001819 E912 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
00181B E914 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
00181D E916 2F               4      CPL         ;A=0FFH
00181E E917 FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001821 E91A D8              11      RET C
001822 E91B FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001825 E91E FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001828 E921 FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E924                     BPB16BIT:
00182B E924 ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
00182D E926 DE00             7      SBC A,0
00182F E928 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E92B                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001832 E92B CB18             8      RR  B       ;->CY
001834 E92D 3808            12      JR  C,BPBTC2
001836 E92F CB3F             8      SRL A
001838 E931 CB1C             8      RR  H       ;AHL=AHL/2
00183A E933 CB1D             8      RR  L
00183C E935 18F4            12      JR  BPBTC1
       E937                     BPBTC2:
00183E E937 C6FF             7      ADD A,0FFH
001840 E939 D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001841 E93A 23               6      INC HL
001842 E93B 23               6      INC HL
001843 E93C DD7508          19      LD  (IX+DPB_MAXCL),L
001846 E93F DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001849 E942 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
00184C E945 DD7706          19      LD  (IX+DPB_FATID),A
                                
00184F E948 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001852 E94B C6FE             7      ADD A,0-2       ;>2:CF=1
001854 E94D FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001857 E950 6F               4      LD  L,A
001858 E951 3002            12      JR  NC,BPBFAT1
00185A E953 F680             7      OR  080H
       E955                     BPBFAT1:            ;ここではCF=0
00185C E955 DD770F          19      LD  (IX+DPB_BPS),A
       E958                     CHECK_MAXSECSZ:
00185F E958 3A7BEF          13      LD  A,(_MAX_SEC_SZ_H)
001862 E95B BD               4      CP  L
001863 E95C C8              11      RET Z       ;1セクタ1024バイト
001864 E95D 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001865 E95E C8              11      RET Z       ;1セクタ256バイト
001866 E95F 2D               4      DEC L
001867 E960 C8              11      RET Z       ;1セクタ512バイト
001868 E961 37               4      SCF
001869 E962 C9              10      RET
                                
       E963                     RDFATS:
00186A E963 CD8EE9          17      CALL    FATSETUP
00186D E966 D8              11      RET C
00186E E967 CD71E9          17      CALL    DRD24B
001871 E96A 2A7CEF          16      LD  HL,(_FATBF)
001874 E96D 7E               7      LD  A,(HL)
001875 E96E C9              10      RET
                                
       E96F                     DRD24:
001876 E96F 0601             7      LD  B,1
       E971                     DRD24B:
001878 E971 DDE5            15      PUSH    IX
00187A E973 DD2AA8EE        20      LD  IX,(_DPB)
00187E E977 CD28EC          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E978                     DRDPAT  EQU $-2
001881 E97A DDE1            14      POP IX
001883 E97C C9              10      RET
                                
       E97D                     DWT24:
001884 E97D 0601             7      LD  B,1
       E97F                     DWT24B:
001886 E97F DDE5            15      PUSH    IX
001888 E981 DD2AA8EE        20      LD  IX,(_DPB)
00188C E985 CD90EB          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E986                     DWTPAT  EQU $-2
00188F E988 DDE1            14      POP IX
001891 E98A D0              11      RET NC
001892 E98B C35AEE          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E98E                     FATSETUP:
001895 E98E 3AAAEE          13      LD  A,(_FATDRV)
001898 E991 CD97EA          17      CALL    CHGDRVR     ;ドライブ切り替え
00189B E994 D8              11      RET C
       E995                     FATS2:
00189C E995 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
00189F E998 0F               4      RRCA
0018A0 E999 CDC9E9          17      CALL    FATSETUP12  ;自己書き換え
       E99A                     FATSX   EQU $-2
0018A3 E99C 210000          10      LD  HL,0
0018A6 E99F 4A               4      LD  C,D
0018A7 E9A0 54               4      LD  D,H
0018A8 E9A1 3AABEE          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
0018AB E9A4 47               4      LD  B,A
0018AC E9A5 04               4      INC B
0018AD E9A6 DD7E00          19      LD  A,(IX+DPB_FATLN)
       E9A9                     FAT_SKP:
0018B0 E9A9 05               4      DEC B
0018B1 E9AA 2809            12      JR  Z,FAT1
0018B3 E9AC 19              11      ADD HL,DE
0018B4 E9AD 93               4      SUB E
0018B5 E9AE 30F9            12      JR  NC,FAT_SKP
0018B7 E9B0 DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
0018BB E9B4 C8              11      RET Z
       E9B5                     FAT1:
0018BC E9B5 EB               4      EX  DE,HL
0018BD E9B6 B7               4      OR  A       ;0の場合は0100Hとして扱う
0018BE E9B7 2803            12      JR  Z,FAT3
0018C0 E9B9 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
0018C1 E9BA 3801            12      JR  C,FAT2
       E9BC                     FAT3:
0018C3 E9BC 79               4      LD  A,C
       E9BD                     FAT2:
0018C4 E9BD 47               4      LD  B,A
                                
0018C5 E9BE 2AFAEF          16      LD  HL,(_FATPS) ;fat sector pos
0018C8 E9C1 19              11      ADD HL,DE
0018C9 E9C2 EB               4      EX  DE,HL
0018CA E9C3 2A7CEF          16      LD  HL,(_FATBF)
0018CD E9C6 AF               4      XOR A       ;CF=0
0018CE E9C7 4F               4      LD  C,A
0018CF E9C8 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E9C9                     FATSETUP12:
0018D0 E9C9 110606          10      LD  DE,0606H    ;256
0018D3 E9CC D8              11      RET C
0018D4 E9CD 110303          10      LD  DE,0303H    ;512
0018D7 E9D0 0F               4      RRCA
0018D8 E9D1 D8              11      RET C
0018D9 E9D2 110102          10      LD  DE,0201H    ;1024
0018DC E9D5 C9              10      RET
                                
       E9D6                     FATSETUP16:
0018DD E9D6 110404          10      LD  DE,0404H    ;256
0018E0 E9D9 D8              11      RET C
0018E1 E9DA 110202          10      LD  DE,0202H    ;512
0018E4 E9DD 0F               4      RRCA
0018E5 E9DE D8              11      RET C
0018E6 E9DF 110101          10      LD  DE,0101H    ;1024
0018E9 E9E2 C9              10      RET
                                
       E9E3                     CHGDRV:
0018EA E9E3 E5              11      PUSH    HL
0018EB E9E4 2189EE          10      LD  HL,_DSK
0018EE E9E7 BE               7      CP  (HL)
0018EF E9E8 280A            12      JR  Z,CHGDRVE
       E9EA                     CHGDRV1:
0018F1 E9EA DDE5            15      PUSH    IX
0018F3 E9EC CDF6E9          17      CALL    CHGDRV0
0018F6 E9EF 3A89EE          13      LD  A,(_DSK)
0018F9 E9F2 DDE1            14      POP IX
       E9F4                     CHGDRVE:
0018FB E9F4 E1              10      POP HL
0018FC E9F5 C9              10      RET
                                
       E9F6                     CHGDRV0:
0018FD E9F6 6F               4      LD  L,A
0018FE E9F7 CDDCEE          17      CALL    _GETDPB
001901 E9FA D8              11      RET C
001902 E9FB DD22A8EE        20      LD  (_DPB),IX
001906 E9FF 7D               4      LD  A,L
001907 EA00 3289EE          13      LD  (_DSK),A
       EA03                     CHGDRV2:
00190A EA03 C5              11      PUSH    BC
00190B EA04 D5              11      PUSH    DE
00190C EA05 ED734EEA        20      LD  (SPPAT2),SP
001910 EA09 F3               4      DI
001911 EA0A DDF9            10      LD  SP,IX
                                
001913 EA0C E1              10      POP HL      ;00:DPB_FATLN
001914 EA0D E1              10      POP HL      ;02:DPB_DRD
001915 EA0E 2278E9          16      LD  (DRDPAT),HL
                                
001918 EA11 E1              10      POP HL
001919 EA12 2286E9          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
00191C EA15 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
00191D EA16 7C               4      LD  A,H
00191E EA17 32FFF2          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001921 EA1A 3D               4      DEC A
001922 EA1B 32E1E7          13      LD  (_NCPAT),A
                                
001925 EA1E E1              10      POP HL      ;08:DPB_MAXCL
001926 EA1F 7D               4      LD  A,L
001927 EA20 321EF3          13      LD  (CLPAT2),A
00192A EA23 7C               4      LD  A,H
00192B EA24 321AF3          13      LD  (CLPAT1),A
00192E EA27 2B               6      DEC HL
00192F EA28 221DF5          16      LD  (MAXCLP),HL
                                
001932 EA2B E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001933 EA2C 4C               4      LD  C,H
                                
001934 EA2D E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001935 EA2E E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001936 EA2F 7C               4      LD  A,H     ;DPB_BPS
001937 EA30 E607             7      AND 7
001939 EA32 3253E5          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
00193C EA35 87               4      ADD A,A     ;8  4   2
00193D EA36 87               4      ADD A,A     ;010H   8   4
00193E EA37 87               4      ADD A,A     ;020H   010H    8
00193F EA38 327DF1          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001942 EA3B 2600             7      LD  H,0
001944 EA3D 22FAEF          16      LD  (_FATPS),HL
                                
001947 EA40 E1              10      POP HL      ;10:DPB_DIRPS
001948 EA41 22FCEF          16      LD  (_DIRPS),HL
                                
00194B EA44 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
00194C EA45 7C               4      LD  A,H
00194D EA46 3284EE          13      LD  (_DRIVE),A
                                
001950 EA49 E1              10      POP HL      ;14:DPB_ADDCL
001951 EA4A 220FF3          16      LD  (CLSPAT),HL
                                
001954 EA4D 310000          10      LD  SP,0        ;元のSPを復元
       EA4E                     SPPAT2  EQU $-2
001957 EA50 FB               4      EI
001958 EA51 2AFCEF          16      LD  HL,(_DIRPS)
00195B EA54 0600             7      LD  B,0
00195D EA56 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
00195E EA57 2298F1          16      LD  (MD_PAT),HL
                                
001961 EA5A 2A1DF5          16      LD  HL,(MAXCLP)
001964 EA5D 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001967 EA60 19              11      ADD HL,DE
001968 EA61 380F            12      JR  C,SETFAT16
00196A EA63 2167E7          10      LD  HL,GNCL     ;FAT12
00196D EA66 118AE7          10      LD  DE,SNCL
001970 EA69 01C9E9          10      LD  BC,FATSETUP12
001973 EA6C DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001977 EA70 180D            12      JR  EXTRA1
       EA72                     SETFAT16:
001979 EA72 21BEE7          10      LD  HL,GNCL16   ;FAT16
00197C EA75 11CBE7          10      LD  DE,SNCL16
00197F EA78 01D6E9          10      LD  BC,FATSETUP16
001982 EA7B DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       EA7F                     EXTRA1:
001986 EA7F 22F8EE          16      LD  (GNCPAT),HL
001989 EA82 ED53FBEE        20      LD  (SNCPAT),DE
00198D EA86 ED439AE9        20      LD  (FATSX),BC
001991 EA8A D1              10      POP DE
001992 EA8B C1              10      POP BC
001993 EA8C AF               4      XOR A
001994 EA8D C9              10      RET
                                
       EA8E                     GETDPBD:
001995 EA8E DDE3            23      EX  (SP),IX
001997 EA90 DDE5            15      PUSH    IX
001999 EA92 3A88EE          13      LD  A,(_DRV)
00199C EA95 1807            12      JR  GETDPB1
                                
       EA97                     CHGDRVR:
00199E EA97 CDD9EE          17      CALL    _CHGDRV
0019A1 EA9A D8              11      RET C
0019A2 EA9B 3A89EE          13      LD  A,(_DSK)
       EA9E                     GETDPB1:
0019A5 EA9E C3DCEE          10      JP  _GETDPB
                                
       EAA1                     GETDPB:
0019A8 EAA1 FE08             7      CP  8
0019AA EAA3 3F               4      CCF
0019AB EAA4 D8              11      RET C
0019AC EAA5 0F               4      RRCA
0019AD EAA6 0F               4      RRCA
0019AE EAA7 0F               4      RRCA
0019AF EAA8 DD                      DB  0DDH        ;Z80未定義命令
0019B0 EAA9 6F               4      LD  L,A     ;LD IXL,A
0019B1 EAAA DD                      DB  0DDH        ;Z80未定義命令
0019B2 EAAB 26F6             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
0019B4 EAAD DD7E00          19      LD  A,(IX+DPB_FATLN)
0019B7 EAB0 A7               4      AND A       ;CF=0の為
0019B8 EAB1 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
0019BC EAB5 C0              11      RET NZ      ;FAT16
0019BD EAB6 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
0019C1 EABA C0              11      RET NZ      ;BPB
0019C2 EABB FE01             7      CP  001H        ;A=0 THEN CF=1
0019C4 EABD C9              10      RET
                                
       EABE                     _SYS5F:
0019C5 EABE AF               4      XOR A
       EABF                     FFLUSH:
0019C6 EABF F5              11      PUSH    AF
0019C7 EAC0 CDE5E6          17      CALL    WTFATX
0019CA EAC3 AF               4      XOR A
0019CB EAC4 32ABEE          13      LD  (_FATIX),A
0019CE EAC7 2F               4      CPL         ;0FFH
0019CF EAC8 32AAEE          13      LD  (_FATDRV),A
0019D2 EACB 3E                      DB  03EH        ;次のPUSH AFをスキップ
       EACC                     FFLUSHBUF:
0019D3 EACC F5              11      PUSH    AF
0019D4 EACD CD9BE6          17      CALL    DWTX
0019D7 EAD0 3EFF             7      LD  A,0FFH
0019D9 EAD2 3239EE          13      LD  (SFILE),A
0019DC EAD5 32A5EE          13      LD  (_DBDRV),A
0019DF EAD8 F1              10      POP AF
0019E0 EAD9 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "88DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   PC-8801mkIISR
                                
                                ;   FLOPPY DISK DRIVER
                                ;
       EADA                     PUTCOM_EXECUTE:
0019E1 EADA 3E0D             7      LD  A,0DH       ;エグゼキュート
                                ;   コマンド送信
       EADC                     PUTCOM:
0019E3 EADC F5              11      PUSH    AF
0019E4 EADD 3E0F             7      LD  A,00FH
0019E6 EADF D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
0019E8 EAE1 F1              10      POP AF
                                ;   通常ハンドシェイク（ホストが送信）
       EAE2                     PUTDAT:
0019E9 EAE2 F5              11      PUSH    AF
       EAE3                     PUTDAT1:
0019EA EAE3 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
0019EC EAE5 E602             7      AND 2       ;RFD
0019EE EAE7 28FA            12      JR  Z,PUTDAT1
0019F0 EAE9 3E0E             7      LD  A,00EH      ;ATN=0
0019F2 EAEB D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
0019F4 EAED F1              10      POP AF
0019F5 EAEE D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
0019F7 EAF0 F5              11      PUSH    AF
0019F8 EAF1 3E09             7      LD  A,9     ;DAV=1
0019FA EAF3 D3FF            11      OUT (0FFH),A
       EAF5                     PUTDAT2:
0019FC EAF5 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
0019FE EAF7 E604             7      AND 4       ;DAC
001A00 EAF9 28FA            12      JR  Z,PUTDAT2
                                
001A02 EAFB 3E08             7      LD  A,8     ;DAV=0
001A04 EAFD D3FF            11      OUT (0FFH),A
       EAFF                     PUTDAT3:
001A06 EAFF DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A08 EB01 E604             7      AND 4       ;DAC
001A0A EB03 20FA            12      JR  NZ,PUTDAT3
001A0C EB05 F1              10      POP AF
001A0D EB06 C9              10      RET
                                
                                ;   通常ハンドシェイク（ホストが受信）
       EB07                     GETDAT:
001A0E EB07 3E0B             7      LD  A,00BH      ;RFD=1
001A10 EB09 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
       EB0B                     GETDAT1:
001A12 EB0B DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A14 EB0D 0F               4      RRCA            ;DAV
001A15 EB0E 30FB            12      JR  NC,GETDAT1
                                
001A17 EB10 3E0A             7      LD  A,00AH      ;RFD=0
001A19 EB12 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001A1B EB14 DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001A1D EB16 F5              11      PUSH    AF
001A1E EB17 3E0D             7      LD  A,00DH      ;DAC=1
001A20 EB19 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
       EB1B                     GETDAT2:
001A22 EB1B DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A24 EB1D 0F               4      RRCA            ;DAV
001A25 EB1E 38FB            12      JR  C,GETDAT2
                                
001A27 EB20 3E0C             7      LD  A,00CH      ;DAC=0
001A29 EB22 D3FF            11      OUT (0FFH),A
001A2B EB24 F1              10      POP AF
001A2C EB25 C9              10      RET
                                
                                ;   高速ハンドシェイク（ホストが送信）
                                ;   HL:アドレス BC:受信サイズ（必ず偶数にする）
       EB26                     FPUTDAT:
       EB26                     FPUTDAT1:
001A2D EB26 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A2F EB28 E602             7      AND 2       ;RFD
001A31 EB2A 28FA            12      JR  Z,FPUTDAT1
001A33 EB2C 3E0E             7      LD  A,00EH      ;ATN=0
001A35 EB2E D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001A37 EB30 7E               7      LD  A,(HL)
001A38 EB31 D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
                                
001A3A EB33 3E09             7      LD  A,9     ;DAV=1
001A3C EB35 D3FF            11      OUT (0FFH),A
001A3E EB37 23               6      INC HL
001A3F EB38 0B               6      DEC BC
       EB39                     FPUTDAT2:
001A40 EB39 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A42 EB3B E604             7      AND 4       ;DAC
001A44 EB3D 28FA            12      JR  Z,FPUTDAT2
                                
001A46 EB3F 7E               7      LD  A,(HL)
001A47 EB40 D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
                                
001A49 EB42 3E08             7      LD  A,8     ;DAV=0
001A4B EB44 D3FF            11      OUT (0FFH),A
       EB46                     FPUTDAT3:
001A4D EB46 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A4F EB48 E604             7      AND 4       ;DAC
001A51 EB4A 20FA            12      JR  NZ,FPUTDAT3
                                
001A53 EB4C EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001A55 EB4E E0              11      RET PO
001A56 EB4F 18D5            12      JR  FPUTDAT
                                
                                
                                ;   高速ハンドシェイク（ホストが受信）
                                ;   HL:アドレス BC:受信サイズ（必ず偶数にする）
       EB51                     FGETDAT:
001A58 EB51 3E0B             7      LD  A,00BH      ;RFD=1
001A5A EB53 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
       EB55                     FGETDAT1:
001A5C EB55 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A5E EB57 0F               4      RRCA            ;DAV
001A5F EB58 30FB            12      JR  NC,FGETDAT1
                                
001A61 EB5A 3E0A             7      LD  A,00AH      ;RFD=0
001A63 EB5C D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001A65 EB5E DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001A67 EB60 77               7      LD  (HL),A
                                
001A68 EB61 3E0D             7      LD  A,00DH      ;DAC=1
001A6A EB63 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
001A6C EB65 23               6      INC HL
001A6D EB66 0B               6      DEC BC
       EB67                     FGETDAT2:
001A6E EB67 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A70 EB69 0F               4      RRCA            ;DAV
001A71 EB6A 38FB            12      JR  C,FGETDAT2
                                
001A73 EB6C DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001A75 EB6E 77               7      LD  (HL),A
                                
001A76 EB6F 3E0C             7      LD  A,00CH      ;DAC=0
001A78 EB71 D3FF            11      OUT (0FFH),A
                                
001A7A EB73 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001A7C EB75 E0              11      RET PO
001A7D EB76 18D9            12      JR  FGETDAT
                                
                                ;   論理セクタ番号からトラック番号とセクタ番号を得る
                                ;   in
                                ;   DE:論理セクタ
       EB78                     CALC_SECTOR:
001A7F EB78 C5              11      PUSH    BC
001A80 EB79 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001A83 EB7C 0610             7      LD  B,16
001A85 EB7E AF               4      XOR A
001A86 EB7F EB               4      EX  DE,HL
       EB80                     DIV1:
001A87 EB80 29              11      ADD HL,HL
001A88 EB81 8F               4      ADC A,A
001A89 EB82 B9               4      CP  C
001A8A EB83 3802            12      JR  C,DIV2
001A8C EB85 91               4      SUB C
001A8D EB86 2C               4      INC L
       EB87                     DIV2:
001A8E EB87 10F7            13      DJNZ    DIV1
                                
001A90 EB89 3C               4      INC A   ;最小のセクタは１固定
001A91 EB8A 55               4      LD  D,L ;TRACK
       EB8B                     DIV3:
001A92 EB8B 5F               4      LD  E,A ;SECTOR
001A93 EB8C C1              10      POP BC
001A94 EB8D C9              10      RET
                                
       EB8E                     WTTRK:
001A95 EB8E 37               4      SCF
001A96 EB8F C9              10      RET
       EB90                     FDWT:
001A97 EB90 E5              11      PUSH    HL
001A98 EB91 D5              11      PUSH    DE
001A99 EB92 CD78EB          17      CALL    CALC_SECTOR
001A9C EB95 7A               4      LD  A,D     ;トラック
001A9D EB96 32F4EB          13      LD  (FDWT_TRACK),A
001AA0 EB99 7B               4      LD  A,E     ;セクタ
001AA1 EB9A 32EFEB          13      LD  (FDWT_SECTOR),A
001AA4 EB9D DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001AA7 EBA0 93               4      SUB E
001AA8 EBA1 3C               4      INC A
001AA9 EBA2 67               4      LD  H,A
001AAA EBA3 D1              10      POP DE
001AAB EBA4 3A53E5          13      LD  A,(SECSZ_H) ;1セクタのサイズの上位1バイト
001AAE EBA7 4F               4      LD  C,A
001AAF EBA8 AF               4      XOR A
       EBA9                     FDWT2:
001AB0 EBA9 81               4      ADD A,C
001AB1 EBAA 13               6      INC DE
001AB2 EBAB 05               4      DEC B
001AB3 EBAC 2807            12      JR  Z,FDWT3
001AB5 EBAE 25               4      DEC H       ;トラック、ヘッドを跨がない
001AB6 EBAF 2804            12      JR  Z,FDWT3
001AB8 EBB1 FE3A             7      CP  03AH        ;バッファとして04000H-07BFFHまで使える
001ABA EBB3 38F4            12      JR  C,FDWT2
       EBB5                     FDWT3:
001ABC EBB5 4F               4      LD  C,A
001ABD EBB6 E1              10      POP HL
001ABE EBB7 3E16             7      LD  A,16H       ;高速レシーブメモリ
001AC0 EBB9 CDDCEA          17      CALL    PUTCOM
001AC3 EBBC 3E40             7      LD  A,HIGH DSS_DATA ;開始アドレスH
001AC5 EBBE CDE2EA          17      CALL    PUTDAT
001AC8 EBC1 AF               4      XOR A       ;開始アドレスL
001AC9 EBC2 CDE2EA          17      CALL    PUTDAT
001ACC EBC5 79               4      LD  A,C     ;バイト数H
001ACD EBC6 CDE2EA          17      CALL    PUTDAT
001AD0 EBC9 AF               4      XOR A       ;バイト数L
001AD1 EBCA CDE2EA          17      CALL    PUTDAT
001AD4 EBCD C5              11      PUSH    BC
001AD5 EBCE 41               4      LD  B,C
001AD6 EBCF 0E00             7      LD  C,0
001AD8 EBD1 CD26EB          17      CALL    FPUTDAT
001ADB EBD4 C1              10      POP BC
001ADC EBD5 CDDAEA          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001ADF EBD8 3E7C             7      LD  A,HIGH WRITEDISKEX
001AE1 EBDA CDE2EA          17      CALL    PUTDAT
001AE4 EBDD 3EB1             7      LD  A,LOW WRITEDISKEX
001AE6 EBDF CDE2EA          17      CALL    PUTDAT
001AE9 EBE2 DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
001AEC EBE5 CDE2EA          17      CALL    PUTDAT
001AEF EBE8 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001AF2 EBEB CDE2EA          17      CALL    PUTDAT
001AF5 EBEE 3E00             7      LD  A,0     ;セクタ
       EBEF                     FDWT_SECTOR EQU $-1
001AF7 EBF0 CDE2EA          17      CALL    PUTDAT
001AFA EBF3 3E00             7      LD  A,0     ;トラック
       EBF4                     FDWT_TRACK  EQU $-1
001AFC EBF5 CDE2EA          17      CALL    PUTDAT
001AFF EBF8 DD7E0A          19      LD  A,(IX+DPB_FDMODE)   ;フロッピーディスクのモード
001B02 EBFB CDE2EA          17      CALL    PUTDAT
001B05 EBFE 3A53E5          13      LD  A,(SECSZ_H) ;1セクタのサイズの上位1バイト
001B08 EC01 CDE2EA          17      CALL    PUTDAT
001B0B EC04 79               4      LD  A,C
001B0C EC05 CDE2EA          17      CALL    PUTDAT      ;バイト数H
001B0F EC08 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;フロッピーディスクのシリンダ数
001B12 EC0B CDE2EA          17      CALL    PUTDAT
                                
001B15 EC0E CDDAEA          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001B18 EC11 3E7E             7      LD  A,HIGH RESULTEX
001B1A EC13 CDE2EA          17      CALL    PUTDAT
001B1D EC16 3E21             7      LD  A,LOW RESULTEX
001B1F EC18 CDE2EA          17      CALL    PUTDAT
                                
001B22 EC1B CD07EB          17      CALL    GETDAT
001B25 EC1E 4F               4      LD  C,A
001B26 EC1F FE01             7      CP  1
001B28 EC21 D8              11      RET C
                                
001B29 EC22 78               4      LD  A,B
001B2A EC23 B7               4      OR  A
001B2B EC24 C290EB          10      JP  NZ,FDWT
001B2E EC27 C9              10      RET
                                
       EC28                     FDRD:
001B2F EC28 CDDAEA          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001B32 EC2B 3E7C             7      LD  A,HIGH READDISKEX
001B34 EC2D CDE2EA          17      CALL    PUTDAT
001B37 EC30 AF               4      XOR A
001B38 EC31 CDE2EA          17      CALL    PUTDAT
001B3B EC34 3A7BEF          13      LD  A,(_MAX_SEC_SZ_H)
001B3E EC37 87               4      ADD A,A
001B3F EC38 DDB613          19      OR  (IX+DPB_UNITNO)     ;デバイスドライバ内におけるユニット番号
001B42 EC3B CDE2EA          17      CALL    PUTDAT
001B45 EC3E DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001B48 EC41 CDE2EA          17      CALL    PUTDAT
001B4B EC44 E5              11      PUSH    HL
001B4C EC45 D5              11      PUSH    DE
001B4D EC46 CD78EB          17      CALL    CALC_SECTOR
001B50 EC49 7B               4      LD  A,E     ;セクタ
001B51 EC4A CDE2EA          17      CALL    PUTDAT
001B54 EC4D 7A               4      LD  A,D     ;トラック
001B55 EC4E CDE2EA          17      CALL    PUTDAT
001B58 EC51 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001B5B EC54 93               4      SUB E
001B5C EC55 3C               4      INC A
001B5D EC56 67               4      LD  H,A
001B5E EC57 D1              10      POP DE
001B5F EC58 DD7E0A          19      LD  A,(IX+DPB_FDMODE)   ;フロッピーディスクのモード
001B62 EC5B CDE2EA          17      CALL    PUTDAT
001B65 EC5E 3A53E5          13      LD  A,(SECSZ_H) ;1セクタのサイズの上位1バイト
001B68 EC61 CDE2EA          17      CALL    PUTDAT
001B6B EC64 4F               4      LD  C,A
001B6C EC65 AF               4      XOR A
       EC66                     FDRD2:
001B6D EC66 81               4      ADD A,C
001B6E EC67 13               6      INC DE
001B6F EC68 05               4      DEC B
001B70 EC69 2807            12      JR  Z,FDRD3
001B72 EC6B 25               4      DEC H       ;トラック、ヘッドを跨がない
001B73 EC6C 2804            12      JR  Z,FDRD3
001B75 EC6E FE3A             7      CP  03AH        ;バッファとして04000H-07BFFHまで使える
001B77 EC70 38F4            12      JR  C,FDRD2
       EC72                     FDRD3:
001B79 EC72 E1              10      POP HL
001B7A EC73 4F               4      LD  C,A
001B7B EC74 CDE2EA          17      CALL    PUTDAT      ;バイト数H
001B7E EC77 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;フロッピーディスクのシリンダ数
001B81 EC7A CDE2EA          17      CALL    PUTDAT
                                
001B84 EC7D CDDAEA          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001B87 EC80 3E7E             7      LD  A,HIGH RESULTEX
001B89 EC82 CDE2EA          17      CALL    PUTDAT
001B8C EC85 3E21             7      LD  A,LOW RESULTEX
001B8E EC87 CDE2EA          17      CALL    PUTDAT
                                
001B91 EC8A CD07EB          17      CALL    GETDAT
001B94 EC8D 4F               4      LD  C,A
001B95 EC8E FE01             7      CP  1
001B97 EC90 D8              11      RET C
                                
001B98 EC91 3E15             7      LD  A,15H       ;高速センドメモリ
001B9A EC93 CDDCEA          17      CALL    PUTCOM
001B9D EC96 3E40             7      LD  A,HIGH DSS_DATA ;開始アドレスH
001B9F EC98 CDE2EA          17      CALL    PUTDAT
001BA2 EC9B AF               4      XOR A       ;開始アドレスL
001BA3 EC9C CDE2EA          17      CALL    PUTDAT
001BA6 EC9F 79               4      LD  A,C     ;バイト数H
001BA7 ECA0 CDE2EA          17      CALL    PUTDAT
001BAA ECA3 AF               4      XOR A       ;バイト数L
001BAB ECA4 CDE2EA          17      CALL    PUTDAT
001BAE ECA7 C5              11      PUSH    BC
001BAF ECA8 41               4      LD  B,C
001BB0 ECA9 0E00             7      LD  C,0
001BB2 ECAB CD51EB          17      CALL    FGETDAT
001BB5 ECAE C1              10      POP BC
001BB6 ECAF 78               4      LD  A,B
001BB7 ECB0 B7               4      OR  A
001BB8 ECB1 C228EC          10      JP  NZ,FDRD
001BBB ECB4 C9              10      RET
                                
[EOF:88DISK.ASM:UTF_8]
                                    INCLUDE "88INTVEC.ASM"
                                
                                ;   LSX-Dodgers TABLE 割り込みベクタとI/Oルーチン
                                
001BBC ECB5                         ALIGN   256
                                
                                ;
                                ;   割り込みベクタ:アドレス下位1バイトが0になるように
                                ;   高速RAM(0F000H-0FFFFH)と被らないようにする
                                ;
       ED00                     IRXRDY:
001C07 ED00 E1E2                    DW  INTE88
       ED02                     IVRTC:
001C09 ED02 A3E2                    DW  INTVRTC
       ED04                     ICLOCK:
001C0B ED04 E1E2                    DW  INTE88
       ED06                     IINT4:
001C0D ED06 E1E2                    DW  INTE88
       ED08                     IINT3:
001C0F ED08 E1E2                    DW  INTE88
       ED0A                     IINT2:
001C11 ED0A E1E2                    DW  INTE88
       ED0C                     IFDINT1:
001C13 ED0C E1E2                    DW  INTE88
       ED0E                     IFDINT2:
001C15 ED0E E1E2                    DW  INTE88
                                
                                ;   先行キー入力バッファ
       ED10                     KEYBF:
001C17 ED10                         DS  020H
                                
                                ;   バンク切り替え時のスタック
001C37 ED30                         DS  030H-18
       ED4E                     EXTSP:
                                
[EOF:88INTVEC.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001C55 ED4E                     PATHD:  DS  PATHX
001C90 ED89 00                  PATHE:  DB  0
                                
       ED8A                     DTA_CCP:
001C91 ED8A                         DS  37
                                
       EDAF                     FCB_BAT:
001CB6 EDAF                         DS  37
                                
001CDB EDD4 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001CE6 EDDF 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
                                ;   ALIGN   256
       EDE6                     AT_WORK:
001CED EDE6                         DS  WORKAD-AT_WORK
                                
       EE00                     CPM_BOOT:
001D07 EE00 C30000          10      JP  0
       EE03                     _SYS00:     ;(BDOS)プログラム終了
       EE03                     CPM_WBOOT:
001D0A EE03 C309D9          10      JP  WBOOT1
       EE06                     CPM_CONST:
001D0D EE06 C35FE3          10      JP  CONSTX
       EE09                     _SYS07:     ;(BDOS)コンソール直接入力
       EE09                     CPM_CONIN:
001D10 EE09 C343E3          10      JP  FLGET
       EE0C                     CPM_CONOUT:
001D13 EE0C C389E1          10      JP  CONOUT1
                                
       EE0F                     DECBF:              ;10進数表示時のバッファ(5バイト)
001D16 EE0F                         DS  5
       EE0F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       EE11                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       EE14                     FDRV:
001D1B EE14 00                      DB  0
       EE15                     FNAME:
001D1C EE15                         DS  36
       EE39                     SFILE:
001D40 EE39                         DS  33      ;DRV FILENAME
       EE5A                     _DISKE:
001D61 EE5A C363E0          10      JP  SHOW_ERROR
                                
001D64 EE5D 0000                LEFTX:  DW  0
001D66 EE5F 0000                DTAX:   DW  0
                                
                                ;   PSGのビープ音のデータ(X1)
       EE61                     BEEPD:
001D68 EE61 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
001D70 EE69 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                ;
       EE62                     RTC_YY  EQU BEEPD+1 ;RTCのバッファ年(88)
       EE63                     RTC_MW  EQU BEEPD+2 ;RTCのバッファ月(88)
       EE64                     RTC_DD  EQU BEEPD+3 ;RTCのバッファ日(88)
       EE65                     RTC_TT  EQU BEEPD+4 ;RTCのバッファ時(88)
       EE66                     RTC_MM  EQU BEEPD+5 ;RTCのバッファ分(88)
       EE67                     RTC_SS  EQU BEEPD+6 ;RTCのバッファ秒(88)
       EE62                     ROM_SLT EQU BEEPD+1 ;ROMのスロット(MSX)
       EE61                     ZERO    EQU BEEPD
                                
       EE70                     CHECK:
001D77 EE70 00                      DB  0
                                
       EE71                     OK:
001D78 EE71 4F4B24                  DB  "OK$"
001D7B EE74                         DS  5
       EE79                     COMERM:
001D80 EE79 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       EE80                     _CYL0:
001D87 EE80 FF                      DB  0FFH    ;Cylinder
       EE81                     _CYL1:
001D88 EE81 FF                      DB  0FFH    ;Cylinder
       EE82                     _CYL2:
001D89 EE82 FF                      DB  0FFH    ;Cylinder
       EE83                     _CYL3:
001D8A EE83 FF                      DB  0FFH    ;Cylinder
       EE84                     _DRIVE:
001D8B EE84 00                      DB  0   ;unit number
       EE85                     _SEEKSP:
001D8C EE85 00                      DB  0   ;Seek speed
       EE86                     _ISEEK:
001D8D EE86 32                      DB  50  ;
001D8E EE87                         DS  1
       EE88                     _DRV:
001D8F EE88 00                      DB  0
       EE89                     _DSK:
001D90 EE89 FF                      DB  0FFH
       EE8A                     _DTA:
001D91 EE8A 8000                    DW  00080H
       EE8C                     _CTC:
001D93 EE8C 0000                    DW  0
       EE8E                     _TXADR:
001D95 EE8E 0000                    DW  0
       EE90                     _KEYPS:
001D97 EE90 0000                    DW  0
       EE92                     _KEYD:
001D99 EE92 00                      DB  000H    ;キーデータ
       EE93                     _KEYST:
001D9A EE93 FF                      DB  0FFH    ;キーステータス(SHIFT,CTRLの状態)
       EE94                     _KEYSP_L:
001D9B EE94 00                      DB  KEYSP_L ;オートリピートの速度
       EE95                     _KEYSP_H:
001D9C EE95 14                      DB  KEYSP_H ;オートリピートの速度
       EE96                     _COLORF:
001D9D EE96 00                      DB  COLORF  ;色
       EE97                     _LINE:
001D9E EE97 18                      DB  LINE
                                
                                            ;次のファイルの検索(C=12)で使用するFCB
       EE98                     _FCB:
001D9F EE98 0000                    DW  0   ;SEARCH FILES
       EE9A                     _FBPS:
001DA1 EE9A 0000                    DW  0   ;    //
       EE9C                     _FBAD:
001DA3 EE9C 0000                    DW  0   ;    //
       EE9E                     _FBCNT:
001DA5 EE9E 00                      DB  0   ;    //
       EE9F                     _FILEN:
001DA6 EE9F 00                      DB  0   ;    //
       EEA0                     _DIRF:
001DA7 EEA0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
001DA8 EEA1                         DS  1
       EEA2                     _WTFATF:
001DA9 EEA2 00                      DB  0   ;FATバッファの更新フラグ
001DAA EEA3                         DS  1
       EEA4                     _WTDBF:
001DAB EEA4 00                      DB  0   ;データバッファの更新フラグ
       EEA5                     _DBDRV:
001DAC EEA5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       EEA6                     _DBSEC:
001DAD EEA6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       EEA8                     _DPB:
001DAF EEA8 0000                    DW  0
       EEAA                     _FATDRV:
001DB1 EEAA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       EEAB                     _FATIX:
001DB2 EEAB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       EEAC                     _FAKEFREE:
001DB3 EEAC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
001DB5 EEAE                         DS  2
                                ;   画面周りのデータ
       EEB0                     CRTCD:
001DB7 EEB0 6F                      DB  06FH
       EEB1                     _WIDTH:
001DB8 EEB1 50                      DB  WIDTH
       EEB2                     TVRAMTOP:
001DB9 EEB2 5938                    DB  059H,038H
001DBB EEB4 1F02                    DB  01FH,002H
       EEB6                     _LINE2:
001DBD EEB6 19                      DB  019H
       EEB7                     WKE4:
001DBE EEB7 1C                      DB  01CH
       EEB8                     WKE6:
001DBF EEB8 00                      DB  000H
       EEB9                     WK40:
001DC0 EEB9 07                      DB  007H
       EEBA                     _PAGE_MINUS:
001DC1 EEBA 80F8                    DW  0-WIDTH*LINE
       EEBC                     _WIDTH_MINUS:
001DC3 EEBC B0FF                    DW  0-WIDTH
       EEBE                     WK30:
001DC5 EEBE 0C                      DB  00CH
       EEBF                     WK31:
       EEBF                     WK1FD0:
001DC6 EEBF 20                      DB  020H
                                
                                ;   割り込みベクタ(X1)
001DC7 EEC0 0000                CTC0:   DW  INTCTCE
001DC9 EEC2 0000                CTC1:   DW  INTCTCE
001DCB EEC4 0000                CTC2:   DW  INTCTCE
001DCD EEC6 0000                CTC3:   DW  INTCTCE
001DCF EEC8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
001DD1 EECA C30AE2          10  _INKEY: JP  INKEY
001DD4 EECD C348E1          10  _PRINT: JP  PRINT
001DD7 EED0 C384E2          10  _SCRN:  JP  SCRN
001DDA EED3 C3AEE1          10  _POS:   JP  POS
001DDD EED6 C39CF0          10  _LOC:   JP  LOC
       EED9                     _CHGDRV:
001DE0 EED9 C3E3E9          10      JP  CHGDRV
       EEDC                     _GETDPB:
001DE3 EEDC C3A1EA          10      JP  GETDPB
       EEDF                     _FFLUSH:
001DE6 EEDF C3BFEA          10      JP  FFLUSH
       EEE2                     _RDFATX:
001DE9 EEE2 C3BBE6          10      JP  RDFATX
001DEC EEE5 C3EDE7          10  _RDFAT: JP  RDFAT
001DEF EEE8 C38EEB          10  _WTTRK: JP  WTTRK
001DF2 EEEB C328EC          10  _FDRD:  JP  FDRD
001DF5 EEEE C390EB          10  _FDWT:  JP  FDWT
       EEF1                     _BPB2DPB:
001DF8 EEF1 C385E8          10      JP  BPB2DPB
       EEF4                     _BREAK:
001DFB EEF4 C3A9DA          10      JP  END_BATCH
       EEF7                     _GNCL:
001DFE EEF7 C367E7          10      JP  GNCL        ; self-modifying code
       EEF8                     GNCPAT  EQU $-2
       EEFA                     _SNCL:
001E01 EEFA C38AE7          10      JP  SNCL        ; self-modifying code
       EEFB                     SNCPAT  EQU $-2
       EEFD                     _COMANL:
001E04 EEFD C362D9          10      JP  COMANL
                                
       EF00                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       EF00                     STABLE:
                                ;0
001E07 EF00 03EE16E322E3AAF1        DW  _SYS00,_SYS01,_SYS02,_SYS03
001E0F EF08 CEDDCEDD27E309EE        DW  _SYS04,_SYS05,_SYS06,_SYS07
001E17 EF10 2FE3D0DD75E057E3        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
001E1F EF18 E5DDEADDF9DD0ADE        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001E27 EF20 5EDEA5DEEEDE1FDF        DW  _SYS10,_SYS11,_SYS12,_SYS13
001E2F EF28 27DF3DDF52DF4ADF        DW  _SYS14,_SYS15,_SYS16,_SYS17
001E37 EF30 99DF9EDFA3DFA9DF        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001E3F EF38 CEDDCFDFCEDDD3DF        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
001E47 EF40 CEDD89DF91DFDADF        DW  _SYS20,_SYS21,_SYS22,_SYS23
001E4F EF48 FFDFCEDD7BE349E4        DW  _SYS24,_ERROR,_SYS26,_SYS27
001E57 EF50 91DF09E0A1E0AAF1        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
001E5F EF58 C8E0AAF1CEDD2AE0        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
001E67 EF60 24E0CEDDCEDDCEDD        DW  _SYS30,_ERROR,_ERROR,_ERROR
001E6F EF68 CEDDCEDDCEDDCEDD        DW  _ERROR,_ERROR,_ERROR,_ERROR
001E77 EF70 CEDDAAF1AAF14BE0        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
001E7F EF78 B1DD                    DW  _DOS2
                                
001E81 EF7A                         DS  1
       EF7B                     _MAX_SEC_SZ_H:
001E82 EF7B 02                      DB  MAX_SEC_SZ_H
                                
                                ;   FATバッファのアドレス
       EF7C                     _FATBF:
001E83 EF7C 00F7                    DW  FATBF
                                
                                ;   データバッファのアドレス
       EF7E                     _DTBUF:
001E85 EF7E 00FD                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       EF80                     CTRLTB:
001E87 EF80 9FF09FF0D5F06EF1        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
001E8F EF88 68F1F5F04CF123F1        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
001E97 EF90 A6F0CAF071F116F1        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
001E9F EF98 49F109F178F19FF0        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
001EA7 EFA0 9FF09FF00EF19FF0        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
001EAF EFA8 9FF09FF09FF09FF0        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
001EB7 EFB0 9FF09FF049F11DF1        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
001EBF EFB8 89F0ADF0C1F071F1        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
                                ;   2D/2DDでBPBがない場合のデフォルト値(2D/360KB/9セクタ1024バイト)
001EC7 EFC0 0200                M2D:    DW  2
001EC9 EFC2 FD02                    DB  0FDH,2
001ECB EFC4 6401                    DW  356
001ECD EFC6 FF0728090182            DB  0FFH,7,40,9,1,082H
001ED3 EFCC 0500A7000800            DW  5,0A7H,8
                                
                                ;   2HDでBPBがない場合のデフォルト値(2HD/1.23MB/8セクタ1024バイト)
001ED9 EFD2 0200                M2HD:   DW  2
001EDB EFD4 FE01                    DB  0FEH,1
001EDD EFD6 C704                    DW  1223
001EDF EFD8 FE064D080184            DB  0FEH,6,77,8,1,084H
001EE5 EFDE 0500A7000900            DW  5,0A7H,9
                                
                                ;   ディレクトリエントリとFCBの変換テーブル(日付+時刻+サイズ)
001EEB EFE4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
001EED EFE6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
001EEF EFE8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
001EF1 EFEA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       EFEE                     SDDATAE:
                                
001EF5 EFEE                         DS  2
                                
                                ;   バッチファイルのFCB
       EFF0                     _FCB_BAT:
001EF7 EFF0 AFED                    DW  FCB_BAT
       EFF2                     _PATH:
001EF9 EFF2 4EED                    DW  PATHD
                                
001EFB EFF4                     SCDIR:  DS  2       ;+14 +15
001EFD EFF6                     SFBPS:  DS  2       ;FBPS
001EFF EFF8                     SFNDF:  DS  2       ;FILEN DIRF
                                
001F01 EFFA 0000                _FATPS: DW  0
001F03 EFFC 0000                _DIRPS: DW  0
001F05 EFFE 0000                _CLPS:  DW  0
                                
       F000                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       F000                     FILEC:
001F07 F000 CD0BF0          17      CALL    FILE
       F003                     FILEC2:
001F0A F003 3A15EE          13      LD  A,(FDRV+1)
001F0D F006 FE20             7      CP  020H
001F0F F008 C8              11      RET Z
001F10 F009 1839            12      JR  SETDIR1
                                
       F00B                     FILE:
001F12 F00B AF               4      XOR A
001F13 F00C 3214EE          13      LD  (FDRV),A
001F16 F00F 67               4      LD  H,A
001F17 F010 6F               4      LD  L,A
001F18 F011 2222EE          16      LD  (FDRV+14),HL
001F1B F014 CDE1F0          17      CALL    SPCUT
001F1E F017 CDC6F0          17      CALL    CCHK3
001F21 F01A 2812            12      JR  Z,DEVI1
001F23 F01C 13               6      INC DE
001F24 F01D 1A               7      LD  A,(DE)
001F25 F01E 1B               6      DEC DE
001F26 F01F FE3A             7      CP  ':'
001F28 F021 200B            12      JR  NZ,DEVI1
001F2A F023 1A               7      LD  A,(DE)      ;DRIVE
001F2B F024 CD27F3          17      CALL    CAP
001F2E F027 D640             7      SUB '@'
001F30 F029 13               6      INC DE
001F31 F02A 13               6      INC DE
001F32 F02B 3214EE          13      LD  (FDRV),A
       F02E                     DEVI1:
001F35 F02E 1A               7      LD  A,(DE)
001F36 F02F D65C             7      SUB 05CH        ;\
001F38 F031 2009            12      JR  NZ,NOROOT
001F3A F033 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
001F3B F034 222EEE          16      LD  (FDRV+26),HL
001F3E F037 2C               4      INC L
001F3F F038 2222EE          16      LD  (FDRV+14),HL
001F42 F03B 13               6      INC DE
       F03C                     NOROOT:
                                
       F03C                     SETDIR:
001F43 F03C CD67F0          17      CALL    FILED
001F46 F03F 1A               7      LD  A,(DE)
001F47 F040 FE5C             7      CP  05CH        ;\
001F49 F042 C0              11      RET NZ
001F4A F043 13               6      INC DE
       F044                     SETDIR1:
001F4B F044 3E10             7      LD  A,010H      ;Directory
001F4D F046 3221EE          13      LD  (FDRV+13),A
001F50 F049 D5              11      PUSH    DE
001F51 F04A 1114EE          10      LD  DE,FDRV
001F54 F04D 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
001F56 F04F CD9FDD          17      CALL    BDOS0
001F59 F052 D1              10      POP DE
001F5A F053 B7               4      OR  A
001F5B F054 C0              11      RET NZ
                                
001F5C F055 3A21EE          13      LD  A,(FDRV+13)
001F5F F058 E610             7      AND 010H        ;ディレクトリ
001F61 F05A C8              11      RET Z
                                
001F62 F05B CDAEF0          17      CALL    FILEI
001F65 F05E 2A2EEE          16      LD  HL,(FDRV+26)
001F68 F061 23               6      INC HL
001F69 F062 2222EE          16      LD  (FDRV+14),HL
001F6C F065 18D5            12      JR  SETDIR
                                
       F067                     FILED:
001F6E F067 CDAEF0          17      CALL    FILEI
001F71 F06A 2115EE          10      LD  HL,FNAME
                                
001F74 F06D 0608             7      LD  B,8
       F06F                     FILE2:
001F76 F06F CDBBF0          17      CALL    CCHKF
001F79 F072 C8              11      RET Z
001F7A F073 FE2A             7      CP  '*'
001F7C F075 282E            12      JR  Z,FILE9
001F7E F077 FE2E             7      CP  '.'
001F80 F079 280C            12      JR  Z,FILE4
001F82 F07B 77               7      LD  (HL),A
001F83 F07C 23               6      INC HL
001F84 F07D 10F0            13      DJNZ    FILE2
                                
       F07F                     FILE3:
001F86 F07F CDBBF0          17      CALL    CCHKF
001F89 F082 C8              11      RET Z
001F8A F083 FE2E             7      CP  '.'
001F8C F085 20F8            12      JR  NZ,FILE3
                                
       F087                     FILE4:
001F8E F087 211DEE          10      LD  HL,FNAME+8
001F91 F08A 0603             7      LD  B,3
                                
       F08C                     FILE4L:
001F93 F08C CDBBF0          17      CALL    CCHKF
001F96 F08F C8              11      RET Z
001F97 F090 FE2E             7      CP  '.'
001F99 F092 2008            12      JR  NZ,FILE12
001F9B F094 3215EE          13      LD  (FNAME),A   ;Parent directory(..)
001F9E F097 3216EE          13      LD  (FNAME+1),A
001FA1 F09A 3E20             7      LD  A,020H
       F09C                     FILE12:
001FA3 F09C FE2A             7      CP  '*'
001FA5 F09E 280A            12      JR  Z,FILE10
001FA7 F0A0 77               7      LD  (HL),A
001FA8 F0A1 23               6      INC HL
001FA9 F0A2 10E8            13      DJNZ    FILE4L
001FAB F0A4 C9              10      RET
                                
       F0A5                     FILE9:              ;名前の*処理、名前の残りを?で埋める
001FAC F0A5 CDAAF0          17      CALL    FILE10
001FAF F0A8 18D5            12      JR  FILE3
                                
       F0AA                     FILE10:
001FB1 F0AA 3E3F             7      LD  A,'?'
001FB3 F0AC 1808            12      JR  FILL_MEMORY
       F0AE                     FILEI:              ;名前＋拡張子をスペースで初期化
001FB5 F0AE 3E20             7      LD  A,020H
001FB7 F0B0 01000B          10      LD  BC,11*256   ;C=0にしておく
001FBA F0B3 2115EE          10      LD  HL,FNAME
       F0B6                     FILL_MEMORY:            ;HLからBバイトAで埋める
001FBD F0B6 77               7      LD  (HL),A
001FBE F0B7 23               6      INC HL
001FBF F0B8 10FC            13      DJNZ    FILL_MEMORY
001FC1 F0BA C9              10      RET
                                
       F0BB                     CCHKF:
001FC2 F0BB 1A               7      LD  A,(DE)
001FC3 F0BC CDC3F0          17      CALL    CCHK2
001FC6 F0BF C8              11      RET Z
001FC7 F0C0 C32FF4          10      JP  FKAN
                                
       F0C3                     CCHK2:
001FCA F0C3 0C               4      INC C
001FCB F0C4 0D               4      DEC C
001FCC F0C5 C0              11      RET NZ
       F0C6                     CCHK3:              ;ZF=1 で使えない文字
001FCD F0C6 FE2B             7      CP  '+'
001FCF F0C8 C8              11      RET Z
001FD0 F0C9 FE2C             7      CP  ','
001FD2 F0CB C8              11      RET Z
001FD3 F0CC FE2F             7      CP  '/'
001FD5 F0CE C8              11      RET Z
001FD6 F0CF FE3A             7      CP  ':'
001FD8 F0D1 C8              11      RET Z
001FD9 F0D2 FE3B             7      CP  ';'
001FDB F0D4 C8              11      RET Z
001FDC F0D5 FE3D             7      CP  '='
001FDE F0D7 C8              11      RET Z
001FDF F0D8 FE5C             7      CP  05CH    ;\
001FE1 F0DA C8              11      RET Z
001FE2 F0DB FE20             7      CP  020H
001FE4 F0DD D0              11      RET NC
001FE5 F0DE BF               4      CP  A       ;Z=1
001FE6 F0DF C9              10      RET
                                
       F0E0                     SS1:
001FE7 F0E0 13               6      INC DE
       F0E1                     SPCUT:              ;スペースをカット
001FE8 F0E1 1A               7      LD  A,(DE)
001FE9 F0E2 FE20             7      CP  020H
001FEB F0E4 28FA            12      JR  Z,SS1
001FED F0E6 C9              10      RET
                                
       F0E7                     SETDRVF:
001FEE F0E7 1114EE          10      LD  DE,FDRV
       F0EA                     SETDRV0:
001FF1 F0EA CDF3F0          17      CALL    SETDRV
001FF4 F0ED FDE1            14      POP IY
001FF6 F0EF C1              10      POP BC
001FF7 F0F0 D1              10      POP DE
001FF8 F0F1 E1              10      POP HL
001FF9 F0F2 C9              10      RET
                                
       F0F3                     SETDRV:
001FFA F0F3 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
001FFB F0F4 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
001FFC F0F5 C5              11      PUSH    BC
001FFD F0F6 1A               7      LD  A,(DE)
001FFE F0F7 D5              11      PUSH    DE
001FFF F0F8 FDE3            23      EX  (SP),IY
                                
002001 F0FA CD01F1          17      CALL    GETDRV
002004 F0FD CDD9EE          17      CALL    _CHGDRV
                                
002007 F100 E9               4      JP  (HL)
                                
       F101                     GETDRV:
002008 F101 CD14F1          17      CALL    GETDRV1
00200B F104 3288EE          13      LD  (_DRV),A
00200E F107 C9              10      RET
                                
       F108                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
00200F F108 CD14F1          17      CALL    GETDRV1
002012 F10B C5              11      PUSH    BC
002013 F10C 4F               4      LD  C,A
002014 F10D 1A               7      LD  A,(DE)
002015 F10E CD14F1          17      CALL    GETDRV1
002018 F111 A9               4      XOR C
002019 F112 C1              10      POP BC
00201A F113 C9              10      RET
       F114                     GETDRV1:
00201B F114 E67F             7      AND 07FH
00201D F116 D601             7      SUB 001H
00201F F118 D0              11      RET NC
002020 F119 3A0400          13      LD  A,(_DVSW)   ;Current Drive
002023 F11C C9              10      RET
                                
       F11D                     SOPENX:
002024 F11D 1139EE          10      LD  DE,SFILE
002027 F120 FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
00202A F123 CD08F1          17      CALL    IS_SAME_DRV_A_DE
00202D F126 2024            12      JR  NZ,SOPEN
00202F F128 13               6      INC DE
002030 F129 FDE5            15      PUSH    IY
002032 F12B E1              10      POP HL
002033 F12C 23               6      INC HL
002034 F12D CDB8F2          17      CALL    CPFILE
002037 F130 201A            12      JR  NZ,SOPEN
                                
002039 F132 2AF4EF          16      LD  HL,(SCDIR)
00203C F135 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00203F F138 FD740F          19      LD  (IY+15),H
                                
002042 F13B 2AF8EF          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
002045 F13E 229FEE          16      LD  (_FILEN),HL
                                
002048 F141 ED5BF6EF        20      LD  DE,(SFBPS)
00204C F145 2139EE          10      LD  HL,SFILE
00204F F148 36FF            10      LD  (HL),0FFH
002051 F14A 23               6      INC HL
002052 F14B C9              10      RET
       F14C                     SOPEN:
002053 F14C 2160F2          10      LD  HL,FILESE
       F14F                     SOPENC:
002056 F14F 2288F1          16      LD  (OPENPAT),HL
                                
002059 F152 CDE2EE          17      CALL    _RDFATX     ;Detect Media
00205C F155 3856            12      JR  C,RDDERR
                                
00205E F157 AF               4      XOR A
00205F F158 329FEE          13      LD  (_FILEN),A
002062 F15B CD64F3          17      CALL    LDDIRX1     ;A=0で呼び出す
002065 F15E 2818            12      JR  Z,SDIRX1
                                
002067 F160 CD51F2          17      CALL    READ_DIR    ;Sub Directory
00206A F163 3808            12      JR  C,SDIRX0
00206C F165 2A7EEF          16      LD  HL,(_DTBUF)
00206F F168 7E               7      LD  A,(HL)
002070 F169 FE2E             7      CP  '.'
002072 F16B 280F            12      JR  Z,SOPEN1
       F16D                     SDIRX0:
002074 F16D AF               4      XOR A
002075 F16E 32A0EE          13      LD  (_DIRF),A
002078 F171 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
00207C F175 FD770F          19      LD  (IY+15),A
       F178                     SDIRX1:
00207F F178 ED5BFCEF        20      LD  DE,(_DIRPS) ;Root Directory
       F17C                     SOPEN1:
002083 F17C 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       F17D                     SDECPAT EQU $-1
       F17E                     SOPEN1X:
002085 F17E CD51F2          17      CALL    READ_DIR    ;FILE SEARCH
002088 F181 382A            12      JR  C,RDDERR
00208A F183 2A7EEF          16      LD  HL,(_DTBUF)
       F186                     SOPEN2:
00208D F186 D5              11      PUSH    DE
00208E F187 CD60F2          17      CALL    FILESE      ;(self-modifying code)
       F188                     OPENPAT EQU $-2
002091 F18A D1              10      POP DE
002092 F18B 386D            12      JR  C,SOPENE
002094 F18D 281B            12      JR  Z,SCF_FF_RET
       F18F                     SOPEN3:
002096 F18F 3AA0EE          13      LD  A,(_DIRF)   ;ディレクトリか判別
002099 F192 B7               4      OR  A
00209A F193 200C            12      JR  NZ,SOPEN5
00209C F195 13               6      INC DE      ;ルートディレクトリ
00209D F196 E5              11      PUSH    HL
00209E F197 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       F198                     MD_PAT  EQU $-2
0020A1 F19A ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
0020A3 F19C E1              10      POP HL
0020A4 F19D 20DD            12      JR  NZ,SOPEN1
0020A6 F19F 1807            12      JR  SOPEN6
       F1A1                     SOPEN5:
0020A8 F1A1 CDE6E7          17      CALL    GNCLX       ;END DIR
0020AB F1A4 D8              11      RET C
0020AC F1A5 CD18F3          17      CALL    ENDCL
       F1A8                     SOPEN6:
0020AF F1A8 38D2            12      JR  C,SOPEN1
       F1AA                     SCF_FF_RET:
0020B1 F1AA 37               4      SCF         ;CF=1
0020B2 F1AB 9F               4      SBC A,A     ;A=0FFH
0020B3 F1AC C9              10      RET
                                
       F1AD                     RDDERR:
0020B4 F1AD BF               4      CP  A       ;READ ERR CF=1 ZF=1
0020B5 F1AE 37               4      SCF
0020B6 F1AF C9              10      RET
                                
       F1B0                     NOPEN:
0020B7 F1B0 2160F2          10      LD  HL,FILESE
0020BA F1B3 2288F1          16      LD  (OPENPAT),HL
0020BD F1B6 FD2A98EE        20      LD  IY,(_FCB)
0020C1 F1BA CD42F4          17      CALL    CHKWILDX
0020C4 F1BD 30EB            12      JR  NC,SCF_FF_RET
0020C6 F1BF FD7E00          19      LD  A,(IY+0)
0020C9 F1C2 CD01F1          17      CALL    GETDRV
0020CC F1C5 CDD9EE          17      CALL    _CHGDRV
0020CF F1C8 D8              11      RET C
0020D0 F1C9 2AF8EF          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
0020D3 F1CC 229FEE          16      LD  (_FILEN),HL
                                
0020D6 F1CF CD5FF3          17      CALL    LDDIRX
0020D9 F1D2 ED5B9AEE        20      LD  DE,(_FBPS)
0020DD F1D6 CD51F2          17      CALL    READ_DIR
0020E0 F1D9 38D2            12      JR  C,RDDERR
0020E2 F1DB 3A9EEE          13      LD  A,(_FBCNT)
0020E5 F1DE 3D               4      DEC A
0020E6 F1DF 28AE            12      JR  Z,SOPEN3
       F1E1                     NOPEN2:
0020E8 F1E1 2A9CEE          16      LD  HL,(_FBAD)
0020EB F1E4 012000          10      LD  BC,020H
0020EE F1E7 09              11      ADD HL,BC
0020EF F1E8 4F               4      LD  C,A
0020F0 F1E9 189B            12      JR  SOPEN2
                                
       F1EB                     SOPENE2:
0020F2 F1EB 229CEE          16      LD  (_FBAD),HL
0020F5 F1EE 79               4      LD  A,C
0020F6 F1EF 329EEE          13      LD  (_FBCNT),A
0020F9 F1F2 ED539AEE        20      LD  (_FBPS),DE
0020FD F1F6 FD2298EE        20      LD  (_FCB),IY
       F1FA                     SOPENE:
002101 F1FA AF               4      XOR A
002102 F1FB C9              10      RET
                                
       F1FC                     COPEN:
002103 F1FC FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
002107 F200 217DF2          10      LD  HL,NEXTSE
00210A F203 CD4FF1          17      CALL    SOPENC
00210D F206 D0              11      RET NC
00210E F207 C8              11      RET Z
00210F F208 3AA0EE          13      LD  A,(_DIRF)   ;ディレクトリか判別
002112 F20B B7               4      OR  A
002113 F20C 37               4      SCF
002114 F20D C8              11      RET Z       ;ルートディレクトリ
002115 F20E 0601             7      LD  B,1
002117 F210 CDA1F4          17      CALL    WRDF
00211A F213 D8              11      RET C
00211B F214 ED5BFEEF        20      LD  DE,(_CLPS)
00211F F218 D5              11      PUSH    DE
002120 F219 CDE1F2          17      CALL    DCPAT
002123 F21C CD67E6          17      CALL    DRDNX
002126 F21F 2A7EEF          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
002129 F222 ED4B52E5        20      LD  BC,(SECSZ)  ;1セクタのサイズ
00212D F226 AF               4      XOR A
       F227                     COPENCL:
00212E F227 77               7      LD  (HL),A
00212F F228 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
002131 F22A EA27F2          10      JP  PE,COPENCL
                                
002134 F22D 3AFFF2          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
002137 F230 3D               4      DEC A
002138 F231 2819            12      JR  Z,COPENE
00213A F233 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
00213C F235 32DEE7          13      LD  (_SECPS),A
00213F F238 D1              10      POP DE      ;DE=(_CLPS)
002140 F239 D5              11      PUSH    DE
       F23A                     COPEN1:
002141 F23A D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
002142 F23B C5              11      PUSH    BC
002143 F23C 2A7EEF          16      LD  HL,(_DTBUF)
002146 F23F CDFBF2          17      CALL    CLUSTX
002149 F242 CD7DE9          17      CALL    DWT24
00214C F245 C1              10      POP BC
00214D F246 D1              10      POP DE
00214E F247 CDDDE7          17      CALL    NEXTX
002151 F24A 20EE            12      JR  NZ,COPEN1
       F24C                     COPENE:
002153 F24C 2A7EEF          16      LD  HL,(_DTBUF)
002156 F24F D1              10      POP DE
002157 F250 C9              10      RET
                                
       F251                     READ_DIR:
002158 F251 ED53FEEF        20      LD  (_CLPS),DE
00215C F255 C5              11      PUSH    BC
00215D F256 D5              11      PUSH    DE
00215E F257 CDE1F2          17      CALL    DCPAT
002161 F25A CD47E6          17      CALL    DRDX
002164 F25D D1              10      POP DE
002165 F25E C1              10      POP BC
002166 F25F C9              10      RET
                                
       F260                     FILESE:
002167 F260 7E               7      LD  A,(HL)
002168 F261 B7               4      OR  A
002169 F262 C8              11      RET Z       ;END:ZF=1 CF=0
00216A F263 FEE5             7      CP  0E5H
00216C F265 280E            12      JR  Z,FILESE1
00216E F267 FDE5            15      PUSH    IY
002170 F269 D1              10      POP DE
002171 F26A 13               6      INC DE
002172 F26B E5              11      PUSH    HL
002173 F26C CDB8F2          17      CALL    CPFILE
002176 F26F CCD9F2          17      CALL    Z,CPFILE2
002179 F272 E1              10      POP HL
00217A F273 37               4      SCF
00217B F274 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       F275                     FILESE1:
00217C F275 CD8CF2          17      CALL    FNEXT
00217F F278 20E6            12      JR  NZ,FILESE
       F27A                     ZF0_CF0_AFF_RET:
002181 F27A F6FF             7      OR  0FFH        ;ZF=0 CF=0
002183 F27C C9              10      RET
                                
       F27D                     NEXTSE:
002184 F27D 7E               7      LD  A,(HL)
002185 F27E B7               4      OR  A
002186 F27F 37               4      SCF
002187 F280 C8              11      RET Z       ;!!!:ZF=1 CF=1
002188 F281 FEE5             7      CP  0E5H
00218A F283 37               4      SCF
00218B F284 C8              11      RET Z       ;!!!:(ZF=1) CF=1
00218C F285 CD8CF2          17      CALL    FNEXT
00218F F288 20F3            12      JR  NZ,NEXTSE
002191 F28A 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       F28C                     FNEXT:
002193 F28C E5              11      PUSH    HL
002194 F28D 219FEE          10      LD  HL,_FILEN
002197 F290 34              11      INC (HL)
002198 F291 E1              10      POP HL
002199 F292 112000          10      LD  DE,020H
00219C F295 19              11      ADD HL,DE
00219D F296 0D               4      DEC C
00219E F297 C9              10      RET
                                
       F298                     CPNAME:
00219F F298 C5              11      PUSH    BC
0021A0 F299 D5              11      PUSH    DE
0021A1 F29A E5              11      PUSH    HL
0021A2 F29B CDB2F2          17      CALL    CPFILE4
0021A5 F29E E1              10      POP HL
0021A6 F29F 23               6      INC HL
0021A7 F2A0 23               6      INC HL
0021A8 F2A1 23               6      INC HL
0021A9 F2A2 23               6      INC HL
0021AA F2A3 D1              10      POP DE
0021AB F2A4 C1              10      POP BC
0021AC F2A5 2005            12      JR  NZ,CPNAME1
0021AE F2A7 7E               7      LD  A,(HL)
0021AF F2A8 23               6      INC HL
0021B0 F2A9 66               7      LD  H,(HL)
0021B1 F2AA 6F               4      LD  L,A
0021B2 F2AB C9              10      RET
       F2AC                     CPNAME1:
0021B3 F2AC 23               6      INC HL
0021B4 F2AD 23               6      INC HL
0021B5 F2AE 10E8            13      DJNZ    CPNAME
0021B7 F2B0 37               4      SCF
0021B8 F2B1 C9              10      RET
                                
       F2B2                     CPFILE4:
0021B9 F2B2 C5              11      PUSH    BC
0021BA F2B3 010004          10      LD  BC,00400H
0021BD F2B6 1804            12      JR  CPSTR1
       F2B8                     CPFILE:
0021BF F2B8 C5              11      PUSH    BC
0021C0 F2B9 01000B          10      LD  BC,00B00H
       F2BC                     CPSTR1:
0021C3 F2BC 1A               7      LD  A,(DE)
0021C4 F2BD FE3F             7      CP  '?'     ;Wild card
0021C6 F2BF 2812            12      JR  Z,CPSTR2
0021C8 F2C1 7E               7      LD  A,(HL)
0021C9 F2C2 CD28F4          17      CALL    FKANC
0021CC F2C5 E5              11      PUSH    HL
0021CD F2C6 67               4      LD  H,A
0021CE F2C7 1A               7      LD  A,(DE)
0021CF F2C8 CB01             8      RLC C
0021D1 F2CA CD28F4          17      CALL    FKANC
0021D4 F2CD CB09             8      RRC C
0021D6 F2CF BC               4      CP  H       ;CP (HL),(DE)
0021D7 F2D0 E1              10      POP HL
0021D8 F2D1 2004            12      JR  NZ,CPSTR3
       F2D3                     CPSTR2:
0021DA F2D3 13               6      INC DE
0021DB F2D4 23               6      INC HL
0021DC F2D5 10E5            13      DJNZ    CPSTR1
       F2D7                     CPSTR3:
0021DE F2D7 C1              10      POP BC
0021DF F2D8 C9              10      RET
                                
       F2D9                     CPFILE2:
0021E0 F2D9 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0021E3 F2DC F6E1             7      OR  0E1H
0021E5 F2DE 2F               4      CPL
0021E6 F2DF A6               7      AND (HL)
0021E7 F2E0 C9              10      RET
                                
       F2E1                     DCPAT:
0021E8 F2E1 0E00             7      LD  C,0
0021EA F2E3 2A7EEF          16      LD  HL,(_DTBUF)
0021ED F2E6 3AA0EE          13      LD  A,(_DIRF)   ;ディレクトリか判別
0021F0 F2E9 B7               4      OR  A
0021F1 F2EA C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
0021F2 F2EB 3AFFF2          13      LD  A,(SPCPAT)
0021F5 F2EE 4F               4      LD  C,A
0021F6 F2EF 3ADEE7          13      LD  A,(_SECPS)
0021F9 F2F2 B9               4      CP  C
0021FA F2F3 3801            12      JR  C,DC1
0021FC F2F5 AF               4      XOR A
       F2F6                     DC1:
0021FD F2F6 F680             7      OR  080H
0021FF F2F8 32A0EE          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       F2FB                     CLUSTX:
002202 F2FB E5              11      PUSH    HL
002203 F2FC EB               4      EX  DE,HL
002204 F2FD AF               4      XOR A
002205 F2FE 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       F2FF                     SPCPAT  EQU $-1
       F300                     L_CLDBL:
002207 F300 CB19             8      RR  C       ;->CF
002209 F302 3804            12      JR  C,E_CLDBL
00220B F304 29              11      ADD HL,HL       ;*2
00220C F305 8F               4      ADC A,A
00220D F306 18F8            12      JR  L_CLDBL
       F308                     E_CLDBL:
00220F F308 4F               4      LD  C,A
002210 F309 3ADEE7          13      LD  A,(_SECPS)
002213 F30C B5               4      OR  L
002214 F30D 6F               4      LD  L,A
002215 F30E 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       F30F                     CLSPAT  EQU $-2
002218 F311 AF               4      XOR A
002219 F312 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
00221A F313 89               4      ADC A,C
00221B F314 4F               4      LD  C,A
00221C F315 EB               4      EX  DE,HL
00221D F316 E1              10      POP HL
00221E F317 C9              10      RET
                                ;(8)
       F318                     ENDCL:
00221F F318 7A               4      LD  A,D ;END CLUSTER
002220 F319 FE01             7      CP  1   ;164=356    (self-modifying code)
       F31A                     CLPAT1  EQU $-1
002222 F31B C0              11      RET NZ
002223 F31C 7B               4      LD  A,E
002224 F31D FE64             7      CP  064H    ;       (self-modifying code)
       F31E                     CLPAT2  EQU $-1
002226 F31F C9              10      RET
                                ;(3)
       F320                     CAP4:
002227 F320 3EE5             7      LD  A,0E5H
002229 F322 C9              10      RET
                                                    ;for X1/88 ワークエリア
00222A F323 5BEE                    DW  _DISKE+1        ;DISKVE($F323)
00222C F325 F5EE                    DW  _BREAK+1        ;BREAKV($F325)
                                
       F327                     CAP:            ;(9)
00222E F327 FE61             7      CP  'a'
002230 F329 D8              11      RET C
002231 F32A FE7B             7      CP  'z'+1
002233 F32C D0              11      RET NC
002234 F32D D620             7      SUB 020H
002236 F32F C9              10      RET
                                ;(10)
       F330                     CAP2:
002237 F330 CD27F3          17      CALL    CAP
       F333                     CAP3:               ;
00223A F333 FE05             7      CP  5
00223C F335 28E9            12      JR  Z,CAP4
00223E F337 FE21             7      CP  021H
002240 F339 C9              10      RET
                                                    ;
       F33A                     CHDIR:
002241 F33A CD8EEA          17      CALL    GETDPBD
002244 F33D 381D            12      JR  C,CHDIR2
002246 F33F DD751A          19      LD  (IX+DPB_SDIR),L
002249 F342 DD741B          19      LD  (IX+DPB_SDIR+1),H
00224C F345 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       F347                     LDDIR:
00224E F347 CD8EEA          17      CALL    GETDPBD
002251 F34A DD5E1A          19      LD  E,(IX+DPB_SDIR)
002254 F34D DD561B          19      LD  D,(IX+DPB_SDIR+1)
002257 F350 13               6      INC DE
002258 F351 FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00225B F354 FD720F          19      LD  (IY+15),D
00225E F357 1B               6      DEC DE
00225F F358 AF               4      XOR A
002260 F359 32A0EE          13      LD  (_DIRF),A
       F35C                     CHDIR2:
002263 F35C DDE1            14      POP IX
002265 F35E C9              10      RET
                                
       F35F                     LDDIRX:
002266 F35F 3AA0EE          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
002269 F362 E67F             7      AND 07FH
       F364                     LDDIRX1:
00226B F364 32DEE7          13      LD  (_SECPS),A
00226E F367 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
002271 F36A FD560F          19      LD  D,(IY+15)
002274 F36D 1B               6      DEC DE
002275 F36E CD18F3          17      CALL    ENDCL
002278 F371 D447F3          17      CALL    NC,LDDIR
       F374                     LDDIRS:
00227B F374 7A               4      LD  A,D
00227C F375 B3               4      OR  E
00227D F376 32A0EE          13      LD  (_DIRF),A   ;ディレクトリか判別
002280 F379 C9              10      RET
                                
       F37A                     KILL:
002281 F37A CD42F4          17      CALL    CHKWILDX
002284 F37D 3834            12      JR  C,KILLW
002286 F37F CD1DF1          17      CALL    SOPENX
       F382                     KILLS:
002289 F382 3E1F             7      LD  A,01FH
00228B F384 D4C6F3          17      CALL    NC,CHKATT
00228E F387 D8              11      RET C
       F388                     KILLSX:
00228F F388 36E5            10      LD  (HL),0E5H   ;DIR
002291 F38A CD1EF4          17      CALL    WTDB
002294 F38D 111A00          10      LD  DE,01AH
002297 F390 19              11      ADD HL,DE
002298 F391 5E               7      LD  E,(HL)
002299 F392 23               6      INC HL
00229A F393 56               7      LD  D,(HL)
       F394                     KILLS1:
00229B F394 CD18F3          17      CALL    ENDCL
00229E F397 D0              11      RET NC      ;CF=0
00229F F398 21FEFF          10      LD  HL,0-2
0022A2 F39B 19              11      ADD HL,DE
0022A3 F39C D0              11      RET NC      ;DE= 0 or 1
0022A4 F39D D5              11      PUSH    DE
0022A5 F39E CDF7EE          17      CALL    _GNCL
0022A8 F3A1 ED53FEEF        20      LD  (_CLPS),DE
0022AC F3A5 D1              10      POP DE
0022AD F3A6 210000          10      LD  HL,0
0022B0 F3A9 D4FAEE          17      CALL    NC,_SNCL
0022B3 F3AC D8              11      RET C
0022B4 F3AD ED5BFEEF        20      LD  DE,(_CLPS)  ;FAT
0022B8 F3B1 18E1            12      JR  KILLS1
                                
       F3B3                     KILLW:
0022BA F3B3 CD4CF1          17      CALL    SOPEN
       F3B6                     KILLW1:
0022BD F3B6 380B            12      JR  C,KILLW2
0022BF F3B8 CDEBF1          17      CALL    SOPENE2
0022C2 F3BB CD82F3          17      CALL    KILLS
0022C5 F3BE CDB0F1          17      CALL    NOPEN
0022C8 F3C1 18F3            12      JR  KILLW1
       F3C3                     KILLW2:
0022CA F3C3 C8              11      RET Z
0022CB F3C4 3F               4      CCF
0022CC F3C5 C9              10      RET
                                
       F3C6                     CHKATT:
0022CD F3C6 E5              11      PUSH    HL
0022CE F3C7 110B00          10      LD  DE,00BH
0022D1 F3CA 19              11      ADD HL,DE
0022D2 F3CB A6               7      AND (HL)
0022D3 F3CC E1              10      POP HL
0022D4 F3CD C8              11      RET Z
0022D5 F3CE 37               4      SCF
0022D6 F3CF C9              10      RET
                                
       F3D0                     NAME:
0022D7 F3D0 CD42F4          17      CALL    CHKWILDX
0022DA F3D3 D8              11      RET C
0022DB F3D4 110400          10      LD  DE,4
0022DE F3D7 19              11      ADD HL,DE
0022DF F3D8 22EDF3          16      LD  (NAMEP),HL
0022E2 F3DB 23               6      INC HL
0022E3 F3DC CD46F4          17      CALL    CHKWILD
0022E6 F3DF D8              11      RET C
                                
0022E7 F3E0 CD1DF1          17      CALL    SOPENX
0022EA F3E3 3E0F             7      LD  A,00FH
0022EC F3E5 D4C6F3          17      CALL    NC,CHKATT
0022EF F3E8 D8              11      RET C
                                
0022F0 F3E9 FDE5            15      PUSH    IY
0022F2 F3EB FD210000        14      LD  IY,0        ;自己書き換え
       F3ED                     NAMEP   EQU $-2
0022F6 F3EF CD1DF1          17      CALL    SOPENX
0022F9 F3F2 FDE3            23      EX  (SP),IY
0022FB F3F4 3F               4      CCF
0022FC F3F5 D44CF1          17      CALL    NC,SOPEN
0022FF F3F8 EB               4      EX  DE,HL
002300 F3F9 E1              10      POP HL
002301 F3FA D8              11      RET C
                                
       F3FB                     SETNAME:
002302 F3FB 01000B          10      LD  BC,11*256
002305 F3FE 23               6      INC HL
002306 F3FF 7E               7      LD  A,(HL)
002307 F400 FEE5             7      CP  0E5H
002309 F402 2004            12      JR  NZ,SNAME1
00230B F404 3E05             7      LD  A,5
00230D F406 180E            12      JR  SNAME3
       F408                     SNAME1:
00230F F408 7E               7      LD  A,(HL)
002310 F409 0C               4      INC C
002311 F40A 0D               4      DEC C
002312 F40B 2009            12      JR  NZ,SNAME3
002314 F40D CD27F3          17      CALL    CAP
002317 F410 FEA0             7      CP  0A0H
002319 F412 2002            12      JR  NZ,SNAME3
00231B F414 3E20             7      LD  A,020H
       F416                     SNAME3:
00231D F416 12               7      LD  (DE),A
00231E F417 7E               7      LD  A,(HL)
00231F F418 23               6      INC HL
002320 F419 CD2FF4          17      CALL    FKAN
002323 F41C 10EA            13      DJNZ    SNAME1
       F41E                     WTDB:               ;バッファデータが更新された
002325 F41E 3EFF             7      LD  A,0FFH
002327 F420 3239EE          13      LD  (SFILE),A
00232A F423 32A4EE          13      LD  (_WTDBF),A
00232D F426 AF               4      XOR A
00232E F427 C9              10      RET
                                
       F428                     FKANC:
00232F F428 CB41             8      BIT 0,C
002331 F42A CC30F3          17      CALL    Z,CAP2
002334 F42D 1801            12      JR  FKANX
       F42F                     FKAN:           ;漢字チェック
002336 F42F 13               6      INC DE
       F430                     FKANX:
002337 F430 CB41             8      BIT 0,C
002339 F432 CB81             8      RES 0,C
00233B F434 C0              11      RET NZ
00233C F435 FE80             7      CP  080H
00233E F437 D8              11      RET C
00233F F438 FEA0             7      CP  0A0H
002341 F43A 3803            12      JR  C,FKAN1
002343 F43C FEE0             7      CP  0E0H
002345 F43E D8              11      RET C
       F43F                     FKAN1:
002346 F43F 0C               4      INC C
002347 F440 A7               4      AND A
002348 F441 C9              10      RET
                                
       F442                     CHKWILDX:
002349 F442 FDE5            15      PUSH    IY
00234B F444 E1              10      POP HL
00234C F445 23               6      INC HL
       F446                     CHKWILD:
00234D F446 060B             7      LD  B,11
00234F F448 3E3F             7      LD  A,'?'
       F44A                     CHKWIL1:
002351 F44A BE               7      CP  (HL)
002352 F44B 23               6      INC HL
002353 F44C 37               4      SCF
002354 F44D C8              11      RET Z
002355 F44E 10FA            13      DJNZ    CHKWIL1
002357 F450 AF               4      XOR A
002358 F451 C9              10      RET
                                
       F452                     SDIRENT:        ;IY=FCB HL=DIR
002359 F452 D5              11      PUSH    DE
00235A F453 E5              11      PUSH    HL
00235B F454 FDE5            15      PUSH    IY
00235D F456 D1              10      POP DE
00235E F457 EB               4      EX  DE,HL
00235F F458 CDFBF3          17      CALL    SETNAME
                                ;               Attribute
002362 F45B FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
002365 F45E 12               7      LD  (DE),A
002366 F45F 13               6      INC DE
                                ;               Reserved
002367 F460 AF               4      XOR A
002368 F461 060A             7      LD  B,10
       F463                     SDE1:
00236A F463 12               7      LD  (DE),A
00236B F464 13               6      INC DE
00236C F465 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
00236E F467 21E4EF          10      LD  HL,SDDATA       ;(FCB)更新年月日
002371 F46A 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       F46C                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
002373 F46C 7E               7      LD  A,(HL)
002374 F46D 23               6      INC HL
002375 F46E 3273F4          13      LD  (SDPAT),A
002378 F471 FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       F473                     SDPAT   EQU $-1
00237B F474 12               7      LD  (DE),A
00237C F475 13               6      INC DE
00237D F476 10F4            13      DJNZ    SDLOOP
                                
00237F F478 AF               4      XOR A
002380 F479 E1              10      POP HL
002381 F47A D1              10      POP DE
002382 F47B C9              10      RET
                                
       F47C                     WOPEN:
002383 F47C FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
002386 F47F E61F             7      AND 01FH
002388 F481 37               4      SCF
002389 F482 C0              11      RET NZ
00238A F483 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       F487                     TOPEN2:
00238E F487 AF               4      XOR A
       F488                     TOPEN:              ;Initializes the time stamp
00238F F488 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
002393 F48C C9              10      RET
                                
       F48D                     WRDFX:
002394 F48D 3AFFF2          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       F490                     L_WRFX:
002397 F490 1F               4      RRA         ;->CF
002398 F491 3806            12      JR  C,E_WRFX
00239A F493 CB39             8      SRL C
00239C F495 CB1C             8      RR  H       ;CH=CH/2
00239E F497 18F7            12      JR  L_WRFX
       F499                     E_WRFX:
0023A0 F499 41               4      LD  B,C
0023A1 F49A 4C               4      LD  C,H
0023A2 F49B 03               6      INC BC
0023A3 F49C 3E37             7      LD  A,037H      ;SCF
0023A5 F49E 3264E6          13      LD  (DRDN1),A
                                
       F4A1                     WRDF:               ;BCクラスタ分FATを確保する
0023A8 F4A1 110200          10      LD  DE,2
0023AB F4A4 AF               4      XOR A
0023AC F4A5 32DEE7          13      LD  (_SECPS),A
       F4A8                     WRDF1:
0023AF F4A8 C5              11      PUSH    BC
0023B0 F4A9 D5              11      PUSH    DE
0023B1 F4AA CDF7EE          17      CALL    _GNCL
0023B4 F4AD 381C            12      JR  C,WRDF3
0023B6 F4AF 7A               4      LD  A,D     ;空いているかチェック
0023B7 F4B0 B3               4      OR  E
0023B8 F4B1 202A            12      JR  NZ,WRDF4
0023BA F4B3 E1              10      POP HL      ;HL=空いているクラスタ
0023BB F4B4 E5              11      PUSH    HL
0023BC F4B5 ED5BFEEF        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
0023C0 F4B9 22FEEF          16      LD  (_CLPS),HL
0023C3 F4BC 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
0023C4 F4BD B3               4      OR  E
0023C5 F4BE 2008            12      JR  NZ,WRDF2
0023C7 F4C0 FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
0023CA F4C3 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
0023CD F4C6 1803            12      JR  WRDF3
       F4C8                     WRDF2:
0023CF F4C8 CDFAEE          17      CALL    _SNCL
       F4CB                     WRDF3:
0023D2 F4CB D1              10      POP DE
0023D3 F4CC C1              10      POP BC
0023D4 F4CD D8              11      RET C
0023D5 F4CE 0B               6      DEC BC
0023D6 F4CF 78               4      LD  A,B
0023D7 F4D0 B1               4      OR  C
0023D8 F4D1 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
0023DA F4D3 ED5BFEEF        20      LD  DE,(_CLPS)
0023DE F4D7 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
0023E1 F4DA C3FAEE          10      JP  _SNCL
                                
       F4DD                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
0023E4 F4DD D1              10      POP DE
0023E5 F4DE C1              10      POP BC
       F4DF                     WRDF5:
0023E6 F4DF 13               6      INC DE
0023E7 F4E0 CD18F3          17      CALL    ENDCL
0023EA F4E3 38C3            12      JR  C,WRDF1
0023EC F4E5 37               4      SCF
0023ED F4E6 C9              10      RET
                                
       F4E7                     RWXR:
0023EE F4E7 3A53E5          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       F4EA                     L_RWX:
0023F1 F4EA 1F               4      RRA     ;->CF
0023F2 F4EB 3808            12      JR  C,E_RWX
0023F4 F4ED CB38             8      SRL B   ;BCH=BCH/2
0023F6 F4EF CB19             8      RR  C   ;
0023F8 F4F1 CB1C             8      RR  H   ;
0023FA F4F3 18F5            12      JR  L_RWX
       F4F5                     E_RWX:
0023FC F4F5 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0023FF F4F8 FD561B          19      LD  D,(IY+27)
002402 F4FB AF               4      XOR A
002403 F4FC 32DEE7          13      LD  (_SECPS),A
       F4FF                     RWX1:
002406 F4FF ED53FEEF        20      LD  (_CLPS),DE
00240A F503 7A               4      LD  A,D
00240B F504 B3               4      OR  E
00240C F505 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
00240E F507 78               4      LD  A,B
00240F F508 B1               4      OR  C
002410 F509 B4               4      OR  H
002411 F50A C8              11      RET Z       ;RET BCH==0 => CF=0
                                
002412 F50B CDE6E7          17      CALL    GNCLX
002415 F50E D8              11      RET C
002416 F50F 7C               4      LD  A,H     ;
002417 F510 25               4      DEC H       ;
002418 F511 B7               4      OR  A       ;DEC BCH
002419 F512 2001            12      JR  NZ,RWX2     ;
00241B F514 0B               6      DEC BC      ;
       F515                     RWX2:
00241C F515 CD18F3          17      CALL    ENDCL
00241F F518 38E5            12      JR  C,RWX1
       F51A                     SCF_RET:
002421 F51A 37               4      SCF
002422 F51B C9              10      RET
                                
       F51C                     DSKF:
002423 F51C 110000          10      LD  DE,0
       F51D                     MAXCLP  EQU $-2
002426 F51F 2AACEE          16      LD  HL,(_FAKEFREE)
002429 F522 7C               4      LD  A,H
00242A F523 B5               4      OR  L
00242B F524 2803            12      JR  Z,DSKF1
00242D F526 110100          10      LD  DE,1
       F529                     DSKF1:
002430 F529 D5              11      PUSH    DE
002431 F52A CDF7EE          17      CALL    _GNCL
002434 F52D 380C            12      JR  C,POPSCF
002436 F52F 7A               4      LD  A,D
002437 F530 B3               4      OR  E
002438 F531 2001            12      JR  NZ,DSKF2
00243A F533 23               6      INC HL
       F534                     DSKF2:
00243B F534 D1              10      POP DE
00243C F535 1B               6      DEC DE
00243D F536 7A               4      LD  A,D
00243E F537 B3               4      OR  E
00243F F538 20EF            12      JR  NZ,DSKF1
002441 F53A C9              10      RET
                                
       F53B                     POPSCF:
002442 F53B F1              10      POP AF
002443 F53C 37               4      SCF
002444 F53D C9              10      RET
                                
       F53E                     SETTMS:
002445 F53E FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
002448 F541 3C               4      INC A
002449 F542 C0              11      RET NZ      ;ファイルが更新されていない
       F543                     SETTMSX:            ;FCBに日付時刻をセットする
00244A F543 CDC8E0          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
00244D F546 CB25             8      SLA L       ;   *2
00244F F548 CB25             8      SLA L       ;   *4
002451 F54A 29              11      ADD HL,HL       ;*2 *8
002452 F54B 29              11      ADD HL,HL       ;*4 *16
002453 F54C 29              11      ADD HL,HL       ;*8 *32
002454 F54D 7A               4      LD  A,D
002455 F54E 0F               4      RRCA            ;bit.0->7->->->0->C
002456 F54F E61F             7      AND 01FH
002458 F551 B5               4      OR  L
002459 F552 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
00245C F555 FD7417          19      LD  (IY+23),H
                                
00245F F558 CDA1E0          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
002462 F55B 0144F8          10      LD  BC,0-1980
002465 F55E 09              11      ADD HL,BC
002466 F55F 65               4      LD  H,L
                                
002467 F560 7A               4      LD  A,D
002468 F561 87               4      ADD A,A     ;*2
002469 F562 87               4      ADD A,A     ;*4
00246A F563 87               4      ADD A,A     ;*8
00246B F564 87               4      ADD A,A     ;*16
00246C F565 6F               4      LD  L,A
00246D F566 29              11      ADD HL,HL       ;*32
00246E F567 7D               4      LD  A,L
00246F F568 B3               4      OR  E
002470 F569 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
002473 F56C FD7415          19      LD  (IY+21),H
002476 F56F C9              10      RET
                                ;(16)
       F570                     PUSHRR:
002477 F570 3217E6          13      LD  (SETSEQ_SWC_RND),A
00247A F573 2229E6          16      LD  (SETSEQ_SWC_SEQ_RR),HL
00247D F576 CD96F5          17      CALL    GET_RR_AHL
002480 F579 220FEE          16      LD  (RR_BUF_HL),HL
002483 F57C 3211EE          13      LD  (RR_BUF_A),A
002486 F57F C9              10      RET
                                ;(14)
       F580                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
002487 F580 87               4      ADD A,A     ;in BHLA => out AHL
002488 F581 ED6A            15      ADC HL,HL
00248A F583 CB18             8      RR  B
00248C F585 B7               4      OR  A
00248D F586 78               4      LD  A,B     ;ここでフラグは変化しない
00248E F587 C8              11      RET Z
00248F F588 2C               4      INC L       ;INC AHL
002490 F589 C0              11      RET NZ      ;
002491 F58A 24               4      INC H       ;
002492 F58B C0              11      RET NZ      ;
002493 F58C 3C               4      INC A       ;
002494 F58D C9              10      RET
                                ;(18)
       F58E                     INIT_RND:
002495 F58E 3ECD             7      LD  A,0CDH      ;CALL ????
002497 F590 21ADF5          10      LD  HL,POPRR
00249A F593 CD70F5          17      CALL    PUSHRR
       F596                     GET_RR_AHL:
00249D F596 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0024A0 F599 FD6622          19      LD  H,(IY+34)   ;
0024A3 F59C FD7E23          19      LD  A,(IY+35)   ;
0024A6 F59F C9              10      RET
                                ;(10)
       F5A0                     SET_RR_AHL:
0024A7 F5A0 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0024AA F5A3 FD7422          19      LD  (IY+34),H   ;
0024AD F5A6 FD7723          19      LD  (IY+35),A   ;
0024B0 F5A9 C9              10      RET
                                ;(17)
       F5AA                     SETSEQ:
0024B1 F5AA CDCFF5          17      CALL    SETSEQ1
       F5AD                     POPRR:
0024B4 F5AD F5              11      PUSH    AF
0024B5 F5AE E5              11      PUSH    HL
0024B6 F5AF 2A0FEE          16      LD  HL,(RR_BUF_HL)
0024B9 F5B2 3A11EE          13      LD  A,(RR_BUF_A)
0024BC F5B5 CDA0F5          17      CALL    SET_RR_AHL
0024BF F5B8 E1              10      POP HL
0024C0 F5B9 F1              10      POP AF
0024C1 F5BA C9              10      RET
                                ;(20)
       F5BB                     GET_RR_BCDE:            ;BCDE=Random record
0024C2 F5BB FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
0024C5 F5BE FD5622          19      LD  D,(IY+34)
0024C8 F5C1 FD4E23          19      LD  C,(IY+35)
0024CB F5C4 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
0024CD F5C6 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0024D1 F5CA C0              11      RET NZ
0024D2 F5CB FD4624          19      LD  B,(IY+36)
0024D5 F5CE C9              10      RET
                                
       F5CF                     SETSEQ1:
0024D6 F5CF F5              11      PUSH    AF
0024D7 F5D0 E5              11      PUSH    HL      ;AHL=Random record
0024D8 F5D1 CD96F5          17      CALL    GET_RR_AHL
0024DB F5D4 47               4      LD  B,A     ;AHL→HLA
0024DC F5D5 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
0024DD F5D6 6C               4      LD  L,H     ;(IY+34)
0024DE F5D7 60               4      LD  H,B     ;(IY+35)
0024DF F5D8 0600             7      LD  B,0
                                
0024E1 F5DA CD80F5          17      CALL    GET_CPM_R_SIZE
                                
0024E4 F5DD 29              11      ADD HL,HL
0024E5 F5DE CB3D             8      SRL L       ;L=L/2
0024E7 F5E0 FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
0024EA F5E3 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
0024ED F5E6 E1              10      POP HL
0024EE F5E7 F1              10      POP AF
0024EF F5E8 C9              10      RET
                                
                                ;(23)
       F5E9                     RBXEND:             ;レコード数だけランダムレコードを進める
0024F0 F5E9 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       F5EA                     RBSIZE  EQU $-2
0024F3 F5EC CD96F5          17      CALL    GET_RR_AHL
0024F6 F5EF 19              11      ADD HL,DE
0024F7 F5F0 CE00             7      ADC A,0
0024F9 F5F2 CDA0F5          17      CALL    SET_RR_AHL
0024FC F5F5 EB               4      EX  DE,HL       ;HL=進めるレコード数
0024FD F5F6 D0              11      RET NC
0024FE F5F7 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
002502 F5FB C0              11      RET NZ
002503 F5FC FD3424          23      INC (IY+36)
002506 F5FF C9              10      RET
       F600                     FILE_E:
                                
       F1AA                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       F1AA                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       F1AA                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       F1AA                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       F1AA                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "88DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   PC-8801mkIISR
                                
       F600                     _DEVICE:
                                
                                ;   A:
                                
002507 F600 0200                    DW  2   ;DPB_FATLN
002509 F602 EBEE                    DW  _FDRD   ;DPB_DRD
00250B F604 EEEE                    DW  _FDWT   ;DPB_DWT
00250D F606 FD                      DB  0FDH    ;DPB_FATID
00250E F607 02                      DB  2   ;DPB_SECPCL
00250F F608 6401                    DW  356 ;DPB_MAXCL
002511 F60A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002512 F60B 07                      DB  7   ;DPB_DIRSCNT
002513 F60C 28                      DB  40  ;DPB_MAXCYL
002514 F60D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002515 F60E 01                      DB  1   ;DPB_FATPS
002516 F60F 82                      DB  082H    ;DPB_BPS
002517 F610 0500                    DW  5   ;DPB_DIRPS
002519 F612 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00251A F613 00                      DB  0   ;DPB_UNITNO
00251B F614 0800                    DW  8   ;DPB_ADDCL
00251D F616 0000                    DW  0   ;DPB_16
00251F F618 0000                    DW  0   ;DPB_18
002521 F61A 0000                    DW  0   ;DPB_SDIR
002523 F61C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002527 F620 0200                    DW  2   ;DPB_FATLN
002529 F622 EBEE                    DW  _FDRD   ;DPB_DRD
00252B F624 EEEE                    DW  _FDWT   ;DPB_DWT
00252D F626 FD                      DB  0FDH    ;DPB_FATID
00252E F627 02                      DB  2   ;DPB_SECPCL
00252F F628 6401                    DW  356 ;DPB_MAXCL
002531 F62A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002532 F62B 07                      DB  7   ;DPB_DIRSCNT
002533 F62C 28                      DB  40  ;DPB_MAXCYL
002534 F62D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002535 F62E 01                      DB  1   ;DPB_FATPS
002536 F62F 82                      DB  082H    ;DPB_BPS
002537 F630 0500                    DW  5   ;DPB_DIRPS
002539 F632 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00253A F633 01                      DB  1   ;DPB_UNITNO
00253B F634 0800                    DW  8   ;DPB_ADDCL
00253D F636 0000                    DW  0   ;DPB_16
00253F F638 0000                    DW  0   ;DPB_18
002541 F63A 0000                    DW  0   ;DPB_SDIR
002543 F63C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002547 F640                         DS  32
                                
                                ;   D:
                                
002567 F660                         DS  32
                                
                                ;   E:
                                
002587 F680                         DS  32
                                
                                ;   F:
                                
0025A7 F6A0 0000                BANKFL: DW  0   ;DPB_FATLN
0025A9 F6A2 5FDD                    DW  BDRD    ;DPB_DRD
0025AB F6A4 5BDD                    DW  BDWT    ;DPB_DWT
0025AD F6A6 F9                      DB  0F9H    ;DPB_FATID
0025AE F6A7 02                      DB  2   ;DPB_SECPCL
0025AF F6A8 0000                BANKCL: DW  0   ;DPB_MAXCL
0025B1 F6AA 00                      DB  0   ;DPB_FDMODE
0025B2 F6AB 08                      DB  8   ;DPB_DIRSCNT
0025B3 F6AC 00                      DB  0   ;DPB_MAXCYL
0025B4 F6AD 01                      DB  1   ;DPB_MAXSEC
0025B5 F6AE 00                      DB  0   ;DPB_FATPS
0025B6 F6AF 02                      DB  2   ;DPB_BPS
0025B7 F6B0 0200                    DW  2   ;DPB_DIRPS
0025B9 F6B2 0B                  BANKDV: DB  00BH    ;DPB_DEVICE
0025BA F6B3 00                      DB  0   ;DPB_UNITNO
0025BB F6B4 0600                    DW  6   ;DPB_ADDCL
0025BD F6B6 0000                    DW  0   ;DPB_16
0025BF F6B8 0000                    DW  0   ;DPB_18
0025C1 F6BA 0000                    DW  0   ;DPB_SDIR
0025C3 F6BC 454D454D                DB  "EMEM"  ;DPB_NAME
                                
                                ;   G:
                                
0025C7 F6C0                         DS  32
                                
                                ;   H:
0025E7 F6E0                         DS  32-8
0025FF F6F8 00                      DB  0
[EOF:88DPB.ASM:UTF_8]
                                
       F6F9                     LAST_ADR:
                                
                                    END
[EOF:88.ASM:UTF_8]
