                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   LSX-Dodgers for PC-8801mkIISR
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "88DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   PC-8001mkIISR
                                
       0002                     MAC EQU 2   ;PC-8001mkIISR
       0001                     DEV EQU 1
                                
       011D                     VER_6F  EQU 0011DH
                                
       D100                     RUN EQU 0D100H
       D0F9                     OFFSET  EQU RUN-7
                                
       D906                     BDOS    EQU 0D906H
       ED00                     INTAD   EQU 0ED00H
       EE00                     WORKAD  EQU 0EE00H
       F600                     DEVD    EQU 0F600H
       F700                     FATBF   EQU 0F700H
       FD00                     DTBUF   EQU 0FD00H
       FF00                     KEYBF   EQU 0FF00H
       FF20                     KBUF    EQU 0FF20H
       FFBB                     SUBSYS  EQU EXTBIO-5*3
       FFD9                     TRAP38  EQU 0FFD9H
       0050                     WIDTH   EQU 80
       0018                     LINE    EQU 24
       0000                     COLORF  EQU 0
       0010                     KEYSP_H EQU 16
       0000                     KEYSP_L EQU 0
       0008                     COMS    EQU 8
       0002                     MAX_SEC_SZ_H    EQU 2       ;1セクタ1024バイトのサポート(2:off 4:on)
                                
                                ; ディスクサブシステム
       002A                     MAIN        EQU 0002AH
                                
       4000                     DSS_DATA    EQU 04000H
                                
       7C00                     DSS     EQU 07C00H
[EOF:88DEF.ASM:SHIFT_JIS]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0001                     VER_3   EQU 1
       1D02                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0102                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0161                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 D0F9                         ORG OFFSET
                                
                                ;   MSX BINARY HEADER
000000 D0F9 FE                      DB  0FEH
                                ;   MSX BINARY START ADDRESS
000001 D0FA 00D1                    DW  RUN
                                ;   MSX BINARY END ADDRESS
000003 D0FC F9F6                    DW  LAST_ADR
                                ;   MSX BINARY EXEC ADDRESS
000005 D0FE 07D1                    DW  START
                                
                                    INCLUDE "88INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   PC-8801mkIISR
                                
000007 D100 C307D1          10      JP  START
00000A D103 021D                    DW  MACW
00000C D105 6101                    DW  VER
                                
       D107                     START:
00000E D107 F3               4      DI
00000F D108 ED5E             8      IM  2
000011 D10A 3107D1          10      LD  SP,START
000014 D10D CD1BD1          17      CALL    INIT        ;NZならAUTOEXECを実行
000017 D110 210000          10      LD  HL,0
00001A D113 E5              11      PUSH    HL
00001B D114 C8              11      RET Z
00001C D115 11ACD2          10      LD  DE,AUTOD
00001F D118 C3FDEE          10      JP  _COMANL
                                
       D11B                     INIT:
000022 D11B DB32            11      IN  A,(032H)
000024 D11D E6EF             7      AND 0EFH        ;高速RAMアクセスモード/高速RAM
000026 D11F D332            11      OUT (032H),A
                                
000028 D121 21C8F3          10      LD  HL,0F3C8H   ;テキストをクリア
00002B D124 11E880          10      LD  DE,080E8H
00002E D127 0E20             7      LD  C,' '
000030 D129 3E19             7      LD  A,25
       D12B                     TVCL1:
000032 D12B 0650             7      LD  B,80
       D12D                     TVCL2:
000034 D12D 71               7      LD  (HL),C
000035 D12E 23               6      INC HL
000036 D12F 10FC            13      DJNZ    TVCL2
000038 D131 0614             7      LD  B,20
       D133                     TVCL3:
00003A D133 72               7      LD  (HL),D
00003B D134 2C               4      INC L
00003C D135 73               7      LD  (HL),E
00003D D136 23               6      INC HL
00003E D137 10FA            13      DJNZ    TVCL3
000040 D139 3D               4      DEC A
000041 D13A 20EF            12      JR  NZ,TVCL1
                                
000043 D13C 2129D3          10      LD  HL,AT_VRAM
000046 D13F 1100F0          10      LD  DE,0F000H
000049 D142 01F702          10      LD  BC,AT_VRAME-AT_VRAM
00004C D145 EDB0                    LDIR
                                
00004E D147 DB32            11      IN  A,(032H)
000050 D149 F610             7      OR  010H        ;高速RAMアクセスモード/メインRAM
000052 D14B D332            11      OUT (032H),A
       D14D                     INIT_CRTC:
000054 D14D 3E03             7      LD  A,3     ;80桁
000056 D14F D330            11      OUT (030H),A
000058 D151 32BEEE          13      LD  (WK30),A
                                
00005B D154 3E22             7      LD  A,022H      ;25行 64K RAM
00005D D156 D331            11      OUT (031H),A
00005F D158 32BFEE          13      LD  (WK31),A
                                
000062 D15B 3EFF             7      LD  A,0FFH
000064 D15D D3E4            11      OUT (0E4H),A    ;割り込みレベル設定
000066 D15F 32B7EE          13      LD  (WKE4),A
000069 D162 3E00             7      LD  A,0
00006B D164 D3E6            11      OUT (0E6H),A    ;割り込みマスク
                                
00006D D166 3E19             7      LD  A,019H
00006F D168 D340            11      OUT (040H),A    ;CRT I/F 同期ビットオン
000071 D16A 32B9EE          13      LD  (WK40),A
000074 D16D CD79E2          17      CALL    VBLANK
                                
000077 D170 AF               4      XOR A
000078 D171 D351            11      OUT (051H),A    ;Reset CRTC
00007A D173 3EA0             7      LD  A,0A0H
00007C D175 D368            11      OUT (068H),A    ;DMAC: Mode Set(Reset)
00007E D177 21C8F3          10      LD  HL,0F3C8H
000081 D17A 22B2EE          16      LD  (TVRAMTOP),HL
000084 D17D 0E64             7      LD  C,064H
000086 D17F ED69            12      OUT (C),L       ;TVRAM LOW
000088 D181 ED61            12      OUT (C),H       ;TVRAM HIGH
00008A D183 21B78B          10      LD  HL,08000H+120*25-1
00008D D186 0C               4      INC C       ;65H
00008E D187 ED69            12      OUT (C),L
000090 D189 ED61            12      OUT (C),H
000092 D18B 3ECE             7      LD  A,080H+80-2
000094 D18D D350            11      OUT (050H),A
000096 D18F 3E98             7      LD  A,080H+25-1
000098 D191 D350            11      OUT (050H),A
00009A D193 DB40            11      IN  A,(040H)
00009C D195 CB4F             8      BIT 1,A
00009E D197 21DE67          10      LD  HL,067DEH
0000A1 D19A 2003            12      JR  NZ,RESO1
0000A3 D19C 21586F          10      LD  HL,06F58H
       D19F                     RESO1:
0000A6 D19F 0E50             7      LD  C,050H
0000A8 D1A1 ED61            12      OUT (C),H
0000AA D1A3 ED69            12      OUT (C),L
                                
0000AC D1A5 3E53             7      LD  A,053H
0000AE D1A7 D350            11      OUT (050H),A
                                
0000B0 D1A9 3E43             7      LD  A,043H
0000B2 D1AB D351            11      OUT (051H),A
                                
0000B4 D1AD 3EE4             7      LD  A,0E4H
0000B6 D1AF D368            11      OUT (068H),A
                                
0000B8 D1B1 3E20             7      LD  A,020H
0000BA D1B3 D351            11      OUT (051H),A
                                
0000BC D1B5 CD79E2          17      CALL    VBLANK
       D1B8                     IVBL1:
0000BF D1B8 DB40            11      IN  A,(040H)
0000C1 D1BA CB6F             8      BIT 5,A
0000C3 D1BC 20FA            12      JR  NZ,IVBL1
                                
0000C5 D1BE 3E11             7      LD  A,011H
0000C7 D1C0 D340            11      OUT (040H),A    ;CRT I/F 同期ビットオフ
0000C9 D1C2 32B9EE          13      LD  (WK40),A
       D1C5                     BANK:
0000CC D1C5 01E300          10      LD  BC,000E3H   ;拡張RAM バンク選択
0000CF D1C8 21007F          10      LD  HL,07F00H
0000D2 D1CB 56               7      LD  D,(HL)
0000D3 D1CC F3               4      DI
0000D4 D1CD 3E01             7      LD  A,1     ;リード可
0000D6 D1CF D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
0000D8 D1D1 ED41            12      OUT (C),B       ;拡張RAM バンク選択
0000DA D1D3 3A0000          13      LD  A,(0)
0000DD D1D6 FEEB             7      CP  0EBH
0000DF D1D8 2005            12      JR  NZ,BANK1
0000E1 D1DA 3E2B             7      LD  A,02BH
0000E3 D1DC 32B2F6          13      LD  (BANKDV),A
       D1DF                     BANK1:
0000E6 D1DF 3E01             7      LD  A,1     ;リード可
0000E8 D1E1 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
0000EA D1E3 ED41            12      OUT (C),B       ;拡張RAM バンク選択
0000EC D1E5 5E               7      LD  E,(HL)
0000ED D1E6 7B               4      LD  A,E
0000EE D1E7 C6A5             7      ADD A,0A5H
0000F0 D1E9 77               7      LD  (HL),A      ;メインメモリに書き込む
0000F1 D1EA BE               7      CP  (HL)
0000F2 D1EB 2811            12      JR  Z,BANK2     ;メインメモリが反映されているか？
0000F4 D1ED 3E11             7      LD  A,011H      ;ライト/リード可
0000F6 D1EF D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
0000F8 D1F1 7B               4      LD  A,E
0000F9 D1F2 C6A5             7      ADD A,0A5H
0000FB D1F4 77               7      LD  (HL),A
0000FC D1F5 BE               7      CP  (HL)
0000FD D1F6 73               7      LD  (HL),E      ;拡張RAM に元の値を戻す
0000FE D1F7 2005            12      JR  NZ,BANK2    ;拡張RAM に反映しているか？
000100 D1F9 04               4      INC B
000101 D1FA CB60             8      BIT 4,B
000103 D1FC 28E1            12      JR  Z,BANK1
       D1FE                     BANK2:
000105 D1FE AF               4      XOR A       ;ライト/リード不可
000106 D1FF D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000108 D201 72               7      LD  (HL),D      ;メインメモリ に元の値を戻す
000109 D202 78               4      LD  A,B
00010A D203 B7               4      OR  A
00010B D204 2814            12      JR  Z,NOBANK
00010D D206 68               4      LD  L,B
00010E D207 2600             7      LD  H,0
000110 D209 29              11      ADD HL,HL   ;*2
000111 D20A 29              11      ADD HL,HL   ;*4
000112 D20B 29              11      ADD HL,HL   ;*8
000113 D20C 29              11      ADD HL,HL   ;*16
000114 D20D 29              11      ADD HL,HL   ;*32
000115 D20E 2B               6      DEC HL  ;-1
000116 D20F 2B               6      DEC HL  ;-2
000117 D210 2B               6      DEC HL  ;-3
000118 D211 22A8F6          16      LD  (BANKCL),HL
00011B D214 CD9CD2          17      CALL    CALC_FATLN
00011E D217 32A0F6          13      LD  (BANKFL),A
       D21A                     NOBANK:
                                                ;初期化
000121 D21A AF               4      XOR A       ;イニシャライズ
000122 D21B CDC2EA          17      CALL    PUTCOM
000125 D21E 3E16             7      LD  A,16H       ;高速レシーブメモリ
000127 D220 CDC2EA          17      CALL    PUTCOM
00012A D223 3E7C             7      LD  A,DSS/256   ;開始アドレスH
00012C D225 CDC8EA          17      CALL    PUTDAT
00012F D228 AF               4      XOR A       ;開始アドレスL
000130 D229 CDC8EA          17      CALL    PUTDAT
000133 D22C 015102          10      LD  BC,AT_DSSE-AT_DSS
000136 D22F CB41             8      BIT 0,C
000138 D231 2801            12      JR  Z,SUBPG1
00013A D233 03               6      INC BC      ;偶数にする
       D234                     SUBPG1:
00013B D234 78               4      LD  A,B     ;バイト数H
00013C D235 CDC8EA          17      CALL    PUTDAT
00013F D238 79               4      LD  A,C
000140 D239 CDC8EA          17      CALL    PUTDAT
000143 D23C 2120D6          10      LD  HL,AT_DSS
000146 D23F CD0CEB          17      CALL    FPUTDAT
                                
000149 D242 210000          10      LD  HL,0
00014C D245 065C             7      LD  B,05CH
00014E D247 3E                      DB  03EH    ;LD A,??
00014F D248 FF              12      RST 38H
000150 D249 CDB7F0          17      CALL    FILL_MEMORY
000153 D24C 06A4             7      LD  B,0A4H
000155 D24E AF               4      XOR A
000156 D24F 320400          13      LD  (_DVSW),A
000159 D252 CDB7F0          17      CALL    FILL_MEMORY
                                
00015C D255 3EC3             7      LD  A,0C3H      ;JP
00015E D257 2103EE          10      LD  HL,CPM_WBOOT
000161 D25A 320000          13      LD  (00000H),A
000164 D25D 220100          16      LD  (00001H),HL ;IPL
                                
000167 D260 2106D9          10      LD  HL,BDOS
00016A D263 320500          13      LD  (00005H),A
00016D D266 220600          16      LD  (00006H),HL ;BDOS
                                
000170 D269 21D9FF          10      LD  HL,TRAP38   ;TRAP38
000173 D26C 323800          13      LD  (00038H),A
000176 D26F 223900          16      LD  (00039H),HL ;RST 038H
                                
000179 D272 3EEE             7      LD  A,CPM_BOOT/256
00017B D274 320B00          13      LD  (0000BH),A
                                
00017E D277 3E                      DB  03EH    ;LD A,??
00017F D278 E9               4      JP  (HL)
000180 D279 320F00          13      LD  (0000FH),A
                                
000183 D27C 21B8D2          10      LD  HL,INIMES
000186 D27F CDE3DD          17      CALL    MSX
       D282                     INIT1:
000189 D282 F3               4      DI
00018A D283 1100FF          10      LD  DE,0FF00H
00018D D286 06BB             7      LD  B,SUBSYS%256
00018F D288 CD43DC          17      CALL    ZERO_MEMORY_DE
                                
000192 D28B 21E4D2          10      LD  HL,AT_SUBSYS
000195 D28E 11BBFF          10      LD  DE,SUBSYS
000198 D291 014500          10      LD  BC,AT_TRAPE-AT_SUBSYS
00019B D294 EDB0                    LDIR
                                
00019D D296 CD1AE2          17      CALL    CHKEY
0001A0 D299 FE03             7      CP  3
0001A2 D29B C9              10      RET
                                
       D29C                     CALC_FATLN: ;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
0001A3 D29C 5D               4      LD  E,L
0001A4 D29D 54               4      LD  D,H
0001A5 D29E 29              11      ADD HL,HL   ;*2
0001A6 D29F 19              11      ADD HL,DE   ;*3
0001A7 D2A0 CB3C             8      SRL H   ;/2
0001A9 D2A2 CB1D             8      RR  L   ;1クラスタ辺り1.5バイト必要
0001AB D2A4 11FF01          10      LD  DE,511  ;切り上げる
0001AE D2A7 19              11      ADD HL,DE
0001AF D2A8 7C               4      LD  A,H
0001B0 D2A9 CB3F             8      SRL A
0001B2 D2AB C9              10      RET
                                
0001B3 D2AC 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
0001BC D2B5 413A00              AUTODV: DB  "A:",0
                                
0001BF D2B8 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for PC-8801mkIISR v"
            6765727320666F72    
            2050432D38383031    
            6D6B494953522076    
0001DF D2D8 312E                    DB  030H + VER_1, '.'
0001E1 D2DA 3631                    DB  030H + VER_2 ,030H + VER_3
0001E3 D2DC                         DB  ''
0001E3 D2DC 2047616B750D0A          DB  " Gaku",0DH,0AH
0001EA D2E3 00                      DB  0
                                
       D2E4                     AT_SUBSYS:
0001EB FFBB                         ORG SUBSYS,AT_SUBSYS-OFFSET
0001EB FFBB C3C2EA          10      JP  PUTCOM
0001EE FFBE C3C8EA          10      JP  PUTDAT
0001F1 FFC1 C3EDEA          10      JP  GETDAT
0001F4 FFC4 C30CEB          10      JP  FPUTDAT
0001F7 FFC7 C337EB          10      JP  FGETDAT
                                ;EXTBIO
0001FA FFCA C9              10      RET
0001FB FFCB                         DS  14,0FFH
                                ;TRAP38:
000209 FFD9 210000          10      LD  HL,0
00020C FFDC E3              19      EX  (SP),HL
00020D FFDD 3E24             7      LD  A,'$'
00020F FFDF CDF3E2          17      CALL    MSG_A
000212 FFE2 2B               6      DEC HL
000213 FFE3 7C               4      LD  A,H
000214 FFE4 CDE8FF          17      CALL    PRHX
000217 FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
000218 FFE8 F5              11      PUSH    AF
000219 FFE9 07               4      RLCA
00021A FFEA 07               4      RLCA
00021B FFEB 07               4      RLCA
00021C FFEC 07               4      RLCA
00021D FFED CDF1FF          17      CALL    PRHX2
000220 FFF0 F1              10      POP AF
       FFF1                     PRHX2:
000221 FFF1 E60F             7      AND 00FH
000223 FFF3 FE0A             7      CP  10
000225 FFF5 3F               4      CCF
000226 FFF6 CE30             7      ADC A,'0'
000228 FFF8 27               4      DAA
000229 FFF9 C3F3E2          10      JP  MSG_A
00022C FFFC                         DS  4
000230 D329                         ORG $$+OFFSET   ;$DEPHASE
       D329                     AT_TRAPE:
[EOF:88INIT.ASM:SHIFT_JIS]
                                    INCLUDE "88VRAM.ASM"
                                
                                ;   LSX-Dodgers VRAM
                                ;   PC-8801mkIISR
                                
       D329                     AT_VRAM:
000230 F000                         ORG 0F000H,AT_VRAM-OFFSET
       F000                     ESC1:
000230 F000 7B               4      LD  A,E
000231 F001 FE41             7      CP  'A'
000233 F003 CAC3F0          10      JP  Z,CTRL1E
000236 F006 FE42             7      CP  'B'
000238 F008 CA77F1          10      JP  Z,CTRL1F
00023B F00B FE43             7      CP  'C'
00023D F00D CA89F0          10      JP  Z,CTRL1C
000240 F010 FE44             7      CP  'D'
000242 F012 CAAEF0          10      JP  Z,CTRL1D
000245 F015 FE45             7      CP  'E'
000247 F017 2802            12      JR  Z,CT0CX
000249 F019 FE6A             7      CP  'j'
       F01B                     CT0CX:
00024B F01B CA4EF1          10      JP  Z,CTRL0C
00024E F01E FE48             7      CP  'H'
000250 F020 CA1AF1          10      JP  Z,CTRL0B
000253 F023 FE4A             7      CP  'J'
000255 F025 CA51F1          10      JP  Z,CTRL06
000258 F028 FE4B             7      CP  'K'
00025A F02A CAF8F0          10      JP  Z,CTRL05
00025D F02D FE4C             7      CP  'L'
00025F F02F CA7EF1          10      JP  Z,CTRL0E
000262 F032 FE54             7      CP  'T'
000264 F034 CAF8F0          10      JP  Z,CTRL05
000267 F037 FE78             7      CP  'x'
000269 F039 2804            12      JR  Z,ESC1X
00026B F03B FE79             7      CP  'y'
00026D F03D 2002            12      JR  NZ,ESC1Y
       F03F                     ESC1X:
00026F F03F 3601            10      LD  (HL),1
       F041                     ESC1Y:
000271 F041 FE3D             7      CP  '='
000273 F043 2804            12      JR  Z,ESC1W
000275 F045 FE59             7      CP  'Y'
000277 F047 2002            12      JR  NZ,ESC1Z
       F049                     ESC1W:
000279 F049 3602            10      LD  (HL),2
       F04B                     ESC1Z:
00027B F04B FE20             7      CP  020H
00027D F04D 3802            12      JR  C,ESC1C
00027F F04F 87               4      ADD A,A
000280 F050 D0              11      RET NC
       F051                     ESC1C:
000281 F051 E1              10      POP HL
000282 F052 C357E1          10      JP  ANK
                                
       F055                     ESC:
000285 F055 215EE1          10      LD  HL,PRINTE5
000288 F058 E5              11      PUSH    HL
000289 F059 2149E1          10      LD  HL,ESCFLG
00028C F05C 3600            10      LD  (HL),0
00028E F05E 3D               4      DEC A
00028F F05F 289F            12      JR  Z,ESC1
000291 F061 3D               4      DEC A
000292 F062 2009            12      JR  NZ,ESC2
000294 F064 3603            10      LD  (HL),3
000296 F066 7B               4      LD  A,E
000297 F067 D620             7      SUB 020H
000299 F069 3270F0          13      LD  (ESCYP+1),A
00029C F06C C9              10      RET
       F06D                     ESC2:
00029D F06D 3D               4      DEC A
00029E F06E C0              11      RET NZ
00029F F06F 2600             7  ESCYP:  LD  H,0
0002A1 F071 7B               4      LD  A,E
0002A2 F072 D620             7      SUB 020H
0002A4 F074 6F               4      LD  L,A
0002A5 F075 C3D6EE          10      JP  _LOC
                                
       F078                     CTRL:
0002A8 F078 7B               4      LD  A,E
0002A9 F079 87               4      ADD A,A
0002AA F07A F680             7      OR  080H
0002AC F07C 6F               4      LD  L,A
0002AD F07D 26EF             7      LD  H,CTRLTB/256
0002AF F07F 7E               7      LD  A,(HL)
0002B0 F080 2C               4      INC L
0002B1 F081 66               7      LD  H,(HL)
0002B2 F082 6F               4      LD  L,A
0002B3 F083 CD0F00          17      CALL    JP_HL
0002B6 F086 C35EE1          10      JP  PRINTE5
                                
       F089                     CTRL1C:
0002B9 F089 2A8EEE          16      LD  HL,(_TXADR)
0002BC F08C 2C               4      INC L
       F08D                     PRINTE3:
0002BD F08D 3AB1EE          13      LD  A,(_WIDTH)
0002C0 F090 3D               4      DEC A
0002C1 F091 BD               4      CP  L
0002C2 F092 3009            12      JR  NC,SET_TXADR_HL
0002C4 F094 2E00             7      LD  L,0
0002C6 F096 24               4      INC H
       F097                     PRINTE8:
0002C7 F097 3A97EE          13      LD  A,(_LINE)
0002CA F09A BC               4      CP  H
0002CB F09B 2804            12      JR  Z,PRINT2
       F09D                     LOC:
       F09D                     SET_TXADR_HL:
0002CD F09D 228EEE          16      LD  (_TXADR),HL
       F0A0                     CTRL00:
0002D0 F0A0 C9              10      RET
                                
       F0A1                     PRINT2:
0002D1 F0A1 CD84F1          17      CALL    SCR
0002D4 F0A4 25               4      DEC H
0002D5 F0A5 18F6            12      JR  SET_TXADR_HL
                                
       F0A7                     CTRL08:
0002D7 F0A7 3A54E1          13      LD  A,(INSFLG)
0002DA F0AA FECD             7      CP  0CDH        ;CALL ????
0002DC F0AC 2829            12      JR  Z,CTRL02
       F0AE                     CTRL1D:
0002DE F0AE 2A8EEE          16      LD  HL,(_TXADR)
0002E1 F0B1 7C               4      LD  A,H
0002E2 F0B2 B5               4      OR  L
0002E3 F0B3 C8              11      RET Z
0002E4 F0B4 7D               4      LD  A,L
0002E5 F0B5 B7               4      OR  A
0002E6 F0B6 2803            12      JR  Z,CTRL1DX1
0002E8 F0B8 2D               4      DEC L
0002E9 F0B9 18E2            12      JR  SET_TXADR_HL
       F0BB                     CTRL1DX1:
0002EB F0BB 3AB1EE          13      LD  A,(_WIDTH)
0002EE F0BE 3D               4      DEC A
0002EF F0BF 6F               4      LD  L,A
0002F0 F0C0 25               4      DEC H
0002F1 F0C1 18DA            12      JR  SET_TXADR_HL
       F0C3                     CTRL1E:
0002F3 F0C3 2A8EEE          16      LD  HL,(_TXADR)
0002F6 F0C6 7C               4      LD  A,H
0002F7 F0C7 B7               4      OR  A
0002F8 F0C8 C8              11      RET Z
0002F9 F0C9 25               4      DEC H
0002FA F0CA 18D1            12      JR  SET_TXADR_HL
                                
       F0CC                     CTRL09:
0002FC F0CC 2A8EEE          16      LD  HL,(_TXADR)
0002FF F0CF 7D               4      LD  A,L
000300 F0D0 E6F8             7      AND 0F8H
000302 F0D2 C608             7      ADD A,8
000304 F0D4 6F               4      LD  L,A
000305 F0D5 18B6            12      JR  PRINTE3
                                
       F0D7                     CTRL02:
000307 F0D7 3A8EEE          13      LD  A,(_TXADR)
00030A F0DA B7               4      OR  A
00030B F0DB 28D1            12      JR  Z,CTRL1D
00030D F0DD CDAEF0          17      CALL    CTRL1D
000310 F0E0 2A8EEE          16      LD  HL,(_TXADR)
000313 F0E3 3AB1EE          13      LD  A,(_WIDTH)
000316 F0E6 4F               4      LD  C,A
000317 F0E7 95               4      SUB L
000318 F0E8 47               4      LD  B,A
000319 F0E9 79               4      LD  A,C
00031A F0EA 3D               4      DEC A
00031B F0EB 6F               4      LD  L,A
00031C F0EC CD68E1          17      CALL    LOC1
                                
00031F F0EF 3E20             7      LD  A,020H
       F0F1                     C8X1:
000321 F0F1 4E               7      LD  C,(HL)
000322 F0F2 77               7      LD  (HL),A
000323 F0F3 2B               6      DEC HL
000324 F0F4 79               4      LD  A,C
000325 F0F5 10FA            13      DJNZ    C8X1
000327 F0F7 C9              10      RET
                                
       F0F8                     CTRL05:
000328 F0F8 CDD3EE          17      CALL    _POS
00032B F0FB 2A8EEE          16      LD  HL,(_TXADR)
00032E F0FE 3AB1EE          13      LD  A,(_WIDTH)
000331 F101 95               4      SUB L
000332 F102 47               4      LD  B,A
000333 F103 CD65E1          17      CALL    LOC0
       F106                     CLLINE:
000336 F106 3E20             7      LD  A,020H
       F108                     CLLINE1:
000338 F108 77               7      LD  (HL),A
000339 F109 23               6      INC HL
00033A F10A 10FC            13      DJNZ    CLLINE1
00033C F10C C9              10      RET
                                
       F10D                     CTRL0D:
00033D F10D AF               4      XOR A
00033E F10E 328EEE          13      LD  (_TXADR),A
000341 F111 C9              10      RET
                                
       F112                     CTRL12:
000342 F112 2154E1          10      LD  HL,INSFLG
000345 F115 7E               7      LD  A,(HL)
000346 F116 EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000348 F118 77               7      LD  (HL),A
000349 F119 C9              10      RET
                                
       F11A                     CTRL0B:
00034A F11A 210000          10      LD  HL,0
00034D F11D 228EEE          16      LD  (_TXADR),HL
000350 F120 C9              10      RET
                                
       F121                     CTRL1B:
000351 F121 3E01             7      LD  A,1
000353 F123 3249E1          13      LD  (ESCFLG),A
000356 F126 C9              10      RET
                                
       F127                     CTRL07:
000357 F127 3AB9EE          13      LD  A,(WK40)
00035A F12A F5              11      PUSH    AF
00035B F12B F620             7      OR  20H
00035D F12D D340            11      OUT (040H),A
00035F F12F 0610             7      LD  B,16
       F131                     C07X1:
000361 F131 CD79E2          17      CALL    VBLANK
000364 F134 10FB            13      DJNZ    C07X1
000366 F136 F1              10      POP AF
000367 F137 D340            11      OUT (040H),A
000369 F139 C9              10      RET
                                
       F13A                     INSERT:
00036A F13A 2A8EEE          16      LD  HL,(_TXADR)
00036D F13D 3AB1EE          13      LD  A,(_WIDTH)
000370 F140 95               4      SUB L
000371 F141 47               4      LD  B,A
                                
000372 F142 CD65E1          17      CALL    LOC0
                                
000375 F145 3E20             7      LD  A,020H
       F147                     INS1:
000377 F147 4E               7      LD  C,(HL)
000378 F148 77               7      LD  (HL),A
000379 F149 79               4      LD  A,C
00037A F14A 23               6      INC HL
00037B F14B 10FA            13      DJNZ    INS1
00037D F14D C9              10      RET
                                
       F14E                     CTRL0C:
00037E F14E CD1AF1          17      CALL    CTRL0B
       F151                     CTRL06:
000381 F151 2A8EEE          16      LD  HL,(_TXADR)
       F154                     CLS1:
       F154                     CLS2:
000384 F154 E5              11      PUSH    HL
000385 F155 3AB1EE          13      LD  A,(_WIDTH)
000388 F158 95               4      SUB L
000389 F159 47               4      LD  B,A
00038A F15A CD68E1          17      CALL    LOC1
00038D F15D 3E20             7      LD  A,020H
       F15F                     CLS3:
00038F F15F 77               7      LD  (HL),A
000390 F160 23               6      INC HL
000391 F161 10FC            13      DJNZ    CLS3
000393 F163 E1              10      POP HL
000394 F164 2E00             7      LD  L,0
000396 F166 24               4      INC H
000397 F167 3A97EE          13      LD  A,(_LINE)
00039A F16A BC               4      CP  H
00039B F16B 20E7            12      JR  NZ,CLS2
00039D F16D C9              10      RET
                                
       F16E                     CTRL04:
00039E F16E CDD3EE          17      CALL    _POS
0003A1 F171 7D               4      LD  A,L
0003A2 F172 B7               4      OR  A
0003A3 F173 C8              11      RET Z
       F174                     CTRL03:
0003A4 F174 CD0DF1          17      CALL    CTRL0D
       F177                     CTRL0A:
       F177                     CTRL1F:
0003A7 F177 2A8EEE          16      LD  HL,(_TXADR)
0003AA F17A 24               4      INC H
0003AB F17B C397F0          10      JP  PRINTE8
                                
       F17E                     CTRL0E:
0003AE F17E CDD3EE          17      CALL    _POS
0003B1 F181 7C               4      LD  A,H
0003B2 F182 1804            12      JR  SCR1
       F184                     SCR:
0003B4 F184 3A97EE          13      LD  A,(_LINE)
0003B7 F187 3D               4      DEC A
       F188                     SCR1:
0003B8 F188 C5              11      PUSH    BC
0003B9 F189 D5              11      PUSH    DE
0003BA F18A E5              11      PUSH    HL
0003BB F18B F5              11      PUSH    AF
0003BC F18C 210000          10      LD  HL,0
0003BF F18F CD68E1          17      CALL    LOC1
0003C2 F192 EB               4      EX  DE,HL
0003C3 F193 210001          10      LD  HL,0100H
0003C6 F196 CD68E1          17      CALL    LOC1
0003C9 F199 C1              10      POP BC
0003CA F19A 78               4      LD  A,B
0003CB F19B B7               4      OR  A
       F19C                     SCRUP1:
0003CC F19C 2815            12      JR  Z,SCRCL
0003CE F19E E5              11      PUSH    HL
0003CF F19F D5              11      PUSH    DE
0003D0 F1A0 0608             7      LD  B,8
0003D2 F1A2 5F               4      LD  E,A
0003D3 F1A3 210078          10      LD  HL,120*256
0003D6 F1A6 55               4      LD  D,L
       F1A7                     SCRH2:
0003D7 F1A7 29              11      ADD HL,HL
0003D8 F1A8 3001            12      JR  NC,SCRH3
0003DA F1AA 19              11      ADD HL,DE
       F1AB                     SCRH3:
0003DB F1AB 10FA            13      DJNZ    SCRH2
0003DD F1AD 4D               4      LD  C,L
0003DE F1AE 44               4      LD  B,H
0003DF F1AF D1              10      POP DE
0003E0 F1B0 E1              10      POP HL
0003E1 F1B1 EDB0                    LDIR
                                
       F1B3                     SCRCL:
0003E3 F1B3 3AB1EE          13      LD  A,(_WIDTH)
0003E6 F1B6 47               4      LD  B,A
0003E7 F1B7 EB               4      EX  DE,HL
0003E8 F1B8 CD06F1          17      CALL    CLLINE
0003EB F1BB E1              10      POP HL
0003EC F1BC D1              10      POP DE
0003ED F1BD C1              10      POP BC
0003EE F1BE C9              10      RET
[EOF:88VRAM.ASM:UTF_8]
                                    INCLUDE "88TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE キーのテーブル
                                
       F1BF                     KEY_TABLE:
0003EF F1BF 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
0003F7 F1C7 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
0003FF F1CF 4061626364656667        DB  '@','a','b','c','d','e','f','g' ;2
000407 F1D7 68696A6B6C6D6E6F        DB  'h','i','j','k','l','m','n','o' ;3
00040F F1DF 7071727374757677        DB  'p','q','r','s','t','u','v','w' ;4
000417 F1E7 78797A5B5C5D5E2D        DB  'x','y','z','[',5CH,']','^','-' ;5
00041F F1EF 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;6
000427 F1F7 38393A3B2C2E2F5C        DB  '8','9',':',';',',','.','/',5CH ;7
00042F F1FF 0C1E1C0800000000        DB  0CH,1EH,1CH,08H,00H,00H,00H,00H ;8
000437 F207 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
00043F F20F 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
000447 F217 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
00044F F21F 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
                                
       F227                     SHIFT_TABLE:
000457 F227 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
00045F F22F 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
000467 F237 4041424344454647        DB  '@','A','B','C','D','E','F','G' ;2
00046F F23F 48494A4B4C4D4E4F        DB  'H','I','J','K','L','M','N','O' ;3
000477 F247 5051525354555657        DB  'P','Q','R','S','T','U','V','W' ;4
00047F F24F 58595A7B7C7D7E3D        DB  'X','Y','Z','{','|','}','~','=' ;5
000487 F257 3021222324252627        DB  '0','!','"','#','$','%','&',27H ;6
00048F F25F 28292A2B3C3E3F5F        DB  '(',')','*','+','<','>','?','_' ;7
000497 F267 0B1E1C0800000000        DB  0BH,1EH,1CH,08H,00H,00H,00H,00H ;8
00049F F26F 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
0004A7 F277 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
0004AF F27F 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
0004B7 F287 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
                                
       F28F                     CTRL_TABLE:
0004BF F28F 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
0004C7 F297 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
0004CF F29F 4001020304050607        DB  '@',01H,02H,03H,04H,05H,06H,07H ;2
0004D7 F2A7 08090A0B0C0D0E0F        DB  08H,09H,0AH,0BH,0CH,0DH,0EH,0FH ;3
0004DF F2AF 1011121314151617        DB  10H,11H,12H,13H,14H,15H,16H,17H ;4
0004E7 F2B7 18191A5B5C5D5E2D        DB  18H,19H,1AH,'[',5CH,']','^','-' ;5
0004EF F2BF 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;6
0004F7 F2C7 38393A3B2C2E2F5F        DB  '8','9',':',';',',','.','/','_' ;7
0004FF F2CF 0C1E1C0800000000        DB  0CH,1EH,1CH,08H,00H,00H,00H,00H ;8
000507 F2D7 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
00050F F2DF 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
000517 F2E7 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
00051F F2EF 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
       F2F7                     VRAME:
000527 D620                         ORG $$+OFFSET   ;$DEPHASE
       D620                     AT_VRAME:
[EOF:88TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "88SUB.ASM"
                                
                                ;   LSX-Dodgers SUB DISK SYSTEM
                                ;   PC-8801mkIISR
                                
       D620                     AT_DSS:
000527 7C00                         ORG DSS,AT_DSS-OFFSET
000527 7C00 C3437C          10      JP  READDISKEX
00052A 7C03 C3A37C          10      JP  WRITEDISKEX
00052D 7C06 C3BB7C          10      JP  GETPARAMS_N
000530 7C09 C3C67C          10      JP  SEEK
000533 7C0C C3547D          10      JP  FDCOMMAND
000536 7C0F C3207E          10      JP  CHECKRESULT
000539 7C12 C3427E          10      JP  GETDEVSTAT
00053C 7C15 C3477E          10      JP  RDFDC
                                
00053F 7C18                         DS  8*3
                                
       7C30                     S_PARAMS:
000557 7C30                         DS  16
       7C30                     S_UNITNO    EQU S_PARAMS    ;ユニット番号 0:ドライブA 1:ドライブB
       7C31                     S_DPS       EQU S_PARAMS+1  ;1トラックのセクタ数
       7C32                     S_SECTOR_R  EQU S_PARAMS+2  ;セクタ番号
       7C33                     S_TRACK     EQU S_PARAMS+3  ;トラック番号
       7C34                     S_FDMODE    EQU S_PARAMS+4  ;FDモード切り替え $FF:2D/2DD $FE:2HD
       7C35                     S_SECSIZE_N EQU S_PARAMS+5  ;N セクタサイズ
       7C36                     S_BYTE_H    EQU S_PARAMS+6  ;バイト数H
       7C37                     S_MAXCL     EQU S_PARAMS+7  ;シリンダ数
                                
       7C40                     S_CMD_STATUS:
000567 7C40 00                      DB  0
       7C41                     S_LEFT:
000568 7C41 00                      DB  0
       7C42                     S_WKF4:
000569 7C42 00                      DB  0
                                
       7C43                     READDISKEX:
00056A 7C43 CDB97C          17      CALL    GETPARAMS
00056D 7C46 AF               4      XOR A
00056E 7C47 327A7C          13      LD  (RETRY_RDDISK),A
000571 7C4A 2A327C          16      LD  HL,(S_PARAMS+2)
000574 7C4D 7D               4      LD  A,L
000575 7C4E 3D               4      DEC A
000576 7C4F B4               4      OR  H
000577 7C50 200C            12      JR  NZ,RDDISK0
000579 7C52 2A357C          16      LD  HL,(S_PARAMS+5)
00057C 7C55 7C               4      LD  A,H
00057D 7C56 BD               4      CP  L
00057E 7C57 2005            12      JR  NZ,RDDISK0
000580 7C59 3E03             7      LD  A,3
000582 7C5B 327A7C          13      LD  (RETRY_RDDISK),A
       7C5E                     RDDISK0:
000585 7C5E CDC67C          17      CALL    SEEK
000588 7C61 3E46             7      LD  A,46H       ;READ DATA
00058A 7C63 CD547D          17      CALL    FDCOMMAND
00058D 7C66 3834            12      JR  C,FINISH_DISK
00058F 7C68 CD857D          17      CALL    RDDISK1
       7C6B                     WRDISK3:
000592 7C6B 78               4      LD  A,B
000593 7C6C B2               4      OR  D
000594 7C6D 32417C          13      LD  (S_LEFT),A
000597 7C70 DBF8            11      IN  A,(0F8H)    ;FDC μPD765A TC入力
000599 7C72 FB               4      EI
00059A 7C73 76               4      HALT
00059B 7C74 CD207E          17      CALL    CHECKRESULT
00059E 7C77 301D            12      JR  NC,FINISH_DISK0
       7C7A                     RETRY_RDDISK    EQU $+1
0005A0 7C79 3E00             7      LD  A,0
0005A2 7C7B B7               4      OR  A
0005A3 7C7C 2818            12      JR  Z,FINISH_DISK0
0005A5 7C7E 3D               4      DEC A
0005A6 7C7F 327A7C          13      LD  (RETRY_RDDISK),A
0005A9 7C82 3A357C          13      LD  A,(S_PARAMS+5)
0005AC 7C85 FE04             7      CP  4
0005AE 7C87 3003            12      JR  NC,RETRY_RDDISK1
0005B0 7C89 87               4      ADD A,A
0005B1 7C8A 1802            12      JR  RETRY_RDDISK2
       7C8C                     RETRY_RDDISK1:
0005B3 7C8C 3E01             7      LD  A,1
       7C8E                     RETRY_RDDISK2:
0005B5 7C8E 67               4      LD  H,A
0005B6 7C8F 6F               4      LD  L,A
0005B7 7C90 22357C          16      LD  (S_PARAMS+5),HL
0005BA 7C93 C35E7C          10      JP  RDDISK0
       7C96                     FINISH_DISK0:
0005BD 7C96 3A417C          13      LD  A,(S_LEFT)
0005C0 7C99 D601             7      SUB 1
0005C2 7C9B 3F               4      CCF
       7C9C                     FINISH_DISK:
0005C3 7C9C 9F               4      SBC A,A
0005C4 7C9D 32407C          13      LD  (S_CMD_STATUS),A
0005C7 7CA0 C32A00          10      JP  MAIN
                                
       7CA3                     WRITEDISKEX:
0005CA 7CA3 AF               4      XOR A
0005CB 7CA4 327A7C          13      LD  (RETRY_RDDISK),A
0005CE 7CA7 CDB97C          17      CALL    GETPARAMS
0005D1 7CAA CDC67C          17      CALL    SEEK
0005D4 7CAD 3E45             7      LD  A,45H       ;WRITE DATA
0005D6 7CAF CD547D          17      CALL    FDCOMMAND
0005D9 7CB2 38E8            12      JR  C,FINISH_DISK
0005DB 7CB4 CDCC7D          17      CALL    WRDISK1
0005DE 7CB7 18B2            12      JR  WRDISK3
                                
       7CB9                     GETPARAMS:
0005E0 7CB9 0608             7      LD  B,8
       7CBB                     GETPARAMS_N:
0005E2 7CBB E5              11      PUSH    HL
0005E3 7CBC 21307C          10      LD  HL,S_PARAMS
       7CBF                     GETPARAMS1:
0005E6 7CBF D7              12      RST 10H
0005E7 7CC0 77               7      LD  (HL),A
0005E8 7CC1 23               6      INC HL
0005E9 7CC2 10FB            13      DJNZ    GETPARAMS1
0005EB 7CC4 E1              10      POP HL
0005EC 7CC5 C9              10      RET
                                
       7CC6                     SEEK:
0005ED 7CC6 E5              11      PUSH    HL
0005EE 7CC7 3A347C          13      LD  A,(S_FDMODE)    ;FDモード切り替え $FF:2D/2DD $FE:2HD
0005F1 7CCA 1F               4      RRA
0005F2 7CCB 3F               4      CCF
0005F3 7CCC 9F               4      SBC A,A
0005F4 7CCD F5              11      PUSH    AF
0005F5 7CCE E605             7      AND 5
0005F7 7CD0 4F               4      LD  C,A
0005F8 7CD1 3A377C          13      LD  A,(S_MAXCL) ;シリンダ数
0005FB 7CD4 C6D3             7      ADD A,0-45      ;オーバートラックを考慮して40+α
0005FD 7CD6 9F               4      SBC A,A
0005FE 7CD7 E604             7      AND 4
000600 7CD9 B1               4      OR  C
000601 7CDA 0EFA             7      LD  C,0FFH-5    ;マスク
000603 7CDC 47               4      LD  B,A
000604 7CDD 3A307C          13      LD  A,(S_UNITNO)    ;0:ドライブA 1:ドライブB
000607 7CE0 B7               4      OR  A
000608 7CE1 2804            12      JR  Z,SET_WKF4
00060A 7CE3 CB20             8      SLA B
00060C 7CE5 CB01             4      RLC C
       7CE7                     SET_WKF4:
00060E 7CE7 3A427C          13      LD  A,(S_WKF4)
000611 7CEA A1               4      AND C
000612 7CEB B0               4      OR  B
000613 7CEC 4F               4      LD  C,A
000614 7CED D3F4            11      OUT (0F4H),A    ;ドライブ制御
000616 7CEF E6DF             7      AND 0FFH-020H   ;CLKの分は抜いておく
000618 7CF1 47               4      LD  B,A
000619 7CF2 F1              10      POP AF
00061A 7CF3 E620             7      AND 020H        ;bit5:CLK
00061C 7CF5 B0               4      OR  B
00061D 7CF6 D3F4            11      OUT (0F4H),A    ;ドライブ制御
00061F 7CF8 32427C          13      LD  (S_WKF4),A
000622 7CFB 47               4      LD  B,A
000623 7CFC A9               4      XOR C
000624 7CFD E620             7      AND 020H        ;CLKが変化したら一定時間待つ
000626 7CFF 2808            12      JR  Z,NOCHGCLK
000628 7D01 2160F0          10      LD  HL,0F060H
       7D04                     WAIT_CLK:
00062B 7D04 2B               6      DEC HL
00062C 7D05 7C               4      LD  A,H
00062D 7D06 B5               4      OR  L
00062E 7D07 20FB            12      JR  NZ,WAIT_CLK
       7D09                     NOCHGCLK:
000630 7D09 78               4      LD  A,B
000631 7D0A E620             7      AND 020H
000633 7D0C 2805            12      JR  Z,SPECIFY2D
000635 7D0E 1131DF          10      LD  DE,0DF31H   ;SPECIFY 2HD / SRT:13 HUT:15 HLT:24 NON-DMA
000638 7D11 1803            12      JR  SPECIFYOK
       7D13                     SPECIFY2D:
00063A 7D13 1119DA          10      LD  DE,0DA19H   ;SPECIFY 2D/2DD / SRT:13 HUT 10 HLT:12 NON-DMA
       7D16                     SPECIFYOK:
00063D 7D16 3E03             7      LD  A,3     ;SPECIFY
00063F 7D18 E7              12      RST 20H
000640 7D19 7A               4      LD  A,D
000641 7D1A E7              12      RST 20H
000642 7D1B 7B               4      LD  A,E
000643 7D1C E7              12      RST 20H
       7D1D                     NOSPECIFY:
000644 7D1D ED4B307C        20      LD  BC,(S_PARAMS)
000648 7D21 ED5B327C        20      LD  DE,(S_PARAMS+2)
00064C 7D25 7A               4      LD  A,D     ;TRACK
00064D 7D26 CB3F             8      SRL A       ;CYLINDER
00064F 7D28 3E0F             7      LD  A,00FH      ;SEEK
000651 7D2A 2002            12      JR  NZ,SEEK1    ;0シリンダの場合はRECALIBRATE、それ以外はSEEKを使う
000653 7D2C 3E07             7      LD  A,7     ;RECALIBRATE
       7D2E                     SEEK1:
000655 7D2E E7              12      RST 20H
000656 7D2F 79               4      LD  A,C     ;DR/HD
000657 7D30 E7              12      RST 20H
000658 7D31 7A               4      LD  A,D     ;TRACK
000659 7D32 CB3F             8      SRL A       ;CYLINDER
00065B 7D34 C42000          17      CALL    NZ,20H      ;SEEKの場合だけ呼ぶ(0シリンダの場合はRECALIBRATEを使うのでシリンダの設定は不要)
00065E 7D37 FB               4      EI
00065F 7D38 76               4      HALT
000660 7D39 3E08             7      LD  A,8     ;SENSE
000662 7D3B E7              12      RST 20H
000663 7D3C CD477E          17      CALL    RDFDC       ;ST0
000666 7D3F CD477E          17      CALL    RDFDC       ;PCN(CYLINDER)
000669 7D42 210040          10      LD  HL,04000H
       7D45                     WAIT_SEEK:
00066C 7D45 CD427E          17      CALL    GETDEVSTAT
00066F 7D48 E608             7      AND 8
000671 7D4A 2006            12      JR  NZ,SEEK_OK
000673 7D4C 2B               6      DEC HL
000674 7D4D 7C               4      LD  A,H
000675 7D4E B5               4      OR  L
000676 7D4F 20F4            12      JR  NZ,WAIT_SEEK
000678 7D51 37               4      SCF
       7D52                     SEEK_OK:
000679 7D52 E1              10      POP HL
00067A 7D53 C9              10      RET
                                
       7D54                     FDCOMMAND:
00067B 7D54 E7              12      RST 20H
00067C 7D55 7A               4      LD  A,D     ;HD US1 US0
00067D 7D56 E601             7      AND 1
00067F 7D58 87               4      ADD A,A
000680 7D59 87               4      ADD A,A
000681 7D5A B1               4      OR  C
000682 7D5B E7              12      RST 20H
000683 7D5C 7A               4      LD  A,D     ;C
000684 7D5D CB3F             8      SRL A
000686 7D5F E7              12      RST 20H
000687 7D60 7A               4      LD  A,D     ;H
000688 7D61 E601             7      AND 1
00068A 7D63 E7              12      RST 20H
00068B 7D64 7B               4      LD  A,E     ;R
00068C 7D65 E7              12      RST 20H
00068D 7D66 3A357C          13      LD  A,(S_PARAMS+5)  ;N
000690 7D69 FE04             7      CP  4
000692 7D6B 3802            12      JR  C,FDCOMMAND2
                                
000694 7D6D 3E03             7      LD  A,3
       7D6F                     FDCOMMAND2:
000696 7D6F 1E20             7      LD  E,020H      ;NO SERVICE
000698 7D71 E7              12      RST 20H
                                
000699 7D72 210040          10      LD  HL,DSS_DATA ;開始アドレス
00069C 7D75 78               4      LD  A,B     ;EOT
00069D 7D76 E7              12      RST 20H
                                
00069E 7D77 01FB00          10      LD  BC,000FBH   ;B:バイト数L C:FDC μPD765A データレジスタ
0006A1 7D7A 3E54             7      LD  A,054H      ;GSL
0006A3 7D7C E7              12      RST 20H
                                
0006A4 7D7D 3A367C          13      LD  A,(S_BYTE_H)
0006A7 7D80 57               4      LD  D,A     ;バイト数H
                                
0006A8 7D81 AF               4      XOR A       ;DTL
0006A9 7D82 E7              12      RST 20H
0006AA 7D83 A7               4      AND A
0006AB 7D84 C9              10      RET
                                
       7D85                     RDDISK1:            ;高速化の為にループ展開x8
0006AC 7D85 FB               4      EI
0006AD 7D86 76               4      HALT
0006AE 7D87 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006B0 7D89 A3               4      AND E       ;NO SERVICE
0006B1 7D8A C8              11      RET Z
0006B2 7D8B EDA2            16      INI
                                
0006B4 7D8D FB               4      EI
0006B5 7D8E 76               4      HALT
0006B6 7D8F DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006B8 7D91 A3               4      AND E       ;NO SERVICE
0006B9 7D92 C8              11      RET Z
0006BA 7D93 EDA2            16      INI
                                
0006BC 7D95 FB               4      EI
0006BD 7D96 76               4      HALT
0006BE 7D97 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006C0 7D99 A3               4      AND E       ;NO SERVICE
0006C1 7D9A C8              11      RET Z
0006C2 7D9B EDA2            16      INI
                                
0006C4 7D9D FB               4      EI
0006C5 7D9E 76               4      HALT
0006C6 7D9F DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006C8 7DA1 A3               4      AND E       ;NO SERVICE
0006C9 7DA2 C8              11      RET Z
0006CA 7DA3 EDA2            16      INI
                                
0006CC 7DA5 FB               4      EI
0006CD 7DA6 76               4      HALT
0006CE 7DA7 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006D0 7DA9 A3               4      AND E       ;NO SERVICE
0006D1 7DAA C8              11      RET Z
0006D2 7DAB EDA2            16      INI
                                
0006D4 7DAD FB               4      EI
0006D5 7DAE 76               4      HALT
0006D6 7DAF DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006D8 7DB1 A3               4      AND E       ;NO SERVICE
0006D9 7DB2 C8              11      RET Z
0006DA 7DB3 EDA2            16      INI
                                
0006DC 7DB5 FB               4      EI
0006DD 7DB6 76               4      HALT
0006DE 7DB7 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006E0 7DB9 A3               4      AND E       ;NO SERVICE
0006E1 7DBA C8              11      RET Z
0006E2 7DBB EDA2            16      INI
                                
0006E4 7DBD FB               4      EI
0006E5 7DBE 76               4      HALT
0006E6 7DBF DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006E8 7DC1 A3               4      AND E       ;NO SERVICE
0006E9 7DC2 C8              11      RET Z
0006EA 7DC3 EDA2            16      INI
                                
0006EC 7DC5 20BE            12      JR  NZ,RDDISK1
0006EE 7DC7 15               4      DEC D
0006EF 7DC8 C2857D          10      JP  NZ,RDDISK1
0006F2 7DCB C9              10      RET
                                
       7DCC                     WRDISK1:            ;高速化の為にループ展開x8
0006F3 7DCC FB               4      EI
0006F4 7DCD 76               4      HALT
0006F5 7DCE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006F7 7DD0 A3               4      AND E
0006F8 7DD1 C8              11      RET Z
0006F9 7DD2 EDA3            16      OUTI
                                
0006FB 7DD4 FB               4      EI
0006FC 7DD5 76               4      HALT
0006FD 7DD6 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0006FF 7DD8 A3               4      AND E
000700 7DD9 C8              11      RET Z
000701 7DDA EDA3            16      OUTI
                                
000703 7DDC FB               4      EI
000704 7DDD 76               4      HALT
000705 7DDE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000707 7DE0 A3               4      AND E
000708 7DE1 C8              11      RET Z
000709 7DE2 EDA3            16      OUTI
                                
00070B 7DE4 FB               4      EI
00070C 7DE5 76               4      HALT
00070D 7DE6 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00070F 7DE8 A3               4      AND E
000710 7DE9 C8              11      RET Z
000711 7DEA EDA3            16      OUTI
                                
000713 7DEC FB               4      EI
000714 7DED 76               4      HALT
000715 7DEE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000717 7DF0 A3               4      AND E
000718 7DF1 C8              11      RET Z
000719 7DF2 EDA3            16      OUTI
                                
00071B 7DF4 FB               4      EI
00071C 7DF5 76               4      HALT
00071D 7DF6 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00071F 7DF8 A3               4      AND E
000720 7DF9 C8              11      RET Z
000721 7DFA EDA3            16      OUTI
                                
000723 7DFC FB               4      EI
000724 7DFD 76               4      HALT
000725 7DFE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000727 7E00 A3               4      AND E
000728 7E01 C8              11      RET Z
000729 7E02 EDA3            16      OUTI
                                
00072B 7E04 FB               4      EI
00072C 7E05 76               4      HALT
00072D 7E06 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00072F 7E08 A3               4      AND E
000730 7E09 C8              11      RET Z
000731 7E0A EDA3            16      OUTI
                                
000733 7E0C 20BE            12      JR  NZ,WRDISK1
000735 7E0E 15               4      DEC D
000736 7E0F C2CC7D          10      JP  NZ,WRDISK1
000739 7E12 C9              10      RET
                                
       7E13                     RESULTEX:
00073A 7E13 3A407C          13      LD  A,(S_CMD_STATUS)
00073D 7E16 3C               4      INC A
00073E 7E17 2803            12      JR  Z,RESULTEX1
000740 7E19 3A367C          13      LD  A,(S_BYTE_H)    ;バイト数H
       7E1C                     RESULTEX1:
000743 7E1C DF              12      RST 18H
000744 7E1D C32A00          10      JP  MAIN
                                
       7E20                     CHECKRESULT:
000747 7E20 C5              11      PUSH    BC
000748 7E21 CD477E          17      CALL    RDFDC       ;ST0
00074B 7E24 E6D8             7      AND 0D8H
00074D 7E26 4F               4      LD  C,A
00074E 7E27 CD477E          17      CALL    RDFDC       ;ST1
000751 7E2A E6B7             7      AND 0B7H
000753 7E2C B1               4      OR  C
000754 7E2D 4F               4      LD  C,A
000755 7E2E CD477E          17      CALL    RDFDC       ;ST2
000758 7E31 E673             7      AND 073H
00075A 7E33 B1               4      OR  C
00075B 7E34 4F               4      LD  C,A
00075C 7E35 0604             7      LD  B,4
       7E37                     CHECKRESULT1:           ;C H R N
00075E 7E37 CD477E          17      CALL    RDFDC
000761 7E3A 10FB            13      DJNZ    CHECKRESULT1
000763 7E3C 79               4      LD  A,C
000764 7E3D A7               4      AND A
000765 7E3E C1              10      POP BC
000766 7E3F C8              11      RET Z
000767 7E40 37               4      SCF
000768 7E41 C9              10      RET
                                
       7E42                     GETDEVSTAT:
000769 7E42 3E04             7      LD  A,4
00076B 7E44 E7              12      RST 20H
00076C 7E45 79               4      LD  A,C
00076D 7E46 E7              12      RST 20H
                                
       7E47                     RDFDC:
00076E 7E47 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000770 7E49 2F               4      CPL
000771 7E4A E6C0             7      AND 0C0H        ;RQMとDIOが両方1になるまで待つ
000773 7E4C 20F9            12      JR  NZ,RDFDC
000775 7E4E DBFB            11      IN  A,(0FBH)    ;FDC μPD765A データレジスタリード
000777 7E50 C9              10      RET
                                
000778 D871                         ORG $$+OFFSET   ;$DEPHASE
       D871                     AT_DSSE:
       D871                     INITE:
000778 D871                         DS  BDOS-INITE
00080D D906 C367E0          10      JP  BDOS_RF
[EOF:88SUB.ASM:SHIFT_JIS]
                                    INCLUDE "88CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   PC-8801mkIISR
                                
       D909                     WBOOT1:
000810 D909 ED7B0600        20      LD  SP,(SYSTEM+1)
000814 D90D DB32            11      IN  A,(032H)
000816 D90F F610             7      OR  10H     ;高速RAMアクセスモードOFF
000818 D911 D332            11      OUT (032H),A
                                
00081A D913 3EED             7      LD  A,IVRTC/256
00081C D915 ED47             9      LD  I,A
00081E D917 3AB8EE          13      LD  A,(WKE6)
000821 D91A F602             7      OR  2       ;VRTC割り込みマスク
000823 D91C D3E6            11      OUT (0E6H),A    ;割り込みマスク
000825 D91E 32B8EE          13      LD  (WKE6),A
000828 D921 3AB7EE          13      LD  A,(WKE4)
00082B D924 D3E4            11      OUT (0E4H),A    ;割り込みレベル設定 
                                
00082D D926 FB               4      EI
00082E D927 2192EE          10      LD  HL,_KEYD
000831 D92A 3600            10      LD  (HL),0
000833 D92C CD1AE2          17      CALL    CHKEY
000836 D92F CDE0E2          17      CALL    KEYBC_IFBREAK
000839 D932 3E04             7      LD  A,4
00083B D934 CDF3E2          17      CALL    MSG_A
[EOF:88CCP.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D937                     COMMAND:
00083E D937 3A8FED          13      LD  A,(FCB_BAT)
000841 D93A B7               4      OR  A
000842 D93B C27DDA          10      JP  NZ,C_BAT1
000845 D93E CDF1D9          17      CALL    SETDTA1
000848 D941 3A0400          13      LD  A,(_DVSW)
00084B D944 C641             7      ADD A,'A'
00084D D946 CDF3E2          17      CALL    MSG_A
000850 D949 3E3E             7      LD  A,'>'
000852 D94B CDF3E2          17      CALL    MSG_A
000855 D94E 3E50             7      LD  A,80
000857 D950 12               7      LD  (DE),A
000858 D951 CD70E0          17      CALL    _SYS0A      ;(BDOS)文字列入力
00085B D954 CD72DB          17      CALL    LTNL
       D957                     COMMAND2:
00085E D957 118200          10      LD  DE,DTA1+2
000861 D95A CDFDEE          17      CALL    _COMANL
000864 D95D 30D8            12      JR  NC,COMMAND
000866 D95F 1179EE          10      LD  DE,COMERM
000869 D962 CDD4DD          17      CALL    _SYS09      ;(BDOS)文字列出力
00086C D965 C7              12      RST 0
                                
       D966                     COMANL:
00086D D966 CD0BF0          17      CALL    FILE
000870 D969 3A19EE          13      LD  A,(FNAME+4)
000873 D96C FE20             7      CP  020H
000875 D96E 201C            12      JR  NZ,COMB2
000877 D970 D5              11      PUSH    DE
000878 D971 1115EE          10      LD  DE,FNAME
00087B D974 1A               7      LD  A,(DE)
00087C D975 FE20             7      CP  020H
00087E D977 2844            12      JR  Z,SDVSW
000880 D979 1B               6      DEC DE
000881 D97A 1A               7      LD  A,(DE)
000882 D97B C6FF             7      ADD A,0FFH
000884 D97D 3809            12      JR  C,COMB
000886 D97F 13               6      INC DE
                                
000887 D980 212FDD          10      LD  HL,COMTB
00088A D983 0608             7      LD  B,COMS
00088C D985 CD9AF2          17      CALL    CPNAME
       D988                     COMB:
00088F D988 D1              10      POP DE
000890 D989 D20F00          10      JP  NC,JP_HL
       D98C                     COMB2:
000893 D98C EB               4      EX  DE,HL
000894 D98D 225ADA          16      LD  (COMSWC),HL
000897 D990 F5              11      PUSH    AF
000898 D991 CD12DA          17      CALL    CEXE4
00089B D994 F1              10      POP AF
00089C D995 2115EE          10      LD  HL,FNAME
00089F D998 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
0008A2 D99B 010B00          10      LD  BC,11
0008A5 D99E EDB0                    LDIR
0008A7 D9A0 112EED          10      LD  DE,PATHD
       D9A3                     CEX1:
0008AA D9A3 1A               7      LD  A,(DE)
0008AB D9A4 FE20             7      CP  020H
0008AD D9A6 D8              11      RET C
0008AE D9A7 CD00F0          17      CALL    FILEC
0008B1 D9AA D5              11      PUSH    DE
0008B2 D9AB 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
0008B5 D9AE 1115EE          10      LD  DE,FNAME
0008B8 D9B1 010B00          10      LD  BC,11
0008BB D9B4 EDB0                    LDIR
0008BD D9B6 CD12DA          17      CALL    CEXE4
0008C0 D9B9 D1              10      POP DE
0008C1 D9BA 13               6      INC DE
0008C2 D9BB 18E6            12      JR  CEX1
                                
       D9BD                     SDVSW:
0008C4 D9BD F1              10      POP AF
0008C5 D9BE 3A14EE          13      LD  A,(FDRV)
0008C8 D9C1 3D               4      DEC A
0008C9 D9C2 5F               4      LD  E,A
0008CA D9C3 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
0008CC D9C5 1831            12      JR  SYSTEM0
                                
       D9C7                     OPEN1:
0008CE D9C7 2114EE          10      LD  HL,FDRV
       D9CA                     OPEN:
0008D1 D9CA 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D9CC                     OPEN3:
0008D3 D9CC D5              11      PUSH    DE
0008D4 D9CD 116AED          10      LD  DE,DTA_CCP
0008D7 D9D0 CDEED9          17      CALL    SETDTA
0008DA D9D3 EB               4      EX  DE,HL
0008DB D9D4 CDF8D9          17      CALL    SYSTEM0
0008DE D9D7 D1              10      POP DE
0008DF D9D8 C9              10      RET
                                
       D9D9                     OPEN2:
0008E0 D9D9 0E12             7      LD  C,012H
0008E2 D9DB 18EF            12      JR  OPEN3
                                
       D9DD                     DEFCB:              ;Z=Ok NZ=Error
0008E4 D9DD 116AED          10      LD  DE,DTA_CCP
0008E7 D9E0 CDF6D9          17      CALL    SYSC0F
                                
0008EA D9E3 118BED          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0008ED D9E6 0604             7      LD  B,4
0008EF D9E8 CD43DC          17      CALL    ZERO_MEMORY_DE
       D9EB                     SETDTA100:
0008F2 D9EB 110001          10      LD  DE,00100H
       D9EE                     SETDTA:
0008F5 D9EE C3A7DF          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D9F1                     SETDTA1:
0008F8 D9F1 118000          10      LD  DE,DTA1
0008FB D9F4 18F8            12      JR  SETDTA
                                
       D9F6                     SYSC0F:
0008FD D9F6 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D9F8                     SYSTEM0:
0008FF D9F8 CD0500          17      CALL    SYSTEM
000902 D9FB B7               4      OR  A
000903 D9FC C9              10      RET
                                
       D9FD                     C_CD:
000904 D9FD 0E5A             7      LD  C,05AH
000906 D9FF 18F7            12      JR  SYSTEM0
                                
       DA01                     S27BUF:
000908 DA01 2100FE          10      LD  HL,0-00200H ;スクラッチエリア(0100H)+スタック予備(0100H)
00090B DA04 39              11      ADD HL,SP
00090C DA05 2E00             7      LD  L,0
00090E DA07 7C               4      LD  A,H
00090F DA08 E6F8             7      AND 0F8H
000911 DA0A 67               4      LD  H,A
       DA0B                     S27DTA:
000912 DA0B 116AED          10      LD  DE,DTA_CCP
       DA0E                     S27:
000915 DA0E 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
000917 DA10 18E6            12      JR  SYSTEM0
                                
       DA12                     CEXE4:
000919 DA12 211DEE          10      LD  HL,FNAME+8
00091C DA15 7E               7      LD  A,(HL)
00091D DA16 FE20             7      CP  020H
00091F DA18 2007            12      JR  NZ,CEXE7
000921 DA1A 3E3F             7      LD  A,'?'
000923 DA1C 77               7      LD  (HL),A
000924 DA1D 23               6      INC HL
000925 DA1E 77               7      LD  (HL),A
000926 DA1F 23               6      INC HL
000927 DA20 77               7      LD  (HL),A
       DA21                     CEXE7:
000928 DA21 CDC7D9          17      CALL    OPEN1
       DA24                     CEXE5:
00092B DA24 C0              11      RET NZ
00092C DA25 2A74ED          16      LD  HL,(DTA_CCP+1+9)
00092F DA28 7C               4      LD  A,H
000930 DA29 CD22F3          17      CALL    CAP
000933 DA2C 67               4      LD  H,A
000934 DA2D 7D               4      LD  A,L
000935 DA2E CD22F3          17      CALL    CAP
000938 DA31 6F               4      LD  L,A
000939 DA32 3A73ED          13      LD  A,(DTA_CCP+1+8)
00093C DA35 CD22F3          17      CALL    CAP
00093F DA38 D642             7      SUB 'B'
000941 DA3A 282C            12      JR  Z,C_BAT
000943 DA3C 3D               4      DEC A       ;'C'
000944 DA3D 2805            12      JR  Z,C_EXE
       DA3F                     CEXE6:
000946 DA3F CDD9D9          17      CALL    OPEN2
000949 DA42 18E0            12      JR  CEXE5
                                
       DA44                     C_EXE:
00094B DA44 7C               4      LD  A,H
00094C DA45 FE4D             7      CP  'M'
00094E DA47 20F6            12      JR  NZ,CEXE6
                                
000950 DA49 CDDDD9          17      CALL    DEFCB
000953 DA4C CD01DA          17      CALL    S27BUF
000956 DA4F 3D               4      DEC A
000957 DA50 37               4      SCF
000958 DA51 C0              11      RET NZ
000959 DA52 7C               4      LD  A,H
00095A DA53 B5               4      OR  L
00095B DA54 37               4      SCF
00095C DA55 C8              11      RET Z
00095D DA56 CDF1D9          17      CALL    SETDTA1
000960 DA59 110000          10      LD  DE,0                ; self-modifying code
       DA5A                     COMSWC  EQU $-2
000963 DA5C ED7B0600        20      LD  SP,(SYSTEM+1)
000967 DA60 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000968 DA61 6F               4      LD  L,A
000969 DA62 E5              11      PUSH    HL              ; push $0000 (reboot address)
00096A DA63 24               4      INC H
00096B DA64 E5              11      PUSH    HL              ; push $0100 (TPA address)
00096C DA65 C30EDC          10      JP  SETFCB              ; and JP $0100
                                
       DA68                     C_BAT:
00096F DA68 114154          10      LD  DE,'A'+'T'*256
000972 DA6B ED52            15      SBC HL,DE
000974 DA6D 20D0            12      JR  NZ,CEXE6
                                
000976 DA6F CDDDD9          17      CALL    DEFCB
                                
000979 DA72 216AED          10      LD  HL,DTA_CCP
00097C DA75 118FED          10      LD  DE,FCB_BAT
00097F DA78 012500          10      LD  BC,37
000982 DA7B EDB0                    LDIR
       DA7D                     C_BAT1:
000984 DA7D CDEBD9          17      CALL    SETDTA100
000987 DA80 CDB4DA          17      CALL    FGETC_BAT
00098A DA83 218100          10      LD  HL,DTA1+1
00098D DA86 2025            12      JR  NZ,END_BATCH
00098F DA88 FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
000991 DA8A 38F1            12      JR  C,C_BAT1
000993 DA8C 3620            10      LD  (HL),' '
000995 DA8E 23               6      INC HL
       DA8F                     C_BAT2:
000996 DA8F 77               7      LD  (HL),A
000997 DA90 23               6      INC HL
000998 DA91 7D               4      LD  A,L
000999 DA92 3C               4      INC A       ;L==0FFH
00099A DA93 2809            12      JR  Z,RUN_BATCH
00099C DA95 CDB4DA          17      CALL    FGETC_BAT
00099F DA98 2004            12      JR  NZ,RUN_BATCH
0009A1 DA9A FE20             7      CP  020H
0009A3 DA9C 30F1            12      JR  NC,C_BAT2
       DA9E                     RUN_BATCH:
0009A5 DA9E 7D               4      LD  A,L
0009A6 DA9F D67F             7      SUB DTA1-1
0009A8 DAA1 328000          13      LD  (DTA1),A
0009AB DAA4 FE04             7      CP  4
0009AD DAA6 3805            12      JR  C,END_BATCH
0009AF DAA8 3600            10      LD  (HL),0
0009B1 DAAA C357D9          10      JP  COMMAND2
       DAAD                     END_BATCH:
0009B4 DAAD AF               4      XOR A       ;バッチファイルを閉じる
0009B5 DAAE 328FED          13      LD  (FCB_BAT),A
0009B8 DAB1 C300EE          10      JP  CPM_BOOT
                                
       DAB4                     FGETC_BAT:
0009BB DAB4 118FED          10      LD  DE,FCB_BAT
       DAB7                     FGETC:              ;1文字ずつ読み込む
0009BE DAB7 E5              11      PUSH    HL      ;Z:成功
0009BF DAB8 210100          10      LD  HL,1
0009C2 DABB CD0EDA          17      CALL    S27
0009C5 DABE E1              10      POP HL
0009C6 DABF 3A0001          13      LD  A,(00100H)
0009C9 DAC2 C9              10      RET
                                
       DAC3                     C_DEL:
0009CA DAC3 CD0EDC          17      CALL    SETFCB
0009CD DAC6 CD09E3          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
0009D0 DAC9 0E13             7      LD  C,013H
0009D2 DACB 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       DACD                     C_REN:
0009D4 DACD CD0EDC          17      CALL    SETFCB
0009D7 DAD0 3E10             7      LD  A,010H      ;ディレクトリも対象にする
0009D9 DAD2 326900          13      LD  (FCB1+13),A ;属性
0009DC DAD5 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       DAD7                     CDEL1:
0009DE DAD7 115C00          10      LD  DE,FCB1
0009E1 DADA CD0500          17      CALL    SYSTEM
0009E4 DADD C6FF             7      ADD A,0FFH
0009E6 DADF C9              10      RET
                                
       DAE0                     C_DIR:
0009E7 DAE0 CD00F0          17      CALL    FILEC
0009EA DAE3 2115EE          10      LD  HL,FDRV+1
0009ED DAE6 CD24DD          17      CALL    CWILD1
0009F0 DAE9 3EF1             7      LD  A,0F1H
0009F2 DAEB 3221EE          13      LD  (FDRV+13),A
0009F5 DAEE CDC7D9          17      CALL    OPEN1
       DAF1                     CDIR1:
0009F8 DAF1 B7               4      OR  A
0009F9 DAF2 2008            12      JR  NZ,PDSKF
0009FB DAF4 CD3FDB          17      CALL    P_NAME
0009FE DAF7 CDD9D9          17      CALL    OPEN2
000A01 DAFA 18F5            12      JR  CDIR1
       DAFC                     PDSKF:
000A03 DAFC 3A14EE          13      LD  A,(FDRV)
000A06 DAFF 5F               4      LD  E,A
000A07 DB00 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
000A09 DB02 CD0500          17      CALL    SYSTEM
000A0C DB05 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
000A0D DB06 C601             7      ADD A,001H
000A0F DB08 D8              11      RET C       ;Aが0FFHだった場合
000A10 DB09 3E06             7      LD  A,8-2
       DB0B                     PDS1:               ;HL=未使用クラスタの総数
000A12 DB0B 3C               4      INC A
000A13 DB0C CB19             8      RR  C
000A15 DB0E 30FB            12      JR  NC,PDS1
       DB10                     PDS2:               ;B←論理セクタのサイズの上位8ビット
000A17 DB10 3C               4      INC A
000A18 DB11 CB18             8      RR  B
000A1A DB13 30FB            12      JR  NC,PDS2
000A1C DB15 47               4      LD  B,A
                                
000A1D DB16 110000          10      LD  DE,0
       DB19                     PDS3:
000A20 DB19 29              11      ADD HL,HL
000A21 DB1A EB               4      EX  DE,HL
000A22 DB1B ED6A            15      ADC HL,HL
000A24 DB1D EB               4      EX  DE,HL
000A25 DB1E 10F9            13      DJNZ    PDS3
       DB20                     PDSKF1:
000A27 DB20 CDACDB          17      CALL    PRDEC_DEHL
000A2A DB23 11BFED          10      LD  DE,FREE
000A2D DB26 CDD4DD          17      CALL    _SYS09      ;(BDOS)文字列出力
000A30 DB29 CD99DB          17      CALL    PUTDRV
000A33 DB2C 3E5C             7      LD  A,05CH      ;\
000A35 DB2E CDF3E2          17      CALL    MSG_A
000A38 DB31 2A22EE          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
000A3B DB34 AF               4      XOR A
000A3C DB35 11FEFF          10      LD  DE,0-2
000A3F DB38 19              11      ADD HL,DE
000A40 DB39 23               6      INC HL
000A41 DB3A DCA9DB          17      CALL    C,PRDEC_HL
000A44 DB3D 1833            12      JR  LTNL
                                
       DB3F                     P_NAME:
000A46 DB3F 3A6BED          13      LD  A,(DTA_CCP+1)
000A49 DB42 FE2E             7      CP  '.'
000A4B DB44 C8              11      RET Z
                                
000A4C DB45 3A76ED          13      LD  A,(DTA_CCP+1+00BH)
000A4F DB48 F5              11      PUSH    AF
000A50 DB49 CB67             8      BIT 4,A
000A52 DB4B 2808            12      JR  Z,DIR3
000A54 DB4D 11B4ED          10      LD  DE,DIRMES
000A57 DB50 CDD4DD          17      CALL    _SYS09      ;(BDOS)文字列出力
000A5A DB53 180A            12      JR  DIR6
       DB55                     DIR3:
000A5C DB55 ED5B89ED        20      LD  DE,(DTA_CCP+1+01EH)
000A60 DB59 2A87ED          16      LD  HL,(DTA_CCP+1+01CH)
000A63 DB5C CDACDB          17      CALL    PRDEC_DEHL
       DB5F                     DIR6:
000A66 DB5F F1              10      POP AF
000A67 DB60 0F               4      RRCA
000A68 DB61 9F               4      SBC A,A
000A69 DB62 E60A             7      AND '*'-020H
000A6B DB64 C620             7      ADD A,020H
000A6D DB66 CDF3E2          17      CALL    MSG_A
000A70 DB69 CD99DB          17      CALL    PUTDRV
000A73 DB6C 216BED          10      LD  HL,DTA_CCP+1
000A76 DB6F CDECDB          17      CALL    FPRNT
                                
       DB72                     LTNL:
000A79 DB72 1E03             7      LD  E,3
000A7B DB74 C3CDEE          10      JP  _PRINT
                                
       DB77                     C_PATH:
000A7E DB77 CDE2F0          17      CALL    SPCUT
000A81 DB7A 212EED          10      LD  HL,PATHD
000A84 DB7D FE21             7      CP  021H
000A86 DB7F 300C            12      JR  NC,CPATH0
       DB81                     CPATHP:
000A88 DB81 7E               7      LD  A,(HL)
000A89 DB82 23               6      INC HL
000A8A DB83 FE20             7      CP  020H
000A8C DB85 3F               4      CCF
000A8D DB86 30EA            12      JR  NC,LTNL
000A8F DB88 CDF3E2          17      CALL    MSG_A
000A92 DB8B 18F4            12      JR  CPATHP
       DB8D                     CPATH0:
000A94 DB8D FE3B             7      CP  ';'
000A96 DB8F 2001            12      JR  NZ,CPATH1
000A98 DB91 13               6      INC DE
       DB92                     CPATH1:
000A99 DB92 EB               4      EX  DE,HL
000A9A DB93 013B00          10      LD  BC,PATHX
000A9D DB96 EDB0                    LDIR
000A9F DB98 C9              10      RET
                                
       DB99                     PUTDRV:
000AA0 DB99 3A14EE          13      LD  A,(FDRV)
000AA3 DB9C CD15F1          17      CALL    GETDRV1
000AA6 DB9F C641             7      ADD A,'A'
000AA8 DBA1 CDF3E2          17      CALL    MSG_A
000AAB DBA4 3E3A             7      LD  A,':'
       DBA6                     MSG_AR:
000AAD DBA6 C3F3E2          10      JP  MSG_A
                                
       DBA9                     PRDEC_HL:
000AB0 DBA9 AF               4      XOR A
000AB1 DBAA 5F               4      LD  E,A
000AB2 DBAB 57               4      LD  D,A
       DBAC                     PRDEC_DEHL:
000AB3 DBAC D5              11      PUSH    DE
000AB4 DBAD 110FEE          10      LD  DE,DECBF
000AB7 DBB0 0605             7      LD  B,5
000AB9 DBB2 CD43DC          17      CALL    ZERO_MEMORY_DE  ;A=0
000ABC DBB5 D1              10      POP DE
                                
000ABD DBB6 0E20             7      LD  C,32
       DBB8                     DEC1:
000ABF DBB8 29              11      ADD HL,HL
000AC0 DBB9 EB               4      EX  DE,HL
000AC1 DBBA ED6A            15      ADC HL,HL
000AC3 DBBC EB               4      EX  DE,HL
000AC4 DBBD E5              11      PUSH    HL
000AC5 DBBE 2113EE          10      LD  HL,DECBF+4
000AC8 DBC1 0605             7      LD  B,5
       DBC3                     DEC2:
000ACA DBC3 7E               7      LD  A,(HL)
000ACB DBC4 8F               4      ADC A,A
000ACC DBC5 27               4      DAA
000ACD DBC6 77               7      LD  (HL),A
000ACE DBC7 2B               6      DEC HL
000ACF DBC8 10F9            13      DJNZ    DEC2
000AD1 DBCA E1              10      POP HL
000AD2 DBCB 0D               4      DEC C
000AD3 DBCC 20EA            12      JR  NZ,DEC1
                                
000AD5 DBCE 210FEE          10      LD  HL,DECBF
000AD8 DBD1 3E20             7      LD  A,020H
000ADA DBD3 0604             7      LD  B,4
       DBD5                     DEC3:
000ADC DBD5 CDE2DB          17      CALL    DEC4
000ADF DBD8 CDE2DB          17      CALL    DEC4
000AE2 DBDB 23               6      INC HL
000AE3 DBDC 10F7            13      DJNZ    DEC3
       DBDE                     DECX:
000AE5 DBDE CDE2DB          17      CALL    DEC4
000AE8 DBE1 AF               4      XOR A
       DBE2                     DEC4:
000AE9 DBE2 ED6F            18      RLD
000AEB DBE4 FE20             7      CP  020H
000AED DBE6 2802            12      JR  Z,DEC5
000AEF DBE8 F630             7      OR  030H
       DBEA                     DEC5:
000AF1 DBEA 18BA            12      JR  MSG_AR
                                
       DBEC                     FPRNT:
000AF3 DBEC 0608             7      LD  B,8 ;ファイル名を表示
000AF5 DBEE CDFDDB          17      CALL    P_N1
000AF8 DBF1 7E               7      LD  A,(HL)
000AF9 DBF2 CD2EF3          17      CALL    CAP3
000AFC DBF5 D8              11      RET C   ;拡張子が無い
                                
000AFD DBF6 3E2E             7      LD  A,'.'
000AFF DBF8 CDF3E2          17      CALL    MSG_A
000B02 DBFB 0603             7      LD  B,3 ;拡張子を表示
       DBFD                     P_N1:
000B04 DBFD 7E               7      LD  A,(HL)
000B05 DBFE CD2EF3          17      CALL    CAP3
000B08 DC01 3807            12      JR  C,P_N2
000B0A DC03 CDF3E2          17      CALL    MSG_A
000B0D DC06 23               6      INC HL
000B0E DC07 10F4            13      DJNZ    P_N1
000B10 DC09 C9              10      RET
       DC0A                     P_N2:
000B11 DC0A 23               6      INC HL
000B12 DC0B 10FD            13      DJNZ    P_N2
000B14 DC0D C9              10      RET
                                
       DC0E                     SETFCB:
000B15 DC0E CDE2F0          17      CALL    SPCUT
000B18 DC11 1A               7      LD  A,(DE)
000B19 DC12 FE20             7      CP  020H
000B1B DC14 3801            12      JR  C,SETFCBA
000B1D DC16 1B               6      DEC DE
       DC17                     SETFCBA:
000B1E DC17 0624             7      LD  B,36
000B20 DC19 215C00          10      LD  HL,FCB1
000B23 DC1C E5              11      PUSH    HL
000B24 DC1D AF               4      XOR A
000B25 DC1E CDB7F0          17      CALL    FILL_MEMORY
000B28 DC21 E1              10      POP HL
000B29 DC22 D5              11      PUSH    DE
000B2A DC23 CD0EE0          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000B2D DC26 216C00          10      LD  HL,FCB2
000B30 DC29 CD0EE0          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000B33 DC2C E1              10      POP HL
000B34 DC2D 010050          10      LD  BC,05000H
000B37 DC30 118100          10      LD  DE,00081H
       DC33                     SETFCB1:
000B3A DC33 7E               7      LD  A,(HL)
000B3B DC34 23               6      INC HL
000B3C DC35 FE20             7      CP  020H
000B3E DC37 3805            12      JR  C,SETFCB2
000B40 DC39 12               7      LD  (DE),A
000B41 DC3A 13               6      INC DE
000B42 DC3B 0C               4      INC C
000B43 DC3C 10F5            13      DJNZ    SETFCB1
       DC3E                     SETFCB2:
000B45 DC3E 79               4      LD  A,C
000B46 DC3F 328000          13      LD  (DTA1),A
000B49 DC42 04               4      INC B
       DC43                     ZERO_MEMORY_DE:
000B4A DC43 AF               4      XOR A
       DC44                     FILL_MEMORY_DE:
000B4B DC44 12               7      LD  (DE),A
000B4C DC45 13               6      INC DE
000B4D DC46 10FC            13      DJNZ    FILL_MEMORY_DE
000B4F DC48 C9              10      RET
                                
       DC49                     C_COPY:
000B50 DC49 CD0EDC          17      CALL    SETFCB
                                
000B53 DC4C 1161EE          10      LD  DE,ZERO
000B56 DC4F CD03F0          17      CALL    FILEC2
000B59 DC52 216C00          10      LD  HL,FCB2
000B5C DC55 CD15E0          17      CALL    S29X1
                                
000B5F DC58 3E10             7      LD  A,010H
000B61 DC5A 326900          13      LD  (FCB1+13),A
000B64 DC5D 216D00          10      LD  HL,FCB2FN
000B67 DC60 CD24DD          17      CALL    CWILD1
       DC63                     COPY0:
000B6A DC63 CD21DD          17      CALL    CWILD
000B6D DC66 215C00          10      LD  HL,FCB1
000B70 DC69 CDCAD9          17      CALL    OPEN
000B73 DC6C 37               4      SCF
       DC6D                     COPY1:
000B74 DC6D C0              11      RET NZ
000B75 DC6E CDDDD9          17      CALL    DEFCB
                                
000B78 DC71 3A77ED          13      LD  A,(DTA_CCP+13)
000B7B DC74 CB67             8      BIT 4,A
000B7D DC76 2821            12      JR  Z,COPY1A
                                
000B7F DC78 215D00          10      LD  HL,FCB1FN
000B82 DC7B CD46F4          17      CALL    CHKWILD
000B85 DC7E 3814            12      JR  C,COPY9
                                
000B87 DC80 3E20             7      LD  A,020H
000B89 DC82 325D00          13      LD  (FCB1FN),A
000B8C DC85 2A84ED          16      LD  HL,(DTA_CCP+26)
000B8F DC88 23               6      INC HL
000B90 DC89 226A00          16      LD  (FCB1+14),HL
000B93 DC8C 18D5            12      JR  COPY0
                                
       DC8E                     COPY8:
000B95 DC8E CDD4DD          17      CALL    _SYS09      ;(BDOS)文字列出力
000B98 DC91 CD72DB          17      CALL    LTNL
       DC94                     COPY9:
000B9B DC94 CDD9D9          17      CALL    OPEN2
000B9E DC97 18D4            12      JR  COPY1
                                
       DC99                     COPY1A:
000BA0 DC99 216C00          10      LD  HL,FCB2
000BA3 DC9C 1114EE          10      LD  DE,FDRV
000BA6 DC9F 016CED          10      LD  BC,DTA_CCP+2
000BA9 DCA2 EDA0            16      LDI
000BAB DCA4 3E0B             7      LD  A,11
       DCA6                     COPY2:
000BAD DCA6 F5              11      PUSH    AF
000BAE DCA7 7E               7      LD  A,(HL)
000BAF DCA8 FE3F             7      CP  '?'
000BB1 DCAA 2001            12      JR  NZ,COPY3
000BB3 DCAC 0A               7      LD  A,(BC)
       DCAD                     COPY3:
000BB4 DCAD 12               7      LD  (DE),A
000BB5 DCAE 03               6      INC BC
000BB6 DCAF 13               6      INC DE
000BB7 DCB0 23               6      INC HL
000BB8 DCB1 F1              10      POP AF
000BB9 DCB2 3D               4      DEC A
000BBA DCB3 20F1            12      JR  NZ,COPY2
000BBC DCB5 010500          10      LD  BC,16-11
000BBF DCB8 EDB0                    LDIR
       DCBA                     PUTNAME:
000BC1 DCBA 215D00          10      LD  HL,FCB1FN
000BC4 DCBD CD46F4          17      CALL    CHKWILD
000BC7 DCC0 300B            12      JR  NC,PUTN1
000BC9 DCC2 2115EE          10      LD  HL,FDRV+1
000BCC DCC5 CDECDB          17      CALL    FPRNT
000BCF DCC8 3E20             7      LD  A,020H
000BD1 DCCA CDF3E2          17      CALL    MSG_A
       DCCD                     PUTN1:
000BD4 DCCD 1114EE          10      LD  DE,FDRV
000BD7 DCD0 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
000BD9 DCD2 CDF8D9          17      CALL    SYSTEM0
000BDC DCD5 2048            12      JR  NZ,COPYE2
000BDE DCD7 67               4      LD  H,A     ;A=0
000BDF DCD8 6F               4      LD  L,A
000BE0 DCD9 2235EE          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
000BE3 DCDC 2237EE          16      LD  (FDRV+35),HL
       DCDF                     COPY6:
000BE6 DCDF CD01DA          17      CALL    S27BUF
000BE9 DCE2 47               4      LD  B,A
000BEA DCE3 3C               4      INC A
000BEB DCE4 2831            12      JR  Z,COPYE
000BED DCE6 7C               4      LD  A,H
000BEE DCE7 B5               4      OR  L
000BEF DCE8 280C            12      JR  Z,COPY7
000BF1 DCEA 1114EE          10      LD  DE,FDRV
000BF4 DCED 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
000BF6 DCEF CDF8D9          17      CALL    SYSTEM0
000BF9 DCF2 2023            12      JR  NZ,COPYE
000BFB DCF4 10E9            13      DJNZ    COPY6
       DCF6                     COPY7:
000BFD DCF6 3A77ED          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
000C00 DCF9 3221EE          13      LD  (FDRV+13),A
000C03 DCFC 217EED          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
000C06 DCFF 1128EE          10      LD  DE,FDRV+20
000C09 DD02 010400          10      LD  BC,4
000C0C DD05 EDB0                    LDIR
                                
000C0E DD07 1114EE          10      LD  DE,FDRV
000C11 DD0A 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
000C13 DD0C CDF8D9          17      CALL    SYSTEM0
000C16 DD0F 2006            12      JR  NZ,COPYE
                                
000C18 DD11 1171EE          10      LD  DE,OK
000C1B DD14 C38EDC          10      JP  COPY8
                                
       DD17                     COPYE:
000C1E DD17 1114EE          10      LD  DE,FDRV
000C21 DD1A 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
000C23 DD1C CD0500          17      CALL    SYSTEM
       DD1F                     COPYE2:
000C26 DD1F 37               4      SCF
000C27 DD20 C9              10      RET
                                
       DD21                     CWILD:
000C28 DD21 215D00          10      LD  HL,FCB1FN
       DD24                     CWILD1:
000C2B DD24 7E               7      LD  A,(HL)
000C2C DD25 FE20             7      CP  020H
000C2E DD27 C0              11      RET NZ
       DD28                     CWILD2:
000C2F DD28 3E3F             7      LD  A,'?'
000C31 DD2A 060B             7      LD  B,11
000C33 DD2C C3B7F0          10      JP  FILL_MEMORY
                                
       DD2F                     COMTB:
000C36 DD2F 44202020                DB  "D   "  ;1
000C3A DD33 E0DA                    DW  C_DIR
000C3C DD35 44495220                DB  "DIR "  ;2
000C40 DD39 E0DA                    DW  C_DIR
000C42 DD3B 434F5059                DB  "COPY"  ;3
000C46 DD3F 49DC                    DW  C_COPY
000C48 DD41 43442020                DB  "CD  "  ;4
000C4C DD45 FDD9                    DW  C_CD
000C4E DD47 44454C20                DB  "DEL "  ;5
000C52 DD4B C3DA                    DW  C_DEL
000C54 DD4D 50415448                DB  "PATH"  ;6
000C58 DD51 77DB                    DW  C_PATH
000C5A DD53 52454E20                DB  "REN "  ;7
000C5E DD57 CDDA                    DW  C_REN
000C60 DD59 52454D20                DB  "REM "  ;8
000C64 DD5D D1DD                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "88DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   PC-8801mkIISR
                                
                                ;   BANK RAM DISK DRIVER
                                
       DD5F                     BDWT:
000C66 DD5F 3E10             7      LD  A,010H  ;ライト可　リード不可
000C68 DD61 1802            12  JR  BRW
                                
       DD63                     BDRD:
000C6A DD63 3E01             7      LD  A,001H  ;ライト不可　リード可
       DD65                     BRW:
000C6C DD65 F3               4      DI
000C6D DD66 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000C6F DD68 ED739FDD        20      LD  (BANKSP),SP
000C73 DD6C 3AA0DD          13      LD  A,(BANKSPH)
000C76 DD6F 87               4      ADD A,A
000C77 DD70 3803            12      JR  C,BRW1
000C79 DD72 312EED          10      LD  SP,EXTSP    ;拡張メモリにスタックが重なる場合
       DD75                     BRW1:
000C7C DD75 C5              11      PUSH    BC
000C7D DD76 D5              11      PUSH    DE
000C7E DD77 EB               4      EX  DE,HL       ;DE=メインメモリ
000C7F DD78 29              11      ADD HL,HL
000C80 DD79 29              11      ADD HL,HL
000C81 DD7A 7C               4      LD  A,H
000C82 DD7B DD860C          19      ADD A,(IX+DPB_MAXCYL)
000C85 DD7E D3E3            11      OUT (0E3H),A    ;拡張RAM バンク選択
000C87 DD80 65               4      LD  H,L
000C88 DD81 CB3C             8      SRL H   ;/2
000C8A DD83 2E00             7      LD  L,0
000C8C DD85 DBE2            11      IN  A,(0E2H)    ;拡張RAM リード/ライト制御
000C8E DD87 0F               4      RRCA
000C8F DD88 3001            12      JR  NC,BRW2     ;0: リード可
000C91 DD8A EB               4      EX  DE,HL       ;DE=拡張メモリ HL=メインメモリ
       DD8B                     BRW2:
000C92 DD8B 010002          10      LD  BC,512
000C95 DD8E EDB0                    LDIR
                                
000C97 DD90 DBE2            11      IN  A,(0E2H)    ;拡張RAM リード/ライト制御
000C99 DD92 0F               4      RRCA
000C9A DD93 3801            12      JR  C,BRW3      ;1: リード不可
000C9C DD95 EB               4      EX  DE,HL       ;DE=拡張メモリ HL=メインメモリ
       DD96                     BRW3:
000C9D DD96 D1              10      POP DE
000C9E DD97 C1              10      POP BC
000C9F DD98 13               6      INC DE
000CA0 DD99 10DA            13      DJNZ    BRW1
                                
000CA2 DD9B AF               4      XOR A
000CA3 DD9C D3E2            11      OUT (0E2H),A    ;メインメモリに切り替える
000CA5 DD9E 310000          10      LD  SP,0
       DD9F                     BANKSP  EQU $-2
       DDA0                     BANKSPH EQU $-1
000CA8 DDA1 FB               4      EI
000CA9 DDA2 C9              10      RET
                                
[EOF:88DISK2.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       DDA3                     BDOS0:
000CAA DDA3 E5              11      PUSH    HL
000CAB DDA4 79               4      LD  A,C
000CAC DDA5 FE3C             7      CP  03CH
000CAE DDA7 3802            12      JR  C,DOS1
000CB0 DDA9 3E3C             7      LD  A,03CH
       DDAB                     DOS1:
000CB2 DDAB 87               4      ADD A,A
000CB3 DDAC 32B0DD          13      LD  (DOS1_SWC),A
000CB6 DDAF 2A00EF          16      LD  HL,(STABLE)
       DDB0                     DOS1_SWC    EQU $-2
000CB9 DDB2 E3              19      EX  (SP),HL
000CBA DDB3 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
000CBB DDB4 C9              10      RET
       DDB5                     _DOS2:
000CBC DDB5 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000CBE DDB7 CA50E0          10      JP  Z,_SYS5A
000CC1 DDBA FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000CC3 DDBC CA0DE0          10      JP  Z,_SYS5C
000CC6 DDBF FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
000CC8 DDC1 CAA4EA          10      JP  Z,_SYS5F
000CCB DDC4 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000CCD DDC6 200A            12      JR  NZ,_ERROR
000CCF DDC8 011D01          10      LD  BC,VER_6F
000CD2 DDCB 116101          10      LD  DE,VER
000CD5 DDCE 210201          10      LD  HL,MACD
       DDD1                     C_REM:
000CD8 DDD1 AF               4      XOR A
       DDD2                     _ERROR:
000CD9 DDD2 A7               4      AND A
000CDA DDD3 C9              10      RET
                                
       DDD4                     _SYS09:     ;文字列出力
000CDB DDD4 D5              11      PUSH    DE
       DDD5                     _SX09:
000CDC DDD5 1A               7      LD  A,(DE)
000CDD DDD6 13               6      INC DE
000CDE DDD7 FE24             7      CP  '$'
000CE0 DDD9 2831            12      JR  Z,SX0E2
000CE2 DDDB CDF3E2          17      CALL    MSG_A
000CE5 DDDE 18F5            12      JR  _SX09
                                
       DDE0                     MSX1:
000CE7 DDE0 CDF3E2          17      CALL    MSG_A
       DDE3                     MSX:
000CEA DDE3 7E               7      LD  A,(HL)
000CEB DDE4 23               6      INC HL
000CEC DDE5 B7               4      OR  A
000CED DDE6 20F8            12      JR  NZ,MSX1
000CEF DDE8 C9              10      RET
                                
       DDE9                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000CF0 DDE9 212200          10      LD  HL,00022H
000CF3 DDEC 7D               4      LD  A,L
000CF4 DDED C9              10      RET
                                
       DDEE                     _SYS0D:     ;(BDOS)ディスクリセット
000CF5 DDEE CDDFEE          17      CALL    _FFLUSH
000CF8 DDF1 E5              11      PUSH    HL
000CF9 DDF2 218000          10      LD  HL,00080H
000CFC DDF5 228AEE          16      LD  (_DTA),HL
000CFF DDF8 E1              10      POP HL
000D00 DDF9 D5              11      PUSH    DE
000D01 DDFA 1E00             7      LD  E,0
000D03 DDFC 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       DDFD                     _SYS0E:     ;(BDOS)カレントドライブの設定
000D04 DDFD D5              11      PUSH    DE
000D05 DDFE 7B               4      LD  A,E
000D06 DDFF DDE5            15      PUSH    IX
000D08 DE01 CDDCEE          17      CALL    _GETDPB
000D0B DE04 DDE1            14      POP IX
000D0D DE06 3804            12      JR  C,SX0E2
000D0F DE08 7B               4      LD  A,E
000D10 DE09 320400          13      LD  (_DVSW),A
       DE0C                     SX0E2:
000D13 DE0C D1              10      POP DE
000D14 DE0D C9              10      RET
                                
       DE0E                     _SYS0F:     ;(BDOS)ファイルのオープン
000D15 DE0E CDF4F0          17      CALL    SETDRV
000D18 DE11 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000D1B DE14 C602             7      ADD A,002H      ;Write
000D1D DE16 2848            12      JR  Z,FEND0F
000D1F DE18 CD42F4          17      CALL    CHKWILDX
                                
000D22 DE1B D41EF1          17      CALL    NC,SOPENX
       DE1E                     _S16XX:
000D25 DE1E 3840            12      JR  C,FEND0F
                                                ;Directory location
000D27 DE20 3A9FEE          13      LD  A,(_FILEN)
000D2A DE23 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
000D2D DE26 3AA0EE          13      LD  A,(_DIRF)
000D30 DE29 FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000D33 DE2C FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
000D36 DE2F FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
000D39 DE32 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
000D3D DE36 FDE5            15      PUSH    IY
000D3F DE38 D1              10      POP DE
000D40 DE39 13               6      INC DE
000D41 DE3A 010B00          10      LD  BC,11
000D44 DE3D EDB0                    LDIR
                                ;               Attribute
000D46 DE3F 7E               7      LD  A,(HL)
000D47 DE40 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
000D4A DE43 110B00          10      LD  DE,11       ;Reserved
000D4D DE46 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
000D4E DE47 11E4EF          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
000D51 DE4A 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DE4C                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000D53 DE4C 1A               7      LD  A,(DE)
000D54 DE4D 13               6      INC DE
000D55 DE4E 3255DE          13      LD  (S16PAT),A
000D58 DE51 7E               7      LD  A,(HL)
000D59 DE52 23               6      INC HL
000D5A DE53 FD7700          19      LD  (IY+0),A
       DE55                     S16PAT  EQU $-1
000D5D DE56 10F4            13      DJNZ    S16LOOP
                                
000D5F DE58 AF               4      XOR A
000D60 DE59 FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000D63 DE5C FD22FDDE        20      LD  (OFCB_SWC),IY
       DE60                     FEND0F:
000D67 DE60 1845            12      JR  FEND10
                                
       DE62                     _SYS10:     ;(BDOS)ファイルのクローズ
000D69 DE62 CDF4F0          17      CALL    SETDRV
000D6C DE65 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000D6F DE68 D6FE             7      SUB 0FEH
000D71 DE6A 37               4      SCF
000D72 DE6B 3F               4      CCF
000D73 DE6C 2039            12      JR  NZ,FEND10
       DE6E                     _S10A:              ;Write
000D75 DE6E FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000D78 DE71 FD770F          19      LD  (IY+15),A
                                
000D7B DE74 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
000D7E DE77 CD3EF5          17      CALL    SETTMS
                                
000D81 DE7A FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000D84 DE7D 32A0EE          13      LD  (_DIRF),A
000D87 DE80 E67F             7      AND 07FH
000D89 DE82 32C5E7          13      LD  (_SECPS),A
000D8C DE85 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000D8F DE88 FD561F          19      LD  D,(IY+31)
000D92 DE8B CD53F2          17      CALL    READ_DIR
000D95 DE8E 3817            12      JR  C,FEND10
                                
000D97 DE90 3A7EF1          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000D9A DE93 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000D9B DE94 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000D9E DE97 6F               4      LD  L,A
000D9F DE98 2600             7      LD  H,0
000DA1 DE9A 29              11      ADD HL,HL       ;*2
000DA2 DE9B 29              11      ADD HL,HL       ;*4
000DA3 DE9C 29              11      ADD HL,HL       ;*8
000DA4 DE9D 29              11      ADD HL,HL       ;*16
000DA5 DE9E 29              11      ADD HL,HL       ;*32
000DA6 DE9F ED4B7EEF        20      LD  BC,(_DTBUF)
000DAA DEA3 09              11      ADD HL,BC
                                
000DAB DEA4 CD52F4          17      CALL    SDIRENT
       DEA7                     FEND10:
000DAE DEA7 1842            12      JR  FEND
                                
       DEA9                     _SYS11:     ;(BDOS)最初のファイルの検索
000DB0 DEA9 CDF4F0          17      CALL    SETDRV
000DB3 DEAC CD4DF1          17      CALL    SOPEN
       DEAF                     _S12X1:
000DB6 DEAF 383A            12      JR  C,FEND
000DB8 DEB1 CDECF1          17      CALL    SOPENE2
000DBB DEB4 ED5B8AEE        20      LD  DE,(_DTA)
000DBF DEB8 3A88EE          13      LD  A,(_DRV)
000DC2 DEBB 3C               4      INC A
000DC3 DEBC 12               7      LD  (DE),A
000DC4 DEBD D5              11      PUSH    DE
000DC5 DEBE 13               6      INC DE
000DC6 DEBF 012000          10      LD  BC,32
000DC9 DEC2 EDB0                    LDIR
000DCB DEC4 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000DCE DEC7 FD660F          19      LD  H,(IY+15)
000DD1 DECA 22F4EF          16      LD  (SCDIR),HL
000DD4 DECD 2A9AEE          16      LD  HL,(_FBPS)
000DD7 DED0 22F6EF          16      LD  (SFBPS),HL
000DDA DED3 2A9FEE          16      LD  HL,(_FILEN)
000DDD DED6 7C               4      LD  A,H
000DDE DED7 B7               4      OR  A
000DDF DED8 2806            12      JR  Z,_S12DIR
000DE1 DEDA 3AC5E7          13      LD  A,(_SECPS)
000DE4 DEDD F680             7      OR  080H
000DE6 DEDF 67               4      LD  H,A
       DEE0                     _S12DIR:
000DE7 DEE0 22F8EF          16      LD  (SFNDF),HL  ;Directory position and Flags
000DEA DEE3 E1              10      POP HL
000DEB DEE4 1139EE          10      LD  DE,SFILE
000DEE DEE7 0E21             7      LD  C,33
       DEE9                     _S11B:
000DF0 DEE9 EDB0                    LDIR
       DEEB                     FEND:
000DF2 DEEB 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       DEEC                     FENDE:
000DF3 DEEC FDE1            14      POP IY
000DF5 DEEE C1              10      POP BC
000DF6 DEEF D1              10      POP DE
000DF7 DEF0 E1              10      POP HL
000DF8 DEF1 C9              10      RET
                                
       DEF2                     _SYS12:     ;(BDOS)次のファイルの検索
000DF9 DEF2 E5              11      PUSH    HL
000DFA DEF3 D5              11      PUSH    DE
000DFB DEF4 C5              11      PUSH    BC
000DFC DEF5 FDE5            15      PUSH    IY
000DFE DEF7 CDB1F1          17      CALL    NOPEN
000E01 DEFA 18B3            12      JR  _S12X1
                                
       DEFC                     _S16K:
000E03 DEFC 110000          10      LD  DE,0
       DEFD                     OFCB_SWC    EQU $-2
000E06 DEFF D5              11      PUSH    DE
000E07 DF00 061A             7      LD  B,26        ;First cluster
       DF02                     S16K1:
000E09 DF02 13               6      INC DE
000E0A DF03 23               6      INC HL
000E0B DF04 10FC            13      DJNZ    S16K1
                                
000E0D DF06 1A               7      LD  A,(DE)
000E0E DF07 BE               7      CP  (HL)
000E0F DF08 2015            12      JR  NZ,S16K2
000E11 DF0A 13               6      INC DE
000E12 DF0B 23               6      INC HL
000E13 DF0C 1A               7      LD  A,(DE)
000E14 DF0D BE               7      CP  (HL)
000E15 DF0E 200F            12      JR  NZ,S16K2
                                
000E17 DF10 E1              10      POP HL
000E18 DF11 FDE5            15      PUSH    IY
000E1A DF13 D1              10      POP DE
000E1B DF14 7E               7      LD  A,(HL)
000E1C DF15 CD09F1          17      CALL    IS_SAME_DRV_A_DE
000E1F DF18 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000E21 DF1A ED52            15      SBC HL,DE       ;CP HL,DE
000E23 DF1C 37               4      SCF
000E24 DF1D C0              11      RET NZ
000E25 DF1E E5              11      PUSH    HL
       DF1F                     S16K2:
000E26 DF1F E1              10      POP HL
       DF20                     S16K3:
000E27 DF20 FDE5            15      PUSH    IY
000E29 DF22 D1              10      POP DE
       DF23                     _SYS13:     ;(BDOS)ファイルの削除
000E2A DF23 CDF4F0          17      CALL    SETDRV
000E2D DF26 CD78F3          17      CALL    KILL
       DF29                     FEND13:
000E30 DF29 18C0            12      JR  FEND
                                
       DF2B                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000E32 DF2B CDF4F0          17      CALL    SETDRV
000E35 DF2E CDA0F5          17      CALL    INIT_SEQ
       DF31                     SREAD:
000E38 DF31 CDCEF5          17      CALL    RB_READ
                                
000E3B DF34 C601             7      ADD A,001H
000E3D DF36 38B3            12      JR  C,FEND
                                
000E3F DF38 7D               4      LD  A,L
000E40 DF39 D601             7      SUB 001H
       DF3B                     FENDX:
000E42 DF3B 9F               4      SBC A,A
000E43 DF3C E603             7      AND 3
000E45 DF3E 1F               4      RRA
000E46 DF3F 18AB            12      JR  FENDE
                                
       DF41                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000E48 DF41 CDF4F0          17      CALL    SETDRV
000E4B DF44 CDA0F5          17      CALL    INIT_SEQ
       DF47                     SWRITE:
000E4E DF47 CDC7F5          17      CALL    RB_WRITE
                                
000E51 DF4A C6FF             7      ADD A,0FFH
000E53 DF4C 18ED            12      JR  FENDX
                                
       DF4E                     _SYS17:     ;(BDOS)ファイル名の変更
000E55 DF4E CDF4F0          17      CALL    SETDRV
000E58 DF51 CDCEF3          17      CALL    NAME
000E5B DF54 18D3            12      JR  FEND13
                                
       DF56                     _SYS16:     ;(BDOS)ファイルの作成
000E5D DF56 CDF4F0          17      CALL    SETDRV
                                
000E60 DF59 CD42F4          17      CALL    CHKWILDX
000E63 DF5C 38CB            12      JR  C,FEND13
000E65 DF5E FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000E68 DF61 FE05             7      CP  5
000E6A DF63 2805            12      JR  Z,_S16X2
000E6C DF65 FE21             7      CP  021H
000E6E DF67 DA29DF          10      JP  C,FEND13
       DF6A                     _S16X2:
                                ;               Clear FCB
000E71 DF6A FDE5            15      PUSH    IY
000E73 DF6C E1              10      POP HL
000E74 DF6D 011000          10      LD  BC,16
000E77 DF70 09              11      ADD HL,BC
       DF71                     _S16X1:
000E78 DF71 70               7      LD  (HL),B      ;B=0
000E79 DF72 23               6      INC HL
000E7A DF73 0D               4      DEC C
000E7B DF74 20FB            12      JR  NZ,_S16X1
                                
000E7D DF76 CD43F5          17      CALL    SETTMSX
000E80 DF79 FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000E84 DF7D CD1EF1          17      CALL    SOPENX
000E87 DF80 3F               4      CCF
000E88 DF81 CCFCDE          17      CALL    Z,_S16K
000E8B DF84 D4FDF1          17      CALL    NC,COPEN
000E8E DF87 D452F4          17      CALL    NC,SDIRENT
000E91 DF8A C31EDE          10      JP  _S16XX
                                
       DF8D                     _SYS21:     ;(BDOS)ランダムな読み出し
000E94 DF8D CDF4F0          17      CALL    SETDRV
000E97 DF90 CD8EF5          17      CALL    INIT_RND
000E9A DF93 189C            12      JR  SREAD
                                
       DF95                     _SYS22:     ;(BDOS)ランダムな書き込み
       DF95                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000E9C DF95 CDF4F0          17      CALL    SETDRV
000E9F DF98 CD8EF5          17      CALL    INIT_RND
000EA2 DF9B 18AA            12      JR  SWRITE
                                
       DF9D                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000EA4 DF9D 21FF00          10      LD  HL,000FFH
000EA7 DFA0 AF               4      XOR A
000EA8 DFA1 C9              10      RET
                                
       DFA2                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000EA9 DFA2 3A0400          13      LD  A,(_DVSW)
000EAC DFA5 A7               4      AND A
000EAD DFA6 C9              10      RET
                                
       DFA7                     _SYS1A:     ;(BDOS)DTAの設定
000EAE DFA7 ED538AEE        20      LD  (_DTA),DE
000EB2 DFAB AF               4      XOR A
000EB3 DFAC C9              10      RET
                                
       DFAD                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000EB4 DFAD 7B               4      LD  A,E
000EB5 DFAE CD02F1          17      CALL    GETDRV
000EB8 DFB1 CDDCEE          17      CALL    _GETDPB
000EBB DFB4 D4E2EE          17      CALL    NC,_RDFATX
000EBE DFB7 210000          10      LD  HL,0
000EC1 DFBA D41CF5          17      CALL    NC,DSKF
                                
000EC4 DFBD ED5B1DF5        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000EC8 DFC1 1B               6      DEC DE      ;DE←クラスタの総数
000EC9 DFC2 FD2A7CEF        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000ECD DFC6 9F               4      SBC A,A
000ECE DFC7 D8              11      RET C
000ECF DFC8 4F               4      LD  C,A     ;C=0
000ED0 DFC9 DD7E0F          19      LD  A,(IX+DPB_BPS)
000ED3 DFCC E607             7      AND 7
000ED5 DFCE 47               4      LD  B,A
000ED6 DFCF DD7E07          19      LD  A,(IX+DPB_SECPCL)
000ED9 DFD2 C9              10      RET
                                
       DFD3                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000EDA DFD3 AF               4      XOR A
000EDB DFD4 67               4      LD  H,A
000EDC DFD5 6F               4      LD  L,A
000EDD DFD6 C9              10      RET
                                
       DFD7                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000EDE DFD7 2100F6          10      LD  HL,_DEVICE
000EE1 DFDA 7B               4      LD  A,E
000EE2 DFDB C3DCEE          10      JP  _GETDPB
                                
       DFDE                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000EE5 DFDE E5              11      PUSH    HL
000EE6 DFDF 2A1EEF          16      LD  HL,(STABLE+2*00FH)  ;ファイルのオープン
000EE9 DFE2 CD0F00          17      CALL    JP_HL
000EEC DFE5 381B            12      JR  C,_S23X1
                                
000EEE DFE7 D5              11      PUSH    DE      ;EX DE,IY
000EEF DFE8 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000EF1 DFEA FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000EF4 DFED FD6E11          19      LD  L,(IY+17)   ;
000EF7 DFF0 FD6612          19      LD  H,(IY+18)   ;
000EFA DFF3 C5              11      PUSH    BC      ;
000EFB DFF4 FD4613          19      LD  B,(IY+19)   ;
000EFE DFF7 CD80F5          17      CALL    GET_CPM_R_SIZE
000F01 DFFA C1              10      POP BC
       DFFB                     _S24X1:
000F02 DFFB CD0DE6          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000F05 DFFE FDE3            23      EX  (SP),IY     ;
000F07 E000 D1              10      POP DE      ;
                                
000F08 E001 AF               4      XOR A
       E002                     _S23X1:
000F09 E002 E1              10      POP HL
000F0A E003 C9              10      RET
                                
       E004                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000F0B E004 E5              11      PUSH    HL
000F0C E005 D5              11      PUSH    DE      ;EX DE,IY
000F0D E006 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000F0F E008 CDA8F5          17      CALL    GETSEQ
000F12 E00B 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       E00D                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000F14 E00D 2B               6      DEC HL
       E00E                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000F15 E00E C5              11      PUSH    BC
000F16 E00F E5              11      PUSH    HL
000F17 E010 CD0BF0          17      CALL    FILE
000F1A E013 E1              10      POP HL
000F1B E014 C1              10      POP BC
       E015                     S29X1:
000F1C E015 C5              11      PUSH    BC
000F1D E016 D5              11      PUSH    DE
000F1E E017 E5              11      PUSH    HL
000F1F E018 EB               4      EX  DE,HL
000F20 E019 AF               4      XOR A
000F21 E01A 3221EE          13      LD  (FDRV+13),A
000F24 E01D 2114EE          10      LD  HL,FDRV
000F27 E020 011000          10      LD  BC,16
000F2A E023 EDB0                    LDIR
000F2C E025 E1              10      POP HL
000F2D E026 D1              10      POP DE
000F2E E027 C1              10      POP BC
000F2F E028 C9              10      RET
                                
       E029                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000F30 E029 C5              11      PUSH    BC
000F31 E02A 0163E9          10      LD  BC,DWT24B
000F34 E02D 1804            12      JR  S2FX
       E02F                     _SYS2F:
000F36 E02F C5              11      PUSH    BC
000F37 E030 0153E9          10      LD  BC,DRD24B
       E033                     S2FX:
000F3A E033 ED4349E0        20      LD  (S2F_SWC),BC
000F3E E037 CDDFEE          17      CALL    _FFLUSH
                                
000F41 E03A D5              11      PUSH    DE
000F42 E03B E5              11      PUSH    HL
000F43 E03C 7D               4      LD  A,L     ;Drive
000F44 E03D CDD9EE          17      CALL    _CHGDRV
000F47 E040 3809            12      JR  C,S30X2
000F49 E042 44               4      LD  B,H     ;Number of clusters
000F4A E043 2A8AEE          16      LD  HL,(_DTA)
                                
000F4D E046 0E00             7      LD  C,0
000F4F E048 CD53E9          17      CALL    DRD24B
       E049                     S2F_SWC EQU $-2
       E04B                     S30X2:
000F52 E04B E1              10      POP HL
000F53 E04C D1              10      POP DE
000F54 E04D C1              10      POP BC
000F55 E04E 9F               4      SBC A,A
000F56 E04F C9              10      RET
                                
       E050                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000F57 E050 C5              11      PUSH    BC
000F58 E051 D5              11      PUSH    DE
000F59 E052 E5              11      PUSH    HL
000F5A E053 CD00F0          17      CALL    FILEC
000F5D E056 214BE0          10      LD  HL,S30X2
000F60 E059 E5              11      PUSH    HL
000F61 E05A 3A21EE          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
000F64 E05D E610             7      AND 010H        ;ディレクトリ
000F66 E05F C8              11      RET Z
000F67 E060 1114EE          10      LD  DE,FDRV
000F6A E063 2A4EEF          16      LD  HL,(STABLE+2*027H)  ;ランダムブロック読み込み
000F6D E066 E9               4      JP  (HL)
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "88IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   PC-8801mkIISR
                                ;   割り込み処理は0F000Hより前にする
                                
       DDD2                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       DDD2                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       DDD2                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       DDD2                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       DDD2                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       DDD2                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       E067                     BDOS_RF:
000F6E E067 DB32            11      IN  A,(032H)
000F70 E069 F610             7      OR  010H        ;高速RAMアクセスモード/メインRAM
000F72 E06B D332            11      OUT (032H),A
000F74 E06D C3A3DD          10      JP  BDOS0
                                
       E070                     _SYS0A:     ;(BDOS)文字列入力
000F77 E070 C5              11      PUSH    BC
000F78 E071 E5              11      PUSH    HL
000F79 E072 D5              11      PUSH    DE
000F7A E073 CDA9E1          17      CALL    GETL
000F7D E076 1120FF          10      LD  DE,KBUF
000F80 E079 E1              10      POP HL
000F81 E07A E5              11      PUSH    HL
000F82 E07B 0E00             7      LD  C,0
000F84 E07D 3004            12      JR  NC,SAX0
000F86 E07F 23               6      INC HL
000F87 E080 23               6      INC HL
000F88 E081 1808            12      JR  SAX4
       E083                     SAX0:
000F8A E083 46               7      LD  B,(HL)
000F8B E084 23               6      INC HL
       E085                     SAX1:
000F8C E085 23               6      INC HL
000F8D E086 1A               7      LD  A,(DE)
000F8E E087 13               6      INC DE
000F8F E088 B7               4      OR  A
000F90 E089 2004            12      JR  NZ,SAX2
       E08B                     SAX4:
000F92 E08B 360D            10      LD  (HL),00DH
000F94 E08D 1804            12      JR  SAX3
       E08F                     SAX2:
000F96 E08F 77               7      LD  (HL),A
000F97 E090 0C               4      INC C
000F98 E091 10F2            13      DJNZ    SAX1
       E093                     SAX3:
000F9A E093 D1              10      POP DE
000F9B E094 79               4      LD  A,C
000F9C E095 13               6      INC DE
000F9D E096 12               7      LD  (DE),A
000F9E E097 1B               6      DEC DE
000F9F E098 E1              10      POP HL
000FA0 E099 C1              10      POP BC
000FA1 E09A A7               4      AND A
000FA2 E09B C9              10      RET
                                
       E09C                     _SYS2A:     ;(BDOS)日付の獲得
000FA3 E09C C5              11      PUSH    BC
000FA4 E09D CDDCE0          17      CALL    RTCREAD
000FA7 E0A0 3A62EE          13      LD  A,(RTC_YY)
000FAA E0A3 CD47E3          17      CALL    BCD
000FAD E0A6 6F               4      LD  L,A
000FAE E0A7 2600             7      LD  H,0
                                ;   LD  DE,1900     ;0076CH
                                ;   CP  90      ;90以上は1900年代 1990-1999
                                ;   JR  NC,RDDATE1  ;90未満は2000年代 2000-2089
                                ;   LD  E,0D0H      ;2000 & 0FFH D=007H
000FB0 E0A9 11D007          10      LD  DE,2000     ;すべて2000年代で処理 2000-2099
       E0AC                     RDDATE1:
000FB3 E0AC 19              11      ADD HL,DE
000FB4 E0AD 3A63EE          13      LD  A,(RTC_MW)
000FB7 E0B0 57               4      LD  D,A
000FB8 E0B1 3A64EE          13      LD  A,(RTC_DD)
000FBB E0B4 CD47E3          17      CALL    BCD
000FBE E0B7 5F               4      LD  E,A
000FBF E0B8 7A               4      LD  A,D
000FC0 E0B9 0604             7      LD  B,4
       E0BB                     RDDATE2:
000FC2 E0BB CB3A             8      SRL D
000FC4 E0BD 10FC            13      DJNZ    RDDATE2
000FC6 E0BF C1              10      POP BC
000FC7 E0C0 E607             7      AND 7
000FC9 E0C2 C9              10      RET
                                
       E0C3                     _SYS2C:     ;(BDOS)時刻の獲得
000FCA E0C3 C5              11      PUSH    BC
000FCB E0C4 CDDCE0          17      CALL    RTCREAD
000FCE E0C7 3A65EE          13      LD  A,(RTC_TT)
000FD1 E0CA CD47E3          17      CALL    BCD
000FD4 E0CD 67               4      LD  H,A
000FD5 E0CE 3A66EE          13      LD  A,(RTC_MM)
000FD8 E0D1 CD47E3          17      CALL    BCD
000FDB E0D4 6F               4      LD  L,A
000FDC E0D5 3A67EE          13      LD  A,(RTC_SS)
000FDF E0D8 57               4      LD  D,A
000FE0 E0D9 C1              10      POP BC
000FE1 E0DA AF               4      XOR A
000FE2 E0DB C9              10      RET
                                
       E0DC                     RTCREAD:
000FE3 E0DC 0EF9             7      LD  C,0F9H
000FE5 E0DE 3AB9EE          13      LD  A,(WK40)
000FE8 E0E1 5F               4      LD  E,A
000FE9 E0E2 3E03             7      LD  A,3     ;コマンド３：タイムリードにセット
000FEB E0E4 CD0EE1          17      CALL    RTCCMD
000FEE E0E7 3E01             7      LD  A,1     ;コマンド１：レジスタシフトにセット
000FF0 E0E9 CD0EE1          17      CALL    RTCCMD
000FF3 E0EC 0606             7      LD  B,6
000FF5 E0EE 2167EE          10      LD  HL,RTC_SS
       E0F1                     RTCREAD1:
000FF8 E0F1 C5              11      PUSH    BC
000FF9 E0F2 0608             7      LD  B,8
       E0F4                     RTCREAD2:
000FFB E0F4 DB40            11      IN  A,(40H)     ;システムモードセンス BIT4:CDI
000FFD E0F6 87               4      ADD A,A
000FFE E0F7 87               4      ADD A,A
000FFF E0F8 87               4      ADD A,A
001000 E0F9 87               4      ADD A,A
001001 E0FA CB1E            15      RR  (HL)
001003 E0FC CD33E1          17      CALL    RTCCLK
001006 E0FF 10F3            13      DJNZ    RTCREAD2
001008 E101 C1              10      POP BC
001009 E102 2B               6      DEC HL
00100A E103 10EC            13      DJNZ    RTCREAD1
00100C E105 AF               4      XOR A
00100D E106 CD0EE1          17      CALL    RTCCMD
001010 E109 7B               4      LD  A,E
001011 E10A 32B9EE          13      LD  (WK40),A
001014 E10D C9              10      RET
                                
       E10E                     RTCCMD:
001015 E10E 0604             7      LD  B,4
001017 E110 07               4      RLCA
001018 E111 07               4      RLCA
001019 E112 07               4      RLCA
       E113                     RTCCMD1:
00101A E113 F5              11      PUSH    AF
00101B E114 F607             7      OR  7
00101D E116 D310            11      OUT (10H),A     ;プリンタデータ出力 兼 カレンダクロック(μPD1990AC)出力
00101F E118 CD33E1          17      CALL    RTCCLK
001022 E11B F1              10      POP AF
001023 E11C 0F               4      RRCA
001024 E11D 10F4            13      DJNZ    RTCCMD1
001026 E11F 3E07             7      LD  A,7
001028 E121 D310            11      OUT (10H),A     ;プリンタデータ出力 兼 カレンダクロック(μPD1990AC)出力
00102A E123 7B               4      LD  A,E
00102B E124 A1               4      AND C
00102C E125 F602             7      OR  2
00102E E127 D340            11      OUT (40H),A     ;ストローブポート
001030 E129 A1               4      AND C
001031 E12A 00               4      NOP
001032 E12B D340            11      OUT (40H),A     ;ストローブポート
001034 E12D 5F               4      LD  E,A
001035 E12E 060D             7      LD  B,13
       E130                     RTCCMD3:
001037 E130 10FE            13      DJNZ    RTCCMD3
001039 E132 C9              10      RET
                                
       E133                     RTCCLK:
00103A E133 7B               4      LD  A,E
00103B E134 A1               4      AND C
00103C E135 F604             7      OR  04H
00103E E137 D340            11      OUT (40H),A
001040 E139 A1               4      AND C
001041 E13A 00               4      NOP
001042 E13B D340            11      OUT (40H),A
001044 E13D 5F               4      LD  E,A
001045 E13E C9              10      RET
                                
       E13F                     PRINT:
001046 E13F DB32            11      IN  A,(032H)
001048 E141 F5              11      PUSH    AF
001049 E142 E6EF             7      AND 0EFH        ;高速RAMアクセスモード/高速RAM
00104B E144 D332            11      OUT (032H),A
00104D E146 C5              11      PUSH    BC
00104E E147 E5              11      PUSH    HL
00104F E148 3E00             7      LD  A,000H      ;自己書き換え
       E149                     ESCFLG  EQU $-1
001051 E14A B7               4      OR  A
001052 E14B C255F0          10      JP  NZ,ESC
                                
001055 E14E 3E1F             7      LD  A,01FH
001057 E150 BB               4      CP  E
001058 E151 D278F0          10      JP  NC,CTRL
       E154                     INSFLG  EQU $
00105B E154 013AF1          10      LD  BC,INSERT   ;自己書き換え
       E157                     ANK:
00105E E157 CD65E1          17      CALL    LOC0
001061 E15A 73               7      LD  (HL),E
001062 E15B CD89F0          17      CALL    CTRL1C
       E15E                     PRINTE5:
001065 E15E E1              10      POP HL
001066 E15F C1              10      POP BC
001067 E160 F1              10      POP AF
001068 E161 D332            11      OUT (032H),A
00106A E163 AF               4      XOR A
00106B E164 C9              10      RET
                                
       E165                     LOC0:
00106C E165 2A8EEE          16      LD  HL,(_TXADR) ;L=x H=y
       E168                     LOC1:
00106F E168 D5              11      PUSH    DE
001070 E169 7C               4      LD  A,H
001071 E16A CB15             8      RL  L
001073 E16C CB3C             8      SRL H   ;*128
001075 E16E CB1D             8      RR  L
                                
001077 E170 87               4      ADD A,A ;*2
001078 E171 87               4      ADD A,A ;*4
001079 E172 87               4      ADD A,A ;*8
00107A E173 5F               4      LD  E,A
00107B E174 7D               4      LD  A,L
00107C E175 93               4      SUB E
00107D E176 5F               4      LD  E,A
                                
00107E E177 9F               4      SBC A,A
00107F E178 84               4      ADD A,H
001080 E179 57               4      LD  D,A
                                
001081 E17A 2AB2EE          16      LD  HL,(TVRAMTOP)
001084 E17D 19              11      ADD HL,DE
001085 E17E D1              10      POP DE
001086 E17F C9              10      RET
                                
       E180                     CONOUT1:
001087 E180 59               4      LD  E,C
001088 E181 CDCDEE          17      CALL    _PRINT
00108B E184 7B               4      LD  A,E
00108C E185 FE0A             7      CP  00AH
00108E E187 2006            12      JR  NZ,CURSOR_ON
001090 E189 CD0DF1          17      CALL    CTRL0D
001093 E18C CDF8F0          17      CALL    CTRL05
       E18F                     CURSOR_ON:
001096 E18F F5              11      PUSH    AF
001097 E190 3E81             7      LD  A,081H
       E192                     CURSOR0:
001099 E192 D351            11      OUT (051H),A
00109B E194 3A8EEE          13      LD  A,(_TXADR)
00109E E197 D350            11      OUT (050H),A
0010A0 E199 3A8FEE          13      LD  A,(_TXADR+1)
0010A3 E19C D350            11      OUT (050H),A
0010A5 E19E F1              10      POP AF
0010A6 E19F C9              10      RET
       E1A0                     CURSOR_OFF:
0010A7 E1A0 F5              11      PUSH    AF
0010A8 E1A1 3E80             7      LD  A,080H
0010AA E1A3 18ED            12      JR  CURSOR0
                                
       E1A5                     POS:
0010AC E1A5 2A8EEE          16      LD  HL,(_TXADR)
0010AF E1A8 C9              10      RET
                                
       E1A9                     GETL:
0010B0 E1A9 CDD3EE          17      CALL    _POS
0010B3 E1AC E5              11      PUSH    HL
0010B4 E1AD 3ECD             7      LD  A,0CDH      ;CALL ????
0010B6 E1AF 3254E1          13      LD  (INSFLG),A
       E1B2                     GETL1:
0010B9 E1B2 CD09E3          17      CALL    _SYS08
0010BC E1B5 FE09             7      CP  9
0010BE E1B7 2008            12      JR  NZ,GETL1V
0010C0 E1B9 2120FF          10      LD  HL,KBUF
0010C3 E1BC CDE3DD          17      CALL    MSX
0010C6 E1BF 18F1            12      JR  GETL1
       E1C1                     GETL1V:
0010C8 E1C1 5F               4      LD  E,A
0010C9 E1C2 CDCDEE          17      CALL    _PRINT
                                
0010CC E1C5 7B               4      LD  A,E
0010CD E1C6 FE0D             7      CP  00DH
0010CF E1C8 20E8            12      JR  NZ,GETL1
0010D1 E1CA 3E01             7      LD  A,1     ;LD BC,????
0010D3 E1CC 3254E1          13      LD  (INSFLG),A
0010D6 E1CF 1120FF          10      LD  DE,KBUF
0010D9 E1D2 3AB1EE          13      LD  A,(_WIDTH)
0010DC E1D5 47               4      LD  B,A
0010DD E1D6 CD43DC          17      CALL    ZERO_MEMORY_DE
                                
0010E0 E1D9 D1              10      POP DE
0010E1 E1DA CDD3EE          17      CALL    _POS
0010E4 E1DD 6B               4      LD  L,E
0010E5 E1DE 3AB1EE          13      LD  A,(_WIDTH)
0010E8 E1E1 95               4      SUB L
0010E9 E1E2 57               4      LD  D,A
0010EA E1E3 CD68E1          17      CALL    LOC1
0010ED E1E6 4D               4      LD  C,L
0010EE E1E7 7C               4      LD  A,H
0010EF E1E8 F630             7      OR  030H
0010F1 E1EA 47               4      LD  B,A
0010F2 E1EB 5A               4      LD  E,D
0010F3 E1EC 2120FF          10      LD  HL,KBUF
       E1EF                     GETL2:
0010F6 E1EF CDD0EE          17      CALL    _SCRN
0010F9 E1F2 03               6      INC BC
0010FA E1F3 77               7      LD  (HL),A
0010FB E1F4 23               6      INC HL
0010FC E1F5 1D               4      DEC E
0010FD E1F6 20F7            12      JR  NZ,GETL2
       E1F8                     GETL3:
0010FF E1F8 2B               6      DEC HL
001100 E1F9 7E               7      LD  A,(HL)
001101 E1FA FE21             7      CP  021H
001103 E1FC D0              11      RET NC
001104 E1FD 3600            10      LD  (HL),0
001106 E1FF 15               4      DEC D
001107 E200 20F6            12      JR  NZ,GETL3
001109 E202 C9              10      RET
                                
       E203                     INKEY:
00110A E203 FB               4      EI
00110B E204 E5              11      PUSH    HL
00110C E205 2A90EE          16      LD  HL,(_KEYPS)
00110F E208 7C               4      LD  A,H
001110 E209 AD               4      XOR L
001111 E20A 280C            12      JR  Z,INKEY1
001113 E20C 7C               4      LD  A,H
001114 E20D 3C               4      INC A
001115 E20E E61F             7      AND 01FH
001117 E210 3291EE          13      LD  (_KEYPS+1),A
00111A E213 6F               4      LD  L,A
00111B E214 26FF             7      LD  H,KEYBF/256
00111D E216 7E               7      LD  A,(HL)
00111E E217 B7               4      OR  A
       E218                     INKEY1:
00111F E218 E1              10      POP HL
001120 E219 C9              10      RET
                                
       E21A                     CHKEY:
001121 E21A C5              11      PUSH    BC
001122 E21B DB32            11      IN  A,(032H)
001124 E21D F5              11      PUSH    AF
001125 E21E E6EF             7      AND 0EFH        ;高速RAMアクセスモード/高速RAM
001127 E220 D332            11      OUT (032H),A
001129 E222 DB08            11      IN  A,(8)       ;6:SHIFT,7:CTRL
00112B E224 4F               4      LD  C,A
00112C E225 3A0E00          13      LD  A,(00EH)
00112F E228 CB5F             8      BIT 3,A
001131 E22A 2002            12      JR  NZ,CHKEYRSHIFT
001133 E22C CBB1             8      RES 6,C
       E22E                     CHKEYRSHIFT:
001135 E22E 79               4      LD  A,C
001136 E22F 3293EE          13      LD  (_KEYD+1),A
001139 E232 E5              11      PUSH    HL
00113A E233 0E00             7      LD  C,0
00113C E235 21BFF1          10      LD  HL,KEY_TABLE
00113F E238 CB77             8      BIT 6,A
001141 E23A 2003            12      JR  NZ,CHKEY0
001143 E23C 2127F2          10      LD  HL,SHIFT_TABLE
       E23F                     CHKEY0:
001146 E23F CB7F             8      BIT 7,A
001148 E241 2003            12      JR  NZ,CHKEY1
00114A E243 218FF2          10      LD  HL,CTRL_TABLE
       E246                     CHKEY1:
00114D E246 ED78            12      IN  A,(C)
00114F E248 0608             7      LD  B,8
       E24A                     CHKEY2:
001151 E24A 0F               4      RRCA
001152 E24B 300B            12      JR  NC,CHKEY4
       E24D                     CHKEY3:
001154 E24D 23               6      INC HL
001155 E24E 10FA            13      DJNZ    CHKEY2
001157 E250 0C               4      INC C
001158 E251 79               4      LD  A,C
001159 E252 D60D             7      SUB 00DH
00115B E254 20F0            12      JR  NZ,CHKEY1
00115D E256 1804            12      JR  CHKEY5
       E258                     CHKEY4:
00115F E258 7E               7      LD  A,(HL)
001160 E259 B7               4      OR  A
001161 E25A 28F1            12      JR  Z,CHKEY3
       E25C                     CHKEY5:
001163 E25C E1              10      POP HL
001164 E25D C1              10      POP BC
001165 E25E 4F               4      LD  C,A
001166 E25F 78               4      LD  A,B
001167 E260 D332            11      OUT (032H),A
001169 E262 79               4      LD  A,C
00116A E263 C1              10      POP BC
00116B E264 B7               4      OR  A
00116C E265 3292EE          13      LD  (_KEYD),A
00116F E268 C9              10      RET
                                
       E269                     SCRN:
001170 E269 E5              11      PUSH    HL
001171 E26A DB32            11      IN  A,(032H)
001173 E26C 67               4      LD  H,A
001174 E26D E6EF             7      AND 0EFH        ;高速RAMアクセスモード/高速RAM
001176 E26F D332            11      OUT (032H),A
001178 E271 0A               7      LD  A,(BC)
001179 E272 6F               4      LD  L,A
00117A E273 7C               4      LD  A,H
00117B E274 D332            11      OUT (032H),A
00117D E276 7D               4      LD  A,L
00117E E277 E1              10      POP HL
00117F E278 C9              10      RET
                                
       E279                     VBLANK:
001180 E279 F5              11      PUSH    AF
       E27A                     VBLANK0:
001181 E27A DB40            11      IN  A,(040H)
001183 E27C E620             7      AND 020H
001185 E27E 20FA            12      JR  NZ,VBLANK0
       E280                     VBLANK1:
001187 E280 DB40            11      IN  A,(040H)
001189 E282 E620             7      AND 020H
00118B E284 28FA            12      JR  Z,VBLANK1
00118D E286 F1              10      POP AF
00118E E287 C9              10      RET
                                
       E288                     INTVRTC:
00118F E288 F3               4      DI
001190 E289 F5              11      PUSH    AF
001191 E28A CD1AE2          17      CALL    CHKEY
001194 E28D FE00             7      CP  0
       E28E                     KEYDT   EQU $-1
001196 E28F 2028            12      JR  NZ,SETKEY1
001198 E291 E5              11      PUSH    HL
001199 E292 2A90EE          16      LD  HL,(_KEYPS)
00119C E295 7C               4      LD  A,H
00119D E296 AD               4      XOR L
00119E E297 E1              10      POP HL
00119F E298 2011            12      JR  NZ,ENDKEY
0011A1 E29A 3E00             7      LD  A,0
       E29B                     KEYAR   EQU $-1
0011A3 E29C B7               4      OR  A
0011A4 E29D 2014            12      JR  NZ,ARWKEY
       E29F                     SETKEY:
0011A6 E29F 329BE2          13      LD  (KEYAR),A
0011A9 E2A2 3A92EE          13      LD  A,(_KEYD)
0011AC E2A5 328EE2          13      LD  (KEYDT),A
0011AF E2A8 CDC6E2          17      CALL    KEYSET
       E2AB                     ENDKEY:
0011B2 E2AB 3AB7EE          13      LD  A,(WKE4)
0011B5 E2AE D3E4            11      OUT (0E4H),A
0011B7 E2B0 F1              10      POP AF
0011B8 E2B1 FB               4      EI
0011B9 E2B2 C9              10      RET
       E2B3                     ARWKEY:
0011BA E2B3 3D               4      DEC A
0011BB E2B4 329BE2          13      LD  (KEYAR),A
0011BE E2B7 18F2            12      JR  ENDKEY
       E2B9                     SETKEY1:
0011C0 E2B9 3A95EE          13      LD  A,(_KEYSP+1)
0011C3 E2BC 18E1            12      JR  SETKEY
                                
       E2BE                     INTE88:
0011C5 E2BE F5              11      PUSH    AF
0011C6 E2BF 3AB7EE          13      LD  A,(WKE4)
0011C9 E2C2 D3E4            11      OUT (0E4H),A
0011CB E2C4 F1              10      POP AF
0011CC E2C5 C9              10      RET
       E2C6                     KEYSET:
       E2C6                     KEYBS:
0011CD E2C6 B7               4      OR  A
0011CE E2C7 C8              11      RET Z
       E2C8                     KEYBS1:
0011CF E2C8 CDE0E2          17      CALL    KEYBC_IFBREAK
0011D2 E2CB E5              11      PUSH    HL
0011D3 E2CC F5              11      PUSH    AF
0011D4 E2CD 2A90EE          16      LD  HL,(_KEYPS)
0011D7 E2D0 2C               4      INC L
0011D8 E2D1 CBAD             8      RES 5,L
0011DA E2D3 7D               4      LD  A,L
0011DB E2D4 BC               4      CP  H
0011DC E2D5 2815            12      JR  Z,POP_AF_HL_SCF_RET
0011DE E2D7 3290EE          13      LD  (_KEYPS),A
0011E1 E2DA 26FF             7      LD  H,KEYBF/256
0011E3 E2DC F1              10      POP AF
0011E4 E2DD 77               7      LD  (HL),A
0011E5 E2DE E1              10      POP HL
0011E6 E2DF C9              10      RET
       E2E0                     KEYBC_IFBREAK:
0011E7 E2E0 FE03             7      CP  3
0011E9 E2E2 C0              11      RET NZ
       E2E3                     KEYBC:
0011EA E2E3 E5              11      PUSH    HL
0011EB E2E4 210000          10      LD  HL,0
0011EE E2E7 2290EE          16      LD  (_KEYPS),HL
0011F1 E2EA E1              10      POP HL
0011F2 E2EB C9              10      RET
                                
       E2EC                     POP_AF_HL_SCF_RET:
0011F3 E2EC F1              10      POP AF
0011F4 E2ED E1              10      POP HL
0011F5 E2EE 37               4      SCF
0011F6 E2EF C9              10      RET
                                
       E2F0                     _SYS01:     ;(BDOS)コンソール入力
0011F7 E2F0 CD09EE          17      CALL    _SYS07
       E2F3                     MSG_A:
0011FA E2F3 F5              11      PUSH    AF
0011FB E2F4 D5              11      PUSH    DE
0011FC E2F5 5F               4      LD  E,A
0011FD E2F6 CDFCE2          17      CALL    _SYS02
001200 E2F9 D1              10      POP DE
001201 E2FA F1              10      POP AF
001202 E2FB C9              10      RET
                                
       E2FC                     _SYS02:     ;(BDOS)コンソール出力
001203 E2FC CD0EE3          17      CALL    BREAK
001206 E2FF 1805            12      JR  PRINTX
                                
       E301                     _SYS06:     ;(BDOS)コンソール直接入出力
001208 E301 7B               4      LD  A,E
001209 E302 3C               4      INC A
00120A E303 CACAEE          10      JP  Z,_INKEY
       E306                     PRINTX:
00120D E306 C3CDEE          10      JP  _PRINT
                                
       E309                     _SYS08:     ;(BDOS)エコーなしコンソール入力
001210 E309 CD09EE          17      CALL    _SYS07
001213 E30C 1804            12      JR  BREAK1
       E30E                     BREAK:
001215 E30E FB               4      EI
001216 E30F 3A92EE          13      LD  A,(_KEYD)
       E312                     BREAK1:
001219 E312 FE03             7      CP  3       ;CTRL+C
00121B E314 CA00EE          10      JP  Z,CPM_BOOT
00121E E317 FE13             7      CP  013H        ;CTRL+S
001220 E319 C0              11      RET NZ
                                
       E31A                     PAUSE:
001221 E31A CDE3E2          17      CALL    KEYBC
                                
       E31D                     FLGET:
001224 E31D CDDFEE          17      CALL    _FFLUSH
001227 E320 E5              11      PUSH    HL
001228 E321 2A8EEE          16      LD  HL,(_TXADR)
00122B E324 CD8FE1          17      CALL    CURSOR_ON
       E327                     FLGET1:
00122E E327 CDCAEE          17      CALL    _INKEY
001231 E32A 28FB            12      JR  Z,FLGET1
001233 E32C CDA0E1          17      CALL    CURSOR_OFF
001236 E32F E1              10      POP HL
001237 E330 C9              10      RET
                                
       E331                     _SYS0B:     ;(BDOS)コンソール状態のチェック
001238 E331 CD0EE3          17      CALL    BREAK
00123B E334 3A92EE          13      LD  A,(_KEYD)
00123E E337 B7               4      OR  A
00123F E338 C8              11      RET Z
       E339                     CONSTX:
001240 E339 CDDFEE          17      CALL    _FFLUSH
001243 E33C E5              11      PUSH    HL
001244 E33D 2A90EE          16      LD  HL,(_KEYPS)
001247 E340 7C               4      LD  A,H
001248 E341 AD               4      XOR L
001249 E342 E1              10      POP HL
00124A E343 C6FF             7      ADD A,0FFH
00124C E345 9F               4      SBC A,A
00124D E346 C9              10      RET
                                
                                ;------------------------
                                ;BCDの10進数化
                                ;in
                                ;   A  : BCD
                                ;out
                                ;   A  : 10進数
                                ;------------------------
       E347                     BCD:
00124E E347 4F               4      LD  C,A
00124F E348 E6F0             7      AND 0F0H    ;10の位
001251 E34A 0F               4      RRCA
001252 E34B 47               4      LD  B,A
001253 E34C 0F               4      RRCA
001254 E34D 0F               4      RRCA
001255 E34E 80               4      ADD A,B
001256 E34F 47               4      LD  B,A
001257 E350 79               4      LD  A,C
001258 E351 E60F             7      AND 00FH    ;1の位
00125A E353 80               4      ADD A,B
00125B E354 C9              10      RET
[EOF:88IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E355                     _SYS26:     ;(BDOS)ランダムブロック書き込み
00125C E355 AF               4      XOR A
00125D E356 324EE6          13      LD  (DRDN1),A   ;NOP
001260 E359 227AE5          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
001263 E35C 225DEE          16      LD  (LEFTX),HL
001266 E35F CDF4F0          17      CALL    SETDRV
                                
001269 E362 CDD2E4          17      CALL    RBX0
00126C E365 DAF2E3          10      JP  C,RBWERR
00126F E368 CD7CF4          17      CALL    WOPEN
001272 E36B DAF2E3          10      JP  C,RBWERR
001275 E36E 7C               4      LD  A,H
001276 E36F B5               4      OR  L
001277 E370 CAEBE3          10      JP  Z,RBW1
                                
00127A E373 2B               6      DEC HL
                                
00127B E374 CD90E5          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
00127E E377 19              11      ADD HL,DE       ;BCHL=HL+BCDE
00127F E378 3001            12      JR  NC,S26X1    ;
001281 E37A 03               6      INC BC      ;
       E37B                     S26X1:
001282 E37B CDE7F4          17      CALL    RWXR
001285 E37E DC8DF4          17      CALL    C,WRDFX
001288 E381 DAF2E3          10      JP  C,RBWERR
                                
00128B E384 CD01E5          17      CALL    RBX2
00128E E387 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
001290 E389 CD20E5          17      CALL    RBXA
001293 E38C 3864            12      JR  C,RBWERR
001295 E38E EB               4      EX  DE,HL
001296 E38F C5              11      PUSH    BC
001297 E390 EDB0                    LDIR
001299 E392 225FEE          16      LD  (DTAX),HL
                                
00129C E395 CD1CF4          17      CALL    WTDB        ;バッファデータは更新された
                                
00129F E398 2A5DEE          16      LD  HL,(LEFTX)
0012A2 E39B D1              10      POP DE
0012A3 E39C ED52            15      SBC HL,DE
0012A5 E39E 225DEE          16      LD  (LEFTX),HL
0012A8 E3A1 2831            12      JR  Z,RBWEND
                                
       E3A3                     RBWB:
0012AA E3A3 CD55E5          17      CALL    RBXB
0012AD E3A6 2814            12      JR  Z,RBWC
       E3A8                     RBWB1:
0012AF E3A8 C5              11      PUSH    BC
0012B0 E3A9 D5              11      PUSH    DE
0012B1 E3AA CDFDF2          17      CALL    CLUSTX
0012B4 E3AD CDA4E5          17      CALL    DWTC
0012B7 E3B0 D1              10      POP DE
0012B8 E3B1 C1              10      POP BC
0012B9 E3B2 D4CDE7          17      CALL    NC,GNCLX
0012BC E3B5 383B            12      JR  C,RBWERR
0012BE E3B7 10EF            13      DJNZ    RBWB1
0012C0 E3B9 CDF4E5          17      CALL    DRW_FLUSH
       E3BC                     RBWC:
0012C3 E3BC CD6DE5          17      CALL    RBXC
0012C6 E3BF 2813            12      JR  Z,RBWEND
0012C8 E3C1 C5              11      PUSH    BC
0012C9 E3C2 CDFDF2          17      CALL    CLUSTX
0012CC E3C5 CD4DE6          17      CALL    DRDN
0012CF E3C8 C1              10      POP BC
0012D0 E3C9 3827            12      JR  C,RBWERR
0012D2 E3CB ED5B7EEF        20      LD  DE,(_DTBUF)
0012D6 E3CF EDB0                    LDIR
0012D8 E3D1 CD1CF4          17      CALL    WTDB        ;バッファデータは更新された
       E3D4                     RBWEND:
0012DB E3D4 CD79E5          17      CALL    RBXEND
                                
0012DE E3D7 CDE1E4          17      CALL    RBX1
0012E1 E3DA 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
0012E3 E3DC CD90E5          17      CALL    GET_RR_BCDE ;BCDE=Random record
0012E6 E3DF FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
0012E9 E3E2 FD7211          19      LD  (IY+17),D   ;
0012EC E3E5 FD7112          19      LD  (IY+18),C   ;
0012EF E3E8 FD7013          19      LD  (IY+19),B   ;
       E3EB                     RBW1:
0012F2 E3EB FDE1            14      POP IY
0012F4 E3ED C1              10      POP BC
0012F5 E3EE D1              10      POP DE
0012F6 E3EF E1              10      POP HL
       E3F0                     DD_NUL:
0012F7 E3F0 AF               4      XOR A
       E3F1                     DRDF0:
       E3F1                     DWTF0:
0012F8 E3F1 C9              10      RET
                                
       E3F2                     RBWERR:
0012F9 E3F2 FDE5            15      PUSH    IY
0012FB E3F4 D1              10      POP DE
0012FC E3F5 2A20EF          16      LD  HL,(STABLE+2*010H)
0012FF E3F8 CD0F00          17      CALL    JP_HL
       E3FB                     RBRERR1:
001302 E3FB 3E01             7      LD  A,001H
       E3FD                     RBRERR2:
001304 E3FD FDE1            14      POP IY
001306 E3FF C1              10      POP BC
001307 E400 D1              10      POP DE
001308 E401 E1              10      POP HL
001309 E402 37               4      SCF
00130A E403 210000          10      LD  HL,0
00130D E406 C9              10      RET
                                
       E407                     RBRERR:
00130E E407 3EFF             7      LD  A,0FFH
001310 E409 18F2            12      JR  RBRERR2
                                
       E40B                     RBRFL:
001312 E40B 3E00             7  RBRFLP: LD  A,000H
001314 E40D FE0D             7      CP  00DH
001316 E40F 2005            12      JR  NZ,RBRFL1
001318 E411 D5              11      PUSH    DE
001319 E412 1E0A             7      LD  E,00AH
00131B E414 1805            12      JR  RBRFL2
       E416                     RBRFL1:
00131D E416 D5              11      PUSH    DE
00131E E417 CD09EE          17      CALL    _SYS07
001321 E41A 5F               4      LD  E,A
       E41B                     RBRFL2:
001322 E41B CDCDEE          17      CALL    _PRINT
001325 E41E 7B               4      LD  A,E
001326 E41F D1              10      POP DE
001327 E420 320CE4          13      LD  (RBRFLP+1),A
00132A E423 C9              10      RET
       E424                     DDX:
00132B E424 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
00132E E427 CD22F3          17      CALL    CAP
001331 E42A FE41             7      CP  'A'
001333 E42C C9              10      RET
                                
                                                ;Read random block
       E42D                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001334 E42D 225DEE          16      LD  (LEFTX),HL
001337 E430 CDF4F0          17      CALL    SETDRV
                                
00133A E433 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
00133E E437 C2C0E4          10      JP  NZ,RBRDIR   ;ディレクトリ
001341 E43A CDD2E4          17      CALL    RBX0
001344 E43D DA07E4          10      JP  C,RBRERR
001347 E440 CDE1E4          17      CALL    RBX1
00134A E443 D4F9E4          17      CALL    NC,RBX1R
00134D E446 DAFBE3          10      JP  C,RBRERR1
001350 E449 EB               4      EX  DE,HL
001351 E44A ED52            15      SBC HL,DE       ;CP 00HL,BCDE
001353 E44C 19              11      ADD HL,DE
001354 E44D 79               4      LD  A,C
001355 E44E DE00             7      SBC A,0
001357 E450 78               4      LD  A,B
001358 E451 DE00             7      SBC A,0
00135A E453 3801            12      JR  C,RBR1
00135C E455 EB               4      EX  DE,HL
       E456                     RBR1:
00135D E456 9F               4      SBC A,A
00135E E457 E601             7      AND 1
001360 E459 32BEE4          13      LD  (RBRA_SWC),A
                                
001363 E45C 7C               4      LD  A,H
001364 E45D B5               4      OR  L
001365 E45E 2857            12      JR  Z,RBREND0
                                
001367 E460 227AE5          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
00136A E463 225DEE          16      LD  (LEFTX),HL
                                
00136D E466 CD01E5          17      CALL    RBX2
001370 E469 2819            12      JR  Z,RBRB
001372 E46B CD20E5          17      CALL    RBXA
001375 E46E DA07E4          10      JP  C,RBRERR
001378 E471 C5              11      PUSH    BC
001379 E472 EDB0                    LDIR
00137B E474 ED535FEE        20      LD  (DTAX),DE
00137F E478 2A5DEE          16      LD  HL,(LEFTX)
001382 E47B D1              10      POP DE
001383 E47C A7               4      AND A
001384 E47D ED52            15      SBC HL,DE
001386 E47F 225DEE          16      LD  (LEFTX),HL
001389 E482 2830            12      JR  Z,RBREND
                                
       E484                     RBRB:
00138B E484 CD55E5          17      CALL    RBXB
00138E E487 2815            12      JR  Z,RBRC
       E489                     RBRB1:
001390 E489 C5              11      PUSH    BC
001391 E48A D5              11      PUSH    DE
001392 E48B CDFDF2          17      CALL    CLUSTX
001395 E48E CDAAE5          17      CALL    DRDC
001398 E491 D1              10      POP DE
001399 E492 C1              10      POP BC
00139A E493 D4CDE7          17      CALL    NC,GNCLX
00139D E496 DA07E4          10      JP  C,RBRERR
0013A0 E499 10EE            13      DJNZ    RBRB1
0013A2 E49B CDF4E5          17      CALL    DRW_FLUSH
       E49E                     RBRC:
0013A5 E49E CD6DE5          17      CALL    RBXC
0013A8 E4A1 2811            12      JR  Z,RBREND
0013AA E4A3 C5              11      PUSH    BC
0013AB E4A4 CDFDF2          17      CALL    CLUSTX
0013AE E4A7 CD31E6          17      CALL    DRDX
0013B1 E4AA C1              10      POP BC
0013B2 E4AB DA07E4          10      JP  C,RBRERR
0013B5 E4AE EB               4      EX  DE,HL
0013B6 E4AF 2A7EEF          16      LD  HL,(_DTBUF)
0013B9 E4B2 EDB0                    LDIR
       E4B4                     RBREND:
0013BB E4B4 CD79E5          17      CALL    RBXEND
       E4B7                     RBREND0:
0013BE E4B7 FDE1            14      POP IY
0013C0 E4B9 C1              10      POP BC
0013C1 E4BA D1              10      POP DE
0013C2 E4BB F1              10      POP AF  ;(HL)
0013C3 E4BC AF               4      XOR A
0013C4 E4BD 3E00             7      LD  A,000H
       E4BE                     RBRA_SWC    EQU $-1
0013C6 E4BF C9              10      RET
                                
       E4C0                     RBRDIR:
0013C7 E4C0 FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0013CA E4C3 FD661B          19      LD  H,(IY+27)
0013CD E4C6 CD38F3          17      CALL    CHDIR
0013D0 E4C9 AF               4      XOR A
0013D1 E4CA 67               4      LD  H,A
0013D2 E4CB 6F               4      LD  L,A
0013D3 E4CC 3C               4      INC A
0013D4 E4CD 32BEE4          13      LD  (RBRA_SWC),A
0013D7 E4D0 18E5            12      JR  RBREND0
                                
       E4D2                     RBX0:
0013D9 E4D2 2A8AEE          16      LD  HL,(_DTA)
0013DC E4D5 225FEE          16      LD  (DTAX),HL
0013DF E4D8 2A5DEE          16      LD  HL,(LEFTX)
0013E2 E4DB FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0013E5 E4DE D6FD             7      SUB 0FDH
0013E7 E4E0 C9              10      RET
                                
       E4E1                     RBX1:               ;ファイルサイズとランダムレコードを比べる
0013E8 E4E1 E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
0013E9 E4E2 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
0013EC E4E5 FD6611          19      LD  H,(IY+17)   ;
0013EF E4E8 FD7E12          19      LD  A,(IY+18)   ;
                                
0013F2 E4EB CD90E5          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0013F5 E4EE A7               4      AND A
0013F6 E4EF ED52            15      SBC HL,DE
0013F8 E4F1 99               4      SBC A,C
0013F9 E4F2 4F               4      LD  C,A
0013FA E4F3 FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
0013FD E4F6 98               4      SBC A,B
0013FE E4F7 D1              10      POP DE
0013FF E4F8 C9              10      RET
       E4F9                     RBX1R:
001400 E4F9 47               4      LD  B,A
001401 E4FA B1               4      OR  C
001402 E4FB EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
001403 E4FC B2               4      OR  D
001404 E4FD B3               4      OR  E
001405 E4FE C0              11      RET NZ
001406 E4FF 37               4      SCF
001407 E500 C9              10      RET
                                
       E501                     RBX2:               ;Cluster settings
001408 E501 FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
00140B E504 FD4E23          19      LD  C,(IY+35)
00140E E507 0600             7      LD  B,0
001410 E509 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001414 E50D 2003            12      JR  NZ,RBX3
001416 E50F FD4624          19      LD  B,(IY+36)
       E512                     RBX3:
001419 E512 CDE7F4          17      CALL    RWXR
00141C E515 3A37E5          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
00141F E518 3D               4      DEC A
001420 E519 FDA622          19      AND (IY+34)
001423 E51C FDB621          19      OR  (IY+33)
001426 E51F C9              10      RET
                                
       E520                     RBXA:
001427 E520 C5              11      PUSH    BC
001428 E521 D5              11      PUSH    DE
001429 E522 CDFDF2          17      CALL    CLUSTX
00142C E525 CD31E6          17      CALL    DRDX
00142F E528 D1              10      POP DE
001430 E529 C1              10      POP BC
001431 E52A D4CDE7          17      CALL    NC,GNCLX
001434 E52D D8              11      RET C
001435 E52E ED53FEEF        20      LD  (_CLPS),DE
                                
001439 E532 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
00143C E535 210004          10  SECSZ:  LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
00143F E538 7C               4      LD  A,H
001440 E539 3D               4      DEC A       ;1024=3 / 512=1
001441 E53A FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
001444 E53D 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
001445 E53E ED42            15      SBC HL,BC       ;残りを計算
                                
001447 E540 ED5B5DEE        20      LD  DE,(LEFTX)
00144B E544 ED52            15      SBC HL,DE       ;CP HL,DE
00144D E546 19              11      ADD HL,DE       ;
00144E E547 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
001450 E549 EB               4      EX  DE,HL
       E54A                     RBXA1:
001451 E54A E5              11      PUSH    HL
001452 E54B 2A7EEF          16      LD  HL,(_DTBUF)
001455 E54E 09              11      ADD HL,BC
001456 E54F ED5B5FEE        20      LD  DE,(DTAX)
00145A E553 C1              10      POP BC
00145B E554 C9              10      RET
                                
       E555                     RBXB:
00145C E555 2A5FEE          16      LD  HL,(DTAX)
00145F E558 ED5BFEEF        20      LD  DE,(_CLPS)
001463 E55C 3A5EEE          13      LD  A,(LEFTX+1)
001466 E55F 47               4      LD  B,A
001467 E560 3A37E5          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E563                     RBXB1:
00146A E563 1F               4      RRA     ;->CF
00146B E564 3804            12      JR  C,RBXB2
00146D E566 CB38             8      SRL B   ;B=B/2
00146F E568 18F9            12      JR  RBXB1
       E56A                     RBXB2:
001471 E56A 78               4      LD  A,B
001472 E56B B7               4      OR  A
001473 E56C C9              10      RET
                                
       E56D                     RBXC:
001474 E56D ED4B5DEE        20      LD  BC,(LEFTX)
001478 E571 3A37E5          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
00147B E574 3D               4      DEC A
00147C E575 A0               4      AND B
00147D E576 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
00147E E577 B1               4      OR  C
00147F E578 C9              10      RET
                                
       E579                     RBXEND:             ;レコード数だけランダムレコードを進める
001480 E579 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       E57A                     RBSIZE  EQU $-2
001483 E57C CD96F5          17      CALL    GET_RR_AHL
001486 E57F 19              11      ADD HL,DE
001487 E580 CE00             7      ADC A,0
001489 E582 CD0DE6          17      CALL    SET_RR_AHL
00148C E585 EB               4      EX  DE,HL       ;HL=進めるレコード数
00148D E586 D0              11      RET NC
00148E E587 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001492 E58B C0              11      RET NZ
001493 E58C FD3424          23      INC (IY+36)
001496 E58F C9              10      RET
                                
       E590                     GET_RR_BCDE:            ;BCDE=Random record
001497 E590 FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
00149A E593 FD5622          19      LD  D,(IY+34)
00149D E596 FD4E23          19      LD  C,(IY+35)
0014A0 E599 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
0014A2 E59B FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0014A6 E59F C0              11      RET NZ
0014A7 E5A0 FD4624          19      LD  B,(IY+36)
0014AA E5A3 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E5A4                     DWTC:
0014AB E5A4 E5              11      PUSH    HL
0014AC E5A5 2163E9          10      LD  HL,DWT24B
0014AF E5A8 1804            12      JR  DWTC1
       E5AA                     DRDC:
0014B1 E5AA E5              11      PUSH    HL
0014B2 E5AB 2153E9          10      LD  HL,DRD24B
       E5AE                     DWTC1:
0014B5 E5AE 2208E6          16      LD  (DRWF_MODE),HL
0014B8 E5B1 E1              10      POP HL
0014B9 E5B2 3AF8E5          13      LD  A,(DRWF_B)
0014BC E5B5 B7               4      OR  A
0014BD E5B6 200F            12      JR  NZ,DRDC1
       E5B8                     SAVE_DRWC:
0014BF E5B8 0601             7      LD  B,1
0014C1 E5BA ED43F7E5        20      LD  (DRWF_C),BC
0014C5 E5BE ED53FEE5        20      LD  (DRWF_E),DE
0014C9 E5C2 2201E6          16      LD  (DRWF_HL),HL
0014CC E5C5 1820            12      JR  INC_HL_DRWC
       E5C7                     DRDC1:
0014CE E5C7 E5              11      PUSH    HL
0014CF E5C8 21FEE5          10      LD  HL,DRWF_E
0014D2 E5CB 86               7      ADD A,(HL)
0014D3 E5CC F5              11      PUSH    AF
0014D4 E5CD BB               4      CP  E
0014D5 E5CE 201D            12      JR  NZ,DRDC2
0014D7 E5D0 F1              10      POP AF
0014D8 E5D1 23               6      INC HL
0014D9 E5D2 7E               7      LD  A,(HL)
0014DA E5D3 CE00             7      ADC A,0
0014DC E5D5 F5              11      PUSH    AF
0014DD E5D6 BA               4      CP  D
0014DE E5D7 2014            12      JR  NZ,DRDC2
0014E0 E5D9 F1              10      POP AF
0014E1 E5DA 3AF7E5          13      LD  A,(DRWF_C)
0014E4 E5DD CE00             7      ADC A,0
0014E6 E5DF B9               4      CP  C
0014E7 E5E0 200C            12      JR  NZ,DRDC3
0014E9 E5E2 21F8E5          10      LD  HL,DRWF_B
0014EC E5E5 34              11      INC (HL)
0014ED E5E6 E1              10      POP HL
       E5E7                     INC_HL_DRWC:
0014EE E5E7 3A37E5          13      LD  A,(SECSZ+2)     ;1セクタのサイズの上位1バイト
0014F1 E5EA 84               4      ADD A,H
0014F2 E5EB 67               4      LD  H,A
0014F3 E5EC C9              10      RET
       E5ED                     DRDC2:
0014F4 E5ED F1              10      POP AF
       E5EE                     DRDC3:
0014F5 E5EE CDF4E5          17      CALL    DRW_FLUSH
0014F8 E5F1 E1              10      POP HL
0014F9 E5F2 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E5F4                     DRW_FLUSH:
0014FB E5F4 C5              11      PUSH    BC
0014FC E5F5 D5              11      PUSH    DE
0014FD E5F6 010000          10      LD  BC,0
       E5F7                     DRWF_C  EQU $-2
       E5F8                     DRWF_B  EQU $-1
001500 E5F9 78               4      LD  A,B
001501 E5FA B7               4      OR  A
001502 E5FB 280D            12      JR  Z,DRDF1
001504 E5FD 110000          10      LD  DE,0
       E5FE                     DRWF_E  EQU $-2
       E5FF                     DRWF_D  EQU $-1
001507 E600 210000          10      LD  HL,0
       E601                     DRWF_HL EQU $-2
00150A E603 AF               4      XOR A
00150B E604 32F8E5          13      LD  (DRWF_B),A
00150E E607 CD53E9          17      CALL    DRD24B
       E608                     DRWF_MODE   EQU $-2
       E60A                     DRDF1:
001511 E60A D1              10      POP DE
001512 E60B C1              10      POP BC
001513 E60C C9              10      RET
                                
       E60D                     SET_RR_AHL:
001514 E60D FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001517 E610 FD7422          19      LD  (IY+34),H
00151A E613 FD7723          19      LD  (IY+35),A
00151D E616 C9              10      RET
                                
       E617                     SETSEQ1:
00151E E617 F5              11      PUSH    AF
00151F E618 E5              11      PUSH    HL      ;AHL=Random record
001520 E619 CD96F5          17      CALL    GET_RR_AHL
001523 E61C 47               4      LD  B,A     ;AHL→HLA
001524 E61D 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
001525 E61E 6C               4      LD  L,H     ;(IY+34)
001526 E61F 60               4      LD  H,B     ;(IY+35)
001527 E620 0600             7      LD  B,0
                                
001529 E622 CD80F5          17      CALL    GET_CPM_R_SIZE
                                
00152C E625 29              11      ADD HL,HL
00152D E626 CB3D             8      SRL L       ;L=L/2
00152F E628 FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
001532 E62B FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
001535 E62E E1              10      POP HL
001536 E62F F1              10      POP AF
001537 E630 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E631                     DRDX:
001538 E631 CD6FE6          17      CALL    DRDY
00153B E634 C8              11      RET Z
00153C E635 CD55E6          17      CALL    DRDX1       ;データバッファの情報を保存
00153F E638 D8              11      RET C
001540 E639 E5              11      PUSH    HL
001541 E63A C5              11      PUSH    BC
001542 E63B D5              11      PUSH    DE
001543 E63C 2A7EEF          16      LD  HL,(_DTBUF)
001546 E63F 3A98E6          13      LD  A,(_DBS24)
001549 E642 4F               4      LD  C,A
00154A E643 CD51E9          17      CALL    DRD24
00154D E646 DC6AE6          17      CALL    C,DRDNE
       E649                     POP_DE_BC_HL_RET:
001550 E649 D1              10      POP DE
001551 E64A C1              10      POP BC
001552 E64B E1              10      POP HL
001553 E64C C9              10      RET
                                
                                ;   CDE:セクタ番号
       E64D                     DRDN:
001554 E64D AF               4      XOR A
001555 E64E 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
001556 E64F 30E0            12      JR  NC,DRDX
       E651                     DRDNX:
001558 E651 CD6FE6          17      CALL    DRDY
00155B E654 C8              11      RET Z
       E655                     DRDX1:
00155C E655 CD85E6          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
00155F E658 ED53A6EE        20      LD  (_DBSEC),DE
001563 E65C 79               4      LD  A,C
001564 E65D 3298E6          13      LD  (_DBS24),A
                                
001567 E660 3A88EE          13      LD  A,(_DRV)
00156A E663 32A5EE          13      LD  (_DBDRV),A
00156D E666 CDD9EE          17      CALL    _CHGDRV
001570 E669 D0              11      RET NC
       E66A                     DRDNE:
001571 E66A 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001572 E66B 32A5EE          13      LD  (_DBDRV),A
001575 E66E C9              10      RET
                                
                                ;   CDE:セクタ番号
       E66F                     DRDY:
001576 E66F 3A98E6          13      LD  A,(_DBS24)
001579 E672 B9               4      CP  C
00157A E673 C0              11      RET NZ
                                
00157B E674 E5              11      PUSH    HL
00157C E675 3A88EE          13      LD  A,(_DRV)
00157F E678 21A5EE          10      LD  HL,_DBDRV
001582 E67B AE               7      XOR (HL)
001583 E67C 2005            12      JR  NZ,POP_HL_RET
                                
001585 E67E 2AA6EE          16      LD  HL,(_DBSEC)
001588 E681 ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E683                     POP_HL_RET:
00158A E683 E1              10      POP HL
00158B E684 C9              10      RET
                                
       E685                     DWTX:
00158C E685 3AA4EE          13      LD  A,(_WTDBF)
00158F E688 B7               4      OR  A
001590 E689 C8              11      RET Z
001591 E68A AF               4      XOR A
001592 E68B 32A4EE          13      LD  (_WTDBF),A
                                
001595 E68E E5              11      PUSH    HL
001596 E68F C5              11      PUSH    BC
001597 E690 D5              11      PUSH    DE
001598 E691 3AA5EE          13      LD  A,(_DBDRV)
00159B E694 CDD9EE          17      CALL    _CHGDRV
00159E E697 0E00             7      LD  C,0
       E698                     _DBS24  EQU $-1
0015A0 E699 ED5BA6EE        20      LD  DE,(_DBSEC)
0015A4 E69D 2A7EEF          16      LD  HL,(_DTBUF)
0015A7 E6A0 D461E9          17      CALL    NC,DWT24
       E6A3                     POP_DE_BC_HL_RET2:
0015AA E6A3 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E6A5                     RDFATX:
0015AC E6A5 E5              11      PUSH    HL
0015AD E6A6 3A88EE          13      LD  A,(_DRV)
0015B0 E6A9 21AAEE          10      LD  HL,_FATDRV
0015B3 E6AC AE               7      XOR (HL)
0015B4 E6AD 28D4            12      JR  Z,POP_HL_RET
                                
0015B6 E6AF C5              11      PUSH    BC
0015B7 E6B0 D5              11      PUSH    DE
0015B8 E6B1 DDE5            15      PUSH    IX
0015BA E6B3 CDCFE6          17      CALL    WTFATX
0015BD E6B6 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
0015BF E6B8 AF               4      XOR A
0015C0 E6B9 32ABEE          13      LD  (_FATIX),A
0015C3 E6BC 3A88EE          13      LD  A,(_DRV)
0015C6 E6BF 32AAEE          13      LD  (_FATDRV),A
0015C9 E6C2 CDE5EE          17      CALL    _RDFAT
       E6C5                     RDFATE2:
0015CC E6C5 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
0015CE E6C7 9F               4      SBC A,A     ;A=0xFF
0015CF E6C8 32AAEE          13      LD  (_FATDRV),A
       E6CB                     POP_IX_DE_BC_HL_RET:
0015D2 E6CB DDE1            14      POP IX
0015D4 E6CD 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E6CF                     WTFATX:
0015D6 E6CF 3AA2EE          13      LD  A,(_WTFATF)
0015D9 E6D2 B7               4      OR  A
0015DA E6D3 C8              11      RET Z
0015DB E6D4 E5              11      PUSH    HL
0015DC E6D5 3AAAEE          13      LD  A,(_FATDRV)
0015DF E6D8 21A5EE          10      LD  HL,_DBDRV
0015E2 E6DB AE               7      XOR (HL)
0015E3 E6DC CC85E6          17      CALL    Z,DWTX
0015E6 E6DF 38A2            12      JR  C,POP_HL_RET
0015E8 E6E1 C5              11      PUSH    BC
0015E9 E6E2 D5              11      PUSH    DE
0015EA E6E3 DDE5            15      PUSH    IX
0015EC E6E5 CD6EE9          17      CALL    WTFAT
0015EF E6E8 AF               4      XOR A
0015F0 E6E9 32A2EE          13      LD  (_WTFATF),A
0015F3 E6EC 18DD            12      JR  POP_IX_DE_BC_HL_RET
                                
       E6EE                     N16CL1:
0015F5 E6EE 7A               4      LD  A,D
0015F6 E6EF B3               4      OR  E
0015F7 E6F0 37               4      SCF
0015F8 E6F1 C8              11      RET Z
                                
0015F9 E6F2 7A               4      LD  A,D
0015FA E6F3 1807            12      JR  NCL1X
       E6F5                     NCL1:
0015FC E6F5 7A               4      LD  A,D
0015FD E6F6 B3               4      OR  E
0015FE E6F7 37               4      SCF
0015FF E6F8 C8              11      RET Z
                                
001600 E6F9 7A               4      LD  A,D
001601 E6FA CB3F             8      SRL A   ;/2
       E6FC                     NCL1X:
001603 E6FC CB3F             8      SRL A   ;/2
                                
001605 E6FE E5              11      PUSH    HL
001606 E6FF 321EE7          13      LD  (NCLPAT_FATIX),A    ;_FATIX
001609 E702 2AAAEE          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
00160C E705 BC               4      CP  H
00160D E706 3A88EE          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001610 E709 321DE7          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001613 E70C 2005            12      JR  NZ,NCL2     ;FATIXが違う
001615 E70E BD               4      CP  L
001616 E70F 2002            12      JR  NZ,NCL2     ;ドライブが違う
001618 E711 E1              10      POP HL
001619 E712 C9              10      RET
       E713                     NCL2:
00161A E713 C5              11      PUSH    BC
00161B E714 D5              11      PUSH    DE
00161C E715 DDE5            15      PUSH    IX
00161E E717 CDCFE6          17      CALL    WTFATX
001621 E71A 38AF            12      JR  C,POP_IX_DE_BC_HL_RET
001623 E71C 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E71E                     NCLPAT_FATIX    EQU $-1
       E71D                     NCLPAT_FATDRV   EQU $-2
001626 E71F ED43AAEE        20      LD  (_FATDRV),BC
00162A E723 CD43E9          17      CALL    RDFATS
00162D E726 189D            12      JR  RDFATE2
                                
       E728                     NCL3:
00162F E728 CB9A             8      RES 3,D
001631 E72A CB92             8      RES 2,D
001633 E72C 6B               4      LD  L,E
001634 E72D 62               4      LD  H,D
001635 E72E CB3C             8      SRL H   ;
001637 E730 CB1D             8      RR  L   ;HLA=HLA/2
001639 E732 1F               4      RRA     ;
00163A E733 F5              11      PUSH    AF
00163B E734 3AABEE          13      LD  A,(_FATIX)
00163E E737 0F               4      RRCA
00163F E738 300B            12      JR  NC,NCL3X1
001641 E73A 3A37E5          13      LD  A,(SECSZ+2)
001644 E73D FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
001646 E73F 2004            12      JR  NZ,NCL3X1
001648 E741 010002          10      LD  BC,512
00164B E744 09              11      ADD HL,BC
       E745                     NCL3X1:
00164C E745 F1              10      POP AF
00164D E746 ED4B7CEF        20      LD  BC,(_FATBF)
001651 E74A 19              11      ADD HL,DE
001652 E74B 09              11      ADD HL,BC
001653 E74C 17               4      RLA
001654 E74D C9              10      RET
                                
       E74E                     GNCL:
001655 E74E CDF5E6          17      CALL    NCL1        ;GET NEXT CLUSTER
001658 E751 D8              11      RET C
001659 E752 C5              11      PUSH    BC
00165A E753 E5              11      PUSH    HL
00165B E754 CD28E7          17      CALL    NCL3
00165E E757 3809            12      JR  C,GNC1
001660 E759 5E               7      LD  E,(HL)
001661 E75A 23               6      INC HL
001662 E75B 7E               7      LD  A,(HL)
001663 E75C E60F             7      AND 00FH
001665 E75E 57               4      LD  D,A
001666 E75F E1              10      POP HL
001667 E760 C1              10      POP BC
001668 E761 C9              10      RET
       E762                     GNC1:
001669 E762 7E               7      LD  A,(HL)
00166A E763 23               6      INC HL
00166B E764 56               7      LD  D,(HL)
00166C E765 0604             7      LD  B,4
       E767                     GNC1L:
00166E E767 CB3A             8      SRL D   ;DA=DA/2
001670 E769 1F               4      RRA     ;
001671 E76A 10FB            13      DJNZ    GNC1L
                                
001673 E76C 5F               4      LD  E,A
001674 E76D E1              10      POP HL
001675 E76E C1              10      POP BC
001676 E76F A7               4      AND A
001677 E770 C9              10      RET
                                
       E771                     SNCL:
001678 E771 CDF5E6          17      CALL    NCL1
00167B E774 D8              11      RET C
                                ;               SET NEXT CLUSTER
00167C E775 E5              11      PUSH    HL
00167D E776 C5              11      PUSH    BC
00167E E777 D5              11      PUSH    DE
00167F E778 E5              11      PUSH    HL
001680 E779 CD28E7          17      CALL    NCL3
001683 E77C D1              10      POP DE
                                ;CF=ODD
001684 E77D 7E               7      LD  A,(HL)
001685 E77E 73               7      LD  (HL),E
001686 E77F 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
001688 E781 23               6      INC HL
001689 E782 ED67            18      RRD     ;M={A[3:0],E[3:0]}
00168B E784 7A               4      LD  A,D
00168C E785 1804            12      JR  SNC11
       E787                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
00168E E787 ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001690 E789 23               6      INC HL
001691 E78A 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E78B                     SNC11:
001692 E78B ED6F            18      RLD     ;M={M[7:4],D[3:0]}
001694 E78D B7               4      OR  A
001695 E78E D1              10      POP DE
001696 E78F C1              10      POP BC
001697 E790 E1              10      POP HL
       E791                     FAT_CHANGED:
001698 E791 3E01             7      LD  A,1
00169A E793 32A2EE          13      LD  (_WTFATF),A
00169D E796 C9              10      RET
                                
       E797                     N16CL3:
00169E E797 C5              11      PUSH    BC
00169F E798 6B               4      LD  L,E
0016A0 E799 7A               4      LD  A,D
0016A1 E79A E601             7      AND 1
0016A3 E79C 67               4      LD  H,A
0016A4 E79D 29              11      ADD HL,HL
0016A5 E79E ED4B7CEF        20      LD  BC,(_FATBF)
0016A9 E7A2 09              11      ADD HL,BC
0016AA E7A3 C1              10      POP BC
0016AB E7A4 C9              10      RET
                                
       E7A5                     GNCL16:
0016AC E7A5 CDEEE6          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
0016AF E7A8 D8              11      RET C
0016B0 E7A9 E5              11      PUSH    HL
0016B1 E7AA CD97E7          17      CALL    N16CL3
0016B4 E7AD 5E               7      LD  E,(HL)
0016B5 E7AE 23               6      INC HL
0016B6 E7AF 56               7      LD  D,(HL)
0016B7 E7B0 E1              10      POP HL
0016B8 E7B1 C9              10      RET
                                
       E7B2                     SNCL16:
0016B9 E7B2 CDEEE6          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
0016BC E7B5 D8              11      RET C
0016BD E7B6 D5              11      PUSH    DE
0016BE E7B7 E5              11      PUSH    HL
0016BF E7B8 CD97E7          17      CALL    N16CL3
0016C2 E7BB D1              10      POP DE      ;HL
0016C3 E7BC 73               7      LD  (HL),E
0016C4 E7BD 23               6      INC HL
0016C5 E7BE 72               7      LD  (HL),D
0016C6 E7BF 6B               4      LD  L,E
0016C7 E7C0 62               4      LD  H,D
0016C8 E7C1 D1              10      POP DE
0016C9 E7C2 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E7C4                     NEXTX:
0016CB E7C4 3E00             7      LD  A,0 ;自己書き換え
       E7C5                     _SECPS  EQU $-1
0016CD E7C6 3C               4      INC A
0016CE E7C7 E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E7C8                     _NCPAT  EQU $-1
0016D0 E7C9 32C5E7          13      LD  (_SECPS),A
0016D3 E7CC C9              10      RET
                                
       E7CD                     GNCLX:
0016D4 E7CD CDC4E7          17      CALL    NEXTX
0016D7 E7D0 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
0016D8 E7D1 C3F7EE          10      JP  _GNCL   ;次のクラスタを探す
                                
       E7D4                     RDFAT:
0016DB E7D4 3E80             7      LD  A,080H
0016DD E7D6 3270EE          13      LD  (CHECK),A
       E7D9                     RDFAT1:
0016E0 E7D9 3A88EE          13      LD  A,(_DRV)
0016E3 E7DC CD7DEA          17      CALL    CHGDRVR
0016E6 E7DF D8              11      RET C
0016E7 E7E0 DD7E12          19      LD  A,(IX+DPB_DEVICE)
0016EA E7E3 CB6F             8      BIT 5,A
0016EC E7E5 286C            12      JR  Z,RDFAT0X
0016EE E7E7 2170EE          10      LD  HL,CHECK
0016F1 E7EA A6               7      AND (HL)
0016F2 E7EB 77               7      LD  (HL),A
0016F3 E7EC 110000          10      LD  DE,0        ;BPB
0016F6 E7EF 2A7CEF          16      LD  HL,(_FATBF)
0016F9 E7F2 CD4FE9          17      CALL    DRD16
0016FC E7F5 3024            12      JR  NC,GETBPB
0016FE E7F7 2170EE          10      LD  HL,CHECK
001701 E7FA CB06            15      RLC (HL)
001703 E7FC 3F               4      CCF
001704 E7FD D8              11      RET C
001705 E7FE DDCB0A1E        23      RR  (IX+DPB_FDMODE)
001709 E802 3F               4      CCF         ;フロッピーディスクのFDモードを切り替える
00170A E803 DDCB0A16        23      RL  (IX+DPB_FDMODE)
00170E E807 3EFF             7      LD  A,0FFH
001710 E809 3289EE          13      LD  (_DSK),A
001713 E80C 3A84EE          13      LD  A,(_DRIVE)
001716 E80F E603             7      AND 3
001718 E811 F680             7      OR  080H
00171A E813 6F               4      LD  L,A
00171B E814 26EE             7      LD  H,_CYL0/256
00171D E816 3EFF             7      LD  A,0FFH
00171F E818 77               7      LD  (HL),A
001720 E819 18BE            12      JR  RDFAT1
       E81B                     GETBPB:
001722 E81B FDE5            15      PUSH    IY
001724 E81D FD2A7CEF        20      LD  IY,(_FATBF) ;BPB
001728 E821 CDF1EE          17      CALL    _BPB2DPB
00172B E824 FDE1            14      POP IY
00172D E826 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001730 E829 3025            12      JR  NC,GETBPBOK
001732 E82B E60F             7      AND 00FH
001734 E82D FE07             7      CP  7
001736 E82F 37               4      SCF
001737 E830 C0              11      RET NZ
001738 E831 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
00173C E835 21C0EF          10      LD  HL,M2D
00173F E838 2006            12      JR  NZ,SETFDMODE
001741 E83A CD28E9          17      CALL    CHECK1024
001744 E83D D8              11      RET C
001745 E83E 2ED2             7      LD  L,M2HD-STABLE
       E840                     SETFDMODE:
001747 E840 DDE5            15      PUSH    IX
001749 E842 D1              10      POP DE
00174A E843 EDA0            16      LDI
00174C E845 EDA0            16      LDI
00174E E847 13               6      INC DE
00174F E848 13               6      INC DE
001750 E849 13               6      INC DE
001751 E84A 13               6      INC DE
001752 E84B 010C00          10      LD  BC,12
001755 E84E EDB0                    LDIR
       E850                     GETBPBOK:
001757 E850 CDE9E9          17      CALL    CHGDRV2
       E853                     RDFAT0X:
00175A E853 CD43E9          17      CALL    RDFATS
00175D E856 D8              11      RET C
00175E E857 DDAE06          19      XOR (IX+DPB_FATID)
001761 E85A C8              11      RET Z
001762 E85B DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001766 E85F C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
001767 E860 37               4      SCF
001768 E861 C9              10      RET
                                
       E862                     POP_HL_SCF_RET:
001769 E862 E1              10      POP HL
00176A E863 37               4      SCF
00176B E864 C9              10      RET
                                
       E865                     BPB2DPB:
00176C E865 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
00176F E868 B7               4      OR  A
001770 E869 37               4      SCF
001771 E86A C0              11      RET NZ
       E86B                     BPBOK:
001772 E86B FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001775 E86E DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001778 E871 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
00177B E874 DD7700          19      LD  (IX+DPB_FATLN),A
00177E E877 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
001781 E87A DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
001784 E87D FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001787 E880 FD660F          19      LD  H,(IY+15)
00178A E883 DD750E          19      LD  (IX+DPB_FATPS),L
00178D E886 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001790 E889 FD5617          19      LD  D,(IY+23)
001793 E88C FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E88F                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001796 E88F 19              11      ADD HL,DE
001797 E890 10FD            13      DJNZ    BPBDP1
       E892                     BPBDP2:
001799 E892 DD7510          19      LD  (IX+DPB_DIRPS),L
00179C E895 DD7411          19      LD  (IX+DPB_DIRPS+1),H
00179F E898 E5              11      PUSH    HL
                                
0017A0 E899 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
0017A3 E89C FD6612          19      LD  H,(IY+18)
0017A6 E89F FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
0017A9 E8A2 B7               4      OR  A
0017AA E8A3 28BD            12      JR  Z,POP_HL_SCF_RET
0017AC E8A5 0606             7      LD  B,6
       E8A7                     BPBBPS1:
0017AE E8A7 05               4      DEC B
0017AF E8A8 0F               4      RRCA
0017B0 E8A9 30FC            12      JR  NC,BPBBPS1
       E8AB                     BPBDE1:
0017B2 E8AB 29              11      ADD HL,HL
0017B3 E8AC 10FD            13      DJNZ    BPBDE1
                                
0017B5 E8AE 7C               4      LD  A,H
0017B6 E8AF DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
0017B9 E8B2 D1              10      POP DE      ;DPB_DIRPS
0017BA E8B3 6C               4      LD  L,H
0017BB E8B4 2600             7      LD  H,0
0017BD E8B6 19              11      ADD HL,DE       ;MAXDIR
0017BE E8B7 E5              11      PUSH    HL
0017BF E8B8 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
0017C2 E8BB CB21             8      SLA C       ;*2
0017C4 E8BD AF               4      XOR A
0017C5 E8BE 47               4      LD  B,A
0017C6 E8BF ED42            15      SBC HL,BC
0017C8 E8C1 DD7514          19      LD  (IX+DPB_ADDCL),L
0017CB E8C4 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
0017CE E8C7 D1              10      POP DE      ;DE=DPB_MAXDIR
0017CF E8C8 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
0017D2 E8CB FD6614          19      LD  H,(IY+20)
                                
0017D5 E8CE DD7E12          19      LD  A,(IX+DPB_DEVICE)
0017D8 E8D1 E60F             7      AND 00FH
0017DA E8D3 FE07             7      CP  7       ;フロッピー
0017DC E8D5 2019            12      JR  NZ,NOT_FD
0017DE E8D7 E5              11      PUSH    HL
0017DF E8D8 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
0017E2 E8DB DD710D          19      LD  (IX+DPB_MAXSEC),C
0017E5 E8DE AF               4      XOR A
0017E6 E8DF CB21             8      SLA C       ;両面なのでセクタ数を２倍
0017E8 E8E1 0610             7      LD  B,16
       E8E3                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
0017EA E8E3 29              11      ADD HL,HL
0017EB E8E4 17               4      RLA
0017EC E8E5 B9               4      CP  C
0017ED E8E6 3802            12      JR  C,DIVSEC1
0017EF E8E8 91               4      SUB C
0017F0 E8E9 2C               4      INC L
       E8EA                     DIVSEC1:
0017F1 E8EA 10F7            13      DJNZ    DIVSEC
0017F3 E8EC DD750C          19      LD  (IX+DPB_MAXCYL),L
0017F6 E8EF E1              10      POP HL  ;ここまでフロッピー専用
       E8F0                     NOT_FD:
0017F7 E8F0 7C               4      LD  A,H
0017F8 E8F1 B5               4      OR  L
0017F9 E8F2 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
0017FB E8F4 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
0017FD E8F6 2F               4      CPL         ;A=0FFH
0017FE E8F7 FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001801 E8FA D8              11      RET C
001802 E8FB FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001805 E8FE FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001808 E901 FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E904                     BPB16BIT:
00180B E904 ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
00180D E906 DE00             7      SBC A,0
00180F E908 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E90B                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001812 E90B CB18             8      RR  B       ;->CY
001814 E90D 3808            12      JR  C,BPBTC2
001816 E90F CB3F             8      SRL A
001818 E911 CB1C             8      RR  H       ;AHL=AHL/2
00181A E913 CB1D             8      RR  L
00181C E915 18F4            12      JR  BPBTC1
       E917                     BPBTC2:
00181E E917 C6FF             7      ADD A,0FFH
001820 E919 D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001821 E91A 23               6      INC HL
001822 E91B 23               6      INC HL
001823 E91C DD7508          19      LD  (IX+DPB_MAXCL),L
001826 E91F DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001829 E922 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
00182C E925 DD7706          19      LD  (IX+DPB_FATID),A
       E928                     CHECK1024:
00182F E928 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001832 E92B C6FE             7      ADD A,0-2       ;>2:CF=1
001834 E92D FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001837 E930 6F               4      LD  L,A
001838 E931 3002            12      JR  NC,BPBFAT1
00183A E933 F680             7      OR  080H
       E935                     BPBFAT1:            ;ここではCF=0
00183C E935 DD770F          19      LD  (IX+DPB_BPS),A
00183F E938 3A7BEF          13      LD  A,(_MAX_SEC_SZ_H)
001842 E93B BD               4      CP  L
001843 E93C C8              11      RET Z       ;1セクタ1024バイト
001844 E93D 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001845 E93E C8              11      RET Z       ;1セクタ256バイト
001846 E93F 2D               4      DEC L
001847 E940 C8              11      RET Z       ;1セクタ512バイト
001848 E941 37               4      SCF
001849 E942 C9              10      RET
                                
       E943                     RDFATS:
00184A E943 CD74E9          17      CALL    FATSETUP
00184D E946 D8              11      RET C
00184E E947 CD53E9          17      CALL    DRD24B
001851 E94A 2A7CEF          16      LD  HL,(_FATBF)
001854 E94D 7E               7      LD  A,(HL)
001855 E94E C9              10      RET
                                
       E94F                     DRD16:
001856 E94F 0E00             7      LD  C,0
       E951                     DRD24:
001858 E951 0601             7      LD  B,1
       E953                     DRD24B:
00185A E953 DDE5            15      PUSH    IX
00185C E955 DD2AA8EE        20      LD  IX,(_DPB)
001860 E959 CD0EEC          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E95A                     DRDPAT  EQU $-2
       E95C                     POP_IX_RET:
001863 E95C DDE1            14      POP IX
001865 E95E C9              10      RET
                                
       E95F                     DWT16:
001866 E95F 0E00             7      LD  C,0
       E961                     DWT24:
001868 E961 0601             7      LD  B,1
       E963                     DWT24B:
00186A E963 DDE5            15      PUSH    IX
00186C E965 DD2AA8EE        20      LD  IX,(_DPB)
001870 E969 CD76EB          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E96A                     DWTPAT  EQU $-2
001873 E96C 18EE            12      JR  POP_IX_RET
                                
       E96E                     WTFAT:
001875 E96E CD74E9          17      CALL    FATSETUP
001878 E971 30F0            12      JR  NC,DWT24B
00187A E973 C9              10      RET
                                ;   CALL    NC,DWT24B   ;予備FATの保存ルーチン
                                ;   RET C
                                ;   BIT 7,(IX+DPB_BPS)
                                ;   RET Z       ;予備FATが無い
                                ;   CALL    FATS2
                                ;   PUSH    HL      ;予備FAT
                                ;   LD  L,(IX+DPB_FATLN)
                                ;   LD  H,(IX+DPB_FATLN+1)
                                ;   ADD HL,DE
                                ;   EX  DE,HL
                                ;   POP HL
                                ;   JR  DWT24B
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E974                     FATSETUP:
00187B E974 3AAAEE          13      LD  A,(_FATDRV)
00187E E977 CD7DEA          17      CALL    CHGDRVR     ;ドライブ切り替え
001881 E97A D8              11      RET C
       E97B                     FATS2:
001882 E97B DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001885 E97E 0F               4      RRCA
001886 E97F CDAFE9          17      CALL    FATSETUP12  ;自己書き換え
       E980                     FATSX   EQU $-2
001889 E982 210000          10      LD  HL,0
00188C E985 4A               4      LD  C,D
00188D E986 54               4      LD  D,H
00188E E987 3AABEE          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
001891 E98A 47               4      LD  B,A
001892 E98B 04               4      INC B
001893 E98C DD7E00          19      LD  A,(IX+DPB_FATLN)
       E98F                     FAT_SKP:
001896 E98F 05               4      DEC B
001897 E990 2809            12      JR  Z,FAT1
001899 E992 19              11      ADD HL,DE
00189A E993 93               4      SUB E
00189B E994 30F9            12      JR  NC,FAT_SKP
00189D E996 DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
0018A1 E99A C8              11      RET Z
       E99B                     FAT1:
0018A2 E99B EB               4      EX  DE,HL
0018A3 E99C B7               4      OR  A       ;0の場合は0100Hとして扱う
0018A4 E99D 2803            12      JR  Z,FAT3
0018A6 E99F B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
0018A7 E9A0 3801            12      JR  C,FAT2
       E9A2                     FAT3:
0018A9 E9A2 79               4      LD  A,C
       E9A3                     FAT2:
0018AA E9A3 47               4      LD  B,A
                                
0018AB E9A4 2AFAEF          16      LD  HL,(_FATPS) ;fat sector pos
0018AE E9A7 19              11      ADD HL,DE
0018AF E9A8 EB               4      EX  DE,HL
0018B0 E9A9 2A7CEF          16      LD  HL,(_FATBF)
0018B3 E9AC AF               4      XOR A       ;CF=0
0018B4 E9AD 4F               4      LD  C,A
0018B5 E9AE C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E9AF                     FATSETUP12:
0018B6 E9AF 110606          10      LD  DE,0606H    ;256
0018B9 E9B2 D8              11      RET C
0018BA E9B3 110303          10      LD  DE,0303H    ;512
0018BD E9B6 0F               4      RRCA
0018BE E9B7 D8              11      RET C
0018BF E9B8 110102          10      LD  DE,0201H    ;1024
0018C2 E9BB C9              10      RET
                                
       E9BC                     FATSETUP16:
0018C3 E9BC 110404          10      LD  DE,0404H    ;256
0018C6 E9BF D8              11      RET C
0018C7 E9C0 110202          10      LD  DE,0202H    ;512
0018CA E9C3 0F               4      RRCA
0018CB E9C4 D8              11      RET C
0018CC E9C5 110101          10      LD  DE,0101H    ;1024
0018CF E9C8 C9              10      RET
                                
       E9C9                     CHGDRV:
0018D0 E9C9 E5              11      PUSH    HL
0018D1 E9CA 2189EE          10      LD  HL,_DSK
0018D4 E9CD BE               7      CP  (HL)
0018D5 E9CE 280A            12      JR  Z,CHGDRVE
       E9D0                     CHGDRV1:
0018D7 E9D0 DDE5            15      PUSH    IX
0018D9 E9D2 CDDCE9          17      CALL    CHGDRV0
0018DC E9D5 3A89EE          13      LD  A,(_DSK)
0018DF E9D8 DDE1            14      POP IX
       E9DA                     CHGDRVE:
0018E1 E9DA E1              10      POP HL
0018E2 E9DB C9              10      RET
                                
       E9DC                     CHGDRV0:
0018E3 E9DC 6F               4      LD  L,A
0018E4 E9DD CDDCEE          17      CALL    _GETDPB
0018E7 E9E0 D8              11      RET C
0018E8 E9E1 DD22A8EE        20      LD  (_DPB),IX
0018EC E9E5 7D               4      LD  A,L
0018ED E9E6 3289EE          13      LD  (_DSK),A
       E9E9                     CHGDRV2:
0018F0 E9E9 C5              11      PUSH    BC
0018F1 E9EA D5              11      PUSH    DE
0018F2 E9EB ED7334EA        20      LD  (SPPAT2),SP
0018F6 E9EF F3               4      DI
0018F7 E9F0 DDF9            10      LD  SP,IX
                                
0018F9 E9F2 E1              10      POP HL      ;00:DPB_FATLN
0018FA E9F3 E1              10      POP HL      ;02:DPB_DRD
0018FB E9F4 225AE9          16      LD  (DRDPAT),HL
                                
0018FE E9F7 E1              10      POP HL
0018FF E9F8 226AE9          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001902 E9FB E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001903 E9FC 7C               4      LD  A,H
001904 E9FD 3201F3          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001907 EA00 3D               4      DEC A
001908 EA01 32C8E7          13      LD  (_NCPAT),A
                                
00190B EA04 E1              10      POP HL      ;08:DPB_MAXCL
00190C EA05 7D               4      LD  A,L
00190D EA06 3220F3          13      LD  (CLPAT2),A
001910 EA09 7C               4      LD  A,H
001911 EA0A 321CF3          13      LD  (CLPAT1),A
001914 EA0D 2B               6      DEC HL
001915 EA0E 221DF5          16      LD  (MAXCLP),HL
                                
001918 EA11 E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001919 EA12 4C               4      LD  C,H
                                
00191A EA13 E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
00191B EA14 E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
00191C EA15 7C               4      LD  A,H     ;DPB_BPS
00191D EA16 E607             7      AND 7
00191F EA18 3237E5          13      LD  (SECSZ+2),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001922 EA1B 87               4      ADD A,A     ;8  4   2
001923 EA1C 87               4      ADD A,A     ;010H   8   4
001924 EA1D 87               4      ADD A,A     ;020H   010H    8
001925 EA1E 327EF1          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001928 EA21 2600             7      LD  H,0
00192A EA23 22FAEF          16      LD  (_FATPS),HL
                                
00192D EA26 E1              10      POP HL      ;10:DPB_DIRPS
00192E EA27 22FCEF          16      LD  (_DIRPS),HL
                                
001931 EA2A E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001932 EA2B 7C               4      LD  A,H
001933 EA2C 3284EE          13      LD  (_DRIVE),A
                                
001936 EA2F E1              10      POP HL      ;14:DPB_ADDCL
001937 EA30 2211F3          16      LD  (CLSPAT),HL
                                
00193A EA33 310000          10      LD  SP,0        ;元のSPを復元
       EA34                     SPPAT2  EQU $-2
00193D EA36 FB               4      EI
00193E EA37 2AFCEF          16      LD  HL,(_DIRPS)
001941 EA3A 0600             7      LD  B,0
001943 EA3C 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001944 EA3D 2299F1          16      LD  (MD_PAT),HL
                                
001947 EA40 2A1DF5          16      LD  HL,(MAXCLP)
00194A EA43 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
00194D EA46 19              11      ADD HL,DE
00194E EA47 380F            12      JR  C,SETFAT16
001950 EA49 214EE7          10      LD  HL,GNCL     ;FAT12
001953 EA4C 1171E7          10      LD  DE,SNCL
001956 EA4F 01AFE9          10      LD  BC,FATSETUP12
001959 EA52 DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
00195D EA56 180D            12      JR  EXTRA1
       EA58                     SETFAT16:
00195F EA58 21A5E7          10      LD  HL,GNCL16   ;FAT16
001962 EA5B 11B2E7          10      LD  DE,SNCL16
001965 EA5E 01BCE9          10      LD  BC,FATSETUP16
001968 EA61 DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       EA65                     EXTRA1:
00196C EA65 22F8EE          16      LD  (GNCPAT),HL
00196F EA68 ED53FBEE        20      LD  (SNCPAT),DE
001973 EA6C ED4380E9        20      LD  (FATSX),BC
001977 EA70 D1              10      POP DE
001978 EA71 C1              10      POP BC
001979 EA72 AF               4      XOR A
00197A EA73 C9              10      RET
                                
       EA74                     GETDPBD:
00197B EA74 DDE3            23      EX  (SP),IX
00197D EA76 DDE5            15      PUSH    IX
00197F EA78 3A88EE          13      LD  A,(_DRV)
001982 EA7B 1807            12      JR  GETDPB1
                                
       EA7D                     CHGDRVR:
001984 EA7D CDD9EE          17      CALL    _CHGDRV
001987 EA80 D8              11      RET C
001988 EA81 3A89EE          13      LD  A,(_DSK)
       EA84                     GETDPB1:
00198B EA84 C3DCEE          10      JP  _GETDPB
                                
       EA87                     GETDPB:
00198E EA87 FE08             7      CP  8
001990 EA89 3F               4      CCF
001991 EA8A D8              11      RET C
001992 EA8B 0F               4      RRCA
001993 EA8C 0F               4      RRCA
001994 EA8D 0F               4      RRCA
001995 EA8E DD                      DB  0DDH        ;Z80未定義命令
001996 EA8F 6F               4      LD  L,A     ;LD IXL,A
001997 EA90 DD                      DB  0DDH        ;Z80未定義命令
001998 EA91 26F6             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
00199A EA93 DD7E00          19      LD  A,(IX+DPB_FATLN)
00199D EA96 A7               4      AND A       ;CF=0の為
00199E EA97 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
0019A2 EA9B C0              11      RET NZ      ;FAT16
0019A3 EA9C DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
0019A7 EAA0 C0              11      RET NZ      ;BPB
0019A8 EAA1 FE01             7      CP  001H        ;A=0 THEN CF=1
0019AA EAA3 C9              10      RET
                                
       EAA4                     _SYS5F:
0019AB EAA4 AF               4      XOR A
       EAA5                     FFLUSH:
0019AC EAA5 F5              11      PUSH    AF
0019AD EAA6 CDCFE6          17      CALL    WTFATX
0019B0 EAA9 AF               4      XOR A
0019B1 EAAA 32ABEE          13      LD  (_FATIX),A
0019B4 EAAD 2F               4      CPL         ;0FFH
0019B5 EAAE 32AAEE          13      LD  (_FATDRV),A
0019B8 EAB1 3E                      DB  03EH        ;次のPUSH AFをスキップ
       EAB2                     FFLUSHBUF:
0019B9 EAB2 F5              11      PUSH    AF
0019BA EAB3 CD85E6          17      CALL    DWTX
0019BD EAB6 3EFF             7      LD  A,0FFH
0019BF EAB8 3239EE          13      LD  (SFILE),A
0019C2 EABB 32A5EE          13      LD  (_DBDRV),A
0019C5 EABE F1              10      POP AF
0019C6 EABF C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "88DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   PC-8801mkIISR
                                
                                ;   FLOPPY DISK DRIVER
                                ;
       EAC0                     PUTCOM_EXECUTE:
0019C7 EAC0 3E0D             7      LD  A,0DH       ;エグゼキュート
                                ;   コマンド送信
       EAC2                     PUTCOM:
0019C9 EAC2 F5              11      PUSH    AF
0019CA EAC3 3E0F             7      LD  A,00FH
0019CC EAC5 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
0019CE EAC7 F1              10      POP AF
                                ;   通常ハンドシェイク（ホストが送信）
       EAC8                     PUTDAT:
0019CF EAC8 F5              11      PUSH    AF
       EAC9                     PUTDAT1:
0019D0 EAC9 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
0019D2 EACB E602             7      AND 2       ;RFD
0019D4 EACD 28FA            12      JR  Z,PUTDAT1
0019D6 EACF 3E0E             7      LD  A,00EH      ;ATN=0
0019D8 EAD1 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
0019DA EAD3 F1              10      POP AF
0019DB EAD4 D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
0019DD EAD6 F5              11      PUSH    AF
0019DE EAD7 3E09             7      LD  A,9     ;DAV=1
0019E0 EAD9 D3FF            11      OUT (0FFH),A
       EADB                     PUTDAT2:
0019E2 EADB DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
0019E4 EADD E604             7      AND 4       ;DAC
0019E6 EADF 28FA            12      JR  Z,PUTDAT2
                                
0019E8 EAE1 3E08             7      LD  A,8     ;DAV=0
0019EA EAE3 D3FF            11      OUT (0FFH),A
       EAE5                     PUTDAT3:
0019EC EAE5 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
0019EE EAE7 E604             7      AND 4       ;DAC
0019F0 EAE9 20FA            12      JR  NZ,PUTDAT3
0019F2 EAEB F1              10      POP AF
0019F3 EAEC C9              10      RET
                                
                                ;   通常ハンドシェイク（ホストが受信）
       EAED                     GETDAT:
0019F4 EAED 3E0B             7      LD  A,00BH      ;RFD=1
0019F6 EAEF D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
       EAF1                     GETDAT1:
0019F8 EAF1 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
0019FA EAF3 0F               4      RRCA            ;DAV
0019FB EAF4 30FB            12      JR  NC,GETDAT1
                                
0019FD EAF6 3E0A             7      LD  A,00AH      ;RFD=0
0019FF EAF8 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001A01 EAFA DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001A03 EAFC F5              11      PUSH    AF
001A04 EAFD 3E0D             7      LD  A,00DH      ;DAC=1
001A06 EAFF D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
       EB01                     GETDAT2:
001A08 EB01 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A0A EB03 0F               4      RRCA            ;DAV
001A0B EB04 38FB            12      JR  C,GETDAT2
                                
001A0D EB06 3E0C             7      LD  A,00CH      ;DAC=0
001A0F EB08 D3FF            11      OUT (0FFH),A
001A11 EB0A F1              10      POP AF
001A12 EB0B C9              10      RET
                                
                                ;   高速ハンドシェイク（ホストが送信）
                                ;   HL:アドレス BC:受信サイズ（必ず偶数にする）
       EB0C                     FPUTDAT:
       EB0C                     FPUTDAT1:
001A13 EB0C DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A15 EB0E E602             7      AND 2       ;RFD
001A17 EB10 28FA            12      JR  Z,FPUTDAT1
001A19 EB12 3E0E             7      LD  A,00EH      ;ATN=0
001A1B EB14 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001A1D EB16 7E               7      LD  A,(HL)
001A1E EB17 D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
                                
001A20 EB19 3E09             7      LD  A,9     ;DAV=1
001A22 EB1B D3FF            11      OUT (0FFH),A
001A24 EB1D 23               6      INC HL
001A25 EB1E 0B               6      DEC BC
       EB1F                     FPUTDAT2:
001A26 EB1F DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A28 EB21 E604             7      AND 4       ;DAC
001A2A EB23 28FA            12      JR  Z,FPUTDAT2
                                
001A2C EB25 7E               7      LD  A,(HL)
001A2D EB26 D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
                                
001A2F EB28 3E08             7      LD  A,8     ;DAV=0
001A31 EB2A D3FF            11      OUT (0FFH),A
       EB2C                     FPUTDAT3:
001A33 EB2C DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A35 EB2E E604             7      AND 4       ;DAC
001A37 EB30 20FA            12      JR  NZ,FPUTDAT3
                                
001A39 EB32 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001A3B EB34 E0              11      RET PO
001A3C EB35 18D5            12      JR  FPUTDAT
                                
                                
                                ;   高速ハンドシェイク（ホストが受信）
                                ;   HL:アドレス BC:受信サイズ（必ず偶数にする）
       EB37                     FGETDAT:
001A3E EB37 3E0B             7      LD  A,00BH      ;RFD=1
001A40 EB39 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
       EB3B                     FGETDAT1:
001A42 EB3B DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A44 EB3D 0F               4      RRCA            ;DAV
001A45 EB3E 30FB            12      JR  NC,FGETDAT1
                                
001A47 EB40 3E0A             7      LD  A,00AH      ;RFD=0
001A49 EB42 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001A4B EB44 DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001A4D EB46 77               7      LD  (HL),A
                                
001A4E EB47 3E0D             7      LD  A,00DH      ;DAC=1
001A50 EB49 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
001A52 EB4B 23               6      INC HL
001A53 EB4C 0B               6      DEC BC
       EB4D                     FGETDAT2:
001A54 EB4D DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001A56 EB4F 0F               4      RRCA            ;DAV
001A57 EB50 38FB            12      JR  C,FGETDAT2
                                
001A59 EB52 DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001A5B EB54 77               7      LD  (HL),A
                                
001A5C EB55 3E0C             7      LD  A,00CH      ;DAC=0
001A5E EB57 D3FF            11      OUT (0FFH),A
                                
001A60 EB59 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001A62 EB5B E0              11      RET PO
001A63 EB5C 18D9            12      JR  FGETDAT
                                
                                ;   論理セクタ番号からトラック番号とセクタ番号を得る
                                ;   in
                                ;   DE:論理セクタ
       EB5E                     CALC_SECTOR:
001A65 EB5E C5              11      PUSH    BC
001A66 EB5F DD4E0D          19      LD  C,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001A69 EB62 0610             7      LD  B,16
001A6B EB64 AF               4      XOR A
001A6C EB65 EB               4      EX  DE,HL
       EB66                     DIV1:
001A6D EB66 29              11      ADD HL,HL
001A6E EB67 8F               4      ADC A,A
001A6F EB68 B9               4      CP  C
001A70 EB69 3802            12      JR  C,DIV2
001A72 EB6B 91               4      SUB C
001A73 EB6C 2C               4      INC L
       EB6D                     DIV2:
001A74 EB6D 10F7            13      DJNZ    DIV1
                                
001A76 EB6F 3C               4      INC A   ;最小のセクタは１固定
001A77 EB70 55               4      LD  D,L ;TRACK
       EB71                     DIV3:
001A78 EB71 5F               4      LD  E,A ;SECTOR
001A79 EB72 C1              10      POP BC
001A7A EB73 C9              10      RET
                                
       EB74                     WTTRK:
001A7B EB74 37               4      SCF
001A7C EB75 C9              10      RET
       EB76                     FDWT:
001A7D EB76 E5              11      PUSH    HL
001A7E EB77 D5              11      PUSH    DE
001A7F EB78 CD5EEB          17      CALL    CALC_SECTOR
001A82 EB7B 7A               4      LD  A,D     ;トラック
001A83 EB7C 32DAEB          13      LD  (FDWT_TRACK),A
001A86 EB7F 7B               4      LD  A,E     ;セクタ
001A87 EB80 32D5EB          13      LD  (FDWT_SECTOR),A
001A8A EB83 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001A8D EB86 93               4      SUB E
001A8E EB87 3C               4      INC A
001A8F EB88 67               4      LD  H,A
001A90 EB89 D1              10      POP DE
001A91 EB8A 3A37E5          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
001A94 EB8D 4F               4      LD  C,A
001A95 EB8E AF               4      XOR A
       EB8F                     FDWT2:
001A96 EB8F 81               4      ADD A,C
001A97 EB90 13               6      INC DE
001A98 EB91 05               4      DEC B
001A99 EB92 2807            12      JR  Z,FDWT3
001A9B EB94 25               4      DEC H       ;トラック、ヘッドを跨がない
001A9C EB95 2804            12      JR  Z,FDWT3
001A9E EB97 FE3A             7      CP  03AH        ;バッファとして04000H-07BFFHまで使える
001AA0 EB99 38F4            12      JR  C,FDWT2
       EB9B                     FDWT3:
001AA2 EB9B 4F               4      LD  C,A
001AA3 EB9C E1              10      POP HL
001AA4 EB9D 3E16             7      LD  A,16H       ;高速レシーブメモリ
001AA6 EB9F CDC2EA          17      CALL    PUTCOM
001AA9 EBA2 3E40             7      LD  A,DSS_DATA/256  ;開始アドレスH
001AAB EBA4 CDC8EA          17      CALL    PUTDAT
001AAE EBA7 AF               4      XOR A       ;開始アドレスL
001AAF EBA8 CDC8EA          17      CALL    PUTDAT
001AB2 EBAB 79               4      LD  A,C     ;バイト数H
001AB3 EBAC CDC8EA          17      CALL    PUTDAT
001AB6 EBAF AF               4      XOR A       ;バイト数L
001AB7 EBB0 CDC8EA          17      CALL    PUTDAT
001ABA EBB3 C5              11      PUSH    BC
001ABB EBB4 41               4      LD  B,C
001ABC EBB5 0E00             7      LD  C,0
001ABE EBB7 CD0CEB          17      CALL    FPUTDAT
001AC1 EBBA C1              10      POP BC
001AC2 EBBB CDC0EA          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001AC5 EBBE 3E7C             7      LD  A,WRITEDISKEX/256
001AC7 EBC0 CDC8EA          17      CALL    PUTDAT
001ACA EBC3 3EA3             7      LD  A,WRITEDISKEX%256
001ACC EBC5 CDC8EA          17      CALL    PUTDAT
001ACF EBC8 DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
001AD2 EBCB CDC8EA          17      CALL    PUTDAT
001AD5 EBCE DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001AD8 EBD1 CDC8EA          17      CALL    PUTDAT
001ADB EBD4 3E00             7      LD  A,0     ;セクタ
       EBD5                     FDWT_SECTOR EQU $-1
001ADD EBD6 CDC8EA          17      CALL    PUTDAT
001AE0 EBD9 3E00             7      LD  A,0     ;トラック
       EBDA                     FDWT_TRACK  EQU $-1
001AE2 EBDB CDC8EA          17      CALL    PUTDAT
001AE5 EBDE DD7E0A          19      LD  A,(IX+DPB_FDMODE)   ;フロッピーディスクのモード
001AE8 EBE1 CDC8EA          17      CALL    PUTDAT
001AEB EBE4 3A37E5          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
001AEE EBE7 CDC8EA          17      CALL    PUTDAT
001AF1 EBEA 79               4      LD  A,C
001AF2 EBEB CDC8EA          17      CALL    PUTDAT      ;バイト数H
001AF5 EBEE DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;フロッピーディスクのシリンダ数
001AF8 EBF1 CDC8EA          17      CALL    PUTDAT
                                
001AFB EBF4 CDC0EA          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001AFE EBF7 3E7E             7      LD  A,RESULTEX/256
001B00 EBF9 CDC8EA          17      CALL    PUTDAT
001B03 EBFC 3E13             7      LD  A,RESULTEX%256
001B05 EBFE CDC8EA          17      CALL    PUTDAT
                                
001B08 EC01 CDEDEA          17      CALL    GETDAT
001B0B EC04 4F               4      LD  C,A
001B0C EC05 FE01             7      CP  1
001B0E EC07 D8              11      RET C
                                
001B0F EC08 78               4      LD  A,B
001B10 EC09 B7               4      OR  A
001B11 EC0A C276EB          10      JP  NZ,FDWT
001B14 EC0D C9              10      RET
                                
       EC0E                     FDRD:
001B15 EC0E CDC0EA          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001B18 EC11 3E7C             7      LD  A,READDISKEX/256
001B1A EC13 CDC8EA          17      CALL    PUTDAT
001B1D EC16 AF               4      XOR A
001B1E EC17 CDC8EA          17      CALL    PUTDAT
001B21 EC1A DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
001B24 EC1D CDC8EA          17      CALL    PUTDAT
001B27 EC20 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001B2A EC23 CDC8EA          17      CALL    PUTDAT
001B2D EC26 E5              11      PUSH    HL
001B2E EC27 D5              11      PUSH    DE
001B2F EC28 CD5EEB          17      CALL    CALC_SECTOR
001B32 EC2B 7B               4      LD  A,E     ;セクタ
001B33 EC2C CDC8EA          17      CALL    PUTDAT
001B36 EC2F 7A               4      LD  A,D     ;トラック
001B37 EC30 CDC8EA          17      CALL    PUTDAT
001B3A EC33 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001B3D EC36 93               4      SUB E
001B3E EC37 3C               4      INC A
001B3F EC38 67               4      LD  H,A
001B40 EC39 D1              10      POP DE
001B41 EC3A DD7E0A          19      LD  A,(IX+DPB_FDMODE)   ;フロッピーディスクのモード
001B44 EC3D CDC8EA          17      CALL    PUTDAT
001B47 EC40 3A37E5          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
001B4A EC43 CDC8EA          17      CALL    PUTDAT
001B4D EC46 4F               4      LD  C,A
001B4E EC47 AF               4      XOR A
       EC48                     FDRD2:
001B4F EC48 81               4      ADD A,C
001B50 EC49 13               6      INC DE
001B51 EC4A 05               4      DEC B
001B52 EC4B 2807            12      JR  Z,FDRD3
001B54 EC4D 25               4      DEC H       ;トラック、ヘッドを跨がない
001B55 EC4E 2804            12      JR  Z,FDRD3
001B57 EC50 FE3A             7      CP  03AH        ;バッファとして04000H-07BFFHまで使える
001B59 EC52 38F4            12      JR  C,FDRD2
       EC54                     FDRD3:
001B5B EC54 E1              10      POP HL
001B5C EC55 4F               4      LD  C,A
001B5D EC56 CDC8EA          17      CALL    PUTDAT      ;バイト数H
001B60 EC59 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;フロッピーディスクのシリンダ数
001B63 EC5C CDC8EA          17      CALL    PUTDAT
                                
001B66 EC5F CDC0EA          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001B69 EC62 3E7E             7      LD  A,RESULTEX/256
001B6B EC64 CDC8EA          17      CALL    PUTDAT
001B6E EC67 3E13             7      LD  A,RESULTEX%256
001B70 EC69 CDC8EA          17      CALL    PUTDAT
                                
001B73 EC6C CDEDEA          17      CALL    GETDAT
001B76 EC6F 4F               4      LD  C,A
001B77 EC70 FE01             7      CP  1
001B79 EC72 D8              11      RET C
                                
001B7A EC73 3E15             7      LD  A,15H       ;高速センドメモリ
001B7C EC75 CDC2EA          17      CALL    PUTCOM
001B7F EC78 3E40             7      LD  A,DSS_DATA/256  ;開始アドレスH
001B81 EC7A CDC8EA          17      CALL    PUTDAT
001B84 EC7D AF               4      XOR A       ;開始アドレスL
001B85 EC7E CDC8EA          17      CALL    PUTDAT
001B88 EC81 79               4      LD  A,C     ;バイト数H
001B89 EC82 CDC8EA          17      CALL    PUTDAT
001B8C EC85 AF               4      XOR A       ;バイト数L
001B8D EC86 CDC8EA          17      CALL    PUTDAT
001B90 EC89 C5              11      PUSH    BC
001B91 EC8A 41               4      LD  B,C
001B92 EC8B 0E00             7      LD  C,0
001B94 EC8D CD37EB          17      CALL    FGETDAT
001B97 EC90 C1              10      POP BC
001B98 EC91 78               4      LD  A,B
001B99 EC92 B7               4      OR  A
001B9A EC93 C20EEC          10      JP  NZ,FDRD
001B9D EC96 C9              10      RET
                                
[EOF:88DISK.ASM:UTF_8]
                                    INCLUDE "88INTVEC.ASM"
                                
                                ;   LSX-Dodgers TABLE 割り込みベクタとI/Oルーチン
                                
       EC97                     AT_TABLE:
001B9E EC97                         DS  INTAD-AT_TABLE
                                
                                ;
                                ;   割り込みベクタ:アドレス下位1バイトが0になるように
                                ;   高速RAM(0F000H-0FFFFH)と被らないようにする
                                ;
       ED00                     IRXRDY:
001C07 ED00 BEE2                    DW  INTE88
       ED02                     IVRTC:
001C09 ED02 88E2                    DW  INTVRTC
       ED04                     ICLOCK:
001C0B ED04 BEE2                    DW  INTE88
       ED06                     IINT4:
001C0D ED06 BEE2                    DW  INTE88
       ED08                     IINT3:
001C0F ED08 BEE2                    DW  INTE88
       ED0A                     IINT2:
001C11 ED0A BEE2                    DW  INTE88
       ED0C                     IFDINT1:
001C13 ED0C BEE2                    DW  INTE88
       ED0E                     IFDINT2:
001C15 ED0E BEE2                    DW  INTE88
                                
001C17 ED10                         DS  030H-18
       ED2E                     EXTSP:
                                
[EOF:88INTVEC.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001C35 ED2E                     PATHD:  DS  PATHX
001C70 ED69 00                  PATHE:  DB  0
                                
       ED6A                     DTA_CCP:
001C71 ED6A                         DS  37
                                
       ED8F                     FCB_BAT:
001C96 ED8F                         DS  37
                                
001CBB EDB4 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001CC6 EDBF 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
       EDC6                     AT_WORK:
001CCD EDC6                         DS  WORKAD-AT_WORK
                                
       EE00                     CPM_BOOT:
001D07 EE00 C30000          10      JP  0
       EE03                     _SYS00:     ;(BDOS)プログラム終了
       EE03                     CPM_WBOOT:
001D0A EE03 C309D9          10      JP  WBOOT1
       EE06                     CPM_CONST:
001D0D EE06 C339E3          10      JP  CONSTX
       EE09                     _SYS07:     ;(BDOS)コンソール直接入力
       EE09                     CPM_CONIN:
001D10 EE09 C31DE3          10      JP  FLGET
       EE0C                     CPM_CONOUT:
001D13 EE0C C380E1          10      JP  CONOUT1
                                
       EE0F                     DECBF:              ;10進数表示時のバッファ(5バイト)
001D16 EE0F                         DS  5
       EE0F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       EE11                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
001D1B EE14 00                  FDRV:   DB  0
001D1C EE15                     FNAME:  DS  36
001D40 EE39                     SFILE:  DS  33      ;DRV FILENAME
                                
001D61 EE5A                         DS  3
                                
001D64 EE5D 0000                LEFTX:  DW  0
001D66 EE5F 0000                DTAX:   DW  0
                                
       EE61                     ZERO:
       EE61                     BEEPD:
001D68 EE61 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
001D70 EE69 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
       EE62                     RTC_YY  EQU BEEPD+1
       EE63                     RTC_MW  EQU BEEPD+2
       EE64                     RTC_DD  EQU BEEPD+3
       EE65                     RTC_TT  EQU BEEPD+4
       EE66                     RTC_MM  EQU BEEPD+5
       EE67                     RTC_SS  EQU BEEPD+6
       EE62                     ROM_SLT EQU BEEPD+1
                                
001D77 EE70 00                  CHECK:  DB  0
                                
001D78 EE71 4F4B24              OK: DB  "OK$"
001D7B EE74                         DS  5
001D80 EE79 4572726F722124      COMERM: DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
001D87 EE80 FF                  _CYL0:  DB  0FFH    ;Cylinder
001D88 EE81 FF                  _CYL1:  DB  0FFH    ;Cylinder
001D89 EE82 FF                  _CYL2:  DB  0FFH    ;Cylinder
001D8A EE83 FF                  _CYL3:  DB  0FFH    ;Cylinder
001D8B EE84 00                  _DRIVE: DB  0   ;unit number
       EE85                     _SEEKSP:
001D8C EE85 00                      DB  0   ;Seek speed
001D8D EE86 FF                  _ISEEK: DB  0FFH    ;
001D8E EE87                         DS  1
001D8F EE88 00                  _DRV:   DB  0
001D90 EE89 FF                  _DSK:   DB  0FFH
001D91 EE8A 8000                _DTA:   DW  00080H
001D93 EE8C 0000                _CTC:   DW  0
001D95 EE8E 0000                _TXADR: DW  0
001D97 EE90 0000                _KEYPS: DW  0
001D99 EE92 00FF                _KEYD:  DW  0FF00H  ;キーデータ
001D9B EE94 0010                _KEYSP: DB  KEYSP_L,KEYSP_H ;オートリピートの速度
       EE96                     _COLORF:
001D9D EE96 00                      DB  COLORF  ;色
001D9E EE97 18                  _LINE:  DB  LINE
                                
001D9F EE98 0000                _FCB:   DW  0   ;SEARCH FILES
001DA1 EE9A 0000                _FBPS:  DW  0   ;    //
001DA3 EE9C 0000                _FBAD:  DW  0   ;    //
001DA5 EE9E 00                  _FBCNT: DB  0   ;    //
001DA6 EE9F 00                  _FILEN: DB  0   ;    //
001DA7 EEA0 00                  _DIRF:  DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
001DA8 EEA1                         DS  1
       EEA2                     _WTFATF:
001DA9 EEA2 00                      DB  0   ;FATバッファの更新フラグ
001DAA EEA3                         DS  1
001DAB EEA4 00                  _WTDBF: DB  0   ;データバッファの更新フラグ
001DAC EEA5 FF                  _DBDRV: DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
001DAD EEA6 0000                _DBSEC: DW  0   ;データバッファにあるデータを読み込んだセクタ番号
001DAF EEA8 0000                _DPB:   DW  0
       EEAA                     _FATDRV:
001DB1 EEAA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
001DB2 EEAB 00                  _FATIX: DB  0   ;FATバッファに読み込んでいるインデックス
       EEAC                     _FAKEFREE:
001DB3 EEAC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
001DB5 EEAE                         DS  2
                                
       EEB0                     CRTCD:
001DB7 EEB0 6F                      DB  06FH
       EEB1                     _WIDTH:
001DB8 EEB1 50                      DB  WIDTH
       EEB2                     TVRAMTOP:
001DB9 EEB2 5938                    DB  059H,038H
001DBB EEB4 1F02                    DB  01FH,002H
       EEB6                     _LINE2:
001DBD EEB6 19                      DB  019H
       EEB7                     WKE4:
001DBE EEB7 1C                      DB  01CH
       EEB8                     WKE6:
001DBF EEB8 00                      DB  000H
       EEB9                     WK40:
001DC0 EEB9 07                      DB  007H
       EEBA                     _PAGE_MINUS:
001DC1 EEBA 80F8                    DW  0-WIDTH*LINE
       EEBC                     _WIDTH_MINUS:
001DC3 EEBC B0FF                    DW  0-WIDTH
       EEBE                     WK30:
001DC5 EEBE 0C                      DB  00CH
       EEBF                     WK31:
       EEBF                     WK1FD0:
001DC6 EEBF 20                      DB  020H
                                
001DC7 EEC0 0000                CTC0:   DW  INTCTCE
001DC9 EEC2 0000                CTC1:   DW  INTCTCE
001DCB EEC4 0000                CTC2:   DW  INTCTCE
001DCD EEC6 0000                CTC3:   DW  INTCTCE
001DCF EEC8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
001DD1 EECA C303E2          10  _INKEY: JP  INKEY
001DD4 EECD C33FE1          10  _PRINT: JP  PRINT
001DD7 EED0 C369E2          10  _SCRN:  JP  SCRN
001DDA EED3 C3A5E1          10  _POS:   JP  POS
001DDD EED6 C39DF0          10  _LOC:   JP  LOC
       EED9                     _CHGDRV:
001DE0 EED9 C3C9E9          10      JP  CHGDRV
       EEDC                     _GETDPB:
001DE3 EEDC C387EA          10      JP  GETDPB
       EEDF                     _FFLUSH:
001DE6 EEDF C3A5EA          10      JP  FFLUSH
       EEE2                     _RDFATX:
001DE9 EEE2 C3A5E6          10      JP  RDFATX
001DEC EEE5 C3D4E7          10  _RDFAT: JP  RDFAT
001DEF EEE8 C374EB          10  _WTTRK: JP  WTTRK
001DF2 EEEB C30EEC          10  _FDRD:  JP  FDRD
001DF5 EEEE C376EB          10  _FDWT:  JP  FDWT
       EEF1                     _BPB2DPB:
001DF8 EEF1 C365E8          10      JP  BPB2DPB
       EEF4                     _BREAK:
001DFB EEF4 C3ADDA          10      JP  END_BATCH
       EEF7                     _GNCL:
001DFE EEF7 C34EE7          10      JP  GNCL        ; self-modifying code
       EEF8                     GNCPAT  EQU $-2
       EEFA                     _SNCL:
001E01 EEFA C371E7          10      JP  SNCL        ; self-modifying code
       EEFB                     SNCPAT  EQU $-2
       EEFD                     _COMANL:
001E04 EEFD C366D9          10      JP  COMANL
                                
       EF00                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       EF00                     STABLE:
                                ;0
001E07 EF00 03EEF0E2FCE2ABF1        DW  _SYS00,_SYS01,_SYS02,_SYS03
001E0F EF08 D2DDD2DD01E309EE        DW  _SYS04,_SYS05,_SYS06,_SYS07
001E17 EF10 09E3D4DD70E031E3        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
001E1F EF18 E9DDEEDDFDDD0EDE        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001E27 EF20 62DEA9DEF2DE23DF        DW  _SYS10,_SYS11,_SYS12,_SYS13
001E2F EF28 2BDF41DF56DF4EDF        DW  _SYS14,_SYS15,_SYS16,_SYS17
001E37 EF30 9DDFA2DFA7DFADDF        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001E3F EF38 D2DDD3DFD2DDD7DF        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
001E47 EF40 D2DD8DDF95DFDEDF        DW  _SYS20,_SYS21,_SYS22,_SYS23
001E4F EF48 04E0D2DD55E32DE4        DW  _SYS24,_ERROR,_SYS26,_SYS27
001E57 EF50 95DF0EE09CE0ABF1        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
001E5F EF58 C3E0ABF1D2DD2FE0        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
001E67 EF60 29E0D2DDD2DDD2DD        DW  _SYS30,_ERROR,_ERROR,_ERROR
001E6F EF68 D2DDD2DDD2DDD2DD        DW  _ERROR,_ERROR,_ERROR,_ERROR
001E77 EF70 D2DDABF1ABF150E0        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
001E7F EF78 B5DD                    DW  _DOS2
                                
001E81 EF7A                         DS  1
       EF7B                     _MAX_SEC_SZ_H:
001E82 EF7B 02                      DB  MAX_SEC_SZ_H
       EF7C                     _FATBF:
001E83 EF7C 00F7                    DW  FATBF
       EF7E                     _DTBUF:
001E85 EF7E 00FD                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       EF80                     CTRLTB:
001E87 EF80 A0F0A0F0D7F074F1        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
001E8F EF88 6EF1F8F051F127F1        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
001E97 EF90 A7F0CCF077F11AF1        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
001E9F EF98 4EF10DF17EF1A0F0        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
001EA7 EFA0 A0F0A0F012F1A0F0        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
001EAF EFA8 A0F0A0F0A0F0A0F0        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
001EB7 EFB0 A0F0A0F04EF121F1        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
001EBF EFB8 89F0AEF0C3F077F1        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
001EC7 EFC0 0200                M2D:    DW  2
001EC9 EFC2 FD02                    DB  0FDH,2
001ECB EFC4 6401                    DW  356
001ECD EFC6 FF0728090182            DB  0FFH,7,40,9,1,082H
001ED3 EFCC 0500A7000800            DW  5,0A7H,8
                                
001ED9 EFD2 0200                M2HD:   DW  2
001EDB EFD4 FE01                    DB  0FEH,1
001EDD EFD6 C704                    DW  1223
001EDF EFD8 FE064D080184            DB  0FEH,6,77,8,1,084H
001EE5 EFDE 0500A7000900            DW  5,0A7H,9
                                
001EEB EFE4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
001EED EFE6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
001EEF EFE8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
001EF1 EFEA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       EFEE                     SDDATAE:
                                
001EF5 EFEE                         DS  2
       EFF0                     _FCB_BAT:
001EF7 EFF0 8FED                    DW  FCB_BAT
       EFF2                     _PATH:
001EF9 EFF2 2EED                    DW  PATHD
                                
001EFB EFF4                     SCDIR:  DS  2       ;+14 +15
001EFD EFF6                     SFBPS:  DS  2       ;FBPS
001EFF EFF8                     SFNDF:  DS  2       ;FILEN DIRF
                                
001F01 EFFA 0000                _FATPS: DW  0
001F03 EFFC 0000                _DIRPS: DW  0
001F05 EFFE 0000                _CLPS:  DW  0
                                
       F000                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり
                                
       F000                     FILEC:
001F07 F000 CD0BF0          17      CALL    FILE
       F003                     FILEC2:
001F0A F003 3A15EE          13      LD  A,(FDRV+1)
001F0D F006 FE20             7      CP  020H
001F0F F008 C8              11      RET Z
001F10 F009 1839            12      JR  SETDIR1
                                
       F00B                     FILE:
001F12 F00B AF               4      XOR A
001F13 F00C 3214EE          13      LD  (FDRV),A
001F16 F00F 67               4      LD  H,A
001F17 F010 6F               4      LD  L,A
001F18 F011 2222EE          16      LD  (FDRV+14),HL
001F1B F014 CDE2F0          17      CALL    SPCUT
001F1E F017 CDC7F0          17      CALL    CCHK3
001F21 F01A 2812            12      JR  Z,DEVI1
001F23 F01C 13               6      INC DE
001F24 F01D 1A               7      LD  A,(DE)
001F25 F01E 1B               6      DEC DE
001F26 F01F FE3A             7      CP  ':'
001F28 F021 200B            12      JR  NZ,DEVI1
001F2A F023 1A               7      LD  A,(DE)      ;DRIVE
001F2B F024 CD22F3          17      CALL    CAP
001F2E F027 D640             7      SUB '@'
001F30 F029 13               6      INC DE
001F31 F02A 13               6      INC DE
001F32 F02B 3214EE          13      LD  (FDRV),A
       F02E                     DEVI1:
001F35 F02E 1A               7      LD  A,(DE)
001F36 F02F D65C             7      SUB 05CH        ;\
001F38 F031 2009            12      JR  NZ,NOROOT
001F3A F033 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
001F3B F034 222EEE          16      LD  (FDRV+26),HL
001F3E F037 2C               4      INC L
001F3F F038 2222EE          16      LD  (FDRV+14),HL
001F42 F03B 13               6      INC DE
       F03C                     NOROOT:
                                
       F03C                     SETDIR:
001F43 F03C CD68F0          17      CALL    FILED
001F46 F03F 1A               7      LD  A,(DE)
001F47 F040 FE5C             7      CP  05CH        ;\
001F49 F042 C0              11      RET NZ
001F4A F043 13               6      INC DE
       F044                     SETDIR1:
001F4B F044 3E10             7      LD  A,010H      ;Directory
001F4D F046 3221EE          13      LD  (FDRV+13),A
001F50 F049 D5              11      PUSH    DE
001F51 F04A 1114EE          10      LD  DE,FDRV
001F54 F04D 2A1EEF          16      LD  HL,(STABLE+2*00FH)
001F57 F050 CD0F00          17      CALL    JP_HL
001F5A F053 D1              10      POP DE
001F5B F054 B7               4      OR  A
001F5C F055 C0              11      RET NZ
                                
001F5D F056 3A21EE          13      LD  A,(FDRV+13)
001F60 F059 CB67             8      BIT 4,A
001F62 F05B C8              11      RET Z
                                
001F63 F05C CDAFF0          17      CALL    FILEI
001F66 F05F 2A2EEE          16      LD  HL,(FDRV+26)
001F69 F062 23               6      INC HL
001F6A F063 2222EE          16      LD  (FDRV+14),HL
001F6D F066 18D4            12      JR  SETDIR
                                
       F068                     FILED:
001F6F F068 CDAFF0          17      CALL    FILEI
001F72 F06B 2115EE          10      LD  HL,FNAME
                                
001F75 F06E 0608             7      LD  B,8
       F070                     FILE2:
001F77 F070 CDBCF0          17      CALL    CCHKF
001F7A F073 C8              11      RET Z
001F7B F074 FE2A             7      CP  '*'
001F7D F076 282E            12      JR  Z,FILE9
001F7F F078 FE2E             7      CP  '.'
001F81 F07A 280C            12      JR  Z,FILE4
001F83 F07C 77               7      LD  (HL),A
001F84 F07D 23               6      INC HL
001F85 F07E 10F0            13      DJNZ    FILE2
                                
       F080                     FILE3:
001F87 F080 CDBCF0          17      CALL    CCHKF
001F8A F083 C8              11      RET Z
001F8B F084 FE2E             7      CP  '.'
001F8D F086 20F8            12      JR  NZ,FILE3
                                
       F088                     FILE4:
001F8F F088 211DEE          10      LD  HL,FNAME+8
001F92 F08B 0603             7      LD  B,3
                                
       F08D                     FILE4L:
001F94 F08D CDBCF0          17      CALL    CCHKF
001F97 F090 C8              11      RET Z
001F98 F091 FE2E             7      CP  '.'
001F9A F093 2008            12      JR  NZ,FILE12
001F9C F095 3215EE          13      LD  (FNAME),A   ;Parent directory(..)
001F9F F098 3216EE          13      LD  (FNAME+1),A
001FA2 F09B 3E20             7      LD  A,020H
       F09D                     FILE12:
001FA4 F09D FE2A             7      CP  '*'
001FA6 F09F 280A            12      JR  Z,FILE10
001FA8 F0A1 77               7      LD  (HL),A
001FA9 F0A2 23               6      INC HL
001FAA F0A3 10E8            13      DJNZ    FILE4L
001FAC F0A5 C9              10      RET
                                
       F0A6                     FILE9:              ;名前の*処理、名前の残りを?で埋める
001FAD F0A6 CDABF0          17      CALL    FILE10
001FB0 F0A9 18D5            12      JR  FILE3
                                
       F0AB                     FILE10:
001FB2 F0AB 3E3F             7      LD  A,'?'
001FB4 F0AD 1808            12      JR  FILL_MEMORY
       F0AF                     FILEI:              ;名前＋拡張子をスペースで初期化
001FB6 F0AF 3E20             7      LD  A,020H
001FB8 F0B1 01000B          10      LD  BC,11*256   ;C=0にしておく
001FBB F0B4 2115EE          10      LD  HL,FNAME
       F0B7                     FILL_MEMORY:            ;HLからBバイトAで埋める
001FBE F0B7 77               7      LD  (HL),A
001FBF F0B8 23               6      INC HL
001FC0 F0B9 10FC            13      DJNZ    FILL_MEMORY
001FC2 F0BB C9              10      RET
                                
       F0BC                     CCHKF:
001FC3 F0BC 1A               7      LD  A,(DE)
001FC4 F0BD CDC4F0          17      CALL    CCHK2
001FC7 F0C0 C8              11      RET Z
001FC8 F0C1 C32FF4          10      JP  FKAN
                                
       F0C4                     CCHK2:
001FCB F0C4 0C               4      INC C
001FCC F0C5 0D               4      DEC C
001FCD F0C6 C0              11      RET NZ
       F0C7                     CCHK3:              ;ZF=1 で使えない文字
001FCE F0C7 FE2B             7      CP  '+'
001FD0 F0C9 C8              11      RET Z
001FD1 F0CA FE2C             7      CP  ','
001FD3 F0CC C8              11      RET Z
001FD4 F0CD FE2F             7      CP  '/'
001FD6 F0CF C8              11      RET Z
001FD7 F0D0 FE3A             7      CP  ':'
001FD9 F0D2 C8              11      RET Z
001FDA F0D3 FE3B             7      CP  ';'
001FDC F0D5 C8              11      RET Z
001FDD F0D6 FE3D             7      CP  '='
001FDF F0D8 C8              11      RET Z
001FE0 F0D9 FE5C             7      CP  05CH    ;\
001FE2 F0DB C8              11      RET Z
001FE3 F0DC FE20             7      CP  020H
001FE5 F0DE D0              11      RET NC
001FE6 F0DF BF               4      CP  A       ;Z=1
001FE7 F0E0 C9              10      RET
                                
       F0E1                     SS1:
001FE8 F0E1 13               6      INC DE
       F0E2                     SPCUT:              ;スペースをカット
001FE9 F0E2 1A               7      LD  A,(DE)
001FEA F0E3 FE20             7      CP  020H
001FEC F0E5 28FA            12      JR  Z,SS1
001FEE F0E7 C9              10      RET
                                
       F0E8                     SETDRVF:
001FEF F0E8 1114EE          10      LD  DE,FDRV
       F0EB                     SETDRV0:
001FF2 F0EB CDF4F0          17      CALL    SETDRV
001FF5 F0EE FDE1            14      POP IY
001FF7 F0F0 C1              10      POP BC
001FF8 F0F1 D1              10      POP DE
001FF9 F0F2 E1              10      POP HL
001FFA F0F3 C9              10      RET
                                
       F0F4                     SETDRV:
001FFB F0F4 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
001FFC F0F5 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
001FFD F0F6 C5              11      PUSH    BC
001FFE F0F7 1A               7      LD  A,(DE)
001FFF F0F8 D5              11      PUSH    DE
002000 F0F9 FDE3            23      EX  (SP),IY
                                
002002 F0FB CD02F1          17      CALL    GETDRV
002005 F0FE CDD9EE          17      CALL    _CHGDRV
                                
002008 F101 E9               4      JP  (HL)
                                
       F102                     GETDRV:
002009 F102 CD15F1          17      CALL    GETDRV1
00200C F105 3288EE          13      LD  (_DRV),A
00200F F108 C9              10      RET
                                
       F109                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
002010 F109 CD15F1          17      CALL    GETDRV1
002013 F10C C5              11      PUSH    BC
002014 F10D 4F               4      LD  C,A
002015 F10E 1A               7      LD  A,(DE)
002016 F10F CD15F1          17      CALL    GETDRV1
002019 F112 A9               4      XOR C
00201A F113 C1              10      POP BC
00201B F114 C9              10      RET
       F115                     GETDRV1:
00201C F115 E67F             7      AND 07FH
00201E F117 D601             7      SUB 001H
002020 F119 D0              11      RET NC
002021 F11A 3A0400          13      LD  A,(_DVSW)   ;Current Drive
002024 F11D C9              10      RET
                                
       F11E                     SOPENX:
002025 F11E 1139EE          10      LD  DE,SFILE
002028 F121 FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
00202B F124 CD09F1          17      CALL    IS_SAME_DRV_A_DE
00202E F127 2024            12      JR  NZ,SOPEN
002030 F129 13               6      INC DE
002031 F12A FDE5            15      PUSH    IY
002033 F12C E1              10      POP HL
002034 F12D 23               6      INC HL
002035 F12E CDBAF2          17      CALL    CPFILE
002038 F131 201A            12      JR  NZ,SOPEN
                                
00203A F133 2AF4EF          16      LD  HL,(SCDIR)
00203D F136 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
002040 F139 FD740F          19      LD  (IY+15),H
                                
002043 F13C 2AF8EF          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
002046 F13F 229FEE          16      LD  (_FILEN),HL
                                
002049 F142 ED5BF6EF        20      LD  DE,(SFBPS)
00204D F146 2139EE          10      LD  HL,SFILE
002050 F149 36FF            10      LD  (HL),0FFH
002052 F14B 23               6      INC HL
002053 F14C C9              10      RET
       F14D                     SOPEN:
002054 F14D 2162F2          10      LD  HL,FILESE
       F150                     SOPENC:
002057 F150 2289F1          16      LD  (OPENPAT),HL
                                
00205A F153 CDE2EE          17      CALL    _RDFATX     ;Detect Media
00205D F156 3856            12      JR  C,RDDERR
                                
00205F F158 AF               4      XOR A
002060 F159 329FEE          13      LD  (_FILEN),A
002063 F15C CD62F3          17      CALL    LDDIRX1     ;A=0で呼び出す
002066 F15F 2818            12      JR  Z,SDIRX1
                                
002068 F161 CD53F2          17      CALL    READ_DIR    ;Sub Directory
00206B F164 3808            12      JR  C,SDIRX0
00206D F166 2A7EEF          16      LD  HL,(_DTBUF)
002070 F169 7E               7      LD  A,(HL)
002071 F16A FE2E             7      CP  '.'
002073 F16C 280F            12      JR  Z,SOPEN1
       F16E                     SDIRX0:
002075 F16E AF               4      XOR A
002076 F16F 32A0EE          13      LD  (_DIRF),A
002079 F172 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
00207D F176 FD770F          19      LD  (IY+15),A
       F179                     SDIRX1:
002080 F179 ED5BFCEF        20      LD  DE,(_DIRPS) ;Root Directory
       F17D                     SOPEN1:
002084 F17D 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       F17E                     SDECPAT EQU $-1
       F17F                     SOPEN1X:
002086 F17F CD53F2          17      CALL    READ_DIR    ;FILE SEARCH
002089 F182 382A            12      JR  C,RDDERR
00208B F184 2A7EEF          16      LD  HL,(_DTBUF)
       F187                     SOPEN2:
00208E F187 D5              11      PUSH    DE
00208F F188 CD62F2          17      CALL    FILESE      ;(self-modifying code)
       F189                     OPENPAT EQU $-2
002092 F18B D1              10      POP DE
002093 F18C 386D            12      JR  C,SOPENE
002095 F18E 281B            12      JR  Z,SCF_FF_RET
       F190                     SOPEN3:
002097 F190 3AA0EE          13      LD  A,(_DIRF)   ;ディレクトリか判別
00209A F193 B7               4      OR  A
00209B F194 200C            12      JR  NZ,SOPEN5
00209D F196 13               6      INC DE      ;ルートディレクトリ
00209E F197 E5              11      PUSH    HL
00209F F198 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       F199                     MD_PAT  EQU $-2
0020A2 F19B ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
0020A4 F19D E1              10      POP HL
0020A5 F19E 20DD            12      JR  NZ,SOPEN1
0020A7 F1A0 1807            12      JR  SOPEN6
       F1A2                     SOPEN5:
0020A9 F1A2 CDCDE7          17      CALL    GNCLX       ;END DIR
0020AC F1A5 D8              11      RET C
0020AD F1A6 CD1AF3          17      CALL    ENDCL
       F1A9                     SOPEN6:
0020B0 F1A9 38D2            12      JR  C,SOPEN1
       F1AB                     SCF_FF_RET:
0020B2 F1AB 37               4      SCF         ;CF=1
0020B3 F1AC 9F               4      SBC A,A     ;A=0FFH
0020B4 F1AD C9              10      RET
                                
       F1AE                     RDDERR:
0020B5 F1AE BF               4      CP  A       ;READ ERR CF=1 ZF=1
0020B6 F1AF 37               4      SCF
0020B7 F1B0 C9              10      RET
                                
       F1B1                     NOPEN:
0020B8 F1B1 2162F2          10      LD  HL,FILESE
0020BB F1B4 2289F1          16      LD  (OPENPAT),HL
0020BE F1B7 FD2A98EE        20      LD  IY,(_FCB)
0020C2 F1BB CD42F4          17      CALL    CHKWILDX
0020C5 F1BE 30EB            12      JR  NC,SCF_FF_RET
0020C7 F1C0 FD7E00          19      LD  A,(IY+0)
0020CA F1C3 CD02F1          17      CALL    GETDRV
0020CD F1C6 CDD9EE          17      CALL    _CHGDRV
0020D0 F1C9 D8              11      RET C
0020D1 F1CA 2AF8EF          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
0020D4 F1CD 229FEE          16      LD  (_FILEN),HL
                                
0020D7 F1D0 CD5DF3          17      CALL    LDDIRX
0020DA F1D3 ED5B9AEE        20      LD  DE,(_FBPS)
0020DE F1D7 CD53F2          17      CALL    READ_DIR
0020E1 F1DA 38D2            12      JR  C,RDDERR
0020E3 F1DC 3A9EEE          13      LD  A,(_FBCNT)
0020E6 F1DF 3D               4      DEC A
0020E7 F1E0 28AE            12      JR  Z,SOPEN3
       F1E2                     NOPEN2:
0020E9 F1E2 2A9CEE          16      LD  HL,(_FBAD)
0020EC F1E5 012000          10      LD  BC,020H
0020EF F1E8 09              11      ADD HL,BC
0020F0 F1E9 4F               4      LD  C,A
0020F1 F1EA 189B            12      JR  SOPEN2
                                
       F1EC                     SOPENE2:
0020F3 F1EC 229CEE          16      LD  (_FBAD),HL
0020F6 F1EF 79               4      LD  A,C
0020F7 F1F0 329EEE          13      LD  (_FBCNT),A
0020FA F1F3 ED539AEE        20      LD  (_FBPS),DE
0020FE F1F7 FD2298EE        20      LD  (_FCB),IY
       F1FB                     SOPENE:
002102 F1FB AF               4      XOR A
002103 F1FC C9              10      RET
                                
       F1FD                     COPEN:
002104 F1FD FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
002108 F201 217FF2          10      LD  HL,NEXTSE
00210B F204 CD50F1          17      CALL    SOPENC
00210E F207 D0              11      RET NC
00210F F208 C8              11      RET Z
002110 F209 3AA0EE          13      LD  A,(_DIRF)   ;ディレクトリか判別
002113 F20C B7               4      OR  A
002114 F20D 37               4      SCF
002115 F20E C8              11      RET Z       ;ルートディレクトリ
002116 F20F 0601             7      LD  B,1
002118 F211 CDA1F4          17      CALL    WRDF
00211B F214 D8              11      RET C
00211C F215 ED5BFEEF        20      LD  DE,(_CLPS)
002120 F219 D5              11      PUSH    DE
002121 F21A CDE3F2          17      CALL    DCPAT
002124 F21D CD51E6          17      CALL    DRDNX
002127 F220 2A7EEF          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
00212A F223 3A37E5          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
00212D F226 47               4      LD  B,A
00212E F227 AF               4      XOR A
00212F F228 4F               4      LD  C,A
       F229                     COPENCL:
002130 F229 77               7      LD  (HL),A
002131 F22A EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
002133 F22C EA29F2          10      JP  PE,COPENCL
                                
002136 F22F 3A01F3          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
002139 F232 3D               4      DEC A
00213A F233 2819            12      JR  Z,COPENE
00213C F235 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
00213E F237 32C5E7          13      LD  (_SECPS),A
002141 F23A D1              10      POP DE      ;DE=(_CLPS)
002142 F23B D5              11      PUSH    DE
       F23C                     COPEN1:
002143 F23C D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
002144 F23D C5              11      PUSH    BC
002145 F23E 2A7EEF          16      LD  HL,(_DTBUF)
002148 F241 CDFDF2          17      CALL    CLUSTX
00214B F244 CD61E9          17      CALL    DWT24
00214E F247 C1              10      POP BC
00214F F248 D1              10      POP DE
002150 F249 CDC4E7          17      CALL    NEXTX
002153 F24C 20EE            12      JR  NZ,COPEN1
       F24E                     COPENE:
002155 F24E 2A7EEF          16      LD  HL,(_DTBUF)
002158 F251 D1              10      POP DE
002159 F252 C9              10      RET
                                
       F253                     READ_DIR:
00215A F253 ED53FEEF        20      LD  (_CLPS),DE
00215E F257 C5              11      PUSH    BC
00215F F258 D5              11      PUSH    DE
002160 F259 CDE3F2          17      CALL    DCPAT
002163 F25C CD31E6          17      CALL    DRDX
002166 F25F D1              10      POP DE
002167 F260 C1              10      POP BC
002168 F261 C9              10      RET
                                
       F262                     FILESE:
002169 F262 7E               7      LD  A,(HL)
00216A F263 B7               4      OR  A
00216B F264 C8              11      RET Z       ;END:ZF=1 CF=0
00216C F265 FEE5             7      CP  0E5H
00216E F267 280E            12      JR  Z,FILESE1
002170 F269 FDE5            15      PUSH    IY
002172 F26B D1              10      POP DE
002173 F26C 13               6      INC DE
002174 F26D E5              11      PUSH    HL
002175 F26E CDBAF2          17      CALL    CPFILE
002178 F271 CCDBF2          17      CALL    Z,CPFILE2
00217B F274 E1              10      POP HL
00217C F275 37               4      SCF
00217D F276 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       F277                     FILESE1:
00217E F277 CD8EF2          17      CALL    FNEXT
002181 F27A 20E6            12      JR  NZ,FILESE
       F27C                     ZF0_CF0_AFF_RET:
002183 F27C F6FF             7      OR  0FFH        ;ZF=0 CF=0
002185 F27E C9              10      RET
                                
       F27F                     NEXTSE:
002186 F27F 7E               7      LD  A,(HL)
002187 F280 B7               4      OR  A
002188 F281 37               4      SCF
002189 F282 C8              11      RET Z       ;!!!:ZF=1 CF=1
00218A F283 FEE5             7      CP  0E5H
00218C F285 37               4      SCF
00218D F286 C8              11      RET Z       ;!!!:(ZF=1) CF=1
00218E F287 CD8EF2          17      CALL    FNEXT
002191 F28A 20F3            12      JR  NZ,NEXTSE
002193 F28C 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       F28E                     FNEXT:
002195 F28E E5              11      PUSH    HL
002196 F28F 219FEE          10      LD  HL,_FILEN
002199 F292 34              11      INC (HL)
00219A F293 E1              10      POP HL
00219B F294 112000          10      LD  DE,020H
00219E F297 19              11      ADD HL,DE
00219F F298 0D               4      DEC C
0021A0 F299 C9              10      RET
                                
       F29A                     CPNAME:
0021A1 F29A C5              11      PUSH    BC
0021A2 F29B D5              11      PUSH    DE
0021A3 F29C E5              11      PUSH    HL
0021A4 F29D CDB4F2          17      CALL    CPFILE4
0021A7 F2A0 E1              10      POP HL
0021A8 F2A1 23               6      INC HL
0021A9 F2A2 23               6      INC HL
0021AA F2A3 23               6      INC HL
0021AB F2A4 23               6      INC HL
0021AC F2A5 D1              10      POP DE
0021AD F2A6 C1              10      POP BC
0021AE F2A7 2005            12      JR  NZ,CPNAME1
0021B0 F2A9 7E               7      LD  A,(HL)
0021B1 F2AA 23               6      INC HL
0021B2 F2AB 66               7      LD  H,(HL)
0021B3 F2AC 6F               4      LD  L,A
0021B4 F2AD C9              10      RET
       F2AE                     CPNAME1:
0021B5 F2AE 23               6      INC HL
0021B6 F2AF 23               6      INC HL
0021B7 F2B0 10E8            13      DJNZ    CPNAME
0021B9 F2B2 37               4      SCF
0021BA F2B3 C9              10      RET
                                
       F2B4                     CPFILE4:
0021BB F2B4 C5              11      PUSH    BC
0021BC F2B5 010004          10      LD  BC,00400H
0021BF F2B8 1804            12      JR  CPSTR1
       F2BA                     CPFILE:
0021C1 F2BA C5              11      PUSH    BC
0021C2 F2BB 01000B          10      LD  BC,00B00H
       F2BE                     CPSTR1:
0021C5 F2BE 1A               7      LD  A,(DE)
0021C6 F2BF FE3F             7      CP  '?'     ;Wild card
0021C8 F2C1 2812            12      JR  Z,CPSTR2
0021CA F2C3 7E               7      LD  A,(HL)
0021CB F2C4 CD28F4          17      CALL    FKANC
0021CE F2C7 E5              11      PUSH    HL
0021CF F2C8 67               4      LD  H,A
0021D0 F2C9 1A               7      LD  A,(DE)
0021D1 F2CA CB01             4      RLC C
0021D3 F2CC CD28F4          17      CALL    FKANC
0021D6 F2CF CB09             4      RRC C
0021D8 F2D1 BC               4      CP  H       ;CP (HL),(DE)
0021D9 F2D2 E1              10      POP HL
0021DA F2D3 2004            12      JR  NZ,CPSTR3
       F2D5                     CPSTR2:
0021DC F2D5 13               6      INC DE
0021DD F2D6 23               6      INC HL
0021DE F2D7 10E5            13      DJNZ    CPSTR1
       F2D9                     CPSTR3:
0021E0 F2D9 C1              10      POP BC
0021E1 F2DA C9              10      RET
                                
       F2DB                     CPFILE2:
0021E2 F2DB FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0021E5 F2DE F6E1             7      OR  0E1H
0021E7 F2E0 2F               4      CPL
0021E8 F2E1 A6               7      AND (HL)
0021E9 F2E2 C9              10      RET
                                
       F2E3                     DCPAT:
0021EA F2E3 0E00             7      LD  C,0
0021EC F2E5 2A7EEF          16      LD  HL,(_DTBUF)
0021EF F2E8 3AA0EE          13      LD  A,(_DIRF)   ;ディレクトリか判別
0021F2 F2EB B7               4      OR  A
0021F3 F2EC C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
0021F4 F2ED 3A01F3          13      LD  A,(SPCPAT)
0021F7 F2F0 4F               4      LD  C,A
0021F8 F2F1 3AC5E7          13      LD  A,(_SECPS)
0021FB F2F4 B9               4      CP  C
0021FC F2F5 3801            12      JR  C,DC1
0021FE F2F7 AF               4      XOR A
       F2F8                     DC1:
0021FF F2F8 F680             7      OR  080H
002201 F2FA 32A0EE          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       F2FD                     CLUSTX:
002204 F2FD E5              11      PUSH    HL
002205 F2FE EB               4      EX  DE,HL
002206 F2FF AF               4      XOR A
002207 F300 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       F301                     SPCPAT  EQU $-1
       F302                     L_CLDBL:
002209 F302 CB19             8      RR  C       ;->CF
00220B F304 3804            12      JR  C,E_CLDBL
00220D F306 29              11      ADD HL,HL       ;*2
00220E F307 8F               4      ADC A,A
00220F F308 18F8            12      JR  L_CLDBL
       F30A                     E_CLDBL:
002211 F30A 4F               4      LD  C,A
002212 F30B 3AC5E7          13      LD  A,(_SECPS)
002215 F30E B5               4      OR  L
002216 F30F 6F               4      LD  L,A
002217 F310 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       F311                     CLSPAT  EQU $-2
00221A F313 AF               4      XOR A
00221B F314 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
00221C F315 89               4      ADC A,C
00221D F316 4F               4      LD  C,A
00221E F317 EB               4      EX  DE,HL
00221F F318 E1              10      POP HL
002220 F319 C9              10      RET
                                
       F31A                     ENDCL:
002221 F31A 7A               4      LD  A,D ;END CLUSTER
002222 F31B FE01             7      CP  1   ;164=356    (self-modifying code)
       F31C                     CLPAT1  EQU $-1
002224 F31D C0              11      RET NZ
002225 F31E 7B               4      LD  A,E
002226 F31F FE64             7      CP  064H    ;       (self-modifying code)
       F320                     CLPAT2  EQU $-1
002228 F321 C9              10      RET
                                
       F322                     CAP:
002229 F322 FE61             7      CP  'a'
00222B F324 D8              11      RET C
00222C F325 FE7B             7      CP  'z'+1
00222E F327 D0              11      RET NC
00222F F328 D620             7      SUB 020H
002231 F32A C9              10      RET
       F32B                     CAP2:
002232 F32B CD22F3          17      CALL    CAP
       F32E                     CAP3:               ;
002235 F32E FE05             7      CP  5
002237 F330 2803            12      JR  Z,CAP4
002239 F332 FE21             7      CP  021H
00223B F334 C9              10      RET
       F335                     CAP4:
00223C F335 3EE5             7      LD  A,0E5H
00223E F337 C9              10      RET
                                
       F338                     CHDIR:
00223F F338 CD74EA          17      CALL    GETDPBD
002242 F33B 381D            12      JR  C,CHDIR2
002244 F33D DD751A          19      LD  (IX+DPB_SDIR),L
002247 F340 DD741B          19      LD  (IX+DPB_SDIR+1),H
00224A F343 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       F345                     LDDIR:
00224C F345 CD74EA          17      CALL    GETDPBD
00224F F348 DD5E1A          19      LD  E,(IX+DPB_SDIR)
002252 F34B DD561B          19      LD  D,(IX+DPB_SDIR+1)
002255 F34E 13               6      INC DE
002256 F34F FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
002259 F352 FD720F          19      LD  (IY+15),D
00225C F355 1B               6      DEC DE
00225D F356 AF               4      XOR A
00225E F357 32A0EE          13      LD  (_DIRF),A
       F35A                     CHDIR2:
002261 F35A DDE1            14      POP IX
002263 F35C C9              10      RET
                                
       F35D                     LDDIRX:
002264 F35D 3AA0EE          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
002267 F360 E67F             7      AND 07FH
       F362                     LDDIRX1:
002269 F362 32C5E7          13      LD  (_SECPS),A
00226C F365 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00226F F368 FD560F          19      LD  D,(IY+15)
002272 F36B 1B               6      DEC DE
002273 F36C CD1AF3          17      CALL    ENDCL
002276 F36F D445F3          17      CALL    NC,LDDIR
       F372                     LDDIRS:
002279 F372 7A               4      LD  A,D
00227A F373 B3               4      OR  E
00227B F374 32A0EE          13      LD  (_DIRF),A   ;ディレクトリか判別
00227E F377 C9              10      RET
                                
       F378                     KILL:
00227F F378 CD42F4          17      CALL    CHKWILDX
002282 F37B 3834            12      JR  C,KILLW
002284 F37D CD1EF1          17      CALL    SOPENX
       F380                     KILLS:
002287 F380 3E1F             7      LD  A,01FH
002289 F382 D4C4F3          17      CALL    NC,CHKATT
00228C F385 D8              11      RET C
       F386                     KILLSX:
00228D F386 36E5            10      LD  (HL),0E5H   ;DIR
00228F F388 CD1CF4          17      CALL    WTDB
002292 F38B 111A00          10      LD  DE,01AH
002295 F38E 19              11      ADD HL,DE
002296 F38F 5E               7      LD  E,(HL)
002297 F390 23               6      INC HL
002298 F391 56               7      LD  D,(HL)
       F392                     KILLS1:
002299 F392 CD1AF3          17      CALL    ENDCL
00229C F395 D0              11      RET NC      ;CF=0
00229D F396 21FEFF          10      LD  HL,0-2
0022A0 F399 19              11      ADD HL,DE
0022A1 F39A D0              11      RET NC      ;DE= 0 or 1
0022A2 F39B D5              11      PUSH    DE
0022A3 F39C CDF7EE          17      CALL    _GNCL
0022A6 F39F ED53FEEF        20      LD  (_CLPS),DE
0022AA F3A3 D1              10      POP DE
0022AB F3A4 210000          10      LD  HL,0
0022AE F3A7 D4FAEE          17      CALL    NC,_SNCL
0022B1 F3AA D8              11      RET C
0022B2 F3AB ED5BFEEF        20      LD  DE,(_CLPS)  ;FAT
0022B6 F3AF 18E1            12      JR  KILLS1
                                
       F3B1                     KILLW:
0022B8 F3B1 CD4DF1          17      CALL    SOPEN
       F3B4                     KILLW1:
0022BB F3B4 380B            12      JR  C,KILLW2
0022BD F3B6 CDECF1          17      CALL    SOPENE2
0022C0 F3B9 CD80F3          17      CALL    KILLS
0022C3 F3BC CDB1F1          17      CALL    NOPEN
0022C6 F3BF 18F3            12      JR  KILLW1
       F3C1                     KILLW2:
0022C8 F3C1 C8              11      RET Z
0022C9 F3C2 3F               4      CCF
0022CA F3C3 C9              10      RET
                                
       F3C4                     CHKATT:
0022CB F3C4 E5              11      PUSH    HL
0022CC F3C5 110B00          10      LD  DE,00BH
0022CF F3C8 19              11      ADD HL,DE
0022D0 F3C9 A6               7      AND (HL)
0022D1 F3CA E1              10      POP HL
0022D2 F3CB C8              11      RET Z
0022D3 F3CC 37               4      SCF
0022D4 F3CD C9              10      RET
                                
       F3CE                     NAME:
0022D5 F3CE CD42F4          17      CALL    CHKWILDX
0022D8 F3D1 D8              11      RET C
0022D9 F3D2 110400          10      LD  DE,4
0022DC F3D5 19              11      ADD HL,DE
0022DD F3D6 22EBF3          16      LD  (NAMEP),HL
0022E0 F3D9 23               6      INC HL
0022E1 F3DA CD46F4          17      CALL    CHKWILD
0022E4 F3DD D8              11      RET C
                                
0022E5 F3DE CD1EF1          17      CALL    SOPENX
0022E8 F3E1 3E0F             7      LD  A,00FH
0022EA F3E3 D4C4F3          17      CALL    NC,CHKATT
0022ED F3E6 D8              11      RET C
                                
0022EE F3E7 FDE5            15      PUSH    IY
0022F0 F3E9 FD210000        14      LD  IY,0        ;自己書き換え
       F3EB                     NAMEP   EQU $-2
0022F4 F3ED CD1EF1          17      CALL    SOPENX
0022F7 F3F0 FDE3            23      EX  (SP),IY
0022F9 F3F2 3F               4      CCF
0022FA F3F3 D44DF1          17      CALL    NC,SOPEN
0022FD F3F6 EB               4      EX  DE,HL
0022FE F3F7 E1              10      POP HL
0022FF F3F8 D8              11      RET C
                                
       F3F9                     SETNAME:
002300 F3F9 01000B          10      LD  BC,11*256
002303 F3FC 23               6      INC HL
002304 F3FD 7E               7      LD  A,(HL)
002305 F3FE FEE5             7      CP  0E5H
002307 F400 2004            12      JR  NZ,SNAME1
002309 F402 3E05             7      LD  A,5
00230B F404 180E            12      JR  SNAME3
       F406                     SNAME1:
00230D F406 7E               7      LD  A,(HL)
00230E F407 0C               4      INC C
00230F F408 0D               4      DEC C
002310 F409 2009            12      JR  NZ,SNAME3
002312 F40B CD22F3          17      CALL    CAP
002315 F40E FEA0             7      CP  0A0H
002317 F410 2002            12      JR  NZ,SNAME3
002319 F412 3E20             7      LD  A,020H
       F414                     SNAME3:
00231B F414 12               7      LD  (DE),A
00231C F415 7E               7      LD  A,(HL)
00231D F416 23               6      INC HL
00231E F417 CD2FF4          17      CALL    FKAN
002321 F41A 10EA            13      DJNZ    SNAME1
       F41C                     WTDB:
002323 F41C 3EFF             7      LD  A,0FFH
002325 F41E 3239EE          13      LD  (SFILE),A
002328 F421 3E01             7      LD  A,1
00232A F423 32A4EE          13      LD  (_WTDBF),A
00232D F426 AF               4      XOR A
00232E F427 C9              10      RET
                                
       F428                     FKANC:
00232F F428 CB41             8      BIT 0,C
002331 F42A CC2BF3          17      CALL    Z,CAP2
002334 F42D 1801            12      JR  FKANX
       F42F                     FKAN:           ;漢字チェック
002336 F42F 13               6      INC DE
       F430                     FKANX:
002337 F430 CB41             8      BIT 0,C
002339 F432 CB81             8      RES 0,C
00233B F434 C0              11      RET NZ
00233C F435 FE80             7      CP  080H
00233E F437 D8              11      RET C
00233F F438 FEA0             7      CP  0A0H
002341 F43A 3803            12      JR  C,FKAN1
002343 F43C FEE0             7      CP  0E0H
002345 F43E D8              11      RET C
       F43F                     FKAN1:
002346 F43F 0C               4      INC C
002347 F440 A7               4      AND A
002348 F441 C9              10      RET
                                
       F442                     CHKWILDX:
002349 F442 FDE5            15      PUSH    IY
00234B F444 E1              10      POP HL
00234C F445 23               6      INC HL
       F446                     CHKWILD:
00234D F446 060B             7      LD  B,11
00234F F448 3E3F             7      LD  A,'?'
       F44A                     CHKWIL1:
002351 F44A BE               7      CP  (HL)
002352 F44B 23               6      INC HL
002353 F44C 37               4      SCF
002354 F44D C8              11      RET Z
002355 F44E 10FA            13      DJNZ    CHKWIL1
002357 F450 AF               4      XOR A
002358 F451 C9              10      RET
                                
       F452                     SDIRENT:        ;IY=FCB HL=DIR
002359 F452 D5              11      PUSH    DE
00235A F453 E5              11      PUSH    HL
00235B F454 FDE5            15      PUSH    IY
00235D F456 D1              10      POP DE
00235E F457 EB               4      EX  DE,HL
00235F F458 CDF9F3          17      CALL    SETNAME
                                ;               Attribute
002362 F45B FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
002365 F45E 12               7      LD  (DE),A
002366 F45F 13               6      INC DE
                                ;               Reserved
002367 F460 AF               4      XOR A
002368 F461 060A             7      LD  B,10
       F463                     SDE1:
00236A F463 12               7      LD  (DE),A
00236B F464 13               6      INC DE
00236C F465 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
00236E F467 21E4EF          10      LD  HL,SDDATA       ;(FCB)更新年月日
002371 F46A 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       F46C                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
002373 F46C 7E               7      LD  A,(HL)
002374 F46D 23               6      INC HL
002375 F46E 3273F4          13      LD  (SDPAT),A
002378 F471 FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       F473                     SDPAT   EQU $-1
00237B F474 12               7      LD  (DE),A
00237C F475 13               6      INC DE
00237D F476 10F4            13      DJNZ    SDLOOP
                                
00237F F478 AF               4      XOR A
002380 F479 E1              10      POP HL
002381 F47A D1              10      POP DE
002382 F47B C9              10      RET
                                
       F47C                     WOPEN:
002383 F47C FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
002386 F47F E61F             7      AND 01FH
002388 F481 37               4      SCF
002389 F482 C0              11      RET NZ
00238A F483 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       F487                     TOPEN2:
00238E F487 AF               4      XOR A
       F488                     TOPEN:              ;Initializes the time stamp
00238F F488 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
002393 F48C C9              10      RET
                                
       F48D                     WRDFX:
002394 F48D 3A01F3          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       F490                     L_WRFX:
002397 F490 1F               4      RRA         ;->CF
002398 F491 3806            12      JR  C,E_WRFX
00239A F493 CB39             8      SRL C
00239C F495 CB1C             8      RR  H       ;CH=CH/2
00239E F497 18F7            12      JR  L_WRFX
       F499                     E_WRFX:
0023A0 F499 41               4      LD  B,C
0023A1 F49A 4C               4      LD  C,H
0023A2 F49B 03               6      INC BC
0023A3 F49C 3E37             7      LD  A,037H      ;SCF
0023A5 F49E 324EE6          13      LD  (DRDN1),A
                                
       F4A1                     WRDF:               ;BCクラスタ分FATを確保する
0023A8 F4A1 110200          10      LD  DE,2
0023AB F4A4 AF               4      XOR A
0023AC F4A5 32C5E7          13      LD  (_SECPS),A
       F4A8                     WRDF1:
0023AF F4A8 C5              11      PUSH    BC
0023B0 F4A9 D5              11      PUSH    DE
0023B1 F4AA CDF7EE          17      CALL    _GNCL
0023B4 F4AD 381C            12      JR  C,WRDF3
0023B6 F4AF 7A               4      LD  A,D     ;空いているかチェック
0023B7 F4B0 B3               4      OR  E
0023B8 F4B1 202A            12      JR  NZ,WRDF4
0023BA F4B3 E1              10      POP HL      ;HL=空いているクラスタ
0023BB F4B4 E5              11      PUSH    HL
0023BC F4B5 ED5BFEEF        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
0023C0 F4B9 22FEEF          16      LD  (_CLPS),HL
0023C3 F4BC 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
0023C4 F4BD B3               4      OR  E
0023C5 F4BE 2008            12      JR  NZ,WRDF2
0023C7 F4C0 FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
0023CA F4C3 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
0023CD F4C6 1803            12      JR  WRDF3
       F4C8                     WRDF2:
0023CF F4C8 CDFAEE          17      CALL    _SNCL
       F4CB                     WRDF3:
0023D2 F4CB D1              10      POP DE
0023D3 F4CC C1              10      POP BC
0023D4 F4CD D8              11      RET C
0023D5 F4CE 0B               6      DEC BC
0023D6 F4CF 78               4      LD  A,B
0023D7 F4D0 B1               4      OR  C
0023D8 F4D1 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
0023DA F4D3 ED5BFEEF        20      LD  DE,(_CLPS)
0023DE F4D7 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
0023E1 F4DA C3FAEE          10      JP  _SNCL
                                
       F4DD                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
0023E4 F4DD D1              10      POP DE
0023E5 F4DE C1              10      POP BC
       F4DF                     WRDF5:
0023E6 F4DF 13               6      INC DE
0023E7 F4E0 CD1AF3          17      CALL    ENDCL
0023EA F4E3 38C3            12      JR  C,WRDF1
0023EC F4E5 37               4      SCF
0023ED F4E6 C9              10      RET
                                
       F4E7                     RWXR:
0023EE F4E7 3A37E5          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       F4EA                     L_RWX:
0023F1 F4EA 1F               4      RRA     ;->CF
0023F2 F4EB 3808            12      JR  C,E_RWX
0023F4 F4ED CB38             8      SRL B   ;BCH=BCH/2
0023F6 F4EF CB19             8      RR  C   ;
0023F8 F4F1 CB1C             8      RR  H   ;
0023FA F4F3 18F5            12      JR  L_RWX
       F4F5                     E_RWX:
0023FC F4F5 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0023FF F4F8 FD561B          19      LD  D,(IY+27)
002402 F4FB AF               4      XOR A
002403 F4FC 32C5E7          13      LD  (_SECPS),A
       F4FF                     RWX1:
002406 F4FF ED53FEEF        20      LD  (_CLPS),DE
00240A F503 7A               4      LD  A,D
00240B F504 B3               4      OR  E
00240C F505 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
00240E F507 78               4      LD  A,B
00240F F508 B1               4      OR  C
002410 F509 B4               4      OR  H
002411 F50A C8              11      RET Z       ;RET BCH==0 => CF=0
                                
002412 F50B CDCDE7          17      CALL    GNCLX
002415 F50E D8              11      RET C
002416 F50F 7C               4      LD  A,H     ;
002417 F510 25               4      DEC H       ;
002418 F511 B7               4      OR  A       ;DEC BCH
002419 F512 2001            12      JR  NZ,RWX2     ;
00241B F514 0B               6      DEC BC      ;
       F515                     RWX2:
00241C F515 CD1AF3          17      CALL    ENDCL
00241F F518 38E5            12      JR  C,RWX1
       F51A                     SCF_RET:
002421 F51A 37               4      SCF
002422 F51B C9              10      RET
                                
       F51C                     DSKF:
002423 F51C 110000          10      LD  DE,0
       F51D                     MAXCLP  EQU $-2
002426 F51F 2AACEE          16      LD  HL,(_FAKEFREE)
002429 F522 7C               4      LD  A,H
00242A F523 B5               4      OR  L
00242B F524 2803            12      JR  Z,DSKF1
00242D F526 110100          10      LD  DE,1
       F529                     DSKF1:
002430 F529 D5              11      PUSH    DE
002431 F52A CDF7EE          17      CALL    _GNCL
002434 F52D 380C            12      JR  C,POPSCF
002436 F52F 7A               4      LD  A,D
002437 F530 B3               4      OR  E
002438 F531 2001            12      JR  NZ,DSKF2
00243A F533 23               6      INC HL
       F534                     DSKF2:
00243B F534 D1              10      POP DE
00243C F535 1B               6      DEC DE
00243D F536 7A               4      LD  A,D
00243E F537 B3               4      OR  E
00243F F538 20EF            12      JR  NZ,DSKF1
002441 F53A C9              10      RET
                                
       F53B                     POPSCF:
002442 F53B F1              10      POP AF
002443 F53C 37               4      SCF
002444 F53D C9              10      RET
                                
       F53E                     SETTMS:
002445 F53E FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
002448 F541 3C               4      INC A
002449 F542 C0              11      RET NZ      ;ファイルが更新されていない
       F543                     SETTMSX:            ;FCBに日付時刻をセットする
00244A F543 CDC3E0          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
00244D F546 CB25             8      SLA L       ;   *2
00244F F548 CB25             8      SLA L       ;   *4
002451 F54A 29              11      ADD HL,HL       ;*2 *8
002452 F54B 29              11      ADD HL,HL       ;*4 *16
002453 F54C 29              11      ADD HL,HL       ;*8 *32
002454 F54D 7A               4      LD  A,D
002455 F54E 0F               4      RRCA            ;bit.0->7->->->0->C
002456 F54F E61F             7      AND 01FH
002458 F551 B5               4      OR  L
002459 F552 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
00245C F555 FD7417          19      LD  (IY+23),H
                                
00245F F558 CD9CE0          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
002462 F55B 0144F8          10      LD  BC,0-1980
002465 F55E 09              11      ADD HL,BC
002466 F55F 65               4      LD  H,L
                                
002467 F560 7A               4      LD  A,D
002468 F561 87               4      ADD A,A     ;*2
002469 F562 87               4      ADD A,A     ;*4
00246A F563 87               4      ADD A,A     ;*8
00246B F564 87               4      ADD A,A     ;*16
00246C F565 6F               4      LD  L,A
00246D F566 29              11      ADD HL,HL       ;*32
00246E F567 7D               4      LD  A,L
00246F F568 B3               4      OR  E
002470 F569 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
002473 F56C FD7415          19      LD  (IY+21),H
002476 F56F C9              10      RET
                                
       F570                     PUSHRR:
002477 F570 32E4F5          13      LD  (SETSEQ_SWC_RND),A
00247A F573 22F6F5          16      LD  (SETSEQ_SWC_SEQ_RR),HL
00247D F576 CD96F5          17      CALL    GET_RR_AHL
002480 F579 220FEE          16      LD  (RR_BUF_HL),HL
002483 F57C 3211EE          13      LD  (RR_BUF_A),A
002486 F57F C9              10      RET
                                
       F580                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
002487 F580 87               4      ADD A,A     ;in BHLA => out AHL
002488 F581 ED6A            15      ADC HL,HL
00248A F583 CB18             8      RR  B
00248C F585 B7               4      OR  A
00248D F586 78               4      LD  A,B     ;ここでフラグは変化しない
00248E F587 C8              11      RET Z
00248F F588 2C               4      INC L       ;INC AHL
002490 F589 C0              11      RET NZ      ;
002491 F58A 24               4      INC H       ;
002492 F58B C0              11      RET NZ      ;
002493 F58C 3C               4      INC A       ;
002494 F58D C9              10      RET
                                
       F58E                     INIT_RND:
002495 F58E 3ECD             7      LD  A,0CDH      ;CALL ????
002497 F590 21B9F5          10      LD  HL,POPRR
00249A F593 CD70F5          17      CALL    PUSHRR
       F596                     GET_RR_AHL:
00249D F596 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0024A0 F599 FD6622          19      LD  H,(IY+34)   ;
0024A3 F59C FD7E23          19      LD  A,(IY+35)   ;
0024A6 F59F C9              10      RET
       F5A0                     INIT_SEQ:
0024A7 F5A0 3E01             7      LD  A,1     ;LD BC,????
0024A9 F5A2 21B6F5          10      LD  HL,SETSEQ
0024AC F5A5 CD70F5          17      CALL    PUSHRR
       F5A8                     GETSEQ:
0024AF F5A8 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
0024B2 F5AB FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
0024B5 F5AE AF               4      XOR A
                                
0024B6 F5AF CB25             8      SLA L   ;L=L*2
                                
0024B8 F5B1 CB3C             8      SRL H   ;HL=HL/2
0024BA F5B3 CB1D             8      RR  L   ;
0024BC F5B5 C9              10      RET
                                
       F5B6                     SETSEQ:
0024BD F5B6 CD17E6          17      CALL    SETSEQ1
       F5B9                     POPRR:
0024C0 F5B9 F5              11      PUSH    AF
0024C1 F5BA E5              11      PUSH    HL
0024C2 F5BB 2A0FEE          16      LD  HL,(RR_BUF_HL)
0024C5 F5BE 3A11EE          13      LD  A,(RR_BUF_A)
0024C8 F5C1 CD0DE6          17      CALL    SET_RR_AHL
0024CB F5C4 E1              10      POP HL
0024CC F5C5 F1              10      POP AF
0024CD F5C6 C9              10      RET
                                
       F5C7                     RB_WRITE:
0024CE F5C7 C5              11      PUSH    BC
0024CF F5C8 ED4B4CEF        20      LD  BC,(STABLE+2*026H)  ;(BDOS)ランダムブロック書き込み
0024D3 F5CC 1805            12      JR  RBRW
       F5CE                     RB_READ:
0024D5 F5CE C5              11      PUSH    BC
0024D6 F5CF ED4B4EEF        20      LD  BC,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       F5D3                     RBRW:
0024DA F5D3 1F               4      RRA     ;AHL = AHL*128
0024DB F5D4 7C               4      LD  A,H ;AHL = AHL0/2
0024DC F5D5 1F               4      RRA     ;A
0024DD F5D6 65               4      LD  H,L ;
0024DE F5D7 CB1C             8      RR  H   ;H
0024E0 F5D9 2E00             7      LD  L,0 ;
0024E2 F5DB CB1D             8      RR  L   ;L
0024E4 F5DD CD0DE6          17      CALL    SET_RR_AHL
0024E7 F5E0 218000          10      LD  HL,128
0024EA F5E3 C5              11      PUSH    BC
       F5E4                     SETSEQ_SWC_RND:
0024EB F5E4 CD17E6          17      CALL    SETSEQ1
0024EE F5E7 C1              10      POP BC
0024EF F5E8 FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
0024F3 F5EC FDE5            15      PUSH    IY
0024F5 F5EE D1              10      POP DE
0024F6 F5EF D5              11      PUSH    DE
0024F7 F5F0 CDFEF5          17      CALL    JP_BC
0024FA F5F3 FDE1            14      POP IY
0024FC F5F5 CDB6F5          17      CALL    SETSEQ
       F5F6                     SETSEQ_SWC_SEQ_RR   EQU $-2
0024FF F5F8 FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
002503 F5FC C1              10      POP BC
002504 F5FD C9              10      RET
       F5FE                     JP_BC:
002505 F5FE C5              11      PUSH    BC
002506 F5FF C9              10      RET
                                
       F1AB                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       F1AB                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       F1AB                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       F1AB                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       F1AB                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "88DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   PC-8801mkIISR
                                
       F600                     _DEVICE:
                                
                                ;   A:
                                
002507 F600 0200                    DW  2   ;DPB_FATLN
002509 F602 EBEE                    DW  _FDRD   ;DPB_DRD
00250B F604 EEEE                    DW  _FDWT   ;DPB_DWT
00250D F606 FD                      DB  0FDH    ;DPB_FATID
00250E F607 02                      DB  2   ;DPB_SECPCL
00250F F608 6401                    DW  356 ;DPB_MAXCL
002511 F60A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002512 F60B 07                      DB  7   ;DPB_DIRSCNT
002513 F60C 28                      DB  40  ;DPB_MAXCYL
002514 F60D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002515 F60E 01                      DB  1   ;DPB_FATPS
002516 F60F 82                      DB  082H    ;DPB_BPS
002517 F610 0500                    DW  5   ;DPB_DIRPS
002519 F612 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00251A F613 00                      DB  0   ;DPB_UNITNO
00251B F614 0800                    DW  8   ;DPB_ADDCL
00251D F616 0000                    DW  0   ;DPB_16
00251F F618 0000                    DW  0   ;DPB_18
002521 F61A 0000                    DW  0   ;DPB_SDIR
002523 F61C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002527 F620 0200                    DW  2   ;DPB_FATLN
002529 F622 EBEE                    DW  _FDRD   ;DPB_DRD
00252B F624 EEEE                    DW  _FDWT   ;DPB_DWT
00252D F626 FD                      DB  0FDH    ;DPB_FATID
00252E F627 02                      DB  2   ;DPB_SECPCL
00252F F628 6401                    DW  356 ;DPB_MAXCL
002531 F62A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002532 F62B 07                      DB  7   ;DPB_DIRSCNT
002533 F62C 28                      DB  40  ;DPB_MAXCYL
002534 F62D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002535 F62E 01                      DB  1   ;DPB_FATPS
002536 F62F 82                      DB  082H    ;DPB_BPS
002537 F630 0500                    DW  5   ;DPB_DIRPS
002539 F632 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00253A F633 01                      DB  1   ;DPB_UNITNO
00253B F634 0800                    DW  8   ;DPB_ADDCL
00253D F636 0000                    DW  0   ;DPB_16
00253F F638 0000                    DW  0   ;DPB_18
002541 F63A 0000                    DW  0   ;DPB_SDIR
002543 F63C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002547 F640                         DS  32
                                
                                ;   D:
                                
002567 F660                         DS  32
                                
                                ;   E:
                                
002587 F680                         DS  32
                                
                                ;   F:
                                
0025A7 F6A0 0000                BANKFL: DW  0   ;DPB_FATLN
0025A9 F6A2 63DD                    DW  BDRD    ;DPB_DRD
0025AB F6A4 5FDD                    DW  BDWT    ;DPB_DWT
0025AD F6A6 F9                      DB  0F9H    ;DPB_FATID
0025AE F6A7 02                      DB  2   ;DPB_SECPCL
0025AF F6A8 0000                BANKCL: DW  0   ;DPB_MAXCL
0025B1 F6AA 00                      DB  0   ;DPB_FDMODE
0025B2 F6AB 08                      DB  8   ;DPB_DIRSCNT
0025B3 F6AC 00                      DB  0   ;DPB_MAXCYL
0025B4 F6AD 01                      DB  1   ;DPB_MAXSEC
0025B5 F6AE 00                      DB  0   ;DPB_FATPS
0025B6 F6AF 02                      DB  2   ;DPB_BPS
0025B7 F6B0 0200                    DW  2   ;DPB_DIRPS
0025B9 F6B2 0B                  BANKDV: DB  00BH    ;DPB_DEVICE
0025BA F6B3 00                      DB  0   ;DPB_UNITNO
0025BB F6B4 0600                    DW  6   ;DPB_ADDCL
0025BD F6B6 0000                    DW  0   ;DPB_16
0025BF F6B8 0000                    DW  0   ;DPB_18
0025C1 F6BA 0000                    DW  0   ;DPB_SDIR
0025C3 F6BC 454D454D                DB  "EMEM"  ;DPB_NAME
                                
                                ;   G:
                                
0025C7 F6C0                         DS  32
                                
                                ;   H:
0025E7 F6E0                         DS  32-8
0025FF F6F8 00                      DB  0
[EOF:88DPB.ASM:UTF_8]
                                
       F6F9                     LAST_ADR:
                                
                                    END
[EOF:88.ASM:UTF_8]
