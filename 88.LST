                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   LSX-Dodgers for PC-8801mkIISR
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "88DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   PC-8001mkIISR
                                
       0002                     MAC EQU 2   ;PC-8001mkIISR
       0001                     DEV EQU 1
                                
       011D                     VER_6F  EQU 0011DH
       00A0                     NBSP    EQU 0A0H
                                
       CD00                     RUN EQU 0CD00H
       CCF9                     OFFSET  EQU RUN-7
                                
       D106                     BDOS    EQU 0D106H
       EE00                     INTAD   EQU 0EE00H
       EF00                     WORKAD  EQU 0EF00H
       F300                     FATBF   EQU 0F300H
       FB00                     DTBUF   EQU 0FB00H
       FF00                     KEYBF   EQU 0FF00H
       FF20                     KBUF    EQU 0FF20H
       FFBB                     SUBSYS  EQU EXTBIO-5*3
       FFD9                     TRAP38  EQU 0FFD9H
       0050                     WIDTH   EQU 80
       0018                     LINE    EQU 24
       0000                     COLORF  EQU 0
       0010                     KEYSP_H EQU 16
       0000                     KEYSP_L EQU 0
       0009                     COMS    EQU 9
                                
                                ; ディスクサブシステム
       002A                     MAIN        EQU 0002AH
                                
       4000                     DSS_DATA    EQU 04000H
                                
       7C00                     DSS     EQU 07C00H
[EOF:88DEF.ASM:SHIFT_JIS]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0005                     VER_2   EQU 5
       0007                     VER_3   EQU 7
       1D02                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0102                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0157                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 CCF9                         ORG OFFSET
                                
                                ;   MSX BINARY HEADER
000000 CCF9 FE                      DB  0FEH
                                ;   MSX BINARY START ADDRESS
000001 CCFA 00CD                    DW  RUN
                                ;   MSX BINARY END ADDRESS
000003 CCFC F9F2                    DW  LAST_ADR
                                ;   MSX BINARY EXEC ADDRESS
000005 CCFE 07CD                    DW  START
                                
                                    INCLUDE "88INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   PC-8801mkIISR
                                
000007 CD00 C307CD          10      JP  START
00000A CD03 021D                    DW  MACW
00000C CD05 5701                    DW  VER
                                
       CD07                     START:
00000E CD07 F3               4      DI
00000F CD08 ED5E             8      IM  2
000011 CD0A 3107CD          10      LD  SP,START
000014 CD0D CD1BCD          17      CALL    INIT        ;NZならAUTOEXECを実行
000017 CD10 210000          10      LD  HL,0
00001A CD13 E5              11      PUSH    HL
00001B CD14 C8              11      RET Z
00001C CD15 1133CE          10      LD  DE,AUTOD
00001F CD18 C3FDEF          10      JP  _COMANL
                                
       CD1B                     INIT:
000022 CD1B DB32            11      IN  A,(032H)
000024 CD1D CBA7             8      RES 4,A     ;高速RAMアクセスモード
000026 CD1F D332            11      OUT (032H),A
                                
000028 CD21 21C8F3          10      LD  HL,0F3C8H   ;テキストをクリア
00002B CD24 11E880          10      LD  DE,080E8H
00002E CD27 0E20             7      LD  C,' '
000030 CD29 3E19             7      LD  A,25
       CD2B                     TVCL1:
000032 CD2B 0650             7      LD  B,80
       CD2D                     TVCL2:
000034 CD2D 71               7      LD  (HL),C
000035 CD2E 23               6      INC HL
000036 CD2F 10FC            13      DJNZ    TVCL2
000038 CD31 0614             7      LD  B,20
       CD33                     TVCL3:
00003A CD33 72               7      LD  (HL),D
00003B CD34 2C               4      INC L
00003C CD35 73               7      LD  (HL),E
00003D CD36 23               6      INC HL
00003E CD37 10FA            13      DJNZ    TVCL3
000040 CD39 3D               4      DEC A
000041 CD3A 20EF            12      JR  NZ,TVCL1
                                
000043 CD3C DB32            11      IN  A,(032H)
000045 CD3E F610             7      OR  010H        ;高速RAMアクセスモードOFF
000047 CD40 D332            11      OUT (032H),A
                                
000049 CD42 AF               4      XOR A
00004A CD43 32B8EF          13      LD  (WKE6),A
00004D CD46 2F               4      CPL
00004E CD47 32B7EF          13      LD  (WKE4),A
                                
000051 CD4A CD00DE          17      CALL    INIT_CRTC
       CD4D                     BANK:
000054 CD4D DBE2            11      IN  A,(0E2H)
000056 CD4F 06E3             7      LD  B,0E3H      ;拡張RAM バンク選択
000058 CD51 21007F          10      LD  HL,07F00H
00005B CD54 F3               4      DI
00005C CD55 3E11             7      LD  A,011H
00005E CD57 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000060 CD59 ED69            12      OUT (C),L
000062 CD5B 3A0000          13      LD  A,(0)
000065 CD5E FEEB             7      CP  0EBH
000067 CD60 2005            12      JR  NZ,BANK1
000069 CD62 3E2B             7      LD  A,02BH
00006B CD64 32B2F2          13      LD  (BANKDV),A
       CD67                     BANK1:
00006E CD67 3E11             7      LD  A,011H
000070 CD69 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000072 CD6B ED69            12      OUT (C),L
000074 CD6D 5E               7      LD  E,(HL)
000075 CD6E 7B               4      LD  A,E
000076 CD6F C6A5             7      ADD A,0A5H
000078 CD71 77               7      LD  (HL),A
000079 CD72 BE               7      CP  (HL)
00007A CD73 73               7      LD  (HL),E
00007B CD74 2005            12      JR  NZ,BANK2
00007D CD76 2C               4      INC L
00007E CD77 CB65             8      BIT 4,L
000080 CD79 28EC            12      JR  Z,BANK1
       CD7B                     BANK2:
000082 CD7B AF               4      XOR A
000083 CD7C D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000085 CD7E 7D               4      LD  A,L
000086 CD7F B7               4      OR  A
000087 CD80 2813            12      JR  Z,NOBANK
000089 CD82 2600             7      LD  H,0
00008B CD84 29              11      ADD HL,HL   ;*2
00008C CD85 29              11      ADD HL,HL   ;*4
00008D CD86 29              11      ADD HL,HL   ;*8
00008E CD87 29              11      ADD HL,HL   ;*16
00008F CD88 29              11      ADD HL,HL   ;*32
000090 CD89 2B               6      DEC HL  ;-1
000091 CD8A 2B               6      DEC HL  ;-2
000092 CD8B 2B               6      DEC HL  ;-3
000093 CD8C 22A8F2          16      LD  (BANKCL),HL
000096 CD8F CD23CE          17      CALL    CALC_FATLN
000099 CD92 32A0F2          13      LD  (BANKFL),A
       CD95                     NOBANK:
                                                ;初期化
00009C CD95 AF               4      XOR A       ;イニシャライズ
00009D CD96 CD0AEC          17      CALL    PUTCOM
0000A0 CD99 3E16             7      LD  A,16H       ;高速レシーブメモリ
0000A2 CD9B CD0AEC          17      CALL    PUTCOM
0000A5 CD9E 3E7C             7      LD  A,DSS/256   ;開始アドレスH
0000A7 CDA0 CD10EC          17      CALL    PUTDAT
0000AA CDA3 AF               4      XOR A       ;開始アドレスL
0000AB CDA4 CD10EC          17      CALL    PUTDAT
0000AE CDA7 015102          10      LD  BC,AT_DSSE-AT_DSS
0000B1 CDAA CB41             8      BIT 0,C
0000B3 CDAC 2801            12      JR  Z,SUBPG1
0000B5 CDAE 03               6      INC BC      ;偶数にする
       CDAF                     SUBPG1:
0000B6 CDAF 78               4      LD  A,B     ;バイト数H
0000B7 CDB0 CD10EC          17      CALL    PUTDAT
0000BA CDB3 79               4      LD  A,C
0000BB CDB4 CD10EC          17      CALL    PUTDAT
0000BE CDB7 21B0CE          10      LD  HL,AT_DSS
0000C1 CDBA CD54EC          17      CALL    FPUTDAT
                                
0000C4 CDBD 210000          10      LD  HL,0
0000C7 CDC0 065C             7      LD  B,05CH
0000C9 CDC2 3EFF             7      LD  A,0FFH      ;RST 38H
0000CB CDC4 CD46DF          17      CALL    FILL_MEMORY
0000CE CDC7 06A4             7      LD  B,0A4H
0000D0 CDC9 AF               4      XOR A
0000D1 CDCA CD46DF          17      CALL    FILL_MEMORY
                                
0000D4 CDCD 3EC3             7      LD  A,0C3H      ;JP
0000D6 CDCF 2103EF          10      LD  HL,CPM_WBOOT
0000D9 CDD2 320000          13      LD  (00000H),A
0000DC CDD5 220100          16      LD  (00001H),HL ;IPL
                                
0000DF CDD8 21021D          10      LD  HL,MACW     ;3 bit7  DPB Compatible LA(1)
0000E2 CDDB 220300          16      LD  (00003H),HL ;  bit6-0 Machine
                                ;               ;4 LSX-Dodgers(01DH)
0000E5 CDDE 2106D1          10      LD  HL,BDOS
0000E8 CDE1 320500          13      LD  (00005H),A
0000EB CDE4 220600          16      LD  (00006H),HL ;BDOS
                                
0000EE CDE7 2179DE          10      LD  HL,BIOS
0000F1 CDEA 321800          13      LD  (00018H),A
0000F4 CDED 221900          16      LD  (00019H),HL ;BIOS-ROM
                                
0000F7 CDF0 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000FA CDF3 323800          13      LD  (00038H),A
0000FD CDF6 223900          16      LD  (00039H),HL ;RST 038H
                                
000100 CDF9 3EEF             7      LD  A,CPM_BOOT/256
000102 CDFB 320B00          13      LD  (0000BH),A
                                
000105 CDFE 3EE9             7      LD  A,0E9H      ;JP (HL)
000107 CE00 320F00          13      LD  (0000FH),A
                                
00010A CE03 213FCE          10      LD  HL,INIMES
00010D CE06 CDAAD6          17      CALL    MSX
       CE09                     INIT1:
000110 CE09 F3               4      DI
000111 CE0A 1100FF          10      LD  DE,0FF00H
000114 CE0D 06BB             7      LD  B,SUBSYS%256
000116 CE0F CDBDD4          17      CALL    ZERO_MEMORY_DE
                                
000119 CE12 216BCE          10      LD  HL,AT_SUBSYS
00011C CE15 11BBFF          10      LD  DE,SUBSYS
00011F CE18 014500          10      LD  BC,AT_TRAPE-AT_SUBSYS
000122 CE1B EDB0                    LDIR
                                
000124 CE1D CD9FDD          17      CALL    CHKEY
000127 CE20 FE03             7      CP  3
000129 CE22 C9              10      RET
                                
       CE23                     CALC_FATLN: ;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
00012A CE23 5D               4      LD  E,L
00012B CE24 54               4      LD  D,H
00012C CE25 29              11      ADD HL,HL   ;*2
00012D CE26 19              11      ADD HL,DE   ;*3
00012E CE27 CB3C             8      SRL H   ;/2
000130 CE29 CB1D             8      RR  L   ;1クラスタ辺り1.5バイト必要
000132 CE2B 11FF01          10      LD  DE,511  ;切り上げる
000135 CE2E 19              11      ADD HL,DE
000136 CE2F 7C               4      LD  A,H
000137 CE30 CB3F             8      SRL A
000139 CE32 C9              10      RET
                                
00013A CE33 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000143 CE3C 413A00              AUTODV: DB  "A:",0
                                
000146 CE3F 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for PC-8801mkIISR v"
            6765727320666F72    
            2050432D38383031    
            6D6B494953522076    
000166 CE5F 312E                    DB  030H + VER_1, '.'
000168 CE61 3537                    DB  030H + VER_2 ,030H + VER_3
                                ;   DB  ""
00016A CE63 2047616B750D0A          DB  ' Gaku',0DH,0AH
000171 CE6A 00                      DB  0
                                
       CE6B                     AT_SUBSYS:
000172 FFBB                         ORG SUBSYS,AT_SUBSYS-OFFSET
000172 FFBB C30AEC          10      JP  PUTCOM
000175 FFBE C310EC          10      JP  PUTDAT
000178 FFC1 C335EC          10      JP  GETDAT
00017B FFC4 C354EC          10      JP  FPUTDAT
00017E FFC7 C380EC          10      JP  FGETDAT
                                ;EXTBIO
000181 FFCA C9              10      RET
000182 FFCB                         DS  14,0FFH
                                ;TRAP38:
000190 FFD9 210000          10      LD  HL,0
000193 FFDC E3              19      EX  (SP),HL
000194 FFDD 3E24             7      LD  A,'$'
000196 FFDF CDA3D9          17      CALL    MSG_A
000199 FFE2 2B               6      DEC HL
00019A FFE3 7C               4      LD  A,H
00019B FFE4 CDE8FF          17      CALL    PRHX
00019E FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
00019F FFE8 F5              11      PUSH    AF
0001A0 FFE9 07               4      RLCA
0001A1 FFEA 07               4      RLCA
0001A2 FFEB 07               4      RLCA
0001A3 FFEC 07               4      RLCA
0001A4 FFED CDF1FF          17      CALL    PRHX2
0001A7 FFF0 F1              10      POP AF
       FFF1                     PRHX2:
0001A8 FFF1 E60F             7      AND 00FH
0001AA FFF3 FE0A             7      CP  10
0001AC FFF5 3F               4      CCF
0001AD FFF6 CE30             7      ADC A,'0'
0001AF FFF8 27               4      DAA
0001B0 FFF9 C3A3D9          10      JP  MSG_A
0001B3 FFFC                         DS  4
0001B7 CEB0                         ORG $$+OFFSET   ;$DEPHASE
       CEB0                     AT_TRAPE:
[EOF:88INIT.ASM:SHIFT_JIS]
                                    INCLUDE "88SUB.ASM"
                                
                                ;   LSX-Dodgers SUB DISK SYSTEM
                                ;   PC-8801mkIISR
                                
       CEB0                     AT_DSS:
0001B7 7C00                         ORG DSS,AT_DSS-OFFSET
0001B7 7C00 C3437C          10      JP  READDISKEX
0001BA 7C03 C3A37C          10      JP  WRITEDISKEX
0001BD 7C06 C3BB7C          10      JP  GETPARAMS_N
0001C0 7C09 C3C67C          10      JP  SEEK
0001C3 7C0C C3547D          10      JP  FDCOMMAND
0001C6 7C0F C3207E          10      JP  CHECKRESULT
0001C9 7C12 C3427E          10      JP  GETDEVSTAT
0001CC 7C15 C3477E          10      JP  RDFDC
                                
0001CF 7C18                         DS  8*3
                                
       7C30                     S_PARAMS:
0001E7 7C30                         DS  16
       7C30                     S_UNITNO    EQU S_PARAMS    ;ユニット番号 0:ドライブA 1:ドライブB
       7C31                     S_DPS       EQU S_PARAMS+1  ;1トラックのセクタ数
       7C32                     S_SECTOR_R  EQU S_PARAMS+2  ;セクタ番号
       7C33                     S_TRACK     EQU S_PARAMS+3  ;トラック番号
       7C34                     S_FDMODE    EQU S_PARAMS+4  ;FDモード切り替え $FF:2D/2DD $FE:2HD
       7C35                     S_SECSIZE_N EQU S_PARAMS+5  ;N セクタサイズ
       7C36                     S_BYTE_H    EQU S_PARAMS+6  ;バイト数H
       7C37                     S_MAXCL     EQU S_PARAMS+7  ;シリンダ数
                                
       7C40                     S_CMD_STATUS:
0001F7 7C40 00                      DB  0
       7C41                     S_LEFT:
0001F8 7C41 00                      DB  0
       7C42                     S_WKF4:
0001F9 7C42 00                      DB  0
                                
       7C43                     READDISKEX:
0001FA 7C43 CDB97C          17      CALL    GETPARAMS
0001FD 7C46 AF               4      XOR A
0001FE 7C47 327A7C          13      LD  (RETRY_RDDISK),A
000201 7C4A 2A327C          16      LD  HL,(S_PARAMS+2)
000204 7C4D 7D               4      LD  A,L
000205 7C4E 3D               4      DEC A
000206 7C4F B4               4      OR  H
000207 7C50 200C            12      JR  NZ,RDDISK0
000209 7C52 2A357C          16      LD  HL,(S_PARAMS+5)
00020C 7C55 7C               4      LD  A,H
00020D 7C56 BD               4      CP  L
00020E 7C57 2005            12      JR  NZ,RDDISK0
000210 7C59 3E03             7      LD  A,3
000212 7C5B 327A7C          13      LD  (RETRY_RDDISK),A
       7C5E                     RDDISK0:
000215 7C5E CDC67C          17      CALL    SEEK
000218 7C61 3E46             7      LD  A,46H       ;READ DATA
00021A 7C63 CD547D          17      CALL    FDCOMMAND
00021D 7C66 3834            12      JR  C,FINISH_DISK
00021F 7C68 CD857D          17      CALL    RDDISK1
       7C6B                     WRDISK3:
000222 7C6B 78               4      LD  A,B
000223 7C6C B2               4      OR  D
000224 7C6D 32417C          13      LD  (S_LEFT),A
000227 7C70 DBF8            11      IN  A,(0F8H)    ;FDC μPD765A TC入力
000229 7C72 FB               4      EI
00022A 7C73 76               4      HALT
00022B 7C74 CD207E          17      CALL    CHECKRESULT
00022E 7C77 301D            12      JR  NC,FINISH_DISK0
       7C7A                     RETRY_RDDISK    EQU $+1
000230 7C79 3E00             7      LD  A,0
000232 7C7B B7               4      OR  A
000233 7C7C 2818            12      JR  Z,FINISH_DISK0
000235 7C7E 3D               4      DEC A
000236 7C7F 327A7C          13      LD  (RETRY_RDDISK),A
000239 7C82 3A357C          13      LD  A,(S_PARAMS+5)
00023C 7C85 FE04             7      CP  4
00023E 7C87 3003            12      JR  NC,RETRY_RDDISK1
000240 7C89 87               4      ADD A,A
000241 7C8A 1802            12      JR  RETRY_RDDISK2
       7C8C                     RETRY_RDDISK1:
000243 7C8C 3E01             7      LD  A,1
       7C8E                     RETRY_RDDISK2:
000245 7C8E 67               4      LD  H,A
000246 7C8F 6F               4      LD  L,A
000247 7C90 22357C          16      LD  (S_PARAMS+5),HL
00024A 7C93 C35E7C          10      JP  RDDISK0
       7C96                     FINISH_DISK0:
00024D 7C96 3A417C          13      LD  A,(S_LEFT)
000250 7C99 D601             7      SUB 1
000252 7C9B 3F               4      CCF
       7C9C                     FINISH_DISK:
000253 7C9C 9F               4      SBC A,A
000254 7C9D 32407C          13      LD  (S_CMD_STATUS),A
000257 7CA0 C32A00          10      JP  MAIN
                                
       7CA3                     WRITEDISKEX:
00025A 7CA3 AF               4      XOR A
00025B 7CA4 327A7C          13      LD  (RETRY_RDDISK),A
00025E 7CA7 CDB97C          17      CALL    GETPARAMS
000261 7CAA CDC67C          17      CALL    SEEK
000264 7CAD 3E45             7      LD  A,45H       ;WRITE DATA
000266 7CAF CD547D          17      CALL    FDCOMMAND
000269 7CB2 38E8            12      JR  C,FINISH_DISK
00026B 7CB4 CDCC7D          17      CALL    WRDISK1
00026E 7CB7 18B2            12      JR  WRDISK3
                                
       7CB9                     GETPARAMS:
000270 7CB9 0608             7      LD  B,8
       7CBB                     GETPARAMS_N:
000272 7CBB E5              11      PUSH    HL
000273 7CBC 21307C          10      LD  HL,S_PARAMS
       7CBF                     GETPARAMS1:
000276 7CBF D7              12      RST 10H
000277 7CC0 77               7      LD  (HL),A
000278 7CC1 23               6      INC HL
000279 7CC2 10FB            13      DJNZ    GETPARAMS1
00027B 7CC4 E1              10      POP HL
00027C 7CC5 C9              10      RET
                                
       7CC6                     SEEK:
00027D 7CC6 E5              11      PUSH    HL
00027E 7CC7 3A347C          13      LD  A,(S_FDMODE)    ;FDモード切り替え $FF:2D/2DD $FE:2HD
000281 7CCA 1F               4      RRA
000282 7CCB 3F               4      CCF
000283 7CCC 9F               4      SBC A,A
000284 7CCD F5              11      PUSH    AF
000285 7CCE E605             7      AND 5
000287 7CD0 4F               4      LD  C,A
000288 7CD1 3A377C          13      LD  A,(S_MAXCL) ;シリンダ数
00028B 7CD4 C6D3             7      ADD A,0-45      ;オーバートラックを考慮して40+α
00028D 7CD6 9F               4      SBC A,A
00028E 7CD7 E604             7      AND 4
000290 7CD9 B1               4      OR  C
000291 7CDA 0EFA             7      LD  C,0FFH-5    ;マスク
000293 7CDC 47               4      LD  B,A
000294 7CDD 3A307C          13      LD  A,(S_UNITNO)    ;0:ドライブA 1:ドライブB
000297 7CE0 B7               4      OR  A
000298 7CE1 2804            12      JR  Z,SET_WKF4
00029A 7CE3 CB20             8      SLA B
00029C 7CE5 CB01             4      RLC C
       7CE7                     SET_WKF4:
00029E 7CE7 3A427C          13      LD  A,(S_WKF4)
0002A1 7CEA A1               4      AND C
0002A2 7CEB B0               4      OR  B
0002A3 7CEC 4F               4      LD  C,A
0002A4 7CED D3F4            11      OUT (0F4H),A    ;ドライブ制御
0002A6 7CEF E6DF             7      AND 0FFH-020H   ;CLKの分は抜いておく
0002A8 7CF1 47               4      LD  B,A
0002A9 7CF2 F1              10      POP AF
0002AA 7CF3 E620             7      AND 020H        ;bit5:CLK
0002AC 7CF5 B0               4      OR  B
0002AD 7CF6 D3F4            11      OUT (0F4H),A    ;ドライブ制御
0002AF 7CF8 32427C          13      LD  (S_WKF4),A
0002B2 7CFB 47               4      LD  B,A
0002B3 7CFC A9               4      XOR C
0002B4 7CFD E620             7      AND 020H        ;CLKが変化したら一定時間待つ
0002B6 7CFF 2808            12      JR  Z,NOCHGCLK
0002B8 7D01 2160F0          10      LD  HL,0F060H
       7D04                     WAIT_CLK:
0002BB 7D04 2B               6      DEC HL
0002BC 7D05 7C               4      LD  A,H
0002BD 7D06 B5               4      OR  L
0002BE 7D07 20FB            12      JR  NZ,WAIT_CLK
       7D09                     NOCHGCLK:
0002C0 7D09 78               4      LD  A,B
0002C1 7D0A E620             7      AND 020H
0002C3 7D0C 2805            12      JR  Z,SPECIFY2D
0002C5 7D0E 1131DF          10      LD  DE,0DF31H   ;SPECIFY 2HD / SRT:13 HUT:15 HLT:24 NON-DMA
0002C8 7D11 1803            12      JR  SPECIFYOK
       7D13                     SPECIFY2D:
0002CA 7D13 1119DA          10      LD  DE,0DA19H   ;SPECIFY 2D/2DD / SRT:13 HUT 10 HLT:12 NON-DMA
       7D16                     SPECIFYOK:
0002CD 7D16 3E03             7      LD  A,3     ;SPECIFY
0002CF 7D18 E7              12      RST 20H
0002D0 7D19 7A               4      LD  A,D
0002D1 7D1A E7              12      RST 20H
0002D2 7D1B 7B               4      LD  A,E
0002D3 7D1C E7              12      RST 20H
       7D1D                     NOSPECIFY:
0002D4 7D1D ED4B307C        20      LD  BC,(S_PARAMS)
0002D8 7D21 ED5B327C        20      LD  DE,(S_PARAMS+2)
0002DC 7D25 7A               4      LD  A,D     ;TRACK
0002DD 7D26 CB3F             8      SRL A       ;CYLINDER
0002DF 7D28 3E0F             7      LD  A,00FH      ;SEEK
0002E1 7D2A 2002            12      JR  NZ,SEEK1    ;0シリンダの場合はRECALIBRATE、それ以外はSEEKを使う
0002E3 7D2C 3E07             7      LD  A,7     ;RECALIBRATE
       7D2E                     SEEK1:
0002E5 7D2E E7              12      RST 20H
0002E6 7D2F 79               4      LD  A,C     ;DR/HD
0002E7 7D30 E7              12      RST 20H
0002E8 7D31 7A               4      LD  A,D     ;TRACK
0002E9 7D32 CB3F             8      SRL A       ;CYLINDER
0002EB 7D34 C42000          17      CALL    NZ,20H      ;SEEKの場合だけ呼ぶ(0シリンダの場合はRECALIBRATEを使うのでシリンダの設定は不要)
0002EE 7D37 FB               4      EI
0002EF 7D38 76               4      HALT
0002F0 7D39 3E08             7      LD  A,8     ;SENSE
0002F2 7D3B E7              12      RST 20H
0002F3 7D3C CD477E          17      CALL    RDFDC       ;ST0
0002F6 7D3F CD477E          17      CALL    RDFDC       ;PCN(CYLINDER)
0002F9 7D42 210040          10      LD  HL,04000H
       7D45                     WAIT_SEEK:
0002FC 7D45 CD427E          17      CALL    GETDEVSTAT
0002FF 7D48 E608             7      AND 8
000301 7D4A 2006            12      JR  NZ,SEEK_OK
000303 7D4C 2B               6      DEC HL
000304 7D4D 7C               4      LD  A,H
000305 7D4E B5               4      OR  L
000306 7D4F 20F4            12      JR  NZ,WAIT_SEEK
000308 7D51 37               4      SCF
       7D52                     SEEK_OK:
000309 7D52 E1              10      POP HL
00030A 7D53 C9              10      RET
                                
       7D54                     FDCOMMAND:
00030B 7D54 E7              12      RST 20H
00030C 7D55 7A               4      LD  A,D     ;HD US1 US0
00030D 7D56 E601             7      AND 1
00030F 7D58 87               4      ADD A,A
000310 7D59 87               4      ADD A,A
000311 7D5A B1               4      OR  C
000312 7D5B E7              12      RST 20H
000313 7D5C 7A               4      LD  A,D     ;C
000314 7D5D CB3F             8      SRL A
000316 7D5F E7              12      RST 20H
000317 7D60 7A               4      LD  A,D     ;H
000318 7D61 E601             7      AND 1
00031A 7D63 E7              12      RST 20H
00031B 7D64 7B               4      LD  A,E     ;R
00031C 7D65 E7              12      RST 20H
00031D 7D66 3A357C          13      LD  A,(S_PARAMS+5)  ;N
000320 7D69 FE04             7      CP  4
000322 7D6B 3802            12      JR  C,FDCOMMAND2
                                
000324 7D6D 3E03             7      LD  A,3
       7D6F                     FDCOMMAND2:
000326 7D6F 1E20             7      LD  E,020H      ;NO SERVICE
000328 7D71 E7              12      RST 20H
                                
000329 7D72 210040          10      LD  HL,DSS_DATA ;開始アドレス
00032C 7D75 78               4      LD  A,B     ;EOT
00032D 7D76 E7              12      RST 20H
                                
00032E 7D77 01FB00          10      LD  BC,000FBH   ;B:バイト数L C:FDC μPD765A データレジスタ
000331 7D7A 3E54             7      LD  A,054H      ;GSL
000333 7D7C E7              12      RST 20H
                                
000334 7D7D 3A367C          13      LD  A,(S_BYTE_H)
000337 7D80 57               4      LD  D,A     ;バイト数H
                                
000338 7D81 AF               4      XOR A       ;DTL
000339 7D82 E7              12      RST 20H
00033A 7D83 A7               4      AND A
00033B 7D84 C9              10      RET
                                
       7D85                     RDDISK1:            ;高速化の為にループ展開x8
00033C 7D85 FB               4      EI
00033D 7D86 76               4      HALT
00033E 7D87 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000340 7D89 A3               4      AND E       ;NO SERVICE
000341 7D8A C8              11      RET Z
000342 7D8B EDA2            16      INI
                                
000344 7D8D FB               4      EI
000345 7D8E 76               4      HALT
000346 7D8F DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000348 7D91 A3               4      AND E       ;NO SERVICE
000349 7D92 C8              11      RET Z
00034A 7D93 EDA2            16      INI
                                
00034C 7D95 FB               4      EI
00034D 7D96 76               4      HALT
00034E 7D97 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000350 7D99 A3               4      AND E       ;NO SERVICE
000351 7D9A C8              11      RET Z
000352 7D9B EDA2            16      INI
                                
000354 7D9D FB               4      EI
000355 7D9E 76               4      HALT
000356 7D9F DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000358 7DA1 A3               4      AND E       ;NO SERVICE
000359 7DA2 C8              11      RET Z
00035A 7DA3 EDA2            16      INI
                                
00035C 7DA5 FB               4      EI
00035D 7DA6 76               4      HALT
00035E 7DA7 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000360 7DA9 A3               4      AND E       ;NO SERVICE
000361 7DAA C8              11      RET Z
000362 7DAB EDA2            16      INI
                                
000364 7DAD FB               4      EI
000365 7DAE 76               4      HALT
000366 7DAF DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000368 7DB1 A3               4      AND E       ;NO SERVICE
000369 7DB2 C8              11      RET Z
00036A 7DB3 EDA2            16      INI
                                
00036C 7DB5 FB               4      EI
00036D 7DB6 76               4      HALT
00036E 7DB7 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000370 7DB9 A3               4      AND E       ;NO SERVICE
000371 7DBA C8              11      RET Z
000372 7DBB EDA2            16      INI
                                
000374 7DBD FB               4      EI
000375 7DBE 76               4      HALT
000376 7DBF DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000378 7DC1 A3               4      AND E       ;NO SERVICE
000379 7DC2 C8              11      RET Z
00037A 7DC3 EDA2            16      INI
                                
00037C 7DC5 20BE            12      JR  NZ,RDDISK1
00037E 7DC7 15               4      DEC D
00037F 7DC8 C2857D          10      JP  NZ,RDDISK1
000382 7DCB C9              10      RET
                                
       7DCC                     WRDISK1:            ;高速化の為にループ展開x8
000383 7DCC FB               4      EI
000384 7DCD 76               4      HALT
000385 7DCE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000387 7DD0 A3               4      AND E
000388 7DD1 C8              11      RET Z
000389 7DD2 EDA3            16      OUTI
                                
00038B 7DD4 FB               4      EI
00038C 7DD5 76               4      HALT
00038D 7DD6 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00038F 7DD8 A3               4      AND E
000390 7DD9 C8              11      RET Z
000391 7DDA EDA3            16      OUTI
                                
000393 7DDC FB               4      EI
000394 7DDD 76               4      HALT
000395 7DDE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000397 7DE0 A3               4      AND E
000398 7DE1 C8              11      RET Z
000399 7DE2 EDA3            16      OUTI
                                
00039B 7DE4 FB               4      EI
00039C 7DE5 76               4      HALT
00039D 7DE6 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00039F 7DE8 A3               4      AND E
0003A0 7DE9 C8              11      RET Z
0003A1 7DEA EDA3            16      OUTI
                                
0003A3 7DEC FB               4      EI
0003A4 7DED 76               4      HALT
0003A5 7DEE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003A7 7DF0 A3               4      AND E
0003A8 7DF1 C8              11      RET Z
0003A9 7DF2 EDA3            16      OUTI
                                
0003AB 7DF4 FB               4      EI
0003AC 7DF5 76               4      HALT
0003AD 7DF6 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003AF 7DF8 A3               4      AND E
0003B0 7DF9 C8              11      RET Z
0003B1 7DFA EDA3            16      OUTI
                                
0003B3 7DFC FB               4      EI
0003B4 7DFD 76               4      HALT
0003B5 7DFE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003B7 7E00 A3               4      AND E
0003B8 7E01 C8              11      RET Z
0003B9 7E02 EDA3            16      OUTI
                                
0003BB 7E04 FB               4      EI
0003BC 7E05 76               4      HALT
0003BD 7E06 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003BF 7E08 A3               4      AND E
0003C0 7E09 C8              11      RET Z
0003C1 7E0A EDA3            16      OUTI
                                
0003C3 7E0C 20BE            12      JR  NZ,WRDISK1
0003C5 7E0E 15               4      DEC D
0003C6 7E0F C2CC7D          10      JP  NZ,WRDISK1
0003C9 7E12 C9              10      RET
                                
       7E13                     RESULTEX:
0003CA 7E13 3A407C          13      LD  A,(S_CMD_STATUS)
0003CD 7E16 3C               4      INC A
0003CE 7E17 2803            12      JR  Z,RESULTEX1
0003D0 7E19 3A367C          13      LD  A,(S_BYTE_H)    ;バイト数H
       7E1C                     RESULTEX1:
0003D3 7E1C DF              12      RST 18H
0003D4 7E1D C32A00          10      JP  MAIN
                                
       7E20                     CHECKRESULT:
0003D7 7E20 C5              11      PUSH    BC
0003D8 7E21 CD477E          17      CALL    RDFDC       ;ST0
0003DB 7E24 E6D8             7      AND 0D8H
0003DD 7E26 4F               4      LD  C,A
0003DE 7E27 CD477E          17      CALL    RDFDC       ;ST1
0003E1 7E2A E6B7             7      AND 0B7H
0003E3 7E2C B1               4      OR  C
0003E4 7E2D 4F               4      LD  C,A
0003E5 7E2E CD477E          17      CALL    RDFDC       ;ST2
0003E8 7E31 E673             7      AND 073H
0003EA 7E33 B1               4      OR  C
0003EB 7E34 4F               4      LD  C,A
0003EC 7E35 0604             7      LD  B,4
       7E37                     CHECKRESULT1:           ;C H R N
0003EE 7E37 CD477E          17      CALL    RDFDC
0003F1 7E3A 10FB            13      DJNZ    CHECKRESULT1
0003F3 7E3C 79               4      LD  A,C
0003F4 7E3D A7               4      AND A
0003F5 7E3E C1              10      POP BC
0003F6 7E3F C8              11      RET Z
0003F7 7E40 37               4      SCF
0003F8 7E41 C9              10      RET
                                
       7E42                     GETDEVSTAT:
0003F9 7E42 3E04             7      LD  A,4
0003FB 7E44 E7              12      RST 20H
0003FC 7E45 79               4      LD  A,C
0003FD 7E46 E7              12      RST 20H
                                
       7E47                     RDFDC:
0003FE 7E47 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000400 7E49 2F               4      CPL
000401 7E4A E6C0             7      AND 0C0H        ;RQMとDIOが両方1になるまで待つ
000403 7E4C 20F9            12      JR  NZ,RDFDC
000405 7E4E DBFB            11      IN  A,(0FBH)    ;FDC μPD765A データレジスタリード
000407 7E50 C9              10      RET
                                
000408 D101                         ORG $$+OFFSET   ;$DEPHASE
       D101                     AT_DSSE:
       D101                     INITE:
000408 D101                         DS  BDOS-INITE
00040D D106 C32FD9          10      JP  BDOS_RF
[EOF:88SUB.ASM:SHIFT_JIS]
                                    INCLUDE "88CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   PC-8801mkIISR
                                
       D109                     WBOOT1:
000410 D109 ED7B0600        20      LD  SP,(SYSTEM+1)
000414 D10D DB32            11      IN  A,(032H)
000416 D10F F610             7      OR  10H     ;高速RAMアクセスモードOFF
000418 D111 D332            11      OUT (032H),A
                                
00041A D113 3EEE             7      LD  A,IVRTC/256
00041C D115 ED47             9      LD  I,A
00041E D117 3AB8EF          13      LD  A,(WKE6)
000421 D11A F602             7      OR  2       ;VRTC割り込みマスク
000423 D11C D3E6            11      OUT (0E6H),A    ;割り込みマスク
000425 D11E 32B8EF          13      LD  (WKE6),A
000428 D121 3AB7EF          13      LD  A,(WKE4)
00042B D124 D3E4            11      OUT (0E4H),A    ;割り込みレベル設定 
                                
00042D D126 FB               4      EI
00042E D127 2192EF          10      LD  HL,_KEYD
000431 D12A 3600            10      LD  (HL),0
000433 D12C CD9FDD          17      CALL    CHKEY
000436 D12F CD90D9          17      CALL    KEYBC_IFBREAK
000439 D132 3E04             7      LD  A,4
00043B D134 CDA3D9          17      CALL    MSG_A
[EOF:88CCP.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D137                     COMMAND:
00043E D137 3A66F1          13      LD  A,(FCB_BAT)
000441 D13A B7               4      OR  A
000442 D13B C27CD2          10      JP  NZ,C_BAT1
000445 D13E CDF1D1          17      CALL    SETDTA1
000448 D141 3A87EF          13      LD  A,(_DVSW)
00044B D144 C641             7      ADD A,'A'
00044D D146 CDA3D9          17      CALL    MSG_A
000450 D149 3E3E             7      LD  A,'>'
000452 D14B CDA3D9          17      CALL    MSG_A
000455 D14E 3E50             7      LD  A,80
000457 D150 12               7      LD  (DE),A
000458 D151 CDE1D9          17      CALL    _SYS0A      ;(BDOS)文字列入力
00045B D154 CD7FD3          17      CALL    LTNL
       D157                     COMMAND2:
00045E D157 118200          10      LD  DE,DTA1+2
000461 D15A CDFDEF          17      CALL    _COMANL
000464 D15D 30D8            12      JR  NC,COMMAND
000466 D15F 1179EF          10      LD  DE,COMERM
000469 D162 CD9BD6          17      CALL    _SYS09      ;(BDOS)文字列出力
00046C D165 C7              12      RST 0
                                
       D166                     COMANL:
00046D D166 CD9ADE          17      CALL    FILE
000470 D169 3A19EF          13      LD  A,(FNAME+4)
000473 D16C FE20             7      CP  020H
000475 D16E 201C            12      JR  NZ,COMB2
000477 D170 D5              11      PUSH    DE
000478 D171 1115EF          10      LD  DE,FNAME
00047B D174 1A               7      LD  A,(DE)
00047C D175 FE20             7      CP  020H
00047E D177 2844            12      JR  Z,SDVSW
000480 D179 1B               6      DEC DE
000481 D17A 1A               7      LD  A,(DE)
000482 D17B C6FF             7      ADD A,0FFH
000484 D17D 3809            12      JR  C,COMB
000486 D17F 13               6      INC DE
                                
000487 D180 21EDD5          10      LD  HL,COMTB
00048A D183 0609             7      LD  B,COMS
00048C D185 CD1EE1          17      CALL    CPNAME
       D188                     COMB:
00048F D188 D1              10      POP DE
000490 D189 D20F00          10      JP  NC,JP_HL
       D18C                     COMB2:
000493 D18C EB               4      EX  DE,HL
000494 D18D 2259D2          16      LD  (COMPAT+1),HL
000497 D190 F5              11      PUSH    AF
000498 D191 CD11D2          17      CALL    CEXE4
00049B D194 F1              10      POP AF
00049C D195 2115EF          10      LD  HL,FNAME
00049F D198 116D00          10      LD  DE,FCB2+1   ;COMMAND NAME
0004A2 D19B 010B00          10      LD  BC,11
0004A5 D19E EDB0                    LDIR
0004A7 D1A0 1100F1          10      LD  DE,PATHD
       D1A3                     CEX1:
0004AA D1A3 1A               7      LD  A,(DE)
0004AB D1A4 FE20             7      CP  020H
0004AD D1A6 D8              11      RET C
0004AE D1A7 CD8FDE          17      CALL    FILEC
0004B1 D1AA D5              11      PUSH    DE
0004B2 D1AB 216D00          10      LD  HL,FCB2+1   ;COMMAND NAME
0004B5 D1AE 1115EF          10      LD  DE,FNAME
0004B8 D1B1 010B00          10      LD  BC,11
0004BB D1B4 EDB0                    LDIR
0004BD D1B6 CD11D2          17      CALL    CEXE4
0004C0 D1B9 D1              10      POP DE
0004C1 D1BA 13               6      INC DE
0004C2 D1BB 18E6            12      JR  CEX1
                                
       D1BD                     SDVSW:
0004C4 D1BD F1              10      POP AF
0004C5 D1BE 3A14EF          13      LD  A,(FDRV)
0004C8 D1C1 3D               4      DEC A
0004C9 D1C2 5F               4      LD  E,A
0004CA D1C3 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
0004CC D1C5 1831            12      JR  SYSTEM0
                                
       D1C7                     OPEN1:
0004CE D1C7 2114EF          10      LD  HL,FDRV
       D1CA                     OPEN:
0004D1 D1CA 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D1CC                     OPEN3:
0004D3 D1CC D5              11      PUSH    DE
0004D4 D1CD 1141F1          10      LD  DE,DTA_CCP
0004D7 D1D0 CDEED1          17      CALL    SETDTA
0004DA D1D3 EB               4      EX  DE,HL
0004DB D1D4 CDF8D1          17      CALL    SYSTEM0
0004DE D1D7 D1              10      POP DE
0004DF D1D8 C9              10      RET
                                
       D1D9                     OPEN2:
0004E0 D1D9 0E12             7      LD  C,012H
0004E2 D1DB 18EF            12      JR  OPEN3
                                
       D1DD                     DEFCB:              ;Z=Ok NZ=Error
0004E4 D1DD 1141F1          10      LD  DE,DTA_CCP
0004E7 D1E0 CDF6D1          17      CALL    SYSC0F
                                
0004EA D1E3 1162F1          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0004ED D1E6 0604             7      LD  B,4
0004EF D1E8 CDBDD4          17      CALL    ZERO_MEMORY_DE
       D1EB                     SETDTA100:
0004F2 D1EB 110001          10      LD  DE,00100H
       D1EE                     SETDTA:
0004F5 D1EE C373D8          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D1F1                     SETDTA1:
0004F8 D1F1 118000          10      LD  DE,DTA1
0004FB D1F4 18F8            12      JR  SETDTA
                                
       D1F6                     SYSC0F:
0004FD D1F6 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D1F8                     SYSTEM0:
0004FF D1F8 CD0500          17      CALL    SYSTEM
000502 D1FB B7               4      OR  A
000503 D1FC C9              10      RET
                                
       D1FD                     C_CD:
000504 D1FD 0E5A             7      LD  C,5AH
000506 D1FF 18F7            12      JR  SYSTEM0
                                
       D201                     S27BUF:
000508 D201 3A0700          13      LD  A,(SYSTEM+2)
00050B D204 3D               4      DEC A
00050C D205 E6F8             7      AND 0F8H
00050E D207 67               4      LD  H,A
00050F D208 2E00             7      LD  L,0
       D20A                     S27DTA:
000511 D20A 1141F1          10      LD  DE,DTA_CCP
       D20D                     S27:
000514 D20D 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
000516 D20F 18E7            12      JR  SYSTEM0
                                
       D211                     CEXE4:
000518 D211 211DEF          10      LD  HL,FNAME+8
00051B D214 7E               7      LD  A,(HL)
00051C D215 FE20             7      CP  020H
00051E D217 2007            12      JR  NZ,CEXE7
000520 D219 3E3F             7      LD  A,'?'
000522 D21B 77               7      LD  (HL),A
000523 D21C 23               6      INC HL
000524 D21D 77               7      LD  (HL),A
000525 D21E 23               6      INC HL
000526 D21F 77               7      LD  (HL),A
       D220                     CEXE7:
000527 D220 CDC7D1          17      CALL    OPEN1
       D223                     CEXE5:
00052A D223 C0              11      RET NZ
00052B D224 2A4BF1          16      LD  HL,(DTA_CCP+1+9)
00052E D227 7C               4      LD  A,H
00052F D228 CDA6E1          17      CALL    CAP
000532 D22B 67               4      LD  H,A
000533 D22C 7D               4      LD  A,L
000534 D22D CDA6E1          17      CALL    CAP
000537 D230 6F               4      LD  L,A
000538 D231 3A4AF1          13      LD  A,(DTA_CCP+1+8)
00053B D234 CDA6E1          17      CALL    CAP
00053E D237 D642             7      SUB 'B'
000540 D239 282C            12      JR  Z,C_BAT
000542 D23B 3D               4      DEC A       ;'C'
000543 D23C 2805            12      JR  Z,C_EXE
       D23E                     CEXE6:
000545 D23E CDD9D1          17      CALL    OPEN2
000548 D241 18E0            12      JR  CEXE5
                                
       D243                     C_EXE:
00054A D243 7C               4      LD  A,H
00054B D244 FE4D             7      CP  'M'
00054D D246 20F6            12      JR  NZ,CEXE6
                                
00054F D248 CDDDD1          17      CALL    DEFCB
000552 D24B CD01D2          17      CALL    S27BUF
000555 D24E 3D               4      DEC A
000556 D24F 37               4      SCF
000557 D250 C0              11      RET NZ
000558 D251 7C               4      LD  A,H
000559 D252 B5               4      OR  L
00055A D253 37               4      SCF
00055B D254 C8              11      RET Z
00055C D255 CDF1D1          17      CALL    SETDTA1
00055F D258 110000          10  COMPAT: LD  DE,0                ; self-modifying code
000562 D25B ED7B0600        20      LD  SP,(SYSTEM+1)
000566 D25F 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000567 D260 6F               4      LD  L,A
000568 D261 E5              11      PUSH    HL              ; push $0000 (reboot address)
000569 D262 24               4      INC H
00056A D263 E5              11      PUSH    HL              ; push $0100 (TPA address)
00056B D264 C388D4          10      JP  SETFCB              ; and JP $0100
                                
       D267                     C_BAT:
00056E D267 114154          10      LD  DE,'A'+'T'*256
000571 D26A ED52            15      SBC HL,DE
000573 D26C 20D0            12      JR  NZ,CEXE6
                                
000575 D26E CDDDD1          17      CALL    DEFCB
                                
000578 D271 2141F1          10      LD  HL,DTA_CCP
00057B D274 1166F1          10      LD  DE,FCB_BAT
00057E D277 012500          10      LD  BC,37
000581 D27A EDB0                    LDIR
       D27C                     C_BAT1:
000583 D27C CDEBD1          17      CALL    SETDTA100
000586 D27F CDB3D2          17      CALL    FGETC_BAT
000589 D282 218100          10      LD  HL,DTA1+1
00058C D285 2025            12      JR  NZ,END_BATCH
00058E D287 FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
000590 D289 38F1            12      JR  C,C_BAT1
000592 D28B 3620            10      LD  (HL),' '
000594 D28D 23               6      INC HL
       D28E                     C_BAT2:
000595 D28E 77               7      LD  (HL),A
000596 D28F 23               6      INC HL
000597 D290 7D               4      LD  A,L
000598 D291 3C               4      INC A       ;L==0FFH
000599 D292 2809            12      JR  Z,RUN_BATCH
00059B D294 CDB3D2          17      CALL    FGETC_BAT
00059E D297 2004            12      JR  NZ,RUN_BATCH
0005A0 D299 FE20             7      CP  020H
0005A2 D29B 30F1            12      JR  NC,C_BAT2
       D29D                     RUN_BATCH:
0005A4 D29D 7D               4      LD  A,L
0005A5 D29E D67F             7      SUB DTA1-1
0005A7 D2A0 328000          13      LD  (DTA1),A
0005AA D2A3 FE04             7      CP  4
0005AC D2A5 3805            12      JR  C,END_BATCH
0005AE D2A7 3600            10      LD  (HL),0
0005B0 D2A9 C357D1          10      JP  COMMAND2
       D2AC                     END_BATCH:
0005B3 D2AC AF               4      XOR A       ;バッチファイルを閉じる
0005B4 D2AD 3266F1          13      LD  (FCB_BAT),A
0005B7 D2B0 C300EF          10      JP  CPM_BOOT
                                
       D2B3                     FGETC_BAT:
0005BA D2B3 1166F1          10      LD  DE,FCB_BAT
       D2B6                     FGETC:              ;1文字ずつ読み込む
0005BD D2B6 E5              11      PUSH    HL      ;Z:成功
0005BE D2B7 210100          10      LD  HL,1
0005C1 D2BA CD0DD2          17      CALL    S27
0005C4 D2BD E1              10      POP HL
0005C5 D2BE 3A0001          13      LD  A,(00100H)
0005C8 D2C1 C9              10      RET
                                
       D2C2                     C_DEL:
0005C9 D2C2 CD88D4          17      CALL    SETFCB
0005CC D2C5 CDB9D9          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
0005CF D2C8 0E13             7      LD  C,013H
0005D1 D2CA 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D2CC                     C_REN:
0005D3 D2CC CD88D4          17      CALL    SETFCB
0005D6 D2CF 3E10             7      LD  A,010H      ;ディレクトリも対象にする
0005D8 D2D1 326900          13      LD  (FCB1+13),A ;属性
0005DB D2D4 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D2D6                     CDEL1:
0005DD D2D6 115C00          10      LD  DE,FCB1
0005E0 D2D9 CD0500          17      CALL    SYSTEM
0005E3 D2DC C6FF             7      ADD A,0FFH
0005E5 D2DE C9              10      RET
                                
       D2DF                     C_DIR:
0005E6 D2DF CD8FDE          17      CALL    FILEC
0005E9 D2E2 2115EF          10      LD  HL,FDRV+1
0005EC D2E5 CDD3D5          17      CALL    CWILD1
0005EF D2E8 3EF1             7      LD  A,0F1H
0005F1 D2EA 3221EF          13      LD  (FDRV+13),A
0005F4 D2ED CDC7D1          17      CALL    OPEN1
       D2F0                     CDIR1:
0005F7 D2F0 B7               4      OR  A
0005F8 D2F1 2008            12      JR  NZ,PDSKF
0005FA D2F3 CD3ED3          17      CALL    P_NAME
0005FD D2F6 CDD9D1          17      CALL    OPEN2
000600 D2F9 18F5            12      JR  CDIR1
                                
       D2FB                     PDSKF:
000602 D2FB 3A14EF          13      LD  A,(FDRV)
000605 D2FE 5F               4      LD  E,A
000606 D2FF 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
000608 D301 CD0500          17      CALL    SYSTEM
00060B D304 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
00060C D305 C601             7      ADD A,001H
00060E D307 D8              11      RET C       ;Aが0FFHだった場合
00060F D308 3E06             7      LD  A,8-2
       D30A                     PDS1:               ;HL=未使用クラスタの総数
000611 D30A 3C               4      INC A
000612 D30B CB19             8      RR  C
000614 D30D 30FB            12      JR  NC,PDS1
       D30F                     PDS2:               ;B←論理セクタのサイズの上位8ビット
000616 D30F 3C               4      INC A
000617 D310 CB18             8      RR  B
000619 D312 30FB            12      JR  NC,PDS2
00061B D314 47               4      LD  B,A
                                
00061C D315 110000          10      LD  DE,0
       D318                     PDS3:
00061F D318 29              11      ADD HL,HL
000620 D319 EB               4      EX  DE,HL
000621 D31A ED6A            15      ADC HL,HL
000623 D31C EB               4      EX  DE,HL
000624 D31D 10F9            13      DJNZ    PDS3
       D31F                     PDSKF1:
000626 D31F CDB7D3          17      CALL    PRDEC_DEHL
000629 D322 118BF1          10      LD  DE,FREE
00062C D325 CD9BD6          17      CALL    _SYS09      ;(BDOS)文字列出力
00062F D328 CDA6D3          17      CALL    PUTDRV
000632 D32B 3E5C             7      LD  A,05CH      ;\
000634 D32D CDA3D9          17      CALL    MSG_A
000637 D330 2A22EF          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
00063A D333 AF               4      XOR A
00063B D334 11FEFF          10      LD  DE,0-2
00063E D337 19              11      ADD HL,DE
00063F D338 23               6      INC HL
000640 D339 DCB3D3          17      CALL    C,PRDEC_HL
000643 D33C 1841            12      JR  LTNL
                                
       D33E                     P_NAME:
000645 D33E 3A42F1          13      LD  A,(DTA_CCP+1)
000648 D341 FE2E             7      CP  '.'
00064A D343 C8              11      RET Z
00064B D344 11E9D5          10      LD  DE,DIRHD
00064E D347 CD9BD6          17      CALL    _SYS09      ;(BDOS)文字列出力
000651 D34A 3A4DF1          13      LD  A,(DTA_CCP+1+00BH)
000654 D34D F5              11      PUSH    AF
000655 D34E 0F               4      RRCA
000656 D34F 9F               4      SBC A,A
000657 D350 E60A             7      AND '*'-020H
000659 D352 C620             7      ADD A,020H
00065B D354 CDA3D9          17      CALL    MSG_A
00065E D357 CDA6D3          17      CALL    PUTDRV
000661 D35A 2142F1          10      LD  HL,DTA_CCP+1
000664 D35D CDF7D3          17      CALL    FPRNT
                                
000667 D360 F1              10      POP AF
000668 D361 CB67             8      BIT 4,A
00066A D363 2808            12      JR  Z,DIR3
00066C D365 11DED5          10      LD  DE,DIRMES
00066F D368 CD9BD6          17      CALL    _SYS09      ;(BDOS)文字列出力
000672 D36B 180A            12      JR  DIR6
       D36D                     DIR3:
000674 D36D ED5B60F1        20      LD  DE,(DTA_CCP+1+01EH)
000678 D371 2A5EF1          16      LD  HL,(DTA_CCP+1+01CH)
00067B D374 CDB7D3          17      CALL    PRDEC_DEHL
       D377                     DIR6:
00067E D377 3AB1EF          13      LD  A,(_WIDTH)
000681 D37A FE29             7      CP  40+1
000683 D37C D419D4          17      CALL    NC,PRTTMS
                                
       D37F                     LTNL:
000686 D37F 1E03             7      LD  E,3
000688 D381 C3CDEF          10      JP  _PRINT
                                
       D384                     C_PATH:
00068B D384 CD71DF          17      CALL    SPCUT
00068E D387 2100F1          10      LD  HL,PATHD
000691 D38A FE21             7      CP  021H
000693 D38C 300C            12      JR  NC,CPATH0
       D38E                     CPATHP:
000695 D38E 7E               7      LD  A,(HL)
000696 D38F 23               6      INC HL
000697 D390 FE20             7      CP  020H
000699 D392 3F               4      CCF
00069A D393 30EA            12      JR  NC,LTNL
00069C D395 CDA3D9          17      CALL    MSG_A
00069F D398 18F4            12      JR  CPATHP
       D39A                     CPATH0:
0006A1 D39A FE3B             7      CP  ';'
0006A3 D39C 2001            12      JR  NZ,CPATH1
0006A5 D39E 13               6      INC DE
       D39F                     CPATH1:
0006A6 D39F EB               4      EX  DE,HL
0006A7 D3A0 014000          10      LD  BC,PATHX
0006AA D3A3 EDB0                    LDIR
0006AC D3A5 C9              10      RET
                                
       D3A6                     PUTDRV:
0006AD D3A6 3A14EF          13      LD  A,(FDRV)
0006B0 D3A9 C640             7      ADD A,'A'-1
0006B2 D3AB CDA3D9          17      CALL    MSG_A
0006B5 D3AE 3E3A             7      LD  A,':'
       D3B0                     MSG_AR:
0006B7 D3B0 C3A3D9          10      JP  MSG_A
                                
       D3B3                     PRDEC_HL:
0006BA D3B3 AF               4      XOR A
       D3B4                     PRDEC_AHL:
0006BB D3B4 5F               4      LD  E,A
0006BC D3B5 1600             7      LD  D,0
       D3B7                     PRDEC_DEHL:
0006BE D3B7 D5              11      PUSH    DE
0006BF D3B8 110FEF          10      LD  DE,DECBF
0006C2 D3BB 0605             7      LD  B,5
0006C4 D3BD CDBDD4          17      CALL    ZERO_MEMORY_DE  ;A=0
0006C7 D3C0 D1              10      POP DE
                                
0006C8 D3C1 0E20             7      LD  C,32
       D3C3                     DEC1:
0006CA D3C3 29              11      ADD HL,HL
0006CB D3C4 EB               4      EX  DE,HL
0006CC D3C5 ED6A            15      ADC HL,HL
0006CE D3C7 EB               4      EX  DE,HL
0006CF D3C8 E5              11      PUSH    HL
0006D0 D3C9 2113EF          10      LD  HL,DECBF+4
0006D3 D3CC 0605             7      LD  B,5
       D3CE                     DEC2:
0006D5 D3CE 7E               7      LD  A,(HL)
0006D6 D3CF 8F               4      ADC A,A
0006D7 D3D0 27               4      DAA
0006D8 D3D1 77               7      LD  (HL),A
0006D9 D3D2 2B               6      DEC HL
0006DA D3D3 10F9            13      DJNZ    DEC2
0006DC D3D5 E1              10      POP HL
0006DD D3D6 0D               4      DEC C
0006DE D3D7 20EA            12      JR  NZ,DEC1
                                
0006E0 D3D9 210FEF          10      LD  HL,DECBF
0006E3 D3DC 3E20             7      LD  A,020H
0006E5 D3DE 0604             7      LD  B,4
       D3E0                     DEC3:
0006E7 D3E0 CDEDD3          17      CALL    DEC4
0006EA D3E3 CDEDD3          17      CALL    DEC4
0006ED D3E6 23               6      INC HL
0006EE D3E7 10F7            13      DJNZ    DEC3
       D3E9                     DECX:
0006F0 D3E9 CDEDD3          17      CALL    DEC4
0006F3 D3EC AF               4      XOR A
       D3ED                     DEC4:
0006F4 D3ED ED6F            18      RLD
0006F6 D3EF FE20             7      CP  020H
0006F8 D3F1 2802            12      JR  Z,DEC5
0006FA D3F3 F630             7      OR  030H
       D3F5                     DEC5:
0006FC D3F5 18B9            12      JR  MSG_AR
                                
       D3F7                     FPRNT:
0006FE D3F7 0608             7      LD  B,8
000700 D3F9 CD0AD4          17      CALL    P_N1
000703 D3FC 7E               7      LD  A,(HL)
000704 D3FD C680             7      ADD A,NBSP-020H
000706 D3FF FEA0             7      CP  NBSP
000708 D401 2802            12      JR  Z,FPR1
00070A D403 3E2E             7      LD  A,'.'
       D405                     FPR1:
00070C D405 CDA3D9          17      CALL    MSG_A
00070F D408 0603             7      LD  B,3
                                
       D40A                     P_N1:
000711 D40A C5              11      PUSH    BC
000712 D40B E5              11      PUSH    HL
000713 D40C 7E               7      LD  A,(HL)
000714 D40D CDB2E1          17      CALL    CAP3
000717 D410 CDA3D9          17      CALL    MSG_A
00071A D413 E1              10      POP HL
00071B D414 C1              10      POP BC
00071C D415 23               6      INC HL
00071D D416 10F2            13      DJNZ    P_N1
00071F D418 C9              10      RET
                                
       D419                     PRTTMS:
000720 D419 3E20             7      LD  A,020H
000722 D41B CDA3D9          17      CALL    MSG_A
                                
000725 D41E 2A5AF1          16      LD  HL,(DTA_CCP+1+24)
000728 D421 7D               4      LD  A,L
000729 D422 B7               4      OR  A
00072A D423 C8              11      RET Z
00072B D424 CB3C             8      SRL H
00072D D426 17               4      RLA
00072E D427 17               4      RLA
00072F D428 17               4      RLA
000730 D429 17               4      RLA
000731 D42A E60F             7      AND 00FH
000733 D42C 57               4      LD  D,A
000734 D42D 7C               4      LD  A,H
000735 D42E C650             7      ADD A,80
000737 D430 CD73D4          17      CALL    PRDEC_A
00073A D433 3E2D             7      LD  A,'-'
00073C D435 CDA3D9          17      CALL    MSG_A
00073F D438 7A               4      LD  A,D
000740 D439 CD73D4          17      CALL    PRDEC_A
000743 D43C 3E2D             7      LD  A,'-'
000745 D43E CDA3D9          17      CALL    MSG_A
000748 D441 7D               4      LD  A,L
000749 D442 E61F             7      AND 01FH
00074B D444 CD73D4          17      CALL    PRDEC_A
                                
00074E D447 2A58F1          16      LD  HL,(DTA_CCP+1+22)
                                
000751 D44A 3E20             7      LD  A,020H
000753 D44C CDA3D9          17      CALL    MSG_A
000756 D44F 7C               4      LD  A,H
000757 D450 65               4      LD  H,L
000758 D451 0603             7      LD  B,3
       D453                     PRTTMS1:
00075A D453 1F               4      RRA
00075B D454 CB1D             8      RR  L
00075D D456 10FB            13      DJNZ    PRTTMS1
00075F D458 E61F             7      AND 01FH
000761 D45A CD73D4          17      CALL    PRDEC_A
000764 D45D 3E3A             7      LD  A,':'
000766 D45F CDA3D9          17      CALL    MSG_A
000769 D462 7D               4      LD  A,L
00076A D463 0F               4      RRCA
00076B D464 0F               4      RRCA
00076C D465 E63F             7      AND 03FH
00076E D467 CD73D4          17      CALL    PRDEC_A
000771 D46A 3E3A             7      LD  A,':'
000773 D46C CDA3D9          17      CALL    MSG_A
000776 D46F 7C               4      LD  A,H
000777 D470 E61F             7      AND 01FH
000779 D472 87               4      ADD A,A
                                
                                ;   PRINT10
                                
       D473                     PRDEC_A:
00077A D473 E5              11      PUSH    HL
00077B D474 0608             7      LD  B,8
00077D D476 4F               4      LD  C,A
00077E D477 AF               4      XOR A
       D478                     PRTA1:
00077F D478 CB01             4      RLC C
000781 D47A 8F               4      ADC A,A
000782 D47B 27               4      DAA
000783 D47C 10FA            13      DJNZ    PRTA1
000785 D47E 210FEF          10      LD  HL,DECBF
000788 D481 77               7      LD  (HL),A
000789 D482 AF               4      XOR A
00078A D483 CDE9D3          17      CALL    DECX
00078D D486 E1              10      POP HL
00078E D487 C9              10      RET
                                
       D488                     SETFCB:
00078F D488 CD71DF          17      CALL    SPCUT
000792 D48B 1A               7      LD  A,(DE)
000793 D48C FE20             7      CP  020H
000795 D48E 3801            12      JR  C,SETFCBA
000797 D490 1B               6      DEC DE
       D491                     SETFCBA:
000798 D491 0624             7      LD  B,36
00079A D493 215C00          10      LD  HL,FCB1
00079D D496 E5              11      PUSH    HL
00079E D497 AF               4      XOR A
00079F D498 CD46DF          17      CALL    FILL_MEMORY
0007A2 D49B E1              10      POP HL
0007A3 D49C D5              11      PUSH    DE
0007A4 D49D CDD9D8          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0007A7 D4A0 216C00          10      LD  HL,FCB2
0007AA D4A3 CDD9D8          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0007AD D4A6 E1              10      POP HL
0007AE D4A7 010050          10      LD  BC,05000H
0007B1 D4AA 118100          10      LD  DE,00081H
       D4AD                     SETFCB1:
0007B4 D4AD 7E               7      LD  A,(HL)
0007B5 D4AE 23               6      INC HL
0007B6 D4AF FE20             7      CP  020H
0007B8 D4B1 3805            12      JR  C,SETFCB2
0007BA D4B3 12               7      LD  (DE),A
0007BB D4B4 13               6      INC DE
0007BC D4B5 0C               4      INC C
0007BD D4B6 10F5            13      DJNZ    SETFCB1
       D4B8                     SETFCB2:
0007BF D4B8 79               4      LD  A,C
0007C0 D4B9 328000          13      LD  (DTA1),A
0007C3 D4BC 04               4      INC B
       D4BD                     ZERO_MEMORY_DE:
0007C4 D4BD AF               4      XOR A
       D4BE                     FILL_MEMORY_DE:
0007C5 D4BE 12               7      LD  (DE),A
0007C6 D4BF 13               6      INC DE
0007C7 D4C0 10FC            13      DJNZ    FILL_MEMORY_DE
0007C9 D4C2 C9              10      RET
                                
       D4C3                     C_COPY:
0007CA D4C3 CD88D4          17      CALL    SETFCB
                                
0007CD D4C6 1161EF          10      LD  DE,ZERO
0007D0 D4C9 CD92DE          17      CALL    FILEC2
0007D3 D4CC 216C00          10      LD  HL,FCB2
0007D6 D4CF CDE0D8          17      CALL    S29X1
                                
0007D9 D4D2 3E10             7      LD  A,010H
0007DB D4D4 326900          13      LD  (FCB1+13),A
0007DE D4D7 216D00          10      LD  HL,FCB2+1
0007E1 D4DA CDD3D5          17      CALL    CWILD1
       D4DD                     COPY0:
0007E4 D4DD CDD0D5          17      CALL    CWILD
0007E7 D4E0 215C00          10      LD  HL,FCB1
0007EA D4E3 CDCAD1          17      CALL    OPEN
0007ED D4E6 37               4      SCF
       D4E7                     COPY1:
0007EE D4E7 C0              11      RET NZ
0007EF D4E8 CDDDD1          17      CALL    DEFCB
                                
0007F2 D4EB 3A4EF1          13      LD  A,(DTA_CCP+13)
0007F5 D4EE CB67             8      BIT 4,A
0007F7 D4F0 2821            12      JR  Z,COPY1A
                                
0007F9 D4F2 215D00          10      LD  HL,FCB1+1
0007FC D4F5 CDD5E2          17      CALL    CHKWILD
0007FF D4F8 3814            12      JR  C,COPY9
                                
000801 D4FA 3E20             7      LD  A,020H
000803 D4FC 325D00          13      LD  (FCB1+1),A
000806 D4FF 2A5BF1          16      LD  HL,(DTA_CCP+26)
000809 D502 23               6      INC HL
00080A D503 226A00          16      LD  (FCB1+14),HL
00080D D506 18D5            12      JR  COPY0
                                
       D508                     COPY8:
00080F D508 CD9BD6          17      CALL    _SYS09      ;(BDOS)文字列出力
000812 D50B CD7FD3          17      CALL    LTNL
       D50E                     COPY9:
000815 D50E CDD9D1          17      CALL    OPEN2
000818 D511 18D4            12      JR  COPY1
                                
       D513                     COPY1A:
00081A D513 216C00          10      LD  HL,FCB2
00081D D516 1114EF          10      LD  DE,FDRV
000820 D519 0143F1          10      LD  BC,DTA_CCP+2
000823 D51C EDA0            16      LDI
000825 D51E 3E0B             7      LD  A,11
       D520                     COPY2:
000827 D520 F5              11      PUSH    AF
000828 D521 7E               7      LD  A,(HL)
000829 D522 FE3F             7      CP  '?'
00082B D524 2001            12      JR  NZ,COPY3
00082D D526 0A               7      LD  A,(BC)
       D527                     COPY3:
00082E D527 12               7      LD  (DE),A
00082F D528 03               6      INC BC
000830 D529 13               6      INC DE
000831 D52A 23               6      INC HL
000832 D52B F1              10      POP AF
000833 D52C 3D               4      DEC A
000834 D52D 20F1            12      JR  NZ,COPY2
000836 D52F 010500          10      LD  BC,16-11
000839 D532 EDB0                    LDIR
       D534                     PUTNAME:
00083B D534 215D00          10      LD  HL,FCB1+1
00083E D537 CDD5E2          17      CALL    CHKWILD
000841 D53A 300B            12      JR  NC,PUTN1
000843 D53C 2115EF          10      LD  HL,FDRV+1
000846 D53F CDF7D3          17      CALL    FPRNT
000849 D542 3E20             7      LD  A,020H
00084B D544 CDA3D9          17      CALL    MSG_A
       D547                     PUTN1:
00084E D547 1114EF          10      LD  DE,FDRV
000851 D54A 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
000853 D54C CDF8D1          17      CALL    SYSTEM0
000856 D54F 2048            12      JR  NZ,COPYE2
000858 D551 67               4      LD  H,A     ;A=0
000859 D552 6F               4      LD  L,A
00085A D553 2235EF          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
00085D D556 2237EF          16      LD  (FDRV+35),HL
       D559                     COPY6:
000860 D559 CD01D2          17      CALL    S27BUF
000863 D55C 47               4      LD  B,A
000864 D55D 3C               4      INC A
000865 D55E 2831            12      JR  Z,COPYE
000867 D560 7C               4      LD  A,H
000868 D561 B5               4      OR  L
000869 D562 280C            12      JR  Z,COPY7
00086B D564 1114EF          10      LD  DE,FDRV
00086E D567 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
000870 D569 CDF8D1          17      CALL    SYSTEM0
000873 D56C 2023            12      JR  NZ,COPYE
000875 D56E 10E9            13      DJNZ    COPY6
       D570                     COPY7:
000877 D570 3A4EF1          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
00087A D573 3221EF          13      LD  (FDRV+13),A
00087D D576 2155F1          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
000880 D579 1128EF          10      LD  DE,FDRV+20
000883 D57C 010400          10      LD  BC,4
000886 D57F EDB0                    LDIR
                                
000888 D581 1114EF          10      LD  DE,FDRV
00088B D584 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
00088D D586 CDF8D1          17      CALL    SYSTEM0
000890 D589 2006            12      JR  NZ,COPYE
                                
000892 D58B 1171EF          10      LD  DE,OK
000895 D58E C308D5          10      JP  COPY8
                                
       D591                     COPYE:
000898 D591 1114EF          10      LD  DE,FDRV
00089B D594 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
00089D D596 CD0500          17      CALL    SYSTEM
       D599                     COPYE2:
0008A0 D599 37               4      SCF
0008A1 D59A C9              10      RET
                                
       D59B                     C_TYPE:
0008A2 D59B CD88D4          17      CALL    SETFCB
0008A5 D59E 215C00          10      LD  HL,FCB1
0008A8 D5A1 CDCAD1          17      CALL    OPEN
0008AB D5A4 37               4      SCF
       D5A5                     TYPE1:
0008AC D5A5 C0              11      RET NZ
0008AD D5A6 CDDDD1          17      CALL    DEFCB
0008B0 D5A9 3E06             7      LD  A,6
0008B2 D5AB CDA3D9          17      CALL    MSG_A
       D5AE                     TYPE2:
0008B5 D5AE CD01D2          17      CALL    S27BUF
0008B8 D5B1 C6FE             7      ADD A,0FEH
0008BA D5B3 D8              11      RET C
0008BB D5B4 7C               4      LD  A,H
0008BC D5B5 B5               4      OR  L
0008BD D5B6 2813            12      JR  Z,TYPEE
0008BF D5B8 010001          10      LD  BC,00100H
       D5BB                     TYPE3:
0008C2 D5BB 0A               7      LD  A,(BC)
0008C3 D5BC 03               6      INC BC
0008C4 D5BD FE1A             7      CP  01AH
0008C6 D5BF 280A            12      JR  Z,TYPEE
0008C8 D5C1 CDA3D9          17      CALL    MSG_A
0008CB D5C4 2B               6      DEC HL
0008CC D5C5 7C               4      LD  A,H
0008CD D5C6 B5               4      OR  L
0008CE D5C7 20F2            12      JR  NZ,TYPE3
0008D0 D5C9 18E3            12      JR  TYPE2
       D5CB                     TYPEE:
0008D2 D5CB CDD9D1          17      CALL    OPEN2
0008D5 D5CE 18D5            12      JR  TYPE1
                                
       D5D0                     CWILD:
0008D7 D5D0 215D00          10      LD  HL,FCB1+1
       D5D3                     CWILD1:
0008DA D5D3 7E               7      LD  A,(HL)
0008DB D5D4 FE20             7      CP  020H
0008DD D5D6 C0              11      RET NZ
       D5D7                     CWILD2:
0008DE D5D7 3E3F             7      LD  A,'?'
0008E0 D5D9 060B             7      LD  B,11
0008E2 D5DB C346DF          10      JP  FILL_MEMORY
                                
0008E5 D5DE 20202020203C4449    DIRMES: DB  "     <DIR>$"
            523E24              
0008F0 D5E9 20203A24            DIRHD:  DB  "  :$"
                                
       D5ED                     COMTB:
0008F4 D5ED 44202020                DB  "D   "  ;1
0008F8 D5F1 DFD2                    DW  C_DIR
0008FA D5F3 44495220                DB  "DIR "  ;2
0008FE D5F7 DFD2                    DW  C_DIR
000900 D5F9 434F5059                DB  "COPY"  ;3
000904 D5FD C3D4                    DW  C_COPY
000906 D5FF 43442020                DB  "CD  "  ;4
00090A D603 FDD1                    DW  C_CD
00090C D605 44454C20                DB  "DEL "  ;5
000910 D609 C2D2                    DW  C_DEL
000912 D60B 50415448                DB  "PATH"  ;6
000916 D60F 84D3                    DW  C_PATH
000918 D611 52454E20                DB  "REN "  ;7
00091C D615 CCD2                    DW  C_REN
00091E D617 54595045                DB  "TYPE"  ;8
000922 D61B 9BD5                    DW  C_TYPE
000924 D61D 52454D20                DB  "REM "  ;9
000928 D621 98D6                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "88DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   PC-8801mkIISR
                                
                                ;   BANK RAM DISK DRIVER
                                
       D623                     BDWT:
00092A D623 3E10             7      LD  A,010H  ;ライト可　リード不可
00092C D625 1802            12  JR  BRW
                                
       D627                     BDRD:
00092E D627 3E01             7      LD  A,001H  ;ライト不可　リード可
       D629                     BRW:
000930 D629 F3               4      DI
000931 D62A D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000933 D62C ED7365D6        20      LD  (BANKSP+1),SP
000937 D630 3A66D6          13      LD  A,(BANKSP+2)
00093A D633 87               4      ADD A,A
00093B D634 3803            12      JR  C,BRW1
00093D D636 312EEE          10      LD  SP,EXTSP
       D639                     BRW1:
000940 D639 C5              11      PUSH    BC
000941 D63A D5              11      PUSH    DE
000942 D63B EB               4      EX  DE,HL
000943 D63C 29              11      ADD HL,HL
000944 D63D 29              11      ADD HL,HL
000945 D63E 7C               4      LD  A,H
000946 D63F DD860C          19      ADD A,(IX+DPB_MAXCYL)
000949 D642 E60F             7      AND 00FH        ;バンク
00094B D644 D3E3            11      OUT (0E3H),A    ;拡張RAM バンク選択
00094D D646 65               4      LD  H,L
00094E D647 CB3C             8      SRL H   ;/2
000950 D649 2E00             7      LD  L,0
000952 D64B DBE2            11      IN  A,(0E2H)    ;拡張RAM リード/ライト制御
000954 D64D 0F               4      RRCA
000955 D64E 3001            12      JR  NC,BRW2
000957 D650 EB               4      EX  DE,HL
       D651                     BRW2:
000958 D651 010002          10      LD  BC,512
00095B D654 EDB0                    LDIR
                                
00095D D656 DBE2            11      IN  A,(0E2H)    ;拡張RAM リード/ライト制御
00095F D658 0F               4      RRCA
000960 D659 3801            12      JR  C,BRW3
000962 D65B EB               4      EX  DE,HL
       D65C                     BRW3:
000963 D65C D1              10      POP DE
000964 D65D C1              10      POP BC
000965 D65E 13               6      INC DE
000966 D65F 10D8            13      DJNZ    BRW1
                                
000968 D661 AF               4      XOR A
000969 D662 D3E2            11      OUT (0E2H),A    ;メインメモリに切り替える
00096B D664 310000          10  BANKSP: LD  SP,0
00096E D667 FB               4      EI
00096F D668 C9              10      RET
                                
[EOF:88DISK2.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D669                     BDOS0:
000970 D669 E5              11      PUSH    HL
000971 D66A 79               4      LD  A,C
000972 D66B FE3C             7      CP  03CH
000974 D66D 3802            12      JR  C,DOS1
000976 D66F 3E3C             7      LD  A,03CH
       D671                     DOS1:
000978 D671 87               4      ADD A,A
000979 D672 6F               4      LD  L,A
00097A D673 26F0             7      LD  H,STABLE/256
00097C D675 7E               7      LD  A,(HL)
00097D D676 2C               4      INC L
00097E D677 66               7      LD  H,(HL)
00097F D678 6F               4      LD  L,A
000980 D679 E3              19      EX  (SP),HL
000981 D67A 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
000982 D67B C9              10      RET
       D67C                     _DOS2:
000983 D67C FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000985 D67E CA1BD9          10      JP  Z,_SYS5A
000988 D681 FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
00098A D683 CAD9D8          10      JP  Z,_SYS29
00098D D686 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
00098F D688 CAEEEB          10      JP  Z,_SYS5F
000992 D68B FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000994 D68D 200A            12      JR  NZ,_ERROR
000996 D68F 011D01          10      LD  BC,VER_6F
000999 D692 115701          10      LD  DE,VER
00099C D695 210201          10      LD  HL,MACD
       D698                     C_REM:
00099F D698 AF               4      XOR A
       D699                     _ERROR:
0009A0 D699 A7               4      AND A
0009A1 D69A C9              10      RET
                                
       D69B                     _SYS09:     ;文字列出力
0009A2 D69B D5              11      PUSH    DE
       D69C                     _SX09:
0009A3 D69C 1A               7      LD  A,(DE)
0009A4 D69D 13               6      INC DE
0009A5 D69E FE24             7      CP  '$'
0009A7 D6A0 2831            12      JR  Z,SX0E2
0009A9 D6A2 CDA3D9          17      CALL    MSG_A
0009AC D6A5 18F5            12      JR  _SX09
                                
       D6A7                     MSX1:
0009AE D6A7 CDA3D9          17      CALL    MSG_A
       D6AA                     MSX:
0009B1 D6AA 7E               7      LD  A,(HL)
0009B2 D6AB 23               6      INC HL
0009B3 D6AC B7               4      OR  A
0009B4 D6AD 20F8            12      JR  NZ,MSX1
0009B6 D6AF C9              10      RET
                                
       D6B0                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0009B7 D6B0 212200          10      LD  HL,00022H
0009BA D6B3 7D               4      LD  A,L
0009BB D6B4 C9              10      RET
                                
       D6B5                     _SYS0D:     ;(BDOS)ディスクリセット
0009BC D6B5 CDDFEF          17      CALL    _FFLUSH
0009BF D6B8 E5              11      PUSH    HL
0009C0 D6B9 218000          10      LD  HL,00080H
0009C3 D6BC 228AEF          16      LD  (_DTA),HL
0009C6 D6BF E1              10      POP HL
0009C7 D6C0 D5              11      PUSH    DE
0009C8 D6C1 1E00             7      LD  E,0
0009CA D6C3 3E                      DB  03EH
                                
       D6C4                     _SYS0E:     ;(BDOS)カレントドライブの設定
0009CB D6C4 D5              11      PUSH    DE
0009CC D6C5 7B               4      LD  A,E
0009CD D6C6 DDE5            15      PUSH    IX
0009CF D6C8 CDDCEF          17      CALL    _GETDPB
0009D2 D6CB DDE1            14      POP IX
0009D4 D6CD 3804            12      JR  C,SX0E2
0009D6 D6CF 7B               4      LD  A,E
0009D7 D6D0 3287EF          13      LD  (_DVSW),A
       D6D3                     SX0E2:
0009DA D6D3 D1              10      POP DE
0009DB D6D4 C9              10      RET
                                
       D6D5                     _SYS0F:     ;(BDOS)ファイルのオープン
0009DC D6D5 CD83DF          17      CALL    SETDRV
0009DF D6D8 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0009E2 D6DB C602             7      ADD A,002H      ;Write
0009E4 D6DD 2848            12      JR  Z,FEND0F
0009E6 D6DF CDD1E2          17      CALL    CHKWILDX
                                
0009E9 D6E2 D4A3DF          17      CALL    NC,SOPENX
       D6E5                     _S16XX:
0009EC D6E5 3840            12      JR  C,FEND0F
                                                ;Directory location
0009EE D6E7 3A9FEF          13      LD  A,(_FILEN)
0009F1 D6EA FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
0009F4 D6ED 3AA0EF          13      LD  A,(_DIRF)
0009F7 D6F0 FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
0009FA D6F3 FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
0009FD D6F6 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
000A00 D6F9 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
000A04 D6FD FDE5            15      PUSH    IY
000A06 D6FF D1              10      POP DE
000A07 D700 13               6      INC DE
000A08 D701 010B00          10      LD  BC,11
000A0B D704 EDB0                    LDIR
                                ;               Attribute
000A0D D706 7E               7      LD  A,(HL)
000A0E D707 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
000A11 D70A 110B00          10      LD  DE,11       ;Reserved
000A14 D70D 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
000A15 D70E 11E4F0          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
000A18 D711 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D713                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000A1A D713 1A               7      LD  A,(DE)
000A1B D714 13               6      INC DE
000A1C D715 321CD7          13      LD  (S16PAT+2),A
000A1F D718 7E               7      LD  A,(HL)
000A20 D719 23               6      INC HL
000A21 D71A FD7700          19  S16PAT: LD  (IY+0),A
000A24 D71D 10F4            13      DJNZ    S16LOOP
                                
000A26 D71F AF               4      XOR A
000A27 D720 FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000A2A D723 FD22CBD7        20      LD  (OFCB+1),IY
       D727                     FEND0F:
000A2E D727 1845            12      JR  FEND10
                                
       D729                     _SYS10:     ;(BDOS)ファイルのクローズ
000A30 D729 CD83DF          17      CALL    SETDRV
000A33 D72C FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000A36 D72F D6FE             7      SUB 0FEH
000A38 D731 37               4      SCF
000A39 D732 3F               4      CCF
000A3A D733 2039            12      JR  NZ,FEND10
       D735                     _S10A:              ;Write
000A3C D735 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000A3F D738 FD770F          19      LD  (IY+15),A
                                
000A42 D73B FD341C          23      INC (IY+28)     ;0FEH->0FFH ;オープンモード
000A45 D73E CDCDE3          17      CALL    SETTMS
                                
000A48 D741 FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000A4B D744 32A0EF          13      LD  (_DIRF),A
000A4E D747 E67F             7      AND 07FH
000A50 D749 32F8E8          13      LD  (_SECPS+1),A
000A53 D74C FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000A56 D74F FD561F          19      LD  D,(IY+31)
000A59 D752 CDD7E0          17      CALL    READ_DIR
000A5C D755 3817            12      JR  C,FEND10
                                
000A5E D757 3A01E0          13  SDECM1: LD  A,(SDECPAT+1)   ;1セクタ辺りのディレクトリエントリ数
000A61 D75A 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000A62 D75B FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000A65 D75E 6F               4      LD  L,A
000A66 D75F 2600             7      LD  H,0
000A68 D761 29              11      ADD HL,HL       ;*2
000A69 D762 29              11      ADD HL,HL       ;*4
000A6A D763 29              11      ADD HL,HL       ;*8
000A6B D764 29              11      ADD HL,HL       ;*16
000A6C D765 29              11      ADD HL,HL       ;*32
000A6D D766 ED4B7EF0        20      LD  BC,(_DTBUF)
000A71 D76A 09              11      ADD HL,BC
                                
000A72 D76B CDE1E2          17      CALL    SDIRENT
       D76E                     FEND10:
000A75 D76E 1842            12      JR  FEND
                                
       D770                     _SYS11:     ;(BDOS)最初のファイルの検索
000A77 D770 CD83DF          17      CALL    SETDRV
000A7A D773 CDD0DF          17      CALL    SOPEN
       D776                     _S12X1:
000A7D D776 383A            12      JR  C,FEND
000A7F D778 CD70E0          17      CALL    SOPENE2
000A82 D77B ED5B8AEF        20      LD  DE,(_DTA)
000A86 D77F 3A88EF          13      LD  A,(_DRV)
000A89 D782 3C               4      INC A
000A8A D783 12               7      LD  (DE),A
000A8B D784 D5              11      PUSH    DE
000A8C D785 13               6      INC DE
000A8D D786 012000          10      LD  BC,32
000A90 D789 EDB0                    LDIR
000A92 D78B FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000A95 D78E FD660F          19      LD  H,(IY+15)
000A98 D791 22F4F0          16      LD  (SCDIR),HL
000A9B D794 2A9AEF          16      LD  HL,(_FBPS)
000A9E D797 22F6F0          16      LD  (SFBPS),HL
000AA1 D79A 2A9FEF          16      LD  HL,(_FILEN)
000AA4 D79D 7C               4      LD  A,H
000AA5 D79E B7               4      OR  A
000AA6 D79F 2806            12      JR  Z,_S12DIR
000AA8 D7A1 3AF8E8          13      LD  A,(_SECPS+1)
000AAB D7A4 F680             7      OR  080H
000AAD D7A6 67               4      LD  H,A
       D7A7                     _S12DIR:
000AAE D7A7 22F8F0          16      LD  (SFNDF),HL  ;Directory position and Flags
000AB1 D7AA E1              10      POP HL
000AB2 D7AB 1139EF          10      LD  DE,SFILE
000AB5 D7AE 0E21             7      LD  C,33
       D7B0                     _S11B:
000AB7 D7B0 EDB0                    LDIR
       D7B2                     FEND:
000AB9 D7B2 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D7B3                     FENDE:
000ABA D7B3 FDE1            14      POP IY
000ABC D7B5 C1              10      POP BC
000ABD D7B6 D1              10      POP DE
000ABE D7B7 E1              10      POP HL
000ABF D7B8 C9              10      RET
                                
       D7B9                     _SYS12:     ;(BDOS)次のファイルの検索
000AC0 D7B9 E5              11      PUSH    HL
000AC1 D7BA D5              11      PUSH    DE
000AC2 D7BB C5              11      PUSH    BC
000AC3 D7BC FDE5            15      PUSH    IY
000AC5 D7BE CD34E0          17      CALL    NOPEN
000AC8 D7C1 18B3            12      JR  _S12X1
                                
       D7C3                     _S16K:
000ACA D7C3 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000ACD D7C6 FEFD             7      CP  0FDH        ;Device(0FDH)
000ACF D7C8 37               4      SCF
000AD0 D7C9 C8              11      RET Z
                                
000AD1 D7CA 110000          10  OFCB:   LD  DE,0
000AD4 D7CD D5              11      PUSH    DE
000AD5 D7CE 061A             7      LD  B,26        ;First cluster
       D7D0                     S16K1:
000AD7 D7D0 13               6      INC DE
000AD8 D7D1 23               6      INC HL
000AD9 D7D2 10FC            13      DJNZ    S16K1
                                
000ADB D7D4 1A               7      LD  A,(DE)
000ADC D7D5 BE               7      CP  (HL)
000ADD D7D6 2013            12      JR  NZ,S16K2
000ADF D7D8 13               6      INC DE
000AE0 D7D9 23               6      INC HL
000AE1 D7DA 1A               7      LD  A,(DE)
000AE2 D7DB BE               7      CP  (HL)
000AE3 D7DC 200D            12      JR  NZ,S16K2
                                
000AE5 D7DE E1              10      POP HL
000AE6 D7DF FDE5            15      PUSH    IY
000AE8 D7E1 D1              10      POP DE
000AE9 D7E2 1A               7      LD  A,(DE)      ;Drive
000AEA D7E3 BE               7      CP  (HL)
000AEB D7E4 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000AED D7E6 ED52            15      SBC HL,DE       ;CP HL,DE
000AEF D7E8 37               4      SCF
000AF0 D7E9 C0              11      RET NZ
000AF1 D7EA E5              11      PUSH    HL
       D7EB                     S16K2:
000AF2 D7EB E1              10      POP HL
       D7EC                     S16K3:
000AF3 D7EC FDE5            15      PUSH    IY
000AF5 D7EE D1              10      POP DE
       D7EF                     _SYS13:     ;(BDOS)ファイルの削除
000AF6 D7EF CD83DF          17      CALL    SETDRV
000AF9 D7F2 CD01E2          17      CALL    KILL
       D7F5                     FEND13:
000AFC D7F5 18BB            12      JR  FEND
                                
       D7F7                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000AFE D7F7 CD83DF          17      CALL    SETDRV
000B01 D7FA CD39E4          17      CALL    INIT_SEQ
       D7FD                     SREAD:
000B04 D7FD CD81E4          17      CALL    RB_READ
                                
000B07 D800 C601             7      ADD A,001H
000B09 D802 38AE            12      JR  C,FEND
                                
000B0B D804 7D               4      LD  A,L
000B0C D805 D601             7      SUB 001H
       D807                     FENDX:
000B0E D807 9F               4      SBC A,A
000B0F D808 E603             7      AND 3
000B11 D80A 1F               4      RRA
000B12 D80B 18A6            12      JR  FENDE
                                
       D80D                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000B14 D80D CD83DF          17      CALL    SETDRV
000B17 D810 CD39E4          17      CALL    INIT_SEQ
       D813                     SWRITE:
000B1A D813 CD7AE4          17      CALL    RB_WRITE
                                
000B1D D816 C6FF             7      ADD A,0FFH
000B1F D818 18ED            12      JR  FENDX
                                
       D81A                     _SYS17:     ;(BDOS)ファイル名の変更
000B21 D81A CD83DF          17      CALL    SETDRV
000B24 D81D CD57E2          17      CALL    NAME
000B27 D820 18D3            12      JR  FEND13
                                
       D822                     _SYS16:     ;(BDOS)ファイルの作成
000B29 D822 CD83DF          17      CALL    SETDRV
                                
000B2C D825 CDD1E2          17      CALL    CHKWILDX
000B2F D828 38CB            12      JR  C,FEND13
000B31 D82A FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000B34 D82D FE05             7      CP  5
000B36 D82F 2805            12      JR  Z,_S16X2
000B38 D831 FE21             7      CP  021H
000B3A D833 DAF5D7          10      JP  C,FEND13
       D836                     _S16X2:
                                ;               Clear FCB
000B3D D836 FDE5            15      PUSH    IY
000B3F D838 E1              10      POP HL
000B40 D839 011000          10      LD  BC,16
000B43 D83C 09              11      ADD HL,BC
       D83D                     _S16X1:
000B44 D83D 70               7      LD  (HL),B      ;B=0
000B45 D83E 23               6      INC HL
000B46 D83F 0D               4      DEC C
000B47 D840 20FB            12      JR  NZ,_S16X1
                                
000B49 D842 CDD2E3          17      CALL    SETTMSX
000B4C D845 FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000B50 D849 CDA3DF          17      CALL    SOPENX
000B53 D84C 3F               4      CCF
000B54 D84D CCC3D7          17      CALL    Z,_S16K
000B57 D850 D481E0          17      CALL    NC,COPEN
000B5A D853 D4E1E2          17      CALL    NC,SDIRENT
000B5D D856 C3E5D6          10      JP  _S16XX
                                
       D859                     _SYS21:     ;(BDOS)ランダムな読み出し
000B60 D859 CD83DF          17      CALL    SETDRV
000B63 D85C CD1DE4          17      CALL    INIT_RND
000B66 D85F 189C            12      JR  SREAD
                                
       D861                     _SYS22:     ;(BDOS)ランダムな書き込み
       D861                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000B68 D861 CD83DF          17      CALL    SETDRV
000B6B D864 CD1DE4          17      CALL    INIT_RND
000B6E D867 18AA            12      JR  SWRITE
                                
       D869                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000B70 D869 21FF00          10      LD  HL,000FFH
000B73 D86C AF               4      XOR A
000B74 D86D C9              10      RET
                                
       D86E                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000B75 D86E 3A87EF          13      LD  A,(_DVSW)
000B78 D871 A7               4      AND A
000B79 D872 C9              10      RET
                                
       D873                     _SYS1A:     ;(BDOS)DTAの設定
000B7A D873 ED538AEF        20      LD  (_DTA),DE
000B7E D877 AF               4      XOR A
000B7F D878 C9              10      RET
                                
       D879                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000B80 D879 7B               4      LD  A,E
000B81 D87A CD96DF          17      CALL    GETDRV
000B84 D87D CDDCEF          17      CALL    _GETDPB
000B87 D880 D4E2EF          17      CALL    NC,_RDFATX
000B8A D883 210000          10      LD  HL,0
000B8D D886 D4ABE3          17      CALL    NC,DSKF
                                
000B90 D889 ED5BACE3        20      LD  DE,(MAXCLP+1)   ;DPB_MAXCL-1
000B94 D88D 1B               6      DEC DE      ;DE←クラスタの総数
000B95 D88E FD2A7CF0        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000B99 D892 9F               4      SBC A,A
000B9A D893 D8              11      RET C
000B9B D894 4F               4      LD  C,A     ;C=0
000B9C D895 DD7E0F          19      LD  A,(IX+DPB_BPS)
000B9F D898 E60F             7      AND 00FH
000BA1 D89A 47               4      LD  B,A
000BA2 D89B DD7E07          19      LD  A,(IX+DPB_SECPCL)
000BA5 D89E C9              10      RET
                                
       D89F                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000BA6 D89F AF               4      XOR A
000BA7 D8A0 67               4      LD  H,A
000BA8 D8A1 6F               4      LD  L,A
000BA9 D8A2 C9              10      RET
                                
       D8A3                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000BAA D8A3 2100F2          10      LD  HL,_DEVICE
000BAD D8A6 7B               4      LD  A,E
000BAE D8A7 C3DCEF          10      JP  _GETDPB
                                
       D8AA                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000BB1 D8AA E5              11      PUSH    HL
000BB2 D8AB 2A1EF0          16      LD  HL,(STABLE+2*00FH)  ;ファイルのオープン
000BB5 D8AE CD0F00          17      CALL    JP_HL
000BB8 D8B1 381B            12      JR  C,_S23X1
                                
000BBA D8B3 D5              11      PUSH    DE      ;EX DE,IY
000BBB D8B4 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000BBD D8B6 FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000BC0 D8B9 FD6E11          19      LD  L,(IY+17)   ;
000BC3 D8BC FD6612          19      LD  H,(IY+18)   ;
000BC6 D8BF C5              11      PUSH    BC      ;
000BC7 D8C0 FD4613          19      LD  B,(IY+19)   ;
000BCA D8C3 CD0FE4          17      CALL    GET_CPM_R_SIZE
000BCD D8C6 C1              10      POP BC
       D8C7                     _S24X1:
000BCE D8C7 CD2FE4          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000BD1 D8CA FDE3            23      EX  (SP),IY     ;
000BD3 D8CC D1              10      POP DE      ;
                                
000BD4 D8CD AF               4      XOR A
       D8CE                     _S23X1:
000BD5 D8CE E1              10      POP HL
000BD6 D8CF C9              10      RET
                                
       D8D0                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000BD7 D8D0 E5              11      PUSH    HL
000BD8 D8D1 D5              11      PUSH    DE      ;EX DE,IY
000BD9 D8D2 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000BDB D8D4 CD41E4          17      CALL    GETSEQ
000BDE D8D7 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D8D9                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000BE0 D8D9 C5              11      PUSH    BC
000BE1 D8DA E5              11      PUSH    HL
000BE2 D8DB CD9ADE          17      CALL    FILE
000BE5 D8DE E1              10      POP HL
000BE6 D8DF C1              10      POP BC
       D8E0                     S29X1:
000BE7 D8E0 C5              11      PUSH    BC
000BE8 D8E1 D5              11      PUSH    DE
000BE9 D8E2 E5              11      PUSH    HL
000BEA D8E3 EB               4      EX  DE,HL
000BEB D8E4 AF               4      XOR A
000BEC D8E5 3221EF          13      LD  (FDRV+13),A
000BEF D8E8 2114EF          10      LD  HL,FDRV
000BF2 D8EB 011000          10      LD  BC,16
000BF5 D8EE EDB0                    LDIR
000BF7 D8F0 E1              10      POP HL
000BF8 D8F1 D1              10      POP DE
000BF9 D8F2 C1              10      POP BC
000BFA D8F3 C9              10      RET
                                
       D8F4                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000BFB D8F4 C5              11      PUSH    BC
000BFC D8F5 0192EA          10      LD  BC,DWT24B
000BFF D8F8 1804            12      JR  S2FX
       D8FA                     _SYS2F:
000C01 D8FA C5              11      PUSH    BC
000C02 D8FB 0182EA          10      LD  BC,DRD24B
       D8FE                     S2FX:
000C05 D8FE ED4314D9        20      LD  (S2FPAT+1),BC
000C09 D902 CDDFEF          17      CALL    _FFLUSH
                                
000C0C D905 D5              11      PUSH    DE
000C0D D906 E5              11      PUSH    HL
000C0E D907 7D               4      LD  A,L     ;Drive
000C0F D908 CDD9EF          17      CALL    _CHGDRV
000C12 D90B 3809            12      JR  C,S30X2
000C14 D90D 44               4      LD  B,H     ;Number of clusters
000C15 D90E 2A8AEF          16      LD  HL,(_DTA)
                                
000C18 D911 0E00             7      LD  C,0
000C1A D913 CD82EA          17  S2FPAT: CALL    DRD24B
       D916                     S30X2:
000C1D D916 E1              10      POP HL
000C1E D917 D1              10      POP DE
000C1F D918 C1              10      POP BC
000C20 D919 9F               4      SBC A,A
000C21 D91A C9              10      RET
                                
       D91B                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000C22 D91B C5              11      PUSH    BC
000C23 D91C D5              11      PUSH    DE
000C24 D91D E5              11      PUSH    HL
000C25 D91E CD8FDE          17      CALL    FILEC
000C28 D921 210000          10      LD  HL,0
000C2B D924 1114EF          10      LD  DE,FDRV
000C2E D927 2A4EF0          16      LD  HL,(STABLE+2*027H)  ;ランダムブロック読み込み
000C31 D92A CD0F00          17      CALL    JP_HL
000C34 D92D 18E7            12      JR  S30X2
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "88IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   PC-8801mkIISR
                                
       D699                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D699                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D699                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D699                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D699                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D699                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       D92F                     BDOS_RF:
000C36 D92F DB32            11      IN  A,(032H)
000C38 D931 F610             7      OR  010H        ;高速RAMアクセスモードOFF
000C3A D933 D332            11      OUT (032H),A
000C3C D935 C369D6          10      JP  BDOS0
                                
       D938                     INTVRTC:
000C3F D938 F3               4      DI
000C40 D939 F5              11      PUSH    AF
000C41 D93A CD9FDD          17      CALL    CHKEY
000C44 D93D FE00             7      CP  0
       D93E                     KEYDT   EQU $-1
000C46 D93F 2028            12      JR  NZ,SETKEY1
000C48 D941 E5              11      PUSH    HL
000C49 D942 2A90EF          16      LD  HL,(_KEYPS)
000C4C D945 7C               4      LD  A,H
000C4D D946 AD               4      XOR L
000C4E D947 E1              10      POP HL
000C4F D948 2011            12      JR  NZ,ENDKEY
000C51 D94A 3E00             7      LD  A,0
       D94B                     KEYAR   EQU $-1
000C53 D94C B7               4      OR  A
000C54 D94D 2014            12      JR  NZ,ARWKEY
       D94F                     SETKEY:
000C56 D94F 324BD9          13      LD  (KEYAR),A
000C59 D952 3A92EF          13      LD  A,(_KEYD)
000C5C D955 323ED9          13      LD  (KEYDT),A
000C5F D958 CD76D9          17      CALL    KEYSET
       D95B                     ENDKEY:
000C62 D95B 3AB7EF          13      LD  A,(WKE4)
000C65 D95E D3E4            11      OUT (0E4H),A
000C67 D960 F1              10      POP AF
000C68 D961 FB               4      EI
000C69 D962 C9              10      RET
       D963                     ARWKEY:
000C6A D963 3D               4      DEC A
000C6B D964 324BD9          13      LD  (KEYAR),A
000C6E D967 18F2            12      JR  ENDKEY
       D969                     SETKEY1:
000C70 D969 3A95EF          13      LD  A,(_KEYSP+1)
000C73 D96C 18E1            12      JR  SETKEY
                                
       D96E                     INTE88:
000C75 D96E F5              11      PUSH    AF
000C76 D96F 3AB7EF          13      LD  A,(WKE4)
000C79 D972 D3E4            11      OUT (0E4H),A
000C7B D974 F1              10      POP AF
000C7C D975 C9              10      RET
       D976                     KEYSET:
       D976                     KEYBS:
000C7D D976 B7               4      OR  A
000C7E D977 C8              11      RET Z
       D978                     KEYBS1:
000C7F D978 CD90D9          17      CALL    KEYBC_IFBREAK
000C82 D97B E5              11      PUSH    HL
000C83 D97C F5              11      PUSH    AF
000C84 D97D 2A90EF          16      LD  HL,(_KEYPS)
000C87 D980 2C               4      INC L
000C88 D981 CBAD             8      RES 5,L
000C8A D983 7D               4      LD  A,L
000C8B D984 BC               4      CP  H
000C8C D985 2815            12      JR  Z,POP_AF_HL_SCF_RET
000C8E D987 3290EF          13      LD  (_KEYPS),A
000C91 D98A 26FF             7      LD  H,KEYBF/256
000C93 D98C F1              10      POP AF
000C94 D98D 77               7      LD  (HL),A
000C95 D98E E1              10      POP HL
000C96 D98F C9              10      RET
       D990                     KEYBC_IFBREAK:
000C97 D990 FE03             7      CP  3
000C99 D992 C0              11      RET NZ
       D993                     KEYBC:
000C9A D993 E5              11      PUSH    HL
000C9B D994 210000          10      LD  HL,0
000C9E D997 2290EF          16      LD  (_KEYPS),HL
000CA1 D99A E1              10      POP HL
000CA2 D99B C9              10      RET
                                
       D99C                     POP_AF_HL_SCF_RET:
000CA3 D99C F1              10      POP AF
000CA4 D99D E1              10      POP HL
000CA5 D99E 37               4      SCF
000CA6 D99F C9              10      RET
                                
       D9A0                     _SYS01:     ;(BDOS)コンソール入力
000CA7 D9A0 CD09EF          17      CALL    _SYS07
       D9A3                     MSG_A:
000CAA D9A3 F5              11      PUSH    AF
000CAB D9A4 D5              11      PUSH    DE
000CAC D9A5 5F               4      LD  E,A
000CAD D9A6 CDACD9          17      CALL    _SYS02
000CB0 D9A9 D1              10      POP DE
000CB1 D9AA F1              10      POP AF
000CB2 D9AB C9              10      RET
                                
       D9AC                     _SYS02:     ;(BDOS)コンソール出力
000CB3 D9AC CDBED9          17      CALL    BREAK
000CB6 D9AF 1805            12      JR  PRINTX
                                
       D9B1                     _SYS06:     ;(BDOS)コンソール直接入出力
000CB8 D9B1 7B               4      LD  A,E
000CB9 D9B2 3C               4      INC A
000CBA D9B3 CACAEF          10      JP  Z,_INKEY
       D9B6                     PRINTX:
000CBD D9B6 C3CDEF          10      JP  _PRINT
                                
       D9B9                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000CC0 D9B9 CD09EF          17      CALL    _SYS07
000CC3 D9BC 1804            12      JR  BREAK1
       D9BE                     BREAK:
000CC5 D9BE FB               4      EI
000CC6 D9BF 3A92EF          13      LD  A,(_KEYD)
       D9C2                     BREAK1:
000CC9 D9C2 FE03             7      CP  3       ;CTRL+C
000CCB D9C4 CA00EF          10      JP  Z,CPM_BOOT
000CCE D9C7 FE13             7      CP  013H        ;CTRL+S
000CD0 D9C9 C0              11      RET NZ
                                
       D9CA                     PAUSE:
000CD1 D9CA CD93D9          17      CALL    KEYBC
                                
       D9CD                     FLGET:
000CD4 D9CD CDDFEF          17      CALL    _FFLUSH
000CD7 D9D0 E5              11      PUSH    HL
000CD8 D9D1 2A8EEF          16      LD  HL,(_TXADR)
000CDB D9D4 CD5EDC          17      CALL    CURSOR_ON
       D9D7                     FLGET1:
000CDE D9D7 CDCAEF          17      CALL    _INKEY
000CE1 D9DA 28FB            12      JR  Z,FLGET1
000CE3 D9DC CD6FDC          17      CALL    CURSOR_OFF
000CE6 D9DF E1              10      POP HL
000CE7 D9E0 C9              10      RET
                                
       D9E1                     _SYS0A:     ;(BDOS)文字列入力
000CE8 D9E1 C5              11      PUSH    BC
000CE9 D9E2 E5              11      PUSH    HL
000CEA D9E3 D5              11      PUSH    DE
000CEB D9E4 CD2EDD          17      CALL    GETL
000CEE D9E7 1120FF          10      LD  DE,KBUF
000CF1 D9EA E1              10      POP HL
000CF2 D9EB E5              11      PUSH    HL
000CF3 D9EC 0E00             7      LD  C,0
000CF5 D9EE 3004            12      JR  NC,SAX0
000CF7 D9F0 23               6      INC HL
000CF8 D9F1 23               6      INC HL
000CF9 D9F2 1808            12      JR  SAX4
       D9F4                     SAX0:
000CFB D9F4 46               7      LD  B,(HL)
000CFC D9F5 23               6      INC HL
       D9F6                     SAX1:
000CFD D9F6 23               6      INC HL
000CFE D9F7 1A               7      LD  A,(DE)
000CFF D9F8 13               6      INC DE
000D00 D9F9 B7               4      OR  A
000D01 D9FA 2004            12      JR  NZ,SAX2
       D9FC                     SAX4:
000D03 D9FC 360D            10      LD  (HL),00DH
000D05 D9FE 1804            12      JR  SAX3
       DA00                     SAX2:
000D07 DA00 77               7      LD  (HL),A
000D08 DA01 0C               4      INC C
000D09 DA02 10F2            13      DJNZ    SAX1
       DA04                     SAX3:
000D0B DA04 D1              10      POP DE
000D0C DA05 79               4      LD  A,C
000D0D DA06 13               6      INC DE
000D0E DA07 12               7      LD  (DE),A
000D0F DA08 1B               6      DEC DE
000D10 DA09 E1              10      POP HL
000D11 DA0A C1              10      POP BC
000D12 DA0B A7               4      AND A
000D13 DA0C C9              10      RET
                                
       DA0D                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000D14 DA0D CDBED9          17      CALL    BREAK
000D17 DA10 3A92EF          13      LD  A,(_KEYD)
000D1A DA13 B7               4      OR  A
000D1B DA14 C8              11      RET Z
       DA15                     CONSTX:
000D1C DA15 CDDFEF          17      CALL    _FFLUSH
000D1F DA18 E5              11      PUSH    HL
000D20 DA19 2A90EF          16      LD  HL,(_KEYPS)
000D23 DA1C 7C               4      LD  A,H
000D24 DA1D AD               4      XOR L
000D25 DA1E E1              10      POP HL
000D26 DA1F C6FF             7      ADD A,0FFH
000D28 DA21 9F               4      SBC A,A
000D29 DA22 C9              10      RET
                                
       DA23                     _SYS2A:     ;(BDOS)日付の獲得
000D2A DA23 C5              11      PUSH    BC
000D2B DA24 CD63DA          17      CALL    RTCREAD
000D2E DA27 3A62EF          13      LD  A,(RTC_YY)
000D31 DA2A CDC6DA          17      CALL    BCD
000D34 DA2D 6F               4      LD  L,A
000D35 DA2E 2600             7      LD  H,0
                                ;   LD  DE,1900     ;0076CH
                                ;   CP  90      ;90以上は1900年代 1990-1999
                                ;   JR  NC,RDDATE1  ;90未満は2000年代 2000-2089
                                ;   LD  E,0D0H      ;2000 & 0FFH D=007H
000D37 DA30 11D007          10      LD  DE,2000     ;すべて2000年代で処理 2000-2099
       DA33                     RDDATE1:
000D3A DA33 19              11      ADD HL,DE
000D3B DA34 3A63EF          13      LD  A,(RTC_MW)
000D3E DA37 57               4      LD  D,A
000D3F DA38 3A64EF          13      LD  A,(RTC_DD)
000D42 DA3B CDC6DA          17      CALL    BCD
000D45 DA3E 5F               4      LD  E,A
000D46 DA3F 7A               4      LD  A,D
000D47 DA40 0604             7      LD  B,4
       DA42                     RDDATE2:
000D49 DA42 CB3A             8      SRL D
000D4B DA44 10FC            13      DJNZ    RDDATE2
000D4D DA46 C1              10      POP BC
000D4E DA47 E607             7      AND 7
000D50 DA49 C9              10      RET
                                
       DA4A                     _SYS2C:     ;(BDOS)時刻の獲得
000D51 DA4A C5              11      PUSH    BC
000D52 DA4B CD63DA          17      CALL    RTCREAD
000D55 DA4E 3A65EF          13      LD  A,(RTC_TT)
000D58 DA51 CDC6DA          17      CALL    BCD
000D5B DA54 67               4      LD  H,A
000D5C DA55 3A66EF          13      LD  A,(RTC_MM)
000D5F DA58 CDC6DA          17      CALL    BCD
000D62 DA5B 6F               4      LD  L,A
000D63 DA5C 3A67EF          13      LD  A,(RTC_SS)
000D66 DA5F 57               4      LD  D,A
000D67 DA60 C1              10      POP BC
000D68 DA61 AF               4      XOR A
000D69 DA62 C9              10      RET
                                
       DA63                     RTCREAD:
000D6A DA63 0EF9             7      LD  C,0F9H
000D6C DA65 3AB9EF          13      LD  A,(WK40)
000D6F DA68 5F               4      LD  E,A
000D70 DA69 3E03             7      LD  A,3     ;コマンド３：タイムリードにセット
000D72 DA6B CD95DA          17      CALL    RTCCMD
000D75 DA6E 3E01             7      LD  A,1     ;コマンド１：レジスタシフトにセット
000D77 DA70 CD95DA          17      CALL    RTCCMD
000D7A DA73 0606             7      LD  B,6
000D7C DA75 2167EF          10      LD  HL,RTC_SS
       DA78                     RTCREAD1:
000D7F DA78 C5              11      PUSH    BC
000D80 DA79 0608             7      LD  B,8
       DA7B                     RTCREAD2:
000D82 DA7B DB40            11      IN  A,(40H)     ;システムモードセンス BIT4:CDI
000D84 DA7D 87               4      ADD A,A
000D85 DA7E 87               4      ADD A,A
000D86 DA7F 87               4      ADD A,A
000D87 DA80 87               4      ADD A,A
000D88 DA81 CB1E            15      RR  (HL)
000D8A DA83 CDBADA          17      CALL    RTCCLK
000D8D DA86 10F3            13      DJNZ    RTCREAD2
000D8F DA88 C1              10      POP BC
000D90 DA89 2B               6      DEC HL
000D91 DA8A 10EC            13      DJNZ    RTCREAD1
000D93 DA8C AF               4      XOR A
000D94 DA8D CD95DA          17      CALL    RTCCMD
000D97 DA90 7B               4      LD  A,E
000D98 DA91 32B9EF          13      LD  (WK40),A
000D9B DA94 C9              10      RET
                                
       DA95                     RTCCMD:
000D9C DA95 0604             7      LD  B,4
000D9E DA97 07               4      RLCA
000D9F DA98 07               4      RLCA
000DA0 DA99 07               4      RLCA
       DA9A                     RTCCMD1:
000DA1 DA9A F5              11      PUSH    AF
000DA2 DA9B F607             7      OR  7
000DA4 DA9D D310            11      OUT (10H),A     ;プリンタデータ出力 兼 カレンダクロック(μPD1990AC)出力
000DA6 DA9F CDBADA          17      CALL    RTCCLK
000DA9 DAA2 F1              10      POP AF
000DAA DAA3 0F               4      RRCA
000DAB DAA4 10F4            13      DJNZ    RTCCMD1
000DAD DAA6 3E07             7      LD  A,7
000DAF DAA8 D310            11      OUT (10H),A     ;プリンタデータ出力 兼 カレンダクロック(μPD1990AC)出力
000DB1 DAAA 7B               4      LD  A,E
000DB2 DAAB A1               4      AND C
000DB3 DAAC F602             7      OR  2
000DB5 DAAE D340            11      OUT (40H),A     ;ストローブポート
000DB7 DAB0 A1               4      AND C
000DB8 DAB1 00               4      NOP
000DB9 DAB2 D340            11      OUT (40H),A     ;ストローブポート
000DBB DAB4 5F               4      LD  E,A
000DBC DAB5 060D             7      LD  B,13
       DAB7                     RTCCMD3:
000DBE DAB7 10FE            13      DJNZ    RTCCMD3
000DC0 DAB9 C9              10      RET
                                
       DABA                     RTCCLK:
000DC1 DABA 7B               4      LD  A,E
000DC2 DABB A1               4      AND C
000DC3 DABC F604             7      OR  04H
000DC5 DABE D340            11      OUT (40H),A
000DC7 DAC0 A1               4      AND C
000DC8 DAC1 00               4      NOP
000DC9 DAC2 D340            11      OUT (40H),A
000DCB DAC4 5F               4      LD  E,A
000DCC DAC5 C9              10      RET
                                
                                ;------------------------
                                ;BCDの10進数化
                                ;in
                                ;   A  : BCD
                                ;out
                                ;   A  : 10進数
                                ;------------------------
       DAC6                     BCD:
000DCD DAC6 4F               4      LD  C,A
000DCE DAC7 E6F0             7      AND 0F0H    ;10の位
000DD0 DAC9 0F               4      RRCA
000DD1 DACA 47               4      LD  B,A
000DD2 DACB 0F               4      RRCA
000DD3 DACC 0F               4      RRCA
000DD4 DACD 80               4      ADD A,B
000DD5 DACE 47               4      LD  B,A
000DD6 DACF 79               4      LD  A,C
000DD7 DAD0 E60F             7      AND 00FH    ;1の位
000DD9 DAD2 80               4      ADD A,B
000DDA DAD3 C9              10      RET
                                
       DAD4                     ESC1:
000DDB DAD4 7B               4      LD  A,E
000DDC DAD5 FE41             7      CP  'A'
000DDE DAD7 CAB9DB          10      JP  Z,CTRL1E
000DE1 DADA FE42             7      CP  'B'
000DE3 DADC CAD8DC          10      JP  Z,CTRL1F
000DE6 DADF FE43             7      CP  'C'
000DE8 DAE1 CA7FDB          10      JP  Z,CTRL1C
000DEB DAE4 FE44             7      CP  'D'
000DED DAE6 CAA4DB          10      JP  Z,CTRL1D
000DF0 DAE9 FE45             7      CP  'E'
000DF2 DAEB 2802            12      JR  Z,CT0CX
000DF4 DAED FE6A             7      CP  'j'
       DAEF                     CT0CX:
000DF6 DAEF CAA5DC          10      JP  Z,CTRL0C
000DF9 DAF2 FE48             7      CP  'H'
000DFB DAF4 CA24DC          10      JP  Z,CTRL0B
000DFE DAF7 FE4A             7      CP  'J'
000E00 DAF9 CAA8DC          10      JP  Z,CTRL06
000E03 DAFC FE4B             7      CP  'K'
000E05 DAFE CAF8DB          10      JP  Z,CTRL05
000E08 DB01 FE4C             7      CP  'L'
000E0A DB03 CADFDC          10      JP  Z,CTRL0E
000E0D DB06 FE54             7      CP  'T'
000E0F DB08 CAF8DB          10      JP  Z,CTRL05
000E12 DB0B FE78             7      CP  'x'
000E14 DB0D 2804            12      JR  Z,ESC1X
000E16 DB0F FE79             7      CP  'y'
000E18 DB11 2002            12      JR  NZ,ESC1Y
       DB13                     ESC1X:
000E1A DB13 3601            10      LD  (HL),1
       DB15                     ESC1Y:
000E1C DB15 FE3D             7      CP  '='
000E1E DB17 2804            12      JR  Z,ESC1W
000E20 DB19 FE59             7      CP  'Y'
000E22 DB1B 2002            12      JR  NZ,ESC1Z
       DB1D                     ESC1W:
000E24 DB1D 3602            10      LD  (HL),2
       DB1F                     ESC1Z:
000E26 DB1F FE20             7      CP  020H
000E28 DB21 3802            12      JR  C,ESC1C
000E2A DB23 87               4      ADD A,A
000E2B DB24 D0              11      RET NC
       DB25                     ESC1C:
000E2C DB25 E1              10      POP HL
000E2D DB26 1832            12      JR  ANK
                                
       DB28                     ESC:
000E2F DB28 216BDB          10      LD  HL,PRINTE5
000E32 DB2B E5              11      PUSH    HL
000E33 DB2C 214EDB          10      LD  HL,ESCFLG
000E36 DB2F 3600            10      LD  (HL),0
000E38 DB31 3D               4      DEC A
000E39 DB32 28A0            12      JR  Z,ESC1
000E3B DB34 3D               4      DEC A
000E3C DB35 2009            12      JR  NZ,ESC2
000E3E DB37 3603            10      LD  (HL),3
000E40 DB39 7B               4      LD  A,E
000E41 DB3A D620             7      SUB 020H
000E43 DB3C 3243DB          13      LD  (ESCYP+1),A
000E46 DB3F C9              10      RET
       DB40                     ESC2:
000E47 DB40 3D               4      DEC A
000E48 DB41 C0              11      RET NZ
000E49 DB42 2600             7  ESCYP:  LD  H,0
000E4B DB44 7B               4      LD  A,E
000E4C DB45 D620             7      SUB 020H
000E4E DB47 6F               4      LD  L,A
000E4F DB48 C3D6EF          10      JP  _LOC
                                
       DB4B                     PRINT:
000E52 DB4B C5              11      PUSH    BC
000E53 DB4C E5              11      PUSH    HL
       DB4E                     ESCFLG  EQU $+1
000E54 DB4D 3E00             7      LD  A,000H      ;自己書き換え
000E56 DB4F B7               4      OR  A
000E57 DB50 20D6            12      JR  NZ,ESC
                                
000E59 DB52 3E1F             7      LD  A,01FH
000E5B DB54 BB               4      CP  E
000E5C DB55 3018            12      JR  NC,CTRL
       DB57                     INSFLG  EQU $
000E5E DB57 0187DC          10      LD  BC,INSERT   ;自己書き換え
       DB5A                     ANK:
000E61 DB5A CD31DC          17      CALL    LOC0
000E64 DB5D DB32            11      IN  A,(032H)
000E66 DB5F F5              11      PUSH    AF
000E67 DB60 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000E69 DB62 D332            11      OUT (032H),A
000E6B DB64 73               7      LD  (HL),E
000E6C DB65 F1              10      POP AF
000E6D DB66 D332            11      OUT (032H),A
000E6F DB68 CD7FDB          17      CALL    CTRL1C
       DB6B                     PRINTE5:
000E72 DB6B E1              10      POP HL
000E73 DB6C C1              10      POP BC
000E74 DB6D AF               4      XOR A
000E75 DB6E C9              10      RET
                                
       DB6F                     CTRL:
000E76 DB6F 7B               4      LD  A,E
000E77 DB70 87               4      ADD A,A
000E78 DB71 F680             7      OR  080H
000E7A DB73 6F               4      LD  L,A
000E7B DB74 26F0             7      LD  H,CTRLTB/256
000E7D DB76 7E               7      LD  A,(HL)
000E7E DB77 2C               4      INC L
000E7F DB78 66               7      LD  H,(HL)
000E80 DB79 6F               4      LD  L,A
000E81 DB7A CD0F00          17      CALL    JP_HL
000E84 DB7D 18EC            12      JR  PRINTE5
                                
       DB7F                     CTRL1C:
000E86 DB7F 2A8EEF          16      LD  HL,(_TXADR)
000E89 DB82 2C               4      INC L
       DB83                     PRINTE3:
000E8A DB83 3AB1EF          13      LD  A,(_WIDTH)
000E8D DB86 3D               4      DEC A
000E8E DB87 BD               4      CP  L
000E8F DB88 3009            12      JR  NC,SET_TXADR_HL
000E91 DB8A 2E00             7      LD  L,0
000E93 DB8C 24               4      INC H
       DB8D                     PRINTE8:
000E94 DB8D 3A97EF          13      LD  A,(_LINE)
000E97 DB90 BC               4      CP  H
000E98 DB91 2804            12      JR  Z,PRINT2
       DB93                     LOC:
       DB93                     SET_TXADR_HL:
000E9A DB93 228EEF          16      LD  (_TXADR),HL
       DB96                     CTRL00:
000E9D DB96 C9              10      RET
                                
       DB97                     PRINT2:
000E9E DB97 CDE5DC          17      CALL    SCR
000EA1 DB9A 25               4      DEC H
000EA2 DB9B 18F6            12      JR  SET_TXADR_HL
                                
       DB9D                     CTRL08:
000EA4 DB9D 3A57DB          13      LD  A,(INSFLG)
000EA7 DBA0 FECD             7      CP  0CDH        ;CALL ????
000EA9 DBA2 2829            12      JR  Z,CTRL02
       DBA4                     CTRL1D:
000EAB DBA4 2A8EEF          16      LD  HL,(_TXADR)
000EAE DBA7 7C               4      LD  A,H
000EAF DBA8 B5               4      OR  L
000EB0 DBA9 C8              11      RET Z
000EB1 DBAA 7D               4      LD  A,L
000EB2 DBAB B7               4      OR  A
000EB3 DBAC 2803            12      JR  Z,CTRL1DX1
000EB5 DBAE 2D               4      DEC L
000EB6 DBAF 18E2            12      JR  SET_TXADR_HL
       DBB1                     CTRL1DX1:
000EB8 DBB1 3AB1EF          13      LD  A,(_WIDTH)
000EBB DBB4 3D               4      DEC A
000EBC DBB5 6F               4      LD  L,A
000EBD DBB6 25               4      DEC H
000EBE DBB7 18DA            12      JR  SET_TXADR_HL
       DBB9                     CTRL1E:
000EC0 DBB9 2A8EEF          16      LD  HL,(_TXADR)
000EC3 DBBC 7C               4      LD  A,H
000EC4 DBBD B7               4      OR  A
000EC5 DBBE C8              11      RET Z
000EC6 DBBF 25               4      DEC H
000EC7 DBC0 18D1            12      JR  SET_TXADR_HL
                                
       DBC2                     CTRL09:
000EC9 DBC2 2A8EEF          16      LD  HL,(_TXADR)
000ECC DBC5 7D               4      LD  A,L
000ECD DBC6 E6F8             7      AND 0F8H
000ECF DBC8 C608             7      ADD A,8
000ED1 DBCA 6F               4      LD  L,A
000ED2 DBCB 18B6            12      JR  PRINTE3
                                
       DBCD                     CTRL02:
000ED4 DBCD 3A8EEF          13      LD  A,(_TXADR)
000ED7 DBD0 B7               4      OR  A
000ED8 DBD1 28D1            12      JR  Z,CTRL1D
000EDA DBD3 CDA4DB          17      CALL    CTRL1D
000EDD DBD6 2A8EEF          16      LD  HL,(_TXADR)
000EE0 DBD9 3AB1EF          13      LD  A,(_WIDTH)
000EE3 DBDC 4F               4      LD  C,A
000EE4 DBDD 95               4      SUB L
000EE5 DBDE 47               4      LD  B,A
000EE6 DBDF 79               4      LD  A,C
000EE7 DBE0 3D               4      DEC A
000EE8 DBE1 6F               4      LD  L,A
000EE9 DBE2 CD34DC          17      CALL    LOC1
                                
000EEC DBE5 DB32            11      IN  A,(032H)
000EEE DBE7 F5              11      PUSH    AF
000EEF DBE8 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000EF1 DBEA D332            11      OUT (032H),A
                                
000EF3 DBEC 3E20             7      LD  A,020H
       DBEE                     C8X1:
000EF5 DBEE 4E               7      LD  C,(HL)
000EF6 DBEF 77               7      LD  (HL),A
000EF7 DBF0 2B               6      DEC HL
000EF8 DBF1 79               4      LD  A,C
000EF9 DBF2 10FA            13      DJNZ    C8X1
                                
000EFB DBF4 F1              10      POP AF
000EFC DBF5 D332            11      OUT (032H),A
000EFE DBF7 C9              10      RET
                                
       DBF8                     CTRL05:
000EFF DBF8 CDD3EF          17      CALL    _POS
000F02 DBFB 2A8EEF          16      LD  HL,(_TXADR)
000F05 DBFE 3AB1EF          13      LD  A,(_WIDTH)
000F08 DC01 95               4      SUB L
000F09 DC02 47               4      LD  B,A
000F0A DC03 CD31DC          17      CALL    LOC0
       DC06                     CLLINE:
000F0D DC06 DB32            11      IN  A,(032H)
000F0F DC08 F5              11      PUSH    AF
000F10 DC09 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000F12 DC0B D332            11      OUT (032H),A
000F14 DC0D 3E20             7      LD  A,020H
       DC0F                     CLLINE1:
000F16 DC0F 77               7      LD  (HL),A
000F17 DC10 23               6      INC HL
000F18 DC11 10FC            13      DJNZ    CLLINE1
                                
000F1A DC13 F1              10      POP AF
000F1B DC14 D332            11      OUT (032H),A
000F1D DC16 C9              10      RET
                                
       DC17                     CTRL0D:
000F1E DC17 AF               4      XOR A
000F1F DC18 328EEF          13      LD  (_TXADR),A
000F22 DC1B C9              10      RET
                                
       DC1C                     CTRL12:
000F23 DC1C 2157DB          10      LD  HL,INSFLG
000F26 DC1F 7E               7      LD  A,(HL)
000F27 DC20 EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000F29 DC22 77               7      LD  (HL),A
000F2A DC23 C9              10      RET
                                
       DC24                     CTRL0B:
000F2B DC24 210000          10      LD  HL,0
000F2E DC27 228EEF          16      LD  (_TXADR),HL
000F31 DC2A C9              10      RET
                                
       DC2B                     CTRL1B:
000F32 DC2B 3E01             7      LD  A,1
000F34 DC2D 324EDB          13      LD  (ESCFLG),A
000F37 DC30 C9              10      RET
       DC31                     LOC0:
000F38 DC31 2A8EEF          16      LD  HL,(_TXADR)
       DC34                     LOC1:
000F3B DC34 D5              11      PUSH    DE
000F3C DC35 E5              11      PUSH    HL
000F3D DC36 6C               4      LD  L,H ;Y
000F3E DC37 5C               4      LD  E,H
000F3F DC38 2600             7      LD  H,0
000F41 DC3A 54               4      LD  D,H
000F42 DC3B 29              11      ADD HL,HL   ;*2
000F43 DC3C 29              11      ADD HL,HL   ;*4
000F44 DC3D 29              11      ADD HL,HL   ;*8
000F45 DC3E 29              11      ADD HL,HL   ;*16
000F46 DC3F ED52            15      SBC HL,DE   ;*15
000F48 DC41 29              11      ADD HL,HL   ;*30
000F49 DC42 29              11      ADD HL,HL   ;*60
000F4A DC43 29              11      ADD HL,HL   ;*120
000F4B DC44 D1              10      POP DE
000F4C DC45 1600             7      LD  D,0
000F4E DC47 19              11      ADD HL,DE   ;X
000F4F DC48 ED5BB2EF        20      LD  DE,(TVRAMTOP)
000F53 DC4C 19              11      ADD HL,DE
000F54 DC4D D1              10      POP DE
000F55 DC4E C9              10      RET
                                
       DC4F                     CONOUT1:
000F56 DC4F 59               4      LD  E,C
000F57 DC50 CDCDEF          17      CALL    _PRINT
000F5A DC53 7B               4      LD  A,E
000F5B DC54 FE0A             7      CP  00AH
000F5D DC56 2006            12      JR  NZ,CURSOR_ON
000F5F DC58 CD17DC          17      CALL    CTRL0D
000F62 DC5B CDF8DB          17      CALL    CTRL05
       DC5E                     CURSOR_ON:
000F65 DC5E F5              11      PUSH    AF
000F66 DC5F 3E81             7      LD  A,081H
       DC61                     CURSOR0:
000F68 DC61 D351            11      OUT (051H),A
000F6A DC63 3A8EEF          13      LD  A,(_TXADR)
000F6D DC66 D350            11      OUT (050H),A
000F6F DC68 3A8FEF          13      LD  A,(_TXADR+1)
000F72 DC6B D350            11      OUT (050H),A
000F74 DC6D F1              10      POP AF
000F75 DC6E C9              10      RET
       DC6F                     CURSOR_OFF:
000F76 DC6F F5              11      PUSH    AF
000F77 DC70 3E80             7      LD  A,080H
000F79 DC72 18ED            12      JR  CURSOR0
                                
       DC74                     CTRL07:
000F7B DC74 3AB9EF          13      LD  A,(WK40)
000F7E DC77 F5              11      PUSH    AF
000F7F DC78 F620             7      OR  20H
000F81 DC7A D340            11      OUT (040H),A
000F83 DC7C 0610             7      LD  B,16
       DC7E                     C07X1:
000F85 DC7E CDF1DD          17      CALL    VBLANK
000F88 DC81 10FB            13      DJNZ    C07X1
000F8A DC83 F1              10      POP AF
000F8B DC84 D340            11      OUT (040H),A
000F8D DC86 C9              10      RET
                                
       DC87                     INSERT:
000F8E DC87 2A8EEF          16      LD  HL,(_TXADR)
000F91 DC8A 3AB1EF          13      LD  A,(_WIDTH)
000F94 DC8D 95               4      SUB L
000F95 DC8E 47               4      LD  B,A
                                
000F96 DC8F CD31DC          17      CALL    LOC0
                                
000F99 DC92 DB32            11      IN  A,(032H)
000F9B DC94 F5              11      PUSH    AF
000F9C DC95 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000F9E DC97 D332            11      OUT (032H),A
                                
000FA0 DC99 3E20             7      LD  A,020H
       DC9B                     INS1:
000FA2 DC9B 4E               7      LD  C,(HL)
000FA3 DC9C 77               7      LD  (HL),A
000FA4 DC9D 79               4      LD  A,C
000FA5 DC9E 23               6      INC HL
000FA6 DC9F 10FA            13      DJNZ    INS1
                                
000FA8 DCA1 F1              10      POP AF
000FA9 DCA2 D332            11      OUT (032H),A
000FAB DCA4 C9              10      RET
                                
       DCA5                     CTRL0C:
000FAC DCA5 CD24DC          17      CALL    CTRL0B
       DCA8                     CTRL06:
000FAF DCA8 2A8EEF          16      LD  HL,(_TXADR)
       DCAB                     CLS1:
000FB2 DCAB DB32            11      IN  A,(032H)
000FB4 DCAD F5              11      PUSH    AF
000FB5 DCAE E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000FB7 DCB0 D332            11      OUT (032H),A
       DCB2                     CLS2:
000FB9 DCB2 E5              11      PUSH    HL
000FBA DCB3 3AB1EF          13      LD  A,(_WIDTH)
000FBD DCB6 95               4      SUB L
000FBE DCB7 47               4      LD  B,A
000FBF DCB8 CD34DC          17      CALL    LOC1
000FC2 DCBB 3E20             7      LD  A,020H
       DCBD                     CLS3:
000FC4 DCBD 77               7      LD  (HL),A
000FC5 DCBE 23               6      INC HL
000FC6 DCBF 10FC            13      DJNZ    CLS3
000FC8 DCC1 E1              10      POP HL
000FC9 DCC2 2E00             7      LD  L,0
000FCB DCC4 24               4      INC H
000FCC DCC5 3A97EF          13      LD  A,(_LINE)
000FCF DCC8 BC               4      CP  H
000FD0 DCC9 20E7            12      JR  NZ,CLS2
000FD2 DCCB F1              10      POP AF
000FD3 DCCC D332            11      OUT (032H),A
000FD5 DCCE C9              10      RET
                                
       DCCF                     CTRL04:
000FD6 DCCF CDD3EF          17      CALL    _POS
000FD9 DCD2 7D               4      LD  A,L
000FDA DCD3 B7               4      OR  A
000FDB DCD4 C8              11      RET Z
       DCD5                     CTRL03:
000FDC DCD5 CD17DC          17      CALL    CTRL0D
       DCD8                     CTRL0A:
       DCD8                     CTRL1F:
000FDF DCD8 2A8EEF          16      LD  HL,(_TXADR)
000FE2 DCDB 24               4      INC H
000FE3 DCDC C38DDB          10      JP  PRINTE8
                                
       DCDF                     CTRL0E:
000FE6 DCDF CDD3EF          17      CALL    _POS
000FE9 DCE2 7C               4      LD  A,H
000FEA DCE3 1804            12      JR  SCR1
       DCE5                     SCR:
000FEC DCE5 3A97EF          13      LD  A,(_LINE)
000FEF DCE8 3D               4      DEC A
       DCE9                     SCR1:
000FF0 DCE9 C5              11      PUSH    BC
000FF1 DCEA D5              11      PUSH    DE
000FF2 DCEB E5              11      PUSH    HL
000FF3 DCEC F5              11      PUSH    AF
000FF4 DCED 210000          10      LD  HL,0
000FF7 DCF0 CD34DC          17      CALL    LOC1
000FFA DCF3 EB               4      EX  DE,HL
000FFB DCF4 210001          10      LD  HL,0100H
000FFE DCF7 CD34DC          17      CALL    LOC1
001001 DCFA C1              10      POP BC
001002 DCFB DB32            11      IN  A,(032H)
001004 DCFD F5              11      PUSH    AF
001005 DCFE E6EF             7      AND 0EFH        ;高速RAMアクセスモード
001007 DD00 D332            11      OUT (032H),A
001009 DD02 78               4      LD  A,B
00100A DD03 B7               4      OR  A
       DD04                     SCRUP1:
00100B DD04 2815            12      JR  Z,SCRCL
00100D DD06 E5              11      PUSH    HL
00100E DD07 D5              11      PUSH    DE
00100F DD08 0608             7      LD  B,8
001011 DD0A 5F               4      LD  E,A
001012 DD0B 210078          10      LD  HL,120*256
001015 DD0E 55               4      LD  D,L
       DD0F                     SCRH2:
001016 DD0F 29              11      ADD HL,HL
001017 DD10 3001            12      JR  NC,SCRH3
001019 DD12 19              11      ADD HL,DE
       DD13                     SCRH3:
00101A DD13 10FA            13      DJNZ    SCRH2
00101C DD15 4D               4      LD  C,L
00101D DD16 44               4      LD  B,H
00101E DD17 D1              10      POP DE
00101F DD18 E1              10      POP HL
001020 DD19 EDB0                    LDIR
                                
       DD1B                     SCRCL:
001022 DD1B F1              10      POP AF
001023 DD1C D332            11      OUT (032H),A
                                
001025 DD1E 3AB1EF          13      LD  A,(_WIDTH)
001028 DD21 47               4      LD  B,A
001029 DD22 EB               4      EX  DE,HL
00102A DD23 CD06DC          17      CALL    CLLINE
00102D DD26 E1              10      POP HL
00102E DD27 D1              10      POP DE
00102F DD28 C1              10      POP BC
001030 DD29 C9              10      RET
       DD2A                     POS:
001031 DD2A 2A8EEF          16      LD  HL,(_TXADR)
001034 DD2D C9              10      RET
                                
       DD2E                     GETL:
001035 DD2E CDD3EF          17      CALL    _POS
001038 DD31 E5              11      PUSH    HL
001039 DD32 3ECD             7      LD  A,0CDH      ;CALL ????
00103B DD34 3257DB          13      LD  (INSFLG),A
       DD37                     GETL1:
00103E DD37 CDB9D9          17      CALL    _SYS08
001041 DD3A FE09             7      CP  9
001043 DD3C 2008            12      JR  NZ,GETL1V
001045 DD3E 2120FF          10      LD  HL,KBUF
001048 DD41 CDAAD6          17      CALL    MSX
00104B DD44 18F1            12      JR  GETL1
       DD46                     GETL1V:
00104D DD46 5F               4      LD  E,A
00104E DD47 CDCDEF          17      CALL    _PRINT
                                
001051 DD4A 7B               4      LD  A,E
001052 DD4B FE0D             7      CP  00DH
001054 DD4D 20E8            12      JR  NZ,GETL1
001056 DD4F 3E01             7      LD  A,1     ;LD BC,????
001058 DD51 3257DB          13      LD  (INSFLG),A
00105B DD54 1120FF          10      LD  DE,KBUF
00105E DD57 3AB1EF          13      LD  A,(_WIDTH)
001061 DD5A 47               4      LD  B,A
001062 DD5B CDBDD4          17      CALL    ZERO_MEMORY_DE
                                
001065 DD5E D1              10      POP DE
001066 DD5F CDD3EF          17      CALL    _POS
001069 DD62 6B               4      LD  L,E
00106A DD63 3AB1EF          13      LD  A,(_WIDTH)
00106D DD66 95               4      SUB L
00106E DD67 57               4      LD  D,A
00106F DD68 CD34DC          17      CALL    LOC1
001072 DD6B 4D               4      LD  C,L
001073 DD6C 7C               4      LD  A,H
001074 DD6D F630             7      OR  030H
001076 DD6F 47               4      LD  B,A
001077 DD70 5A               4      LD  E,D
001078 DD71 2120FF          10      LD  HL,KBUF
       DD74                     GETL2:
00107B DD74 CDD0EF          17      CALL    _SCRN
00107E DD77 03               6      INC BC
00107F DD78 77               7      LD  (HL),A
001080 DD79 23               6      INC HL
001081 DD7A 1D               4      DEC E
001082 DD7B 20F7            12      JR  NZ,GETL2
       DD7D                     GETL3:
001084 DD7D 2B               6      DEC HL
001085 DD7E 7E               7      LD  A,(HL)
001086 DD7F FE21             7      CP  021H
001088 DD81 D0              11      RET NC
001089 DD82 3600            10      LD  (HL),0
00108B DD84 15               4      DEC D
00108C DD85 20F6            12      JR  NZ,GETL3
00108E DD87 C9              10      RET
                                
       DD88                     INKEY:
00108F DD88 FB               4      EI
001090 DD89 E5              11      PUSH    HL
001091 DD8A 2A90EF          16      LD  HL,(_KEYPS)
001094 DD8D 7C               4      LD  A,H
001095 DD8E AD               4      XOR L
001096 DD8F 280B            12      JR  Z,INKEY1
001098 DD91 7C               4      LD  A,H
001099 DD92 3C               4      INC A
00109A DD93 E61F             7      AND 01FH
00109C DD95 3291EF          13      LD  (_KEYPS+1),A
00109F DD98 6F               4      LD  L,A
0010A0 DD99 26FF             7      LD  H,KEYBF/256
0010A2 DD9B 7E               7      LD  A,(HL)
       DD9C                     INKEY1:
0010A3 DD9C E1              10      POP HL
0010A4 DD9D B7               4      OR  A
0010A5 DD9E C9              10      RET
                                
       DD9F                     CHKEY:
0010A6 DD9F C5              11      PUSH    BC
0010A7 DDA0 DB08            11      IN  A,(8)       ;6:SHIFT,7:CTRL
0010A9 DDA2 4F               4      LD  C,A
0010AA DDA3 3A0E00          13      LD  A,(00EH)
0010AD DDA6 CB5F             8      BIT 3,A
0010AF DDA8 2002            12      JR  NZ,CHKEYRSHIFT
0010B1 DDAA CBB1             8      RES 6,C
       DDAC                     CHKEYRSHIFT:
0010B3 DDAC 79               4      LD  A,C
0010B4 DDAD 3293EF          13      LD  (_KEYD+1),A
0010B7 DDB0 E5              11      PUSH    HL
0010B8 DDB1 0E00             7      LD  C,0
0010BA DDB3 2198F1          10      LD  HL,KEY_TABLE
0010BD DDB6 CB77             8      BIT 6,A
0010BF DDB8 2003            12      JR  NZ,CHKEY0
0010C1 DDBA 212EEE          10      LD  HL,SHIFT_TABLE
       DDBD                     CHKEY0:
0010C4 DDBD CB7F             8      BIT 7,A
0010C6 DDBF 2003            12      JR  NZ,CHKEY1
0010C8 DDC1 2196EE          10      LD  HL,CTRL_TABLE
       DDC4                     CHKEY1:
0010CB DDC4 ED78            12      IN  A,(C)
0010CD DDC6 0608             7      LD  B,8
       DDC8                     CHKEY2:
0010CF DDC8 0F               4      RRCA
0010D0 DDC9 300B            12      JR  NC,CHKEY4
       DDCB                     CHKEY3:
0010D2 DDCB 23               6      INC HL
0010D3 DDCC 10FA            13      DJNZ    CHKEY2
0010D5 DDCE 0C               4      INC C
0010D6 DDCF 79               4      LD  A,C
0010D7 DDD0 D60D             7      SUB 00DH
0010D9 DDD2 20F0            12      JR  NZ,CHKEY1
0010DB DDD4 1804            12      JR  CHKEY5
       DDD6                     CHKEY4:
0010DD DDD6 7E               7      LD  A,(HL)
0010DE DDD7 B7               4      OR  A
0010DF DDD8 28F1            12      JR  Z,CHKEY3
       DDDA                     CHKEY5:
0010E1 DDDA E1              10      POP HL
0010E2 DDDB C1              10      POP BC
0010E3 DDDC B7               4      OR  A
0010E4 DDDD 3292EF          13      LD  (_KEYD),A
0010E7 DDE0 C9              10      RET
                                
       DDE1                     SCRN:
0010E8 DDE1 E5              11      PUSH    HL
0010E9 DDE2 DB32            11      IN  A,(032H)
0010EB DDE4 67               4      LD  H,A
0010EC DDE5 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
0010EE DDE7 D332            11      OUT (032H),A
0010F0 DDE9 0A               7      LD  A,(BC)
0010F1 DDEA 6F               4      LD  L,A
0010F2 DDEB 7C               4      LD  A,H
0010F3 DDEC D332            11      OUT (032H),A
0010F5 DDEE 7D               4      LD  A,L
0010F6 DDEF E1              10      POP HL
0010F7 DDF0 C9              10      RET
                                
       DDF1                     VBLANK:
0010F8 DDF1 F5              11      PUSH    AF
       DDF2                     VBLANK0:
0010F9 DDF2 DB40            11      IN  A,(040H)
0010FB DDF4 E620             7      AND 020H
0010FD DDF6 20FA            12      JR  NZ,VBLANK0
       DDF8                     VBLANK1:
0010FF DDF8 DB40            11      IN  A,(040H)
001101 DDFA E620             7      AND 020H
001103 DDFC 28FA            12      JR  Z,VBLANK1
001105 DDFE F1              10      POP AF
001106 DDFF C9              10      RET
                                
       DE00                     INIT_CRTC:
001107 DE00 3E03             7      LD  A,3     ;80桁
001109 DE02 D330            11      OUT (030H),A
00110B DE04 32BEEF          13      LD  (WK30),A
                                
00110E DE07 3E22             7      LD  A,022H      ;25行 64K RAM
001110 DE09 D331            11      OUT (031H),A
001112 DE0B 32BFEF          13      LD  (WK31),A
                                
001115 DE0E 3EFF             7      LD  A,0FFH
001117 DE10 D3E4            11      OUT (0E4H),A    ;割り込みレベル設定
001119 DE12 32B7EF          13      LD  (WKE4),A
00111C DE15 3E00             7      LD  A,0
00111E DE17 D3E6            11      OUT (0E6H),A    ;割り込みマスク
                                
001120 DE19 3E19             7      LD  A,019H
001122 DE1B D340            11      OUT (040H),A    ;CRT I/F 同期ビットオン
001124 DE1D 32B9EF          13      LD  (WK40),A
001127 DE20 CDF1DD          17      CALL    VBLANK
                                
00112A DE23 AF               4      XOR A
00112B DE24 D351            11      OUT (051H),A    ;Reset CRTC
00112D DE26 3EA0             7      LD  A,0A0H
00112F DE28 D368            11      OUT (068H),A    ;DMAC: Mode Set(Reset)
001131 DE2A 21C8F3          10      LD  HL,0F3C8H
001134 DE2D 22B2EF          16      LD  (TVRAMTOP),HL
001137 DE30 0E64             7      LD  C,064H
001139 DE32 ED69            12      OUT (C),L       ;TVRAM LOW
00113B DE34 ED61            12      OUT (C),H       ;TVRAM HIGH
00113D DE36 21B78B          10      LD  HL,08000H+120*25-1
001140 DE39 0C               4      INC C       ;65H
001141 DE3A ED69            12      OUT (C),L
001143 DE3C ED61            12      OUT (C),H
001145 DE3E 3ECE             7      LD  A,080H+80-2
001147 DE40 D350            11      OUT (050H),A
001149 DE42 3E98             7      LD  A,080H+25-1
00114B DE44 D350            11      OUT (050H),A
00114D DE46 DB40            11      IN  A,(040H)
00114F DE48 CB4F             8      BIT 1,A
001151 DE4A 21DE67          10      LD  HL,067DEH
001154 DE4D 2003            12      JR  NZ,RESO1
001156 DE4F 21586F          10      LD  HL,06F58H
       DE52                     RESO1:
001159 DE52 0E50             7      LD  C,050H
00115B DE54 ED61            12      OUT (C),H
00115D DE56 ED69            12      OUT (C),L
                                
00115F DE58 3E53             7      LD  A,053H
001161 DE5A D350            11      OUT (050H),A
                                
001163 DE5C 3E43             7      LD  A,043H
001165 DE5E D351            11      OUT (051H),A
                                
001167 DE60 3EE4             7      LD  A,0E4H
001169 DE62 D368            11      OUT (068H),A
                                
00116B DE64 3E20             7      LD  A,020H
00116D DE66 D351            11      OUT (051H),A
                                
00116F DE68 CDF1DD          17      CALL    VBLANK
       DE6B                     IVBL1:
001172 DE6B DB40            11      IN  A,(040H)
001174 DE6D CB6F             8      BIT 5,A
001176 DE6F 20FA            12      JR  NZ,IVBL1
                                
001178 DE71 3E11             7      LD  A,011H
00117A DE73 D340            11      OUT (040H),A    ;CRT I/F 同期ビットオフ
00117C DE75 32B9EF          13      LD  (WK40),A
00117F DE78 C9              10      RET
                                
       DE79                     BIOS:
001180 DE79 F3               4      DI
001181 DE7A F5              11      PUSH    AF
001182 DE7B 3ABFEF          13      LD  A,(WK31)
001185 DE7E CB8F             8      RES 1,A
001187 DE80 D331            11      OUT (031H),A
001189 DE82 F1              10      POP AF
00118A DE83 CDB1E4          17      CALL    JP_BC
00118D DE86 F5              11      PUSH    AF
00118E DE87 3ABFEF          13      LD  A,(WK31)
001191 DE8A D331            11      OUT (031H),A
001193 DE8C F1              10      POP AF
001194 DE8D FB               4      EI
001195 DE8E C9              10      RET
[EOF:88IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
       DE8F                     FILEC:
001196 DE8F CD9ADE          17      CALL    FILE
       DE92                     FILEC2:
001199 DE92 3A15EF          13      LD  A,(FDRV+1)
00119C DE95 FE20             7      CP  020H
00119E DE97 C8              11      RET Z
00119F DE98 1839            12      JR  SETDIR1
                                
       DE9A                     FILE:
0011A1 DE9A AF               4      XOR A
0011A2 DE9B 3214EF          13      LD  (FDRV),A
0011A5 DE9E 67               4      LD  H,A
0011A6 DE9F 6F               4      LD  L,A
0011A7 DEA0 2222EF          16      LD  (FDRV+14),HL
0011AA DEA3 CD71DF          17      CALL    SPCUT
0011AD DEA6 CD56DF          17      CALL    CCHK3
0011B0 DEA9 2812            12      JR  Z,DEVI1
0011B2 DEAB 13               6      INC DE
0011B3 DEAC 1A               7      LD  A,(DE)
0011B4 DEAD 1B               6      DEC DE
0011B5 DEAE FE3A             7      CP  ':'
0011B7 DEB0 200B            12      JR  NZ,DEVI1
0011B9 DEB2 1A               7      LD  A,(DE)      ;DRIVE
0011BA DEB3 CDA6E1          17      CALL    CAP
0011BD DEB6 D640             7      SUB '@'
0011BF DEB8 13               6      INC DE
0011C0 DEB9 13               6      INC DE
0011C1 DEBA 3214EF          13      LD  (FDRV),A
       DEBD                     DEVI1:
0011C4 DEBD 1A               7      LD  A,(DE)
0011C5 DEBE D65C             7      SUB 05CH        ;\
0011C7 DEC0 2009            12      JR  NZ,NOROOT
0011C9 DEC2 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
0011CA DEC3 222EEF          16      LD  (FDRV+26),HL
0011CD DEC6 2C               4      INC L
0011CE DEC7 2222EF          16      LD  (FDRV+14),HL
0011D1 DECA 13               6      INC DE
       DECB                     NOROOT:
                                
       DECB                     SETDIR:
0011D2 DECB CDF7DE          17      CALL    FILED
0011D5 DECE 1A               7      LD  A,(DE)
0011D6 DECF FE5C             7      CP  05CH        ;\
0011D8 DED1 C0              11      RET NZ
0011D9 DED2 13               6      INC DE
       DED3                     SETDIR1:
0011DA DED3 3E10             7      LD  A,010H      ;Directory
0011DC DED5 3221EF          13      LD  (FDRV+13),A
0011DF DED8 D5              11      PUSH    DE
0011E0 DED9 1114EF          10      LD  DE,FDRV
0011E3 DEDC 2A1EF0          16      LD  HL,(STABLE+2*00FH)
0011E6 DEDF CD0F00          17      CALL    JP_HL
0011E9 DEE2 D1              10      POP DE
0011EA DEE3 B7               4      OR  A
0011EB DEE4 C0              11      RET NZ
                                
0011EC DEE5 3A21EF          13      LD  A,(FDRV+13)
0011EF DEE8 CB67             8      BIT 4,A
0011F1 DEEA C8              11      RET Z
                                
0011F2 DEEB CD3EDF          17      CALL    FILEI
0011F5 DEEE 2A2EEF          16      LD  HL,(FDRV+26)
0011F8 DEF1 23               6      INC HL
0011F9 DEF2 2222EF          16      LD  (FDRV+14),HL
0011FC DEF5 18D4            12      JR  SETDIR
                                
       DEF7                     FILED:
0011FE DEF7 CD3EDF          17      CALL    FILEI
001201 DEFA 2115EF          10      LD  HL,FNAME
                                
001204 DEFD 0608             7      LD  B,8
       DEFF                     FILE2:
001206 DEFF CD4BDF          17      CALL    CCHKF
001209 DF02 C8              11      RET Z
00120A DF03 FE2A             7      CP  '*'
00120C DF05 282E            12      JR  Z,FILE9
00120E DF07 FE2E             7      CP  '.'
001210 DF09 280C            12      JR  Z,FILE4
001212 DF0B 77               7      LD  (HL),A
001213 DF0C 23               6      INC HL
001214 DF0D 10F0            13      DJNZ    FILE2
                                
       DF0F                     FILE3:
001216 DF0F CD4BDF          17      CALL    CCHKF
001219 DF12 C8              11      RET Z
00121A DF13 FE2E             7      CP  '.'
00121C DF15 20F8            12      JR  NZ,FILE3
                                
       DF17                     FILE4:
00121E DF17 211DEF          10      LD  HL,FNAME+8
001221 DF1A 0603             7      LD  B,3
                                
       DF1C                     FILE4L:
001223 DF1C CD4BDF          17      CALL    CCHKF
001226 DF1F C8              11      RET Z
001227 DF20 FE2E             7      CP  '.'
001229 DF22 2008            12      JR  NZ,FILE12
00122B DF24 3215EF          13      LD  (FNAME),A   ;Parent directory(..)
00122E DF27 3216EF          13      LD  (FNAME+1),A
001231 DF2A 3E20             7      LD  A,020H
       DF2C                     FILE12:
001233 DF2C FE2A             7      CP  '*'
001235 DF2E 280A            12      JR  Z,FILE10
001237 DF30 77               7      LD  (HL),A
001238 DF31 23               6      INC HL
001239 DF32 10E8            13      DJNZ    FILE4L
00123B DF34 C9              10      RET
                                
       DF35                     FILE9:              ;名前の*処理、名前の残りを?で埋める
00123C DF35 CD3ADF          17      CALL    FILE10
00123F DF38 18D5            12      JR  FILE3
                                
       DF3A                     FILE10:
001241 DF3A 3E3F             7      LD  A,'?'
001243 DF3C 1808            12      JR  FILL_MEMORY
       DF3E                     FILEI:              ;名前＋拡張子をスペースで初期化
001245 DF3E 3E20             7      LD  A,020H
001247 DF40 01000B          10      LD  BC,11*256   ;C=0にしておく
00124A DF43 2115EF          10      LD  HL,FNAME
       DF46                     FILL_MEMORY:            ;HLからBバイトAで埋める
00124D DF46 77               7      LD  (HL),A
00124E DF47 23               6      INC HL
00124F DF48 10FC            13      DJNZ    FILL_MEMORY
001251 DF4A C9              10      RET
                                
       DF4B                     CCHKF:
001252 DF4B 1A               7      LD  A,(DE)
001253 DF4C CD53DF          17      CALL    CCHK2
001256 DF4F C8              11      RET Z
001257 DF50 C3BEE2          10      JP  FKAN
                                
       DF53                     CCHK2:
00125A DF53 0C               4      INC C
00125B DF54 0D               4      DEC C
00125C DF55 C0              11      RET NZ
       DF56                     CCHK3:              ;ZF=1 で使えない文字
00125D DF56 FE2B             7      CP  '+'
00125F DF58 C8              11      RET Z
001260 DF59 FE2C             7      CP  ','
001262 DF5B C8              11      RET Z
001263 DF5C FE2F             7      CP  '/'
001265 DF5E C8              11      RET Z
001266 DF5F FE3A             7      CP  ':'
001268 DF61 C8              11      RET Z
001269 DF62 FE3B             7      CP  ';'
00126B DF64 C8              11      RET Z
00126C DF65 FE3D             7      CP  '='
00126E DF67 C8              11      RET Z
00126F DF68 FE5C             7      CP  05CH    ;\
001271 DF6A C8              11      RET Z
001272 DF6B FE20             7      CP  020H
001274 DF6D D0              11      RET NC
001275 DF6E BF               4      CP  A       ;Z=1
001276 DF6F C9              10      RET
                                
       DF70                     SS1:
001277 DF70 13               6      INC DE
       DF71                     SPCUT:              ;スペースをカット
001278 DF71 1A               7      LD  A,(DE)
001279 DF72 FE20             7      CP  020H
00127B DF74 28FA            12      JR  Z,SS1
00127D DF76 C9              10      RET
                                
       DF77                     SETDRVF:
00127E DF77 1114EF          10      LD  DE,FDRV
       DF7A                     SETDRV0:
001281 DF7A CD83DF          17      CALL    SETDRV
001284 DF7D FDE1            14      POP IY
001286 DF7F C1              10      POP BC
001287 DF80 D1              10      POP DE
001288 DF81 E1              10      POP HL
001289 DF82 C9              10      RET
                                
       DF83                     SETDRV:
00128A DF83 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
00128B DF84 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
00128C DF85 C5              11      PUSH    BC
00128D DF86 1A               7      LD  A,(DE)
00128E DF87 D5              11      PUSH    DE
00128F DF88 FDE3            23      EX  (SP),IY
                                
001291 DF8A CD96DF          17      CALL    GETDRV
001294 DF8D 3C               4      INC A
001295 DF8E FD7700          19      LD  (IY+0),A    ;(FCB)ドライブ番号
001298 DF91 3D               4      DEC A
001299 DF92 CDD9EF          17      CALL    _CHGDRV
                                
00129C DF95 E9               4      JP  (HL)
                                
       DF96                     GETDRV:
00129D DF96 E67F             7      AND 07FH
00129F DF98 D601             7      SUB 001H
0012A1 DF9A 3003            12      JR  NC,GETDRV1
0012A3 DF9C 3A87EF          13      LD  A,(_DVSW)   ;Current Drive
       DF9F                     GETDRV1:
0012A6 DF9F 3288EF          13      LD  (_DRV),A
0012A9 DFA2 C9              10      RET
                                
       DFA3                     SOPENX:
0012AA DFA3 1139EF          10      LD  DE,SFILE
0012AD DFA6 1A               7      LD  A,(DE)
0012AE DFA7 FDBE00           7      CP  (IY+0)      ;(FCB)ドライブ番号
0012B1 DFAA 2024            12      JR  NZ,SOPEN
0012B3 DFAC 13               6      INC DE
0012B4 DFAD FDE5            15      PUSH    IY
0012B6 DFAF E1              10      POP HL
0012B7 DFB0 23               6      INC HL
0012B8 DFB1 CD3EE1          17      CALL    CPFILE
0012BB DFB4 201A            12      JR  NZ,SOPEN
                                
0012BD DFB6 2AF4F0          16      LD  HL,(SCDIR)
0012C0 DFB9 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0012C3 DFBC FD740F          19      LD  (IY+15),H
                                
0012C6 DFBF 2AF8F0          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
0012C9 DFC2 229FEF          16      LD  (_FILEN),HL
                                
0012CC DFC5 ED5BF6F0        20      LD  DE,(SFBPS)
0012D0 DFC9 2139EF          10      LD  HL,SFILE
0012D3 DFCC 36FF            10      LD  (HL),0FFH
0012D5 DFCE 23               6      INC HL
0012D6 DFCF C9              10      RET
       DFD0                     SOPEN:
0012D7 DFD0 21E6E0          10      LD  HL,FILESE
       DFD3                     SOPENC:
0012DA DFD3 220CE0          16      LD  (OPENPAT+1),HL
                                
0012DD DFD6 CDE2EF          17      CALL    _RDFATX     ;Detect Media
0012E0 DFD9 3856            12      JR  C,RDDERR
                                
0012E2 DFDB AF               4      XOR A
0012E3 DFDC 329FEF          13      LD  (_FILEN),A
0012E6 DFDF CDEBE1          17      CALL    LDDIRX1     ;A=0で呼び出す
0012E9 DFE2 2818            12      JR  Z,SDIRX1
                                
0012EB DFE4 CDD7E0          17      CALL    READ_DIR    ;Sub Directory
0012EE DFE7 3808            12      JR  C,SDIRX0
0012F0 DFE9 2A7EF0          16      LD  HL,(_DTBUF)
0012F3 DFEC 7E               7      LD  A,(HL)
0012F4 DFED FE2E             7      CP  '.'
0012F6 DFEF 280F            12      JR  Z,SOPEN1
       DFF1                     SDIRX0:
0012F8 DFF1 AF               4      XOR A
0012F9 DFF2 32A0EF          13      LD  (_DIRF),A
0012FC DFF5 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
001300 DFF9 FD770F          19      LD  (IY+15),A
       DFFC                     SDIRX1:
001303 DFFC ED5BFCF0        20      LD  DE,(_DIRPS) ;Root Directory
       E000                     SOPEN1:
001307 E000 0E20             7  SDECPAT:LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       E002                     SOPEN1X:
001309 E002 CDD7E0          17      CALL    READ_DIR    ;FILE SEARCH
00130C E005 382A            12      JR  C,RDDERR
00130E E007 2A7EF0          16      LD  HL,(_DTBUF)
       E00A                     SOPEN2:
001311 E00A D5              11      PUSH    DE
001312 E00B CDE6E0          17  OPENPAT:CALL    FILESE      ;(self-modifying code)
001315 E00E D1              10      POP DE
001316 E00F 386E            12      JR  C,SOPENE
001318 E011 281B            12      JR  Z,SCF_FF_RET
       E013                     SOPEN3:
00131A E013 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
00131D E016 B7               4      OR  A
00131E E017 200C            12      JR  NZ,SOPEN5
001320 E019 13               6      INC DE      ;ルートディレクトリ
001321 E01A E5              11      PUSH    HL
001322 E01B 210C00          10  MD_PAT: LD  HL,12       ;(self-modifying code)MAXDIR
001325 E01E ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
001327 E020 E1              10      POP HL
001328 E021 20DD            12      JR  NZ,SOPEN1
00132A E023 1807            12      JR  SOPEN6
       E025                     SOPEN5:
00132C E025 CD00E9          17      CALL    GNCLX       ;END DIR
00132F E028 D8              11      RET C
001330 E029 CD9EE1          17      CALL    ENDCL
       E02C                     SOPEN6:
001333 E02C 38D2            12      JR  C,SOPEN1
       E02E                     SCF_FF_RET:
001335 E02E 37               4      SCF         ;CF=1
001336 E02F 9F               4      SBC A,A     ;A=0FFH
001337 E030 C9              10      RET
                                
       E031                     RDDERR:
001338 E031 BF               4      CP  A       ;READ ERR CF=1 ZF=1
001339 E032 37               4      SCF
00133A E033 C9              10      RET
                                
       E034                     NOPEN:
00133B E034 21E6E0          10      LD  HL,FILESE
00133E E037 220CE0          16      LD  (OPENPAT+1),HL
001341 E03A FD2A98EF        20      LD  IY,(_FCB)
001345 E03E CDD1E2          17      CALL    CHKWILDX
001348 E041 30EB            12      JR  NC,SCF_FF_RET
00134A E043 FD7E00          19      LD  A,(IY+0)    ;(FCB)ドライブ番号
00134D E046 3D               4      DEC A
00134E E047 3288EF          13      LD  (_DRV),A
001351 E04A CDD9EF          17      CALL    _CHGDRV
001354 E04D D8              11      RET C
001355 E04E 2AF8F0          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
001358 E051 229FEF          16      LD  (_FILEN),HL
                                
00135B E054 CDE6E1          17      CALL    LDDIRX
00135E E057 ED5B9AEF        20      LD  DE,(_FBPS)
001362 E05B CDD7E0          17      CALL    READ_DIR
001365 E05E 38D1            12      JR  C,RDDERR
001367 E060 3A9EEF          13      LD  A,(_FBCNT)
00136A E063 3D               4      DEC A
00136B E064 28AD            12      JR  Z,SOPEN3
       E066                     NOPEN2:
00136D E066 2A9CEF          16      LD  HL,(_FBAD)
001370 E069 012000          10      LD  BC,020H
001373 E06C 09              11      ADD HL,BC
001374 E06D 4F               4      LD  C,A
001375 E06E 189A            12      JR  SOPEN2
                                
       E070                     SOPENE2:
001377 E070 229CEF          16      LD  (_FBAD),HL
00137A E073 79               4      LD  A,C
00137B E074 329EEF          13      LD  (_FBCNT),A
00137E E077 ED539AEF        20      LD  (_FBPS),DE
001382 E07B FD2298EF        20      LD  (_FCB),IY
       E07F                     SOPENE:
001386 E07F AF               4      XOR A
001387 E080 C9              10      RET
                                
       E081                     COPEN:
001388 E081 FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
00138C E085 2103E1          10      LD  HL,NEXTSE
00138F E088 CDD3DF          17      CALL    SOPENC
001392 E08B D0              11      RET NC
001393 E08C C8              11      RET Z
001394 E08D 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
001397 E090 B7               4      OR  A
001398 E091 37               4      SCF
001399 E092 C8              11      RET Z       ;ルートディレクトリ
00139A E093 0601             7      LD  B,1
00139C E095 CD30E3          17      CALL    WRDF
00139F E098 D8              11      RET C
0013A0 E099 ED5BFEF0        20      LD  DE,(_CLPS)
0013A4 E09D D5              11      PUSH    DE
0013A5 E09E CD67E1          17      CALL    DCPAT
0013A8 E0A1 CD8BE7          17      CALL    DRDNX
0013AB E0A4 2A7EF0          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
0013AE E0A7 3A95E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
0013B1 E0AA 47               4      LD  B,A
0013B2 E0AB AF               4      XOR A
0013B3 E0AC 4F               4      LD  C,A
       E0AD                     COPENCL:
0013B4 E0AD 77               7      LD  (HL),A
0013B5 E0AE EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0013B7 E0B0 EAADE0          10      JP  PE,COPENCL
                                
0013BA E0B3 3A85E1          13      LD  A,(SPCPAT+1)    ;1クラスタの論理セクタ数
0013BD E0B6 3D               4      DEC A
0013BE E0B7 2819            12      JR  Z,COPENE
0013C0 E0B9 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
0013C2 E0BB 32F8E8          13      LD  (_SECPS+1),A
0013C5 E0BE D1              10      POP DE      ;DE=(_CLPS)
0013C6 E0BF D5              11      PUSH    DE
       E0C0                     COPEN1:
0013C7 E0C0 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
0013C8 E0C1 C5              11      PUSH    BC
0013C9 E0C2 2A7EF0          16      LD  HL,(_DTBUF)
0013CC E0C5 CD81E1          17      CALL    CLUSTX
0013CF E0C8 CD90EA          17      CALL    DWT24
0013D2 E0CB C1              10      POP BC
0013D3 E0CC D1              10      POP DE
0013D4 E0CD CDF7E8          17      CALL    NEXTX
0013D7 E0D0 20EE            12      JR  NZ,COPEN1
       E0D2                     COPENE:
0013D9 E0D2 2A7EF0          16      LD  HL,(_DTBUF)
0013DC E0D5 D1              10      POP DE
0013DD E0D6 C9              10      RET
                                
       E0D7                     READ_DIR:
0013DE E0D7 ED53FEF0        20      LD  (_CLPS),DE
0013E2 E0DB C5              11      PUSH    BC
0013E3 E0DC D5              11      PUSH    DE
0013E4 E0DD CD67E1          17      CALL    DCPAT
0013E7 E0E0 CD6BE7          17      CALL    DRDX
0013EA E0E3 D1              10      POP DE
0013EB E0E4 C1              10      POP BC
0013EC E0E5 C9              10      RET
                                
       E0E6                     FILESE:
0013ED E0E6 7E               7      LD  A,(HL)
0013EE E0E7 B7               4      OR  A
0013EF E0E8 C8              11      RET Z       ;END:ZF=1 CF=0
0013F0 E0E9 FEE5             7      CP  0E5H
0013F2 E0EB 280E            12      JR  Z,FILESE1
0013F4 E0ED FDE5            15      PUSH    IY
0013F6 E0EF D1              10      POP DE
0013F7 E0F0 13               6      INC DE
0013F8 E0F1 E5              11      PUSH    HL
0013F9 E0F2 CD3EE1          17      CALL    CPFILE
0013FC E0F5 CC5FE1          17      CALL    Z,CPFILE2
0013FF E0F8 E1              10      POP HL
001400 E0F9 37               4      SCF
001401 E0FA C8              11      RET Z       ;!!!:(ZF=1) CF=1
       E0FB                     FILESE1:
001402 E0FB CD12E1          17      CALL    FNEXT
001405 E0FE 20E6            12      JR  NZ,FILESE
       E100                     ZF0_CF0_AFF_RET:
001407 E100 F6FF             7      OR  0FFH        ;ZF=0 CF=0
001409 E102 C9              10      RET
                                
       E103                     NEXTSE:
00140A E103 7E               7      LD  A,(HL)
00140B E104 B7               4      OR  A
00140C E105 37               4      SCF
00140D E106 C8              11      RET Z       ;!!!:ZF=1 CF=1
00140E E107 FEE5             7      CP  0E5H
001410 E109 37               4      SCF
001411 E10A C8              11      RET Z       ;!!!:(ZF=1) CF=1
001412 E10B CD12E1          17      CALL    FNEXT
001415 E10E 20F3            12      JR  NZ,NEXTSE
001417 E110 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       E112                     FNEXT:
001419 E112 E5              11      PUSH    HL
00141A E113 219FEF          10      LD  HL,_FILEN
00141D E116 34              11      INC (HL)
00141E E117 E1              10      POP HL
00141F E118 112000          10      LD  DE,020H
001422 E11B 19              11      ADD HL,DE
001423 E11C 0D               4      DEC C
001424 E11D C9              10      RET
                                
       E11E                     CPNAME:
001425 E11E C5              11      PUSH    BC
001426 E11F D5              11      PUSH    DE
001427 E120 E5              11      PUSH    HL
001428 E121 CD38E1          17      CALL    CPFILE4
00142B E124 E1              10      POP HL
00142C E125 23               6      INC HL
00142D E126 23               6      INC HL
00142E E127 23               6      INC HL
00142F E128 23               6      INC HL
001430 E129 D1              10      POP DE
001431 E12A C1              10      POP BC
001432 E12B 2005            12      JR  NZ,CPNAME1
001434 E12D 7E               7      LD  A,(HL)
001435 E12E 23               6      INC HL
001436 E12F 66               7      LD  H,(HL)
001437 E130 6F               4      LD  L,A
001438 E131 C9              10      RET
       E132                     CPNAME1:
001439 E132 23               6      INC HL
00143A E133 23               6      INC HL
00143B E134 10E8            13      DJNZ    CPNAME
00143D E136 37               4      SCF
00143E E137 C9              10      RET
                                
       E138                     CPFILE4:
00143F E138 C5              11      PUSH    BC
001440 E139 010004          10      LD  BC,00400H
001443 E13C 1804            12      JR  CPSTR1
       E13E                     CPFILE:
001445 E13E C5              11      PUSH    BC
001446 E13F 01000B          10      LD  BC,00B00H
       E142                     CPSTR1:
001449 E142 1A               7      LD  A,(DE)
00144A E143 FE3F             7      CP  '?'     ;Wild card
00144C E145 2812            12      JR  Z,CPSTR2
00144E E147 7E               7      LD  A,(HL)
00144F E148 CDB7E2          17      CALL    FKANC
001452 E14B E5              11      PUSH    HL
001453 E14C 67               4      LD  H,A
001454 E14D 1A               7      LD  A,(DE)
001455 E14E CB01             4      RLC C
001457 E150 CDB7E2          17      CALL    FKANC
00145A E153 CB09             4      RRC C
00145C E155 BC               4      CP  H       ;CP (HL),(DE)
00145D E156 E1              10      POP HL
00145E E157 2004            12      JR  NZ,CPSTR3
       E159                     CPSTR2:
001460 E159 13               6      INC DE
001461 E15A 23               6      INC HL
001462 E15B 10E5            13      DJNZ    CPSTR1
       E15D                     CPSTR3:
001464 E15D C1              10      POP BC
001465 E15E C9              10      RET
                                
       E15F                     CPFILE2:
001466 E15F FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001469 E162 F6E1             7      OR  0E1H
00146B E164 2F               4      CPL
00146C E165 A6               7      AND (HL)
00146D E166 C9              10      RET
                                
       E167                     DCPAT:
00146E E167 0E00             7      LD  C,0
001470 E169 2A7EF0          16      LD  HL,(_DTBUF)
001473 E16C 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
001476 E16F B7               4      OR  A
001477 E170 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
001478 E171 3A85E1          13      LD  A,(SPCPAT+1)
00147B E174 4F               4      LD  C,A
00147C E175 3AF8E8          13      LD  A,(_SECPS+1)
00147F E178 B9               4      CP  C
001480 E179 3801            12      JR  C,DC1
001482 E17B AF               4      XOR A
       E17C                     DC1:
001483 E17C F680             7      OR  080H
001485 E17E 32A0EF          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       E181                     CLUSTX:
001488 E181 E5              11      PUSH    HL
001489 E182 EB               4      EX  DE,HL
00148A E183 AF               4      XOR A
00148B E184 0E01             7  SPCPAT: LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       E186                     L_CLDBL:
00148D E186 CB19             8      RR  C       ;->CF
00148F E188 3804            12      JR  C,E_CLDBL
001491 E18A 29              11      ADD HL,HL       ;*2
001492 E18B 8F               4      ADC A,A
001493 E18C 18F8            12      JR  L_CLDBL
       E18E                     E_CLDBL:
001495 E18E 4F               4      LD  C,A
001496 E18F 3AF8E8          13      LD  A,(_SECPS+1)
001499 E192 B5               4      OR  L
00149A E193 6F               4      LD  L,A
00149B E194 110800          10  CLSPAT: LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
00149E E197 AF               4      XOR A
00149F E198 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
0014A0 E199 89               4      ADC A,C
0014A1 E19A 4F               4      LD  C,A
0014A2 E19B EB               4      EX  DE,HL
0014A3 E19C E1              10      POP HL
0014A4 E19D C9              10      RET
                                
       E19E                     ENDCL:
0014A5 E19E 7A               4      LD  A,D ;END CLUSTER
0014A6 E19F FE01             7  CLPAT1: CP  1   ;164=356    (self-modifying code)
0014A8 E1A1 C0              11      RET NZ
0014A9 E1A2 7B               4      LD  A,E
0014AA E1A3 FE64             7  CLPAT2: CP  064H    ;       (self-modifying code)
0014AC E1A5 C9              10      RET
                                
       E1A6                     CAP:
0014AD E1A6 FE61             7      CP  'a'
0014AF E1A8 D8              11      RET C
0014B0 E1A9 FE7B             7      CP  'z'+1
0014B2 E1AB D0              11      RET NC
0014B3 E1AC D620             7      SUB 020H
0014B5 E1AE C9              10      RET
       E1AF                     CAP2:
0014B6 E1AF CDA6E1          17      CALL    CAP
       E1B2                     CAP3:
0014B9 E1B2 CDBBE1          17      CALL    CAP4
0014BC E1B5 FE21             7      CP  021H
0014BE E1B7 D0              11      RET NC
0014BF E1B8 3EA0             7      LD  A,NBSP
0014C1 E1BA C9              10      RET
       E1BB                     CAP4:
0014C2 E1BB FE05             7      CP  5
0014C4 E1BD C0              11      RET NZ
0014C5 E1BE 3EE5             7      LD  A,0E5H
0014C7 E1C0 C9              10      RET
                                
       E1C1                     CHDIR:
0014C8 E1C1 CDBEEB          17      CALL    GETDPBD
0014CB E1C4 381D            12      JR  C,CHDIR2
0014CD E1C6 DD751A          19      LD  (IX+DPB_SDIR),L
0014D0 E1C9 DD741B          19      LD  (IX+DPB_SDIR+1),H
0014D3 E1CC 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       E1CE                     LDDIR:
0014D5 E1CE CDBEEB          17      CALL    GETDPBD
0014D8 E1D1 DD5E1A          19      LD  E,(IX+DPB_SDIR)
0014DB E1D4 DD561B          19      LD  D,(IX+DPB_SDIR+1)
0014DE E1D7 13               6      INC DE
0014DF E1D8 FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0014E2 E1DB FD720F          19      LD  (IY+15),D
0014E5 E1DE 1B               6      DEC DE
0014E6 E1DF AF               4      XOR A
0014E7 E1E0 32A0EF          13      LD  (_DIRF),A
       E1E3                     CHDIR2:
0014EA E1E3 DDE1            14      POP IX
0014EC E1E5 C9              10      RET
                                
       E1E6                     LDDIRX:
0014ED E1E6 3AA0EF          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
0014F0 E1E9 E67F             7      AND 07FH
       E1EB                     LDDIRX1:
0014F2 E1EB 32F8E8          13      LD  (_SECPS+1),A
0014F5 E1EE FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0014F8 E1F1 FD560F          19      LD  D,(IY+15)
0014FB E1F4 1B               6      DEC DE
0014FC E1F5 CD9EE1          17      CALL    ENDCL
0014FF E1F8 D4CEE1          17      CALL    NC,LDDIR
       E1FB                     LDDIRS:
001502 E1FB 7A               4      LD  A,D
001503 E1FC B3               4      OR  E
001504 E1FD 32A0EF          13      LD  (_DIRF),A   ;ディレクトリか判別
001507 E200 C9              10      RET
                                
       E201                     KILL:
001508 E201 CDD1E2          17      CALL    CHKWILDX
00150B E204 3834            12      JR  C,KILLW
00150D E206 CDA3DF          17      CALL    SOPENX
       E209                     KILLS:
001510 E209 3E1F             7      LD  A,01FH
001512 E20B D44DE2          17      CALL    NC,CHKATT
001515 E20E D8              11      RET C
       E20F                     KILLSX:
001516 E20F 36E5            10      LD  (HL),0E5H   ;DIR
001518 E211 CDABE2          17      CALL    WTDB
00151B E214 111A00          10      LD  DE,01AH
00151E E217 19              11      ADD HL,DE
00151F E218 5E               7      LD  E,(HL)
001520 E219 23               6      INC HL
001521 E21A 56               7      LD  D,(HL)
       E21B                     KILLS1:
001522 E21B CD9EE1          17      CALL    ENDCL
001525 E21E D0              11      RET NC      ;CF=0
001526 E21F 21FEFF          10      LD  HL,0-2
001529 E222 19              11      ADD HL,DE
00152A E223 D0              11      RET NC      ;DE= 0 or 1
00152B E224 D5              11      PUSH    DE
00152C E225 CDF7EF          17      CALL    _GNCL
00152F E228 ED53FEF0        20      LD  (_CLPS),DE
001533 E22C D1              10      POP DE
001534 E22D 210000          10      LD  HL,0
001537 E230 D4FAEF          17      CALL    NC,_SNCL
00153A E233 D8              11      RET C
00153B E234 ED5BFEF0        20      LD  DE,(_CLPS)  ;FAT
00153F E238 18E1            12      JR  KILLS1
                                
       E23A                     KILLW:
001541 E23A CDD0DF          17      CALL    SOPEN
       E23D                     KILLW1:
001544 E23D 380B            12      JR  C,KILLW2
001546 E23F CD70E0          17      CALL    SOPENE2
001549 E242 CD09E2          17      CALL    KILLS
00154C E245 CD34E0          17      CALL    NOPEN
00154F E248 18F3            12      JR  KILLW1
       E24A                     KILLW2:
001551 E24A C8              11      RET Z
001552 E24B 3F               4      CCF
001553 E24C C9              10      RET
                                
       E24D                     CHKATT:
001554 E24D E5              11      PUSH    HL
001555 E24E 110B00          10      LD  DE,00BH
001558 E251 19              11      ADD HL,DE
001559 E252 A6               7      AND (HL)
00155A E253 E1              10      POP HL
00155B E254 C8              11      RET Z
00155C E255 37               4      SCF
00155D E256 C9              10      RET
                                
       E257                     NAME:
00155E E257 CDD1E2          17      CALL    CHKWILDX
001561 E25A D8              11      RET C
001562 E25B 110400          10      LD  DE,4
001565 E25E 19              11      ADD HL,DE
001566 E25F 2277E2          16      LD  (NAMEP+2),HL
001569 E262 23               6      INC HL
00156A E263 CDD5E2          17      CALL    CHKWILD
00156D E266 D8              11      RET C
                                
00156E E267 CDA3DF          17      CALL    SOPENX
001571 E26A 3E0F             7      LD  A,00FH
001573 E26C D44DE2          17      CALL    NC,CHKATT
001576 E26F D8              11      RET C
                                
001577 E270 FD7E00          19      LD  A,(IY+0)
00157A E273 FDE5            15      PUSH    IY
00157C E275 FD210000        14  NAMEP:  LD  IY,0        ;自己書き換え
001580 E279 FD7700          19      LD  (IY+0),A
001583 E27C CDA3DF          17      CALL    SOPENX
001586 E27F FDE3            23      EX  (SP),IY
001588 E281 3F               4      CCF
001589 E282 D4D0DF          17      CALL    NC,SOPEN
00158C E285 EB               4      EX  DE,HL
00158D E286 E1              10      POP HL
00158E E287 D8              11      RET C
                                
       E288                     SETNAME:
00158F E288 01000B          10      LD  BC,11*256
001592 E28B 23               6      INC HL
001593 E28C 7E               7      LD  A,(HL)
001594 E28D FEE5             7      CP  0E5H
001596 E28F 2004            12      JR  NZ,SNAME1
001598 E291 3E05             7      LD  A,5
00159A E293 180E            12      JR  SNAME3
       E295                     SNAME1:
00159C E295 7E               7      LD  A,(HL)
00159D E296 0C               4      INC C
00159E E297 0D               4      DEC C
00159F E298 2009            12      JR  NZ,SNAME3
0015A1 E29A CDA6E1          17      CALL    CAP
0015A4 E29D FEA0             7      CP  0A0H
0015A6 E29F 2002            12      JR  NZ,SNAME3
0015A8 E2A1 3E20             7      LD  A,020H
       E2A3                     SNAME3:
0015AA E2A3 12               7      LD  (DE),A
0015AB E2A4 7E               7      LD  A,(HL)
0015AC E2A5 23               6      INC HL
0015AD E2A6 CDBEE2          17      CALL    FKAN
0015B0 E2A9 10EA            13      DJNZ    SNAME1
       E2AB                     WTDB:
0015B2 E2AB 3EFF             7      LD  A,0FFH
0015B4 E2AD 3239EF          13      LD  (SFILE),A
       E2B0                     SWTDBF:
0015B7 E2B0 3E01             7      LD  A,1
0015B9 E2B2 32A4EF          13      LD  (_WTDBF),A
0015BC E2B5 AF               4      XOR A
0015BD E2B6 C9              10      RET
                                
       E2B7                     FKANC:
0015BE E2B7 CB41             8      BIT 0,C
0015C0 E2B9 CCAFE1          17      CALL    Z,CAP2
0015C3 E2BC 1801            12      JR  FKANX
       E2BE                     FKAN:           ;漢字チェック
0015C5 E2BE 13               6      INC DE
       E2BF                     FKANX:
0015C6 E2BF CB41             8      BIT 0,C
0015C8 E2C1 CB81             8      RES 0,C
0015CA E2C3 C0              11      RET NZ
0015CB E2C4 FE80             7      CP  080H
0015CD E2C6 D8              11      RET C
0015CE E2C7 FEA0             7      CP  0A0H
0015D0 E2C9 3803            12      JR  C,FKAN1
0015D2 E2CB FEE0             7      CP  0E0H
0015D4 E2CD D8              11      RET C
       E2CE                     FKAN1:
0015D5 E2CE 0C               4      INC C
0015D6 E2CF A7               4      AND A
0015D7 E2D0 C9              10      RET
                                
       E2D1                     CHKWILDX:
0015D8 E2D1 FDE5            15      PUSH    IY
0015DA E2D3 E1              10      POP HL
0015DB E2D4 23               6      INC HL
       E2D5                     CHKWILD:
0015DC E2D5 060B             7      LD  B,11
0015DE E2D7 3E3F             7      LD  A,'?'
       E2D9                     CHKWIL1:
0015E0 E2D9 BE               7      CP  (HL)
0015E1 E2DA 23               6      INC HL
0015E2 E2DB 37               4      SCF
0015E3 E2DC C8              11      RET Z
0015E4 E2DD 10FA            13      DJNZ    CHKWIL1
0015E6 E2DF AF               4      XOR A
0015E7 E2E0 C9              10      RET
                                
       E2E1                     SDIRENT:        ;IY=FCB HL=DIR
0015E8 E2E1 D5              11      PUSH    DE
0015E9 E2E2 E5              11      PUSH    HL
0015EA E2E3 FDE5            15      PUSH    IY
0015EC E2E5 D1              10      POP DE
0015ED E2E6 EB               4      EX  DE,HL
0015EE E2E7 CD88E2          17      CALL    SETNAME
                                ;               Attribute
0015F1 E2EA FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0015F4 E2ED 12               7      LD  (DE),A
0015F5 E2EE 13               6      INC DE
                                ;               Reserved
0015F6 E2EF AF               4      XOR A
0015F7 E2F0 060A             7      LD  B,10
       E2F2                     SDE1:
0015F9 E2F2 12               7      LD  (DE),A
0015FA E2F3 13               6      INC DE
0015FB E2F4 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
0015FD E2F6 21E4F0          10      LD  HL,SDDATA       ;(FCB)更新年月日
001600 E2F9 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       E2FB                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
001602 E2FB 7E               7      LD  A,(HL)
001603 E2FC 23               6      INC HL
001604 E2FD 3202E3          13      LD  (SDPAT+2),A
001607 E300 FD7E00          19  SDPAT:  LD  A,(IY+0)    ;LD A,(IY+A)
00160A E303 12               7      LD  (DE),A
00160B E304 13               6      INC DE
00160C E305 10F4            13      DJNZ    SDLOOP
                                
00160E E307 AF               4      XOR A
00160F E308 E1              10      POP HL
001610 E309 D1              10      POP DE
001611 E30A C9              10      RET
                                
       E30B                     WOPEN:
001612 E30B FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001615 E30E E61F             7      AND 01FH
001617 E310 37               4      SCF
001618 E311 C0              11      RET NZ
001619 E312 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E316                     TOPEN2:
00161D E316 AF               4      XOR A
       E317                     TOPEN:              ;Initializes the time stamp
00161E E317 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
001622 E31B C9              10      RET
                                
       E31C                     WRDFX:
001623 E31C 3A85E1          13      LD  A,(SPCPAT+1)    ;1クラスタの論理セクタ
       E31F                     L_WRFX:
001626 E31F 1F               4      RRA         ;->CF
001627 E320 3806            12      JR  C,E_WRFX
001629 E322 CB39             8      SRL C
00162B E324 CB1C             8      RR  H       ;CH=CH/2
00162D E326 18F7            12      JR  L_WRFX
       E328                     E_WRFX:
00162F E328 41               4      LD  B,C
001630 E329 4C               4      LD  C,H
001631 E32A 03               6      INC BC
001632 E32B 3E37             7      LD  A,037H      ;SCF
001634 E32D 3288E7          13      LD  (DRDN1),A
                                
       E330                     WRDF:               ;BCクラスタ分FATを確保する
001637 E330 110200          10      LD  DE,2
00163A E333 AF               4      XOR A
00163B E334 32F8E8          13      LD  (_SECPS+1),A
       E337                     WRDF1:
00163E E337 C5              11      PUSH    BC
00163F E338 D5              11      PUSH    DE
001640 E339 CDF7EF          17      CALL    _GNCL
001643 E33C 381C            12      JR  C,WRDF3
001645 E33E 7A               4      LD  A,D     ;空いているかチェック
001646 E33F B3               4      OR  E
001647 E340 202A            12      JR  NZ,WRDF4
001649 E342 E1              10      POP HL      ;HL=空いているクラスタ
00164A E343 E5              11      PUSH    HL
00164B E344 ED5BFEF0        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
00164F E348 22FEF0          16      LD  (_CLPS),HL
001652 E34B 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
001653 E34C B3               4      OR  E
001654 E34D 2008            12      JR  NZ,WRDF2
001656 E34F FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
001659 E352 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
00165C E355 1803            12      JR  WRDF3
       E357                     WRDF2:
00165E E357 CDFAEF          17      CALL    _SNCL
       E35A                     WRDF3:
001661 E35A D1              10      POP DE
001662 E35B C1              10      POP BC
001663 E35C D8              11      RET C
001664 E35D 0B               6      DEC BC
001665 E35E 78               4      LD  A,B
001666 E35F B1               4      OR  C
001667 E360 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
001669 E362 ED5BFEF0        20      LD  DE,(_CLPS)
00166D E366 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
001670 E369 C3FAEF          10      JP  _SNCL
                                
       E36C                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
001673 E36C D1              10      POP DE
001674 E36D C1              10      POP BC
       E36E                     WRDF5:
001675 E36E 13               6      INC DE
001676 E36F CD9EE1          17      CALL    ENDCL
001679 E372 38C3            12      JR  C,WRDF1
00167B E374 37               4      SCF
00167C E375 C9              10      RET
                                
       E376                     RWXR:
00167D E376 3A95E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E379                     L_RWX:
001680 E379 1F               4      RRA     ;->CF
001681 E37A 3808            12      JR  C,E_RWX
001683 E37C CB38             8      SRL B   ;BCH=BCH/2
001685 E37E CB19             8      RR  C   ;
001687 E380 CB1C             8      RR  H   ;
001689 E382 18F5            12      JR  L_RWX
       E384                     E_RWX:
00168B E384 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
00168E E387 FD561B          19      LD  D,(IY+27)
001691 E38A AF               4      XOR A
001692 E38B 32F8E8          13      LD  (_SECPS+1),A
       E38E                     RWX1:
001695 E38E ED53FEF0        20      LD  (_CLPS),DE
001699 E392 7A               4      LD  A,D
00169A E393 B3               4      OR  E
00169B E394 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
00169D E396 78               4      LD  A,B
00169E E397 B1               4      OR  C
00169F E398 B4               4      OR  H
0016A0 E399 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
0016A1 E39A CD00E9          17      CALL    GNCLX
0016A4 E39D D8              11      RET C
0016A5 E39E 7C               4      LD  A,H     ;
0016A6 E39F 25               4      DEC H       ;
0016A7 E3A0 B7               4      OR  A       ;DEC BCH
0016A8 E3A1 2001            12      JR  NZ,RWX2     ;
0016AA E3A3 0B               6      DEC BC      ;
       E3A4                     RWX2:
0016AB E3A4 CD9EE1          17      CALL    ENDCL
0016AE E3A7 38E5            12      JR  C,RWX1
       E3A9                     SCF_RET:
0016B0 E3A9 37               4      SCF
0016B1 E3AA C9              10      RET
                                
       E3AB                     DSKF:
0016B2 E3AB 110000          10  MAXCLP: LD  DE,0
0016B5 E3AE 2AACEF          16      LD  HL,(_FAKEFREE)
0016B8 E3B1 7C               4      LD  A,H
0016B9 E3B2 B5               4      OR  L
0016BA E3B3 2803            12      JR  Z,DSKF1
0016BC E3B5 110100          10      LD  DE,1
       E3B8                     DSKF1:
0016BF E3B8 D5              11      PUSH    DE
0016C0 E3B9 CDF7EF          17      CALL    _GNCL
0016C3 E3BC 380C            12      JR  C,POPSCF
0016C5 E3BE 7A               4      LD  A,D
0016C6 E3BF B3               4      OR  E
0016C7 E3C0 2001            12      JR  NZ,DSKF2
0016C9 E3C2 23               6      INC HL
       E3C3                     DSKF2:
0016CA E3C3 D1              10      POP DE
0016CB E3C4 1B               6      DEC DE
0016CC E3C5 7A               4      LD  A,D
0016CD E3C6 B3               4      OR  E
0016CE E3C7 20EF            12      JR  NZ,DSKF1
0016D0 E3C9 C9              10      RET
                                
       E3CA                     POPSCF:
0016D1 E3CA F1              10      POP AF
0016D2 E3CB 37               4      SCF
0016D3 E3CC C9              10      RET
                                
       E3CD                     SETTMS:
0016D4 E3CD FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
0016D7 E3D0 3C               4      INC A
0016D8 E3D1 C0              11      RET NZ      ;ファイルが更新されていない
       E3D2                     SETTMSX:            ;FCBに日付時刻をセットする
0016D9 E3D2 CD4ADA          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
0016DC E3D5 CB25             8      SLA L       ;   *2
0016DE E3D7 CB25             8      SLA L       ;   *4
0016E0 E3D9 29              11      ADD HL,HL       ;*2 *8
0016E1 E3DA 29              11      ADD HL,HL       ;*4 *16
0016E2 E3DB 29              11      ADD HL,HL       ;*8 *32
0016E3 E3DC 7A               4      LD  A,D
0016E4 E3DD 0F               4      RRCA            ;bit.0->7->->->0->C
0016E5 E3DE E61F             7      AND 01FH
0016E7 E3E0 B5               4      OR  L
0016E8 E3E1 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
0016EB E3E4 FD7417          19      LD  (IY+23),H
                                
0016EE E3E7 CD23DA          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
0016F1 E3EA 0144F8          10      LD  BC,0-1980
0016F4 E3ED 09              11      ADD HL,BC
0016F5 E3EE 65               4      LD  H,L
                                
0016F6 E3EF 7A               4      LD  A,D
0016F7 E3F0 87               4      ADD A,A     ;*2
0016F8 E3F1 87               4      ADD A,A     ;*4
0016F9 E3F2 87               4      ADD A,A     ;*8
0016FA E3F3 87               4      ADD A,A     ;*16
0016FB E3F4 6F               4      LD  L,A
0016FC E3F5 29              11      ADD HL,HL       ;*32
0016FD E3F6 7D               4      LD  A,L
0016FE E3F7 B3               4      OR  E
0016FF E3F8 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
001702 E3FB FD7415          19      LD  (IY+21),H
001705 E3FE C9              10      RET
                                
       E3FF                     PUSHRR:
001706 E3FF 3297E4          13      LD  (SETSEQ_SWC_RND),A
001709 E402 22A9E4          16      LD  (SETSEQ_SWC_SEQ_RR),HL
00170C E405 CD25E4          17      CALL    GET_RR_AHL
00170F E408 220FEF          16      LD  (RR_BUF_HL),HL
001712 E40B 3211EF          13      LD  (RR_BUF_A),A
001715 E40E C9              10      RET
                                
       E40F                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
001716 E40F 87               4      ADD A,A     ;in BHLA => out AHL
001717 E410 ED6A            15      ADC HL,HL
001719 E412 CB18             8      RR  B
00171B E414 B7               4      OR  A
00171C E415 78               4      LD  A,B     ;ここでフラグは変化しない
00171D E416 C8              11      RET Z
00171E E417 2C               4      INC L       ;INC AHL
00171F E418 C0              11      RET NZ      ;
001720 E419 24               4      INC H       ;
001721 E41A C0              11      RET NZ      ;
001722 E41B 3C               4      INC A       ;
001723 E41C C9              10      RET
                                
       E41D                     INIT_RND:
001724 E41D 3ECD             7      LD  A,0CDH      ;CALL ????
001726 E41F 216CE4          10      LD  HL,POPRR
001729 E422 CDFFE3          17      CALL    PUSHRR
       E425                     GET_RR_AHL:
00172C E425 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00172F E428 FD6622          19      LD  H,(IY+34)   ;
001732 E42B FD7E23          19      LD  A,(IY+35)   ;
001735 E42E C9              10      RET
       E42F                     SET_RR_AHL:
001736 E42F FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001739 E432 FD7422          19      LD  (IY+34),H
00173C E435 FD7723          19      LD  (IY+35),A
00173F E438 C9              10      RET
       E439                     INIT_SEQ:
001740 E439 3E01             7      LD  A,1     ;LD BC,????
001742 E43B 2169E4          10      LD  HL,SETSEQ
001745 E43E CDFFE3          17      CALL    PUSHRR
       E441                     GETSEQ:
001748 E441 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
00174B E444 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
00174E E447 AF               4      XOR A
                                
00174F E448 CB25             8      SLA L   ;L=L*2
                                
001751 E44A CB3C             8      SRL H   ;HL=HL/2
001753 E44C CB1D             8      RR  L   ;
001755 E44E C9              10      RET
                                
       E44F                     SETSEQ1:
001756 E44F F5              11      PUSH    AF
001757 E450 E5              11      PUSH    HL      ;AHL=Random record
001758 E451 CD25E4          17      CALL    GET_RR_AHL
00175B E454 47               4      LD  B,A     ;AHL→HLA
00175C E455 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
00175D E456 6C               4      LD  L,H     ;(IY+34)
00175E E457 60               4      LD  H,B     ;(IY+35)
00175F E458 0600             7      LD  B,0
                                
001761 E45A CD0FE4          17      CALL    GET_CPM_R_SIZE
                                
001764 E45D 29              11      ADD HL,HL
001765 E45E CB3D             8      SRL L       ;L=L/2
001767 E460 FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
00176A E463 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
00176D E466 E1              10      POP HL
00176E E467 F1              10      POP AF
00176F E468 C9              10      RET
       E469                     SETSEQ:
001770 E469 CD4FE4          17      CALL    SETSEQ1
       E46C                     POPRR:
001773 E46C F5              11      PUSH    AF
001774 E46D E5              11      PUSH    HL
001775 E46E 2A0FEF          16      LD  HL,(RR_BUF_HL)
001778 E471 3A11EF          13      LD  A,(RR_BUF_A)
00177B E474 CD2FE4          17      CALL    SET_RR_AHL
00177E E477 E1              10      POP HL
00177F E478 F1              10      POP AF
001780 E479 C9              10      RET
                                
       E47A                     RB_WRITE:
001781 E47A C5              11      PUSH    BC
001782 E47B ED4B4CF0        20      LD  BC,(STABLE+2*026H)  ;(BDOS)ランダムブロック書き込み
001786 E47F 1805            12      JR  RBRW
       E481                     RB_READ:
001788 E481 C5              11      PUSH    BC
001789 E482 ED4B4EF0        20      LD  BC,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       E486                     RBRW:
00178D E486 1F               4      RRA     ;AHL = AHL*128
00178E E487 7C               4      LD  A,H ;AHL = AHL0/2
00178F E488 1F               4      RRA     ;A
001790 E489 65               4      LD  H,L ;
001791 E48A CB1C             8      RR  H   ;H
001793 E48C 2E00             7      LD  L,0 ;
001795 E48E CB1D             8      RR  L   ;L
001797 E490 CD2FE4          17      CALL    SET_RR_AHL
00179A E493 218000          10      LD  HL,128
00179D E496 C5              11      PUSH    BC
       E497                     SETSEQ_SWC_RND:
00179E E497 CD4FE4          17      CALL    SETSEQ1
0017A1 E49A C1              10      POP BC
0017A2 E49B FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
0017A6 E49F FDE5            15      PUSH    IY
0017A8 E4A1 D1              10      POP DE
0017A9 E4A2 D5              11      PUSH    DE
0017AA E4A3 CDB1E4          17      CALL    JP_BC
0017AD E4A6 FDE1            14      POP IY
0017AF E4A8 CD69E4          17      CALL    SETSEQ
       E4A9                     SETSEQ_SWC_SEQ_RR   EQU $-2
0017B2 E4AB FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
0017B6 E4AF C1              10      POP BC
0017B7 E4B0 C9              10      RET
       E4B1                     JP_BC:
0017B8 E4B1 C5              11      PUSH    BC
0017B9 E4B2 C9              10      RET
                                
       E02E                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       E02E                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       E02E                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       E02E                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       E02E                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E4B3                     _SYS26:     ;(BDOS)ランダムブロック書き込み
0017BA E4B3 AF               4      XOR A
0017BB E4B4 3288E7          13      LD  (DRDN1),A   ;NOP
0017BE E4B7 22D8E6          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
0017C1 E4BA 225DEF          16      LD  (LEFTX),HL
0017C4 E4BD CD83DF          17      CALL    SETDRV
                                
0017C7 E4C0 CD30E6          17      CALL    RBX0
0017CA E4C3 DA50E5          10      JP  C,RBWERR
0017CD E4C6 CD0BE3          17      CALL    WOPEN
0017D0 E4C9 DA50E5          10      JP  C,RBWERR
0017D3 E4CC 7C               4      LD  A,H
0017D4 E4CD B5               4      OR  L
0017D5 E4CE CA49E5          10      JP  Z,RBW1
                                
0017D8 E4D1 2B               6      DEC HL
                                
0017D9 E4D2 CDEEE6          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0017DC E4D5 19              11      ADD HL,DE       ;BCHL=HL+BCDE
0017DD E4D6 3001            12      JR  NC,S26X1    ;
0017DF E4D8 03               6      INC BC      ;
       E4D9                     S26X1:
0017E0 E4D9 CD76E3          17      CALL    RWXR
0017E3 E4DC DC1CE3          17      CALL    C,WRDFX
0017E6 E4DF DA50E5          10      JP  C,RBWERR
                                
0017E9 E4E2 CD5FE6          17      CALL    RBX2
0017EC E4E5 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
0017EE E4E7 CD7EE6          17      CALL    RBXA
0017F1 E4EA 3864            12      JR  C,RBWERR
0017F3 E4EC EB               4      EX  DE,HL
0017F4 E4ED C5              11      PUSH    BC
0017F5 E4EE EDB0                    LDIR
0017F7 E4F0 225FEF          16      LD  (DTAX),HL
                                
0017FA E4F3 CDB0E2          17      CALL    SWTDBF      ;バッファデータは更新された
                                
0017FD E4F6 2A5DEF          16      LD  HL,(LEFTX)
001800 E4F9 D1              10      POP DE
001801 E4FA ED52            15      SBC HL,DE
001803 E4FC 225DEF          16      LD  (LEFTX),HL
001806 E4FF 2831            12      JR  Z,RBWEND
                                
       E501                     RBWB:
001808 E501 CDB3E6          17      CALL    RBXB
00180B E504 2814            12      JR  Z,RBWC
       E506                     RBWB1:
00180D E506 C5              11      PUSH    BC
00180E E507 D5              11      PUSH    DE
00180F E508 CD81E1          17      CALL    CLUSTX
001812 E50B CD02E7          17      CALL    DWTC
001815 E50E D1              10      POP DE
001816 E50F C1              10      POP BC
001817 E510 D400E9          17      CALL    NC,GNCLX
00181A E513 383B            12      JR  C,RBWERR
00181C E515 10EF            13      DJNZ    RBWB1
00181E E517 CD52E7          17      CALL    DRW_FLUSH
       E51A                     RBWC:
001821 E51A CDCBE6          17      CALL    RBXC
001824 E51D 2813            12      JR  Z,RBWEND
001826 E51F C5              11      PUSH    BC
001827 E520 CD81E1          17      CALL    CLUSTX
00182A E523 CD87E7          17      CALL    DRDN
00182D E526 C1              10      POP BC
00182E E527 3827            12      JR  C,RBWERR
001830 E529 ED5B7EF0        20      LD  DE,(_DTBUF)
001834 E52D EDB0                    LDIR
001836 E52F CDB0E2          17      CALL    SWTDBF      ;バッファデータは更新された
       E532                     RBWEND:
001839 E532 CDD7E6          17      CALL    RBXEND
                                
00183C E535 CD3FE6          17      CALL    RBX1
00183F E538 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
001841 E53A CDEEE6          17      CALL    GET_RR_BCDE ;BCDE=Random record
001844 E53D FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
001847 E540 FD7211          19      LD  (IY+17),D   ;
00184A E543 FD7112          19      LD  (IY+18),C   ;
00184D E546 FD7013          19      LD  (IY+19),B   ;
       E549                     RBW1:
001850 E549 FDE1            14      POP IY
001852 E54B C1              10      POP BC
001853 E54C D1              10      POP DE
001854 E54D E1              10      POP HL
       E54E                     DD_NUL:
001855 E54E AF               4      XOR A
       E54F                     DRDF0:
       E54F                     DWTF0:
001856 E54F C9              10      RET
                                
       E550                     RBWERR:
001857 E550 FDE5            15      PUSH    IY
001859 E552 D1              10      POP DE
00185A E553 2A20F0          16      LD  HL,(STABLE+2*010H)
00185D E556 CD0F00          17      CALL    JP_HL
       E559                     RBRERR1:
001860 E559 3E01             7      LD  A,001H
       E55B                     RBRERR2:
001862 E55B FDE1            14      POP IY
001864 E55D C1              10      POP BC
001865 E55E D1              10      POP DE
001866 E55F E1              10      POP HL
001867 E560 37               4      SCF
001868 E561 210000          10      LD  HL,0
00186B E564 C9              10      RET
                                
       E565                     RBRERR:
00186C E565 3EFF             7      LD  A,0FFH
00186E E567 18F2            12      JR  RBRERR2
                                
       E569                     RBRFL:
001870 E569 3E00             7  RBRFLP: LD  A,000H
001872 E56B FE0D             7      CP  00DH
001874 E56D 2005            12      JR  NZ,RBRFL1
001876 E56F D5              11      PUSH    DE
001877 E570 1E0A             7      LD  E,00AH
001879 E572 1805            12      JR  RBRFL2
       E574                     RBRFL1:
00187B E574 D5              11      PUSH    DE
00187C E575 CD09EF          17      CALL    _SYS07
00187F E578 5F               4      LD  E,A
       E579                     RBRFL2:
001880 E579 CDCDEF          17      CALL    _PRINT
001883 E57C 7B               4      LD  A,E
001884 E57D D1              10      POP DE
001885 E57E 326AE5          13      LD  (RBRFLP+1),A
001888 E581 C9              10      RET
       E582                     DDX:
001889 E582 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
00188C E585 CDA6E1          17      CALL    CAP
00188F E588 FE41             7      CP  'A'
001891 E58A C9              10      RET
                                
                                                ;Read random block
       E58B                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001892 E58B 225DEF          16      LD  (LEFTX),HL
001895 E58E CD83DF          17      CALL    SETDRV
                                
001898 E591 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
00189C E595 C21EE6          10      JP  NZ,RBRDIR   ;ディレクトリ
00189F E598 CD30E6          17      CALL    RBX0
0018A2 E59B DA65E5          10      JP  C,RBRERR
0018A5 E59E CD3FE6          17      CALL    RBX1
0018A8 E5A1 D457E6          17      CALL    NC,RBX1R
0018AB E5A4 DA59E5          10      JP  C,RBRERR1
0018AE E5A7 EB               4      EX  DE,HL
0018AF E5A8 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
0018B1 E5AA 19              11      ADD HL,DE
0018B2 E5AB 79               4      LD  A,C
0018B3 E5AC DE00             7      SBC A,0
0018B5 E5AE 78               4      LD  A,B
0018B6 E5AF DE00             7      SBC A,0
0018B8 E5B1 3801            12      JR  C,RBR1
0018BA E5B3 EB               4      EX  DE,HL
       E5B4                     RBR1:
0018BB E5B4 9F               4      SBC A,A
0018BC E5B5 E601             7      AND 1
0018BE E5B7 321CE6          13      LD  (RBRAP+1),A
                                
0018C1 E5BA 7C               4      LD  A,H
0018C2 E5BB B5               4      OR  L
0018C3 E5BC 2857            12      JR  Z,RBREND0
                                
0018C5 E5BE 22D8E6          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
0018C8 E5C1 225DEF          16      LD  (LEFTX),HL
                                
0018CB E5C4 CD5FE6          17      CALL    RBX2
0018CE E5C7 2819            12      JR  Z,RBRB
0018D0 E5C9 CD7EE6          17      CALL    RBXA
0018D3 E5CC DA65E5          10      JP  C,RBRERR
0018D6 E5CF C5              11      PUSH    BC
0018D7 E5D0 EDB0                    LDIR
0018D9 E5D2 ED535FEF        20      LD  (DTAX),DE
0018DD E5D6 2A5DEF          16      LD  HL,(LEFTX)
0018E0 E5D9 D1              10      POP DE
0018E1 E5DA A7               4      AND A
0018E2 E5DB ED52            15      SBC HL,DE
0018E4 E5DD 225DEF          16      LD  (LEFTX),HL
0018E7 E5E0 2830            12      JR  Z,RBREND
                                
       E5E2                     RBRB:
0018E9 E5E2 CDB3E6          17      CALL    RBXB
0018EC E5E5 2815            12      JR  Z,RBRC
       E5E7                     RBRB1:
0018EE E5E7 C5              11      PUSH    BC
0018EF E5E8 D5              11      PUSH    DE
0018F0 E5E9 CD81E1          17      CALL    CLUSTX
0018F3 E5EC CD08E7          17      CALL    DRDC
0018F6 E5EF D1              10      POP DE
0018F7 E5F0 C1              10      POP BC
0018F8 E5F1 D400E9          17      CALL    NC,GNCLX
0018FB E5F4 DA65E5          10      JP  C,RBRERR
0018FE E5F7 10EE            13      DJNZ    RBRB1
001900 E5F9 CD52E7          17      CALL    DRW_FLUSH
       E5FC                     RBRC:
001903 E5FC CDCBE6          17      CALL    RBXC
001906 E5FF 2811            12      JR  Z,RBREND
001908 E601 C5              11      PUSH    BC
001909 E602 CD81E1          17      CALL    CLUSTX
00190C E605 CD6BE7          17      CALL    DRDX
00190F E608 C1              10      POP BC
001910 E609 DA65E5          10      JP  C,RBRERR
001913 E60C EB               4      EX  DE,HL
001914 E60D 2A7EF0          16      LD  HL,(_DTBUF)
001917 E610 EDB0                    LDIR
       E612                     RBREND:
001919 E612 CDD7E6          17      CALL    RBXEND
       E615                     RBREND0:
00191C E615 FDE1            14      POP IY
00191E E617 C1              10      POP BC
00191F E618 D1              10      POP DE
001920 E619 F1              10      POP AF  ;(HL)
001921 E61A AF               4      XOR A
001922 E61B 3E00             7  RBRAP:  LD  A,000H
001924 E61D C9              10      RET
                                
       E61E                     RBRDIR:
001925 E61E FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001928 E621 FD661B          19      LD  H,(IY+27)
00192B E624 CDC1E1          17      CALL    CHDIR
00192E E627 AF               4      XOR A
00192F E628 67               4      LD  H,A
001930 E629 6F               4      LD  L,A
001931 E62A 3C               4      INC A
001932 E62B 321CE6          13      LD  (RBRAP+1),A
001935 E62E 18E5            12      JR  RBREND0
                                
       E630                     RBX0:
001937 E630 2A8AEF          16      LD  HL,(_DTA)
00193A E633 225FEF          16      LD  (DTAX),HL
00193D E636 2A5DEF          16      LD  HL,(LEFTX)
001940 E639 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
001943 E63C D6FD             7      SUB 0FDH
001945 E63E C9              10      RET
                                
       E63F                     RBX1:               ;ファイルサイズとランダムレコードを比べる
001946 E63F E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
001947 E640 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
00194A E643 FD6611          19      LD  H,(IY+17)   ;
00194D E646 FD7E12          19      LD  A,(IY+18)   ;
                                
001950 E649 CDEEE6          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001953 E64C A7               4      AND A
001954 E64D ED52            15      SBC HL,DE
001956 E64F 99               4      SBC A,C
001957 E650 4F               4      LD  C,A
001958 E651 FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
00195B E654 98               4      SBC A,B
00195C E655 D1              10      POP DE
00195D E656 C9              10      RET
       E657                     RBX1R:
00195E E657 47               4      LD  B,A
00195F E658 B1               4      OR  C
001960 E659 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
001961 E65A B2               4      OR  D
001962 E65B B3               4      OR  E
001963 E65C C0              11      RET NZ
001964 E65D 37               4      SCF
001965 E65E C9              10      RET
                                
       E65F                     RBX2:               ;Cluster settings
001966 E65F FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001969 E662 FD4E23          19      LD  C,(IY+35)
00196C E665 0600             7      LD  B,0
00196E E667 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001972 E66B 2003            12      JR  NZ,RBX3
001974 E66D FD4624          19      LD  B,(IY+36)
       E670                     RBX3:
001977 E670 CD76E3          17      CALL    RWXR
00197A E673 3A95E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
00197D E676 3D               4      DEC A
00197E E677 FDA622          19      AND (IY+34)
001981 E67A FDB621          19      OR  (IY+33)
001984 E67D C9              10      RET
                                
       E67E                     RBXA:
001985 E67E C5              11      PUSH    BC
001986 E67F D5              11      PUSH    DE
001987 E680 CD81E1          17      CALL    CLUSTX
00198A E683 CD6BE7          17      CALL    DRDX
00198D E686 D1              10      POP DE
00198E E687 C1              10      POP BC
00198F E688 D400E9          17      CALL    NC,GNCLX
001992 E68B D8              11      RET C
001993 E68C ED53FEF0        20      LD  (_CLPS),DE
                                
001997 E690 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
00199A E693 210004          10  SECSZ:  LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
00199D E696 7C               4      LD  A,H
00199E E697 3D               4      DEC A       ;1024=3 / 512=1
00199F E698 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
0019A2 E69B 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
0019A3 E69C ED42            15      SBC HL,BC       ;残りを計算
                                
0019A5 E69E ED5B5DEF        20      LD  DE,(LEFTX)
0019A9 E6A2 ED52            15      SBC HL,DE       ;CP HL,DE
0019AB E6A4 19              11      ADD HL,DE       ;
0019AC E6A5 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
0019AE E6A7 EB               4      EX  DE,HL
       E6A8                     RBXA1:
0019AF E6A8 E5              11      PUSH    HL
0019B0 E6A9 2A7EF0          16      LD  HL,(_DTBUF)
0019B3 E6AC 09              11      ADD HL,BC
0019B4 E6AD ED5B5FEF        20      LD  DE,(DTAX)
0019B8 E6B1 C1              10      POP BC
0019B9 E6B2 C9              10      RET
                                
       E6B3                     RBXB:
0019BA E6B3 2A5FEF          16      LD  HL,(DTAX)
0019BD E6B6 ED5BFEF0        20      LD  DE,(_CLPS)
0019C1 E6BA 3A5EEF          13      LD  A,(LEFTX+1)
0019C4 E6BD 47               4      LD  B,A
0019C5 E6BE 3A95E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E6C1                     RBXB1:
0019C8 E6C1 1F               4      RRA     ;->CF
0019C9 E6C2 3804            12      JR  C,RBXB2
0019CB E6C4 CB38             8      SRL B   ;B=B/2
0019CD E6C6 18F9            12      JR  RBXB1
       E6C8                     RBXB2:
0019CF E6C8 78               4      LD  A,B
0019D0 E6C9 B7               4      OR  A
0019D1 E6CA C9              10      RET
                                
       E6CB                     RBXC:
0019D2 E6CB ED4B5DEF        20      LD  BC,(LEFTX)
0019D6 E6CF 3A95E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
0019D9 E6D2 3D               4      DEC A
0019DA E6D3 A0               4      AND B
0019DB E6D4 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
0019DC E6D5 B1               4      OR  C
0019DD E6D6 C9              10      RET
                                
       E6D7                     RBXEND:             ;レコード数だけランダムレコードを進める
0019DE E6D7 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       E6D8                     RBSIZE  EQU $-2
0019E1 E6DA CD25E4          17      CALL    GET_RR_AHL
0019E4 E6DD 19              11      ADD HL,DE
0019E5 E6DE CE00             7      ADC A,0
0019E7 E6E0 CD2FE4          17      CALL    SET_RR_AHL
0019EA E6E3 EB               4      EX  DE,HL       ;HL=進めるレコード数
0019EB E6E4 D0              11      RET NC
0019EC E6E5 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0019F0 E6E9 C0              11      RET NZ
0019F1 E6EA FD3424          23      INC (IY+36)
0019F4 E6ED C9              10      RET
                                
       E6EE                     GET_RR_BCDE:            ;BCDE=Random record
0019F5 E6EE FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
0019F8 E6F1 FD5622          19      LD  D,(IY+34)
0019FB E6F4 FD4E23          19      LD  C,(IY+35)
0019FE E6F7 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
001A00 E6F9 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001A04 E6FD C0              11      RET NZ
001A05 E6FE FD4624          19      LD  B,(IY+36)
001A08 E701 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E702                     DWTC:
001A09 E702 E5              11      PUSH    HL
001A0A E703 2192EA          10      LD  HL,DWT24B
001A0D E706 1804            12      JR  DWTC1
       E708                     DRDC:
001A0F E708 E5              11      PUSH    HL
001A10 E709 2182EA          10      LD  HL,DRD24B
       E70C                     DWTC1:
001A13 E70C 2266E7          16      LD  (DRWF_MODE),HL
001A16 E70F E1              10      POP HL
001A17 E710 3A56E7          13      LD  A,(DRWF_B)
001A1A E713 B7               4      OR  A
001A1B E714 200F            12      JR  NZ,DRDC1
       E716                     SAVE_DRWC:
001A1D E716 0601             7      LD  B,1
001A1F E718 ED4355E7        20      LD  (DRWF_C),BC
001A23 E71C ED535CE7        20      LD  (DRWF_E),DE
001A27 E720 225FE7          16      LD  (DRWF_HL),HL
001A2A E723 1820            12      JR  INC_HL_DRWC
       E725                     DRDC1:
001A2C E725 E5              11      PUSH    HL
001A2D E726 215CE7          10      LD  HL,DRWF_E
001A30 E729 86               7      ADD A,(HL)
001A31 E72A F5              11      PUSH    AF
001A32 E72B BB               4      CP  E
001A33 E72C 201D            12      JR  NZ,DRDC2
001A35 E72E F1              10      POP AF
001A36 E72F 23               6      INC HL
001A37 E730 7E               7      LD  A,(HL)
001A38 E731 CE00             7      ADC A,0
001A3A E733 F5              11      PUSH    AF
001A3B E734 BA               4      CP  D
001A3C E735 2014            12      JR  NZ,DRDC2
001A3E E737 F1              10      POP AF
001A3F E738 3A55E7          13      LD  A,(DRWF_C)
001A42 E73B CE00             7      ADC A,0
001A44 E73D B9               4      CP  C
001A45 E73E 200C            12      JR  NZ,DRDC3
001A47 E740 2156E7          10      LD  HL,DRWF_B
001A4A E743 34              11      INC (HL)
001A4B E744 E1              10      POP HL
       E745                     INC_HL_DRWC:
001A4C E745 3A95E6          13      LD  A,(SECSZ+2)     ;1セクタのサイズの上位1バイト
001A4F E748 84               4      ADD A,H
001A50 E749 67               4      LD  H,A
001A51 E74A C9              10      RET
       E74B                     DRDC2:
001A52 E74B F1              10      POP AF
       E74C                     DRDC3:
001A53 E74C CD52E7          17      CALL    DRW_FLUSH
001A56 E74F E1              10      POP HL
001A57 E750 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E752                     DRW_FLUSH:
001A59 E752 C5              11      PUSH    BC
001A5A E753 D5              11      PUSH    DE
001A5B E754 010000          10      LD  BC,0
       E755                     DRWF_C  EQU $-2
       E756                     DRWF_B  EQU $-1
001A5E E757 78               4      LD  A,B
001A5F E758 B7               4      OR  A
001A60 E759 280D            12      JR  Z,DRDF1
001A62 E75B 110000          10      LD  DE,0
       E75C                     DRWF_E  EQU $-2
       E75D                     DRWF_D  EQU $-1
001A65 E75E 210000          10      LD  HL,0
       E75F                     DRWF_HL EQU $-2
001A68 E761 AF               4      XOR A
001A69 E762 3256E7          13      LD  (DRWF_B),A
001A6C E765 CD82EA          17      CALL    DRD24B
       E766                     DRWF_MODE   EQU $-2
       E768                     DRDF1:
001A6F E768 D1              10      POP DE
001A70 E769 C1              10      POP BC
001A71 E76A C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E76B                     DRDX:
001A72 E76B CDA9E7          17      CALL    DRDY
001A75 E76E C8              11      RET Z
001A76 E76F CD8FE7          17      CALL    DRDX1       ;データバッファの情報を保存
001A79 E772 D8              11      RET C
001A7A E773 E5              11      PUSH    HL
001A7B E774 C5              11      PUSH    BC
001A7C E775 D5              11      PUSH    DE
001A7D E776 2A7EF0          16      LD  HL,(_DTBUF)
001A80 E779 3AD2E7          13      LD  A,(_DBS24+1)
001A83 E77C 4F               4      LD  C,A
001A84 E77D CD80EA          17      CALL    DRD24
001A87 E780 DCA4E7          17      CALL    C,DRDNE
       E783                     POP_DE_BC_HL_RET:
001A8A E783 D1              10      POP DE
001A8B E784 C1              10      POP BC
001A8C E785 E1              10      POP HL
001A8D E786 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E787                     DRDN:
001A8E E787 AF               4      XOR A
001A8F E788 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
001A90 E789 30E0            12      JR  NC,DRDX
       E78B                     DRDNX:
001A92 E78B CDA9E7          17      CALL    DRDY
001A95 E78E C8              11      RET Z
       E78F                     DRDX1:
001A96 E78F CDBFE7          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
001A99 E792 ED53A6EF        20      LD  (_DBSEC),DE
001A9D E796 79               4      LD  A,C
001A9E E797 32D2E7          13      LD  (_DBS24+1),A
                                
001AA1 E79A 3A88EF          13      LD  A,(_DRV)
001AA4 E79D 32A5EF          13      LD  (_DBDRV),A
001AA7 E7A0 CDD9EF          17      CALL    _CHGDRV
001AAA E7A3 D0              11      RET NC
       E7A4                     DRDNE:
001AAB E7A4 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001AAC E7A5 32A5EF          13      LD  (_DBDRV),A
001AAF E7A8 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E7A9                     DRDY:
001AB0 E7A9 3AD2E7          13      LD  A,(_DBS24+1)
001AB3 E7AC B9               4      CP  C
001AB4 E7AD C0              11      RET NZ
                                
001AB5 E7AE E5              11      PUSH    HL
001AB6 E7AF 3A88EF          13      LD  A,(_DRV)
001AB9 E7B2 21A5EF          10      LD  HL,_DBDRV
001ABC E7B5 AE               7      XOR (HL)
001ABD E7B6 2005            12      JR  NZ,POP_HL_RET
                                
001ABF E7B8 2AA6EF          16      LD  HL,(_DBSEC)
001AC2 E7BB ED52            15      SBC HL,DE       ;CF=0
       E7BD                     POP_HL_RET:
001AC4 E7BD E1              10      POP HL
001AC5 E7BE C9              10      RET
                                
       E7BF                     DWTX:
001AC6 E7BF 3AA4EF          13      LD  A,(_WTDBF)
001AC9 E7C2 B7               4      OR  A
001ACA E7C3 C8              11      RET Z
001ACB E7C4 AF               4      XOR A
001ACC E7C5 32A4EF          13      LD  (_WTDBF),A
                                
001ACF E7C8 E5              11      PUSH    HL
001AD0 E7C9 C5              11      PUSH    BC
001AD1 E7CA D5              11      PUSH    DE
001AD2 E7CB 3AA5EF          13      LD  A,(_DBDRV)
001AD5 E7CE CDD9EF          17      CALL    _CHGDRV
001AD8 E7D1 0E00             7  _DBS24: LD  C,0
001ADA E7D3 ED5BA6EF        20      LD  DE,(_DBSEC)
001ADE E7D7 2A7EF0          16      LD  HL,(_DTBUF)
001AE1 E7DA D490EA          17      CALL    NC,DWT24
       E7DD                     POP_DE_BC_HL_RET2:
001AE4 E7DD 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E7DF                     RDFATX:
001AE6 E7DF E5              11      PUSH    HL
001AE7 E7E0 3A88EF          13      LD  A,(_DRV)
001AEA E7E3 21AAEF          10      LD  HL,_FATDRV
001AED E7E6 AE               7      XOR (HL)
001AEE E7E7 28D4            12      JR  Z,POP_HL_RET
                                
001AF0 E7E9 C5              11      PUSH    BC
001AF1 E7EA D5              11      PUSH    DE
001AF2 E7EB DDE5            15      PUSH    IX
001AF4 E7ED CD09E8          17      CALL    WTFATX
001AF7 E7F0 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
001AF9 E7F2 AF               4      XOR A
001AFA E7F3 32ABEF          13      LD  (_FATIX),A
001AFD E7F6 3A88EF          13      LD  A,(_DRV)
001B00 E7F9 32AAEF          13      LD  (_FATDRV),A
001B03 E7FC CDE5EF          17      CALL    _RDFAT
       E7FF                     RDFATE2:
001B06 E7FF 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
001B08 E801 9F               4      SBC A,A     ;A=0xFF
001B09 E802 32AAEF          13      LD  (_FATDRV),A
       E805                     POP_IX_DE_BC_HL_RET:
001B0C E805 DDE1            14      POP IX
001B0E E807 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E809                     WTFATX:
001B10 E809 3AA2EF          13      LD  A,(_WTFATF)
001B13 E80C B7               4      OR  A
001B14 E80D C8              11      RET Z
001B15 E80E E5              11      PUSH    HL
001B16 E80F 3AAAEF          13      LD  A,(_FATDRV)
001B19 E812 21A5EF          10      LD  HL,_DBDRV
001B1C E815 AE               7      XOR (HL)
001B1D E816 CCBFE7          17      CALL    Z,DWTX
001B20 E819 38A2            12      JR  C,POP_HL_RET
001B22 E81B C5              11      PUSH    BC
001B23 E81C D5              11      PUSH    DE
001B24 E81D DDE5            15      PUSH    IX
001B26 E81F CD9DEA          17      CALL    WTFAT
001B29 E822 AF               4      XOR A
001B2A E823 32A2EF          13      LD  (_WTFATF),A
001B2D E826 18DD            12      JR  POP_IX_DE_BC_HL_RET
                                
       E828                     NCL1:
001B2F E828 7A               4      LD  A,D
001B30 E829 B3               4      OR  E
001B31 E82A 37               4      SCF
001B32 E82B C8              11      RET Z
                                
001B33 E82C 7A               4      LD  A,D
001B34 E82D CB3F             8      SRL A   ;/2
001B36 E82F CB3F             8      SRL A   ;/2
                                
001B38 E831 E5              11      PUSH    HL
001B39 E832 3251E8          13      LD  (NCLPAT+2),A    ;_FATIX
001B3C E835 2AAAEF          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001B3F E838 BC               4      CP  H
001B40 E839 3A88EF          13      LD  A,(_DRV)    ;この間でフラグは変化しない
001B43 E83C 3250E8          13      LD  (NCLPAT+1),A    ;_FATDRV
001B46 E83F 2005            12      JR  NZ,NCL2     ;FATIXが違う
001B48 E841 BD               4      CP  L
001B49 E842 2002            12      JR  NZ,NCL2     ;ドライブが違う
001B4B E844 E1              10      POP HL
001B4C E845 C9              10      RET
       E846                     NCL2:
001B4D E846 C5              11      PUSH    BC
001B4E E847 D5              11      PUSH    DE
001B4F E848 DDE5            15      PUSH    IX
001B51 E84A CD09E8          17      CALL    WTFATX
001B54 E84D 38B6            12      JR  C,POP_IX_DE_BC_HL_RET
001B56 E84F 010000          10  NCLPAT: LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
001B59 E852 ED43AAEF        20      LD  (_FATDRV),BC
001B5D E856 CD72EA          17      CALL    RDFATS
001B60 E859 18A4            12      JR  RDFATE2
                                
       E85B                     NCL3:
001B62 E85B CB9A             8      RES 3,D
001B64 E85D CB92             8      RES 2,D
001B66 E85F 6B               4      LD  L,E
001B67 E860 62               4      LD  H,D
001B68 E861 CB3C             8      SRL H   ;
001B6A E863 CB1D             8      RR  L   ;HLA=HLA/2
001B6C E865 1F               4      RRA     ;
001B6D E866 F5              11      PUSH    AF
001B6E E867 3AABEF          13      LD  A,(_FATIX)
001B71 E86A 0F               4      RRCA
001B72 E86B 300B            12      JR  NC,NCL3X1
001B74 E86D 3A95E6          13      LD  A,(SECSZ+2)
001B77 E870 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
001B79 E872 2004            12      JR  NZ,NCL3X1
001B7B E874 010002          10      LD  BC,512
001B7E E877 09              11      ADD HL,BC
       E878                     NCL3X1:
001B7F E878 F1              10      POP AF
001B80 E879 ED4B7CF0        20      LD  BC,(_FATBF)
001B84 E87D 19              11      ADD HL,DE
001B85 E87E 09              11      ADD HL,BC
001B86 E87F 17               4      RLA
001B87 E880 C9              10      RET
                                
       E881                     GNCL:
001B88 E881 CD28E8          17      CALL    NCL1        ;GET NEXT CLUSTER
001B8B E884 D8              11      RET C
001B8C E885 C5              11      PUSH    BC
001B8D E886 E5              11      PUSH    HL
001B8E E887 CD5BE8          17      CALL    NCL3
001B91 E88A 3809            12      JR  C,GNC1
001B93 E88C 5E               7      LD  E,(HL)
001B94 E88D 23               6      INC HL
001B95 E88E 7E               7      LD  A,(HL)
001B96 E88F E60F             7      AND 00FH
001B98 E891 57               4      LD  D,A
001B99 E892 E1              10      POP HL
001B9A E893 C1              10      POP BC
001B9B E894 C9              10      RET
       E895                     GNC1:
001B9C E895 7E               7      LD  A,(HL)
001B9D E896 23               6      INC HL
001B9E E897 56               7      LD  D,(HL)
001B9F E898 0604             7      LD  B,4
       E89A                     GNC1L:
001BA1 E89A CB3A             8      SRL D   ;DA=DA/2
001BA3 E89C 1F               4      RRA     ;
001BA4 E89D 10FB            13      DJNZ    GNC1L
                                
001BA6 E89F 5F               4      LD  E,A
001BA7 E8A0 E1              10      POP HL
001BA8 E8A1 C1              10      POP BC
001BA9 E8A2 A7               4      AND A
001BAA E8A3 C9              10      RET
                                
       E8A4                     SNCL:
001BAB E8A4 CD28E8          17      CALL    NCL1
001BAE E8A7 D8              11      RET C
                                ;               SET NEXT CLUSTER
001BAF E8A8 E5              11      PUSH    HL
001BB0 E8A9 C5              11      PUSH    BC
001BB1 E8AA D5              11      PUSH    DE
001BB2 E8AB E5              11      PUSH    HL
001BB3 E8AC CD5BE8          17      CALL    NCL3
001BB6 E8AF D1              10      POP DE
                                ;CF=ODD
001BB7 E8B0 7E               7      LD  A,(HL)
001BB8 E8B1 73               7      LD  (HL),E
001BB9 E8B2 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
001BBB E8B4 23               6      INC HL
001BBC E8B5 ED67            18      RRD     ;M={A[3:0],E[3:0]}
001BBE E8B7 7A               4      LD  A,D
001BBF E8B8 1804            12      JR  SNC11
       E8BA                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
001BC1 E8BA ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001BC3 E8BC 23               6      INC HL
001BC4 E8BD 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E8BE                     SNC11:
001BC5 E8BE ED6F            18      RLD     ;M={M[7:4],D[3:0]}
001BC7 E8C0 B7               4      OR  A
001BC8 E8C1 D1              10      POP DE
001BC9 E8C2 C1              10      POP BC
001BCA E8C3 E1              10      POP HL
       E8C4                     FAT_CHANGED:
001BCB E8C4 3E01             7      LD  A,1
001BCD E8C6 32A2EF          13      LD  (_WTFATF),A
001BD0 E8C9 C9              10      RET
                                
       E8CA                     N16CL3:
001BD1 E8CA C5              11      PUSH    BC
001BD2 E8CB 6B               4      LD  L,E
001BD3 E8CC 7A               4      LD  A,D
001BD4 E8CD E603             7      AND 3
001BD6 E8CF 67               4      LD  H,A
001BD7 E8D0 29              11      ADD HL,HL
001BD8 E8D1 ED4B7CF0        20      LD  BC,(_FATBF)
001BDC E8D5 09              11      ADD HL,BC
001BDD E8D6 C1              10      POP BC
001BDE E8D7 C9              10      RET
                                
       E8D8                     GNCL16:
001BDF E8D8 CD28E8          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
001BE2 E8DB D8              11      RET C
001BE3 E8DC E5              11      PUSH    HL
001BE4 E8DD CDCAE8          17      CALL    N16CL3
001BE7 E8E0 5E               7      LD  E,(HL)
001BE8 E8E1 23               6      INC HL
001BE9 E8E2 56               7      LD  D,(HL)
001BEA E8E3 E1              10      POP HL
001BEB E8E4 C9              10      RET
                                
       E8E5                     SNCL16:
001BEC E8E5 CD28E8          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
001BEF E8E8 D8              11      RET C
001BF0 E8E9 D5              11      PUSH    DE
001BF1 E8EA E5              11      PUSH    HL
001BF2 E8EB CDCAE8          17      CALL    N16CL3
001BF5 E8EE D1              10      POP DE      ;HL
001BF6 E8EF 73               7      LD  (HL),E
001BF7 E8F0 23               6      INC HL
001BF8 E8F1 72               7      LD  (HL),D
001BF9 E8F2 6B               4      LD  L,E
001BFA E8F3 62               4      LD  H,D
001BFB E8F4 D1              10      POP DE
001BFC E8F5 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E8F7                     NEXTX:
001BFE E8F7 3E00             7  _SECPS: LD  A,0 ;自己書き換え
001C00 E8F9 3C               4      INC A
001C01 E8FA E600             7  NCPAT:  AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
001C03 E8FC 32F8E8          13      LD  (_SECPS+1),A
001C06 E8FF C9              10      RET
                                
       E900                     GNCLX:
001C07 E900 CDF7E8          17      CALL    NEXTX
001C0A E903 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001C0B E904 C3F7EF          10      JP  _GNCL   ;次のクラスタを探す
                                
       E907                     RDFAT:
001C0E E907 3E80             7      LD  A,080H
001C10 E909 3270EF          13      LD  (CHECK),A
       E90C                     RDFAT1:
001C13 E90C 3A88EF          13      LD  A,(_DRV)
001C16 E90F CDC7EB          17      CALL    CHGDRVR
001C19 E912 D8              11      RET C
001C1A E913 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001C1D E916 CB6F             8      BIT 5,A
001C1F E918 286B            12      JR  Z,RDFAT0X
001C21 E91A 2170EF          10      LD  HL,CHECK
001C24 E91D A6               7      AND (HL)
001C25 E91E 77               7      LD  (HL),A
001C26 E91F 110000          10      LD  DE,0        ;BPB
001C29 E922 2A7CF0          16      LD  HL,(_FATBF)
001C2C E925 CD7EEA          17      CALL    DRD16
001C2F E928 3024            12      JR  NC,GETBPB
001C31 E92A 2170EF          10      LD  HL,CHECK
001C34 E92D CB06            15      RLC (HL)
001C36 E92F 3F               4      CCF
001C37 E930 D8              11      RET C
001C38 E931 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
001C3C E935 3F               4      CCF         ;フロッピーディスクのFDモードを切り替える
001C3D E936 DDCB0A16        23      RL  (IX+DPB_FDMODE)
001C41 E93A 3EFF             7      LD  A,0FFH
001C43 E93C 3289EF          13      LD  (_DSK),A
001C46 E93F 3A84EF          13      LD  A,(_DRIVE)
001C49 E942 E603             7      AND 3
001C4B E944 F680             7      OR  080H
001C4D E946 6F               4      LD  L,A
001C4E E947 26EF             7      LD  H,_CYL0/256
001C50 E949 3EFF             7      LD  A,0FFH
001C52 E94B 77               7      LD  (HL),A
001C53 E94C 18BE            12      JR  RDFAT1
       E94E                     GETBPB:
001C55 E94E FDE5            15      PUSH    IY
001C57 E950 FD2A7CF0        20      LD  IY,(_FATBF) ;BPB
001C5B E954 CDF1EF          17      CALL    _BPB2DPB
001C5E E957 FDE1            14      POP IY
001C60 E959 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001C63 E95C 3021            12      JR  NC,GETBPBOK
001C65 E95E E60F             7      AND 00FH
001C67 E960 FE07             7      CP  7
001C69 E962 37               4      SCF
001C6A E963 C0              11      RET NZ
001C6B E964 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001C6F E968 21C0F0          10      LD  HL,M2D
001C72 E96B 2002            12      JR  NZ,SETFDMODE
001C74 E96D 2ED2             7      LD  L,M2HD-STABLE
       E96F                     SETFDMODE:
001C76 E96F DDE5            15      PUSH    IX
001C78 E971 D1              10      POP DE
001C79 E972 EDA0            16      LDI
001C7B E974 EDA0            16      LDI
001C7D E976 13               6      INC DE
001C7E E977 13               6      INC DE
001C7F E978 13               6      INC DE
001C80 E979 13               6      INC DE
001C81 E97A 010C00          10      LD  BC,12
001C84 E97D EDB0                    LDIR
       E97F                     GETBPBOK:
001C86 E97F 328EE9          13      LD  (DEVSWC),A
001C89 E982 CD26EB          17      CALL    CHGDRV2
       E985                     RDFAT0X:
001C8C E985 CD72EA          17      CALL    RDFATS
001C8F E988 D8              11      RET C
001C90 E989 DDAE06          19      XOR (IX+DPB_FATID)
001C93 E98C C8              11      RET Z
001C94 E98D 3E00             7      LD  A,0     ;DPB_DEVICE
       E98E                     DEVSWC  EQU $-1
001C96 E98F CB6F             8      BIT 5,A
001C98 E991 C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
001C99 E992 37               4      SCF
001C9A E993 C9              10      RET
                                
       E994                     BPB2DPB:
001C9B E994 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
001C9E E997 B7               4      OR  A
001C9F E998 37               4      SCF
001CA0 E999 C0              11      RET NZ
       E99A                     BPBOK:
001CA1 E99A FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001CA4 E99D DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001CA7 E9A0 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001CAA E9A3 DD7700          19      LD  (IX+DPB_FATLN),A
001CAD E9A6 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
001CB0 E9A9 DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
001CB3 E9AC FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001CB6 E9AF FD660F          19      LD  H,(IY+15)
001CB9 E9B2 DD750E          19      LD  (IX+DPB_FATPS),L
001CBC E9B5 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001CBF E9B8 FD5617          19      LD  D,(IY+23)
001CC2 E9BB FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E9BE                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001CC5 E9BE 19              11      ADD HL,DE
001CC6 E9BF 10FD            13      DJNZ    BPBDP1
       E9C1                     BPBDP2:
001CC8 E9C1 DD7510          19      LD  (IX+DPB_DIRPS),L
001CCB E9C4 DD7411          19      LD  (IX+DPB_DIRPS+1),H
001CCE E9C7 E5              11      PUSH    HL
                                
001CCF E9C8 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
001CD2 E9CB FD6612          19      LD  H,(IY+18)
001CD5 E9CE FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001CD8 E9D1 B7               4      OR  A
001CD9 E9D2 37               4      SCF
001CDA E9D3 C8              11      RET Z
001CDB E9D4 0606             7      LD  B,6
       E9D6                     BPBBPS1:
001CDD E9D6 05               4      DEC B
001CDE E9D7 0F               4      RRCA
001CDF E9D8 30FC            12      JR  NC,BPBBPS1
       E9DA                     BPBDE1:
001CE1 E9DA 29              11      ADD HL,HL
001CE2 E9DB 10FD            13      DJNZ    BPBDE1
                                
001CE4 E9DD 7C               4      LD  A,H
001CE5 E9DE DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
001CE8 E9E1 D1              10      POP DE      ;DPB_DIRPS
001CE9 E9E2 6C               4      LD  L,H
001CEA E9E3 2600             7      LD  H,0
001CEC E9E5 19              11      ADD HL,DE       ;MAXDIR
001CED E9E6 E5              11      PUSH    HL
001CEE E9E7 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001CF1 E9EA CB21             8      SLA C       ;*2
001CF3 E9EC AF               4      XOR A
001CF4 E9ED 47               4      LD  B,A
001CF5 E9EE ED42            15      SBC HL,BC
001CF7 E9F0 DD7514          19      LD  (IX+DPB_ADDCL),L
001CFA E9F3 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
001CFD E9F6 D1              10      POP DE      ;DE=DPB_MAXDIR
001CFE E9F7 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001D01 E9FA FD6614          19      LD  H,(IY+20)
                                
001D04 E9FD DD7E12          19      LD  A,(IX+DPB_DEVICE)
001D07 EA00 E60F             7      AND 00FH
001D09 EA02 FE07             7      CP  7       ;フロッピー
001D0B EA04 2019            12      JR  NZ,NOT_FD
001D0D EA06 E5              11      PUSH    HL
001D0E EA07 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001D11 EA0A DD710D          19      LD  (IX+DPB_MAXSEC),C
001D14 EA0D AF               4      XOR A
001D15 EA0E CB21             8      SLA C       ;両面なのでセクタ数を２倍
001D17 EA10 0610             7      LD  B,16
       EA12                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001D19 EA12 29              11      ADD HL,HL
001D1A EA13 17               4      RLA
001D1B EA14 B9               4      CP  C
001D1C EA15 3802            12      JR  C,DIVSEC1
001D1E EA17 91               4      SUB C
001D1F EA18 2C               4      INC L
       EA19                     DIVSEC1:
001D20 EA19 10F7            13      DJNZ    DIVSEC
001D22 EA1B DD750C          19      LD  (IX+DPB_MAXCYL),L
001D25 EA1E E1              10      POP HL  ;ここまでフロッピー専用
       EA1F                     NOT_FD:
001D26 EA1F 7C               4      LD  A,H
001D27 EA20 B5               4      OR  L
001D28 EA21 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001D2A EA23 2010            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001D2C EA25 FD7E23          19      LD  A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001D2F EA28 B7               4      OR  A
001D30 EA29 37               4      SCF
001D31 EA2A C0              11      RET NZ
001D32 EA2B FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001D35 EA2E FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので
001D38 EA31 FD7E22          19      LD  A,(IY+34)   ;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
001D3B EA34 A7               4      AND A       ;CF=0
       EA35                     BPB16BIT:
001D3C EA35 ED52            15      SBC HL,DE
001D3E EA37 DE00             7      SBC A,0
001D40 EA39 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       EA3C                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001D43 EA3C CB18             8      RR  B       ;->CY
001D45 EA3E 3808            12      JR  C,BPBTC2
001D47 EA40 CB3F             8      SRL A
001D49 EA42 CB1C             8      RR  H       ;AHL=AHL/2
001D4B EA44 CB1D             8      RR  L
001D4D EA46 18F4            12      JR  BPBTC1
       EA48                     BPBTC2:
001D4F EA48 B7               4      OR  A
001D50 EA49 37               4      SCF
001D51 EA4A C0              11      RET NZ      ;念のため(クラスタ数が16ビットを超える場合)
001D52 EA4B 23               6      INC HL
001D53 EA4C 23               6      INC HL
001D54 EA4D DD7508          19      LD  (IX+DPB_MAXCL),L
001D57 EA50 DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001D5A EA53 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001D5D EA56 DD7706          19      LD  (IX+DPB_FATID),A
                                
001D60 EA59 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001D63 EA5C C6FE             7      ADD A,0-2       ;>2:CF=1
001D65 EA5E FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001D68 EA61 6F               4      LD  L,A
001D69 EA62 3002            12      JR  NC,BPBFAT1
001D6B EA64 F680             7      OR  080H
       EA66                     BPBFAT1:            ;ここではCF=0
001D6D EA66 DD770F          19      LD  (IX+DPB_BPS),A
001D70 EA69 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001D71 EA6A C8              11      RET Z       ;1セクタ256バイト
001D72 EA6B 2D               4      DEC L
001D73 EA6C C8              11      RET Z       ;1セクタ512バイト
001D74 EA6D 2D               4      DEC L
001D75 EA6E 2D               4      DEC L
001D76 EA6F C8              11      RET Z       ;1セクタ1024バイト
001D77 EA70 37               4      SCF
001D78 EA71 C9              10      RET
                                
       EA72                     RDFATS:
001D79 EA72 CDB8EA          17      CALL    FATSETUP
001D7C EA75 D8              11      RET C
001D7D EA76 CD82EA          17      CALL    DRD24B
001D80 EA79 2A7CF0          16      LD  HL,(_FATBF)
001D83 EA7C 7E               7      LD  A,(HL)
001D84 EA7D C9              10      RET
                                
       EA7E                     DRD16:
001D85 EA7E 0E00             7      LD  C,0
       EA80                     DRD24:
001D87 EA80 0601             7      LD  B,1
       EA82                     DRD24B:
001D89 EA82 DDE5            15      PUSH    IX
001D8B EA84 DD2AA8EF        20      LD  IX,(_DPB)
001D8F EA88 CD5CED          17  DRDPAT: CALL    FDRD        ;自己書き換え（ディスク読み込み）
       EA8B                     POP_IX_RET:
001D92 EA8B DDE1            14      POP IX
001D94 EA8D C9              10      RET
                                
       EA8E                     DWT16:
001D95 EA8E 0E00             7      LD  C,0
       EA90                     DWT24:
001D97 EA90 0601             7      LD  B,1
       EA92                     DWT24B:
001D99 EA92 DDE5            15      PUSH    IX
001D9B EA94 DD2AA8EF        20      LD  IX,(_DPB)
001D9F EA98 CDC0EC          17  DWTPAT: CALL    FDWT        ;自己書き換え（ディスク書き込み）
001DA2 EA9B 18EE            12      JR  POP_IX_RET
                                
       EA9D                     WTFAT:
001DA4 EA9D CDB8EA          17      CALL    FATSETUP
001DA7 EAA0 D492EA          17      CALL    NC,DWT24B
001DAA EAA3 D8              11      RET C
001DAB EAA4 DDCB0F7E        20      BIT 7,(IX+DPB_BPS)
001DAF EAA8 C8              11      RET Z       ;予備FATが無い
001DB0 EAA9 CDBFEA          17      CALL    FATS2
001DB3 EAAC E5              11      PUSH    HL      ;予備FAT
001DB4 EAAD DD6E00          19      LD  L,(IX+DPB_FATLN)
001DB7 EAB0 DD6601          19      LD  H,(IX+DPB_FATLN+1)
001DBA EAB3 19              11      ADD HL,DE
001DBB EAB4 EB               4      EX  DE,HL
001DBC EAB5 E1              10      POP HL
001DBD EAB6 18DA            12      JR  DWT24B
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ1024毎に2KBを切り替える
                                ;------------------------
       EAB8                     FATSETUP:
001DBF EAB8 3AAAEF          13      LD  A,(_FATDRV)
001DC2 EABB CDC7EB          17      CALL    CHGDRVR     ;ドライブ切り替え
001DC5 EABE D8              11      RET C
       EABF                     FATS2:
001DC6 EABF DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001DC9 EAC2 0F               4      RRCA
001DCA EAC3 CDECEA          17  FATSX:  CALL    FATSETUP12  ;自己書き換え
001DCD EAC6 210000          10      LD  HL,0
001DD0 EAC9 4A               4      LD  C,D
001DD1 EACA 54               4      LD  D,H
001DD2 EACB 3AABEF          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
001DD5 EACE 47               4      LD  B,A
001DD6 EACF 04               4      INC B
001DD7 EAD0 DD7E00          19      LD  A,(IX+DPB_FATLN)
       EAD3                     FAT_SKP:
001DDA EAD3 05               4      DEC B
001DDB EAD4 2805            12      JR  Z,FAT1
001DDD EAD6 19              11      ADD HL,DE
001DDE EAD7 93               4      SUB E
001DDF EAD8 30F9            12      JR  NC,FAT_SKP
001DE1 EADA C9              10      RET
       EADB                     FAT1:
001DE2 EADB EB               4      EX  DE,HL
001DE3 EADC B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001DE4 EADD 3801            12      JR  C,FAT2
001DE6 EADF 79               4      LD  A,C
       EAE0                     FAT2:
001DE7 EAE0 47               4      LD  B,A
                                
001DE8 EAE1 2AFAF0          16      LD  HL,(_FATPS) ;fat sector pos
001DEB EAE4 19              11      ADD HL,DE
001DEC EAE5 EB               4      EX  DE,HL
001DED EAE6 2A7CF0          16      LD  HL,(_FATBF)
001DF0 EAE9 AF               4      XOR A       ;CF=0
001DF1 EAEA 4F               4      LD  C,A
001DF2 EAEB C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       EAEC                     FATSETUP12:
001DF3 EAEC 110606          10      LD  DE,0606H    ;256
001DF6 EAEF D8              11      RET C
001DF7 EAF0 110303          10      LD  DE,0303H    ;512
001DFA EAF3 0F               4      RRCA
001DFB EAF4 D8              11      RET C
001DFC EAF5 110102          10      LD  DE,0201H    ;1024
001DFF EAF8 C9              10      RET
                                
       EAF9                     FATSETUP16:
001E00 EAF9 110808          10      LD  DE,0808H    ;256
001E03 EAFC D8              11      RET C
001E04 EAFD 110404          10      LD  DE,0404H
001E07 EB00 0F               4      RRCA            ;512
001E08 EB01 D8              11      RET C
001E09 EB02 110202          10      LD  DE,0202H    ;1024
001E0C EB05 C9              10      RET
                                
       EB06                     CHGDRV:
001E0D EB06 E5              11      PUSH    HL
001E0E EB07 2189EF          10      LD  HL,_DSK
001E11 EB0A BE               7      CP  (HL)
001E12 EB0B 280A            12      JR  Z,CHGDRVE
       EB0D                     CHGDRV1:
001E14 EB0D DDE5            15      PUSH    IX
001E16 EB0F CD19EB          17      CALL    CHGDRV0
001E19 EB12 3A89EF          13      LD  A,(_DSK)
001E1C EB15 DDE1            14      POP IX
       EB17                     CHGDRVE:
001E1E EB17 E1              10      POP HL
001E1F EB18 C9              10      RET
                                
       EB19                     CHGDRV0:
001E20 EB19 6F               4      LD  L,A
001E21 EB1A CDDCEF          17      CALL    _GETDPB
001E24 EB1D D8              11      RET C
001E25 EB1E DD22A8EF        20      LD  (_DPB),IX
001E29 EB22 7D               4      LD  A,L
001E2A EB23 3289EF          13      LD  (_DSK),A
       EB26                     CHGDRV2:
001E2D EB26 C5              11      PUSH    BC
001E2E EB27 D5              11      PUSH    DE
001E2F EB28 ED737DEB        20      LD  (SPPAT2+1),SP
001E33 EB2C F3               4      DI
001E34 EB2D DDF9            10      LD  SP,IX
                                
001E36 EB2F E1              10      POP HL      ;00:DPB_FATLN
001E37 EB30 E1              10      POP HL      ;02:DPB_DRD
001E38 EB31 2289EA          16      LD  (DRDPAT+1),HL
                                
001E3B EB34 E1              10      POP HL
001E3C EB35 2299EA          16      LD  (DWTPAT+1),HL   ;04:DPB_DWT
                                
001E3F EB38 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001E40 EB39 7C               4      LD  A,H
001E41 EB3A 3285E1          13      LD  (SPCPAT+1),A    ;1クラスタの論理セクタ数
001E44 EB3D 3D               4      DEC A
001E45 EB3E 32FBE8          13      LD  (NCPAT+1),A
                                
001E48 EB41 E1              10      POP HL      ;08:DPB_MAXCL
001E49 EB42 7D               4      LD  A,L
001E4A EB43 32A4E1          13      LD  (CLPAT2+1),A
001E4D EB46 7C               4      LD  A,H
001E4E EB47 32A0E1          13      LD  (CLPAT1+1),A
001E51 EB4A 2B               6      DEC HL
001E52 EB4B 22ACE3          16      LD  (MAXCLP+1),HL
                                
001E55 EB4E E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001E56 EB4F 7D               4      LD  A,L
001E57 EB50 F6FE             7      OR  0FEH
001E59 EB52 328BED          13      LD  (FDMODE+1),A
001E5C EB55 07               4      RLCA
001E5D EB56 E603             7      AND 3
001E5F EB58 326BEF          13      LD  (FSPAT+1),A
001E62 EB5B 4C               4      LD  C,H
                                
001E63 EB5C E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001E64 EB5D E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001E65 EB5E 7C               4      LD  A,H     ;DPB_BPS
001E66 EB5F E607             7      AND 7
001E68 EB61 3295E6          13      LD  (SECSZ+2),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98
                                                ;1セクタ256 GRAM/RAMF/CMOS/等
                                                ;1024   512 256
                                                ;4  2   1
001E6B EB64 87               4      ADD A,A     ;8  4   2
001E6C EB65 87               4      ADD A,A     ;010H   8   4
001E6D EB66 87               4      ADD A,A     ;020H   010H    8
001E6E EB67 3201E0          13      LD  (SDECPAT+1),A   ;1セクタ辺りのディレクトリエントリ数
                                
001E71 EB6A 2600             7      LD  H,0
001E73 EB6C 22FAF0          16      LD  (_FATPS),HL
                                
001E76 EB6F E1              10      POP HL      ;10:DPB_DIRPS
001E77 EB70 22FCF0          16      LD  (_DIRPS),HL
                                
001E7A EB73 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001E7B EB74 7C               4      LD  A,H
001E7C EB75 3284EF          13      LD  (_DRIVE),A
                                
001E7F EB78 E1              10      POP HL      ;14:DPB_ADDCL
001E80 EB79 2295E1          16      LD  (CLSPAT+1),HL
                                
001E83 EB7C 310000          10  SPPAT2: LD  SP,0        ;元のSPを復元
001E86 EB7F FB               4      EI
001E87 EB80 2AFCF0          16      LD  HL,(_DIRPS)
001E8A EB83 0600             7      LD  B,0
001E8C EB85 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001E8D EB86 221CE0          16      LD  (MD_PAT+1),HL
                                
001E90 EB89 2AACE3          16      LD  HL,(MAXCLP+1);
001E93 EB8C 11F60F          10      LD  DE,4086     ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001E96 EB8F ED52            15      SBC HL,DE       ;CF=0のはず
001E98 EB91 300F            12      JR  NC,SETFAT16
001E9A EB93 2181E8          10      LD  HL,GNCL     ;FAT12
001E9D EB96 11A4E8          10      LD  DE,SNCL
001EA0 EB99 01ECEA          10      LD  BC,FATSETUP12
001EA3 EB9C DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001EA7 EBA0 180D            12      JR  EXTRA1
       EBA2                     SETFAT16:
001EA9 EBA2 21D8E8          10      LD  HL,GNCL16   ;FAT16
001EAC EBA5 11E5E8          10      LD  DE,SNCL16
001EAF EBA8 01F9EA          10      LD  BC,FATSETUP16
001EB2 EBAB DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       EBAF                     EXTRA1:
001EB6 EBAF 22F8EF          16      LD  (GNCPAT+1),HL
001EB9 EBB2 ED53FBEF        20      LD  (SNCPAT+1),DE
001EBD EBB6 ED43C4EA        20      LD  (FATSX+1),BC
001EC1 EBBA D1              10      POP DE
001EC2 EBBB C1              10      POP BC
001EC3 EBBC AF               4      XOR A
001EC4 EBBD C9              10      RET
                                
       EBBE                     GETDPBD:
001EC5 EBBE DDE3            23      EX  (SP),IX
001EC7 EBC0 DDE5            15      PUSH    IX
001EC9 EBC2 3A88EF          13      LD  A,(_DRV)
001ECC EBC5 1807            12      JR  GETDPB1
                                
       EBC7                     CHGDRVR:
001ECE EBC7 CDD9EF          17      CALL    _CHGDRV
001ED1 EBCA D8              11      RET C
001ED2 EBCB 3A89EF          13      LD  A,(_DSK)
       EBCE                     GETDPB1:
001ED5 EBCE C3DCEF          10      JP  _GETDPB
                                
       EBD1                     GETDPB:
001ED8 EBD1 FE08             7      CP  8
001EDA EBD3 3F               4      CCF
001EDB EBD4 D8              11      RET C
001EDC EBD5 0F               4      RRCA
001EDD EBD6 0F               4      RRCA
001EDE EBD7 0F               4      RRCA
001EDF EBD8 DD                      DB  0DDH        ;Z80未定義命令
001EE0 EBD9 6F               4      LD  L,A     ;LD IXL,A
001EE1 EBDA DD                      DB  0DDH        ;Z80未定義命令
001EE2 EBDB 26F2             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001EE4 EBDD DD7E00          19      LD  A,(IX+DPB_FATLN)
001EE7 EBE0 A7               4      AND A       ;CF=0の為
001EE8 EBE1 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001EEC EBE5 C0              11      RET NZ      ;FAT16
001EED EBE6 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001EF1 EBEA C0              11      RET NZ      ;BPB
001EF2 EBEB FE01             7      CP  001H        ;A=0 THEN CF=1
001EF4 EBED C9              10      RET
                                
       EBEE                     _SYS5F:
001EF5 EBEE AF               4      XOR A
       EBEF                     FFLUSH:
001EF6 EBEF F5              11      PUSH    AF
001EF7 EBF0 CD09E8          17      CALL    WTFATX
001EFA EBF3 AF               4      XOR A
001EFB EBF4 32ABEF          13      LD  (_FATIX),A
001EFE EBF7 2F               4      CPL         ;0FFH
001EFF EBF8 32AAEF          13      LD  (_FATDRV),A
001F02 EBFB 3E                      DB  03EH        ;次のPUSH AFをスキップ
       EBFC                     FFLUSHBUF:
001F03 EBFC F5              11      PUSH    AF
001F04 EBFD CDBFE7          17      CALL    DWTX
001F07 EC00 3EFF             7      LD  A,0FFH
001F09 EC02 3239EF          13      LD  (SFILE),A
001F0C EC05 32A5EF          13      LD  (_DBDRV),A
001F0F EC08 F1              10      POP AF
001F10 EC09 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "88DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   PC-8801mkIISR
                                
                                ;   FLOPPY DISK DRIVER
                                ;
                                ;   コマンド送信
       EC0A                     PUTCOM:
001F11 EC0A F5              11      PUSH    AF
001F12 EC0B 3E0F             7      LD  A,00FH
001F14 EC0D D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
001F16 EC0F F1              10      POP AF
                                ;   通常ハンドシェイク（ホストが送信）
       EC10                     PUTDAT:
001F17 EC10 F5              11      PUSH    AF
       EC11                     PUTDAT1:
001F18 EC11 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001F1A EC13 E602             7      AND 2       ;RFD
001F1C EC15 28FA            12      JR  Z,PUTDAT1
001F1E EC17 3E0E             7      LD  A,00EH      ;ATN=0
001F20 EC19 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
001F22 EC1B F1              10      POP AF
001F23 EC1C D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
001F25 EC1E F5              11      PUSH    AF
001F26 EC1F 3E09             7      LD  A,9     ;DAV=1
001F28 EC21 D3FF            11      OUT (0FFH),A
       EC23                     PUTDAT2:
001F2A EC23 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001F2C EC25 E604             7      AND 4       ;DAC
001F2E EC27 28FA            12      JR  Z,PUTDAT2
                                
001F30 EC29 3E08             7      LD  A,8     ;DAV=0
001F32 EC2B D3FF            11      OUT (0FFH),A
       EC2D                     PUTDAT3:
001F34 EC2D DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001F36 EC2F E604             7      AND 4       ;DAC
001F38 EC31 20FA            12      JR  NZ,PUTDAT3
001F3A EC33 F1              10      POP AF
001F3B EC34 C9              10      RET
                                
                                ;   通常ハンドシェイク（ホストが受信）
       EC35                     GETDAT:
001F3C EC35 3E0B             7      LD  A,00BH      ;RFD=1
001F3E EC37 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
       EC39                     GETDAT1:
001F40 EC39 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001F42 EC3B 0F               4      RRCA            ;DAV
001F43 EC3C 30FB            12      JR  NC,GETDAT1
                                
001F45 EC3E 3E0A             7      LD  A,00AH      ;RFD=0
001F47 EC40 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001F49 EC42 DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001F4B EC44 F5              11      PUSH    AF
001F4C EC45 3E0D             7      LD  A,00DH      ;DAC=1
001F4E EC47 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
       EC49                     GETDAT2:
001F50 EC49 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001F52 EC4B 0F               4      RRCA            ;DAV
001F53 EC4C 38FB            12      JR  C,GETDAT2
                                
001F55 EC4E 3E0C             7      LD  A,00CH      ;DAC=0
001F57 EC50 D3FF            11      OUT (0FFH),A
001F59 EC52 F1              10      POP AF
001F5A EC53 C9              10      RET
                                
                                ;   高速ハンドシェイク（ホストが送信）
                                ;   HL:アドレス BC:受信サイズ（必ず偶数にする）
       EC54                     FPUTDAT:
       EC54                     FPUTDAT1:
001F5B EC54 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001F5D EC56 E602             7      AND 2       ;RFD
001F5F EC58 28FA            12      JR  Z,FPUTDAT1
001F61 EC5A 3E0E             7      LD  A,00EH      ;ATN=0
001F63 EC5C D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001F65 EC5E 7E               7      LD  A,(HL)
001F66 EC5F D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
                                
001F68 EC61 3E09             7      LD  A,9     ;DAV=1
001F6A EC63 D3FF            11      OUT (0FFH),A
001F6C EC65 23               6      INC HL
001F6D EC66 0B               6      DEC BC
       EC67                     FPUTDAT2:
001F6E EC67 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001F70 EC69 E604             7      AND 4       ;DAC
001F72 EC6B 28FA            12      JR  Z,FPUTDAT2
                                
001F74 EC6D 7E               7      LD  A,(HL)
001F75 EC6E D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
                                
001F77 EC70 3E08             7      LD  A,8     ;DAV=0
001F79 EC72 D3FF            11      OUT (0FFH),A
       EC74                     FPUTDAT3:
001F7B EC74 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001F7D EC76 E604             7      AND 4       ;DAC
001F7F EC78 20FA            12      JR  NZ,FPUTDAT3
                                
001F81 EC7A EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001F83 EC7C EA54EC          10      JP  PE,FPUTDAT
001F86 EC7F C9              10      RET
                                
                                
                                ;   高速ハンドシェイク（ホストが受信）
                                ;   HL:アドレス BC:受信サイズ（必ず偶数にする）
       EC80                     FGETDAT:
001F87 EC80 3E0B             7      LD  A,00BH      ;RFD=1
001F89 EC82 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
       EC84                     FGETDAT1:
001F8B EC84 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001F8D EC86 0F               4      RRCA            ;DAV
001F8E EC87 30FB            12      JR  NC,FGETDAT1
                                
001F90 EC89 3E0A             7      LD  A,00AH      ;RFD=0
001F92 EC8B D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001F94 EC8D DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001F96 EC8F 77               7      LD  (HL),A
                                
001F97 EC90 3E0D             7      LD  A,00DH      ;DAC=1
001F99 EC92 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
001F9B EC94 23               6      INC HL
001F9C EC95 0B               6      DEC BC
       EC96                     FGETDAT2:
001F9D EC96 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001F9F EC98 0F               4      RRCA            ;DAV
001FA0 EC99 38FB            12      JR  C,FGETDAT2
                                
001FA2 EC9B DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001FA4 EC9D 77               7      LD  (HL),A
                                
001FA5 EC9E 3E0C             7      LD  A,00CH      ;DAC=0
001FA7 ECA0 D3FF            11      OUT (0FFH),A
                                
001FA9 ECA2 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001FAB ECA4 EA80EC          10      JP  PE,FGETDAT
001FAE ECA7 C9              10      RET
                                
                                ;   論理セクタ番号からトラック番号とセクタ番号を得る
                                ;   in
                                ;   DE:論理セクタ
       ECA8                     CALC_SECTOR:
001FAF ECA8 C5              11      PUSH    BC
001FB0 ECA9 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001FB3 ECAC 0610             7      LD  B,16
001FB5 ECAE AF               4      XOR A
001FB6 ECAF EB               4      EX  DE,HL
       ECB0                     DIV1:
001FB7 ECB0 29              11      ADD HL,HL
001FB8 ECB1 8F               4      ADC A,A
001FB9 ECB2 B9               4      CP  C
001FBA ECB3 3802            12      JR  C,DIV2
001FBC ECB5 91               4      SUB C
001FBD ECB6 2C               4      INC L
       ECB7                     DIV2:
001FBE ECB7 10F7            13      DJNZ    DIV1
                                
001FC0 ECB9 3C               4      INC A   ;最小のセクタは１固定
001FC1 ECBA 55               4      LD  D,L ;TRACK
       ECBB                     DIV3:
001FC2 ECBB 5F               4      LD  E,A ;SECTOR
001FC3 ECBC C1              10      POP BC
001FC4 ECBD C9              10      RET
                                
       ECBE                     WTTRK:
001FC5 ECBE 37               4      SCF
001FC6 ECBF C9              10      RET
       ECC0                     FDWT:
001FC7 ECC0 E5              11      PUSH    HL
001FC8 ECC1 D5              11      PUSH    DE
001FC9 ECC2 CDA8EC          17      CALL    CALC_SECTOR
001FCC ECC5 7A               4      LD  A,D     ;トラック
001FCD ECC6 3226ED          13      LD  (FDWT_TRACK),A
001FD0 ECC9 7B               4      LD  A,E     ;セクタ
001FD1 ECCA 3221ED          13      LD  (FDWT_SECTOR),A
001FD4 ECCD DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001FD7 ECD0 93               4      SUB E
001FD8 ECD1 3C               4      INC A
001FD9 ECD2 67               4      LD  H,A
001FDA ECD3 D1              10      POP DE
001FDB ECD4 3A95E6          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
001FDE ECD7 4F               4      LD  C,A
001FDF ECD8 AF               4      XOR A
       ECD9                     FDWT2:
001FE0 ECD9 81               4      ADD A,C
001FE1 ECDA 13               6      INC DE
001FE2 ECDB 05               4      DEC B
001FE3 ECDC 2807            12      JR  Z,FDWT3
001FE5 ECDE 25               4      DEC H       ;トラック、ヘッドを跨がない
001FE6 ECDF 2804            12      JR  Z,FDWT3
001FE8 ECE1 FE3A             7      CP  03AH        ;バッファとして04000H-07BFFHまで使える
001FEA ECE3 38F4            12      JR  C,FDWT2
       ECE5                     FDWT3:
001FEC ECE5 4F               4      LD  C,A
001FED ECE6 E1              10      POP HL
001FEE ECE7 3E16             7      LD  A,16H       ;高速レシーブメモリ
001FF0 ECE9 CD0AEC          17      CALL    PUTCOM
001FF3 ECEC 3E40             7      LD  A,DSS_DATA/256  ;開始アドレスH
001FF5 ECEE CD10EC          17      CALL    PUTDAT
001FF8 ECF1 AF               4      XOR A       ;開始アドレスL
001FF9 ECF2 CD10EC          17      CALL    PUTDAT
001FFC ECF5 79               4      LD  A,C     ;バイト数H
001FFD ECF6 CD10EC          17      CALL    PUTDAT
002000 ECF9 AF               4      XOR A       ;バイト数L
002001 ECFA CD10EC          17      CALL    PUTDAT
002004 ECFD C5              11      PUSH    BC
002005 ECFE 41               4      LD  B,C
002006 ECFF 0E00             7      LD  C,0
002008 ED01 CD54EC          17      CALL    FPUTDAT
00200B ED04 C1              10      POP BC
00200C ED05 3E0D             7      LD  A,0DH       ;エグゼキュート
00200E ED07 CD0AEC          17      CALL    PUTCOM
002011 ED0A 3E7C             7      LD  A,WRITEDISKEX/256
002013 ED0C CD10EC          17      CALL    PUTDAT
002016 ED0F 3EA3             7      LD  A,WRITEDISKEX%256
002018 ED11 CD10EC          17      CALL    PUTDAT
00201B ED14 DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
00201E ED17 CD10EC          17      CALL    PUTDAT
002021 ED1A DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
002024 ED1D CD10EC          17      CALL    PUTDAT
       ED21                     FDWT_SECTOR EQU $+1
002027 ED20 3E00             7      LD  A,0     ;セクタ
002029 ED22 CD10EC          17      CALL    PUTDAT
       ED26                     FDWT_TRACK  EQU $+1
00202C ED25 3E00             7      LD  A,0     ;トラック
00202E ED27 CD10EC          17      CALL    PUTDAT
002031 ED2A 3A8BED          13      LD  A,(FDMODE+1)    ;フロッピーディスクのモード(DPB_FDMODE)
002034 ED2D CD10EC          17      CALL    PUTDAT
002037 ED30 3A95E6          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
00203A ED33 CD10EC          17      CALL    PUTDAT
00203D ED36 79               4      LD  A,C
00203E ED37 CD10EC          17      CALL    PUTDAT      ;バイト数H
002041 ED3A DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;フロッピーディスクのシリンダ数
002044 ED3D CD10EC          17      CALL    PUTDAT
                                
002047 ED40 3E0D             7      LD  A,0DH       ;エグゼキュート
002049 ED42 CD0AEC          17      CALL    PUTCOM
00204C ED45 3E7E             7      LD  A,RESULTEX/256
00204E ED47 CD10EC          17      CALL    PUTDAT
002051 ED4A 3E13             7      LD  A,RESULTEX%256
002053 ED4C CD10EC          17      CALL    PUTDAT
                                
002056 ED4F CD35EC          17      CALL    GETDAT
002059 ED52 4F               4      LD  C,A
00205A ED53 FE01             7      CP  1
00205C ED55 D8              11      RET C
                                
00205D ED56 78               4      LD  A,B
00205E ED57 B7               4      OR  A
00205F ED58 C2C0EC          10      JP  NZ,FDWT
002062 ED5B C9              10      RET
                                
       ED5C                     FDRD:
002063 ED5C 3E0D             7      LD  A,0DH       ;エグゼキュート
002065 ED5E CD0AEC          17      CALL    PUTCOM
002068 ED61 3E7C             7      LD  A,READDISKEX/256
00206A ED63 CD10EC          17      CALL    PUTDAT
00206D ED66 AF               4      XOR A
00206E ED67 CD10EC          17      CALL    PUTDAT
002071 ED6A DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
002074 ED6D CD10EC          17      CALL    PUTDAT
002077 ED70 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
00207A ED73 CD10EC          17      CALL    PUTDAT
00207D ED76 E5              11      PUSH    HL
00207E ED77 D5              11      PUSH    DE
00207F ED78 CDA8EC          17      CALL    CALC_SECTOR
002082 ED7B 7B               4      LD  A,E     ;セクタ
002083 ED7C CD10EC          17      CALL    PUTDAT
002086 ED7F 7A               4      LD  A,D     ;トラック
002087 ED80 CD10EC          17      CALL    PUTDAT
00208A ED83 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
00208D ED86 93               4      SUB E
00208E ED87 3C               4      INC A
00208F ED88 67               4      LD  H,A
002090 ED89 D1              10      POP DE
002091 ED8A 3EFF             7  FDMODE: LD  A,0FFH      ;フロッピーディスクのモード(DPB_FDMODE)
002093 ED8C CD10EC          17      CALL    PUTDAT
002096 ED8F 3A95E6          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
002099 ED92 CD10EC          17      CALL    PUTDAT
00209C ED95 4F               4      LD  C,A
00209D ED96 AF               4      XOR A
       ED97                     FDRD2:
00209E ED97 81               4      ADD A,C
00209F ED98 13               6      INC DE
0020A0 ED99 05               4      DEC B
0020A1 ED9A 2807            12      JR  Z,FDRD3
0020A3 ED9C 25               4      DEC H       ;トラック、ヘッドを跨がない
0020A4 ED9D 2804            12      JR  Z,FDRD3
0020A6 ED9F FE3A             7      CP  03AH        ;バッファとして04000H-07BFFHまで使える
0020A8 EDA1 38F4            12      JR  C,FDRD2
       EDA3                     FDRD3:
0020AA EDA3 E1              10      POP HL
0020AB EDA4 4F               4      LD  C,A
0020AC EDA5 CD10EC          17      CALL    PUTDAT      ;バイト数H
0020AF EDA8 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;フロッピーディスクのシリンダ数
0020B2 EDAB CD10EC          17      CALL    PUTDAT
                                
0020B5 EDAE 3E0D             7      LD  A,0DH       ;エグゼキュート
0020B7 EDB0 CD0AEC          17      CALL    PUTCOM
0020BA EDB3 3E7E             7      LD  A,RESULTEX/256
0020BC EDB5 CD10EC          17      CALL    PUTDAT
0020BF EDB8 3E13             7      LD  A,RESULTEX%256
0020C1 EDBA CD10EC          17      CALL    PUTDAT
                                
0020C4 EDBD CD35EC          17      CALL    GETDAT
0020C7 EDC0 4F               4      LD  C,A
0020C8 EDC1 FE01             7      CP  1
0020CA EDC3 D8              11      RET C
                                
0020CB EDC4 3E15             7      LD  A,15H       ;高速センドメモリ
0020CD EDC6 CD0AEC          17      CALL    PUTCOM
0020D0 EDC9 3E40             7      LD  A,DSS_DATA/256  ;開始アドレスH
0020D2 EDCB CD10EC          17      CALL    PUTDAT
0020D5 EDCE AF               4      XOR A       ;開始アドレスL
0020D6 EDCF CD10EC          17      CALL    PUTDAT
0020D9 EDD2 79               4      LD  A,C     ;バイト数H
0020DA EDD3 CD10EC          17      CALL    PUTDAT
0020DD EDD6 AF               4      XOR A       ;バイト数L
0020DE EDD7 CD10EC          17      CALL    PUTDAT
0020E1 EDDA C5              11      PUSH    BC
0020E2 EDDB 41               4      LD  B,C
0020E3 EDDC 0E00             7      LD  C,0
0020E5 EDDE CD80EC          17      CALL    FGETDAT
0020E8 EDE1 C1              10      POP BC
0020E9 EDE2 78               4      LD  A,B
0020EA EDE3 B7               4      OR  A
0020EB EDE4 C25CED          10      JP  NZ,FDRD
0020EE EDE7 C9              10      RET
                                
       EF6A                     FSPAT   EQU BEEPD+9
                                
[EOF:88DISK.ASM:UTF_8]
                                    INCLUDE "88INTVEC.ASM"
                                
                                ;   LSX-Dodgers TABLE 割り込みベクタとキーのテーブル(Shift/Ctrl)
                                
       EDE8                     AT_TABLE:
0020EF EDE8                         DS  INTAD-AT_TABLE
                                
                                ;
                                ;   割り込みベクタ:アドレス下位1バイトが0になるように
                                ;
       EE00                     IRXRDY:
002107 EE00 6ED9                    DW  INTE88
       EE02                     IVRTC:
002109 EE02 38D9                    DW  INTVRTC
       EE04                     ICLOCK:
00210B EE04 6ED9                    DW  INTE88
       EE06                     IINT4:
00210D EE06 6ED9                    DW  INTE88
       EE08                     IINT3:
00210F EE08 6ED9                    DW  INTE88
       EE0A                     IINT2:
002111 EE0A 6ED9                    DW  INTE88
       EE0C                     IFDINT1:
002113 EE0C 6ED9                    DW  INTE88
       EE0E                     IFDINT2:
002115 EE0E 6ED9                    DW  INTE88
                                
002117 EE10                         DS  030H-18
       EE2E                     EXTSP:
                                
       EE2E                     SHIFT_TABLE:
002135 EE2E 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
00213D EE36 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
002145 EE3E 4041424344454647        DB  '@','A','B','C','D','E','F','G' ;2
00214D EE46 48494A4B4C4D4E4F        DB  'H','I','J','K','L','M','N','O' ;3
002155 EE4E 5051525354555657        DB  'P','Q','R','S','T','U','V','W' ;4
00215D EE56 58595A7B7C7D7E3D        DB  'X','Y','Z','{','|','}','~','=' ;5
002165 EE5E 3021222324252627        DB  '0','!','"','#','$','%','&',27H ;6
00216D EE66 28292A2B3C3E3F5F        DB  '(',')','*','+','<','>','?','_' ;7
002175 EE6E 0B1E1C0800000000        DB  0BH,1EH,1CH,08H,00H,00H,00H,00H ;8
00217D EE76 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
002185 EE7E 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
00218D EE86 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
002195 EE8E 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
                                
       EE96                     CTRL_TABLE:
00219D EE96 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
0021A5 EE9E 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
0021AD EEA6 4001020304050607        DB  '@',01H,02H,03H,04H,05H,06H,07H ;2
0021B5 EEAE 08090A0B0C0D0E0F        DB  08H,09H,0AH,0BH,0CH,0DH,0EH,0FH ;3
0021BD EEB6 1011121314151617        DB  10H,11H,12H,13H,14H,15H,16H,17H ;4
0021C5 EEBE 18191A5B5C5D5E2D        DB  18H,19H,1AH,'[',5CH,']','^','-' ;5
0021CD EEC6 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;6
0021D5 EECE 38393A3B2C2E2F5F        DB  '8','9',':',';',',','.','/','_' ;7
0021DD EED6 0C1E1C0800000000        DB  0CH,1EH,1CH,08H,00H,00H,00H,00H ;8
0021E5 EEDE 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
0021ED EEE6 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
0021F5 EEEE 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
0021FD EEF6 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
[EOF:88INTVEC.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
       EEFE                     AT_WORK:
002205 EEFE                         DS  WORKAD-AT_WORK
                                
       EF00                     CPM_BOOT:
002207 EF00 C30000          10      JP  0
       EF03                     _SYS00:     ;(BDOS)プログラム終了
       EF03                     CPM_WBOOT:
00220A EF03 C309D1          10      JP  WBOOT1
       EF06                     CPM_CONST:
00220D EF06 C315DA          10      JP  CONSTX
       EF09                     _SYS07:     ;(BDOS)コンソール直接入力
       EF09                     CPM_CONIN:
002210 EF09 C3CDD9          10      JP  FLGET
       EF0C                     CPM_CONOUT:
002213 EF0C C34FDC          10      JP  CONOUT1
                                
       EF0F                     DECBF:              ;10進数表示時のバッファ(5バイト)
002216 EF0F                         DS  5
       EF0F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       EF11                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
00221B EF14 00                  FDRV:   DB  0
00221C EF15                     FNAME:  DS  36
002240 EF39                     SFILE:  DS  33      ;DRV FILENAME
                                
002261 EF5A                         DS  3
                                
002264 EF5D 0000                LEFTX:  DW  0
002266 EF5F 0000                DTAX:   DW  0
                                
       EF61                     ZERO:
       EF61                     BEEPD:
002268 EF61 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
002270 EF69 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
       EF62                     RTC_YY  EQU BEEPD+1
       EF63                     RTC_MW  EQU BEEPD+2
       EF64                     RTC_DD  EQU BEEPD+3
       EF65                     RTC_TT  EQU BEEPD+4
       EF66                     RTC_MM  EQU BEEPD+5
       EF67                     RTC_SS  EQU BEEPD+6
       EF62                     ROM_SLT EQU BEEPD+1
                                
002277 EF70 00                  CHECK:  DB  0
                                
002278 EF71 4F4B24              OK: DB  "OK$"
00227B EF74                         DS  5
002280 EF79 4572726F722124      COMERM: DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
002287 EF80 FF                  _CYL0:  DB  0FFH    ;Cylinder
002288 EF81 FF                  _CYL1:  DB  0FFH    ;Cylinder
002289 EF82 FF                  _CYL2:  DB  0FFH    ;Cylinder
00228A EF83 FF                  _CYL3:  DB  0FFH    ;Cylinder
00228B EF84 00                  _DRIVE: DB  0   ;unit number
00228C EF85 00                  _SEEKSP:DB  0   ;Seek speed
00228D EF86 FF                  _ISEEK: DB  0FFH    ;
00228E EF87 00                  _DVSW:  DB  0
00228F EF88 00                  _DRV:   DB  0
002290 EF89 FF                  _DSK:   DB  0FFH
002291 EF8A 8000                _DTA:   DW  00080H
002293 EF8C 0000                _CTC:   DW  0
002295 EF8E 0000                _TXADR: DW  0
002297 EF90 0000                _KEYPS: DW  0
002299 EF92 00FF                _KEYD:  DW  0FF00H  ;キーデータ
00229B EF94 0010                _KEYSP: DB  KEYSP_L,KEYSP_H ;オートリピートの速度
00229D EF96 00                  _COLORF:DB  COLORF  ;色
00229E EF97 18                  _LINE:  DB  LINE
                                
00229F EF98 0000                _FCB:   DW  0   ;SEARCH FILES
0022A1 EF9A 0000                _FBPS:  DW  0   ;    //
0022A3 EF9C 0000                _FBAD:  DW  0   ;    //
0022A5 EF9E 00                  _FBCNT: DB  0   ;    //
0022A6 EF9F 00                  _FILEN: DB  0   ;    //
0022A7 EFA0 00                  _DIRF:  DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
0022A8 EFA1                         DS  1
0022A9 EFA2 00                  _WTFATF:DB  0   ;FATバッファの更新フラグ
0022AA EFA3                         DS  1
0022AB EFA4 00                  _WTDBF: DB  0   ;データバッファの更新フラグ
0022AC EFA5 FF                  _DBDRV: DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
0022AD EFA6 0000                _DBSEC: DW  0   ;データバッファにあるデータを読み込んだセクタ番号
0022AF EFA8 0000                _DPB:   DW  0
       EFAA                     _FATDRV:
0022B1 EFAA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
0022B2 EFAB 00                  _FATIX: DB  0   ;FATバッファに読み込んでいるインデックス
       EFAC                     _FAKEFREE:
0022B3 EFAC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
0022B5 EFAE                         DS  2
                                
       EFB0                     CRTCD:
0022B7 EFB0 6F                      DB  06FH
       EFB1                     _WIDTH:
0022B8 EFB1 50                      DB  WIDTH
       EFB2                     TVRAMTOP:
0022B9 EFB2 5938                    DB  059H,038H
0022BB EFB4 1F02                    DB  01FH,002H
       EFB6                     _LINE2:
0022BD EFB6 19                      DB  019H
       EFB7                     WKE4:
0022BE EFB7 1C                      DB  01CH
       EFB8                     WKE6:
0022BF EFB8 00                      DB  000H
       EFB9                     WK40:
0022C0 EFB9 07                      DB  007H
       EFBA                     _PAGE_MINUS:
0022C1 EFBA 80F8                    DW  0-WIDTH*LINE
       EFBC                     _WIDTH_MINUS:
0022C3 EFBC B0FF                    DW  0-WIDTH
       EFBE                     WK30:
0022C5 EFBE 0C                      DB  00CH
       EFBF                     WK31:
       EFBF                     WK1FD0:
0022C6 EFBF 20                      DB  020H
                                
0022C7 EFC0 0000                CTC0:   DW  INTCTCE
0022C9 EFC2 0000                CTC1:   DW  INTCTCE
0022CB EFC4 0000                CTC2:   DW  INTCTC2
0022CD EFC6 0000                CTC3:   DW  INTCTCE
0022CF EFC8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
0022D1 EFCA C388DD          10  _INKEY: JP  INKEY
0022D4 EFCD C34BDB          10  _PRINT: JP  PRINT
0022D7 EFD0 C3E1DD          10  _SCRN:  JP  SCRN
0022DA EFD3 C32ADD          10  _POS:   JP  POS
0022DD EFD6 C393DB          10  _LOC:   JP  LOC
       EFD9                     _CHGDRV:
0022E0 EFD9 C306EB          10      JP  CHGDRV
       EFDC                     _GETDPB:
0022E3 EFDC C3D1EB          10      JP  GETDPB
       EFDF                     _FFLUSH:
0022E6 EFDF C3EFEB          10      JP  FFLUSH
       EFE2                     _RDFATX:
0022E9 EFE2 C3DFE7          10      JP  RDFATX
0022EC EFE5 C307E9          10  _RDFAT: JP  RDFAT
0022EF EFE8 C3BEEC          10  _WTTRK: JP  WTTRK
0022F2 EFEB C35CED          10  _FDRD:  JP  FDRD
0022F5 EFEE C3C0EC          10  _FDWT:  JP  FDWT
       EFF1                     _BPB2DPB:
0022F8 EFF1 C394E9          10      JP  BPB2DPB
       EFF4                     _BREAK:
0022FB EFF4 C3ACD2          10      JP  END_BATCH
       EFF7                     _GNCL:
0022FE EFF7 C381E8          10  GNCPAT: JP  GNCL        ; self-modifying code
       EFFA                     _SNCL:
002301 EFFA C3A4E8          10  SNCPAT: JP  SNCL        ; self-modifying code
002304 EFFD C366D1          10  _COMANL:JP  COMANL
                                
       F000                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F000                     STABLE:
                                ;0
002307 F000 03EFA0D9ACD92EE0        DW  _SYS00,_SYS01,_SYS02,_SYS03
00230F F008 99D699D6B1D909EF        DW  _SYS04,_SYS05,_SYS06,_SYS07
002317 F010 B9D99BD6E1D90DDA        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
00231F F018 B0D6B5D6C4D6D5D6        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
002327 F020 29D770D7B9D7EFD7        DW  _SYS10,_SYS11,_SYS12,_SYS13
00232F F028 F7D70DD822D81AD8        DW  _SYS14,_SYS15,_SYS16,_SYS17
002337 F030 69D86ED873D879D8        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
00233F F038 99D69FD899D6A3D8        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
002347 F040 99D659D861D8AAD8        DW  _SYS20,_SYS21,_SYS22,_SYS23
00234F F048 D0D899D6B3E48BE5        DW  _SYS24,_ERROR,_SYS26,_SYS27
002357 F050 61D8D9D823DA2EE0        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
00235F F058 4ADA2EE099D6FAD8        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
002367 F060 F4D899D699D699D6        DW  _SYS30,_ERROR,_ERROR,_ERROR
00236F F068 99D699D699D699D6        DW  _ERROR,_ERROR,_ERROR,_ERROR
002377 F070 99D62EE02EE01BD9        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
00237F F078 7CD6                    DW  _DOS2
                                
002381 F07A                         DS  2
002383 F07C 00F3                _FATBF: DW  FATBF
002385 F07E 00FB                _DTBUF: DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F080                     CTRLTB:
002387 F080 96DB96DBCDDBD5DC        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
00238F F088 CFDCF8DBA8DC74DC        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002397 F090 9DDBC2DBD8DC24DC        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
00239F F098 A5DC17DCDFDC96DB        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
0023A7 F0A0 96DB96DB1CDC96DB        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
0023AF F0A8 96DB96DB96DB96DB        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
0023B7 F0B0 96DB96DBA5DC2BDC        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
0023BF F0B8 7FDBA4DBB9DBD8DC        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
0023C7 F0C0 0200                M2D:    DW  2
0023C9 F0C2 FD02                    DB  0FDH,2
0023CB F0C4 6401                    DW  356
0023CD F0C6 FF0728090182            DB  0FFH,7,40,9,1,082H
0023D3 F0CC 0500A7000800            DW  5,0A7H,8
                                
0023D9 F0D2 0200                M2HD:   DW  2
0023DB F0D4 FE01                    DB  0FEH,1
0023DD F0D6 C704                    DW  1223
0023DF F0D8 FE064D080184            DB  0FEH,6,77,8,1,084H
0023E5 F0DE 0500A7000900            DW  5,0A7H,9
                                
0023EB F0E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
0023ED F0E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
0023EF F0E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
0023F1 F0EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F0EE                     SDDATAE:
                                
0023F5 F0EE                         DS  2
       F0F0                     _FCB_BAT:
0023F7 F0F0 66F1                    DW  FCB_BAT
       F0F2                     _PATH:
0023F9 F0F2 00F1                    DW  PATHD
                                
0023FB F0F4                     SCDIR:  DS  2       ;+14 +15
0023FD F0F6                     SFBPS:  DS  2       ;FBPS
0023FF F0F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
002401 F0FA 0000                _FATPS: DW  0
002403 F0FC 0000                _DIRPS: DW  0
002405 F0FE 0000                _CLPS:  DW  0
                                
       F100                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       0040                     PATHX   EQU 64
002407 F100                     PATHD:  DS  PATHX
002447 F140 00                  PATHE:  DB  0
                                
       F141                     DTA_CCP:
002448 F141                         DS  37
                                
       F166                     FCB_BAT:
00246D F166                         DS  37
                                
                                
002492 F18B 2062797465732066    FREE:   DB  " bytes free",9,'$'
            7265650924          
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "88TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE キーのテーブル
                                
       F198                     KEY_TABLE:
00249F F198 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
0024A7 F1A0 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
0024AF F1A8 4061626364656667        DB  '@','a','b','c','d','e','f','g' ;2
0024B7 F1B0 68696A6B6C6D6E6F        DB  'h','i','j','k','l','m','n','o' ;3
0024BF F1B8 7071727374757677        DB  'p','q','r','s','t','u','v','w' ;4
0024C7 F1C0 78797A5B5C5D5E2D        DB  'x','y','z','[',5CH,']','^','-' ;5
0024CF F1C8 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;6
0024D7 F1D0 38393A3B2C2E2F5C        DB  '8','9',':',';',',','.','/',5CH ;7
0024DF F1D8 0C1E1C0800000000        DB  0CH,1EH,1CH,08H,00H,00H,00H,00H ;8
0024E7 F1E0 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
0024EF F1E8 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
0024F7 F1F0 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
0024FF F1F8 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
[EOF:88TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "88DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   PC-8801mkIISR
                                
       F200                     _DEVICE:
                                
                                ;   A:
                                
002507 F200 0200                    DW  2   ;DPB_FATLN
002509 F202 EBEF                    DW  _FDRD   ;DPB_DRD
00250B F204 EEEF                    DW  _FDWT   ;DPB_DWT
00250D F206 FD                      DB  0FDH    ;DPB_FATID
00250E F207 02                      DB  2   ;DPB_SECPCL
00250F F208 6401                    DW  356 ;DPB_MAXCL
002511 F20A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002512 F20B 07                      DB  7   ;DPB_DIRSCNT
002513 F20C 28                      DB  40  ;DPB_MAXCYL
002514 F20D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002515 F20E 01                      DB  1   ;DPB_FATPS
002516 F20F 82                      DB  082H    ;DPB_BPS
002517 F210 0500                    DW  5   ;DPB_DIRPS
002519 F212 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00251A F213 00                      DB  0   ;DPB_UNITNO
00251B F214 0800                    DW  8   ;DPB_ADDCL
00251D F216 0000                    DW  0   ;DPB_16
00251F F218 0000                    DW  0   ;DPB_18
002521 F21A 0000                    DW  0   ;DPB_SDIR
002523 F21C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002527 F220 0200                    DW  2   ;DPB_FATLN
002529 F222 EBEF                    DW  _FDRD   ;DPB_DRD
00252B F224 EEEF                    DW  _FDWT   ;DPB_DWT
00252D F226 FD                      DB  0FDH    ;DPB_FATID
00252E F227 02                      DB  2   ;DPB_SECPCL
00252F F228 6401                    DW  356 ;DPB_MAXCL
002531 F22A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002532 F22B 07                      DB  7   ;DPB_DIRSCNT
002533 F22C 28                      DB  40  ;DPB_MAXCYL
002534 F22D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002535 F22E 01                      DB  1   ;DPB_FATPS
002536 F22F 82                      DB  082H    ;DPB_BPS
002537 F230 0500                    DW  5   ;DPB_DIRPS
002539 F232 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00253A F233 01                      DB  1   ;DPB_UNITNO
00253B F234 0800                    DW  8   ;DPB_ADDCL
00253D F236 0000                    DW  0   ;DPB_16
00253F F238 0000                    DW  0   ;DPB_18
002541 F23A 0000                    DW  0   ;DPB_SDIR
002543 F23C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002547 F240                         DS  32
                                
                                ;   D:
                                
002567 F260                         DS  32
                                
                                ;   E:
                                
002587 F280                         DS  32
                                
                                ;   F:
                                
0025A7 F2A0 0000                BANKFL: DW  0   ;DPB_FATLN
0025A9 F2A2 27D6                    DW  BDRD    ;DPB_DRD
0025AB F2A4 23D6                    DW  BDWT    ;DPB_DWT
0025AD F2A6 F9                      DB  0F9H    ;DPB_FATID
0025AE F2A7 02                      DB  2   ;DPB_SECPCL
0025AF F2A8 0000                BANKCL: DW  0   ;DPB_MAXCL
0025B1 F2AA 00                      DB  0   ;DPB_FDMODE
0025B2 F2AB 08                      DB  8   ;DPB_DIRSCNT
0025B3 F2AC 00                      DB  0   ;DPB_MAXCYL
0025B4 F2AD 01                      DB  1   ;DPB_MAXSEC
0025B5 F2AE 00                      DB  0   ;DPB_FATPS
0025B6 F2AF 02                      DB  2   ;DPB_BPS
0025B7 F2B0 0200                    DW  2   ;DPB_DIRPS
0025B9 F2B2 0B                  BANKDV: DB  00BH    ;DPB_DEVICE
0025BA F2B3 00                      DB  0   ;DPB_UNITNO
0025BB F2B4 0600                    DW  6   ;DPB_ADDCL
0025BD F2B6 0000                    DW  0   ;DPB_16
0025BF F2B8 0000                    DW  0   ;DPB_18
0025C1 F2BA 0000                    DW  0   ;DPB_SDIR
0025C3 F2BC 454D454D                DB  "EMEM"  ;DPB_NAME
                                
                                ;   G:
                                
0025C7 F2C0                         DS  32
                                
                                ;   H:
0025E7 F2E0                         DS  32-8
0025FF F2F8 00                      DB  0
[EOF:88DPB.ASM:UTF_8]
                                
       F2F9                     LAST_ADR:
                                
                                    END
[EOF:88.ASM:UTF_8]
