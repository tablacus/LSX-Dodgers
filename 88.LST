                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   LSX-Dodgers for PC-8801mkIISR
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "88DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   PC-8001mkIISR
                                
       0002                     MAC EQU 2   ;PC-8001mkIISR
       0001                     DEV EQU 1
                                
       011D                     VER_6F  EQU 0011DH
                                
       CE00                     RUN EQU 0CE00H
       CDF9                     OFFSET  EQU RUN-7
                                
       D206                     BDOS    EQU 0D206H
       EE00                     INTAD   EQU 0EE00H
       EF00                     WORKAD  EQU 0EF00H
       F300                     FATBF   EQU 0F300H
       FB00                     DTBUF   EQU 0FB00H
       FF00                     KEYBF   EQU 0FF00H
       FF20                     KBUF    EQU 0FF20H
       FFBB                     SUBSYS  EQU EXTBIO-5*3
       FFD9                     TRAP38  EQU 0FFD9H
       0050                     WIDTH   EQU 80
       0018                     LINE    EQU 24
       0000                     COLORF  EQU 0
       0010                     KEYSP_H EQU 16
       0000                     KEYSP_L EQU 0
       0008                     COMS    EQU 8
                                
                                ; ディスクサブシステム
       002A                     MAIN        EQU 0002AH
                                
       4000                     DSS_DATA    EQU 04000H
                                
       7C00                     DSS     EQU 07C00H
[EOF:88DEF.ASM:SHIFT_JIS]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0000                     VER_3   EQU 0
       1D02                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0102                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0160                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 CDF9                         ORG OFFSET
                                
                                ;   MSX BINARY HEADER
000000 CDF9 FE                      DB  0FEH
                                ;   MSX BINARY START ADDRESS
000001 CDFA 00CE                    DW  RUN
                                ;   MSX BINARY END ADDRESS
000003 CDFC F9F2                    DW  LAST_ADR
                                ;   MSX BINARY EXEC ADDRESS
000005 CDFE 07CE                    DW  START
                                
                                    INCLUDE "88INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   PC-8801mkIISR
                                
000007 CE00 C307CE          10      JP  START
00000A CE03 021D                    DW  MACW
00000C CE05 6001                    DW  VER
                                
       CE07                     START:
00000E CE07 F3               4      DI
00000F CE08 ED5E             8      IM  2
000011 CE0A 3107CE          10      LD  SP,START
000014 CE0D CD1BCE          17      CALL    INIT        ;NZならAUTOEXECを実行
000017 CE10 210000          10      LD  HL,0
00001A CE13 E5              11      PUSH    HL
00001B CE14 C8              11      RET Z
00001C CE15 1137CF          10      LD  DE,AUTOD
00001F CE18 C3FDEF          10      JP  _COMANL
                                
       CE1B                     INIT:
000022 CE1B DB32            11      IN  A,(032H)
000024 CE1D CBA7             8      RES 4,A     ;高速RAMアクセスモード
000026 CE1F D332            11      OUT (032H),A
                                
000028 CE21 21C8F3          10      LD  HL,0F3C8H   ;テキストをクリア
00002B CE24 11E880          10      LD  DE,080E8H
00002E CE27 0E20             7      LD  C,' '
000030 CE29 3E19             7      LD  A,25
       CE2B                     TVCL1:
000032 CE2B 0650             7      LD  B,80
       CE2D                     TVCL2:
000034 CE2D 71               7      LD  (HL),C
000035 CE2E 23               6      INC HL
000036 CE2F 10FC            13      DJNZ    TVCL2
000038 CE31 0614             7      LD  B,20
       CE33                     TVCL3:
00003A CE33 72               7      LD  (HL),D
00003B CE34 2C               4      INC L
00003C CE35 73               7      LD  (HL),E
00003D CE36 23               6      INC HL
00003E CE37 10FA            13      DJNZ    TVCL3
000040 CE39 3D               4      DEC A
000041 CE3A 20EF            12      JR  NZ,TVCL1
                                
000043 CE3C DB32            11      IN  A,(032H)
000045 CE3E F610             7      OR  010H        ;高速RAMアクセスモードOFF
000047 CE40 D332            11      OUT (032H),A
                                
000049 CE42 AF               4      XOR A
00004A CE43 32B8EF          13      LD  (WKE6),A
00004D CE46 2F               4      CPL
00004E CE47 32B7EF          13      LD  (WKE4),A
                                
000051 CE4A CD35DE          17      CALL    INIT_CRTC
       CE4D                     BANK:
000054 CE4D 01E300          10      LD  BC,000E3H   ;拡張RAM バンク選択
000057 CE50 21007F          10      LD  HL,07F00H
00005A CE53 56               7      LD  D,(HL)
00005B CE54 F3               4      DI
00005C CE55 3E01             7      LD  A,1     ;リード可
00005E CE57 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000060 CE59 ED41            12      OUT (C),B       ;拡張RAM バンク選択
000062 CE5B 3A0000          13      LD  A,(0)
000065 CE5E FEEB             7      CP  0EBH
000067 CE60 2005            12      JR  NZ,BANK1
000069 CE62 3E2B             7      LD  A,02BH
00006B CE64 32B2F2          13      LD  (BANKDV),A
       CE67                     BANK1:
00006E CE67 3E01             7      LD  A,1     ;リード可
000070 CE69 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000072 CE6B ED41            12      OUT (C),B       ;拡張RAM バンク選択
000074 CE6D 5E               7      LD  E,(HL)
000075 CE6E 7B               4      LD  A,E
000076 CE6F C6A5             7      ADD A,0A5H
000078 CE71 77               7      LD  (HL),A      ;メインメモリに書き込む
000079 CE72 BE               7      CP  (HL)
00007A CE73 2811            12      JR  Z,BANK2     ;メインメモリが反映されているか？
00007C CE75 3E11             7      LD  A,011H      ;ライト/リード可
00007E CE77 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000080 CE79 7B               4      LD  A,E
000081 CE7A C6A5             7      ADD A,0A5H
000083 CE7C 77               7      LD  (HL),A
000084 CE7D BE               7      CP  (HL)
000085 CE7E 73               7      LD  (HL),E      ;拡張RAM に元の値を戻す
000086 CE7F 2005            12      JR  NZ,BANK2    ;拡張RAM に反映しているか？
000088 CE81 04               4      INC B
000089 CE82 CB60             8      BIT 4,B
00008B CE84 28E1            12      JR  Z,BANK1
       CE86                     BANK2:
00008D CE86 AF               4      XOR A       ;ライト/リード不可
00008E CE87 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
000090 CE89 72               7      LD  (HL),D      ;メインメモリ に元の値を戻す
000091 CE8A 78               4      LD  A,B
000092 CE8B B7               4      OR  A
000093 CE8C 2814            12      JR  Z,NOBANK
000095 CE8E 68               4      LD  L,B
000096 CE8F 2600             7      LD  H,0
000098 CE91 29              11      ADD HL,HL   ;*2
000099 CE92 29              11      ADD HL,HL   ;*4
00009A CE93 29              11      ADD HL,HL   ;*8
00009B CE94 29              11      ADD HL,HL   ;*16
00009C CE95 29              11      ADD HL,HL   ;*32
00009D CE96 2B               6      DEC HL  ;-1
00009E CE97 2B               6      DEC HL  ;-2
00009F CE98 2B               6      DEC HL  ;-3
0000A0 CE99 22A8F2          16      LD  (BANKCL),HL
0000A3 CE9C CD27CF          17      CALL    CALC_FATLN
0000A6 CE9F 32A0F2          13      LD  (BANKFL),A
       CEA2                     NOBANK:
                                                ;初期化
0000A9 CEA2 AF               4      XOR A       ;イニシャライズ
0000AA CEA3 CD1FEC          17      CALL    PUTCOM
0000AD CEA6 3E16             7      LD  A,16H       ;高速レシーブメモリ
0000AF CEA8 CD1FEC          17      CALL    PUTCOM
0000B2 CEAB 3E7C             7      LD  A,DSS/256   ;開始アドレスH
0000B4 CEAD CD25EC          17      CALL    PUTDAT
0000B7 CEB0 AF               4      XOR A       ;開始アドレスL
0000B8 CEB1 CD25EC          17      CALL    PUTDAT
0000BB CEB4 015102          10      LD  BC,AT_DSSE-AT_DSS
0000BE CEB7 CB41             8      BIT 0,C
0000C0 CEB9 2801            12      JR  Z,SUBPG1
0000C2 CEBB 03               6      INC BC      ;偶数にする
       CEBC                     SUBPG1:
0000C3 CEBC 78               4      LD  A,B     ;バイト数H
0000C4 CEBD CD25EC          17      CALL    PUTDAT
0000C7 CEC0 79               4      LD  A,C
0000C8 CEC1 CD25EC          17      CALL    PUTDAT
0000CB CEC4 21B4CF          10      LD  HL,AT_DSS
0000CE CEC7 CD69EC          17      CALL    FPUTDAT
                                
0000D1 CECA 210000          10      LD  HL,0
0000D4 CECD 065C             7      LD  B,05CH
0000D6 CECF 3E                      DB  03EH    ;LD A,??
0000D7 CED0 FF              12      RST 38H
0000D8 CED1 CD65DF          17      CALL    FILL_MEMORY
0000DB CED4 06A4             7      LD  B,0A4H
0000DD CED6 AF               4      XOR A
0000DE CED7 CD65DF          17      CALL    FILL_MEMORY
                                
0000E1 CEDA 3EC3             7      LD  A,0C3H      ;JP
0000E3 CEDC 2103EF          10      LD  HL,CPM_WBOOT
0000E6 CEDF 320000          13      LD  (00000H),A
0000E9 CEE2 220100          16      LD  (00001H),HL ;IPL
                                
0000EC CEE5 21021D          10      LD  HL,MACW     ;3 bit7  DPB Compatible LA(1)
0000EF CEE8 220300          16      LD  (00003H),HL ;  bit6-0 Machine
                                ;               ;4 LSX-Dodgers(01DH)
0000F2 CEEB 2106D2          10      LD  HL,BDOS
0000F5 CEEE 320500          13      LD  (00005H),A
0000F8 CEF1 220600          16      LD  (00006H),HL ;BDOS
                                
0000FB CEF4 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000FE CEF7 323800          13      LD  (00038H),A
000101 CEFA 223900          16      LD  (00039H),HL ;RST 038H
                                
000104 CEFD 3EEF             7      LD  A,CPM_BOOT/256
000106 CEFF 320B00          13      LD  (0000BH),A
                                
000109 CF02 3E                      DB  03EH    ;LD A,??
00010A CF03 E9               4      JP  (HL)
00010B CF04 320F00          13      LD  (0000FH),A
                                
00010E CF07 2143CF          10      LD  HL,INIMES
000111 CF0A CDE4D6          17      CALL    MSX
       CF0D                     INIT1:
000114 CF0D F3               4      DI
000115 CF0E 1100FF          10      LD  DE,0FF00H
000118 CF11 06BB             7      LD  B,SUBSYS%256
00011A CF13 CD43D5          17      CALL    ZERO_MEMORY_DE
                                
00011D CF16 216FCF          10      LD  HL,AT_SUBSYS
000120 CF19 11BBFF          10      LD  DE,SUBSYS
000123 CF1C 014500          10      LD  BC,AT_TRAPE-AT_SUBSYS
000126 CF1F EDB0                    LDIR
                                
000128 CF21 CDD4DD          17      CALL    CHKEY
00012B CF24 FE03             7      CP  3
00012D CF26 C9              10      RET
                                
       CF27                     CALC_FATLN: ;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
00012E CF27 5D               4      LD  E,L
00012F CF28 54               4      LD  D,H
000130 CF29 29              11      ADD HL,HL   ;*2
000131 CF2A 19              11      ADD HL,DE   ;*3
000132 CF2B CB3C             8      SRL H   ;/2
000134 CF2D CB1D             8      RR  L   ;1クラスタ辺り1.5バイト必要
000136 CF2F 11FF01          10      LD  DE,511  ;切り上げる
000139 CF32 19              11      ADD HL,DE
00013A CF33 7C               4      LD  A,H
00013B CF34 CB3F             8      SRL A
00013D CF36 C9              10      RET
                                
00013E CF37 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000147 CF40 413A00              AUTODV: DB  "A:",0
                                
00014A CF43 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for PC-8801mkIISR v"
            6765727320666F72    
            2050432D38383031    
            6D6B494953522076    
00016A CF63 312E                    DB  030H + VER_1, '.'
00016C CF65 3630                    DB  030H + VER_2 ,030H + VER_3
                                ;   DB  ""
00016E CF67 2047616B750D0A          DB  ' Gaku',0DH,0AH
000175 CF6E 00                      DB  0
                                
       CF6F                     AT_SUBSYS:
000176 FFBB                         ORG SUBSYS,AT_SUBSYS-OFFSET
000176 FFBB C31FEC          10      JP  PUTCOM
000179 FFBE C325EC          10      JP  PUTDAT
00017C FFC1 C34AEC          10      JP  GETDAT
00017F FFC4 C369EC          10      JP  FPUTDAT
000182 FFC7 C394EC          10      JP  FGETDAT
                                ;EXTBIO
000185 FFCA C9              10      RET
000186 FFCB                         DS  14,0FFH
                                ;TRAP38:
000194 FFD9 210000          10      LD  HL,0
000197 FFDC E3              19      EX  (SP),HL
000198 FFDD 3E24             7      LD  A,'$'
00019A FFDF CDD8D9          17      CALL    MSG_A
00019D FFE2 2B               6      DEC HL
00019E FFE3 7C               4      LD  A,H
00019F FFE4 CDE8FF          17      CALL    PRHX
0001A2 FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
0001A3 FFE8 F5              11      PUSH    AF
0001A4 FFE9 07               4      RLCA
0001A5 FFEA 07               4      RLCA
0001A6 FFEB 07               4      RLCA
0001A7 FFEC 07               4      RLCA
0001A8 FFED CDF1FF          17      CALL    PRHX2
0001AB FFF0 F1              10      POP AF
       FFF1                     PRHX2:
0001AC FFF1 E60F             7      AND 00FH
0001AE FFF3 FE0A             7      CP  10
0001B0 FFF5 3F               4      CCF
0001B1 FFF6 CE30             7      ADC A,'0'
0001B3 FFF8 27               4      DAA
0001B4 FFF9 C3D8D9          10      JP  MSG_A
0001B7 FFFC                         DS  4
0001BB CFB4                         ORG $$+OFFSET   ;$DEPHASE
       CFB4                     AT_TRAPE:
[EOF:88INIT.ASM:SHIFT_JIS]
                                    INCLUDE "88SUB.ASM"
                                
                                ;   LSX-Dodgers SUB DISK SYSTEM
                                ;   PC-8801mkIISR
                                
       CFB4                     AT_DSS:
0001BB 7C00                         ORG DSS,AT_DSS-OFFSET
0001BB 7C00 C3437C          10      JP  READDISKEX
0001BE 7C03 C3A37C          10      JP  WRITEDISKEX
0001C1 7C06 C3BB7C          10      JP  GETPARAMS_N
0001C4 7C09 C3C67C          10      JP  SEEK
0001C7 7C0C C3547D          10      JP  FDCOMMAND
0001CA 7C0F C3207E          10      JP  CHECKRESULT
0001CD 7C12 C3427E          10      JP  GETDEVSTAT
0001D0 7C15 C3477E          10      JP  RDFDC
                                
0001D3 7C18                         DS  8*3
                                
       7C30                     S_PARAMS:
0001EB 7C30                         DS  16
       7C30                     S_UNITNO    EQU S_PARAMS    ;ユニット番号 0:ドライブA 1:ドライブB
       7C31                     S_DPS       EQU S_PARAMS+1  ;1トラックのセクタ数
       7C32                     S_SECTOR_R  EQU S_PARAMS+2  ;セクタ番号
       7C33                     S_TRACK     EQU S_PARAMS+3  ;トラック番号
       7C34                     S_FDMODE    EQU S_PARAMS+4  ;FDモード切り替え $FF:2D/2DD $FE:2HD
       7C35                     S_SECSIZE_N EQU S_PARAMS+5  ;N セクタサイズ
       7C36                     S_BYTE_H    EQU S_PARAMS+6  ;バイト数H
       7C37                     S_MAXCL     EQU S_PARAMS+7  ;シリンダ数
                                
       7C40                     S_CMD_STATUS:
0001FB 7C40 00                      DB  0
       7C41                     S_LEFT:
0001FC 7C41 00                      DB  0
       7C42                     S_WKF4:
0001FD 7C42 00                      DB  0
                                
       7C43                     READDISKEX:
0001FE 7C43 CDB97C          17      CALL    GETPARAMS
000201 7C46 AF               4      XOR A
000202 7C47 327A7C          13      LD  (RETRY_RDDISK),A
000205 7C4A 2A327C          16      LD  HL,(S_PARAMS+2)
000208 7C4D 7D               4      LD  A,L
000209 7C4E 3D               4      DEC A
00020A 7C4F B4               4      OR  H
00020B 7C50 200C            12      JR  NZ,RDDISK0
00020D 7C52 2A357C          16      LD  HL,(S_PARAMS+5)
000210 7C55 7C               4      LD  A,H
000211 7C56 BD               4      CP  L
000212 7C57 2005            12      JR  NZ,RDDISK0
000214 7C59 3E03             7      LD  A,3
000216 7C5B 327A7C          13      LD  (RETRY_RDDISK),A
       7C5E                     RDDISK0:
000219 7C5E CDC67C          17      CALL    SEEK
00021C 7C61 3E46             7      LD  A,46H       ;READ DATA
00021E 7C63 CD547D          17      CALL    FDCOMMAND
000221 7C66 3834            12      JR  C,FINISH_DISK
000223 7C68 CD857D          17      CALL    RDDISK1
       7C6B                     WRDISK3:
000226 7C6B 78               4      LD  A,B
000227 7C6C B2               4      OR  D
000228 7C6D 32417C          13      LD  (S_LEFT),A
00022B 7C70 DBF8            11      IN  A,(0F8H)    ;FDC μPD765A TC入力
00022D 7C72 FB               4      EI
00022E 7C73 76               4      HALT
00022F 7C74 CD207E          17      CALL    CHECKRESULT
000232 7C77 301D            12      JR  NC,FINISH_DISK0
       7C7A                     RETRY_RDDISK    EQU $+1
000234 7C79 3E00             7      LD  A,0
000236 7C7B B7               4      OR  A
000237 7C7C 2818            12      JR  Z,FINISH_DISK0
000239 7C7E 3D               4      DEC A
00023A 7C7F 327A7C          13      LD  (RETRY_RDDISK),A
00023D 7C82 3A357C          13      LD  A,(S_PARAMS+5)
000240 7C85 FE04             7      CP  4
000242 7C87 3003            12      JR  NC,RETRY_RDDISK1
000244 7C89 87               4      ADD A,A
000245 7C8A 1802            12      JR  RETRY_RDDISK2
       7C8C                     RETRY_RDDISK1:
000247 7C8C 3E01             7      LD  A,1
       7C8E                     RETRY_RDDISK2:
000249 7C8E 67               4      LD  H,A
00024A 7C8F 6F               4      LD  L,A
00024B 7C90 22357C          16      LD  (S_PARAMS+5),HL
00024E 7C93 C35E7C          10      JP  RDDISK0
       7C96                     FINISH_DISK0:
000251 7C96 3A417C          13      LD  A,(S_LEFT)
000254 7C99 D601             7      SUB 1
000256 7C9B 3F               4      CCF
       7C9C                     FINISH_DISK:
000257 7C9C 9F               4      SBC A,A
000258 7C9D 32407C          13      LD  (S_CMD_STATUS),A
00025B 7CA0 C32A00          10      JP  MAIN
                                
       7CA3                     WRITEDISKEX:
00025E 7CA3 AF               4      XOR A
00025F 7CA4 327A7C          13      LD  (RETRY_RDDISK),A
000262 7CA7 CDB97C          17      CALL    GETPARAMS
000265 7CAA CDC67C          17      CALL    SEEK
000268 7CAD 3E45             7      LD  A,45H       ;WRITE DATA
00026A 7CAF CD547D          17      CALL    FDCOMMAND
00026D 7CB2 38E8            12      JR  C,FINISH_DISK
00026F 7CB4 CDCC7D          17      CALL    WRDISK1
000272 7CB7 18B2            12      JR  WRDISK3
                                
       7CB9                     GETPARAMS:
000274 7CB9 0608             7      LD  B,8
       7CBB                     GETPARAMS_N:
000276 7CBB E5              11      PUSH    HL
000277 7CBC 21307C          10      LD  HL,S_PARAMS
       7CBF                     GETPARAMS1:
00027A 7CBF D7              12      RST 10H
00027B 7CC0 77               7      LD  (HL),A
00027C 7CC1 23               6      INC HL
00027D 7CC2 10FB            13      DJNZ    GETPARAMS1
00027F 7CC4 E1              10      POP HL
000280 7CC5 C9              10      RET
                                
       7CC6                     SEEK:
000281 7CC6 E5              11      PUSH    HL
000282 7CC7 3A347C          13      LD  A,(S_FDMODE)    ;FDモード切り替え $FF:2D/2DD $FE:2HD
000285 7CCA 1F               4      RRA
000286 7CCB 3F               4      CCF
000287 7CCC 9F               4      SBC A,A
000288 7CCD F5              11      PUSH    AF
000289 7CCE E605             7      AND 5
00028B 7CD0 4F               4      LD  C,A
00028C 7CD1 3A377C          13      LD  A,(S_MAXCL) ;シリンダ数
00028F 7CD4 C6D3             7      ADD A,0-45      ;オーバートラックを考慮して40+α
000291 7CD6 9F               4      SBC A,A
000292 7CD7 E604             7      AND 4
000294 7CD9 B1               4      OR  C
000295 7CDA 0EFA             7      LD  C,0FFH-5    ;マスク
000297 7CDC 47               4      LD  B,A
000298 7CDD 3A307C          13      LD  A,(S_UNITNO)    ;0:ドライブA 1:ドライブB
00029B 7CE0 B7               4      OR  A
00029C 7CE1 2804            12      JR  Z,SET_WKF4
00029E 7CE3 CB20             8      SLA B
0002A0 7CE5 CB01             4      RLC C
       7CE7                     SET_WKF4:
0002A2 7CE7 3A427C          13      LD  A,(S_WKF4)
0002A5 7CEA A1               4      AND C
0002A6 7CEB B0               4      OR  B
0002A7 7CEC 4F               4      LD  C,A
0002A8 7CED D3F4            11      OUT (0F4H),A    ;ドライブ制御
0002AA 7CEF E6DF             7      AND 0FFH-020H   ;CLKの分は抜いておく
0002AC 7CF1 47               4      LD  B,A
0002AD 7CF2 F1              10      POP AF
0002AE 7CF3 E620             7      AND 020H        ;bit5:CLK
0002B0 7CF5 B0               4      OR  B
0002B1 7CF6 D3F4            11      OUT (0F4H),A    ;ドライブ制御
0002B3 7CF8 32427C          13      LD  (S_WKF4),A
0002B6 7CFB 47               4      LD  B,A
0002B7 7CFC A9               4      XOR C
0002B8 7CFD E620             7      AND 020H        ;CLKが変化したら一定時間待つ
0002BA 7CFF 2808            12      JR  Z,NOCHGCLK
0002BC 7D01 2160F0          10      LD  HL,0F060H
       7D04                     WAIT_CLK:
0002BF 7D04 2B               6      DEC HL
0002C0 7D05 7C               4      LD  A,H
0002C1 7D06 B5               4      OR  L
0002C2 7D07 20FB            12      JR  NZ,WAIT_CLK
       7D09                     NOCHGCLK:
0002C4 7D09 78               4      LD  A,B
0002C5 7D0A E620             7      AND 020H
0002C7 7D0C 2805            12      JR  Z,SPECIFY2D
0002C9 7D0E 1131DF          10      LD  DE,0DF31H   ;SPECIFY 2HD / SRT:13 HUT:15 HLT:24 NON-DMA
0002CC 7D11 1803            12      JR  SPECIFYOK
       7D13                     SPECIFY2D:
0002CE 7D13 1119DA          10      LD  DE,0DA19H   ;SPECIFY 2D/2DD / SRT:13 HUT 10 HLT:12 NON-DMA
       7D16                     SPECIFYOK:
0002D1 7D16 3E03             7      LD  A,3     ;SPECIFY
0002D3 7D18 E7              12      RST 20H
0002D4 7D19 7A               4      LD  A,D
0002D5 7D1A E7              12      RST 20H
0002D6 7D1B 7B               4      LD  A,E
0002D7 7D1C E7              12      RST 20H
       7D1D                     NOSPECIFY:
0002D8 7D1D ED4B307C        20      LD  BC,(S_PARAMS)
0002DC 7D21 ED5B327C        20      LD  DE,(S_PARAMS+2)
0002E0 7D25 7A               4      LD  A,D     ;TRACK
0002E1 7D26 CB3F             8      SRL A       ;CYLINDER
0002E3 7D28 3E0F             7      LD  A,00FH      ;SEEK
0002E5 7D2A 2002            12      JR  NZ,SEEK1    ;0シリンダの場合はRECALIBRATE、それ以外はSEEKを使う
0002E7 7D2C 3E07             7      LD  A,7     ;RECALIBRATE
       7D2E                     SEEK1:
0002E9 7D2E E7              12      RST 20H
0002EA 7D2F 79               4      LD  A,C     ;DR/HD
0002EB 7D30 E7              12      RST 20H
0002EC 7D31 7A               4      LD  A,D     ;TRACK
0002ED 7D32 CB3F             8      SRL A       ;CYLINDER
0002EF 7D34 C42000          17      CALL    NZ,20H      ;SEEKの場合だけ呼ぶ(0シリンダの場合はRECALIBRATEを使うのでシリンダの設定は不要)
0002F2 7D37 FB               4      EI
0002F3 7D38 76               4      HALT
0002F4 7D39 3E08             7      LD  A,8     ;SENSE
0002F6 7D3B E7              12      RST 20H
0002F7 7D3C CD477E          17      CALL    RDFDC       ;ST0
0002FA 7D3F CD477E          17      CALL    RDFDC       ;PCN(CYLINDER)
0002FD 7D42 210040          10      LD  HL,04000H
       7D45                     WAIT_SEEK:
000300 7D45 CD427E          17      CALL    GETDEVSTAT
000303 7D48 E608             7      AND 8
000305 7D4A 2006            12      JR  NZ,SEEK_OK
000307 7D4C 2B               6      DEC HL
000308 7D4D 7C               4      LD  A,H
000309 7D4E B5               4      OR  L
00030A 7D4F 20F4            12      JR  NZ,WAIT_SEEK
00030C 7D51 37               4      SCF
       7D52                     SEEK_OK:
00030D 7D52 E1              10      POP HL
00030E 7D53 C9              10      RET
                                
       7D54                     FDCOMMAND:
00030F 7D54 E7              12      RST 20H
000310 7D55 7A               4      LD  A,D     ;HD US1 US0
000311 7D56 E601             7      AND 1
000313 7D58 87               4      ADD A,A
000314 7D59 87               4      ADD A,A
000315 7D5A B1               4      OR  C
000316 7D5B E7              12      RST 20H
000317 7D5C 7A               4      LD  A,D     ;C
000318 7D5D CB3F             8      SRL A
00031A 7D5F E7              12      RST 20H
00031B 7D60 7A               4      LD  A,D     ;H
00031C 7D61 E601             7      AND 1
00031E 7D63 E7              12      RST 20H
00031F 7D64 7B               4      LD  A,E     ;R
000320 7D65 E7              12      RST 20H
000321 7D66 3A357C          13      LD  A,(S_PARAMS+5)  ;N
000324 7D69 FE04             7      CP  4
000326 7D6B 3802            12      JR  C,FDCOMMAND2
                                
000328 7D6D 3E03             7      LD  A,3
       7D6F                     FDCOMMAND2:
00032A 7D6F 1E20             7      LD  E,020H      ;NO SERVICE
00032C 7D71 E7              12      RST 20H
                                
00032D 7D72 210040          10      LD  HL,DSS_DATA ;開始アドレス
000330 7D75 78               4      LD  A,B     ;EOT
000331 7D76 E7              12      RST 20H
                                
000332 7D77 01FB00          10      LD  BC,000FBH   ;B:バイト数L C:FDC μPD765A データレジスタ
000335 7D7A 3E54             7      LD  A,054H      ;GSL
000337 7D7C E7              12      RST 20H
                                
000338 7D7D 3A367C          13      LD  A,(S_BYTE_H)
00033B 7D80 57               4      LD  D,A     ;バイト数H
                                
00033C 7D81 AF               4      XOR A       ;DTL
00033D 7D82 E7              12      RST 20H
00033E 7D83 A7               4      AND A
00033F 7D84 C9              10      RET
                                
       7D85                     RDDISK1:            ;高速化の為にループ展開x8
000340 7D85 FB               4      EI
000341 7D86 76               4      HALT
000342 7D87 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000344 7D89 A3               4      AND E       ;NO SERVICE
000345 7D8A C8              11      RET Z
000346 7D8B EDA2            16      INI
                                
000348 7D8D FB               4      EI
000349 7D8E 76               4      HALT
00034A 7D8F DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00034C 7D91 A3               4      AND E       ;NO SERVICE
00034D 7D92 C8              11      RET Z
00034E 7D93 EDA2            16      INI
                                
000350 7D95 FB               4      EI
000351 7D96 76               4      HALT
000352 7D97 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000354 7D99 A3               4      AND E       ;NO SERVICE
000355 7D9A C8              11      RET Z
000356 7D9B EDA2            16      INI
                                
000358 7D9D FB               4      EI
000359 7D9E 76               4      HALT
00035A 7D9F DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00035C 7DA1 A3               4      AND E       ;NO SERVICE
00035D 7DA2 C8              11      RET Z
00035E 7DA3 EDA2            16      INI
                                
000360 7DA5 FB               4      EI
000361 7DA6 76               4      HALT
000362 7DA7 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000364 7DA9 A3               4      AND E       ;NO SERVICE
000365 7DAA C8              11      RET Z
000366 7DAB EDA2            16      INI
                                
000368 7DAD FB               4      EI
000369 7DAE 76               4      HALT
00036A 7DAF DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00036C 7DB1 A3               4      AND E       ;NO SERVICE
00036D 7DB2 C8              11      RET Z
00036E 7DB3 EDA2            16      INI
                                
000370 7DB5 FB               4      EI
000371 7DB6 76               4      HALT
000372 7DB7 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000374 7DB9 A3               4      AND E       ;NO SERVICE
000375 7DBA C8              11      RET Z
000376 7DBB EDA2            16      INI
                                
000378 7DBD FB               4      EI
000379 7DBE 76               4      HALT
00037A 7DBF DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00037C 7DC1 A3               4      AND E       ;NO SERVICE
00037D 7DC2 C8              11      RET Z
00037E 7DC3 EDA2            16      INI
                                
000380 7DC5 20BE            12      JR  NZ,RDDISK1
000382 7DC7 15               4      DEC D
000383 7DC8 C2857D          10      JP  NZ,RDDISK1
000386 7DCB C9              10      RET
                                
       7DCC                     WRDISK1:            ;高速化の為にループ展開x8
000387 7DCC FB               4      EI
000388 7DCD 76               4      HALT
000389 7DCE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00038B 7DD0 A3               4      AND E
00038C 7DD1 C8              11      RET Z
00038D 7DD2 EDA3            16      OUTI
                                
00038F 7DD4 FB               4      EI
000390 7DD5 76               4      HALT
000391 7DD6 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000393 7DD8 A3               4      AND E
000394 7DD9 C8              11      RET Z
000395 7DDA EDA3            16      OUTI
                                
000397 7DDC FB               4      EI
000398 7DDD 76               4      HALT
000399 7DDE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
00039B 7DE0 A3               4      AND E
00039C 7DE1 C8              11      RET Z
00039D 7DE2 EDA3            16      OUTI
                                
00039F 7DE4 FB               4      EI
0003A0 7DE5 76               4      HALT
0003A1 7DE6 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003A3 7DE8 A3               4      AND E
0003A4 7DE9 C8              11      RET Z
0003A5 7DEA EDA3            16      OUTI
                                
0003A7 7DEC FB               4      EI
0003A8 7DED 76               4      HALT
0003A9 7DEE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003AB 7DF0 A3               4      AND E
0003AC 7DF1 C8              11      RET Z
0003AD 7DF2 EDA3            16      OUTI
                                
0003AF 7DF4 FB               4      EI
0003B0 7DF5 76               4      HALT
0003B1 7DF6 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003B3 7DF8 A3               4      AND E
0003B4 7DF9 C8              11      RET Z
0003B5 7DFA EDA3            16      OUTI
                                
0003B7 7DFC FB               4      EI
0003B8 7DFD 76               4      HALT
0003B9 7DFE DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003BB 7E00 A3               4      AND E
0003BC 7E01 C8              11      RET Z
0003BD 7E02 EDA3            16      OUTI
                                
0003BF 7E04 FB               4      EI
0003C0 7E05 76               4      HALT
0003C1 7E06 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
0003C3 7E08 A3               4      AND E
0003C4 7E09 C8              11      RET Z
0003C5 7E0A EDA3            16      OUTI
                                
0003C7 7E0C 20BE            12      JR  NZ,WRDISK1
0003C9 7E0E 15               4      DEC D
0003CA 7E0F C2CC7D          10      JP  NZ,WRDISK1
0003CD 7E12 C9              10      RET
                                
       7E13                     RESULTEX:
0003CE 7E13 3A407C          13      LD  A,(S_CMD_STATUS)
0003D1 7E16 3C               4      INC A
0003D2 7E17 2803            12      JR  Z,RESULTEX1
0003D4 7E19 3A367C          13      LD  A,(S_BYTE_H)    ;バイト数H
       7E1C                     RESULTEX1:
0003D7 7E1C DF              12      RST 18H
0003D8 7E1D C32A00          10      JP  MAIN
                                
       7E20                     CHECKRESULT:
0003DB 7E20 C5              11      PUSH    BC
0003DC 7E21 CD477E          17      CALL    RDFDC       ;ST0
0003DF 7E24 E6D8             7      AND 0D8H
0003E1 7E26 4F               4      LD  C,A
0003E2 7E27 CD477E          17      CALL    RDFDC       ;ST1
0003E5 7E2A E6B7             7      AND 0B7H
0003E7 7E2C B1               4      OR  C
0003E8 7E2D 4F               4      LD  C,A
0003E9 7E2E CD477E          17      CALL    RDFDC       ;ST2
0003EC 7E31 E673             7      AND 073H
0003EE 7E33 B1               4      OR  C
0003EF 7E34 4F               4      LD  C,A
0003F0 7E35 0604             7      LD  B,4
       7E37                     CHECKRESULT1:           ;C H R N
0003F2 7E37 CD477E          17      CALL    RDFDC
0003F5 7E3A 10FB            13      DJNZ    CHECKRESULT1
0003F7 7E3C 79               4      LD  A,C
0003F8 7E3D A7               4      AND A
0003F9 7E3E C1              10      POP BC
0003FA 7E3F C8              11      RET Z
0003FB 7E40 37               4      SCF
0003FC 7E41 C9              10      RET
                                
       7E42                     GETDEVSTAT:
0003FD 7E42 3E04             7      LD  A,4
0003FF 7E44 E7              12      RST 20H
000400 7E45 79               4      LD  A,C
000401 7E46 E7              12      RST 20H
                                
       7E47                     RDFDC:
000402 7E47 DBFA            11      IN  A,(0FAH)    ;FDC μPD765A ステータスレジスタリード
000404 7E49 2F               4      CPL
000405 7E4A E6C0             7      AND 0C0H        ;RQMとDIOが両方1になるまで待つ
000407 7E4C 20F9            12      JR  NZ,RDFDC
000409 7E4E DBFB            11      IN  A,(0FBH)    ;FDC μPD765A データレジスタリード
00040B 7E50 C9              10      RET
                                
00040C D205                         ORG $$+OFFSET   ;$DEPHASE
       D205                     AT_DSSE:
       D205                     INITE:
00040C D205                         DS  BDOS-INITE
00040D D206 C364D9          10      JP  BDOS_RF
[EOF:88SUB.ASM:SHIFT_JIS]
                                    INCLUDE "88CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   PC-8801mkIISR
                                
       D209                     WBOOT1:
000410 D209 ED7B0600        20      LD  SP,(SYSTEM+1)
000414 D20D DB32            11      IN  A,(032H)
000416 D20F F610             7      OR  10H     ;高速RAMアクセスモードOFF
000418 D211 D332            11      OUT (032H),A
                                
00041A D213 3EEE             7      LD  A,IVRTC/256
00041C D215 ED47             9      LD  I,A
00041E D217 3AB8EF          13      LD  A,(WKE6)
000421 D21A F602             7      OR  2       ;VRTC割り込みマスク
000423 D21C D3E6            11      OUT (0E6H),A    ;割り込みマスク
000425 D21E 32B8EF          13      LD  (WKE6),A
000428 D221 3AB7EF          13      LD  A,(WKE4)
00042B D224 D3E4            11      OUT (0E4H),A    ;割り込みレベル設定 
                                
00042D D226 FB               4      EI
00042E D227 2192EF          10      LD  HL,_KEYD
000431 D22A 3600            10      LD  (HL),0
000433 D22C CDD4DD          17      CALL    CHKEY
000436 D22F CDC5D9          17      CALL    KEYBC_IFBREAK
000439 D232 3E04             7      LD  A,4
00043B D234 CDD8D9          17      CALL    MSG_A
[EOF:88CCP.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D237                     COMMAND:
00043E D237 3A61F1          13      LD  A,(FCB_BAT)
000441 D23A B7               4      OR  A
000442 D23B C27DD3          10      JP  NZ,C_BAT1
000445 D23E CDF1D2          17      CALL    SETDTA1
000448 D241 3A87EF          13      LD  A,(_DVSW)
00044B D244 C641             7      ADD A,'A'
00044D D246 CDD8D9          17      CALL    MSG_A
000450 D249 3E3E             7      LD  A,'>'
000452 D24B CDD8D9          17      CALL    MSG_A
000455 D24E 3E50             7      LD  A,80
000457 D250 12               7      LD  (DE),A
000458 D251 CD16DA          17      CALL    _SYS0A      ;(BDOS)文字列入力
00045B D254 CD72D4          17      CALL    LTNL
       D257                     COMMAND2:
00045E D257 118200          10      LD  DE,DTA1+2
000461 D25A CDFDEF          17      CALL    _COMANL
000464 D25D 30D8            12      JR  NC,COMMAND
000466 D25F 1179EF          10      LD  DE,COMERM
000469 D262 CDD5D6          17      CALL    _SYS09      ;(BDOS)文字列出力
00046C D265 C7              12      RST 0
                                
       D266                     COMANL:
00046D D266 CDB9DE          17      CALL    FILE
000470 D269 3A19EF          13      LD  A,(FNAME+4)
000473 D26C FE20             7      CP  020H
000475 D26E 201C            12      JR  NZ,COMB2
000477 D270 D5              11      PUSH    DE
000478 D271 1115EF          10      LD  DE,FNAME
00047B D274 1A               7      LD  A,(DE)
00047C D275 FE20             7      CP  020H
00047E D277 2844            12      JR  Z,SDVSW
000480 D279 1B               6      DEC DE
000481 D27A 1A               7      LD  A,(DE)
000482 D27B C6FF             7      ADD A,0FFH
000484 D27D 3809            12      JR  C,COMB
000486 D27F 13               6      INC DE
                                
000487 D280 212FD6          10      LD  HL,COMTB
00048A D283 0608             7      LD  B,COMS
00048C D285 CD48E1          17      CALL    CPNAME
       D288                     COMB:
00048F D288 D1              10      POP DE
000490 D289 D20F00          10      JP  NC,JP_HL
       D28C                     COMB2:
000493 D28C EB               4      EX  DE,HL
000494 D28D 225AD3          16      LD  (COMSWC),HL
000497 D290 F5              11      PUSH    AF
000498 D291 CD12D3          17      CALL    CEXE4
00049B D294 F1              10      POP AF
00049C D295 2115EF          10      LD  HL,FNAME
00049F D298 116D00          10      LD  DE,FCB2+1   ;COMMAND NAME
0004A2 D29B 010B00          10      LD  BC,11
0004A5 D29E EDB0                    LDIR
0004A7 D2A0 1100F1          10      LD  DE,PATHD
       D2A3                     CEX1:
0004AA D2A3 1A               7      LD  A,(DE)
0004AB D2A4 FE20             7      CP  020H
0004AD D2A6 D8              11      RET C
0004AE D2A7 CDAEDE          17      CALL    FILEC
0004B1 D2AA D5              11      PUSH    DE
0004B2 D2AB 216D00          10      LD  HL,FCB2+1   ;COMMAND NAME
0004B5 D2AE 1115EF          10      LD  DE,FNAME
0004B8 D2B1 010B00          10      LD  BC,11
0004BB D2B4 EDB0                    LDIR
0004BD D2B6 CD12D3          17      CALL    CEXE4
0004C0 D2B9 D1              10      POP DE
0004C1 D2BA 13               6      INC DE
0004C2 D2BB 18E6            12      JR  CEX1
                                
       D2BD                     SDVSW:
0004C4 D2BD F1              10      POP AF
0004C5 D2BE 3A14EF          13      LD  A,(FDRV)
0004C8 D2C1 3D               4      DEC A
0004C9 D2C2 5F               4      LD  E,A
0004CA D2C3 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
0004CC D2C5 1831            12      JR  SYSTEM0
                                
       D2C7                     OPEN1:
0004CE D2C7 2114EF          10      LD  HL,FDRV
       D2CA                     OPEN:
0004D1 D2CA 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D2CC                     OPEN3:
0004D3 D2CC D5              11      PUSH    DE
0004D4 D2CD 113CF1          10      LD  DE,DTA_CCP
0004D7 D2D0 CDEED2          17      CALL    SETDTA
0004DA D2D3 EB               4      EX  DE,HL
0004DB D2D4 CDF8D2          17      CALL    SYSTEM0
0004DE D2D7 D1              10      POP DE
0004DF D2D8 C9              10      RET
                                
       D2D9                     OPEN2:
0004E0 D2D9 0E12             7      LD  C,012H
0004E2 D2DB 18EF            12      JR  OPEN3
                                
       D2DD                     DEFCB:              ;Z=Ok NZ=Error
0004E4 D2DD 113CF1          10      LD  DE,DTA_CCP
0004E7 D2E0 CDF6D2          17      CALL    SYSC0F
                                
0004EA D2E3 115DF1          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0004ED D2E6 0604             7      LD  B,4
0004EF D2E8 CD43D5          17      CALL    ZERO_MEMORY_DE
       D2EB                     SETDTA100:
0004F2 D2EB 110001          10      LD  DE,00100H
       D2EE                     SETDTA:
0004F5 D2EE C3A8D8          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D2F1                     SETDTA1:
0004F8 D2F1 118000          10      LD  DE,DTA1
0004FB D2F4 18F8            12      JR  SETDTA
                                
       D2F6                     SYSC0F:
0004FD D2F6 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D2F8                     SYSTEM0:
0004FF D2F8 CD0500          17      CALL    SYSTEM
000502 D2FB B7               4      OR  A
000503 D2FC C9              10      RET
                                
       D2FD                     C_CD:
000504 D2FD 0E5A             7      LD  C,05AH
000506 D2FF 18F7            12      JR  SYSTEM0
                                
       D301                     S27BUF:
000508 D301 2100FE          10      LD  HL,-00200H  ;スクラッチエリア(0100H)+スタック予備(0100H)
00050B D304 39              11      ADD HL,SP
00050C D305 2E00             7      LD  L,0
00050E D307 7C               4      LD  A,H
00050F D308 E6F8             7      AND 0F8H
000511 D30A 67               4      LD  H,A
       D30B                     S27DTA:
000512 D30B 113CF1          10      LD  DE,DTA_CCP
       D30E                     S27:
000515 D30E 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
000517 D310 18E6            12      JR  SYSTEM0
                                
       D312                     CEXE4:
000519 D312 211DEF          10      LD  HL,FNAME+8
00051C D315 7E               7      LD  A,(HL)
00051D D316 FE20             7      CP  020H
00051F D318 2007            12      JR  NZ,CEXE7
000521 D31A 3E3F             7      LD  A,'?'
000523 D31C 77               7      LD  (HL),A
000524 D31D 23               6      INC HL
000525 D31E 77               7      LD  (HL),A
000526 D31F 23               6      INC HL
000527 D320 77               7      LD  (HL),A
       D321                     CEXE7:
000528 D321 CDC7D2          17      CALL    OPEN1
       D324                     CEXE5:
00052B D324 C0              11      RET NZ
00052C D325 2A46F1          16      LD  HL,(DTA_CCP+1+9)
00052F D328 7C               4      LD  A,H
000530 D329 CDD0E1          17      CALL    CAP
000533 D32C 67               4      LD  H,A
000534 D32D 7D               4      LD  A,L
000535 D32E CDD0E1          17      CALL    CAP
000538 D331 6F               4      LD  L,A
000539 D332 3A45F1          13      LD  A,(DTA_CCP+1+8)
00053C D335 CDD0E1          17      CALL    CAP
00053F D338 D642             7      SUB 'B'
000541 D33A 282C            12      JR  Z,C_BAT
000543 D33C 3D               4      DEC A       ;'C'
000544 D33D 2805            12      JR  Z,C_EXE
       D33F                     CEXE6:
000546 D33F CDD9D2          17      CALL    OPEN2
000549 D342 18E0            12      JR  CEXE5
                                
       D344                     C_EXE:
00054B D344 7C               4      LD  A,H
00054C D345 FE4D             7      CP  'M'
00054E D347 20F6            12      JR  NZ,CEXE6
                                
000550 D349 CDDDD2          17      CALL    DEFCB
000553 D34C CD01D3          17      CALL    S27BUF
000556 D34F 3D               4      DEC A
000557 D350 37               4      SCF
000558 D351 C0              11      RET NZ
000559 D352 7C               4      LD  A,H
00055A D353 B5               4      OR  L
00055B D354 37               4      SCF
00055C D355 C8              11      RET Z
00055D D356 CDF1D2          17      CALL    SETDTA1
000560 D359 110000          10      LD  DE,0                ; self-modifying code
       D35A                     COMSWC  EQU $-2
000563 D35C ED7B0600        20      LD  SP,(SYSTEM+1)
000567 D360 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000568 D361 6F               4      LD  L,A
000569 D362 E5              11      PUSH    HL              ; push $0000 (reboot address)
00056A D363 24               4      INC H
00056B D364 E5              11      PUSH    HL              ; push $0100 (TPA address)
00056C D365 C30ED5          10      JP  SETFCB              ; and JP $0100
                                
       D368                     C_BAT:
00056F D368 114154          10      LD  DE,'A'+'T'*256
000572 D36B ED52            15      SBC HL,DE
000574 D36D 20D0            12      JR  NZ,CEXE6
                                
000576 D36F CDDDD2          17      CALL    DEFCB
                                
000579 D372 213CF1          10      LD  HL,DTA_CCP
00057C D375 1161F1          10      LD  DE,FCB_BAT
00057F D378 012500          10      LD  BC,37
000582 D37B EDB0                    LDIR
       D37D                     C_BAT1:
000584 D37D CDEBD2          17      CALL    SETDTA100
000587 D380 CDB4D3          17      CALL    FGETC_BAT
00058A D383 218100          10      LD  HL,DTA1+1
00058D D386 2025            12      JR  NZ,END_BATCH
00058F D388 FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
000591 D38A 38F1            12      JR  C,C_BAT1
000593 D38C 3620            10      LD  (HL),' '
000595 D38E 23               6      INC HL
       D38F                     C_BAT2:
000596 D38F 77               7      LD  (HL),A
000597 D390 23               6      INC HL
000598 D391 7D               4      LD  A,L
000599 D392 3C               4      INC A       ;L==0FFH
00059A D393 2809            12      JR  Z,RUN_BATCH
00059C D395 CDB4D3          17      CALL    FGETC_BAT
00059F D398 2004            12      JR  NZ,RUN_BATCH
0005A1 D39A FE20             7      CP  020H
0005A3 D39C 30F1            12      JR  NC,C_BAT2
       D39E                     RUN_BATCH:
0005A5 D39E 7D               4      LD  A,L
0005A6 D39F D67F             7      SUB DTA1-1
0005A8 D3A1 328000          13      LD  (DTA1),A
0005AB D3A4 FE04             7      CP  4
0005AD D3A6 3805            12      JR  C,END_BATCH
0005AF D3A8 3600            10      LD  (HL),0
0005B1 D3AA C357D2          10      JP  COMMAND2
       D3AD                     END_BATCH:
0005B4 D3AD AF               4      XOR A       ;バッチファイルを閉じる
0005B5 D3AE 3261F1          13      LD  (FCB_BAT),A
0005B8 D3B1 C300EF          10      JP  CPM_BOOT
                                
       D3B4                     FGETC_BAT:
0005BB D3B4 1161F1          10      LD  DE,FCB_BAT
       D3B7                     FGETC:              ;1文字ずつ読み込む
0005BE D3B7 E5              11      PUSH    HL      ;Z:成功
0005BF D3B8 210100          10      LD  HL,1
0005C2 D3BB CD0ED3          17      CALL    S27
0005C5 D3BE E1              10      POP HL
0005C6 D3BF 3A0001          13      LD  A,(00100H)
0005C9 D3C2 C9              10      RET
                                
       D3C3                     C_DEL:
0005CA D3C3 CD0ED5          17      CALL    SETFCB
0005CD D3C6 CDEED9          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
0005D0 D3C9 0E13             7      LD  C,013H
0005D2 D3CB 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D3CD                     C_REN:
0005D4 D3CD CD0ED5          17      CALL    SETFCB
0005D7 D3D0 3E10             7      LD  A,010H      ;ディレクトリも対象にする
0005D9 D3D2 326900          13      LD  (FCB1+13),A ;属性
0005DC D3D5 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D3D7                     CDEL1:
0005DE D3D7 115C00          10      LD  DE,FCB1
0005E1 D3DA CD0500          17      CALL    SYSTEM
0005E4 D3DD C6FF             7      ADD A,0FFH
0005E6 D3DF C9              10      RET
                                
       D3E0                     C_DIR:
0005E7 D3E0 CDAEDE          17      CALL    FILEC
0005EA D3E3 2115EF          10      LD  HL,FDRV+1
0005ED D3E6 CD24D6          17      CALL    CWILD1
0005F0 D3E9 3EF1             7      LD  A,0F1H
0005F2 D3EB 3221EF          13      LD  (FDRV+13),A
0005F5 D3EE CDC7D2          17      CALL    OPEN1
       D3F1                     CDIR1:
0005F8 D3F1 B7               4      OR  A
0005F9 D3F2 2008            12      JR  NZ,PDSKF
0005FB D3F4 CD3FD4          17      CALL    P_NAME
0005FE D3F7 CDD9D2          17      CALL    OPEN2
000601 D3FA 18F5            12      JR  CDIR1
       D3FC                     PDSKF:
000603 D3FC 3A14EF          13      LD  A,(FDRV)
000606 D3FF 5F               4      LD  E,A
000607 D400 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
000609 D402 CD0500          17      CALL    SYSTEM
00060C D405 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
00060D D406 C601             7      ADD A,001H
00060F D408 D8              11      RET C       ;Aが0FFHだった場合
000610 D409 3E06             7      LD  A,8-2
       D40B                     PDS1:               ;HL=未使用クラスタの総数
000612 D40B 3C               4      INC A
000613 D40C CB19             8      RR  C
000615 D40E 30FB            12      JR  NC,PDS1
       D410                     PDS2:               ;B←論理セクタのサイズの上位8ビット
000617 D410 3C               4      INC A
000618 D411 CB18             8      RR  B
00061A D413 30FB            12      JR  NC,PDS2
00061C D415 47               4      LD  B,A
                                
00061D D416 110000          10      LD  DE,0
       D419                     PDS3:
000620 D419 29              11      ADD HL,HL
000621 D41A EB               4      EX  DE,HL
000622 D41B ED6A            15      ADC HL,HL
000624 D41D EB               4      EX  DE,HL
000625 D41E 10F9            13      DJNZ    PDS3
       D420                     PDSKF1:
000627 D420 CDACD4          17      CALL    PRDEC_DEHL
00062A D423 1191F1          10      LD  DE,FREE
00062D D426 CDD5D6          17      CALL    _SYS09      ;(BDOS)文字列出力
000630 D429 CD99D4          17      CALL    PUTDRV
000633 D42C 3E5C             7      LD  A,05CH      ;\
000635 D42E CDD8D9          17      CALL    MSG_A
000638 D431 2A22EF          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
00063B D434 AF               4      XOR A
00063C D435 11FEFF          10      LD  DE,0-2
00063F D438 19              11      ADD HL,DE
000640 D439 23               6      INC HL
000641 D43A DCA9D4          17      CALL    C,PRDEC_HL
000644 D43D 1833            12      JR  LTNL
                                
       D43F                     P_NAME:
000646 D43F 3A3DF1          13      LD  A,(DTA_CCP+1)
000649 D442 FE2E             7      CP  '.'
00064B D444 C8              11      RET Z
                                
00064C D445 3A48F1          13      LD  A,(DTA_CCP+1+00BH)
00064F D448 F5              11      PUSH    AF
000650 D449 CB67             8      BIT 4,A
000652 D44B 2808            12      JR  Z,DIR3
000654 D44D 1186F1          10      LD  DE,DIRMES
000657 D450 CDD5D6          17      CALL    _SYS09      ;(BDOS)文字列出力
00065A D453 180A            12      JR  DIR6
       D455                     DIR3:
00065C D455 ED5B5BF1        20      LD  DE,(DTA_CCP+1+01EH)
000660 D459 2A59F1          16      LD  HL,(DTA_CCP+1+01CH)
000663 D45C CDACD4          17      CALL    PRDEC_DEHL
       D45F                     DIR6:
000666 D45F F1              10      POP AF
000667 D460 0F               4      RRCA
000668 D461 9F               4      SBC A,A
000669 D462 E60A             7      AND '*'-020H
00066B D464 C620             7      ADD A,020H
00066D D466 CDD8D9          17      CALL    MSG_A
000670 D469 CD99D4          17      CALL    PUTDRV
000673 D46C 213DF1          10      LD  HL,DTA_CCP+1
000676 D46F CDECD4          17      CALL    FPRNT
                                
       D472                     LTNL:
000679 D472 1E03             7      LD  E,3
00067B D474 C3CDEF          10      JP  _PRINT
                                
       D477                     C_PATH:
00067E D477 CD90DF          17      CALL    SPCUT
000681 D47A 2100F1          10      LD  HL,PATHD
000684 D47D FE21             7      CP  021H
000686 D47F 300C            12      JR  NC,CPATH0
       D481                     CPATHP:
000688 D481 7E               7      LD  A,(HL)
000689 D482 23               6      INC HL
00068A D483 FE20             7      CP  020H
00068C D485 3F               4      CCF
00068D D486 30EA            12      JR  NC,LTNL
00068F D488 CDD8D9          17      CALL    MSG_A
000692 D48B 18F4            12      JR  CPATHP
       D48D                     CPATH0:
000694 D48D FE3B             7      CP  ';'
000696 D48F 2001            12      JR  NZ,CPATH1
000698 D491 13               6      INC DE
       D492                     CPATH1:
000699 D492 EB               4      EX  DE,HL
00069A D493 013B00          10      LD  BC,PATHX
00069D D496 EDB0                    LDIR
00069F D498 C9              10      RET
                                
       D499                     PUTDRV:
0006A0 D499 3A14EF          13      LD  A,(FDRV)
0006A3 D49C CDC3DF          17      CALL    GETDRV1
0006A6 D49F C641             7      ADD A,'A'
0006A8 D4A1 CDD8D9          17      CALL    MSG_A
0006AB D4A4 3E3A             7      LD  A,':'
       D4A6                     MSG_AR:
0006AD D4A6 C3D8D9          10      JP  MSG_A
                                
       D4A9                     PRDEC_HL:
0006B0 D4A9 AF               4      XOR A
0006B1 D4AA 5F               4      LD  E,A
0006B2 D4AB 57               4      LD  D,A
       D4AC                     PRDEC_DEHL:
0006B3 D4AC D5              11      PUSH    DE
0006B4 D4AD 110FEF          10      LD  DE,DECBF
0006B7 D4B0 0605             7      LD  B,5
0006B9 D4B2 CD43D5          17      CALL    ZERO_MEMORY_DE  ;A=0
0006BC D4B5 D1              10      POP DE
                                
0006BD D4B6 0E20             7      LD  C,32
       D4B8                     DEC1:
0006BF D4B8 29              11      ADD HL,HL
0006C0 D4B9 EB               4      EX  DE,HL
0006C1 D4BA ED6A            15      ADC HL,HL
0006C3 D4BC EB               4      EX  DE,HL
0006C4 D4BD E5              11      PUSH    HL
0006C5 D4BE 2113EF          10      LD  HL,DECBF+4
0006C8 D4C1 0605             7      LD  B,5
       D4C3                     DEC2:
0006CA D4C3 7E               7      LD  A,(HL)
0006CB D4C4 8F               4      ADC A,A
0006CC D4C5 27               4      DAA
0006CD D4C6 77               7      LD  (HL),A
0006CE D4C7 2B               6      DEC HL
0006CF D4C8 10F9            13      DJNZ    DEC2
0006D1 D4CA E1              10      POP HL
0006D2 D4CB 0D               4      DEC C
0006D3 D4CC 20EA            12      JR  NZ,DEC1
                                
0006D5 D4CE 210FEF          10      LD  HL,DECBF
0006D8 D4D1 3E20             7      LD  A,020H
0006DA D4D3 0604             7      LD  B,4
       D4D5                     DEC3:
0006DC D4D5 CDE2D4          17      CALL    DEC4
0006DF D4D8 CDE2D4          17      CALL    DEC4
0006E2 D4DB 23               6      INC HL
0006E3 D4DC 10F7            13      DJNZ    DEC3
       D4DE                     DECX:
0006E5 D4DE CDE2D4          17      CALL    DEC4
0006E8 D4E1 AF               4      XOR A
       D4E2                     DEC4:
0006E9 D4E2 ED6F            18      RLD
0006EB D4E4 FE20             7      CP  020H
0006ED D4E6 2802            12      JR  Z,DEC5
0006EF D4E8 F630             7      OR  030H
       D4EA                     DEC5:
0006F1 D4EA 18BA            12      JR  MSG_AR
                                
       D4EC                     FPRNT:
0006F3 D4EC 0608             7      LD  B,8 ;ファイル名を表示
0006F5 D4EE CDFDD4          17      CALL    P_N1
0006F8 D4F1 7E               7      LD  A,(HL)
0006F9 D4F2 CDDCE1          17      CALL    CAP3
0006FC D4F5 D8              11      RET C   ;拡張子が無い
                                
0006FD D4F6 3E2E             7      LD  A,'.'
0006FF D4F8 CDD8D9          17      CALL    MSG_A
000702 D4FB 0603             7      LD  B,3 ;拡張子を表示
       D4FD                     P_N1:
000704 D4FD 7E               7      LD  A,(HL)
000705 D4FE CDDCE1          17      CALL    CAP3
000708 D501 3807            12      JR  C,P_N2
00070A D503 CDD8D9          17      CALL    MSG_A
00070D D506 23               6      INC HL
00070E D507 10F4            13      DJNZ    P_N1
000710 D509 C9              10      RET
       D50A                     P_N2:
000711 D50A 23               6      INC HL
000712 D50B 10FD            13      DJNZ    P_N2
000714 D50D C9              10      RET
                                
       D50E                     SETFCB:
000715 D50E CD90DF          17      CALL    SPCUT
000718 D511 1A               7      LD  A,(DE)
000719 D512 FE20             7      CP  020H
00071B D514 3801            12      JR  C,SETFCBA
00071D D516 1B               6      DEC DE
       D517                     SETFCBA:
00071E D517 0624             7      LD  B,36
000720 D519 215C00          10      LD  HL,FCB1
000723 D51C E5              11      PUSH    HL
000724 D51D AF               4      XOR A
000725 D51E CD65DF          17      CALL    FILL_MEMORY
000728 D521 E1              10      POP HL
000729 D522 D5              11      PUSH    DE
00072A D523 CD0ED9          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
00072D D526 216C00          10      LD  HL,FCB2
000730 D529 CD0ED9          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000733 D52C E1              10      POP HL
000734 D52D 010050          10      LD  BC,05000H
000737 D530 118100          10      LD  DE,00081H
       D533                     SETFCB1:
00073A D533 7E               7      LD  A,(HL)
00073B D534 23               6      INC HL
00073C D535 FE20             7      CP  020H
00073E D537 3805            12      JR  C,SETFCB2
000740 D539 12               7      LD  (DE),A
000741 D53A 13               6      INC DE
000742 D53B 0C               4      INC C
000743 D53C 10F5            13      DJNZ    SETFCB1
       D53E                     SETFCB2:
000745 D53E 79               4      LD  A,C
000746 D53F 328000          13      LD  (DTA1),A
000749 D542 04               4      INC B
       D543                     ZERO_MEMORY_DE:
00074A D543 AF               4      XOR A
       D544                     FILL_MEMORY_DE:
00074B D544 12               7      LD  (DE),A
00074C D545 13               6      INC DE
00074D D546 10FC            13      DJNZ    FILL_MEMORY_DE
00074F D548 C9              10      RET
                                
       D549                     C_COPY:
000750 D549 CD0ED5          17      CALL    SETFCB
                                
000753 D54C 1161EF          10      LD  DE,ZERO
000756 D54F CDB1DE          17      CALL    FILEC2
000759 D552 216C00          10      LD  HL,FCB2
00075C D555 CD15D9          17      CALL    S29X1
                                
00075F D558 3E10             7      LD  A,010H
000761 D55A 326900          13      LD  (FCB1+13),A
000764 D55D 216D00          10      LD  HL,FCB2+1
000767 D560 CD24D6          17      CALL    CWILD1
       D563                     COPY0:
00076A D563 CD21D6          17      CALL    CWILD
00076D D566 215C00          10      LD  HL,FCB1
000770 D569 CDCAD2          17      CALL    OPEN
000773 D56C 37               4      SCF
       D56D                     COPY1:
000774 D56D C0              11      RET NZ
000775 D56E CDDDD2          17      CALL    DEFCB
                                
000778 D571 3A49F1          13      LD  A,(DTA_CCP+13)
00077B D574 CB67             8      BIT 4,A
00077D D576 2821            12      JR  Z,COPY1A
                                
00077F D578 215D00          10      LD  HL,FCB1+1
000782 D57B CDF4E2          17      CALL    CHKWILD
000785 D57E 3814            12      JR  C,COPY9
                                
000787 D580 3E20             7      LD  A,020H
000789 D582 325D00          13      LD  (FCB1+1),A
00078C D585 2A56F1          16      LD  HL,(DTA_CCP+26)
00078F D588 23               6      INC HL
000790 D589 226A00          16      LD  (FCB1+14),HL
000793 D58C 18D5            12      JR  COPY0
                                
       D58E                     COPY8:
000795 D58E CDD5D6          17      CALL    _SYS09      ;(BDOS)文字列出力
000798 D591 CD72D4          17      CALL    LTNL
       D594                     COPY9:
00079B D594 CDD9D2          17      CALL    OPEN2
00079E D597 18D4            12      JR  COPY1
                                
       D599                     COPY1A:
0007A0 D599 216C00          10      LD  HL,FCB2
0007A3 D59C 1114EF          10      LD  DE,FDRV
0007A6 D59F 013EF1          10      LD  BC,DTA_CCP+2
0007A9 D5A2 EDA0            16      LDI
0007AB D5A4 3E0B             7      LD  A,11
       D5A6                     COPY2:
0007AD D5A6 F5              11      PUSH    AF
0007AE D5A7 7E               7      LD  A,(HL)
0007AF D5A8 FE3F             7      CP  '?'
0007B1 D5AA 2001            12      JR  NZ,COPY3
0007B3 D5AC 0A               7      LD  A,(BC)
       D5AD                     COPY3:
0007B4 D5AD 12               7      LD  (DE),A
0007B5 D5AE 03               6      INC BC
0007B6 D5AF 13               6      INC DE
0007B7 D5B0 23               6      INC HL
0007B8 D5B1 F1              10      POP AF
0007B9 D5B2 3D               4      DEC A
0007BA D5B3 20F1            12      JR  NZ,COPY2
0007BC D5B5 010500          10      LD  BC,16-11
0007BF D5B8 EDB0                    LDIR
       D5BA                     PUTNAME:
0007C1 D5BA 215D00          10      LD  HL,FCB1+1
0007C4 D5BD CDF4E2          17      CALL    CHKWILD
0007C7 D5C0 300B            12      JR  NC,PUTN1
0007C9 D5C2 2115EF          10      LD  HL,FDRV+1
0007CC D5C5 CDECD4          17      CALL    FPRNT
0007CF D5C8 3E20             7      LD  A,020H
0007D1 D5CA CDD8D9          17      CALL    MSG_A
       D5CD                     PUTN1:
0007D4 D5CD 1114EF          10      LD  DE,FDRV
0007D7 D5D0 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
0007D9 D5D2 CDF8D2          17      CALL    SYSTEM0
0007DC D5D5 2048            12      JR  NZ,COPYE2
0007DE D5D7 67               4      LD  H,A     ;A=0
0007DF D5D8 6F               4      LD  L,A
0007E0 D5D9 2235EF          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0007E3 D5DC 2237EF          16      LD  (FDRV+35),HL
       D5DF                     COPY6:
0007E6 D5DF CD01D3          17      CALL    S27BUF
0007E9 D5E2 47               4      LD  B,A
0007EA D5E3 3C               4      INC A
0007EB D5E4 2831            12      JR  Z,COPYE
0007ED D5E6 7C               4      LD  A,H
0007EE D5E7 B5               4      OR  L
0007EF D5E8 280C            12      JR  Z,COPY7
0007F1 D5EA 1114EF          10      LD  DE,FDRV
0007F4 D5ED 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0007F6 D5EF CDF8D2          17      CALL    SYSTEM0
0007F9 D5F2 2023            12      JR  NZ,COPYE
0007FB D5F4 10E9            13      DJNZ    COPY6
       D5F6                     COPY7:
0007FD D5F6 3A49F1          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
000800 D5F9 3221EF          13      LD  (FDRV+13),A
000803 D5FC 2150F1          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
000806 D5FF 1128EF          10      LD  DE,FDRV+20
000809 D602 010400          10      LD  BC,4
00080C D605 EDB0                    LDIR
                                
00080E D607 1114EF          10      LD  DE,FDRV
000811 D60A 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
000813 D60C CDF8D2          17      CALL    SYSTEM0
000816 D60F 2006            12      JR  NZ,COPYE
                                
000818 D611 1171EF          10      LD  DE,OK
00081B D614 C38ED5          10      JP  COPY8
                                
       D617                     COPYE:
00081E D617 1114EF          10      LD  DE,FDRV
000821 D61A 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
000823 D61C CD0500          17      CALL    SYSTEM
       D61F                     COPYE2:
000826 D61F 37               4      SCF
000827 D620 C9              10      RET
                                
       D621                     CWILD:
000828 D621 215D00          10      LD  HL,FCB1+1
       D624                     CWILD1:
00082B D624 7E               7      LD  A,(HL)
00082C D625 FE20             7      CP  020H
00082E D627 C0              11      RET NZ
       D628                     CWILD2:
00082F D628 3E3F             7      LD  A,'?'
000831 D62A 060B             7      LD  B,11
000833 D62C C365DF          10      JP  FILL_MEMORY
                                
       D62F                     COMTB:
000836 D62F 44202020                DB  "D   "  ;1
00083A D633 E0D3                    DW  C_DIR
00083C D635 44495220                DB  "DIR "  ;2
000840 D639 E0D3                    DW  C_DIR
000842 D63B 434F5059                DB  "COPY"  ;3
000846 D63F 49D5                    DW  C_COPY
000848 D641 43442020                DB  "CD  "  ;4
00084C D645 FDD2                    DW  C_CD
00084E D647 44454C20                DB  "DEL "  ;5
000852 D64B C3D3                    DW  C_DEL
000854 D64D 50415448                DB  "PATH"  ;6
000858 D651 77D4                    DW  C_PATH
00085A D653 52454E20                DB  "REN "  ;7
00085E D657 CDD3                    DW  C_REN
000860 D659 52454D20                DB  "REM "  ;8
000864 D65D D2D6                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "88DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   PC-8801mkIISR
                                
                                ;   BANK RAM DISK DRIVER
                                
       D65F                     BDWT:
000866 D65F 3E10             7      LD  A,010H  ;ライト可　リード不可
000868 D661 1802            12  JR  BRW
                                
       D663                     BDRD:
00086A D663 3E01             7      LD  A,001H  ;ライト不可　リード可
       D665                     BRW:
00086C D665 F3               4      DI
00086D D666 D3E2            11      OUT (0E2H),A    ;拡張RAM リード/ライト制御
00086F D668 ED739FD6        20      LD  (BANKSP),SP
000873 D66C 3AA0D6          13      LD  A,(BANKSPH)
000876 D66F 87               4      ADD A,A
000877 D670 3803            12      JR  C,BRW1
000879 D672 312EEE          10      LD  SP,EXTSP    ;拡張メモリにスタックが重なる場合
       D675                     BRW1:
00087C D675 C5              11      PUSH    BC
00087D D676 D5              11      PUSH    DE
00087E D677 EB               4      EX  DE,HL       ;DE=メインメモリ
00087F D678 29              11      ADD HL,HL
000880 D679 29              11      ADD HL,HL
000881 D67A 7C               4      LD  A,H
000882 D67B DD860C          19      ADD A,(IX+DPB_MAXCYL)
000885 D67E D3E3            11      OUT (0E3H),A    ;拡張RAM バンク選択
000887 D680 65               4      LD  H,L
000888 D681 CB3C             8      SRL H   ;/2
00088A D683 2E00             7      LD  L,0
00088C D685 DBE2            11      IN  A,(0E2H)    ;拡張RAM リード/ライト制御
00088E D687 0F               4      RRCA
00088F D688 3001            12      JR  NC,BRW2     ;0: リード可
000891 D68A EB               4      EX  DE,HL       ;DE=拡張メモリ HL=メインメモリ
       D68B                     BRW2:
000892 D68B 010002          10      LD  BC,512
000895 D68E EDB0                    LDIR
                                
000897 D690 DBE2            11      IN  A,(0E2H)    ;拡張RAM リード/ライト制御
000899 D692 0F               4      RRCA
00089A D693 3801            12      JR  C,BRW3      ;1: リード不可
00089C D695 EB               4      EX  DE,HL       ;DE=拡張メモリ HL=メインメモリ
       D696                     BRW3:
00089D D696 D1              10      POP DE
00089E D697 C1              10      POP BC
00089F D698 13               6      INC DE
0008A0 D699 10DA            13      DJNZ    BRW1
                                
0008A2 D69B AF               4      XOR A
0008A3 D69C D3E2            11      OUT (0E2H),A    ;メインメモリに切り替える
0008A5 D69E 310000          10      LD  SP,0
       D69F                     BANKSP  EQU $-2
       D6A0                     BANKSPH EQU $-1
0008A8 D6A1 FB               4      EI
0008A9 D6A2 C9              10      RET
                                
[EOF:88DISK2.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D6A3                     BDOS0:
0008AA D6A3 E5              11      PUSH    HL
0008AB D6A4 79               4      LD  A,C
0008AC D6A5 FE3C             7      CP  03CH
0008AE D6A7 3802            12      JR  C,DOS1
0008B0 D6A9 3E3C             7      LD  A,03CH
       D6AB                     DOS1:
0008B2 D6AB 87               4      ADD A,A
0008B3 D6AC 6F               4      LD  L,A
0008B4 D6AD 26F0             7      LD  H,STABLE/256
0008B6 D6AF 7E               7      LD  A,(HL)
0008B7 D6B0 2C               4      INC L
0008B8 D6B1 66               7      LD  H,(HL)
0008B9 D6B2 6F               4      LD  L,A
0008BA D6B3 E3              19      EX  (SP),HL
0008BB D6B4 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
0008BC D6B5 C9              10      RET
       D6B6                     _DOS2:
0008BD D6B6 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
0008BF D6B8 CA50D9          10      JP  Z,_SYS5A
0008C2 D6BB FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
0008C4 D6BD CA0ED9          10      JP  Z,_SYS29
0008C7 D6C0 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
0008C9 D6C2 CA01EC          10      JP  Z,_SYS5F
0008CC D6C5 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
0008CE D6C7 200A            12      JR  NZ,_ERROR
0008D0 D6C9 011D01          10      LD  BC,VER_6F
0008D3 D6CC 116001          10      LD  DE,VER
0008D6 D6CF 210201          10      LD  HL,MACD
       D6D2                     C_REM:
0008D9 D6D2 AF               4      XOR A
       D6D3                     _ERROR:
0008DA D6D3 A7               4      AND A
0008DB D6D4 C9              10      RET
                                
       D6D5                     _SYS09:     ;文字列出力
0008DC D6D5 D5              11      PUSH    DE
       D6D6                     _SX09:
0008DD D6D6 1A               7      LD  A,(DE)
0008DE D6D7 13               6      INC DE
0008DF D6D8 FE24             7      CP  '$'
0008E1 D6DA 2831            12      JR  Z,SX0E2
0008E3 D6DC CDD8D9          17      CALL    MSG_A
0008E6 D6DF 18F5            12      JR  _SX09
                                
       D6E1                     MSX1:
0008E8 D6E1 CDD8D9          17      CALL    MSG_A
       D6E4                     MSX:
0008EB D6E4 7E               7      LD  A,(HL)
0008EC D6E5 23               6      INC HL
0008ED D6E6 B7               4      OR  A
0008EE D6E7 20F8            12      JR  NZ,MSX1
0008F0 D6E9 C9              10      RET
                                
       D6EA                     _SYS0C:     ;(BDOS)バージョン番号の獲得
0008F1 D6EA 212200          10      LD  HL,00022H
0008F4 D6ED 7D               4      LD  A,L
0008F5 D6EE C9              10      RET
                                
       D6EF                     _SYS0D:     ;(BDOS)ディスクリセット
0008F6 D6EF CDDFEF          17      CALL    _FFLUSH
0008F9 D6F2 E5              11      PUSH    HL
0008FA D6F3 218000          10      LD  HL,00080H
0008FD D6F6 228AEF          16      LD  (_DTA),HL
000900 D6F9 E1              10      POP HL
000901 D6FA D5              11      PUSH    DE
000902 D6FB 1E00             7      LD  E,0
000904 D6FD 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D6FE                     _SYS0E:     ;(BDOS)カレントドライブの設定
000905 D6FE D5              11      PUSH    DE
000906 D6FF 7B               4      LD  A,E
000907 D700 DDE5            15      PUSH    IX
000909 D702 CDDCEF          17      CALL    _GETDPB
00090C D705 DDE1            14      POP IX
00090E D707 3804            12      JR  C,SX0E2
000910 D709 7B               4      LD  A,E
000911 D70A 3287EF          13      LD  (_DVSW),A
       D70D                     SX0E2:
000914 D70D D1              10      POP DE
000915 D70E C9              10      RET
                                
       D70F                     _SYS0F:     ;(BDOS)ファイルのオープン
000916 D70F CDA2DF          17      CALL    SETDRV
000919 D712 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00091C D715 C602             7      ADD A,002H      ;Write
00091E D717 2848            12      JR  Z,FEND0F
000920 D719 CDF0E2          17      CALL    CHKWILDX
                                
000923 D71C D4CCDF          17      CALL    NC,SOPENX
       D71F                     _S16XX:
000926 D71F 3840            12      JR  C,FEND0F
                                                ;Directory location
000928 D721 3A9FEF          13      LD  A,(_FILEN)
00092B D724 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
00092E D727 3AA0EF          13      LD  A,(_DIRF)
000931 D72A FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000934 D72D FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
000937 D730 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
00093A D733 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
00093E D737 FDE5            15      PUSH    IY
000940 D739 D1              10      POP DE
000941 D73A 13               6      INC DE
000942 D73B 010B00          10      LD  BC,11
000945 D73E EDB0                    LDIR
                                ;               Attribute
000947 D740 7E               7      LD  A,(HL)
000948 D741 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
00094B D744 110B00          10      LD  DE,11       ;Reserved
00094E D747 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
00094F D748 11E4F0          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
000952 D74B 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D74D                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000954 D74D 1A               7      LD  A,(DE)
000955 D74E 13               6      INC DE
000956 D74F 3256D7          13      LD  (S16PAT),A
000959 D752 7E               7      LD  A,(HL)
00095A D753 23               6      INC HL
00095B D754 FD7700          19      LD  (IY+0),A
       D756                     S16PAT  EQU $-1
00095E D757 10F4            13      DJNZ    S16LOOP
                                
000960 D759 AF               4      XOR A
000961 D75A FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000964 D75D FD22FED7        20      LD  (OFCB_SWC),IY
       D761                     FEND0F:
000968 D761 1845            12      JR  FEND10
                                
       D763                     _SYS10:     ;(BDOS)ファイルのクローズ
00096A D763 CDA2DF          17      CALL    SETDRV
00096D D766 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000970 D769 D6FE             7      SUB 0FEH
000972 D76B 37               4      SCF
000973 D76C 3F               4      CCF
000974 D76D 2039            12      JR  NZ,FEND10
       D76F                     _S10A:              ;Write
000976 D76F FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000979 D772 FD770F          19      LD  (IY+15),A
                                
00097C D775 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
00097F D778 CDECE3          17      CALL    SETTMS
                                
000982 D77B FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000985 D77E 32A0EF          13      LD  (_DIRF),A
000988 D781 E67F             7      AND 07FH
00098A D783 3217E9          13      LD  (_SECPS),A
00098D D786 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000990 D789 FD561F          19      LD  D,(IY+31)
000993 D78C CD01E1          17      CALL    READ_DIR
000996 D78F 3817            12      JR  C,FEND10
                                
000998 D791 3A2CE0          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
00099B D794 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
00099C D795 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
00099F D798 6F               4      LD  L,A
0009A0 D799 2600             7      LD  H,0
0009A2 D79B 29              11      ADD HL,HL       ;*2
0009A3 D79C 29              11      ADD HL,HL       ;*4
0009A4 D79D 29              11      ADD HL,HL       ;*8
0009A5 D79E 29              11      ADD HL,HL       ;*16
0009A6 D79F 29              11      ADD HL,HL       ;*32
0009A7 D7A0 ED4B7EF0        20      LD  BC,(_DTBUF)
0009AB D7A4 09              11      ADD HL,BC
                                
0009AC D7A5 CD00E3          17      CALL    SDIRENT
       D7A8                     FEND10:
0009AF D7A8 1842            12      JR  FEND
                                
       D7AA                     _SYS11:     ;(BDOS)最初のファイルの検索
0009B1 D7AA CDA2DF          17      CALL    SETDRV
0009B4 D7AD CDFBDF          17      CALL    SOPEN
       D7B0                     _S12X1:
0009B7 D7B0 383A            12      JR  C,FEND
0009B9 D7B2 CD9AE0          17      CALL    SOPENE2
0009BC D7B5 ED5B8AEF        20      LD  DE,(_DTA)
0009C0 D7B9 3A88EF          13      LD  A,(_DRV)
0009C3 D7BC 3C               4      INC A
0009C4 D7BD 12               7      LD  (DE),A
0009C5 D7BE D5              11      PUSH    DE
0009C6 D7BF 13               6      INC DE
0009C7 D7C0 012000          10      LD  BC,32
0009CA D7C3 EDB0                    LDIR
0009CC D7C5 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
0009CF D7C8 FD660F          19      LD  H,(IY+15)
0009D2 D7CB 22F4F0          16      LD  (SCDIR),HL
0009D5 D7CE 2A9AEF          16      LD  HL,(_FBPS)
0009D8 D7D1 22F6F0          16      LD  (SFBPS),HL
0009DB D7D4 2A9FEF          16      LD  HL,(_FILEN)
0009DE D7D7 7C               4      LD  A,H
0009DF D7D8 B7               4      OR  A
0009E0 D7D9 2806            12      JR  Z,_S12DIR
0009E2 D7DB 3A17E9          13      LD  A,(_SECPS)
0009E5 D7DE F680             7      OR  080H
0009E7 D7E0 67               4      LD  H,A
       D7E1                     _S12DIR:
0009E8 D7E1 22F8F0          16      LD  (SFNDF),HL  ;Directory position and Flags
0009EB D7E4 E1              10      POP HL
0009EC D7E5 1139EF          10      LD  DE,SFILE
0009EF D7E8 0E21             7      LD  C,33
       D7EA                     _S11B:
0009F1 D7EA EDB0                    LDIR
       D7EC                     FEND:
0009F3 D7EC 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D7ED                     FENDE:
0009F4 D7ED FDE1            14      POP IY
0009F6 D7EF C1              10      POP BC
0009F7 D7F0 D1              10      POP DE
0009F8 D7F1 E1              10      POP HL
0009F9 D7F2 C9              10      RET
                                
       D7F3                     _SYS12:     ;(BDOS)次のファイルの検索
0009FA D7F3 E5              11      PUSH    HL
0009FB D7F4 D5              11      PUSH    DE
0009FC D7F5 C5              11      PUSH    BC
0009FD D7F6 FDE5            15      PUSH    IY
0009FF D7F8 CD5FE0          17      CALL    NOPEN
000A02 D7FB 18B3            12      JR  _S12X1
                                
       D7FD                     _S16K:
000A04 D7FD 110000          10      LD  DE,0
       D7FE                     OFCB_SWC    EQU $-2
000A07 D800 D5              11      PUSH    DE
000A08 D801 061A             7      LD  B,26        ;First cluster
       D803                     S16K1:
000A0A D803 13               6      INC DE
000A0B D804 23               6      INC HL
000A0C D805 10FC            13      DJNZ    S16K1
                                
000A0E D807 1A               7      LD  A,(DE)
000A0F D808 BE               7      CP  (HL)
000A10 D809 2015            12      JR  NZ,S16K2
000A12 D80B 13               6      INC DE
000A13 D80C 23               6      INC HL
000A14 D80D 1A               7      LD  A,(DE)
000A15 D80E BE               7      CP  (HL)
000A16 D80F 200F            12      JR  NZ,S16K2
                                
000A18 D811 E1              10      POP HL
000A19 D812 FDE5            15      PUSH    IY
000A1B D814 D1              10      POP DE
000A1C D815 7E               7      LD  A,(HL)
000A1D D816 CDB7DF          17      CALL    IS_SAME_DRV_A_DE
000A20 D819 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000A22 D81B ED52            15      SBC HL,DE       ;CP HL,DE
000A24 D81D 37               4      SCF
000A25 D81E C0              11      RET NZ
000A26 D81F E5              11      PUSH    HL
       D820                     S16K2:
000A27 D820 E1              10      POP HL
       D821                     S16K3:
000A28 D821 FDE5            15      PUSH    IY
000A2A D823 D1              10      POP DE
       D824                     _SYS13:     ;(BDOS)ファイルの削除
000A2B D824 CDA2DF          17      CALL    SETDRV
000A2E D827 CD26E2          17      CALL    KILL
       D82A                     FEND13:
000A31 D82A 18C0            12      JR  FEND
                                
       D82C                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000A33 D82C CDA2DF          17      CALL    SETDRV
000A36 D82F CD58E4          17      CALL    INIT_SEQ
       D832                     SREAD:
000A39 D832 CDA0E4          17      CALL    RB_READ
                                
000A3C D835 C601             7      ADD A,001H
000A3E D837 38B3            12      JR  C,FEND
                                
000A40 D839 7D               4      LD  A,L
000A41 D83A D601             7      SUB 001H
       D83C                     FENDX:
000A43 D83C 9F               4      SBC A,A
000A44 D83D E603             7      AND 3
000A46 D83F 1F               4      RRA
000A47 D840 18AB            12      JR  FENDE
                                
       D842                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000A49 D842 CDA2DF          17      CALL    SETDRV
000A4C D845 CD58E4          17      CALL    INIT_SEQ
       D848                     SWRITE:
000A4F D848 CD99E4          17      CALL    RB_WRITE
                                
000A52 D84B C6FF             7      ADD A,0FFH
000A54 D84D 18ED            12      JR  FENDX
                                
       D84F                     _SYS17:     ;(BDOS)ファイル名の変更
000A56 D84F CDA2DF          17      CALL    SETDRV
000A59 D852 CD7CE2          17      CALL    NAME
000A5C D855 18D3            12      JR  FEND13
                                
       D857                     _SYS16:     ;(BDOS)ファイルの作成
000A5E D857 CDA2DF          17      CALL    SETDRV
                                
000A61 D85A CDF0E2          17      CALL    CHKWILDX
000A64 D85D 38CB            12      JR  C,FEND13
000A66 D85F FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000A69 D862 FE05             7      CP  5
000A6B D864 2805            12      JR  Z,_S16X2
000A6D D866 FE21             7      CP  021H
000A6F D868 DA2AD8          10      JP  C,FEND13
       D86B                     _S16X2:
                                ;               Clear FCB
000A72 D86B FDE5            15      PUSH    IY
000A74 D86D E1              10      POP HL
000A75 D86E 011000          10      LD  BC,16
000A78 D871 09              11      ADD HL,BC
       D872                     _S16X1:
000A79 D872 70               7      LD  (HL),B      ;B=0
000A7A D873 23               6      INC HL
000A7B D874 0D               4      DEC C
000A7C D875 20FB            12      JR  NZ,_S16X1
                                
000A7E D877 CDF1E3          17      CALL    SETTMSX
000A81 D87A FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000A85 D87E CDCCDF          17      CALL    SOPENX
000A88 D881 3F               4      CCF
000A89 D882 CCFDD7          17      CALL    Z,_S16K
000A8C D885 D4ABE0          17      CALL    NC,COPEN
000A8F D888 D400E3          17      CALL    NC,SDIRENT
000A92 D88B C31FD7          10      JP  _S16XX
                                
       D88E                     _SYS21:     ;(BDOS)ランダムな読み出し
000A95 D88E CDA2DF          17      CALL    SETDRV
000A98 D891 CD3CE4          17      CALL    INIT_RND
000A9B D894 189C            12      JR  SREAD
                                
       D896                     _SYS22:     ;(BDOS)ランダムな書き込み
       D896                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000A9D D896 CDA2DF          17      CALL    SETDRV
000AA0 D899 CD3CE4          17      CALL    INIT_RND
000AA3 D89C 18AA            12      JR  SWRITE
                                
       D89E                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000AA5 D89E 21FF00          10      LD  HL,000FFH
000AA8 D8A1 AF               4      XOR A
000AA9 D8A2 C9              10      RET
                                
       D8A3                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000AAA D8A3 3A87EF          13      LD  A,(_DVSW)
000AAD D8A6 A7               4      AND A
000AAE D8A7 C9              10      RET
                                
       D8A8                     _SYS1A:     ;(BDOS)DTAの設定
000AAF D8A8 ED538AEF        20      LD  (_DTA),DE
000AB3 D8AC AF               4      XOR A
000AB4 D8AD C9              10      RET
                                
       D8AE                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000AB5 D8AE 7B               4      LD  A,E
000AB6 D8AF CDB0DF          17      CALL    GETDRV
000AB9 D8B2 CDDCEF          17      CALL    _GETDPB
000ABC D8B5 D4E2EF          17      CALL    NC,_RDFATX
000ABF D8B8 210000          10      LD  HL,0
000AC2 D8BB D4CAE3          17      CALL    NC,DSKF
                                
000AC5 D8BE ED5BCBE3        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000AC9 D8C2 1B               6      DEC DE      ;DE←クラスタの総数
000ACA D8C3 FD2A7CF0        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000ACE D8C7 9F               4      SBC A,A
000ACF D8C8 D8              11      RET C
000AD0 D8C9 4F               4      LD  C,A     ;C=0
000AD1 D8CA DD7E0F          19      LD  A,(IX+DPB_BPS)
000AD4 D8CD E607             7      AND 7
000AD6 D8CF 47               4      LD  B,A
000AD7 D8D0 DD7E07          19      LD  A,(IX+DPB_SECPCL)
000ADA D8D3 C9              10      RET
                                
       D8D4                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000ADB D8D4 AF               4      XOR A
000ADC D8D5 67               4      LD  H,A
000ADD D8D6 6F               4      LD  L,A
000ADE D8D7 C9              10      RET
                                
       D8D8                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000ADF D8D8 2100F2          10      LD  HL,_DEVICE
000AE2 D8DB 7B               4      LD  A,E
000AE3 D8DC C3DCEF          10      JP  _GETDPB
                                
       D8DF                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000AE6 D8DF E5              11      PUSH    HL
000AE7 D8E0 2A1EF0          16      LD  HL,(STABLE+2*00FH)  ;ファイルのオープン
000AEA D8E3 CD0F00          17      CALL    JP_HL
000AED D8E6 381B            12      JR  C,_S23X1
                                
000AEF D8E8 D5              11      PUSH    DE      ;EX DE,IY
000AF0 D8E9 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000AF2 D8EB FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000AF5 D8EE FD6E11          19      LD  L,(IY+17)   ;
000AF8 D8F1 FD6612          19      LD  H,(IY+18)   ;
000AFB D8F4 C5              11      PUSH    BC      ;
000AFC D8F5 FD4613          19      LD  B,(IY+19)   ;
000AFF D8F8 CD2EE4          17      CALL    GET_CPM_R_SIZE
000B02 D8FB C1              10      POP BC
       D8FC                     _S24X1:
000B03 D8FC CD4EE4          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000B06 D8FF FDE3            23      EX  (SP),IY     ;
000B08 D901 D1              10      POP DE      ;
                                
000B09 D902 AF               4      XOR A
       D903                     _S23X1:
000B0A D903 E1              10      POP HL
000B0B D904 C9              10      RET
                                
       D905                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000B0C D905 E5              11      PUSH    HL
000B0D D906 D5              11      PUSH    DE      ;EX DE,IY
000B0E D907 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000B10 D909 CD60E4          17      CALL    GETSEQ
000B13 D90C 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D90E                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000B15 D90E C5              11      PUSH    BC
000B16 D90F E5              11      PUSH    HL
000B17 D910 CDB9DE          17      CALL    FILE
000B1A D913 E1              10      POP HL
000B1B D914 C1              10      POP BC
       D915                     S29X1:
000B1C D915 C5              11      PUSH    BC
000B1D D916 D5              11      PUSH    DE
000B1E D917 E5              11      PUSH    HL
000B1F D918 EB               4      EX  DE,HL
000B20 D919 AF               4      XOR A
000B21 D91A 3221EF          13      LD  (FDRV+13),A
000B24 D91D 2114EF          10      LD  HL,FDRV
000B27 D920 011000          10      LD  BC,16
000B2A D923 EDB0                    LDIR
000B2C D925 E1              10      POP HL
000B2D D926 D1              10      POP DE
000B2E D927 C1              10      POP BC
000B2F D928 C9              10      RET
                                
       D929                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000B30 D929 C5              11      PUSH    BC
000B31 D92A 01B1EA          10      LD  BC,DWT24B
000B34 D92D 1804            12      JR  S2FX
       D92F                     _SYS2F:
000B36 D92F C5              11      PUSH    BC
000B37 D930 01A1EA          10      LD  BC,DRD24B
       D933                     S2FX:
000B3A D933 ED4349D9        20      LD  (S2FPAT+1),BC
000B3E D937 CDDFEF          17      CALL    _FFLUSH
                                
000B41 D93A D5              11      PUSH    DE
000B42 D93B E5              11      PUSH    HL
000B43 D93C 7D               4      LD  A,L     ;Drive
000B44 D93D CDD9EF          17      CALL    _CHGDRV
000B47 D940 3809            12      JR  C,S30X2
000B49 D942 44               4      LD  B,H     ;Number of clusters
000B4A D943 2A8AEF          16      LD  HL,(_DTA)
                                
000B4D D946 0E00             7      LD  C,0
000B4F D948 CDA1EA          17  S2FPAT: CALL    DRD24B
       D94B                     S30X2:
000B52 D94B E1              10      POP HL
000B53 D94C D1              10      POP DE
000B54 D94D C1              10      POP BC
000B55 D94E 9F               4      SBC A,A
000B56 D94F C9              10      RET
                                
       D950                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000B57 D950 C5              11      PUSH    BC
000B58 D951 D5              11      PUSH    DE
000B59 D952 E5              11      PUSH    HL
000B5A D953 CDAEDE          17      CALL    FILEC
000B5D D956 210000          10      LD  HL,0
000B60 D959 1114EF          10      LD  DE,FDRV
000B63 D95C 2A4EF0          16      LD  HL,(STABLE+2*027H)  ;ランダムブロック読み込み
000B66 D95F CD0F00          17      CALL    JP_HL
000B69 D962 18E7            12      JR  S30X2
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "88IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   PC-8801mkIISR
                                
       D6D3                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D6D3                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D6D3                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D6D3                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D6D3                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D6D3                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       D964                     BDOS_RF:
000B6B D964 DB32            11      IN  A,(032H)
000B6D D966 F610             7      OR  010H        ;高速RAMアクセスモードOFF
000B6F D968 D332            11      OUT (032H),A
000B71 D96A C3A3D6          10      JP  BDOS0
                                
       D96D                     INTVRTC:
000B74 D96D F3               4      DI
000B75 D96E F5              11      PUSH    AF
000B76 D96F CDD4DD          17      CALL    CHKEY
000B79 D972 FE00             7      CP  0
       D973                     KEYDT   EQU $-1
000B7B D974 2028            12      JR  NZ,SETKEY1
000B7D D976 E5              11      PUSH    HL
000B7E D977 2A90EF          16      LD  HL,(_KEYPS)
000B81 D97A 7C               4      LD  A,H
000B82 D97B AD               4      XOR L
000B83 D97C E1              10      POP HL
000B84 D97D 2011            12      JR  NZ,ENDKEY
000B86 D97F 3E00             7      LD  A,0
       D980                     KEYAR   EQU $-1
000B88 D981 B7               4      OR  A
000B89 D982 2014            12      JR  NZ,ARWKEY
       D984                     SETKEY:
000B8B D984 3280D9          13      LD  (KEYAR),A
000B8E D987 3A92EF          13      LD  A,(_KEYD)
000B91 D98A 3273D9          13      LD  (KEYDT),A
000B94 D98D CDABD9          17      CALL    KEYSET
       D990                     ENDKEY:
000B97 D990 3AB7EF          13      LD  A,(WKE4)
000B9A D993 D3E4            11      OUT (0E4H),A
000B9C D995 F1              10      POP AF
000B9D D996 FB               4      EI
000B9E D997 C9              10      RET
       D998                     ARWKEY:
000B9F D998 3D               4      DEC A
000BA0 D999 3280D9          13      LD  (KEYAR),A
000BA3 D99C 18F2            12      JR  ENDKEY
       D99E                     SETKEY1:
000BA5 D99E 3A95EF          13      LD  A,(_KEYSP+1)
000BA8 D9A1 18E1            12      JR  SETKEY
                                
       D9A3                     INTE88:
000BAA D9A3 F5              11      PUSH    AF
000BAB D9A4 3AB7EF          13      LD  A,(WKE4)
000BAE D9A7 D3E4            11      OUT (0E4H),A
000BB0 D9A9 F1              10      POP AF
000BB1 D9AA C9              10      RET
       D9AB                     KEYSET:
       D9AB                     KEYBS:
000BB2 D9AB B7               4      OR  A
000BB3 D9AC C8              11      RET Z
       D9AD                     KEYBS1:
000BB4 D9AD CDC5D9          17      CALL    KEYBC_IFBREAK
000BB7 D9B0 E5              11      PUSH    HL
000BB8 D9B1 F5              11      PUSH    AF
000BB9 D9B2 2A90EF          16      LD  HL,(_KEYPS)
000BBC D9B5 2C               4      INC L
000BBD D9B6 CBAD             8      RES 5,L
000BBF D9B8 7D               4      LD  A,L
000BC0 D9B9 BC               4      CP  H
000BC1 D9BA 2815            12      JR  Z,POP_AF_HL_SCF_RET
000BC3 D9BC 3290EF          13      LD  (_KEYPS),A
000BC6 D9BF 26FF             7      LD  H,KEYBF/256
000BC8 D9C1 F1              10      POP AF
000BC9 D9C2 77               7      LD  (HL),A
000BCA D9C3 E1              10      POP HL
000BCB D9C4 C9              10      RET
       D9C5                     KEYBC_IFBREAK:
000BCC D9C5 FE03             7      CP  3
000BCE D9C7 C0              11      RET NZ
       D9C8                     KEYBC:
000BCF D9C8 E5              11      PUSH    HL
000BD0 D9C9 210000          10      LD  HL,0
000BD3 D9CC 2290EF          16      LD  (_KEYPS),HL
000BD6 D9CF E1              10      POP HL
000BD7 D9D0 C9              10      RET
                                
       D9D1                     POP_AF_HL_SCF_RET:
000BD8 D9D1 F1              10      POP AF
000BD9 D9D2 E1              10      POP HL
000BDA D9D3 37               4      SCF
000BDB D9D4 C9              10      RET
                                
       D9D5                     _SYS01:     ;(BDOS)コンソール入力
000BDC D9D5 CD09EF          17      CALL    _SYS07
       D9D8                     MSG_A:
000BDF D9D8 F5              11      PUSH    AF
000BE0 D9D9 D5              11      PUSH    DE
000BE1 D9DA 5F               4      LD  E,A
000BE2 D9DB CDE1D9          17      CALL    _SYS02
000BE5 D9DE D1              10      POP DE
000BE6 D9DF F1              10      POP AF
000BE7 D9E0 C9              10      RET
                                
       D9E1                     _SYS02:     ;(BDOS)コンソール出力
000BE8 D9E1 CDF3D9          17      CALL    BREAK
000BEB D9E4 1805            12      JR  PRINTX
                                
       D9E6                     _SYS06:     ;(BDOS)コンソール直接入出力
000BED D9E6 7B               4      LD  A,E
000BEE D9E7 3C               4      INC A
000BEF D9E8 CACAEF          10      JP  Z,_INKEY
       D9EB                     PRINTX:
000BF2 D9EB C3CDEF          10      JP  _PRINT
                                
       D9EE                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000BF5 D9EE CD09EF          17      CALL    _SYS07
000BF8 D9F1 1804            12      JR  BREAK1
       D9F3                     BREAK:
000BFA D9F3 FB               4      EI
000BFB D9F4 3A92EF          13      LD  A,(_KEYD)
       D9F7                     BREAK1:
000BFE D9F7 FE03             7      CP  3       ;CTRL+C
000C00 D9F9 CA00EF          10      JP  Z,CPM_BOOT
000C03 D9FC FE13             7      CP  013H        ;CTRL+S
000C05 D9FE C0              11      RET NZ
                                
       D9FF                     PAUSE:
000C06 D9FF CDC8D9          17      CALL    KEYBC
                                
       DA02                     FLGET:
000C09 DA02 CDDFEF          17      CALL    _FFLUSH
000C0C DA05 E5              11      PUSH    HL
000C0D DA06 2A8EEF          16      LD  HL,(_TXADR)
000C10 DA09 CD93DC          17      CALL    CURSOR_ON
       DA0C                     FLGET1:
000C13 DA0C CDCAEF          17      CALL    _INKEY
000C16 DA0F 28FB            12      JR  Z,FLGET1
000C18 DA11 CDA4DC          17      CALL    CURSOR_OFF
000C1B DA14 E1              10      POP HL
000C1C DA15 C9              10      RET
                                
       DA16                     _SYS0A:     ;(BDOS)文字列入力
000C1D DA16 C5              11      PUSH    BC
000C1E DA17 E5              11      PUSH    HL
000C1F DA18 D5              11      PUSH    DE
000C20 DA19 CD63DD          17      CALL    GETL
000C23 DA1C 1120FF          10      LD  DE,KBUF
000C26 DA1F E1              10      POP HL
000C27 DA20 E5              11      PUSH    HL
000C28 DA21 0E00             7      LD  C,0
000C2A DA23 3004            12      JR  NC,SAX0
000C2C DA25 23               6      INC HL
000C2D DA26 23               6      INC HL
000C2E DA27 1808            12      JR  SAX4
       DA29                     SAX0:
000C30 DA29 46               7      LD  B,(HL)
000C31 DA2A 23               6      INC HL
       DA2B                     SAX1:
000C32 DA2B 23               6      INC HL
000C33 DA2C 1A               7      LD  A,(DE)
000C34 DA2D 13               6      INC DE
000C35 DA2E B7               4      OR  A
000C36 DA2F 2004            12      JR  NZ,SAX2
       DA31                     SAX4:
000C38 DA31 360D            10      LD  (HL),00DH
000C3A DA33 1804            12      JR  SAX3
       DA35                     SAX2:
000C3C DA35 77               7      LD  (HL),A
000C3D DA36 0C               4      INC C
000C3E DA37 10F2            13      DJNZ    SAX1
       DA39                     SAX3:
000C40 DA39 D1              10      POP DE
000C41 DA3A 79               4      LD  A,C
000C42 DA3B 13               6      INC DE
000C43 DA3C 12               7      LD  (DE),A
000C44 DA3D 1B               6      DEC DE
000C45 DA3E E1              10      POP HL
000C46 DA3F C1              10      POP BC
000C47 DA40 A7               4      AND A
000C48 DA41 C9              10      RET
                                
       DA42                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000C49 DA42 CDF3D9          17      CALL    BREAK
000C4C DA45 3A92EF          13      LD  A,(_KEYD)
000C4F DA48 B7               4      OR  A
000C50 DA49 C8              11      RET Z
       DA4A                     CONSTX:
000C51 DA4A CDDFEF          17      CALL    _FFLUSH
000C54 DA4D E5              11      PUSH    HL
000C55 DA4E 2A90EF          16      LD  HL,(_KEYPS)
000C58 DA51 7C               4      LD  A,H
000C59 DA52 AD               4      XOR L
000C5A DA53 E1              10      POP HL
000C5B DA54 C6FF             7      ADD A,0FFH
000C5D DA56 9F               4      SBC A,A
000C5E DA57 C9              10      RET
                                
       DA58                     _SYS2A:     ;(BDOS)日付の獲得
000C5F DA58 C5              11      PUSH    BC
000C60 DA59 CD98DA          17      CALL    RTCREAD
000C63 DA5C 3A62EF          13      LD  A,(RTC_YY)
000C66 DA5F CDFBDA          17      CALL    BCD
000C69 DA62 6F               4      LD  L,A
000C6A DA63 2600             7      LD  H,0
                                ;   LD  DE,1900     ;0076CH
                                ;   CP  90      ;90以上は1900年代 1990-1999
                                ;   JR  NC,RDDATE1  ;90未満は2000年代 2000-2089
                                ;   LD  E,0D0H      ;2000 & 0FFH D=007H
000C6C DA65 11D007          10      LD  DE,2000     ;すべて2000年代で処理 2000-2099
       DA68                     RDDATE1:
000C6F DA68 19              11      ADD HL,DE
000C70 DA69 3A63EF          13      LD  A,(RTC_MW)
000C73 DA6C 57               4      LD  D,A
000C74 DA6D 3A64EF          13      LD  A,(RTC_DD)
000C77 DA70 CDFBDA          17      CALL    BCD
000C7A DA73 5F               4      LD  E,A
000C7B DA74 7A               4      LD  A,D
000C7C DA75 0604             7      LD  B,4
       DA77                     RDDATE2:
000C7E DA77 CB3A             8      SRL D
000C80 DA79 10FC            13      DJNZ    RDDATE2
000C82 DA7B C1              10      POP BC
000C83 DA7C E607             7      AND 7
000C85 DA7E C9              10      RET
                                
       DA7F                     _SYS2C:     ;(BDOS)時刻の獲得
000C86 DA7F C5              11      PUSH    BC
000C87 DA80 CD98DA          17      CALL    RTCREAD
000C8A DA83 3A65EF          13      LD  A,(RTC_TT)
000C8D DA86 CDFBDA          17      CALL    BCD
000C90 DA89 67               4      LD  H,A
000C91 DA8A 3A66EF          13      LD  A,(RTC_MM)
000C94 DA8D CDFBDA          17      CALL    BCD
000C97 DA90 6F               4      LD  L,A
000C98 DA91 3A67EF          13      LD  A,(RTC_SS)
000C9B DA94 57               4      LD  D,A
000C9C DA95 C1              10      POP BC
000C9D DA96 AF               4      XOR A
000C9E DA97 C9              10      RET
                                
       DA98                     RTCREAD:
000C9F DA98 0EF9             7      LD  C,0F9H
000CA1 DA9A 3AB9EF          13      LD  A,(WK40)
000CA4 DA9D 5F               4      LD  E,A
000CA5 DA9E 3E03             7      LD  A,3     ;コマンド３：タイムリードにセット
000CA7 DAA0 CDCADA          17      CALL    RTCCMD
000CAA DAA3 3E01             7      LD  A,1     ;コマンド１：レジスタシフトにセット
000CAC DAA5 CDCADA          17      CALL    RTCCMD
000CAF DAA8 0606             7      LD  B,6
000CB1 DAAA 2167EF          10      LD  HL,RTC_SS
       DAAD                     RTCREAD1:
000CB4 DAAD C5              11      PUSH    BC
000CB5 DAAE 0608             7      LD  B,8
       DAB0                     RTCREAD2:
000CB7 DAB0 DB40            11      IN  A,(40H)     ;システムモードセンス BIT4:CDI
000CB9 DAB2 87               4      ADD A,A
000CBA DAB3 87               4      ADD A,A
000CBB DAB4 87               4      ADD A,A
000CBC DAB5 87               4      ADD A,A
000CBD DAB6 CB1E            15      RR  (HL)
000CBF DAB8 CDEFDA          17      CALL    RTCCLK
000CC2 DABB 10F3            13      DJNZ    RTCREAD2
000CC4 DABD C1              10      POP BC
000CC5 DABE 2B               6      DEC HL
000CC6 DABF 10EC            13      DJNZ    RTCREAD1
000CC8 DAC1 AF               4      XOR A
000CC9 DAC2 CDCADA          17      CALL    RTCCMD
000CCC DAC5 7B               4      LD  A,E
000CCD DAC6 32B9EF          13      LD  (WK40),A
000CD0 DAC9 C9              10      RET
                                
       DACA                     RTCCMD:
000CD1 DACA 0604             7      LD  B,4
000CD3 DACC 07               4      RLCA
000CD4 DACD 07               4      RLCA
000CD5 DACE 07               4      RLCA
       DACF                     RTCCMD1:
000CD6 DACF F5              11      PUSH    AF
000CD7 DAD0 F607             7      OR  7
000CD9 DAD2 D310            11      OUT (10H),A     ;プリンタデータ出力 兼 カレンダクロック(μPD1990AC)出力
000CDB DAD4 CDEFDA          17      CALL    RTCCLK
000CDE DAD7 F1              10      POP AF
000CDF DAD8 0F               4      RRCA
000CE0 DAD9 10F4            13      DJNZ    RTCCMD1
000CE2 DADB 3E07             7      LD  A,7
000CE4 DADD D310            11      OUT (10H),A     ;プリンタデータ出力 兼 カレンダクロック(μPD1990AC)出力
000CE6 DADF 7B               4      LD  A,E
000CE7 DAE0 A1               4      AND C
000CE8 DAE1 F602             7      OR  2
000CEA DAE3 D340            11      OUT (40H),A     ;ストローブポート
000CEC DAE5 A1               4      AND C
000CED DAE6 00               4      NOP
000CEE DAE7 D340            11      OUT (40H),A     ;ストローブポート
000CF0 DAE9 5F               4      LD  E,A
000CF1 DAEA 060D             7      LD  B,13
       DAEC                     RTCCMD3:
000CF3 DAEC 10FE            13      DJNZ    RTCCMD3
000CF5 DAEE C9              10      RET
                                
       DAEF                     RTCCLK:
000CF6 DAEF 7B               4      LD  A,E
000CF7 DAF0 A1               4      AND C
000CF8 DAF1 F604             7      OR  04H
000CFA DAF3 D340            11      OUT (40H),A
000CFC DAF5 A1               4      AND C
000CFD DAF6 00               4      NOP
000CFE DAF7 D340            11      OUT (40H),A
000D00 DAF9 5F               4      LD  E,A
000D01 DAFA C9              10      RET
                                
                                ;------------------------
                                ;BCDの10進数化
                                ;in
                                ;   A  : BCD
                                ;out
                                ;   A  : 10進数
                                ;------------------------
       DAFB                     BCD:
000D02 DAFB 4F               4      LD  C,A
000D03 DAFC E6F0             7      AND 0F0H    ;10の位
000D05 DAFE 0F               4      RRCA
000D06 DAFF 47               4      LD  B,A
000D07 DB00 0F               4      RRCA
000D08 DB01 0F               4      RRCA
000D09 DB02 80               4      ADD A,B
000D0A DB03 47               4      LD  B,A
000D0B DB04 79               4      LD  A,C
000D0C DB05 E60F             7      AND 00FH    ;1の位
000D0E DB07 80               4      ADD A,B
000D0F DB08 C9              10      RET
                                
       DB09                     ESC1:
000D10 DB09 7B               4      LD  A,E
000D11 DB0A FE41             7      CP  'A'
000D13 DB0C CAEEDB          10      JP  Z,CTRL1E
000D16 DB0F FE42             7      CP  'B'
000D18 DB11 CA0DDD          10      JP  Z,CTRL1F
000D1B DB14 FE43             7      CP  'C'
000D1D DB16 CAB4DB          10      JP  Z,CTRL1C
000D20 DB19 FE44             7      CP  'D'
000D22 DB1B CAD9DB          10      JP  Z,CTRL1D
000D25 DB1E FE45             7      CP  'E'
000D27 DB20 2802            12      JR  Z,CT0CX
000D29 DB22 FE6A             7      CP  'j'
       DB24                     CT0CX:
000D2B DB24 CADADC          10      JP  Z,CTRL0C
000D2E DB27 FE48             7      CP  'H'
000D30 DB29 CA59DC          10      JP  Z,CTRL0B
000D33 DB2C FE4A             7      CP  'J'
000D35 DB2E CADDDC          10      JP  Z,CTRL06
000D38 DB31 FE4B             7      CP  'K'
000D3A DB33 CA2DDC          10      JP  Z,CTRL05
000D3D DB36 FE4C             7      CP  'L'
000D3F DB38 CA14DD          10      JP  Z,CTRL0E
000D42 DB3B FE54             7      CP  'T'
000D44 DB3D CA2DDC          10      JP  Z,CTRL05
000D47 DB40 FE78             7      CP  'x'
000D49 DB42 2804            12      JR  Z,ESC1X
000D4B DB44 FE79             7      CP  'y'
000D4D DB46 2002            12      JR  NZ,ESC1Y
       DB48                     ESC1X:
000D4F DB48 3601            10      LD  (HL),1
       DB4A                     ESC1Y:
000D51 DB4A FE3D             7      CP  '='
000D53 DB4C 2804            12      JR  Z,ESC1W
000D55 DB4E FE59             7      CP  'Y'
000D57 DB50 2002            12      JR  NZ,ESC1Z
       DB52                     ESC1W:
000D59 DB52 3602            10      LD  (HL),2
       DB54                     ESC1Z:
000D5B DB54 FE20             7      CP  020H
000D5D DB56 3802            12      JR  C,ESC1C
000D5F DB58 87               4      ADD A,A
000D60 DB59 D0              11      RET NC
       DB5A                     ESC1C:
000D61 DB5A E1              10      POP HL
000D62 DB5B 1832            12      JR  ANK
                                
       DB5D                     ESC:
000D64 DB5D 21A0DB          10      LD  HL,PRINTE5
000D67 DB60 E5              11      PUSH    HL
000D68 DB61 2183DB          10      LD  HL,ESCFLG
000D6B DB64 3600            10      LD  (HL),0
000D6D DB66 3D               4      DEC A
000D6E DB67 28A0            12      JR  Z,ESC1
000D70 DB69 3D               4      DEC A
000D71 DB6A 2009            12      JR  NZ,ESC2
000D73 DB6C 3603            10      LD  (HL),3
000D75 DB6E 7B               4      LD  A,E
000D76 DB6F D620             7      SUB 020H
000D78 DB71 3278DB          13      LD  (ESCYP+1),A
000D7B DB74 C9              10      RET
       DB75                     ESC2:
000D7C DB75 3D               4      DEC A
000D7D DB76 C0              11      RET NZ
000D7E DB77 2600             7  ESCYP:  LD  H,0
000D80 DB79 7B               4      LD  A,E
000D81 DB7A D620             7      SUB 020H
000D83 DB7C 6F               4      LD  L,A
000D84 DB7D C3D6EF          10      JP  _LOC
                                
       DB80                     PRINT:
000D87 DB80 C5              11      PUSH    BC
000D88 DB81 E5              11      PUSH    HL
000D89 DB82 3E00             7      LD  A,000H      ;自己書き換え
       DB83                     ESCFLG  EQU $-1
000D8B DB84 B7               4      OR  A
000D8C DB85 20D6            12      JR  NZ,ESC
                                
000D8E DB87 3E1F             7      LD  A,01FH
000D90 DB89 BB               4      CP  E
000D91 DB8A 3018            12      JR  NC,CTRL
       DB8C                     INSFLG  EQU $
000D93 DB8C 01BCDC          10      LD  BC,INSERT   ;自己書き換え
       DB8F                     ANK:
000D96 DB8F CD66DC          17      CALL    LOC0
000D99 DB92 DB32            11      IN  A,(032H)
000D9B DB94 F5              11      PUSH    AF
000D9C DB95 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000D9E DB97 D332            11      OUT (032H),A
000DA0 DB99 73               7      LD  (HL),E
000DA1 DB9A F1              10      POP AF
000DA2 DB9B D332            11      OUT (032H),A
000DA4 DB9D CDB4DB          17      CALL    CTRL1C
       DBA0                     PRINTE5:
000DA7 DBA0 E1              10      POP HL
000DA8 DBA1 C1              10      POP BC
000DA9 DBA2 AF               4      XOR A
000DAA DBA3 C9              10      RET
                                
       DBA4                     CTRL:
000DAB DBA4 7B               4      LD  A,E
000DAC DBA5 87               4      ADD A,A
000DAD DBA6 F680             7      OR  080H
000DAF DBA8 6F               4      LD  L,A
000DB0 DBA9 26F0             7      LD  H,CTRLTB/256
000DB2 DBAB 7E               7      LD  A,(HL)
000DB3 DBAC 2C               4      INC L
000DB4 DBAD 66               7      LD  H,(HL)
000DB5 DBAE 6F               4      LD  L,A
000DB6 DBAF CD0F00          17      CALL    JP_HL
000DB9 DBB2 18EC            12      JR  PRINTE5
                                
       DBB4                     CTRL1C:
000DBB DBB4 2A8EEF          16      LD  HL,(_TXADR)
000DBE DBB7 2C               4      INC L
       DBB8                     PRINTE3:
000DBF DBB8 3AB1EF          13      LD  A,(_WIDTH)
000DC2 DBBB 3D               4      DEC A
000DC3 DBBC BD               4      CP  L
000DC4 DBBD 3009            12      JR  NC,SET_TXADR_HL
000DC6 DBBF 2E00             7      LD  L,0
000DC8 DBC1 24               4      INC H
       DBC2                     PRINTE8:
000DC9 DBC2 3A97EF          13      LD  A,(_LINE)
000DCC DBC5 BC               4      CP  H
000DCD DBC6 2804            12      JR  Z,PRINT2
       DBC8                     LOC:
       DBC8                     SET_TXADR_HL:
000DCF DBC8 228EEF          16      LD  (_TXADR),HL
       DBCB                     CTRL00:
000DD2 DBCB C9              10      RET
                                
       DBCC                     PRINT2:
000DD3 DBCC CD1ADD          17      CALL    SCR
000DD6 DBCF 25               4      DEC H
000DD7 DBD0 18F6            12      JR  SET_TXADR_HL
                                
       DBD2                     CTRL08:
000DD9 DBD2 3A8CDB          13      LD  A,(INSFLG)
000DDC DBD5 FECD             7      CP  0CDH        ;CALL ????
000DDE DBD7 2829            12      JR  Z,CTRL02
       DBD9                     CTRL1D:
000DE0 DBD9 2A8EEF          16      LD  HL,(_TXADR)
000DE3 DBDC 7C               4      LD  A,H
000DE4 DBDD B5               4      OR  L
000DE5 DBDE C8              11      RET Z
000DE6 DBDF 7D               4      LD  A,L
000DE7 DBE0 B7               4      OR  A
000DE8 DBE1 2803            12      JR  Z,CTRL1DX1
000DEA DBE3 2D               4      DEC L
000DEB DBE4 18E2            12      JR  SET_TXADR_HL
       DBE6                     CTRL1DX1:
000DED DBE6 3AB1EF          13      LD  A,(_WIDTH)
000DF0 DBE9 3D               4      DEC A
000DF1 DBEA 6F               4      LD  L,A
000DF2 DBEB 25               4      DEC H
000DF3 DBEC 18DA            12      JR  SET_TXADR_HL
       DBEE                     CTRL1E:
000DF5 DBEE 2A8EEF          16      LD  HL,(_TXADR)
000DF8 DBF1 7C               4      LD  A,H
000DF9 DBF2 B7               4      OR  A
000DFA DBF3 C8              11      RET Z
000DFB DBF4 25               4      DEC H
000DFC DBF5 18D1            12      JR  SET_TXADR_HL
                                
       DBF7                     CTRL09:
000DFE DBF7 2A8EEF          16      LD  HL,(_TXADR)
000E01 DBFA 7D               4      LD  A,L
000E02 DBFB E6F8             7      AND 0F8H
000E04 DBFD C608             7      ADD A,8
000E06 DBFF 6F               4      LD  L,A
000E07 DC00 18B6            12      JR  PRINTE3
                                
       DC02                     CTRL02:
000E09 DC02 3A8EEF          13      LD  A,(_TXADR)
000E0C DC05 B7               4      OR  A
000E0D DC06 28D1            12      JR  Z,CTRL1D
000E0F DC08 CDD9DB          17      CALL    CTRL1D
000E12 DC0B 2A8EEF          16      LD  HL,(_TXADR)
000E15 DC0E 3AB1EF          13      LD  A,(_WIDTH)
000E18 DC11 4F               4      LD  C,A
000E19 DC12 95               4      SUB L
000E1A DC13 47               4      LD  B,A
000E1B DC14 79               4      LD  A,C
000E1C DC15 3D               4      DEC A
000E1D DC16 6F               4      LD  L,A
000E1E DC17 CD69DC          17      CALL    LOC1
                                
000E21 DC1A DB32            11      IN  A,(032H)
000E23 DC1C F5              11      PUSH    AF
000E24 DC1D E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000E26 DC1F D332            11      OUT (032H),A
                                
000E28 DC21 3E20             7      LD  A,020H
       DC23                     C8X1:
000E2A DC23 4E               7      LD  C,(HL)
000E2B DC24 77               7      LD  (HL),A
000E2C DC25 2B               6      DEC HL
000E2D DC26 79               4      LD  A,C
000E2E DC27 10FA            13      DJNZ    C8X1
                                
000E30 DC29 F1              10      POP AF
000E31 DC2A D332            11      OUT (032H),A
000E33 DC2C C9              10      RET
                                
       DC2D                     CTRL05:
000E34 DC2D CDD3EF          17      CALL    _POS
000E37 DC30 2A8EEF          16      LD  HL,(_TXADR)
000E3A DC33 3AB1EF          13      LD  A,(_WIDTH)
000E3D DC36 95               4      SUB L
000E3E DC37 47               4      LD  B,A
000E3F DC38 CD66DC          17      CALL    LOC0
       DC3B                     CLLINE:
000E42 DC3B DB32            11      IN  A,(032H)
000E44 DC3D F5              11      PUSH    AF
000E45 DC3E E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000E47 DC40 D332            11      OUT (032H),A
000E49 DC42 3E20             7      LD  A,020H
       DC44                     CLLINE1:
000E4B DC44 77               7      LD  (HL),A
000E4C DC45 23               6      INC HL
000E4D DC46 10FC            13      DJNZ    CLLINE1
                                
000E4F DC48 F1              10      POP AF
000E50 DC49 D332            11      OUT (032H),A
000E52 DC4B C9              10      RET
                                
       DC4C                     CTRL0D:
000E53 DC4C AF               4      XOR A
000E54 DC4D 328EEF          13      LD  (_TXADR),A
000E57 DC50 C9              10      RET
                                
       DC51                     CTRL12:
000E58 DC51 218CDB          10      LD  HL,INSFLG
000E5B DC54 7E               7      LD  A,(HL)
000E5C DC55 EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000E5E DC57 77               7      LD  (HL),A
000E5F DC58 C9              10      RET
                                
       DC59                     CTRL0B:
000E60 DC59 210000          10      LD  HL,0
000E63 DC5C 228EEF          16      LD  (_TXADR),HL
000E66 DC5F C9              10      RET
                                
       DC60                     CTRL1B:
000E67 DC60 3E01             7      LD  A,1
000E69 DC62 3283DB          13      LD  (ESCFLG),A
000E6C DC65 C9              10      RET
       DC66                     LOC0:
000E6D DC66 2A8EEF          16      LD  HL,(_TXADR)
       DC69                     LOC1:
000E70 DC69 D5              11      PUSH    DE
000E71 DC6A E5              11      PUSH    HL
000E72 DC6B 6C               4      LD  L,H ;Y
000E73 DC6C 5C               4      LD  E,H
000E74 DC6D 2600             7      LD  H,0
000E76 DC6F 54               4      LD  D,H
000E77 DC70 29              11      ADD HL,HL   ;*2
000E78 DC71 29              11      ADD HL,HL   ;*4
000E79 DC72 29              11      ADD HL,HL   ;*8
000E7A DC73 29              11      ADD HL,HL   ;*16
000E7B DC74 ED52            15      SBC HL,DE   ;*15
000E7D DC76 29              11      ADD HL,HL   ;*30
000E7E DC77 29              11      ADD HL,HL   ;*60
000E7F DC78 29              11      ADD HL,HL   ;*120
000E80 DC79 D1              10      POP DE
000E81 DC7A 1600             7      LD  D,0
000E83 DC7C 19              11      ADD HL,DE   ;X
000E84 DC7D ED5BB2EF        20      LD  DE,(TVRAMTOP)
000E88 DC81 19              11      ADD HL,DE
000E89 DC82 D1              10      POP DE
000E8A DC83 C9              10      RET
                                
       DC84                     CONOUT1:
000E8B DC84 59               4      LD  E,C
000E8C DC85 CDCDEF          17      CALL    _PRINT
000E8F DC88 7B               4      LD  A,E
000E90 DC89 FE0A             7      CP  00AH
000E92 DC8B 2006            12      JR  NZ,CURSOR_ON
000E94 DC8D CD4CDC          17      CALL    CTRL0D
000E97 DC90 CD2DDC          17      CALL    CTRL05
       DC93                     CURSOR_ON:
000E9A DC93 F5              11      PUSH    AF
000E9B DC94 3E81             7      LD  A,081H
       DC96                     CURSOR0:
000E9D DC96 D351            11      OUT (051H),A
000E9F DC98 3A8EEF          13      LD  A,(_TXADR)
000EA2 DC9B D350            11      OUT (050H),A
000EA4 DC9D 3A8FEF          13      LD  A,(_TXADR+1)
000EA7 DCA0 D350            11      OUT (050H),A
000EA9 DCA2 F1              10      POP AF
000EAA DCA3 C9              10      RET
       DCA4                     CURSOR_OFF:
000EAB DCA4 F5              11      PUSH    AF
000EAC DCA5 3E80             7      LD  A,080H
000EAE DCA7 18ED            12      JR  CURSOR0
                                
       DCA9                     CTRL07:
000EB0 DCA9 3AB9EF          13      LD  A,(WK40)
000EB3 DCAC F5              11      PUSH    AF
000EB4 DCAD F620             7      OR  20H
000EB6 DCAF D340            11      OUT (040H),A
000EB8 DCB1 0610             7      LD  B,16
       DCB3                     C07X1:
000EBA DCB3 CD26DE          17      CALL    VBLANK
000EBD DCB6 10FB            13      DJNZ    C07X1
000EBF DCB8 F1              10      POP AF
000EC0 DCB9 D340            11      OUT (040H),A
000EC2 DCBB C9              10      RET
                                
       DCBC                     INSERT:
000EC3 DCBC 2A8EEF          16      LD  HL,(_TXADR)
000EC6 DCBF 3AB1EF          13      LD  A,(_WIDTH)
000EC9 DCC2 95               4      SUB L
000ECA DCC3 47               4      LD  B,A
                                
000ECB DCC4 CD66DC          17      CALL    LOC0
                                
000ECE DCC7 DB32            11      IN  A,(032H)
000ED0 DCC9 F5              11      PUSH    AF
000ED1 DCCA E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000ED3 DCCC D332            11      OUT (032H),A
                                
000ED5 DCCE 3E20             7      LD  A,020H
       DCD0                     INS1:
000ED7 DCD0 4E               7      LD  C,(HL)
000ED8 DCD1 77               7      LD  (HL),A
000ED9 DCD2 79               4      LD  A,C
000EDA DCD3 23               6      INC HL
000EDB DCD4 10FA            13      DJNZ    INS1
                                
000EDD DCD6 F1              10      POP AF
000EDE DCD7 D332            11      OUT (032H),A
000EE0 DCD9 C9              10      RET
                                
       DCDA                     CTRL0C:
000EE1 DCDA CD59DC          17      CALL    CTRL0B
       DCDD                     CTRL06:
000EE4 DCDD 2A8EEF          16      LD  HL,(_TXADR)
       DCE0                     CLS1:
000EE7 DCE0 DB32            11      IN  A,(032H)
000EE9 DCE2 F5              11      PUSH    AF
000EEA DCE3 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000EEC DCE5 D332            11      OUT (032H),A
       DCE7                     CLS2:
000EEE DCE7 E5              11      PUSH    HL
000EEF DCE8 3AB1EF          13      LD  A,(_WIDTH)
000EF2 DCEB 95               4      SUB L
000EF3 DCEC 47               4      LD  B,A
000EF4 DCED CD69DC          17      CALL    LOC1
000EF7 DCF0 3E20             7      LD  A,020H
       DCF2                     CLS3:
000EF9 DCF2 77               7      LD  (HL),A
000EFA DCF3 23               6      INC HL
000EFB DCF4 10FC            13      DJNZ    CLS3
000EFD DCF6 E1              10      POP HL
000EFE DCF7 2E00             7      LD  L,0
000F00 DCF9 24               4      INC H
000F01 DCFA 3A97EF          13      LD  A,(_LINE)
000F04 DCFD BC               4      CP  H
000F05 DCFE 20E7            12      JR  NZ,CLS2
000F07 DD00 F1              10      POP AF
000F08 DD01 D332            11      OUT (032H),A
000F0A DD03 C9              10      RET
                                
       DD04                     CTRL04:
000F0B DD04 CDD3EF          17      CALL    _POS
000F0E DD07 7D               4      LD  A,L
000F0F DD08 B7               4      OR  A
000F10 DD09 C8              11      RET Z
       DD0A                     CTRL03:
000F11 DD0A CD4CDC          17      CALL    CTRL0D
       DD0D                     CTRL0A:
       DD0D                     CTRL1F:
000F14 DD0D 2A8EEF          16      LD  HL,(_TXADR)
000F17 DD10 24               4      INC H
000F18 DD11 C3C2DB          10      JP  PRINTE8
                                
       DD14                     CTRL0E:
000F1B DD14 CDD3EF          17      CALL    _POS
000F1E DD17 7C               4      LD  A,H
000F1F DD18 1804            12      JR  SCR1
       DD1A                     SCR:
000F21 DD1A 3A97EF          13      LD  A,(_LINE)
000F24 DD1D 3D               4      DEC A
       DD1E                     SCR1:
000F25 DD1E C5              11      PUSH    BC
000F26 DD1F D5              11      PUSH    DE
000F27 DD20 E5              11      PUSH    HL
000F28 DD21 F5              11      PUSH    AF
000F29 DD22 210000          10      LD  HL,0
000F2C DD25 CD69DC          17      CALL    LOC1
000F2F DD28 EB               4      EX  DE,HL
000F30 DD29 210001          10      LD  HL,0100H
000F33 DD2C CD69DC          17      CALL    LOC1
000F36 DD2F C1              10      POP BC
000F37 DD30 DB32            11      IN  A,(032H)
000F39 DD32 F5              11      PUSH    AF
000F3A DD33 E6EF             7      AND 0EFH        ;高速RAMアクセスモード
000F3C DD35 D332            11      OUT (032H),A
000F3E DD37 78               4      LD  A,B
000F3F DD38 B7               4      OR  A
       DD39                     SCRUP1:
000F40 DD39 2815            12      JR  Z,SCRCL
000F42 DD3B E5              11      PUSH    HL
000F43 DD3C D5              11      PUSH    DE
000F44 DD3D 0608             7      LD  B,8
000F46 DD3F 5F               4      LD  E,A
000F47 DD40 210078          10      LD  HL,120*256
000F4A DD43 55               4      LD  D,L
       DD44                     SCRH2:
000F4B DD44 29              11      ADD HL,HL
000F4C DD45 3001            12      JR  NC,SCRH3
000F4E DD47 19              11      ADD HL,DE
       DD48                     SCRH3:
000F4F DD48 10FA            13      DJNZ    SCRH2
000F51 DD4A 4D               4      LD  C,L
000F52 DD4B 44               4      LD  B,H
000F53 DD4C D1              10      POP DE
000F54 DD4D E1              10      POP HL
000F55 DD4E EDB0                    LDIR
                                
       DD50                     SCRCL:
000F57 DD50 F1              10      POP AF
000F58 DD51 D332            11      OUT (032H),A
                                
000F5A DD53 3AB1EF          13      LD  A,(_WIDTH)
000F5D DD56 47               4      LD  B,A
000F5E DD57 EB               4      EX  DE,HL
000F5F DD58 CD3BDC          17      CALL    CLLINE
000F62 DD5B E1              10      POP HL
000F63 DD5C D1              10      POP DE
000F64 DD5D C1              10      POP BC
000F65 DD5E C9              10      RET
       DD5F                     POS:
000F66 DD5F 2A8EEF          16      LD  HL,(_TXADR)
000F69 DD62 C9              10      RET
                                
       DD63                     GETL:
000F6A DD63 CDD3EF          17      CALL    _POS
000F6D DD66 E5              11      PUSH    HL
000F6E DD67 3ECD             7      LD  A,0CDH      ;CALL ????
000F70 DD69 328CDB          13      LD  (INSFLG),A
       DD6C                     GETL1:
000F73 DD6C CDEED9          17      CALL    _SYS08
000F76 DD6F FE09             7      CP  9
000F78 DD71 2008            12      JR  NZ,GETL1V
000F7A DD73 2120FF          10      LD  HL,KBUF
000F7D DD76 CDE4D6          17      CALL    MSX
000F80 DD79 18F1            12      JR  GETL1
       DD7B                     GETL1V:
000F82 DD7B 5F               4      LD  E,A
000F83 DD7C CDCDEF          17      CALL    _PRINT
                                
000F86 DD7F 7B               4      LD  A,E
000F87 DD80 FE0D             7      CP  00DH
000F89 DD82 20E8            12      JR  NZ,GETL1
000F8B DD84 3E01             7      LD  A,1     ;LD BC,????
000F8D DD86 328CDB          13      LD  (INSFLG),A
000F90 DD89 1120FF          10      LD  DE,KBUF
000F93 DD8C 3AB1EF          13      LD  A,(_WIDTH)
000F96 DD8F 47               4      LD  B,A
000F97 DD90 CD43D5          17      CALL    ZERO_MEMORY_DE
                                
000F9A DD93 D1              10      POP DE
000F9B DD94 CDD3EF          17      CALL    _POS
000F9E DD97 6B               4      LD  L,E
000F9F DD98 3AB1EF          13      LD  A,(_WIDTH)
000FA2 DD9B 95               4      SUB L
000FA3 DD9C 57               4      LD  D,A
000FA4 DD9D CD69DC          17      CALL    LOC1
000FA7 DDA0 4D               4      LD  C,L
000FA8 DDA1 7C               4      LD  A,H
000FA9 DDA2 F630             7      OR  030H
000FAB DDA4 47               4      LD  B,A
000FAC DDA5 5A               4      LD  E,D
000FAD DDA6 2120FF          10      LD  HL,KBUF
       DDA9                     GETL2:
000FB0 DDA9 CDD0EF          17      CALL    _SCRN
000FB3 DDAC 03               6      INC BC
000FB4 DDAD 77               7      LD  (HL),A
000FB5 DDAE 23               6      INC HL
000FB6 DDAF 1D               4      DEC E
000FB7 DDB0 20F7            12      JR  NZ,GETL2
       DDB2                     GETL3:
000FB9 DDB2 2B               6      DEC HL
000FBA DDB3 7E               7      LD  A,(HL)
000FBB DDB4 FE21             7      CP  021H
000FBD DDB6 D0              11      RET NC
000FBE DDB7 3600            10      LD  (HL),0
000FC0 DDB9 15               4      DEC D
000FC1 DDBA 20F6            12      JR  NZ,GETL3
000FC3 DDBC C9              10      RET
                                
       DDBD                     INKEY:
000FC4 DDBD FB               4      EI
000FC5 DDBE E5              11      PUSH    HL
000FC6 DDBF 2A90EF          16      LD  HL,(_KEYPS)
000FC9 DDC2 7C               4      LD  A,H
000FCA DDC3 AD               4      XOR L
000FCB DDC4 280C            12      JR  Z,INKEY1
000FCD DDC6 7C               4      LD  A,H
000FCE DDC7 3C               4      INC A
000FCF DDC8 E61F             7      AND 01FH
000FD1 DDCA 3291EF          13      LD  (_KEYPS+1),A
000FD4 DDCD 6F               4      LD  L,A
000FD5 DDCE 26FF             7      LD  H,KEYBF/256
000FD7 DDD0 7E               7      LD  A,(HL)
000FD8 DDD1 B7               4      OR  A
       DDD2                     INKEY1:
000FD9 DDD2 E1              10      POP HL
000FDA DDD3 C9              10      RET
                                
       DDD4                     CHKEY:
000FDB DDD4 C5              11      PUSH    BC
000FDC DDD5 DB08            11      IN  A,(8)       ;6:SHIFT,7:CTRL
000FDE DDD7 4F               4      LD  C,A
000FDF DDD8 3A0E00          13      LD  A,(00EH)
000FE2 DDDB CB5F             8      BIT 3,A
000FE4 DDDD 2002            12      JR  NZ,CHKEYRSHIFT
000FE6 DDDF CBB1             8      RES 6,C
       DDE1                     CHKEYRSHIFT:
000FE8 DDE1 79               4      LD  A,C
000FE9 DDE2 3293EF          13      LD  (_KEYD+1),A
000FEC DDE5 E5              11      PUSH    HL
000FED DDE6 0E00             7      LD  C,0
000FEF DDE8 2198F1          10      LD  HL,KEY_TABLE
000FF2 DDEB CB77             8      BIT 6,A
000FF4 DDED 2003            12      JR  NZ,CHKEY0
000FF6 DDEF 212EEE          10      LD  HL,SHIFT_TABLE
       DDF2                     CHKEY0:
000FF9 DDF2 CB7F             8      BIT 7,A
000FFB DDF4 2003            12      JR  NZ,CHKEY1
000FFD DDF6 2196EE          10      LD  HL,CTRL_TABLE
       DDF9                     CHKEY1:
001000 DDF9 ED78            12      IN  A,(C)
001002 DDFB 0608             7      LD  B,8
       DDFD                     CHKEY2:
001004 DDFD 0F               4      RRCA
001005 DDFE 300B            12      JR  NC,CHKEY4
       DE00                     CHKEY3:
001007 DE00 23               6      INC HL
001008 DE01 10FA            13      DJNZ    CHKEY2
00100A DE03 0C               4      INC C
00100B DE04 79               4      LD  A,C
00100C DE05 D60D             7      SUB 00DH
00100E DE07 20F0            12      JR  NZ,CHKEY1
001010 DE09 1804            12      JR  CHKEY5
       DE0B                     CHKEY4:
001012 DE0B 7E               7      LD  A,(HL)
001013 DE0C B7               4      OR  A
001014 DE0D 28F1            12      JR  Z,CHKEY3
       DE0F                     CHKEY5:
001016 DE0F E1              10      POP HL
001017 DE10 C1              10      POP BC
001018 DE11 B7               4      OR  A
001019 DE12 3292EF          13      LD  (_KEYD),A
00101C DE15 C9              10      RET
                                
       DE16                     SCRN:
00101D DE16 E5              11      PUSH    HL
00101E DE17 DB32            11      IN  A,(032H)
001020 DE19 67               4      LD  H,A
001021 DE1A E6EF             7      AND 0EFH        ;高速RAMアクセスモード
001023 DE1C D332            11      OUT (032H),A
001025 DE1E 0A               7      LD  A,(BC)
001026 DE1F 6F               4      LD  L,A
001027 DE20 7C               4      LD  A,H
001028 DE21 D332            11      OUT (032H),A
00102A DE23 7D               4      LD  A,L
00102B DE24 E1              10      POP HL
00102C DE25 C9              10      RET
                                
       DE26                     VBLANK:
00102D DE26 F5              11      PUSH    AF
       DE27                     VBLANK0:
00102E DE27 DB40            11      IN  A,(040H)
001030 DE29 E620             7      AND 020H
001032 DE2B 20FA            12      JR  NZ,VBLANK0
       DE2D                     VBLANK1:
001034 DE2D DB40            11      IN  A,(040H)
001036 DE2F E620             7      AND 020H
001038 DE31 28FA            12      JR  Z,VBLANK1
00103A DE33 F1              10      POP AF
00103B DE34 C9              10      RET
                                
       DE35                     INIT_CRTC:
00103C DE35 3E03             7      LD  A,3     ;80桁
00103E DE37 D330            11      OUT (030H),A
001040 DE39 32BEEF          13      LD  (WK30),A
                                
001043 DE3C 3E22             7      LD  A,022H      ;25行 64K RAM
001045 DE3E D331            11      OUT (031H),A
001047 DE40 32BFEF          13      LD  (WK31),A
                                
00104A DE43 3EFF             7      LD  A,0FFH
00104C DE45 D3E4            11      OUT (0E4H),A    ;割り込みレベル設定
00104E DE47 32B7EF          13      LD  (WKE4),A
001051 DE4A 3E00             7      LD  A,0
001053 DE4C D3E6            11      OUT (0E6H),A    ;割り込みマスク
                                
001055 DE4E 3E19             7      LD  A,019H
001057 DE50 D340            11      OUT (040H),A    ;CRT I/F 同期ビットオン
001059 DE52 32B9EF          13      LD  (WK40),A
00105C DE55 CD26DE          17      CALL    VBLANK
                                
00105F DE58 AF               4      XOR A
001060 DE59 D351            11      OUT (051H),A    ;Reset CRTC
001062 DE5B 3EA0             7      LD  A,0A0H
001064 DE5D D368            11      OUT (068H),A    ;DMAC: Mode Set(Reset)
001066 DE5F 21C8F3          10      LD  HL,0F3C8H
001069 DE62 22B2EF          16      LD  (TVRAMTOP),HL
00106C DE65 0E64             7      LD  C,064H
00106E DE67 ED69            12      OUT (C),L       ;TVRAM LOW
001070 DE69 ED61            12      OUT (C),H       ;TVRAM HIGH
001072 DE6B 21B78B          10      LD  HL,08000H+120*25-1
001075 DE6E 0C               4      INC C       ;65H
001076 DE6F ED69            12      OUT (C),L
001078 DE71 ED61            12      OUT (C),H
00107A DE73 3ECE             7      LD  A,080H+80-2
00107C DE75 D350            11      OUT (050H),A
00107E DE77 3E98             7      LD  A,080H+25-1
001080 DE79 D350            11      OUT (050H),A
001082 DE7B DB40            11      IN  A,(040H)
001084 DE7D CB4F             8      BIT 1,A
001086 DE7F 21DE67          10      LD  HL,067DEH
001089 DE82 2003            12      JR  NZ,RESO1
00108B DE84 21586F          10      LD  HL,06F58H
       DE87                     RESO1:
00108E DE87 0E50             7      LD  C,050H
001090 DE89 ED61            12      OUT (C),H
001092 DE8B ED69            12      OUT (C),L
                                
001094 DE8D 3E53             7      LD  A,053H
001096 DE8F D350            11      OUT (050H),A
                                
001098 DE91 3E43             7      LD  A,043H
00109A DE93 D351            11      OUT (051H),A
                                
00109C DE95 3EE4             7      LD  A,0E4H
00109E DE97 D368            11      OUT (068H),A
                                
0010A0 DE99 3E20             7      LD  A,020H
0010A2 DE9B D351            11      OUT (051H),A
                                
0010A4 DE9D CD26DE          17      CALL    VBLANK
       DEA0                     IVBL1:
0010A7 DEA0 DB40            11      IN  A,(040H)
0010A9 DEA2 CB6F             8      BIT 5,A
0010AB DEA4 20FA            12      JR  NZ,IVBL1
                                
0010AD DEA6 3E11             7      LD  A,011H
0010AF DEA8 D340            11      OUT (040H),A    ;CRT I/F 同期ビットオフ
0010B1 DEAA 32B9EF          13      LD  (WK40),A
0010B4 DEAD C9              10      RET
[EOF:88IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
       DEAE                     FILEC:
0010B5 DEAE CDB9DE          17      CALL    FILE
       DEB1                     FILEC2:
0010B8 DEB1 3A15EF          13      LD  A,(FDRV+1)
0010BB DEB4 FE20             7      CP  020H
0010BD DEB6 C8              11      RET Z
0010BE DEB7 1839            12      JR  SETDIR1
                                
       DEB9                     FILE:
0010C0 DEB9 AF               4      XOR A
0010C1 DEBA 3214EF          13      LD  (FDRV),A
0010C4 DEBD 67               4      LD  H,A
0010C5 DEBE 6F               4      LD  L,A
0010C6 DEBF 2222EF          16      LD  (FDRV+14),HL
0010C9 DEC2 CD90DF          17      CALL    SPCUT
0010CC DEC5 CD75DF          17      CALL    CCHK3
0010CF DEC8 2812            12      JR  Z,DEVI1
0010D1 DECA 13               6      INC DE
0010D2 DECB 1A               7      LD  A,(DE)
0010D3 DECC 1B               6      DEC DE
0010D4 DECD FE3A             7      CP  ':'
0010D6 DECF 200B            12      JR  NZ,DEVI1
0010D8 DED1 1A               7      LD  A,(DE)      ;DRIVE
0010D9 DED2 CDD0E1          17      CALL    CAP
0010DC DED5 D640             7      SUB '@'
0010DE DED7 13               6      INC DE
0010DF DED8 13               6      INC DE
0010E0 DED9 3214EF          13      LD  (FDRV),A
       DEDC                     DEVI1:
0010E3 DEDC 1A               7      LD  A,(DE)
0010E4 DEDD D65C             7      SUB 05CH        ;\
0010E6 DEDF 2009            12      JR  NZ,NOROOT
0010E8 DEE1 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
0010E9 DEE2 222EEF          16      LD  (FDRV+26),HL
0010EC DEE5 2C               4      INC L
0010ED DEE6 2222EF          16      LD  (FDRV+14),HL
0010F0 DEE9 13               6      INC DE
       DEEA                     NOROOT:
                                
       DEEA                     SETDIR:
0010F1 DEEA CD16DF          17      CALL    FILED
0010F4 DEED 1A               7      LD  A,(DE)
0010F5 DEEE FE5C             7      CP  05CH        ;\
0010F7 DEF0 C0              11      RET NZ
0010F8 DEF1 13               6      INC DE
       DEF2                     SETDIR1:
0010F9 DEF2 3E10             7      LD  A,010H      ;Directory
0010FB DEF4 3221EF          13      LD  (FDRV+13),A
0010FE DEF7 D5              11      PUSH    DE
0010FF DEF8 1114EF          10      LD  DE,FDRV
001102 DEFB 2A1EF0          16      LD  HL,(STABLE+2*00FH)
001105 DEFE CD0F00          17      CALL    JP_HL
001108 DF01 D1              10      POP DE
001109 DF02 B7               4      OR  A
00110A DF03 C0              11      RET NZ
                                
00110B DF04 3A21EF          13      LD  A,(FDRV+13)
00110E DF07 CB67             8      BIT 4,A
001110 DF09 C8              11      RET Z
                                
001111 DF0A CD5DDF          17      CALL    FILEI
001114 DF0D 2A2EEF          16      LD  HL,(FDRV+26)
001117 DF10 23               6      INC HL
001118 DF11 2222EF          16      LD  (FDRV+14),HL
00111B DF14 18D4            12      JR  SETDIR
                                
       DF16                     FILED:
00111D DF16 CD5DDF          17      CALL    FILEI
001120 DF19 2115EF          10      LD  HL,FNAME
                                
001123 DF1C 0608             7      LD  B,8
       DF1E                     FILE2:
001125 DF1E CD6ADF          17      CALL    CCHKF
001128 DF21 C8              11      RET Z
001129 DF22 FE2A             7      CP  '*'
00112B DF24 282E            12      JR  Z,FILE9
00112D DF26 FE2E             7      CP  '.'
00112F DF28 280C            12      JR  Z,FILE4
001131 DF2A 77               7      LD  (HL),A
001132 DF2B 23               6      INC HL
001133 DF2C 10F0            13      DJNZ    FILE2
                                
       DF2E                     FILE3:
001135 DF2E CD6ADF          17      CALL    CCHKF
001138 DF31 C8              11      RET Z
001139 DF32 FE2E             7      CP  '.'
00113B DF34 20F8            12      JR  NZ,FILE3
                                
       DF36                     FILE4:
00113D DF36 211DEF          10      LD  HL,FNAME+8
001140 DF39 0603             7      LD  B,3
                                
       DF3B                     FILE4L:
001142 DF3B CD6ADF          17      CALL    CCHKF
001145 DF3E C8              11      RET Z
001146 DF3F FE2E             7      CP  '.'
001148 DF41 2008            12      JR  NZ,FILE12
00114A DF43 3215EF          13      LD  (FNAME),A   ;Parent directory(..)
00114D DF46 3216EF          13      LD  (FNAME+1),A
001150 DF49 3E20             7      LD  A,020H
       DF4B                     FILE12:
001152 DF4B FE2A             7      CP  '*'
001154 DF4D 280A            12      JR  Z,FILE10
001156 DF4F 77               7      LD  (HL),A
001157 DF50 23               6      INC HL
001158 DF51 10E8            13      DJNZ    FILE4L
00115A DF53 C9              10      RET
                                
       DF54                     FILE9:              ;名前の*処理、名前の残りを?で埋める
00115B DF54 CD59DF          17      CALL    FILE10
00115E DF57 18D5            12      JR  FILE3
                                
       DF59                     FILE10:
001160 DF59 3E3F             7      LD  A,'?'
001162 DF5B 1808            12      JR  FILL_MEMORY
       DF5D                     FILEI:              ;名前＋拡張子をスペースで初期化
001164 DF5D 3E20             7      LD  A,020H
001166 DF5F 01000B          10      LD  BC,11*256   ;C=0にしておく
001169 DF62 2115EF          10      LD  HL,FNAME
       DF65                     FILL_MEMORY:            ;HLからBバイトAで埋める
00116C DF65 77               7      LD  (HL),A
00116D DF66 23               6      INC HL
00116E DF67 10FC            13      DJNZ    FILL_MEMORY
001170 DF69 C9              10      RET
                                
       DF6A                     CCHKF:
001171 DF6A 1A               7      LD  A,(DE)
001172 DF6B CD72DF          17      CALL    CCHK2
001175 DF6E C8              11      RET Z
001176 DF6F C3DDE2          10      JP  FKAN
                                
       DF72                     CCHK2:
001179 DF72 0C               4      INC C
00117A DF73 0D               4      DEC C
00117B DF74 C0              11      RET NZ
       DF75                     CCHK3:              ;ZF=1 で使えない文字
00117C DF75 FE2B             7      CP  '+'
00117E DF77 C8              11      RET Z
00117F DF78 FE2C             7      CP  ','
001181 DF7A C8              11      RET Z
001182 DF7B FE2F             7      CP  '/'
001184 DF7D C8              11      RET Z
001185 DF7E FE3A             7      CP  ':'
001187 DF80 C8              11      RET Z
001188 DF81 FE3B             7      CP  ';'
00118A DF83 C8              11      RET Z
00118B DF84 FE3D             7      CP  '='
00118D DF86 C8              11      RET Z
00118E DF87 FE5C             7      CP  05CH    ;\
001190 DF89 C8              11      RET Z
001191 DF8A FE20             7      CP  020H
001193 DF8C D0              11      RET NC
001194 DF8D BF               4      CP  A       ;Z=1
001195 DF8E C9              10      RET
                                
       DF8F                     SS1:
001196 DF8F 13               6      INC DE
       DF90                     SPCUT:              ;スペースをカット
001197 DF90 1A               7      LD  A,(DE)
001198 DF91 FE20             7      CP  020H
00119A DF93 28FA            12      JR  Z,SS1
00119C DF95 C9              10      RET
                                
       DF96                     SETDRVF:
00119D DF96 1114EF          10      LD  DE,FDRV
       DF99                     SETDRV0:
0011A0 DF99 CDA2DF          17      CALL    SETDRV
0011A3 DF9C FDE1            14      POP IY
0011A5 DF9E C1              10      POP BC
0011A6 DF9F D1              10      POP DE
0011A7 DFA0 E1              10      POP HL
0011A8 DFA1 C9              10      RET
                                
       DFA2                     SETDRV:
0011A9 DFA2 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
0011AA DFA3 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
0011AB DFA4 C5              11      PUSH    BC
0011AC DFA5 1A               7      LD  A,(DE)
0011AD DFA6 D5              11      PUSH    DE
0011AE DFA7 FDE3            23      EX  (SP),IY
                                
0011B0 DFA9 CDB0DF          17      CALL    GETDRV
0011B3 DFAC CDD9EF          17      CALL    _CHGDRV
                                
0011B6 DFAF E9               4      JP  (HL)
                                
       DFB0                     GETDRV:
0011B7 DFB0 CDC3DF          17      CALL    GETDRV1
0011BA DFB3 3288EF          13      LD  (_DRV),A
0011BD DFB6 C9              10      RET
                                
       DFB7                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
0011BE DFB7 CDC3DF          17      CALL    GETDRV1
0011C1 DFBA C5              11      PUSH    BC
0011C2 DFBB 4F               4      LD  C,A
0011C3 DFBC 1A               7      LD  A,(DE)
0011C4 DFBD CDC3DF          17      CALL    GETDRV1
0011C7 DFC0 A9               4      XOR C
0011C8 DFC1 C1              10      POP BC
0011C9 DFC2 C9              10      RET
       DFC3                     GETDRV1:
0011CA DFC3 E67F             7      AND 07FH
0011CC DFC5 D601             7      SUB 001H
0011CE DFC7 D0              11      RET NC
0011CF DFC8 3A87EF          13      LD  A,(_DVSW)   ;Current Drive
0011D2 DFCB C9              10      RET
                                
       DFCC                     SOPENX:
0011D3 DFCC 1139EF          10      LD  DE,SFILE
0011D6 DFCF FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
0011D9 DFD2 CDB7DF          17      CALL    IS_SAME_DRV_A_DE
0011DC DFD5 2024            12      JR  NZ,SOPEN
0011DE DFD7 13               6      INC DE
0011DF DFD8 FDE5            15      PUSH    IY
0011E1 DFDA E1              10      POP HL
0011E2 DFDB 23               6      INC HL
0011E3 DFDC CD68E1          17      CALL    CPFILE
0011E6 DFDF 201A            12      JR  NZ,SOPEN
                                
0011E8 DFE1 2AF4F0          16      LD  HL,(SCDIR)
0011EB DFE4 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011EE DFE7 FD740F          19      LD  (IY+15),H
                                
0011F1 DFEA 2AF8F0          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
0011F4 DFED 229FEF          16      LD  (_FILEN),HL
                                
0011F7 DFF0 ED5BF6F0        20      LD  DE,(SFBPS)
0011FB DFF4 2139EF          10      LD  HL,SFILE
0011FE DFF7 36FF            10      LD  (HL),0FFH
001200 DFF9 23               6      INC HL
001201 DFFA C9              10      RET
       DFFB                     SOPEN:
001202 DFFB 2110E1          10      LD  HL,FILESE
       DFFE                     SOPENC:
001205 DFFE 2237E0          16      LD  (OPENPAT),HL
                                
001208 E001 CDE2EF          17      CALL    _RDFATX     ;Detect Media
00120B E004 3856            12      JR  C,RDDERR
                                
00120D E006 AF               4      XOR A
00120E E007 329FEF          13      LD  (_FILEN),A
001211 E00A CD10E2          17      CALL    LDDIRX1     ;A=0で呼び出す
001214 E00D 2818            12      JR  Z,SDIRX1
                                
001216 E00F CD01E1          17      CALL    READ_DIR    ;Sub Directory
001219 E012 3808            12      JR  C,SDIRX0
00121B E014 2A7EF0          16      LD  HL,(_DTBUF)
00121E E017 7E               7      LD  A,(HL)
00121F E018 FE2E             7      CP  '.'
001221 E01A 280F            12      JR  Z,SOPEN1
       E01C                     SDIRX0:
001223 E01C AF               4      XOR A
001224 E01D 32A0EF          13      LD  (_DIRF),A
001227 E020 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
00122B E024 FD770F          19      LD  (IY+15),A
       E027                     SDIRX1:
00122E E027 ED5BFCF0        20      LD  DE,(_DIRPS) ;Root Directory
       E02B                     SOPEN1:
001232 E02B 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       E02C                     SDECPAT EQU $-1
       E02D                     SOPEN1X:
001234 E02D CD01E1          17      CALL    READ_DIR    ;FILE SEARCH
001237 E030 382A            12      JR  C,RDDERR
001239 E032 2A7EF0          16      LD  HL,(_DTBUF)
       E035                     SOPEN2:
00123C E035 D5              11      PUSH    DE
00123D E036 CD10E1          17      CALL    FILESE      ;(self-modifying code)
       E037                     OPENPAT EQU $-2
001240 E039 D1              10      POP DE
001241 E03A 386D            12      JR  C,SOPENE
001243 E03C 281B            12      JR  Z,SCF_FF_RET
       E03E                     SOPEN3:
001245 E03E 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
001248 E041 B7               4      OR  A
001249 E042 200C            12      JR  NZ,SOPEN5
00124B E044 13               6      INC DE      ;ルートディレクトリ
00124C E045 E5              11      PUSH    HL
00124D E046 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       E047                     MD_PAT  EQU $-2
001250 E049 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
001252 E04B E1              10      POP HL
001253 E04C 20DD            12      JR  NZ,SOPEN1
001255 E04E 1807            12      JR  SOPEN6
       E050                     SOPEN5:
001257 E050 CD1FE9          17      CALL    GNCLX       ;END DIR
00125A E053 D8              11      RET C
00125B E054 CDC8E1          17      CALL    ENDCL
       E057                     SOPEN6:
00125E E057 38D2            12      JR  C,SOPEN1
       E059                     SCF_FF_RET:
001260 E059 37               4      SCF         ;CF=1
001261 E05A 9F               4      SBC A,A     ;A=0FFH
001262 E05B C9              10      RET
                                
       E05C                     RDDERR:
001263 E05C BF               4      CP  A       ;READ ERR CF=1 ZF=1
001264 E05D 37               4      SCF
001265 E05E C9              10      RET
                                
       E05F                     NOPEN:
001266 E05F 2110E1          10      LD  HL,FILESE
001269 E062 2237E0          16      LD  (OPENPAT),HL
00126C E065 FD2A98EF        20      LD  IY,(_FCB)
001270 E069 CDF0E2          17      CALL    CHKWILDX
001273 E06C 30EB            12      JR  NC,SCF_FF_RET
001275 E06E FD7E00          19      LD  A,(IY+0)
001278 E071 CDB0DF          17      CALL    GETDRV
00127B E074 CDD9EF          17      CALL    _CHGDRV
00127E E077 D8              11      RET C
00127F E078 2AF8F0          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
001282 E07B 229FEF          16      LD  (_FILEN),HL
                                
001285 E07E CD0BE2          17      CALL    LDDIRX
001288 E081 ED5B9AEF        20      LD  DE,(_FBPS)
00128C E085 CD01E1          17      CALL    READ_DIR
00128F E088 38D2            12      JR  C,RDDERR
001291 E08A 3A9EEF          13      LD  A,(_FBCNT)
001294 E08D 3D               4      DEC A
001295 E08E 28AE            12      JR  Z,SOPEN3
       E090                     NOPEN2:
001297 E090 2A9CEF          16      LD  HL,(_FBAD)
00129A E093 012000          10      LD  BC,020H
00129D E096 09              11      ADD HL,BC
00129E E097 4F               4      LD  C,A
00129F E098 189B            12      JR  SOPEN2
                                
       E09A                     SOPENE2:
0012A1 E09A 229CEF          16      LD  (_FBAD),HL
0012A4 E09D 79               4      LD  A,C
0012A5 E09E 329EEF          13      LD  (_FBCNT),A
0012A8 E0A1 ED539AEF        20      LD  (_FBPS),DE
0012AC E0A5 FD2298EF        20      LD  (_FCB),IY
       E0A9                     SOPENE:
0012B0 E0A9 AF               4      XOR A
0012B1 E0AA C9              10      RET
                                
       E0AB                     COPEN:
0012B2 E0AB FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
0012B6 E0AF 212DE1          10      LD  HL,NEXTSE
0012B9 E0B2 CDFEDF          17      CALL    SOPENC
0012BC E0B5 D0              11      RET NC
0012BD E0B6 C8              11      RET Z
0012BE E0B7 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
0012C1 E0BA B7               4      OR  A
0012C2 E0BB 37               4      SCF
0012C3 E0BC C8              11      RET Z       ;ルートディレクトリ
0012C4 E0BD 0601             7      LD  B,1
0012C6 E0BF CD4FE3          17      CALL    WRDF
0012C9 E0C2 D8              11      RET C
0012CA E0C3 ED5BFEF0        20      LD  DE,(_CLPS)
0012CE E0C7 D5              11      PUSH    DE
0012CF E0C8 CD91E1          17      CALL    DCPAT
0012D2 E0CB CDAAE7          17      CALL    DRDNX
0012D5 E0CE 2A7EF0          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
0012D8 E0D1 3AB4E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
0012DB E0D4 47               4      LD  B,A
0012DC E0D5 AF               4      XOR A
0012DD E0D6 4F               4      LD  C,A
       E0D7                     COPENCL:
0012DE E0D7 77               7      LD  (HL),A
0012DF E0D8 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0012E1 E0DA EAD7E0          10      JP  PE,COPENCL
                                
0012E4 E0DD 3AAFE1          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
0012E7 E0E0 3D               4      DEC A
0012E8 E0E1 2819            12      JR  Z,COPENE
0012EA E0E3 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
0012EC E0E5 3217E9          13      LD  (_SECPS),A
0012EF E0E8 D1              10      POP DE      ;DE=(_CLPS)
0012F0 E0E9 D5              11      PUSH    DE
       E0EA                     COPEN1:
0012F1 E0EA D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
0012F2 E0EB C5              11      PUSH    BC
0012F3 E0EC 2A7EF0          16      LD  HL,(_DTBUF)
0012F6 E0EF CDABE1          17      CALL    CLUSTX
0012F9 E0F2 CDAFEA          17      CALL    DWT24
0012FC E0F5 C1              10      POP BC
0012FD E0F6 D1              10      POP DE
0012FE E0F7 CD16E9          17      CALL    NEXTX
001301 E0FA 20EE            12      JR  NZ,COPEN1
       E0FC                     COPENE:
001303 E0FC 2A7EF0          16      LD  HL,(_DTBUF)
001306 E0FF D1              10      POP DE
001307 E100 C9              10      RET
                                
       E101                     READ_DIR:
001308 E101 ED53FEF0        20      LD  (_CLPS),DE
00130C E105 C5              11      PUSH    BC
00130D E106 D5              11      PUSH    DE
00130E E107 CD91E1          17      CALL    DCPAT
001311 E10A CD8AE7          17      CALL    DRDX
001314 E10D D1              10      POP DE
001315 E10E C1              10      POP BC
001316 E10F C9              10      RET
                                
       E110                     FILESE:
001317 E110 7E               7      LD  A,(HL)
001318 E111 B7               4      OR  A
001319 E112 C8              11      RET Z       ;END:ZF=1 CF=0
00131A E113 FEE5             7      CP  0E5H
00131C E115 280E            12      JR  Z,FILESE1
00131E E117 FDE5            15      PUSH    IY
001320 E119 D1              10      POP DE
001321 E11A 13               6      INC DE
001322 E11B E5              11      PUSH    HL
001323 E11C CD68E1          17      CALL    CPFILE
001326 E11F CC89E1          17      CALL    Z,CPFILE2
001329 E122 E1              10      POP HL
00132A E123 37               4      SCF
00132B E124 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       E125                     FILESE1:
00132C E125 CD3CE1          17      CALL    FNEXT
00132F E128 20E6            12      JR  NZ,FILESE
       E12A                     ZF0_CF0_AFF_RET:
001331 E12A F6FF             7      OR  0FFH        ;ZF=0 CF=0
001333 E12C C9              10      RET
                                
       E12D                     NEXTSE:
001334 E12D 7E               7      LD  A,(HL)
001335 E12E B7               4      OR  A
001336 E12F 37               4      SCF
001337 E130 C8              11      RET Z       ;!!!:ZF=1 CF=1
001338 E131 FEE5             7      CP  0E5H
00133A E133 37               4      SCF
00133B E134 C8              11      RET Z       ;!!!:(ZF=1) CF=1
00133C E135 CD3CE1          17      CALL    FNEXT
00133F E138 20F3            12      JR  NZ,NEXTSE
001341 E13A 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       E13C                     FNEXT:
001343 E13C E5              11      PUSH    HL
001344 E13D 219FEF          10      LD  HL,_FILEN
001347 E140 34              11      INC (HL)
001348 E141 E1              10      POP HL
001349 E142 112000          10      LD  DE,020H
00134C E145 19              11      ADD HL,DE
00134D E146 0D               4      DEC C
00134E E147 C9              10      RET
                                
       E148                     CPNAME:
00134F E148 C5              11      PUSH    BC
001350 E149 D5              11      PUSH    DE
001351 E14A E5              11      PUSH    HL
001352 E14B CD62E1          17      CALL    CPFILE4
001355 E14E E1              10      POP HL
001356 E14F 23               6      INC HL
001357 E150 23               6      INC HL
001358 E151 23               6      INC HL
001359 E152 23               6      INC HL
00135A E153 D1              10      POP DE
00135B E154 C1              10      POP BC
00135C E155 2005            12      JR  NZ,CPNAME1
00135E E157 7E               7      LD  A,(HL)
00135F E158 23               6      INC HL
001360 E159 66               7      LD  H,(HL)
001361 E15A 6F               4      LD  L,A
001362 E15B C9              10      RET
       E15C                     CPNAME1:
001363 E15C 23               6      INC HL
001364 E15D 23               6      INC HL
001365 E15E 10E8            13      DJNZ    CPNAME
001367 E160 37               4      SCF
001368 E161 C9              10      RET
                                
       E162                     CPFILE4:
001369 E162 C5              11      PUSH    BC
00136A E163 010004          10      LD  BC,00400H
00136D E166 1804            12      JR  CPSTR1
       E168                     CPFILE:
00136F E168 C5              11      PUSH    BC
001370 E169 01000B          10      LD  BC,00B00H
       E16C                     CPSTR1:
001373 E16C 1A               7      LD  A,(DE)
001374 E16D FE3F             7      CP  '?'     ;Wild card
001376 E16F 2812            12      JR  Z,CPSTR2
001378 E171 7E               7      LD  A,(HL)
001379 E172 CDD6E2          17      CALL    FKANC
00137C E175 E5              11      PUSH    HL
00137D E176 67               4      LD  H,A
00137E E177 1A               7      LD  A,(DE)
00137F E178 CB01             4      RLC C
001381 E17A CDD6E2          17      CALL    FKANC
001384 E17D CB09             4      RRC C
001386 E17F BC               4      CP  H       ;CP (HL),(DE)
001387 E180 E1              10      POP HL
001388 E181 2004            12      JR  NZ,CPSTR3
       E183                     CPSTR2:
00138A E183 13               6      INC DE
00138B E184 23               6      INC HL
00138C E185 10E5            13      DJNZ    CPSTR1
       E187                     CPSTR3:
00138E E187 C1              10      POP BC
00138F E188 C9              10      RET
                                
       E189                     CPFILE2:
001390 E189 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001393 E18C F6E1             7      OR  0E1H
001395 E18E 2F               4      CPL
001396 E18F A6               7      AND (HL)
001397 E190 C9              10      RET
                                
       E191                     DCPAT:
001398 E191 0E00             7      LD  C,0
00139A E193 2A7EF0          16      LD  HL,(_DTBUF)
00139D E196 3AA0EF          13      LD  A,(_DIRF)   ;ディレクトリか判別
0013A0 E199 B7               4      OR  A
0013A1 E19A C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
0013A2 E19B 3AAFE1          13      LD  A,(SPCPAT)
0013A5 E19E 4F               4      LD  C,A
0013A6 E19F 3A17E9          13      LD  A,(_SECPS)
0013A9 E1A2 B9               4      CP  C
0013AA E1A3 3801            12      JR  C,DC1
0013AC E1A5 AF               4      XOR A
       E1A6                     DC1:
0013AD E1A6 F680             7      OR  080H
0013AF E1A8 32A0EF          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       E1AB                     CLUSTX:
0013B2 E1AB E5              11      PUSH    HL
0013B3 E1AC EB               4      EX  DE,HL
0013B4 E1AD AF               4      XOR A
0013B5 E1AE 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       E1AF                     SPCPAT  EQU $-1
       E1B0                     L_CLDBL:
0013B7 E1B0 CB19             8      RR  C       ;->CF
0013B9 E1B2 3804            12      JR  C,E_CLDBL
0013BB E1B4 29              11      ADD HL,HL       ;*2
0013BC E1B5 8F               4      ADC A,A
0013BD E1B6 18F8            12      JR  L_CLDBL
       E1B8                     E_CLDBL:
0013BF E1B8 4F               4      LD  C,A
0013C0 E1B9 3A17E9          13      LD  A,(_SECPS)
0013C3 E1BC B5               4      OR  L
0013C4 E1BD 6F               4      LD  L,A
0013C5 E1BE 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       E1BF                     CLSPAT  EQU $-2
0013C8 E1C1 AF               4      XOR A
0013C9 E1C2 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
0013CA E1C3 89               4      ADC A,C
0013CB E1C4 4F               4      LD  C,A
0013CC E1C5 EB               4      EX  DE,HL
0013CD E1C6 E1              10      POP HL
0013CE E1C7 C9              10      RET
                                
       E1C8                     ENDCL:
0013CF E1C8 7A               4      LD  A,D ;END CLUSTER
0013D0 E1C9 FE01             7      CP  1   ;164=356    (self-modifying code)
       E1CA                     CLPAT1  EQU $-1
0013D2 E1CB C0              11      RET NZ
0013D3 E1CC 7B               4      LD  A,E
0013D4 E1CD FE64             7      CP  064H    ;       (self-modifying code)
       E1CE                     CLPAT2  EQU $-1
0013D6 E1CF C9              10      RET
                                
       E1D0                     CAP:
0013D7 E1D0 FE61             7      CP  'a'
0013D9 E1D2 D8              11      RET C
0013DA E1D3 FE7B             7      CP  'z'+1
0013DC E1D5 D0              11      RET NC
0013DD E1D6 D620             7      SUB 020H
0013DF E1D8 C9              10      RET
       E1D9                     CAP2:
0013E0 E1D9 CDD0E1          17      CALL    CAP
       E1DC                     CAP3:               ;
0013E3 E1DC FE05             7      CP  5
0013E5 E1DE 2803            12      JR  Z,CAP4
0013E7 E1E0 FE21             7      CP  021H
0013E9 E1E2 C9              10      RET
       E1E3                     CAP4:
0013EA E1E3 3EE5             7      LD  A,0E5H
0013EC E1E5 C9              10      RET
                                
       E1E6                     CHDIR:
0013ED E1E6 CDD1EB          17      CALL    GETDPBD
0013F0 E1E9 381D            12      JR  C,CHDIR2
0013F2 E1EB DD751A          19      LD  (IX+DPB_SDIR),L
0013F5 E1EE DD741B          19      LD  (IX+DPB_SDIR+1),H
0013F8 E1F1 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       E1F3                     LDDIR:
0013FA E1F3 CDD1EB          17      CALL    GETDPBD
0013FD E1F6 DD5E1A          19      LD  E,(IX+DPB_SDIR)
001400 E1F9 DD561B          19      LD  D,(IX+DPB_SDIR+1)
001403 E1FC 13               6      INC DE
001404 E1FD FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
001407 E200 FD720F          19      LD  (IY+15),D
00140A E203 1B               6      DEC DE
00140B E204 AF               4      XOR A
00140C E205 32A0EF          13      LD  (_DIRF),A
       E208                     CHDIR2:
00140F E208 DDE1            14      POP IX
001411 E20A C9              10      RET
                                
       E20B                     LDDIRX:
001412 E20B 3AA0EF          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
001415 E20E E67F             7      AND 07FH
       E210                     LDDIRX1:
001417 E210 3217E9          13      LD  (_SECPS),A
00141A E213 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00141D E216 FD560F          19      LD  D,(IY+15)
001420 E219 1B               6      DEC DE
001421 E21A CDC8E1          17      CALL    ENDCL
001424 E21D D4F3E1          17      CALL    NC,LDDIR
       E220                     LDDIRS:
001427 E220 7A               4      LD  A,D
001428 E221 B3               4      OR  E
001429 E222 32A0EF          13      LD  (_DIRF),A   ;ディレクトリか判別
00142C E225 C9              10      RET
                                
       E226                     KILL:
00142D E226 CDF0E2          17      CALL    CHKWILDX
001430 E229 3834            12      JR  C,KILLW
001432 E22B CDCCDF          17      CALL    SOPENX
       E22E                     KILLS:
001435 E22E 3E1F             7      LD  A,01FH
001437 E230 D472E2          17      CALL    NC,CHKATT
00143A E233 D8              11      RET C
       E234                     KILLSX:
00143B E234 36E5            10      LD  (HL),0E5H   ;DIR
00143D E236 CDCAE2          17      CALL    WTDB
001440 E239 111A00          10      LD  DE,01AH
001443 E23C 19              11      ADD HL,DE
001444 E23D 5E               7      LD  E,(HL)
001445 E23E 23               6      INC HL
001446 E23F 56               7      LD  D,(HL)
       E240                     KILLS1:
001447 E240 CDC8E1          17      CALL    ENDCL
00144A E243 D0              11      RET NC      ;CF=0
00144B E244 21FEFF          10      LD  HL,0-2
00144E E247 19              11      ADD HL,DE
00144F E248 D0              11      RET NC      ;DE= 0 or 1
001450 E249 D5              11      PUSH    DE
001451 E24A CDF7EF          17      CALL    _GNCL
001454 E24D ED53FEF0        20      LD  (_CLPS),DE
001458 E251 D1              10      POP DE
001459 E252 210000          10      LD  HL,0
00145C E255 D4FAEF          17      CALL    NC,_SNCL
00145F E258 D8              11      RET C
001460 E259 ED5BFEF0        20      LD  DE,(_CLPS)  ;FAT
001464 E25D 18E1            12      JR  KILLS1
                                
       E25F                     KILLW:
001466 E25F CDFBDF          17      CALL    SOPEN
       E262                     KILLW1:
001469 E262 380B            12      JR  C,KILLW2
00146B E264 CD9AE0          17      CALL    SOPENE2
00146E E267 CD2EE2          17      CALL    KILLS
001471 E26A CD5FE0          17      CALL    NOPEN
001474 E26D 18F3            12      JR  KILLW1
       E26F                     KILLW2:
001476 E26F C8              11      RET Z
001477 E270 3F               4      CCF
001478 E271 C9              10      RET
                                
       E272                     CHKATT:
001479 E272 E5              11      PUSH    HL
00147A E273 110B00          10      LD  DE,00BH
00147D E276 19              11      ADD HL,DE
00147E E277 A6               7      AND (HL)
00147F E278 E1              10      POP HL
001480 E279 C8              11      RET Z
001481 E27A 37               4      SCF
001482 E27B C9              10      RET
                                
       E27C                     NAME:
001483 E27C CDF0E2          17      CALL    CHKWILDX
001486 E27F D8              11      RET C
001487 E280 110400          10      LD  DE,4
00148A E283 19              11      ADD HL,DE
00148B E284 2299E2          16      LD  (NAMEP),HL
00148E E287 23               6      INC HL
00148F E288 CDF4E2          17      CALL    CHKWILD
001492 E28B D8              11      RET C
                                
001493 E28C CDCCDF          17      CALL    SOPENX
001496 E28F 3E0F             7      LD  A,00FH
001498 E291 D472E2          17      CALL    NC,CHKATT
00149B E294 D8              11      RET C
                                
00149C E295 FDE5            15      PUSH    IY
00149E E297 FD210000        14      LD  IY,0        ;自己書き換え
       E299                     NAMEP   EQU $-2
0014A2 E29B CDCCDF          17      CALL    SOPENX
0014A5 E29E FDE3            23      EX  (SP),IY
0014A7 E2A0 3F               4      CCF
0014A8 E2A1 D4FBDF          17      CALL    NC,SOPEN
0014AB E2A4 EB               4      EX  DE,HL
0014AC E2A5 E1              10      POP HL
0014AD E2A6 D8              11      RET C
                                
       E2A7                     SETNAME:
0014AE E2A7 01000B          10      LD  BC,11*256
0014B1 E2AA 23               6      INC HL
0014B2 E2AB 7E               7      LD  A,(HL)
0014B3 E2AC FEE5             7      CP  0E5H
0014B5 E2AE 2004            12      JR  NZ,SNAME1
0014B7 E2B0 3E05             7      LD  A,5
0014B9 E2B2 180E            12      JR  SNAME3
       E2B4                     SNAME1:
0014BB E2B4 7E               7      LD  A,(HL)
0014BC E2B5 0C               4      INC C
0014BD E2B6 0D               4      DEC C
0014BE E2B7 2009            12      JR  NZ,SNAME3
0014C0 E2B9 CDD0E1          17      CALL    CAP
0014C3 E2BC FEA0             7      CP  0A0H
0014C5 E2BE 2002            12      JR  NZ,SNAME3
0014C7 E2C0 3E20             7      LD  A,020H
       E2C2                     SNAME3:
0014C9 E2C2 12               7      LD  (DE),A
0014CA E2C3 7E               7      LD  A,(HL)
0014CB E2C4 23               6      INC HL
0014CC E2C5 CDDDE2          17      CALL    FKAN
0014CF E2C8 10EA            13      DJNZ    SNAME1
       E2CA                     WTDB:
0014D1 E2CA 3EFF             7      LD  A,0FFH
0014D3 E2CC 3239EF          13      LD  (SFILE),A
       E2CF                     SWTDBF:
0014D6 E2CF 3E01             7      LD  A,1
0014D8 E2D1 32A4EF          13      LD  (_WTDBF),A
0014DB E2D4 AF               4      XOR A
0014DC E2D5 C9              10      RET
                                
       E2D6                     FKANC:
0014DD E2D6 CB41             8      BIT 0,C
0014DF E2D8 CCD9E1          17      CALL    Z,CAP2
0014E2 E2DB 1801            12      JR  FKANX
       E2DD                     FKAN:           ;漢字チェック
0014E4 E2DD 13               6      INC DE
       E2DE                     FKANX:
0014E5 E2DE CB41             8      BIT 0,C
0014E7 E2E0 CB81             8      RES 0,C
0014E9 E2E2 C0              11      RET NZ
0014EA E2E3 FE80             7      CP  080H
0014EC E2E5 D8              11      RET C
0014ED E2E6 FEA0             7      CP  0A0H
0014EF E2E8 3803            12      JR  C,FKAN1
0014F1 E2EA FEE0             7      CP  0E0H
0014F3 E2EC D8              11      RET C
       E2ED                     FKAN1:
0014F4 E2ED 0C               4      INC C
0014F5 E2EE A7               4      AND A
0014F6 E2EF C9              10      RET
                                
       E2F0                     CHKWILDX:
0014F7 E2F0 FDE5            15      PUSH    IY
0014F9 E2F2 E1              10      POP HL
0014FA E2F3 23               6      INC HL
       E2F4                     CHKWILD:
0014FB E2F4 060B             7      LD  B,11
0014FD E2F6 3E3F             7      LD  A,'?'
       E2F8                     CHKWIL1:
0014FF E2F8 BE               7      CP  (HL)
001500 E2F9 23               6      INC HL
001501 E2FA 37               4      SCF
001502 E2FB C8              11      RET Z
001503 E2FC 10FA            13      DJNZ    CHKWIL1
001505 E2FE AF               4      XOR A
001506 E2FF C9              10      RET
                                
       E300                     SDIRENT:        ;IY=FCB HL=DIR
001507 E300 D5              11      PUSH    DE
001508 E301 E5              11      PUSH    HL
001509 E302 FDE5            15      PUSH    IY
00150B E304 D1              10      POP DE
00150C E305 EB               4      EX  DE,HL
00150D E306 CDA7E2          17      CALL    SETNAME
                                ;               Attribute
001510 E309 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001513 E30C 12               7      LD  (DE),A
001514 E30D 13               6      INC DE
                                ;               Reserved
001515 E30E AF               4      XOR A
001516 E30F 060A             7      LD  B,10
       E311                     SDE1:
001518 E311 12               7      LD  (DE),A
001519 E312 13               6      INC DE
00151A E313 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
00151C E315 21E4F0          10      LD  HL,SDDATA       ;(FCB)更新年月日
00151F E318 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       E31A                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
001521 E31A 7E               7      LD  A,(HL)
001522 E31B 23               6      INC HL
001523 E31C 3221E3          13      LD  (SDPAT),A
001526 E31F FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       E321                     SDPAT   EQU $-1
001529 E322 12               7      LD  (DE),A
00152A E323 13               6      INC DE
00152B E324 10F4            13      DJNZ    SDLOOP
                                
00152D E326 AF               4      XOR A
00152E E327 E1              10      POP HL
00152F E328 D1              10      POP DE
001530 E329 C9              10      RET
                                
       E32A                     WOPEN:
001531 E32A FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001534 E32D E61F             7      AND 01FH
001536 E32F 37               4      SCF
001537 E330 C0              11      RET NZ
001538 E331 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E335                     TOPEN2:
00153C E335 AF               4      XOR A
       E336                     TOPEN:              ;Initializes the time stamp
00153D E336 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
001541 E33A C9              10      RET
                                
       E33B                     WRDFX:
001542 E33B 3AAFE1          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       E33E                     L_WRFX:
001545 E33E 1F               4      RRA         ;->CF
001546 E33F 3806            12      JR  C,E_WRFX
001548 E341 CB39             8      SRL C
00154A E343 CB1C             8      RR  H       ;CH=CH/2
00154C E345 18F7            12      JR  L_WRFX
       E347                     E_WRFX:
00154E E347 41               4      LD  B,C
00154F E348 4C               4      LD  C,H
001550 E349 03               6      INC BC
001551 E34A 3E37             7      LD  A,037H      ;SCF
001553 E34C 32A7E7          13      LD  (DRDN1),A
                                
       E34F                     WRDF:               ;BCクラスタ分FATを確保する
001556 E34F 110200          10      LD  DE,2
001559 E352 AF               4      XOR A
00155A E353 3217E9          13      LD  (_SECPS),A
       E356                     WRDF1:
00155D E356 C5              11      PUSH    BC
00155E E357 D5              11      PUSH    DE
00155F E358 CDF7EF          17      CALL    _GNCL
001562 E35B 381C            12      JR  C,WRDF3
001564 E35D 7A               4      LD  A,D     ;空いているかチェック
001565 E35E B3               4      OR  E
001566 E35F 202A            12      JR  NZ,WRDF4
001568 E361 E1              10      POP HL      ;HL=空いているクラスタ
001569 E362 E5              11      PUSH    HL
00156A E363 ED5BFEF0        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
00156E E367 22FEF0          16      LD  (_CLPS),HL
001571 E36A 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
001572 E36B B3               4      OR  E
001573 E36C 2008            12      JR  NZ,WRDF2
001575 E36E FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
001578 E371 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
00157B E374 1803            12      JR  WRDF3
       E376                     WRDF2:
00157D E376 CDFAEF          17      CALL    _SNCL
       E379                     WRDF3:
001580 E379 D1              10      POP DE
001581 E37A C1              10      POP BC
001582 E37B D8              11      RET C
001583 E37C 0B               6      DEC BC
001584 E37D 78               4      LD  A,B
001585 E37E B1               4      OR  C
001586 E37F 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
001588 E381 ED5BFEF0        20      LD  DE,(_CLPS)
00158C E385 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
00158F E388 C3FAEF          10      JP  _SNCL
                                
       E38B                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
001592 E38B D1              10      POP DE
001593 E38C C1              10      POP BC
       E38D                     WRDF5:
001594 E38D 13               6      INC DE
001595 E38E CDC8E1          17      CALL    ENDCL
001598 E391 38C3            12      JR  C,WRDF1
00159A E393 37               4      SCF
00159B E394 C9              10      RET
                                
       E395                     RWXR:
00159C E395 3AB4E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E398                     L_RWX:
00159F E398 1F               4      RRA     ;->CF
0015A0 E399 3808            12      JR  C,E_RWX
0015A2 E39B CB38             8      SRL B   ;BCH=BCH/2
0015A4 E39D CB19             8      RR  C   ;
0015A6 E39F CB1C             8      RR  H   ;
0015A8 E3A1 18F5            12      JR  L_RWX
       E3A3                     E_RWX:
0015AA E3A3 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0015AD E3A6 FD561B          19      LD  D,(IY+27)
0015B0 E3A9 AF               4      XOR A
0015B1 E3AA 3217E9          13      LD  (_SECPS),A
       E3AD                     RWX1:
0015B4 E3AD ED53FEF0        20      LD  (_CLPS),DE
0015B8 E3B1 7A               4      LD  A,D
0015B9 E3B2 B3               4      OR  E
0015BA E3B3 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
0015BC E3B5 78               4      LD  A,B
0015BD E3B6 B1               4      OR  C
0015BE E3B7 B4               4      OR  H
0015BF E3B8 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
0015C0 E3B9 CD1FE9          17      CALL    GNCLX
0015C3 E3BC D8              11      RET C
0015C4 E3BD 7C               4      LD  A,H     ;
0015C5 E3BE 25               4      DEC H       ;
0015C6 E3BF B7               4      OR  A       ;DEC BCH
0015C7 E3C0 2001            12      JR  NZ,RWX2     ;
0015C9 E3C2 0B               6      DEC BC      ;
       E3C3                     RWX2:
0015CA E3C3 CDC8E1          17      CALL    ENDCL
0015CD E3C6 38E5            12      JR  C,RWX1
       E3C8                     SCF_RET:
0015CF E3C8 37               4      SCF
0015D0 E3C9 C9              10      RET
                                
       E3CA                     DSKF:
0015D1 E3CA 110000          10      LD  DE,0
       E3CB                     MAXCLP  EQU $-2
0015D4 E3CD 2AACEF          16      LD  HL,(_FAKEFREE)
0015D7 E3D0 7C               4      LD  A,H
0015D8 E3D1 B5               4      OR  L
0015D9 E3D2 2803            12      JR  Z,DSKF1
0015DB E3D4 110100          10      LD  DE,1
       E3D7                     DSKF1:
0015DE E3D7 D5              11      PUSH    DE
0015DF E3D8 CDF7EF          17      CALL    _GNCL
0015E2 E3DB 380C            12      JR  C,POPSCF
0015E4 E3DD 7A               4      LD  A,D
0015E5 E3DE B3               4      OR  E
0015E6 E3DF 2001            12      JR  NZ,DSKF2
0015E8 E3E1 23               6      INC HL
       E3E2                     DSKF2:
0015E9 E3E2 D1              10      POP DE
0015EA E3E3 1B               6      DEC DE
0015EB E3E4 7A               4      LD  A,D
0015EC E3E5 B3               4      OR  E
0015ED E3E6 20EF            12      JR  NZ,DSKF1
0015EF E3E8 C9              10      RET
                                
       E3E9                     POPSCF:
0015F0 E3E9 F1              10      POP AF
0015F1 E3EA 37               4      SCF
0015F2 E3EB C9              10      RET
                                
       E3EC                     SETTMS:
0015F3 E3EC FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
0015F6 E3EF 3C               4      INC A
0015F7 E3F0 C0              11      RET NZ      ;ファイルが更新されていない
       E3F1                     SETTMSX:            ;FCBに日付時刻をセットする
0015F8 E3F1 CD7FDA          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
0015FB E3F4 CB25             8      SLA L       ;   *2
0015FD E3F6 CB25             8      SLA L       ;   *4
0015FF E3F8 29              11      ADD HL,HL       ;*2 *8
001600 E3F9 29              11      ADD HL,HL       ;*4 *16
001601 E3FA 29              11      ADD HL,HL       ;*8 *32
001602 E3FB 7A               4      LD  A,D
001603 E3FC 0F               4      RRCA            ;bit.0->7->->->0->C
001604 E3FD E61F             7      AND 01FH
001606 E3FF B5               4      OR  L
001607 E400 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
00160A E403 FD7417          19      LD  (IY+23),H
                                
00160D E406 CD58DA          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
001610 E409 0144F8          10      LD  BC,0-1980
001613 E40C 09              11      ADD HL,BC
001614 E40D 65               4      LD  H,L
                                
001615 E40E 7A               4      LD  A,D
001616 E40F 87               4      ADD A,A     ;*2
001617 E410 87               4      ADD A,A     ;*4
001618 E411 87               4      ADD A,A     ;*8
001619 E412 87               4      ADD A,A     ;*16
00161A E413 6F               4      LD  L,A
00161B E414 29              11      ADD HL,HL       ;*32
00161C E415 7D               4      LD  A,L
00161D E416 B3               4      OR  E
00161E E417 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
001621 E41A FD7415          19      LD  (IY+21),H
001624 E41D C9              10      RET
                                
       E41E                     PUSHRR:
001625 E41E 32B6E4          13      LD  (SETSEQ_SWC_RND),A
001628 E421 22C8E4          16      LD  (SETSEQ_SWC_SEQ_RR),HL
00162B E424 CD44E4          17      CALL    GET_RR_AHL
00162E E427 220FEF          16      LD  (RR_BUF_HL),HL
001631 E42A 3211EF          13      LD  (RR_BUF_A),A
001634 E42D C9              10      RET
                                
       E42E                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
001635 E42E 87               4      ADD A,A     ;in BHLA => out AHL
001636 E42F ED6A            15      ADC HL,HL
001638 E431 CB18             8      RR  B
00163A E433 B7               4      OR  A
00163B E434 78               4      LD  A,B     ;ここでフラグは変化しない
00163C E435 C8              11      RET Z
00163D E436 2C               4      INC L       ;INC AHL
00163E E437 C0              11      RET NZ      ;
00163F E438 24               4      INC H       ;
001640 E439 C0              11      RET NZ      ;
001641 E43A 3C               4      INC A       ;
001642 E43B C9              10      RET
                                
       E43C                     INIT_RND:
001643 E43C 3ECD             7      LD  A,0CDH      ;CALL ????
001645 E43E 218BE4          10      LD  HL,POPRR
001648 E441 CD1EE4          17      CALL    PUSHRR
       E444                     GET_RR_AHL:
00164B E444 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00164E E447 FD6622          19      LD  H,(IY+34)   ;
001651 E44A FD7E23          19      LD  A,(IY+35)   ;
001654 E44D C9              10      RET
       E44E                     SET_RR_AHL:
001655 E44E FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001658 E451 FD7422          19      LD  (IY+34),H
00165B E454 FD7723          19      LD  (IY+35),A
00165E E457 C9              10      RET
       E458                     INIT_SEQ:
00165F E458 3E01             7      LD  A,1     ;LD BC,????
001661 E45A 2188E4          10      LD  HL,SETSEQ
001664 E45D CD1EE4          17      CALL    PUSHRR
       E460                     GETSEQ:
001667 E460 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
00166A E463 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
00166D E466 AF               4      XOR A
                                
00166E E467 CB25             8      SLA L   ;L=L*2
                                
001670 E469 CB3C             8      SRL H   ;HL=HL/2
001672 E46B CB1D             8      RR  L   ;
001674 E46D C9              10      RET
                                
       E46E                     SETSEQ1:
001675 E46E F5              11      PUSH    AF
001676 E46F E5              11      PUSH    HL      ;AHL=Random record
001677 E470 CD44E4          17      CALL    GET_RR_AHL
00167A E473 47               4      LD  B,A     ;AHL→HLA
00167B E474 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
00167C E475 6C               4      LD  L,H     ;(IY+34)
00167D E476 60               4      LD  H,B     ;(IY+35)
00167E E477 0600             7      LD  B,0
                                
001680 E479 CD2EE4          17      CALL    GET_CPM_R_SIZE
                                
001683 E47C 29              11      ADD HL,HL
001684 E47D CB3D             8      SRL L       ;L=L/2
001686 E47F FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
001689 E482 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
00168C E485 E1              10      POP HL
00168D E486 F1              10      POP AF
00168E E487 C9              10      RET
       E488                     SETSEQ:
00168F E488 CD6EE4          17      CALL    SETSEQ1
       E48B                     POPRR:
001692 E48B F5              11      PUSH    AF
001693 E48C E5              11      PUSH    HL
001694 E48D 2A0FEF          16      LD  HL,(RR_BUF_HL)
001697 E490 3A11EF          13      LD  A,(RR_BUF_A)
00169A E493 CD4EE4          17      CALL    SET_RR_AHL
00169D E496 E1              10      POP HL
00169E E497 F1              10      POP AF
00169F E498 C9              10      RET
                                
       E499                     RB_WRITE:
0016A0 E499 C5              11      PUSH    BC
0016A1 E49A ED4B4CF0        20      LD  BC,(STABLE+2*026H)  ;(BDOS)ランダムブロック書き込み
0016A5 E49E 1805            12      JR  RBRW
       E4A0                     RB_READ:
0016A7 E4A0 C5              11      PUSH    BC
0016A8 E4A1 ED4B4EF0        20      LD  BC,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       E4A5                     RBRW:
0016AC E4A5 1F               4      RRA     ;AHL = AHL*128
0016AD E4A6 7C               4      LD  A,H ;AHL = AHL0/2
0016AE E4A7 1F               4      RRA     ;A
0016AF E4A8 65               4      LD  H,L ;
0016B0 E4A9 CB1C             8      RR  H   ;H
0016B2 E4AB 2E00             7      LD  L,0 ;
0016B4 E4AD CB1D             8      RR  L   ;L
0016B6 E4AF CD4EE4          17      CALL    SET_RR_AHL
0016B9 E4B2 218000          10      LD  HL,128
0016BC E4B5 C5              11      PUSH    BC
       E4B6                     SETSEQ_SWC_RND:
0016BD E4B6 CD6EE4          17      CALL    SETSEQ1
0016C0 E4B9 C1              10      POP BC
0016C1 E4BA FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
0016C5 E4BE FDE5            15      PUSH    IY
0016C7 E4C0 D1              10      POP DE
0016C8 E4C1 D5              11      PUSH    DE
0016C9 E4C2 CDD0E4          17      CALL    JP_BC
0016CC E4C5 FDE1            14      POP IY
0016CE E4C7 CD88E4          17      CALL    SETSEQ
       E4C8                     SETSEQ_SWC_SEQ_RR   EQU $-2
0016D1 E4CA FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
0016D5 E4CE C1              10      POP BC
0016D6 E4CF C9              10      RET
       E4D0                     JP_BC:
0016D7 E4D0 C5              11      PUSH    BC
0016D8 E4D1 C9              10      RET
                                
       E059                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       E059                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       E059                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       E059                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       E059                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E4D2                     _SYS26:     ;(BDOS)ランダムブロック書き込み
0016D9 E4D2 AF               4      XOR A
0016DA E4D3 32A7E7          13      LD  (DRDN1),A   ;NOP
0016DD E4D6 22F7E6          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
0016E0 E4D9 225DEF          16      LD  (LEFTX),HL
0016E3 E4DC CDA2DF          17      CALL    SETDRV
                                
0016E6 E4DF CD4FE6          17      CALL    RBX0
0016E9 E4E2 DA6FE5          10      JP  C,RBWERR
0016EC E4E5 CD2AE3          17      CALL    WOPEN
0016EF E4E8 DA6FE5          10      JP  C,RBWERR
0016F2 E4EB 7C               4      LD  A,H
0016F3 E4EC B5               4      OR  L
0016F4 E4ED CA68E5          10      JP  Z,RBW1
                                
0016F7 E4F0 2B               6      DEC HL
                                
0016F8 E4F1 CD0DE7          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0016FB E4F4 19              11      ADD HL,DE       ;BCHL=HL+BCDE
0016FC E4F5 3001            12      JR  NC,S26X1    ;
0016FE E4F7 03               6      INC BC      ;
       E4F8                     S26X1:
0016FF E4F8 CD95E3          17      CALL    RWXR
001702 E4FB DC3BE3          17      CALL    C,WRDFX
001705 E4FE DA6FE5          10      JP  C,RBWERR
                                
001708 E501 CD7EE6          17      CALL    RBX2
00170B E504 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
00170D E506 CD9DE6          17      CALL    RBXA
001710 E509 3864            12      JR  C,RBWERR
001712 E50B EB               4      EX  DE,HL
001713 E50C C5              11      PUSH    BC
001714 E50D EDB0                    LDIR
001716 E50F 225FEF          16      LD  (DTAX),HL
                                
001719 E512 CDCFE2          17      CALL    SWTDBF      ;バッファデータは更新された
                                
00171C E515 2A5DEF          16      LD  HL,(LEFTX)
00171F E518 D1              10      POP DE
001720 E519 ED52            15      SBC HL,DE
001722 E51B 225DEF          16      LD  (LEFTX),HL
001725 E51E 2831            12      JR  Z,RBWEND
                                
       E520                     RBWB:
001727 E520 CDD2E6          17      CALL    RBXB
00172A E523 2814            12      JR  Z,RBWC
       E525                     RBWB1:
00172C E525 C5              11      PUSH    BC
00172D E526 D5              11      PUSH    DE
00172E E527 CDABE1          17      CALL    CLUSTX
001731 E52A CD21E7          17      CALL    DWTC
001734 E52D D1              10      POP DE
001735 E52E C1              10      POP BC
001736 E52F D41FE9          17      CALL    NC,GNCLX
001739 E532 383B            12      JR  C,RBWERR
00173B E534 10EF            13      DJNZ    RBWB1
00173D E536 CD71E7          17      CALL    DRW_FLUSH
       E539                     RBWC:
001740 E539 CDEAE6          17      CALL    RBXC
001743 E53C 2813            12      JR  Z,RBWEND
001745 E53E C5              11      PUSH    BC
001746 E53F CDABE1          17      CALL    CLUSTX
001749 E542 CDA6E7          17      CALL    DRDN
00174C E545 C1              10      POP BC
00174D E546 3827            12      JR  C,RBWERR
00174F E548 ED5B7EF0        20      LD  DE,(_DTBUF)
001753 E54C EDB0                    LDIR
001755 E54E CDCFE2          17      CALL    SWTDBF      ;バッファデータは更新された
       E551                     RBWEND:
001758 E551 CDF6E6          17      CALL    RBXEND
                                
00175B E554 CD5EE6          17      CALL    RBX1
00175E E557 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
001760 E559 CD0DE7          17      CALL    GET_RR_BCDE ;BCDE=Random record
001763 E55C FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
001766 E55F FD7211          19      LD  (IY+17),D   ;
001769 E562 FD7112          19      LD  (IY+18),C   ;
00176C E565 FD7013          19      LD  (IY+19),B   ;
       E568                     RBW1:
00176F E568 FDE1            14      POP IY
001771 E56A C1              10      POP BC
001772 E56B D1              10      POP DE
001773 E56C E1              10      POP HL
       E56D                     DD_NUL:
001774 E56D AF               4      XOR A
       E56E                     DRDF0:
       E56E                     DWTF0:
001775 E56E C9              10      RET
                                
       E56F                     RBWERR:
001776 E56F FDE5            15      PUSH    IY
001778 E571 D1              10      POP DE
001779 E572 2A20F0          16      LD  HL,(STABLE+2*010H)
00177C E575 CD0F00          17      CALL    JP_HL
       E578                     RBRERR1:
00177F E578 3E01             7      LD  A,001H
       E57A                     RBRERR2:
001781 E57A FDE1            14      POP IY
001783 E57C C1              10      POP BC
001784 E57D D1              10      POP DE
001785 E57E E1              10      POP HL
001786 E57F 37               4      SCF
001787 E580 210000          10      LD  HL,0
00178A E583 C9              10      RET
                                
       E584                     RBRERR:
00178B E584 3EFF             7      LD  A,0FFH
00178D E586 18F2            12      JR  RBRERR2
                                
       E588                     RBRFL:
00178F E588 3E00             7  RBRFLP: LD  A,000H
001791 E58A FE0D             7      CP  00DH
001793 E58C 2005            12      JR  NZ,RBRFL1
001795 E58E D5              11      PUSH    DE
001796 E58F 1E0A             7      LD  E,00AH
001798 E591 1805            12      JR  RBRFL2
       E593                     RBRFL1:
00179A E593 D5              11      PUSH    DE
00179B E594 CD09EF          17      CALL    _SYS07
00179E E597 5F               4      LD  E,A
       E598                     RBRFL2:
00179F E598 CDCDEF          17      CALL    _PRINT
0017A2 E59B 7B               4      LD  A,E
0017A3 E59C D1              10      POP DE
0017A4 E59D 3289E5          13      LD  (RBRFLP+1),A
0017A7 E5A0 C9              10      RET
       E5A1                     DDX:
0017A8 E5A1 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
0017AB E5A4 CDD0E1          17      CALL    CAP
0017AE E5A7 FE41             7      CP  'A'
0017B0 E5A9 C9              10      RET
                                
                                                ;Read random block
       E5AA                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0017B1 E5AA 225DEF          16      LD  (LEFTX),HL
0017B4 E5AD CDA2DF          17      CALL    SETDRV
                                
0017B7 E5B0 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
0017BB E5B4 C23DE6          10      JP  NZ,RBRDIR   ;ディレクトリ
0017BE E5B7 CD4FE6          17      CALL    RBX0
0017C1 E5BA DA84E5          10      JP  C,RBRERR
0017C4 E5BD CD5EE6          17      CALL    RBX1
0017C7 E5C0 D476E6          17      CALL    NC,RBX1R
0017CA E5C3 DA78E5          10      JP  C,RBRERR1
0017CD E5C6 EB               4      EX  DE,HL
0017CE E5C7 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
0017D0 E5C9 19              11      ADD HL,DE
0017D1 E5CA 79               4      LD  A,C
0017D2 E5CB DE00             7      SBC A,0
0017D4 E5CD 78               4      LD  A,B
0017D5 E5CE DE00             7      SBC A,0
0017D7 E5D0 3801            12      JR  C,RBR1
0017D9 E5D2 EB               4      EX  DE,HL
       E5D3                     RBR1:
0017DA E5D3 9F               4      SBC A,A
0017DB E5D4 E601             7      AND 1
0017DD E5D6 323BE6          13      LD  (RBRAP+1),A
                                
0017E0 E5D9 7C               4      LD  A,H
0017E1 E5DA B5               4      OR  L
0017E2 E5DB 2857            12      JR  Z,RBREND0
                                
0017E4 E5DD 22F7E6          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
0017E7 E5E0 225DEF          16      LD  (LEFTX),HL
                                
0017EA E5E3 CD7EE6          17      CALL    RBX2
0017ED E5E6 2819            12      JR  Z,RBRB
0017EF E5E8 CD9DE6          17      CALL    RBXA
0017F2 E5EB DA84E5          10      JP  C,RBRERR
0017F5 E5EE C5              11      PUSH    BC
0017F6 E5EF EDB0                    LDIR
0017F8 E5F1 ED535FEF        20      LD  (DTAX),DE
0017FC E5F5 2A5DEF          16      LD  HL,(LEFTX)
0017FF E5F8 D1              10      POP DE
001800 E5F9 A7               4      AND A
001801 E5FA ED52            15      SBC HL,DE
001803 E5FC 225DEF          16      LD  (LEFTX),HL
001806 E5FF 2830            12      JR  Z,RBREND
                                
       E601                     RBRB:
001808 E601 CDD2E6          17      CALL    RBXB
00180B E604 2815            12      JR  Z,RBRC
       E606                     RBRB1:
00180D E606 C5              11      PUSH    BC
00180E E607 D5              11      PUSH    DE
00180F E608 CDABE1          17      CALL    CLUSTX
001812 E60B CD27E7          17      CALL    DRDC
001815 E60E D1              10      POP DE
001816 E60F C1              10      POP BC
001817 E610 D41FE9          17      CALL    NC,GNCLX
00181A E613 DA84E5          10      JP  C,RBRERR
00181D E616 10EE            13      DJNZ    RBRB1
00181F E618 CD71E7          17      CALL    DRW_FLUSH
       E61B                     RBRC:
001822 E61B CDEAE6          17      CALL    RBXC
001825 E61E 2811            12      JR  Z,RBREND
001827 E620 C5              11      PUSH    BC
001828 E621 CDABE1          17      CALL    CLUSTX
00182B E624 CD8AE7          17      CALL    DRDX
00182E E627 C1              10      POP BC
00182F E628 DA84E5          10      JP  C,RBRERR
001832 E62B EB               4      EX  DE,HL
001833 E62C 2A7EF0          16      LD  HL,(_DTBUF)
001836 E62F EDB0                    LDIR
       E631                     RBREND:
001838 E631 CDF6E6          17      CALL    RBXEND
       E634                     RBREND0:
00183B E634 FDE1            14      POP IY
00183D E636 C1              10      POP BC
00183E E637 D1              10      POP DE
00183F E638 F1              10      POP AF  ;(HL)
001840 E639 AF               4      XOR A
001841 E63A 3E00             7  RBRAP:  LD  A,000H
001843 E63C C9              10      RET
                                
       E63D                     RBRDIR:
001844 E63D FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001847 E640 FD661B          19      LD  H,(IY+27)
00184A E643 CDE6E1          17      CALL    CHDIR
00184D E646 AF               4      XOR A
00184E E647 67               4      LD  H,A
00184F E648 6F               4      LD  L,A
001850 E649 3C               4      INC A
001851 E64A 323BE6          13      LD  (RBRAP+1),A
001854 E64D 18E5            12      JR  RBREND0
                                
       E64F                     RBX0:
001856 E64F 2A8AEF          16      LD  HL,(_DTA)
001859 E652 225FEF          16      LD  (DTAX),HL
00185C E655 2A5DEF          16      LD  HL,(LEFTX)
00185F E658 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
001862 E65B D6FD             7      SUB 0FDH
001864 E65D C9              10      RET
                                
       E65E                     RBX1:               ;ファイルサイズとランダムレコードを比べる
001865 E65E E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
001866 E65F FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
001869 E662 FD6611          19      LD  H,(IY+17)   ;
00186C E665 FD7E12          19      LD  A,(IY+18)   ;
                                
00186F E668 CD0DE7          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001872 E66B A7               4      AND A
001873 E66C ED52            15      SBC HL,DE
001875 E66E 99               4      SBC A,C
001876 E66F 4F               4      LD  C,A
001877 E670 FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
00187A E673 98               4      SBC A,B
00187B E674 D1              10      POP DE
00187C E675 C9              10      RET
       E676                     RBX1R:
00187D E676 47               4      LD  B,A
00187E E677 B1               4      OR  C
00187F E678 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
001880 E679 B2               4      OR  D
001881 E67A B3               4      OR  E
001882 E67B C0              11      RET NZ
001883 E67C 37               4      SCF
001884 E67D C9              10      RET
                                
       E67E                     RBX2:               ;Cluster settings
001885 E67E FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001888 E681 FD4E23          19      LD  C,(IY+35)
00188B E684 0600             7      LD  B,0
00188D E686 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001891 E68A 2003            12      JR  NZ,RBX3
001893 E68C FD4624          19      LD  B,(IY+36)
       E68F                     RBX3:
001896 E68F CD95E3          17      CALL    RWXR
001899 E692 3AB4E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
00189C E695 3D               4      DEC A
00189D E696 FDA622          19      AND (IY+34)
0018A0 E699 FDB621          19      OR  (IY+33)
0018A3 E69C C9              10      RET
                                
       E69D                     RBXA:
0018A4 E69D C5              11      PUSH    BC
0018A5 E69E D5              11      PUSH    DE
0018A6 E69F CDABE1          17      CALL    CLUSTX
0018A9 E6A2 CD8AE7          17      CALL    DRDX
0018AC E6A5 D1              10      POP DE
0018AD E6A6 C1              10      POP BC
0018AE E6A7 D41FE9          17      CALL    NC,GNCLX
0018B1 E6AA D8              11      RET C
0018B2 E6AB ED53FEF0        20      LD  (_CLPS),DE
                                
0018B6 E6AF FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
0018B9 E6B2 210004          10  SECSZ:  LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
0018BC E6B5 7C               4      LD  A,H
0018BD E6B6 3D               4      DEC A       ;1024=3 / 512=1
0018BE E6B7 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
0018C1 E6BA 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
0018C2 E6BB ED42            15      SBC HL,BC       ;残りを計算
                                
0018C4 E6BD ED5B5DEF        20      LD  DE,(LEFTX)
0018C8 E6C1 ED52            15      SBC HL,DE       ;CP HL,DE
0018CA E6C3 19              11      ADD HL,DE       ;
0018CB E6C4 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
0018CD E6C6 EB               4      EX  DE,HL
       E6C7                     RBXA1:
0018CE E6C7 E5              11      PUSH    HL
0018CF E6C8 2A7EF0          16      LD  HL,(_DTBUF)
0018D2 E6CB 09              11      ADD HL,BC
0018D3 E6CC ED5B5FEF        20      LD  DE,(DTAX)
0018D7 E6D0 C1              10      POP BC
0018D8 E6D1 C9              10      RET
                                
       E6D2                     RBXB:
0018D9 E6D2 2A5FEF          16      LD  HL,(DTAX)
0018DC E6D5 ED5BFEF0        20      LD  DE,(_CLPS)
0018E0 E6D9 3A5EEF          13      LD  A,(LEFTX+1)
0018E3 E6DC 47               4      LD  B,A
0018E4 E6DD 3AB4E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E6E0                     RBXB1:
0018E7 E6E0 1F               4      RRA     ;->CF
0018E8 E6E1 3804            12      JR  C,RBXB2
0018EA E6E3 CB38             8      SRL B   ;B=B/2
0018EC E6E5 18F9            12      JR  RBXB1
       E6E7                     RBXB2:
0018EE E6E7 78               4      LD  A,B
0018EF E6E8 B7               4      OR  A
0018F0 E6E9 C9              10      RET
                                
       E6EA                     RBXC:
0018F1 E6EA ED4B5DEF        20      LD  BC,(LEFTX)
0018F5 E6EE 3AB4E6          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
0018F8 E6F1 3D               4      DEC A
0018F9 E6F2 A0               4      AND B
0018FA E6F3 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
0018FB E6F4 B1               4      OR  C
0018FC E6F5 C9              10      RET
                                
       E6F6                     RBXEND:             ;レコード数だけランダムレコードを進める
0018FD E6F6 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       E6F7                     RBSIZE  EQU $-2
001900 E6F9 CD44E4          17      CALL    GET_RR_AHL
001903 E6FC 19              11      ADD HL,DE
001904 E6FD CE00             7      ADC A,0
001906 E6FF CD4EE4          17      CALL    SET_RR_AHL
001909 E702 EB               4      EX  DE,HL       ;HL=進めるレコード数
00190A E703 D0              11      RET NC
00190B E704 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00190F E708 C0              11      RET NZ
001910 E709 FD3424          23      INC (IY+36)
001913 E70C C9              10      RET
                                
       E70D                     GET_RR_BCDE:            ;BCDE=Random record
001914 E70D FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
001917 E710 FD5622          19      LD  D,(IY+34)
00191A E713 FD4E23          19      LD  C,(IY+35)
00191D E716 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
00191F E718 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001923 E71C C0              11      RET NZ
001924 E71D FD4624          19      LD  B,(IY+36)
001927 E720 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E721                     DWTC:
001928 E721 E5              11      PUSH    HL
001929 E722 21B1EA          10      LD  HL,DWT24B
00192C E725 1804            12      JR  DWTC1
       E727                     DRDC:
00192E E727 E5              11      PUSH    HL
00192F E728 21A1EA          10      LD  HL,DRD24B
       E72B                     DWTC1:
001932 E72B 2285E7          16      LD  (DRWF_MODE),HL
001935 E72E E1              10      POP HL
001936 E72F 3A75E7          13      LD  A,(DRWF_B)
001939 E732 B7               4      OR  A
00193A E733 200F            12      JR  NZ,DRDC1
       E735                     SAVE_DRWC:
00193C E735 0601             7      LD  B,1
00193E E737 ED4374E7        20      LD  (DRWF_C),BC
001942 E73B ED537BE7        20      LD  (DRWF_E),DE
001946 E73F 227EE7          16      LD  (DRWF_HL),HL
001949 E742 1820            12      JR  INC_HL_DRWC
       E744                     DRDC1:
00194B E744 E5              11      PUSH    HL
00194C E745 217BE7          10      LD  HL,DRWF_E
00194F E748 86               7      ADD A,(HL)
001950 E749 F5              11      PUSH    AF
001951 E74A BB               4      CP  E
001952 E74B 201D            12      JR  NZ,DRDC2
001954 E74D F1              10      POP AF
001955 E74E 23               6      INC HL
001956 E74F 7E               7      LD  A,(HL)
001957 E750 CE00             7      ADC A,0
001959 E752 F5              11      PUSH    AF
00195A E753 BA               4      CP  D
00195B E754 2014            12      JR  NZ,DRDC2
00195D E756 F1              10      POP AF
00195E E757 3A74E7          13      LD  A,(DRWF_C)
001961 E75A CE00             7      ADC A,0
001963 E75C B9               4      CP  C
001964 E75D 200C            12      JR  NZ,DRDC3
001966 E75F 2175E7          10      LD  HL,DRWF_B
001969 E762 34              11      INC (HL)
00196A E763 E1              10      POP HL
       E764                     INC_HL_DRWC:
00196B E764 3AB4E6          13      LD  A,(SECSZ+2)     ;1セクタのサイズの上位1バイト
00196E E767 84               4      ADD A,H
00196F E768 67               4      LD  H,A
001970 E769 C9              10      RET
       E76A                     DRDC2:
001971 E76A F1              10      POP AF
       E76B                     DRDC3:
001972 E76B CD71E7          17      CALL    DRW_FLUSH
001975 E76E E1              10      POP HL
001976 E76F 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E771                     DRW_FLUSH:
001978 E771 C5              11      PUSH    BC
001979 E772 D5              11      PUSH    DE
00197A E773 010000          10      LD  BC,0
       E774                     DRWF_C  EQU $-2
       E775                     DRWF_B  EQU $-1
00197D E776 78               4      LD  A,B
00197E E777 B7               4      OR  A
00197F E778 280D            12      JR  Z,DRDF1
001981 E77A 110000          10      LD  DE,0
       E77B                     DRWF_E  EQU $-2
       E77C                     DRWF_D  EQU $-1
001984 E77D 210000          10      LD  HL,0
       E77E                     DRWF_HL EQU $-2
001987 E780 AF               4      XOR A
001988 E781 3275E7          13      LD  (DRWF_B),A
00198B E784 CDA1EA          17      CALL    DRD24B
       E785                     DRWF_MODE   EQU $-2
       E787                     DRDF1:
00198E E787 D1              10      POP DE
00198F E788 C1              10      POP BC
001990 E789 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E78A                     DRDX:
001991 E78A CDC8E7          17      CALL    DRDY
001994 E78D C8              11      RET Z
001995 E78E CDAEE7          17      CALL    DRDX1       ;データバッファの情報を保存
001998 E791 D8              11      RET C
001999 E792 E5              11      PUSH    HL
00199A E793 C5              11      PUSH    BC
00199B E794 D5              11      PUSH    DE
00199C E795 2A7EF0          16      LD  HL,(_DTBUF)
00199F E798 3AF1E7          13      LD  A,(_DBS24)
0019A2 E79B 4F               4      LD  C,A
0019A3 E79C CD9FEA          17      CALL    DRD24
0019A6 E79F DCC3E7          17      CALL    C,DRDNE
       E7A2                     POP_DE_BC_HL_RET:
0019A9 E7A2 D1              10      POP DE
0019AA E7A3 C1              10      POP BC
0019AB E7A4 E1              10      POP HL
0019AC E7A5 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E7A6                     DRDN:
0019AD E7A6 AF               4      XOR A
0019AE E7A7 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
0019AF E7A8 30E0            12      JR  NC,DRDX
       E7AA                     DRDNX:
0019B1 E7AA CDC8E7          17      CALL    DRDY
0019B4 E7AD C8              11      RET Z
       E7AE                     DRDX1:
0019B5 E7AE CDDEE7          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
0019B8 E7B1 ED53A6EF        20      LD  (_DBSEC),DE
0019BC E7B5 79               4      LD  A,C
0019BD E7B6 32F1E7          13      LD  (_DBS24),A
                                
0019C0 E7B9 3A88EF          13      LD  A,(_DRV)
0019C3 E7BC 32A5EF          13      LD  (_DBDRV),A
0019C6 E7BF CDD9EF          17      CALL    _CHGDRV
0019C9 E7C2 D0              11      RET NC
       E7C3                     DRDNE:
0019CA E7C3 9F               4      SBC A,A     ;CF=1ならばA=0FFH
0019CB E7C4 32A5EF          13      LD  (_DBDRV),A
0019CE E7C7 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E7C8                     DRDY:
0019CF E7C8 3AF1E7          13      LD  A,(_DBS24)
0019D2 E7CB B9               4      CP  C
0019D3 E7CC C0              11      RET NZ
                                
0019D4 E7CD E5              11      PUSH    HL
0019D5 E7CE 3A88EF          13      LD  A,(_DRV)
0019D8 E7D1 21A5EF          10      LD  HL,_DBDRV
0019DB E7D4 AE               7      XOR (HL)
0019DC E7D5 2005            12      JR  NZ,POP_HL_RET
                                
0019DE E7D7 2AA6EF          16      LD  HL,(_DBSEC)
0019E1 E7DA ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E7DC                     POP_HL_RET:
0019E3 E7DC E1              10      POP HL
0019E4 E7DD C9              10      RET
                                
       E7DE                     DWTX:
0019E5 E7DE 3AA4EF          13      LD  A,(_WTDBF)
0019E8 E7E1 B7               4      OR  A
0019E9 E7E2 C8              11      RET Z
0019EA E7E3 AF               4      XOR A
0019EB E7E4 32A4EF          13      LD  (_WTDBF),A
                                
0019EE E7E7 E5              11      PUSH    HL
0019EF E7E8 C5              11      PUSH    BC
0019F0 E7E9 D5              11      PUSH    DE
0019F1 E7EA 3AA5EF          13      LD  A,(_DBDRV)
0019F4 E7ED CDD9EF          17      CALL    _CHGDRV
0019F7 E7F0 0E00             7      LD  C,0
       E7F1                     _DBS24  EQU $-1
0019F9 E7F2 ED5BA6EF        20      LD  DE,(_DBSEC)
0019FD E7F6 2A7EF0          16      LD  HL,(_DTBUF)
001A00 E7F9 D4AFEA          17      CALL    NC,DWT24
       E7FC                     POP_DE_BC_HL_RET2:
001A03 E7FC 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E7FE                     RDFATX:
001A05 E7FE E5              11      PUSH    HL
001A06 E7FF 3A88EF          13      LD  A,(_DRV)
001A09 E802 21AAEF          10      LD  HL,_FATDRV
001A0C E805 AE               7      XOR (HL)
001A0D E806 28D4            12      JR  Z,POP_HL_RET
                                
001A0F E808 C5              11      PUSH    BC
001A10 E809 D5              11      PUSH    DE
001A11 E80A DDE5            15      PUSH    IX
001A13 E80C CD28E8          17      CALL    WTFATX
001A16 E80F 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
001A18 E811 AF               4      XOR A
001A19 E812 32ABEF          13      LD  (_FATIX),A
001A1C E815 3A88EF          13      LD  A,(_DRV)
001A1F E818 32AAEF          13      LD  (_FATDRV),A
001A22 E81B CDE5EF          17      CALL    _RDFAT
       E81E                     RDFATE2:
001A25 E81E 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
001A27 E820 9F               4      SBC A,A     ;A=0xFF
001A28 E821 32AAEF          13      LD  (_FATDRV),A
       E824                     POP_IX_DE_BC_HL_RET:
001A2B E824 DDE1            14      POP IX
001A2D E826 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E828                     WTFATX:
001A2F E828 3AA2EF          13      LD  A,(_WTFATF)
001A32 E82B B7               4      OR  A
001A33 E82C C8              11      RET Z
001A34 E82D E5              11      PUSH    HL
001A35 E82E 3AAAEF          13      LD  A,(_FATDRV)
001A38 E831 21A5EF          10      LD  HL,_DBDRV
001A3B E834 AE               7      XOR (HL)
001A3C E835 CCDEE7          17      CALL    Z,DWTX
001A3F E838 38A2            12      JR  C,POP_HL_RET
001A41 E83A C5              11      PUSH    BC
001A42 E83B D5              11      PUSH    DE
001A43 E83C DDE5            15      PUSH    IX
001A45 E83E CDBCEA          17      CALL    WTFAT
001A48 E841 AF               4      XOR A
001A49 E842 32A2EF          13      LD  (_WTFATF),A
001A4C E845 18DD            12      JR  POP_IX_DE_BC_HL_RET
                                
       E847                     NCL1:
001A4E E847 7A               4      LD  A,D
001A4F E848 B3               4      OR  E
001A50 E849 37               4      SCF
001A51 E84A C8              11      RET Z
                                
001A52 E84B 7A               4      LD  A,D
001A53 E84C CB3F             8      SRL A   ;/2
001A55 E84E CB3F             8      SRL A   ;/2
                                
001A57 E850 E5              11      PUSH    HL
001A58 E851 3270E8          13      LD  (NCLPAT_FATIX),A    ;_FATIX
001A5B E854 2AAAEF          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001A5E E857 BC               4      CP  H
001A5F E858 3A88EF          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001A62 E85B 326FE8          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001A65 E85E 2005            12      JR  NZ,NCL2     ;FATIXが違う
001A67 E860 BD               4      CP  L
001A68 E861 2002            12      JR  NZ,NCL2     ;ドライブが違う
001A6A E863 E1              10      POP HL
001A6B E864 C9              10      RET
       E865                     NCL2:
001A6C E865 C5              11      PUSH    BC
001A6D E866 D5              11      PUSH    DE
001A6E E867 DDE5            15      PUSH    IX
001A70 E869 CD28E8          17      CALL    WTFATX
001A73 E86C 38B6            12      JR  C,POP_IX_DE_BC_HL_RET
001A75 E86E 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E870                     NCLPAT_FATIX    EQU $-1
       E86F                     NCLPAT_FATDRV   EQU $-2
001A78 E871 ED43AAEF        20      LD  (_FATDRV),BC
001A7C E875 CD91EA          17      CALL    RDFATS
001A7F E878 18A4            12      JR  RDFATE2
                                
       E87A                     NCL3:
001A81 E87A CB9A             8      RES 3,D
001A83 E87C CB92             8      RES 2,D
001A85 E87E 6B               4      LD  L,E
001A86 E87F 62               4      LD  H,D
001A87 E880 CB3C             8      SRL H   ;
001A89 E882 CB1D             8      RR  L   ;HLA=HLA/2
001A8B E884 1F               4      RRA     ;
001A8C E885 F5              11      PUSH    AF
001A8D E886 3AABEF          13      LD  A,(_FATIX)
001A90 E889 0F               4      RRCA
001A91 E88A 300B            12      JR  NC,NCL3X1
001A93 E88C 3AB4E6          13      LD  A,(SECSZ+2)
001A96 E88F FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
001A98 E891 2004            12      JR  NZ,NCL3X1
001A9A E893 010002          10      LD  BC,512
001A9D E896 09              11      ADD HL,BC
       E897                     NCL3X1:
001A9E E897 F1              10      POP AF
001A9F E898 ED4B7CF0        20      LD  BC,(_FATBF)
001AA3 E89C 19              11      ADD HL,DE
001AA4 E89D 09              11      ADD HL,BC
001AA5 E89E 17               4      RLA
001AA6 E89F C9              10      RET
                                
       E8A0                     GNCL:
001AA7 E8A0 CD47E8          17      CALL    NCL1        ;GET NEXT CLUSTER
001AAA E8A3 D8              11      RET C
001AAB E8A4 C5              11      PUSH    BC
001AAC E8A5 E5              11      PUSH    HL
001AAD E8A6 CD7AE8          17      CALL    NCL3
001AB0 E8A9 3809            12      JR  C,GNC1
001AB2 E8AB 5E               7      LD  E,(HL)
001AB3 E8AC 23               6      INC HL
001AB4 E8AD 7E               7      LD  A,(HL)
001AB5 E8AE E60F             7      AND 00FH
001AB7 E8B0 57               4      LD  D,A
001AB8 E8B1 E1              10      POP HL
001AB9 E8B2 C1              10      POP BC
001ABA E8B3 C9              10      RET
       E8B4                     GNC1:
001ABB E8B4 7E               7      LD  A,(HL)
001ABC E8B5 23               6      INC HL
001ABD E8B6 56               7      LD  D,(HL)
001ABE E8B7 0604             7      LD  B,4
       E8B9                     GNC1L:
001AC0 E8B9 CB3A             8      SRL D   ;DA=DA/2
001AC2 E8BB 1F               4      RRA     ;
001AC3 E8BC 10FB            13      DJNZ    GNC1L
                                
001AC5 E8BE 5F               4      LD  E,A
001AC6 E8BF E1              10      POP HL
001AC7 E8C0 C1              10      POP BC
001AC8 E8C1 A7               4      AND A
001AC9 E8C2 C9              10      RET
                                
       E8C3                     SNCL:
001ACA E8C3 CD47E8          17      CALL    NCL1
001ACD E8C6 D8              11      RET C
                                ;               SET NEXT CLUSTER
001ACE E8C7 E5              11      PUSH    HL
001ACF E8C8 C5              11      PUSH    BC
001AD0 E8C9 D5              11      PUSH    DE
001AD1 E8CA E5              11      PUSH    HL
001AD2 E8CB CD7AE8          17      CALL    NCL3
001AD5 E8CE D1              10      POP DE
                                ;CF=ODD
001AD6 E8CF 7E               7      LD  A,(HL)
001AD7 E8D0 73               7      LD  (HL),E
001AD8 E8D1 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
001ADA E8D3 23               6      INC HL
001ADB E8D4 ED67            18      RRD     ;M={A[3:0],E[3:0]}
001ADD E8D6 7A               4      LD  A,D
001ADE E8D7 1804            12      JR  SNC11
       E8D9                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
001AE0 E8D9 ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001AE2 E8DB 23               6      INC HL
001AE3 E8DC 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E8DD                     SNC11:
001AE4 E8DD ED6F            18      RLD     ;M={M[7:4],D[3:0]}
001AE6 E8DF B7               4      OR  A
001AE7 E8E0 D1              10      POP DE
001AE8 E8E1 C1              10      POP BC
001AE9 E8E2 E1              10      POP HL
       E8E3                     FAT_CHANGED:
001AEA E8E3 3E01             7      LD  A,1
001AEC E8E5 32A2EF          13      LD  (_WTFATF),A
001AEF E8E8 C9              10      RET
                                
       E8E9                     N16CL3:
001AF0 E8E9 C5              11      PUSH    BC
001AF1 E8EA 6B               4      LD  L,E
001AF2 E8EB 7A               4      LD  A,D
001AF3 E8EC E603             7      AND 3
001AF5 E8EE 67               4      LD  H,A
001AF6 E8EF 29              11      ADD HL,HL
001AF7 E8F0 ED4B7CF0        20      LD  BC,(_FATBF)
001AFB E8F4 09              11      ADD HL,BC
001AFC E8F5 C1              10      POP BC
001AFD E8F6 C9              10      RET
                                
       E8F7                     GNCL16:
001AFE E8F7 CD47E8          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
001B01 E8FA D8              11      RET C
001B02 E8FB E5              11      PUSH    HL
001B03 E8FC CDE9E8          17      CALL    N16CL3
001B06 E8FF 5E               7      LD  E,(HL)
001B07 E900 23               6      INC HL
001B08 E901 56               7      LD  D,(HL)
001B09 E902 E1              10      POP HL
001B0A E903 C9              10      RET
                                
       E904                     SNCL16:
001B0B E904 CD47E8          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
001B0E E907 D8              11      RET C
001B0F E908 D5              11      PUSH    DE
001B10 E909 E5              11      PUSH    HL
001B11 E90A CDE9E8          17      CALL    N16CL3
001B14 E90D D1              10      POP DE      ;HL
001B15 E90E 73               7      LD  (HL),E
001B16 E90F 23               6      INC HL
001B17 E910 72               7      LD  (HL),D
001B18 E911 6B               4      LD  L,E
001B19 E912 62               4      LD  H,D
001B1A E913 D1              10      POP DE
001B1B E914 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E916                     NEXTX:
001B1D E916 3E00             7      LD  A,0 ;自己書き換え
       E917                     _SECPS  EQU $-1
001B1F E918 3C               4      INC A
001B20 E919 E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E91A                     _NCPAT  EQU $-1
001B22 E91B 3217E9          13      LD  (_SECPS),A
001B25 E91E C9              10      RET
                                
       E91F                     GNCLX:
001B26 E91F CD16E9          17      CALL    NEXTX
001B29 E922 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001B2A E923 C3F7EF          10      JP  _GNCL   ;次のクラスタを探す
                                
       E926                     RDFAT:
001B2D E926 3E80             7      LD  A,080H
001B2F E928 3270EF          13      LD  (CHECK),A
       E92B                     RDFAT1:
001B32 E92B 3A88EF          13      LD  A,(_DRV)
001B35 E92E CDDAEB          17      CALL    CHGDRVR
001B38 E931 D8              11      RET C
001B39 E932 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001B3C E935 CB6F             8      BIT 5,A
001B3E E937 2868            12      JR  Z,RDFAT0X
001B40 E939 2170EF          10      LD  HL,CHECK
001B43 E93C A6               7      AND (HL)
001B44 E93D 77               7      LD  (HL),A
001B45 E93E 110000          10      LD  DE,0        ;BPB
001B48 E941 2A7CF0          16      LD  HL,(_FATBF)
001B4B E944 CD9DEA          17      CALL    DRD16
001B4E E947 3024            12      JR  NC,GETBPB
001B50 E949 2170EF          10      LD  HL,CHECK
001B53 E94C CB06            15      RLC (HL)
001B55 E94E 3F               4      CCF
001B56 E94F D8              11      RET C
001B57 E950 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
001B5B E954 3F               4      CCF         ;フロッピーディスクのFDモードを切り替える
001B5C E955 DDCB0A16        23      RL  (IX+DPB_FDMODE)
001B60 E959 3EFF             7      LD  A,0FFH
001B62 E95B 3289EF          13      LD  (_DSK),A
001B65 E95E 3A84EF          13      LD  A,(_DRIVE)
001B68 E961 E603             7      AND 3
001B6A E963 F680             7      OR  080H
001B6C E965 6F               4      LD  L,A
001B6D E966 26EF             7      LD  H,_CYL0/256
001B6F E968 3EFF             7      LD  A,0FFH
001B71 E96A 77               7      LD  (HL),A
001B72 E96B 18BE            12      JR  RDFAT1
       E96D                     GETBPB:
001B74 E96D FDE5            15      PUSH    IY
001B76 E96F FD2A7CF0        20      LD  IY,(_FATBF) ;BPB
001B7A E973 CDF1EF          17      CALL    _BPB2DPB
001B7D E976 FDE1            14      POP IY
001B7F E978 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001B82 E97B 3021            12      JR  NC,GETBPBOK
001B84 E97D E60F             7      AND 00FH
001B86 E97F FE07             7      CP  7
001B88 E981 37               4      SCF
001B89 E982 C0              11      RET NZ
001B8A E983 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001B8E E987 21C0F0          10      LD  HL,M2D
001B91 E98A 2002            12      JR  NZ,SETFDMODE
001B93 E98C 2ED2             7      LD  L,M2HD-STABLE
       E98E                     SETFDMODE:
001B95 E98E DDE5            15      PUSH    IX
001B97 E990 D1              10      POP DE
001B98 E991 EDA0            16      LDI
001B9A E993 EDA0            16      LDI
001B9C E995 13               6      INC DE
001B9D E996 13               6      INC DE
001B9E E997 13               6      INC DE
001B9F E998 13               6      INC DE
001BA0 E999 010C00          10      LD  BC,12
001BA3 E99C EDB0                    LDIR
       E99E                     GETBPBOK:
001BA5 E99E CD45EB          17      CALL    CHGDRV2
       E9A1                     RDFAT0X:
001BA8 E9A1 CD91EA          17      CALL    RDFATS
001BAB E9A4 D8              11      RET C
001BAC E9A5 DDAE06          19      XOR (IX+DPB_FATID)
001BAF E9A8 C8              11      RET Z
001BB0 E9A9 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001BB4 E9AD C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
001BB5 E9AE 37               4      SCF
001BB6 E9AF C9              10      RET
                                
       E9B0                     POP_HL_SCF_RET:
001BB7 E9B0 E1              10      POP HL
001BB8 E9B1 37               4      SCF
001BB9 E9B2 C9              10      RET
                                
       E9B3                     BPB2DPB:
001BBA E9B3 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
001BBD E9B6 B7               4      OR  A
001BBE E9B7 37               4      SCF
001BBF E9B8 C0              11      RET NZ
       E9B9                     BPBOK:
001BC0 E9B9 FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001BC3 E9BC DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001BC6 E9BF FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001BC9 E9C2 DD7700          19      LD  (IX+DPB_FATLN),A
001BCC E9C5 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
001BCF E9C8 DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
001BD2 E9CB FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001BD5 E9CE FD660F          19      LD  H,(IY+15)
001BD8 E9D1 DD750E          19      LD  (IX+DPB_FATPS),L
001BDB E9D4 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001BDE E9D7 FD5617          19      LD  D,(IY+23)
001BE1 E9DA FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E9DD                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001BE4 E9DD 19              11      ADD HL,DE
001BE5 E9DE 10FD            13      DJNZ    BPBDP1
       E9E0                     BPBDP2:
001BE7 E9E0 DD7510          19      LD  (IX+DPB_DIRPS),L
001BEA E9E3 DD7411          19      LD  (IX+DPB_DIRPS+1),H
001BED E9E6 E5              11      PUSH    HL
                                
001BEE E9E7 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
001BF1 E9EA FD6612          19      LD  H,(IY+18)
001BF4 E9ED FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001BF7 E9F0 B7               4      OR  A
001BF8 E9F1 28BD            12      JR  Z,POP_HL_SCF_RET
001BFA E9F3 0606             7      LD  B,6
       E9F5                     BPBBPS1:
001BFC E9F5 05               4      DEC B
001BFD E9F6 0F               4      RRCA
001BFE E9F7 30FC            12      JR  NC,BPBBPS1
       E9F9                     BPBDE1:
001C00 E9F9 29              11      ADD HL,HL
001C01 E9FA 10FD            13      DJNZ    BPBDE1
                                
001C03 E9FC 7C               4      LD  A,H
001C04 E9FD DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
001C07 EA00 D1              10      POP DE      ;DPB_DIRPS
001C08 EA01 6C               4      LD  L,H
001C09 EA02 2600             7      LD  H,0
001C0B EA04 19              11      ADD HL,DE       ;MAXDIR
001C0C EA05 E5              11      PUSH    HL
001C0D EA06 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001C10 EA09 CB21             8      SLA C       ;*2
001C12 EA0B AF               4      XOR A
001C13 EA0C 47               4      LD  B,A
001C14 EA0D ED42            15      SBC HL,BC
001C16 EA0F DD7514          19      LD  (IX+DPB_ADDCL),L
001C19 EA12 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
001C1C EA15 D1              10      POP DE      ;DE=DPB_MAXDIR
001C1D EA16 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001C20 EA19 FD6614          19      LD  H,(IY+20)
                                
001C23 EA1C DD7E12          19      LD  A,(IX+DPB_DEVICE)
001C26 EA1F E60F             7      AND 00FH
001C28 EA21 FE07             7      CP  7       ;フロッピー
001C2A EA23 2019            12      JR  NZ,NOT_FD
001C2C EA25 E5              11      PUSH    HL
001C2D EA26 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001C30 EA29 DD710D          19      LD  (IX+DPB_MAXSEC),C
001C33 EA2C AF               4      XOR A
001C34 EA2D CB21             8      SLA C       ;両面なのでセクタ数を２倍
001C36 EA2F 0610             7      LD  B,16
       EA31                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001C38 EA31 29              11      ADD HL,HL
001C39 EA32 17               4      RLA
001C3A EA33 B9               4      CP  C
001C3B EA34 3802            12      JR  C,DIVSEC1
001C3D EA36 91               4      SUB C
001C3E EA37 2C               4      INC L
       EA38                     DIVSEC1:
001C3F EA38 10F7            13      DJNZ    DIVSEC
001C41 EA3A DD750C          19      LD  (IX+DPB_MAXCYL),L
001C44 EA3D E1              10      POP HL  ;ここまでフロッピー専用
       EA3E                     NOT_FD:
001C45 EA3E 7C               4      LD  A,H
001C46 EA3F B5               4      OR  L
001C47 EA40 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001C49 EA42 2010            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001C4B EA44 FD7E23          19      LD  A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001C4E EA47 B7               4      OR  A
001C4F EA48 37               4      SCF
001C50 EA49 C0              11      RET NZ
001C51 EA4A FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001C54 EA4D FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので
001C57 EA50 FD7E22          19      LD  A,(IY+34)   ;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
001C5A EA53 A7               4      AND A       ;CF=0
       EA54                     BPB16BIT:
001C5B EA54 ED52            15      SBC HL,DE
001C5D EA56 DE00             7      SBC A,0
001C5F EA58 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       EA5B                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001C62 EA5B CB18             8      RR  B       ;->CY
001C64 EA5D 3808            12      JR  C,BPBTC2
001C66 EA5F CB3F             8      SRL A
001C68 EA61 CB1C             8      RR  H       ;AHL=AHL/2
001C6A EA63 CB1D             8      RR  L
001C6C EA65 18F4            12      JR  BPBTC1
       EA67                     BPBTC2:
001C6E EA67 B7               4      OR  A
001C6F EA68 37               4      SCF
001C70 EA69 C0              11      RET NZ      ;念のため(クラスタ数が16ビットを超える場合)
001C71 EA6A 23               6      INC HL
001C72 EA6B 23               6      INC HL
001C73 EA6C DD7508          19      LD  (IX+DPB_MAXCL),L
001C76 EA6F DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001C79 EA72 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001C7C EA75 DD7706          19      LD  (IX+DPB_FATID),A
                                
001C7F EA78 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001C82 EA7B C6FE             7      ADD A,0-2       ;>2:CF=1
001C84 EA7D FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001C87 EA80 6F               4      LD  L,A
001C88 EA81 3002            12      JR  NC,BPBFAT1
001C8A EA83 F680             7      OR  080H
       EA85                     BPBFAT1:            ;ここではCF=0
001C8C EA85 DD770F          19      LD  (IX+DPB_BPS),A
001C8F EA88 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001C90 EA89 C8              11      RET Z       ;1セクタ256バイト
001C91 EA8A 2D               4      DEC L
001C92 EA8B C8              11      RET Z       ;1セクタ512バイト
001C93 EA8C 2D               4      DEC L
001C94 EA8D 2D               4      DEC L
001C95 EA8E C8              11      RET Z       ;1セクタ1024バイト
001C96 EA8F 37               4      SCF
001C97 EA90 C9              10      RET
                                
       EA91                     RDFATS:
001C98 EA91 CDD7EA          17      CALL    FATSETUP
001C9B EA94 D8              11      RET C
001C9C EA95 CDA1EA          17      CALL    DRD24B
001C9F EA98 2A7CF0          16      LD  HL,(_FATBF)
001CA2 EA9B 7E               7      LD  A,(HL)
001CA3 EA9C C9              10      RET
                                
       EA9D                     DRD16:
001CA4 EA9D 0E00             7      LD  C,0
       EA9F                     DRD24:
001CA6 EA9F 0601             7      LD  B,1
       EAA1                     DRD24B:
001CA8 EAA1 DDE5            15      PUSH    IX
001CAA EAA3 DD2AA8EF        20      LD  IX,(_DPB)
001CAE EAA7 CD6BED          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       EAA8                     DRDPAT  EQU $-2
       EAAA                     POP_IX_RET:
001CB1 EAAA DDE1            14      POP IX
001CB3 EAAC C9              10      RET
                                
       EAAD                     DWT16:
001CB4 EAAD 0E00             7      LD  C,0
       EAAF                     DWT24:
001CB6 EAAF 0601             7      LD  B,1
       EAB1                     DWT24B:
001CB8 EAB1 DDE5            15      PUSH    IX
001CBA EAB3 DD2AA8EF        20      LD  IX,(_DPB)
001CBE EAB7 CDD3EC          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       EAB8                     DWTPAT  EQU $-2
001CC1 EABA 18EE            12      JR  POP_IX_RET
                                
       EABC                     WTFAT:
001CC3 EABC CDD7EA          17      CALL    FATSETUP
001CC6 EABF D4B1EA          17      CALL    NC,DWT24B
001CC9 EAC2 D8              11      RET C
001CCA EAC3 DDCB0F7E        20      BIT 7,(IX+DPB_BPS)
001CCE EAC7 C8              11      RET Z       ;予備FATが無い
001CCF EAC8 CDDEEA          17      CALL    FATS2
001CD2 EACB E5              11      PUSH    HL      ;予備FAT
001CD3 EACC DD6E00          19      LD  L,(IX+DPB_FATLN)
001CD6 EACF DD6601          19      LD  H,(IX+DPB_FATLN+1)
001CD9 EAD2 19              11      ADD HL,DE
001CDA EAD3 EB               4      EX  DE,HL
001CDB EAD4 E1              10      POP HL
001CDC EAD5 18DA            12      JR  DWT24B
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ1024毎に2KBを切り替える
                                ;------------------------
       EAD7                     FATSETUP:
001CDE EAD7 3AAAEF          13      LD  A,(_FATDRV)
001CE1 EADA CDDAEB          17      CALL    CHGDRVR     ;ドライブ切り替え
001CE4 EADD D8              11      RET C
       EADE                     FATS2:
001CE5 EADE DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001CE8 EAE1 0F               4      RRCA
001CE9 EAE2 CD0BEB          17      CALL    FATSETUP12  ;自己書き換え
       EAE3                     FATSX   EQU $-2
001CEC EAE5 210000          10      LD  HL,0
001CEF EAE8 4A               4      LD  C,D
001CF0 EAE9 54               4      LD  D,H
001CF1 EAEA 3AABEF          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
001CF4 EAED 47               4      LD  B,A
001CF5 EAEE 04               4      INC B
001CF6 EAEF DD7E00          19      LD  A,(IX+DPB_FATLN)
       EAF2                     FAT_SKP:
001CF9 EAF2 05               4      DEC B
001CFA EAF3 2805            12      JR  Z,FAT1
001CFC EAF5 19              11      ADD HL,DE
001CFD EAF6 93               4      SUB E
001CFE EAF7 30F9            12      JR  NC,FAT_SKP
001D00 EAF9 C9              10      RET
       EAFA                     FAT1:
001D01 EAFA EB               4      EX  DE,HL
001D02 EAFB B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001D03 EAFC 3801            12      JR  C,FAT2
001D05 EAFE 79               4      LD  A,C
       EAFF                     FAT2:
001D06 EAFF 47               4      LD  B,A
                                
001D07 EB00 2AFAF0          16      LD  HL,(_FATPS) ;fat sector pos
001D0A EB03 19              11      ADD HL,DE
001D0B EB04 EB               4      EX  DE,HL
001D0C EB05 2A7CF0          16      LD  HL,(_FATBF)
001D0F EB08 AF               4      XOR A       ;CF=0
001D10 EB09 4F               4      LD  C,A
001D11 EB0A C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       EB0B                     FATSETUP12:
001D12 EB0B 110606          10      LD  DE,0606H    ;256
001D15 EB0E D8              11      RET C
001D16 EB0F 110303          10      LD  DE,0303H    ;512
001D19 EB12 0F               4      RRCA
001D1A EB13 D8              11      RET C
001D1B EB14 110102          10      LD  DE,0201H    ;1024
001D1E EB17 C9              10      RET
                                
       EB18                     FATSETUP16:
001D1F EB18 110808          10      LD  DE,0808H    ;256
001D22 EB1B D8              11      RET C
001D23 EB1C 110404          10      LD  DE,0404H
001D26 EB1F 0F               4      RRCA            ;512
001D27 EB20 D8              11      RET C
001D28 EB21 110202          10      LD  DE,0202H    ;1024
001D2B EB24 C9              10      RET
                                
       EB25                     CHGDRV:
001D2C EB25 E5              11      PUSH    HL
001D2D EB26 2189EF          10      LD  HL,_DSK
001D30 EB29 BE               7      CP  (HL)
001D31 EB2A 280A            12      JR  Z,CHGDRVE
       EB2C                     CHGDRV1:
001D33 EB2C DDE5            15      PUSH    IX
001D35 EB2E CD38EB          17      CALL    CHGDRV0
001D38 EB31 3A89EF          13      LD  A,(_DSK)
001D3B EB34 DDE1            14      POP IX
       EB36                     CHGDRVE:
001D3D EB36 E1              10      POP HL
001D3E EB37 C9              10      RET
                                
       EB38                     CHGDRV0:
001D3F EB38 6F               4      LD  L,A
001D40 EB39 CDDCEF          17      CALL    _GETDPB
001D43 EB3C D8              11      RET C
001D44 EB3D DD22A8EF        20      LD  (_DPB),IX
001D48 EB41 7D               4      LD  A,L
001D49 EB42 3289EF          13      LD  (_DSK),A
       EB45                     CHGDRV2:
001D4C EB45 C5              11      PUSH    BC
001D4D EB46 D5              11      PUSH    DE
001D4E EB47 ED7390EB        20      LD  (SPPAT2),SP
001D52 EB4B F3               4      DI
001D53 EB4C DDF9            10      LD  SP,IX
                                
001D55 EB4E E1              10      POP HL      ;00:DPB_FATLN
001D56 EB4F E1              10      POP HL      ;02:DPB_DRD
001D57 EB50 22A8EA          16      LD  (DRDPAT),HL
                                
001D5A EB53 E1              10      POP HL
001D5B EB54 22B8EA          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001D5E EB57 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001D5F EB58 7C               4      LD  A,H
001D60 EB59 32AFE1          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001D63 EB5C 3D               4      DEC A
001D64 EB5D 321AE9          13      LD  (_NCPAT),A
                                
001D67 EB60 E1              10      POP HL      ;08:DPB_MAXCL
001D68 EB61 7D               4      LD  A,L
001D69 EB62 32CEE1          13      LD  (CLPAT2),A
001D6C EB65 7C               4      LD  A,H
001D6D EB66 32CAE1          13      LD  (CLPAT1),A
001D70 EB69 2B               6      DEC HL
001D71 EB6A 22CBE3          16      LD  (MAXCLP),HL
                                
001D74 EB6D E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001D75 EB6E 4C               4      LD  C,H
                                
001D76 EB6F E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001D77 EB70 E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001D78 EB71 7C               4      LD  A,H     ;DPB_BPS
001D79 EB72 E607             7      AND 7
001D7B EB74 32B4E6          13      LD  (SECSZ+2),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98
                                                ;1セクタ256 GRAM/RAMF/CMOS/等
                                                ;1024   512 256
                                                ;4  2   1
001D7E EB77 87               4      ADD A,A     ;8  4   2
001D7F EB78 87               4      ADD A,A     ;010H   8   4
001D80 EB79 87               4      ADD A,A     ;020H   010H    8
001D81 EB7A 322CE0          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001D84 EB7D 2600             7      LD  H,0
001D86 EB7F 22FAF0          16      LD  (_FATPS),HL
                                
001D89 EB82 E1              10      POP HL      ;10:DPB_DIRPS
001D8A EB83 22FCF0          16      LD  (_DIRPS),HL
                                
001D8D EB86 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001D8E EB87 7C               4      LD  A,H
001D8F EB88 3284EF          13      LD  (_DRIVE),A
                                
001D92 EB8B E1              10      POP HL      ;14:DPB_ADDCL
001D93 EB8C 22BFE1          16      LD  (CLSPAT),HL
                                
001D96 EB8F 310000          10      LD  SP,0        ;元のSPを復元
       EB90                     SPPAT2  EQU $-2
001D99 EB92 FB               4      EI
001D9A EB93 2AFCF0          16      LD  HL,(_DIRPS)
001D9D EB96 0600             7      LD  B,0
001D9F EB98 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001DA0 EB99 2247E0          16      LD  (MD_PAT),HL
                                
001DA3 EB9C 2ACBE3          16      LD  HL,(MAXCLP);
001DA6 EB9F 11F60F          10      LD  DE,4086     ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001DA9 EBA2 ED52            15      SBC HL,DE       ;CF=0のはず
001DAB EBA4 300F            12      JR  NC,SETFAT16
001DAD EBA6 21A0E8          10      LD  HL,GNCL     ;FAT12
001DB0 EBA9 11C3E8          10      LD  DE,SNCL
001DB3 EBAC 010BEB          10      LD  BC,FATSETUP12
001DB6 EBAF DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001DBA EBB3 180D            12      JR  EXTRA1
       EBB5                     SETFAT16:
001DBC EBB5 21F7E8          10      LD  HL,GNCL16   ;FAT16
001DBF EBB8 1104E9          10      LD  DE,SNCL16
001DC2 EBBB 0118EB          10      LD  BC,FATSETUP16
001DC5 EBBE DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       EBC2                     EXTRA1:
001DC9 EBC2 22F8EF          16      LD  (GNCPAT),HL
001DCC EBC5 ED53FBEF        20      LD  (SNCPAT),DE
001DD0 EBC9 ED43E3EA        20      LD  (FATSX),BC
001DD4 EBCD D1              10      POP DE
001DD5 EBCE C1              10      POP BC
001DD6 EBCF AF               4      XOR A
001DD7 EBD0 C9              10      RET
                                
       EBD1                     GETDPBD:
001DD8 EBD1 DDE3            23      EX  (SP),IX
001DDA EBD3 DDE5            15      PUSH    IX
001DDC EBD5 3A88EF          13      LD  A,(_DRV)
001DDF EBD8 1807            12      JR  GETDPB1
                                
       EBDA                     CHGDRVR:
001DE1 EBDA CDD9EF          17      CALL    _CHGDRV
001DE4 EBDD D8              11      RET C
001DE5 EBDE 3A89EF          13      LD  A,(_DSK)
       EBE1                     GETDPB1:
001DE8 EBE1 C3DCEF          10      JP  _GETDPB
                                
       EBE4                     GETDPB:
001DEB EBE4 FE08             7      CP  8
001DED EBE6 3F               4      CCF
001DEE EBE7 D8              11      RET C
001DEF EBE8 0F               4      RRCA
001DF0 EBE9 0F               4      RRCA
001DF1 EBEA 0F               4      RRCA
001DF2 EBEB DD                      DB  0DDH        ;Z80未定義命令
001DF3 EBEC 6F               4      LD  L,A     ;LD IXL,A
001DF4 EBED DD                      DB  0DDH        ;Z80未定義命令
001DF5 EBEE 26F2             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001DF7 EBF0 DD7E00          19      LD  A,(IX+DPB_FATLN)
001DFA EBF3 A7               4      AND A       ;CF=0の為
001DFB EBF4 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001DFF EBF8 C0              11      RET NZ      ;FAT16
001E00 EBF9 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001E04 EBFD C0              11      RET NZ      ;BPB
001E05 EBFE FE01             7      CP  001H        ;A=0 THEN CF=1
001E07 EC00 C9              10      RET
                                
       EC01                     _SYS5F:
001E08 EC01 AF               4      XOR A
       EC02                     FFLUSH:
001E09 EC02 F5              11      PUSH    AF
001E0A EC03 CD28E8          17      CALL    WTFATX
001E0D EC06 AF               4      XOR A
001E0E EC07 32ABEF          13      LD  (_FATIX),A
001E11 EC0A 2F               4      CPL         ;0FFH
001E12 EC0B 32AAEF          13      LD  (_FATDRV),A
001E15 EC0E 3E                      DB  03EH        ;次のPUSH AFをスキップ
       EC0F                     FFLUSHBUF:
001E16 EC0F F5              11      PUSH    AF
001E17 EC10 CDDEE7          17      CALL    DWTX
001E1A EC13 3EFF             7      LD  A,0FFH
001E1C EC15 3239EF          13      LD  (SFILE),A
001E1F EC18 32A5EF          13      LD  (_DBDRV),A
001E22 EC1B F1              10      POP AF
001E23 EC1C C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "88DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   PC-8801mkIISR
                                
                                ;   FLOPPY DISK DRIVER
                                ;
       EC1D                     PUTCOM_EXECUTE:
001E24 EC1D 3E0D             7      LD  A,0DH       ;エグゼキュート
                                ;   コマンド送信
       EC1F                     PUTCOM:
001E26 EC1F F5              11      PUSH    AF
001E27 EC20 3E0F             7      LD  A,00FH
001E29 EC22 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
001E2B EC24 F1              10      POP AF
                                ;   通常ハンドシェイク（ホストが送信）
       EC25                     PUTDAT:
001E2C EC25 F5              11      PUSH    AF
       EC26                     PUTDAT1:
001E2D EC26 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E2F EC28 E602             7      AND 2       ;RFD
001E31 EC2A 28FA            12      JR  Z,PUTDAT1
001E33 EC2C 3E0E             7      LD  A,00EH      ;ATN=0
001E35 EC2E D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
001E37 EC30 F1              10      POP AF
001E38 EC31 D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
001E3A EC33 F5              11      PUSH    AF
001E3B EC34 3E09             7      LD  A,9     ;DAV=1
001E3D EC36 D3FF            11      OUT (0FFH),A
       EC38                     PUTDAT2:
001E3F EC38 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E41 EC3A E604             7      AND 4       ;DAC
001E43 EC3C 28FA            12      JR  Z,PUTDAT2
                                
001E45 EC3E 3E08             7      LD  A,8     ;DAV=0
001E47 EC40 D3FF            11      OUT (0FFH),A
       EC42                     PUTDAT3:
001E49 EC42 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E4B EC44 E604             7      AND 4       ;DAC
001E4D EC46 20FA            12      JR  NZ,PUTDAT3
001E4F EC48 F1              10      POP AF
001E50 EC49 C9              10      RET
                                
                                ;   通常ハンドシェイク（ホストが受信）
       EC4A                     GETDAT:
001E51 EC4A 3E0B             7      LD  A,00BH      ;RFD=1
001E53 EC4C D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
       EC4E                     GETDAT1:
001E55 EC4E DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E57 EC50 0F               4      RRCA            ;DAV
001E58 EC51 30FB            12      JR  NC,GETDAT1
                                
001E5A EC53 3E0A             7      LD  A,00AH      ;RFD=0
001E5C EC55 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001E5E EC57 DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001E60 EC59 F5              11      PUSH    AF
001E61 EC5A 3E0D             7      LD  A,00DH      ;DAC=1
001E63 EC5C D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
       EC5E                     GETDAT2:
001E65 EC5E DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E67 EC60 0F               4      RRCA            ;DAV
001E68 EC61 38FB            12      JR  C,GETDAT2
                                
001E6A EC63 3E0C             7      LD  A,00CH      ;DAC=0
001E6C EC65 D3FF            11      OUT (0FFH),A
001E6E EC67 F1              10      POP AF
001E6F EC68 C9              10      RET
                                
                                ;   高速ハンドシェイク（ホストが送信）
                                ;   HL:アドレス BC:受信サイズ（必ず偶数にする）
       EC69                     FPUTDAT:
       EC69                     FPUTDAT1:
001E70 EC69 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E72 EC6B E602             7      AND 2       ;RFD
001E74 EC6D 28FA            12      JR  Z,FPUTDAT1
001E76 EC6F 3E0E             7      LD  A,00EH      ;ATN=0
001E78 EC71 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001E7A EC73 7E               7      LD  A,(HL)
001E7B EC74 D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
                                
001E7D EC76 3E09             7      LD  A,9     ;DAV=1
001E7F EC78 D3FF            11      OUT (0FFH),A
001E81 EC7A 23               6      INC HL
001E82 EC7B 0B               6      DEC BC
       EC7C                     FPUTDAT2:
001E83 EC7C DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E85 EC7E E604             7      AND 4       ;DAC
001E87 EC80 28FA            12      JR  Z,FPUTDAT2
                                
001E89 EC82 7E               7      LD  A,(HL)
001E8A EC83 D3FD            11      OUT (0FDH),A    ;標準状態ではサブシステムへのデータ送信ポート
                                
001E8C EC85 3E08             7      LD  A,8     ;DAV=0
001E8E EC87 D3FF            11      OUT (0FFH),A
       EC89                     FPUTDAT3:
001E90 EC89 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001E92 EC8B E604             7      AND 4       ;DAC
001E94 EC8D 20FA            12      JR  NZ,FPUTDAT3
                                
001E96 EC8F EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001E98 EC91 E0              11      RET PO
001E99 EC92 18D5            12      JR  FPUTDAT
                                
                                
                                ;   高速ハンドシェイク（ホストが受信）
                                ;   HL:アドレス BC:受信サイズ（必ず偶数にする）
       EC94                     FGETDAT:
001E9B EC94 3E0B             7      LD  A,00BH      ;RFD=1
001E9D EC96 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
       EC98                     FGETDAT1:
001E9F EC98 DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001EA1 EC9A 0F               4      RRCA            ;DAV
001EA2 EC9B 30FB            12      JR  NC,FGETDAT1
                                
001EA4 EC9D 3E0A             7      LD  A,00AH      ;RFD=0
001EA6 EC9F D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
                                
001EA8 ECA1 DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001EAA ECA3 77               7      LD  (HL),A
                                
001EAB ECA4 3E0D             7      LD  A,00DH      ;DAC=1
001EAD ECA6 D3FF            11      OUT (0FFH),A    ;ディスクサブシステムI/F 8255 コントロール
001EAF ECA8 23               6      INC HL
001EB0 ECA9 0B               6      DEC BC
       ECAA                     FGETDAT2:
001EB1 ECAA DBFE            11      IN  A,(0FEH)    ;ディスクサブシステムI/F 8255 ポートC
001EB3 ECAC 0F               4      RRCA            ;DAV
001EB4 ECAD 38FB            12      JR  C,FGETDAT2
                                
001EB6 ECAF DBFC            11      IN  A,(0FCH)    ;標準状態ではサブシステムからのデータ受信ポート
001EB8 ECB1 77               7      LD  (HL),A
                                
001EB9 ECB2 3E0C             7      LD  A,00CH      ;DAC=0
001EBB ECB4 D3FF            11      OUT (0FFH),A
                                
001EBD ECB6 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001EBF ECB8 E0              11      RET PO
001EC0 ECB9 18D9            12      JR  FGETDAT
                                
                                ;   論理セクタ番号からトラック番号とセクタ番号を得る
                                ;   in
                                ;   DE:論理セクタ
       ECBB                     CALC_SECTOR:
001EC2 ECBB C5              11      PUSH    BC
001EC3 ECBC DD4E0D          19      LD  C,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001EC6 ECBF 0610             7      LD  B,16
001EC8 ECC1 AF               4      XOR A
001EC9 ECC2 EB               4      EX  DE,HL
       ECC3                     DIV1:
001ECA ECC3 29              11      ADD HL,HL
001ECB ECC4 8F               4      ADC A,A
001ECC ECC5 B9               4      CP  C
001ECD ECC6 3802            12      JR  C,DIV2
001ECF ECC8 91               4      SUB C
001ED0 ECC9 2C               4      INC L
       ECCA                     DIV2:
001ED1 ECCA 10F7            13      DJNZ    DIV1
                                
001ED3 ECCC 3C               4      INC A   ;最小のセクタは１固定
001ED4 ECCD 55               4      LD  D,L ;TRACK
       ECCE                     DIV3:
001ED5 ECCE 5F               4      LD  E,A ;SECTOR
001ED6 ECCF C1              10      POP BC
001ED7 ECD0 C9              10      RET
                                
       ECD1                     WTTRK:
001ED8 ECD1 37               4      SCF
001ED9 ECD2 C9              10      RET
       ECD3                     FDWT:
001EDA ECD3 E5              11      PUSH    HL
001EDB ECD4 D5              11      PUSH    DE
001EDC ECD5 CDBBEC          17      CALL    CALC_SECTOR
001EDF ECD8 7A               4      LD  A,D     ;トラック
001EE0 ECD9 3237ED          13      LD  (FDWT_TRACK),A
001EE3 ECDC 7B               4      LD  A,E     ;セクタ
001EE4 ECDD 3232ED          13      LD  (FDWT_SECTOR),A
001EE7 ECE0 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001EEA ECE3 93               4      SUB E
001EEB ECE4 3C               4      INC A
001EEC ECE5 67               4      LD  H,A
001EED ECE6 D1              10      POP DE
001EEE ECE7 3AB4E6          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
001EF1 ECEA 4F               4      LD  C,A
001EF2 ECEB AF               4      XOR A
       ECEC                     FDWT2:
001EF3 ECEC 81               4      ADD A,C
001EF4 ECED 13               6      INC DE
001EF5 ECEE 05               4      DEC B
001EF6 ECEF 2807            12      JR  Z,FDWT3
001EF8 ECF1 25               4      DEC H       ;トラック、ヘッドを跨がない
001EF9 ECF2 2804            12      JR  Z,FDWT3
001EFB ECF4 FE3A             7      CP  03AH        ;バッファとして04000H-07BFFHまで使える
001EFD ECF6 38F4            12      JR  C,FDWT2
       ECF8                     FDWT3:
001EFF ECF8 4F               4      LD  C,A
001F00 ECF9 E1              10      POP HL
001F01 ECFA 3E16             7      LD  A,16H       ;高速レシーブメモリ
001F03 ECFC CD1FEC          17      CALL    PUTCOM
001F06 ECFF 3E40             7      LD  A,DSS_DATA/256  ;開始アドレスH
001F08 ED01 CD25EC          17      CALL    PUTDAT
001F0B ED04 AF               4      XOR A       ;開始アドレスL
001F0C ED05 CD25EC          17      CALL    PUTDAT
001F0F ED08 79               4      LD  A,C     ;バイト数H
001F10 ED09 CD25EC          17      CALL    PUTDAT
001F13 ED0C AF               4      XOR A       ;バイト数L
001F14 ED0D CD25EC          17      CALL    PUTDAT
001F17 ED10 C5              11      PUSH    BC
001F18 ED11 41               4      LD  B,C
001F19 ED12 0E00             7      LD  C,0
001F1B ED14 CD69EC          17      CALL    FPUTDAT
001F1E ED17 C1              10      POP BC
001F1F ED18 CD1DEC          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001F22 ED1B 3E7C             7      LD  A,WRITEDISKEX/256
001F24 ED1D CD25EC          17      CALL    PUTDAT
001F27 ED20 3EA3             7      LD  A,WRITEDISKEX%256
001F29 ED22 CD25EC          17      CALL    PUTDAT
001F2C ED25 DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
001F2F ED28 CD25EC          17      CALL    PUTDAT
001F32 ED2B DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001F35 ED2E CD25EC          17      CALL    PUTDAT
       ED32                     FDWT_SECTOR EQU $+1
001F38 ED31 3E00             7      LD  A,0     ;セクタ
001F3A ED33 CD25EC          17      CALL    PUTDAT
001F3D ED36 3E00             7      LD  A,0     ;トラック
       ED37                     FDWT_TRACK  EQU $-1
001F3F ED38 CD25EC          17      CALL    PUTDAT
001F42 ED3B DD7E0A          19      LD  A,(IX+DPB_FDMODE)   ;フロッピーディスクのモード
001F45 ED3E CD25EC          17      CALL    PUTDAT
001F48 ED41 3AB4E6          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
001F4B ED44 CD25EC          17      CALL    PUTDAT
001F4E ED47 79               4      LD  A,C
001F4F ED48 CD25EC          17      CALL    PUTDAT      ;バイト数H
001F52 ED4B DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;フロッピーディスクのシリンダ数
001F55 ED4E CD25EC          17      CALL    PUTDAT
                                
001F58 ED51 CD1DEC          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001F5B ED54 3E7E             7      LD  A,RESULTEX/256
001F5D ED56 CD25EC          17      CALL    PUTDAT
001F60 ED59 3E13             7      LD  A,RESULTEX%256
001F62 ED5B CD25EC          17      CALL    PUTDAT
                                
001F65 ED5E CD4AEC          17      CALL    GETDAT
001F68 ED61 4F               4      LD  C,A
001F69 ED62 FE01             7      CP  1
001F6B ED64 D8              11      RET C
                                
001F6C ED65 78               4      LD  A,B
001F6D ED66 B7               4      OR  A
001F6E ED67 C2D3EC          10      JP  NZ,FDWT
001F71 ED6A C9              10      RET
                                
       ED6B                     FDRD:
001F72 ED6B CD1DEC          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001F75 ED6E 3E7C             7      LD  A,READDISKEX/256
001F77 ED70 CD25EC          17      CALL    PUTDAT
001F7A ED73 AF               4      XOR A
001F7B ED74 CD25EC          17      CALL    PUTDAT
001F7E ED77 DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
001F81 ED7A CD25EC          17      CALL    PUTDAT
001F84 ED7D DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001F87 ED80 CD25EC          17      CALL    PUTDAT
001F8A ED83 E5              11      PUSH    HL
001F8B ED84 D5              11      PUSH    DE
001F8C ED85 CDBBEC          17      CALL    CALC_SECTOR
001F8F ED88 7B               4      LD  A,E     ;セクタ
001F90 ED89 CD25EC          17      CALL    PUTDAT
001F93 ED8C 7A               4      LD  A,D     ;トラック
001F94 ED8D CD25EC          17      CALL    PUTDAT
001F97 ED90 DD7E0D          19      LD  A,(IX+DPB_MAXSEC)   ;フロッピーディスクの1トラックのセクタ数
001F9A ED93 93               4      SUB E
001F9B ED94 3C               4      INC A
001F9C ED95 67               4      LD  H,A
001F9D ED96 D1              10      POP DE
001F9E ED97 DD7E0A          19      LD  A,(IX+DPB_FDMODE)   ;フロッピーディスクのモード
001FA1 ED9A CD25EC          17      CALL    PUTDAT
001FA4 ED9D 3AB4E6          13      LD  A,(SECSZ+2) ;1セクタのサイズの上位1バイト
001FA7 EDA0 CD25EC          17      CALL    PUTDAT
001FAA EDA3 4F               4      LD  C,A
001FAB EDA4 AF               4      XOR A
       EDA5                     FDRD2:
001FAC EDA5 81               4      ADD A,C
001FAD EDA6 13               6      INC DE
001FAE EDA7 05               4      DEC B
001FAF EDA8 2807            12      JR  Z,FDRD3
001FB1 EDAA 25               4      DEC H       ;トラック、ヘッドを跨がない
001FB2 EDAB 2804            12      JR  Z,FDRD3
001FB4 EDAD FE3A             7      CP  03AH        ;バッファとして04000H-07BFFHまで使える
001FB6 EDAF 38F4            12      JR  C,FDRD2
       EDB1                     FDRD3:
001FB8 EDB1 E1              10      POP HL
001FB9 EDB2 4F               4      LD  C,A
001FBA EDB3 CD25EC          17      CALL    PUTDAT      ;バイト数H
001FBD EDB6 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;フロッピーディスクのシリンダ数
001FC0 EDB9 CD25EC          17      CALL    PUTDAT
                                
001FC3 EDBC CD1DEC          17      CALL    PUTCOM_EXECUTE      ;エグゼキュート
001FC6 EDBF 3E7E             7      LD  A,RESULTEX/256
001FC8 EDC1 CD25EC          17      CALL    PUTDAT
001FCB EDC4 3E13             7      LD  A,RESULTEX%256
001FCD EDC6 CD25EC          17      CALL    PUTDAT
                                
001FD0 EDC9 CD4AEC          17      CALL    GETDAT
001FD3 EDCC 4F               4      LD  C,A
001FD4 EDCD FE01             7      CP  1
001FD6 EDCF D8              11      RET C
                                
001FD7 EDD0 3E15             7      LD  A,15H       ;高速センドメモリ
001FD9 EDD2 CD1FEC          17      CALL    PUTCOM
001FDC EDD5 3E40             7      LD  A,DSS_DATA/256  ;開始アドレスH
001FDE EDD7 CD25EC          17      CALL    PUTDAT
001FE1 EDDA AF               4      XOR A       ;開始アドレスL
001FE2 EDDB CD25EC          17      CALL    PUTDAT
001FE5 EDDE 79               4      LD  A,C     ;バイト数H
001FE6 EDDF CD25EC          17      CALL    PUTDAT
001FE9 EDE2 AF               4      XOR A       ;バイト数L
001FEA EDE3 CD25EC          17      CALL    PUTDAT
001FED EDE6 C5              11      PUSH    BC
001FEE EDE7 41               4      LD  B,C
001FEF EDE8 0E00             7      LD  C,0
001FF1 EDEA CD94EC          17      CALL    FGETDAT
001FF4 EDED C1              10      POP BC
001FF5 EDEE 78               4      LD  A,B
001FF6 EDEF B7               4      OR  A
001FF7 EDF0 C26BED          10      JP  NZ,FDRD
001FFA EDF3 C9              10      RET
                                
[EOF:88DISK.ASM:UTF_8]
                                    INCLUDE "88INTVEC.ASM"
                                
                                ;   LSX-Dodgers TABLE 割り込みベクタとキーのテーブル(Shift/Ctrl)
                                
       EDF4                     AT_TABLE:
001FFB EDF4                         DS  INTAD-AT_TABLE
                                
                                ;
                                ;   割り込みベクタ:アドレス下位1バイトが0になるように
                                ;
       EE00                     IRXRDY:
002007 EE00 A3D9                    DW  INTE88
       EE02                     IVRTC:
002009 EE02 6DD9                    DW  INTVRTC
       EE04                     ICLOCK:
00200B EE04 A3D9                    DW  INTE88
       EE06                     IINT4:
00200D EE06 A3D9                    DW  INTE88
       EE08                     IINT3:
00200F EE08 A3D9                    DW  INTE88
       EE0A                     IINT2:
002011 EE0A A3D9                    DW  INTE88
       EE0C                     IFDINT1:
002013 EE0C A3D9                    DW  INTE88
       EE0E                     IFDINT2:
002015 EE0E A3D9                    DW  INTE88
                                
002017 EE10                         DS  030H-18
       EE2E                     EXTSP:
                                
       EE2E                     SHIFT_TABLE:
002035 EE2E 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
00203D EE36 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
002045 EE3E 4041424344454647        DB  '@','A','B','C','D','E','F','G' ;2
00204D EE46 48494A4B4C4D4E4F        DB  'H','I','J','K','L','M','N','O' ;3
002055 EE4E 5051525354555657        DB  'P','Q','R','S','T','U','V','W' ;4
00205D EE56 58595A7B7C7D7E3D        DB  'X','Y','Z','{','|','}','~','=' ;5
002065 EE5E 3021222324252627        DB  '0','!','"','#','$','%','&',27H ;6
00206D EE66 28292A2B3C3E3F5F        DB  '(',')','*','+','<','>','?','_' ;7
002075 EE6E 0B1E1C0800000000        DB  0BH,1EH,1CH,08H,00H,00H,00H,00H ;8
00207D EE76 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
002085 EE7E 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
00208D EE86 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
002095 EE8E 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
                                
       EE96                     CTRL_TABLE:
00209D EE96 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
0020A5 EE9E 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
0020AD EEA6 4001020304050607        DB  '@',01H,02H,03H,04H,05H,06H,07H ;2
0020B5 EEAE 08090A0B0C0D0E0F        DB  08H,09H,0AH,0BH,0CH,0DH,0EH,0FH ;3
0020BD EEB6 1011121314151617        DB  10H,11H,12H,13H,14H,15H,16H,17H ;4
0020C5 EEBE 18191A5B5C5D5E2D        DB  18H,19H,1AH,'[',5CH,']','^','-' ;5
0020CD EEC6 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;6
0020D5 EECE 38393A3B2C2E2F5F        DB  '8','9',':',';',',','.','/','_' ;7
0020DD EED6 0C1E1C0800000000        DB  0CH,1EH,1CH,08H,00H,00H,00H,00H ;8
0020E5 EEDE 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
0020ED EEE6 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
0020F5 EEEE 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
0020FD EEF6 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
[EOF:88INTVEC.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
       EEFE                     AT_WORK:
002105 EEFE                         DS  WORKAD-AT_WORK
                                
       EF00                     CPM_BOOT:
002107 EF00 C30000          10      JP  0
       EF03                     _SYS00:     ;(BDOS)プログラム終了
       EF03                     CPM_WBOOT:
00210A EF03 C309D2          10      JP  WBOOT1
       EF06                     CPM_CONST:
00210D EF06 C34ADA          10      JP  CONSTX
       EF09                     _SYS07:     ;(BDOS)コンソール直接入力
       EF09                     CPM_CONIN:
002110 EF09 C302DA          10      JP  FLGET
       EF0C                     CPM_CONOUT:
002113 EF0C C384DC          10      JP  CONOUT1
                                
       EF0F                     DECBF:              ;10進数表示時のバッファ(5バイト)
002116 EF0F                         DS  5
       EF0F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       EF11                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
00211B EF14 00                  FDRV:   DB  0
00211C EF15                     FNAME:  DS  36
002140 EF39                     SFILE:  DS  33      ;DRV FILENAME
                                
002161 EF5A                         DS  3
                                
002164 EF5D 0000                LEFTX:  DW  0
002166 EF5F 0000                DTAX:   DW  0
                                
       EF61                     ZERO:
       EF61                     BEEPD:
002168 EF61 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
002170 EF69 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
       EF62                     RTC_YY  EQU BEEPD+1
       EF63                     RTC_MW  EQU BEEPD+2
       EF64                     RTC_DD  EQU BEEPD+3
       EF65                     RTC_TT  EQU BEEPD+4
       EF66                     RTC_MM  EQU BEEPD+5
       EF67                     RTC_SS  EQU BEEPD+6
       EF62                     ROM_SLT EQU BEEPD+1
                                
002177 EF70 00                  CHECK:  DB  0
                                
002178 EF71 4F4B24              OK: DB  "OK$"
00217B EF74                         DS  5
002180 EF79 4572726F722124      COMERM: DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
002187 EF80 FF                  _CYL0:  DB  0FFH    ;Cylinder
002188 EF81 FF                  _CYL1:  DB  0FFH    ;Cylinder
002189 EF82 FF                  _CYL2:  DB  0FFH    ;Cylinder
00218A EF83 FF                  _CYL3:  DB  0FFH    ;Cylinder
00218B EF84 00                  _DRIVE: DB  0   ;unit number
00218C EF85 00                  _SEEKSP:DB  0   ;Seek speed
00218D EF86 FF                  _ISEEK: DB  0FFH    ;
00218E EF87 00                  _DVSW:  DB  0
00218F EF88 00                  _DRV:   DB  0
002190 EF89 FF                  _DSK:   DB  0FFH
002191 EF8A 8000                _DTA:   DW  00080H
002193 EF8C 0000                _CTC:   DW  0
002195 EF8E 0000                _TXADR: DW  0
002197 EF90 0000                _KEYPS: DW  0
002199 EF92 00FF                _KEYD:  DW  0FF00H  ;キーデータ
00219B EF94 0010                _KEYSP: DB  KEYSP_L,KEYSP_H ;オートリピートの速度
00219D EF96 00                  _COLORF:DB  COLORF  ;色
00219E EF97 18                  _LINE:  DB  LINE
                                
00219F EF98 0000                _FCB:   DW  0   ;SEARCH FILES
0021A1 EF9A 0000                _FBPS:  DW  0   ;    //
0021A3 EF9C 0000                _FBAD:  DW  0   ;    //
0021A5 EF9E 00                  _FBCNT: DB  0   ;    //
0021A6 EF9F 00                  _FILEN: DB  0   ;    //
0021A7 EFA0 00                  _DIRF:  DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
0021A8 EFA1                         DS  1
0021A9 EFA2 00                  _WTFATF:DB  0   ;FATバッファの更新フラグ
0021AA EFA3                         DS  1
0021AB EFA4 00                  _WTDBF: DB  0   ;データバッファの更新フラグ
0021AC EFA5 FF                  _DBDRV: DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
0021AD EFA6 0000                _DBSEC: DW  0   ;データバッファにあるデータを読み込んだセクタ番号
0021AF EFA8 0000                _DPB:   DW  0
       EFAA                     _FATDRV:
0021B1 EFAA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
0021B2 EFAB 00                  _FATIX: DB  0   ;FATバッファに読み込んでいるインデックス
       EFAC                     _FAKEFREE:
0021B3 EFAC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
0021B5 EFAE                         DS  2
                                
       EFB0                     CRTCD:
0021B7 EFB0 6F                      DB  06FH
       EFB1                     _WIDTH:
0021B8 EFB1 50                      DB  WIDTH
       EFB2                     TVRAMTOP:
0021B9 EFB2 5938                    DB  059H,038H
0021BB EFB4 1F02                    DB  01FH,002H
       EFB6                     _LINE2:
0021BD EFB6 19                      DB  019H
       EFB7                     WKE4:
0021BE EFB7 1C                      DB  01CH
       EFB8                     WKE6:
0021BF EFB8 00                      DB  000H
       EFB9                     WK40:
0021C0 EFB9 07                      DB  007H
       EFBA                     _PAGE_MINUS:
0021C1 EFBA 80F8                    DW  0-WIDTH*LINE
       EFBC                     _WIDTH_MINUS:
0021C3 EFBC B0FF                    DW  0-WIDTH
       EFBE                     WK30:
0021C5 EFBE 0C                      DB  00CH
       EFBF                     WK31:
       EFBF                     WK1FD0:
0021C6 EFBF 20                      DB  020H
                                
0021C7 EFC0 0000                CTC0:   DW  INTCTCE
0021C9 EFC2 0000                CTC1:   DW  INTCTCE
0021CB EFC4 0000                CTC2:   DW  INTCTCE
0021CD EFC6 0000                CTC3:   DW  INTCTCE
0021CF EFC8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
0021D1 EFCA C3BDDD          10  _INKEY: JP  INKEY
0021D4 EFCD C380DB          10  _PRINT: JP  PRINT
0021D7 EFD0 C316DE          10  _SCRN:  JP  SCRN
0021DA EFD3 C35FDD          10  _POS:   JP  POS
0021DD EFD6 C3C8DB          10  _LOC:   JP  LOC
       EFD9                     _CHGDRV:
0021E0 EFD9 C325EB          10      JP  CHGDRV
       EFDC                     _GETDPB:
0021E3 EFDC C3E4EB          10      JP  GETDPB
       EFDF                     _FFLUSH:
0021E6 EFDF C302EC          10      JP  FFLUSH
       EFE2                     _RDFATX:
0021E9 EFE2 C3FEE7          10      JP  RDFATX
0021EC EFE5 C326E9          10  _RDFAT: JP  RDFAT
0021EF EFE8 C3D1EC          10  _WTTRK: JP  WTTRK
0021F2 EFEB C36BED          10  _FDRD:  JP  FDRD
0021F5 EFEE C3D3EC          10  _FDWT:  JP  FDWT
       EFF1                     _BPB2DPB:
0021F8 EFF1 C3B3E9          10      JP  BPB2DPB
       EFF4                     _BREAK:
0021FB EFF4 C3ADD3          10      JP  END_BATCH
       EFF7                     _GNCL:
0021FE EFF7 C3A0E8          10      JP  GNCL        ; self-modifying code
       EFF8                     GNCPAT  EQU $-2
       EFFA                     _SNCL:
002201 EFFA C3C3E8          10      JP  SNCL        ; self-modifying code
       EFFB                     SNCPAT  EQU $-2
002204 EFFD C366D2          10  _COMANL:JP  COMANL
                                
       F000                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F000                     STABLE:
                                ;0
002207 F000 03EFD5D9E1D959E0        DW  _SYS00,_SYS01,_SYS02,_SYS03
00220F F008 D3D6D3D6E6D909EF        DW  _SYS04,_SYS05,_SYS06,_SYS07
002217 F010 EED9D5D616DA42DA        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
00221F F018 EAD6EFD6FED60FD7        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
002227 F020 63D7AAD7F3D724D8        DW  _SYS10,_SYS11,_SYS12,_SYS13
00222F F028 2CD842D857D84FD8        DW  _SYS14,_SYS15,_SYS16,_SYS17
002237 F030 9ED8A3D8A8D8AED8        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
00223F F038 D3D6D4D8D3D6D8D8        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
002247 F040 D3D68ED896D8DFD8        DW  _SYS20,_SYS21,_SYS22,_SYS23
00224F F048 05D9D3D6D2E4AAE5        DW  _SYS24,_ERROR,_SYS26,_SYS27
002257 F050 96D80ED958DA59E0        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
00225F F058 7FDA59E0D3D62FD9        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
002267 F060 29D9D3D6D3D6D3D6        DW  _SYS30,_ERROR,_ERROR,_ERROR
00226F F068 D3D6D3D6D3D6D3D6        DW  _ERROR,_ERROR,_ERROR,_ERROR
002277 F070 D3D659E059E050D9        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
00227F F078 B6D6                    DW  _DOS2
                                
002281 F07A                         DS  2
002283 F07C 00F3                _FATBF: DW  FATBF
002285 F07E 00FB                _DTBUF: DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F080                     CTRLTB:
002287 F080 CBDBCBDB02DC0ADD        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
00228F F088 04DD2DDCDDDCA9DC        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002297 F090 D2DBF7DB0DDD59DC        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
00229F F098 DADC4CDC14DDCBDB        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
0022A7 F0A0 CBDBCBDB51DCCBDB        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
0022AF F0A8 CBDBCBDBCBDBCBDB        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
0022B7 F0B0 CBDBCBDBDADC60DC        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
0022BF F0B8 B4DBD9DBEEDB0DDD        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
0022C7 F0C0 0200                M2D:    DW  2
0022C9 F0C2 FD02                    DB  0FDH,2
0022CB F0C4 6401                    DW  356
0022CD F0C6 FF0728090182            DB  0FFH,7,40,9,1,082H
0022D3 F0CC 0500A7000800            DW  5,0A7H,8
                                
0022D9 F0D2 0200                M2HD:   DW  2
0022DB F0D4 FE01                    DB  0FEH,1
0022DD F0D6 C704                    DW  1223
0022DF F0D8 FE064D080184            DB  0FEH,6,77,8,1,084H
0022E5 F0DE 0500A7000900            DW  5,0A7H,9
                                
0022EB F0E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
0022ED F0E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
0022EF F0E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
0022F1 F0EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F0EE                     SDDATAE:
                                
0022F5 F0EE                         DS  2
       F0F0                     _FCB_BAT:
0022F7 F0F0 61F1                    DW  FCB_BAT
       F0F2                     _PATH:
0022F9 F0F2 00F1                    DW  PATHD
                                
0022FB F0F4                     SCDIR:  DS  2       ;+14 +15
0022FD F0F6                     SFBPS:  DS  2       ;FBPS
0022FF F0F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
002301 F0FA 0000                _FATPS: DW  0
002303 F0FC 0000                _DIRPS: DW  0
002305 F0FE 0000                _CLPS:  DW  0
                                
       F100                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
002307 F100                     PATHD:  DS  PATHX
002342 F13B 00                  PATHE:  DB  0
                                
       F13C                     DTA_CCP:
002343 F13C                         DS  37
                                
       F161                     FCB_BAT:
002368 F161                         DS  37
                                
00238D F186 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
002398 F191 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "88TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE キーのテーブル
                                
       F198                     KEY_TABLE:
00239F F198 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;0
0023A7 F1A0 38392A2B3D2E2C0D        DB  '8','9','*','+','=','.',',',0DH ;1
0023AF F1A8 4061626364656667        DB  '@','a','b','c','d','e','f','g' ;2
0023B7 F1B0 68696A6B6C6D6E6F        DB  'h','i','j','k','l','m','n','o' ;3
0023BF F1B8 7071727374757677        DB  'p','q','r','s','t','u','v','w' ;4
0023C7 F1C0 78797A5B5C5D5E2D        DB  'x','y','z','[',5CH,']','^','-' ;5
0023CF F1C8 3031323334353637        DB  '0','1','2','3','4','5','6','7' ;6
0023D7 F1D0 38393A3B2C2E2F5C        DB  '8','9',':',';',',','.','/',5CH ;7
0023DF F1D8 0C1E1C0800000000        DB  0CH,1EH,1CH,08H,00H,00H,00H,00H ;8
0023E7 F1E0 030000000000201B        DB  03H,00H,00H,00H,00H,00H,' ',1BH ;9
0023EF F1E8 091F1D00002D2F00        DB  09H,1FH,1DH,00H,00H,'-','/',00H ;A
0023F7 F1F0 0000000000000000        DB  00H,00H,00H,00H,00H,00H,00H,00H ;B
0023FF F1F8 0000000000081208        DB  00H,00H,00H,00H,00H,08H,12H,08H ;C
[EOF:88TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "88DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   PC-8801mkIISR
                                
       F200                     _DEVICE:
                                
                                ;   A:
                                
002407 F200 0200                    DW  2   ;DPB_FATLN
002409 F202 EBEF                    DW  _FDRD   ;DPB_DRD
00240B F204 EEEF                    DW  _FDWT   ;DPB_DWT
00240D F206 FD                      DB  0FDH    ;DPB_FATID
00240E F207 02                      DB  2   ;DPB_SECPCL
00240F F208 6401                    DW  356 ;DPB_MAXCL
002411 F20A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002412 F20B 07                      DB  7   ;DPB_DIRSCNT
002413 F20C 28                      DB  40  ;DPB_MAXCYL
002414 F20D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002415 F20E 01                      DB  1   ;DPB_FATPS
002416 F20F 82                      DB  082H    ;DPB_BPS
002417 F210 0500                    DW  5   ;DPB_DIRPS
002419 F212 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00241A F213 00                      DB  0   ;DPB_UNITNO
00241B F214 0800                    DW  8   ;DPB_ADDCL
00241D F216 0000                    DW  0   ;DPB_16
00241F F218 0000                    DW  0   ;DPB_18
002421 F21A 0000                    DW  0   ;DPB_SDIR
002423 F21C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002427 F220 0200                    DW  2   ;DPB_FATLN
002429 F222 EBEF                    DW  _FDRD   ;DPB_DRD
00242B F224 EEEF                    DW  _FDWT   ;DPB_DWT
00242D F226 FD                      DB  0FDH    ;DPB_FATID
00242E F227 02                      DB  2   ;DPB_SECPCL
00242F F228 6401                    DW  356 ;DPB_MAXCL
002431 F22A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002432 F22B 07                      DB  7   ;DPB_DIRSCNT
002433 F22C 28                      DB  40  ;DPB_MAXCYL
002434 F22D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002435 F22E 01                      DB  1   ;DPB_FATPS
002436 F22F 82                      DB  082H    ;DPB_BPS
002437 F230 0500                    DW  5   ;DPB_DIRPS
002439 F232 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00243A F233 01                      DB  1   ;DPB_UNITNO
00243B F234 0800                    DW  8   ;DPB_ADDCL
00243D F236 0000                    DW  0   ;DPB_16
00243F F238 0000                    DW  0   ;DPB_18
002441 F23A 0000                    DW  0   ;DPB_SDIR
002443 F23C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002447 F240                         DS  32
                                
                                ;   D:
                                
002467 F260                         DS  32
                                
                                ;   E:
                                
002487 F280                         DS  32
                                
                                ;   F:
                                
0024A7 F2A0 0000                BANKFL: DW  0   ;DPB_FATLN
0024A9 F2A2 63D6                    DW  BDRD    ;DPB_DRD
0024AB F2A4 5FD6                    DW  BDWT    ;DPB_DWT
0024AD F2A6 F9                      DB  0F9H    ;DPB_FATID
0024AE F2A7 02                      DB  2   ;DPB_SECPCL
0024AF F2A8 0000                BANKCL: DW  0   ;DPB_MAXCL
0024B1 F2AA 00                      DB  0   ;DPB_FDMODE
0024B2 F2AB 08                      DB  8   ;DPB_DIRSCNT
0024B3 F2AC 00                      DB  0   ;DPB_MAXCYL
0024B4 F2AD 01                      DB  1   ;DPB_MAXSEC
0024B5 F2AE 00                      DB  0   ;DPB_FATPS
0024B6 F2AF 02                      DB  2   ;DPB_BPS
0024B7 F2B0 0200                    DW  2   ;DPB_DIRPS
0024B9 F2B2 0B                  BANKDV: DB  00BH    ;DPB_DEVICE
0024BA F2B3 00                      DB  0   ;DPB_UNITNO
0024BB F2B4 0600                    DW  6   ;DPB_ADDCL
0024BD F2B6 0000                    DW  0   ;DPB_16
0024BF F2B8 0000                    DW  0   ;DPB_18
0024C1 F2BA 0000                    DW  0   ;DPB_SDIR
0024C3 F2BC 454D454D                DB  "EMEM"  ;DPB_NAME
                                
                                ;   G:
                                
0024C7 F2C0                         DS  32
                                
                                ;   H:
0024E7 F2E0                         DS  32-8
0024FF F2F8 00                      DB  0
[EOF:88DPB.ASM:UTF_8]
                                
       F2F9                     LAST_ADR:
                                
                                    END
[EOF:88.ASM:UTF_8]
