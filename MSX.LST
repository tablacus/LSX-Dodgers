                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "MSXDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       0003                     MAC EQU 3   ;MSX
       0001                     DEV EQU 1
                                
       001D                     VER_6F  EQU 0001DH
                                
       4000                     RUN EQU 04000H
                                
       C800                     START2  EQU 0C800H
       CB06                     BDOS    EQU 0CB06H
       E600                     WORKAD  EQU 0E600H
       E900                     FATBF   EQU 0E900H
       EF00                     DTBUF   EQU 0EF00H
       0028                     WIDTH   EQU 40
       0018                     LINE    EQU 24
       0000                     COLORF  EQU 0
       0000                     KEYSP_H EQU 0
       0000                     KEYSP_L EQU 0
       0008                     COMS    EQU 8
       0002                     MAX_SEC_SZ_H    EQU 2       ;1セクタ1024バイトのサポート(2:off 4:on)
       8000                     BUFFER  EQU 08000H
       0100                     BUF_COM EQU 00100H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
                                
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       006C                     INITXT  EQU 0006CH
       0078                     SETTXT  EQU 00078H
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00AE                     PINLIN  EQU 000AEH
       00B1                     INLIN   EQU 000B1H
       00B4                     QINLIN  EQU 000B4H
       00B7                     BREAKX  EQU 000B7H
       00C0                     BEEP    EQU 000C0H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0144                     PHYDIO  EQU 00144H  ;MAIN:BIOS:
       0156                     KILBUF  EQU 00156H
                                
       01F5                     REDCLK  EQU 001F5H  ;SUB
       01F9                     WRTCLK  EQU 001F9H  ;SUB
                                
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F398                     JP_IX   EQU 0F398H
       F3AE                     LINL40  EQU 0F3AEH
       F3B0                     LINLEN  EQU 0F3B0H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
                                
       F41F                     KBUF    EQU 0F41FH; 318
                                
       F55E                     BUF EQU 0F55EH
                                
       FAF8                     EXBRSA  EQU 0FAF8H
                                
       FBCA                     FSTPOS  EQU 0FBCAH
                                
       FC9B                     INTFLG  EQU 0FC9BH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCC5                     SLTTBL  EQU 0FCC5H
                                
       FEDA                     H_STKE  EQU 0FEDAH
       FFA7                     H_PHYD  EQU 0FFA7H
                                
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU 06000H
       6800                     BANK1_SEL EQU 06800H
       7000                     BANK2_SEL EQU 07000H
       7800                     BANK3_SEL EQU 07800H
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       8000                     KONAMI_BANK2_SEL EQU 08000H
       A000                     KONAMI_BANK3_SEL EQU 0A000H
                                
       F55D                     SPBUF   EQU KBUF+318
       003B                     ENASUB  EQU 0003BH
[EOF:MSXDEF.ASM:UTF_8]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0002                     VER_3   EQU 2
       1D03                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0103                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0162                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 1942                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
                                    INCLUDE "MSXFDIPL.ASM"
                                ;   LSX-Dodgers FDIPL
                                ;   MSX
000010 4010 186E            12      JR  INIT_FDD_BOOT
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
       4080                     INIT_FDD_BOOT:
000080 4080 F3               4      DI
000081 4081 ED56             8      IM  1
000083 4083 3A42F3          13      LD  A,(RAMAD1)
000086 4086 2640             7      LD  H,040H
000088 4088 CD2400          17      CALL    _ENASLT
00008B 408B 216382          10      LD  HL,AT_START2+04000H
00008E 408E 1100C8          10      LD  DE,START2
000091 4091 010021          10      LD  BC,MSX_E-START2
000094 4094 EDB0                    LDIR
000096 4096 2180E8          10      LD  HL,_DEVICE+4*32     ;E
000099 4099 1100E8          10      LD  DE,_DEVICE      ;A
00009C 409C 018000          10      LD  BC,32*4
00009F 409F EDB0                    LDIR
0000A1 40A1 21DFE8          10      LD  HL,_DEVICE+6*32+DPB_NAME+3
0000A4 40A4 3E07             7      LD  A,7
       40A6                     FDD_INIT1:
0000A6 40A6 C62F             7      ADD A,'0'-1
0000A8 40A8 77               7      LD  (HL),A
0000A9 40A9 11F4FF          10      LD  DE,DPB_UNITNO-(DPB_NAME+3)
0000AC 40AC 19              11      ADD HL,DE
0000AD 40AD D630             7      SUB '0'
0000AF 40AF 77               7      LD  (HL),A
0000B0 40B0 11ECFF          10      LD  DE,-DPB_UNITNO-1
0000B3 40B3 19              11      ADD HL,DE       ;ここでZフラグは変化しない
0000B4 40B4 20F0            12      JR  NZ,FDD_INIT1
0000B6 40B6 218040          10      LD  HL,INIT_FDD_BOOT
                                
0000B9 40B9 CD16C9          17      CALL    SET_BDOS
0000BC 40BC 21F6C8          10      LD  HL,ROMCHECKED
0000BF 40BF 2204C8          16      LD  (INIT_SWC),HL
0000C2 40C2 3EC3             7      LD  A,0C3H      ;JP
0000C4 40C4 3299CB          13      LD  (FDD_BDOS_JP),A
0000C7 40C7 21D5CF          10      LD  HL,BDOS0
0000CA 40CA 229ACB          16      LD  (FDD_BDOS_ADR),HL
0000CD 40CD 2199CB          10      LD  HL,FDD_BDOS_JP
0000D0 40D0 220600          16      LD  (00006H),HL ;BDOS
0000D3 40D3 C300C8          10      JP  START2
[EOF:MSXFDIPL.ASM:UTF_8]
                                    INCLUDE "MSXROM.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MSX
                                
       40D6                     INT38H_ROM:
0000D6 40D6 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
0000D9 40D9 CDE240          17      CALL    ENASLT_00H
0000DC 40DC CD3800          17      CALL    00038H
0000DF 40DF 3A41F3          13      LD  A,(RAMAD0)  ;メインRAMに切り替える
                                ;   JP  ENASLT_00H
                                ;
                                ;ページ0専門のENASLT
                                ;in
                                ;A←スロット
                                ;破壊
                                ;ABCHL
                                ;
                                ; ページ1 に配置
       40E2                     ENASLT_00H:
0000E2 40E2 F3               4      DI
0000E3 40E3 67               4      LD  H,A
0000E4 40E4 E603             7      AND 3
0000E6 40E6 4F               4      LD  C,A
0000E7 40E7 DBA8            11      IN  A,(0A8H)
0000E9 40E9 06FC             7      LD  B,0FCH  ;ページ0
0000EB 40EB A0               4      AND B
0000EC 40EC B1               4      OR  C
0000ED 40ED CB7C             8      BIT 7,H
0000EF 40EF CA37D6          10      JP  Z,ENASLT_NOEXT
                                                ;拡張スロットの処理
0000F2 40F2 D5              11      PUSH    DE
0000F3 40F3 CD1FD6          17      CALL    ENATBL
0000F6 40F6 0F               4      RRCA
0000F7 40F7 0F               4      RRCA
0000F8 40F8 4F               4      LD  C,A
0000F9 40F9 7B               4      LD  A,E
0000FA 40FA CD0041          17      CALL    AT_3B
0000FD 40FD 73               7      LD  (HL),E
0000FE 40FE D1              10      POP DE
0000FF 40FF C9              10      RET
                                ;
                                ;   ENASLOTの補助（ページ0・003BH～にも配置）
                                ;
       4100                     AT_3B:              ;ENASUB 対象の拡張スロットを切り替えるために基本スロットを切り替える
000100 4100 D3A8            11      OUT (0A8H),A
000102 4102 3AFFFF          13      LD  A,(0FFFFH)  ;拡張スロットの切り替え
000105 4105 2F               4      CPL
000106 4106 A0               4      AND B
000107 4107 B1               4      OR  C
000108 4108 32FFFF          13      LD  (0FFFFH),A
00010B 410B 5F               4      LD  E,A
                                                ;基本スロットの切り替え
00010C 410C 7A               4      LD  A,D
00010D 410D D3A8            11      OUT (0A8H),A
00010F 410F C9              10      RET
       4110                     AT_3B_E:
                                
                                
[EOF:MSXROM.ASM:UTF_8]
                                
0001BD 41BD                         ORG 041BDH
0001BD 41BD C9              10      RET
                                
                                    ;MBR_Partition1 (2DDのデータ)
0001BE 41BE 00                      DB  0       ;ブートフラグ
0001BF 41BF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001C2 41C2 01                      DB  1       ;識別子(FAT12)
0001C3 41C3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001C6 41C6 20000000                DW  32,0        ;パーティションの最初のセクタ番号(LBA方式)
0001CA 41CA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
                                    ;MBR_Partition2 (2DDのデータ)
0001CE 41CE 00                      DB  0       ;ブートフラグ
0001CF 41CF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001D2 41D2 01                      DB  1       ;識別子(FAT12)
0001D3 41D3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001D6 41D6 C0050000                DW  32+1440,0   ;パーティションの最初のセクタ番号(LBA方式)
0001DA 41DA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
0001FE 41FE                         ORG 041FEH
0001FE 41FE 55AA                    DB  055H,0AAH   ;MBR_Sig
                                
                                    INCLUDE "MSXINIT.ASM"
                                ;   LSX-Dodgers INIT
                                ;   MSX
       4200                     START:
000200 4200 F3               4      DI
000201 4201 ED56             8      IM  1
000203 4203 AF               4      XOR A               ;A=0
000204 4204 320060          13      LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
000207 4207 3C               4      INC A               ;A=1
000208 4208 320068          13      LD  (BANK1_SEL),A
00020B 420B 216342          10      LD  HL,AT_START2
00020E 420E 1100C8          10      LD  DE,START2
000211 4211 010021          10      LD  BC,MSX_E-START2
000214 4214 EDB0                    LDIR
000216 4216 C300C8          10      JP  START2
                                
       4219                     INIT_ROM:
000219 4219 3E                      DB  03EH    ;LD A,??
00021A 421A F7              12      RST 30H
00021B 421B F3               4      DI
00021C 421C 32DAFE          13      LD  (H_STKE),A
00021F 421F 2640             7      LD  H,040H
000221 4221 CD894F          17      CALL    AT_GETSLT
000224 4224 21DBFE          10      LD  HL,H_STKE+1
000227 4227 77               7      LD  (HL),A
000228 4228 110042          10      LD  DE,START
00022B 422B 23               6      INC HL
00022C 422C 73               7      LD  (HL),E
00022D 422D 23               6      INC HL
00022E 422E 72               7      LD  (HL),D
                                
00022F 422F CD3801          17      CALL    RSLREG      ;read primary slot #
000232 4232 07               4      RLCA
000233 4233 07               4      RLCA
000234 4234 26C0             7      LD  H,0C0H
000236 4236 CD894F          17      CALL    AT_GETSLT
000239 4239 3A42F3          13      LD  A,(RAMAD1)
00023C 423C CD5542          17      CALL    FIXRAMAD
00023F 423F 3242F3          13      LD  (RAMAD1),A
000242 4242 3A41F3          13      LD  A,(RAMAD0)
000245 4245 CD5542          17      CALL    FIXRAMAD
000248 4248 3241F3          13      LD  (RAMAD0),A
00024B 424B 2680             7      LD  H,080H
00024D 424D CD894F          17      CALL    AT_GETSLT
000250 4250 3243F3          13      LD  (RAMAD2),A
                                
000253 4253 FB               4      EI
000254 4254 C9              10      RET
                                
       4255                     FIXRAMAD:
000255 4255 B7               4      OR  A
000256 4256 2807            12      JR  Z,FIXRAMAD1
000258 4258 FEC9             7      CP  0C9H
00025A 425A 2803            12      JR  Z,FIXRAMAD1
00025C 425C FEFF             7      CP  0FFH
00025E 425E C0              11      RET NZ
       425F                     FIXRAMAD1:
00025F 425F 3A44F3          13      LD  A,(RAMAD3)
000262 4262 C9              10      RET
                                
       4263                     AT_START2:
000263 C800                         ORG START2,AT_START2-RUN
                                
000263 C800 3100C8          10      LD  SP,START2
000266 C803 CD11C8          17      CALL    INIT        ;NZならAUTOEXECを実行
       C804                     INIT_SWC    EQU $-2
000269 C806 210000          10      LD  HL,0
00026C C809 E5              11      PUSH    HL
00026D C80A C8              11      RET Z
00026E C80B 111ECA          10      LD  DE,AUTOD
000271 C80E C3FDE6          10      JP  _COMANL
                                
       C811                     INIT:
000274 C811 DD21900D        14      LD  IX,0D90H
000278 C815 0600             7      LD  B,0
       C817                     CHECK_CBIOS1:
00027A C817 DD7E00          19      LD  A,(IX+0)
00027D C81A FE43             7      CP  'C'
00027F C81C 202B            12      JR  NZ,CHECK_CBIOS2
000281 C81E DD7E01          19      LD  A,(IX+1)
000284 C821 FE2D             7      CP  '-'
000286 C823 2024            12      JR  NZ,CHECK_CBIOS2
000288 C825 DD7E02          19      LD  A,(IX+2)
00028B C828 FE42             7      CP  'B'
00028D C82A 201D            12      JR  NZ,CHECK_CBIOS2
00028F C82C DD7E03          19      LD  A,(IX+3)
000292 C82F FE49             7      CP  'I'
000294 C831 2016            12      JR  NZ,CHECK_CBIOS2
000296 C833 DD7E04          19      LD  A,(IX+4)
000299 C836 FE4F             7      CP  'O'
00029B C838 200F            12      JR  NZ,CHECK_CBIOS2
00029D C83A DD7E05          19      LD  A,(IX+5)
0002A0 C83D EE53             7      XOR 'S'
0002A2 C83F 2008            12      JR  NZ,CHECK_CBIOS2
                                
0002A4 C841 3225D3          13      LD  (CBIOS_SWC1),A
0002A7 C844 3249D3          13      LD  (CBIOS_SWC2),A
                                
0002AA C847 1804            12      JR  CHECK_CBIOS3
       C849                     CHECK_CBIOS2:
0002AC C849 DD23            10      INC IX
0002AE C84B 10CA            13      DJNZ    CHECK_CBIOS1
       C84D                     CHECK_CBIOS3:
0002B0 C84D 3ADBFE          13      LD  A,(H_STKE+1)
0002B3 C850 3262E6          13      LD  (ROM_SLT),A
                                
0002B6 C853 26C0             7      LD  H,0C0H
0002B8 C855 CD894F          17      CALL    AT_GETSLT
0002BB C858 3244F3          13      LD  (RAMAD3),A
0002BE C85B 2680             7      LD  H,080H
0002C0 C85D CD894F          17      CALL    AT_GETSLT
0002C3 C860 CD82C9          17      CALL    CHK_RAM
0002C6 C863 3243F3          13      LD  (RAMAD2),A
       C866                     RAMCHK2:
0002C9 C866 3A44F3          13      LD  A,(RAMAD3)
0002CC C869 2640             7      LD  H,040H
0002CE C86B CD82C9          17      CALL    CHK_RAM
0002D1 C86E 3242F3          13      LD  (RAMAD1),A
       C871                     RAMCHK1:
0002D4 C871 3A44F3          13      LD  A,(RAMAD3)
0002D7 C874 2600             7      LD  H,00H
0002D9 C876 CD82C9          17      CALL    CHK_RAM
0002DC C879 3241F3          13      LD  (RAMAD0),A
       C87C                     RAMCHK0:
0002DF C87C 3A41F3          13      LD  A,(RAMAD0)
0002E2 C87F CDE240          17      CALL    ENASLT_00H
                                
0002E5 C882 210000          10      LD  HL,0
0002E8 C885 065C             7      LD  B,05CH
0002EA C887 3E                      DB  03EH    ;LD A,??
0002EB C888 EF              12      RST 28H
0002EC C889 CDC5D7          17      CALL    FILL_MEMORY
0002EF C88C 06A4             7      LD  B,0A4H
0002F1 C88E AF               4      XOR A
0002F2 C88F 320400          13      LD  (_DVSW),A
0002F5 C892 CDC5D7          17      CALL    FILL_MEMORY
                                
0002F8 C895 CD16C9          17      CALL    SET_BDOS
0002FB C898 CD3EC9          17      CALL    SET_ISC
                                
0002FE C89B 3A42F3          13      LD  A,(RAMAD1)
000301 C89E CD3AD6          17      CALL    ENASLT_40H
                                                ;MSXワークエリア
000304 C8A1 3E03             7      LD  A,3
000306 C8A3 329BFC          13      LD  (INTFLG),A
                                                ;ROMタイプ判別(ASCII-8K/ASCII-16K)
000309 C8A6 1E00             7      LD  E,0
00030B C8A8 3A62E6          13      LD  A,(ROM_SLT)
00030E C8AB 210068          10      LD  HL,BANK1_SEL
000311 C8AE CD1400          17      CALL    _WRSLT
                                
000314 C8B1 210060          10      LD  HL,06000H
000317 C8B4 3A62E6          13      LD  A,(ROM_SLT)
00031A C8B7 CD0C00          17      CALL    _RDSLT
00031D C8BA FE41             7      CP  'A'
00031F C8BC 280F            12      JR  Z,ROM8K
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K)
000321 C8BE 3E                      DB  03EH    ;LD A,??
000322 C8BF 00               4      NOP
000323 C8C0 322ECB          13      LD  (ASCII16K1),A
000326 C8C3 3232CB          13      LD  (ASCII16K2),A
000329 C8C6 3E3F             7      LD  A,03FH
00032B C8C8 3248CB          13      LD  (ASCII16K3),A
00032E C8CB 1829            12      JR  ROMCHECKED
       C8CD                     ROM8K:              ;Konami-8Kチェック
000330 C8CD 1E01             7      LD  E,1
000332 C8CF 3A62E6          13      LD  A,(ROM_SLT)
000335 C8D2 210070          10      LD  HL,BANK2_SEL
000338 C8D5 CD1400          17      CALL    _WRSLT
                                
00033B C8D8 1E00             7      LD  E,0
00033D C8DA 3A62E6          13      LD  A,(ROM_SLT)
000340 C8DD 210080          10      LD  HL,KONAMI_BANK2_SEL
000343 C8E0 CD1400          17      CALL    _WRSLT
                                
000346 C8E3 210080          10      LD  HL,08000H
000349 C8E6 3A62E6          13      LD  A,(ROM_SLT)
00034C C8E9 CD0C00          17      CALL    _RDSLT
00034F C8EC FE41             7      CP  'A'
000351 C8EE 2006            12      JR  NZ,ROMCHECKED
                                                ;Konami-8K
000353 C8F0 210080          10      LD  HL,KONAMI_BANK2_SEL
000356 C8F3 2239CB          16      LD  (ROM8000H),HL
       C8F6                     ROMCHECKED:
                                
000359 C8F6 3E28             7      LD  A,40
00035B C8F8 32AEF3          13      LD  (LINL40),A
00035E C8FB 32B1E6          13      LD  (_WIDTH),A
000361 C8FE DD216C00        14      LD  IX,INITXT
000365 C902 CD1AD5          17      CALL    CALSLT_R
000368 C905 DD217800        14      LD  IX,SETTXT
00036C C909 CD1AD5          17      CALL    CALSLT_R
                                
00036F C90C 212ACA          10      LD  HL,INIMES
000372 C90F CD14D0          17      CALL    MSX
       C912                     INIT1:
000375 C912 AF               4      XOR A
000376 C913 FE03             7      CP  3
000378 C915 C9              10      RET
                                
       C916                     SET_BDOS:
000379 C916 3E                      DB  03EH    ;LD A,??
00037A C917 E9               4      JP  (HL)
00037B C918 320F00          13      LD  (0000FH),A
                                
00037E C91B 3EC3             7      LD  A,0C3H      ;JP
000380 C91D 2103E6          10      LD  HL,CPM_WBOOT
000383 C920 320000          13      LD  (00000H),A
000386 C923 220100          16      LD  (00001H),HL ;IPL
                                
000389 C926 2106CB          10      LD  HL,BDOS
00038C C929 320500          13      LD  (00005H),A
00038F C92C 220600          16      LD  (00006H),HL ;BDOS
                                
000392 C92F 210000          10      LD  HL,0
000395 C932 322800          13      LD  (00028H),A
000398 C935 222900          16      LD  (00029H),HL ;BDOS
                                
                                                ;LSX-Dodgers
00039B C938 3EE6             7      LD  A,CPM_BOOT/256
00039D C93A 320B00          13      LD  (0000BH),A
0003A0 C93D C9              10      RET
                                
       C93E                     SET_ISC:                ;インタースロットコール
0003A1 C93E 3EC3             7      LD  A,0C3H      ;JP
0003A3 C940 21B5D6          10      LD  HL,RDSLT
0003A6 C943 320C00          13      LD  (_RDSLT),A
0003A9 C946 220D00          16      LD  (_RDSLT+1),HL
                                
0003AC C949 21D3D6          10      LD  HL,WRSLT
0003AF C94C 321400          13      LD  (_WRSLT),A
0003B2 C94F 221500          16      LD  (_WRSLT+1),HL
                                
0003B5 C952 2167D6          10      LD  HL,CALSLT
0003B8 C955 321C00          13      LD  (_CALSLT),A
0003BB C958 221D00          16      LD  (_CALSLT+1),HL
                                
0003BE C95B 21BFD5          10      LD  HL,ENASLT
0003C1 C95E 322400          13      LD  (_ENASLT),A
0003C4 C961 222500          16      LD  (_ENASLT+1),HL
                                
0003C7 C964 2157D6          10      LD  HL,CALLF
0003CA C967 323000          13      LD  (_CALLF),A
0003CD C96A 223100          16      LD  (_CALLF+1),HL
                                
0003D0 C96D 21EFD6          10      LD  HL,INT38H
0003D3 C970 323800          13      LD  (00038H),A
0003D6 C973 223900          16      LD  (00038H+1),HL
                                
0003D9 C976 210041          10      LD  HL,AT_3B
0003DC C979 113B00          10      LD  DE,ENASUB
0003DF C97C 011000          10      LD  BC,AT_3B_E-AT_3B
0003E2 C97F EDB0                    LDIR
0003E4 C981 C9              10      RET
       C982                     CHK_RAM:
0003E5 C982 E5              11      PUSH    HL
0003E6 C983 CDD7C9          17      CALL    CHK_RAM0
0003E9 C986 E1              10      POP HL
0003EA C987 C8              11      RET Z
0003EB C988 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
0003EE C98B E680             7      AND 080H
0003F0 C98D CDAEC9          17      CALL    CHK_RAM_SLT
0003F3 C990 C8              11      RET Z
0003F4 C991 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
0003F7 C994 E680             7      AND 080H
0003F9 C996 C601             7      ADD A,1
0003FB C998 CDAEC9          17      CALL    CHK_RAM_SLT
0003FE C99B C8              11      RET Z
0003FF C99C 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000402 C99F E680             7      AND 080H
000404 C9A1 C602             7      ADD A,2
000406 C9A3 CDAEC9          17      CALL    CHK_RAM_SLT
000409 C9A6 C8              11      RET Z
00040A C9A7 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
00040D C9AA E680             7      AND 080H
00040F C9AC C603             7      ADD A,3
       C9AE                     CHK_RAM_SLT:
000411 C9AE E5              11      PUSH    HL
000412 C9AF CDD7C9          17      CALL    CHK_RAM0        ;スロット#X or X-0
000415 C9B2 E1              10      POP HL
000416 C9B3 C8              11      RET Z
000417 C9B4 CB79             8      BIT 7,C
000419 C9B6 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
00041B C9B8 79               4      LD  A,C
00041C C9B9 C604             7      ADD A,4*1           ;スロット#X-1
00041E C9BB E5              11      PUSH    HL
00041F C9BC CDD7C9          17      CALL    CHK_RAM0
000422 C9BF E1              10      POP HL
000423 C9C0 C8              11      RET Z
000424 C9C1 79               4      LD  A,C
000425 C9C2 C608             7      ADD A,4*2           ;スロット#X-2
000427 C9C4 E5              11      PUSH    HL
000428 C9C5 CDD7C9          17      CALL    CHK_RAM0
00042B C9C8 E1              10      POP HL
00042C C9C9 C8              11      RET Z
00042D C9CA 79               4      LD  A,C
00042E C9CB C60C             7      ADD A,4*3           ;スロット#X-3
000430 C9CD E5              11      PUSH    HL
000431 C9CE CDD7C9          17      CALL    CHK_RAM0
000434 C9D1 E1              10      POP HL
       C9D2                     CHK_RAM_E:
000435 C9D2 AF               4      XOR A
000436 C9D3 3C               4      INC A           ;ZF=0にする
000437 C9D4 3E00             7      LD  A,0
000439 C9D6 C9              10      RET
                                
       C9D7                     CHK_RAM0:
00043A C9D7 4F               4      LD  C,A
00043B C9D8 3A62E6          13      LD  A,(ROM_SLT)
00043E C9DB B9               4      CP  C
00043F C9DC 28F4            12      JR  Z,CHK_RAM_E
000441 C9DE 2E00             7      LD  L,0
       C9E0                     CHK_RAM1:
000443 C9E0 79               4      LD  A,C
000444 C9E1 DD210C00        14      LD  IX,_RDSLT
000448 C9E5 CD12CA          17      CALL    CALSLT_RAM
00044B C9E8 C6E5             7      ADD A,0E5H
00044D C9EA 47               4      LD  B,A
00044E C9EB 5F               4      LD  E,A
00044F C9EC 79               4      LD  A,C
000450 C9ED DD211400        14      LD  IX,_WRSLT
000454 C9F1 CD12CA          17      CALL    CALSLT_RAM
000457 C9F4 79               4      LD  A,C
000458 C9F5 DD210C00        14      LD  IX,_RDSLT
00045C C9F9 CD12CA          17      CALL    CALSLT_RAM
00045F C9FC B8               4      CP  B
000460 C9FD C0              11      RET NZ
000461 C9FE D6E5             7      SUB 0E5H
000463 CA00 79               4      LD  A,C
000464 CA01 5F               4      LD  E,A
000465 CA02 DD211400        14      LD  IX,_WRSLT
000469 CA06 CD12CA          17      CALL    CALSLT_RAM
00046C CA09 24               4      INC H
00046D CA0A 7D               4      LD  A,L
00046E CA0B C604             7      ADD A,4
000470 CA0D 6F               4      LD  L,A
000471 CA0E 20D0            12      JR  NZ,CHK_RAM1
000473 CA10 79               4      LD  A,C     ;ZF=1のハズ
000474 CA11 C9              10      RET
                                
       CA12                     CALSLT_RAM:
000475 CA12 C5              11      PUSH    BC
000476 CA13 E5              11      PUSH    HL
000477 CA14 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00047B CA18 CD1C00          17      CALL    _CALSLT
00047E CA1B E1              10      POP HL
00047F CA1C C1              10      POP BC
000480 CA1D C9              10      RET
                                
000481 CA1E 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
00048A CA27 413A00              AUTODV: DB  "A:",0
                                
00048D CA2A 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MSX v"
            6765727320666F72    
            204D53582076        
0004A3 CA40 312E                    DB  030H + VER_1, '.'
0004A5 CA42 3632                    DB  030H + VER_2 ,030H + VER_3
0004A7 CA44 62                      DB  'b'
0004A8 CA45 2047616B750D0A          DB  " Gaku",0DH,0AH
0004AF CA4C 00                      DB  0
                                
0004B0 CA4D 0300                M2DD:   DW  3
0004B2 CA4F F902                    DB  0F9H,2
0004B4 CA51 CB02                    DW  715
0004B6 CA53 FF0750090182            DB  0FFH,7,80,9,1,082H
0004BC CA59 0700A7000A00            DW  7,0A7H,10
       CA5F                     M2DDE:
                                
       CA5F                     INITE:
0004C2 CA5F                         DS  BDOS-INITE
000569 CB06 C3D5CF          10      JP  BDOS0
[EOF:MSXINIT.ASM:SHIFT_JIS]
                                    INCLUDE "MSXDISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MSX
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       CB09                     FDRD:
00056C CB09 ED7398CB        20      LD  (DRDSP),SP
000570 CB0D 3A99CB          13      LD  A,(DRDSPH)  ;スタックがカートリッジと被っていないかチェック
000573 CB10 FE7F             7      CP  07FH
000575 CB12 3809            12      JR  C,FDRD1
000577 CB14 FEC1             7      CP  0C1H
000579 CB16 3005            12      JR  NC,FDRD1
00057B CB18 3E00             7      LD  A,0     ;BDOS0+13Hが外部から書き換えされても動くようにする
00057D CB1A 315DF5          10      LD  SP,SPBUF
       CB1D                     FDRD1:
000580 CB1D C5              11      PUSH    BC
000581 CB1E D5              11      PUSH    DE
                                
000582 CB1F E5              11      PUSH    HL
000583 CB20 EB               4      EX  DE,HL
000584 CB21 DD460F          19      LD  B,(IX+DPB_BPS)
       CB24                     EADR1:
000587 CB24 CB18             8      RR  B
000589 CB26 3803            12      JR  C,EADR2
00058B CB28 29              11      ADD HL,HL
00058C CB29 18F9            12      JR  EADR1
       CB2B                     EADR2:
00058E CB2B E5              11      PUSH    HL  ;あとでDEで受け取る
00058F CB2C 29              11      ADD HL,HL   ;64KB→32KB
000590 CB2D 29              11      ADD HL,HL   ;32KB→16KB
       CB2E                     ASCII16K1:
000591 CB2E 29              11      ADD HL,HL   ;16KB→8KB  ;ASCII-16Kの場合はここがNOPに置き換えられる
                                
000592 CB2F DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;16KB単位でカートリッジ内のディスクが存在する位置を指定
       CB32                     ASCII16K2:
000595 CB32 87               4      ADD A,A         ;ASCII-16Kの場合はここがNOPに置き換えられる
000596 CB33 84               4      ADD A,H
000597 CB34 5F               4      LD  E,A
000598 CB35 3A62E6          13      LD  A,(ROM_SLT)
00059B CB38 210070          10      LD  HL,BANK2_SEL
       CB39                     ROM8000H    EQU $-2
00059E CB3B CD1400          17      CALL    _WRSLT
                                
0005A1 CB3E 3A62E6          13      LD  A,(ROM_SLT) ;カートリッジROMに切り替える
0005A4 CB41 CD9DD5          17      CALL    ENASLT_80H
                                
0005A7 CB44 D1              10      POP DE
0005A8 CB45 E1              10      POP HL      ;HLは読み出し先のメモリアドレス
                                
0005A9 CB46 7B               4      LD  A,E
0005AA CB47 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F/16K:3F)
       CB48                     ASCII16K3   EQU $-1
0005AC CB49 1E00             7      LD  E,0     ;DEはROMディスクから読み出すアドレス
0005AE CB4B C680             7      ADD A,080H
0005B0 CB4D 57               4      LD  D,A
                                
0005B1 CB4E 3E                      DB  03EH
0005B2 CB4F A7               4      AND A
0005B3 CB50 327BCB          13      LD  (DRD_SWC3),A
0005B6 CB53 7C               4      LD  A,H     ;読み出し先がカートリッジと被っていないかチェック
0005B7 CB54 FE7B             7      CP  07BH
0005B9 CB56 3812            12      JR  C,DRD2
0005BB CB58 FEC1             7      CP  0C1H
0005BD CB5A 300E            12      JR  NC,DRD2
0005BF CB5C 2282CB          16      LD  (DRD_SWC1),HL   ;被っている場合はデータバッファをフラッシュして一時的に使う
0005C2 CB5F 2A7EE7          16      LD  HL,(_DTBUF)
0005C5 CB62 3E                      DB  03EH
0005C6 CB63 37               4      SCF
0005C7 CB64 327BCB          13      LD  (DRD_SWC3),A
0005CA CB67 CD60E4          17      CALL    FFLUSHBUF
       CB6A                     DRD2:
0005CD CB6A DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
0005D0 CB6D E607             7      AND 7
0005D2 CB6F 47               4      LD  B,A
0005D3 CB70 4B               4      LD  C,E ;E=0
                                
0005D4 CB71 EB               4      EX  DE,HL
0005D5 CB72 EDB0                    LDIR
0005D7 CB74 D5              11      PUSH    DE
0005D8 CB75 3A43F3          13      LD  A,(RAMAD2)
0005DB CB78 CD9DD5          17      CALL    ENASLT_80H
       CB7B                     DRD_SWC3:
0005DE CB7B A7               4      AND A       ;自己書き換え)被っている場合はSCFになる
0005DF CB7C 3012            12      JR  NC,DRD3
                                
0005E1 CB7E 2A7EE7          16      LD  HL,(_DTBUF)
0005E4 CB81 110000          10      LD  DE,0
       CB82                     DRD_SWC1    EQU $-2
0005E7 CB84 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
0005EA CB87 E607             7      AND 7
0005EC CB89 47               4      LD  B,A
0005ED CB8A 0E00             7      LD  C,0
0005EF CB8C EDB0                    LDIR
0005F1 CB8E E1              10      POP HL
0005F2 CB8F D5              11      PUSH    DE
       CB90                     DRD3:
0005F3 CB90 E1              10      POP HL
0005F4 CB91 D1              10      POP DE
0005F5 CB92 13               6      INC DE
0005F6 CB93 C1              10      POP BC
0005F7 CB94 1087            13      DJNZ    FDRD1
0005F9 CB96 AF               4      XOR A
0005FA CB97 310000          10      LD  SP,0
       CB98                     DRDSP   EQU $-2
       CB99                     DRDSPH  EQU $-1
0005FD CB9A FB               4      EI
0005FE CB9B C9              10      RET
                                
       CB99                     FDD_BDOS_JP EQU $-3
       CB9A                     FDD_BDOS_ADR    EQU $-2
[EOF:MSXDISK.ASM:UTF_8]
                                    INCLUDE "MSXCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MSX
                                
       CB9C                     S27BUF_COM:
0005FF CB9C 110001          10      LD  DE,BUF_COM
000602 CB9F CDD8D1          17      CALL    _SYS1A      ;(BDOS)DTAの設定
000605 CBA2 2100FE          10      LD  HL,0-BUF_COM-00100H ;バッファー+スタック予備(0100H)
000608 CBA5 C37ACC          10      JP  S27BUF2
       CBA8                     WBOOT1:
00060B CBA8 3E03             7      LD  A,3
00060D CBAA 2A0600          16      LD  HL,(SYSTEM+1)   ;必ずBDOS0+13Hが「0」になるようにする ※ここはFDD起動時
000610 CBAD F9               6      LD  SP,HL
000611 CBAE CDA7D2          17      CALL    MSG_A
       CBB1                     WBOOT2:
[EOF:MSXCCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       CBB1                     COMMAND:
000614 CBB1 3A58E5          13      LD  A,(FCB_BAT)
000617 CBB4 B7               4      OR  A
000618 CBB5 C2F3CC          10      JP  NZ,C_BAT1
00061B CBB8 CD67CC          17      CALL    SETDTA1
00061E CBBB 3A0400          13      LD  A,(_DVSW)
000621 CBBE C641             7      ADD A,'A'
000623 CBC0 CDA7D2          17      CALL    MSG_A
000626 CBC3 3E3E             7      LD  A,'>'
000628 CBC5 CDA7D2          17      CALL    MSG_A
00062B CBC8 3E50             7      LD  A,80
00062D CBCA 12               7      LD  (DE),A
00062E CBCB CD67D3          17      CALL    _SYS0A      ;(BDOS)文字列入力
000631 CBCE CDE8CD          17      CALL    LTNL
       CBD1                     COMMAND2:
000634 CBD1 118200          10      LD  DE,DTA1+2
000637 CBD4 CDFDE6          17      CALL    _COMANL
00063A CBD7 DC98D2          17      CALL    C,SHOW_ERROR
00063D CBDA 18D5            12      JR  COMMAND
                                
       CBDC                     COMANL:
00063F CBDC CD1AD7          17      CALL    FILE
000642 CBDF 3A19E6          13      LD  A,(FNAME+4)
000645 CBE2 FE20             7      CP  020H
000647 CBE4 201C            12      JR  NZ,COMB2
000649 CBE6 D5              11      PUSH    DE
00064A CBE7 1115E6          10      LD  DE,FNAME
00064D CBEA 1A               7      LD  A,(DE)
00064E CBEB FE20             7      CP  020H
000650 CBED 2844            12      JR  Z,SDVSW
000652 CBEF 1B               6      DEC DE
000653 CBF0 1A               7      LD  A,(DE)
000654 CBF1 C6FF             7      ADD A,0FFH
000656 CBF3 3809            12      JR  C,COMB
000658 CBF5 13               6      INC DE
                                
000659 CBF6 21A5CF          10      LD  HL,COMTB
00065C CBF9 0608             7      LD  B,COMS
00065E CBFB CDA7D9          17      CALL    CPNAME
       CBFE                     COMB:
000661 CBFE D1              10      POP DE
000662 CBFF D297D2          10      JP  NC,JPHL
       CC02                     COMB2:
000665 CC02 EB               4      EX  DE,HL
000666 CC03 22D0CC          16      LD  (COMSWC),HL
000669 CC06 F5              11      PUSH    AF
00066A CC07 CD88CC          17      CALL    CEXE4
00066D CC0A F1              10      POP AF
00066E CC0B 2115E6          10      LD  HL,FNAME
000671 CC0E 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
000674 CC11 010B00          10      LD  BC,11
000677 CC14 EDB0                    LDIR
000679 CC16 11F7E4          10      LD  DE,PATHD
       CC19                     CEX1:
00067C CC19 1A               7      LD  A,(DE)
00067D CC1A FE20             7      CP  020H
00067F CC1C D8              11      RET C
000680 CC1D CD0FD7          17      CALL    FILEC
000683 CC20 D5              11      PUSH    DE
000684 CC21 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
000687 CC24 1115E6          10      LD  DE,FNAME
00068A CC27 010B00          10      LD  BC,11
00068D CC2A EDB0                    LDIR
00068F CC2C CD88CC          17      CALL    CEXE4
000692 CC2F D1              10      POP DE
000693 CC30 13               6      INC DE
000694 CC31 18E6            12      JR  CEX1
                                
       CC33                     SDVSW:
000696 CC33 F1              10      POP AF
000697 CC34 3A14E6          13      LD  A,(FDRV)
00069A CC37 3D               4      DEC A
00069B CC38 5F               4      LD  E,A
00069C CC39 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
00069E CC3B 1831            12      JR  SYSTEM0
                                
       CC3D                     OPEN1:
0006A0 CC3D 2114E6          10      LD  HL,FDRV
       CC40                     OPEN:
0006A3 CC40 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       CC42                     OPEN3:
0006A5 CC42 D5              11      PUSH    DE
0006A6 CC43 1133E5          10      LD  DE,DTA_CCP
0006A9 CC46 CD64CC          17      CALL    SETDTA
0006AC CC49 EB               4      EX  DE,HL
0006AD CC4A CD6ECC          17      CALL    SYSTEM0
0006B0 CC4D D1              10      POP DE
0006B1 CC4E C9              10      RET
                                
       CC4F                     OPEN2:
0006B2 CC4F 0E12             7      LD  C,012H
0006B4 CC51 18EF            12      JR  OPEN3
                                
       CC53                     DEFCB:              ;Z=Ok NZ=Error
0006B6 CC53 1133E5          10      LD  DE,DTA_CCP
0006B9 CC56 CD6CCC          17      CALL    SYSC0F
                                
0006BC CC59 1154E5          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0006BF CC5C 0604             7      LD  B,4
0006C1 CC5E CDB9CE          17      CALL    ZERO_MEMORY_DE
       CC61                     SETDTA100:
0006C4 CC61 110080          10      LD  DE,BUFFER
       CC64                     SETDTA:
0006C7 CC64 C3D8D1          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       CC67                     SETDTA1:
0006CA CC67 118000          10      LD  DE,DTA1
0006CD CC6A 18F8            12      JR  SETDTA
                                
       CC6C                     SYSC0F:
0006CF CC6C 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       CC6E                     SYSTEM0:
0006D1 CC6E CD0500          17      CALL    SYSTEM
0006D4 CC71 B7               4      OR  A
0006D5 CC72 C9              10      RET
                                
       CC73                     C_CD:
0006D6 CC73 0E5A             7      LD  C,05AH
0006D8 CC75 18F7            12      JR  SYSTEM0
                                
       CC77                     S27BUF:
0006DA CC77 21007F          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       CC7A                     S27BUF2:
0006DD CC7A 39              11      ADD HL,SP
0006DE CC7B 2E00             7      LD  L,0
0006E0 CC7D 7C               4      LD  A,H
0006E1 CC7E E6F8             7      AND 0F8H
0006E3 CC80 67               4      LD  H,A
       CC81                     S27DTA:
0006E4 CC81 1133E5          10      LD  DE,DTA_CCP
       CC84                     S27:
0006E7 CC84 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
0006E9 CC86 18E6            12      JR  SYSTEM0
                                
       CC88                     CEXE4:
0006EB CC88 211DE6          10      LD  HL,FNAME+8
0006EE CC8B 7E               7      LD  A,(HL)
0006EF CC8C FE20             7      CP  020H
0006F1 CC8E 2007            12      JR  NZ,CEXE7
0006F3 CC90 3E3F             7      LD  A,'?'
0006F5 CC92 77               7      LD  (HL),A
0006F6 CC93 23               6      INC HL
0006F7 CC94 77               7      LD  (HL),A
0006F8 CC95 23               6      INC HL
0006F9 CC96 77               7      LD  (HL),A
       CC97                     CEXE7:
0006FA CC97 CD3DCC          17      CALL    OPEN1
       CC9A                     CEXE5:
0006FD CC9A C0              11      RET NZ
0006FE CC9B 2A3DE5          16      LD  HL,(DTA_CCP+1+9)
000701 CC9E 7C               4      LD  A,H
000702 CC9F CD36DA          17      CALL    CAP
000705 CCA2 67               4      LD  H,A
000706 CCA3 7D               4      LD  A,L
000707 CCA4 CD36DA          17      CALL    CAP
00070A CCA7 6F               4      LD  L,A
00070B CCA8 3A3CE5          13      LD  A,(DTA_CCP+1+8)
00070E CCAB CD36DA          17      CALL    CAP
000711 CCAE D642             7      SUB 'B'
000713 CCB0 282C            12      JR  Z,C_BAT
000715 CCB2 3D               4      DEC A       ;'C'
000716 CCB3 2805            12      JR  Z,C_EXE
       CCB5                     CEXE6:
000718 CCB5 CD4FCC          17      CALL    OPEN2
00071B CCB8 18E0            12      JR  CEXE5
                                
       CCBA                     C_EXE:
00071D CCBA 7C               4      LD  A,H
00071E CCBB FE4D             7      CP  'M'
000720 CCBD 20F6            12      JR  NZ,CEXE6
                                
000722 CCBF CD53CC          17      CALL    DEFCB
000725 CCC2 CD9CCB          17      CALL    S27BUF_COM
000728 CCC5 3D               4      DEC A
000729 CCC6 37               4      SCF
00072A CCC7 C0              11      RET NZ
00072B CCC8 7C               4      LD  A,H
00072C CCC9 B5               4      OR  L
00072D CCCA 37               4      SCF
00072E CCCB C8              11      RET Z
00072F CCCC CD67CC          17      CALL    SETDTA1
000732 CCCF 110000          10      LD  DE,0                ; self-modifying code
       CCD0                     COMSWC  EQU $-2
000735 CCD2 ED7B0600        20      LD  SP,(SYSTEM+1)
000739 CCD6 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
00073A CCD7 6F               4      LD  L,A
00073B CCD8 E5              11      PUSH    HL              ; push $0000 (reboot address)
00073C CCD9 24               4      INC H
00073D CCDA E5              11      PUSH    HL              ; push $0100 (TPA address)
00073E CCDB C384CE          10      JP  SETFCB              ; and JP $0100
                                
       CCDE                     C_BAT:
000741 CCDE 114154          10      LD  DE,'A'+'T'*256
000744 CCE1 ED52            15      SBC HL,DE
000746 CCE3 20D0            12      JR  NZ,CEXE6
                                
000748 CCE5 CD53CC          17      CALL    DEFCB
                                
00074B CCE8 2133E5          10      LD  HL,DTA_CCP
00074E CCEB 1158E5          10      LD  DE,FCB_BAT
000751 CCEE 012500          10      LD  BC,37
000754 CCF1 EDB0                    LDIR
       CCF3                     C_BAT1:
000756 CCF3 CD61CC          17      CALL    SETDTA100
000759 CCF6 CD2ACD          17      CALL    FGETC_BAT
00075C CCF9 218100          10      LD  HL,DTA1+1
00075F CCFC 2025            12      JR  NZ,END_BATCH
000761 CCFE FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
000763 CD00 38F1            12      JR  C,C_BAT1
000765 CD02 3620            10      LD  (HL),' '
000767 CD04 23               6      INC HL
       CD05                     C_BAT2:
000768 CD05 77               7      LD  (HL),A
000769 CD06 23               6      INC HL
00076A CD07 7D               4      LD  A,L
00076B CD08 3C               4      INC A       ;L==0FFH
00076C CD09 2809            12      JR  Z,RUN_BATCH
00076E CD0B CD2ACD          17      CALL    FGETC_BAT
000771 CD0E 2004            12      JR  NZ,RUN_BATCH
000773 CD10 FE20             7      CP  020H
000775 CD12 30F1            12      JR  NC,C_BAT2
       CD14                     RUN_BATCH:
000777 CD14 7D               4      LD  A,L
000778 CD15 D67F             7      SUB DTA1-1
00077A CD17 328000          13      LD  (DTA1),A
00077D CD1A FE04             7      CP  4
00077F CD1C 3805            12      JR  C,END_BATCH
000781 CD1E 3600            10      LD  (HL),0
000783 CD20 C3D1CB          10      JP  COMMAND2
       CD23                     END_BATCH:
000786 CD23 AF               4      XOR A       ;バッチファイルを閉じる
000787 CD24 3258E5          13      LD  (FCB_BAT),A
00078A CD27 C300E6          10      JP  CPM_BOOT
                                
       CD2A                     FGETC_BAT:
00078D CD2A 1158E5          10      LD  DE,FCB_BAT
       CD2D                     FGETC:              ;1文字ずつ読み込む
000790 CD2D E5              11      PUSH    HL      ;Z:成功
000791 CD2E 210100          10      LD  HL,1
000794 CD31 CD84CC          17      CALL    S27
000797 CD34 E1              10      POP HL
000798 CD35 3A0080          13      LD  A,(BUFFER)
00079B CD38 C9              10      RET
                                
       CD39                     C_DEL:
00079C CD39 CD84CE          17      CALL    SETFCB
00079F CD3C CDE3D2          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
0007A2 CD3F 0E13             7      LD  C,013H
0007A4 CD41 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       CD43                     C_REN:
0007A6 CD43 CD84CE          17      CALL    SETFCB
0007A9 CD46 3E10             7      LD  A,010H      ;ディレクトリも対象にする
0007AB CD48 326900          13      LD  (FCB1+13),A ;属性
0007AE CD4B 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       CD4D                     CDEL1:
0007B0 CD4D 115C00          10      LD  DE,FCB1
0007B3 CD50 CD0500          17      CALL    SYSTEM
0007B6 CD53 C6FF             7      ADD A,0FFH
0007B8 CD55 C9              10      RET
                                
       CD56                     C_DIR:
0007B9 CD56 CD0FD7          17      CALL    FILEC
0007BC CD59 2115E6          10      LD  HL,FDRV+1
0007BF CD5C CD9ACF          17      CALL    CWILD1
0007C2 CD5F 3EF1             7      LD  A,0F1H
0007C4 CD61 3221E6          13      LD  (FDRV+13),A
0007C7 CD64 CD3DCC          17      CALL    OPEN1
       CD67                     CDIR1:
0007CA CD67 B7               4      OR  A
0007CB CD68 2008            12      JR  NZ,PDSKF
0007CD CD6A CDB5CD          17      CALL    P_NAME
0007D0 CD6D CD4FCC          17      CALL    OPEN2
0007D3 CD70 18F5            12      JR  CDIR1
       CD72                     PDSKF:
0007D5 CD72 3A14E6          13      LD  A,(FDRV)
0007D8 CD75 5F               4      LD  E,A
0007D9 CD76 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
0007DB CD78 CD0500          17      CALL    SYSTEM
0007DE CD7B 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
0007DF CD7C C601             7      ADD A,001H
0007E1 CD7E D8              11      RET C       ;Aが0FFHだった場合
0007E2 CD7F 3E06             7      LD  A,8-2
       CD81                     PDS1:               ;HL=未使用クラスタの総数
0007E4 CD81 3C               4      INC A
0007E5 CD82 CB19             8      RR  C
0007E7 CD84 30FB            12      JR  NC,PDS1
       CD86                     PDS2:               ;B←論理セクタのサイズの上位8ビット
0007E9 CD86 3C               4      INC A
0007EA CD87 CB18             8      RR  B
0007EC CD89 30FB            12      JR  NC,PDS2
0007EE CD8B 47               4      LD  B,A
                                
0007EF CD8C 110000          10      LD  DE,0
       CD8F                     PDS3:
0007F2 CD8F 29              11      ADD HL,HL
0007F3 CD90 EB               4      EX  DE,HL
0007F4 CD91 ED6A            15      ADC HL,HL
0007F6 CD93 EB               4      EX  DE,HL
0007F7 CD94 10F9            13      DJNZ    PDS3
       CD96                     PDSKF1:
0007F9 CD96 CD22CE          17      CALL    PRDEC_DEHL
0007FC CD99 1188E5          10      LD  DE,FREE
0007FF CD9C CD05D0          17      CALL    _SYS09      ;(BDOS)文字列出力
000802 CD9F CD0FCE          17      CALL    PUTDRV
000805 CDA2 3E5C             7      LD  A,05CH      ;\
000807 CDA4 CDA7D2          17      CALL    MSG_A
00080A CDA7 2A22E6          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
00080D CDAA AF               4      XOR A
00080E CDAB 11FEFF          10      LD  DE,0-2
000811 CDAE 19              11      ADD HL,DE
000812 CDAF 23               6      INC HL
000813 CDB0 DC1FCE          17      CALL    C,PRDEC_HL
000816 CDB3 1833            12      JR  LTNL
                                
       CDB5                     P_NAME:
000818 CDB5 3A34E5          13      LD  A,(DTA_CCP+1)
00081B CDB8 FE2E             7      CP  '.'
00081D CDBA C8              11      RET Z
                                
00081E CDBB 3A3FE5          13      LD  A,(DTA_CCP+1+00BH)
000821 CDBE F5              11      PUSH    AF
000822 CDBF CB67             8      BIT 4,A
000824 CDC1 2808            12      JR  Z,DIR3
000826 CDC3 117DE5          10      LD  DE,DIRMES
000829 CDC6 CD05D0          17      CALL    _SYS09      ;(BDOS)文字列出力
00082C CDC9 180A            12      JR  DIR6
       CDCB                     DIR3:
00082E CDCB ED5B52E5        20      LD  DE,(DTA_CCP+1+01EH)
000832 CDCF 2A50E5          16      LD  HL,(DTA_CCP+1+01CH)
000835 CDD2 CD22CE          17      CALL    PRDEC_DEHL
       CDD5                     DIR6:
000838 CDD5 F1              10      POP AF
000839 CDD6 0F               4      RRCA
00083A CDD7 9F               4      SBC A,A
00083B CDD8 E60A             7      AND '*'-020H
00083D CDDA C620             7      ADD A,020H
00083F CDDC CDA7D2          17      CALL    MSG_A
000842 CDDF CD0FCE          17      CALL    PUTDRV
000845 CDE2 2134E5          10      LD  HL,DTA_CCP+1
000848 CDE5 CD62CE          17      CALL    FPRNT
                                
       CDE8                     LTNL:
00084B CDE8 1E03             7      LD  E,3
00084D CDEA C3CDE6          10      JP  _PRINT
                                
       CDED                     C_PATH:
000850 CDED CDF0D7          17      CALL    SPCUT
000853 CDF0 21F7E4          10      LD  HL,PATHD
000856 CDF3 FE21             7      CP  021H
000858 CDF5 300C            12      JR  NC,CPATH0
       CDF7                     CPATHP:
00085A CDF7 7E               7      LD  A,(HL)
00085B CDF8 23               6      INC HL
00085C CDF9 FE20             7      CP  020H
00085E CDFB 3F               4      CCF
00085F CDFC 30EA            12      JR  NC,LTNL
000861 CDFE CDA7D2          17      CALL    MSG_A
000864 CE01 18F4            12      JR  CPATHP
       CE03                     CPATH0:
000866 CE03 FE3B             7      CP  ';'
000868 CE05 2001            12      JR  NZ,CPATH1
00086A CE07 13               6      INC DE
       CE08                     CPATH1:
00086B CE08 EB               4      EX  DE,HL
00086C CE09 013B00          10      LD  BC,PATHX
00086F CE0C EDB0                    LDIR
000871 CE0E C9              10      RET
                                
       CE0F                     PUTDRV:
000872 CE0F 3A14E6          13      LD  A,(FDRV)
000875 CE12 CD23D8          17      CALL    GETDRV1
000878 CE15 C641             7      ADD A,'A'
00087A CE17 CDA7D2          17      CALL    MSG_A
00087D CE1A 3E3A             7      LD  A,':'
       CE1C                     MSG_AR:
00087F CE1C C3A7D2          10      JP  MSG_A
                                
       CE1F                     PRDEC_HL:
000882 CE1F AF               4      XOR A
000883 CE20 5F               4      LD  E,A
000884 CE21 57               4      LD  D,A
       CE22                     PRDEC_DEHL:
000885 CE22 D5              11      PUSH    DE
000886 CE23 110FE6          10      LD  DE,DECBF
000889 CE26 0605             7      LD  B,5
00088B CE28 CDB9CE          17      CALL    ZERO_MEMORY_DE  ;A=0
00088E CE2B D1              10      POP DE
                                
00088F CE2C 0E20             7      LD  C,32
       CE2E                     DEC1:
000891 CE2E 29              11      ADD HL,HL
000892 CE2F EB               4      EX  DE,HL
000893 CE30 ED6A            15      ADC HL,HL
000895 CE32 EB               4      EX  DE,HL
000896 CE33 E5              11      PUSH    HL
000897 CE34 2113E6          10      LD  HL,DECBF+4
00089A CE37 0605             7      LD  B,5
       CE39                     DEC2:
00089C CE39 7E               7      LD  A,(HL)
00089D CE3A 8F               4      ADC A,A
00089E CE3B 27               4      DAA
00089F CE3C 77               7      LD  (HL),A
0008A0 CE3D 2B               6      DEC HL
0008A1 CE3E 10F9            13      DJNZ    DEC2
0008A3 CE40 E1              10      POP HL
0008A4 CE41 0D               4      DEC C
0008A5 CE42 20EA            12      JR  NZ,DEC1
                                
0008A7 CE44 210FE6          10      LD  HL,DECBF
0008AA CE47 3E20             7      LD  A,020H
0008AC CE49 0604             7      LD  B,4
       CE4B                     DEC3:
0008AE CE4B CD58CE          17      CALL    DEC4
0008B1 CE4E CD58CE          17      CALL    DEC4
0008B4 CE51 23               6      INC HL
0008B5 CE52 10F7            13      DJNZ    DEC3
       CE54                     DECX:
0008B7 CE54 CD58CE          17      CALL    DEC4
0008BA CE57 AF               4      XOR A
       CE58                     DEC4:
0008BB CE58 ED6F            18      RLD
0008BD CE5A FE20             7      CP  020H
0008BF CE5C 2802            12      JR  Z,DEC5
0008C1 CE5E F630             7      OR  030H
       CE60                     DEC5:
0008C3 CE60 18BA            12      JR  MSG_AR
                                
       CE62                     FPRNT:
0008C5 CE62 0608             7      LD  B,8 ;ファイル名を表示
0008C7 CE64 CD73CE          17      CALL    P_N1
0008CA CE67 7E               7      LD  A,(HL)
0008CB CE68 CD42DA          17      CALL    CAP3
0008CE CE6B D8              11      RET C   ;拡張子が無い
                                
0008CF CE6C 3E2E             7      LD  A,'.'
0008D1 CE6E CDA7D2          17      CALL    MSG_A
0008D4 CE71 0603             7      LD  B,3 ;拡張子を表示
       CE73                     P_N1:
0008D6 CE73 7E               7      LD  A,(HL)
0008D7 CE74 CD42DA          17      CALL    CAP3
0008DA CE77 3807            12      JR  C,P_N2
0008DC CE79 CDA7D2          17      CALL    MSG_A
0008DF CE7C 23               6      INC HL
0008E0 CE7D 10F4            13      DJNZ    P_N1
0008E2 CE7F C9              10      RET
       CE80                     P_N2:
0008E3 CE80 23               6      INC HL
0008E4 CE81 10FD            13      DJNZ    P_N2
0008E6 CE83 C9              10      RET
                                
       CE84                     SETFCB:
0008E7 CE84 CDF0D7          17      CALL    SPCUT
0008EA CE87 1A               7      LD  A,(DE)
0008EB CE88 FE20             7      CP  020H
0008ED CE8A 3801            12      JR  C,SETFCBA
0008EF CE8C 1B               6      DEC DE
       CE8D                     SETFCBA:
0008F0 CE8D 0624             7      LD  B,36
0008F2 CE8F 215C00          10      LD  HL,FCB1
0008F5 CE92 E5              11      PUSH    HL
0008F6 CE93 AF               4      XOR A
0008F7 CE94 CDC5D7          17      CALL    FILL_MEMORY
0008FA CE97 E1              10      POP HL
0008FB CE98 D5              11      PUSH    DE
0008FC CE99 CD3ED2          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0008FF CE9C 216C00          10      LD  HL,FCB2
000902 CE9F CD3ED2          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000905 CEA2 E1              10      POP HL
000906 CEA3 010050          10      LD  BC,05000H
000909 CEA6 118100          10      LD  DE,00081H
       CEA9                     SETFCB1:
00090C CEA9 7E               7      LD  A,(HL)
00090D CEAA 23               6      INC HL
00090E CEAB FE20             7      CP  020H
000910 CEAD 3805            12      JR  C,SETFCB2
000912 CEAF 12               7      LD  (DE),A
000913 CEB0 13               6      INC DE
000914 CEB1 0C               4      INC C
000915 CEB2 10F5            13      DJNZ    SETFCB1
       CEB4                     SETFCB2:
000917 CEB4 79               4      LD  A,C
000918 CEB5 328000          13      LD  (DTA1),A
00091B CEB8 04               4      INC B
       CEB9                     ZERO_MEMORY_DE:
00091C CEB9 AF               4      XOR A
       CEBA                     FILL_MEMORY_DE:
00091D CEBA 12               7      LD  (DE),A
00091E CEBB 13               6      INC DE
00091F CEBC 10FC            13      DJNZ    FILL_MEMORY_DE
000921 CEBE C9              10      RET
                                
       CEBF                     C_COPY:
000922 CEBF CD84CE          17      CALL    SETFCB
                                
000925 CEC2 1161E6          10      LD  DE,ZERO
000928 CEC5 CD12D7          17      CALL    FILEC2
00092B CEC8 216C00          10      LD  HL,FCB2
00092E CECB CD45D2          17      CALL    S29X1
                                
000931 CECE 3E10             7      LD  A,010H
000933 CED0 326900          13      LD  (FCB1+13),A
000936 CED3 216D00          10      LD  HL,FCB2FN
000939 CED6 CD9ACF          17      CALL    CWILD1
       CED9                     COPY0:
00093C CED9 CD97CF          17      CALL    CWILD
00093F CEDC 215C00          10      LD  HL,FCB1
000942 CEDF CD40CC          17      CALL    OPEN
000945 CEE2 37               4      SCF
       CEE3                     COPY1:
000946 CEE3 C0              11      RET NZ
000947 CEE4 CD53CC          17      CALL    DEFCB
                                
00094A CEE7 3A40E5          13      LD  A,(DTA_CCP+13)
00094D CEEA CB67             8      BIT 4,A
00094F CEEC 2821            12      JR  Z,COPY1A
                                
000951 CEEE 215D00          10      LD  HL,FCB1FN
000954 CEF1 CD55DB          17      CALL    CHKWILD
000957 CEF4 3814            12      JR  C,COPY9
                                
000959 CEF6 3E20             7      LD  A,020H
00095B CEF8 325D00          13      LD  (FCB1FN),A
00095E CEFB 2A4DE5          16      LD  HL,(DTA_CCP+26)
000961 CEFE 23               6      INC HL
000962 CEFF 226A00          16      LD  (FCB1+14),HL
000965 CF02 18D5            12      JR  COPY0
                                
       CF04                     COPY8:
000967 CF04 CD05D0          17      CALL    _SYS09      ;(BDOS)文字列出力
00096A CF07 CDE8CD          17      CALL    LTNL
       CF0A                     COPY9:
00096D CF0A CD4FCC          17      CALL    OPEN2
000970 CF0D 18D4            12      JR  COPY1
                                
       CF0F                     COPY1A:
000972 CF0F 216C00          10      LD  HL,FCB2
000975 CF12 1114E6          10      LD  DE,FDRV
000978 CF15 0135E5          10      LD  BC,DTA_CCP+2
00097B CF18 EDA0            16      LDI
00097D CF1A 3E0B             7      LD  A,11
       CF1C                     COPY2:
00097F CF1C F5              11      PUSH    AF
000980 CF1D 7E               7      LD  A,(HL)
000981 CF1E FE3F             7      CP  '?'
000983 CF20 2001            12      JR  NZ,COPY3
000985 CF22 0A               7      LD  A,(BC)
       CF23                     COPY3:
000986 CF23 12               7      LD  (DE),A
000987 CF24 03               6      INC BC
000988 CF25 13               6      INC DE
000989 CF26 23               6      INC HL
00098A CF27 F1              10      POP AF
00098B CF28 3D               4      DEC A
00098C CF29 20F1            12      JR  NZ,COPY2
00098E CF2B 010500          10      LD  BC,16-11
000991 CF2E EDB0                    LDIR
       CF30                     PUTNAME:
000993 CF30 215D00          10      LD  HL,FCB1FN
000996 CF33 CD55DB          17      CALL    CHKWILD
000999 CF36 300B            12      JR  NC,PUTN1
00099B CF38 2115E6          10      LD  HL,FDRV+1
00099E CF3B CD62CE          17      CALL    FPRNT
0009A1 CF3E 3E20             7      LD  A,020H
0009A3 CF40 CDA7D2          17      CALL    MSG_A
       CF43                     PUTN1:
0009A6 CF43 1114E6          10      LD  DE,FDRV
0009A9 CF46 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
0009AB CF48 CD6ECC          17      CALL    SYSTEM0
0009AE CF4B 2048            12      JR  NZ,COPYE2
0009B0 CF4D 67               4      LD  H,A     ;A=0
0009B1 CF4E 6F               4      LD  L,A
0009B2 CF4F 2235E6          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0009B5 CF52 2237E6          16      LD  (FDRV+35),HL
       CF55                     COPY6:
0009B8 CF55 CD77CC          17      CALL    S27BUF
0009BB CF58 47               4      LD  B,A
0009BC CF59 3C               4      INC A
0009BD CF5A 2831            12      JR  Z,COPYE
0009BF CF5C 7C               4      LD  A,H
0009C0 CF5D B5               4      OR  L
0009C1 CF5E 280C            12      JR  Z,COPY7
0009C3 CF60 1114E6          10      LD  DE,FDRV
0009C6 CF63 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0009C8 CF65 CD6ECC          17      CALL    SYSTEM0
0009CB CF68 2023            12      JR  NZ,COPYE
0009CD CF6A 10E9            13      DJNZ    COPY6
       CF6C                     COPY7:
0009CF CF6C 3A40E5          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0009D2 CF6F 3221E6          13      LD  (FDRV+13),A
0009D5 CF72 2147E5          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
0009D8 CF75 1128E6          10      LD  DE,FDRV+20
0009DB CF78 010400          10      LD  BC,4
0009DE CF7B EDB0                    LDIR
                                
0009E0 CF7D 1114E6          10      LD  DE,FDRV
0009E3 CF80 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
0009E5 CF82 CD6ECC          17      CALL    SYSTEM0
0009E8 CF85 2006            12      JR  NZ,COPYE
                                
0009EA CF87 1171E6          10      LD  DE,OK
0009ED CF8A C304CF          10      JP  COPY8
                                
       CF8D                     COPYE:
0009F0 CF8D 1114E6          10      LD  DE,FDRV
0009F3 CF90 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
0009F5 CF92 CD0500          17      CALL    SYSTEM
       CF95                     COPYE2:
0009F8 CF95 37               4      SCF
0009F9 CF96 C9              10      RET
                                
       CF97                     CWILD:
0009FA CF97 215D00          10      LD  HL,FCB1FN
       CF9A                     CWILD1:
0009FD CF9A 7E               7      LD  A,(HL)
0009FE CF9B FE20             7      CP  020H
000A00 CF9D C0              11      RET NZ
       CF9E                     CWILD2:
000A01 CF9E 3E3F             7      LD  A,'?'
000A03 CFA0 060B             7      LD  B,11
000A05 CFA2 C3C5D7          10      JP  FILL_MEMORY
                                
       CFA5                     COMTB:
000A08 CFA5 44202020                DB  "D   "  ;1
000A0C CFA9 56CD                    DW  C_DIR
000A0E CFAB 44495220                DB  "DIR "  ;2
000A12 CFAF 56CD                    DW  C_DIR
000A14 CFB1 434F5059                DB  "COPY"  ;3
000A18 CFB5 BFCE                    DW  C_COPY
000A1A CFB7 43442020                DB  "CD  "  ;4
000A1E CFBB 73CC                    DW  C_CD
000A20 CFBD 44454C20                DB  "DEL "  ;5
000A24 CFC1 39CD                    DW  C_DEL
000A26 CFC3 50415448                DB  "PATH"  ;6
000A2A CFC7 EDCD                    DW  C_PATH
000A2C CFC9 52454E20                DB  "REN "  ;7
000A30 CFCD 43CD                    DW  C_REN
000A32 CFCF 52454D20                DB  "REM "  ;8
000A36 CFD3 03D0                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       CFD5                     BDOS0:
000A38 CFD5 E5              11      PUSH    HL
000A39 CFD6 79               4      LD  A,C
000A3A CFD7 FE3C             7      CP  03CH
000A3C CFD9 3802            12      JR  C,DOS1
000A3E CFDB 3E3C             7      LD  A,03CH
       CFDD                     DOS1:
000A40 CFDD 87               4      ADD A,A
000A41 CFDE 32E2CF          13      LD  (DOS1_SWC),A
000A44 CFE1 2A00E7          16      LD  HL,(STABLE)
       CFE2                     DOS1_SWC    EQU $-2
000A47 CFE4 E3              19      EX  (SP),HL
000A48 CFE5 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
000A49 CFE6 C9              10      RET
       CFE7                     _DOS2:
000A4A CFE7 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000A4C CFE9 CA80D2          10      JP  Z,_SYS5A
000A4F CFEC FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000A51 CFEE CA3DD2          10      JP  Z,_SYS5C
000A54 CFF1 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
000A56 CFF3 CA52E4          10      JP  Z,_SYS5F
000A59 CFF6 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000A5B CFF8 2009            12      JR  NZ,_ERROR
000A5D CFFA 011D00          10      LD  BC,VER_6F
000A60 CFFD 116201          10      LD  DE,VER
000A63 D000 210301          10      LD  HL,MACD
       D003                     C_REM:
       D003                     _ERROR:
000A66 D003 AF               4      XOR A
000A67 D004 C9              10      RET
                                
       D005                     _SYS09:     ;文字列出力
000A68 D005 D5              11      PUSH    DE
       D006                     _SX09:
000A69 D006 1A               7      LD  A,(DE)
000A6A D007 13               6      INC DE
000A6B D008 FE24             7      CP  '$'
000A6D D00A 2831            12      JR  Z,SX0E2
000A6F D00C CDA7D2          17      CALL    MSG_A
000A72 D00F 18F5            12      JR  _SX09
                                
       D011                     MSX1:
000A74 D011 CDA7D2          17      CALL    MSG_A
       D014                     MSX:
000A77 D014 7E               7      LD  A,(HL)
000A78 D015 23               6      INC HL
000A79 D016 B7               4      OR  A
000A7A D017 20F8            12      JR  NZ,MSX1
000A7C D019 C9              10      RET
                                
       D01A                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000A7D D01A 212200          10      LD  HL,00022H
000A80 D01D 7D               4      LD  A,L
000A81 D01E C9              10      RET
                                
       D01F                     _SYS0D:     ;(BDOS)ディスクリセット
000A82 D01F CDDFE6          17      CALL    _FFLUSH
000A85 D022 E5              11      PUSH    HL
000A86 D023 218000          10      LD  HL,00080H
000A89 D026 228AE6          16      LD  (_DTA),HL
000A8C D029 E1              10      POP HL
000A8D D02A D5              11      PUSH    DE
000A8E D02B 1E00             7      LD  E,0
000A90 D02D 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D02E                     _SYS0E:     ;(BDOS)カレントドライブの設定
000A91 D02E D5              11      PUSH    DE
000A92 D02F 7B               4      LD  A,E
000A93 D030 DDE5            15      PUSH    IX
000A95 D032 CDDCE6          17      CALL    _GETDPB
000A98 D035 DDE1            14      POP IX
000A9A D037 3804            12      JR  C,SX0E2
000A9C D039 7B               4      LD  A,E
000A9D D03A 320400          13      LD  (_DVSW),A
       D03D                     SX0E2:
000AA0 D03D D1              10      POP DE
000AA1 D03E C9              10      RET
                                
       D03F                     _SYS0F:     ;(BDOS)ファイルのオープン
000AA2 D03F CD02D8          17      CALL    SETDRV
000AA5 D042 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000AA8 D045 C602             7      ADD A,002H      ;Write
000AAA D047 2848            12      JR  Z,FEND0F
000AAC D049 CD51DB          17      CALL    CHKWILDX
                                
000AAF D04C D42CD8          17      CALL    NC,SOPENX
       D04F                     _S16XX:
000AB2 D04F 3840            12      JR  C,FEND0F
                                                ;Directory location
000AB4 D051 3A9FE6          13      LD  A,(_FILEN)
000AB7 D054 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
000ABA D057 3AA0E6          13      LD  A,(_DIRF)
000ABD D05A FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000AC0 D05D FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
000AC3 D060 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
000AC6 D063 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
000ACA D067 FDE5            15      PUSH    IY
000ACC D069 D1              10      POP DE
000ACD D06A 13               6      INC DE
000ACE D06B 010B00          10      LD  BC,11
000AD1 D06E EDB0                    LDIR
                                ;               Attribute
000AD3 D070 7E               7      LD  A,(HL)
000AD4 D071 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
000AD7 D074 110B00          10      LD  DE,11       ;Reserved
000ADA D077 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
000ADB D078 11E4E7          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
000ADE D07B 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D07D                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000AE0 D07D 1A               7      LD  A,(DE)
000AE1 D07E 13               6      INC DE
000AE2 D07F 3286D0          13      LD  (S16PAT),A
000AE5 D082 7E               7      LD  A,(HL)
000AE6 D083 23               6      INC HL
000AE7 D084 FD7700          19      LD  (IY+0),A
       D086                     S16PAT  EQU $-1
000AEA D087 10F4            13      DJNZ    S16LOOP
                                
000AEC D089 AF               4      XOR A
000AED D08A FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000AF0 D08D FD222ED1        20      LD  (OFCB_SWC),IY
       D091                     FEND0F:
000AF4 D091 1845            12      JR  FEND10
                                
       D093                     _SYS10:     ;(BDOS)ファイルのクローズ
000AF6 D093 CD02D8          17      CALL    SETDRV
000AF9 D096 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000AFC D099 D6FE             7      SUB 0FEH
000AFE D09B 37               4      SCF
000AFF D09C 3F               4      CCF
000B00 D09D 2039            12      JR  NZ,FEND10
       D09F                     _S10A:              ;Write
000B02 D09F FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000B05 D0A2 FD770F          19      LD  (IY+15),A
                                
000B08 D0A5 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
000B0B D0A8 CD4DDC          17      CALL    SETTMS
                                
000B0E D0AB FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000B11 D0AE 32A0E6          13      LD  (_DIRF),A
000B14 D0B1 E67F             7      AND 07FH
000B16 D0B3 3272E1          13      LD  (_SECPS),A
000B19 D0B6 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000B1C D0B9 FD561F          19      LD  D,(IY+31)
000B1F D0BC CD60D9          17      CALL    READ_DIR
000B22 D0BF 3817            12      JR  C,FEND10
                                
000B24 D0C1 3A8CD8          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000B27 D0C4 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000B28 D0C5 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000B2B D0C8 6F               4      LD  L,A
000B2C D0C9 2600             7      LD  H,0
000B2E D0CB 29              11      ADD HL,HL       ;*2
000B2F D0CC 29              11      ADD HL,HL       ;*4
000B30 D0CD 29              11      ADD HL,HL       ;*8
000B31 D0CE 29              11      ADD HL,HL       ;*16
000B32 D0CF 29              11      ADD HL,HL       ;*32
000B33 D0D0 ED4B7EE7        20      LD  BC,(_DTBUF)
000B37 D0D4 09              11      ADD HL,BC
                                
000B38 D0D5 CD61DB          17      CALL    SDIRENT
       D0D8                     FEND10:
000B3B D0D8 1842            12      JR  FEND
                                
       D0DA                     _SYS11:     ;(BDOS)最初のファイルの検索
000B3D D0DA CD02D8          17      CALL    SETDRV
000B40 D0DD CD5BD8          17      CALL    SOPEN
       D0E0                     _S12X1:
000B43 D0E0 383A            12      JR  C,FEND
000B45 D0E2 CDFAD8          17      CALL    SOPENE2
000B48 D0E5 ED5B8AE6        20      LD  DE,(_DTA)
000B4C D0E9 3A88E6          13      LD  A,(_DRV)
000B4F D0EC 3C               4      INC A
000B50 D0ED 12               7      LD  (DE),A
000B51 D0EE D5              11      PUSH    DE
000B52 D0EF 13               6      INC DE
000B53 D0F0 012000          10      LD  BC,32
000B56 D0F3 EDB0                    LDIR
000B58 D0F5 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000B5B D0F8 FD660F          19      LD  H,(IY+15)
000B5E D0FB 22F4E7          16      LD  (SCDIR),HL
000B61 D0FE 2A9AE6          16      LD  HL,(_FBPS)
000B64 D101 22F6E7          16      LD  (SFBPS),HL
000B67 D104 2A9FE6          16      LD  HL,(_FILEN)
000B6A D107 7C               4      LD  A,H
000B6B D108 B7               4      OR  A
000B6C D109 2806            12      JR  Z,_S12DIR
000B6E D10B 3A72E1          13      LD  A,(_SECPS)
000B71 D10E F680             7      OR  080H
000B73 D110 67               4      LD  H,A
       D111                     _S12DIR:
000B74 D111 22F8E7          16      LD  (SFNDF),HL  ;Directory position and Flags
000B77 D114 E1              10      POP HL
000B78 D115 1139E6          10      LD  DE,SFILE
000B7B D118 0E21             7      LD  C,33
       D11A                     _S11B:
000B7D D11A EDB0                    LDIR
       D11C                     FEND:
000B7F D11C 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D11D                     FENDE:
000B80 D11D FDE1            14      POP IY
000B82 D11F C1              10      POP BC
000B83 D120 D1              10      POP DE
000B84 D121 E1              10      POP HL
000B85 D122 C9              10      RET
                                
       D123                     _SYS12:     ;(BDOS)次のファイルの検索
000B86 D123 E5              11      PUSH    HL
000B87 D124 D5              11      PUSH    DE
000B88 D125 C5              11      PUSH    BC
000B89 D126 FDE5            15      PUSH    IY
000B8B D128 CDBFD8          17      CALL    NOPEN
000B8E D12B 18B3            12      JR  _S12X1
                                
       D12D                     _S16K:
000B90 D12D 110000          10      LD  DE,0
       D12E                     OFCB_SWC    EQU $-2
000B93 D130 D5              11      PUSH    DE
000B94 D131 061A             7      LD  B,26        ;First cluster
       D133                     S16K1:
000B96 D133 13               6      INC DE
000B97 D134 23               6      INC HL
000B98 D135 10FC            13      DJNZ    S16K1
                                
000B9A D137 1A               7      LD  A,(DE)
000B9B D138 BE               7      CP  (HL)
000B9C D139 2015            12      JR  NZ,S16K2
000B9E D13B 13               6      INC DE
000B9F D13C 23               6      INC HL
000BA0 D13D 1A               7      LD  A,(DE)
000BA1 D13E BE               7      CP  (HL)
000BA2 D13F 200F            12      JR  NZ,S16K2
                                
000BA4 D141 E1              10      POP HL
000BA5 D142 FDE5            15      PUSH    IY
000BA7 D144 D1              10      POP DE
000BA8 D145 7E               7      LD  A,(HL)
000BA9 D146 CD17D8          17      CALL    IS_SAME_DRV_A_DE
000BAC D149 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000BAE D14B ED52            15      SBC HL,DE       ;CP HL,DE
000BB0 D14D 37               4      SCF
000BB1 D14E C0              11      RET NZ
000BB2 D14F E5              11      PUSH    HL
       D150                     S16K2:
000BB3 D150 E1              10      POP HL
       D151                     S16K3:
000BB4 D151 FDE5            15      PUSH    IY
000BB6 D153 D1              10      POP DE
       D154                     _SYS13:     ;(BDOS)ファイルの削除
000BB7 D154 CD02D8          17      CALL    SETDRV
000BBA D157 CD89DA          17      CALL    KILL
       D15A                     FEND13:
000BBD D15A 18C0            12      JR  FEND
                                
       D15C                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000BBF D15C CD02D8          17      CALL    SETDRV
000BC2 D15F CDC5DF          17      CALL    INIT_SEQ
       D162                     SREAD:
000BC5 D162 CD97DF          17      CALL    RB_READ
                                
000BC8 D165 C601             7      ADD A,001H
000BCA D167 38B3            12      JR  C,FEND
                                
000BCC D169 7D               4      LD  A,L
000BCD D16A D601             7      SUB 001H
       D16C                     FENDX:
000BCF D16C 9F               4      SBC A,A
000BD0 D16D E603             7      AND 3
000BD2 D16F 1F               4      RRA
000BD3 D170 18AB            12      JR  FENDE
                                
       D172                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000BD5 D172 CD02D8          17      CALL    SETDRV
000BD8 D175 CDC5DF          17      CALL    INIT_SEQ
       D178                     SWRITE:
000BDB D178 CD92DF          17      CALL    RB_WRITE
                                
000BDE D17B C6FF             7      ADD A,0FFH
000BE0 D17D 18ED            12      JR  FENDX
                                
       D17F                     _SYS17:     ;(BDOS)ファイル名の変更
000BE2 D17F CD02D8          17      CALL    SETDRV
000BE5 D182 CDDFDA          17      CALL    NAME
000BE8 D185 18D3            12      JR  FEND13
                                
       D187                     _SYS16:     ;(BDOS)ファイルの作成
000BEA D187 CD02D8          17      CALL    SETDRV
                                
000BED D18A CD51DB          17      CALL    CHKWILDX
000BF0 D18D 38CB            12      JR  C,FEND13
000BF2 D18F FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000BF5 D192 FE05             7      CP  5
000BF7 D194 2805            12      JR  Z,_S16X2
000BF9 D196 FE21             7      CP  021H
000BFB D198 DA5AD1          10      JP  C,FEND13
       D19B                     _S16X2:
                                ;               Clear FCB
000BFE D19B FDE5            15      PUSH    IY
000C00 D19D E1              10      POP HL
000C01 D19E 011000          10      LD  BC,16
000C04 D1A1 09              11      ADD HL,BC
       D1A2                     _S16X1:
000C05 D1A2 70               7      LD  (HL),B      ;B=0
000C06 D1A3 23               6      INC HL
000C07 D1A4 0D               4      DEC C
000C08 D1A5 20FB            12      JR  NZ,_S16X1
                                
000C0A D1A7 CD52DC          17      CALL    SETTMSX
000C0D D1AA FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000C11 D1AE CD2CD8          17      CALL    SOPENX
000C14 D1B1 3F               4      CCF
000C15 D1B2 CC2DD1          17      CALL    Z,_S16K
000C18 D1B5 D40BD9          17      CALL    NC,COPEN
000C1B D1B8 D461DB          17      CALL    NC,SDIRENT
000C1E D1BB C34FD0          10      JP  _S16XX
                                
       D1BE                     _SYS21:     ;(BDOS)ランダムな読み出し
000C21 D1BE CD02D8          17      CALL    SETDRV
000C24 D1C1 CD9DDC          17      CALL    INIT_RND
000C27 D1C4 189C            12      JR  SREAD
                                
       D1C6                     _SYS22:     ;(BDOS)ランダムな書き込み
       D1C6                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000C29 D1C6 CD02D8          17      CALL    SETDRV
000C2C D1C9 CD9DDC          17      CALL    INIT_RND
000C2F D1CC 18AA            12      JR  SWRITE
                                
       D1CE                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000C31 D1CE 21FF00          10      LD  HL,000FFH
000C34 D1D1 AF               4      XOR A
000C35 D1D2 C9              10      RET
                                
       D1D3                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000C36 D1D3 3A0400          13      LD  A,(_DVSW)   ;from LDOS
000C39 D1D6 A7               4      AND A
000C3A D1D7 C9              10      RET
                                
       D1D8                     _SYS1A:     ;(BDOS)DTAの設定
000C3B D1D8 ED538AE6        20      LD  (_DTA),DE
000C3F D1DC AF               4      XOR A
000C40 D1DD C9              10      RET
                                
       D1DE                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000C41 D1DE 7B               4      LD  A,E
000C42 D1DF CD10D8          17      CALL    GETDRV
000C45 D1E2 CDDCE6          17      CALL    _GETDPB
000C48 D1E5 D4E2E6          17      CALL    NC,_RDFATX
000C4B D1E8 210000          10      LD  HL,0
000C4E D1EB D42BDC          17      CALL    NC,DSKF
                                
000C51 D1EE ED5B2CDC        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000C55 D1F2 1B               6      DEC DE      ;DE←クラスタの総数
000C56 D1F3 FD2A7CE7        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000C5A D1F7 9F               4      SBC A,A
000C5B D1F8 D8              11      RET C
000C5C D1F9 4F               4      LD  C,A     ;C=0
000C5D D1FA DD7E0F          19      LD  A,(IX+DPB_BPS)
000C60 D1FD E607             7      AND 7
000C62 D1FF 47               4      LD  B,A
000C63 D200 DD7E07          19      LD  A,(IX+DPB_SECPCL)
000C66 D203 C9              10      RET
                                
       D204                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000C67 D204 AF               4      XOR A
000C68 D205 67               4      LD  H,A
000C69 D206 6F               4      LD  L,A
000C6A D207 C9              10      RET
                                
       D208                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000C6B D208 2100E8          10      LD  HL,_DEVICE
000C6E D20B 7B               4      LD  A,E
000C6F D20C C3DCE6          10      JP  _GETDPB
                                
       D20F                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000C72 D20F E5              11      PUSH    HL
000C73 D210 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000C75 D212 CDD5CF          17      CALL    BDOS0
000C78 D215 381B            12      JR  C,_S23X1
                                
000C7A D217 D5              11      PUSH    DE      ;EX DE,IY
000C7B D218 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000C7D D21A FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000C80 D21D FD6E11          19      LD  L,(IY+17)   ;
000C83 D220 FD6612          19      LD  H,(IY+18)   ;
000C86 D223 C5              11      PUSH    BC      ;
000C87 D224 FD4613          19      LD  B,(IY+19)   ;
000C8A D227 CD8FDC          17      CALL    GET_CPM_R_SIZE
000C8D D22A C1              10      POP BC
       D22B                     _S24X1:
000C8E D22B CDAFDC          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000C91 D22E FDE3            23      EX  (SP),IY     ;
000C93 D230 D1              10      POP DE      ;
                                
000C94 D231 AF               4      XOR A
       D232                     _S23X1:
000C95 D232 E1              10      POP HL
000C96 D233 C9              10      RET
                                
       D234                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000C97 D234 E5              11      PUSH    HL
000C98 D235 D5              11      PUSH    DE      ;EX DE,IY
000C99 D236 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000C9B D238 CDCDDF          17      CALL    GETSEQ
000C9E D23B 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D23D                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000CA0 D23D 2B               6      DEC HL
       D23E                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000CA1 D23E C5              11      PUSH    BC
000CA2 D23F E5              11      PUSH    HL
000CA3 D240 CD1AD7          17      CALL    FILE
000CA6 D243 E1              10      POP HL
000CA7 D244 C1              10      POP BC
       D245                     S29X1:
000CA8 D245 C5              11      PUSH    BC
000CA9 D246 D5              11      PUSH    DE
000CAA D247 E5              11      PUSH    HL
000CAB D248 EB               4      EX  DE,HL
000CAC D249 AF               4      XOR A
000CAD D24A 3221E6          13      LD  (FDRV+13),A
000CB0 D24D 2114E6          10      LD  HL,FDRV
000CB3 D250 011000          10      LD  BC,16
000CB6 D253 EDB0                    LDIR
000CB8 D255 E1              10      POP HL
000CB9 D256 D1              10      POP DE
000CBA D257 C1              10      POP BC
000CBB D258 C9              10      RET
                                
       D259                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000CBC D259 C5              11      PUSH    BC
000CBD D25A 0113E3          10      LD  BC,DWT24B
000CC0 D25D 1804            12      JR  S2FX
       D25F                     _SYS2F:
000CC2 D25F C5              11      PUSH    BC
000CC3 D260 0105E3          10      LD  BC,DRD24B
       D263                     S2FX:
000CC6 D263 ED4379D2        20      LD  (S2F_SWC),BC
000CCA D267 CDDFE6          17      CALL    _FFLUSH
                                
000CCD D26A D5              11      PUSH    DE
000CCE D26B E5              11      PUSH    HL
000CCF D26C 7D               4      LD  A,L     ;Drive
000CD0 D26D CDD9E6          17      CALL    _CHGDRV
000CD3 D270 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
000CD5 D272 44               4      LD  B,H     ;Number of clusters
000CD6 D273 2A8AE6          16      LD  HL,(_DTA)
                                
000CD9 D276 0E00             7      LD  C,0
000CDB D278 CD05E3          17      CALL    DRD24B
       D279                     S2F_SWC EQU $-2
       D27B                     POP_HL_DE_BC_SBCAA_RET:
000CDE D27B E1              10      POP HL
000CDF D27C D1              10      POP DE
000CE0 D27D C1              10      POP BC
000CE1 D27E 9F               4      SBC A,A
000CE2 D27F C9              10      RET
                                
       D280                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000CE3 D280 C5              11      PUSH    BC
000CE4 D281 D5              11      PUSH    DE
000CE5 D282 E5              11      PUSH    HL
000CE6 D283 CD0FD7          17      CALL    FILEC
000CE9 D286 217BD2          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
000CEC D289 E5              11      PUSH    HL
000CED D28A 3A21E6          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
000CF0 D28D E610             7      AND 010H        ;ディレクトリ
000CF2 D28F 37               4      SCF
000CF3 D290 C8              11      RET Z
000CF4 D291 1114E6          10      LD  DE,FDRV
000CF7 D294 2A4EE7          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       D297                     JPHL:
000CFA D297 E9               4      JP  (HL)
                                
       D298                     SHOW_ERROR:         ;(9)
000CFB D298 1179E6          10      LD  DE,COMERM
000CFE D29B CD05D0          17      CALL    _SYS09      ;(BDOS)文字列出力
000D01 D29E C300E6          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "MSXIO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MSX
                                
       D003                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D003                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D003                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D003                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D003                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D003                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       0000                     CTRL00  EQU 0
       0000                     CTRL03  EQU 0
       0000                     CTRL04  EQU 0
       0000                     CTRL05  EQU 0
       0000                     CTRL06  EQU 0
       0000                     CTRL07  EQU 0
       0000                     CTRL08  EQU 0
       0000                     CTRL09  EQU 0
       0000                     CTRL0A  EQU 0
       0000                     CTRL0B  EQU 0
       0000                     CTRL0C  EQU 0
       0000                     CTRL0D  EQU 0
       0000                     CTRL0E  EQU 0
       0000                     CTRL12  EQU 0
       0000                     CTRL1B  EQU 0
       0000                     CTRL1C  EQU 0
       0000                     CTRL1D  EQU 0
       0000                     CTRL1E  EQU 0
       0000                     CTRL1F  EQU 0
                                
       D2A1                     PRINT:
000D04 D2A1 7B               4      LD  A,E
000D05 D2A2 1803            12      JR  MSG_A
                                
       D2A4                     _SYS01:     ;(BDOS)コンソール入力
000D07 D2A4 CD09E6          17      CALL    _SYS07
       D2A7                     MSG_A:
000D0A D2A7 FE03             7      CP  3
000D0C D2A9 2814            12      JR  Z,MSG_BR
       D2AB                     MSGA1:
000D0E D2AB F5              11      PUSH    AF
000D0F D2AC C5              11      PUSH    BC
000D10 D2AD D5              11      PUSH    DE
000D11 D2AE E5              11      PUSH    HL
000D12 D2AF DDE5            15      PUSH    IX
000D14 D2B1 DD21A200        14      LD  IX,CHPUT
000D18 D2B5 CD1AD5          17      CALL    CALSLT_R
000D1B D2B8 DDE1            14      POP IX
000D1D D2BA E1              10      POP HL
000D1E D2BB D1              10      POP DE
000D1F D2BC C1              10      POP BC
       D2BD                     MSGA2:
000D20 D2BD F1              10      POP AF
000D21 D2BE C9              10      RET
       D2BF                     MSG_BR:
000D22 D2BF F5              11      PUSH    AF
000D23 D2C0 3ADDF3          13      LD  A,(CSRX)
000D26 D2C3 FE02             7      CP  2
000D28 D2C5 38F6            12      JR  C,MSGA2
000D2A D2C7 F1              10      POP AF
       D2C8                     MSG_CR:
000D2B D2C8 F5              11      PUSH    AF
000D2C D2C9 3E0D             7      LD  A,00DH
000D2E D2CB CDABD2          17      CALL    MSGA1
000D31 D2CE 3E0A             7      LD  A,00AH
000D33 D2D0 CDABD2          17      CALL    MSGA1
000D36 D2D3 F1              10      POP AF
000D37 D2D4 C9              10      RET
                                
       D2D5                     _SYS02:     ;(BDOS)コンソール出力
000D38 D2D5 CDF1D2          17      CALL    BREAK
000D3B D2D8 C3CDE6          10      JP  _PRINT
                                
       D2DB                     _SYS06:     ;(BDOS)コンソール直接入出力
000D3E D2DB 7B               4      LD  A,E
000D3F D2DC 3C               4      INC A
000D40 D2DD CACAE6          10      JP  Z,_INKEY
000D43 D2E0 C3CDE6          10      JP  _PRINT
                                
       D2E3                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000D46 D2E3 CD09E6          17      CALL    _SYS07
000D49 D2E6 FE03             7      CP  3
000D4B D2E8 CCF4E6          17      CALL    Z,_BREAK
000D4E D2EB FE13             7      CP  013H        ;CTRL+S
000D50 D2ED C0              11      RET NZ
       D2EE                     PAUSE:
000D51 D2EE CD08D3          17      CALL    KEYBC
                                
       D2F1                     BREAK:
000D54 D2F1 F5              11      PUSH    AF
000D55 D2F2 C5              11      PUSH    BC
000D56 D2F3 D5              11      PUSH    DE
000D57 D2F4 E5              11      PUSH    HL
000D58 D2F5 DDE5            15      PUSH    IX
000D5A D2F7 DD21B700        14      LD  IX,BREAKX
000D5E D2FB CD1AD5          17      CALL    CALSLT_R
000D61 D2FE DDE1            14      POP IX
000D63 D300 E1              10      POP HL
000D64 D301 D1              10      POP DE
000D65 D302 C1              10      POP BC
000D66 D303 DCF4E6          17      CALL    C,_BREAK
000D69 D306 F1              10      POP AF
000D6A D307 C9              10      RET
       D308                     KEYBC:
000D6B D308 F5              11      PUSH    AF
000D6C D309 C5              11      PUSH    BC
000D6D D30A D5              11      PUSH    DE
000D6E D30B E5              11      PUSH    HL
000D6F D30C DDE5            15      PUSH    IX
000D71 D30E DD215601        14      LD  IX,KILBUF
000D75 D312 CD1AD5          17      CALL    CALSLT_R
000D78 D315 DDE1            14      POP IX
000D7A D317 E1              10      POP HL
000D7B D318 D1              10      POP DE
000D7C D319 C1              10      POP BC
000D7D D31A F1              10      POP AF
000D7E D31B C9              10      RET
       D31C                     FLGET:
000D7F D31C C5              11      PUSH    BC
000D80 D31D D5              11      PUSH    DE
000D81 D31E E5              11      PUSH    HL
000D82 D31F DDE5            15      PUSH    IX
000D84 D321 CDDFE6          17      CALL    _FFLUSH
000D87 D324 181B            12      JR  FLGET1
       D325                     CBIOS_SWC1  EQU $-1
000D89 D326 CD02D5          17      CALL    GETVRAM
                                
000D8C D329 E5              11      PUSH    HL
000D8D D32A DD214A00        14      LD  IX,RDVRM
000D91 D32E CD1AD5          17      CALL    CALSLT_R
000D94 D331 E1              10      POP HL
000D95 D332 324DD3          13      LD  (SWCCHR),A
                                
000D98 D335 E5              11      PUSH    HL
000D99 D336 3EFF             7      LD  A,0FFH
000D9B D338 DD214D00        14      LD  IX,WRTVRM
000D9F D33C CD1AD5          17      CALL    CALSLT_R
000DA2 D33F E1              10      POP HL
                                
000DA3 D340 E5              11      PUSH    HL
       D341                     FLGET1:
000DA4 D341 DD219F00        14      LD  IX,CHGET
000DA8 D345 CD1AD5          17      CALL    CALSLT_R
000DAB D348 180C            12      JR  FLGET2
       D349                     CBIOS_SWC2  EQU $-1
000DAD D34A E1              10      POP HL
                                
000DAE D34B F5              11      PUSH    AF
000DAF D34C 3E00             7      LD  A,0
       D34D                     SWCCHR  EQU $-1
000DB1 D34E DD214D00        14      LD  IX,WRTVRM
000DB5 D352 CD1AD5          17      CALL    CALSLT_R
000DB8 D355 F1              10      POP AF
       D356                     FLGET2:
000DB9 D356 DDE1            14      POP IX
000DBB D358 E1              10      POP HL
000DBC D359 D1              10      POP DE
000DBD D35A C1              10      POP BC
000DBE D35B FE03             7      CP  3
000DC0 D35D C0              11      RET NZ
000DC1 D35E C300E6          10      JP  CPM_BOOT
                                
       D361                     INKEY:
000DC4 D361 CD06E6          17      CALL    CPM_CONST
000DC7 D364 C8              11      RET Z
000DC8 D365 18B5            12      JR  FLGET
                                
       D367                     _SYS0A:     ;(BDOS)文字列入力
000DCA D367 C5              11      PUSH    BC
000DCB D368 E5              11      PUSH    HL
000DCC D369 D5              11      PUSH    DE
000DCD D36A CD93D3          17      CALL    GETL
000DD0 D36D 111FF4          10      LD  DE,KBUF
000DD3 D370 E1              10      POP HL
000DD4 D371 E5              11      PUSH    HL
000DD5 D372 0E00             7      LD  C,0
000DD7 D374 3004            12      JR  NC,SAX0
000DD9 D376 23               6      INC HL
000DDA D377 23               6      INC HL
000DDB D378 1808            12      JR  SAX4
       D37A                     SAX0:
000DDD D37A 46               7      LD  B,(HL)
000DDE D37B 23               6      INC HL
       D37C                     SAX1:
000DDF D37C 23               6      INC HL
000DE0 D37D 1A               7      LD  A,(DE)
000DE1 D37E 13               6      INC DE
000DE2 D37F B7               4      OR  A
000DE3 D380 2004            12      JR  NZ,SAX2
       D382                     SAX4:
000DE5 D382 360D            10      LD  (HL),00DH
000DE7 D384 1804            12      JR  SAX3
       D386                     SAX2:
000DE9 D386 77               7      LD  (HL),A
000DEA D387 0C               4      INC C
000DEB D388 10F2            13      DJNZ    SAX1
       D38A                     SAX3:
000DED D38A D1              10      POP DE
000DEE D38B 79               4      LD  A,C
000DEF D38C 13               6      INC DE
000DF0 D38D 12               7      LD  (DE),A
000DF1 D38E 1B               6      DEC DE
000DF2 D38F E1              10      POP HL
000DF3 D390 C1              10      POP BC
000DF4 D391 A7               4      AND A
000DF5 D392 C9              10      RET
       D393                     GETL:
000DF6 D393 DDE5            15      PUSH    IX
000DF8 D395 FDE5            15      PUSH    IY
                                
000DFA D397 2ADCF3          16      LD  HL,(CSRY)
000DFD D39A 22CAFB          16      LD  (FSTPOS),HL
       D39D                     GETL1:
000E00 D39D CDE3D2          17      CALL    _SYS08
000E03 D3A0 FE09             7      CP  9
000E05 D3A2 2008            12      JR  NZ,GETL1V
000E07 D3A4 211FF4          10      LD  HL,KBUF
000E0A D3A7 CD14D0          17      CALL    MSX
000E0D D3AA 18F1            12      JR  GETL1
       D3AC                     GETL1V:
000E0F D3AC 5F               4      LD  E,A
000E10 D3AD FE08             7      CP  8
000E12 D3AF CCA8D4          17      CALL    Z,CTRL02
000E15 D3B2 FE20             7      CP  020H
000E17 D3B4 D4D4D4          17      CALL    NC,INSERT
000E1A D3B7 CDABD2          17      CALL    MSGA1
                                
000E1D D3BA 7B               4      LD  A,E
000E1E D3BB FE0D             7      CP  00DH
000E20 D3BD 20DE            12      JR  NZ,GETL1
                                
000E22 D3BF 111FF4          10      LD  DE,KBUF
000E25 D3C2 3AB0F3          13      LD  A,(LINLEN)
000E28 D3C5 47               4      LD  B,A
000E29 D3C6 CDB9CE          17      CALL    ZERO_MEMORY_DE
                                
000E2C D3C9 2ACAFB          16      LD  HL,(FSTPOS)
000E2F D3CC 3ADCF3          13      LD  A,(CSRY)
000E32 D3CF 6F               4      LD  L,A
000E33 D3D0 E5              11      PUSH    HL
000E34 D3D1 CD05D5          17      CALL    LOC0
000E37 D3D4 4D               4      LD  C,L
000E38 D3D5 44               4      LD  B,H
000E39 D3D6 E1              10      POP HL
000E3A D3D7 3AB0F3          13      LD  A,(LINLEN)
000E3D D3DA 94               4      SUB H
000E3E D3DB 3D               4      DEC A
000E3F D3DC 5F               4      LD  E,A
000E40 D3DD 211FF4          10      LD  HL,KBUF
       D3E0                     GETL2:
000E43 D3E0 CDD0E6          17      CALL    _SCRN
000E46 D3E3 03               6      INC BC
000E47 D3E4 77               7      LD  (HL),A
000E48 D3E5 23               6      INC HL
000E49 D3E6 1D               4      DEC E
000E4A D3E7 20F7            12      JR  NZ,GETL2
000E4C D3E9 CDC8D2          17      CALL    MSG_CR
                                
000E4F D3EC FDE1            14      POP IY
000E51 D3EE DDE1            14      POP IX
       D3F0                     GETL3:
000E53 D3F0 2B               6      DEC HL
000E54 D3F1 7E               7      LD  A,(HL)
000E55 D3F2 FE21             7      CP  021H
000E57 D3F4 D0              11      RET NC
000E58 D3F5 3600            10      LD  (HL),0
000E5A D3F7 15               4      DEC D
000E5B D3F8 20F6            12      JR  NZ,GETL3
000E5D D3FA C9              10      RET
                                
       D3FB                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       D3FB                     CONSTX:
000E5E D3FB C5              11      PUSH    BC
000E5F D3FC D5              11      PUSH    DE
000E60 D3FD E5              11      PUSH    HL
000E61 D3FE DDE5            15      PUSH    IX
000E63 D400 DD219C00        14      LD  IX,CHSNS
000E67 D404 CD1AD5          17      CALL    CALSLT_R
000E6A D407 DDE1            14      POP IX
000E6C D409 E1              10      POP HL
000E6D D40A D1              10      POP DE
000E6E D40B C1              10      POP BC
000E6F D40C C9              10      RET
                                
       D40D                     _SYS2A:     ;(BDOS)日付の獲得
000E70 D40D 0E0B             7      LD  C,11        ;年/Year→HL
000E72 D40F CD4ED4          17      CALL    RDCLK_BCD
000E75 D412 6F               4      LD  L,A
000E76 D413 2600             7      LD  H,0
000E78 D415 3AF8FA          13      LD  A,(EXBRSA)
000E7B D418 B7               4      OR  A
000E7C D419 2804            12      JR  Z,SX2A1
000E7E D41B 11BC07          10      LD  DE,1980     ;1980年～2079年
000E81 D41E 19              11      ADD HL,DE
       D41F                     SX2A1:
000E82 D41F 0E09             7      LD  C,9     ;月/Month→D
000E84 D421 CD4ED4          17      CALL    RDCLK_BCD
000E87 D424 57               4      LD  D,A
                                
000E88 D425 0E07             7      LD  C,7     ;日/Day→E
000E8A D427 CD4ED4          17      CALL    RDCLK_BCD
000E8D D42A 5F               4      LD  E,A
                                
000E8E D42B 0E06             7      LD  C,6     ;曜日/Week→A
       D42D                     RDCLK:
000E90 D42D DDE5            15      PUSH    IX
000E92 D42F DD21F501        14      LD  IX,REDCLK
       D433                     WRCLK1:
000E96 D433 3AF8FA          13      LD  A,(EXBRSA)
000E99 D436 B7               4      OR  A
000E9A D437 280A            12      JR  Z,RDCLK1    ;MSX1
000E9C D439 FDE5            15      PUSH    IY
000E9E D43B FD67             9      LD  IYH,A
000EA0 D43D 78               4      LD  A,B
000EA1 D43E CD1C00          17      CALL    _CALSLT
000EA4 D441 FDE1            14      POP IY
       D443                     RDCLK1:
000EA6 D443 DDE1            14      POP IX
000EA8 D445 C9              10      RET
       D446                     WRCLK:
000EA9 D446 DDE5            15      PUSH    IX
000EAB D448 DD21F901        14      LD  IX,WRTCLK
000EAF D44C 18E5            12      JR  WRCLK1
                                
       D44E                     RDCLK_BCD:
000EB1 D44E CD2DD4          17      CALL    RDCLK       ;1の位
000EB4 D451 47               4      LD  B,A
000EB5 D452 0C               4      INC C
000EB6 D453 CD2DD4          17      CALL    RDCLK       ;10の位
000EB9 D456 87               4      ADD A,A     ;*2
000EBA D457 4F               4      LD  C,A
000EBB D458 87               4      ADD A,A     ;*4
000EBC D459 87               4      ADD A,A     ;*8
000EBD D45A 81               4      ADD A,C     ;*10(8+2)
000EBE D45B 80               4      ADD A,B     ;1の位
000EBF D45C C9              10      RET
                                
       D45D                     _SYS2C:     ;(BDOS)時刻の獲得
000EC0 D45D 011501          10      LD  BC,00115H       ;12時間計/24時間計の設定を24時間計に
000EC3 D460 CD46D4          17      CALL    WRCLK
000EC6 D463 0E04             7      LD  C,4     ;H=時/Hour
000EC8 D465 CD4ED4          17      CALL    RDCLK_BCD
000ECB D468 67               4      LD  H,A
000ECC D469 0E02             7      LD  C,2     ;L=分/Minute
000ECE D46B CD4ED4          17      CALL    RDCLK_BCD
000ED1 D46E 6F               4      LD  L,A
000ED2 D46F 0E00             7      LD  C,0     ;D=秒/Second
000ED4 D471 CD4ED4          17      CALL    RDCLK_BCD
000ED7 D474 57               4      LD  D,A
000ED8 D475 AF               4      XOR A       ;E=1/100秒
000ED9 D476 5F               4      LD  E,A
000EDA D477 C9              10      RET
                                
       D478                     POS:
000EDB D478 F5              11      PUSH    AF
000EDC D479 2ADCF3          16      LD  HL,(CSRY)
000EDF D47C 7D               4      LD  A,L
000EE0 D47D 6C               4      LD  L,H
000EE1 D47E 67               4      LD  H,A
000EE2 D47F 2C               4      INC L
000EE3 D480 24               4      INC H
000EE4 D481 F1              10      POP AF
000EE5 D482 C9              10      RET
                                
       D483                     LOC:
000EE6 D483 F5              11      PUSH    AF
000EE7 D484 E5              11      PUSH    HL
000EE8 D485 7D               4      LD  A,L
000EE9 D486 6C               4      LD  L,H
000EEA D487 67               4      LD  H,A
000EEB D488 2D               4      DEC L
000EEC D489 25               4      DEC H
000EED D48A DDE5            15      PUSH    IX
000EEF D48C DD21C600        14      LD  IX,POSIT
000EF3 D490 CD1AD5          17      CALL    CALSLT_R
000EF6 D493 DDE1            14      POP IX
000EF8 D495 E1              10      POP HL
000EF9 D496 F1              10      POP AF
000EFA D497 C9              10      RET
       D498                     SCRN:
000EFB D498 E5              11      PUSH    HL
000EFC D499 DDE5            15      PUSH    IX
                                
000EFE D49B 69               4      LD  L,C
000EFF D49C 60               4      LD  H,B
000F00 D49D DD214A00        14      LD  IX,RDVRM
000F04 D4A1 CD1AD5          17      CALL    CALSLT_R
                                
000F07 D4A4 DDE1            14      POP IX
000F09 D4A6 E1              10      POP HL
000F0A D4A7 C9              10      RET
                                
       D4A8                     CTRL02:
000F0B D4A8 F5              11      PUSH    AF
000F0C D4A9 D5              11      PUSH    DE
000F0D D4AA 2ADCF3          16      LD  HL,(CSRY)
000F10 D4AD 3AB0F3          13      LD  A,(LINLEN)
000F13 D4B0 4F               4      LD  C,A
000F14 D4B1 94               4      SUB H   ;CSRX
000F15 D4B2 C602             7      ADD A,2
000F17 D4B4 47               4      LD  B,A ;カーソルより右の文字数
000F18 D4B5 61               4      LD  H,C ;LINLEN
000F19 D4B6 C5              11      PUSH    BC
000F1A D4B7 CD05D5          17      CALL    LOC0
000F1D D4BA C1              10      POP BC
                                
000F1E D4BB 1620             7      LD  D,020H
       D4BD                     C8X1:
000F20 D4BD DD214A00        14      LD  IX,RDVRM
000F24 D4C1 CD1AD5          17      CALL    CALSLT_R
000F27 D4C4 4F               4      LD  C,A
000F28 D4C5 7A               4      LD  A,D
000F29 D4C6 DD214D00        14      LD  IX,WRTVRM
000F2D D4CA CD1AD5          17      CALL    CALSLT_R
000F30 D4CD 2B               6      DEC HL
000F31 D4CE 51               4      LD  D,C
000F32 D4CF 10EC            13      DJNZ    C8X1
000F34 D4D1 D1              10      POP DE
000F35 D4D2 F1              10      POP AF
000F36 D4D3 C9              10      RET
                                
       D4D4                     INSERT:
000F37 D4D4 F5              11      PUSH    AF
000F38 D4D5 D5              11      PUSH    DE
000F39 D4D6 2ADCF3          16      LD  HL,(CSRY)
000F3C D4D9 3AB0F3          13      LD  A,(LINLEN)
000F3F D4DC 4F               4      LD  C,A
000F40 D4DD 94               4      SUB H   ;CSRX
000F41 D4DE 3C               4      INC A
000F42 D4DF 47               4      LD  B,A ;カーソルより右の文字数
000F43 D4E0 C5              11      PUSH    BC
000F44 D4E1 CD05D5          17      CALL    LOC0
000F47 D4E4 C1              10      POP BC
                                
000F48 D4E5 1620             7      LD  D,020H
       D4E7                     INS1:
000F4A D4E7 DD214A00        14      LD  IX,RDVRM
000F4E D4EB CD1AD5          17      CALL    CALSLT_R
000F51 D4EE 4F               4      LD  C,A
000F52 D4EF 7A               4      LD  A,D
000F53 D4F0 DD214D00        14      LD  IX,WRTVRM
000F57 D4F4 CD1AD5          17      CALL    CALSLT_R
000F5A D4F7 23               6      INC HL
000F5B D4F8 51               4      LD  D,C
000F5C D4F9 10EC            13      DJNZ    INS1
000F5E D4FB D1              10      POP DE
000F5F D4FC F1              10      POP AF
000F60 D4FD C9              10      RET
                                
       D4FE                     CONOUT1:
000F61 D4FE 59               4      LD  E,C
000F62 D4FF C3CDE6          10      JP  _PRINT
                                
       D502                     GETVRAM:
000F65 D502 2ADCF3          16      LD  HL,(CSRY)
       D505                     LOC0:
000F68 D505 2D               4      DEC L
000F69 D506 25               4      DEC H
000F6A D507 4C               4      LD  C,H ;CSRX-1
000F6B D508 5D               4      LD  E,L ;CSRY-1
       D509                     LOC1:
000F6C D509 3AB0F3          13      LD  A,(LINLEN)
000F6F D50C 67               4      LD  H,A
000F70 D50D 1600             7      LD  D,0
000F72 D50F 6A               4      LD  L,D ;0
000F73 D510 0608             7      LD  B,8
       D512                     LOC2:
000F75 D512 29              11      ADD HL,HL
000F76 D513 3001            12      JR  NC,LOC3
000F78 D515 19              11      ADD HL,DE
       D516                     LOC3:
000F79 D516 10FA            13      DJNZ    LOC2
000F7B D518 09              11      ADD HL,BC
000F7C D519 C9              10      RET
                                
       D51A                     CALSLT_R:
000F7D D51A FDE5            15      PUSH    IY
000F7F D51C FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000F83 D520 CD1C00          17      CALL    _CALSLT
000F86 D523 FDE1            14      POP IY
000F88 D525 C9              10      RET
                                
                                ;
                                ; インタースロットコール
                                ; ページ3 に配置
                                
       4F89                     AT_GETSLT   EQU 04000H+$$
                                
                                ;
                                ;   現在のスロットを知る
                                ;in
                                ;HL←上位2ビットで切り替えるページを指定
                                ;out
                                ;A→スロット
                                ;※ROM、RAMの両方のルーチンを使うため絶対番地を使わない
       D526                     _GETSLT:
000F89 D526 E5              11      PUSH    HL
000F8A D527 DBA8            11      IN  A,(0A8H)
                                
000F8C D529 CB7C             8      BIT 7,H
000F8E D52B 2032            12      JR  NZ,GETSLT_HIGH
000F90 D52D CB74             8      BIT 6,H
000F92 D52F 21C1FC          10      LD  HL,EXPTBL
000F95 D532 201B            12      JR  NZ,GETSLT_40H
       D534                     GETSLT_00H:             ;ページ0
000F97 D534 E603             7      AND 3
000F99 D536 85               4      ADD A,L
000F9A D537 6F               4      LD  L,A
000F9B D538 CB7E            13      BIT 7,(HL)
000F9D D53A 280F            12      JR  Z,GETSLT_1
000F9F D53C C604             7      ADD A,SLTTBL-EXPTBL     ;拡張スロットをワークアリアから取得
000FA1 D53E 6F               4      LD  L,A
000FA2 D53F 7E               7      LD  A,(HL)
       D540                     GETSLT_3:
000FA3 D540 07               4      RLCA
000FA4 D541 07               4      RLCA
       D542                     GETSLT_2:
000FA5 D542 E60C             7      AND 00CH
000FA7 D544 67               4      LD  H,A
000FA8 D545 7D               4      LD  A,L
000FA9 D546 D645             7      SUB LOW SLTTBL - 080H
000FAB D548 B4               4      OR  H
000FAC D549 E1              10      POP HL
000FAD D54A C9              10      RET
       D54B                     GETSLT_1:               ;スロットは拡張されていない
000FAE D54B D6C1             7      SUB LOW EXPTBL
000FB0 D54D E1              10      POP HL
000FB1 D54E C9              10      RET
                                
       D54F                     GETSLT_40H:             ;ページ1
000FB2 D54F 0F               4      RRCA
000FB3 D550 0F               4      RRCA
000FB4 D551 E603             7      AND 3
000FB6 D553 85               4      ADD A,L
000FB7 D554 6F               4      LD  L,A
000FB8 D555 CB7E            13      BIT 7,(HL)
000FBA D557 28F2            12      JR  Z,GETSLT_1
000FBC D559 C604             7      ADD A,SLTTBL-EXPTBL
000FBE D55B 6F               4      LD  L,A
000FBF D55C 7E               7      LD  A,(HL)
000FC0 D55D 18E3            12      JR  GETSLT_2
                                
       D55F                     GETSLT_HIGH:
000FC2 D55F CB74             8      BIT 6,H
000FC4 D561 21C1FC          10      LD  HL,EXPTBL
000FC7 D564 2014            12      JR  NZ,GETSLT_C0H
       D566                     GETSLT_80H:             ;ページ2
000FC9 D566 0F               4      RRCA
000FCA D567 0F               4      RRCA
000FCB D568 0F               4      RRCA
000FCC D569 0F               4      RRCA
000FCD D56A E603             7      AND 3
000FCF D56C 85               4      ADD A,L
000FD0 D56D 6F               4      LD  L,A
000FD1 D56E CB7E            13      BIT 7,(HL)
000FD3 D570 28D9            12      JR  Z,GETSLT_1
000FD5 D572 C604             7      ADD A,SLTTBL-EXPTBL
000FD7 D574 6F               4      LD  L,A
000FD8 D575 7E               7      LD  A,(HL)
000FD9 D576 0F               4      RRCA
000FDA D577 0F               4      RRCA
000FDB D578 18C8            12      JR  GETSLT_2
                                
       D57A                     GETSLT_C0H:             ;ページ3
000FDD D57A 07               4      RLCA
000FDE D57B 07               4      RLCA
000FDF D57C E603             7      AND 3
000FE1 D57E 85               4      ADD A,L
000FE2 D57F 6F               4      LD  L,A
000FE3 D580 CB7E            13      BIT 7,(HL)
000FE5 D582 28C7            12      JR  Z,GETSLT_1
000FE7 D584 C604             7      ADD A,SLTTBL-EXPTBL
000FE9 D586 6F               4      LD  L,A
000FEA D587 7E               7      LD  A,(HL)
000FEB D588 07               4      RLCA
000FEC D589 07               4      RLCA
000FED D58A 18B4            12      JR  GETSLT_3
                                
       D58C                     SAME_SLOT_00H:          ;ページ0とページ3のスロットが同一
000FEF D58C D3A8            11      OUT (0A8H),A
000FF1 D58E 3AFFFF          13      LD  A,(0FFFFH)  ;拡張スロットの切り替え
000FF4 D591 2F               4      CPL
000FF5 D592 E6FC             7      AND 0FCH        ;ページ0マスク
000FF7 D594 B1               4      OR  C
000FF8 D595 32FFFF          13      LD  (0FFFFH),A
000FFB D598 77               7      LD  (HL),A
000FFC D599 C9              10      RET
                                
       D59A                     ENASLT_HIGH:
000FFD D59A CB74             8      BIT 6,H
000FFF D59C C0              11      RET NZ          ;ページ3はスロット切り替え不可
                                ;
                                ;ページ2専門のENASLT
                                ;in
                                ;A←スロット
                                ;破壊
                                ;ABCHL
                                ;
       D59D                     ENASLT_80H:
001000 D59D F3               4      DI
001001 D59E 6F               4      LD  L,A
001002 D59F E603             7      AND 3
001004 D5A1 07               4      RLCA
001005 D5A2 07               4      RLCA
001006 D5A3 07               4      RLCA
001007 D5A4 07               4      RLCA
001008 D5A5 4F               4      LD  C,A
001009 D5A6 DBA8            11      IN  A,(0A8H)
00100B D5A8 06CF             7      LD  B,0CFH  ;ページ2マスク
00100D D5AA A0               4      AND B
00100E D5AB B1               4      OR  C
00100F D5AC CB7D             8      BIT 7,L
001011 D5AE CA37D6          10      JP  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001014 D5B1 D5              11      PUSH    DE
001015 D5B2 CD15D6          17      CALL    ENATBL_BIOS_CHECK
001018 D5B5 07               4      RLCA
001019 D5B6 07               4      RLCA
00101A D5B7 4F               4      LD  C,A
00101B D5B8 7B               4      LD  A,E
00101C D5B9 CD3B00          17      CALL    ENASUB
00101F D5BC 73               7      LD  (HL),E
001020 D5BD D1              10      POP DE
001021 D5BE C9              10      RET
                                ;
                                ;ENASLT
                                ;in
                                ;A←スロット
                                ;HL←上位2ビットで切り替えるページを指定
                                ;破壊
                                ;ABCHL
                                ;
       D5BF                     ENASLT:
001022 D5BF CB7C             8      BIT 7,H
001024 D5C1 20D7            12      JR  NZ,ENASLT_HIGH
001026 D5C3 CB74             8      BIT 6,H
001028 D5C5 2073            12      JR  NZ,ENASLT_40H
       D5C7                     _ENASLT_00H:
00102A D5C7 F3               4      DI
00102B D5C8 67               4      LD  H,A
00102C D5C9 E603             7      AND 3
00102E D5CB 4F               4      LD  C,A
00102F D5CC DBA8            11      IN  A,(0A8H)
001031 D5CE E6FC             7      AND 0FCH    ;ページ0マスク
001033 D5D0 B1               4      OR  C
001034 D5D1 CB7C             8      BIT 7,H
001036 D5D3 2862            12      JR  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
001038 D5D5 D5              11      PUSH    DE
001039 D5D6 44               4      LD  B,H
00103A D5D7 CD1FD6          17      CALL    ENATBL
00103D D5DA 0F               4      RRCA
00103E D5DB 0F               4      RRCA
00103F D5DC 4F               4      LD  C,A
001040 D5DD 7B               4      LD  A,E
001041 D5DE BA               4      CP  D
001042 D5DF D1              10      POP DE
001043 D5E0 28AA            12      JR  Z,SAME_SLOT_00H ;ページ0とページ3のスロットが同一の場合
001045 D5E2 60               4      LD  H,B
       D5E3                     ENASLT_SUB:
001046 D5E3 7C               4      LD  A,H     ;ページ3でスロットを指定するためにページ1のROMのルーチンを使う
001047 D5E4 DDE5            15      PUSH    IX
001049 D5E6 DD21E240        14      LD  IX,ENASLT_00H
       D5EA                     INT38H_SUB1:
00104D D5EA FDE5            15      PUSH    IY
00104F D5EC FD2A61E6        20      LD  IY,(ROM_SLT-1)
001053 D5F0 CD67D6          17      CALL    CALSLT
001056 D5F3 FDE1            14      POP IY
001058 D5F5 DDE1            14      POP IX
00105A D5F7 C9              10      RET
                                
       D5F8                     _ENASLT_00H_S:
00105B D5F8 ED7303D6        20      LD  (ENASLT_SP1),SP
00105F D5FC 315DF5          10      LD  SP,SPBUF
001062 D5FF CDE3D5          17      CALL    ENASLT_SUB
001065 D602 310000          10      LD  SP,0
       D603                     ENASLT_SP1  EQU $-2
001068 D605 C9              10      RET
                                
       D606                     INT38H_SUB:
001069 D606 DDE5            15      PUSH    IX
00106B D608 DD21D640        14      LD  IX,INT38H_ROM
00106F D60C 18DC            12      JR  INT38H_SUB1
                                
       D60E                     ENASLT_BIOS:
001071 D60E D1              10      POP DE
001072 D60F 7D               4      LD  A,L
001073 D610 CD2400          17      CALL    _ENASLT
001076 D613 D1              10      POP DE
001077 D614 C9              10      RET
                                
       D615                     ENATBL_BIOS_CHECK:
001078 D615 57               4      LD  D,A
001079 D616 3A0000          13      LD  A,(0000H)
00107C D619 FEF3             7      CP  0F3H    ;0000H が DI の場合はページ0は BIOS とみなす
00107E D61B 28F1            12      JR  Z,ENASLT_BIOS
001080 D61D 65               4      LD  H,L
001081 D61E 7A               4      LD  A,D
       D61F                     ENATBL:
001082 D61F 57               4      LD  D,A ;基本スロットに出力する値
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
001083 D620 7C               4      LD  A,H
001084 D621 E603             7      AND 3
001086 D623 4F               4      LD  C,A ;C=スロット#
                                
                                    ;スロットテーブル
001087 D624 2EC5             7      LD  L,LOW SLTTBL
001089 D626 85               4      ADD A,L
00108A D627 6F               4      LD  L,A
                                            ;対象の拡張スロットを切り替えるために基本スロットを切り替える
00108B D628 79               4      LD  A,C ;C=スロット#
00108C D629 0F               4      RRCA
00108D D62A 0F               4      RRCA        ;ページ3
00108E D62B 4F               4      LD  C,A
00108F D62C 7A               4      LD  A,D ;基本スロットに出力する値
001090 D62D E63F             7      AND 03FH    ;ページ3マスク
001092 D62F B1               4      OR  C
001093 D630 5F               4      LD  E,A ;基本スロットでページ3にスロットを割り当てる
001094 D631 7C               4      LD  A,H
001095 D632 E60C             7      AND 00CH
001097 D634 26FC             7      LD  H,HIGH SLTTBL
001099 D636 C9              10      RET
       D637                     ENASLT_NOEXT_00H:
                                
       D637                     ENASLT_NOEXT:               ;スロットが拡張されていない場合
00109A D637 D3A8            11      OUT (0A8H),A
00109C D639 C9              10      RET
                                
                                ;
                                ;ページ1専門のENASLT
                                ;in
                                ;A←スロット
                                ;破壊
                                ;ABCHL
                                ;
       D63A                     ENASLT_40H:
00109D D63A F3               4      DI
00109E D63B 6F               4      LD  L,A
00109F D63C E603             7      AND 3
0010A1 D63E 07               4      RLCA
0010A2 D63F 07               4      RLCA
0010A3 D640 4F               4      LD  C,A
0010A4 D641 DBA8            11      IN  A,(0A8H)
0010A6 D643 06F3             7      LD  B,0F3H  ;ページ1マスク
0010A8 D645 A0               4      AND B
0010A9 D646 B1               4      OR  C
0010AA D647 CB7D             8      BIT 7,L
0010AC D649 28EC            12      JR  Z,ENASLT_NOEXT
                                            ;拡張スロットの処理
0010AE D64B D5              11      PUSH    DE
0010AF D64C CD15D6          17      CALL    ENATBL_BIOS_CHECK
0010B2 D64F 4F               4      LD  C,A
0010B3 D650 7B               4      LD  A,E
0010B4 D651 CD3B00          17      CALL    ENASUB
0010B7 D654 73               7      LD  (HL),E
0010B8 D655 D1              10      POP DE
0010B9 D656 C9              10      RET
                                
       D657                     CALLF:
0010BA D657 E3              19      EX  (SP),HL
0010BB D658 F5              11      PUSH    AF
0010BC D659 7E               7      LD  A,(HL)
0010BD D65A FD67             9      LD  IYH,A
0010BF D65C 23               6      INC HL
0010C0 D65D 7E               7      LD  A,(HL)
0010C1 D65E DD6F             9      LD  IXL,A
0010C3 D660 23               6      INC HL
0010C4 D661 7E               7      LD  A,(HL)
0010C5 D662 DD67             9      LD  IXH,A
0010C7 D664 23               6      INC HL
0010C8 D665 F1              10      POP AF
0010C9 D666 E3              19      EX  (SP),HL
       D667                     CALSLT:
0010CA D667 F3               4      DI
0010CB D668 08               4      EX  AF,AF'
0010CC D669 F5              11      PUSH    AF      ;裏AFを保存
0010CD D66A E5              11      PUSH    HL
0010CE D66B 210280          10      LD  HL,08002H
0010D1 D66E 39              11      ADD HL,SP
0010D2 D66F E1              10      POP HL
0010D3 D670 3007            12      JR  NC,CALSLT_1
0010D5 D672 CD88D6          17      CALL    CALSLT_2
       D675                     CALSLT_E:
0010D8 D675 08               4      EX  AF,AF'
0010D9 D676 F1              10      POP AF      ;保存した裏AF
0010DA D677 08               4      EX  AF,AF'
0010DB D678 C9              10      RET
       D679                     CALSLT_1:
0010DC D679 ED7384D6        20      LD  (CSSP),SP
0010E0 D67D 315DF5          10      LD  SP,SPBUF
0010E3 D680 CD88D6          17      CALL    CALSLT_2
0010E6 D683 310000          10      LD  SP,0
       D684                     CSSP    EQU $-2
0010E9 D686 18ED            12      JR  CALSLT_E
                                
       D688                     CALSLT_2:
0010EB D688 E5              11      PUSH    HL
0010EC D689 DD7C             9      LD  A,IXH
0010EE D68B 67               4      LD  H,A
0010EF D68C CD26D5          17      CALL    _GETSLT
0010F2 D68F FDBC            10      CP  IYH
0010F4 D691 281E            12      JR  Z,CALSLT_3
0010F6 D693 C5              11      PUSH    BC
0010F7 D694 F5              11      PUSH    AF
0010F8 D695 FD7C             9      LD  A,IYH
0010FA D697 CDBFD5          17      CALL    ENASLT
0010FD D69A F1              10      POP AF
0010FE D69B C1              10      POP BC
0010FF D69C 6F               4      LD  L,A
001100 D69D DD7C             9      LD  A,IXH
001102 D69F 67               4      LD  H,A
001103 D6A0 E3              19      EX  (SP),HL
001104 D6A1 08               4      EX  AF,AF'
001105 D6A2 CD98F3          17      CALL    JP_IX
001108 D6A5 E3              19      EX  (SP),HL
001109 D6A6 C5              11      PUSH    BC
00110A D6A7 08               4      EX  AF,AF'
00110B D6A8 7D               4      LD  A,L
00110C D6A9 CDBFD5          17      CALL    ENASLT
00110F D6AC 08               4      EX  AF,AF'
001110 D6AD C1              10      POP BC
001111 D6AE E1              10      POP HL
001112 D6AF FB               4      EI
001113 D6B0 C9              10      RET
                                
       D6B1                     CALSLT_3:
001114 D6B1 E1              10      POP HL
001115 D6B2 08               4      EX  AF,AF'
001116 D6B3 DDE9             8      JP  (IX)
                                
       D6B5                     RDSLT:
001118 D6B5 F3               4      DI
001119 D6B6 D5              11      PUSH    DE
00111A D6B7 57               4      LD  D,A
00111B D6B8 CD26D5          17      CALL    _GETSLT
00111E D6BB BA               4      CP  D
00111F D6BC 2812            12      JR  Z,RDSLT1
001121 D6BE 5F               4      LD  E,A
001122 D6BF 7A               4      LD  A,D
001123 D6C0 E5              11      PUSH    HL
001124 D6C1 CDBFD5          17      CALL    ENASLT
001127 D6C4 E1              10      POP HL
001128 D6C5 46               7      LD  B,(HL)
001129 D6C6 C5              11      PUSH    BC
00112A D6C7 7B               4      LD  A,E
00112B D6C8 E5              11      PUSH    HL
00112C D6C9 CDBFD5          17      CALL    ENASLT
00112F D6CC E1              10      POP HL
001130 D6CD F1              10      POP AF
001131 D6CE D1              10      POP DE
001132 D6CF C9              10      RET
       D6D0                     RDSLT1:
001133 D6D0 7E               7      LD  A,(HL)
001134 D6D1 D1              10      POP DE
001135 D6D2 C9              10      RET
                                
       D6D3                     WRSLT:
001136 D6D3 F3               4      DI
001137 D6D4 D5              11      PUSH    DE
001138 D6D5 57               4      LD  D,A
001139 D6D6 CD26D5          17      CALL    _GETSLT
00113C D6D9 BA               4      CP  D
00113D D6DA 2810            12      JR  Z,WRSLT1
00113F D6DC F5              11      PUSH    AF
001140 D6DD E5              11      PUSH    HL
001141 D6DE 7A               4      LD  A,D
001142 D6DF CDBFD5          17      CALL    ENASLT
001145 D6E2 E1              10      POP HL
001146 D6E3 73               7      LD  (HL),E
001147 D6E4 F1              10      POP AF
001148 D6E5 E5              11      PUSH    HL
001149 D6E6 CDBFD5          17      CALL    ENASLT
00114C D6E9 E1              10      POP HL
00114D D6EA D1              10      POP DE
00114E D6EB C9              10      RET
                                
       D6EC                     WRSLT1:
00114F D6EC 73               7      LD  (HL),E
001150 D6ED D1              10      POP DE
001151 D6EE C9              10      RET
                                
       D6EF                     INT38H:
001152 D6EF F3               4      DI
001153 D6F0 F5              11      PUSH    AF
001154 D6F1 C5              11      PUSH    BC
001155 D6F2 E5              11      PUSH    HL
001156 D6F3 210280          10      LD  HL,08002H
001159 D6F6 39              11      ADD HL,SP
00115A D6F7 380E            12      JR  C,INT38H1
00115C D6F9 ED7304D7        20      LD  (INTSP),SP  ;スタックポインタ保存
001160 D6FD 315DF5          10      LD  SP,SPBUF
001163 D700 CD06D6          17      CALL    INT38H_SUB
001166 D703 310000          10      LD  SP,0
       D704                     INTSP   EQU $-2
001169 D706 AF               4      XOR A
       D707                     INT38H1:
00116A D707 DC06D6          17      CALL    C,INT38H_SUB
00116D D70A E1              10      POP HL
00116E D70B C1              10      POP BC
00116F D70C F1              10      POP AF
001170 D70D FB               4      EI
001171 D70E C9              10      RET
[EOF:MSXIO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       D70F                     FILEC:
001172 D70F CD1AD7          17      CALL    FILE
       D712                     FILEC2:
001175 D712 3A15E6          13      LD  A,(FDRV+1)
001178 D715 FE20             7      CP  020H
00117A D717 C8              11      RET Z
00117B D718 1839            12      JR  SETDIR1
                                
       D71A                     FILE:
00117D D71A AF               4      XOR A
00117E D71B 3214E6          13      LD  (FDRV),A
001181 D71E 67               4      LD  H,A
001182 D71F 6F               4      LD  L,A
001183 D720 2222E6          16      LD  (FDRV+14),HL
001186 D723 CDF0D7          17      CALL    SPCUT
001189 D726 CDD5D7          17      CALL    CCHK3
00118C D729 2812            12      JR  Z,DEVI1
00118E D72B 13               6      INC DE
00118F D72C 1A               7      LD  A,(DE)
001190 D72D 1B               6      DEC DE
001191 D72E FE3A             7      CP  ':'
001193 D730 200B            12      JR  NZ,DEVI1
001195 D732 1A               7      LD  A,(DE)      ;DRIVE
001196 D733 CD36DA          17      CALL    CAP
001199 D736 D640             7      SUB '@'
00119B D738 13               6      INC DE
00119C D739 13               6      INC DE
00119D D73A 3214E6          13      LD  (FDRV),A
       D73D                     DEVI1:
0011A0 D73D 1A               7      LD  A,(DE)
0011A1 D73E D65C             7      SUB 05CH        ;\
0011A3 D740 2009            12      JR  NZ,NOROOT
0011A5 D742 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
0011A6 D743 222EE6          16      LD  (FDRV+26),HL
0011A9 D746 2C               4      INC L
0011AA D747 2222E6          16      LD  (FDRV+14),HL
0011AD D74A 13               6      INC DE
       D74B                     NOROOT:
                                
       D74B                     SETDIR:
0011AE D74B CD76D7          17      CALL    FILED
0011B1 D74E 1A               7      LD  A,(DE)
0011B2 D74F FE5C             7      CP  05CH        ;\
0011B4 D751 C0              11      RET NZ
0011B5 D752 13               6      INC DE
       D753                     SETDIR1:
0011B6 D753 3E10             7      LD  A,010H      ;Directory
0011B8 D755 3221E6          13      LD  (FDRV+13),A
0011BB D758 D5              11      PUSH    DE
0011BC D759 1114E6          10      LD  DE,FDRV
0011BF D75C 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
0011C1 D75E CDD5CF          17      CALL    BDOS0
0011C4 D761 D1              10      POP DE
0011C5 D762 B7               4      OR  A
0011C6 D763 C0              11      RET NZ
                                
0011C7 D764 3A21E6          13      LD  A,(FDRV+13)
0011CA D767 E610             7      AND 010H        ;ディレクトリ
0011CC D769 C8              11      RET Z
                                
0011CD D76A CDBDD7          17      CALL    FILEI
0011D0 D76D 2A2EE6          16      LD  HL,(FDRV+26)
0011D3 D770 23               6      INC HL
0011D4 D771 2222E6          16      LD  (FDRV+14),HL
0011D7 D774 18D5            12      JR  SETDIR
                                
       D776                     FILED:
0011D9 D776 CDBDD7          17      CALL    FILEI
0011DC D779 2115E6          10      LD  HL,FNAME
                                
0011DF D77C 0608             7      LD  B,8
       D77E                     FILE2:
0011E1 D77E CDCAD7          17      CALL    CCHKF
0011E4 D781 C8              11      RET Z
0011E5 D782 FE2A             7      CP  '*'
0011E7 D784 282E            12      JR  Z,FILE9
0011E9 D786 FE2E             7      CP  '.'
0011EB D788 280C            12      JR  Z,FILE4
0011ED D78A 77               7      LD  (HL),A
0011EE D78B 23               6      INC HL
0011EF D78C 10F0            13      DJNZ    FILE2
                                
       D78E                     FILE3:
0011F1 D78E CDCAD7          17      CALL    CCHKF
0011F4 D791 C8              11      RET Z
0011F5 D792 FE2E             7      CP  '.'
0011F7 D794 20F8            12      JR  NZ,FILE3
                                
       D796                     FILE4:
0011F9 D796 211DE6          10      LD  HL,FNAME+8
0011FC D799 0603             7      LD  B,3
                                
       D79B                     FILE4L:
0011FE D79B CDCAD7          17      CALL    CCHKF
001201 D79E C8              11      RET Z
001202 D79F FE2E             7      CP  '.'
001204 D7A1 2008            12      JR  NZ,FILE12
001206 D7A3 3215E6          13      LD  (FNAME),A   ;Parent directory(..)
001209 D7A6 3216E6          13      LD  (FNAME+1),A
00120C D7A9 3E20             7      LD  A,020H
       D7AB                     FILE12:
00120E D7AB FE2A             7      CP  '*'
001210 D7AD 280A            12      JR  Z,FILE10
001212 D7AF 77               7      LD  (HL),A
001213 D7B0 23               6      INC HL
001214 D7B1 10E8            13      DJNZ    FILE4L
001216 D7B3 C9              10      RET
                                
       D7B4                     FILE9:              ;名前の*処理、名前の残りを?で埋める
001217 D7B4 CDB9D7          17      CALL    FILE10
00121A D7B7 18D5            12      JR  FILE3
                                
       D7B9                     FILE10:
00121C D7B9 3E3F             7      LD  A,'?'
00121E D7BB 1808            12      JR  FILL_MEMORY
       D7BD                     FILEI:              ;名前＋拡張子をスペースで初期化
001220 D7BD 3E20             7      LD  A,020H
001222 D7BF 01000B          10      LD  BC,11*256   ;C=0にしておく
001225 D7C2 2115E6          10      LD  HL,FNAME
       D7C5                     FILL_MEMORY:            ;HLからBバイトAで埋める
001228 D7C5 77               7      LD  (HL),A
001229 D7C6 23               6      INC HL
00122A D7C7 10FC            13      DJNZ    FILL_MEMORY
00122C D7C9 C9              10      RET
                                
       D7CA                     CCHKF:
00122D D7CA 1A               7      LD  A,(DE)
00122E D7CB CDD2D7          17      CALL    CCHK2
001231 D7CE C8              11      RET Z
001232 D7CF C33EDB          10      JP  FKAN
                                
       D7D2                     CCHK2:
001235 D7D2 0C               4      INC C
001236 D7D3 0D               4      DEC C
001237 D7D4 C0              11      RET NZ
       D7D5                     CCHK3:              ;ZF=1 で使えない文字
001238 D7D5 FE2B             7      CP  '+'
00123A D7D7 C8              11      RET Z
00123B D7D8 FE2C             7      CP  ','
00123D D7DA C8              11      RET Z
00123E D7DB FE2F             7      CP  '/'
001240 D7DD C8              11      RET Z
001241 D7DE FE3A             7      CP  ':'
001243 D7E0 C8              11      RET Z
001244 D7E1 FE3B             7      CP  ';'
001246 D7E3 C8              11      RET Z
001247 D7E4 FE3D             7      CP  '='
001249 D7E6 C8              11      RET Z
00124A D7E7 FE5C             7      CP  05CH    ;\
00124C D7E9 C8              11      RET Z
00124D D7EA FE20             7      CP  020H
00124F D7EC D0              11      RET NC
001250 D7ED BF               4      CP  A       ;Z=1
001251 D7EE C9              10      RET
                                
       D7EF                     SS1:
001252 D7EF 13               6      INC DE
       D7F0                     SPCUT:              ;スペースをカット
001253 D7F0 1A               7      LD  A,(DE)
001254 D7F1 FE20             7      CP  020H
001256 D7F3 28FA            12      JR  Z,SS1
001258 D7F5 C9              10      RET
                                
       D7F6                     SETDRVF:
001259 D7F6 1114E6          10      LD  DE,FDRV
       D7F9                     SETDRV0:
00125C D7F9 CD02D8          17      CALL    SETDRV
00125F D7FC FDE1            14      POP IY
001261 D7FE C1              10      POP BC
001262 D7FF D1              10      POP DE
001263 D800 E1              10      POP HL
001264 D801 C9              10      RET
                                
       D802                     SETDRV:
001265 D802 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
001266 D803 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
001267 D804 C5              11      PUSH    BC
001268 D805 1A               7      LD  A,(DE)
001269 D806 D5              11      PUSH    DE
00126A D807 FDE3            23      EX  (SP),IY
                                
00126C D809 CD10D8          17      CALL    GETDRV
00126F D80C CDD9E6          17      CALL    _CHGDRV
                                
001272 D80F E9               4      JP  (HL)
                                
       D810                     GETDRV:
001273 D810 CD23D8          17      CALL    GETDRV1
001276 D813 3288E6          13      LD  (_DRV),A
001279 D816 C9              10      RET
                                
       D817                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
00127A D817 CD23D8          17      CALL    GETDRV1
00127D D81A C5              11      PUSH    BC
00127E D81B 4F               4      LD  C,A
00127F D81C 1A               7      LD  A,(DE)
001280 D81D CD23D8          17      CALL    GETDRV1
001283 D820 A9               4      XOR C
001284 D821 C1              10      POP BC
001285 D822 C9              10      RET
       D823                     GETDRV1:
001286 D823 E67F             7      AND 07FH
001288 D825 D601             7      SUB 001H
00128A D827 D0              11      RET NC
00128B D828 3A0400          13      LD  A,(_DVSW)   ;Current Drive
00128E D82B C9              10      RET
                                
       D82C                     SOPENX:
00128F D82C 1139E6          10      LD  DE,SFILE
001292 D82F FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
001295 D832 CD17D8          17      CALL    IS_SAME_DRV_A_DE
001298 D835 2024            12      JR  NZ,SOPEN
00129A D837 13               6      INC DE
00129B D838 FDE5            15      PUSH    IY
00129D D83A E1              10      POP HL
00129E D83B 23               6      INC HL
00129F D83C CDC7D9          17      CALL    CPFILE
0012A2 D83F 201A            12      JR  NZ,SOPEN
                                
0012A4 D841 2AF4E7          16      LD  HL,(SCDIR)
0012A7 D844 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0012AA D847 FD740F          19      LD  (IY+15),H
                                
0012AD D84A 2AF8E7          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
0012B0 D84D 229FE6          16      LD  (_FILEN),HL
                                
0012B3 D850 ED5BF6E7        20      LD  DE,(SFBPS)
0012B7 D854 2139E6          10      LD  HL,SFILE
0012BA D857 36FF            10      LD  (HL),0FFH
0012BC D859 23               6      INC HL
0012BD D85A C9              10      RET
       D85B                     SOPEN:
0012BE D85B 216FD9          10      LD  HL,FILESE
       D85E                     SOPENC:
0012C1 D85E 2297D8          16      LD  (OPENPAT),HL
                                
0012C4 D861 CDE2E6          17      CALL    _RDFATX     ;Detect Media
0012C7 D864 3856            12      JR  C,RDDERR
                                
0012C9 D866 AF               4      XOR A
0012CA D867 329FE6          13      LD  (_FILEN),A
0012CD D86A CD73DA          17      CALL    LDDIRX1     ;A=0で呼び出す
0012D0 D86D 2818            12      JR  Z,SDIRX1
                                
0012D2 D86F CD60D9          17      CALL    READ_DIR    ;Sub Directory
0012D5 D872 3808            12      JR  C,SDIRX0
0012D7 D874 2A7EE7          16      LD  HL,(_DTBUF)
0012DA D877 7E               7      LD  A,(HL)
0012DB D878 FE2E             7      CP  '.'
0012DD D87A 280F            12      JR  Z,SOPEN1
       D87C                     SDIRX0:
0012DF D87C AF               4      XOR A
0012E0 D87D 32A0E6          13      LD  (_DIRF),A
0012E3 D880 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
0012E7 D884 FD770F          19      LD  (IY+15),A
       D887                     SDIRX1:
0012EA D887 ED5BFCE7        20      LD  DE,(_DIRPS) ;Root Directory
       D88B                     SOPEN1:
0012EE D88B 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       D88C                     SDECPAT EQU $-1
       D88D                     SOPEN1X:
0012F0 D88D CD60D9          17      CALL    READ_DIR    ;FILE SEARCH
0012F3 D890 382A            12      JR  C,RDDERR
0012F5 D892 2A7EE7          16      LD  HL,(_DTBUF)
       D895                     SOPEN2:
0012F8 D895 D5              11      PUSH    DE
0012F9 D896 CD6FD9          17      CALL    FILESE      ;(self-modifying code)
       D897                     OPENPAT EQU $-2
0012FC D899 D1              10      POP DE
0012FD D89A 386D            12      JR  C,SOPENE
0012FF D89C 281B            12      JR  Z,SCF_FF_RET
       D89E                     SOPEN3:
001301 D89E 3AA0E6          13      LD  A,(_DIRF)   ;ディレクトリか判別
001304 D8A1 B7               4      OR  A
001305 D8A2 200C            12      JR  NZ,SOPEN5
001307 D8A4 13               6      INC DE      ;ルートディレクトリ
001308 D8A5 E5              11      PUSH    HL
001309 D8A6 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       D8A7                     MD_PAT  EQU $-2
00130C D8A9 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
00130E D8AB E1              10      POP HL
00130F D8AC 20DD            12      JR  NZ,SOPEN1
001311 D8AE 1807            12      JR  SOPEN6
       D8B0                     SOPEN5:
001313 D8B0 CD7AE1          17      CALL    GNCLX       ;END DIR
001316 D8B3 D8              11      RET C
001317 D8B4 CD27DA          17      CALL    ENDCL
       D8B7                     SOPEN6:
00131A D8B7 38D2            12      JR  C,SOPEN1
       D8B9                     SCF_FF_RET:
00131C D8B9 37               4      SCF         ;CF=1
00131D D8BA 9F               4      SBC A,A     ;A=0FFH
00131E D8BB C9              10      RET
                                
       D8BC                     RDDERR:
00131F D8BC BF               4      CP  A       ;READ ERR CF=1 ZF=1
001320 D8BD 37               4      SCF
001321 D8BE C9              10      RET
                                
       D8BF                     NOPEN:
001322 D8BF 216FD9          10      LD  HL,FILESE
001325 D8C2 2297D8          16      LD  (OPENPAT),HL
001328 D8C5 FD2A98E6        20      LD  IY,(_FCB)
00132C D8C9 CD51DB          17      CALL    CHKWILDX
00132F D8CC 30EB            12      JR  NC,SCF_FF_RET
001331 D8CE FD7E00          19      LD  A,(IY+0)
001334 D8D1 CD10D8          17      CALL    GETDRV
001337 D8D4 CDD9E6          17      CALL    _CHGDRV
00133A D8D7 D8              11      RET C
00133B D8D8 2AF8E7          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
00133E D8DB 229FE6          16      LD  (_FILEN),HL
                                
001341 D8DE CD6EDA          17      CALL    LDDIRX
001344 D8E1 ED5B9AE6        20      LD  DE,(_FBPS)
001348 D8E5 CD60D9          17      CALL    READ_DIR
00134B D8E8 38D2            12      JR  C,RDDERR
00134D D8EA 3A9EE6          13      LD  A,(_FBCNT)
001350 D8ED 3D               4      DEC A
001351 D8EE 28AE            12      JR  Z,SOPEN3
       D8F0                     NOPEN2:
001353 D8F0 2A9CE6          16      LD  HL,(_FBAD)
001356 D8F3 012000          10      LD  BC,020H
001359 D8F6 09              11      ADD HL,BC
00135A D8F7 4F               4      LD  C,A
00135B D8F8 189B            12      JR  SOPEN2
                                
       D8FA                     SOPENE2:
00135D D8FA 229CE6          16      LD  (_FBAD),HL
001360 D8FD 79               4      LD  A,C
001361 D8FE 329EE6          13      LD  (_FBCNT),A
001364 D901 ED539AE6        20      LD  (_FBPS),DE
001368 D905 FD2298E6        20      LD  (_FCB),IY
       D909                     SOPENE:
00136C D909 AF               4      XOR A
00136D D90A C9              10      RET
                                
       D90B                     COPEN:
00136E D90B FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
001372 D90F 218CD9          10      LD  HL,NEXTSE
001375 D912 CD5ED8          17      CALL    SOPENC
001378 D915 D0              11      RET NC
001379 D916 C8              11      RET Z
00137A D917 3AA0E6          13      LD  A,(_DIRF)   ;ディレクトリか判別
00137D D91A B7               4      OR  A
00137E D91B 37               4      SCF
00137F D91C C8              11      RET Z       ;ルートディレクトリ
001380 D91D 0601             7      LD  B,1
001382 D91F CDB0DB          17      CALL    WRDF
001385 D922 D8              11      RET C
001386 D923 ED5BFEE7        20      LD  DE,(_CLPS)
00138A D927 D5              11      PUSH    DE
00138B D928 CDF0D9          17      CALL    DCPAT
00138E D92B CDFBDF          17      CALL    DRDNX
001391 D92E 2A7EE7          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
001394 D931 ED4BE6DE        20      LD  BC,(SECSZ)  ;1セクタのサイズ
001398 D935 AF               4      XOR A
       D936                     COPENCL:
001399 D936 77               7      LD  (HL),A
00139A D937 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00139C D939 EA36D9          10      JP  PE,COPENCL
                                
00139F D93C 3A0EDA          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
0013A2 D93F 3D               4      DEC A
0013A3 D940 2819            12      JR  Z,COPENE
0013A5 D942 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
0013A7 D944 3272E1          13      LD  (_SECPS),A
0013AA D947 D1              10      POP DE      ;DE=(_CLPS)
0013AB D948 D5              11      PUSH    DE
       D949                     COPEN1:
0013AC D949 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
0013AD D94A C5              11      PUSH    BC
0013AE D94B 2A7EE7          16      LD  HL,(_DTBUF)
0013B1 D94E CD0ADA          17      CALL    CLUSTX
0013B4 D951 CD11E3          17      CALL    DWT24
0013B7 D954 C1              10      POP BC
0013B8 D955 D1              10      POP DE
0013B9 D956 CD71E1          17      CALL    NEXTX
0013BC D959 20EE            12      JR  NZ,COPEN1
       D95B                     COPENE:
0013BE D95B 2A7EE7          16      LD  HL,(_DTBUF)
0013C1 D95E D1              10      POP DE
0013C2 D95F C9              10      RET
                                
       D960                     READ_DIR:
0013C3 D960 ED53FEE7        20      LD  (_CLPS),DE
0013C7 D964 C5              11      PUSH    BC
0013C8 D965 D5              11      PUSH    DE
0013C9 D966 CDF0D9          17      CALL    DCPAT
0013CC D969 CDDBDF          17      CALL    DRDX
0013CF D96C D1              10      POP DE
0013D0 D96D C1              10      POP BC
0013D1 D96E C9              10      RET
                                
       D96F                     FILESE:
0013D2 D96F 7E               7      LD  A,(HL)
0013D3 D970 B7               4      OR  A
0013D4 D971 C8              11      RET Z       ;END:ZF=1 CF=0
0013D5 D972 FEE5             7      CP  0E5H
0013D7 D974 280E            12      JR  Z,FILESE1
0013D9 D976 FDE5            15      PUSH    IY
0013DB D978 D1              10      POP DE
0013DC D979 13               6      INC DE
0013DD D97A E5              11      PUSH    HL
0013DE D97B CDC7D9          17      CALL    CPFILE
0013E1 D97E CCE8D9          17      CALL    Z,CPFILE2
0013E4 D981 E1              10      POP HL
0013E5 D982 37               4      SCF
0013E6 D983 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       D984                     FILESE1:
0013E7 D984 CD9BD9          17      CALL    FNEXT
0013EA D987 20E6            12      JR  NZ,FILESE
       D989                     ZF0_CF0_AFF_RET:
0013EC D989 F6FF             7      OR  0FFH        ;ZF=0 CF=0
0013EE D98B C9              10      RET
                                
       D98C                     NEXTSE:
0013EF D98C 7E               7      LD  A,(HL)
0013F0 D98D B7               4      OR  A
0013F1 D98E 37               4      SCF
0013F2 D98F C8              11      RET Z       ;!!!:ZF=1 CF=1
0013F3 D990 FEE5             7      CP  0E5H
0013F5 D992 37               4      SCF
0013F6 D993 C8              11      RET Z       ;!!!:(ZF=1) CF=1
0013F7 D994 CD9BD9          17      CALL    FNEXT
0013FA D997 20F3            12      JR  NZ,NEXTSE
0013FC D999 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       D99B                     FNEXT:
0013FE D99B E5              11      PUSH    HL
0013FF D99C 219FE6          10      LD  HL,_FILEN
001402 D99F 34              11      INC (HL)
001403 D9A0 E1              10      POP HL
001404 D9A1 112000          10      LD  DE,020H
001407 D9A4 19              11      ADD HL,DE
001408 D9A5 0D               4      DEC C
001409 D9A6 C9              10      RET
                                
       D9A7                     CPNAME:
00140A D9A7 C5              11      PUSH    BC
00140B D9A8 D5              11      PUSH    DE
00140C D9A9 E5              11      PUSH    HL
00140D D9AA CDC1D9          17      CALL    CPFILE4
001410 D9AD E1              10      POP HL
001411 D9AE 23               6      INC HL
001412 D9AF 23               6      INC HL
001413 D9B0 23               6      INC HL
001414 D9B1 23               6      INC HL
001415 D9B2 D1              10      POP DE
001416 D9B3 C1              10      POP BC
001417 D9B4 2005            12      JR  NZ,CPNAME1
001419 D9B6 7E               7      LD  A,(HL)
00141A D9B7 23               6      INC HL
00141B D9B8 66               7      LD  H,(HL)
00141C D9B9 6F               4      LD  L,A
00141D D9BA C9              10      RET
       D9BB                     CPNAME1:
00141E D9BB 23               6      INC HL
00141F D9BC 23               6      INC HL
001420 D9BD 10E8            13      DJNZ    CPNAME
001422 D9BF 37               4      SCF
001423 D9C0 C9              10      RET
                                
       D9C1                     CPFILE4:
001424 D9C1 C5              11      PUSH    BC
001425 D9C2 010004          10      LD  BC,00400H
001428 D9C5 1804            12      JR  CPSTR1
       D9C7                     CPFILE:
00142A D9C7 C5              11      PUSH    BC
00142B D9C8 01000B          10      LD  BC,00B00H
       D9CB                     CPSTR1:
00142E D9CB 1A               7      LD  A,(DE)
00142F D9CC FE3F             7      CP  '?'     ;Wild card
001431 D9CE 2812            12      JR  Z,CPSTR2
001433 D9D0 7E               7      LD  A,(HL)
001434 D9D1 CD37DB          17      CALL    FKANC
001437 D9D4 E5              11      PUSH    HL
001438 D9D5 67               4      LD  H,A
001439 D9D6 1A               7      LD  A,(DE)
00143A D9D7 CB01             8      RLC C
00143C D9D9 CD37DB          17      CALL    FKANC
00143F D9DC CB09             8      RRC C
001441 D9DE BC               4      CP  H       ;CP (HL),(DE)
001442 D9DF E1              10      POP HL
001443 D9E0 2004            12      JR  NZ,CPSTR3
       D9E2                     CPSTR2:
001445 D9E2 13               6      INC DE
001446 D9E3 23               6      INC HL
001447 D9E4 10E5            13      DJNZ    CPSTR1
       D9E6                     CPSTR3:
001449 D9E6 C1              10      POP BC
00144A D9E7 C9              10      RET
                                
       D9E8                     CPFILE2:
00144B D9E8 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
00144E D9EB F6E1             7      OR  0E1H
001450 D9ED 2F               4      CPL
001451 D9EE A6               7      AND (HL)
001452 D9EF C9              10      RET
                                
       D9F0                     DCPAT:
001453 D9F0 0E00             7      LD  C,0
001455 D9F2 2A7EE7          16      LD  HL,(_DTBUF)
001458 D9F5 3AA0E6          13      LD  A,(_DIRF)   ;ディレクトリか判別
00145B D9F8 B7               4      OR  A
00145C D9F9 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
00145D D9FA 3A0EDA          13      LD  A,(SPCPAT)
001460 D9FD 4F               4      LD  C,A
001461 D9FE 3A72E1          13      LD  A,(_SECPS)
001464 DA01 B9               4      CP  C
001465 DA02 3801            12      JR  C,DC1
001467 DA04 AF               4      XOR A
       DA05                     DC1:
001468 DA05 F680             7      OR  080H
00146A DA07 32A0E6          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       DA0A                     CLUSTX:
00146D DA0A E5              11      PUSH    HL
00146E DA0B EB               4      EX  DE,HL
00146F DA0C AF               4      XOR A
001470 DA0D 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       DA0E                     SPCPAT  EQU $-1
       DA0F                     L_CLDBL:
001472 DA0F CB19             8      RR  C       ;->CF
001474 DA11 3804            12      JR  C,E_CLDBL
001476 DA13 29              11      ADD HL,HL       ;*2
001477 DA14 8F               4      ADC A,A
001478 DA15 18F8            12      JR  L_CLDBL
       DA17                     E_CLDBL:
00147A DA17 4F               4      LD  C,A
00147B DA18 3A72E1          13      LD  A,(_SECPS)
00147E DA1B B5               4      OR  L
00147F DA1C 6F               4      LD  L,A
001480 DA1D 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       DA1E                     CLSPAT  EQU $-2
001483 DA20 AF               4      XOR A
001484 DA21 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
001485 DA22 89               4      ADC A,C
001486 DA23 4F               4      LD  C,A
001487 DA24 EB               4      EX  DE,HL
001488 DA25 E1              10      POP HL
001489 DA26 C9              10      RET
                                ;(8)
       DA27                     ENDCL:
00148A DA27 7A               4      LD  A,D ;END CLUSTER
00148B DA28 FE01             7      CP  1   ;164=356    (self-modifying code)
       DA29                     CLPAT1  EQU $-1
00148D DA2A C0              11      RET NZ
00148E DA2B 7B               4      LD  A,E
00148F DA2C FE64             7      CP  064H    ;       (self-modifying code)
       DA2D                     CLPAT2  EQU $-1
001491 DA2E C9              10      RET
                                ;(3)
       DA2F                     CAP4:
001492 DA2F 3EE5             7      LD  A,0E5H
001494 DA31 C9              10      RET
                                                    ;for X1/88 ワークエリア
001495 DA32 5BE6                    DW  _DISKE+1        ;DISKVE($F323)
001497 DA34 F5E6                    DW  _BREAK+1        ;BREAKV($F325)
                                
       DA36                     CAP:            ;(9)
001499 DA36 FE61             7      CP  'a'
00149B DA38 D8              11      RET C
00149C DA39 FE7B             7      CP  'z'+1
00149E DA3B D0              11      RET NC
00149F DA3C D620             7      SUB 020H
0014A1 DA3E C9              10      RET
                                ;(10)
       DA3F                     CAP2:
0014A2 DA3F CD36DA          17      CALL    CAP
       DA42                     CAP3:               ;
0014A5 DA42 FE05             7      CP  5
0014A7 DA44 28E9            12      JR  Z,CAP4
0014A9 DA46 FE21             7      CP  021H
0014AB DA48 C9              10      RET
                                                    ;
       DA49                     CHDIR:
0014AC DA49 CD22E4          17      CALL    GETDPBD
0014AF DA4C 381D            12      JR  C,CHDIR2
0014B1 DA4E DD751A          19      LD  (IX+DPB_SDIR),L
0014B4 DA51 DD741B          19      LD  (IX+DPB_SDIR+1),H
0014B7 DA54 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       DA56                     LDDIR:
0014B9 DA56 CD22E4          17      CALL    GETDPBD
0014BC DA59 DD5E1A          19      LD  E,(IX+DPB_SDIR)
0014BF DA5C DD561B          19      LD  D,(IX+DPB_SDIR+1)
0014C2 DA5F 13               6      INC DE
0014C3 DA60 FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0014C6 DA63 FD720F          19      LD  (IY+15),D
0014C9 DA66 1B               6      DEC DE
0014CA DA67 AF               4      XOR A
0014CB DA68 32A0E6          13      LD  (_DIRF),A
       DA6B                     CHDIR2:
0014CE DA6B DDE1            14      POP IX
0014D0 DA6D C9              10      RET
                                
       DA6E                     LDDIRX:
0014D1 DA6E 3AA0E6          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
0014D4 DA71 E67F             7      AND 07FH
       DA73                     LDDIRX1:
0014D6 DA73 3272E1          13      LD  (_SECPS),A
0014D9 DA76 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0014DC DA79 FD560F          19      LD  D,(IY+15)
0014DF DA7C 1B               6      DEC DE
0014E0 DA7D CD27DA          17      CALL    ENDCL
0014E3 DA80 D456DA          17      CALL    NC,LDDIR
       DA83                     LDDIRS:
0014E6 DA83 7A               4      LD  A,D
0014E7 DA84 B3               4      OR  E
0014E8 DA85 32A0E6          13      LD  (_DIRF),A   ;ディレクトリか判別
0014EB DA88 C9              10      RET
                                
       DA89                     KILL:
0014EC DA89 CD51DB          17      CALL    CHKWILDX
0014EF DA8C 3834            12      JR  C,KILLW
0014F1 DA8E CD2CD8          17      CALL    SOPENX
       DA91                     KILLS:
0014F4 DA91 3E1F             7      LD  A,01FH
0014F6 DA93 D4D5DA          17      CALL    NC,CHKATT
0014F9 DA96 D8              11      RET C
       DA97                     KILLSX:
0014FA DA97 36E5            10      LD  (HL),0E5H   ;DIR
0014FC DA99 CD2DDB          17      CALL    WTDB
0014FF DA9C 111A00          10      LD  DE,01AH
001502 DA9F 19              11      ADD HL,DE
001503 DAA0 5E               7      LD  E,(HL)
001504 DAA1 23               6      INC HL
001505 DAA2 56               7      LD  D,(HL)
       DAA3                     KILLS1:
001506 DAA3 CD27DA          17      CALL    ENDCL
001509 DAA6 D0              11      RET NC      ;CF=0
00150A DAA7 21FEFF          10      LD  HL,0-2
00150D DAAA 19              11      ADD HL,DE
00150E DAAB D0              11      RET NC      ;DE= 0 or 1
00150F DAAC D5              11      PUSH    DE
001510 DAAD CDF7E6          17      CALL    _GNCL
001513 DAB0 ED53FEE7        20      LD  (_CLPS),DE
001517 DAB4 D1              10      POP DE
001518 DAB5 210000          10      LD  HL,0
00151B DAB8 D4FAE6          17      CALL    NC,_SNCL
00151E DABB D8              11      RET C
00151F DABC ED5BFEE7        20      LD  DE,(_CLPS)  ;FAT
001523 DAC0 18E1            12      JR  KILLS1
                                
       DAC2                     KILLW:
001525 DAC2 CD5BD8          17      CALL    SOPEN
       DAC5                     KILLW1:
001528 DAC5 380B            12      JR  C,KILLW2
00152A DAC7 CDFAD8          17      CALL    SOPENE2
00152D DACA CD91DA          17      CALL    KILLS
001530 DACD CDBFD8          17      CALL    NOPEN
001533 DAD0 18F3            12      JR  KILLW1
       DAD2                     KILLW2:
001535 DAD2 C8              11      RET Z
001536 DAD3 3F               4      CCF
001537 DAD4 C9              10      RET
                                
       DAD5                     CHKATT:
001538 DAD5 E5              11      PUSH    HL
001539 DAD6 110B00          10      LD  DE,00BH
00153C DAD9 19              11      ADD HL,DE
00153D DADA A6               7      AND (HL)
00153E DADB E1              10      POP HL
00153F DADC C8              11      RET Z
001540 DADD 37               4      SCF
001541 DADE C9              10      RET
                                
       DADF                     NAME:
001542 DADF CD51DB          17      CALL    CHKWILDX
001545 DAE2 D8              11      RET C
001546 DAE3 110400          10      LD  DE,4
001549 DAE6 19              11      ADD HL,DE
00154A DAE7 22FCDA          16      LD  (NAMEP),HL
00154D DAEA 23               6      INC HL
00154E DAEB CD55DB          17      CALL    CHKWILD
001551 DAEE D8              11      RET C
                                
001552 DAEF CD2CD8          17      CALL    SOPENX
001555 DAF2 3E0F             7      LD  A,00FH
001557 DAF4 D4D5DA          17      CALL    NC,CHKATT
00155A DAF7 D8              11      RET C
                                
00155B DAF8 FDE5            15      PUSH    IY
00155D DAFA FD210000        14      LD  IY,0        ;自己書き換え
       DAFC                     NAMEP   EQU $-2
001561 DAFE CD2CD8          17      CALL    SOPENX
001564 DB01 FDE3            23      EX  (SP),IY
001566 DB03 3F               4      CCF
001567 DB04 D45BD8          17      CALL    NC,SOPEN
00156A DB07 EB               4      EX  DE,HL
00156B DB08 E1              10      POP HL
00156C DB09 D8              11      RET C
                                
       DB0A                     SETNAME:
00156D DB0A 01000B          10      LD  BC,11*256
001570 DB0D 23               6      INC HL
001571 DB0E 7E               7      LD  A,(HL)
001572 DB0F FEE5             7      CP  0E5H
001574 DB11 2004            12      JR  NZ,SNAME1
001576 DB13 3E05             7      LD  A,5
001578 DB15 180E            12      JR  SNAME3
       DB17                     SNAME1:
00157A DB17 7E               7      LD  A,(HL)
00157B DB18 0C               4      INC C
00157C DB19 0D               4      DEC C
00157D DB1A 2009            12      JR  NZ,SNAME3
00157F DB1C CD36DA          17      CALL    CAP
001582 DB1F FEA0             7      CP  0A0H
001584 DB21 2002            12      JR  NZ,SNAME3
001586 DB23 3E20             7      LD  A,020H
       DB25                     SNAME3:
001588 DB25 12               7      LD  (DE),A
001589 DB26 7E               7      LD  A,(HL)
00158A DB27 23               6      INC HL
00158B DB28 CD3EDB          17      CALL    FKAN
00158E DB2B 10EA            13      DJNZ    SNAME1
       DB2D                     WTDB:               ;バッファデータが更新された
001590 DB2D 3EFF             7      LD  A,0FFH
001592 DB2F 3239E6          13      LD  (SFILE),A
001595 DB32 32A4E6          13      LD  (_WTDBF),A
001598 DB35 AF               4      XOR A
001599 DB36 C9              10      RET
                                
       DB37                     FKANC:
00159A DB37 CB41             8      BIT 0,C
00159C DB39 CC3FDA          17      CALL    Z,CAP2
00159F DB3C 1801            12      JR  FKANX
       DB3E                     FKAN:           ;漢字チェック
0015A1 DB3E 13               6      INC DE
       DB3F                     FKANX:
0015A2 DB3F CB41             8      BIT 0,C
0015A4 DB41 CB81             8      RES 0,C
0015A6 DB43 C0              11      RET NZ
0015A7 DB44 FE80             7      CP  080H
0015A9 DB46 D8              11      RET C
0015AA DB47 FEA0             7      CP  0A0H
0015AC DB49 3803            12      JR  C,FKAN1
0015AE DB4B FEE0             7      CP  0E0H
0015B0 DB4D D8              11      RET C
       DB4E                     FKAN1:
0015B1 DB4E 0C               4      INC C
0015B2 DB4F A7               4      AND A
0015B3 DB50 C9              10      RET
                                
       DB51                     CHKWILDX:
0015B4 DB51 FDE5            15      PUSH    IY
0015B6 DB53 E1              10      POP HL
0015B7 DB54 23               6      INC HL
       DB55                     CHKWILD:
0015B8 DB55 060B             7      LD  B,11
0015BA DB57 3E3F             7      LD  A,'?'
       DB59                     CHKWIL1:
0015BC DB59 BE               7      CP  (HL)
0015BD DB5A 23               6      INC HL
0015BE DB5B 37               4      SCF
0015BF DB5C C8              11      RET Z
0015C0 DB5D 10FA            13      DJNZ    CHKWIL1
0015C2 DB5F AF               4      XOR A
0015C3 DB60 C9              10      RET
                                
       DB61                     SDIRENT:        ;IY=FCB HL=DIR
0015C4 DB61 D5              11      PUSH    DE
0015C5 DB62 E5              11      PUSH    HL
0015C6 DB63 FDE5            15      PUSH    IY
0015C8 DB65 D1              10      POP DE
0015C9 DB66 EB               4      EX  DE,HL
0015CA DB67 CD0ADB          17      CALL    SETNAME
                                ;               Attribute
0015CD DB6A FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0015D0 DB6D 12               7      LD  (DE),A
0015D1 DB6E 13               6      INC DE
                                ;               Reserved
0015D2 DB6F AF               4      XOR A
0015D3 DB70 060A             7      LD  B,10
       DB72                     SDE1:
0015D5 DB72 12               7      LD  (DE),A
0015D6 DB73 13               6      INC DE
0015D7 DB74 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
0015D9 DB76 21E4E7          10      LD  HL,SDDATA       ;(FCB)更新年月日
0015DC DB79 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DB7B                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
0015DE DB7B 7E               7      LD  A,(HL)
0015DF DB7C 23               6      INC HL
0015E0 DB7D 3282DB          13      LD  (SDPAT),A
0015E3 DB80 FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       DB82                     SDPAT   EQU $-1
0015E6 DB83 12               7      LD  (DE),A
0015E7 DB84 13               6      INC DE
0015E8 DB85 10F4            13      DJNZ    SDLOOP
                                
0015EA DB87 AF               4      XOR A
0015EB DB88 E1              10      POP HL
0015EC DB89 D1              10      POP DE
0015ED DB8A C9              10      RET
                                
       DB8B                     WOPEN:
0015EE DB8B FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0015F1 DB8E E61F             7      AND 01FH
0015F3 DB90 37               4      SCF
0015F4 DB91 C0              11      RET NZ
0015F5 DB92 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       DB96                     TOPEN2:
0015F9 DB96 AF               4      XOR A
       DB97                     TOPEN:              ;Initializes the time stamp
0015FA DB97 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
0015FE DB9B C9              10      RET
                                
       DB9C                     WRDFX:
0015FF DB9C 3A0EDA          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       DB9F                     L_WRFX:
001602 DB9F 1F               4      RRA         ;->CF
001603 DBA0 3806            12      JR  C,E_WRFX
001605 DBA2 CB39             8      SRL C
001607 DBA4 CB1C             8      RR  H       ;CH=CH/2
001609 DBA6 18F7            12      JR  L_WRFX
       DBA8                     E_WRFX:
00160B DBA8 41               4      LD  B,C
00160C DBA9 4C               4      LD  C,H
00160D DBAA 03               6      INC BC
00160E DBAB 3E37             7      LD  A,037H      ;SCF
001610 DBAD 32F8DF          13      LD  (DRDN1),A
                                
       DBB0                     WRDF:               ;BCクラスタ分FATを確保する
001613 DBB0 110200          10      LD  DE,2
001616 DBB3 AF               4      XOR A
001617 DBB4 3272E1          13      LD  (_SECPS),A
       DBB7                     WRDF1:
00161A DBB7 C5              11      PUSH    BC
00161B DBB8 D5              11      PUSH    DE
00161C DBB9 CDF7E6          17      CALL    _GNCL
00161F DBBC 381C            12      JR  C,WRDF3
001621 DBBE 7A               4      LD  A,D     ;空いているかチェック
001622 DBBF B3               4      OR  E
001623 DBC0 202A            12      JR  NZ,WRDF4
001625 DBC2 E1              10      POP HL      ;HL=空いているクラスタ
001626 DBC3 E5              11      PUSH    HL
001627 DBC4 ED5BFEE7        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
00162B DBC8 22FEE7          16      LD  (_CLPS),HL
00162E DBCB 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
00162F DBCC B3               4      OR  E
001630 DBCD 2008            12      JR  NZ,WRDF2
001632 DBCF FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
001635 DBD2 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
001638 DBD5 1803            12      JR  WRDF3
       DBD7                     WRDF2:
00163A DBD7 CDFAE6          17      CALL    _SNCL
       DBDA                     WRDF3:
00163D DBDA D1              10      POP DE
00163E DBDB C1              10      POP BC
00163F DBDC D8              11      RET C
001640 DBDD 0B               6      DEC BC
001641 DBDE 78               4      LD  A,B
001642 DBDF B1               4      OR  C
001643 DBE0 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
001645 DBE2 ED5BFEE7        20      LD  DE,(_CLPS)
001649 DBE6 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
00164C DBE9 C3FAE6          10      JP  _SNCL
                                
       DBEC                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
00164F DBEC D1              10      POP DE
001650 DBED C1              10      POP BC
       DBEE                     WRDF5:
001651 DBEE 13               6      INC DE
001652 DBEF CD27DA          17      CALL    ENDCL
001655 DBF2 38C3            12      JR  C,WRDF1
001657 DBF4 37               4      SCF
001658 DBF5 C9              10      RET
                                
       DBF6                     RWXR:
001659 DBF6 3AE7DE          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       DBF9                     L_RWX:
00165C DBF9 1F               4      RRA     ;->CF
00165D DBFA 3808            12      JR  C,E_RWX
00165F DBFC CB38             8      SRL B   ;BCH=BCH/2
001661 DBFE CB19             8      RR  C   ;
001663 DC00 CB1C             8      RR  H   ;
001665 DC02 18F5            12      JR  L_RWX
       DC04                     E_RWX:
001667 DC04 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
00166A DC07 FD561B          19      LD  D,(IY+27)
00166D DC0A AF               4      XOR A
00166E DC0B 3272E1          13      LD  (_SECPS),A
       DC0E                     RWX1:
001671 DC0E ED53FEE7        20      LD  (_CLPS),DE
001675 DC12 7A               4      LD  A,D
001676 DC13 B3               4      OR  E
001677 DC14 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
001679 DC16 78               4      LD  A,B
00167A DC17 B1               4      OR  C
00167B DC18 B4               4      OR  H
00167C DC19 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
00167D DC1A CD7AE1          17      CALL    GNCLX
001680 DC1D D8              11      RET C
001681 DC1E 7C               4      LD  A,H     ;
001682 DC1F 25               4      DEC H       ;
001683 DC20 B7               4      OR  A       ;DEC BCH
001684 DC21 2001            12      JR  NZ,RWX2     ;
001686 DC23 0B               6      DEC BC      ;
       DC24                     RWX2:
001687 DC24 CD27DA          17      CALL    ENDCL
00168A DC27 38E5            12      JR  C,RWX1
       DC29                     SCF_RET:
00168C DC29 37               4      SCF
00168D DC2A C9              10      RET
                                
       DC2B                     DSKF:
00168E DC2B 110000          10      LD  DE,0
       DC2C                     MAXCLP  EQU $-2
001691 DC2E 2AACE6          16      LD  HL,(_FAKEFREE)
001694 DC31 7C               4      LD  A,H
001695 DC32 B5               4      OR  L
001696 DC33 2803            12      JR  Z,DSKF1
001698 DC35 110100          10      LD  DE,1
       DC38                     DSKF1:
00169B DC38 D5              11      PUSH    DE
00169C DC39 CDF7E6          17      CALL    _GNCL
00169F DC3C 380C            12      JR  C,POPSCF
0016A1 DC3E 7A               4      LD  A,D
0016A2 DC3F B3               4      OR  E
0016A3 DC40 2001            12      JR  NZ,DSKF2
0016A5 DC42 23               6      INC HL
       DC43                     DSKF2:
0016A6 DC43 D1              10      POP DE
0016A7 DC44 1B               6      DEC DE
0016A8 DC45 7A               4      LD  A,D
0016A9 DC46 B3               4      OR  E
0016AA DC47 20EF            12      JR  NZ,DSKF1
0016AC DC49 C9              10      RET
                                
       DC4A                     POPSCF:
0016AD DC4A F1              10      POP AF
0016AE DC4B 37               4      SCF
0016AF DC4C C9              10      RET
                                
       DC4D                     SETTMS:
0016B0 DC4D FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
0016B3 DC50 3C               4      INC A
0016B4 DC51 C0              11      RET NZ      ;ファイルが更新されていない
       DC52                     SETTMSX:            ;FCBに日付時刻をセットする
0016B5 DC52 CD5DD4          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
0016B8 DC55 CB25             8      SLA L       ;   *2
0016BA DC57 CB25             8      SLA L       ;   *4
0016BC DC59 29              11      ADD HL,HL       ;*2 *8
0016BD DC5A 29              11      ADD HL,HL       ;*4 *16
0016BE DC5B 29              11      ADD HL,HL       ;*8 *32
0016BF DC5C 7A               4      LD  A,D
0016C0 DC5D 0F               4      RRCA            ;bit.0->7->->->0->C
0016C1 DC5E E61F             7      AND 01FH
0016C3 DC60 B5               4      OR  L
0016C4 DC61 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
0016C7 DC64 FD7417          19      LD  (IY+23),H
                                
0016CA DC67 CD0DD4          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
0016CD DC6A 0144F8          10      LD  BC,0-1980
0016D0 DC6D 09              11      ADD HL,BC
0016D1 DC6E 65               4      LD  H,L
                                
0016D2 DC6F 7A               4      LD  A,D
0016D3 DC70 87               4      ADD A,A     ;*2
0016D4 DC71 87               4      ADD A,A     ;*4
0016D5 DC72 87               4      ADD A,A     ;*8
0016D6 DC73 87               4      ADD A,A     ;*16
0016D7 DC74 6F               4      LD  L,A
0016D8 DC75 29              11      ADD HL,HL       ;*32
0016D9 DC76 7D               4      LD  A,L
0016DA DC77 B3               4      OR  E
0016DB DC78 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
0016DE DC7B FD7415          19      LD  (IY+21),H
0016E1 DC7E C9              10      RET
                                ;(16)
       DC7F                     PUSHRR:
0016E2 DC7F 32ABDF          13      LD  (SETSEQ_SWC_RND),A
0016E5 DC82 22BDDF          16      LD  (SETSEQ_SWC_SEQ_RR),HL
0016E8 DC85 CDA5DC          17      CALL    GET_RR_AHL
0016EB DC88 220FE6          16      LD  (RR_BUF_HL),HL
0016EE DC8B 3211E6          13      LD  (RR_BUF_A),A
0016F1 DC8E C9              10      RET
                                ;(14)
       DC8F                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
0016F2 DC8F 87               4      ADD A,A     ;in BHLA => out AHL
0016F3 DC90 ED6A            15      ADC HL,HL
0016F5 DC92 CB18             8      RR  B
0016F7 DC94 B7               4      OR  A
0016F8 DC95 78               4      LD  A,B     ;ここでフラグは変化しない
0016F9 DC96 C8              11      RET Z
0016FA DC97 2C               4      INC L       ;INC AHL
0016FB DC98 C0              11      RET NZ      ;
0016FC DC99 24               4      INC H       ;
0016FD DC9A C0              11      RET NZ      ;
0016FE DC9B 3C               4      INC A       ;
0016FF DC9C C9              10      RET
                                ;(18)
       DC9D                     INIT_RND:
001700 DC9D 3ECD             7      LD  A,0CDH      ;CALL ????
001702 DC9F 21BCDC          10      LD  HL,POPRR
001705 DCA2 CD7FDC          17      CALL    PUSHRR
       DCA5                     GET_RR_AHL:
001708 DCA5 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00170B DCA8 FD6622          19      LD  H,(IY+34)   ;
00170E DCAB FD7E23          19      LD  A,(IY+35)   ;
001711 DCAE C9              10      RET
                                ;(10)
       DCAF                     SET_RR_AHL:
001712 DCAF FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001715 DCB2 FD7422          19      LD  (IY+34),H   ;
001718 DCB5 FD7723          19      LD  (IY+35),A   ;
00171B DCB8 C9              10      RET
                                ;(17)
       DCB9                     SETSEQ:
00171C DCB9 CDDEDC          17      CALL    SETSEQ1
       DCBC                     POPRR:
00171F DCBC F5              11      PUSH    AF
001720 DCBD E5              11      PUSH    HL
001721 DCBE 2A0FE6          16      LD  HL,(RR_BUF_HL)
001724 DCC1 3A11E6          13      LD  A,(RR_BUF_A)
001727 DCC4 CDAFDC          17      CALL    SET_RR_AHL
00172A DCC7 E1              10      POP HL
00172B DCC8 F1              10      POP AF
00172C DCC9 C9              10      RET
                                ;(20)
       DCCA                     GET_RR_BCDE:            ;BCDE=Random record
00172D DCCA FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
001730 DCCD FD5622          19      LD  D,(IY+34)
001733 DCD0 FD4E23          19      LD  C,(IY+35)
001736 DCD3 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
001738 DCD5 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00173C DCD9 C0              11      RET NZ
00173D DCDA FD4624          19      LD  B,(IY+36)
001740 DCDD C9              10      RET
                                
       DCDE                     SETSEQ1:
001741 DCDE F5              11      PUSH    AF
001742 DCDF E5              11      PUSH    HL      ;AHL=Random record
001743 DCE0 CDA5DC          17      CALL    GET_RR_AHL
001746 DCE3 47               4      LD  B,A     ;AHL→HLA
001747 DCE4 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
001748 DCE5 6C               4      LD  L,H     ;(IY+34)
001749 DCE6 60               4      LD  H,B     ;(IY+35)
00174A DCE7 0600             7      LD  B,0
                                
00174C DCE9 CD8FDC          17      CALL    GET_CPM_R_SIZE
                                
00174F DCEC 29              11      ADD HL,HL
001750 DCED CB3D             8      SRL L       ;L=L/2
001752 DCEF FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
001755 DCF2 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
001758 DCF5 E1              10      POP HL
001759 DCF6 F1              10      POP AF
00175A DCF7 C9              10      RET
                                
                                ;(23)
       DCF8                     RBXEND:             ;レコード数だけランダムレコードを進める
00175B DCF8 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       DCF9                     RBSIZE  EQU $-2
00175E DCFB CDA5DC          17      CALL    GET_RR_AHL
001761 DCFE 19              11      ADD HL,DE
001762 DCFF CE00             7      ADC A,0
001764 DD01 CDAFDC          17      CALL    SET_RR_AHL
001767 DD04 EB               4      EX  DE,HL       ;HL=進めるレコード数
001768 DD05 D0              11      RET NC
001769 DD06 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00176D DD0A C0              11      RET NZ
00176E DD0B FD3424          23      INC (IY+36)
001771 DD0E C9              10      RET
       DD0F                     FILE_E:
                                
       D8B9                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       D8B9                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       D8B9                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       D8B9                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       D8B9                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       DD0F                     _SYS26:     ;(BDOS)ランダムブロック書き込み
001772 DD0F AF               4      XOR A
001773 DD10 32F8DF          13      LD  (DRDN1),A   ;NOP
001776 DD13 22F9DC          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
001779 DD16 225DE6          16      LD  (LEFTX),HL
00177C DD19 CD02D8          17      CALL    SETDRV
                                
00177F DD1C CD82DE          17      CALL    RBX0
001782 DD1F DAACDD          10      JP  C,RBWERR
001785 DD22 CD8BDB          17      CALL    WOPEN
001788 DD25 DAACDD          10      JP  C,RBWERR
00178B DD28 7C               4      LD  A,H
00178C DD29 B5               4      OR  L
00178D DD2A CAA5DD          10      JP  Z,RBW1
                                
001790 DD2D 2B               6      DEC HL
                                
001791 DD2E CDCADC          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001794 DD31 19              11      ADD HL,DE       ;BCHL=HL+BCDE
001795 DD32 3001            12      JR  NC,S26X1    ;
001797 DD34 03               6      INC BC      ;
       DD35                     S26X1:
001798 DD35 CDF6DB          17      CALL    RWXR
00179B DD38 DC9CDB          17      CALL    C,WRDFX
00179E DD3B DAACDD          10      JP  C,RBWERR
                                
0017A1 DD3E CDB1DE          17      CALL    RBX2
0017A4 DD41 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
0017A6 DD43 CDD0DE          17      CALL    RBXA
0017A9 DD46 3864            12      JR  C,RBWERR
0017AB DD48 EB               4      EX  DE,HL
0017AC DD49 C5              11      PUSH    BC
0017AD DD4A EDB0                    LDIR
0017AF DD4C 225FE6          16      LD  (DTAX),HL
                                
0017B2 DD4F CD2DDB          17      CALL    WTDB        ;バッファデータは更新された
                                
0017B5 DD52 2A5DE6          16      LD  HL,(LEFTX)
0017B8 DD55 D1              10      POP DE
0017B9 DD56 ED52            15      SBC HL,DE
0017BB DD58 225DE6          16      LD  (LEFTX),HL
0017BE DD5B 2831            12      JR  Z,RBWEND
                                
       DD5D                     RBWB:
0017C0 DD5D CD05DF          17      CALL    RBXB
0017C3 DD60 2814            12      JR  Z,RBWC
       DD62                     RBWB1:
0017C5 DD62 C5              11      PUSH    BC
0017C6 DD63 D5              11      PUSH    DE
0017C7 DD64 CD0ADA          17      CALL    CLUSTX
0017CA DD67 CD29DF          17      CALL    DWTC
0017CD DD6A D1              10      POP DE
0017CE DD6B C1              10      POP BC
0017CF DD6C D47AE1          17      CALL    NC,GNCLX
0017D2 DD6F 383B            12      JR  C,RBWERR
0017D4 DD71 10EF            13      DJNZ    RBWB1
0017D6 DD73 CD79DF          17      CALL    DRW_FLUSH
       DD76                     RBWC:
0017D9 DD76 CD1DDF          17      CALL    RBXC
0017DC DD79 2813            12      JR  Z,RBWEND
0017DE DD7B C5              11      PUSH    BC
0017DF DD7C CD0ADA          17      CALL    CLUSTX
0017E2 DD7F CDF7DF          17      CALL    DRDN
0017E5 DD82 C1              10      POP BC
0017E6 DD83 3827            12      JR  C,RBWERR
0017E8 DD85 ED5B7EE7        20      LD  DE,(_DTBUF)
0017EC DD89 EDB0                    LDIR
0017EE DD8B CD2DDB          17      CALL    WTDB        ;バッファデータは更新された
       DD8E                     RBWEND:
0017F1 DD8E CDF8DC          17      CALL    RBXEND
                                
0017F4 DD91 CD91DE          17      CALL    RBX1
0017F7 DD94 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
0017F9 DD96 CDCADC          17      CALL    GET_RR_BCDE ;BCDE=Random record
0017FC DD99 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
0017FF DD9C FD7211          19      LD  (IY+17),D   ;
001802 DD9F FD7112          19      LD  (IY+18),C   ;
001805 DDA2 FD7013          19      LD  (IY+19),B   ;
       DDA5                     RBW1:
001808 DDA5 FDE1            14      POP IY
00180A DDA7 C1              10      POP BC
00180B DDA8 D1              10      POP DE
00180C DDA9 E1              10      POP HL
       DDAA                     DD_NUL:
00180D DDAA AF               4      XOR A
       DDAB                     DRDF0:
       DDAB                     DWTF0:
00180E DDAB C9              10      RET
                                
       DDAC                     RBWERR:
00180F DDAC FDE5            15      PUSH    IY
001811 DDAE D1              10      POP DE
001812 DDAF 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
001814 DDB1 CDD5CF          17      CALL    BDOS0
       DDB4                     RBRERR1:
001817 DDB4 3E01             7      LD  A,001H
       DDB6                     RBRERR2:
001819 DDB6 FDE1            14      POP IY
00181B DDB8 C1              10      POP BC
00181C DDB9 D1              10      POP DE
00181D DDBA E1              10      POP HL
00181E DDBB 37               4      SCF
00181F DDBC 210000          10      LD  HL,0
001822 DDBF C9              10      RET
                                
       DDC0                     RBRERR:
001823 DDC0 3EFF             7      LD  A,0FFH
001825 DDC2 18F2            12      JR  RBRERR2
                                
       DDC4                     RBRFL:
001827 DDC4 3E00             7  RBRFLP: LD  A,000H
001829 DDC6 FE0D             7      CP  00DH
00182B DDC8 2005            12      JR  NZ,RBRFL1
00182D DDCA D5              11      PUSH    DE
00182E DDCB 1E0A             7      LD  E,00AH
001830 DDCD 1805            12      JR  RBRFL2
       DDCF                     RBRFL1:
001832 DDCF D5              11      PUSH    DE
001833 DDD0 CD09E6          17      CALL    _SYS07
001836 DDD3 5F               4      LD  E,A
       DDD4                     RBRFL2:
001837 DDD4 CDCDE6          17      CALL    _PRINT
00183A DDD7 7B               4      LD  A,E
00183B DDD8 D1              10      POP DE
00183C DDD9 32C5DD          13      LD  (RBRFLP+1),A
00183F DDDC C9              10      RET
                                
                                                ;Read random block
       DDDD                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001840 DDDD 225DE6          16      LD  (LEFTX),HL
001843 DDE0 CD02D8          17      CALL    SETDRV
                                
001846 DDE3 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
00184A DDE7 C270DE          10      JP  NZ,RBRDIR   ;ディレクトリ
00184D DDEA CD82DE          17      CALL    RBX0
001850 DDED DAC0DD          10      JP  C,RBRERR
001853 DDF0 CD91DE          17      CALL    RBX1
001856 DDF3 D4A9DE          17      CALL    NC,RBX1R
001859 DDF6 DAB4DD          10      JP  C,RBRERR1
00185C DDF9 EB               4      EX  DE,HL
00185D DDFA ED52            15      SBC HL,DE       ;CP 00HL,BCDE
00185F DDFC 19              11      ADD HL,DE
001860 DDFD 79               4      LD  A,C
001861 DDFE DE00             7      SBC A,0
001863 DE00 78               4      LD  A,B
001864 DE01 DE00             7      SBC A,0
001866 DE03 3801            12      JR  C,RBR1
001868 DE05 EB               4      EX  DE,HL
       DE06                     RBR1:
001869 DE06 9F               4      SBC A,A
00186A DE07 E601             7      AND 1
00186C DE09 326EDE          13      LD  (RBRA_SWC),A
                                
00186F DE0C 7C               4      LD  A,H
001870 DE0D B5               4      OR  L
001871 DE0E 2857            12      JR  Z,RBREND0
                                
001873 DE10 22F9DC          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
001876 DE13 225DE6          16      LD  (LEFTX),HL
                                
001879 DE16 CDB1DE          17      CALL    RBX2
00187C DE19 2819            12      JR  Z,RBRB
00187E DE1B CDD0DE          17      CALL    RBXA
001881 DE1E DAC0DD          10      JP  C,RBRERR
001884 DE21 C5              11      PUSH    BC
001885 DE22 EDB0                    LDIR
001887 DE24 ED535FE6        20      LD  (DTAX),DE
00188B DE28 2A5DE6          16      LD  HL,(LEFTX)
00188E DE2B D1              10      POP DE
00188F DE2C A7               4      AND A
001890 DE2D ED52            15      SBC HL,DE
001892 DE2F 225DE6          16      LD  (LEFTX),HL
001895 DE32 2830            12      JR  Z,RBREND
                                
       DE34                     RBRB:
001897 DE34 CD05DF          17      CALL    RBXB
00189A DE37 2815            12      JR  Z,RBRC
       DE39                     RBRB1:
00189C DE39 C5              11      PUSH    BC
00189D DE3A D5              11      PUSH    DE
00189E DE3B CD0ADA          17      CALL    CLUSTX
0018A1 DE3E CD2FDF          17      CALL    DRDC
0018A4 DE41 D1              10      POP DE
0018A5 DE42 C1              10      POP BC
0018A6 DE43 D47AE1          17      CALL    NC,GNCLX
0018A9 DE46 DAC0DD          10      JP  C,RBRERR
0018AC DE49 10EE            13      DJNZ    RBRB1
0018AE DE4B CD79DF          17      CALL    DRW_FLUSH
       DE4E                     RBRC:
0018B1 DE4E CD1DDF          17      CALL    RBXC
0018B4 DE51 2811            12      JR  Z,RBREND
0018B6 DE53 C5              11      PUSH    BC
0018B7 DE54 CD0ADA          17      CALL    CLUSTX
0018BA DE57 CDDBDF          17      CALL    DRDX
0018BD DE5A C1              10      POP BC
0018BE DE5B DAC0DD          10      JP  C,RBRERR
0018C1 DE5E EB               4      EX  DE,HL
0018C2 DE5F 2A7EE7          16      LD  HL,(_DTBUF)
0018C5 DE62 EDB0                    LDIR
       DE64                     RBREND:
0018C7 DE64 CDF8DC          17      CALL    RBXEND
       DE67                     RBREND0:
0018CA DE67 FDE1            14      POP IY
0018CC DE69 C1              10      POP BC
0018CD DE6A D1              10      POP DE
0018CE DE6B F1              10      POP AF  ;(HL)
0018CF DE6C AF               4      XOR A
0018D0 DE6D 3E00             7      LD  A,000H
       DE6E                     RBRA_SWC    EQU $-1
0018D2 DE6F C9              10      RET
                                
       DE70                     RBRDIR:
0018D3 DE70 FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0018D6 DE73 FD661B          19      LD  H,(IY+27)
0018D9 DE76 CD49DA          17      CALL    CHDIR
0018DC DE79 AF               4      XOR A
0018DD DE7A 67               4      LD  H,A
0018DE DE7B 6F               4      LD  L,A
0018DF DE7C 3C               4      INC A
0018E0 DE7D 326EDE          13      LD  (RBRA_SWC),A
0018E3 DE80 18E5            12      JR  RBREND0
                                ;(15)
       DE82                     RBX0:
0018E5 DE82 2A8AE6          16      LD  HL,(_DTA)
0018E8 DE85 225FE6          16      LD  (DTAX),HL
0018EB DE88 2A5DE6          16      LD  HL,(LEFTX)
0018EE DE8B FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0018F1 DE8E D6FD             7      SUB 0FDH
0018F3 DE90 C9              10      RET
                                
       DE91                     RBX1:               ;ファイルサイズとランダムレコードを比べる
0018F4 DE91 E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
0018F5 DE92 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
0018F8 DE95 FD6611          19      LD  H,(IY+17)   ;
0018FB DE98 FD7E12          19      LD  A,(IY+18)   ;
                                
0018FE DE9B CDCADC          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001901 DE9E A7               4      AND A
001902 DE9F ED52            15      SBC HL,DE
001904 DEA1 99               4      SBC A,C
001905 DEA2 4F               4      LD  C,A
001906 DEA3 FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
001909 DEA6 98               4      SBC A,B
00190A DEA7 D1              10      POP DE
00190B DEA8 C9              10      RET
       DEA9                     RBX1R:              ;(8)
00190C DEA9 47               4      LD  B,A
00190D DEAA B1               4      OR  C
00190E DEAB EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
00190F DEAC B2               4      OR  D
001910 DEAD B3               4      OR  E
001911 DEAE C0              11      RET NZ
001912 DEAF 37               4      SCF
001913 DEB0 C9              10      RET
                                
       DEB1                     RBX2:               ;Cluster settings
001914 DEB1 FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001917 DEB4 FD4E23          19      LD  C,(IY+35)
00191A DEB7 0600             7      LD  B,0
00191C DEB9 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001920 DEBD 2003            12      JR  NZ,RBX3
001922 DEBF FD4624          19      LD  B,(IY+36)
       DEC2                     RBX3:
001925 DEC2 CDF6DB          17      CALL    RWXR
001928 DEC5 3AE7DE          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
00192B DEC8 3D               4      DEC A
00192C DEC9 FDA622          19      AND (IY+34)
00192F DECC FDB621          19      OR  (IY+33)
001932 DECF C9              10      RET
                                
       DED0                     RBXA:
001933 DED0 C5              11      PUSH    BC
001934 DED1 D5              11      PUSH    DE
001935 DED2 CD0ADA          17      CALL    CLUSTX
001938 DED5 CDDBDF          17      CALL    DRDX
00193B DED8 D1              10      POP DE
00193C DED9 C1              10      POP BC
00193D DEDA D47AE1          17      CALL    NC,GNCLX
001940 DEDD D8              11      RET C
001941 DEDE ED53FEE7        20      LD  (_CLPS),DE
                                
001945 DEE2 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
001948 DEE5 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       DEE6                     SECSZ   EQU $-2
       DEE7                     SECSZ_H EQU $-1
00194B DEE8 7C               4      LD  A,H
00194C DEE9 3D               4      DEC A       ;1024=3 / 512=1
00194D DEEA FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
001950 DEED 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
001951 DEEE ED42            15      SBC HL,BC       ;残りを計算
                                
001953 DEF0 ED5B5DE6        20      LD  DE,(LEFTX)
001957 DEF4 ED52            15      SBC HL,DE       ;CP HL,DE
001959 DEF6 19              11      ADD HL,DE       ;
00195A DEF7 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
00195C DEF9 EB               4      EX  DE,HL
       DEFA                     RBXA1:
00195D DEFA E5              11      PUSH    HL
00195E DEFB 2A7EE7          16      LD  HL,(_DTBUF)
001961 DEFE 09              11      ADD HL,BC
001962 DEFF ED5B5FE6        20      LD  DE,(DTAX)
001966 DF03 C1              10      POP BC
001967 DF04 C9              10      RET
                                
       DF05                     RBXB:
001968 DF05 2A5FE6          16      LD  HL,(DTAX)
00196B DF08 ED5BFEE7        20      LD  DE,(_CLPS)
00196F DF0C 3A5EE6          13      LD  A,(LEFTX+1)
001972 DF0F 47               4      LD  B,A
001973 DF10 3AE7DE          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       DF13                     RBXB1:
001976 DF13 1F               4      RRA     ;->CF
001977 DF14 3804            12      JR  C,RBXB2
001979 DF16 CB38             8      SRL B   ;B=B/2
00197B DF18 18F9            12      JR  RBXB1
       DF1A                     RBXB2:
00197D DF1A 78               4      LD  A,B
00197E DF1B B7               4      OR  A
00197F DF1C C9              10      RET
                                ;(12)
       DF1D                     RBXC:
001980 DF1D ED4B5DE6        20      LD  BC,(LEFTX)
001984 DF21 3AE7DE          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001987 DF24 3D               4      DEC A
001988 DF25 A0               4      AND B
001989 DF26 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
00198A DF27 B1               4      OR  C
00198B DF28 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       DF29                     DWTC:
00198C DF29 E5              11      PUSH    HL
00198D DF2A 2113E3          10      LD  HL,DWT24B
001990 DF2D 1804            12      JR  DWTC1
       DF2F                     DRDC:
001992 DF2F E5              11      PUSH    HL
001993 DF30 2105E3          10      LD  HL,DRD24B
       DF33                     DWTC1:
001996 DF33 228DDF          16      LD  (DRWF_MODE),HL
001999 DF36 E1              10      POP HL
00199A DF37 3A7DDF          13      LD  A,(DRWF_B)
00199D DF3A B7               4      OR  A
00199E DF3B 200F            12      JR  NZ,DRDC1
       DF3D                     SAVE_DRWC:
0019A0 DF3D 0601             7      LD  B,1
0019A2 DF3F ED437CDF        20      LD  (DRWF_C),BC
0019A6 DF43 ED5383DF        20      LD  (DRWF_E),DE
0019AA DF47 2286DF          16      LD  (DRWF_HL),HL
0019AD DF4A 1820            12      JR  INC_HL_DRWC
       DF4C                     DRDC1:
0019AF DF4C E5              11      PUSH    HL
0019B0 DF4D 2183DF          10      LD  HL,DRWF_E
0019B3 DF50 86               7      ADD A,(HL)
0019B4 DF51 F5              11      PUSH    AF
0019B5 DF52 BB               4      CP  E
0019B6 DF53 201D            12      JR  NZ,DRDC2
0019B8 DF55 F1              10      POP AF
0019B9 DF56 23               6      INC HL
0019BA DF57 7E               7      LD  A,(HL)
0019BB DF58 CE00             7      ADC A,0
0019BD DF5A F5              11      PUSH    AF
0019BE DF5B BA               4      CP  D
0019BF DF5C 2014            12      JR  NZ,DRDC2
0019C1 DF5E F1              10      POP AF
0019C2 DF5F 3A7CDF          13      LD  A,(DRWF_C)
0019C5 DF62 CE00             7      ADC A,0
0019C7 DF64 B9               4      CP  C
0019C8 DF65 200C            12      JR  NZ,DRDC3
0019CA DF67 217DDF          10      LD  HL,DRWF_B
0019CD DF6A 34              11      INC (HL)
0019CE DF6B E1              10      POP HL
       DF6C                     INC_HL_DRWC:
0019CF DF6C 3AE7DE          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
0019D2 DF6F 84               4      ADD A,H
0019D3 DF70 67               4      LD  H,A
0019D4 DF71 C9              10      RET
       DF72                     DRDC2:
0019D5 DF72 F1              10      POP AF
       DF73                     DRDC3:
0019D6 DF73 CD79DF          17      CALL    DRW_FLUSH
0019D9 DF76 E1              10      POP HL
0019DA DF77 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       DF79                     DRW_FLUSH:
0019DC DF79 C5              11      PUSH    BC
0019DD DF7A D5              11      PUSH    DE
0019DE DF7B 010000          10      LD  BC,0
       DF7C                     DRWF_C  EQU $-2
       DF7D                     DRWF_B  EQU $-1
0019E1 DF7E 78               4      LD  A,B
0019E2 DF7F B7               4      OR  A
0019E3 DF80 280D            12      JR  Z,DRDF1
0019E5 DF82 110000          10      LD  DE,0
       DF83                     DRWF_E  EQU $-2
       DF84                     DRWF_D  EQU $-1
0019E8 DF85 210000          10      LD  HL,0
       DF86                     DRWF_HL EQU $-2
0019EB DF88 AF               4      XOR A
0019EC DF89 327DDF          13      LD  (DRWF_B),A
0019EF DF8C CD05E3          17      CALL    DRD24B
       DF8D                     DRWF_MODE   EQU $-2
       DF8F                     DRDF1:
0019F2 DF8F D1              10      POP DE
0019F3 DF90 C1              10      POP BC
0019F4 DF91 C9              10      RET
                                
       DF92                     RB_WRITE:
0019F5 DF92 C5              11      PUSH    BC
0019F6 DF93 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0019F8 DF95 1803            12      JR  RBRW
       DF97                     RB_READ:
0019FA DF97 C5              11      PUSH    BC
0019FB DF98 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       DF9A                     RBRW:
0019FD DF9A 1F               4      RRA     ;AHL = AHL*128
0019FE DF9B 7C               4      LD  A,H ;AHL = AHL0/2
0019FF DF9C 1F               4      RRA     ;A
001A00 DF9D 65               4      LD  H,L ;
001A01 DF9E CB1C             8      RR  H   ;H
001A03 DFA0 2E00             7      LD  L,0 ;
001A05 DFA2 CB1D             8      RR  L   ;L
001A07 DFA4 CDAFDC          17      CALL    SET_RR_AHL
001A0A DFA7 218000          10      LD  HL,128
001A0D DFAA C5              11      PUSH    BC
       DFAB                     SETSEQ_SWC_RND:
001A0E DFAB CDDEDC          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
001A11 DFAE C1              10      POP BC
001A12 DFAF FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
001A16 DFB3 FDE5            15      PUSH    IY
001A18 DFB5 D1              10      POP DE
001A19 DFB6 D5              11      PUSH    DE
001A1A DFB7 CDD5CF          17      CALL    BDOS0
001A1D DFBA FDE1            14      POP IY
001A1F DFBC CDB9DC          17      CALL    SETSEQ      ;SETSEQ or POPRR
       DFBD                     SETSEQ_SWC_SEQ_RR   EQU $-2
001A22 DFBF FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
001A26 DFC3 C1              10      POP BC
001A27 DFC4 C9              10      RET
                                
                                ;(22)
       DFC5                     INIT_SEQ:
001A28 DFC5 3E01             7      LD  A,1     ;LD BC,????
001A2A DFC7 21B9DC          10      LD  HL,SETSEQ
001A2D DFCA CD7FDC          17      CALL    PUSHRR
       DFCD                     GETSEQ:
001A30 DFCD FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
001A33 DFD0 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
001A36 DFD3 AF               4      XOR A
                                
001A37 DFD4 CB25             8      SLA L   ;L=L*2
                                
001A39 DFD6 CB3C             8      SRL H   ;HL=HL/2
001A3B DFD8 CB1D             8      RR  L   ;
001A3D DFDA C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       DFDB                     DRDX:
001A3E DFDB CD19E0          17      CALL    DRDY
001A41 DFDE C8              11      RET Z
001A42 DFDF CDFFDF          17      CALL    DRDX1       ;データバッファの情報を保存
001A45 DFE2 D8              11      RET C
001A46 DFE3 E5              11      PUSH    HL
001A47 DFE4 C5              11      PUSH    BC
001A48 DFE5 D5              11      PUSH    DE
001A49 DFE6 2A7EE7          16      LD  HL,(_DTBUF)
001A4C DFE9 3A42E0          13      LD  A,(_DBS24)
001A4F DFEC 4F               4      LD  C,A
001A50 DFED CD03E3          17      CALL    DRD24
001A53 DFF0 DC14E0          17      CALL    C,DRDNE
       DFF3                     POP_DE_BC_HL_RET:
001A56 DFF3 D1              10      POP DE
001A57 DFF4 C1              10      POP BC
001A58 DFF5 E1              10      POP HL
001A59 DFF6 C9              10      RET
                                
                                ;   CDE:セクタ番号
       DFF7                     DRDN:
001A5A DFF7 AF               4      XOR A
001A5B DFF8 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
001A5C DFF9 30E0            12      JR  NC,DRDX
       DFFB                     DRDNX:
001A5E DFFB CD19E0          17      CALL    DRDY
001A61 DFFE C8              11      RET Z
       DFFF                     DRDX1:
001A62 DFFF CD2FE0          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
001A65 E002 ED53A6E6        20      LD  (_DBSEC),DE
001A69 E006 79               4      LD  A,C
001A6A E007 3242E0          13      LD  (_DBS24),A
                                
001A6D E00A 3A88E6          13      LD  A,(_DRV)
001A70 E00D 32A5E6          13      LD  (_DBDRV),A
001A73 E010 CDD9E6          17      CALL    _CHGDRV
001A76 E013 D0              11      RET NC
       E014                     DRDNE:
001A77 E014 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001A78 E015 32A5E6          13      LD  (_DBDRV),A
001A7B E018 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E019                     DRDY:
001A7C E019 3A42E0          13      LD  A,(_DBS24)
001A7F E01C B9               4      CP  C
001A80 E01D C0              11      RET NZ
                                
001A81 E01E E5              11      PUSH    HL
001A82 E01F 3A88E6          13      LD  A,(_DRV)
001A85 E022 21A5E6          10      LD  HL,_DBDRV
001A88 E025 AE               7      XOR (HL)
001A89 E026 2005            12      JR  NZ,POP_HL_RET
                                
001A8B E028 2AA6E6          16      LD  HL,(_DBSEC)
001A8E E02B ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E02D                     POP_HL_RET:
001A90 E02D E1              10      POP HL
001A91 E02E C9              10      RET
                                
       E02F                     DWTX:
001A92 E02F 3AA4E6          13      LD  A,(_WTDBF)
001A95 E032 B7               4      OR  A
001A96 E033 C8              11      RET Z
001A97 E034 AF               4      XOR A
001A98 E035 32A4E6          13      LD  (_WTDBF),A
                                
001A9B E038 E5              11      PUSH    HL
001A9C E039 C5              11      PUSH    BC
001A9D E03A D5              11      PUSH    DE
001A9E E03B 3AA5E6          13      LD  A,(_DBDRV)
001AA1 E03E CDD9E6          17      CALL    _CHGDRV
001AA4 E041 0E00             7      LD  C,0
       E042                     _DBS24  EQU $-1
001AA6 E043 ED5BA6E6        20      LD  DE,(_DBSEC)
001AAA E047 2A7EE7          16      LD  HL,(_DTBUF)
001AAD E04A D411E3          17      CALL    NC,DWT24
       E04D                     POP_DE_BC_HL_RET2:
001AB0 E04D 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E04F                     RDFATX:
001AB2 E04F E5              11      PUSH    HL
001AB3 E050 3A88E6          13      LD  A,(_DRV)
001AB6 E053 21AAE6          10      LD  HL,_FATDRV
001AB9 E056 AE               7      XOR (HL)
001ABA E057 28D4            12      JR  Z,POP_HL_RET
                                
001ABC E059 C5              11      PUSH    BC
001ABD E05A D5              11      PUSH    DE
001ABE E05B DDE5            15      PUSH    IX
001AC0 E05D CD79E0          17      CALL    WTFATX
001AC3 E060 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
001AC5 E062 AF               4      XOR A
001AC6 E063 32ABE6          13      LD  (_FATIX),A
001AC9 E066 3A88E6          13      LD  A,(_DRV)
001ACC E069 32AAE6          13      LD  (_FATDRV),A
001ACF E06C CDE5E6          17      CALL    _RDFAT
       E06F                     RDFATE2:
001AD2 E06F 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
001AD4 E071 9F               4      SBC A,A     ;A=0xFF
001AD5 E072 32AAE6          13      LD  (_FATDRV),A
       E075                     POP_IX_DE_BC_HL_RET:
001AD8 E075 DDE1            14      POP IX
001ADA E077 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E079                     WTFATX:
001ADC E079 3AA2E6          13      LD  A,(_WTFATF)
001ADF E07C B7               4      OR  A
001AE0 E07D C8              11      RET Z
001AE1 E07E AF               4      XOR A
001AE2 E07F 32A2E6          13      LD  (_WTFATF),A
                                
001AE5 E082 E5              11      PUSH    HL
001AE6 E083 3AAAE6          13      LD  A,(_FATDRV)
001AE9 E086 21A5E6          10      LD  HL,_DBDRV
001AEC E089 AE               7      XOR (HL)
001AED E08A CC2FE0          17      CALL    Z,DWTX
001AF0 E08D 389E            12      JR  C,POP_HL_RET
001AF2 E08F C5              11      PUSH    BC
001AF3 E090 D5              11      PUSH    DE
001AF4 E091 DDE5            15      PUSH    IX
001AF6 E093 CD22E3          17      CALL    FATSETUP
001AF9 E096 D413E3          17      CALL    NC,DWT24B
001AFC E099 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E09B                     N16CL1:
001AFE E09B 7A               4      LD  A,D
001AFF E09C B3               4      OR  E
001B00 E09D 37               4      SCF
001B01 E09E C8              11      RET Z
                                
001B02 E09F 7A               4      LD  A,D
001B03 E0A0 1807            12      JR  NCL1X
       E0A2                     NCL1:
001B05 E0A2 7A               4      LD  A,D
001B06 E0A3 B3               4      OR  E
001B07 E0A4 37               4      SCF
001B08 E0A5 C8              11      RET Z
                                
001B09 E0A6 7A               4      LD  A,D
001B0A E0A7 CB3F             8      SRL A   ;/2
       E0A9                     NCL1X:
001B0C E0A9 CB3F             8      SRL A   ;/2
                                
001B0E E0AB E5              11      PUSH    HL
001B0F E0AC 32CBE0          13      LD  (NCLPAT_FATIX),A    ;_FATIX
001B12 E0AF 2AAAE6          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001B15 E0B2 BC               4      CP  H
001B16 E0B3 3A88E6          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001B19 E0B6 32CAE0          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001B1C E0B9 2005            12      JR  NZ,NCL2     ;FATIXが違う
001B1E E0BB BD               4      CP  L
001B1F E0BC 2002            12      JR  NZ,NCL2     ;ドライブが違う
001B21 E0BE E1              10      POP HL
001B22 E0BF C9              10      RET
       E0C0                     NCL2:
001B23 E0C0 C5              11      PUSH    BC
001B24 E0C1 D5              11      PUSH    DE
001B25 E0C2 DDE5            15      PUSH    IX
001B27 E0C4 CD79E0          17      CALL    WTFATX
001B2A E0C7 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
001B2C E0C9 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E0CB                     NCLPAT_FATIX    EQU $-1
       E0CA                     NCLPAT_FATDRV   EQU $-2
001B2F E0CC ED43AAE6        20      LD  (_FATDRV),BC
001B33 E0D0 CDF7E2          17      CALL    RDFATS
001B36 E0D3 189A            12      JR  RDFATE2
                                
       E0D5                     NCL3:
001B38 E0D5 CB9A             8      RES 3,D
001B3A E0D7 CB92             8      RES 2,D
001B3C E0D9 6B               4      LD  L,E
001B3D E0DA 62               4      LD  H,D
001B3E E0DB CB3C             8      SRL H   ;
001B40 E0DD CB1D             8      RR  L   ;HLA=HLA/2
001B42 E0DF 1F               4      RRA     ;
001B43 E0E0 F5              11      PUSH    AF
001B44 E0E1 3AABE6          13      LD  A,(_FATIX)
001B47 E0E4 0F               4      RRCA
001B48 E0E5 300B            12      JR  NC,NCL3X1
001B4A E0E7 3AE7DE          13      LD  A,(SECSZ_H)
001B4D E0EA FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの際に先頭を512バイトずらす
001B4F E0EC 2004            12      JR  NZ,NCL3X1
001B51 E0EE 010002          10      LD  BC,512
001B54 E0F1 09              11      ADD HL,BC
       E0F2                     NCL3X1:
001B55 E0F2 F1              10      POP AF
001B56 E0F3 ED4B7CE7        20      LD  BC,(_FATBF)
001B5A E0F7 19              11      ADD HL,DE
001B5B E0F8 09              11      ADD HL,BC
001B5C E0F9 17               4      RLA
001B5D E0FA C9              10      RET
                                
       E0FB                     GNCL:
001B5E E0FB CDA2E0          17      CALL    NCL1        ;GET NEXT CLUSTER
001B61 E0FE D8              11      RET C
001B62 E0FF C5              11      PUSH    BC
001B63 E100 E5              11      PUSH    HL
001B64 E101 CDD5E0          17      CALL    NCL3
001B67 E104 3809            12      JR  C,GNC1
001B69 E106 5E               7      LD  E,(HL)
001B6A E107 23               6      INC HL
001B6B E108 7E               7      LD  A,(HL)
001B6C E109 E60F             7      AND 00FH
001B6E E10B 57               4      LD  D,A
001B6F E10C E1              10      POP HL
001B70 E10D C1              10      POP BC
001B71 E10E C9              10      RET
       E10F                     GNC1:
001B72 E10F 7E               7      LD  A,(HL)
001B73 E110 23               6      INC HL
001B74 E111 56               7      LD  D,(HL)
001B75 E112 0604             7      LD  B,4
       E114                     GNC1L:
001B77 E114 CB3A             8      SRL D   ;DA=DA/2
001B79 E116 1F               4      RRA     ;
001B7A E117 10FB            13      DJNZ    GNC1L
                                
001B7C E119 5F               4      LD  E,A
001B7D E11A E1              10      POP HL
001B7E E11B C1              10      POP BC
001B7F E11C A7               4      AND A
001B80 E11D C9              10      RET
                                
       E11E                     SNCL:
001B81 E11E CDA2E0          17      CALL    NCL1
001B84 E121 D8              11      RET C
                                ;               SET NEXT CLUSTER
001B85 E122 E5              11      PUSH    HL
001B86 E123 C5              11      PUSH    BC
001B87 E124 D5              11      PUSH    DE
001B88 E125 E5              11      PUSH    HL
001B89 E126 CDD5E0          17      CALL    NCL3
001B8C E129 D1              10      POP DE
                                ;CF=ODD
001B8D E12A 7E               7      LD  A,(HL)
001B8E E12B 73               7      LD  (HL),E
001B8F E12C 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
001B91 E12E 23               6      INC HL
001B92 E12F ED67            18      RRD     ;M={A[3:0],E[3:0]}
001B94 E131 7A               4      LD  A,D
001B95 E132 1804            12      JR  SNC11
       E134                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
001B97 E134 ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001B99 E136 23               6      INC HL
001B9A E137 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E138                     SNC11:
001B9B E138 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
001B9D E13A B7               4      OR  A
001B9E E13B D1              10      POP DE
001B9F E13C C1              10      POP BC
001BA0 E13D E1              10      POP HL
       E13E                     FAT_CHANGED:
001BA1 E13E 3EFF             7      LD  A,0FFH
001BA3 E140 32A2E6          13      LD  (_WTFATF),A
001BA6 E143 C9              10      RET
                                
       E144                     N16CL3:
001BA7 E144 C5              11      PUSH    BC
001BA8 E145 6B               4      LD  L,E
001BA9 E146 7A               4      LD  A,D
001BAA E147 E601             7      AND 1
001BAC E149 67               4      LD  H,A
001BAD E14A 29              11      ADD HL,HL
001BAE E14B ED4B7CE7        20      LD  BC,(_FATBF)
001BB2 E14F 09              11      ADD HL,BC
001BB3 E150 C1              10      POP BC
001BB4 E151 C9              10      RET
                                
       E152                     GNCL16:
001BB5 E152 CD9BE0          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
001BB8 E155 D8              11      RET C
001BB9 E156 E5              11      PUSH    HL
001BBA E157 CD44E1          17      CALL    N16CL3
001BBD E15A 5E               7      LD  E,(HL)
001BBE E15B 23               6      INC HL
001BBF E15C 56               7      LD  D,(HL)
001BC0 E15D E1              10      POP HL
001BC1 E15E C9              10      RET
                                
       E15F                     SNCL16:
001BC2 E15F CD9BE0          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
001BC5 E162 D8              11      RET C
001BC6 E163 D5              11      PUSH    DE
001BC7 E164 E5              11      PUSH    HL
001BC8 E165 CD44E1          17      CALL    N16CL3
001BCB E168 D1              10      POP DE      ;HL
001BCC E169 73               7      LD  (HL),E
001BCD E16A 23               6      INC HL
001BCE E16B 72               7      LD  (HL),D
001BCF E16C 6B               4      LD  L,E
001BD0 E16D 62               4      LD  H,D
001BD1 E16E D1              10      POP DE
001BD2 E16F 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E171                     NEXTX:
001BD4 E171 3E00             7      LD  A,0 ;自己書き換え
       E172                     _SECPS  EQU $-1
001BD6 E173 3C               4      INC A
001BD7 E174 E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E175                     _NCPAT  EQU $-1
001BD9 E176 3272E1          13      LD  (_SECPS),A
001BDC E179 C9              10      RET
                                
       E17A                     GNCLX:
001BDD E17A CD71E1          17      CALL    NEXTX
001BE0 E17D C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001BE1 E17E C3F7E6          10      JP  _GNCL   ;次のクラスタを探す
                                
       E181                     RDFAT:
001BE4 E181 3E80             7      LD  A,080H
001BE6 E183 3270E6          13      LD  (CHECK),A
       E186                     RDFAT1:
001BE9 E186 3A88E6          13      LD  A,(_DRV)
001BEC E189 CD2BE4          17      CALL    CHGDRVR
001BEF E18C D8              11      RET C
001BF0 E18D DD7E12          19      LD  A,(IX+DPB_DEVICE)
001BF3 E190 CB6F             8      BIT 5,A
001BF5 E192 286E            12      JR  Z,RDFAT0X
001BF7 E194 2170E6          10      LD  HL,CHECK
001BFA E197 A6               7      AND (HL)
001BFB E198 77               7      LD  (HL),A
001BFC E199 110000          10      LD  DE,0        ;BPB
001BFF E19C 2A7CE7          16      LD  HL,(_FATBF)
001C02 E19F 0E00             7      LD  C,0
001C04 E1A1 CD03E3          17      CALL    DRD24
001C07 E1A4 3022            12      JR  NC,GETBPB
001C09 E1A6 2170E6          10      LD  HL,CHECK
001C0C E1A9 CB06            15      RLC (HL)
001C0E E1AB 3F               4      CCF
001C0F E1AC D8              11      RET C
001C10 E1AD DDCB0A1E        23      RR  (IX+DPB_FDMODE)
001C14 E1B1 3F               4      CCF         ;フロッピーディスクのFDモード(2D/2HD)を切り替える
001C15 E1B2 DDCB0A16        23      RL  (IX+DPB_FDMODE)
001C19 E1B6 3A84E6          13      LD  A,(_DRIVE)
001C1C E1B9 E603             7      AND 3
001C1E E1BB F680             7      OR  080H
001C20 E1BD 6F               4      LD  L,A
001C21 E1BE 26E6             7      LD  H,_CYL0/256
001C23 E1C0 3EFF             7      LD  A,0FFH
001C25 E1C2 3289E6          13      LD  (_DSK),A
001C28 E1C5 77               7      LD  (HL),A
001C29 E1C6 18BE            12      JR  RDFAT1
       E1C8                     GETBPB:
001C2B E1C8 FDE5            15      PUSH    IY
001C2D E1CA FD2A7CE7        20      LD  IY,(_FATBF) ;BPB
001C31 E1CE CDF1E6          17      CALL    _BPB2DPB
001C34 E1D1 FDE1            14      POP IY
001C36 E1D3 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001C39 E1D6 3027            12      JR  NC,GETBPBOK
001C3B E1D8 E60F             7      AND 00FH
001C3D E1DA FE07             7      CP  7
001C3F E1DC 37               4      SCF
001C40 E1DD C0              11      RET NZ
001C41 E1DE DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001C45 E1E2 21C0E7          10      LD  HL,M2D
001C48 E1E5 2008            12      JR  NZ,SETFDMODE
001C4A E1E7 2E04             7      LD  L,4
001C4C E1E9 CDECE2          17      CALL    CHECK_MAXSECSZ
001C4F E1EC D8              11      RET C
001C50 E1ED 2ED2             7      LD  L,M2HD-STABLE
       E1EF                     SETFDMODE:
001C52 E1EF DDE5            15      PUSH    IX
001C54 E1F1 D1              10      POP DE
001C55 E1F2 EDA0            16      LDI
001C57 E1F4 EDA0            16      LDI
001C59 E1F6 13               6      INC DE
001C5A E1F7 13               6      INC DE
001C5B E1F8 13               6      INC DE
001C5C E1F9 13               6      INC DE
001C5D E1FA 010C00          10      LD  BC,12
001C60 E1FD EDB0                    LDIR
       E1FF                     GETBPBOK:
001C62 E1FF CD97E3          17      CALL    CHGDRV2
       E202                     RDFAT0X:
001C65 E202 CDF7E2          17      CALL    RDFATS
001C68 E205 D8              11      RET C
001C69 E206 DDAE06          19      XOR (IX+DPB_FATID)
001C6C E209 C8              11      RET Z
001C6D E20A DD7E12          19      LD  A,(IX+DPB_DEVICE)
001C70 E20D CB5F             8      BIT 3,A
001C72 E20F 2803            12      JR  Z,RDFAT0X1
001C74 E211 CB6F             8      BIT 5,A
001C76 E213 C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E214                     RDFAT0X1:
001C77 E214 37               4      SCF
001C78 E215 C9              10      RET
                                
       E216                     POP_HL_SCF_RET:
001C79 E216 E1              10      POP HL
001C7A E217 37               4      SCF
001C7B E218 C9              10      RET
                                
       E219                     BPB2DPB:
001C7C E219 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
001C7F E21C B7               4      OR  A
001C80 E21D 37               4      SCF
001C81 E21E C0              11      RET NZ
       E21F                     BPBOK:
001C82 E21F FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001C85 E222 DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001C88 E225 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001C8B E228 DD7700          19      LD  (IX+DPB_FATLN),A
001C8E E22B FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
001C91 E22E DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
001C94 E231 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001C97 E234 FD660F          19      LD  H,(IY+15)
001C9A E237 DD750E          19      LD  (IX+DPB_FATPS),L
001C9D E23A FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001CA0 E23D FD5617          19      LD  D,(IY+23)
001CA3 E240 FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E243                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001CA6 E243 19              11      ADD HL,DE
001CA7 E244 10FD            13      DJNZ    BPBDP1
       E246                     BPBDP2:
001CA9 E246 DD7510          19      LD  (IX+DPB_DIRPS),L
001CAC E249 DD7411          19      LD  (IX+DPB_DIRPS+1),H
001CAF E24C E5              11      PUSH    HL
                                
001CB0 E24D FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
001CB3 E250 FD6612          19      LD  H,(IY+18)
001CB6 E253 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001CB9 E256 B7               4      OR  A
001CBA E257 28BD            12      JR  Z,POP_HL_SCF_RET
001CBC E259 0606             7      LD  B,6
       E25B                     BPBBPS1:
001CBE E25B 05               4      DEC B
001CBF E25C 0F               4      RRCA
001CC0 E25D 30FC            12      JR  NC,BPBBPS1
       E25F                     BPBDE1:
001CC2 E25F 29              11      ADD HL,HL
001CC3 E260 10FD            13      DJNZ    BPBDE1
                                
001CC5 E262 7C               4      LD  A,H
001CC6 E263 DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
001CC9 E266 D1              10      POP DE      ;DPB_DIRPS
001CCA E267 6C               4      LD  L,H
001CCB E268 2600             7      LD  H,0
001CCD E26A 19              11      ADD HL,DE       ;MAXDIR
001CCE E26B E5              11      PUSH    HL
001CCF E26C FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001CD2 E26F CB21             8      SLA C       ;*2
001CD4 E271 AF               4      XOR A
001CD5 E272 47               4      LD  B,A
001CD6 E273 ED42            15      SBC HL,BC
001CD8 E275 DD7514          19      LD  (IX+DPB_ADDCL),L
001CDB E278 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
001CDE E27B D1              10      POP DE      ;DE=DPB_MAXDIR
001CDF E27C FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001CE2 E27F FD6614          19      LD  H,(IY+20)
                                
001CE5 E282 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001CE8 E285 E60F             7      AND 00FH
001CEA E287 FE07             7      CP  7       ;フロッピー
001CEC E289 2019            12      JR  NZ,NOT_FD
001CEE E28B E5              11      PUSH    HL
001CEF E28C FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001CF2 E28F DD710D          19      LD  (IX+DPB_MAXSEC),C
001CF5 E292 AF               4      XOR A
001CF6 E293 CB21             8      SLA C       ;両面なのでセクタ数を２倍
001CF8 E295 0610             7      LD  B,16
       E297                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001CFA E297 29              11      ADD HL,HL
001CFB E298 17               4      RLA
001CFC E299 B9               4      CP  C
001CFD E29A 3802            12      JR  C,DIVSEC1
001CFF E29C 91               4      SUB C
001D00 E29D 2C               4      INC L
       E29E                     DIVSEC1:
001D01 E29E 10F7            13      DJNZ    DIVSEC
001D03 E2A0 DD750C          19      LD  (IX+DPB_MAXCYL),L
001D06 E2A3 E1              10      POP HL  ;ここまでフロッピー専用
       E2A4                     NOT_FD:
001D07 E2A4 7C               4      LD  A,H
001D08 E2A5 B5               4      OR  L
001D09 E2A6 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001D0B E2A8 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001D0D E2AA 2F               4      CPL         ;A=0FFH
001D0E E2AB FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001D11 E2AE D8              11      RET C
001D12 E2AF FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001D15 E2B2 FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001D18 E2B5 FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E2B8                     BPB16BIT:
001D1B E2B8 ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001D1D E2BA DE00             7      SBC A,0
001D1F E2BC FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E2BF                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001D22 E2BF CB18             8      RR  B       ;->CY
001D24 E2C1 3808            12      JR  C,BPBTC2
001D26 E2C3 CB3F             8      SRL A
001D28 E2C5 CB1C             8      RR  H       ;AHL=AHL/2
001D2A E2C7 CB1D             8      RR  L
001D2C E2C9 18F4            12      JR  BPBTC1
       E2CB                     BPBTC2:
001D2E E2CB C6FF             7      ADD A,0FFH
001D30 E2CD D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001D31 E2CE 23               6      INC HL
001D32 E2CF 23               6      INC HL
001D33 E2D0 DD7508          19      LD  (IX+DPB_MAXCL),L
001D36 E2D3 DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001D39 E2D6 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001D3C E2D9 DD7706          19      LD  (IX+DPB_FATID),A
                                
001D3F E2DC FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001D42 E2DF C6FE             7      ADD A,0-2       ;>2:CF=1
001D44 E2E1 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001D47 E2E4 6F               4      LD  L,A
001D48 E2E5 3002            12      JR  NC,BPBFAT1
001D4A E2E7 F680             7      OR  080H
       E2E9                     BPBFAT1:            ;ここではCF=0
001D4C E2E9 DD770F          19      LD  (IX+DPB_BPS),A
       E2EC                     CHECK_MAXSECSZ:
001D4F E2EC 3A7BE7          13      LD  A,(_MAX_SEC_SZ_H)
001D52 E2EF BD               4      CP  L
001D53 E2F0 C8              11      RET Z       ;1セクタ1024バイト
001D54 E2F1 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001D55 E2F2 C8              11      RET Z       ;1セクタ256バイト
001D56 E2F3 2D               4      DEC L
001D57 E2F4 C8              11      RET Z       ;1セクタ512バイト
001D58 E2F5 37               4      SCF
001D59 E2F6 C9              10      RET
                                
       E2F7                     RDFATS:
001D5A E2F7 CD22E3          17      CALL    FATSETUP
001D5D E2FA D8              11      RET C
001D5E E2FB CD05E3          17      CALL    DRD24B
001D61 E2FE 2A7CE7          16      LD  HL,(_FATBF)
001D64 E301 7E               7      LD  A,(HL)
001D65 E302 C9              10      RET
                                
       E303                     DRD24:
001D66 E303 0601             7      LD  B,1
       E305                     DRD24B:
001D68 E305 DDE5            15      PUSH    IX
001D6A E307 DD2AA8E6        20      LD  IX,(_DPB)
001D6E E30B CD09CB          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E30C                     DRDPAT  EQU $-2
001D71 E30E DDE1            14      POP IX
001D73 E310 C9              10      RET
                                
       E311                     DWT24:
001D74 E311 0601             7      LD  B,1
       E313                     DWT24B:
001D76 E313 DDE5            15      PUSH    IX
001D78 E315 DD2AA8E6        20      LD  IX,(_DPB)
001D7C E319 CD6EE4          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E31A                     DWTPAT  EQU $-2
001D7F E31C DDE1            14      POP IX
001D81 E31E D0              11      RET NC
001D82 E31F C35AE6          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E322                     FATSETUP:
001D85 E322 3AAAE6          13      LD  A,(_FATDRV)
001D88 E325 CD2BE4          17      CALL    CHGDRVR     ;ドライブ切り替え
001D8B E328 D8              11      RET C
       E329                     FATS2:
001D8C E329 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001D8F E32C 0F               4      RRCA
001D90 E32D CD5DE3          17      CALL    FATSETUP12  ;自己書き換え
       E32E                     FATSX   EQU $-2
001D93 E330 210000          10      LD  HL,0
001D96 E333 4A               4      LD  C,D
001D97 E334 54               4      LD  D,H
001D98 E335 3AABE6          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
001D9B E338 47               4      LD  B,A
001D9C E339 04               4      INC B
001D9D E33A DD7E00          19      LD  A,(IX+DPB_FATLN)
       E33D                     FAT_SKP:
001DA0 E33D 05               4      DEC B
001DA1 E33E 2809            12      JR  Z,FAT1
001DA3 E340 19              11      ADD HL,DE
001DA4 E341 93               4      SUB E
001DA5 E342 30F9            12      JR  NC,FAT_SKP
001DA7 E344 DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
001DAB E348 C8              11      RET Z
       E349                     FAT1:
001DAC E349 EB               4      EX  DE,HL
001DAD E34A B7               4      OR  A       ;0の場合は0100Hとして扱う
001DAE E34B 2803            12      JR  Z,FAT3
001DB0 E34D B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001DB1 E34E 3801            12      JR  C,FAT2
       E350                     FAT3:
001DB3 E350 79               4      LD  A,C
       E351                     FAT2:
001DB4 E351 47               4      LD  B,A
                                
001DB5 E352 2AFAE7          16      LD  HL,(_FATPS) ;fat sector pos
001DB8 E355 19              11      ADD HL,DE
001DB9 E356 EB               4      EX  DE,HL
001DBA E357 2A7CE7          16      LD  HL,(_FATBF)
001DBD E35A AF               4      XOR A       ;CF=0
001DBE E35B 4F               4      LD  C,A
001DBF E35C C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E35D                     FATSETUP12:
001DC0 E35D 110606          10      LD  DE,0606H    ;256
001DC3 E360 D8              11      RET C
001DC4 E361 110303          10      LD  DE,0303H    ;512
001DC7 E364 0F               4      RRCA
001DC8 E365 D8              11      RET C
001DC9 E366 110102          10      LD  DE,0201H    ;1024
001DCC E369 C9              10      RET
                                
       E36A                     FATSETUP16:
001DCD E36A 110404          10      LD  DE,0404H    ;256
001DD0 E36D D8              11      RET C
001DD1 E36E 110202          10      LD  DE,0202H    ;512
001DD4 E371 0F               4      RRCA
001DD5 E372 D8              11      RET C
001DD6 E373 110101          10      LD  DE,0101H    ;1024
001DD9 E376 C9              10      RET
                                
       E377                     CHGDRV:
001DDA E377 E5              11      PUSH    HL
001DDB E378 2189E6          10      LD  HL,_DSK
001DDE E37B BE               7      CP  (HL)
001DDF E37C 280A            12      JR  Z,CHGDRVE
       E37E                     CHGDRV1:
001DE1 E37E DDE5            15      PUSH    IX
001DE3 E380 CD8AE3          17      CALL    CHGDRV0
001DE6 E383 3A89E6          13      LD  A,(_DSK)
001DE9 E386 DDE1            14      POP IX
       E388                     CHGDRVE:
001DEB E388 E1              10      POP HL
001DEC E389 C9              10      RET
                                
       E38A                     CHGDRV0:
001DED E38A 6F               4      LD  L,A
001DEE E38B CDDCE6          17      CALL    _GETDPB
001DF1 E38E D8              11      RET C
001DF2 E38F DD22A8E6        20      LD  (_DPB),IX
001DF6 E393 7D               4      LD  A,L
001DF7 E394 3289E6          13      LD  (_DSK),A
       E397                     CHGDRV2:
001DFA E397 C5              11      PUSH    BC
001DFB E398 D5              11      PUSH    DE
001DFC E399 ED73E2E3        20      LD  (SPPAT2),SP
001E00 E39D F3               4      DI
001E01 E39E DDF9            10      LD  SP,IX
                                
001E03 E3A0 E1              10      POP HL      ;00:DPB_FATLN
001E04 E3A1 E1              10      POP HL      ;02:DPB_DRD
001E05 E3A2 220CE3          16      LD  (DRDPAT),HL
                                
001E08 E3A5 E1              10      POP HL
001E09 E3A6 221AE3          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001E0C E3A9 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001E0D E3AA 7C               4      LD  A,H
001E0E E3AB 320EDA          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001E11 E3AE 3D               4      DEC A
001E12 E3AF 3275E1          13      LD  (_NCPAT),A
                                
001E15 E3B2 E1              10      POP HL      ;08:DPB_MAXCL
001E16 E3B3 7D               4      LD  A,L
001E17 E3B4 322DDA          13      LD  (CLPAT2),A
001E1A E3B7 7C               4      LD  A,H
001E1B E3B8 3229DA          13      LD  (CLPAT1),A
001E1E E3BB 2B               6      DEC HL
001E1F E3BC 222CDC          16      LD  (MAXCLP),HL
                                
001E22 E3BF E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001E23 E3C0 4C               4      LD  C,H
                                
001E24 E3C1 E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001E25 E3C2 E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001E26 E3C3 7C               4      LD  A,H     ;DPB_BPS
001E27 E3C4 E607             7      AND 7
001E29 E3C6 32E7DE          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001E2C E3C9 87               4      ADD A,A     ;8  4   2
001E2D E3CA 87               4      ADD A,A     ;010H   8   4
001E2E E3CB 87               4      ADD A,A     ;020H   010H    8
001E2F E3CC 328CD8          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001E32 E3CF 2600             7      LD  H,0
001E34 E3D1 22FAE7          16      LD  (_FATPS),HL
                                
001E37 E3D4 E1              10      POP HL      ;10:DPB_DIRPS
001E38 E3D5 22FCE7          16      LD  (_DIRPS),HL
                                
001E3B E3D8 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001E3C E3D9 7C               4      LD  A,H
001E3D E3DA 3284E6          13      LD  (_DRIVE),A
                                
001E40 E3DD E1              10      POP HL      ;14:DPB_ADDCL
001E41 E3DE 221EDA          16      LD  (CLSPAT),HL
                                
001E44 E3E1 310000          10      LD  SP,0        ;元のSPを復元
       E3E2                     SPPAT2  EQU $-2
001E47 E3E4 FB               4      EI
001E48 E3E5 2AFCE7          16      LD  HL,(_DIRPS)
001E4B E3E8 0600             7      LD  B,0
001E4D E3EA 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001E4E E3EB 22A7D8          16      LD  (MD_PAT),HL
                                
001E51 E3EE 2A2CDC          16      LD  HL,(MAXCLP)
001E54 E3F1 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001E57 E3F4 19              11      ADD HL,DE
001E58 E3F5 380F            12      JR  C,SETFAT16
001E5A E3F7 21FBE0          10      LD  HL,GNCL     ;FAT12
001E5D E3FA 111EE1          10      LD  DE,SNCL
001E60 E3FD 015DE3          10      LD  BC,FATSETUP12
001E63 E400 DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001E67 E404 180D            12      JR  EXTRA1
       E406                     SETFAT16:
001E69 E406 2152E1          10      LD  HL,GNCL16   ;FAT16
001E6C E409 115FE1          10      LD  DE,SNCL16
001E6F E40C 016AE3          10      LD  BC,FATSETUP16
001E72 E40F DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       E413                     EXTRA1:
001E76 E413 22F8E6          16      LD  (GNCPAT),HL
001E79 E416 ED53FBE6        20      LD  (SNCPAT),DE
001E7D E41A ED432EE3        20      LD  (FATSX),BC
001E81 E41E D1              10      POP DE
001E82 E41F C1              10      POP BC
001E83 E420 AF               4      XOR A
001E84 E421 C9              10      RET
                                
       E422                     GETDPBD:
001E85 E422 DDE3            23      EX  (SP),IX
001E87 E424 DDE5            15      PUSH    IX
001E89 E426 3A88E6          13      LD  A,(_DRV)
001E8C E429 1807            12      JR  GETDPB1
                                
       E42B                     CHGDRVR:
001E8E E42B CDD9E6          17      CALL    _CHGDRV
001E91 E42E D8              11      RET C
001E92 E42F 3A89E6          13      LD  A,(_DSK)
       E432                     GETDPB1:
001E95 E432 C3DCE6          10      JP  _GETDPB
                                
       E435                     GETDPB:
001E98 E435 FE08             7      CP  8
001E9A E437 3F               4      CCF
001E9B E438 D8              11      RET C
001E9C E439 0F               4      RRCA
001E9D E43A 0F               4      RRCA
001E9E E43B 0F               4      RRCA
001E9F E43C DD                      DB  0DDH        ;Z80未定義命令
001EA0 E43D 6F               4      LD  L,A     ;LD IXL,A
001EA1 E43E DD                      DB  0DDH        ;Z80未定義命令
001EA2 E43F 26E8             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001EA4 E441 DD7E00          19      LD  A,(IX+DPB_FATLN)
001EA7 E444 A7               4      AND A       ;CF=0の為
001EA8 E445 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001EAC E449 C0              11      RET NZ      ;FAT16
001EAD E44A DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001EB1 E44E C0              11      RET NZ      ;BPB
001EB2 E44F FE01             7      CP  001H        ;A=0 THEN CF=1
001EB4 E451 C9              10      RET
                                
       E452                     _SYS5F:
001EB5 E452 AF               4      XOR A
       E453                     FFLUSH:
001EB6 E453 F5              11      PUSH    AF
001EB7 E454 CD79E0          17      CALL    WTFATX
001EBA E457 AF               4      XOR A
001EBB E458 32ABE6          13      LD  (_FATIX),A
001EBE E45B 2F               4      CPL         ;0FFH
001EBF E45C 32AAE6          13      LD  (_FATDRV),A
001EC2 E45F 3E                      DB  03EH        ;次のPUSH AFをスキップ
       E460                     FFLUSHBUF:
001EC3 E460 F5              11      PUSH    AF
001EC4 E461 CD2FE0          17      CALL    DWTX
001EC7 E464 3EFF             7      LD  A,0FFH
001EC9 E466 3239E6          13      LD  (SFILE),A
001ECC E469 32A5E6          13      LD  (_DBDRV),A
001ECF E46C F1              10      POP AF
001ED0 E46D C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "MSXDISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MSX
                                
                                ;   PHYDIO DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       E46E                     WTTRK:
       E46E                     FDWT:
001ED1 E46E 37               4      SCF
001ED2 E46F C9              10      RET
                                
       E470                     PDWT:
001ED3 E470 37               4      SCF
001ED4 E471 CB7C             8      BIT 7,H
001ED6 E473 2058            12      JR  NZ,PDWX
001ED8 E475 CD60E4          17      CALL    FFLUSHBUF
       E478                     PDWT1:
001EDB E478 C5              11      PUSH    BC
001EDC E479 D5              11      PUSH    DE
001EDD E47A ED5B7EE7        20      LD  DE,(_DTBUF)
001EE1 E47E DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001EE4 E481 E607             7      AND 7
001EE6 E483 47               4      LD  B,A
001EE7 E484 0E00             7      LD  C,0
001EE9 E486 EDB0                    LDIR
001EEB E488 E3              19      EX  (SP),HL
001EEC E489 EB               4      EX  DE,HL
001EED E48A D5              11      PUSH    DE
001EEE E48B 2A7EE7          16      LD  HL,(_DTBUF)
001EF1 E48E 0601             7      LD  B,1
001EF3 E490 37               4      SCF
001EF4 E491 CDCDE4          17      CALL    PDWX
001EF7 E494 3832            12      JR  C,PDRWERR
001EF9 E496 D1              10      POP DE
001EFA E497 13               6      INC DE
001EFB E498 E1              10      POP HL
001EFC E499 C1              10      POP BC
001EFD E49A 10D4            13      DJNZ    PDWT
001EFF E49C AF               4      XOR A
001F00 E49D C9              10      RET
       E49E                     PDRD:
001F01 E49E CB7C             8      BIT 7,H
001F03 E4A0 202A            12      JR  NZ,PDWXR
001F05 E4A2 CD60E4          17      CALL    FFLUSHBUF
       E4A5                     PDRD1:
001F08 E4A5 C5              11      PUSH    BC
001F09 E4A6 D5              11      PUSH    DE
001F0A E4A7 E5              11      PUSH    HL
001F0B E4A8 2A7EE7          16      LD  HL,(_DTBUF)
001F0E E4AB 0601             7      LD  B,1
001F10 E4AD CDCCE4          17      CALL    PDWXR
001F13 E4B0 3816            12      JR  C,PDRWERR
001F15 E4B2 D1              10      POP DE
001F16 E4B3 2A7EE7          16      LD  HL,(_DTBUF)
001F19 E4B6 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001F1C E4B9 E607             7      AND 7
001F1E E4BB 47               4      LD  B,A
001F1F E4BC 0E00             7      LD  C,0
001F21 E4BE EDB0                    LDIR
001F23 E4C0 EB               4      EX  DE,HL
001F24 E4C1 D1              10      POP DE
001F25 E4C2 13               6      INC DE
001F26 E4C3 C1              10      POP BC
001F27 E4C4 10D8            13      DJNZ    PDRD
001F29 E4C6 AF               4      XOR A
001F2A E4C7 C9              10      RET
       E4C8                     PDRWERR:
001F2B E4C8 E1              10      POP HL
001F2C E4C9 D1              10      POP DE
001F2D E4CA C1              10      POP BC
001F2E E4CB C9              10      RET
       E4CC                     PDWXR:
001F2F E4CC A7               4      AND A
       E4CD                     PDWX:                   ;CF=0 READ CF=1 WRITE
001F30 E4CD DDCB1266        20      BIT 4,(IX+DPB_DEVICE)   ;デバイス情報
001F34 E4D1 2003            12      JR  NZ,PDWX1
001F36 E4D3 DD4E06          19      LD  C,(IX+DPB_FATID)    ;メディアバイト
       E4D6                     PDWX1:
001F39 E4D6 DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
001F3C E4D9 C5              11      PUSH    BC
001F3D E4DA D5              11      PUSH    DE
001F3E E4DB E5              11      PUSH    HL
001F3F E4DC DDE5            15      PUSH    IX
001F41 E4DE FDE5            15      PUSH    IY
001F43 E4E0 CDA7FF          17      CALL    H_PHYD
001F46 E4E3 FDE1            14      POP IY
                                ;   LD  IX,PHYDIO
                                ;   CALL    CALSLT_R
001F48 E4E5 DDE1            14      POP IX
001F4A E4E7 E1              10      POP HL
001F4B E4E8 D1              10      POP DE
001F4C E4E9 C1              10      POP BC
001F4D E4EA D8              11      RET C
       E4EB                     PDWX2:
001F4E E4EB 13               6      INC DE
001F4F E4EC DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001F52 E4EF E607             7      AND 7
001F54 E4F1 84               4      ADD A,H
001F55 E4F2 67               4      LD  H,A
001F56 E4F3 10F6            13      DJNZ    PDWX2
001F58 E4F5 AF               4      XOR A
001F59 E4F6 C9              10      RET
[EOF:MSXDISK2.ASM:UTF_8]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001F5A E4F7                     PATHD:  DS  PATHX
001F95 E532 00                  PATHE:  DB  0
                                
       E533                     DTA_CCP:
001F96 E533                         DS  37
                                
       E558                     FCB_BAT:
001FBB E558                         DS  37
                                
001FE0 E57D 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001FEB E588 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
                                ;   ALIGN   256
       E58F                     AT_WORK:
001FF2 E58F                         DS  WORKAD-AT_WORK
                                
       E600                     CPM_BOOT:
002063 E600 C30000          10      JP  0
       E603                     _SYS00:     ;(BDOS)プログラム終了
       E603                     CPM_WBOOT:
002066 E603 C3A8CB          10      JP  WBOOT1
       E606                     CPM_CONST:
002069 E606 C3FBD3          10      JP  CONSTX
       E609                     _SYS07:     ;(BDOS)コンソール直接入力
       E609                     CPM_CONIN:
00206C E609 C31CD3          10      JP  FLGET
       E60C                     CPM_CONOUT:
00206F E60C C3FED4          10      JP  CONOUT1
                                
       E60F                     DECBF:              ;10進数表示時のバッファ(5バイト)
002072 E60F                         DS  5
       E60F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       E611                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       E614                     FDRV:
002077 E614 00                      DB  0
       E615                     FNAME:
002078 E615                         DS  36
       E639                     SFILE:
00209C E639                         DS  33      ;DRV FILENAME
       E65A                     _DISKE:
0020BD E65A C398D2          10      JP  SHOW_ERROR
                                
0020C0 E65D 0000                LEFTX:  DW  0
0020C2 E65F 0000                DTAX:   DW  0
                                
                                ;   PSGのビープ音のデータ(X1)
       E661                     BEEPD:
0020C4 E661 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
0020CC E669 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                ;
       E662                     RTC_YY  EQU BEEPD+1 ;RTCのバッファ年(88)
       E663                     RTC_MW  EQU BEEPD+2 ;RTCのバッファ月(88)
       E664                     RTC_DD  EQU BEEPD+3 ;RTCのバッファ日(88)
       E665                     RTC_TT  EQU BEEPD+4 ;RTCのバッファ時(88)
       E666                     RTC_MM  EQU BEEPD+5 ;RTCのバッファ分(88)
       E667                     RTC_SS  EQU BEEPD+6 ;RTCのバッファ秒(88)
       E662                     ROM_SLT EQU BEEPD+1 ;ROMのスロット(MSX)
       E661                     ZERO    EQU BEEPD
                                
       E670                     CHECK:
0020D3 E670 00                      DB  0
                                
       E671                     OK:
0020D4 E671 4F4B24                  DB  "OK$"
0020D7 E674                         DS  5
       E679                     COMERM:
0020DC E679 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       E680                     _CYL0:
0020E3 E680 FF                      DB  0FFH    ;Cylinder
       E681                     _CYL1:
0020E4 E681 FF                      DB  0FFH    ;Cylinder
       E682                     _CYL2:
0020E5 E682 FF                      DB  0FFH    ;Cylinder
       E683                     _CYL3:
0020E6 E683 FF                      DB  0FFH    ;Cylinder
       E684                     _DRIVE:
0020E7 E684 00                      DB  0   ;unit number
       E685                     _SEEKSP:
0020E8 E685 00                      DB  0   ;Seek speed
       E686                     _ISEEK:
0020E9 E686 32                      DB  50  ;
0020EA E687                         DS  1
       E688                     _DRV:
0020EB E688 00                      DB  0
       E689                     _DSK:
0020EC E689 FF                      DB  0FFH
       E68A                     _DTA:
0020ED E68A 8000                    DW  00080H
       E68C                     _CTC:
0020EF E68C 0000                    DW  0
       E68E                     _TXADR:
0020F1 E68E 0000                    DW  0
       E690                     _KEYPS:
0020F3 E690 0000                    DW  0
       E692                     _KEYD:
0020F5 E692 00                      DB  000H    ;キーデータ
       E693                     _KEYST:
0020F6 E693 FF                      DB  0FFH    ;キーステータス(SHIFT,CTRLの状態)
       E694                     _KEYSP_L:
0020F7 E694 00                      DB  KEYSP_L ;オートリピートの速度
       E695                     _KEYSP_H:
0020F8 E695 00                      DB  KEYSP_H ;オートリピートの速度
       E696                     _COLORF:
0020F9 E696 00                      DB  COLORF  ;色
       E697                     _LINE:
0020FA E697 18                      DB  LINE
                                
                                            ;次のファイルの検索(C=12)で使用するFCB
       E698                     _FCB:
0020FB E698 0000                    DW  0   ;SEARCH FILES
       E69A                     _FBPS:
0020FD E69A 0000                    DW  0   ;    //
       E69C                     _FBAD:
0020FF E69C 0000                    DW  0   ;    //
       E69E                     _FBCNT:
002101 E69E 00                      DB  0   ;    //
       E69F                     _FILEN:
002102 E69F 00                      DB  0   ;    //
       E6A0                     _DIRF:
002103 E6A0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
002104 E6A1                         DS  1
       E6A2                     _WTFATF:
002105 E6A2 00                      DB  0   ;FATバッファの更新フラグ
002106 E6A3                         DS  1
       E6A4                     _WTDBF:
002107 E6A4 00                      DB  0   ;データバッファの更新フラグ
       E6A5                     _DBDRV:
002108 E6A5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       E6A6                     _DBSEC:
002109 E6A6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       E6A8                     _DPB:
00210B E6A8 0000                    DW  0
       E6AA                     _FATDRV:
00210D E6AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       E6AB                     _FATIX:
00210E E6AB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       E6AC                     _FAKEFREE:
00210F E6AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
002111 E6AE                         DS  2
                                ;   画面周りのデータ
       E6B0                     CRTCD:
002113 E6B0 6F                      DB  06FH
       E6B1                     _WIDTH:
002114 E6B1 28                      DB  WIDTH
       E6B2                     TVRAMTOP:
002115 E6B2 5938                    DB  059H,038H
002117 E6B4 1F02                    DB  01FH,002H
       E6B6                     _LINE2:
002119 E6B6 19                      DB  019H
       E6B7                     WKE4:
00211A E6B7 1C                      DB  01CH
       E6B8                     WKE6:
00211B E6B8 00                      DB  000H
       E6B9                     WK40:
00211C E6B9 07                      DB  007H
       E6BA                     _PAGE_MINUS:
00211D E6BA 40FC                    DW  0-WIDTH*LINE
       E6BC                     _WIDTH_MINUS:
00211F E6BC D8FF                    DW  0-WIDTH
       E6BE                     WK30:
002121 E6BE 0C                      DB  00CH
       E6BF                     WK31:
       E6BF                     WK1FD0:
002122 E6BF 20                      DB  020H
                                
                                ;   割り込みベクタ(X1)
002123 E6C0 0000                CTC0:   DW  INTCTCE
002125 E6C2 0000                CTC1:   DW  INTCTCE
002127 E6C4 0000                CTC2:   DW  INTCTCE
002129 E6C6 0000                CTC3:   DW  INTCTCE
00212B E6C8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
00212D E6CA C361D3          10  _INKEY: JP  INKEY
002130 E6CD C3A1D2          10  _PRINT: JP  PRINT
002133 E6D0 C398D4          10  _SCRN:  JP  SCRN
002136 E6D3 C378D4          10  _POS:   JP  POS
002139 E6D6 C383D4          10  _LOC:   JP  LOC
       E6D9                     _CHGDRV:
00213C E6D9 C377E3          10      JP  CHGDRV
       E6DC                     _GETDPB:
00213F E6DC C335E4          10      JP  GETDPB
       E6DF                     _FFLUSH:
002142 E6DF C353E4          10      JP  FFLUSH
       E6E2                     _RDFATX:
002145 E6E2 C34FE0          10      JP  RDFATX
002148 E6E5 C381E1          10  _RDFAT: JP  RDFAT
00214B E6E8 C36EE4          10  _WTTRK: JP  WTTRK
00214E E6EB C309CB          10  _FDRD:  JP  FDRD
002151 E6EE C36EE4          10  _FDWT:  JP  FDWT
       E6F1                     _BPB2DPB:
002154 E6F1 C319E2          10      JP  BPB2DPB
       E6F4                     _BREAK:
002157 E6F4 C323CD          10      JP  END_BATCH
       E6F7                     _GNCL:
00215A E6F7 C3FBE0          10      JP  GNCL        ; self-modifying code
       E6F8                     GNCPAT  EQU $-2
       E6FA                     _SNCL:
00215D E6FA C31EE1          10      JP  SNCL        ; self-modifying code
       E6FB                     SNCPAT  EQU $-2
       E6FD                     _COMANL:
002160 E6FD C3DCCB          10      JP  COMANL
                                
       E700                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       E700                     STABLE:
                                ;0
002163 E700 03E6A4D2D5D2B9D8        DW  _SYS00,_SYS01,_SYS02,_SYS03
00216B E708 03D003D0DBD209E6        DW  _SYS04,_SYS05,_SYS06,_SYS07
002173 E710 E3D205D067D3FBD3        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
00217B E718 1AD01FD02ED03FD0        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
002183 E720 93D0DAD023D154D1        DW  _SYS10,_SYS11,_SYS12,_SYS13
00218B E728 5CD172D187D17FD1        DW  _SYS14,_SYS15,_SYS16,_SYS17
002193 E730 CED1D3D1D8D1DED1        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
00219B E738 03D004D203D008D2        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
0021A3 E740 03D0BED1C6D10FD2        DW  _SYS20,_SYS21,_SYS22,_SYS23
0021AB E748 34D203D00FDDDDDD        DW  _SYS24,_ERROR,_SYS26,_SYS27
0021B3 E750 C6D13ED20DD4B9D8        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
0021BB E758 5DD4B9D803D05FD2        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
0021C3 E760 59D203D003D003D0        DW  _SYS30,_ERROR,_ERROR,_ERROR
0021CB E768 03D003D003D003D0        DW  _ERROR,_ERROR,_ERROR,_ERROR
0021D3 E770 03D0B9D8B9D880D2        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
0021DB E778 E7CF                    DW  _DOS2
                                
0021DD E77A                         DS  1
       E77B                     _MAX_SEC_SZ_H:
0021DE E77B 02                      DB  MAX_SEC_SZ_H
                                
                                ;   FATバッファのアドレス
       E77C                     _FATBF:
0021DF E77C 00E9                    DW  FATBF
                                
                                ;   データバッファのアドレス
       E77E                     _DTBUF:
0021E1 E77E 00EF                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       E780                     CTRLTB:
0021E3 E780 00000000A8D40000        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
0021EB E788 0000000000000000        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
0021F3 E790 0000000000000000        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
0021FB E798 0000000000000000        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
002203 E7A0 0000000000000000        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
00220B E7A8 0000000000000000        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
002213 E7B0 0000000000000000        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
00221B E7B8 0000000000000000        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
                                ;   2D/2DDでBPBがない場合のデフォルト値(2D/360KB/9セクタ1024バイト)
002223 E7C0 0200                M2D:    DW  2
002225 E7C2 FD02                    DB  0FDH,2
002227 E7C4 6401                    DW  356
002229 E7C6 FF0728090182            DB  0FFH,7,40,9,1,082H
00222F E7CC 0500A7000800            DW  5,0A7H,8
                                
                                ;   2HDでBPBがない場合のデフォルト値(2HD/1.23MB/8セクタ1024バイト)
002235 E7D2 0200                M2HD:   DW  2
002237 E7D4 FE01                    DB  0FEH,1
002239 E7D6 C704                    DW  1223
00223B E7D8 FE064D080184            DB  0FEH,6,77,8,1,084H
002241 E7DE 0500A7000900            DW  5,0A7H,9
                                
                                ;   ディレクトリエントリとFCBの変換テーブル(日付+時刻+サイズ)
002247 E7E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
002249 E7E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
00224B E7E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
00224D E7EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       E7EE                     SDDATAE:
                                
002251 E7EE                         DS  2
                                
                                ;   バッチファイルのFCB
       E7F0                     _FCB_BAT:
002253 E7F0 58E5                    DW  FCB_BAT
       E7F2                     _PATH:
002255 E7F2 F7E4                    DW  PATHD
                                
002257 E7F4                     SCDIR:  DS  2       ;+14 +15
002259 E7F6                     SFBPS:  DS  2       ;FBPS
00225B E7F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
00225D E7FA 0000                _FATPS: DW  0
00225F E7FC 0000                _DIRPS: DW  0
002261 E7FE 0000                _CLPS:  DW  0
                                
       E800                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "MSXDPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MSX
                                
       E800                     _DEVICE:
                                
                                ;   A:
                                
002263 E800 0300                    DW  3   ;DPB_FATLN
002265 E802 EBE6                    DW  _FDRD   ;DPB_DRD
002267 E804 EEE6                    DW  _FDWT   ;DPB_DWT
002269 E806 F9                      DB  0F9H    ;DPB_FATID
00226A E807 03                      DB  3   ;DPB_SECPCL
00226B E808 CB02                    DW  715 ;DPB_MAXCL
00226D E80A 00                      DB  0   ;DPB_FDMODE
00226E E80B 07                      DB  7   ;DPB_DIRSCNT
00226F E80C 01                      DB  1   ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002270 E80D 00                      DB  0   ;DPB_MAXSEC
002271 E80E 01                      DB  1   ;DPB_FATPS
002272 E80F 82                      DB  082H    ;DPB_BPS
002273 E810 0700                    DW  7   ;DPB_DIRPS
002275 E812 2E                      DB  02EH    ;DPB_DEVICE
002276 E813 00                      DB  0   ;DPB_UNITNO
002277 E814 0A00                    DW  10  ;DPB_ADDCL
002279 E816 0000                    DW  0   ;DPB_16
00227B E818 0000                    DW  0   ;DPB_18
00227D E81A 0000                    DW  0   ;DPB_SDIR
00227F E81C 524F4D30                DB  "ROM0"  ;DPB_NAME
                                
                                ;   B:
                                
002283 E820 0300                    DW  3   ;DPB_FATLN
002285 E822 EBE6                    DW  _FDRD   ;DPB_DRD
002287 E824 EEE6                    DW  _FDWT   ;DPB_DWT
002289 E826 F9                      DB  0F9H    ;DPB_FATID
00228A E827 03                      DB  3   ;DPB_SECPCL
00228B E828 CB02                    DW  715 ;DPB_MAXCL
00228D E82A 00                      DB  0   ;DPB_FDMODE
00228E E82B 07                      DB  7   ;DPB_DIRSCNT
00228F E82C 2E                      DB  46  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002290 E82D 00                      DB  0   ;DPB_MAXSEC
002291 E82E 01                      DB  1   ;DPB_FATPS
002292 E82F 82                      DB  082H    ;DPB_BPS
002293 E830 0700                    DW  7   ;DPB_DIRPS
002295 E832 2E                      DB  02EH    ;DPB_DEVICE
002296 E833 01                      DB  1   ;DPB_UNITNO
002297 E834 0A00                    DW  10  ;DPB_ADDCL
002299 E836 0000                    DW  0   ;DPB_16
00229B E838 0000                    DW  0   ;DPB_18
00229D E83A 0000                    DW  0   ;DPB_SDIR
00229F E83C 524F4D31                DB  "ROM1"  ;DPB_NAME
                                
                                ;   C:
                                
0022A3 E840                         DS  32
                                
                                ;   D:
                                
0022C3 E860                         DS  32
                                
                                ;   E:
                                
0022E3 E880 0300                    DW  3   ;DPB_FATLN
0022E5 E882 9EE4                    DW  PDRD    ;DPB_DRD
0022E7 E884 70E4                    DW  PDWT    ;DPB_DWT
0022E9 E886 F9                      DB  0F9H    ;DPB_FATID
0022EA E887 03                      DB  3   ;DPB_SECPCL
0022EB E888 CB02                    DW  715 ;DPB_MAXCL
0022ED E88A FF                      DB  0FFH    ;DPB_FDMODE
0022EE E88B 07                      DB  7   ;DPB_DIRSCNT
0022EF E88C 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
0022F0 E88D 09                      DB  9   ;DPB_MAXSEC
0022F1 E88E 01                      DB  1   ;DPB_FATPS
0022F2 E88F 82                      DB  082H    ;DPB_BPS
0022F3 E890 0700                    DW  7   ;DPB_DIRPS
0022F5 E892 2D                      DB  02DH    ;DPB_DEVICE
0022F6 E893 00                      DB  0   ;DPB_UNITNO
0022F7 E894 0A00                    DW  10  ;DPB_ADDCL
0022F9 E896 0000                    DW  0   ;DPB_16
0022FB E898 0000                    DW  0   ;DPB_18
0022FD E89A 0000                    DW  0   ;DPB_SDIR
0022FF E89C 44534B30                DB  "DSK0"  ;DPB_NAME
                                
                                ;   F:
                                
002303 E8A0 0300                    DW  3   ;DPB_FATLN
002305 E8A2 9EE4                    DW  PDRD    ;DPB_DRD
002307 E8A4 70E4                    DW  PDWT    ;DPB_DWT
002309 E8A6 F9                      DB  0F9H    ;DPB_FATID
00230A E8A7 03                      DB  3   ;DPB_SECPCL
00230B E8A8 CB02                    DW  715 ;DPB_MAXCL
00230D E8AA FF                      DB  0FFH    ;DPB_FDMODE
00230E E8AB 07                      DB  7   ;DPB_DIRSCNT
00230F E8AC 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002310 E8AD 09                      DB  9   ;DPB_MAXSEC
002311 E8AE 01                      DB  1   ;DPB_FATPS
002312 E8AF 82                      DB  082H    ;DPB_BPS
002313 E8B0 0700                    DW  7   ;DPB_DIRPS
002315 E8B2 2D                      DB  02DH    ;DPB_DEVICE
002316 E8B3 01                      DB  1   ;DPB_UNITNO
002317 E8B4 0A00                    DW  10  ;DPB_ADDCL
002319 E8B6 0000                    DW  0   ;DPB_16
00231B E8B8 0000                    DW  0   ;DPB_18
00231D E8BA 0000                    DW  0   ;DPB_SDIR
00231F E8BC 44534B31                DB  "DSK1"  ;DPB_NAME
                                
                                ;   G:
                                
002323 E8C0 0300                    DW  3   ;DPB_FATLN
002325 E8C2 9EE4                    DW  PDRD    ;DPB_DRD
002327 E8C4 70E4                    DW  PDWT    ;DPB_DWT
002329 E8C6 F9                      DB  0F9H    ;DPB_FATID
00232A E8C7 03                      DB  3   ;DPB_SECPCL
00232B E8C8 CB02                    DW  715 ;DPB_MAXCL
00232D E8CA FF                      DB  0FFH    ;DPB_FDMODE
00232E E8CB 07                      DB  7   ;DPB_DIRSCNT
00232F E8CC 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002330 E8CD 09                      DB  9   ;DPB_MAXSEC
002331 E8CE 01                      DB  1   ;DPB_FATPS
002332 E8CF 82                      DB  082H    ;DPB_BPS
002333 E8D0 0700                    DW  7   ;DPB_DIRPS
002335 E8D2 2D                      DB  02DH    ;DPB_DEVICE
002336 E8D3 02                      DB  2   ;DPB_UNITNO
002337 E8D4 0A00                    DW  10  ;DPB_ADDCL
002339 E8D6 0000                    DW  0   ;DPB_16
00233B E8D8 0000                    DW  0   ;DPB_18
00233D E8DA 0000                    DW  0   ;DPB_SDIR
00233F E8DC 44534B32                DB  "DSK2"  ;DPB_NAME
                                
                                ;   H:
002343 E8E0 0300                    DW  3   ;DPB_FATLN
002345 E8E2 9EE4                    DW  PDRD    ;DPB_DRD
002347 E8E4 70E4                    DW  PDWT    ;DPB_DWT
002349 E8E6 F9                      DB  0F9H    ;DPB_FATID
00234A E8E7 03                      DB  3   ;DPB_SECPCL
00234B E8E8 CB02                    DW  715 ;DPB_MAXCL
00234D E8EA FF                      DB  0FFH    ;DPB_FDMODE
00234E E8EB 07                      DB  7   ;DPB_DIRSCNT
00234F E8EC 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002350 E8ED 09                      DB  9   ;DPB_MAXSEC
002351 E8EE 01                      DB  1   ;DPB_FATPS
002352 E8EF 82                      DB  082H    ;DPB_BPS
002353 E8F0 0700                    DW  7   ;DPB_DIRPS
002355 E8F2 2D                      DB  02DH    ;DPB_DEVICE
002356 E8F3 07                      DB  7   ;DPB_UNITNO
002357 E8F4 0A00                    DW  10  ;DPB_ADDCL
002359 E8F6 0000                    DW  0   ;DPB_16
00235B E8F8 0000                    DW  0   ;DPB_18
00235D E8FA 0000                    DW  0   ;DPB_SDIR
00235F E8FC 44534B37                DB  "DSK7"  ;DPB_NAME
       E900                     MSX_E:
[EOF:MSXDPB.ASM:UTF_8]
                                
002363 E900                         DS  03FFFH - $$
003FFF 059C 00                      DB  0
       059D                     LAST_ADR:
                                
                                    END
[EOF:MSX.ASM:UTF_8]
