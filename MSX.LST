                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "MSXDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       0003                     MAC EQU 3   ;MSX
       0001                     DEV EQU 1
                                
       001D                     VER_6F  EQU 0001DH
                                
       4000                     RUN EQU 04000H
                                
       C900                     START2  EQU 0C900H
       CC06                     BDOS    EQU 0CC06H
       E600                     WORKAD  EQU 0E600H
       E900                     FATBF   EQU 0E900H
       EF00                     DTBUF   EQU 0EF00H
       0028                     WIDTH   EQU 40
       0018                     LINE    EQU 24
       0000                     COLORF  EQU 0
       0000                     KEYSP_H EQU 0
       0000                     KEYSP_L EQU 0
       0008                     COMS    EQU 8
       0002                     MAX_SEC_SZ_H    EQU 2       ;1セクタ1024バイトのサポート(2:off 4:on)
       8000                     BUFFER  EQU 08000H
       0100                     BUF_COM EQU 00100H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
                                
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       006C                     INITXT  EQU 0006CH
       0078                     SETTXT  EQU 00078H
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00AE                     PINLIN  EQU 000AEH
       00B1                     INLIN   EQU 000B1H
       00B4                     QINLIN  EQU 000B4H
       00B7                     BREAKX  EQU 000B7H
       00C0                     BEEP    EQU 000C0H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0144                     PHYDIO  EQU 00144H  ;MAIN:BIOS:
       0156                     KILBUF  EQU 00156H
                                
       01F5                     REDCLK  EQU 001F5H  ;SUB
       01F9                     WRTCLK  EQU 001F9H  ;SUB
                                
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F3AE                     LINL40  EQU 0F3AEH
       F3B0                     LINLEN  EQU 0F3B0H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
                                
       F41F                     KBUF    EQU 0F41FH; 318
                                
       F55E                     BUF EQU 0F55EH
                                
       FAF8                     EXBRSA  EQU 0FAF8H
                                
       FBCA                     FSTPOS  EQU 0FBCAH
                                
       FC9B                     INTFLG  EQU 0FC9BH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCC5                     SLTTBL  EQU 0FCC5H
                                
       FEDA                     H_STKE  EQU 0FEDAH
       FFA7                     H_PHYD  EQU 0FFA7H
                                
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU 06000H
       6800                     BANK1_SEL EQU 06800H
       7000                     BANK2_SEL EQU 07000H
       7800                     BANK3_SEL EQU 07800H
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       8000                     KONAMI_BANK2_SEL EQU 08000H
       A000                     KONAMI_BANK3_SEL EQU 0A000H
[EOF:MSXDEF.ASM:UTF_8]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0002                     VER_3   EQU 2
       1D03                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0103                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0162                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 1942                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
                                    INCLUDE "MSXFDIPL.ASM"
                                ;   LSX-Dodgers FDIPL
                                ;   MSX
000010 4010 186E            12      JR  INIT_FDD_BOOT
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
       4080                     INIT_FDD_BOOT:
000080 4080 F3               4      DI
000081 4081 ED56             8      IM  1
000083 4083 3A42F3          13      LD  A,(RAMAD1)
000086 4086 2640             7      LD  H,040H
000088 4088 CD2400          17      CALL    _ENASLT
00008B 408B 218A82          10      LD  HL,AT_START2+04000H
00008E 408E 1100C9          10      LD  DE,START2
000091 4091 010020          10      LD  BC,MSX_E-START2
000094 4094 EDB0                    LDIR
000096 4096 2180E8          10      LD  HL,_DEVICE+4*32     ;E
000099 4099 1100E8          10      LD  DE,_DEVICE      ;A
00009C 409C 018000          10      LD  BC,32*4
00009F 409F EDB0                    LDIR
0000A1 40A1 21DFE8          10      LD  HL,_DEVICE+6*32+DPB_NAME+3
0000A4 40A4 3E07             7      LD  A,7
       40A6                     FDD_INIT1:
0000A6 40A6 C62F             7      ADD A,'0'-1
0000A8 40A8 77               7      LD  (HL),A
0000A9 40A9 11F4FF          10      LD  DE,DPB_UNITNO-(DPB_NAME+3)
0000AC 40AC 19              11      ADD HL,DE
0000AD 40AD D630             7      SUB '0'
0000AF 40AF 77               7      LD  (HL),A
0000B0 40B0 11ECFF          10      LD  DE,-DPB_UNITNO-1
0000B3 40B3 19              11      ADD HL,DE       ;ここでZフラグは変化しない
0000B4 40B4 20F0            12      JR  NZ,FDD_INIT1
0000B6 40B6 218040          10      LD  HL,INIT_FDD_BOOT
                                
0000B9 40B9 CD07CA          17      CALL    SET_BDOS
0000BC 40BC 21E7C9          10      LD  HL,ROMCHECKED
0000BF 40BF 2204C9          16      LD  (INIT_SWC),HL
0000C2 40C2 3EC3             7      LD  A,0C3H      ;JP
0000C4 40C4 329DCC          13      LD  (FDD_BDOS_JP),A
0000C7 40C7 21D9D0          10      LD  HL,BDOS0
0000CA 40CA 229ECC          16      LD  (FDD_BDOS_ADR),HL
0000CD 40CD 219DCC          10      LD  HL,FDD_BDOS_JP
0000D0 40D0 220600          16      LD  (00006H),HL ;BDOS
0000D3 40D3 C300C9          10      JP  START2
[EOF:MSXFDIPL.ASM:UTF_8]
                                
0001BD 41BD                         ORG 041BDH
0001BD 41BD C9              10      RET
                                
                                    ;MBR_Partition1 (2DDのデータ)
0001BE 41BE 00                      DB  0       ;ブートフラグ
0001BF 41BF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001C2 41C2 01                      DB  1       ;識別子(FAT12)
0001C3 41C3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001C6 41C6 20000000                DW  32,0        ;パーティションの最初のセクタ番号(LBA方式)
0001CA 41CA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
                                    ;MBR_Partition2 (2DDのデータ)
0001CE 41CE 00                      DB  0       ;ブートフラグ
0001CF 41CF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001D2 41D2 01                      DB  1       ;識別子(FAT12)
0001D3 41D3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001D6 41D6 C0050000                DW  32+1440,0   ;パーティションの最初のセクタ番号(LBA方式)
0001DA 41DA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
0001FE 41FE                         ORG 041FEH
0001FE 41FE 55AA                    DB  055H,0AAH   ;MBR_Sig
                                
                                    INCLUDE "MSXINIT.ASM"
                                ;   LSX-Dodgers INIT
                                ;   MSX
       4200                     START:
000200 4200 F3               4      DI
000201 4201 ED56             8      IM  1
000203 4203 AF               4      XOR A               ;A=0
000204 4204 320060          13      LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
000207 4207 3C               4      INC A               ;A=1
000208 4208 320068          13      LD  (BANK1_SEL),A
00020B 420B 218A42          10      LD  HL,AT_START2
00020E 420E 1100C9          10      LD  DE,START2
000211 4211 010020          10      LD  BC,MSX_E-START2
000214 4214 EDB0                    LDIR
000216 4216 C300C9          10      JP  START2
                                
       4219                     INIT_ROM:
000219 4219 3E                      DB  03EH    ;LD A,??
00021A 421A F7              12      RST 30H
00021B 421B F3               4      DI
00021C 421C 32DAFE          13      LD  (H_STKE),A
00021F 421F CD6642          17      CALL    GTSL1_
000222 4222 21DBFE          10      LD  HL,H_STKE+1
000225 4225 77               7      LD  (HL),A
000226 4226 110042          10      LD  DE,START
000229 4229 23               6      INC HL
00022A 422A 73               7      LD  (HL),E
00022B 422B 23               6      INC HL
00022C 422C 72               7      LD  (HL),D
                                
00022D 422D CD3801          17      CALL    RSLREG      ;read primary slot #
000230 4230 07               4      RLCA
000231 4231 07               4      RLCA
000232 4232 F5              11      PUSH    AF
000233 4233 1605             7      LD  D,4+1
000235 4235 CD6D42          17      CALL    GTSL2_
000238 4238 3244F3          13      LD  (RAMAD3),A
00023B 423B 3A42F3          13      LD  A,(RAMAD1)
00023E 423E CD5842          17      CALL    FIXRAMAD
000241 4241 3242F3          13      LD  (RAMAD1),A
000244 4244 3A41F3          13      LD  A,(RAMAD0)
000247 4247 CD5842          17      CALL    FIXRAMAD
00024A 424A 3241F3          13      LD  (RAMAD0),A
00024D 424D F1              10      POP AF
00024E 424E 1603             7      LD  D,2+1
000250 4250 CD6D42          17      CALL    GTSL2_
000253 4253 3243F3          13      LD  (RAMAD2),A
                                
000256 4256 FB               4      EI
000257 4257 C9              10      RET
                                
       4258                     FIXRAMAD:
000258 4258 B7               4      OR  A
000259 4259 2807            12      JR  Z,FIXRAMAD1
00025B 425B FEC9             7      CP  0C9H
00025D 425D 2803            12      JR  Z,FIXRAMAD1
00025F 425F FEFF             7      CP  0FFH
000261 4261 C0              11      RET NZ
       4262                     FIXRAMAD1:
000262 4262 3A44F3          13      LD  A,(RAMAD3)
000265 4265 C9              10      RET
                                
       4266                     GTSL1_:             ;自分のいるスロットを知る
000266 4266 CD3801          17      CALL    RSLREG      ;read primary slot #
000269 4269 0F               4      RRCA
00026A 426A 0F               4      RRCA
00026B 426B 1601             7      LD  D,1
       426D                     GTSL2_:
00026D 426D E603             7      AND 3       ;[A]=000000PP
00026F 426F 5F               4      LD  E,A     ;[E]=000000PP
000270 4270 21C1FC          10      LD  HL,EXPTBL
000273 4273 85               4      ADD A,L     ;桁上りは無い
000274 4274 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000275 4275 7B               4      LD  A,E     ;[A]=000000PP
000276 4276 CB7E            13      BIT 7,(HL)
000278 4278 C8              11      RET Z
000279 4279 7D               4      LD  A,L     ;point to SLTTBL entry
00027A 427A C604             7      ADD A,4     ;桁上りは無い
00027C 427C 6F               4      LD  L,A
00027D 427D 7E               7      LD  A,(HL)      ;get currently expansion slot register
       427E                     GTSL3_:
00027E 427E 15               4      DEC D
00027F 427F 2803            12      JR  Z,GTSL4_:
000281 4281 0F               4      RRCA
000282 4282 18FA            12      JR  GTSL3_:
       4284                     GTSL4_:
000284 4284 E60C             7      AND 00CH        ;[A] = 0000SS00
000286 4286 B3               4      OR  E       ;[A] = 0000SSPP
000287 4287 F680             7      OR  080H        ;[A] = 1000SSPP
000289 4289 C9              10      RET
                                
       428A                     AT_START2:
00028A C900                         ORG START2,AT_START2-RUN
                                
00028A C900 3100C9          10      LD  SP,START2
00028D C903 CD11C9          17      CALL    INIT        ;NZならAUTOEXECを実行
       C904                     INIT_SWC    EQU $-2
000290 C906 210000          10      LD  HL,0
000293 C909 E5              11      PUSH    HL
000294 C90A C8              11      RET Z
000295 C90B 11FCCA          10      LD  DE,AUTOD
000298 C90E C3FDE6          10      JP  _COMANL
                                
       C911                     INIT:
00029B C911 DD21900D        14      LD  IX,0D90H
00029F C915 0600             7      LD  B,0
       C917                     CHECK_CBIOS1:
0002A1 C917 DD7E00          19      LD  A,(IX+0)
0002A4 C91A FE43             7      CP  'C'
0002A6 C91C 202B            12      JR  NZ,CHECK_CBIOS2
0002A8 C91E DD7E01          19      LD  A,(IX+1)
0002AB C921 FE2D             7      CP  '-'
0002AD C923 2024            12      JR  NZ,CHECK_CBIOS2
0002AF C925 DD7E02          19      LD  A,(IX+2)
0002B2 C928 FE42             7      CP  'B'
0002B4 C92A 201D            12      JR  NZ,CHECK_CBIOS2
0002B6 C92C DD7E03          19      LD  A,(IX+3)
0002B9 C92F FE49             7      CP  'I'
0002BB C931 2016            12      JR  NZ,CHECK_CBIOS2
0002BD C933 DD7E04          19      LD  A,(IX+4)
0002C0 C936 FE4F             7      CP  'O'
0002C2 C938 200F            12      JR  NZ,CHECK_CBIOS2
0002C4 C93A DD7E05          19      LD  A,(IX+5)
0002C7 C93D EE53             7      XOR 'S'
0002C9 C93F 2008            12      JR  NZ,CHECK_CBIOS2
                                
0002CB C941 322AD4          13      LD  (CBIOS_SWC1),A
0002CE C944 324ED4          13      LD  (CBIOS_SWC2),A
                                
0002D1 C947 1804            12      JR  CHECK_CBIOS3
       C949                     CHECK_CBIOS2:
0002D3 C949 DD23            10      INC IX
0002D5 C94B 10CA            13      DJNZ    CHECK_CBIOS1
       C94D                     CHECK_CBIOS3:
0002D7 C94D 3ADBFE          13      LD  A,(H_STKE+1)
0002DA C950 3262E6          13      LD  (ROM_SLT),A
                                
       C953                     RAMCHK2:
0002DD C953 3A42F3          13      LD  A,(RAMAD1)
0002E0 C956 2640             7      LD  H,040H
0002E2 C958 CD60CA          17      CALL    CHK_RAM
0002E5 C95B 3242F3          13      LD  (RAMAD1),A
       C95E                     RAMCHK1:
0002E8 C95E 3A41F3          13      LD  A,(RAMAD0)
0002EB C961 2600             7      LD  H,00H
0002ED C963 CD60CA          17      CALL    CHK_RAM
0002F0 C966 3241F3          13      LD  (RAMAD0),A
       C969                     RAMCHK0:
0002F3 C969 3A42F3          13      LD  A,(RAMAD1)
0002F6 C96C 2640             7      LD  H,040H
0002F8 C96E CD2400          17      CALL    _ENASLT
                                
0002FB C971 3A41F3          13      LD  A,(RAMAD0)
0002FE C974 CDA6D6          17      CALL    ENASLT0
                                
000301 C977 210000          10      LD  HL,0
000304 C97A 065C             7      LD  B,05CH
000306 C97C 3E                      DB  03EH    ;LD A,??
000307 C97D EF              12      RST 28H
000308 C97E CDD4D7          17      CALL    FILL_MEMORY
00030B C981 06A4             7      LD  B,0A4H
00030D C983 AF               4      XOR A
00030E C984 320400          13      LD  (_DVSW),A
000311 C987 CDD4D7          17      CALL    FILL_MEMORY
                                
000314 C98A CD07CA          17      CALL    SET_BDOS
                                
                                                ;LSX-Dodgers
000317 C98D 3EE6             7      LD  A,CPM_BOOT/256
000319 C98F 320B00          13      LD  (0000BH),A
                                
                                                ;MSXワークエリア
00031C C992 3E03             7      LD  A,3
00031E C994 329BFC          13      LD  (INTFLG),A
                                
                                                ;ROMタイプ判別(ASCII-8K/ASCII-16K)
000321 C997 1E00             7      LD  E,0
000323 C999 3A62E6          13      LD  A,(ROM_SLT)
000326 C99C 210068          10      LD  HL,BANK1_SEL
000329 C99F CD1400          17      CALL    _WRSLT
                                
00032C C9A2 210060          10      LD  HL,06000H
00032F C9A5 3A62E6          13      LD  A,(ROM_SLT)
000332 C9A8 CD0C00          17      CALL    _RDSLT
000335 C9AB FE41             7      CP  'A'
000337 C9AD 280F            12      JR  Z,ROM8K
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K)
000339 C9AF 3E                      DB  03EH    ;LD A,??
00033A C9B0 00               4      NOP
00033B C9B1 322ECC          13      LD  (ASCII16K1),A
00033E C9B4 3232CC          13      LD  (ASCII16K2),A
000341 C9B7 3E3F             7      LD  A,03FH
000343 C9B9 324ACC          13      LD  (ASCII16K3),A
000346 C9BC 1829            12      JR  ROMCHECKED
       C9BE                     ROM8K:              ;Konami-8Kチェック
000348 C9BE 1E01             7      LD  E,1
00034A C9C0 3A62E6          13      LD  A,(ROM_SLT)
00034D C9C3 210070          10      LD  HL,BANK2_SEL
000350 C9C6 CD1400          17      CALL    _WRSLT
                                
000353 C9C9 1E00             7      LD  E,0
000355 C9CB 3A62E6          13      LD  A,(ROM_SLT)
000358 C9CE 210080          10      LD  HL,KONAMI_BANK2_SEL
00035B C9D1 CD1400          17      CALL    _WRSLT
                                
00035E C9D4 210080          10      LD  HL,08000H
000361 C9D7 3A62E6          13      LD  A,(ROM_SLT)
000364 C9DA CD0C00          17      CALL    _RDSLT
000367 C9DD FE41             7      CP  'A'
000369 C9DF 2006            12      JR  NZ,ROMCHECKED
                                                ;Konami-8K
00036B C9E1 210080          10      LD  HL,KONAMI_BANK2_SEL
00036E C9E4 2239CC          16      LD  (ROM8000H),HL
       C9E7                     ROMCHECKED:
                                
000371 C9E7 3E28             7      LD  A,40
000373 C9E9 32AEF3          13      LD  (LINL40),A
000376 C9EC 32B1E6          13      LD  (_WIDTH),A
000379 C9EF DD216C00        14      LD  IX,INITXT
00037D C9F3 CD1FD6          17      CALL    CALSLT_R
000380 C9F6 DD217800        14      LD  IX,SETTXT
000384 C9FA CD1FD6          17      CALL    CALSLT_R
                                
000387 C9FD 2108CB          10      LD  HL,INIMES
00038A CA00 CD19D1          17      CALL    MSX
       CA03                     INIT1:
00038D CA03 AF               4      XOR A
00038E CA04 FE03             7      CP  3
000390 CA06 C9              10      RET
       CA07                     SET_BDOS:
000391 CA07 3E                      DB  03EH    ;LD A,??
000392 CA08 E9               4      JP  (HL)
000393 CA09 320F00          13      LD  (0000FH),A
                                
000396 CA0C 3EC3             7      LD  A,0C3H      ;JP
000398 CA0E 2103E6          10      LD  HL,CPM_WBOOT
00039B CA11 320000          13      LD  (00000H),A
00039E CA14 220100          16      LD  (00001H),HL ;IPL
                                
0003A1 CA17 2106CC          10      LD  HL,BDOS
0003A4 CA1A 320500          13      LD  (00005H),A
0003A7 CA1D 220600          16      LD  (00006H),HL ;BDOS
                                
0003AA CA20 210000          10      LD  HL,0
0003AD CA23 322800          13      LD  (00028H),A
0003B0 CA26 222900          16      LD  (00029H),HL ;BDOS
                                                ;インタースロットコール
0003B3 CA29 218FD6          10      LD  HL,RDSLTR
0003B6 CA2C 320C00          13      LD  (_RDSLT),A
0003B9 CA2F 220D00          16      LD  (_RDSLT+1),HL
                                
0003BC CA32 2194D6          10      LD  HL,WRSLTR
0003BF CA35 321400          13      LD  (_WRSLT),A
0003C2 CA38 221500          16      LD  (_WRSLT+1),HL
                                
0003C5 CA3B 213BD6          10      LD  HL,CALSLTR
0003C8 CA3E 321C00          13      LD  (_CALSLT),A
0003CB CA41 221D00          16      LD  (_CALSLT+1),HL
                                
0003CE CA44 219ED6          10      LD  HL,ENASLTR
0003D1 CA47 322400          13      LD  (_ENASLT),A
0003D4 CA4A 222500          16      LD  (_ENASLT+1),HL
                                
0003D7 CA4D 212BD6          10      LD  HL,CALLF
0003DA CA50 323000          13      LD  (_CALLF),A
0003DD CA53 223100          16      LD  (_CALLF+1),HL
                                
0003E0 CA56 21DFD6          10      LD  HL,INT38H
0003E3 CA59 323800          13      LD  (00038H),A
0003E6 CA5C 223900          16      LD  (00038H+1),HL
0003E9 CA5F C9              10      RET
       CA60                     CHK_RAM:
0003EA CA60 E5              11      PUSH    HL
0003EB CA61 CDB5CA          17      CALL    CHK_RAM0
0003EE CA64 E1              10      POP HL
0003EF CA65 C8              11      RET Z
0003F0 CA66 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
0003F3 CA69 E680             7      AND 080H
0003F5 CA6B CD8CCA          17      CALL    CHK_RAM_SLT
0003F8 CA6E C8              11      RET Z
0003F9 CA6F 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
0003FC CA72 E680             7      AND 080H
0003FE CA74 C601             7      ADD A,1
000400 CA76 CD8CCA          17      CALL    CHK_RAM_SLT
000403 CA79 C8              11      RET Z
000404 CA7A 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000407 CA7D E680             7      AND 080H
000409 CA7F C602             7      ADD A,2
00040B CA81 CD8CCA          17      CALL    CHK_RAM_SLT
00040E CA84 C8              11      RET Z
00040F CA85 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000412 CA88 E680             7      AND 080H
000414 CA8A C603             7      ADD A,3
       CA8C                     CHK_RAM_SLT:
000416 CA8C E5              11      PUSH    HL
000417 CA8D CDB5CA          17      CALL    CHK_RAM0        ;スロット#X or X-0
00041A CA90 E1              10      POP HL
00041B CA91 C8              11      RET Z
00041C CA92 CB79             8      BIT 7,C
00041E CA94 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000420 CA96 79               4      LD  A,C
000421 CA97 C604             7      ADD A,4*1           ;スロット#X-1
000423 CA99 E5              11      PUSH    HL
000424 CA9A CDB5CA          17      CALL    CHK_RAM0
000427 CA9D E1              10      POP HL
000428 CA9E C8              11      RET Z
000429 CA9F 79               4      LD  A,C
00042A CAA0 C608             7      ADD A,4*2           ;スロット#X-2
00042C CAA2 E5              11      PUSH    HL
00042D CAA3 CDB5CA          17      CALL    CHK_RAM0
000430 CAA6 E1              10      POP HL
000431 CAA7 C8              11      RET Z
000432 CAA8 79               4      LD  A,C
000433 CAA9 C60C             7      ADD A,4*3           ;スロット#X-3
000435 CAAB E5              11      PUSH    HL
000436 CAAC CDB5CA          17      CALL    CHK_RAM0
000439 CAAF E1              10      POP HL
       CAB0                     CHK_RAM_E:
00043A CAB0 AF               4      XOR A
00043B CAB1 3C               4      INC A           ;ZF=0にする
00043C CAB2 3E00             7      LD  A,0
00043E CAB4 C9              10      RET
                                
       CAB5                     CHK_RAM0:
00043F CAB5 4F               4      LD  C,A
000440 CAB6 3A62E6          13      LD  A,(ROM_SLT)
000443 CAB9 B9               4      CP  C
000444 CABA 28F4            12      JR  Z,CHK_RAM_E
000446 CABC 2E00             7      LD  L,0
       CABE                     CHK_RAM1:
000448 CABE 79               4      LD  A,C
000449 CABF DD210C00        14      LD  IX,_RDSLT
00044D CAC3 CDF0CA          17      CALL    CALSLT_RAM
000450 CAC6 C6E5             7      ADD A,0E5H
000452 CAC8 47               4      LD  B,A
000453 CAC9 5F               4      LD  E,A
000454 CACA 79               4      LD  A,C
000455 CACB DD211400        14      LD  IX,_WRSLT
000459 CACF CDF0CA          17      CALL    CALSLT_RAM
00045C CAD2 79               4      LD  A,C
00045D CAD3 DD210C00        14      LD  IX,_RDSLT
000461 CAD7 CDF0CA          17      CALL    CALSLT_RAM
000464 CADA B8               4      CP  B
000465 CADB C0              11      RET NZ
000466 CADC D6E5             7      SUB 0E5H
000468 CADE 79               4      LD  A,C
000469 CADF 5F               4      LD  E,A
00046A CAE0 DD211400        14      LD  IX,_WRSLT
00046E CAE4 CDF0CA          17      CALL    CALSLT_RAM
000471 CAE7 24               4      INC H
000472 CAE8 7D               4      LD  A,L
000473 CAE9 C604             7      ADD A,4
000475 CAEB 6F               4      LD  L,A
000476 CAEC 20D0            12      JR  NZ,CHK_RAM1
000478 CAEE 79               4      LD  A,C     ;ZF=1のハズ
000479 CAEF C9              10      RET
                                
       CAF0                     CALSLT_RAM:
00047A CAF0 C5              11      PUSH    BC
00047B CAF1 E5              11      PUSH    HL
00047C CAF2 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000480 CAF6 CD1C00          17      CALL    _CALSLT
000483 CAF9 E1              10      POP HL
000484 CAFA C1              10      POP BC
000485 CAFB C9              10      RET
                                
000486 CAFC 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
00048F CB05 413A00              AUTODV: DB  "A:",0
                                
000492 CB08 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MSX v"
            6765727320666F72    
            204D53582076        
0004A8 CB1E 312E                    DB  030H + VER_1, '.'
0004AA CB20 3632                    DB  030H + VER_2 ,030H + VER_3
0004AC CB22                         DB  ''
0004AC CB22 2047616B750D0A          DB  " Gaku",0DH,0AH
0004B3 CB29 00                      DB  0
                                
0004B4 CB2A 0300                M2DD:   DW  3
0004B6 CB2C F902                    DB  0F9H,2
0004B8 CB2E CB02                    DW  715
0004BA CB30 FF0750090182            DB  0FFH,7,80,9,1,082H
0004C0 CB36 0700A7000A00            DW  7,0A7H,10
       CB3C                     M2DDE:
                                
       CB3C                     INITE:
0004C6 CB3C                         DS  BDOS-INITE
000590 CC06 C3D9D0          10      JP  BDOS0
[EOF:MSXINIT.ASM:SHIFT_JIS]
                                    INCLUDE "MSXDISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MSX
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       CC09                     FDRD:
000593 CC09 ED739CCC        20      LD  (DRDSP),SP
000597 CC0D 3A9DCC          13      LD  A,(DRDSPH)  ;スタックがカートリッジと被っていないかチェック
00059A CC10 FE7F             7      CP  07FH
00059C CC12 3809            12      JR  C,FDRD1
00059E CC14 FEC1             7      CP  0C1H
0005A0 CC16 3005            12      JR  NC,FDRD1
0005A2 CC18 3E00             7      LD  A,0     ;BDOS0+13Hが外部から書き換えされても動くようにする
0005A4 CC1A 315EF5          10      LD  SP,BUF
       CC1D                     FDRD1:
0005A7 CC1D C5              11      PUSH    BC
0005A8 CC1E D5              11      PUSH    DE
                                
0005A9 CC1F E5              11      PUSH    HL
0005AA CC20 EB               4      EX  DE,HL
0005AB CC21 DD460F          19      LD  B,(IX+DPB_BPS)
       CC24                     EADR1:
0005AE CC24 CB18             8      RR  B
0005B0 CC26 3803            12      JR  C,EADR2
0005B2 CC28 29              11      ADD HL,HL
0005B3 CC29 18F9            12      JR  EADR1
       CC2B                     EADR2:
0005B5 CC2B E5              11      PUSH    HL  ;あとでDEで受け取る
0005B6 CC2C 29              11      ADD HL,HL   ;64KB→32KB
0005B7 CC2D 29              11      ADD HL,HL   ;32KB→16KB
       CC2E                     ASCII16K1:
0005B8 CC2E 29              11      ADD HL,HL   ;16KB→8KB  ;ASCII-16Kの場合はここがNOPに置き換えられる
                                
0005B9 CC2F DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;16KB単位でカートリッジ内のディスクが存在する位置を指定
       CC32                     ASCII16K2:
0005BC CC32 87               4      ADD A,A         ;ASCII-16Kの場合はここがNOPに置き換えられる
0005BD CC33 84               4      ADD A,H
0005BE CC34 5F               4      LD  E,A
0005BF CC35 3A62E6          13      LD  A,(ROM_SLT)
0005C2 CC38 210070          10      LD  HL,BANK2_SEL
       CC39                     ROM8000H    EQU $-2
0005C5 CC3B CD1400          17      CALL    _WRSLT
                                
0005C8 CC3E 2680             7      LD  H,080H
0005CA CC40 3A62E6          13      LD  A,(ROM_SLT) ;カートリッジROMに切り替える
0005CD CC43 CD2400          17      CALL    _ENASLT
                                
0005D0 CC46 D1              10      POP DE
0005D1 CC47 E1              10      POP HL      ;HLは読み出し先のメモリアドレス
                                
0005D2 CC48 7B               4      LD  A,E
0005D3 CC49 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F/16K:3F)
       CC4A                     ASCII16K3   EQU $-1
0005D5 CC4B 1E00             7      LD  E,0     ;DEはROMディスクから読み出すアドレス
0005D7 CC4D C680             7      ADD A,080H
0005D9 CC4F 57               4      LD  D,A
                                
0005DA CC50 3E                      DB  03EH
0005DB CC51 A7               4      AND A
0005DC CC52 327FCC          13      LD  (DRD_SWC3),A
0005DF CC55 7C               4      LD  A,H     ;読み出し先がカートリッジと被っていないかチェック
0005E0 CC56 FE7B             7      CP  07BH
0005E2 CC58 3812            12      JR  C,DRD2
0005E4 CC5A FEC1             7      CP  0C1H
0005E6 CC5C 300E            12      JR  NC,DRD2
0005E8 CC5E 2286CC          16      LD  (DRD_SWC1),HL   ;被っている場合はデータバッファをフラッシュして一時的に使う
0005EB CC61 2A7EE7          16      LD  HL,(_DTBUF)
0005EE CC64 3E                      DB  03EH
0005EF CC65 37               4      SCF
0005F0 CC66 327FCC          13      LD  (DRD_SWC3),A
0005F3 CC69 CD6FE4          17      CALL    FFLUSHBUF
       CC6C                     DRD2:
0005F6 CC6C DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
0005F9 CC6F E607             7      AND 7
0005FB CC71 47               4      LD  B,A
0005FC CC72 4B               4      LD  C,E ;E=0
                                
0005FD CC73 EB               4      EX  DE,HL
0005FE CC74 EDB0                    LDIR
000600 CC76 D5              11      PUSH    DE
000601 CC77 2680             7      LD  H,080H
000603 CC79 3A43F3          13      LD  A,(0F341H+2)    ;メインRAMに戻す
000606 CC7C CD2400          17      CALL    _ENASLT
       CC7F                     DRD_SWC3:
000609 CC7F A7               4      AND A       ;自己書き換え)被っている場合はSCFになる
00060A CC80 3012            12      JR  NC,DRD3
                                
00060C CC82 2A7EE7          16      LD  HL,(_DTBUF)
00060F CC85 110000          10      LD  DE,0
       CC86                     DRD_SWC1    EQU $-2
000612 CC88 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
000615 CC8B E607             7      AND 7
000617 CC8D 47               4      LD  B,A
000618 CC8E 0E00             7      LD  C,0
00061A CC90 EDB0                    LDIR
00061C CC92 E1              10      POP HL
00061D CC93 D5              11      PUSH    DE
       CC94                     DRD3:
00061E CC94 E1              10      POP HL
00061F CC95 D1              10      POP DE
000620 CC96 13               6      INC DE
000621 CC97 C1              10      POP BC
000622 CC98 1083            13      DJNZ    FDRD1
000624 CC9A AF               4      XOR A
000625 CC9B 310000          10      LD  SP,0
       CC9C                     DRDSP   EQU $-2
       CC9D                     DRDSPH  EQU $-1
000628 CC9E FB               4      EI
000629 CC9F C9              10      RET
                                
       CC9D                     FDD_BDOS_JP EQU $-3
       CC9E                     FDD_BDOS_ADR    EQU $-2
[EOF:MSXDISK.ASM:UTF_8]
                                    INCLUDE "MSXCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MSX
                                
       CCA0                     S27BUF_COM:
00062A CCA0 110001          10      LD  DE,BUF_COM
00062D CCA3 CDDDD2          17      CALL    _SYS1A      ;(BDOS)DTAの設定
000630 CCA6 2100FE          10      LD  HL,0-BUF_COM-00100H ;バッファー+スタック予備(0100H)
000633 CCA9 C37ECD          10      JP  S27BUF2
       CCAC                     WBOOT1:
000636 CCAC 3E03             7      LD  A,3
000638 CCAE 2A0600          16      LD  HL,(SYSTEM+1)   ;必ずBDOS0+13Hが「0」になるようにする ※ここはFDD起動時
00063B CCB1 F9               6      LD  SP,HL
00063C CCB2 CDACD3          17      CALL    MSG_A
       CCB5                     WBOOT2:
[EOF:MSXCCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       CCB5                     COMMAND:
00063F CCB5 3A67E5          13      LD  A,(FCB_BAT)
000642 CCB8 B7               4      OR  A
000643 CCB9 C2F7CD          10      JP  NZ,C_BAT1
000646 CCBC CD6BCD          17      CALL    SETDTA1
000649 CCBF 3A0400          13      LD  A,(_DVSW)
00064C CCC2 C641             7      ADD A,'A'
00064E CCC4 CDACD3          17      CALL    MSG_A
000651 CCC7 3E3E             7      LD  A,'>'
000653 CCC9 CDACD3          17      CALL    MSG_A
000656 CCCC 3E50             7      LD  A,80
000658 CCCE 12               7      LD  (DE),A
000659 CCCF CD6CD4          17      CALL    _SYS0A      ;(BDOS)文字列入力
00065C CCD2 CDECCE          17      CALL    LTNL
       CCD5                     COMMAND2:
00065F CCD5 118200          10      LD  DE,DTA1+2
000662 CCD8 CDFDE6          17      CALL    _COMANL
000665 CCDB DC9DD3          17      CALL    C,SHOW_ERROR
000668 CCDE 18D5            12      JR  COMMAND
                                
       CCE0                     COMANL:
00066A CCE0 CD29D7          17      CALL    FILE
00066D CCE3 3A19E6          13      LD  A,(FNAME+4)
000670 CCE6 FE20             7      CP  020H
000672 CCE8 201C            12      JR  NZ,COMB2
000674 CCEA D5              11      PUSH    DE
000675 CCEB 1115E6          10      LD  DE,FNAME
000678 CCEE 1A               7      LD  A,(DE)
000679 CCEF FE20             7      CP  020H
00067B CCF1 2844            12      JR  Z,SDVSW
00067D CCF3 1B               6      DEC DE
00067E CCF4 1A               7      LD  A,(DE)
00067F CCF5 C6FF             7      ADD A,0FFH
000681 CCF7 3809            12      JR  C,COMB
000683 CCF9 13               6      INC DE
                                
000684 CCFA 21A9D0          10      LD  HL,COMTB
000687 CCFD 0608             7      LD  B,COMS
000689 CCFF CDB6D9          17      CALL    CPNAME
       CD02                     COMB:
00068C CD02 D1              10      POP DE
00068D CD03 D29CD3          10      JP  NC,JPHL
       CD06                     COMB2:
000690 CD06 EB               4      EX  DE,HL
000691 CD07 22D4CD          16      LD  (COMSWC),HL
000694 CD0A F5              11      PUSH    AF
000695 CD0B CD8CCD          17      CALL    CEXE4
000698 CD0E F1              10      POP AF
000699 CD0F 2115E6          10      LD  HL,FNAME
00069C CD12 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
00069F CD15 010B00          10      LD  BC,11
0006A2 CD18 EDB0                    LDIR
0006A4 CD1A 1106E5          10      LD  DE,PATHD
       CD1D                     CEX1:
0006A7 CD1D 1A               7      LD  A,(DE)
0006A8 CD1E FE20             7      CP  020H
0006AA CD20 D8              11      RET C
0006AB CD21 CD1ED7          17      CALL    FILEC
0006AE CD24 D5              11      PUSH    DE
0006AF CD25 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
0006B2 CD28 1115E6          10      LD  DE,FNAME
0006B5 CD2B 010B00          10      LD  BC,11
0006B8 CD2E EDB0                    LDIR
0006BA CD30 CD8CCD          17      CALL    CEXE4
0006BD CD33 D1              10      POP DE
0006BE CD34 13               6      INC DE
0006BF CD35 18E6            12      JR  CEX1
                                
       CD37                     SDVSW:
0006C1 CD37 F1              10      POP AF
0006C2 CD38 3A14E6          13      LD  A,(FDRV)
0006C5 CD3B 3D               4      DEC A
0006C6 CD3C 5F               4      LD  E,A
0006C7 CD3D 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
0006C9 CD3F 1831            12      JR  SYSTEM0
                                
       CD41                     OPEN1:
0006CB CD41 2114E6          10      LD  HL,FDRV
       CD44                     OPEN:
0006CE CD44 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       CD46                     OPEN3:
0006D0 CD46 D5              11      PUSH    DE
0006D1 CD47 1142E5          10      LD  DE,DTA_CCP
0006D4 CD4A CD68CD          17      CALL    SETDTA
0006D7 CD4D EB               4      EX  DE,HL
0006D8 CD4E CD72CD          17      CALL    SYSTEM0
0006DB CD51 D1              10      POP DE
0006DC CD52 C9              10      RET
                                
       CD53                     OPEN2:
0006DD CD53 0E12             7      LD  C,012H
0006DF CD55 18EF            12      JR  OPEN3
                                
       CD57                     DEFCB:              ;Z=Ok NZ=Error
0006E1 CD57 1142E5          10      LD  DE,DTA_CCP
0006E4 CD5A CD70CD          17      CALL    SYSC0F
                                
0006E7 CD5D 1163E5          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0006EA CD60 0604             7      LD  B,4
0006EC CD62 CDBDCF          17      CALL    ZERO_MEMORY_DE
       CD65                     SETDTA100:
0006EF CD65 110080          10      LD  DE,BUFFER
       CD68                     SETDTA:
0006F2 CD68 C3DDD2          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       CD6B                     SETDTA1:
0006F5 CD6B 118000          10      LD  DE,DTA1
0006F8 CD6E 18F8            12      JR  SETDTA
                                
       CD70                     SYSC0F:
0006FA CD70 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       CD72                     SYSTEM0:
0006FC CD72 CD0500          17      CALL    SYSTEM
0006FF CD75 B7               4      OR  A
000700 CD76 C9              10      RET
                                
       CD77                     C_CD:
000701 CD77 0E5A             7      LD  C,05AH
000703 CD79 18F7            12      JR  SYSTEM0
                                
       CD7B                     S27BUF:
000705 CD7B 21007F          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       CD7E                     S27BUF2:
000708 CD7E 39              11      ADD HL,SP
000709 CD7F 2E00             7      LD  L,0
00070B CD81 7C               4      LD  A,H
00070C CD82 E6F8             7      AND 0F8H
00070E CD84 67               4      LD  H,A
       CD85                     S27DTA:
00070F CD85 1142E5          10      LD  DE,DTA_CCP
       CD88                     S27:
000712 CD88 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
000714 CD8A 18E6            12      JR  SYSTEM0
                                
       CD8C                     CEXE4:
000716 CD8C 211DE6          10      LD  HL,FNAME+8
000719 CD8F 7E               7      LD  A,(HL)
00071A CD90 FE20             7      CP  020H
00071C CD92 2007            12      JR  NZ,CEXE7
00071E CD94 3E3F             7      LD  A,'?'
000720 CD96 77               7      LD  (HL),A
000721 CD97 23               6      INC HL
000722 CD98 77               7      LD  (HL),A
000723 CD99 23               6      INC HL
000724 CD9A 77               7      LD  (HL),A
       CD9B                     CEXE7:
000725 CD9B CD41CD          17      CALL    OPEN1
       CD9E                     CEXE5:
000728 CD9E C0              11      RET NZ
000729 CD9F 2A4CE5          16      LD  HL,(DTA_CCP+1+9)
00072C CDA2 7C               4      LD  A,H
00072D CDA3 CD45DA          17      CALL    CAP
000730 CDA6 67               4      LD  H,A
000731 CDA7 7D               4      LD  A,L
000732 CDA8 CD45DA          17      CALL    CAP
000735 CDAB 6F               4      LD  L,A
000736 CDAC 3A4BE5          13      LD  A,(DTA_CCP+1+8)
000739 CDAF CD45DA          17      CALL    CAP
00073C CDB2 D642             7      SUB 'B'
00073E CDB4 282C            12      JR  Z,C_BAT
000740 CDB6 3D               4      DEC A       ;'C'
000741 CDB7 2805            12      JR  Z,C_EXE
       CDB9                     CEXE6:
000743 CDB9 CD53CD          17      CALL    OPEN2
000746 CDBC 18E0            12      JR  CEXE5
                                
       CDBE                     C_EXE:
000748 CDBE 7C               4      LD  A,H
000749 CDBF FE4D             7      CP  'M'
00074B CDC1 20F6            12      JR  NZ,CEXE6
                                
00074D CDC3 CD57CD          17      CALL    DEFCB
000750 CDC6 CDA0CC          17      CALL    S27BUF_COM
000753 CDC9 3D               4      DEC A
000754 CDCA 37               4      SCF
000755 CDCB C0              11      RET NZ
000756 CDCC 7C               4      LD  A,H
000757 CDCD B5               4      OR  L
000758 CDCE 37               4      SCF
000759 CDCF C8              11      RET Z
00075A CDD0 CD6BCD          17      CALL    SETDTA1
00075D CDD3 110000          10      LD  DE,0                ; self-modifying code
       CDD4                     COMSWC  EQU $-2
000760 CDD6 ED7B0600        20      LD  SP,(SYSTEM+1)
000764 CDDA 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000765 CDDB 6F               4      LD  L,A
000766 CDDC E5              11      PUSH    HL              ; push $0000 (reboot address)
000767 CDDD 24               4      INC H
000768 CDDE E5              11      PUSH    HL              ; push $0100 (TPA address)
000769 CDDF C388CF          10      JP  SETFCB              ; and JP $0100
                                
       CDE2                     C_BAT:
00076C CDE2 114154          10      LD  DE,'A'+'T'*256
00076F CDE5 ED52            15      SBC HL,DE
000771 CDE7 20D0            12      JR  NZ,CEXE6
                                
000773 CDE9 CD57CD          17      CALL    DEFCB
                                
000776 CDEC 2142E5          10      LD  HL,DTA_CCP
000779 CDEF 1167E5          10      LD  DE,FCB_BAT
00077C CDF2 012500          10      LD  BC,37
00077F CDF5 EDB0                    LDIR
       CDF7                     C_BAT1:
000781 CDF7 CD65CD          17      CALL    SETDTA100
000784 CDFA CD2ECE          17      CALL    FGETC_BAT
000787 CDFD 218100          10      LD  HL,DTA1+1
00078A CE00 2025            12      JR  NZ,END_BATCH
00078C CE02 FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
00078E CE04 38F1            12      JR  C,C_BAT1
000790 CE06 3620            10      LD  (HL),' '
000792 CE08 23               6      INC HL
       CE09                     C_BAT2:
000793 CE09 77               7      LD  (HL),A
000794 CE0A 23               6      INC HL
000795 CE0B 7D               4      LD  A,L
000796 CE0C 3C               4      INC A       ;L==0FFH
000797 CE0D 2809            12      JR  Z,RUN_BATCH
000799 CE0F CD2ECE          17      CALL    FGETC_BAT
00079C CE12 2004            12      JR  NZ,RUN_BATCH
00079E CE14 FE20             7      CP  020H
0007A0 CE16 30F1            12      JR  NC,C_BAT2
       CE18                     RUN_BATCH:
0007A2 CE18 7D               4      LD  A,L
0007A3 CE19 D67F             7      SUB DTA1-1
0007A5 CE1B 328000          13      LD  (DTA1),A
0007A8 CE1E FE04             7      CP  4
0007AA CE20 3805            12      JR  C,END_BATCH
0007AC CE22 3600            10      LD  (HL),0
0007AE CE24 C3D5CC          10      JP  COMMAND2
       CE27                     END_BATCH:
0007B1 CE27 AF               4      XOR A       ;バッチファイルを閉じる
0007B2 CE28 3267E5          13      LD  (FCB_BAT),A
0007B5 CE2B C300E6          10      JP  CPM_BOOT
                                
       CE2E                     FGETC_BAT:
0007B8 CE2E 1167E5          10      LD  DE,FCB_BAT
       CE31                     FGETC:              ;1文字ずつ読み込む
0007BB CE31 E5              11      PUSH    HL      ;Z:成功
0007BC CE32 210100          10      LD  HL,1
0007BF CE35 CD88CD          17      CALL    S27
0007C2 CE38 E1              10      POP HL
0007C3 CE39 3A0080          13      LD  A,(BUFFER)
0007C6 CE3C C9              10      RET
                                
       CE3D                     C_DEL:
0007C7 CE3D CD88CF          17      CALL    SETFCB
0007CA CE40 CDE8D3          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
0007CD CE43 0E13             7      LD  C,013H
0007CF CE45 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       CE47                     C_REN:
0007D1 CE47 CD88CF          17      CALL    SETFCB
0007D4 CE4A 3E10             7      LD  A,010H      ;ディレクトリも対象にする
0007D6 CE4C 326900          13      LD  (FCB1+13),A ;属性
0007D9 CE4F 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       CE51                     CDEL1:
0007DB CE51 115C00          10      LD  DE,FCB1
0007DE CE54 CD0500          17      CALL    SYSTEM
0007E1 CE57 C6FF             7      ADD A,0FFH
0007E3 CE59 C9              10      RET
                                
       CE5A                     C_DIR:
0007E4 CE5A CD1ED7          17      CALL    FILEC
0007E7 CE5D 2115E6          10      LD  HL,FDRV+1
0007EA CE60 CD9ED0          17      CALL    CWILD1
0007ED CE63 3EF1             7      LD  A,0F1H
0007EF CE65 3221E6          13      LD  (FDRV+13),A
0007F2 CE68 CD41CD          17      CALL    OPEN1
       CE6B                     CDIR1:
0007F5 CE6B B7               4      OR  A
0007F6 CE6C 2008            12      JR  NZ,PDSKF
0007F8 CE6E CDB9CE          17      CALL    P_NAME
0007FB CE71 CD53CD          17      CALL    OPEN2
0007FE CE74 18F5            12      JR  CDIR1
       CE76                     PDSKF:
000800 CE76 3A14E6          13      LD  A,(FDRV)
000803 CE79 5F               4      LD  E,A
000804 CE7A 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
000806 CE7C CD0500          17      CALL    SYSTEM
000809 CE7F 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
00080A CE80 C601             7      ADD A,001H
00080C CE82 D8              11      RET C       ;Aが0FFHだった場合
00080D CE83 3E06             7      LD  A,8-2
       CE85                     PDS1:               ;HL=未使用クラスタの総数
00080F CE85 3C               4      INC A
000810 CE86 CB19             8      RR  C
000812 CE88 30FB            12      JR  NC,PDS1
       CE8A                     PDS2:               ;B←論理セクタのサイズの上位8ビット
000814 CE8A 3C               4      INC A
000815 CE8B CB18             8      RR  B
000817 CE8D 30FB            12      JR  NC,PDS2
000819 CE8F 47               4      LD  B,A
                                
00081A CE90 110000          10      LD  DE,0
       CE93                     PDS3:
00081D CE93 29              11      ADD HL,HL
00081E CE94 EB               4      EX  DE,HL
00081F CE95 ED6A            15      ADC HL,HL
000821 CE97 EB               4      EX  DE,HL
000822 CE98 10F9            13      DJNZ    PDS3
       CE9A                     PDSKF1:
000824 CE9A CD26CF          17      CALL    PRDEC_DEHL
000827 CE9D 1197E5          10      LD  DE,FREE
00082A CEA0 CD0AD1          17      CALL    _SYS09      ;(BDOS)文字列出力
00082D CEA3 CD13CF          17      CALL    PUTDRV
000830 CEA6 3E5C             7      LD  A,05CH      ;\
000832 CEA8 CDACD3          17      CALL    MSG_A
000835 CEAB 2A22E6          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
000838 CEAE AF               4      XOR A
000839 CEAF 11FEFF          10      LD  DE,0-2
00083C CEB2 19              11      ADD HL,DE
00083D CEB3 23               6      INC HL
00083E CEB4 DC23CF          17      CALL    C,PRDEC_HL
000841 CEB7 1833            12      JR  LTNL
                                
       CEB9                     P_NAME:
000843 CEB9 3A43E5          13      LD  A,(DTA_CCP+1)
000846 CEBC FE2E             7      CP  '.'
000848 CEBE C8              11      RET Z
                                
000849 CEBF 3A4EE5          13      LD  A,(DTA_CCP+1+00BH)
00084C CEC2 F5              11      PUSH    AF
00084D CEC3 CB67             8      BIT 4,A
00084F CEC5 2808            12      JR  Z,DIR3
000851 CEC7 118CE5          10      LD  DE,DIRMES
000854 CECA CD0AD1          17      CALL    _SYS09      ;(BDOS)文字列出力
000857 CECD 180A            12      JR  DIR6
       CECF                     DIR3:
000859 CECF ED5B61E5        20      LD  DE,(DTA_CCP+1+01EH)
00085D CED3 2A5FE5          16      LD  HL,(DTA_CCP+1+01CH)
000860 CED6 CD26CF          17      CALL    PRDEC_DEHL
       CED9                     DIR6:
000863 CED9 F1              10      POP AF
000864 CEDA 0F               4      RRCA
000865 CEDB 9F               4      SBC A,A
000866 CEDC E60A             7      AND '*'-020H
000868 CEDE C620             7      ADD A,020H
00086A CEE0 CDACD3          17      CALL    MSG_A
00086D CEE3 CD13CF          17      CALL    PUTDRV
000870 CEE6 2143E5          10      LD  HL,DTA_CCP+1
000873 CEE9 CD66CF          17      CALL    FPRNT
                                
       CEEC                     LTNL:
000876 CEEC 1E03             7      LD  E,3
000878 CEEE C3CDE6          10      JP  _PRINT
                                
       CEF1                     C_PATH:
00087B CEF1 CDFFD7          17      CALL    SPCUT
00087E CEF4 2106E5          10      LD  HL,PATHD
000881 CEF7 FE21             7      CP  021H
000883 CEF9 300C            12      JR  NC,CPATH0
       CEFB                     CPATHP:
000885 CEFB 7E               7      LD  A,(HL)
000886 CEFC 23               6      INC HL
000887 CEFD FE20             7      CP  020H
000889 CEFF 3F               4      CCF
00088A CF00 30EA            12      JR  NC,LTNL
00088C CF02 CDACD3          17      CALL    MSG_A
00088F CF05 18F4            12      JR  CPATHP
       CF07                     CPATH0:
000891 CF07 FE3B             7      CP  ';'
000893 CF09 2001            12      JR  NZ,CPATH1
000895 CF0B 13               6      INC DE
       CF0C                     CPATH1:
000896 CF0C EB               4      EX  DE,HL
000897 CF0D 013B00          10      LD  BC,PATHX
00089A CF10 EDB0                    LDIR
00089C CF12 C9              10      RET
                                
       CF13                     PUTDRV:
00089D CF13 3A14E6          13      LD  A,(FDRV)
0008A0 CF16 CD32D8          17      CALL    GETDRV1
0008A3 CF19 C641             7      ADD A,'A'
0008A5 CF1B CDACD3          17      CALL    MSG_A
0008A8 CF1E 3E3A             7      LD  A,':'
       CF20                     MSG_AR:
0008AA CF20 C3ACD3          10      JP  MSG_A
                                
       CF23                     PRDEC_HL:
0008AD CF23 AF               4      XOR A
0008AE CF24 5F               4      LD  E,A
0008AF CF25 57               4      LD  D,A
       CF26                     PRDEC_DEHL:
0008B0 CF26 D5              11      PUSH    DE
0008B1 CF27 110FE6          10      LD  DE,DECBF
0008B4 CF2A 0605             7      LD  B,5
0008B6 CF2C CDBDCF          17      CALL    ZERO_MEMORY_DE  ;A=0
0008B9 CF2F D1              10      POP DE
                                
0008BA CF30 0E20             7      LD  C,32
       CF32                     DEC1:
0008BC CF32 29              11      ADD HL,HL
0008BD CF33 EB               4      EX  DE,HL
0008BE CF34 ED6A            15      ADC HL,HL
0008C0 CF36 EB               4      EX  DE,HL
0008C1 CF37 E5              11      PUSH    HL
0008C2 CF38 2113E6          10      LD  HL,DECBF+4
0008C5 CF3B 0605             7      LD  B,5
       CF3D                     DEC2:
0008C7 CF3D 7E               7      LD  A,(HL)
0008C8 CF3E 8F               4      ADC A,A
0008C9 CF3F 27               4      DAA
0008CA CF40 77               7      LD  (HL),A
0008CB CF41 2B               6      DEC HL
0008CC CF42 10F9            13      DJNZ    DEC2
0008CE CF44 E1              10      POP HL
0008CF CF45 0D               4      DEC C
0008D0 CF46 20EA            12      JR  NZ,DEC1
                                
0008D2 CF48 210FE6          10      LD  HL,DECBF
0008D5 CF4B 3E20             7      LD  A,020H
0008D7 CF4D 0604             7      LD  B,4
       CF4F                     DEC3:
0008D9 CF4F CD5CCF          17      CALL    DEC4
0008DC CF52 CD5CCF          17      CALL    DEC4
0008DF CF55 23               6      INC HL
0008E0 CF56 10F7            13      DJNZ    DEC3
       CF58                     DECX:
0008E2 CF58 CD5CCF          17      CALL    DEC4
0008E5 CF5B AF               4      XOR A
       CF5C                     DEC4:
0008E6 CF5C ED6F            18      RLD
0008E8 CF5E FE20             7      CP  020H
0008EA CF60 2802            12      JR  Z,DEC5
0008EC CF62 F630             7      OR  030H
       CF64                     DEC5:
0008EE CF64 18BA            12      JR  MSG_AR
                                
       CF66                     FPRNT:
0008F0 CF66 0608             7      LD  B,8 ;ファイル名を表示
0008F2 CF68 CD77CF          17      CALL    P_N1
0008F5 CF6B 7E               7      LD  A,(HL)
0008F6 CF6C CD51DA          17      CALL    CAP3
0008F9 CF6F D8              11      RET C   ;拡張子が無い
                                
0008FA CF70 3E2E             7      LD  A,'.'
0008FC CF72 CDACD3          17      CALL    MSG_A
0008FF CF75 0603             7      LD  B,3 ;拡張子を表示
       CF77                     P_N1:
000901 CF77 7E               7      LD  A,(HL)
000902 CF78 CD51DA          17      CALL    CAP3
000905 CF7B 3807            12      JR  C,P_N2
000907 CF7D CDACD3          17      CALL    MSG_A
00090A CF80 23               6      INC HL
00090B CF81 10F4            13      DJNZ    P_N1
00090D CF83 C9              10      RET
       CF84                     P_N2:
00090E CF84 23               6      INC HL
00090F CF85 10FD            13      DJNZ    P_N2
000911 CF87 C9              10      RET
                                
       CF88                     SETFCB:
000912 CF88 CDFFD7          17      CALL    SPCUT
000915 CF8B 1A               7      LD  A,(DE)
000916 CF8C FE20             7      CP  020H
000918 CF8E 3801            12      JR  C,SETFCBA
00091A CF90 1B               6      DEC DE
       CF91                     SETFCBA:
00091B CF91 0624             7      LD  B,36
00091D CF93 215C00          10      LD  HL,FCB1
000920 CF96 E5              11      PUSH    HL
000921 CF97 AF               4      XOR A
000922 CF98 CDD4D7          17      CALL    FILL_MEMORY
000925 CF9B E1              10      POP HL
000926 CF9C D5              11      PUSH    DE
000927 CF9D CD43D3          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
00092A CFA0 216C00          10      LD  HL,FCB2
00092D CFA3 CD43D3          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000930 CFA6 E1              10      POP HL
000931 CFA7 010050          10      LD  BC,05000H
000934 CFAA 118100          10      LD  DE,00081H
       CFAD                     SETFCB1:
000937 CFAD 7E               7      LD  A,(HL)
000938 CFAE 23               6      INC HL
000939 CFAF FE20             7      CP  020H
00093B CFB1 3805            12      JR  C,SETFCB2
00093D CFB3 12               7      LD  (DE),A
00093E CFB4 13               6      INC DE
00093F CFB5 0C               4      INC C
000940 CFB6 10F5            13      DJNZ    SETFCB1
       CFB8                     SETFCB2:
000942 CFB8 79               4      LD  A,C
000943 CFB9 328000          13      LD  (DTA1),A
000946 CFBC 04               4      INC B
       CFBD                     ZERO_MEMORY_DE:
000947 CFBD AF               4      XOR A
       CFBE                     FILL_MEMORY_DE:
000948 CFBE 12               7      LD  (DE),A
000949 CFBF 13               6      INC DE
00094A CFC0 10FC            13      DJNZ    FILL_MEMORY_DE
00094C CFC2 C9              10      RET
                                
       CFC3                     C_COPY:
00094D CFC3 CD88CF          17      CALL    SETFCB
                                
000950 CFC6 1161E6          10      LD  DE,ZERO
000953 CFC9 CD21D7          17      CALL    FILEC2
000956 CFCC 216C00          10      LD  HL,FCB2
000959 CFCF CD4AD3          17      CALL    S29X1
                                
00095C CFD2 3E10             7      LD  A,010H
00095E CFD4 326900          13      LD  (FCB1+13),A
000961 CFD7 216D00          10      LD  HL,FCB2FN
000964 CFDA CD9ED0          17      CALL    CWILD1
       CFDD                     COPY0:
000967 CFDD CD9BD0          17      CALL    CWILD
00096A CFE0 215C00          10      LD  HL,FCB1
00096D CFE3 CD44CD          17      CALL    OPEN
000970 CFE6 37               4      SCF
       CFE7                     COPY1:
000971 CFE7 C0              11      RET NZ
000972 CFE8 CD57CD          17      CALL    DEFCB
                                
000975 CFEB 3A4FE5          13      LD  A,(DTA_CCP+13)
000978 CFEE CB67             8      BIT 4,A
00097A CFF0 2821            12      JR  Z,COPY1A
                                
00097C CFF2 215D00          10      LD  HL,FCB1FN
00097F CFF5 CD64DB          17      CALL    CHKWILD
000982 CFF8 3814            12      JR  C,COPY9
                                
000984 CFFA 3E20             7      LD  A,020H
000986 CFFC 325D00          13      LD  (FCB1FN),A
000989 CFFF 2A5CE5          16      LD  HL,(DTA_CCP+26)
00098C D002 23               6      INC HL
00098D D003 226A00          16      LD  (FCB1+14),HL
000990 D006 18D5            12      JR  COPY0
                                
       D008                     COPY8:
000992 D008 CD0AD1          17      CALL    _SYS09      ;(BDOS)文字列出力
000995 D00B CDECCE          17      CALL    LTNL
       D00E                     COPY9:
000998 D00E CD53CD          17      CALL    OPEN2
00099B D011 18D4            12      JR  COPY1
                                
       D013                     COPY1A:
00099D D013 216C00          10      LD  HL,FCB2
0009A0 D016 1114E6          10      LD  DE,FDRV
0009A3 D019 0144E5          10      LD  BC,DTA_CCP+2
0009A6 D01C EDA0            16      LDI
0009A8 D01E 3E0B             7      LD  A,11
       D020                     COPY2:
0009AA D020 F5              11      PUSH    AF
0009AB D021 7E               7      LD  A,(HL)
0009AC D022 FE3F             7      CP  '?'
0009AE D024 2001            12      JR  NZ,COPY3
0009B0 D026 0A               7      LD  A,(BC)
       D027                     COPY3:
0009B1 D027 12               7      LD  (DE),A
0009B2 D028 03               6      INC BC
0009B3 D029 13               6      INC DE
0009B4 D02A 23               6      INC HL
0009B5 D02B F1              10      POP AF
0009B6 D02C 3D               4      DEC A
0009B7 D02D 20F1            12      JR  NZ,COPY2
0009B9 D02F 010500          10      LD  BC,16-11
0009BC D032 EDB0                    LDIR
       D034                     PUTNAME:
0009BE D034 215D00          10      LD  HL,FCB1FN
0009C1 D037 CD64DB          17      CALL    CHKWILD
0009C4 D03A 300B            12      JR  NC,PUTN1
0009C6 D03C 2115E6          10      LD  HL,FDRV+1
0009C9 D03F CD66CF          17      CALL    FPRNT
0009CC D042 3E20             7      LD  A,020H
0009CE D044 CDACD3          17      CALL    MSG_A
       D047                     PUTN1:
0009D1 D047 1114E6          10      LD  DE,FDRV
0009D4 D04A 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
0009D6 D04C CD72CD          17      CALL    SYSTEM0
0009D9 D04F 2048            12      JR  NZ,COPYE2
0009DB D051 67               4      LD  H,A     ;A=0
0009DC D052 6F               4      LD  L,A
0009DD D053 2235E6          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0009E0 D056 2237E6          16      LD  (FDRV+35),HL
       D059                     COPY6:
0009E3 D059 CD7BCD          17      CALL    S27BUF
0009E6 D05C 47               4      LD  B,A
0009E7 D05D 3C               4      INC A
0009E8 D05E 2831            12      JR  Z,COPYE
0009EA D060 7C               4      LD  A,H
0009EB D061 B5               4      OR  L
0009EC D062 280C            12      JR  Z,COPY7
0009EE D064 1114E6          10      LD  DE,FDRV
0009F1 D067 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0009F3 D069 CD72CD          17      CALL    SYSTEM0
0009F6 D06C 2023            12      JR  NZ,COPYE
0009F8 D06E 10E9            13      DJNZ    COPY6
       D070                     COPY7:
0009FA D070 3A4FE5          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0009FD D073 3221E6          13      LD  (FDRV+13),A
000A00 D076 2156E5          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
000A03 D079 1128E6          10      LD  DE,FDRV+20
000A06 D07C 010400          10      LD  BC,4
000A09 D07F EDB0                    LDIR
                                
000A0B D081 1114E6          10      LD  DE,FDRV
000A0E D084 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
000A10 D086 CD72CD          17      CALL    SYSTEM0
000A13 D089 2006            12      JR  NZ,COPYE
                                
000A15 D08B 1171E6          10      LD  DE,OK
000A18 D08E C308D0          10      JP  COPY8
                                
       D091                     COPYE:
000A1B D091 1114E6          10      LD  DE,FDRV
000A1E D094 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
000A20 D096 CD0500          17      CALL    SYSTEM
       D099                     COPYE2:
000A23 D099 37               4      SCF
000A24 D09A C9              10      RET
                                
       D09B                     CWILD:
000A25 D09B 215D00          10      LD  HL,FCB1FN
       D09E                     CWILD1:
000A28 D09E 7E               7      LD  A,(HL)
000A29 D09F FE20             7      CP  020H
000A2B D0A1 C0              11      RET NZ
       D0A2                     CWILD2:
000A2C D0A2 3E3F             7      LD  A,'?'
000A2E D0A4 060B             7      LD  B,11
000A30 D0A6 C3D4D7          10      JP  FILL_MEMORY
                                
       D0A9                     COMTB:
000A33 D0A9 44202020                DB  "D   "  ;1
000A37 D0AD 5ACE                    DW  C_DIR
000A39 D0AF 44495220                DB  "DIR "  ;2
000A3D D0B3 5ACE                    DW  C_DIR
000A3F D0B5 434F5059                DB  "COPY"  ;3
000A43 D0B9 C3CF                    DW  C_COPY
000A45 D0BB 43442020                DB  "CD  "  ;4
000A49 D0BF 77CD                    DW  C_CD
000A4B D0C1 44454C20                DB  "DEL "  ;5
000A4F D0C5 3DCE                    DW  C_DEL
000A51 D0C7 50415448                DB  "PATH"  ;6
000A55 D0CB F1CE                    DW  C_PATH
000A57 D0CD 52454E20                DB  "REN "  ;7
000A5B D0D1 47CE                    DW  C_REN
000A5D D0D3 52454D20                DB  "REM "  ;8
000A61 D0D7 07D1                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D0D9                     BDOS0:
000A63 D0D9 E5              11      PUSH    HL
000A64 D0DA 79               4      LD  A,C
000A65 D0DB FE3C             7      CP  03CH
000A67 D0DD 3802            12      JR  C,DOS1
000A69 D0DF 3E3C             7      LD  A,03CH
       D0E1                     DOS1:
000A6B D0E1 87               4      ADD A,A
000A6C D0E2 32E6D0          13      LD  (DOS1_SWC),A
000A6F D0E5 2A00E7          16      LD  HL,(STABLE)
       D0E6                     DOS1_SWC    EQU $-2
000A72 D0E8 E3              19      EX  (SP),HL
000A73 D0E9 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
000A74 D0EA C9              10      RET
       D0EB                     _DOS2:
000A75 D0EB FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000A77 D0ED CA85D3          10      JP  Z,_SYS5A
000A7A D0F0 FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000A7C D0F2 CA42D3          10      JP  Z,_SYS5C
000A7F D0F5 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
000A81 D0F7 CA61E4          10      JP  Z,_SYS5F
000A84 D0FA FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000A86 D0FC 200A            12      JR  NZ,_ERROR
000A88 D0FE 011D00          10      LD  BC,VER_6F
000A8B D101 116201          10      LD  DE,VER
000A8E D104 210301          10      LD  HL,MACD
       D107                     C_REM:
000A91 D107 AF               4      XOR A
       D108                     _ERROR:
000A92 D108 A7               4      AND A
000A93 D109 C9              10      RET
                                
       D10A                     _SYS09:     ;文字列出力
000A94 D10A D5              11      PUSH    DE
       D10B                     _SX09:
000A95 D10B 1A               7      LD  A,(DE)
000A96 D10C 13               6      INC DE
000A97 D10D FE24             7      CP  '$'
000A99 D10F 2831            12      JR  Z,SX0E2
000A9B D111 CDACD3          17      CALL    MSG_A
000A9E D114 18F5            12      JR  _SX09
                                
       D116                     MSX1:
000AA0 D116 CDACD3          17      CALL    MSG_A
       D119                     MSX:
000AA3 D119 7E               7      LD  A,(HL)
000AA4 D11A 23               6      INC HL
000AA5 D11B B7               4      OR  A
000AA6 D11C 20F8            12      JR  NZ,MSX1
000AA8 D11E C9              10      RET
                                
       D11F                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000AA9 D11F 212200          10      LD  HL,00022H
000AAC D122 7D               4      LD  A,L
000AAD D123 C9              10      RET
                                
       D124                     _SYS0D:     ;(BDOS)ディスクリセット
000AAE D124 CDDFE6          17      CALL    _FFLUSH
000AB1 D127 E5              11      PUSH    HL
000AB2 D128 218000          10      LD  HL,00080H
000AB5 D12B 228AE6          16      LD  (_DTA),HL
000AB8 D12E E1              10      POP HL
000AB9 D12F D5              11      PUSH    DE
000ABA D130 1E00             7      LD  E,0
000ABC D132 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D133                     _SYS0E:     ;(BDOS)カレントドライブの設定
000ABD D133 D5              11      PUSH    DE
000ABE D134 7B               4      LD  A,E
000ABF D135 DDE5            15      PUSH    IX
000AC1 D137 CDDCE6          17      CALL    _GETDPB
000AC4 D13A DDE1            14      POP IX
000AC6 D13C 3804            12      JR  C,SX0E2
000AC8 D13E 7B               4      LD  A,E
000AC9 D13F 320400          13      LD  (_DVSW),A
       D142                     SX0E2:
000ACC D142 D1              10      POP DE
000ACD D143 C9              10      RET
                                
       D144                     _SYS0F:     ;(BDOS)ファイルのオープン
000ACE D144 CD11D8          17      CALL    SETDRV
000AD1 D147 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000AD4 D14A C602             7      ADD A,002H      ;Write
000AD6 D14C 2848            12      JR  Z,FEND0F
000AD8 D14E CD60DB          17      CALL    CHKWILDX
                                
000ADB D151 D43BD8          17      CALL    NC,SOPENX
       D154                     _S16XX:
000ADE D154 3840            12      JR  C,FEND0F
                                                ;Directory location
000AE0 D156 3A9FE6          13      LD  A,(_FILEN)
000AE3 D159 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
000AE6 D15C 3AA0E6          13      LD  A,(_DIRF)
000AE9 D15F FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000AEC D162 FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
000AEF D165 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
000AF2 D168 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
000AF6 D16C FDE5            15      PUSH    IY
000AF8 D16E D1              10      POP DE
000AF9 D16F 13               6      INC DE
000AFA D170 010B00          10      LD  BC,11
000AFD D173 EDB0                    LDIR
                                ;               Attribute
000AFF D175 7E               7      LD  A,(HL)
000B00 D176 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
000B03 D179 110B00          10      LD  DE,11       ;Reserved
000B06 D17C 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
000B07 D17D 11E4E7          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
000B0A D180 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D182                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000B0C D182 1A               7      LD  A,(DE)
000B0D D183 13               6      INC DE
000B0E D184 328BD1          13      LD  (S16PAT),A
000B11 D187 7E               7      LD  A,(HL)
000B12 D188 23               6      INC HL
000B13 D189 FD7700          19      LD  (IY+0),A
       D18B                     S16PAT  EQU $-1
000B16 D18C 10F4            13      DJNZ    S16LOOP
                                
000B18 D18E AF               4      XOR A
000B19 D18F FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000B1C D192 FD2233D2        20      LD  (OFCB_SWC),IY
       D196                     FEND0F:
000B20 D196 1845            12      JR  FEND10
                                
       D198                     _SYS10:     ;(BDOS)ファイルのクローズ
000B22 D198 CD11D8          17      CALL    SETDRV
000B25 D19B FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000B28 D19E D6FE             7      SUB 0FEH
000B2A D1A0 37               4      SCF
000B2B D1A1 3F               4      CCF
000B2C D1A2 2039            12      JR  NZ,FEND10
       D1A4                     _S10A:              ;Write
000B2E D1A4 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000B31 D1A7 FD770F          19      LD  (IY+15),A
                                
000B34 D1AA FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
000B37 D1AD CD5CDC          17      CALL    SETTMS
                                
000B3A D1B0 FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000B3D D1B3 32A0E6          13      LD  (_DIRF),A
000B40 D1B6 E67F             7      AND 07FH
000B42 D1B8 3281E1          13      LD  (_SECPS),A
000B45 D1BB FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000B48 D1BE FD561F          19      LD  D,(IY+31)
000B4B D1C1 CD6FD9          17      CALL    READ_DIR
000B4E D1C4 3817            12      JR  C,FEND10
                                
000B50 D1C6 3A9BD8          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000B53 D1C9 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000B54 D1CA FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000B57 D1CD 6F               4      LD  L,A
000B58 D1CE 2600             7      LD  H,0
000B5A D1D0 29              11      ADD HL,HL       ;*2
000B5B D1D1 29              11      ADD HL,HL       ;*4
000B5C D1D2 29              11      ADD HL,HL       ;*8
000B5D D1D3 29              11      ADD HL,HL       ;*16
000B5E D1D4 29              11      ADD HL,HL       ;*32
000B5F D1D5 ED4B7EE7        20      LD  BC,(_DTBUF)
000B63 D1D9 09              11      ADD HL,BC
                                
000B64 D1DA CD70DB          17      CALL    SDIRENT
       D1DD                     FEND10:
000B67 D1DD 1842            12      JR  FEND
                                
       D1DF                     _SYS11:     ;(BDOS)最初のファイルの検索
000B69 D1DF CD11D8          17      CALL    SETDRV
000B6C D1E2 CD6AD8          17      CALL    SOPEN
       D1E5                     _S12X1:
000B6F D1E5 383A            12      JR  C,FEND
000B71 D1E7 CD09D9          17      CALL    SOPENE2
000B74 D1EA ED5B8AE6        20      LD  DE,(_DTA)
000B78 D1EE 3A88E6          13      LD  A,(_DRV)
000B7B D1F1 3C               4      INC A
000B7C D1F2 12               7      LD  (DE),A
000B7D D1F3 D5              11      PUSH    DE
000B7E D1F4 13               6      INC DE
000B7F D1F5 012000          10      LD  BC,32
000B82 D1F8 EDB0                    LDIR
000B84 D1FA FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000B87 D1FD FD660F          19      LD  H,(IY+15)
000B8A D200 22F4E7          16      LD  (SCDIR),HL
000B8D D203 2A9AE6          16      LD  HL,(_FBPS)
000B90 D206 22F6E7          16      LD  (SFBPS),HL
000B93 D209 2A9FE6          16      LD  HL,(_FILEN)
000B96 D20C 7C               4      LD  A,H
000B97 D20D B7               4      OR  A
000B98 D20E 2806            12      JR  Z,_S12DIR
000B9A D210 3A81E1          13      LD  A,(_SECPS)
000B9D D213 F680             7      OR  080H
000B9F D215 67               4      LD  H,A
       D216                     _S12DIR:
000BA0 D216 22F8E7          16      LD  (SFNDF),HL  ;Directory position and Flags
000BA3 D219 E1              10      POP HL
000BA4 D21A 1139E6          10      LD  DE,SFILE
000BA7 D21D 0E21             7      LD  C,33
       D21F                     _S11B:
000BA9 D21F EDB0                    LDIR
       D221                     FEND:
000BAB D221 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D222                     FENDE:
000BAC D222 FDE1            14      POP IY
000BAE D224 C1              10      POP BC
000BAF D225 D1              10      POP DE
000BB0 D226 E1              10      POP HL
000BB1 D227 C9              10      RET
                                
       D228                     _SYS12:     ;(BDOS)次のファイルの検索
000BB2 D228 E5              11      PUSH    HL
000BB3 D229 D5              11      PUSH    DE
000BB4 D22A C5              11      PUSH    BC
000BB5 D22B FDE5            15      PUSH    IY
000BB7 D22D CDCED8          17      CALL    NOPEN
000BBA D230 18B3            12      JR  _S12X1
                                
       D232                     _S16K:
000BBC D232 110000          10      LD  DE,0
       D233                     OFCB_SWC    EQU $-2
000BBF D235 D5              11      PUSH    DE
000BC0 D236 061A             7      LD  B,26        ;First cluster
       D238                     S16K1:
000BC2 D238 13               6      INC DE
000BC3 D239 23               6      INC HL
000BC4 D23A 10FC            13      DJNZ    S16K1
                                
000BC6 D23C 1A               7      LD  A,(DE)
000BC7 D23D BE               7      CP  (HL)
000BC8 D23E 2015            12      JR  NZ,S16K2
000BCA D240 13               6      INC DE
000BCB D241 23               6      INC HL
000BCC D242 1A               7      LD  A,(DE)
000BCD D243 BE               7      CP  (HL)
000BCE D244 200F            12      JR  NZ,S16K2
                                
000BD0 D246 E1              10      POP HL
000BD1 D247 FDE5            15      PUSH    IY
000BD3 D249 D1              10      POP DE
000BD4 D24A 7E               7      LD  A,(HL)
000BD5 D24B CD26D8          17      CALL    IS_SAME_DRV_A_DE
000BD8 D24E 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000BDA D250 ED52            15      SBC HL,DE       ;CP HL,DE
000BDC D252 37               4      SCF
000BDD D253 C0              11      RET NZ
000BDE D254 E5              11      PUSH    HL
       D255                     S16K2:
000BDF D255 E1              10      POP HL
       D256                     S16K3:
000BE0 D256 FDE5            15      PUSH    IY
000BE2 D258 D1              10      POP DE
       D259                     _SYS13:     ;(BDOS)ファイルの削除
000BE3 D259 CD11D8          17      CALL    SETDRV
000BE6 D25C CD98DA          17      CALL    KILL
       D25F                     FEND13:
000BE9 D25F 18C0            12      JR  FEND
                                
       D261                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000BEB D261 CD11D8          17      CALL    SETDRV
000BEE D264 CDD4DF          17      CALL    INIT_SEQ
       D267                     SREAD:
000BF1 D267 CDA6DF          17      CALL    RB_READ
                                
000BF4 D26A C601             7      ADD A,001H
000BF6 D26C 38B3            12      JR  C,FEND
                                
000BF8 D26E 7D               4      LD  A,L
000BF9 D26F D601             7      SUB 001H
       D271                     FENDX:
000BFB D271 9F               4      SBC A,A
000BFC D272 E603             7      AND 3
000BFE D274 1F               4      RRA
000BFF D275 18AB            12      JR  FENDE
                                
       D277                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000C01 D277 CD11D8          17      CALL    SETDRV
000C04 D27A CDD4DF          17      CALL    INIT_SEQ
       D27D                     SWRITE:
000C07 D27D CDA1DF          17      CALL    RB_WRITE
                                
000C0A D280 C6FF             7      ADD A,0FFH
000C0C D282 18ED            12      JR  FENDX
                                
       D284                     _SYS17:     ;(BDOS)ファイル名の変更
000C0E D284 CD11D8          17      CALL    SETDRV
000C11 D287 CDEEDA          17      CALL    NAME
000C14 D28A 18D3            12      JR  FEND13
                                
       D28C                     _SYS16:     ;(BDOS)ファイルの作成
000C16 D28C CD11D8          17      CALL    SETDRV
                                
000C19 D28F CD60DB          17      CALL    CHKWILDX
000C1C D292 38CB            12      JR  C,FEND13
000C1E D294 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000C21 D297 FE05             7      CP  5
000C23 D299 2805            12      JR  Z,_S16X2
000C25 D29B FE21             7      CP  021H
000C27 D29D DA5FD2          10      JP  C,FEND13
       D2A0                     _S16X2:
                                ;               Clear FCB
000C2A D2A0 FDE5            15      PUSH    IY
000C2C D2A2 E1              10      POP HL
000C2D D2A3 011000          10      LD  BC,16
000C30 D2A6 09              11      ADD HL,BC
       D2A7                     _S16X1:
000C31 D2A7 70               7      LD  (HL),B      ;B=0
000C32 D2A8 23               6      INC HL
000C33 D2A9 0D               4      DEC C
000C34 D2AA 20FB            12      JR  NZ,_S16X1
                                
000C36 D2AC CD61DC          17      CALL    SETTMSX
000C39 D2AF FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000C3D D2B3 CD3BD8          17      CALL    SOPENX
000C40 D2B6 3F               4      CCF
000C41 D2B7 CC32D2          17      CALL    Z,_S16K
000C44 D2BA D41AD9          17      CALL    NC,COPEN
000C47 D2BD D470DB          17      CALL    NC,SDIRENT
000C4A D2C0 C354D1          10      JP  _S16XX
                                
       D2C3                     _SYS21:     ;(BDOS)ランダムな読み出し
000C4D D2C3 CD11D8          17      CALL    SETDRV
000C50 D2C6 CDACDC          17      CALL    INIT_RND
000C53 D2C9 189C            12      JR  SREAD
                                
       D2CB                     _SYS22:     ;(BDOS)ランダムな書き込み
       D2CB                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000C55 D2CB CD11D8          17      CALL    SETDRV
000C58 D2CE CDACDC          17      CALL    INIT_RND
000C5B D2D1 18AA            12      JR  SWRITE
                                
       D2D3                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000C5D D2D3 21FF00          10      LD  HL,000FFH
000C60 D2D6 AF               4      XOR A
000C61 D2D7 C9              10      RET
                                
       D2D8                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000C62 D2D8 3A0400          13      LD  A,(_DVSW)   ;from LDOS
000C65 D2DB A7               4      AND A
000C66 D2DC C9              10      RET
                                
       D2DD                     _SYS1A:     ;(BDOS)DTAの設定
000C67 D2DD ED538AE6        20      LD  (_DTA),DE
000C6B D2E1 AF               4      XOR A
000C6C D2E2 C9              10      RET
                                
       D2E3                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000C6D D2E3 7B               4      LD  A,E
000C6E D2E4 CD1FD8          17      CALL    GETDRV
000C71 D2E7 CDDCE6          17      CALL    _GETDPB
000C74 D2EA D4E2E6          17      CALL    NC,_RDFATX
000C77 D2ED 210000          10      LD  HL,0
000C7A D2F0 D43ADC          17      CALL    NC,DSKF
                                
000C7D D2F3 ED5B3BDC        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000C81 D2F7 1B               6      DEC DE      ;DE←クラスタの総数
000C82 D2F8 FD2A7CE7        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000C86 D2FC 9F               4      SBC A,A
000C87 D2FD D8              11      RET C
000C88 D2FE 4F               4      LD  C,A     ;C=0
000C89 D2FF DD7E0F          19      LD  A,(IX+DPB_BPS)
000C8C D302 E607             7      AND 7
000C8E D304 47               4      LD  B,A
000C8F D305 DD7E07          19      LD  A,(IX+DPB_SECPCL)
000C92 D308 C9              10      RET
                                
       D309                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000C93 D309 AF               4      XOR A
000C94 D30A 67               4      LD  H,A
000C95 D30B 6F               4      LD  L,A
000C96 D30C C9              10      RET
                                
       D30D                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000C97 D30D 2100E8          10      LD  HL,_DEVICE
000C9A D310 7B               4      LD  A,E
000C9B D311 C3DCE6          10      JP  _GETDPB
                                
       D314                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000C9E D314 E5              11      PUSH    HL
000C9F D315 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000CA1 D317 CDD9D0          17      CALL    BDOS0
000CA4 D31A 381B            12      JR  C,_S23X1
                                
000CA6 D31C D5              11      PUSH    DE      ;EX DE,IY
000CA7 D31D FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000CA9 D31F FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000CAC D322 FD6E11          19      LD  L,(IY+17)   ;
000CAF D325 FD6612          19      LD  H,(IY+18)   ;
000CB2 D328 C5              11      PUSH    BC      ;
000CB3 D329 FD4613          19      LD  B,(IY+19)   ;
000CB6 D32C CD9EDC          17      CALL    GET_CPM_R_SIZE
000CB9 D32F C1              10      POP BC
       D330                     _S24X1:
000CBA D330 CDBEDC          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000CBD D333 FDE3            23      EX  (SP),IY     ;
000CBF D335 D1              10      POP DE      ;
                                
000CC0 D336 AF               4      XOR A
       D337                     _S23X1:
000CC1 D337 E1              10      POP HL
000CC2 D338 C9              10      RET
                                
       D339                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000CC3 D339 E5              11      PUSH    HL
000CC4 D33A D5              11      PUSH    DE      ;EX DE,IY
000CC5 D33B FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000CC7 D33D CDDCDF          17      CALL    GETSEQ
000CCA D340 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D342                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000CCC D342 2B               6      DEC HL
       D343                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000CCD D343 C5              11      PUSH    BC
000CCE D344 E5              11      PUSH    HL
000CCF D345 CD29D7          17      CALL    FILE
000CD2 D348 E1              10      POP HL
000CD3 D349 C1              10      POP BC
       D34A                     S29X1:
000CD4 D34A C5              11      PUSH    BC
000CD5 D34B D5              11      PUSH    DE
000CD6 D34C E5              11      PUSH    HL
000CD7 D34D EB               4      EX  DE,HL
000CD8 D34E AF               4      XOR A
000CD9 D34F 3221E6          13      LD  (FDRV+13),A
000CDC D352 2114E6          10      LD  HL,FDRV
000CDF D355 011000          10      LD  BC,16
000CE2 D358 EDB0                    LDIR
000CE4 D35A E1              10      POP HL
000CE5 D35B D1              10      POP DE
000CE6 D35C C1              10      POP BC
000CE7 D35D C9              10      RET
                                
       D35E                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000CE8 D35E C5              11      PUSH    BC
000CE9 D35F 0122E3          10      LD  BC,DWT24B
000CEC D362 1804            12      JR  S2FX
       D364                     _SYS2F:
000CEE D364 C5              11      PUSH    BC
000CEF D365 0114E3          10      LD  BC,DRD24B
       D368                     S2FX:
000CF2 D368 ED437ED3        20      LD  (S2F_SWC),BC
000CF6 D36C CDDFE6          17      CALL    _FFLUSH
                                
000CF9 D36F D5              11      PUSH    DE
000CFA D370 E5              11      PUSH    HL
000CFB D371 7D               4      LD  A,L     ;Drive
000CFC D372 CDD9E6          17      CALL    _CHGDRV
000CFF D375 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
000D01 D377 44               4      LD  B,H     ;Number of clusters
000D02 D378 2A8AE6          16      LD  HL,(_DTA)
                                
000D05 D37B 0E00             7      LD  C,0
000D07 D37D CD14E3          17      CALL    DRD24B
       D37E                     S2F_SWC EQU $-2
       D380                     POP_HL_DE_BC_SBCAA_RET:
000D0A D380 E1              10      POP HL
000D0B D381 D1              10      POP DE
000D0C D382 C1              10      POP BC
000D0D D383 9F               4      SBC A,A
000D0E D384 C9              10      RET
                                
       D385                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000D0F D385 C5              11      PUSH    BC
000D10 D386 D5              11      PUSH    DE
000D11 D387 E5              11      PUSH    HL
000D12 D388 CD1ED7          17      CALL    FILEC
000D15 D38B 2180D3          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
000D18 D38E E5              11      PUSH    HL
000D19 D38F 3A21E6          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
000D1C D392 E610             7      AND 010H        ;ディレクトリ
000D1E D394 37               4      SCF
000D1F D395 C8              11      RET Z
000D20 D396 1114E6          10      LD  DE,FDRV
000D23 D399 2A4EE7          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       D39C                     JPHL:
000D26 D39C E9               4      JP  (HL)
                                
       D39D                     SHOW_ERROR:         ;(9)
000D27 D39D 1179E6          10      LD  DE,COMERM
000D2A D3A0 CD0AD1          17      CALL    _SYS09      ;(BDOS)文字列出力
000D2D D3A3 C300E6          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "MSXIO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MSX
                                
       D108                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D108                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D108                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D108                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D108                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D108                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       0000                     CTRL00  EQU 0
       0000                     CTRL03  EQU 0
       0000                     CTRL04  EQU 0
       0000                     CTRL05  EQU 0
       0000                     CTRL06  EQU 0
       0000                     CTRL07  EQU 0
       0000                     CTRL08  EQU 0
       0000                     CTRL09  EQU 0
       0000                     CTRL0A  EQU 0
       0000                     CTRL0B  EQU 0
       0000                     CTRL0C  EQU 0
       0000                     CTRL0D  EQU 0
       0000                     CTRL0E  EQU 0
       0000                     CTRL12  EQU 0
       0000                     CTRL1B  EQU 0
       0000                     CTRL1C  EQU 0
       0000                     CTRL1D  EQU 0
       0000                     CTRL1E  EQU 0
       0000                     CTRL1F  EQU 0
                                
       D3A6                     PRINT:
000D30 D3A6 7B               4      LD  A,E
000D31 D3A7 1803            12      JR  MSG_A
                                
       D3A9                     _SYS01:     ;(BDOS)コンソール入力
000D33 D3A9 CD09E6          17      CALL    _SYS07
       D3AC                     MSG_A:
000D36 D3AC FE03             7      CP  3
000D38 D3AE 2814            12      JR  Z,MSG_BR
       D3B0                     MSGA1:
000D3A D3B0 F5              11      PUSH    AF
000D3B D3B1 C5              11      PUSH    BC
000D3C D3B2 D5              11      PUSH    DE
000D3D D3B3 E5              11      PUSH    HL
000D3E D3B4 DDE5            15      PUSH    IX
000D40 D3B6 DD21A200        14      LD  IX,CHPUT
000D44 D3BA CD1FD6          17      CALL    CALSLT_R
000D47 D3BD DDE1            14      POP IX
000D49 D3BF E1              10      POP HL
000D4A D3C0 D1              10      POP DE
000D4B D3C1 C1              10      POP BC
       D3C2                     MSGA2:
000D4C D3C2 F1              10      POP AF
000D4D D3C3 C9              10      RET
       D3C4                     MSG_BR:
000D4E D3C4 F5              11      PUSH    AF
000D4F D3C5 3ADDF3          13      LD  A,(CSRX)
000D52 D3C8 FE02             7      CP  2
000D54 D3CA 38F6            12      JR  C,MSGA2
000D56 D3CC F1              10      POP AF
       D3CD                     MSG_CR:
000D57 D3CD F5              11      PUSH    AF
000D58 D3CE 3E0D             7      LD  A,00DH
000D5A D3D0 CDB0D3          17      CALL    MSGA1
000D5D D3D3 3E0A             7      LD  A,00AH
000D5F D3D5 CDB0D3          17      CALL    MSGA1
000D62 D3D8 F1              10      POP AF
000D63 D3D9 C9              10      RET
                                
       D3DA                     _SYS02:     ;(BDOS)コンソール出力
000D64 D3DA CDF6D3          17      CALL    BREAK
000D67 D3DD C3CDE6          10      JP  _PRINT
                                
       D3E0                     _SYS06:     ;(BDOS)コンソール直接入出力
000D6A D3E0 7B               4      LD  A,E
000D6B D3E1 3C               4      INC A
000D6C D3E2 CACAE6          10      JP  Z,_INKEY
000D6F D3E5 C3CDE6          10      JP  _PRINT
                                
       D3E8                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000D72 D3E8 CD09E6          17      CALL    _SYS07
000D75 D3EB FE03             7      CP  3
000D77 D3ED CCF4E6          17      CALL    Z,_BREAK
000D7A D3F0 FE13             7      CP  013H        ;CTRL+S
000D7C D3F2 C0              11      RET NZ
       D3F3                     PAUSE:
000D7D D3F3 CD0DD4          17      CALL    KEYBC
                                
       D3F6                     BREAK:
000D80 D3F6 F5              11      PUSH    AF
000D81 D3F7 C5              11      PUSH    BC
000D82 D3F8 D5              11      PUSH    DE
000D83 D3F9 E5              11      PUSH    HL
000D84 D3FA DDE5            15      PUSH    IX
000D86 D3FC DD21B700        14      LD  IX,BREAKX
000D8A D400 CD1FD6          17      CALL    CALSLT_R
000D8D D403 DDE1            14      POP IX
000D8F D405 E1              10      POP HL
000D90 D406 D1              10      POP DE
000D91 D407 C1              10      POP BC
000D92 D408 DCF4E6          17      CALL    C,_BREAK
000D95 D40B F1              10      POP AF
000D96 D40C C9              10      RET
       D40D                     KEYBC:
000D97 D40D F5              11      PUSH    AF
000D98 D40E C5              11      PUSH    BC
000D99 D40F D5              11      PUSH    DE
000D9A D410 E5              11      PUSH    HL
000D9B D411 DDE5            15      PUSH    IX
000D9D D413 DD215601        14      LD  IX,KILBUF
000DA1 D417 CD1FD6          17      CALL    CALSLT_R
000DA4 D41A DDE1            14      POP IX
000DA6 D41C E1              10      POP HL
000DA7 D41D D1              10      POP DE
000DA8 D41E C1              10      POP BC
000DA9 D41F F1              10      POP AF
000DAA D420 C9              10      RET
       D421                     FLGET:
000DAB D421 C5              11      PUSH    BC
000DAC D422 D5              11      PUSH    DE
000DAD D423 E5              11      PUSH    HL
000DAE D424 DDE5            15      PUSH    IX
000DB0 D426 CDDFE6          17      CALL    _FFLUSH
000DB3 D429 181B            12      JR  FLGET1
       D42A                     CBIOS_SWC1  EQU $-1
000DB5 D42B CD07D6          17      CALL    GETVRAM
                                
000DB8 D42E E5              11      PUSH    HL
000DB9 D42F DD214A00        14      LD  IX,RDVRM
000DBD D433 CD1FD6          17      CALL    CALSLT_R
000DC0 D436 E1              10      POP HL
000DC1 D437 3252D4          13      LD  (SWCCHR),A
                                
000DC4 D43A E5              11      PUSH    HL
000DC5 D43B 3EFF             7      LD  A,0FFH
000DC7 D43D DD214D00        14      LD  IX,WRTVRM
000DCB D441 CD1FD6          17      CALL    CALSLT_R
000DCE D444 E1              10      POP HL
                                
000DCF D445 E5              11      PUSH    HL
       D446                     FLGET1:
000DD0 D446 DD219F00        14      LD  IX,CHGET
000DD4 D44A CD1FD6          17      CALL    CALSLT_R
000DD7 D44D 180C            12      JR  FLGET2
       D44E                     CBIOS_SWC2  EQU $-1
000DD9 D44F E1              10      POP HL
                                
000DDA D450 F5              11      PUSH    AF
000DDB D451 3E00             7      LD  A,0
       D452                     SWCCHR  EQU $-1
000DDD D453 DD214D00        14      LD  IX,WRTVRM
000DE1 D457 CD1FD6          17      CALL    CALSLT_R
000DE4 D45A F1              10      POP AF
       D45B                     FLGET2:
000DE5 D45B DDE1            14      POP IX
000DE7 D45D E1              10      POP HL
000DE8 D45E D1              10      POP DE
000DE9 D45F C1              10      POP BC
000DEA D460 FE03             7      CP  3
000DEC D462 C0              11      RET NZ
000DED D463 C300E6          10      JP  CPM_BOOT
                                
       D466                     INKEY:
000DF0 D466 CD06E6          17      CALL    CPM_CONST
000DF3 D469 C8              11      RET Z
000DF4 D46A 18B5            12      JR  FLGET
                                
       D46C                     _SYS0A:     ;(BDOS)文字列入力
000DF6 D46C C5              11      PUSH    BC
000DF7 D46D E5              11      PUSH    HL
000DF8 D46E D5              11      PUSH    DE
000DF9 D46F CD98D4          17      CALL    GETL
000DFC D472 111FF4          10      LD  DE,KBUF
000DFF D475 E1              10      POP HL
000E00 D476 E5              11      PUSH    HL
000E01 D477 0E00             7      LD  C,0
000E03 D479 3004            12      JR  NC,SAX0
000E05 D47B 23               6      INC HL
000E06 D47C 23               6      INC HL
000E07 D47D 1808            12      JR  SAX4
       D47F                     SAX0:
000E09 D47F 46               7      LD  B,(HL)
000E0A D480 23               6      INC HL
       D481                     SAX1:
000E0B D481 23               6      INC HL
000E0C D482 1A               7      LD  A,(DE)
000E0D D483 13               6      INC DE
000E0E D484 B7               4      OR  A
000E0F D485 2004            12      JR  NZ,SAX2
       D487                     SAX4:
000E11 D487 360D            10      LD  (HL),00DH
000E13 D489 1804            12      JR  SAX3
       D48B                     SAX2:
000E15 D48B 77               7      LD  (HL),A
000E16 D48C 0C               4      INC C
000E17 D48D 10F2            13      DJNZ    SAX1
       D48F                     SAX3:
000E19 D48F D1              10      POP DE
000E1A D490 79               4      LD  A,C
000E1B D491 13               6      INC DE
000E1C D492 12               7      LD  (DE),A
000E1D D493 1B               6      DEC DE
000E1E D494 E1              10      POP HL
000E1F D495 C1              10      POP BC
000E20 D496 A7               4      AND A
000E21 D497 C9              10      RET
       D498                     GETL:
000E22 D498 DDE5            15      PUSH    IX
000E24 D49A FDE5            15      PUSH    IY
                                
000E26 D49C 2ADCF3          16      LD  HL,(CSRY)
000E29 D49F 22CAFB          16      LD  (FSTPOS),HL
       D4A2                     GETL1:
000E2C D4A2 CDE8D3          17      CALL    _SYS08
000E2F D4A5 FE09             7      CP  9
000E31 D4A7 2008            12      JR  NZ,GETL1V
000E33 D4A9 211FF4          10      LD  HL,KBUF
000E36 D4AC CD19D1          17      CALL    MSX
000E39 D4AF 18F1            12      JR  GETL1
       D4B1                     GETL1V:
000E3B D4B1 5F               4      LD  E,A
000E3C D4B2 FE08             7      CP  8
000E3E D4B4 CCADD5          17      CALL    Z,CTRL02
000E41 D4B7 FE20             7      CP  020H
000E43 D4B9 D4D9D5          17      CALL    NC,INSERT
000E46 D4BC CDB0D3          17      CALL    MSGA1
                                
000E49 D4BF 7B               4      LD  A,E
000E4A D4C0 FE0D             7      CP  00DH
000E4C D4C2 20DE            12      JR  NZ,GETL1
                                
000E4E D4C4 111FF4          10      LD  DE,KBUF
000E51 D4C7 3AB0F3          13      LD  A,(LINLEN)
000E54 D4CA 47               4      LD  B,A
000E55 D4CB CDBDCF          17      CALL    ZERO_MEMORY_DE
                                
000E58 D4CE 2ACAFB          16      LD  HL,(FSTPOS)
000E5B D4D1 3ADCF3          13      LD  A,(CSRY)
000E5E D4D4 6F               4      LD  L,A
000E5F D4D5 E5              11      PUSH    HL
000E60 D4D6 CD0AD6          17      CALL    LOC0
000E63 D4D9 4D               4      LD  C,L
000E64 D4DA 44               4      LD  B,H
000E65 D4DB E1              10      POP HL
000E66 D4DC 3AB0F3          13      LD  A,(LINLEN)
000E69 D4DF 94               4      SUB H
000E6A D4E0 3D               4      DEC A
000E6B D4E1 5F               4      LD  E,A
000E6C D4E2 211FF4          10      LD  HL,KBUF
       D4E5                     GETL2:
000E6F D4E5 CDD0E6          17      CALL    _SCRN
000E72 D4E8 03               6      INC BC
000E73 D4E9 77               7      LD  (HL),A
000E74 D4EA 23               6      INC HL
000E75 D4EB 1D               4      DEC E
000E76 D4EC 20F7            12      JR  NZ,GETL2
000E78 D4EE CDCDD3          17      CALL    MSG_CR
                                
000E7B D4F1 FDE1            14      POP IY
000E7D D4F3 DDE1            14      POP IX
       D4F5                     GETL3:
000E7F D4F5 2B               6      DEC HL
000E80 D4F6 7E               7      LD  A,(HL)
000E81 D4F7 FE21             7      CP  021H
000E83 D4F9 D0              11      RET NC
000E84 D4FA 3600            10      LD  (HL),0
000E86 D4FC 15               4      DEC D
000E87 D4FD 20F6            12      JR  NZ,GETL3
000E89 D4FF C9              10      RET
                                
       D500                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       D500                     CONSTX:
000E8A D500 C5              11      PUSH    BC
000E8B D501 D5              11      PUSH    DE
000E8C D502 E5              11      PUSH    HL
000E8D D503 DDE5            15      PUSH    IX
000E8F D505 DD219C00        14      LD  IX,CHSNS
000E93 D509 CD1FD6          17      CALL    CALSLT_R
000E96 D50C DDE1            14      POP IX
000E98 D50E E1              10      POP HL
000E99 D50F D1              10      POP DE
000E9A D510 C1              10      POP BC
000E9B D511 C9              10      RET
                                
       D512                     _SYS2A:     ;(BDOS)日付の獲得
000E9C D512 0E0B             7      LD  C,11        ;年/Year→HL
000E9E D514 CD53D5          17      CALL    RDCLK_BCD
000EA1 D517 6F               4      LD  L,A
000EA2 D518 2600             7      LD  H,0
000EA4 D51A 3AF8FA          13      LD  A,(EXBRSA)
000EA7 D51D B7               4      OR  A
000EA8 D51E 2804            12      JR  Z,SX2A1
000EAA D520 11BC07          10      LD  DE,1980     ;1980年～2079年
000EAD D523 19              11      ADD HL,DE
       D524                     SX2A1:
000EAE D524 0E09             7      LD  C,9     ;月/Month→D
000EB0 D526 CD53D5          17      CALL    RDCLK_BCD
000EB3 D529 57               4      LD  D,A
                                
000EB4 D52A 0E07             7      LD  C,7     ;日/Day→E
000EB6 D52C CD53D5          17      CALL    RDCLK_BCD
000EB9 D52F 5F               4      LD  E,A
                                
000EBA D530 0E06             7      LD  C,6     ;曜日/Week→A
       D532                     RDCLK:
000EBC D532 DDE5            15      PUSH    IX
000EBE D534 DD21F501        14      LD  IX,REDCLK
       D538                     WRCLK1:
000EC2 D538 3AF8FA          13      LD  A,(EXBRSA)
000EC5 D53B B7               4      OR  A
000EC6 D53C 280A            12      JR  Z,RDCLK1    ;MSX1
000EC8 D53E FDE5            15      PUSH    IY
000ECA D540 FD67             9      LD  IYH,A
000ECC D542 78               4      LD  A,B
000ECD D543 CD3BD6          17      CALL    CALSLTR
000ED0 D546 FDE1            14      POP IY
       D548                     RDCLK1:
000ED2 D548 DDE1            14      POP IX
000ED4 D54A C9              10      RET
       D54B                     WRCLK:
000ED5 D54B DDE5            15      PUSH    IX
000ED7 D54D DD21F901        14      LD  IX,WRTCLK
000EDB D551 18E5            12      JR  WRCLK1
                                
       D553                     RDCLK_BCD:
000EDD D553 CD32D5          17      CALL    RDCLK       ;1の位
000EE0 D556 47               4      LD  B,A
000EE1 D557 0C               4      INC C
000EE2 D558 CD32D5          17      CALL    RDCLK       ;10の位
000EE5 D55B 87               4      ADD A,A     ;*2
000EE6 D55C 4F               4      LD  C,A
000EE7 D55D 87               4      ADD A,A     ;*4
000EE8 D55E 87               4      ADD A,A     ;*8
000EE9 D55F 81               4      ADD A,C     ;*10(8+2)
000EEA D560 80               4      ADD A,B     ;1の位
000EEB D561 C9              10      RET
                                
       D562                     _SYS2C:     ;(BDOS)時刻の獲得
000EEC D562 011501          10      LD  BC,00115H       ;12時間計/24時間計の設定を24時間計に
000EEF D565 CD4BD5          17      CALL    WRCLK
000EF2 D568 0E04             7      LD  C,4     ;H=時/Hour
000EF4 D56A CD53D5          17      CALL    RDCLK_BCD
000EF7 D56D 67               4      LD  H,A
000EF8 D56E 0E02             7      LD  C,2     ;L=分/Minute
000EFA D570 CD53D5          17      CALL    RDCLK_BCD
000EFD D573 6F               4      LD  L,A
000EFE D574 0E00             7      LD  C,0     ;D=秒/Second
000F00 D576 CD53D5          17      CALL    RDCLK_BCD
000F03 D579 57               4      LD  D,A
000F04 D57A AF               4      XOR A       ;E=1/100秒
000F05 D57B 5F               4      LD  E,A
000F06 D57C C9              10      RET
                                
       D57D                     POS:
000F07 D57D F5              11      PUSH    AF
000F08 D57E 2ADCF3          16      LD  HL,(CSRY)
000F0B D581 7D               4      LD  A,L
000F0C D582 6C               4      LD  L,H
000F0D D583 67               4      LD  H,A
000F0E D584 2C               4      INC L
000F0F D585 24               4      INC H
000F10 D586 F1              10      POP AF
000F11 D587 C9              10      RET
                                
       D588                     LOC:
000F12 D588 F5              11      PUSH    AF
000F13 D589 E5              11      PUSH    HL
000F14 D58A 7D               4      LD  A,L
000F15 D58B 6C               4      LD  L,H
000F16 D58C 67               4      LD  H,A
000F17 D58D 2D               4      DEC L
000F18 D58E 25               4      DEC H
000F19 D58F DDE5            15      PUSH    IX
000F1B D591 DD21C600        14      LD  IX,POSIT
000F1F D595 CD1FD6          17      CALL    CALSLT_R
000F22 D598 DDE1            14      POP IX
000F24 D59A E1              10      POP HL
000F25 D59B F1              10      POP AF
000F26 D59C C9              10      RET
       D59D                     SCRN:
000F27 D59D E5              11      PUSH    HL
000F28 D59E DDE5            15      PUSH    IX
                                
000F2A D5A0 69               4      LD  L,C
000F2B D5A1 60               4      LD  H,B
000F2C D5A2 DD214A00        14      LD  IX,RDVRM
000F30 D5A6 CD1FD6          17      CALL    CALSLT_R
                                
000F33 D5A9 DDE1            14      POP IX
000F35 D5AB E1              10      POP HL
000F36 D5AC C9              10      RET
                                
       D5AD                     CTRL02:
000F37 D5AD F5              11      PUSH    AF
000F38 D5AE D5              11      PUSH    DE
000F39 D5AF 2ADCF3          16      LD  HL,(CSRY)
000F3C D5B2 3AB0F3          13      LD  A,(LINLEN)
000F3F D5B5 4F               4      LD  C,A
000F40 D5B6 94               4      SUB H   ;CSRX
000F41 D5B7 C602             7      ADD A,2
000F43 D5B9 47               4      LD  B,A ;カーソルより右の文字数
000F44 D5BA 61               4      LD  H,C ;LINLEN
000F45 D5BB C5              11      PUSH    BC
000F46 D5BC CD0AD6          17      CALL    LOC0
000F49 D5BF C1              10      POP BC
                                
000F4A D5C0 1620             7      LD  D,020H
       D5C2                     C8X1:
000F4C D5C2 DD214A00        14      LD  IX,RDVRM
000F50 D5C6 CD1FD6          17      CALL    CALSLT_R
000F53 D5C9 4F               4      LD  C,A
000F54 D5CA 7A               4      LD  A,D
000F55 D5CB DD214D00        14      LD  IX,WRTVRM
000F59 D5CF CD1FD6          17      CALL    CALSLT_R
000F5C D5D2 2B               6      DEC HL
000F5D D5D3 51               4      LD  D,C
000F5E D5D4 10EC            13      DJNZ    C8X1
000F60 D5D6 D1              10      POP DE
000F61 D5D7 F1              10      POP AF
000F62 D5D8 C9              10      RET
                                
       D5D9                     INSERT:
000F63 D5D9 F5              11      PUSH    AF
000F64 D5DA D5              11      PUSH    DE
000F65 D5DB 2ADCF3          16      LD  HL,(CSRY)
000F68 D5DE 3AB0F3          13      LD  A,(LINLEN)
000F6B D5E1 4F               4      LD  C,A
000F6C D5E2 94               4      SUB H   ;CSRX
000F6D D5E3 3C               4      INC A
000F6E D5E4 47               4      LD  B,A ;カーソルより右の文字数
000F6F D5E5 C5              11      PUSH    BC
000F70 D5E6 CD0AD6          17      CALL    LOC0
000F73 D5E9 C1              10      POP BC
                                
000F74 D5EA 1620             7      LD  D,020H
       D5EC                     INS1:
000F76 D5EC DD214A00        14      LD  IX,RDVRM
000F7A D5F0 CD1FD6          17      CALL    CALSLT_R
000F7D D5F3 4F               4      LD  C,A
000F7E D5F4 7A               4      LD  A,D
000F7F D5F5 DD214D00        14      LD  IX,WRTVRM
000F83 D5F9 CD1FD6          17      CALL    CALSLT_R
000F86 D5FC 23               6      INC HL
000F87 D5FD 51               4      LD  D,C
000F88 D5FE 10EC            13      DJNZ    INS1
000F8A D600 D1              10      POP DE
000F8B D601 F1              10      POP AF
000F8C D602 C9              10      RET
                                
       D603                     CONOUT1:
000F8D D603 59               4      LD  E,C
000F8E D604 C3CDE6          10      JP  _PRINT
                                
       D607                     GETVRAM:
000F91 D607 2ADCF3          16      LD  HL,(CSRY)
       D60A                     LOC0:
000F94 D60A 2D               4      DEC L
000F95 D60B 25               4      DEC H
000F96 D60C 4C               4      LD  C,H ;CSRX-1
000F97 D60D 5D               4      LD  E,L ;CSRY-1
       D60E                     LOC1:
000F98 D60E 3AB0F3          13      LD  A,(LINLEN)
000F9B D611 67               4      LD  H,A
000F9C D612 1600             7      LD  D,0
000F9E D614 6A               4      LD  L,D ;0
000F9F D615 0608             7      LD  B,8
       D617                     LOC2:
000FA1 D617 29              11      ADD HL,HL
000FA2 D618 3001            12      JR  NC,LOC3
000FA4 D61A 19              11      ADD HL,DE
       D61B                     LOC3:
000FA5 D61B 10FA            13      DJNZ    LOC2
000FA7 D61D 09              11      ADD HL,BC
000FA8 D61E C9              10      RET
                                
       D61F                     CALSLT_R:
000FA9 D61F FDE5            15      PUSH    IY
000FAB D621 FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000FAF D625 CD3BD6          17      CALL    CALSLTR
000FB2 D628 FDE1            14      POP IY
000FB4 D62A C9              10      RET
                                
       D62B                     CALLF:
000FB5 D62B 08               4      EX  AF,AF'
000FB6 D62C E3              19      EX  (SP),HL
000FB7 D62D 7E               7      LD  A,(HL)
000FB8 D62E FD67             9      LD  IYH,A
000FBA D630 23               6      INC HL
000FBB D631 7E               7      LD  A,(HL)
000FBC D632 DD6F             9      LD  IXL,A
000FBE D634 23               6      INC HL
000FBF D635 7E               7      LD  A,(HL)
000FC0 D636 DD67             9      LD  IXH,A
000FC2 D638 23               6      INC HL
000FC3 D639 E3              19      EX  (SP),HL
000FC4 D63A 08               4      EX  AF,AF'
       D63B                     CALSLTR:
000FC5 D63B 08               4      EX  AF,AF'
000FC6 D63C 3E1C             7      LD  A,_CALSLT
                                ;
                                ;メインROMのインタースロットコールを呼び出す
                                ;in
                                ;A:インタースロットコールのアドレス
                                ;A':インタースロットコールの際に渡すAの値
                                ;
       D63E                     SLTCALL:
000FC8 D63E F3               4      DI
000FC9 D63F 3280D6          13      LD  (SLTCALLX),A
000FCC D642 AF               4      XOR A
000FCD D643 3281D6          13      LD  (SLTCALLX_H),A
000FD0 D646 ED735DD6        20      LD  (CSSP),SP
000FD4 D64A 3A5ED6          13      LD  A,(CSSP+1)
000FD7 D64D FE41             7      CP  040H+1
000FD9 D64F 3805            12      JR  C,CALSLTR1
000FDB D651 CD61D6          17      CALL    CALSLTR2
000FDE D654 FB               4      EI
000FDF D655 C9              10      RET
       D656                     CALSLTR1:
000FE0 D656 315EF5          10      LD  SP,BUF
000FE3 D659 CD61D6          17      CALL    CALSLTR2
000FE6 D65C 310000          10      LD  SP,0
       D65D                     CSSP    EQU $-2
000FE9 D65F FB               4      EI
000FEA D660 C9              10      RET
       D661                     CALSLTR2:
000FEB D661 C5              11      PUSH    BC
000FEC D662 E5              11      PUSH    HL
000FED D663 3A80D6          13      LD  A,(SLTCALLX)
000FF0 D666 FE1C             7      CP  _CALSLT
000FF2 D668 200B            12      JR  NZ,CALSLTR3
000FF4 D66A 3AC1FC          13      LD  A,(EXPTBL)
000FF7 D66D FDBC            10      CP  IYH
000FF9 D66F 2004            12      JR  NZ,CALSLTR3 ;_CALSLTでメインROMの場合はIXをコールする
000FFB D671 DD2280D6        20      LD  (SLTCALLX),IX
       D675                     CALSLTR3:
000FFF D675 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
001002 D678 CDA6D6          17      CALL    ENASLT0
001005 D67B E1              10      POP HL
001006 D67C C1              10      POP BC
001007 D67D F5              11      PUSH    AF      ;A:元のスロット
001008 D67E 08               4      EX  AF,AF'
001009 D67F CD1C00          17      CALL    _CALSLT     ;自己書き換え
       D680                     SLTCALLX    EQU $-2
       D681                     SLTCALLX_H  EQU $-1
00100C D682 08               4      EX  AF,AF'
00100D D683 F1              10      POP AF
00100E D684 08               4      EX  AF,AF'      ;裏A:元のスロット
00100F D685 C5              11      PUSH    BC
001010 D686 E5              11      PUSH    HL
001011 D687 08               4      EX  AF,AF'
001012 D688 CDA6D6          17      CALL    ENASLT0
001015 D68B 08               4      EX  AF,AF'
001016 D68C E1              10      POP HL
001017 D68D C1              10      POP BC
001018 D68E C9              10      RET
                                
       D68F                     RDSLTR:
001019 D68F 08               4      EX  AF,AF'
00101A D690 3E0C             7      LD  A,_RDSLT
00101C D692 18AA            12      JR  SLTCALL
                                
       D694                     WRSLTR:
00101E D694 08               4      EX  AF,AF'
00101F D695 3E14             7      LD  A,_WRSLT
001021 D697 18A5            12      JR  SLTCALL
                                
       D699                     ENASLT1:
001023 D699 08               4      EX  AF,AF'
001024 D69A 3E24             7      LD  A,_ENASLT
001026 D69C 18A0            12      JR  SLTCALL
       D69E                     ENASLTR:
001028 D69E CB7C             8      BIT 7,H
00102A D6A0 20F7            12      JR  NZ,ENASLT1
00102C D6A2 CB74             8      BIT 6,H
00102E D6A4 20F3            12      JR  NZ,ENASLT1
                                ;
                                ;ページ0専門のENASLT
                                ;in
                                ;A←スロット
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       D6A6                     ENASLT0:
001030 D6A6 F3               4      DI
001031 D6A7 6F               4      LD  L,A
001032 D6A8 E603             7      AND 3
001034 D6AA 4F               4      LD  C,A
001035 D6AB DBA8            11      IN  A,(0A8H)
001037 D6AD 67               4      LD  H,A
001038 D6AE E6FC             7      AND 0FCH
00103A D6B0 B1               4      OR  C
00103B D6B1 D3A8            11      OUT (0A8H),A
00103D D6B3 7C               4      LD  A,H
00103E D6B4 E603             7      AND 3
001040 D6B6 CB7D             8      BIT 7,L
001042 D6B8 C8              11      RET Z
001043 D6B9 F680             7      OR  080H
001045 D6BB 67               4      LD  H,A
001046 D6BC 7D               4      LD  A,L
001047 D6BD 0F               4      RRCA
001048 D6BE 0F               4      RRCA
001049 D6BF E603             7      AND 3
00104B D6C1 4F               4      LD  C,A
00104C D6C2 3AFFFF          13      LD  A,(0FFFFH)
00104F D6C5 2F               4      CPL
001050 D6C6 47               4      LD  B,A
001051 D6C7 E6FC             7      AND 0FCH
001053 D6C9 B1               4      OR  C
001054 D6CA 32FFFF          13      LD  (0FFFFH),A
001057 D6CD 78               4      LD  A,B
001058 D6CE E603             7      AND 3
00105A D6D0 87               4      ADD A,A
00105B D6D1 87               4      ADD A,A
00105C D6D2 B4               4      OR  H
00105D D6D3 4F               4      LD  C,A
                                
00105E D6D4 7D               4      LD  A,L
00105F D6D5 E603             7      AND 3
001061 D6D7 C6C5             7      ADD A,LOW SLTTBL
001063 D6D9 6F               4      LD  L,A
001064 D6DA 26FC             7      LD  H,HIGH SLTTBL
001066 D6DC 70               7      LD  (HL),B
001067 D6DD 79               4      LD  A,C
001068 D6DE C9              10      RET
                                
       D6DF                     INT38H:
001069 D6DF F5              11      PUSH    AF
00106A D6E0 C5              11      PUSH    BC
00106B D6E1 E5              11      PUSH    HL
00106C D6E2 2100BF          10      LD  HL,010000H-04100H   ;メインROMを呼び出すのでスタックがPage1に被っていないかチェック
00106F D6E5 39              11      ADD HL,SP
001070 D6E6 3825            12      JR  C,INT38H1
001072 D6E8 2A03D7          16      LD  HL,(INTSP)      ;別の割り込み中の場合は飛ばす
001075 D6EB 7C               4      LD  A,H
001076 D6EC B5               4      OR  L
001077 D6ED 202A            12      JR  NZ,INT38H2
                                
001079 D6EF ED7303D7        20      LD  (INTSP),SP  ;スタックポインタがページ1
00107D D6F3 315EF5          10      LD  SP,BUF
001080 D6F6 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
001083 D6F9 CDA6D6          17      CALL    ENASLT0
001086 D6FC CD3800          17      CALL    00038H
001089 D6FF CDA6D6          17      CALL    ENASLT0
00108C D702 310000          10      LD  SP,0
       D703                     INTSP   EQU $-2
00108F D705 210000          10      LD  HL,0
001092 D708 2203D7          16      LD  (INTSP),HL
001095 D70B 180C            12      JR  INT38H2
                                
       D70D                     INT38H1:
001097 D70D 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
00109A D710 CDA6D6          17      CALL    ENASLT0
00109D D713 CD3800          17      CALL    00038H
0010A0 D716 CDA6D6          17      CALL    ENASLT0
       D719                     INT38H2:
0010A3 D719 E1              10      POP HL
0010A4 D71A C1              10      POP BC
0010A5 D71B F1              10      POP AF
0010A6 D71C FB               4      EI
0010A7 D71D C9              10      RET
                                
                                
                                
                                
                                
[EOF:MSXIO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       D71E                     FILEC:
0010A8 D71E CD29D7          17      CALL    FILE
       D721                     FILEC2:
0010AB D721 3A15E6          13      LD  A,(FDRV+1)
0010AE D724 FE20             7      CP  020H
0010B0 D726 C8              11      RET Z
0010B1 D727 1839            12      JR  SETDIR1
                                
       D729                     FILE:
0010B3 D729 AF               4      XOR A
0010B4 D72A 3214E6          13      LD  (FDRV),A
0010B7 D72D 67               4      LD  H,A
0010B8 D72E 6F               4      LD  L,A
0010B9 D72F 2222E6          16      LD  (FDRV+14),HL
0010BC D732 CDFFD7          17      CALL    SPCUT
0010BF D735 CDE4D7          17      CALL    CCHK3
0010C2 D738 2812            12      JR  Z,DEVI1
0010C4 D73A 13               6      INC DE
0010C5 D73B 1A               7      LD  A,(DE)
0010C6 D73C 1B               6      DEC DE
0010C7 D73D FE3A             7      CP  ':'
0010C9 D73F 200B            12      JR  NZ,DEVI1
0010CB D741 1A               7      LD  A,(DE)      ;DRIVE
0010CC D742 CD45DA          17      CALL    CAP
0010CF D745 D640             7      SUB '@'
0010D1 D747 13               6      INC DE
0010D2 D748 13               6      INC DE
0010D3 D749 3214E6          13      LD  (FDRV),A
       D74C                     DEVI1:
0010D6 D74C 1A               7      LD  A,(DE)
0010D7 D74D D65C             7      SUB 05CH        ;\
0010D9 D74F 2009            12      JR  NZ,NOROOT
0010DB D751 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
0010DC D752 222EE6          16      LD  (FDRV+26),HL
0010DF D755 2C               4      INC L
0010E0 D756 2222E6          16      LD  (FDRV+14),HL
0010E3 D759 13               6      INC DE
       D75A                     NOROOT:
                                
       D75A                     SETDIR:
0010E4 D75A CD85D7          17      CALL    FILED
0010E7 D75D 1A               7      LD  A,(DE)
0010E8 D75E FE5C             7      CP  05CH        ;\
0010EA D760 C0              11      RET NZ
0010EB D761 13               6      INC DE
       D762                     SETDIR1:
0010EC D762 3E10             7      LD  A,010H      ;Directory
0010EE D764 3221E6          13      LD  (FDRV+13),A
0010F1 D767 D5              11      PUSH    DE
0010F2 D768 1114E6          10      LD  DE,FDRV
0010F5 D76B 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
0010F7 D76D CDD9D0          17      CALL    BDOS0
0010FA D770 D1              10      POP DE
0010FB D771 B7               4      OR  A
0010FC D772 C0              11      RET NZ
                                
0010FD D773 3A21E6          13      LD  A,(FDRV+13)
001100 D776 E610             7      AND 010H        ;ディレクトリ
001102 D778 C8              11      RET Z
                                
001103 D779 CDCCD7          17      CALL    FILEI
001106 D77C 2A2EE6          16      LD  HL,(FDRV+26)
001109 D77F 23               6      INC HL
00110A D780 2222E6          16      LD  (FDRV+14),HL
00110D D783 18D5            12      JR  SETDIR
                                
       D785                     FILED:
00110F D785 CDCCD7          17      CALL    FILEI
001112 D788 2115E6          10      LD  HL,FNAME
                                
001115 D78B 0608             7      LD  B,8
       D78D                     FILE2:
001117 D78D CDD9D7          17      CALL    CCHKF
00111A D790 C8              11      RET Z
00111B D791 FE2A             7      CP  '*'
00111D D793 282E            12      JR  Z,FILE9
00111F D795 FE2E             7      CP  '.'
001121 D797 280C            12      JR  Z,FILE4
001123 D799 77               7      LD  (HL),A
001124 D79A 23               6      INC HL
001125 D79B 10F0            13      DJNZ    FILE2
                                
       D79D                     FILE3:
001127 D79D CDD9D7          17      CALL    CCHKF
00112A D7A0 C8              11      RET Z
00112B D7A1 FE2E             7      CP  '.'
00112D D7A3 20F8            12      JR  NZ,FILE3
                                
       D7A5                     FILE4:
00112F D7A5 211DE6          10      LD  HL,FNAME+8
001132 D7A8 0603             7      LD  B,3
                                
       D7AA                     FILE4L:
001134 D7AA CDD9D7          17      CALL    CCHKF
001137 D7AD C8              11      RET Z
001138 D7AE FE2E             7      CP  '.'
00113A D7B0 2008            12      JR  NZ,FILE12
00113C D7B2 3215E6          13      LD  (FNAME),A   ;Parent directory(..)
00113F D7B5 3216E6          13      LD  (FNAME+1),A
001142 D7B8 3E20             7      LD  A,020H
       D7BA                     FILE12:
001144 D7BA FE2A             7      CP  '*'
001146 D7BC 280A            12      JR  Z,FILE10
001148 D7BE 77               7      LD  (HL),A
001149 D7BF 23               6      INC HL
00114A D7C0 10E8            13      DJNZ    FILE4L
00114C D7C2 C9              10      RET
                                
       D7C3                     FILE9:              ;名前の*処理、名前の残りを?で埋める
00114D D7C3 CDC8D7          17      CALL    FILE10
001150 D7C6 18D5            12      JR  FILE3
                                
       D7C8                     FILE10:
001152 D7C8 3E3F             7      LD  A,'?'
001154 D7CA 1808            12      JR  FILL_MEMORY
       D7CC                     FILEI:              ;名前＋拡張子をスペースで初期化
001156 D7CC 3E20             7      LD  A,020H
001158 D7CE 01000B          10      LD  BC,11*256   ;C=0にしておく
00115B D7D1 2115E6          10      LD  HL,FNAME
       D7D4                     FILL_MEMORY:            ;HLからBバイトAで埋める
00115E D7D4 77               7      LD  (HL),A
00115F D7D5 23               6      INC HL
001160 D7D6 10FC            13      DJNZ    FILL_MEMORY
001162 D7D8 C9              10      RET
                                
       D7D9                     CCHKF:
001163 D7D9 1A               7      LD  A,(DE)
001164 D7DA CDE1D7          17      CALL    CCHK2
001167 D7DD C8              11      RET Z
001168 D7DE C34DDB          10      JP  FKAN
                                
       D7E1                     CCHK2:
00116B D7E1 0C               4      INC C
00116C D7E2 0D               4      DEC C
00116D D7E3 C0              11      RET NZ
       D7E4                     CCHK3:              ;ZF=1 で使えない文字
00116E D7E4 FE2B             7      CP  '+'
001170 D7E6 C8              11      RET Z
001171 D7E7 FE2C             7      CP  ','
001173 D7E9 C8              11      RET Z
001174 D7EA FE2F             7      CP  '/'
001176 D7EC C8              11      RET Z
001177 D7ED FE3A             7      CP  ':'
001179 D7EF C8              11      RET Z
00117A D7F0 FE3B             7      CP  ';'
00117C D7F2 C8              11      RET Z
00117D D7F3 FE3D             7      CP  '='
00117F D7F5 C8              11      RET Z
001180 D7F6 FE5C             7      CP  05CH    ;\
001182 D7F8 C8              11      RET Z
001183 D7F9 FE20             7      CP  020H
001185 D7FB D0              11      RET NC
001186 D7FC BF               4      CP  A       ;Z=1
001187 D7FD C9              10      RET
                                
       D7FE                     SS1:
001188 D7FE 13               6      INC DE
       D7FF                     SPCUT:              ;スペースをカット
001189 D7FF 1A               7      LD  A,(DE)
00118A D800 FE20             7      CP  020H
00118C D802 28FA            12      JR  Z,SS1
00118E D804 C9              10      RET
                                
       D805                     SETDRVF:
00118F D805 1114E6          10      LD  DE,FDRV
       D808                     SETDRV0:
001192 D808 CD11D8          17      CALL    SETDRV
001195 D80B FDE1            14      POP IY
001197 D80D C1              10      POP BC
001198 D80E D1              10      POP DE
001199 D80F E1              10      POP HL
00119A D810 C9              10      RET
                                
       D811                     SETDRV:
00119B D811 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
00119C D812 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
00119D D813 C5              11      PUSH    BC
00119E D814 1A               7      LD  A,(DE)
00119F D815 D5              11      PUSH    DE
0011A0 D816 FDE3            23      EX  (SP),IY
                                
0011A2 D818 CD1FD8          17      CALL    GETDRV
0011A5 D81B CDD9E6          17      CALL    _CHGDRV
                                
0011A8 D81E E9               4      JP  (HL)
                                
       D81F                     GETDRV:
0011A9 D81F CD32D8          17      CALL    GETDRV1
0011AC D822 3288E6          13      LD  (_DRV),A
0011AF D825 C9              10      RET
                                
       D826                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
0011B0 D826 CD32D8          17      CALL    GETDRV1
0011B3 D829 C5              11      PUSH    BC
0011B4 D82A 4F               4      LD  C,A
0011B5 D82B 1A               7      LD  A,(DE)
0011B6 D82C CD32D8          17      CALL    GETDRV1
0011B9 D82F A9               4      XOR C
0011BA D830 C1              10      POP BC
0011BB D831 C9              10      RET
       D832                     GETDRV1:
0011BC D832 E67F             7      AND 07FH
0011BE D834 D601             7      SUB 001H
0011C0 D836 D0              11      RET NC
0011C1 D837 3A0400          13      LD  A,(_DVSW)   ;Current Drive
0011C4 D83A C9              10      RET
                                
       D83B                     SOPENX:
0011C5 D83B 1139E6          10      LD  DE,SFILE
0011C8 D83E FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
0011CB D841 CD26D8          17      CALL    IS_SAME_DRV_A_DE
0011CE D844 2024            12      JR  NZ,SOPEN
0011D0 D846 13               6      INC DE
0011D1 D847 FDE5            15      PUSH    IY
0011D3 D849 E1              10      POP HL
0011D4 D84A 23               6      INC HL
0011D5 D84B CDD6D9          17      CALL    CPFILE
0011D8 D84E 201A            12      JR  NZ,SOPEN
                                
0011DA D850 2AF4E7          16      LD  HL,(SCDIR)
0011DD D853 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011E0 D856 FD740F          19      LD  (IY+15),H
                                
0011E3 D859 2AF8E7          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
0011E6 D85C 229FE6          16      LD  (_FILEN),HL
                                
0011E9 D85F ED5BF6E7        20      LD  DE,(SFBPS)
0011ED D863 2139E6          10      LD  HL,SFILE
0011F0 D866 36FF            10      LD  (HL),0FFH
0011F2 D868 23               6      INC HL
0011F3 D869 C9              10      RET
       D86A                     SOPEN:
0011F4 D86A 217ED9          10      LD  HL,FILESE
       D86D                     SOPENC:
0011F7 D86D 22A6D8          16      LD  (OPENPAT),HL
                                
0011FA D870 CDE2E6          17      CALL    _RDFATX     ;Detect Media
0011FD D873 3856            12      JR  C,RDDERR
                                
0011FF D875 AF               4      XOR A
001200 D876 329FE6          13      LD  (_FILEN),A
001203 D879 CD82DA          17      CALL    LDDIRX1     ;A=0で呼び出す
001206 D87C 2818            12      JR  Z,SDIRX1
                                
001208 D87E CD6FD9          17      CALL    READ_DIR    ;Sub Directory
00120B D881 3808            12      JR  C,SDIRX0
00120D D883 2A7EE7          16      LD  HL,(_DTBUF)
001210 D886 7E               7      LD  A,(HL)
001211 D887 FE2E             7      CP  '.'
001213 D889 280F            12      JR  Z,SOPEN1
       D88B                     SDIRX0:
001215 D88B AF               4      XOR A
001216 D88C 32A0E6          13      LD  (_DIRF),A
001219 D88F FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
00121D D893 FD770F          19      LD  (IY+15),A
       D896                     SDIRX1:
001220 D896 ED5BFCE7        20      LD  DE,(_DIRPS) ;Root Directory
       D89A                     SOPEN1:
001224 D89A 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       D89B                     SDECPAT EQU $-1
       D89C                     SOPEN1X:
001226 D89C CD6FD9          17      CALL    READ_DIR    ;FILE SEARCH
001229 D89F 382A            12      JR  C,RDDERR
00122B D8A1 2A7EE7          16      LD  HL,(_DTBUF)
       D8A4                     SOPEN2:
00122E D8A4 D5              11      PUSH    DE
00122F D8A5 CD7ED9          17      CALL    FILESE      ;(self-modifying code)
       D8A6                     OPENPAT EQU $-2
001232 D8A8 D1              10      POP DE
001233 D8A9 386D            12      JR  C,SOPENE
001235 D8AB 281B            12      JR  Z,SCF_FF_RET
       D8AD                     SOPEN3:
001237 D8AD 3AA0E6          13      LD  A,(_DIRF)   ;ディレクトリか判別
00123A D8B0 B7               4      OR  A
00123B D8B1 200C            12      JR  NZ,SOPEN5
00123D D8B3 13               6      INC DE      ;ルートディレクトリ
00123E D8B4 E5              11      PUSH    HL
00123F D8B5 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       D8B6                     MD_PAT  EQU $-2
001242 D8B8 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
001244 D8BA E1              10      POP HL
001245 D8BB 20DD            12      JR  NZ,SOPEN1
001247 D8BD 1807            12      JR  SOPEN6
       D8BF                     SOPEN5:
001249 D8BF CD89E1          17      CALL    GNCLX       ;END DIR
00124C D8C2 D8              11      RET C
00124D D8C3 CD36DA          17      CALL    ENDCL
       D8C6                     SOPEN6:
001250 D8C6 38D2            12      JR  C,SOPEN1
       D8C8                     SCF_FF_RET:
001252 D8C8 37               4      SCF         ;CF=1
001253 D8C9 9F               4      SBC A,A     ;A=0FFH
001254 D8CA C9              10      RET
                                
       D8CB                     RDDERR:
001255 D8CB BF               4      CP  A       ;READ ERR CF=1 ZF=1
001256 D8CC 37               4      SCF
001257 D8CD C9              10      RET
                                
       D8CE                     NOPEN:
001258 D8CE 217ED9          10      LD  HL,FILESE
00125B D8D1 22A6D8          16      LD  (OPENPAT),HL
00125E D8D4 FD2A98E6        20      LD  IY,(_FCB)
001262 D8D8 CD60DB          17      CALL    CHKWILDX
001265 D8DB 30EB            12      JR  NC,SCF_FF_RET
001267 D8DD FD7E00          19      LD  A,(IY+0)
00126A D8E0 CD1FD8          17      CALL    GETDRV
00126D D8E3 CDD9E6          17      CALL    _CHGDRV
001270 D8E6 D8              11      RET C
001271 D8E7 2AF8E7          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
001274 D8EA 229FE6          16      LD  (_FILEN),HL
                                
001277 D8ED CD7DDA          17      CALL    LDDIRX
00127A D8F0 ED5B9AE6        20      LD  DE,(_FBPS)
00127E D8F4 CD6FD9          17      CALL    READ_DIR
001281 D8F7 38D2            12      JR  C,RDDERR
001283 D8F9 3A9EE6          13      LD  A,(_FBCNT)
001286 D8FC 3D               4      DEC A
001287 D8FD 28AE            12      JR  Z,SOPEN3
       D8FF                     NOPEN2:
001289 D8FF 2A9CE6          16      LD  HL,(_FBAD)
00128C D902 012000          10      LD  BC,020H
00128F D905 09              11      ADD HL,BC
001290 D906 4F               4      LD  C,A
001291 D907 189B            12      JR  SOPEN2
                                
       D909                     SOPENE2:
001293 D909 229CE6          16      LD  (_FBAD),HL
001296 D90C 79               4      LD  A,C
001297 D90D 329EE6          13      LD  (_FBCNT),A
00129A D910 ED539AE6        20      LD  (_FBPS),DE
00129E D914 FD2298E6        20      LD  (_FCB),IY
       D918                     SOPENE:
0012A2 D918 AF               4      XOR A
0012A3 D919 C9              10      RET
                                
       D91A                     COPEN:
0012A4 D91A FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
0012A8 D91E 219BD9          10      LD  HL,NEXTSE
0012AB D921 CD6DD8          17      CALL    SOPENC
0012AE D924 D0              11      RET NC
0012AF D925 C8              11      RET Z
0012B0 D926 3AA0E6          13      LD  A,(_DIRF)   ;ディレクトリか判別
0012B3 D929 B7               4      OR  A
0012B4 D92A 37               4      SCF
0012B5 D92B C8              11      RET Z       ;ルートディレクトリ
0012B6 D92C 0601             7      LD  B,1
0012B8 D92E CDBFDB          17      CALL    WRDF
0012BB D931 D8              11      RET C
0012BC D932 ED5BFEE7        20      LD  DE,(_CLPS)
0012C0 D936 D5              11      PUSH    DE
0012C1 D937 CDFFD9          17      CALL    DCPAT
0012C4 D93A CD0AE0          17      CALL    DRDNX
0012C7 D93D 2A7EE7          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
0012CA D940 ED4BF5DE        20      LD  BC,(SECSZ)  ;1セクタのサイズ
0012CE D944 AF               4      XOR A
       D945                     COPENCL:
0012CF D945 77               7      LD  (HL),A
0012D0 D946 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0012D2 D948 EA45D9          10      JP  PE,COPENCL
                                
0012D5 D94B 3A1DDA          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
0012D8 D94E 3D               4      DEC A
0012D9 D94F 2819            12      JR  Z,COPENE
0012DB D951 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
0012DD D953 3281E1          13      LD  (_SECPS),A
0012E0 D956 D1              10      POP DE      ;DE=(_CLPS)
0012E1 D957 D5              11      PUSH    DE
       D958                     COPEN1:
0012E2 D958 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
0012E3 D959 C5              11      PUSH    BC
0012E4 D95A 2A7EE7          16      LD  HL,(_DTBUF)
0012E7 D95D CD19DA          17      CALL    CLUSTX
0012EA D960 CD20E3          17      CALL    DWT24
0012ED D963 C1              10      POP BC
0012EE D964 D1              10      POP DE
0012EF D965 CD80E1          17      CALL    NEXTX
0012F2 D968 20EE            12      JR  NZ,COPEN1
       D96A                     COPENE:
0012F4 D96A 2A7EE7          16      LD  HL,(_DTBUF)
0012F7 D96D D1              10      POP DE
0012F8 D96E C9              10      RET
                                
       D96F                     READ_DIR:
0012F9 D96F ED53FEE7        20      LD  (_CLPS),DE
0012FD D973 C5              11      PUSH    BC
0012FE D974 D5              11      PUSH    DE
0012FF D975 CDFFD9          17      CALL    DCPAT
001302 D978 CDEADF          17      CALL    DRDX
001305 D97B D1              10      POP DE
001306 D97C C1              10      POP BC
001307 D97D C9              10      RET
                                
       D97E                     FILESE:
001308 D97E 7E               7      LD  A,(HL)
001309 D97F B7               4      OR  A
00130A D980 C8              11      RET Z       ;END:ZF=1 CF=0
00130B D981 FEE5             7      CP  0E5H
00130D D983 280E            12      JR  Z,FILESE1
00130F D985 FDE5            15      PUSH    IY
001311 D987 D1              10      POP DE
001312 D988 13               6      INC DE
001313 D989 E5              11      PUSH    HL
001314 D98A CDD6D9          17      CALL    CPFILE
001317 D98D CCF7D9          17      CALL    Z,CPFILE2
00131A D990 E1              10      POP HL
00131B D991 37               4      SCF
00131C D992 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       D993                     FILESE1:
00131D D993 CDAAD9          17      CALL    FNEXT
001320 D996 20E6            12      JR  NZ,FILESE
       D998                     ZF0_CF0_AFF_RET:
001322 D998 F6FF             7      OR  0FFH        ;ZF=0 CF=0
001324 D99A C9              10      RET
                                
       D99B                     NEXTSE:
001325 D99B 7E               7      LD  A,(HL)
001326 D99C B7               4      OR  A
001327 D99D 37               4      SCF
001328 D99E C8              11      RET Z       ;!!!:ZF=1 CF=1
001329 D99F FEE5             7      CP  0E5H
00132B D9A1 37               4      SCF
00132C D9A2 C8              11      RET Z       ;!!!:(ZF=1) CF=1
00132D D9A3 CDAAD9          17      CALL    FNEXT
001330 D9A6 20F3            12      JR  NZ,NEXTSE
001332 D9A8 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       D9AA                     FNEXT:
001334 D9AA E5              11      PUSH    HL
001335 D9AB 219FE6          10      LD  HL,_FILEN
001338 D9AE 34              11      INC (HL)
001339 D9AF E1              10      POP HL
00133A D9B0 112000          10      LD  DE,020H
00133D D9B3 19              11      ADD HL,DE
00133E D9B4 0D               4      DEC C
00133F D9B5 C9              10      RET
                                
       D9B6                     CPNAME:
001340 D9B6 C5              11      PUSH    BC
001341 D9B7 D5              11      PUSH    DE
001342 D9B8 E5              11      PUSH    HL
001343 D9B9 CDD0D9          17      CALL    CPFILE4
001346 D9BC E1              10      POP HL
001347 D9BD 23               6      INC HL
001348 D9BE 23               6      INC HL
001349 D9BF 23               6      INC HL
00134A D9C0 23               6      INC HL
00134B D9C1 D1              10      POP DE
00134C D9C2 C1              10      POP BC
00134D D9C3 2005            12      JR  NZ,CPNAME1
00134F D9C5 7E               7      LD  A,(HL)
001350 D9C6 23               6      INC HL
001351 D9C7 66               7      LD  H,(HL)
001352 D9C8 6F               4      LD  L,A
001353 D9C9 C9              10      RET
       D9CA                     CPNAME1:
001354 D9CA 23               6      INC HL
001355 D9CB 23               6      INC HL
001356 D9CC 10E8            13      DJNZ    CPNAME
001358 D9CE 37               4      SCF
001359 D9CF C9              10      RET
                                
       D9D0                     CPFILE4:
00135A D9D0 C5              11      PUSH    BC
00135B D9D1 010004          10      LD  BC,00400H
00135E D9D4 1804            12      JR  CPSTR1
       D9D6                     CPFILE:
001360 D9D6 C5              11      PUSH    BC
001361 D9D7 01000B          10      LD  BC,00B00H
       D9DA                     CPSTR1:
001364 D9DA 1A               7      LD  A,(DE)
001365 D9DB FE3F             7      CP  '?'     ;Wild card
001367 D9DD 2812            12      JR  Z,CPSTR2
001369 D9DF 7E               7      LD  A,(HL)
00136A D9E0 CD46DB          17      CALL    FKANC
00136D D9E3 E5              11      PUSH    HL
00136E D9E4 67               4      LD  H,A
00136F D9E5 1A               7      LD  A,(DE)
001370 D9E6 CB01             8      RLC C
001372 D9E8 CD46DB          17      CALL    FKANC
001375 D9EB CB09             8      RRC C
001377 D9ED BC               4      CP  H       ;CP (HL),(DE)
001378 D9EE E1              10      POP HL
001379 D9EF 2004            12      JR  NZ,CPSTR3
       D9F1                     CPSTR2:
00137B D9F1 13               6      INC DE
00137C D9F2 23               6      INC HL
00137D D9F3 10E5            13      DJNZ    CPSTR1
       D9F5                     CPSTR3:
00137F D9F5 C1              10      POP BC
001380 D9F6 C9              10      RET
                                
       D9F7                     CPFILE2:
001381 D9F7 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001384 D9FA F6E1             7      OR  0E1H
001386 D9FC 2F               4      CPL
001387 D9FD A6               7      AND (HL)
001388 D9FE C9              10      RET
                                
       D9FF                     DCPAT:
001389 D9FF 0E00             7      LD  C,0
00138B DA01 2A7EE7          16      LD  HL,(_DTBUF)
00138E DA04 3AA0E6          13      LD  A,(_DIRF)   ;ディレクトリか判別
001391 DA07 B7               4      OR  A
001392 DA08 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
001393 DA09 3A1DDA          13      LD  A,(SPCPAT)
001396 DA0C 4F               4      LD  C,A
001397 DA0D 3A81E1          13      LD  A,(_SECPS)
00139A DA10 B9               4      CP  C
00139B DA11 3801            12      JR  C,DC1
00139D DA13 AF               4      XOR A
       DA14                     DC1:
00139E DA14 F680             7      OR  080H
0013A0 DA16 32A0E6          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       DA19                     CLUSTX:
0013A3 DA19 E5              11      PUSH    HL
0013A4 DA1A EB               4      EX  DE,HL
0013A5 DA1B AF               4      XOR A
0013A6 DA1C 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       DA1D                     SPCPAT  EQU $-1
       DA1E                     L_CLDBL:
0013A8 DA1E CB19             8      RR  C       ;->CF
0013AA DA20 3804            12      JR  C,E_CLDBL
0013AC DA22 29              11      ADD HL,HL       ;*2
0013AD DA23 8F               4      ADC A,A
0013AE DA24 18F8            12      JR  L_CLDBL
       DA26                     E_CLDBL:
0013B0 DA26 4F               4      LD  C,A
0013B1 DA27 3A81E1          13      LD  A,(_SECPS)
0013B4 DA2A B5               4      OR  L
0013B5 DA2B 6F               4      LD  L,A
0013B6 DA2C 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       DA2D                     CLSPAT  EQU $-2
0013B9 DA2F AF               4      XOR A
0013BA DA30 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
0013BB DA31 89               4      ADC A,C
0013BC DA32 4F               4      LD  C,A
0013BD DA33 EB               4      EX  DE,HL
0013BE DA34 E1              10      POP HL
0013BF DA35 C9              10      RET
                                ;(8)
       DA36                     ENDCL:
0013C0 DA36 7A               4      LD  A,D ;END CLUSTER
0013C1 DA37 FE01             7      CP  1   ;164=356    (self-modifying code)
       DA38                     CLPAT1  EQU $-1
0013C3 DA39 C0              11      RET NZ
0013C4 DA3A 7B               4      LD  A,E
0013C5 DA3B FE64             7      CP  064H    ;       (self-modifying code)
       DA3C                     CLPAT2  EQU $-1
0013C7 DA3D C9              10      RET
                                ;(3)
       DA3E                     CAP4:
0013C8 DA3E 3EE5             7      LD  A,0E5H
0013CA DA40 C9              10      RET
                                                    ;for X1/88 ワークエリア
0013CB DA41 5BE6                    DW  _DISKE+1        ;DISKVE($F323)
0013CD DA43 F5E6                    DW  _BREAK+1        ;BREAKV($F325)
                                
       DA45                     CAP:            ;(9)
0013CF DA45 FE61             7      CP  'a'
0013D1 DA47 D8              11      RET C
0013D2 DA48 FE7B             7      CP  'z'+1
0013D4 DA4A D0              11      RET NC
0013D5 DA4B D620             7      SUB 020H
0013D7 DA4D C9              10      RET
                                ;(10)
       DA4E                     CAP2:
0013D8 DA4E CD45DA          17      CALL    CAP
       DA51                     CAP3:               ;
0013DB DA51 FE05             7      CP  5
0013DD DA53 28E9            12      JR  Z,CAP4
0013DF DA55 FE21             7      CP  021H
0013E1 DA57 C9              10      RET
                                                    ;
       DA58                     CHDIR:
0013E2 DA58 CD31E4          17      CALL    GETDPBD
0013E5 DA5B 381D            12      JR  C,CHDIR2
0013E7 DA5D DD751A          19      LD  (IX+DPB_SDIR),L
0013EA DA60 DD741B          19      LD  (IX+DPB_SDIR+1),H
0013ED DA63 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       DA65                     LDDIR:
0013EF DA65 CD31E4          17      CALL    GETDPBD
0013F2 DA68 DD5E1A          19      LD  E,(IX+DPB_SDIR)
0013F5 DA6B DD561B          19      LD  D,(IX+DPB_SDIR+1)
0013F8 DA6E 13               6      INC DE
0013F9 DA6F FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0013FC DA72 FD720F          19      LD  (IY+15),D
0013FF DA75 1B               6      DEC DE
001400 DA76 AF               4      XOR A
001401 DA77 32A0E6          13      LD  (_DIRF),A
       DA7A                     CHDIR2:
001404 DA7A DDE1            14      POP IX
001406 DA7C C9              10      RET
                                
       DA7D                     LDDIRX:
001407 DA7D 3AA0E6          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
00140A DA80 E67F             7      AND 07FH
       DA82                     LDDIRX1:
00140C DA82 3281E1          13      LD  (_SECPS),A
00140F DA85 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
001412 DA88 FD560F          19      LD  D,(IY+15)
001415 DA8B 1B               6      DEC DE
001416 DA8C CD36DA          17      CALL    ENDCL
001419 DA8F D465DA          17      CALL    NC,LDDIR
       DA92                     LDDIRS:
00141C DA92 7A               4      LD  A,D
00141D DA93 B3               4      OR  E
00141E DA94 32A0E6          13      LD  (_DIRF),A   ;ディレクトリか判別
001421 DA97 C9              10      RET
                                
       DA98                     KILL:
001422 DA98 CD60DB          17      CALL    CHKWILDX
001425 DA9B 3834            12      JR  C,KILLW
001427 DA9D CD3BD8          17      CALL    SOPENX
       DAA0                     KILLS:
00142A DAA0 3E1F             7      LD  A,01FH
00142C DAA2 D4E4DA          17      CALL    NC,CHKATT
00142F DAA5 D8              11      RET C
       DAA6                     KILLSX:
001430 DAA6 36E5            10      LD  (HL),0E5H   ;DIR
001432 DAA8 CD3CDB          17      CALL    WTDB
001435 DAAB 111A00          10      LD  DE,01AH
001438 DAAE 19              11      ADD HL,DE
001439 DAAF 5E               7      LD  E,(HL)
00143A DAB0 23               6      INC HL
00143B DAB1 56               7      LD  D,(HL)
       DAB2                     KILLS1:
00143C DAB2 CD36DA          17      CALL    ENDCL
00143F DAB5 D0              11      RET NC      ;CF=0
001440 DAB6 21FEFF          10      LD  HL,0-2
001443 DAB9 19              11      ADD HL,DE
001444 DABA D0              11      RET NC      ;DE= 0 or 1
001445 DABB D5              11      PUSH    DE
001446 DABC CDF7E6          17      CALL    _GNCL
001449 DABF ED53FEE7        20      LD  (_CLPS),DE
00144D DAC3 D1              10      POP DE
00144E DAC4 210000          10      LD  HL,0
001451 DAC7 D4FAE6          17      CALL    NC,_SNCL
001454 DACA D8              11      RET C
001455 DACB ED5BFEE7        20      LD  DE,(_CLPS)  ;FAT
001459 DACF 18E1            12      JR  KILLS1
                                
       DAD1                     KILLW:
00145B DAD1 CD6AD8          17      CALL    SOPEN
       DAD4                     KILLW1:
00145E DAD4 380B            12      JR  C,KILLW2
001460 DAD6 CD09D9          17      CALL    SOPENE2
001463 DAD9 CDA0DA          17      CALL    KILLS
001466 DADC CDCED8          17      CALL    NOPEN
001469 DADF 18F3            12      JR  KILLW1
       DAE1                     KILLW2:
00146B DAE1 C8              11      RET Z
00146C DAE2 3F               4      CCF
00146D DAE3 C9              10      RET
                                
       DAE4                     CHKATT:
00146E DAE4 E5              11      PUSH    HL
00146F DAE5 110B00          10      LD  DE,00BH
001472 DAE8 19              11      ADD HL,DE
001473 DAE9 A6               7      AND (HL)
001474 DAEA E1              10      POP HL
001475 DAEB C8              11      RET Z
001476 DAEC 37               4      SCF
001477 DAED C9              10      RET
                                
       DAEE                     NAME:
001478 DAEE CD60DB          17      CALL    CHKWILDX
00147B DAF1 D8              11      RET C
00147C DAF2 110400          10      LD  DE,4
00147F DAF5 19              11      ADD HL,DE
001480 DAF6 220BDB          16      LD  (NAMEP),HL
001483 DAF9 23               6      INC HL
001484 DAFA CD64DB          17      CALL    CHKWILD
001487 DAFD D8              11      RET C
                                
001488 DAFE CD3BD8          17      CALL    SOPENX
00148B DB01 3E0F             7      LD  A,00FH
00148D DB03 D4E4DA          17      CALL    NC,CHKATT
001490 DB06 D8              11      RET C
                                
001491 DB07 FDE5            15      PUSH    IY
001493 DB09 FD210000        14      LD  IY,0        ;自己書き換え
       DB0B                     NAMEP   EQU $-2
001497 DB0D CD3BD8          17      CALL    SOPENX
00149A DB10 FDE3            23      EX  (SP),IY
00149C DB12 3F               4      CCF
00149D DB13 D46AD8          17      CALL    NC,SOPEN
0014A0 DB16 EB               4      EX  DE,HL
0014A1 DB17 E1              10      POP HL
0014A2 DB18 D8              11      RET C
                                
       DB19                     SETNAME:
0014A3 DB19 01000B          10      LD  BC,11*256
0014A6 DB1C 23               6      INC HL
0014A7 DB1D 7E               7      LD  A,(HL)
0014A8 DB1E FEE5             7      CP  0E5H
0014AA DB20 2004            12      JR  NZ,SNAME1
0014AC DB22 3E05             7      LD  A,5
0014AE DB24 180E            12      JR  SNAME3
       DB26                     SNAME1:
0014B0 DB26 7E               7      LD  A,(HL)
0014B1 DB27 0C               4      INC C
0014B2 DB28 0D               4      DEC C
0014B3 DB29 2009            12      JR  NZ,SNAME3
0014B5 DB2B CD45DA          17      CALL    CAP
0014B8 DB2E FEA0             7      CP  0A0H
0014BA DB30 2002            12      JR  NZ,SNAME3
0014BC DB32 3E20             7      LD  A,020H
       DB34                     SNAME3:
0014BE DB34 12               7      LD  (DE),A
0014BF DB35 7E               7      LD  A,(HL)
0014C0 DB36 23               6      INC HL
0014C1 DB37 CD4DDB          17      CALL    FKAN
0014C4 DB3A 10EA            13      DJNZ    SNAME1
       DB3C                     WTDB:               ;バッファデータが更新された
0014C6 DB3C 3EFF             7      LD  A,0FFH
0014C8 DB3E 3239E6          13      LD  (SFILE),A
0014CB DB41 32A4E6          13      LD  (_WTDBF),A
0014CE DB44 AF               4      XOR A
0014CF DB45 C9              10      RET
                                
       DB46                     FKANC:
0014D0 DB46 CB41             8      BIT 0,C
0014D2 DB48 CC4EDA          17      CALL    Z,CAP2
0014D5 DB4B 1801            12      JR  FKANX
       DB4D                     FKAN:           ;漢字チェック
0014D7 DB4D 13               6      INC DE
       DB4E                     FKANX:
0014D8 DB4E CB41             8      BIT 0,C
0014DA DB50 CB81             8      RES 0,C
0014DC DB52 C0              11      RET NZ
0014DD DB53 FE80             7      CP  080H
0014DF DB55 D8              11      RET C
0014E0 DB56 FEA0             7      CP  0A0H
0014E2 DB58 3803            12      JR  C,FKAN1
0014E4 DB5A FEE0             7      CP  0E0H
0014E6 DB5C D8              11      RET C
       DB5D                     FKAN1:
0014E7 DB5D 0C               4      INC C
0014E8 DB5E A7               4      AND A
0014E9 DB5F C9              10      RET
                                
       DB60                     CHKWILDX:
0014EA DB60 FDE5            15      PUSH    IY
0014EC DB62 E1              10      POP HL
0014ED DB63 23               6      INC HL
       DB64                     CHKWILD:
0014EE DB64 060B             7      LD  B,11
0014F0 DB66 3E3F             7      LD  A,'?'
       DB68                     CHKWIL1:
0014F2 DB68 BE               7      CP  (HL)
0014F3 DB69 23               6      INC HL
0014F4 DB6A 37               4      SCF
0014F5 DB6B C8              11      RET Z
0014F6 DB6C 10FA            13      DJNZ    CHKWIL1
0014F8 DB6E AF               4      XOR A
0014F9 DB6F C9              10      RET
                                
       DB70                     SDIRENT:        ;IY=FCB HL=DIR
0014FA DB70 D5              11      PUSH    DE
0014FB DB71 E5              11      PUSH    HL
0014FC DB72 FDE5            15      PUSH    IY
0014FE DB74 D1              10      POP DE
0014FF DB75 EB               4      EX  DE,HL
001500 DB76 CD19DB          17      CALL    SETNAME
                                ;               Attribute
001503 DB79 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001506 DB7C 12               7      LD  (DE),A
001507 DB7D 13               6      INC DE
                                ;               Reserved
001508 DB7E AF               4      XOR A
001509 DB7F 060A             7      LD  B,10
       DB81                     SDE1:
00150B DB81 12               7      LD  (DE),A
00150C DB82 13               6      INC DE
00150D DB83 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
00150F DB85 21E4E7          10      LD  HL,SDDATA       ;(FCB)更新年月日
001512 DB88 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DB8A                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
001514 DB8A 7E               7      LD  A,(HL)
001515 DB8B 23               6      INC HL
001516 DB8C 3291DB          13      LD  (SDPAT),A
001519 DB8F FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       DB91                     SDPAT   EQU $-1
00151C DB92 12               7      LD  (DE),A
00151D DB93 13               6      INC DE
00151E DB94 10F4            13      DJNZ    SDLOOP
                                
001520 DB96 AF               4      XOR A
001521 DB97 E1              10      POP HL
001522 DB98 D1              10      POP DE
001523 DB99 C9              10      RET
                                
       DB9A                     WOPEN:
001524 DB9A FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001527 DB9D E61F             7      AND 01FH
001529 DB9F 37               4      SCF
00152A DBA0 C0              11      RET NZ
00152B DBA1 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       DBA5                     TOPEN2:
00152F DBA5 AF               4      XOR A
       DBA6                     TOPEN:              ;Initializes the time stamp
001530 DBA6 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
001534 DBAA C9              10      RET
                                
       DBAB                     WRDFX:
001535 DBAB 3A1DDA          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       DBAE                     L_WRFX:
001538 DBAE 1F               4      RRA         ;->CF
001539 DBAF 3806            12      JR  C,E_WRFX
00153B DBB1 CB39             8      SRL C
00153D DBB3 CB1C             8      RR  H       ;CH=CH/2
00153F DBB5 18F7            12      JR  L_WRFX
       DBB7                     E_WRFX:
001541 DBB7 41               4      LD  B,C
001542 DBB8 4C               4      LD  C,H
001543 DBB9 03               6      INC BC
001544 DBBA 3E37             7      LD  A,037H      ;SCF
001546 DBBC 3207E0          13      LD  (DRDN1),A
                                
       DBBF                     WRDF:               ;BCクラスタ分FATを確保する
001549 DBBF 110200          10      LD  DE,2
00154C DBC2 AF               4      XOR A
00154D DBC3 3281E1          13      LD  (_SECPS),A
       DBC6                     WRDF1:
001550 DBC6 C5              11      PUSH    BC
001551 DBC7 D5              11      PUSH    DE
001552 DBC8 CDF7E6          17      CALL    _GNCL
001555 DBCB 381C            12      JR  C,WRDF3
001557 DBCD 7A               4      LD  A,D     ;空いているかチェック
001558 DBCE B3               4      OR  E
001559 DBCF 202A            12      JR  NZ,WRDF4
00155B DBD1 E1              10      POP HL      ;HL=空いているクラスタ
00155C DBD2 E5              11      PUSH    HL
00155D DBD3 ED5BFEE7        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
001561 DBD7 22FEE7          16      LD  (_CLPS),HL
001564 DBDA 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
001565 DBDB B3               4      OR  E
001566 DBDC 2008            12      JR  NZ,WRDF2
001568 DBDE FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
00156B DBE1 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
00156E DBE4 1803            12      JR  WRDF3
       DBE6                     WRDF2:
001570 DBE6 CDFAE6          17      CALL    _SNCL
       DBE9                     WRDF3:
001573 DBE9 D1              10      POP DE
001574 DBEA C1              10      POP BC
001575 DBEB D8              11      RET C
001576 DBEC 0B               6      DEC BC
001577 DBED 78               4      LD  A,B
001578 DBEE B1               4      OR  C
001579 DBEF 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
00157B DBF1 ED5BFEE7        20      LD  DE,(_CLPS)
00157F DBF5 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
001582 DBF8 C3FAE6          10      JP  _SNCL
                                
       DBFB                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
001585 DBFB D1              10      POP DE
001586 DBFC C1              10      POP BC
       DBFD                     WRDF5:
001587 DBFD 13               6      INC DE
001588 DBFE CD36DA          17      CALL    ENDCL
00158B DC01 38C3            12      JR  C,WRDF1
00158D DC03 37               4      SCF
00158E DC04 C9              10      RET
                                
       DC05                     RWXR:
00158F DC05 3AF6DE          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       DC08                     L_RWX:
001592 DC08 1F               4      RRA     ;->CF
001593 DC09 3808            12      JR  C,E_RWX
001595 DC0B CB38             8      SRL B   ;BCH=BCH/2
001597 DC0D CB19             8      RR  C   ;
001599 DC0F CB1C             8      RR  H   ;
00159B DC11 18F5            12      JR  L_RWX
       DC13                     E_RWX:
00159D DC13 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0015A0 DC16 FD561B          19      LD  D,(IY+27)
0015A3 DC19 AF               4      XOR A
0015A4 DC1A 3281E1          13      LD  (_SECPS),A
       DC1D                     RWX1:
0015A7 DC1D ED53FEE7        20      LD  (_CLPS),DE
0015AB DC21 7A               4      LD  A,D
0015AC DC22 B3               4      OR  E
0015AD DC23 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
0015AF DC25 78               4      LD  A,B
0015B0 DC26 B1               4      OR  C
0015B1 DC27 B4               4      OR  H
0015B2 DC28 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
0015B3 DC29 CD89E1          17      CALL    GNCLX
0015B6 DC2C D8              11      RET C
0015B7 DC2D 7C               4      LD  A,H     ;
0015B8 DC2E 25               4      DEC H       ;
0015B9 DC2F B7               4      OR  A       ;DEC BCH
0015BA DC30 2001            12      JR  NZ,RWX2     ;
0015BC DC32 0B               6      DEC BC      ;
       DC33                     RWX2:
0015BD DC33 CD36DA          17      CALL    ENDCL
0015C0 DC36 38E5            12      JR  C,RWX1
       DC38                     SCF_RET:
0015C2 DC38 37               4      SCF
0015C3 DC39 C9              10      RET
                                
       DC3A                     DSKF:
0015C4 DC3A 110000          10      LD  DE,0
       DC3B                     MAXCLP  EQU $-2
0015C7 DC3D 2AACE6          16      LD  HL,(_FAKEFREE)
0015CA DC40 7C               4      LD  A,H
0015CB DC41 B5               4      OR  L
0015CC DC42 2803            12      JR  Z,DSKF1
0015CE DC44 110100          10      LD  DE,1
       DC47                     DSKF1:
0015D1 DC47 D5              11      PUSH    DE
0015D2 DC48 CDF7E6          17      CALL    _GNCL
0015D5 DC4B 380C            12      JR  C,POPSCF
0015D7 DC4D 7A               4      LD  A,D
0015D8 DC4E B3               4      OR  E
0015D9 DC4F 2001            12      JR  NZ,DSKF2
0015DB DC51 23               6      INC HL
       DC52                     DSKF2:
0015DC DC52 D1              10      POP DE
0015DD DC53 1B               6      DEC DE
0015DE DC54 7A               4      LD  A,D
0015DF DC55 B3               4      OR  E
0015E0 DC56 20EF            12      JR  NZ,DSKF1
0015E2 DC58 C9              10      RET
                                
       DC59                     POPSCF:
0015E3 DC59 F1              10      POP AF
0015E4 DC5A 37               4      SCF
0015E5 DC5B C9              10      RET
                                
       DC5C                     SETTMS:
0015E6 DC5C FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
0015E9 DC5F 3C               4      INC A
0015EA DC60 C0              11      RET NZ      ;ファイルが更新されていない
       DC61                     SETTMSX:            ;FCBに日付時刻をセットする
0015EB DC61 CD62D5          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
0015EE DC64 CB25             8      SLA L       ;   *2
0015F0 DC66 CB25             8      SLA L       ;   *4
0015F2 DC68 29              11      ADD HL,HL       ;*2 *8
0015F3 DC69 29              11      ADD HL,HL       ;*4 *16
0015F4 DC6A 29              11      ADD HL,HL       ;*8 *32
0015F5 DC6B 7A               4      LD  A,D
0015F6 DC6C 0F               4      RRCA            ;bit.0->7->->->0->C
0015F7 DC6D E61F             7      AND 01FH
0015F9 DC6F B5               4      OR  L
0015FA DC70 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
0015FD DC73 FD7417          19      LD  (IY+23),H
                                
001600 DC76 CD12D5          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
001603 DC79 0144F8          10      LD  BC,0-1980
001606 DC7C 09              11      ADD HL,BC
001607 DC7D 65               4      LD  H,L
                                
001608 DC7E 7A               4      LD  A,D
001609 DC7F 87               4      ADD A,A     ;*2
00160A DC80 87               4      ADD A,A     ;*4
00160B DC81 87               4      ADD A,A     ;*8
00160C DC82 87               4      ADD A,A     ;*16
00160D DC83 6F               4      LD  L,A
00160E DC84 29              11      ADD HL,HL       ;*32
00160F DC85 7D               4      LD  A,L
001610 DC86 B3               4      OR  E
001611 DC87 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
001614 DC8A FD7415          19      LD  (IY+21),H
001617 DC8D C9              10      RET
                                ;(16)
       DC8E                     PUSHRR:
001618 DC8E 32BADF          13      LD  (SETSEQ_SWC_RND),A
00161B DC91 22CCDF          16      LD  (SETSEQ_SWC_SEQ_RR),HL
00161E DC94 CDB4DC          17      CALL    GET_RR_AHL
001621 DC97 220FE6          16      LD  (RR_BUF_HL),HL
001624 DC9A 3211E6          13      LD  (RR_BUF_A),A
001627 DC9D C9              10      RET
                                ;(14)
       DC9E                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
001628 DC9E 87               4      ADD A,A     ;in BHLA => out AHL
001629 DC9F ED6A            15      ADC HL,HL
00162B DCA1 CB18             8      RR  B
00162D DCA3 B7               4      OR  A
00162E DCA4 78               4      LD  A,B     ;ここでフラグは変化しない
00162F DCA5 C8              11      RET Z
001630 DCA6 2C               4      INC L       ;INC AHL
001631 DCA7 C0              11      RET NZ      ;
001632 DCA8 24               4      INC H       ;
001633 DCA9 C0              11      RET NZ      ;
001634 DCAA 3C               4      INC A       ;
001635 DCAB C9              10      RET
                                ;(18)
       DCAC                     INIT_RND:
001636 DCAC 3ECD             7      LD  A,0CDH      ;CALL ????
001638 DCAE 21CBDC          10      LD  HL,POPRR
00163B DCB1 CD8EDC          17      CALL    PUSHRR
       DCB4                     GET_RR_AHL:
00163E DCB4 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001641 DCB7 FD6622          19      LD  H,(IY+34)   ;
001644 DCBA FD7E23          19      LD  A,(IY+35)   ;
001647 DCBD C9              10      RET
                                ;(10)
       DCBE                     SET_RR_AHL:
001648 DCBE FD7521          19      LD  (IY+33),L   ;(FCB)Random record
00164B DCC1 FD7422          19      LD  (IY+34),H   ;
00164E DCC4 FD7723          19      LD  (IY+35),A   ;
001651 DCC7 C9              10      RET
                                ;(17)
       DCC8                     SETSEQ:
001652 DCC8 CDEDDC          17      CALL    SETSEQ1
       DCCB                     POPRR:
001655 DCCB F5              11      PUSH    AF
001656 DCCC E5              11      PUSH    HL
001657 DCCD 2A0FE6          16      LD  HL,(RR_BUF_HL)
00165A DCD0 3A11E6          13      LD  A,(RR_BUF_A)
00165D DCD3 CDBEDC          17      CALL    SET_RR_AHL
001660 DCD6 E1              10      POP HL
001661 DCD7 F1              10      POP AF
001662 DCD8 C9              10      RET
                                ;(20)
       DCD9                     GET_RR_BCDE:            ;BCDE=Random record
001663 DCD9 FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
001666 DCDC FD5622          19      LD  D,(IY+34)
001669 DCDF FD4E23          19      LD  C,(IY+35)
00166C DCE2 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
00166E DCE4 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001672 DCE8 C0              11      RET NZ
001673 DCE9 FD4624          19      LD  B,(IY+36)
001676 DCEC C9              10      RET
                                
       DCED                     SETSEQ1:
001677 DCED F5              11      PUSH    AF
001678 DCEE E5              11      PUSH    HL      ;AHL=Random record
001679 DCEF CDB4DC          17      CALL    GET_RR_AHL
00167C DCF2 47               4      LD  B,A     ;AHL→HLA
00167D DCF3 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
00167E DCF4 6C               4      LD  L,H     ;(IY+34)
00167F DCF5 60               4      LD  H,B     ;(IY+35)
001680 DCF6 0600             7      LD  B,0
                                
001682 DCF8 CD9EDC          17      CALL    GET_CPM_R_SIZE
                                
001685 DCFB 29              11      ADD HL,HL
001686 DCFC CB3D             8      SRL L       ;L=L/2
001688 DCFE FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
00168B DD01 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
00168E DD04 E1              10      POP HL
00168F DD05 F1              10      POP AF
001690 DD06 C9              10      RET
                                
                                ;(23)
       DD07                     RBXEND:             ;レコード数だけランダムレコードを進める
001691 DD07 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       DD08                     RBSIZE  EQU $-2
001694 DD0A CDB4DC          17      CALL    GET_RR_AHL
001697 DD0D 19              11      ADD HL,DE
001698 DD0E CE00             7      ADC A,0
00169A DD10 CDBEDC          17      CALL    SET_RR_AHL
00169D DD13 EB               4      EX  DE,HL       ;HL=進めるレコード数
00169E DD14 D0              11      RET NC
00169F DD15 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0016A3 DD19 C0              11      RET NZ
0016A4 DD1A FD3424          23      INC (IY+36)
0016A7 DD1D C9              10      RET
       DD1E                     FILE_E:
                                
       D8C8                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       D8C8                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       D8C8                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       D8C8                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       D8C8                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       DD1E                     _SYS26:     ;(BDOS)ランダムブロック書き込み
0016A8 DD1E AF               4      XOR A
0016A9 DD1F 3207E0          13      LD  (DRDN1),A   ;NOP
0016AC DD22 2208DD          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
0016AF DD25 225DE6          16      LD  (LEFTX),HL
0016B2 DD28 CD11D8          17      CALL    SETDRV
                                
0016B5 DD2B CD91DE          17      CALL    RBX0
0016B8 DD2E DABBDD          10      JP  C,RBWERR
0016BB DD31 CD9ADB          17      CALL    WOPEN
0016BE DD34 DABBDD          10      JP  C,RBWERR
0016C1 DD37 7C               4      LD  A,H
0016C2 DD38 B5               4      OR  L
0016C3 DD39 CAB4DD          10      JP  Z,RBW1
                                
0016C6 DD3C 2B               6      DEC HL
                                
0016C7 DD3D CDD9DC          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0016CA DD40 19              11      ADD HL,DE       ;BCHL=HL+BCDE
0016CB DD41 3001            12      JR  NC,S26X1    ;
0016CD DD43 03               6      INC BC      ;
       DD44                     S26X1:
0016CE DD44 CD05DC          17      CALL    RWXR
0016D1 DD47 DCABDB          17      CALL    C,WRDFX
0016D4 DD4A DABBDD          10      JP  C,RBWERR
                                
0016D7 DD4D CDC0DE          17      CALL    RBX2
0016DA DD50 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
0016DC DD52 CDDFDE          17      CALL    RBXA
0016DF DD55 3864            12      JR  C,RBWERR
0016E1 DD57 EB               4      EX  DE,HL
0016E2 DD58 C5              11      PUSH    BC
0016E3 DD59 EDB0                    LDIR
0016E5 DD5B 225FE6          16      LD  (DTAX),HL
                                
0016E8 DD5E CD3CDB          17      CALL    WTDB        ;バッファデータは更新された
                                
0016EB DD61 2A5DE6          16      LD  HL,(LEFTX)
0016EE DD64 D1              10      POP DE
0016EF DD65 ED52            15      SBC HL,DE
0016F1 DD67 225DE6          16      LD  (LEFTX),HL
0016F4 DD6A 2831            12      JR  Z,RBWEND
                                
       DD6C                     RBWB:
0016F6 DD6C CD14DF          17      CALL    RBXB
0016F9 DD6F 2814            12      JR  Z,RBWC
       DD71                     RBWB1:
0016FB DD71 C5              11      PUSH    BC
0016FC DD72 D5              11      PUSH    DE
0016FD DD73 CD19DA          17      CALL    CLUSTX
001700 DD76 CD38DF          17      CALL    DWTC
001703 DD79 D1              10      POP DE
001704 DD7A C1              10      POP BC
001705 DD7B D489E1          17      CALL    NC,GNCLX
001708 DD7E 383B            12      JR  C,RBWERR
00170A DD80 10EF            13      DJNZ    RBWB1
00170C DD82 CD88DF          17      CALL    DRW_FLUSH
       DD85                     RBWC:
00170F DD85 CD2CDF          17      CALL    RBXC
001712 DD88 2813            12      JR  Z,RBWEND
001714 DD8A C5              11      PUSH    BC
001715 DD8B CD19DA          17      CALL    CLUSTX
001718 DD8E CD06E0          17      CALL    DRDN
00171B DD91 C1              10      POP BC
00171C DD92 3827            12      JR  C,RBWERR
00171E DD94 ED5B7EE7        20      LD  DE,(_DTBUF)
001722 DD98 EDB0                    LDIR
001724 DD9A CD3CDB          17      CALL    WTDB        ;バッファデータは更新された
       DD9D                     RBWEND:
001727 DD9D CD07DD          17      CALL    RBXEND
                                
00172A DDA0 CDA0DE          17      CALL    RBX1
00172D DDA3 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
00172F DDA5 CDD9DC          17      CALL    GET_RR_BCDE ;BCDE=Random record
001732 DDA8 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
001735 DDAB FD7211          19      LD  (IY+17),D   ;
001738 DDAE FD7112          19      LD  (IY+18),C   ;
00173B DDB1 FD7013          19      LD  (IY+19),B   ;
       DDB4                     RBW1:
00173E DDB4 FDE1            14      POP IY
001740 DDB6 C1              10      POP BC
001741 DDB7 D1              10      POP DE
001742 DDB8 E1              10      POP HL
       DDB9                     DD_NUL:
001743 DDB9 AF               4      XOR A
       DDBA                     DRDF0:
       DDBA                     DWTF0:
001744 DDBA C9              10      RET
                                
       DDBB                     RBWERR:
001745 DDBB FDE5            15      PUSH    IY
001747 DDBD D1              10      POP DE
001748 DDBE 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
00174A DDC0 CDD9D0          17      CALL    BDOS0
       DDC3                     RBRERR1:
00174D DDC3 3E01             7      LD  A,001H
       DDC5                     RBRERR2:
00174F DDC5 FDE1            14      POP IY
001751 DDC7 C1              10      POP BC
001752 DDC8 D1              10      POP DE
001753 DDC9 E1              10      POP HL
001754 DDCA 37               4      SCF
001755 DDCB 210000          10      LD  HL,0
001758 DDCE C9              10      RET
                                
       DDCF                     RBRERR:
001759 DDCF 3EFF             7      LD  A,0FFH
00175B DDD1 18F2            12      JR  RBRERR2
                                
       DDD3                     RBRFL:
00175D DDD3 3E00             7  RBRFLP: LD  A,000H
00175F DDD5 FE0D             7      CP  00DH
001761 DDD7 2005            12      JR  NZ,RBRFL1
001763 DDD9 D5              11      PUSH    DE
001764 DDDA 1E0A             7      LD  E,00AH
001766 DDDC 1805            12      JR  RBRFL2
       DDDE                     RBRFL1:
001768 DDDE D5              11      PUSH    DE
001769 DDDF CD09E6          17      CALL    _SYS07
00176C DDE2 5F               4      LD  E,A
       DDE3                     RBRFL2:
00176D DDE3 CDCDE6          17      CALL    _PRINT
001770 DDE6 7B               4      LD  A,E
001771 DDE7 D1              10      POP DE
001772 DDE8 32D4DD          13      LD  (RBRFLP+1),A
001775 DDEB C9              10      RET
                                
                                                ;Read random block
       DDEC                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001776 DDEC 225DE6          16      LD  (LEFTX),HL
001779 DDEF CD11D8          17      CALL    SETDRV
                                
00177C DDF2 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
001780 DDF6 C27FDE          10      JP  NZ,RBRDIR   ;ディレクトリ
001783 DDF9 CD91DE          17      CALL    RBX0
001786 DDFC DACFDD          10      JP  C,RBRERR
001789 DDFF CDA0DE          17      CALL    RBX1
00178C DE02 D4B8DE          17      CALL    NC,RBX1R
00178F DE05 DAC3DD          10      JP  C,RBRERR1
001792 DE08 EB               4      EX  DE,HL
001793 DE09 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
001795 DE0B 19              11      ADD HL,DE
001796 DE0C 79               4      LD  A,C
001797 DE0D DE00             7      SBC A,0
001799 DE0F 78               4      LD  A,B
00179A DE10 DE00             7      SBC A,0
00179C DE12 3801            12      JR  C,RBR1
00179E DE14 EB               4      EX  DE,HL
       DE15                     RBR1:
00179F DE15 9F               4      SBC A,A
0017A0 DE16 E601             7      AND 1
0017A2 DE18 327DDE          13      LD  (RBRA_SWC),A
                                
0017A5 DE1B 7C               4      LD  A,H
0017A6 DE1C B5               4      OR  L
0017A7 DE1D 2857            12      JR  Z,RBREND0
                                
0017A9 DE1F 2208DD          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
0017AC DE22 225DE6          16      LD  (LEFTX),HL
                                
0017AF DE25 CDC0DE          17      CALL    RBX2
0017B2 DE28 2819            12      JR  Z,RBRB
0017B4 DE2A CDDFDE          17      CALL    RBXA
0017B7 DE2D DACFDD          10      JP  C,RBRERR
0017BA DE30 C5              11      PUSH    BC
0017BB DE31 EDB0                    LDIR
0017BD DE33 ED535FE6        20      LD  (DTAX),DE
0017C1 DE37 2A5DE6          16      LD  HL,(LEFTX)
0017C4 DE3A D1              10      POP DE
0017C5 DE3B A7               4      AND A
0017C6 DE3C ED52            15      SBC HL,DE
0017C8 DE3E 225DE6          16      LD  (LEFTX),HL
0017CB DE41 2830            12      JR  Z,RBREND
                                
       DE43                     RBRB:
0017CD DE43 CD14DF          17      CALL    RBXB
0017D0 DE46 2815            12      JR  Z,RBRC
       DE48                     RBRB1:
0017D2 DE48 C5              11      PUSH    BC
0017D3 DE49 D5              11      PUSH    DE
0017D4 DE4A CD19DA          17      CALL    CLUSTX
0017D7 DE4D CD3EDF          17      CALL    DRDC
0017DA DE50 D1              10      POP DE
0017DB DE51 C1              10      POP BC
0017DC DE52 D489E1          17      CALL    NC,GNCLX
0017DF DE55 DACFDD          10      JP  C,RBRERR
0017E2 DE58 10EE            13      DJNZ    RBRB1
0017E4 DE5A CD88DF          17      CALL    DRW_FLUSH
       DE5D                     RBRC:
0017E7 DE5D CD2CDF          17      CALL    RBXC
0017EA DE60 2811            12      JR  Z,RBREND
0017EC DE62 C5              11      PUSH    BC
0017ED DE63 CD19DA          17      CALL    CLUSTX
0017F0 DE66 CDEADF          17      CALL    DRDX
0017F3 DE69 C1              10      POP BC
0017F4 DE6A DACFDD          10      JP  C,RBRERR
0017F7 DE6D EB               4      EX  DE,HL
0017F8 DE6E 2A7EE7          16      LD  HL,(_DTBUF)
0017FB DE71 EDB0                    LDIR
       DE73                     RBREND:
0017FD DE73 CD07DD          17      CALL    RBXEND
       DE76                     RBREND0:
001800 DE76 FDE1            14      POP IY
001802 DE78 C1              10      POP BC
001803 DE79 D1              10      POP DE
001804 DE7A F1              10      POP AF  ;(HL)
001805 DE7B AF               4      XOR A
001806 DE7C 3E00             7      LD  A,000H
       DE7D                     RBRA_SWC    EQU $-1
001808 DE7E C9              10      RET
                                
       DE7F                     RBRDIR:
001809 DE7F FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
00180C DE82 FD661B          19      LD  H,(IY+27)
00180F DE85 CD58DA          17      CALL    CHDIR
001812 DE88 AF               4      XOR A
001813 DE89 67               4      LD  H,A
001814 DE8A 6F               4      LD  L,A
001815 DE8B 3C               4      INC A
001816 DE8C 327DDE          13      LD  (RBRA_SWC),A
001819 DE8F 18E5            12      JR  RBREND0
                                ;(15)
       DE91                     RBX0:
00181B DE91 2A8AE6          16      LD  HL,(_DTA)
00181E DE94 225FE6          16      LD  (DTAX),HL
001821 DE97 2A5DE6          16      LD  HL,(LEFTX)
001824 DE9A FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
001827 DE9D D6FD             7      SUB 0FDH
001829 DE9F C9              10      RET
                                
       DEA0                     RBX1:               ;ファイルサイズとランダムレコードを比べる
00182A DEA0 E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
00182B DEA1 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
00182E DEA4 FD6611          19      LD  H,(IY+17)   ;
001831 DEA7 FD7E12          19      LD  A,(IY+18)   ;
                                
001834 DEAA CDD9DC          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001837 DEAD A7               4      AND A
001838 DEAE ED52            15      SBC HL,DE
00183A DEB0 99               4      SBC A,C
00183B DEB1 4F               4      LD  C,A
00183C DEB2 FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
00183F DEB5 98               4      SBC A,B
001840 DEB6 D1              10      POP DE
001841 DEB7 C9              10      RET
       DEB8                     RBX1R:              ;(8)
001842 DEB8 47               4      LD  B,A
001843 DEB9 B1               4      OR  C
001844 DEBA EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
001845 DEBB B2               4      OR  D
001846 DEBC B3               4      OR  E
001847 DEBD C0              11      RET NZ
001848 DEBE 37               4      SCF
001849 DEBF C9              10      RET
                                
       DEC0                     RBX2:               ;Cluster settings
00184A DEC0 FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
00184D DEC3 FD4E23          19      LD  C,(IY+35)
001850 DEC6 0600             7      LD  B,0
001852 DEC8 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001856 DECC 2003            12      JR  NZ,RBX3
001858 DECE FD4624          19      LD  B,(IY+36)
       DED1                     RBX3:
00185B DED1 CD05DC          17      CALL    RWXR
00185E DED4 3AF6DE          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001861 DED7 3D               4      DEC A
001862 DED8 FDA622          19      AND (IY+34)
001865 DEDB FDB621          19      OR  (IY+33)
001868 DEDE C9              10      RET
                                
       DEDF                     RBXA:
001869 DEDF C5              11      PUSH    BC
00186A DEE0 D5              11      PUSH    DE
00186B DEE1 CD19DA          17      CALL    CLUSTX
00186E DEE4 CDEADF          17      CALL    DRDX
001871 DEE7 D1              10      POP DE
001872 DEE8 C1              10      POP BC
001873 DEE9 D489E1          17      CALL    NC,GNCLX
001876 DEEC D8              11      RET C
001877 DEED ED53FEE7        20      LD  (_CLPS),DE
                                
00187B DEF1 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
00187E DEF4 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       DEF5                     SECSZ   EQU $-2
       DEF6                     SECSZ_H EQU $-1
001881 DEF7 7C               4      LD  A,H
001882 DEF8 3D               4      DEC A       ;1024=3 / 512=1
001883 DEF9 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
001886 DEFC 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
001887 DEFD ED42            15      SBC HL,BC       ;残りを計算
                                
001889 DEFF ED5B5DE6        20      LD  DE,(LEFTX)
00188D DF03 ED52            15      SBC HL,DE       ;CP HL,DE
00188F DF05 19              11      ADD HL,DE       ;
001890 DF06 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
001892 DF08 EB               4      EX  DE,HL
       DF09                     RBXA1:
001893 DF09 E5              11      PUSH    HL
001894 DF0A 2A7EE7          16      LD  HL,(_DTBUF)
001897 DF0D 09              11      ADD HL,BC
001898 DF0E ED5B5FE6        20      LD  DE,(DTAX)
00189C DF12 C1              10      POP BC
00189D DF13 C9              10      RET
                                
       DF14                     RBXB:
00189E DF14 2A5FE6          16      LD  HL,(DTAX)
0018A1 DF17 ED5BFEE7        20      LD  DE,(_CLPS)
0018A5 DF1B 3A5EE6          13      LD  A,(LEFTX+1)
0018A8 DF1E 47               4      LD  B,A
0018A9 DF1F 3AF6DE          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       DF22                     RBXB1:
0018AC DF22 1F               4      RRA     ;->CF
0018AD DF23 3804            12      JR  C,RBXB2
0018AF DF25 CB38             8      SRL B   ;B=B/2
0018B1 DF27 18F9            12      JR  RBXB1
       DF29                     RBXB2:
0018B3 DF29 78               4      LD  A,B
0018B4 DF2A B7               4      OR  A
0018B5 DF2B C9              10      RET
                                ;(12)
       DF2C                     RBXC:
0018B6 DF2C ED4B5DE6        20      LD  BC,(LEFTX)
0018BA DF30 3AF6DE          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
0018BD DF33 3D               4      DEC A
0018BE DF34 A0               4      AND B
0018BF DF35 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
0018C0 DF36 B1               4      OR  C
0018C1 DF37 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       DF38                     DWTC:
0018C2 DF38 E5              11      PUSH    HL
0018C3 DF39 2122E3          10      LD  HL,DWT24B
0018C6 DF3C 1804            12      JR  DWTC1
       DF3E                     DRDC:
0018C8 DF3E E5              11      PUSH    HL
0018C9 DF3F 2114E3          10      LD  HL,DRD24B
       DF42                     DWTC1:
0018CC DF42 229CDF          16      LD  (DRWF_MODE),HL
0018CF DF45 E1              10      POP HL
0018D0 DF46 3A8CDF          13      LD  A,(DRWF_B)
0018D3 DF49 B7               4      OR  A
0018D4 DF4A 200F            12      JR  NZ,DRDC1
       DF4C                     SAVE_DRWC:
0018D6 DF4C 0601             7      LD  B,1
0018D8 DF4E ED438BDF        20      LD  (DRWF_C),BC
0018DC DF52 ED5392DF        20      LD  (DRWF_E),DE
0018E0 DF56 2295DF          16      LD  (DRWF_HL),HL
0018E3 DF59 1820            12      JR  INC_HL_DRWC
       DF5B                     DRDC1:
0018E5 DF5B E5              11      PUSH    HL
0018E6 DF5C 2192DF          10      LD  HL,DRWF_E
0018E9 DF5F 86               7      ADD A,(HL)
0018EA DF60 F5              11      PUSH    AF
0018EB DF61 BB               4      CP  E
0018EC DF62 201D            12      JR  NZ,DRDC2
0018EE DF64 F1              10      POP AF
0018EF DF65 23               6      INC HL
0018F0 DF66 7E               7      LD  A,(HL)
0018F1 DF67 CE00             7      ADC A,0
0018F3 DF69 F5              11      PUSH    AF
0018F4 DF6A BA               4      CP  D
0018F5 DF6B 2014            12      JR  NZ,DRDC2
0018F7 DF6D F1              10      POP AF
0018F8 DF6E 3A8BDF          13      LD  A,(DRWF_C)
0018FB DF71 CE00             7      ADC A,0
0018FD DF73 B9               4      CP  C
0018FE DF74 200C            12      JR  NZ,DRDC3
001900 DF76 218CDF          10      LD  HL,DRWF_B
001903 DF79 34              11      INC (HL)
001904 DF7A E1              10      POP HL
       DF7B                     INC_HL_DRWC:
001905 DF7B 3AF6DE          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
001908 DF7E 84               4      ADD A,H
001909 DF7F 67               4      LD  H,A
00190A DF80 C9              10      RET
       DF81                     DRDC2:
00190B DF81 F1              10      POP AF
       DF82                     DRDC3:
00190C DF82 CD88DF          17      CALL    DRW_FLUSH
00190F DF85 E1              10      POP HL
001910 DF86 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       DF88                     DRW_FLUSH:
001912 DF88 C5              11      PUSH    BC
001913 DF89 D5              11      PUSH    DE
001914 DF8A 010000          10      LD  BC,0
       DF8B                     DRWF_C  EQU $-2
       DF8C                     DRWF_B  EQU $-1
001917 DF8D 78               4      LD  A,B
001918 DF8E B7               4      OR  A
001919 DF8F 280D            12      JR  Z,DRDF1
00191B DF91 110000          10      LD  DE,0
       DF92                     DRWF_E  EQU $-2
       DF93                     DRWF_D  EQU $-1
00191E DF94 210000          10      LD  HL,0
       DF95                     DRWF_HL EQU $-2
001921 DF97 AF               4      XOR A
001922 DF98 328CDF          13      LD  (DRWF_B),A
001925 DF9B CD14E3          17      CALL    DRD24B
       DF9C                     DRWF_MODE   EQU $-2
       DF9E                     DRDF1:
001928 DF9E D1              10      POP DE
001929 DF9F C1              10      POP BC
00192A DFA0 C9              10      RET
                                
       DFA1                     RB_WRITE:
00192B DFA1 C5              11      PUSH    BC
00192C DFA2 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
00192E DFA4 1803            12      JR  RBRW
       DFA6                     RB_READ:
001930 DFA6 C5              11      PUSH    BC
001931 DFA7 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       DFA9                     RBRW:
001933 DFA9 1F               4      RRA     ;AHL = AHL*128
001934 DFAA 7C               4      LD  A,H ;AHL = AHL0/2
001935 DFAB 1F               4      RRA     ;A
001936 DFAC 65               4      LD  H,L ;
001937 DFAD CB1C             8      RR  H   ;H
001939 DFAF 2E00             7      LD  L,0 ;
00193B DFB1 CB1D             8      RR  L   ;L
00193D DFB3 CDBEDC          17      CALL    SET_RR_AHL
001940 DFB6 218000          10      LD  HL,128
001943 DFB9 C5              11      PUSH    BC
       DFBA                     SETSEQ_SWC_RND:
001944 DFBA CDEDDC          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
001947 DFBD C1              10      POP BC
001948 DFBE FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
00194C DFC2 FDE5            15      PUSH    IY
00194E DFC4 D1              10      POP DE
00194F DFC5 D5              11      PUSH    DE
001950 DFC6 CDD9D0          17      CALL    BDOS0
001953 DFC9 FDE1            14      POP IY
001955 DFCB CDC8DC          17      CALL    SETSEQ      ;SETSEQ or POPRR
       DFCC                     SETSEQ_SWC_SEQ_RR   EQU $-2
001958 DFCE FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
00195C DFD2 C1              10      POP BC
00195D DFD3 C9              10      RET
                                
                                ;(22)
       DFD4                     INIT_SEQ:
00195E DFD4 3E01             7      LD  A,1     ;LD BC,????
001960 DFD6 21C8DC          10      LD  HL,SETSEQ
001963 DFD9 CD8EDC          17      CALL    PUSHRR
       DFDC                     GETSEQ:
001966 DFDC FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
001969 DFDF FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
00196C DFE2 AF               4      XOR A
                                
00196D DFE3 CB25             8      SLA L   ;L=L*2
                                
00196F DFE5 CB3C             8      SRL H   ;HL=HL/2
001971 DFE7 CB1D             8      RR  L   ;
001973 DFE9 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       DFEA                     DRDX:
001974 DFEA CD28E0          17      CALL    DRDY
001977 DFED C8              11      RET Z
001978 DFEE CD0EE0          17      CALL    DRDX1       ;データバッファの情報を保存
00197B DFF1 D8              11      RET C
00197C DFF2 E5              11      PUSH    HL
00197D DFF3 C5              11      PUSH    BC
00197E DFF4 D5              11      PUSH    DE
00197F DFF5 2A7EE7          16      LD  HL,(_DTBUF)
001982 DFF8 3A51E0          13      LD  A,(_DBS24)
001985 DFFB 4F               4      LD  C,A
001986 DFFC CD12E3          17      CALL    DRD24
001989 DFFF DC23E0          17      CALL    C,DRDNE
       E002                     POP_DE_BC_HL_RET:
00198C E002 D1              10      POP DE
00198D E003 C1              10      POP BC
00198E E004 E1              10      POP HL
00198F E005 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E006                     DRDN:
001990 E006 AF               4      XOR A
001991 E007 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
001992 E008 30E0            12      JR  NC,DRDX
       E00A                     DRDNX:
001994 E00A CD28E0          17      CALL    DRDY
001997 E00D C8              11      RET Z
       E00E                     DRDX1:
001998 E00E CD3EE0          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
00199B E011 ED53A6E6        20      LD  (_DBSEC),DE
00199F E015 79               4      LD  A,C
0019A0 E016 3251E0          13      LD  (_DBS24),A
                                
0019A3 E019 3A88E6          13      LD  A,(_DRV)
0019A6 E01C 32A5E6          13      LD  (_DBDRV),A
0019A9 E01F CDD9E6          17      CALL    _CHGDRV
0019AC E022 D0              11      RET NC
       E023                     DRDNE:
0019AD E023 9F               4      SBC A,A     ;CF=1ならばA=0FFH
0019AE E024 32A5E6          13      LD  (_DBDRV),A
0019B1 E027 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E028                     DRDY:
0019B2 E028 3A51E0          13      LD  A,(_DBS24)
0019B5 E02B B9               4      CP  C
0019B6 E02C C0              11      RET NZ
                                
0019B7 E02D E5              11      PUSH    HL
0019B8 E02E 3A88E6          13      LD  A,(_DRV)
0019BB E031 21A5E6          10      LD  HL,_DBDRV
0019BE E034 AE               7      XOR (HL)
0019BF E035 2005            12      JR  NZ,POP_HL_RET
                                
0019C1 E037 2AA6E6          16      LD  HL,(_DBSEC)
0019C4 E03A ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E03C                     POP_HL_RET:
0019C6 E03C E1              10      POP HL
0019C7 E03D C9              10      RET
                                
       E03E                     DWTX:
0019C8 E03E 3AA4E6          13      LD  A,(_WTDBF)
0019CB E041 B7               4      OR  A
0019CC E042 C8              11      RET Z
0019CD E043 AF               4      XOR A
0019CE E044 32A4E6          13      LD  (_WTDBF),A
                                
0019D1 E047 E5              11      PUSH    HL
0019D2 E048 C5              11      PUSH    BC
0019D3 E049 D5              11      PUSH    DE
0019D4 E04A 3AA5E6          13      LD  A,(_DBDRV)
0019D7 E04D CDD9E6          17      CALL    _CHGDRV
0019DA E050 0E00             7      LD  C,0
       E051                     _DBS24  EQU $-1
0019DC E052 ED5BA6E6        20      LD  DE,(_DBSEC)
0019E0 E056 2A7EE7          16      LD  HL,(_DTBUF)
0019E3 E059 D420E3          17      CALL    NC,DWT24
       E05C                     POP_DE_BC_HL_RET2:
0019E6 E05C 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E05E                     RDFATX:
0019E8 E05E E5              11      PUSH    HL
0019E9 E05F 3A88E6          13      LD  A,(_DRV)
0019EC E062 21AAE6          10      LD  HL,_FATDRV
0019EF E065 AE               7      XOR (HL)
0019F0 E066 28D4            12      JR  Z,POP_HL_RET
                                
0019F2 E068 C5              11      PUSH    BC
0019F3 E069 D5              11      PUSH    DE
0019F4 E06A DDE5            15      PUSH    IX
0019F6 E06C CD88E0          17      CALL    WTFATX
0019F9 E06F 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
0019FB E071 AF               4      XOR A
0019FC E072 32ABE6          13      LD  (_FATIX),A
0019FF E075 3A88E6          13      LD  A,(_DRV)
001A02 E078 32AAE6          13      LD  (_FATDRV),A
001A05 E07B CDE5E6          17      CALL    _RDFAT
       E07E                     RDFATE2:
001A08 E07E 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
001A0A E080 9F               4      SBC A,A     ;A=0xFF
001A0B E081 32AAE6          13      LD  (_FATDRV),A
       E084                     POP_IX_DE_BC_HL_RET:
001A0E E084 DDE1            14      POP IX
001A10 E086 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E088                     WTFATX:
001A12 E088 3AA2E6          13      LD  A,(_WTFATF)
001A15 E08B B7               4      OR  A
001A16 E08C C8              11      RET Z
001A17 E08D AF               4      XOR A
001A18 E08E 32A2E6          13      LD  (_WTFATF),A
                                
001A1B E091 E5              11      PUSH    HL
001A1C E092 3AAAE6          13      LD  A,(_FATDRV)
001A1F E095 21A5E6          10      LD  HL,_DBDRV
001A22 E098 AE               7      XOR (HL)
001A23 E099 CC3EE0          17      CALL    Z,DWTX
001A26 E09C 389E            12      JR  C,POP_HL_RET
001A28 E09E C5              11      PUSH    BC
001A29 E09F D5              11      PUSH    DE
001A2A E0A0 DDE5            15      PUSH    IX
001A2C E0A2 CD31E3          17      CALL    FATSETUP
001A2F E0A5 D422E3          17      CALL    NC,DWT24B
001A32 E0A8 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E0AA                     N16CL1:
001A34 E0AA 7A               4      LD  A,D
001A35 E0AB B3               4      OR  E
001A36 E0AC 37               4      SCF
001A37 E0AD C8              11      RET Z
                                
001A38 E0AE 7A               4      LD  A,D
001A39 E0AF 1807            12      JR  NCL1X
       E0B1                     NCL1:
001A3B E0B1 7A               4      LD  A,D
001A3C E0B2 B3               4      OR  E
001A3D E0B3 37               4      SCF
001A3E E0B4 C8              11      RET Z
                                
001A3F E0B5 7A               4      LD  A,D
001A40 E0B6 CB3F             8      SRL A   ;/2
       E0B8                     NCL1X:
001A42 E0B8 CB3F             8      SRL A   ;/2
                                
001A44 E0BA E5              11      PUSH    HL
001A45 E0BB 32DAE0          13      LD  (NCLPAT_FATIX),A    ;_FATIX
001A48 E0BE 2AAAE6          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001A4B E0C1 BC               4      CP  H
001A4C E0C2 3A88E6          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001A4F E0C5 32D9E0          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001A52 E0C8 2005            12      JR  NZ,NCL2     ;FATIXが違う
001A54 E0CA BD               4      CP  L
001A55 E0CB 2002            12      JR  NZ,NCL2     ;ドライブが違う
001A57 E0CD E1              10      POP HL
001A58 E0CE C9              10      RET
       E0CF                     NCL2:
001A59 E0CF C5              11      PUSH    BC
001A5A E0D0 D5              11      PUSH    DE
001A5B E0D1 DDE5            15      PUSH    IX
001A5D E0D3 CD88E0          17      CALL    WTFATX
001A60 E0D6 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
001A62 E0D8 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E0DA                     NCLPAT_FATIX    EQU $-1
       E0D9                     NCLPAT_FATDRV   EQU $-2
001A65 E0DB ED43AAE6        20      LD  (_FATDRV),BC
001A69 E0DF CD06E3          17      CALL    RDFATS
001A6C E0E2 189A            12      JR  RDFATE2
                                
       E0E4                     NCL3:
001A6E E0E4 CB9A             8      RES 3,D
001A70 E0E6 CB92             8      RES 2,D
001A72 E0E8 6B               4      LD  L,E
001A73 E0E9 62               4      LD  H,D
001A74 E0EA CB3C             8      SRL H   ;
001A76 E0EC CB1D             8      RR  L   ;HLA=HLA/2
001A78 E0EE 1F               4      RRA     ;
001A79 E0EF F5              11      PUSH    AF
001A7A E0F0 3AABE6          13      LD  A,(_FATIX)
001A7D E0F3 0F               4      RRCA
001A7E E0F4 300B            12      JR  NC,NCL3X1
001A80 E0F6 3AF6DE          13      LD  A,(SECSZ_H)
001A83 E0F9 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの際に先頭を512バイトずらす
001A85 E0FB 2004            12      JR  NZ,NCL3X1
001A87 E0FD 010002          10      LD  BC,512
001A8A E100 09              11      ADD HL,BC
       E101                     NCL3X1:
001A8B E101 F1              10      POP AF
001A8C E102 ED4B7CE7        20      LD  BC,(_FATBF)
001A90 E106 19              11      ADD HL,DE
001A91 E107 09              11      ADD HL,BC
001A92 E108 17               4      RLA
001A93 E109 C9              10      RET
                                
       E10A                     GNCL:
001A94 E10A CDB1E0          17      CALL    NCL1        ;GET NEXT CLUSTER
001A97 E10D D8              11      RET C
001A98 E10E C5              11      PUSH    BC
001A99 E10F E5              11      PUSH    HL
001A9A E110 CDE4E0          17      CALL    NCL3
001A9D E113 3809            12      JR  C,GNC1
001A9F E115 5E               7      LD  E,(HL)
001AA0 E116 23               6      INC HL
001AA1 E117 7E               7      LD  A,(HL)
001AA2 E118 E60F             7      AND 00FH
001AA4 E11A 57               4      LD  D,A
001AA5 E11B E1              10      POP HL
001AA6 E11C C1              10      POP BC
001AA7 E11D C9              10      RET
       E11E                     GNC1:
001AA8 E11E 7E               7      LD  A,(HL)
001AA9 E11F 23               6      INC HL
001AAA E120 56               7      LD  D,(HL)
001AAB E121 0604             7      LD  B,4
       E123                     GNC1L:
001AAD E123 CB3A             8      SRL D   ;DA=DA/2
001AAF E125 1F               4      RRA     ;
001AB0 E126 10FB            13      DJNZ    GNC1L
                                
001AB2 E128 5F               4      LD  E,A
001AB3 E129 E1              10      POP HL
001AB4 E12A C1              10      POP BC
001AB5 E12B A7               4      AND A
001AB6 E12C C9              10      RET
                                
       E12D                     SNCL:
001AB7 E12D CDB1E0          17      CALL    NCL1
001ABA E130 D8              11      RET C
                                ;               SET NEXT CLUSTER
001ABB E131 E5              11      PUSH    HL
001ABC E132 C5              11      PUSH    BC
001ABD E133 D5              11      PUSH    DE
001ABE E134 E5              11      PUSH    HL
001ABF E135 CDE4E0          17      CALL    NCL3
001AC2 E138 D1              10      POP DE
                                ;CF=ODD
001AC3 E139 7E               7      LD  A,(HL)
001AC4 E13A 73               7      LD  (HL),E
001AC5 E13B 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
001AC7 E13D 23               6      INC HL
001AC8 E13E ED67            18      RRD     ;M={A[3:0],E[3:0]}
001ACA E140 7A               4      LD  A,D
001ACB E141 1804            12      JR  SNC11
       E143                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
001ACD E143 ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001ACF E145 23               6      INC HL
001AD0 E146 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E147                     SNC11:
001AD1 E147 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
001AD3 E149 B7               4      OR  A
001AD4 E14A D1              10      POP DE
001AD5 E14B C1              10      POP BC
001AD6 E14C E1              10      POP HL
       E14D                     FAT_CHANGED:
001AD7 E14D 3EFF             7      LD  A,0FFH
001AD9 E14F 32A2E6          13      LD  (_WTFATF),A
001ADC E152 C9              10      RET
                                
       E153                     N16CL3:
001ADD E153 C5              11      PUSH    BC
001ADE E154 6B               4      LD  L,E
001ADF E155 7A               4      LD  A,D
001AE0 E156 E601             7      AND 1
001AE2 E158 67               4      LD  H,A
001AE3 E159 29              11      ADD HL,HL
001AE4 E15A ED4B7CE7        20      LD  BC,(_FATBF)
001AE8 E15E 09              11      ADD HL,BC
001AE9 E15F C1              10      POP BC
001AEA E160 C9              10      RET
                                
       E161                     GNCL16:
001AEB E161 CDAAE0          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
001AEE E164 D8              11      RET C
001AEF E165 E5              11      PUSH    HL
001AF0 E166 CD53E1          17      CALL    N16CL3
001AF3 E169 5E               7      LD  E,(HL)
001AF4 E16A 23               6      INC HL
001AF5 E16B 56               7      LD  D,(HL)
001AF6 E16C E1              10      POP HL
001AF7 E16D C9              10      RET
                                
       E16E                     SNCL16:
001AF8 E16E CDAAE0          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
001AFB E171 D8              11      RET C
001AFC E172 D5              11      PUSH    DE
001AFD E173 E5              11      PUSH    HL
001AFE E174 CD53E1          17      CALL    N16CL3
001B01 E177 D1              10      POP DE      ;HL
001B02 E178 73               7      LD  (HL),E
001B03 E179 23               6      INC HL
001B04 E17A 72               7      LD  (HL),D
001B05 E17B 6B               4      LD  L,E
001B06 E17C 62               4      LD  H,D
001B07 E17D D1              10      POP DE
001B08 E17E 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E180                     NEXTX:
001B0A E180 3E00             7      LD  A,0 ;自己書き換え
       E181                     _SECPS  EQU $-1
001B0C E182 3C               4      INC A
001B0D E183 E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E184                     _NCPAT  EQU $-1
001B0F E185 3281E1          13      LD  (_SECPS),A
001B12 E188 C9              10      RET
                                
       E189                     GNCLX:
001B13 E189 CD80E1          17      CALL    NEXTX
001B16 E18C C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001B17 E18D C3F7E6          10      JP  _GNCL   ;次のクラスタを探す
                                
       E190                     RDFAT:
001B1A E190 3E80             7      LD  A,080H
001B1C E192 3270E6          13      LD  (CHECK),A
       E195                     RDFAT1:
001B1F E195 3A88E6          13      LD  A,(_DRV)
001B22 E198 CD3AE4          17      CALL    CHGDRVR
001B25 E19B D8              11      RET C
001B26 E19C DD7E12          19      LD  A,(IX+DPB_DEVICE)
001B29 E19F CB6F             8      BIT 5,A
001B2B E1A1 286E            12      JR  Z,RDFAT0X
001B2D E1A3 2170E6          10      LD  HL,CHECK
001B30 E1A6 A6               7      AND (HL)
001B31 E1A7 77               7      LD  (HL),A
001B32 E1A8 110000          10      LD  DE,0        ;BPB
001B35 E1AB 2A7CE7          16      LD  HL,(_FATBF)
001B38 E1AE 0E00             7      LD  C,0
001B3A E1B0 CD12E3          17      CALL    DRD24
001B3D E1B3 3022            12      JR  NC,GETBPB
001B3F E1B5 2170E6          10      LD  HL,CHECK
001B42 E1B8 CB06            15      RLC (HL)
001B44 E1BA 3F               4      CCF
001B45 E1BB D8              11      RET C
001B46 E1BC DDCB0A1E        23      RR  (IX+DPB_FDMODE)
001B4A E1C0 3F               4      CCF         ;フロッピーディスクのFDモード(2D/2HD)を切り替える
001B4B E1C1 DDCB0A16        23      RL  (IX+DPB_FDMODE)
001B4F E1C5 3A84E6          13      LD  A,(_DRIVE)
001B52 E1C8 E603             7      AND 3
001B54 E1CA F680             7      OR  080H
001B56 E1CC 6F               4      LD  L,A
001B57 E1CD 26E6             7      LD  H,_CYL0/256
001B59 E1CF 3EFF             7      LD  A,0FFH
001B5B E1D1 3289E6          13      LD  (_DSK),A
001B5E E1D4 77               7      LD  (HL),A
001B5F E1D5 18BE            12      JR  RDFAT1
       E1D7                     GETBPB:
001B61 E1D7 FDE5            15      PUSH    IY
001B63 E1D9 FD2A7CE7        20      LD  IY,(_FATBF) ;BPB
001B67 E1DD CDF1E6          17      CALL    _BPB2DPB
001B6A E1E0 FDE1            14      POP IY
001B6C E1E2 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001B6F E1E5 3027            12      JR  NC,GETBPBOK
001B71 E1E7 E60F             7      AND 00FH
001B73 E1E9 FE07             7      CP  7
001B75 E1EB 37               4      SCF
001B76 E1EC C0              11      RET NZ
001B77 E1ED DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001B7B E1F1 21C0E7          10      LD  HL,M2D
001B7E E1F4 2008            12      JR  NZ,SETFDMODE
001B80 E1F6 2E04             7      LD  L,4
001B82 E1F8 CDFBE2          17      CALL    CHECK_MAXSECSZ
001B85 E1FB D8              11      RET C
001B86 E1FC 2ED2             7      LD  L,M2HD-STABLE
       E1FE                     SETFDMODE:
001B88 E1FE DDE5            15      PUSH    IX
001B8A E200 D1              10      POP DE
001B8B E201 EDA0            16      LDI
001B8D E203 EDA0            16      LDI
001B8F E205 13               6      INC DE
001B90 E206 13               6      INC DE
001B91 E207 13               6      INC DE
001B92 E208 13               6      INC DE
001B93 E209 010C00          10      LD  BC,12
001B96 E20C EDB0                    LDIR
       E20E                     GETBPBOK:
001B98 E20E CDA6E3          17      CALL    CHGDRV2
       E211                     RDFAT0X:
001B9B E211 CD06E3          17      CALL    RDFATS
001B9E E214 D8              11      RET C
001B9F E215 DDAE06          19      XOR (IX+DPB_FATID)
001BA2 E218 C8              11      RET Z
001BA3 E219 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001BA6 E21C CB5F             8      BIT 3,A
001BA8 E21E 2803            12      JR  Z,RDFAT0X1
001BAA E220 CB6F             8      BIT 5,A
001BAC E222 C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E223                     RDFAT0X1:
001BAD E223 37               4      SCF
001BAE E224 C9              10      RET
                                
       E225                     POP_HL_SCF_RET:
001BAF E225 E1              10      POP HL
001BB0 E226 37               4      SCF
001BB1 E227 C9              10      RET
                                
       E228                     BPB2DPB:
001BB2 E228 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
001BB5 E22B B7               4      OR  A
001BB6 E22C 37               4      SCF
001BB7 E22D C0              11      RET NZ
       E22E                     BPBOK:
001BB8 E22E FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001BBB E231 DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001BBE E234 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001BC1 E237 DD7700          19      LD  (IX+DPB_FATLN),A
001BC4 E23A FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
001BC7 E23D DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
001BCA E240 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001BCD E243 FD660F          19      LD  H,(IY+15)
001BD0 E246 DD750E          19      LD  (IX+DPB_FATPS),L
001BD3 E249 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001BD6 E24C FD5617          19      LD  D,(IY+23)
001BD9 E24F FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E252                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001BDC E252 19              11      ADD HL,DE
001BDD E253 10FD            13      DJNZ    BPBDP1
       E255                     BPBDP2:
001BDF E255 DD7510          19      LD  (IX+DPB_DIRPS),L
001BE2 E258 DD7411          19      LD  (IX+DPB_DIRPS+1),H
001BE5 E25B E5              11      PUSH    HL
                                
001BE6 E25C FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
001BE9 E25F FD6612          19      LD  H,(IY+18)
001BEC E262 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001BEF E265 B7               4      OR  A
001BF0 E266 28BD            12      JR  Z,POP_HL_SCF_RET
001BF2 E268 0606             7      LD  B,6
       E26A                     BPBBPS1:
001BF4 E26A 05               4      DEC B
001BF5 E26B 0F               4      RRCA
001BF6 E26C 30FC            12      JR  NC,BPBBPS1
       E26E                     BPBDE1:
001BF8 E26E 29              11      ADD HL,HL
001BF9 E26F 10FD            13      DJNZ    BPBDE1
                                
001BFB E271 7C               4      LD  A,H
001BFC E272 DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
001BFF E275 D1              10      POP DE      ;DPB_DIRPS
001C00 E276 6C               4      LD  L,H
001C01 E277 2600             7      LD  H,0
001C03 E279 19              11      ADD HL,DE       ;MAXDIR
001C04 E27A E5              11      PUSH    HL
001C05 E27B FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001C08 E27E CB21             8      SLA C       ;*2
001C0A E280 AF               4      XOR A
001C0B E281 47               4      LD  B,A
001C0C E282 ED42            15      SBC HL,BC
001C0E E284 DD7514          19      LD  (IX+DPB_ADDCL),L
001C11 E287 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
001C14 E28A D1              10      POP DE      ;DE=DPB_MAXDIR
001C15 E28B FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001C18 E28E FD6614          19      LD  H,(IY+20)
                                
001C1B E291 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001C1E E294 E60F             7      AND 00FH
001C20 E296 FE07             7      CP  7       ;フロッピー
001C22 E298 2019            12      JR  NZ,NOT_FD
001C24 E29A E5              11      PUSH    HL
001C25 E29B FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001C28 E29E DD710D          19      LD  (IX+DPB_MAXSEC),C
001C2B E2A1 AF               4      XOR A
001C2C E2A2 CB21             8      SLA C       ;両面なのでセクタ数を２倍
001C2E E2A4 0610             7      LD  B,16
       E2A6                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001C30 E2A6 29              11      ADD HL,HL
001C31 E2A7 17               4      RLA
001C32 E2A8 B9               4      CP  C
001C33 E2A9 3802            12      JR  C,DIVSEC1
001C35 E2AB 91               4      SUB C
001C36 E2AC 2C               4      INC L
       E2AD                     DIVSEC1:
001C37 E2AD 10F7            13      DJNZ    DIVSEC
001C39 E2AF DD750C          19      LD  (IX+DPB_MAXCYL),L
001C3C E2B2 E1              10      POP HL  ;ここまでフロッピー専用
       E2B3                     NOT_FD:
001C3D E2B3 7C               4      LD  A,H
001C3E E2B4 B5               4      OR  L
001C3F E2B5 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001C41 E2B7 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001C43 E2B9 2F               4      CPL         ;A=0FFH
001C44 E2BA FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001C47 E2BD D8              11      RET C
001C48 E2BE FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001C4B E2C1 FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001C4E E2C4 FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E2C7                     BPB16BIT:
001C51 E2C7 ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001C53 E2C9 DE00             7      SBC A,0
001C55 E2CB FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E2CE                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001C58 E2CE CB18             8      RR  B       ;->CY
001C5A E2D0 3808            12      JR  C,BPBTC2
001C5C E2D2 CB3F             8      SRL A
001C5E E2D4 CB1C             8      RR  H       ;AHL=AHL/2
001C60 E2D6 CB1D             8      RR  L
001C62 E2D8 18F4            12      JR  BPBTC1
       E2DA                     BPBTC2:
001C64 E2DA C6FF             7      ADD A,0FFH
001C66 E2DC D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001C67 E2DD 23               6      INC HL
001C68 E2DE 23               6      INC HL
001C69 E2DF DD7508          19      LD  (IX+DPB_MAXCL),L
001C6C E2E2 DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001C6F E2E5 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001C72 E2E8 DD7706          19      LD  (IX+DPB_FATID),A
                                
001C75 E2EB FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001C78 E2EE C6FE             7      ADD A,0-2       ;>2:CF=1
001C7A E2F0 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001C7D E2F3 6F               4      LD  L,A
001C7E E2F4 3002            12      JR  NC,BPBFAT1
001C80 E2F6 F680             7      OR  080H
       E2F8                     BPBFAT1:            ;ここではCF=0
001C82 E2F8 DD770F          19      LD  (IX+DPB_BPS),A
       E2FB                     CHECK_MAXSECSZ:
001C85 E2FB 3A7BE7          13      LD  A,(_MAX_SEC_SZ_H)
001C88 E2FE BD               4      CP  L
001C89 E2FF C8              11      RET Z       ;1セクタ1024バイト
001C8A E300 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001C8B E301 C8              11      RET Z       ;1セクタ256バイト
001C8C E302 2D               4      DEC L
001C8D E303 C8              11      RET Z       ;1セクタ512バイト
001C8E E304 37               4      SCF
001C8F E305 C9              10      RET
                                
       E306                     RDFATS:
001C90 E306 CD31E3          17      CALL    FATSETUP
001C93 E309 D8              11      RET C
001C94 E30A CD14E3          17      CALL    DRD24B
001C97 E30D 2A7CE7          16      LD  HL,(_FATBF)
001C9A E310 7E               7      LD  A,(HL)
001C9B E311 C9              10      RET
                                
       E312                     DRD24:
001C9C E312 0601             7      LD  B,1
       E314                     DRD24B:
001C9E E314 DDE5            15      PUSH    IX
001CA0 E316 DD2AA8E6        20      LD  IX,(_DPB)
001CA4 E31A CD09CC          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E31B                     DRDPAT  EQU $-2
001CA7 E31D DDE1            14      POP IX
001CA9 E31F C9              10      RET
                                
       E320                     DWT24:
001CAA E320 0601             7      LD  B,1
       E322                     DWT24B:
001CAC E322 DDE5            15      PUSH    IX
001CAE E324 DD2AA8E6        20      LD  IX,(_DPB)
001CB2 E328 CD7DE4          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E329                     DWTPAT  EQU $-2
001CB5 E32B DDE1            14      POP IX
001CB7 E32D D0              11      RET NC
001CB8 E32E C35AE6          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E331                     FATSETUP:
001CBB E331 3AAAE6          13      LD  A,(_FATDRV)
001CBE E334 CD3AE4          17      CALL    CHGDRVR     ;ドライブ切り替え
001CC1 E337 D8              11      RET C
       E338                     FATS2:
001CC2 E338 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001CC5 E33B 0F               4      RRCA
001CC6 E33C CD6CE3          17      CALL    FATSETUP12  ;自己書き換え
       E33D                     FATSX   EQU $-2
001CC9 E33F 210000          10      LD  HL,0
001CCC E342 4A               4      LD  C,D
001CCD E343 54               4      LD  D,H
001CCE E344 3AABE6          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
001CD1 E347 47               4      LD  B,A
001CD2 E348 04               4      INC B
001CD3 E349 DD7E00          19      LD  A,(IX+DPB_FATLN)
       E34C                     FAT_SKP:
001CD6 E34C 05               4      DEC B
001CD7 E34D 2809            12      JR  Z,FAT1
001CD9 E34F 19              11      ADD HL,DE
001CDA E350 93               4      SUB E
001CDB E351 30F9            12      JR  NC,FAT_SKP
001CDD E353 DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
001CE1 E357 C8              11      RET Z
       E358                     FAT1:
001CE2 E358 EB               4      EX  DE,HL
001CE3 E359 B7               4      OR  A       ;0の場合は0100Hとして扱う
001CE4 E35A 2803            12      JR  Z,FAT3
001CE6 E35C B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001CE7 E35D 3801            12      JR  C,FAT2
       E35F                     FAT3:
001CE9 E35F 79               4      LD  A,C
       E360                     FAT2:
001CEA E360 47               4      LD  B,A
                                
001CEB E361 2AFAE7          16      LD  HL,(_FATPS) ;fat sector pos
001CEE E364 19              11      ADD HL,DE
001CEF E365 EB               4      EX  DE,HL
001CF0 E366 2A7CE7          16      LD  HL,(_FATBF)
001CF3 E369 AF               4      XOR A       ;CF=0
001CF4 E36A 4F               4      LD  C,A
001CF5 E36B C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E36C                     FATSETUP12:
001CF6 E36C 110606          10      LD  DE,0606H    ;256
001CF9 E36F D8              11      RET C
001CFA E370 110303          10      LD  DE,0303H    ;512
001CFD E373 0F               4      RRCA
001CFE E374 D8              11      RET C
001CFF E375 110102          10      LD  DE,0201H    ;1024
001D02 E378 C9              10      RET
                                
       E379                     FATSETUP16:
001D03 E379 110404          10      LD  DE,0404H    ;256
001D06 E37C D8              11      RET C
001D07 E37D 110202          10      LD  DE,0202H    ;512
001D0A E380 0F               4      RRCA
001D0B E381 D8              11      RET C
001D0C E382 110101          10      LD  DE,0101H    ;1024
001D0F E385 C9              10      RET
                                
       E386                     CHGDRV:
001D10 E386 E5              11      PUSH    HL
001D11 E387 2189E6          10      LD  HL,_DSK
001D14 E38A BE               7      CP  (HL)
001D15 E38B 280A            12      JR  Z,CHGDRVE
       E38D                     CHGDRV1:
001D17 E38D DDE5            15      PUSH    IX
001D19 E38F CD99E3          17      CALL    CHGDRV0
001D1C E392 3A89E6          13      LD  A,(_DSK)
001D1F E395 DDE1            14      POP IX
       E397                     CHGDRVE:
001D21 E397 E1              10      POP HL
001D22 E398 C9              10      RET
                                
       E399                     CHGDRV0:
001D23 E399 6F               4      LD  L,A
001D24 E39A CDDCE6          17      CALL    _GETDPB
001D27 E39D D8              11      RET C
001D28 E39E DD22A8E6        20      LD  (_DPB),IX
001D2C E3A2 7D               4      LD  A,L
001D2D E3A3 3289E6          13      LD  (_DSK),A
       E3A6                     CHGDRV2:
001D30 E3A6 C5              11      PUSH    BC
001D31 E3A7 D5              11      PUSH    DE
001D32 E3A8 ED73F1E3        20      LD  (SPPAT2),SP
001D36 E3AC F3               4      DI
001D37 E3AD DDF9            10      LD  SP,IX
                                
001D39 E3AF E1              10      POP HL      ;00:DPB_FATLN
001D3A E3B0 E1              10      POP HL      ;02:DPB_DRD
001D3B E3B1 221BE3          16      LD  (DRDPAT),HL
                                
001D3E E3B4 E1              10      POP HL
001D3F E3B5 2229E3          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001D42 E3B8 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001D43 E3B9 7C               4      LD  A,H
001D44 E3BA 321DDA          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001D47 E3BD 3D               4      DEC A
001D48 E3BE 3284E1          13      LD  (_NCPAT),A
                                
001D4B E3C1 E1              10      POP HL      ;08:DPB_MAXCL
001D4C E3C2 7D               4      LD  A,L
001D4D E3C3 323CDA          13      LD  (CLPAT2),A
001D50 E3C6 7C               4      LD  A,H
001D51 E3C7 3238DA          13      LD  (CLPAT1),A
001D54 E3CA 2B               6      DEC HL
001D55 E3CB 223BDC          16      LD  (MAXCLP),HL
                                
001D58 E3CE E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001D59 E3CF 4C               4      LD  C,H
                                
001D5A E3D0 E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001D5B E3D1 E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001D5C E3D2 7C               4      LD  A,H     ;DPB_BPS
001D5D E3D3 E607             7      AND 7
001D5F E3D5 32F6DE          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001D62 E3D8 87               4      ADD A,A     ;8  4   2
001D63 E3D9 87               4      ADD A,A     ;010H   8   4
001D64 E3DA 87               4      ADD A,A     ;020H   010H    8
001D65 E3DB 329BD8          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001D68 E3DE 2600             7      LD  H,0
001D6A E3E0 22FAE7          16      LD  (_FATPS),HL
                                
001D6D E3E3 E1              10      POP HL      ;10:DPB_DIRPS
001D6E E3E4 22FCE7          16      LD  (_DIRPS),HL
                                
001D71 E3E7 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001D72 E3E8 7C               4      LD  A,H
001D73 E3E9 3284E6          13      LD  (_DRIVE),A
                                
001D76 E3EC E1              10      POP HL      ;14:DPB_ADDCL
001D77 E3ED 222DDA          16      LD  (CLSPAT),HL
                                
001D7A E3F0 310000          10      LD  SP,0        ;元のSPを復元
       E3F1                     SPPAT2  EQU $-2
001D7D E3F3 FB               4      EI
001D7E E3F4 2AFCE7          16      LD  HL,(_DIRPS)
001D81 E3F7 0600             7      LD  B,0
001D83 E3F9 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001D84 E3FA 22B6D8          16      LD  (MD_PAT),HL
                                
001D87 E3FD 2A3BDC          16      LD  HL,(MAXCLP)
001D8A E400 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001D8D E403 19              11      ADD HL,DE
001D8E E404 380F            12      JR  C,SETFAT16
001D90 E406 210AE1          10      LD  HL,GNCL     ;FAT12
001D93 E409 112DE1          10      LD  DE,SNCL
001D96 E40C 016CE3          10      LD  BC,FATSETUP12
001D99 E40F DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001D9D E413 180D            12      JR  EXTRA1
       E415                     SETFAT16:
001D9F E415 2161E1          10      LD  HL,GNCL16   ;FAT16
001DA2 E418 116EE1          10      LD  DE,SNCL16
001DA5 E41B 0179E3          10      LD  BC,FATSETUP16
001DA8 E41E DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       E422                     EXTRA1:
001DAC E422 22F8E6          16      LD  (GNCPAT),HL
001DAF E425 ED53FBE6        20      LD  (SNCPAT),DE
001DB3 E429 ED433DE3        20      LD  (FATSX),BC
001DB7 E42D D1              10      POP DE
001DB8 E42E C1              10      POP BC
001DB9 E42F AF               4      XOR A
001DBA E430 C9              10      RET
                                
       E431                     GETDPBD:
001DBB E431 DDE3            23      EX  (SP),IX
001DBD E433 DDE5            15      PUSH    IX
001DBF E435 3A88E6          13      LD  A,(_DRV)
001DC2 E438 1807            12      JR  GETDPB1
                                
       E43A                     CHGDRVR:
001DC4 E43A CDD9E6          17      CALL    _CHGDRV
001DC7 E43D D8              11      RET C
001DC8 E43E 3A89E6          13      LD  A,(_DSK)
       E441                     GETDPB1:
001DCB E441 C3DCE6          10      JP  _GETDPB
                                
       E444                     GETDPB:
001DCE E444 FE08             7      CP  8
001DD0 E446 3F               4      CCF
001DD1 E447 D8              11      RET C
001DD2 E448 0F               4      RRCA
001DD3 E449 0F               4      RRCA
001DD4 E44A 0F               4      RRCA
001DD5 E44B DD                      DB  0DDH        ;Z80未定義命令
001DD6 E44C 6F               4      LD  L,A     ;LD IXL,A
001DD7 E44D DD                      DB  0DDH        ;Z80未定義命令
001DD8 E44E 26E8             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001DDA E450 DD7E00          19      LD  A,(IX+DPB_FATLN)
001DDD E453 A7               4      AND A       ;CF=0の為
001DDE E454 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001DE2 E458 C0              11      RET NZ      ;FAT16
001DE3 E459 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001DE7 E45D C0              11      RET NZ      ;BPB
001DE8 E45E FE01             7      CP  001H        ;A=0 THEN CF=1
001DEA E460 C9              10      RET
                                
       E461                     _SYS5F:
001DEB E461 AF               4      XOR A
       E462                     FFLUSH:
001DEC E462 F5              11      PUSH    AF
001DED E463 CD88E0          17      CALL    WTFATX
001DF0 E466 AF               4      XOR A
001DF1 E467 32ABE6          13      LD  (_FATIX),A
001DF4 E46A 2F               4      CPL         ;0FFH
001DF5 E46B 32AAE6          13      LD  (_FATDRV),A
001DF8 E46E 3E                      DB  03EH        ;次のPUSH AFをスキップ
       E46F                     FFLUSHBUF:
001DF9 E46F F5              11      PUSH    AF
001DFA E470 CD3EE0          17      CALL    DWTX
001DFD E473 3EFF             7      LD  A,0FFH
001DFF E475 3239E6          13      LD  (SFILE),A
001E02 E478 32A5E6          13      LD  (_DBDRV),A
001E05 E47B F1              10      POP AF
001E06 E47C C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "MSXDISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MSX
                                
                                ;   PHYDIO DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       E47D                     WTTRK:
       E47D                     FDWT:
001E07 E47D 37               4      SCF
001E08 E47E C9              10      RET
                                
       E47F                     PDWT:
001E09 E47F 37               4      SCF
001E0A E480 CB7C             8      BIT 7,H
001E0C E482 2058            12      JR  NZ,PDWX
001E0E E484 CD6FE4          17      CALL    FFLUSHBUF
       E487                     PDWT1:
001E11 E487 C5              11      PUSH    BC
001E12 E488 D5              11      PUSH    DE
001E13 E489 ED5B7EE7        20      LD  DE,(_DTBUF)
001E17 E48D DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001E1A E490 E607             7      AND 7
001E1C E492 47               4      LD  B,A
001E1D E493 0E00             7      LD  C,0
001E1F E495 EDB0                    LDIR
001E21 E497 E3              19      EX  (SP),HL
001E22 E498 EB               4      EX  DE,HL
001E23 E499 D5              11      PUSH    DE
001E24 E49A 2A7EE7          16      LD  HL,(_DTBUF)
001E27 E49D 0601             7      LD  B,1
001E29 E49F 37               4      SCF
001E2A E4A0 CDDCE4          17      CALL    PDWX
001E2D E4A3 3832            12      JR  C,PDRWERR
001E2F E4A5 D1              10      POP DE
001E30 E4A6 13               6      INC DE
001E31 E4A7 E1              10      POP HL
001E32 E4A8 C1              10      POP BC
001E33 E4A9 10D4            13      DJNZ    PDWT
001E35 E4AB AF               4      XOR A
001E36 E4AC C9              10      RET
       E4AD                     PDRD:
001E37 E4AD CB7C             8      BIT 7,H
001E39 E4AF 202A            12      JR  NZ,PDWXR
001E3B E4B1 CD6FE4          17      CALL    FFLUSHBUF
       E4B4                     PDRD1:
001E3E E4B4 C5              11      PUSH    BC
001E3F E4B5 D5              11      PUSH    DE
001E40 E4B6 E5              11      PUSH    HL
001E41 E4B7 2A7EE7          16      LD  HL,(_DTBUF)
001E44 E4BA 0601             7      LD  B,1
001E46 E4BC CDDBE4          17      CALL    PDWXR
001E49 E4BF 3816            12      JR  C,PDRWERR
001E4B E4C1 D1              10      POP DE
001E4C E4C2 2A7EE7          16      LD  HL,(_DTBUF)
001E4F E4C5 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001E52 E4C8 E607             7      AND 7
001E54 E4CA 47               4      LD  B,A
001E55 E4CB 0E00             7      LD  C,0
001E57 E4CD EDB0                    LDIR
001E59 E4CF EB               4      EX  DE,HL
001E5A E4D0 D1              10      POP DE
001E5B E4D1 13               6      INC DE
001E5C E4D2 C1              10      POP BC
001E5D E4D3 10D8            13      DJNZ    PDRD
001E5F E4D5 AF               4      XOR A
001E60 E4D6 C9              10      RET
       E4D7                     PDRWERR:
001E61 E4D7 E1              10      POP HL
001E62 E4D8 D1              10      POP DE
001E63 E4D9 C1              10      POP BC
001E64 E4DA C9              10      RET
       E4DB                     PDWXR:
001E65 E4DB A7               4      AND A
       E4DC                     PDWX:                   ;CF=0 READ CF=1 WRITE
001E66 E4DC DDCB1266        20      BIT 4,(IX+DPB_DEVICE)   ;デバイス情報
001E6A E4E0 2003            12      JR  NZ,PDWX1
001E6C E4E2 DD4E06          19      LD  C,(IX+DPB_FATID)    ;メディアバイト
       E4E5                     PDWX1:
001E6F E4E5 DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
001E72 E4E8 C5              11      PUSH    BC
001E73 E4E9 D5              11      PUSH    DE
001E74 E4EA E5              11      PUSH    HL
001E75 E4EB DDE5            15      PUSH    IX
001E77 E4ED FDE5            15      PUSH    IY
001E79 E4EF CDA7FF          17      CALL    H_PHYD
001E7C E4F2 FDE1            14      POP IY
                                ;   LD  IX,PHYDIO
                                ;   CALL    CALSLT_R
001E7E E4F4 DDE1            14      POP IX
001E80 E4F6 E1              10      POP HL
001E81 E4F7 D1              10      POP DE
001E82 E4F8 C1              10      POP BC
001E83 E4F9 D8              11      RET C
       E4FA                     PDWX2:
001E84 E4FA 13               6      INC DE
001E85 E4FB DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001E88 E4FE E607             7      AND 7
001E8A E500 84               4      ADD A,H
001E8B E501 67               4      LD  H,A
001E8C E502 10F6            13      DJNZ    PDWX2
001E8E E504 AF               4      XOR A
001E8F E505 C9              10      RET
[EOF:MSXDISK2.ASM:UTF_8]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001E90 E506                     PATHD:  DS  PATHX
001ECB E541 00                  PATHE:  DB  0
                                
       E542                     DTA_CCP:
001ECC E542                         DS  37
                                
       E567                     FCB_BAT:
001EF1 E567                         DS  37
                                
001F16 E58C 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001F21 E597 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
                                ;   ALIGN   256
       E59E                     AT_WORK:
001F28 E59E                         DS  WORKAD-AT_WORK
                                
       E600                     CPM_BOOT:
001F8A E600 C30000          10      JP  0
       E603                     _SYS00:     ;(BDOS)プログラム終了
       E603                     CPM_WBOOT:
001F8D E603 C3ACCC          10      JP  WBOOT1
       E606                     CPM_CONST:
001F90 E606 C300D5          10      JP  CONSTX
       E609                     _SYS07:     ;(BDOS)コンソール直接入力
       E609                     CPM_CONIN:
001F93 E609 C321D4          10      JP  FLGET
       E60C                     CPM_CONOUT:
001F96 E60C C303D6          10      JP  CONOUT1
                                
       E60F                     DECBF:              ;10進数表示時のバッファ(5バイト)
001F99 E60F                         DS  5
       E60F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       E611                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       E614                     FDRV:
001F9E E614 00                      DB  0
       E615                     FNAME:
001F9F E615                         DS  36
       E639                     SFILE:
001FC3 E639                         DS  33      ;DRV FILENAME
       E65A                     _DISKE:
001FE4 E65A C39DD3          10      JP  SHOW_ERROR
                                
001FE7 E65D 0000                LEFTX:  DW  0
001FE9 E65F 0000                DTAX:   DW  0
                                
                                ;   PSGのビープ音のデータ(X1)
       E661                     BEEPD:
001FEB E661 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
001FF3 E669 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                ;
       E662                     RTC_YY  EQU BEEPD+1 ;RTCのバッファ年(88)
       E663                     RTC_MW  EQU BEEPD+2 ;RTCのバッファ月(88)
       E664                     RTC_DD  EQU BEEPD+3 ;RTCのバッファ日(88)
       E665                     RTC_TT  EQU BEEPD+4 ;RTCのバッファ時(88)
       E666                     RTC_MM  EQU BEEPD+5 ;RTCのバッファ分(88)
       E667                     RTC_SS  EQU BEEPD+6 ;RTCのバッファ秒(88)
       E662                     ROM_SLT EQU BEEPD+1 ;ROMのスロット(MSX)
       E661                     ZERO    EQU BEEPD
                                
       E670                     CHECK:
001FFA E670 00                      DB  0
                                
       E671                     OK:
001FFB E671 4F4B24                  DB  "OK$"
001FFE E674                         DS  5
       E679                     COMERM:
002003 E679 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       E680                     _CYL0:
00200A E680 FF                      DB  0FFH    ;Cylinder
       E681                     _CYL1:
00200B E681 FF                      DB  0FFH    ;Cylinder
       E682                     _CYL2:
00200C E682 FF                      DB  0FFH    ;Cylinder
       E683                     _CYL3:
00200D E683 FF                      DB  0FFH    ;Cylinder
       E684                     _DRIVE:
00200E E684 00                      DB  0   ;unit number
       E685                     _SEEKSP:
00200F E685 00                      DB  0   ;Seek speed
       E686                     _ISEEK:
002010 E686 32                      DB  50  ;
002011 E687                         DS  1
       E688                     _DRV:
002012 E688 00                      DB  0
       E689                     _DSK:
002013 E689 FF                      DB  0FFH
       E68A                     _DTA:
002014 E68A 8000                    DW  00080H
       E68C                     _CTC:
002016 E68C 0000                    DW  0
       E68E                     _TXADR:
002018 E68E 0000                    DW  0
       E690                     _KEYPS:
00201A E690 0000                    DW  0
       E692                     _KEYD:
00201C E692 00                      DB  000H    ;キーデータ
       E693                     _KEYST:
00201D E693 FF                      DB  0FFH    ;キーステータス(SHIFT,CTRLの状態)
       E694                     _KEYSP_L:
00201E E694 00                      DB  KEYSP_L ;オートリピートの速度
       E695                     _KEYSP_H:
00201F E695 00                      DB  KEYSP_H ;オートリピートの速度
       E696                     _COLORF:
002020 E696 00                      DB  COLORF  ;色
       E697                     _LINE:
002021 E697 18                      DB  LINE
                                
                                            ;次のファイルの検索(C=12)で使用するFCB
       E698                     _FCB:
002022 E698 0000                    DW  0   ;SEARCH FILES
       E69A                     _FBPS:
002024 E69A 0000                    DW  0   ;    //
       E69C                     _FBAD:
002026 E69C 0000                    DW  0   ;    //
       E69E                     _FBCNT:
002028 E69E 00                      DB  0   ;    //
       E69F                     _FILEN:
002029 E69F 00                      DB  0   ;    //
       E6A0                     _DIRF:
00202A E6A0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
00202B E6A1                         DS  1
       E6A2                     _WTFATF:
00202C E6A2 00                      DB  0   ;FATバッファの更新フラグ
00202D E6A3                         DS  1
       E6A4                     _WTDBF:
00202E E6A4 00                      DB  0   ;データバッファの更新フラグ
       E6A5                     _DBDRV:
00202F E6A5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       E6A6                     _DBSEC:
002030 E6A6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       E6A8                     _DPB:
002032 E6A8 0000                    DW  0
       E6AA                     _FATDRV:
002034 E6AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       E6AB                     _FATIX:
002035 E6AB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       E6AC                     _FAKEFREE:
002036 E6AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
002038 E6AE                         DS  2
                                ;   画面周りのデータ
       E6B0                     CRTCD:
00203A E6B0 6F                      DB  06FH
       E6B1                     _WIDTH:
00203B E6B1 28                      DB  WIDTH
       E6B2                     TVRAMTOP:
00203C E6B2 5938                    DB  059H,038H
00203E E6B4 1F02                    DB  01FH,002H
       E6B6                     _LINE2:
002040 E6B6 19                      DB  019H
       E6B7                     WKE4:
002041 E6B7 1C                      DB  01CH
       E6B8                     WKE6:
002042 E6B8 00                      DB  000H
       E6B9                     WK40:
002043 E6B9 07                      DB  007H
       E6BA                     _PAGE_MINUS:
002044 E6BA 40FC                    DW  0-WIDTH*LINE
       E6BC                     _WIDTH_MINUS:
002046 E6BC D8FF                    DW  0-WIDTH
       E6BE                     WK30:
002048 E6BE 0C                      DB  00CH
       E6BF                     WK31:
       E6BF                     WK1FD0:
002049 E6BF 20                      DB  020H
                                
                                ;   割り込みベクタ(X1)
00204A E6C0 0000                CTC0:   DW  INTCTCE
00204C E6C2 0000                CTC1:   DW  INTCTCE
00204E E6C4 0000                CTC2:   DW  INTCTCE
002050 E6C6 0000                CTC3:   DW  INTCTCE
002052 E6C8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
002054 E6CA C366D4          10  _INKEY: JP  INKEY
002057 E6CD C3A6D3          10  _PRINT: JP  PRINT
00205A E6D0 C39DD5          10  _SCRN:  JP  SCRN
00205D E6D3 C37DD5          10  _POS:   JP  POS
002060 E6D6 C388D5          10  _LOC:   JP  LOC
       E6D9                     _CHGDRV:
002063 E6D9 C386E3          10      JP  CHGDRV
       E6DC                     _GETDPB:
002066 E6DC C344E4          10      JP  GETDPB
       E6DF                     _FFLUSH:
002069 E6DF C362E4          10      JP  FFLUSH
       E6E2                     _RDFATX:
00206C E6E2 C35EE0          10      JP  RDFATX
00206F E6E5 C390E1          10  _RDFAT: JP  RDFAT
002072 E6E8 C37DE4          10  _WTTRK: JP  WTTRK
002075 E6EB C309CC          10  _FDRD:  JP  FDRD
002078 E6EE C37DE4          10  _FDWT:  JP  FDWT
       E6F1                     _BPB2DPB:
00207B E6F1 C328E2          10      JP  BPB2DPB
       E6F4                     _BREAK:
00207E E6F4 C327CE          10      JP  END_BATCH
       E6F7                     _GNCL:
002081 E6F7 C30AE1          10      JP  GNCL        ; self-modifying code
       E6F8                     GNCPAT  EQU $-2
       E6FA                     _SNCL:
002084 E6FA C32DE1          10      JP  SNCL        ; self-modifying code
       E6FB                     SNCPAT  EQU $-2
       E6FD                     _COMANL:
002087 E6FD C3E0CC          10      JP  COMANL
                                
       E700                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       E700                     STABLE:
                                ;0
00208A E700 03E6A9D3DAD3C8D8        DW  _SYS00,_SYS01,_SYS02,_SYS03
002092 E708 08D108D1E0D309E6        DW  _SYS04,_SYS05,_SYS06,_SYS07
00209A E710 E8D30AD16CD400D5        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
0020A2 E718 1FD124D133D144D1        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
0020AA E720 98D1DFD128D259D2        DW  _SYS10,_SYS11,_SYS12,_SYS13
0020B2 E728 61D277D28CD284D2        DW  _SYS14,_SYS15,_SYS16,_SYS17
0020BA E730 D3D2D8D2DDD2E3D2        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
0020C2 E738 08D109D308D10DD3        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
0020CA E740 08D1C3D2CBD214D3        DW  _SYS20,_SYS21,_SYS22,_SYS23
0020D2 E748 39D308D11EDDECDD        DW  _SYS24,_ERROR,_SYS26,_SYS27
0020DA E750 CBD243D312D5C8D8        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
0020E2 E758 62D5C8D808D164D3        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
0020EA E760 5ED308D108D108D1        DW  _SYS30,_ERROR,_ERROR,_ERROR
0020F2 E768 08D108D108D108D1        DW  _ERROR,_ERROR,_ERROR,_ERROR
0020FA E770 08D1C8D8C8D885D3        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
002102 E778 EBD0                    DW  _DOS2
                                
002104 E77A                         DS  1
       E77B                     _MAX_SEC_SZ_H:
002105 E77B 02                      DB  MAX_SEC_SZ_H
                                
                                ;   FATバッファのアドレス
       E77C                     _FATBF:
002106 E77C 00E9                    DW  FATBF
                                
                                ;   データバッファのアドレス
       E77E                     _DTBUF:
002108 E77E 00EF                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       E780                     CTRLTB:
00210A E780 00000000ADD50000        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
002112 E788 0000000000000000        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
00211A E790 0000000000000000        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
002122 E798 0000000000000000        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
00212A E7A0 0000000000000000        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
002132 E7A8 0000000000000000        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
00213A E7B0 0000000000000000        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
002142 E7B8 0000000000000000        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
                                ;   2D/2DDでBPBがない場合のデフォルト値(2D/360KB/9セクタ1024バイト)
00214A E7C0 0200                M2D:    DW  2
00214C E7C2 FD02                    DB  0FDH,2
00214E E7C4 6401                    DW  356
002150 E7C6 FF0728090182            DB  0FFH,7,40,9,1,082H
002156 E7CC 0500A7000800            DW  5,0A7H,8
                                
                                ;   2HDでBPBがない場合のデフォルト値(2HD/1.23MB/8セクタ1024バイト)
00215C E7D2 0200                M2HD:   DW  2
00215E E7D4 FE01                    DB  0FEH,1
002160 E7D6 C704                    DW  1223
002162 E7D8 FE064D080184            DB  0FEH,6,77,8,1,084H
002168 E7DE 0500A7000900            DW  5,0A7H,9
                                
                                ;   ディレクトリエントリとFCBの変換テーブル(日付+時刻+サイズ)
00216E E7E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
002170 E7E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
002172 E7E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
002174 E7EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       E7EE                     SDDATAE:
                                
002178 E7EE                         DS  2
                                
                                ;   バッチファイルのFCB
       E7F0                     _FCB_BAT:
00217A E7F0 67E5                    DW  FCB_BAT
       E7F2                     _PATH:
00217C E7F2 06E5                    DW  PATHD
                                
00217E E7F4                     SCDIR:  DS  2       ;+14 +15
002180 E7F6                     SFBPS:  DS  2       ;FBPS
002182 E7F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
002184 E7FA 0000                _FATPS: DW  0
002186 E7FC 0000                _DIRPS: DW  0
002188 E7FE 0000                _CLPS:  DW  0
                                
       E800                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "MSXDPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MSX
                                
       E800                     _DEVICE:
                                
                                ;   A:
                                
00218A E800 0300                    DW  3   ;DPB_FATLN
00218C E802 EBE6                    DW  _FDRD   ;DPB_DRD
00218E E804 EEE6                    DW  _FDWT   ;DPB_DWT
002190 E806 F9                      DB  0F9H    ;DPB_FATID
002191 E807 03                      DB  3   ;DPB_SECPCL
002192 E808 CB02                    DW  715 ;DPB_MAXCL
002194 E80A 00                      DB  0   ;DPB_FDMODE
002195 E80B 07                      DB  7   ;DPB_DIRSCNT
002196 E80C 01                      DB  1   ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002197 E80D 00                      DB  0   ;DPB_MAXSEC
002198 E80E 01                      DB  1   ;DPB_FATPS
002199 E80F 82                      DB  082H    ;DPB_BPS
00219A E810 0700                    DW  7   ;DPB_DIRPS
00219C E812 2E                      DB  02EH    ;DPB_DEVICE
00219D E813 00                      DB  0   ;DPB_UNITNO
00219E E814 0A00                    DW  10  ;DPB_ADDCL
0021A0 E816 0000                    DW  0   ;DPB_16
0021A2 E818 0000                    DW  0   ;DPB_18
0021A4 E81A 0000                    DW  0   ;DPB_SDIR
0021A6 E81C 524F4D30                DB  "ROM0"  ;DPB_NAME
                                
                                ;   B:
                                
0021AA E820 0300                    DW  3   ;DPB_FATLN
0021AC E822 EBE6                    DW  _FDRD   ;DPB_DRD
0021AE E824 EEE6                    DW  _FDWT   ;DPB_DWT
0021B0 E826 F9                      DB  0F9H    ;DPB_FATID
0021B1 E827 03                      DB  3   ;DPB_SECPCL
0021B2 E828 CB02                    DW  715 ;DPB_MAXCL
0021B4 E82A 00                      DB  0   ;DPB_FDMODE
0021B5 E82B 07                      DB  7   ;DPB_DIRSCNT
0021B6 E82C 2E                      DB  46  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
0021B7 E82D 00                      DB  0   ;DPB_MAXSEC
0021B8 E82E 01                      DB  1   ;DPB_FATPS
0021B9 E82F 82                      DB  082H    ;DPB_BPS
0021BA E830 0700                    DW  7   ;DPB_DIRPS
0021BC E832 2E                      DB  02EH    ;DPB_DEVICE
0021BD E833 01                      DB  1   ;DPB_UNITNO
0021BE E834 0A00                    DW  10  ;DPB_ADDCL
0021C0 E836 0000                    DW  0   ;DPB_16
0021C2 E838 0000                    DW  0   ;DPB_18
0021C4 E83A 0000                    DW  0   ;DPB_SDIR
0021C6 E83C 524F4D31                DB  "ROM1"  ;DPB_NAME
                                
                                ;   C:
                                
0021CA E840                         DS  32
                                
                                ;   D:
                                
0021EA E860                         DS  32
                                
                                ;   E:
                                
00220A E880 0300                    DW  3   ;DPB_FATLN
00220C E882 ADE4                    DW  PDRD    ;DPB_DRD
00220E E884 7FE4                    DW  PDWT    ;DPB_DWT
002210 E886 F9                      DB  0F9H    ;DPB_FATID
002211 E887 03                      DB  3   ;DPB_SECPCL
002212 E888 CB02                    DW  715 ;DPB_MAXCL
002214 E88A FF                      DB  0FFH    ;DPB_FDMODE
002215 E88B 07                      DB  7   ;DPB_DIRSCNT
002216 E88C 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002217 E88D 09                      DB  9   ;DPB_MAXSEC
002218 E88E 01                      DB  1   ;DPB_FATPS
002219 E88F 82                      DB  082H    ;DPB_BPS
00221A E890 0700                    DW  7   ;DPB_DIRPS
00221C E892 2D                      DB  02DH    ;DPB_DEVICE
00221D E893 00                      DB  0   ;DPB_UNITNO
00221E E894 0A00                    DW  10  ;DPB_ADDCL
002220 E896 0000                    DW  0   ;DPB_16
002222 E898 0000                    DW  0   ;DPB_18
002224 E89A 0000                    DW  0   ;DPB_SDIR
002226 E89C 44534B30                DB  "DSK0"  ;DPB_NAME
                                
                                ;   F:
                                
00222A E8A0 0300                    DW  3   ;DPB_FATLN
00222C E8A2 ADE4                    DW  PDRD    ;DPB_DRD
00222E E8A4 7FE4                    DW  PDWT    ;DPB_DWT
002230 E8A6 F9                      DB  0F9H    ;DPB_FATID
002231 E8A7 03                      DB  3   ;DPB_SECPCL
002232 E8A8 CB02                    DW  715 ;DPB_MAXCL
002234 E8AA FF                      DB  0FFH    ;DPB_FDMODE
002235 E8AB 07                      DB  7   ;DPB_DIRSCNT
002236 E8AC 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002237 E8AD 09                      DB  9   ;DPB_MAXSEC
002238 E8AE 01                      DB  1   ;DPB_FATPS
002239 E8AF 82                      DB  082H    ;DPB_BPS
00223A E8B0 0700                    DW  7   ;DPB_DIRPS
00223C E8B2 2D                      DB  02DH    ;DPB_DEVICE
00223D E8B3 01                      DB  1   ;DPB_UNITNO
00223E E8B4 0A00                    DW  10  ;DPB_ADDCL
002240 E8B6 0000                    DW  0   ;DPB_16
002242 E8B8 0000                    DW  0   ;DPB_18
002244 E8BA 0000                    DW  0   ;DPB_SDIR
002246 E8BC 44534B31                DB  "DSK1"  ;DPB_NAME
                                
                                ;   G:
                                
00224A E8C0 0300                    DW  3   ;DPB_FATLN
00224C E8C2 ADE4                    DW  PDRD    ;DPB_DRD
00224E E8C4 7FE4                    DW  PDWT    ;DPB_DWT
002250 E8C6 F9                      DB  0F9H    ;DPB_FATID
002251 E8C7 03                      DB  3   ;DPB_SECPCL
002252 E8C8 CB02                    DW  715 ;DPB_MAXCL
002254 E8CA FF                      DB  0FFH    ;DPB_FDMODE
002255 E8CB 07                      DB  7   ;DPB_DIRSCNT
002256 E8CC 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002257 E8CD 09                      DB  9   ;DPB_MAXSEC
002258 E8CE 01                      DB  1   ;DPB_FATPS
002259 E8CF 82                      DB  082H    ;DPB_BPS
00225A E8D0 0700                    DW  7   ;DPB_DIRPS
00225C E8D2 2D                      DB  02DH    ;DPB_DEVICE
00225D E8D3 02                      DB  2   ;DPB_UNITNO
00225E E8D4 0A00                    DW  10  ;DPB_ADDCL
002260 E8D6 0000                    DW  0   ;DPB_16
002262 E8D8 0000                    DW  0   ;DPB_18
002264 E8DA 0000                    DW  0   ;DPB_SDIR
002266 E8DC 44534B32                DB  "DSK2"  ;DPB_NAME
                                
                                ;   H:
00226A E8E0 0300                    DW  3   ;DPB_FATLN
00226C E8E2 ADE4                    DW  PDRD    ;DPB_DRD
00226E E8E4 7FE4                    DW  PDWT    ;DPB_DWT
002270 E8E6 F9                      DB  0F9H    ;DPB_FATID
002271 E8E7 03                      DB  3   ;DPB_SECPCL
002272 E8E8 CB02                    DW  715 ;DPB_MAXCL
002274 E8EA FF                      DB  0FFH    ;DPB_FDMODE
002275 E8EB 07                      DB  7   ;DPB_DIRSCNT
002276 E8EC 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002277 E8ED 09                      DB  9   ;DPB_MAXSEC
002278 E8EE 01                      DB  1   ;DPB_FATPS
002279 E8EF 82                      DB  082H    ;DPB_BPS
00227A E8F0 0700                    DW  7   ;DPB_DIRPS
00227C E8F2 2D                      DB  02DH    ;DPB_DEVICE
00227D E8F3 07                      DB  7   ;DPB_UNITNO
00227E E8F4 0A00                    DW  10  ;DPB_ADDCL
002280 E8F6 0000                    DW  0   ;DPB_16
002282 E8F8 0000                    DW  0   ;DPB_18
002284 E8FA 0000                    DW  0   ;DPB_SDIR
002286 E8FC 44534B37                DB  "DSK7"  ;DPB_NAME
       E900                     MSX_E:
[EOF:MSXDPB.ASM:UTF_8]
                                
00228A E900                         DS  03FFFH - $$
003FFF 0675 00                      DB  0
       0676                     LAST_ADR:
                                
                                    END
[EOF:MSX.ASM:UTF_8]
