                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "MSXDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       0003                     MAC EQU 3   ;MSX
       0001                     DEV EQU 1
                                
       001D                     VER_6F  EQU 0001DH
                                
       4000                     RUN EQU 04000H
                                
       C900                     START2  EQU 0C900H
       CC06                     BDOS    EQU 0CC06H
       E600                     WORKAD  EQU 0E600H
       E900                     FATBF   EQU 0E900H
       EF00                     DTBUF   EQU 0EF00H
       0028                     WIDTH   EQU 40
       0018                     LINE    EQU 24
       0000                     COLORF  EQU 0
       0000                     KEYSP_H EQU 0
       0000                     KEYSP_L EQU 0
       0008                     COMS    EQU 8
       0002                     MAX_SEC_SZ_H    EQU 2       ;1セクタ1024バイトのサポート(2:off 4:on)
       8000                     BUFFER  EQU 08000H
       0100                     BUF_COM EQU 00100H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
                                
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       006C                     INITXT  EQU 0006CH
       0078                     SETTXT  EQU 00078H
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00AE                     PINLIN  EQU 000AEH
       00B1                     INLIN   EQU 000B1H
       00B4                     QINLIN  EQU 000B4H
       00B7                     BREAKX  EQU 000B7H
       00C0                     BEEP    EQU 000C0H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0144                     PHYDIO  EQU 00144H  ;MAIN:BIOS:
       0156                     KILBUF  EQU 00156H
                                
       01F5                     REDCLK  EQU 001F5H  ;SUB
       01F9                     WRTCLK  EQU 001F9H  ;SUB
                                
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
       F3AE                     LINL40  EQU 0F3AEH
       F3B0                     LINLEN  EQU 0F3B0H
       F3DC                     CSRY    EQU 0F3DCH
       F3DD                     CSRX    EQU 0F3DDH
                                
       F41F                     KBUF    EQU 0F41FH; 318
                                
       F55E                     BUF EQU 0F55EH
                                
       FAF8                     EXBRSA  EQU 0FAF8H
                                
       FBCA                     FSTPOS  EQU 0FBCAH
                                
       FC9B                     INTFLG  EQU 0FC9BH
       FCC1                     EXPTBL  EQU 0FCC1H
       FCC5                     SLTTBL  EQU 0FCC5H
                                
       FEDA                     H_STKE  EQU 0FEDAH
       FFA7                     H_PHYD  EQU 0FFA7H
                                
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU 06000H
       6800                     BANK1_SEL EQU 06800H
       7000                     BANK2_SEL EQU 07000H
       7800                     BANK3_SEL EQU 07800H
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       8000                     KONAMI_BANK2_SEL EQU 08000H
       A000                     KONAMI_BANK3_SEL EQU 0A000H
                                
       F55D                     SPBUF   EQU KBUF+318
[EOF:MSXDEF.ASM:UTF_8]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0002                     VER_3   EQU 2
       1D03                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0103                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0162                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 1942                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
                                    INCLUDE "MSXFDIPL.ASM"
                                ;   LSX-Dodgers FDIPL
                                ;   MSX
000010 4010 186E            12      JR  INIT_FDD_BOOT
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
       4080                     INIT_FDD_BOOT:
000080 4080 F3               4      DI
000081 4081 ED56             8      IM  1
000083 4083 3A42F3          13      LD  A,(RAMAD1)
000086 4086 2640             7      LD  H,040H
000088 4088 CD2400          17      CALL    _ENASLT
00008B 408B 218A82          10      LD  HL,AT_START2+04000H
00008E 408E 1100C9          10      LD  DE,START2
000091 4091 010020          10      LD  BC,MSX_E-START2
000094 4094 EDB0                    LDIR
000096 4096 2180E8          10      LD  HL,_DEVICE+4*32     ;E
000099 4099 1100E8          10      LD  DE,_DEVICE      ;A
00009C 409C 018000          10      LD  BC,32*4
00009F 409F EDB0                    LDIR
0000A1 40A1 21DFE8          10      LD  HL,_DEVICE+6*32+DPB_NAME+3
0000A4 40A4 3E07             7      LD  A,7
       40A6                     FDD_INIT1:
0000A6 40A6 C62F             7      ADD A,'0'-1
0000A8 40A8 77               7      LD  (HL),A
0000A9 40A9 11F4FF          10      LD  DE,DPB_UNITNO-(DPB_NAME+3)
0000AC 40AC 19              11      ADD HL,DE
0000AD 40AD D630             7      SUB '0'
0000AF 40AF 77               7      LD  (HL),A
0000B0 40B0 11ECFF          10      LD  DE,-DPB_UNITNO-1
0000B3 40B3 19              11      ADD HL,DE       ;ここでZフラグは変化しない
0000B4 40B4 20F0            12      JR  NZ,FDD_INIT1
0000B6 40B6 218040          10      LD  HL,INIT_FDD_BOOT
                                
0000B9 40B9 CD05CA          17      CALL    SET_BDOS
0000BC 40BC 21E5C9          10      LD  HL,ROMCHECKED
0000BF 40BF 2204C9          16      LD  (INIT_SWC),HL
0000C2 40C2 3EC3             7      LD  A,0C3H      ;JP
0000C4 40C4 329BCC          13      LD  (FDD_BDOS_JP),A
0000C7 40C7 21D7D0          10      LD  HL,BDOS0
0000CA 40CA 229CCC          16      LD  (FDD_BDOS_ADR),HL
0000CD 40CD 219BCC          10      LD  HL,FDD_BDOS_JP
0000D0 40D0 220600          16      LD  (00006H),HL ;BDOS
0000D3 40D3 C300C9          10      JP  START2
[EOF:MSXFDIPL.ASM:UTF_8]
                                
0001BD 41BD                         ORG 041BDH
0001BD 41BD C9              10      RET
                                
                                    ;MBR_Partition1 (2DDのデータ)
0001BE 41BE 00                      DB  0       ;ブートフラグ
0001BF 41BF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001C2 41C2 01                      DB  1       ;識別子(FAT12)
0001C3 41C3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001C6 41C6 20000000                DW  32,0        ;パーティションの最初のセクタ番号(LBA方式)
0001CA 41CA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
                                    ;MBR_Partition2 (2DDのデータ)
0001CE 41CE 00                      DB  0       ;ブートフラグ
0001CF 41CF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001D2 41D2 01                      DB  1       ;識別子(FAT12)
0001D3 41D3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001D6 41D6 C0050000                DW  32+1440,0   ;パーティションの最初のセクタ番号(LBA方式)
0001DA 41DA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
0001FE 41FE                         ORG 041FEH
0001FE 41FE 55AA                    DB  055H,0AAH   ;MBR_Sig
                                
                                    INCLUDE "MSXINIT.ASM"
                                ;   LSX-Dodgers INIT
                                ;   MSX
       4200                     START:
000200 4200 F3               4      DI
000201 4201 ED56             8      IM  1
000203 4203 AF               4      XOR A               ;A=0
000204 4204 320060          13      LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
000207 4207 3C               4      INC A               ;A=1
000208 4208 320068          13      LD  (BANK1_SEL),A
00020B 420B 218A42          10      LD  HL,AT_START2
00020E 420E 1100C9          10      LD  DE,START2
000211 4211 010020          10      LD  BC,MSX_E-START2
000214 4214 EDB0                    LDIR
000216 4216 C300C9          10      JP  START2
                                
       4219                     INIT_ROM:
000219 4219 3E                      DB  03EH    ;LD A,??
00021A 421A F7              12      RST 30H
00021B 421B F3               4      DI
00021C 421C 32DAFE          13      LD  (H_STKE),A
00021F 421F CD6642          17      CALL    GTSL1_
000222 4222 21DBFE          10      LD  HL,H_STKE+1
000225 4225 77               7      LD  (HL),A
000226 4226 110042          10      LD  DE,START
000229 4229 23               6      INC HL
00022A 422A 73               7      LD  (HL),E
00022B 422B 23               6      INC HL
00022C 422C 72               7      LD  (HL),D
                                
00022D 422D CD3801          17      CALL    RSLREG      ;read primary slot #
000230 4230 07               4      RLCA
000231 4231 07               4      RLCA
000232 4232 F5              11      PUSH    AF
000233 4233 1605             7      LD  D,4+1
000235 4235 CD6D42          17      CALL    GTSL2_
000238 4238 3244F3          13      LD  (RAMAD3),A
00023B 423B 3A42F3          13      LD  A,(RAMAD1)
00023E 423E CD5842          17      CALL    FIXRAMAD
000241 4241 3242F3          13      LD  (RAMAD1),A
000244 4244 3A41F3          13      LD  A,(RAMAD0)
000247 4247 CD5842          17      CALL    FIXRAMAD
00024A 424A 3241F3          13      LD  (RAMAD0),A
00024D 424D F1              10      POP AF
00024E 424E 1603             7      LD  D,2+1
000250 4250 CD6D42          17      CALL    GTSL2_
000253 4253 3243F3          13      LD  (RAMAD2),A
                                
000256 4256 FB               4      EI
000257 4257 C9              10      RET
                                
       4258                     FIXRAMAD:
000258 4258 B7               4      OR  A
000259 4259 2807            12      JR  Z,FIXRAMAD1
00025B 425B FEC9             7      CP  0C9H
00025D 425D 2803            12      JR  Z,FIXRAMAD1
00025F 425F FEFF             7      CP  0FFH
000261 4261 C0              11      RET NZ
       4262                     FIXRAMAD1:
000262 4262 3A44F3          13      LD  A,(RAMAD3)
000265 4265 C9              10      RET
                                
       4266                     GTSL1_:             ;自分のいるスロットを知る
000266 4266 CD3801          17      CALL    RSLREG      ;read primary slot #
000269 4269 0F               4      RRCA
00026A 426A 0F               4      RRCA
00026B 426B 1601             7      LD  D,1
       426D                     GTSL2_:
00026D 426D E603             7      AND 3       ;[A]=000000PP
00026F 426F 5F               4      LD  E,A     ;[E]=000000PP
000270 4270 21C1FC          10      LD  HL,EXPTBL
000273 4273 85               4      ADD A,L     ;桁上りは無い
000274 4274 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000275 4275 7B               4      LD  A,E     ;[A]=000000PP
000276 4276 CB7E            13      BIT 7,(HL)
000278 4278 C8              11      RET Z
000279 4279 7D               4      LD  A,L     ;point to SLTTBL entry
00027A 427A C604             7      ADD A,4     ;桁上りは無い
00027C 427C 6F               4      LD  L,A
00027D 427D 7E               7      LD  A,(HL)      ;get currently expansion slot register
       427E                     GTSL3_:
00027E 427E 15               4      DEC D
00027F 427F 2803            12      JR  Z,GTSL4_:
000281 4281 0F               4      RRCA
000282 4282 18FA            12      JR  GTSL3_:
       4284                     GTSL4_:
000284 4284 E60C             7      AND 00CH        ;[A] = 0000SS00
000286 4286 B3               4      OR  E       ;[A] = 0000SSPP
000287 4287 F680             7      OR  080H        ;[A] = 1000SSPP
000289 4289 C9              10      RET
                                
       428A                     AT_START2:
00028A C900                         ORG START2,AT_START2-RUN
                                
00028A C900 3100C9          10      LD  SP,START2
00028D C903 CD11C9          17      CALL    INIT        ;NZならAUTOEXECを実行
       C904                     INIT_SWC    EQU $-2
000290 C906 210000          10      LD  HL,0
000293 C909 E5              11      PUSH    HL
000294 C90A C8              11      RET Z
000295 C90B 11FACA          10      LD  DE,AUTOD
000298 C90E C3FDE6          10      JP  _COMANL
                                
       C911                     INIT:
00029B C911 DD21900D        14      LD  IX,0D90H
00029F C915 0600             7      LD  B,0
       C917                     CHECK_CBIOS1:
0002A1 C917 DD7E00          19      LD  A,(IX+0)
0002A4 C91A FE43             7      CP  'C'
0002A6 C91C 202B            12      JR  NZ,CHECK_CBIOS2
0002A8 C91E DD7E01          19      LD  A,(IX+1)
0002AB C921 FE2D             7      CP  '-'
0002AD C923 2024            12      JR  NZ,CHECK_CBIOS2
0002AF C925 DD7E02          19      LD  A,(IX+2)
0002B2 C928 FE42             7      CP  'B'
0002B4 C92A 201D            12      JR  NZ,CHECK_CBIOS2
0002B6 C92C DD7E03          19      LD  A,(IX+3)
0002B9 C92F FE49             7      CP  'I'
0002BB C931 2016            12      JR  NZ,CHECK_CBIOS2
0002BD C933 DD7E04          19      LD  A,(IX+4)
0002C0 C936 FE4F             7      CP  'O'
0002C2 C938 200F            12      JR  NZ,CHECK_CBIOS2
0002C4 C93A DD7E05          19      LD  A,(IX+5)
0002C7 C93D EE53             7      XOR 'S'
0002C9 C93F 2008            12      JR  NZ,CHECK_CBIOS2
                                
0002CB C941 3228D4          13      LD  (CBIOS_SWC1),A
0002CE C944 324CD4          13      LD  (CBIOS_SWC2),A
                                
0002D1 C947 1804            12      JR  CHECK_CBIOS3
       C949                     CHECK_CBIOS2:
0002D3 C949 DD23            10      INC IX
0002D5 C94B 10CA            13      DJNZ    CHECK_CBIOS1
       C94D                     CHECK_CBIOS3:
0002D7 C94D 3ADBFE          13      LD  A,(H_STKE+1)
0002DA C950 3262E6          13      LD  (ROM_SLT),A
                                
       C953                     RAMCHK2:
0002DD C953 3A42F3          13      LD  A,(RAMAD1)
0002E0 C956 2640             7      LD  H,040H
0002E2 C958 CD5ECA          17      CALL    CHK_RAM
0002E5 C95B 3242F3          13      LD  (RAMAD1),A
       C95E                     RAMCHK1:
0002E8 C95E 3A41F3          13      LD  A,(RAMAD0)
0002EB C961 2600             7      LD  H,00H
0002ED C963 CD5ECA          17      CALL    CHK_RAM
0002F0 C966 3241F3          13      LD  (RAMAD0),A
       C969                     RAMCHK0:
0002F3 C969 3A42F3          13      LD  A,(RAMAD1)
0002F6 C96C CD11D7          17      CALL    ENASLT_40H
                                
0002F9 C96F 3A41F3          13      LD  A,(RAMAD0)
0002FC C972 CDD8D6          17      CALL    ENASLT_00H
                                
0002FF C975 210000          10      LD  HL,0
000302 C978 065C             7      LD  B,05CH
000304 C97A 3E                      DB  03EH    ;LD A,??
000305 C97B EF              12      RST 28H
000306 C97C CD34D8          17      CALL    FILL_MEMORY
000309 C97F 06A4             7      LD  B,0A4H
00030B C981 AF               4      XOR A
00030C C982 320400          13      LD  (_DVSW),A
00030F C985 CD34D8          17      CALL    FILL_MEMORY
                                
000312 C988 CD05CA          17      CALL    SET_BDOS
                                
                                                ;LSX-Dodgers
000315 C98B 3EE6             7      LD  A,CPM_BOOT/256
000317 C98D 320B00          13      LD  (0000BH),A
                                
                                                ;MSXワークエリア
00031A C990 3E03             7      LD  A,3
00031C C992 329BFC          13      LD  (INTFLG),A
                                
                                                ;ROMタイプ判別(ASCII-8K/ASCII-16K)
00031F C995 1E00             7      LD  E,0
000321 C997 3A62E6          13      LD  A,(ROM_SLT)
000324 C99A 210068          10      LD  HL,BANK1_SEL
000327 C99D CD1400          17      CALL    _WRSLT
                                
00032A C9A0 210060          10      LD  HL,06000H
00032D C9A3 3A62E6          13      LD  A,(ROM_SLT)
000330 C9A6 CD0C00          17      CALL    _RDSLT
000333 C9A9 FE41             7      CP  'A'
000335 C9AB 280F            12      JR  Z,ROM8K
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K)
000337 C9AD 3E                      DB  03EH    ;LD A,??
000338 C9AE 00               4      NOP
000339 C9AF 322ECC          13      LD  (ASCII16K1),A
00033C C9B2 3232CC          13      LD  (ASCII16K2),A
00033F C9B5 3E3F             7      LD  A,03FH
000341 C9B7 324BCC          13      LD  (ASCII16K3),A
000344 C9BA 1829            12      JR  ROMCHECKED
       C9BC                     ROM8K:              ;Konami-8Kチェック
000346 C9BC 1E01             7      LD  E,1
000348 C9BE 3A62E6          13      LD  A,(ROM_SLT)
00034B C9C1 210070          10      LD  HL,BANK2_SEL
00034E C9C4 CD1400          17      CALL    _WRSLT
                                
000351 C9C7 1E00             7      LD  E,0
000353 C9C9 3A62E6          13      LD  A,(ROM_SLT)
000356 C9CC 210080          10      LD  HL,KONAMI_BANK2_SEL
000359 C9CF CD1400          17      CALL    _WRSLT
                                
00035C C9D2 210080          10      LD  HL,08000H
00035F C9D5 3A62E6          13      LD  A,(ROM_SLT)
000362 C9D8 CD0C00          17      CALL    _RDSLT
000365 C9DB FE41             7      CP  'A'
000367 C9DD 2006            12      JR  NZ,ROMCHECKED
                                                ;Konami-8K
000369 C9DF 210080          10      LD  HL,KONAMI_BANK2_SEL
00036C C9E2 2239CC          16      LD  (ROM8000H),HL
       C9E5                     ROMCHECKED:
                                
00036F C9E5 3E28             7      LD  A,40
000371 C9E7 32AEF3          13      LD  (LINL40),A
000374 C9EA 32B1E6          13      LD  (_WIDTH),A
000377 C9ED DD216C00        14      LD  IX,INITXT
00037B C9F1 CD1DD6          17      CALL    CALSLT_R
00037E C9F4 DD217800        14      LD  IX,SETTXT
000382 C9F8 CD1DD6          17      CALL    CALSLT_R
                                
000385 C9FB 2106CB          10      LD  HL,INIMES
000388 C9FE CD17D1          17      CALL    MSX
       CA01                     INIT1:
00038B CA01 AF               4      XOR A
00038C CA02 FE03             7      CP  3
00038E CA04 C9              10      RET
       CA05                     SET_BDOS:
00038F CA05 3E                      DB  03EH    ;LD A,??
000390 CA06 E9               4      JP  (HL)
000391 CA07 320F00          13      LD  (0000FH),A
                                
000394 CA0A 3EC3             7      LD  A,0C3H      ;JP
000396 CA0C 2103E6          10      LD  HL,CPM_WBOOT
000399 CA0F 320000          13      LD  (00000H),A
00039C CA12 220100          16      LD  (00001H),HL ;IPL
                                
00039F CA15 2106CC          10      LD  HL,BDOS
0003A2 CA18 320500          13      LD  (00005H),A
0003A5 CA1B 220600          16      LD  (00006H),HL ;BDOS
                                
0003A8 CA1E 210000          10      LD  HL,0
0003AB CA21 322800          13      LD  (00028H),A
0003AE CA24 222900          16      LD  (00029H),HL ;BDOS
                                                ;インタースロットコール
0003B1 CA27 217DD6          10      LD  HL,RDSLT
0003B4 CA2A 320C00          13      LD  (_RDSLT),A
0003B7 CA2D 220D00          16      LD  (_RDSLT+1),HL
                                
0003BA CA30 218BD6          10      LD  HL,WRSLT
0003BD CA33 321400          13      LD  (_WRSLT),A
0003C0 CA36 221500          16      LD  (_WRSLT+1),HL
                                
0003C3 CA39 213BD6          10      LD  HL,CALSLT
0003C6 CA3C 321C00          13      LD  (_CALSLT),A
0003C9 CA3F 221D00          16      LD  (_CALSLT+1),HL
                                
0003CC CA42 21D0D6          10      LD  HL,ENASLT
0003CF CA45 322400          13      LD  (_ENASLT),A
0003D2 CA48 222500          16      LD  (_ENASLT+1),HL
                                
0003D5 CA4B 212BD6          10      LD  HL,CALLF
0003D8 CA4E 323000          13      LD  (_CALLF),A
0003DB CA51 223100          16      LD  (_CALLF+1),HL
                                
0003DE CA54 213FD7          10      LD  HL,INT38H
0003E1 CA57 323800          13      LD  (00038H),A
0003E4 CA5A 223900          16      LD  (00038H+1),HL
0003E7 CA5D C9              10      RET
       CA5E                     CHK_RAM:
0003E8 CA5E E5              11      PUSH    HL
0003E9 CA5F CDB3CA          17      CALL    CHK_RAM0
0003EC CA62 E1              10      POP HL
0003ED CA63 C8              11      RET Z
0003EE CA64 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
0003F1 CA67 E680             7      AND 080H
0003F3 CA69 CD8ACA          17      CALL    CHK_RAM_SLT
0003F6 CA6C C8              11      RET Z
0003F7 CA6D 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
0003FA CA70 E680             7      AND 080H
0003FC CA72 C601             7      ADD A,1
0003FE CA74 CD8ACA          17      CALL    CHK_RAM_SLT
000401 CA77 C8              11      RET Z
000402 CA78 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000405 CA7B E680             7      AND 080H
000407 CA7D C602             7      ADD A,2
000409 CA7F CD8ACA          17      CALL    CHK_RAM_SLT
00040C CA82 C8              11      RET Z
00040D CA83 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000410 CA86 E680             7      AND 080H
000412 CA88 C603             7      ADD A,3
       CA8A                     CHK_RAM_SLT:
000414 CA8A E5              11      PUSH    HL
000415 CA8B CDB3CA          17      CALL    CHK_RAM0        ;スロット#X or X-0
000418 CA8E E1              10      POP HL
000419 CA8F C8              11      RET Z
00041A CA90 CB79             8      BIT 7,C
00041C CA92 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
00041E CA94 79               4      LD  A,C
00041F CA95 C604             7      ADD A,4*1           ;スロット#X-1
000421 CA97 E5              11      PUSH    HL
000422 CA98 CDB3CA          17      CALL    CHK_RAM0
000425 CA9B E1              10      POP HL
000426 CA9C C8              11      RET Z
000427 CA9D 79               4      LD  A,C
000428 CA9E C608             7      ADD A,4*2           ;スロット#X-2
00042A CAA0 E5              11      PUSH    HL
00042B CAA1 CDB3CA          17      CALL    CHK_RAM0
00042E CAA4 E1              10      POP HL
00042F CAA5 C8              11      RET Z
000430 CAA6 79               4      LD  A,C
000431 CAA7 C60C             7      ADD A,4*3           ;スロット#X-3
000433 CAA9 E5              11      PUSH    HL
000434 CAAA CDB3CA          17      CALL    CHK_RAM0
000437 CAAD E1              10      POP HL
       CAAE                     CHK_RAM_E:
000438 CAAE AF               4      XOR A
000439 CAAF 3C               4      INC A           ;ZF=0にする
00043A CAB0 3E00             7      LD  A,0
00043C CAB2 C9              10      RET
                                
       CAB3                     CHK_RAM0:
00043D CAB3 4F               4      LD  C,A
00043E CAB4 3A62E6          13      LD  A,(ROM_SLT)
000441 CAB7 B9               4      CP  C
000442 CAB8 28F4            12      JR  Z,CHK_RAM_E
000444 CABA 2E00             7      LD  L,0
       CABC                     CHK_RAM1:
000446 CABC 79               4      LD  A,C
000447 CABD DD210C00        14      LD  IX,_RDSLT
00044B CAC1 CDEECA          17      CALL    CALSLT_RAM
00044E CAC4 C6E5             7      ADD A,0E5H
000450 CAC6 47               4      LD  B,A
000451 CAC7 5F               4      LD  E,A
000452 CAC8 79               4      LD  A,C
000453 CAC9 DD211400        14      LD  IX,_WRSLT
000457 CACD CDEECA          17      CALL    CALSLT_RAM
00045A CAD0 79               4      LD  A,C
00045B CAD1 DD210C00        14      LD  IX,_RDSLT
00045F CAD5 CDEECA          17      CALL    CALSLT_RAM
000462 CAD8 B8               4      CP  B
000463 CAD9 C0              11      RET NZ
000464 CADA D6E5             7      SUB 0E5H
000466 CADC 79               4      LD  A,C
000467 CADD 5F               4      LD  E,A
000468 CADE DD211400        14      LD  IX,_WRSLT
00046C CAE2 CDEECA          17      CALL    CALSLT_RAM
00046F CAE5 24               4      INC H
000470 CAE6 7D               4      LD  A,L
000471 CAE7 C604             7      ADD A,4
000473 CAE9 6F               4      LD  L,A
000474 CAEA 20D0            12      JR  NZ,CHK_RAM1
000476 CAEC 79               4      LD  A,C     ;ZF=1のハズ
000477 CAED C9              10      RET
                                
       CAEE                     CALSLT_RAM:
000478 CAEE C5              11      PUSH    BC
000479 CAEF E5              11      PUSH    HL
00047A CAF0 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00047E CAF4 CD1C00          17      CALL    _CALSLT
000481 CAF7 E1              10      POP HL
000482 CAF8 C1              10      POP BC
000483 CAF9 C9              10      RET
                                
000484 CAFA 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
00048D CB03 413A00              AUTODV: DB  "A:",0
                                
000490 CB06 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MSX v"
            6765727320666F72    
            204D53582076        
0004A6 CB1C 312E                    DB  030H + VER_1, '.'
0004A8 CB1E 3632                    DB  030H + VER_2 ,030H + VER_3
0004AA CB20 61                      DB  'a'
0004AB CB21 2047616B750D0A          DB  " Gaku",0DH,0AH
0004B2 CB28 00                      DB  0
                                
0004B3 CB29 0300                M2DD:   DW  3
0004B5 CB2B F902                    DB  0F9H,2
0004B7 CB2D CB02                    DW  715
0004B9 CB2F FF0750090182            DB  0FFH,7,80,9,1,082H
0004BF CB35 0700A7000A00            DW  7,0A7H,10
       CB3B                     M2DDE:
                                
       CB3B                     INITE:
0004C5 CB3B                         DS  BDOS-INITE
000590 CC06 C3D7D0          10      JP  BDOS0
[EOF:MSXINIT.ASM:SHIFT_JIS]
                                    INCLUDE "MSXDISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MSX
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       CC09                     FDRD:
000593 CC09 ED739ACC        20      LD  (DRDSP),SP
000597 CC0D 3A9BCC          13      LD  A,(DRDSPH)  ;スタックがカートリッジと被っていないかチェック
00059A CC10 FE7F             7      CP  07FH
00059C CC12 3809            12      JR  C,FDRD1
00059E CC14 FEC1             7      CP  0C1H
0005A0 CC16 3005            12      JR  NC,FDRD1
0005A2 CC18 3E00             7      LD  A,0     ;BDOS0+13Hが外部から書き換えされても動くようにする
0005A4 CC1A 315DF5          10      LD  SP,SPBUF
       CC1D                     FDRD1:
0005A7 CC1D C5              11      PUSH    BC
0005A8 CC1E D5              11      PUSH    DE
                                
0005A9 CC1F E5              11      PUSH    HL
0005AA CC20 EB               4      EX  DE,HL
0005AB CC21 DD460F          19      LD  B,(IX+DPB_BPS)
       CC24                     EADR1:
0005AE CC24 CB18             8      RR  B
0005B0 CC26 3803            12      JR  C,EADR2
0005B2 CC28 29              11      ADD HL,HL
0005B3 CC29 18F9            12      JR  EADR1
       CC2B                     EADR2:
0005B5 CC2B E5              11      PUSH    HL  ;あとでDEで受け取る
0005B6 CC2C 29              11      ADD HL,HL   ;64KB→32KB
0005B7 CC2D 29              11      ADD HL,HL   ;32KB→16KB
       CC2E                     ASCII16K1:
0005B8 CC2E 29              11      ADD HL,HL   ;16KB→8KB  ;ASCII-16Kの場合はここがNOPに置き換えられる
                                
0005B9 CC2F DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;16KB単位でカートリッジ内のディスクが存在する位置を指定
       CC32                     ASCII16K2:
0005BC CC32 87               4      ADD A,A         ;ASCII-16Kの場合はここがNOPに置き換えられる
0005BD CC33 84               4      ADD A,H
0005BE CC34 5F               4      LD  E,A
0005BF CC35 3A62E6          13      LD  A,(ROM_SLT)
0005C2 CC38 210070          10      LD  HL,BANK2_SEL
       CC39                     ROM8000H    EQU $-2
0005C5 CC3B CD1400          17      CALL    _WRSLT
                                
0005C8 CC3E 3A62E6          13      LD  A,(ROM_SLT) ;カートリッジROMに切り替える
0005CB CC41 CD9AD6          17      CALL    ENASLT_80H
0005CE CC44 3279CC          13      LD  (DRDSLT_SWC),A
                                
0005D1 CC47 D1              10      POP DE
0005D2 CC48 E1              10      POP HL      ;HLは読み出し先のメモリアドレス
                                
0005D3 CC49 7B               4      LD  A,E
0005D4 CC4A E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F/16K:3F)
       CC4B                     ASCII16K3   EQU $-1
0005D6 CC4C 1E00             7      LD  E,0     ;DEはROMディスクから読み出すアドレス
0005D8 CC4E C680             7      ADD A,080H
0005DA CC50 57               4      LD  D,A
                                
0005DB CC51 3E                      DB  03EH
0005DC CC52 A7               4      AND A
0005DD CC53 327DCC          13      LD  (DRD_SWC3),A
0005E0 CC56 7C               4      LD  A,H     ;読み出し先がカートリッジと被っていないかチェック
0005E1 CC57 FE7B             7      CP  07BH
0005E3 CC59 3812            12      JR  C,DRD2
0005E5 CC5B FEC1             7      CP  0C1H
0005E7 CC5D 300E            12      JR  NC,DRD2
0005E9 CC5F 2284CC          16      LD  (DRD_SWC1),HL   ;被っている場合はデータバッファをフラッシュして一時的に使う
0005EC CC62 2A7EE7          16      LD  HL,(_DTBUF)
0005EF CC65 3E                      DB  03EH
0005F0 CC66 37               4      SCF
0005F1 CC67 327DCC          13      LD  (DRD_SWC3),A
0005F4 CC6A CDCFE4          17      CALL    FFLUSHBUF
       CC6D                     DRD2:
0005F7 CC6D DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
0005FA CC70 E607             7      AND 7
0005FC CC72 47               4      LD  B,A
0005FD CC73 4B               4      LD  C,E ;E=0
                                
0005FE CC74 EB               4      EX  DE,HL
0005FF CC75 EDB0                    LDIR
000601 CC77 D5              11      PUSH    DE
000602 CC78 3E00             7      LD  A,0 ;元に戻す
       CC79                     DRDSLT_SWC  EQU $-1
000604 CC7A CD9AD6          17      CALL    ENASLT_80H
       CC7D                     DRD_SWC3:
000607 CC7D A7               4      AND A       ;自己書き換え)被っている場合はSCFになる
000608 CC7E 3012            12      JR  NC,DRD3
                                
00060A CC80 2A7EE7          16      LD  HL,(_DTBUF)
00060D CC83 110000          10      LD  DE,0
       CC84                     DRD_SWC1    EQU $-2
000610 CC86 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
000613 CC89 E607             7      AND 7
000615 CC8B 47               4      LD  B,A
000616 CC8C 0E00             7      LD  C,0
000618 CC8E EDB0                    LDIR
00061A CC90 E1              10      POP HL
00061B CC91 D5              11      PUSH    DE
       CC92                     DRD3:
00061C CC92 E1              10      POP HL
00061D CC93 D1              10      POP DE
00061E CC94 13               6      INC DE
00061F CC95 C1              10      POP BC
000620 CC96 1085            13      DJNZ    FDRD1
000622 CC98 AF               4      XOR A
000623 CC99 310000          10      LD  SP,0
       CC9A                     DRDSP   EQU $-2
       CC9B                     DRDSPH  EQU $-1
000626 CC9C FB               4      EI
000627 CC9D C9              10      RET
                                
       CC9B                     FDD_BDOS_JP EQU $-3
       CC9C                     FDD_BDOS_ADR    EQU $-2
[EOF:MSXDISK.ASM:UTF_8]
                                    INCLUDE "MSXCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MSX
                                
       CC9E                     S27BUF_COM:
000628 CC9E 110001          10      LD  DE,BUF_COM
00062B CCA1 CDDBD2          17      CALL    _SYS1A      ;(BDOS)DTAの設定
00062E CCA4 2100FE          10      LD  HL,0-BUF_COM-00100H ;バッファー+スタック予備(0100H)
000631 CCA7 C37CCD          10      JP  S27BUF2
       CCAA                     WBOOT1:
000634 CCAA 3E03             7      LD  A,3
000636 CCAC 2A0600          16      LD  HL,(SYSTEM+1)   ;必ずBDOS0+13Hが「0」になるようにする ※ここはFDD起動時
000639 CCAF F9               6      LD  SP,HL
00063A CCB0 CDAAD3          17      CALL    MSG_A
       CCB3                     WBOOT2:
[EOF:MSXCCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       CCB3                     COMMAND:
00063D CCB3 3AC7E5          13      LD  A,(FCB_BAT)
000640 CCB6 B7               4      OR  A
000641 CCB7 C2F5CD          10      JP  NZ,C_BAT1
000644 CCBA CD69CD          17      CALL    SETDTA1
000647 CCBD 3A0400          13      LD  A,(_DVSW)
00064A CCC0 C641             7      ADD A,'A'
00064C CCC2 CDAAD3          17      CALL    MSG_A
00064F CCC5 3E3E             7      LD  A,'>'
000651 CCC7 CDAAD3          17      CALL    MSG_A
000654 CCCA 3E50             7      LD  A,80
000656 CCCC 12               7      LD  (DE),A
000657 CCCD CD6AD4          17      CALL    _SYS0A      ;(BDOS)文字列入力
00065A CCD0 CDEACE          17      CALL    LTNL
       CCD3                     COMMAND2:
00065D CCD3 118200          10      LD  DE,DTA1+2
000660 CCD6 CDFDE6          17      CALL    _COMANL
000663 CCD9 DC9BD3          17      CALL    C,SHOW_ERROR
000666 CCDC 18D5            12      JR  COMMAND
                                
       CCDE                     COMANL:
000668 CCDE CD89D7          17      CALL    FILE
00066B CCE1 3A19E6          13      LD  A,(FNAME+4)
00066E CCE4 FE20             7      CP  020H
000670 CCE6 201C            12      JR  NZ,COMB2
000672 CCE8 D5              11      PUSH    DE
000673 CCE9 1115E6          10      LD  DE,FNAME
000676 CCEC 1A               7      LD  A,(DE)
000677 CCED FE20             7      CP  020H
000679 CCEF 2844            12      JR  Z,SDVSW
00067B CCF1 1B               6      DEC DE
00067C CCF2 1A               7      LD  A,(DE)
00067D CCF3 C6FF             7      ADD A,0FFH
00067F CCF5 3809            12      JR  C,COMB
000681 CCF7 13               6      INC DE
                                
000682 CCF8 21A7D0          10      LD  HL,COMTB
000685 CCFB 0608             7      LD  B,COMS
000687 CCFD CD16DA          17      CALL    CPNAME
       CD00                     COMB:
00068A CD00 D1              10      POP DE
00068B CD01 D29AD3          10      JP  NC,JPHL
       CD04                     COMB2:
00068E CD04 EB               4      EX  DE,HL
00068F CD05 22D2CD          16      LD  (COMSWC),HL
000692 CD08 F5              11      PUSH    AF
000693 CD09 CD8ACD          17      CALL    CEXE4
000696 CD0C F1              10      POP AF
000697 CD0D 2115E6          10      LD  HL,FNAME
00069A CD10 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
00069D CD13 010B00          10      LD  BC,11
0006A0 CD16 EDB0                    LDIR
0006A2 CD18 1166E5          10      LD  DE,PATHD
       CD1B                     CEX1:
0006A5 CD1B 1A               7      LD  A,(DE)
0006A6 CD1C FE20             7      CP  020H
0006A8 CD1E D8              11      RET C
0006A9 CD1F CD7ED7          17      CALL    FILEC
0006AC CD22 D5              11      PUSH    DE
0006AD CD23 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
0006B0 CD26 1115E6          10      LD  DE,FNAME
0006B3 CD29 010B00          10      LD  BC,11
0006B6 CD2C EDB0                    LDIR
0006B8 CD2E CD8ACD          17      CALL    CEXE4
0006BB CD31 D1              10      POP DE
0006BC CD32 13               6      INC DE
0006BD CD33 18E6            12      JR  CEX1
                                
       CD35                     SDVSW:
0006BF CD35 F1              10      POP AF
0006C0 CD36 3A14E6          13      LD  A,(FDRV)
0006C3 CD39 3D               4      DEC A
0006C4 CD3A 5F               4      LD  E,A
0006C5 CD3B 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
0006C7 CD3D 1831            12      JR  SYSTEM0
                                
       CD3F                     OPEN1:
0006C9 CD3F 2114E6          10      LD  HL,FDRV
       CD42                     OPEN:
0006CC CD42 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       CD44                     OPEN3:
0006CE CD44 D5              11      PUSH    DE
0006CF CD45 11A2E5          10      LD  DE,DTA_CCP
0006D2 CD48 CD66CD          17      CALL    SETDTA
0006D5 CD4B EB               4      EX  DE,HL
0006D6 CD4C CD70CD          17      CALL    SYSTEM0
0006D9 CD4F D1              10      POP DE
0006DA CD50 C9              10      RET
                                
       CD51                     OPEN2:
0006DB CD51 0E12             7      LD  C,012H
0006DD CD53 18EF            12      JR  OPEN3
                                
       CD55                     DEFCB:              ;Z=Ok NZ=Error
0006DF CD55 11A2E5          10      LD  DE,DTA_CCP
0006E2 CD58 CD6ECD          17      CALL    SYSC0F
                                
0006E5 CD5B 11C3E5          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0006E8 CD5E 0604             7      LD  B,4
0006EA CD60 CDBBCF          17      CALL    ZERO_MEMORY_DE
       CD63                     SETDTA100:
0006ED CD63 110080          10      LD  DE,BUFFER
       CD66                     SETDTA:
0006F0 CD66 C3DBD2          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       CD69                     SETDTA1:
0006F3 CD69 118000          10      LD  DE,DTA1
0006F6 CD6C 18F8            12      JR  SETDTA
                                
       CD6E                     SYSC0F:
0006F8 CD6E 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       CD70                     SYSTEM0:
0006FA CD70 CD0500          17      CALL    SYSTEM
0006FD CD73 B7               4      OR  A
0006FE CD74 C9              10      RET
                                
       CD75                     C_CD:
0006FF CD75 0E5A             7      LD  C,05AH
000701 CD77 18F7            12      JR  SYSTEM0
                                
       CD79                     S27BUF:
000703 CD79 21007F          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       CD7C                     S27BUF2:
000706 CD7C 39              11      ADD HL,SP
000707 CD7D 2E00             7      LD  L,0
000709 CD7F 7C               4      LD  A,H
00070A CD80 E6F8             7      AND 0F8H
00070C CD82 67               4      LD  H,A
       CD83                     S27DTA:
00070D CD83 11A2E5          10      LD  DE,DTA_CCP
       CD86                     S27:
000710 CD86 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
000712 CD88 18E6            12      JR  SYSTEM0
                                
       CD8A                     CEXE4:
000714 CD8A 211DE6          10      LD  HL,FNAME+8
000717 CD8D 7E               7      LD  A,(HL)
000718 CD8E FE20             7      CP  020H
00071A CD90 2007            12      JR  NZ,CEXE7
00071C CD92 3E3F             7      LD  A,'?'
00071E CD94 77               7      LD  (HL),A
00071F CD95 23               6      INC HL
000720 CD96 77               7      LD  (HL),A
000721 CD97 23               6      INC HL
000722 CD98 77               7      LD  (HL),A
       CD99                     CEXE7:
000723 CD99 CD3FCD          17      CALL    OPEN1
       CD9C                     CEXE5:
000726 CD9C C0              11      RET NZ
000727 CD9D 2AACE5          16      LD  HL,(DTA_CCP+1+9)
00072A CDA0 7C               4      LD  A,H
00072B CDA1 CDA5DA          17      CALL    CAP
00072E CDA4 67               4      LD  H,A
00072F CDA5 7D               4      LD  A,L
000730 CDA6 CDA5DA          17      CALL    CAP
000733 CDA9 6F               4      LD  L,A
000734 CDAA 3AABE5          13      LD  A,(DTA_CCP+1+8)
000737 CDAD CDA5DA          17      CALL    CAP
00073A CDB0 D642             7      SUB 'B'
00073C CDB2 282C            12      JR  Z,C_BAT
00073E CDB4 3D               4      DEC A       ;'C'
00073F CDB5 2805            12      JR  Z,C_EXE
       CDB7                     CEXE6:
000741 CDB7 CD51CD          17      CALL    OPEN2
000744 CDBA 18E0            12      JR  CEXE5
                                
       CDBC                     C_EXE:
000746 CDBC 7C               4      LD  A,H
000747 CDBD FE4D             7      CP  'M'
000749 CDBF 20F6            12      JR  NZ,CEXE6
                                
00074B CDC1 CD55CD          17      CALL    DEFCB
00074E CDC4 CD9ECC          17      CALL    S27BUF_COM
000751 CDC7 3D               4      DEC A
000752 CDC8 37               4      SCF
000753 CDC9 C0              11      RET NZ
000754 CDCA 7C               4      LD  A,H
000755 CDCB B5               4      OR  L
000756 CDCC 37               4      SCF
000757 CDCD C8              11      RET Z
000758 CDCE CD69CD          17      CALL    SETDTA1
00075B CDD1 110000          10      LD  DE,0                ; self-modifying code
       CDD2                     COMSWC  EQU $-2
00075E CDD4 ED7B0600        20      LD  SP,(SYSTEM+1)
000762 CDD8 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000763 CDD9 6F               4      LD  L,A
000764 CDDA E5              11      PUSH    HL              ; push $0000 (reboot address)
000765 CDDB 24               4      INC H
000766 CDDC E5              11      PUSH    HL              ; push $0100 (TPA address)
000767 CDDD C386CF          10      JP  SETFCB              ; and JP $0100
                                
       CDE0                     C_BAT:
00076A CDE0 114154          10      LD  DE,'A'+'T'*256
00076D CDE3 ED52            15      SBC HL,DE
00076F CDE5 20D0            12      JR  NZ,CEXE6
                                
000771 CDE7 CD55CD          17      CALL    DEFCB
                                
000774 CDEA 21A2E5          10      LD  HL,DTA_CCP
000777 CDED 11C7E5          10      LD  DE,FCB_BAT
00077A CDF0 012500          10      LD  BC,37
00077D CDF3 EDB0                    LDIR
       CDF5                     C_BAT1:
00077F CDF5 CD63CD          17      CALL    SETDTA100
000782 CDF8 CD2CCE          17      CALL    FGETC_BAT
000785 CDFB 218100          10      LD  HL,DTA1+1
000788 CDFE 2025            12      JR  NZ,END_BATCH
00078A CE00 FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
00078C CE02 38F1            12      JR  C,C_BAT1
00078E CE04 3620            10      LD  (HL),' '
000790 CE06 23               6      INC HL
       CE07                     C_BAT2:
000791 CE07 77               7      LD  (HL),A
000792 CE08 23               6      INC HL
000793 CE09 7D               4      LD  A,L
000794 CE0A 3C               4      INC A       ;L==0FFH
000795 CE0B 2809            12      JR  Z,RUN_BATCH
000797 CE0D CD2CCE          17      CALL    FGETC_BAT
00079A CE10 2004            12      JR  NZ,RUN_BATCH
00079C CE12 FE20             7      CP  020H
00079E CE14 30F1            12      JR  NC,C_BAT2
       CE16                     RUN_BATCH:
0007A0 CE16 7D               4      LD  A,L
0007A1 CE17 D67F             7      SUB DTA1-1
0007A3 CE19 328000          13      LD  (DTA1),A
0007A6 CE1C FE04             7      CP  4
0007A8 CE1E 3805            12      JR  C,END_BATCH
0007AA CE20 3600            10      LD  (HL),0
0007AC CE22 C3D3CC          10      JP  COMMAND2
       CE25                     END_BATCH:
0007AF CE25 AF               4      XOR A       ;バッチファイルを閉じる
0007B0 CE26 32C7E5          13      LD  (FCB_BAT),A
0007B3 CE29 C300E6          10      JP  CPM_BOOT
                                
       CE2C                     FGETC_BAT:
0007B6 CE2C 11C7E5          10      LD  DE,FCB_BAT
       CE2F                     FGETC:              ;1文字ずつ読み込む
0007B9 CE2F E5              11      PUSH    HL      ;Z:成功
0007BA CE30 210100          10      LD  HL,1
0007BD CE33 CD86CD          17      CALL    S27
0007C0 CE36 E1              10      POP HL
0007C1 CE37 3A0080          13      LD  A,(BUFFER)
0007C4 CE3A C9              10      RET
                                
       CE3B                     C_DEL:
0007C5 CE3B CD86CF          17      CALL    SETFCB
0007C8 CE3E CDE6D3          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
0007CB CE41 0E13             7      LD  C,013H
0007CD CE43 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       CE45                     C_REN:
0007CF CE45 CD86CF          17      CALL    SETFCB
0007D2 CE48 3E10             7      LD  A,010H      ;ディレクトリも対象にする
0007D4 CE4A 326900          13      LD  (FCB1+13),A ;属性
0007D7 CE4D 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       CE4F                     CDEL1:
0007D9 CE4F 115C00          10      LD  DE,FCB1
0007DC CE52 CD0500          17      CALL    SYSTEM
0007DF CE55 C6FF             7      ADD A,0FFH
0007E1 CE57 C9              10      RET
                                
       CE58                     C_DIR:
0007E2 CE58 CD7ED7          17      CALL    FILEC
0007E5 CE5B 2115E6          10      LD  HL,FDRV+1
0007E8 CE5E CD9CD0          17      CALL    CWILD1
0007EB CE61 3EF1             7      LD  A,0F1H
0007ED CE63 3221E6          13      LD  (FDRV+13),A
0007F0 CE66 CD3FCD          17      CALL    OPEN1
       CE69                     CDIR1:
0007F3 CE69 B7               4      OR  A
0007F4 CE6A 2008            12      JR  NZ,PDSKF
0007F6 CE6C CDB7CE          17      CALL    P_NAME
0007F9 CE6F CD51CD          17      CALL    OPEN2
0007FC CE72 18F5            12      JR  CDIR1
       CE74                     PDSKF:
0007FE CE74 3A14E6          13      LD  A,(FDRV)
000801 CE77 5F               4      LD  E,A
000802 CE78 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
000804 CE7A CD0500          17      CALL    SYSTEM
000807 CE7D 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
000808 CE7E C601             7      ADD A,001H
00080A CE80 D8              11      RET C       ;Aが0FFHだった場合
00080B CE81 3E06             7      LD  A,8-2
       CE83                     PDS1:               ;HL=未使用クラスタの総数
00080D CE83 3C               4      INC A
00080E CE84 CB19             8      RR  C
000810 CE86 30FB            12      JR  NC,PDS1
       CE88                     PDS2:               ;B←論理セクタのサイズの上位8ビット
000812 CE88 3C               4      INC A
000813 CE89 CB18             8      RR  B
000815 CE8B 30FB            12      JR  NC,PDS2
000817 CE8D 47               4      LD  B,A
                                
000818 CE8E 110000          10      LD  DE,0
       CE91                     PDS3:
00081B CE91 29              11      ADD HL,HL
00081C CE92 EB               4      EX  DE,HL
00081D CE93 ED6A            15      ADC HL,HL
00081F CE95 EB               4      EX  DE,HL
000820 CE96 10F9            13      DJNZ    PDS3
       CE98                     PDSKF1:
000822 CE98 CD24CF          17      CALL    PRDEC_DEHL
000825 CE9B 11F7E5          10      LD  DE,FREE
000828 CE9E CD08D1          17      CALL    _SYS09      ;(BDOS)文字列出力
00082B CEA1 CD11CF          17      CALL    PUTDRV
00082E CEA4 3E5C             7      LD  A,05CH      ;\
000830 CEA6 CDAAD3          17      CALL    MSG_A
000833 CEA9 2A22E6          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
000836 CEAC AF               4      XOR A
000837 CEAD 11FEFF          10      LD  DE,0-2
00083A CEB0 19              11      ADD HL,DE
00083B CEB1 23               6      INC HL
00083C CEB2 DC21CF          17      CALL    C,PRDEC_HL
00083F CEB5 1833            12      JR  LTNL
                                
       CEB7                     P_NAME:
000841 CEB7 3AA3E5          13      LD  A,(DTA_CCP+1)
000844 CEBA FE2E             7      CP  '.'
000846 CEBC C8              11      RET Z
                                
000847 CEBD 3AAEE5          13      LD  A,(DTA_CCP+1+00BH)
00084A CEC0 F5              11      PUSH    AF
00084B CEC1 CB67             8      BIT 4,A
00084D CEC3 2808            12      JR  Z,DIR3
00084F CEC5 11ECE5          10      LD  DE,DIRMES
000852 CEC8 CD08D1          17      CALL    _SYS09      ;(BDOS)文字列出力
000855 CECB 180A            12      JR  DIR6
       CECD                     DIR3:
000857 CECD ED5BC1E5        20      LD  DE,(DTA_CCP+1+01EH)
00085B CED1 2ABFE5          16      LD  HL,(DTA_CCP+1+01CH)
00085E CED4 CD24CF          17      CALL    PRDEC_DEHL
       CED7                     DIR6:
000861 CED7 F1              10      POP AF
000862 CED8 0F               4      RRCA
000863 CED9 9F               4      SBC A,A
000864 CEDA E60A             7      AND '*'-020H
000866 CEDC C620             7      ADD A,020H
000868 CEDE CDAAD3          17      CALL    MSG_A
00086B CEE1 CD11CF          17      CALL    PUTDRV
00086E CEE4 21A3E5          10      LD  HL,DTA_CCP+1
000871 CEE7 CD64CF          17      CALL    FPRNT
                                
       CEEA                     LTNL:
000874 CEEA 1E03             7      LD  E,3
000876 CEEC C3CDE6          10      JP  _PRINT
                                
       CEEF                     C_PATH:
000879 CEEF CD5FD8          17      CALL    SPCUT
00087C CEF2 2166E5          10      LD  HL,PATHD
00087F CEF5 FE21             7      CP  021H
000881 CEF7 300C            12      JR  NC,CPATH0
       CEF9                     CPATHP:
000883 CEF9 7E               7      LD  A,(HL)
000884 CEFA 23               6      INC HL
000885 CEFB FE20             7      CP  020H
000887 CEFD 3F               4      CCF
000888 CEFE 30EA            12      JR  NC,LTNL
00088A CF00 CDAAD3          17      CALL    MSG_A
00088D CF03 18F4            12      JR  CPATHP
       CF05                     CPATH0:
00088F CF05 FE3B             7      CP  ';'
000891 CF07 2001            12      JR  NZ,CPATH1
000893 CF09 13               6      INC DE
       CF0A                     CPATH1:
000894 CF0A EB               4      EX  DE,HL
000895 CF0B 013B00          10      LD  BC,PATHX
000898 CF0E EDB0                    LDIR
00089A CF10 C9              10      RET
                                
       CF11                     PUTDRV:
00089B CF11 3A14E6          13      LD  A,(FDRV)
00089E CF14 CD92D8          17      CALL    GETDRV1
0008A1 CF17 C641             7      ADD A,'A'
0008A3 CF19 CDAAD3          17      CALL    MSG_A
0008A6 CF1C 3E3A             7      LD  A,':'
       CF1E                     MSG_AR:
0008A8 CF1E C3AAD3          10      JP  MSG_A
                                
       CF21                     PRDEC_HL:
0008AB CF21 AF               4      XOR A
0008AC CF22 5F               4      LD  E,A
0008AD CF23 57               4      LD  D,A
       CF24                     PRDEC_DEHL:
0008AE CF24 D5              11      PUSH    DE
0008AF CF25 110FE6          10      LD  DE,DECBF
0008B2 CF28 0605             7      LD  B,5
0008B4 CF2A CDBBCF          17      CALL    ZERO_MEMORY_DE  ;A=0
0008B7 CF2D D1              10      POP DE
                                
0008B8 CF2E 0E20             7      LD  C,32
       CF30                     DEC1:
0008BA CF30 29              11      ADD HL,HL
0008BB CF31 EB               4      EX  DE,HL
0008BC CF32 ED6A            15      ADC HL,HL
0008BE CF34 EB               4      EX  DE,HL
0008BF CF35 E5              11      PUSH    HL
0008C0 CF36 2113E6          10      LD  HL,DECBF+4
0008C3 CF39 0605             7      LD  B,5
       CF3B                     DEC2:
0008C5 CF3B 7E               7      LD  A,(HL)
0008C6 CF3C 8F               4      ADC A,A
0008C7 CF3D 27               4      DAA
0008C8 CF3E 77               7      LD  (HL),A
0008C9 CF3F 2B               6      DEC HL
0008CA CF40 10F9            13      DJNZ    DEC2
0008CC CF42 E1              10      POP HL
0008CD CF43 0D               4      DEC C
0008CE CF44 20EA            12      JR  NZ,DEC1
                                
0008D0 CF46 210FE6          10      LD  HL,DECBF
0008D3 CF49 3E20             7      LD  A,020H
0008D5 CF4B 0604             7      LD  B,4
       CF4D                     DEC3:
0008D7 CF4D CD5ACF          17      CALL    DEC4
0008DA CF50 CD5ACF          17      CALL    DEC4
0008DD CF53 23               6      INC HL
0008DE CF54 10F7            13      DJNZ    DEC3
       CF56                     DECX:
0008E0 CF56 CD5ACF          17      CALL    DEC4
0008E3 CF59 AF               4      XOR A
       CF5A                     DEC4:
0008E4 CF5A ED6F            18      RLD
0008E6 CF5C FE20             7      CP  020H
0008E8 CF5E 2802            12      JR  Z,DEC5
0008EA CF60 F630             7      OR  030H
       CF62                     DEC5:
0008EC CF62 18BA            12      JR  MSG_AR
                                
       CF64                     FPRNT:
0008EE CF64 0608             7      LD  B,8 ;ファイル名を表示
0008F0 CF66 CD75CF          17      CALL    P_N1
0008F3 CF69 7E               7      LD  A,(HL)
0008F4 CF6A CDB1DA          17      CALL    CAP3
0008F7 CF6D D8              11      RET C   ;拡張子が無い
                                
0008F8 CF6E 3E2E             7      LD  A,'.'
0008FA CF70 CDAAD3          17      CALL    MSG_A
0008FD CF73 0603             7      LD  B,3 ;拡張子を表示
       CF75                     P_N1:
0008FF CF75 7E               7      LD  A,(HL)
000900 CF76 CDB1DA          17      CALL    CAP3
000903 CF79 3807            12      JR  C,P_N2
000905 CF7B CDAAD3          17      CALL    MSG_A
000908 CF7E 23               6      INC HL
000909 CF7F 10F4            13      DJNZ    P_N1
00090B CF81 C9              10      RET
       CF82                     P_N2:
00090C CF82 23               6      INC HL
00090D CF83 10FD            13      DJNZ    P_N2
00090F CF85 C9              10      RET
                                
       CF86                     SETFCB:
000910 CF86 CD5FD8          17      CALL    SPCUT
000913 CF89 1A               7      LD  A,(DE)
000914 CF8A FE20             7      CP  020H
000916 CF8C 3801            12      JR  C,SETFCBA
000918 CF8E 1B               6      DEC DE
       CF8F                     SETFCBA:
000919 CF8F 0624             7      LD  B,36
00091B CF91 215C00          10      LD  HL,FCB1
00091E CF94 E5              11      PUSH    HL
00091F CF95 AF               4      XOR A
000920 CF96 CD34D8          17      CALL    FILL_MEMORY
000923 CF99 E1              10      POP HL
000924 CF9A D5              11      PUSH    DE
000925 CF9B CD41D3          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000928 CF9E 216C00          10      LD  HL,FCB2
00092B CFA1 CD41D3          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
00092E CFA4 E1              10      POP HL
00092F CFA5 010050          10      LD  BC,05000H
000932 CFA8 118100          10      LD  DE,00081H
       CFAB                     SETFCB1:
000935 CFAB 7E               7      LD  A,(HL)
000936 CFAC 23               6      INC HL
000937 CFAD FE20             7      CP  020H
000939 CFAF 3805            12      JR  C,SETFCB2
00093B CFB1 12               7      LD  (DE),A
00093C CFB2 13               6      INC DE
00093D CFB3 0C               4      INC C
00093E CFB4 10F5            13      DJNZ    SETFCB1
       CFB6                     SETFCB2:
000940 CFB6 79               4      LD  A,C
000941 CFB7 328000          13      LD  (DTA1),A
000944 CFBA 04               4      INC B
       CFBB                     ZERO_MEMORY_DE:
000945 CFBB AF               4      XOR A
       CFBC                     FILL_MEMORY_DE:
000946 CFBC 12               7      LD  (DE),A
000947 CFBD 13               6      INC DE
000948 CFBE 10FC            13      DJNZ    FILL_MEMORY_DE
00094A CFC0 C9              10      RET
                                
       CFC1                     C_COPY:
00094B CFC1 CD86CF          17      CALL    SETFCB
                                
00094E CFC4 1161E6          10      LD  DE,ZERO
000951 CFC7 CD81D7          17      CALL    FILEC2
000954 CFCA 216C00          10      LD  HL,FCB2
000957 CFCD CD48D3          17      CALL    S29X1
                                
00095A CFD0 3E10             7      LD  A,010H
00095C CFD2 326900          13      LD  (FCB1+13),A
00095F CFD5 216D00          10      LD  HL,FCB2FN
000962 CFD8 CD9CD0          17      CALL    CWILD1
       CFDB                     COPY0:
000965 CFDB CD99D0          17      CALL    CWILD
000968 CFDE 215C00          10      LD  HL,FCB1
00096B CFE1 CD42CD          17      CALL    OPEN
00096E CFE4 37               4      SCF
       CFE5                     COPY1:
00096F CFE5 C0              11      RET NZ
000970 CFE6 CD55CD          17      CALL    DEFCB
                                
000973 CFE9 3AAFE5          13      LD  A,(DTA_CCP+13)
000976 CFEC CB67             8      BIT 4,A
000978 CFEE 2821            12      JR  Z,COPY1A
                                
00097A CFF0 215D00          10      LD  HL,FCB1FN
00097D CFF3 CDC4DB          17      CALL    CHKWILD
000980 CFF6 3814            12      JR  C,COPY9
                                
000982 CFF8 3E20             7      LD  A,020H
000984 CFFA 325D00          13      LD  (FCB1FN),A
000987 CFFD 2ABCE5          16      LD  HL,(DTA_CCP+26)
00098A D000 23               6      INC HL
00098B D001 226A00          16      LD  (FCB1+14),HL
00098E D004 18D5            12      JR  COPY0
                                
       D006                     COPY8:
000990 D006 CD08D1          17      CALL    _SYS09      ;(BDOS)文字列出力
000993 D009 CDEACE          17      CALL    LTNL
       D00C                     COPY9:
000996 D00C CD51CD          17      CALL    OPEN2
000999 D00F 18D4            12      JR  COPY1
                                
       D011                     COPY1A:
00099B D011 216C00          10      LD  HL,FCB2
00099E D014 1114E6          10      LD  DE,FDRV
0009A1 D017 01A4E5          10      LD  BC,DTA_CCP+2
0009A4 D01A EDA0            16      LDI
0009A6 D01C 3E0B             7      LD  A,11
       D01E                     COPY2:
0009A8 D01E F5              11      PUSH    AF
0009A9 D01F 7E               7      LD  A,(HL)
0009AA D020 FE3F             7      CP  '?'
0009AC D022 2001            12      JR  NZ,COPY3
0009AE D024 0A               7      LD  A,(BC)
       D025                     COPY3:
0009AF D025 12               7      LD  (DE),A
0009B0 D026 03               6      INC BC
0009B1 D027 13               6      INC DE
0009B2 D028 23               6      INC HL
0009B3 D029 F1              10      POP AF
0009B4 D02A 3D               4      DEC A
0009B5 D02B 20F1            12      JR  NZ,COPY2
0009B7 D02D 010500          10      LD  BC,16-11
0009BA D030 EDB0                    LDIR
       D032                     PUTNAME:
0009BC D032 215D00          10      LD  HL,FCB1FN
0009BF D035 CDC4DB          17      CALL    CHKWILD
0009C2 D038 300B            12      JR  NC,PUTN1
0009C4 D03A 2115E6          10      LD  HL,FDRV+1
0009C7 D03D CD64CF          17      CALL    FPRNT
0009CA D040 3E20             7      LD  A,020H
0009CC D042 CDAAD3          17      CALL    MSG_A
       D045                     PUTN1:
0009CF D045 1114E6          10      LD  DE,FDRV
0009D2 D048 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
0009D4 D04A CD70CD          17      CALL    SYSTEM0
0009D7 D04D 2048            12      JR  NZ,COPYE2
0009D9 D04F 67               4      LD  H,A     ;A=0
0009DA D050 6F               4      LD  L,A
0009DB D051 2235E6          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0009DE D054 2237E6          16      LD  (FDRV+35),HL
       D057                     COPY6:
0009E1 D057 CD79CD          17      CALL    S27BUF
0009E4 D05A 47               4      LD  B,A
0009E5 D05B 3C               4      INC A
0009E6 D05C 2831            12      JR  Z,COPYE
0009E8 D05E 7C               4      LD  A,H
0009E9 D05F B5               4      OR  L
0009EA D060 280C            12      JR  Z,COPY7
0009EC D062 1114E6          10      LD  DE,FDRV
0009EF D065 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0009F1 D067 CD70CD          17      CALL    SYSTEM0
0009F4 D06A 2023            12      JR  NZ,COPYE
0009F6 D06C 10E9            13      DJNZ    COPY6
       D06E                     COPY7:
0009F8 D06E 3AAFE5          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0009FB D071 3221E6          13      LD  (FDRV+13),A
0009FE D074 21B6E5          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
000A01 D077 1128E6          10      LD  DE,FDRV+20
000A04 D07A 010400          10      LD  BC,4
000A07 D07D EDB0                    LDIR
                                
000A09 D07F 1114E6          10      LD  DE,FDRV
000A0C D082 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
000A0E D084 CD70CD          17      CALL    SYSTEM0
000A11 D087 2006            12      JR  NZ,COPYE
                                
000A13 D089 1171E6          10      LD  DE,OK
000A16 D08C C306D0          10      JP  COPY8
                                
       D08F                     COPYE:
000A19 D08F 1114E6          10      LD  DE,FDRV
000A1C D092 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
000A1E D094 CD0500          17      CALL    SYSTEM
       D097                     COPYE2:
000A21 D097 37               4      SCF
000A22 D098 C9              10      RET
                                
       D099                     CWILD:
000A23 D099 215D00          10      LD  HL,FCB1FN
       D09C                     CWILD1:
000A26 D09C 7E               7      LD  A,(HL)
000A27 D09D FE20             7      CP  020H
000A29 D09F C0              11      RET NZ
       D0A0                     CWILD2:
000A2A D0A0 3E3F             7      LD  A,'?'
000A2C D0A2 060B             7      LD  B,11
000A2E D0A4 C334D8          10      JP  FILL_MEMORY
                                
       D0A7                     COMTB:
000A31 D0A7 44202020                DB  "D   "  ;1
000A35 D0AB 58CE                    DW  C_DIR
000A37 D0AD 44495220                DB  "DIR "  ;2
000A3B D0B1 58CE                    DW  C_DIR
000A3D D0B3 434F5059                DB  "COPY"  ;3
000A41 D0B7 C1CF                    DW  C_COPY
000A43 D0B9 43442020                DB  "CD  "  ;4
000A47 D0BD 75CD                    DW  C_CD
000A49 D0BF 44454C20                DB  "DEL "  ;5
000A4D D0C3 3BCE                    DW  C_DEL
000A4F D0C5 50415448                DB  "PATH"  ;6
000A53 D0C9 EFCE                    DW  C_PATH
000A55 D0CB 52454E20                DB  "REN "  ;7
000A59 D0CF 45CE                    DW  C_REN
000A5B D0D1 52454D20                DB  "REM "  ;8
000A5F D0D5 05D1                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D0D7                     BDOS0:
000A61 D0D7 E5              11      PUSH    HL
000A62 D0D8 79               4      LD  A,C
000A63 D0D9 FE3C             7      CP  03CH
000A65 D0DB 3802            12      JR  C,DOS1
000A67 D0DD 3E3C             7      LD  A,03CH
       D0DF                     DOS1:
000A69 D0DF 87               4      ADD A,A
000A6A D0E0 32E4D0          13      LD  (DOS1_SWC),A
000A6D D0E3 2A00E7          16      LD  HL,(STABLE)
       D0E4                     DOS1_SWC    EQU $-2
000A70 D0E6 E3              19      EX  (SP),HL
000A71 D0E7 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
000A72 D0E8 C9              10      RET
       D0E9                     _DOS2:
000A73 D0E9 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000A75 D0EB CA83D3          10      JP  Z,_SYS5A
000A78 D0EE FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000A7A D0F0 CA40D3          10      JP  Z,_SYS5C
000A7D D0F3 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
000A7F D0F5 CAC1E4          10      JP  Z,_SYS5F
000A82 D0F8 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000A84 D0FA 200A            12      JR  NZ,_ERROR
000A86 D0FC 011D00          10      LD  BC,VER_6F
000A89 D0FF 116201          10      LD  DE,VER
000A8C D102 210301          10      LD  HL,MACD
       D105                     C_REM:
000A8F D105 AF               4      XOR A
       D106                     _ERROR:
000A90 D106 A7               4      AND A
000A91 D107 C9              10      RET
                                
       D108                     _SYS09:     ;文字列出力
000A92 D108 D5              11      PUSH    DE
       D109                     _SX09:
000A93 D109 1A               7      LD  A,(DE)
000A94 D10A 13               6      INC DE
000A95 D10B FE24             7      CP  '$'
000A97 D10D 2831            12      JR  Z,SX0E2
000A99 D10F CDAAD3          17      CALL    MSG_A
000A9C D112 18F5            12      JR  _SX09
                                
       D114                     MSX1:
000A9E D114 CDAAD3          17      CALL    MSG_A
       D117                     MSX:
000AA1 D117 7E               7      LD  A,(HL)
000AA2 D118 23               6      INC HL
000AA3 D119 B7               4      OR  A
000AA4 D11A 20F8            12      JR  NZ,MSX1
000AA6 D11C C9              10      RET
                                
       D11D                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000AA7 D11D 212200          10      LD  HL,00022H
000AAA D120 7D               4      LD  A,L
000AAB D121 C9              10      RET
                                
       D122                     _SYS0D:     ;(BDOS)ディスクリセット
000AAC D122 CDDFE6          17      CALL    _FFLUSH
000AAF D125 E5              11      PUSH    HL
000AB0 D126 218000          10      LD  HL,00080H
000AB3 D129 228AE6          16      LD  (_DTA),HL
000AB6 D12C E1              10      POP HL
000AB7 D12D D5              11      PUSH    DE
000AB8 D12E 1E00             7      LD  E,0
000ABA D130 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D131                     _SYS0E:     ;(BDOS)カレントドライブの設定
000ABB D131 D5              11      PUSH    DE
000ABC D132 7B               4      LD  A,E
000ABD D133 DDE5            15      PUSH    IX
000ABF D135 CDDCE6          17      CALL    _GETDPB
000AC2 D138 DDE1            14      POP IX
000AC4 D13A 3804            12      JR  C,SX0E2
000AC6 D13C 7B               4      LD  A,E
000AC7 D13D 320400          13      LD  (_DVSW),A
       D140                     SX0E2:
000ACA D140 D1              10      POP DE
000ACB D141 C9              10      RET
                                
       D142                     _SYS0F:     ;(BDOS)ファイルのオープン
000ACC D142 CD71D8          17      CALL    SETDRV
000ACF D145 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000AD2 D148 C602             7      ADD A,002H      ;Write
000AD4 D14A 2848            12      JR  Z,FEND0F
000AD6 D14C CDC0DB          17      CALL    CHKWILDX
                                
000AD9 D14F D49BD8          17      CALL    NC,SOPENX
       D152                     _S16XX:
000ADC D152 3840            12      JR  C,FEND0F
                                                ;Directory location
000ADE D154 3A9FE6          13      LD  A,(_FILEN)
000AE1 D157 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
000AE4 D15A 3AA0E6          13      LD  A,(_DIRF)
000AE7 D15D FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000AEA D160 FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
000AED D163 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
000AF0 D166 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
000AF4 D16A FDE5            15      PUSH    IY
000AF6 D16C D1              10      POP DE
000AF7 D16D 13               6      INC DE
000AF8 D16E 010B00          10      LD  BC,11
000AFB D171 EDB0                    LDIR
                                ;               Attribute
000AFD D173 7E               7      LD  A,(HL)
000AFE D174 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
000B01 D177 110B00          10      LD  DE,11       ;Reserved
000B04 D17A 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
000B05 D17B 11E4E7          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
000B08 D17E 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D180                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000B0A D180 1A               7      LD  A,(DE)
000B0B D181 13               6      INC DE
000B0C D182 3289D1          13      LD  (S16PAT),A
000B0F D185 7E               7      LD  A,(HL)
000B10 D186 23               6      INC HL
000B11 D187 FD7700          19      LD  (IY+0),A
       D189                     S16PAT  EQU $-1
000B14 D18A 10F4            13      DJNZ    S16LOOP
                                
000B16 D18C AF               4      XOR A
000B17 D18D FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000B1A D190 FD2231D2        20      LD  (OFCB_SWC),IY
       D194                     FEND0F:
000B1E D194 1845            12      JR  FEND10
                                
       D196                     _SYS10:     ;(BDOS)ファイルのクローズ
000B20 D196 CD71D8          17      CALL    SETDRV
000B23 D199 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000B26 D19C D6FE             7      SUB 0FEH
000B28 D19E 37               4      SCF
000B29 D19F 3F               4      CCF
000B2A D1A0 2039            12      JR  NZ,FEND10
       D1A2                     _S10A:              ;Write
000B2C D1A2 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000B2F D1A5 FD770F          19      LD  (IY+15),A
                                
000B32 D1A8 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
000B35 D1AB CDBCDC          17      CALL    SETTMS
                                
000B38 D1AE FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000B3B D1B1 32A0E6          13      LD  (_DIRF),A
000B3E D1B4 E67F             7      AND 07FH
000B40 D1B6 32E1E1          13      LD  (_SECPS),A
000B43 D1B9 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000B46 D1BC FD561F          19      LD  D,(IY+31)
000B49 D1BF CDCFD9          17      CALL    READ_DIR
000B4C D1C2 3817            12      JR  C,FEND10
                                
000B4E D1C4 3AFBD8          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000B51 D1C7 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000B52 D1C8 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000B55 D1CB 6F               4      LD  L,A
000B56 D1CC 2600             7      LD  H,0
000B58 D1CE 29              11      ADD HL,HL       ;*2
000B59 D1CF 29              11      ADD HL,HL       ;*4
000B5A D1D0 29              11      ADD HL,HL       ;*8
000B5B D1D1 29              11      ADD HL,HL       ;*16
000B5C D1D2 29              11      ADD HL,HL       ;*32
000B5D D1D3 ED4B7EE7        20      LD  BC,(_DTBUF)
000B61 D1D7 09              11      ADD HL,BC
                                
000B62 D1D8 CDD0DB          17      CALL    SDIRENT
       D1DB                     FEND10:
000B65 D1DB 1842            12      JR  FEND
                                
       D1DD                     _SYS11:     ;(BDOS)最初のファイルの検索
000B67 D1DD CD71D8          17      CALL    SETDRV
000B6A D1E0 CDCAD8          17      CALL    SOPEN
       D1E3                     _S12X1:
000B6D D1E3 383A            12      JR  C,FEND
000B6F D1E5 CD69D9          17      CALL    SOPENE2
000B72 D1E8 ED5B8AE6        20      LD  DE,(_DTA)
000B76 D1EC 3A88E6          13      LD  A,(_DRV)
000B79 D1EF 3C               4      INC A
000B7A D1F0 12               7      LD  (DE),A
000B7B D1F1 D5              11      PUSH    DE
000B7C D1F2 13               6      INC DE
000B7D D1F3 012000          10      LD  BC,32
000B80 D1F6 EDB0                    LDIR
000B82 D1F8 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000B85 D1FB FD660F          19      LD  H,(IY+15)
000B88 D1FE 22F4E7          16      LD  (SCDIR),HL
000B8B D201 2A9AE6          16      LD  HL,(_FBPS)
000B8E D204 22F6E7          16      LD  (SFBPS),HL
000B91 D207 2A9FE6          16      LD  HL,(_FILEN)
000B94 D20A 7C               4      LD  A,H
000B95 D20B B7               4      OR  A
000B96 D20C 2806            12      JR  Z,_S12DIR
000B98 D20E 3AE1E1          13      LD  A,(_SECPS)
000B9B D211 F680             7      OR  080H
000B9D D213 67               4      LD  H,A
       D214                     _S12DIR:
000B9E D214 22F8E7          16      LD  (SFNDF),HL  ;Directory position and Flags
000BA1 D217 E1              10      POP HL
000BA2 D218 1139E6          10      LD  DE,SFILE
000BA5 D21B 0E21             7      LD  C,33
       D21D                     _S11B:
000BA7 D21D EDB0                    LDIR
       D21F                     FEND:
000BA9 D21F 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D220                     FENDE:
000BAA D220 FDE1            14      POP IY
000BAC D222 C1              10      POP BC
000BAD D223 D1              10      POP DE
000BAE D224 E1              10      POP HL
000BAF D225 C9              10      RET
                                
       D226                     _SYS12:     ;(BDOS)次のファイルの検索
000BB0 D226 E5              11      PUSH    HL
000BB1 D227 D5              11      PUSH    DE
000BB2 D228 C5              11      PUSH    BC
000BB3 D229 FDE5            15      PUSH    IY
000BB5 D22B CD2ED9          17      CALL    NOPEN
000BB8 D22E 18B3            12      JR  _S12X1
                                
       D230                     _S16K:
000BBA D230 110000          10      LD  DE,0
       D231                     OFCB_SWC    EQU $-2
000BBD D233 D5              11      PUSH    DE
000BBE D234 061A             7      LD  B,26        ;First cluster
       D236                     S16K1:
000BC0 D236 13               6      INC DE
000BC1 D237 23               6      INC HL
000BC2 D238 10FC            13      DJNZ    S16K1
                                
000BC4 D23A 1A               7      LD  A,(DE)
000BC5 D23B BE               7      CP  (HL)
000BC6 D23C 2015            12      JR  NZ,S16K2
000BC8 D23E 13               6      INC DE
000BC9 D23F 23               6      INC HL
000BCA D240 1A               7      LD  A,(DE)
000BCB D241 BE               7      CP  (HL)
000BCC D242 200F            12      JR  NZ,S16K2
                                
000BCE D244 E1              10      POP HL
000BCF D245 FDE5            15      PUSH    IY
000BD1 D247 D1              10      POP DE
000BD2 D248 7E               7      LD  A,(HL)
000BD3 D249 CD86D8          17      CALL    IS_SAME_DRV_A_DE
000BD6 D24C 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000BD8 D24E ED52            15      SBC HL,DE       ;CP HL,DE
000BDA D250 37               4      SCF
000BDB D251 C0              11      RET NZ
000BDC D252 E5              11      PUSH    HL
       D253                     S16K2:
000BDD D253 E1              10      POP HL
       D254                     S16K3:
000BDE D254 FDE5            15      PUSH    IY
000BE0 D256 D1              10      POP DE
       D257                     _SYS13:     ;(BDOS)ファイルの削除
000BE1 D257 CD71D8          17      CALL    SETDRV
000BE4 D25A CDF8DA          17      CALL    KILL
       D25D                     FEND13:
000BE7 D25D 18C0            12      JR  FEND
                                
       D25F                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000BE9 D25F CD71D8          17      CALL    SETDRV
000BEC D262 CD34E0          17      CALL    INIT_SEQ
       D265                     SREAD:
000BEF D265 CD06E0          17      CALL    RB_READ
                                
000BF2 D268 C601             7      ADD A,001H
000BF4 D26A 38B3            12      JR  C,FEND
                                
000BF6 D26C 7D               4      LD  A,L
000BF7 D26D D601             7      SUB 001H
       D26F                     FENDX:
000BF9 D26F 9F               4      SBC A,A
000BFA D270 E603             7      AND 3
000BFC D272 1F               4      RRA
000BFD D273 18AB            12      JR  FENDE
                                
       D275                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000BFF D275 CD71D8          17      CALL    SETDRV
000C02 D278 CD34E0          17      CALL    INIT_SEQ
       D27B                     SWRITE:
000C05 D27B CD01E0          17      CALL    RB_WRITE
                                
000C08 D27E C6FF             7      ADD A,0FFH
000C0A D280 18ED            12      JR  FENDX
                                
       D282                     _SYS17:     ;(BDOS)ファイル名の変更
000C0C D282 CD71D8          17      CALL    SETDRV
000C0F D285 CD4EDB          17      CALL    NAME
000C12 D288 18D3            12      JR  FEND13
                                
       D28A                     _SYS16:     ;(BDOS)ファイルの作成
000C14 D28A CD71D8          17      CALL    SETDRV
                                
000C17 D28D CDC0DB          17      CALL    CHKWILDX
000C1A D290 38CB            12      JR  C,FEND13
000C1C D292 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000C1F D295 FE05             7      CP  5
000C21 D297 2805            12      JR  Z,_S16X2
000C23 D299 FE21             7      CP  021H
000C25 D29B DA5DD2          10      JP  C,FEND13
       D29E                     _S16X2:
                                ;               Clear FCB
000C28 D29E FDE5            15      PUSH    IY
000C2A D2A0 E1              10      POP HL
000C2B D2A1 011000          10      LD  BC,16
000C2E D2A4 09              11      ADD HL,BC
       D2A5                     _S16X1:
000C2F D2A5 70               7      LD  (HL),B      ;B=0
000C30 D2A6 23               6      INC HL
000C31 D2A7 0D               4      DEC C
000C32 D2A8 20FB            12      JR  NZ,_S16X1
                                
000C34 D2AA CDC1DC          17      CALL    SETTMSX
000C37 D2AD FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000C3B D2B1 CD9BD8          17      CALL    SOPENX
000C3E D2B4 3F               4      CCF
000C3F D2B5 CC30D2          17      CALL    Z,_S16K
000C42 D2B8 D47AD9          17      CALL    NC,COPEN
000C45 D2BB D4D0DB          17      CALL    NC,SDIRENT
000C48 D2BE C352D1          10      JP  _S16XX
                                
       D2C1                     _SYS21:     ;(BDOS)ランダムな読み出し
000C4B D2C1 CD71D8          17      CALL    SETDRV
000C4E D2C4 CD0CDD          17      CALL    INIT_RND
000C51 D2C7 189C            12      JR  SREAD
                                
       D2C9                     _SYS22:     ;(BDOS)ランダムな書き込み
       D2C9                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000C53 D2C9 CD71D8          17      CALL    SETDRV
000C56 D2CC CD0CDD          17      CALL    INIT_RND
000C59 D2CF 18AA            12      JR  SWRITE
                                
       D2D1                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000C5B D2D1 21FF00          10      LD  HL,000FFH
000C5E D2D4 AF               4      XOR A
000C5F D2D5 C9              10      RET
                                
       D2D6                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000C60 D2D6 3A0400          13      LD  A,(_DVSW)   ;from LDOS
000C63 D2D9 A7               4      AND A
000C64 D2DA C9              10      RET
                                
       D2DB                     _SYS1A:     ;(BDOS)DTAの設定
000C65 D2DB ED538AE6        20      LD  (_DTA),DE
000C69 D2DF AF               4      XOR A
000C6A D2E0 C9              10      RET
                                
       D2E1                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000C6B D2E1 7B               4      LD  A,E
000C6C D2E2 CD7FD8          17      CALL    GETDRV
000C6F D2E5 CDDCE6          17      CALL    _GETDPB
000C72 D2E8 D4E2E6          17      CALL    NC,_RDFATX
000C75 D2EB 210000          10      LD  HL,0
000C78 D2EE D49ADC          17      CALL    NC,DSKF
                                
000C7B D2F1 ED5B9BDC        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000C7F D2F5 1B               6      DEC DE      ;DE←クラスタの総数
000C80 D2F6 FD2A7CE7        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000C84 D2FA 9F               4      SBC A,A
000C85 D2FB D8              11      RET C
000C86 D2FC 4F               4      LD  C,A     ;C=0
000C87 D2FD DD7E0F          19      LD  A,(IX+DPB_BPS)
000C8A D300 E607             7      AND 7
000C8C D302 47               4      LD  B,A
000C8D D303 DD7E07          19      LD  A,(IX+DPB_SECPCL)
000C90 D306 C9              10      RET
                                
       D307                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000C91 D307 AF               4      XOR A
000C92 D308 67               4      LD  H,A
000C93 D309 6F               4      LD  L,A
000C94 D30A C9              10      RET
                                
       D30B                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000C95 D30B 2100E8          10      LD  HL,_DEVICE
000C98 D30E 7B               4      LD  A,E
000C99 D30F C3DCE6          10      JP  _GETDPB
                                
       D312                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000C9C D312 E5              11      PUSH    HL
000C9D D313 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000C9F D315 CDD7D0          17      CALL    BDOS0
000CA2 D318 381B            12      JR  C,_S23X1
                                
000CA4 D31A D5              11      PUSH    DE      ;EX DE,IY
000CA5 D31B FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000CA7 D31D FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000CAA D320 FD6E11          19      LD  L,(IY+17)   ;
000CAD D323 FD6612          19      LD  H,(IY+18)   ;
000CB0 D326 C5              11      PUSH    BC      ;
000CB1 D327 FD4613          19      LD  B,(IY+19)   ;
000CB4 D32A CDFEDC          17      CALL    GET_CPM_R_SIZE
000CB7 D32D C1              10      POP BC
       D32E                     _S24X1:
000CB8 D32E CD1EDD          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000CBB D331 FDE3            23      EX  (SP),IY     ;
000CBD D333 D1              10      POP DE      ;
                                
000CBE D334 AF               4      XOR A
       D335                     _S23X1:
000CBF D335 E1              10      POP HL
000CC0 D336 C9              10      RET
                                
       D337                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000CC1 D337 E5              11      PUSH    HL
000CC2 D338 D5              11      PUSH    DE      ;EX DE,IY
000CC3 D339 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000CC5 D33B CD3CE0          17      CALL    GETSEQ
000CC8 D33E 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D340                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000CCA D340 2B               6      DEC HL
       D341                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000CCB D341 C5              11      PUSH    BC
000CCC D342 E5              11      PUSH    HL
000CCD D343 CD89D7          17      CALL    FILE
000CD0 D346 E1              10      POP HL
000CD1 D347 C1              10      POP BC
       D348                     S29X1:
000CD2 D348 C5              11      PUSH    BC
000CD3 D349 D5              11      PUSH    DE
000CD4 D34A E5              11      PUSH    HL
000CD5 D34B EB               4      EX  DE,HL
000CD6 D34C AF               4      XOR A
000CD7 D34D 3221E6          13      LD  (FDRV+13),A
000CDA D350 2114E6          10      LD  HL,FDRV
000CDD D353 011000          10      LD  BC,16
000CE0 D356 EDB0                    LDIR
000CE2 D358 E1              10      POP HL
000CE3 D359 D1              10      POP DE
000CE4 D35A C1              10      POP BC
000CE5 D35B C9              10      RET
                                
       D35C                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000CE6 D35C C5              11      PUSH    BC
000CE7 D35D 0182E3          10      LD  BC,DWT24B
000CEA D360 1804            12      JR  S2FX
       D362                     _SYS2F:
000CEC D362 C5              11      PUSH    BC
000CED D363 0174E3          10      LD  BC,DRD24B
       D366                     S2FX:
000CF0 D366 ED437CD3        20      LD  (S2F_SWC),BC
000CF4 D36A CDDFE6          17      CALL    _FFLUSH
                                
000CF7 D36D D5              11      PUSH    DE
000CF8 D36E E5              11      PUSH    HL
000CF9 D36F 7D               4      LD  A,L     ;Drive
000CFA D370 CDD9E6          17      CALL    _CHGDRV
000CFD D373 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
000CFF D375 44               4      LD  B,H     ;Number of clusters
000D00 D376 2A8AE6          16      LD  HL,(_DTA)
                                
000D03 D379 0E00             7      LD  C,0
000D05 D37B CD74E3          17      CALL    DRD24B
       D37C                     S2F_SWC EQU $-2
       D37E                     POP_HL_DE_BC_SBCAA_RET:
000D08 D37E E1              10      POP HL
000D09 D37F D1              10      POP DE
000D0A D380 C1              10      POP BC
000D0B D381 9F               4      SBC A,A
000D0C D382 C9              10      RET
                                
       D383                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000D0D D383 C5              11      PUSH    BC
000D0E D384 D5              11      PUSH    DE
000D0F D385 E5              11      PUSH    HL
000D10 D386 CD7ED7          17      CALL    FILEC
000D13 D389 217ED3          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
000D16 D38C E5              11      PUSH    HL
000D17 D38D 3A21E6          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
000D1A D390 E610             7      AND 010H        ;ディレクトリ
000D1C D392 37               4      SCF
000D1D D393 C8              11      RET Z
000D1E D394 1114E6          10      LD  DE,FDRV
000D21 D397 2A4EE7          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       D39A                     JPHL:
000D24 D39A E9               4      JP  (HL)
                                
       D39B                     SHOW_ERROR:         ;(9)
000D25 D39B 1179E6          10      LD  DE,COMERM
000D28 D39E CD08D1          17      CALL    _SYS09      ;(BDOS)文字列出力
000D2B D3A1 C300E6          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "MSXIO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MSX
                                
       D106                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D106                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D106                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D106                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D106                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D106                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       0000                     CTRL00  EQU 0
       0000                     CTRL03  EQU 0
       0000                     CTRL04  EQU 0
       0000                     CTRL05  EQU 0
       0000                     CTRL06  EQU 0
       0000                     CTRL07  EQU 0
       0000                     CTRL08  EQU 0
       0000                     CTRL09  EQU 0
       0000                     CTRL0A  EQU 0
       0000                     CTRL0B  EQU 0
       0000                     CTRL0C  EQU 0
       0000                     CTRL0D  EQU 0
       0000                     CTRL0E  EQU 0
       0000                     CTRL12  EQU 0
       0000                     CTRL1B  EQU 0
       0000                     CTRL1C  EQU 0
       0000                     CTRL1D  EQU 0
       0000                     CTRL1E  EQU 0
       0000                     CTRL1F  EQU 0
                                
       D3A4                     PRINT:
000D2E D3A4 7B               4      LD  A,E
000D2F D3A5 1803            12      JR  MSG_A
                                
       D3A7                     _SYS01:     ;(BDOS)コンソール入力
000D31 D3A7 CD09E6          17      CALL    _SYS07
       D3AA                     MSG_A:
000D34 D3AA FE03             7      CP  3
000D36 D3AC 2814            12      JR  Z,MSG_BR
       D3AE                     MSGA1:
000D38 D3AE F5              11      PUSH    AF
000D39 D3AF C5              11      PUSH    BC
000D3A D3B0 D5              11      PUSH    DE
000D3B D3B1 E5              11      PUSH    HL
000D3C D3B2 DDE5            15      PUSH    IX
000D3E D3B4 DD21A200        14      LD  IX,CHPUT
000D42 D3B8 CD1DD6          17      CALL    CALSLT_R
000D45 D3BB DDE1            14      POP IX
000D47 D3BD E1              10      POP HL
000D48 D3BE D1              10      POP DE
000D49 D3BF C1              10      POP BC
       D3C0                     MSGA2:
000D4A D3C0 F1              10      POP AF
000D4B D3C1 C9              10      RET
       D3C2                     MSG_BR:
000D4C D3C2 F5              11      PUSH    AF
000D4D D3C3 3ADDF3          13      LD  A,(CSRX)
000D50 D3C6 FE02             7      CP  2
000D52 D3C8 38F6            12      JR  C,MSGA2
000D54 D3CA F1              10      POP AF
       D3CB                     MSG_CR:
000D55 D3CB F5              11      PUSH    AF
000D56 D3CC 3E0D             7      LD  A,00DH
000D58 D3CE CDAED3          17      CALL    MSGA1
000D5B D3D1 3E0A             7      LD  A,00AH
000D5D D3D3 CDAED3          17      CALL    MSGA1
000D60 D3D6 F1              10      POP AF
000D61 D3D7 C9              10      RET
                                
       D3D8                     _SYS02:     ;(BDOS)コンソール出力
000D62 D3D8 CDF4D3          17      CALL    BREAK
000D65 D3DB C3CDE6          10      JP  _PRINT
                                
       D3DE                     _SYS06:     ;(BDOS)コンソール直接入出力
000D68 D3DE 7B               4      LD  A,E
000D69 D3DF 3C               4      INC A
000D6A D3E0 CACAE6          10      JP  Z,_INKEY
000D6D D3E3 C3CDE6          10      JP  _PRINT
                                
       D3E6                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000D70 D3E6 CD09E6          17      CALL    _SYS07
000D73 D3E9 FE03             7      CP  3
000D75 D3EB CCF4E6          17      CALL    Z,_BREAK
000D78 D3EE FE13             7      CP  013H        ;CTRL+S
000D7A D3F0 C0              11      RET NZ
       D3F1                     PAUSE:
000D7B D3F1 CD0BD4          17      CALL    KEYBC
                                
       D3F4                     BREAK:
000D7E D3F4 F5              11      PUSH    AF
000D7F D3F5 C5              11      PUSH    BC
000D80 D3F6 D5              11      PUSH    DE
000D81 D3F7 E5              11      PUSH    HL
000D82 D3F8 DDE5            15      PUSH    IX
000D84 D3FA DD21B700        14      LD  IX,BREAKX
000D88 D3FE CD1DD6          17      CALL    CALSLT_R
000D8B D401 DDE1            14      POP IX
000D8D D403 E1              10      POP HL
000D8E D404 D1              10      POP DE
000D8F D405 C1              10      POP BC
000D90 D406 DCF4E6          17      CALL    C,_BREAK
000D93 D409 F1              10      POP AF
000D94 D40A C9              10      RET
       D40B                     KEYBC:
000D95 D40B F5              11      PUSH    AF
000D96 D40C C5              11      PUSH    BC
000D97 D40D D5              11      PUSH    DE
000D98 D40E E5              11      PUSH    HL
000D99 D40F DDE5            15      PUSH    IX
000D9B D411 DD215601        14      LD  IX,KILBUF
000D9F D415 CD1DD6          17      CALL    CALSLT_R
000DA2 D418 DDE1            14      POP IX
000DA4 D41A E1              10      POP HL
000DA5 D41B D1              10      POP DE
000DA6 D41C C1              10      POP BC
000DA7 D41D F1              10      POP AF
000DA8 D41E C9              10      RET
       D41F                     FLGET:
000DA9 D41F C5              11      PUSH    BC
000DAA D420 D5              11      PUSH    DE
000DAB D421 E5              11      PUSH    HL
000DAC D422 DDE5            15      PUSH    IX
000DAE D424 CDDFE6          17      CALL    _FFLUSH
000DB1 D427 181B            12      JR  FLGET1
       D428                     CBIOS_SWC1  EQU $-1
000DB3 D429 CD05D6          17      CALL    GETVRAM
                                
000DB6 D42C E5              11      PUSH    HL
000DB7 D42D DD214A00        14      LD  IX,RDVRM
000DBB D431 CD1DD6          17      CALL    CALSLT_R
000DBE D434 E1              10      POP HL
000DBF D435 3250D4          13      LD  (SWCCHR),A
                                
000DC2 D438 E5              11      PUSH    HL
000DC3 D439 3EFF             7      LD  A,0FFH
000DC5 D43B DD214D00        14      LD  IX,WRTVRM
000DC9 D43F CD1DD6          17      CALL    CALSLT_R
000DCC D442 E1              10      POP HL
                                
000DCD D443 E5              11      PUSH    HL
       D444                     FLGET1:
000DCE D444 DD219F00        14      LD  IX,CHGET
000DD2 D448 CD1DD6          17      CALL    CALSLT_R
000DD5 D44B 180C            12      JR  FLGET2
       D44C                     CBIOS_SWC2  EQU $-1
000DD7 D44D E1              10      POP HL
                                
000DD8 D44E F5              11      PUSH    AF
000DD9 D44F 3E00             7      LD  A,0
       D450                     SWCCHR  EQU $-1
000DDB D451 DD214D00        14      LD  IX,WRTVRM
000DDF D455 CD1DD6          17      CALL    CALSLT_R
000DE2 D458 F1              10      POP AF
       D459                     FLGET2:
000DE3 D459 DDE1            14      POP IX
000DE5 D45B E1              10      POP HL
000DE6 D45C D1              10      POP DE
000DE7 D45D C1              10      POP BC
000DE8 D45E FE03             7      CP  3
000DEA D460 C0              11      RET NZ
000DEB D461 C300E6          10      JP  CPM_BOOT
                                
       D464                     INKEY:
000DEE D464 CD06E6          17      CALL    CPM_CONST
000DF1 D467 C8              11      RET Z
000DF2 D468 18B5            12      JR  FLGET
                                
       D46A                     _SYS0A:     ;(BDOS)文字列入力
000DF4 D46A C5              11      PUSH    BC
000DF5 D46B E5              11      PUSH    HL
000DF6 D46C D5              11      PUSH    DE
000DF7 D46D CD96D4          17      CALL    GETL
000DFA D470 111FF4          10      LD  DE,KBUF
000DFD D473 E1              10      POP HL
000DFE D474 E5              11      PUSH    HL
000DFF D475 0E00             7      LD  C,0
000E01 D477 3004            12      JR  NC,SAX0
000E03 D479 23               6      INC HL
000E04 D47A 23               6      INC HL
000E05 D47B 1808            12      JR  SAX4
       D47D                     SAX0:
000E07 D47D 46               7      LD  B,(HL)
000E08 D47E 23               6      INC HL
       D47F                     SAX1:
000E09 D47F 23               6      INC HL
000E0A D480 1A               7      LD  A,(DE)
000E0B D481 13               6      INC DE
000E0C D482 B7               4      OR  A
000E0D D483 2004            12      JR  NZ,SAX2
       D485                     SAX4:
000E0F D485 360D            10      LD  (HL),00DH
000E11 D487 1804            12      JR  SAX3
       D489                     SAX2:
000E13 D489 77               7      LD  (HL),A
000E14 D48A 0C               4      INC C
000E15 D48B 10F2            13      DJNZ    SAX1
       D48D                     SAX3:
000E17 D48D D1              10      POP DE
000E18 D48E 79               4      LD  A,C
000E19 D48F 13               6      INC DE
000E1A D490 12               7      LD  (DE),A
000E1B D491 1B               6      DEC DE
000E1C D492 E1              10      POP HL
000E1D D493 C1              10      POP BC
000E1E D494 A7               4      AND A
000E1F D495 C9              10      RET
       D496                     GETL:
000E20 D496 DDE5            15      PUSH    IX
000E22 D498 FDE5            15      PUSH    IY
                                
000E24 D49A 2ADCF3          16      LD  HL,(CSRY)
000E27 D49D 22CAFB          16      LD  (FSTPOS),HL
       D4A0                     GETL1:
000E2A D4A0 CDE6D3          17      CALL    _SYS08
000E2D D4A3 FE09             7      CP  9
000E2F D4A5 2008            12      JR  NZ,GETL1V
000E31 D4A7 211FF4          10      LD  HL,KBUF
000E34 D4AA CD17D1          17      CALL    MSX
000E37 D4AD 18F1            12      JR  GETL1
       D4AF                     GETL1V:
000E39 D4AF 5F               4      LD  E,A
000E3A D4B0 FE08             7      CP  8
000E3C D4B2 CCABD5          17      CALL    Z,CTRL02
000E3F D4B5 FE20             7      CP  020H
000E41 D4B7 D4D7D5          17      CALL    NC,INSERT
000E44 D4BA CDAED3          17      CALL    MSGA1
                                
000E47 D4BD 7B               4      LD  A,E
000E48 D4BE FE0D             7      CP  00DH
000E4A D4C0 20DE            12      JR  NZ,GETL1
                                
000E4C D4C2 111FF4          10      LD  DE,KBUF
000E4F D4C5 3AB0F3          13      LD  A,(LINLEN)
000E52 D4C8 47               4      LD  B,A
000E53 D4C9 CDBBCF          17      CALL    ZERO_MEMORY_DE
                                
000E56 D4CC 2ACAFB          16      LD  HL,(FSTPOS)
000E59 D4CF 3ADCF3          13      LD  A,(CSRY)
000E5C D4D2 6F               4      LD  L,A
000E5D D4D3 E5              11      PUSH    HL
000E5E D4D4 CD08D6          17      CALL    LOC0
000E61 D4D7 4D               4      LD  C,L
000E62 D4D8 44               4      LD  B,H
000E63 D4D9 E1              10      POP HL
000E64 D4DA 3AB0F3          13      LD  A,(LINLEN)
000E67 D4DD 94               4      SUB H
000E68 D4DE 3D               4      DEC A
000E69 D4DF 5F               4      LD  E,A
000E6A D4E0 211FF4          10      LD  HL,KBUF
       D4E3                     GETL2:
000E6D D4E3 CDD0E6          17      CALL    _SCRN
000E70 D4E6 03               6      INC BC
000E71 D4E7 77               7      LD  (HL),A
000E72 D4E8 23               6      INC HL
000E73 D4E9 1D               4      DEC E
000E74 D4EA 20F7            12      JR  NZ,GETL2
000E76 D4EC CDCBD3          17      CALL    MSG_CR
                                
000E79 D4EF FDE1            14      POP IY
000E7B D4F1 DDE1            14      POP IX
       D4F3                     GETL3:
000E7D D4F3 2B               6      DEC HL
000E7E D4F4 7E               7      LD  A,(HL)
000E7F D4F5 FE21             7      CP  021H
000E81 D4F7 D0              11      RET NC
000E82 D4F8 3600            10      LD  (HL),0
000E84 D4FA 15               4      DEC D
000E85 D4FB 20F6            12      JR  NZ,GETL3
000E87 D4FD C9              10      RET
                                
       D4FE                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       D4FE                     CONSTX:
000E88 D4FE C5              11      PUSH    BC
000E89 D4FF D5              11      PUSH    DE
000E8A D500 E5              11      PUSH    HL
000E8B D501 DDE5            15      PUSH    IX
000E8D D503 DD219C00        14      LD  IX,CHSNS
000E91 D507 CD1DD6          17      CALL    CALSLT_R
000E94 D50A DDE1            14      POP IX
000E96 D50C E1              10      POP HL
000E97 D50D D1              10      POP DE
000E98 D50E C1              10      POP BC
000E99 D50F C9              10      RET
                                
       D510                     _SYS2A:     ;(BDOS)日付の獲得
000E9A D510 0E0B             7      LD  C,11        ;年/Year→HL
000E9C D512 CD51D5          17      CALL    RDCLK_BCD
000E9F D515 6F               4      LD  L,A
000EA0 D516 2600             7      LD  H,0
000EA2 D518 3AF8FA          13      LD  A,(EXBRSA)
000EA5 D51B B7               4      OR  A
000EA6 D51C 2804            12      JR  Z,SX2A1
000EA8 D51E 11BC07          10      LD  DE,1980     ;1980年～2079年
000EAB D521 19              11      ADD HL,DE
       D522                     SX2A1:
000EAC D522 0E09             7      LD  C,9     ;月/Month→D
000EAE D524 CD51D5          17      CALL    RDCLK_BCD
000EB1 D527 57               4      LD  D,A
                                
000EB2 D528 0E07             7      LD  C,7     ;日/Day→E
000EB4 D52A CD51D5          17      CALL    RDCLK_BCD
000EB7 D52D 5F               4      LD  E,A
                                
000EB8 D52E 0E06             7      LD  C,6     ;曜日/Week→A
       D530                     RDCLK:
000EBA D530 DDE5            15      PUSH    IX
000EBC D532 DD21F501        14      LD  IX,REDCLK
       D536                     WRCLK1:
000EC0 D536 3AF8FA          13      LD  A,(EXBRSA)
000EC3 D539 B7               4      OR  A
000EC4 D53A 280A            12      JR  Z,RDCLK1    ;MSX1
000EC6 D53C FDE5            15      PUSH    IY
000EC8 D53E FD67             9      LD  IYH,A
000ECA D540 78               4      LD  A,B
000ECB D541 CD3BD6          17      CALL    CALSLT
000ECE D544 FDE1            14      POP IY
       D546                     RDCLK1:
000ED0 D546 DDE1            14      POP IX
000ED2 D548 C9              10      RET
       D549                     WRCLK:
000ED3 D549 DDE5            15      PUSH    IX
000ED5 D54B DD21F901        14      LD  IX,WRTCLK
000ED9 D54F 18E5            12      JR  WRCLK1
                                
       D551                     RDCLK_BCD:
000EDB D551 CD30D5          17      CALL    RDCLK       ;1の位
000EDE D554 47               4      LD  B,A
000EDF D555 0C               4      INC C
000EE0 D556 CD30D5          17      CALL    RDCLK       ;10の位
000EE3 D559 87               4      ADD A,A     ;*2
000EE4 D55A 4F               4      LD  C,A
000EE5 D55B 87               4      ADD A,A     ;*4
000EE6 D55C 87               4      ADD A,A     ;*8
000EE7 D55D 81               4      ADD A,C     ;*10(8+2)
000EE8 D55E 80               4      ADD A,B     ;1の位
000EE9 D55F C9              10      RET
                                
       D560                     _SYS2C:     ;(BDOS)時刻の獲得
000EEA D560 011501          10      LD  BC,00115H       ;12時間計/24時間計の設定を24時間計に
000EED D563 CD49D5          17      CALL    WRCLK
000EF0 D566 0E04             7      LD  C,4     ;H=時/Hour
000EF2 D568 CD51D5          17      CALL    RDCLK_BCD
000EF5 D56B 67               4      LD  H,A
000EF6 D56C 0E02             7      LD  C,2     ;L=分/Minute
000EF8 D56E CD51D5          17      CALL    RDCLK_BCD
000EFB D571 6F               4      LD  L,A
000EFC D572 0E00             7      LD  C,0     ;D=秒/Second
000EFE D574 CD51D5          17      CALL    RDCLK_BCD
000F01 D577 57               4      LD  D,A
000F02 D578 AF               4      XOR A       ;E=1/100秒
000F03 D579 5F               4      LD  E,A
000F04 D57A C9              10      RET
                                
       D57B                     POS:
000F05 D57B F5              11      PUSH    AF
000F06 D57C 2ADCF3          16      LD  HL,(CSRY)
000F09 D57F 7D               4      LD  A,L
000F0A D580 6C               4      LD  L,H
000F0B D581 67               4      LD  H,A
000F0C D582 2C               4      INC L
000F0D D583 24               4      INC H
000F0E D584 F1              10      POP AF
000F0F D585 C9              10      RET
                                
       D586                     LOC:
000F10 D586 F5              11      PUSH    AF
000F11 D587 E5              11      PUSH    HL
000F12 D588 7D               4      LD  A,L
000F13 D589 6C               4      LD  L,H
000F14 D58A 67               4      LD  H,A
000F15 D58B 2D               4      DEC L
000F16 D58C 25               4      DEC H
000F17 D58D DDE5            15      PUSH    IX
000F19 D58F DD21C600        14      LD  IX,POSIT
000F1D D593 CD1DD6          17      CALL    CALSLT_R
000F20 D596 DDE1            14      POP IX
000F22 D598 E1              10      POP HL
000F23 D599 F1              10      POP AF
000F24 D59A C9              10      RET
       D59B                     SCRN:
000F25 D59B E5              11      PUSH    HL
000F26 D59C DDE5            15      PUSH    IX
                                
000F28 D59E 69               4      LD  L,C
000F29 D59F 60               4      LD  H,B
000F2A D5A0 DD214A00        14      LD  IX,RDVRM
000F2E D5A4 CD1DD6          17      CALL    CALSLT_R
                                
000F31 D5A7 DDE1            14      POP IX
000F33 D5A9 E1              10      POP HL
000F34 D5AA C9              10      RET
                                
       D5AB                     CTRL02:
000F35 D5AB F5              11      PUSH    AF
000F36 D5AC D5              11      PUSH    DE
000F37 D5AD 2ADCF3          16      LD  HL,(CSRY)
000F3A D5B0 3AB0F3          13      LD  A,(LINLEN)
000F3D D5B3 4F               4      LD  C,A
000F3E D5B4 94               4      SUB H   ;CSRX
000F3F D5B5 C602             7      ADD A,2
000F41 D5B7 47               4      LD  B,A ;カーソルより右の文字数
000F42 D5B8 61               4      LD  H,C ;LINLEN
000F43 D5B9 C5              11      PUSH    BC
000F44 D5BA CD08D6          17      CALL    LOC0
000F47 D5BD C1              10      POP BC
                                
000F48 D5BE 1620             7      LD  D,020H
       D5C0                     C8X1:
000F4A D5C0 DD214A00        14      LD  IX,RDVRM
000F4E D5C4 CD1DD6          17      CALL    CALSLT_R
000F51 D5C7 4F               4      LD  C,A
000F52 D5C8 7A               4      LD  A,D
000F53 D5C9 DD214D00        14      LD  IX,WRTVRM
000F57 D5CD CD1DD6          17      CALL    CALSLT_R
000F5A D5D0 2B               6      DEC HL
000F5B D5D1 51               4      LD  D,C
000F5C D5D2 10EC            13      DJNZ    C8X1
000F5E D5D4 D1              10      POP DE
000F5F D5D5 F1              10      POP AF
000F60 D5D6 C9              10      RET
                                
       D5D7                     INSERT:
000F61 D5D7 F5              11      PUSH    AF
000F62 D5D8 D5              11      PUSH    DE
000F63 D5D9 2ADCF3          16      LD  HL,(CSRY)
000F66 D5DC 3AB0F3          13      LD  A,(LINLEN)
000F69 D5DF 4F               4      LD  C,A
000F6A D5E0 94               4      SUB H   ;CSRX
000F6B D5E1 3C               4      INC A
000F6C D5E2 47               4      LD  B,A ;カーソルより右の文字数
000F6D D5E3 C5              11      PUSH    BC
000F6E D5E4 CD08D6          17      CALL    LOC0
000F71 D5E7 C1              10      POP BC
                                
000F72 D5E8 1620             7      LD  D,020H
       D5EA                     INS1:
000F74 D5EA DD214A00        14      LD  IX,RDVRM
000F78 D5EE CD1DD6          17      CALL    CALSLT_R
000F7B D5F1 4F               4      LD  C,A
000F7C D5F2 7A               4      LD  A,D
000F7D D5F3 DD214D00        14      LD  IX,WRTVRM
000F81 D5F7 CD1DD6          17      CALL    CALSLT_R
000F84 D5FA 23               6      INC HL
000F85 D5FB 51               4      LD  D,C
000F86 D5FC 10EC            13      DJNZ    INS1
000F88 D5FE D1              10      POP DE
000F89 D5FF F1              10      POP AF
000F8A D600 C9              10      RET
                                
       D601                     CONOUT1:
000F8B D601 59               4      LD  E,C
000F8C D602 C3CDE6          10      JP  _PRINT
                                
       D605                     GETVRAM:
000F8F D605 2ADCF3          16      LD  HL,(CSRY)
       D608                     LOC0:
000F92 D608 2D               4      DEC L
000F93 D609 25               4      DEC H
000F94 D60A 4C               4      LD  C,H ;CSRX-1
000F95 D60B 5D               4      LD  E,L ;CSRY-1
       D60C                     LOC1:
000F96 D60C 3AB0F3          13      LD  A,(LINLEN)
000F99 D60F 67               4      LD  H,A
000F9A D610 1600             7      LD  D,0
000F9C D612 6A               4      LD  L,D ;0
000F9D D613 0608             7      LD  B,8
       D615                     LOC2:
000F9F D615 29              11      ADD HL,HL
000FA0 D616 3001            12      JR  NC,LOC3
000FA2 D618 19              11      ADD HL,DE
       D619                     LOC3:
000FA3 D619 10FA            13      DJNZ    LOC2
000FA5 D61B 09              11      ADD HL,BC
000FA6 D61C C9              10      RET
                                
       D61D                     CALSLT_R:
000FA7 D61D FDE5            15      PUSH    IY
000FA9 D61F FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000FAD D623 CD3BD6          17      CALL    CALSLT
000FB0 D626 FDE1            14      POP IY
000FB2 D628 C9              10      RET
                                
       D629                     JP_IX:
000FB3 D629 DDE9             8      JP  (IX)
                                
       D62B                     CALLF:
000FB5 D62B E3              19      EX  (SP),HL
000FB6 D62C F5              11      PUSH    AF
000FB7 D62D 7E               7      LD  A,(HL)
000FB8 D62E FD67             9      LD  IYH,A
000FBA D630 23               6      INC HL
000FBB D631 7E               7      LD  A,(HL)
000FBC D632 DD6F             9      LD  IXL,A
000FBE D634 23               6      INC HL
000FBF D635 7E               7      LD  A,(HL)
000FC0 D636 DD67             9      LD  IXH,A
000FC2 D638 23               6      INC HL
000FC3 D639 F1              10      POP AF
000FC4 D63A E3              19      EX  (SP),HL
       D63B                     CALSLT:
000FC5 D63B 08               4      EX  AF,AF'
000FC6 D63C F5              11      PUSH    AF      ;裏AFを保存
000FC7 D63D F3               4      DI
000FC8 D63E ED7358D6        20      LD  (CSSP),SP
000FCC D642 3A59D6          13      LD  A,(CSSP+1)
000FCF D645 FE41             7      CP  040H+1
000FD1 D647 3808            12      JR  C,CALSLT_1
000FD3 D649 CD5CD6          17      CALL    CALSLT_2
       D64C                     CALSLT_E:
000FD6 D64C 08               4      EX  AF,AF'
000FD7 D64D F1              10      POP AF      ;保存した裏AF
000FD8 D64E 08               4      EX  AF,AF'
000FD9 D64F FB               4      EI
000FDA D650 C9              10      RET
       D651                     CALSLT_1:
000FDB D651 315DF5          10      LD  SP,SPBUF
000FDE D654 CD5CD6          17      CALL    CALSLT_2
000FE1 D657 310000          10      LD  SP,0
       D658                     CSSP    EQU $-2
000FE4 D65A 18F0            12      JR  CALSLT_E
                                
       D65C                     CALSLT_2:
000FE6 D65C C5              11      PUSH    BC
000FE7 D65D E5              11      PUSH    HL
000FE8 D65E DD7C             9      LD  A,IXH
000FEA D660 67               4      LD  H,A
000FEB D661 FD7C             9      LD  A,IYH
000FED D663 CDD0D6          17      CALL    ENASLT
000FF0 D666 E1              10      POP HL
000FF1 D667 C1              10      POP BC
000FF2 D668 F5              11      PUSH    AF      ;A:元のスロット
000FF3 D669 08               4      EX  AF,AF'
000FF4 D66A CD29D6          17      CALL    JP_IX
000FF7 D66D 08               4      EX  AF,AF'      ;裏A:戻り値
000FF8 D66E F1              10      POP AF      ;A:元のスロット
000FF9 D66F 08               4      EX  AF,AF'      ;A:戻り値 裏A:元のスロット
000FFA D670 C5              11      PUSH    BC
000FFB D671 E5              11      PUSH    HL
000FFC D672 DD44             9      LD  B,IXH
000FFE D674 60               4      LD  H,B
000FFF D675 08               4      EX  AF,AF'      ;A:元のスロット 裏A:戻り値
001000 D676 CDD0D6          17      CALL    ENASLT
001003 D679 08               4      EX  AF,AF'      ;A:戻り値
001004 D67A E1              10      POP HL
001005 D67B C1              10      POP BC
001006 D67C C9              10      RET
                                
       D67D                     RDSLT:
001007 D67D E5              11      PUSH    HL
001008 D67E CDD0D6          17      CALL    ENASLT
00100B D681 E1              10      POP HL
00100C D682 46               7      LD  B,(HL)
00100D D683 C5              11      PUSH    BC
00100E D684 E5              11      PUSH    HL
00100F D685 CDD0D6          17      CALL    ENASLT
001012 D688 E1              10      POP HL
001013 D689 F1              10      POP AF
001014 D68A C9              10      RET
                                
       D68B                     WRSLT:
001015 D68B E5              11      PUSH    HL
001016 D68C CDD0D6          17      CALL    ENASLT
001019 D68F E1              10      POP HL
00101A D690 73               7      LD  (HL),E
00101B D691 E5              11      PUSH    HL
00101C D692 CDD0D6          17      CALL    ENASLT
00101F D695 E1              10      POP HL
001020 D696 C9              10      RET
                                
       D697                     ENASLT1:
001021 D697 CB74             8      BIT 6,H
001023 D699 C0              11      RET NZ          ;ページ3はスロット切り替え不可
                                ;
                                ;ページ2専門のENASLT
                                ;in
                                ;A←スロット
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       D69A                     ENASLT_80H:
001024 D69A F3               4      DI
001025 D69B 6F               4      LD  L,A
001026 D69C E603             7      AND 3
001028 D69E 87               4      ADD A,A
001029 D69F 87               4      ADD A,A
00102A D6A0 87               4      ADD A,A
00102B D6A1 87               4      ADD A,A
00102C D6A2 4F               4      LD  C,A
00102D D6A3 DBA8            11      IN  A,(0A8H)
00102F D6A5 67               4      LD  H,A
001030 D6A6 E6CF             7      AND 0CFH
001032 D6A8 B1               4      OR  C
001033 D6A9 D3A8            11      OUT (0A8H),A
001035 D6AB 7C               4      LD  A,H
001036 D6AC 0F               4      RRCA
001037 D6AD 0F               4      RRCA
001038 D6AE 0F               4      RRCA
001039 D6AF 0F               4      RRCA
00103A D6B0 E603             7      AND 3
00103C D6B2 CB7D             8      BIT 7,L
00103E D6B4 C8              11      RET Z
00103F D6B5 F680             7      OR  080H
001041 D6B7 67               4      LD  H,A
001042 D6B8 7D               4      LD  A,L
001043 D6B9 07               4      RLCA
001044 D6BA 07               4      RLCA
001045 D6BB E630             7      AND 030H
001047 D6BD 4F               4      LD  C,A
001048 D6BE 3AFFFF          13      LD  A,(0FFFFH)
00104B D6C1 2F               4      CPL
00104C D6C2 47               4      LD  B,A
00104D D6C3 E6CF             7      AND 0CFH
00104F D6C5 B1               4      OR  C
001050 D6C6 32FFFF          13      LD  (0FFFFH),A
001053 D6C9 78               4      LD  A,B
001054 D6CA E630             7      AND 030H
001056 D6CC 0F               4      RRCA
001057 D6CD 0F               4      RRCA
001058 D6CE 1834            12      JR  ENASLT1_1
                                
                                ;
                                ;ENASLT
                                ;in
                                ;A←スロット
                                ;HL←上位2ビットで切り替えるページを指定
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       D6D0                     ENASLT:
00105A D6D0 CB7C             8      BIT 7,H
00105C D6D2 20C3            12      JR  NZ,ENASLT1
00105E D6D4 CB74             8      BIT 6,H
001060 D6D6 2039            12      JR  NZ,ENASLT_40H
                                ;
                                ;ページ0専門のENASLT
                                ;in
                                ;A←スロット
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       D6D8                     ENASLT_00H:
001062 D6D8 F3               4      DI
001063 D6D9 6F               4      LD  L,A
001064 D6DA E603             7      AND 3
001066 D6DC 4F               4      LD  C,A
001067 D6DD DBA8            11      IN  A,(0A8H)
001069 D6DF 67               4      LD  H,A
00106A D6E0 E6FC             7      AND 0FCH
00106C D6E2 B1               4      OR  C
00106D D6E3 D3A8            11      OUT (0A8H),A
00106F D6E5 7C               4      LD  A,H
001070 D6E6 E603             7      AND 3
001072 D6E8 CB7D             8      BIT 7,L
001074 D6EA C8              11      RET Z
001075 D6EB F680             7      OR  080H
001077 D6ED 67               4      LD  H,A
001078 D6EE 7D               4      LD  A,L
001079 D6EF 0F               4      RRCA
00107A D6F0 0F               4      RRCA
00107B D6F1 E603             7      AND 3
00107D D6F3 4F               4      LD  C,A
00107E D6F4 3AFFFF          13      LD  A,(0FFFFH)
001081 D6F7 2F               4      CPL
001082 D6F8 47               4      LD  B,A
001083 D6F9 E6FC             7      AND 0FCH
001085 D6FB B1               4      OR  C
001086 D6FC 32FFFF          13      LD  (0FFFFH),A
001089 D6FF 78               4      LD  A,B
00108A D700 E603             7      AND 3
00108C D702 87               4      ADD A,A
00108D D703 87               4      ADD A,A
       D704                     ENASLT1_1:
00108E D704 B4               4      OR  H
00108F D705 4F               4      LD  C,A
                                
001090 D706 7D               4      LD  A,L
001091 D707 E603             7      AND 3
001093 D709 C6C5             7      ADD A,LOW SLTTBL
001095 D70B 6F               4      LD  L,A
001096 D70C 26FC             7      LD  H,HIGH SLTTBL
001098 D70E 70               7      LD  (HL),B
001099 D70F 79               4      LD  A,C
00109A D710 C9              10      RET
                                
                                ;
                                ;ページ1専門のENASLT
                                ;in
                                ;A←スロット
                                ;out
                                ;A←切り替え前のスロット
                                ;破壊
                                ;BCHL
                                ;
       D711                     ENASLT_40H:
00109B D711 F3               4      DI
00109C D712 6F               4      LD  L,A
00109D D713 E603             7      AND 3
00109F D715 87               4      ADD A,A
0010A0 D716 87               4      ADD A,A
0010A1 D717 4F               4      LD  C,A
0010A2 D718 DBA8            11      IN  A,(0A8H)
0010A4 D71A 67               4      LD  H,A
0010A5 D71B E6F3             7      AND 0F3H
0010A7 D71D B1               4      OR  C
0010A8 D71E D3A8            11      OUT (0A8H),A
0010AA D720 7C               4      LD  A,H
0010AB D721 0F               4      RRCA
0010AC D722 0F               4      RRCA
0010AD D723 E603             7      AND 3
0010AF D725 CB7D             8      BIT 7,L
0010B1 D727 C8              11      RET Z
0010B2 D728 F680             7      OR  080H
0010B4 D72A 67               4      LD  H,A
0010B5 D72B 7D               4      LD  A,L
0010B6 D72C E60C             7      AND 00CH
0010B8 D72E 4F               4      LD  C,A
0010B9 D72F 3AFFFF          13      LD  A,(0FFFFH)
0010BC D732 2F               4      CPL
0010BD D733 47               4      LD  B,A
0010BE D734 E6F3             7      AND 0F3H
0010C0 D736 B1               4      OR  C
0010C1 D737 32FFFF          13      LD  (0FFFFH),A
0010C4 D73A 78               4      LD  A,B
0010C5 D73B E60C             7      AND 00CH
0010C7 D73D 18C5            12      JR  ENASLT1_1
                                
       D73F                     INT38H:
0010C9 D73F F5              11      PUSH    AF
0010CA D740 C5              11      PUSH    BC
0010CB D741 E5              11      PUSH    HL
0010CC D742 2100BF          10      LD  HL,010000H-04100H   ;メインROMを呼び出すのでスタックがPage1に被っていないかチェック
0010CF D745 39              11      ADD HL,SP
0010D0 D746 3825            12      JR  C,INT38H1
0010D2 D748 2A63D7          16      LD  HL,(INTSP)      ;別の割り込み中の場合は飛ばす
0010D5 D74B 7C               4      LD  A,H
0010D6 D74C B5               4      OR  L
0010D7 D74D 202A            12      JR  NZ,INT38H2
                                
0010D9 D74F ED7363D7        20      LD  (INTSP),SP  ;スタックポインタがページ1
0010DD D753 315DF5          10      LD  SP,SPBUF
0010E0 D756 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
0010E3 D759 CDD8D6          17      CALL    ENASLT_00H
0010E6 D75C CD3800          17      CALL    00038H
0010E9 D75F CDD8D6          17      CALL    ENASLT_00H
0010EC D762 310000          10      LD  SP,0
       D763                     INTSP   EQU $-2
0010EF D765 210000          10      LD  HL,0
0010F2 D768 2263D7          16      LD  (INTSP),HL
0010F5 D76B 180C            12      JR  INT38H2
                                
       D76D                     INT38H1:
0010F7 D76D 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
0010FA D770 CDD8D6          17      CALL    ENASLT_00H
0010FD D773 CD3800          17      CALL    00038H
001100 D776 CDD8D6          17      CALL    ENASLT_00H
       D779                     INT38H2:
001103 D779 E1              10      POP HL
001104 D77A C1              10      POP BC
001105 D77B F1              10      POP AF
001106 D77C FB               4      EI
001107 D77D C9              10      RET
                                
                                
                                
                                
                                
[EOF:MSXIO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       D77E                     FILEC:
001108 D77E CD89D7          17      CALL    FILE
       D781                     FILEC2:
00110B D781 3A15E6          13      LD  A,(FDRV+1)
00110E D784 FE20             7      CP  020H
001110 D786 C8              11      RET Z
001111 D787 1839            12      JR  SETDIR1
                                
       D789                     FILE:
001113 D789 AF               4      XOR A
001114 D78A 3214E6          13      LD  (FDRV),A
001117 D78D 67               4      LD  H,A
001118 D78E 6F               4      LD  L,A
001119 D78F 2222E6          16      LD  (FDRV+14),HL
00111C D792 CD5FD8          17      CALL    SPCUT
00111F D795 CD44D8          17      CALL    CCHK3
001122 D798 2812            12      JR  Z,DEVI1
001124 D79A 13               6      INC DE
001125 D79B 1A               7      LD  A,(DE)
001126 D79C 1B               6      DEC DE
001127 D79D FE3A             7      CP  ':'
001129 D79F 200B            12      JR  NZ,DEVI1
00112B D7A1 1A               7      LD  A,(DE)      ;DRIVE
00112C D7A2 CDA5DA          17      CALL    CAP
00112F D7A5 D640             7      SUB '@'
001131 D7A7 13               6      INC DE
001132 D7A8 13               6      INC DE
001133 D7A9 3214E6          13      LD  (FDRV),A
       D7AC                     DEVI1:
001136 D7AC 1A               7      LD  A,(DE)
001137 D7AD D65C             7      SUB 05CH        ;\
001139 D7AF 2009            12      JR  NZ,NOROOT
00113B D7B1 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
00113C D7B2 222EE6          16      LD  (FDRV+26),HL
00113F D7B5 2C               4      INC L
001140 D7B6 2222E6          16      LD  (FDRV+14),HL
001143 D7B9 13               6      INC DE
       D7BA                     NOROOT:
                                
       D7BA                     SETDIR:
001144 D7BA CDE5D7          17      CALL    FILED
001147 D7BD 1A               7      LD  A,(DE)
001148 D7BE FE5C             7      CP  05CH        ;\
00114A D7C0 C0              11      RET NZ
00114B D7C1 13               6      INC DE
       D7C2                     SETDIR1:
00114C D7C2 3E10             7      LD  A,010H      ;Directory
00114E D7C4 3221E6          13      LD  (FDRV+13),A
001151 D7C7 D5              11      PUSH    DE
001152 D7C8 1114E6          10      LD  DE,FDRV
001155 D7CB 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
001157 D7CD CDD7D0          17      CALL    BDOS0
00115A D7D0 D1              10      POP DE
00115B D7D1 B7               4      OR  A
00115C D7D2 C0              11      RET NZ
                                
00115D D7D3 3A21E6          13      LD  A,(FDRV+13)
001160 D7D6 E610             7      AND 010H        ;ディレクトリ
001162 D7D8 C8              11      RET Z
                                
001163 D7D9 CD2CD8          17      CALL    FILEI
001166 D7DC 2A2EE6          16      LD  HL,(FDRV+26)
001169 D7DF 23               6      INC HL
00116A D7E0 2222E6          16      LD  (FDRV+14),HL
00116D D7E3 18D5            12      JR  SETDIR
                                
       D7E5                     FILED:
00116F D7E5 CD2CD8          17      CALL    FILEI
001172 D7E8 2115E6          10      LD  HL,FNAME
                                
001175 D7EB 0608             7      LD  B,8
       D7ED                     FILE2:
001177 D7ED CD39D8          17      CALL    CCHKF
00117A D7F0 C8              11      RET Z
00117B D7F1 FE2A             7      CP  '*'
00117D D7F3 282E            12      JR  Z,FILE9
00117F D7F5 FE2E             7      CP  '.'
001181 D7F7 280C            12      JR  Z,FILE4
001183 D7F9 77               7      LD  (HL),A
001184 D7FA 23               6      INC HL
001185 D7FB 10F0            13      DJNZ    FILE2
                                
       D7FD                     FILE3:
001187 D7FD CD39D8          17      CALL    CCHKF
00118A D800 C8              11      RET Z
00118B D801 FE2E             7      CP  '.'
00118D D803 20F8            12      JR  NZ,FILE3
                                
       D805                     FILE4:
00118F D805 211DE6          10      LD  HL,FNAME+8
001192 D808 0603             7      LD  B,3
                                
       D80A                     FILE4L:
001194 D80A CD39D8          17      CALL    CCHKF
001197 D80D C8              11      RET Z
001198 D80E FE2E             7      CP  '.'
00119A D810 2008            12      JR  NZ,FILE12
00119C D812 3215E6          13      LD  (FNAME),A   ;Parent directory(..)
00119F D815 3216E6          13      LD  (FNAME+1),A
0011A2 D818 3E20             7      LD  A,020H
       D81A                     FILE12:
0011A4 D81A FE2A             7      CP  '*'
0011A6 D81C 280A            12      JR  Z,FILE10
0011A8 D81E 77               7      LD  (HL),A
0011A9 D81F 23               6      INC HL
0011AA D820 10E8            13      DJNZ    FILE4L
0011AC D822 C9              10      RET
                                
       D823                     FILE9:              ;名前の*処理、名前の残りを?で埋める
0011AD D823 CD28D8          17      CALL    FILE10
0011B0 D826 18D5            12      JR  FILE3
                                
       D828                     FILE10:
0011B2 D828 3E3F             7      LD  A,'?'
0011B4 D82A 1808            12      JR  FILL_MEMORY
       D82C                     FILEI:              ;名前＋拡張子をスペースで初期化
0011B6 D82C 3E20             7      LD  A,020H
0011B8 D82E 01000B          10      LD  BC,11*256   ;C=0にしておく
0011BB D831 2115E6          10      LD  HL,FNAME
       D834                     FILL_MEMORY:            ;HLからBバイトAで埋める
0011BE D834 77               7      LD  (HL),A
0011BF D835 23               6      INC HL
0011C0 D836 10FC            13      DJNZ    FILL_MEMORY
0011C2 D838 C9              10      RET
                                
       D839                     CCHKF:
0011C3 D839 1A               7      LD  A,(DE)
0011C4 D83A CD41D8          17      CALL    CCHK2
0011C7 D83D C8              11      RET Z
0011C8 D83E C3ADDB          10      JP  FKAN
                                
       D841                     CCHK2:
0011CB D841 0C               4      INC C
0011CC D842 0D               4      DEC C
0011CD D843 C0              11      RET NZ
       D844                     CCHK3:              ;ZF=1 で使えない文字
0011CE D844 FE2B             7      CP  '+'
0011D0 D846 C8              11      RET Z
0011D1 D847 FE2C             7      CP  ','
0011D3 D849 C8              11      RET Z
0011D4 D84A FE2F             7      CP  '/'
0011D6 D84C C8              11      RET Z
0011D7 D84D FE3A             7      CP  ':'
0011D9 D84F C8              11      RET Z
0011DA D850 FE3B             7      CP  ';'
0011DC D852 C8              11      RET Z
0011DD D853 FE3D             7      CP  '='
0011DF D855 C8              11      RET Z
0011E0 D856 FE5C             7      CP  05CH    ;\
0011E2 D858 C8              11      RET Z
0011E3 D859 FE20             7      CP  020H
0011E5 D85B D0              11      RET NC
0011E6 D85C BF               4      CP  A       ;Z=1
0011E7 D85D C9              10      RET
                                
       D85E                     SS1:
0011E8 D85E 13               6      INC DE
       D85F                     SPCUT:              ;スペースをカット
0011E9 D85F 1A               7      LD  A,(DE)
0011EA D860 FE20             7      CP  020H
0011EC D862 28FA            12      JR  Z,SS1
0011EE D864 C9              10      RET
                                
       D865                     SETDRVF:
0011EF D865 1114E6          10      LD  DE,FDRV
       D868                     SETDRV0:
0011F2 D868 CD71D8          17      CALL    SETDRV
0011F5 D86B FDE1            14      POP IY
0011F7 D86D C1              10      POP BC
0011F8 D86E D1              10      POP DE
0011F9 D86F E1              10      POP HL
0011FA D870 C9              10      RET
                                
       D871                     SETDRV:
0011FB D871 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
0011FC D872 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
0011FD D873 C5              11      PUSH    BC
0011FE D874 1A               7      LD  A,(DE)
0011FF D875 D5              11      PUSH    DE
001200 D876 FDE3            23      EX  (SP),IY
                                
001202 D878 CD7FD8          17      CALL    GETDRV
001205 D87B CDD9E6          17      CALL    _CHGDRV
                                
001208 D87E E9               4      JP  (HL)
                                
       D87F                     GETDRV:
001209 D87F CD92D8          17      CALL    GETDRV1
00120C D882 3288E6          13      LD  (_DRV),A
00120F D885 C9              10      RET
                                
       D886                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
001210 D886 CD92D8          17      CALL    GETDRV1
001213 D889 C5              11      PUSH    BC
001214 D88A 4F               4      LD  C,A
001215 D88B 1A               7      LD  A,(DE)
001216 D88C CD92D8          17      CALL    GETDRV1
001219 D88F A9               4      XOR C
00121A D890 C1              10      POP BC
00121B D891 C9              10      RET
       D892                     GETDRV1:
00121C D892 E67F             7      AND 07FH
00121E D894 D601             7      SUB 001H
001220 D896 D0              11      RET NC
001221 D897 3A0400          13      LD  A,(_DVSW)   ;Current Drive
001224 D89A C9              10      RET
                                
       D89B                     SOPENX:
001225 D89B 1139E6          10      LD  DE,SFILE
001228 D89E FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
00122B D8A1 CD86D8          17      CALL    IS_SAME_DRV_A_DE
00122E D8A4 2024            12      JR  NZ,SOPEN
001230 D8A6 13               6      INC DE
001231 D8A7 FDE5            15      PUSH    IY
001233 D8A9 E1              10      POP HL
001234 D8AA 23               6      INC HL
001235 D8AB CD36DA          17      CALL    CPFILE
001238 D8AE 201A            12      JR  NZ,SOPEN
                                
00123A D8B0 2AF4E7          16      LD  HL,(SCDIR)
00123D D8B3 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
001240 D8B6 FD740F          19      LD  (IY+15),H
                                
001243 D8B9 2AF8E7          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
001246 D8BC 229FE6          16      LD  (_FILEN),HL
                                
001249 D8BF ED5BF6E7        20      LD  DE,(SFBPS)
00124D D8C3 2139E6          10      LD  HL,SFILE
001250 D8C6 36FF            10      LD  (HL),0FFH
001252 D8C8 23               6      INC HL
001253 D8C9 C9              10      RET
       D8CA                     SOPEN:
001254 D8CA 21DED9          10      LD  HL,FILESE
       D8CD                     SOPENC:
001257 D8CD 2206D9          16      LD  (OPENPAT),HL
                                
00125A D8D0 CDE2E6          17      CALL    _RDFATX     ;Detect Media
00125D D8D3 3856            12      JR  C,RDDERR
                                
00125F D8D5 AF               4      XOR A
001260 D8D6 329FE6          13      LD  (_FILEN),A
001263 D8D9 CDE2DA          17      CALL    LDDIRX1     ;A=0で呼び出す
001266 D8DC 2818            12      JR  Z,SDIRX1
                                
001268 D8DE CDCFD9          17      CALL    READ_DIR    ;Sub Directory
00126B D8E1 3808            12      JR  C,SDIRX0
00126D D8E3 2A7EE7          16      LD  HL,(_DTBUF)
001270 D8E6 7E               7      LD  A,(HL)
001271 D8E7 FE2E             7      CP  '.'
001273 D8E9 280F            12      JR  Z,SOPEN1
       D8EB                     SDIRX0:
001275 D8EB AF               4      XOR A
001276 D8EC 32A0E6          13      LD  (_DIRF),A
001279 D8EF FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
00127D D8F3 FD770F          19      LD  (IY+15),A
       D8F6                     SDIRX1:
001280 D8F6 ED5BFCE7        20      LD  DE,(_DIRPS) ;Root Directory
       D8FA                     SOPEN1:
001284 D8FA 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       D8FB                     SDECPAT EQU $-1
       D8FC                     SOPEN1X:
001286 D8FC CDCFD9          17      CALL    READ_DIR    ;FILE SEARCH
001289 D8FF 382A            12      JR  C,RDDERR
00128B D901 2A7EE7          16      LD  HL,(_DTBUF)
       D904                     SOPEN2:
00128E D904 D5              11      PUSH    DE
00128F D905 CDDED9          17      CALL    FILESE      ;(self-modifying code)
       D906                     OPENPAT EQU $-2
001292 D908 D1              10      POP DE
001293 D909 386D            12      JR  C,SOPENE
001295 D90B 281B            12      JR  Z,SCF_FF_RET
       D90D                     SOPEN3:
001297 D90D 3AA0E6          13      LD  A,(_DIRF)   ;ディレクトリか判別
00129A D910 B7               4      OR  A
00129B D911 200C            12      JR  NZ,SOPEN5
00129D D913 13               6      INC DE      ;ルートディレクトリ
00129E D914 E5              11      PUSH    HL
00129F D915 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       D916                     MD_PAT  EQU $-2
0012A2 D918 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
0012A4 D91A E1              10      POP HL
0012A5 D91B 20DD            12      JR  NZ,SOPEN1
0012A7 D91D 1807            12      JR  SOPEN6
       D91F                     SOPEN5:
0012A9 D91F CDE9E1          17      CALL    GNCLX       ;END DIR
0012AC D922 D8              11      RET C
0012AD D923 CD96DA          17      CALL    ENDCL
       D926                     SOPEN6:
0012B0 D926 38D2            12      JR  C,SOPEN1
       D928                     SCF_FF_RET:
0012B2 D928 37               4      SCF         ;CF=1
0012B3 D929 9F               4      SBC A,A     ;A=0FFH
0012B4 D92A C9              10      RET
                                
       D92B                     RDDERR:
0012B5 D92B BF               4      CP  A       ;READ ERR CF=1 ZF=1
0012B6 D92C 37               4      SCF
0012B7 D92D C9              10      RET
                                
       D92E                     NOPEN:
0012B8 D92E 21DED9          10      LD  HL,FILESE
0012BB D931 2206D9          16      LD  (OPENPAT),HL
0012BE D934 FD2A98E6        20      LD  IY,(_FCB)
0012C2 D938 CDC0DB          17      CALL    CHKWILDX
0012C5 D93B 30EB            12      JR  NC,SCF_FF_RET
0012C7 D93D FD7E00          19      LD  A,(IY+0)
0012CA D940 CD7FD8          17      CALL    GETDRV
0012CD D943 CDD9E6          17      CALL    _CHGDRV
0012D0 D946 D8              11      RET C
0012D1 D947 2AF8E7          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
0012D4 D94A 229FE6          16      LD  (_FILEN),HL
                                
0012D7 D94D CDDDDA          17      CALL    LDDIRX
0012DA D950 ED5B9AE6        20      LD  DE,(_FBPS)
0012DE D954 CDCFD9          17      CALL    READ_DIR
0012E1 D957 38D2            12      JR  C,RDDERR
0012E3 D959 3A9EE6          13      LD  A,(_FBCNT)
0012E6 D95C 3D               4      DEC A
0012E7 D95D 28AE            12      JR  Z,SOPEN3
       D95F                     NOPEN2:
0012E9 D95F 2A9CE6          16      LD  HL,(_FBAD)
0012EC D962 012000          10      LD  BC,020H
0012EF D965 09              11      ADD HL,BC
0012F0 D966 4F               4      LD  C,A
0012F1 D967 189B            12      JR  SOPEN2
                                
       D969                     SOPENE2:
0012F3 D969 229CE6          16      LD  (_FBAD),HL
0012F6 D96C 79               4      LD  A,C
0012F7 D96D 329EE6          13      LD  (_FBCNT),A
0012FA D970 ED539AE6        20      LD  (_FBPS),DE
0012FE D974 FD2298E6        20      LD  (_FCB),IY
       D978                     SOPENE:
001302 D978 AF               4      XOR A
001303 D979 C9              10      RET
                                
       D97A                     COPEN:
001304 D97A FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
001308 D97E 21FBD9          10      LD  HL,NEXTSE
00130B D981 CDCDD8          17      CALL    SOPENC
00130E D984 D0              11      RET NC
00130F D985 C8              11      RET Z
001310 D986 3AA0E6          13      LD  A,(_DIRF)   ;ディレクトリか判別
001313 D989 B7               4      OR  A
001314 D98A 37               4      SCF
001315 D98B C8              11      RET Z       ;ルートディレクトリ
001316 D98C 0601             7      LD  B,1
001318 D98E CD1FDC          17      CALL    WRDF
00131B D991 D8              11      RET C
00131C D992 ED5BFEE7        20      LD  DE,(_CLPS)
001320 D996 D5              11      PUSH    DE
001321 D997 CD5FDA          17      CALL    DCPAT
001324 D99A CD6AE0          17      CALL    DRDNX
001327 D99D 2A7EE7          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
00132A D9A0 ED4B55DF        20      LD  BC,(SECSZ)  ;1セクタのサイズ
00132E D9A4 AF               4      XOR A
       D9A5                     COPENCL:
00132F D9A5 77               7      LD  (HL),A
001330 D9A6 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001332 D9A8 EAA5D9          10      JP  PE,COPENCL
                                
001335 D9AB 3A7DDA          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
001338 D9AE 3D               4      DEC A
001339 D9AF 2819            12      JR  Z,COPENE
00133B D9B1 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
00133D D9B3 32E1E1          13      LD  (_SECPS),A
001340 D9B6 D1              10      POP DE      ;DE=(_CLPS)
001341 D9B7 D5              11      PUSH    DE
       D9B8                     COPEN1:
001342 D9B8 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
001343 D9B9 C5              11      PUSH    BC
001344 D9BA 2A7EE7          16      LD  HL,(_DTBUF)
001347 D9BD CD79DA          17      CALL    CLUSTX
00134A D9C0 CD80E3          17      CALL    DWT24
00134D D9C3 C1              10      POP BC
00134E D9C4 D1              10      POP DE
00134F D9C5 CDE0E1          17      CALL    NEXTX
001352 D9C8 20EE            12      JR  NZ,COPEN1
       D9CA                     COPENE:
001354 D9CA 2A7EE7          16      LD  HL,(_DTBUF)
001357 D9CD D1              10      POP DE
001358 D9CE C9              10      RET
                                
       D9CF                     READ_DIR:
001359 D9CF ED53FEE7        20      LD  (_CLPS),DE
00135D D9D3 C5              11      PUSH    BC
00135E D9D4 D5              11      PUSH    DE
00135F D9D5 CD5FDA          17      CALL    DCPAT
001362 D9D8 CD4AE0          17      CALL    DRDX
001365 D9DB D1              10      POP DE
001366 D9DC C1              10      POP BC
001367 D9DD C9              10      RET
                                
       D9DE                     FILESE:
001368 D9DE 7E               7      LD  A,(HL)
001369 D9DF B7               4      OR  A
00136A D9E0 C8              11      RET Z       ;END:ZF=1 CF=0
00136B D9E1 FEE5             7      CP  0E5H
00136D D9E3 280E            12      JR  Z,FILESE1
00136F D9E5 FDE5            15      PUSH    IY
001371 D9E7 D1              10      POP DE
001372 D9E8 13               6      INC DE
001373 D9E9 E5              11      PUSH    HL
001374 D9EA CD36DA          17      CALL    CPFILE
001377 D9ED CC57DA          17      CALL    Z,CPFILE2
00137A D9F0 E1              10      POP HL
00137B D9F1 37               4      SCF
00137C D9F2 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       D9F3                     FILESE1:
00137D D9F3 CD0ADA          17      CALL    FNEXT
001380 D9F6 20E6            12      JR  NZ,FILESE
       D9F8                     ZF0_CF0_AFF_RET:
001382 D9F8 F6FF             7      OR  0FFH        ;ZF=0 CF=0
001384 D9FA C9              10      RET
                                
       D9FB                     NEXTSE:
001385 D9FB 7E               7      LD  A,(HL)
001386 D9FC B7               4      OR  A
001387 D9FD 37               4      SCF
001388 D9FE C8              11      RET Z       ;!!!:ZF=1 CF=1
001389 D9FF FEE5             7      CP  0E5H
00138B DA01 37               4      SCF
00138C DA02 C8              11      RET Z       ;!!!:(ZF=1) CF=1
00138D DA03 CD0ADA          17      CALL    FNEXT
001390 DA06 20F3            12      JR  NZ,NEXTSE
001392 DA08 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       DA0A                     FNEXT:
001394 DA0A E5              11      PUSH    HL
001395 DA0B 219FE6          10      LD  HL,_FILEN
001398 DA0E 34              11      INC (HL)
001399 DA0F E1              10      POP HL
00139A DA10 112000          10      LD  DE,020H
00139D DA13 19              11      ADD HL,DE
00139E DA14 0D               4      DEC C
00139F DA15 C9              10      RET
                                
       DA16                     CPNAME:
0013A0 DA16 C5              11      PUSH    BC
0013A1 DA17 D5              11      PUSH    DE
0013A2 DA18 E5              11      PUSH    HL
0013A3 DA19 CD30DA          17      CALL    CPFILE4
0013A6 DA1C E1              10      POP HL
0013A7 DA1D 23               6      INC HL
0013A8 DA1E 23               6      INC HL
0013A9 DA1F 23               6      INC HL
0013AA DA20 23               6      INC HL
0013AB DA21 D1              10      POP DE
0013AC DA22 C1              10      POP BC
0013AD DA23 2005            12      JR  NZ,CPNAME1
0013AF DA25 7E               7      LD  A,(HL)
0013B0 DA26 23               6      INC HL
0013B1 DA27 66               7      LD  H,(HL)
0013B2 DA28 6F               4      LD  L,A
0013B3 DA29 C9              10      RET
       DA2A                     CPNAME1:
0013B4 DA2A 23               6      INC HL
0013B5 DA2B 23               6      INC HL
0013B6 DA2C 10E8            13      DJNZ    CPNAME
0013B8 DA2E 37               4      SCF
0013B9 DA2F C9              10      RET
                                
       DA30                     CPFILE4:
0013BA DA30 C5              11      PUSH    BC
0013BB DA31 010004          10      LD  BC,00400H
0013BE DA34 1804            12      JR  CPSTR1
       DA36                     CPFILE:
0013C0 DA36 C5              11      PUSH    BC
0013C1 DA37 01000B          10      LD  BC,00B00H
       DA3A                     CPSTR1:
0013C4 DA3A 1A               7      LD  A,(DE)
0013C5 DA3B FE3F             7      CP  '?'     ;Wild card
0013C7 DA3D 2812            12      JR  Z,CPSTR2
0013C9 DA3F 7E               7      LD  A,(HL)
0013CA DA40 CDA6DB          17      CALL    FKANC
0013CD DA43 E5              11      PUSH    HL
0013CE DA44 67               4      LD  H,A
0013CF DA45 1A               7      LD  A,(DE)
0013D0 DA46 CB01             8      RLC C
0013D2 DA48 CDA6DB          17      CALL    FKANC
0013D5 DA4B CB09             8      RRC C
0013D7 DA4D BC               4      CP  H       ;CP (HL),(DE)
0013D8 DA4E E1              10      POP HL
0013D9 DA4F 2004            12      JR  NZ,CPSTR3
       DA51                     CPSTR2:
0013DB DA51 13               6      INC DE
0013DC DA52 23               6      INC HL
0013DD DA53 10E5            13      DJNZ    CPSTR1
       DA55                     CPSTR3:
0013DF DA55 C1              10      POP BC
0013E0 DA56 C9              10      RET
                                
       DA57                     CPFILE2:
0013E1 DA57 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0013E4 DA5A F6E1             7      OR  0E1H
0013E6 DA5C 2F               4      CPL
0013E7 DA5D A6               7      AND (HL)
0013E8 DA5E C9              10      RET
                                
       DA5F                     DCPAT:
0013E9 DA5F 0E00             7      LD  C,0
0013EB DA61 2A7EE7          16      LD  HL,(_DTBUF)
0013EE DA64 3AA0E6          13      LD  A,(_DIRF)   ;ディレクトリか判別
0013F1 DA67 B7               4      OR  A
0013F2 DA68 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
0013F3 DA69 3A7DDA          13      LD  A,(SPCPAT)
0013F6 DA6C 4F               4      LD  C,A
0013F7 DA6D 3AE1E1          13      LD  A,(_SECPS)
0013FA DA70 B9               4      CP  C
0013FB DA71 3801            12      JR  C,DC1
0013FD DA73 AF               4      XOR A
       DA74                     DC1:
0013FE DA74 F680             7      OR  080H
001400 DA76 32A0E6          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       DA79                     CLUSTX:
001403 DA79 E5              11      PUSH    HL
001404 DA7A EB               4      EX  DE,HL
001405 DA7B AF               4      XOR A
001406 DA7C 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       DA7D                     SPCPAT  EQU $-1
       DA7E                     L_CLDBL:
001408 DA7E CB19             8      RR  C       ;->CF
00140A DA80 3804            12      JR  C,E_CLDBL
00140C DA82 29              11      ADD HL,HL       ;*2
00140D DA83 8F               4      ADC A,A
00140E DA84 18F8            12      JR  L_CLDBL
       DA86                     E_CLDBL:
001410 DA86 4F               4      LD  C,A
001411 DA87 3AE1E1          13      LD  A,(_SECPS)
001414 DA8A B5               4      OR  L
001415 DA8B 6F               4      LD  L,A
001416 DA8C 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       DA8D                     CLSPAT  EQU $-2
001419 DA8F AF               4      XOR A
00141A DA90 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
00141B DA91 89               4      ADC A,C
00141C DA92 4F               4      LD  C,A
00141D DA93 EB               4      EX  DE,HL
00141E DA94 E1              10      POP HL
00141F DA95 C9              10      RET
                                ;(8)
       DA96                     ENDCL:
001420 DA96 7A               4      LD  A,D ;END CLUSTER
001421 DA97 FE01             7      CP  1   ;164=356    (self-modifying code)
       DA98                     CLPAT1  EQU $-1
001423 DA99 C0              11      RET NZ
001424 DA9A 7B               4      LD  A,E
001425 DA9B FE64             7      CP  064H    ;       (self-modifying code)
       DA9C                     CLPAT2  EQU $-1
001427 DA9D C9              10      RET
                                ;(3)
       DA9E                     CAP4:
001428 DA9E 3EE5             7      LD  A,0E5H
00142A DAA0 C9              10      RET
                                                    ;for X1/88 ワークエリア
00142B DAA1 5BE6                    DW  _DISKE+1        ;DISKVE($F323)
00142D DAA3 F5E6                    DW  _BREAK+1        ;BREAKV($F325)
                                
       DAA5                     CAP:            ;(9)
00142F DAA5 FE61             7      CP  'a'
001431 DAA7 D8              11      RET C
001432 DAA8 FE7B             7      CP  'z'+1
001434 DAAA D0              11      RET NC
001435 DAAB D620             7      SUB 020H
001437 DAAD C9              10      RET
                                ;(10)
       DAAE                     CAP2:
001438 DAAE CDA5DA          17      CALL    CAP
       DAB1                     CAP3:               ;
00143B DAB1 FE05             7      CP  5
00143D DAB3 28E9            12      JR  Z,CAP4
00143F DAB5 FE21             7      CP  021H
001441 DAB7 C9              10      RET
                                                    ;
       DAB8                     CHDIR:
001442 DAB8 CD91E4          17      CALL    GETDPBD
001445 DABB 381D            12      JR  C,CHDIR2
001447 DABD DD751A          19      LD  (IX+DPB_SDIR),L
00144A DAC0 DD741B          19      LD  (IX+DPB_SDIR+1),H
00144D DAC3 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       DAC5                     LDDIR:
00144F DAC5 CD91E4          17      CALL    GETDPBD
001452 DAC8 DD5E1A          19      LD  E,(IX+DPB_SDIR)
001455 DACB DD561B          19      LD  D,(IX+DPB_SDIR+1)
001458 DACE 13               6      INC DE
001459 DACF FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00145C DAD2 FD720F          19      LD  (IY+15),D
00145F DAD5 1B               6      DEC DE
001460 DAD6 AF               4      XOR A
001461 DAD7 32A0E6          13      LD  (_DIRF),A
       DADA                     CHDIR2:
001464 DADA DDE1            14      POP IX
001466 DADC C9              10      RET
                                
       DADD                     LDDIRX:
001467 DADD 3AA0E6          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
00146A DAE0 E67F             7      AND 07FH
       DAE2                     LDDIRX1:
00146C DAE2 32E1E1          13      LD  (_SECPS),A
00146F DAE5 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
001472 DAE8 FD560F          19      LD  D,(IY+15)
001475 DAEB 1B               6      DEC DE
001476 DAEC CD96DA          17      CALL    ENDCL
001479 DAEF D4C5DA          17      CALL    NC,LDDIR
       DAF2                     LDDIRS:
00147C DAF2 7A               4      LD  A,D
00147D DAF3 B3               4      OR  E
00147E DAF4 32A0E6          13      LD  (_DIRF),A   ;ディレクトリか判別
001481 DAF7 C9              10      RET
                                
       DAF8                     KILL:
001482 DAF8 CDC0DB          17      CALL    CHKWILDX
001485 DAFB 3834            12      JR  C,KILLW
001487 DAFD CD9BD8          17      CALL    SOPENX
       DB00                     KILLS:
00148A DB00 3E1F             7      LD  A,01FH
00148C DB02 D444DB          17      CALL    NC,CHKATT
00148F DB05 D8              11      RET C
       DB06                     KILLSX:
001490 DB06 36E5            10      LD  (HL),0E5H   ;DIR
001492 DB08 CD9CDB          17      CALL    WTDB
001495 DB0B 111A00          10      LD  DE,01AH
001498 DB0E 19              11      ADD HL,DE
001499 DB0F 5E               7      LD  E,(HL)
00149A DB10 23               6      INC HL
00149B DB11 56               7      LD  D,(HL)
       DB12                     KILLS1:
00149C DB12 CD96DA          17      CALL    ENDCL
00149F DB15 D0              11      RET NC      ;CF=0
0014A0 DB16 21FEFF          10      LD  HL,0-2
0014A3 DB19 19              11      ADD HL,DE
0014A4 DB1A D0              11      RET NC      ;DE= 0 or 1
0014A5 DB1B D5              11      PUSH    DE
0014A6 DB1C CDF7E6          17      CALL    _GNCL
0014A9 DB1F ED53FEE7        20      LD  (_CLPS),DE
0014AD DB23 D1              10      POP DE
0014AE DB24 210000          10      LD  HL,0
0014B1 DB27 D4FAE6          17      CALL    NC,_SNCL
0014B4 DB2A D8              11      RET C
0014B5 DB2B ED5BFEE7        20      LD  DE,(_CLPS)  ;FAT
0014B9 DB2F 18E1            12      JR  KILLS1
                                
       DB31                     KILLW:
0014BB DB31 CDCAD8          17      CALL    SOPEN
       DB34                     KILLW1:
0014BE DB34 380B            12      JR  C,KILLW2
0014C0 DB36 CD69D9          17      CALL    SOPENE2
0014C3 DB39 CD00DB          17      CALL    KILLS
0014C6 DB3C CD2ED9          17      CALL    NOPEN
0014C9 DB3F 18F3            12      JR  KILLW1
       DB41                     KILLW2:
0014CB DB41 C8              11      RET Z
0014CC DB42 3F               4      CCF
0014CD DB43 C9              10      RET
                                
       DB44                     CHKATT:
0014CE DB44 E5              11      PUSH    HL
0014CF DB45 110B00          10      LD  DE,00BH
0014D2 DB48 19              11      ADD HL,DE
0014D3 DB49 A6               7      AND (HL)
0014D4 DB4A E1              10      POP HL
0014D5 DB4B C8              11      RET Z
0014D6 DB4C 37               4      SCF
0014D7 DB4D C9              10      RET
                                
       DB4E                     NAME:
0014D8 DB4E CDC0DB          17      CALL    CHKWILDX
0014DB DB51 D8              11      RET C
0014DC DB52 110400          10      LD  DE,4
0014DF DB55 19              11      ADD HL,DE
0014E0 DB56 226BDB          16      LD  (NAMEP),HL
0014E3 DB59 23               6      INC HL
0014E4 DB5A CDC4DB          17      CALL    CHKWILD
0014E7 DB5D D8              11      RET C
                                
0014E8 DB5E CD9BD8          17      CALL    SOPENX
0014EB DB61 3E0F             7      LD  A,00FH
0014ED DB63 D444DB          17      CALL    NC,CHKATT
0014F0 DB66 D8              11      RET C
                                
0014F1 DB67 FDE5            15      PUSH    IY
0014F3 DB69 FD210000        14      LD  IY,0        ;自己書き換え
       DB6B                     NAMEP   EQU $-2
0014F7 DB6D CD9BD8          17      CALL    SOPENX
0014FA DB70 FDE3            23      EX  (SP),IY
0014FC DB72 3F               4      CCF
0014FD DB73 D4CAD8          17      CALL    NC,SOPEN
001500 DB76 EB               4      EX  DE,HL
001501 DB77 E1              10      POP HL
001502 DB78 D8              11      RET C
                                
       DB79                     SETNAME:
001503 DB79 01000B          10      LD  BC,11*256
001506 DB7C 23               6      INC HL
001507 DB7D 7E               7      LD  A,(HL)
001508 DB7E FEE5             7      CP  0E5H
00150A DB80 2004            12      JR  NZ,SNAME1
00150C DB82 3E05             7      LD  A,5
00150E DB84 180E            12      JR  SNAME3
       DB86                     SNAME1:
001510 DB86 7E               7      LD  A,(HL)
001511 DB87 0C               4      INC C
001512 DB88 0D               4      DEC C
001513 DB89 2009            12      JR  NZ,SNAME3
001515 DB8B CDA5DA          17      CALL    CAP
001518 DB8E FEA0             7      CP  0A0H
00151A DB90 2002            12      JR  NZ,SNAME3
00151C DB92 3E20             7      LD  A,020H
       DB94                     SNAME3:
00151E DB94 12               7      LD  (DE),A
00151F DB95 7E               7      LD  A,(HL)
001520 DB96 23               6      INC HL
001521 DB97 CDADDB          17      CALL    FKAN
001524 DB9A 10EA            13      DJNZ    SNAME1
       DB9C                     WTDB:               ;バッファデータが更新された
001526 DB9C 3EFF             7      LD  A,0FFH
001528 DB9E 3239E6          13      LD  (SFILE),A
00152B DBA1 32A4E6          13      LD  (_WTDBF),A
00152E DBA4 AF               4      XOR A
00152F DBA5 C9              10      RET
                                
       DBA6                     FKANC:
001530 DBA6 CB41             8      BIT 0,C
001532 DBA8 CCAEDA          17      CALL    Z,CAP2
001535 DBAB 1801            12      JR  FKANX
       DBAD                     FKAN:           ;漢字チェック
001537 DBAD 13               6      INC DE
       DBAE                     FKANX:
001538 DBAE CB41             8      BIT 0,C
00153A DBB0 CB81             8      RES 0,C
00153C DBB2 C0              11      RET NZ
00153D DBB3 FE80             7      CP  080H
00153F DBB5 D8              11      RET C
001540 DBB6 FEA0             7      CP  0A0H
001542 DBB8 3803            12      JR  C,FKAN1
001544 DBBA FEE0             7      CP  0E0H
001546 DBBC D8              11      RET C
       DBBD                     FKAN1:
001547 DBBD 0C               4      INC C
001548 DBBE A7               4      AND A
001549 DBBF C9              10      RET
                                
       DBC0                     CHKWILDX:
00154A DBC0 FDE5            15      PUSH    IY
00154C DBC2 E1              10      POP HL
00154D DBC3 23               6      INC HL
       DBC4                     CHKWILD:
00154E DBC4 060B             7      LD  B,11
001550 DBC6 3E3F             7      LD  A,'?'
       DBC8                     CHKWIL1:
001552 DBC8 BE               7      CP  (HL)
001553 DBC9 23               6      INC HL
001554 DBCA 37               4      SCF
001555 DBCB C8              11      RET Z
001556 DBCC 10FA            13      DJNZ    CHKWIL1
001558 DBCE AF               4      XOR A
001559 DBCF C9              10      RET
                                
       DBD0                     SDIRENT:        ;IY=FCB HL=DIR
00155A DBD0 D5              11      PUSH    DE
00155B DBD1 E5              11      PUSH    HL
00155C DBD2 FDE5            15      PUSH    IY
00155E DBD4 D1              10      POP DE
00155F DBD5 EB               4      EX  DE,HL
001560 DBD6 CD79DB          17      CALL    SETNAME
                                ;               Attribute
001563 DBD9 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001566 DBDC 12               7      LD  (DE),A
001567 DBDD 13               6      INC DE
                                ;               Reserved
001568 DBDE AF               4      XOR A
001569 DBDF 060A             7      LD  B,10
       DBE1                     SDE1:
00156B DBE1 12               7      LD  (DE),A
00156C DBE2 13               6      INC DE
00156D DBE3 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
00156F DBE5 21E4E7          10      LD  HL,SDDATA       ;(FCB)更新年月日
001572 DBE8 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DBEA                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
001574 DBEA 7E               7      LD  A,(HL)
001575 DBEB 23               6      INC HL
001576 DBEC 32F1DB          13      LD  (SDPAT),A
001579 DBEF FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       DBF1                     SDPAT   EQU $-1
00157C DBF2 12               7      LD  (DE),A
00157D DBF3 13               6      INC DE
00157E DBF4 10F4            13      DJNZ    SDLOOP
                                
001580 DBF6 AF               4      XOR A
001581 DBF7 E1              10      POP HL
001582 DBF8 D1              10      POP DE
001583 DBF9 C9              10      RET
                                
       DBFA                     WOPEN:
001584 DBFA FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001587 DBFD E61F             7      AND 01FH
001589 DBFF 37               4      SCF
00158A DC00 C0              11      RET NZ
00158B DC01 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       DC05                     TOPEN2:
00158F DC05 AF               4      XOR A
       DC06                     TOPEN:              ;Initializes the time stamp
001590 DC06 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
001594 DC0A C9              10      RET
                                
       DC0B                     WRDFX:
001595 DC0B 3A7DDA          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       DC0E                     L_WRFX:
001598 DC0E 1F               4      RRA         ;->CF
001599 DC0F 3806            12      JR  C,E_WRFX
00159B DC11 CB39             8      SRL C
00159D DC13 CB1C             8      RR  H       ;CH=CH/2
00159F DC15 18F7            12      JR  L_WRFX
       DC17                     E_WRFX:
0015A1 DC17 41               4      LD  B,C
0015A2 DC18 4C               4      LD  C,H
0015A3 DC19 03               6      INC BC
0015A4 DC1A 3E37             7      LD  A,037H      ;SCF
0015A6 DC1C 3267E0          13      LD  (DRDN1),A
                                
       DC1F                     WRDF:               ;BCクラスタ分FATを確保する
0015A9 DC1F 110200          10      LD  DE,2
0015AC DC22 AF               4      XOR A
0015AD DC23 32E1E1          13      LD  (_SECPS),A
       DC26                     WRDF1:
0015B0 DC26 C5              11      PUSH    BC
0015B1 DC27 D5              11      PUSH    DE
0015B2 DC28 CDF7E6          17      CALL    _GNCL
0015B5 DC2B 381C            12      JR  C,WRDF3
0015B7 DC2D 7A               4      LD  A,D     ;空いているかチェック
0015B8 DC2E B3               4      OR  E
0015B9 DC2F 202A            12      JR  NZ,WRDF4
0015BB DC31 E1              10      POP HL      ;HL=空いているクラスタ
0015BC DC32 E5              11      PUSH    HL
0015BD DC33 ED5BFEE7        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
0015C1 DC37 22FEE7          16      LD  (_CLPS),HL
0015C4 DC3A 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
0015C5 DC3B B3               4      OR  E
0015C6 DC3C 2008            12      JR  NZ,WRDF2
0015C8 DC3E FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
0015CB DC41 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
0015CE DC44 1803            12      JR  WRDF3
       DC46                     WRDF2:
0015D0 DC46 CDFAE6          17      CALL    _SNCL
       DC49                     WRDF3:
0015D3 DC49 D1              10      POP DE
0015D4 DC4A C1              10      POP BC
0015D5 DC4B D8              11      RET C
0015D6 DC4C 0B               6      DEC BC
0015D7 DC4D 78               4      LD  A,B
0015D8 DC4E B1               4      OR  C
0015D9 DC4F 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
0015DB DC51 ED5BFEE7        20      LD  DE,(_CLPS)
0015DF DC55 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
0015E2 DC58 C3FAE6          10      JP  _SNCL
                                
       DC5B                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
0015E5 DC5B D1              10      POP DE
0015E6 DC5C C1              10      POP BC
       DC5D                     WRDF5:
0015E7 DC5D 13               6      INC DE
0015E8 DC5E CD96DA          17      CALL    ENDCL
0015EB DC61 38C3            12      JR  C,WRDF1
0015ED DC63 37               4      SCF
0015EE DC64 C9              10      RET
                                
       DC65                     RWXR:
0015EF DC65 3A56DF          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       DC68                     L_RWX:
0015F2 DC68 1F               4      RRA     ;->CF
0015F3 DC69 3808            12      JR  C,E_RWX
0015F5 DC6B CB38             8      SRL B   ;BCH=BCH/2
0015F7 DC6D CB19             8      RR  C   ;
0015F9 DC6F CB1C             8      RR  H   ;
0015FB DC71 18F5            12      JR  L_RWX
       DC73                     E_RWX:
0015FD DC73 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001600 DC76 FD561B          19      LD  D,(IY+27)
001603 DC79 AF               4      XOR A
001604 DC7A 32E1E1          13      LD  (_SECPS),A
       DC7D                     RWX1:
001607 DC7D ED53FEE7        20      LD  (_CLPS),DE
00160B DC81 7A               4      LD  A,D
00160C DC82 B3               4      OR  E
00160D DC83 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
00160F DC85 78               4      LD  A,B
001610 DC86 B1               4      OR  C
001611 DC87 B4               4      OR  H
001612 DC88 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
001613 DC89 CDE9E1          17      CALL    GNCLX
001616 DC8C D8              11      RET C
001617 DC8D 7C               4      LD  A,H     ;
001618 DC8E 25               4      DEC H       ;
001619 DC8F B7               4      OR  A       ;DEC BCH
00161A DC90 2001            12      JR  NZ,RWX2     ;
00161C DC92 0B               6      DEC BC      ;
       DC93                     RWX2:
00161D DC93 CD96DA          17      CALL    ENDCL
001620 DC96 38E5            12      JR  C,RWX1
       DC98                     SCF_RET:
001622 DC98 37               4      SCF
001623 DC99 C9              10      RET
                                
       DC9A                     DSKF:
001624 DC9A 110000          10      LD  DE,0
       DC9B                     MAXCLP  EQU $-2
001627 DC9D 2AACE6          16      LD  HL,(_FAKEFREE)
00162A DCA0 7C               4      LD  A,H
00162B DCA1 B5               4      OR  L
00162C DCA2 2803            12      JR  Z,DSKF1
00162E DCA4 110100          10      LD  DE,1
       DCA7                     DSKF1:
001631 DCA7 D5              11      PUSH    DE
001632 DCA8 CDF7E6          17      CALL    _GNCL
001635 DCAB 380C            12      JR  C,POPSCF
001637 DCAD 7A               4      LD  A,D
001638 DCAE B3               4      OR  E
001639 DCAF 2001            12      JR  NZ,DSKF2
00163B DCB1 23               6      INC HL
       DCB2                     DSKF2:
00163C DCB2 D1              10      POP DE
00163D DCB3 1B               6      DEC DE
00163E DCB4 7A               4      LD  A,D
00163F DCB5 B3               4      OR  E
001640 DCB6 20EF            12      JR  NZ,DSKF1
001642 DCB8 C9              10      RET
                                
       DCB9                     POPSCF:
001643 DCB9 F1              10      POP AF
001644 DCBA 37               4      SCF
001645 DCBB C9              10      RET
                                
       DCBC                     SETTMS:
001646 DCBC FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
001649 DCBF 3C               4      INC A
00164A DCC0 C0              11      RET NZ      ;ファイルが更新されていない
       DCC1                     SETTMSX:            ;FCBに日付時刻をセットする
00164B DCC1 CD60D5          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
00164E DCC4 CB25             8      SLA L       ;   *2
001650 DCC6 CB25             8      SLA L       ;   *4
001652 DCC8 29              11      ADD HL,HL       ;*2 *8
001653 DCC9 29              11      ADD HL,HL       ;*4 *16
001654 DCCA 29              11      ADD HL,HL       ;*8 *32
001655 DCCB 7A               4      LD  A,D
001656 DCCC 0F               4      RRCA            ;bit.0->7->->->0->C
001657 DCCD E61F             7      AND 01FH
001659 DCCF B5               4      OR  L
00165A DCD0 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
00165D DCD3 FD7417          19      LD  (IY+23),H
                                
001660 DCD6 CD10D5          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
001663 DCD9 0144F8          10      LD  BC,0-1980
001666 DCDC 09              11      ADD HL,BC
001667 DCDD 65               4      LD  H,L
                                
001668 DCDE 7A               4      LD  A,D
001669 DCDF 87               4      ADD A,A     ;*2
00166A DCE0 87               4      ADD A,A     ;*4
00166B DCE1 87               4      ADD A,A     ;*8
00166C DCE2 87               4      ADD A,A     ;*16
00166D DCE3 6F               4      LD  L,A
00166E DCE4 29              11      ADD HL,HL       ;*32
00166F DCE5 7D               4      LD  A,L
001670 DCE6 B3               4      OR  E
001671 DCE7 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
001674 DCEA FD7415          19      LD  (IY+21),H
001677 DCED C9              10      RET
                                ;(16)
       DCEE                     PUSHRR:
001678 DCEE 321AE0          13      LD  (SETSEQ_SWC_RND),A
00167B DCF1 222CE0          16      LD  (SETSEQ_SWC_SEQ_RR),HL
00167E DCF4 CD14DD          17      CALL    GET_RR_AHL
001681 DCF7 220FE6          16      LD  (RR_BUF_HL),HL
001684 DCFA 3211E6          13      LD  (RR_BUF_A),A
001687 DCFD C9              10      RET
                                ;(14)
       DCFE                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
001688 DCFE 87               4      ADD A,A     ;in BHLA => out AHL
001689 DCFF ED6A            15      ADC HL,HL
00168B DD01 CB18             8      RR  B
00168D DD03 B7               4      OR  A
00168E DD04 78               4      LD  A,B     ;ここでフラグは変化しない
00168F DD05 C8              11      RET Z
001690 DD06 2C               4      INC L       ;INC AHL
001691 DD07 C0              11      RET NZ      ;
001692 DD08 24               4      INC H       ;
001693 DD09 C0              11      RET NZ      ;
001694 DD0A 3C               4      INC A       ;
001695 DD0B C9              10      RET
                                ;(18)
       DD0C                     INIT_RND:
001696 DD0C 3ECD             7      LD  A,0CDH      ;CALL ????
001698 DD0E 212BDD          10      LD  HL,POPRR
00169B DD11 CDEEDC          17      CALL    PUSHRR
       DD14                     GET_RR_AHL:
00169E DD14 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0016A1 DD17 FD6622          19      LD  H,(IY+34)   ;
0016A4 DD1A FD7E23          19      LD  A,(IY+35)   ;
0016A7 DD1D C9              10      RET
                                ;(10)
       DD1E                     SET_RR_AHL:
0016A8 DD1E FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0016AB DD21 FD7422          19      LD  (IY+34),H   ;
0016AE DD24 FD7723          19      LD  (IY+35),A   ;
0016B1 DD27 C9              10      RET
                                ;(17)
       DD28                     SETSEQ:
0016B2 DD28 CD4DDD          17      CALL    SETSEQ1
       DD2B                     POPRR:
0016B5 DD2B F5              11      PUSH    AF
0016B6 DD2C E5              11      PUSH    HL
0016B7 DD2D 2A0FE6          16      LD  HL,(RR_BUF_HL)
0016BA DD30 3A11E6          13      LD  A,(RR_BUF_A)
0016BD DD33 CD1EDD          17      CALL    SET_RR_AHL
0016C0 DD36 E1              10      POP HL
0016C1 DD37 F1              10      POP AF
0016C2 DD38 C9              10      RET
                                ;(20)
       DD39                     GET_RR_BCDE:            ;BCDE=Random record
0016C3 DD39 FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
0016C6 DD3C FD5622          19      LD  D,(IY+34)
0016C9 DD3F FD4E23          19      LD  C,(IY+35)
0016CC DD42 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
0016CE DD44 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0016D2 DD48 C0              11      RET NZ
0016D3 DD49 FD4624          19      LD  B,(IY+36)
0016D6 DD4C C9              10      RET
                                
       DD4D                     SETSEQ1:
0016D7 DD4D F5              11      PUSH    AF
0016D8 DD4E E5              11      PUSH    HL      ;AHL=Random record
0016D9 DD4F CD14DD          17      CALL    GET_RR_AHL
0016DC DD52 47               4      LD  B,A     ;AHL→HLA
0016DD DD53 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
0016DE DD54 6C               4      LD  L,H     ;(IY+34)
0016DF DD55 60               4      LD  H,B     ;(IY+35)
0016E0 DD56 0600             7      LD  B,0
                                
0016E2 DD58 CDFEDC          17      CALL    GET_CPM_R_SIZE
                                
0016E5 DD5B 29              11      ADD HL,HL
0016E6 DD5C CB3D             8      SRL L       ;L=L/2
0016E8 DD5E FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
0016EB DD61 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
0016EE DD64 E1              10      POP HL
0016EF DD65 F1              10      POP AF
0016F0 DD66 C9              10      RET
                                
                                ;(23)
       DD67                     RBXEND:             ;レコード数だけランダムレコードを進める
0016F1 DD67 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       DD68                     RBSIZE  EQU $-2
0016F4 DD6A CD14DD          17      CALL    GET_RR_AHL
0016F7 DD6D 19              11      ADD HL,DE
0016F8 DD6E CE00             7      ADC A,0
0016FA DD70 CD1EDD          17      CALL    SET_RR_AHL
0016FD DD73 EB               4      EX  DE,HL       ;HL=進めるレコード数
0016FE DD74 D0              11      RET NC
0016FF DD75 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001703 DD79 C0              11      RET NZ
001704 DD7A FD3424          23      INC (IY+36)
001707 DD7D C9              10      RET
       DD7E                     FILE_E:
                                
       D928                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       D928                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       D928                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       D928                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       D928                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       DD7E                     _SYS26:     ;(BDOS)ランダムブロック書き込み
001708 DD7E AF               4      XOR A
001709 DD7F 3267E0          13      LD  (DRDN1),A   ;NOP
00170C DD82 2268DD          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
00170F DD85 225DE6          16      LD  (LEFTX),HL
001712 DD88 CD71D8          17      CALL    SETDRV
                                
001715 DD8B CDF1DE          17      CALL    RBX0
001718 DD8E DA1BDE          10      JP  C,RBWERR
00171B DD91 CDFADB          17      CALL    WOPEN
00171E DD94 DA1BDE          10      JP  C,RBWERR
001721 DD97 7C               4      LD  A,H
001722 DD98 B5               4      OR  L
001723 DD99 CA14DE          10      JP  Z,RBW1
                                
001726 DD9C 2B               6      DEC HL
                                
001727 DD9D CD39DD          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
00172A DDA0 19              11      ADD HL,DE       ;BCHL=HL+BCDE
00172B DDA1 3001            12      JR  NC,S26X1    ;
00172D DDA3 03               6      INC BC      ;
       DDA4                     S26X1:
00172E DDA4 CD65DC          17      CALL    RWXR
001731 DDA7 DC0BDC          17      CALL    C,WRDFX
001734 DDAA DA1BDE          10      JP  C,RBWERR
                                
001737 DDAD CD20DF          17      CALL    RBX2
00173A DDB0 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
00173C DDB2 CD3FDF          17      CALL    RBXA
00173F DDB5 3864            12      JR  C,RBWERR
001741 DDB7 EB               4      EX  DE,HL
001742 DDB8 C5              11      PUSH    BC
001743 DDB9 EDB0                    LDIR
001745 DDBB 225FE6          16      LD  (DTAX),HL
                                
001748 DDBE CD9CDB          17      CALL    WTDB        ;バッファデータは更新された
                                
00174B DDC1 2A5DE6          16      LD  HL,(LEFTX)
00174E DDC4 D1              10      POP DE
00174F DDC5 ED52            15      SBC HL,DE
001751 DDC7 225DE6          16      LD  (LEFTX),HL
001754 DDCA 2831            12      JR  Z,RBWEND
                                
       DDCC                     RBWB:
001756 DDCC CD74DF          17      CALL    RBXB
001759 DDCF 2814            12      JR  Z,RBWC
       DDD1                     RBWB1:
00175B DDD1 C5              11      PUSH    BC
00175C DDD2 D5              11      PUSH    DE
00175D DDD3 CD79DA          17      CALL    CLUSTX
001760 DDD6 CD98DF          17      CALL    DWTC
001763 DDD9 D1              10      POP DE
001764 DDDA C1              10      POP BC
001765 DDDB D4E9E1          17      CALL    NC,GNCLX
001768 DDDE 383B            12      JR  C,RBWERR
00176A DDE0 10EF            13      DJNZ    RBWB1
00176C DDE2 CDE8DF          17      CALL    DRW_FLUSH
       DDE5                     RBWC:
00176F DDE5 CD8CDF          17      CALL    RBXC
001772 DDE8 2813            12      JR  Z,RBWEND
001774 DDEA C5              11      PUSH    BC
001775 DDEB CD79DA          17      CALL    CLUSTX
001778 DDEE CD66E0          17      CALL    DRDN
00177B DDF1 C1              10      POP BC
00177C DDF2 3827            12      JR  C,RBWERR
00177E DDF4 ED5B7EE7        20      LD  DE,(_DTBUF)
001782 DDF8 EDB0                    LDIR
001784 DDFA CD9CDB          17      CALL    WTDB        ;バッファデータは更新された
       DDFD                     RBWEND:
001787 DDFD CD67DD          17      CALL    RBXEND
                                
00178A DE00 CD00DF          17      CALL    RBX1
00178D DE03 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
00178F DE05 CD39DD          17      CALL    GET_RR_BCDE ;BCDE=Random record
001792 DE08 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
001795 DE0B FD7211          19      LD  (IY+17),D   ;
001798 DE0E FD7112          19      LD  (IY+18),C   ;
00179B DE11 FD7013          19      LD  (IY+19),B   ;
       DE14                     RBW1:
00179E DE14 FDE1            14      POP IY
0017A0 DE16 C1              10      POP BC
0017A1 DE17 D1              10      POP DE
0017A2 DE18 E1              10      POP HL
       DE19                     DD_NUL:
0017A3 DE19 AF               4      XOR A
       DE1A                     DRDF0:
       DE1A                     DWTF0:
0017A4 DE1A C9              10      RET
                                
       DE1B                     RBWERR:
0017A5 DE1B FDE5            15      PUSH    IY
0017A7 DE1D D1              10      POP DE
0017A8 DE1E 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
0017AA DE20 CDD7D0          17      CALL    BDOS0
       DE23                     RBRERR1:
0017AD DE23 3E01             7      LD  A,001H
       DE25                     RBRERR2:
0017AF DE25 FDE1            14      POP IY
0017B1 DE27 C1              10      POP BC
0017B2 DE28 D1              10      POP DE
0017B3 DE29 E1              10      POP HL
0017B4 DE2A 37               4      SCF
0017B5 DE2B 210000          10      LD  HL,0
0017B8 DE2E C9              10      RET
                                
       DE2F                     RBRERR:
0017B9 DE2F 3EFF             7      LD  A,0FFH
0017BB DE31 18F2            12      JR  RBRERR2
                                
       DE33                     RBRFL:
0017BD DE33 3E00             7  RBRFLP: LD  A,000H
0017BF DE35 FE0D             7      CP  00DH
0017C1 DE37 2005            12      JR  NZ,RBRFL1
0017C3 DE39 D5              11      PUSH    DE
0017C4 DE3A 1E0A             7      LD  E,00AH
0017C6 DE3C 1805            12      JR  RBRFL2
       DE3E                     RBRFL1:
0017C8 DE3E D5              11      PUSH    DE
0017C9 DE3F CD09E6          17      CALL    _SYS07
0017CC DE42 5F               4      LD  E,A
       DE43                     RBRFL2:
0017CD DE43 CDCDE6          17      CALL    _PRINT
0017D0 DE46 7B               4      LD  A,E
0017D1 DE47 D1              10      POP DE
0017D2 DE48 3234DE          13      LD  (RBRFLP+1),A
0017D5 DE4B C9              10      RET
                                
                                                ;Read random block
       DE4C                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0017D6 DE4C 225DE6          16      LD  (LEFTX),HL
0017D9 DE4F CD71D8          17      CALL    SETDRV
                                
0017DC DE52 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
0017E0 DE56 C2DFDE          10      JP  NZ,RBRDIR   ;ディレクトリ
0017E3 DE59 CDF1DE          17      CALL    RBX0
0017E6 DE5C DA2FDE          10      JP  C,RBRERR
0017E9 DE5F CD00DF          17      CALL    RBX1
0017EC DE62 D418DF          17      CALL    NC,RBX1R
0017EF DE65 DA23DE          10      JP  C,RBRERR1
0017F2 DE68 EB               4      EX  DE,HL
0017F3 DE69 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
0017F5 DE6B 19              11      ADD HL,DE
0017F6 DE6C 79               4      LD  A,C
0017F7 DE6D DE00             7      SBC A,0
0017F9 DE6F 78               4      LD  A,B
0017FA DE70 DE00             7      SBC A,0
0017FC DE72 3801            12      JR  C,RBR1
0017FE DE74 EB               4      EX  DE,HL
       DE75                     RBR1:
0017FF DE75 9F               4      SBC A,A
001800 DE76 E601             7      AND 1
001802 DE78 32DDDE          13      LD  (RBRA_SWC),A
                                
001805 DE7B 7C               4      LD  A,H
001806 DE7C B5               4      OR  L
001807 DE7D 2857            12      JR  Z,RBREND0
                                
001809 DE7F 2268DD          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
00180C DE82 225DE6          16      LD  (LEFTX),HL
                                
00180F DE85 CD20DF          17      CALL    RBX2
001812 DE88 2819            12      JR  Z,RBRB
001814 DE8A CD3FDF          17      CALL    RBXA
001817 DE8D DA2FDE          10      JP  C,RBRERR
00181A DE90 C5              11      PUSH    BC
00181B DE91 EDB0                    LDIR
00181D DE93 ED535FE6        20      LD  (DTAX),DE
001821 DE97 2A5DE6          16      LD  HL,(LEFTX)
001824 DE9A D1              10      POP DE
001825 DE9B A7               4      AND A
001826 DE9C ED52            15      SBC HL,DE
001828 DE9E 225DE6          16      LD  (LEFTX),HL
00182B DEA1 2830            12      JR  Z,RBREND
                                
       DEA3                     RBRB:
00182D DEA3 CD74DF          17      CALL    RBXB
001830 DEA6 2815            12      JR  Z,RBRC
       DEA8                     RBRB1:
001832 DEA8 C5              11      PUSH    BC
001833 DEA9 D5              11      PUSH    DE
001834 DEAA CD79DA          17      CALL    CLUSTX
001837 DEAD CD9EDF          17      CALL    DRDC
00183A DEB0 D1              10      POP DE
00183B DEB1 C1              10      POP BC
00183C DEB2 D4E9E1          17      CALL    NC,GNCLX
00183F DEB5 DA2FDE          10      JP  C,RBRERR
001842 DEB8 10EE            13      DJNZ    RBRB1
001844 DEBA CDE8DF          17      CALL    DRW_FLUSH
       DEBD                     RBRC:
001847 DEBD CD8CDF          17      CALL    RBXC
00184A DEC0 2811            12      JR  Z,RBREND
00184C DEC2 C5              11      PUSH    BC
00184D DEC3 CD79DA          17      CALL    CLUSTX
001850 DEC6 CD4AE0          17      CALL    DRDX
001853 DEC9 C1              10      POP BC
001854 DECA DA2FDE          10      JP  C,RBRERR
001857 DECD EB               4      EX  DE,HL
001858 DECE 2A7EE7          16      LD  HL,(_DTBUF)
00185B DED1 EDB0                    LDIR
       DED3                     RBREND:
00185D DED3 CD67DD          17      CALL    RBXEND
       DED6                     RBREND0:
001860 DED6 FDE1            14      POP IY
001862 DED8 C1              10      POP BC
001863 DED9 D1              10      POP DE
001864 DEDA F1              10      POP AF  ;(HL)
001865 DEDB AF               4      XOR A
001866 DEDC 3E00             7      LD  A,000H
       DEDD                     RBRA_SWC    EQU $-1
001868 DEDE C9              10      RET
                                
       DEDF                     RBRDIR:
001869 DEDF FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
00186C DEE2 FD661B          19      LD  H,(IY+27)
00186F DEE5 CDB8DA          17      CALL    CHDIR
001872 DEE8 AF               4      XOR A
001873 DEE9 67               4      LD  H,A
001874 DEEA 6F               4      LD  L,A
001875 DEEB 3C               4      INC A
001876 DEEC 32DDDE          13      LD  (RBRA_SWC),A
001879 DEEF 18E5            12      JR  RBREND0
                                ;(15)
       DEF1                     RBX0:
00187B DEF1 2A8AE6          16      LD  HL,(_DTA)
00187E DEF4 225FE6          16      LD  (DTAX),HL
001881 DEF7 2A5DE6          16      LD  HL,(LEFTX)
001884 DEFA FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
001887 DEFD D6FD             7      SUB 0FDH
001889 DEFF C9              10      RET
                                
       DF00                     RBX1:               ;ファイルサイズとランダムレコードを比べる
00188A DF00 E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
00188B DF01 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
00188E DF04 FD6611          19      LD  H,(IY+17)   ;
001891 DF07 FD7E12          19      LD  A,(IY+18)   ;
                                
001894 DF0A CD39DD          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001897 DF0D A7               4      AND A
001898 DF0E ED52            15      SBC HL,DE
00189A DF10 99               4      SBC A,C
00189B DF11 4F               4      LD  C,A
00189C DF12 FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
00189F DF15 98               4      SBC A,B
0018A0 DF16 D1              10      POP DE
0018A1 DF17 C9              10      RET
       DF18                     RBX1R:              ;(8)
0018A2 DF18 47               4      LD  B,A
0018A3 DF19 B1               4      OR  C
0018A4 DF1A EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
0018A5 DF1B B2               4      OR  D
0018A6 DF1C B3               4      OR  E
0018A7 DF1D C0              11      RET NZ
0018A8 DF1E 37               4      SCF
0018A9 DF1F C9              10      RET
                                
       DF20                     RBX2:               ;Cluster settings
0018AA DF20 FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
0018AD DF23 FD4E23          19      LD  C,(IY+35)
0018B0 DF26 0600             7      LD  B,0
0018B2 DF28 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0018B6 DF2C 2003            12      JR  NZ,RBX3
0018B8 DF2E FD4624          19      LD  B,(IY+36)
       DF31                     RBX3:
0018BB DF31 CD65DC          17      CALL    RWXR
0018BE DF34 3A56DF          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
0018C1 DF37 3D               4      DEC A
0018C2 DF38 FDA622          19      AND (IY+34)
0018C5 DF3B FDB621          19      OR  (IY+33)
0018C8 DF3E C9              10      RET
                                
       DF3F                     RBXA:
0018C9 DF3F C5              11      PUSH    BC
0018CA DF40 D5              11      PUSH    DE
0018CB DF41 CD79DA          17      CALL    CLUSTX
0018CE DF44 CD4AE0          17      CALL    DRDX
0018D1 DF47 D1              10      POP DE
0018D2 DF48 C1              10      POP BC
0018D3 DF49 D4E9E1          17      CALL    NC,GNCLX
0018D6 DF4C D8              11      RET C
0018D7 DF4D ED53FEE7        20      LD  (_CLPS),DE
                                
0018DB DF51 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
0018DE DF54 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       DF55                     SECSZ   EQU $-2
       DF56                     SECSZ_H EQU $-1
0018E1 DF57 7C               4      LD  A,H
0018E2 DF58 3D               4      DEC A       ;1024=3 / 512=1
0018E3 DF59 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
0018E6 DF5C 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
0018E7 DF5D ED42            15      SBC HL,BC       ;残りを計算
                                
0018E9 DF5F ED5B5DE6        20      LD  DE,(LEFTX)
0018ED DF63 ED52            15      SBC HL,DE       ;CP HL,DE
0018EF DF65 19              11      ADD HL,DE       ;
0018F0 DF66 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
0018F2 DF68 EB               4      EX  DE,HL
       DF69                     RBXA1:
0018F3 DF69 E5              11      PUSH    HL
0018F4 DF6A 2A7EE7          16      LD  HL,(_DTBUF)
0018F7 DF6D 09              11      ADD HL,BC
0018F8 DF6E ED5B5FE6        20      LD  DE,(DTAX)
0018FC DF72 C1              10      POP BC
0018FD DF73 C9              10      RET
                                
       DF74                     RBXB:
0018FE DF74 2A5FE6          16      LD  HL,(DTAX)
001901 DF77 ED5BFEE7        20      LD  DE,(_CLPS)
001905 DF7B 3A5EE6          13      LD  A,(LEFTX+1)
001908 DF7E 47               4      LD  B,A
001909 DF7F 3A56DF          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       DF82                     RBXB1:
00190C DF82 1F               4      RRA     ;->CF
00190D DF83 3804            12      JR  C,RBXB2
00190F DF85 CB38             8      SRL B   ;B=B/2
001911 DF87 18F9            12      JR  RBXB1
       DF89                     RBXB2:
001913 DF89 78               4      LD  A,B
001914 DF8A B7               4      OR  A
001915 DF8B C9              10      RET
                                ;(12)
       DF8C                     RBXC:
001916 DF8C ED4B5DE6        20      LD  BC,(LEFTX)
00191A DF90 3A56DF          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
00191D DF93 3D               4      DEC A
00191E DF94 A0               4      AND B
00191F DF95 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
001920 DF96 B1               4      OR  C
001921 DF97 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       DF98                     DWTC:
001922 DF98 E5              11      PUSH    HL
001923 DF99 2182E3          10      LD  HL,DWT24B
001926 DF9C 1804            12      JR  DWTC1
       DF9E                     DRDC:
001928 DF9E E5              11      PUSH    HL
001929 DF9F 2174E3          10      LD  HL,DRD24B
       DFA2                     DWTC1:
00192C DFA2 22FCDF          16      LD  (DRWF_MODE),HL
00192F DFA5 E1              10      POP HL
001930 DFA6 3AECDF          13      LD  A,(DRWF_B)
001933 DFA9 B7               4      OR  A
001934 DFAA 200F            12      JR  NZ,DRDC1
       DFAC                     SAVE_DRWC:
001936 DFAC 0601             7      LD  B,1
001938 DFAE ED43EBDF        20      LD  (DRWF_C),BC
00193C DFB2 ED53F2DF        20      LD  (DRWF_E),DE
001940 DFB6 22F5DF          16      LD  (DRWF_HL),HL
001943 DFB9 1820            12      JR  INC_HL_DRWC
       DFBB                     DRDC1:
001945 DFBB E5              11      PUSH    HL
001946 DFBC 21F2DF          10      LD  HL,DRWF_E
001949 DFBF 86               7      ADD A,(HL)
00194A DFC0 F5              11      PUSH    AF
00194B DFC1 BB               4      CP  E
00194C DFC2 201D            12      JR  NZ,DRDC2
00194E DFC4 F1              10      POP AF
00194F DFC5 23               6      INC HL
001950 DFC6 7E               7      LD  A,(HL)
001951 DFC7 CE00             7      ADC A,0
001953 DFC9 F5              11      PUSH    AF
001954 DFCA BA               4      CP  D
001955 DFCB 2014            12      JR  NZ,DRDC2
001957 DFCD F1              10      POP AF
001958 DFCE 3AEBDF          13      LD  A,(DRWF_C)
00195B DFD1 CE00             7      ADC A,0
00195D DFD3 B9               4      CP  C
00195E DFD4 200C            12      JR  NZ,DRDC3
001960 DFD6 21ECDF          10      LD  HL,DRWF_B
001963 DFD9 34              11      INC (HL)
001964 DFDA E1              10      POP HL
       DFDB                     INC_HL_DRWC:
001965 DFDB 3A56DF          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
001968 DFDE 84               4      ADD A,H
001969 DFDF 67               4      LD  H,A
00196A DFE0 C9              10      RET
       DFE1                     DRDC2:
00196B DFE1 F1              10      POP AF
       DFE2                     DRDC3:
00196C DFE2 CDE8DF          17      CALL    DRW_FLUSH
00196F DFE5 E1              10      POP HL
001970 DFE6 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       DFE8                     DRW_FLUSH:
001972 DFE8 C5              11      PUSH    BC
001973 DFE9 D5              11      PUSH    DE
001974 DFEA 010000          10      LD  BC,0
       DFEB                     DRWF_C  EQU $-2
       DFEC                     DRWF_B  EQU $-1
001977 DFED 78               4      LD  A,B
001978 DFEE B7               4      OR  A
001979 DFEF 280D            12      JR  Z,DRDF1
00197B DFF1 110000          10      LD  DE,0
       DFF2                     DRWF_E  EQU $-2
       DFF3                     DRWF_D  EQU $-1
00197E DFF4 210000          10      LD  HL,0
       DFF5                     DRWF_HL EQU $-2
001981 DFF7 AF               4      XOR A
001982 DFF8 32ECDF          13      LD  (DRWF_B),A
001985 DFFB CD74E3          17      CALL    DRD24B
       DFFC                     DRWF_MODE   EQU $-2
       DFFE                     DRDF1:
001988 DFFE D1              10      POP DE
001989 DFFF C1              10      POP BC
00198A E000 C9              10      RET
                                
       E001                     RB_WRITE:
00198B E001 C5              11      PUSH    BC
00198C E002 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
00198E E004 1803            12      JR  RBRW
       E006                     RB_READ:
001990 E006 C5              11      PUSH    BC
001991 E007 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       E009                     RBRW:
001993 E009 1F               4      RRA     ;AHL = AHL*128
001994 E00A 7C               4      LD  A,H ;AHL = AHL0/2
001995 E00B 1F               4      RRA     ;A
001996 E00C 65               4      LD  H,L ;
001997 E00D CB1C             8      RR  H   ;H
001999 E00F 2E00             7      LD  L,0 ;
00199B E011 CB1D             8      RR  L   ;L
00199D E013 CD1EDD          17      CALL    SET_RR_AHL
0019A0 E016 218000          10      LD  HL,128
0019A3 E019 C5              11      PUSH    BC
       E01A                     SETSEQ_SWC_RND:
0019A4 E01A CD4DDD          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
0019A7 E01D C1              10      POP BC
0019A8 E01E FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
0019AC E022 FDE5            15      PUSH    IY
0019AE E024 D1              10      POP DE
0019AF E025 D5              11      PUSH    DE
0019B0 E026 CDD7D0          17      CALL    BDOS0
0019B3 E029 FDE1            14      POP IY
0019B5 E02B CD28DD          17      CALL    SETSEQ      ;SETSEQ or POPRR
       E02C                     SETSEQ_SWC_SEQ_RR   EQU $-2
0019B8 E02E FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
0019BC E032 C1              10      POP BC
0019BD E033 C9              10      RET
                                
                                ;(22)
       E034                     INIT_SEQ:
0019BE E034 3E01             7      LD  A,1     ;LD BC,????
0019C0 E036 2128DD          10      LD  HL,SETSEQ
0019C3 E039 CDEEDC          17      CALL    PUSHRR
       E03C                     GETSEQ:
0019C6 E03C FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
0019C9 E03F FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
0019CC E042 AF               4      XOR A
                                
0019CD E043 CB25             8      SLA L   ;L=L*2
                                
0019CF E045 CB3C             8      SRL H   ;HL=HL/2
0019D1 E047 CB1D             8      RR  L   ;
0019D3 E049 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E04A                     DRDX:
0019D4 E04A CD88E0          17      CALL    DRDY
0019D7 E04D C8              11      RET Z
0019D8 E04E CD6EE0          17      CALL    DRDX1       ;データバッファの情報を保存
0019DB E051 D8              11      RET C
0019DC E052 E5              11      PUSH    HL
0019DD E053 C5              11      PUSH    BC
0019DE E054 D5              11      PUSH    DE
0019DF E055 2A7EE7          16      LD  HL,(_DTBUF)
0019E2 E058 3AB1E0          13      LD  A,(_DBS24)
0019E5 E05B 4F               4      LD  C,A
0019E6 E05C CD72E3          17      CALL    DRD24
0019E9 E05F DC83E0          17      CALL    C,DRDNE
       E062                     POP_DE_BC_HL_RET:
0019EC E062 D1              10      POP DE
0019ED E063 C1              10      POP BC
0019EE E064 E1              10      POP HL
0019EF E065 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E066                     DRDN:
0019F0 E066 AF               4      XOR A
0019F1 E067 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
0019F2 E068 30E0            12      JR  NC,DRDX
       E06A                     DRDNX:
0019F4 E06A CD88E0          17      CALL    DRDY
0019F7 E06D C8              11      RET Z
       E06E                     DRDX1:
0019F8 E06E CD9EE0          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
0019FB E071 ED53A6E6        20      LD  (_DBSEC),DE
0019FF E075 79               4      LD  A,C
001A00 E076 32B1E0          13      LD  (_DBS24),A
                                
001A03 E079 3A88E6          13      LD  A,(_DRV)
001A06 E07C 32A5E6          13      LD  (_DBDRV),A
001A09 E07F CDD9E6          17      CALL    _CHGDRV
001A0C E082 D0              11      RET NC
       E083                     DRDNE:
001A0D E083 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001A0E E084 32A5E6          13      LD  (_DBDRV),A
001A11 E087 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E088                     DRDY:
001A12 E088 3AB1E0          13      LD  A,(_DBS24)
001A15 E08B B9               4      CP  C
001A16 E08C C0              11      RET NZ
                                
001A17 E08D E5              11      PUSH    HL
001A18 E08E 3A88E6          13      LD  A,(_DRV)
001A1B E091 21A5E6          10      LD  HL,_DBDRV
001A1E E094 AE               7      XOR (HL)
001A1F E095 2005            12      JR  NZ,POP_HL_RET
                                
001A21 E097 2AA6E6          16      LD  HL,(_DBSEC)
001A24 E09A ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E09C                     POP_HL_RET:
001A26 E09C E1              10      POP HL
001A27 E09D C9              10      RET
                                
       E09E                     DWTX:
001A28 E09E 3AA4E6          13      LD  A,(_WTDBF)
001A2B E0A1 B7               4      OR  A
001A2C E0A2 C8              11      RET Z
001A2D E0A3 AF               4      XOR A
001A2E E0A4 32A4E6          13      LD  (_WTDBF),A
                                
001A31 E0A7 E5              11      PUSH    HL
001A32 E0A8 C5              11      PUSH    BC
001A33 E0A9 D5              11      PUSH    DE
001A34 E0AA 3AA5E6          13      LD  A,(_DBDRV)
001A37 E0AD CDD9E6          17      CALL    _CHGDRV
001A3A E0B0 0E00             7      LD  C,0
       E0B1                     _DBS24  EQU $-1
001A3C E0B2 ED5BA6E6        20      LD  DE,(_DBSEC)
001A40 E0B6 2A7EE7          16      LD  HL,(_DTBUF)
001A43 E0B9 D480E3          17      CALL    NC,DWT24
       E0BC                     POP_DE_BC_HL_RET2:
001A46 E0BC 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E0BE                     RDFATX:
001A48 E0BE E5              11      PUSH    HL
001A49 E0BF 3A88E6          13      LD  A,(_DRV)
001A4C E0C2 21AAE6          10      LD  HL,_FATDRV
001A4F E0C5 AE               7      XOR (HL)
001A50 E0C6 28D4            12      JR  Z,POP_HL_RET
                                
001A52 E0C8 C5              11      PUSH    BC
001A53 E0C9 D5              11      PUSH    DE
001A54 E0CA DDE5            15      PUSH    IX
001A56 E0CC CDE8E0          17      CALL    WTFATX
001A59 E0CF 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
001A5B E0D1 AF               4      XOR A
001A5C E0D2 32ABE6          13      LD  (_FATIX),A
001A5F E0D5 3A88E6          13      LD  A,(_DRV)
001A62 E0D8 32AAE6          13      LD  (_FATDRV),A
001A65 E0DB CDE5E6          17      CALL    _RDFAT
       E0DE                     RDFATE2:
001A68 E0DE 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
001A6A E0E0 9F               4      SBC A,A     ;A=0xFF
001A6B E0E1 32AAE6          13      LD  (_FATDRV),A
       E0E4                     POP_IX_DE_BC_HL_RET:
001A6E E0E4 DDE1            14      POP IX
001A70 E0E6 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E0E8                     WTFATX:
001A72 E0E8 3AA2E6          13      LD  A,(_WTFATF)
001A75 E0EB B7               4      OR  A
001A76 E0EC C8              11      RET Z
001A77 E0ED AF               4      XOR A
001A78 E0EE 32A2E6          13      LD  (_WTFATF),A
                                
001A7B E0F1 E5              11      PUSH    HL
001A7C E0F2 3AAAE6          13      LD  A,(_FATDRV)
001A7F E0F5 21A5E6          10      LD  HL,_DBDRV
001A82 E0F8 AE               7      XOR (HL)
001A83 E0F9 CC9EE0          17      CALL    Z,DWTX
001A86 E0FC 389E            12      JR  C,POP_HL_RET
001A88 E0FE C5              11      PUSH    BC
001A89 E0FF D5              11      PUSH    DE
001A8A E100 DDE5            15      PUSH    IX
001A8C E102 CD91E3          17      CALL    FATSETUP
001A8F E105 D482E3          17      CALL    NC,DWT24B
001A92 E108 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E10A                     N16CL1:
001A94 E10A 7A               4      LD  A,D
001A95 E10B B3               4      OR  E
001A96 E10C 37               4      SCF
001A97 E10D C8              11      RET Z
                                
001A98 E10E 7A               4      LD  A,D
001A99 E10F 1807            12      JR  NCL1X
       E111                     NCL1:
001A9B E111 7A               4      LD  A,D
001A9C E112 B3               4      OR  E
001A9D E113 37               4      SCF
001A9E E114 C8              11      RET Z
                                
001A9F E115 7A               4      LD  A,D
001AA0 E116 CB3F             8      SRL A   ;/2
       E118                     NCL1X:
001AA2 E118 CB3F             8      SRL A   ;/2
                                
001AA4 E11A E5              11      PUSH    HL
001AA5 E11B 323AE1          13      LD  (NCLPAT_FATIX),A    ;_FATIX
001AA8 E11E 2AAAE6          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001AAB E121 BC               4      CP  H
001AAC E122 3A88E6          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001AAF E125 3239E1          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001AB2 E128 2005            12      JR  NZ,NCL2     ;FATIXが違う
001AB4 E12A BD               4      CP  L
001AB5 E12B 2002            12      JR  NZ,NCL2     ;ドライブが違う
001AB7 E12D E1              10      POP HL
001AB8 E12E C9              10      RET
       E12F                     NCL2:
001AB9 E12F C5              11      PUSH    BC
001ABA E130 D5              11      PUSH    DE
001ABB E131 DDE5            15      PUSH    IX
001ABD E133 CDE8E0          17      CALL    WTFATX
001AC0 E136 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
001AC2 E138 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E13A                     NCLPAT_FATIX    EQU $-1
       E139                     NCLPAT_FATDRV   EQU $-2
001AC5 E13B ED43AAE6        20      LD  (_FATDRV),BC
001AC9 E13F CD66E3          17      CALL    RDFATS
001ACC E142 189A            12      JR  RDFATE2
                                
       E144                     NCL3:
001ACE E144 CB9A             8      RES 3,D
001AD0 E146 CB92             8      RES 2,D
001AD2 E148 6B               4      LD  L,E
001AD3 E149 62               4      LD  H,D
001AD4 E14A CB3C             8      SRL H   ;
001AD6 E14C CB1D             8      RR  L   ;HLA=HLA/2
001AD8 E14E 1F               4      RRA     ;
001AD9 E14F F5              11      PUSH    AF
001ADA E150 3AABE6          13      LD  A,(_FATIX)
001ADD E153 0F               4      RRCA
001ADE E154 300B            12      JR  NC,NCL3X1
001AE0 E156 3A56DF          13      LD  A,(SECSZ_H)
001AE3 E159 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの際に先頭を512バイトずらす
001AE5 E15B 2004            12      JR  NZ,NCL3X1
001AE7 E15D 010002          10      LD  BC,512
001AEA E160 09              11      ADD HL,BC
       E161                     NCL3X1:
001AEB E161 F1              10      POP AF
001AEC E162 ED4B7CE7        20      LD  BC,(_FATBF)
001AF0 E166 19              11      ADD HL,DE
001AF1 E167 09              11      ADD HL,BC
001AF2 E168 17               4      RLA
001AF3 E169 C9              10      RET
                                
       E16A                     GNCL:
001AF4 E16A CD11E1          17      CALL    NCL1        ;GET NEXT CLUSTER
001AF7 E16D D8              11      RET C
001AF8 E16E C5              11      PUSH    BC
001AF9 E16F E5              11      PUSH    HL
001AFA E170 CD44E1          17      CALL    NCL3
001AFD E173 3809            12      JR  C,GNC1
001AFF E175 5E               7      LD  E,(HL)
001B00 E176 23               6      INC HL
001B01 E177 7E               7      LD  A,(HL)
001B02 E178 E60F             7      AND 00FH
001B04 E17A 57               4      LD  D,A
001B05 E17B E1              10      POP HL
001B06 E17C C1              10      POP BC
001B07 E17D C9              10      RET
       E17E                     GNC1:
001B08 E17E 7E               7      LD  A,(HL)
001B09 E17F 23               6      INC HL
001B0A E180 56               7      LD  D,(HL)
001B0B E181 0604             7      LD  B,4
       E183                     GNC1L:
001B0D E183 CB3A             8      SRL D   ;DA=DA/2
001B0F E185 1F               4      RRA     ;
001B10 E186 10FB            13      DJNZ    GNC1L
                                
001B12 E188 5F               4      LD  E,A
001B13 E189 E1              10      POP HL
001B14 E18A C1              10      POP BC
001B15 E18B A7               4      AND A
001B16 E18C C9              10      RET
                                
       E18D                     SNCL:
001B17 E18D CD11E1          17      CALL    NCL1
001B1A E190 D8              11      RET C
                                ;               SET NEXT CLUSTER
001B1B E191 E5              11      PUSH    HL
001B1C E192 C5              11      PUSH    BC
001B1D E193 D5              11      PUSH    DE
001B1E E194 E5              11      PUSH    HL
001B1F E195 CD44E1          17      CALL    NCL3
001B22 E198 D1              10      POP DE
                                ;CF=ODD
001B23 E199 7E               7      LD  A,(HL)
001B24 E19A 73               7      LD  (HL),E
001B25 E19B 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
001B27 E19D 23               6      INC HL
001B28 E19E ED67            18      RRD     ;M={A[3:0],E[3:0]}
001B2A E1A0 7A               4      LD  A,D
001B2B E1A1 1804            12      JR  SNC11
       E1A3                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
001B2D E1A3 ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001B2F E1A5 23               6      INC HL
001B30 E1A6 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E1A7                     SNC11:
001B31 E1A7 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
001B33 E1A9 B7               4      OR  A
001B34 E1AA D1              10      POP DE
001B35 E1AB C1              10      POP BC
001B36 E1AC E1              10      POP HL
       E1AD                     FAT_CHANGED:
001B37 E1AD 3EFF             7      LD  A,0FFH
001B39 E1AF 32A2E6          13      LD  (_WTFATF),A
001B3C E1B2 C9              10      RET
                                
       E1B3                     N16CL3:
001B3D E1B3 C5              11      PUSH    BC
001B3E E1B4 6B               4      LD  L,E
001B3F E1B5 7A               4      LD  A,D
001B40 E1B6 E601             7      AND 1
001B42 E1B8 67               4      LD  H,A
001B43 E1B9 29              11      ADD HL,HL
001B44 E1BA ED4B7CE7        20      LD  BC,(_FATBF)
001B48 E1BE 09              11      ADD HL,BC
001B49 E1BF C1              10      POP BC
001B4A E1C0 C9              10      RET
                                
       E1C1                     GNCL16:
001B4B E1C1 CD0AE1          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
001B4E E1C4 D8              11      RET C
001B4F E1C5 E5              11      PUSH    HL
001B50 E1C6 CDB3E1          17      CALL    N16CL3
001B53 E1C9 5E               7      LD  E,(HL)
001B54 E1CA 23               6      INC HL
001B55 E1CB 56               7      LD  D,(HL)
001B56 E1CC E1              10      POP HL
001B57 E1CD C9              10      RET
                                
       E1CE                     SNCL16:
001B58 E1CE CD0AE1          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
001B5B E1D1 D8              11      RET C
001B5C E1D2 D5              11      PUSH    DE
001B5D E1D3 E5              11      PUSH    HL
001B5E E1D4 CDB3E1          17      CALL    N16CL3
001B61 E1D7 D1              10      POP DE      ;HL
001B62 E1D8 73               7      LD  (HL),E
001B63 E1D9 23               6      INC HL
001B64 E1DA 72               7      LD  (HL),D
001B65 E1DB 6B               4      LD  L,E
001B66 E1DC 62               4      LD  H,D
001B67 E1DD D1              10      POP DE
001B68 E1DE 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E1E0                     NEXTX:
001B6A E1E0 3E00             7      LD  A,0 ;自己書き換え
       E1E1                     _SECPS  EQU $-1
001B6C E1E2 3C               4      INC A
001B6D E1E3 E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E1E4                     _NCPAT  EQU $-1
001B6F E1E5 32E1E1          13      LD  (_SECPS),A
001B72 E1E8 C9              10      RET
                                
       E1E9                     GNCLX:
001B73 E1E9 CDE0E1          17      CALL    NEXTX
001B76 E1EC C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001B77 E1ED C3F7E6          10      JP  _GNCL   ;次のクラスタを探す
                                
       E1F0                     RDFAT:
001B7A E1F0 3E80             7      LD  A,080H
001B7C E1F2 3270E6          13      LD  (CHECK),A
       E1F5                     RDFAT1:
001B7F E1F5 3A88E6          13      LD  A,(_DRV)
001B82 E1F8 CD9AE4          17      CALL    CHGDRVR
001B85 E1FB D8              11      RET C
001B86 E1FC DD7E12          19      LD  A,(IX+DPB_DEVICE)
001B89 E1FF CB6F             8      BIT 5,A
001B8B E201 286E            12      JR  Z,RDFAT0X
001B8D E203 2170E6          10      LD  HL,CHECK
001B90 E206 A6               7      AND (HL)
001B91 E207 77               7      LD  (HL),A
001B92 E208 110000          10      LD  DE,0        ;BPB
001B95 E20B 2A7CE7          16      LD  HL,(_FATBF)
001B98 E20E 0E00             7      LD  C,0
001B9A E210 CD72E3          17      CALL    DRD24
001B9D E213 3022            12      JR  NC,GETBPB
001B9F E215 2170E6          10      LD  HL,CHECK
001BA2 E218 CB06            15      RLC (HL)
001BA4 E21A 3F               4      CCF
001BA5 E21B D8              11      RET C
001BA6 E21C DDCB0A1E        23      RR  (IX+DPB_FDMODE)
001BAA E220 3F               4      CCF         ;フロッピーディスクのFDモード(2D/2HD)を切り替える
001BAB E221 DDCB0A16        23      RL  (IX+DPB_FDMODE)
001BAF E225 3A84E6          13      LD  A,(_DRIVE)
001BB2 E228 E603             7      AND 3
001BB4 E22A F680             7      OR  080H
001BB6 E22C 6F               4      LD  L,A
001BB7 E22D 26E6             7      LD  H,_CYL0/256
001BB9 E22F 3EFF             7      LD  A,0FFH
001BBB E231 3289E6          13      LD  (_DSK),A
001BBE E234 77               7      LD  (HL),A
001BBF E235 18BE            12      JR  RDFAT1
       E237                     GETBPB:
001BC1 E237 FDE5            15      PUSH    IY
001BC3 E239 FD2A7CE7        20      LD  IY,(_FATBF) ;BPB
001BC7 E23D CDF1E6          17      CALL    _BPB2DPB
001BCA E240 FDE1            14      POP IY
001BCC E242 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001BCF E245 3027            12      JR  NC,GETBPBOK
001BD1 E247 E60F             7      AND 00FH
001BD3 E249 FE07             7      CP  7
001BD5 E24B 37               4      SCF
001BD6 E24C C0              11      RET NZ
001BD7 E24D DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001BDB E251 21C0E7          10      LD  HL,M2D
001BDE E254 2008            12      JR  NZ,SETFDMODE
001BE0 E256 2E04             7      LD  L,4
001BE2 E258 CD5BE3          17      CALL    CHECK_MAXSECSZ
001BE5 E25B D8              11      RET C
001BE6 E25C 2ED2             7      LD  L,M2HD-STABLE
       E25E                     SETFDMODE:
001BE8 E25E DDE5            15      PUSH    IX
001BEA E260 D1              10      POP DE
001BEB E261 EDA0            16      LDI
001BED E263 EDA0            16      LDI
001BEF E265 13               6      INC DE
001BF0 E266 13               6      INC DE
001BF1 E267 13               6      INC DE
001BF2 E268 13               6      INC DE
001BF3 E269 010C00          10      LD  BC,12
001BF6 E26C EDB0                    LDIR
       E26E                     GETBPBOK:
001BF8 E26E CD06E4          17      CALL    CHGDRV2
       E271                     RDFAT0X:
001BFB E271 CD66E3          17      CALL    RDFATS
001BFE E274 D8              11      RET C
001BFF E275 DDAE06          19      XOR (IX+DPB_FATID)
001C02 E278 C8              11      RET Z
001C03 E279 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001C06 E27C CB5F             8      BIT 3,A
001C08 E27E 2803            12      JR  Z,RDFAT0X1
001C0A E280 CB6F             8      BIT 5,A
001C0C E282 C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E283                     RDFAT0X1:
001C0D E283 37               4      SCF
001C0E E284 C9              10      RET
                                
       E285                     POP_HL_SCF_RET:
001C0F E285 E1              10      POP HL
001C10 E286 37               4      SCF
001C11 E287 C9              10      RET
                                
       E288                     BPB2DPB:
001C12 E288 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
001C15 E28B B7               4      OR  A
001C16 E28C 37               4      SCF
001C17 E28D C0              11      RET NZ
       E28E                     BPBOK:
001C18 E28E FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001C1B E291 DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001C1E E294 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001C21 E297 DD7700          19      LD  (IX+DPB_FATLN),A
001C24 E29A FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
001C27 E29D DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
001C2A E2A0 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001C2D E2A3 FD660F          19      LD  H,(IY+15)
001C30 E2A6 DD750E          19      LD  (IX+DPB_FATPS),L
001C33 E2A9 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001C36 E2AC FD5617          19      LD  D,(IY+23)
001C39 E2AF FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E2B2                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001C3C E2B2 19              11      ADD HL,DE
001C3D E2B3 10FD            13      DJNZ    BPBDP1
       E2B5                     BPBDP2:
001C3F E2B5 DD7510          19      LD  (IX+DPB_DIRPS),L
001C42 E2B8 DD7411          19      LD  (IX+DPB_DIRPS+1),H
001C45 E2BB E5              11      PUSH    HL
                                
001C46 E2BC FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
001C49 E2BF FD6612          19      LD  H,(IY+18)
001C4C E2C2 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001C4F E2C5 B7               4      OR  A
001C50 E2C6 28BD            12      JR  Z,POP_HL_SCF_RET
001C52 E2C8 0606             7      LD  B,6
       E2CA                     BPBBPS1:
001C54 E2CA 05               4      DEC B
001C55 E2CB 0F               4      RRCA
001C56 E2CC 30FC            12      JR  NC,BPBBPS1
       E2CE                     BPBDE1:
001C58 E2CE 29              11      ADD HL,HL
001C59 E2CF 10FD            13      DJNZ    BPBDE1
                                
001C5B E2D1 7C               4      LD  A,H
001C5C E2D2 DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
001C5F E2D5 D1              10      POP DE      ;DPB_DIRPS
001C60 E2D6 6C               4      LD  L,H
001C61 E2D7 2600             7      LD  H,0
001C63 E2D9 19              11      ADD HL,DE       ;MAXDIR
001C64 E2DA E5              11      PUSH    HL
001C65 E2DB FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001C68 E2DE CB21             8      SLA C       ;*2
001C6A E2E0 AF               4      XOR A
001C6B E2E1 47               4      LD  B,A
001C6C E2E2 ED42            15      SBC HL,BC
001C6E E2E4 DD7514          19      LD  (IX+DPB_ADDCL),L
001C71 E2E7 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
001C74 E2EA D1              10      POP DE      ;DE=DPB_MAXDIR
001C75 E2EB FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001C78 E2EE FD6614          19      LD  H,(IY+20)
                                
001C7B E2F1 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001C7E E2F4 E60F             7      AND 00FH
001C80 E2F6 FE07             7      CP  7       ;フロッピー
001C82 E2F8 2019            12      JR  NZ,NOT_FD
001C84 E2FA E5              11      PUSH    HL
001C85 E2FB FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001C88 E2FE DD710D          19      LD  (IX+DPB_MAXSEC),C
001C8B E301 AF               4      XOR A
001C8C E302 CB21             8      SLA C       ;両面なのでセクタ数を２倍
001C8E E304 0610             7      LD  B,16
       E306                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001C90 E306 29              11      ADD HL,HL
001C91 E307 17               4      RLA
001C92 E308 B9               4      CP  C
001C93 E309 3802            12      JR  C,DIVSEC1
001C95 E30B 91               4      SUB C
001C96 E30C 2C               4      INC L
       E30D                     DIVSEC1:
001C97 E30D 10F7            13      DJNZ    DIVSEC
001C99 E30F DD750C          19      LD  (IX+DPB_MAXCYL),L
001C9C E312 E1              10      POP HL  ;ここまでフロッピー専用
       E313                     NOT_FD:
001C9D E313 7C               4      LD  A,H
001C9E E314 B5               4      OR  L
001C9F E315 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001CA1 E317 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001CA3 E319 2F               4      CPL         ;A=0FFH
001CA4 E31A FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001CA7 E31D D8              11      RET C
001CA8 E31E FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001CAB E321 FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001CAE E324 FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E327                     BPB16BIT:
001CB1 E327 ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001CB3 E329 DE00             7      SBC A,0
001CB5 E32B FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E32E                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001CB8 E32E CB18             8      RR  B       ;->CY
001CBA E330 3808            12      JR  C,BPBTC2
001CBC E332 CB3F             8      SRL A
001CBE E334 CB1C             8      RR  H       ;AHL=AHL/2
001CC0 E336 CB1D             8      RR  L
001CC2 E338 18F4            12      JR  BPBTC1
       E33A                     BPBTC2:
001CC4 E33A C6FF             7      ADD A,0FFH
001CC6 E33C D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001CC7 E33D 23               6      INC HL
001CC8 E33E 23               6      INC HL
001CC9 E33F DD7508          19      LD  (IX+DPB_MAXCL),L
001CCC E342 DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001CCF E345 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001CD2 E348 DD7706          19      LD  (IX+DPB_FATID),A
                                
001CD5 E34B FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001CD8 E34E C6FE             7      ADD A,0-2       ;>2:CF=1
001CDA E350 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001CDD E353 6F               4      LD  L,A
001CDE E354 3002            12      JR  NC,BPBFAT1
001CE0 E356 F680             7      OR  080H
       E358                     BPBFAT1:            ;ここではCF=0
001CE2 E358 DD770F          19      LD  (IX+DPB_BPS),A
       E35B                     CHECK_MAXSECSZ:
001CE5 E35B 3A7BE7          13      LD  A,(_MAX_SEC_SZ_H)
001CE8 E35E BD               4      CP  L
001CE9 E35F C8              11      RET Z       ;1セクタ1024バイト
001CEA E360 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001CEB E361 C8              11      RET Z       ;1セクタ256バイト
001CEC E362 2D               4      DEC L
001CED E363 C8              11      RET Z       ;1セクタ512バイト
001CEE E364 37               4      SCF
001CEF E365 C9              10      RET
                                
       E366                     RDFATS:
001CF0 E366 CD91E3          17      CALL    FATSETUP
001CF3 E369 D8              11      RET C
001CF4 E36A CD74E3          17      CALL    DRD24B
001CF7 E36D 2A7CE7          16      LD  HL,(_FATBF)
001CFA E370 7E               7      LD  A,(HL)
001CFB E371 C9              10      RET
                                
       E372                     DRD24:
001CFC E372 0601             7      LD  B,1
       E374                     DRD24B:
001CFE E374 DDE5            15      PUSH    IX
001D00 E376 DD2AA8E6        20      LD  IX,(_DPB)
001D04 E37A CD09CC          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E37B                     DRDPAT  EQU $-2
001D07 E37D DDE1            14      POP IX
001D09 E37F C9              10      RET
                                
       E380                     DWT24:
001D0A E380 0601             7      LD  B,1
       E382                     DWT24B:
001D0C E382 DDE5            15      PUSH    IX
001D0E E384 DD2AA8E6        20      LD  IX,(_DPB)
001D12 E388 CDDDE4          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E389                     DWTPAT  EQU $-2
001D15 E38B DDE1            14      POP IX
001D17 E38D D0              11      RET NC
001D18 E38E C35AE6          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E391                     FATSETUP:
001D1B E391 3AAAE6          13      LD  A,(_FATDRV)
001D1E E394 CD9AE4          17      CALL    CHGDRVR     ;ドライブ切り替え
001D21 E397 D8              11      RET C
       E398                     FATS2:
001D22 E398 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001D25 E39B 0F               4      RRCA
001D26 E39C CDCCE3          17      CALL    FATSETUP12  ;自己書き換え
       E39D                     FATSX   EQU $-2
001D29 E39F 210000          10      LD  HL,0
001D2C E3A2 4A               4      LD  C,D
001D2D E3A3 54               4      LD  D,H
001D2E E3A4 3AABE6          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
001D31 E3A7 47               4      LD  B,A
001D32 E3A8 04               4      INC B
001D33 E3A9 DD7E00          19      LD  A,(IX+DPB_FATLN)
       E3AC                     FAT_SKP:
001D36 E3AC 05               4      DEC B
001D37 E3AD 2809            12      JR  Z,FAT1
001D39 E3AF 19              11      ADD HL,DE
001D3A E3B0 93               4      SUB E
001D3B E3B1 30F9            12      JR  NC,FAT_SKP
001D3D E3B3 DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
001D41 E3B7 C8              11      RET Z
       E3B8                     FAT1:
001D42 E3B8 EB               4      EX  DE,HL
001D43 E3B9 B7               4      OR  A       ;0の場合は0100Hとして扱う
001D44 E3BA 2803            12      JR  Z,FAT3
001D46 E3BC B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001D47 E3BD 3801            12      JR  C,FAT2
       E3BF                     FAT3:
001D49 E3BF 79               4      LD  A,C
       E3C0                     FAT2:
001D4A E3C0 47               4      LD  B,A
                                
001D4B E3C1 2AFAE7          16      LD  HL,(_FATPS) ;fat sector pos
001D4E E3C4 19              11      ADD HL,DE
001D4F E3C5 EB               4      EX  DE,HL
001D50 E3C6 2A7CE7          16      LD  HL,(_FATBF)
001D53 E3C9 AF               4      XOR A       ;CF=0
001D54 E3CA 4F               4      LD  C,A
001D55 E3CB C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E3CC                     FATSETUP12:
001D56 E3CC 110606          10      LD  DE,0606H    ;256
001D59 E3CF D8              11      RET C
001D5A E3D0 110303          10      LD  DE,0303H    ;512
001D5D E3D3 0F               4      RRCA
001D5E E3D4 D8              11      RET C
001D5F E3D5 110102          10      LD  DE,0201H    ;1024
001D62 E3D8 C9              10      RET
                                
       E3D9                     FATSETUP16:
001D63 E3D9 110404          10      LD  DE,0404H    ;256
001D66 E3DC D8              11      RET C
001D67 E3DD 110202          10      LD  DE,0202H    ;512
001D6A E3E0 0F               4      RRCA
001D6B E3E1 D8              11      RET C
001D6C E3E2 110101          10      LD  DE,0101H    ;1024
001D6F E3E5 C9              10      RET
                                
       E3E6                     CHGDRV:
001D70 E3E6 E5              11      PUSH    HL
001D71 E3E7 2189E6          10      LD  HL,_DSK
001D74 E3EA BE               7      CP  (HL)
001D75 E3EB 280A            12      JR  Z,CHGDRVE
       E3ED                     CHGDRV1:
001D77 E3ED DDE5            15      PUSH    IX
001D79 E3EF CDF9E3          17      CALL    CHGDRV0
001D7C E3F2 3A89E6          13      LD  A,(_DSK)
001D7F E3F5 DDE1            14      POP IX
       E3F7                     CHGDRVE:
001D81 E3F7 E1              10      POP HL
001D82 E3F8 C9              10      RET
                                
       E3F9                     CHGDRV0:
001D83 E3F9 6F               4      LD  L,A
001D84 E3FA CDDCE6          17      CALL    _GETDPB
001D87 E3FD D8              11      RET C
001D88 E3FE DD22A8E6        20      LD  (_DPB),IX
001D8C E402 7D               4      LD  A,L
001D8D E403 3289E6          13      LD  (_DSK),A
       E406                     CHGDRV2:
001D90 E406 C5              11      PUSH    BC
001D91 E407 D5              11      PUSH    DE
001D92 E408 ED7351E4        20      LD  (SPPAT2),SP
001D96 E40C F3               4      DI
001D97 E40D DDF9            10      LD  SP,IX
                                
001D99 E40F E1              10      POP HL      ;00:DPB_FATLN
001D9A E410 E1              10      POP HL      ;02:DPB_DRD
001D9B E411 227BE3          16      LD  (DRDPAT),HL
                                
001D9E E414 E1              10      POP HL
001D9F E415 2289E3          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001DA2 E418 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001DA3 E419 7C               4      LD  A,H
001DA4 E41A 327DDA          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001DA7 E41D 3D               4      DEC A
001DA8 E41E 32E4E1          13      LD  (_NCPAT),A
                                
001DAB E421 E1              10      POP HL      ;08:DPB_MAXCL
001DAC E422 7D               4      LD  A,L
001DAD E423 329CDA          13      LD  (CLPAT2),A
001DB0 E426 7C               4      LD  A,H
001DB1 E427 3298DA          13      LD  (CLPAT1),A
001DB4 E42A 2B               6      DEC HL
001DB5 E42B 229BDC          16      LD  (MAXCLP),HL
                                
001DB8 E42E E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001DB9 E42F 4C               4      LD  C,H
                                
001DBA E430 E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001DBB E431 E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001DBC E432 7C               4      LD  A,H     ;DPB_BPS
001DBD E433 E607             7      AND 7
001DBF E435 3256DF          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001DC2 E438 87               4      ADD A,A     ;8  4   2
001DC3 E439 87               4      ADD A,A     ;010H   8   4
001DC4 E43A 87               4      ADD A,A     ;020H   010H    8
001DC5 E43B 32FBD8          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001DC8 E43E 2600             7      LD  H,0
001DCA E440 22FAE7          16      LD  (_FATPS),HL
                                
001DCD E443 E1              10      POP HL      ;10:DPB_DIRPS
001DCE E444 22FCE7          16      LD  (_DIRPS),HL
                                
001DD1 E447 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001DD2 E448 7C               4      LD  A,H
001DD3 E449 3284E6          13      LD  (_DRIVE),A
                                
001DD6 E44C E1              10      POP HL      ;14:DPB_ADDCL
001DD7 E44D 228DDA          16      LD  (CLSPAT),HL
                                
001DDA E450 310000          10      LD  SP,0        ;元のSPを復元
       E451                     SPPAT2  EQU $-2
001DDD E453 FB               4      EI
001DDE E454 2AFCE7          16      LD  HL,(_DIRPS)
001DE1 E457 0600             7      LD  B,0
001DE3 E459 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001DE4 E45A 2216D9          16      LD  (MD_PAT),HL
                                
001DE7 E45D 2A9BDC          16      LD  HL,(MAXCLP)
001DEA E460 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001DED E463 19              11      ADD HL,DE
001DEE E464 380F            12      JR  C,SETFAT16
001DF0 E466 216AE1          10      LD  HL,GNCL     ;FAT12
001DF3 E469 118DE1          10      LD  DE,SNCL
001DF6 E46C 01CCE3          10      LD  BC,FATSETUP12
001DF9 E46F DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001DFD E473 180D            12      JR  EXTRA1
       E475                     SETFAT16:
001DFF E475 21C1E1          10      LD  HL,GNCL16   ;FAT16
001E02 E478 11CEE1          10      LD  DE,SNCL16
001E05 E47B 01D9E3          10      LD  BC,FATSETUP16
001E08 E47E DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       E482                     EXTRA1:
001E0C E482 22F8E6          16      LD  (GNCPAT),HL
001E0F E485 ED53FBE6        20      LD  (SNCPAT),DE
001E13 E489 ED439DE3        20      LD  (FATSX),BC
001E17 E48D D1              10      POP DE
001E18 E48E C1              10      POP BC
001E19 E48F AF               4      XOR A
001E1A E490 C9              10      RET
                                
       E491                     GETDPBD:
001E1B E491 DDE3            23      EX  (SP),IX
001E1D E493 DDE5            15      PUSH    IX
001E1F E495 3A88E6          13      LD  A,(_DRV)
001E22 E498 1807            12      JR  GETDPB1
                                
       E49A                     CHGDRVR:
001E24 E49A CDD9E6          17      CALL    _CHGDRV
001E27 E49D D8              11      RET C
001E28 E49E 3A89E6          13      LD  A,(_DSK)
       E4A1                     GETDPB1:
001E2B E4A1 C3DCE6          10      JP  _GETDPB
                                
       E4A4                     GETDPB:
001E2E E4A4 FE08             7      CP  8
001E30 E4A6 3F               4      CCF
001E31 E4A7 D8              11      RET C
001E32 E4A8 0F               4      RRCA
001E33 E4A9 0F               4      RRCA
001E34 E4AA 0F               4      RRCA
001E35 E4AB DD                      DB  0DDH        ;Z80未定義命令
001E36 E4AC 6F               4      LD  L,A     ;LD IXL,A
001E37 E4AD DD                      DB  0DDH        ;Z80未定義命令
001E38 E4AE 26E8             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001E3A E4B0 DD7E00          19      LD  A,(IX+DPB_FATLN)
001E3D E4B3 A7               4      AND A       ;CF=0の為
001E3E E4B4 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001E42 E4B8 C0              11      RET NZ      ;FAT16
001E43 E4B9 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001E47 E4BD C0              11      RET NZ      ;BPB
001E48 E4BE FE01             7      CP  001H        ;A=0 THEN CF=1
001E4A E4C0 C9              10      RET
                                
       E4C1                     _SYS5F:
001E4B E4C1 AF               4      XOR A
       E4C2                     FFLUSH:
001E4C E4C2 F5              11      PUSH    AF
001E4D E4C3 CDE8E0          17      CALL    WTFATX
001E50 E4C6 AF               4      XOR A
001E51 E4C7 32ABE6          13      LD  (_FATIX),A
001E54 E4CA 2F               4      CPL         ;0FFH
001E55 E4CB 32AAE6          13      LD  (_FATDRV),A
001E58 E4CE 3E                      DB  03EH        ;次のPUSH AFをスキップ
       E4CF                     FFLUSHBUF:
001E59 E4CF F5              11      PUSH    AF
001E5A E4D0 CD9EE0          17      CALL    DWTX
001E5D E4D3 3EFF             7      LD  A,0FFH
001E5F E4D5 3239E6          13      LD  (SFILE),A
001E62 E4D8 32A5E6          13      LD  (_DBDRV),A
001E65 E4DB F1              10      POP AF
001E66 E4DC C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "MSXDISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MSX
                                
                                ;   PHYDIO DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       E4DD                     WTTRK:
       E4DD                     FDWT:
001E67 E4DD 37               4      SCF
001E68 E4DE C9              10      RET
                                
       E4DF                     PDWT:
001E69 E4DF 37               4      SCF
001E6A E4E0 CB7C             8      BIT 7,H
001E6C E4E2 2058            12      JR  NZ,PDWX
001E6E E4E4 CDCFE4          17      CALL    FFLUSHBUF
       E4E7                     PDWT1:
001E71 E4E7 C5              11      PUSH    BC
001E72 E4E8 D5              11      PUSH    DE
001E73 E4E9 ED5B7EE7        20      LD  DE,(_DTBUF)
001E77 E4ED DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001E7A E4F0 E607             7      AND 7
001E7C E4F2 47               4      LD  B,A
001E7D E4F3 0E00             7      LD  C,0
001E7F E4F5 EDB0                    LDIR
001E81 E4F7 E3              19      EX  (SP),HL
001E82 E4F8 EB               4      EX  DE,HL
001E83 E4F9 D5              11      PUSH    DE
001E84 E4FA 2A7EE7          16      LD  HL,(_DTBUF)
001E87 E4FD 0601             7      LD  B,1
001E89 E4FF 37               4      SCF
001E8A E500 CD3CE5          17      CALL    PDWX
001E8D E503 3832            12      JR  C,PDRWERR
001E8F E505 D1              10      POP DE
001E90 E506 13               6      INC DE
001E91 E507 E1              10      POP HL
001E92 E508 C1              10      POP BC
001E93 E509 10D4            13      DJNZ    PDWT
001E95 E50B AF               4      XOR A
001E96 E50C C9              10      RET
       E50D                     PDRD:
001E97 E50D CB7C             8      BIT 7,H
001E99 E50F 202A            12      JR  NZ,PDWXR
001E9B E511 CDCFE4          17      CALL    FFLUSHBUF
       E514                     PDRD1:
001E9E E514 C5              11      PUSH    BC
001E9F E515 D5              11      PUSH    DE
001EA0 E516 E5              11      PUSH    HL
001EA1 E517 2A7EE7          16      LD  HL,(_DTBUF)
001EA4 E51A 0601             7      LD  B,1
001EA6 E51C CD3BE5          17      CALL    PDWXR
001EA9 E51F 3816            12      JR  C,PDRWERR
001EAB E521 D1              10      POP DE
001EAC E522 2A7EE7          16      LD  HL,(_DTBUF)
001EAF E525 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001EB2 E528 E607             7      AND 7
001EB4 E52A 47               4      LD  B,A
001EB5 E52B 0E00             7      LD  C,0
001EB7 E52D EDB0                    LDIR
001EB9 E52F EB               4      EX  DE,HL
001EBA E530 D1              10      POP DE
001EBB E531 13               6      INC DE
001EBC E532 C1              10      POP BC
001EBD E533 10D8            13      DJNZ    PDRD
001EBF E535 AF               4      XOR A
001EC0 E536 C9              10      RET
       E537                     PDRWERR:
001EC1 E537 E1              10      POP HL
001EC2 E538 D1              10      POP DE
001EC3 E539 C1              10      POP BC
001EC4 E53A C9              10      RET
       E53B                     PDWXR:
001EC5 E53B A7               4      AND A
       E53C                     PDWX:                   ;CF=0 READ CF=1 WRITE
001EC6 E53C DDCB1266        20      BIT 4,(IX+DPB_DEVICE)   ;デバイス情報
001ECA E540 2003            12      JR  NZ,PDWX1
001ECC E542 DD4E06          19      LD  C,(IX+DPB_FATID)    ;メディアバイト
       E545                     PDWX1:
001ECF E545 DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
001ED2 E548 C5              11      PUSH    BC
001ED3 E549 D5              11      PUSH    DE
001ED4 E54A E5              11      PUSH    HL
001ED5 E54B DDE5            15      PUSH    IX
001ED7 E54D FDE5            15      PUSH    IY
001ED9 E54F CDA7FF          17      CALL    H_PHYD
001EDC E552 FDE1            14      POP IY
                                ;   LD  IX,PHYDIO
                                ;   CALL    CALSLT_R
001EDE E554 DDE1            14      POP IX
001EE0 E556 E1              10      POP HL
001EE1 E557 D1              10      POP DE
001EE2 E558 C1              10      POP BC
001EE3 E559 D8              11      RET C
       E55A                     PDWX2:
001EE4 E55A 13               6      INC DE
001EE5 E55B DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001EE8 E55E E607             7      AND 7
001EEA E560 84               4      ADD A,H
001EEB E561 67               4      LD  H,A
001EEC E562 10F6            13      DJNZ    PDWX2
001EEE E564 AF               4      XOR A
001EEF E565 C9              10      RET
[EOF:MSXDISK2.ASM:UTF_8]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001EF0 E566                     PATHD:  DS  PATHX
001F2B E5A1 00                  PATHE:  DB  0
                                
       E5A2                     DTA_CCP:
001F2C E5A2                         DS  37
                                
       E5C7                     FCB_BAT:
001F51 E5C7                         DS  37
                                
001F76 E5EC 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001F81 E5F7 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
                                ;   ALIGN   256
       E5FE                     AT_WORK:
001F88 E5FE                         DS  WORKAD-AT_WORK
                                
       E600                     CPM_BOOT:
001F8A E600 C30000          10      JP  0
       E603                     _SYS00:     ;(BDOS)プログラム終了
       E603                     CPM_WBOOT:
001F8D E603 C3AACC          10      JP  WBOOT1
       E606                     CPM_CONST:
001F90 E606 C3FED4          10      JP  CONSTX
       E609                     _SYS07:     ;(BDOS)コンソール直接入力
       E609                     CPM_CONIN:
001F93 E609 C31FD4          10      JP  FLGET
       E60C                     CPM_CONOUT:
001F96 E60C C301D6          10      JP  CONOUT1
                                
       E60F                     DECBF:              ;10進数表示時のバッファ(5バイト)
001F99 E60F                         DS  5
       E60F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       E611                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       E614                     FDRV:
001F9E E614 00                      DB  0
       E615                     FNAME:
001F9F E615                         DS  36
       E639                     SFILE:
001FC3 E639                         DS  33      ;DRV FILENAME
       E65A                     _DISKE:
001FE4 E65A C39BD3          10      JP  SHOW_ERROR
                                
001FE7 E65D 0000                LEFTX:  DW  0
001FE9 E65F 0000                DTAX:   DW  0
                                
                                ;   PSGのビープ音のデータ(X1)
       E661                     BEEPD:
001FEB E661 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
001FF3 E669 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                ;
       E662                     RTC_YY  EQU BEEPD+1 ;RTCのバッファ年(88)
       E663                     RTC_MW  EQU BEEPD+2 ;RTCのバッファ月(88)
       E664                     RTC_DD  EQU BEEPD+3 ;RTCのバッファ日(88)
       E665                     RTC_TT  EQU BEEPD+4 ;RTCのバッファ時(88)
       E666                     RTC_MM  EQU BEEPD+5 ;RTCのバッファ分(88)
       E667                     RTC_SS  EQU BEEPD+6 ;RTCのバッファ秒(88)
       E662                     ROM_SLT EQU BEEPD+1 ;ROMのスロット(MSX)
       E661                     ZERO    EQU BEEPD
                                
       E670                     CHECK:
001FFA E670 00                      DB  0
                                
       E671                     OK:
001FFB E671 4F4B24                  DB  "OK$"
001FFE E674                         DS  5
       E679                     COMERM:
002003 E679 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       E680                     _CYL0:
00200A E680 FF                      DB  0FFH    ;Cylinder
       E681                     _CYL1:
00200B E681 FF                      DB  0FFH    ;Cylinder
       E682                     _CYL2:
00200C E682 FF                      DB  0FFH    ;Cylinder
       E683                     _CYL3:
00200D E683 FF                      DB  0FFH    ;Cylinder
       E684                     _DRIVE:
00200E E684 00                      DB  0   ;unit number
       E685                     _SEEKSP:
00200F E685 00                      DB  0   ;Seek speed
       E686                     _ISEEK:
002010 E686 32                      DB  50  ;
002011 E687                         DS  1
       E688                     _DRV:
002012 E688 00                      DB  0
       E689                     _DSK:
002013 E689 FF                      DB  0FFH
       E68A                     _DTA:
002014 E68A 8000                    DW  00080H
       E68C                     _CTC:
002016 E68C 0000                    DW  0
       E68E                     _TXADR:
002018 E68E 0000                    DW  0
       E690                     _KEYPS:
00201A E690 0000                    DW  0
       E692                     _KEYD:
00201C E692 00                      DB  000H    ;キーデータ
       E693                     _KEYST:
00201D E693 FF                      DB  0FFH    ;キーステータス(SHIFT,CTRLの状態)
       E694                     _KEYSP_L:
00201E E694 00                      DB  KEYSP_L ;オートリピートの速度
       E695                     _KEYSP_H:
00201F E695 00                      DB  KEYSP_H ;オートリピートの速度
       E696                     _COLORF:
002020 E696 00                      DB  COLORF  ;色
       E697                     _LINE:
002021 E697 18                      DB  LINE
                                
                                            ;次のファイルの検索(C=12)で使用するFCB
       E698                     _FCB:
002022 E698 0000                    DW  0   ;SEARCH FILES
       E69A                     _FBPS:
002024 E69A 0000                    DW  0   ;    //
       E69C                     _FBAD:
002026 E69C 0000                    DW  0   ;    //
       E69E                     _FBCNT:
002028 E69E 00                      DB  0   ;    //
       E69F                     _FILEN:
002029 E69F 00                      DB  0   ;    //
       E6A0                     _DIRF:
00202A E6A0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
00202B E6A1                         DS  1
       E6A2                     _WTFATF:
00202C E6A2 00                      DB  0   ;FATバッファの更新フラグ
00202D E6A3                         DS  1
       E6A4                     _WTDBF:
00202E E6A4 00                      DB  0   ;データバッファの更新フラグ
       E6A5                     _DBDRV:
00202F E6A5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       E6A6                     _DBSEC:
002030 E6A6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       E6A8                     _DPB:
002032 E6A8 0000                    DW  0
       E6AA                     _FATDRV:
002034 E6AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       E6AB                     _FATIX:
002035 E6AB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       E6AC                     _FAKEFREE:
002036 E6AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
002038 E6AE                         DS  2
                                ;   画面周りのデータ
       E6B0                     CRTCD:
00203A E6B0 6F                      DB  06FH
       E6B1                     _WIDTH:
00203B E6B1 28                      DB  WIDTH
       E6B2                     TVRAMTOP:
00203C E6B2 5938                    DB  059H,038H
00203E E6B4 1F02                    DB  01FH,002H
       E6B6                     _LINE2:
002040 E6B6 19                      DB  019H
       E6B7                     WKE4:
002041 E6B7 1C                      DB  01CH
       E6B8                     WKE6:
002042 E6B8 00                      DB  000H
       E6B9                     WK40:
002043 E6B9 07                      DB  007H
       E6BA                     _PAGE_MINUS:
002044 E6BA 40FC                    DW  0-WIDTH*LINE
       E6BC                     _WIDTH_MINUS:
002046 E6BC D8FF                    DW  0-WIDTH
       E6BE                     WK30:
002048 E6BE 0C                      DB  00CH
       E6BF                     WK31:
       E6BF                     WK1FD0:
002049 E6BF 20                      DB  020H
                                
                                ;   割り込みベクタ(X1)
00204A E6C0 0000                CTC0:   DW  INTCTCE
00204C E6C2 0000                CTC1:   DW  INTCTCE
00204E E6C4 0000                CTC2:   DW  INTCTCE
002050 E6C6 0000                CTC3:   DW  INTCTCE
002052 E6C8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
002054 E6CA C364D4          10  _INKEY: JP  INKEY
002057 E6CD C3A4D3          10  _PRINT: JP  PRINT
00205A E6D0 C39BD5          10  _SCRN:  JP  SCRN
00205D E6D3 C37BD5          10  _POS:   JP  POS
002060 E6D6 C386D5          10  _LOC:   JP  LOC
       E6D9                     _CHGDRV:
002063 E6D9 C3E6E3          10      JP  CHGDRV
       E6DC                     _GETDPB:
002066 E6DC C3A4E4          10      JP  GETDPB
       E6DF                     _FFLUSH:
002069 E6DF C3C2E4          10      JP  FFLUSH
       E6E2                     _RDFATX:
00206C E6E2 C3BEE0          10      JP  RDFATX
00206F E6E5 C3F0E1          10  _RDFAT: JP  RDFAT
002072 E6E8 C3DDE4          10  _WTTRK: JP  WTTRK
002075 E6EB C309CC          10  _FDRD:  JP  FDRD
002078 E6EE C3DDE4          10  _FDWT:  JP  FDWT
       E6F1                     _BPB2DPB:
00207B E6F1 C388E2          10      JP  BPB2DPB
       E6F4                     _BREAK:
00207E E6F4 C325CE          10      JP  END_BATCH
       E6F7                     _GNCL:
002081 E6F7 C36AE1          10      JP  GNCL        ; self-modifying code
       E6F8                     GNCPAT  EQU $-2
       E6FA                     _SNCL:
002084 E6FA C38DE1          10      JP  SNCL        ; self-modifying code
       E6FB                     SNCPAT  EQU $-2
       E6FD                     _COMANL:
002087 E6FD C3DECC          10      JP  COMANL
                                
       E700                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       E700                     STABLE:
                                ;0
00208A E700 03E6A7D3D8D328D9        DW  _SYS00,_SYS01,_SYS02,_SYS03
002092 E708 06D106D1DED309E6        DW  _SYS04,_SYS05,_SYS06,_SYS07
00209A E710 E6D308D16AD4FED4        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
0020A2 E718 1DD122D131D142D1        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
0020AA E720 96D1DDD126D257D2        DW  _SYS10,_SYS11,_SYS12,_SYS13
0020B2 E728 5FD275D28AD282D2        DW  _SYS14,_SYS15,_SYS16,_SYS17
0020BA E730 D1D2D6D2DBD2E1D2        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
0020C2 E738 06D107D306D10BD3        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
0020CA E740 06D1C1D2C9D212D3        DW  _SYS20,_SYS21,_SYS22,_SYS23
0020D2 E748 37D306D17EDD4CDE        DW  _SYS24,_ERROR,_SYS26,_SYS27
0020DA E750 C9D241D310D528D9        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
0020E2 E758 60D528D906D162D3        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
0020EA E760 5CD306D106D106D1        DW  _SYS30,_ERROR,_ERROR,_ERROR
0020F2 E768 06D106D106D106D1        DW  _ERROR,_ERROR,_ERROR,_ERROR
0020FA E770 06D128D928D983D3        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
002102 E778 E9D0                    DW  _DOS2
                                
002104 E77A                         DS  1
       E77B                     _MAX_SEC_SZ_H:
002105 E77B 02                      DB  MAX_SEC_SZ_H
                                
                                ;   FATバッファのアドレス
       E77C                     _FATBF:
002106 E77C 00E9                    DW  FATBF
                                
                                ;   データバッファのアドレス
       E77E                     _DTBUF:
002108 E77E 00EF                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       E780                     CTRLTB:
00210A E780 00000000ABD50000        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
002112 E788 0000000000000000        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
00211A E790 0000000000000000        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
002122 E798 0000000000000000        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
00212A E7A0 0000000000000000        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
002132 E7A8 0000000000000000        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
00213A E7B0 0000000000000000        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
002142 E7B8 0000000000000000        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
                                ;   2D/2DDでBPBがない場合のデフォルト値(2D/360KB/9セクタ1024バイト)
00214A E7C0 0200                M2D:    DW  2
00214C E7C2 FD02                    DB  0FDH,2
00214E E7C4 6401                    DW  356
002150 E7C6 FF0728090182            DB  0FFH,7,40,9,1,082H
002156 E7CC 0500A7000800            DW  5,0A7H,8
                                
                                ;   2HDでBPBがない場合のデフォルト値(2HD/1.23MB/8セクタ1024バイト)
00215C E7D2 0200                M2HD:   DW  2
00215E E7D4 FE01                    DB  0FEH,1
002160 E7D6 C704                    DW  1223
002162 E7D8 FE064D080184            DB  0FEH,6,77,8,1,084H
002168 E7DE 0500A7000900            DW  5,0A7H,9
                                
                                ;   ディレクトリエントリとFCBの変換テーブル(日付+時刻+サイズ)
00216E E7E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
002170 E7E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
002172 E7E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
002174 E7EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       E7EE                     SDDATAE:
                                
002178 E7EE                         DS  2
                                
                                ;   バッチファイルのFCB
       E7F0                     _FCB_BAT:
00217A E7F0 C7E5                    DW  FCB_BAT
       E7F2                     _PATH:
00217C E7F2 66E5                    DW  PATHD
                                
00217E E7F4                     SCDIR:  DS  2       ;+14 +15
002180 E7F6                     SFBPS:  DS  2       ;FBPS
002182 E7F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
002184 E7FA 0000                _FATPS: DW  0
002186 E7FC 0000                _DIRPS: DW  0
002188 E7FE 0000                _CLPS:  DW  0
                                
       E800                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "MSXDPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MSX
                                
       E800                     _DEVICE:
                                
                                ;   A:
                                
00218A E800 0300                    DW  3   ;DPB_FATLN
00218C E802 EBE6                    DW  _FDRD   ;DPB_DRD
00218E E804 EEE6                    DW  _FDWT   ;DPB_DWT
002190 E806 F9                      DB  0F9H    ;DPB_FATID
002191 E807 03                      DB  3   ;DPB_SECPCL
002192 E808 CB02                    DW  715 ;DPB_MAXCL
002194 E80A 00                      DB  0   ;DPB_FDMODE
002195 E80B 07                      DB  7   ;DPB_DIRSCNT
002196 E80C 01                      DB  1   ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002197 E80D 00                      DB  0   ;DPB_MAXSEC
002198 E80E 01                      DB  1   ;DPB_FATPS
002199 E80F 82                      DB  082H    ;DPB_BPS
00219A E810 0700                    DW  7   ;DPB_DIRPS
00219C E812 2E                      DB  02EH    ;DPB_DEVICE
00219D E813 00                      DB  0   ;DPB_UNITNO
00219E E814 0A00                    DW  10  ;DPB_ADDCL
0021A0 E816 0000                    DW  0   ;DPB_16
0021A2 E818 0000                    DW  0   ;DPB_18
0021A4 E81A 0000                    DW  0   ;DPB_SDIR
0021A6 E81C 524F4D30                DB  "ROM0"  ;DPB_NAME
                                
                                ;   B:
                                
0021AA E820 0300                    DW  3   ;DPB_FATLN
0021AC E822 EBE6                    DW  _FDRD   ;DPB_DRD
0021AE E824 EEE6                    DW  _FDWT   ;DPB_DWT
0021B0 E826 F9                      DB  0F9H    ;DPB_FATID
0021B1 E827 03                      DB  3   ;DPB_SECPCL
0021B2 E828 CB02                    DW  715 ;DPB_MAXCL
0021B4 E82A 00                      DB  0   ;DPB_FDMODE
0021B5 E82B 07                      DB  7   ;DPB_DIRSCNT
0021B6 E82C 2E                      DB  46  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
0021B7 E82D 00                      DB  0   ;DPB_MAXSEC
0021B8 E82E 01                      DB  1   ;DPB_FATPS
0021B9 E82F 82                      DB  082H    ;DPB_BPS
0021BA E830 0700                    DW  7   ;DPB_DIRPS
0021BC E832 2E                      DB  02EH    ;DPB_DEVICE
0021BD E833 01                      DB  1   ;DPB_UNITNO
0021BE E834 0A00                    DW  10  ;DPB_ADDCL
0021C0 E836 0000                    DW  0   ;DPB_16
0021C2 E838 0000                    DW  0   ;DPB_18
0021C4 E83A 0000                    DW  0   ;DPB_SDIR
0021C6 E83C 524F4D31                DB  "ROM1"  ;DPB_NAME
                                
                                ;   C:
                                
0021CA E840                         DS  32
                                
                                ;   D:
                                
0021EA E860                         DS  32
                                
                                ;   E:
                                
00220A E880 0300                    DW  3   ;DPB_FATLN
00220C E882 0DE5                    DW  PDRD    ;DPB_DRD
00220E E884 DFE4                    DW  PDWT    ;DPB_DWT
002210 E886 F9                      DB  0F9H    ;DPB_FATID
002211 E887 03                      DB  3   ;DPB_SECPCL
002212 E888 CB02                    DW  715 ;DPB_MAXCL
002214 E88A FF                      DB  0FFH    ;DPB_FDMODE
002215 E88B 07                      DB  7   ;DPB_DIRSCNT
002216 E88C 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002217 E88D 09                      DB  9   ;DPB_MAXSEC
002218 E88E 01                      DB  1   ;DPB_FATPS
002219 E88F 82                      DB  082H    ;DPB_BPS
00221A E890 0700                    DW  7   ;DPB_DIRPS
00221C E892 2D                      DB  02DH    ;DPB_DEVICE
00221D E893 00                      DB  0   ;DPB_UNITNO
00221E E894 0A00                    DW  10  ;DPB_ADDCL
002220 E896 0000                    DW  0   ;DPB_16
002222 E898 0000                    DW  0   ;DPB_18
002224 E89A 0000                    DW  0   ;DPB_SDIR
002226 E89C 44534B30                DB  "DSK0"  ;DPB_NAME
                                
                                ;   F:
                                
00222A E8A0 0300                    DW  3   ;DPB_FATLN
00222C E8A2 0DE5                    DW  PDRD    ;DPB_DRD
00222E E8A4 DFE4                    DW  PDWT    ;DPB_DWT
002230 E8A6 F9                      DB  0F9H    ;DPB_FATID
002231 E8A7 03                      DB  3   ;DPB_SECPCL
002232 E8A8 CB02                    DW  715 ;DPB_MAXCL
002234 E8AA FF                      DB  0FFH    ;DPB_FDMODE
002235 E8AB 07                      DB  7   ;DPB_DIRSCNT
002236 E8AC 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002237 E8AD 09                      DB  9   ;DPB_MAXSEC
002238 E8AE 01                      DB  1   ;DPB_FATPS
002239 E8AF 82                      DB  082H    ;DPB_BPS
00223A E8B0 0700                    DW  7   ;DPB_DIRPS
00223C E8B2 2D                      DB  02DH    ;DPB_DEVICE
00223D E8B3 01                      DB  1   ;DPB_UNITNO
00223E E8B4 0A00                    DW  10  ;DPB_ADDCL
002240 E8B6 0000                    DW  0   ;DPB_16
002242 E8B8 0000                    DW  0   ;DPB_18
002244 E8BA 0000                    DW  0   ;DPB_SDIR
002246 E8BC 44534B31                DB  "DSK1"  ;DPB_NAME
                                
                                ;   G:
                                
00224A E8C0 0300                    DW  3   ;DPB_FATLN
00224C E8C2 0DE5                    DW  PDRD    ;DPB_DRD
00224E E8C4 DFE4                    DW  PDWT    ;DPB_DWT
002250 E8C6 F9                      DB  0F9H    ;DPB_FATID
002251 E8C7 03                      DB  3   ;DPB_SECPCL
002252 E8C8 CB02                    DW  715 ;DPB_MAXCL
002254 E8CA FF                      DB  0FFH    ;DPB_FDMODE
002255 E8CB 07                      DB  7   ;DPB_DIRSCNT
002256 E8CC 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002257 E8CD 09                      DB  9   ;DPB_MAXSEC
002258 E8CE 01                      DB  1   ;DPB_FATPS
002259 E8CF 82                      DB  082H    ;DPB_BPS
00225A E8D0 0700                    DW  7   ;DPB_DIRPS
00225C E8D2 2D                      DB  02DH    ;DPB_DEVICE
00225D E8D3 02                      DB  2   ;DPB_UNITNO
00225E E8D4 0A00                    DW  10  ;DPB_ADDCL
002260 E8D6 0000                    DW  0   ;DPB_16
002262 E8D8 0000                    DW  0   ;DPB_18
002264 E8DA 0000                    DW  0   ;DPB_SDIR
002266 E8DC 44534B32                DB  "DSK2"  ;DPB_NAME
                                
                                ;   H:
00226A E8E0 0300                    DW  3   ;DPB_FATLN
00226C E8E2 0DE5                    DW  PDRD    ;DPB_DRD
00226E E8E4 DFE4                    DW  PDWT    ;DPB_DWT
002270 E8E6 F9                      DB  0F9H    ;DPB_FATID
002271 E8E7 03                      DB  3   ;DPB_SECPCL
002272 E8E8 CB02                    DW  715 ;DPB_MAXCL
002274 E8EA FF                      DB  0FFH    ;DPB_FDMODE
002275 E8EB 07                      DB  7   ;DPB_DIRSCNT
002276 E8EC 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002277 E8ED 09                      DB  9   ;DPB_MAXSEC
002278 E8EE 01                      DB  1   ;DPB_FATPS
002279 E8EF 82                      DB  082H    ;DPB_BPS
00227A E8F0 0700                    DW  7   ;DPB_DIRPS
00227C E8F2 2D                      DB  02DH    ;DPB_DEVICE
00227D E8F3 07                      DB  7   ;DPB_UNITNO
00227E E8F4 0A00                    DW  10  ;DPB_ADDCL
002280 E8F6 0000                    DW  0   ;DPB_16
002282 E8F8 0000                    DW  0   ;DPB_18
002284 E8FA 0000                    DW  0   ;DPB_SDIR
002286 E8FC 44534B37                DB  "DSK7"  ;DPB_NAME
       E900                     MSX_E:
[EOF:MSXDPB.ASM:UTF_8]
                                
00228A E900                         DS  03FFFH - $$
003FFF 0675 00                      DB  0
       0676                     LAST_ADR:
                                
                                    END
[EOF:MSX.ASM:UTF_8]
