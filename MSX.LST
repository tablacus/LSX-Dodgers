                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "MSXDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       0003                     MAC EQU 3   ;MSX
       0001                     DEV EQU 1
                                
       001D                     VER_6F  EQU 0001DH
                                
       4000                     RUN EQU 04000H
                                
       C700                     START2  EQU 0C700H
       CA06                     BDOS    EQU 0CA06H
       E500                     WORKAD  EQU 0E500H
       E800                     FATBF   EQU 0E800H
       EE00                     DTBUF   EQU 0EE00H
       0028                     WIDTH   EQU 40
       0019                     LINE    EQU 25
       0000                     COLORF  EQU 0
       0000                     KEYSP_H EQU 0
       0000                     KEYSP_L EQU 0
       0008                     COMS    EQU 8
       0002                     MAX_SEC_SZ_H    EQU 2       ;1セクタ1024バイトのサポート(2:off 4:on)
       8000                     BUFFER  EQU 08000H
       0100                     BUF_COM EQU 00100H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
                                
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       006C                     INITXT  EQU 0006CH
       0078                     SETTXT  EQU 00078H
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00AE                     PINLIN  EQU 000AEH
       00B1                     INLIN   EQU 000B1H
       00B4                     QINLIN  EQU 000B4H
       00B7                     BREAKX  EQU 000B7H
       00C0                     BEEP    EQU 000C0H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0144                     PHYDIO  EQU 00144H  ;MAIN:BIOS:
       0156                     KILBUF  EQU 00156H
                                
       01F5                     REDCLK  EQU 001F5H  ;SUB
       01F9                     WRTCLK  EQU 001F9H  ;SUB
                                
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
                                
       FEDA                     H_STKE  EQU 0FEDAH
       FFA7                     H_PHYD  EQU 0FFA7H
                                
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU 06000H
       6800                     BANK1_SEL EQU 06800H
       7000                     BANK2_SEL EQU 07000H
       7800                     BANK3_SEL EQU 07800H
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       8000                     KONAMI_BANK2_SEL EQU 08000H
       A000                     KONAMI_BANK3_SEL EQU 0A000H
[EOF:MSXDEF.ASM:UTF_8]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0001                     VER_3   EQU 1
       1D03                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0103                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0161                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 1942                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
                                    INCLUDE "MSXFDIPL.ASM"
                                ;   LSX-Dodgers FDIPL
                                ;   MSX
000010 4010 186E            12      JR  INIT_FDD_BOOT
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
       4080                     INIT_FDD_BOOT:
000080 4080 F3               4      DI
000081 4081 ED56             8      IM  1
000083 4083 3A42F3          13      LD  A,(RAMAD1)
000086 4086 2640             7      LD  H,040H
000088 4088 CD2400          17      CALL    _ENASLT
00008B 408B 218A82          10      LD  HL,AT_START2+04000H
00008E 408E 1100C7          10      LD  DE,START2
000091 4091 010021          10      LD  BC,MSX_E-START2
000094 4094 EDB0                    LDIR
000096 4096 2180E7          10      LD  HL,_DEVICE+4*32     ;E
000099 4099 1100E7          10      LD  DE,_DEVICE      ;A
00009C 409C 018000          10      LD  BC,32*4
00009F 409F EDB0                    LDIR
0000A1 40A1 21DFE7          10      LD  HL,_DEVICE+6*32+DPB_NAME+3
0000A4 40A4 3E07             7      LD  A,7
       40A6                     FDD_INIT1:
0000A6 40A6 C62F             7      ADD A,'0'-1
0000A8 40A8 77               7      LD  (HL),A
0000A9 40A9 11F4FF          10      LD  DE,DPB_UNITNO-(DPB_NAME+3)
0000AC 40AC 19              11      ADD HL,DE
0000AD 40AD D630             7      SUB '0'
0000AF 40AF 77               7      LD  (HL),A
0000B0 40B0 11ECFF          10      LD  DE,-DPB_UNITNO-1
0000B3 40B3 19              11      ADD HL,DE       ;ここでZフラグは変化しない
0000B4 40B4 20F0            12      JR  NZ,FDD_INIT1
0000B6 40B6 218040          10      LD  HL,INIT_FDD_BOOT
                                
0000B9 40B9 CD11C8          17      CALL    SET_BDOS
0000BC 40BC 21E9C7          10      LD  HL,ROMCHECKED
0000BF 40BF 2204C7          16      LD  (INIT_SWC),HL
0000C2 40C2 C300C7          10      JP  START2
[EOF:MSXFDIPL.ASM:UTF_8]
                                
0001BD 41BD                         ORG 041BDH
0001BD 41BD C9              10      RET
                                
                                    ;MBR_Partition1 (2DDのデータ)
0001BE 41BE 00                      DB  0       ;ブートフラグ
0001BF 41BF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001C2 41C2 01                      DB  1       ;識別子(FAT12)
0001C3 41C3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001C6 41C6 20000000                DW  32,0        ;パーティションの最初のセクタ番号(LBA方式)
0001CA 41CA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
                                    ;MBR_Partition2 (2DDのデータ)
0001CE 41CE 00                      DB  0       ;ブートフラグ
0001CF 41CF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001D2 41D2 01                      DB  1       ;識別子(FAT12)
0001D3 41D3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001D6 41D6 C0050000                DW  32+1440,0   ;パーティションの最初のセクタ番号(LBA方式)
0001DA 41DA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
0001FE 41FE                         ORG 041FEH
0001FE 41FE 55AA                    DB  055H,0AAH   ;MBR_Sig
                                
                                    INCLUDE "MSXINIT.ASM"
                                ;   LSX-Dodgers INIT
                                ;   MSX
       4200                     START:
000200 4200 F3               4      DI
000201 4201 ED56             8      IM  1
000203 4203 AF               4      XOR A               ;A=0
000204 4204 320060          13      LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
000207 4207 3C               4      INC A               ;A=1
000208 4208 320068          13      LD  (BANK1_SEL),A
00020B 420B 218A42          10      LD  HL,AT_START2
00020E 420E 1100C7          10      LD  DE,START2
000211 4211 010021          10      LD  BC,MSX_E-START2
000214 4214 EDB0                    LDIR
000216 4216 C300C7          10      JP  START2
                                
       4219                     INIT_ROM:
000219 4219 3E                      DB  03EH    ;LD A,??
00021A 421A F7              12      RST 30H
00021B 421B F3               4      DI
00021C 421C 32DAFE          13      LD  (H_STKE),A
00021F 421F CD6642          17      CALL    GTSL1_
000222 4222 21DBFE          10      LD  HL,H_STKE+1
000225 4225 77               7      LD  (HL),A
000226 4226 110042          10      LD  DE,START
000229 4229 23               6      INC HL
00022A 422A 73               7      LD  (HL),E
00022B 422B 23               6      INC HL
00022C 422C 72               7      LD  (HL),D
                                
00022D 422D CD3801          17      CALL    RSLREG      ;read primary slot #
000230 4230 07               4      RLCA
000231 4231 07               4      RLCA
000232 4232 F5              11      PUSH    AF
000233 4233 1605             7      LD  D,4+1
000235 4235 CD6D42          17      CALL    GTSL2_
000238 4238 3244F3          13      LD  (RAMAD3),A
00023B 423B 3A42F3          13      LD  A,(RAMAD1)
00023E 423E CD5842          17      CALL    FIXRAMAD
000241 4241 3242F3          13      LD  (RAMAD1),A
000244 4244 3A41F3          13      LD  A,(RAMAD0)
000247 4247 CD5842          17      CALL    FIXRAMAD
00024A 424A 3241F3          13      LD  (RAMAD0),A
00024D 424D F1              10      POP AF
00024E 424E 1603             7      LD  D,2+1
000250 4250 CD6D42          17      CALL    GTSL2_
000253 4253 3243F3          13      LD  (RAMAD2),A
                                
000256 4256 FB               4      EI
000257 4257 C9              10      RET
                                
       4258                     FIXRAMAD:
000258 4258 B7               4      OR  A
000259 4259 2807            12      JR  Z,FIXRAMAD1
00025B 425B FEC9             7      CP  0C9H
00025D 425D 2803            12      JR  Z,FIXRAMAD1
00025F 425F FEFF             7      CP  0FFH
000261 4261 C0              11      RET NZ
       4262                     FIXRAMAD1:
000262 4262 3A44F3          13      LD  A,(RAMAD3)
000265 4265 C9              10      RET
                                
       4266                     GTSL1_:             ;自分のいるスロットを知る
000266 4266 CD3801          17      CALL    RSLREG      ;read primary slot #
000269 4269 0F               4      RRCA
00026A 426A 0F               4      RRCA
00026B 426B 1601             7      LD  D,1
       426D                     GTSL2_:
00026D 426D E603             7      AND 3       ;[A]=000000PP
00026F 426F 5F               4      LD  E,A     ;[E]=000000PP
000270 4270 21C1FC          10      LD  HL,EXPTBL
000273 4273 85               4      ADD A,L     ;桁上りは無い
000274 4274 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000275 4275 7B               4      LD  A,E     ;[A]=000000PP
000276 4276 CB7E            13      BIT 7,(HL)
000278 4278 C8              11      RET Z
000279 4279 7D               4      LD  A,L     ;point to SLTTBL entry
00027A 427A C604             7      ADD A,4     ;桁上りは無い
00027C 427C 6F               4      LD  L,A
00027D 427D 7E               7      LD  A,(HL)      ;get currently expansion slot register
       427E                     GTSL3_:
00027E 427E 15               4      DEC D
00027F 427F 2803            12      JR  Z,GTSL4_:
000281 4281 0F               4      RRCA
000282 4282 18FA            12      JR  GTSL3_:
       4284                     GTSL4_:
000284 4284 E60C             7      AND 00CH        ;[A] = 0000SS00
000286 4286 B3               4      OR  E       ;[A] = 0000SSPP
000287 4287 F680             7      OR  080H        ;[A] = 1000SSPP
000289 4289 C9              10      RET
                                
       428A                     AT_START2:
00028A C700                         ORG START2,AT_START2-RUN
                                
00028A C700 3100C7          10      LD  SP,START2
00028D C703 CD11C7          17      CALL    INIT        ;NZならAUTOEXECを実行
       C704                     INIT_SWC    EQU $-2
000290 C706 210000          10      LD  HL,0
000293 C709 E5              11      PUSH    HL
000294 C70A C8              11      RET Z
000295 C70B 1106C9          10      LD  DE,AUTOD
000298 C70E C3FDE5          10      JP  _COMANL
                                
       C711                     INIT:
00029B C711 DD21900D        14      LD  IX,0D90H
00029F C715 0600             7      LD  B,0
       C717                     CHECK_CBIOS1:
0002A1 C717 DD7E00          19      LD  A,(IX+0)
0002A4 C71A FE43             7      CP  'C'
0002A6 C71C 202B            12      JR  NZ,CHECK_CBIOS2
0002A8 C71E DD7E01          19      LD  A,(IX+1)
0002AB C721 FE2D             7      CP  '-'
0002AD C723 2024            12      JR  NZ,CHECK_CBIOS2
0002AF C725 DD7E02          19      LD  A,(IX+2)
0002B2 C728 FE42             7      CP  'B'
0002B4 C72A 201D            12      JR  NZ,CHECK_CBIOS2
0002B6 C72C DD7E03          19      LD  A,(IX+3)
0002B9 C72F FE49             7      CP  'I'
0002BB C731 2016            12      JR  NZ,CHECK_CBIOS2
0002BD C733 DD7E04          19      LD  A,(IX+4)
0002C0 C736 FE4F             7      CP  'O'
0002C2 C738 200F            12      JR  NZ,CHECK_CBIOS2
0002C4 C73A DD7E05          19      LD  A,(IX+5)
0002C7 C73D EE53             7      XOR 'S'
0002C9 C73F 2008            12      JR  NZ,CHECK_CBIOS2
                                
0002CB C741 3293D1          13      LD  (CBIOS_SWC1),A
0002CE C744 32B7D1          13      LD  (CBIOS_SWC2),A
                                
0002D1 C747 1804            12      JR  CHECK_CBIOS3
       C749                     CHECK_CBIOS2:
0002D3 C749 DD23            10      INC IX
0002D5 C74B 10CA            13      DJNZ    CHECK_CBIOS1
       C74D                     CHECK_CBIOS3:
0002D7 C74D 3ADBFE          13      LD  A,(H_STKE+1)
0002DA C750 3262E5          13      LD  (ROM_SLT),A
                                
       C753                     RAMCHK2:
0002DD C753 3A42F3          13      LD  A,(RAMAD1)
0002E0 C756 2640             7      LD  H,040H
0002E2 C758 CD6AC8          17      CALL    CHK_RAM
0002E5 C75B 3242F3          13      LD  (RAMAD1),A
       C75E                     RAMCHK1:
0002E8 C75E 3A41F3          13      LD  A,(RAMAD0)
0002EB C761 2600             7      LD  H,00H
0002ED C763 CD6AC8          17      CALL    CHK_RAM
0002F0 C766 3241F3          13      LD  (RAMAD0),A
       C769                     RAMCHK0:
0002F3 C769 3A42F3          13      LD  A,(RAMAD1)
0002F6 C76C 2640             7      LD  H,040H
0002F8 C76E CDE2D4          17      CALL    ENASLT
                                
0002FB C771 3A41F3          13      LD  A,(RAMAD0)
0002FE C774 2600             7      LD  H,000H
000300 C776 CDE2D4          17      CALL    ENASLT
                                
000303 C779 210000          10      LD  HL,0
000306 C77C 065C             7      LD  B,05CH
000308 C77E 3E                      DB  03EH    ;LD A,??
000309 C77F EF              12      RST 28H
00030A C780 CD7BD6          17      CALL    FILL_MEMORY
00030D C783 06A4             7      LD  B,0A4H
00030F C785 AF               4      XOR A
000310 C786 320400          13      LD  (_DVSW),A
000313 C789 CD7BD6          17      CALL    FILL_MEMORY
                                
000316 C78C CD11C8          17      CALL    SET_BDOS
                                
                                                ;LSX-Dodgers
000319 C78F 3EE5             7      LD  A,CPM_BOOT/256
00031B C791 320B00          13      LD  (0000BH),A
                                
                                                ;MSXワークエリア
00031E C794 3E03             7      LD  A,3
000320 C796 329BFC          13      LD  (INTFLG),A
                                
                                                ;ROMタイプ判別(ASCII-8K/ASCII-16K)
000323 C799 1E00             7      LD  E,0
000325 C79B 3A62E5          13      LD  A,(ROM_SLT)
000328 C79E 210068          10      LD  HL,BANK1_SEL
00032B C7A1 CD6FD4          17      CALL    WRSLT
                                
00032E C7A4 210060          10      LD  HL,06000H
000331 C7A7 3A62E5          13      LD  A,(ROM_SLT)
000334 C7AA CD2ED4          17      CALL    RDSLT
000337 C7AD FE41             7      CP  'A'
000339 C7AF 280F            12      JR  Z,ROM8K
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K)
00033B C7B1 3E                      DB  03EH    ;LD A,??
00033C C7B2 00               4      NOP
00033D C7B3 3247E3          13      LD  (ASCII16K1),A
000340 C7B6 324BE3          13      LD  (ASCII16K2),A
000343 C7B9 3E3F             7      LD  A,03FH
000345 C7BB 3263E3          13      LD  (ASCII16K3),A
000348 C7BE 1829            12      JR  ROMCHECKED
       C7C0                     ROM8K:              ;Konami-8Kチェック
00034A C7C0 1E01             7      LD  E,1
00034C C7C2 3A62E5          13      LD  A,(ROM_SLT)
00034F C7C5 210070          10      LD  HL,BANK2_SEL
000352 C7C8 CD6FD4          17      CALL    WRSLT
                                
000355 C7CB 1E00             7      LD  E,0
000357 C7CD 3A62E5          13      LD  A,(ROM_SLT)
00035A C7D0 210080          10      LD  HL,KONAMI_BANK2_SEL
00035D C7D3 CD6FD4          17      CALL    WRSLT
                                
000360 C7D6 210080          10      LD  HL,08000H
000363 C7D9 3A62E5          13      LD  A,(ROM_SLT)
000366 C7DC CD2ED4          17      CALL    RDSLT
000369 C7DF FE41             7      CP  'A'
00036B C7E1 2006            12      JR  NZ,ROMCHECKED
                                                ;Konami-8K
00036D C7E3 210080          10      LD  HL,KONAMI_BANK2_SEL
000370 C7E6 2252E3          16      LD  (ROM8000H),HL
       C7E9                     ROMCHECKED:
                                                ;MSX2判別
000373 C7E9 3AF8FA          13      LD  A,(EXBRSA)
000376 C7EC B7               4      OR  A
000377 C7ED 3E28             7      LD  A,40
000379 C7EF 2802            12      JR  Z,ISMSX1
00037B C7F1 3E50             7      LD  A,80        ;MSX2以降は80桁で起動
       C7F3                     ISMSX1:
00037D C7F3 32AEF3          13      LD  (LINL40),A
000380 C7F6 32B1E5          13      LD  (_WIDTH),A
000383 C7F9 DD216C00        14      LD  IX,INITXT
000387 C7FD CD88D3          17      CALL    CALSLT_R
00038A C800 DD217800        14      LD  IX,SETTXT
00038E C804 CD88D3          17      CALL    CALSLT_R
                                
000391 C807 2112C9          10      LD  HL,INIMES
000394 C80A CD82CE          17      CALL    MSX
       C80D                     INIT1:
000397 C80D AF               4      XOR A
000398 C80E FE03             7      CP  3
00039A C810 C9              10      RET
       C811                     SET_BDOS:
00039B C811 3E                      DB  03EH    ;LD A,??
00039C C812 E9               4      JP  (HL)
00039D C813 320F00          13      LD  (0000FH),A
                                
0003A0 C816 3EC3             7      LD  A,0C3H      ;JP
0003A2 C818 2103E5          10      LD  HL,CPM_WBOOT
0003A5 C81B 320000          13      LD  (00000H),A
0003A8 C81E 220100          16      LD  (00001H),HL ;IPL
                                
0003AB C821 2106CA          10      LD  HL,BDOS
0003AE C824 320500          13      LD  (00005H),A
0003B1 C827 220600          16      LD  (00006H),HL ;BDOS
                                
0003B4 C82A 210000          10      LD  HL,0
0003B7 C82D 322800          13      LD  (00028H),A
0003BA C830 222900          16      LD  (00029H),HL ;BDOS
                                                ;インタースロットコール
0003BD C833 21E2D3          10      LD  HL,RDSLTR
0003C0 C836 320C00          13      LD  (_RDSLT),A
0003C3 C839 220D00          16      LD  (_RDSLT+1),HL
                                
0003C6 C83C 21EBD3          10      LD  HL,WRSLTR
0003C9 C83F 321400          13      LD  (_WRSLT),A
0003CC C842 221500          16      LD  (_WRSLT+1),HL
                                
0003CF C845 21A4D3          10      LD  HL,CALSLTR
0003D2 C848 321C00          13      LD  (_CALSLT),A
0003D5 C84B 221D00          16      LD  (_CALSLT+1),HL
                                
0003D8 C84E 21E2D4          10      LD  HL,ENASLT
0003DB C851 322400          13      LD  (_ENASLT),A
0003DE C854 222500          16      LD  (_ENASLT+1),HL
                                
0003E1 C857 2194D3          10      LD  HL,CALLF
0003E4 C85A 323000          13      LD  (_CALLF),A
0003E7 C85D 223100          16      LD  (_CALLF+1),HL
                                
0003EA C860 21F4D3          10      LD  HL,INT38H
0003ED C863 323800          13      LD  (00038H),A
0003F0 C866 223900          16      LD  (00038H+1),HL
0003F3 C869 C9              10      RET
       C86A                     CHK_RAM:
0003F4 C86A E5              11      PUSH    HL
0003F5 C86B CDBFC8          17      CALL    CHK_RAM0
0003F8 C86E E1              10      POP HL
0003F9 C86F C8              11      RET Z
0003FA C870 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
0003FD C873 E680             7      AND 080H
0003FF C875 CD96C8          17      CALL    CHK_RAM_SLT
000402 C878 C8              11      RET Z
000403 C879 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
000406 C87C E680             7      AND 080H
000408 C87E C601             7      ADD A,1
00040A C880 CD96C8          17      CALL    CHK_RAM_SLT
00040D C883 C8              11      RET Z
00040E C884 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000411 C887 E680             7      AND 080H
000413 C889 C602             7      ADD A,2
000415 C88B CD96C8          17      CALL    CHK_RAM_SLT
000418 C88E C8              11      RET Z
000419 C88F 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
00041C C892 E680             7      AND 080H
00041E C894 C603             7      ADD A,3
       C896                     CHK_RAM_SLT:
000420 C896 E5              11      PUSH    HL
000421 C897 CDBFC8          17      CALL    CHK_RAM0        ;スロット#X or X-0
000424 C89A E1              10      POP HL
000425 C89B C8              11      RET Z
000426 C89C CB79             8      BIT 7,C
000428 C89E 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
00042A C8A0 79               4      LD  A,C
00042B C8A1 C604             7      ADD A,4*1           ;スロット#X-1
00042D C8A3 E5              11      PUSH    HL
00042E C8A4 CDBFC8          17      CALL    CHK_RAM0
000431 C8A7 E1              10      POP HL
000432 C8A8 C8              11      RET Z
000433 C8A9 79               4      LD  A,C
000434 C8AA C608             7      ADD A,4*2           ;スロット#X-2
000436 C8AC E5              11      PUSH    HL
000437 C8AD CDBFC8          17      CALL    CHK_RAM0
00043A C8B0 E1              10      POP HL
00043B C8B1 C8              11      RET Z
00043C C8B2 79               4      LD  A,C
00043D C8B3 C60C             7      ADD A,4*3           ;スロット#X-3
00043F C8B5 E5              11      PUSH    HL
000440 C8B6 CDBFC8          17      CALL    CHK_RAM0
000443 C8B9 E1              10      POP HL
       C8BA                     CHK_RAM_E:
000444 C8BA AF               4      XOR A
000445 C8BB 3C               4      INC A           ;ZF=0にする
000446 C8BC 3E00             7      LD  A,0
000448 C8BE C9              10      RET
                                
       C8BF                     CHK_RAM0:
000449 C8BF 4F               4      LD  C,A
00044A C8C0 3A62E5          13      LD  A,(ROM_SLT)
00044D C8C3 B9               4      CP  C
00044E C8C4 28F4            12      JR  Z,CHK_RAM_E
000450 C8C6 2E00             7      LD  L,0
       C8C8                     CHK_RAM1:
000452 C8C8 79               4      LD  A,C
000453 C8C9 DD210C00        14      LD  IX,_RDSLT
000457 C8CD CDFAC8          17      CALL    CALSLT_RAM
00045A C8D0 C6E5             7      ADD A,0E5H
00045C C8D2 47               4      LD  B,A
00045D C8D3 5F               4      LD  E,A
00045E C8D4 79               4      LD  A,C
00045F C8D5 DD211400        14      LD  IX,_WRSLT
000463 C8D9 CDFAC8          17      CALL    CALSLT_RAM
000466 C8DC 79               4      LD  A,C
000467 C8DD DD210C00        14      LD  IX,_RDSLT
00046B C8E1 CDFAC8          17      CALL    CALSLT_RAM
00046E C8E4 B8               4      CP  B
00046F C8E5 C0              11      RET NZ
000470 C8E6 D6E5             7      SUB 0E5H
000472 C8E8 79               4      LD  A,C
000473 C8E9 5F               4      LD  E,A
000474 C8EA DD211400        14      LD  IX,_WRSLT
000478 C8EE CDFAC8          17      CALL    CALSLT_RAM
00047B C8F1 24               4      INC H
00047C C8F2 7D               4      LD  A,L
00047D C8F3 C604             7      ADD A,4
00047F C8F5 6F               4      LD  L,A
000480 C8F6 20D0            12      JR  NZ,CHK_RAM1
000482 C8F8 79               4      LD  A,C     ;ZF=1のハズ
000483 C8F9 C9              10      RET
                                
       C8FA                     CALSLT_RAM:
000484 C8FA C5              11      PUSH    BC
000485 C8FB E5              11      PUSH    HL
000486 C8FC FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
00048A C900 CD1C00          17      CALL    _CALSLT
00048D C903 E1              10      POP HL
00048E C904 C1              10      POP BC
00048F C905 C9              10      RET
                                
000490 C906 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000499 C90F 413A00              AUTODV: DB  "A:",0
                                
00049C C912 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MSX v"
            6765727320666F72    
            204D53582076        
0004B2 C928 312E                    DB  030H + VER_1, '.'
0004B4 C92A 3631                    DB  030H + VER_2 ,030H + VER_3
0004B6 C92C 68                      DB  'h'
0004B7 C92D 2047616B750D0A          DB  " Gaku",0DH,0AH
0004BE C934 00                      DB  0
                                
0004BF C935 0300                M2DD:   DW  3
0004C1 C937 F902                    DB  0F9H,2
0004C3 C939 CB02                    DW  715
0004C5 C93B FF0750090182            DB  0FFH,7,80,9,1,082H
0004CB C941 0700A7000A00            DW  7,0A7H,10
       C947                     M2DDE:
[EOF:MSXINIT.ASM:SHIFT_JIS]
                                    INCLUDE "MSXCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MSX
                                
       C947                     INITE:
0004D1 C947                         DS  BDOS-INITE
000590 CA06 C342CE          10      JP  BDOS0
       CA09                     S27BUF_COM:
000593 CA09 110001          10      LD  DE,BUF_COM
000596 CA0C CD46D0          17      CALL    _SYS1A      ;(BDOS)DTAの設定
000599 CA0F 2100FE          10      LD  HL,0-BUF_COM-00100H ;バッファー+スタック予備(0100H)
00059C CA12 C3E7CA          10      JP  S27BUF2
       CA15                     WBOOT1:
00059F CA15 ED7B0600        20      LD  SP,(SYSTEM+1)
0005A3 CA19 3E03             7      LD  A,3
0005A5 CA1B CD15D1          17      CALL    MSG_A
       CA1E                     WBOOT2:
[EOF:MSXCCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       CA1E                     COMMAND:
0005A8 CA1E 3AA1E4          13      LD  A,(FCB_BAT)
0005AB CA21 B7               4      OR  A
0005AC CA22 C260CB          10      JP  NZ,C_BAT1
0005AF CA25 CDD4CA          17      CALL    SETDTA1
0005B2 CA28 3A0400          13      LD  A,(_DVSW)
0005B5 CA2B C641             7      ADD A,'A'
0005B7 CA2D CD15D1          17      CALL    MSG_A
0005BA CA30 3E3E             7      LD  A,'>'
0005BC CA32 CD15D1          17      CALL    MSG_A
0005BF CA35 3E50             7      LD  A,80
0005C1 CA37 12               7      LD  (DE),A
0005C2 CA38 CDD5D1          17      CALL    _SYS0A      ;(BDOS)文字列入力
0005C5 CA3B CD55CC          17      CALL    LTNL
       CA3E                     COMMAND2:
0005C8 CA3E 118200          10      LD  DE,DTA1+2
0005CB CA41 CDFDE5          17      CALL    _COMANL
0005CE CA44 DC06D1          17      CALL    C,SHOW_ERROR
0005D1 CA47 18D5            12      JR  COMMAND
                                
       CA49                     COMANL:
0005D3 CA49 CDD0D5          17      CALL    FILE
0005D6 CA4C 3A19E5          13      LD  A,(FNAME+4)
0005D9 CA4F FE20             7      CP  020H
0005DB CA51 201C            12      JR  NZ,COMB2
0005DD CA53 D5              11      PUSH    DE
0005DE CA54 1115E5          10      LD  DE,FNAME
0005E1 CA57 1A               7      LD  A,(DE)
0005E2 CA58 FE20             7      CP  020H
0005E4 CA5A 2844            12      JR  Z,SDVSW
0005E6 CA5C 1B               6      DEC DE
0005E7 CA5D 1A               7      LD  A,(DE)
0005E8 CA5E C6FF             7      ADD A,0FFH
0005EA CA60 3809            12      JR  C,COMB
0005EC CA62 13               6      INC DE
                                
0005ED CA63 2112CE          10      LD  HL,COMTB
0005F0 CA66 0608             7      LD  B,COMS
0005F2 CA68 CD5DD8          17      CALL    CPNAME
       CA6B                     COMB:
0005F5 CA6B D1              10      POP DE
0005F6 CA6C D205D1          10      JP  NC,JPHL
       CA6F                     COMB2:
0005F9 CA6F EB               4      EX  DE,HL
0005FA CA70 223DCB          16      LD  (COMSWC),HL
0005FD CA73 F5              11      PUSH    AF
0005FE CA74 CDF5CA          17      CALL    CEXE4
000601 CA77 F1              10      POP AF
000602 CA78 2115E5          10      LD  HL,FNAME
000605 CA7B 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
000608 CA7E 010B00          10      LD  BC,11
00060B CA81 EDB0                    LDIR
00060D CA83 1140E4          10      LD  DE,PATHD
       CA86                     CEX1:
000610 CA86 1A               7      LD  A,(DE)
000611 CA87 FE20             7      CP  020H
000613 CA89 D8              11      RET C
000614 CA8A CDC5D5          17      CALL    FILEC
000617 CA8D D5              11      PUSH    DE
000618 CA8E 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
00061B CA91 1115E5          10      LD  DE,FNAME
00061E CA94 010B00          10      LD  BC,11
000621 CA97 EDB0                    LDIR
000623 CA99 CDF5CA          17      CALL    CEXE4
000626 CA9C D1              10      POP DE
000627 CA9D 13               6      INC DE
000628 CA9E 18E6            12      JR  CEX1
                                
       CAA0                     SDVSW:
00062A CAA0 F1              10      POP AF
00062B CAA1 3A14E5          13      LD  A,(FDRV)
00062E CAA4 3D               4      DEC A
00062F CAA5 5F               4      LD  E,A
000630 CAA6 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
000632 CAA8 1831            12      JR  SYSTEM0
                                
       CAAA                     OPEN1:
000634 CAAA 2114E5          10      LD  HL,FDRV
       CAAD                     OPEN:
000637 CAAD 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       CAAF                     OPEN3:
000639 CAAF D5              11      PUSH    DE
00063A CAB0 117CE4          10      LD  DE,DTA_CCP
00063D CAB3 CDD1CA          17      CALL    SETDTA
000640 CAB6 EB               4      EX  DE,HL
000641 CAB7 CDDBCA          17      CALL    SYSTEM0
000644 CABA D1              10      POP DE
000645 CABB C9              10      RET
                                
       CABC                     OPEN2:
000646 CABC 0E12             7      LD  C,012H
000648 CABE 18EF            12      JR  OPEN3
                                
       CAC0                     DEFCB:              ;Z=Ok NZ=Error
00064A CAC0 117CE4          10      LD  DE,DTA_CCP
00064D CAC3 CDD9CA          17      CALL    SYSC0F
                                
000650 CAC6 119DE4          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
000653 CAC9 0604             7      LD  B,4
000655 CACB CD26CD          17      CALL    ZERO_MEMORY_DE
       CACE                     SETDTA100:
000658 CACE 110080          10      LD  DE,BUFFER
       CAD1                     SETDTA:
00065B CAD1 C346D0          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       CAD4                     SETDTA1:
00065E CAD4 118000          10      LD  DE,DTA1
000661 CAD7 18F8            12      JR  SETDTA
                                
       CAD9                     SYSC0F:
000663 CAD9 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       CADB                     SYSTEM0:
000665 CADB CD0500          17      CALL    SYSTEM
000668 CADE B7               4      OR  A
000669 CADF C9              10      RET
                                
       CAE0                     C_CD:
00066A CAE0 0E5A             7      LD  C,05AH
00066C CAE2 18F7            12      JR  SYSTEM0
                                
       CAE4                     S27BUF:
00066E CAE4 21007F          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       CAE7                     S27BUF2:
000671 CAE7 39              11      ADD HL,SP
000672 CAE8 2E00             7      LD  L,0
000674 CAEA 7C               4      LD  A,H
000675 CAEB E6F8             7      AND 0F8H
000677 CAED 67               4      LD  H,A
       CAEE                     S27DTA:
000678 CAEE 117CE4          10      LD  DE,DTA_CCP
       CAF1                     S27:
00067B CAF1 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
00067D CAF3 18E6            12      JR  SYSTEM0
                                
       CAF5                     CEXE4:
00067F CAF5 211DE5          10      LD  HL,FNAME+8
000682 CAF8 7E               7      LD  A,(HL)
000683 CAF9 FE20             7      CP  020H
000685 CAFB 2007            12      JR  NZ,CEXE7
000687 CAFD 3E3F             7      LD  A,'?'
000689 CAFF 77               7      LD  (HL),A
00068A CB00 23               6      INC HL
00068B CB01 77               7      LD  (HL),A
00068C CB02 23               6      INC HL
00068D CB03 77               7      LD  (HL),A
       CB04                     CEXE7:
00068E CB04 CDAACA          17      CALL    OPEN1
       CB07                     CEXE5:
000691 CB07 C0              11      RET NZ
000692 CB08 2A86E4          16      LD  HL,(DTA_CCP+1+9)
000695 CB0B 7C               4      LD  A,H
000696 CB0C CDECD8          17      CALL    CAP
000699 CB0F 67               4      LD  H,A
00069A CB10 7D               4      LD  A,L
00069B CB11 CDECD8          17      CALL    CAP
00069E CB14 6F               4      LD  L,A
00069F CB15 3A85E4          13      LD  A,(DTA_CCP+1+8)
0006A2 CB18 CDECD8          17      CALL    CAP
0006A5 CB1B D642             7      SUB 'B'
0006A7 CB1D 282C            12      JR  Z,C_BAT
0006A9 CB1F 3D               4      DEC A       ;'C'
0006AA CB20 2805            12      JR  Z,C_EXE
       CB22                     CEXE6:
0006AC CB22 CDBCCA          17      CALL    OPEN2
0006AF CB25 18E0            12      JR  CEXE5
                                
       CB27                     C_EXE:
0006B1 CB27 7C               4      LD  A,H
0006B2 CB28 FE4D             7      CP  'M'
0006B4 CB2A 20F6            12      JR  NZ,CEXE6
                                
0006B6 CB2C CDC0CA          17      CALL    DEFCB
0006B9 CB2F CD09CA          17      CALL    S27BUF_COM
0006BC CB32 3D               4      DEC A
0006BD CB33 37               4      SCF
0006BE CB34 C0              11      RET NZ
0006BF CB35 7C               4      LD  A,H
0006C0 CB36 B5               4      OR  L
0006C1 CB37 37               4      SCF
0006C2 CB38 C8              11      RET Z
0006C3 CB39 CDD4CA          17      CALL    SETDTA1
0006C6 CB3C 110000          10      LD  DE,0                ; self-modifying code
       CB3D                     COMSWC  EQU $-2
0006C9 CB3F ED7B0600        20      LD  SP,(SYSTEM+1)
0006CD CB43 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
0006CE CB44 6F               4      LD  L,A
0006CF CB45 E5              11      PUSH    HL              ; push $0000 (reboot address)
0006D0 CB46 24               4      INC H
0006D1 CB47 E5              11      PUSH    HL              ; push $0100 (TPA address)
0006D2 CB48 C3F1CC          10      JP  SETFCB              ; and JP $0100
                                
       CB4B                     C_BAT:
0006D5 CB4B 114154          10      LD  DE,'A'+'T'*256
0006D8 CB4E ED52            15      SBC HL,DE
0006DA CB50 20D0            12      JR  NZ,CEXE6
                                
0006DC CB52 CDC0CA          17      CALL    DEFCB
                                
0006DF CB55 217CE4          10      LD  HL,DTA_CCP
0006E2 CB58 11A1E4          10      LD  DE,FCB_BAT
0006E5 CB5B 012500          10      LD  BC,37
0006E8 CB5E EDB0                    LDIR
       CB60                     C_BAT1:
0006EA CB60 CDCECA          17      CALL    SETDTA100
0006ED CB63 CD97CB          17      CALL    FGETC_BAT
0006F0 CB66 218100          10      LD  HL,DTA1+1
0006F3 CB69 2025            12      JR  NZ,END_BATCH
0006F5 CB6B FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
0006F7 CB6D 38F1            12      JR  C,C_BAT1
0006F9 CB6F 3620            10      LD  (HL),' '
0006FB CB71 23               6      INC HL
       CB72                     C_BAT2:
0006FC CB72 77               7      LD  (HL),A
0006FD CB73 23               6      INC HL
0006FE CB74 7D               4      LD  A,L
0006FF CB75 3C               4      INC A       ;L==0FFH
000700 CB76 2809            12      JR  Z,RUN_BATCH
000702 CB78 CD97CB          17      CALL    FGETC_BAT
000705 CB7B 2004            12      JR  NZ,RUN_BATCH
000707 CB7D FE20             7      CP  020H
000709 CB7F 30F1            12      JR  NC,C_BAT2
       CB81                     RUN_BATCH:
00070B CB81 7D               4      LD  A,L
00070C CB82 D67F             7      SUB DTA1-1
00070E CB84 328000          13      LD  (DTA1),A
000711 CB87 FE04             7      CP  4
000713 CB89 3805            12      JR  C,END_BATCH
000715 CB8B 3600            10      LD  (HL),0
000717 CB8D C33ECA          10      JP  COMMAND2
       CB90                     END_BATCH:
00071A CB90 AF               4      XOR A       ;バッチファイルを閉じる
00071B CB91 32A1E4          13      LD  (FCB_BAT),A
00071E CB94 C300E5          10      JP  CPM_BOOT
                                
       CB97                     FGETC_BAT:
000721 CB97 11A1E4          10      LD  DE,FCB_BAT
       CB9A                     FGETC:              ;1文字ずつ読み込む
000724 CB9A E5              11      PUSH    HL      ;Z:成功
000725 CB9B 210100          10      LD  HL,1
000728 CB9E CDF1CA          17      CALL    S27
00072B CBA1 E1              10      POP HL
00072C CBA2 3A0080          13      LD  A,(BUFFER)
00072F CBA5 C9              10      RET
                                
       CBA6                     C_DEL:
000730 CBA6 CDF1CC          17      CALL    SETFCB
000733 CBA9 CD51D1          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
000736 CBAC 0E13             7      LD  C,013H
000738 CBAE 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       CBB0                     C_REN:
00073A CBB0 CDF1CC          17      CALL    SETFCB
00073D CBB3 3E10             7      LD  A,010H      ;ディレクトリも対象にする
00073F CBB5 326900          13      LD  (FCB1+13),A ;属性
000742 CBB8 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       CBBA                     CDEL1:
000744 CBBA 115C00          10      LD  DE,FCB1
000747 CBBD CD0500          17      CALL    SYSTEM
00074A CBC0 C6FF             7      ADD A,0FFH
00074C CBC2 C9              10      RET
                                
       CBC3                     C_DIR:
00074D CBC3 CDC5D5          17      CALL    FILEC
000750 CBC6 2115E5          10      LD  HL,FDRV+1
000753 CBC9 CD07CE          17      CALL    CWILD1
000756 CBCC 3EF1             7      LD  A,0F1H
000758 CBCE 3221E5          13      LD  (FDRV+13),A
00075B CBD1 CDAACA          17      CALL    OPEN1
       CBD4                     CDIR1:
00075E CBD4 B7               4      OR  A
00075F CBD5 2008            12      JR  NZ,PDSKF
000761 CBD7 CD22CC          17      CALL    P_NAME
000764 CBDA CDBCCA          17      CALL    OPEN2
000767 CBDD 18F5            12      JR  CDIR1
       CBDF                     PDSKF:
000769 CBDF 3A14E5          13      LD  A,(FDRV)
00076C CBE2 5F               4      LD  E,A
00076D CBE3 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
00076F CBE5 CD0500          17      CALL    SYSTEM
000772 CBE8 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
000773 CBE9 C601             7      ADD A,001H
000775 CBEB D8              11      RET C       ;Aが0FFHだった場合
000776 CBEC 3E06             7      LD  A,8-2
       CBEE                     PDS1:               ;HL=未使用クラスタの総数
000778 CBEE 3C               4      INC A
000779 CBEF CB19             8      RR  C
00077B CBF1 30FB            12      JR  NC,PDS1
       CBF3                     PDS2:               ;B←論理セクタのサイズの上位8ビット
00077D CBF3 3C               4      INC A
00077E CBF4 CB18             8      RR  B
000780 CBF6 30FB            12      JR  NC,PDS2
000782 CBF8 47               4      LD  B,A
                                
000783 CBF9 110000          10      LD  DE,0
       CBFC                     PDS3:
000786 CBFC 29              11      ADD HL,HL
000787 CBFD EB               4      EX  DE,HL
000788 CBFE ED6A            15      ADC HL,HL
00078A CC00 EB               4      EX  DE,HL
00078B CC01 10F9            13      DJNZ    PDS3
       CC03                     PDSKF1:
00078D CC03 CD8FCC          17      CALL    PRDEC_DEHL
000790 CC06 11D1E4          10      LD  DE,FREE
000793 CC09 CD73CE          17      CALL    _SYS09      ;(BDOS)文字列出力
000796 CC0C CD7CCC          17      CALL    PUTDRV
000799 CC0F 3E5C             7      LD  A,05CH      ;\
00079B CC11 CD15D1          17      CALL    MSG_A
00079E CC14 2A22E5          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
0007A1 CC17 AF               4      XOR A
0007A2 CC18 11FEFF          10      LD  DE,0-2
0007A5 CC1B 19              11      ADD HL,DE
0007A6 CC1C 23               6      INC HL
0007A7 CC1D DC8CCC          17      CALL    C,PRDEC_HL
0007AA CC20 1833            12      JR  LTNL
                                
       CC22                     P_NAME:
0007AC CC22 3A7DE4          13      LD  A,(DTA_CCP+1)
0007AF CC25 FE2E             7      CP  '.'
0007B1 CC27 C8              11      RET Z
                                
0007B2 CC28 3A88E4          13      LD  A,(DTA_CCP+1+00BH)
0007B5 CC2B F5              11      PUSH    AF
0007B6 CC2C CB67             8      BIT 4,A
0007B8 CC2E 2808            12      JR  Z,DIR3
0007BA CC30 11C6E4          10      LD  DE,DIRMES
0007BD CC33 CD73CE          17      CALL    _SYS09      ;(BDOS)文字列出力
0007C0 CC36 180A            12      JR  DIR6
       CC38                     DIR3:
0007C2 CC38 ED5B9BE4        20      LD  DE,(DTA_CCP+1+01EH)
0007C6 CC3C 2A99E4          16      LD  HL,(DTA_CCP+1+01CH)
0007C9 CC3F CD8FCC          17      CALL    PRDEC_DEHL
       CC42                     DIR6:
0007CC CC42 F1              10      POP AF
0007CD CC43 0F               4      RRCA
0007CE CC44 9F               4      SBC A,A
0007CF CC45 E60A             7      AND '*'-020H
0007D1 CC47 C620             7      ADD A,020H
0007D3 CC49 CD15D1          17      CALL    MSG_A
0007D6 CC4C CD7CCC          17      CALL    PUTDRV
0007D9 CC4F 217DE4          10      LD  HL,DTA_CCP+1
0007DC CC52 CDCFCC          17      CALL    FPRNT
                                
       CC55                     LTNL:
0007DF CC55 1E03             7      LD  E,3
0007E1 CC57 C3CDE5          10      JP  _PRINT
                                
       CC5A                     C_PATH:
0007E4 CC5A CDA6D6          17      CALL    SPCUT
0007E7 CC5D 2140E4          10      LD  HL,PATHD
0007EA CC60 FE21             7      CP  021H
0007EC CC62 300C            12      JR  NC,CPATH0
       CC64                     CPATHP:
0007EE CC64 7E               7      LD  A,(HL)
0007EF CC65 23               6      INC HL
0007F0 CC66 FE20             7      CP  020H
0007F2 CC68 3F               4      CCF
0007F3 CC69 30EA            12      JR  NC,LTNL
0007F5 CC6B CD15D1          17      CALL    MSG_A
0007F8 CC6E 18F4            12      JR  CPATHP
       CC70                     CPATH0:
0007FA CC70 FE3B             7      CP  ';'
0007FC CC72 2001            12      JR  NZ,CPATH1
0007FE CC74 13               6      INC DE
       CC75                     CPATH1:
0007FF CC75 EB               4      EX  DE,HL
000800 CC76 013B00          10      LD  BC,PATHX
000803 CC79 EDB0                    LDIR
000805 CC7B C9              10      RET
                                
       CC7C                     PUTDRV:
000806 CC7C 3A14E5          13      LD  A,(FDRV)
000809 CC7F CDD9D6          17      CALL    GETDRV1
00080C CC82 C641             7      ADD A,'A'
00080E CC84 CD15D1          17      CALL    MSG_A
000811 CC87 3E3A             7      LD  A,':'
       CC89                     MSG_AR:
000813 CC89 C315D1          10      JP  MSG_A
                                
       CC8C                     PRDEC_HL:
000816 CC8C AF               4      XOR A
000817 CC8D 5F               4      LD  E,A
000818 CC8E 57               4      LD  D,A
       CC8F                     PRDEC_DEHL:
000819 CC8F D5              11      PUSH    DE
00081A CC90 110FE5          10      LD  DE,DECBF
00081D CC93 0605             7      LD  B,5
00081F CC95 CD26CD          17      CALL    ZERO_MEMORY_DE  ;A=0
000822 CC98 D1              10      POP DE
                                
000823 CC99 0E20             7      LD  C,32
       CC9B                     DEC1:
000825 CC9B 29              11      ADD HL,HL
000826 CC9C EB               4      EX  DE,HL
000827 CC9D ED6A            15      ADC HL,HL
000829 CC9F EB               4      EX  DE,HL
00082A CCA0 E5              11      PUSH    HL
00082B CCA1 2113E5          10      LD  HL,DECBF+4
00082E CCA4 0605             7      LD  B,5
       CCA6                     DEC2:
000830 CCA6 7E               7      LD  A,(HL)
000831 CCA7 8F               4      ADC A,A
000832 CCA8 27               4      DAA
000833 CCA9 77               7      LD  (HL),A
000834 CCAA 2B               6      DEC HL
000835 CCAB 10F9            13      DJNZ    DEC2
000837 CCAD E1              10      POP HL
000838 CCAE 0D               4      DEC C
000839 CCAF 20EA            12      JR  NZ,DEC1
                                
00083B CCB1 210FE5          10      LD  HL,DECBF
00083E CCB4 3E20             7      LD  A,020H
000840 CCB6 0604             7      LD  B,4
       CCB8                     DEC3:
000842 CCB8 CDC5CC          17      CALL    DEC4
000845 CCBB CDC5CC          17      CALL    DEC4
000848 CCBE 23               6      INC HL
000849 CCBF 10F7            13      DJNZ    DEC3
       CCC1                     DECX:
00084B CCC1 CDC5CC          17      CALL    DEC4
00084E CCC4 AF               4      XOR A
       CCC5                     DEC4:
00084F CCC5 ED6F            18      RLD
000851 CCC7 FE20             7      CP  020H
000853 CCC9 2802            12      JR  Z,DEC5
000855 CCCB F630             7      OR  030H
       CCCD                     DEC5:
000857 CCCD 18BA            12      JR  MSG_AR
                                
       CCCF                     FPRNT:
000859 CCCF 0608             7      LD  B,8 ;ファイル名を表示
00085B CCD1 CDE0CC          17      CALL    P_N1
00085E CCD4 7E               7      LD  A,(HL)
00085F CCD5 CDF8D8          17      CALL    CAP3
000862 CCD8 D8              11      RET C   ;拡張子が無い
                                
000863 CCD9 3E2E             7      LD  A,'.'
000865 CCDB CD15D1          17      CALL    MSG_A
000868 CCDE 0603             7      LD  B,3 ;拡張子を表示
       CCE0                     P_N1:
00086A CCE0 7E               7      LD  A,(HL)
00086B CCE1 CDF8D8          17      CALL    CAP3
00086E CCE4 3807            12      JR  C,P_N2
000870 CCE6 CD15D1          17      CALL    MSG_A
000873 CCE9 23               6      INC HL
000874 CCEA 10F4            13      DJNZ    P_N1
000876 CCEC C9              10      RET
       CCED                     P_N2:
000877 CCED 23               6      INC HL
000878 CCEE 10FD            13      DJNZ    P_N2
00087A CCF0 C9              10      RET
                                
       CCF1                     SETFCB:
00087B CCF1 CDA6D6          17      CALL    SPCUT
00087E CCF4 1A               7      LD  A,(DE)
00087F CCF5 FE20             7      CP  020H
000881 CCF7 3801            12      JR  C,SETFCBA
000883 CCF9 1B               6      DEC DE
       CCFA                     SETFCBA:
000884 CCFA 0624             7      LD  B,36
000886 CCFC 215C00          10      LD  HL,FCB1
000889 CCFF E5              11      PUSH    HL
00088A CD00 AF               4      XOR A
00088B CD01 CD7BD6          17      CALL    FILL_MEMORY
00088E CD04 E1              10      POP HL
00088F CD05 D5              11      PUSH    DE
000890 CD06 CDACD0          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000893 CD09 216C00          10      LD  HL,FCB2
000896 CD0C CDACD0          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000899 CD0F E1              10      POP HL
00089A CD10 010050          10      LD  BC,05000H
00089D CD13 118100          10      LD  DE,00081H
       CD16                     SETFCB1:
0008A0 CD16 7E               7      LD  A,(HL)
0008A1 CD17 23               6      INC HL
0008A2 CD18 FE20             7      CP  020H
0008A4 CD1A 3805            12      JR  C,SETFCB2
0008A6 CD1C 12               7      LD  (DE),A
0008A7 CD1D 13               6      INC DE
0008A8 CD1E 0C               4      INC C
0008A9 CD1F 10F5            13      DJNZ    SETFCB1
       CD21                     SETFCB2:
0008AB CD21 79               4      LD  A,C
0008AC CD22 328000          13      LD  (DTA1),A
0008AF CD25 04               4      INC B
       CD26                     ZERO_MEMORY_DE:
0008B0 CD26 AF               4      XOR A
       CD27                     FILL_MEMORY_DE:
0008B1 CD27 12               7      LD  (DE),A
0008B2 CD28 13               6      INC DE
0008B3 CD29 10FC            13      DJNZ    FILL_MEMORY_DE
0008B5 CD2B C9              10      RET
                                
       CD2C                     C_COPY:
0008B6 CD2C CDF1CC          17      CALL    SETFCB
                                
0008B9 CD2F 1161E5          10      LD  DE,ZERO
0008BC CD32 CDC8D5          17      CALL    FILEC2
0008BF CD35 216C00          10      LD  HL,FCB2
0008C2 CD38 CDB3D0          17      CALL    S29X1
                                
0008C5 CD3B 3E10             7      LD  A,010H
0008C7 CD3D 326900          13      LD  (FCB1+13),A
0008CA CD40 216D00          10      LD  HL,FCB2FN
0008CD CD43 CD07CE          17      CALL    CWILD1
       CD46                     COPY0:
0008D0 CD46 CD04CE          17      CALL    CWILD
0008D3 CD49 215C00          10      LD  HL,FCB1
0008D6 CD4C CDADCA          17      CALL    OPEN
0008D9 CD4F 37               4      SCF
       CD50                     COPY1:
0008DA CD50 C0              11      RET NZ
0008DB CD51 CDC0CA          17      CALL    DEFCB
                                
0008DE CD54 3A89E4          13      LD  A,(DTA_CCP+13)
0008E1 CD57 CB67             8      BIT 4,A
0008E3 CD59 2821            12      JR  Z,COPY1A
                                
0008E5 CD5B 215D00          10      LD  HL,FCB1FN
0008E8 CD5E CD0BDA          17      CALL    CHKWILD
0008EB CD61 3814            12      JR  C,COPY9
                                
0008ED CD63 3E20             7      LD  A,020H
0008EF CD65 325D00          13      LD  (FCB1FN),A
0008F2 CD68 2A96E4          16      LD  HL,(DTA_CCP+26)
0008F5 CD6B 23               6      INC HL
0008F6 CD6C 226A00          16      LD  (FCB1+14),HL
0008F9 CD6F 18D5            12      JR  COPY0
                                
       CD71                     COPY8:
0008FB CD71 CD73CE          17      CALL    _SYS09      ;(BDOS)文字列出力
0008FE CD74 CD55CC          17      CALL    LTNL
       CD77                     COPY9:
000901 CD77 CDBCCA          17      CALL    OPEN2
000904 CD7A 18D4            12      JR  COPY1
                                
       CD7C                     COPY1A:
000906 CD7C 216C00          10      LD  HL,FCB2
000909 CD7F 1114E5          10      LD  DE,FDRV
00090C CD82 017EE4          10      LD  BC,DTA_CCP+2
00090F CD85 EDA0            16      LDI
000911 CD87 3E0B             7      LD  A,11
       CD89                     COPY2:
000913 CD89 F5              11      PUSH    AF
000914 CD8A 7E               7      LD  A,(HL)
000915 CD8B FE3F             7      CP  '?'
000917 CD8D 2001            12      JR  NZ,COPY3
000919 CD8F 0A               7      LD  A,(BC)
       CD90                     COPY3:
00091A CD90 12               7      LD  (DE),A
00091B CD91 03               6      INC BC
00091C CD92 13               6      INC DE
00091D CD93 23               6      INC HL
00091E CD94 F1              10      POP AF
00091F CD95 3D               4      DEC A
000920 CD96 20F1            12      JR  NZ,COPY2
000922 CD98 010500          10      LD  BC,16-11
000925 CD9B EDB0                    LDIR
       CD9D                     PUTNAME:
000927 CD9D 215D00          10      LD  HL,FCB1FN
00092A CDA0 CD0BDA          17      CALL    CHKWILD
00092D CDA3 300B            12      JR  NC,PUTN1
00092F CDA5 2115E5          10      LD  HL,FDRV+1
000932 CDA8 CDCFCC          17      CALL    FPRNT
000935 CDAB 3E20             7      LD  A,020H
000937 CDAD CD15D1          17      CALL    MSG_A
       CDB0                     PUTN1:
00093A CDB0 1114E5          10      LD  DE,FDRV
00093D CDB3 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
00093F CDB5 CDDBCA          17      CALL    SYSTEM0
000942 CDB8 2048            12      JR  NZ,COPYE2
000944 CDBA 67               4      LD  H,A     ;A=0
000945 CDBB 6F               4      LD  L,A
000946 CDBC 2235E5          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
000949 CDBF 2237E5          16      LD  (FDRV+35),HL
       CDC2                     COPY6:
00094C CDC2 CDE4CA          17      CALL    S27BUF
00094F CDC5 47               4      LD  B,A
000950 CDC6 3C               4      INC A
000951 CDC7 2831            12      JR  Z,COPYE
000953 CDC9 7C               4      LD  A,H
000954 CDCA B5               4      OR  L
000955 CDCB 280C            12      JR  Z,COPY7
000957 CDCD 1114E5          10      LD  DE,FDRV
00095A CDD0 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
00095C CDD2 CDDBCA          17      CALL    SYSTEM0
00095F CDD5 2023            12      JR  NZ,COPYE
000961 CDD7 10E9            13      DJNZ    COPY6
       CDD9                     COPY7:
000963 CDD9 3A89E4          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
000966 CDDC 3221E5          13      LD  (FDRV+13),A
000969 CDDF 2190E4          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
00096C CDE2 1128E5          10      LD  DE,FDRV+20
00096F CDE5 010400          10      LD  BC,4
000972 CDE8 EDB0                    LDIR
                                
000974 CDEA 1114E5          10      LD  DE,FDRV
000977 CDED 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
000979 CDEF CDDBCA          17      CALL    SYSTEM0
00097C CDF2 2006            12      JR  NZ,COPYE
                                
00097E CDF4 1171E5          10      LD  DE,OK
000981 CDF7 C371CD          10      JP  COPY8
                                
       CDFA                     COPYE:
000984 CDFA 1114E5          10      LD  DE,FDRV
000987 CDFD 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
000989 CDFF CD0500          17      CALL    SYSTEM
       CE02                     COPYE2:
00098C CE02 37               4      SCF
00098D CE03 C9              10      RET
                                
       CE04                     CWILD:
00098E CE04 215D00          10      LD  HL,FCB1FN
       CE07                     CWILD1:
000991 CE07 7E               7      LD  A,(HL)
000992 CE08 FE20             7      CP  020H
000994 CE0A C0              11      RET NZ
       CE0B                     CWILD2:
000995 CE0B 3E3F             7      LD  A,'?'
000997 CE0D 060B             7      LD  B,11
000999 CE0F C37BD6          10      JP  FILL_MEMORY
                                
       CE12                     COMTB:
00099C CE12 44202020                DB  "D   "  ;1
0009A0 CE16 C3CB                    DW  C_DIR
0009A2 CE18 44495220                DB  "DIR "  ;2
0009A6 CE1C C3CB                    DW  C_DIR
0009A8 CE1E 434F5059                DB  "COPY"  ;3
0009AC CE22 2CCD                    DW  C_COPY
0009AE CE24 43442020                DB  "CD  "  ;4
0009B2 CE28 E0CA                    DW  C_CD
0009B4 CE2A 44454C20                DB  "DEL "  ;5
0009B8 CE2E A6CB                    DW  C_DEL
0009BA CE30 50415448                DB  "PATH"  ;6
0009BE CE34 5ACC                    DW  C_PATH
0009C0 CE36 52454E20                DB  "REN "  ;7
0009C4 CE3A B0CB                    DW  C_REN
0009C6 CE3C 52454D20                DB  "REM "  ;8
0009CA CE40 70CE                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       CE42                     BDOS0:
0009CC CE42 E5              11      PUSH    HL
0009CD CE43 79               4      LD  A,C
0009CE CE44 FE3C             7      CP  03CH
0009D0 CE46 3802            12      JR  C,DOS1
0009D2 CE48 3E3C             7      LD  A,03CH
       CE4A                     DOS1:
0009D4 CE4A 87               4      ADD A,A
0009D5 CE4B 324FCE          13      LD  (DOS1_SWC),A
0009D8 CE4E 2A00E6          16      LD  HL,(STABLE)
       CE4F                     DOS1_SWC    EQU $-2
0009DB CE51 E3              19      EX  (SP),HL
0009DC CE52 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
0009DD CE53 C9              10      RET
       CE54                     _DOS2:
0009DE CE54 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
0009E0 CE56 CAEED0          10      JP  Z,_SYS5A
0009E3 CE59 FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
0009E5 CE5B CAABD0          10      JP  Z,_SYS5C
0009E8 CE5E FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
0009EA CE60 CA06E3          10      JP  Z,_SYS5F
0009ED CE63 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
0009EF CE65 200A            12      JR  NZ,_ERROR
0009F1 CE67 011D00          10      LD  BC,VER_6F
0009F4 CE6A 116101          10      LD  DE,VER
0009F7 CE6D 210301          10      LD  HL,MACD
       CE70                     C_REM:
0009FA CE70 AF               4      XOR A
       CE71                     _ERROR:
0009FB CE71 A7               4      AND A
0009FC CE72 C9              10      RET
                                
       CE73                     _SYS09:     ;文字列出力
0009FD CE73 D5              11      PUSH    DE
       CE74                     _SX09:
0009FE CE74 1A               7      LD  A,(DE)
0009FF CE75 13               6      INC DE
000A00 CE76 FE24             7      CP  '$'
000A02 CE78 2831            12      JR  Z,SX0E2
000A04 CE7A CD15D1          17      CALL    MSG_A
000A07 CE7D 18F5            12      JR  _SX09
                                
       CE7F                     MSX1:
000A09 CE7F CD15D1          17      CALL    MSG_A
       CE82                     MSX:
000A0C CE82 7E               7      LD  A,(HL)
000A0D CE83 23               6      INC HL
000A0E CE84 B7               4      OR  A
000A0F CE85 20F8            12      JR  NZ,MSX1
000A11 CE87 C9              10      RET
                                
       CE88                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000A12 CE88 212200          10      LD  HL,00022H
000A15 CE8B 7D               4      LD  A,L
000A16 CE8C C9              10      RET
                                
       CE8D                     _SYS0D:     ;(BDOS)ディスクリセット
000A17 CE8D CDDFE5          17      CALL    _FFLUSH
000A1A CE90 E5              11      PUSH    HL
000A1B CE91 218000          10      LD  HL,00080H
000A1E CE94 228AE5          16      LD  (_DTA),HL
000A21 CE97 E1              10      POP HL
000A22 CE98 D5              11      PUSH    DE
000A23 CE99 1E00             7      LD  E,0
000A25 CE9B 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       CE9C                     _SYS0E:     ;(BDOS)カレントドライブの設定
000A26 CE9C D5              11      PUSH    DE
000A27 CE9D 7B               4      LD  A,E
000A28 CE9E DDE5            15      PUSH    IX
000A2A CEA0 CDDCE5          17      CALL    _GETDPB
000A2D CEA3 DDE1            14      POP IX
000A2F CEA5 3804            12      JR  C,SX0E2
000A31 CEA7 7B               4      LD  A,E
000A32 CEA8 320400          13      LD  (_DVSW),A
       CEAB                     SX0E2:
000A35 CEAB D1              10      POP DE
000A36 CEAC C9              10      RET
                                
       CEAD                     _SYS0F:     ;(BDOS)ファイルのオープン
000A37 CEAD CDB8D6          17      CALL    SETDRV
000A3A CEB0 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000A3D CEB3 C602             7      ADD A,002H      ;Write
000A3F CEB5 2848            12      JR  Z,FEND0F
000A41 CEB7 CD07DA          17      CALL    CHKWILDX
                                
000A44 CEBA D4E2D6          17      CALL    NC,SOPENX
       CEBD                     _S16XX:
000A47 CEBD 3840            12      JR  C,FEND0F
                                                ;Directory location
000A49 CEBF 3A9FE5          13      LD  A,(_FILEN)
000A4C CEC2 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
000A4F CEC5 3AA0E5          13      LD  A,(_DIRF)
000A52 CEC8 FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000A55 CECB FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
000A58 CECE FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
000A5B CED1 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
000A5F CED5 FDE5            15      PUSH    IY
000A61 CED7 D1              10      POP DE
000A62 CED8 13               6      INC DE
000A63 CED9 010B00          10      LD  BC,11
000A66 CEDC EDB0                    LDIR
                                ;               Attribute
000A68 CEDE 7E               7      LD  A,(HL)
000A69 CEDF FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
000A6C CEE2 110B00          10      LD  DE,11       ;Reserved
000A6F CEE5 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
000A70 CEE6 11E4E6          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
000A73 CEE9 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       CEEB                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000A75 CEEB 1A               7      LD  A,(DE)
000A76 CEEC 13               6      INC DE
000A77 CEED 32F4CE          13      LD  (S16PAT),A
000A7A CEF0 7E               7      LD  A,(HL)
000A7B CEF1 23               6      INC HL
000A7C CEF2 FD7700          19      LD  (IY+0),A
       CEF4                     S16PAT  EQU $-1
000A7F CEF5 10F4            13      DJNZ    S16LOOP
                                
000A81 CEF7 AF               4      XOR A
000A82 CEF8 FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000A85 CEFB FD229CCF        20      LD  (OFCB_SWC),IY
       CEFF                     FEND0F:
000A89 CEFF 1845            12      JR  FEND10
                                
       CF01                     _SYS10:     ;(BDOS)ファイルのクローズ
000A8B CF01 CDB8D6          17      CALL    SETDRV
000A8E CF04 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000A91 CF07 D6FE             7      SUB 0FEH
000A93 CF09 37               4      SCF
000A94 CF0A 3F               4      CCF
000A95 CF0B 2039            12      JR  NZ,FEND10
       CF0D                     _S10A:              ;Write
000A97 CF0D FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000A9A CF10 FD770F          19      LD  (IY+15),A
                                
000A9D CF13 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
000AA0 CF16 CD03DB          17      CALL    SETTMS
                                
000AA3 CF19 FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000AA6 CF1C 32A0E5          13      LD  (_DIRF),A
000AA9 CF1F E67F             7      AND 07FH
000AAB CF21 3228E0          13      LD  (_SECPS),A
000AAE CF24 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000AB1 CF27 FD561F          19      LD  D,(IY+31)
000AB4 CF2A CD16D8          17      CALL    READ_DIR
000AB7 CF2D 3817            12      JR  C,FEND10
                                
000AB9 CF2F 3A42D7          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000ABC CF32 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000ABD CF33 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000AC0 CF36 6F               4      LD  L,A
000AC1 CF37 2600             7      LD  H,0
000AC3 CF39 29              11      ADD HL,HL       ;*2
000AC4 CF3A 29              11      ADD HL,HL       ;*4
000AC5 CF3B 29              11      ADD HL,HL       ;*8
000AC6 CF3C 29              11      ADD HL,HL       ;*16
000AC7 CF3D 29              11      ADD HL,HL       ;*32
000AC8 CF3E ED4B7EE6        20      LD  BC,(_DTBUF)
000ACC CF42 09              11      ADD HL,BC
                                
000ACD CF43 CD17DA          17      CALL    SDIRENT
       CF46                     FEND10:
000AD0 CF46 1842            12      JR  FEND
                                
       CF48                     _SYS11:     ;(BDOS)最初のファイルの検索
000AD2 CF48 CDB8D6          17      CALL    SETDRV
000AD5 CF4B CD11D7          17      CALL    SOPEN
       CF4E                     _S12X1:
000AD8 CF4E 383A            12      JR  C,FEND
000ADA CF50 CDB0D7          17      CALL    SOPENE2
000ADD CF53 ED5B8AE5        20      LD  DE,(_DTA)
000AE1 CF57 3A88E5          13      LD  A,(_DRV)
000AE4 CF5A 3C               4      INC A
000AE5 CF5B 12               7      LD  (DE),A
000AE6 CF5C D5              11      PUSH    DE
000AE7 CF5D 13               6      INC DE
000AE8 CF5E 012000          10      LD  BC,32
000AEB CF61 EDB0                    LDIR
000AED CF63 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000AF0 CF66 FD660F          19      LD  H,(IY+15)
000AF3 CF69 22F4E6          16      LD  (SCDIR),HL
000AF6 CF6C 2A9AE5          16      LD  HL,(_FBPS)
000AF9 CF6F 22F6E6          16      LD  (SFBPS),HL
000AFC CF72 2A9FE5          16      LD  HL,(_FILEN)
000AFF CF75 7C               4      LD  A,H
000B00 CF76 B7               4      OR  A
000B01 CF77 2806            12      JR  Z,_S12DIR
000B03 CF79 3A28E0          13      LD  A,(_SECPS)
000B06 CF7C F680             7      OR  080H
000B08 CF7E 67               4      LD  H,A
       CF7F                     _S12DIR:
000B09 CF7F 22F8E6          16      LD  (SFNDF),HL  ;Directory position and Flags
000B0C CF82 E1              10      POP HL
000B0D CF83 1139E5          10      LD  DE,SFILE
000B10 CF86 0E21             7      LD  C,33
       CF88                     _S11B:
000B12 CF88 EDB0                    LDIR
       CF8A                     FEND:
000B14 CF8A 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       CF8B                     FENDE:
000B15 CF8B FDE1            14      POP IY
000B17 CF8D C1              10      POP BC
000B18 CF8E D1              10      POP DE
000B19 CF8F E1              10      POP HL
000B1A CF90 C9              10      RET
                                
       CF91                     _SYS12:     ;(BDOS)次のファイルの検索
000B1B CF91 E5              11      PUSH    HL
000B1C CF92 D5              11      PUSH    DE
000B1D CF93 C5              11      PUSH    BC
000B1E CF94 FDE5            15      PUSH    IY
000B20 CF96 CD75D7          17      CALL    NOPEN
000B23 CF99 18B3            12      JR  _S12X1
                                
       CF9B                     _S16K:
000B25 CF9B 110000          10      LD  DE,0
       CF9C                     OFCB_SWC    EQU $-2
000B28 CF9E D5              11      PUSH    DE
000B29 CF9F 061A             7      LD  B,26        ;First cluster
       CFA1                     S16K1:
000B2B CFA1 13               6      INC DE
000B2C CFA2 23               6      INC HL
000B2D CFA3 10FC            13      DJNZ    S16K1
                                
000B2F CFA5 1A               7      LD  A,(DE)
000B30 CFA6 BE               7      CP  (HL)
000B31 CFA7 2015            12      JR  NZ,S16K2
000B33 CFA9 13               6      INC DE
000B34 CFAA 23               6      INC HL
000B35 CFAB 1A               7      LD  A,(DE)
000B36 CFAC BE               7      CP  (HL)
000B37 CFAD 200F            12      JR  NZ,S16K2
                                
000B39 CFAF E1              10      POP HL
000B3A CFB0 FDE5            15      PUSH    IY
000B3C CFB2 D1              10      POP DE
000B3D CFB3 7E               7      LD  A,(HL)
000B3E CFB4 CDCDD6          17      CALL    IS_SAME_DRV_A_DE
000B41 CFB7 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000B43 CFB9 ED52            15      SBC HL,DE       ;CP HL,DE
000B45 CFBB 37               4      SCF
000B46 CFBC C0              11      RET NZ
000B47 CFBD E5              11      PUSH    HL
       CFBE                     S16K2:
000B48 CFBE E1              10      POP HL
       CFBF                     S16K3:
000B49 CFBF FDE5            15      PUSH    IY
000B4B CFC1 D1              10      POP DE
       CFC2                     _SYS13:     ;(BDOS)ファイルの削除
000B4C CFC2 CDB8D6          17      CALL    SETDRV
000B4F CFC5 CD3FD9          17      CALL    KILL
       CFC8                     FEND13:
000B52 CFC8 18C0            12      JR  FEND
                                
       CFCA                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000B54 CFCA CDB8D6          17      CALL    SETDRV
000B57 CFCD CD7BDE          17      CALL    INIT_SEQ
       CFD0                     SREAD:
000B5A CFD0 CD4DDE          17      CALL    RB_READ
                                
000B5D CFD3 C601             7      ADD A,001H
000B5F CFD5 38B3            12      JR  C,FEND
                                
000B61 CFD7 7D               4      LD  A,L
000B62 CFD8 D601             7      SUB 001H
       CFDA                     FENDX:
000B64 CFDA 9F               4      SBC A,A
000B65 CFDB E603             7      AND 3
000B67 CFDD 1F               4      RRA
000B68 CFDE 18AB            12      JR  FENDE
                                
       CFE0                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000B6A CFE0 CDB8D6          17      CALL    SETDRV
000B6D CFE3 CD7BDE          17      CALL    INIT_SEQ
       CFE6                     SWRITE:
000B70 CFE6 CD48DE          17      CALL    RB_WRITE
                                
000B73 CFE9 C6FF             7      ADD A,0FFH
000B75 CFEB 18ED            12      JR  FENDX
                                
       CFED                     _SYS17:     ;(BDOS)ファイル名の変更
000B77 CFED CDB8D6          17      CALL    SETDRV
000B7A CFF0 CD95D9          17      CALL    NAME
000B7D CFF3 18D3            12      JR  FEND13
                                
       CFF5                     _SYS16:     ;(BDOS)ファイルの作成
000B7F CFF5 CDB8D6          17      CALL    SETDRV
                                
000B82 CFF8 CD07DA          17      CALL    CHKWILDX
000B85 CFFB 38CB            12      JR  C,FEND13
000B87 CFFD FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000B8A D000 FE05             7      CP  5
000B8C D002 2805            12      JR  Z,_S16X2
000B8E D004 FE21             7      CP  021H
000B90 D006 DAC8CF          10      JP  C,FEND13
       D009                     _S16X2:
                                ;               Clear FCB
000B93 D009 FDE5            15      PUSH    IY
000B95 D00B E1              10      POP HL
000B96 D00C 011000          10      LD  BC,16
000B99 D00F 09              11      ADD HL,BC
       D010                     _S16X1:
000B9A D010 70               7      LD  (HL),B      ;B=0
000B9B D011 23               6      INC HL
000B9C D012 0D               4      DEC C
000B9D D013 20FB            12      JR  NZ,_S16X1
                                
000B9F D015 CD08DB          17      CALL    SETTMSX
000BA2 D018 FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000BA6 D01C CDE2D6          17      CALL    SOPENX
000BA9 D01F 3F               4      CCF
000BAA D020 CC9BCF          17      CALL    Z,_S16K
000BAD D023 D4C1D7          17      CALL    NC,COPEN
000BB0 D026 D417DA          17      CALL    NC,SDIRENT
000BB3 D029 C3BDCE          10      JP  _S16XX
                                
       D02C                     _SYS21:     ;(BDOS)ランダムな読み出し
000BB6 D02C CDB8D6          17      CALL    SETDRV
000BB9 D02F CD53DB          17      CALL    INIT_RND
000BBC D032 189C            12      JR  SREAD
                                
       D034                     _SYS22:     ;(BDOS)ランダムな書き込み
       D034                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000BBE D034 CDB8D6          17      CALL    SETDRV
000BC1 D037 CD53DB          17      CALL    INIT_RND
000BC4 D03A 18AA            12      JR  SWRITE
                                
       D03C                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000BC6 D03C 21FF00          10      LD  HL,000FFH
000BC9 D03F AF               4      XOR A
000BCA D040 C9              10      RET
                                
       D041                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000BCB D041 3A0400          13      LD  A,(_DVSW)   ;from LDOS
000BCE D044 A7               4      AND A
000BCF D045 C9              10      RET
                                
       D046                     _SYS1A:     ;(BDOS)DTAの設定
000BD0 D046 ED538AE5        20      LD  (_DTA),DE
000BD4 D04A AF               4      XOR A
000BD5 D04B C9              10      RET
                                
       D04C                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000BD6 D04C 7B               4      LD  A,E
000BD7 D04D CDC6D6          17      CALL    GETDRV
000BDA D050 CDDCE5          17      CALL    _GETDPB
000BDD D053 D4E2E5          17      CALL    NC,_RDFATX
000BE0 D056 210000          10      LD  HL,0
000BE3 D059 D4E1DA          17      CALL    NC,DSKF
                                
000BE6 D05C ED5BE2DA        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000BEA D060 1B               6      DEC DE      ;DE←クラスタの総数
000BEB D061 FD2A7CE6        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000BEF D065 9F               4      SBC A,A
000BF0 D066 D8              11      RET C
000BF1 D067 4F               4      LD  C,A     ;C=0
000BF2 D068 DD7E0F          19      LD  A,(IX+DPB_BPS)
000BF5 D06B E607             7      AND 7
000BF7 D06D 47               4      LD  B,A
000BF8 D06E DD7E07          19      LD  A,(IX+DPB_SECPCL)
000BFB D071 C9              10      RET
                                
       D072                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000BFC D072 AF               4      XOR A
000BFD D073 67               4      LD  H,A
000BFE D074 6F               4      LD  L,A
000BFF D075 C9              10      RET
                                
       D076                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000C00 D076 2100E7          10      LD  HL,_DEVICE
000C03 D079 7B               4      LD  A,E
000C04 D07A C3DCE5          10      JP  _GETDPB
                                
       D07D                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000C07 D07D E5              11      PUSH    HL
000C08 D07E 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000C0A D080 CD42CE          17      CALL    BDOS0
000C0D D083 381B            12      JR  C,_S23X1
                                
000C0F D085 D5              11      PUSH    DE      ;EX DE,IY
000C10 D086 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000C12 D088 FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000C15 D08B FD6E11          19      LD  L,(IY+17)   ;
000C18 D08E FD6612          19      LD  H,(IY+18)   ;
000C1B D091 C5              11      PUSH    BC      ;
000C1C D092 FD4613          19      LD  B,(IY+19)   ;
000C1F D095 CD45DB          17      CALL    GET_CPM_R_SIZE
000C22 D098 C1              10      POP BC
       D099                     _S24X1:
000C23 D099 CD65DB          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000C26 D09C FDE3            23      EX  (SP),IY     ;
000C28 D09E D1              10      POP DE      ;
                                
000C29 D09F AF               4      XOR A
       D0A0                     _S23X1:
000C2A D0A0 E1              10      POP HL
000C2B D0A1 C9              10      RET
                                
       D0A2                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000C2C D0A2 E5              11      PUSH    HL
000C2D D0A3 D5              11      PUSH    DE      ;EX DE,IY
000C2E D0A4 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000C30 D0A6 CD83DE          17      CALL    GETSEQ
000C33 D0A9 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D0AB                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000C35 D0AB 2B               6      DEC HL
       D0AC                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000C36 D0AC C5              11      PUSH    BC
000C37 D0AD E5              11      PUSH    HL
000C38 D0AE CDD0D5          17      CALL    FILE
000C3B D0B1 E1              10      POP HL
000C3C D0B2 C1              10      POP BC
       D0B3                     S29X1:
000C3D D0B3 C5              11      PUSH    BC
000C3E D0B4 D5              11      PUSH    DE
000C3F D0B5 E5              11      PUSH    HL
000C40 D0B6 EB               4      EX  DE,HL
000C41 D0B7 AF               4      XOR A
000C42 D0B8 3221E5          13      LD  (FDRV+13),A
000C45 D0BB 2114E5          10      LD  HL,FDRV
000C48 D0BE 011000          10      LD  BC,16
000C4B D0C1 EDB0                    LDIR
000C4D D0C3 E1              10      POP HL
000C4E D0C4 D1              10      POP DE
000C4F D0C5 C1              10      POP BC
000C50 D0C6 C9              10      RET
                                
       D0C7                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000C51 D0C7 C5              11      PUSH    BC
000C52 D0C8 01C7E1          10      LD  BC,DWT24B
000C55 D0CB 1804            12      JR  S2FX
       D0CD                     _SYS2F:
000C57 D0CD C5              11      PUSH    BC
000C58 D0CE 01B9E1          10      LD  BC,DRD24B
       D0D1                     S2FX:
000C5B D0D1 ED43E7D0        20      LD  (S2F_SWC),BC
000C5F D0D5 CDDFE5          17      CALL    _FFLUSH
                                
000C62 D0D8 D5              11      PUSH    DE
000C63 D0D9 E5              11      PUSH    HL
000C64 D0DA 7D               4      LD  A,L     ;Drive
000C65 D0DB CDD9E5          17      CALL    _CHGDRV
000C68 D0DE 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
000C6A D0E0 44               4      LD  B,H     ;Number of clusters
000C6B D0E1 2A8AE5          16      LD  HL,(_DTA)
                                
000C6E D0E4 0E00             7      LD  C,0
000C70 D0E6 CDB9E1          17      CALL    DRD24B
       D0E7                     S2F_SWC EQU $-2
       D0E9                     POP_HL_DE_BC_SBCAA_RET:
000C73 D0E9 E1              10      POP HL
000C74 D0EA D1              10      POP DE
000C75 D0EB C1              10      POP BC
000C76 D0EC 9F               4      SBC A,A
000C77 D0ED C9              10      RET
                                
       D0EE                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000C78 D0EE C5              11      PUSH    BC
000C79 D0EF D5              11      PUSH    DE
000C7A D0F0 E5              11      PUSH    HL
000C7B D0F1 CDC5D5          17      CALL    FILEC
000C7E D0F4 21E9D0          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
000C81 D0F7 E5              11      PUSH    HL
000C82 D0F8 3A21E5          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
000C85 D0FB E610             7      AND 010H        ;ディレクトリ
000C87 D0FD 37               4      SCF
000C88 D0FE C8              11      RET Z
000C89 D0FF 1114E5          10      LD  DE,FDRV
000C8C D102 2A4EE6          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       D105                     JPHL:
000C8F D105 E9               4      JP  (HL)
                                
       D106                     SHOW_ERROR:         ;(9)
000C90 D106 1179E5          10      LD  DE,COMERM
000C93 D109 CD73CE          17      CALL    _SYS09      ;(BDOS)文字列出力
000C96 D10C C300E5          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "MSXIO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MSX
                                
       CE71                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       CE71                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       CE71                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       CE71                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       CE71                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       CE71                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       0000                     CTRL00  EQU 0
       0000                     CTRL03  EQU 0
       0000                     CTRL04  EQU 0
       0000                     CTRL05  EQU 0
       0000                     CTRL06  EQU 0
       0000                     CTRL07  EQU 0
       0000                     CTRL08  EQU 0
       0000                     CTRL09  EQU 0
       0000                     CTRL0A  EQU 0
       0000                     CTRL0B  EQU 0
       0000                     CTRL0C  EQU 0
       0000                     CTRL0D  EQU 0
       0000                     CTRL0E  EQU 0
       0000                     CTRL12  EQU 0
       0000                     CTRL1B  EQU 0
       0000                     CTRL1C  EQU 0
       0000                     CTRL1D  EQU 0
       0000                     CTRL1E  EQU 0
       0000                     CTRL1F  EQU 0
                                
       D10F                     PRINT:
000C99 D10F 7B               4      LD  A,E
000C9A D110 1803            12      JR  MSG_A
                                
       D112                     _SYS01:     ;(BDOS)コンソール入力
000C9C D112 CD09E5          17      CALL    _SYS07
       D115                     MSG_A:
000C9F D115 FE03             7      CP  3
000CA1 D117 2814            12      JR  Z,MSG_BR
       D119                     MSGA1:
000CA3 D119 F5              11      PUSH    AF
000CA4 D11A C5              11      PUSH    BC
000CA5 D11B D5              11      PUSH    DE
000CA6 D11C E5              11      PUSH    HL
000CA7 D11D DDE5            15      PUSH    IX
000CA9 D11F DD21A200        14      LD  IX,CHPUT
000CAD D123 CD88D3          17      CALL    CALSLT_R
000CB0 D126 DDE1            14      POP IX
000CB2 D128 E1              10      POP HL
000CB3 D129 D1              10      POP DE
000CB4 D12A C1              10      POP BC
       D12B                     MSGA2:
000CB5 D12B F1              10      POP AF
000CB6 D12C C9              10      RET
       D12D                     MSG_BR:
000CB7 D12D F5              11      PUSH    AF
000CB8 D12E 3ADDF3          13      LD  A,(CSRX)
000CBB D131 FE02             7      CP  2
000CBD D133 38F6            12      JR  C,MSGA2
000CBF D135 F1              10      POP AF
       D136                     MSG_CR:
000CC0 D136 F5              11      PUSH    AF
000CC1 D137 3E0D             7      LD  A,00DH
000CC3 D139 CD19D1          17      CALL    MSGA1
000CC6 D13C 3E0A             7      LD  A,00AH
000CC8 D13E CD19D1          17      CALL    MSGA1
000CCB D141 F1              10      POP AF
000CCC D142 C9              10      RET
                                
       D143                     _SYS02:     ;(BDOS)コンソール出力
000CCD D143 CD5FD1          17      CALL    BREAK
000CD0 D146 C3CDE5          10      JP  _PRINT
                                
       D149                     _SYS06:     ;(BDOS)コンソール直接入出力
000CD3 D149 7B               4      LD  A,E
000CD4 D14A 3C               4      INC A
000CD5 D14B CACAE5          10      JP  Z,_INKEY
000CD8 D14E C3CDE5          10      JP  _PRINT
                                
       D151                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000CDB D151 CD09E5          17      CALL    _SYS07
000CDE D154 FE03             7      CP  3
000CE0 D156 CCF4E5          17      CALL    Z,_BREAK
000CE3 D159 FE13             7      CP  013H        ;CTRL+S
000CE5 D15B C0              11      RET NZ
       D15C                     PAUSE:
000CE6 D15C CD76D1          17      CALL    KEYBC
                                
       D15F                     BREAK:
000CE9 D15F F5              11      PUSH    AF
000CEA D160 C5              11      PUSH    BC
000CEB D161 D5              11      PUSH    DE
000CEC D162 E5              11      PUSH    HL
000CED D163 DDE5            15      PUSH    IX
000CEF D165 DD21B700        14      LD  IX,BREAKX
000CF3 D169 CD88D3          17      CALL    CALSLT_R
000CF6 D16C DDE1            14      POP IX
000CF8 D16E E1              10      POP HL
000CF9 D16F D1              10      POP DE
000CFA D170 C1              10      POP BC
000CFB D171 DCF4E5          17      CALL    C,_BREAK
000CFE D174 F1              10      POP AF
000CFF D175 C9              10      RET
       D176                     KEYBC:
000D00 D176 F5              11      PUSH    AF
000D01 D177 C5              11      PUSH    BC
000D02 D178 D5              11      PUSH    DE
000D03 D179 E5              11      PUSH    HL
000D04 D17A DDE5            15      PUSH    IX
000D06 D17C DD215601        14      LD  IX,KILBUF
000D0A D180 CD88D3          17      CALL    CALSLT_R
000D0D D183 DDE1            14      POP IX
000D0F D185 E1              10      POP HL
000D10 D186 D1              10      POP DE
000D11 D187 C1              10      POP BC
000D12 D188 F1              10      POP AF
000D13 D189 C9              10      RET
       D18A                     FLGET:
000D14 D18A C5              11      PUSH    BC
000D15 D18B D5              11      PUSH    DE
000D16 D18C E5              11      PUSH    HL
000D17 D18D DDE5            15      PUSH    IX
000D19 D18F CDDFE5          17      CALL    _FFLUSH
000D1C D192 181B            12      JR  FLGET1
       D193                     CBIOS_SWC1  EQU $-1
000D1E D194 CD70D3          17      CALL    GETVRAM
                                
000D21 D197 E5              11      PUSH    HL
000D22 D198 DD214A00        14      LD  IX,RDVRM
000D26 D19C CD88D3          17      CALL    CALSLT_R
000D29 D19F E1              10      POP HL
000D2A D1A0 32BBD1          13      LD  (SWCCHR),A
                                
000D2D D1A3 E5              11      PUSH    HL
000D2E D1A4 3EFF             7      LD  A,0FFH
000D30 D1A6 DD214D00        14      LD  IX,WRTVRM
000D34 D1AA CD88D3          17      CALL    CALSLT_R
000D37 D1AD E1              10      POP HL
                                
000D38 D1AE E5              11      PUSH    HL
       D1AF                     FLGET1:
000D39 D1AF DD219F00        14      LD  IX,CHGET
000D3D D1B3 CD88D3          17      CALL    CALSLT_R
000D40 D1B6 180C            12      JR  FLGET2
       D1B7                     CBIOS_SWC2  EQU $-1
000D42 D1B8 E1              10      POP HL
                                
000D43 D1B9 F5              11      PUSH    AF
000D44 D1BA 3E00             7      LD  A,0
       D1BB                     SWCCHR  EQU $-1
000D46 D1BC DD214D00        14      LD  IX,WRTVRM
000D4A D1C0 CD88D3          17      CALL    CALSLT_R
000D4D D1C3 F1              10      POP AF
       D1C4                     FLGET2:
000D4E D1C4 DDE1            14      POP IX
000D50 D1C6 E1              10      POP HL
000D51 D1C7 D1              10      POP DE
000D52 D1C8 C1              10      POP BC
000D53 D1C9 FE03             7      CP  3
000D55 D1CB C0              11      RET NZ
000D56 D1CC C300E5          10      JP  CPM_BOOT
                                
       D1CF                     INKEY:
000D59 D1CF CD06E5          17      CALL    CPM_CONST
000D5C D1D2 C8              11      RET Z
000D5D D1D3 18B5            12      JR  FLGET
                                
       D1D5                     _SYS0A:     ;(BDOS)文字列入力
000D5F D1D5 C5              11      PUSH    BC
000D60 D1D6 E5              11      PUSH    HL
000D61 D1D7 D5              11      PUSH    DE
000D62 D1D8 CD01D2          17      CALL    GETL
000D65 D1DB 111FF4          10      LD  DE,KBUF
000D68 D1DE E1              10      POP HL
000D69 D1DF E5              11      PUSH    HL
000D6A D1E0 0E00             7      LD  C,0
000D6C D1E2 3004            12      JR  NC,SAX0
000D6E D1E4 23               6      INC HL
000D6F D1E5 23               6      INC HL
000D70 D1E6 1808            12      JR  SAX4
       D1E8                     SAX0:
000D72 D1E8 46               7      LD  B,(HL)
000D73 D1E9 23               6      INC HL
       D1EA                     SAX1:
000D74 D1EA 23               6      INC HL
000D75 D1EB 1A               7      LD  A,(DE)
000D76 D1EC 13               6      INC DE
000D77 D1ED B7               4      OR  A
000D78 D1EE 2004            12      JR  NZ,SAX2
       D1F0                     SAX4:
000D7A D1F0 360D            10      LD  (HL),00DH
000D7C D1F2 1804            12      JR  SAX3
       D1F4                     SAX2:
000D7E D1F4 77               7      LD  (HL),A
000D7F D1F5 0C               4      INC C
000D80 D1F6 10F2            13      DJNZ    SAX1
       D1F8                     SAX3:
000D82 D1F8 D1              10      POP DE
000D83 D1F9 79               4      LD  A,C
000D84 D1FA 13               6      INC DE
000D85 D1FB 12               7      LD  (DE),A
000D86 D1FC 1B               6      DEC DE
000D87 D1FD E1              10      POP HL
000D88 D1FE C1              10      POP BC
000D89 D1FF A7               4      AND A
000D8A D200 C9              10      RET
       D201                     GETL:
000D8B D201 DDE5            15      PUSH    IX
000D8D D203 FDE5            15      PUSH    IY
                                
000D8F D205 2ADCF3          16      LD  HL,(CSRY)
000D92 D208 22CAFB          16      LD  (FSTPOS),HL
       D20B                     GETL1:
000D95 D20B CD51D1          17      CALL    _SYS08
000D98 D20E FE09             7      CP  9
000D9A D210 2008            12      JR  NZ,GETL1V
000D9C D212 211FF4          10      LD  HL,KBUF
000D9F D215 CD82CE          17      CALL    MSX
000DA2 D218 18F1            12      JR  GETL1
       D21A                     GETL1V:
000DA4 D21A 5F               4      LD  E,A
000DA5 D21B FE08             7      CP  8
000DA7 D21D CC16D3          17      CALL    Z,CTRL02
000DAA D220 FE20             7      CP  020H
000DAC D222 D442D3          17      CALL    NC,INSERT
000DAF D225 CD19D1          17      CALL    MSGA1
                                
000DB2 D228 7B               4      LD  A,E
000DB3 D229 FE0D             7      CP  00DH
000DB5 D22B 20DE            12      JR  NZ,GETL1
                                
000DB7 D22D 111FF4          10      LD  DE,KBUF
000DBA D230 3AB0F3          13      LD  A,(LINLEN)
000DBD D233 47               4      LD  B,A
000DBE D234 CD26CD          17      CALL    ZERO_MEMORY_DE
                                
000DC1 D237 2ACAFB          16      LD  HL,(FSTPOS)
000DC4 D23A 3ADCF3          13      LD  A,(CSRY)
000DC7 D23D 6F               4      LD  L,A
000DC8 D23E E5              11      PUSH    HL
000DC9 D23F CD73D3          17      CALL    LOC0
000DCC D242 4D               4      LD  C,L
000DCD D243 44               4      LD  B,H
000DCE D244 E1              10      POP HL
000DCF D245 3AB0F3          13      LD  A,(LINLEN)
000DD2 D248 94               4      SUB H
000DD3 D249 3D               4      DEC A
000DD4 D24A 5F               4      LD  E,A
000DD5 D24B 211FF4          10      LD  HL,KBUF
       D24E                     GETL2:
000DD8 D24E CDD0E5          17      CALL    _SCRN
000DDB D251 03               6      INC BC
000DDC D252 77               7      LD  (HL),A
000DDD D253 23               6      INC HL
000DDE D254 1D               4      DEC E
000DDF D255 20F7            12      JR  NZ,GETL2
000DE1 D257 CD36D1          17      CALL    MSG_CR
                                
000DE4 D25A FDE1            14      POP IY
000DE6 D25C DDE1            14      POP IX
       D25E                     GETL3:
000DE8 D25E 2B               6      DEC HL
000DE9 D25F 7E               7      LD  A,(HL)
000DEA D260 FE21             7      CP  021H
000DEC D262 D0              11      RET NC
000DED D263 3600            10      LD  (HL),0
000DEF D265 15               4      DEC D
000DF0 D266 20F6            12      JR  NZ,GETL3
000DF2 D268 C9              10      RET
                                
       D269                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       D269                     CONSTX:
000DF3 D269 C5              11      PUSH    BC
000DF4 D26A D5              11      PUSH    DE
000DF5 D26B E5              11      PUSH    HL
000DF6 D26C DDE5            15      PUSH    IX
000DF8 D26E DD219C00        14      LD  IX,CHSNS
000DFC D272 CD88D3          17      CALL    CALSLT_R
000DFF D275 DDE1            14      POP IX
000E01 D277 E1              10      POP HL
000E02 D278 D1              10      POP DE
000E03 D279 C1              10      POP BC
000E04 D27A C9              10      RET
                                
       D27B                     _SYS2A:     ;(BDOS)日付の獲得
000E05 D27B 0E0B             7      LD  C,11        ;年/Year→HL
000E07 D27D CDBCD2          17      CALL    RDCLK_BCD
000E0A D280 6F               4      LD  L,A
000E0B D281 2600             7      LD  H,0
000E0D D283 3AF8FA          13      LD  A,(EXBRSA)
000E10 D286 B7               4      OR  A
000E11 D287 2804            12      JR  Z,SX2A1
000E13 D289 11BC07          10      LD  DE,1980     ;1980年～2079年
000E16 D28C 19              11      ADD HL,DE
       D28D                     SX2A1:
000E17 D28D 0E09             7      LD  C,9     ;月/Month→D
000E19 D28F CDBCD2          17      CALL    RDCLK_BCD
000E1C D292 57               4      LD  D,A
                                
000E1D D293 0E07             7      LD  C,7     ;日/Day→E
000E1F D295 CDBCD2          17      CALL    RDCLK_BCD
000E22 D298 5F               4      LD  E,A
                                
000E23 D299 0E06             7      LD  C,6     ;曜日/Week→A
       D29B                     RDCLK:
000E25 D29B DDE5            15      PUSH    IX
000E27 D29D DD21F501        14      LD  IX,REDCLK
       D2A1                     WRCLK1:
000E2B D2A1 3AF8FA          13      LD  A,(EXBRSA)
000E2E D2A4 B7               4      OR  A
000E2F D2A5 280A            12      JR  Z,RDCLK1    ;MSX1
000E31 D2A7 FDE5            15      PUSH    IY
000E33 D2A9 FD67             9      LD  IYH,A
000E35 D2AB 78               4      LD  A,B
000E36 D2AC CDA4D3          17      CALL    CALSLTR
000E39 D2AF FDE1            14      POP IY
       D2B1                     RDCLK1:
000E3B D2B1 DDE1            14      POP IX
000E3D D2B3 C9              10      RET
       D2B4                     WRCLK:
000E3E D2B4 DDE5            15      PUSH    IX
000E40 D2B6 DD21F901        14      LD  IX,WRTCLK
000E44 D2BA 18E5            12      JR  WRCLK1
                                
       D2BC                     RDCLK_BCD:
000E46 D2BC CD9BD2          17      CALL    RDCLK       ;1の位
000E49 D2BF 47               4      LD  B,A
000E4A D2C0 0C               4      INC C
000E4B D2C1 CD9BD2          17      CALL    RDCLK       ;10の位
000E4E D2C4 87               4      ADD A,A     ;*2
000E4F D2C5 4F               4      LD  C,A
000E50 D2C6 87               4      ADD A,A     ;*4
000E51 D2C7 87               4      ADD A,A     ;*8
000E52 D2C8 81               4      ADD A,C     ;*10(8+2)
000E53 D2C9 80               4      ADD A,B     ;1の位
000E54 D2CA C9              10      RET
                                
       D2CB                     _SYS2C:     ;(BDOS)時刻の獲得
000E55 D2CB 011501          10      LD  BC,00115H       ;12時間計/24時間計の設定を24時間計に
000E58 D2CE CDB4D2          17      CALL    WRCLK
000E5B D2D1 0E04             7      LD  C,4     ;H=時/Hour
000E5D D2D3 CDBCD2          17      CALL    RDCLK_BCD
000E60 D2D6 67               4      LD  H,A
000E61 D2D7 0E02             7      LD  C,2     ;L=分/Minute
000E63 D2D9 CDBCD2          17      CALL    RDCLK_BCD
000E66 D2DC 6F               4      LD  L,A
000E67 D2DD 0E00             7      LD  C,0     ;D=秒/Second
000E69 D2DF CDBCD2          17      CALL    RDCLK_BCD
000E6C D2E2 57               4      LD  D,A
000E6D D2E3 AF               4      XOR A       ;E=1/100秒
000E6E D2E4 5F               4      LD  E,A
000E6F D2E5 C9              10      RET
                                
       D2E6                     POS:
000E70 D2E6 F5              11      PUSH    AF
000E71 D2E7 2ADCF3          16      LD  HL,(CSRY)
000E74 D2EA 7D               4      LD  A,L
000E75 D2EB 6C               4      LD  L,H
000E76 D2EC 67               4      LD  H,A
000E77 D2ED 2C               4      INC L
000E78 D2EE 24               4      INC H
000E79 D2EF F1              10      POP AF
000E7A D2F0 C9              10      RET
                                
       D2F1                     LOC:
000E7B D2F1 F5              11      PUSH    AF
000E7C D2F2 E5              11      PUSH    HL
000E7D D2F3 7D               4      LD  A,L
000E7E D2F4 6C               4      LD  L,H
000E7F D2F5 67               4      LD  H,A
000E80 D2F6 2D               4      DEC L
000E81 D2F7 25               4      DEC H
000E82 D2F8 DDE5            15      PUSH    IX
000E84 D2FA DD21C600        14      LD  IX,POSIT
000E88 D2FE CD88D3          17      CALL    CALSLT_R
000E8B D301 DDE1            14      POP IX
000E8D D303 E1              10      POP HL
000E8E D304 F1              10      POP AF
000E8F D305 C9              10      RET
       D306                     SCRN:
000E90 D306 E5              11      PUSH    HL
000E91 D307 DDE5            15      PUSH    IX
                                
000E93 D309 69               4      LD  L,C
000E94 D30A 60               4      LD  H,B
000E95 D30B DD214A00        14      LD  IX,RDVRM
000E99 D30F CD88D3          17      CALL    CALSLT_R
                                
000E9C D312 DDE1            14      POP IX
000E9E D314 E1              10      POP HL
000E9F D315 C9              10      RET
                                
       D316                     CTRL02:
000EA0 D316 F5              11      PUSH    AF
000EA1 D317 D5              11      PUSH    DE
000EA2 D318 2ADCF3          16      LD  HL,(CSRY)
000EA5 D31B 3AB0F3          13      LD  A,(LINLEN)
000EA8 D31E 4F               4      LD  C,A
000EA9 D31F 94               4      SUB H   ;CSRX
000EAA D320 C602             7      ADD A,2
000EAC D322 47               4      LD  B,A ;カーソルより右の文字数
000EAD D323 61               4      LD  H,C ;LINLEN
000EAE D324 C5              11      PUSH    BC
000EAF D325 CD73D3          17      CALL    LOC0
000EB2 D328 C1              10      POP BC
                                
000EB3 D329 1620             7      LD  D,020H
       D32B                     C8X1:
000EB5 D32B DD214A00        14      LD  IX,RDVRM
000EB9 D32F CD88D3          17      CALL    CALSLT_R
000EBC D332 4F               4      LD  C,A
000EBD D333 7A               4      LD  A,D
000EBE D334 DD214D00        14      LD  IX,WRTVRM
000EC2 D338 CD88D3          17      CALL    CALSLT_R
000EC5 D33B 2B               6      DEC HL
000EC6 D33C 51               4      LD  D,C
000EC7 D33D 10EC            13      DJNZ    C8X1
000EC9 D33F D1              10      POP DE
000ECA D340 F1              10      POP AF
000ECB D341 C9              10      RET
                                
       D342                     INSERT:
000ECC D342 F5              11      PUSH    AF
000ECD D343 D5              11      PUSH    DE
000ECE D344 2ADCF3          16      LD  HL,(CSRY)
000ED1 D347 3AB0F3          13      LD  A,(LINLEN)
000ED4 D34A 4F               4      LD  C,A
000ED5 D34B 94               4      SUB H   ;CSRX
000ED6 D34C 3C               4      INC A
000ED7 D34D 47               4      LD  B,A ;カーソルより右の文字数
000ED8 D34E C5              11      PUSH    BC
000ED9 D34F CD73D3          17      CALL    LOC0
000EDC D352 C1              10      POP BC
                                
000EDD D353 1620             7      LD  D,020H
       D355                     INS1:
000EDF D355 DD214A00        14      LD  IX,RDVRM
000EE3 D359 CD88D3          17      CALL    CALSLT_R
000EE6 D35C 4F               4      LD  C,A
000EE7 D35D 7A               4      LD  A,D
000EE8 D35E DD214D00        14      LD  IX,WRTVRM
000EEC D362 CD88D3          17      CALL    CALSLT_R
000EEF D365 23               6      INC HL
000EF0 D366 51               4      LD  D,C
000EF1 D367 10EC            13      DJNZ    INS1
000EF3 D369 D1              10      POP DE
000EF4 D36A F1              10      POP AF
000EF5 D36B C9              10      RET
                                
       D36C                     CONOUT1:
000EF6 D36C 59               4      LD  E,C
000EF7 D36D C3CDE5          10      JP  _PRINT
                                
       D370                     GETVRAM:
000EFA D370 2ADCF3          16      LD  HL,(CSRY)
       D373                     LOC0:
000EFD D373 2D               4      DEC L
000EFE D374 25               4      DEC H
000EFF D375 4C               4      LD  C,H ;CSRX-1
000F00 D376 5D               4      LD  E,L ;CSRY-1
       D377                     LOC1:
000F01 D377 3AB0F3          13      LD  A,(LINLEN)
000F04 D37A 67               4      LD  H,A
000F05 D37B 1600             7      LD  D,0
000F07 D37D 6A               4      LD  L,D ;0
000F08 D37E 0608             7      LD  B,8
       D380                     LOC2:
000F0A D380 29              11      ADD HL,HL
000F0B D381 3001            12      JR  NC,LOC3
000F0D D383 19              11      ADD HL,DE
       D384                     LOC3:
000F0E D384 10FA            13      DJNZ    LOC2
000F10 D386 09              11      ADD HL,BC
000F11 D387 C9              10      RET
                                
       D388                     CALSLT_R:
000F12 D388 FDE5            15      PUSH    IY
000F14 D38A FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000F18 D38E CDA4D3          17      CALL    CALSLTR
000F1B D391 FDE1            14      POP IY
000F1D D393 C9              10      RET
                                
       D394                     CALLF:
000F1E D394 08               4      EX  AF,AF'
000F1F D395 E3              19      EX  (SP),HL
000F20 D396 7E               7      LD  A,(HL)
000F21 D397 FD67             9      LD  IYH,A
000F23 D399 23               6      INC HL
000F24 D39A 7E               7      LD  A,(HL)
000F25 D39B DD6F             9      LD  IXL,A
000F27 D39D 23               6      INC HL
000F28 D39E 7E               7      LD  A,(HL)
000F29 D39F DD67             9      LD  IXH,A
000F2B D3A1 23               6      INC HL
000F2C D3A2 E3              19      EX  (SP),HL
000F2D D3A3 08               4      EX  AF,AF'
       D3A4                     CALSLTR:
000F2E D3A4 F3               4      DI
000F2F D3A5 ED73DED3        20      LD  (CSSP),SP
000F33 D3A9 F5              11      PUSH    AF
000F34 D3AA 3E1C             7      LD  A,_CALSLT
       D3AC                     SLTCALL:
000F36 D3AC 32CBD3          13      LD  (SLTCALLX),A
000F39 D3AF 3ADFD3          13      LD  A,(CSSP+1)
000F3C D3B2 FE41             7      CP  040H+1
000F3E D3B4 3005            12      JR  NC,CALSLTR1
000F40 D3B6 F1              10      POP AF
000F41 D3B7 315EF5          10      LD  SP,BUF
000F44 D3BA F5              11      PUSH    AF
       D3BB                     CALSLTR1:
000F45 D3BB C5              11      PUSH    BC
000F46 D3BC D5              11      PUSH    DE
000F47 D3BD E5              11      PUSH    HL
000F48 D3BE 2600             7      LD  H,0
000F4A D3C0 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
000F4D D3C3 CDE2D4          17      CALL    ENASLT
000F50 D3C6 E1              10      POP HL
000F51 D3C7 D1              10      POP DE
000F52 D3C8 C1              10      POP BC
000F53 D3C9 F1              10      POP AF
000F54 D3CA CD1C00          17      CALL    _CALSLT
       D3CB                     SLTCALLX    EQU $-2
000F57 D3CD F5              11      PUSH    AF
000F58 D3CE C5              11      PUSH    BC
000F59 D3CF D5              11      PUSH    DE
000F5A D3D0 E5              11      PUSH    HL
000F5B D3D1 2600             7      LD  H,0
000F5D D3D3 3A41F3          13      LD  A,(0F341H)  ;メインRAMに戻す
000F60 D3D6 CDE2D4          17      CALL    ENASLT
000F63 D3D9 E1              10      POP HL
000F64 D3DA D1              10      POP DE
000F65 D3DB C1              10      POP BC
000F66 D3DC F1              10      POP AF
000F67 D3DD 310000          10      LD  SP,0
       D3DE                     CSSP    EQU $-2
000F6A D3E0 FB               4      EI
000F6B D3E1 C9              10      RET
                                
       D3E2                     RDSLTR:
000F6C D3E2 ED73DED3        20      LD  (CSSP),SP
000F70 D3E6 F5              11      PUSH    AF
000F71 D3E7 3E0C             7      LD  A,_RDSLT
000F73 D3E9 18C1            12      JR  SLTCALL
                                
       D3EB                     WRSLTR:
000F75 D3EB ED73DED3        20      LD  (CSSP),SP
000F79 D3EF F5              11      PUSH    AF
000F7A D3F0 3E14             7      LD  A,_WRSLT
000F7C D3F2 18B8            12      JR  SLTCALL
                                
       D3F4                     INT38H:
000F7E D3F4 F5              11      PUSH    AF
000F7F D3F5 E5              11      PUSH    HL          ;メインROMを呼び出すのでスタックが被っていないかチェック
000F80 D3F6 2A20D4          16      LD  HL,(INTSP)
000F83 D3F9 7C               4      LD  A,H
000F84 D3FA B5               4      OR  L
000F85 D3FB 202D            12      JR  NZ,INT38H2
000F87 D3FD C5              11      PUSH    BC
000F88 D3FE D5              11      PUSH    DE
000F89 D3FF 2100BF          10      LD  HL,010000H-04100H   ;Page1
000F8C D402 39              11      ADD HL,SP
000F8D D403 ED7320D4        20      LD  (INTSP),SP
000F91 D407 3803            12      JR  C,INT38H1
000F93 D409 315EF5          10      LD  SP,BUF
       D40C                     INT38H1:
000F96 D40C 2600             7      LD  H,0
000F98 D40E 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
000F9B D411 CDE2D4          17      CALL    ENASLT
000F9E D414 CD3800          17      CALL    00038H
000FA1 D417 2600             7      LD  H,0
000FA3 D419 3A41F3          13      LD  A,(0F341H)  ;メインRAMに戻す
000FA6 D41C CDE2D4          17      CALL    ENASLT
000FA9 D41F 310000          10      LD  SP,0
       D420                     INTSP   EQU $-2
000FAC D422 210000          10      LD  HL,0
000FAF D425 2220D4          16      LD  (INTSP),HL
000FB2 D428 D1              10      POP DE
000FB3 D429 C1              10      POP BC
       D42A                     INT38H2:
000FB4 D42A E1              10      POP HL
000FB5 D42B F1              10      POP AF
000FB6 D42C FB               4      EI
000FB7 D42D C9              10      RET
                                
[EOF:MSXIO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       D5C5                     FILEC:
00114F D5C5 CDD0D5          17      CALL    FILE
       D5C8                     FILEC2:
001152 D5C8 3A15E5          13      LD  A,(FDRV+1)
001155 D5CB FE20             7      CP  020H
001157 D5CD C8              11      RET Z
001158 D5CE 1839            12      JR  SETDIR1
                                
       D5D0                     FILE:
00115A D5D0 AF               4      XOR A
00115B D5D1 3214E5          13      LD  (FDRV),A
00115E D5D4 67               4      LD  H,A
00115F D5D5 6F               4      LD  L,A
001160 D5D6 2222E5          16      LD  (FDRV+14),HL
001163 D5D9 CDA6D6          17      CALL    SPCUT
001166 D5DC CD8BD6          17      CALL    CCHK3
001169 D5DF 2812            12      JR  Z,DEVI1
00116B D5E1 13               6      INC DE
00116C D5E2 1A               7      LD  A,(DE)
00116D D5E3 1B               6      DEC DE
00116E D5E4 FE3A             7      CP  ':'
001170 D5E6 200B            12      JR  NZ,DEVI1
001172 D5E8 1A               7      LD  A,(DE)      ;DRIVE
001173 D5E9 CDECD8          17      CALL    CAP
001176 D5EC D640             7      SUB '@'
001178 D5EE 13               6      INC DE
001179 D5EF 13               6      INC DE
00117A D5F0 3214E5          13      LD  (FDRV),A
       D5F3                     DEVI1:
00117D D5F3 1A               7      LD  A,(DE)
00117E D5F4 D65C             7      SUB 05CH        ;\
001180 D5F6 2009            12      JR  NZ,NOROOT
001182 D5F8 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
001183 D5F9 222EE5          16      LD  (FDRV+26),HL
001186 D5FC 2C               4      INC L
001187 D5FD 2222E5          16      LD  (FDRV+14),HL
00118A D600 13               6      INC DE
       D601                     NOROOT:
                                
       D601                     SETDIR:
00118B D601 CD2CD6          17      CALL    FILED
00118E D604 1A               7      LD  A,(DE)
00118F D605 FE5C             7      CP  05CH        ;\
001191 D607 C0              11      RET NZ
001192 D608 13               6      INC DE
       D609                     SETDIR1:
001193 D609 3E10             7      LD  A,010H      ;Directory
001195 D60B 3221E5          13      LD  (FDRV+13),A
001198 D60E D5              11      PUSH    DE
001199 D60F 1114E5          10      LD  DE,FDRV
00119C D612 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
00119E D614 CD42CE          17      CALL    BDOS0
0011A1 D617 D1              10      POP DE
0011A2 D618 B7               4      OR  A
0011A3 D619 C0              11      RET NZ
                                
0011A4 D61A 3A21E5          13      LD  A,(FDRV+13)
0011A7 D61D E610             7      AND 010H        ;ディレクトリ
0011A9 D61F C8              11      RET Z
                                
0011AA D620 CD73D6          17      CALL    FILEI
0011AD D623 2A2EE5          16      LD  HL,(FDRV+26)
0011B0 D626 23               6      INC HL
0011B1 D627 2222E5          16      LD  (FDRV+14),HL
0011B4 D62A 18D5            12      JR  SETDIR
                                
       D62C                     FILED:
0011B6 D62C CD73D6          17      CALL    FILEI
0011B9 D62F 2115E5          10      LD  HL,FNAME
                                
0011BC D632 0608             7      LD  B,8
       D634                     FILE2:
0011BE D634 CD80D6          17      CALL    CCHKF
0011C1 D637 C8              11      RET Z
0011C2 D638 FE2A             7      CP  '*'
0011C4 D63A 282E            12      JR  Z,FILE9
0011C6 D63C FE2E             7      CP  '.'
0011C8 D63E 280C            12      JR  Z,FILE4
0011CA D640 77               7      LD  (HL),A
0011CB D641 23               6      INC HL
0011CC D642 10F0            13      DJNZ    FILE2
                                
       D644                     FILE3:
0011CE D644 CD80D6          17      CALL    CCHKF
0011D1 D647 C8              11      RET Z
0011D2 D648 FE2E             7      CP  '.'
0011D4 D64A 20F8            12      JR  NZ,FILE3
                                
       D64C                     FILE4:
0011D6 D64C 211DE5          10      LD  HL,FNAME+8
0011D9 D64F 0603             7      LD  B,3
                                
       D651                     FILE4L:
0011DB D651 CD80D6          17      CALL    CCHKF
0011DE D654 C8              11      RET Z
0011DF D655 FE2E             7      CP  '.'
0011E1 D657 2008            12      JR  NZ,FILE12
0011E3 D659 3215E5          13      LD  (FNAME),A   ;Parent directory(..)
0011E6 D65C 3216E5          13      LD  (FNAME+1),A
0011E9 D65F 3E20             7      LD  A,020H
       D661                     FILE12:
0011EB D661 FE2A             7      CP  '*'
0011ED D663 280A            12      JR  Z,FILE10
0011EF D665 77               7      LD  (HL),A
0011F0 D666 23               6      INC HL
0011F1 D667 10E8            13      DJNZ    FILE4L
0011F3 D669 C9              10      RET
                                
       D66A                     FILE9:              ;名前の*処理、名前の残りを?で埋める
0011F4 D66A CD6FD6          17      CALL    FILE10
0011F7 D66D 18D5            12      JR  FILE3
                                
       D66F                     FILE10:
0011F9 D66F 3E3F             7      LD  A,'?'
0011FB D671 1808            12      JR  FILL_MEMORY
       D673                     FILEI:              ;名前＋拡張子をスペースで初期化
0011FD D673 3E20             7      LD  A,020H
0011FF D675 01000B          10      LD  BC,11*256   ;C=0にしておく
001202 D678 2115E5          10      LD  HL,FNAME
       D67B                     FILL_MEMORY:            ;HLからBバイトAで埋める
001205 D67B 77               7      LD  (HL),A
001206 D67C 23               6      INC HL
001207 D67D 10FC            13      DJNZ    FILL_MEMORY
001209 D67F C9              10      RET
                                
       D680                     CCHKF:
00120A D680 1A               7      LD  A,(DE)
00120B D681 CD88D6          17      CALL    CCHK2
00120E D684 C8              11      RET Z
00120F D685 C3F4D9          10      JP  FKAN
                                
       D688                     CCHK2:
001212 D688 0C               4      INC C
001213 D689 0D               4      DEC C
001214 D68A C0              11      RET NZ
       D68B                     CCHK3:              ;ZF=1 で使えない文字
001215 D68B FE2B             7      CP  '+'
001217 D68D C8              11      RET Z
001218 D68E FE2C             7      CP  ','
00121A D690 C8              11      RET Z
00121B D691 FE2F             7      CP  '/'
00121D D693 C8              11      RET Z
00121E D694 FE3A             7      CP  ':'
001220 D696 C8              11      RET Z
001221 D697 FE3B             7      CP  ';'
001223 D699 C8              11      RET Z
001224 D69A FE3D             7      CP  '='
001226 D69C C8              11      RET Z
001227 D69D FE5C             7      CP  05CH    ;\
001229 D69F C8              11      RET Z
00122A D6A0 FE20             7      CP  020H
00122C D6A2 D0              11      RET NC
00122D D6A3 BF               4      CP  A       ;Z=1
00122E D6A4 C9              10      RET
                                
       D6A5                     SS1:
00122F D6A5 13               6      INC DE
       D6A6                     SPCUT:              ;スペースをカット
001230 D6A6 1A               7      LD  A,(DE)
001231 D6A7 FE20             7      CP  020H
001233 D6A9 28FA            12      JR  Z,SS1
001235 D6AB C9              10      RET
                                
       D6AC                     SETDRVF:
001236 D6AC 1114E5          10      LD  DE,FDRV
       D6AF                     SETDRV0:
001239 D6AF CDB8D6          17      CALL    SETDRV
00123C D6B2 FDE1            14      POP IY
00123E D6B4 C1              10      POP BC
00123F D6B5 D1              10      POP DE
001240 D6B6 E1              10      POP HL
001241 D6B7 C9              10      RET
                                
       D6B8                     SETDRV:
001242 D6B8 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
001243 D6B9 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
001244 D6BA C5              11      PUSH    BC
001245 D6BB 1A               7      LD  A,(DE)
001246 D6BC D5              11      PUSH    DE
001247 D6BD FDE3            23      EX  (SP),IY
                                
001249 D6BF CDC6D6          17      CALL    GETDRV
00124C D6C2 CDD9E5          17      CALL    _CHGDRV
                                
00124F D6C5 E9               4      JP  (HL)
                                
       D6C6                     GETDRV:
001250 D6C6 CDD9D6          17      CALL    GETDRV1
001253 D6C9 3288E5          13      LD  (_DRV),A
001256 D6CC C9              10      RET
                                
       D6CD                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
001257 D6CD CDD9D6          17      CALL    GETDRV1
00125A D6D0 C5              11      PUSH    BC
00125B D6D1 4F               4      LD  C,A
00125C D6D2 1A               7      LD  A,(DE)
00125D D6D3 CDD9D6          17      CALL    GETDRV1
001260 D6D6 A9               4      XOR C
001261 D6D7 C1              10      POP BC
001262 D6D8 C9              10      RET
       D6D9                     GETDRV1:
001263 D6D9 E67F             7      AND 07FH
001265 D6DB D601             7      SUB 001H
001267 D6DD D0              11      RET NC
001268 D6DE 3A0400          13      LD  A,(_DVSW)   ;Current Drive
00126B D6E1 C9              10      RET
                                
       D6E2                     SOPENX:
00126C D6E2 1139E5          10      LD  DE,SFILE
00126F D6E5 FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
001272 D6E8 CDCDD6          17      CALL    IS_SAME_DRV_A_DE
001275 D6EB 2024            12      JR  NZ,SOPEN
001277 D6ED 13               6      INC DE
001278 D6EE FDE5            15      PUSH    IY
00127A D6F0 E1              10      POP HL
00127B D6F1 23               6      INC HL
00127C D6F2 CD7DD8          17      CALL    CPFILE
00127F D6F5 201A            12      JR  NZ,SOPEN
                                
001281 D6F7 2AF4E6          16      LD  HL,(SCDIR)
001284 D6FA FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
001287 D6FD FD740F          19      LD  (IY+15),H
                                
00128A D700 2AF8E6          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
00128D D703 229FE5          16      LD  (_FILEN),HL
                                
001290 D706 ED5BF6E6        20      LD  DE,(SFBPS)
001294 D70A 2139E5          10      LD  HL,SFILE
001297 D70D 36FF            10      LD  (HL),0FFH
001299 D70F 23               6      INC HL
00129A D710 C9              10      RET
       D711                     SOPEN:
00129B D711 2125D8          10      LD  HL,FILESE
       D714                     SOPENC:
00129E D714 224DD7          16      LD  (OPENPAT),HL
                                
0012A1 D717 CDE2E5          17      CALL    _RDFATX     ;Detect Media
0012A4 D71A 3856            12      JR  C,RDDERR
                                
0012A6 D71C AF               4      XOR A
0012A7 D71D 329FE5          13      LD  (_FILEN),A
0012AA D720 CD29D9          17      CALL    LDDIRX1     ;A=0で呼び出す
0012AD D723 2818            12      JR  Z,SDIRX1
                                
0012AF D725 CD16D8          17      CALL    READ_DIR    ;Sub Directory
0012B2 D728 3808            12      JR  C,SDIRX0
0012B4 D72A 2A7EE6          16      LD  HL,(_DTBUF)
0012B7 D72D 7E               7      LD  A,(HL)
0012B8 D72E FE2E             7      CP  '.'
0012BA D730 280F            12      JR  Z,SOPEN1
       D732                     SDIRX0:
0012BC D732 AF               4      XOR A
0012BD D733 32A0E5          13      LD  (_DIRF),A
0012C0 D736 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
0012C4 D73A FD770F          19      LD  (IY+15),A
       D73D                     SDIRX1:
0012C7 D73D ED5BFCE6        20      LD  DE,(_DIRPS) ;Root Directory
       D741                     SOPEN1:
0012CB D741 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       D742                     SDECPAT EQU $-1
       D743                     SOPEN1X:
0012CD D743 CD16D8          17      CALL    READ_DIR    ;FILE SEARCH
0012D0 D746 382A            12      JR  C,RDDERR
0012D2 D748 2A7EE6          16      LD  HL,(_DTBUF)
       D74B                     SOPEN2:
0012D5 D74B D5              11      PUSH    DE
0012D6 D74C CD25D8          17      CALL    FILESE      ;(self-modifying code)
       D74D                     OPENPAT EQU $-2
0012D9 D74F D1              10      POP DE
0012DA D750 386D            12      JR  C,SOPENE
0012DC D752 281B            12      JR  Z,SCF_FF_RET
       D754                     SOPEN3:
0012DE D754 3AA0E5          13      LD  A,(_DIRF)   ;ディレクトリか判別
0012E1 D757 B7               4      OR  A
0012E2 D758 200C            12      JR  NZ,SOPEN5
0012E4 D75A 13               6      INC DE      ;ルートディレクトリ
0012E5 D75B E5              11      PUSH    HL
0012E6 D75C 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       D75D                     MD_PAT  EQU $-2
0012E9 D75F ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
0012EB D761 E1              10      POP HL
0012EC D762 20DD            12      JR  NZ,SOPEN1
0012EE D764 1807            12      JR  SOPEN6
       D766                     SOPEN5:
0012F0 D766 CD30E0          17      CALL    GNCLX       ;END DIR
0012F3 D769 D8              11      RET C
0012F4 D76A CDDDD8          17      CALL    ENDCL
       D76D                     SOPEN6:
0012F7 D76D 38D2            12      JR  C,SOPEN1
       D76F                     SCF_FF_RET:
0012F9 D76F 37               4      SCF         ;CF=1
0012FA D770 9F               4      SBC A,A     ;A=0FFH
0012FB D771 C9              10      RET
                                
       D772                     RDDERR:
0012FC D772 BF               4      CP  A       ;READ ERR CF=1 ZF=1
0012FD D773 37               4      SCF
0012FE D774 C9              10      RET
                                
       D775                     NOPEN:
0012FF D775 2125D8          10      LD  HL,FILESE
001302 D778 224DD7          16      LD  (OPENPAT),HL
001305 D77B FD2A98E5        20      LD  IY,(_FCB)
001309 D77F CD07DA          17      CALL    CHKWILDX
00130C D782 30EB            12      JR  NC,SCF_FF_RET
00130E D784 FD7E00          19      LD  A,(IY+0)
001311 D787 CDC6D6          17      CALL    GETDRV
001314 D78A CDD9E5          17      CALL    _CHGDRV
001317 D78D D8              11      RET C
001318 D78E 2AF8E6          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
00131B D791 229FE5          16      LD  (_FILEN),HL
                                
00131E D794 CD24D9          17      CALL    LDDIRX
001321 D797 ED5B9AE5        20      LD  DE,(_FBPS)
001325 D79B CD16D8          17      CALL    READ_DIR
001328 D79E 38D2            12      JR  C,RDDERR
00132A D7A0 3A9EE5          13      LD  A,(_FBCNT)
00132D D7A3 3D               4      DEC A
00132E D7A4 28AE            12      JR  Z,SOPEN3
       D7A6                     NOPEN2:
001330 D7A6 2A9CE5          16      LD  HL,(_FBAD)
001333 D7A9 012000          10      LD  BC,020H
001336 D7AC 09              11      ADD HL,BC
001337 D7AD 4F               4      LD  C,A
001338 D7AE 189B            12      JR  SOPEN2
                                
       D7B0                     SOPENE2:
00133A D7B0 229CE5          16      LD  (_FBAD),HL
00133D D7B3 79               4      LD  A,C
00133E D7B4 329EE5          13      LD  (_FBCNT),A
001341 D7B7 ED539AE5        20      LD  (_FBPS),DE
001345 D7BB FD2298E5        20      LD  (_FCB),IY
       D7BF                     SOPENE:
001349 D7BF AF               4      XOR A
00134A D7C0 C9              10      RET
                                
       D7C1                     COPEN:
00134B D7C1 FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
00134F D7C5 2142D8          10      LD  HL,NEXTSE
001352 D7C8 CD14D7          17      CALL    SOPENC
001355 D7CB D0              11      RET NC
001356 D7CC C8              11      RET Z
001357 D7CD 3AA0E5          13      LD  A,(_DIRF)   ;ディレクトリか判別
00135A D7D0 B7               4      OR  A
00135B D7D1 37               4      SCF
00135C D7D2 C8              11      RET Z       ;ルートディレクトリ
00135D D7D3 0601             7      LD  B,1
00135F D7D5 CD66DA          17      CALL    WRDF
001362 D7D8 D8              11      RET C
001363 D7D9 ED5BFEE6        20      LD  DE,(_CLPS)
001367 D7DD D5              11      PUSH    DE
001368 D7DE CDA6D8          17      CALL    DCPAT
00136B D7E1 CDB1DE          17      CALL    DRDNX
00136E D7E4 2A7EE6          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
001371 D7E7 ED4B9CDD        20      LD  BC,(SECSZ)  ;1セクタのサイズ
001375 D7EB AF               4      XOR A
       D7EC                     COPENCL:
001376 D7EC 77               7      LD  (HL),A
001377 D7ED EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001379 D7EF EAECD7          10      JP  PE,COPENCL
                                
00137C D7F2 3AC4D8          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
00137F D7F5 3D               4      DEC A
001380 D7F6 2819            12      JR  Z,COPENE
001382 D7F8 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
001384 D7FA 3228E0          13      LD  (_SECPS),A
001387 D7FD D1              10      POP DE      ;DE=(_CLPS)
001388 D7FE D5              11      PUSH    DE
       D7FF                     COPEN1:
001389 D7FF D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
00138A D800 C5              11      PUSH    BC
00138B D801 2A7EE6          16      LD  HL,(_DTBUF)
00138E D804 CDC0D8          17      CALL    CLUSTX
001391 D807 CDC5E1          17      CALL    DWT24
001394 D80A C1              10      POP BC
001395 D80B D1              10      POP DE
001396 D80C CD27E0          17      CALL    NEXTX
001399 D80F 20EE            12      JR  NZ,COPEN1
       D811                     COPENE:
00139B D811 2A7EE6          16      LD  HL,(_DTBUF)
00139E D814 D1              10      POP DE
00139F D815 C9              10      RET
                                
       D816                     READ_DIR:
0013A0 D816 ED53FEE6        20      LD  (_CLPS),DE
0013A4 D81A C5              11      PUSH    BC
0013A5 D81B D5              11      PUSH    DE
0013A6 D81C CDA6D8          17      CALL    DCPAT
0013A9 D81F CD91DE          17      CALL    DRDX
0013AC D822 D1              10      POP DE
0013AD D823 C1              10      POP BC
0013AE D824 C9              10      RET
                                
       D825                     FILESE:
0013AF D825 7E               7      LD  A,(HL)
0013B0 D826 B7               4      OR  A
0013B1 D827 C8              11      RET Z       ;END:ZF=1 CF=0
0013B2 D828 FEE5             7      CP  0E5H
0013B4 D82A 280E            12      JR  Z,FILESE1
0013B6 D82C FDE5            15      PUSH    IY
0013B8 D82E D1              10      POP DE
0013B9 D82F 13               6      INC DE
0013BA D830 E5              11      PUSH    HL
0013BB D831 CD7DD8          17      CALL    CPFILE
0013BE D834 CC9ED8          17      CALL    Z,CPFILE2
0013C1 D837 E1              10      POP HL
0013C2 D838 37               4      SCF
0013C3 D839 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       D83A                     FILESE1:
0013C4 D83A CD51D8          17      CALL    FNEXT
0013C7 D83D 20E6            12      JR  NZ,FILESE
       D83F                     ZF0_CF0_AFF_RET:
0013C9 D83F F6FF             7      OR  0FFH        ;ZF=0 CF=0
0013CB D841 C9              10      RET
                                
       D842                     NEXTSE:
0013CC D842 7E               7      LD  A,(HL)
0013CD D843 B7               4      OR  A
0013CE D844 37               4      SCF
0013CF D845 C8              11      RET Z       ;!!!:ZF=1 CF=1
0013D0 D846 FEE5             7      CP  0E5H
0013D2 D848 37               4      SCF
0013D3 D849 C8              11      RET Z       ;!!!:(ZF=1) CF=1
0013D4 D84A CD51D8          17      CALL    FNEXT
0013D7 D84D 20F3            12      JR  NZ,NEXTSE
0013D9 D84F 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       D851                     FNEXT:
0013DB D851 E5              11      PUSH    HL
0013DC D852 219FE5          10      LD  HL,_FILEN
0013DF D855 34              11      INC (HL)
0013E0 D856 E1              10      POP HL
0013E1 D857 112000          10      LD  DE,020H
0013E4 D85A 19              11      ADD HL,DE
0013E5 D85B 0D               4      DEC C
0013E6 D85C C9              10      RET
                                
       D85D                     CPNAME:
0013E7 D85D C5              11      PUSH    BC
0013E8 D85E D5              11      PUSH    DE
0013E9 D85F E5              11      PUSH    HL
0013EA D860 CD77D8          17      CALL    CPFILE4
0013ED D863 E1              10      POP HL
0013EE D864 23               6      INC HL
0013EF D865 23               6      INC HL
0013F0 D866 23               6      INC HL
0013F1 D867 23               6      INC HL
0013F2 D868 D1              10      POP DE
0013F3 D869 C1              10      POP BC
0013F4 D86A 2005            12      JR  NZ,CPNAME1
0013F6 D86C 7E               7      LD  A,(HL)
0013F7 D86D 23               6      INC HL
0013F8 D86E 66               7      LD  H,(HL)
0013F9 D86F 6F               4      LD  L,A
0013FA D870 C9              10      RET
       D871                     CPNAME1:
0013FB D871 23               6      INC HL
0013FC D872 23               6      INC HL
0013FD D873 10E8            13      DJNZ    CPNAME
0013FF D875 37               4      SCF
001400 D876 C9              10      RET
                                
       D877                     CPFILE4:
001401 D877 C5              11      PUSH    BC
001402 D878 010004          10      LD  BC,00400H
001405 D87B 1804            12      JR  CPSTR1
       D87D                     CPFILE:
001407 D87D C5              11      PUSH    BC
001408 D87E 01000B          10      LD  BC,00B00H
       D881                     CPSTR1:
00140B D881 1A               7      LD  A,(DE)
00140C D882 FE3F             7      CP  '?'     ;Wild card
00140E D884 2812            12      JR  Z,CPSTR2
001410 D886 7E               7      LD  A,(HL)
001411 D887 CDEDD9          17      CALL    FKANC
001414 D88A E5              11      PUSH    HL
001415 D88B 67               4      LD  H,A
001416 D88C 1A               7      LD  A,(DE)
001417 D88D CB01             8      RLC C
001419 D88F CDEDD9          17      CALL    FKANC
00141C D892 CB09             8      RRC C
00141E D894 BC               4      CP  H       ;CP (HL),(DE)
00141F D895 E1              10      POP HL
001420 D896 2004            12      JR  NZ,CPSTR3
       D898                     CPSTR2:
001422 D898 13               6      INC DE
001423 D899 23               6      INC HL
001424 D89A 10E5            13      DJNZ    CPSTR1
       D89C                     CPSTR3:
001426 D89C C1              10      POP BC
001427 D89D C9              10      RET
                                
       D89E                     CPFILE2:
001428 D89E FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
00142B D8A1 F6E1             7      OR  0E1H
00142D D8A3 2F               4      CPL
00142E D8A4 A6               7      AND (HL)
00142F D8A5 C9              10      RET
                                
       D8A6                     DCPAT:
001430 D8A6 0E00             7      LD  C,0
001432 D8A8 2A7EE6          16      LD  HL,(_DTBUF)
001435 D8AB 3AA0E5          13      LD  A,(_DIRF)   ;ディレクトリか判別
001438 D8AE B7               4      OR  A
001439 D8AF C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
00143A D8B0 3AC4D8          13      LD  A,(SPCPAT)
00143D D8B3 4F               4      LD  C,A
00143E D8B4 3A28E0          13      LD  A,(_SECPS)
001441 D8B7 B9               4      CP  C
001442 D8B8 3801            12      JR  C,DC1
001444 D8BA AF               4      XOR A
       D8BB                     DC1:
001445 D8BB F680             7      OR  080H
001447 D8BD 32A0E5          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       D8C0                     CLUSTX:
00144A D8C0 E5              11      PUSH    HL
00144B D8C1 EB               4      EX  DE,HL
00144C D8C2 AF               4      XOR A
00144D D8C3 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       D8C4                     SPCPAT  EQU $-1
       D8C5                     L_CLDBL:
00144F D8C5 CB19             8      RR  C       ;->CF
001451 D8C7 3804            12      JR  C,E_CLDBL
001453 D8C9 29              11      ADD HL,HL       ;*2
001454 D8CA 8F               4      ADC A,A
001455 D8CB 18F8            12      JR  L_CLDBL
       D8CD                     E_CLDBL:
001457 D8CD 4F               4      LD  C,A
001458 D8CE 3A28E0          13      LD  A,(_SECPS)
00145B D8D1 B5               4      OR  L
00145C D8D2 6F               4      LD  L,A
00145D D8D3 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       D8D4                     CLSPAT  EQU $-2
001460 D8D6 AF               4      XOR A
001461 D8D7 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
001462 D8D8 89               4      ADC A,C
001463 D8D9 4F               4      LD  C,A
001464 D8DA EB               4      EX  DE,HL
001465 D8DB E1              10      POP HL
001466 D8DC C9              10      RET
                                ;(8)
       D8DD                     ENDCL:
001467 D8DD 7A               4      LD  A,D ;END CLUSTER
001468 D8DE FE01             7      CP  1   ;164=356    (self-modifying code)
       D8DF                     CLPAT1  EQU $-1
00146A D8E0 C0              11      RET NZ
00146B D8E1 7B               4      LD  A,E
00146C D8E2 FE64             7      CP  064H    ;       (self-modifying code)
       D8E3                     CLPAT2  EQU $-1
00146E D8E4 C9              10      RET
                                ;(3)
       D8E5                     CAP4:
00146F D8E5 3EE5             7      LD  A,0E5H
001471 D8E7 C9              10      RET
                                                    ;for X1/88 ワークエリア
001472 D8E8 5BE5                    DW  _DISKE+1        ;DISKVE($F323)
001474 D8EA F5E5                    DW  _BREAK+1        ;BREAKV($F325)
                                
       D8EC                     CAP:            ;(9)
001476 D8EC FE61             7      CP  'a'
001478 D8EE D8              11      RET C
001479 D8EF FE7B             7      CP  'z'+1
00147B D8F1 D0              11      RET NC
00147C D8F2 D620             7      SUB 020H
00147E D8F4 C9              10      RET
                                ;(10)
       D8F5                     CAP2:
00147F D8F5 CDECD8          17      CALL    CAP
       D8F8                     CAP3:               ;
001482 D8F8 FE05             7      CP  5
001484 D8FA 28E9            12      JR  Z,CAP4
001486 D8FC FE21             7      CP  021H
001488 D8FE C9              10      RET
                                                    ;
       D8FF                     CHDIR:
001489 D8FF CDD6E2          17      CALL    GETDPBD
00148C D902 381D            12      JR  C,CHDIR2
00148E D904 DD751A          19      LD  (IX+DPB_SDIR),L
001491 D907 DD741B          19      LD  (IX+DPB_SDIR+1),H
001494 D90A 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       D90C                     LDDIR:
001496 D90C CDD6E2          17      CALL    GETDPBD
001499 D90F DD5E1A          19      LD  E,(IX+DPB_SDIR)
00149C D912 DD561B          19      LD  D,(IX+DPB_SDIR+1)
00149F D915 13               6      INC DE
0014A0 D916 FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0014A3 D919 FD720F          19      LD  (IY+15),D
0014A6 D91C 1B               6      DEC DE
0014A7 D91D AF               4      XOR A
0014A8 D91E 32A0E5          13      LD  (_DIRF),A
       D921                     CHDIR2:
0014AB D921 DDE1            14      POP IX
0014AD D923 C9              10      RET
                                
       D924                     LDDIRX:
0014AE D924 3AA0E5          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
0014B1 D927 E67F             7      AND 07FH
       D929                     LDDIRX1:
0014B3 D929 3228E0          13      LD  (_SECPS),A
0014B6 D92C FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0014B9 D92F FD560F          19      LD  D,(IY+15)
0014BC D932 1B               6      DEC DE
0014BD D933 CDDDD8          17      CALL    ENDCL
0014C0 D936 D40CD9          17      CALL    NC,LDDIR
       D939                     LDDIRS:
0014C3 D939 7A               4      LD  A,D
0014C4 D93A B3               4      OR  E
0014C5 D93B 32A0E5          13      LD  (_DIRF),A   ;ディレクトリか判別
0014C8 D93E C9              10      RET
                                
       D93F                     KILL:
0014C9 D93F CD07DA          17      CALL    CHKWILDX
0014CC D942 3834            12      JR  C,KILLW
0014CE D944 CDE2D6          17      CALL    SOPENX
       D947                     KILLS:
0014D1 D947 3E1F             7      LD  A,01FH
0014D3 D949 D48BD9          17      CALL    NC,CHKATT
0014D6 D94C D8              11      RET C
       D94D                     KILLSX:
0014D7 D94D 36E5            10      LD  (HL),0E5H   ;DIR
0014D9 D94F CDE3D9          17      CALL    WTDB
0014DC D952 111A00          10      LD  DE,01AH
0014DF D955 19              11      ADD HL,DE
0014E0 D956 5E               7      LD  E,(HL)
0014E1 D957 23               6      INC HL
0014E2 D958 56               7      LD  D,(HL)
       D959                     KILLS1:
0014E3 D959 CDDDD8          17      CALL    ENDCL
0014E6 D95C D0              11      RET NC      ;CF=0
0014E7 D95D 21FEFF          10      LD  HL,0-2
0014EA D960 19              11      ADD HL,DE
0014EB D961 D0              11      RET NC      ;DE= 0 or 1
0014EC D962 D5              11      PUSH    DE
0014ED D963 CDF7E5          17      CALL    _GNCL
0014F0 D966 ED53FEE6        20      LD  (_CLPS),DE
0014F4 D96A D1              10      POP DE
0014F5 D96B 210000          10      LD  HL,0
0014F8 D96E D4FAE5          17      CALL    NC,_SNCL
0014FB D971 D8              11      RET C
0014FC D972 ED5BFEE6        20      LD  DE,(_CLPS)  ;FAT
001500 D976 18E1            12      JR  KILLS1
                                
       D978                     KILLW:
001502 D978 CD11D7          17      CALL    SOPEN
       D97B                     KILLW1:
001505 D97B 380B            12      JR  C,KILLW2
001507 D97D CDB0D7          17      CALL    SOPENE2
00150A D980 CD47D9          17      CALL    KILLS
00150D D983 CD75D7          17      CALL    NOPEN
001510 D986 18F3            12      JR  KILLW1
       D988                     KILLW2:
001512 D988 C8              11      RET Z
001513 D989 3F               4      CCF
001514 D98A C9              10      RET
                                
       D98B                     CHKATT:
001515 D98B E5              11      PUSH    HL
001516 D98C 110B00          10      LD  DE,00BH
001519 D98F 19              11      ADD HL,DE
00151A D990 A6               7      AND (HL)
00151B D991 E1              10      POP HL
00151C D992 C8              11      RET Z
00151D D993 37               4      SCF
00151E D994 C9              10      RET
                                
       D995                     NAME:
00151F D995 CD07DA          17      CALL    CHKWILDX
001522 D998 D8              11      RET C
001523 D999 110400          10      LD  DE,4
001526 D99C 19              11      ADD HL,DE
001527 D99D 22B2D9          16      LD  (NAMEP),HL
00152A D9A0 23               6      INC HL
00152B D9A1 CD0BDA          17      CALL    CHKWILD
00152E D9A4 D8              11      RET C
                                
00152F D9A5 CDE2D6          17      CALL    SOPENX
001532 D9A8 3E0F             7      LD  A,00FH
001534 D9AA D48BD9          17      CALL    NC,CHKATT
001537 D9AD D8              11      RET C
                                
001538 D9AE FDE5            15      PUSH    IY
00153A D9B0 FD210000        14      LD  IY,0        ;自己書き換え
       D9B2                     NAMEP   EQU $-2
00153E D9B4 CDE2D6          17      CALL    SOPENX
001541 D9B7 FDE3            23      EX  (SP),IY
001543 D9B9 3F               4      CCF
001544 D9BA D411D7          17      CALL    NC,SOPEN
001547 D9BD EB               4      EX  DE,HL
001548 D9BE E1              10      POP HL
001549 D9BF D8              11      RET C
                                
       D9C0                     SETNAME:
00154A D9C0 01000B          10      LD  BC,11*256
00154D D9C3 23               6      INC HL
00154E D9C4 7E               7      LD  A,(HL)
00154F D9C5 FEE5             7      CP  0E5H
001551 D9C7 2004            12      JR  NZ,SNAME1
001553 D9C9 3E05             7      LD  A,5
001555 D9CB 180E            12      JR  SNAME3
       D9CD                     SNAME1:
001557 D9CD 7E               7      LD  A,(HL)
001558 D9CE 0C               4      INC C
001559 D9CF 0D               4      DEC C
00155A D9D0 2009            12      JR  NZ,SNAME3
00155C D9D2 CDECD8          17      CALL    CAP
00155F D9D5 FEA0             7      CP  0A0H
001561 D9D7 2002            12      JR  NZ,SNAME3
001563 D9D9 3E20             7      LD  A,020H
       D9DB                     SNAME3:
001565 D9DB 12               7      LD  (DE),A
001566 D9DC 7E               7      LD  A,(HL)
001567 D9DD 23               6      INC HL
001568 D9DE CDF4D9          17      CALL    FKAN
00156B D9E1 10EA            13      DJNZ    SNAME1
       D9E3                     WTDB:               ;バッファデータが更新された
00156D D9E3 3EFF             7      LD  A,0FFH
00156F D9E5 3239E5          13      LD  (SFILE),A
001572 D9E8 32A4E5          13      LD  (_WTDBF),A
001575 D9EB AF               4      XOR A
001576 D9EC C9              10      RET
                                
       D9ED                     FKANC:
001577 D9ED CB41             8      BIT 0,C
001579 D9EF CCF5D8          17      CALL    Z,CAP2
00157C D9F2 1801            12      JR  FKANX
       D9F4                     FKAN:           ;漢字チェック
00157E D9F4 13               6      INC DE
       D9F5                     FKANX:
00157F D9F5 CB41             8      BIT 0,C
001581 D9F7 CB81             8      RES 0,C
001583 D9F9 C0              11      RET NZ
001584 D9FA FE80             7      CP  080H
001586 D9FC D8              11      RET C
001587 D9FD FEA0             7      CP  0A0H
001589 D9FF 3803            12      JR  C,FKAN1
00158B DA01 FEE0             7      CP  0E0H
00158D DA03 D8              11      RET C
       DA04                     FKAN1:
00158E DA04 0C               4      INC C
00158F DA05 A7               4      AND A
001590 DA06 C9              10      RET
                                
       DA07                     CHKWILDX:
001591 DA07 FDE5            15      PUSH    IY
001593 DA09 E1              10      POP HL
001594 DA0A 23               6      INC HL
       DA0B                     CHKWILD:
001595 DA0B 060B             7      LD  B,11
001597 DA0D 3E3F             7      LD  A,'?'
       DA0F                     CHKWIL1:
001599 DA0F BE               7      CP  (HL)
00159A DA10 23               6      INC HL
00159B DA11 37               4      SCF
00159C DA12 C8              11      RET Z
00159D DA13 10FA            13      DJNZ    CHKWIL1
00159F DA15 AF               4      XOR A
0015A0 DA16 C9              10      RET
                                
       DA17                     SDIRENT:        ;IY=FCB HL=DIR
0015A1 DA17 D5              11      PUSH    DE
0015A2 DA18 E5              11      PUSH    HL
0015A3 DA19 FDE5            15      PUSH    IY
0015A5 DA1B D1              10      POP DE
0015A6 DA1C EB               4      EX  DE,HL
0015A7 DA1D CDC0D9          17      CALL    SETNAME
                                ;               Attribute
0015AA DA20 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0015AD DA23 12               7      LD  (DE),A
0015AE DA24 13               6      INC DE
                                ;               Reserved
0015AF DA25 AF               4      XOR A
0015B0 DA26 060A             7      LD  B,10
       DA28                     SDE1:
0015B2 DA28 12               7      LD  (DE),A
0015B3 DA29 13               6      INC DE
0015B4 DA2A 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
0015B6 DA2C 21E4E6          10      LD  HL,SDDATA       ;(FCB)更新年月日
0015B9 DA2F 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DA31                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
0015BB DA31 7E               7      LD  A,(HL)
0015BC DA32 23               6      INC HL
0015BD DA33 3238DA          13      LD  (SDPAT),A
0015C0 DA36 FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       DA38                     SDPAT   EQU $-1
0015C3 DA39 12               7      LD  (DE),A
0015C4 DA3A 13               6      INC DE
0015C5 DA3B 10F4            13      DJNZ    SDLOOP
                                
0015C7 DA3D AF               4      XOR A
0015C8 DA3E E1              10      POP HL
0015C9 DA3F D1              10      POP DE
0015CA DA40 C9              10      RET
                                
       DA41                     WOPEN:
0015CB DA41 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0015CE DA44 E61F             7      AND 01FH
0015D0 DA46 37               4      SCF
0015D1 DA47 C0              11      RET NZ
0015D2 DA48 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       DA4C                     TOPEN2:
0015D6 DA4C AF               4      XOR A
       DA4D                     TOPEN:              ;Initializes the time stamp
0015D7 DA4D FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
0015DB DA51 C9              10      RET
                                
       DA52                     WRDFX:
0015DC DA52 3AC4D8          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       DA55                     L_WRFX:
0015DF DA55 1F               4      RRA         ;->CF
0015E0 DA56 3806            12      JR  C,E_WRFX
0015E2 DA58 CB39             8      SRL C
0015E4 DA5A CB1C             8      RR  H       ;CH=CH/2
0015E6 DA5C 18F7            12      JR  L_WRFX
       DA5E                     E_WRFX:
0015E8 DA5E 41               4      LD  B,C
0015E9 DA5F 4C               4      LD  C,H
0015EA DA60 03               6      INC BC
0015EB DA61 3E37             7      LD  A,037H      ;SCF
0015ED DA63 32AEDE          13      LD  (DRDN1),A
                                
       DA66                     WRDF:               ;BCクラスタ分FATを確保する
0015F0 DA66 110200          10      LD  DE,2
0015F3 DA69 AF               4      XOR A
0015F4 DA6A 3228E0          13      LD  (_SECPS),A
       DA6D                     WRDF1:
0015F7 DA6D C5              11      PUSH    BC
0015F8 DA6E D5              11      PUSH    DE
0015F9 DA6F CDF7E5          17      CALL    _GNCL
0015FC DA72 381C            12      JR  C,WRDF3
0015FE DA74 7A               4      LD  A,D     ;空いているかチェック
0015FF DA75 B3               4      OR  E
001600 DA76 202A            12      JR  NZ,WRDF4
001602 DA78 E1              10      POP HL      ;HL=空いているクラスタ
001603 DA79 E5              11      PUSH    HL
001604 DA7A ED5BFEE6        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
001608 DA7E 22FEE6          16      LD  (_CLPS),HL
00160B DA81 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
00160C DA82 B3               4      OR  E
00160D DA83 2008            12      JR  NZ,WRDF2
00160F DA85 FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
001612 DA88 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
001615 DA8B 1803            12      JR  WRDF3
       DA8D                     WRDF2:
001617 DA8D CDFAE5          17      CALL    _SNCL
       DA90                     WRDF3:
00161A DA90 D1              10      POP DE
00161B DA91 C1              10      POP BC
00161C DA92 D8              11      RET C
00161D DA93 0B               6      DEC BC
00161E DA94 78               4      LD  A,B
00161F DA95 B1               4      OR  C
001620 DA96 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
001622 DA98 ED5BFEE6        20      LD  DE,(_CLPS)
001626 DA9C 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
001629 DA9F C3FAE5          10      JP  _SNCL
                                
       DAA2                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
00162C DAA2 D1              10      POP DE
00162D DAA3 C1              10      POP BC
       DAA4                     WRDF5:
00162E DAA4 13               6      INC DE
00162F DAA5 CDDDD8          17      CALL    ENDCL
001632 DAA8 38C3            12      JR  C,WRDF1
001634 DAAA 37               4      SCF
001635 DAAB C9              10      RET
                                
       DAAC                     RWXR:
001636 DAAC 3A9DDD          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       DAAF                     L_RWX:
001639 DAAF 1F               4      RRA     ;->CF
00163A DAB0 3808            12      JR  C,E_RWX
00163C DAB2 CB38             8      SRL B   ;BCH=BCH/2
00163E DAB4 CB19             8      RR  C   ;
001640 DAB6 CB1C             8      RR  H   ;
001642 DAB8 18F5            12      JR  L_RWX
       DABA                     E_RWX:
001644 DABA FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001647 DABD FD561B          19      LD  D,(IY+27)
00164A DAC0 AF               4      XOR A
00164B DAC1 3228E0          13      LD  (_SECPS),A
       DAC4                     RWX1:
00164E DAC4 ED53FEE6        20      LD  (_CLPS),DE
001652 DAC8 7A               4      LD  A,D
001653 DAC9 B3               4      OR  E
001654 DACA 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
001656 DACC 78               4      LD  A,B
001657 DACD B1               4      OR  C
001658 DACE B4               4      OR  H
001659 DACF C8              11      RET Z       ;RET BCH==0 => CF=0
                                
00165A DAD0 CD30E0          17      CALL    GNCLX
00165D DAD3 D8              11      RET C
00165E DAD4 7C               4      LD  A,H     ;
00165F DAD5 25               4      DEC H       ;
001660 DAD6 B7               4      OR  A       ;DEC BCH
001661 DAD7 2001            12      JR  NZ,RWX2     ;
001663 DAD9 0B               6      DEC BC      ;
       DADA                     RWX2:
001664 DADA CDDDD8          17      CALL    ENDCL
001667 DADD 38E5            12      JR  C,RWX1
       DADF                     SCF_RET:
001669 DADF 37               4      SCF
00166A DAE0 C9              10      RET
                                
       DAE1                     DSKF:
00166B DAE1 110000          10      LD  DE,0
       DAE2                     MAXCLP  EQU $-2
00166E DAE4 2AACE5          16      LD  HL,(_FAKEFREE)
001671 DAE7 7C               4      LD  A,H
001672 DAE8 B5               4      OR  L
001673 DAE9 2803            12      JR  Z,DSKF1
001675 DAEB 110100          10      LD  DE,1
       DAEE                     DSKF1:
001678 DAEE D5              11      PUSH    DE
001679 DAEF CDF7E5          17      CALL    _GNCL
00167C DAF2 380C            12      JR  C,POPSCF
00167E DAF4 7A               4      LD  A,D
00167F DAF5 B3               4      OR  E
001680 DAF6 2001            12      JR  NZ,DSKF2
001682 DAF8 23               6      INC HL
       DAF9                     DSKF2:
001683 DAF9 D1              10      POP DE
001684 DAFA 1B               6      DEC DE
001685 DAFB 7A               4      LD  A,D
001686 DAFC B3               4      OR  E
001687 DAFD 20EF            12      JR  NZ,DSKF1
001689 DAFF C9              10      RET
                                
       DB00                     POPSCF:
00168A DB00 F1              10      POP AF
00168B DB01 37               4      SCF
00168C DB02 C9              10      RET
                                
       DB03                     SETTMS:
00168D DB03 FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
001690 DB06 3C               4      INC A
001691 DB07 C0              11      RET NZ      ;ファイルが更新されていない
       DB08                     SETTMSX:            ;FCBに日付時刻をセットする
001692 DB08 CDCBD2          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
001695 DB0B CB25             8      SLA L       ;   *2
001697 DB0D CB25             8      SLA L       ;   *4
001699 DB0F 29              11      ADD HL,HL       ;*2 *8
00169A DB10 29              11      ADD HL,HL       ;*4 *16
00169B DB11 29              11      ADD HL,HL       ;*8 *32
00169C DB12 7A               4      LD  A,D
00169D DB13 0F               4      RRCA            ;bit.0->7->->->0->C
00169E DB14 E61F             7      AND 01FH
0016A0 DB16 B5               4      OR  L
0016A1 DB17 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
0016A4 DB1A FD7417          19      LD  (IY+23),H
                                
0016A7 DB1D CD7BD2          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
0016AA DB20 0144F8          10      LD  BC,0-1980
0016AD DB23 09              11      ADD HL,BC
0016AE DB24 65               4      LD  H,L
                                
0016AF DB25 7A               4      LD  A,D
0016B0 DB26 87               4      ADD A,A     ;*2
0016B1 DB27 87               4      ADD A,A     ;*4
0016B2 DB28 87               4      ADD A,A     ;*8
0016B3 DB29 87               4      ADD A,A     ;*16
0016B4 DB2A 6F               4      LD  L,A
0016B5 DB2B 29              11      ADD HL,HL       ;*32
0016B6 DB2C 7D               4      LD  A,L
0016B7 DB2D B3               4      OR  E
0016B8 DB2E FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
0016BB DB31 FD7415          19      LD  (IY+21),H
0016BE DB34 C9              10      RET
                                ;(16)
       DB35                     PUSHRR:
0016BF DB35 3261DE          13      LD  (SETSEQ_SWC_RND),A
0016C2 DB38 2273DE          16      LD  (SETSEQ_SWC_SEQ_RR),HL
0016C5 DB3B CD5BDB          17      CALL    GET_RR_AHL
0016C8 DB3E 220FE5          16      LD  (RR_BUF_HL),HL
0016CB DB41 3211E5          13      LD  (RR_BUF_A),A
0016CE DB44 C9              10      RET
                                ;(14)
       DB45                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
0016CF DB45 87               4      ADD A,A     ;in BHLA => out AHL
0016D0 DB46 ED6A            15      ADC HL,HL
0016D2 DB48 CB18             8      RR  B
0016D4 DB4A B7               4      OR  A
0016D5 DB4B 78               4      LD  A,B     ;ここでフラグは変化しない
0016D6 DB4C C8              11      RET Z
0016D7 DB4D 2C               4      INC L       ;INC AHL
0016D8 DB4E C0              11      RET NZ      ;
0016D9 DB4F 24               4      INC H       ;
0016DA DB50 C0              11      RET NZ      ;
0016DB DB51 3C               4      INC A       ;
0016DC DB52 C9              10      RET
                                ;(18)
       DB53                     INIT_RND:
0016DD DB53 3ECD             7      LD  A,0CDH      ;CALL ????
0016DF DB55 2172DB          10      LD  HL,POPRR
0016E2 DB58 CD35DB          17      CALL    PUSHRR
       DB5B                     GET_RR_AHL:
0016E5 DB5B FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0016E8 DB5E FD6622          19      LD  H,(IY+34)   ;
0016EB DB61 FD7E23          19      LD  A,(IY+35)   ;
0016EE DB64 C9              10      RET
                                ;(10)
       DB65                     SET_RR_AHL:
0016EF DB65 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0016F2 DB68 FD7422          19      LD  (IY+34),H   ;
0016F5 DB6B FD7723          19      LD  (IY+35),A   ;
0016F8 DB6E C9              10      RET
                                ;(17)
       DB6F                     SETSEQ:
0016F9 DB6F CD94DB          17      CALL    SETSEQ1
       DB72                     POPRR:
0016FC DB72 F5              11      PUSH    AF
0016FD DB73 E5              11      PUSH    HL
0016FE DB74 2A0FE5          16      LD  HL,(RR_BUF_HL)
001701 DB77 3A11E5          13      LD  A,(RR_BUF_A)
001704 DB7A CD65DB          17      CALL    SET_RR_AHL
001707 DB7D E1              10      POP HL
001708 DB7E F1              10      POP AF
001709 DB7F C9              10      RET
                                ;(20)
       DB80                     GET_RR_BCDE:            ;BCDE=Random record
00170A DB80 FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
00170D DB83 FD5622          19      LD  D,(IY+34)
001710 DB86 FD4E23          19      LD  C,(IY+35)
001713 DB89 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
001715 DB8B FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001719 DB8F C0              11      RET NZ
00171A DB90 FD4624          19      LD  B,(IY+36)
00171D DB93 C9              10      RET
                                
       DB94                     SETSEQ1:
00171E DB94 F5              11      PUSH    AF
00171F DB95 E5              11      PUSH    HL      ;AHL=Random record
001720 DB96 CD5BDB          17      CALL    GET_RR_AHL
001723 DB99 47               4      LD  B,A     ;AHL→HLA
001724 DB9A 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
001725 DB9B 6C               4      LD  L,H     ;(IY+34)
001726 DB9C 60               4      LD  H,B     ;(IY+35)
001727 DB9D 0600             7      LD  B,0
                                
001729 DB9F CD45DB          17      CALL    GET_CPM_R_SIZE
                                
00172C DBA2 29              11      ADD HL,HL
00172D DBA3 CB3D             8      SRL L       ;L=L/2
00172F DBA5 FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
001732 DBA8 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
001735 DBAB E1              10      POP HL
001736 DBAC F1              10      POP AF
001737 DBAD C9              10      RET
                                
                                ;(23)
       DBAE                     RBXEND:             ;レコード数だけランダムレコードを進める
001738 DBAE 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       DBAF                     RBSIZE  EQU $-2
00173B DBB1 CD5BDB          17      CALL    GET_RR_AHL
00173E DBB4 19              11      ADD HL,DE
00173F DBB5 CE00             7      ADC A,0
001741 DBB7 CD65DB          17      CALL    SET_RR_AHL
001744 DBBA EB               4      EX  DE,HL       ;HL=進めるレコード数
001745 DBBB D0              11      RET NC
001746 DBBC FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00174A DBC0 C0              11      RET NZ
00174B DBC1 FD3424          23      INC (IY+36)
00174E DBC4 C9              10      RET
       DBC5                     FILE_E:
                                
       D76F                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       D76F                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       D76F                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       D76F                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       D76F                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       DBC5                     _SYS26:     ;(BDOS)ランダムブロック書き込み
00174F DBC5 AF               4      XOR A
001750 DBC6 32AEDE          13      LD  (DRDN1),A   ;NOP
001753 DBC9 22AFDB          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
001756 DBCC 225DE5          16      LD  (LEFTX),HL
001759 DBCF CDB8D6          17      CALL    SETDRV
                                
00175C DBD2 CD38DD          17      CALL    RBX0
00175F DBD5 DA62DC          10      JP  C,RBWERR
001762 DBD8 CD41DA          17      CALL    WOPEN
001765 DBDB DA62DC          10      JP  C,RBWERR
001768 DBDE 7C               4      LD  A,H
001769 DBDF B5               4      OR  L
00176A DBE0 CA5BDC          10      JP  Z,RBW1
                                
00176D DBE3 2B               6      DEC HL
                                
00176E DBE4 CD80DB          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001771 DBE7 19              11      ADD HL,DE       ;BCHL=HL+BCDE
001772 DBE8 3001            12      JR  NC,S26X1    ;
001774 DBEA 03               6      INC BC      ;
       DBEB                     S26X1:
001775 DBEB CDACDA          17      CALL    RWXR
001778 DBEE DC52DA          17      CALL    C,WRDFX
00177B DBF1 DA62DC          10      JP  C,RBWERR
                                
00177E DBF4 CD67DD          17      CALL    RBX2
001781 DBF7 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
001783 DBF9 CD86DD          17      CALL    RBXA
001786 DBFC 3864            12      JR  C,RBWERR
001788 DBFE EB               4      EX  DE,HL
001789 DBFF C5              11      PUSH    BC
00178A DC00 EDB0                    LDIR
00178C DC02 225FE5          16      LD  (DTAX),HL
                                
00178F DC05 CDE3D9          17      CALL    WTDB        ;バッファデータは更新された
                                
001792 DC08 2A5DE5          16      LD  HL,(LEFTX)
001795 DC0B D1              10      POP DE
001796 DC0C ED52            15      SBC HL,DE
001798 DC0E 225DE5          16      LD  (LEFTX),HL
00179B DC11 2831            12      JR  Z,RBWEND
                                
       DC13                     RBWB:
00179D DC13 CDBBDD          17      CALL    RBXB
0017A0 DC16 2814            12      JR  Z,RBWC
       DC18                     RBWB1:
0017A2 DC18 C5              11      PUSH    BC
0017A3 DC19 D5              11      PUSH    DE
0017A4 DC1A CDC0D8          17      CALL    CLUSTX
0017A7 DC1D CDDFDD          17      CALL    DWTC
0017AA DC20 D1              10      POP DE
0017AB DC21 C1              10      POP BC
0017AC DC22 D430E0          17      CALL    NC,GNCLX
0017AF DC25 383B            12      JR  C,RBWERR
0017B1 DC27 10EF            13      DJNZ    RBWB1
0017B3 DC29 CD2FDE          17      CALL    DRW_FLUSH
       DC2C                     RBWC:
0017B6 DC2C CDD3DD          17      CALL    RBXC
0017B9 DC2F 2813            12      JR  Z,RBWEND
0017BB DC31 C5              11      PUSH    BC
0017BC DC32 CDC0D8          17      CALL    CLUSTX
0017BF DC35 CDADDE          17      CALL    DRDN
0017C2 DC38 C1              10      POP BC
0017C3 DC39 3827            12      JR  C,RBWERR
0017C5 DC3B ED5B7EE6        20      LD  DE,(_DTBUF)
0017C9 DC3F EDB0                    LDIR
0017CB DC41 CDE3D9          17      CALL    WTDB        ;バッファデータは更新された
       DC44                     RBWEND:
0017CE DC44 CDAEDB          17      CALL    RBXEND
                                
0017D1 DC47 CD47DD          17      CALL    RBX1
0017D4 DC4A 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
0017D6 DC4C CD80DB          17      CALL    GET_RR_BCDE ;BCDE=Random record
0017D9 DC4F FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
0017DC DC52 FD7211          19      LD  (IY+17),D   ;
0017DF DC55 FD7112          19      LD  (IY+18),C   ;
0017E2 DC58 FD7013          19      LD  (IY+19),B   ;
       DC5B                     RBW1:
0017E5 DC5B FDE1            14      POP IY
0017E7 DC5D C1              10      POP BC
0017E8 DC5E D1              10      POP DE
0017E9 DC5F E1              10      POP HL
       DC60                     DD_NUL:
0017EA DC60 AF               4      XOR A
       DC61                     DRDF0:
       DC61                     DWTF0:
0017EB DC61 C9              10      RET
                                
       DC62                     RBWERR:
0017EC DC62 FDE5            15      PUSH    IY
0017EE DC64 D1              10      POP DE
0017EF DC65 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
0017F1 DC67 CD42CE          17      CALL    BDOS0
       DC6A                     RBRERR1:
0017F4 DC6A 3E01             7      LD  A,001H
       DC6C                     RBRERR2:
0017F6 DC6C FDE1            14      POP IY
0017F8 DC6E C1              10      POP BC
0017F9 DC6F D1              10      POP DE
0017FA DC70 E1              10      POP HL
0017FB DC71 37               4      SCF
0017FC DC72 210000          10      LD  HL,0
0017FF DC75 C9              10      RET
                                
       DC76                     RBRERR:
001800 DC76 3EFF             7      LD  A,0FFH
001802 DC78 18F2            12      JR  RBRERR2
                                
       DC7A                     RBRFL:
001804 DC7A 3E00             7  RBRFLP: LD  A,000H
001806 DC7C FE0D             7      CP  00DH
001808 DC7E 2005            12      JR  NZ,RBRFL1
00180A DC80 D5              11      PUSH    DE
00180B DC81 1E0A             7      LD  E,00AH
00180D DC83 1805            12      JR  RBRFL2
       DC85                     RBRFL1:
00180F DC85 D5              11      PUSH    DE
001810 DC86 CD09E5          17      CALL    _SYS07
001813 DC89 5F               4      LD  E,A
       DC8A                     RBRFL2:
001814 DC8A CDCDE5          17      CALL    _PRINT
001817 DC8D 7B               4      LD  A,E
001818 DC8E D1              10      POP DE
001819 DC8F 327BDC          13      LD  (RBRFLP+1),A
00181C DC92 C9              10      RET
                                
                                                ;Read random block
       DC93                     _SYS27:     ;(BDOS)ランダムブロック読み込み
00181D DC93 225DE5          16      LD  (LEFTX),HL
001820 DC96 CDB8D6          17      CALL    SETDRV
                                
001823 DC99 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
001827 DC9D C226DD          10      JP  NZ,RBRDIR   ;ディレクトリ
00182A DCA0 CD38DD          17      CALL    RBX0
00182D DCA3 DA76DC          10      JP  C,RBRERR
001830 DCA6 CD47DD          17      CALL    RBX1
001833 DCA9 D45FDD          17      CALL    NC,RBX1R
001836 DCAC DA6ADC          10      JP  C,RBRERR1
001839 DCAF EB               4      EX  DE,HL
00183A DCB0 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
00183C DCB2 19              11      ADD HL,DE
00183D DCB3 79               4      LD  A,C
00183E DCB4 DE00             7      SBC A,0
001840 DCB6 78               4      LD  A,B
001841 DCB7 DE00             7      SBC A,0
001843 DCB9 3801            12      JR  C,RBR1
001845 DCBB EB               4      EX  DE,HL
       DCBC                     RBR1:
001846 DCBC 9F               4      SBC A,A
001847 DCBD E601             7      AND 1
001849 DCBF 3224DD          13      LD  (RBRA_SWC),A
                                
00184C DCC2 7C               4      LD  A,H
00184D DCC3 B5               4      OR  L
00184E DCC4 2857            12      JR  Z,RBREND0
                                
001850 DCC6 22AFDB          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
001853 DCC9 225DE5          16      LD  (LEFTX),HL
                                
001856 DCCC CD67DD          17      CALL    RBX2
001859 DCCF 2819            12      JR  Z,RBRB
00185B DCD1 CD86DD          17      CALL    RBXA
00185E DCD4 DA76DC          10      JP  C,RBRERR
001861 DCD7 C5              11      PUSH    BC
001862 DCD8 EDB0                    LDIR
001864 DCDA ED535FE5        20      LD  (DTAX),DE
001868 DCDE 2A5DE5          16      LD  HL,(LEFTX)
00186B DCE1 D1              10      POP DE
00186C DCE2 A7               4      AND A
00186D DCE3 ED52            15      SBC HL,DE
00186F DCE5 225DE5          16      LD  (LEFTX),HL
001872 DCE8 2830            12      JR  Z,RBREND
                                
       DCEA                     RBRB:
001874 DCEA CDBBDD          17      CALL    RBXB
001877 DCED 2815            12      JR  Z,RBRC
       DCEF                     RBRB1:
001879 DCEF C5              11      PUSH    BC
00187A DCF0 D5              11      PUSH    DE
00187B DCF1 CDC0D8          17      CALL    CLUSTX
00187E DCF4 CDE5DD          17      CALL    DRDC
001881 DCF7 D1              10      POP DE
001882 DCF8 C1              10      POP BC
001883 DCF9 D430E0          17      CALL    NC,GNCLX
001886 DCFC DA76DC          10      JP  C,RBRERR
001889 DCFF 10EE            13      DJNZ    RBRB1
00188B DD01 CD2FDE          17      CALL    DRW_FLUSH
       DD04                     RBRC:
00188E DD04 CDD3DD          17      CALL    RBXC
001891 DD07 2811            12      JR  Z,RBREND
001893 DD09 C5              11      PUSH    BC
001894 DD0A CDC0D8          17      CALL    CLUSTX
001897 DD0D CD91DE          17      CALL    DRDX
00189A DD10 C1              10      POP BC
00189B DD11 DA76DC          10      JP  C,RBRERR
00189E DD14 EB               4      EX  DE,HL
00189F DD15 2A7EE6          16      LD  HL,(_DTBUF)
0018A2 DD18 EDB0                    LDIR
       DD1A                     RBREND:
0018A4 DD1A CDAEDB          17      CALL    RBXEND
       DD1D                     RBREND0:
0018A7 DD1D FDE1            14      POP IY
0018A9 DD1F C1              10      POP BC
0018AA DD20 D1              10      POP DE
0018AB DD21 F1              10      POP AF  ;(HL)
0018AC DD22 AF               4      XOR A
0018AD DD23 3E00             7      LD  A,000H
       DD24                     RBRA_SWC    EQU $-1
0018AF DD25 C9              10      RET
                                
       DD26                     RBRDIR:
0018B0 DD26 FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0018B3 DD29 FD661B          19      LD  H,(IY+27)
0018B6 DD2C CDFFD8          17      CALL    CHDIR
0018B9 DD2F AF               4      XOR A
0018BA DD30 67               4      LD  H,A
0018BB DD31 6F               4      LD  L,A
0018BC DD32 3C               4      INC A
0018BD DD33 3224DD          13      LD  (RBRA_SWC),A
0018C0 DD36 18E5            12      JR  RBREND0
                                ;(15)
       DD38                     RBX0:
0018C2 DD38 2A8AE5          16      LD  HL,(_DTA)
0018C5 DD3B 225FE5          16      LD  (DTAX),HL
0018C8 DD3E 2A5DE5          16      LD  HL,(LEFTX)
0018CB DD41 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0018CE DD44 D6FD             7      SUB 0FDH
0018D0 DD46 C9              10      RET
                                
       DD47                     RBX1:               ;ファイルサイズとランダムレコードを比べる
0018D1 DD47 E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
0018D2 DD48 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
0018D5 DD4B FD6611          19      LD  H,(IY+17)   ;
0018D8 DD4E FD7E12          19      LD  A,(IY+18)   ;
                                
0018DB DD51 CD80DB          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0018DE DD54 A7               4      AND A
0018DF DD55 ED52            15      SBC HL,DE
0018E1 DD57 99               4      SBC A,C
0018E2 DD58 4F               4      LD  C,A
0018E3 DD59 FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
0018E6 DD5C 98               4      SBC A,B
0018E7 DD5D D1              10      POP DE
0018E8 DD5E C9              10      RET
       DD5F                     RBX1R:              ;(8)
0018E9 DD5F 47               4      LD  B,A
0018EA DD60 B1               4      OR  C
0018EB DD61 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
0018EC DD62 B2               4      OR  D
0018ED DD63 B3               4      OR  E
0018EE DD64 C0              11      RET NZ
0018EF DD65 37               4      SCF
0018F0 DD66 C9              10      RET
                                
       DD67                     RBX2:               ;Cluster settings
0018F1 DD67 FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
0018F4 DD6A FD4E23          19      LD  C,(IY+35)
0018F7 DD6D 0600             7      LD  B,0
0018F9 DD6F FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0018FD DD73 2003            12      JR  NZ,RBX3
0018FF DD75 FD4624          19      LD  B,(IY+36)
       DD78                     RBX3:
001902 DD78 CDACDA          17      CALL    RWXR
001905 DD7B 3A9DDD          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001908 DD7E 3D               4      DEC A
001909 DD7F FDA622          19      AND (IY+34)
00190C DD82 FDB621          19      OR  (IY+33)
00190F DD85 C9              10      RET
                                
       DD86                     RBXA:
001910 DD86 C5              11      PUSH    BC
001911 DD87 D5              11      PUSH    DE
001912 DD88 CDC0D8          17      CALL    CLUSTX
001915 DD8B CD91DE          17      CALL    DRDX
001918 DD8E D1              10      POP DE
001919 DD8F C1              10      POP BC
00191A DD90 D430E0          17      CALL    NC,GNCLX
00191D DD93 D8              11      RET C
00191E DD94 ED53FEE6        20      LD  (_CLPS),DE
                                
001922 DD98 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
001925 DD9B 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       DD9C                     SECSZ   EQU $-2
       DD9D                     SECSZ_H EQU $-1
001928 DD9E 7C               4      LD  A,H
001929 DD9F 3D               4      DEC A       ;1024=3 / 512=1
00192A DDA0 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
00192D DDA3 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
00192E DDA4 ED42            15      SBC HL,BC       ;残りを計算
                                
001930 DDA6 ED5B5DE5        20      LD  DE,(LEFTX)
001934 DDAA ED52            15      SBC HL,DE       ;CP HL,DE
001936 DDAC 19              11      ADD HL,DE       ;
001937 DDAD 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
001939 DDAF EB               4      EX  DE,HL
       DDB0                     RBXA1:
00193A DDB0 E5              11      PUSH    HL
00193B DDB1 2A7EE6          16      LD  HL,(_DTBUF)
00193E DDB4 09              11      ADD HL,BC
00193F DDB5 ED5B5FE5        20      LD  DE,(DTAX)
001943 DDB9 C1              10      POP BC
001944 DDBA C9              10      RET
                                
       DDBB                     RBXB:
001945 DDBB 2A5FE5          16      LD  HL,(DTAX)
001948 DDBE ED5BFEE6        20      LD  DE,(_CLPS)
00194C DDC2 3A5EE5          13      LD  A,(LEFTX+1)
00194F DDC5 47               4      LD  B,A
001950 DDC6 3A9DDD          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       DDC9                     RBXB1:
001953 DDC9 1F               4      RRA     ;->CF
001954 DDCA 3804            12      JR  C,RBXB2
001956 DDCC CB38             8      SRL B   ;B=B/2
001958 DDCE 18F9            12      JR  RBXB1
       DDD0                     RBXB2:
00195A DDD0 78               4      LD  A,B
00195B DDD1 B7               4      OR  A
00195C DDD2 C9              10      RET
                                ;(12)
       DDD3                     RBXC:
00195D DDD3 ED4B5DE5        20      LD  BC,(LEFTX)
001961 DDD7 3A9DDD          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001964 DDDA 3D               4      DEC A
001965 DDDB A0               4      AND B
001966 DDDC 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
001967 DDDD B1               4      OR  C
001968 DDDE C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       DDDF                     DWTC:
001969 DDDF E5              11      PUSH    HL
00196A DDE0 21C7E1          10      LD  HL,DWT24B
00196D DDE3 1804            12      JR  DWTC1
       DDE5                     DRDC:
00196F DDE5 E5              11      PUSH    HL
001970 DDE6 21B9E1          10      LD  HL,DRD24B
       DDE9                     DWTC1:
001973 DDE9 2243DE          16      LD  (DRWF_MODE),HL
001976 DDEC E1              10      POP HL
001977 DDED 3A33DE          13      LD  A,(DRWF_B)
00197A DDF0 B7               4      OR  A
00197B DDF1 200F            12      JR  NZ,DRDC1
       DDF3                     SAVE_DRWC:
00197D DDF3 0601             7      LD  B,1
00197F DDF5 ED4332DE        20      LD  (DRWF_C),BC
001983 DDF9 ED5339DE        20      LD  (DRWF_E),DE
001987 DDFD 223CDE          16      LD  (DRWF_HL),HL
00198A DE00 1820            12      JR  INC_HL_DRWC
       DE02                     DRDC1:
00198C DE02 E5              11      PUSH    HL
00198D DE03 2139DE          10      LD  HL,DRWF_E
001990 DE06 86               7      ADD A,(HL)
001991 DE07 F5              11      PUSH    AF
001992 DE08 BB               4      CP  E
001993 DE09 201D            12      JR  NZ,DRDC2
001995 DE0B F1              10      POP AF
001996 DE0C 23               6      INC HL
001997 DE0D 7E               7      LD  A,(HL)
001998 DE0E CE00             7      ADC A,0
00199A DE10 F5              11      PUSH    AF
00199B DE11 BA               4      CP  D
00199C DE12 2014            12      JR  NZ,DRDC2
00199E DE14 F1              10      POP AF
00199F DE15 3A32DE          13      LD  A,(DRWF_C)
0019A2 DE18 CE00             7      ADC A,0
0019A4 DE1A B9               4      CP  C
0019A5 DE1B 200C            12      JR  NZ,DRDC3
0019A7 DE1D 2133DE          10      LD  HL,DRWF_B
0019AA DE20 34              11      INC (HL)
0019AB DE21 E1              10      POP HL
       DE22                     INC_HL_DRWC:
0019AC DE22 3A9DDD          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
0019AF DE25 84               4      ADD A,H
0019B0 DE26 67               4      LD  H,A
0019B1 DE27 C9              10      RET
       DE28                     DRDC2:
0019B2 DE28 F1              10      POP AF
       DE29                     DRDC3:
0019B3 DE29 CD2FDE          17      CALL    DRW_FLUSH
0019B6 DE2C E1              10      POP HL
0019B7 DE2D 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       DE2F                     DRW_FLUSH:
0019B9 DE2F C5              11      PUSH    BC
0019BA DE30 D5              11      PUSH    DE
0019BB DE31 010000          10      LD  BC,0
       DE32                     DRWF_C  EQU $-2
       DE33                     DRWF_B  EQU $-1
0019BE DE34 78               4      LD  A,B
0019BF DE35 B7               4      OR  A
0019C0 DE36 280D            12      JR  Z,DRDF1
0019C2 DE38 110000          10      LD  DE,0
       DE39                     DRWF_E  EQU $-2
       DE3A                     DRWF_D  EQU $-1
0019C5 DE3B 210000          10      LD  HL,0
       DE3C                     DRWF_HL EQU $-2
0019C8 DE3E AF               4      XOR A
0019C9 DE3F 3233DE          13      LD  (DRWF_B),A
0019CC DE42 CDB9E1          17      CALL    DRD24B
       DE43                     DRWF_MODE   EQU $-2
       DE45                     DRDF1:
0019CF DE45 D1              10      POP DE
0019D0 DE46 C1              10      POP BC
0019D1 DE47 C9              10      RET
                                
       DE48                     RB_WRITE:
0019D2 DE48 C5              11      PUSH    BC
0019D3 DE49 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0019D5 DE4B 1803            12      JR  RBRW
       DE4D                     RB_READ:
0019D7 DE4D C5              11      PUSH    BC
0019D8 DE4E 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       DE50                     RBRW:
0019DA DE50 1F               4      RRA     ;AHL = AHL*128
0019DB DE51 7C               4      LD  A,H ;AHL = AHL0/2
0019DC DE52 1F               4      RRA     ;A
0019DD DE53 65               4      LD  H,L ;
0019DE DE54 CB1C             8      RR  H   ;H
0019E0 DE56 2E00             7      LD  L,0 ;
0019E2 DE58 CB1D             8      RR  L   ;L
0019E4 DE5A CD65DB          17      CALL    SET_RR_AHL
0019E7 DE5D 218000          10      LD  HL,128
0019EA DE60 C5              11      PUSH    BC
       DE61                     SETSEQ_SWC_RND:
0019EB DE61 CD94DB          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
0019EE DE64 C1              10      POP BC
0019EF DE65 FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
0019F3 DE69 FDE5            15      PUSH    IY
0019F5 DE6B D1              10      POP DE
0019F6 DE6C D5              11      PUSH    DE
0019F7 DE6D CD42CE          17      CALL    BDOS0
0019FA DE70 FDE1            14      POP IY
0019FC DE72 CD6FDB          17      CALL    SETSEQ      ;SETSEQ or POPRR
       DE73                     SETSEQ_SWC_SEQ_RR   EQU $-2
0019FF DE75 FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
001A03 DE79 C1              10      POP BC
001A04 DE7A C9              10      RET
                                
                                ;(22)
       DE7B                     INIT_SEQ:
001A05 DE7B 3E01             7      LD  A,1     ;LD BC,????
001A07 DE7D 216FDB          10      LD  HL,SETSEQ
001A0A DE80 CD35DB          17      CALL    PUSHRR
       DE83                     GETSEQ:
001A0D DE83 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
001A10 DE86 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
001A13 DE89 AF               4      XOR A
                                
001A14 DE8A CB25             8      SLA L   ;L=L*2
                                
001A16 DE8C CB3C             8      SRL H   ;HL=HL/2
001A18 DE8E CB1D             8      RR  L   ;
001A1A DE90 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       DE91                     DRDX:
001A1B DE91 CDCFDE          17      CALL    DRDY
001A1E DE94 C8              11      RET Z
001A1F DE95 CDB5DE          17      CALL    DRDX1       ;データバッファの情報を保存
001A22 DE98 D8              11      RET C
001A23 DE99 E5              11      PUSH    HL
001A24 DE9A C5              11      PUSH    BC
001A25 DE9B D5              11      PUSH    DE
001A26 DE9C 2A7EE6          16      LD  HL,(_DTBUF)
001A29 DE9F 3AF8DE          13      LD  A,(_DBS24)
001A2C DEA2 4F               4      LD  C,A
001A2D DEA3 CDB7E1          17      CALL    DRD24
001A30 DEA6 DCCADE          17      CALL    C,DRDNE
       DEA9                     POP_DE_BC_HL_RET:
001A33 DEA9 D1              10      POP DE
001A34 DEAA C1              10      POP BC
001A35 DEAB E1              10      POP HL
001A36 DEAC C9              10      RET
                                
                                ;   CDE:セクタ番号
       DEAD                     DRDN:
001A37 DEAD AF               4      XOR A
001A38 DEAE 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
001A39 DEAF 30E0            12      JR  NC,DRDX
       DEB1                     DRDNX:
001A3B DEB1 CDCFDE          17      CALL    DRDY
001A3E DEB4 C8              11      RET Z
       DEB5                     DRDX1:
001A3F DEB5 CDE5DE          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
001A42 DEB8 ED53A6E5        20      LD  (_DBSEC),DE
001A46 DEBC 79               4      LD  A,C
001A47 DEBD 32F8DE          13      LD  (_DBS24),A
                                
001A4A DEC0 3A88E5          13      LD  A,(_DRV)
001A4D DEC3 32A5E5          13      LD  (_DBDRV),A
001A50 DEC6 CDD9E5          17      CALL    _CHGDRV
001A53 DEC9 D0              11      RET NC
       DECA                     DRDNE:
001A54 DECA 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001A55 DECB 32A5E5          13      LD  (_DBDRV),A
001A58 DECE C9              10      RET
                                
                                ;   CDE:セクタ番号
       DECF                     DRDY:
001A59 DECF 3AF8DE          13      LD  A,(_DBS24)
001A5C DED2 B9               4      CP  C
001A5D DED3 C0              11      RET NZ
                                
001A5E DED4 E5              11      PUSH    HL
001A5F DED5 3A88E5          13      LD  A,(_DRV)
001A62 DED8 21A5E5          10      LD  HL,_DBDRV
001A65 DEDB AE               7      XOR (HL)
001A66 DEDC 2005            12      JR  NZ,POP_HL_RET
                                
001A68 DEDE 2AA6E5          16      LD  HL,(_DBSEC)
001A6B DEE1 ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       DEE3                     POP_HL_RET:
001A6D DEE3 E1              10      POP HL
001A6E DEE4 C9              10      RET
                                
       DEE5                     DWTX:
001A6F DEE5 3AA4E5          13      LD  A,(_WTDBF)
001A72 DEE8 B7               4      OR  A
001A73 DEE9 C8              11      RET Z
001A74 DEEA AF               4      XOR A
001A75 DEEB 32A4E5          13      LD  (_WTDBF),A
                                
001A78 DEEE E5              11      PUSH    HL
001A79 DEEF C5              11      PUSH    BC
001A7A DEF0 D5              11      PUSH    DE
001A7B DEF1 3AA5E5          13      LD  A,(_DBDRV)
001A7E DEF4 CDD9E5          17      CALL    _CHGDRV
001A81 DEF7 0E00             7      LD  C,0
       DEF8                     _DBS24  EQU $-1
001A83 DEF9 ED5BA6E5        20      LD  DE,(_DBSEC)
001A87 DEFD 2A7EE6          16      LD  HL,(_DTBUF)
001A8A DF00 D4C5E1          17      CALL    NC,DWT24
       DF03                     POP_DE_BC_HL_RET2:
001A8D DF03 18A4            12      JR  POP_DE_BC_HL_RET
                                
       DF05                     RDFATX:
001A8F DF05 E5              11      PUSH    HL
001A90 DF06 3A88E5          13      LD  A,(_DRV)
001A93 DF09 21AAE5          10      LD  HL,_FATDRV
001A96 DF0C AE               7      XOR (HL)
001A97 DF0D 28D4            12      JR  Z,POP_HL_RET
                                
001A99 DF0F C5              11      PUSH    BC
001A9A DF10 D5              11      PUSH    DE
001A9B DF11 DDE5            15      PUSH    IX
001A9D DF13 CD2FDF          17      CALL    WTFATX
001AA0 DF16 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
001AA2 DF18 AF               4      XOR A
001AA3 DF19 32ABE5          13      LD  (_FATIX),A
001AA6 DF1C 3A88E5          13      LD  A,(_DRV)
001AA9 DF1F 32AAE5          13      LD  (_FATDRV),A
001AAC DF22 CDE5E5          17      CALL    _RDFAT
       DF25                     RDFATE2:
001AAF DF25 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
001AB1 DF27 9F               4      SBC A,A     ;A=0xFF
001AB2 DF28 32AAE5          13      LD  (_FATDRV),A
       DF2B                     POP_IX_DE_BC_HL_RET:
001AB5 DF2B DDE1            14      POP IX
001AB7 DF2D 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       DF2F                     WTFATX:
001AB9 DF2F 3AA2E5          13      LD  A,(_WTFATF)
001ABC DF32 B7               4      OR  A
001ABD DF33 C8              11      RET Z
001ABE DF34 AF               4      XOR A
001ABF DF35 32A2E5          13      LD  (_WTFATF),A
                                
001AC2 DF38 E5              11      PUSH    HL
001AC3 DF39 3AAAE5          13      LD  A,(_FATDRV)
001AC6 DF3C 21A5E5          10      LD  HL,_DBDRV
001AC9 DF3F AE               7      XOR (HL)
001ACA DF40 CCE5DE          17      CALL    Z,DWTX
001ACD DF43 389E            12      JR  C,POP_HL_RET
001ACF DF45 C5              11      PUSH    BC
001AD0 DF46 D5              11      PUSH    DE
001AD1 DF47 DDE5            15      PUSH    IX
001AD3 DF49 CDD6E1          17      CALL    FATSETUP
001AD6 DF4C D4C7E1          17      CALL    NC,DWT24B
001AD9 DF4F 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       DF51                     N16CL1:
001ADB DF51 7A               4      LD  A,D
001ADC DF52 B3               4      OR  E
001ADD DF53 37               4      SCF
001ADE DF54 C8              11      RET Z
                                
001ADF DF55 7A               4      LD  A,D
001AE0 DF56 1807            12      JR  NCL1X
       DF58                     NCL1:
001AE2 DF58 7A               4      LD  A,D
001AE3 DF59 B3               4      OR  E
001AE4 DF5A 37               4      SCF
001AE5 DF5B C8              11      RET Z
                                
001AE6 DF5C 7A               4      LD  A,D
001AE7 DF5D CB3F             8      SRL A   ;/2
       DF5F                     NCL1X:
001AE9 DF5F CB3F             8      SRL A   ;/2
                                
001AEB DF61 E5              11      PUSH    HL
001AEC DF62 3281DF          13      LD  (NCLPAT_FATIX),A    ;_FATIX
001AEF DF65 2AAAE5          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001AF2 DF68 BC               4      CP  H
001AF3 DF69 3A88E5          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001AF6 DF6C 3280DF          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001AF9 DF6F 2005            12      JR  NZ,NCL2     ;FATIXが違う
001AFB DF71 BD               4      CP  L
001AFC DF72 2002            12      JR  NZ,NCL2     ;ドライブが違う
001AFE DF74 E1              10      POP HL
001AFF DF75 C9              10      RET
       DF76                     NCL2:
001B00 DF76 C5              11      PUSH    BC
001B01 DF77 D5              11      PUSH    DE
001B02 DF78 DDE5            15      PUSH    IX
001B04 DF7A CD2FDF          17      CALL    WTFATX
001B07 DF7D 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
001B09 DF7F 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       DF81                     NCLPAT_FATIX    EQU $-1
       DF80                     NCLPAT_FATDRV   EQU $-2
001B0C DF82 ED43AAE5        20      LD  (_FATDRV),BC
001B10 DF86 CDABE1          17      CALL    RDFATS
001B13 DF89 189A            12      JR  RDFATE2
                                
       DF8B                     NCL3:
001B15 DF8B CB9A             8      RES 3,D
001B17 DF8D CB92             8      RES 2,D
001B19 DF8F 6B               4      LD  L,E
001B1A DF90 62               4      LD  H,D
001B1B DF91 CB3C             8      SRL H   ;
001B1D DF93 CB1D             8      RR  L   ;HLA=HLA/2
001B1F DF95 1F               4      RRA     ;
001B20 DF96 F5              11      PUSH    AF
001B21 DF97 3AABE5          13      LD  A,(_FATIX)
001B24 DF9A 0F               4      RRCA
001B25 DF9B 300B            12      JR  NC,NCL3X1
001B27 DF9D 3A9DDD          13      LD  A,(SECSZ_H)
001B2A DFA0 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの際に先頭を512バイトずらす
001B2C DFA2 2004            12      JR  NZ,NCL3X1
001B2E DFA4 010002          10      LD  BC,512
001B31 DFA7 09              11      ADD HL,BC
       DFA8                     NCL3X1:
001B32 DFA8 F1              10      POP AF
001B33 DFA9 ED4B7CE6        20      LD  BC,(_FATBF)
001B37 DFAD 19              11      ADD HL,DE
001B38 DFAE 09              11      ADD HL,BC
001B39 DFAF 17               4      RLA
001B3A DFB0 C9              10      RET
                                
       DFB1                     GNCL:
001B3B DFB1 CD58DF          17      CALL    NCL1        ;GET NEXT CLUSTER
001B3E DFB4 D8              11      RET C
001B3F DFB5 C5              11      PUSH    BC
001B40 DFB6 E5              11      PUSH    HL
001B41 DFB7 CD8BDF          17      CALL    NCL3
001B44 DFBA 3809            12      JR  C,GNC1
001B46 DFBC 5E               7      LD  E,(HL)
001B47 DFBD 23               6      INC HL
001B48 DFBE 7E               7      LD  A,(HL)
001B49 DFBF E60F             7      AND 00FH
001B4B DFC1 57               4      LD  D,A
001B4C DFC2 E1              10      POP HL
001B4D DFC3 C1              10      POP BC
001B4E DFC4 C9              10      RET
       DFC5                     GNC1:
001B4F DFC5 7E               7      LD  A,(HL)
001B50 DFC6 23               6      INC HL
001B51 DFC7 56               7      LD  D,(HL)
001B52 DFC8 0604             7      LD  B,4
       DFCA                     GNC1L:
001B54 DFCA CB3A             8      SRL D   ;DA=DA/2
001B56 DFCC 1F               4      RRA     ;
001B57 DFCD 10FB            13      DJNZ    GNC1L
                                
001B59 DFCF 5F               4      LD  E,A
001B5A DFD0 E1              10      POP HL
001B5B DFD1 C1              10      POP BC
001B5C DFD2 A7               4      AND A
001B5D DFD3 C9              10      RET
                                
       DFD4                     SNCL:
001B5E DFD4 CD58DF          17      CALL    NCL1
001B61 DFD7 D8              11      RET C
                                ;               SET NEXT CLUSTER
001B62 DFD8 E5              11      PUSH    HL
001B63 DFD9 C5              11      PUSH    BC
001B64 DFDA D5              11      PUSH    DE
001B65 DFDB E5              11      PUSH    HL
001B66 DFDC CD8BDF          17      CALL    NCL3
001B69 DFDF D1              10      POP DE
                                ;CF=ODD
001B6A DFE0 7E               7      LD  A,(HL)
001B6B DFE1 73               7      LD  (HL),E
001B6C DFE2 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
001B6E DFE4 23               6      INC HL
001B6F DFE5 ED67            18      RRD     ;M={A[3:0],E[3:0]}
001B71 DFE7 7A               4      LD  A,D
001B72 DFE8 1804            12      JR  SNC11
       DFEA                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
001B74 DFEA ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001B76 DFEC 23               6      INC HL
001B77 DFED 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       DFEE                     SNC11:
001B78 DFEE ED6F            18      RLD     ;M={M[7:4],D[3:0]}
001B7A DFF0 B7               4      OR  A
001B7B DFF1 D1              10      POP DE
001B7C DFF2 C1              10      POP BC
001B7D DFF3 E1              10      POP HL
       DFF4                     FAT_CHANGED:
001B7E DFF4 3EFF             7      LD  A,0FFH
001B80 DFF6 32A2E5          13      LD  (_WTFATF),A
001B83 DFF9 C9              10      RET
                                
       DFFA                     N16CL3:
001B84 DFFA C5              11      PUSH    BC
001B85 DFFB 6B               4      LD  L,E
001B86 DFFC 7A               4      LD  A,D
001B87 DFFD E601             7      AND 1
001B89 DFFF 67               4      LD  H,A
001B8A E000 29              11      ADD HL,HL
001B8B E001 ED4B7CE6        20      LD  BC,(_FATBF)
001B8F E005 09              11      ADD HL,BC
001B90 E006 C1              10      POP BC
001B91 E007 C9              10      RET
                                
       E008                     GNCL16:
001B92 E008 CD51DF          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
001B95 E00B D8              11      RET C
001B96 E00C E5              11      PUSH    HL
001B97 E00D CDFADF          17      CALL    N16CL3
001B9A E010 5E               7      LD  E,(HL)
001B9B E011 23               6      INC HL
001B9C E012 56               7      LD  D,(HL)
001B9D E013 E1              10      POP HL
001B9E E014 C9              10      RET
                                
       E015                     SNCL16:
001B9F E015 CD51DF          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
001BA2 E018 D8              11      RET C
001BA3 E019 D5              11      PUSH    DE
001BA4 E01A E5              11      PUSH    HL
001BA5 E01B CDFADF          17      CALL    N16CL3
001BA8 E01E D1              10      POP DE      ;HL
001BA9 E01F 73               7      LD  (HL),E
001BAA E020 23               6      INC HL
001BAB E021 72               7      LD  (HL),D
001BAC E022 6B               4      LD  L,E
001BAD E023 62               4      LD  H,D
001BAE E024 D1              10      POP DE
001BAF E025 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E027                     NEXTX:
001BB1 E027 3E00             7      LD  A,0 ;自己書き換え
       E028                     _SECPS  EQU $-1
001BB3 E029 3C               4      INC A
001BB4 E02A E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E02B                     _NCPAT  EQU $-1
001BB6 E02C 3228E0          13      LD  (_SECPS),A
001BB9 E02F C9              10      RET
                                
       E030                     GNCLX:
001BBA E030 CD27E0          17      CALL    NEXTX
001BBD E033 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001BBE E034 C3F7E5          10      JP  _GNCL   ;次のクラスタを探す
                                
       E037                     RDFAT:
001BC1 E037 3E80             7      LD  A,080H
001BC3 E039 3270E5          13      LD  (CHECK),A
       E03C                     RDFAT1:
001BC6 E03C 3A88E5          13      LD  A,(_DRV)
001BC9 E03F CDDFE2          17      CALL    CHGDRVR
001BCC E042 D8              11      RET C
001BCD E043 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001BD0 E046 CB6F             8      BIT 5,A
001BD2 E048 286C            12      JR  Z,RDFAT0X
001BD4 E04A 2170E5          10      LD  HL,CHECK
001BD7 E04D A6               7      AND (HL)
001BD8 E04E 77               7      LD  (HL),A
001BD9 E04F 110000          10      LD  DE,0        ;BPB
001BDC E052 2A7CE6          16      LD  HL,(_FATBF)
001BDF E055 0E00             7      LD  C,0
001BE1 E057 CDB7E1          17      CALL    DRD24
001BE4 E05A 3022            12      JR  NC,GETBPB
001BE6 E05C 2170E5          10      LD  HL,CHECK
001BE9 E05F CB06            15      RLC (HL)
001BEB E061 3F               4      CCF
001BEC E062 D8              11      RET C
001BED E063 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
001BF1 E067 3F               4      CCF         ;フロッピーディスクのFDモード(2D/2HD)を切り替える
001BF2 E068 DDCB0A16        23      RL  (IX+DPB_FDMODE)
001BF6 E06C 3A84E5          13      LD  A,(_DRIVE)
001BF9 E06F E603             7      AND 3
001BFB E071 F680             7      OR  080H
001BFD E073 6F               4      LD  L,A
001BFE E074 26E5             7      LD  H,_CYL0/256
001C00 E076 3EFF             7      LD  A,0FFH
001C02 E078 3289E5          13      LD  (_DSK),A
001C05 E07B 77               7      LD  (HL),A
001C06 E07C 18BE            12      JR  RDFAT1
       E07E                     GETBPB:
001C08 E07E FDE5            15      PUSH    IY
001C0A E080 FD2A7CE6        20      LD  IY,(_FATBF) ;BPB
001C0E E084 CDF1E5          17      CALL    _BPB2DPB
001C11 E087 FDE1            14      POP IY
001C13 E089 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001C16 E08C 3025            12      JR  NC,GETBPBOK
001C18 E08E E60F             7      AND 00FH
001C1A E090 FE07             7      CP  7
001C1C E092 37               4      SCF
001C1D E093 C0              11      RET NZ
001C1E E094 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001C22 E098 21C0E6          10      LD  HL,M2D
001C25 E09B 2006            12      JR  NZ,SETFDMODE
001C27 E09D CD90E1          17      CALL    CHECK1024
001C2A E0A0 D8              11      RET C
001C2B E0A1 2ED2             7      LD  L,M2HD-STABLE
       E0A3                     SETFDMODE:
001C2D E0A3 DDE5            15      PUSH    IX
001C2F E0A5 D1              10      POP DE
001C30 E0A6 EDA0            16      LDI
001C32 E0A8 EDA0            16      LDI
001C34 E0AA 13               6      INC DE
001C35 E0AB 13               6      INC DE
001C36 E0AC 13               6      INC DE
001C37 E0AD 13               6      INC DE
001C38 E0AE 010C00          10      LD  BC,12
001C3B E0B1 EDB0                    LDIR
       E0B3                     GETBPBOK:
001C3D E0B3 CD4BE2          17      CALL    CHGDRV2
       E0B6                     RDFAT0X:
001C40 E0B6 CDABE1          17      CALL    RDFATS
001C43 E0B9 D8              11      RET C
001C44 E0BA DDAE06          19      XOR (IX+DPB_FATID)
001C47 E0BD C8              11      RET Z
001C48 E0BE DD7E12          19      LD  A,(IX+DPB_DEVICE)
001C4B E0C1 CB5F             8      BIT 3,A
001C4D E0C3 2803            12      JR  Z,RDFAT0X1
001C4F E0C5 CB6F             8      BIT 5,A
001C51 E0C7 C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E0C8                     RDFAT0X1:
001C52 E0C8 37               4      SCF
001C53 E0C9 C9              10      RET
                                
       E0CA                     POP_HL_SCF_RET:
001C54 E0CA E1              10      POP HL
001C55 E0CB 37               4      SCF
001C56 E0CC C9              10      RET
                                
       E0CD                     BPB2DPB:
001C57 E0CD FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
001C5A E0D0 B7               4      OR  A
001C5B E0D1 37               4      SCF
001C5C E0D2 C0              11      RET NZ
       E0D3                     BPBOK:
001C5D E0D3 FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001C60 E0D6 DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001C63 E0D9 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001C66 E0DC DD7700          19      LD  (IX+DPB_FATLN),A
001C69 E0DF FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
001C6C E0E2 DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
001C6F E0E5 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001C72 E0E8 FD660F          19      LD  H,(IY+15)
001C75 E0EB DD750E          19      LD  (IX+DPB_FATPS),L
001C78 E0EE FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001C7B E0F1 FD5617          19      LD  D,(IY+23)
001C7E E0F4 FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E0F7                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001C81 E0F7 19              11      ADD HL,DE
001C82 E0F8 10FD            13      DJNZ    BPBDP1
       E0FA                     BPBDP2:
001C84 E0FA DD7510          19      LD  (IX+DPB_DIRPS),L
001C87 E0FD DD7411          19      LD  (IX+DPB_DIRPS+1),H
001C8A E100 E5              11      PUSH    HL
                                
001C8B E101 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
001C8E E104 FD6612          19      LD  H,(IY+18)
001C91 E107 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001C94 E10A B7               4      OR  A
001C95 E10B 28BD            12      JR  Z,POP_HL_SCF_RET
001C97 E10D 0606             7      LD  B,6
       E10F                     BPBBPS1:
001C99 E10F 05               4      DEC B
001C9A E110 0F               4      RRCA
001C9B E111 30FC            12      JR  NC,BPBBPS1
       E113                     BPBDE1:
001C9D E113 29              11      ADD HL,HL
001C9E E114 10FD            13      DJNZ    BPBDE1
                                
001CA0 E116 7C               4      LD  A,H
001CA1 E117 DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
001CA4 E11A D1              10      POP DE      ;DPB_DIRPS
001CA5 E11B 6C               4      LD  L,H
001CA6 E11C 2600             7      LD  H,0
001CA8 E11E 19              11      ADD HL,DE       ;MAXDIR
001CA9 E11F E5              11      PUSH    HL
001CAA E120 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001CAD E123 CB21             8      SLA C       ;*2
001CAF E125 AF               4      XOR A
001CB0 E126 47               4      LD  B,A
001CB1 E127 ED42            15      SBC HL,BC
001CB3 E129 DD7514          19      LD  (IX+DPB_ADDCL),L
001CB6 E12C DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
001CB9 E12F D1              10      POP DE      ;DE=DPB_MAXDIR
001CBA E130 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001CBD E133 FD6614          19      LD  H,(IY+20)
                                
001CC0 E136 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001CC3 E139 E60F             7      AND 00FH
001CC5 E13B FE07             7      CP  7       ;フロッピー
001CC7 E13D 2019            12      JR  NZ,NOT_FD
001CC9 E13F E5              11      PUSH    HL
001CCA E140 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001CCD E143 DD710D          19      LD  (IX+DPB_MAXSEC),C
001CD0 E146 AF               4      XOR A
001CD1 E147 CB21             8      SLA C       ;両面なのでセクタ数を２倍
001CD3 E149 0610             7      LD  B,16
       E14B                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001CD5 E14B 29              11      ADD HL,HL
001CD6 E14C 17               4      RLA
001CD7 E14D B9               4      CP  C
001CD8 E14E 3802            12      JR  C,DIVSEC1
001CDA E150 91               4      SUB C
001CDB E151 2C               4      INC L
       E152                     DIVSEC1:
001CDC E152 10F7            13      DJNZ    DIVSEC
001CDE E154 DD750C          19      LD  (IX+DPB_MAXCYL),L
001CE1 E157 E1              10      POP HL  ;ここまでフロッピー専用
       E158                     NOT_FD:
001CE2 E158 7C               4      LD  A,H
001CE3 E159 B5               4      OR  L
001CE4 E15A 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001CE6 E15C 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001CE8 E15E 2F               4      CPL         ;A=0FFH
001CE9 E15F FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001CEC E162 D8              11      RET C
001CED E163 FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001CF0 E166 FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001CF3 E169 FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E16C                     BPB16BIT:
001CF6 E16C ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001CF8 E16E DE00             7      SBC A,0
001CFA E170 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E173                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001CFD E173 CB18             8      RR  B       ;->CY
001CFF E175 3808            12      JR  C,BPBTC2
001D01 E177 CB3F             8      SRL A
001D03 E179 CB1C             8      RR  H       ;AHL=AHL/2
001D05 E17B CB1D             8      RR  L
001D07 E17D 18F4            12      JR  BPBTC1
       E17F                     BPBTC2:
001D09 E17F C6FF             7      ADD A,0FFH
001D0B E181 D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001D0C E182 23               6      INC HL
001D0D E183 23               6      INC HL
001D0E E184 DD7508          19      LD  (IX+DPB_MAXCL),L
001D11 E187 DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001D14 E18A FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001D17 E18D DD7706          19      LD  (IX+DPB_FATID),A
       E190                     CHECK1024:
001D1A E190 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001D1D E193 C6FE             7      ADD A,0-2       ;>2:CF=1
001D1F E195 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001D22 E198 6F               4      LD  L,A
001D23 E199 3002            12      JR  NC,BPBFAT1
001D25 E19B F680             7      OR  080H
       E19D                     BPBFAT1:            ;ここではCF=0
001D27 E19D DD770F          19      LD  (IX+DPB_BPS),A
001D2A E1A0 3A7BE6          13      LD  A,(_MAX_SEC_SZ_H)
001D2D E1A3 BD               4      CP  L
001D2E E1A4 C8              11      RET Z       ;1セクタ1024バイト
001D2F E1A5 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001D30 E1A6 C8              11      RET Z       ;1セクタ256バイト
001D31 E1A7 2D               4      DEC L
001D32 E1A8 C8              11      RET Z       ;1セクタ512バイト
001D33 E1A9 37               4      SCF
001D34 E1AA C9              10      RET
                                
       E1AB                     RDFATS:
001D35 E1AB CDD6E1          17      CALL    FATSETUP
001D38 E1AE D8              11      RET C
001D39 E1AF CDB9E1          17      CALL    DRD24B
001D3C E1B2 2A7CE6          16      LD  HL,(_FATBF)
001D3F E1B5 7E               7      LD  A,(HL)
001D40 E1B6 C9              10      RET
                                
       E1B7                     DRD24:
001D41 E1B7 0601             7      LD  B,1
       E1B9                     DRD24B:
001D43 E1B9 DDE5            15      PUSH    IX
001D45 E1BB DD2AA8E5        20      LD  IX,(_DPB)
001D49 E1BF CD24E3          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E1C0                     DRDPAT  EQU $-2
001D4C E1C2 DDE1            14      POP IX
001D4E E1C4 C9              10      RET
                                
       E1C5                     DWT24:
001D4F E1C5 0601             7      LD  B,1
       E1C7                     DWT24B:
001D51 E1C7 DDE5            15      PUSH    IX
001D53 E1C9 DD2AA8E5        20      LD  IX,(_DPB)
001D57 E1CD CD22E3          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E1CE                     DWTPAT  EQU $-2
001D5A E1D0 DDE1            14      POP IX
001D5C E1D2 D0              11      RET NC
001D5D E1D3 C35AE5          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E1D6                     FATSETUP:
001D60 E1D6 3AAAE5          13      LD  A,(_FATDRV)
001D63 E1D9 CDDFE2          17      CALL    CHGDRVR     ;ドライブ切り替え
001D66 E1DC D8              11      RET C
       E1DD                     FATS2:
001D67 E1DD DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001D6A E1E0 0F               4      RRCA
001D6B E1E1 CD11E2          17      CALL    FATSETUP12  ;自己書き換え
       E1E2                     FATSX   EQU $-2
001D6E E1E4 210000          10      LD  HL,0
001D71 E1E7 4A               4      LD  C,D
001D72 E1E8 54               4      LD  D,H
001D73 E1E9 3AABE5          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
001D76 E1EC 47               4      LD  B,A
001D77 E1ED 04               4      INC B
001D78 E1EE DD7E00          19      LD  A,(IX+DPB_FATLN)
       E1F1                     FAT_SKP:
001D7B E1F1 05               4      DEC B
001D7C E1F2 2809            12      JR  Z,FAT1
001D7E E1F4 19              11      ADD HL,DE
001D7F E1F5 93               4      SUB E
001D80 E1F6 30F9            12      JR  NC,FAT_SKP
001D82 E1F8 DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
001D86 E1FC C8              11      RET Z
       E1FD                     FAT1:
001D87 E1FD EB               4      EX  DE,HL
001D88 E1FE B7               4      OR  A       ;0の場合は0100Hとして扱う
001D89 E1FF 2803            12      JR  Z,FAT3
001D8B E201 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001D8C E202 3801            12      JR  C,FAT2
       E204                     FAT3:
001D8E E204 79               4      LD  A,C
       E205                     FAT2:
001D8F E205 47               4      LD  B,A
                                
001D90 E206 2AFAE6          16      LD  HL,(_FATPS) ;fat sector pos
001D93 E209 19              11      ADD HL,DE
001D94 E20A EB               4      EX  DE,HL
001D95 E20B 2A7CE6          16      LD  HL,(_FATBF)
001D98 E20E AF               4      XOR A       ;CF=0
001D99 E20F 4F               4      LD  C,A
001D9A E210 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E211                     FATSETUP12:
001D9B E211 110606          10      LD  DE,0606H    ;256
001D9E E214 D8              11      RET C
001D9F E215 110303          10      LD  DE,0303H    ;512
001DA2 E218 0F               4      RRCA
001DA3 E219 D8              11      RET C
001DA4 E21A 110102          10      LD  DE,0201H    ;1024
001DA7 E21D C9              10      RET
                                
       E21E                     FATSETUP16:
001DA8 E21E 110404          10      LD  DE,0404H    ;256
001DAB E221 D8              11      RET C
001DAC E222 110202          10      LD  DE,0202H    ;512
001DAF E225 0F               4      RRCA
001DB0 E226 D8              11      RET C
001DB1 E227 110101          10      LD  DE,0101H    ;1024
001DB4 E22A C9              10      RET
                                
       E22B                     CHGDRV:
001DB5 E22B E5              11      PUSH    HL
001DB6 E22C 2189E5          10      LD  HL,_DSK
001DB9 E22F BE               7      CP  (HL)
001DBA E230 280A            12      JR  Z,CHGDRVE
       E232                     CHGDRV1:
001DBC E232 DDE5            15      PUSH    IX
001DBE E234 CD3EE2          17      CALL    CHGDRV0
001DC1 E237 3A89E5          13      LD  A,(_DSK)
001DC4 E23A DDE1            14      POP IX
       E23C                     CHGDRVE:
001DC6 E23C E1              10      POP HL
001DC7 E23D C9              10      RET
                                
       E23E                     CHGDRV0:
001DC8 E23E 6F               4      LD  L,A
001DC9 E23F CDDCE5          17      CALL    _GETDPB
001DCC E242 D8              11      RET C
001DCD E243 DD22A8E5        20      LD  (_DPB),IX
001DD1 E247 7D               4      LD  A,L
001DD2 E248 3289E5          13      LD  (_DSK),A
       E24B                     CHGDRV2:
001DD5 E24B C5              11      PUSH    BC
001DD6 E24C D5              11      PUSH    DE
001DD7 E24D ED7396E2        20      LD  (SPPAT2),SP
001DDB E251 F3               4      DI
001DDC E252 DDF9            10      LD  SP,IX
                                
001DDE E254 E1              10      POP HL      ;00:DPB_FATLN
001DDF E255 E1              10      POP HL      ;02:DPB_DRD
001DE0 E256 22C0E1          16      LD  (DRDPAT),HL
                                
001DE3 E259 E1              10      POP HL
001DE4 E25A 22CEE1          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001DE7 E25D E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001DE8 E25E 7C               4      LD  A,H
001DE9 E25F 32C4D8          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001DEC E262 3D               4      DEC A
001DED E263 322BE0          13      LD  (_NCPAT),A
                                
001DF0 E266 E1              10      POP HL      ;08:DPB_MAXCL
001DF1 E267 7D               4      LD  A,L
001DF2 E268 32E3D8          13      LD  (CLPAT2),A
001DF5 E26B 7C               4      LD  A,H
001DF6 E26C 32DFD8          13      LD  (CLPAT1),A
001DF9 E26F 2B               6      DEC HL
001DFA E270 22E2DA          16      LD  (MAXCLP),HL
                                
001DFD E273 E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001DFE E274 4C               4      LD  C,H
                                
001DFF E275 E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001E00 E276 E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001E01 E277 7C               4      LD  A,H     ;DPB_BPS
001E02 E278 E607             7      AND 7
001E04 E27A 329DDD          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001E07 E27D 87               4      ADD A,A     ;8  4   2
001E08 E27E 87               4      ADD A,A     ;010H   8   4
001E09 E27F 87               4      ADD A,A     ;020H   010H    8
001E0A E280 3242D7          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001E0D E283 2600             7      LD  H,0
001E0F E285 22FAE6          16      LD  (_FATPS),HL
                                
001E12 E288 E1              10      POP HL      ;10:DPB_DIRPS
001E13 E289 22FCE6          16      LD  (_DIRPS),HL
                                
001E16 E28C E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001E17 E28D 7C               4      LD  A,H
001E18 E28E 3284E5          13      LD  (_DRIVE),A
                                
001E1B E291 E1              10      POP HL      ;14:DPB_ADDCL
001E1C E292 22D4D8          16      LD  (CLSPAT),HL
                                
001E1F E295 310000          10      LD  SP,0        ;元のSPを復元
       E296                     SPPAT2  EQU $-2
001E22 E298 FB               4      EI
001E23 E299 2AFCE6          16      LD  HL,(_DIRPS)
001E26 E29C 0600             7      LD  B,0
001E28 E29E 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001E29 E29F 225DD7          16      LD  (MD_PAT),HL
                                
001E2C E2A2 2AE2DA          16      LD  HL,(MAXCLP)
001E2F E2A5 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001E32 E2A8 19              11      ADD HL,DE
001E33 E2A9 380F            12      JR  C,SETFAT16
001E35 E2AB 21B1DF          10      LD  HL,GNCL     ;FAT12
001E38 E2AE 11D4DF          10      LD  DE,SNCL
001E3B E2B1 0111E2          10      LD  BC,FATSETUP12
001E3E E2B4 DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001E42 E2B8 180D            12      JR  EXTRA1
       E2BA                     SETFAT16:
001E44 E2BA 2108E0          10      LD  HL,GNCL16   ;FAT16
001E47 E2BD 1115E0          10      LD  DE,SNCL16
001E4A E2C0 011EE2          10      LD  BC,FATSETUP16
001E4D E2C3 DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       E2C7                     EXTRA1:
001E51 E2C7 22F8E5          16      LD  (GNCPAT),HL
001E54 E2CA ED53FBE5        20      LD  (SNCPAT),DE
001E58 E2CE ED43E2E1        20      LD  (FATSX),BC
001E5C E2D2 D1              10      POP DE
001E5D E2D3 C1              10      POP BC
001E5E E2D4 AF               4      XOR A
001E5F E2D5 C9              10      RET
                                
       E2D6                     GETDPBD:
001E60 E2D6 DDE3            23      EX  (SP),IX
001E62 E2D8 DDE5            15      PUSH    IX
001E64 E2DA 3A88E5          13      LD  A,(_DRV)
001E67 E2DD 1807            12      JR  GETDPB1
                                
       E2DF                     CHGDRVR:
001E69 E2DF CDD9E5          17      CALL    _CHGDRV
001E6C E2E2 D8              11      RET C
001E6D E2E3 3A89E5          13      LD  A,(_DSK)
       E2E6                     GETDPB1:
001E70 E2E6 C3DCE5          10      JP  _GETDPB
                                
       E2E9                     GETDPB:
001E73 E2E9 FE08             7      CP  8
001E75 E2EB 3F               4      CCF
001E76 E2EC D8              11      RET C
001E77 E2ED 0F               4      RRCA
001E78 E2EE 0F               4      RRCA
001E79 E2EF 0F               4      RRCA
001E7A E2F0 DD                      DB  0DDH        ;Z80未定義命令
001E7B E2F1 6F               4      LD  L,A     ;LD IXL,A
001E7C E2F2 DD                      DB  0DDH        ;Z80未定義命令
001E7D E2F3 26E7             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001E7F E2F5 DD7E00          19      LD  A,(IX+DPB_FATLN)
001E82 E2F8 A7               4      AND A       ;CF=0の為
001E83 E2F9 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001E87 E2FD C0              11      RET NZ      ;FAT16
001E88 E2FE DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001E8C E302 C0              11      RET NZ      ;BPB
001E8D E303 FE01             7      CP  001H        ;A=0 THEN CF=1
001E8F E305 C9              10      RET
                                
       E306                     _SYS5F:
001E90 E306 AF               4      XOR A
       E307                     FFLUSH:
001E91 E307 F5              11      PUSH    AF
001E92 E308 CD2FDF          17      CALL    WTFATX
001E95 E30B AF               4      XOR A
001E96 E30C 32ABE5          13      LD  (_FATIX),A
001E99 E30F 2F               4      CPL         ;0FFH
001E9A E310 32AAE5          13      LD  (_FATDRV),A
001E9D E313 3E                      DB  03EH        ;次のPUSH AFをスキップ
       E314                     FFLUSHBUF:
001E9E E314 F5              11      PUSH    AF
001E9F E315 CDE5DE          17      CALL    DWTX
001EA2 E318 3EFF             7      LD  A,0FFH
001EA4 E31A 3239E5          13      LD  (SFILE),A
001EA7 E31D 32A5E5          13      LD  (_DBDRV),A
001EAA E320 F1              10      POP AF
001EAB E321 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "MSXDISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MSX
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       E322                     WTTRK:
       E322                     FDWT:
001EAC E322 37               4      SCF
001EAD E323 C9              10      RET
       E324                     FDRD:
001EAE E324 ED73B5E3        20      LD  (DRDSP),SP
001EB2 E328 3AB6E3          13      LD  A,(DRDSPH)  ;スタックがカートリッジと被っていないかチェック
001EB5 E32B FE7F             7      CP  07FH
001EB7 E32D 3807            12      JR  C,FDRD1
001EB9 E32F FEC1             7      CP  0C1H
001EBB E331 3003            12      JR  NC,FDRD1
001EBD E333 315EF5          10      LD  SP,BUF
       E336                     FDRD1:
001EC0 E336 C5              11      PUSH    BC
001EC1 E337 D5              11      PUSH    DE
                                
001EC2 E338 E5              11      PUSH    HL
001EC3 E339 EB               4      EX  DE,HL
001EC4 E33A DD460F          19      LD  B,(IX+DPB_BPS)
       E33D                     EADR1:
001EC7 E33D CB18             8      RR  B
001EC9 E33F 3803            12      JR  C,EADR2
001ECB E341 29              11      ADD HL,HL
001ECC E342 18F9            12      JR  EADR1
       E344                     EADR2:
001ECE E344 E5              11      PUSH    HL  ;あとでDEで受け取る
001ECF E345 29              11      ADD HL,HL   ;64KB→32KB
001ED0 E346 29              11      ADD HL,HL   ;32KB→16KB
       E347                     ASCII16K1:
001ED1 E347 29              11      ADD HL,HL   ;16KB→8KB  ;ASCII-16Kの場合はここがNOPに置き換えられる
                                
001ED2 E348 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;16KB単位でカートリッジ内のディスクが存在する位置を指定
       E34B                     ASCII16K2:
001ED5 E34B 87               4      ADD A,A         ;ASCII-16Kの場合はここがNOPに置き換えられる
001ED6 E34C 84               4      ADD A,H
001ED7 E34D 5F               4      LD  E,A
001ED8 E34E 3A62E5          13      LD  A,(ROM_SLT)
001EDB E351 210070          10      LD  HL,BANK2_SEL
       E352                     ROM8000H    EQU $-2
001EDE E354 CD6FD4          17      CALL    WRSLT
                                
001EE1 E357 2680             7      LD  H,080H
001EE3 E359 3A62E5          13      LD  A,(ROM_SLT) ;カートリッジROMに切り替える
001EE6 E35C CDE2D4          17      CALL    ENASLT
                                
001EE9 E35F D1              10      POP DE
001EEA E360 E1              10      POP HL      ;HLは読み出し先のメモリアドレス
                                
001EEB E361 7B               4      LD  A,E
001EEC E362 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F/16K:3F)
       E363                     ASCII16K3   EQU $-1
001EEE E364 1E00             7      LD  E,0     ;DEはROMディスクから読み出すアドレス
001EF0 E366 C680             7      ADD A,080H
001EF2 E368 57               4      LD  D,A
                                
001EF3 E369 3E                      DB  03EH
001EF4 E36A A7               4      AND A
001EF5 E36B 3298E3          13      LD  (DRD_SWC3),A
001EF8 E36E 7C               4      LD  A,H     ;読み出し先がカートリッジと被っていないかチェック
001EF9 E36F FE7B             7      CP  07BH
001EFB E371 3812            12      JR  C,DRD2
001EFD E373 FEC1             7      CP  0C1H
001EFF E375 300E            12      JR  NC,DRD2
001F01 E377 229FE3          16      LD  (DRD_SWC1),HL   ;被っている場合はデータバッファをフラッシュして一時的に使う
001F04 E37A 2A7EE6          16      LD  HL,(_DTBUF)
001F07 E37D 3E                      DB  03EH
001F08 E37E 37               4      SCF
001F09 E37F 3298E3          13      LD  (DRD_SWC3),A
001F0C E382 CD14E3          17      CALL    FFLUSHBUF
       E385                     DRD2:
001F0F E385 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001F12 E388 E607             7      AND 7
001F14 E38A 47               4      LD  B,A
001F15 E38B 4B               4      LD  C,E ;E=0
                                
001F16 E38C EB               4      EX  DE,HL
001F17 E38D EDB0                    LDIR
001F19 E38F D5              11      PUSH    DE
001F1A E390 2680             7      LD  H,080H
001F1C E392 3A43F3          13      LD  A,(0F341H+2)    ;メインRAMに戻す
001F1F E395 CDE2D4          17      CALL    ENASLT
       E398                     DRD_SWC3:
001F22 E398 A7               4      AND A       ;自己書き換え)被っている場合はSCFになる
001F23 E399 3012            12      JR  NC,DRD3
                                
001F25 E39B 2A7EE6          16      LD  HL,(_DTBUF)
001F28 E39E 110000          10      LD  DE,0
       E39F                     DRD_SWC1    EQU $-2
001F2B E3A1 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001F2E E3A4 E607             7      AND 7
001F30 E3A6 47               4      LD  B,A
001F31 E3A7 0E00             7      LD  C,0
001F33 E3A9 EDB0                    LDIR
001F35 E3AB E1              10      POP HL
001F36 E3AC D5              11      PUSH    DE
       E3AD                     DRD3:
001F37 E3AD E1              10      POP HL
001F38 E3AE D1              10      POP DE
001F39 E3AF 13               6      INC DE
001F3A E3B0 C1              10      POP BC
001F3B E3B1 1083            13      DJNZ    FDRD1
001F3D E3B3 AF               4      XOR A
001F3E E3B4 310000          10      LD  SP,0
       E3B5                     DRDSP   EQU $-2
       E3B6                     DRDSPH  EQU $-1
001F41 E3B7 FB               4      EI
001F42 E3B8 C9              10      RET
                                
       E3B9                     PDWT:
001F43 E3B9 37               4      SCF
001F44 E3BA CB7C             8      BIT 7,H
001F46 E3BC 2058            12      JR  NZ,PDWX
001F48 E3BE CD14E3          17      CALL    FFLUSHBUF
       E3C1                     PDWT1:
001F4B E3C1 C5              11      PUSH    BC
001F4C E3C2 D5              11      PUSH    DE
001F4D E3C3 ED5B7EE6        20      LD  DE,(_DTBUF)
001F51 E3C7 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001F54 E3CA E607             7      AND 7
001F56 E3CC 47               4      LD  B,A
001F57 E3CD 0E00             7      LD  C,0
001F59 E3CF EDB0                    LDIR
001F5B E3D1 E3              19      EX  (SP),HL
001F5C E3D2 EB               4      EX  DE,HL
001F5D E3D3 D5              11      PUSH    DE
001F5E E3D4 2A7EE6          16      LD  HL,(_DTBUF)
001F61 E3D7 0601             7      LD  B,1
001F63 E3D9 37               4      SCF
001F64 E3DA CD16E4          17      CALL    PDWX
001F67 E3DD 3832            12      JR  C,PDRWERR
001F69 E3DF D1              10      POP DE
001F6A E3E0 13               6      INC DE
001F6B E3E1 E1              10      POP HL
001F6C E3E2 C1              10      POP BC
001F6D E3E3 10D4            13      DJNZ    PDWT
001F6F E3E5 AF               4      XOR A
001F70 E3E6 C9              10      RET
       E3E7                     PDRD:
001F71 E3E7 CB7C             8      BIT 7,H
001F73 E3E9 202A            12      JR  NZ,PDWXR
001F75 E3EB CD14E3          17      CALL    FFLUSHBUF
       E3EE                     PDRD1:
001F78 E3EE C5              11      PUSH    BC
001F79 E3EF D5              11      PUSH    DE
001F7A E3F0 E5              11      PUSH    HL
001F7B E3F1 2A7EE6          16      LD  HL,(_DTBUF)
001F7E E3F4 0601             7      LD  B,1
001F80 E3F6 CD15E4          17      CALL    PDWXR
001F83 E3F9 3816            12      JR  C,PDRWERR
001F85 E3FB D1              10      POP DE
001F86 E3FC 2A7EE6          16      LD  HL,(_DTBUF)
001F89 E3FF DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001F8C E402 E607             7      AND 7
001F8E E404 47               4      LD  B,A
001F8F E405 0E00             7      LD  C,0
001F91 E407 EDB0                    LDIR
001F93 E409 EB               4      EX  DE,HL
001F94 E40A D1              10      POP DE
001F95 E40B 13               6      INC DE
001F96 E40C C1              10      POP BC
001F97 E40D 10D8            13      DJNZ    PDRD
001F99 E40F AF               4      XOR A
001F9A E410 C9              10      RET
       E411                     PDRWERR:
001F9B E411 E1              10      POP HL
001F9C E412 D1              10      POP DE
001F9D E413 C1              10      POP BC
001F9E E414 C9              10      RET
       E415                     PDWXR:
001F9F E415 A7               4      AND A
       E416                     PDWX:                   ;CF=0 READ CF=1 WRITE
001FA0 E416 DDCB1266        20      BIT 4,(IX+DPB_DEVICE)   ;デバイス情報
001FA4 E41A 2003            12      JR  NZ,PDWX1
001FA6 E41C DD4E06          19      LD  C,(IX+DPB_FATID)    ;メディアバイト
       E41F                     PDWX1:
001FA9 E41F DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
001FAC E422 C5              11      PUSH    BC
001FAD E423 D5              11      PUSH    DE
001FAE E424 E5              11      PUSH    HL
001FAF E425 DDE5            15      PUSH    IX
001FB1 E427 FDE5            15      PUSH    IY
001FB3 E429 CDA7FF          17      CALL    H_PHYD
001FB6 E42C FDE1            14      POP IY
                                ;   LD  IX,PHYDIO
                                ;   CALL    CALSLT_R
001FB8 E42E DDE1            14      POP IX
001FBA E430 E1              10      POP HL
001FBB E431 D1              10      POP DE
001FBC E432 C1              10      POP BC
001FBD E433 D8              11      RET C
       E434                     PDWX2:
001FBE E434 13               6      INC DE
001FBF E435 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001FC2 E438 E607             7      AND 7
001FC4 E43A 84               4      ADD A,H
001FC5 E43B 67               4      LD  H,A
001FC6 E43C 10F6            13      DJNZ    PDWX2
001FC8 E43E AF               4      XOR A
001FC9 E43F C9              10      RET
[EOF:MSXDISK.ASM:UTF_8]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001FCA E440                     PATHD:  DS  PATHX
002005 E47B 00                  PATHE:  DB  0
                                
       E47C                     DTA_CCP:
002006 E47C                         DS  37
                                
       E4A1                     FCB_BAT:
00202B E4A1                         DS  37
                                
002050 E4C6 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
00205B E4D1 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
                                ;   ALIGN   256
       E4D8                     AT_WORK:
002062 E4D8                         DS  WORKAD-AT_WORK
                                
       E500                     CPM_BOOT:
00208A E500 C30000          10      JP  0
       E503                     _SYS00:     ;(BDOS)プログラム終了
       E503                     CPM_WBOOT:
00208D E503 C315CA          10      JP  WBOOT1
       E506                     CPM_CONST:
002090 E506 C369D2          10      JP  CONSTX
       E509                     _SYS07:     ;(BDOS)コンソール直接入力
       E509                     CPM_CONIN:
002093 E509 C38AD1          10      JP  FLGET
       E50C                     CPM_CONOUT:
002096 E50C C36CD3          10      JP  CONOUT1
                                
       E50F                     DECBF:              ;10進数表示時のバッファ(5バイト)
002099 E50F                         DS  5
       E50F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       E511                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       E514                     FDRV:
00209E E514 00                      DB  0
       E515                     FNAME:
00209F E515                         DS  36
       E539                     SFILE:
0020C3 E539                         DS  33      ;DRV FILENAME
       E55A                     _DISKE:
0020E4 E55A C306D1          10      JP  SHOW_ERROR
                                
0020E7 E55D 0000                LEFTX:  DW  0
0020E9 E55F 0000                DTAX:   DW  0
                                
                                ;   PSGのビープ音のデータ(X1)
       E561                     BEEPD:
0020EB E561 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
0020F3 E569 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                ;
       E562                     RTC_YY  EQU BEEPD+1 ;RTCのバッファ年(88)
       E563                     RTC_MW  EQU BEEPD+2 ;RTCのバッファ月(88)
       E564                     RTC_DD  EQU BEEPD+3 ;RTCのバッファ日(88)
       E565                     RTC_TT  EQU BEEPD+4 ;RTCのバッファ時(88)
       E566                     RTC_MM  EQU BEEPD+5 ;RTCのバッファ分(88)
       E567                     RTC_SS  EQU BEEPD+6 ;RTCのバッファ秒(88)
       E562                     ROM_SLT EQU BEEPD+1 ;ROMのスロット(MSX)
       E561                     ZERO    EQU BEEPD
                                
       E570                     CHECK:
0020FA E570 00                      DB  0
                                
       E571                     OK:
0020FB E571 4F4B24                  DB  "OK$"
0020FE E574                         DS  5
       E579                     COMERM:
002103 E579 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       E580                     _CYL0:
00210A E580 FF                      DB  0FFH    ;Cylinder
       E581                     _CYL1:
00210B E581 FF                      DB  0FFH    ;Cylinder
       E582                     _CYL2:
00210C E582 FF                      DB  0FFH    ;Cylinder
       E583                     _CYL3:
00210D E583 FF                      DB  0FFH    ;Cylinder
       E584                     _DRIVE:
00210E E584 00                      DB  0   ;unit number
       E585                     _SEEKSP:
00210F E585 00                      DB  0   ;Seek speed
       E586                     _ISEEK:
002110 E586 32                      DB  50  ;
002111 E587                         DS  1
       E588                     _DRV:
002112 E588 00                      DB  0
       E589                     _DSK:
002113 E589 FF                      DB  0FFH
       E58A                     _DTA:
002114 E58A 8000                    DW  00080H
       E58C                     _CTC:
002116 E58C 0000                    DW  0
       E58E                     _TXADR:
002118 E58E 0000                    DW  0
       E590                     _KEYPS:
00211A E590 0000                    DW  0
       E592                     _KEYD:
00211C E592 00                      DB  000H    ;キーデータ
       E593                     _KEYST:
00211D E593 FF                      DB  0FFH    ;キーステータス(SHIFT,CTRLの状態)
       E594                     _KEYSP_L:
00211E E594 00                      DB  KEYSP_L ;オートリピートの速度
       E595                     _KEYSP_H:
00211F E595 00                      DB  KEYSP_H ;オートリピートの速度
       E596                     _COLORF:
002120 E596 00                      DB  COLORF  ;色
       E597                     _LINE:
002121 E597 19                      DB  LINE
                                
                                            ;次のファイルの検索(C=12)で使用するFCB
       E598                     _FCB:
002122 E598 0000                    DW  0   ;SEARCH FILES
       E59A                     _FBPS:
002124 E59A 0000                    DW  0   ;    //
       E59C                     _FBAD:
002126 E59C 0000                    DW  0   ;    //
       E59E                     _FBCNT:
002128 E59E 00                      DB  0   ;    //
       E59F                     _FILEN:
002129 E59F 00                      DB  0   ;    //
       E5A0                     _DIRF:
00212A E5A0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
00212B E5A1                         DS  1
       E5A2                     _WTFATF:
00212C E5A2 00                      DB  0   ;FATバッファの更新フラグ
00212D E5A3                         DS  1
       E5A4                     _WTDBF:
00212E E5A4 00                      DB  0   ;データバッファの更新フラグ
       E5A5                     _DBDRV:
00212F E5A5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       E5A6                     _DBSEC:
002130 E5A6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       E5A8                     _DPB:
002132 E5A8 0000                    DW  0
       E5AA                     _FATDRV:
002134 E5AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       E5AB                     _FATIX:
002135 E5AB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       E5AC                     _FAKEFREE:
002136 E5AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
002138 E5AE                         DS  2
                                ;   画面周りのデータ
       E5B0                     CRTCD:
00213A E5B0 6F                      DB  06FH
       E5B1                     _WIDTH:
00213B E5B1 28                      DB  WIDTH
       E5B2                     TVRAMTOP:
00213C E5B2 5938                    DB  059H,038H
00213E E5B4 1F02                    DB  01FH,002H
       E5B6                     _LINE2:
002140 E5B6 19                      DB  019H
       E5B7                     WKE4:
002141 E5B7 1C                      DB  01CH
       E5B8                     WKE6:
002142 E5B8 00                      DB  000H
       E5B9                     WK40:
002143 E5B9 07                      DB  007H
       E5BA                     _PAGE_MINUS:
002144 E5BA 18FC                    DW  0-WIDTH*LINE
       E5BC                     _WIDTH_MINUS:
002146 E5BC D8FF                    DW  0-WIDTH
       E5BE                     WK30:
002148 E5BE 0C                      DB  00CH
       E5BF                     WK31:
       E5BF                     WK1FD0:
002149 E5BF 20                      DB  020H
                                
                                ;   割り込みベクタ(X1)
00214A E5C0 0000                CTC0:   DW  INTCTCE
00214C E5C2 0000                CTC1:   DW  INTCTCE
00214E E5C4 0000                CTC2:   DW  INTCTCE
002150 E5C6 0000                CTC3:   DW  INTCTCE
002152 E5C8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
002154 E5CA C3CFD1          10  _INKEY: JP  INKEY
002157 E5CD C30FD1          10  _PRINT: JP  PRINT
00215A E5D0 C306D3          10  _SCRN:  JP  SCRN
00215D E5D3 C3E6D2          10  _POS:   JP  POS
002160 E5D6 C3F1D2          10  _LOC:   JP  LOC
       E5D9                     _CHGDRV:
002163 E5D9 C32BE2          10      JP  CHGDRV
       E5DC                     _GETDPB:
002166 E5DC C3E9E2          10      JP  GETDPB
       E5DF                     _FFLUSH:
002169 E5DF C307E3          10      JP  FFLUSH
       E5E2                     _RDFATX:
00216C E5E2 C305DF          10      JP  RDFATX
00216F E5E5 C337E0          10  _RDFAT: JP  RDFAT
002172 E5E8 C322E3          10  _WTTRK: JP  WTTRK
002175 E5EB C324E3          10  _FDRD:  JP  FDRD
002178 E5EE C322E3          10  _FDWT:  JP  FDWT
       E5F1                     _BPB2DPB:
00217B E5F1 C3CDE0          10      JP  BPB2DPB
       E5F4                     _BREAK:
00217E E5F4 C390CB          10      JP  END_BATCH
       E5F7                     _GNCL:
002181 E5F7 C3B1DF          10      JP  GNCL        ; self-modifying code
       E5F8                     GNCPAT  EQU $-2
       E5FA                     _SNCL:
002184 E5FA C3D4DF          10      JP  SNCL        ; self-modifying code
       E5FB                     SNCPAT  EQU $-2
       E5FD                     _COMANL:
002187 E5FD C349CA          10      JP  COMANL
                                
       E600                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       E600                     STABLE:
                                ;0
00218A E600 03E512D143D16FD7        DW  _SYS00,_SYS01,_SYS02,_SYS03
002192 E608 71CE71CE49D109E5        DW  _SYS04,_SYS05,_SYS06,_SYS07
00219A E610 51D173CED5D169D2        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
0021A2 E618 88CE8DCE9CCEADCE        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
0021AA E620 01CF48CF91CFC2CF        DW  _SYS10,_SYS11,_SYS12,_SYS13
0021B2 E628 CACFE0CFF5CFEDCF        DW  _SYS14,_SYS15,_SYS16,_SYS17
0021BA E630 3CD041D046D04CD0        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
0021C2 E638 71CE72D071CE76D0        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
0021CA E640 71CE2CD034D07DD0        DW  _SYS20,_SYS21,_SYS22,_SYS23
0021D2 E648 A2D071CEC5DB93DC        DW  _SYS24,_ERROR,_SYS26,_SYS27
0021DA E650 34D0ACD07BD26FD7        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
0021E2 E658 CBD26FD771CECDD0        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
0021EA E660 C7D071CE71CE71CE        DW  _SYS30,_ERROR,_ERROR,_ERROR
0021F2 E668 71CE71CE71CE71CE        DW  _ERROR,_ERROR,_ERROR,_ERROR
0021FA E670 71CE6FD76FD7EED0        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
002202 E678 54CE                    DW  _DOS2
                                
002204 E67A                         DS  1
       E67B                     _MAX_SEC_SZ_H:
002205 E67B 02                      DB  MAX_SEC_SZ_H
                                
                                ;   FATバッファのアドレス
       E67C                     _FATBF:
002206 E67C 00E8                    DW  FATBF
                                
                                ;   データバッファのアドレス
       E67E                     _DTBUF:
002208 E67E 00EE                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       E680                     CTRLTB:
00220A E680 0000000016D30000        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
002212 E688 0000000000000000        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
00221A E690 0000000000000000        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
002222 E698 0000000000000000        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
00222A E6A0 0000000000000000        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
002232 E6A8 0000000000000000        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
00223A E6B0 0000000000000000        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
002242 E6B8 0000000000000000        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
                                ;   2D/2DDでBPBがない場合のデフォルト値(2D/360KB/9セクタ1024バイト)
00224A E6C0 0200                M2D:    DW  2
00224C E6C2 FD02                    DB  0FDH,2
00224E E6C4 6401                    DW  356
002250 E6C6 FF0728090182            DB  0FFH,7,40,9,1,082H
002256 E6CC 0500A7000800            DW  5,0A7H,8
                                
                                ;   2HDでBPBがない場合のデフォルト値(2HD/1.23MB/8セクタ1024バイト)
00225C E6D2 0200                M2HD:   DW  2
00225E E6D4 FE01                    DB  0FEH,1
002260 E6D6 C704                    DW  1223
002262 E6D8 FE064D080184            DB  0FEH,6,77,8,1,084H
002268 E6DE 0500A7000900            DW  5,0A7H,9
                                
                                ;   ディレクトリエントリとFCBの変換テーブル(日付+時刻+サイズ)
00226E E6E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
002270 E6E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
002272 E6E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
002274 E6EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       E6EE                     SDDATAE:
                                
002278 E6EE                         DS  2
                                
                                ;   バッチファイルのFCB
       E6F0                     _FCB_BAT:
00227A E6F0 A1E4                    DW  FCB_BAT
       E6F2                     _PATH:
00227C E6F2 40E4                    DW  PATHD
                                
00227E E6F4                     SCDIR:  DS  2       ;+14 +15
002280 E6F6                     SFBPS:  DS  2       ;FBPS
002282 E6F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
002284 E6FA 0000                _FATPS: DW  0
002286 E6FC 0000                _DIRPS: DW  0
002288 E6FE 0000                _CLPS:  DW  0
                                
       E700                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "MSXDPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MSX
                                
       E700                     _DEVICE:
                                
                                ;   A:
                                
00228A E700 0300                    DW  3   ;DPB_FATLN
00228C E702 EBE5                    DW  _FDRD   ;DPB_DRD
00228E E704 EEE5                    DW  _FDWT   ;DPB_DWT
002290 E706 F9                      DB  0F9H    ;DPB_FATID
002291 E707 03                      DB  3   ;DPB_SECPCL
002292 E708 CB02                    DW  715 ;DPB_MAXCL
002294 E70A 00                      DB  0   ;DPB_FDMODE
002295 E70B 07                      DB  7   ;DPB_DIRSCNT
002296 E70C 01                      DB  1   ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002297 E70D 00                      DB  0   ;DPB_MAXSEC
002298 E70E 01                      DB  1   ;DPB_FATPS
002299 E70F 82                      DB  082H    ;DPB_BPS
00229A E710 0700                    DW  7   ;DPB_DIRPS
00229C E712 2E                      DB  02EH    ;DPB_DEVICE
00229D E713 00                      DB  0   ;DPB_UNITNO
00229E E714 0A00                    DW  10  ;DPB_ADDCL
0022A0 E716 0000                    DW  0   ;DPB_16
0022A2 E718 0000                    DW  0   ;DPB_18
0022A4 E71A 0000                    DW  0   ;DPB_SDIR
0022A6 E71C 524F4D30                DB  "ROM0"  ;DPB_NAME
                                
                                ;   B:
                                
0022AA E720 0300                    DW  3   ;DPB_FATLN
0022AC E722 EBE5                    DW  _FDRD   ;DPB_DRD
0022AE E724 EEE5                    DW  _FDWT   ;DPB_DWT
0022B0 E726 F9                      DB  0F9H    ;DPB_FATID
0022B1 E727 03                      DB  3   ;DPB_SECPCL
0022B2 E728 CB02                    DW  715 ;DPB_MAXCL
0022B4 E72A 00                      DB  0   ;DPB_FDMODE
0022B5 E72B 07                      DB  7   ;DPB_DIRSCNT
0022B6 E72C 2E                      DB  46  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
0022B7 E72D 00                      DB  0   ;DPB_MAXSEC
0022B8 E72E 01                      DB  1   ;DPB_FATPS
0022B9 E72F 82                      DB  082H    ;DPB_BPS
0022BA E730 0700                    DW  7   ;DPB_DIRPS
0022BC E732 2E                      DB  02EH    ;DPB_DEVICE
0022BD E733 01                      DB  1   ;DPB_UNITNO
0022BE E734 0A00                    DW  10  ;DPB_ADDCL
0022C0 E736 0000                    DW  0   ;DPB_16
0022C2 E738 0000                    DW  0   ;DPB_18
0022C4 E73A 0000                    DW  0   ;DPB_SDIR
0022C6 E73C 524F4D31                DB  "ROM1"  ;DPB_NAME
                                
                                ;   C:
                                
0022CA E740                         DS  32
                                
                                ;   D:
                                
0022EA E760                         DS  32
                                
                                ;   E:
                                
00230A E780 0300                    DW  3   ;DPB_FATLN
00230C E782 E7E3                    DW  PDRD    ;DPB_DRD
00230E E784 B9E3                    DW  PDWT    ;DPB_DWT
002310 E786 F9                      DB  0F9H    ;DPB_FATID
002311 E787 03                      DB  3   ;DPB_SECPCL
002312 E788 CB02                    DW  715 ;DPB_MAXCL
002314 E78A FF                      DB  0FFH    ;DPB_FDMODE
002315 E78B 07                      DB  7   ;DPB_DIRSCNT
002316 E78C 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002317 E78D 09                      DB  9   ;DPB_MAXSEC
002318 E78E 01                      DB  1   ;DPB_FATPS
002319 E78F 82                      DB  082H    ;DPB_BPS
00231A E790 0700                    DW  7   ;DPB_DIRPS
00231C E792 2D                      DB  02DH    ;DPB_DEVICE
00231D E793 00                      DB  0   ;DPB_UNITNO
00231E E794 0A00                    DW  10  ;DPB_ADDCL
002320 E796 0000                    DW  0   ;DPB_16
002322 E798 0000                    DW  0   ;DPB_18
002324 E79A 0000                    DW  0   ;DPB_SDIR
002326 E79C 44534B30                DB  "DSK0"  ;DPB_NAME
                                
                                ;   F:
                                
00232A E7A0 0300                    DW  3   ;DPB_FATLN
00232C E7A2 E7E3                    DW  PDRD    ;DPB_DRD
00232E E7A4 B9E3                    DW  PDWT    ;DPB_DWT
002330 E7A6 F9                      DB  0F9H    ;DPB_FATID
002331 E7A7 03                      DB  3   ;DPB_SECPCL
002332 E7A8 CB02                    DW  715 ;DPB_MAXCL
002334 E7AA FF                      DB  0FFH    ;DPB_FDMODE
002335 E7AB 07                      DB  7   ;DPB_DIRSCNT
002336 E7AC 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002337 E7AD 09                      DB  9   ;DPB_MAXSEC
002338 E7AE 01                      DB  1   ;DPB_FATPS
002339 E7AF 82                      DB  082H    ;DPB_BPS
00233A E7B0 0700                    DW  7   ;DPB_DIRPS
00233C E7B2 2D                      DB  02DH    ;DPB_DEVICE
00233D E7B3 01                      DB  1   ;DPB_UNITNO
00233E E7B4 0A00                    DW  10  ;DPB_ADDCL
002340 E7B6 0000                    DW  0   ;DPB_16
002342 E7B8 0000                    DW  0   ;DPB_18
002344 E7BA 0000                    DW  0   ;DPB_SDIR
002346 E7BC 44534B31                DB  "DSK1"  ;DPB_NAME
                                
                                ;   G:
                                
00234A E7C0 0300                    DW  3   ;DPB_FATLN
00234C E7C2 E7E3                    DW  PDRD    ;DPB_DRD
00234E E7C4 B9E3                    DW  PDWT    ;DPB_DWT
002350 E7C6 F9                      DB  0F9H    ;DPB_FATID
002351 E7C7 03                      DB  3   ;DPB_SECPCL
002352 E7C8 CB02                    DW  715 ;DPB_MAXCL
002354 E7CA FF                      DB  0FFH    ;DPB_FDMODE
002355 E7CB 07                      DB  7   ;DPB_DIRSCNT
002356 E7CC 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002357 E7CD 09                      DB  9   ;DPB_MAXSEC
002358 E7CE 01                      DB  1   ;DPB_FATPS
002359 E7CF 82                      DB  082H    ;DPB_BPS
00235A E7D0 0700                    DW  7   ;DPB_DIRPS
00235C E7D2 2D                      DB  02DH    ;DPB_DEVICE
00235D E7D3 02                      DB  2   ;DPB_UNITNO
00235E E7D4 0A00                    DW  10  ;DPB_ADDCL
002360 E7D6 0000                    DW  0   ;DPB_16
002362 E7D8 0000                    DW  0   ;DPB_18
002364 E7DA 0000                    DW  0   ;DPB_SDIR
002366 E7DC 44534B32                DB  "DSK2"  ;DPB_NAME
                                
                                ;   H:
00236A E7E0 0300                    DW  3   ;DPB_FATLN
00236C E7E2 E7E3                    DW  PDRD    ;DPB_DRD
00236E E7E4 B9E3                    DW  PDWT    ;DPB_DWT
002370 E7E6 F9                      DB  0F9H    ;DPB_FATID
002371 E7E7 03                      DB  3   ;DPB_SECPCL
002372 E7E8 CB02                    DW  715 ;DPB_MAXCL
002374 E7EA FF                      DB  0FFH    ;DPB_FDMODE
002375 E7EB 07                      DB  7   ;DPB_DIRSCNT
002376 E7EC 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002377 E7ED 09                      DB  9   ;DPB_MAXSEC
002378 E7EE 01                      DB  1   ;DPB_FATPS
002379 E7EF 82                      DB  082H    ;DPB_BPS
00237A E7F0 0700                    DW  7   ;DPB_DIRPS
00237C E7F2 2D                      DB  02DH    ;DPB_DEVICE
00237D E7F3 07                      DB  7   ;DPB_UNITNO
00237E E7F4 0A00                    DW  10  ;DPB_ADDCL
002380 E7F6 0000                    DW  0   ;DPB_16
002382 E7F8 0000                    DW  0   ;DPB_18
002384 E7FA 0000                    DW  0   ;DPB_SDIR
002386 E7FC 44534B37                DB  "DSK7"  ;DPB_NAME
       E800                     MSX_E:
[EOF:MSXDPB.ASM:UTF_8]
                                
00238A E800                         DS  03FFFH - $$
003FFF 0475 00                      DB  0
       0476                     LAST_ADR:
                                
                                    END
[EOF:MSX.ASM:UTF_8]
