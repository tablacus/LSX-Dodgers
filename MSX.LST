                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for MSX
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "MSXDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MSX
                                
       0003                     MAC EQU 3   ;MSX
       0001                     DEV EQU 1
                                
       001D                     VER_6F  EQU 0001DH
                                
       4000                     RUN EQU 04000H
                                
       C800                     START2  EQU 0C800H
       CB06                     BDOS    EQU 0CB06H
       E600                     WORKAD  EQU 0E600H
       E900                     FATBF   EQU 0E900H
       EF00                     DTBUF   EQU 0EF00H
       0028                     WIDTH   EQU 40
       0018                     LINE    EQU 24
       0000                     COLORF  EQU 0
       0000                     KEYSP_H EQU 0
       0000                     KEYSP_L EQU 0
       0008                     COMS    EQU 8
       0002                     MAX_SEC_SZ_H    EQU 2       ;1セクタ1024バイトのサポート(2:off 4:on)
       8000                     BUFFER  EQU 08000H
       0100                     BUF_COM EQU 00100H
                                
       000C                     _RDSLT  EQU 0000CH
       0014                     _WRSLT  EQU 00014H
       001C                     _CALSLT EQU 0001CH
       0024                     _ENASLT EQU 00024H
       0030                     _CALLF  EQU 00030H
                                
       004A                     RDVRM   EQU 0004AH
       004D                     WRTVRM  EQU 0004DH
       006C                     INITXT  EQU 0006CH
       0078                     SETTXT  EQU 00078H
       009C                     CHSNS   EQU 0009CH
       009F                     CHGET   EQU 0009FH
       00A2                     CHPUT   EQU 000A2H
       00AE                     PINLIN  EQU 000AEH
       00B1                     INLIN   EQU 000B1H
       00B4                     QINLIN  EQU 000B4H
       00B7                     BREAKX  EQU 000B7H
       00C0                     BEEP    EQU 000C0H
       00C6                     POSIT   EQU 000C6H
       0138                     RSLREG  EQU 00138H
       0144                     PHYDIO  EQU 00144H  ;MAIN:BIOS:
       0156                     KILBUF  EQU 00156H
                                
       01F5                     REDCLK  EQU 001F5H  ;SUB
       01F9                     WRTCLK  EQU 001F9H  ;SUB
                                
       F341                     RAMAD0  EQU 0F341H
       F342                     RAMAD1  EQU 0F342H
       F343                     RAMAD2  EQU 0F343H
       F344                     RAMAD3  EQU 0F344H
                                
       FEDA                     H_STKE  EQU 0FEDAH
       FFA7                     H_PHYD  EQU 0FFA7H
                                
                                            ;ASCII-8K
       6000                     BANK0_SEL EQU 06000H
       6800                     BANK1_SEL EQU 06800H
       7000                     BANK2_SEL EQU 07000H
       7800                     BANK3_SEL EQU 07800H
                                            ;ASCII-16K
                                ;BANK0_SEL EQU 06000H
                                ;BANK1_SEL EQU 07000H
                                            ;KONAMI-8K
       8000                     KONAMI_BANK2_SEL EQU 08000H
       A000                     KONAMI_BANK3_SEL EQU 0A000H
[EOF:MSXDEF.ASM:UTF_8]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0001                     VER_3   EQU 1
       1D03                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0103                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0161                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
000000 4000                         ORG RUN
                                
                                ; MSX ROM header
000000 4000 4142                    DB  "AB"   ; ID for auto-executable ROM
000002 4002 1942                    DW  INIT_ROM   ; Main program execution address.
000004 4004 0000                    DW  0      ; STATEMENT
000006 4006 0000                    DW  0      ; DEVICE
000008 4008 0000                    DW  0      ; TEXT
00000A 400A 000000000000            DW  0,0,0  ; Reserved
                                
                                    INCLUDE "MSXFDIPL.ASM"
                                ;   LSX-Dodgers FDIPL
                                ;   MSX
000010 4010 186E            12      JR  INIT_FDD_BOOT
00007F 407F                         ORG 0407FH
00007F 407F C9              10      RET
       4080                     INIT_FDD_BOOT:
000080 4080 F3               4      DI
000081 4081 ED56             8      IM  1
000083 4083 3A42F3          13      LD  A,(RAMAD1)
000086 4086 2640             7      LD  H,040H
000088 4088 CD2400          17      CALL    _ENASLT
00008B 408B 218A82          10      LD  HL,AT_START2+04000H
00008E 408E 1100C8          10      LD  DE,START2
000091 4091 010021          10      LD  BC,MSX_E-START2
000094 4094 EDB0                    LDIR
000096 4096 2180E8          10      LD  HL,_DEVICE+4*32     ;E
000099 4099 1100E8          10      LD  DE,_DEVICE      ;A
00009C 409C 018000          10      LD  BC,32*4
00009F 409F EDB0                    LDIR
0000A1 40A1 21DFE8          10      LD  HL,_DEVICE+6*32+DPB_NAME+3
0000A4 40A4 3E07             7      LD  A,7
       40A6                     FDD_INIT1:
0000A6 40A6 C62F             7      ADD A,'0'-1
0000A8 40A8 77               7      LD  (HL),A
0000A9 40A9 11F4FF          10      LD  DE,DPB_UNITNO-(DPB_NAME+3)
0000AC 40AC 19              11      ADD HL,DE
0000AD 40AD D630             7      SUB '0'
0000AF 40AF 77               7      LD  (HL),A
0000B0 40B0 11ECFF          10      LD  DE,-DPB_UNITNO-1
0000B3 40B3 19              11      ADD HL,DE       ;ここでZフラグは変化しない
0000B4 40B4 20F0            12      JR  NZ,FDD_INIT1
0000B6 40B6 218040          10      LD  HL,INIT_FDD_BOOT
                                
0000B9 40B9 CD09C9          17      CALL    SET_BDOS
0000BC 40BC 21E9C8          10      LD  HL,ROMCHECKED
0000BF 40BF 2204C8          16      LD  (INIT_SWC),HL
0000C2 40C2 3EC3             7      LD  A,0C3H      ;JP
0000C4 40C4 329BCB          13      LD  (FDD_BDOS_JP),A
0000C7 40C7 21D7CF          10      LD  HL,BDOS0
0000CA 40CA 229CCB          16      LD  (FDD_BDOS_ADR),HL
0000CD 40CD 219BCB          10      LD  HL,FDD_BDOS_JP
0000D0 40D0 220600          16      LD  (00006H),HL ;BDOS
0000D3 40D3 C300C8          10      JP  START2
[EOF:MSXFDIPL.ASM:UTF_8]
                                
0001BD 41BD                         ORG 041BDH
0001BD 41BD C9              10      RET
                                
                                    ;MBR_Partition1 (2DDのデータ)
0001BE 41BE 00                      DB  0       ;ブートフラグ
0001BF 41BF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001C2 41C2 01                      DB  1       ;識別子(FAT12)
0001C3 41C3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001C6 41C6 20000000                DW  32,0        ;パーティションの最初のセクタ番号(LBA方式)
0001CA 41CA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
                                    ;MBR_Partition2 (2DDのデータ)
0001CE 41CE 00                      DB  0       ;ブートフラグ
0001CF 41CF 000000                  DB  0,0,0       ;パーティションの最初のセクタ番号(CHS方式)
0001D2 41D2 01                      DB  1       ;識別子(FAT12)
0001D3 41D3 000000                  DB  0,0,0       ;パーティションの最後のセクタ番号(CHS方式)
0001D6 41D6 C0050000                DW  32+1440,0   ;パーティションの最初のセクタ番号(LBA方式)
0001DA 41DA A0050000                DW  1440,0      ;パーティション内のセクタ数(LBA方式)
                                
0001FE 41FE                         ORG 041FEH
0001FE 41FE 55AA                    DB  055H,0AAH   ;MBR_Sig
                                
                                    INCLUDE "MSXINIT.ASM"
                                ;   LSX-Dodgers INIT
                                ;   MSX
       4200                     START:
000200 4200 F3               4      DI
000201 4201 ED56             8      IM  1
000203 4203 AF               4      XOR A               ;A=0
000204 4204 320060          13      LD  (BANK0_SEL),A           ;似非RAM対策でバンク0を設定
000207 4207 3C               4      INC A               ;A=1
000208 4208 320068          13      LD  (BANK1_SEL),A
00020B 420B 218A42          10      LD  HL,AT_START2
00020E 420E 1100C8          10      LD  DE,START2
000211 4211 010021          10      LD  BC,MSX_E-START2
000214 4214 EDB0                    LDIR
000216 4216 C300C8          10      JP  START2
                                
       4219                     INIT_ROM:
000219 4219 3E                      DB  03EH    ;LD A,??
00021A 421A F7              12      RST 30H
00021B 421B F3               4      DI
00021C 421C 32DAFE          13      LD  (H_STKE),A
00021F 421F CD6642          17      CALL    GTSL1_
000222 4222 21DBFE          10      LD  HL,H_STKE+1
000225 4225 77               7      LD  (HL),A
000226 4226 110042          10      LD  DE,START
000229 4229 23               6      INC HL
00022A 422A 73               7      LD  (HL),E
00022B 422B 23               6      INC HL
00022C 422C 72               7      LD  (HL),D
                                
00022D 422D CD3801          17      CALL    RSLREG      ;read primary slot #
000230 4230 07               4      RLCA
000231 4231 07               4      RLCA
000232 4232 F5              11      PUSH    AF
000233 4233 1605             7      LD  D,4+1
000235 4235 CD6D42          17      CALL    GTSL2_
000238 4238 3244F3          13      LD  (RAMAD3),A
00023B 423B 3A42F3          13      LD  A,(RAMAD1)
00023E 423E CD5842          17      CALL    FIXRAMAD
000241 4241 3242F3          13      LD  (RAMAD1),A
000244 4244 3A41F3          13      LD  A,(RAMAD0)
000247 4247 CD5842          17      CALL    FIXRAMAD
00024A 424A 3241F3          13      LD  (RAMAD0),A
00024D 424D F1              10      POP AF
00024E 424E 1603             7      LD  D,2+1
000250 4250 CD6D42          17      CALL    GTSL2_
000253 4253 3243F3          13      LD  (RAMAD2),A
                                
000256 4256 FB               4      EI
000257 4257 C9              10      RET
                                
       4258                     FIXRAMAD:
000258 4258 B7               4      OR  A
000259 4259 2807            12      JR  Z,FIXRAMAD1
00025B 425B FEC9             7      CP  0C9H
00025D 425D 2803            12      JR  Z,FIXRAMAD1
00025F 425F FEFF             7      CP  0FFH
000261 4261 C0              11      RET NZ
       4262                     FIXRAMAD1:
000262 4262 3A44F3          13      LD  A,(RAMAD3)
000265 4265 C9              10      RET
                                
       4266                     GTSL1_:             ;自分のいるスロットを知る
000266 4266 CD3801          17      CALL    RSLREG      ;read primary slot #
000269 4269 0F               4      RRCA
00026A 426A 0F               4      RRCA
00026B 426B 1601             7      LD  D,1
       426D                     GTSL2_:
00026D 426D E603             7      AND 3       ;[A]=000000PP
00026F 426F 5F               4      LD  E,A     ;[E]=000000PP
000270 4270 21C1FC          10      LD  HL,EXPTBL
000273 4273 85               4      ADD A,L     ;桁上りは無い
000274 4274 6F               4      LD  L,A     ;[HL]=EXPTBL+000000PP
000275 4275 7B               4      LD  A,E     ;[A]=000000PP
000276 4276 CB7E            13      BIT 7,(HL)
000278 4278 C8              11      RET Z
000279 4279 7D               4      LD  A,L     ;point to SLTTBL entry
00027A 427A C604             7      ADD A,4     ;桁上りは無い
00027C 427C 6F               4      LD  L,A
00027D 427D 7E               7      LD  A,(HL)      ;get currently expansion slot register
       427E                     GTSL3_:
00027E 427E 15               4      DEC D
00027F 427F 2803            12      JR  Z,GTSL4_:
000281 4281 0F               4      RRCA
000282 4282 18FA            12      JR  GTSL3_:
       4284                     GTSL4_:
000284 4284 E60C             7      AND 00CH        ;[A] = 0000SS00
000286 4286 B3               4      OR  E       ;[A] = 0000SSPP
000287 4287 F680             7      OR  080H        ;[A] = 1000SSPP
000289 4289 C9              10      RET
                                
       428A                     AT_START2:
00028A C800                         ORG START2,AT_START2-RUN
                                
00028A C800 3100C8          10      LD  SP,START2
00028D C803 CD11C8          17      CALL    INIT        ;NZならAUTOEXECを実行
       C804                     INIT_SWC    EQU $-2
000290 C806 210000          10      LD  HL,0
000293 C809 E5              11      PUSH    HL
000294 C80A C8              11      RET Z
000295 C80B 11FEC9          10      LD  DE,AUTOD
000298 C80E C3FDE6          10      JP  _COMANL
                                
       C811                     INIT:
00029B C811 DD21900D        14      LD  IX,0D90H
00029F C815 0600             7      LD  B,0
       C817                     CHECK_CBIOS1:
0002A1 C817 DD7E00          19      LD  A,(IX+0)
0002A4 C81A FE43             7      CP  'C'
0002A6 C81C 202B            12      JR  NZ,CHECK_CBIOS2
0002A8 C81E DD7E01          19      LD  A,(IX+1)
0002AB C821 FE2D             7      CP  '-'
0002AD C823 2024            12      JR  NZ,CHECK_CBIOS2
0002AF C825 DD7E02          19      LD  A,(IX+2)
0002B2 C828 FE42             7      CP  'B'
0002B4 C82A 201D            12      JR  NZ,CHECK_CBIOS2
0002B6 C82C DD7E03          19      LD  A,(IX+3)
0002B9 C82F FE49             7      CP  'I'
0002BB C831 2016            12      JR  NZ,CHECK_CBIOS2
0002BD C833 DD7E04          19      LD  A,(IX+4)
0002C0 C836 FE4F             7      CP  'O'
0002C2 C838 200F            12      JR  NZ,CHECK_CBIOS2
0002C4 C83A DD7E05          19      LD  A,(IX+5)
0002C7 C83D EE53             7      XOR 'S'
0002C9 C83F 2008            12      JR  NZ,CHECK_CBIOS2
                                
0002CB C841 3228D3          13      LD  (CBIOS_SWC1),A
0002CE C844 324CD3          13      LD  (CBIOS_SWC2),A
                                
0002D1 C847 1804            12      JR  CHECK_CBIOS3
       C849                     CHECK_CBIOS2:
0002D3 C849 DD23            10      INC IX
0002D5 C84B 10CA            13      DJNZ    CHECK_CBIOS1
       C84D                     CHECK_CBIOS3:
0002D7 C84D 3ADBFE          13      LD  A,(H_STKE+1)
0002DA C850 3262E6          13      LD  (ROM_SLT),A
                                
       C853                     RAMCHK2:
0002DD C853 3A42F3          13      LD  A,(RAMAD1)
0002E0 C856 2640             7      LD  H,040H
0002E2 C858 CD62C9          17      CALL    CHK_RAM
0002E5 C85B 3242F3          13      LD  (RAMAD1),A
       C85E                     RAMCHK1:
0002E8 C85E 3A41F3          13      LD  A,(RAMAD0)
0002EB C861 2600             7      LD  H,00H
0002ED C863 CD62C9          17      CALL    CHK_RAM
0002F0 C866 3241F3          13      LD  (RAMAD0),A
       C869                     RAMCHK0:
0002F3 C869 3A42F3          13      LD  A,(RAMAD1)
0002F6 C86C 2640             7      LD  H,040H
0002F8 C86E CD77D6          17      CALL    ENASLT
                                
0002FB C871 3A41F3          13      LD  A,(RAMAD0)
0002FE C874 2600             7      LD  H,000H
000300 C876 CD77D6          17      CALL    ENASLT
                                
000303 C879 210000          10      LD  HL,0
000306 C87C 065C             7      LD  B,05CH
000308 C87E 3E                      DB  03EH    ;LD A,??
000309 C87F EF              12      RST 28H
00030A C880 CD10D8          17      CALL    FILL_MEMORY
00030D C883 06A4             7      LD  B,0A4H
00030F C885 AF               4      XOR A
000310 C886 320400          13      LD  (_DVSW),A
000313 C889 CD10D8          17      CALL    FILL_MEMORY
                                
000316 C88C CD09C9          17      CALL    SET_BDOS
                                
                                                ;LSX-Dodgers
000319 C88F 3EE6             7      LD  A,CPM_BOOT/256
00031B C891 320B00          13      LD  (0000BH),A
                                
                                                ;MSXワークエリア
00031E C894 3E03             7      LD  A,3
000320 C896 329BFC          13      LD  (INTFLG),A
                                
                                                ;ROMタイプ判別(ASCII-8K/ASCII-16K)
000323 C899 1E00             7      LD  E,0
000325 C89B 3A62E6          13      LD  A,(ROM_SLT)
000328 C89E 210068          10      LD  HL,BANK1_SEL
00032B C8A1 CD04D6          17      CALL    WRSLT
                                
00032E C8A4 210060          10      LD  HL,06000H
000331 C8A7 3A62E6          13      LD  A,(ROM_SLT)
000334 C8AA CDC3D5          17      CALL    RDSLT
000337 C8AD FE41             7      CP  'A'
000339 C8AF 280F            12      JR  Z,ROM8K
                                                ;ASCII-8K/Konami-8Kではない(ASCII-16K)
00033B C8B1 3E                      DB  03EH    ;LD A,??
00033C C8B2 00               4      NOP
00033D C8B3 322CCB          13      LD  (ASCII16K1),A
000340 C8B6 3230CB          13      LD  (ASCII16K2),A
000343 C8B9 3E3F             7      LD  A,03FH
000345 C8BB 3248CB          13      LD  (ASCII16K3),A
000348 C8BE 1829            12      JR  ROMCHECKED
       C8C0                     ROM8K:              ;Konami-8Kチェック
00034A C8C0 1E01             7      LD  E,1
00034C C8C2 3A62E6          13      LD  A,(ROM_SLT)
00034F C8C5 210070          10      LD  HL,BANK2_SEL
000352 C8C8 CD04D6          17      CALL    WRSLT
                                
000355 C8CB 1E00             7      LD  E,0
000357 C8CD 3A62E6          13      LD  A,(ROM_SLT)
00035A C8D0 210080          10      LD  HL,KONAMI_BANK2_SEL
00035D C8D3 CD04D6          17      CALL    WRSLT
                                
000360 C8D6 210080          10      LD  HL,08000H
000363 C8D9 3A62E6          13      LD  A,(ROM_SLT)
000366 C8DC CDC3D5          17      CALL    RDSLT
000369 C8DF FE41             7      CP  'A'
00036B C8E1 2006            12      JR  NZ,ROMCHECKED
                                                ;Konami-8K
00036D C8E3 210080          10      LD  HL,KONAMI_BANK2_SEL
000370 C8E6 2237CB          16      LD  (ROM8000H),HL
       C8E9                     ROMCHECKED:
                                
000373 C8E9 3E28             7      LD  A,40
000375 C8EB 32AEF3          13      LD  (LINL40),A
000378 C8EE 32B1E6          13      LD  (_WIDTH),A
00037B C8F1 DD216C00        14      LD  IX,INITXT
00037F C8F5 CD1DD5          17      CALL    CALSLT_R
000382 C8F8 DD217800        14      LD  IX,SETTXT
000386 C8FC CD1DD5          17      CALL    CALSLT_R
                                
000389 C8FF 210ACA          10      LD  HL,INIMES
00038C C902 CD17D0          17      CALL    MSX
       C905                     INIT1:
00038F C905 AF               4      XOR A
000390 C906 FE03             7      CP  3
000392 C908 C9              10      RET
       C909                     SET_BDOS:
000393 C909 3E                      DB  03EH    ;LD A,??
000394 C90A E9               4      JP  (HL)
000395 C90B 320F00          13      LD  (0000FH),A
                                
000398 C90E 3EC3             7      LD  A,0C3H      ;JP
00039A C910 2103E6          10      LD  HL,CPM_WBOOT
00039D C913 320000          13      LD  (00000H),A
0003A0 C916 220100          16      LD  (00001H),HL ;IPL
                                
0003A3 C919 2106CB          10      LD  HL,BDOS
0003A6 C91C 320500          13      LD  (00005H),A
0003A9 C91F 220600          16      LD  (00006H),HL ;BDOS
                                
0003AC C922 210000          10      LD  HL,0
0003AF C925 322800          13      LD  (00028H),A
0003B2 C928 222900          16      LD  (00029H),HL ;BDOS
                                                ;インタースロットコール
0003B5 C92B 2177D5          10      LD  HL,RDSLTR
0003B8 C92E 320C00          13      LD  (_RDSLT),A
0003BB C931 220D00          16      LD  (_RDSLT+1),HL
                                
0003BE C934 2180D5          10      LD  HL,WRSLTR
0003C1 C937 321400          13      LD  (_WRSLT),A
0003C4 C93A 221500          16      LD  (_WRSLT+1),HL
                                
0003C7 C93D 2139D5          10      LD  HL,CALSLTR
0003CA C940 321C00          13      LD  (_CALSLT),A
0003CD C943 221D00          16      LD  (_CALSLT+1),HL
                                
0003D0 C946 2177D6          10      LD  HL,ENASLT
0003D3 C949 322400          13      LD  (_ENASLT),A
0003D6 C94C 222500          16      LD  (_ENASLT+1),HL
                                
0003D9 C94F 2129D5          10      LD  HL,CALLF
0003DC C952 323000          13      LD  (_CALLF),A
0003DF C955 223100          16      LD  (_CALLF+1),HL
                                
0003E2 C958 2189D5          10      LD  HL,INT38H
0003E5 C95B 323800          13      LD  (00038H),A
0003E8 C95E 223900          16      LD  (00038H+1),HL
0003EB C961 C9              10      RET
       C962                     CHK_RAM:
0003EC C962 E5              11      PUSH    HL
0003ED C963 CDB7C9          17      CALL    CHK_RAM0
0003F0 C966 E1              10      POP HL
0003F1 C967 C8              11      RET Z
0003F2 C968 3AC1FC          13      LD  A,(EXPTBL)      ;スロット#0
0003F5 C96B E680             7      AND 080H
0003F7 C96D CD8EC9          17      CALL    CHK_RAM_SLT
0003FA C970 C8              11      RET Z
0003FB C971 3AC2FC          13      LD  A,(EXPTBL+1)        ;スロット#1
0003FE C974 E680             7      AND 080H
000400 C976 C601             7      ADD A,1
000402 C978 CD8EC9          17      CALL    CHK_RAM_SLT
000405 C97B C8              11      RET Z
000406 C97C 3AC3FC          13      LD  A,(EXPTBL+2)        ;スロット#2
000409 C97F E680             7      AND 080H
00040B C981 C602             7      ADD A,2
00040D C983 CD8EC9          17      CALL    CHK_RAM_SLT
000410 C986 C8              11      RET Z
000411 C987 3AC4FC          13      LD  A,(EXPTBL+3)        ;スロット#3
000414 C98A E680             7      AND 080H
000416 C98C C603             7      ADD A,3
       C98E                     CHK_RAM_SLT:
000418 C98E E5              11      PUSH    HL
000419 C98F CDB7C9          17      CALL    CHK_RAM0        ;スロット#X or X-0
00041C C992 E1              10      POP HL
00041D C993 C8              11      RET Z
00041E C994 CB79             8      BIT 7,C
000420 C996 281A            12      JR  Z,CHK_RAM_E     ;スロットは拡張されていない
000422 C998 79               4      LD  A,C
000423 C999 C604             7      ADD A,4*1           ;スロット#X-1
000425 C99B E5              11      PUSH    HL
000426 C99C CDB7C9          17      CALL    CHK_RAM0
000429 C99F E1              10      POP HL
00042A C9A0 C8              11      RET Z
00042B C9A1 79               4      LD  A,C
00042C C9A2 C608             7      ADD A,4*2           ;スロット#X-2
00042E C9A4 E5              11      PUSH    HL
00042F C9A5 CDB7C9          17      CALL    CHK_RAM0
000432 C9A8 E1              10      POP HL
000433 C9A9 C8              11      RET Z
000434 C9AA 79               4      LD  A,C
000435 C9AB C60C             7      ADD A,4*3           ;スロット#X-3
000437 C9AD E5              11      PUSH    HL
000438 C9AE CDB7C9          17      CALL    CHK_RAM0
00043B C9B1 E1              10      POP HL
       C9B2                     CHK_RAM_E:
00043C C9B2 AF               4      XOR A
00043D C9B3 3C               4      INC A           ;ZF=0にする
00043E C9B4 3E00             7      LD  A,0
000440 C9B6 C9              10      RET
                                
       C9B7                     CHK_RAM0:
000441 C9B7 4F               4      LD  C,A
000442 C9B8 3A62E6          13      LD  A,(ROM_SLT)
000445 C9BB B9               4      CP  C
000446 C9BC 28F4            12      JR  Z,CHK_RAM_E
000448 C9BE 2E00             7      LD  L,0
       C9C0                     CHK_RAM1:
00044A C9C0 79               4      LD  A,C
00044B C9C1 DD210C00        14      LD  IX,_RDSLT
00044F C9C5 CDF2C9          17      CALL    CALSLT_RAM
000452 C9C8 C6E5             7      ADD A,0E5H
000454 C9CA 47               4      LD  B,A
000455 C9CB 5F               4      LD  E,A
000456 C9CC 79               4      LD  A,C
000457 C9CD DD211400        14      LD  IX,_WRSLT
00045B C9D1 CDF2C9          17      CALL    CALSLT_RAM
00045E C9D4 79               4      LD  A,C
00045F C9D5 DD210C00        14      LD  IX,_RDSLT
000463 C9D9 CDF2C9          17      CALL    CALSLT_RAM
000466 C9DC B8               4      CP  B
000467 C9DD C0              11      RET NZ
000468 C9DE D6E5             7      SUB 0E5H
00046A C9E0 79               4      LD  A,C
00046B C9E1 5F               4      LD  E,A
00046C C9E2 DD211400        14      LD  IX,_WRSLT
000470 C9E6 CDF2C9          17      CALL    CALSLT_RAM
000473 C9E9 24               4      INC H
000474 C9EA 7D               4      LD  A,L
000475 C9EB C604             7      ADD A,4
000477 C9ED 6F               4      LD  L,A
000478 C9EE 20D0            12      JR  NZ,CHK_RAM1
00047A C9F0 79               4      LD  A,C     ;ZF=1のハズ
00047B C9F1 C9              10      RET
                                
       C9F2                     CALSLT_RAM:
00047C C9F2 C5              11      PUSH    BC
00047D C9F3 E5              11      PUSH    HL
00047E C9F4 FD2AC0FC        20      LD  IY,(EXPTBL-1) ;メインROMスロット
000482 C9F8 CD1C00          17      CALL    _CALSLT
000485 C9FB E1              10      POP HL
000486 C9FC C1              10      POP BC
000487 C9FD C9              10      RET
                                
000488 C9FE 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000491 CA07 413A00              AUTODV: DB  "A:",0
                                
000494 CA0A 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MSX v"
            6765727320666F72    
            204D53582076        
0004AA CA20 312E                    DB  030H + VER_1, '.'
0004AC CA22 3631                    DB  030H + VER_2 ,030H + VER_3
0004AE CA24 6A                      DB  'j'
0004AF CA25 2047616B750D0A          DB  " Gaku",0DH,0AH
0004B6 CA2C 00                      DB  0
                                
0004B7 CA2D 0300                M2DD:   DW  3
0004B9 CA2F F902                    DB  0F9H,2
0004BB CA31 CB02                    DW  715
0004BD CA33 FF0750090182            DB  0FFH,7,80,9,1,082H
0004C3 CA39 0700A7000A00            DW  7,0A7H,10
       CA3F                     M2DDE:
                                
       CA3F                     INITE:
0004C9 CA3F                         DS  BDOS-INITE
000590 CB06 C3D7CF          10      JP  BDOS0
[EOF:MSXINIT.ASM:SHIFT_JIS]
                                    INCLUDE "MSXDISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MSX
                                
                                ;   ROM DISK DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       CB09                     FDRD:
000593 CB09 ED739ACB        20      LD  (DRDSP),SP
000597 CB0D 3A9BCB          13      LD  A,(DRDSPH)  ;スタックがカートリッジと被っていないかチェック
00059A CB10 FE7F             7      CP  07FH
00059C CB12 3807            12      JR  C,FDRD1
00059E CB14 FEC1             7      CP  0C1H
0005A0 CB16 3003            12      JR  NC,FDRD1
0005A2 CB18 315EF5          10      LD  SP,BUF
       CB1B                     FDRD1:
0005A5 CB1B C5              11      PUSH    BC
0005A6 CB1C D5              11      PUSH    DE
                                
0005A7 CB1D E5              11      PUSH    HL
0005A8 CB1E EB               4      EX  DE,HL
0005A9 CB1F DD460F          19      LD  B,(IX+DPB_BPS)
       CB22                     EADR1:
0005AC CB22 CB18             8      RR  B
0005AE CB24 3803            12      JR  C,EADR2
0005B0 CB26 29              11      ADD HL,HL
0005B1 CB27 18F9            12      JR  EADR1
       CB29                     EADR2:
0005B3 CB29 E5              11      PUSH    HL  ;あとでDEで受け取る
0005B4 CB2A 29              11      ADD HL,HL   ;64KB→32KB
0005B5 CB2B 29              11      ADD HL,HL   ;32KB→16KB
       CB2C                     ASCII16K1:
0005B6 CB2C 29              11      ADD HL,HL   ;16KB→8KB  ;ASCII-16Kの場合はここがNOPに置き換えられる
                                
0005B7 CB2D DD7E0C          19      LD  A,(IX+DPB_MAXCYL)   ;16KB単位でカートリッジ内のディスクが存在する位置を指定
       CB30                     ASCII16K2:
0005BA CB30 87               4      ADD A,A         ;ASCII-16Kの場合はここがNOPに置き換えられる
0005BB CB31 84               4      ADD A,H
0005BC CB32 5F               4      LD  E,A
0005BD CB33 3A62E6          13      LD  A,(ROM_SLT)
0005C0 CB36 210070          10      LD  HL,BANK2_SEL
       CB37                     ROM8000H    EQU $-2
0005C3 CB39 CD04D6          17      CALL    WRSLT
                                
0005C6 CB3C 2680             7      LD  H,080H
0005C8 CB3E 3A62E6          13      LD  A,(ROM_SLT) ;カートリッジROMに切り替える
0005CB CB41 CD77D6          17      CALL    ENASLT
                                
0005CE CB44 D1              10      POP DE
0005CF CB45 E1              10      POP HL      ;HLは読み出し先のメモリアドレス
                                
0005D0 CB46 7B               4      LD  A,E
0005D1 CB47 E61F             7      AND 01FH        ;セグメントのサイズでフィルタする(8K:1F/16K:3F)
       CB48                     ASCII16K3   EQU $-1
0005D3 CB49 1E00             7      LD  E,0     ;DEはROMディスクから読み出すアドレス
0005D5 CB4B C680             7      ADD A,080H
0005D7 CB4D 57               4      LD  D,A
                                
0005D8 CB4E 3E                      DB  03EH
0005D9 CB4F A7               4      AND A
0005DA CB50 327DCB          13      LD  (DRD_SWC3),A
0005DD CB53 7C               4      LD  A,H     ;読み出し先がカートリッジと被っていないかチェック
0005DE CB54 FE7B             7      CP  07BH
0005E0 CB56 3812            12      JR  C,DRD2
0005E2 CB58 FEC1             7      CP  0C1H
0005E4 CB5A 300E            12      JR  NC,DRD2
0005E6 CB5C 2284CB          16      LD  (DRD_SWC1),HL   ;被っている場合はデータバッファをフラッシュして一時的に使う
0005E9 CB5F 2A7EE7          16      LD  HL,(_DTBUF)
0005EC CB62 3E                      DB  03EH
0005ED CB63 37               4      SCF
0005EE CB64 327DCB          13      LD  (DRD_SWC3),A
0005F1 CB67 CDA9E4          17      CALL    FFLUSHBUF
       CB6A                     DRD2:
0005F4 CB6A DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
0005F7 CB6D E607             7      AND 7
0005F9 CB6F 47               4      LD  B,A
0005FA CB70 4B               4      LD  C,E ;E=0
                                
0005FB CB71 EB               4      EX  DE,HL
0005FC CB72 EDB0                    LDIR
0005FE CB74 D5              11      PUSH    DE
0005FF CB75 2680             7      LD  H,080H
000601 CB77 3A43F3          13      LD  A,(0F341H+2)    ;メインRAMに戻す
000604 CB7A CD77D6          17      CALL    ENASLT
       CB7D                     DRD_SWC3:
000607 CB7D A7               4      AND A       ;自己書き換え)被っている場合はSCFになる
000608 CB7E 3012            12      JR  NC,DRD3
                                
00060A CB80 2A7EE7          16      LD  HL,(_DTBUF)
00060D CB83 110000          10      LD  DE,0
       CB84                     DRD_SWC1    EQU $-2
000610 CB86 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
000613 CB89 E607             7      AND 7
000615 CB8B 47               4      LD  B,A
000616 CB8C 0E00             7      LD  C,0
000618 CB8E EDB0                    LDIR
00061A CB90 E1              10      POP HL
00061B CB91 D5              11      PUSH    DE
       CB92                     DRD3:
00061C CB92 E1              10      POP HL
00061D CB93 D1              10      POP DE
00061E CB94 13               6      INC DE
00061F CB95 C1              10      POP BC
000620 CB96 1083            13      DJNZ    FDRD1
000622 CB98 AF               4      XOR A
000623 CB99 310000          10      LD  SP,0
       CB9A                     DRDSP   EQU $-2
       CB9B                     DRDSPH  EQU $-1
000626 CB9C FB               4      EI
000627 CB9D C9              10      RET
                                
       CB9B                     FDD_BDOS_JP EQU $-3
       CB9C                     FDD_BDOS_ADR    EQU $-2
[EOF:MSXDISK.ASM:UTF_8]
                                    INCLUDE "MSXCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MSX
                                
       CB9E                     S27BUF_COM:
000628 CB9E 110001          10      LD  DE,BUF_COM
00062B CBA1 CDDBD1          17      CALL    _SYS1A      ;(BDOS)DTAの設定
00062E CBA4 2100FE          10      LD  HL,0-BUF_COM-00100H ;バッファー+スタック予備(0100H)
000631 CBA7 C37CCC          10      JP  S27BUF2
       CBAA                     WBOOT1:
000634 CBAA ED7B0600        20      LD  SP,(SYSTEM+1)
000638 CBAE 3E03             7      LD  A,3
00063A CBB0 CDAAD2          17      CALL    MSG_A
       CBB3                     WBOOT2:
[EOF:MSXCCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       CBB3                     COMMAND:
00063D CBB3 3AA1E5          13      LD  A,(FCB_BAT)
000640 CBB6 B7               4      OR  A
000641 CBB7 C2F5CC          10      JP  NZ,C_BAT1
000644 CBBA CD69CC          17      CALL    SETDTA1
000647 CBBD 3A0400          13      LD  A,(_DVSW)
00064A CBC0 C641             7      ADD A,'A'
00064C CBC2 CDAAD2          17      CALL    MSG_A
00064F CBC5 3E3E             7      LD  A,'>'
000651 CBC7 CDAAD2          17      CALL    MSG_A
000654 CBCA 3E50             7      LD  A,80
000656 CBCC 12               7      LD  (DE),A
000657 CBCD CD6AD3          17      CALL    _SYS0A      ;(BDOS)文字列入力
00065A CBD0 CDEACD          17      CALL    LTNL
       CBD3                     COMMAND2:
00065D CBD3 118200          10      LD  DE,DTA1+2
000660 CBD6 CDFDE6          17      CALL    _COMANL
000663 CBD9 DC9BD2          17      CALL    C,SHOW_ERROR
000666 CBDC 18D5            12      JR  COMMAND
                                
       CBDE                     COMANL:
000668 CBDE CD65D7          17      CALL    FILE
00066B CBE1 3A19E6          13      LD  A,(FNAME+4)
00066E CBE4 FE20             7      CP  020H
000670 CBE6 201C            12      JR  NZ,COMB2
000672 CBE8 D5              11      PUSH    DE
000673 CBE9 1115E6          10      LD  DE,FNAME
000676 CBEC 1A               7      LD  A,(DE)
000677 CBED FE20             7      CP  020H
000679 CBEF 2844            12      JR  Z,SDVSW
00067B CBF1 1B               6      DEC DE
00067C CBF2 1A               7      LD  A,(DE)
00067D CBF3 C6FF             7      ADD A,0FFH
00067F CBF5 3809            12      JR  C,COMB
000681 CBF7 13               6      INC DE
                                
000682 CBF8 21A7CF          10      LD  HL,COMTB
000685 CBFB 0608             7      LD  B,COMS
000687 CBFD CDF2D9          17      CALL    CPNAME
       CC00                     COMB:
00068A CC00 D1              10      POP DE
00068B CC01 D29AD2          10      JP  NC,JPHL
       CC04                     COMB2:
00068E CC04 EB               4      EX  DE,HL
00068F CC05 22D2CC          16      LD  (COMSWC),HL
000692 CC08 F5              11      PUSH    AF
000693 CC09 CD8ACC          17      CALL    CEXE4
000696 CC0C F1              10      POP AF
000697 CC0D 2115E6          10      LD  HL,FNAME
00069A CC10 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
00069D CC13 010B00          10      LD  BC,11
0006A0 CC16 EDB0                    LDIR
0006A2 CC18 1140E5          10      LD  DE,PATHD
       CC1B                     CEX1:
0006A5 CC1B 1A               7      LD  A,(DE)
0006A6 CC1C FE20             7      CP  020H
0006A8 CC1E D8              11      RET C
0006A9 CC1F CD5AD7          17      CALL    FILEC
0006AC CC22 D5              11      PUSH    DE
0006AD CC23 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
0006B0 CC26 1115E6          10      LD  DE,FNAME
0006B3 CC29 010B00          10      LD  BC,11
0006B6 CC2C EDB0                    LDIR
0006B8 CC2E CD8ACC          17      CALL    CEXE4
0006BB CC31 D1              10      POP DE
0006BC CC32 13               6      INC DE
0006BD CC33 18E6            12      JR  CEX1
                                
       CC35                     SDVSW:
0006BF CC35 F1              10      POP AF
0006C0 CC36 3A14E6          13      LD  A,(FDRV)
0006C3 CC39 3D               4      DEC A
0006C4 CC3A 5F               4      LD  E,A
0006C5 CC3B 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
0006C7 CC3D 1831            12      JR  SYSTEM0
                                
       CC3F                     OPEN1:
0006C9 CC3F 2114E6          10      LD  HL,FDRV
       CC42                     OPEN:
0006CC CC42 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       CC44                     OPEN3:
0006CE CC44 D5              11      PUSH    DE
0006CF CC45 117CE5          10      LD  DE,DTA_CCP
0006D2 CC48 CD66CC          17      CALL    SETDTA
0006D5 CC4B EB               4      EX  DE,HL
0006D6 CC4C CD70CC          17      CALL    SYSTEM0
0006D9 CC4F D1              10      POP DE
0006DA CC50 C9              10      RET
                                
       CC51                     OPEN2:
0006DB CC51 0E12             7      LD  C,012H
0006DD CC53 18EF            12      JR  OPEN3
                                
       CC55                     DEFCB:              ;Z=Ok NZ=Error
0006DF CC55 117CE5          10      LD  DE,DTA_CCP
0006E2 CC58 CD6ECC          17      CALL    SYSC0F
                                
0006E5 CC5B 119DE5          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0006E8 CC5E 0604             7      LD  B,4
0006EA CC60 CDBBCE          17      CALL    ZERO_MEMORY_DE
       CC63                     SETDTA100:
0006ED CC63 110080          10      LD  DE,BUFFER
       CC66                     SETDTA:
0006F0 CC66 C3DBD1          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       CC69                     SETDTA1:
0006F3 CC69 118000          10      LD  DE,DTA1
0006F6 CC6C 18F8            12      JR  SETDTA
                                
       CC6E                     SYSC0F:
0006F8 CC6E 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       CC70                     SYSTEM0:
0006FA CC70 CD0500          17      CALL    SYSTEM
0006FD CC73 B7               4      OR  A
0006FE CC74 C9              10      RET
                                
       CC75                     C_CD:
0006FF CC75 0E5A             7      LD  C,05AH
000701 CC77 18F7            12      JR  SYSTEM0
                                
       CC79                     S27BUF:
000703 CC79 21007F          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       CC7C                     S27BUF2:
000706 CC7C 39              11      ADD HL,SP
000707 CC7D 2E00             7      LD  L,0
000709 CC7F 7C               4      LD  A,H
00070A CC80 E6F8             7      AND 0F8H
00070C CC82 67               4      LD  H,A
       CC83                     S27DTA:
00070D CC83 117CE5          10      LD  DE,DTA_CCP
       CC86                     S27:
000710 CC86 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
000712 CC88 18E6            12      JR  SYSTEM0
                                
       CC8A                     CEXE4:
000714 CC8A 211DE6          10      LD  HL,FNAME+8
000717 CC8D 7E               7      LD  A,(HL)
000718 CC8E FE20             7      CP  020H
00071A CC90 2007            12      JR  NZ,CEXE7
00071C CC92 3E3F             7      LD  A,'?'
00071E CC94 77               7      LD  (HL),A
00071F CC95 23               6      INC HL
000720 CC96 77               7      LD  (HL),A
000721 CC97 23               6      INC HL
000722 CC98 77               7      LD  (HL),A
       CC99                     CEXE7:
000723 CC99 CD3FCC          17      CALL    OPEN1
       CC9C                     CEXE5:
000726 CC9C C0              11      RET NZ
000727 CC9D 2A86E5          16      LD  HL,(DTA_CCP+1+9)
00072A CCA0 7C               4      LD  A,H
00072B CCA1 CD81DA          17      CALL    CAP
00072E CCA4 67               4      LD  H,A
00072F CCA5 7D               4      LD  A,L
000730 CCA6 CD81DA          17      CALL    CAP
000733 CCA9 6F               4      LD  L,A
000734 CCAA 3A85E5          13      LD  A,(DTA_CCP+1+8)
000737 CCAD CD81DA          17      CALL    CAP
00073A CCB0 D642             7      SUB 'B'
00073C CCB2 282C            12      JR  Z,C_BAT
00073E CCB4 3D               4      DEC A       ;'C'
00073F CCB5 2805            12      JR  Z,C_EXE
       CCB7                     CEXE6:
000741 CCB7 CD51CC          17      CALL    OPEN2
000744 CCBA 18E0            12      JR  CEXE5
                                
       CCBC                     C_EXE:
000746 CCBC 7C               4      LD  A,H
000747 CCBD FE4D             7      CP  'M'
000749 CCBF 20F6            12      JR  NZ,CEXE6
                                
00074B CCC1 CD55CC          17      CALL    DEFCB
00074E CCC4 CD9ECB          17      CALL    S27BUF_COM
000751 CCC7 3D               4      DEC A
000752 CCC8 37               4      SCF
000753 CCC9 C0              11      RET NZ
000754 CCCA 7C               4      LD  A,H
000755 CCCB B5               4      OR  L
000756 CCCC 37               4      SCF
000757 CCCD C8              11      RET Z
000758 CCCE CD69CC          17      CALL    SETDTA1
00075B CCD1 110000          10      LD  DE,0                ; self-modifying code
       CCD2                     COMSWC  EQU $-2
00075E CCD4 ED7B0600        20      LD  SP,(SYSTEM+1)
000762 CCD8 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000763 CCD9 6F               4      LD  L,A
000764 CCDA E5              11      PUSH    HL              ; push $0000 (reboot address)
000765 CCDB 24               4      INC H
000766 CCDC E5              11      PUSH    HL              ; push $0100 (TPA address)
000767 CCDD C386CE          10      JP  SETFCB              ; and JP $0100
                                
       CCE0                     C_BAT:
00076A CCE0 114154          10      LD  DE,'A'+'T'*256
00076D CCE3 ED52            15      SBC HL,DE
00076F CCE5 20D0            12      JR  NZ,CEXE6
                                
000771 CCE7 CD55CC          17      CALL    DEFCB
                                
000774 CCEA 217CE5          10      LD  HL,DTA_CCP
000777 CCED 11A1E5          10      LD  DE,FCB_BAT
00077A CCF0 012500          10      LD  BC,37
00077D CCF3 EDB0                    LDIR
       CCF5                     C_BAT1:
00077F CCF5 CD63CC          17      CALL    SETDTA100
000782 CCF8 CD2CCD          17      CALL    FGETC_BAT
000785 CCFB 218100          10      LD  HL,DTA1+1
000788 CCFE 2025            12      JR  NZ,END_BATCH
00078A CD00 FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
00078C CD02 38F1            12      JR  C,C_BAT1
00078E CD04 3620            10      LD  (HL),' '
000790 CD06 23               6      INC HL
       CD07                     C_BAT2:
000791 CD07 77               7      LD  (HL),A
000792 CD08 23               6      INC HL
000793 CD09 7D               4      LD  A,L
000794 CD0A 3C               4      INC A       ;L==0FFH
000795 CD0B 2809            12      JR  Z,RUN_BATCH
000797 CD0D CD2CCD          17      CALL    FGETC_BAT
00079A CD10 2004            12      JR  NZ,RUN_BATCH
00079C CD12 FE20             7      CP  020H
00079E CD14 30F1            12      JR  NC,C_BAT2
       CD16                     RUN_BATCH:
0007A0 CD16 7D               4      LD  A,L
0007A1 CD17 D67F             7      SUB DTA1-1
0007A3 CD19 328000          13      LD  (DTA1),A
0007A6 CD1C FE04             7      CP  4
0007A8 CD1E 3805            12      JR  C,END_BATCH
0007AA CD20 3600            10      LD  (HL),0
0007AC CD22 C3D3CB          10      JP  COMMAND2
       CD25                     END_BATCH:
0007AF CD25 AF               4      XOR A       ;バッチファイルを閉じる
0007B0 CD26 32A1E5          13      LD  (FCB_BAT),A
0007B3 CD29 C300E6          10      JP  CPM_BOOT
                                
       CD2C                     FGETC_BAT:
0007B6 CD2C 11A1E5          10      LD  DE,FCB_BAT
       CD2F                     FGETC:              ;1文字ずつ読み込む
0007B9 CD2F E5              11      PUSH    HL      ;Z:成功
0007BA CD30 210100          10      LD  HL,1
0007BD CD33 CD86CC          17      CALL    S27
0007C0 CD36 E1              10      POP HL
0007C1 CD37 3A0080          13      LD  A,(BUFFER)
0007C4 CD3A C9              10      RET
                                
       CD3B                     C_DEL:
0007C5 CD3B CD86CE          17      CALL    SETFCB
0007C8 CD3E CDE6D2          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
0007CB CD41 0E13             7      LD  C,013H
0007CD CD43 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       CD45                     C_REN:
0007CF CD45 CD86CE          17      CALL    SETFCB
0007D2 CD48 3E10             7      LD  A,010H      ;ディレクトリも対象にする
0007D4 CD4A 326900          13      LD  (FCB1+13),A ;属性
0007D7 CD4D 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       CD4F                     CDEL1:
0007D9 CD4F 115C00          10      LD  DE,FCB1
0007DC CD52 CD0500          17      CALL    SYSTEM
0007DF CD55 C6FF             7      ADD A,0FFH
0007E1 CD57 C9              10      RET
                                
       CD58                     C_DIR:
0007E2 CD58 CD5AD7          17      CALL    FILEC
0007E5 CD5B 2115E6          10      LD  HL,FDRV+1
0007E8 CD5E CD9CCF          17      CALL    CWILD1
0007EB CD61 3EF1             7      LD  A,0F1H
0007ED CD63 3221E6          13      LD  (FDRV+13),A
0007F0 CD66 CD3FCC          17      CALL    OPEN1
       CD69                     CDIR1:
0007F3 CD69 B7               4      OR  A
0007F4 CD6A 2008            12      JR  NZ,PDSKF
0007F6 CD6C CDB7CD          17      CALL    P_NAME
0007F9 CD6F CD51CC          17      CALL    OPEN2
0007FC CD72 18F5            12      JR  CDIR1
       CD74                     PDSKF:
0007FE CD74 3A14E6          13      LD  A,(FDRV)
000801 CD77 5F               4      LD  E,A
000802 CD78 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
000804 CD7A CD0500          17      CALL    SYSTEM
000807 CD7D 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
000808 CD7E C601             7      ADD A,001H
00080A CD80 D8              11      RET C       ;Aが0FFHだった場合
00080B CD81 3E06             7      LD  A,8-2
       CD83                     PDS1:               ;HL=未使用クラスタの総数
00080D CD83 3C               4      INC A
00080E CD84 CB19             8      RR  C
000810 CD86 30FB            12      JR  NC,PDS1
       CD88                     PDS2:               ;B←論理セクタのサイズの上位8ビット
000812 CD88 3C               4      INC A
000813 CD89 CB18             8      RR  B
000815 CD8B 30FB            12      JR  NC,PDS2
000817 CD8D 47               4      LD  B,A
                                
000818 CD8E 110000          10      LD  DE,0
       CD91                     PDS3:
00081B CD91 29              11      ADD HL,HL
00081C CD92 EB               4      EX  DE,HL
00081D CD93 ED6A            15      ADC HL,HL
00081F CD95 EB               4      EX  DE,HL
000820 CD96 10F9            13      DJNZ    PDS3
       CD98                     PDSKF1:
000822 CD98 CD24CE          17      CALL    PRDEC_DEHL
000825 CD9B 11D1E5          10      LD  DE,FREE
000828 CD9E CD08D0          17      CALL    _SYS09      ;(BDOS)文字列出力
00082B CDA1 CD11CE          17      CALL    PUTDRV
00082E CDA4 3E5C             7      LD  A,05CH      ;\
000830 CDA6 CDAAD2          17      CALL    MSG_A
000833 CDA9 2A22E6          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
000836 CDAC AF               4      XOR A
000837 CDAD 11FEFF          10      LD  DE,0-2
00083A CDB0 19              11      ADD HL,DE
00083B CDB1 23               6      INC HL
00083C CDB2 DC21CE          17      CALL    C,PRDEC_HL
00083F CDB5 1833            12      JR  LTNL
                                
       CDB7                     P_NAME:
000841 CDB7 3A7DE5          13      LD  A,(DTA_CCP+1)
000844 CDBA FE2E             7      CP  '.'
000846 CDBC C8              11      RET Z
                                
000847 CDBD 3A88E5          13      LD  A,(DTA_CCP+1+00BH)
00084A CDC0 F5              11      PUSH    AF
00084B CDC1 CB67             8      BIT 4,A
00084D CDC3 2808            12      JR  Z,DIR3
00084F CDC5 11C6E5          10      LD  DE,DIRMES
000852 CDC8 CD08D0          17      CALL    _SYS09      ;(BDOS)文字列出力
000855 CDCB 180A            12      JR  DIR6
       CDCD                     DIR3:
000857 CDCD ED5B9BE5        20      LD  DE,(DTA_CCP+1+01EH)
00085B CDD1 2A99E5          16      LD  HL,(DTA_CCP+1+01CH)
00085E CDD4 CD24CE          17      CALL    PRDEC_DEHL
       CDD7                     DIR6:
000861 CDD7 F1              10      POP AF
000862 CDD8 0F               4      RRCA
000863 CDD9 9F               4      SBC A,A
000864 CDDA E60A             7      AND '*'-020H
000866 CDDC C620             7      ADD A,020H
000868 CDDE CDAAD2          17      CALL    MSG_A
00086B CDE1 CD11CE          17      CALL    PUTDRV
00086E CDE4 217DE5          10      LD  HL,DTA_CCP+1
000871 CDE7 CD64CE          17      CALL    FPRNT
                                
       CDEA                     LTNL:
000874 CDEA 1E03             7      LD  E,3
000876 CDEC C3CDE6          10      JP  _PRINT
                                
       CDEF                     C_PATH:
000879 CDEF CD3BD8          17      CALL    SPCUT
00087C CDF2 2140E5          10      LD  HL,PATHD
00087F CDF5 FE21             7      CP  021H
000881 CDF7 300C            12      JR  NC,CPATH0
       CDF9                     CPATHP:
000883 CDF9 7E               7      LD  A,(HL)
000884 CDFA 23               6      INC HL
000885 CDFB FE20             7      CP  020H
000887 CDFD 3F               4      CCF
000888 CDFE 30EA            12      JR  NC,LTNL
00088A CE00 CDAAD2          17      CALL    MSG_A
00088D CE03 18F4            12      JR  CPATHP
       CE05                     CPATH0:
00088F CE05 FE3B             7      CP  ';'
000891 CE07 2001            12      JR  NZ,CPATH1
000893 CE09 13               6      INC DE
       CE0A                     CPATH1:
000894 CE0A EB               4      EX  DE,HL
000895 CE0B 013B00          10      LD  BC,PATHX
000898 CE0E EDB0                    LDIR
00089A CE10 C9              10      RET
                                
       CE11                     PUTDRV:
00089B CE11 3A14E6          13      LD  A,(FDRV)
00089E CE14 CD6ED8          17      CALL    GETDRV1
0008A1 CE17 C641             7      ADD A,'A'
0008A3 CE19 CDAAD2          17      CALL    MSG_A
0008A6 CE1C 3E3A             7      LD  A,':'
       CE1E                     MSG_AR:
0008A8 CE1E C3AAD2          10      JP  MSG_A
                                
       CE21                     PRDEC_HL:
0008AB CE21 AF               4      XOR A
0008AC CE22 5F               4      LD  E,A
0008AD CE23 57               4      LD  D,A
       CE24                     PRDEC_DEHL:
0008AE CE24 D5              11      PUSH    DE
0008AF CE25 110FE6          10      LD  DE,DECBF
0008B2 CE28 0605             7      LD  B,5
0008B4 CE2A CDBBCE          17      CALL    ZERO_MEMORY_DE  ;A=0
0008B7 CE2D D1              10      POP DE
                                
0008B8 CE2E 0E20             7      LD  C,32
       CE30                     DEC1:
0008BA CE30 29              11      ADD HL,HL
0008BB CE31 EB               4      EX  DE,HL
0008BC CE32 ED6A            15      ADC HL,HL
0008BE CE34 EB               4      EX  DE,HL
0008BF CE35 E5              11      PUSH    HL
0008C0 CE36 2113E6          10      LD  HL,DECBF+4
0008C3 CE39 0605             7      LD  B,5
       CE3B                     DEC2:
0008C5 CE3B 7E               7      LD  A,(HL)
0008C6 CE3C 8F               4      ADC A,A
0008C7 CE3D 27               4      DAA
0008C8 CE3E 77               7      LD  (HL),A
0008C9 CE3F 2B               6      DEC HL
0008CA CE40 10F9            13      DJNZ    DEC2
0008CC CE42 E1              10      POP HL
0008CD CE43 0D               4      DEC C
0008CE CE44 20EA            12      JR  NZ,DEC1
                                
0008D0 CE46 210FE6          10      LD  HL,DECBF
0008D3 CE49 3E20             7      LD  A,020H
0008D5 CE4B 0604             7      LD  B,4
       CE4D                     DEC3:
0008D7 CE4D CD5ACE          17      CALL    DEC4
0008DA CE50 CD5ACE          17      CALL    DEC4
0008DD CE53 23               6      INC HL
0008DE CE54 10F7            13      DJNZ    DEC3
       CE56                     DECX:
0008E0 CE56 CD5ACE          17      CALL    DEC4
0008E3 CE59 AF               4      XOR A
       CE5A                     DEC4:
0008E4 CE5A ED6F            18      RLD
0008E6 CE5C FE20             7      CP  020H
0008E8 CE5E 2802            12      JR  Z,DEC5
0008EA CE60 F630             7      OR  030H
       CE62                     DEC5:
0008EC CE62 18BA            12      JR  MSG_AR
                                
       CE64                     FPRNT:
0008EE CE64 0608             7      LD  B,8 ;ファイル名を表示
0008F0 CE66 CD75CE          17      CALL    P_N1
0008F3 CE69 7E               7      LD  A,(HL)
0008F4 CE6A CD8DDA          17      CALL    CAP3
0008F7 CE6D D8              11      RET C   ;拡張子が無い
                                
0008F8 CE6E 3E2E             7      LD  A,'.'
0008FA CE70 CDAAD2          17      CALL    MSG_A
0008FD CE73 0603             7      LD  B,3 ;拡張子を表示
       CE75                     P_N1:
0008FF CE75 7E               7      LD  A,(HL)
000900 CE76 CD8DDA          17      CALL    CAP3
000903 CE79 3807            12      JR  C,P_N2
000905 CE7B CDAAD2          17      CALL    MSG_A
000908 CE7E 23               6      INC HL
000909 CE7F 10F4            13      DJNZ    P_N1
00090B CE81 C9              10      RET
       CE82                     P_N2:
00090C CE82 23               6      INC HL
00090D CE83 10FD            13      DJNZ    P_N2
00090F CE85 C9              10      RET
                                
       CE86                     SETFCB:
000910 CE86 CD3BD8          17      CALL    SPCUT
000913 CE89 1A               7      LD  A,(DE)
000914 CE8A FE20             7      CP  020H
000916 CE8C 3801            12      JR  C,SETFCBA
000918 CE8E 1B               6      DEC DE
       CE8F                     SETFCBA:
000919 CE8F 0624             7      LD  B,36
00091B CE91 215C00          10      LD  HL,FCB1
00091E CE94 E5              11      PUSH    HL
00091F CE95 AF               4      XOR A
000920 CE96 CD10D8          17      CALL    FILL_MEMORY
000923 CE99 E1              10      POP HL
000924 CE9A D5              11      PUSH    DE
000925 CE9B CD41D2          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000928 CE9E 216C00          10      LD  HL,FCB2
00092B CEA1 CD41D2          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
00092E CEA4 E1              10      POP HL
00092F CEA5 010050          10      LD  BC,05000H
000932 CEA8 118100          10      LD  DE,00081H
       CEAB                     SETFCB1:
000935 CEAB 7E               7      LD  A,(HL)
000936 CEAC 23               6      INC HL
000937 CEAD FE20             7      CP  020H
000939 CEAF 3805            12      JR  C,SETFCB2
00093B CEB1 12               7      LD  (DE),A
00093C CEB2 13               6      INC DE
00093D CEB3 0C               4      INC C
00093E CEB4 10F5            13      DJNZ    SETFCB1
       CEB6                     SETFCB2:
000940 CEB6 79               4      LD  A,C
000941 CEB7 328000          13      LD  (DTA1),A
000944 CEBA 04               4      INC B
       CEBB                     ZERO_MEMORY_DE:
000945 CEBB AF               4      XOR A
       CEBC                     FILL_MEMORY_DE:
000946 CEBC 12               7      LD  (DE),A
000947 CEBD 13               6      INC DE
000948 CEBE 10FC            13      DJNZ    FILL_MEMORY_DE
00094A CEC0 C9              10      RET
                                
       CEC1                     C_COPY:
00094B CEC1 CD86CE          17      CALL    SETFCB
                                
00094E CEC4 1161E6          10      LD  DE,ZERO
000951 CEC7 CD5DD7          17      CALL    FILEC2
000954 CECA 216C00          10      LD  HL,FCB2
000957 CECD CD48D2          17      CALL    S29X1
                                
00095A CED0 3E10             7      LD  A,010H
00095C CED2 326900          13      LD  (FCB1+13),A
00095F CED5 216D00          10      LD  HL,FCB2FN
000962 CED8 CD9CCF          17      CALL    CWILD1
       CEDB                     COPY0:
000965 CEDB CD99CF          17      CALL    CWILD
000968 CEDE 215C00          10      LD  HL,FCB1
00096B CEE1 CD42CC          17      CALL    OPEN
00096E CEE4 37               4      SCF
       CEE5                     COPY1:
00096F CEE5 C0              11      RET NZ
000970 CEE6 CD55CC          17      CALL    DEFCB
                                
000973 CEE9 3A89E5          13      LD  A,(DTA_CCP+13)
000976 CEEC CB67             8      BIT 4,A
000978 CEEE 2821            12      JR  Z,COPY1A
                                
00097A CEF0 215D00          10      LD  HL,FCB1FN
00097D CEF3 CDA0DB          17      CALL    CHKWILD
000980 CEF6 3814            12      JR  C,COPY9
                                
000982 CEF8 3E20             7      LD  A,020H
000984 CEFA 325D00          13      LD  (FCB1FN),A
000987 CEFD 2A96E5          16      LD  HL,(DTA_CCP+26)
00098A CF00 23               6      INC HL
00098B CF01 226A00          16      LD  (FCB1+14),HL
00098E CF04 18D5            12      JR  COPY0
                                
       CF06                     COPY8:
000990 CF06 CD08D0          17      CALL    _SYS09      ;(BDOS)文字列出力
000993 CF09 CDEACD          17      CALL    LTNL
       CF0C                     COPY9:
000996 CF0C CD51CC          17      CALL    OPEN2
000999 CF0F 18D4            12      JR  COPY1
                                
       CF11                     COPY1A:
00099B CF11 216C00          10      LD  HL,FCB2
00099E CF14 1114E6          10      LD  DE,FDRV
0009A1 CF17 017EE5          10      LD  BC,DTA_CCP+2
0009A4 CF1A EDA0            16      LDI
0009A6 CF1C 3E0B             7      LD  A,11
       CF1E                     COPY2:
0009A8 CF1E F5              11      PUSH    AF
0009A9 CF1F 7E               7      LD  A,(HL)
0009AA CF20 FE3F             7      CP  '?'
0009AC CF22 2001            12      JR  NZ,COPY3
0009AE CF24 0A               7      LD  A,(BC)
       CF25                     COPY3:
0009AF CF25 12               7      LD  (DE),A
0009B0 CF26 03               6      INC BC
0009B1 CF27 13               6      INC DE
0009B2 CF28 23               6      INC HL
0009B3 CF29 F1              10      POP AF
0009B4 CF2A 3D               4      DEC A
0009B5 CF2B 20F1            12      JR  NZ,COPY2
0009B7 CF2D 010500          10      LD  BC,16-11
0009BA CF30 EDB0                    LDIR
       CF32                     PUTNAME:
0009BC CF32 215D00          10      LD  HL,FCB1FN
0009BF CF35 CDA0DB          17      CALL    CHKWILD
0009C2 CF38 300B            12      JR  NC,PUTN1
0009C4 CF3A 2115E6          10      LD  HL,FDRV+1
0009C7 CF3D CD64CE          17      CALL    FPRNT
0009CA CF40 3E20             7      LD  A,020H
0009CC CF42 CDAAD2          17      CALL    MSG_A
       CF45                     PUTN1:
0009CF CF45 1114E6          10      LD  DE,FDRV
0009D2 CF48 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
0009D4 CF4A CD70CC          17      CALL    SYSTEM0
0009D7 CF4D 2048            12      JR  NZ,COPYE2
0009D9 CF4F 67               4      LD  H,A     ;A=0
0009DA CF50 6F               4      LD  L,A
0009DB CF51 2235E6          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0009DE CF54 2237E6          16      LD  (FDRV+35),HL
       CF57                     COPY6:
0009E1 CF57 CD79CC          17      CALL    S27BUF
0009E4 CF5A 47               4      LD  B,A
0009E5 CF5B 3C               4      INC A
0009E6 CF5C 2831            12      JR  Z,COPYE
0009E8 CF5E 7C               4      LD  A,H
0009E9 CF5F B5               4      OR  L
0009EA CF60 280C            12      JR  Z,COPY7
0009EC CF62 1114E6          10      LD  DE,FDRV
0009EF CF65 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0009F1 CF67 CD70CC          17      CALL    SYSTEM0
0009F4 CF6A 2023            12      JR  NZ,COPYE
0009F6 CF6C 10E9            13      DJNZ    COPY6
       CF6E                     COPY7:
0009F8 CF6E 3A89E5          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0009FB CF71 3221E6          13      LD  (FDRV+13),A
0009FE CF74 2190E5          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
000A01 CF77 1128E6          10      LD  DE,FDRV+20
000A04 CF7A 010400          10      LD  BC,4
000A07 CF7D EDB0                    LDIR
                                
000A09 CF7F 1114E6          10      LD  DE,FDRV
000A0C CF82 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
000A0E CF84 CD70CC          17      CALL    SYSTEM0
000A11 CF87 2006            12      JR  NZ,COPYE
                                
000A13 CF89 1171E6          10      LD  DE,OK
000A16 CF8C C306CF          10      JP  COPY8
                                
       CF8F                     COPYE:
000A19 CF8F 1114E6          10      LD  DE,FDRV
000A1C CF92 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
000A1E CF94 CD0500          17      CALL    SYSTEM
       CF97                     COPYE2:
000A21 CF97 37               4      SCF
000A22 CF98 C9              10      RET
                                
       CF99                     CWILD:
000A23 CF99 215D00          10      LD  HL,FCB1FN
       CF9C                     CWILD1:
000A26 CF9C 7E               7      LD  A,(HL)
000A27 CF9D FE20             7      CP  020H
000A29 CF9F C0              11      RET NZ
       CFA0                     CWILD2:
000A2A CFA0 3E3F             7      LD  A,'?'
000A2C CFA2 060B             7      LD  B,11
000A2E CFA4 C310D8          10      JP  FILL_MEMORY
                                
       CFA7                     COMTB:
000A31 CFA7 44202020                DB  "D   "  ;1
000A35 CFAB 58CD                    DW  C_DIR
000A37 CFAD 44495220                DB  "DIR "  ;2
000A3B CFB1 58CD                    DW  C_DIR
000A3D CFB3 434F5059                DB  "COPY"  ;3
000A41 CFB7 C1CE                    DW  C_COPY
000A43 CFB9 43442020                DB  "CD  "  ;4
000A47 CFBD 75CC                    DW  C_CD
000A49 CFBF 44454C20                DB  "DEL "  ;5
000A4D CFC3 3BCD                    DW  C_DEL
000A4F CFC5 50415448                DB  "PATH"  ;6
000A53 CFC9 EFCD                    DW  C_PATH
000A55 CFCB 52454E20                DB  "REN "  ;7
000A59 CFCF 45CD                    DW  C_REN
000A5B CFD1 52454D20                DB  "REM "  ;8
000A5F CFD5 05D0                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       CFD7                     BDOS0:
000A61 CFD7 E5              11      PUSH    HL
000A62 CFD8 79               4      LD  A,C
000A63 CFD9 FE3C             7      CP  03CH
000A65 CFDB 3802            12      JR  C,DOS1
000A67 CFDD 3E3C             7      LD  A,03CH
       CFDF                     DOS1:
000A69 CFDF 87               4      ADD A,A
000A6A CFE0 32E4CF          13      LD  (DOS1_SWC),A
000A6D CFE3 2A00E7          16      LD  HL,(STABLE)
       CFE4                     DOS1_SWC    EQU $-2
000A70 CFE6 E3              19      EX  (SP),HL
000A71 CFE7 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
000A72 CFE8 C9              10      RET
       CFE9                     _DOS2:
000A73 CFE9 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000A75 CFEB CA83D2          10      JP  Z,_SYS5A
000A78 CFEE FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000A7A CFF0 CA40D2          10      JP  Z,_SYS5C
000A7D CFF3 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
000A7F CFF5 CA9BE4          10      JP  Z,_SYS5F
000A82 CFF8 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000A84 CFFA 200A            12      JR  NZ,_ERROR
000A86 CFFC 011D00          10      LD  BC,VER_6F
000A89 CFFF 116101          10      LD  DE,VER
000A8C D002 210301          10      LD  HL,MACD
       D005                     C_REM:
000A8F D005 AF               4      XOR A
       D006                     _ERROR:
000A90 D006 A7               4      AND A
000A91 D007 C9              10      RET
                                
       D008                     _SYS09:     ;文字列出力
000A92 D008 D5              11      PUSH    DE
       D009                     _SX09:
000A93 D009 1A               7      LD  A,(DE)
000A94 D00A 13               6      INC DE
000A95 D00B FE24             7      CP  '$'
000A97 D00D 2831            12      JR  Z,SX0E2
000A99 D00F CDAAD2          17      CALL    MSG_A
000A9C D012 18F5            12      JR  _SX09
                                
       D014                     MSX1:
000A9E D014 CDAAD2          17      CALL    MSG_A
       D017                     MSX:
000AA1 D017 7E               7      LD  A,(HL)
000AA2 D018 23               6      INC HL
000AA3 D019 B7               4      OR  A
000AA4 D01A 20F8            12      JR  NZ,MSX1
000AA6 D01C C9              10      RET
                                
       D01D                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000AA7 D01D 212200          10      LD  HL,00022H
000AAA D020 7D               4      LD  A,L
000AAB D021 C9              10      RET
                                
       D022                     _SYS0D:     ;(BDOS)ディスクリセット
000AAC D022 CDDFE6          17      CALL    _FFLUSH
000AAF D025 E5              11      PUSH    HL
000AB0 D026 218000          10      LD  HL,00080H
000AB3 D029 228AE6          16      LD  (_DTA),HL
000AB6 D02C E1              10      POP HL
000AB7 D02D D5              11      PUSH    DE
000AB8 D02E 1E00             7      LD  E,0
000ABA D030 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D031                     _SYS0E:     ;(BDOS)カレントドライブの設定
000ABB D031 D5              11      PUSH    DE
000ABC D032 7B               4      LD  A,E
000ABD D033 DDE5            15      PUSH    IX
000ABF D035 CDDCE6          17      CALL    _GETDPB
000AC2 D038 DDE1            14      POP IX
000AC4 D03A 3804            12      JR  C,SX0E2
000AC6 D03C 7B               4      LD  A,E
000AC7 D03D 320400          13      LD  (_DVSW),A
       D040                     SX0E2:
000ACA D040 D1              10      POP DE
000ACB D041 C9              10      RET
                                
       D042                     _SYS0F:     ;(BDOS)ファイルのオープン
000ACC D042 CD4DD8          17      CALL    SETDRV
000ACF D045 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000AD2 D048 C602             7      ADD A,002H      ;Write
000AD4 D04A 2848            12      JR  Z,FEND0F
000AD6 D04C CD9CDB          17      CALL    CHKWILDX
                                
000AD9 D04F D477D8          17      CALL    NC,SOPENX
       D052                     _S16XX:
000ADC D052 3840            12      JR  C,FEND0F
                                                ;Directory location
000ADE D054 3A9FE6          13      LD  A,(_FILEN)
000AE1 D057 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
000AE4 D05A 3AA0E6          13      LD  A,(_DIRF)
000AE7 D05D FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000AEA D060 FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
000AED D063 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
000AF0 D066 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
000AF4 D06A FDE5            15      PUSH    IY
000AF6 D06C D1              10      POP DE
000AF7 D06D 13               6      INC DE
000AF8 D06E 010B00          10      LD  BC,11
000AFB D071 EDB0                    LDIR
                                ;               Attribute
000AFD D073 7E               7      LD  A,(HL)
000AFE D074 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
000B01 D077 110B00          10      LD  DE,11       ;Reserved
000B04 D07A 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
000B05 D07B 11E4E7          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
000B08 D07E 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D080                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000B0A D080 1A               7      LD  A,(DE)
000B0B D081 13               6      INC DE
000B0C D082 3289D0          13      LD  (S16PAT),A
000B0F D085 7E               7      LD  A,(HL)
000B10 D086 23               6      INC HL
000B11 D087 FD7700          19      LD  (IY+0),A
       D089                     S16PAT  EQU $-1
000B14 D08A 10F4            13      DJNZ    S16LOOP
                                
000B16 D08C AF               4      XOR A
000B17 D08D FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000B1A D090 FD2231D1        20      LD  (OFCB_SWC),IY
       D094                     FEND0F:
000B1E D094 1845            12      JR  FEND10
                                
       D096                     _SYS10:     ;(BDOS)ファイルのクローズ
000B20 D096 CD4DD8          17      CALL    SETDRV
000B23 D099 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000B26 D09C D6FE             7      SUB 0FEH
000B28 D09E 37               4      SCF
000B29 D09F 3F               4      CCF
000B2A D0A0 2039            12      JR  NZ,FEND10
       D0A2                     _S10A:              ;Write
000B2C D0A2 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000B2F D0A5 FD770F          19      LD  (IY+15),A
                                
000B32 D0A8 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
000B35 D0AB CD98DC          17      CALL    SETTMS
                                
000B38 D0AE FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000B3B D0B1 32A0E6          13      LD  (_DIRF),A
000B3E D0B4 E67F             7      AND 07FH
000B40 D0B6 32BDE1          13      LD  (_SECPS),A
000B43 D0B9 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000B46 D0BC FD561F          19      LD  D,(IY+31)
000B49 D0BF CDABD9          17      CALL    READ_DIR
000B4C D0C2 3817            12      JR  C,FEND10
                                
000B4E D0C4 3AD7D8          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000B51 D0C7 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000B52 D0C8 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000B55 D0CB 6F               4      LD  L,A
000B56 D0CC 2600             7      LD  H,0
000B58 D0CE 29              11      ADD HL,HL       ;*2
000B59 D0CF 29              11      ADD HL,HL       ;*4
000B5A D0D0 29              11      ADD HL,HL       ;*8
000B5B D0D1 29              11      ADD HL,HL       ;*16
000B5C D0D2 29              11      ADD HL,HL       ;*32
000B5D D0D3 ED4B7EE7        20      LD  BC,(_DTBUF)
000B61 D0D7 09              11      ADD HL,BC
                                
000B62 D0D8 CDACDB          17      CALL    SDIRENT
       D0DB                     FEND10:
000B65 D0DB 1842            12      JR  FEND
                                
       D0DD                     _SYS11:     ;(BDOS)最初のファイルの検索
000B67 D0DD CD4DD8          17      CALL    SETDRV
000B6A D0E0 CDA6D8          17      CALL    SOPEN
       D0E3                     _S12X1:
000B6D D0E3 383A            12      JR  C,FEND
000B6F D0E5 CD45D9          17      CALL    SOPENE2
000B72 D0E8 ED5B8AE6        20      LD  DE,(_DTA)
000B76 D0EC 3A88E6          13      LD  A,(_DRV)
000B79 D0EF 3C               4      INC A
000B7A D0F0 12               7      LD  (DE),A
000B7B D0F1 D5              11      PUSH    DE
000B7C D0F2 13               6      INC DE
000B7D D0F3 012000          10      LD  BC,32
000B80 D0F6 EDB0                    LDIR
000B82 D0F8 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000B85 D0FB FD660F          19      LD  H,(IY+15)
000B88 D0FE 22F4E7          16      LD  (SCDIR),HL
000B8B D101 2A9AE6          16      LD  HL,(_FBPS)
000B8E D104 22F6E7          16      LD  (SFBPS),HL
000B91 D107 2A9FE6          16      LD  HL,(_FILEN)
000B94 D10A 7C               4      LD  A,H
000B95 D10B B7               4      OR  A
000B96 D10C 2806            12      JR  Z,_S12DIR
000B98 D10E 3ABDE1          13      LD  A,(_SECPS)
000B9B D111 F680             7      OR  080H
000B9D D113 67               4      LD  H,A
       D114                     _S12DIR:
000B9E D114 22F8E7          16      LD  (SFNDF),HL  ;Directory position and Flags
000BA1 D117 E1              10      POP HL
000BA2 D118 1139E6          10      LD  DE,SFILE
000BA5 D11B 0E21             7      LD  C,33
       D11D                     _S11B:
000BA7 D11D EDB0                    LDIR
       D11F                     FEND:
000BA9 D11F 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D120                     FENDE:
000BAA D120 FDE1            14      POP IY
000BAC D122 C1              10      POP BC
000BAD D123 D1              10      POP DE
000BAE D124 E1              10      POP HL
000BAF D125 C9              10      RET
                                
       D126                     _SYS12:     ;(BDOS)次のファイルの検索
000BB0 D126 E5              11      PUSH    HL
000BB1 D127 D5              11      PUSH    DE
000BB2 D128 C5              11      PUSH    BC
000BB3 D129 FDE5            15      PUSH    IY
000BB5 D12B CD0AD9          17      CALL    NOPEN
000BB8 D12E 18B3            12      JR  _S12X1
                                
       D130                     _S16K:
000BBA D130 110000          10      LD  DE,0
       D131                     OFCB_SWC    EQU $-2
000BBD D133 D5              11      PUSH    DE
000BBE D134 061A             7      LD  B,26        ;First cluster
       D136                     S16K1:
000BC0 D136 13               6      INC DE
000BC1 D137 23               6      INC HL
000BC2 D138 10FC            13      DJNZ    S16K1
                                
000BC4 D13A 1A               7      LD  A,(DE)
000BC5 D13B BE               7      CP  (HL)
000BC6 D13C 2015            12      JR  NZ,S16K2
000BC8 D13E 13               6      INC DE
000BC9 D13F 23               6      INC HL
000BCA D140 1A               7      LD  A,(DE)
000BCB D141 BE               7      CP  (HL)
000BCC D142 200F            12      JR  NZ,S16K2
                                
000BCE D144 E1              10      POP HL
000BCF D145 FDE5            15      PUSH    IY
000BD1 D147 D1              10      POP DE
000BD2 D148 7E               7      LD  A,(HL)
000BD3 D149 CD62D8          17      CALL    IS_SAME_DRV_A_DE
000BD6 D14C 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000BD8 D14E ED52            15      SBC HL,DE       ;CP HL,DE
000BDA D150 37               4      SCF
000BDB D151 C0              11      RET NZ
000BDC D152 E5              11      PUSH    HL
       D153                     S16K2:
000BDD D153 E1              10      POP HL
       D154                     S16K3:
000BDE D154 FDE5            15      PUSH    IY
000BE0 D156 D1              10      POP DE
       D157                     _SYS13:     ;(BDOS)ファイルの削除
000BE1 D157 CD4DD8          17      CALL    SETDRV
000BE4 D15A CDD4DA          17      CALL    KILL
       D15D                     FEND13:
000BE7 D15D 18C0            12      JR  FEND
                                
       D15F                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000BE9 D15F CD4DD8          17      CALL    SETDRV
000BEC D162 CD10E0          17      CALL    INIT_SEQ
       D165                     SREAD:
000BEF D165 CDE2DF          17      CALL    RB_READ
                                
000BF2 D168 C601             7      ADD A,001H
000BF4 D16A 38B3            12      JR  C,FEND
                                
000BF6 D16C 7D               4      LD  A,L
000BF7 D16D D601             7      SUB 001H
       D16F                     FENDX:
000BF9 D16F 9F               4      SBC A,A
000BFA D170 E603             7      AND 3
000BFC D172 1F               4      RRA
000BFD D173 18AB            12      JR  FENDE
                                
       D175                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000BFF D175 CD4DD8          17      CALL    SETDRV
000C02 D178 CD10E0          17      CALL    INIT_SEQ
       D17B                     SWRITE:
000C05 D17B CDDDDF          17      CALL    RB_WRITE
                                
000C08 D17E C6FF             7      ADD A,0FFH
000C0A D180 18ED            12      JR  FENDX
                                
       D182                     _SYS17:     ;(BDOS)ファイル名の変更
000C0C D182 CD4DD8          17      CALL    SETDRV
000C0F D185 CD2ADB          17      CALL    NAME
000C12 D188 18D3            12      JR  FEND13
                                
       D18A                     _SYS16:     ;(BDOS)ファイルの作成
000C14 D18A CD4DD8          17      CALL    SETDRV
                                
000C17 D18D CD9CDB          17      CALL    CHKWILDX
000C1A D190 38CB            12      JR  C,FEND13
000C1C D192 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000C1F D195 FE05             7      CP  5
000C21 D197 2805            12      JR  Z,_S16X2
000C23 D199 FE21             7      CP  021H
000C25 D19B DA5DD1          10      JP  C,FEND13
       D19E                     _S16X2:
                                ;               Clear FCB
000C28 D19E FDE5            15      PUSH    IY
000C2A D1A0 E1              10      POP HL
000C2B D1A1 011000          10      LD  BC,16
000C2E D1A4 09              11      ADD HL,BC
       D1A5                     _S16X1:
000C2F D1A5 70               7      LD  (HL),B      ;B=0
000C30 D1A6 23               6      INC HL
000C31 D1A7 0D               4      DEC C
000C32 D1A8 20FB            12      JR  NZ,_S16X1
                                
000C34 D1AA CD9DDC          17      CALL    SETTMSX
000C37 D1AD FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000C3B D1B1 CD77D8          17      CALL    SOPENX
000C3E D1B4 3F               4      CCF
000C3F D1B5 CC30D1          17      CALL    Z,_S16K
000C42 D1B8 D456D9          17      CALL    NC,COPEN
000C45 D1BB D4ACDB          17      CALL    NC,SDIRENT
000C48 D1BE C352D0          10      JP  _S16XX
                                
       D1C1                     _SYS21:     ;(BDOS)ランダムな読み出し
000C4B D1C1 CD4DD8          17      CALL    SETDRV
000C4E D1C4 CDE8DC          17      CALL    INIT_RND
000C51 D1C7 189C            12      JR  SREAD
                                
       D1C9                     _SYS22:     ;(BDOS)ランダムな書き込み
       D1C9                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000C53 D1C9 CD4DD8          17      CALL    SETDRV
000C56 D1CC CDE8DC          17      CALL    INIT_RND
000C59 D1CF 18AA            12      JR  SWRITE
                                
       D1D1                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000C5B D1D1 21FF00          10      LD  HL,000FFH
000C5E D1D4 AF               4      XOR A
000C5F D1D5 C9              10      RET
                                
       D1D6                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000C60 D1D6 3A0400          13      LD  A,(_DVSW)   ;from LDOS
000C63 D1D9 A7               4      AND A
000C64 D1DA C9              10      RET
                                
       D1DB                     _SYS1A:     ;(BDOS)DTAの設定
000C65 D1DB ED538AE6        20      LD  (_DTA),DE
000C69 D1DF AF               4      XOR A
000C6A D1E0 C9              10      RET
                                
       D1E1                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000C6B D1E1 7B               4      LD  A,E
000C6C D1E2 CD5BD8          17      CALL    GETDRV
000C6F D1E5 CDDCE6          17      CALL    _GETDPB
000C72 D1E8 D4E2E6          17      CALL    NC,_RDFATX
000C75 D1EB 210000          10      LD  HL,0
000C78 D1EE D476DC          17      CALL    NC,DSKF
                                
000C7B D1F1 ED5B77DC        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000C7F D1F5 1B               6      DEC DE      ;DE←クラスタの総数
000C80 D1F6 FD2A7CE7        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000C84 D1FA 9F               4      SBC A,A
000C85 D1FB D8              11      RET C
000C86 D1FC 4F               4      LD  C,A     ;C=0
000C87 D1FD DD7E0F          19      LD  A,(IX+DPB_BPS)
000C8A D200 E607             7      AND 7
000C8C D202 47               4      LD  B,A
000C8D D203 DD7E07          19      LD  A,(IX+DPB_SECPCL)
000C90 D206 C9              10      RET
                                
       D207                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000C91 D207 AF               4      XOR A
000C92 D208 67               4      LD  H,A
000C93 D209 6F               4      LD  L,A
000C94 D20A C9              10      RET
                                
       D20B                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000C95 D20B 2100E8          10      LD  HL,_DEVICE
000C98 D20E 7B               4      LD  A,E
000C99 D20F C3DCE6          10      JP  _GETDPB
                                
       D212                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000C9C D212 E5              11      PUSH    HL
000C9D D213 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000C9F D215 CDD7CF          17      CALL    BDOS0
000CA2 D218 381B            12      JR  C,_S23X1
                                
000CA4 D21A D5              11      PUSH    DE      ;EX DE,IY
000CA5 D21B FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000CA7 D21D FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000CAA D220 FD6E11          19      LD  L,(IY+17)   ;
000CAD D223 FD6612          19      LD  H,(IY+18)   ;
000CB0 D226 C5              11      PUSH    BC      ;
000CB1 D227 FD4613          19      LD  B,(IY+19)   ;
000CB4 D22A CDDADC          17      CALL    GET_CPM_R_SIZE
000CB7 D22D C1              10      POP BC
       D22E                     _S24X1:
000CB8 D22E CDFADC          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000CBB D231 FDE3            23      EX  (SP),IY     ;
000CBD D233 D1              10      POP DE      ;
                                
000CBE D234 AF               4      XOR A
       D235                     _S23X1:
000CBF D235 E1              10      POP HL
000CC0 D236 C9              10      RET
                                
       D237                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000CC1 D237 E5              11      PUSH    HL
000CC2 D238 D5              11      PUSH    DE      ;EX DE,IY
000CC3 D239 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000CC5 D23B CD18E0          17      CALL    GETSEQ
000CC8 D23E 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D240                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000CCA D240 2B               6      DEC HL
       D241                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000CCB D241 C5              11      PUSH    BC
000CCC D242 E5              11      PUSH    HL
000CCD D243 CD65D7          17      CALL    FILE
000CD0 D246 E1              10      POP HL
000CD1 D247 C1              10      POP BC
       D248                     S29X1:
000CD2 D248 C5              11      PUSH    BC
000CD3 D249 D5              11      PUSH    DE
000CD4 D24A E5              11      PUSH    HL
000CD5 D24B EB               4      EX  DE,HL
000CD6 D24C AF               4      XOR A
000CD7 D24D 3221E6          13      LD  (FDRV+13),A
000CDA D250 2114E6          10      LD  HL,FDRV
000CDD D253 011000          10      LD  BC,16
000CE0 D256 EDB0                    LDIR
000CE2 D258 E1              10      POP HL
000CE3 D259 D1              10      POP DE
000CE4 D25A C1              10      POP BC
000CE5 D25B C9              10      RET
                                
       D25C                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000CE6 D25C C5              11      PUSH    BC
000CE7 D25D 015CE3          10      LD  BC,DWT24B
000CEA D260 1804            12      JR  S2FX
       D262                     _SYS2F:
000CEC D262 C5              11      PUSH    BC
000CED D263 014EE3          10      LD  BC,DRD24B
       D266                     S2FX:
000CF0 D266 ED437CD2        20      LD  (S2F_SWC),BC
000CF4 D26A CDDFE6          17      CALL    _FFLUSH
                                
000CF7 D26D D5              11      PUSH    DE
000CF8 D26E E5              11      PUSH    HL
000CF9 D26F 7D               4      LD  A,L     ;Drive
000CFA D270 CDD9E6          17      CALL    _CHGDRV
000CFD D273 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
000CFF D275 44               4      LD  B,H     ;Number of clusters
000D00 D276 2A8AE6          16      LD  HL,(_DTA)
                                
000D03 D279 0E00             7      LD  C,0
000D05 D27B CD4EE3          17      CALL    DRD24B
       D27C                     S2F_SWC EQU $-2
       D27E                     POP_HL_DE_BC_SBCAA_RET:
000D08 D27E E1              10      POP HL
000D09 D27F D1              10      POP DE
000D0A D280 C1              10      POP BC
000D0B D281 9F               4      SBC A,A
000D0C D282 C9              10      RET
                                
       D283                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000D0D D283 C5              11      PUSH    BC
000D0E D284 D5              11      PUSH    DE
000D0F D285 E5              11      PUSH    HL
000D10 D286 CD5AD7          17      CALL    FILEC
000D13 D289 217ED2          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
000D16 D28C E5              11      PUSH    HL
000D17 D28D 3A21E6          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
000D1A D290 E610             7      AND 010H        ;ディレクトリ
000D1C D292 37               4      SCF
000D1D D293 C8              11      RET Z
000D1E D294 1114E6          10      LD  DE,FDRV
000D21 D297 2A4EE7          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       D29A                     JPHL:
000D24 D29A E9               4      JP  (HL)
                                
       D29B                     SHOW_ERROR:         ;(9)
000D25 D29B 1179E6          10      LD  DE,COMERM
000D28 D29E CD08D0          17      CALL    _SYS09      ;(BDOS)文字列出力
000D2B D2A1 C300E6          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "MSXIO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MSX
                                
       D006                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D006                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D006                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D006                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D006                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D006                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       0000                     CTRL00  EQU 0
       0000                     CTRL03  EQU 0
       0000                     CTRL04  EQU 0
       0000                     CTRL05  EQU 0
       0000                     CTRL06  EQU 0
       0000                     CTRL07  EQU 0
       0000                     CTRL08  EQU 0
       0000                     CTRL09  EQU 0
       0000                     CTRL0A  EQU 0
       0000                     CTRL0B  EQU 0
       0000                     CTRL0C  EQU 0
       0000                     CTRL0D  EQU 0
       0000                     CTRL0E  EQU 0
       0000                     CTRL12  EQU 0
       0000                     CTRL1B  EQU 0
       0000                     CTRL1C  EQU 0
       0000                     CTRL1D  EQU 0
       0000                     CTRL1E  EQU 0
       0000                     CTRL1F  EQU 0
                                
       D2A4                     PRINT:
000D2E D2A4 7B               4      LD  A,E
000D2F D2A5 1803            12      JR  MSG_A
                                
       D2A7                     _SYS01:     ;(BDOS)コンソール入力
000D31 D2A7 CD09E6          17      CALL    _SYS07
       D2AA                     MSG_A:
000D34 D2AA FE03             7      CP  3
000D36 D2AC 2814            12      JR  Z,MSG_BR
       D2AE                     MSGA1:
000D38 D2AE F5              11      PUSH    AF
000D39 D2AF C5              11      PUSH    BC
000D3A D2B0 D5              11      PUSH    DE
000D3B D2B1 E5              11      PUSH    HL
000D3C D2B2 DDE5            15      PUSH    IX
000D3E D2B4 DD21A200        14      LD  IX,CHPUT
000D42 D2B8 CD1DD5          17      CALL    CALSLT_R
000D45 D2BB DDE1            14      POP IX
000D47 D2BD E1              10      POP HL
000D48 D2BE D1              10      POP DE
000D49 D2BF C1              10      POP BC
       D2C0                     MSGA2:
000D4A D2C0 F1              10      POP AF
000D4B D2C1 C9              10      RET
       D2C2                     MSG_BR:
000D4C D2C2 F5              11      PUSH    AF
000D4D D2C3 3ADDF3          13      LD  A,(CSRX)
000D50 D2C6 FE02             7      CP  2
000D52 D2C8 38F6            12      JR  C,MSGA2
000D54 D2CA F1              10      POP AF
       D2CB                     MSG_CR:
000D55 D2CB F5              11      PUSH    AF
000D56 D2CC 3E0D             7      LD  A,00DH
000D58 D2CE CDAED2          17      CALL    MSGA1
000D5B D2D1 3E0A             7      LD  A,00AH
000D5D D2D3 CDAED2          17      CALL    MSGA1
000D60 D2D6 F1              10      POP AF
000D61 D2D7 C9              10      RET
                                
       D2D8                     _SYS02:     ;(BDOS)コンソール出力
000D62 D2D8 CDF4D2          17      CALL    BREAK
000D65 D2DB C3CDE6          10      JP  _PRINT
                                
       D2DE                     _SYS06:     ;(BDOS)コンソール直接入出力
000D68 D2DE 7B               4      LD  A,E
000D69 D2DF 3C               4      INC A
000D6A D2E0 CACAE6          10      JP  Z,_INKEY
000D6D D2E3 C3CDE6          10      JP  _PRINT
                                
       D2E6                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000D70 D2E6 CD09E6          17      CALL    _SYS07
000D73 D2E9 FE03             7      CP  3
000D75 D2EB CCF4E6          17      CALL    Z,_BREAK
000D78 D2EE FE13             7      CP  013H        ;CTRL+S
000D7A D2F0 C0              11      RET NZ
       D2F1                     PAUSE:
000D7B D2F1 CD0BD3          17      CALL    KEYBC
                                
       D2F4                     BREAK:
000D7E D2F4 F5              11      PUSH    AF
000D7F D2F5 C5              11      PUSH    BC
000D80 D2F6 D5              11      PUSH    DE
000D81 D2F7 E5              11      PUSH    HL
000D82 D2F8 DDE5            15      PUSH    IX
000D84 D2FA DD21B700        14      LD  IX,BREAKX
000D88 D2FE CD1DD5          17      CALL    CALSLT_R
000D8B D301 DDE1            14      POP IX
000D8D D303 E1              10      POP HL
000D8E D304 D1              10      POP DE
000D8F D305 C1              10      POP BC
000D90 D306 DCF4E6          17      CALL    C,_BREAK
000D93 D309 F1              10      POP AF
000D94 D30A C9              10      RET
       D30B                     KEYBC:
000D95 D30B F5              11      PUSH    AF
000D96 D30C C5              11      PUSH    BC
000D97 D30D D5              11      PUSH    DE
000D98 D30E E5              11      PUSH    HL
000D99 D30F DDE5            15      PUSH    IX
000D9B D311 DD215601        14      LD  IX,KILBUF
000D9F D315 CD1DD5          17      CALL    CALSLT_R
000DA2 D318 DDE1            14      POP IX
000DA4 D31A E1              10      POP HL
000DA5 D31B D1              10      POP DE
000DA6 D31C C1              10      POP BC
000DA7 D31D F1              10      POP AF
000DA8 D31E C9              10      RET
       D31F                     FLGET:
000DA9 D31F C5              11      PUSH    BC
000DAA D320 D5              11      PUSH    DE
000DAB D321 E5              11      PUSH    HL
000DAC D322 DDE5            15      PUSH    IX
000DAE D324 CDDFE6          17      CALL    _FFLUSH
000DB1 D327 181B            12      JR  FLGET1
       D328                     CBIOS_SWC1  EQU $-1
000DB3 D329 CD05D5          17      CALL    GETVRAM
                                
000DB6 D32C E5              11      PUSH    HL
000DB7 D32D DD214A00        14      LD  IX,RDVRM
000DBB D331 CD1DD5          17      CALL    CALSLT_R
000DBE D334 E1              10      POP HL
000DBF D335 3250D3          13      LD  (SWCCHR),A
                                
000DC2 D338 E5              11      PUSH    HL
000DC3 D339 3EFF             7      LD  A,0FFH
000DC5 D33B DD214D00        14      LD  IX,WRTVRM
000DC9 D33F CD1DD5          17      CALL    CALSLT_R
000DCC D342 E1              10      POP HL
                                
000DCD D343 E5              11      PUSH    HL
       D344                     FLGET1:
000DCE D344 DD219F00        14      LD  IX,CHGET
000DD2 D348 CD1DD5          17      CALL    CALSLT_R
000DD5 D34B 180C            12      JR  FLGET2
       D34C                     CBIOS_SWC2  EQU $-1
000DD7 D34D E1              10      POP HL
                                
000DD8 D34E F5              11      PUSH    AF
000DD9 D34F 3E00             7      LD  A,0
       D350                     SWCCHR  EQU $-1
000DDB D351 DD214D00        14      LD  IX,WRTVRM
000DDF D355 CD1DD5          17      CALL    CALSLT_R
000DE2 D358 F1              10      POP AF
       D359                     FLGET2:
000DE3 D359 DDE1            14      POP IX
000DE5 D35B E1              10      POP HL
000DE6 D35C D1              10      POP DE
000DE7 D35D C1              10      POP BC
000DE8 D35E FE03             7      CP  3
000DEA D360 C0              11      RET NZ
000DEB D361 C300E6          10      JP  CPM_BOOT
                                
       D364                     INKEY:
000DEE D364 CD06E6          17      CALL    CPM_CONST
000DF1 D367 C8              11      RET Z
000DF2 D368 18B5            12      JR  FLGET
                                
       D36A                     _SYS0A:     ;(BDOS)文字列入力
000DF4 D36A C5              11      PUSH    BC
000DF5 D36B E5              11      PUSH    HL
000DF6 D36C D5              11      PUSH    DE
000DF7 D36D CD96D3          17      CALL    GETL
000DFA D370 111FF4          10      LD  DE,KBUF
000DFD D373 E1              10      POP HL
000DFE D374 E5              11      PUSH    HL
000DFF D375 0E00             7      LD  C,0
000E01 D377 3004            12      JR  NC,SAX0
000E03 D379 23               6      INC HL
000E04 D37A 23               6      INC HL
000E05 D37B 1808            12      JR  SAX4
       D37D                     SAX0:
000E07 D37D 46               7      LD  B,(HL)
000E08 D37E 23               6      INC HL
       D37F                     SAX1:
000E09 D37F 23               6      INC HL
000E0A D380 1A               7      LD  A,(DE)
000E0B D381 13               6      INC DE
000E0C D382 B7               4      OR  A
000E0D D383 2004            12      JR  NZ,SAX2
       D385                     SAX4:
000E0F D385 360D            10      LD  (HL),00DH
000E11 D387 1804            12      JR  SAX3
       D389                     SAX2:
000E13 D389 77               7      LD  (HL),A
000E14 D38A 0C               4      INC C
000E15 D38B 10F2            13      DJNZ    SAX1
       D38D                     SAX3:
000E17 D38D D1              10      POP DE
000E18 D38E 79               4      LD  A,C
000E19 D38F 13               6      INC DE
000E1A D390 12               7      LD  (DE),A
000E1B D391 1B               6      DEC DE
000E1C D392 E1              10      POP HL
000E1D D393 C1              10      POP BC
000E1E D394 A7               4      AND A
000E1F D395 C9              10      RET
       D396                     GETL:
000E20 D396 DDE5            15      PUSH    IX
000E22 D398 FDE5            15      PUSH    IY
                                
000E24 D39A 2ADCF3          16      LD  HL,(CSRY)
000E27 D39D 22CAFB          16      LD  (FSTPOS),HL
       D3A0                     GETL1:
000E2A D3A0 CDE6D2          17      CALL    _SYS08
000E2D D3A3 FE09             7      CP  9
000E2F D3A5 2008            12      JR  NZ,GETL1V
000E31 D3A7 211FF4          10      LD  HL,KBUF
000E34 D3AA CD17D0          17      CALL    MSX
000E37 D3AD 18F1            12      JR  GETL1
       D3AF                     GETL1V:
000E39 D3AF 5F               4      LD  E,A
000E3A D3B0 FE08             7      CP  8
000E3C D3B2 CCABD4          17      CALL    Z,CTRL02
000E3F D3B5 FE20             7      CP  020H
000E41 D3B7 D4D7D4          17      CALL    NC,INSERT
000E44 D3BA CDAED2          17      CALL    MSGA1
                                
000E47 D3BD 7B               4      LD  A,E
000E48 D3BE FE0D             7      CP  00DH
000E4A D3C0 20DE            12      JR  NZ,GETL1
                                
000E4C D3C2 111FF4          10      LD  DE,KBUF
000E4F D3C5 3AB0F3          13      LD  A,(LINLEN)
000E52 D3C8 47               4      LD  B,A
000E53 D3C9 CDBBCE          17      CALL    ZERO_MEMORY_DE
                                
000E56 D3CC 2ACAFB          16      LD  HL,(FSTPOS)
000E59 D3CF 3ADCF3          13      LD  A,(CSRY)
000E5C D3D2 6F               4      LD  L,A
000E5D D3D3 E5              11      PUSH    HL
000E5E D3D4 CD08D5          17      CALL    LOC0
000E61 D3D7 4D               4      LD  C,L
000E62 D3D8 44               4      LD  B,H
000E63 D3D9 E1              10      POP HL
000E64 D3DA 3AB0F3          13      LD  A,(LINLEN)
000E67 D3DD 94               4      SUB H
000E68 D3DE 3D               4      DEC A
000E69 D3DF 5F               4      LD  E,A
000E6A D3E0 211FF4          10      LD  HL,KBUF
       D3E3                     GETL2:
000E6D D3E3 CDD0E6          17      CALL    _SCRN
000E70 D3E6 03               6      INC BC
000E71 D3E7 77               7      LD  (HL),A
000E72 D3E8 23               6      INC HL
000E73 D3E9 1D               4      DEC E
000E74 D3EA 20F7            12      JR  NZ,GETL2
000E76 D3EC CDCBD2          17      CALL    MSG_CR
                                
000E79 D3EF FDE1            14      POP IY
000E7B D3F1 DDE1            14      POP IX
       D3F3                     GETL3:
000E7D D3F3 2B               6      DEC HL
000E7E D3F4 7E               7      LD  A,(HL)
000E7F D3F5 FE21             7      CP  021H
000E81 D3F7 D0              11      RET NC
000E82 D3F8 3600            10      LD  (HL),0
000E84 D3FA 15               4      DEC D
000E85 D3FB 20F6            12      JR  NZ,GETL3
000E87 D3FD C9              10      RET
                                
       D3FE                     _SYS0B:     ;(BDOS)コンソール状態のチェック
       D3FE                     CONSTX:
000E88 D3FE C5              11      PUSH    BC
000E89 D3FF D5              11      PUSH    DE
000E8A D400 E5              11      PUSH    HL
000E8B D401 DDE5            15      PUSH    IX
000E8D D403 DD219C00        14      LD  IX,CHSNS
000E91 D407 CD1DD5          17      CALL    CALSLT_R
000E94 D40A DDE1            14      POP IX
000E96 D40C E1              10      POP HL
000E97 D40D D1              10      POP DE
000E98 D40E C1              10      POP BC
000E99 D40F C9              10      RET
                                
       D410                     _SYS2A:     ;(BDOS)日付の獲得
000E9A D410 0E0B             7      LD  C,11        ;年/Year→HL
000E9C D412 CD51D4          17      CALL    RDCLK_BCD
000E9F D415 6F               4      LD  L,A
000EA0 D416 2600             7      LD  H,0
000EA2 D418 3AF8FA          13      LD  A,(EXBRSA)
000EA5 D41B B7               4      OR  A
000EA6 D41C 2804            12      JR  Z,SX2A1
000EA8 D41E 11BC07          10      LD  DE,1980     ;1980年～2079年
000EAB D421 19              11      ADD HL,DE
       D422                     SX2A1:
000EAC D422 0E09             7      LD  C,9     ;月/Month→D
000EAE D424 CD51D4          17      CALL    RDCLK_BCD
000EB1 D427 57               4      LD  D,A
                                
000EB2 D428 0E07             7      LD  C,7     ;日/Day→E
000EB4 D42A CD51D4          17      CALL    RDCLK_BCD
000EB7 D42D 5F               4      LD  E,A
                                
000EB8 D42E 0E06             7      LD  C,6     ;曜日/Week→A
       D430                     RDCLK:
000EBA D430 DDE5            15      PUSH    IX
000EBC D432 DD21F501        14      LD  IX,REDCLK
       D436                     WRCLK1:
000EC0 D436 3AF8FA          13      LD  A,(EXBRSA)
000EC3 D439 B7               4      OR  A
000EC4 D43A 280A            12      JR  Z,RDCLK1    ;MSX1
000EC6 D43C FDE5            15      PUSH    IY
000EC8 D43E FD67             9      LD  IYH,A
000ECA D440 78               4      LD  A,B
000ECB D441 CD39D5          17      CALL    CALSLTR
000ECE D444 FDE1            14      POP IY
       D446                     RDCLK1:
000ED0 D446 DDE1            14      POP IX
000ED2 D448 C9              10      RET
       D449                     WRCLK:
000ED3 D449 DDE5            15      PUSH    IX
000ED5 D44B DD21F901        14      LD  IX,WRTCLK
000ED9 D44F 18E5            12      JR  WRCLK1
                                
       D451                     RDCLK_BCD:
000EDB D451 CD30D4          17      CALL    RDCLK       ;1の位
000EDE D454 47               4      LD  B,A
000EDF D455 0C               4      INC C
000EE0 D456 CD30D4          17      CALL    RDCLK       ;10の位
000EE3 D459 87               4      ADD A,A     ;*2
000EE4 D45A 4F               4      LD  C,A
000EE5 D45B 87               4      ADD A,A     ;*4
000EE6 D45C 87               4      ADD A,A     ;*8
000EE7 D45D 81               4      ADD A,C     ;*10(8+2)
000EE8 D45E 80               4      ADD A,B     ;1の位
000EE9 D45F C9              10      RET
                                
       D460                     _SYS2C:     ;(BDOS)時刻の獲得
000EEA D460 011501          10      LD  BC,00115H       ;12時間計/24時間計の設定を24時間計に
000EED D463 CD49D4          17      CALL    WRCLK
000EF0 D466 0E04             7      LD  C,4     ;H=時/Hour
000EF2 D468 CD51D4          17      CALL    RDCLK_BCD
000EF5 D46B 67               4      LD  H,A
000EF6 D46C 0E02             7      LD  C,2     ;L=分/Minute
000EF8 D46E CD51D4          17      CALL    RDCLK_BCD
000EFB D471 6F               4      LD  L,A
000EFC D472 0E00             7      LD  C,0     ;D=秒/Second
000EFE D474 CD51D4          17      CALL    RDCLK_BCD
000F01 D477 57               4      LD  D,A
000F02 D478 AF               4      XOR A       ;E=1/100秒
000F03 D479 5F               4      LD  E,A
000F04 D47A C9              10      RET
                                
       D47B                     POS:
000F05 D47B F5              11      PUSH    AF
000F06 D47C 2ADCF3          16      LD  HL,(CSRY)
000F09 D47F 7D               4      LD  A,L
000F0A D480 6C               4      LD  L,H
000F0B D481 67               4      LD  H,A
000F0C D482 2C               4      INC L
000F0D D483 24               4      INC H
000F0E D484 F1              10      POP AF
000F0F D485 C9              10      RET
                                
       D486                     LOC:
000F10 D486 F5              11      PUSH    AF
000F11 D487 E5              11      PUSH    HL
000F12 D488 7D               4      LD  A,L
000F13 D489 6C               4      LD  L,H
000F14 D48A 67               4      LD  H,A
000F15 D48B 2D               4      DEC L
000F16 D48C 25               4      DEC H
000F17 D48D DDE5            15      PUSH    IX
000F19 D48F DD21C600        14      LD  IX,POSIT
000F1D D493 CD1DD5          17      CALL    CALSLT_R
000F20 D496 DDE1            14      POP IX
000F22 D498 E1              10      POP HL
000F23 D499 F1              10      POP AF
000F24 D49A C9              10      RET
       D49B                     SCRN:
000F25 D49B E5              11      PUSH    HL
000F26 D49C DDE5            15      PUSH    IX
                                
000F28 D49E 69               4      LD  L,C
000F29 D49F 60               4      LD  H,B
000F2A D4A0 DD214A00        14      LD  IX,RDVRM
000F2E D4A4 CD1DD5          17      CALL    CALSLT_R
                                
000F31 D4A7 DDE1            14      POP IX
000F33 D4A9 E1              10      POP HL
000F34 D4AA C9              10      RET
                                
       D4AB                     CTRL02:
000F35 D4AB F5              11      PUSH    AF
000F36 D4AC D5              11      PUSH    DE
000F37 D4AD 2ADCF3          16      LD  HL,(CSRY)
000F3A D4B0 3AB0F3          13      LD  A,(LINLEN)
000F3D D4B3 4F               4      LD  C,A
000F3E D4B4 94               4      SUB H   ;CSRX
000F3F D4B5 C602             7      ADD A,2
000F41 D4B7 47               4      LD  B,A ;カーソルより右の文字数
000F42 D4B8 61               4      LD  H,C ;LINLEN
000F43 D4B9 C5              11      PUSH    BC
000F44 D4BA CD08D5          17      CALL    LOC0
000F47 D4BD C1              10      POP BC
                                
000F48 D4BE 1620             7      LD  D,020H
       D4C0                     C8X1:
000F4A D4C0 DD214A00        14      LD  IX,RDVRM
000F4E D4C4 CD1DD5          17      CALL    CALSLT_R
000F51 D4C7 4F               4      LD  C,A
000F52 D4C8 7A               4      LD  A,D
000F53 D4C9 DD214D00        14      LD  IX,WRTVRM
000F57 D4CD CD1DD5          17      CALL    CALSLT_R
000F5A D4D0 2B               6      DEC HL
000F5B D4D1 51               4      LD  D,C
000F5C D4D2 10EC            13      DJNZ    C8X1
000F5E D4D4 D1              10      POP DE
000F5F D4D5 F1              10      POP AF
000F60 D4D6 C9              10      RET
                                
       D4D7                     INSERT:
000F61 D4D7 F5              11      PUSH    AF
000F62 D4D8 D5              11      PUSH    DE
000F63 D4D9 2ADCF3          16      LD  HL,(CSRY)
000F66 D4DC 3AB0F3          13      LD  A,(LINLEN)
000F69 D4DF 4F               4      LD  C,A
000F6A D4E0 94               4      SUB H   ;CSRX
000F6B D4E1 3C               4      INC A
000F6C D4E2 47               4      LD  B,A ;カーソルより右の文字数
000F6D D4E3 C5              11      PUSH    BC
000F6E D4E4 CD08D5          17      CALL    LOC0
000F71 D4E7 C1              10      POP BC
                                
000F72 D4E8 1620             7      LD  D,020H
       D4EA                     INS1:
000F74 D4EA DD214A00        14      LD  IX,RDVRM
000F78 D4EE CD1DD5          17      CALL    CALSLT_R
000F7B D4F1 4F               4      LD  C,A
000F7C D4F2 7A               4      LD  A,D
000F7D D4F3 DD214D00        14      LD  IX,WRTVRM
000F81 D4F7 CD1DD5          17      CALL    CALSLT_R
000F84 D4FA 23               6      INC HL
000F85 D4FB 51               4      LD  D,C
000F86 D4FC 10EC            13      DJNZ    INS1
000F88 D4FE D1              10      POP DE
000F89 D4FF F1              10      POP AF
000F8A D500 C9              10      RET
                                
       D501                     CONOUT1:
000F8B D501 59               4      LD  E,C
000F8C D502 C3CDE6          10      JP  _PRINT
                                
       D505                     GETVRAM:
000F8F D505 2ADCF3          16      LD  HL,(CSRY)
       D508                     LOC0:
000F92 D508 2D               4      DEC L
000F93 D509 25               4      DEC H
000F94 D50A 4C               4      LD  C,H ;CSRX-1
000F95 D50B 5D               4      LD  E,L ;CSRY-1
       D50C                     LOC1:
000F96 D50C 3AB0F3          13      LD  A,(LINLEN)
000F99 D50F 67               4      LD  H,A
000F9A D510 1600             7      LD  D,0
000F9C D512 6A               4      LD  L,D ;0
000F9D D513 0608             7      LD  B,8
       D515                     LOC2:
000F9F D515 29              11      ADD HL,HL
000FA0 D516 3001            12      JR  NC,LOC3
000FA2 D518 19              11      ADD HL,DE
       D519                     LOC3:
000FA3 D519 10FA            13      DJNZ    LOC2
000FA5 D51B 09              11      ADD HL,BC
000FA6 D51C C9              10      RET
                                
       D51D                     CALSLT_R:
000FA7 D51D FDE5            15      PUSH    IY
000FA9 D51F FD2AC0FC        20      LD  IY,(EXPTBL-1)   ;メインROMスロット
000FAD D523 CD39D5          17      CALL    CALSLTR
000FB0 D526 FDE1            14      POP IY
000FB2 D528 C9              10      RET
                                
       D529                     CALLF:
000FB3 D529 08               4      EX  AF,AF'
000FB4 D52A E3              19      EX  (SP),HL
000FB5 D52B 7E               7      LD  A,(HL)
000FB6 D52C FD67             9      LD  IYH,A
000FB8 D52E 23               6      INC HL
000FB9 D52F 7E               7      LD  A,(HL)
000FBA D530 DD6F             9      LD  IXL,A
000FBC D532 23               6      INC HL
000FBD D533 7E               7      LD  A,(HL)
000FBE D534 DD67             9      LD  IXH,A
000FC0 D536 23               6      INC HL
000FC1 D537 E3              19      EX  (SP),HL
000FC2 D538 08               4      EX  AF,AF'
       D539                     CALSLTR:
000FC3 D539 F3               4      DI
000FC4 D53A ED7373D5        20      LD  (CSSP),SP
000FC8 D53E F5              11      PUSH    AF
000FC9 D53F 3E1C             7      LD  A,_CALSLT
       D541                     SLTCALL:
000FCB D541 3260D5          13      LD  (SLTCALLX),A
000FCE D544 3A74D5          13      LD  A,(CSSP+1)
000FD1 D547 FE41             7      CP  040H+1
000FD3 D549 3005            12      JR  NC,CALSLTR1
000FD5 D54B F1              10      POP AF
000FD6 D54C 315EF5          10      LD  SP,BUF
000FD9 D54F F5              11      PUSH    AF
       D550                     CALSLTR1:
000FDA D550 C5              11      PUSH    BC
000FDB D551 D5              11      PUSH    DE
000FDC D552 E5              11      PUSH    HL
000FDD D553 2600             7      LD  H,0
000FDF D555 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
000FE2 D558 CD77D6          17      CALL    ENASLT
000FE5 D55B E1              10      POP HL
000FE6 D55C D1              10      POP DE
000FE7 D55D C1              10      POP BC
000FE8 D55E F1              10      POP AF
000FE9 D55F CD1C00          17      CALL    _CALSLT
       D560                     SLTCALLX    EQU $-2
000FEC D562 F5              11      PUSH    AF
000FED D563 C5              11      PUSH    BC
000FEE D564 D5              11      PUSH    DE
000FEF D565 E5              11      PUSH    HL
000FF0 D566 2600             7      LD  H,0
000FF2 D568 3A41F3          13      LD  A,(0F341H)  ;メインRAMに戻す
000FF5 D56B CD77D6          17      CALL    ENASLT
000FF8 D56E E1              10      POP HL
000FF9 D56F D1              10      POP DE
000FFA D570 C1              10      POP BC
000FFB D571 F1              10      POP AF
000FFC D572 310000          10      LD  SP,0
       D573                     CSSP    EQU $-2
000FFF D575 FB               4      EI
001000 D576 C9              10      RET
                                
       D577                     RDSLTR:
001001 D577 ED7373D5        20      LD  (CSSP),SP
001005 D57B F5              11      PUSH    AF
001006 D57C 3E0C             7      LD  A,_RDSLT
001008 D57E 18C1            12      JR  SLTCALL
                                
       D580                     WRSLTR:
00100A D580 ED7373D5        20      LD  (CSSP),SP
00100E D584 F5              11      PUSH    AF
00100F D585 3E14             7      LD  A,_WRSLT
001011 D587 18B8            12      JR  SLTCALL
                                
       D589                     INT38H:
001013 D589 F5              11      PUSH    AF
001014 D58A E5              11      PUSH    HL          ;メインROMを呼び出すのでスタックが被っていないかチェック
001015 D58B 2AB5D5          16      LD  HL,(INTSP)
001018 D58E 7C               4      LD  A,H
001019 D58F B5               4      OR  L
00101A D590 202D            12      JR  NZ,INT38H2
00101C D592 C5              11      PUSH    BC
00101D D593 D5              11      PUSH    DE
00101E D594 2100BF          10      LD  HL,010000H-04100H   ;Page1
001021 D597 39              11      ADD HL,SP
001022 D598 ED73B5D5        20      LD  (INTSP),SP
001026 D59C 3803            12      JR  C,INT38H1
001028 D59E 315EF5          10      LD  SP,BUF
       D5A1                     INT38H1:
00102B D5A1 2600             7      LD  H,0
00102D D5A3 3AC1FC          13      LD  A,(EXPTBL)  ;メインROMに切り替える
001030 D5A6 CD77D6          17      CALL    ENASLT
001033 D5A9 CD3800          17      CALL    00038H
001036 D5AC 2600             7      LD  H,0
001038 D5AE 3A41F3          13      LD  A,(0F341H)  ;メインRAMに戻す
00103B D5B1 CD77D6          17      CALL    ENASLT
00103E D5B4 310000          10      LD  SP,0
       D5B5                     INTSP   EQU $-2
001041 D5B7 210000          10      LD  HL,0
001044 D5BA 22B5D5          16      LD  (INTSP),HL
001047 D5BD D1              10      POP DE
001048 D5BE C1              10      POP BC
       D5BF                     INT38H2:
001049 D5BF E1              10      POP HL
00104A D5C0 F1              10      POP AF
00104B D5C1 FB               4      EI
00104C D5C2 C9              10      RET
                                
[EOF:MSXIO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       D75A                     FILEC:
0011E4 D75A CD65D7          17      CALL    FILE
       D75D                     FILEC2:
0011E7 D75D 3A15E6          13      LD  A,(FDRV+1)
0011EA D760 FE20             7      CP  020H
0011EC D762 C8              11      RET Z
0011ED D763 1839            12      JR  SETDIR1
                                
       D765                     FILE:
0011EF D765 AF               4      XOR A
0011F0 D766 3214E6          13      LD  (FDRV),A
0011F3 D769 67               4      LD  H,A
0011F4 D76A 6F               4      LD  L,A
0011F5 D76B 2222E6          16      LD  (FDRV+14),HL
0011F8 D76E CD3BD8          17      CALL    SPCUT
0011FB D771 CD20D8          17      CALL    CCHK3
0011FE D774 2812            12      JR  Z,DEVI1
001200 D776 13               6      INC DE
001201 D777 1A               7      LD  A,(DE)
001202 D778 1B               6      DEC DE
001203 D779 FE3A             7      CP  ':'
001205 D77B 200B            12      JR  NZ,DEVI1
001207 D77D 1A               7      LD  A,(DE)      ;DRIVE
001208 D77E CD81DA          17      CALL    CAP
00120B D781 D640             7      SUB '@'
00120D D783 13               6      INC DE
00120E D784 13               6      INC DE
00120F D785 3214E6          13      LD  (FDRV),A
       D788                     DEVI1:
001212 D788 1A               7      LD  A,(DE)
001213 D789 D65C             7      SUB 05CH        ;\
001215 D78B 2009            12      JR  NZ,NOROOT
001217 D78D 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
001218 D78E 222EE6          16      LD  (FDRV+26),HL
00121B D791 2C               4      INC L
00121C D792 2222E6          16      LD  (FDRV+14),HL
00121F D795 13               6      INC DE
       D796                     NOROOT:
                                
       D796                     SETDIR:
001220 D796 CDC1D7          17      CALL    FILED
001223 D799 1A               7      LD  A,(DE)
001224 D79A FE5C             7      CP  05CH        ;\
001226 D79C C0              11      RET NZ
001227 D79D 13               6      INC DE
       D79E                     SETDIR1:
001228 D79E 3E10             7      LD  A,010H      ;Directory
00122A D7A0 3221E6          13      LD  (FDRV+13),A
00122D D7A3 D5              11      PUSH    DE
00122E D7A4 1114E6          10      LD  DE,FDRV
001231 D7A7 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
001233 D7A9 CDD7CF          17      CALL    BDOS0
001236 D7AC D1              10      POP DE
001237 D7AD B7               4      OR  A
001238 D7AE C0              11      RET NZ
                                
001239 D7AF 3A21E6          13      LD  A,(FDRV+13)
00123C D7B2 E610             7      AND 010H        ;ディレクトリ
00123E D7B4 C8              11      RET Z
                                
00123F D7B5 CD08D8          17      CALL    FILEI
001242 D7B8 2A2EE6          16      LD  HL,(FDRV+26)
001245 D7BB 23               6      INC HL
001246 D7BC 2222E6          16      LD  (FDRV+14),HL
001249 D7BF 18D5            12      JR  SETDIR
                                
       D7C1                     FILED:
00124B D7C1 CD08D8          17      CALL    FILEI
00124E D7C4 2115E6          10      LD  HL,FNAME
                                
001251 D7C7 0608             7      LD  B,8
       D7C9                     FILE2:
001253 D7C9 CD15D8          17      CALL    CCHKF
001256 D7CC C8              11      RET Z
001257 D7CD FE2A             7      CP  '*'
001259 D7CF 282E            12      JR  Z,FILE9
00125B D7D1 FE2E             7      CP  '.'
00125D D7D3 280C            12      JR  Z,FILE4
00125F D7D5 77               7      LD  (HL),A
001260 D7D6 23               6      INC HL
001261 D7D7 10F0            13      DJNZ    FILE2
                                
       D7D9                     FILE3:
001263 D7D9 CD15D8          17      CALL    CCHKF
001266 D7DC C8              11      RET Z
001267 D7DD FE2E             7      CP  '.'
001269 D7DF 20F8            12      JR  NZ,FILE3
                                
       D7E1                     FILE4:
00126B D7E1 211DE6          10      LD  HL,FNAME+8
00126E D7E4 0603             7      LD  B,3
                                
       D7E6                     FILE4L:
001270 D7E6 CD15D8          17      CALL    CCHKF
001273 D7E9 C8              11      RET Z
001274 D7EA FE2E             7      CP  '.'
001276 D7EC 2008            12      JR  NZ,FILE12
001278 D7EE 3215E6          13      LD  (FNAME),A   ;Parent directory(..)
00127B D7F1 3216E6          13      LD  (FNAME+1),A
00127E D7F4 3E20             7      LD  A,020H
       D7F6                     FILE12:
001280 D7F6 FE2A             7      CP  '*'
001282 D7F8 280A            12      JR  Z,FILE10
001284 D7FA 77               7      LD  (HL),A
001285 D7FB 23               6      INC HL
001286 D7FC 10E8            13      DJNZ    FILE4L
001288 D7FE C9              10      RET
                                
       D7FF                     FILE9:              ;名前の*処理、名前の残りを?で埋める
001289 D7FF CD04D8          17      CALL    FILE10
00128C D802 18D5            12      JR  FILE3
                                
       D804                     FILE10:
00128E D804 3E3F             7      LD  A,'?'
001290 D806 1808            12      JR  FILL_MEMORY
       D808                     FILEI:              ;名前＋拡張子をスペースで初期化
001292 D808 3E20             7      LD  A,020H
001294 D80A 01000B          10      LD  BC,11*256   ;C=0にしておく
001297 D80D 2115E6          10      LD  HL,FNAME
       D810                     FILL_MEMORY:            ;HLからBバイトAで埋める
00129A D810 77               7      LD  (HL),A
00129B D811 23               6      INC HL
00129C D812 10FC            13      DJNZ    FILL_MEMORY
00129E D814 C9              10      RET
                                
       D815                     CCHKF:
00129F D815 1A               7      LD  A,(DE)
0012A0 D816 CD1DD8          17      CALL    CCHK2
0012A3 D819 C8              11      RET Z
0012A4 D81A C389DB          10      JP  FKAN
                                
       D81D                     CCHK2:
0012A7 D81D 0C               4      INC C
0012A8 D81E 0D               4      DEC C
0012A9 D81F C0              11      RET NZ
       D820                     CCHK3:              ;ZF=1 で使えない文字
0012AA D820 FE2B             7      CP  '+'
0012AC D822 C8              11      RET Z
0012AD D823 FE2C             7      CP  ','
0012AF D825 C8              11      RET Z
0012B0 D826 FE2F             7      CP  '/'
0012B2 D828 C8              11      RET Z
0012B3 D829 FE3A             7      CP  ':'
0012B5 D82B C8              11      RET Z
0012B6 D82C FE3B             7      CP  ';'
0012B8 D82E C8              11      RET Z
0012B9 D82F FE3D             7      CP  '='
0012BB D831 C8              11      RET Z
0012BC D832 FE5C             7      CP  05CH    ;\
0012BE D834 C8              11      RET Z
0012BF D835 FE20             7      CP  020H
0012C1 D837 D0              11      RET NC
0012C2 D838 BF               4      CP  A       ;Z=1
0012C3 D839 C9              10      RET
                                
       D83A                     SS1:
0012C4 D83A 13               6      INC DE
       D83B                     SPCUT:              ;スペースをカット
0012C5 D83B 1A               7      LD  A,(DE)
0012C6 D83C FE20             7      CP  020H
0012C8 D83E 28FA            12      JR  Z,SS1
0012CA D840 C9              10      RET
                                
       D841                     SETDRVF:
0012CB D841 1114E6          10      LD  DE,FDRV
       D844                     SETDRV0:
0012CE D844 CD4DD8          17      CALL    SETDRV
0012D1 D847 FDE1            14      POP IY
0012D3 D849 C1              10      POP BC
0012D4 D84A D1              10      POP DE
0012D5 D84B E1              10      POP HL
0012D6 D84C C9              10      RET
                                
       D84D                     SETDRV:
0012D7 D84D E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
0012D8 D84E D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
0012D9 D84F C5              11      PUSH    BC
0012DA D850 1A               7      LD  A,(DE)
0012DB D851 D5              11      PUSH    DE
0012DC D852 FDE3            23      EX  (SP),IY
                                
0012DE D854 CD5BD8          17      CALL    GETDRV
0012E1 D857 CDD9E6          17      CALL    _CHGDRV
                                
0012E4 D85A E9               4      JP  (HL)
                                
       D85B                     GETDRV:
0012E5 D85B CD6ED8          17      CALL    GETDRV1
0012E8 D85E 3288E6          13      LD  (_DRV),A
0012EB D861 C9              10      RET
                                
       D862                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
0012EC D862 CD6ED8          17      CALL    GETDRV1
0012EF D865 C5              11      PUSH    BC
0012F0 D866 4F               4      LD  C,A
0012F1 D867 1A               7      LD  A,(DE)
0012F2 D868 CD6ED8          17      CALL    GETDRV1
0012F5 D86B A9               4      XOR C
0012F6 D86C C1              10      POP BC
0012F7 D86D C9              10      RET
       D86E                     GETDRV1:
0012F8 D86E E67F             7      AND 07FH
0012FA D870 D601             7      SUB 001H
0012FC D872 D0              11      RET NC
0012FD D873 3A0400          13      LD  A,(_DVSW)   ;Current Drive
001300 D876 C9              10      RET
                                
       D877                     SOPENX:
001301 D877 1139E6          10      LD  DE,SFILE
001304 D87A FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
001307 D87D CD62D8          17      CALL    IS_SAME_DRV_A_DE
00130A D880 2024            12      JR  NZ,SOPEN
00130C D882 13               6      INC DE
00130D D883 FDE5            15      PUSH    IY
00130F D885 E1              10      POP HL
001310 D886 23               6      INC HL
001311 D887 CD12DA          17      CALL    CPFILE
001314 D88A 201A            12      JR  NZ,SOPEN
                                
001316 D88C 2AF4E7          16      LD  HL,(SCDIR)
001319 D88F FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00131C D892 FD740F          19      LD  (IY+15),H
                                
00131F D895 2AF8E7          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
001322 D898 229FE6          16      LD  (_FILEN),HL
                                
001325 D89B ED5BF6E7        20      LD  DE,(SFBPS)
001329 D89F 2139E6          10      LD  HL,SFILE
00132C D8A2 36FF            10      LD  (HL),0FFH
00132E D8A4 23               6      INC HL
00132F D8A5 C9              10      RET
       D8A6                     SOPEN:
001330 D8A6 21BAD9          10      LD  HL,FILESE
       D8A9                     SOPENC:
001333 D8A9 22E2D8          16      LD  (OPENPAT),HL
                                
001336 D8AC CDE2E6          17      CALL    _RDFATX     ;Detect Media
001339 D8AF 3856            12      JR  C,RDDERR
                                
00133B D8B1 AF               4      XOR A
00133C D8B2 329FE6          13      LD  (_FILEN),A
00133F D8B5 CDBEDA          17      CALL    LDDIRX1     ;A=0で呼び出す
001342 D8B8 2818            12      JR  Z,SDIRX1
                                
001344 D8BA CDABD9          17      CALL    READ_DIR    ;Sub Directory
001347 D8BD 3808            12      JR  C,SDIRX0
001349 D8BF 2A7EE7          16      LD  HL,(_DTBUF)
00134C D8C2 7E               7      LD  A,(HL)
00134D D8C3 FE2E             7      CP  '.'
00134F D8C5 280F            12      JR  Z,SOPEN1
       D8C7                     SDIRX0:
001351 D8C7 AF               4      XOR A
001352 D8C8 32A0E6          13      LD  (_DIRF),A
001355 D8CB FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
001359 D8CF FD770F          19      LD  (IY+15),A
       D8D2                     SDIRX1:
00135C D8D2 ED5BFCE7        20      LD  DE,(_DIRPS) ;Root Directory
       D8D6                     SOPEN1:
001360 D8D6 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       D8D7                     SDECPAT EQU $-1
       D8D8                     SOPEN1X:
001362 D8D8 CDABD9          17      CALL    READ_DIR    ;FILE SEARCH
001365 D8DB 382A            12      JR  C,RDDERR
001367 D8DD 2A7EE7          16      LD  HL,(_DTBUF)
       D8E0                     SOPEN2:
00136A D8E0 D5              11      PUSH    DE
00136B D8E1 CDBAD9          17      CALL    FILESE      ;(self-modifying code)
       D8E2                     OPENPAT EQU $-2
00136E D8E4 D1              10      POP DE
00136F D8E5 386D            12      JR  C,SOPENE
001371 D8E7 281B            12      JR  Z,SCF_FF_RET
       D8E9                     SOPEN3:
001373 D8E9 3AA0E6          13      LD  A,(_DIRF)   ;ディレクトリか判別
001376 D8EC B7               4      OR  A
001377 D8ED 200C            12      JR  NZ,SOPEN5
001379 D8EF 13               6      INC DE      ;ルートディレクトリ
00137A D8F0 E5              11      PUSH    HL
00137B D8F1 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       D8F2                     MD_PAT  EQU $-2
00137E D8F4 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
001380 D8F6 E1              10      POP HL
001381 D8F7 20DD            12      JR  NZ,SOPEN1
001383 D8F9 1807            12      JR  SOPEN6
       D8FB                     SOPEN5:
001385 D8FB CDC5E1          17      CALL    GNCLX       ;END DIR
001388 D8FE D8              11      RET C
001389 D8FF CD72DA          17      CALL    ENDCL
       D902                     SOPEN6:
00138C D902 38D2            12      JR  C,SOPEN1
       D904                     SCF_FF_RET:
00138E D904 37               4      SCF         ;CF=1
00138F D905 9F               4      SBC A,A     ;A=0FFH
001390 D906 C9              10      RET
                                
       D907                     RDDERR:
001391 D907 BF               4      CP  A       ;READ ERR CF=1 ZF=1
001392 D908 37               4      SCF
001393 D909 C9              10      RET
                                
       D90A                     NOPEN:
001394 D90A 21BAD9          10      LD  HL,FILESE
001397 D90D 22E2D8          16      LD  (OPENPAT),HL
00139A D910 FD2A98E6        20      LD  IY,(_FCB)
00139E D914 CD9CDB          17      CALL    CHKWILDX
0013A1 D917 30EB            12      JR  NC,SCF_FF_RET
0013A3 D919 FD7E00          19      LD  A,(IY+0)
0013A6 D91C CD5BD8          17      CALL    GETDRV
0013A9 D91F CDD9E6          17      CALL    _CHGDRV
0013AC D922 D8              11      RET C
0013AD D923 2AF8E7          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
0013B0 D926 229FE6          16      LD  (_FILEN),HL
                                
0013B3 D929 CDB9DA          17      CALL    LDDIRX
0013B6 D92C ED5B9AE6        20      LD  DE,(_FBPS)
0013BA D930 CDABD9          17      CALL    READ_DIR
0013BD D933 38D2            12      JR  C,RDDERR
0013BF D935 3A9EE6          13      LD  A,(_FBCNT)
0013C2 D938 3D               4      DEC A
0013C3 D939 28AE            12      JR  Z,SOPEN3
       D93B                     NOPEN2:
0013C5 D93B 2A9CE6          16      LD  HL,(_FBAD)
0013C8 D93E 012000          10      LD  BC,020H
0013CB D941 09              11      ADD HL,BC
0013CC D942 4F               4      LD  C,A
0013CD D943 189B            12      JR  SOPEN2
                                
       D945                     SOPENE2:
0013CF D945 229CE6          16      LD  (_FBAD),HL
0013D2 D948 79               4      LD  A,C
0013D3 D949 329EE6          13      LD  (_FBCNT),A
0013D6 D94C ED539AE6        20      LD  (_FBPS),DE
0013DA D950 FD2298E6        20      LD  (_FCB),IY
       D954                     SOPENE:
0013DE D954 AF               4      XOR A
0013DF D955 C9              10      RET
                                
       D956                     COPEN:
0013E0 D956 FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
0013E4 D95A 21D7D9          10      LD  HL,NEXTSE
0013E7 D95D CDA9D8          17      CALL    SOPENC
0013EA D960 D0              11      RET NC
0013EB D961 C8              11      RET Z
0013EC D962 3AA0E6          13      LD  A,(_DIRF)   ;ディレクトリか判別
0013EF D965 B7               4      OR  A
0013F0 D966 37               4      SCF
0013F1 D967 C8              11      RET Z       ;ルートディレクトリ
0013F2 D968 0601             7      LD  B,1
0013F4 D96A CDFBDB          17      CALL    WRDF
0013F7 D96D D8              11      RET C
0013F8 D96E ED5BFEE7        20      LD  DE,(_CLPS)
0013FC D972 D5              11      PUSH    DE
0013FD D973 CD3BDA          17      CALL    DCPAT
001400 D976 CD46E0          17      CALL    DRDNX
001403 D979 2A7EE7          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
001406 D97C ED4B31DF        20      LD  BC,(SECSZ)  ;1セクタのサイズ
00140A D980 AF               4      XOR A
       D981                     COPENCL:
00140B D981 77               7      LD  (HL),A
00140C D982 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00140E D984 EA81D9          10      JP  PE,COPENCL
                                
001411 D987 3A59DA          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
001414 D98A 3D               4      DEC A
001415 D98B 2819            12      JR  Z,COPENE
001417 D98D 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
001419 D98F 32BDE1          13      LD  (_SECPS),A
00141C D992 D1              10      POP DE      ;DE=(_CLPS)
00141D D993 D5              11      PUSH    DE
       D994                     COPEN1:
00141E D994 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
00141F D995 C5              11      PUSH    BC
001420 D996 2A7EE7          16      LD  HL,(_DTBUF)
001423 D999 CD55DA          17      CALL    CLUSTX
001426 D99C CD5AE3          17      CALL    DWT24
001429 D99F C1              10      POP BC
00142A D9A0 D1              10      POP DE
00142B D9A1 CDBCE1          17      CALL    NEXTX
00142E D9A4 20EE            12      JR  NZ,COPEN1
       D9A6                     COPENE:
001430 D9A6 2A7EE7          16      LD  HL,(_DTBUF)
001433 D9A9 D1              10      POP DE
001434 D9AA C9              10      RET
                                
       D9AB                     READ_DIR:
001435 D9AB ED53FEE7        20      LD  (_CLPS),DE
001439 D9AF C5              11      PUSH    BC
00143A D9B0 D5              11      PUSH    DE
00143B D9B1 CD3BDA          17      CALL    DCPAT
00143E D9B4 CD26E0          17      CALL    DRDX
001441 D9B7 D1              10      POP DE
001442 D9B8 C1              10      POP BC
001443 D9B9 C9              10      RET
                                
       D9BA                     FILESE:
001444 D9BA 7E               7      LD  A,(HL)
001445 D9BB B7               4      OR  A
001446 D9BC C8              11      RET Z       ;END:ZF=1 CF=0
001447 D9BD FEE5             7      CP  0E5H
001449 D9BF 280E            12      JR  Z,FILESE1
00144B D9C1 FDE5            15      PUSH    IY
00144D D9C3 D1              10      POP DE
00144E D9C4 13               6      INC DE
00144F D9C5 E5              11      PUSH    HL
001450 D9C6 CD12DA          17      CALL    CPFILE
001453 D9C9 CC33DA          17      CALL    Z,CPFILE2
001456 D9CC E1              10      POP HL
001457 D9CD 37               4      SCF
001458 D9CE C8              11      RET Z       ;!!!:(ZF=1) CF=1
       D9CF                     FILESE1:
001459 D9CF CDE6D9          17      CALL    FNEXT
00145C D9D2 20E6            12      JR  NZ,FILESE
       D9D4                     ZF0_CF0_AFF_RET:
00145E D9D4 F6FF             7      OR  0FFH        ;ZF=0 CF=0
001460 D9D6 C9              10      RET
                                
       D9D7                     NEXTSE:
001461 D9D7 7E               7      LD  A,(HL)
001462 D9D8 B7               4      OR  A
001463 D9D9 37               4      SCF
001464 D9DA C8              11      RET Z       ;!!!:ZF=1 CF=1
001465 D9DB FEE5             7      CP  0E5H
001467 D9DD 37               4      SCF
001468 D9DE C8              11      RET Z       ;!!!:(ZF=1) CF=1
001469 D9DF CDE6D9          17      CALL    FNEXT
00146C D9E2 20F3            12      JR  NZ,NEXTSE
00146E D9E4 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       D9E6                     FNEXT:
001470 D9E6 E5              11      PUSH    HL
001471 D9E7 219FE6          10      LD  HL,_FILEN
001474 D9EA 34              11      INC (HL)
001475 D9EB E1              10      POP HL
001476 D9EC 112000          10      LD  DE,020H
001479 D9EF 19              11      ADD HL,DE
00147A D9F0 0D               4      DEC C
00147B D9F1 C9              10      RET
                                
       D9F2                     CPNAME:
00147C D9F2 C5              11      PUSH    BC
00147D D9F3 D5              11      PUSH    DE
00147E D9F4 E5              11      PUSH    HL
00147F D9F5 CD0CDA          17      CALL    CPFILE4
001482 D9F8 E1              10      POP HL
001483 D9F9 23               6      INC HL
001484 D9FA 23               6      INC HL
001485 D9FB 23               6      INC HL
001486 D9FC 23               6      INC HL
001487 D9FD D1              10      POP DE
001488 D9FE C1              10      POP BC
001489 D9FF 2005            12      JR  NZ,CPNAME1
00148B DA01 7E               7      LD  A,(HL)
00148C DA02 23               6      INC HL
00148D DA03 66               7      LD  H,(HL)
00148E DA04 6F               4      LD  L,A
00148F DA05 C9              10      RET
       DA06                     CPNAME1:
001490 DA06 23               6      INC HL
001491 DA07 23               6      INC HL
001492 DA08 10E8            13      DJNZ    CPNAME
001494 DA0A 37               4      SCF
001495 DA0B C9              10      RET
                                
       DA0C                     CPFILE4:
001496 DA0C C5              11      PUSH    BC
001497 DA0D 010004          10      LD  BC,00400H
00149A DA10 1804            12      JR  CPSTR1
       DA12                     CPFILE:
00149C DA12 C5              11      PUSH    BC
00149D DA13 01000B          10      LD  BC,00B00H
       DA16                     CPSTR1:
0014A0 DA16 1A               7      LD  A,(DE)
0014A1 DA17 FE3F             7      CP  '?'     ;Wild card
0014A3 DA19 2812            12      JR  Z,CPSTR2
0014A5 DA1B 7E               7      LD  A,(HL)
0014A6 DA1C CD82DB          17      CALL    FKANC
0014A9 DA1F E5              11      PUSH    HL
0014AA DA20 67               4      LD  H,A
0014AB DA21 1A               7      LD  A,(DE)
0014AC DA22 CB01             8      RLC C
0014AE DA24 CD82DB          17      CALL    FKANC
0014B1 DA27 CB09             8      RRC C
0014B3 DA29 BC               4      CP  H       ;CP (HL),(DE)
0014B4 DA2A E1              10      POP HL
0014B5 DA2B 2004            12      JR  NZ,CPSTR3
       DA2D                     CPSTR2:
0014B7 DA2D 13               6      INC DE
0014B8 DA2E 23               6      INC HL
0014B9 DA2F 10E5            13      DJNZ    CPSTR1
       DA31                     CPSTR3:
0014BB DA31 C1              10      POP BC
0014BC DA32 C9              10      RET
                                
       DA33                     CPFILE2:
0014BD DA33 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0014C0 DA36 F6E1             7      OR  0E1H
0014C2 DA38 2F               4      CPL
0014C3 DA39 A6               7      AND (HL)
0014C4 DA3A C9              10      RET
                                
       DA3B                     DCPAT:
0014C5 DA3B 0E00             7      LD  C,0
0014C7 DA3D 2A7EE7          16      LD  HL,(_DTBUF)
0014CA DA40 3AA0E6          13      LD  A,(_DIRF)   ;ディレクトリか判別
0014CD DA43 B7               4      OR  A
0014CE DA44 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
0014CF DA45 3A59DA          13      LD  A,(SPCPAT)
0014D2 DA48 4F               4      LD  C,A
0014D3 DA49 3ABDE1          13      LD  A,(_SECPS)
0014D6 DA4C B9               4      CP  C
0014D7 DA4D 3801            12      JR  C,DC1
0014D9 DA4F AF               4      XOR A
       DA50                     DC1:
0014DA DA50 F680             7      OR  080H
0014DC DA52 32A0E6          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       DA55                     CLUSTX:
0014DF DA55 E5              11      PUSH    HL
0014E0 DA56 EB               4      EX  DE,HL
0014E1 DA57 AF               4      XOR A
0014E2 DA58 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       DA59                     SPCPAT  EQU $-1
       DA5A                     L_CLDBL:
0014E4 DA5A CB19             8      RR  C       ;->CF
0014E6 DA5C 3804            12      JR  C,E_CLDBL
0014E8 DA5E 29              11      ADD HL,HL       ;*2
0014E9 DA5F 8F               4      ADC A,A
0014EA DA60 18F8            12      JR  L_CLDBL
       DA62                     E_CLDBL:
0014EC DA62 4F               4      LD  C,A
0014ED DA63 3ABDE1          13      LD  A,(_SECPS)
0014F0 DA66 B5               4      OR  L
0014F1 DA67 6F               4      LD  L,A
0014F2 DA68 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       DA69                     CLSPAT  EQU $-2
0014F5 DA6B AF               4      XOR A
0014F6 DA6C 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
0014F7 DA6D 89               4      ADC A,C
0014F8 DA6E 4F               4      LD  C,A
0014F9 DA6F EB               4      EX  DE,HL
0014FA DA70 E1              10      POP HL
0014FB DA71 C9              10      RET
                                ;(8)
       DA72                     ENDCL:
0014FC DA72 7A               4      LD  A,D ;END CLUSTER
0014FD DA73 FE01             7      CP  1   ;164=356    (self-modifying code)
       DA74                     CLPAT1  EQU $-1
0014FF DA75 C0              11      RET NZ
001500 DA76 7B               4      LD  A,E
001501 DA77 FE64             7      CP  064H    ;       (self-modifying code)
       DA78                     CLPAT2  EQU $-1
001503 DA79 C9              10      RET
                                ;(3)
       DA7A                     CAP4:
001504 DA7A 3EE5             7      LD  A,0E5H
001506 DA7C C9              10      RET
                                                    ;for X1/88 ワークエリア
001507 DA7D 5BE6                    DW  _DISKE+1        ;DISKVE($F323)
001509 DA7F F5E6                    DW  _BREAK+1        ;BREAKV($F325)
                                
       DA81                     CAP:            ;(9)
00150B DA81 FE61             7      CP  'a'
00150D DA83 D8              11      RET C
00150E DA84 FE7B             7      CP  'z'+1
001510 DA86 D0              11      RET NC
001511 DA87 D620             7      SUB 020H
001513 DA89 C9              10      RET
                                ;(10)
       DA8A                     CAP2:
001514 DA8A CD81DA          17      CALL    CAP
       DA8D                     CAP3:               ;
001517 DA8D FE05             7      CP  5
001519 DA8F 28E9            12      JR  Z,CAP4
00151B DA91 FE21             7      CP  021H
00151D DA93 C9              10      RET
                                                    ;
       DA94                     CHDIR:
00151E DA94 CD6BE4          17      CALL    GETDPBD
001521 DA97 381D            12      JR  C,CHDIR2
001523 DA99 DD751A          19      LD  (IX+DPB_SDIR),L
001526 DA9C DD741B          19      LD  (IX+DPB_SDIR+1),H
001529 DA9F 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       DAA1                     LDDIR:
00152B DAA1 CD6BE4          17      CALL    GETDPBD
00152E DAA4 DD5E1A          19      LD  E,(IX+DPB_SDIR)
001531 DAA7 DD561B          19      LD  D,(IX+DPB_SDIR+1)
001534 DAAA 13               6      INC DE
001535 DAAB FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
001538 DAAE FD720F          19      LD  (IY+15),D
00153B DAB1 1B               6      DEC DE
00153C DAB2 AF               4      XOR A
00153D DAB3 32A0E6          13      LD  (_DIRF),A
       DAB6                     CHDIR2:
001540 DAB6 DDE1            14      POP IX
001542 DAB8 C9              10      RET
                                
       DAB9                     LDDIRX:
001543 DAB9 3AA0E6          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
001546 DABC E67F             7      AND 07FH
       DABE                     LDDIRX1:
001548 DABE 32BDE1          13      LD  (_SECPS),A
00154B DAC1 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00154E DAC4 FD560F          19      LD  D,(IY+15)
001551 DAC7 1B               6      DEC DE
001552 DAC8 CD72DA          17      CALL    ENDCL
001555 DACB D4A1DA          17      CALL    NC,LDDIR
       DACE                     LDDIRS:
001558 DACE 7A               4      LD  A,D
001559 DACF B3               4      OR  E
00155A DAD0 32A0E6          13      LD  (_DIRF),A   ;ディレクトリか判別
00155D DAD3 C9              10      RET
                                
       DAD4                     KILL:
00155E DAD4 CD9CDB          17      CALL    CHKWILDX
001561 DAD7 3834            12      JR  C,KILLW
001563 DAD9 CD77D8          17      CALL    SOPENX
       DADC                     KILLS:
001566 DADC 3E1F             7      LD  A,01FH
001568 DADE D420DB          17      CALL    NC,CHKATT
00156B DAE1 D8              11      RET C
       DAE2                     KILLSX:
00156C DAE2 36E5            10      LD  (HL),0E5H   ;DIR
00156E DAE4 CD78DB          17      CALL    WTDB
001571 DAE7 111A00          10      LD  DE,01AH
001574 DAEA 19              11      ADD HL,DE
001575 DAEB 5E               7      LD  E,(HL)
001576 DAEC 23               6      INC HL
001577 DAED 56               7      LD  D,(HL)
       DAEE                     KILLS1:
001578 DAEE CD72DA          17      CALL    ENDCL
00157B DAF1 D0              11      RET NC      ;CF=0
00157C DAF2 21FEFF          10      LD  HL,0-2
00157F DAF5 19              11      ADD HL,DE
001580 DAF6 D0              11      RET NC      ;DE= 0 or 1
001581 DAF7 D5              11      PUSH    DE
001582 DAF8 CDF7E6          17      CALL    _GNCL
001585 DAFB ED53FEE7        20      LD  (_CLPS),DE
001589 DAFF D1              10      POP DE
00158A DB00 210000          10      LD  HL,0
00158D DB03 D4FAE6          17      CALL    NC,_SNCL
001590 DB06 D8              11      RET C
001591 DB07 ED5BFEE7        20      LD  DE,(_CLPS)  ;FAT
001595 DB0B 18E1            12      JR  KILLS1
                                
       DB0D                     KILLW:
001597 DB0D CDA6D8          17      CALL    SOPEN
       DB10                     KILLW1:
00159A DB10 380B            12      JR  C,KILLW2
00159C DB12 CD45D9          17      CALL    SOPENE2
00159F DB15 CDDCDA          17      CALL    KILLS
0015A2 DB18 CD0AD9          17      CALL    NOPEN
0015A5 DB1B 18F3            12      JR  KILLW1
       DB1D                     KILLW2:
0015A7 DB1D C8              11      RET Z
0015A8 DB1E 3F               4      CCF
0015A9 DB1F C9              10      RET
                                
       DB20                     CHKATT:
0015AA DB20 E5              11      PUSH    HL
0015AB DB21 110B00          10      LD  DE,00BH
0015AE DB24 19              11      ADD HL,DE
0015AF DB25 A6               7      AND (HL)
0015B0 DB26 E1              10      POP HL
0015B1 DB27 C8              11      RET Z
0015B2 DB28 37               4      SCF
0015B3 DB29 C9              10      RET
                                
       DB2A                     NAME:
0015B4 DB2A CD9CDB          17      CALL    CHKWILDX
0015B7 DB2D D8              11      RET C
0015B8 DB2E 110400          10      LD  DE,4
0015BB DB31 19              11      ADD HL,DE
0015BC DB32 2247DB          16      LD  (NAMEP),HL
0015BF DB35 23               6      INC HL
0015C0 DB36 CDA0DB          17      CALL    CHKWILD
0015C3 DB39 D8              11      RET C
                                
0015C4 DB3A CD77D8          17      CALL    SOPENX
0015C7 DB3D 3E0F             7      LD  A,00FH
0015C9 DB3F D420DB          17      CALL    NC,CHKATT
0015CC DB42 D8              11      RET C
                                
0015CD DB43 FDE5            15      PUSH    IY
0015CF DB45 FD210000        14      LD  IY,0        ;自己書き換え
       DB47                     NAMEP   EQU $-2
0015D3 DB49 CD77D8          17      CALL    SOPENX
0015D6 DB4C FDE3            23      EX  (SP),IY
0015D8 DB4E 3F               4      CCF
0015D9 DB4F D4A6D8          17      CALL    NC,SOPEN
0015DC DB52 EB               4      EX  DE,HL
0015DD DB53 E1              10      POP HL
0015DE DB54 D8              11      RET C
                                
       DB55                     SETNAME:
0015DF DB55 01000B          10      LD  BC,11*256
0015E2 DB58 23               6      INC HL
0015E3 DB59 7E               7      LD  A,(HL)
0015E4 DB5A FEE5             7      CP  0E5H
0015E6 DB5C 2004            12      JR  NZ,SNAME1
0015E8 DB5E 3E05             7      LD  A,5
0015EA DB60 180E            12      JR  SNAME3
       DB62                     SNAME1:
0015EC DB62 7E               7      LD  A,(HL)
0015ED DB63 0C               4      INC C
0015EE DB64 0D               4      DEC C
0015EF DB65 2009            12      JR  NZ,SNAME3
0015F1 DB67 CD81DA          17      CALL    CAP
0015F4 DB6A FEA0             7      CP  0A0H
0015F6 DB6C 2002            12      JR  NZ,SNAME3
0015F8 DB6E 3E20             7      LD  A,020H
       DB70                     SNAME3:
0015FA DB70 12               7      LD  (DE),A
0015FB DB71 7E               7      LD  A,(HL)
0015FC DB72 23               6      INC HL
0015FD DB73 CD89DB          17      CALL    FKAN
001600 DB76 10EA            13      DJNZ    SNAME1
       DB78                     WTDB:               ;バッファデータが更新された
001602 DB78 3EFF             7      LD  A,0FFH
001604 DB7A 3239E6          13      LD  (SFILE),A
001607 DB7D 32A4E6          13      LD  (_WTDBF),A
00160A DB80 AF               4      XOR A
00160B DB81 C9              10      RET
                                
       DB82                     FKANC:
00160C DB82 CB41             8      BIT 0,C
00160E DB84 CC8ADA          17      CALL    Z,CAP2
001611 DB87 1801            12      JR  FKANX
       DB89                     FKAN:           ;漢字チェック
001613 DB89 13               6      INC DE
       DB8A                     FKANX:
001614 DB8A CB41             8      BIT 0,C
001616 DB8C CB81             8      RES 0,C
001618 DB8E C0              11      RET NZ
001619 DB8F FE80             7      CP  080H
00161B DB91 D8              11      RET C
00161C DB92 FEA0             7      CP  0A0H
00161E DB94 3803            12      JR  C,FKAN1
001620 DB96 FEE0             7      CP  0E0H
001622 DB98 D8              11      RET C
       DB99                     FKAN1:
001623 DB99 0C               4      INC C
001624 DB9A A7               4      AND A
001625 DB9B C9              10      RET
                                
       DB9C                     CHKWILDX:
001626 DB9C FDE5            15      PUSH    IY
001628 DB9E E1              10      POP HL
001629 DB9F 23               6      INC HL
       DBA0                     CHKWILD:
00162A DBA0 060B             7      LD  B,11
00162C DBA2 3E3F             7      LD  A,'?'
       DBA4                     CHKWIL1:
00162E DBA4 BE               7      CP  (HL)
00162F DBA5 23               6      INC HL
001630 DBA6 37               4      SCF
001631 DBA7 C8              11      RET Z
001632 DBA8 10FA            13      DJNZ    CHKWIL1
001634 DBAA AF               4      XOR A
001635 DBAB C9              10      RET
                                
       DBAC                     SDIRENT:        ;IY=FCB HL=DIR
001636 DBAC D5              11      PUSH    DE
001637 DBAD E5              11      PUSH    HL
001638 DBAE FDE5            15      PUSH    IY
00163A DBB0 D1              10      POP DE
00163B DBB1 EB               4      EX  DE,HL
00163C DBB2 CD55DB          17      CALL    SETNAME
                                ;               Attribute
00163F DBB5 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001642 DBB8 12               7      LD  (DE),A
001643 DBB9 13               6      INC DE
                                ;               Reserved
001644 DBBA AF               4      XOR A
001645 DBBB 060A             7      LD  B,10
       DBBD                     SDE1:
001647 DBBD 12               7      LD  (DE),A
001648 DBBE 13               6      INC DE
001649 DBBF 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
00164B DBC1 21E4E7          10      LD  HL,SDDATA       ;(FCB)更新年月日
00164E DBC4 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DBC6                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
001650 DBC6 7E               7      LD  A,(HL)
001651 DBC7 23               6      INC HL
001652 DBC8 32CDDB          13      LD  (SDPAT),A
001655 DBCB FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       DBCD                     SDPAT   EQU $-1
001658 DBCE 12               7      LD  (DE),A
001659 DBCF 13               6      INC DE
00165A DBD0 10F4            13      DJNZ    SDLOOP
                                
00165C DBD2 AF               4      XOR A
00165D DBD3 E1              10      POP HL
00165E DBD4 D1              10      POP DE
00165F DBD5 C9              10      RET
                                
       DBD6                     WOPEN:
001660 DBD6 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001663 DBD9 E61F             7      AND 01FH
001665 DBDB 37               4      SCF
001666 DBDC C0              11      RET NZ
001667 DBDD FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       DBE1                     TOPEN2:
00166B DBE1 AF               4      XOR A
       DBE2                     TOPEN:              ;Initializes the time stamp
00166C DBE2 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
001670 DBE6 C9              10      RET
                                
       DBE7                     WRDFX:
001671 DBE7 3A59DA          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       DBEA                     L_WRFX:
001674 DBEA 1F               4      RRA         ;->CF
001675 DBEB 3806            12      JR  C,E_WRFX
001677 DBED CB39             8      SRL C
001679 DBEF CB1C             8      RR  H       ;CH=CH/2
00167B DBF1 18F7            12      JR  L_WRFX
       DBF3                     E_WRFX:
00167D DBF3 41               4      LD  B,C
00167E DBF4 4C               4      LD  C,H
00167F DBF5 03               6      INC BC
001680 DBF6 3E37             7      LD  A,037H      ;SCF
001682 DBF8 3243E0          13      LD  (DRDN1),A
                                
       DBFB                     WRDF:               ;BCクラスタ分FATを確保する
001685 DBFB 110200          10      LD  DE,2
001688 DBFE AF               4      XOR A
001689 DBFF 32BDE1          13      LD  (_SECPS),A
       DC02                     WRDF1:
00168C DC02 C5              11      PUSH    BC
00168D DC03 D5              11      PUSH    DE
00168E DC04 CDF7E6          17      CALL    _GNCL
001691 DC07 381C            12      JR  C,WRDF3
001693 DC09 7A               4      LD  A,D     ;空いているかチェック
001694 DC0A B3               4      OR  E
001695 DC0B 202A            12      JR  NZ,WRDF4
001697 DC0D E1              10      POP HL      ;HL=空いているクラスタ
001698 DC0E E5              11      PUSH    HL
001699 DC0F ED5BFEE7        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
00169D DC13 22FEE7          16      LD  (_CLPS),HL
0016A0 DC16 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
0016A1 DC17 B3               4      OR  E
0016A2 DC18 2008            12      JR  NZ,WRDF2
0016A4 DC1A FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
0016A7 DC1D FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
0016AA DC20 1803            12      JR  WRDF3
       DC22                     WRDF2:
0016AC DC22 CDFAE6          17      CALL    _SNCL
       DC25                     WRDF3:
0016AF DC25 D1              10      POP DE
0016B0 DC26 C1              10      POP BC
0016B1 DC27 D8              11      RET C
0016B2 DC28 0B               6      DEC BC
0016B3 DC29 78               4      LD  A,B
0016B4 DC2A B1               4      OR  C
0016B5 DC2B 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
0016B7 DC2D ED5BFEE7        20      LD  DE,(_CLPS)
0016BB DC31 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
0016BE DC34 C3FAE6          10      JP  _SNCL
                                
       DC37                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
0016C1 DC37 D1              10      POP DE
0016C2 DC38 C1              10      POP BC
       DC39                     WRDF5:
0016C3 DC39 13               6      INC DE
0016C4 DC3A CD72DA          17      CALL    ENDCL
0016C7 DC3D 38C3            12      JR  C,WRDF1
0016C9 DC3F 37               4      SCF
0016CA DC40 C9              10      RET
                                
       DC41                     RWXR:
0016CB DC41 3A32DF          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       DC44                     L_RWX:
0016CE DC44 1F               4      RRA     ;->CF
0016CF DC45 3808            12      JR  C,E_RWX
0016D1 DC47 CB38             8      SRL B   ;BCH=BCH/2
0016D3 DC49 CB19             8      RR  C   ;
0016D5 DC4B CB1C             8      RR  H   ;
0016D7 DC4D 18F5            12      JR  L_RWX
       DC4F                     E_RWX:
0016D9 DC4F FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0016DC DC52 FD561B          19      LD  D,(IY+27)
0016DF DC55 AF               4      XOR A
0016E0 DC56 32BDE1          13      LD  (_SECPS),A
       DC59                     RWX1:
0016E3 DC59 ED53FEE7        20      LD  (_CLPS),DE
0016E7 DC5D 7A               4      LD  A,D
0016E8 DC5E B3               4      OR  E
0016E9 DC5F 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
0016EB DC61 78               4      LD  A,B
0016EC DC62 B1               4      OR  C
0016ED DC63 B4               4      OR  H
0016EE DC64 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
0016EF DC65 CDC5E1          17      CALL    GNCLX
0016F2 DC68 D8              11      RET C
0016F3 DC69 7C               4      LD  A,H     ;
0016F4 DC6A 25               4      DEC H       ;
0016F5 DC6B B7               4      OR  A       ;DEC BCH
0016F6 DC6C 2001            12      JR  NZ,RWX2     ;
0016F8 DC6E 0B               6      DEC BC      ;
       DC6F                     RWX2:
0016F9 DC6F CD72DA          17      CALL    ENDCL
0016FC DC72 38E5            12      JR  C,RWX1
       DC74                     SCF_RET:
0016FE DC74 37               4      SCF
0016FF DC75 C9              10      RET
                                
       DC76                     DSKF:
001700 DC76 110000          10      LD  DE,0
       DC77                     MAXCLP  EQU $-2
001703 DC79 2AACE6          16      LD  HL,(_FAKEFREE)
001706 DC7C 7C               4      LD  A,H
001707 DC7D B5               4      OR  L
001708 DC7E 2803            12      JR  Z,DSKF1
00170A DC80 110100          10      LD  DE,1
       DC83                     DSKF1:
00170D DC83 D5              11      PUSH    DE
00170E DC84 CDF7E6          17      CALL    _GNCL
001711 DC87 380C            12      JR  C,POPSCF
001713 DC89 7A               4      LD  A,D
001714 DC8A B3               4      OR  E
001715 DC8B 2001            12      JR  NZ,DSKF2
001717 DC8D 23               6      INC HL
       DC8E                     DSKF2:
001718 DC8E D1              10      POP DE
001719 DC8F 1B               6      DEC DE
00171A DC90 7A               4      LD  A,D
00171B DC91 B3               4      OR  E
00171C DC92 20EF            12      JR  NZ,DSKF1
00171E DC94 C9              10      RET
                                
       DC95                     POPSCF:
00171F DC95 F1              10      POP AF
001720 DC96 37               4      SCF
001721 DC97 C9              10      RET
                                
       DC98                     SETTMS:
001722 DC98 FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
001725 DC9B 3C               4      INC A
001726 DC9C C0              11      RET NZ      ;ファイルが更新されていない
       DC9D                     SETTMSX:            ;FCBに日付時刻をセットする
001727 DC9D CD60D4          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
00172A DCA0 CB25             8      SLA L       ;   *2
00172C DCA2 CB25             8      SLA L       ;   *4
00172E DCA4 29              11      ADD HL,HL       ;*2 *8
00172F DCA5 29              11      ADD HL,HL       ;*4 *16
001730 DCA6 29              11      ADD HL,HL       ;*8 *32
001731 DCA7 7A               4      LD  A,D
001732 DCA8 0F               4      RRCA            ;bit.0->7->->->0->C
001733 DCA9 E61F             7      AND 01FH
001735 DCAB B5               4      OR  L
001736 DCAC FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
001739 DCAF FD7417          19      LD  (IY+23),H
                                
00173C DCB2 CD10D4          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
00173F DCB5 0144F8          10      LD  BC,0-1980
001742 DCB8 09              11      ADD HL,BC
001743 DCB9 65               4      LD  H,L
                                
001744 DCBA 7A               4      LD  A,D
001745 DCBB 87               4      ADD A,A     ;*2
001746 DCBC 87               4      ADD A,A     ;*4
001747 DCBD 87               4      ADD A,A     ;*8
001748 DCBE 87               4      ADD A,A     ;*16
001749 DCBF 6F               4      LD  L,A
00174A DCC0 29              11      ADD HL,HL       ;*32
00174B DCC1 7D               4      LD  A,L
00174C DCC2 B3               4      OR  E
00174D DCC3 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
001750 DCC6 FD7415          19      LD  (IY+21),H
001753 DCC9 C9              10      RET
                                ;(16)
       DCCA                     PUSHRR:
001754 DCCA 32F6DF          13      LD  (SETSEQ_SWC_RND),A
001757 DCCD 2208E0          16      LD  (SETSEQ_SWC_SEQ_RR),HL
00175A DCD0 CDF0DC          17      CALL    GET_RR_AHL
00175D DCD3 220FE6          16      LD  (RR_BUF_HL),HL
001760 DCD6 3211E6          13      LD  (RR_BUF_A),A
001763 DCD9 C9              10      RET
                                ;(14)
       DCDA                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
001764 DCDA 87               4      ADD A,A     ;in BHLA => out AHL
001765 DCDB ED6A            15      ADC HL,HL
001767 DCDD CB18             8      RR  B
001769 DCDF B7               4      OR  A
00176A DCE0 78               4      LD  A,B     ;ここでフラグは変化しない
00176B DCE1 C8              11      RET Z
00176C DCE2 2C               4      INC L       ;INC AHL
00176D DCE3 C0              11      RET NZ      ;
00176E DCE4 24               4      INC H       ;
00176F DCE5 C0              11      RET NZ      ;
001770 DCE6 3C               4      INC A       ;
001771 DCE7 C9              10      RET
                                ;(18)
       DCE8                     INIT_RND:
001772 DCE8 3ECD             7      LD  A,0CDH      ;CALL ????
001774 DCEA 2107DD          10      LD  HL,POPRR
001777 DCED CDCADC          17      CALL    PUSHRR
       DCF0                     GET_RR_AHL:
00177A DCF0 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00177D DCF3 FD6622          19      LD  H,(IY+34)   ;
001780 DCF6 FD7E23          19      LD  A,(IY+35)   ;
001783 DCF9 C9              10      RET
                                ;(10)
       DCFA                     SET_RR_AHL:
001784 DCFA FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001787 DCFD FD7422          19      LD  (IY+34),H   ;
00178A DD00 FD7723          19      LD  (IY+35),A   ;
00178D DD03 C9              10      RET
                                ;(17)
       DD04                     SETSEQ:
00178E DD04 CD29DD          17      CALL    SETSEQ1
       DD07                     POPRR:
001791 DD07 F5              11      PUSH    AF
001792 DD08 E5              11      PUSH    HL
001793 DD09 2A0FE6          16      LD  HL,(RR_BUF_HL)
001796 DD0C 3A11E6          13      LD  A,(RR_BUF_A)
001799 DD0F CDFADC          17      CALL    SET_RR_AHL
00179C DD12 E1              10      POP HL
00179D DD13 F1              10      POP AF
00179E DD14 C9              10      RET
                                ;(20)
       DD15                     GET_RR_BCDE:            ;BCDE=Random record
00179F DD15 FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
0017A2 DD18 FD5622          19      LD  D,(IY+34)
0017A5 DD1B FD4E23          19      LD  C,(IY+35)
0017A8 DD1E 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
0017AA DD20 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0017AE DD24 C0              11      RET NZ
0017AF DD25 FD4624          19      LD  B,(IY+36)
0017B2 DD28 C9              10      RET
                                
       DD29                     SETSEQ1:
0017B3 DD29 F5              11      PUSH    AF
0017B4 DD2A E5              11      PUSH    HL      ;AHL=Random record
0017B5 DD2B CDF0DC          17      CALL    GET_RR_AHL
0017B8 DD2E 47               4      LD  B,A     ;AHL→HLA
0017B9 DD2F 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
0017BA DD30 6C               4      LD  L,H     ;(IY+34)
0017BB DD31 60               4      LD  H,B     ;(IY+35)
0017BC DD32 0600             7      LD  B,0
                                
0017BE DD34 CDDADC          17      CALL    GET_CPM_R_SIZE
                                
0017C1 DD37 29              11      ADD HL,HL
0017C2 DD38 CB3D             8      SRL L       ;L=L/2
0017C4 DD3A FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
0017C7 DD3D FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
0017CA DD40 E1              10      POP HL
0017CB DD41 F1              10      POP AF
0017CC DD42 C9              10      RET
                                
                                ;(23)
       DD43                     RBXEND:             ;レコード数だけランダムレコードを進める
0017CD DD43 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       DD44                     RBSIZE  EQU $-2
0017D0 DD46 CDF0DC          17      CALL    GET_RR_AHL
0017D3 DD49 19              11      ADD HL,DE
0017D4 DD4A CE00             7      ADC A,0
0017D6 DD4C CDFADC          17      CALL    SET_RR_AHL
0017D9 DD4F EB               4      EX  DE,HL       ;HL=進めるレコード数
0017DA DD50 D0              11      RET NC
0017DB DD51 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0017DF DD55 C0              11      RET NZ
0017E0 DD56 FD3424          23      INC (IY+36)
0017E3 DD59 C9              10      RET
       DD5A                     FILE_E:
                                
       D904                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       D904                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       D904                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       D904                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       D904                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       DD5A                     _SYS26:     ;(BDOS)ランダムブロック書き込み
0017E4 DD5A AF               4      XOR A
0017E5 DD5B 3243E0          13      LD  (DRDN1),A   ;NOP
0017E8 DD5E 2244DD          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
0017EB DD61 225DE6          16      LD  (LEFTX),HL
0017EE DD64 CD4DD8          17      CALL    SETDRV
                                
0017F1 DD67 CDCDDE          17      CALL    RBX0
0017F4 DD6A DAF7DD          10      JP  C,RBWERR
0017F7 DD6D CDD6DB          17      CALL    WOPEN
0017FA DD70 DAF7DD          10      JP  C,RBWERR
0017FD DD73 7C               4      LD  A,H
0017FE DD74 B5               4      OR  L
0017FF DD75 CAF0DD          10      JP  Z,RBW1
                                
001802 DD78 2B               6      DEC HL
                                
001803 DD79 CD15DD          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001806 DD7C 19              11      ADD HL,DE       ;BCHL=HL+BCDE
001807 DD7D 3001            12      JR  NC,S26X1    ;
001809 DD7F 03               6      INC BC      ;
       DD80                     S26X1:
00180A DD80 CD41DC          17      CALL    RWXR
00180D DD83 DCE7DB          17      CALL    C,WRDFX
001810 DD86 DAF7DD          10      JP  C,RBWERR
                                
001813 DD89 CDFCDE          17      CALL    RBX2
001816 DD8C 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
001818 DD8E CD1BDF          17      CALL    RBXA
00181B DD91 3864            12      JR  C,RBWERR
00181D DD93 EB               4      EX  DE,HL
00181E DD94 C5              11      PUSH    BC
00181F DD95 EDB0                    LDIR
001821 DD97 225FE6          16      LD  (DTAX),HL
                                
001824 DD9A CD78DB          17      CALL    WTDB        ;バッファデータは更新された
                                
001827 DD9D 2A5DE6          16      LD  HL,(LEFTX)
00182A DDA0 D1              10      POP DE
00182B DDA1 ED52            15      SBC HL,DE
00182D DDA3 225DE6          16      LD  (LEFTX),HL
001830 DDA6 2831            12      JR  Z,RBWEND
                                
       DDA8                     RBWB:
001832 DDA8 CD50DF          17      CALL    RBXB
001835 DDAB 2814            12      JR  Z,RBWC
       DDAD                     RBWB1:
001837 DDAD C5              11      PUSH    BC
001838 DDAE D5              11      PUSH    DE
001839 DDAF CD55DA          17      CALL    CLUSTX
00183C DDB2 CD74DF          17      CALL    DWTC
00183F DDB5 D1              10      POP DE
001840 DDB6 C1              10      POP BC
001841 DDB7 D4C5E1          17      CALL    NC,GNCLX
001844 DDBA 383B            12      JR  C,RBWERR
001846 DDBC 10EF            13      DJNZ    RBWB1
001848 DDBE CDC4DF          17      CALL    DRW_FLUSH
       DDC1                     RBWC:
00184B DDC1 CD68DF          17      CALL    RBXC
00184E DDC4 2813            12      JR  Z,RBWEND
001850 DDC6 C5              11      PUSH    BC
001851 DDC7 CD55DA          17      CALL    CLUSTX
001854 DDCA CD42E0          17      CALL    DRDN
001857 DDCD C1              10      POP BC
001858 DDCE 3827            12      JR  C,RBWERR
00185A DDD0 ED5B7EE7        20      LD  DE,(_DTBUF)
00185E DDD4 EDB0                    LDIR
001860 DDD6 CD78DB          17      CALL    WTDB        ;バッファデータは更新された
       DDD9                     RBWEND:
001863 DDD9 CD43DD          17      CALL    RBXEND
                                
001866 DDDC CDDCDE          17      CALL    RBX1
001869 DDDF 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
00186B DDE1 CD15DD          17      CALL    GET_RR_BCDE ;BCDE=Random record
00186E DDE4 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
001871 DDE7 FD7211          19      LD  (IY+17),D   ;
001874 DDEA FD7112          19      LD  (IY+18),C   ;
001877 DDED FD7013          19      LD  (IY+19),B   ;
       DDF0                     RBW1:
00187A DDF0 FDE1            14      POP IY
00187C DDF2 C1              10      POP BC
00187D DDF3 D1              10      POP DE
00187E DDF4 E1              10      POP HL
       DDF5                     DD_NUL:
00187F DDF5 AF               4      XOR A
       DDF6                     DRDF0:
       DDF6                     DWTF0:
001880 DDF6 C9              10      RET
                                
       DDF7                     RBWERR:
001881 DDF7 FDE5            15      PUSH    IY
001883 DDF9 D1              10      POP DE
001884 DDFA 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
001886 DDFC CDD7CF          17      CALL    BDOS0
       DDFF                     RBRERR1:
001889 DDFF 3E01             7      LD  A,001H
       DE01                     RBRERR2:
00188B DE01 FDE1            14      POP IY
00188D DE03 C1              10      POP BC
00188E DE04 D1              10      POP DE
00188F DE05 E1              10      POP HL
001890 DE06 37               4      SCF
001891 DE07 210000          10      LD  HL,0
001894 DE0A C9              10      RET
                                
       DE0B                     RBRERR:
001895 DE0B 3EFF             7      LD  A,0FFH
001897 DE0D 18F2            12      JR  RBRERR2
                                
       DE0F                     RBRFL:
001899 DE0F 3E00             7  RBRFLP: LD  A,000H
00189B DE11 FE0D             7      CP  00DH
00189D DE13 2005            12      JR  NZ,RBRFL1
00189F DE15 D5              11      PUSH    DE
0018A0 DE16 1E0A             7      LD  E,00AH
0018A2 DE18 1805            12      JR  RBRFL2
       DE1A                     RBRFL1:
0018A4 DE1A D5              11      PUSH    DE
0018A5 DE1B CD09E6          17      CALL    _SYS07
0018A8 DE1E 5F               4      LD  E,A
       DE1F                     RBRFL2:
0018A9 DE1F CDCDE6          17      CALL    _PRINT
0018AC DE22 7B               4      LD  A,E
0018AD DE23 D1              10      POP DE
0018AE DE24 3210DE          13      LD  (RBRFLP+1),A
0018B1 DE27 C9              10      RET
                                
                                                ;Read random block
       DE28                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0018B2 DE28 225DE6          16      LD  (LEFTX),HL
0018B5 DE2B CD4DD8          17      CALL    SETDRV
                                
0018B8 DE2E FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
0018BC DE32 C2BBDE          10      JP  NZ,RBRDIR   ;ディレクトリ
0018BF DE35 CDCDDE          17      CALL    RBX0
0018C2 DE38 DA0BDE          10      JP  C,RBRERR
0018C5 DE3B CDDCDE          17      CALL    RBX1
0018C8 DE3E D4F4DE          17      CALL    NC,RBX1R
0018CB DE41 DAFFDD          10      JP  C,RBRERR1
0018CE DE44 EB               4      EX  DE,HL
0018CF DE45 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
0018D1 DE47 19              11      ADD HL,DE
0018D2 DE48 79               4      LD  A,C
0018D3 DE49 DE00             7      SBC A,0
0018D5 DE4B 78               4      LD  A,B
0018D6 DE4C DE00             7      SBC A,0
0018D8 DE4E 3801            12      JR  C,RBR1
0018DA DE50 EB               4      EX  DE,HL
       DE51                     RBR1:
0018DB DE51 9F               4      SBC A,A
0018DC DE52 E601             7      AND 1
0018DE DE54 32B9DE          13      LD  (RBRA_SWC),A
                                
0018E1 DE57 7C               4      LD  A,H
0018E2 DE58 B5               4      OR  L
0018E3 DE59 2857            12      JR  Z,RBREND0
                                
0018E5 DE5B 2244DD          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
0018E8 DE5E 225DE6          16      LD  (LEFTX),HL
                                
0018EB DE61 CDFCDE          17      CALL    RBX2
0018EE DE64 2819            12      JR  Z,RBRB
0018F0 DE66 CD1BDF          17      CALL    RBXA
0018F3 DE69 DA0BDE          10      JP  C,RBRERR
0018F6 DE6C C5              11      PUSH    BC
0018F7 DE6D EDB0                    LDIR
0018F9 DE6F ED535FE6        20      LD  (DTAX),DE
0018FD DE73 2A5DE6          16      LD  HL,(LEFTX)
001900 DE76 D1              10      POP DE
001901 DE77 A7               4      AND A
001902 DE78 ED52            15      SBC HL,DE
001904 DE7A 225DE6          16      LD  (LEFTX),HL
001907 DE7D 2830            12      JR  Z,RBREND
                                
       DE7F                     RBRB:
001909 DE7F CD50DF          17      CALL    RBXB
00190C DE82 2815            12      JR  Z,RBRC
       DE84                     RBRB1:
00190E DE84 C5              11      PUSH    BC
00190F DE85 D5              11      PUSH    DE
001910 DE86 CD55DA          17      CALL    CLUSTX
001913 DE89 CD7ADF          17      CALL    DRDC
001916 DE8C D1              10      POP DE
001917 DE8D C1              10      POP BC
001918 DE8E D4C5E1          17      CALL    NC,GNCLX
00191B DE91 DA0BDE          10      JP  C,RBRERR
00191E DE94 10EE            13      DJNZ    RBRB1
001920 DE96 CDC4DF          17      CALL    DRW_FLUSH
       DE99                     RBRC:
001923 DE99 CD68DF          17      CALL    RBXC
001926 DE9C 2811            12      JR  Z,RBREND
001928 DE9E C5              11      PUSH    BC
001929 DE9F CD55DA          17      CALL    CLUSTX
00192C DEA2 CD26E0          17      CALL    DRDX
00192F DEA5 C1              10      POP BC
001930 DEA6 DA0BDE          10      JP  C,RBRERR
001933 DEA9 EB               4      EX  DE,HL
001934 DEAA 2A7EE7          16      LD  HL,(_DTBUF)
001937 DEAD EDB0                    LDIR
       DEAF                     RBREND:
001939 DEAF CD43DD          17      CALL    RBXEND
       DEB2                     RBREND0:
00193C DEB2 FDE1            14      POP IY
00193E DEB4 C1              10      POP BC
00193F DEB5 D1              10      POP DE
001940 DEB6 F1              10      POP AF  ;(HL)
001941 DEB7 AF               4      XOR A
001942 DEB8 3E00             7      LD  A,000H
       DEB9                     RBRA_SWC    EQU $-1
001944 DEBA C9              10      RET
                                
       DEBB                     RBRDIR:
001945 DEBB FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001948 DEBE FD661B          19      LD  H,(IY+27)
00194B DEC1 CD94DA          17      CALL    CHDIR
00194E DEC4 AF               4      XOR A
00194F DEC5 67               4      LD  H,A
001950 DEC6 6F               4      LD  L,A
001951 DEC7 3C               4      INC A
001952 DEC8 32B9DE          13      LD  (RBRA_SWC),A
001955 DECB 18E5            12      JR  RBREND0
                                ;(15)
       DECD                     RBX0:
001957 DECD 2A8AE6          16      LD  HL,(_DTA)
00195A DED0 225FE6          16      LD  (DTAX),HL
00195D DED3 2A5DE6          16      LD  HL,(LEFTX)
001960 DED6 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
001963 DED9 D6FD             7      SUB 0FDH
001965 DEDB C9              10      RET
                                
       DEDC                     RBX1:               ;ファイルサイズとランダムレコードを比べる
001966 DEDC E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
001967 DEDD FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
00196A DEE0 FD6611          19      LD  H,(IY+17)   ;
00196D DEE3 FD7E12          19      LD  A,(IY+18)   ;
                                
001970 DEE6 CD15DD          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001973 DEE9 A7               4      AND A
001974 DEEA ED52            15      SBC HL,DE
001976 DEEC 99               4      SBC A,C
001977 DEED 4F               4      LD  C,A
001978 DEEE FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
00197B DEF1 98               4      SBC A,B
00197C DEF2 D1              10      POP DE
00197D DEF3 C9              10      RET
       DEF4                     RBX1R:              ;(8)
00197E DEF4 47               4      LD  B,A
00197F DEF5 B1               4      OR  C
001980 DEF6 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
001981 DEF7 B2               4      OR  D
001982 DEF8 B3               4      OR  E
001983 DEF9 C0              11      RET NZ
001984 DEFA 37               4      SCF
001985 DEFB C9              10      RET
                                
       DEFC                     RBX2:               ;Cluster settings
001986 DEFC FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001989 DEFF FD4E23          19      LD  C,(IY+35)
00198C DF02 0600             7      LD  B,0
00198E DF04 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001992 DF08 2003            12      JR  NZ,RBX3
001994 DF0A FD4624          19      LD  B,(IY+36)
       DF0D                     RBX3:
001997 DF0D CD41DC          17      CALL    RWXR
00199A DF10 3A32DF          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
00199D DF13 3D               4      DEC A
00199E DF14 FDA622          19      AND (IY+34)
0019A1 DF17 FDB621          19      OR  (IY+33)
0019A4 DF1A C9              10      RET
                                
       DF1B                     RBXA:
0019A5 DF1B C5              11      PUSH    BC
0019A6 DF1C D5              11      PUSH    DE
0019A7 DF1D CD55DA          17      CALL    CLUSTX
0019AA DF20 CD26E0          17      CALL    DRDX
0019AD DF23 D1              10      POP DE
0019AE DF24 C1              10      POP BC
0019AF DF25 D4C5E1          17      CALL    NC,GNCLX
0019B2 DF28 D8              11      RET C
0019B3 DF29 ED53FEE7        20      LD  (_CLPS),DE
                                
0019B7 DF2D FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
0019BA DF30 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       DF31                     SECSZ   EQU $-2
       DF32                     SECSZ_H EQU $-1
0019BD DF33 7C               4      LD  A,H
0019BE DF34 3D               4      DEC A       ;1024=3 / 512=1
0019BF DF35 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
0019C2 DF38 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
0019C3 DF39 ED42            15      SBC HL,BC       ;残りを計算
                                
0019C5 DF3B ED5B5DE6        20      LD  DE,(LEFTX)
0019C9 DF3F ED52            15      SBC HL,DE       ;CP HL,DE
0019CB DF41 19              11      ADD HL,DE       ;
0019CC DF42 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
0019CE DF44 EB               4      EX  DE,HL
       DF45                     RBXA1:
0019CF DF45 E5              11      PUSH    HL
0019D0 DF46 2A7EE7          16      LD  HL,(_DTBUF)
0019D3 DF49 09              11      ADD HL,BC
0019D4 DF4A ED5B5FE6        20      LD  DE,(DTAX)
0019D8 DF4E C1              10      POP BC
0019D9 DF4F C9              10      RET
                                
       DF50                     RBXB:
0019DA DF50 2A5FE6          16      LD  HL,(DTAX)
0019DD DF53 ED5BFEE7        20      LD  DE,(_CLPS)
0019E1 DF57 3A5EE6          13      LD  A,(LEFTX+1)
0019E4 DF5A 47               4      LD  B,A
0019E5 DF5B 3A32DF          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       DF5E                     RBXB1:
0019E8 DF5E 1F               4      RRA     ;->CF
0019E9 DF5F 3804            12      JR  C,RBXB2
0019EB DF61 CB38             8      SRL B   ;B=B/2
0019ED DF63 18F9            12      JR  RBXB1
       DF65                     RBXB2:
0019EF DF65 78               4      LD  A,B
0019F0 DF66 B7               4      OR  A
0019F1 DF67 C9              10      RET
                                ;(12)
       DF68                     RBXC:
0019F2 DF68 ED4B5DE6        20      LD  BC,(LEFTX)
0019F6 DF6C 3A32DF          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
0019F9 DF6F 3D               4      DEC A
0019FA DF70 A0               4      AND B
0019FB DF71 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
0019FC DF72 B1               4      OR  C
0019FD DF73 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       DF74                     DWTC:
0019FE DF74 E5              11      PUSH    HL
0019FF DF75 215CE3          10      LD  HL,DWT24B
001A02 DF78 1804            12      JR  DWTC1
       DF7A                     DRDC:
001A04 DF7A E5              11      PUSH    HL
001A05 DF7B 214EE3          10      LD  HL,DRD24B
       DF7E                     DWTC1:
001A08 DF7E 22D8DF          16      LD  (DRWF_MODE),HL
001A0B DF81 E1              10      POP HL
001A0C DF82 3AC8DF          13      LD  A,(DRWF_B)
001A0F DF85 B7               4      OR  A
001A10 DF86 200F            12      JR  NZ,DRDC1
       DF88                     SAVE_DRWC:
001A12 DF88 0601             7      LD  B,1
001A14 DF8A ED43C7DF        20      LD  (DRWF_C),BC
001A18 DF8E ED53CEDF        20      LD  (DRWF_E),DE
001A1C DF92 22D1DF          16      LD  (DRWF_HL),HL
001A1F DF95 1820            12      JR  INC_HL_DRWC
       DF97                     DRDC1:
001A21 DF97 E5              11      PUSH    HL
001A22 DF98 21CEDF          10      LD  HL,DRWF_E
001A25 DF9B 86               7      ADD A,(HL)
001A26 DF9C F5              11      PUSH    AF
001A27 DF9D BB               4      CP  E
001A28 DF9E 201D            12      JR  NZ,DRDC2
001A2A DFA0 F1              10      POP AF
001A2B DFA1 23               6      INC HL
001A2C DFA2 7E               7      LD  A,(HL)
001A2D DFA3 CE00             7      ADC A,0
001A2F DFA5 F5              11      PUSH    AF
001A30 DFA6 BA               4      CP  D
001A31 DFA7 2014            12      JR  NZ,DRDC2
001A33 DFA9 F1              10      POP AF
001A34 DFAA 3AC7DF          13      LD  A,(DRWF_C)
001A37 DFAD CE00             7      ADC A,0
001A39 DFAF B9               4      CP  C
001A3A DFB0 200C            12      JR  NZ,DRDC3
001A3C DFB2 21C8DF          10      LD  HL,DRWF_B
001A3F DFB5 34              11      INC (HL)
001A40 DFB6 E1              10      POP HL
       DFB7                     INC_HL_DRWC:
001A41 DFB7 3A32DF          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
001A44 DFBA 84               4      ADD A,H
001A45 DFBB 67               4      LD  H,A
001A46 DFBC C9              10      RET
       DFBD                     DRDC2:
001A47 DFBD F1              10      POP AF
       DFBE                     DRDC3:
001A48 DFBE CDC4DF          17      CALL    DRW_FLUSH
001A4B DFC1 E1              10      POP HL
001A4C DFC2 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       DFC4                     DRW_FLUSH:
001A4E DFC4 C5              11      PUSH    BC
001A4F DFC5 D5              11      PUSH    DE
001A50 DFC6 010000          10      LD  BC,0
       DFC7                     DRWF_C  EQU $-2
       DFC8                     DRWF_B  EQU $-1
001A53 DFC9 78               4      LD  A,B
001A54 DFCA B7               4      OR  A
001A55 DFCB 280D            12      JR  Z,DRDF1
001A57 DFCD 110000          10      LD  DE,0
       DFCE                     DRWF_E  EQU $-2
       DFCF                     DRWF_D  EQU $-1
001A5A DFD0 210000          10      LD  HL,0
       DFD1                     DRWF_HL EQU $-2
001A5D DFD3 AF               4      XOR A
001A5E DFD4 32C8DF          13      LD  (DRWF_B),A
001A61 DFD7 CD4EE3          17      CALL    DRD24B
       DFD8                     DRWF_MODE   EQU $-2
       DFDA                     DRDF1:
001A64 DFDA D1              10      POP DE
001A65 DFDB C1              10      POP BC
001A66 DFDC C9              10      RET
                                
       DFDD                     RB_WRITE:
001A67 DFDD C5              11      PUSH    BC
001A68 DFDE 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
001A6A DFE0 1803            12      JR  RBRW
       DFE2                     RB_READ:
001A6C DFE2 C5              11      PUSH    BC
001A6D DFE3 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       DFE5                     RBRW:
001A6F DFE5 1F               4      RRA     ;AHL = AHL*128
001A70 DFE6 7C               4      LD  A,H ;AHL = AHL0/2
001A71 DFE7 1F               4      RRA     ;A
001A72 DFE8 65               4      LD  H,L ;
001A73 DFE9 CB1C             8      RR  H   ;H
001A75 DFEB 2E00             7      LD  L,0 ;
001A77 DFED CB1D             8      RR  L   ;L
001A79 DFEF CDFADC          17      CALL    SET_RR_AHL
001A7C DFF2 218000          10      LD  HL,128
001A7F DFF5 C5              11      PUSH    BC
       DFF6                     SETSEQ_SWC_RND:
001A80 DFF6 CD29DD          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
001A83 DFF9 C1              10      POP BC
001A84 DFFA FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
001A88 DFFE FDE5            15      PUSH    IY
001A8A E000 D1              10      POP DE
001A8B E001 D5              11      PUSH    DE
001A8C E002 CDD7CF          17      CALL    BDOS0
001A8F E005 FDE1            14      POP IY
001A91 E007 CD04DD          17      CALL    SETSEQ      ;SETSEQ or POPRR
       E008                     SETSEQ_SWC_SEQ_RR   EQU $-2
001A94 E00A FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
001A98 E00E C1              10      POP BC
001A99 E00F C9              10      RET
                                
                                ;(22)
       E010                     INIT_SEQ:
001A9A E010 3E01             7      LD  A,1     ;LD BC,????
001A9C E012 2104DD          10      LD  HL,SETSEQ
001A9F E015 CDCADC          17      CALL    PUSHRR
       E018                     GETSEQ:
001AA2 E018 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
001AA5 E01B FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
001AA8 E01E AF               4      XOR A
                                
001AA9 E01F CB25             8      SLA L   ;L=L*2
                                
001AAB E021 CB3C             8      SRL H   ;HL=HL/2
001AAD E023 CB1D             8      RR  L   ;
001AAF E025 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E026                     DRDX:
001AB0 E026 CD64E0          17      CALL    DRDY
001AB3 E029 C8              11      RET Z
001AB4 E02A CD4AE0          17      CALL    DRDX1       ;データバッファの情報を保存
001AB7 E02D D8              11      RET C
001AB8 E02E E5              11      PUSH    HL
001AB9 E02F C5              11      PUSH    BC
001ABA E030 D5              11      PUSH    DE
001ABB E031 2A7EE7          16      LD  HL,(_DTBUF)
001ABE E034 3A8DE0          13      LD  A,(_DBS24)
001AC1 E037 4F               4      LD  C,A
001AC2 E038 CD4CE3          17      CALL    DRD24
001AC5 E03B DC5FE0          17      CALL    C,DRDNE
       E03E                     POP_DE_BC_HL_RET:
001AC8 E03E D1              10      POP DE
001AC9 E03F C1              10      POP BC
001ACA E040 E1              10      POP HL
001ACB E041 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E042                     DRDN:
001ACC E042 AF               4      XOR A
001ACD E043 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
001ACE E044 30E0            12      JR  NC,DRDX
       E046                     DRDNX:
001AD0 E046 CD64E0          17      CALL    DRDY
001AD3 E049 C8              11      RET Z
       E04A                     DRDX1:
001AD4 E04A CD7AE0          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
001AD7 E04D ED53A6E6        20      LD  (_DBSEC),DE
001ADB E051 79               4      LD  A,C
001ADC E052 328DE0          13      LD  (_DBS24),A
                                
001ADF E055 3A88E6          13      LD  A,(_DRV)
001AE2 E058 32A5E6          13      LD  (_DBDRV),A
001AE5 E05B CDD9E6          17      CALL    _CHGDRV
001AE8 E05E D0              11      RET NC
       E05F                     DRDNE:
001AE9 E05F 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001AEA E060 32A5E6          13      LD  (_DBDRV),A
001AED E063 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E064                     DRDY:
001AEE E064 3A8DE0          13      LD  A,(_DBS24)
001AF1 E067 B9               4      CP  C
001AF2 E068 C0              11      RET NZ
                                
001AF3 E069 E5              11      PUSH    HL
001AF4 E06A 3A88E6          13      LD  A,(_DRV)
001AF7 E06D 21A5E6          10      LD  HL,_DBDRV
001AFA E070 AE               7      XOR (HL)
001AFB E071 2005            12      JR  NZ,POP_HL_RET
                                
001AFD E073 2AA6E6          16      LD  HL,(_DBSEC)
001B00 E076 ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E078                     POP_HL_RET:
001B02 E078 E1              10      POP HL
001B03 E079 C9              10      RET
                                
       E07A                     DWTX:
001B04 E07A 3AA4E6          13      LD  A,(_WTDBF)
001B07 E07D B7               4      OR  A
001B08 E07E C8              11      RET Z
001B09 E07F AF               4      XOR A
001B0A E080 32A4E6          13      LD  (_WTDBF),A
                                
001B0D E083 E5              11      PUSH    HL
001B0E E084 C5              11      PUSH    BC
001B0F E085 D5              11      PUSH    DE
001B10 E086 3AA5E6          13      LD  A,(_DBDRV)
001B13 E089 CDD9E6          17      CALL    _CHGDRV
001B16 E08C 0E00             7      LD  C,0
       E08D                     _DBS24  EQU $-1
001B18 E08E ED5BA6E6        20      LD  DE,(_DBSEC)
001B1C E092 2A7EE7          16      LD  HL,(_DTBUF)
001B1F E095 D45AE3          17      CALL    NC,DWT24
       E098                     POP_DE_BC_HL_RET2:
001B22 E098 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E09A                     RDFATX:
001B24 E09A E5              11      PUSH    HL
001B25 E09B 3A88E6          13      LD  A,(_DRV)
001B28 E09E 21AAE6          10      LD  HL,_FATDRV
001B2B E0A1 AE               7      XOR (HL)
001B2C E0A2 28D4            12      JR  Z,POP_HL_RET
                                
001B2E E0A4 C5              11      PUSH    BC
001B2F E0A5 D5              11      PUSH    DE
001B30 E0A6 DDE5            15      PUSH    IX
001B32 E0A8 CDC4E0          17      CALL    WTFATX
001B35 E0AB 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
001B37 E0AD AF               4      XOR A
001B38 E0AE 32ABE6          13      LD  (_FATIX),A
001B3B E0B1 3A88E6          13      LD  A,(_DRV)
001B3E E0B4 32AAE6          13      LD  (_FATDRV),A
001B41 E0B7 CDE5E6          17      CALL    _RDFAT
       E0BA                     RDFATE2:
001B44 E0BA 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
001B46 E0BC 9F               4      SBC A,A     ;A=0xFF
001B47 E0BD 32AAE6          13      LD  (_FATDRV),A
       E0C0                     POP_IX_DE_BC_HL_RET:
001B4A E0C0 DDE1            14      POP IX
001B4C E0C2 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E0C4                     WTFATX:
001B4E E0C4 3AA2E6          13      LD  A,(_WTFATF)
001B51 E0C7 B7               4      OR  A
001B52 E0C8 C8              11      RET Z
001B53 E0C9 AF               4      XOR A
001B54 E0CA 32A2E6          13      LD  (_WTFATF),A
                                
001B57 E0CD E5              11      PUSH    HL
001B58 E0CE 3AAAE6          13      LD  A,(_FATDRV)
001B5B E0D1 21A5E6          10      LD  HL,_DBDRV
001B5E E0D4 AE               7      XOR (HL)
001B5F E0D5 CC7AE0          17      CALL    Z,DWTX
001B62 E0D8 389E            12      JR  C,POP_HL_RET
001B64 E0DA C5              11      PUSH    BC
001B65 E0DB D5              11      PUSH    DE
001B66 E0DC DDE5            15      PUSH    IX
001B68 E0DE CD6BE3          17      CALL    FATSETUP
001B6B E0E1 D45CE3          17      CALL    NC,DWT24B
001B6E E0E4 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E0E6                     N16CL1:
001B70 E0E6 7A               4      LD  A,D
001B71 E0E7 B3               4      OR  E
001B72 E0E8 37               4      SCF
001B73 E0E9 C8              11      RET Z
                                
001B74 E0EA 7A               4      LD  A,D
001B75 E0EB 1807            12      JR  NCL1X
       E0ED                     NCL1:
001B77 E0ED 7A               4      LD  A,D
001B78 E0EE B3               4      OR  E
001B79 E0EF 37               4      SCF
001B7A E0F0 C8              11      RET Z
                                
001B7B E0F1 7A               4      LD  A,D
001B7C E0F2 CB3F             8      SRL A   ;/2
       E0F4                     NCL1X:
001B7E E0F4 CB3F             8      SRL A   ;/2
                                
001B80 E0F6 E5              11      PUSH    HL
001B81 E0F7 3216E1          13      LD  (NCLPAT_FATIX),A    ;_FATIX
001B84 E0FA 2AAAE6          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001B87 E0FD BC               4      CP  H
001B88 E0FE 3A88E6          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001B8B E101 3215E1          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001B8E E104 2005            12      JR  NZ,NCL2     ;FATIXが違う
001B90 E106 BD               4      CP  L
001B91 E107 2002            12      JR  NZ,NCL2     ;ドライブが違う
001B93 E109 E1              10      POP HL
001B94 E10A C9              10      RET
       E10B                     NCL2:
001B95 E10B C5              11      PUSH    BC
001B96 E10C D5              11      PUSH    DE
001B97 E10D DDE5            15      PUSH    IX
001B99 E10F CDC4E0          17      CALL    WTFATX
001B9C E112 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
001B9E E114 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E116                     NCLPAT_FATIX    EQU $-1
       E115                     NCLPAT_FATDRV   EQU $-2
001BA1 E117 ED43AAE6        20      LD  (_FATDRV),BC
001BA5 E11B CD40E3          17      CALL    RDFATS
001BA8 E11E 189A            12      JR  RDFATE2
                                
       E120                     NCL3:
001BAA E120 CB9A             8      RES 3,D
001BAC E122 CB92             8      RES 2,D
001BAE E124 6B               4      LD  L,E
001BAF E125 62               4      LD  H,D
001BB0 E126 CB3C             8      SRL H   ;
001BB2 E128 CB1D             8      RR  L   ;HLA=HLA/2
001BB4 E12A 1F               4      RRA     ;
001BB5 E12B F5              11      PUSH    AF
001BB6 E12C 3AABE6          13      LD  A,(_FATIX)
001BB9 E12F 0F               4      RRCA
001BBA E130 300B            12      JR  NC,NCL3X1
001BBC E132 3A32DF          13      LD  A,(SECSZ_H)
001BBF E135 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの際に先頭を512バイトずらす
001BC1 E137 2004            12      JR  NZ,NCL3X1
001BC3 E139 010002          10      LD  BC,512
001BC6 E13C 09              11      ADD HL,BC
       E13D                     NCL3X1:
001BC7 E13D F1              10      POP AF
001BC8 E13E ED4B7CE7        20      LD  BC,(_FATBF)
001BCC E142 19              11      ADD HL,DE
001BCD E143 09              11      ADD HL,BC
001BCE E144 17               4      RLA
001BCF E145 C9              10      RET
                                
       E146                     GNCL:
001BD0 E146 CDEDE0          17      CALL    NCL1        ;GET NEXT CLUSTER
001BD3 E149 D8              11      RET C
001BD4 E14A C5              11      PUSH    BC
001BD5 E14B E5              11      PUSH    HL
001BD6 E14C CD20E1          17      CALL    NCL3
001BD9 E14F 3809            12      JR  C,GNC1
001BDB E151 5E               7      LD  E,(HL)
001BDC E152 23               6      INC HL
001BDD E153 7E               7      LD  A,(HL)
001BDE E154 E60F             7      AND 00FH
001BE0 E156 57               4      LD  D,A
001BE1 E157 E1              10      POP HL
001BE2 E158 C1              10      POP BC
001BE3 E159 C9              10      RET
       E15A                     GNC1:
001BE4 E15A 7E               7      LD  A,(HL)
001BE5 E15B 23               6      INC HL
001BE6 E15C 56               7      LD  D,(HL)
001BE7 E15D 0604             7      LD  B,4
       E15F                     GNC1L:
001BE9 E15F CB3A             8      SRL D   ;DA=DA/2
001BEB E161 1F               4      RRA     ;
001BEC E162 10FB            13      DJNZ    GNC1L
                                
001BEE E164 5F               4      LD  E,A
001BEF E165 E1              10      POP HL
001BF0 E166 C1              10      POP BC
001BF1 E167 A7               4      AND A
001BF2 E168 C9              10      RET
                                
       E169                     SNCL:
001BF3 E169 CDEDE0          17      CALL    NCL1
001BF6 E16C D8              11      RET C
                                ;               SET NEXT CLUSTER
001BF7 E16D E5              11      PUSH    HL
001BF8 E16E C5              11      PUSH    BC
001BF9 E16F D5              11      PUSH    DE
001BFA E170 E5              11      PUSH    HL
001BFB E171 CD20E1          17      CALL    NCL3
001BFE E174 D1              10      POP DE
                                ;CF=ODD
001BFF E175 7E               7      LD  A,(HL)
001C00 E176 73               7      LD  (HL),E
001C01 E177 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
001C03 E179 23               6      INC HL
001C04 E17A ED67            18      RRD     ;M={A[3:0],E[3:0]}
001C06 E17C 7A               4      LD  A,D
001C07 E17D 1804            12      JR  SNC11
       E17F                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
001C09 E17F ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001C0B E181 23               6      INC HL
001C0C E182 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E183                     SNC11:
001C0D E183 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
001C0F E185 B7               4      OR  A
001C10 E186 D1              10      POP DE
001C11 E187 C1              10      POP BC
001C12 E188 E1              10      POP HL
       E189                     FAT_CHANGED:
001C13 E189 3EFF             7      LD  A,0FFH
001C15 E18B 32A2E6          13      LD  (_WTFATF),A
001C18 E18E C9              10      RET
                                
       E18F                     N16CL3:
001C19 E18F C5              11      PUSH    BC
001C1A E190 6B               4      LD  L,E
001C1B E191 7A               4      LD  A,D
001C1C E192 E601             7      AND 1
001C1E E194 67               4      LD  H,A
001C1F E195 29              11      ADD HL,HL
001C20 E196 ED4B7CE7        20      LD  BC,(_FATBF)
001C24 E19A 09              11      ADD HL,BC
001C25 E19B C1              10      POP BC
001C26 E19C C9              10      RET
                                
       E19D                     GNCL16:
001C27 E19D CDE6E0          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
001C2A E1A0 D8              11      RET C
001C2B E1A1 E5              11      PUSH    HL
001C2C E1A2 CD8FE1          17      CALL    N16CL3
001C2F E1A5 5E               7      LD  E,(HL)
001C30 E1A6 23               6      INC HL
001C31 E1A7 56               7      LD  D,(HL)
001C32 E1A8 E1              10      POP HL
001C33 E1A9 C9              10      RET
                                
       E1AA                     SNCL16:
001C34 E1AA CDE6E0          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
001C37 E1AD D8              11      RET C
001C38 E1AE D5              11      PUSH    DE
001C39 E1AF E5              11      PUSH    HL
001C3A E1B0 CD8FE1          17      CALL    N16CL3
001C3D E1B3 D1              10      POP DE      ;HL
001C3E E1B4 73               7      LD  (HL),E
001C3F E1B5 23               6      INC HL
001C40 E1B6 72               7      LD  (HL),D
001C41 E1B7 6B               4      LD  L,E
001C42 E1B8 62               4      LD  H,D
001C43 E1B9 D1              10      POP DE
001C44 E1BA 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E1BC                     NEXTX:
001C46 E1BC 3E00             7      LD  A,0 ;自己書き換え
       E1BD                     _SECPS  EQU $-1
001C48 E1BE 3C               4      INC A
001C49 E1BF E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E1C0                     _NCPAT  EQU $-1
001C4B E1C1 32BDE1          13      LD  (_SECPS),A
001C4E E1C4 C9              10      RET
                                
       E1C5                     GNCLX:
001C4F E1C5 CDBCE1          17      CALL    NEXTX
001C52 E1C8 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001C53 E1C9 C3F7E6          10      JP  _GNCL   ;次のクラスタを探す
                                
       E1CC                     RDFAT:
001C56 E1CC 3E80             7      LD  A,080H
001C58 E1CE 3270E6          13      LD  (CHECK),A
       E1D1                     RDFAT1:
001C5B E1D1 3A88E6          13      LD  A,(_DRV)
001C5E E1D4 CD74E4          17      CALL    CHGDRVR
001C61 E1D7 D8              11      RET C
001C62 E1D8 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001C65 E1DB CB6F             8      BIT 5,A
001C67 E1DD 286C            12      JR  Z,RDFAT0X
001C69 E1DF 2170E6          10      LD  HL,CHECK
001C6C E1E2 A6               7      AND (HL)
001C6D E1E3 77               7      LD  (HL),A
001C6E E1E4 110000          10      LD  DE,0        ;BPB
001C71 E1E7 2A7CE7          16      LD  HL,(_FATBF)
001C74 E1EA 0E00             7      LD  C,0
001C76 E1EC CD4CE3          17      CALL    DRD24
001C79 E1EF 3022            12      JR  NC,GETBPB
001C7B E1F1 2170E6          10      LD  HL,CHECK
001C7E E1F4 CB06            15      RLC (HL)
001C80 E1F6 3F               4      CCF
001C81 E1F7 D8              11      RET C
001C82 E1F8 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
001C86 E1FC 3F               4      CCF         ;フロッピーディスクのFDモード(2D/2HD)を切り替える
001C87 E1FD DDCB0A16        23      RL  (IX+DPB_FDMODE)
001C8B E201 3A84E6          13      LD  A,(_DRIVE)
001C8E E204 E603             7      AND 3
001C90 E206 F680             7      OR  080H
001C92 E208 6F               4      LD  L,A
001C93 E209 26E6             7      LD  H,_CYL0/256
001C95 E20B 3EFF             7      LD  A,0FFH
001C97 E20D 3289E6          13      LD  (_DSK),A
001C9A E210 77               7      LD  (HL),A
001C9B E211 18BE            12      JR  RDFAT1
       E213                     GETBPB:
001C9D E213 FDE5            15      PUSH    IY
001C9F E215 FD2A7CE7        20      LD  IY,(_FATBF) ;BPB
001CA3 E219 CDF1E6          17      CALL    _BPB2DPB
001CA6 E21C FDE1            14      POP IY
001CA8 E21E DD7E12          19      LD  A,(IX+DPB_DEVICE)
001CAB E221 3025            12      JR  NC,GETBPBOK
001CAD E223 E60F             7      AND 00FH
001CAF E225 FE07             7      CP  7
001CB1 E227 37               4      SCF
001CB2 E228 C0              11      RET NZ
001CB3 E229 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001CB7 E22D 21C0E7          10      LD  HL,M2D
001CBA E230 2006            12      JR  NZ,SETFDMODE
001CBC E232 CD25E3          17      CALL    CHECK1024
001CBF E235 D8              11      RET C
001CC0 E236 2ED2             7      LD  L,M2HD-STABLE
       E238                     SETFDMODE:
001CC2 E238 DDE5            15      PUSH    IX
001CC4 E23A D1              10      POP DE
001CC5 E23B EDA0            16      LDI
001CC7 E23D EDA0            16      LDI
001CC9 E23F 13               6      INC DE
001CCA E240 13               6      INC DE
001CCB E241 13               6      INC DE
001CCC E242 13               6      INC DE
001CCD E243 010C00          10      LD  BC,12
001CD0 E246 EDB0                    LDIR
       E248                     GETBPBOK:
001CD2 E248 CDE0E3          17      CALL    CHGDRV2
       E24B                     RDFAT0X:
001CD5 E24B CD40E3          17      CALL    RDFATS
001CD8 E24E D8              11      RET C
001CD9 E24F DDAE06          19      XOR (IX+DPB_FATID)
001CDC E252 C8              11      RET Z
001CDD E253 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001CE0 E256 CB5F             8      BIT 3,A
001CE2 E258 2803            12      JR  Z,RDFAT0X1
001CE4 E25A CB6F             8      BIT 5,A
001CE6 E25C C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E25D                     RDFAT0X1:
001CE7 E25D 37               4      SCF
001CE8 E25E C9              10      RET
                                
       E25F                     POP_HL_SCF_RET:
001CE9 E25F E1              10      POP HL
001CEA E260 37               4      SCF
001CEB E261 C9              10      RET
                                
       E262                     BPB2DPB:
001CEC E262 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
001CEF E265 B7               4      OR  A
001CF0 E266 37               4      SCF
001CF1 E267 C0              11      RET NZ
       E268                     BPBOK:
001CF2 E268 FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001CF5 E26B DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001CF8 E26E FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001CFB E271 DD7700          19      LD  (IX+DPB_FATLN),A
001CFE E274 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
001D01 E277 DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
001D04 E27A FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001D07 E27D FD660F          19      LD  H,(IY+15)
001D0A E280 DD750E          19      LD  (IX+DPB_FATPS),L
001D0D E283 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001D10 E286 FD5617          19      LD  D,(IY+23)
001D13 E289 FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E28C                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001D16 E28C 19              11      ADD HL,DE
001D17 E28D 10FD            13      DJNZ    BPBDP1
       E28F                     BPBDP2:
001D19 E28F DD7510          19      LD  (IX+DPB_DIRPS),L
001D1C E292 DD7411          19      LD  (IX+DPB_DIRPS+1),H
001D1F E295 E5              11      PUSH    HL
                                
001D20 E296 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
001D23 E299 FD6612          19      LD  H,(IY+18)
001D26 E29C FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001D29 E29F B7               4      OR  A
001D2A E2A0 28BD            12      JR  Z,POP_HL_SCF_RET
001D2C E2A2 0606             7      LD  B,6
       E2A4                     BPBBPS1:
001D2E E2A4 05               4      DEC B
001D2F E2A5 0F               4      RRCA
001D30 E2A6 30FC            12      JR  NC,BPBBPS1
       E2A8                     BPBDE1:
001D32 E2A8 29              11      ADD HL,HL
001D33 E2A9 10FD            13      DJNZ    BPBDE1
                                
001D35 E2AB 7C               4      LD  A,H
001D36 E2AC DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
001D39 E2AF D1              10      POP DE      ;DPB_DIRPS
001D3A E2B0 6C               4      LD  L,H
001D3B E2B1 2600             7      LD  H,0
001D3D E2B3 19              11      ADD HL,DE       ;MAXDIR
001D3E E2B4 E5              11      PUSH    HL
001D3F E2B5 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001D42 E2B8 CB21             8      SLA C       ;*2
001D44 E2BA AF               4      XOR A
001D45 E2BB 47               4      LD  B,A
001D46 E2BC ED42            15      SBC HL,BC
001D48 E2BE DD7514          19      LD  (IX+DPB_ADDCL),L
001D4B E2C1 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
001D4E E2C4 D1              10      POP DE      ;DE=DPB_MAXDIR
001D4F E2C5 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001D52 E2C8 FD6614          19      LD  H,(IY+20)
                                
001D55 E2CB DD7E12          19      LD  A,(IX+DPB_DEVICE)
001D58 E2CE E60F             7      AND 00FH
001D5A E2D0 FE07             7      CP  7       ;フロッピー
001D5C E2D2 2019            12      JR  NZ,NOT_FD
001D5E E2D4 E5              11      PUSH    HL
001D5F E2D5 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001D62 E2D8 DD710D          19      LD  (IX+DPB_MAXSEC),C
001D65 E2DB AF               4      XOR A
001D66 E2DC CB21             8      SLA C       ;両面なのでセクタ数を２倍
001D68 E2DE 0610             7      LD  B,16
       E2E0                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001D6A E2E0 29              11      ADD HL,HL
001D6B E2E1 17               4      RLA
001D6C E2E2 B9               4      CP  C
001D6D E2E3 3802            12      JR  C,DIVSEC1
001D6F E2E5 91               4      SUB C
001D70 E2E6 2C               4      INC L
       E2E7                     DIVSEC1:
001D71 E2E7 10F7            13      DJNZ    DIVSEC
001D73 E2E9 DD750C          19      LD  (IX+DPB_MAXCYL),L
001D76 E2EC E1              10      POP HL  ;ここまでフロッピー専用
       E2ED                     NOT_FD:
001D77 E2ED 7C               4      LD  A,H
001D78 E2EE B5               4      OR  L
001D79 E2EF 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001D7B E2F1 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001D7D E2F3 2F               4      CPL         ;A=0FFH
001D7E E2F4 FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001D81 E2F7 D8              11      RET C
001D82 E2F8 FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001D85 E2FB FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001D88 E2FE FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E301                     BPB16BIT:
001D8B E301 ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001D8D E303 DE00             7      SBC A,0
001D8F E305 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E308                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001D92 E308 CB18             8      RR  B       ;->CY
001D94 E30A 3808            12      JR  C,BPBTC2
001D96 E30C CB3F             8      SRL A
001D98 E30E CB1C             8      RR  H       ;AHL=AHL/2
001D9A E310 CB1D             8      RR  L
001D9C E312 18F4            12      JR  BPBTC1
       E314                     BPBTC2:
001D9E E314 C6FF             7      ADD A,0FFH
001DA0 E316 D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001DA1 E317 23               6      INC HL
001DA2 E318 23               6      INC HL
001DA3 E319 DD7508          19      LD  (IX+DPB_MAXCL),L
001DA6 E31C DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001DA9 E31F FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001DAC E322 DD7706          19      LD  (IX+DPB_FATID),A
       E325                     CHECK1024:
001DAF E325 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001DB2 E328 C6FE             7      ADD A,0-2       ;>2:CF=1
001DB4 E32A FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001DB7 E32D 6F               4      LD  L,A
001DB8 E32E 3002            12      JR  NC,BPBFAT1
001DBA E330 F680             7      OR  080H
       E332                     BPBFAT1:            ;ここではCF=0
001DBC E332 DD770F          19      LD  (IX+DPB_BPS),A
001DBF E335 3A7BE7          13      LD  A,(_MAX_SEC_SZ_H)
001DC2 E338 BD               4      CP  L
001DC3 E339 C8              11      RET Z       ;1セクタ1024バイト
001DC4 E33A 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001DC5 E33B C8              11      RET Z       ;1セクタ256バイト
001DC6 E33C 2D               4      DEC L
001DC7 E33D C8              11      RET Z       ;1セクタ512バイト
001DC8 E33E 37               4      SCF
001DC9 E33F C9              10      RET
                                
       E340                     RDFATS:
001DCA E340 CD6BE3          17      CALL    FATSETUP
001DCD E343 D8              11      RET C
001DCE E344 CD4EE3          17      CALL    DRD24B
001DD1 E347 2A7CE7          16      LD  HL,(_FATBF)
001DD4 E34A 7E               7      LD  A,(HL)
001DD5 E34B C9              10      RET
                                
       E34C                     DRD24:
001DD6 E34C 0601             7      LD  B,1
       E34E                     DRD24B:
001DD8 E34E DDE5            15      PUSH    IX
001DDA E350 DD2AA8E6        20      LD  IX,(_DPB)
001DDE E354 CD09CB          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E355                     DRDPAT  EQU $-2
001DE1 E357 DDE1            14      POP IX
001DE3 E359 C9              10      RET
                                
       E35A                     DWT24:
001DE4 E35A 0601             7      LD  B,1
       E35C                     DWT24B:
001DE6 E35C DDE5            15      PUSH    IX
001DE8 E35E DD2AA8E6        20      LD  IX,(_DPB)
001DEC E362 CDB7E4          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E363                     DWTPAT  EQU $-2
001DEF E365 DDE1            14      POP IX
001DF1 E367 D0              11      RET NC
001DF2 E368 C35AE6          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E36B                     FATSETUP:
001DF5 E36B 3AAAE6          13      LD  A,(_FATDRV)
001DF8 E36E CD74E4          17      CALL    CHGDRVR     ;ドライブ切り替え
001DFB E371 D8              11      RET C
       E372                     FATS2:
001DFC E372 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001DFF E375 0F               4      RRCA
001E00 E376 CDA6E3          17      CALL    FATSETUP12  ;自己書き換え
       E377                     FATSX   EQU $-2
001E03 E379 210000          10      LD  HL,0
001E06 E37C 4A               4      LD  C,D
001E07 E37D 54               4      LD  D,H
001E08 E37E 3AABE6          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
001E0B E381 47               4      LD  B,A
001E0C E382 04               4      INC B
001E0D E383 DD7E00          19      LD  A,(IX+DPB_FATLN)
       E386                     FAT_SKP:
001E10 E386 05               4      DEC B
001E11 E387 2809            12      JR  Z,FAT1
001E13 E389 19              11      ADD HL,DE
001E14 E38A 93               4      SUB E
001E15 E38B 30F9            12      JR  NC,FAT_SKP
001E17 E38D DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
001E1B E391 C8              11      RET Z
       E392                     FAT1:
001E1C E392 EB               4      EX  DE,HL
001E1D E393 B7               4      OR  A       ;0の場合は0100Hとして扱う
001E1E E394 2803            12      JR  Z,FAT3
001E20 E396 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001E21 E397 3801            12      JR  C,FAT2
       E399                     FAT3:
001E23 E399 79               4      LD  A,C
       E39A                     FAT2:
001E24 E39A 47               4      LD  B,A
                                
001E25 E39B 2AFAE7          16      LD  HL,(_FATPS) ;fat sector pos
001E28 E39E 19              11      ADD HL,DE
001E29 E39F EB               4      EX  DE,HL
001E2A E3A0 2A7CE7          16      LD  HL,(_FATBF)
001E2D E3A3 AF               4      XOR A       ;CF=0
001E2E E3A4 4F               4      LD  C,A
001E2F E3A5 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E3A6                     FATSETUP12:
001E30 E3A6 110606          10      LD  DE,0606H    ;256
001E33 E3A9 D8              11      RET C
001E34 E3AA 110303          10      LD  DE,0303H    ;512
001E37 E3AD 0F               4      RRCA
001E38 E3AE D8              11      RET C
001E39 E3AF 110102          10      LD  DE,0201H    ;1024
001E3C E3B2 C9              10      RET
                                
       E3B3                     FATSETUP16:
001E3D E3B3 110404          10      LD  DE,0404H    ;256
001E40 E3B6 D8              11      RET C
001E41 E3B7 110202          10      LD  DE,0202H    ;512
001E44 E3BA 0F               4      RRCA
001E45 E3BB D8              11      RET C
001E46 E3BC 110101          10      LD  DE,0101H    ;1024
001E49 E3BF C9              10      RET
                                
       E3C0                     CHGDRV:
001E4A E3C0 E5              11      PUSH    HL
001E4B E3C1 2189E6          10      LD  HL,_DSK
001E4E E3C4 BE               7      CP  (HL)
001E4F E3C5 280A            12      JR  Z,CHGDRVE
       E3C7                     CHGDRV1:
001E51 E3C7 DDE5            15      PUSH    IX
001E53 E3C9 CDD3E3          17      CALL    CHGDRV0
001E56 E3CC 3A89E6          13      LD  A,(_DSK)
001E59 E3CF DDE1            14      POP IX
       E3D1                     CHGDRVE:
001E5B E3D1 E1              10      POP HL
001E5C E3D2 C9              10      RET
                                
       E3D3                     CHGDRV0:
001E5D E3D3 6F               4      LD  L,A
001E5E E3D4 CDDCE6          17      CALL    _GETDPB
001E61 E3D7 D8              11      RET C
001E62 E3D8 DD22A8E6        20      LD  (_DPB),IX
001E66 E3DC 7D               4      LD  A,L
001E67 E3DD 3289E6          13      LD  (_DSK),A
       E3E0                     CHGDRV2:
001E6A E3E0 C5              11      PUSH    BC
001E6B E3E1 D5              11      PUSH    DE
001E6C E3E2 ED732BE4        20      LD  (SPPAT2),SP
001E70 E3E6 F3               4      DI
001E71 E3E7 DDF9            10      LD  SP,IX
                                
001E73 E3E9 E1              10      POP HL      ;00:DPB_FATLN
001E74 E3EA E1              10      POP HL      ;02:DPB_DRD
001E75 E3EB 2255E3          16      LD  (DRDPAT),HL
                                
001E78 E3EE E1              10      POP HL
001E79 E3EF 2263E3          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001E7C E3F2 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001E7D E3F3 7C               4      LD  A,H
001E7E E3F4 3259DA          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001E81 E3F7 3D               4      DEC A
001E82 E3F8 32C0E1          13      LD  (_NCPAT),A
                                
001E85 E3FB E1              10      POP HL      ;08:DPB_MAXCL
001E86 E3FC 7D               4      LD  A,L
001E87 E3FD 3278DA          13      LD  (CLPAT2),A
001E8A E400 7C               4      LD  A,H
001E8B E401 3274DA          13      LD  (CLPAT1),A
001E8E E404 2B               6      DEC HL
001E8F E405 2277DC          16      LD  (MAXCLP),HL
                                
001E92 E408 E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001E93 E409 4C               4      LD  C,H
                                
001E94 E40A E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001E95 E40B E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001E96 E40C 7C               4      LD  A,H     ;DPB_BPS
001E97 E40D E607             7      AND 7
001E99 E40F 3232DF          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001E9C E412 87               4      ADD A,A     ;8  4   2
001E9D E413 87               4      ADD A,A     ;010H   8   4
001E9E E414 87               4      ADD A,A     ;020H   010H    8
001E9F E415 32D7D8          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001EA2 E418 2600             7      LD  H,0
001EA4 E41A 22FAE7          16      LD  (_FATPS),HL
                                
001EA7 E41D E1              10      POP HL      ;10:DPB_DIRPS
001EA8 E41E 22FCE7          16      LD  (_DIRPS),HL
                                
001EAB E421 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001EAC E422 7C               4      LD  A,H
001EAD E423 3284E6          13      LD  (_DRIVE),A
                                
001EB0 E426 E1              10      POP HL      ;14:DPB_ADDCL
001EB1 E427 2269DA          16      LD  (CLSPAT),HL
                                
001EB4 E42A 310000          10      LD  SP,0        ;元のSPを復元
       E42B                     SPPAT2  EQU $-2
001EB7 E42D FB               4      EI
001EB8 E42E 2AFCE7          16      LD  HL,(_DIRPS)
001EBB E431 0600             7      LD  B,0
001EBD E433 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001EBE E434 22F2D8          16      LD  (MD_PAT),HL
                                
001EC1 E437 2A77DC          16      LD  HL,(MAXCLP)
001EC4 E43A 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001EC7 E43D 19              11      ADD HL,DE
001EC8 E43E 380F            12      JR  C,SETFAT16
001ECA E440 2146E1          10      LD  HL,GNCL     ;FAT12
001ECD E443 1169E1          10      LD  DE,SNCL
001ED0 E446 01A6E3          10      LD  BC,FATSETUP12
001ED3 E449 DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001ED7 E44D 180D            12      JR  EXTRA1
       E44F                     SETFAT16:
001ED9 E44F 219DE1          10      LD  HL,GNCL16   ;FAT16
001EDC E452 11AAE1          10      LD  DE,SNCL16
001EDF E455 01B3E3          10      LD  BC,FATSETUP16
001EE2 E458 DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       E45C                     EXTRA1:
001EE6 E45C 22F8E6          16      LD  (GNCPAT),HL
001EE9 E45F ED53FBE6        20      LD  (SNCPAT),DE
001EED E463 ED4377E3        20      LD  (FATSX),BC
001EF1 E467 D1              10      POP DE
001EF2 E468 C1              10      POP BC
001EF3 E469 AF               4      XOR A
001EF4 E46A C9              10      RET
                                
       E46B                     GETDPBD:
001EF5 E46B DDE3            23      EX  (SP),IX
001EF7 E46D DDE5            15      PUSH    IX
001EF9 E46F 3A88E6          13      LD  A,(_DRV)
001EFC E472 1807            12      JR  GETDPB1
                                
       E474                     CHGDRVR:
001EFE E474 CDD9E6          17      CALL    _CHGDRV
001F01 E477 D8              11      RET C
001F02 E478 3A89E6          13      LD  A,(_DSK)
       E47B                     GETDPB1:
001F05 E47B C3DCE6          10      JP  _GETDPB
                                
       E47E                     GETDPB:
001F08 E47E FE08             7      CP  8
001F0A E480 3F               4      CCF
001F0B E481 D8              11      RET C
001F0C E482 0F               4      RRCA
001F0D E483 0F               4      RRCA
001F0E E484 0F               4      RRCA
001F0F E485 DD                      DB  0DDH        ;Z80未定義命令
001F10 E486 6F               4      LD  L,A     ;LD IXL,A
001F11 E487 DD                      DB  0DDH        ;Z80未定義命令
001F12 E488 26E8             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001F14 E48A DD7E00          19      LD  A,(IX+DPB_FATLN)
001F17 E48D A7               4      AND A       ;CF=0の為
001F18 E48E DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001F1C E492 C0              11      RET NZ      ;FAT16
001F1D E493 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001F21 E497 C0              11      RET NZ      ;BPB
001F22 E498 FE01             7      CP  001H        ;A=0 THEN CF=1
001F24 E49A C9              10      RET
                                
       E49B                     _SYS5F:
001F25 E49B AF               4      XOR A
       E49C                     FFLUSH:
001F26 E49C F5              11      PUSH    AF
001F27 E49D CDC4E0          17      CALL    WTFATX
001F2A E4A0 AF               4      XOR A
001F2B E4A1 32ABE6          13      LD  (_FATIX),A
001F2E E4A4 2F               4      CPL         ;0FFH
001F2F E4A5 32AAE6          13      LD  (_FATDRV),A
001F32 E4A8 3E                      DB  03EH        ;次のPUSH AFをスキップ
       E4A9                     FFLUSHBUF:
001F33 E4A9 F5              11      PUSH    AF
001F34 E4AA CD7AE0          17      CALL    DWTX
001F37 E4AD 3EFF             7      LD  A,0FFH
001F39 E4AF 3239E6          13      LD  (SFILE),A
001F3C E4B2 32A5E6          13      LD  (_DBDRV),A
001F3F E4B5 F1              10      POP AF
001F40 E4B6 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "MSXDISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MSX
                                
                                ;   PHYDIO DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       E4B7                     WTTRK:
       E4B7                     FDWT:
001F41 E4B7 37               4      SCF
001F42 E4B8 C9              10      RET
                                
       E4B9                     PDWT:
001F43 E4B9 37               4      SCF
001F44 E4BA CB7C             8      BIT 7,H
001F46 E4BC 2058            12      JR  NZ,PDWX
001F48 E4BE CDA9E4          17      CALL    FFLUSHBUF
       E4C1                     PDWT1:
001F4B E4C1 C5              11      PUSH    BC
001F4C E4C2 D5              11      PUSH    DE
001F4D E4C3 ED5B7EE7        20      LD  DE,(_DTBUF)
001F51 E4C7 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001F54 E4CA E607             7      AND 7
001F56 E4CC 47               4      LD  B,A
001F57 E4CD 0E00             7      LD  C,0
001F59 E4CF EDB0                    LDIR
001F5B E4D1 E3              19      EX  (SP),HL
001F5C E4D2 EB               4      EX  DE,HL
001F5D E4D3 D5              11      PUSH    DE
001F5E E4D4 2A7EE7          16      LD  HL,(_DTBUF)
001F61 E4D7 0601             7      LD  B,1
001F63 E4D9 37               4      SCF
001F64 E4DA CD16E5          17      CALL    PDWX
001F67 E4DD 3832            12      JR  C,PDRWERR
001F69 E4DF D1              10      POP DE
001F6A E4E0 13               6      INC DE
001F6B E4E1 E1              10      POP HL
001F6C E4E2 C1              10      POP BC
001F6D E4E3 10D4            13      DJNZ    PDWT
001F6F E4E5 AF               4      XOR A
001F70 E4E6 C9              10      RET
       E4E7                     PDRD:
001F71 E4E7 CB7C             8      BIT 7,H
001F73 E4E9 202A            12      JR  NZ,PDWXR
001F75 E4EB CDA9E4          17      CALL    FFLUSHBUF
       E4EE                     PDRD1:
001F78 E4EE C5              11      PUSH    BC
001F79 E4EF D5              11      PUSH    DE
001F7A E4F0 E5              11      PUSH    HL
001F7B E4F1 2A7EE7          16      LD  HL,(_DTBUF)
001F7E E4F4 0601             7      LD  B,1
001F80 E4F6 CD15E5          17      CALL    PDWXR
001F83 E4F9 3816            12      JR  C,PDRWERR
001F85 E4FB D1              10      POP DE
001F86 E4FC 2A7EE7          16      LD  HL,(_DTBUF)
001F89 E4FF DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001F8C E502 E607             7      AND 7
001F8E E504 47               4      LD  B,A
001F8F E505 0E00             7      LD  C,0
001F91 E507 EDB0                    LDIR
001F93 E509 EB               4      EX  DE,HL
001F94 E50A D1              10      POP DE
001F95 E50B 13               6      INC DE
001F96 E50C C1              10      POP BC
001F97 E50D 10D8            13      DJNZ    PDRD
001F99 E50F AF               4      XOR A
001F9A E510 C9              10      RET
       E511                     PDRWERR:
001F9B E511 E1              10      POP HL
001F9C E512 D1              10      POP DE
001F9D E513 C1              10      POP BC
001F9E E514 C9              10      RET
       E515                     PDWXR:
001F9F E515 A7               4      AND A
       E516                     PDWX:                   ;CF=0 READ CF=1 WRITE
001FA0 E516 DDCB1266        20      BIT 4,(IX+DPB_DEVICE)   ;デバイス情報
001FA4 E51A 2003            12      JR  NZ,PDWX1
001FA6 E51C DD4E06          19      LD  C,(IX+DPB_FATID)    ;メディアバイト
       E51F                     PDWX1:
001FA9 E51F DD7E13          19      LD  A,(IX+DPB_UNITNO)   ;デバイスドライバ内におけるユニット番号
001FAC E522 C5              11      PUSH    BC
001FAD E523 D5              11      PUSH    DE
001FAE E524 E5              11      PUSH    HL
001FAF E525 DDE5            15      PUSH    IX
001FB1 E527 FDE5            15      PUSH    IY
001FB3 E529 CDA7FF          17      CALL    H_PHYD
001FB6 E52C FDE1            14      POP IY
                                ;   LD  IX,PHYDIO
                                ;   CALL    CALSLT_R
001FB8 E52E DDE1            14      POP IX
001FBA E530 E1              10      POP HL
001FBB E531 D1              10      POP DE
001FBC E532 C1              10      POP BC
001FBD E533 D8              11      RET C
       E534                     PDWX2:
001FBE E534 13               6      INC DE
001FBF E535 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;BCは読み出すセクタサイズ
001FC2 E538 E607             7      AND 7
001FC4 E53A 84               4      ADD A,H
001FC5 E53B 67               4      LD  H,A
001FC6 E53C 10F6            13      DJNZ    PDWX2
001FC8 E53E AF               4      XOR A
001FC9 E53F C9              10      RET
[EOF:MSXDISK2.ASM:UTF_8]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001FCA E540                     PATHD:  DS  PATHX
002005 E57B 00                  PATHE:  DB  0
                                
       E57C                     DTA_CCP:
002006 E57C                         DS  37
                                
       E5A1                     FCB_BAT:
00202B E5A1                         DS  37
                                
002050 E5C6 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
00205B E5D1 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
                                ;   ALIGN   256
       E5D8                     AT_WORK:
002062 E5D8                         DS  WORKAD-AT_WORK
                                
       E600                     CPM_BOOT:
00208A E600 C30000          10      JP  0
       E603                     _SYS00:     ;(BDOS)プログラム終了
       E603                     CPM_WBOOT:
00208D E603 C3AACB          10      JP  WBOOT1
       E606                     CPM_CONST:
002090 E606 C3FED3          10      JP  CONSTX
       E609                     _SYS07:     ;(BDOS)コンソール直接入力
       E609                     CPM_CONIN:
002093 E609 C31FD3          10      JP  FLGET
       E60C                     CPM_CONOUT:
002096 E60C C301D5          10      JP  CONOUT1
                                
       E60F                     DECBF:              ;10進数表示時のバッファ(5バイト)
002099 E60F                         DS  5
       E60F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       E611                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       E614                     FDRV:
00209E E614 00                      DB  0
       E615                     FNAME:
00209F E615                         DS  36
       E639                     SFILE:
0020C3 E639                         DS  33      ;DRV FILENAME
       E65A                     _DISKE:
0020E4 E65A C39BD2          10      JP  SHOW_ERROR
                                
0020E7 E65D 0000                LEFTX:  DW  0
0020E9 E65F 0000                DTAX:   DW  0
                                
                                ;   PSGのビープ音のデータ(X1)
       E661                     BEEPD:
0020EB E661 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
0020F3 E669 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                ;
       E662                     RTC_YY  EQU BEEPD+1 ;RTCのバッファ年(88)
       E663                     RTC_MW  EQU BEEPD+2 ;RTCのバッファ月(88)
       E664                     RTC_DD  EQU BEEPD+3 ;RTCのバッファ日(88)
       E665                     RTC_TT  EQU BEEPD+4 ;RTCのバッファ時(88)
       E666                     RTC_MM  EQU BEEPD+5 ;RTCのバッファ分(88)
       E667                     RTC_SS  EQU BEEPD+6 ;RTCのバッファ秒(88)
       E662                     ROM_SLT EQU BEEPD+1 ;ROMのスロット(MSX)
       E661                     ZERO    EQU BEEPD
                                
       E670                     CHECK:
0020FA E670 00                      DB  0
                                
       E671                     OK:
0020FB E671 4F4B24                  DB  "OK$"
0020FE E674                         DS  5
       E679                     COMERM:
002103 E679 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       E680                     _CYL0:
00210A E680 FF                      DB  0FFH    ;Cylinder
       E681                     _CYL1:
00210B E681 FF                      DB  0FFH    ;Cylinder
       E682                     _CYL2:
00210C E682 FF                      DB  0FFH    ;Cylinder
       E683                     _CYL3:
00210D E683 FF                      DB  0FFH    ;Cylinder
       E684                     _DRIVE:
00210E E684 00                      DB  0   ;unit number
       E685                     _SEEKSP:
00210F E685 00                      DB  0   ;Seek speed
       E686                     _ISEEK:
002110 E686 32                      DB  50  ;
002111 E687                         DS  1
       E688                     _DRV:
002112 E688 00                      DB  0
       E689                     _DSK:
002113 E689 FF                      DB  0FFH
       E68A                     _DTA:
002114 E68A 8000                    DW  00080H
       E68C                     _CTC:
002116 E68C 0000                    DW  0
       E68E                     _TXADR:
002118 E68E 0000                    DW  0
       E690                     _KEYPS:
00211A E690 0000                    DW  0
       E692                     _KEYD:
00211C E692 00                      DB  000H    ;キーデータ
       E693                     _KEYST:
00211D E693 FF                      DB  0FFH    ;キーステータス(SHIFT,CTRLの状態)
       E694                     _KEYSP_L:
00211E E694 00                      DB  KEYSP_L ;オートリピートの速度
       E695                     _KEYSP_H:
00211F E695 00                      DB  KEYSP_H ;オートリピートの速度
       E696                     _COLORF:
002120 E696 00                      DB  COLORF  ;色
       E697                     _LINE:
002121 E697 18                      DB  LINE
                                
                                            ;次のファイルの検索(C=12)で使用するFCB
       E698                     _FCB:
002122 E698 0000                    DW  0   ;SEARCH FILES
       E69A                     _FBPS:
002124 E69A 0000                    DW  0   ;    //
       E69C                     _FBAD:
002126 E69C 0000                    DW  0   ;    //
       E69E                     _FBCNT:
002128 E69E 00                      DB  0   ;    //
       E69F                     _FILEN:
002129 E69F 00                      DB  0   ;    //
       E6A0                     _DIRF:
00212A E6A0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
00212B E6A1                         DS  1
       E6A2                     _WTFATF:
00212C E6A2 00                      DB  0   ;FATバッファの更新フラグ
00212D E6A3                         DS  1
       E6A4                     _WTDBF:
00212E E6A4 00                      DB  0   ;データバッファの更新フラグ
       E6A5                     _DBDRV:
00212F E6A5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       E6A6                     _DBSEC:
002130 E6A6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       E6A8                     _DPB:
002132 E6A8 0000                    DW  0
       E6AA                     _FATDRV:
002134 E6AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       E6AB                     _FATIX:
002135 E6AB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       E6AC                     _FAKEFREE:
002136 E6AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
002138 E6AE                         DS  2
                                ;   画面周りのデータ
       E6B0                     CRTCD:
00213A E6B0 6F                      DB  06FH
       E6B1                     _WIDTH:
00213B E6B1 28                      DB  WIDTH
       E6B2                     TVRAMTOP:
00213C E6B2 5938                    DB  059H,038H
00213E E6B4 1F02                    DB  01FH,002H
       E6B6                     _LINE2:
002140 E6B6 19                      DB  019H
       E6B7                     WKE4:
002141 E6B7 1C                      DB  01CH
       E6B8                     WKE6:
002142 E6B8 00                      DB  000H
       E6B9                     WK40:
002143 E6B9 07                      DB  007H
       E6BA                     _PAGE_MINUS:
002144 E6BA 40FC                    DW  0-WIDTH*LINE
       E6BC                     _WIDTH_MINUS:
002146 E6BC D8FF                    DW  0-WIDTH
       E6BE                     WK30:
002148 E6BE 0C                      DB  00CH
       E6BF                     WK31:
       E6BF                     WK1FD0:
002149 E6BF 20                      DB  020H
                                
                                ;   割り込みベクタ(X1)
00214A E6C0 0000                CTC0:   DW  INTCTCE
00214C E6C2 0000                CTC1:   DW  INTCTCE
00214E E6C4 0000                CTC2:   DW  INTCTCE
002150 E6C6 0000                CTC3:   DW  INTCTCE
002152 E6C8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
002154 E6CA C364D3          10  _INKEY: JP  INKEY
002157 E6CD C3A4D2          10  _PRINT: JP  PRINT
00215A E6D0 C39BD4          10  _SCRN:  JP  SCRN
00215D E6D3 C37BD4          10  _POS:   JP  POS
002160 E6D6 C386D4          10  _LOC:   JP  LOC
       E6D9                     _CHGDRV:
002163 E6D9 C3C0E3          10      JP  CHGDRV
       E6DC                     _GETDPB:
002166 E6DC C37EE4          10      JP  GETDPB
       E6DF                     _FFLUSH:
002169 E6DF C39CE4          10      JP  FFLUSH
       E6E2                     _RDFATX:
00216C E6E2 C39AE0          10      JP  RDFATX
00216F E6E5 C3CCE1          10  _RDFAT: JP  RDFAT
002172 E6E8 C3B7E4          10  _WTTRK: JP  WTTRK
002175 E6EB C309CB          10  _FDRD:  JP  FDRD
002178 E6EE C3B7E4          10  _FDWT:  JP  FDWT
       E6F1                     _BPB2DPB:
00217B E6F1 C362E2          10      JP  BPB2DPB
       E6F4                     _BREAK:
00217E E6F4 C325CD          10      JP  END_BATCH
       E6F7                     _GNCL:
002181 E6F7 C346E1          10      JP  GNCL        ; self-modifying code
       E6F8                     GNCPAT  EQU $-2
       E6FA                     _SNCL:
002184 E6FA C369E1          10      JP  SNCL        ; self-modifying code
       E6FB                     SNCPAT  EQU $-2
       E6FD                     _COMANL:
002187 E6FD C3DECB          10      JP  COMANL
                                
       E700                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       E700                     STABLE:
                                ;0
00218A E700 03E6A7D2D8D204D9        DW  _SYS00,_SYS01,_SYS02,_SYS03
002192 E708 06D006D0DED209E6        DW  _SYS04,_SYS05,_SYS06,_SYS07
00219A E710 E6D208D06AD3FED3        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
0021A2 E718 1DD022D031D042D0        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
0021AA E720 96D0DDD026D157D1        DW  _SYS10,_SYS11,_SYS12,_SYS13
0021B2 E728 5FD175D18AD182D1        DW  _SYS14,_SYS15,_SYS16,_SYS17
0021BA E730 D1D1D6D1DBD1E1D1        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
0021C2 E738 06D007D206D00BD2        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
0021CA E740 06D0C1D1C9D112D2        DW  _SYS20,_SYS21,_SYS22,_SYS23
0021D2 E748 37D206D05ADD28DE        DW  _SYS24,_ERROR,_SYS26,_SYS27
0021DA E750 C9D141D210D404D9        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
0021E2 E758 60D404D906D062D2        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
0021EA E760 5CD206D006D006D0        DW  _SYS30,_ERROR,_ERROR,_ERROR
0021F2 E768 06D006D006D006D0        DW  _ERROR,_ERROR,_ERROR,_ERROR
0021FA E770 06D004D904D983D2        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
002202 E778 E9CF                    DW  _DOS2
                                
002204 E77A                         DS  1
       E77B                     _MAX_SEC_SZ_H:
002205 E77B 02                      DB  MAX_SEC_SZ_H
                                
                                ;   FATバッファのアドレス
       E77C                     _FATBF:
002206 E77C 00E9                    DW  FATBF
                                
                                ;   データバッファのアドレス
       E77E                     _DTBUF:
002208 E77E 00EF                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       E780                     CTRLTB:
00220A E780 00000000ABD40000        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
002212 E788 0000000000000000        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
00221A E790 0000000000000000        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
002222 E798 0000000000000000        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
00222A E7A0 0000000000000000        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
002232 E7A8 0000000000000000        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
00223A E7B0 0000000000000000        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
002242 E7B8 0000000000000000        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
                                ;   2D/2DDでBPBがない場合のデフォルト値(2D/360KB/9セクタ1024バイト)
00224A E7C0 0200                M2D:    DW  2
00224C E7C2 FD02                    DB  0FDH,2
00224E E7C4 6401                    DW  356
002250 E7C6 FF0728090182            DB  0FFH,7,40,9,1,082H
002256 E7CC 0500A7000800            DW  5,0A7H,8
                                
                                ;   2HDでBPBがない場合のデフォルト値(2HD/1.23MB/8セクタ1024バイト)
00225C E7D2 0200                M2HD:   DW  2
00225E E7D4 FE01                    DB  0FEH,1
002260 E7D6 C704                    DW  1223
002262 E7D8 FE064D080184            DB  0FEH,6,77,8,1,084H
002268 E7DE 0500A7000900            DW  5,0A7H,9
                                
                                ;   ディレクトリエントリとFCBの変換テーブル(日付+時刻+サイズ)
00226E E7E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
002270 E7E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
002272 E7E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
002274 E7EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       E7EE                     SDDATAE:
                                
002278 E7EE                         DS  2
                                
                                ;   バッチファイルのFCB
       E7F0                     _FCB_BAT:
00227A E7F0 A1E5                    DW  FCB_BAT
       E7F2                     _PATH:
00227C E7F2 40E5                    DW  PATHD
                                
00227E E7F4                     SCDIR:  DS  2       ;+14 +15
002280 E7F6                     SFBPS:  DS  2       ;FBPS
002282 E7F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
002284 E7FA 0000                _FATPS: DW  0
002286 E7FC 0000                _DIRPS: DW  0
002288 E7FE 0000                _CLPS:  DW  0
                                
       E800                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "MSXDPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MSX
                                
       E800                     _DEVICE:
                                
                                ;   A:
                                
00228A E800 0300                    DW  3   ;DPB_FATLN
00228C E802 EBE6                    DW  _FDRD   ;DPB_DRD
00228E E804 EEE6                    DW  _FDWT   ;DPB_DWT
002290 E806 F9                      DB  0F9H    ;DPB_FATID
002291 E807 03                      DB  3   ;DPB_SECPCL
002292 E808 CB02                    DW  715 ;DPB_MAXCL
002294 E80A 00                      DB  0   ;DPB_FDMODE
002295 E80B 07                      DB  7   ;DPB_DIRSCNT
002296 E80C 01                      DB  1   ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002297 E80D 00                      DB  0   ;DPB_MAXSEC
002298 E80E 01                      DB  1   ;DPB_FATPS
002299 E80F 82                      DB  082H    ;DPB_BPS
00229A E810 0700                    DW  7   ;DPB_DIRPS
00229C E812 2E                      DB  02EH    ;DPB_DEVICE
00229D E813 00                      DB  0   ;DPB_UNITNO
00229E E814 0A00                    DW  10  ;DPB_ADDCL
0022A0 E816 0000                    DW  0   ;DPB_16
0022A2 E818 0000                    DW  0   ;DPB_18
0022A4 E81A 0000                    DW  0   ;DPB_SDIR
0022A6 E81C 524F4D30                DB  "ROM0"  ;DPB_NAME
                                
                                ;   B:
                                
0022AA E820 0300                    DW  3   ;DPB_FATLN
0022AC E822 EBE6                    DW  _FDRD   ;DPB_DRD
0022AE E824 EEE6                    DW  _FDWT   ;DPB_DWT
0022B0 E826 F9                      DB  0F9H    ;DPB_FATID
0022B1 E827 03                      DB  3   ;DPB_SECPCL
0022B2 E828 CB02                    DW  715 ;DPB_MAXCL
0022B4 E82A 00                      DB  0   ;DPB_FDMODE
0022B5 E82B 07                      DB  7   ;DPB_DIRSCNT
0022B6 E82C 2E                      DB  46  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
0022B7 E82D 00                      DB  0   ;DPB_MAXSEC
0022B8 E82E 01                      DB  1   ;DPB_FATPS
0022B9 E82F 82                      DB  082H    ;DPB_BPS
0022BA E830 0700                    DW  7   ;DPB_DIRPS
0022BC E832 2E                      DB  02EH    ;DPB_DEVICE
0022BD E833 01                      DB  1   ;DPB_UNITNO
0022BE E834 0A00                    DW  10  ;DPB_ADDCL
0022C0 E836 0000                    DW  0   ;DPB_16
0022C2 E838 0000                    DW  0   ;DPB_18
0022C4 E83A 0000                    DW  0   ;DPB_SDIR
0022C6 E83C 524F4D31                DB  "ROM1"  ;DPB_NAME
                                
                                ;   C:
                                
0022CA E840                         DS  32
                                
                                ;   D:
                                
0022EA E860                         DS  32
                                
                                ;   E:
                                
00230A E880 0300                    DW  3   ;DPB_FATLN
00230C E882 E7E4                    DW  PDRD    ;DPB_DRD
00230E E884 B9E4                    DW  PDWT    ;DPB_DWT
002310 E886 F9                      DB  0F9H    ;DPB_FATID
002311 E887 03                      DB  3   ;DPB_SECPCL
002312 E888 CB02                    DW  715 ;DPB_MAXCL
002314 E88A FF                      DB  0FFH    ;DPB_FDMODE
002315 E88B 07                      DB  7   ;DPB_DIRSCNT
002316 E88C 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002317 E88D 09                      DB  9   ;DPB_MAXSEC
002318 E88E 01                      DB  1   ;DPB_FATPS
002319 E88F 82                      DB  082H    ;DPB_BPS
00231A E890 0700                    DW  7   ;DPB_DIRPS
00231C E892 2D                      DB  02DH    ;DPB_DEVICE
00231D E893 00                      DB  0   ;DPB_UNITNO
00231E E894 0A00                    DW  10  ;DPB_ADDCL
002320 E896 0000                    DW  0   ;DPB_16
002322 E898 0000                    DW  0   ;DPB_18
002324 E89A 0000                    DW  0   ;DPB_SDIR
002326 E89C 44534B30                DB  "DSK0"  ;DPB_NAME
                                
                                ;   F:
                                
00232A E8A0 0300                    DW  3   ;DPB_FATLN
00232C E8A2 E7E4                    DW  PDRD    ;DPB_DRD
00232E E8A4 B9E4                    DW  PDWT    ;DPB_DWT
002330 E8A6 F9                      DB  0F9H    ;DPB_FATID
002331 E8A7 03                      DB  3   ;DPB_SECPCL
002332 E8A8 CB02                    DW  715 ;DPB_MAXCL
002334 E8AA FF                      DB  0FFH    ;DPB_FDMODE
002335 E8AB 07                      DB  7   ;DPB_DIRSCNT
002336 E8AC 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002337 E8AD 09                      DB  9   ;DPB_MAXSEC
002338 E8AE 01                      DB  1   ;DPB_FATPS
002339 E8AF 82                      DB  082H    ;DPB_BPS
00233A E8B0 0700                    DW  7   ;DPB_DIRPS
00233C E8B2 2D                      DB  02DH    ;DPB_DEVICE
00233D E8B3 01                      DB  1   ;DPB_UNITNO
00233E E8B4 0A00                    DW  10  ;DPB_ADDCL
002340 E8B6 0000                    DW  0   ;DPB_16
002342 E8B8 0000                    DW  0   ;DPB_18
002344 E8BA 0000                    DW  0   ;DPB_SDIR
002346 E8BC 44534B31                DB  "DSK1"  ;DPB_NAME
                                
                                ;   G:
                                
00234A E8C0 0300                    DW  3   ;DPB_FATLN
00234C E8C2 E7E4                    DW  PDRD    ;DPB_DRD
00234E E8C4 B9E4                    DW  PDWT    ;DPB_DWT
002350 E8C6 F9                      DB  0F9H    ;DPB_FATID
002351 E8C7 03                      DB  3   ;DPB_SECPCL
002352 E8C8 CB02                    DW  715 ;DPB_MAXCL
002354 E8CA FF                      DB  0FFH    ;DPB_FDMODE
002355 E8CB 07                      DB  7   ;DPB_DIRSCNT
002356 E8CC 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002357 E8CD 09                      DB  9   ;DPB_MAXSEC
002358 E8CE 01                      DB  1   ;DPB_FATPS
002359 E8CF 82                      DB  082H    ;DPB_BPS
00235A E8D0 0700                    DW  7   ;DPB_DIRPS
00235C E8D2 2D                      DB  02DH    ;DPB_DEVICE
00235D E8D3 02                      DB  2   ;DPB_UNITNO
00235E E8D4 0A00                    DW  10  ;DPB_ADDCL
002360 E8D6 0000                    DW  0   ;DPB_16
002362 E8D8 0000                    DW  0   ;DPB_18
002364 E8DA 0000                    DW  0   ;DPB_SDIR
002366 E8DC 44534B32                DB  "DSK2"  ;DPB_NAME
                                
                                ;   H:
00236A E8E0 0300                    DW  3   ;DPB_FATLN
00236C E8E2 E7E4                    DW  PDRD    ;DPB_DRD
00236E E8E4 B9E4                    DW  PDWT    ;DPB_DWT
002370 E8E6 F9                      DB  0F9H    ;DPB_FATID
002371 E8E7 03                      DB  3   ;DPB_SECPCL
002372 E8E8 CB02                    DW  715 ;DPB_MAXCL
002374 E8EA FF                      DB  0FFH    ;DPB_FDMODE
002375 E8EB 07                      DB  7   ;DPB_DIRSCNT
002376 E8EC 50                      DB  80  ;DPB_MAXCYL ROMディスクではBPPが格納されている先頭BANK
002377 E8ED 09                      DB  9   ;DPB_MAXSEC
002378 E8EE 01                      DB  1   ;DPB_FATPS
002379 E8EF 82                      DB  082H    ;DPB_BPS
00237A E8F0 0700                    DW  7   ;DPB_DIRPS
00237C E8F2 2D                      DB  02DH    ;DPB_DEVICE
00237D E8F3 07                      DB  7   ;DPB_UNITNO
00237E E8F4 0A00                    DW  10  ;DPB_ADDCL
002380 E8F6 0000                    DW  0   ;DPB_16
002382 E8F8 0000                    DW  0   ;DPB_18
002384 E8FA 0000                    DW  0   ;DPB_SDIR
002386 E8FC 44534B37                DB  "DSK7"  ;DPB_NAME
       E900                     MSX_E:
[EOF:MSXDPB.ASM:UTF_8]
                                
00238A E900                         DS  03FFFH - $$
003FFF 0575 00                      DB  0
       0576                     LAST_ADR:
                                
                                    END
[EOF:MSX.ASM:UTF_8]
