                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.13.0, LST:Full:4
                                ;   LSX-Dodgers for X1/turbo/Z
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "X1DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   X1/turbo/Z
                                
       0000                     MAC EQU 0       ;X1
       0000                     DEV EQU 0
                                
       011D                     VER_6F  EQU 0011DH
                                
       D100                     RUN EQU 0D100H
       D706                     BDOS    EQU 0D706H
       F400                     WORKAD  EQU 0F400H
       F700                     FATBF   EQU 0F700H
       FD00                     DTBUF   EQU 0FD00H
       FF00                     KEYBF   EQU 0FF00H
       FF20                     KBUF    EQU 0FF20H
       FFCA                     EXTSP   EQU 0FFCAH
       FFD9                     TRAP38  EQU 0FFD9H
       0050                     WIDTH   EQU 80
       0018                     LINE    EQU 24
       0007                     COLORF  EQU 7
       0010                     KEYSP_H EQU 16
       00C2                     KEYSP_L EQU 0C2H
       0008                     COMS    EQU 8
       0002                     MAX_SEC_SZ_H    EQU 2       ;1セクタ1024バイトのサポート(2:off 4:on)
       0100                     BUFFER  EQU 00100H
       D817                     S27BUF_COM  EQU S27BUF
[EOF:X1DEF.ASM:UTF_8]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0001                     VER_3   EQU 1
       1D00                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0000                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0161                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 D0F9                         ORG RUN-7
                                
                                ;   MSX BINARY HEADER
000000 D0F9 FE                      DB  0FEH
                                ;   MSX BINARY START ADDRESS
000001 D0FA 00D1                    DW  RUN
                                ;   MSX BINARY END ADDRESS
000003 D0FC F9F6                    DW  LAST_ADR
                                ;   MSX BINARY EXEC ADDRESS
000005 D0FE 07D1                    DW  START
                                
                                    INCLUDE "X1INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   X1/turbo/Z
                                
000007 D100 C307D1          10      JP  START
00000A D103 001D                    DW  MACW
00000C D105 6101                    DW  VER
                                
       D107                     START:
00000E D107 F3               4      DI
00000F D108 ED5E             8      IM  2
000011 D10A 31CAFF          10      LD  SP,EXTSP
000014 D10D CD58D1          17      CALL    INIT        ;NZならAUTOEXECを実行
000017 D110 210000          10      LD  HL,0
00001A D113 E5              11      PUSH    HL
00001B D114 F5              11      PUSH    AF
                                                ;2HD等1セクタ1024バイトで起動時(Japan2HD)
00001C D115 3A0CFE          13      LD  A,(0FE0CH)
00001F D118 FE04             7      CP  4
000021 D11A 201B            12      JR  NZ,NOT_2HD2014
000023 D11C 2A0600          16      LD  HL,(00006H)
000026 D11F 5D               4      LD  E,L
000027 D120 54               4      LD  D,H
000028 D121 15               4      DEC D
000029 D122 15               4      DEC D
00002A D123 15               4      DEC D
00002B D124 15               4      DEC D
00002C D125 ED530600        20      LD  (00006H),DE
000030 D129 010300          10      LD  BC,3
000033 D12C EDB0                    LDIR
000035 D12E 3E04             7      LD  A,4
000037 D130 327BF5          13      LD  (_MAX_SEC_SZ_H),A
00003A D133 ED537EF5        20      LD  (_DTBUF),DE
       D137                     NOT_2HD2014:
00003E D137 3A0400          13      LD  A,(_DVSW)
000041 D13A CDDCF4          17      CALL    _GETDPB
000044 D13D 380A            12      JR  C,INIT1
000046 D13F 3A0400          13      LD  A,(_DVSW)
000049 D142 C641             7      ADD A,'A'
00004B D144 32A4D4          13      LD  (AUTODV),A
00004E D147 1807            12      JR  INIT2
       D149                     INIT1:
000050 D149 1E00             7      LD  E,0
000052 D14B 0E0E             7      LD  C,00EH
000054 D14D CD0500          17      CALL    SYSTEM
       D150                     INIT2:
000057 D150 F1              10      POP AF
000058 D151 C8              11      RET Z
000059 D152 119BD4          10      LD  DE,AUTOD
00005C D155 C3FDF4          10      JP  _COMANL
                                
       D158                     INIT:
00005F D158 01031A          10      LD  BC,1A03H
000062 D15B 3E82             7      LD  A,82H
000064 D15D ED79            12      OUT (C),A
000066 D15F 3E1E             7      LD  A,01EH
000068 D161 D300            11      OUT (0),A
                                
00006A D163 010000          10      LD  BC,0
00006D D166 ED438CF4        20      LD  (_CTC),BC
000071 D16A 01040A          10      LD  BC,00A04H
000074 D16D CD45D4          17      CALL    CHKCTC
000077 D170 010407          10      LD  BC,00704H
00007A D173 CD45D4          17      CALL    CHKCTC
00007D D176 01A81F          10      LD  BC,01FA8H
000080 D179 CD45D4          17      CALL    CHKCTC
000083 D17C 01A01F          10      LD  BC,01FA0H
000086 D17F CD45D4          17      CALL    CHKCTC
                                
       D182                     INISIO:
000089 D182 01911F          10      LD  BC,01F91H   ;INIT SIO
00008C D185 1601             7      LD  D,1
00008E D187 ED51            12      OUT (C),D
                                
000090 D189 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
000092 D18B 0E93             7      LD  C,093H
000094 D18D ED51            12      OUT (C),D
000096 D18F ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
000098 D191 0E99             7      LD  C,099H      ;INIT SIO
00009A D193 1601             7      LD  D,1
00009C D195 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
00009E D197 0E9B             7      LD  C,09BH
0000A0 D199 ED51            12      OUT (C),D
0000A2 D19B ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
0000A4 D19D 0E80             7      LD  C,080H      ;INIT DMA
0000A6 D19F 2106C3          10      LD  HL,0C306H
       D1A2                     INIDMA:
0000A9 D1A2 ED61            12      OUT (C),H
0000AB D1A4 2D               4      DEC L
0000AC D1A5 20FB            12      JR  NZ,INIDMA
                                
0000AE D1A7 3EE4             7      LD  A,0E4H
0000B0 D1A9 CDF9E2          17      CALL    COMOUT
0000B3 D1AC AF               4      XOR A
0000B4 D1AD CDD3E2          17      CALL    OT49SB
                                
0000B7 D1B0 3EF4             7      LD  A,INTVEC/256
0000B9 D1B2 ED47             9      LD  I,A
                                
0000BB D1B4 ED4B8CF4        20      LD  BC,(_CTC)
0000BF D1B8 0D               4      DEC C
0000C0 D1B9 0D               4      DEC C
                                
0000C1 D1BA ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
0000C3 D1BC 3EC0             7      LD  A,CTC0-CPM_BOOT
0000C5 D1BE ED79            12      OUT (C),A
                                
0000C7 D1C0 0C               4      INC C
0000C8 D1C1 3E47             7      LD  A,047H
0000CA D1C3 ED79            12      OUT (C),A
0000CC D1C5 3E0D             7      LD  A,13        ;Baudrate 9600-13
0000CE D1C7 ED79            12      OUT (C),A
                                
0000D0 D1C9 79               4      LD  A,C
0000D1 D1CA D610             7      SUB 010H
0000D3 D1CC 4F               4      LD  C,A
                                ;   LD  (SIOAD+1),BC
                                ;   LD  (SIOAD0+1),BC
                                ;   LD  (SIOAD1+1),BC
                                
0000D4 D1CD 21ECD4          10      LD  HL,SIODATA
       D1D0                     SINIT1:
0000D7 D1D0 7E               7      LD  A,(HL)
0000D8 D1D1 23               6      INC HL
0000D9 D1D2 FEFF             7      CP  0FFH
0000DB D1D4 2804            12      JR  Z,SINIT2
0000DD D1D6 ED79            12      OUT (C),A
0000DF D1D8 18F6            12      JR  SINIT1
       D1DA                     SINIT2:
0000E1 D1DA 3EE4             7      LD  A,0E4H
0000E3 D1DC CDF9E2          17      CALL    COMOUT
0000E6 D1DF 3EC8             7      LD  A,INTVEC-CPM_BOOT
0000E8 D1E1 CDD3E2          17      CALL    OT49SB
                                ;
0000EB D1E4 01C41F          10      LD  BC,01FC4H
0000EE D1E7 3E0C             7      LD  A,00CH
0000F0 D1E9 ED79            12      OUT (C),A
                                
0000F2 D1EB 0EC0             7      LD  C,0C0H
0000F4 D1ED ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
0000F6 D1EF 0C               4      INC C
0000F7 D1F0 3E28             7      LD  A,40
0000F9 D1F2 ED79            12      OUT (C),A
                                
0000FB D1F4 0C               4      INC C
0000FC D1F5 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
0000FE D1F7 0C               4      INC C
0000FF D1F8 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
000101 D1FA 0EC5             7      LD  C,0C5H
000103 D1FC ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
       D1FE                     TEXT:
000105 D1FE 0EB0             7      LD  C,0B0H
000107 D200 3E80             7      LD  A,080H
000109 D202 ED79            12      OUT (C),A
00010B D204 1607             7      LD  D,7
00010D D206 0EB9             7      LD  C,0B9H
00010F D208 21E5D4          10      LD  HL,TEXTDT
       D20B                     TEXT1:
000112 D20B 04               4      INC B
000113 D20C EDA3            16      OUTI
000115 D20E 0C               4      INC C
000116 D20F 15               4      DEC D
000117 D210 20F9            12      JR  NZ,TEXT1
000119 D212 01B01F          10      LD  BC,01FB0H
00011C D215 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
00011E D217 0EC4             7      LD  C,0C4H
000120 D219 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
000122 D21B 01011A          10      LD  BC,01A01H
000125 D21E ED78            12      IN  A,(C)
000127 D220 E608             7      AND 8
000129 D222 2809            12      JR  Z,PRN
00012B D224 0E03             7      LD  C,003H
00012D D226 3E0F             7      LD  A,00FH
00012F D228 ED79            12      OUT (C),A
000131 D22A 01040A          10      LD  BC,00A04H
       D22D                     PRN:
000134 D22D 210000          10      LD  HL,0
000137 D230 065C             7      LD  B,05CH
000139 D232 3E                      DB  03EH    ;LD A,??
00013A D233 FF              12      RST 38H
00013B D234 CD53E5          17      CALL    FILL_MEMORY
00013E D237 06A4             7      LD  B,0A4H
000140 D239 AF               4      XOR A
000141 D23A CD53E5          17      CALL    FILL_MEMORY
                                
000144 D23D 3A87FF          13      LD  A,(0FF87H)  ;起動ドライブ
000147 D240 E66F             7      AND 06FH
000149 D242 FE08             7      CP  8
00014B D244 3801            12      JR  C,INIDRV
00014D D246 AF               4      XOR A
       D247                     INIDRV:
00014E D247 320400          13      LD  (_DVSW),A   ;カレントドライブ
                                
000151 D24A 3EC3             7      LD  A,0C3H      ;JP
000153 D24C 2103F4          10      LD  HL,CPM_WBOOT
000156 D24F 320000          13      LD  (00000H),A
000159 D252 220100          16      LD  (00001H),HL ;IPL
                                
00015C D255 2106D7          10      LD  HL,BDOS
00015F D258 320500          13      LD  (00005H),A
000162 D25B 220600          16      LD  (00006H),HL ;BDOS
                                
000165 D25E 212ADF          10      LD  HL,BIOS
000168 D261 221900          16      LD  (00019H),HL ;BIOS-ROM
                                
00016B D264 21D9FF          10      LD  HL,TRAP38   ;TRAP38
00016E D267 323800          13      LD  (00038H),A
000171 D26A 223900          16      LD  (00039H),HL ;RST 038H
                                
000174 D26D 3EF4             7      LD  A,CPM_BOOT/256
000176 D26F 320B00          13      LD  (0000BH),A
                                
000179 D272 3E                      DB  03EH    ;LD A,??
00017A D273 E9               4      JP  (HL)
00017B D274 320F00          13      LD  (0000FH),A
                                                ;KEY
00017E D277 3EE6             7      LD  A,0E6H      ;キーデータ読み出し
000180 D279 CDF9E2          17      CALL    COMOUT
000183 D27C CDDEE2          17      CALL    IN49SB
000186 D27F F5              11      PUSH    AF
000187 D280 CDDEE2          17      CALL    IN49SB
00018A D283 F1              10      POP AF
00018B D284 F5              11      PUSH    AF
00018C D285 E612             7      AND 012H
00018E D287 2005            12      JR  NZ,KEYR
000190 D289 3E01             7      LD  A,1
000192 D28B 32DFD3          13      LD  (KEYREP_SWC),A
       D28E                     KEYR:
000195 D28E F1              10      POP AF
000196 D28F E603             7      AND 3
000198 D291 280E            12      JR  Z,NON
                                
00019A D293 01D03F          10      LD  BC,03FD0H
00019D D296 ED49            12      OUT (C),C
00019F D298 3E37             7      LD  A,037H
0001A1 D29A D3D0            11      OUT (0D0H),A
0001A3 D29C ED78            12      IN  A,(C)
0001A5 D29E B9               4      CP  C
0001A6 D29F 284B            12      JR  Z,TURBO
       D2A1                     NON:
0001A8 D2A1 211FD5          10      LD  HL,AT_SCR1
0001AB D2A4 1183E3          10      LD  DE,SCR1
0001AE D2A7 019400          10      LD  BC,SCRNE-SCR1   ;転送先のサイズ確認用
0001B1 D2AA 018500          10      LD  BC,AT_SCRE-AT_SCR1
0001B4 D2AD EDB0                    LDIR
                                
0001B6 D2AF 21A4D5          10      LD  HL,AT_DWT
0001B9 D2B2 11D6F2          10      LD  DE,WTTRK
0001BC D2B5 018C00          10      LD  BC,DMAE-WTTRK   ;転送先のサイズ確認用
0001BF D2B8 018800          10      LD  BC,AT_CPUE-AT_DWT
0001C2 D2BB EDB0                    LDIR
                                
0001C4 D2BD 21FEE3          10      LD  HL,AT_WTTRK+AT_RS
0001C7 D2C0 22E9F4          16      LD  (_WTTRK+1),HL
0001CA D2C3 211CF3          10      LD  HL,AT_DRD+AT_R
0001CD D2C6 22ECF4          16      LD  (_FDRD+1),HL
0001D0 D2C9 21D6F2          10      LD  HL,AT_DWT+AT_R
0001D3 D2CC 22EFF4          16      LD  (_FDWT+1),HL
0001D6 D2CF 2105E4          10      LD  HL,AT_SCRN+AT_RS
0001D9 D2D2 22D1F4          16      LD  (_SCRN+1),HL
                                
0001DC D2D5 3E27             7      LD  A,027H          ;ノンターボはMFM切り替えを行わない
0001DE D2D7 3212F6          13      LD  (_DEVICE+012H),A    ;Aドライブ
0001E1 D2DA 3232F6          13      LD  (_DEVICE+012H+32),A ;Bドライブ
0001E4 D2DD 3252F6          13      LD  (_DEVICE+012H+32*2),A   ;Cドライブ
0001E7 D2E0 3272F6          13      LD  (_DEVICE+012H+32*3),A   ;Dドライブ
                                
0001EA D2E3 210000          10      LD  HL,0
0001ED D2E6 2224E3          16      LD  (X1PAT),HL
0001F0 D2E9 C373D3          10      JP  NOBANK
                                
       D2EC                     TURBO:
0001F3 D2EC F3               4      DI          ;Check BIOS
0001F4 D2ED 061D             7      LD  B,01DH
0001F6 D2EF ED79            12      OUT (C),A       ;BIOS ON
0001F8 D2F1 3A512F          13      LD  A,(02F51H)
0001FB D2F4 04               4      INC B       ;B=01EH
0001FC D2F5 ED79            12      OUT (C),A       ;BIOS OFF
0001FE D2F7 FB               4      EI
0001FF D2F8 FEC9             7      CP  0C9H
000201 D2FA 2802            12      JR  Z,BIOSOK
000203 D2FC 1805            12      JR  NOBIOS
       D2FE                     BIOSOK:
000205 D2FE 3EC3             7      LD  A,0C3H      ;JP
000207 D300 321800          13      LD  (00018H),A
       D303                     NOBIOS:
00020A D303 3E1F             7      LD  A,01FH      ;スタートポート
00020C D305 DBF0            11      IN  A,(0F0H)
00020E D307 0F               4      RRCA
00020F D308 380B            12      JR  C,CRT1
000211 D30A 21D5D4          10      LD  HL,_C8025H
000214 D30D 11B0F4          10      LD  DE,CRTCD
000217 D310 011000          10      LD  BC,16
00021A D313 EDB0                    LDIR
       D315                     CRT1:
00021C D315 3A8CFF          13      LD  A,(0FF8CH)  ;IPL DEVICE (0:2D/1:2DD/2:2HD)
00021F D318 D602             7      SUB 2
000221 D31A 2017            12      JR  NZ,BANK
                                
                                ;   XOR A       ;すでに0のハズ
       D31C                     TZ1:                ;DPBのモードを2HDにしておく
000223 D31C F5              11      PUSH    AF
000224 D31D CDDCF4          17      CALL    _GETDPB
000227 D320 DD7E12          19      LD  A,(IX+DPB_DEVICE)
00022A D323 E68F             7      AND 08FH
00022C D325 FE87             7      CP  087H        ;フロッピーで切り替えがON
00022E D327 2004            12      JR  NZ,TZ2
000230 D329 DDCB0A86        23      RES 0,(IX+DPB_FDMODE)
       D32D                     TZ2:
000234 D32D F1              10      POP AF
000235 D32E 3C               4      INC A
000236 D32F FE08             7      CP  8
000238 D331 38E9            12      JR  C,TZ1
                                
       D333                     BANK:
00023A D333 01000B          10      LD  BC,00B00H
00023D D336 21007F          10      LD  HL,07F00H
000240 D339 F3               4      DI
000241 D33A ED69            12      OUT (C),L
000243 D33C 3A0000          13      LD  A,(0)
000246 D33F FEEB             7      CP  0EBH
000248 D341 2005            12      JR  NZ,BANK1
00024A D343 3E2B             7      LD  A,02BH
00024C D345 32B2F6          13      LD  (BANKDV),A
       D348                     BANK1:
00024F D348 ED69            12      OUT (C),L
000251 D34A 5E               7      LD  E,(HL)
000252 D34B 7B               4      LD  A,E
000253 D34C C6A5             7      ADD A,0A5H
000255 D34E 77               7      LD  (HL),A
000256 D34F BE               7      CP  (HL)
000257 D350 73               7      LD  (HL),E
000258 D351 2005            12      JR  NZ,BANK2
00025A D353 2C               4      INC L
00025B D354 CB65             8      BIT 4,L
00025D D356 28F0            12      JR  Z,BANK1
       D358                     BANK2:
00025F D358 3E10             7      LD  A,010H
000261 D35A ED79            12      OUT (C),A
000263 D35C 7D               4      LD  A,L
000264 D35D B7               4      OR  A
000265 D35E 2813            12      JR  Z,NOBANK
000267 D360 2600             7      LD  H,0
000269 D362 29              11      ADD HL,HL   ;*2
00026A D363 29              11      ADD HL,HL   ;*4
00026B D364 29              11      ADD HL,HL   ;*8
00026C D365 29              11      ADD HL,HL   ;*16
00026D D366 29              11      ADD HL,HL   ;*32
00026E D367 2B               6      DEC HL  ;-1
00026F D368 2B               6      DEC HL  ;-2
000270 D369 2B               6      DEC HL  ;-3
000271 D36A 22A8F6          16      LD  (BANKCL),HL
000274 D36D CD8BD4          17      CALL    CALC_FATLN
000277 D370 32A0F6          13      LD  (BANKFL),A
       D373                     NOBANK:
       D373                     EMM:
00027A D373 DD2180F6        14      LD  IX,EMMFL
00027E D377 CD36D4          17      CALL    EADR0
000281 D37A ED78            12      IN  A,(C)
000283 D37C F5              11      PUSH    AF
                                
000284 D37D 110000          10      LD  DE,0
       D380                     ECHECK1:
000287 D380 13               6      INC DE
000288 D381 CD3FD4          17      CALL    EADRX
00028B D384 ED60            12      IN  H,(C)
00028D D386 CD3FD4          17      CALL    EADRX
000290 D389 7C               4      LD  A,H
000291 D38A C6E5             7      ADD A,0E5H
000293 D38C ED79            12      OUT (C),A
000295 D38E 3C               4      INC A
000296 D38F CD36D4          17      CALL    EADR0
000299 D392 ED79            12      OUT (C),A
00029B D394 3D               4      DEC A
00029C D395 CD3FD4          17      CALL    EADRX
00029F D398 ED68            12      IN  L,(C)
0002A1 D39A CD3FD4          17      CALL    EADRX
0002A4 D39D ED61            12      OUT (C),H
0002A6 D39F BD               4      CP  L
0002A7 D3A0 2004            12      JR  NZ,ECHECK2
0002A9 D3A2 CB5A             8      BIT 3,D
0002AB D3A4 28DA            12      JR  Z,ECHECK1
       D3A6                     ECHECK2:
0002AD D3A6 CD36D4          17      CALL    EADR0
0002B0 D3A9 F1              10      POP AF
0002B1 D3AA ED79            12      OUT (C),A
0002B3 D3AC FEEB             7      CP  0EBH
0002B5 D3AE 2817            12      JR  Z,EMM_BPB
0002B7 D3B0 DD360D02        19      LD  (IX+DPB_MAXSEC),2   ;BPBが512バイト目から始まる場合を調べる
0002BB D3B4 CD36D4          17      CALL    EADR0
0002BE D3B7 ED78            12      IN  A,(C)
0002C0 D3B9 DDBE06           7      CP  (IX+DPB_FATID)
0002C3 D3BC 280D            12      JR  Z,EMM_NOBPB
0002C5 D3BE DD361226        19      LD  (IX+DPB_DEVICE),026H    ;BPBを使う
0002C9 D3C2 21F5FF          10      LD  HL,0-11
0002CC D3C5 180B            12      JR  EMM_BPB1
       D3C7                     EMM_BPB:
0002CE D3C7 DD361226        19      LD  (IX+DPB_DEVICE),026H    ;BPBを使う
       D3CB                     EMM_NOBPB:
0002D2 D3CB DD360D00        19      LD  (IX+DPB_MAXSEC),0
0002D6 D3CF 21F7FF          10      LD  HL,0-9
       D3D2                     EMM_BPB1:
0002D9 D3D2 19              11      ADD HL,DE
0002DA D3D3 3009            12      JR  NC,NOEMM
0002DC D3D5 2288F6          16      LD  (EMMCL),HL
0002DF D3D8 CD8BD4          17      CALL    CALC_FATLN
0002E2 D3DB 3280F6          13      LD  (EMMFL),A
       D3DE                     NOEMM:
0002E5 D3DE 3E00             7      LD  A,000H
       D3DF                     KEYREP_SWC  EQU $-1
0002E7 D3E0 B7               4      OR  A
0002E8 D3E1 2807            12      JR  Z,KEYR1
0002EA D3E3 010000          10      LD  BC,0
0002ED D3E6 ED438CF4        20      LD  (_CTC),BC
       D3EA                     KEYR1:
0002F1 D3EA CD6CD4          17      CALL    SETCRTC
0002F4 D3ED 0130F8          10      LD  BC,0-80*25
0002F7 D3F0 2ABAF4          16      LD  HL,(_PAGE_MINUS)
0002FA D3F3 ED43BAF4        20      LD  (_PAGE_MINUS),BC
0002FE D3F7 1E0C             7      LD  E,00CH
000300 D3F9 CDCDF4          17      CALL    _PRINT
000303 D3FC 22BAF4          16      LD  (_PAGE_MINUS),HL
                                
000306 D3FF 21A7D4          10      LD  HL,INIMES
000309 D402 CDA6DC          17      CALL    MSX
                                
00030C D405 F3               4      DI
00030D D406 2EFE             7      LD  L,0-2       ;CALLのスタック分減らす
00030F D408 39              11      ADD HL,SP
000310 D409 1100FF          10      LD  DE,0FF00H
000313 D40C 45               4      LD  B,L
000314 D40D CD59DA          17      CALL    ZERO_MEMORY_DE
000317 D410 21CAFF          10      LD  HL,EXTBIO
00031A D413 36C9            10      LD  (HL),0C9H   ;RET
00031C D415 23               6      INC HL
00031D D416 060E             7      LD  B,TRAP38-EXTBIO-1
00031F D418 3E                      DB  03EH    ;LD A,??
000320 D419 FF              12      RST 38H
000321 D41A CD53E5          17      CALL    FILL_MEMORY
000324 D41D 21F8D4          10      LD  HL,AT_TRAP38
000327 D420 11D9FF          10      LD  DE,TRAP38
00032A D423 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
00032D D426 EDB0                    LDIR
                                
00032F D428 3EE6             7      LD  A,0E6H      ;キーデータ読み出し
000331 D42A CDF9E2          17      CALL    COMOUT
000334 D42D CDDEE2          17      CALL    IN49SB
000337 D430 CDDEE2          17      CALL    IN49SB
00033A D433 FE1B             7      CP  01BH
00033C D435 C9              10      RET
                                
       D436                     EADR0:
00033D D436 D5              11      PUSH    DE
00033E D437 110000          10      LD  DE,0
000341 D43A CD3FD4          17      CALL    EADRX
000344 D43D D1              10      POP DE
000345 D43E C9              10      RET
                                
       D43F                     EADRX:
000346 D43F F5              11      PUSH    AF
000347 D440 CD48DC          17      CALL    EADR
00034A D443 F1              10      POP AF
00034B D444 C9              10      RET
                                
       D445                     CHKCTC:
00034C D445 C5              11      PUSH    BC
00034D D446 110347          10      LD  DE,04703H
       D449                     INICTC1:
000350 D449 0C               4      INC C
000351 D44A ED51            12      OUT (C),D
000353 D44C ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
000355 D44E 1D               4      DEC E
000356 D44F 20F8            12      JR  NZ,INICTC1
000358 D451 C1              10      POP BC
                                
000359 D452 11FA07          10      LD  DE,007FAH
00035C D455 ED51            12      OUT (C),D
00035E D457 ED59            12      OUT (C),E
000360 D459 ED78            12      IN  A,(C)
000362 D45B BB               4      CP  E
000363 D45C C0              11      RET NZ
000364 D45D ED51            12      OUT (C),D
000366 D45F ED51            12      OUT (C),D
000368 D461 ED78            12      IN  A,(C)
00036A D463 BA               4      CP  D
00036B D464 C0              11      RET NZ
00036C D465 0C               4      INC C
00036D D466 0C               4      INC C
00036E D467 ED438CF4        20      LD  (_CTC),BC
000372 D46B C9              10      RET
                                
       D46C                     SETCRTC:
000373 D46C 21B0F4          10      LD  HL,CRTCD
000376 D46F AF               4      XOR A
       D470                     SETCRT1:
000377 D470 010018          10      LD  BC,01800H
00037A D473 ED79            12      OUT (C),A
00037C D475 0C               4      INC C
00037D D476 04               4      INC B
00037E D477 EDA3            16      OUTI
000380 D479 3C               4      INC A
000381 D47A FE0C             7      CP  12
000383 D47C 20F2            12      JR  NZ,SETCRT1
000385 D47E 23               6      INC HL
000386 D47F 23               6      INC HL
000387 D480 01031B          10      LD  BC,01A03H+00100H
00038A D483 EDA3            16      OUTI
00038C D485 01D020          10      LD  BC,01FD0H+00100H
00038F D488 EDA3            16      OUTI
000391 D48A C9              10      RET
                                
       D48B                     CALC_FATLN: ;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
000392 D48B 5D               4      LD  E,L
000393 D48C 54               4      LD  D,H
000394 D48D 29              11      ADD HL,HL   ;*2
000395 D48E 19              11      ADD HL,DE   ;*3
000396 D48F CB3C             8      SRL H   ;/2
000398 D491 CB1D             8      RR  L   ;1クラスタ辺り1.5バイト必要
00039A D493 11FF01          10      LD  DE,511  ;切り上げる
00039D D496 19              11      ADD HL,DE
00039E D497 7C               4      LD  A,H
00039F D498 CB3F             8      SRL A
0003A1 D49A C9              10      RET
                                
0003A2 D49B 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
0003AB D4A4 413A00              AUTODV: DB  "A:",0
                                
0003AE D4A7 4C53582D446F6467    INIMES: DB  "LSX-Dodgers for X1/turbo version "
            65727320666F7220    
            58312F747572626F    
            2076657273696F6E    
            20                  
0003CF D4C8 312E                    DB  030H + VER_1, '.'
0003D1 D4CA 3631                    DB  030H + VER_2 ,030H + VER_3
0003D3 D4CC 62                      DB  'b'
0003D4 D4CD 2047616B750D0A          DB  " Gaku",0DH,0AH
0003DB D4D4 00                      DB  0
                                
       D4D5                     _C8025H:
0003DC D4D5 6B5059881B00191A        DB  06BH,050H,059H,088H,01BH,000H,019H,01AH
0003E4 D4DD 000F                    DB  000H,00FH
0003E6 D4DF 80F8B0FF                DW  0-80*LINE,0-80
0003EA D4E3 0C23                    DB  00CH,023H
                                
0003EC D4E5 030C0F30333C3F      TEXTDT: DB  003H,00CH,00FH,030H,033H,03CH,03FH
                                
       D4EC                     SIODATA:
0003F3 D4EC 18                      DB  018H
0003F4 D4ED 0100                    DB  1,0
0003F6 D4EF 0200                    DB  2,0
0003F8 D4F1 03C1                    DB  3,0C1H
0003FA D4F3 0444                    DB  4,044H
0003FC D4F5 05E8                    DB  5,0E8H
0003FE D4F7 FF                      DB  0FFH
                                
       D4F8                     AT_TRAP38:
0003FF D4F8 210000          10      LD  HL,0
000402 D4FB E3              19      EX  (SP),HL
000403 D4FC 3E24             7      LD  A,'$'
000405 D4FE CDA8DF          17      CALL    MSG_A
000408 D501 2B               6      DEC HL
000409 D502 7C               4      LD  A,H
00040A D503 CDE8FF          17      CALL    PRHX+AT_RT
00040D D506 7D               4      LD  A,L
       D507                     PRHX:
00040E D507 F5              11      PUSH    AF
00040F D508 07               4      RLCA
000410 D509 07               4      RLCA
000411 D50A 07               4      RLCA
000412 D50B 07               4      RLCA
000413 D50C CDF1FF          17      CALL    PRHX2+AT_RT
000416 D50F F1              10      POP AF
       D510                     PRHX2:
000417 D510 E60F             7      AND 00FH
000419 D512 FE0A             7      CP  10
00041B D514 3F               4      CCF
00041C D515 CE30             7      ADC A,'0'
00041E D517 27               4      DAA
00041F D518 C3A8DF          10      JP  MSG_A
000422 D51B                         DS  4
       D51F                     AT_TRAPE:
[EOF:X1INIT.ASM:SHIFT_JIS]
                                    INCLUDE "X1CPU.ASM"
                                
                                ;   LSX-Dodgers CPU
                                ;   X1/turbo/Z
                                
                                ;   ノンターボ用パッチ
                                ;   DMAを使って転送している部分をCPUに差し替える
                                
       D51F                     AT_SCR1:
000426 D51F D9               4      EXX
000427 D520 C5              11      PUSH    BC
000428 D521 ED4BB1F4        20      LD  BC,(_WIDTH)
00042C D525 0620             7      LD  B,020H
00042E D527 D9               4      EXX
00042F D528 C5              11      PUSH    BC
000430 D529 010020          10      LD  BC,02000H
                                
000433 D52C 67               4      LD  H,A
000434 D52D B7               4      OR  A
       D52E                     AT_SCRUP1:
000435 D52E 2815            12      JR  Z,AT_SCRCL
000437 D530 C5              11      PUSH    BC
000438 D531 CBE0             8      SET 4,B
00043A D533 D9               4      EXX
00043B D534 C5              11      PUSH    BC
00043C D535 CBE0             8      SET 4,B
00043E D537 D9               4      EXX
00043F D538 CDB4E3          17      CALL    AT_UPSUB+AT_RS
000442 D53B D9               4      EXX
000443 D53C C1              10      POP BC
000444 D53D D9               4      EXX
000445 D53E C1              10      POP BC
000446 D53F CDB4E3          17      CALL    AT_UPSUB+AT_RS
000449 D542 25               4      DEC H
00044A D543 18E9            12      JR  AT_SCRUP1
                                
       D545                     AT_SCRCL:
00044C D545 2AB1F4          16      LD  HL,(_WIDTH)
00044F D548 CD4CE2          17      CALL    LINECL
000452 D54B C1              10      POP BC
000453 D54C D9               4      EXX
000454 D54D C1              10      POP BC
000455 D54E D9               4      EXX
000456 D54F C9              10      RET
                                
       D550                     AT_UPSUB:
000457 D550 3AB1F4          13      LD  A,(_WIDTH)
00045A D553 6F               4      LD  L,A
       D554                     AT_UPSUB1:
00045B D554 D9               4      EXX
00045C D555 ED78            12      IN  A,(C)
00045E D557 03               6      INC BC
00045F D558 D9               4      EXX
000460 D559 ED79            12      OUT (C),A
000462 D55B 03               6      INC BC
000463 D55C 2D               4      DEC L
000464 D55D 20F5            12      JR  NZ,AT_UPSUB1
000466 D55F C9              10      RET
                                
                                ;   FLOPPY DISK DRIVER(CPU)
                                
       D560                     DISKC:
000467 D560 1B               6      DEC DE
000468 D561 CB5F             8      BIT 3,A
00046A D563 C4CFF2          17      CALL    NZ,RNF
       D566                     DISKD:
00046D D566 E5              11      PUSH    HL
00046E D567 21D5F2          10      LD  HL,RETRY
000471 D56A 35              11      DEC (HL)
000472 D56B E1              10      POP HL
000473 D56C 200C            12      JR  NZ,AT_ERR       ;Retry
000475 D56E B7               4      OR  A
000476 D56F 2809            12      JR  Z,AT_ERR        ;Error
                                
       D571                     AT_DELP:
000478 D571 CDCFF2          17      CALL    RNF
00047B D574 CDA7F2          17      CALL    FDMOFF
00047E D577 3EFF             7      LD  A,0FFH
       D579                     AT_ERRZ:
000480 D579 BF               4      CP  A
       D57A                     AT_ERR:
000481 D57A 3EFF             7      LD  A,0FFH
000483 D57C C9              10      RET
       D57D                     ERRW:
000484 D57D 3EFF             7      LD  A,0FFH
000486 D57F BF               4      CP  A
000487 D580 37               4      SCF
000488 D581 C3A7F2          10      JP  FDMOFF
                                
       D584                     ERRDW:
00048B D584 D1              10      POP DE
00048C D585 CDD5E3          17      CALL    AT_DELP+AT_RS
00048F D588 C2E4F2          10      JP  NZ,DWT0+AT_R
000492 D58B B7               4      OR  A
000493 D58C 20EF            12      JR  NZ,ERRW
000495 D58E C9              10      RET
                                
       D58F                     ERRDR:
000496 D58F D1              10      POP DE
000497 D590 CDD5E3          17      CALL    AT_DELP+AT_RS
00049A D593 C22AF3          10      JP  NZ,DRD0+AT_R
00049D D596 B7               4      OR  A
00049E D597 20E4            12      JR  NZ,ERRW
0004A0 D599 C9              10      RET
                                
       D59A                     AT_WTTRK:
0004A1 D59A 0601             7      LD  B,1
0004A3 D59C 3EF4             7      LD  A,0F4H      ;FDC TypeIIIコマンド Write Track
0004A5 D59E C3D8F2          10      JP  AT_WTTRK1+AT_R
                                
       D5A1                     AT_SCRN:
0004A8 D5A1 ED78            12      IN  A,(C)
0004AA D5A3 C9              10      RET
       D5A4                     AT_SCRE:
                                
       D5A4                     AT_DWT:
0004AB D5A4 3EA0             7      LD  A,0A0H      ;FDC TypeIIコマンド Write Sector
       D5A6                     AT_WTTRK1:
0004AD D5A6 326CF2          13      LD  (FDCSWC),A
       D5A9                     DWTBL:
0004B0 D5A9 78               4      LD  A,B
0004B1 D5AA 3218F3          13      LD  (AT_WTB+1+AT_R),A
0004B4 D5AD 3E02             7      LD  A,2     ;Retry count
0004B6 D5AF 32D5F2          13      LD  (RETRY),A
       D5B2                     DWT0:
0004B9 D5B2 D5              11      PUSH    DE
0004BA D5B3 E5              11      PUSH    HL
0004BB D5B4 CD0CF2          17      CALL    SEEK        ;Write disk
0004BE D5B7 E1              10      POP HL
0004BF D5B8 DAE8E3          10      JP  C,ERRDW+AT_RS
0004C2 D5BB F3               4      DI
0004C3 D5BC CDB4F2          17      CALL    SECSET_FDCCMD
0004C6 D5BF 0EFB             7      LD  C,0FBH      ;MB8877A データレジスタ
       D5C1                     DWT1:
0004C8 D5C1 56               7      LD  D,(HL)
       D5C2                     DWT2:
0004C9 D5C2 78               4      LD  A,B
0004CA D5C3 DBF8            11      IN  A,(0F8H)    ;MB8877A ステータス／コマンドレジスタ
0004CC D5C5 0F               4      RRCA
0004CD D5C6 3008            12      JR  NC,DWT4
0004CF D5C8 0F               4      RRCA
0004D0 D5C9 30F7            12      JR  NC,DWT2
       D5CB                     DWT3:
0004D2 D5CB ED51            12      OUT (C),D
0004D4 D5CD 23               6      INC HL
0004D5 D5CE 18F1            12      JR  DWT1
                                
       D5D0                     DWT4:
0004D7 D5D0 3D               4      DEC A
0004D8 D5D1 28F8            12      JR  Z,DWT3
0004DA D5D3 3C               4      INC A
0004DB D5D4 FB               4      EI
0004DC D5D5 D1              10      POP DE
0004DD D5D6 13               6      INC DE
0004DE D5D7 CDA7F2          17      CALL    FDMOFF
0004E1 D5DA 2809            12      JR  Z,DISKOK_WT
0004E3 D5DC CDC4E3          17      CALL    DISKC+AT_RS
0004E6 D5DF 20D1            12      JR  NZ,DWT0
0004E8 D5E1 B7               4      OR  A
0004E9 D5E2 C2E1E3          10      JP  NZ,ERRW+AT_RS
                                
       D5E5                     DISKOK_WT:
0004EC D5E5 0601             7  AT_WTB: LD  B,1
0004EE D5E7 10C0            13      DJNZ    DWTBL
0004F0 D5E9 C9              10      RET
                                
       D5EA                     AT_DRD:
0004F1 D5EA 3E80             7      LD  A,080H      ;FDC TypeIIコマンド Read Sector
0004F3 D5EC 326CF2          13      LD  (FDCSWC),A
       D5EF                     DRDBL:
0004F6 D5EF 78               4      LD  A,B
0004F7 D5F0 325AF3          13      LD  (AT_RDB+1+AT_R),A
0004FA D5F3 3E02             7      LD  A,2     ;Retry count
0004FC D5F5 32D5F2          13      LD  (RETRY),A
       D5F8                     DRD0:
0004FF D5F8 D5              11      PUSH    DE
000500 D5F9 E5              11      PUSH    HL
000501 D5FA CD0CF2          17      CALL    SEEK        ;Read disk
000504 D5FD E1              10      POP HL
000505 D5FE DAF3E3          10      JP  C,ERRDR+AT_RS
000508 D601 F3               4      DI
000509 D602 CDB4F2          17      CALL    SECSET_FDCCMD
00050C D605 0EFB             7      LD  C,0FBH      ;MB8877A データレジスタ
       D607                     DRD1:
00050E D607 78               4      LD  A,B
00050F D608 DBF8            11      IN  A,(0F8H)    ;MB8877A ステータス／コマンドレジスタ
000511 D60A 0F               4      RRCA
000512 D60B 3008            12      JR  NC,DRD3
000514 D60D 0F               4      RRCA
000515 D60E 30F7            12      JR  NC,DRD1
000517 D610 EDA2            16      INI
000519 D612 04               4      INC B
00051A D613 18F2            12      JR  DRD1
                                
       D615                     DRD3:
00051C D615 B7               4      OR  A
00051D D616 FB               4      EI
00051E D617 D1              10      POP DE
00051F D618 13               6      INC DE
000520 D619 CDA7F2          17      CALL    FDMOFF
000523 D61C 2809            12      JR  Z,DISKOK_RD
000525 D61E CDC4E3          17      CALL    DISKC+AT_RS
000528 D621 20D5            12      JR  NZ,DRD0
00052A D623 B7               4      OR  A
00052B D624 C2E1E3          10      JP  NZ,ERRW+AT_RS
                                
       D627                     DISKOK_RD:
00052E D627 0601             7  AT_RDB: LD  B,1
000530 D629 10C4            13      DJNZ    DRDBL
000532 D62B C9              10      RET
                                
       D62C                     AT_CPUE:
                                
       2AE1                     AT_RT   EQU TRAP38-AT_TRAP38
                                
       D62C                     INITE:
000533 D62C                         DS  BDOS-INITE
00060D D706 C366DC          10      JP  BDOS0
[EOF:X1CPU.ASM:SHIFT_JIS]
                                    INCLUDE "X1CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   X1/turbo/Z
                                
       D709                     WBOOT1:
000610 D709 F3               4      DI
000611 D70A ED7B0600        20      LD  SP,(SYSTEM+1)
                                
000615 D70E 3EF4             7      LD  A,INTVEC/256
000617 D710 ED47             9      LD  I,A
                                
000619 D712 3EE4             7      LD  A,0E4H
00061B D714 CDF9E2          17      CALL    COMOUT
00061E D717 3EC8             7      LD  A,INTVEC-CPM_BOOT
000620 D719 CDD3E2          17      CALL    OT49SB
                                
000623 D71C 21B0F4          10      LD  HL,CRTCD
000626 D71F AF               4      XOR A
       D720                     SETCRT2:
000627 D720 010018          10      LD  BC,01800H
00062A D723 ED79            12      OUT (C),A
00062C D725 0C               4      INC C
00062D D726 56               7      LD  D,(HL)
00062E D727 FE0D             7      CP  13
000630 D729 3802            12      JR  C,SETCRT3
000632 D72B 1600             7      LD  D,0
       D72D                     SETCRT3:
000634 D72D ED51            12      OUT (C),D
000636 D72F 23               6      INC HL
000637 D730 3C               4      INC A
000638 D731 FE0E             7      CP  14
00063A D733 20EB            12      JR  NZ,SETCRT2
                                
00063C D735 01031B          10      LD  BC,01A03H+00100H
00063F D738 EDA3            16      OUTI
000641 D73A 01D020          10      LD  BC,01FD0H+00100H
000644 D73D EDA3            16      OUTI
000646 D73F 2192F4          10      LD  HL,_KEYD
000649 D742 7E               7      LD  A,(HL)
00064A D743 3600            10      LD  (HL),0
00064C D745 CD95DF          17      CALL    KEYBC_IFBREAK
00064F D748 3E04             7      LD  A,4
000651 D74A CDA8DF          17      CALL    MSG_A
[EOF:X1CCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D74D                     COMMAND:
000654 D74D 3AC3F3          13      LD  A,(FCB_BAT)
000657 D750 B7               4      OR  A
000658 D751 C293D8          10      JP  NZ,C_BAT1
00065B D754 CD07D8          17      CALL    SETDTA1
00065E D757 3A0400          13      LD  A,(_DVSW)
000661 D75A C641             7      ADD A,'A'
000663 D75C CDA8DF          17      CALL    MSG_A
000666 D75F 3E3E             7      LD  A,'>'
000668 D761 CDA8DF          17      CALL    MSG_A
00066B D764 3E50             7      LD  A,80
00066D D766 12               7      LD  (DE),A
00066E D767 CD29E0          17      CALL    _SYS0A      ;(BDOS)文字列入力
000671 D76A CD88D9          17      CALL    LTNL
       D76D                     COMMAND2:
000674 D76D 118200          10      LD  DE,DTA1+2
000677 D770 CDFDF4          17      CALL    _COMANL
00067A D773 30D8            12      JR  NC,COMMAND
00067C D775 1179F4          10      LD  DE,COMERM
00067F D778 CD97DC          17      CALL    _SYS09      ;(BDOS)文字列出力
000682 D77B C7              12      RST 0
                                
       D77C                     COMANL:
000683 D77C CDA7E4          17      CALL    FILE
000686 D77F 3A19F4          13      LD  A,(FNAME+4)
000689 D782 FE20             7      CP  020H
00068B D784 201C            12      JR  NZ,COMB2
00068D D786 D5              11      PUSH    DE
00068E D787 1115F4          10      LD  DE,FNAME
000691 D78A 1A               7      LD  A,(DE)
000692 D78B FE20             7      CP  020H
000694 D78D 2844            12      JR  Z,SDVSW
000696 D78F 1B               6      DEC DE
000697 D790 1A               7      LD  A,(DE)
000698 D791 C6FF             7      ADD A,0FFH
00069A D793 3809            12      JR  C,COMB
00069C D795 13               6      INC DE
                                
00069D D796 2145DB          10      LD  HL,COMTB
0006A0 D799 0608             7      LD  B,COMS
0006A2 D79B CD36E7          17      CALL    CPNAME
       D79E                     COMB:
0006A5 D79E D1              10      POP DE
0006A6 D79F D20F00          10      JP  NC,JP_HL
       D7A2                     COMB2:
0006A9 D7A2 EB               4      EX  DE,HL
0006AA D7A3 2270D8          16      LD  (COMSWC),HL
0006AD D7A6 F5              11      PUSH    AF
0006AE D7A7 CD28D8          17      CALL    CEXE4
0006B1 D7AA F1              10      POP AF
0006B2 D7AB 2115F4          10      LD  HL,FNAME
0006B5 D7AE 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
0006B8 D7B1 010B00          10      LD  BC,11
0006BB D7B4 EDB0                    LDIR
0006BD D7B6 1162F3          10      LD  DE,PATHD
       D7B9                     CEX1:
0006C0 D7B9 1A               7      LD  A,(DE)
0006C1 D7BA FE20             7      CP  020H
0006C3 D7BC D8              11      RET C
0006C4 D7BD CD9CE4          17      CALL    FILEC
0006C7 D7C0 D5              11      PUSH    DE
0006C8 D7C1 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
0006CB D7C4 1115F4          10      LD  DE,FNAME
0006CE D7C7 010B00          10      LD  BC,11
0006D1 D7CA EDB0                    LDIR
0006D3 D7CC CD28D8          17      CALL    CEXE4
0006D6 D7CF D1              10      POP DE
0006D7 D7D0 13               6      INC DE
0006D8 D7D1 18E6            12      JR  CEX1
                                
       D7D3                     SDVSW:
0006DA D7D3 F1              10      POP AF
0006DB D7D4 3A14F4          13      LD  A,(FDRV)
0006DE D7D7 3D               4      DEC A
0006DF D7D8 5F               4      LD  E,A
0006E0 D7D9 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
0006E2 D7DB 1831            12      JR  SYSTEM0
                                
       D7DD                     OPEN1:
0006E4 D7DD 2114F4          10      LD  HL,FDRV
       D7E0                     OPEN:
0006E7 D7E0 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D7E2                     OPEN3:
0006E9 D7E2 D5              11      PUSH    DE
0006EA D7E3 119EF3          10      LD  DE,DTA_CCP
0006ED D7E6 CD04D8          17      CALL    SETDTA
0006F0 D7E9 EB               4      EX  DE,HL
0006F1 D7EA CD0ED8          17      CALL    SYSTEM0
0006F4 D7ED D1              10      POP DE
0006F5 D7EE C9              10      RET
                                
       D7EF                     OPEN2:
0006F6 D7EF 0E12             7      LD  C,012H
0006F8 D7F1 18EF            12      JR  OPEN3
                                
       D7F3                     DEFCB:              ;Z=Ok NZ=Error
0006FA D7F3 119EF3          10      LD  DE,DTA_CCP
0006FD D7F6 CD0CD8          17      CALL    SYSC0F
                                
000700 D7F9 11BFF3          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
000703 D7FC 0604             7      LD  B,4
000705 D7FE CD59DA          17      CALL    ZERO_MEMORY_DE
       D801                     SETDTA100:
000708 D801 110001          10      LD  DE,BUFFER
       D804                     SETDTA:
00070B D804 C36ADE          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D807                     SETDTA1:
00070E D807 118000          10      LD  DE,DTA1
000711 D80A 18F8            12      JR  SETDTA
                                
       D80C                     SYSC0F:
000713 D80C 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D80E                     SYSTEM0:
000715 D80E CD0500          17      CALL    SYSTEM
000718 D811 B7               4      OR  A
000719 D812 C9              10      RET
                                
       D813                     C_CD:
00071A D813 0E5A             7      LD  C,05AH
00071C D815 18F7            12      JR  SYSTEM0
                                
       D817                     S27BUF:
00071E D817 2100FE          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       D81A                     S27BUF2:
000721 D81A 39              11      ADD HL,SP
000722 D81B 2E00             7      LD  L,0
000724 D81D 7C               4      LD  A,H
000725 D81E E6F8             7      AND 0F8H
000727 D820 67               4      LD  H,A
       D821                     S27DTA:
000728 D821 119EF3          10      LD  DE,DTA_CCP
       D824                     S27:
00072B D824 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
00072D D826 18E6            12      JR  SYSTEM0
                                
       D828                     CEXE4:
00072F D828 211DF4          10      LD  HL,FNAME+8
000732 D82B 7E               7      LD  A,(HL)
000733 D82C FE20             7      CP  020H
000735 D82E 2007            12      JR  NZ,CEXE7
000737 D830 3E3F             7      LD  A,'?'
000739 D832 77               7      LD  (HL),A
00073A D833 23               6      INC HL
00073B D834 77               7      LD  (HL),A
00073C D835 23               6      INC HL
00073D D836 77               7      LD  (HL),A
       D837                     CEXE7:
00073E D837 CDDDD7          17      CALL    OPEN1
       D83A                     CEXE5:
000741 D83A C0              11      RET NZ
000742 D83B 2AA8F3          16      LD  HL,(DTA_CCP+1+9)
000745 D83E 7C               4      LD  A,H
000746 D83F CDBEE7          17      CALL    CAP
000749 D842 67               4      LD  H,A
00074A D843 7D               4      LD  A,L
00074B D844 CDBEE7          17      CALL    CAP
00074E D847 6F               4      LD  L,A
00074F D848 3AA7F3          13      LD  A,(DTA_CCP+1+8)
000752 D84B CDBEE7          17      CALL    CAP
000755 D84E D642             7      SUB 'B'
000757 D850 282C            12      JR  Z,C_BAT
000759 D852 3D               4      DEC A       ;'C'
00075A D853 2805            12      JR  Z,C_EXE
       D855                     CEXE6:
00075C D855 CDEFD7          17      CALL    OPEN2
00075F D858 18E0            12      JR  CEXE5
                                
       D85A                     C_EXE:
000761 D85A 7C               4      LD  A,H
000762 D85B FE4D             7      CP  'M'
000764 D85D 20F6            12      JR  NZ,CEXE6
                                
000766 D85F CDF3D7          17      CALL    DEFCB
000769 D862 CD17D8          17      CALL    S27BUF_COM
00076C D865 3D               4      DEC A
00076D D866 37               4      SCF
00076E D867 C0              11      RET NZ
00076F D868 7C               4      LD  A,H
000770 D869 B5               4      OR  L
000771 D86A 37               4      SCF
000772 D86B C8              11      RET Z
000773 D86C CD07D8          17      CALL    SETDTA1
000776 D86F 110000          10      LD  DE,0                ; self-modifying code
       D870                     COMSWC  EQU $-2
000779 D872 ED7B0600        20      LD  SP,(SYSTEM+1)
00077D D876 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
00077E D877 6F               4      LD  L,A
00077F D878 E5              11      PUSH    HL              ; push $0000 (reboot address)
000780 D879 24               4      INC H
000781 D87A E5              11      PUSH    HL              ; push $0100 (TPA address)
000782 D87B C324DA          10      JP  SETFCB              ; and JP $0100
                                
       D87E                     C_BAT:
000785 D87E 114154          10      LD  DE,'A'+'T'*256
000788 D881 ED52            15      SBC HL,DE
00078A D883 20D0            12      JR  NZ,CEXE6
                                
00078C D885 CDF3D7          17      CALL    DEFCB
                                
00078F D888 219EF3          10      LD  HL,DTA_CCP
000792 D88B 11C3F3          10      LD  DE,FCB_BAT
000795 D88E 012500          10      LD  BC,37
000798 D891 EDB0                    LDIR
       D893                     C_BAT1:
00079A D893 CD01D8          17      CALL    SETDTA100
00079D D896 CDCAD8          17      CALL    FGETC_BAT
0007A0 D899 218100          10      LD  HL,DTA1+1
0007A3 D89C 2025            12      JR  NZ,END_BATCH
0007A5 D89E FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
0007A7 D8A0 38F1            12      JR  C,C_BAT1
0007A9 D8A2 3620            10      LD  (HL),' '
0007AB D8A4 23               6      INC HL
       D8A5                     C_BAT2:
0007AC D8A5 77               7      LD  (HL),A
0007AD D8A6 23               6      INC HL
0007AE D8A7 7D               4      LD  A,L
0007AF D8A8 3C               4      INC A       ;L==0FFH
0007B0 D8A9 2809            12      JR  Z,RUN_BATCH
0007B2 D8AB CDCAD8          17      CALL    FGETC_BAT
0007B5 D8AE 2004            12      JR  NZ,RUN_BATCH
0007B7 D8B0 FE20             7      CP  020H
0007B9 D8B2 30F1            12      JR  NC,C_BAT2
       D8B4                     RUN_BATCH:
0007BB D8B4 7D               4      LD  A,L
0007BC D8B5 D67F             7      SUB DTA1-1
0007BE D8B7 328000          13      LD  (DTA1),A
0007C1 D8BA FE04             7      CP  4
0007C3 D8BC 3805            12      JR  C,END_BATCH
0007C5 D8BE 3600            10      LD  (HL),0
0007C7 D8C0 C36DD7          10      JP  COMMAND2
       D8C3                     END_BATCH:
0007CA D8C3 AF               4      XOR A       ;バッチファイルを閉じる
0007CB D8C4 32C3F3          13      LD  (FCB_BAT),A
0007CE D8C7 C300F4          10      JP  CPM_BOOT
                                
       D8CA                     FGETC_BAT:
0007D1 D8CA 11C3F3          10      LD  DE,FCB_BAT
       D8CD                     FGETC:              ;1文字ずつ読み込む
0007D4 D8CD E5              11      PUSH    HL      ;Z:成功
0007D5 D8CE 210100          10      LD  HL,1
0007D8 D8D1 CD24D8          17      CALL    S27
0007DB D8D4 E1              10      POP HL
0007DC D8D5 3A0001          13      LD  A,(BUFFER)
0007DF D8D8 C9              10      RET
                                
       D8D9                     C_DEL:
0007E0 D8D9 CD24DA          17      CALL    SETFCB
0007E3 D8DC CDBEDF          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
0007E6 D8DF 0E13             7      LD  C,013H
0007E8 D8E1 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D8E3                     C_REN:
0007EA D8E3 CD24DA          17      CALL    SETFCB
0007ED D8E6 3E10             7      LD  A,010H      ;ディレクトリも対象にする
0007EF D8E8 326900          13      LD  (FCB1+13),A ;属性
0007F2 D8EB 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D8ED                     CDEL1:
0007F4 D8ED 115C00          10      LD  DE,FCB1
0007F7 D8F0 CD0500          17      CALL    SYSTEM
0007FA D8F3 C6FF             7      ADD A,0FFH
0007FC D8F5 C9              10      RET
                                
       D8F6                     C_DIR:
0007FD D8F6 CD9CE4          17      CALL    FILEC
000800 D8F9 2115F4          10      LD  HL,FDRV+1
000803 D8FC CD3ADB          17      CALL    CWILD1
000806 D8FF 3EF1             7      LD  A,0F1H
000808 D901 3221F4          13      LD  (FDRV+13),A
00080B D904 CDDDD7          17      CALL    OPEN1
       D907                     CDIR1:
00080E D907 B7               4      OR  A
00080F D908 2008            12      JR  NZ,PDSKF
000811 D90A CD55D9          17      CALL    P_NAME
000814 D90D CDEFD7          17      CALL    OPEN2
000817 D910 18F5            12      JR  CDIR1
       D912                     PDSKF:
000819 D912 3A14F4          13      LD  A,(FDRV)
00081C D915 5F               4      LD  E,A
00081D D916 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
00081F D918 CD0500          17      CALL    SYSTEM
000822 D91B 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
000823 D91C C601             7      ADD A,001H
000825 D91E D8              11      RET C       ;Aが0FFHだった場合
000826 D91F 3E06             7      LD  A,8-2
       D921                     PDS1:               ;HL=未使用クラスタの総数
000828 D921 3C               4      INC A
000829 D922 CB19             8      RR  C
00082B D924 30FB            12      JR  NC,PDS1
       D926                     PDS2:               ;B←論理セクタのサイズの上位8ビット
00082D D926 3C               4      INC A
00082E D927 CB18             8      RR  B
000830 D929 30FB            12      JR  NC,PDS2
000832 D92B 47               4      LD  B,A
                                
000833 D92C 110000          10      LD  DE,0
       D92F                     PDS3:
000836 D92F 29              11      ADD HL,HL
000837 D930 EB               4      EX  DE,HL
000838 D931 ED6A            15      ADC HL,HL
00083A D933 EB               4      EX  DE,HL
00083B D934 10F9            13      DJNZ    PDS3
       D936                     PDSKF1:
00083D D936 CDC2D9          17      CALL    PRDEC_DEHL
000840 D939 11F3F3          10      LD  DE,FREE
000843 D93C CD97DC          17      CALL    _SYS09      ;(BDOS)文字列出力
000846 D93F CDAFD9          17      CALL    PUTDRV
000849 D942 3E5C             7      LD  A,05CH      ;\
00084B D944 CDA8DF          17      CALL    MSG_A
00084E D947 2A22F4          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
000851 D94A AF               4      XOR A
000852 D94B 11FEFF          10      LD  DE,0-2
000855 D94E 19              11      ADD HL,DE
000856 D94F 23               6      INC HL
000857 D950 DCBFD9          17      CALL    C,PRDEC_HL
00085A D953 1833            12      JR  LTNL
                                
       D955                     P_NAME:
00085C D955 3A9FF3          13      LD  A,(DTA_CCP+1)
00085F D958 FE2E             7      CP  '.'
000861 D95A C8              11      RET Z
                                
000862 D95B 3AAAF3          13      LD  A,(DTA_CCP+1+00BH)
000865 D95E F5              11      PUSH    AF
000866 D95F CB67             8      BIT 4,A
000868 D961 2808            12      JR  Z,DIR3
00086A D963 11E8F3          10      LD  DE,DIRMES
00086D D966 CD97DC          17      CALL    _SYS09      ;(BDOS)文字列出力
000870 D969 180A            12      JR  DIR6
       D96B                     DIR3:
000872 D96B ED5BBDF3        20      LD  DE,(DTA_CCP+1+01EH)
000876 D96F 2ABBF3          16      LD  HL,(DTA_CCP+1+01CH)
000879 D972 CDC2D9          17      CALL    PRDEC_DEHL
       D975                     DIR6:
00087C D975 F1              10      POP AF
00087D D976 0F               4      RRCA
00087E D977 9F               4      SBC A,A
00087F D978 E60A             7      AND '*'-020H
000881 D97A C620             7      ADD A,020H
000883 D97C CDA8DF          17      CALL    MSG_A
000886 D97F CDAFD9          17      CALL    PUTDRV
000889 D982 219FF3          10      LD  HL,DTA_CCP+1
00088C D985 CD02DA          17      CALL    FPRNT
                                
       D988                     LTNL:
00088F D988 1E03             7      LD  E,3
000891 D98A C3CDF4          10      JP  _PRINT
                                
       D98D                     C_PATH:
000894 D98D CD7EE5          17      CALL    SPCUT
000897 D990 2162F3          10      LD  HL,PATHD
00089A D993 FE21             7      CP  021H
00089C D995 300C            12      JR  NC,CPATH0
       D997                     CPATHP:
00089E D997 7E               7      LD  A,(HL)
00089F D998 23               6      INC HL
0008A0 D999 FE20             7      CP  020H
0008A2 D99B 3F               4      CCF
0008A3 D99C 30EA            12      JR  NC,LTNL
0008A5 D99E CDA8DF          17      CALL    MSG_A
0008A8 D9A1 18F4            12      JR  CPATHP
       D9A3                     CPATH0:
0008AA D9A3 FE3B             7      CP  ';'
0008AC D9A5 2001            12      JR  NZ,CPATH1
0008AE D9A7 13               6      INC DE
       D9A8                     CPATH1:
0008AF D9A8 EB               4      EX  DE,HL
0008B0 D9A9 013B00          10      LD  BC,PATHX
0008B3 D9AC EDB0                    LDIR
0008B5 D9AE C9              10      RET
                                
       D9AF                     PUTDRV:
0008B6 D9AF 3A14F4          13      LD  A,(FDRV)
0008B9 D9B2 CDB1E5          17      CALL    GETDRV1
0008BC D9B5 C641             7      ADD A,'A'
0008BE D9B7 CDA8DF          17      CALL    MSG_A
0008C1 D9BA 3E3A             7      LD  A,':'
       D9BC                     MSG_AR:
0008C3 D9BC C3A8DF          10      JP  MSG_A
                                
       D9BF                     PRDEC_HL:
0008C6 D9BF AF               4      XOR A
0008C7 D9C0 5F               4      LD  E,A
0008C8 D9C1 57               4      LD  D,A
       D9C2                     PRDEC_DEHL:
0008C9 D9C2 D5              11      PUSH    DE
0008CA D9C3 110FF4          10      LD  DE,DECBF
0008CD D9C6 0605             7      LD  B,5
0008CF D9C8 CD59DA          17      CALL    ZERO_MEMORY_DE  ;A=0
0008D2 D9CB D1              10      POP DE
                                
0008D3 D9CC 0E20             7      LD  C,32
       D9CE                     DEC1:
0008D5 D9CE 29              11      ADD HL,HL
0008D6 D9CF EB               4      EX  DE,HL
0008D7 D9D0 ED6A            15      ADC HL,HL
0008D9 D9D2 EB               4      EX  DE,HL
0008DA D9D3 E5              11      PUSH    HL
0008DB D9D4 2113F4          10      LD  HL,DECBF+4
0008DE D9D7 0605             7      LD  B,5
       D9D9                     DEC2:
0008E0 D9D9 7E               7      LD  A,(HL)
0008E1 D9DA 8F               4      ADC A,A
0008E2 D9DB 27               4      DAA
0008E3 D9DC 77               7      LD  (HL),A
0008E4 D9DD 2B               6      DEC HL
0008E5 D9DE 10F9            13      DJNZ    DEC2
0008E7 D9E0 E1              10      POP HL
0008E8 D9E1 0D               4      DEC C
0008E9 D9E2 20EA            12      JR  NZ,DEC1
                                
0008EB D9E4 210FF4          10      LD  HL,DECBF
0008EE D9E7 3E20             7      LD  A,020H
0008F0 D9E9 0604             7      LD  B,4
       D9EB                     DEC3:
0008F2 D9EB CDF8D9          17      CALL    DEC4
0008F5 D9EE CDF8D9          17      CALL    DEC4
0008F8 D9F1 23               6      INC HL
0008F9 D9F2 10F7            13      DJNZ    DEC3
       D9F4                     DECX:
0008FB D9F4 CDF8D9          17      CALL    DEC4
0008FE D9F7 AF               4      XOR A
       D9F8                     DEC4:
0008FF D9F8 ED6F            18      RLD
000901 D9FA FE20             7      CP  020H
000903 D9FC 2802            12      JR  Z,DEC5
000905 D9FE F630             7      OR  030H
       DA00                     DEC5:
000907 DA00 18BA            12      JR  MSG_AR
                                
       DA02                     FPRNT:
000909 DA02 0608             7      LD  B,8 ;ファイル名を表示
00090B DA04 CD13DA          17      CALL    P_N1
00090E DA07 7E               7      LD  A,(HL)
00090F DA08 CDCAE7          17      CALL    CAP3
000912 DA0B D8              11      RET C   ;拡張子が無い
                                
000913 DA0C 3E2E             7      LD  A,'.'
000915 DA0E CDA8DF          17      CALL    MSG_A
000918 DA11 0603             7      LD  B,3 ;拡張子を表示
       DA13                     P_N1:
00091A DA13 7E               7      LD  A,(HL)
00091B DA14 CDCAE7          17      CALL    CAP3
00091E DA17 3807            12      JR  C,P_N2
000920 DA19 CDA8DF          17      CALL    MSG_A
000923 DA1C 23               6      INC HL
000924 DA1D 10F4            13      DJNZ    P_N1
000926 DA1F C9              10      RET
       DA20                     P_N2:
000927 DA20 23               6      INC HL
000928 DA21 10FD            13      DJNZ    P_N2
00092A DA23 C9              10      RET
                                
       DA24                     SETFCB:
00092B DA24 CD7EE5          17      CALL    SPCUT
00092E DA27 1A               7      LD  A,(DE)
00092F DA28 FE20             7      CP  020H
000931 DA2A 3801            12      JR  C,SETFCBA
000933 DA2C 1B               6      DEC DE
       DA2D                     SETFCBA:
000934 DA2D 0624             7      LD  B,36
000936 DA2F 215C00          10      LD  HL,FCB1
000939 DA32 E5              11      PUSH    HL
00093A DA33 AF               4      XOR A
00093B DA34 CD53E5          17      CALL    FILL_MEMORY
00093E DA37 E1              10      POP HL
00093F DA38 D5              11      PUSH    DE
000940 DA39 CDD1DE          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000943 DA3C 216C00          10      LD  HL,FCB2
000946 DA3F CDD1DE          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000949 DA42 E1              10      POP HL
00094A DA43 010050          10      LD  BC,05000H
00094D DA46 118100          10      LD  DE,00081H
       DA49                     SETFCB1:
000950 DA49 7E               7      LD  A,(HL)
000951 DA4A 23               6      INC HL
000952 DA4B FE20             7      CP  020H
000954 DA4D 3805            12      JR  C,SETFCB2
000956 DA4F 12               7      LD  (DE),A
000957 DA50 13               6      INC DE
000958 DA51 0C               4      INC C
000959 DA52 10F5            13      DJNZ    SETFCB1
       DA54                     SETFCB2:
00095B DA54 79               4      LD  A,C
00095C DA55 328000          13      LD  (DTA1),A
00095F DA58 04               4      INC B
       DA59                     ZERO_MEMORY_DE:
000960 DA59 AF               4      XOR A
       DA5A                     FILL_MEMORY_DE:
000961 DA5A 12               7      LD  (DE),A
000962 DA5B 13               6      INC DE
000963 DA5C 10FC            13      DJNZ    FILL_MEMORY_DE
000965 DA5E C9              10      RET
                                
       DA5F                     C_COPY:
000966 DA5F CD24DA          17      CALL    SETFCB
                                
000969 DA62 1161F4          10      LD  DE,ZERO
00096C DA65 CD9FE4          17      CALL    FILEC2
00096F DA68 216C00          10      LD  HL,FCB2
000972 DA6B CDD8DE          17      CALL    S29X1
                                
000975 DA6E 3E10             7      LD  A,010H
000977 DA70 326900          13      LD  (FCB1+13),A
00097A DA73 216D00          10      LD  HL,FCB2FN
00097D DA76 CD3ADB          17      CALL    CWILD1
       DA79                     COPY0:
000980 DA79 CD37DB          17      CALL    CWILD
000983 DA7C 215C00          10      LD  HL,FCB1
000986 DA7F CDE0D7          17      CALL    OPEN
000989 DA82 37               4      SCF
       DA83                     COPY1:
00098A DA83 C0              11      RET NZ
00098B DA84 CDF3D7          17      CALL    DEFCB
                                
00098E DA87 3AABF3          13      LD  A,(DTA_CCP+13)
000991 DA8A CB67             8      BIT 4,A
000993 DA8C 2821            12      JR  Z,COPY1A
                                
000995 DA8E 215D00          10      LD  HL,FCB1FN
000998 DA91 CDE2E8          17      CALL    CHKWILD
00099B DA94 3814            12      JR  C,COPY9
                                
00099D DA96 3E20             7      LD  A,020H
00099F DA98 325D00          13      LD  (FCB1FN),A
0009A2 DA9B 2AB8F3          16      LD  HL,(DTA_CCP+26)
0009A5 DA9E 23               6      INC HL
0009A6 DA9F 226A00          16      LD  (FCB1+14),HL
0009A9 DAA2 18D5            12      JR  COPY0
                                
       DAA4                     COPY8:
0009AB DAA4 CD97DC          17      CALL    _SYS09      ;(BDOS)文字列出力
0009AE DAA7 CD88D9          17      CALL    LTNL
       DAAA                     COPY9:
0009B1 DAAA CDEFD7          17      CALL    OPEN2
0009B4 DAAD 18D4            12      JR  COPY1
                                
       DAAF                     COPY1A:
0009B6 DAAF 216C00          10      LD  HL,FCB2
0009B9 DAB2 1114F4          10      LD  DE,FDRV
0009BC DAB5 01A0F3          10      LD  BC,DTA_CCP+2
0009BF DAB8 EDA0            16      LDI
0009C1 DABA 3E0B             7      LD  A,11
       DABC                     COPY2:
0009C3 DABC F5              11      PUSH    AF
0009C4 DABD 7E               7      LD  A,(HL)
0009C5 DABE FE3F             7      CP  '?'
0009C7 DAC0 2001            12      JR  NZ,COPY3
0009C9 DAC2 0A               7      LD  A,(BC)
       DAC3                     COPY3:
0009CA DAC3 12               7      LD  (DE),A
0009CB DAC4 03               6      INC BC
0009CC DAC5 13               6      INC DE
0009CD DAC6 23               6      INC HL
0009CE DAC7 F1              10      POP AF
0009CF DAC8 3D               4      DEC A
0009D0 DAC9 20F1            12      JR  NZ,COPY2
0009D2 DACB 010500          10      LD  BC,16-11
0009D5 DACE EDB0                    LDIR
       DAD0                     PUTNAME:
0009D7 DAD0 215D00          10      LD  HL,FCB1FN
0009DA DAD3 CDE2E8          17      CALL    CHKWILD
0009DD DAD6 300B            12      JR  NC,PUTN1
0009DF DAD8 2115F4          10      LD  HL,FDRV+1
0009E2 DADB CD02DA          17      CALL    FPRNT
0009E5 DADE 3E20             7      LD  A,020H
0009E7 DAE0 CDA8DF          17      CALL    MSG_A
       DAE3                     PUTN1:
0009EA DAE3 1114F4          10      LD  DE,FDRV
0009ED DAE6 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
0009EF DAE8 CD0ED8          17      CALL    SYSTEM0
0009F2 DAEB 2048            12      JR  NZ,COPYE2
0009F4 DAED 67               4      LD  H,A     ;A=0
0009F5 DAEE 6F               4      LD  L,A
0009F6 DAEF 2235F4          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0009F9 DAF2 2237F4          16      LD  (FDRV+35),HL
       DAF5                     COPY6:
0009FC DAF5 CD17D8          17      CALL    S27BUF
0009FF DAF8 47               4      LD  B,A
000A00 DAF9 3C               4      INC A
000A01 DAFA 2831            12      JR  Z,COPYE
000A03 DAFC 7C               4      LD  A,H
000A04 DAFD B5               4      OR  L
000A05 DAFE 280C            12      JR  Z,COPY7
000A07 DB00 1114F4          10      LD  DE,FDRV
000A0A DB03 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
000A0C DB05 CD0ED8          17      CALL    SYSTEM0
000A0F DB08 2023            12      JR  NZ,COPYE
000A11 DB0A 10E9            13      DJNZ    COPY6
       DB0C                     COPY7:
000A13 DB0C 3AABF3          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
000A16 DB0F 3221F4          13      LD  (FDRV+13),A
000A19 DB12 21B2F3          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
000A1C DB15 1128F4          10      LD  DE,FDRV+20
000A1F DB18 010400          10      LD  BC,4
000A22 DB1B EDB0                    LDIR
                                
000A24 DB1D 1114F4          10      LD  DE,FDRV
000A27 DB20 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
000A29 DB22 CD0ED8          17      CALL    SYSTEM0
000A2C DB25 2006            12      JR  NZ,COPYE
                                
000A2E DB27 1171F4          10      LD  DE,OK
000A31 DB2A C3A4DA          10      JP  COPY8
                                
       DB2D                     COPYE:
000A34 DB2D 1114F4          10      LD  DE,FDRV
000A37 DB30 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
000A39 DB32 CD0500          17      CALL    SYSTEM
       DB35                     COPYE2:
000A3C DB35 37               4      SCF
000A3D DB36 C9              10      RET
                                
       DB37                     CWILD:
000A3E DB37 215D00          10      LD  HL,FCB1FN
       DB3A                     CWILD1:
000A41 DB3A 7E               7      LD  A,(HL)
000A42 DB3B FE20             7      CP  020H
000A44 DB3D C0              11      RET NZ
       DB3E                     CWILD2:
000A45 DB3E 3E3F             7      LD  A,'?'
000A47 DB40 060B             7      LD  B,11
000A49 DB42 C353E5          10      JP  FILL_MEMORY
                                
       DB45                     COMTB:
000A4C DB45 44202020                DB  "D   "  ;1
000A50 DB49 F6D8                    DW  C_DIR
000A52 DB4B 44495220                DB  "DIR "  ;2
000A56 DB4F F6D8                    DW  C_DIR
000A58 DB51 434F5059                DB  "COPY"  ;3
000A5C DB55 5FDA                    DW  C_COPY
000A5E DB57 43442020                DB  "CD  "  ;4
000A62 DB5B 13D8                    DW  C_CD
000A64 DB5D 44454C20                DB  "DEL "  ;5
000A68 DB61 D9D8                    DW  C_DEL
000A6A DB63 50415448                DB  "PATH"  ;6
000A6E DB67 8DD9                    DW  C_PATH
000A70 DB69 52454E20                DB  "REN "  ;7
000A74 DB6D E3D8                    DW  C_REN
000A76 DB6F 52454D20                DB  "REM "  ;8
000A7A DB73 94DC                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "X1DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   X1/turbo/Z
                                
                                ;   GRAPHIC RAM DISK DRIVER
                                
                                
       DB75                     GDRD:
000A7C DB75 C5              11      PUSH    BC
000A7D DB76 CD9EDB          17      CALL    GADR
000A80 DB79 F1              10      POP AF
       DB7A                     GDRD1:
000A81 DB7A EDA2            16      INI
000A83 DB7C 04               4      INC B
000A84 DB7D 0C               4      INC C
000A85 DB7E 20FA            12      JR  NZ,GDRD1
000A87 DB80 04               4      INC B
000A88 DB81 13               6      INC DE
000A89 DB82 3D               4      DEC A
000A8A DB83 20F5            12      JR  NZ,GDRD1
       DB85                     GBANK0:
000A8C DB85 3ABFF4          13      LD  A,(WK1FD0)
000A8F DB88 E6EF             7      AND 0EFH        ;BANK0
000A91 DB8A 181D            12      JR  S1FD0
                                
       DB8C                     GDWT:
000A93 DB8C C5              11      PUSH    BC
000A94 DB8D CD9EDB          17      CALL    GADR
000A97 DB90 F1              10      POP AF
       DB91                     GDWT1:
000A98 DB91 04               4      INC B
000A99 DB92 EDA3            16      OUTI
000A9B DB94 0C               4      INC C
000A9C DB95 20FA            12      JR  NZ,GDWT1
000A9E DB97 04               4      INC B
000A9F DB98 13               6      INC DE
000AA0 DB99 3D               4      DEC A
000AA1 DB9A 20F5            12      JR  NZ,GDWT1
000AA3 DB9C 18E7            12      JR  GBANK0
                                
       DB9E                     GADR:
000AA5 DB9E 0E00             7      LD  C,0
000AA7 DBA0 7B               4      LD  A,E
000AA8 DBA1 C640             7      ADD A,040H
000AAA DBA3 47               4      LD  B,A
000AAB DBA4 3ABFF4          13      LD  A,(WK1FD0)
000AAE DBA7 F610             7      OR  010H        ;BANK1
       DBA9                     S1FD0:
000AB0 DBA9 C5              11      PUSH    BC
000AB1 DBAA 32BFF4          13      LD  (WK1FD0),A
000AB4 DBAD 01D01F          10      LD  BC,01FD0H
000AB7 DBB0 ED79            12      OUT (C),A
000AB9 DBB2 C1              10      POP BC
000ABA DBB3 C9              10      RET
                                
                                
                                ;   BANK RAM DISK DRIVER
                                
       DBB4                     BDWT:
000ABB DBB4 3E                      DB  03EH    ;LD A,??
000ABC DBB5 37               4      SCF
000ABD DBB6 1802            12      JR  BRW
                                
       DBB8                     BDRD:
000ABF DBB8 3E                      DB  03EH    ;LD A,??
000AC0 DBB9 A7               4      AND A
       DBBA                     BRW:
000AC1 DBBA F3               4      DI
000AC2 DBBB 32E6DB          13      LD  (BRWPAT),A
000AC5 DBBE ED7306DC        20      LD  (BANKSP),SP
000AC9 DBC2 3A07DC          13      LD  A,(BANKSP_H)
000ACC DBC5 87               4      ADD A,A
000ACD DBC6 3803            12      JR  C,BRW0
000ACF DBC8 31CAFF          10      LD  SP,EXTSP
       DBCB                     BRW0:
000AD2 DBCB D9               4      EXX     ;裏レジスタ
000AD3 DBCC C5              11       PUSH    BC
000AD4 DBCD D5              11       PUSH    DE
000AD5 DBCE 01000B          10       LD  BC,00B00H   ;バンクメモリ
000AD8 DBD1 111010          10       LD  DE,01010H
000ADB DBD4 D9               4       EXX        ;表レジスタ
       DBD5                     BRW1:
000ADC DBD5 C5              11      PUSH    BC
000ADD DBD6 D5              11      PUSH    DE
000ADE DBD7 EB               4      EX  DE,HL
000ADF DBD8 29              11      ADD HL,HL
000AE0 DBD9 29              11      ADD HL,HL
000AE1 DBDA 7C               4      LD  A,H
000AE2 DBDB DD860C          19      ADD A,(IX+DPB_MAXCYL)
000AE5 DBDE E60F             7      AND 00FH    ;バンク
000AE7 DBE0 65               4      LD  H,L
000AE8 DBE1 CB3C             8      SRL H   ;/2
000AEA DBE3 2E00             7      LD  L,0
000AEC DBE5 D9               4      EXX     ;裏レジスタ
000AED DBE6 A7               4  BRWPAT:  AND     A  ;自己書き換え(AND A:読み出し/SCF:書き込み)
000AEE DBE7 3808            12       JR  C,BRWT
000AF0 DBE9 57               4       LD  D,A     ;D=バンク
000AF1 DBEA D9               4       EXX        ;表レジスタ
000AF2 DBEB EB               4      EX  DE,HL
000AF3 DBEC CD0ADC          17      CALL    BTFR
000AF6 DBEF 1806            12      JR  BRW2
       DBF1                     BRWT:
000AF8 DBF1 5F               4       LD E,A  ;E=バンク
000AF9 DBF2 D9               4       EXX        ;表レジスタ
000AFA DBF3 CD0ADC          17      CALL    BTFR
000AFD DBF6 EB               4      EX  DE,HL
       DBF7                     BRW2:
000AFE DBF7 D1              10      POP DE
000AFF DBF8 C1              10      POP BC
000B00 DBF9 13               6      INC DE
000B01 DBFA 10D9            13      DJNZ    BRW1
                                
000B03 DBFC D9               4      EXX     ;裏レジスタ
000B04 DBFD 3E10             7       LD  A,10H
000B06 DBFF ED79            12       OUT     (C),A      ;メインメモリに切り替える
000B08 DC01 D1              10       POP     DE
000B09 DC02 C1              10       POP     BC
000B0A DC03 D9               4       EXX        ;表レジスタ
000B0B DC04 AF               4      XOR A
000B0C DC05 310000          10      LD  SP,0
       DC07                     BANKSP_H    EQU $-1
       DC06                     BANKSP      EQU $-2
000B0F DC08 FB               4      EI
000B10 DC09 C9              10      RET
                                
                                ;メインメモリ←→バンクメモリ 512バイトの転送を行う
                                ; DE:転送元アドレス
                                ; HL:転送先アドレス
                                ; 裏BC:バンク切り替えポート(0B00H)
                                ; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
                                ; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
                                
       DC0A                     BTFR:
000B11 DC0A 0600             7      LD  B,0 ;256回ループ(256*2)
       DC0C                     BTFR1:
000B13 DC0C D9               4      EXX     ;裏レジスタ
000B14 DC0D ED51            12       OUT     (C),D   ;BANK(MAIN)
000B16 DC0F D9               4       EXX        ;表レジスタ
000B17 DC10 1A               7      LD  A,(DE)
000B18 DC11 4F               4      LD  C,A
000B19 DC12 13               6      INC DE
000B1A DC13 1A               7      LD  A,(DE)
000B1B DC14 13               6      INC DE
000B1C DC15 D9               4      EXX     ;裏レジスタ
000B1D DC16 ED59            12       OUT     (C),E   ;MAIN(BANK)
000B1F DC18 D9               4       EXX        ;表レジスタ
000B20 DC19 71               7      LD  (HL),C
000B21 DC1A 23               6      INC HL
000B22 DC1B 77               7      LD  (HL),A
000B23 DC1C 23               6      INC HL
000B24 DC1D 10ED            13      DJNZ    BTFR1
000B26 DC1F C9              10      RET
                                
                                ;   EMM DRIVER(CPU)
                                
       DC20                     EDWT:
000B27 DC20 CD48DC          17      CALL    EADR
       DC23                     EDWT0:
000B2A DC23 F5              11      PUSH    AF
000B2B DC24 AF               4      XOR A
       DC25                     EDWT1:
000B2C DC25 04               4      INC B
000B2D DC26 EDA3            16      OUTI
000B2F DC28 04               4      INC B
000B30 DC29 EDA3            16      OUTI
000B32 DC2B 3D               4      DEC A
000B33 DC2C 20F7            12      JR  NZ,EDWT1
000B35 DC2E 13               6      INC DE
000B36 DC2F F1              10      POP AF
000B37 DC30 3D               4      DEC A
000B38 DC31 20F0            12      JR  NZ,EDWT0
000B3A DC33 C9              10      RET
                                
       DC34                     EDRD:
000B3B DC34 CD48DC          17      CALL    EADR
       DC37                     EDRD0:
000B3E DC37 F5              11      PUSH    AF
000B3F DC38 AF               4      XOR A
       DC39                     EDRD1:
000B40 DC39 EDA2            16      INI
000B42 DC3B 04               4      INC B
000B43 DC3C EDA2            16      INI
000B45 DC3E 04               4      INC B
000B46 DC3F 3D               4      DEC A
000B47 DC40 20F7            12      JR  NZ,EDRD1
000B49 DC42 13               6      INC DE
000B4A DC43 F1              10      POP AF
000B4B DC44 3D               4      DEC A
000B4C DC45 20F0            12      JR  NZ,EDRD0
000B4E DC47 C9              10      RET
                                
       DC48                     EADR:
000B4F DC48 C5              11      PUSH    BC
000B50 DC49 D5              11      PUSH    DE
000B51 DC4A EB               4      EX  DE,HL
000B52 DC4B 29              11      ADD HL,HL
000B53 DC4C DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
000B56 DC4F DD460C          19      LD  B,(IX+DPB_MAXCYL)
000B59 DC52 09              11      ADD HL,BC
000B5A DC53 DD4E13          19      LD  C,(IX+DPB_UNITNO)
000B5D DC56 060D             7      LD  B,00DH
000B5F DC58 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
000B61 DC5A 0C               4      INC C
000B62 DC5B ED69            12      OUT (C),L
000B64 DC5D 0C               4      INC C
000B65 DC5E ED61            12      OUT (C),H
000B67 DC60 0C               4      INC C
000B68 DC61 EB               4      EX  DE,HL
000B69 DC62 D1              10      POP DE
000B6A DC63 F1              10      POP AF
000B6B DC64 A7               4      AND A   ;CF=0
000B6C DC65 C9              10      RET
                                
                                
[EOF:X1DISK2.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       DC66                     BDOS0:
000B6D DC66 E5              11      PUSH    HL
000B6E DC67 79               4      LD  A,C
000B6F DC68 FE3C             7      CP  03CH
000B71 DC6A 3802            12      JR  C,DOS1
000B73 DC6C 3E3C             7      LD  A,03CH
       DC6E                     DOS1:
000B75 DC6E 87               4      ADD A,A
000B76 DC6F 3273DC          13      LD  (DOS1_SWC),A
000B79 DC72 2A00F5          16      LD  HL,(STABLE)
       DC73                     DOS1_SWC    EQU $-2
000B7C DC75 E3              19      EX  (SP),HL
000B7D DC76 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
000B7E DC77 C9              10      RET
       DC78                     _DOS2:
000B7F DC78 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000B81 DC7A CA13DF          10      JP  Z,_SYS5A
000B84 DC7D FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000B86 DC7F CAD0DE          10      JP  Z,_SYS5C
000B89 DC82 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
000B8B DC84 CAF0F1          10      JP  Z,_SYS5F
000B8E DC87 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000B90 DC89 200A            12      JR  NZ,_ERROR
000B92 DC8B 011D01          10      LD  BC,VER_6F
000B95 DC8E 116101          10      LD  DE,VER
000B98 DC91 210000          10      LD  HL,MACD
       DC94                     C_REM:
000B9B DC94 AF               4      XOR A
       DC95                     _ERROR:
000B9C DC95 A7               4      AND A
000B9D DC96 C9              10      RET
                                
       DC97                     _SYS09:     ;文字列出力
000B9E DC97 D5              11      PUSH    DE
       DC98                     _SX09:
000B9F DC98 1A               7      LD  A,(DE)
000BA0 DC99 13               6      INC DE
000BA1 DC9A FE24             7      CP  '$'
000BA3 DC9C 2831            12      JR  Z,SX0E2
000BA5 DC9E CDA8DF          17      CALL    MSG_A
000BA8 DCA1 18F5            12      JR  _SX09
                                
       DCA3                     MSX1:
000BAA DCA3 CDA8DF          17      CALL    MSG_A
       DCA6                     MSX:
000BAD DCA6 7E               7      LD  A,(HL)
000BAE DCA7 23               6      INC HL
000BAF DCA8 B7               4      OR  A
000BB0 DCA9 20F8            12      JR  NZ,MSX1
000BB2 DCAB C9              10      RET
                                
       DCAC                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000BB3 DCAC 212200          10      LD  HL,00022H
000BB6 DCAF 7D               4      LD  A,L
000BB7 DCB0 C9              10      RET
                                
       DCB1                     _SYS0D:     ;(BDOS)ディスクリセット
000BB8 DCB1 CDDFF4          17      CALL    _FFLUSH
000BBB DCB4 E5              11      PUSH    HL
000BBC DCB5 218000          10      LD  HL,00080H
000BBF DCB8 228AF4          16      LD  (_DTA),HL
000BC2 DCBB E1              10      POP HL
000BC3 DCBC D5              11      PUSH    DE
000BC4 DCBD 1E00             7      LD  E,0
000BC6 DCBF 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       DCC0                     _SYS0E:     ;(BDOS)カレントドライブの設定
000BC7 DCC0 D5              11      PUSH    DE
000BC8 DCC1 7B               4      LD  A,E
000BC9 DCC2 DDE5            15      PUSH    IX
000BCB DCC4 CDDCF4          17      CALL    _GETDPB
000BCE DCC7 DDE1            14      POP IX
000BD0 DCC9 3804            12      JR  C,SX0E2
000BD2 DCCB 7B               4      LD  A,E
000BD3 DCCC 320400          13      LD  (_DVSW),A
       DCCF                     SX0E2:
000BD6 DCCF D1              10      POP DE
000BD7 DCD0 C9              10      RET
                                
       DCD1                     _SYS0F:     ;(BDOS)ファイルのオープン
000BD8 DCD1 CD90E5          17      CALL    SETDRV
000BDB DCD4 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000BDE DCD7 C602             7      ADD A,002H      ;Write
000BE0 DCD9 2848            12      JR  Z,FEND0F
000BE2 DCDB CDDEE8          17      CALL    CHKWILDX
                                
000BE5 DCDE D4BAE5          17      CALL    NC,SOPENX
       DCE1                     _S16XX:
000BE8 DCE1 3840            12      JR  C,FEND0F
                                                ;Directory location
000BEA DCE3 3A9FF4          13      LD  A,(_FILEN)
000BED DCE6 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
000BF0 DCE9 3AA0F4          13      LD  A,(_DIRF)
000BF3 DCEC FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000BF6 DCEF FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
000BF9 DCF2 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
000BFC DCF5 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
000C00 DCF9 FDE5            15      PUSH    IY
000C02 DCFB D1              10      POP DE
000C03 DCFC 13               6      INC DE
000C04 DCFD 010B00          10      LD  BC,11
000C07 DD00 EDB0                    LDIR
                                ;               Attribute
000C09 DD02 7E               7      LD  A,(HL)
000C0A DD03 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
000C0D DD06 110B00          10      LD  DE,11       ;Reserved
000C10 DD09 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
000C11 DD0A 11E4F5          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
000C14 DD0D 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DD0F                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000C16 DD0F 1A               7      LD  A,(DE)
000C17 DD10 13               6      INC DE
000C18 DD11 3218DD          13      LD  (S16PAT),A
000C1B DD14 7E               7      LD  A,(HL)
000C1C DD15 23               6      INC HL
000C1D DD16 FD7700          19      LD  (IY+0),A
       DD18                     S16PAT  EQU $-1
000C20 DD19 10F4            13      DJNZ    S16LOOP
                                
000C22 DD1B AF               4      XOR A
000C23 DD1C FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000C26 DD1F FD22C0DD        20      LD  (OFCB_SWC),IY
       DD23                     FEND0F:
000C2A DD23 1845            12      JR  FEND10
                                
       DD25                     _SYS10:     ;(BDOS)ファイルのクローズ
000C2C DD25 CD90E5          17      CALL    SETDRV
000C2F DD28 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000C32 DD2B D6FE             7      SUB 0FEH
000C34 DD2D 37               4      SCF
000C35 DD2E 3F               4      CCF
000C36 DD2F 2039            12      JR  NZ,FEND10
       DD31                     _S10A:              ;Write
000C38 DD31 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000C3B DD34 FD770F          19      LD  (IY+15),A
                                
000C3E DD37 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
000C41 DD3A CDDAE9          17      CALL    SETTMS
                                
000C44 DD3D FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000C47 DD40 32A0F4          13      LD  (_DIRF),A
000C4A DD43 E67F             7      AND 07FH
000C4C DD45 320CEF          13      LD  (_SECPS),A
000C4F DD48 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000C52 DD4B FD561F          19      LD  D,(IY+31)
000C55 DD4E CDEFE6          17      CALL    READ_DIR
000C58 DD51 3817            12      JR  C,FEND10
                                
000C5A DD53 3A1AE6          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000C5D DD56 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000C5E DD57 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000C61 DD5A 6F               4      LD  L,A
000C62 DD5B 2600             7      LD  H,0
000C64 DD5D 29              11      ADD HL,HL       ;*2
000C65 DD5E 29              11      ADD HL,HL       ;*4
000C66 DD5F 29              11      ADD HL,HL       ;*8
000C67 DD60 29              11      ADD HL,HL       ;*16
000C68 DD61 29              11      ADD HL,HL       ;*32
000C69 DD62 ED4B7EF5        20      LD  BC,(_DTBUF)
000C6D DD66 09              11      ADD HL,BC
                                
000C6E DD67 CDEEE8          17      CALL    SDIRENT
       DD6A                     FEND10:
000C71 DD6A 1842            12      JR  FEND
                                
       DD6C                     _SYS11:     ;(BDOS)最初のファイルの検索
000C73 DD6C CD90E5          17      CALL    SETDRV
000C76 DD6F CDE9E5          17      CALL    SOPEN
       DD72                     _S12X1:
000C79 DD72 383A            12      JR  C,FEND
000C7B DD74 CD88E6          17      CALL    SOPENE2
000C7E DD77 ED5B8AF4        20      LD  DE,(_DTA)
000C82 DD7B 3A88F4          13      LD  A,(_DRV)
000C85 DD7E 3C               4      INC A
000C86 DD7F 12               7      LD  (DE),A
000C87 DD80 D5              11      PUSH    DE
000C88 DD81 13               6      INC DE
000C89 DD82 012000          10      LD  BC,32
000C8C DD85 EDB0                    LDIR
000C8E DD87 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000C91 DD8A FD660F          19      LD  H,(IY+15)
000C94 DD8D 22F4F5          16      LD  (SCDIR),HL
000C97 DD90 2A9AF4          16      LD  HL,(_FBPS)
000C9A DD93 22F6F5          16      LD  (SFBPS),HL
000C9D DD96 2A9FF4          16      LD  HL,(_FILEN)
000CA0 DD99 7C               4      LD  A,H
000CA1 DD9A B7               4      OR  A
000CA2 DD9B 2806            12      JR  Z,_S12DIR
000CA4 DD9D 3A0CEF          13      LD  A,(_SECPS)
000CA7 DDA0 F680             7      OR  080H
000CA9 DDA2 67               4      LD  H,A
       DDA3                     _S12DIR:
000CAA DDA3 22F8F5          16      LD  (SFNDF),HL  ;Directory position and Flags
000CAD DDA6 E1              10      POP HL
000CAE DDA7 1139F4          10      LD  DE,SFILE
000CB1 DDAA 0E21             7      LD  C,33
       DDAC                     _S11B:
000CB3 DDAC EDB0                    LDIR
       DDAE                     FEND:
000CB5 DDAE 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       DDAF                     FENDE:
000CB6 DDAF FDE1            14      POP IY
000CB8 DDB1 C1              10      POP BC
000CB9 DDB2 D1              10      POP DE
000CBA DDB3 E1              10      POP HL
000CBB DDB4 C9              10      RET
                                
       DDB5                     _SYS12:     ;(BDOS)次のファイルの検索
000CBC DDB5 E5              11      PUSH    HL
000CBD DDB6 D5              11      PUSH    DE
000CBE DDB7 C5              11      PUSH    BC
000CBF DDB8 FDE5            15      PUSH    IY
000CC1 DDBA CD4DE6          17      CALL    NOPEN
000CC4 DDBD 18B3            12      JR  _S12X1
                                
       DDBF                     _S16K:
000CC6 DDBF 110000          10      LD  DE,0
       DDC0                     OFCB_SWC    EQU $-2
000CC9 DDC2 D5              11      PUSH    DE
000CCA DDC3 061A             7      LD  B,26        ;First cluster
       DDC5                     S16K1:
000CCC DDC5 13               6      INC DE
000CCD DDC6 23               6      INC HL
000CCE DDC7 10FC            13      DJNZ    S16K1
                                
000CD0 DDC9 1A               7      LD  A,(DE)
000CD1 DDCA BE               7      CP  (HL)
000CD2 DDCB 2015            12      JR  NZ,S16K2
000CD4 DDCD 13               6      INC DE
000CD5 DDCE 23               6      INC HL
000CD6 DDCF 1A               7      LD  A,(DE)
000CD7 DDD0 BE               7      CP  (HL)
000CD8 DDD1 200F            12      JR  NZ,S16K2
                                
000CDA DDD3 E1              10      POP HL
000CDB DDD4 FDE5            15      PUSH    IY
000CDD DDD6 D1              10      POP DE
000CDE DDD7 7E               7      LD  A,(HL)
000CDF DDD8 CDA5E5          17      CALL    IS_SAME_DRV_A_DE
000CE2 DDDB 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000CE4 DDDD ED52            15      SBC HL,DE       ;CP HL,DE
000CE6 DDDF 37               4      SCF
000CE7 DDE0 C0              11      RET NZ
000CE8 DDE1 E5              11      PUSH    HL
       DDE2                     S16K2:
000CE9 DDE2 E1              10      POP HL
       DDE3                     S16K3:
000CEA DDE3 FDE5            15      PUSH    IY
000CEC DDE5 D1              10      POP DE
       DDE6                     _SYS13:     ;(BDOS)ファイルの削除
000CED DDE6 CD90E5          17      CALL    SETDRV
000CF0 DDE9 CD14E8          17      CALL    KILL
       DDEC                     FEND13:
000CF3 DDEC 18C0            12      JR  FEND
                                
       DDEE                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000CF5 DDEE CD90E5          17      CALL    SETDRV
000CF8 DDF1 CD3CEA          17      CALL    INIT_SEQ
       DDF4                     SREAD:
000CFB DDF4 CD6AEA          17      CALL    RB_READ
                                
000CFE DDF7 C601             7      ADD A,001H
000D00 DDF9 38B3            12      JR  C,FEND
                                
000D02 DDFB 7D               4      LD  A,L
000D03 DDFC D601             7      SUB 001H
       DDFE                     FENDX:
000D05 DDFE 9F               4      SBC A,A
000D06 DDFF E603             7      AND 3
000D08 DE01 1F               4      RRA
000D09 DE02 18AB            12      JR  FENDE
                                
       DE04                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000D0B DE04 CD90E5          17      CALL    SETDRV
000D0E DE07 CD3CEA          17      CALL    INIT_SEQ
       DE0A                     SWRITE:
000D11 DE0A CD63EA          17      CALL    RB_WRITE
                                
000D14 DE0D C6FF             7      ADD A,0FFH
000D16 DE0F 18ED            12      JR  FENDX
                                
       DE11                     _SYS17:     ;(BDOS)ファイル名の変更
000D18 DE11 CD90E5          17      CALL    SETDRV
000D1B DE14 CD6AE8          17      CALL    NAME
000D1E DE17 18D3            12      JR  FEND13
                                
       DE19                     _SYS16:     ;(BDOS)ファイルの作成
000D20 DE19 CD90E5          17      CALL    SETDRV
                                
000D23 DE1C CDDEE8          17      CALL    CHKWILDX
000D26 DE1F 38CB            12      JR  C,FEND13
000D28 DE21 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000D2B DE24 FE05             7      CP  5
000D2D DE26 2805            12      JR  Z,_S16X2
000D2F DE28 FE21             7      CP  021H
000D31 DE2A DAECDD          10      JP  C,FEND13
       DE2D                     _S16X2:
                                ;               Clear FCB
000D34 DE2D FDE5            15      PUSH    IY
000D36 DE2F E1              10      POP HL
000D37 DE30 011000          10      LD  BC,16
000D3A DE33 09              11      ADD HL,BC
       DE34                     _S16X1:
000D3B DE34 70               7      LD  (HL),B      ;B=0
000D3C DE35 23               6      INC HL
000D3D DE36 0D               4      DEC C
000D3E DE37 20FB            12      JR  NZ,_S16X1
                                
000D40 DE39 CDDFE9          17      CALL    SETTMSX
000D43 DE3C FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000D47 DE40 CDBAE5          17      CALL    SOPENX
000D4A DE43 3F               4      CCF
000D4B DE44 CCBFDD          17      CALL    Z,_S16K
000D4E DE47 D499E6          17      CALL    NC,COPEN
000D51 DE4A D4EEE8          17      CALL    NC,SDIRENT
000D54 DE4D C3E1DC          10      JP  _S16XX
                                
       DE50                     _SYS21:     ;(BDOS)ランダムな読み出し
000D57 DE50 CD90E5          17      CALL    SETDRV
000D5A DE53 CD2AEA          17      CALL    INIT_RND
000D5D DE56 189C            12      JR  SREAD
                                
       DE58                     _SYS22:     ;(BDOS)ランダムな書き込み
       DE58                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000D5F DE58 CD90E5          17      CALL    SETDRV
000D62 DE5B CD2AEA          17      CALL    INIT_RND
000D65 DE5E 18AA            12      JR  SWRITE
                                
       DE60                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000D67 DE60 21FF00          10      LD  HL,000FFH
000D6A DE63 AF               4      XOR A
000D6B DE64 C9              10      RET
                                
       DE65                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000D6C DE65 3A0400          13      LD  A,(_DVSW)
000D6F DE68 A7               4      AND A
000D70 DE69 C9              10      RET
                                
       DE6A                     _SYS1A:     ;(BDOS)DTAの設定
000D71 DE6A ED538AF4        20      LD  (_DTA),DE
000D75 DE6E AF               4      XOR A
000D76 DE6F C9              10      RET
                                
       DE70                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000D77 DE70 7B               4      LD  A,E
000D78 DE71 CD9EE5          17      CALL    GETDRV
000D7B DE74 CDDCF4          17      CALL    _GETDPB
000D7E DE77 D4E2F4          17      CALL    NC,_RDFATX
000D81 DE7A 210000          10      LD  HL,0
000D84 DE7D D4B8E9          17      CALL    NC,DSKF
                                
000D87 DE80 ED5BB9E9        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000D8B DE84 1B               6      DEC DE      ;DE←クラスタの総数
000D8C DE85 FD2A7CF5        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000D90 DE89 9F               4      SBC A,A
000D91 DE8A D8              11      RET C
000D92 DE8B 4F               4      LD  C,A     ;C=0
000D93 DE8C DD7E0F          19      LD  A,(IX+DPB_BPS)
000D96 DE8F E607             7      AND 7
000D98 DE91 47               4      LD  B,A
000D99 DE92 DD7E07          19      LD  A,(IX+DPB_SECPCL)
000D9C DE95 C9              10      RET
                                
       DE96                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000D9D DE96 AF               4      XOR A
000D9E DE97 67               4      LD  H,A
000D9F DE98 6F               4      LD  L,A
000DA0 DE99 C9              10      RET
                                
       DE9A                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000DA1 DE9A 2100F6          10      LD  HL,_DEVICE
000DA4 DE9D 7B               4      LD  A,E
000DA5 DE9E C3DCF4          10      JP  _GETDPB
                                
       DEA1                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000DA8 DEA1 E5              11      PUSH    HL
000DA9 DEA2 2A1EF5          16      LD  HL,(STABLE+2*00FH)  ;ファイルのオープン
000DAC DEA5 CD0F00          17      CALL    JP_HL
000DAF DEA8 381B            12      JR  C,_S23X1
                                
000DB1 DEAA D5              11      PUSH    DE      ;EX DE,IY
000DB2 DEAB FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000DB4 DEAD FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000DB7 DEB0 FD6E11          19      LD  L,(IY+17)   ;
000DBA DEB3 FD6612          19      LD  H,(IY+18)   ;
000DBD DEB6 C5              11      PUSH    BC      ;
000DBE DEB7 FD4613          19      LD  B,(IY+19)   ;
000DC1 DEBA CD1CEA          17      CALL    GET_CPM_R_SIZE
000DC4 DEBD C1              10      POP BC
       DEBE                     _S24X1:
000DC5 DEBE CD54ED          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000DC8 DEC1 FDE3            23      EX  (SP),IY     ;
000DCA DEC3 D1              10      POP DE      ;
                                
000DCB DEC4 AF               4      XOR A
       DEC5                     _S23X1:
000DCC DEC5 E1              10      POP HL
000DCD DEC6 C9              10      RET
                                
       DEC7                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000DCE DEC7 E5              11      PUSH    HL
000DCF DEC8 D5              11      PUSH    DE      ;EX DE,IY
000DD0 DEC9 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000DD2 DECB CD44EA          17      CALL    GETSEQ
000DD5 DECE 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       DED0                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000DD7 DED0 2B               6      DEC HL
       DED1                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000DD8 DED1 C5              11      PUSH    BC
000DD9 DED2 E5              11      PUSH    HL
000DDA DED3 CDA7E4          17      CALL    FILE
000DDD DED6 E1              10      POP HL
000DDE DED7 C1              10      POP BC
       DED8                     S29X1:
000DDF DED8 C5              11      PUSH    BC
000DE0 DED9 D5              11      PUSH    DE
000DE1 DEDA E5              11      PUSH    HL
000DE2 DEDB EB               4      EX  DE,HL
000DE3 DEDC AF               4      XOR A
000DE4 DEDD 3221F4          13      LD  (FDRV+13),A
000DE7 DEE0 2114F4          10      LD  HL,FDRV
000DEA DEE3 011000          10      LD  BC,16
000DED DEE6 EDB0                    LDIR
000DEF DEE8 E1              10      POP HL
000DF0 DEE9 D1              10      POP DE
000DF1 DEEA C1              10      POP BC
000DF2 DEEB C9              10      RET
                                
       DEEC                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000DF3 DEEC C5              11      PUSH    BC
000DF4 DEED 01AFF0          10      LD  BC,DWT24B
000DF7 DEF0 1804            12      JR  S2FX
       DEF2                     _SYS2F:
000DF9 DEF2 C5              11      PUSH    BC
000DFA DEF3 019FF0          10      LD  BC,DRD24B
       DEF6                     S2FX:
000DFD DEF6 ED430CDF        20      LD  (S2F_SWC),BC
000E01 DEFA CDDFF4          17      CALL    _FFLUSH
                                
000E04 DEFD D5              11      PUSH    DE
000E05 DEFE E5              11      PUSH    HL
000E06 DEFF 7D               4      LD  A,L     ;Drive
000E07 DF00 CDD9F4          17      CALL    _CHGDRV
000E0A DF03 3809            12      JR  C,S30X2
000E0C DF05 44               4      LD  B,H     ;Number of clusters
000E0D DF06 2A8AF4          16      LD  HL,(_DTA)
                                
000E10 DF09 0E00             7      LD  C,0
000E12 DF0B CD9FF0          17      CALL    DRD24B
       DF0C                     S2F_SWC EQU $-2
       DF0E                     S30X2:
000E15 DF0E E1              10      POP HL
000E16 DF0F D1              10      POP DE
000E17 DF10 C1              10      POP BC
000E18 DF11 9F               4      SBC A,A
000E19 DF12 C9              10      RET
                                
       DF13                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000E1A DF13 C5              11      PUSH    BC
000E1B DF14 D5              11      PUSH    DE
000E1C DF15 E5              11      PUSH    HL
000E1D DF16 CD9CE4          17      CALL    FILEC
000E20 DF19 210EDF          10      LD  HL,S30X2
000E23 DF1C E5              11      PUSH    HL
000E24 DF1D 3A21F4          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
000E27 DF20 E610             7      AND 010H        ;ディレクトリ
000E29 DF22 C8              11      RET Z
000E2A DF23 1114F4          10      LD  DE,FDRV
000E2D DF26 2A4EF5          16      LD  HL,(STABLE+2*027H)  ;ランダムブロック読み込み
000E30 DF29 E9               4      JP  (HL)
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "X1IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   X1/turbo/Z
                                
       DC95                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       DC95                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       DC95                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       DC95                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       DC95                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       DC95                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       DF2A                     BIOS:
000E31 DF2A E5              11      PUSH    HL
000E32 DF2B 211080          10      LD  HL,08010H
000E35 DF2E 39              11      ADD HL,SP
000E36 DF2F E1              10      POP HL
000E37 DF30 300E            12      JR  NC,BIOS2
       DF32                     BIOS1:
000E39 DF32 CD3ADF          17      CALL    BIOS3
000E3C DF35 061E             7      LD  B,01EH
000E3E DF37 ED79            12      OUT (C),A
000E40 DF39 C9              10      RET
       DF3A                     BIOS3:
000E41 DF3A C5              11      PUSH    BC
000E42 DF3B 061D             7      LD  B,01DH
000E44 DF3D ED79            12      OUT (C),A
000E46 DF3F C9              10      RET
       DF40                     BIOS2:
000E47 DF40 ED734BDF        20      LD  (BIOS_SP),SP    ;スタックがBIOS-ROMと被っている場合
000E4B DF44 31CAFF          10      LD  SP,EXTSP
000E4E DF47 CD32DF          17      CALL    BIOS1
000E51 DF4A 310000          10      LD  SP,0
       DF4B                     BIOS_SP EQU $-2
000E54 DF4D C9              10      RET
                                
       DF4E                     INT:
000E55 DF4E F5              11      PUSH    AF
000E56 DF4F E5              11      PUSH    HL
000E57 DF50 C5              11      PUSH    BC
                                
000E58 DF51 CDDEE2          17      CALL    IN49SB
000E5B DF54 67               4      LD  H,A
000E5C DF55 CDDEE2          17      CALL    IN49SB
000E5F DF58 6F               4      LD  L,A
       DF59                     SCEXE:
000E60 DF59 2292F4          16      LD  (_KEYD),HL
000E63 DF5C CD65DF          17      CALL    KEYSET1
                                
000E66 DF5F C1              10      POP BC
       DF60                     INTPE:
000E67 DF60 E1              10      POP HL
       DF61                     INTPE2:
000E68 DF61 F1              10      POP AF
       DF62                     INTCTCE:
000E69 DF62 FB               4      EI
000E6A DF63 ED4D            15      RETI
                                
       DF65                     KEYSET1:
000E6C DF65 F5              11      PUSH    AF
000E6D DF66 AF               4      XOR A
000E6E DF67 3202E0          13      LD  (FLGET_SWC),A
000E71 DF6A F1              10      POP AF
000E72 DF6B B7               4      OR  A
000E73 DF6C C8              11      RET Z
                                
000E74 DF6D CB6C             8      BIT 5,H
000E76 DF6F 2806            12      JR  Z,KEYSET
000E78 DF71 3A95F4          13      LD  A,(_KEYSP+1)
000E7B DF74 3217E0          13      LD  (KEYREPEAT_SWC),A
       DF77                     KEYSET:
000E7E DF77 7D               4      LD  A,L
000E7F DF78 CB74             8      BIT 6,H
000E81 DF7A C0              11      RET NZ
       DF7B                     KEYBS:
000E82 DF7B B7               4      OR  A
000E83 DF7C C8              11      RET Z
       DF7D                     KEYBS1:
000E84 DF7D CD95DF          17      CALL    KEYBC_IFBREAK
000E87 DF80 E5              11      PUSH    HL
000E88 DF81 F5              11      PUSH    AF
000E89 DF82 2A90F4          16      LD  HL,(_KEYPS)
000E8C DF85 2C               4      INC L
000E8D DF86 CBAD             8      RES 5,L
000E8F DF88 7D               4      LD  A,L
000E90 DF89 BC               4      CP  H
000E91 DF8A 2815            12      JR  Z,POP_AF_HL_SCF_RET
000E93 DF8C 3290F4          13      LD  (_KEYPS),A
000E96 DF8F 26FF             7      LD  H,KEYBF/256
000E98 DF91 F1              10      POP AF
000E99 DF92 77               7      LD  (HL),A
000E9A DF93 E1              10      POP HL
000E9B DF94 C9              10      RET
       DF95                     KEYBC_IFBREAK:
000E9C DF95 FE03             7      CP  3
000E9E DF97 C0              11      RET NZ
       DF98                     KEYBC:
000E9F DF98 E5              11      PUSH    HL
000EA0 DF99 210000          10      LD  HL,0
000EA3 DF9C 2290F4          16      LD  (_KEYPS),HL
000EA6 DF9F E1              10      POP HL
000EA7 DFA0 C9              10      RET
                                
       DFA1                     POP_AF_HL_SCF_RET:
000EA8 DFA1 F1              10      POP AF
000EA9 DFA2 E1              10      POP HL
000EAA DFA3 37               4      SCF
000EAB DFA4 C9              10      RET
                                
       DFA5                     _SYS01:     ;(BDOS)コンソール入力
000EAC DFA5 CD09F4          17      CALL    _SYS07
       DFA8                     MSG_A:
000EAF DFA8 F5              11      PUSH    AF
000EB0 DFA9 D5              11      PUSH    DE
000EB1 DFAA 5F               4      LD  E,A
000EB2 DFAB CDB1DF          17      CALL    _SYS02
000EB5 DFAE D1              10      POP DE
000EB6 DFAF F1              10      POP AF
000EB7 DFB0 C9              10      RET
                                
       DFB1                     _SYS02:     ;(BDOS)コンソール出力
000EB8 DFB1 CDC3DF          17      CALL    BREAK
000EBB DFB4 1805            12      JR  PRINTX
                                
       DFB6                     _SYS06:     ;(BDOS)コンソール直接入出力
000EBD DFB6 7B               4      LD  A,E
000EBE DFB7 3C               4      INC A
000EBF DFB8 CACAF4          10      JP  Z,_INKEY
       DFBB                     PRINTX:
000EC2 DFBB C3CDF4          10      JP  _PRINT
                                
       DFBE                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000EC5 DFBE CD09F4          17      CALL    _SYS07
000EC8 DFC1 1804            12      JR  BREAK1
       DFC3                     BREAK:
000ECA DFC3 FB               4      EI
000ECB DFC4 3A92F4          13      LD  A,(_KEYD)
       DFC7                     BREAK1:
000ECE DFC7 FE03             7      CP  3       ;CTRL+C
000ED0 DFC9 CCF4F4          17      CALL    Z,_BREAK
000ED3 DFCC FE13             7      CP  013H        ;CTRL+S
000ED5 DFCE C0              11      RET NZ
                                
       DFCF                     PAUSE:
000ED6 DFCF CD98DF          17      CALL    KEYBC
                                
       DFD2                     FLGET:
000ED9 DFD2 CDDFF4          17      CALL    _FFLUSH
000EDC DFD5 C5              11      PUSH    BC
000EDD DFD6 E5              11      PUSH    HL
000EDE DFD7 ED4B8EF4        20      LD  BC,(_TXADR)
000EE2 DFDB CBE8             8      SET 5,B
000EE4 DFDD ED60            12      IN  H,(C)
       DFDF                     FLGET1:
000EE6 DFDF 3A93F4          13      LD  A,(_KEYD+1)
000EE9 DFE2 0F               4      RRCA
000EEA DFE3 0F               4      RRCA
000EEB DFE4 E610             7      AND 010H
000EED DFE6 F608             7      OR  8
000EEF DFE8 ED68            12      IN  L,(C)
000EF1 DFEA B5               4      OR  L
000EF2 DFEB ED79            12      OUT (C),A
       DFED                     FLGETR:
000EF4 DFED CDCAF4          17      CALL    _INKEY
000EF7 DFF0 2032            12      JR  NZ,FLGETE
000EF9 DFF2 CB5D             8      BIT 3,L
000EFB DFF4 28E9            12      JR  Z,FLGET1
000EFD DFF6 3A92F4          13      LD  A,(_KEYD)
000F00 DFF9 B7               4      OR  A
000F01 DFFA 28E3            12      JR  Z,FLGET1
                                
000F03 DFFC 3E1A             7      LD  A,01AH
000F05 DFFE 3202E0          13      LD  (FLGET_SWC),A
       E001                     FLGET2:
000F08 E001 3E1A             7      LD  A,1AH
       E002                     FLGET_SWC   EQU $-1
000F0A E003 B7               4      OR  A
000F0B E004 28E7            12      JR  Z,FLGETR
000F0D E006 DB01            11      IN  A,(01H)
000F0F E008 87               4      ADD A,A
000F10 E009 30F6            12      JR  NC,FLGET2
       E00B                     FLGET3:
000F12 E00B 3A02E0          13      LD  A,(FLGET_SWC)
000F15 E00E B7               4      OR  A
000F16 E00F 28DC            12      JR  Z,FLGETR
000F18 E011 DB01            11      IN  A,(01H)
000F1A E013 87               4      ADD A,A
000F1B E014 38F5            12      JR  C,FLGET3
                                
000F1D E016 3E00             7      LD  A,0
       E017                     KEYREPEAT_SWC   EQU $-1
000F1F E018 B7               4      OR  A
000F20 E019 2806            12      JR  Z,FLGET4
000F22 E01B 3D               4      DEC A
000F23 E01C 3217E0          13      LD  (KEYREPEAT_SWC),A
000F26 E01F 18E0            12      JR  FLGET2
       E021                     FLGET4:
000F28 E021 3A92F4          13      LD  A,(_KEYD)
       E024                     FLGETE:
000F2B E024 ED61            12      OUT (C),H
000F2D E026 E1              10      POP HL
000F2E E027 C1              10      POP BC
000F2F E028 C9              10      RET
                                
       E029                     _SYS0A:     ;(BDOS)文字列入力
000F30 E029 C5              11      PUSH    BC
000F31 E02A E5              11      PUSH    HL
000F32 E02B D5              11      PUSH    DE
000F33 E02C CD2BE4          17      CALL    GETL
000F36 E02F 1120FF          10      LD  DE,KBUF
000F39 E032 E1              10      POP HL
000F3A E033 E5              11      PUSH    HL
000F3B E034 0E00             7      LD  C,0
000F3D E036 3004            12      JR  NC,SAX0
000F3F E038 23               6      INC HL
000F40 E039 23               6      INC HL
000F41 E03A 1808            12      JR  SAX4
       E03C                     SAX0:
000F43 E03C 46               7      LD  B,(HL)
000F44 E03D 23               6      INC HL
       E03E                     SAX1:
000F45 E03E 23               6      INC HL
000F46 E03F 1A               7      LD  A,(DE)
000F47 E040 13               6      INC DE
000F48 E041 B7               4      OR  A
000F49 E042 2004            12      JR  NZ,SAX2
       E044                     SAX4:
000F4B E044 360D            10      LD  (HL),00DH
000F4D E046 1804            12      JR  SAX3
       E048                     SAX2:
000F4F E048 77               7      LD  (HL),A
000F50 E049 0C               4      INC C
000F51 E04A 10F2            13      DJNZ    SAX1
       E04C                     SAX3:
000F53 E04C D1              10      POP DE
000F54 E04D 79               4      LD  A,C
000F55 E04E 13               6      INC DE
000F56 E04F 12               7      LD  (DE),A
000F57 E050 1B               6      DEC DE
000F58 E051 E1              10      POP HL
000F59 E052 C1              10      POP BC
000F5A E053 A7               4      AND A
000F5B E054 C9              10      RET
                                
       E055                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000F5C E055 CDC3DF          17      CALL    BREAK
000F5F E058 3A92F4          13      LD  A,(_KEYD)
000F62 E05B B7               4      OR  A
000F63 E05C C8              11      RET Z
       E05D                     CONSTX:
000F64 E05D CDDFF4          17      CALL    _FFLUSH
000F67 E060 E5              11      PUSH    HL
000F68 E061 2A90F4          16      LD  HL,(_KEYPS)
000F6B E064 7C               4      LD  A,H
000F6C E065 AD               4      XOR L
000F6D E066 E1              10      POP HL
000F6E E067 C6FF             7      ADD A,0FFH
000F70 E069 9F               4      SBC A,A
000F71 E06A C9              10      RET
                                
       E06B                     _SYS2A:     ;(BDOS)日付の獲得
000F72 E06B C5              11      PUSH    BC
000F73 E06C 3EED             7      LD  A,0EDH      ;Read calendar
000F75 E06E CDF9E2          17      CALL    COMOUT
000F78 E071 CDA3E0          17      CALL    IN49SB_BCD  ;YY
000F7B E074 6F               4      LD  L,A
000F7C E075 2600             7      LD  H,0
                                ;   LD  DE,1900     ;0076CH
                                ;   CP  90      ;90以上は1900年代 1990-1999
                                ;   JR  NC,RDDATE1  ;90未満は2000年代 2000-2089
                                ;   LD  E,0D0H      ;2000 & 0FFH D=007H
000F7E E077 11D007          10      LD  DE,2000     ;すべて2000年代で処理 2000-2099
       E07A                     RDDATE1:
000F81 E07A 19              11      ADD HL,DE
000F82 E07B CDDEE2          17      CALL    IN49SB      ;MW
000F85 E07E 57               4      LD  D,A
000F86 E07F CDA3E0          17      CALL    IN49SB_BCD  ;DD
000F89 E082 5F               4      LD  E,A
000F8A E083 7A               4      LD  A,D
000F8B E084 0604             7      LD  B,4
       E086                     RDDATE2:
000F8D E086 CB3A             8      SRL D
000F8F E088 10FC            13      DJNZ    RDDATE2
000F91 E08A C1              10      POP BC
000F92 E08B E607             7      AND 7
000F94 E08D C9              10      RET
                                
       E08E                     _SYS2C:     ;(BDOS)時刻の獲得
000F95 E08E C5              11      PUSH    BC
000F96 E08F 3EEF             7      LD  A,0EFH      ;Read time
000F98 E091 CDF9E2          17      CALL    COMOUT
000F9B E094 CDA3E0          17      CALL    IN49SB_BCD  ;TT
000F9E E097 67               4      LD  H,A
000F9F E098 CDA3E0          17      CALL    IN49SB_BCD  ;MM
000FA2 E09B 6F               4      LD  L,A
000FA3 E09C CDA3E0          17      CALL    IN49SB_BCD  ;SS
000FA6 E09F 57               4      LD  D,A
000FA7 E0A0 C1              10      POP BC
000FA8 E0A1 AF               4      XOR A
000FA9 E0A2 C9              10      RET
                                
       E0A3                     IN49SB_BCD:
000FAA E0A3 CDDEE2          17      CALL    IN49SB
                                ;------------------------
                                ;BCDの10進数化
                                ;in
                                ;   A  : BCD
                                ;out
                                ;   A  : 10進数
                                ;------------------------
000FAD E0A6 4F               4      LD  C,A
000FAE E0A7 E6F0             7      AND 0F0H    ;10の位
000FB0 E0A9 0F               4      RRCA
000FB1 E0AA 47               4      LD  B,A
000FB2 E0AB 0F               4      RRCA
000FB3 E0AC 0F               4      RRCA
000FB4 E0AD 80               4      ADD A,B
000FB5 E0AE 47               4      LD  B,A
000FB6 E0AF 79               4      LD  A,C
000FB7 E0B0 E60F             7      AND 00FH    ;1の位
000FB9 E0B2 80               4      ADD A,B
000FBA E0B3 C9              10      RET
                                
       E0B4                     ESC1:
000FBB E0B4 7B               4      LD  A,E
000FBC E0B5 FE41             7      CP  'A'
000FBE E0B7 CAFCE1          10      JP  Z,CTRL1E
000FC1 E0BA FE42             7      CP  'B'
000FC3 E0BC CA64E3          10      JP  Z,CTRL1F
000FC6 E0BF FE43             7      CP  'C'
000FC8 E0C1 CA07E2          10      JP  Z,CTRL1C
000FCB E0C4 FE44             7      CP  'D'
000FCD E0C6 CAF3E1          10      JP  Z,CTRL1D
000FD0 E0C9 FE45             7      CP  'E'
000FD2 E0CB 2802            12      JR  Z,CT0CX
000FD4 E0CD FE6A             7      CP  'j'
       E0CF                     CT0CX:
000FD6 E0CF CA37E3          10      JP  Z,CTRL0C
000FD9 E0D2 FE48             7      CP  'H'
000FDB E0D4 CA81E2          10      JP  Z,CTRL0B
000FDE E0D7 FE4A             7      CP  'J'
000FE0 E0D9 CA3AE3          10      JP  Z,CTRL06
000FE3 E0DC FE4B             7      CP  'K'
000FE5 E0DE 2807            12      JR  Z,CT05X
000FE7 E0E0 FE4C             7      CP  'L'
000FE9 E0E2 CA79E3          10      JP  Z,CTRL0E
000FEC E0E5 FE54             7      CP  'T'
       E0E7                     CT05X:
000FEE E0E7 CA40E2          10      JP  Z,CTRL05
000FF1 E0EA FE78             7      CP  'x'
000FF3 E0EC 2804            12      JR  Z,ESC1X
000FF5 E0EE FE79             7      CP  'y'
000FF7 E0F0 2002            12      JR  NZ,ESC1Y
       E0F2                     ESC1X:
000FF9 E0F2 3601            10      LD  (HL),1
       E0F4                     ESC1Y:
000FFB E0F4 FE3D             7      CP  '='
000FFD E0F6 2804            12      JR  Z,ESC1W
000FFF E0F8 FE59             7      CP  'Y'
001001 E0FA 2002            12      JR  NZ,ESC1Z
       E0FC                     ESC1W:
001003 E0FC 3602            10      LD  (HL),2
       E0FE                     ESC1Z:
001005 E0FE FE20             7      CP  020H
001007 E100 3802            12      JR  C,ESC1C
001009 E102 87               4      ADD A,A
00100A E103 D0              11      RET NC
       E104                     ESC1C:
00100B E104 E1              10      POP HL
       E105                     ANK:
00100C E105 ED4B8EF4        20      LD  BC,(_TXADR)
001010 E109 78               4      LD  A,B
001011 E10A F638             7      OR  038H
001013 E10C 47               4      LD  B,A
001014 E10D ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令   kanji
001016 E10F CB98             8      RES 3,B
001018 E111 ED59            12      OUT (C),E       ;Text
       E113                     KANJIE:
00101A E113 CDC8E1          17      CALL    PRINTE7
       E116                     PRINTE5:
00101D E116 E1              10      POP HL
00101E E117 C1              10      POP BC
00101F E118 AF               4      XOR A
001020 E119 C9              10      RET
                                
       E11A                     ESC:
001021 E11A 2116E1          10      LD  HL,PRINTE5
001024 E11D E5              11      PUSH    HL
001025 E11E 2140E1          10      LD  HL,ESCFLG+1
001028 E121 3600            10      LD  (HL),0
00102A E123 3D               4      DEC A
00102B E124 288E            12      JR  Z,ESC1
00102D E126 3D               4      DEC A
00102E E127 2009            12      JR  NZ,ESC2
001030 E129 3603            10      LD  (HL),3
001032 E12B 7B               4      LD  A,E
001033 E12C D620             7      SUB 020H
001035 E12E 3235E1          13      LD  (ESCYP+1),A
001038 E131 C9              10      RET
       E132                     ESC2:
001039 E132 3D               4      DEC A
00103A E133 C0              11      RET NZ
00103B E134 2600             7  ESCYP:  LD  H,0
00103D E136 7B               4      LD  A,E
00103E E137 D620             7      SUB 020H
001040 E139 6F               4      LD  L,A
001041 E13A C3D6F4          10      JP  _LOC
                                
       E13D                     PRINT:
001044 E13D C5              11      PUSH    BC
001045 E13E E5              11      PUSH    HL
001046 E13F 3E00             7  ESCFLG: LD  A,000H
001048 E141 B7               4      OR  A
001049 E142 20D6            12      JR  NZ,ESC
                                
00104B E144 3E1F             7      LD  A,01FH
00104D E146 BB               4      CP  E
00104E E147 3020            12      JR  NC,CTRL
001050 E149 0102E3          10  INSFLG: LD  BC,INSERT
                                
001053 E14C 3A1800          13      LD  A,(00018H)
001056 E14F 3C               4      INC A
001057 E150 28B3            12      JR  Z,ANK
001059 E152 3E00             7  KANFLG: LD  A,000H
00105B E154 B7               4      OR  A
00105C E155 2025            12      JR  NZ,KANJI2
00105E E157 7B               4      LD  A,E
00105F E158 FE80             7      CP  080H
001061 E15A 38A9            12      JR  C,ANK
001063 E15C FEA0             7      CP  0A0H
001065 E15E 3804            12      JR  C,KANJI1
001067 E160 FEE0             7      CP  0E0H
001069 E162 38A1            12      JR  C,ANK
       E164                     KANJI1:
00106B E164 3253E1          13      LD  (KANFLG+1),A
00106E E167 18AD            12      JR  PRINTE5
                                
       E169                     CTRL:
001070 E169 CDAFE1          17      CALL    KANCLR
001073 E16C 7B               4      LD  A,E
001074 E16D 87               4      ADD A,A
001075 E16E F680             7      OR  080H
001077 E170 6F               4      LD  L,A
001078 E171 26F5             7      LD  H,CTRLTB/256
00107A E173 7E               7      LD  A,(HL)
00107B E174 2C               4      INC L
00107C E175 66               7      LD  H,(HL)
00107D E176 6F               4      LD  L,A
00107E E177 CD0F00          17      CALL    JP_HL
001081 E17A 189A            12      JR  PRINTE5
                                
       E17C                     KANJI2:
001083 E17C D5              11      PUSH    DE
001084 E17D 57               4      LD  D,A
001085 E17E 01812F          10      LD  BC,02F81H   ;SFTJIS
001088 E181 DF              12      RST 018H
001089 E182 01C32F          10      LD  BC,02FC3H   ;Instead or JISVRM
00108C E185 DF              12      RST 018H
                                
00108D E186 ED4B8EF4        20      LD  BC,(_TXADR)
001091 E18A 78               4      LD  A,B
001092 E18B F638             7      OR  038H
001094 E18D 47               4      LD  B,A
001095 E18E ED51            12      OUT (C),D       ;kanji
001097 E190 CB98             8      RES 3,B
001099 E192 ED59            12      OUT (C),E       ;Text
00109B E194 CDC8E1          17      CALL    PRINTE7
00109E E197 ED4B8EF4        20      LD  BC,(_TXADR)
0010A2 E19B 78               4      LD  A,B
0010A3 E19C F638             7      OR  038H
0010A5 E19E 47               4      LD  B,A
0010A6 E19F CBF2             8      SET 6,D
0010A8 E1A1 ED51            12      OUT (C),D       ;Kanji
0010AA E1A3 CB98             8      RES 3,B
0010AC E1A5 ED59            12      OUT (C),E       ;Text
0010AE E1A7 D1              10      POP DE
0010AF E1A8 AF               4      XOR A
0010B0 E1A9 3253E1          13      LD  (KANFLG+1),A
0010B3 E1AC C313E1          10      JP  KANJIE
                                
       E1AF                     KANCLR:
0010B6 E1AF 3A53E1          13      LD  A,(KANFLG+1)
0010B9 E1B2 B7               4      OR  A
0010BA E1B3 C8              11      RET Z
0010BB E1B4 ED4B8EF4        20      LD  BC,(_TXADR)
0010BF E1B8 78               4      LD  A,B
0010C0 E1B9 F638             7      OR  038H
0010C2 E1BB 47               4      LD  B,A
0010C3 E1BC AF               4      XOR A
0010C4 E1BD 3253E1          13      LD  (KANFLG+1),A
0010C7 E1C0 ED79            12      OUT (C),A       ;Kanji
0010C9 E1C2 CB98             8      RES 3,B
0010CB E1C4 3E20             7      LD  A,020H
0010CD E1C6 ED79            12      OUT (C),A       ;Text
       E1C8                     PRINTE7:
0010CF E1C8 CBA0             8      RES 4,B
       E1CA                     PRINTE6:
0010D1 E1CA 3A96F4          13      LD  A,(_COLORF)
       E1CD                     PRINTE4:
0010D4 E1CD ED79            12      OUT (C),A       ;Color
0010D6 E1CF 78               4      LD  A,B
0010D7 E1D0 E607             7      AND 7
0010D9 E1D2 47               4      LD  B,A
       E1D3                     PRINTE2:
0010DA E1D3 03               6      INC BC
       E1D4                     PRINTE3:
0010DB E1D4 2ABAF4          16      LD  HL,(_PAGE_MINUS)
0010DE E1D7 A7               4      AND A
0010DF E1D8 ED4A            15      ADC HL,BC
       E1DA                     PRINTE8:
0010E1 E1DA 2805            12      JR  Z,PRINT2
0010E3 E1DC ED438EF4        20      LD  (_TXADR),BC
       E1E0                     CTRL00:
0010E7 E1E0 C9              10      RET
                                
       E1E1                     PRINT2:
0010E8 E1E1 CD7FE3          17      CALL    SCR
0010EB E1E4 2ABCF4          16      LD  HL,(_WIDTH_MINUS)
0010EE E1E7 09              11      ADD HL,BC
       E1E8                     SET_TXADR_HL:
0010EF E1E8 228EF4          16      LD  (_TXADR),HL
0010F2 E1EB C9              10      RET
                                
       E1EC                     CTRL08:
0010F3 E1EC 3A49E1          13      LD  A,(INSFLG)
0010F6 E1EF FECD             7      CP  0CDH        ;CALL ????
0010F8 E1F1 2829            12      JR  Z,CTRL02
       E1F3                     CTRL1D:
0010FA E1F3 2A8EF4          16      LD  HL,(_TXADR)
0010FD E1F6 7C               4      LD  A,H
0010FE E1F7 B5               4      OR  L
0010FF E1F8 C8              11      RET Z
001100 E1F9 2B               6      DEC HL
001101 E1FA 18EC            12      JR  SET_TXADR_HL
                                
       E1FC                     CTRL1E:
001103 E1FC ED4B8EF4        20      LD  BC,(_TXADR)
001107 E200 2ABCF4          16      LD  HL,(_WIDTH_MINUS)
00110A E203 09              11      ADD HL,BC
00110B E204 D0              11      RET NC
00110C E205 18E1            12      JR  SET_TXADR_HL
                                
       E207                     CTRL1C:
00110E E207 ED4B8EF4        20      LD  BC,(_TXADR)
001112 E20B 18C6            12      JR  PRINTE2
                                
       E20D                     CTRL09:
001114 E20D ED4B8EF4        20      LD  BC,(_TXADR)
001118 E211 79               4      LD  A,C
001119 E212 E6F8             7      AND 0F8H
00111B E214 C608             7      ADD A,8
00111D E216 4F               4      LD  C,A
00111E E217 88               4      ADC A,B
00111F E218 91               4      SUB C
001120 E219 47               4      LD  B,A
001121 E21A 18B8            12      JR  PRINTE3
                                
       E21C                     CTRL02:
001123 E21C CDF3E1          17      CALL    CTRL1D
001126 E21F C8              11      RET Z
001127 E220 D5              11      PUSH    DE
001128 E221 CDD3F4          17      CALL    _POS
00112B E224 3AB1F4          13      LD  A,(_WIDTH)
00112E E227 95               4      SUB L
00112F E228 4F               4      LD  C,A
001130 E229 0D               4      DEC C
001131 E22A 0638             7      LD  B,038H
001133 E22C 2A8EF4          16      LD  HL,(_TXADR)
001136 E22F 09              11      ADD HL,BC
001137 E230 44               4      LD  B,H
001138 E231 4D               4      LD  C,L
001139 E232 110020          10      LD  DE,02000H   ;D:Text E:kanji
00113C E235 2A96F4          16      LD  HL,(_COLORF)    ;L:Color
       E238                     C8X1:
00113F E238 CD1EE3          17      CALL    C12S
001142 E23B 0B               6      DEC BC
001143 E23C 20FA            12      JR  NZ,C8X1
001145 E23E D1              10      POP DE
001146 E23F C9              10      RET
                                
       E240                     CTRL05:
001147 E240 CDD3F4          17      CALL    _POS
00114A E243 3AB1F4          13      LD  A,(_WIDTH)
00114D E246 95               4      SUB L
00114E E247 6F               4      LD  L,A
       E248                     C08X1:
00114F E248 ED4B8EF4        20      LD  BC,(_TXADR)
       E24C                     LINECL:
001153 E24C 2620             7      LD  H,020H
001155 E24E 3A96F4          13      LD  A,(_COLORF)
001158 E251 CBE8             8      SET 5,B
       E253                     LINECL1:
00115A E253 CBD8             8      SET 3,B
00115C E255 CBE0             8      SET 4,B
00115E E257 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令   kanji
001160 E259 CB98             8      RES 3,B
001162 E25B ED61            12      OUT (C),H       ;Text
001164 E25D CBA0             8      RES 4,B
001166 E25F ED79            12      OUT (C),A       ;Color
001168 E261 03               6      INC BC
001169 E262 2D               4      DEC L
00116A E263 20EE            12      JR  NZ,LINECL1
00116C E265 C9              10      RET
                                
       E266                     CTRL0D:
00116D E266 CDD3F4          17      CALL    _POS
001170 E269 2E00             7      LD  L,0
       E26B                     LOC:
001172 E26B C5              11      PUSH    BC
001173 E26C E5              11      PUSH    HL
001174 E26D CDAFE1          17      CALL    KANCLR
001177 E270 CD8EE2          17      CALL    LOC1
00117A E273 228EF4          16      LD  (_TXADR),HL
00117D E276 E1              10      POP HL
00117E E277 C1              10      POP BC
00117F E278 C9              10      RET
                                
       E279                     CTRL12:
001180 E279 2149E1          10      LD  HL,INSFLG
001183 E27C 7E               7      LD  A,(HL)
001184 E27D EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
001186 E27F 77               7      LD  (HL),A
001187 E280 C9              10      RET
                                
       E281                     CTRL0B:
001188 E281 210000          10      LD  HL,0
00118B E284 228EF4          16      LD  (_TXADR),HL
00118E E287 C9              10      RET
                                
       E288                     CTRL1B:
00118F E288 3E01             7      LD  A,1
001191 E28A 3240E1          13      LD  (ESCFLG+1),A
001194 E28D C9              10      RET
                                
       E28E                     LOC1:
001195 E28E D5              11      PUSH    DE
001196 E28F 4D               4      LD  C,L
001197 E290 0608             7      LD  B,8
001199 E292 5C               4      LD  E,H
00119A E293 1600             7      LD  D,0
00119C E295 2AB0F4          16      LD  HL,(CRTCD)
00119F E298 6A               4      LD  L,D
       E299                     LOC2:
0011A0 E299 29              11      ADD HL,HL
0011A1 E29A 3001            12      JR  NC,LOC3
0011A3 E29C 19              11      ADD HL,DE
       E29D                     LOC3:
0011A4 E29D 10FA            13      DJNZ    LOC2
0011A6 E29F 09              11      ADD HL,BC
0011A7 E2A0 D1              10      POP DE
0011A8 E2A1 C9              10      RET
                                
       E2A2                     CONOUT1:
0011A9 E2A2 CDB4E2          17      CALL    CURSOR
0011AC E2A5 59               4      LD  E,C
0011AD E2A6 CDCDF4          17      CALL    _PRINT
0011B0 E2A9 7B               4      LD  A,E
0011B1 E2AA FE0A             7      CP  00AH
0011B3 E2AC 2006            12      JR  NZ,CURSOR
0011B5 E2AE CD66E2          17      CALL    CTRL0D
0011B8 E2B1 CD40E2          17      CALL    CTRL05
       E2B4                     CURSOR:
0011BB E2B4 C5              11      PUSH    BC
0011BC E2B5 ED4B8EF4        20      LD  BC,(_TXADR)
0011C0 E2B9 CBE8             8      SET 5,B
0011C2 E2BB ED78            12      IN  A,(C)
0011C4 E2BD EE18             7      XOR 018H
0011C6 E2BF ED79            12      OUT (C),A
0011C8 E2C1 C1              10      POP BC
0011C9 E2C2 C9              10      RET
                                
       E2C3                     CTRL07:
0011CA E2C3 2161F4          10      LD  HL,BEEPD
       E2C6                     BEEP1:
0011CD E2C6 7E               7      LD  A,(HL)
0011CE E2C7 23               6      INC HL
0011CF E2C8 FEFF             7      CP  0FFH
0011D1 E2CA C8              11      RET Z
0011D2 E2CB 061C             7      LD  B,01CH
0011D4 E2CD ED79            12      OUT (C),A
0011D6 E2CF EDA3            16      OUTI
0011D8 E2D1 18F3            12      JR  BEEP1
                                
       E2D3                     OT49SB:
0011DA E2D3 C5              11      PUSH    BC
0011DB E2D4 CDEFE2          17      CALL    CANW
0011DE E2D7 010019          10      LD  BC,01900H
0011E1 E2DA ED79            12      OUT (C),A
0011E3 E2DC C1              10      POP BC
0011E4 E2DD C9              10      RET
                                
       E2DE                     IN49SB:
0011E5 E2DE C5              11      PUSH    BC
0011E6 E2DF 01011A          10      LD  BC,01A01H
       E2E2                     CANR:
0011E9 E2E2 ED78            12      IN  A,(C)
0011EB E2E4 E620             7      AND 020H
0011ED E2E6 20FA            12      JR  NZ,CANR
0011EF E2E8 010019          10      LD  BC,01900H
0011F2 E2EB ED78            12      IN  A,(C)
0011F4 E2ED C1              10      POP BC
0011F5 E2EE C9              10      RET
                                
       E2EF                     CANW:
0011F6 E2EF 01011A          10      LD  BC,01A01H
0011F9 E2F2 ED48            12      IN  C,(C)
0011FB E2F4 CB71             8      BIT 6,C
0011FD E2F6 20F7            12      JR  NZ,CANW
0011FF E2F8 C9              10      RET
                                
       E2F9                     COMOUT:
001200 E2F9 FB               4      EI
001201 E2FA CDD3E2          17      CALL    OT49SB
001204 E2FD CDEFE2          17      CALL    CANW
001207 E300 F3               4      DI
001208 E301 C9              10      RET
                                
       E302                     INSERT:
001209 E302 D5              11      PUSH    DE
00120A E303 CDD3F4          17      CALL    _POS
00120D E306 3AB1F4          13      LD  A,(_WIDTH)
001210 E309 95               4      SUB L
001211 E30A ED4B8EF4        20      LD  BC,(_TXADR)
001215 E30E 110020          10      LD  DE,02000H   ;D:Text E:Kanji
001218 E311 2A96F4          16      LD  HL,(_COLORF)    ;L:Color
00121B E314 CBE8             8      SET 5,B
       E316                     C12X1:
00121D E316 CD1EE3          17      CALL    C12S
001220 E319 03               6      INC BC
001221 E31A 20FA            12      JR  NZ,C12X1
001223 E31C D1              10      POP DE
001224 E31D C9              10      RET
                                
       E31E                     C12S:
001225 E31E CBE0             8      SET 4,B
001227 E320 CBD8             8      SET 3,B
001229 E322 ED60            12      IN  H,(C)
00122B E324 ED59            12  X1PAT:  OUT (C),E
00122D E326 5C               4      LD  E,H
00122E E327 CB98             8      RES 3,B
001230 E329 ED60            12      IN  H,(C)
001232 E32B ED51            12      OUT (C),D
001234 E32D 54               4      LD  D,H
001235 E32E CBA0             8      RES 4,B
001237 E330 ED60            12      IN  H,(C)
001239 E332 ED69            12      OUT (C),L
00123B E334 6C               4      LD  L,H
00123C E335 3D               4      DEC A
00123D E336 C9              10      RET
                                
       E337                     CTRL0C:
00123E E337 CD81E2          17      CALL    CTRL0B
       E33A                     CTRL06:
001241 E33A ED4B8EF4        20      LD  BC,(_TXADR)
       E33E                     C1AX1:
001245 E33E 78               4      LD  A,B
001246 E33F F638             7      OR  038H
001248 E341 47               4      LD  B,A
001249 E342 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令   kanji
00124B E344 CB98             8      RES 3,B
00124D E346 3E20             7      LD  A,020H
00124F E348 ED79            12      OUT (C),A       ;Text
001251 E34A CBA0             8      RES 4,B
001253 E34C 3A96F4          13      LD  A,(_COLORF)
001256 E34F ED79            12      OUT (C),A       ;Color
001258 E351 03               6      INC BC
001259 E352 CBA8             8      RES 5,B
00125B E354 2ABAF4          16      LD  HL,(_PAGE_MINUS)
00125E E357 09              11      ADD HL,BC
00125F E358 30E4            12      JR  NC,C1AX1
001261 E35A C9              10      RET
                                
       E35B                     CTRL04:
001262 E35B CDD3F4          17      CALL    _POS
001265 E35E 7D               4      LD  A,L
001266 E35F B7               4      OR  A
001267 E360 C8              11      RET Z
       E361                     CTRL03:
001268 E361 CD66E2          17      CALL    CTRL0D
       E364                     CTRL0A:
       E364                     CTRL1F:
00126B E364 ED4B8EF4        20      LD  BC,(_TXADR)
00126F E368 2AB1F4          16      LD  HL,(_WIDTH)
001272 E36B 2600             7      LD  H,0
001274 E36D 09              11      ADD HL,BC
001275 E36E 44               4      LD  B,H
001276 E36F 4D               4      LD  C,L
001277 E370 2ABAF4          16      LD  HL,(_PAGE_MINUS)
00127A E373 09              11      ADD HL,BC
00127B E374 3F               4      CCF
00127C E375 9F               4      SBC A,A
00127D E376 C3DAE1          10      JP  PRINTE8
                                
       E379                     CTRL0E:
001280 E379 CDD3F4          17      CALL    _POS
001283 E37C 7C               4      LD  A,H
001284 E37D 1804            12      JR  SCR1
       E37F                     SCR:
001286 E37F 3A97F4          13      LD  A,(_LINE)
001289 E382 3D               4      DEC A
       E383                     SCR1:
00128A E383 C5              11      PUSH    BC
00128B E384 D5              11      PUSH    DE
00128C E385 F5              11      PUSH    AF
00128D E386 3E07             7      LD  A,7
00128F E388 21B9E3          10      LD  HL,SCRDMAD
001292 E38B CDAFE3          17      CALL    SETDMA
001295 E38E F1              10      POP AF
001296 E38F 210038          10      LD  HL,03800H
                                
       E392                     SCRUP1:
001299 E392 B7               4      OR  A
00129A E393 284D            12      JR  Z,SCRCL
00129C E395 F5              11      PUSH    AF
00129D E396 CDC0E3          17      CALL    UPSUB       ;kanji
0012A0 E399 3ABCF4          13      LD  A,(_WIDTH_MINUS)
0012A3 E39C 5F               4      LD  E,A
0012A4 E39D 16F7             7      LD  D,0F7H
0012A6 E39F 19              11      ADD HL,DE
0012A7 E3A0 D5              11      PUSH    DE
0012A8 E3A1 CDC0E3          17      CALL    UPSUB       ;Text
0012AB E3A4 D1              10      POP DE
0012AC E3A5 19              11      ADD HL,DE
0012AD E3A6 CDC0E3          17      CALL    UPSUB       ;Color
0012B0 E3A9 CBE4             8      SET 4,H
0012B2 E3AB F1              10      POP AF
0012B3 E3AC 3D               4      DEC A
0012B4 E3AD 18E3            12      JR  SCRUP1
                                
       E3AF                     SETDMA:
0012B6 E3AF 01871F          10      LD  BC,01F87H
       E3B2                     SDMA:
0012B9 E3B2 04               4      INC B
0012BA E3B3 EDA3            16      OUTI
0012BC E3B5 3D               4      DEC A
0012BD E3B6 20FA            12      JR  NZ,SDMA
0012BF E3B8 C9              10      RET
                                
       E3B9                     SCRDMAD:
0012C0 E3B9 C3                      DB  0C3H        ;WR6 リセット
0012C1 E3BA 9A                      DB  09AH        ;WR5 ストップ WAIT READY:HIGH
0012C2 E3BB 65                      DB  065H        ;WR0 ブロック長(LH)
0012C3 E3BC 4F00                    DW  79
0012C5 E3BE 1C                      DB  01CH        ;WR1 ポートAインクリメント I/O
0012C6 E3BF 18                      DB  018H        ;WR0 ポートAアドレス(LH)
                                
       E3C0                     UPSUB:
0012C7 E3C0 3AB1F4          13      LD  A,(_WIDTH)
0012CA E3C3 5F               4      LD  E,A
0012CB E3C4 1600             7      LD  D,0
0012CD E3C6 3EAD             7      LD  A,0ADH      ;WR4 連続 ポートB開始アドレス(LH)
0012CF E3C8 ED79            12      OUT (C),A
0012D1 E3CA ED69            12      OUT (C),L       ;SOURCE
0012D3 E3CC ED61            12      OUT (C),H
0012D5 E3CE 19              11      ADD HL,DE
0012D6 E3CF 3E1D             7      LD  A,01DH      ;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
0012D8 E3D1 ED79            12      OUT (C),A
0012DA E3D3 ED69            12      OUT (C),L       ;DEST
0012DC E3D5 ED61            12      OUT (C),H
       E3D7                     GO_DMA:
0012DE E3D7 3ECF             7      LD  A,0CFH
0012E0 E3D9 ED79            12      OUT (C),A       ;WR6 ロード
0012E2 E3DB 3EB3             7      LD  A,0B3H
0012E4 E3DD ED79            12      OUT (C),A       ;WR6 強制RDY
0012E6 E3DF ED49            12      OUT (C),C       ;WR6 イネーブル
0012E8 E3E1 C9              10      RET
                                
       E3E2                     SCRCL:
0012E9 E3E2 44               4      LD  B,H
0012EA E3E3 4D               4      LD  C,L
0012EB E3E4 2AB1F4          16      LD  HL,(_WIDTH)
0012EE E3E7 CD4CE2          17      CALL    LINECL
0012F1 E3EA D1              10      POP DE
0012F2 E3EB C1              10      POP BC
0012F3 E3EC C9              10      RET
                                
       E3ED                     SCRN:
0012F4 E3ED D5              11      PUSH    DE
0012F5 E3EE ED58            12      IN  E,(C)       ;Text
0012F7 E3F0 3A1800          13      LD  A,(00018H)
0012FA E3F3 3C               4      INC A
0012FB E3F4 281E            12      JR  Z,SCRN2
0012FD E3F6 CBD8             8      SET 3,B
0012FF E3F8 ED50            12      IN  D,(C)       ;Kanji
001301 E3FA 2816            12      JR  Z,SCRN1
001303 E3FC AF               4      XOR A
001304 E3FD C5              11      PUSH    BC
001305 E3FE 013730          10      LD  BC,03037H   ;VRMJIS
001308 E401 DF              12      RST 018H
001309 E402 01522F          10      LD  BC,02F52H   ;JISSFT
00130C E405 DF              12      RST 018H
00130D E406 C1              10      POP BC
00130E E407 ED78            12      IN  A,(C)
001310 E409 CB98             8      RES 3,B
001312 E40B E640             7      AND 040H
001314 E40D 2005            12      JR  NZ,SCRN2
001316 E40F 7A               4      LD  A,D
001317 E410 D1              10      POP DE
001318 E411 C9              10      RET
       E412                     SCRN1:
001319 E412 CB98             8      RES 3,B
       E414                     SCRN2:
00131B E414 7B               4      LD  A,E
00131C E415 D1              10      POP DE
00131D E416 C9              10      RET
       E417                     SCRNE:
       E417                     POS:
00131E E417 2A8EF4          16      LD  HL,(_TXADR)
001321 E41A C5              11      PUSH    BC
001322 E41B ED4BBCF4        20      LD  BC,(_WIDTH_MINUS)
001326 E41F AF               4      XOR A
       E420                     POS1:
001327 E420 09              11      ADD HL,BC
001328 E421 3C               4      INC A
001329 E422 38FC            12      JR  C,POS1
00132B E424 ED42            15      SBC HL,BC
00132D E426 3D               4      DEC A
00132E E427 67               4      LD  H,A
00132F E428 C1              10      POP BC
001330 E429 A7               4      AND A
001331 E42A C9              10      RET
                                
       E42B                     GETL:
001332 E42B CDD3F4          17      CALL    _POS
001335 E42E E5              11      PUSH    HL
001336 E42F 3ECD             7      LD  A,0CDH      ;CALL ????
001338 E431 3249E1          13      LD  (INSFLG),A
       E434                     GETL1:
00133B E434 CDBEDF          17      CALL    _SYS08
00133E E437 FE09             7      CP  9
001340 E439 2008            12      JR  NZ,GETL1V
001342 E43B 2120FF          10      LD  HL,KBUF
001345 E43E CDA6DC          17      CALL    MSX
001348 E441 18F1            12      JR  GETL1
       E443                     GETL1V:
00134A E443 5F               4      LD  E,A
00134B E444 CDCDF4          17      CALL    _PRINT
                                
00134E E447 7B               4      LD  A,E
00134F E448 FE0D             7      CP  00DH
001351 E44A 20E8            12      JR  NZ,GETL1
001353 E44C 3E01             7      LD  A,1     ;LD BC,????
001355 E44E 3249E1          13      LD  (INSFLG),A
001358 E451 1120FF          10      LD  DE,KBUF
00135B E454 3AB1F4          13      LD  A,(_WIDTH)
00135E E457 47               4      LD  B,A
00135F E458 CD59DA          17      CALL    ZERO_MEMORY_DE
                                
001362 E45B D1              10      POP DE
001363 E45C CDD3F4          17      CALL    _POS
001366 E45F 6B               4      LD  L,E
001367 E460 3AB1F4          13      LD  A,(_WIDTH)
00136A E463 95               4      SUB L
00136B E464 57               4      LD  D,A
00136C E465 CD8EE2          17      CALL    LOC1
00136F E468 4D               4      LD  C,L
001370 E469 7C               4      LD  A,H
001371 E46A F630             7      OR  030H
001373 E46C 47               4      LD  B,A
001374 E46D 5A               4      LD  E,D
001375 E46E 2120FF          10      LD  HL,KBUF
       E471                     GETL2:
001378 E471 CDD0F4          17      CALL    _SCRN
00137B E474 03               6      INC BC
00137C E475 77               7      LD  (HL),A
00137D E476 23               6      INC HL
00137E E477 1D               4      DEC E
00137F E478 20F7            12      JR  NZ,GETL2
       E47A                     GETL3:
001381 E47A 2B               6      DEC HL
001382 E47B 7E               7      LD  A,(HL)
001383 E47C FE21             7      CP  021H
001385 E47E D0              11      RET NC
001386 E47F 3600            10      LD  (HL),0
001388 E481 15               4      DEC D
001389 E482 20F6            12      JR  NZ,GETL3
00138B E484 C9              10      RET
                                
       E485                     INKEY:
00138C E485 FB               4      EI
00138D E486 E5              11      PUSH    HL
00138E E487 2A90F4          16      LD  HL,(_KEYPS)
001391 E48A 7C               4      LD  A,H
001392 E48B AD               4      XOR L
001393 E48C 280B            12      JR  Z,INKEY1
001395 E48E 7C               4      LD  A,H
001396 E48F 3C               4      INC A
001397 E490 E61F             7      AND 01FH
001399 E492 3291F4          13      LD  (_KEYPS+1),A
00139C E495 6F               4      LD  L,A
00139D E496 26FF             7      LD  H,KEYBF/256
00139F E498 7E               7      LD  A,(HL)
       E499                     INKEY1:
0013A0 E499 E1              10      POP HL
0013A1 E49A B7               4      OR  A
0013A2 E49B C9              10      RET
                                
       0E64                     AT_RS   EQU SCR1-AT_SCR1
[EOF:X1IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり
                                
       E49C                     FILEC:
0013A3 E49C CDA7E4          17      CALL    FILE
       E49F                     FILEC2:
0013A6 E49F 3A15F4          13      LD  A,(FDRV+1)
0013A9 E4A2 FE20             7      CP  020H
0013AB E4A4 C8              11      RET Z
0013AC E4A5 1839            12      JR  SETDIR1
                                
       E4A7                     FILE:
0013AE E4A7 AF               4      XOR A
0013AF E4A8 3214F4          13      LD  (FDRV),A
0013B2 E4AB 67               4      LD  H,A
0013B3 E4AC 6F               4      LD  L,A
0013B4 E4AD 2222F4          16      LD  (FDRV+14),HL
0013B7 E4B0 CD7EE5          17      CALL    SPCUT
0013BA E4B3 CD63E5          17      CALL    CCHK3
0013BD E4B6 2812            12      JR  Z,DEVI1
0013BF E4B8 13               6      INC DE
0013C0 E4B9 1A               7      LD  A,(DE)
0013C1 E4BA 1B               6      DEC DE
0013C2 E4BB FE3A             7      CP  ':'
0013C4 E4BD 200B            12      JR  NZ,DEVI1
0013C6 E4BF 1A               7      LD  A,(DE)      ;DRIVE
0013C7 E4C0 CDBEE7          17      CALL    CAP
0013CA E4C3 D640             7      SUB '@'
0013CC E4C5 13               6      INC DE
0013CD E4C6 13               6      INC DE
0013CE E4C7 3214F4          13      LD  (FDRV),A
       E4CA                     DEVI1:
0013D1 E4CA 1A               7      LD  A,(DE)
0013D2 E4CB D65C             7      SUB 05CH        ;\
0013D4 E4CD 2009            12      JR  NZ,NOROOT
0013D6 E4CF 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
0013D7 E4D0 222EF4          16      LD  (FDRV+26),HL
0013DA E4D3 2C               4      INC L
0013DB E4D4 2222F4          16      LD  (FDRV+14),HL
0013DE E4D7 13               6      INC DE
       E4D8                     NOROOT:
                                
       E4D8                     SETDIR:
0013DF E4D8 CD04E5          17      CALL    FILED
0013E2 E4DB 1A               7      LD  A,(DE)
0013E3 E4DC FE5C             7      CP  05CH        ;\
0013E5 E4DE C0              11      RET NZ
0013E6 E4DF 13               6      INC DE
       E4E0                     SETDIR1:
0013E7 E4E0 3E10             7      LD  A,010H      ;Directory
0013E9 E4E2 3221F4          13      LD  (FDRV+13),A
0013EC E4E5 D5              11      PUSH    DE
0013ED E4E6 1114F4          10      LD  DE,FDRV
0013F0 E4E9 2A1EF5          16      LD  HL,(STABLE+2*00FH)
0013F3 E4EC CD0F00          17      CALL    JP_HL
0013F6 E4EF D1              10      POP DE
0013F7 E4F0 B7               4      OR  A
0013F8 E4F1 C0              11      RET NZ
                                
0013F9 E4F2 3A21F4          13      LD  A,(FDRV+13)
0013FC E4F5 CB67             8      BIT 4,A
0013FE E4F7 C8              11      RET Z
                                
0013FF E4F8 CD4BE5          17      CALL    FILEI
001402 E4FB 2A2EF4          16      LD  HL,(FDRV+26)
001405 E4FE 23               6      INC HL
001406 E4FF 2222F4          16      LD  (FDRV+14),HL
001409 E502 18D4            12      JR  SETDIR
                                
       E504                     FILED:
00140B E504 CD4BE5          17      CALL    FILEI
00140E E507 2115F4          10      LD  HL,FNAME
                                
001411 E50A 0608             7      LD  B,8
       E50C                     FILE2:
001413 E50C CD58E5          17      CALL    CCHKF
001416 E50F C8              11      RET Z
001417 E510 FE2A             7      CP  '*'
001419 E512 282E            12      JR  Z,FILE9
00141B E514 FE2E             7      CP  '.'
00141D E516 280C            12      JR  Z,FILE4
00141F E518 77               7      LD  (HL),A
001420 E519 23               6      INC HL
001421 E51A 10F0            13      DJNZ    FILE2
                                
       E51C                     FILE3:
001423 E51C CD58E5          17      CALL    CCHKF
001426 E51F C8              11      RET Z
001427 E520 FE2E             7      CP  '.'
001429 E522 20F8            12      JR  NZ,FILE3
                                
       E524                     FILE4:
00142B E524 211DF4          10      LD  HL,FNAME+8
00142E E527 0603             7      LD  B,3
                                
       E529                     FILE4L:
001430 E529 CD58E5          17      CALL    CCHKF
001433 E52C C8              11      RET Z
001434 E52D FE2E             7      CP  '.'
001436 E52F 2008            12      JR  NZ,FILE12
001438 E531 3215F4          13      LD  (FNAME),A   ;Parent directory(..)
00143B E534 3216F4          13      LD  (FNAME+1),A
00143E E537 3E20             7      LD  A,020H
       E539                     FILE12:
001440 E539 FE2A             7      CP  '*'
001442 E53B 280A            12      JR  Z,FILE10
001444 E53D 77               7      LD  (HL),A
001445 E53E 23               6      INC HL
001446 E53F 10E8            13      DJNZ    FILE4L
001448 E541 C9              10      RET
                                
       E542                     FILE9:              ;名前の*処理、名前の残りを?で埋める
001449 E542 CD47E5          17      CALL    FILE10
00144C E545 18D5            12      JR  FILE3
                                
       E547                     FILE10:
00144E E547 3E3F             7      LD  A,'?'
001450 E549 1808            12      JR  FILL_MEMORY
       E54B                     FILEI:              ;名前＋拡張子をスペースで初期化
001452 E54B 3E20             7      LD  A,020H
001454 E54D 01000B          10      LD  BC,11*256   ;C=0にしておく
001457 E550 2115F4          10      LD  HL,FNAME
       E553                     FILL_MEMORY:            ;HLからBバイトAで埋める
00145A E553 77               7      LD  (HL),A
00145B E554 23               6      INC HL
00145C E555 10FC            13      DJNZ    FILL_MEMORY
00145E E557 C9              10      RET
                                
       E558                     CCHKF:
00145F E558 1A               7      LD  A,(DE)
001460 E559 CD60E5          17      CALL    CCHK2
001463 E55C C8              11      RET Z
001464 E55D C3CBE8          10      JP  FKAN
                                
       E560                     CCHK2:
001467 E560 0C               4      INC C
001468 E561 0D               4      DEC C
001469 E562 C0              11      RET NZ
       E563                     CCHK3:              ;ZF=1 で使えない文字
00146A E563 FE2B             7      CP  '+'
00146C E565 C8              11      RET Z
00146D E566 FE2C             7      CP  ','
00146F E568 C8              11      RET Z
001470 E569 FE2F             7      CP  '/'
001472 E56B C8              11      RET Z
001473 E56C FE3A             7      CP  ':'
001475 E56E C8              11      RET Z
001476 E56F FE3B             7      CP  ';'
001478 E571 C8              11      RET Z
001479 E572 FE3D             7      CP  '='
00147B E574 C8              11      RET Z
00147C E575 FE5C             7      CP  05CH    ;\
00147E E577 C8              11      RET Z
00147F E578 FE20             7      CP  020H
001481 E57A D0              11      RET NC
001482 E57B BF               4      CP  A       ;Z=1
001483 E57C C9              10      RET
                                
       E57D                     SS1:
001484 E57D 13               6      INC DE
       E57E                     SPCUT:              ;スペースをカット
001485 E57E 1A               7      LD  A,(DE)
001486 E57F FE20             7      CP  020H
001488 E581 28FA            12      JR  Z,SS1
00148A E583 C9              10      RET
                                
       E584                     SETDRVF:
00148B E584 1114F4          10      LD  DE,FDRV
       E587                     SETDRV0:
00148E E587 CD90E5          17      CALL    SETDRV
001491 E58A FDE1            14      POP IY
001493 E58C C1              10      POP BC
001494 E58D D1              10      POP DE
001495 E58E E1              10      POP HL
001496 E58F C9              10      RET
                                
       E590                     SETDRV:
001497 E590 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
001498 E591 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
001499 E592 C5              11      PUSH    BC
00149A E593 1A               7      LD  A,(DE)
00149B E594 D5              11      PUSH    DE
00149C E595 FDE3            23      EX  (SP),IY
                                
00149E E597 CD9EE5          17      CALL    GETDRV
0014A1 E59A CDD9F4          17      CALL    _CHGDRV
                                
0014A4 E59D E9               4      JP  (HL)
                                
       E59E                     GETDRV:
0014A5 E59E CDB1E5          17      CALL    GETDRV1
0014A8 E5A1 3288F4          13      LD  (_DRV),A
0014AB E5A4 C9              10      RET
                                
       E5A5                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
0014AC E5A5 CDB1E5          17      CALL    GETDRV1
0014AF E5A8 C5              11      PUSH    BC
0014B0 E5A9 4F               4      LD  C,A
0014B1 E5AA 1A               7      LD  A,(DE)
0014B2 E5AB CDB1E5          17      CALL    GETDRV1
0014B5 E5AE A9               4      XOR C
0014B6 E5AF C1              10      POP BC
0014B7 E5B0 C9              10      RET
       E5B1                     GETDRV1:
0014B8 E5B1 E67F             7      AND 07FH
0014BA E5B3 D601             7      SUB 001H
0014BC E5B5 D0              11      RET NC
0014BD E5B6 3A0400          13      LD  A,(_DVSW)   ;Current Drive
0014C0 E5B9 C9              10      RET
                                
       E5BA                     SOPENX:
0014C1 E5BA 1139F4          10      LD  DE,SFILE
0014C4 E5BD FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
0014C7 E5C0 CDA5E5          17      CALL    IS_SAME_DRV_A_DE
0014CA E5C3 2024            12      JR  NZ,SOPEN
0014CC E5C5 13               6      INC DE
0014CD E5C6 FDE5            15      PUSH    IY
0014CF E5C8 E1              10      POP HL
0014D0 E5C9 23               6      INC HL
0014D1 E5CA CD56E7          17      CALL    CPFILE
0014D4 E5CD 201A            12      JR  NZ,SOPEN
                                
0014D6 E5CF 2AF4F5          16      LD  HL,(SCDIR)
0014D9 E5D2 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0014DC E5D5 FD740F          19      LD  (IY+15),H
                                
0014DF E5D8 2AF8F5          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
0014E2 E5DB 229FF4          16      LD  (_FILEN),HL
                                
0014E5 E5DE ED5BF6F5        20      LD  DE,(SFBPS)
0014E9 E5E2 2139F4          10      LD  HL,SFILE
0014EC E5E5 36FF            10      LD  (HL),0FFH
0014EE E5E7 23               6      INC HL
0014EF E5E8 C9              10      RET
       E5E9                     SOPEN:
0014F0 E5E9 21FEE6          10      LD  HL,FILESE
       E5EC                     SOPENC:
0014F3 E5EC 2225E6          16      LD  (OPENPAT),HL
                                
0014F6 E5EF CDE2F4          17      CALL    _RDFATX     ;Detect Media
0014F9 E5F2 3856            12      JR  C,RDDERR
                                
0014FB E5F4 AF               4      XOR A
0014FC E5F5 329FF4          13      LD  (_FILEN),A
0014FF E5F8 CDFEE7          17      CALL    LDDIRX1     ;A=0で呼び出す
001502 E5FB 2818            12      JR  Z,SDIRX1
                                
001504 E5FD CDEFE6          17      CALL    READ_DIR    ;Sub Directory
001507 E600 3808            12      JR  C,SDIRX0
001509 E602 2A7EF5          16      LD  HL,(_DTBUF)
00150C E605 7E               7      LD  A,(HL)
00150D E606 FE2E             7      CP  '.'
00150F E608 280F            12      JR  Z,SOPEN1
       E60A                     SDIRX0:
001511 E60A AF               4      XOR A
001512 E60B 32A0F4          13      LD  (_DIRF),A
001515 E60E FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
001519 E612 FD770F          19      LD  (IY+15),A
       E615                     SDIRX1:
00151C E615 ED5BFCF5        20      LD  DE,(_DIRPS) ;Root Directory
       E619                     SOPEN1:
001520 E619 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       E61A                     SDECPAT EQU $-1
       E61B                     SOPEN1X:
001522 E61B CDEFE6          17      CALL    READ_DIR    ;FILE SEARCH
001525 E61E 382A            12      JR  C,RDDERR
001527 E620 2A7EF5          16      LD  HL,(_DTBUF)
       E623                     SOPEN2:
00152A E623 D5              11      PUSH    DE
00152B E624 CDFEE6          17      CALL    FILESE      ;(self-modifying code)
       E625                     OPENPAT EQU $-2
00152E E627 D1              10      POP DE
00152F E628 386D            12      JR  C,SOPENE
001531 E62A 281B            12      JR  Z,SCF_FF_RET
       E62C                     SOPEN3:
001533 E62C 3AA0F4          13      LD  A,(_DIRF)   ;ディレクトリか判別
001536 E62F B7               4      OR  A
001537 E630 200C            12      JR  NZ,SOPEN5
001539 E632 13               6      INC DE      ;ルートディレクトリ
00153A E633 E5              11      PUSH    HL
00153B E634 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       E635                     MD_PAT  EQU $-2
00153E E637 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
001540 E639 E1              10      POP HL
001541 E63A 20DD            12      JR  NZ,SOPEN1
001543 E63C 1807            12      JR  SOPEN6
       E63E                     SOPEN5:
001545 E63E CD14EF          17      CALL    GNCLX       ;END DIR
001548 E641 D8              11      RET C
001549 E642 CDB6E7          17      CALL    ENDCL
       E645                     SOPEN6:
00154C E645 38D2            12      JR  C,SOPEN1
       E647                     SCF_FF_RET:
00154E E647 37               4      SCF         ;CF=1
00154F E648 9F               4      SBC A,A     ;A=0FFH
001550 E649 C9              10      RET
                                
       E64A                     RDDERR:
001551 E64A BF               4      CP  A       ;READ ERR CF=1 ZF=1
001552 E64B 37               4      SCF
001553 E64C C9              10      RET
                                
       E64D                     NOPEN:
001554 E64D 21FEE6          10      LD  HL,FILESE
001557 E650 2225E6          16      LD  (OPENPAT),HL
00155A E653 FD2A98F4        20      LD  IY,(_FCB)
00155E E657 CDDEE8          17      CALL    CHKWILDX
001561 E65A 30EB            12      JR  NC,SCF_FF_RET
001563 E65C FD7E00          19      LD  A,(IY+0)
001566 E65F CD9EE5          17      CALL    GETDRV
001569 E662 CDD9F4          17      CALL    _CHGDRV
00156C E665 D8              11      RET C
00156D E666 2AF8F5          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
001570 E669 229FF4          16      LD  (_FILEN),HL
                                
001573 E66C CDF9E7          17      CALL    LDDIRX
001576 E66F ED5B9AF4        20      LD  DE,(_FBPS)
00157A E673 CDEFE6          17      CALL    READ_DIR
00157D E676 38D2            12      JR  C,RDDERR
00157F E678 3A9EF4          13      LD  A,(_FBCNT)
001582 E67B 3D               4      DEC A
001583 E67C 28AE            12      JR  Z,SOPEN3
       E67E                     NOPEN2:
001585 E67E 2A9CF4          16      LD  HL,(_FBAD)
001588 E681 012000          10      LD  BC,020H
00158B E684 09              11      ADD HL,BC
00158C E685 4F               4      LD  C,A
00158D E686 189B            12      JR  SOPEN2
                                
       E688                     SOPENE2:
00158F E688 229CF4          16      LD  (_FBAD),HL
001592 E68B 79               4      LD  A,C
001593 E68C 329EF4          13      LD  (_FBCNT),A
001596 E68F ED539AF4        20      LD  (_FBPS),DE
00159A E693 FD2298F4        20      LD  (_FCB),IY
       E697                     SOPENE:
00159E E697 AF               4      XOR A
00159F E698 C9              10      RET
                                
       E699                     COPEN:
0015A0 E699 FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
0015A4 E69D 211BE7          10      LD  HL,NEXTSE
0015A7 E6A0 CDECE5          17      CALL    SOPENC
0015AA E6A3 D0              11      RET NC
0015AB E6A4 C8              11      RET Z
0015AC E6A5 3AA0F4          13      LD  A,(_DIRF)   ;ディレクトリか判別
0015AF E6A8 B7               4      OR  A
0015B0 E6A9 37               4      SCF
0015B1 E6AA C8              11      RET Z       ;ルートディレクトリ
0015B2 E6AB 0601             7      LD  B,1
0015B4 E6AD CD3DE9          17      CALL    WRDF
0015B7 E6B0 D8              11      RET C
0015B8 E6B1 ED5BFEF5        20      LD  DE,(_CLPS)
0015BC E6B5 D5              11      PUSH    DE
0015BD E6B6 CD7FE7          17      CALL    DCPAT
0015C0 E6B9 CD98ED          17      CALL    DRDNX
0015C3 E6BC 2A7EF5          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
0015C6 E6BF 3A7EEC          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
0015C9 E6C2 47               4      LD  B,A
0015CA E6C3 AF               4      XOR A
0015CB E6C4 4F               4      LD  C,A
       E6C5                     COPENCL:
0015CC E6C5 77               7      LD  (HL),A
0015CD E6C6 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
0015CF E6C8 EAC5E6          10      JP  PE,COPENCL
                                
0015D2 E6CB 3A9DE7          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
0015D5 E6CE 3D               4      DEC A
0015D6 E6CF 2819            12      JR  Z,COPENE
0015D8 E6D1 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
0015DA E6D3 320CEF          13      LD  (_SECPS),A
0015DD E6D6 D1              10      POP DE      ;DE=(_CLPS)
0015DE E6D7 D5              11      PUSH    DE
       E6D8                     COPEN1:
0015DF E6D8 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
0015E0 E6D9 C5              11      PUSH    BC
0015E1 E6DA 2A7EF5          16      LD  HL,(_DTBUF)
0015E4 E6DD CD99E7          17      CALL    CLUSTX
0015E7 E6E0 CDADF0          17      CALL    DWT24
0015EA E6E3 C1              10      POP BC
0015EB E6E4 D1              10      POP DE
0015EC E6E5 CD0BEF          17      CALL    NEXTX
0015EF E6E8 20EE            12      JR  NZ,COPEN1
       E6EA                     COPENE:
0015F1 E6EA 2A7EF5          16      LD  HL,(_DTBUF)
0015F4 E6ED D1              10      POP DE
0015F5 E6EE C9              10      RET
                                
       E6EF                     READ_DIR:
0015F6 E6EF ED53FEF5        20      LD  (_CLPS),DE
0015FA E6F3 C5              11      PUSH    BC
0015FB E6F4 D5              11      PUSH    DE
0015FC E6F5 CD7FE7          17      CALL    DCPAT
0015FF E6F8 CD78ED          17      CALL    DRDX
001602 E6FB D1              10      POP DE
001603 E6FC C1              10      POP BC
001604 E6FD C9              10      RET
                                
       E6FE                     FILESE:
001605 E6FE 7E               7      LD  A,(HL)
001606 E6FF B7               4      OR  A
001607 E700 C8              11      RET Z       ;END:ZF=1 CF=0
001608 E701 FEE5             7      CP  0E5H
00160A E703 280E            12      JR  Z,FILESE1
00160C E705 FDE5            15      PUSH    IY
00160E E707 D1              10      POP DE
00160F E708 13               6      INC DE
001610 E709 E5              11      PUSH    HL
001611 E70A CD56E7          17      CALL    CPFILE
001614 E70D CC77E7          17      CALL    Z,CPFILE2
001617 E710 E1              10      POP HL
001618 E711 37               4      SCF
001619 E712 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       E713                     FILESE1:
00161A E713 CD2AE7          17      CALL    FNEXT
00161D E716 20E6            12      JR  NZ,FILESE
       E718                     ZF0_CF0_AFF_RET:
00161F E718 F6FF             7      OR  0FFH        ;ZF=0 CF=0
001621 E71A C9              10      RET
                                
       E71B                     NEXTSE:
001622 E71B 7E               7      LD  A,(HL)
001623 E71C B7               4      OR  A
001624 E71D 37               4      SCF
001625 E71E C8              11      RET Z       ;!!!:ZF=1 CF=1
001626 E71F FEE5             7      CP  0E5H
001628 E721 37               4      SCF
001629 E722 C8              11      RET Z       ;!!!:(ZF=1) CF=1
00162A E723 CD2AE7          17      CALL    FNEXT
00162D E726 20F3            12      JR  NZ,NEXTSE
00162F E728 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       E72A                     FNEXT:
001631 E72A E5              11      PUSH    HL
001632 E72B 219FF4          10      LD  HL,_FILEN
001635 E72E 34              11      INC (HL)
001636 E72F E1              10      POP HL
001637 E730 112000          10      LD  DE,020H
00163A E733 19              11      ADD HL,DE
00163B E734 0D               4      DEC C
00163C E735 C9              10      RET
                                
       E736                     CPNAME:
00163D E736 C5              11      PUSH    BC
00163E E737 D5              11      PUSH    DE
00163F E738 E5              11      PUSH    HL
001640 E739 CD50E7          17      CALL    CPFILE4
001643 E73C E1              10      POP HL
001644 E73D 23               6      INC HL
001645 E73E 23               6      INC HL
001646 E73F 23               6      INC HL
001647 E740 23               6      INC HL
001648 E741 D1              10      POP DE
001649 E742 C1              10      POP BC
00164A E743 2005            12      JR  NZ,CPNAME1
00164C E745 7E               7      LD  A,(HL)
00164D E746 23               6      INC HL
00164E E747 66               7      LD  H,(HL)
00164F E748 6F               4      LD  L,A
001650 E749 C9              10      RET
       E74A                     CPNAME1:
001651 E74A 23               6      INC HL
001652 E74B 23               6      INC HL
001653 E74C 10E8            13      DJNZ    CPNAME
001655 E74E 37               4      SCF
001656 E74F C9              10      RET
                                
       E750                     CPFILE4:
001657 E750 C5              11      PUSH    BC
001658 E751 010004          10      LD  BC,00400H
00165B E754 1804            12      JR  CPSTR1
       E756                     CPFILE:
00165D E756 C5              11      PUSH    BC
00165E E757 01000B          10      LD  BC,00B00H
       E75A                     CPSTR1:
001661 E75A 1A               7      LD  A,(DE)
001662 E75B FE3F             7      CP  '?'     ;Wild card
001664 E75D 2812            12      JR  Z,CPSTR2
001666 E75F 7E               7      LD  A,(HL)
001667 E760 CDC4E8          17      CALL    FKANC
00166A E763 E5              11      PUSH    HL
00166B E764 67               4      LD  H,A
00166C E765 1A               7      LD  A,(DE)
00166D E766 CB01             4      RLC C
00166F E768 CDC4E8          17      CALL    FKANC
001672 E76B CB09             4      RRC C
001674 E76D BC               4      CP  H       ;CP (HL),(DE)
001675 E76E E1              10      POP HL
001676 E76F 2004            12      JR  NZ,CPSTR3
       E771                     CPSTR2:
001678 E771 13               6      INC DE
001679 E772 23               6      INC HL
00167A E773 10E5            13      DJNZ    CPSTR1
       E775                     CPSTR3:
00167C E775 C1              10      POP BC
00167D E776 C9              10      RET
                                
       E777                     CPFILE2:
00167E E777 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001681 E77A F6E1             7      OR  0E1H
001683 E77C 2F               4      CPL
001684 E77D A6               7      AND (HL)
001685 E77E C9              10      RET
                                
       E77F                     DCPAT:
001686 E77F 0E00             7      LD  C,0
001688 E781 2A7EF5          16      LD  HL,(_DTBUF)
00168B E784 3AA0F4          13      LD  A,(_DIRF)   ;ディレクトリか判別
00168E E787 B7               4      OR  A
00168F E788 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
001690 E789 3A9DE7          13      LD  A,(SPCPAT)
001693 E78C 4F               4      LD  C,A
001694 E78D 3A0CEF          13      LD  A,(_SECPS)
001697 E790 B9               4      CP  C
001698 E791 3801            12      JR  C,DC1
00169A E793 AF               4      XOR A
       E794                     DC1:
00169B E794 F680             7      OR  080H
00169D E796 32A0F4          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       E799                     CLUSTX:
0016A0 E799 E5              11      PUSH    HL
0016A1 E79A EB               4      EX  DE,HL
0016A2 E79B AF               4      XOR A
0016A3 E79C 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       E79D                     SPCPAT  EQU $-1
       E79E                     L_CLDBL:
0016A5 E79E CB19             8      RR  C       ;->CF
0016A7 E7A0 3804            12      JR  C,E_CLDBL
0016A9 E7A2 29              11      ADD HL,HL       ;*2
0016AA E7A3 8F               4      ADC A,A
0016AB E7A4 18F8            12      JR  L_CLDBL
       E7A6                     E_CLDBL:
0016AD E7A6 4F               4      LD  C,A
0016AE E7A7 3A0CEF          13      LD  A,(_SECPS)
0016B1 E7AA B5               4      OR  L
0016B2 E7AB 6F               4      LD  L,A
0016B3 E7AC 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       E7AD                     CLSPAT  EQU $-2
0016B6 E7AF AF               4      XOR A
0016B7 E7B0 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
0016B8 E7B1 89               4      ADC A,C
0016B9 E7B2 4F               4      LD  C,A
0016BA E7B3 EB               4      EX  DE,HL
0016BB E7B4 E1              10      POP HL
0016BC E7B5 C9              10      RET
                                
       E7B6                     ENDCL:
0016BD E7B6 7A               4      LD  A,D ;END CLUSTER
0016BE E7B7 FE01             7      CP  1   ;164=356    (self-modifying code)
       E7B8                     CLPAT1  EQU $-1
0016C0 E7B9 C0              11      RET NZ
0016C1 E7BA 7B               4      LD  A,E
0016C2 E7BB FE64             7      CP  064H    ;       (self-modifying code)
       E7BC                     CLPAT2  EQU $-1
0016C4 E7BD C9              10      RET
                                
       E7BE                     CAP:
0016C5 E7BE FE61             7      CP  'a'
0016C7 E7C0 D8              11      RET C
0016C8 E7C1 FE7B             7      CP  'z'+1
0016CA E7C3 D0              11      RET NC
0016CB E7C4 D620             7      SUB 020H
0016CD E7C6 C9              10      RET
       E7C7                     CAP2:
0016CE E7C7 CDBEE7          17      CALL    CAP
       E7CA                     CAP3:               ;
0016D1 E7CA FE05             7      CP  5
0016D3 E7CC 2803            12      JR  Z,CAP4
0016D5 E7CE FE21             7      CP  021H
0016D7 E7D0 C9              10      RET
       E7D1                     CAP4:
0016D8 E7D1 3EE5             7      LD  A,0E5H
0016DA E7D3 C9              10      RET
                                
       E7D4                     CHDIR:
0016DB E7D4 CDC0F1          17      CALL    GETDPBD
0016DE E7D7 381D            12      JR  C,CHDIR2
0016E0 E7D9 DD751A          19      LD  (IX+DPB_SDIR),L
0016E3 E7DC DD741B          19      LD  (IX+DPB_SDIR+1),H
0016E6 E7DF 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       E7E1                     LDDIR:
0016E8 E7E1 CDC0F1          17      CALL    GETDPBD
0016EB E7E4 DD5E1A          19      LD  E,(IX+DPB_SDIR)
0016EE E7E7 DD561B          19      LD  D,(IX+DPB_SDIR+1)
0016F1 E7EA 13               6      INC DE
0016F2 E7EB FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0016F5 E7EE FD720F          19      LD  (IY+15),D
0016F8 E7F1 1B               6      DEC DE
0016F9 E7F2 AF               4      XOR A
0016FA E7F3 32A0F4          13      LD  (_DIRF),A
       E7F6                     CHDIR2:
0016FD E7F6 DDE1            14      POP IX
0016FF E7F8 C9              10      RET
                                
       E7F9                     LDDIRX:
001700 E7F9 3AA0F4          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
001703 E7FC E67F             7      AND 07FH
       E7FE                     LDDIRX1:
001705 E7FE 320CEF          13      LD  (_SECPS),A
001708 E801 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00170B E804 FD560F          19      LD  D,(IY+15)
00170E E807 1B               6      DEC DE
00170F E808 CDB6E7          17      CALL    ENDCL
001712 E80B D4E1E7          17      CALL    NC,LDDIR
       E80E                     LDDIRS:
001715 E80E 7A               4      LD  A,D
001716 E80F B3               4      OR  E
001717 E810 32A0F4          13      LD  (_DIRF),A   ;ディレクトリか判別
00171A E813 C9              10      RET
                                
       E814                     KILL:
00171B E814 CDDEE8          17      CALL    CHKWILDX
00171E E817 3834            12      JR  C,KILLW
001720 E819 CDBAE5          17      CALL    SOPENX
       E81C                     KILLS:
001723 E81C 3E1F             7      LD  A,01FH
001725 E81E D460E8          17      CALL    NC,CHKATT
001728 E821 D8              11      RET C
       E822                     KILLSX:
001729 E822 36E5            10      LD  (HL),0E5H   ;DIR
00172B E824 CDB8E8          17      CALL    WTDB
00172E E827 111A00          10      LD  DE,01AH
001731 E82A 19              11      ADD HL,DE
001732 E82B 5E               7      LD  E,(HL)
001733 E82C 23               6      INC HL
001734 E82D 56               7      LD  D,(HL)
       E82E                     KILLS1:
001735 E82E CDB6E7          17      CALL    ENDCL
001738 E831 D0              11      RET NC      ;CF=0
001739 E832 21FEFF          10      LD  HL,0-2
00173C E835 19              11      ADD HL,DE
00173D E836 D0              11      RET NC      ;DE= 0 or 1
00173E E837 D5              11      PUSH    DE
00173F E838 CDF7F4          17      CALL    _GNCL
001742 E83B ED53FEF5        20      LD  (_CLPS),DE
001746 E83F D1              10      POP DE
001747 E840 210000          10      LD  HL,0
00174A E843 D4FAF4          17      CALL    NC,_SNCL
00174D E846 D8              11      RET C
00174E E847 ED5BFEF5        20      LD  DE,(_CLPS)  ;FAT
001752 E84B 18E1            12      JR  KILLS1
                                
       E84D                     KILLW:
001754 E84D CDE9E5          17      CALL    SOPEN
       E850                     KILLW1:
001757 E850 380B            12      JR  C,KILLW2
001759 E852 CD88E6          17      CALL    SOPENE2
00175C E855 CD1CE8          17      CALL    KILLS
00175F E858 CD4DE6          17      CALL    NOPEN
001762 E85B 18F3            12      JR  KILLW1
       E85D                     KILLW2:
001764 E85D C8              11      RET Z
001765 E85E 3F               4      CCF
001766 E85F C9              10      RET
                                
       E860                     CHKATT:
001767 E860 E5              11      PUSH    HL
001768 E861 110B00          10      LD  DE,00BH
00176B E864 19              11      ADD HL,DE
00176C E865 A6               7      AND (HL)
00176D E866 E1              10      POP HL
00176E E867 C8              11      RET Z
00176F E868 37               4      SCF
001770 E869 C9              10      RET
                                
       E86A                     NAME:
001771 E86A CDDEE8          17      CALL    CHKWILDX
001774 E86D D8              11      RET C
001775 E86E 110400          10      LD  DE,4
001778 E871 19              11      ADD HL,DE
001779 E872 2287E8          16      LD  (NAMEP),HL
00177C E875 23               6      INC HL
00177D E876 CDE2E8          17      CALL    CHKWILD
001780 E879 D8              11      RET C
                                
001781 E87A CDBAE5          17      CALL    SOPENX
001784 E87D 3E0F             7      LD  A,00FH
001786 E87F D460E8          17      CALL    NC,CHKATT
001789 E882 D8              11      RET C
                                
00178A E883 FDE5            15      PUSH    IY
00178C E885 FD210000        14      LD  IY,0        ;自己書き換え
       E887                     NAMEP   EQU $-2
001790 E889 CDBAE5          17      CALL    SOPENX
001793 E88C FDE3            23      EX  (SP),IY
001795 E88E 3F               4      CCF
001796 E88F D4E9E5          17      CALL    NC,SOPEN
001799 E892 EB               4      EX  DE,HL
00179A E893 E1              10      POP HL
00179B E894 D8              11      RET C
                                
       E895                     SETNAME:
00179C E895 01000B          10      LD  BC,11*256
00179F E898 23               6      INC HL
0017A0 E899 7E               7      LD  A,(HL)
0017A1 E89A FEE5             7      CP  0E5H
0017A3 E89C 2004            12      JR  NZ,SNAME1
0017A5 E89E 3E05             7      LD  A,5
0017A7 E8A0 180E            12      JR  SNAME3
       E8A2                     SNAME1:
0017A9 E8A2 7E               7      LD  A,(HL)
0017AA E8A3 0C               4      INC C
0017AB E8A4 0D               4      DEC C
0017AC E8A5 2009            12      JR  NZ,SNAME3
0017AE E8A7 CDBEE7          17      CALL    CAP
0017B1 E8AA FEA0             7      CP  0A0H
0017B3 E8AC 2002            12      JR  NZ,SNAME3
0017B5 E8AE 3E20             7      LD  A,020H
       E8B0                     SNAME3:
0017B7 E8B0 12               7      LD  (DE),A
0017B8 E8B1 7E               7      LD  A,(HL)
0017B9 E8B2 23               6      INC HL
0017BA E8B3 CDCBE8          17      CALL    FKAN
0017BD E8B6 10EA            13      DJNZ    SNAME1
       E8B8                     WTDB:
0017BF E8B8 3EFF             7      LD  A,0FFH
0017C1 E8BA 3239F4          13      LD  (SFILE),A
0017C4 E8BD 3E01             7      LD  A,1
0017C6 E8BF 32A4F4          13      LD  (_WTDBF),A
0017C9 E8C2 AF               4      XOR A
0017CA E8C3 C9              10      RET
                                
       E8C4                     FKANC:
0017CB E8C4 CB41             8      BIT 0,C
0017CD E8C6 CCC7E7          17      CALL    Z,CAP2
0017D0 E8C9 1801            12      JR  FKANX
       E8CB                     FKAN:           ;漢字チェック
0017D2 E8CB 13               6      INC DE
       E8CC                     FKANX:
0017D3 E8CC CB41             8      BIT 0,C
0017D5 E8CE CB81             8      RES 0,C
0017D7 E8D0 C0              11      RET NZ
0017D8 E8D1 FE80             7      CP  080H
0017DA E8D3 D8              11      RET C
0017DB E8D4 FEA0             7      CP  0A0H
0017DD E8D6 3803            12      JR  C,FKAN1
0017DF E8D8 FEE0             7      CP  0E0H
0017E1 E8DA D8              11      RET C
       E8DB                     FKAN1:
0017E2 E8DB 0C               4      INC C
0017E3 E8DC A7               4      AND A
0017E4 E8DD C9              10      RET
                                
       E8DE                     CHKWILDX:
0017E5 E8DE FDE5            15      PUSH    IY
0017E7 E8E0 E1              10      POP HL
0017E8 E8E1 23               6      INC HL
       E8E2                     CHKWILD:
0017E9 E8E2 060B             7      LD  B,11
0017EB E8E4 3E3F             7      LD  A,'?'
       E8E6                     CHKWIL1:
0017ED E8E6 BE               7      CP  (HL)
0017EE E8E7 23               6      INC HL
0017EF E8E8 37               4      SCF
0017F0 E8E9 C8              11      RET Z
0017F1 E8EA 10FA            13      DJNZ    CHKWIL1
0017F3 E8EC AF               4      XOR A
0017F4 E8ED C9              10      RET
                                
       E8EE                     SDIRENT:        ;IY=FCB HL=DIR
0017F5 E8EE D5              11      PUSH    DE
0017F6 E8EF E5              11      PUSH    HL
0017F7 E8F0 FDE5            15      PUSH    IY
0017F9 E8F2 D1              10      POP DE
0017FA E8F3 EB               4      EX  DE,HL
0017FB E8F4 CD95E8          17      CALL    SETNAME
                                ;               Attribute
0017FE E8F7 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001801 E8FA 12               7      LD  (DE),A
001802 E8FB 13               6      INC DE
                                ;               Reserved
001803 E8FC AF               4      XOR A
001804 E8FD 060A             7      LD  B,10
       E8FF                     SDE1:
001806 E8FF 12               7      LD  (DE),A
001807 E900 13               6      INC DE
001808 E901 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
00180A E903 21E4F5          10      LD  HL,SDDATA       ;(FCB)更新年月日
00180D E906 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       E908                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
00180F E908 7E               7      LD  A,(HL)
001810 E909 23               6      INC HL
001811 E90A 320FE9          13      LD  (SDPAT),A
001814 E90D FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       E90F                     SDPAT   EQU $-1
001817 E910 12               7      LD  (DE),A
001818 E911 13               6      INC DE
001819 E912 10F4            13      DJNZ    SDLOOP
                                
00181B E914 AF               4      XOR A
00181C E915 E1              10      POP HL
00181D E916 D1              10      POP DE
00181E E917 C9              10      RET
                                
       E918                     WOPEN:
00181F E918 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001822 E91B E61F             7      AND 01FH
001824 E91D 37               4      SCF
001825 E91E C0              11      RET NZ
001826 E91F FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E923                     TOPEN2:
00182A E923 AF               4      XOR A
       E924                     TOPEN:              ;Initializes the time stamp
00182B E924 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
00182F E928 C9              10      RET
                                
       E929                     WRDFX:
001830 E929 3A9DE7          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       E92C                     L_WRFX:
001833 E92C 1F               4      RRA         ;->CF
001834 E92D 3806            12      JR  C,E_WRFX
001836 E92F CB39             8      SRL C
001838 E931 CB1C             8      RR  H       ;CH=CH/2
00183A E933 18F7            12      JR  L_WRFX
       E935                     E_WRFX:
00183C E935 41               4      LD  B,C
00183D E936 4C               4      LD  C,H
00183E E937 03               6      INC BC
00183F E938 3E37             7      LD  A,037H      ;SCF
001841 E93A 3295ED          13      LD  (DRDN1),A
                                
       E93D                     WRDF:               ;BCクラスタ分FATを確保する
001844 E93D 110200          10      LD  DE,2
001847 E940 AF               4      XOR A
001848 E941 320CEF          13      LD  (_SECPS),A
       E944                     WRDF1:
00184B E944 C5              11      PUSH    BC
00184C E945 D5              11      PUSH    DE
00184D E946 CDF7F4          17      CALL    _GNCL
001850 E949 381C            12      JR  C,WRDF3
001852 E94B 7A               4      LD  A,D     ;空いているかチェック
001853 E94C B3               4      OR  E
001854 E94D 202A            12      JR  NZ,WRDF4
001856 E94F E1              10      POP HL      ;HL=空いているクラスタ
001857 E950 E5              11      PUSH    HL
001858 E951 ED5BFEF5        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
00185C E955 22FEF5          16      LD  (_CLPS),HL
00185F E958 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
001860 E959 B3               4      OR  E
001861 E95A 2008            12      JR  NZ,WRDF2
001863 E95C FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
001866 E95F FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
001869 E962 1803            12      JR  WRDF3
       E964                     WRDF2:
00186B E964 CDFAF4          17      CALL    _SNCL
       E967                     WRDF3:
00186E E967 D1              10      POP DE
00186F E968 C1              10      POP BC
001870 E969 D8              11      RET C
001871 E96A 0B               6      DEC BC
001872 E96B 78               4      LD  A,B
001873 E96C B1               4      OR  C
001874 E96D 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
001876 E96F ED5BFEF5        20      LD  DE,(_CLPS)
00187A E973 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
00187D E976 C3FAF4          10      JP  _SNCL
                                
       E979                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
001880 E979 D1              10      POP DE
001881 E97A C1              10      POP BC
       E97B                     WRDF5:
001882 E97B 13               6      INC DE
001883 E97C CDB6E7          17      CALL    ENDCL
001886 E97F 38C3            12      JR  C,WRDF1
001888 E981 37               4      SCF
001889 E982 C9              10      RET
                                
       E983                     RWXR:
00188A E983 3A7EEC          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E986                     L_RWX:
00188D E986 1F               4      RRA     ;->CF
00188E E987 3808            12      JR  C,E_RWX
001890 E989 CB38             8      SRL B   ;BCH=BCH/2
001892 E98B CB19             8      RR  C   ;
001894 E98D CB1C             8      RR  H   ;
001896 E98F 18F5            12      JR  L_RWX
       E991                     E_RWX:
001898 E991 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
00189B E994 FD561B          19      LD  D,(IY+27)
00189E E997 AF               4      XOR A
00189F E998 320CEF          13      LD  (_SECPS),A
       E99B                     RWX1:
0018A2 E99B ED53FEF5        20      LD  (_CLPS),DE
0018A6 E99F 7A               4      LD  A,D
0018A7 E9A0 B3               4      OR  E
0018A8 E9A1 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
0018AA E9A3 78               4      LD  A,B
0018AB E9A4 B1               4      OR  C
0018AC E9A5 B4               4      OR  H
0018AD E9A6 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
0018AE E9A7 CD14EF          17      CALL    GNCLX
0018B1 E9AA D8              11      RET C
0018B2 E9AB 7C               4      LD  A,H     ;
0018B3 E9AC 25               4      DEC H       ;
0018B4 E9AD B7               4      OR  A       ;DEC BCH
0018B5 E9AE 2001            12      JR  NZ,RWX2     ;
0018B7 E9B0 0B               6      DEC BC      ;
       E9B1                     RWX2:
0018B8 E9B1 CDB6E7          17      CALL    ENDCL
0018BB E9B4 38E5            12      JR  C,RWX1
       E9B6                     SCF_RET:
0018BD E9B6 37               4      SCF
0018BE E9B7 C9              10      RET
                                
       E9B8                     DSKF:
0018BF E9B8 110000          10      LD  DE,0
       E9B9                     MAXCLP  EQU $-2
0018C2 E9BB 2AACF4          16      LD  HL,(_FAKEFREE)
0018C5 E9BE 7C               4      LD  A,H
0018C6 E9BF B5               4      OR  L
0018C7 E9C0 2803            12      JR  Z,DSKF1
0018C9 E9C2 110100          10      LD  DE,1
       E9C5                     DSKF1:
0018CC E9C5 D5              11      PUSH    DE
0018CD E9C6 CDF7F4          17      CALL    _GNCL
0018D0 E9C9 380C            12      JR  C,POPSCF
0018D2 E9CB 7A               4      LD  A,D
0018D3 E9CC B3               4      OR  E
0018D4 E9CD 2001            12      JR  NZ,DSKF2
0018D6 E9CF 23               6      INC HL
       E9D0                     DSKF2:
0018D7 E9D0 D1              10      POP DE
0018D8 E9D1 1B               6      DEC DE
0018D9 E9D2 7A               4      LD  A,D
0018DA E9D3 B3               4      OR  E
0018DB E9D4 20EF            12      JR  NZ,DSKF1
0018DD E9D6 C9              10      RET
                                
       E9D7                     POPSCF:
0018DE E9D7 F1              10      POP AF
0018DF E9D8 37               4      SCF
0018E0 E9D9 C9              10      RET
                                
       E9DA                     SETTMS:
0018E1 E9DA FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
0018E4 E9DD 3C               4      INC A
0018E5 E9DE C0              11      RET NZ      ;ファイルが更新されていない
       E9DF                     SETTMSX:            ;FCBに日付時刻をセットする
0018E6 E9DF CD8EE0          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
0018E9 E9E2 CB25             8      SLA L       ;   *2
0018EB E9E4 CB25             8      SLA L       ;   *4
0018ED E9E6 29              11      ADD HL,HL       ;*2 *8
0018EE E9E7 29              11      ADD HL,HL       ;*4 *16
0018EF E9E8 29              11      ADD HL,HL       ;*8 *32
0018F0 E9E9 7A               4      LD  A,D
0018F1 E9EA 0F               4      RRCA            ;bit.0->7->->->0->C
0018F2 E9EB E61F             7      AND 01FH
0018F4 E9ED B5               4      OR  L
0018F5 E9EE FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
0018F8 E9F1 FD7417          19      LD  (IY+23),H
                                
0018FB E9F4 CD6BE0          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
0018FE E9F7 0144F8          10      LD  BC,0-1980
001901 E9FA 09              11      ADD HL,BC
001902 E9FB 65               4      LD  H,L
                                
001903 E9FC 7A               4      LD  A,D
001904 E9FD 87               4      ADD A,A     ;*2
001905 E9FE 87               4      ADD A,A     ;*4
001906 E9FF 87               4      ADD A,A     ;*8
001907 EA00 87               4      ADD A,A     ;*16
001908 EA01 6F               4      LD  L,A
001909 EA02 29              11      ADD HL,HL       ;*32
00190A EA03 7D               4      LD  A,L
00190B EA04 B3               4      OR  E
00190C EA05 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
00190F EA08 FD7415          19      LD  (IY+21),H
001912 EA0B C9              10      RET
                                
       EA0C                     PUSHRR:
001913 EA0C 3280EA          13      LD  (SETSEQ_SWC_RND),A
001916 EA0F 2292EA          16      LD  (SETSEQ_SWC_SEQ_RR),HL
001919 EA12 CD32EA          17      CALL    GET_RR_AHL
00191C EA15 220FF4          16      LD  (RR_BUF_HL),HL
00191F EA18 3211F4          13      LD  (RR_BUF_A),A
001922 EA1B C9              10      RET
                                
       EA1C                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
001923 EA1C 87               4      ADD A,A     ;in BHLA => out AHL
001924 EA1D ED6A            15      ADC HL,HL
001926 EA1F CB18             8      RR  B
001928 EA21 B7               4      OR  A
001929 EA22 78               4      LD  A,B     ;ここでフラグは変化しない
00192A EA23 C8              11      RET Z
00192B EA24 2C               4      INC L       ;INC AHL
00192C EA25 C0              11      RET NZ      ;
00192D EA26 24               4      INC H       ;
00192E EA27 C0              11      RET NZ      ;
00192F EA28 3C               4      INC A       ;
001930 EA29 C9              10      RET
                                
       EA2A                     INIT_RND:
001931 EA2A 3ECD             7      LD  A,0CDH      ;CALL ????
001933 EA2C 2155EA          10      LD  HL,POPRR
001936 EA2F CD0CEA          17      CALL    PUSHRR
       EA32                     GET_RR_AHL:
001939 EA32 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00193C EA35 FD6622          19      LD  H,(IY+34)   ;
00193F EA38 FD7E23          19      LD  A,(IY+35)   ;
001942 EA3B C9              10      RET
       EA3C                     INIT_SEQ:
001943 EA3C 3E01             7      LD  A,1     ;LD BC,????
001945 EA3E 2152EA          10      LD  HL,SETSEQ
001948 EA41 CD0CEA          17      CALL    PUSHRR
       EA44                     GETSEQ:
00194B EA44 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
00194E EA47 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
001951 EA4A AF               4      XOR A
                                
001952 EA4B CB25             8      SLA L   ;L=L*2
                                
001954 EA4D CB3C             8      SRL H   ;HL=HL/2
001956 EA4F CB1D             8      RR  L   ;
001958 EA51 C9              10      RET
                                
       EA52                     SETSEQ:
001959 EA52 CD5EED          17      CALL    SETSEQ1
       EA55                     POPRR:
00195C EA55 F5              11      PUSH    AF
00195D EA56 E5              11      PUSH    HL
00195E EA57 2A0FF4          16      LD  HL,(RR_BUF_HL)
001961 EA5A 3A11F4          13      LD  A,(RR_BUF_A)
001964 EA5D CD54ED          17      CALL    SET_RR_AHL
001967 EA60 E1              10      POP HL
001968 EA61 F1              10      POP AF
001969 EA62 C9              10      RET
                                
       EA63                     RB_WRITE:
00196A EA63 C5              11      PUSH    BC
00196B EA64 ED4B4CF5        20      LD  BC,(STABLE+2*026H)  ;(BDOS)ランダムブロック書き込み
00196F EA68 1805            12      JR  RBRW
       EA6A                     RB_READ:
001971 EA6A C5              11      PUSH    BC
001972 EA6B ED4B4EF5        20      LD  BC,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       EA6F                     RBRW:
001976 EA6F 1F               4      RRA     ;AHL = AHL*128
001977 EA70 7C               4      LD  A,H ;AHL = AHL0/2
001978 EA71 1F               4      RRA     ;A
001979 EA72 65               4      LD  H,L ;
00197A EA73 CB1C             8      RR  H   ;H
00197C EA75 2E00             7      LD  L,0 ;
00197E EA77 CB1D             8      RR  L   ;L
001980 EA79 CD54ED          17      CALL    SET_RR_AHL
001983 EA7C 218000          10      LD  HL,128
001986 EA7F C5              11      PUSH    BC
       EA80                     SETSEQ_SWC_RND:
001987 EA80 CD5EED          17      CALL    SETSEQ1
00198A EA83 C1              10      POP BC
00198B EA84 FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
00198F EA88 FDE5            15      PUSH    IY
001991 EA8A D1              10      POP DE
001992 EA8B D5              11      PUSH    DE
001993 EA8C CD9AEA          17      CALL    JP_BC
001996 EA8F FDE1            14      POP IY
001998 EA91 CD52EA          17      CALL    SETSEQ
       EA92                     SETSEQ_SWC_SEQ_RR   EQU $-2
00199B EA94 FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
00199F EA98 C1              10      POP BC
0019A0 EA99 C9              10      RET
       EA9A                     JP_BC:
0019A1 EA9A C5              11      PUSH    BC
0019A2 EA9B C9              10      RET
                                
       E647                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       E647                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       E647                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       E647                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       E647                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       EA9C                     _SYS26:     ;(BDOS)ランダムブロック書き込み
0019A3 EA9C AF               4      XOR A
0019A4 EA9D 3295ED          13      LD  (DRDN1),A   ;NOP
0019A7 EAA0 22C1EC          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
0019AA EAA3 225DF4          16      LD  (LEFTX),HL
0019AD EAA6 CD90E5          17      CALL    SETDRV
                                
0019B0 EAA9 CD19EC          17      CALL    RBX0
0019B3 EAAC DA39EB          10      JP  C,RBWERR
0019B6 EAAF CD18E9          17      CALL    WOPEN
0019B9 EAB2 DA39EB          10      JP  C,RBWERR
0019BC EAB5 7C               4      LD  A,H
0019BD EAB6 B5               4      OR  L
0019BE EAB7 CA32EB          10      JP  Z,RBW1
                                
0019C1 EABA 2B               6      DEC HL
                                
0019C2 EABB CDD7EC          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0019C5 EABE 19              11      ADD HL,DE       ;BCHL=HL+BCDE
0019C6 EABF 3001            12      JR  NC,S26X1    ;
0019C8 EAC1 03               6      INC BC      ;
       EAC2                     S26X1:
0019C9 EAC2 CD83E9          17      CALL    RWXR
0019CC EAC5 DC29E9          17      CALL    C,WRDFX
0019CF EAC8 DA39EB          10      JP  C,RBWERR
                                
0019D2 EACB CD48EC          17      CALL    RBX2
0019D5 EACE 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
0019D7 EAD0 CD67EC          17      CALL    RBXA
0019DA EAD3 3864            12      JR  C,RBWERR
0019DC EAD5 EB               4      EX  DE,HL
0019DD EAD6 C5              11      PUSH    BC
0019DE EAD7 EDB0                    LDIR
0019E0 EAD9 225FF4          16      LD  (DTAX),HL
                                
0019E3 EADC CDB8E8          17      CALL    WTDB        ;バッファデータは更新された
                                
0019E6 EADF 2A5DF4          16      LD  HL,(LEFTX)
0019E9 EAE2 D1              10      POP DE
0019EA EAE3 ED52            15      SBC HL,DE
0019EC EAE5 225DF4          16      LD  (LEFTX),HL
0019EF EAE8 2831            12      JR  Z,RBWEND
                                
       EAEA                     RBWB:
0019F1 EAEA CD9CEC          17      CALL    RBXB
0019F4 EAED 2814            12      JR  Z,RBWC
       EAEF                     RBWB1:
0019F6 EAEF C5              11      PUSH    BC
0019F7 EAF0 D5              11      PUSH    DE
0019F8 EAF1 CD99E7          17      CALL    CLUSTX
0019FB EAF4 CDEBEC          17      CALL    DWTC
0019FE EAF7 D1              10      POP DE
0019FF EAF8 C1              10      POP BC
001A00 EAF9 D414EF          17      CALL    NC,GNCLX
001A03 EAFC 383B            12      JR  C,RBWERR
001A05 EAFE 10EF            13      DJNZ    RBWB1
001A07 EB00 CD3BED          17      CALL    DRW_FLUSH
       EB03                     RBWC:
001A0A EB03 CDB4EC          17      CALL    RBXC
001A0D EB06 2813            12      JR  Z,RBWEND
001A0F EB08 C5              11      PUSH    BC
001A10 EB09 CD99E7          17      CALL    CLUSTX
001A13 EB0C CD94ED          17      CALL    DRDN
001A16 EB0F C1              10      POP BC
001A17 EB10 3827            12      JR  C,RBWERR
001A19 EB12 ED5B7EF5        20      LD  DE,(_DTBUF)
001A1D EB16 EDB0                    LDIR
001A1F EB18 CDB8E8          17      CALL    WTDB        ;バッファデータは更新された
       EB1B                     RBWEND:
001A22 EB1B CDC0EC          17      CALL    RBXEND
                                
001A25 EB1E CD28EC          17      CALL    RBX1
001A28 EB21 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
001A2A EB23 CDD7EC          17      CALL    GET_RR_BCDE ;BCDE=Random record
001A2D EB26 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
001A30 EB29 FD7211          19      LD  (IY+17),D   ;
001A33 EB2C FD7112          19      LD  (IY+18),C   ;
001A36 EB2F FD7013          19      LD  (IY+19),B   ;
       EB32                     RBW1:
001A39 EB32 FDE1            14      POP IY
001A3B EB34 C1              10      POP BC
001A3C EB35 D1              10      POP DE
001A3D EB36 E1              10      POP HL
       EB37                     DD_NUL:
001A3E EB37 AF               4      XOR A
       EB38                     DRDF0:
       EB38                     DWTF0:
001A3F EB38 C9              10      RET
                                
       EB39                     RBWERR:
001A40 EB39 FDE5            15      PUSH    IY
001A42 EB3B D1              10      POP DE
001A43 EB3C 2A20F5          16      LD  HL,(STABLE+2*010H)
001A46 EB3F CD0F00          17      CALL    JP_HL
       EB42                     RBRERR1:
001A49 EB42 3E01             7      LD  A,001H
       EB44                     RBRERR2:
001A4B EB44 FDE1            14      POP IY
001A4D EB46 C1              10      POP BC
001A4E EB47 D1              10      POP DE
001A4F EB48 E1              10      POP HL
001A50 EB49 37               4      SCF
001A51 EB4A 210000          10      LD  HL,0
001A54 EB4D C9              10      RET
                                
       EB4E                     RBRERR:
001A55 EB4E 3EFF             7      LD  A,0FFH
001A57 EB50 18F2            12      JR  RBRERR2
                                
       EB52                     RBRFL:
001A59 EB52 3E00             7  RBRFLP: LD  A,000H
001A5B EB54 FE0D             7      CP  00DH
001A5D EB56 2005            12      JR  NZ,RBRFL1
001A5F EB58 D5              11      PUSH    DE
001A60 EB59 1E0A             7      LD  E,00AH
001A62 EB5B 1805            12      JR  RBRFL2
       EB5D                     RBRFL1:
001A64 EB5D D5              11      PUSH    DE
001A65 EB5E CD09F4          17      CALL    _SYS07
001A68 EB61 5F               4      LD  E,A
       EB62                     RBRFL2:
001A69 EB62 CDCDF4          17      CALL    _PRINT
001A6C EB65 7B               4      LD  A,E
001A6D EB66 D1              10      POP DE
001A6E EB67 3253EB          13      LD  (RBRFLP+1),A
001A71 EB6A C9              10      RET
       EB6B                     DDX:
001A72 EB6B FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
001A75 EB6E CDBEE7          17      CALL    CAP
001A78 EB71 FE41             7      CP  'A'
001A7A EB73 C9              10      RET
                                
                                                ;Read random block
       EB74                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001A7B EB74 225DF4          16      LD  (LEFTX),HL
001A7E EB77 CD90E5          17      CALL    SETDRV
                                
001A81 EB7A FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
001A85 EB7E C207EC          10      JP  NZ,RBRDIR   ;ディレクトリ
001A88 EB81 CD19EC          17      CALL    RBX0
001A8B EB84 DA4EEB          10      JP  C,RBRERR
001A8E EB87 CD28EC          17      CALL    RBX1
001A91 EB8A D440EC          17      CALL    NC,RBX1R
001A94 EB8D DA42EB          10      JP  C,RBRERR1
001A97 EB90 EB               4      EX  DE,HL
001A98 EB91 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
001A9A EB93 19              11      ADD HL,DE
001A9B EB94 79               4      LD  A,C
001A9C EB95 DE00             7      SBC A,0
001A9E EB97 78               4      LD  A,B
001A9F EB98 DE00             7      SBC A,0
001AA1 EB9A 3801            12      JR  C,RBR1
001AA3 EB9C EB               4      EX  DE,HL
       EB9D                     RBR1:
001AA4 EB9D 9F               4      SBC A,A
001AA5 EB9E E601             7      AND 1
001AA7 EBA0 3205EC          13      LD  (RBRA_SWC),A
                                
001AAA EBA3 7C               4      LD  A,H
001AAB EBA4 B5               4      OR  L
001AAC EBA5 2857            12      JR  Z,RBREND0
                                
001AAE EBA7 22C1EC          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
001AB1 EBAA 225DF4          16      LD  (LEFTX),HL
                                
001AB4 EBAD CD48EC          17      CALL    RBX2
001AB7 EBB0 2819            12      JR  Z,RBRB
001AB9 EBB2 CD67EC          17      CALL    RBXA
001ABC EBB5 DA4EEB          10      JP  C,RBRERR
001ABF EBB8 C5              11      PUSH    BC
001AC0 EBB9 EDB0                    LDIR
001AC2 EBBB ED535FF4        20      LD  (DTAX),DE
001AC6 EBBF 2A5DF4          16      LD  HL,(LEFTX)
001AC9 EBC2 D1              10      POP DE
001ACA EBC3 A7               4      AND A
001ACB EBC4 ED52            15      SBC HL,DE
001ACD EBC6 225DF4          16      LD  (LEFTX),HL
001AD0 EBC9 2830            12      JR  Z,RBREND
                                
       EBCB                     RBRB:
001AD2 EBCB CD9CEC          17      CALL    RBXB
001AD5 EBCE 2815            12      JR  Z,RBRC
       EBD0                     RBRB1:
001AD7 EBD0 C5              11      PUSH    BC
001AD8 EBD1 D5              11      PUSH    DE
001AD9 EBD2 CD99E7          17      CALL    CLUSTX
001ADC EBD5 CDF1EC          17      CALL    DRDC
001ADF EBD8 D1              10      POP DE
001AE0 EBD9 C1              10      POP BC
001AE1 EBDA D414EF          17      CALL    NC,GNCLX
001AE4 EBDD DA4EEB          10      JP  C,RBRERR
001AE7 EBE0 10EE            13      DJNZ    RBRB1
001AE9 EBE2 CD3BED          17      CALL    DRW_FLUSH
       EBE5                     RBRC:
001AEC EBE5 CDB4EC          17      CALL    RBXC
001AEF EBE8 2811            12      JR  Z,RBREND
001AF1 EBEA C5              11      PUSH    BC
001AF2 EBEB CD99E7          17      CALL    CLUSTX
001AF5 EBEE CD78ED          17      CALL    DRDX
001AF8 EBF1 C1              10      POP BC
001AF9 EBF2 DA4EEB          10      JP  C,RBRERR
001AFC EBF5 EB               4      EX  DE,HL
001AFD EBF6 2A7EF5          16      LD  HL,(_DTBUF)
001B00 EBF9 EDB0                    LDIR
       EBFB                     RBREND:
001B02 EBFB CDC0EC          17      CALL    RBXEND
       EBFE                     RBREND0:
001B05 EBFE FDE1            14      POP IY
001B07 EC00 C1              10      POP BC
001B08 EC01 D1              10      POP DE
001B09 EC02 F1              10      POP AF  ;(HL)
001B0A EC03 AF               4      XOR A
001B0B EC04 3E00             7      LD  A,000H
       EC05                     RBRA_SWC    EQU $-1
001B0D EC06 C9              10      RET
                                
       EC07                     RBRDIR:
001B0E EC07 FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001B11 EC0A FD661B          19      LD  H,(IY+27)
001B14 EC0D CDD4E7          17      CALL    CHDIR
001B17 EC10 AF               4      XOR A
001B18 EC11 67               4      LD  H,A
001B19 EC12 6F               4      LD  L,A
001B1A EC13 3C               4      INC A
001B1B EC14 3205EC          13      LD  (RBRA_SWC),A
001B1E EC17 18E5            12      JR  RBREND0
                                
       EC19                     RBX0:
001B20 EC19 2A8AF4          16      LD  HL,(_DTA)
001B23 EC1C 225FF4          16      LD  (DTAX),HL
001B26 EC1F 2A5DF4          16      LD  HL,(LEFTX)
001B29 EC22 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
001B2C EC25 D6FD             7      SUB 0FDH
001B2E EC27 C9              10      RET
                                
       EC28                     RBX1:               ;ファイルサイズとランダムレコードを比べる
001B2F EC28 E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
001B30 EC29 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
001B33 EC2C FD6611          19      LD  H,(IY+17)   ;
001B36 EC2F FD7E12          19      LD  A,(IY+18)   ;
                                
001B39 EC32 CDD7EC          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001B3C EC35 A7               4      AND A
001B3D EC36 ED52            15      SBC HL,DE
001B3F EC38 99               4      SBC A,C
001B40 EC39 4F               4      LD  C,A
001B41 EC3A FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
001B44 EC3D 98               4      SBC A,B
001B45 EC3E D1              10      POP DE
001B46 EC3F C9              10      RET
       EC40                     RBX1R:
001B47 EC40 47               4      LD  B,A
001B48 EC41 B1               4      OR  C
001B49 EC42 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
001B4A EC43 B2               4      OR  D
001B4B EC44 B3               4      OR  E
001B4C EC45 C0              11      RET NZ
001B4D EC46 37               4      SCF
001B4E EC47 C9              10      RET
                                
       EC48                     RBX2:               ;Cluster settings
001B4F EC48 FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001B52 EC4B FD4E23          19      LD  C,(IY+35)
001B55 EC4E 0600             7      LD  B,0
001B57 EC50 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001B5B EC54 2003            12      JR  NZ,RBX3
001B5D EC56 FD4624          19      LD  B,(IY+36)
       EC59                     RBX3:
001B60 EC59 CD83E9          17      CALL    RWXR
001B63 EC5C 3A7EEC          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
001B66 EC5F 3D               4      DEC A
001B67 EC60 FDA622          19      AND (IY+34)
001B6A EC63 FDB621          19      OR  (IY+33)
001B6D EC66 C9              10      RET
                                
       EC67                     RBXA:
001B6E EC67 C5              11      PUSH    BC
001B6F EC68 D5              11      PUSH    DE
001B70 EC69 CD99E7          17      CALL    CLUSTX
001B73 EC6C CD78ED          17      CALL    DRDX
001B76 EC6F D1              10      POP DE
001B77 EC70 C1              10      POP BC
001B78 EC71 D414EF          17      CALL    NC,GNCLX
001B7B EC74 D8              11      RET C
001B7C EC75 ED53FEF5        20      LD  (_CLPS),DE
                                
001B80 EC79 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
001B83 EC7C 210004          10  SECSZ:  LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
001B86 EC7F 7C               4      LD  A,H
001B87 EC80 3D               4      DEC A       ;1024=3 / 512=1
001B88 EC81 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
001B8B EC84 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
001B8C EC85 ED42            15      SBC HL,BC       ;残りを計算
                                
001B8E EC87 ED5B5DF4        20      LD  DE,(LEFTX)
001B92 EC8B ED52            15      SBC HL,DE       ;CP HL,DE
001B94 EC8D 19              11      ADD HL,DE       ;
001B95 EC8E 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
001B97 EC90 EB               4      EX  DE,HL
       EC91                     RBXA1:
001B98 EC91 E5              11      PUSH    HL
001B99 EC92 2A7EF5          16      LD  HL,(_DTBUF)
001B9C EC95 09              11      ADD HL,BC
001B9D EC96 ED5B5FF4        20      LD  DE,(DTAX)
001BA1 EC9A C1              10      POP BC
001BA2 EC9B C9              10      RET
                                
       EC9C                     RBXB:
001BA3 EC9C 2A5FF4          16      LD  HL,(DTAX)
001BA6 EC9F ED5BFEF5        20      LD  DE,(_CLPS)
001BAA ECA3 3A5EF4          13      LD  A,(LEFTX+1)
001BAD ECA6 47               4      LD  B,A
001BAE ECA7 3A7EEC          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       ECAA                     RBXB1:
001BB1 ECAA 1F               4      RRA     ;->CF
001BB2 ECAB 3804            12      JR  C,RBXB2
001BB4 ECAD CB38             8      SRL B   ;B=B/2
001BB6 ECAF 18F9            12      JR  RBXB1
       ECB1                     RBXB2:
001BB8 ECB1 78               4      LD  A,B
001BB9 ECB2 B7               4      OR  A
001BBA ECB3 C9              10      RET
                                
       ECB4                     RBXC:
001BBB ECB4 ED4B5DF4        20      LD  BC,(LEFTX)
001BBF ECB8 3A7EEC          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
001BC2 ECBB 3D               4      DEC A
001BC3 ECBC A0               4      AND B
001BC4 ECBD 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
001BC5 ECBE B1               4      OR  C
001BC6 ECBF C9              10      RET
                                
       ECC0                     RBXEND:             ;レコード数だけランダムレコードを進める
001BC7 ECC0 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       ECC1                     RBSIZE  EQU $-2
001BCA ECC3 CD32EA          17      CALL    GET_RR_AHL
001BCD ECC6 19              11      ADD HL,DE
001BCE ECC7 CE00             7      ADC A,0
001BD0 ECC9 CD54ED          17      CALL    SET_RR_AHL
001BD3 ECCC EB               4      EX  DE,HL       ;HL=進めるレコード数
001BD4 ECCD D0              11      RET NC
001BD5 ECCE FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001BD9 ECD2 C0              11      RET NZ
001BDA ECD3 FD3424          23      INC (IY+36)
001BDD ECD6 C9              10      RET
                                
       ECD7                     GET_RR_BCDE:            ;BCDE=Random record
001BDE ECD7 FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
001BE1 ECDA FD5622          19      LD  D,(IY+34)
001BE4 ECDD FD4E23          19      LD  C,(IY+35)
001BE7 ECE0 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
001BE9 ECE2 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001BED ECE6 C0              11      RET NZ
001BEE ECE7 FD4624          19      LD  B,(IY+36)
001BF1 ECEA C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       ECEB                     DWTC:
001BF2 ECEB E5              11      PUSH    HL
001BF3 ECEC 21AFF0          10      LD  HL,DWT24B
001BF6 ECEF 1804            12      JR  DWTC1
       ECF1                     DRDC:
001BF8 ECF1 E5              11      PUSH    HL
001BF9 ECF2 219FF0          10      LD  HL,DRD24B
       ECF5                     DWTC1:
001BFC ECF5 224FED          16      LD  (DRWF_MODE),HL
001BFF ECF8 E1              10      POP HL
001C00 ECF9 3A3FED          13      LD  A,(DRWF_B)
001C03 ECFC B7               4      OR  A
001C04 ECFD 200F            12      JR  NZ,DRDC1
       ECFF                     SAVE_DRWC:
001C06 ECFF 0601             7      LD  B,1
001C08 ED01 ED433EED        20      LD  (DRWF_C),BC
001C0C ED05 ED5345ED        20      LD  (DRWF_E),DE
001C10 ED09 2248ED          16      LD  (DRWF_HL),HL
001C13 ED0C 1820            12      JR  INC_HL_DRWC
       ED0E                     DRDC1:
001C15 ED0E E5              11      PUSH    HL
001C16 ED0F 2145ED          10      LD  HL,DRWF_E
001C19 ED12 86               7      ADD A,(HL)
001C1A ED13 F5              11      PUSH    AF
001C1B ED14 BB               4      CP  E
001C1C ED15 201D            12      JR  NZ,DRDC2
001C1E ED17 F1              10      POP AF
001C1F ED18 23               6      INC HL
001C20 ED19 7E               7      LD  A,(HL)
001C21 ED1A CE00             7      ADC A,0
001C23 ED1C F5              11      PUSH    AF
001C24 ED1D BA               4      CP  D
001C25 ED1E 2014            12      JR  NZ,DRDC2
001C27 ED20 F1              10      POP AF
001C28 ED21 3A3EED          13      LD  A,(DRWF_C)
001C2B ED24 CE00             7      ADC A,0
001C2D ED26 B9               4      CP  C
001C2E ED27 200C            12      JR  NZ,DRDC3
001C30 ED29 213FED          10      LD  HL,DRWF_B
001C33 ED2C 34              11      INC (HL)
001C34 ED2D E1              10      POP HL
       ED2E                     INC_HL_DRWC:
001C35 ED2E 3A7EEC          13      LD  A,(SECSZ+2)     ;1セクタのサイズの上位1バイト
001C38 ED31 84               4      ADD A,H
001C39 ED32 67               4      LD  H,A
001C3A ED33 C9              10      RET
       ED34                     DRDC2:
001C3B ED34 F1              10      POP AF
       ED35                     DRDC3:
001C3C ED35 CD3BED          17      CALL    DRW_FLUSH
001C3F ED38 E1              10      POP HL
001C40 ED39 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       ED3B                     DRW_FLUSH:
001C42 ED3B C5              11      PUSH    BC
001C43 ED3C D5              11      PUSH    DE
001C44 ED3D 010000          10      LD  BC,0
       ED3E                     DRWF_C  EQU $-2
       ED3F                     DRWF_B  EQU $-1
001C47 ED40 78               4      LD  A,B
001C48 ED41 B7               4      OR  A
001C49 ED42 280D            12      JR  Z,DRDF1
001C4B ED44 110000          10      LD  DE,0
       ED45                     DRWF_E  EQU $-2
       ED46                     DRWF_D  EQU $-1
001C4E ED47 210000          10      LD  HL,0
       ED48                     DRWF_HL EQU $-2
001C51 ED4A AF               4      XOR A
001C52 ED4B 323FED          13      LD  (DRWF_B),A
001C55 ED4E CD9FF0          17      CALL    DRD24B
       ED4F                     DRWF_MODE   EQU $-2
       ED51                     DRDF1:
001C58 ED51 D1              10      POP DE
001C59 ED52 C1              10      POP BC
001C5A ED53 C9              10      RET
                                
       ED54                     SET_RR_AHL:
001C5B ED54 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001C5E ED57 FD7422          19      LD  (IY+34),H
001C61 ED5A FD7723          19      LD  (IY+35),A
001C64 ED5D C9              10      RET
                                
       ED5E                     SETSEQ1:
001C65 ED5E F5              11      PUSH    AF
001C66 ED5F E5              11      PUSH    HL      ;AHL=Random record
001C67 ED60 CD32EA          17      CALL    GET_RR_AHL
001C6A ED63 47               4      LD  B,A     ;AHL→HLA
001C6B ED64 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
001C6C ED65 6C               4      LD  L,H     ;(IY+34)
001C6D ED66 60               4      LD  H,B     ;(IY+35)
001C6E ED67 0600             7      LD  B,0
                                
001C70 ED69 CD1CEA          17      CALL    GET_CPM_R_SIZE
                                
001C73 ED6C 29              11      ADD HL,HL
001C74 ED6D CB3D             8      SRL L       ;L=L/2
001C76 ED6F FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
001C79 ED72 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
001C7C ED75 E1              10      POP HL
001C7D ED76 F1              10      POP AF
001C7E ED77 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       ED78                     DRDX:
001C7F ED78 CDB6ED          17      CALL    DRDY
001C82 ED7B C8              11      RET Z
001C83 ED7C CD9CED          17      CALL    DRDX1       ;データバッファの情報を保存
001C86 ED7F D8              11      RET C
001C87 ED80 E5              11      PUSH    HL
001C88 ED81 C5              11      PUSH    BC
001C89 ED82 D5              11      PUSH    DE
001C8A ED83 2A7EF5          16      LD  HL,(_DTBUF)
001C8D ED86 3ADFED          13      LD  A,(_DBS24)
001C90 ED89 4F               4      LD  C,A
001C91 ED8A CD9DF0          17      CALL    DRD24
001C94 ED8D DCB1ED          17      CALL    C,DRDNE
       ED90                     POP_DE_BC_HL_RET:
001C97 ED90 D1              10      POP DE
001C98 ED91 C1              10      POP BC
001C99 ED92 E1              10      POP HL
001C9A ED93 C9              10      RET
                                
                                ;   CDE:セクタ番号
       ED94                     DRDN:
001C9B ED94 AF               4      XOR A
001C9C ED95 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
001C9D ED96 30E0            12      JR  NC,DRDX
       ED98                     DRDNX:
001C9F ED98 CDB6ED          17      CALL    DRDY
001CA2 ED9B C8              11      RET Z
       ED9C                     DRDX1:
001CA3 ED9C CDCCED          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
001CA6 ED9F ED53A6F4        20      LD  (_DBSEC),DE
001CAA EDA3 79               4      LD  A,C
001CAB EDA4 32DFED          13      LD  (_DBS24),A
                                
001CAE EDA7 3A88F4          13      LD  A,(_DRV)
001CB1 EDAA 32A5F4          13      LD  (_DBDRV),A
001CB4 EDAD CDD9F4          17      CALL    _CHGDRV
001CB7 EDB0 D0              11      RET NC
       EDB1                     DRDNE:
001CB8 EDB1 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001CB9 EDB2 32A5F4          13      LD  (_DBDRV),A
001CBC EDB5 C9              10      RET
                                
                                ;   CDE:セクタ番号
       EDB6                     DRDY:
001CBD EDB6 3ADFED          13      LD  A,(_DBS24)
001CC0 EDB9 B9               4      CP  C
001CC1 EDBA C0              11      RET NZ
                                
001CC2 EDBB E5              11      PUSH    HL
001CC3 EDBC 3A88F4          13      LD  A,(_DRV)
001CC6 EDBF 21A5F4          10      LD  HL,_DBDRV
001CC9 EDC2 AE               7      XOR (HL)
001CCA EDC3 2005            12      JR  NZ,POP_HL_RET
                                
001CCC EDC5 2AA6F4          16      LD  HL,(_DBSEC)
001CCF EDC8 ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       EDCA                     POP_HL_RET:
001CD1 EDCA E1              10      POP HL
001CD2 EDCB C9              10      RET
                                
       EDCC                     DWTX:
001CD3 EDCC 3AA4F4          13      LD  A,(_WTDBF)
001CD6 EDCF B7               4      OR  A
001CD7 EDD0 C8              11      RET Z
001CD8 EDD1 AF               4      XOR A
001CD9 EDD2 32A4F4          13      LD  (_WTDBF),A
                                
001CDC EDD5 E5              11      PUSH    HL
001CDD EDD6 C5              11      PUSH    BC
001CDE EDD7 D5              11      PUSH    DE
001CDF EDD8 3AA5F4          13      LD  A,(_DBDRV)
001CE2 EDDB CDD9F4          17      CALL    _CHGDRV
001CE5 EDDE 0E00             7      LD  C,0
       EDDF                     _DBS24  EQU $-1
001CE7 EDE0 ED5BA6F4        20      LD  DE,(_DBSEC)
001CEB EDE4 2A7EF5          16      LD  HL,(_DTBUF)
001CEE EDE7 D4ADF0          17      CALL    NC,DWT24
       EDEA                     POP_DE_BC_HL_RET2:
001CF1 EDEA 18A4            12      JR  POP_DE_BC_HL_RET
                                
       EDEC                     RDFATX:
001CF3 EDEC E5              11      PUSH    HL
001CF4 EDED 3A88F4          13      LD  A,(_DRV)
001CF7 EDF0 21AAF4          10      LD  HL,_FATDRV
001CFA EDF3 AE               7      XOR (HL)
001CFB EDF4 28D4            12      JR  Z,POP_HL_RET
                                
001CFD EDF6 C5              11      PUSH    BC
001CFE EDF7 D5              11      PUSH    DE
001CFF EDF8 DDE5            15      PUSH    IX
001D01 EDFA CD16EE          17      CALL    WTFATX
001D04 EDFD 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
001D06 EDFF AF               4      XOR A
001D07 EE00 32ABF4          13      LD  (_FATIX),A
001D0A EE03 3A88F4          13      LD  A,(_DRV)
001D0D EE06 32AAF4          13      LD  (_FATDRV),A
001D10 EE09 CDE5F4          17      CALL    _RDFAT
       EE0C                     RDFATE2:
001D13 EE0C 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
001D15 EE0E 9F               4      SBC A,A     ;A=0xFF
001D16 EE0F 32AAF4          13      LD  (_FATDRV),A
       EE12                     POP_IX_DE_BC_HL_RET:
001D19 EE12 DDE1            14      POP IX
001D1B EE14 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       EE16                     WTFATX:
001D1D EE16 3AA2F4          13      LD  A,(_WTFATF)
001D20 EE19 B7               4      OR  A
001D21 EE1A C8              11      RET Z
001D22 EE1B E5              11      PUSH    HL
001D23 EE1C 3AAAF4          13      LD  A,(_FATDRV)
001D26 EE1F 21A5F4          10      LD  HL,_DBDRV
001D29 EE22 AE               7      XOR (HL)
001D2A EE23 CCCCED          17      CALL    Z,DWTX
001D2D EE26 38A2            12      JR  C,POP_HL_RET
001D2F EE28 C5              11      PUSH    BC
001D30 EE29 D5              11      PUSH    DE
001D31 EE2A DDE5            15      PUSH    IX
001D33 EE2C CDBAF0          17      CALL    WTFAT
001D36 EE2F AF               4      XOR A
001D37 EE30 32A2F4          13      LD  (_WTFATF),A
001D3A EE33 18DD            12      JR  POP_IX_DE_BC_HL_RET
                                
       EE35                     N16CL1:
001D3C EE35 7A               4      LD  A,D
001D3D EE36 B3               4      OR  E
001D3E EE37 37               4      SCF
001D3F EE38 C8              11      RET Z
                                
001D40 EE39 7A               4      LD  A,D
001D41 EE3A 1807            12      JR  NCL1X
       EE3C                     NCL1:
001D43 EE3C 7A               4      LD  A,D
001D44 EE3D B3               4      OR  E
001D45 EE3E 37               4      SCF
001D46 EE3F C8              11      RET Z
                                
001D47 EE40 7A               4      LD  A,D
001D48 EE41 CB3F             8      SRL A   ;/2
       EE43                     NCL1X:
001D4A EE43 CB3F             8      SRL A   ;/2
                                
001D4C EE45 E5              11      PUSH    HL
001D4D EE46 3265EE          13      LD  (NCLPAT_FATIX),A    ;_FATIX
001D50 EE49 2AAAF4          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001D53 EE4C BC               4      CP  H
001D54 EE4D 3A88F4          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001D57 EE50 3264EE          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001D5A EE53 2005            12      JR  NZ,NCL2     ;FATIXが違う
001D5C EE55 BD               4      CP  L
001D5D EE56 2002            12      JR  NZ,NCL2     ;ドライブが違う
001D5F EE58 E1              10      POP HL
001D60 EE59 C9              10      RET
       EE5A                     NCL2:
001D61 EE5A C5              11      PUSH    BC
001D62 EE5B D5              11      PUSH    DE
001D63 EE5C DDE5            15      PUSH    IX
001D65 EE5E CD16EE          17      CALL    WTFATX
001D68 EE61 38AF            12      JR  C,POP_IX_DE_BC_HL_RET
001D6A EE63 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       EE65                     NCLPAT_FATIX    EQU $-1
       EE64                     NCLPAT_FATDRV   EQU $-2
001D6D EE66 ED43AAF4        20      LD  (_FATDRV),BC
001D71 EE6A CD8FF0          17      CALL    RDFATS
001D74 EE6D 189D            12      JR  RDFATE2
                                
       EE6F                     NCL3:
001D76 EE6F CB9A             8      RES 3,D
001D78 EE71 CB92             8      RES 2,D
001D7A EE73 6B               4      LD  L,E
001D7B EE74 62               4      LD  H,D
001D7C EE75 CB3C             8      SRL H   ;
001D7E EE77 CB1D             8      RR  L   ;HLA=HLA/2
001D80 EE79 1F               4      RRA     ;
001D81 EE7A F5              11      PUSH    AF
001D82 EE7B 3AABF4          13      LD  A,(_FATIX)
001D85 EE7E 0F               4      RRCA
001D86 EE7F 300B            12      JR  NC,NCL3X1
001D88 EE81 3A7EEC          13      LD  A,(SECSZ+2)
001D8B EE84 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
001D8D EE86 2004            12      JR  NZ,NCL3X1
001D8F EE88 010002          10      LD  BC,512
001D92 EE8B 09              11      ADD HL,BC
       EE8C                     NCL3X1:
001D93 EE8C F1              10      POP AF
001D94 EE8D ED4B7CF5        20      LD  BC,(_FATBF)
001D98 EE91 19              11      ADD HL,DE
001D99 EE92 09              11      ADD HL,BC
001D9A EE93 17               4      RLA
001D9B EE94 C9              10      RET
                                
       EE95                     GNCL:
001D9C EE95 CD3CEE          17      CALL    NCL1        ;GET NEXT CLUSTER
001D9F EE98 D8              11      RET C
001DA0 EE99 C5              11      PUSH    BC
001DA1 EE9A E5              11      PUSH    HL
001DA2 EE9B CD6FEE          17      CALL    NCL3
001DA5 EE9E 3809            12      JR  C,GNC1
001DA7 EEA0 5E               7      LD  E,(HL)
001DA8 EEA1 23               6      INC HL
001DA9 EEA2 7E               7      LD  A,(HL)
001DAA EEA3 E60F             7      AND 00FH
001DAC EEA5 57               4      LD  D,A
001DAD EEA6 E1              10      POP HL
001DAE EEA7 C1              10      POP BC
001DAF EEA8 C9              10      RET
       EEA9                     GNC1:
001DB0 EEA9 7E               7      LD  A,(HL)
001DB1 EEAA 23               6      INC HL
001DB2 EEAB 56               7      LD  D,(HL)
001DB3 EEAC 0604             7      LD  B,4
       EEAE                     GNC1L:
001DB5 EEAE CB3A             8      SRL D   ;DA=DA/2
001DB7 EEB0 1F               4      RRA     ;
001DB8 EEB1 10FB            13      DJNZ    GNC1L
                                
001DBA EEB3 5F               4      LD  E,A
001DBB EEB4 E1              10      POP HL
001DBC EEB5 C1              10      POP BC
001DBD EEB6 A7               4      AND A
001DBE EEB7 C9              10      RET
                                
       EEB8                     SNCL:
001DBF EEB8 CD3CEE          17      CALL    NCL1
001DC2 EEBB D8              11      RET C
                                ;               SET NEXT CLUSTER
001DC3 EEBC E5              11      PUSH    HL
001DC4 EEBD C5              11      PUSH    BC
001DC5 EEBE D5              11      PUSH    DE
001DC6 EEBF E5              11      PUSH    HL
001DC7 EEC0 CD6FEE          17      CALL    NCL3
001DCA EEC3 D1              10      POP DE
                                ;CF=ODD
001DCB EEC4 7E               7      LD  A,(HL)
001DCC EEC5 73               7      LD  (HL),E
001DCD EEC6 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
001DCF EEC8 23               6      INC HL
001DD0 EEC9 ED67            18      RRD     ;M={A[3:0],E[3:0]}
001DD2 EECB 7A               4      LD  A,D
001DD3 EECC 1804            12      JR  SNC11
       EECE                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
001DD5 EECE ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001DD7 EED0 23               6      INC HL
001DD8 EED1 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       EED2                     SNC11:
001DD9 EED2 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
001DDB EED4 B7               4      OR  A
001DDC EED5 D1              10      POP DE
001DDD EED6 C1              10      POP BC
001DDE EED7 E1              10      POP HL
       EED8                     FAT_CHANGED:
001DDF EED8 3E01             7      LD  A,1
001DE1 EEDA 32A2F4          13      LD  (_WTFATF),A
001DE4 EEDD C9              10      RET
                                
       EEDE                     N16CL3:
001DE5 EEDE C5              11      PUSH    BC
001DE6 EEDF 6B               4      LD  L,E
001DE7 EEE0 7A               4      LD  A,D
001DE8 EEE1 E601             7      AND 1
001DEA EEE3 67               4      LD  H,A
001DEB EEE4 29              11      ADD HL,HL
001DEC EEE5 ED4B7CF5        20      LD  BC,(_FATBF)
001DF0 EEE9 09              11      ADD HL,BC
001DF1 EEEA C1              10      POP BC
001DF2 EEEB C9              10      RET
                                
       EEEC                     GNCL16:
001DF3 EEEC CD35EE          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
001DF6 EEEF D8              11      RET C
001DF7 EEF0 E5              11      PUSH    HL
001DF8 EEF1 CDDEEE          17      CALL    N16CL3
001DFB EEF4 5E               7      LD  E,(HL)
001DFC EEF5 23               6      INC HL
001DFD EEF6 56               7      LD  D,(HL)
001DFE EEF7 E1              10      POP HL
001DFF EEF8 C9              10      RET
                                
       EEF9                     SNCL16:
001E00 EEF9 CD35EE          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
001E03 EEFC D8              11      RET C
001E04 EEFD D5              11      PUSH    DE
001E05 EEFE E5              11      PUSH    HL
001E06 EEFF CDDEEE          17      CALL    N16CL3
001E09 EF02 D1              10      POP DE      ;HL
001E0A EF03 73               7      LD  (HL),E
001E0B EF04 23               6      INC HL
001E0C EF05 72               7      LD  (HL),D
001E0D EF06 6B               4      LD  L,E
001E0E EF07 62               4      LD  H,D
001E0F EF08 D1              10      POP DE
001E10 EF09 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       EF0B                     NEXTX:
001E12 EF0B 3E00             7      LD  A,0 ;自己書き換え
       EF0C                     _SECPS  EQU $-1
001E14 EF0D 3C               4      INC A
001E15 EF0E E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       EF0F                     _NCPAT  EQU $-1
001E17 EF10 320CEF          13      LD  (_SECPS),A
001E1A EF13 C9              10      RET
                                
       EF14                     GNCLX:
001E1B EF14 CD0BEF          17      CALL    NEXTX
001E1E EF17 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001E1F EF18 C3F7F4          10      JP  _GNCL   ;次のクラスタを探す
                                
       EF1B                     RDFAT:
001E22 EF1B 3E80             7      LD  A,080H
001E24 EF1D 3270F4          13      LD  (CHECK),A
       EF20                     RDFAT1:
001E27 EF20 3A88F4          13      LD  A,(_DRV)
001E2A EF23 CDC9F1          17      CALL    CHGDRVR
001E2D EF26 D8              11      RET C
001E2E EF27 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001E31 EF2A CB6F             8      BIT 5,A
001E33 EF2C 286C            12      JR  Z,RDFAT0X
001E35 EF2E 2170F4          10      LD  HL,CHECK
001E38 EF31 A6               7      AND (HL)
001E39 EF32 77               7      LD  (HL),A
001E3A EF33 110000          10      LD  DE,0        ;BPB
001E3D EF36 2A7CF5          16      LD  HL,(_FATBF)
001E40 EF39 CD9BF0          17      CALL    DRD16
001E43 EF3C 3024            12      JR  NC,GETBPB
001E45 EF3E 2170F4          10      LD  HL,CHECK
001E48 EF41 CB06            15      RLC (HL)
001E4A EF43 3F               4      CCF
001E4B EF44 D8              11      RET C
001E4C EF45 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
001E50 EF49 3F               4      CCF         ;フロッピーディスクのFDモードを切り替える
001E51 EF4A DDCB0A16        23      RL  (IX+DPB_FDMODE)
001E55 EF4E 3EFF             7      LD  A,0FFH
001E57 EF50 3289F4          13      LD  (_DSK),A
001E5A EF53 3A84F4          13      LD  A,(_DRIVE)
001E5D EF56 E603             7      AND 3
001E5F EF58 F680             7      OR  080H
001E61 EF5A 6F               4      LD  L,A
001E62 EF5B 26F4             7      LD  H,_CYL0/256
001E64 EF5D 3EFF             7      LD  A,0FFH
001E66 EF5F 77               7      LD  (HL),A
001E67 EF60 18BE            12      JR  RDFAT1
       EF62                     GETBPB:
001E69 EF62 FDE5            15      PUSH    IY
001E6B EF64 FD2A7CF5        20      LD  IY,(_FATBF) ;BPB
001E6F EF68 CDF1F4          17      CALL    _BPB2DPB
001E72 EF6B FDE1            14      POP IY
001E74 EF6D DD7E12          19      LD  A,(IX+DPB_DEVICE)
001E77 EF70 3025            12      JR  NC,GETBPBOK
001E79 EF72 E60F             7      AND 00FH
001E7B EF74 FE07             7      CP  7
001E7D EF76 37               4      SCF
001E7E EF77 C0              11      RET NZ
001E7F EF78 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001E83 EF7C 21C0F5          10      LD  HL,M2D
001E86 EF7F 2006            12      JR  NZ,SETFDMODE
001E88 EF81 CD74F0          17      CALL    CHECK1024
001E8B EF84 D8              11      RET C
001E8C EF85 2ED2             7      LD  L,M2HD-STABLE
       EF87                     SETFDMODE:
001E8E EF87 DDE5            15      PUSH    IX
001E90 EF89 D1              10      POP DE
001E91 EF8A EDA0            16      LDI
001E93 EF8C EDA0            16      LDI
001E95 EF8E 13               6      INC DE
001E96 EF8F 13               6      INC DE
001E97 EF90 13               6      INC DE
001E98 EF91 13               6      INC DE
001E99 EF92 010C00          10      LD  BC,12
001E9C EF95 EDB0                    LDIR
       EF97                     GETBPBOK:
001E9E EF97 CD35F1          17      CALL    CHGDRV2
       EF9A                     RDFAT0X:
001EA1 EF9A CD8FF0          17      CALL    RDFATS
001EA4 EF9D D8              11      RET C
001EA5 EF9E DDAE06          19      XOR (IX+DPB_FATID)
001EA8 EFA1 C8              11      RET Z
001EA9 EFA2 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001EAC EFA5 CB5F             8      BIT 3,A
001EAE EFA7 2803            12      JR  Z,RDFAT0X1
001EB0 EFA9 CB6F             8      BIT 5,A
001EB2 EFAB C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       EFAC                     RDFAT0X1:
001EB3 EFAC 37               4      SCF
001EB4 EFAD C9              10      RET
                                
       EFAE                     POP_HL_SCF_RET:
001EB5 EFAE E1              10      POP HL
001EB6 EFAF 37               4      SCF
001EB7 EFB0 C9              10      RET
                                
       EFB1                     BPB2DPB:
001EB8 EFB1 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
001EBB EFB4 B7               4      OR  A
001EBC EFB5 37               4      SCF
001EBD EFB6 C0              11      RET NZ
       EFB7                     BPBOK:
001EBE EFB7 FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001EC1 EFBA DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001EC4 EFBD FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001EC7 EFC0 DD7700          19      LD  (IX+DPB_FATLN),A
001ECA EFC3 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
001ECD EFC6 DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
001ED0 EFC9 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001ED3 EFCC FD660F          19      LD  H,(IY+15)
001ED6 EFCF DD750E          19      LD  (IX+DPB_FATPS),L
001ED9 EFD2 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001EDC EFD5 FD5617          19      LD  D,(IY+23)
001EDF EFD8 FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       EFDB                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001EE2 EFDB 19              11      ADD HL,DE
001EE3 EFDC 10FD            13      DJNZ    BPBDP1
       EFDE                     BPBDP2:
001EE5 EFDE DD7510          19      LD  (IX+DPB_DIRPS),L
001EE8 EFE1 DD7411          19      LD  (IX+DPB_DIRPS+1),H
001EEB EFE4 E5              11      PUSH    HL
                                
001EEC EFE5 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
001EEF EFE8 FD6612          19      LD  H,(IY+18)
001EF2 EFEB FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001EF5 EFEE B7               4      OR  A
001EF6 EFEF 28BD            12      JR  Z,POP_HL_SCF_RET
001EF8 EFF1 0606             7      LD  B,6
       EFF3                     BPBBPS1:
001EFA EFF3 05               4      DEC B
001EFB EFF4 0F               4      RRCA
001EFC EFF5 30FC            12      JR  NC,BPBBPS1
       EFF7                     BPBDE1:
001EFE EFF7 29              11      ADD HL,HL
001EFF EFF8 10FD            13      DJNZ    BPBDE1
                                
001F01 EFFA 7C               4      LD  A,H
001F02 EFFB DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
001F05 EFFE D1              10      POP DE      ;DPB_DIRPS
001F06 EFFF 6C               4      LD  L,H
001F07 F000 2600             7      LD  H,0
001F09 F002 19              11      ADD HL,DE       ;MAXDIR
001F0A F003 E5              11      PUSH    HL
001F0B F004 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
001F0E F007 CB21             8      SLA C       ;*2
001F10 F009 AF               4      XOR A
001F11 F00A 47               4      LD  B,A
001F12 F00B ED42            15      SBC HL,BC
001F14 F00D DD7514          19      LD  (IX+DPB_ADDCL),L
001F17 F010 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
001F1A F013 D1              10      POP DE      ;DE=DPB_MAXDIR
001F1B F014 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
001F1E F017 FD6614          19      LD  H,(IY+20)
                                
001F21 F01A DD7E12          19      LD  A,(IX+DPB_DEVICE)
001F24 F01D E60F             7      AND 00FH
001F26 F01F FE07             7      CP  7       ;フロッピー
001F28 F021 2019            12      JR  NZ,NOT_FD
001F2A F023 E5              11      PUSH    HL
001F2B F024 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
001F2E F027 DD710D          19      LD  (IX+DPB_MAXSEC),C
001F31 F02A AF               4      XOR A
001F32 F02B CB21             8      SLA C       ;両面なのでセクタ数を２倍
001F34 F02D 0610             7      LD  B,16
       F02F                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001F36 F02F 29              11      ADD HL,HL
001F37 F030 17               4      RLA
001F38 F031 B9               4      CP  C
001F39 F032 3802            12      JR  C,DIVSEC1
001F3B F034 91               4      SUB C
001F3C F035 2C               4      INC L
       F036                     DIVSEC1:
001F3D F036 10F7            13      DJNZ    DIVSEC
001F3F F038 DD750C          19      LD  (IX+DPB_MAXCYL),L
001F42 F03B E1              10      POP HL  ;ここまでフロッピー専用
       F03C                     NOT_FD:
001F43 F03C 7C               4      LD  A,H
001F44 F03D B5               4      OR  L
001F45 F03E 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001F47 F040 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001F49 F042 2F               4      CPL         ;A=0FFH
001F4A F043 FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001F4D F046 D8              11      RET C
001F4E F047 FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001F51 F04A FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001F54 F04D FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       F050                     BPB16BIT:
001F57 F050 ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001F59 F052 DE00             7      SBC A,0
001F5B F054 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       F057                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001F5E F057 CB18             8      RR  B       ;->CY
001F60 F059 3808            12      JR  C,BPBTC2
001F62 F05B CB3F             8      SRL A
001F64 F05D CB1C             8      RR  H       ;AHL=AHL/2
001F66 F05F CB1D             8      RR  L
001F68 F061 18F4            12      JR  BPBTC1
       F063                     BPBTC2:
001F6A F063 C6FF             7      ADD A,0FFH
001F6C F065 D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001F6D F066 23               6      INC HL
001F6E F067 23               6      INC HL
001F6F F068 DD7508          19      LD  (IX+DPB_MAXCL),L
001F72 F06B DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001F75 F06E FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001F78 F071 DD7706          19      LD  (IX+DPB_FATID),A
       F074                     CHECK1024:
001F7B F074 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001F7E F077 C6FE             7      ADD A,0-2       ;>2:CF=1
001F80 F079 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001F83 F07C 6F               4      LD  L,A
001F84 F07D 3002            12      JR  NC,BPBFAT1
001F86 F07F F680             7      OR  080H
       F081                     BPBFAT1:            ;ここではCF=0
001F88 F081 DD770F          19      LD  (IX+DPB_BPS),A
001F8B F084 3A7BF5          13      LD  A,(_MAX_SEC_SZ_H)
001F8E F087 BD               4      CP  L
001F8F F088 C8              11      RET Z       ;1セクタ1024バイト
001F90 F089 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001F91 F08A C8              11      RET Z       ;1セクタ256バイト
001F92 F08B 2D               4      DEC L
001F93 F08C C8              11      RET Z       ;1セクタ512バイト
001F94 F08D 37               4      SCF
001F95 F08E C9              10      RET
                                
       F08F                     RDFATS:
001F96 F08F CDC0F0          17      CALL    FATSETUP
001F99 F092 D8              11      RET C
001F9A F093 CD9FF0          17      CALL    DRD24B
001F9D F096 2A7CF5          16      LD  HL,(_FATBF)
001FA0 F099 7E               7      LD  A,(HL)
001FA1 F09A C9              10      RET
                                
       F09B                     DRD16:
001FA2 F09B 0E00             7      LD  C,0
       F09D                     DRD24:
001FA4 F09D 0601             7      LD  B,1
       F09F                     DRD24B:
001FA6 F09F DDE5            15      PUSH    IX
001FA8 F0A1 DD2AA8F4        20      LD  IX,(_DPB)
001FAC F0A5 CDEAF2          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       F0A6                     DRDPAT  EQU $-2
       F0A8                     POP_IX_RET:
001FAF F0A8 DDE1            14      POP IX
001FB1 F0AA C9              10      RET
                                
       F0AB                     DWT16:
001FB2 F0AB 0E00             7      LD  C,0
       F0AD                     DWT24:
001FB4 F0AD 0601             7      LD  B,1
       F0AF                     DWT24B:
001FB6 F0AF DDE5            15      PUSH    IX
001FB8 F0B1 DD2AA8F4        20      LD  IX,(_DPB)
001FBC F0B5 CDDCF2          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       F0B6                     DWTPAT  EQU $-2
001FBF F0B8 18EE            12      JR  POP_IX_RET
                                
       F0BA                     WTFAT:
001FC1 F0BA CDC0F0          17      CALL    FATSETUP
001FC4 F0BD 30F0            12      JR  NC,DWT24B
001FC6 F0BF C9              10      RET
                                ;   CALL    NC,DWT24B   ;予備FATの保存ルーチン
                                ;   RET C
                                ;   BIT 7,(IX+DPB_BPS)
                                ;   RET Z       ;予備FATが無い
                                ;   CALL    FATS2
                                ;   PUSH    HL      ;予備FAT
                                ;   LD  L,(IX+DPB_FATLN)
                                ;   LD  H,(IX+DPB_FATLN+1)
                                ;   ADD HL,DE
                                ;   EX  DE,HL
                                ;   POP HL
                                ;   JR  DWT24B
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       F0C0                     FATSETUP:
001FC7 F0C0 3AAAF4          13      LD  A,(_FATDRV)
001FCA F0C3 CDC9F1          17      CALL    CHGDRVR     ;ドライブ切り替え
001FCD F0C6 D8              11      RET C
       F0C7                     FATS2:
001FCE F0C7 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001FD1 F0CA 0F               4      RRCA
001FD2 F0CB CDFBF0          17      CALL    FATSETUP12  ;自己書き換え
       F0CC                     FATSX   EQU $-2
001FD5 F0CE 210000          10      LD  HL,0
001FD8 F0D1 4A               4      LD  C,D
001FD9 F0D2 54               4      LD  D,H
001FDA F0D3 3AABF4          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
001FDD F0D6 47               4      LD  B,A
001FDE F0D7 04               4      INC B
001FDF F0D8 DD7E00          19      LD  A,(IX+DPB_FATLN)
       F0DB                     FAT_SKP:
001FE2 F0DB 05               4      DEC B
001FE3 F0DC 2809            12      JR  Z,FAT1
001FE5 F0DE 19              11      ADD HL,DE
001FE6 F0DF 93               4      SUB E
001FE7 F0E0 30F9            12      JR  NC,FAT_SKP
001FE9 F0E2 DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
001FED F0E6 C8              11      RET Z
       F0E7                     FAT1:
001FEE F0E7 EB               4      EX  DE,HL
001FEF F0E8 B7               4      OR  A       ;0の場合は0100Hとして扱う
001FF0 F0E9 2803            12      JR  Z,FAT3
001FF2 F0EB B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001FF3 F0EC 3801            12      JR  C,FAT2
       F0EE                     FAT3:
001FF5 F0EE 79               4      LD  A,C
       F0EF                     FAT2:
001FF6 F0EF 47               4      LD  B,A
                                
001FF7 F0F0 2AFAF5          16      LD  HL,(_FATPS) ;fat sector pos
001FFA F0F3 19              11      ADD HL,DE
001FFB F0F4 EB               4      EX  DE,HL
001FFC F0F5 2A7CF5          16      LD  HL,(_FATBF)
001FFF F0F8 AF               4      XOR A       ;CF=0
002000 F0F9 4F               4      LD  C,A
002001 F0FA C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       F0FB                     FATSETUP12:
002002 F0FB 110606          10      LD  DE,0606H    ;256
002005 F0FE D8              11      RET C
002006 F0FF 110303          10      LD  DE,0303H    ;512
002009 F102 0F               4      RRCA
00200A F103 D8              11      RET C
00200B F104 110102          10      LD  DE,0201H    ;1024
00200E F107 C9              10      RET
                                
       F108                     FATSETUP16:
00200F F108 110404          10      LD  DE,0404H    ;256
002012 F10B D8              11      RET C
002013 F10C 110202          10      LD  DE,0202H    ;512
002016 F10F 0F               4      RRCA
002017 F110 D8              11      RET C
002018 F111 110101          10      LD  DE,0101H    ;1024
00201B F114 C9              10      RET
                                
       F115                     CHGDRV:
00201C F115 E5              11      PUSH    HL
00201D F116 2189F4          10      LD  HL,_DSK
002020 F119 BE               7      CP  (HL)
002021 F11A 280A            12      JR  Z,CHGDRVE
       F11C                     CHGDRV1:
002023 F11C DDE5            15      PUSH    IX
002025 F11E CD28F1          17      CALL    CHGDRV0
002028 F121 3A89F4          13      LD  A,(_DSK)
00202B F124 DDE1            14      POP IX
       F126                     CHGDRVE:
00202D F126 E1              10      POP HL
00202E F127 C9              10      RET
                                
       F128                     CHGDRV0:
00202F F128 6F               4      LD  L,A
002030 F129 CDDCF4          17      CALL    _GETDPB
002033 F12C D8              11      RET C
002034 F12D DD22A8F4        20      LD  (_DPB),IX
002038 F131 7D               4      LD  A,L
002039 F132 3289F4          13      LD  (_DSK),A
       F135                     CHGDRV2:
00203C F135 C5              11      PUSH    BC
00203D F136 D5              11      PUSH    DE
00203E F137 ED7380F1        20      LD  (SPPAT2),SP
002042 F13B F3               4      DI
002043 F13C DDF9            10      LD  SP,IX
                                
002045 F13E E1              10      POP HL      ;00:DPB_FATLN
002046 F13F E1              10      POP HL      ;02:DPB_DRD
002047 F140 22A6F0          16      LD  (DRDPAT),HL
                                
00204A F143 E1              10      POP HL
00204B F144 22B6F0          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
00204E F147 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
00204F F148 7C               4      LD  A,H
002050 F149 329DE7          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
002053 F14C 3D               4      DEC A
002054 F14D 320FEF          13      LD  (_NCPAT),A
                                
002057 F150 E1              10      POP HL      ;08:DPB_MAXCL
002058 F151 7D               4      LD  A,L
002059 F152 32BCE7          13      LD  (CLPAT2),A
00205C F155 7C               4      LD  A,H
00205D F156 32B8E7          13      LD  (CLPAT1),A
002060 F159 2B               6      DEC HL
002061 F15A 22B9E9          16      LD  (MAXCLP),HL
                                
002064 F15D E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
002065 F15E 4C               4      LD  C,H
                                
002066 F15F E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
002067 F160 E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
002068 F161 7C               4      LD  A,H     ;DPB_BPS
002069 F162 E607             7      AND 7
00206B F164 327EEC          13      LD  (SECSZ+2),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
00206E F167 87               4      ADD A,A     ;8  4   2
00206F F168 87               4      ADD A,A     ;010H   8   4
002070 F169 87               4      ADD A,A     ;020H   010H    8
002071 F16A 321AE6          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
002074 F16D 2600             7      LD  H,0
002076 F16F 22FAF5          16      LD  (_FATPS),HL
                                
002079 F172 E1              10      POP HL      ;10:DPB_DIRPS
00207A F173 22FCF5          16      LD  (_DIRPS),HL
                                
00207D F176 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
00207E F177 7C               4      LD  A,H
00207F F178 3284F4          13      LD  (_DRIVE),A
                                
002082 F17B E1              10      POP HL      ;14:DPB_ADDCL
002083 F17C 22ADE7          16      LD  (CLSPAT),HL
                                
002086 F17F 310000          10      LD  SP,0        ;元のSPを復元
       F180                     SPPAT2  EQU $-2
002089 F182 FB               4      EI
00208A F183 2AFCF5          16      LD  HL,(_DIRPS)
00208D F186 0600             7      LD  B,0
00208F F188 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
002090 F189 2235E6          16      LD  (MD_PAT),HL
                                
002093 F18C 2AB9E9          16      LD  HL,(MAXCLP)
002096 F18F 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
002099 F192 19              11      ADD HL,DE
00209A F193 380F            12      JR  C,SETFAT16
00209C F195 2195EE          10      LD  HL,GNCL     ;FAT12
00209F F198 11B8EE          10      LD  DE,SNCL
0020A2 F19B 01FBF0          10      LD  BC,FATSETUP12
0020A5 F19E DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
0020A9 F1A2 180D            12      JR  EXTRA1
       F1A4                     SETFAT16:
0020AB F1A4 21ECEE          10      LD  HL,GNCL16   ;FAT16
0020AE F1A7 11F9EE          10      LD  DE,SNCL16
0020B1 F1AA 0108F1          10      LD  BC,FATSETUP16
0020B4 F1AD DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       F1B1                     EXTRA1:
0020B8 F1B1 22F8F4          16      LD  (GNCPAT),HL
0020BB F1B4 ED53FBF4        20      LD  (SNCPAT),DE
0020BF F1B8 ED43CCF0        20      LD  (FATSX),BC
0020C3 F1BC D1              10      POP DE
0020C4 F1BD C1              10      POP BC
0020C5 F1BE AF               4      XOR A
0020C6 F1BF C9              10      RET
                                
       F1C0                     GETDPBD:
0020C7 F1C0 DDE3            23      EX  (SP),IX
0020C9 F1C2 DDE5            15      PUSH    IX
0020CB F1C4 3A88F4          13      LD  A,(_DRV)
0020CE F1C7 1807            12      JR  GETDPB1
                                
       F1C9                     CHGDRVR:
0020D0 F1C9 CDD9F4          17      CALL    _CHGDRV
0020D3 F1CC D8              11      RET C
0020D4 F1CD 3A89F4          13      LD  A,(_DSK)
       F1D0                     GETDPB1:
0020D7 F1D0 C3DCF4          10      JP  _GETDPB
                                
       F1D3                     GETDPB:
0020DA F1D3 FE08             7      CP  8
0020DC F1D5 3F               4      CCF
0020DD F1D6 D8              11      RET C
0020DE F1D7 0F               4      RRCA
0020DF F1D8 0F               4      RRCA
0020E0 F1D9 0F               4      RRCA
0020E1 F1DA DD                      DB  0DDH        ;Z80未定義命令
0020E2 F1DB 6F               4      LD  L,A     ;LD IXL,A
0020E3 F1DC DD                      DB  0DDH        ;Z80未定義命令
0020E4 F1DD 26F6             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
0020E6 F1DF DD7E00          19      LD  A,(IX+DPB_FATLN)
0020E9 F1E2 A7               4      AND A       ;CF=0の為
0020EA F1E3 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
0020EE F1E7 C0              11      RET NZ      ;FAT16
0020EF F1E8 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
0020F3 F1EC C0              11      RET NZ      ;BPB
0020F4 F1ED FE01             7      CP  001H        ;A=0 THEN CF=1
0020F6 F1EF C9              10      RET
                                
       F1F0                     _SYS5F:
0020F7 F1F0 AF               4      XOR A
       F1F1                     FFLUSH:
0020F8 F1F1 F5              11      PUSH    AF
0020F9 F1F2 CD16EE          17      CALL    WTFATX
0020FC F1F5 AF               4      XOR A
0020FD F1F6 32ABF4          13      LD  (_FATIX),A
002100 F1F9 2F               4      CPL         ;0FFH
002101 F1FA 32AAF4          13      LD  (_FATDRV),A
002104 F1FD 3E                      DB  03EH        ;次のPUSH AFをスキップ
       F1FE                     FFLUSHBUF:
002105 F1FE F5              11      PUSH    AF
002106 F1FF CDCCED          17      CALL    DWTX
002109 F202 3EFF             7      LD  A,0FFH
00210B F204 3239F4          13      LD  (SFILE),A
00210E F207 32A5F4          13      LD  (_DBDRV),A
002111 F20A F1              10      POP AF
002112 F20B C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "X1DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   X1/turbo/Z
                                
       F20C                     SEEK:
002113 F20C 0610             7      LD  B,16
002115 F20E DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
002118 F211 AF               4      XOR A
002119 F212 EB               4      EX  DE,HL
       F213                     DIV1:
00211A F213 29              11      ADD HL,HL
00211B F214 8F               4      ADC A,A
00211C F215 B9               4      CP  C
00211D F216 3802            12      JR  C,DIV2
00211F F218 91               4      SUB C
002120 F219 2C               4      INC L
       F21A                     DIV2:
002121 F21A 10F7            13      DJNZ    DIV1
                                
002123 F21C 3C               4      INC A   ;最小のセクタは１固定
002124 F21D 55               4      LD  D,L ;TRACK
002125 F21E 5F               4      LD  E,A ;SECTOR
002126 F21F CB3A             8      SRL D   ;CYLINDER
002128 F221 9F               4      SBC A,A
002129 F222 E610             7      AND 010H    ;SIDE
00212B F224 4F               4      LD  C,A
                                
00212C F225 3A84F4          13      LD  A,(_DRIVE)
00212F F228 E603             7      AND 3
002131 F22A B1               4      OR  C
002132 F22B 3284F4          13      LD  (_DRIVE),A  ;サイド選択とドライブを保存
002135 F22E 01FC0F          10      LD  BC,00FFCH   ;モーター制御、サイド選択、 ドライブ選択
002138 F231 F680             7      OR  080H        ;Motor on
00213A F233 ED79            12      OUT (C),A
                                
00213C F235 CD7CF2          17      CALL    SETMODE
00213F F238 D8              11      RET C
                                
002140 F239 CDC6F2          17      CALL    DRIVE
002143 F23C FEFF             7      CP  0FFH        ;A=0FFH Unknown CYLINDER
002145 F23E CCA1F2          17      CALL    Z,FDCRES    ;Restore
002148 F241 0EF9             7      LD  C,0F9H      ;MB8877A トラックレジスタ
00214A F243 ED79            12      OUT (C),A       ;Currrent CYLINDER
00214C F245 92               4      SUB D
00214D F246 C8              11      RET Z       ;No seek シークの必要なし
                                
00214E F247 3A86F4          13      LD  A,(_ISEEK)
002151 F24A 4F               4      LD  C,A
                                
002152 F24B DD7E0C          19      LD  A,(IX+DPB_MAXCYL)
002155 F24E 3D               4      DEC A
002156 F24F BA               4      CP  D       ;Over CYLINDER
002157 F250 D8              11      RET C
                                
002158 F251 B9               4      CP  C
002159 F252 3809            12      JR  C,SETM2     ;2D
00215B F254 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
00215F F258 2803            12      JR  Z,SETM2     ;2HD
002161 F25A 78               4      LD  A,B     ;2DD
002162 F25B DBFE            11      IN  A,(0FEH)    ;1.6M(2HD) タイプ指定 (turbo/Z/CZ-8BF1のみ)
       F25D                     SETM2:
002164 F25D 0EFB             7      LD  C,0FBH      ;MB8877A データレジスタ
002166 F25F ED51            12      OUT (C),D
002168 F261 72               7      LD  (HL),D
002169 F262 0E18             7      LD  C,018H      ;FDC TypeIコマンド Seek
       F264                     FDCCMD2:
00216B F264 3A85F4          13      LD  A,(_SEEKSP)
00216E F267 B1               4      OR  C
                                
       F268                     FDCCMD:
00216F F268 CDBCF2          17      CALL    COMSET
                                
002172 F26B 3E80             7      LD  A,080H      ;FDC COMMAND(Self-modifying code)
       F26C                     FDCSWC  EQU $-1
002174 F26D E620             7      AND 020H        ;Write data Write track
002176 F26F 3C               4      INC A
                                
       F270                     SST:
002177 F270 0E00             7      LD  C,0
       F272                     SST1:
002179 F272 0D               4      DEC C       ; 4
00217A F273 20FD            12      JR  NZ,SST1     ;12 * 256 / 4 = About 1ms
00217C F275 3D               4      DEC A
00217D F276 20FA            12      JR  NZ,SST1
                                
00217F F278 3C               4      INC A       ;A=1
002180 F279 CD89F2          17      CALL    READY
       F27C                     SETMODE:
002183 F27C DD4E0A          19      LD  C,(IX+DPB_FDMODE)   ;フロッピーディスクのモード
002186 F27F ED78            12      IN  A,(C)
                                
002188 F281 78               4      LD  A,B
002189 F282 DBFD            11      IN  A,(0FDH)    ;MFM 方式指定
                                
00218B F284 CDC0F2          17      CALL    DELAY0      ;Head select time
00218E F287 3E81             7      LD  A,081H      ;NOT READY,BUSY
       F289                     READY:
002190 F289 E5              11      PUSH    HL
002191 F28A 67               4      LD  H,A
002192 F28B 0EF8             7      LD  C,0F8H      ;MB8877A ステータス／コマンドレジスタ
002194 F28D 69               4      LD  L,C
       F28E                     READY2:
002195 F28E ED78            12      IN  A,(C)
002197 F290 A4               4      AND H
002198 F291 280C            12      JR  Z,READYE
00219A F293 3E1A             7      LD  A,1AH
00219C F295 DB01            11      IN  A,(01H)
00219E F297 07               4      RLCA
00219F F298 AD               4      XOR L
0021A0 F299 0F               4      RRCA
0021A1 F29A 30F2            12      JR  NC,READY2
0021A3 F29C 2D               4      DEC L
0021A4 F29D 20EF            12      JR  NZ,READY2
       F29F                     READYE:
0021A6 F29F E1              10      POP HL
0021A7 F2A0 C9              10      RET
                                
       F2A1                     FDCRES:
0021A8 F2A1 3600            10      LD  (HL),0
0021AA F2A3 0E08             7      LD  C,8
0021AC F2A5 18BD            12      JR  FDCCMD2
                                
       F2A7                     FDMOFF:
0021AE F2A7 F5              11      PUSH    AF
0021AF F2A8 C5              11      PUSH    BC      ;Motor off
0021B0 F2A9 01FC0F          10      LD  BC,00FFCH   ;モーター制御、サイド選択、 ドライブ選択
0021B3 F2AC 3A84F4          13      LD  A,(_DRIVE)
0021B6 F2AF ED79            12      OUT (C),A
0021B8 F2B1 C1              10      POP BC
0021B9 F2B2 F1              10      POP AF
0021BA F2B3 C9              10      RET
                                
       F2B4                     SECSET_FDCCMD:
0021BB F2B4 3A6CF2          13      LD  A,(FDCSWC)
       F2B7                     SECSET:
0021BE F2B7 01FA0F          10      LD  BC,00FFAH   ;MB8877A セレクタレジスタ
0021C1 F2BA ED59            12      OUT (C),E
       F2BC                     COMSET:
0021C3 F2BC 0EF8             7      LD  C,0F8H      ;MB8877A ステータス／コマンドレジスタ
0021C5 F2BE ED79            12      OUT (C),A
       F2C0                     DELAY0:
0021C7 F2C0 3E1A             7      LD  A,26
       F2C2                     DELAY:
0021C9 F2C2 3D               4      DEC A
0021CA F2C3 20FD            12      JR  NZ,DELAY
0021CC F2C5 C9              10      RET
                                
       F2C6                     DRIVE:
0021CD F2C6 DD6E13          19      LD  L,(IX+DPB_UNITNO)
0021D0 F2C9 26F4             7      LD  H,_CYL0/256
0021D2 F2CB CBFD             8      SET 7,L
0021D4 F2CD 7E               7      LD  A,(HL)
0021D5 F2CE C9              10      RET
                                
       F2CF                     RNF:
0021D6 F2CF CDC6F2          17      CALL    DRIVE
0021D9 F2D2 36FF            10      LD  (HL),0FFH
0021DB F2D4 C9              10      RET
                                
0021DC F2D5 02                  RETRY:  DB  2
                                
                                
                                ;   FLOPPY DISK DRIVER(DMA)
                                
                                
       F2D6                     WTTRK:
0021DD F2D6 0601             7      LD  B,1
0021DF F2D8 3EF4             7      LD  A,0F4H      ;FDC TypeIIIコマンド Write Track
0021E1 F2DA 1802            12      JR  WTTRK1
       F2DC                     FDWT:
0021E3 F2DC 3EA0             7      LD  A,0A0H      ;FDC TypeIIコマンド Write Sector
       F2DE                     WTTRK1:
0021E5 F2DE 326CF2          13      LD  (FDCSWC),A
0021E8 F2E1 3E10             7      LD  A,DMA_WRITE-DMAD
0021EA F2E3 180C            12      JR  DISK
                                
       F2E5                     DISKOK:
0021EC F2E5 0601             7      LD  B,1
       F2E6                     FDCNT   EQU $-1
0021EE F2E7 100B            13      DJNZ    DISK1
0021F0 F2E9 C9              10      RET
                                
       F2EA                     FDRD:
0021F1 F2EA 3E80             7      LD  A,080H      ;FDC TypeIIコマンド Read Sector
0021F3 F2EC 326CF2          13      LD  (FDCSWC),A
0021F6 F2EF 3E0E             7      LD  A,DMA_READ-DMAD
                                
       F2F1                     DISK:
0021F8 F2F1 3208F3          13      LD  (DMASWC),A
       F2F4                     DISK1:
0021FB F2F4 78               4      LD  A,B
0021FC F2F5 32E6F2          13      LD  (FDCNT),A
0021FF F2F8 225DF3          16      LD  (DMAHL),HL
       F2FB                     DISKR:
002202 F2FB 3E02             7      LD  A,2     ;Retry count
002204 F2FD 32D5F2          13      LD  (RETRY),A
       F300                     DISK2:
002207 F300 D5              11      PUSH    DE
002208 F301 CD0CF2          17      CALL    SEEK
00220B F304 3840            12      JR  C,ERRF
00220D F306 F3               4      DI
                                
00220E F307 3E0E             7      LD  A,14        ;自己書き換え
       F308                     DMASWC  EQU $-1
002210 F309 2152F3          10      LD  HL,DMAD
002213 F30C CDAFE3          17      CALL    SETDMA
002216 F30F ED49            12      OUT (C),C       ;OUT 01F87H,087H WR6 イネーブル
002218 F311 C5              11      PUSH    BC
002219 F312 CDB4F2          17      CALL    SECSET_FDCCMD
00221C F315 2A5DF3          16      LD  HL,(DMAHL)
00221F F318 23               6      INC HL
002220 F319 1106BB          10      LD  DE,0BB06H   ;READ DMA
                                
002223 F31C 3E03             7      LD  A,3
002225 F31E CD89F2          17      CALL    READY
002228 F321 ED78            12      IN  A,(C)
                                
00222A F323 C1              10      POP BC
00222B F324 ED51            12      OUT (C),D       ;読み出しマスク設定
00222D F326 ED59            12      OUT (C),E       ;バイトカウンタ(LH)
00222F F328 ED58            12      IN  E,(C)
002231 F32A ED50            12      IN  D,(C)
002233 F32C 19              11      ADD HL,DE
002234 F32D D1              10      POP DE
002235 F32E 13               6      INC DE
002236 F32F FB               4      EI
002237 F330 CDA7F2          17      CALL    FDMOFF
00223A F333 B7               4      OR  A
00223B F334 28AF            12      JR  Z,DISKOK
00223D F336 1B               6      DEC DE
00223E F337 CB67             8      BIT 4,A
002240 F339 C4CFF2          17      CALL    NZ,RNF
       F33C                     DISKE2:
002243 F33C 21D5F2          10      LD  HL,RETRY
002246 F33F 35              11      DEC (HL)
002247 F340 20BE            12      JR  NZ,DISK2
002249 F342 B7               4      OR  A
00224A F343 280A            12      JR  Z,ERR
00224C F345 D5              11      PUSH    DE
       F346                     ERRF:
00224D F346 D1              10      POP DE
       F347                     DELP:
00224E F347 CDCFF2          17      CALL    RNF
002251 F34A CDA7F2          17      CALL    FDMOFF
002254 F34D 3EFF             7      LD  A,0FFH
       F34F                     ERR:
002256 F34F BF               4      CP  A
002257 F350 37               4      SCF
002258 F351 C9              10      RET
                                
       F352                     DMAD:           ;X1turbo DISK DMA
002259 F352 C3                      DB  0C3H    ;WR6 リセット
00225A F353 7D                      DB  07DH    ;WR0 ポートA→ポートB 転送
00225B F354 FB0F                    DW  00FFBH  ;ポートA開始アドレス (FDC MB8877A データレジスタ)
00225D F356 FFFF                    DW  0FFFFH  ;ブロック長(転送サイズ-1)
00225F F358 2C                      DB  02CH    ;WR1 ポートAアドレス固定 I/O
002260 F359 10                      DB  010H    ;WR2 ポートBインクリメント
002261 F35A 80                      DB  080H    ;WR3
002262 F35B 92                      DB  092H    ;WR5 WAIT RDY:LOW
002263 F35C 8D                      DB  08DH    ;WR4 バイト ポートB開始アドレス(LH)
002264 F35D 0000                DMAHL:  DW  0   ;ポートB開始アドレス
002266 F35F CF                      DB  0CFH    ;WR6 ロード
       F360                     DMA_READ:
002267 F360 01                      DB  001H    ;WR0 ポートB←ポートB 転送  （書き込みの際に転送方向を逆にする）
002268 F361 CF                      DB  0CFH    ;WR6 ロード
       F362                     DMA_WRITE:
       F362                     DMAE:
                                
       1D32                     AT_R    EQU WTTRK-AT_DWT
       F362                     AT_TABLE:
[EOF:X1DISK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
002269 F362                     PATHD:  DS  PATHX
0022A4 F39D 00                  PATHE:  DB  0
                                
       F39E                     DTA_CCP:
0022A5 F39E                         DS  37
                                
       F3C3                     FCB_BAT:
0022CA F3C3                         DS  37
                                
0022EF F3E8 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
0022FA F3F3 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
       F3FA                     AT_WORK:
002301 F3FA                         DS  WORKAD-AT_WORK
                                
       F400                     CPM_BOOT:
002307 F400 C30000          10      JP  0
       F403                     _SYS00:     ;(BDOS)プログラム終了
       F403                     CPM_WBOOT:
00230A F403 C309D7          10      JP  WBOOT1
       F406                     CPM_CONST:
00230D F406 C35DE0          10      JP  CONSTX
       F409                     _SYS07:     ;(BDOS)コンソール直接入力
       F409                     CPM_CONIN:
002310 F409 C3D2DF          10      JP  FLGET
       F40C                     CPM_CONOUT:
002313 F40C C3A2E2          10      JP  CONOUT1
                                
       F40F                     DECBF:              ;10進数表示時のバッファ(5バイト)
002316 F40F                         DS  5
       F40F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       F411                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
00231B F414 00                  FDRV:   DB  0
00231C F415                     FNAME:  DS  36
002340 F439                     SFILE:  DS  33      ;DRV FILENAME
                                
002361 F45A                         DS  3
                                
002364 F45D 0000                LEFTX:  DW  0
002366 F45F 0000                DTAX:   DW  0
                                
       F461                     ZERO:
       F461                     BEEPD:
002368 F461 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
002370 F469 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
       F462                     RTC_YY  EQU BEEPD+1
       F463                     RTC_MW  EQU BEEPD+2
       F464                     RTC_DD  EQU BEEPD+3
       F465                     RTC_TT  EQU BEEPD+4
       F466                     RTC_MM  EQU BEEPD+5
       F467                     RTC_SS  EQU BEEPD+6
       F462                     ROM_SLT EQU BEEPD+1
                                
002377 F470 00                  CHECK:  DB  0
                                
002378 F471 4F4B24              OK: DB  "OK$"
00237B F474                         DS  5
002380 F479 4572726F722124      COMERM: DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
002387 F480 FF                  _CYL0:  DB  0FFH    ;Cylinder
002388 F481 FF                  _CYL1:  DB  0FFH    ;Cylinder
002389 F482 FF                  _CYL2:  DB  0FFH    ;Cylinder
00238A F483 FF                  _CYL3:  DB  0FFH    ;Cylinder
00238B F484 00                  _DRIVE: DB  0   ;unit number
       F485                     _SEEKSP:
00238C F485 00                      DB  0   ;Seek speed
00238D F486 32                  _ISEEK: DB  50  ;
00238E F487                         DS  1
00238F F488 00                  _DRV:   DB  0
002390 F489 FF                  _DSK:   DB  0FFH
002391 F48A 8000                _DTA:   DW  00080H
002393 F48C 0000                _CTC:   DW  0
002395 F48E 0000                _TXADR: DW  0
002397 F490 0000                _KEYPS: DW  0
002399 F492 00FF                _KEYD:  DW  0FF00H  ;キーデータ
00239B F494 C210                _KEYSP: DB  KEYSP_L,KEYSP_H ;オートリピートの速度
       F496                     _COLORF:
00239D F496 07                      DB  COLORF  ;色
00239E F497 18                  _LINE:  DB  LINE
                                
00239F F498 0000                _FCB:   DW  0   ;SEARCH FILES
0023A1 F49A 0000                _FBPS:  DW  0   ;    //
0023A3 F49C 0000                _FBAD:  DW  0   ;    //
0023A5 F49E 00                  _FBCNT: DB  0   ;    //
0023A6 F49F 00                  _FILEN: DB  0   ;    //
0023A7 F4A0 00                  _DIRF:  DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
0023A8 F4A1                         DS  1
       F4A2                     _WTFATF:
0023A9 F4A2 00                      DB  0   ;FATバッファの更新フラグ
0023AA F4A3                         DS  1
0023AB F4A4 00                  _WTDBF: DB  0   ;データバッファの更新フラグ
0023AC F4A5 FF                  _DBDRV: DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
0023AD F4A6 0000                _DBSEC: DW  0   ;データバッファにあるデータを読み込んだセクタ番号
0023AF F4A8 0000                _DPB:   DW  0
       F4AA                     _FATDRV:
0023B1 F4AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
0023B2 F4AB 00                  _FATIX: DB  0   ;FATバッファに読み込んでいるインデックス
       F4AC                     _FAKEFREE:
0023B3 F4AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
0023B5 F4AE                         DS  2
                                
       F4B0                     CRTCD:
0023B7 F4B0 6F                      DB  06FH
       F4B1                     _WIDTH:
0023B8 F4B1 50                      DB  WIDTH
       F4B2                     TVRAMTOP:
0023B9 F4B2 5938                    DB  059H,038H
0023BB F4B4 1F02                    DB  01FH,002H
       F4B6                     _LINE2:
0023BD F4B6 19                      DB  019H
       F4B7                     WKE4:
0023BE F4B7 1C                      DB  01CH
       F4B8                     WKE6:
0023BF F4B8 00                      DB  000H
       F4B9                     WK40:
0023C0 F4B9 07                      DB  007H
       F4BA                     _PAGE_MINUS:
0023C1 F4BA 80F8                    DW  0-WIDTH*LINE
       F4BC                     _WIDTH_MINUS:
0023C3 F4BC B0FF                    DW  0-WIDTH
       F4BE                     WK30:
0023C5 F4BE 0C                      DB  00CH
       F4BF                     WK31:
       F4BF                     WK1FD0:
0023C6 F4BF 20                      DB  020H
                                
0023C7 F4C0 62DF                CTC0:   DW  INTCTCE
0023C9 F4C2 62DF                CTC1:   DW  INTCTCE
0023CB F4C4 62DF                CTC2:   DW  INTCTCE
0023CD F4C6 62DF                CTC3:   DW  INTCTCE
0023CF F4C8 4EDF                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
0023D1 F4CA C385E4          10  _INKEY: JP  INKEY
0023D4 F4CD C33DE1          10  _PRINT: JP  PRINT
0023D7 F4D0 C3EDE3          10  _SCRN:  JP  SCRN
0023DA F4D3 C317E4          10  _POS:   JP  POS
0023DD F4D6 C36BE2          10  _LOC:   JP  LOC
       F4D9                     _CHGDRV:
0023E0 F4D9 C315F1          10      JP  CHGDRV
       F4DC                     _GETDPB:
0023E3 F4DC C3D3F1          10      JP  GETDPB
       F4DF                     _FFLUSH:
0023E6 F4DF C3F1F1          10      JP  FFLUSH
       F4E2                     _RDFATX:
0023E9 F4E2 C3ECED          10      JP  RDFATX
0023EC F4E5 C31BEF          10  _RDFAT: JP  RDFAT
0023EF F4E8 C3D6F2          10  _WTTRK: JP  WTTRK
0023F2 F4EB C3EAF2          10  _FDRD:  JP  FDRD
0023F5 F4EE C3DCF2          10  _FDWT:  JP  FDWT
       F4F1                     _BPB2DPB:
0023F8 F4F1 C3B1EF          10      JP  BPB2DPB
       F4F4                     _BREAK:
0023FB F4F4 C3C3D8          10      JP  END_BATCH
       F4F7                     _GNCL:
0023FE F4F7 C395EE          10      JP  GNCL        ; self-modifying code
       F4F8                     GNCPAT  EQU $-2
       F4FA                     _SNCL:
002401 F4FA C3B8EE          10      JP  SNCL        ; self-modifying code
       F4FB                     SNCPAT  EQU $-2
       F4FD                     _COMANL:
002404 F4FD C37CD7          10      JP  COMANL
                                
       F500                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F500                     STABLE:
                                ;0
002407 F500 03F4A5DFB1DF47E6        DW  _SYS00,_SYS01,_SYS02,_SYS03
00240F F508 95DC95DCB6DF09F4        DW  _SYS04,_SYS05,_SYS06,_SYS07
002417 F510 BEDF97DC29E055E0        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
00241F F518 ACDCB1DCC0DCD1DC        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
002427 F520 25DD6CDDB5DDE6DD        DW  _SYS10,_SYS11,_SYS12,_SYS13
00242F F528 EEDD04DE19DE11DE        DW  _SYS14,_SYS15,_SYS16,_SYS17
002437 F530 60DE65DE6ADE70DE        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
00243F F538 95DC96DE95DC9ADE        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
002447 F540 95DC50DE58DEA1DE        DW  _SYS20,_SYS21,_SYS22,_SYS23
00244F F548 C7DE95DC9CEA74EB        DW  _SYS24,_ERROR,_SYS26,_SYS27
002457 F550 58DED1DE6BE047E6        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
00245F F558 8EE047E695DCF2DE        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
002467 F560 ECDE95DC95DC95DC        DW  _SYS30,_ERROR,_ERROR,_ERROR
00246F F568 95DC95DC95DC95DC        DW  _ERROR,_ERROR,_ERROR,_ERROR
002477 F570 95DC47E647E613DF        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
00247F F578 78DC                    DW  _DOS2
                                
002481 F57A                         DS  1
       F57B                     _MAX_SEC_SZ_H:
002482 F57B 02                      DB  MAX_SEC_SZ_H
       F57C                     _FATBF:
002483 F57C 00F7                    DW  FATBF
       F57E                     _DTBUF:
002485 F57E 00FD                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F580                     CTRLTB:
002487 F580 E0E1E0E11CE261E3        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
00248F F588 5BE340E23AE3C3E2        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002497 F590 ECE10DE264E381E2        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
00249F F598 37E366E279E3E0E1        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
0024A7 F5A0 E0E1E0E179E2E0E1        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
0024AF F5A8 E0E1E0E1E0E1E0E1        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
0024B7 F5B0 E0E1E0E137E388E2        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
0024BF F5B8 07E2F3E1FCE164E3        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
0024C7 F5C0 0200                M2D:    DW  2
0024C9 F5C2 FD02                    DB  0FDH,2
0024CB F5C4 6401                    DW  356
0024CD F5C6 FF0728090182            DB  0FFH,7,40,9,1,082H
0024D3 F5CC 0500A7000800            DW  5,0A7H,8
                                
0024D9 F5D2 0200                M2HD:   DW  2
0024DB F5D4 FE01                    DB  0FEH,1
0024DD F5D6 C704                    DW  1223
0024DF F5D8 FE064D080184            DB  0FEH,6,77,8,1,084H
0024E5 F5DE 0500A7000900            DW  5,0A7H,9
                                
0024EB F5E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
0024ED F5E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
0024EF F5E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
0024F1 F5EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F5EE                     SDDATAE:
                                
0024F5 F5EE                         DS  2
       F5F0                     _FCB_BAT:
0024F7 F5F0 C3F3                    DW  FCB_BAT
       F5F2                     _PATH:
0024F9 F5F2 62F3                    DW  PATHD
                                
0024FB F5F4                     SCDIR:  DS  2       ;+14 +15
0024FD F5F6                     SFBPS:  DS  2       ;FBPS
0024FF F5F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
002501 F5FA 0000                _FATPS: DW  0
002503 F5FC 0000                _DIRPS: DW  0
002505 F5FE 0000                _CLPS:  DW  0
                                
       F600                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "X1DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   X1/turbo/Z
                                
       F600                     _DEVICE:
                                
                                ;   A:
                                
002507 F600 0200                    DW  2   ;DPB_FATLN
002509 F602 EBF4                    DW  _FDRD   ;DPB_DRD
00250B F604 EEF4                    DW  _FDWT   ;DPB_DWT
00250D F606 FD                      DB  0FDH    ;DPB_FATID
00250E F607 02                      DB  2   ;DPB_SECPCL
00250F F608 6401                    DW  356 ;DPB_MAXCL
002511 F60A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002512 F60B 07                      DB  7   ;DPB_DIRSCNT
002513 F60C 28                      DB  40  ;DPB_MAXCYL
002514 F60D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002515 F60E 01                      DB  1   ;DPB_FATPS
002516 F60F 82                      DB  082H    ;DPB_BPS
002517 F610 0500                    DW  5   ;DPB_DIRPS
002519 F612 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00251A F613 00                      DB  0   ;DPB_UNITNO
00251B F614 0800                    DW  8   ;DPB_ADDCL
00251D F616 0000                    DW  0   ;DPB_16
00251F F618 0000                    DW  0   ;DPB_18
002521 F61A 0000                    DW  0   ;DPB_SDIR
002523 F61C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002527 F620 0200                    DW  2   ;DPB_FATLN
002529 F622 EBF4                    DW  _FDRD   ;DPB_DRD
00252B F624 EEF4                    DW  _FDWT   ;DPB_DWT
00252D F626 FD                      DB  0FDH    ;DPB_FATID
00252E F627 02                      DB  2   ;DPB_SECPCL
00252F F628 6401                    DW  356 ;DPB_MAXCL
002531 F62A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002532 F62B 07                      DB  7   ;DPB_DIRSCNT
002533 F62C 28                      DB  40  ;DPB_MAXCYL
002534 F62D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002535 F62E 01                      DB  1   ;DPB_FATPS
002536 F62F 82                      DB  082H    ;DPB_BPS
002537 F630 0500                    DW  5   ;DPB_DIRPS
002539 F632 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00253A F633 01                      DB  1   ;DPB_UNITNO
00253B F634 0800                    DW  8   ;DPB_ADDCL
00253D F636 0000                    DW  0   ;DPB_16
00253F F638 0000                    DW  0   ;DPB_18
002541 F63A 0000                    DW  0   ;DPB_SDIR
002543 F63C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002547 F640 0200                    DW  2   ;DPB_FATLN
002549 F642 EBF4                    DW  _FDRD   ;DPB_DRD
00254B F644 EEF4                    DW  _FDWT   ;DPB_DWT
00254D F646 FD                      DB  0FDH    ;DPB_FATID
00254E F647 02                      DB  2   ;DPB_SECPCL
00254F F648 6401                    DW  356 ;DPB_MAXCL
002551 F64A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002552 F64B 07                      DB  7   ;DPB_DIRSCNT
002553 F64C 28                      DB  40  ;DPB_MAXCYL
002554 F64D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002555 F64E 01                      DB  1   ;DPB_FATPS
002556 F64F 82                      DB  082H    ;DPB_BPS
002557 F650 0500                    DW  5   ;DPB_DIRPS
002559 F652 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00255A F653 02                      DB  2   ;DPB_UNITNO
00255B F654 0800                    DW  8   ;DPB_ADDCL
00255D F656 0000                    DW  0   ;DPB_16
00255F F658 0000                    DW  0   ;DPB_18
002561 F65A 0000                    DW  0   ;DPB_SDIR
002563 F65C 46444432                DB  "FDD2"  ;DPB_NAME
                                
                                ;   D:
                                
002567 F660 0200                    DW  2   ;DPB_FATLN
002569 F662 EBF4                    DW  _FDRD   ;DPB_DRD
00256B F664 EEF4                    DW  _FDWT   ;DPB_DWT
00256D F666 FD                      DB  0FDH    ;DPB_FATID
00256E F667 02                      DB  2   ;DPB_SECPCL
00256F F668 6401                    DW  356 ;DPB_MAXCL
002571 F66A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002572 F66B 07                      DB  7   ;DPB_DIRSCNT
002573 F66C 28                      DB  40  ;DPB_MAXCYL
002574 F66D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002575 F66E 01                      DB  1   ;DPB_FATPS
002576 F66F 82                      DB  082H    ;DPB_BPS
002577 F670 0500                    DW  5   ;DPB_DIRPS
002579 F672 A7                      DB  0A7H    ;DPB_DEVICE
00257A F673 03                      DB  3   ;DPB_UNITNO
00257B F674 0800                    DW  8   ;DPB_ADDCL
00257D F676 0000                    DW  0   ;DPB_16
00257F F678 0000                    DW  0   ;DPB_18
002581 F67A 0000                    DW  0   ;DPB_SDIR
002583 F67C 46444433                DB  "FDD3"  ;DPB_NAME
                                
                                ;   E:
                                
002587 F680 0000                EMMFL:  DW  0   ;DPB_FATLN
002589 F682 34DC                EMMRD:  DW  EDRD    ;DPB_DRD
00258B F684 20DC                EMMWR:  DW  EDWT    ;DPB_DWT
00258D F686 FE                      DB  0FEH    ;DPB_FATID
00258E F687 02                      DB  2   ;DPB_SECPCL
00258F F688 0000                EMMCL:  DW  0   ;DPB_MAXCL
002591 F68A 00                      DB  0   ;DPB_FDMODE
002592 F68B 0C                      DB  12  ;DPB_DIRSCNT
002593 F68C 00                      DB  0   ;DPB_MAXCYL
002594 F68D 00                      DB  0   ;DPB_MAXSEC
002595 F68E 02                      DB  2   ;DPB_FATPS
002596 F68F 02                      DB  2   ;DPB_BPS
002597 F690 0A00                    DW  10  ;DPB_DIRPS
002599 F692 06                      DB  6   ;DPB_DEVICE
00259A F693 00                      DB  0   ;DPB_UNITNO
00259B F694 1200                    DW  18  ;DPB_ADDCL
00259D F696 0000                    DW  0   ;DPB_16
00259F F698 0000                    DW  0   ;DPB_18
0025A1 F69A 0000                    DW  0   ;DPB_SDIR
0025A3 F69C 454D4D30                DB  "EMM0"  ;DPB_NAME
                                
                                ;   F:
                                
0025A7 F6A0 0000                BANKFL: DW  0   ;DPB_FATLN
0025A9 F6A2 B8DB                    DW  BDRD    ;DPB_DRD
0025AB F6A4 B4DB                    DW  BDWT    ;DPB_DWT
0025AD F6A6 F9                      DB  0F9H    ;DPB_FATID
0025AE F6A7 02                      DB  2   ;DPB_SECPCL
0025AF F6A8 0000                BANKCL: DW  0   ;DPB_MAXCL
0025B1 F6AA 00                      DB  0   ;DPB_FDMODE
0025B2 F6AB 08                      DB  8   ;DPB_DIRSCNT
0025B3 F6AC 00                      DB  0   ;DPB_MAXCYL
0025B4 F6AD 01                      DB  1   ;DPB_MAXSEC
0025B5 F6AE 00                      DB  0   ;DPB_FATPS
0025B6 F6AF 02                      DB  2   ;DPB_BPS
0025B7 F6B0 0200                    DW  2   ;DPB_DIRPS
0025B9 F6B2 0B                  BANKDV: DB  00BH    ;DPB_DEVICE
0025BA F6B3 00                      DB  0   ;DPB_UNITNO
0025BB F6B4 0600                    DW  6   ;DPB_ADDCL
0025BD F6B6 0000                    DW  0   ;DPB_16
0025BF F6B8 0000                    DW  0   ;DPB_18
0025C1 F6BA 0000                    DW  0   ;DPB_SDIR
0025C3 F6BC 4252414D                DB  "BRAM"  ;DPB_NAME
                                
                                ;   G:
                                
0025C7 F6C0 0200                    DW  2   ;DPB_FATLN
0025C9 F6C2 75DB                    DW  GDRD    ;DPB_DRD
0025CB F6C4 8CDB                    DW  GDWT    ;DPB_DWT
0025CD F6C6 FA                      DB  0FAH    ;DPB_FATID
0025CE F6C7 01                      DB  1   ;DPB_SECPCL
0025CF F6C8 B800                    DW  184 ;DPB_MAXCL
0025D1 F6CA 00                      DB  0   ;DPB_FDMODE
0025D2 F6CB 07                      DB  7   ;DPB_DIRSCNT
0025D3 F6CC 00                      DB  0   ;DPB_MAXCYL
0025D4 F6CD 01                      DB  1   ;DPB_MAXSEC
0025D5 F6CE 01                      DB  1   ;DPB_FATPS
0025D6 F6CF 01                      DB  1   ;DPB_BPS
0025D7 F6D0 0300                    DW  3   ;DPB_DIRPS
0025D9 F6D2 05                      DB  5   ;DPB_DEVICE
0025DA F6D3 01                      DB  1   ;DPB_UNITNO
0025DB F6D4 0800                    DW  8   ;DPB_ADDCL
0025DD F6D6 0000                    DW  0   ;DPB_16
0025DF F6D8 0000                    DW  0   ;DPB_18
0025E1 F6DA 0000                    DW  0   ;DPB_SDIR
0025E3 F6DC 4752414D                DB  "GRAM"  ;DPB_NAME
                                
                                ;   H:
0025E7 F6E0                         DS  32-8
0025FF F6F8 00                      DB  0
[EOF:X1DPB.ASM:UTF_8]
                                
       F6F9                     LAST_ADR:
                                
                                    END
[EOF:X1.ASZ:UTF_8]
