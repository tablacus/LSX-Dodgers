0000                ;	LSX-Dodgers for X1/turbo/Z
0000                ;	Programmed by
0000                ;	Gaku (Lovers/Tablacus)
0000                
0000                	INCLUDE	"X1DEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                ;	X1/turbo/Z
0000                
0000 00 00 00 00    MAC	EQU	0		;X1
0000 00 00 00 00    DEV	EQU	0
0000                
0000 00 00 01 1D    VER_6F	EQU	0011DH
0000                
0000 00 00 CD 00    RUN	EQU	0CD00H
0000 00 00 D3 06    BDOS	EQU	0D306H
0000 00 00 F0 00    WORKAD	EQU	0F000H
0000 00 00 F3 00    FATBF	EQU	0F300H
0000 00 00 FB 00    DTBUF	EQU	0FB00H
0000 00 00 FF 00    KEYBF	EQU	0FF00H
0000 00 00 FF 20    KBUF	EQU	0FF20H
0000 00 00 FF CA    EXTSP	EQU	0FFCAH
0000 00 00 FF D9    TRAP38	EQU	0FFD9H
0000 00 00 00 50    WIDTH	EQU	80
0000 00 00 00 18    LINE	EQU	24
0000 00 00 00 07    COLORF	EQU	7
0000 00 00 00 10    KEYSP_H	EQU	16
0000 00 00 00 C2    KEYSP_L	EQU	0C2H
0000 00 00 00 08    COMS	EQU	8
0000                
0000                	INCLUDE	"LDDEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                
0000 00 00 00 01    VER_1   EQU	1
0000 00 00 00 05    VER_2   EQU	5
0000 00 00 00 08    VER_3   EQU	8
0000 00 00 1D 00    MACW	EQU	MAC + 01D00H	;機種フラグとLD判別フラグ
0000 00 00 00 00    MACD	EQU	MAC + DEV * 256	;機種フラグとデバイスフラグ
0000 00 00 01 58    VER	EQU	VER_1 * 256 + VER_2 * 16 + VER_3
0000                
0000 00 00 00 05    SYSTEM	EQU	00005H
0000 00 00 00 0F    JP_HL	EQU	0000FH
0000 00 00 00 5C    FCB1	EQU	0005CH
0000 00 00 00 6C    FCB2	EQU	0006CH
0000 00 00 00 5D    FCB1FN	EQU	FCB1+1
0000 00 00 00 6D    FCB2FN	EQU	FCB2+1
0000 00 00 00 80    DTA1	EQU	00080H
0000                
0000 00 00 FF CA    EXTBIO	EQU	0FFCAH
0000                
0000 00 00 00 00    DPB_FATLN	EQU	00H
0000 00 00 00 02    DPB_DRD		EQU	02H
0000 00 00 00 04    DPB_DWT		EQU	04H
0000 00 00 00 06    DPB_FATID	EQU	06H
0000 00 00 00 07    DPB_SECPCL	EQU	07H
0000 00 00 00 08    DPB_MAXCL	EQU	08H
0000 00 00 00 0A    DPB_FDMODE	EQU	0AH
0000 00 00 00 0B    DPB_DIRSCNT	EQU	0BH
0000 00 00 00 0C    DPB_MAXCYL	EQU	0CH
0000 00 00 00 0D    DPB_MAXSEC	EQU	0DH
0000 00 00 00 0E    DPB_FATPS	EQU	0EH
0000 00 00 00 0F    DPB_BPS		EQU	0FH
0000 00 00 00 10    DPB_DIRPS	EQU	10H
0000 00 00 00 12    DPB_DEVICE	EQU	12H
0000 00 00 00 13    DPB_UNITNO	EQU	13H
0000 00 00 00 14    DPB_ADDCL	EQU	14H
0000                
0000 00 00 00 1A    DPB_SDIR	EQU	1AH
0000 00 00 00 1C    DPB_NAME	EQU	1CH
0000                
0000                
0000                	ORG	RUN-7
CCF9                
CCF9                ;	MSX BINARY HEADER
CCF9 FE             	DB	0FEH
CCFA                ;	MSX BINARY START ADDRESS
CCFA 00 CD          	DW	RUN
CCFC                ;	MSX BINARY END ADDRESS
CCFC F9 F2          	DW	LAST_ADR
CCFE                ;	MSX BINARY EXEC ADDRESS
CCFE 07 CD          	DW	START
CD00                
CD00                	INCLUDE	"X1INIT.ASM"
CD00                
CD00                ;	LSX-Dodgers INIT
CD00                ;	X1/turbo/Z
CD00                
CD00 C3 07 CD       	JP	START
CD03 00 1D          	DW	MACW
CD05 58 01          	DW	VER
CD07                
CD07                START:
CD07 F3             	DI
CD08 ED 5E          	IM	2
CD0A 31 CA FF       	LD	SP,EXTSP
CD0D CD 1B CD       	CALL	INIT		;NZならAUTOEXECを実行
CD10 21 00 00       	LD	HL,0
CD13 E5             	PUSH	HL
CD14 C8             	RET	Z
CD15 11 83 D0       	LD	DE,AUTOD
CD18 C3 FD F0       	JP	_COMANL
CD1B                
CD1B                INIT:
CD1B 3E 1E          	LD	A,01EH
CD1D D3 00          	OUT	(0),A
CD1F                
CD1F 01 00 00       	LD	BC,0
CD22 ED 43 8C F0    	LD	(_CTC),BC
CD26 01 04 0A       	LD	BC,00A04H
CD29 CD 2D D0       	CALL	CHKCTC
CD2C 01 04 07       	LD	BC,00704H
CD2F CD 2D D0       	CALL	CHKCTC
CD32 01 A8 1F       	LD	BC,01FA8H
CD35 CD 2D D0       	CALL	CHKCTC
CD38 01 A0 1F       	LD	BC,01FA0H
CD3B CD 2D D0       	CALL	CHKCTC
CD3E                ;
CD3E                INISIO:
CD3E 01 91 1F       	LD	BC,01F91H	;INIT SIO
CD41 16 01          	LD	D,1
CD43 ED 51          	OUT	(C),D
CD45                
CD45 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CD47 0E 93          	LD	C,093H
CD49 ED 51          	OUT	(C),D
CD4B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CD4D 0E 99          	LD	C,099H		;INIT SIO
CD4F 16 01          	LD	D,1
CD51 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CD53 0E 9B          	LD	C,09BH
CD55 ED 51          	OUT	(C),D
CD57 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CD59                
CD59 0E 80          	LD	C,080H		;INIT DMA
CD5B 21 06 C3       	LD	HL,0C306H
CD5E                INIDMA:
CD5E ED 61          	OUT	(C),H
CD60 2D             	DEC	L
CD61 20 FB          	JR	NZ,INIDMA
CD63                
CD63 3E E4          	LD	A,0E4H
CD65 CD F7 DE       	CALL	COMOUT
CD68 AF             	XOR	A
CD69 CD D1 DE       	CALL	OT49SB
CD6C                
CD6C 3E F0          	LD	A,INTVEC/256
CD6E ED 47          	LD	I,A
CD70                
CD70 ED 4B 8C F0    	LD	BC,(_CTC)
CD74 0D             	DEC	C
CD75 0D             	DEC	C
CD76                
CD76 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CD78 3E C0          	LD	A,CTC0-CPM_BOOT
CD7A ED 79          	OUT	(C),A
CD7C                
CD7C 0C             	INC	C
CD7D 3E 47          	LD	A,047H
CD7F ED 79          	OUT	(C),A
CD81 3E 0D          	LD	A,13		;Baudrate 9600-13
CD83 ED 79          	OUT	(C),A
CD85                
CD85 79             	LD	A,C
CD86 D6 10          	SUB	010H
CD88 4F             	LD	C,A
CD89                ;	LD	(SIOAD+1),BC
CD89                ;	LD	(SIOAD0+1),BC
CD89                ;	LD	(SIOAD1+1),BC
CD89                
CD89 21 D3 D0       	LD	HL,SIODATA
CD8C                SINIT1:
CD8C 7E             	LD	A,(HL)
CD8D 23             	INC	HL
CD8E FE FF          	CP	0FFH
CD90 28 04          	JR	Z,SINIT2
CD92 ED 79          	OUT	(C),A
CD94 18 F6          	JR	SINIT1
CD96                SINIT2:
CD96 3E E4          	LD	A,0E4H
CD98 CD F7 DE       	CALL	COMOUT
CD9B 3E C8          	LD	A,INTVEC-CPM_BOOT
CD9D CD D1 DE       	CALL	OT49SB
CDA0                ;
CDA0 01 C4 1F       	LD	BC,01FC4H
CDA3 3E 0C          	LD	A,00CH
CDA5 ED 79          	OUT	(C),A
CDA7                
CDA7 0E C0          	LD	C,0C0H
CDA9 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDAB                
CDAB 0C             	INC	C
CDAC 3E 28          	LD	A,40
CDAE ED 79          	OUT	(C),A
CDB0                
CDB0 0C             	INC	C
CDB1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDB3                
CDB3 0C             	INC	C
CDB4 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDB6                
CDB6 0E C5          	LD	C,0C5H
CDB8 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDBA                
CDBA                TEXT:
CDBA 0E B0          	LD	C,0B0H
CDBC 3E 80          	LD	A,080H
CDBE ED 79          	OUT	(C),A
CDC0 16 07          	LD	D,7
CDC2 0E B9          	LD	C,0B9H
CDC4 21 CC D0       	LD	HL,TEXTDT
CDC7                TEXT1:
CDC7 04             	INC	B
CDC8 ED A3          	OUTI
CDCA 0C             	INC	C
CDCB 15             	DEC	D
CDCC 20 F9          	JR	NZ,TEXT1
CDCE 01 B0 1F       	LD	BC,01FB0H
CDD1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDD3                
CDD3 0E C4          	LD	C,0C4H
CDD5 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDD7                
CDD7 01 01 1A       	LD	BC,01A01H
CDDA ED 78          	IN	A,(C)
CDDC E6 08          	AND	8
CDDE 28 09          	JR	Z,PRN
CDE0 0E 03          	LD	C,003H
CDE2 3E 0F          	LD	A,00FH
CDE4 ED 79          	OUT	(C),A
CDE6 01 04 0A       	LD	BC,00A04H
CDE9                PRN:
CDE9 21 00 00       	LD	HL,0
CDEC 06 5C          	LD	B,05CH
CDEE 3E             	DB	03EH	;LD A,??
CDEF FF             	RST	38H
CDF0 CD 51 E1       	CALL	FILL_MEMORY
CDF3 06 A4          	LD	B,0A4H
CDF5 AF             	XOR	A
CDF6 CD 51 E1       	CALL	FILL_MEMORY
CDF9                
CDF9 3E C3          	LD	A,0C3H		;JP
CDFB 21 03 F0       	LD	HL,CPM_WBOOT
CDFE 32 00 00       	LD	(00000H),A
CE01 22 01 00       	LD	(00001H),HL	;IPL
CE04                
CE04 21 00 1D       	LD	HL,MACW	;3 bit7  DPB Compatible LA(1)
CE07 22 03 00       	LD	(00003H),HL	;  bit6-0 Machine X1(0)
CE0A                ;				;4 LSX-Dodgers(01DH)
CE0A 21 06 D3       	LD	HL,BDOS
CE0D 32 05 00       	LD	(00005H),A
CE10 22 06 00       	LD	(00006H),HL	;BDOS
CE13                
CE13 21 28 DB       	LD	HL,BIOS
CE16 22 19 00       	LD	(00019H),HL	;BIOS-ROM
CE19                
CE19 21 D9 FF       	LD	HL,TRAP38	;TRAP38
CE1C 32 38 00       	LD	(00038H),A
CE1F 22 39 00       	LD	(00039H),HL	;RST 038H
CE22                
CE22 3E F0          	LD	A,CPM_BOOT/256
CE24 32 0B 00       	LD	(0000BH),A
CE27                
CE27 3E             	DB	03EH	;LD A,??
CE28 E9             	JP	(HL)
CE29 32 0F 00       	LD	(0000FH),A
CE2C                
CE2C 3E E6          	LD	A,0E6H
CE2E CD F7 DE       	CALL	COMOUT
CE31 CD DC DE       	CALL	IN49SB
CE34 F5             	PUSH	AF
CE35 CD DC DE       	CALL	IN49SB
CE38 F1             	POP	AF
CE39 F5             	PUSH	AF
CE3A E6 12          	AND	012H
CE3C 20 05          	JR	NZ,KEYR
CE3E 3E 01          	LD	A,1
CE40 32 96 CF       	LD	(KEYREP+1),A
CE43                KEYR:
CE43 F1             	POP	AF
CE44 E6 03          	AND	3
CE46 28 0E          	JR	Z,NON
CE48                
CE48 01 D0 3F       	LD	BC,03FD0H
CE4B ED 49          	OUT	(C),C
CE4D 3E 37          	LD	A,037H
CE4F D3 D0          	OUT	(0D0H),A
CE51 ED 78          	IN	A,(C)
CE53 B9             	CP	C
CE54 28 4B          	JR	Z,TURBO
CE56                NON:
CE56 21 06 D1       	LD	HL,AT_SCR1
CE59 11 81 DF       	LD	DE,SCR1
CE5C 01 94 00       	LD	BC,SCRNE-SCR1	;転送先のサイズ確認用
CE5F 01 85 00       	LD	BC,AT_SCRE-AT_SCR1
CE62 ED B0          	LDIR
CE64                
CE64 21 8B D1       	LD	HL,AT_DWT
CE67 11 D4 EE       	LD	DE,WTTRK
CE6A 01 8F 00       	LD	BC,DMAE-WTTRK	;転送先のサイズ確認用
CE6D 01 8E 00       	LD	BC,AT_CPUE-AT_DWT
CE70 ED B0          	LDIR
CE72                
CE72 21 FC DF       	LD	HL,AT_WTTRK+AT_RS
CE75 22 E9 F0       	LD	(_WTTRK+1),HL
CE78 21 1D EF       	LD	HL,AT_DRD+AT_R
CE7B 22 EC F0       	LD	(_FDRD+1),HL
CE7E 21 D4 EE       	LD	HL,AT_DWT+AT_R
CE81 22 EF F0       	LD	(_FDWT+1),HL
CE84 21 03 E0       	LD	HL,AT_SCRN+AT_RS
CE87 22 D1 F0       	LD	(_SCRN+1),HL
CE8A                
CE8A 3E 27          	LD	A,027H			;ノンターボはMFM切り替えを行わない
CE8C 32 12 F2       	LD	(_DEVICE+012H),A	;Aドライブ
CE8F 32 32 F2       	LD	(_DEVICE+012H+32),A	;Bドライブ
CE92 32 52 F2       	LD	(_DEVICE+012H+32*2),A	;Cドライブ
CE95 32 72 F2       	LD	(_DEVICE+012H+32*3),A	;Dドライブ
CE98                
CE98 21 00 00       	LD	HL,0
CE9B 22 22 DF       	LD	(X1PAT),HL
CE9E C3 2A CF       	JP	NOBANK
CEA1                
CEA1                TURBO:
CEA1 F3             	DI			;Check BIOS
CEA2 06 1D          	LD	B,01DH
CEA4 ED 79          	OUT	(C),A		;BIOS ON
CEA6 3A 51 2F       	LD	A,(02F51H)
CEA9 04             	INC	B		;B=01EH
CEAA ED 79          	OUT	(C),A		;BIOS OFF
CEAC FB             	EI
CEAD FE C9          	CP	0C9H
CEAF 28 02          	JR	Z,BIOSOK
CEB1 18 05          	JR	NOBIOS
CEB3                BIOSOK:
CEB3 3E C3          	LD	A,0C3H		;JP
CEB5 32 18 00       	LD	(00018H),A
CEB8                NOBIOS:
CEB8 3E 1F          	LD	A,01FH		;スタートポート
CEBA DB F0          	IN	A,(0F0H)
CEBC 0F             	RRCA
CEBD 38 0B          	JR	C,CRT1
CEBF 21 BC D0       	LD	HL,_C8025H
CEC2 11 B0 F0       	LD	DE,CRTCD
CEC5 01 10 00       	LD	BC,16
CEC8 ED B0          	LDIR
CECA                CRT1:
CECA 3E 1F          	LD	A,01FH		;スタートポート
CECC DB F0          	IN	A,(0F0H)
CECE CB 57          	BIT	2,A
CED0 28 18          	JR	Z,BANK
CED2                
CED2 AF             	XOR	A
CED3                TZ1:				;前面スイッチが2HDの場合はMFMモードを2HDにしておく
CED3 F5             	PUSH	AF
CED4 CD DC F0       	CALL	_GETDPB
CED7 DD 7E 12       	LD	A,(IX+DPB_DEVICE)
CEDA E6 8F          	AND	08FH
CEDC FE 87          	CP	087H		;フロッピーでMEM切り替えがON
CEDE 20 04          	JR	NZ,TZ2
CEE0 DD CB 0A 86    	RES	0,(IX+DPB_FDMODE)
CEE4                TZ2:
CEE4 F1             	POP	AF
CEE5 3C             	INC	A
CEE6 FE 08          	CP	8
CEE8 38 E9          	JR	C,TZ1
CEEA                
CEEA                BANK:
CEEA 01 00 0B       	LD	BC,00B00H
CEED 21 00 7F       	LD	HL,07F00H
CEF0 F3             	DI
CEF1 ED 69          	OUT	(C),L
CEF3 3A 00 00       	LD	A,(0)
CEF6 FE EB          	CP	0EBH
CEF8 20 05          	JR	NZ,BANK1
CEFA 3E 2B          	LD	A,02BH
CEFC 32 B2 F2       	LD	(BANKDV),A
CEFF                BANK1:
CEFF ED 69          	OUT	(C),L
CF01 5E             	LD	E,(HL)
CF02 7B             	LD	A,E
CF03 C6 A5          	ADD	A,0A5H
CF05 77             	LD	(HL),A
CF06 BE             	CP	(HL)
CF07 73             	LD	(HL),E
CF08 20 05          	JR	NZ,BANK2
CF0A 2C             	INC	L
CF0B CB 65          	BIT	4,L
CF0D 28 F0          	JR	Z,BANK1
CF0F                BANK2:
CF0F 3E 10          	LD	A,010H
CF11 ED 79          	OUT	(C),A
CF13 7D             	LD	A,L
CF14 B7             	OR	A
CF15 28 13          	JR	Z,NOBANK
CF17 26 00          	LD	H,0
CF19 29             	ADD	HL,HL	;*2
CF1A 29             	ADD	HL,HL	;*4
CF1B 29             	ADD	HL,HL	;*8
CF1C 29             	ADD	HL,HL	;*16
CF1D 29             	ADD	HL,HL	;*32
CF1E 2B             	DEC	HL	;-1
CF1F 2B             	DEC	HL	;-2
CF20 2B             	DEC	HL	;-3
CF21 22 A8 F2       	LD	(BANKCL),HL
CF24 CD 73 D0       	CALL	CALC_FATLN
CF27 32 A0 F2       	LD	(BANKFL),A
CF2A                NOBANK:
CF2A                EMM:
CF2A DD 21 80 F2    	LD	IX,EMMFL
CF2E CD 1E D0       	CALL	EADR0
CF31 ED 78          	IN	A,(C)
CF33 F5             	PUSH	AF
CF34                
CF34 11 00 00       	LD	DE,0
CF37                ECHECK1:
CF37 13             	INC	DE
CF38 CD 27 D0       	CALL	EADRX
CF3B ED 60          	IN	H,(C)
CF3D CD 27 D0       	CALL	EADRX
CF40 7C             	LD	A,H
CF41 C6 E5          	ADD	A,0E5H
CF43 ED 79          	OUT	(C),A
CF45 3C             	INC	A
CF46 CD 1E D0       	CALL	EADR0
CF49 ED 79          	OUT	(C),A
CF4B 3D             	DEC	A
CF4C CD 27 D0       	CALL	EADRX
CF4F ED 68          	IN	L,(C)
CF51 CD 27 D0       	CALL	EADRX
CF54 ED 61          	OUT	(C),H
CF56 BD             	CP	L
CF57 20 04          	JR	NZ,ECHECK2
CF59 CB 5A          	BIT	3,D
CF5B 28 DA          	JR	Z,ECHECK1
CF5D                ECHECK2:
CF5D CD 1E D0       	CALL	EADR0
CF60 F1             	POP	AF
CF61 ED 79          	OUT	(C),A
CF63 FE EB          	CP	0EBH
CF65 28 17          	JR	Z,EMM_BPB
CF67 DD 36 0D 02    	LD	(IX+DPB_MAXSEC),2	;BPBが512バイト目から始まる場合を調べる
CF6B CD 1E D0       	CALL	EADR0
CF6E ED 78          	IN	A,(C)
CF70 DD BE 06       	CP	(IX+DPB_FATID)
CF73 28 0D          	JR	Z,EMM_NOBPB
CF75 DD 36 12 26    	LD	(IX+DPB_DEVICE),026H	;BPPを使う
CF79 21 F5 FF       	LD	HL,0-11
CF7C 18 0B          	JR	EMM_BPB1
CF7E                EMM_BPB:
CF7E DD 36 12 26    	LD	(IX+DPB_DEVICE),026H	;BPPを使う
CF82                EMM_NOBPB:
CF82 DD 36 0D 00    	LD	(IX+DPB_MAXSEC),0
CF86 21 F7 FF       	LD	HL,0-9
CF89                EMM_BPB1:
CF89 19             	ADD	HL,DE
CF8A 30 09          	JR	NC,NOEMM
CF8C 22 88 F2       	LD	(EMMCL),HL
CF8F CD 73 D0       	CALL	CALC_FATLN
CF92 32 80 F2       	LD	(EMMFL),A
CF95                NOEMM:
CF95 3E 00          KEYREP:	LD	A,000H
CF97 B7             	OR	A
CF98 28 07          	JR	Z,KEYR1
CF9A 01 00 00       	LD	BC,0
CF9D ED 43 8C F0    	LD	(_CTC),BC
CFA1                KEYR1:
CFA1 CD 54 D0       	CALL	SETCRTC
CFA4 01 30 F8       	LD	BC,0-80*25
CFA7 2A BA F0       	LD	HL,(_PAGE_MINUS)
CFAA ED 43 BA F0    	LD	(_PAGE_MINUS),BC
CFAE 1E 0C          	LD	E,00CH
CFB0 CD CD F0       	CALL	_PRINT
CFB3 22 BA F0       	LD	(_PAGE_MINUS),HL
CFB6                
CFB6 21 8F D0       	LD	HL,INIMES
CFB9 CD A3 D8       	CALL	MSX
CFBC                
CFBC 3A 87 FF       	LD	A,(0FF87H)
CFBF FE 08          	CP	8
CFC1 30 1E          	JR	NC,INIT0
CFC3 5F             	LD	E,A
CFC4 C6 41          	ADD	A,'A'
CFC6 32 8C D0       	LD	(AUTODV),A
CFC9 0E 0E          	LD	C,00EH
CFCB CD 05 00       	CALL	SYSTEM
CFCE 1C             	INC	E
CFCF 21 85 F0       	LD	HL,_SEEKSP	;Disk error Ignore
CFD2 CB FE          	SET	7,(HL)
CFD4 0E 1B          	LD	C,01BH
CFD6 CD 05 00       	CALL	SYSTEM
CFD9                
CFD9 21 85 F0       	LD	HL,_SEEKSP
CFDC CB BE          	RES	7,(HL)
CFDE                
CFDE 3C             	INC	A
CFDF 20 08          	JR	NZ,INIT1
CFE1                INIT0:
CFE1 1E 00          	LD	E,0
CFE3 0E 0E          	LD	C,00EH
CFE5 CD 05 00       	CALL	SYSTEM
CFE8 AF             	XOR	A
CFE9                INIT1:
CFE9 F3             	DI
CFEA 08             	EX	AF,AF'
CFEB 2E FE          	LD	L,0-2		;CALLのスタック分減らす
CFED 39             	ADD	HL,SP
CFEE 11 00 FF       	LD	DE,0FF00H
CFF1 45             	LD	B,L
CFF2 CD 55 D6       	CALL	ZERO_MEMORY_DE
CFF5 21 CA FF       	LD	HL,EXTBIO
CFF8 36 C9          	LD	(HL),0C9H	;RET
CFFA 23             	INC	HL
CFFB 06 0E          	LD	B,TRAP38-EXTBIO-1
CFFD 3E             	DB	03EH	;LD A,??
CFFE FF             	RST	38H
CFFF CD 51 E1       	CALL	FILL_MEMORY
D002 21 DF D0       	LD	HL,AT_TRAP38
D005 11 D9 FF       	LD	DE,TRAP38
D008 01 27 00       	LD	BC,AT_TRAPE-AT_TRAP38
D00B ED B0          	LDIR
D00D 08             	EX	AF,AF'
D00E B7             	OR	A
D00F C8             	RET	Z
D010                
D010 3E E6          	LD	A,0E6H
D012 CD F7 DE       	CALL	COMOUT
D015 CD DC DE       	CALL	IN49SB
D018 CD DC DE       	CALL	IN49SB
D01B FE 1B          	CP	01BH
D01D C9             	RET
D01E                
D01E                EADR0:
D01E D5             	PUSH	DE
D01F 11 00 00       	LD	DE,0
D022 CD 27 D0       	CALL	EADRX
D025 D1             	POP	DE
D026 C9             	RET
D027                
D027                EADRX:
D027 F5             	PUSH	AF
D028 CD 44 D8       	CALL	EADR
D02B F1             	POP	AF
D02C C9             	RET
D02D                
D02D                CHKCTC:
D02D C5             	PUSH	BC
D02E 11 03 47       	LD	DE,04703H
D031                INICTC1:
D031 0C             	INC	C
D032 ED 51          	OUT	(C),D
D034 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
D036 1D             	DEC	E
D037 20 F8          	JR	NZ,INICTC1
D039 C1             	POP	BC
D03A                
D03A 11 FA 07       	LD	DE,007FAH
D03D ED 51          	OUT	(C),D
D03F ED 59          	OUT	(C),E
D041 ED 78          	IN	A,(C)
D043 BB             	CP	E
D044 C0             	RET	NZ
D045 ED 51          	OUT	(C),D
D047 ED 51          	OUT	(C),D
D049 ED 78          	IN	A,(C)
D04B BA             	CP	D
D04C C0             	RET	NZ
D04D 0C             	INC	C
D04E 0C             	INC	C
D04F ED 43 8C F0    	LD	(_CTC),BC
D053 C9             	RET
D054                
D054                SETCRTC:
D054 21 B0 F0       	LD	HL,CRTCD
D057 AF             	XOR	A
D058                SETCRT1:
D058 01 00 18       	LD	BC,01800H
D05B ED 79          	OUT	(C),A
D05D 0C             	INC	C
D05E 04             	INC	B
D05F ED A3          	OUTI
D061 3C             	INC	A
D062 FE 0C          	CP	12
D064 20 F2          	JR	NZ,SETCRT1
D066 23             	INC	HL
D067 23             	INC	HL
D068 01 03 1B       	LD	BC,01A03H+00100H
D06B ED A3          	OUTI
D06D 01 D0 20       	LD	BC,01FD0H+00100H
D070 ED A3          	OUTI
D072 C9             	RET
D073                
D073                CALC_FATLN:	;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
D073 5D             	LD	E,L
D074 54             	LD	D,H
D075 29             	ADD	HL,HL	;*2
D076 19             	ADD	HL,DE	;*3
D077 CB 3C          	SRL	H	;/2
D079 CB 1D          	RR	L	;1クラスタ辺り1.5バイト必要
D07B 11 FF 01       	LD	DE,511	;切り上げる
D07E 19             	ADD	HL,DE
D07F 7C             	LD	A,H
D080 CB 3F          	SRL	A
D082 C9             	RET
D083                
D083 41 55 54 4F    AUTOD:	DB	"AUTOEXEC "
D087 45 58 45 43
D08B 20
D08C 41 3A 00       AUTODV:	DB	"A:",0
D08F                
D08F 4C 53 58 2D    INIMES:	DB	"LSX-Dodgers for X1/turbo version "
D093 44 6F 64 67
D097 65 72 73 20
D09B 66 6F 72 20
D09F 58 31 2F 74
D0A3 75 72 62 6F
D0A7 20 76 65 72
D0AB 73 69 6F 6E
D0AF 20
D0B0 31 2E          	DB	030H + VER_1, '.'
D0B2 35 38          	DB	030H + VER_2 ,030H + VER_3
D0B4                ;	DB	""
D0B4 20 47 61 6B    	DB	' Gaku',0DH,0AH
D0B8 75 0D 0A
D0BB 00             	DB	0
D0BC                
D0BC                _C8025H:
D0BC 6B 50 59 88    	DB	06BH,050H,059H,088H,01BH,001H,019H,01AH
D0C0 1B 01 19 1A
D0C4 00 0F          	DB	000H,00FH
D0C6 80 F8 B0 FF    	DW	0-80*LINE,0-80
D0CA 0C 23          	DB	00CH,023H
D0CC                
D0CC 03 0C 0F 30    TEXTDT:	DB	003H,00CH,00FH,030H,033H,03CH,03FH
D0D0 33 3C 3F
D0D3                
D0D3                SIODATA:
D0D3 18             	DB	018H
D0D4 01 00          	DB	1,0
D0D6 02 00          	DB	2,0
D0D8 03 C1          	DB	3,0C1H
D0DA 04 44          	DB	4,044H
D0DC 05 E8          	DB	5,0E8H
D0DE FF             	DB	0FFH
D0DF                
D0DF                AT_TRAP38:
D0DF 21 00 00       	LD	HL,0
D0E2 E3             	EX	(SP),HL
D0E3 3E 24          	LD	A,'$'
D0E5 CD A6 DB       	CALL	MSG_A
D0E8 2B             	DEC	HL
D0E9 7C             	LD	A,H
D0EA CD E8 FF       	CALL	PRHX+AT_RT
D0ED 7D             	LD	A,L
D0EE                PRHX:
D0EE F5             	PUSH	AF
D0EF 07             	RLCA
D0F0 07             	RLCA
D0F1 07             	RLCA
D0F2 07             	RLCA
D0F3 CD F1 FF       	CALL	PRHX2+AT_RT
D0F6 F1             	POP	AF
D0F7                PRHX2:
D0F7 E6 0F          	AND	00FH
D0F9 FE 0A          	CP	10
D0FB 3F             	CCF
D0FC CE 30          	ADC	A,'0'
D0FE 27             	DAA
D0FF C3 A6 DB       	JP	MSG_A
D102                	DS	4
D106                AT_TRAPE:
D106                	INCLUDE	"X1CPU.ASM"
D106                
D106                ;	LSX-Dodgers CPU
D106                ;	X1/turbo/Z
D106                
D106                ;	ノンターボ用パッチ
D106                ;	DMAを使って転送している部分をCPUに差し替える
D106                
D106                AT_SCR1:
D106 D9             	EXX
D107 C5             	PUSH	BC
D108 ED 4B B1 F0    	LD	BC,(_WIDTH)
D10C 06 20          	LD	B,020H
D10E D9             	EXX
D10F C5             	PUSH	BC
D110 01 00 20       	LD	BC,02000H
D113                
D113 67             	LD	H,A
D114 B7             	OR	A
D115                AT_SCRUP1:
D115 28 15          	JR	Z,AT_SCRCL
D117 C5             	PUSH	BC
D118 CB E0          	SET	4,B
D11A D9             	EXX
D11B C5             	PUSH	BC
D11C CB E0          	SET	4,B
D11E D9             	EXX
D11F CD B2 DF       	CALL	AT_UPSUB+AT_RS
D122 D9             	EXX
D123 C1             	POP	BC
D124 D9             	EXX
D125 C1             	POP	BC
D126 CD B2 DF       	CALL	AT_UPSUB+AT_RS
D129 25             	DEC	H
D12A 18 E9          	JR	AT_SCRUP1
D12C                
D12C                AT_SCRCL:
D12C 2A B1 F0       	LD	HL,(_WIDTH)
D12F CD 4A DE       	CALL	LINECL
D132 C1             	POP	BC
D133 D9             	EXX
D134 C1             	POP	BC
D135 D9             	EXX
D136 C9             	RET
D137                
D137                AT_UPSUB:
D137 3A B1 F0       	LD	A,(_WIDTH)
D13A 6F             	LD	L,A
D13B                AT_UPSUB1:
D13B D9             	EXX
D13C ED 78          	IN	A,(C)
D13E 03             	INC	BC
D13F D9             	EXX
D140 ED 79          	OUT	(C),A
D142 03             	INC	BC
D143 2D             	DEC	L
D144 20 F5          	JR	NZ,AT_UPSUB1
D146 C9             	RET
D147                
D147                ;	FLOPPY DISK DRIVER(CPU)
D147                
D147                DISKC:
D147 1B             	DEC	DE
D148 CB 5F          	BIT	3,A
D14A C4 CD EE       	CALL	NZ,RNF
D14D                DISKD:
D14D E5             	PUSH	HL
D14E 21 D3 EE       	LD	HL,RETRY
D151 35             	DEC	(HL)
D152 E1             	POP	HL
D153 20 0C          	JR	NZ,AT_ERR		;Retry
D155 B7             	OR	A
D156 28 09          	JR	Z,AT_ERR		;Error
D158                
D158                AT_DELP:
D158 CD CD EE       	CALL	RNF
D15B CD A9 EE       	CALL	FDMOFF
D15E 3E FF          	LD	A,0FFH
D160                AT_ERRZ:
D160 BF             	CP	A
D161                AT_ERR:
D161 3E FF          	LD	A,0FFH
D163 C9             	RET
D164                ERRW:
D164 3E FF          	LD	A,0FFH
D166 BF             	CP	A
D167 37             	SCF
D168 C3 A9 EE       	JP	FDMOFF
D16B                
D16B                ERRDW:
D16B D1             	POP	DE
D16C CD D3 DF       	CALL	AT_DELP+AT_RS
D16F C2 E2 EE       	JP	NZ,DWT0+AT_R
D172 B7             	OR	A
D173 20 EF          	JR	NZ,ERRW
D175 C9             	RET
D176                
D176                ERRDR:
D176 D1             	POP	DE
D177 CD D3 DF       	CALL	AT_DELP+AT_RS
D17A C2 2B EF       	JP	NZ,DRD0+AT_R
D17D B7             	OR	A
D17E 20 E4          	JR	NZ,ERRW
D180 C9             	RET
D181                
D181                AT_WTTRK:
D181 06 01          	LD	B,1
D183 3E F4          	LD	A,0F4H
D185 C3 D6 EE       	JP	AT_WTTRK1+AT_R
D188                
D188                AT_SCRN:
D188 ED 78          	IN	A,(C)
D18A C9             	RET
D18B                AT_SCRE:
D18B                
D18B                AT_DWT:
D18B 3E A0          	LD	A,0A0H
D18D                AT_WTTRK1:
D18D 32 71 EE       	LD	(FDCPAT+1),A
D190                DWTBL:
D190 78             	LD	A,B
D191 32 19 EF       	LD	(AT_WTB+1+AT_R),A
D194 3E 02          	LD	A,2		;Retry count
D196 32 D3 EE       	LD	(RETRY),A
D199                
D199                DWT0:
D199 D5             	PUSH	DE
D19A E5             	PUSH	HL
D19B CD 10 EE       	CALL	SEEK		;Write disk
D19E E1             	POP	HL
D19F DA E6 DF       	JP	C,ERRDW+AT_RS
D1A2 F3             	DI
D1A3 3A 71 EE       	LD	A,(FDCPAT+1)
D1A6 CD B5 EE       	CALL	SECSET
D1A9 0E FB          	LD	C,0FBH
D1AB                
D1AB                DWT1:
D1AB 56             	LD	D,(HL)
D1AC                DWT2:
D1AC 78             	LD	A,B
D1AD DB F8          	IN	A,(0F8H)
D1AF 0F             	RRCA
D1B0 30 08          	JR	NC,DWT4
D1B2 0F             	RRCA
D1B3 30 F7          	JR	NC,DWT2
D1B5                DWT3:
D1B5 ED 51          	OUT	(C),D
D1B7 23             	INC	HL
D1B8 18 F1          	JR	DWT1
D1BA                
D1BA                DWT4:
D1BA 3D             	DEC	A
D1BB 28 F8          	JR	Z,DWT3
D1BD 3C             	INC	A
D1BE FB             	EI
D1BF D1             	POP	DE
D1C0 13             	INC	DE
D1C1 CD A9 EE       	CALL	FDMOFF
D1C4 28 09          	JR	Z,DISKOK_WT
D1C6 CD C2 DF       	CALL	DISKC+AT_RS
D1C9 20 CE          	JR	NZ,DWT0
D1CB B7             	OR	A
D1CC C2 DF DF       	JP	NZ,ERRW+AT_RS
D1CF                
D1CF                DISKOK_WT:
D1CF 06 01          AT_WTB:	LD	B,1
D1D1 10 BD          	DJNZ	DWTBL
D1D3 C9             	RET
D1D4                
D1D4                AT_DRD:
D1D4 3E 80          	LD	A,080H
D1D6 32 71 EE       	LD	(FDCPAT+1),A
D1D9                DRDBL:
D1D9 78             	LD	A,B
D1DA 32 5E EF       	LD	(AT_RDB+1+AT_R),A
D1DD 3E 02          	LD	A,2		;Retry count
D1DF 32 D3 EE       	LD	(RETRY),A
D1E2                DRD0:
D1E2 D5             	PUSH	DE
D1E3 E5             	PUSH	HL
D1E4 CD 10 EE       	CALL	SEEK		;Read disk
D1E7 E1             	POP	HL
D1E8 DA F1 DF       	JP	C,ERRDR+AT_RS
D1EB F3             	DI
D1EC 3A 71 EE       	LD	A,(FDCPAT+1)
D1EF CD B5 EE       	CALL	SECSET
D1F2 0E FB          	LD	C,0FBH
D1F4                DRD1:
D1F4 78             	LD	A,B
D1F5 DB F8          	IN	A,(0F8H)
D1F7 0F             	RRCA
D1F8 30 08          	JR	NC,DRD3
D1FA 0F             	RRCA
D1FB 30 F7          	JR	NC,DRD1
D1FD ED A2          	INI
D1FF 04             	INC	B
D200 18 F2          	JR	DRD1
D202                
D202                DRD3:
D202 B7             	OR	A
D203 FB             	EI
D204 D1             	POP	DE
D205 13             	INC	DE
D206 CD A9 EE       	CALL	FDMOFF
D209 28 09          	JR	Z,DISKOK_RD
D20B CD C2 DF       	CALL	DISKC+AT_RS
D20E 20 D2          	JR	NZ,DRD0
D210 B7             	OR	A
D211 C2 DF DF       	JP	NZ,ERRW+AT_RS
D214                
D214                DISKOK_RD:
D214 06 01          AT_RDB:	LD	B,1
D216 10 C1          	DJNZ	DRDBL
D218 C9             	RET
D219                
D219                AT_CPUE:
D219                
D219 00 00 2E FA    AT_RT	EQU	TRAP38-AT_TRAP38
D219                
D219                INITE:
D219                	DS	BDOS-INITE
D306 C3 62 D8       	JP	BDOS0
D309                	INCLUDE	"X1CCP.ASM"
D309                
D309                ;	LSX-Dodgers CCP
D309                ;	X1/turbo/Z
D309                
D309                WBOOT1:
D309 F3             	DI
D30A ED 7B 06 00    	LD	SP,(SYSTEM+1)
D30E                
D30E 3E F0          	LD	A,INTVEC/256
D310 ED 47          	LD	I,A
D312                
D312 3E E4          	LD	A,0E4H
D314 CD F7 DE       	CALL	COMOUT
D317 3E C8          	LD	A,INTVEC-CPM_BOOT
D319 CD D1 DE       	CALL	OT49SB
D31C                
D31C 21 B0 F0       	LD	HL,CRTCD
D31F AF             	XOR	A
D320                SETCRT2:
D320 01 00 18       	LD	BC,01800H
D323 ED 79          	OUT	(C),A
D325 0C             	INC	C
D326 56             	LD	D,(HL)
D327 FE 0D          	CP	13
D329 38 02          	JR	C,SETCRT3
D32B 16 00          	LD	D,0
D32D                SETCRT3:
D32D ED 51          	OUT	(C),D
D32F 23             	INC	HL
D330 3C             	INC	A
D331 FE 0E          	CP	14
D333 20 EB          	JR	NZ,SETCRT2
D335                
D335 01 03 1B       	LD	BC,01A03H+00100H
D338 ED A3          	OUTI
D33A 01 D0 20       	LD	BC,01FD0H+00100H
D33D ED A3          	OUTI
D33F 21 92 F0       	LD	HL,_KEYD
D342 7E             	LD	A,(HL)
D343 36 00          	LD	(HL),0
D345 CD 93 DB       	CALL	KEYBC_IFBREAK
D348 3E 04          	LD	A,4
D34A CD A6 DB       	CALL	MSG_A
D34D                	INCLUDE	"LDCCP.ASM"
D34D                
D34D                ;	LSX-Dodgers CCP
D34D                
D34D                COMMAND:
D34D 3A C4 EF       	LD	A,(FCB_BAT)
D350 B7             	OR	A
D351 C2 92 D4       	JP	NZ,C_BAT1
D354 CD 07 D4       	CALL	SETDTA1
D357 3A 87 F0       	LD	A,(_DVSW)
D35A C6 41          	ADD	A,'A'
D35C CD A6 DB       	CALL	MSG_A
D35F 3E 3E          	LD	A,'>'
D361 CD A6 DB       	CALL	MSG_A
D364 3E 50          	LD	A,80
D366 12             	LD	(DE),A
D367 CD 27 DC       	CALL	_SYS0A		;(BDOS)文字列入力
D36A CD 87 D5       	CALL	LTNL
D36D                COMMAND2:
D36D 11 82 00       	LD	DE,DTA1+2
D370 CD FD F0       	CALL	_COMANL
D373 30 D8          	JR	NC,COMMAND
D375 11 79 F0       	LD	DE,COMERM
D378 CD 94 D8       	CALL	_SYS09		;(BDOS)文字列出力
D37B C7             	RST	0
D37C                
D37C                COMANL:
D37C CD A5 E0       	CALL	FILE
D37F 3A 19 F0       	LD	A,(FNAME+4)
D382 FE 20          	CP	020H
D384 20 1C          	JR	NZ,COMB2
D386 D5             	PUSH	DE
D387 11 15 F0       	LD	DE,FNAME
D38A 1A             	LD	A,(DE)
D38B FE 20          	CP	020H
D38D 28 44          	JR	Z,SDVSW
D38F 1B             	DEC	DE
D390 1A             	LD	A,(DE)
D391 C6 FF          	ADD	A,0FFH
D393 38 09          	JR	C,COMB
D395 13             	INC	DE
D396                
D396 21 41 D7       	LD	HL,COMTB
D399 06 08          	LD	B,COMS
D39B CD 29 E3       	CALL	CPNAME
D39E                COMB:
D39E D1             	POP	DE
D39F D2 0F 00       	JP	NC,JP_HL
D3A2                COMB2:
D3A2 EB             	EX	DE,HL
D3A3 22 6F D4       	LD	(COMPAT+1),HL
D3A6 F5             	PUSH	AF
D3A7 CD 27 D4       	CALL	CEXE4
D3AA F1             	POP	AF
D3AB 21 15 F0       	LD	HL,FNAME
D3AE 11 6D 00       	LD	DE,FCB2+1	;COMMAND NAME
D3B1 01 0B 00       	LD	BC,11
D3B4 ED B0          	LDIR
D3B6 11 63 EF       	LD	DE,PATHD
D3B9                CEX1:
D3B9 1A             	LD	A,(DE)
D3BA FE 20          	CP	020H
D3BC D8             	RET	C
D3BD CD 9A E0       	CALL	FILEC
D3C0 D5             	PUSH	DE
D3C1 21 6D 00       	LD	HL,FCB2+1	;COMMAND NAME
D3C4 11 15 F0       	LD	DE,FNAME
D3C7 01 0B 00       	LD	BC,11
D3CA ED B0          	LDIR
D3CC CD 27 D4       	CALL	CEXE4
D3CF D1             	POP	DE
D3D0 13             	INC	DE
D3D1 18 E6          	JR	CEX1
D3D3                
D3D3                SDVSW:
D3D3 F1             	POP	AF
D3D4 3A 14 F0       	LD	A,(FDRV)
D3D7 3D             	DEC	A
D3D8 5F             	LD	E,A
D3D9 0E 0E          	LD	C,00EH		;(BDOS)カレントドライブの設定
D3DB 18 31          	JR	SYSTEM0
D3DD                
D3DD                OPEN1:
D3DD 21 14 F0       	LD	HL,FDRV
D3E0                OPEN:
D3E0 0E 11          	LD	C,011H		;(BDOS)ファイルの検索
D3E2                OPEN3:
D3E2 D5             	PUSH	DE
D3E3 11 9F EF       	LD	DE,DTA_CCP
D3E6 CD 04 D4       	CALL	SETDTA
D3E9 EB             	EX	DE,HL
D3EA CD 0E D4       	CALL	SYSTEM0
D3ED D1             	POP	DE
D3EE C9             	RET
D3EF                
D3EF                OPEN2:
D3EF 0E 12          	LD	C,012H
D3F1 18 EF          	JR	OPEN3
D3F3                
D3F3                DEFCB:				;Z=Ok NZ=Error
D3F3 11 9F EF       	LD	DE,DTA_CCP
D3F6 CD 0C D4       	CALL	SYSC0F
D3F9                
D3F9 11 C0 EF       	LD	DE,DTA_CCP+33	;(FCB)ランダムレコード
D3FC 06 04          	LD	B,4
D3FE CD 55 D6       	CALL	ZERO_MEMORY_DE
D401                SETDTA100:
D401 11 00 01       	LD	DE,00100H
D404                SETDTA:
D404 C3 6C DA       	JP	_SYS1A		;(BDOS)DTAの設定
D407                
D407                SETDTA1:
D407 11 80 00       	LD	DE,DTA1
D40A 18 F8          	JR	SETDTA
D40C                
D40C                SYSC0F:
D40C 0E 0F          	LD	C,00FH		;(BDOS)ファイルのオープン
D40E                SYSTEM0:
D40E CD 05 00       	CALL	SYSTEM
D411 B7             	OR	A
D412 C9             	RET
D413                
D413                C_CD:
D413 0E 5A          	LD	C,5AH
D415 18 F7          	JR	SYSTEM0
D417                
D417                S27BUF:
D417 3A 07 00       	LD	A,(SYSTEM+2)
D41A 3D             	DEC	A
D41B E6 F8          	AND	0F8H
D41D 67             	LD	H,A
D41E 2E 00          	LD	L,0
D420                S27DTA:
D420 11 9F EF       	LD	DE,DTA_CCP
D423                S27:
D423 0E 27          	LD	C,027H		;(BDOS)ランダムブロック読み込み
D425 18 E7          	JR	SYSTEM0
D427                
D427                CEXE4:
D427 21 1D F0       	LD	HL,FNAME+8
D42A 7E             	LD	A,(HL)
D42B FE 20          	CP	020H
D42D 20 07          	JR	NZ,CEXE7
D42F 3E 3F          	LD	A,'?'
D431 77             	LD	(HL),A
D432 23             	INC	HL
D433 77             	LD	(HL),A
D434 23             	INC	HL
D435 77             	LD	(HL),A
D436                CEXE7:
D436 CD DD D3       	CALL	OPEN1
D439                CEXE5:
D439 C0             	RET	NZ
D43A 2A A9 EF       	LD	HL,(DTA_CCP+1+9)
D43D 7C             	LD	A,H
D43E CD B1 E3       	CALL	CAP
D441 67             	LD	H,A
D442 7D             	LD	A,L
D443 CD B1 E3       	CALL	CAP
D446 6F             	LD	L,A
D447 3A A8 EF       	LD	A,(DTA_CCP+1+8)
D44A CD B1 E3       	CALL	CAP
D44D D6 42          	SUB	'B'
D44F 28 2C          	JR	Z,C_BAT
D451 3D             	DEC	A		;'C'
D452 28 05          	JR	Z,C_EXE
D454                CEXE6:
D454 CD EF D3       	CALL	OPEN2
D457 18 E0          	JR	CEXE5
D459                
D459                C_EXE:
D459 7C             	LD	A,H
D45A FE 4D          	CP	'M'
D45C 20 F6          	JR	NZ,CEXE6
D45E                
D45E CD F3 D3       	CALL	DEFCB
D461 CD 17 D4       	CALL	S27BUF
D464 3D             	DEC	A
D465 37             	SCF
D466 C0             	RET	NZ
D467 7C             	LD	A,H
D468 B5             	OR	L
D469 37             	SCF
D46A C8             	RET	Z
D46B CD 07 D4       	CALL	SETDTA1
D46E 11 00 00       COMPAT:	LD	DE,0				; self-modifying code
D471 ED 7B 06 00    	LD	SP,(SYSTEM+1)
D475 67             	LD	H,A				; A=0 in SETDTA1(_SYS1A)
D476 6F             	LD	L,A
D477 E5             	PUSH	HL				; push $0000 (reboot address)
D478 24             	INC	H
D479 E5             	PUSH	HL				; push $0100 (TPA address)
D47A C3 20 D6       	JP	SETFCB				; and JP $0100
D47D                
D47D                C_BAT:
D47D 11 41 54       	LD	DE,'A'+'T'*256
D480 ED 52          	SBC	HL,DE
D482 20 D0          	JR	NZ,CEXE6
D484                
D484 CD F3 D3       	CALL	DEFCB
D487                
D487 21 9F EF       	LD	HL,DTA_CCP
D48A 11 C4 EF       	LD	DE,FCB_BAT
D48D 01 25 00       	LD	BC,37
D490 ED B0          	LDIR
D492                C_BAT1:
D492 CD 01 D4       	CALL	SETDTA100
D495 CD C9 D4       	CALL	FGETC_BAT
D498 21 81 00       	LD	HL,DTA1+1
D49B 20 25          	JR	NZ,END_BATCH
D49D FE 21          	CP	021H		;スペースや改行など制御文字を飛ばす
D49F 38 F1          	JR	C,C_BAT1
D4A1 36 20          	LD	(HL),' '
D4A3 23             	INC	HL
D4A4                C_BAT2:
D4A4 77             	LD	(HL),A
D4A5 23             	INC	HL
D4A6 7D             	LD	A,L
D4A7 3C             	INC	A		;L==0FFH
D4A8 28 09          	JR	Z,RUN_BATCH
D4AA CD C9 D4       	CALL	FGETC_BAT
D4AD 20 04          	JR	NZ,RUN_BATCH
D4AF FE 20          	CP	020H
D4B1 30 F1          	JR	NC,C_BAT2
D4B3                RUN_BATCH:
D4B3 7D             	LD	A,L
D4B4 D6 7F          	SUB	DTA1-1
D4B6 32 80 00       	LD	(DTA1),A
D4B9 FE 04          	CP	4
D4BB 38 05          	JR	C,END_BATCH
D4BD 36 00          	LD	(HL),0
D4BF C3 6D D3       	JP	COMMAND2
D4C2                END_BATCH:
D4C2 AF             	XOR	A		;バッチファイルを閉じる
D4C3 32 C4 EF       	LD	(FCB_BAT),A
D4C6 C3 00 F0       	JP	CPM_BOOT
D4C9                
D4C9                FGETC_BAT:
D4C9 11 C4 EF       	LD	DE,FCB_BAT
D4CC                FGETC:				;1文字ずつ読み込む
D4CC E5             	PUSH	HL		;Z:成功
D4CD 21 01 00       	LD	HL,1
D4D0 CD 23 D4       	CALL	S27
D4D3 E1             	POP	HL
D4D4 3A 00 01       	LD	A,(00100H)
D4D7 C9             	RET
D4D8                
D4D8                C_DEL:
D4D8 CD 20 D6       	CALL	SETFCB
D4DB CD BC DB       	CALL	_SYS08		;(BDOS)エコーなしコンソール入力
D4DE                
D4DE 0E 13          	LD	C,013H
D4E0 18 0A          	JR	CDEL1		;(BDOS)ファイルの削除
D4E2                
D4E2                C_REN:
D4E2 CD 20 D6       	CALL	SETFCB
D4E5 3E 10          	LD	A,010H		;ディレクトリも対象にする
D4E7 32 69 00       	LD	(FCB1+13),A	;属性
D4EA 0E 17          	LD	C,017H		;(BDOS)ファイル名の変更
D4EC                CDEL1:
D4EC 11 5C 00       	LD	DE,FCB1
D4EF CD 05 00       	CALL	SYSTEM
D4F2 C6 FF          	ADD	A,0FFH
D4F4 C9             	RET
D4F5                
D4F5                C_DIR:
D4F5 CD 9A E0       	CALL	FILEC
D4F8 21 15 F0       	LD	HL,FDRV+1
D4FB CD 36 D7       	CALL	CWILD1
D4FE 3E F1          	LD	A,0F1H
D500 32 21 F0       	LD	(FDRV+13),A
D503 CD DD D3       	CALL	OPEN1
D506                CDIR1:
D506 B7             	OR	A
D507 20 08          	JR	NZ,PDSKF
D509 CD 54 D5       	CALL	P_NAME
D50C CD EF D3       	CALL	OPEN2
D50F 18 F5          	JR	CDIR1
D511                PDSKF:
D511 3A 14 F0       	LD	A,(FDRV)
D514 5F             	LD	E,A
D515 0E 1B          	LD	C,01BH		;(BDOS)ディスク情報の獲得
D517 CD 05 00       	CALL	SYSTEM
D51A 4F             	LD	C,A		;C←1クラスタ辺りの論理セクタ数
D51B C6 01          	ADD	A,001H
D51D D8             	RET	C		;Aが0FFHだった場合
D51E 3E 06          	LD	A,8-2
D520                PDS1:				;HL=未使用クラスタの総数
D520 3C             	INC	A
D521 CB 19          	RR	C
D523 30 FB          	JR	NC,PDS1
D525                PDS2:				;B←論理セクタのサイズの上位8ビット
D525 3C             	INC	A
D526 CB 18          	RR	B
D528 30 FB          	JR	NC,PDS2
D52A 47             	LD	B,A
D52B                
D52B 11 00 00       	LD	DE,0
D52E                PDS3:
D52E 29             	ADD	HL,HL
D52F EB             	EX	DE,HL
D530 ED 6A          	ADC	HL,HL
D532 EB             	EX	DE,HL
D533 10 F9          	DJNZ	PDS3
D535                PDSKF1:
D535 CD BE D5       	CALL	PRDEC_DEHL
D538 11 F4 EF       	LD	DE,FREE
D53B CD 94 D8       	CALL	_SYS09		;(BDOS)文字列出力
D53E CD AE D5       	CALL	PUTDRV
D541 3E 5C          	LD	A,05CH		;\
D543 CD A6 DB       	CALL	MSG_A
D546 2A 22 F0       	LD	HL,(FDRV+14)	;ディレクトリのクラスタ番号
D549 AF             	XOR	A
D54A 11 FE FF       	LD	DE,0-2
D54D 19             	ADD	HL,DE
D54E 23             	INC	HL
D54F DC BB D5       	CALL	C,PRDEC_HL
D552 18 33          	JR	LTNL
D554                
D554                P_NAME:
D554 3A A0 EF       	LD	A,(DTA_CCP+1)
D557 FE 2E          	CP	'.'
D559 C8             	RET	Z
D55A                
D55A 3A AB EF       	LD	A,(DTA_CCP+1+00BH)
D55D F5             	PUSH	AF
D55E CB 67          	BIT	4,A
D560 28 08          	JR	Z,DIR3
D562 11 E9 EF       	LD	DE,DIRMES
D565 CD 94 D8       	CALL	_SYS09		;(BDOS)文字列出力
D568 18 0A          	JR	DIR6
D56A                DIR3:
D56A ED 5B BE EF    	LD	DE,(DTA_CCP+1+01EH)
D56E 2A BC EF       	LD	HL,(DTA_CCP+1+01CH)
D571 CD BE D5       	CALL	PRDEC_DEHL
D574                DIR6:
D574 F1             	POP	AF
D575 0F             	RRCA
D576 9F             	SBC	A,A
D577 E6 0A          	AND	'*'-020H
D579 C6 20          	ADD	A,020H
D57B CD A6 DB       	CALL	MSG_A
D57E CD AE D5       	CALL	PUTDRV
D581 21 A0 EF       	LD	HL,DTA_CCP+1
D584 CD FE D5       	CALL	FPRNT
D587                
D587                LTNL:
D587 1E 03          	LD	E,3
D589 C3 CD F0       	JP	_PRINT
D58C                
D58C                C_PATH:
D58C CD 7C E1       	CALL	SPCUT
D58F 21 63 EF       	LD	HL,PATHD
D592 FE 21          	CP	021H
D594 30 0C          	JR	NC,CPATH0
D596                CPATHP:
D596 7E             	LD	A,(HL)
D597 23             	INC	HL
D598 FE 20          	CP	020H
D59A 3F             	CCF
D59B 30 EA          	JR	NC,LTNL
D59D CD A6 DB       	CALL	MSG_A
D5A0 18 F4          	JR	CPATHP
D5A2                CPATH0:
D5A2 FE 3B          	CP	';'
D5A4 20 01          	JR	NZ,CPATH1
D5A6 13             	INC	DE
D5A7                CPATH1:
D5A7 EB             	EX	DE,HL
D5A8 01 3B 00       	LD	BC,PATHX
D5AB ED B0          	LDIR
D5AD C9             	RET
D5AE                
D5AE                PUTDRV:
D5AE 3A 14 F0       	LD	A,(FDRV)
D5B1 C6 40          	ADD	A,'A'-1
D5B3 CD A6 DB       	CALL	MSG_A
D5B6 3E 3A          	LD	A,':'
D5B8                MSG_AR:
D5B8 C3 A6 DB       	JP	MSG_A
D5BB                
D5BB                PRDEC_HL:
D5BB AF             	XOR	A
D5BC 5F             	LD	E,A
D5BD 57             	LD	D,A
D5BE                PRDEC_DEHL:
D5BE D5             	PUSH	DE
D5BF 11 0F F0       	LD	DE,DECBF
D5C2 06 05          	LD	B,5
D5C4 CD 55 D6       	CALL	ZERO_MEMORY_DE	;A=0
D5C7 D1             	POP	DE
D5C8                
D5C8 0E 20          	LD	C,32
D5CA                DEC1:
D5CA 29             	ADD	HL,HL
D5CB EB             	EX	DE,HL
D5CC ED 6A          	ADC	HL,HL
D5CE EB             	EX	DE,HL
D5CF E5             	PUSH	HL
D5D0 21 13 F0       	LD	HL,DECBF+4
D5D3 06 05          	LD	B,5
D5D5                DEC2:
D5D5 7E             	LD	A,(HL)
D5D6 8F             	ADC	A,A
D5D7 27             	DAA
D5D8 77             	LD	(HL),A
D5D9 2B             	DEC	HL
D5DA 10 F9          	DJNZ	DEC2
D5DC E1             	POP	HL
D5DD 0D             	DEC	C
D5DE 20 EA          	JR	NZ,DEC1
D5E0                
D5E0 21 0F F0       	LD	HL,DECBF
D5E3 3E 20          	LD	A,020H
D5E5 06 04          	LD	B,4
D5E7                DEC3:
D5E7 CD F4 D5       	CALL	DEC4
D5EA CD F4 D5       	CALL	DEC4
D5ED 23             	INC	HL
D5EE 10 F7          	DJNZ	DEC3
D5F0                DECX:
D5F0 CD F4 D5       	CALL	DEC4
D5F3 AF             	XOR	A
D5F4                DEC4:
D5F4 ED 6F          	RLD
D5F6 FE 20          	CP	020H
D5F8 28 02          	JR	Z,DEC5
D5FA F6 30          	OR	030H
D5FC                DEC5:
D5FC 18 BA          	JR	MSG_AR
D5FE                
D5FE                FPRNT:
D5FE 06 08          	LD	B,8	;ファイル名を表示
D600 CD 0F D6       	CALL	P_N1
D603 7E             	LD	A,(HL)
D604 CD BD E3       	CALL	CAP3
D607 D8             	RET	C	;拡張子が無い
D608                
D608 3E 2E          	LD	A,'.'
D60A CD A6 DB       	CALL	MSG_A
D60D 06 03          	LD	B,3	;拡張子を表示
D60F                P_N1:
D60F 7E             	LD	A,(HL)
D610 CD BD E3       	CALL	CAP3
D613 38 07          	JR	C,P_N2
D615 CD A6 DB       	CALL	MSG_A
D618 23             	INC	HL
D619 10 F4          	DJNZ	P_N1
D61B C9             	RET
D61C                P_N2:
D61C 23             	INC	HL
D61D 10 FD          	DJNZ	P_N2
D61F C9             	RET
D620                
D620                SETFCB:
D620 CD 7C E1       	CALL	SPCUT
D623 1A             	LD	A,(DE)
D624 FE 20          	CP	020H
D626 38 01          	JR	C,SETFCBA
D628 1B             	DEC	DE
D629                SETFCBA:
D629 06 24          	LD	B,36
D62B 21 5C 00       	LD	HL,FCB1
D62E E5             	PUSH	HL
D62F AF             	XOR	A
D630 CD 51 E1       	CALL	FILL_MEMORY
D633 E1             	POP	HL
D634 D5             	PUSH	DE
D635 CD D2 DA       	CALL	_SYS29		;(BDOS)ファイル名の解析
D638 21 6C 00       	LD	HL,FCB2
D63B CD D2 DA       	CALL	_SYS29		;(BDOS)ファイル名の解析
D63E E1             	POP	HL
D63F 01 00 50       	LD	BC,05000H
D642 11 81 00       	LD	DE,00081H
D645                SETFCB1:
D645 7E             	LD	A,(HL)
D646 23             	INC	HL
D647 FE 20          	CP	020H
D649 38 05          	JR	C,SETFCB2
D64B 12             	LD	(DE),A
D64C 13             	INC	DE
D64D 0C             	INC	C
D64E 10 F5          	DJNZ	SETFCB1
D650                SETFCB2:
D650 79             	LD	A,C
D651 32 80 00       	LD	(DTA1),A
D654 04             	INC	B
D655                ZERO_MEMORY_DE:
D655 AF             	XOR	A
D656                FILL_MEMORY_DE:
D656 12             	LD	(DE),A
D657 13             	INC	DE
D658 10 FC          	DJNZ	FILL_MEMORY_DE
D65A C9             	RET
D65B                
D65B                C_COPY:
D65B CD 20 D6       	CALL	SETFCB
D65E                
D65E 11 61 F0       	LD	DE,ZERO
D661 CD 9D E0       	CALL	FILEC2
D664 21 6C 00       	LD	HL,FCB2
D667 CD D9 DA       	CALL	S29X1
D66A                
D66A 3E 10          	LD	A,010H
D66C 32 69 00       	LD	(FCB1+13),A
D66F 21 6D 00       	LD	HL,FCB2+1
D672 CD 36 D7       	CALL	CWILD1
D675                COPY0:
D675 CD 33 D7       	CALL	CWILD
D678 21 5C 00       	LD	HL,FCB1
D67B CD E0 D3       	CALL	OPEN
D67E 37             	SCF
D67F                COPY1:
D67F C0             	RET	NZ
D680 CD F3 D3       	CALL	DEFCB
D683                
D683 3A AC EF       	LD	A,(DTA_CCP+13)
D686 CB 67          	BIT	4,A
D688 28 21          	JR	Z,COPY1A
D68A                
D68A 21 5D 00       	LD	HL,FCB1+1
D68D CD DB E4       	CALL	CHKWILD
D690 38 14          	JR	C,COPY9
D692                
D692 3E 20          	LD	A,020H
D694 32 5D 00       	LD	(FCB1+1),A
D697 2A B9 EF       	LD	HL,(DTA_CCP+26)
D69A 23             	INC	HL
D69B 22 6A 00       	LD	(FCB1+14),HL
D69E 18 D5          	JR	COPY0
D6A0                
D6A0                COPY8:
D6A0 CD 94 D8       	CALL	_SYS09		;(BDOS)文字列出力
D6A3 CD 87 D5       	CALL	LTNL
D6A6                COPY9:
D6A6 CD EF D3       	CALL	OPEN2
D6A9 18 D4          	JR	COPY1
D6AB                
D6AB                COPY1A:
D6AB 21 6C 00       	LD	HL,FCB2
D6AE 11 14 F0       	LD	DE,FDRV
D6B1 01 A1 EF       	LD	BC,DTA_CCP+2
D6B4 ED A0          	LDI
D6B6 3E 0B          	LD	A,11
D6B8                COPY2:
D6B8 F5             	PUSH	AF
D6B9 7E             	LD	A,(HL)
D6BA FE 3F          	CP	'?'
D6BC 20 01          	JR	NZ,COPY3
D6BE 0A             	LD	A,(BC)
D6BF                COPY3:
D6BF 12             	LD	(DE),A
D6C0 03             	INC	BC
D6C1 13             	INC	DE
D6C2 23             	INC	HL
D6C3 F1             	POP	AF
D6C4 3D             	DEC	A
D6C5 20 F1          	JR	NZ,COPY2
D6C7 01 05 00       	LD	BC,16-11
D6CA ED B0          	LDIR
D6CC                PUTNAME:
D6CC 21 5D 00       	LD	HL,FCB1+1
D6CF CD DB E4       	CALL	CHKWILD
D6D2 30 0B          	JR	NC,PUTN1
D6D4 21 15 F0       	LD	HL,FDRV+1
D6D7 CD FE D5       	CALL	FPRNT
D6DA 3E 20          	LD	A,020H
D6DC CD A6 DB       	CALL	MSG_A
D6DF                PUTN1:
D6DF 11 14 F0       	LD	DE,FDRV
D6E2 0E 16          	LD	C,016H		;(BDOS)ファイルの作成
D6E4 CD 0E D4       	CALL	SYSTEM0
D6E7 20 48          	JR	NZ,COPYE2
D6E9 67             	LD	H,A		;A=0
D6EA 6F             	LD	L,A
D6EB 22 35 F0       	LD	(FDRV+33),HL	;(FCB)ランダムレコード
D6EE 22 37 F0       	LD	(FDRV+35),HL
D6F1                COPY6:
D6F1 CD 17 D4       	CALL	S27BUF
D6F4 47             	LD	B,A
D6F5 3C             	INC	A
D6F6 28 31          	JR	Z,COPYE
D6F8 7C             	LD	A,H
D6F9 B5             	OR	L
D6FA 28 0C          	JR	Z,COPY7
D6FC 11 14 F0       	LD	DE,FDRV
D6FF 0E 26          	LD	C,026H		;(BDOS)ランダムブロック書き込み
D701 CD 0E D4       	CALL	SYSTEM0
D704 20 23          	JR	NZ,COPYE
D706 10 E9          	DJNZ	COPY6
D708                COPY7:
D708 3A AC EF       	LD	A,(DTA_CCP+13)	;(FCB)属性
D70B 32 21 F0       	LD	(FDRV+13),A
D70E 21 B3 EF       	LD	HL,DTA_CCP+20	;(FCB)タイムスタンプ
D711 11 28 F0       	LD	DE,FDRV+20
D714 01 04 00       	LD	BC,4
D717 ED B0          	LDIR
D719                
D719 11 14 F0       	LD	DE,FDRV
D71C 0E 10          	LD	C,010H		;(BDOS)ファイルのクローズ
D71E CD 0E D4       	CALL	SYSTEM0
D721 20 06          	JR	NZ,COPYE
D723                
D723 11 71 F0       	LD	DE,OK
D726 C3 A0 D6       	JP	COPY8
D729                
D729                COPYE:
D729 11 14 F0       	LD	DE,FDRV
D72C 0E 13          	LD	C,013H		;(BDOS)ファイルの削除
D72E CD 05 00       	CALL	SYSTEM
D731                COPYE2:
D731 37             	SCF
D732 C9             	RET
D733                
D733                CWILD:
D733 21 5D 00       	LD	HL,FCB1+1
D736                CWILD1:
D736 7E             	LD	A,(HL)
D737 FE 20          	CP	020H
D739 C0             	RET	NZ
D73A                CWILD2:
D73A 3E 3F          	LD	A,'?'
D73C 06 0B          	LD	B,11
D73E C3 51 E1       	JP	FILL_MEMORY
D741                
D741                COMTB:
D741 44 20 20 20    	DB	"D   "	;1
D745 F5 D4          	DW	C_DIR
D747 44 49 52 20    	DB	"DIR "	;2
D74B F5 D4          	DW	C_DIR
D74D 43 4F 50 59    	DB	"COPY"	;3
D751 5B D6          	DW	C_COPY
D753 43 44 20 20    	DB	"CD  "	;4
D757 13 D4          	DW	C_CD
D759 44 45 4C 20    	DB	"DEL "	;5
D75D D8 D4          	DW	C_DEL
D75F 50 41 54 48    	DB	"PATH"	;6
D763 8C D5          	DW	C_PATH
D765 52 45 4E 20    	DB	"REN "	;7
D769 E2 D4          	DW	C_REN
D76B 52 45 4D 20    	DB	"REM "	;8
D76F 91 D8          	DW	C_REM
D771                	INCLUDE	"X1DISK2.ASM"
D771                
D771                ;	LSX-Dodgers DISK2
D771                ;	X1/turbo/Z
D771                
D771                ;	GRAPHIC RAM DISK DRIVER
D771                
D771                
D771                GDRD:
D771 C5             	PUSH	BC
D772 CD 9A D7       	CALL	GADR
D775 F1             	POP	AF
D776                GDRD1:
D776 ED A2          	INI
D778 04             	INC	B
D779 0C             	INC	C
D77A 20 FA          	JR	NZ,GDRD1
D77C 04             	INC	B
D77D 13             	INC	DE
D77E 3D             	DEC	A
D77F 20 F5          	JR	NZ,GDRD1
D781                GBANK0:
D781 3A BF F0       	LD	A,(WK1FD0)
D784 E6 EF          	AND	0EFH		;BANK0
D786 18 1D          	JR	S1FD0
D788                
D788                GDWT:
D788 C5             	PUSH	BC
D789 CD 9A D7       	CALL	GADR
D78C F1             	POP	AF
D78D                GDWT1:
D78D 04             	INC	B
D78E ED A3          	OUTI
D790 0C             	INC	C
D791 20 FA          	JR	NZ,GDWT1
D793 04             	INC	B
D794 13             	INC	DE
D795 3D             	DEC	A
D796 20 F5          	JR	NZ,GDWT1
D798 18 E7          	JR	GBANK0
D79A                
D79A                GADR:
D79A 0E 00          	LD	C,0
D79C 7B             	LD	A,E
D79D C6 40          	ADD	A,040H
D79F 47             	LD	B,A
D7A0 3A BF F0       	LD	A,(WK1FD0)
D7A3 F6 10          	OR	010H		;BANK1
D7A5                S1FD0:
D7A5 C5             	PUSH	BC
D7A6 32 BF F0       	LD	(WK1FD0),A
D7A9 01 D0 1F       	LD	BC,01FD0H
D7AC ED 79          	OUT	(C),A
D7AE C1             	POP	BC
D7AF C9             	RET
D7B0                
D7B0                
D7B0                ;	BANK RAM DISK DRIVER
D7B0                
D7B0                BDWT:
D7B0 3E             	DB	03EH	;LD A,??
D7B1 37             	SCF
D7B2 18 02          	JR	BRW
D7B4                
D7B4                BDRD:
D7B4 3E             	DB	03EH	;LD A,??
D7B5 A7             	AND	A
D7B6                BRW:
D7B6 F3             	DI
D7B7 32 E2 D7       	LD	(BRWPAT),A
D7BA ED 73 02 D8    	LD	(BANKSP),SP
D7BE 3A 03 D8       	LD	A,(BANKSP_H)
D7C1 87             	ADD	A,A
D7C2 38 03          	JR	C,BRW0
D7C4 31 CA FF       	LD	SP,EXTSP
D7C7                BRW0:
D7C7 D9             	EXX		;裏レジスタ
D7C8 C5             	 PUSH	 BC
D7C9 D5             	 PUSH	 DE
D7CA 01 00 0B       	 LD	 BC,00B00H	 ;バンクメモリ
D7CD 11 10 10       	 LD	 DE,01010H
D7D0 D9             	 EXX		;表レジスタ
D7D1                BRW1:
D7D1 C5             	PUSH	BC
D7D2 D5             	PUSH	DE
D7D3 EB             	EX	DE,HL
D7D4 29             	ADD	HL,HL
D7D5 29             	ADD	HL,HL
D7D6 7C             	LD	A,H
D7D7 DD 86 0C       	ADD	A,(IX+DPB_MAXCYL)
D7DA E6 0F          	AND	00FH	;バンク
D7DC 65             	LD	H,L
D7DD CB 3C          	SRL	H	;/2
D7DF 2E 00          	LD	L,0
D7E1 D9             	EXX		;裏レジスタ
D7E2 A7             BRWPAT:	 AND	 A	;自己書き換え(AND A:読み出し/SCF:書き込み)
D7E3 38 08          	 JR	 C,BRWT
D7E5 57             	 LD	 D,A	 ;D=バンク
D7E6 D9             	 EXX		;表レジスタ
D7E7 EB             	EX	DE,HL
D7E8 CD 06 D8       	CALL	BTFR
D7EB 18 06          	JR	BRW2
D7ED                BRWT:
D7ED 5F             	 LD	E,A	 ;E=バンク
D7EE D9             	 EXX		;表レジスタ
D7EF CD 06 D8       	CALL	BTFR
D7F2 EB             	EX	DE,HL
D7F3                BRW2:
D7F3 D1             	POP	DE
D7F4 C1             	POP	BC
D7F5 13             	INC	DE
D7F6 10 D9          	DJNZ	BRW1
D7F8                
D7F8 D9             	EXX		;裏レジスタ
D7F9 3E 10          	 LD	 A,10H
D7FB ED 79          	 OUT	 (C),A		;メインメモリに切り替える
D7FD D1             	 POP	 DE
D7FE C1             	 POP	 BC
D7FF D9             	 EXX		;表レジスタ
D800 AF             	XOR	A
D801 31 00 00       	LD	SP,0
D804 00 00 D8 03    BANKSP_H	EQU	$-1
D804 00 00 D8 02    BANKSP		EQU	$-2
D804 FB             	EI
D805 C9             	RET
D806                
D806                ;メインメモリ←→バンクメモリ 512バイトの転送を行う
D806                ; DE:転送元アドレス
D806                ; HL:転送先アドレス
D806                ; 裏BC:バンク切り替えポート(0B00H)
D806                ; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
D806                ; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
D806                
D806                BTFR:
D806 06 00          	LD	B,0	;256回ループ(256*2)
D808                BTFR1:
D808 D9             	EXX		;裏レジスタ
D809 ED 51          	 OUT	 (C),D	 ;BANK(MAIN)
D80B D9             	 EXX		;表レジスタ
D80C 1A             	LD	A,(DE)
D80D 4F             	LD	C,A
D80E 13             	INC	DE
D80F 1A             	LD	A,(DE)
D810 13             	INC	DE
D811 D9             	EXX		;裏レジスタ
D812 ED 59          	 OUT	 (C),E	 ;MAIN(BANK)
D814 D9             	 EXX		;表レジスタ
D815 71             	LD	(HL),C
D816 23             	INC	HL
D817 77             	LD	(HL),A
D818 23             	INC	HL
D819 10 ED          	DJNZ	BTFR1
D81B C9             	RET
D81C                
D81C                ;	EMM DRIVER(CPU)
D81C                
D81C                EDWT:
D81C CD 44 D8       	CALL	EADR
D81F                EDWT0:
D81F F5             	PUSH	AF
D820 AF             	XOR	A
D821                EDWT1:
D821 04             	INC	B
D822 ED A3          	OUTI
D824 04             	INC	B
D825 ED A3          	OUTI
D827 3D             	DEC	A
D828 20 F7          	JR	NZ,EDWT1
D82A 13             	INC	DE
D82B F1             	POP	AF
D82C 3D             	DEC	A
D82D 20 F0          	JR	NZ,EDWT0
D82F C9             	RET
D830                
D830                EDRD:
D830 CD 44 D8       	CALL	EADR
D833                EDRD0:
D833 F5             	PUSH	AF
D834 AF             	XOR	A
D835                EDRD1:
D835 ED A2          	INI
D837 04             	INC	B
D838 ED A2          	INI
D83A 04             	INC	B
D83B 3D             	DEC	A
D83C 20 F7          	JR	NZ,EDRD1
D83E 13             	INC	DE
D83F F1             	POP	AF
D840 3D             	DEC	A
D841 20 F0          	JR	NZ,EDRD0
D843 C9             	RET
D844                
D844                EADR:
D844 C5             	PUSH	BC
D845 D5             	PUSH	DE
D846 EB             	EX	DE,HL
D847 29             	ADD	HL,HL
D848 DD 4E 0D       	LD	C,(IX+DPB_MAXSEC)
D84B DD 46 0C       	LD	B,(IX+DPB_MAXCYL)
D84E 09             	ADD	HL,BC
D84F DD 4E 13       	LD	C,(IX+DPB_UNITNO)
D852 06 0D          	LD	B,00DH
D854 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
D856 0C             	INC	C
D857 ED 69          	OUT	(C),L
D859 0C             	INC	C
D85A ED 61          	OUT	(C),H
D85C 0C             	INC	C
D85D EB             	EX	DE,HL
D85E D1             	POP	DE
D85F F1             	POP	AF
D860 A7             	AND	A	;CF=0
D861 C9             	RET
D862                
D862                
D862                	INCLUDE	"LDOS.ASM"
D862                
D862                ;	LSX-Dodgers OS
D862                
D862                BDOS0:
D862 E5             	PUSH	HL
D863 79             	LD	A,C
D864 FE 3C          	CP	03CH
D866 38 02          	JR	C,DOS1
D868 3E 3C          	LD	A,03CH
D86A                DOS1:
D86A 87             	ADD	A,A
D86B 6F             	LD	L,A
D86C 26 F1          	LD	H,STABLE/256
D86E 7E             	LD	A,(HL)
D86F 2C             	INC	L
D870 66             	LD	H,(HL)
D871 6F             	LD	L,A
D872 E3             	EX	(SP),HL
D873 79             	LD	A,C
D874                ;確認用
D874                ;	LD	(0050H),A
D874 C9             	RET
D875                _DOS2:
D875 FE 5A          	CP	05AH		;(BDOS)カレントディレクトリの変更(_CHDIR)
D877 CA 14 DB       	JP	Z,_SYS5A
D87A FE 5C          	CP	05CH		;(BDOS)ファイル名の解析(_PFILE)
D87C CA D2 DA       	JP	Z,_SYS29
D87F FE 5F          	CP	05FH		;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
D881 CA F4 ED       	JP	Z,_SYS5F
D884 FE 6F          	CP	06FH		;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
D886 20 0A          	JR	NZ,_ERROR
D888 01 1D 01       	LD	BC,VER_6F
D88B 11 58 01       	LD	DE,VER
D88E 21 00 00       	LD	HL,MACD
D891                C_REM:
D891 AF             	XOR	A
D892                _ERROR:
D892 A7             	AND	A
D893 C9             	RET
D894                
D894                _SYS09:		;文字列出力
D894 D5             	PUSH	DE
D895                _SX09:
D895 1A             	LD	A,(DE)
D896 13             	INC	DE
D897 FE 24          	CP	'$'
D899 28 31          	JR	Z,SX0E2
D89B CD A6 DB       	CALL	MSG_A
D89E 18 F5          	JR	_SX09
D8A0                
D8A0                MSX1:
D8A0 CD A6 DB       	CALL	MSG_A
D8A3                MSX:
D8A3 7E             	LD	A,(HL)
D8A4 23             	INC	HL
D8A5 B7             	OR	A
D8A6 20 F8          	JR	NZ,MSX1
D8A8 C9             	RET
D8A9                
D8A9                _SYS0C:		;(BDOS)バージョン番号の獲得
D8A9 21 22 00       	LD	HL,00022H
D8AC 7D             	LD	A,L
D8AD C9             	RET
D8AE                
D8AE                _SYS0D:		;(BDOS)ディスクリセット
D8AE CD DF F0       	CALL	_FFLUSH
D8B1 E5             	PUSH	HL
D8B2 21 80 00       	LD	HL,00080H
D8B5 22 8A F0       	LD	(_DTA),HL
D8B8 E1             	POP	HL
D8B9 D5             	PUSH	DE
D8BA 1E 00          	LD	E,0
D8BC 3E             	DB	03EH	;次の PUSH DE をスキップ
D8BD                
D8BD                _SYS0E:		;(BDOS)カレントドライブの設定
D8BD D5             	PUSH	DE
D8BE 7B             	LD	A,E
D8BF DD E5          	PUSH	IX
D8C1 CD DC F0       	CALL	_GETDPB
D8C4 DD E1          	POP	IX
D8C6 38 04          	JR	C,SX0E2
D8C8 7B             	LD	A,E
D8C9 32 87 F0       	LD	(_DVSW),A
D8CC                SX0E2:
D8CC D1             	POP	DE
D8CD C9             	RET
D8CE                
D8CE                _SYS0F:		;(BDOS)ファイルのオープン
D8CE CD 8E E1       	CALL	SETDRV
D8D1 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D8D4 C6 02          	ADD	A,002H		;Write
D8D6 28 48          	JR	Z,FEND0F
D8D8 CD D7 E4       	CALL	CHKWILDX
D8DB                
D8DB D4 AE E1       	CALL	NC,SOPENX
D8DE                _S16XX:
D8DE 38 40          	JR	C,FEND0F
D8E0                				;Directory location
D8E0 3A 9F F0       	LD	A,(_FILEN)
D8E3 FD 77 19       	LD	(IY+25),A	;(FCB)ディレクトリロケーション
D8E6                ;				_DIRF
D8E6 3A A0 F0       	LD	A,(_DIRF)
D8E9 FD 77 1D       	LD	(IY+29),A	;(FCB)ディレクトリモード
D8EC                ;				_FBPS
D8EC FD 73 1E       	LD	(IY+30),E	;(FCB)ディレクトリポジション
D8EF FD 72 1F       	LD	(IY+31),D
D8F2                ;				Open(Read)
D8F2 FD 36 1C FF    	LD	(IY+28),0FFH	;(FCB)オープンモード
D8F6                ;				FILENAME
D8F6 FD E5          	PUSH	IY
D8F8 D1             	POP	DE
D8F9 13             	INC	DE
D8FA 01 0B 00       	LD	BC,11
D8FD ED B0          	LDIR
D8FF                ;				Attribute
D8FF 7E             	LD	A,(HL)
D900 FD 77 0D       	LD	(IY+13),A	;(FCB)属性(アトリビュート)
D903 11 0B 00       	LD	DE,11		;Reserved
D906 19             	ADD	HL,DE
D907                					;(FCB)ファイルを最後に変更した時刻
D907 11 E4 F1       	LD	DE,SDDATA		;(FCB)ファイルを最後に変更した日付
D90A 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
D90C                S16LOOP:				;(FCB)ファイルのサイズ(バイト単位)
D90C 1A             	LD	A,(DE)
D90D 13             	INC	DE
D90E 32 15 D9       	LD	(S16PAT+2),A
D911 7E             	LD	A,(HL)
D912 23             	INC	HL
D913 FD 77 00       S16PAT:	LD	(IY+0),A
D916 10 F4          	DJNZ	S16LOOP
D918                
D918 AF             	XOR	A
D919 FD 77 0C       	LD	(IY+12),A	;(FCB)カレントブロック
D91C FD 22 C4 D9    	LD	(OFCB+1),IY
D920                FEND0F:
D920 18 45          	JR	FEND10
D922                
D922                _SYS10:		;(BDOS)ファイルのクローズ
D922 CD 8E E1       	CALL	SETDRV
D925 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D928 D6 FE          	SUB	0FEH
D92A 37             	SCF
D92B 3F             	CCF
D92C 20 39          	JR	NZ,FEND10
D92E                _S10A:				;Write
D92E FD 77 0E       	LD	(IY+14),A	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D931 FD 77 0F       	LD	(IY+15),A
D934                
D934 FD 34 1C       	INC	(IY+28)		;0FEH->0FFH ;オープンモード
D937 CD D3 E5       	CALL	SETTMS
D93A                
D93A FD 7E 1D       	LD	A,(IY+29)	;(FCB)ディレクトリモード
D93D 32 A0 F0       	LD	(_DIRF),A
D940 E6 7F          	AND	07FH
D942 32 FE EA       	LD	(_SECPS),A
D945 FD 5E 1E       	LD	E,(IY+30)	;(FCB)ディレクトリポジション
D948 FD 56 1F       	LD	D,(IY+31)
D94B CD E2 E2       	CALL	READ_DIR
D94E 38 17          	JR	C,FEND10
D950                
D950 3A 0C E2       SDECM1:	LD	A,(SDECPAT)	;1セクタ辺りのディレクトリエントリ数
D953 3D              	DEC	A		;1024=01FH / 512=00FH / 256=7
D954 FD A6 19       	AND	(IY+25)		;(FCB)ディレクトリロケーション
D957 6F             	LD	L,A
D958 26 00          	LD	H,0
D95A 29             	ADD	HL,HL		;*2
D95B 29             	ADD	HL,HL		;*4
D95C 29             	ADD	HL,HL		;*8
D95D 29             	ADD	HL,HL		;*16
D95E 29             	ADD	HL,HL		;*32
D95F ED 4B 7E F1    	LD	BC,(_DTBUF)
D963 09             	ADD	HL,BC
D964                
D964 CD E7 E4       	CALL	SDIRENT
D967                FEND10:
D967 18 42          	JR	FEND
D969                
D969                _SYS11:		;(BDOS)最初のファイルの検索
D969 CD 8E E1       	CALL	SETDRV
D96C CD DB E1       	CALL	SOPEN
D96F                _S12X1:
D96F 38 3A          	JR	C,FEND
D971 CD 7B E2       	CALL	SOPENE2
D974 ED 5B 8A F0    	LD	DE,(_DTA)
D978 3A 88 F0       	LD	A,(_DRV)
D97B 3C             	INC	A
D97C 12             	LD	(DE),A
D97D D5             	PUSH	DE
D97E 13             	INC	DE
D97F 01 20 00       	LD	BC,32
D982 ED B0          	LDIR
D984 FD 6E 0E       	LD	L,(IY+14)	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D987 FD 66 0F       	LD	H,(IY+15)
D98A 22 F4 F1       	LD	(SCDIR),HL
D98D 2A 9A F0       	LD	HL,(_FBPS)
D990 22 F6 F1       	LD	(SFBPS),HL
D993 2A 9F F0       	LD	HL,(_FILEN)
D996 7C             	LD	A,H
D997 B7             	OR	A
D998 28 06          	JR	Z,_S12DIR
D99A 3A FE EA       	LD	A,(_SECPS)
D99D F6 80          	OR	080H
D99F 67             	LD	H,A
D9A0                _S12DIR:
D9A0 22 F8 F1       	LD	(SFNDF),HL	;Directory position and Flags
D9A3 E1             	POP	HL
D9A4 11 39 F0       	LD	DE,SFILE
D9A7 0E 21          	LD	C,33
D9A9                _S11B:
D9A9 ED B0          	LDIR
D9AB                FEND:
D9AB 9F             	SBC	A,A		;CF=0 A=0 : CF=1 A=0FFH
D9AC                FENDE:
D9AC FD E1          	POP	IY
D9AE C1             	POP	BC
D9AF D1             	POP	DE
D9B0 E1             	POP	HL
D9B1 C9             	RET
D9B2                
D9B2                _SYS12:		;(BDOS)次のファイルの検索
D9B2 E5             	PUSH	HL
D9B3 D5             	PUSH	DE
D9B4 C5             	PUSH	BC
D9B5 FD E5          	PUSH	IY
D9B7 CD 3F E2       	CALL	NOPEN
D9BA 18 B3          	JR	_S12X1
D9BC                
D9BC                _S16K:
D9BC FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D9BF FE FD          	CP	0FDH		;Device(0FDH)
D9C1 37             	SCF
D9C2 C8             	RET	Z
D9C3                
D9C3 11 00 00       OFCB:	LD	DE,0
D9C6 D5             	PUSH	DE
D9C7 06 1A          	LD	B,26		;First cluster
D9C9                S16K1:
D9C9 13             	INC	DE
D9CA 23             	INC	HL
D9CB 10 FC          	DJNZ	S16K1
D9CD                
D9CD 1A             	LD	A,(DE)
D9CE BE             	CP	(HL)
D9CF 20 13          	JR	NZ,S16K2
D9D1 13             	INC	DE
D9D2 23             	INC	HL
D9D3 1A             	LD	A,(DE)
D9D4 BE             	CP	(HL)
D9D5 20 0D          	JR	NZ,S16K2
D9D7                
D9D7 E1             	POP	HL
D9D8 FD E5          	PUSH	IY
D9DA D1             	POP	DE
D9DB 1A             	LD	A,(DE)		;Drive
D9DC BE             	CP	(HL)
D9DD 20 06          	JR	NZ,S16K3
D9DF                				;ここはCFが必ず0
D9DF ED 52          	SBC	HL,DE		;CP HL,DE
D9E1 37             	SCF
D9E2 C0             	RET	NZ
D9E3 E5             	PUSH	HL
D9E4                S16K2:
D9E4 E1             	POP	HL
D9E5                S16K3:
D9E5 FD E5          	PUSH	IY
D9E7 D1             	POP	DE
D9E8                _SYS13:		;(BDOS)ファイルの削除
D9E8 CD 8E E1       	CALL	SETDRV
D9EB CD 07 E4       	CALL	KILL
D9EE                FEND13:
D9EE 18 BB          	JR	FEND
D9F0                
D9F0                _SYS14:		;(BDOS)シーケンシャルな読み出し
D9F0 CD 8E E1       	CALL	SETDRV
D9F3 CD 3F E6       	CALL	INIT_SEQ
D9F6                SREAD:
D9F6 CD 87 E6       	CALL	RB_READ
D9F9                
D9F9 C6 01          	ADD	A,001H
D9FB 38 AE          	JR	C,FEND
D9FD                
D9FD 7D             	LD	A,L
D9FE D6 01          	SUB	001H
DA00                FENDX:
DA00 9F             	SBC	A,A
DA01 E6 03          	AND	3
DA03 1F             	RRA
DA04 18 A6          	JR	FENDE
DA06                
DA06                _SYS15:		;(BDOS)シーケンシャルな書き込み
DA06 CD 8E E1       	CALL	SETDRV
DA09 CD 3F E6       	CALL	INIT_SEQ
DA0C                SWRITE:
DA0C CD 80 E6       	CALL	RB_WRITE
DA0F                
DA0F C6 FF          	ADD	A,0FFH
DA11 18 ED          	JR	FENDX
DA13                
DA13                _SYS17:		;(BDOS)ファイル名の変更
DA13 CD 8E E1       	CALL	SETDRV
DA16 CD 5D E4       	CALL	NAME
DA19 18 D3          	JR	FEND13
DA1B                
DA1B                _SYS16:		;(BDOS)ファイルの作成
DA1B CD 8E E1       	CALL	SETDRV
DA1E                
DA1E CD D7 E4       	CALL	CHKWILDX
DA21 38 CB          	JR	C,FEND13
DA23 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
DA26 FE 05          	CP	5
DA28 28 05          	JR	Z,_S16X2
DA2A FE 21          	CP	021H
DA2C DA EE D9       	JP	C,FEND13
DA2F                _S16X2:
DA2F                ;				Clear FCB
DA2F FD E5          	PUSH	IY
DA31 E1             	POP	HL
DA32 01 10 00       	LD	BC,16
DA35 09             	ADD	HL,BC
DA36                _S16X1:
DA36 70             	LD	(HL),B		;B=0
DA37 23             	INC	HL
DA38 0D             	DEC	C
DA39 20 FB          	JR	NZ,_S16X1
DA3B                
DA3B CD D8 E5       	CALL	SETTMSX
DA3E FD 36 0D FF    	LD	(IY+13),0FFH	;(FCB)Attribute
DA42 CD AE E1       	CALL	SOPENX
DA45 3F             	CCF
DA46 CC BC D9       	CALL	Z,_S16K
DA49 D4 8C E2       	CALL	NC,COPEN
DA4C D4 E7 E4       	CALL	NC,SDIRENT
DA4F C3 DE D8       	JP	_S16XX
DA52                
DA52                _SYS21:		;(BDOS)ランダムな読み出し
DA52 CD 8E E1       	CALL	SETDRV
DA55 CD 23 E6       	CALL	INIT_RND
DA58 18 9C          	JR	SREAD
DA5A                
DA5A                _SYS22:		;(BDOS)ランダムな書き込み
DA5A                _SYS28:		;(BDOS)ランダムな書き込み・その2
DA5A CD 8E E1       	CALL	SETDRV
DA5D CD 23 E6       	CALL	INIT_RND
DA60 18 AA          	JR	SWRITE
DA62                
DA62                _SYS18:		;(BDOS)ログインベクトルの獲得
DA62 21 FF 00       	LD	HL,000FFH
DA65 AF             	XOR	A
DA66 C9             	RET
DA67                
DA67                _SYS19:		;(BDOS)カレントドライブ番号の獲得
DA67 3A 87 F0       	LD	A,(_DVSW)
DA6A A7             	AND	A
DA6B C9             	RET
DA6C                
DA6C                _SYS1A:		;(BDOS)DTAの設定
DA6C ED 53 8A F0    	LD	(_DTA),DE
DA70 AF             	XOR	A
DA71 C9             	RET
DA72                
DA72                _SYS1B:		;(BDOS)ディスク情報の獲得
DA72 7B             	LD	A,E
DA73 CD A1 E1       	CALL	GETDRV
DA76 CD DC F0       	CALL	_GETDPB
DA79 D4 E2 F0       	CALL	NC,_RDFATX
DA7C 21 00 00       	LD	HL,0
DA7F D4 B1 E5       	CALL	NC,DSKF
DA82                
DA82 ED 5B B2 E5    	LD	DE,(MAXCLP)	;DPB_MAXCL-1
DA86 1B             	DEC	DE		;DE←クラスタの総数
DA87 FD 2A 7C F1    	LD	IY,(_FATBF)	;IY←メモリ上のFATの先頭アドレス
DA8B 9F             	SBC	A,A
DA8C D8             	RET	C
DA8D 4F             	LD	C,A		;C=0
DA8E DD 7E 0F       	LD	A,(IX+DPB_BPS)
DA91 E6 07          	AND	7
DA93 47             	LD	B,A
DA94 DD 7E 07       	LD	A,(IX+DPB_SECPCL)
DA97 C9             	RET
DA98                
DA98                _SYS1D:		;(BDOS)書き込みが禁止されているディスクの調査
DA98 AF             	XOR	A
DA99 67             	LD	H,A
DA9A 6F             	LD	L,A
DA9B C9             	RET
DA9C                
DA9C                _SYS1F:		;(BDOS)ディスク装置のパラメータの読み出し
DA9C 21 00 F2       	LD	HL,_DEVICE
DA9F 7B             	LD	A,E
DAA0 C3 DC F0       	JP	_GETDPB
DAA3                
DAA3                _SYS23:		;(BDOS)ファイルサイズの獲得
DAA3 E5             	PUSH	HL
DAA4 2A 1E F1       	LD	HL,(STABLE+2*00FH)	;ファイルのオープン
DAA7 CD 0F 00       	CALL	JP_HL
DAAA 38 1B          	JR	C,_S23X1
DAAC                
DAAC D5             	PUSH	DE		;EX DE,IY
DAAD FD E3          	EX	(SP),IY		;
DAAF                ;	POP	DE		;
DAAF                ;	PUSH	DE		;DEを破壊しないように注意vv
DAAF FD 7E 10       	LD	A,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
DAB2 FD 6E 11       	LD	L,(IY+17)	;
DAB5 FD 66 12       	LD	H,(IY+18)	;
DAB8 C5             	PUSH	BC		;
DAB9 FD 46 13       	LD	B,(IY+19)	;
DABC CD 15 E6       	CALL	GET_CPM_R_SIZE
DABF C1             	POP	BC
DAC0                _S24X1:
DAC0 CD 35 E6       	CALL	SET_RR_AHL
DAC3                ;	POP	DE		;^^^^^^^^^^^^^^^^^^^^^^^^
DAC3                ;	PUSH	DE		;EX DE,IY
DAC3 FD E3          	EX	(SP),IY		;
DAC5 D1             	POP	DE		;
DAC6                
DAC6 AF             	XOR	A
DAC7                _S23X1:
DAC7 E1             	POP	HL
DAC8 C9             	RET
DAC9                
DAC9                _SYS24:		;(BDOS)ランダムレコードフィールドの設定
DAC9 E5             	PUSH	HL
DACA D5             	PUSH	DE		;EX DE,IY
DACB FD E3          	EX	(SP),IY		;
DACD                ;	POP	DE		;
DACD                ;	PUSH	DE		;DEを破壊しないように注意vv
DACD CD 47 E6       	CALL	GETSEQ
DAD0 18 EE          	JR	_S24X1		;^^^^^^^^^^^^^^^^^^^^^^^^
DAD2                
DAD2                _SYS29:		;(BDOS)ファイル名の解析(_PPATH)
DAD2 C5             	PUSH	BC
DAD3 E5             	PUSH	HL
DAD4 CD A5 E0       	CALL	FILE
DAD7 E1             	POP	HL
DAD8 C1             	POP	BC
DAD9                S29X1:
DAD9 C5             	PUSH	BC
DADA D5             	PUSH	DE
DADB E5             	PUSH	HL
DADC EB             	EX	DE,HL
DADD AF             	XOR	A
DADE 32 21 F0       	LD	(FDRV+13),A
DAE1 21 14 F0       	LD	HL,FDRV
DAE4 01 10 00       	LD	BC,16
DAE7 ED B0          	LDIR
DAE9 E1             	POP	HL
DAEA D1             	POP	DE
DAEB C1             	POP	BC
DAEC C9             	RET
DAED                
DAED                _SYS30:		;(BDOS)論理セクタを用いた書き込み
DAED C5             	PUSH	BC
DAEE 01 98 EC       	LD	BC,DWT24B
DAF1 18 04          	JR	S2FX
DAF3                _SYS2F:
DAF3 C5             	PUSH	BC
DAF4 01 88 EC       	LD	BC,DRD24B
DAF7                S2FX:
DAF7 ED 43 0D DB    	LD	(S2FPAT+1),BC
DAFB CD DF F0       	CALL	_FFLUSH
DAFE                
DAFE D5             	PUSH	DE
DAFF E5             	PUSH	HL
DB00 7D             	LD	A,L		;Drive
DB01 CD D9 F0       	CALL	_CHGDRV
DB04 38 09          	JR	C,S30X2
DB06 44             	LD	B,H		;Number of clusters
DB07 2A 8A F0       	LD	HL,(_DTA)
DB0A                
DB0A 0E 00          	LD	C,0
DB0C CD 88 EC       S2FPAT:	CALL	DRD24B
DB0F                S30X2:
DB0F E1             	POP	HL
DB10 D1             	POP	DE
DB11 C1             	POP	BC
DB12 9F             	SBC	A,A
DB13 C9             	RET
DB14                
DB14                _SYS5A:		;(BDOS)カレントディレクトリの変更
DB14 C5             	PUSH	BC
DB15 D5             	PUSH	DE
DB16 E5             	PUSH	HL
DB17 CD 9A E0       	CALL	FILEC
DB1A 21 00 00       	LD	HL,0
DB1D 11 14 F0       	LD	DE,FDRV
DB20 2A 4E F1       	LD	HL,(STABLE+2*027H)	;ランダムブロック読み込み
DB23 CD 0F 00       	CALL	JP_HL
DB26 18 E7          	JR	S30X2
DB28                	INCLUDE	"X1IO.ASM"
DB28                
DB28                ;	LSX-Dodgers IO
DB28                ;	X1/turbo/Z
DB28                
DB28 00 00 D8 92    _SYS04	EQU	_ERROR		;(BDOS)外部出力
DB28 00 00 D8 92    _SYS05	EQU	_ERROR		;(BDOS)プリンタ出力
DB28 00 00 D8 92    _SYS1C	EQU	_ERROR		;(BDOS)ディスクの書き込み禁止化
DB28 00 00 D8 92    _SYS1E	EQU	_ERROR		;(BDOS)ファイル属性の設定
DB28 00 00 D8 92    _SYS20	EQU	_ERROR		;(BDOS)利用者番号の設定と読み出し
DB28 00 00 D8 92    _SYS2E	EQU	_ERROR		;(BDOS)ベリファイ・フラグの設定
DB28                
DB28                BIOS:
DB28 E5             	PUSH	HL
DB29 21 10 80       	LD	HL,08010H
DB2C 39             	ADD	HL,SP
DB2D E1             	POP	HL
DB2E 30 0E          	JR	NC,BIOS2
DB30                BIOS1:
DB30 CD 38 DB       	CALL	BIOS3
DB33 06 1E          	LD	B,01EH
DB35 ED 79          	OUT	(C),A
DB37 C9             	RET
DB38                BIOS3:
DB38 C5             	PUSH	BC
DB39 06 1D          	LD	B,01DH
DB3B ED 79          	OUT	(C),A
DB3D C9             	RET
DB3E                BIOS2:
DB3E ED 73 49 DB    	LD	(BIOS_SP),SP	;スタックがBIOS-ROMと被っている場合
DB42 31 CA FF       	LD	SP,EXTSP
DB45 CD 30 DB       	CALL	BIOS1
DB48 31 00 00       	LD	SP,0
DB4B 00 00 DB 49    BIOS_SP	EQU	$-2
DB4B C9             	RET
DB4C                
DB4C                INT:
DB4C F5             	PUSH	AF
DB4D E5             	PUSH	HL
DB4E C5             	PUSH	BC
DB4F                
DB4F CD DC DE       	CALL	IN49SB
DB52 67             	LD	H,A
DB53 CD DC DE       	CALL	IN49SB
DB56 6F             	LD	L,A
DB57                SCEXE:
DB57 22 92 F0       	LD	(_KEYD),HL
DB5A CD 63 DB       	CALL	KEYSET1
DB5D                
DB5D C1             	POP	BC
DB5E                INTPE:
DB5E E1             	POP	HL
DB5F                INTPE2:
DB5F F1             	POP	AF
DB60                INTCTCE:
DB60 FB             	EI
DB61 ED 4D          	RETI
DB63                
DB63                KEYSET1:
DB63 F5             	PUSH	AF
DB64 AF             	XOR	A
DB65 32 00 DC       	LD	(FLGET_SWC),A
DB68 F1             	POP	AF
DB69 B7             	OR	A
DB6A C8             	RET	Z
DB6B                
DB6B CB 6C          	BIT	5,H
DB6D 28 06          	JR	Z,KEYSET
DB6F 3A 95 F0       	LD	A,(_KEYSP+1)
DB72 32 15 DC       	LD	(KEYREPEAT_SWC),A
DB75                KEYSET:
DB75 7D             	LD	A,L
DB76 CB 74          	BIT	6,H
DB78 C0             	RET	NZ
DB79                KEYBS:
DB79 B7             	OR	A
DB7A C8             	RET	Z
DB7B                KEYBS1:
DB7B CD 93 DB       	CALL	KEYBC_IFBREAK
DB7E E5             	PUSH	HL
DB7F F5             	PUSH	AF
DB80 2A 90 F0       	LD	HL,(_KEYPS)
DB83 2C             	INC	L
DB84 CB AD          	RES	5,L
DB86 7D             	LD	A,L
DB87 BC             	CP	H
DB88 28 15          	JR	Z,POP_AF_HL_SCF_RET
DB8A 32 90 F0       	LD	(_KEYPS),A
DB8D 26 FF          	LD	H,KEYBF/256
DB8F F1             	POP	AF
DB90 77             	LD	(HL),A
DB91 E1             	POP	HL
DB92 C9             	RET
DB93                KEYBC_IFBREAK:
DB93 FE 03          	CP	3
DB95 C0             	RET	NZ
DB96                KEYBC:
DB96 E5             	PUSH	HL
DB97 21 00 00       	LD	HL,0
DB9A 22 90 F0       	LD	(_KEYPS),HL
DB9D E1             	POP	HL
DB9E C9             	RET
DB9F                
DB9F                POP_AF_HL_SCF_RET:
DB9F F1             	POP	AF
DBA0 E1             	POP	HL
DBA1 37             	SCF
DBA2 C9             	RET
DBA3                
DBA3                _SYS01:		;(BDOS)コンソール入力
DBA3 CD 09 F0       	CALL	_SYS07
DBA6                MSG_A:
DBA6 F5             	PUSH	AF
DBA7 D5             	PUSH	DE
DBA8 5F             	LD	E,A
DBA9 CD AF DB       	CALL	_SYS02
DBAC D1             	POP	DE
DBAD F1             	POP	AF
DBAE C9             	RET
DBAF                
DBAF                _SYS02:		;(BDOS)コンソール出力
DBAF CD C1 DB       	CALL	BREAK
DBB2 18 05          	JR	PRINTX
DBB4                
DBB4                _SYS06:		;(BDOS)コンソール直接入出力
DBB4 7B             	LD	A,E
DBB5 3C             	INC	A
DBB6 CA CA F0       	JP	Z,_INKEY
DBB9                PRINTX:
DBB9 C3 CD F0       	JP	_PRINT
DBBC                
DBBC                _SYS08:		;(BDOS)エコーなしコンソール入力
DBBC CD 09 F0       	CALL	_SYS07
DBBF 18 04          	JR	BREAK1
DBC1                BREAK:
DBC1 FB             	EI
DBC2 3A 92 F0       	LD	A,(_KEYD)
DBC5                BREAK1:
DBC5 FE 03          	CP	3		;CTRL+C
DBC7 CC F4 F0       	CALL	Z,_BREAK
DBCA FE 13          	CP	013H		;CTRL+S
DBCC C0             	RET	NZ
DBCD                
DBCD                PAUSE:
DBCD CD 96 DB       	CALL	KEYBC
DBD0                
DBD0                FLGET:
DBD0 CD DF F0       	CALL	_FFLUSH
DBD3 C5             	PUSH	BC
DBD4 E5             	PUSH	HL
DBD5 ED 4B 8E F0    	LD	BC,(_TXADR)
DBD9 CB E8          	SET	5,B
DBDB ED 60          	IN	H,(C)
DBDD                FLGET1:
DBDD 3A 93 F0       	LD	A,(_KEYD+1)
DBE0 0F             	RRCA
DBE1 0F             	RRCA
DBE2 E6 10          	AND	010H
DBE4 F6 08          	OR	8
DBE6 ED 68          	IN	L,(C)
DBE8 B5             	OR	L
DBE9 ED 79          	OUT	(C),A
DBEB                FLGETR:
DBEB CD CA F0       	CALL	_INKEY
DBEE 20 32          	JR	NZ,FLGETE
DBF0 CB 5D          	BIT	3,L
DBF2 28 E9          	JR	Z,FLGET1
DBF4 3A 92 F0       	LD	A,(_KEYD)
DBF7 B7             	OR	A
DBF8 28 E3          	JR	Z,FLGET1
DBFA                
DBFA 3E 1A          	LD	A,01AH
DBFC 32 00 DC       	LD	(FLGET_SWC),A
DBFF                FLGET2:
DBFF 3E 1A          	LD	A,1AH
DC01 00 00 DC 00    FLGET_SWC	EQU	$-1
DC01 B7             	OR	A
DC02 28 E7          	JR	Z,FLGETR
DC04 DB 01          	IN	A,(01H)
DC06 87             	ADD	A,A
DC07 30 F6          	JR	NC,FLGET2
DC09                FLGET3:
DC09 3A 00 DC       	LD	A,(FLGET_SWC)
DC0C B7             	OR	A
DC0D 28 DC          	JR	Z,FLGETR
DC0F DB 01          	IN	A,(01H)
DC11 87             	ADD	A,A
DC12 38 F5          	JR	C,FLGET3
DC14                
DC14 3E 00          	LD	A,0
DC16 00 00 DC 15    KEYREPEAT_SWC	EQU $-1
DC16 B7             	OR	A
DC17 28 06          	JR	Z,FLGET4
DC19 3D             	DEC	A
DC1A 32 15 DC       	LD	(KEYREPEAT_SWC),A
DC1D 18 E0          	JR	FLGET2
DC1F                FLGET4:
DC1F 3A 92 F0       	LD	A,(_KEYD)
DC22                FLGETE:
DC22 ED 61          	OUT	(C),H
DC24 E1             	POP	HL
DC25 C1             	POP	BC
DC26 C9             	RET
DC27                
DC27                _SYS0A:		;(BDOS)文字列入力
DC27 C5             	PUSH	BC
DC28 E5             	PUSH	HL
DC29 D5             	PUSH	DE
DC2A CD 29 E0       	CALL	GETL
DC2D 11 20 FF       	LD	DE,KBUF
DC30 E1             	POP	HL
DC31 E5             	PUSH	HL
DC32 0E 00          	LD	C,0
DC34 30 04          	JR	NC,SAX0
DC36 23             	INC	HL
DC37 23             	INC	HL
DC38 18 08          	JR	SAX4
DC3A                SAX0:
DC3A 46             	LD	B,(HL)
DC3B 23             	INC	HL
DC3C                SAX1:
DC3C 23             	INC	HL
DC3D 1A             	LD	A,(DE)
DC3E 13             	INC	DE
DC3F B7             	OR	A
DC40 20 04          	JR	NZ,SAX2
DC42                SAX4:
DC42 36 0D          	LD	(HL),00DH
DC44 18 04          	JR	SAX3
DC46                SAX2:
DC46 77             	LD	(HL),A
DC47 0C             	INC	C
DC48 10 F2          	DJNZ	SAX1
DC4A                SAX3:
DC4A D1             	POP	DE
DC4B 79             	LD	A,C
DC4C 13             	INC	DE
DC4D 12             	LD	(DE),A
DC4E 1B             	DEC	DE
DC4F E1             	POP	HL
DC50 C1             	POP	BC
DC51 A7             	AND	A
DC52 C9             	RET
DC53                
DC53                _SYS0B:		;(BDOS)コンソール状態のチェック
DC53 CD C1 DB       	CALL	BREAK
DC56 3A 92 F0       	LD	A,(_KEYD)
DC59 B7             	OR	A
DC5A C8             	RET	Z
DC5B                CONSTX:
DC5B CD DF F0       	CALL	_FFLUSH
DC5E E5             	PUSH	HL
DC5F 2A 90 F0       	LD	HL,(_KEYPS)
DC62 7C             	LD	A,H
DC63 AD             	XOR	L
DC64 E1             	POP	HL
DC65 C6 FF          	ADD	A,0FFH
DC67 9F             	SBC	A,A
DC68 C9             	RET
DC69                
DC69                _SYS2A:		;(BDOS)日付の獲得
DC69 C5             	PUSH	BC
DC6A 3E ED          	LD	A,0EDH		;Read calendar
DC6C CD F7 DE       	CALL	COMOUT
DC6F CD A1 DC       	CALL	IN49SB_BCD	;YY
DC72 6F             	LD	L,A
DC73 26 00          	LD	H,0
DC75                ;	LD	DE,1900		;0076CH
DC75                ;	CP	90		;90以上は1900年代 1990-1999
DC75                ;	JR	NC,RDDATE1	;90未満は2000年代 2000-2089
DC75                ;	LD	E,0D0H		;2000 & 0FFH D=007H
DC75 11 D0 07       	LD	DE,2000		;すべて2000年代で処理 2000-2099
DC78                RDDATE1:
DC78 19             	ADD	HL,DE
DC79 CD DC DE       	CALL	IN49SB		;MW
DC7C 57             	LD	D,A
DC7D CD A1 DC       	CALL	IN49SB_BCD	;DD
DC80 5F             	LD	E,A
DC81 7A             	LD	A,D
DC82 06 04          	LD	B,4
DC84                RDDATE2:
DC84 CB 3A          	SRL	D
DC86 10 FC          	DJNZ	RDDATE2
DC88 C1             	POP	BC
DC89 E6 07          	AND	7
DC8B C9             	RET
DC8C                
DC8C                _SYS2C:		;(BDOS)時刻の獲得
DC8C C5             	PUSH	BC
DC8D 3E EF          	LD	A,0EFH		;Read time
DC8F CD F7 DE       	CALL	COMOUT
DC92 CD A1 DC       	CALL	IN49SB_BCD	;TT
DC95 67             	LD	H,A
DC96 CD A1 DC       	CALL	IN49SB_BCD	;MM
DC99 6F             	LD	L,A
DC9A CD A1 DC       	CALL	IN49SB_BCD	;SS
DC9D 57             	LD	D,A
DC9E C1             	POP	BC
DC9F AF             	XOR	A
DCA0 C9             	RET
DCA1                
DCA1                IN49SB_BCD:
DCA1 CD DC DE       	CALL	IN49SB
DCA4                ;------------------------
DCA4                ;BCDの10進数化
DCA4                ;in
DCA4                ;	A  : BCD
DCA4                ;out
DCA4                ;	A  : 10進数
DCA4                ;------------------------
DCA4 4F             	LD	C,A
DCA5 E6 F0          	AND	0F0H	;10の位
DCA7 0F             	RRCA
DCA8 47             	LD	B,A
DCA9 0F             	RRCA
DCAA 0F             	RRCA
DCAB 80             	ADD	A,B
DCAC 47             	LD	B,A
DCAD 79             	LD	A,C
DCAE E6 0F          	AND	00FH	;1の位
DCB0 80             	ADD	A,B
DCB1 C9             	RET
DCB2                
DCB2                ESC1:
DCB2 7B             	LD	A,E
DCB3 FE 41          	CP	'A'
DCB5 CA FA DD       	JP	Z,CTRL1E
DCB8 FE 42          	CP	'B'
DCBA CA 62 DF       	JP	Z,CTRL1F
DCBD FE 43          	CP	'C'
DCBF CA 05 DE       	JP	Z,CTRL1C
DCC2 FE 44          	CP	'D'
DCC4 CA F1 DD       	JP	Z,CTRL1D
DCC7 FE 45          	CP	'E'
DCC9 28 02          	JR	Z,CT0CX
DCCB FE 6A          	CP	'j'
DCCD                CT0CX:
DCCD CA 35 DF       	JP	Z,CTRL0C
DCD0 FE 48          	CP	'H'
DCD2 CA 7F DE       	JP	Z,CTRL0B
DCD5 FE 4A          	CP	'J'
DCD7 CA 38 DF       	JP	Z,CTRL06
DCDA FE 4B          	CP	'K'
DCDC 28 07          	JR	Z,CT05X
DCDE FE 4C          	CP	'L'
DCE0 CA 77 DF       	JP	Z,CTRL0E
DCE3 FE 54          	CP	'T'
DCE5                CT05X:
DCE5 CA 3E DE       	JP	Z,CTRL05
DCE8 FE 78          	CP	'x'
DCEA 28 04          	JR	Z,ESC1X
DCEC FE 79          	CP	'y'
DCEE 20 02          	JR	NZ,ESC1Y
DCF0                ESC1X:
DCF0 36 01          	LD	(HL),1
DCF2                ESC1Y:
DCF2 FE 3D          	CP	'='
DCF4 28 04          	JR	Z,ESC1W
DCF6 FE 59          	CP	'Y'
DCF8 20 02          	JR	NZ,ESC1Z
DCFA                ESC1W:
DCFA 36 02          	LD	(HL),2
DCFC                ESC1Z:
DCFC FE 20          	CP	020H
DCFE 38 02          	JR	C,ESC1C
DD00 87             	ADD	A,A
DD01 D0             	RET	NC
DD02                ESC1C:
DD02 E1             	POP	HL
DD03                ANK:
DD03 ED 4B 8E F0    	LD	BC,(_TXADR)
DD07 78             	LD	A,B
DD08 F6 38          	OR	038H
DD0A 47             	LD	B,A
DD0B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DD0D CB 98          	RES	3,B
DD0F ED 59          	OUT	(C),E		;Text
DD11                KANJIE:
DD11 CD C6 DD       	CALL	PRINTE7
DD14                PRINTE5:
DD14 E1             	POP	HL
DD15 C1             	POP	BC
DD16 AF             	XOR	A
DD17 C9             	RET
DD18                
DD18                ESC:
DD18 21 14 DD       	LD	HL,PRINTE5
DD1B E5             	PUSH	HL
DD1C 21 3E DD       	LD	HL,ESCFLG+1
DD1F 36 00          	LD	(HL),0
DD21 3D             	DEC	A
DD22 28 8E          	JR	Z,ESC1
DD24 3D             	DEC	A
DD25 20 09          	JR	NZ,ESC2
DD27 36 03          	LD	(HL),3
DD29 7B             	LD	A,E
DD2A D6 20          	SUB	020H
DD2C 32 33 DD       	LD	(ESCYP+1),A
DD2F C9             	RET
DD30                ESC2:
DD30 3D             	DEC	A
DD31 C0             	RET	NZ
DD32 26 00          ESCYP:	LD	H,0
DD34 7B             	LD	A,E
DD35 D6 20          	SUB	020H
DD37 6F             	LD	L,A
DD38 C3 D6 F0       	JP	_LOC
DD3B                
DD3B                PRINT:
DD3B C5             	PUSH	BC
DD3C E5             	PUSH	HL
DD3D 3E 00          ESCFLG:	LD	A,000H
DD3F B7             	OR	A
DD40 20 D6          	JR	NZ,ESC
DD42                
DD42 3E 1F          	LD	A,01FH
DD44 BB             	CP	E
DD45 30 20          	JR	NC,CTRL
DD47 01 00 DF       INSFLG:	LD	BC,INSERT
DD4A                
DD4A 3A 18 00       	LD	A,(00018H)
DD4D 3C             	INC	A
DD4E 28 B3          	JR	Z,ANK
DD50 3E 00          KANFLG:	LD	A,000H
DD52 B7             	OR	A
DD53 20 25          	JR	NZ,KANJI2
DD55 7B             	LD	A,E
DD56 FE 80          	CP	080H
DD58 38 A9          	JR	C,ANK
DD5A FE A0          	CP	0A0H
DD5C 38 04          	JR	C,KANJI1
DD5E FE E0          	CP	0E0H
DD60 38 A1          	JR	C,ANK
DD62                KANJI1:
DD62 32 51 DD       	LD	(KANFLG+1),A
DD65 18 AD          	JR	PRINTE5
DD67                
DD67                CTRL:
DD67 CD AD DD       	CALL	KANCLR
DD6A 7B             	LD	A,E
DD6B 87             	ADD	A,A
DD6C F6 80          	OR	080H
DD6E 6F             	LD	L,A
DD6F 26 F1          	LD	H,CTRLTB/256
DD71 7E             	LD	A,(HL)
DD72 2C             	INC	L
DD73 66             	LD	H,(HL)
DD74 6F             	LD	L,A
DD75 CD 0F 00       	CALL	JP_HL
DD78 18 9A          	JR	PRINTE5
DD7A                
DD7A                KANJI2:
DD7A D5             	PUSH	DE
DD7B 57             	LD	D,A
DD7C 01 81 2F       	LD	BC,02F81H	;SFTJIS
DD7F DF             	RST	018H
DD80 01 C3 2F       	LD	BC,02FC3H	;Instead or JISVRM
DD83 DF             	RST	018H
DD84                
DD84 ED 4B 8E F0    	LD	BC,(_TXADR)
DD88 78             	LD	A,B
DD89 F6 38          	OR	038H
DD8B 47             	LD	B,A
DD8C ED 51          	OUT	(C),D		;kanji
DD8E CB 98          	RES	3,B
DD90 ED 59          	OUT	(C),E		;Text
DD92 CD C6 DD       	CALL	PRINTE7
DD95 ED 4B 8E F0    	LD	BC,(_TXADR)
DD99 78             	LD	A,B
DD9A F6 38          	OR	038H
DD9C 47             	LD	B,A
DD9D CB F2          	SET	6,D
DD9F ED 51          	OUT	(C),D		;Kanji
DDA1 CB 98          	RES	3,B
DDA3 ED 59          	OUT	(C),E		;Text
DDA5 D1             	POP	DE
DDA6 AF             	XOR	A
DDA7 32 51 DD       	LD	(KANFLG+1),A
DDAA C3 11 DD       	JP	KANJIE
DDAD                
DDAD                KANCLR:
DDAD 3A 51 DD       	LD	A,(KANFLG+1)
DDB0 B7             	OR	A
DDB1 C8             	RET	Z
DDB2 ED 4B 8E F0    	LD	BC,(_TXADR)
DDB6 78             	LD	A,B
DDB7 F6 38          	OR	038H
DDB9 47             	LD	B,A
DDBA AF             	XOR	A
DDBB 32 51 DD       	LD	(KANFLG+1),A
DDBE ED 79          	OUT	(C),A		;Kanji
DDC0 CB 98          	RES	3,B
DDC2 3E 20          	LD	A,020H
DDC4 ED 79          	OUT	(C),A		;Text
DDC6                PRINTE7:
DDC6 CB A0          	RES	4,B
DDC8                PRINTE6:
DDC8 3A 96 F0       	LD	A,(_COLORF)
DDCB                PRINTE4:
DDCB ED 79          	OUT	(C),A		;Color
DDCD 78             	LD	A,B
DDCE E6 07          	AND	7
DDD0 47             	LD	B,A
DDD1                PRINTE2:
DDD1 03             	INC	BC
DDD2                PRINTE3:
DDD2 2A BA F0       	LD	HL,(_PAGE_MINUS)
DDD5 A7             	AND	A
DDD6 ED 4A          	ADC	HL,BC
DDD8                PRINTE8:
DDD8 28 05          	JR	Z,PRINT2
DDDA ED 43 8E F0    	LD	(_TXADR),BC
DDDE                CTRL00:
DDDE C9             	RET
DDDF                
DDDF                PRINT2:
DDDF CD 7D DF       	CALL	SCR
DDE2 2A BC F0       	LD	HL,(_WIDTH_MINUS)
DDE5 09             	ADD	HL,BC
DDE6                SET_TXADR_HL:
DDE6 22 8E F0       	LD	(_TXADR),HL
DDE9 C9             	RET
DDEA                
DDEA                CTRL08:
DDEA 3A 47 DD       	LD	A,(INSFLG)
DDED FE CD          	CP	0CDH		;CALL ????
DDEF 28 29          	JR	Z,CTRL02
DDF1                CTRL1D:
DDF1 2A 8E F0       	LD	HL,(_TXADR)
DDF4 7C             	LD	A,H
DDF5 B5             	OR	L
DDF6 C8             	RET	Z
DDF7 2B             	DEC	HL
DDF8 18 EC          	JR	SET_TXADR_HL
DDFA                
DDFA                CTRL1E:
DDFA ED 4B 8E F0    	LD	BC,(_TXADR)
DDFE 2A BC F0       	LD	HL,(_WIDTH_MINUS)
DE01 09             	ADD	HL,BC
DE02 D0             	RET	NC
DE03 18 E1          	JR	SET_TXADR_HL
DE05                
DE05                CTRL1C:
DE05 ED 4B 8E F0    	LD	BC,(_TXADR)
DE09 18 C6          	JR	PRINTE2
DE0B                
DE0B                CTRL09:
DE0B ED 4B 8E F0    	LD	BC,(_TXADR)
DE0F 79             	LD	A,C
DE10 E6 F8          	AND	0F8H
DE12 C6 08          	ADD	A,8
DE14 4F             	LD	C,A
DE15 88             	ADC	A,B
DE16 91             	SUB	C
DE17 47             	LD	B,A
DE18 18 B8          	JR	PRINTE3
DE1A                
DE1A                CTRL02:
DE1A CD F1 DD       	CALL	CTRL1D
DE1D C8             	RET	Z
DE1E D5             	PUSH	DE
DE1F CD D3 F0       	CALL	_POS
DE22 3A B1 F0       	LD	A,(_WIDTH)
DE25 95             	SUB	L
DE26 4F             	LD	C,A
DE27 0D             	DEC	C
DE28 06 38          	LD	B,038H
DE2A 2A 8E F0       	LD	HL,(_TXADR)
DE2D 09             	ADD	HL,BC
DE2E 44             	LD	B,H
DE2F 4D             	LD	C,L
DE30 11 00 20       	LD	DE,02000H	;D:Text E:kanji
DE33 2A 96 F0       	LD	HL,(_COLORF)	;L:Color
DE36                C8X1:
DE36 CD 1C DF       	CALL	C12S
DE39 0B             	DEC	BC
DE3A 20 FA          	JR	NZ,C8X1
DE3C D1             	POP	DE
DE3D C9             	RET
DE3E                
DE3E                CTRL05:
DE3E CD D3 F0       	CALL	_POS
DE41 3A B1 F0       	LD	A,(_WIDTH)
DE44 95             	SUB	L
DE45 6F             	LD	L,A
DE46                C08X1:
DE46 ED 4B 8E F0    	LD	BC,(_TXADR)
DE4A                LINECL:
DE4A 26 20          	LD	H,020H
DE4C 3A 96 F0       	LD	A,(_COLORF)
DE4F CB E8          	SET	5,B
DE51                LINECL1:
DE51 CB D8          	SET	3,B
DE53 CB E0          	SET	4,B
DE55 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DE57 CB 98          	RES	3,B
DE59 ED 61          	OUT	(C),H		;Text
DE5B CB A0          	RES	4,B
DE5D ED 79          	OUT	(C),A		;Color
DE5F 03             	INC	BC
DE60 2D             	DEC	L
DE61 20 EE          	JR	NZ,LINECL1
DE63 C9             	RET
DE64                
DE64                CTRL0D:
DE64 CD D3 F0       	CALL	_POS
DE67 2E 00          	LD	L,0
DE69                LOC:
DE69 C5             	PUSH	BC
DE6A E5             	PUSH	HL
DE6B CD AD DD       	CALL	KANCLR
DE6E CD 8C DE       	CALL	LOC1
DE71 22 8E F0       	LD	(_TXADR),HL
DE74 E1             	POP	HL
DE75 C1             	POP	BC
DE76 C9             	RET
DE77                
DE77                CTRL12:
DE77 21 47 DD       	LD	HL,INSFLG
DE7A 7E             	LD	A,(HL)
DE7B EE CC          	XOR	0CCH		;CD:CALL ???? 1:LD BC,????
DE7D 77             	LD	(HL),A
DE7E C9             	RET
DE7F                
DE7F                CTRL0B:
DE7F 21 00 00       	LD	HL,0
DE82 22 8E F0       	LD	(_TXADR),HL
DE85 C9             	RET
DE86                
DE86                CTRL1B:
DE86 3E 01          	LD	A,1
DE88 32 3E DD       	LD	(ESCFLG+1),A
DE8B C9             	RET
DE8C                
DE8C                LOC1:
DE8C D5             	PUSH	DE
DE8D 4D             	LD	C,L
DE8E 06 08          	LD	B,8
DE90 5C             	LD	E,H
DE91 16 00          	LD	D,0
DE93 2A B0 F0       	LD	HL,(CRTCD)
DE96 6A             	LD	L,D
DE97                LOC2:
DE97 29             	ADD	HL,HL
DE98 30 01          	JR	NC,LOC3
DE9A 19             	ADD	HL,DE
DE9B                LOC3:
DE9B 10 FA          	DJNZ	LOC2
DE9D 09             	ADD	HL,BC
DE9E D1             	POP	DE
DE9F C9             	RET
DEA0                
DEA0                CONOUT1:
DEA0 CD B2 DE       	CALL	CURSOR
DEA3 59             	LD	E,C
DEA4 CD CD F0       	CALL	_PRINT
DEA7 7B             	LD	A,E
DEA8 FE 0A          	CP	00AH
DEAA 20 06          	JR	NZ,CURSOR
DEAC CD 64 DE       	CALL	CTRL0D
DEAF CD 3E DE       	CALL	CTRL05
DEB2                CURSOR:
DEB2 C5             	PUSH	BC
DEB3 ED 4B 8E F0    	LD	BC,(_TXADR)
DEB7 CB E8          	SET	5,B
DEB9 ED 78          	IN	A,(C)
DEBB EE 18          	XOR	018H
DEBD ED 79          	OUT	(C),A
DEBF C1             	POP	BC
DEC0 C9             	RET
DEC1                
DEC1                CTRL07:
DEC1 21 61 F0       	LD	HL,BEEPD
DEC4                BEEP1:
DEC4 7E             	LD	A,(HL)
DEC5 23             	INC	HL
DEC6 FE FF          	CP	0FFH
DEC8 C8             	RET	Z
DEC9 06 1C          	LD	B,01CH
DECB ED 79          	OUT	(C),A
DECD ED A3          	OUTI
DECF 18 F3          	JR	BEEP1
DED1                
DED1                OT49SB:
DED1 C5             	PUSH	BC
DED2 CD ED DE       	CALL	CANW
DED5 01 00 19       	LD	BC,01900H
DED8 ED 79          	OUT	(C),A
DEDA C1             	POP	BC
DEDB C9             	RET
DEDC                
DEDC                IN49SB:
DEDC C5             	PUSH	BC
DEDD 01 01 1A       	LD	BC,01A01H
DEE0                CANR:
DEE0 ED 78          	IN	A,(C)
DEE2 E6 20          	AND	020H
DEE4 20 FA          	JR	NZ,CANR
DEE6 01 00 19       	LD	BC,01900H
DEE9 ED 78          	IN	A,(C)
DEEB C1             	POP	BC
DEEC C9             	RET
DEED                
DEED                CANW:
DEED 01 01 1A       	LD	BC,01A01H
DEF0 ED 48          	IN	C,(C)
DEF2 CB 71          	BIT	6,C
DEF4 20 F7          	JR	NZ,CANW
DEF6 C9             	RET
DEF7                
DEF7                COMOUT:
DEF7 FB             	EI
DEF8 CD D1 DE       	CALL	OT49SB
DEFB CD ED DE       	CALL	CANW
DEFE F3             	DI
DEFF C9             	RET
DF00                
DF00                INSERT:
DF00 D5             	PUSH	DE
DF01 CD D3 F0       	CALL	_POS
DF04 3A B1 F0       	LD	A,(_WIDTH)
DF07 95             	SUB	L
DF08 ED 4B 8E F0    	LD	BC,(_TXADR)
DF0C 11 00 20       	LD	DE,02000H	;D:Text E:Kanji
DF0F 2A 96 F0       	LD	HL,(_COLORF)	;L:Color
DF12 CB E8          	SET	5,B
DF14                C12X1:
DF14 CD 1C DF       	CALL	C12S
DF17 03             	INC	BC
DF18 20 FA          	JR	NZ,C12X1
DF1A D1             	POP	DE
DF1B C9             	RET
DF1C                
DF1C                C12S:
DF1C CB E0          	SET	4,B
DF1E CB D8          	SET	3,B
DF20 ED 60          	IN	H,(C)
DF22 ED 59          X1PAT:	OUT	(C),E
DF24 5C             	LD	E,H
DF25 CB 98          	RES	3,B
DF27 ED 60          	IN	H,(C)
DF29 ED 51          	OUT	(C),D
DF2B 54             	LD	D,H
DF2C CB A0          	RES	4,B
DF2E ED 60          	IN	H,(C)
DF30 ED 69          	OUT	(C),L
DF32 6C             	LD	L,H
DF33 3D             	DEC	A
DF34 C9             	RET
DF35                
DF35                CTRL0C:
DF35 CD 7F DE       	CALL	CTRL0B
DF38                CTRL06:
DF38 ED 4B 8E F0    	LD	BC,(_TXADR)
DF3C                C1AX1:
DF3C 78             	LD	A,B
DF3D F6 38          	OR	038H
DF3F 47             	LD	B,A
DF40 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DF42 CB 98          	RES	3,B
DF44 3E 20          	LD	A,020H
DF46 ED 79          	OUT	(C),A		;Text
DF48 CB A0          	RES	4,B
DF4A 3A 96 F0       	LD	A,(_COLORF)
DF4D ED 79          	OUT	(C),A		;Color
DF4F 03             	INC	BC
DF50 CB A8          	RES	5,B
DF52 2A BA F0       	LD	HL,(_PAGE_MINUS)
DF55 09             	ADD	HL,BC
DF56 30 E4          	JR	NC,C1AX1
DF58 C9             	RET
DF59                
DF59                CTRL04:
DF59 CD D3 F0       	CALL	_POS
DF5C 7D             	LD	A,L
DF5D B7             	OR	A
DF5E C8             	RET	Z
DF5F                CTRL03:
DF5F CD 64 DE       	CALL	CTRL0D
DF62                CTRL0A:
DF62                CTRL1F:
DF62 ED 4B 8E F0    	LD	BC,(_TXADR)
DF66 2A B1 F0       	LD	HL,(_WIDTH)
DF69 26 00          	LD	H,0
DF6B 09             	ADD	HL,BC
DF6C 44             	LD	B,H
DF6D 4D             	LD	C,L
DF6E 2A BA F0       	LD	HL,(_PAGE_MINUS)
DF71 09             	ADD	HL,BC
DF72 3F             	CCF
DF73 9F             	SBC	A,A
DF74 C3 D8 DD       	JP	PRINTE8
DF77                
DF77                CTRL0E:
DF77 CD D3 F0       	CALL	_POS
DF7A 7C             	LD	A,H
DF7B 18 04          	JR	SCR1
DF7D                SCR:
DF7D 3A 97 F0       	LD	A,(_LINE)
DF80 3D             	DEC	A
DF81                SCR1:
DF81 C5             	PUSH	BC
DF82 D5             	PUSH	DE
DF83 F5             	PUSH	AF
DF84 3E 07          	LD	A,7
DF86 21 B7 DF       	LD	HL,SCRDMAD
DF89 CD AD DF       	CALL	SETDMA
DF8C F1             	POP	AF
DF8D 21 00 38       	LD	HL,03800H
DF90                
DF90                SCRUP1:
DF90 B7             	OR	A
DF91 28 4D          	JR	Z,SCRCL
DF93 F5             	PUSH	AF
DF94 CD BE DF       	CALL	UPSUB		;kanji
DF97 3A BC F0       	LD	A,(_WIDTH_MINUS)
DF9A 5F             	LD	E,A
DF9B 16 F7          	LD	D,0F7H
DF9D 19             	ADD	HL,DE
DF9E D5             	PUSH	DE
DF9F CD BE DF       	CALL	UPSUB		;Text
DFA2 D1             	POP	DE
DFA3 19             	ADD	HL,DE
DFA4 CD BE DF       	CALL	UPSUB		;Color
DFA7 CB E4          	SET	4,H
DFA9 F1             	POP	AF
DFAA 3D             	DEC	A
DFAB 18 E3          	JR	SCRUP1
DFAD                
DFAD                SETDMA:
DFAD 01 87 1F       	LD	BC,01F87H
DFB0                SDMA:
DFB0 04             	INC	B
DFB1 ED A3          	OUTI
DFB3 3D             	DEC	A
DFB4 20 FA          	JR	NZ,SDMA
DFB6 C9             	RET
DFB7                
DFB7                SCRDMAD:
DFB7 C3             	DB	0C3H		;WR6 リセット
DFB8 9A             	DB	09AH		;WR5 ストップ WAIT READY:HIGH
DFB9 65             	DB	065H		;WR0 ブロック長(LH)
DFBA 4F 00          	DW	79
DFBC 1C             	DB	01CH		;WR1 ポートAインクリメント I/O
DFBD 18             	DB	018H		;WR0 ポートAアドレス(LH)
DFBE                
DFBE                UPSUB:
DFBE 3A B1 F0       	LD	A,(_WIDTH)
DFC1 5F             	LD	E,A
DFC2 16 00          	LD	D,0
DFC4 3E AD          	LD	A,0ADH		;WR4 連続 ポートB開始アドレス(LH)
DFC6 ED 79          	OUT	(C),A
DFC8 ED 69          	OUT	(C),L		;SOURCE
DFCA ED 61          	OUT	(C),H
DFCC 19             	ADD	HL,DE
DFCD 3E 1D          	LD	A,01DH		;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
DFCF ED 79          	OUT	(C),A
DFD1 ED 69          	OUT	(C),L		;DEST
DFD3 ED 61          	OUT	(C),H
DFD5                GO_DMA:
DFD5 3E CF          	LD	A,0CFH
DFD7 ED 79          	OUT	(C),A		;WR6 ロード
DFD9 3E B3          	LD	A,0B3H
DFDB ED 79          	OUT	(C),A		;WR6 強制RDY
DFDD ED 49          	OUT	(C),C		;WR6 イネーブル
DFDF C9             	RET
DFE0                
DFE0                SCRCL:
DFE0 44             	LD	B,H
DFE1 4D             	LD	C,L
DFE2 2A B1 F0       	LD	HL,(_WIDTH)
DFE5 CD 4A DE       	CALL	LINECL
DFE8 D1             	POP	DE
DFE9 C1             	POP	BC
DFEA C9             	RET
DFEB                
DFEB                SCRN:
DFEB D5             	PUSH	DE
DFEC ED 58          	IN	E,(C)		;Text
DFEE 3A 18 00       	LD	A,(00018H)
DFF1 3C             	INC	A
DFF2 28 1E          	JR	Z,SCRN2
DFF4 CB D8          	SET	3,B
DFF6 ED 50          	IN	D,(C)		;Kanji
DFF8 28 16          	JR	Z,SCRN1
DFFA AF             	XOR	A
DFFB C5             	PUSH	BC
DFFC 01 37 30       	LD	BC,03037H	;VRMJIS
DFFF DF             	RST	018H
E000 01 52 2F       	LD	BC,02F52H	;JISSFT
E003 DF             	RST	018H
E004 C1             	POP	BC
E005 ED 78          	IN	A,(C)
E007 CB 98          	RES	3,B
E009 E6 40          	AND	040H
E00B 20 05          	JR	NZ,SCRN2
E00D 7A             	LD	A,D
E00E D1             	POP	DE
E00F C9             	RET
E010                SCRN1:
E010 CB 98          	RES	3,B
E012                SCRN2:
E012 7B             	LD	A,E
E013 D1             	POP	DE
E014 C9             	RET
E015                SCRNE:
E015                POS:
E015 2A 8E F0       	LD	HL,(_TXADR)
E018 C5             	PUSH	BC
E019 ED 4B BC F0    	LD	BC,(_WIDTH_MINUS)
E01D AF             	XOR	A
E01E                POS1:
E01E 09             	ADD	HL,BC
E01F 3C             	INC	A
E020 38 FC          	JR	C,POS1
E022 ED 42          	SBC	HL,BC
E024 3D             	DEC	A
E025 67             	LD	H,A
E026 C1             	POP	BC
E027 A7             	AND	A
E028 C9             	RET
E029                
E029                GETL:
E029 CD D3 F0       	CALL	_POS
E02C E5             	PUSH	HL
E02D 3E CD          	LD	A,0CDH		;CALL ????
E02F 32 47 DD       	LD	(INSFLG),A
E032                GETL1:
E032 CD BC DB       	CALL	_SYS08
E035 FE 09          	CP	9
E037 20 08          	JR	NZ,GETL1V
E039 21 20 FF       	LD	HL,KBUF
E03C CD A3 D8       	CALL	MSX
E03F 18 F1          	JR	GETL1
E041                GETL1V:
E041 5F             	LD	E,A
E042 CD CD F0       	CALL	_PRINT
E045                
E045 7B             	LD	A,E
E046 FE 0D          	CP	00DH
E048 20 E8          	JR	NZ,GETL1
E04A 3E 01          	LD	A,1		;LD BC,????
E04C 32 47 DD       	LD	(INSFLG),A
E04F 11 20 FF       	LD	DE,KBUF
E052 3A B1 F0       	LD	A,(_WIDTH)
E055 47             	LD	B,A
E056 CD 55 D6       	CALL	ZERO_MEMORY_DE
E059                
E059 D1             	POP	DE
E05A CD D3 F0       	CALL	_POS
E05D 6B             	LD	L,E
E05E 3A B1 F0       	LD	A,(_WIDTH)
E061 95             	SUB	L
E062 57             	LD	D,A
E063 CD 8C DE       	CALL	LOC1
E066 4D             	LD	C,L
E067 7C             	LD	A,H
E068 F6 30          	OR	030H
E06A 47             	LD	B,A
E06B 5A             	LD	E,D
E06C 21 20 FF       	LD	HL,KBUF
E06F                GETL2:
E06F CD D0 F0       	CALL	_SCRN
E072 03             	INC	BC
E073 77             	LD	(HL),A
E074 23             	INC	HL
E075 1D             	DEC	E
E076 20 F7          	JR	NZ,GETL2
E078                GETL3:
E078 2B             	DEC	HL
E079 7E             	LD	A,(HL)
E07A FE 21          	CP	021H
E07C D0             	RET	NC
E07D 36 00          	LD	(HL),0
E07F 15             	DEC	D
E080 20 F6          	JR	NZ,GETL3
E082 C9             	RET
E083                
E083                INKEY:
E083 FB             	EI
E084 E5             	PUSH	HL
E085 2A 90 F0       	LD	HL,(_KEYPS)
E088 7C             	LD	A,H
E089 AD             	XOR	L
E08A 28 0B          	JR	Z,INKEY1
E08C 7C             	LD	A,H
E08D 3C             	INC	A
E08E E6 1F          	AND	01FH
E090 32 91 F0       	LD	(_KEYPS+1),A
E093 6F             	LD	L,A
E094 26 FF          	LD	H,KEYBF/256
E096 7E             	LD	A,(HL)
E097                INKEY1:
E097 E1             	POP	HL
E098 B7             	OR	A
E099 C9             	RET
E09A                
E09A 00 00 0E 7B    AT_RS	EQU	SCR1-AT_SCR1
E09A                	INCLUDE	"LDFILE.ASM"
E09A                
E09A                ;	LSX-Dodgers FILE
E09A                
E09A                FILEC:
E09A CD A5 E0       	CALL	FILE
E09D                FILEC2:
E09D 3A 15 F0       	LD	A,(FDRV+1)
E0A0 FE 20          	CP	020H
E0A2 C8             	RET	Z
E0A3 18 39          	JR	SETDIR1
E0A5                
E0A5                FILE:
E0A5 AF             	XOR	A
E0A6 32 14 F0       	LD	(FDRV),A
E0A9 67             	LD	H,A
E0AA 6F             	LD	L,A
E0AB 22 22 F0       	LD	(FDRV+14),HL
E0AE CD 7C E1       	CALL	SPCUT
E0B1 CD 61 E1       	CALL	CCHK3
E0B4 28 12          	JR	Z,DEVI1
E0B6 13             	INC	DE
E0B7 1A             	LD	A,(DE)
E0B8 1B             	DEC	DE
E0B9 FE 3A          	CP	':'
E0BB 20 0B          	JR	NZ,DEVI1
E0BD 1A             	LD	A,(DE)		;DRIVE
E0BE CD B1 E3       	CALL	CAP
E0C1 D6 40          	SUB	'@'
E0C3 13             	INC	DE
E0C4 13             	INC	DE
E0C5 32 14 F0       	LD	(FDRV),A
E0C8                DEVI1:
E0C8 1A             	LD	A,(DE)
E0C9 D6 5C          	SUB	05CH		;\
E0CB 20 09          	JR	NZ,NOROOT
E0CD 6F             	LD	L,A		;A=0でH=0のはずなのでHL=0
E0CE 22 2E F0       	LD	(FDRV+26),HL
E0D1 2C             	INC	L
E0D2 22 22 F0       	LD	(FDRV+14),HL
E0D5 13             	INC	DE
E0D6                NOROOT:
E0D6                
E0D6                SETDIR:
E0D6 CD 02 E1       	CALL	FILED
E0D9 1A             	LD	A,(DE)
E0DA FE 5C          	CP	05CH		;\
E0DC C0             	RET	NZ
E0DD 13             	INC	DE
E0DE                SETDIR1:
E0DE 3E 10          	LD	A,010H		;Directory
E0E0 32 21 F0       	LD	(FDRV+13),A
E0E3 D5             	PUSH	DE
E0E4 11 14 F0       	LD	DE,FDRV
E0E7 2A 1E F1       	LD	HL,(STABLE+2*00FH)
E0EA CD 0F 00       	CALL	JP_HL
E0ED D1             	POP	DE
E0EE B7             	OR	A
E0EF C0             	RET	NZ
E0F0                
E0F0 3A 21 F0       	LD	A,(FDRV+13)
E0F3 CB 67          	BIT	4,A
E0F5 C8             	RET	Z
E0F6                
E0F6 CD 49 E1       	CALL	FILEI
E0F9 2A 2E F0       	LD	HL,(FDRV+26)
E0FC 23             	INC	HL
E0FD 22 22 F0       	LD	(FDRV+14),HL
E100 18 D4          	JR	SETDIR
E102                
E102                FILED:
E102 CD 49 E1       	CALL	FILEI
E105 21 15 F0       	LD	HL,FNAME
E108                
E108 06 08          	LD	B,8
E10A                FILE2:
E10A CD 56 E1       	CALL	CCHKF
E10D C8             	RET	Z
E10E FE 2A          	CP	'*'
E110 28 2E          	JR	Z,FILE9
E112 FE 2E          	CP	'.'
E114 28 0C          	JR	Z,FILE4
E116 77             	LD	(HL),A
E117 23             	INC	HL
E118 10 F0          	DJNZ	FILE2
E11A                
E11A                FILE3:
E11A CD 56 E1       	CALL	CCHKF
E11D C8             	RET	Z
E11E FE 2E          	CP	'.'
E120 20 F8          	JR	NZ,FILE3
E122                
E122                FILE4:
E122 21 1D F0       	LD	HL,FNAME+8
E125 06 03          	LD	B,3
E127                
E127                FILE4L:
E127 CD 56 E1       	CALL	CCHKF
E12A C8             	RET	Z
E12B FE 2E          	CP	'.'
E12D 20 08          	JR	NZ,FILE12
E12F 32 15 F0       	LD	(FNAME),A	;Parent directory(..)
E132 32 16 F0       	LD	(FNAME+1),A
E135 3E 20          	LD	A,020H
E137                FILE12:
E137 FE 2A          	CP	'*'
E139 28 0A          	JR	Z,FILE10
E13B 77             	LD	(HL),A
E13C 23             	INC	HL
E13D 10 E8          	DJNZ	FILE4L
E13F C9             	RET
E140                
E140                FILE9:				;名前の*処理、名前の残りを?で埋める
E140 CD 45 E1       	CALL	FILE10
E143 18 D5          	JR	FILE3
E145                
E145                FILE10:
E145 3E 3F          	LD	A,'?'
E147 18 08          	JR	FILL_MEMORY
E149                FILEI:				;名前＋拡張子をスペースで初期化
E149 3E 20          	LD	A,020H
E14B 01 00 0B       	LD	BC,11*256	;C=0にしておく
E14E 21 15 F0       	LD	HL,FNAME
E151                FILL_MEMORY:			;HLからBバイトAで埋める
E151 77             	LD	(HL),A
E152 23             	INC	HL
E153 10 FC          	DJNZ	FILL_MEMORY
E155 C9             	RET
E156                
E156                CCHKF:
E156 1A             	LD	A,(DE)
E157 CD 5E E1       	CALL	CCHK2
E15A C8             	RET	Z
E15B C3 C4 E4       	JP	FKAN
E15E                
E15E                CCHK2:
E15E 0C             	INC	C
E15F 0D             	DEC	C
E160 C0             	RET	NZ
E161                CCHK3:				;ZF=1 で使えない文字
E161 FE 2B          	CP	'+'
E163 C8             	RET	Z
E164 FE 2C          	CP	','
E166 C8             	RET	Z
E167 FE 2F          	CP	'/'
E169 C8             	RET	Z
E16A FE 3A          	CP	':'
E16C C8             	RET	Z
E16D FE 3B          	CP	';'
E16F C8             	RET	Z
E170 FE 3D          	CP	'='
E172 C8             	RET	Z
E173 FE 5C          	CP	05CH	;\
E175 C8             	RET	Z
E176 FE 20          	CP	020H
E178 D0             	RET	NC
E179 BF             	CP	A		;Z=1
E17A C9             	RET
E17B                
E17B                SS1:
E17B 13             	INC	DE
E17C                SPCUT:				;スペースをカット
E17C 1A             	LD	A,(DE)
E17D FE 20          	CP	020H
E17F 28 FA          	JR	Z,SS1
E181 C9             	RET
E182                
E182                SETDRVF:
E182 11 14 F0       	LD	DE,FDRV
E185                SETDRV0:
E185 CD 8E E1       	CALL	SETDRV
E188 FD E1          	POP	IY
E18A C1             	POP	BC
E18B D1             	POP	DE
E18C E1             	POP	HL
E18D C9             	RET
E18E                
E18E                SETDRV:
E18E E3             	EX	(SP),HL		;HL=RETRN ADDRESS
E18F D5             	PUSH	DE		;PUSH HL/DE/BC/IY
E190 C5             	PUSH	BC
E191 1A             	LD	A,(DE)
E192 D5             	PUSH	DE
E193 FD E3          	EX	(SP),IY
E195                
E195 CD A1 E1       	CALL	GETDRV
E198 3C             	INC	A
E199 FD 77 00       	LD	(IY+0),A	;(FCB)ドライブ番号
E19C 3D             	DEC	A
E19D CD D9 F0       	CALL	_CHGDRV
E1A0                
E1A0 E9             	JP	(HL)
E1A1                
E1A1                GETDRV:
E1A1 E6 7F          	AND	07FH
E1A3 D6 01          	SUB	001H
E1A5 30 03          	JR	NC,GETDRV1
E1A7 3A 87 F0       	LD	A,(_DVSW)	;Current Drive
E1AA                GETDRV1:
E1AA 32 88 F0       	LD	(_DRV),A
E1AD C9             	RET
E1AE                
E1AE                SOPENX:
E1AE 11 39 F0       	LD	DE,SFILE
E1B1 1A             	LD	A,(DE)
E1B2 FD BE 00       	CP	(IY+0)		;(FCB)ドライブ番号
E1B5 20 24          	JR	NZ,SOPEN
E1B7 13             	INC	DE
E1B8 FD E5          	PUSH	IY
E1BA E1             	POP	HL
E1BB 23             	INC	HL
E1BC CD 49 E3       	CALL	CPFILE
E1BF 20 1A          	JR	NZ,SOPEN
E1C1                
E1C1 2A F4 F1       	LD	HL,(SCDIR)
E1C4 FD 75 0E       	LD	(IY+14),L	;(FCB)アクセスするディレクトリのクラスタ番号+1
E1C7 FD 74 0F       	LD	(IY+15),H
E1CA                
E1CA 2A F8 F1       	LD	HL,(SFNDF)	;Direcroty location and Flags
E1CD 22 9F F0       	LD	(_FILEN),HL
E1D0                
E1D0 ED 5B F6 F1    	LD	DE,(SFBPS)
E1D4 21 39 F0       	LD	HL,SFILE
E1D7 36 FF          	LD	(HL),0FFH
E1D9 23             	INC	HL
E1DA C9             	RET
E1DB                SOPEN:
E1DB 21 F1 E2       	LD	HL,FILESE
E1DE                SOPENC:
E1DE 22 17 E2       	LD	(OPENPAT+1),HL
E1E1                
E1E1 CD E2 F0       	CALL	_RDFATX		;Detect Media
E1E4 38 56          	JR	C,RDDERR
E1E6                
E1E6 AF             	XOR	A
E1E7 32 9F F0       	LD	(_FILEN),A
E1EA CD F1 E3       	CALL	LDDIRX1		;A=0で呼び出す
E1ED 28 18          	JR	Z,SDIRX1
E1EF                
E1EF CD E2 E2       	CALL	READ_DIR	;Sub Directory
E1F2 38 08          	JR	C,SDIRX0
E1F4 2A 7E F1       	LD	HL,(_DTBUF)
E1F7 7E             	LD	A,(HL)
E1F8 FE 2E          	CP	'.'
E1FA 28 0F          	JR	Z,SOPEN1
E1FC                SDIRX0:
E1FC AF             	XOR	A
E1FD 32 A0 F0       	LD	(_DIRF),A
E200 FD 36 0E 01    	LD	(IY+14),1	;(FCB)レコードサイズ
E204 FD 77 0F       	LD	(IY+15),A
E207                SDIRX1:
E207 ED 5B FC F1    	LD	DE,(_DIRPS)	;Root Directory
E20B                SOPEN1:
E20B 0E 20          	LD	C,32		;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
E20D 00 00 E2 0C    SDECPAT	EQU	$-1
E20D                SOPEN1X:
E20D CD E2 E2       	CALL	READ_DIR	;FILE SEARCH
E210 38 2A          	JR	C,RDDERR
E212 2A 7E F1       	LD	HL,(_DTBUF)
E215                SOPEN2:
E215 D5             	PUSH	DE
E216 CD F1 E2       OPENPAT:CALL	FILESE		;(self-modifying code)
E219 D1             	POP	DE
E21A 38 6E          	JR	C,SOPENE
E21C 28 1B          	JR	Z,SCF_FF_RET
E21E                SOPEN3:
E21E 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E221 B7             	OR	A
E222 20 0C          	JR	NZ,SOPEN5
E224 13             	INC	DE		;ルートディレクトリ
E225 E5             	PUSH	HL
E226 21 0C 00       	LD	HL,12		;(self-modifying code)MAXDIR
E229 00 00 E2 27    MD_PAT	EQU	$-2
E229 ED 52          	SBC	HL,DE		;CF=0 なので SUB HL,DE
E22B E1             	POP	HL
E22C 20 DD          	JR	NZ,SOPEN1
E22E 18 07          	JR	SOPEN6
E230                SOPEN5:
E230 CD 06 EB       	CALL	GNCLX		;END DIR
E233 D8             	RET	C
E234 CD A9 E3       	CALL	ENDCL
E237                SOPEN6:
E237 38 D2          	JR	C,SOPEN1
E239                SCF_FF_RET:
E239 37             	SCF			;CF=1
E23A 9F             	SBC	A,A		;A=0FFH
E23B C9             	RET
E23C                
E23C                RDDERR:
E23C BF             	CP	A		;READ ERR CF=1 ZF=1
E23D 37             	SCF
E23E C9             	RET
E23F                
E23F                NOPEN:
E23F 21 F1 E2       	LD	HL,FILESE
E242 22 17 E2       	LD	(OPENPAT+1),HL
E245 FD 2A 98 F0    	LD	IY,(_FCB)
E249 CD D7 E4       	CALL	CHKWILDX
E24C 30 EB          	JR	NC,SCF_FF_RET
E24E FD 7E 00       	LD	A,(IY+0)	;(FCB)ドライブ番号
E251 3D             	DEC	A
E252 32 88 F0       	LD	(_DRV),A
E255 CD D9 F0       	CALL	_CHGDRV
E258 D8             	RET	C
E259 2A F8 F1       	LD	HL,(SFNDF)	;Direcroty location and Flags
E25C 22 9F F0       	LD	(_FILEN),HL
E25F                
E25F CD EC E3       	CALL	LDDIRX
E262 ED 5B 9A F0    	LD	DE,(_FBPS)
E266 CD E2 E2       	CALL	READ_DIR
E269 38 D1          	JR	C,RDDERR
E26B 3A 9E F0       	LD	A,(_FBCNT)
E26E 3D             	DEC	A
E26F 28 AD          	JR	Z,SOPEN3
E271                NOPEN2:
E271 2A 9C F0       	LD	HL,(_FBAD)
E274 01 20 00       	LD	BC,020H
E277 09             	ADD	HL,BC
E278 4F             	LD	C,A
E279 18 9A          	JR	SOPEN2
E27B                
E27B                SOPENE2:
E27B 22 9C F0       	LD	(_FBAD),HL
E27E 79             	LD	A,C
E27F 32 9E F0       	LD	(_FBCNT),A
E282 ED 53 9A F0    	LD	(_FBPS),DE
E286 FD 22 98 F0    	LD	(_FCB),IY
E28A                SOPENE:
E28A AF             	XOR	A
E28B C9             	RET
E28C                
E28C                COPEN:
E28C FD 36 0D 20    	LD	(IY+13),020H	;(FCB)属性(アトリビュート)
E290                
E290 21 0E E3       	LD	HL,NEXTSE
E293 CD DE E1       	CALL	SOPENC
E296 D0             	RET	NC
E297 C8             	RET	Z
E298 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E29B B7             	OR	A
E29C 37             	SCF
E29D C8             	RET	Z		;ルートディレクトリ
E29E 06 01          	LD	B,1
E2A0 CD 36 E5       	CALL	WRDF
E2A3 D8             	RET	C
E2A4 ED 5B FE F1    	LD	DE,(_CLPS)
E2A8 D5             	PUSH	DE
E2A9 CD 72 E3       	CALL	DCPAT
E2AC CD 91 E9       	CALL	DRDNX
E2AF 2A 7E F1       	LD	HL,(_DTBUF)	;ディレクトリエントリを0クリア
E2B2 3A 9B E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E2B5 47             	LD	B,A
E2B6 AF             	XOR	A
E2B7 4F             	LD	C,A
E2B8                COPENCL:
E2B8 77             	LD	(HL),A
E2B9 ED A1          	CPI			;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
E2BB EA B8 E2       	JP	PE,COPENCL
E2BE                
E2BE 3A 90 E3       	LD	A,(SPCPAT)	;1クラスタの論理セクタ数
E2C1 3D             	DEC	A
E2C2 28 19          	JR	Z,COPENE
E2C4 3E 01          	LD	A,1		;1セクタ辺りのセクタ数が2以上の場合
E2C6 32 FE EA       	LD	(_SECPS),A
E2C9 D1             	POP	DE		;DE=(_CLPS)
E2CA D5             	PUSH	DE
E2CB                COPEN1:
E2CB D5             	PUSH	DE		;データバッファに入らないセクタもゼロクリア
E2CC C5             	PUSH	BC
E2CD 2A 7E F1       	LD	HL,(_DTBUF)
E2D0 CD 8C E3       	CALL	CLUSTX
E2D3 CD 96 EC       	CALL	DWT24
E2D6 C1             	POP	BC
E2D7 D1             	POP	DE
E2D8 CD FD EA       	CALL	NEXTX
E2DB 20 EE          	JR	NZ,COPEN1
E2DD                COPENE:
E2DD 2A 7E F1       	LD	HL,(_DTBUF)
E2E0 D1             	POP	DE
E2E1 C9             	RET
E2E2                
E2E2                READ_DIR:
E2E2 ED 53 FE F1    	LD	(_CLPS),DE
E2E6 C5             	PUSH	BC
E2E7 D5             	PUSH	DE
E2E8 CD 72 E3       	CALL	DCPAT
E2EB CD 71 E9       	CALL	DRDX
E2EE D1             	POP	DE
E2EF C1             	POP	BC
E2F0 C9             	RET
E2F1                
E2F1                FILESE:
E2F1 7E             	LD	A,(HL)
E2F2 B7             	OR	A
E2F3 C8             	RET	Z		;END:ZF=1 CF=0
E2F4 FE E5          	CP	0E5H
E2F6 28 0E          	JR	Z,FILESE1
E2F8 FD E5          	PUSH	IY
E2FA D1             	POP	DE
E2FB 13             	INC	DE
E2FC E5             	PUSH	HL
E2FD CD 49 E3       	CALL	CPFILE
E300 CC 6A E3       	CALL	Z,CPFILE2
E303 E1             	POP	HL
E304 37             	SCF
E305 C8             	RET	Z		;!!!:(ZF=1) CF=1
E306                FILESE1:
E306 CD 1D E3       	CALL	FNEXT
E309 20 E6          	JR	NZ,FILESE
E30B                ZF0_CF0_AFF_RET:
E30B F6 FF          	OR	0FFH		;ZF=0 CF=0
E30D C9             	RET
E30E                
E30E                NEXTSE:
E30E 7E             	LD	A,(HL)
E30F B7             	OR	A
E310 37             	SCF
E311 C8             	RET	Z		;!!!:ZF=1 CF=1
E312 FE E5          	CP	0E5H
E314 37             	SCF
E315 C8             	RET	Z		;!!!:(ZF=1) CF=1
E316 CD 1D E3       	CALL	FNEXT
E319 20 F3          	JR	NZ,NEXTSE
E31B 18 EE          	JR	ZF0_CF0_AFF_RET
E31D                
E31D                FNEXT:
E31D E5             	PUSH	HL
E31E 21 9F F0       	LD	HL,_FILEN
E321 34             	INC	(HL)
E322 E1             	POP	HL
E323 11 20 00       	LD	DE,020H
E326 19             	ADD	HL,DE
E327 0D             	DEC	C
E328 C9             	RET
E329                
E329                CPNAME:
E329 C5             	PUSH	BC
E32A D5             	PUSH	DE
E32B E5             	PUSH	HL
E32C CD 43 E3       	CALL	CPFILE4
E32F E1             	POP	HL
E330 23             	INC	HL
E331 23             	INC	HL
E332 23             	INC	HL
E333 23             	INC	HL
E334 D1             	POP	DE
E335 C1             	POP	BC
E336 20 05          	JR	NZ,CPNAME1
E338 7E             	LD	A,(HL)
E339 23             	INC	HL
E33A 66             	LD	H,(HL)
E33B 6F             	LD	L,A
E33C C9             	RET
E33D                CPNAME1:
E33D 23             	INC	HL
E33E 23             	INC	HL
E33F 10 E8          	DJNZ	CPNAME
E341 37             	SCF
E342 C9             	RET
E343                
E343                CPFILE4:
E343 C5             	PUSH	BC
E344 01 00 04       	LD	BC,00400H
E347 18 04          	JR	CPSTR1
E349                CPFILE:
E349 C5             	PUSH	BC
E34A 01 00 0B       	LD	BC,00B00H
E34D                CPSTR1:
E34D 1A             	LD	A,(DE)
E34E FE 3F          	CP	'?'		;Wild card
E350 28 12          	JR	Z,CPSTR2
E352 7E             	LD	A,(HL)
E353 CD BD E4       	CALL	FKANC
E356 E5             	PUSH	HL
E357 67             	LD	H,A
E358 1A             	LD	A,(DE)
E359 CB 01          	RLC	C
E35B CD BD E4       	CALL	FKANC
E35E CB 09          	RRC	C
E360 BC             	CP	H		;CP (HL),(DE)
E361 E1             	POP	HL
E362 20 04          	JR	NZ,CPSTR3
E364                CPSTR2:
E364 13             	INC	DE
E365 23             	INC	HL
E366 10 E5          	DJNZ	CPSTR1
E368                CPSTR3:
E368 C1             	POP	BC
E369 C9             	RET
E36A                
E36A                CPFILE2:
E36A FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E36D F6 E1          	OR	0E1H
E36F 2F             	CPL
E370 A6             	AND	(HL)
E371 C9             	RET
E372                
E372                DCPAT:
E372 0E 00          	LD	C,0
E374 2A 7E F1       	LD	HL,(_DTBUF)
E377 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E37A B7             	OR	A
E37B C8             	RET	Z		;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
E37C 3A 90 E3       	LD	A,(SPCPAT)
E37F 4F             	LD	C,A
E380 3A FE EA       	LD	A,(_SECPS)
E383 B9             	CP	C
E384 38 01          	JR	C,DC1
E386 AF             	XOR	A
E387                DC1:
E387 F6 80          	OR	080H
E389 32 A0 F0       	LD	(_DIRF),A	;bit0-6:セクタインデックス
E38C                CLUSTX:
E38C E5             	PUSH	HL
E38D EB             	EX	DE,HL
E38E AF             	XOR	A
E38F 0E 01          	LD	C,1		;自己書き換え（1クラスタの論理セクタ数）
E391 00 00 E3 90    SPCPAT	EQU	$-1
E391                L_CLDBL:
E391 CB 19          	RR	C		;->CF
E393 38 04          	JR	C,E_CLDBL
E395 29             	ADD	HL,HL		;*2
E396 8F             	ADC	A,A
E397 18 F8          	JR	L_CLDBL
E399                E_CLDBL:
E399 4F             	LD	C,A
E39A 3A FE EA       	LD	A,(_SECPS)
E39D B5             	OR	L
E39E 6F             	LD	L,A
E39F 11 08 00       	LD	DE,8	;+8 (2D)  !ADDCL (self-modifying code)
E3A2 00 00 E3 A0    CLSPAT	EQU	$-2
E3A2 AF             	XOR	A
E3A3 19             	ADD	HL,DE	;データ格納領域の先頭論理セクタ番号
E3A4 89             	ADC	A,C
E3A5 4F             	LD	C,A
E3A6 EB             	EX	DE,HL
E3A7 E1             	POP	HL
E3A8 C9             	RET
E3A9                
E3A9                ENDCL:
E3A9 7A             	LD	A,D	;END CLUSTER
E3AA FE 01          	CP	1	;164=356	(self-modifying code)
E3AC 00 00 E3 AB    CLPAT1	EQU	$-1
E3AC C0             	RET	NZ
E3AD 7B             	LD	A,E
E3AE FE 64          	CP	064H	;		(self-modifying code)
E3B0 00 00 E3 AF    CLPAT2	EQU	$-1
E3B0 C9             	RET
E3B1                
E3B1                CAP:
E3B1 FE 61          	CP	'a'
E3B3 D8             	RET	C
E3B4 FE 7B          	CP	'z'+1
E3B6 D0             	RET	NC
E3B7 D6 20          	SUB	020H
E3B9 C9             	RET
E3BA                CAP2:
E3BA CD B1 E3       	CALL	CAP
E3BD                CAP3:				;
E3BD FE 05          	CP	5
E3BF 28 03          	JR	Z,CAP4
E3C1 FE 21          	CP	021H
E3C3 C9             	RET
E3C4                CAP4:
E3C4 3E E5          	LD	A,0E5H
E3C6 C9             	RET
E3C7                
E3C7                CHDIR:
E3C7 CD C4 ED       	CALL	GETDPBD
E3CA 38 1D          	JR	C,CHDIR2
E3CC DD 75 1A       	LD	(IX+DPB_SDIR),L
E3CF DD 74 1B       	LD	(IX+DPB_SDIR+1),H
E3D2 18 15          	JR	CHDIR2		;POP_IX_RET
E3D4                
E3D4                LDDIR:
E3D4 CD C4 ED       	CALL	GETDPBD
E3D7 DD 5E 1A       	LD	E,(IX+DPB_SDIR)
E3DA DD 56 1B       	LD	D,(IX+DPB_SDIR+1)
E3DD 13             	INC	DE
E3DE FD 73 0E       	LD	(IY+14),E	;(FCB)アクセスするディレクトリのクラスタ番号+1
E3E1 FD 72 0F       	LD	(IY+15),D
E3E4 1B             	DEC	DE
E3E5 AF             	XOR	A
E3E6 32 A0 F0       	LD	(_DIRF),A
E3E9                CHDIR2:
E3E9 DD E1          	POP	IX
E3EB C9             	RET
E3EC                
E3EC                LDDIRX:
E3EC 3A A0 F0       	LD	A,(_DIRF)	;(FCB)アクセスするディレクトリのセクタインデックス
E3EF E6 7F          	AND	07FH
E3F1                LDDIRX1:
E3F1 32 FE EA       	LD	(_SECPS),A
E3F4 FD 5E 0E       	LD	E,(IY+14)	;(FCB)アクセスするディレクトリのクラスタ番号+1
E3F7 FD 56 0F       	LD	D,(IY+15)
E3FA 1B             	DEC	DE
E3FB CD A9 E3       	CALL	ENDCL
E3FE D4 D4 E3       	CALL	NC,LDDIR
E401                LDDIRS:
E401 7A             	LD	A,D
E402 B3             	OR	E
E403 32 A0 F0       	LD	(_DIRF),A	;ディレクトリか判別
E406 C9             	RET
E407                
E407                KILL:
E407 CD D7 E4       	CALL	CHKWILDX
E40A 38 34          	JR	C,KILLW
E40C CD AE E1       	CALL	SOPENX
E40F                KILLS:
E40F 3E 1F          	LD	A,01FH
E411 D4 53 E4       	CALL	NC,CHKATT
E414 D8             	RET	C
E415                KILLSX:
E415 36 E5          	LD	(HL),0E5H	;DIR
E417 CD B1 E4       	CALL	WTDB
E41A 11 1A 00       	LD	DE,01AH
E41D 19             	ADD	HL,DE
E41E 5E             	LD	E,(HL)
E41F 23             	INC	HL
E420 56             	LD	D,(HL)
E421                KILLS1:
E421 CD A9 E3       	CALL	ENDCL
E424 D0             	RET	NC		;CF=0
E425 21 FE FF       	LD	HL,0-2
E428 19             	ADD	HL,DE
E429 D0             	RET	NC		;DE= 0 or 1
E42A D5             	PUSH	DE
E42B CD F7 F0       	CALL	_GNCL
E42E ED 53 FE F1    	LD	(_CLPS),DE
E432 D1             	POP	DE
E433 21 00 00       	LD	HL,0
E436 D4 FA F0       	CALL	NC,_SNCL
E439 D8             	RET	C
E43A ED 5B FE F1    	LD	DE,(_CLPS)	;FAT
E43E 18 E1          	JR	KILLS1
E440                
E440                KILLW:
E440 CD DB E1       	CALL	SOPEN
E443                KILLW1:
E443 38 0B          	JR	C,KILLW2
E445 CD 7B E2       	CALL	SOPENE2
E448 CD 0F E4       	CALL	KILLS
E44B CD 3F E2       	CALL	NOPEN
E44E 18 F3          	JR	KILLW1
E450                KILLW2:
E450 C8             	RET	Z
E451 3F             	CCF
E452 C9             	RET
E453                
E453                CHKATT:
E453 E5             	PUSH	HL
E454 11 0B 00       	LD	DE,00BH
E457 19             	ADD	HL,DE
E458 A6             	AND	(HL)
E459 E1             	POP	HL
E45A C8             	RET	Z
E45B 37             	SCF
E45C C9             	RET
E45D                
E45D                NAME:
E45D CD D7 E4       	CALL	CHKWILDX
E460 D8             	RET	C
E461 11 04 00       	LD	DE,4
E464 19             	ADD	HL,DE
E465 22 7D E4       	LD	(NAMEP+2),HL
E468 23             	INC	HL
E469 CD DB E4       	CALL	CHKWILD
E46C D8             	RET	C
E46D                
E46D CD AE E1       	CALL	SOPENX
E470 3E 0F          	LD	A,00FH
E472 D4 53 E4       	CALL	NC,CHKATT
E475 D8             	RET	C
E476                
E476 FD 7E 00       	LD	A,(IY+0)
E479 FD E5          	PUSH	IY
E47B FD 21 00 00    NAMEP:	LD	IY,0		;自己書き換え
E47F FD 77 00       	LD	(IY+0),A
E482 CD AE E1       	CALL	SOPENX
E485 FD E3          	EX	(SP),IY
E487 3F             	CCF
E488 D4 DB E1       	CALL	NC,SOPEN
E48B EB             	EX	DE,HL
E48C E1             	POP	HL
E48D D8             	RET	C
E48E                
E48E                SETNAME:
E48E 01 00 0B       	LD	BC,11*256
E491 23             	INC	HL
E492 7E             	LD	A,(HL)
E493 FE E5          	CP	0E5H
E495 20 04          	JR	NZ,SNAME1
E497 3E 05          	LD	A,5
E499 18 0E          	JR	SNAME3
E49B                SNAME1:
E49B 7E             	LD	A,(HL)
E49C 0C             	INC	C
E49D 0D             	DEC	C
E49E 20 09          	JR	NZ,SNAME3
E4A0 CD B1 E3       	CALL	CAP
E4A3 FE A0          	CP	0A0H
E4A5 20 02          	JR	NZ,SNAME3
E4A7 3E 20          	LD	A,020H
E4A9                SNAME3:
E4A9 12             	LD	(DE),A
E4AA 7E             	LD	A,(HL)
E4AB 23             	INC	HL
E4AC CD C4 E4       	CALL	FKAN
E4AF 10 EA          	DJNZ	SNAME1
E4B1                WTDB:
E4B1 3E FF          	LD	A,0FFH
E4B3 32 39 F0       	LD	(SFILE),A
E4B6                SWTDBF:
E4B6 3E 01          	LD	A,1
E4B8 32 A4 F0       	LD	(_WTDBF),A
E4BB AF             	XOR	A
E4BC C9             	RET
E4BD                
E4BD                FKANC:
E4BD CB 41          	BIT	0,C
E4BF CC BA E3       	CALL	Z,CAP2
E4C2 18 01          	JR	FKANX
E4C4                FKAN:			;漢字チェック
E4C4 13             	INC	DE
E4C5                FKANX:
E4C5 CB 41          	BIT	0,C
E4C7 CB 81          	RES	0,C
E4C9 C0             	RET	NZ
E4CA FE 80          	CP	080H
E4CC D8             	RET	C
E4CD FE A0          	CP	0A0H
E4CF 38 03          	JR	C,FKAN1
E4D1 FE E0          	CP	0E0H
E4D3 D8             	RET	C
E4D4                FKAN1:
E4D4 0C             	INC	C
E4D5 A7             	AND	A
E4D6 C9             	RET
E4D7                
E4D7                CHKWILDX:
E4D7 FD E5          	PUSH	IY
E4D9 E1             	POP	HL
E4DA 23             	INC	HL
E4DB                CHKWILD:
E4DB 06 0B          	LD	B,11
E4DD 3E 3F          	LD	A,'?'
E4DF                CHKWIL1:
E4DF BE             	CP	(HL)
E4E0 23             	INC	HL
E4E1 37             	SCF
E4E2 C8             	RET	Z
E4E3 10 FA          	DJNZ	CHKWIL1
E4E5 AF             	XOR	A
E4E6 C9             	RET
E4E7                
E4E7                SDIRENT:		;IY=FCB HL=DIR
E4E7 D5             	PUSH	DE
E4E8 E5             	PUSH	HL
E4E9 FD E5          	PUSH	IY
E4EB D1             	POP	DE
E4EC EB             	EX	DE,HL
E4ED CD 8E E4       	CALL	SETNAME
E4F0                ;				Attribute
E4F0 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E4F3 12             	LD	(DE),A
E4F4 13             	INC	DE
E4F5                ;				Reserved
E4F5 AF             	XOR	A
E4F6 06 0A          	LD	B,10
E4F8                SDE1:
E4F8 12             	LD	(DE),A
E4F9 13             	INC	DE
E4FA 10 FC          	DJNZ	SDE1
E4FC                					;(FCB)更新時刻
E4FC 21 E4 F1       	LD	HL,SDDATA		;(FCB)更新年月日
E4FF 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
E501                SDLOOP:					;(FCB)ファイルのサイズ(バイト単位)
E501 7E             	LD	A,(HL)
E502 23             	INC	HL
E503 32 08 E5       	LD	(SDPAT+2),A
E506 FD 7E 00       SDPAT:	LD	A,(IY+0)	;LD A,(IY+A)
E509 12             	LD	(DE),A
E50A 13             	INC	DE
E50B 10 F4          	DJNZ	SDLOOP
E50D                
E50D AF             	XOR	A
E50E E1             	POP	HL
E50F D1             	POP	DE
E510 C9             	RET
E511                
E511                WOPEN:
E511 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E514 E6 1F          	AND	01FH
E516 37             	SCF
E517 C0             	RET	NZ
E518 FD 36 1C FE    	LD	(IY+28),0FEH	;(FCB)オープンモード
E51C                TOPEN2:
E51C AF             	XOR	A
E51D                TOPEN:				;Initializes the time stamp
E51D FD 36 17 FF    	LD	(IY+23),0FFH	;(FCB)更新時刻
E521 C9             	RET
E522                
E522                WRDFX:
E522 3A 90 E3       	LD	A,(SPCPAT)	;1クラスタの論理セクタ
E525                L_WRFX:
E525 1F             	RRA			;->CF
E526 38 06          	JR	C,E_WRFX
E528 CB 39          	SRL	C
E52A CB 1C          	RR	H		;CH=CH/2
E52C 18 F7          	JR	L_WRFX
E52E                E_WRFX:
E52E 41             	LD	B,C
E52F 4C             	LD	C,H
E530 03             	INC	BC
E531 3E 37          	LD	A,037H		;SCF
E533 32 8E E9       	LD	(DRDN1),A
E536                
E536                WRDF:				;BCクラスタ分FATを確保する
E536 11 02 00       	LD	DE,2
E539 AF             	XOR	A
E53A 32 FE EA       	LD	(_SECPS),A
E53D                WRDF1:
E53D C5             	PUSH	BC
E53E D5             	PUSH	DE
E53F CD F7 F0       	CALL	_GNCL
E542 38 1C          	JR	C,WRDF3
E544 7A             	LD	A,D		;空いているかチェック
E545 B3             	OR	E
E546 20 2A          	JR	NZ,WRDF4
E548 E1             	POP	HL		;HL=空いているクラスタ
E549 E5             	PUSH	HL
E54A ED 5B FE F1    	LD	DE,(_CLPS)	;DE=元の(_CLPS)
E54E 22 FE F1       	LD	(_CLPS),HL
E551 7A             	LD	A,D		;元の(_CLPS)が 0 か?
E552 B3             	OR	E
E553 20 08          	JR	NZ,WRDF2
E555 FD 75 1A       	LD	(IY+26),L	;(FCB)ファイルの先頭クラスタ
E558 FD 74 1B       	LD	(IY+27),H	;元が空の場合はFCBにクラスタをセットする
E55B 18 03          	JR	WRDF3
E55D                WRDF2:
E55D CD FA F0       	CALL	_SNCL
E560                WRDF3:
E560 D1             	POP	DE
E561 C1             	POP	BC
E562 D8             	RET	C
E563 0B             	DEC	BC
E564 78             	LD	A,B
E565 B1             	OR	C
E566 20 0C          	JR	NZ,WRDF5	;ここでループカウンタチェック
E568 ED 5B FE F1    	LD	DE,(_CLPS)
E56C 21 FF FF       	LD	HL,0FFFFH	;FATエントリ終了(EOCマーク)
E56F C3 FA F0       	JP	_SNCL
E572                
E572                WRDF4:				;DEクラスタが空じゃないので次に移動する
E572 D1             	POP	DE
E573 C1             	POP	BC
E574                WRDF5:
E574 13             	INC	DE
E575 CD A9 E3       	CALL	ENDCL
E578 38 C3          	JR	C,WRDF1
E57A 37             	SCF
E57B C9             	RET
E57C                
E57C                RWXR:
E57C 3A 9B E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E57F                L_RWX:
E57F 1F             	RRA		;->CF
E580 38 08          	JR	C,E_RWX
E582 CB 38          	SRL	B	;BCH=BCH/2
E584 CB 19          	RR	C	;
E586 CB 1C          	RR	H	;
E588 18 F5          	JR	L_RWX
E58A                E_RWX:
E58A FD 5E 1A       	LD	E,(IY+26)	;(FCB)ファイルの先頭クラスタ
E58D FD 56 1B       	LD	D,(IY+27)
E590 AF             	XOR	A
E591 32 FE EA       	LD	(_SECPS),A
E594                RWX1:
E594 ED 53 FE F1    	LD	(_CLPS),DE
E598 7A             	LD	A,D
E599 B3             	OR	E
E59A 28 13          	JR	Z,SCF_RET	;RET DE==0 => CF=1
E59C                
E59C 78             	LD	A,B
E59D B1             	OR	C
E59E B4             	OR	H
E59F C8             	RET	Z		;RET BCH==0 => CF=0
E5A0                
E5A0 CD 06 EB       	CALL	GNCLX
E5A3 D8             	RET	C
E5A4 7C             	LD	A,H		;
E5A5 25             	DEC	H		;
E5A6 B7             	OR	A		;DEC BCH
E5A7 20 01          	JR	NZ,RWX2		;
E5A9 0B             	DEC	BC		;
E5AA                RWX2:
E5AA CD A9 E3       	CALL	ENDCL
E5AD 38 E5          	JR	C,RWX1
E5AF                SCF_RET:
E5AF 37             	SCF
E5B0 C9             	RET
E5B1                
E5B1                DSKF:
E5B1 11 00 00       	LD	DE,0
E5B4 00 00 E5 B2    MAXCLP	EQU	$-2
E5B4 2A AC F0       	LD	HL,(_FAKEFREE)
E5B7 7C             	LD	A,H
E5B8 B5             	OR	L
E5B9 28 03          	JR	Z,DSKF1
E5BB 11 01 00       	LD	DE,1
E5BE                DSKF1:
E5BE D5             	PUSH	DE
E5BF CD F7 F0       	CALL	_GNCL
E5C2 38 0C          	JR	C,POPSCF
E5C4 7A             	LD	A,D
E5C5 B3             	OR	E
E5C6 20 01          	JR	NZ,DSKF2
E5C8 23             	INC	HL
E5C9                DSKF2:
E5C9 D1             	POP	DE
E5CA 1B             	DEC	DE
E5CB 7A             	LD	A,D
E5CC B3             	OR	E
E5CD 20 EF          	JR	NZ,DSKF1
E5CF C9             	RET
E5D0                
E5D0                POPSCF:
E5D0 F1             	POP	AF
E5D1 37             	SCF
E5D2 C9             	RET
E5D3                
E5D3                SETTMS:
E5D3 FD 7E 17       	LD	A,(IY+23)	;(FCB)ファイルを最後に変更した時刻
E5D6 3C             	INC	A
E5D7 C0             	RET	NZ		;ファイルが更新されていない
E5D8                SETTMSX:			;FCBに日付時刻をセットする
E5D8 CD 8C DC       	CALL	_SYS2C		;(BDOS)時刻の獲得
E5DB                				;H←時  L←分  D←秒
E5DB CB 25          	SLA	L		;   *2
E5DD CB 25          	SLA	L		;   *4
E5DF 29             	ADD	HL,HL		;*2 *8
E5E0 29             	ADD	HL,HL		;*4 *16
E5E1 29             	ADD	HL,HL		;*8 *32
E5E2 7A             	LD	A,D
E5E3 0F             	RRCA			;bit.0->7->->->0->C
E5E4 E6 1F          	AND	01FH
E5E6 B5             	OR	L
E5E7 FD 77 16       	LD	(IY+22),A	;(FCB)ファイルを最後に変更した時刻
E5EA FD 74 17       	LD	(IY+23),H
E5ED                
E5ED CD 69 DC       	CALL	_SYS2A		;(BDOS)日付の獲得
E5F0                				;HL←年  D←月  E←日
E5F0 01 44 F8       	LD	BC,0-1980
E5F3 09             	ADD	HL,BC
E5F4 65             	LD	H,L
E5F5                
E5F5 7A             	LD	A,D
E5F6 87             	ADD	A,A		;*2
E5F7 87             	ADD	A,A		;*4
E5F8 87             	ADD	A,A		;*8
E5F9 87             	ADD	A,A		;*16
E5FA 6F             	LD	L,A
E5FB 29             	ADD	HL,HL		;*32
E5FC 7D             	LD	A,L
E5FD B3             	OR	E
E5FE FD 77 14       	LD	(IY+20),A	;(FCB)ファイルを最後に変更した日付
E601 FD 74 15       	LD	(IY+21),H
E604 C9             	RET
E605                
E605                PUSHRR:
E605 32 9D E6       	LD	(SETSEQ_SWC_RND),A
E608 22 AF E6       	LD	(SETSEQ_SWC_SEQ_RR),HL
E60B CD 2B E6       	CALL	GET_RR_AHL
E60E 22 0F F0       	LD	(RR_BUF_HL),HL
E611 32 11 F0       	LD	(RR_BUF_A),A
E614 C9             	RET
E615                
E615                GET_CPM_R_SIZE:		;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
E615 87             	ADD	A,A		;in BHLA => out AHL
E616 ED 6A          	ADC	HL,HL
E618 CB 18          	RR	B
E61A B7             	OR	A
E61B 78             	LD	A,B		;ここでフラグは変化しない
E61C C8             	RET	Z
E61D 2C             	INC	L		;INC AHL
E61E C0             	RET	NZ		;
E61F 24             	INC	H		;
E620 C0             	RET	NZ		;
E621 3C             	INC	A		;
E622 C9             	RET
E623                
E623                INIT_RND:
E623 3E CD          	LD	A,0CDH		;CALL ????
E625 21 72 E6       	LD	HL,POPRR
E628 CD 05 E6       	CALL	PUSHRR
E62B                GET_RR_AHL:
E62B FD 6E 21       	LD	L,(IY+33)	;(FCB)Random record
E62E FD 66 22       	LD	H,(IY+34)	;
E631 FD 7E 23       	LD	A,(IY+35)	;
E634 C9             	RET
E635                SET_RR_AHL:
E635 FD 75 21       	LD	(IY+33),L	;(FCB)Random record
E638 FD 74 22       	LD	(IY+34),H
E63B FD 77 23       	LD	(IY+35),A
E63E C9             	RET
E63F                INIT_SEQ:
E63F 3E 01          	LD	A,1		;LD BC,????
E641 21 6F E6       	LD	HL,SETSEQ
E644 CD 05 E6       	CALL	PUSHRR
E647                GETSEQ:
E647 FD 6E 20       	LD	L,(IY+32)	;(FCB)カレントレコード
E64A FD 66 0C       	LD	H,(IY+12)	;(FCB)カレントブロック
E64D AF             	XOR	A
E64E                
E64E CB 25          	SLA	L	;L=L*2
E650                
E650 CB 3C          	SRL	H	;HL=HL/2
E652 CB 1D          	RR	L	;
E654 C9             	RET
E655                
E655                SETSEQ1:
E655 F5             	PUSH	AF
E656 E5             	PUSH	HL		;AHL=Random record
E657 CD 2B E6       	CALL	GET_RR_AHL
E65A 47             	LD	B,A		;AHL→HLA
E65B 7D             	LD	A,L		;(IY+33)(FCB)ランダムレコード
E65C 6C             	LD	L,H		;(IY+34)
E65D 60             	LD	H,B		;(IY+35)
E65E 06 00          	LD	B,0
E660                
E660 CD 15 E6       	CALL	GET_CPM_R_SIZE
E663                
E663 29             	ADD	HL,HL
E664 CB 3D          	SRL	L		;L=L/2
E666 FD 75 20       	LD	(IY+32),L	;(FCB)カレントレコード
E669 FD 74 0C       	LD	(IY+12),H	;(FCB)カレントブロック
E66C E1             	POP	HL
E66D F1             	POP	AF
E66E C9             	RET
E66F                SETSEQ:
E66F CD 55 E6       	CALL	SETSEQ1
E672                POPRR:
E672 F5             	PUSH	AF
E673 E5             	PUSH	HL
E674 2A 0F F0       	LD	HL,(RR_BUF_HL)
E677 3A 11 F0       	LD	A,(RR_BUF_A)
E67A CD 35 E6       	CALL	SET_RR_AHL
E67D E1             	POP	HL
E67E F1             	POP	AF
E67F C9             	RET
E680                
E680                RB_WRITE:
E680 C5             	PUSH	BC
E681 ED 4B 4C F1    	LD	BC,(STABLE+2*026H)	;(BDOS)ランダムブロック書き込み
E685 18 05          	JR	RBRW
E687                RB_READ:
E687 C5             	PUSH	BC
E688 ED 4B 4E F1    	LD	BC,(STABLE+2*027H)	;(BDOS)ランダムブロック読み込み
E68C                RBRW:
E68C 1F             	RRA		;AHL = AHL*128
E68D 7C             	LD	A,H	;AHL = AHL0/2
E68E 1F             	RRA		;A
E68F 65             	LD	H,L	;
E690 CB 1C          	RR	H	;H
E692 2E 00          	LD	L,0	;
E694 CB 1D          	RR	L	;L
E696 CD 35 E6       	CALL	SET_RR_AHL
E699 21 80 00       	LD	HL,128
E69C C5             	PUSH	BC
E69D                SETSEQ_SWC_RND:
E69D CD 55 E6       	CALL	SETSEQ1
E6A0 C1             	POP	BC
E6A1 FD CB 20 FE    	SET	7,(IY+32)	;(FCB)カレントレコード
E6A5 FD E5          	PUSH	IY
E6A7 D1             	POP	DE
E6A8 D5             	PUSH	DE
E6A9 CD B7 E6       	CALL	JP_BC
E6AC FD E1          	POP	IY
E6AE CD 6F E6       	CALL	SETSEQ
E6B1 00 00 E6 AF    SETSEQ_SWC_SEQ_RR	EQU $-2
E6B1 FD CB 20 BE    	RES	7,(IY+32)	;(FCB)カレントレコード
E6B5                
E6B5 C1             	POP	BC
E6B6 C9             	RET
E6B7                JP_BC:
E6B7 C5             	PUSH	BC
E6B8 C9             	RET
E6B9                
E6B9 00 00 E2 39    _SYS03	EQU	SCF_FF_RET	;(BDOS)外部入力
E6B9 00 00 E2 39    _SYS2B	EQU	SCF_FF_RET	;(BDOS)日付の設定
E6B9 00 00 E2 39    _SYS2D	EQU	SCF_FF_RET	;(BDOS)時刻の設定
E6B9 00 00 E2 39    _SYS39	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの作成
E6B9 00 00 E2 39    _SYS3A	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの削除
E6B9                
E6B9                	INCLUDE	"LDFILE2.ASM"
E6B9                
E6B9                ;	LSX-Dodgers FILE2
E6B9                
E6B9                				;Write random block
E6B9                _SYS26:		;(BDOS)ランダムブロック書き込み
E6B9 AF             	XOR	A
E6BA 32 8E E9       	LD	(DRDN1),A	;NOP
E6BD 22 DE E8       	LD	(RBSIZE),HL	;HL←書き込むレコード数
E6C0 22 5D F0       	LD	(LEFTX),HL
E6C3 CD 8E E1       	CALL	SETDRV
E6C6                
E6C6 CD 36 E8       	CALL	RBX0
E6C9 DA 56 E7       	JP	C,RBWERR
E6CC CD 11 E5       	CALL	WOPEN
E6CF DA 56 E7       	JP	C,RBWERR
E6D2 7C             	LD	A,H
E6D3 B5             	OR	L
E6D4 CA 4F E7       	JP	Z,RBW1
E6D7                
E6D7 2B             	DEC	HL
E6D8                
E6D8 CD F4 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E6DB                
E6DB 19             	ADD	HL,DE		;BCHL=HL+BCDE
E6DC 30 01          	JR	NC,S26X1	;
E6DE 03             	INC	BC		;
E6DF                S26X1:
E6DF CD 7C E5       	CALL	RWXR
E6E2 DC 22 E5       	CALL	C,WRDFX
E6E5 DA 56 E7       	JP	C,RBWERR
E6E8                
E6E8 CD 65 E8       	CALL	RBX2
E6EB 28 1A          	JR	Z,RBWB		;NZ=セクタ以下の端数がある
E6ED CD 84 E8       	CALL	RBXA
E6F0 38 64          	JR	C,RBWERR
E6F2 EB             	EX	DE,HL
E6F3 C5             	PUSH	BC
E6F4 ED B0          	LDIR
E6F6 22 5F F0       	LD	(DTAX),HL
E6F9                
E6F9 CD B6 E4       	CALL	SWTDBF		;バッファデータは更新された
E6FC                
E6FC 2A 5D F0       	LD	HL,(LEFTX)
E6FF D1             	POP	DE
E700 ED 52          	SBC	HL,DE
E702 22 5D F0       	LD	(LEFTX),HL
E705 28 31          	JR	Z,RBWEND
E707                
E707                RBWB:
E707 CD B9 E8       	CALL	RBXB
E70A 28 14          	JR	Z,RBWC
E70C                RBWB1:
E70C C5             	PUSH	BC
E70D D5             	PUSH	DE
E70E CD 8C E3       	CALL	CLUSTX
E711 CD 08 E9       	CALL	DWTC
E714 D1             	POP	DE
E715 C1             	POP	BC
E716 D4 06 EB       	CALL	NC,GNCLX
E719 38 3B          	JR	C,RBWERR
E71B 10 EF          	DJNZ	RBWB1
E71D CD 58 E9       	CALL	DRW_FLUSH
E720                RBWC:
E720 CD D1 E8       	CALL	RBXC
E723 28 13          	JR	Z,RBWEND
E725 C5             	PUSH	BC
E726 CD 8C E3       	CALL	CLUSTX
E729 CD 8D E9       	CALL	DRDN
E72C C1             	POP	BC
E72D 38 27          	JR	C,RBWERR
E72F ED 5B 7E F1    	LD	DE,(_DTBUF)
E733 ED B0          	LDIR
E735 CD B6 E4       	CALL	SWTDBF		;バッファデータは更新された
E738                RBWEND:
E738 CD DD E8       	CALL	RBXEND
E73B                
E73B CD 45 E8       	CALL	RBX1
E73E 30 0F          	JR	NC,RBW1		;ランダムレコードの方が大きい場合はサイズを合わせる
E740 CD F4 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E743 FD 73 10       	LD	(IY+16),E	;ファイルのサイズ(バイト単位)
E746 FD 72 11       	LD	(IY+17),D	;
E749 FD 71 12       	LD	(IY+18),C	;
E74C FD 70 13       	LD	(IY+19),B	;
E74F                RBW1:
E74F FD E1          	POP	IY
E751 C1             	POP	BC
E752 D1             	POP	DE
E753 E1             	POP	HL
E754                DD_NUL:
E754 AF             	XOR	A
E755                DRDF0:
E755                DWTF0:
E755 C9             	RET
E756                
E756                RBWERR:
E756 FD E5          	PUSH	IY
E758 D1             	POP	DE
E759 2A 20 F1       	LD	HL,(STABLE+2*010H)
E75C CD 0F 00       	CALL	JP_HL
E75F                RBRERR1:
E75F 3E 01          	LD	A,001H
E761                RBRERR2:
E761 FD E1          	POP	IY
E763 C1             	POP	BC
E764 D1             	POP	DE
E765 E1             	POP	HL
E766 37             	SCF
E767 21 00 00       	LD	HL,0
E76A C9             	RET
E76B                
E76B                RBRERR:
E76B 3E FF          	LD	A,0FFH
E76D 18 F2          	JR	RBRERR2
E76F                
E76F                RBRFL:
E76F 3E 00          RBRFLP:	LD	A,000H
E771 FE 0D          	CP	00DH
E773 20 05          	JR	NZ,RBRFL1
E775 D5             	PUSH	DE
E776 1E 0A          	LD	E,00AH
E778 18 05          	JR	RBRFL2
E77A                RBRFL1:
E77A D5             	PUSH	DE
E77B CD 09 F0       	CALL	_SYS07
E77E 5F             	LD	E,A
E77F                RBRFL2:
E77F CD CD F0       	CALL	_PRINT
E782 7B             	LD	A,E
E783 D1             	POP	DE
E784 32 70 E7       	LD	(RBRFLP+1),A
E787 C9             	RET
E788                DDX:
E788 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
E78B CD B1 E3       	CALL	CAP
E78E FE 41          	CP	'A'
E790 C9             	RET
E791                
E791                				;Read random block
E791                _SYS27:		;(BDOS)ランダムブロック読み込み
E791 22 5D F0       	LD	(LEFTX),HL
E794 CD 8E E1       	CALL	SETDRV
E797                
E797 FD CB 0D 66    	BIT	4,(IY+13)	;(FCB)属性(アトリビュート)
E79B C2 24 E8       	JP	NZ,RBRDIR	;ディレクトリ
E79E CD 36 E8       	CALL	RBX0
E7A1 DA 6B E7       	JP	C,RBRERR
E7A4 CD 45 E8       	CALL	RBX1
E7A7 D4 5D E8       	CALL	NC,RBX1R
E7AA DA 5F E7       	JP	C,RBRERR1
E7AD EB             	EX	DE,HL
E7AE ED 52          	SBC	HL,DE		;CP 00HL,BCDE
E7B0 19             	ADD	HL,DE
E7B1 79             	LD	A,C
E7B2 DE 00          	SBC	A,0
E7B4 78             	LD	A,B
E7B5 DE 00          	SBC	A,0
E7B7 38 01          	JR	C,RBR1
E7B9 EB             	EX	DE,HL
E7BA                RBR1:
E7BA 9F             	SBC	A,A
E7BB E6 01          	AND	1
E7BD 32 22 E8       	LD	(RBRAP+1),A
E7C0                
E7C0 7C             	LD	A,H
E7C1 B5             	OR	L
E7C2 28 57          	JR	Z,RBREND0
E7C4                
E7C4 22 DE E8       	LD	(RBSIZE),HL	;HL←読み込むレコード数
E7C7 22 5D F0       	LD	(LEFTX),HL
E7CA                
E7CA CD 65 E8       	CALL	RBX2
E7CD 28 19          	JR	Z,RBRB
E7CF CD 84 E8       	CALL	RBXA
E7D2 DA 6B E7       	JP	C,RBRERR
E7D5 C5             	PUSH	BC
E7D6 ED B0          	LDIR
E7D8 ED 53 5F F0    	LD	(DTAX),DE
E7DC 2A 5D F0       	LD	HL,(LEFTX)
E7DF D1             	POP	DE
E7E0 A7             	AND	A
E7E1 ED 52          	SBC	HL,DE
E7E3 22 5D F0       	LD	(LEFTX),HL
E7E6 28 30          	JR	Z,RBREND
E7E8                
E7E8                RBRB:
E7E8 CD B9 E8       	CALL	RBXB
E7EB 28 15          	JR	Z,RBRC
E7ED                RBRB1:
E7ED C5             	PUSH	BC
E7EE D5             	PUSH	DE
E7EF CD 8C E3       	CALL	CLUSTX
E7F2 CD 0E E9       	CALL	DRDC
E7F5 D1             	POP	DE
E7F6 C1             	POP	BC
E7F7 D4 06 EB       	CALL	NC,GNCLX
E7FA DA 6B E7       	JP	C,RBRERR
E7FD 10 EE          	DJNZ	RBRB1
E7FF CD 58 E9       	CALL	DRW_FLUSH
E802                RBRC:
E802 CD D1 E8       	CALL	RBXC
E805 28 11          	JR	Z,RBREND
E807 C5             	PUSH	BC
E808 CD 8C E3       	CALL	CLUSTX
E80B CD 71 E9       	CALL	DRDX
E80E C1             	POP	BC
E80F DA 6B E7       	JP	C,RBRERR
E812 EB             	EX	DE,HL
E813 2A 7E F1       	LD	HL,(_DTBUF)
E816 ED B0          	LDIR
E818                RBREND:
E818 CD DD E8       	CALL	RBXEND
E81B                RBREND0:
E81B FD E1          	POP	IY
E81D C1             	POP	BC
E81E D1             	POP	DE
E81F F1             	POP	AF	;(HL)
E820 AF             	XOR	A
E821 3E 00          RBRAP:	LD	A,000H
E823 C9             	RET
E824                
E824                RBRDIR:
E824 FD 6E 1A       	LD	L,(IY+26)	;(FCB)ファイルの先頭クラスタ
E827 FD 66 1B       	LD	H,(IY+27)
E82A CD C7 E3       	CALL	CHDIR
E82D AF             	XOR	A
E82E 67             	LD	H,A
E82F 6F             	LD	L,A
E830 3C             	INC	A
E831 32 22 E8       	LD	(RBRAP+1),A
E834 18 E5          	JR	RBREND0
E836                
E836                RBX0:
E836 2A 8A F0       	LD	HL,(_DTA)
E839 22 5F F0       	LD	(DTAX),HL
E83C 2A 5D F0       	LD	HL,(LEFTX)
E83F FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
E842 D6 FD          	SUB	0FDH
E844 C9             	RET
E845                
E845                RBX1:				;ファイルサイズとランダムレコードを比べる
E845 E5             	PUSH	HL		;Record byte
E846                				;AHL=File size
E846 FD 6E 10       	LD	L,(IY+16)	;ファイルのサイズ(バイト単位)
E849 FD 66 11       	LD	H,(IY+17)	;
E84C FD 7E 12       	LD	A,(IY+18)	;
E84F                
E84F CD F4 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E852                
E852 A7             	AND	A
E853 ED 52          	SBC	HL,DE
E855 99             	SBC	A,C
E856 4F             	LD	C,A
E857 FD 7E 13       	LD	A,(IY+19)	;ファイルのサイズ
E85A 98             	SBC	A,B
E85B D1             	POP	DE
E85C C9             	RET
E85D                RBX1R:
E85D 47             	LD	B,A
E85E B1             	OR	C
E85F EB             	EX	DE,HL	;BCDE=File byte	HL=Record byte
E860 B2             	OR	D
E861 B3             	OR	E
E862 C0             	RET	NZ
E863 37             	SCF
E864 C9             	RET
E865                
E865                RBX2:				;Cluster settings
E865 FD 66 22       	LD	H,(IY+34)	;(+33)(FCB)ランダムレコード
E868 FD 4E 23       	LD	C,(IY+35)
E86B 06 00          	LD	B,0
E86D FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E871 20 03          	JR	NZ,RBX3
E873 FD 46 24       	LD	B,(IY+36)
E876                RBX3:
E876 CD 7C E5       	CALL	RWXR
E879 3A 9B E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E87C 3D             	DEC	A
E87D FD A6 22       	AND	(IY+34)
E880 FD B6 21       	OR	(IY+33)
E883 C9             	RET
E884                
E884                RBXA:
E884 C5             	PUSH	BC
E885 D5             	PUSH	DE
E886 CD 8C E3       	CALL	CLUSTX
E889 CD 71 E9       	CALL	DRDX
E88C D1             	POP	DE
E88D C1             	POP	BC
E88E D4 06 EB       	CALL	NC,GNCLX
E891 D8             	RET	C
E892 ED 53 FE F1    	LD	(_CLPS),DE
E896                
E896 FD 4E 21       	LD	C,(IY+33)	;(FCB)ランダムレコード
E899 21 00 04       SECSZ:	LD	HL,0400H	;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
E89C 7C             	LD	A,H
E89D 3D             	DEC	A		;1024=3 / 512=1
E89E FD A6 22       	AND	(IY+34)		;(FCB)ランダムレコード
E8A1 47             	LD	B,A		;BCに1セクタ以下の端数が入る
E8A2 ED 42          	SBC	HL,BC		;残りを計算
E8A4                
E8A4 ED 5B 5D F0    	LD	DE,(LEFTX)
E8A8 ED 52          	SBC	HL,DE		;CP HL,DE
E8AA 19             	ADD	HL,DE		;
E8AB 38 01          	JR	C,RBXA1		;DEとHLを比較して大きい方をHLに
E8AD EB             	EX	DE,HL
E8AE                RBXA1:
E8AE E5             	PUSH	HL
E8AF 2A 7E F1       	LD	HL,(_DTBUF)
E8B2 09             	ADD	HL,BC
E8B3 ED 5B 5F F0    	LD	DE,(DTAX)
E8B7 C1             	POP	BC
E8B8 C9             	RET
E8B9                
E8B9                RBXB:
E8B9 2A 5F F0       	LD	HL,(DTAX)
E8BC ED 5B FE F1    	LD	DE,(_CLPS)
E8C0 3A 5E F0       	LD	A,(LEFTX+1)
E8C3 47             	LD	B,A
E8C4 3A 9B E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8C7                RBXB1:
E8C7 1F             	RRA		;->CF
E8C8 38 04          	JR	C,RBXB2
E8CA CB 38          	SRL	B	;B=B/2
E8CC 18 F9          	JR	RBXB1
E8CE                RBXB2:
E8CE 78             	LD	A,B
E8CF B7             	OR	A
E8D0 C9             	RET
E8D1                
E8D1                RBXC:
E8D1 ED 4B 5D F0    	LD	BC,(LEFTX)
E8D5 3A 9B E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8D8 3D             	DEC	A
E8D9 A0             	AND	B
E8DA 47             	LD	B,A		;1セクタ以下の端数がない場合はZ
E8DB B1             	OR	C
E8DC C9             	RET
E8DD                
E8DD                RBXEND:				;レコード数だけランダムレコードを進める
E8DD 11 00 00       	LD	DE,0		;進めるレコード数(RBSIZE)
E8E0 00 00 E8 DE    RBSIZE	EQU	$-2
E8E0 CD 2B E6       	CALL	GET_RR_AHL
E8E3 19             	ADD	HL,DE
E8E4 CE 00          	ADC	A,0
E8E6 CD 35 E6       	CALL	SET_RR_AHL
E8E9 EB             	EX	DE,HL		;HL=進めるレコード数
E8EA D0             	RET	NC
E8EB FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E8EF C0             	RET	NZ
E8F0 FD 34 24       	INC	(IY+36)
E8F3 C9             	RET
E8F4                
E8F4                GET_RR_BCDE:			;BCDE=Random record
E8F4 FD 5E 21       	LD	E,(IY+33)	;(FCB)ランダムレコード
E8F7 FD 56 22       	LD	D,(IY+34)
E8FA FD 4E 23       	LD	C,(IY+35)
E8FD 06 00          	LD	B,0		;CP/M互換のアクセスの場合はFCBは36バイト
E8FF FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E903 C0             	RET	NZ
E904 FD 46 24       	LD	B,(IY+36)
E907 C9             	RET
E908                
E908                ;	ランダムブロックアクセスの連続したセクタをまとめる
E908                
E908                DWTC:
E908 E5             	PUSH	HL
E909 21 98 EC       	LD	HL,DWT24B
E90C 18 04          	JR	DWTC1
E90E                DRDC:
E90E E5             	PUSH	HL
E90F 21 88 EC       	LD	HL,DRD24B
E912                DWTC1:
E912 22 6C E9       	LD	(DRWF_MODE),HL
E915 E1             	POP	HL
E916 3A 5C E9       	LD	A,(DRWF_B)
E919 B7             	OR	A
E91A 20 0F          	JR	NZ,DRDC1
E91C                SAVE_DRWC:
E91C 06 01          	LD	B,1
E91E ED 43 5B E9    	LD	(DRWF_C),BC
E922 ED 53 62 E9    	LD	(DRWF_E),DE
E926 22 65 E9       	LD	(DRWF_HL),HL
E929 18 20          	JR	INC_HL_DRWC
E92B                DRDC1:
E92B E5             	PUSH	HL
E92C 21 62 E9       	LD	HL,DRWF_E
E92F 86             	ADD	A,(HL)
E930 F5             	PUSH	AF
E931 BB             	CP	E
E932 20 1D          	JR	NZ,DRDC2
E934 F1             	POP	AF
E935 23             	INC	HL
E936 7E             	LD	A,(HL)
E937 CE 00          	ADC	A,0
E939 F5             	PUSH	AF
E93A BA             	CP	D
E93B 20 14          	JR	NZ,DRDC2
E93D F1             	POP	AF
E93E 3A 5B E9       	LD	A,(DRWF_C)
E941 CE 00          	ADC	A,0
E943 B9             	CP	C
E944 20 0C          	JR	NZ,DRDC3
E946 21 5C E9       	LD	HL,DRWF_B
E949 34             	INC	(HL)
E94A E1             	POP	HL
E94B                INC_HL_DRWC:
E94B 3A 9B E8       	LD	A,(SECSZ+2)		;1セクタのサイズの上位1バイト
E94E 84             	ADD	A,H
E94F 67             	LD	H,A
E950 C9             	RET
E951                DRDC2:
E951 F1             	POP	AF
E952                DRDC3:
E952 CD 58 E9       	CALL	DRW_FLUSH
E955 E1             	POP	HL
E956 18 C4          	JR	SAVE_DRWC
E958                
E958                ;	ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
E958                DRW_FLUSH:
E958 C5             	PUSH	BC
E959 D5             	PUSH	DE
E95A 01 00 00       	LD	BC,0
E95D 00 00 E9 5B    DRWF_C	EQU	$-2
E95D 00 00 E9 5C    DRWF_B	EQU	$-1
E95D 78             	LD	A,B
E95E B7             	OR	A
E95F 28 0D          	JR	Z,DRDF1
E961 11 00 00       	LD	DE,0
E964 00 00 E9 62    DRWF_E	EQU	$-2
E964 00 00 E9 63    DRWF_D	EQU	$-1
E964 21 00 00       	LD	HL,0
E967 00 00 E9 65    DRWF_HL	EQU	$-2
E967 AF             	XOR	A
E968 32 5C E9       	LD	(DRWF_B),A
E96B CD 88 EC       	CALL	DRD24B
E96E 00 00 E9 6C    DRWF_MODE	EQU	$-2
E96E                DRDF1:
E96E D1             	POP	DE
E96F C1             	POP	BC
E970 C9             	RET
E971                	INCLUDE	"LDDIO.ASM"
E971                
E971                ;	LSX-Dodgers DIO
E971                
E971                DRDX:
E971 CD AF E9       	CALL	DRDY
E974 C8             	RET	Z
E975 CD 95 E9       	CALL	DRDX1		;データバッファの情報を保存
E978 D8             	RET	C
E979 E5             	PUSH	HL
E97A C5             	PUSH	BC
E97B D5             	PUSH	DE
E97C 2A 7E F1       	LD	HL,(_DTBUF)
E97F 3A D8 E9       	LD	A,(_DBS24)
E982 4F             	LD	C,A
E983 CD 86 EC       	CALL	DRD24
E986 DC AA E9       	CALL	C,DRDNE
E989                POP_DE_BC_HL_RET:
E989 D1             	POP	DE
E98A C1             	POP	BC
E98B E1             	POP	HL
E98C C9             	RET
E98D                
E98D                ;	CDE:セクタ番号
E98D                DRDN:
E98D AF             	XOR	A
E98E 00             DRDN1:	NOP			;自己書き換え NOP / SCF
E98F 30 E0          	JR	NC,DRDX
E991                DRDNX:
E991 CD AF E9       	CALL	DRDY
E994 C8             	RET	Z
E995                DRDX1:
E995 CD C5 E9       	CALL	DWTX
E998                				;データバッファの読み込んだドライブ・セクタ情報を保存
E998 ED 53 A6 F0    	LD	(_DBSEC),DE
E99C 79             	LD	A,C
E99D 32 D8 E9       	LD	(_DBS24),A
E9A0                
E9A0 3A 88 F0       	LD	A,(_DRV)
E9A3 32 A5 F0       	LD	(_DBDRV),A
E9A6 CD D9 F0       	CALL	_CHGDRV
E9A9 D0             	RET	NC
E9AA                DRDNE:
E9AA 9F             	SBC	A,A		;CF=1ならばA=0FFH
E9AB 32 A5 F0       	LD	(_DBDRV),A
E9AE C9             	RET
E9AF                
E9AF                ;	CDE:セクタ番号
E9AF                DRDY:
E9AF 3A D8 E9       	LD	A,(_DBS24)
E9B2 B9             	CP	C
E9B3 C0             	RET	NZ
E9B4                
E9B4 E5             	PUSH	HL
E9B5 3A 88 F0       	LD	A,(_DRV)
E9B8 21 A5 F0       	LD	HL,_DBDRV
E9BB AE             	XOR	(HL)
E9BC 20 05          	JR	NZ,POP_HL_RET
E9BE                
E9BE 2A A6 F0       	LD	HL,(_DBSEC)
E9C1 ED 52          	SBC	HL,DE		;上でXORを使っているのでCF=0のはず
E9C3                POP_HL_RET:
E9C3 E1             	POP	HL
E9C4 C9             	RET
E9C5                
E9C5                DWTX:
E9C5 3A A4 F0       	LD	A,(_WTDBF)
E9C8 B7             	OR	A
E9C9 C8             	RET	Z
E9CA AF             	XOR	A
E9CB 32 A4 F0       	LD	(_WTDBF),A
E9CE                
E9CE E5             	PUSH	HL
E9CF C5             	PUSH	BC
E9D0 D5             	PUSH	DE
E9D1 3A A5 F0       	LD	A,(_DBDRV)
E9D4 CD D9 F0       	CALL	_CHGDRV
E9D7 0E 00          	LD	C,0
E9D9 00 00 E9 D8    _DBS24	EQU	$-1
E9D9 ED 5B A6 F0    	LD	DE,(_DBSEC)
E9DD 2A 7E F1       	LD	HL,(_DTBUF)
E9E0 D4 96 EC       	CALL	NC,DWT24
E9E3                POP_DE_BC_HL_RET2:
E9E3 18 A4          	JR	POP_DE_BC_HL_RET
E9E5                
E9E5                RDFATX:
E9E5 E5             	PUSH	HL
E9E6 3A 88 F0       	LD	A,(_DRV)
E9E9 21 AA F0       	LD	HL,_FATDRV
E9EC AE             	XOR	(HL)
E9ED 28 D4          	JR	Z,POP_HL_RET
E9EF                
E9EF C5             	PUSH	BC
E9F0 D5             	PUSH	DE
E9F1 DD E5          	PUSH	IX
E9F3 CD 0F EA       	CALL	WTFATX
E9F6 38 13          	JR	C,POP_IX_DE_BC_HL_RET
E9F8                
E9F8 AF             	XOR	A
E9F9 32 AB F0       	LD	(_FATIX),A
E9FC 3A 88 F0       	LD	A,(_DRV)
E9FF 32 AA F0       	LD	(_FATDRV),A
EA02 CD E5 F0       	CALL	_RDFAT
EA05                RDFATE2:
EA05 30 04          	JR	NC,POP_IX_DE_BC_HL_RET
EA07 9F             	SBC	A,A		;A=0xFF
EA08 32 AA F0       	LD	(_FATDRV),A
EA0B                POP_IX_DE_BC_HL_RET:
EA0B DD E1          	POP	IX
EA0D 18 D4          	JR	POP_DE_BC_HL_RET2
EA0F                
EA0F                WTFATX:
EA0F 3A A2 F0       	LD	A,(_WTFATF)
EA12 B7             	OR	A
EA13 C8             	RET	Z
EA14 E5             	PUSH	HL
EA15 3A AA F0       	LD	A,(_FATDRV)
EA18 21 A5 F0       	LD	HL,_DBDRV
EA1B AE             	XOR	(HL)
EA1C CC C5 E9       	CALL	Z,DWTX
EA1F 38 A2          	JR	C,POP_HL_RET
EA21 C5             	PUSH	BC
EA22 D5             	PUSH	DE
EA23 DD E5          	PUSH	IX
EA25 CD A3 EC       	CALL	WTFAT
EA28 AF             	XOR	A
EA29 32 A2 F0       	LD	(_WTFATF),A
EA2C 18 DD          	JR	POP_IX_DE_BC_HL_RET
EA2E                
EA2E                NCL1:
EA2E 7A             	LD	A,D
EA2F B3             	OR	E
EA30 37             	SCF
EA31 C8             	RET	Z
EA32                
EA32 7A             	LD	A,D
EA33 CB 3F          	SRL	A	;/2
EA35 CB 3F          	SRL	A	;/2
EA37                
EA37 E5             	PUSH	HL
EA38 32 57 EA       	LD	(NCLPAT_FATIX),A	;_FATIX
EA3B 2A AA F0       	LD	HL,(_FATDRV)	;L=_FATDRV H=_FATIX
EA3E BC             	CP	H
EA3F 3A 88 F0       	LD	A,(_DRV)	;LDではフラグは変化しない
EA42 32 56 EA       	LD	(NCLPAT_FATDRV),A	;_FATDRV
EA45 20 05          	JR	NZ,NCL2		;FATIXが違う
EA47 BD             	CP	L
EA48 20 02          	JR	NZ,NCL2		;ドライブが違う
EA4A E1             	POP	HL
EA4B C9             	RET
EA4C                NCL2:
EA4C C5             	PUSH	BC
EA4D D5             	PUSH	DE
EA4E DD E5          	PUSH	IX
EA50 CD 0F EA       	CALL	WTFATX
EA53 38 B6          	JR	C,POP_IX_DE_BC_HL_RET
EA55 01 00 00       	LD	BC,0		;自己書き換え C=_FATDRV B=_FATIX
EA58 00 00 EA 57    NCLPAT_FATIX	EQU	$-1
EA58 00 00 EA 56    NCLPAT_FATDRV	EQU	$-2
EA58 ED 43 AA F0    	LD	(_FATDRV),BC
EA5C CD 78 EC       	CALL	RDFATS
EA5F 18 A4          	JR	RDFATE2
EA61                
EA61                NCL3:
EA61 CB 9A          	RES	3,D
EA63 CB 92          	RES	2,D
EA65 6B             	LD	L,E
EA66 62             	LD	H,D
EA67 CB 3C          	SRL	H	;
EA69 CB 1D          	RR	L	;HLA=HLA/2
EA6B 1F             	RRA		;
EA6C F5             	PUSH	AF
EA6D 3A AB F0       	LD	A,(_FATIX)
EA70 0F             	RRCA
EA71 30 0B          	JR	NC,NCL3X1
EA73 3A 9B E8       	LD	A,(SECSZ+2)
EA76 FE 04          	CP	4		;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
EA78 20 04          	JR	NZ,NCL3X1
EA7A 01 00 02       	LD	BC,512
EA7D 09             	ADD	HL,BC
EA7E                NCL3X1:
EA7E F1             	POP	AF
EA7F ED 4B 7C F1    	LD	BC,(_FATBF)
EA83 19             	ADD	HL,DE
EA84 09             	ADD	HL,BC
EA85 17             	RLA
EA86 C9             	RET
EA87                
EA87                GNCL:
EA87 CD 2E EA       	CALL	NCL1		;GET NEXT CLUSTER
EA8A D8             	RET	C
EA8B C5             	PUSH	BC
EA8C E5             	PUSH	HL
EA8D CD 61 EA       	CALL	NCL3
EA90 38 09          	JR	C,GNC1
EA92 5E             	LD	E,(HL)
EA93 23             	INC	HL
EA94 7E             	LD	A,(HL)
EA95 E6 0F          	AND	00FH
EA97 57             	LD	D,A
EA98 E1             	POP	HL
EA99 C1             	POP	BC
EA9A C9             	RET
EA9B                GNC1:
EA9B 7E             	LD	A,(HL)
EA9C 23             	INC	HL
EA9D 56             	LD	D,(HL)
EA9E 06 04          	LD	B,4
EAA0                GNC1L:
EAA0 CB 3A          	SRL	D	;DA=DA/2
EAA2 1F             	RRA		;
EAA3 10 FB          	DJNZ	GNC1L
EAA5                
EAA5 5F             	LD	E,A
EAA6 E1             	POP	HL
EAA7 C1             	POP	BC
EAA8 A7             	AND	A
EAA9 C9             	RET
EAAA                
EAAA                SNCL:
EAAA CD 2E EA       	CALL	NCL1
EAAD D8             	RET	C
EAAE                ;				SET NEXT CLUSTER
EAAE E5             	PUSH	HL
EAAF C5             	PUSH	BC
EAB0 D5             	PUSH	DE
EAB1 E5             	PUSH	HL
EAB2 CD 61 EA       	CALL	NCL3
EAB5 D1             	POP	DE
EAB6                ;CF=ODD
EAB6 7E             	LD	A,(HL)
EAB7 73             	LD	(HL),E
EAB8 38 06          	JR	C,SNC1
EABA                ;EVEN
EABA                ;M[0] = E
EABA                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
EABA 23             	INC	HL
EABB ED 67          	RRD		;M={A[3:0],E[3:0]}
EABD 7A             	LD	A,D
EABE 18 04          	JR	SNC11
EAC0                SNC1:
EAC0                ;ODD
EAC0                ;HL[0] = (HL[0]&0x0F) | (E<<4)
EAC0                ;HL[1] = DE>>4
EAC0 ED 6F          	RLD		;M={D[3:0],E[7:4]}
EAC2 23             	INC	HL
EAC3 72             	LD	(HL),D	;M={D[3:0],E[7:4]}
EAC4                SNC11:
EAC4 ED 6F          	RLD		;M={M[7:4],D[3:0]}
EAC6 B7             	OR	A
EAC7 D1             	POP	DE
EAC8 C1             	POP	BC
EAC9 E1             	POP	HL
EACA                FAT_CHANGED:
EACA 3E 01          	LD	A,1
EACC 32 A2 F0       	LD	(_WTFATF),A
EACF C9             	RET
EAD0                
EAD0                N16CL3:
EAD0 C5             	PUSH	BC
EAD1 6B             	LD	L,E
EAD2 7A             	LD	A,D
EAD3 E6 03          	AND	3
EAD5 67             	LD	H,A
EAD6 29             	ADD	HL,HL
EAD7 ED 4B 7C F1    	LD	BC,(_FATBF)
EADB 09             	ADD	HL,BC
EADC C1             	POP	BC
EADD C9             	RET
EADE                
EADE                GNCL16:
EADE CD 2E EA       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EAE1 D8             	RET	C
EAE2 E5             	PUSH	HL
EAE3 CD D0 EA       	CALL	N16CL3
EAE6 5E             	LD	E,(HL)
EAE7 23             	INC	HL
EAE8 56             	LD	D,(HL)
EAE9 E1             	POP	HL
EAEA C9             	RET
EAEB                
EAEB                SNCL16:
EAEB CD 2E EA       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EAEE D8             	RET	C
EAEF D5             	PUSH	DE
EAF0 E5             	PUSH	HL
EAF1 CD D0 EA       	CALL	N16CL3
EAF4 D1             	POP	DE		;HL
EAF5 73             	LD	(HL),E
EAF6 23             	INC	HL
EAF7 72             	LD	(HL),D
EAF8 6B             	LD	L,E
EAF9 62             	LD	H,D
EAFA D1             	POP	DE
EAFB 18 CD          	JR	FAT_CHANGED
EAFD                
EAFD                ;------------------------
EAFD                ;次のセクタを探す際に_SECPSの値をチェック
EAFD                ;in
EAFD                ;	DE : セクタ番号
EAFD                ;out
EAFD                ;	DE : 次のセクタ番号
EAFD                ;note
EAFD                ;
EAFD                ;------------------------
EAFD                NEXTX:
EAFD 3E 00          	LD	A,0	;自己書き換え
EAFF 00 00 EA FE    _SECPS	EQU	$-1
EAFF 3C             	INC	A
EB00 E6 00          	AND	0	;自己書き換え　1クラスタの論理セクタ数-1
EB02 00 00 EB 01    _NCPAT	EQU	$-1
EB02 32 FE EA       	LD	(_SECPS),A
EB05 C9             	RET
EB06                
EB06                GNCLX:
EB06 CD FD EA       	CALL	NEXTX
EB09 C0             	RET	NZ	;1クラスタのセクタ未満の場合は戻る
EB0A C3 F7 F0       	JP	_GNCL	;次のクラスタを探す
EB0D                
EB0D                RDFAT:
EB0D 3E 80          	LD	A,080H
EB0F 32 70 F0       	LD	(CHECK),A
EB12                RDFAT1:
EB12 3A 88 F0       	LD	A,(_DRV)
EB15 CD CD ED       	CALL	CHGDRVR
EB18 D8             	RET	C
EB19 DD 7E 12       	LD	A,(IX+DPB_DEVICE)
EB1C CB 6F          	BIT	5,A
EB1E 28 68          	JR	Z,RDFAT0X
EB20 21 70 F0       	LD	HL,CHECK
EB23 A6             	AND	(HL)
EB24 77             	LD	(HL),A
EB25 11 00 00       	LD	DE,0		;BPB
EB28 2A 7C F1       	LD	HL,(_FATBF)
EB2B CD 84 EC       	CALL	DRD16
EB2E 30 24          	JR	NC,GETBPB
EB30 21 70 F0       	LD	HL,CHECK
EB33 CB 06          	RLC	(HL)
EB35 3F             	CCF
EB36 D8             	RET	C
EB37 DD CB 0A 1E    	RR	(IX+DPB_FDMODE)
EB3B 3F             	CCF			;フロッピーディスクのFDモードを切り替える
EB3C DD CB 0A 16    	RL	(IX+DPB_FDMODE)
EB40 3E FF          	LD	A,0FFH
EB42 32 89 F0       	LD	(_DSK),A
EB45 3A 84 F0       	LD	A,(_DRIVE)
EB48 E6 03          	AND	3
EB4A F6 80          	OR	080H
EB4C 6F             	LD	L,A
EB4D 26 F0          	LD	H,_CYL0/256
EB4F 3E FF          	LD	A,0FFH
EB51 77             	LD	(HL),A
EB52 18 BE          	JR	RDFAT1
EB54                GETBPB:
EB54 FD E5          	PUSH	IY
EB56 FD 2A 7C F1    	LD	IY,(_FATBF)	;BPB
EB5A CD F1 F0       	CALL	_BPB2DPB
EB5D FD E1          	POP	IY
EB5F DD 7E 12       	LD	A,(IX+DPB_DEVICE)
EB62 30 21          	JR	NC,GETBPBOK
EB64 E6 0F          	AND	00FH
EB66 FE 07          	CP	7
EB68 37             	SCF
EB69 C0             	RET	NZ
EB6A DD CB 0A 46    	BIT	0,(IX+DPB_FDMODE)
EB6E 21 C0 F1       	LD	HL,M2D
EB71 20 02          	JR	NZ,SETFDMODE
EB73 2E D2          	LD	L,M2HD-STABLE
EB75                SETFDMODE:
EB75 DD E5          	PUSH	IX
EB77 D1             	POP	DE
EB78 ED A0          	LDI
EB7A ED A0          	LDI
EB7C 13             	INC	DE
EB7D 13             	INC	DE
EB7E 13             	INC	DE
EB7F 13             	INC	DE
EB80 01 0C 00       	LD	BC,12
EB83 ED B0          	LDIR
EB85                GETBPBOK:
EB85 CD 2C ED       	CALL	CHGDRV2
EB88                RDFAT0X:
EB88 CD 78 EC       	CALL	RDFATS
EB8B D8             	RET	C
EB8C DD AE 06       	XOR	(IX+DPB_FATID)
EB8F C8             	RET	Z
EB90 DD CB 12 6E    	BIT	5,(IX+DPB_DEVICE)
EB94 C0             	RET	NZ		;BPBを取得している場合はFATIDをチェックしない
EB95 37             	SCF
EB96 C9             	RET
EB97                
EB97                POP_HL_SCF_RET:
EB97 E1             	POP	HL
EB98 37             	SCF
EB99 C9             	RET
EB9A                
EB9A                BPB2DPB:
EB9A FD 7E 0B       	LD	A,(IY+11)	;BPB_BytsPerSec
EB9D B7             	OR	A
EB9E 37             	SCF
EB9F C0             	RET	NZ
EBA0                BPBOK:
EBA0 FD 7E 0D       	LD	A,(IY+13)	;BPB_SecPerClus
EBA3 DD 77 07       	LD	(IX+DPB_SECPCL),A
EBA6                
EBA6 FD 7E 16       	LD	A,(IY+22)	;BPB_FATSz16
EBA9 DD 77 00       	LD	(IX+DPB_FATLN),A
EBAC FD 7E 17       	LD	A,(IY+23)	;BPB_FATSz16
EBAF DD 77 01       	LD	(IX+DPB_FATLN+1),A
EBB2                
EBB2 FD 6E 0E       	LD	L,(IY+14)	;BPB_RsvdSecCnt
EBB5 FD 66 0F       	LD	H,(IY+15)
EBB8 DD 75 0E       	LD	(IX+DPB_FATPS),L
EBBB FD 5E 16       	LD	E,(IY+22)	;BPB_FATSz16
EBBE FD 56 17       	LD	D,(IY+23)
EBC1 FD 46 10       	LD	B,(IY+16)	;BPB_NumFATs
EBC4                BPBDP1:				;BPB_FATSz16 * BPB_NumFATs
EBC4 19             	ADD	HL,DE
EBC5 10 FD          	DJNZ	BPBDP1
EBC7                BPBDP2:
EBC7 DD 75 10       	LD	(IX+DPB_DIRPS),L
EBCA DD 74 11       	LD	(IX+DPB_DIRPS+1),H
EBCD E5             	PUSH	HL
EBCE                
EBCE FD 6E 11       	LD	L,(IY+17)	;BPB_RootEntCnt
EBD1 FD 66 12       	LD	H,(IY+18)
EBD4 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EBD7 B7             	OR	A
EBD8 28 BD          	JR	Z,POP_HL_SCF_RET
EBDA 06 06          	LD	B,6
EBDC                BPBBPS1:
EBDC 05             	DEC	B
EBDD 0F             	RRCA
EBDE 30 FC          	JR	NC,BPBBPS1
EBE0                BPBDE1:
EBE0 29             	ADD	HL,HL
EBE1 10 FD          	DJNZ	BPBDE1
EBE3                
EBE3 7C             	LD	A,H
EBE4 DD 77 0B       	LD	(IX+DPB_DIRSCNT),A	;
EBE7                
EBE7 D1             	POP	DE		;DPB_DIRPS
EBE8 6C             	LD	L,H
EBE9 26 00          	LD	H,0
EBEB 19             	ADD	HL,DE		;MAXDIR
EBEC E5             	PUSH	HL
EBED FD 4E 0D       	LD	C,(IY+13)	;BPB_SecPerClus
EBF0 CB 21          	SLA	C		;*2
EBF2 AF             	XOR	A
EBF3 47             	LD	B,A
EBF4 ED 42          	SBC	HL,BC
EBF6 DD 75 14       	LD	(IX+DPB_ADDCL),L
EBF9 DD 74 15       	LD	(IX+DPB_ADDCL+1),H
EBFC                
EBFC D1             	POP	DE		;DE=DPB_MAXDIR
EBFD FD 6E 13       	LD	L,(IY+19)	;BPB_TotSec16
EC00 FD 66 14       	LD	H,(IY+20)
EC03                
EC03 DD 7E 12       	LD	A,(IX+DPB_DEVICE)
EC06 E6 0F          	AND	00FH
EC08 FE 07          	CP	7		;フロッピー
EC0A 20 19          	JR	NZ,NOT_FD
EC0C E5             	PUSH	HL
EC0D FD 4E 18       	LD	C,(IY+24)	;BPB_SecPerTr
EC10 DD 71 0D       	LD	(IX+DPB_MAXSEC),C
EC13 AF             	XOR	A
EC14 CB 21          	SLA	C		;両面なのでセクタ数を２倍
EC16 06 10          	LD	B,16
EC18                DIVSEC:				;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
EC18 29             	ADD	HL,HL
EC19 17             	RLA
EC1A B9             	CP	C
EC1B 38 02             	JR	C,DIVSEC1
EC1D 91                	SUB	C
EC1E 2C             	INC	L
EC1F                DIVSEC1:
EC1F 10 F7           	DJNZ	DIVSEC
EC21 DD 75 0C       	LD	(IX+DPB_MAXCYL),L
EC24 E1             	POP	HL	;ここまでフロッピー専用
EC25                NOT_FD:
EC25 7C             	LD	A,H
EC26 B5             	OR	L
EC27 3E 00          	LD	A,0		;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
EC29 20 10          	JR	NZ,BPB16BIT	;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
EC2B FD 7E 23       	LD	A,(IY+35)	;念のために総セクタ数が24ビットを超える場合はエラーを返す
EC2E B7             	OR	A
EC2F 37             	SCF
EC30 C0             	RET	NZ
EC31 FD 6E 20       	LD	L,(IY+32)	;BPB_TotSec32 は AHL の24ビットで扱う
EC34 FD 66 21       	LD	H,(IY+33)	;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので
EC37 FD 7E 22       	LD	A,(IY+34)	;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
EC3A A7             	AND	A		;CF=0
EC3B                BPB16BIT:
EC3B ED 52          	SBC	HL,DE
EC3D DE 00          	SBC	A,0
EC3F FD 46 0D       	LD	B,(IY+13)	;BPB_SecPerClus
EC42                BPBTC1:				;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
EC42 CB 18          	RR	B		;->CY
EC44 38 08          	JR	C,BPBTC2
EC46 CB 3F          	SRL	A
EC48 CB 1C          	RR	H		;AHL=AHL/2
EC4A CB 1D          	RR	L
EC4C 18 F4          	JR	BPBTC1
EC4E                BPBTC2:
EC4E B7             	OR	A
EC4F 37             	SCF
EC50 C0             	RET	NZ		;念のため(クラスタ数が16ビットを超える場合)
EC51 23             	INC	HL
EC52 23             	INC	HL
EC53 DD 75 08       	LD	(IX+DPB_MAXCL),L
EC56 DD 74 09       	LD	(IX+DPB_MAXCL+1),H
EC59                
EC59 FD 7E 15       	LD	A,(IY+21)	;BPB_Media
EC5C DD 77 06       	LD	(IX+DPB_FATID),A
EC5F                
EC5F FD 7E 10       	LD	A,(IY+16)	;BPB_NumFATs
EC62 C6 FE          	ADD	A,0-2		;>2:CF=1
EC64 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EC67 6F             	LD	L,A
EC68 30 02          	JR	NC,BPBFAT1
EC6A F6 80          	OR	080H
EC6C                BPBFAT1:			;ここではCF=0
EC6C DD 77 0F       	LD	(IX+DPB_BPS),A
EC6F 2D             	DEC	L		;以下のセクタサイズに合致しない場合はCF=1でエラーにする
EC70 C8             	RET	Z		;1セクタ256バイト
EC71 2D             	DEC	L
EC72 C8             	RET	Z		;1セクタ512バイト
EC73 2D             	DEC	L
EC74 2D             	DEC	L
EC75 C8             	RET	Z		;1セクタ1024バイト
EC76 37             	SCF
EC77 C9             	RET
EC78                
EC78                RDFATS:
EC78 CD BE EC       	CALL	FATSETUP
EC7B D8             	RET	C
EC7C CD 88 EC       	CALL	DRD24B
EC7F 2A 7C F1       	LD	HL,(_FATBF)
EC82 7E             	LD	A,(HL)
EC83 C9             	RET
EC84                
EC84                DRD16:
EC84 0E 00          	LD	C,0
EC86                DRD24:
EC86 06 01          	LD	B,1
EC88                DRD24B:
EC88 DD E5          	PUSH	IX
EC8A DD 2A A8 F0    	LD	IX,(_DPB)
EC8E CD E8 EE       	CALL	FDRD		;自己書き換え（ディスク読み込み）
EC91 00 00 EC 8F    DRDPAT	EQU	$-2
EC91                POP_IX_RET:
EC91 DD E1          	POP	IX
EC93 C9             	RET
EC94                
EC94                DWT16:
EC94 0E 00          	LD	C,0
EC96                DWT24:
EC96 06 01          	LD	B,1
EC98                DWT24B:
EC98 DD E5          	PUSH	IX
EC9A DD 2A A8 F0    	LD	IX,(_DPB)
EC9E CD DA EE       	CALL	FDWT		;自己書き換え（ディスク書き込み）
ECA1 00 00 EC 9F    DWTPAT	EQU	$-2
ECA1 18 EE          	JR	POP_IX_RET
ECA3                
ECA3                WTFAT:
ECA3 CD BE EC       	CALL	FATSETUP
ECA6 D4 98 EC       	CALL	NC,DWT24B
ECA9 D8             	RET	C
ECAA DD CB 0F 7E    	BIT	7,(IX+DPB_BPS)
ECAE C8             	RET	Z		;予備FATが無い
ECAF CD C5 EC       	CALL	FATS2
ECB2 E5             	PUSH	HL		;予備FAT
ECB3 DD 6E 00       	LD	L,(IX+DPB_FATLN)
ECB6 DD 66 01       	LD	H,(IX+DPB_FATLN+1)
ECB9 19             	ADD	HL,DE
ECBA EB             	EX	DE,HL
ECBB E1             	POP	HL
ECBC 18 DA          	JR	DWT24B
ECBE                ;------------------------
ECBE                ;FATのセットアップ
ECBE                ;out
ECBE                ;	B  : FATセクタ数
ECBE                ;	DE : FAT先頭セクタ番号
ECBE                ;	HL : FATバッファポインタ
ECBE                ;	CF : 1=ドライブ切り替えエラー
ECBE                ;note
ECBE                ;	FATサイズがFATバッファを超える場合は
ECBE                ;	対象クラスタ領域==(_FATIX)によって
ECBE                ;	FAT12:対象クラスタ1024毎に1.5KBを切り替える
ECBE                ;	FAT16:対象クラスタ1024毎に2KBを切り替える
ECBE                ;------------------------
ECBE                FATSETUP:
ECBE 3A AA F0       	LD	A,(_FATDRV)
ECC1 CD CD ED       	CALL	CHGDRVR		;ドライブ切り替え
ECC4 D8             	RET	C
ECC5                FATS2:
ECC5 DD 7E 0F       	LD	A,(IX+DPB_BPS)	;512=2 1024=4
ECC8 0F             	RRCA
ECC9 CD F2 EC       	CALL	FATSETUP12	;自己書き換え
ECCC 00 00 EC CA    FATSX	EQU	$-2
ECCC 21 00 00       	LD	HL,0
ECCF 4A             	LD	C,D
ECD0 54             	LD	D,H
ECD1 3A AB F0       	LD	A,(_FATIX)	;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
ECD4 47             	LD	B,A
ECD5 04             	INC	B
ECD6 DD 7E 00       	LD	A,(IX+DPB_FATLN)
ECD9                FAT_SKP:
ECD9 05             	DEC	B
ECDA 28 05          	JR	Z,FAT1
ECDC 19             	ADD	HL,DE
ECDD 93             	SUB	E
ECDE 30 F9          	JR	NC,FAT_SKP
ECE0 C9             	RET
ECE1                FAT1:
ECE1 EB             	EX	DE,HL
ECE2 B9             	CP	C		;C=FATバッファに読み込めるセクタ数
ECE3 38 01          	JR	C,FAT2
ECE5 79             	LD	A,C
ECE6                FAT2:
ECE6 47             	LD	B,A
ECE7                
ECE7 2A FA F1       	LD	HL,(_FATPS)	;fat sector pos
ECEA 19             	ADD	HL,DE
ECEB EB             	EX	DE,HL
ECEC 2A 7C F1       	LD	HL,(_FATBF)
ECEF AF             	XOR	A		;CF=0
ECF0 4F             	LD	C,A
ECF1 C9             	RET
ECF2                ;
ECF2                ;	FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
ECF2                ;	FATSETUP* (FAT12/FAT16)
ECF2                ;out
ECF2                ;	D : FATバッファに読み込める最大のセクタ数
ECF2                ;	E : _FATIXで進めるセクタ数
ECF2                FATSETUP12:
ECF2 11 06 06       	LD	DE,0606H	;256
ECF5 D8             	RET	C
ECF6 11 03 03       	LD	DE,0303H	;512
ECF9 0F             	RRCA
ECFA D8             	RET	C
ECFB 11 01 02       	LD	DE,0201H	;1024
ECFE C9             	RET
ECFF                
ECFF                FATSETUP16:
ECFF 11 08 08       	LD	DE,0808H	;256
ED02 D8             	RET	C
ED03 11 04 04       	LD	DE,0404H
ED06 0F             	RRCA			;512
ED07 D8             	RET	C
ED08 11 02 02       	LD	DE,0202H	;1024
ED0B C9             	RET
ED0C                
ED0C                CHGDRV:
ED0C E5             	PUSH	HL
ED0D 21 89 F0       	LD	HL,_DSK
ED10 BE             	CP	(HL)
ED11 28 0A          	JR	Z,CHGDRVE
ED13                CHGDRV1:
ED13 DD E5          	PUSH	IX
ED15 CD 1F ED       	CALL	CHGDRV0
ED18 3A 89 F0       	LD	A,(_DSK)
ED1B DD E1          	POP	IX
ED1D                CHGDRVE:
ED1D E1             	POP	HL
ED1E C9             	RET
ED1F                
ED1F                CHGDRV0:
ED1F 6F             	LD	L,A
ED20 CD DC F0       	CALL	_GETDPB
ED23 D8             	RET	C
ED24 DD 22 A8 F0    	LD	(_DPB),IX
ED28 7D             	LD	A,L
ED29 32 89 F0       	LD	(_DSK),A
ED2C                CHGDRV2:
ED2C C5             	PUSH	BC
ED2D D5             	PUSH	DE
ED2E ED 73 83 ED    	LD	(SPPAT2),SP
ED32 F3             	DI
ED33 DD F9          	LD	SP,IX
ED35                
ED35 E1             	POP	HL		;00:DPB_FATLN
ED36 E1             	POP	HL		;02:DPB_DRD
ED37 22 8F EC       	LD	(DRDPAT),HL
ED3A                
ED3A E1             	POP	HL
ED3B 22 9F EC       	LD	(DWTPAT),HL	;04:DPB_DWT
ED3E                
ED3E E1             	POP	HL		;L=06:DPB_FATID H=07:DPB_SECPCL
ED3F 7C             	LD	A,H
ED40 32 90 E3       	LD	(SPCPAT),A	;1クラスタの論理セクタ数
ED43 3D             	DEC	A
ED44 32 01 EB       	LD	(_NCPAT),A
ED47                
ED47 E1             	POP	HL		;08:DPB_MAXCL
ED48 7D             	LD	A,L
ED49 32 AF E3       	LD	(CLPAT2),A
ED4C 7C             	LD	A,H
ED4D 32 AB E3       	LD	(CLPAT1),A
ED50 2B             	DEC	HL
ED51 22 B2 E5       	LD	(MAXCLP),HL
ED54                
ED54 E1             	POP	HL		;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
ED55 7D             	LD	A,L
ED56 F6 FE          	OR	0FEH
ED58 32 83 EE       	LD	(FDMODE+1),A
ED5B 07             	RLCA
ED5C E6 03          	AND	3
ED5E 32 6B EE       	LD	(FSPAT+1),A
ED61 4C             	LD	C,H
ED62                
ED62 E1             	POP	HL		;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
ED63                
ED63 E1             	POP	HL		;L=0E:DPB_FATPS H=0F:DPB_BPS
ED64 7C             	LD	A,H		;DPB_BPS
ED65 E6 07          	AND	7
ED67 32 9B E8       	LD	(SECSZ+2),A	;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
ED6A                				;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
ED6A                				;1セクタ1024 2HD/2HDE98
ED6A                				;1セクタ256 GRAM/RAMF/CMOS/等
ED6A                				;1024	512	256
ED6A                				;4	2	1
ED6A 87             	ADD	A,A		;8	4	2
ED6B 87             	ADD	A,A		;010H	8	4
ED6C 87             	ADD	A,A		;020H	010H	8
ED6D 32 0C E2       	LD	(SDECPAT),A	;1セクタ辺りのディレクトリエントリ数
ED70                
ED70 26 00          	LD	H,0
ED72 22 FA F1       	LD	(_FATPS),HL
ED75                
ED75 E1             	POP	HL		;10:DPB_DIRPS
ED76 22 FC F1       	LD	(_DIRPS),HL
ED79                
ED79 E1             	POP	HL		;L=12:DPB_DEVICE H=13:DPB_UNITNO
ED7A 7C             	LD	A,H
ED7B 32 84 F0       	LD	(_DRIVE),A
ED7E                
ED7E E1             	POP	HL		;14:DPB_ADDCL
ED7F 22 A0 E3       	LD	(CLSPAT),HL
ED82                
ED82 31 00 00       	LD	SP,0		;元のSPを復元
ED85 00 00 ED 83    SPPAT2	EQU	$-2
ED85 FB             	EI
ED86 2A FC F1       	LD	HL,(_DIRPS)
ED89 06 00          	LD	B,0
ED8B 09             	ADD	HL,BC		;C=DPB_DIRSCNT
ED8C 22 27 E2       	LD	(MD_PAT),HL
ED8F                
ED8F 2A B2 E5       	LD	HL,(MAXCLP);
ED92 11 F6 0F       	LD	DE,4086		;クラスタ数が4086未満:FAT12 4086以上:FAT16
ED95 ED 52          	SBC	HL,DE		;CF=0のはず
ED97 30 0F          	JR	NC,SETFAT16
ED99 21 87 EA       	LD	HL,GNCL		;FAT12
ED9C 11 AA EA       	LD	DE,SNCL
ED9F 01 F2 EC       	LD	BC,FATSETUP12
EDA2 DD CB 0F AE    	RES	5,(IX+DPB_BPS)	;DPB_BPS(FAT12)
EDA6 18 0D          	JR	EXTRA1
EDA8                SETFAT16:
EDA8 21 DE EA       	LD	HL,GNCL16	;FAT16
EDAB 11 EB EA       	LD	DE,SNCL16
EDAE 01 FF EC       	LD	BC,FATSETUP16
EDB1 DD CB 0F EE    	SET	5,(IX+DPB_BPS)	;DPB_BPS(FAT16)
EDB5                EXTRA1:
EDB5 22 F8 F0       	LD	(GNCPAT),HL
EDB8 ED 53 FB F0    	LD	(SNCPAT),DE
EDBC ED 43 CA EC    	LD	(FATSX),BC
EDC0 D1             	POP	DE
EDC1 C1             	POP	BC
EDC2 AF             	XOR	A
EDC3 C9             	RET
EDC4                
EDC4                GETDPBD:
EDC4 DD E3          	EX	(SP),IX
EDC6 DD E5          	PUSH	IX
EDC8 3A 88 F0       	LD	A,(_DRV)
EDCB 18 07          	JR	GETDPB1
EDCD                
EDCD                CHGDRVR:
EDCD CD D9 F0       	CALL	_CHGDRV
EDD0 D8             	RET	C
EDD1 3A 89 F0       	LD	A,(_DSK)
EDD4                GETDPB1:
EDD4 C3 DC F0       	JP	_GETDPB
EDD7                
EDD7                GETDPB:
EDD7 FE 08          	CP	8
EDD9 3F             	CCF
EDDA D8             	RET	C
EDDB 0F             	RRCA
EDDC 0F             	RRCA
EDDD 0F             	RRCA
EDDE DD             	DB	0DDH		;Z80未定義命令
EDDF 6F             	LD	L,A		;LD	IXL,A
EDE0 DD             	DB	0DDH		;Z80未定義命令
EDE1 26 F2          	LD	H,_DEVICE/256	;LD	IXH,_DEVICE/256
EDE3 DD 7E 00       	LD	A,(IX+DPB_FATLN)
EDE6 A7             	AND	A		;CF=0の為
EDE7 DD CB 0F 6E    	BIT	5,(IX+DPB_BPS)
EDEB C0             	RET	NZ		;FAT16
EDEC DD CB 12 6E    	BIT	5,(IX+DPB_DEVICE)
EDF0 C0             	RET	NZ		;BPB
EDF1 FE 01          	CP	001H		;A=0 THEN CF=1
EDF3 C9             	RET
EDF4                
EDF4                _SYS5F:
EDF4 AF             	XOR	A
EDF5                FFLUSH:
EDF5 F5             	PUSH	AF
EDF6 CD 0F EA       	CALL	WTFATX
EDF9 AF             	XOR	A
EDFA 32 AB F0       	LD	(_FATIX),A
EDFD 2F             	CPL			;0FFH
EDFE 32 AA F0       	LD	(_FATDRV),A
EE01 3E             	DB	03EH		;次のPUSH AFをスキップ
EE02                FFLUSHBUF:
EE02 F5             	PUSH	AF
EE03 CD C5 E9       	CALL	DWTX
EE06 3E FF          	LD	A,0FFH
EE08 32 39 F0       	LD	(SFILE),A
EE0B 32 A5 F0       	LD	(_DBDRV),A
EE0E F1             	POP	AF
EE0F C9             	RET
EE10                
EE10                	INCLUDE	"X1DISK.ASM"
EE10                
EE10                ;	LSX-Dodgers DISK
EE10                ;	X1/turbo/Z
EE10                
EE10                SEEK:
EE10 06 10          	LD	B,16
EE12 DD 4E 0D       	LD	C,(IX+DPB_MAXSEC)
EE15 AF             	XOR	A
EE16 EB             	EX	DE,HL
EE17                DIV1:
EE17 29             	ADD	HL,HL
EE18 8F             	ADC	A,A
EE19 B9             	CP	C
EE1A 38 02          	JR	C,DIV2
EE1C 91             	SUB	C
EE1D 2C             	INC	L
EE1E                DIV2:
EE1E 10 F7          	DJNZ	DIV1
EE20                
EE20 3C             	INC	A	;最小のセクタは１固定
EE21 55             	LD	D,L	;TRACK
EE22 5F             	LD	E,A	;SECTOR
EE23 CB 3A          	SRL	D	;CYLINDER
EE25 9F             	SBC	A,A
EE26 E6 10          	AND	010H	;SIDE
EE28 4F             	LD	C,A
EE29                
EE29 3A 84 F0       	LD	A,(_DRIVE)
EE2C FE 04          	CP	4
EE2E 3F             	CCF
EE2F D8             	RET	C
EE30 B1             	OR	C
EE31 32 AF EE       	LD	(MOPAT+1),A	;Motor off data
EE34 01 FC 0F       	LD	BC,00FFCH
EE37 F6 80          	OR	080H		;Motor on
EE39 ED 79          	OUT	(C),A
EE3B                
EE3B CD 81 EE       	CALL	SETMODE
EE3E D8             	RET	C
EE3F                
EE3F CD C4 EE       	CALL	DRIVE
EE42 FE FF          	CP	0FFH		;A=0FFH Unknown CYLINDER
EE44 CC A3 EE       	CALL	Z,FDCRES	;Restore
EE47 0E F9          	LD	C,0F9H
EE49 ED 79          	OUT	(C),A		;Currrent CYLINDER
EE4B 92             	SUB	D
EE4C C8             	RET	Z		;No seek
EE4D                
EE4D 3A 86 F0       	LD	A,(_ISEEK)
EE50 4F             	LD	C,A
EE51                
EE51 DD 7E 0C       	LD	A,(IX+DPB_MAXCYL)
EE54 3D             	DEC	A
EE55 BA             	CP	D		;Over CYLINDER
EE56 D8             	RET	C
EE57                
EE57 B9             	CP	C		;for Built-in 2DD
EE58 38 03          	JR	C,SETM2
EE5A 78             	LD	A,B		;B=00FH
EE5B DB FE          	IN	A,(0FEH)		;2HD mode for 2DD seek
EE5D                SETM2:
EE5D 78             	LD	A,B
EE5E DB FD          	IN	A,(0FDH)		;MFM mode
EE60                
EE60 0E FB          	LD	C,0FBH
EE62 ED 51          	OUT	(C),D
EE64 72             	LD	(HL),D
EE65 0E 18          	LD	C,018H		;Seek
EE67                FDCCMD2:
EE67 3A 85 F0       	LD	A,(_SEEKSP)
EE6A E6 FF          FSPAT:	AND	0FFH
EE6C B1             	OR	C
EE6D                
EE6D                FDCCMD:
EE6D CD BA EE       	CALL	COMSET
EE70                
EE70 3E 80          FDCPAT:	LD	A,080H		;FDC COMMAND(Self-modifying code)
EE72 E6 20          	AND	020H		;Write data Write track
EE74 3C             	INC	A
EE75                
EE75                SST:
EE75 0E 00          	LD	C,0
EE77                SST1:
EE77 0D             	DEC	C		; 4
EE78 20 FD          	JR	NZ,SST1		;12 * 256 / 4 = About 1ms
EE7A 3D             	DEC	A
EE7B 20 FA          	JR	NZ,SST1
EE7D                
EE7D 3C             	INC	A		;A=1
EE7E CD 8C EE       	CALL	READY
EE81                SETMODE:
EE81 78             	LD	A,B		;B=00FH
EE82 DB FF          FDMODE:	IN	A,(0FFH)	;Floppy mode(2D/2HD) (Self-modifying code)
EE84                
EE84 78             	LD	A,B
EE85 DB FD          	IN	A,(0FDH)	;MFM mode
EE87                
EE87 CD BE EE       	CALL	DELAY0		;Head select time
EE8A 3E 81          	LD	A,081H
EE8C                READY:
EE8C 32 96 EE       	LD	(WAITA+1),A
EE8F E5             	PUSH	HL
EE90 0E F8          	LD	C,0F8H
EE92 61             	LD	H,C
EE93                READY2:
EE93 ED 78          	IN	A,(C)
EE95 E6 81          WAITA:	AND	081H		;NOT READY,BUSY
EE97 28 08          	JR	Z,READYE
EE99 E3             	EX	(SP),HL		;wait 19clock
EE9A E3             	EX	(SP),HL		; //
EE9B 2B             	DEC	HL
EE9C 7C             	LD	A,H
EE9D B5             	OR	L
EE9E 20 F3          	JR	NZ,READY2
EEA0 37             	SCF
EEA1                READYE:
EEA1 E1             	POP	HL
EEA2 C9             	RET
EEA3                
EEA3                FDCRES:
EEA3 36 00          	LD	(HL),0
EEA5 0E 08          	LD	C,8
EEA7 18 BE          	JR	FDCCMD2
EEA9                
EEA9                FDMOFF:
EEA9 F5             	PUSH	AF
EEAA C5             	PUSH	BC
EEAB 01 FC 0F       	LD	BC,00FFCH	;Motor off
EEAE 3E 00          MOPAT:	LD	A,000H		;(Self-rewriting)
EEB0 ED 79          	OUT	(C),A
EEB2 C1             	POP	BC
EEB3 F1             	POP	AF
EEB4 C9             	RET
EEB5                
EEB5                SECSET:
EEB5 01 FA 0F       	LD	BC,00FFAH
EEB8 ED 59          	OUT	(C),E
EEBA                COMSET:
EEBA 0E F8          	LD	C,0F8H
EEBC ED 79          	OUT	(C),A
EEBE                DELAY0:
EEBE 3E 1A          	LD	A,26
EEC0                DELAY:
EEC0 3D             	DEC	A
EEC1 20 FD          	JR	NZ,DELAY
EEC3 C9             	RET
EEC4                
EEC4                DRIVE:
EEC4 2A 84 F0       	LD	HL,(_DRIVE)
EEC7 26 F0          	LD	H,_CYL0/256
EEC9 CB FD          	SET	7,L
EECB 7E             	LD	A,(HL)
EECC C9             	RET
EECD                
EECD                RNF:
EECD CD C4 EE       	CALL	DRIVE
EED0 36 FF          	LD	(HL),0FFH
EED2 C9             	RET
EED3                
EED3 02             RETRY:	DB	2
EED4                
EED4                
EED4                ;	FLOPPY DISK DRIVER(DMA)
EED4                
EED4                
EED4                WTTRK:
EED4 06 01          	LD	B,1
EED6 3E F4          	LD	A,0F4H
EED8 18 02          	JR	WTTRK1
EEDA                FDWT:
EEDA 3E A0          	LD	A,0A0H
EEDC                WTTRK1:
EEDC 32 71 EE       	LD	(FDCPAT+1),A
EEDF 3E 10          	LD	A,16
EEE1 18 0C          	JR	DISK
EEE3                
EEE3                DISKOK:
EEE3 06 01          FDCNT:	LD	B,1
EEE5 10 0B          	DJNZ	DISK1
EEE7 C9             	RET
EEE8                
EEE8                FDRD:
EEE8 3E 80          	LD	A,080H
EEEA 32 71 EE       	LD	(FDCPAT+1),A
EEED 3E 0E          	LD	A,14
EEEF                
EEEF                DISK:
EEEF 32 06 EF       	LD	(DMAPAT+1),A
EEF2                DISK1:
EEF2 78             	LD	A,B
EEF3 32 E4 EE       	LD	(FDCNT+1),A
EEF6 22 5E EF       	LD	(DMAD+11),HL
EEF9                DISKR:
EEF9 3E 02          	LD	A,2		;Retry count
EEFB 32 D3 EE       	LD	(RETRY),A
EEFE                DISK2:
EEFE D5             	PUSH	DE
EEFF CD 10 EE       	CALL	SEEK
EF02 38 43          	JR	C,ERRF
EF04 F3             	DI
EF05                
EF05 3E 0E          DMAPAT:	LD	A,14		;自己書き換え
EF07 21 53 EF       	LD	HL,DMAD
EF0A CD AD DF       	CALL	SETDMA
EF0D ED 49          	OUT	(C),C		;OUT 01F87H,087H WR6 イネーブル
EF0F 3A 71 EE       	LD	A,(FDCPAT+1)
EF12 C5             	PUSH	BC
EF13 CD B5 EE       	CALL	SECSET
EF16 2A 5E EF       	LD	HL,(DMAHL)
EF19 23             	INC	HL
EF1A 11 06 BB       	LD	DE,0BB06H	;READ DMA
EF1D                
EF1D 3E 03          	LD	A,3
EF1F CD 8C EE       	CALL	READY
EF22 ED 78          	IN	A,(C)
EF24                
EF24 C1             	POP	BC
EF25 ED 51          	OUT	(C),D		;読み出しマスク設定
EF27 ED 59          	OUT	(C),E		;バイトカウンタ(LH)
EF29 ED 58          	IN	E,(C)
EF2B ED 50          	IN	D,(C)
EF2D 19             	ADD	HL,DE
EF2E D1             	POP	DE
EF2F 13             	INC	DE
EF30 FB             	EI
EF31 CD A9 EE       	CALL	FDMOFF
EF34 B7             	OR	A
EF35 28 AC          	JR	Z,DISKOK
EF37 1B             	DEC	DE
EF38 CB 67          	BIT	4,A
EF3A C4 CD EE       	CALL	NZ,RNF
EF3D                DISKE2:
EF3D 21 D3 EE       	LD	HL,RETRY
EF40 35             	DEC	(HL)
EF41 20 BB          	JR	NZ,DISK2
EF43 B7             	OR	A
EF44 28 0A          	JR	Z,ERR
EF46 D5             	PUSH	DE
EF47                ERRF:
EF47 D1             	POP	DE
EF48                DELP:
EF48 CD CD EE       	CALL	RNF
EF4B CD A9 EE       	CALL	FDMOFF
EF4E 3E FF          	LD	A,0FFH
EF50                ERR:
EF50 BF             	CP	A
EF51 37             	SCF
EF52 C9             	RET
EF53                
EF53                			;X1turbo DISK DMA
EF53 C3             DMAD:	DB	0C3H	;WR6 リセット
EF54 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
EF55 FB 0F          	DW	00FFBH	;ポートA開始アドレス FDC データレジスタ
EF57 FF FF          	DW	0FFFFH	;ブロック長(転送サイズ-1)
EF59 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
EF5A 10             	DB	010H	;WR2 ポートBインクリメント
EF5B 80             	DB	080H	;WR3
EF5C 92             	DB	092H	;WR5 WAIT RDY:LOW
EF5D 8D             	DB	08DH	;WR4 バイト ポートB開始アドレス(LH)
EF5E 00 00          DMAHL:	DW	0	;ポートB開始アドレス
EF60 CF             	DB	0CFH	;WR6 ロード
EF61 01             	DB	001H	;WR0 ポートB←ポートB 転送
EF62 CF             	DB	0CFH	;WR6 ロード
EF63                
EF63                DMAE:
EF63                
EF63 00 00 1D 49    AT_R	EQU	WTTRK-AT_DWT
EF63                AT_TABLE:
EF63                	INCLUDE	"LDCCPWK.ASM"
EF63                
EF63                ;	LSX-Dodgers CCP WORK
EF63                
EF63 00 00 00 3B    PATHX	EQU	59
EF63                PATHD:	DS	PATHX
EF9E 00             PATHE:	DB	0
EF9F                
EF9F                DTA_CCP:
EF9F                	DS	37
EFC4                
EFC4                FCB_BAT:
EFC4                	DS	37
EFE9                
EFE9 20 20 20 3C    DIRMES:	DB	"   <DIR>  $"
EFED 44 49 52 3E
EFF1 20 20 24
EFF4 20 66 72 65    FREE:	DB	" free $"
EFF8 65 20 24
EFFB                	INCLUDE	"LDWORK.ASM"
EFFB                
EFFB                ;	LSX-Dodgers WORK0
EFFB                ;
EFFB                ;	CP/M互換BIOS
EFFB                ;	BOOT:アドレス下位1バイトが0になるように
EFFB                AT_WORK:
EFFB                	DS	WORKAD-AT_WORK
F000                
F000                CPM_BOOT:
F000 C3 00 00       	JP	0
F003                _SYS00:		;(BDOS)プログラム終了
F003                CPM_WBOOT:
F003 C3 09 D3       	JP	WBOOT1
F006                CPM_CONST:
F006 C3 5B DC       	JP	CONSTX
F009                _SYS07:		;(BDOS)コンソール直接入力
F009                CPM_CONIN:
F009 C3 D0 DB       	JP	FLGET
F00C                CPM_CONOUT:
F00C C3 A0 DE       	JP	CONOUT1
F00F                
F00F                DECBF:				;10進数表示時のバッファ(5バイト)
F00F                	DS	5
F014 00 00 F0 0F    RR_BUF_HL	EQU	DECBF	;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
F014 00 00 F0 11    RR_BUF_A	EQU	DECBF+2	;計3バイト
F014                
F014 00             FDRV:	DB	0
F015                FNAME:	DS	36
F039                SFILE:	DS	33		;DRV FILENAME
F05A                
F05A                	DS	3
F05D                
F05D 00 00          LEFTX:	DW	0
F05F 00 00          DTAX:	DW	0
F061                
F061                ZERO:
F061                BEEPD:
F061 00 8E 01 00    	DB	0,08EH,1,0,00BH,0,00CH,010H
F065 0B 00 0C 10
F069 07 3E 08 10    	DB	007H,03EH,008H,010H,00DH,0,0FFH
F06D 0D 00 FF
F070 00 00 F0 62    RTC_YY	EQU	BEEPD+1
F070 00 00 F0 63    RTC_MW	EQU	BEEPD+2
F070 00 00 F0 64    RTC_DD	EQU	BEEPD+3
F070 00 00 F0 65    RTC_TT	EQU	BEEPD+4
F070 00 00 F0 66    RTC_MM	EQU	BEEPD+5
F070 00 00 F0 67    RTC_SS	EQU	BEEPD+6
F070 00 00 F0 62    ROM_SLT	EQU	BEEPD+1
F070                
F070 00             CHECK:	DB	0
F071                
F071 4F 4B 24       OK:	DB	"OK$"
F074                	DS	5
F079 45 72 72 6F    COMERM:	DB	"Error!$"
F07D 72 21 24
F080                ;	システムワークエリア
F080                ;	_CYL0:アドレス下位1バイトが080Hになるように
F080 FF             _CYL0:	DB	0FFH	;Cylinder
F081 FF             _CYL1:	DB	0FFH	;Cylinder
F082 FF             _CYL2:	DB	0FFH	;Cylinder
F083 FF             _CYL3:	DB	0FFH	;Cylinder
F084 00             _DRIVE:	DB	0	;unit number
F085 00             _SEEKSP:DB	0	;Seek speed
F086 FF             _ISEEK:	DB	0FFH	;
F087 00             _DVSW:	DB	0
F088 00             _DRV:	DB	0
F089 FF             _DSK:	DB	0FFH
F08A 80 00          _DTA:	DW	00080H
F08C 00 00          _CTC:	DW	0
F08E 00 00          _TXADR:	DW	0
F090 00 00          _KEYPS:	DW	0
F092 00 FF          _KEYD:	DW	0FF00H	;キーデータ
F094 C2 10          _KEYSP:	DB	KEYSP_L,KEYSP_H	;オートリピートの速度
F096 07             _COLORF:DB	COLORF	;色
F097 18             _LINE:	DB	LINE
F098                
F098 00 00          _FCB:	DW	0	;SEARCH FILES
F09A 00 00          _FBPS:	DW	0	;    //
F09C 00 00          _FBAD:	DW	0	;    //
F09E 00             _FBCNT:	DB	0	;    //
F09F 00             _FILEN:	DB	0	;    //
F0A0 00             _DIRF:	DB	0	;bit7:ディレクトリ bit0-6:セクタインデックス
F0A1                	DS	1
F0A2 00             _WTFATF:DB	0	;FATバッファの更新フラグ
F0A3                	DS	1
F0A4 00             _WTDBF:	DB	0	;データバッファの更新フラグ
F0A5 FF             _DBDRV:	DB	0FFH	;データバッファにあるデータを読み込んだドライブ
F0A6 00 00          _DBSEC:	DW	0	;データバッファにあるデータを読み込んだセクタ番号
F0A8 00 00          _DPB:	DW	0
F0AA                _FATDRV:
F0AA FF             	DB	0FFH	;FATバッファに読み込んでいるドライブ
F0AB 00             _FATIX:	DB	0	;FATバッファに読み込んでいるインデックス
F0AC                _FAKEFREE:
F0AC 00 00          	DW	0	;偽の残量（FATサイズが大きくなると重くなるのでその対策）
F0AE                
F0AE                	DS	2
F0B0                
F0B0                CRTCD:
F0B0 6F             	DB	06FH
F0B1                _WIDTH:
F0B1 50             	DB	WIDTH
F0B2                TVRAMTOP:
F0B2 59 38          	DB	059H,038H
F0B4 1F 02          	DB	01FH,002H
F0B6                _LINE2:
F0B6 19             	DB	019H
F0B7                WKE4:
F0B7 1C             	DB	01CH
F0B8                WKE6:
F0B8 00             	DB	000H
F0B9                WK40:
F0B9 07             	DB	007H
F0BA                _PAGE_MINUS:
F0BA 80 F8          	DW	0-WIDTH*LINE
F0BC                _WIDTH_MINUS:
F0BC B0 FF          	DW	0-WIDTH
F0BE                WK30:
F0BE 0C             	DB	00CH
F0BF                WK31:
F0BF                WK1FD0:
F0BF 20             	DB	020H
F0C0                
F0C0 60 DB          CTC0:	DW	INTCTCE
F0C2 60 DB          CTC1:	DW	INTCTCE
F0C4 60 DB          CTC2:	DW	INTCTCE
F0C6 60 DB          CTC3:	DW	INTCTCE
F0C8 4C DB          INTVEC:	DW	INT
F0CA                
F0CA                ;	LSX-Dodgers 独自BIOS
F0CA                
F0CA C3 83 E0       _INKEY:	JP	INKEY
F0CD C3 3B DD       _PRINT:	JP	PRINT
F0D0 C3 EB DF       _SCRN:	JP	SCRN
F0D3 C3 15 E0       _POS:	JP	POS
F0D6 C3 69 DE       _LOC:	JP	LOC
F0D9                _CHGDRV:
F0D9 C3 0C ED       	JP	CHGDRV
F0DC                _GETDPB:
F0DC C3 D7 ED       	JP	GETDPB
F0DF                _FFLUSH:
F0DF C3 F5 ED       	JP	FFLUSH
F0E2                _RDFATX:
F0E2 C3 E5 E9       	JP	RDFATX
F0E5 C3 0D EB       _RDFAT:	JP	RDFAT
F0E8 C3 D4 EE       _WTTRK:	JP	WTTRK
F0EB C3 E8 EE       _FDRD:	JP	FDRD
F0EE C3 DA EE       _FDWT:	JP	FDWT
F0F1                _BPB2DPB:
F0F1 C3 9A EB       	JP	BPB2DPB
F0F4                _BREAK:
F0F4 C3 C2 D4       	JP	END_BATCH
F0F7                _GNCL:
F0F7 C3 87 EA       	JP	GNCL		; self-modifying code
F0FA 00 00 F0 F8    GNCPAT	EQU	$-2
F0FA                _SNCL:
F0FA C3 AA EA       	JP	SNCL		; self-modifying code
F0FD 00 00 F0 FB    SNCPAT	EQU	$-2
F0FD C3 7C D3       _COMANL:JP	COMANL
F100                
F100                _WE:
F100                	INCLUDE	"LDCALL.ASM"
F100                
F100                ;	LSX-Dodgers システムコール(BDOS)
F100                ;
F100                ;	LSX-Dodgers SYSTEM CALL
F100                ;	STABLE:アドレス下位1バイトが0になるように
F100                
F100                STABLE:
F100                ;0
F100 03 F0 A3 DB    	DW	_SYS00,_SYS01,_SYS02,_SYS03
F104 AF DB 39 E2
F108 92 D8 92 D8    	DW	_SYS04,_SYS05,_SYS06,_SYS07
F10C B4 DB 09 F0
F110 BC DB 94 D8    	DW	_SYS08,_SYS09,_SYS0A,_SYS0B
F114 27 DC 53 DC
F118 A9 D8 AE D8    	DW	_SYS0C,_SYS0D,_SYS0E,_SYS0F
F11C BD D8 CE D8
F120                ;1
F120 22 D9 69 D9    	DW	_SYS10,_SYS11,_SYS12,_SYS13
F124 B2 D9 E8 D9
F128 F0 D9 06 DA    	DW	_SYS14,_SYS15,_SYS16,_SYS17
F12C 1B DA 13 DA
F130 62 DA 67 DA    	DW	_SYS18,_SYS19,_SYS1A,_SYS1B
F134 6C DA 72 DA
F138 92 D8 98 DA    	DW	_SYS1C,_SYS1D,_SYS1E,_SYS1F
F13C 92 D8 9C DA
F140                ;2
F140 92 D8 52 DA    	DW	_SYS20,_SYS21,_SYS22,_SYS23
F144 5A DA A3 DA
F148 C9 DA 92 D8    	DW	_SYS24,_ERROR,_SYS26,_SYS27
F14C B9 E6 91 E7
F150 5A DA D2 DA    	DW	_SYS28,_SYS29,_SYS2A,_SYS2B
F154 69 DC 39 E2
F158 8C DC 39 E2    	DW	_SYS2C,_SYS2D,_SYS2E,_SYS2F
F15C 92 D8 F3 DA
F160                ;3
F160 ED DA 92 D8    	DW	_SYS30,_ERROR,_ERROR,_ERROR
F164 92 D8 92 D8
F168 92 D8 92 D8    	DW	_ERROR,_ERROR,_ERROR,_ERROR
F16C 92 D8 92 D8
F170 92 D8 39 E2    	DW	_ERROR,_SYS39,_SYS3A,_SYS5A
F174 39 E2 14 DB
F178                ;DOS2
F178 75 D8          	DW	_DOS2
F17A                
F17A                	DS	2
F17C 00 F3          _FATBF:	DW	FATBF
F17E 00 FB          _DTBUF:	DW	DTBUF
F180                
F180                ;	コントロールコードテーブル
F180                ;	CTRLTB:アドレス下位1バイトが080Hになるように
F180                
F180                CTRLTB:
F180 DE DD DE DD    	DW	CTRL00,CTRL00,CTRL02,CTRL03	;  A,B,C
F184 1A DE 5F DF
F188 59 DF 3E DE    	DW	CTRL04,CTRL05,CTRL06,CTRL07	;D,E,F,G
F18C 38 DF C1 DE
F190 EA DD 0B DE    	DW	CTRL08,CTRL09,CTRL0A,CTRL0B	;H,I,J,K
F194 62 DF 7F DE
F198 35 DF 64 DE    	DW	CTRL0C,CTRL0D,CTRL0E,CTRL00	;L,M,N,O
F19C 77 DF DE DD
F1A0 DE DD DE DD    	DW	CTRL00,CTRL00,CTRL12,CTRL00	;P,Q,R,S
F1A4 77 DE DE DD
F1A8 DE DD DE DD    	DW	CTRL00,CTRL00,CTRL00,CTRL00	;T,U,V,W
F1AC DE DD DE DD
F1B0 DE DD DE DD    	DW	CTRL00,CTRL00,CTRL0C,CTRL1B	;X,Y,Z,ESC
F1B4 35 DF 86 DE
F1B8 05 DE F1 DD    	DW	CTRL1C,CTRL1D,CTRL1E,CTRL1F	;→,←,↑,↓
F1BC FA DD 62 DF
F1C0                
F1C0 02 00          M2D:	DW	2
F1C2 FD 02          	DB	0FDH,2
F1C4 64 01          	DW	356
F1C6 FF 07 28 09    	DB	0FFH,7,40,9,1,082H
F1CA 01 82
F1CC 05 00 A7 00    	DW	5,0A7H,8
F1D0 08 00
F1D2                
F1D2 02 00          M2HD:	DW	2
F1D4 FE 01          	DB	0FEH,1
F1D6 C7 04          	DW	1223
F1D8 FE 06 4D 08    	DB	0FEH,6,77,8,1,084H
F1DC 01 84
F1DE 05 00 A7 00    	DW	5,0A7H,9
F1E2 09 00
F1E4                
F1E4 16 17          SDDATA:	DB	22,23		;(FCB)ファイルを最後に変更した時刻
F1E6 14 15          	DB	20,21		;(FCB)ファイルを最後に変更した日付
F1E8 1A 1B          	DB	26,27		;(FCB)ファイルの先頭クラスタ
F1EA 10 11 12 13    	DB	16,17,18,19	;(FCB)ファイルのサイズ(バイト単位)
F1EE                SDDATAE:
F1EE                
F1EE                	DS	2
F1F0                _FCB_BAT:
F1F0 C4 EF          	DW	FCB_BAT
F1F2                _PATH:
F1F2 63 EF          	DW	PATHD
F1F4                
F1F4                SCDIR:	DS	2		;+14 +15
F1F6                SFBPS:	DS	2		;FBPS
F1F8                SFNDF:	DS	2		;FILEN DIRF
F1FA                
F1FA 00 00          _FATPS:	DW	0
F1FC 00 00          _DIRPS:	DW	0
F1FE 00 00          _CLPS:	DW	0
F200                
F200                _PE:
F200                	INCLUDE	"X1DPB.ASM"
F200                
F200                ;	LSX-Dodgers DPB
F200                ;	X1/turbo/Z
F200                
F200                _DEVICE:
F200                
F200                ;	A:
F200                
F200 02 00          	DW	2	;DPB_FATLN
F202 EB F0          	DW	_FDRD	;DPB_DRD
F204 EE F0          	DW	_FDWT	;DPB_DWT
F206 FD             	DB	0FDH	;DPB_FATID
F207 02             	DB	2	;DPB_SECPCL
F208 64 01          	DW	356	;DPB_MAXCL
F20A FF             	DB	0FFH	;DPB_FDMODE	0FFH=2D / 0FEH=2HD
F20B 07             	DB	7	;DPB_DIRSCNT
F20C 28             	DB	40	;DPB_MAXCYL
F20D 09             	DB	9	;DPB_MAXSEC	Number of sectors
F20E 01             	DB	1	;DPB_FATPS
F20F 82             	DB	082H	;DPB_BPS
F210 05 00          	DW	5	;DPB_DIRPS
F212 A7             	DB	0A7H	;DPB_DEVICE	Device Number
F213 00             	DB	0	;DPB_UNITNO
F214 08 00          	DW	8	;DPB_ADDCL
F216 00 00          	DW	0	;DPB_16
F218 00 00          	DW	0	;DPB_18
F21A 00 00          	DW	0	;DPB_SDIR
F21C 46 44 44 30    	DB	"FDD0"	;DPB_NAME
F220                
F220                ;	B:
F220                
F220 02 00          	DW	2	;DPB_FATLN
F222 EB F0          	DW	_FDRD	;DPB_DRD
F224 EE F0          	DW	_FDWT	;DPB_DWT
F226 FD             	DB	0FDH	;DPB_FATID
F227 02             	DB	2	;DPB_SECPCL
F228 64 01          	DW	356	;DPB_MAXCL
F22A FF             	DB	0FFH	;DPB_FDMODE	0FFH=2D / 0FEH=2HD
F22B 07             	DB	7	;DPB_DIRSCNT
F22C 28             	DB	40	;DPB_MAXCYL
F22D 09             	DB	9	;DPB_MAXSEC	Number of sectors
F22E 01             	DB	1	;DPB_FATPS
F22F 82             	DB	082H	;DPB_BPS
F230 05 00          	DW	5	;DPB_DIRPS
F232 A7             	DB	0A7H	;DPB_DEVICE	Device Number
F233 01             	DB	1	;DPB_UNITNO
F234 08 00          	DW	8	;DPB_ADDCL
F236 00 00          	DW	0	;DPB_16
F238 00 00          	DW	0	;DPB_18
F23A 00 00          	DW	0	;DPB_SDIR
F23C 46 44 44 31    	DB	"FDD1"	;DPB_NAME
F240                
F240                ;	C:
F240                
F240 02 00          	DW	2	;DPB_FATLN
F242 EB F0          	DW	_FDRD	;DPB_DRD
F244 EE F0          	DW	_FDWT	;DPB_DWT
F246 FD             	DB	0FDH	;DPB_FATID
F247 02             	DB	2	;DPB_SECPCL
F248 64 01          	DW	356	;DPB_MAXCL
F24A FF             	DB	0FFH	;DPB_FDMODE	0FFH=2D / 0FEH=2HD
F24B 07             	DB	7	;DPB_DIRSCNT
F24C 28             	DB	40	;DPB_MAXCYL
F24D 09             	DB	9	;DPB_MAXSEC	Number of sectors
F24E 01             	DB	1	;DPB_FATPS
F24F 82             	DB	082H	;DPB_BPS
F250 05 00          	DW	5	;DPB_DIRPS
F252 A7             	DB	0A7H	;DPB_DEVICE	Device Number
F253 02             	DB	2	;DPB_UNITNO
F254 08 00          	DW	8	;DPB_ADDCL
F256 00 00          	DW	0	;DPB_16
F258 00 00          	DW	0	;DPB_18
F25A 00 00          	DW	0	;DPB_SDIR
F25C 46 44 44 32    	DB	"FDD2"	;DPB_NAME
F260                
F260                ;	D:
F260                
F260 02 00          	DW	2	;DPB_FATLN
F262 EB F0          	DW	_FDRD	;DPB_DRD
F264 EE F0          	DW	_FDWT	;DPB_DWT
F266 FD             	DB	0FDH	;DPB_FATID
F267 02             	DB	2	;DPB_SECPCL
F268 64 01          	DW	356	;DPB_MAXCL
F26A FF             	DB	0FFH	;DPB_FDMODE	0FFH=2D / 0FEH=2HD
F26B 07             	DB	7	;DPB_DIRSCNT
F26C 28             	DB	40	;DPB_MAXCYL
F26D 09             	DB	9	;DPB_MAXSEC	Number of sectors
F26E 01             	DB	1	;DPB_FATPS
F26F 82             	DB	082H	;DPB_BPS
F270 05 00          	DW	5	;DPB_DIRPS
F272 A7             	DB	0A7H	;DPB_DEVICE
F273 03             	DB	3	;DPB_UNITNO
F274 08 00          	DW	8	;DPB_ADDCL
F276 00 00          	DW	0	;DPB_16
F278 00 00          	DW	0	;DPB_18
F27A 00 00          	DW	0	;DPB_SDIR
F27C 46 44 44 33    	DB	"FDD3"	;DPB_NAME
F280                
F280                ;	E:
F280                
F280 00 00          EMMFL:	DW	0	;DPB_FATLN
F282 30 D8          EMMRD:	DW	EDRD	;DPB_DRD
F284 1C D8          EMMWR:	DW	EDWT	;DPB_DWT
F286 FE             	DB	0FEH	;DPB_FATID
F287 02             	DB	2	;DPB_SECPCL
F288 00 00          EMMCL:	DW	0	;DPB_MAXCL
F28A 00             	DB	0	;DPB_FDMODE
F28B 0C             	DB	12	;DPB_DIRSCNT
F28C 00             	DB	0	;DPB_MAXCYL
F28D 00             	DB	0	;DPB_MAXSEC
F28E 02             	DB	2	;DPB_FATPS
F28F 02             	DB	2	;DPB_BPS
F290 0A 00          	DW	10	;DPB_DIRPS
F292 06             	DB	6	;DPB_DEVICE
F293 00             	DB	0	;DPB_UNITNO
F294 12 00          	DW	18	;DPB_ADDCL
F296 00 00          	DW	0	;DPB_16
F298 00 00          	DW	0	;DPB_18
F29A 00 00          	DW	0	;DPB_SDIR
F29C 45 4D 4D 30    	DB	"EMM0"	;DPB_NAME
F2A0                
F2A0                ;	F:
F2A0                
F2A0 00 00          BANKFL:	DW	0	;DPB_FATLN
F2A2 B4 D7          	DW	BDRD	;DPB_DRD
F2A4 B0 D7          	DW	BDWT	;DPB_DWT
F2A6 F9             	DB	0F9H	;DPB_FATID
F2A7 02             	DB	2	;DPB_SECPCL
F2A8 00 00          BANKCL:	DW	0	;DPB_MAXCL
F2AA 00             	DB	0	;DPB_FDMODE
F2AB 08             	DB	8	;DPB_DIRSCNT
F2AC 00             	DB	0	;DPB_MAXCYL
F2AD 01             	DB	1	;DPB_MAXSEC
F2AE 00             	DB	0	;DPB_FATPS
F2AF 02             	DB	2	;DPB_BPS
F2B0 02 00          	DW	2	;DPB_DIRPS
F2B2 0B             BANKDV:	DB	00BH	;DPB_DEVICE
F2B3 00             	DB	0	;DPB_UNITNO
F2B4 06 00          	DW	6	;DPB_ADDCL
F2B6 00 00          	DW	0	;DPB_16
F2B8 00 00          	DW	0	;DPB_18
F2BA 00 00          	DW	0	;DPB_SDIR
F2BC 42 52 41 4D    	DB	"BRAM"	;DPB_NAME
F2C0                
F2C0                ;	G:
F2C0                
F2C0 02 00          	DW	2	;DPB_FATLN
F2C2 71 D7          	DW	GDRD	;DPB_DRD
F2C4 88 D7          	DW	GDWT	;DPB_DWT
F2C6 FA             	DB	0FAH	;DPB_FATID
F2C7 01             	DB	1	;DPB_SECPCL
F2C8 B8 00          	DW	184	;DPB_MAXCL
F2CA 00             	DB	0	;DPB_FDMODE
F2CB 07             	DB	7	;DPB_DIRSCNT
F2CC 00             	DB	0	;DPB_MAXCYL
F2CD 01             	DB	1	;DPB_MAXSEC
F2CE 01             	DB	1	;DPB_FATPS
F2CF 01             	DB	1	;DPB_BPS
F2D0 03 00          	DW	3	;DPB_DIRPS
F2D2 05             	DB	5	;DPB_DEVICE
F2D3 01             	DB	1	;DPB_UNITNO
F2D4 08 00          	DW	8	;DPB_ADDCL
F2D6 00 00          	DW	0	;DPB_16
F2D8 00 00          	DW	0	;DPB_18
F2DA 00 00          	DW	0	;DPB_SDIR
F2DC 47 52 41 4D    	DB	"GRAM"	;DPB_NAME
F2E0                
F2E0                ;	H:
F2E0                	DS	32-8
F2F8 00             	DB	0
F2F9                
F2F9                LAST_ADR:
F2F9                
F2F9                	END
F2F9                
