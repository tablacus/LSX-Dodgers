0000                ;	LSX-Dodgers for X1/turbo/Z
0000                ;	Programmed by
0000                ;	Gaku (Lovers/Tablacus)
0000                
0000                	INCLUDE	"X1DEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                ;	X1/turbo/Z
0000                
0000 00 00 00 00    MAC	EQU	0		;X1
0000 00 00 00 00    DEV EQU 0
0000                
0000 00 00 CB 00    RUN	EQU	0CB00H
0000 00 00 D1 06    BDOS	EQU	0D106H
0000 00 00 EF 00    WORKAD	EQU	0EF00H
0000 00 00 F2 00    FATBF	EQU	0F200H
0000 00 00 FA 00    DTBUF	EQU	0FA00H
0000 00 00 FE 00    KEYBF	EQU	0FE00H
0000 00 00 FF 00    KBUF	EQU	0FF00H
0000 00 00 FF CA    EXTSP	EQU	0FFCAH
0000 00 00 FF D9    TRAP38	EQU	0FFD9H
0000 00 00 00 50    WIDTH	EQU	80
0000 00 00 00 18    LINE	EQU	24
0000 00 00 00 07    COLORF	EQU	7
0000 00 00 00 09    COMS	EQU	9
0000                
0000                ;DRDC	EQU	DRD24
0000                ;DWTC	EQU	DWT24
0000                ;DRDF	EQU	DRDF0
0000                ;DWTF	EQU	DWTF0
0000                
0000                	INCLUDE	"LDDEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                
0000 00 00 00 01    VER_1   EQU	1
0000 00 00 00 04    VER_2   EQU	4
0000 00 00 00 07    VER_3   EQU	7
0000 00 00 1D 00    MACW	EQU	MAC + 01D00H	;機種フラグとLD判別フラグ
0000 00 00 00 00    MACD	EQU	MAC + DEV * 256	;機種フラグとデバイスフラグ
0000 00 00 01 47    VER	EQU	VER_1 * 256 + VER_2 * 16 + VER_3
0000                
0000 00 00 00 05    SYSTEM	EQU	00005H
0000 00 00 00 0F    JP_HL	EQU	0000FH
0000 00 00 00 5C    FCB1	EQU	0005CH
0000 00 00 00 6C    FCB2	EQU	0006CH
0000 00 00 00 5D    FCB1FN	EQU	FCB1+1
0000 00 00 00 6D    FCB2FN	EQU	FCB2+1
0000 00 00 00 80    DTA1	EQU	00080H
0000                
0000 00 00 FF CA    EXTBIO	EQU	0FFCAH
0000                
0000                
0000                	ORG	RUN-7
CAF9                
CAF9                ;	MSX BINARY HEADER
CAF9 FE             	DB	0FEH
CAFA                ;	MSX BINARY START ADDRESS
CAFA 00 CB          	DW	RUN
CAFC                ;	MSX BINARY END ADDRESS
CAFC F9 F1          	DW	LAST_ADR
CAFE                ;	MSX BINARY EXEC ADDRESS
CAFE 07 CB          	DW	START
CB00                
CB00                	INCLUDE	"X1INIT.ASM"
CB00                
CB00                ;	LSX-Dodgers INIT
CB00                ;	X1/turbo/Z
CB00                
CB00 C3 07 CB       	JP	START
CB03 00 1D          	DW	MACW
CB05 47 01          	DW	VER
CB07                
CB07                START:
CB07 F3             	DI
CB08 ED 5E          	IM	2
CB0A 31 CA FF       	LD	SP,EXTSP
CB0D CD 1B CB       	CALL	INIT		;NZならAUTOEXECを実行
CB10 21 00 00       	LD	HL,0
CB13 E5             	PUSH	HL
CB14 C8             	RET	Z
CB15 11 9B CE       	LD	DE,AUTOD
CB18 C3 FD EF       	JP	_COMANL
CB1B                
CB1B                INIT:
CB1B 3E 1E          	LD	A,01EH
CB1D D3 00          	OUT	(0),A
CB1F                
CB1F 01 00 00       	LD	BC,0
CB22 ED 43 8C EF    	LD	(_CTC),BC
CB26 01 04 0A       	LD	BC,00A04H
CB29 CD 45 CE       	CALL	CHKCTC
CB2C 01 04 07       	LD	BC,00704H
CB2F CD 45 CE       	CALL	CHKCTC
CB32 01 A8 1F       	LD	BC,01FA8H
CB35 CD 45 CE       	CALL	CHKCTC
CB38 01 A0 1F       	LD	BC,01FA0H
CB3B CD 45 CE       	CALL	CHKCTC
CB3E                ;
CB3E                INISIO:
CB3E 01 91 1F       	LD	BC,01F91H	;INIT SIO
CB41 16 01          	LD	D,1
CB43 ED 51          	OUT	(C),D
CB45                
CB45 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB47 0E 93          	LD	C,093H
CB49 ED 51          	OUT	(C),D
CB4B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB4D 0E 99          	LD	C,099H		;INIT SIO
CB4F 16 01          	LD	D,1
CB51 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB53 0E 9B          	LD	C,09BH
CB55 ED 51          	OUT	(C),D
CB57 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB59                
CB59 0E 80          	LD	C,080H		;INIT DMA
CB5B 21 06 C3       	LD	HL,0C306H
CB5E                INIDMA:
CB5E ED 61          	OUT	(C),H
CB60 2D             	DEC	L
CB61 20 FB          	JR	NZ,INIDMA
CB63                
CB63 3E E4          	LD	A,0E4H
CB65 CD C6 DE       	CALL	COMOUT
CB68 AF             	XOR	A
CB69 CD A0 DE       	CALL	OT49SB
CB6C                
CB6C 3E EF          	LD	A,INTVEC/256
CB6E ED 47          	LD	I,A
CB70                
CB70 ED 4B 8C EF    	LD	BC,(_CTC)
CB74 0B             	DEC	BC
CB75 0B             	DEC	BC
CB76                
CB76 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB78 3E C0          	LD	A,CTC0
CB7A ED 79          	OUT	(C),A
CB7C                
CB7C 0C             	INC	C
CB7D 3E 47          	LD	A,047H
CB7F ED 79          	OUT	(C),A
CB81 3E 0D          	LD	A,13		;Baudrate 9600-13
CB83 ED 79          	OUT	(C),A
CB85                
CB85 79             	LD	A,C
CB86 D6 10          	SUB	010H
CB88 4F             	LD	C,A
CB89                ;	LD	(SIOAD+1),BC
CB89                ;	LD	(SIOAD0+1),BC
CB89                ;	LD	(SIOAD1+1),BC
CB89                
CB89 21 EB CE       	LD	HL,SIODATA
CB8C                SINIT1:
CB8C 7E             	LD	A,(HL)
CB8D 23             	INC	HL
CB8E FE FF          	CP	0FFH
CB90 28 04          	JR	Z,SINIT2
CB92 ED 79          	OUT	(C),A
CB94 18 F6          	JR	SINIT1
CB96                SINIT2:
CB96 3E E4          	LD	A,0E4H
CB98 CD C6 DE       	CALL	COMOUT
CB9B 3E C8          	LD	A,INTVEC
CB9D CD A0 DE       	CALL	OT49SB
CBA0                ;
CBA0 01 C4 1F       	LD	BC,01FC4H
CBA3 3E 0C          	LD	A,00CH
CBA5 ED 79          	OUT	(C),A
CBA7                
CBA7 0E C0          	LD	C,0C0H
CBA9 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBAB                
CBAB 0C             	INC	C
CBAC 3E 28          	LD	A,40
CBAE ED 79          	OUT	(C),A
CBB0                
CBB0 0C             	INC	C
CBB1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBB3                
CBB3 0C             	INC	C
CBB4 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBB6                
CBB6 0E C5          	LD	C,0C5H
CBB8 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBBA                
CBBA                TEXT:
CBBA 0E B0          	LD	C,0B0H
CBBC 3E 80          	LD	A,080H
CBBE ED 79          	OUT	(C),A
CBC0 16 07          	LD	D,7
CBC2 0E B9          	LD	C,0B9H
CBC4 21 E4 CE       	LD	HL,TEXTDT
CBC7                TEXT1:
CBC7 04             	INC	B
CBC8 ED A3          	OUTI
CBCA 0C             	INC	C
CBCB 15             	DEC	D
CBCC 20 F9          	JR	NZ,TEXT1
CBCE 01 B0 1F       	LD	BC,01FB0H
CBD1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBD3                
CBD3 0E C4          	LD	C,0C4H
CBD5 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBD7                
CBD7 01 01 1A       	LD	BC,01A01H
CBDA ED 78          	IN	A,(C)
CBDC E6 08          	AND	8
CBDE 28 09          	JR	Z,PRN
CBE0 0E 03          	LD	C,003H
CBE2 3E 0F          	LD	A,00FH
CBE4 ED 79          	OUT	(C),A
CBE6 01 04 0A       	LD	BC,00A04H
CBE9                PRN:
CBE9 21 00 00       	LD	HL,0
CBEC 06 5C          	LD	B,05CH
CBEE 3E FF          	LD	A,0FFH		;RST 38H
CBF0 CD 1E E1       	CALL	FILL_MEMORY
CBF3 06 A4          	LD	B,0A4H
CBF5 AF             	XOR	A
CBF6 CD 1E E1       	CALL	FILL_MEMORY
CBF9                
CBF9 3E C3          	LD	A,0C3H		;JP
CBFB 21 03 EF       	LD	HL,CPM_WBOOT
CBFE 32 00 00       	LD	(00000H),A
CC01 22 01 00       	LD	(00001H),HL	;IPL
CC04                
CC04 21 00 1D       	LD	HL,MACW	;3 bit7  DPB Compatible LA(1)
CC07 22 03 00       	LD	(00003H),HL	;  bit6-0 Machine X1(0)
CC0A                ;				;4 LSX-Dodgers(01DH)
CC0A 21 06 D1       	LD	HL,BDOS
CC0D 32 05 00       	LD	(00005H),A
CC10 22 06 00       	LD	(00006H),HL	;BDOS
CC13                
CC13 21 C0 DA       	LD	HL,BIOS
CC16 22 19 00       	LD	(00019H),HL	;BIOS-ROM
CC19                
CC19 21 D9 FF       	LD	HL,TRAP38	;TRAP38
CC1C 32 38 00       	LD	(00038H),A
CC1F 22 39 00       	LD	(00039H),HL	;RST 038H
CC22                
CC22 3E EF          	LD	A,CPM_BOOT/256
CC24 32 0B 00       	LD	(0000BH),A
CC27                
CC27 3E E9          	LD	A,0E9H		;JP (HL)
CC29 32 0F 00       	LD	(0000FH),A
CC2C                
CC2C 3A 7D F0       	LD	A,(_FATBF+1)
CC2F 32 13 00       	LD	(00013H),A
CC32                
CC32 3A 7F F0       	LD	A,(_DTBUF+1)
CC35 32 17 00       	LD	(00017H),A
CC38                
CC38 3E FE          	LD	A,KEYBF/256
CC3A 32 1B 00       	LD	(0001BH),A
CC3D                
CC3D 3E FF          	LD	A,KBUF/256
CC3F 32 1F 00       	LD	(0001FH),A
CC42                
CC42 21 47 01       	LD	HL,VER
CC45 22 5A 00       	LD	(0005AH),HL
CC48                
CC48 3E E6          	LD	A,0E6H
CC4A CD C6 DE       	CALL	COMOUT
CC4D CD AB DE       	CALL	IN49SB
CC50 F5             	PUSH	AF
CC51 CD AB DE       	CALL	IN49SB
CC54 F1             	POP	AF
CC55 F5             	PUSH	AF
CC56 E6 12          	AND	012H
CC58 20 05          	JR	NZ,KEYR
CC5A 3E 01          	LD	A,1
CC5C 32 9B CD       	LD	(KEYREP+1),A
CC5F                KEYR:
CC5F F1             	POP	AF
CC60 E6 03          	AND	3
CC62 28 0E          	JR	Z,NON
CC64                
CC64 01 D0 3F       	LD	BC,03FD0H
CC67 ED 49          	OUT	(C),C
CC69 3E 37          	LD	A,037H
CC6B D3 D0          	OUT	(0D0H),A
CC6D ED 78          	IN	A,(C)
CC6F B9             	CP	C
CC70 28 65          	JR	Z,TURBO
CC72                NON:
CC72 21 F7 CE       	LD	HL,AT_SCR1
CC75 11 50 DF       	LD	DE,SCR1
CC78 01 94 00       	LD	BC,SCRNE-SCR1	;転送先のサイズ確認用
CC7B 01 85 00       	LD	BC,AT_SCRE-AT_SCR1
CC7E ED B0          	LDIR
CC80                
CC80 21 7C CF       	LD	HL,AT_DWT
CC83 11 6B EE       	LD	DE,WTTRK
CC86 01 8F 00       	LD	BC,DMAE-WTTRK	;転送先のサイズ確認用
CC89 01 8E 00       	LD	BC,AT_CPUE-AT_DWT
CC8C ED B0          	LDIR
CC8E                
CC8E 21 0A D0       	LD	HL,AT_EDWT
CC91 11 69 D7       	LD	DE,EDWT
CC94 01 4B 00       	LD	BC,EMME-EDWT	;転送先のサイズ確認用
CC97 01 46 00       	LD	BC,AT_EMME-AT_EDWT
CC9A ED B0          	LDIR
CC9C                
CC9C 21 CB DF       	LD	HL,AT_WTTRK+AT_RS
CC9F 22 E9 EF       	LD	(_WTTRK+1),HL
CCA2 21 B4 EE       	LD	HL,AT_DRD+AT_R
CCA5 22 EC EF       	LD	(_FDRD+1),HL
CCA8 21 6B EE       	LD	HL,AT_DWT+AT_R
CCAB 22 EF EF       	LD	(_FDWT+1),HL
CCAE 21 7D D7       	LD	HL,AT_EDRD+AT_RE
CCB1 22 82 F1       	LD	(EMMRD),HL
CCB4 21 69 D7       	LD	HL,AT_EDWT+AT_RE
CCB7 22 84 F1       	LD	(EMMWR),HL
CCBA 21 D2 DF       	LD	HL,AT_SCRN+AT_RS
CCBD 22 D1 EF       	LD	(_SCRN+1),HL
CCC0                
CCC0 3E 27          	LD	A,027H			;ノンターボはMFM切り替えを行わない
CCC2 32 12 F1       	LD	(DEVICE+012H),A		;Aドライブ
CCC5 32 32 F1       	LD	(DEVICE+012H+32),A	;Bドライブ
CCC8 32 52 F1       	LD	(DEVICE+012H+32*2),A	;Cドライブ
CCCB 32 72 F1       	LD	(DEVICE+012H+32*3),A	;Dドライブ
CCCE                
CCCE 21 00 00       	LD	HL,0
CCD1 22 F1 DE       	LD	(X1PAT),HL
CCD4 C3 52 CD       	JP	NOBANK
CCD7                
CCD7                TURBO:
CCD7 F3             	DI			;Check BIOS
CCD8 06 1D          	LD	B,01DH
CCDA ED 79          	OUT	(C),A		;BIOS ON
CCDC 3A 51 2F       	LD	A,(02F51H)
CCDF 04             	INC	B		;B=01EH
CCE0 ED 79          	OUT	(C),A		;BIOS OFF
CCE2 FB             	EI
CCE3 FE C9          	CP	0C9H
CCE5 28 02          	JR	Z,BIOSOK
CCE7 18 05          	JR	NOBIOS
CCE9                BIOSOK:
CCE9 3E C3          	LD	A,0C3H		;JP
CCEB 32 18 00       	LD	(00018H),A
CCEE                NOBIOS:
CCEE 3E 1F          	LD	A,01FH		;スタートポート
CCF0 DB F0          	IN	A,(0F0H)
CCF2 0F             	RRCA
CCF3 38 0B          	JR	C,CRT1
CCF5 21 D4 CE       	LD	HL,_C8025H
CCF8 11 B0 EF       	LD	DE,CRTCD
CCFB 01 10 00       	LD	BC,16
CCFE ED B0          	LDIR
CD00                CRT1:
CD00 3E 1F          	LD	A,01FH		;スタートポート
CD02 DB F0          	IN	A,(0F0H)
CD04 CB 57          	BIT	2,A
CD06 28 18          	JR	Z,BANK
CD08                
CD08 AF             	XOR	A
CD09                TZ1:				;前面スイッチが2HDの場合はMFMモードを2HDにしておく
CD09 F5             	PUSH	AF
CD0A CD DC EF       	CALL	_GETDPB
CD0D DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
CD10 E6 8F          	AND	08FH
CD12 FE 87          	CP	087H		;フロッピーでMEM切り替えがON
CD14 20 04          	JR	NZ,TZ2
CD16 DD CB 0A 86    	RES	0,(IX+0AH)	;(DPB_0A_FDMODE)
CD1A                TZ2:
CD1A F1             	POP	AF
CD1B 3C             	INC	A
CD1C FE 08          	CP	8
CD1E 38 E9          	JR	C,TZ1
CD20                
CD20                BANK:
CD20 01 00 0B       	LD	BC,00B00H
CD23 21 00 7F       	LD	HL,07F00H
CD26 F3             	DI
CD27                BANK1:
CD27 ED 69          	OUT	(C),L
CD29 5E             	LD	E,(HL)
CD2A 7B             	LD	A,E
CD2B C6 A5          	ADD	A,0A5H
CD2D 77             	LD	(HL),A
CD2E BE             	CP	(HL)
CD2F 73             	LD	(HL),E
CD30 20 05          	JR	NZ,BANK2
CD32 2C             	INC	L
CD33 CB 65          	BIT	4,L
CD35 28 F0          	JR	Z,BANK1
CD37                BANK2:
CD37 3E 10          	LD	A,010H
CD39 ED 79          	OUT	(C),A
CD3B 7D             	LD	A,L
CD3C B7             	OR	A
CD3D 28 13          	JR	Z,NOBANK
CD3F 26 00          	LD	H,0
CD41 29             	ADD	HL,HL	;*2
CD42 29             	ADD	HL,HL	;*4
CD43 29             	ADD	HL,HL	;*8
CD44 29             	ADD	HL,HL	;*16
CD45 29             	ADD	HL,HL	;*32
CD46 2B             	DEC	HL	;-1
CD47 2B             	DEC	HL	;-2
CD48 2B             	DEC	HL	;-3
CD49 22 A8 F1       	LD	(BANKCL),HL
CD4C CD 8B CE       	CALL	CALC_FATLN
CD4F 32 A0 F1       	LD	(BANKFL),A
CD52                NOBANK:
CD52                EMM:
CD52 DD 21 80 F1    	LD	IX,EMMFL
CD56 CD 3C CE       	CALL	EADR0
CD59 ED 78          	IN	A,(C)
CD5B F5             	PUSH	AF
CD5C                
CD5C 11 00 00       	LD	DE,0
CD5F                ECHECK1:
CD5F 13             	INC	DE
CD60 CD 20 CE       	CALL	EADR2
CD63 ED 60          	IN	H,(C)
CD65 CD 20 CE       	CALL	EADR2
CD68 7C             	LD	A,H
CD69 C6 E5          	ADD	A,0E5H
CD6B ED 79          	OUT	(C),A
CD6D 3C             	INC	A
CD6E CD 3C CE       	CALL	EADR0
CD71 ED 79          	OUT	(C),A
CD73 3D             	DEC	A
CD74 CD 20 CE       	CALL	EADR2
CD77 ED 68          	IN	L,(C)
CD79 CD 20 CE       	CALL	EADR2
CD7C ED 61          	OUT	(C),H
CD7E BD             	CP	L
CD7F 20 04          	JR	NZ,ECHECK2
CD81 CB 5A          	BIT	3,D
CD83 28 DA          	JR	Z,ECHECK1
CD85                ECHECK2:
CD85 CD 3C CE       	CALL	EADR0
CD88 F1             	POP	AF
CD89 ED 79          	OUT	(C),A
CD8B                
CD8B 21 F7 FF       	LD	HL,0-9
CD8E 19             	ADD	HL,DE
CD8F 30 09          	JR	NC,NOEMM
CD91 22 88 F1       	LD	(EMMCL),HL
CD94 CD 8B CE       	CALL	CALC_FATLN
CD97 32 80 F1       	LD	(EMMFL),A
CD9A                NOEMM:
CD9A 3E 00          KEYREP:	LD	A,000H
CD9C B7             	OR	A
CD9D 28 07          	JR	Z,KEYR1
CD9F 01 00 00       	LD	BC,0
CDA2 ED 43 8C EF    	LD	(_CTC),BC
CDA6                KEYR1:
CDA6 CD 6C CE       	CALL	SETCRTC
CDA9 01 30 F8       	LD	BC,0-80*25
CDAC 2A BA EF       	LD	HL,(_PAGE_MINUS)
CDAF ED 43 BA EF    	LD	(_PAGE_MINUS),BC
CDB3 1E 0C          	LD	E,00CH
CDB5 CD CD EF       	CALL	_PRINT
CDB8 22 BA EF       	LD	(_PAGE_MINUS),HL
CDBB                
CDBB 21 A7 CE       	LD	HL,INIMES
CDBE CD 0D D8       	CALL	MSX
CDC1                
CDC1 3A 87 FF       	LD	A,(0FF87H)
CDC4 FE 08          	CP	8
CDC6 30 1E          	JR	NC,INIT0
CDC8 5F             	LD	E,A
CDC9 C6 41          	ADD	A,'A'
CDCB 32 A4 CE       	LD	(AUTODV),A
CDCE 0E 0E          	LD	C,00EH
CDD0 CD 05 00       	CALL	SYSTEM
CDD3 1C             	INC	E
CDD4 21 85 EF       	LD	HL,_SEEKSP	;Disk error Ignore
CDD7 CB FE          	SET	7,(HL)
CDD9 0E 1B          	LD	C,01BH
CDDB CD 05 00       	CALL	SYSTEM
CDDE                
CDDE 21 85 EF       	LD	HL,_SEEKSP
CDE1 CB BE          	RES	7,(HL)
CDE3                
CDE3 3C             	INC	A
CDE4 20 08          	JR	NZ,INIT1
CDE6                INIT0:
CDE6 1E 00          	LD	E,0
CDE8 0E 0E          	LD	C,00EH
CDEA CD 05 00       	CALL	SYSTEM
CDED AF             	XOR	A
CDEE                INIT1:
CDEE F3             	DI
CDEF 08             	EX	AF,AF'
CDF0 2E FE          	LD	L,0-2		;CALLのスタック分減らす
CDF2 39             	ADD	HL,SP
CDF3 11 00 FF       	LD	DE,0FF00H
CDF6 45             	LD	B,L
CDF7 CD E8 D4       	CALL	ZERO_MEMORY_DE
CDFA 21 CA FF       	LD	HL,EXTSP
CDFD 06 0F          	LD	B,TRAP38-EXTBIO
CDFF 3E FF          	LD	A,0FFH		;RST 38H
CE01 CD 1E E1       	CALL	FILL_MEMORY
CE04 21 50 D0       	LD	HL,AT_TRAP38
CE07 11 D9 FF       	LD	DE,TRAP38
CE0A 01 27 00       	LD	BC,AT_TRAPE-AT_TRAP38
CE0D ED B0          	LDIR
CE0F 08             	EX	AF,AF'
CE10 B7             	OR	A
CE11 C8             	RET	Z
CE12                
CE12 3E E6          	LD	A,0E6H
CE14 CD C6 DE       	CALL	COMOUT
CE17 CD AB DE       	CALL	IN49SB
CE1A CD AB DE       	CALL	IN49SB
CE1D FE 1B          	CP	01BH
CE1F C9             	RET
CE20                
CE20                EADR2:
CE20 D5             	PUSH	DE
CE21 EB             	EX	DE,HL
CE22 29             	ADD	HL,HL
CE23 29             	ADD	HL,HL
CE24 DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
CE27 DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
CE2A 09             	ADD	HL,BC
CE2B DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
CE2E 06 0D          	LD	B,00DH
CE30 ED 49          	OUT	(C),C
CE32 0C             	INC	C
CE33 ED 69          	OUT	(C),L
CE35 0C             	INC	C
CE36 ED 61          	OUT	(C),H
CE38 0C             	INC	C
CE39 EB             	EX	DE,HL
CE3A D1             	POP	DE
CE3B C9             	RET
CE3C                
CE3C                EADR0:
CE3C D5             	PUSH	DE
CE3D 11 00 00       	LD	DE,0
CE40 CD 20 CE       	CALL	EADR2
CE43 D1             	POP	DE
CE44 C9             	RET
CE45                
CE45                CHKCTC:
CE45 C5             	PUSH	BC
CE46 11 03 47       	LD	DE,04703H
CE49                INICTC1:
CE49 0C             	INC	C
CE4A ED 51          	OUT	(C),D
CE4C ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CE4E 1D             	DEC	E
CE4F 20 F8          	JR	NZ,INICTC1
CE51 C1             	POP	BC
CE52                
CE52 11 FA 07       	LD	DE,007FAH
CE55 ED 51          	OUT	(C),D
CE57 ED 59          	OUT	(C),E
CE59 ED 78          	IN	A,(C)
CE5B BB             	CP	E
CE5C C0             	RET	NZ
CE5D ED 51          	OUT	(C),D
CE5F ED 51          	OUT	(C),D
CE61 ED 78          	IN	A,(C)
CE63 BA             	CP	D
CE64 C0             	RET	NZ
CE65 03             	INC	BC
CE66 03             	INC	BC
CE67 ED 43 8C EF    	LD	(_CTC),BC
CE6B C9             	RET
CE6C                
CE6C                SETCRTC:
CE6C 21 B0 EF       	LD	HL,CRTCD
CE6F AF             	XOR	A
CE70                SETCRT1:
CE70 01 00 18       	LD	BC,01800H
CE73 ED 79          	OUT	(C),A
CE75 0C             	INC	C
CE76 04             	INC	B
CE77 ED A3          	OUTI
CE79 3C             	INC	A
CE7A FE 0C          	CP	12
CE7C 20 F2          	JR	NZ,SETCRT1
CE7E 23             	INC	HL
CE7F 23             	INC	HL
CE80 01 03 1B       	LD	BC,01A03H+00100H
CE83 ED A3          	OUTI
CE85 01 D0 20       	LD	BC,01FD0H+00100H
CE88 ED A3          	OUTI
CE8A C9             	RET
CE8B                
CE8B                CALC_FATLN:	;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
CE8B 5D             	LD	E,L
CE8C 54             	LD	D,H
CE8D 29             	ADD	HL,HL	;*2
CE8E 19             	ADD	HL,DE	;*3
CE8F CB 3C          	SRL	H	;/2
CE91 CB 1D          	RR	L	;1クラスタ辺り1.5バイト必要
CE93 11 FF 01       	LD	DE,511	;切り上げる
CE96 19             	ADD	HL,DE
CE97 7C             	LD	A,H
CE98 CB 3F          	SRL	A
CE9A C9             	RET
CE9B                
CE9B 41 55 54 4F    AUTOD:	DB	"AUTOEXEC "
CE9F 45 58 45 43
CEA3 20
CEA4 41 3A 00       AUTODV:	DB	"A:",0
CEA7                
CEA7 4C 53 58 2D    INIMES:	DB	"LSX-Dodgers for X1/turbo version "
CEAB 44 6F 64 67
CEAF 65 72 73 20
CEB3 66 6F 72 20
CEB7 58 31 2F 74
CEBB 75 72 62 6F
CEBF 20 76 65 72
CEC3 73 69 6F 6E
CEC7 20
CEC8 31 2E          	DB	030H + VER_1, '.'
CECA 34 37          	DB	030H + VER_2 ,030H + VER_3
CECC 20 47 61 6B    	DB	' Gaku',0DH,0AH
CED0 75 0D 0A
CED3 00             	DB	0
CED4                
CED4                _C8025H:
CED4 6B 50 59 88    	DB	06BH,050H,059H,088H,01BH,001H,019H,01AH
CED8 1B 01 19 1A
CEDC 00 0F          	DB	000H,00FH
CEDE 80 F8 B0 FF    	DW	0-80*LINE,0-80
CEE2 0C 23          	DB	00CH,023H
CEE4                
CEE4 03 0C 0F 30    TEXTDT:	DB	003H,00CH,00FH,030H,033H,03CH,03FH
CEE8 33 3C 3F
CEEB                
CEEB                SIODATA:
CEEB 18             	DB	018H
CEEC 01 00          	DB	1,0
CEEE 02 00          	DB	2,0
CEF0 03 C1          	DB	3,0C1H
CEF2 04 44          	DB	4,044H
CEF4 05 E8          	DB	5,0E8H
CEF6 FF             	DB	0FFH
CEF7                
CEF7                ;	ノンターボ用パッチ
CEF7                
CEF7                AT_SCR1:
CEF7 D9             	EXX
CEF8 C5             	PUSH	BC
CEF9 ED 4B B1 EF    	LD	BC,(_WIDTH)
CEFD 06 20          	LD	B,020H
CEFF D9             	EXX
CF00 C5             	PUSH	BC
CF01 01 00 20       	LD	BC,02000H
CF04                
CF04 67             	LD	H,A
CF05 B7             	OR	A
CF06                AT_SCRUP1:
CF06 28 15          	JR	Z,AT_SCRCL
CF08 C5             	PUSH	BC
CF09 CB E0          	SET	4,B
CF0B D9             	EXX
CF0C C5             	PUSH	BC
CF0D CB E0          	SET	4,B
CF0F D9             	EXX
CF10 CD 81 DF       	CALL	AT_UPSUB+AT_RS
CF13 D9             	EXX
CF14 C1             	POP	BC
CF15 D9             	EXX
CF16 C1             	POP	BC
CF17 CD 81 DF       	CALL	AT_UPSUB+AT_RS
CF1A 25             	DEC	H
CF1B 18 E9          	JR	AT_SCRUP1
CF1D                
CF1D                AT_SCRCL:
CF1D 2A B1 EF       	LD	HL,(_WIDTH)
CF20 CD 17 DE       	CALL	LINECL
CF23 C1             	POP	BC
CF24 D9             	EXX
CF25 C1             	POP	BC
CF26 D9             	EXX
CF27 C9             	RET
CF28                
CF28                AT_UPSUB:
CF28 3A B1 EF       	LD	A,(_WIDTH)
CF2B 6F             	LD	L,A
CF2C                AT_UPSUB1:
CF2C D9             	EXX
CF2D ED 78          	IN	A,(C)
CF2F 03             	INC	BC
CF30 D9             	EXX
CF31 ED 79          	OUT	(C),A
CF33 03             	INC	BC
CF34 2D             	DEC	L
CF35 20 F5          	JR	NZ,AT_UPSUB1
CF37 C9             	RET
CF38                
CF38                ;	FLOPPY DISK DRIVER(CPU)
CF38                
CF38                DISKC:
CF38 1B             	DEC	DE
CF39 CB 5F          	BIT	3,A
CF3B C4 64 EE       	CALL	NZ,RNF
CF3E                DISKD:
CF3E E5             	PUSH	HL
CF3F 21 6A EE       	LD	HL,RETRY
CF42 35             	DEC	(HL)
CF43 E1             	POP	HL
CF44 20 0C          	JR	NZ,AT_ERR		;Retry
CF46 B7             	OR	A
CF47 28 09          	JR	Z,AT_ERR		;Error
CF49                
CF49                AT_DELP:
CF49 CD 64 EE       	CALL	RNF
CF4C CD 40 EE       	CALL	FDMOFF
CF4F 3E FF          	LD	A,0FFH
CF51                AT_ERRZ:
CF51 BF             	CP	A
CF52                AT_ERR:
CF52 3E FF          	LD	A,0FFH
CF54 C9             	RET
CF55                ERRW:
CF55 3E FF          	LD	A,0FFH
CF57 BF             	CP	A
CF58 37             	SCF
CF59 C3 40 EE       	JP	FDMOFF
CF5C                
CF5C                ERRDW:
CF5C D1             	POP	DE
CF5D CD A2 DF       	CALL	AT_DELP+AT_RS
CF60 C2 79 EE       	JP	NZ,DWT0+AT_R
CF63 B7             	OR	A
CF64 20 EF          	JR	NZ,ERRW
CF66 C9             	RET
CF67                
CF67                ERRDR:
CF67 D1             	POP	DE
CF68 CD A2 DF       	CALL	AT_DELP+AT_RS
CF6B C2 C2 EE       	JP	NZ,DRD0+AT_R
CF6E B7             	OR	A
CF6F 20 E4          	JR	NZ,ERRW
CF71 C9             	RET
CF72                
CF72                AT_WTTRK:
CF72 06 01          	LD	B,1
CF74 3E F4          	LD	A,0F4H
CF76 C3 6D EE       	JP	AT_WTTRK1+AT_R
CF79                
CF79                AT_SCRN:
CF79 ED 78          	IN	A,(C)
CF7B C9             	RET
CF7C                AT_SCRE:
CF7C                
CF7C                AT_DWT:
CF7C 3E A0          	LD	A,0A0H
CF7E                AT_WTTRK1:
CF7E 32 08 EE       	LD	(FDCPAT+1),A
CF81                DWTBL:
CF81 78             	LD	A,B
CF82 32 B0 EE       	LD	(AT_WTB+1+AT_R),A
CF85 3E 02          	LD	A,2		;Retry count
CF87 32 6A EE       	LD	(RETRY),A
CF8A                
CF8A                DWT0:
CF8A D5             	PUSH	DE
CF8B E5             	PUSH	HL
CF8C CD A7 ED       	CALL	SEEK		;Write disk
CF8F E1             	POP	HL
CF90 DA B5 DF       	JP	C,ERRDW+AT_RS
CF93 F3             	DI
CF94 3A 08 EE       	LD	A,(FDCPAT+1)
CF97 CD 4C EE       	CALL	SECSET
CF9A 0E FB          	LD	C,0FBH
CF9C                
CF9C                DWT1:
CF9C 56             	LD	D,(HL)
CF9D                DWT2:
CF9D 78             	LD	A,B
CF9E DB F8          	IN	A,(0F8H)
CFA0 0F             	RRCA
CFA1 30 08          	JR	NC,DWT4
CFA3 0F             	RRCA
CFA4 30 F7          	JR	NC,DWT2
CFA6                DWT3:
CFA6 ED 51          	OUT	(C),D
CFA8 23             	INC	HL
CFA9 18 F1          	JR	DWT1
CFAB                
CFAB                DWT4:
CFAB 3D             	DEC	A
CFAC 28 F8          	JR	Z,DWT3
CFAE 3C             	INC	A
CFAF FB             	EI
CFB0 D1             	POP	DE
CFB1 13             	INC	DE
CFB2 CD 40 EE       	CALL	FDMOFF
CFB5 28 09          	JR	Z,DISKOK_WT
CFB7 CD 91 DF       	CALL	DISKC+AT_RS
CFBA 20 CE          	JR	NZ,DWT0
CFBC B7             	OR	A
CFBD C2 AE DF       	JP	NZ,ERRW+AT_RS
CFC0                
CFC0                DISKOK_WT:
CFC0 06 01          AT_WTB:	LD	B,1
CFC2 10 BD          	DJNZ	DWTBL
CFC4 C9             	RET
CFC5                
CFC5                AT_DRD:
CFC5 3E 80          	LD	A,080H
CFC7 32 08 EE       	LD	(FDCPAT+1),A
CFCA                DRDBL:
CFCA 78             	LD	A,B
CFCB 32 F5 EE       	LD	(AT_RDB+1+AT_R),A
CFCE 3E 02          	LD	A,2		;Retry count
CFD0 32 6A EE       	LD	(RETRY),A
CFD3                DRD0:
CFD3 D5             	PUSH	DE
CFD4 E5             	PUSH	HL
CFD5 CD A7 ED       	CALL	SEEK		;Read disk
CFD8 E1             	POP	HL
CFD9 DA C0 DF       	JP	C,ERRDR+AT_RS
CFDC F3             	DI
CFDD 3A 08 EE       	LD	A,(FDCPAT+1)
CFE0 CD 4C EE       	CALL	SECSET
CFE3 0E FB          	LD	C,0FBH
CFE5                DRD1:
CFE5 78             	LD	A,B
CFE6 DB F8          	IN	A,(0F8H)
CFE8 0F             	RRCA
CFE9 30 08          	JR	NC,DRD3
CFEB 0F             	RRCA
CFEC 30 F7          	JR	NC,DRD1
CFEE ED A2          	INI
CFF0 04             	INC	B
CFF1 18 F2          	JR	DRD1
CFF3                
CFF3                DRD3:
CFF3 B7             	OR	A
CFF4 FB             	EI
CFF5 D1             	POP	DE
CFF6 13             	INC	DE
CFF7 CD 40 EE       	CALL	FDMOFF
CFFA 28 09          	JR	Z,DISKOK_RD
CFFC CD 91 DF       	CALL	DISKC+AT_RS
CFFF 20 D2          	JR	NZ,DRD0
D001 B7             	OR	A
D002 C2 AE DF       	JP	NZ,ERRW+AT_RS
D005                
D005                DISKOK_RD:
D005 06 01          AT_RDB:	LD	B,1
D007 10 C1          	DJNZ	DRDBL
D009 C9             	RET
D00A                
D00A                AT_CPUE:
D00A                
D00A                
D00A                ;	EMM DRIVER(CPU)
D00A                
D00A                
D00A                AT_EDWT:
D00A CD 91 D7       	CALL	AT_EADR+AT_RE
D00D                AT_EDWT0:
D00D F5             	PUSH	AF
D00E AF             	XOR	A
D00F                AT_EDWT1:
D00F 04             	INC	B
D010 ED A3          	OUTI
D012 04             	INC	B
D013 ED A3          	OUTI
D015 3D             	DEC	A
D016 20 F7          	JR	NZ,AT_EDWT1
D018 13             	INC	DE
D019 F1             	POP	AF
D01A 3D             	DEC	A
D01B 20 F0          	JR	NZ,AT_EDWT0
D01D C9             	RET
D01E                
D01E                AT_EDRD:
D01E CD 91 D7       	CALL	AT_EADR+AT_RE
D021                AT_EDRD0:
D021 F5             	PUSH	AF
D022 AF             	XOR	A
D023                AT_EDRD1:
D023 ED A2          	INI
D025 04             	INC	B
D026 ED A2          	INI
D028 04             	INC	B
D029 3D             	DEC	A
D02A 20 F7          	JR	NZ,AT_EDRD1
D02C 13             	INC	DE
D02D F1             	POP	AF
D02E 3D             	DEC	A
D02F 20 F0          	JR	NZ,AT_EDRD0
D031 C9             	RET
D032                
D032                AT_EADR:
D032 C5             	PUSH	BC
D033 D5             	PUSH	DE
D034 EB             	EX	DE,HL
D035 29             	ADD	HL,HL
D036 DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
D039 DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
D03C 09             	ADD	HL,BC
D03D DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
D040 06 0D          	LD	B,00DH
D042 ED 49          	OUT	(C),C
D044 0C             	INC	C
D045 ED 69          	OUT	(C),L
D047 0C             	INC	C
D048 ED 61          	OUT	(C),H
D04A 0C             	INC	C
D04B EB             	EX	DE,HL
D04C D1             	POP	DE
D04D F1             	POP	AF
D04E A7             	AND	A	;CF=0
D04F C9             	RET
D050                AT_EMME:
D050                
D050                AT_TRAP38:
D050 21 00 00       	LD	HL,0
D053 E3             	EX	(SP),HL
D054 3E 24          	LD	A,'$'
D056 CD A3 DB       	CALL	MSG_A
D059 2B             	DEC	HL
D05A 7C             	LD	A,H
D05B CD E8 FF       	CALL	PRHX+AT_RT
D05E 7D             	LD	A,L
D05F                PRHX:
D05F F5             	PUSH	AF
D060 07             	RLCA
D061 07             	RLCA
D062 07             	RLCA
D063 07             	RLCA
D064 CD F1 FF       	CALL	PRHX2+AT_RT
D067 F1             	POP	AF
D068                PRHX2:
D068 E6 0F          	AND	00FH
D06A FE 0A          	CP	10
D06C 3F             	CCF
D06D CE 30          	ADC	A,'0'
D06F 27             	DAA
D070 C3 A3 DB       	JP	MSG_A
D073                	DS	4
D077                AT_TRAPE:
D077                
D077 00 00 2F 89    AT_RT	EQU	TRAP38-AT_TRAP38
D077                
D077                INITE:
D077                	DS	BDOS-INITE
D106                
D106 C3 B4 D7       	JP	BDOS0
D109                	INCLUDE	"X1CCP.ASM"
D109                
D109                ;	LSX-Dodgers CCP
D109                ;	X1/turbo/Z
D109                
D109                WBOOT1:
D109 F3             	DI
D10A ED 7B 06 00    	LD	SP,(SYSTEM+1)
D10E                
D10E 3E EF          	LD	A,INTVEC/256
D110 ED 47          	LD	I,A
D112                
D112 3E E4          	LD	A,0E4H
D114 CD C6 DE       	CALL	COMOUT
D117 3E C8          	LD	A,INTVEC
D119 CD A0 DE       	CALL	OT49SB
D11C                
D11C 21 B0 EF       	LD	HL,CRTCD
D11F AF             	XOR	A
D120                SETCRT2:
D120 01 00 18       	LD	BC,01800H
D123 ED 79          	OUT	(C),A
D125 0C             	INC	C
D126 56             	LD	D,(HL)
D127 FE 0D          	CP	13
D129 38 02          	JR	C,SETCRT3
D12B 16 00          	LD	D,0
D12D                SETCRT3:
D12D ED 51          	OUT	(C),D
D12F 23             	INC	HL
D130 3C             	INC	A
D131 FE 0E          	CP	14
D133 20 EB          	JR	NZ,SETCRT2
D135                
D135 01 03 1B       	LD	BC,01A03H+00100H
D138 ED A3          	OUTI
D13A 01 D0 20       	LD	BC,01FD0H+00100H
D13D ED A3          	OUTI
D13F 21 92 EF       	LD	HL,_KEYD
D142 7E             	LD	A,(HL)
D143 36 00          	LD	(HL),0
D145 CD 8D DB       	CALL	KEYBC_IFBREAK
D148 3E 04          	LD	A,4
D14A CD A3 DB       	CALL	MSG_A
D14D                	INCLUDE	"LDCCP.ASM"
D14D                
D14D                ;	LSX-Dodgers CCP
D14D                
D14D                COMMAND:
D14D CD 00 D2       	CALL	SETDTA1
D150 3A 87 EF       	LD	A,(_DVSW)
D153 C6 41          	ADD	A,'A'
D155 CD A3 DB       	CALL	MSG_A
D158 3E 3E          	LD	A,'>'
D15A CD A3 DB       	CALL	MSG_A
D15D 3E 50          	LD	A,80
D15F 12             	LD	(DE),A
D160 CD F2 DB       	CALL	_SYS0A		;(BDOS)文字列入力
D163 CD AA D3       	CALL	LTNL
D166                
D166 11 82 00       	LD	DE,DTA1+2
D169 CD FD EF       	CALL	_COMANL
D16C 30 DF          	JR	NC,COMMAND
D16E 11 79 EF       	LD	DE,COMERM
D171 CD FE D7       	CALL	_SYS09		;(BDOS)文字列出力
D174 C7             	RST	0
D175                
D175                COMANL:
D175 CD 72 E0       	CALL	FILE
D178 3A 19 EF       	LD	A,(FNAME+4)
D17B FE 20          	CP	020H
D17D 20 1C          	JR	NZ,COMB2
D17F D5             	PUSH	DE
D180 11 15 EF       	LD	DE,FNAME
D183 1A             	LD	A,(DE)
D184 FE 20          	CP	020H
D186 28 44          	JR	Z,SDVSW
D188 1B             	DEC	DE
D189 1A             	LD	A,(DE)
D18A C6 FF          	ADD	A,0FFH
D18C 38 09          	JR	C,COMB
D18E 13             	INC	DE
D18F                
D18F 21 8B D6       	LD	HL,COMTB
D192 06 09          	LD	B,COMS
D194 CD F6 E2       	CALL	CPNAME
D197                COMB:
D197 D1             	POP	DE
D198 D2 0F 00       	JP	NC,JP_HL
D19B                COMB2:
D19B EB             	EX	DE,HL
D19C 22 74 D2       	LD	(COMPAT+1),HL
D19F F5             	PUSH	AF
D1A0 CD 20 D2       	CALL	CEXE4
D1A3 F1             	POP	AF
D1A4 21 15 EF       	LD	HL,FNAME
D1A7 11 6D 00       	LD	DE,FCB2+1	;COMMAND NAME
D1AA 01 0B 00       	LD	BC,11
D1AD ED B0          	LDIR
D1AF 11 2E D6       	LD	DE,PATHD
D1B2                CEX1:
D1B2 1A             	LD	A,(DE)
D1B3 FE 20          	CP	020H
D1B5 D8             	RET	C
D1B6 CD 67 E0       	CALL	FILEC
D1B9 D5             	PUSH	DE
D1BA 21 6D 00       	LD	HL,FCB2+1	;COMMAND NAME
D1BD 11 15 EF       	LD	DE,FNAME
D1C0 01 0B 00       	LD	BC,11
D1C3 ED B0          	LDIR
D1C5 CD 20 D2       	CALL	CEXE4
D1C8 D1             	POP	DE
D1C9 13             	INC	DE
D1CA 18 E6          	JR	CEX1
D1CC                
D1CC                SDVSW:
D1CC F1             	POP	AF
D1CD 3A 14 EF       	LD	A,(FDRV)
D1D0 3D             	DEC	A
D1D1 5F             	LD	E,A
D1D2 0E 0E          	LD	C,00EH		;(BDOS)カレントドライブの設定
D1D4 18 31          	JR	SYSTEM0
D1D6                
D1D6                OPEN1:
D1D6 21 14 EF       	LD	HL,FDRV
D1D9                OPEN:
D1D9 0E 11          	LD	C,011H		;(BDOS)ファイルの検索
D1DB                OPEN3:
D1DB D5             	PUSH	DE
D1DC 11 09 D6       	LD	DE,DTA_CCP
D1DF CD FD D1       	CALL	SETDTA
D1E2 EB             	EX	DE,HL
D1E3 CD 07 D2       	CALL	SYSTEM0
D1E6 D1             	POP	DE
D1E7 C9             	RET
D1E8                
D1E8                OPEN2:
D1E8 0E 12          	LD	C,012H
D1EA 18 EF          	JR	OPEN3
D1EC                
D1EC                DEFCB:				;Z=Ok NZ=Error
D1EC 11 09 D6       	LD	DE,DTA_CCP
D1EF CD 05 D2       	CALL	SYSC0F
D1F2                
D1F2 11 2A D6       	LD	DE,DTA_CCP+33	;(FCB)ランダムレコード
D1F5 06 04          	LD	B,4
D1F7 CD E8 D4       	CALL	ZERO_MEMORY_DE
D1FA 11 00 01       	LD	DE,00100H
D1FD                SETDTA:
D1FD C3 FC D9       	JP	_SYS1A		;(BDOS)DTAの設定
D200                
D200                SETDTA1:
D200 11 80 00       	LD	DE,DTA1
D203 18 F8          	JR	SETDTA
D205                
D205                SYSC0F:
D205 0E 0F          	LD	C,00FH		;(BDOS)ファイルのオープン
D207                SYSTEM0:
D207 CD 05 00       	CALL	SYSTEM
D20A B7             	OR	A
D20B C9             	RET
D20C                
D20C                C_CD:
D20C 0E 5A          	LD	C,5AH
D20E 18 F7          	JR	SYSTEM0
D210                
D210                S27BUF:
D210 3A 07 00       	LD	A,(SYSTEM+2)
D213 3D             	DEC	A
D214 E6 F8          	AND	0F8H
D216 67             	LD	H,A
D217 2E 00          	LD	L,0
D219                S27DTA:
D219 11 09 D6       	LD	DE,DTA_CCP
D21C                S27:
D21C 0E 27          	LD	C,027H		;(BDOS)ランダムブロック読み込み
D21E 18 E7          	JR	SYSTEM0
D220                
D220                CEXE4:
D220 3A 14 EF       	LD	A,(FDRV)
D223 32 57 00       	LD	(00057H),A
D226 2A 22 EF       	LD	HL,(FDRV+14)
D229 22 58 00       	LD	(00058H),HL
D22C                
D22C 21 1D EF       	LD	HL,FNAME+8
D22F 7E             	LD	A,(HL)
D230 FE 20          	CP	020H
D232 20 07          	JR	NZ,CEXE7
D234 3E 3F          	LD	A,'?'
D236 77             	LD	(HL),A
D237 23             	INC	HL
D238 77             	LD	(HL),A
D239 23             	INC	HL
D23A 77             	LD	(HL),A
D23B                CEXE7:
D23B CD D6 D1       	CALL	OPEN1
D23E                CEXE5:
D23E C0             	RET	NZ
D23F 2A 13 D6       	LD	HL,(DTA_CCP+1+9)
D242 7C             	LD	A,H
D243 CD 7E E3       	CALL	CAP
D246 67             	LD	H,A
D247 7D             	LD	A,L
D248 CD 7E E3       	CALL	CAP
D24B 6F             	LD	L,A
D24C 3A 12 D6       	LD	A,(DTA_CCP+1+8)
D24F CD 7E E3       	CALL	CAP
D252 D6 42          	SUB	'B'
D254 28 2C          	JR	Z,C_BAT
D256 3D             	DEC	A		;'C'
D257 28 05          	JR	Z,C_EXE
D259                CEXE6:
D259 CD E8 D1       	CALL	OPEN2
D25C 18 E0          	JR	CEXE5
D25E                
D25E                C_EXE:
D25E 7C             	LD	A,H
D25F FE 4D          	CP	'M'
D261 20 F6          	JR	NZ,CEXE6
D263                
D263 CD EC D1       	CALL	DEFCB
D266 CD 10 D2       	CALL	S27BUF
D269 3D             	DEC	A
D26A 37             	SCF
D26B C0             	RET	NZ
D26C 7C             	LD	A,H
D26D B5             	OR	L
D26E 37             	SCF
D26F C8             	RET	Z
D270 CD 00 D2       	CALL	SETDTA1
D273 11 00 00       COMPAT:	LD	DE,0				; self-modifying code
D276 ED 7B 06 00    	LD	SP,(SYSTEM+1)
D27A 67             	LD	H,A				; A=0 in SETDTA1(_SYS1A)
D27B 6F             	LD	L,A
D27C E5             	PUSH	HL				; push $0000 (reboot address)
D27D 24             	INC	H
D27E E5             	PUSH	HL				; push $0100 (TPA address)
D27F C3 B3 D4       	JP	SETFCB				; and JP $0100
D282                
D282                C_BAT:
D282 11 41 54       	LD	DE,'A'+'T'*256
D285 ED 52          	SBC	HL,DE
D287 20 D0          	JR	NZ,CEXE6
D289                
D289 F1             	POP	AF
D28A F1             	POP	AF
D28B CD EC D1       	CALL	DEFCB
D28E 21 00 02       	LD	HL,00200H
D291 CD 19 D2       	CALL	S27DTA
D294 C6 FE          	ADD	A,0FEH
D296 D8             	RET	C
D297 7D             	LD	A,L
D298 B7             	OR	A
D299 37             	SCF
D29A C8             	RET	Z
D29B 3C             	INC	A
D29C F5             	PUSH	AF
D29D                
D29D CD 90 DB       	CALL	KEYBC
D2A0 3E 06          	LD	A,6
D2A2 CD A3 DB       	CALL	MSG_A
D2A5 C1             	POP	BC
D2A6 21 00 01       	LD	HL,00100H
D2A9                BAT1:
D2A9 A7             	AND	A
D2AA 05             	DEC	B
D2AB C8             	RET	Z
D2AC 7E             	LD	A,(HL)
D2AD FE 25          	CP	'%'
D2AF 28 0C          	JR	Z,BAT2
D2B1                BAT1X:
D2B1 7E             	LD	A,(HL)
D2B2 23             	INC	HL
D2B3 FE 1A          	CP	01AH
D2B5 C8             	RET	Z
D2B6 FE 0A          	CP	00AH
D2B8 C4 75 DB       	CALL	NZ,KEYBS
D2BB 18 EC          	JR	BAT1
D2BD                
D2BD                BAT2:
D2BD 23             	INC	HL
D2BE 7E             	LD	A,(HL)
D2BF 2B             	DEC	HL
D2C0 D6 31          	SUB	'1'
D2C2 38 ED          	JR	C,BAT1X
D2C4 FE 09          	CP	9
D2C6 30 E9          	JR	NC,BAT1X
D2C8 23             	INC	HL
D2C9 23             	INC	HL
D2CA 3C             	INC	A
D2CB 4F             	LD	C,A
D2CC ED 5B 74 D2    	LD	DE,(COMPAT+1)
D2D0                BAT3:
D2D0 1A             	LD	A,(DE)
D2D1 B7             	OR	A
D2D2 28 D5          	JR	Z,BAT1
D2D4 CD 49 E1       	CALL	SPCUT
D2D7 0D             	DEC	C
D2D8 28 08          	JR	Z,BAT5
D2DA                BAT4:
D2DA 1A             	LD	A,(DE)
D2DB FE 21          	CP	021H
D2DD 38 F1          	JR	C,BAT3
D2DF 13             	INC	DE
D2E0 18 F8          	JR	BAT4
D2E2                BAT5:
D2E2 1A             	LD	A,(DE)
D2E3 FE 21          	CP	021H
D2E5 38 C2          	JR	C,BAT1
D2E7 13             	INC	DE
D2E8 CD 75 DB       	CALL	KEYBS
D2EB 18 F5          	JR	BAT5
D2ED                
D2ED                C_DEL:
D2ED CD B3 D4       	CALL	SETFCB
D2F0 CD B9 DB       	CALL	_SYS08		;(BDOS)エコーなしコンソール入力
D2F3                
D2F3 0E 13          	LD	C,013H
D2F5 18 0A          	JR	CDEL1		;(BDOS)ファイルの削除
D2F7                
D2F7                C_REN:
D2F7 CD B3 D4       	CALL	SETFCB
D2FA 3E 10          	LD	A,010H		;ディレクトリも対象にする
D2FC 32 69 00       	LD	(FCB1+13),A	;属性
D2FF 0E 17          	LD	C,017H		;(BDOS)ファイル名の変更
D301                CDEL1:
D301 11 5C 00       	LD	DE,FCB1
D304 CD 05 00       	CALL	SYSTEM
D307 C6 FF          	ADD	A,0FFH
D309 C9             	RET
D30A                
D30A                C_DIR:
D30A CD 67 E0       	CALL	FILEC
D30D 21 15 EF       	LD	HL,FDRV+1
D310 CD FE D5       	CALL	CWILD1
D313 3E F1          	LD	A,0F1H
D315 32 21 EF       	LD	(FDRV+13),A
D318 CD D6 D1       	CALL	OPEN1
D31B                CDIR1:
D31B B7             	OR	A
D31C 20 08          	JR	NZ,PDSKF
D31E CD 69 D3       	CALL	P_NAME
D321 CD E8 D1       	CALL	OPEN2
D324 18 F5          	JR	CDIR1
D326                
D326                PDSKF:
D326 3A 14 EF       	LD	A,(FDRV)
D329 5F             	LD	E,A
D32A 0E 1B          	LD	C,01BH		;(BDOS)ディスク情報の獲得
D32C CD 05 00       	CALL	SYSTEM
D32F 4F             	LD	C,A		;C←1クラスタ辺りの論理セクタ数
D330 C6 01          	ADD	A,001H
D332 D8             	RET	C		;Aが0FFHだった場合
D333 3E 06          	LD	A,8-2
D335                PDS1:				;HL=未使用クラスタの総数
D335 3C             	INC	A
D336 CB 19          	RR	C
D338 30 FB          	JR	NC,PDS1
D33A                PDS2:				;B←論理セクタのサイズの上位8ビット
D33A 3C             	INC	A
D33B CB 18          	RR	B
D33D 30 FB          	JR	NC,PDS2
D33F 47             	LD	B,A
D340                
D340 11 00 00       	LD	DE,0
D343                PDS3:
D343 29             	ADD	HL,HL
D344 EB             	EX	DE,HL
D345 ED 6A          	ADC	HL,HL
D347 EB             	EX	DE,HL
D348 10 F9          	DJNZ	PDS3
D34A                PDSKF1:
D34A CD E2 D3       	CALL	PRDEC_DEHL
D34D 11 6F D6       	LD	DE,FREE
D350 CD FE D7       	CALL	_SYS09		;(BDOS)文字列出力
D353 CD D1 D3       	CALL	PUTDRV
D356 3E 5C          	LD	A,05CH		;\
D358 CD A3 DB       	CALL	MSG_A
D35B 2A 22 EF       	LD	HL,(FDRV+14)	;ディレクトリのクラスタ番号
D35E AF             	XOR	A
D35F 11 FE FF       	LD	DE,0-2
D362 19             	ADD	HL,DE
D363 23             	INC	HL
D364 DC DE D3       	CALL	C,PRDEC_HL
D367 18 41          	JR	LTNL
D369                
D369                P_NAME:
D369 3A 0A D6       	LD	A,(DTA_CCP+1)
D36C FE 2E          	CP	'.'
D36E C8             	RET	Z
D36F 11 87 D6       	LD	DE,DIRHD
D372 CD FE D7       	CALL	_SYS09		;(BDOS)文字列出力
D375 3A 15 D6       	LD	A,(DTA_CCP+1+00BH)
D378 F5             	PUSH	AF
D379 0F             	RRCA
D37A 9F             	SBC	A,A
D37B E6 0A          	AND	'*'-020H
D37D C6 20          	ADD	A,020H
D37F CD A3 DB       	CALL	MSG_A
D382 CD D1 D3       	CALL	PUTDRV
D385 21 0A D6       	LD	HL,DTA_CCP+1
D388 CD 22 D4       	CALL	FPRNT
D38B                
D38B F1             	POP	AF
D38C CB 67          	BIT	4,A
D38E 28 08          	JR	Z,DIR3
D390 11 7C D6       	LD	DE,DIRMES
D393 CD FE D7       	CALL	_SYS09		;(BDOS)文字列出力
D396 18 0A          	JR	DIR6
D398                DIR3:
D398 ED 5B 28 D6    	LD	DE,(DTA_CCP+1+01EH)
D39C 2A 26 D6       	LD	HL,(DTA_CCP+1+01CH)
D39F CD E2 D3       	CALL	PRDEC_DEHL
D3A2                DIR6:
D3A2 3A B1 EF       	LD	A,(_WIDTH)
D3A5 FE 29          	CP	40+1
D3A7 D4 44 D4       	CALL	NC,PRTTMS
D3AA                
D3AA                LTNL:
D3AA 1E 03          	LD	E,3
D3AC C3 CD EF       	JP	_PRINT
D3AF                
D3AF                C_PATH:
D3AF CD 49 E1       	CALL	SPCUT
D3B2 21 2E D6       	LD	HL,PATHD
D3B5 FE 21          	CP	021H
D3B7 30 0C          	JR	NC,CPATH0
D3B9                CPATHP:
D3B9 7E             	LD	A,(HL)
D3BA 23             	INC	HL
D3BB FE 20          	CP	020H
D3BD 3F             	CCF
D3BE 30 EA          	JR	NC,LTNL
D3C0 CD A3 DB       	CALL	MSG_A
D3C3 18 F4          	JR	CPATHP
D3C5                CPATH0:
D3C5 FE 3B          	CP	';'
D3C7 20 01          	JR	NZ,CPATH1
D3C9 13             	INC	DE
D3CA                CPATH1:
D3CA EB             	EX	DE,HL
D3CB 01 40 00       	LD	BC,PATHX
D3CE ED B0          	LDIR
D3D0 C9             	RET
D3D1                
D3D1                PUTDRV:
D3D1 3A 14 EF       	LD	A,(FDRV)
D3D4 C6 40          	ADD	A,'A'-1
D3D6 CD A3 DB       	CALL	MSG_A
D3D9 3E 3A          	LD	A,':'
D3DB                MSG_AR:
D3DB C3 A3 DB       	JP	MSG_A
D3DE                
D3DE                PRDEC_HL:
D3DE AF             	XOR	A
D3DF                PRDEC_AHL:
D3DF 5F             	LD	E,A
D3E0 16 00          	LD	D,0
D3E2                PRDEC_DEHL:
D3E2 D5             	PUSH	DE
D3E3 11 0F EF       	LD	DE,DECBF
D3E6 06 05          	LD	B,5
D3E8 CD E8 D4       	CALL	ZERO_MEMORY_DE	;A=0
D3EB D1             	POP	DE
D3EC                
D3EC 0E 20          	LD	C,32
D3EE                DEC1:
D3EE 29             	ADD	HL,HL
D3EF EB             	EX	DE,HL
D3F0 ED 6A          	ADC	HL,HL
D3F2 EB             	EX	DE,HL
D3F3 E5             	PUSH	HL
D3F4 21 13 EF       	LD	HL,DECBF+4
D3F7 06 05          	LD	B,5
D3F9                DEC2:
D3F9 7E             	LD	A,(HL)
D3FA 8F             	ADC	A,A
D3FB 27             	DAA
D3FC 77             	LD	(HL),A
D3FD 2B             	DEC	HL
D3FE 10 F9          	DJNZ	DEC2
D400 E1             	POP	HL
D401 0D             	DEC	C
D402 20 EA          	JR	NZ,DEC1
D404                
D404 21 0F EF       	LD	HL,DECBF
D407 3E 20          	LD	A,020H
D409 06 04          	LD	B,4
D40B                DEC3:
D40B CD 18 D4       	CALL	DEC4
D40E CD 18 D4       	CALL	DEC4
D411 23             	INC	HL
D412 10 F7          	DJNZ	DEC3
D414                DECX:
D414 CD 18 D4       	CALL	DEC4
D417 AF             	XOR	A
D418                DEC4:
D418 ED 6F          	RLD
D41A FE 20          	CP	020H
D41C 28 02          	JR	Z,DEC5
D41E F6 30          	OR	030H
D420                DEC5:
D420 18 B9          	JR	MSG_AR
D422                
D422                FPRNT:
D422 06 08          	LD	B,8
D424 CD 35 D4       	CALL	P_N1
D427 7E             	LD	A,(HL)
D428 C6 80          	ADD	A,0A0H-020H
D42A FE A0          	CP	0A0H
D42C 28 02          	JR	Z,FPR1
D42E 3E 2E          	LD	A,'.'
D430                FPR1:
D430 CD A3 DB       	CALL	MSG_A
D433 06 03          	LD	B,3
D435                
D435                P_N1:
D435 C5             	PUSH	BC
D436 E5             	PUSH	HL
D437 7E             	LD	A,(HL)
D438 CD 8A E3       	CALL	CAP3
D43B CD A3 DB       	CALL	MSG_A
D43E E1             	POP	HL
D43F C1             	POP	BC
D440 23             	INC	HL
D441 10 F2          	DJNZ	P_N1
D443 C9             	RET
D444                
D444                PRTTMS:
D444 3E 20          	LD	A,020H
D446 CD A3 DB       	CALL	MSG_A
D449                
D449 2A 22 D6       	LD	HL,(DTA_CCP+1+24)
D44C 7D             	LD	A,L
D44D B7             	OR	A
D44E C8             	RET	Z
D44F CB 3C          	SRL	H
D451 17             	RLA
D452 17             	RLA
D453 17             	RLA
D454 17             	RLA
D455 E6 0F          	AND	00FH
D457 57             	LD	D,A
D458 7C             	LD	A,H
D459 C6 50          	ADD	A,80
D45B CD 9E D4       	CALL	PRDEC_A
D45E 3E 2D          	LD	A,'-'
D460 CD A3 DB       	CALL	MSG_A
D463 7A             	LD	A,D
D464 CD 9E D4       	CALL	PRDEC_A
D467 3E 2D          	LD	A,'-'
D469 CD A3 DB       	CALL	MSG_A
D46C 7D             	LD	A,L
D46D E6 1F          	AND	01FH
D46F CD 9E D4       	CALL	PRDEC_A
D472                
D472 2A 20 D6       	LD	HL,(DTA_CCP+1+22)
D475                
D475 3E 20          	LD	A,020H
D477 CD A3 DB       	CALL	MSG_A
D47A 7C             	LD	A,H
D47B 65             	LD	H,L
D47C 06 03          	LD	B,3
D47E                PRTTMS1:
D47E 1F             	RRA
D47F CB 1D          	RR	L
D481 10 FB          	DJNZ	PRTTMS1
D483 E6 1F          	AND	01FH
D485 CD 9E D4       	CALL	PRDEC_A
D488 3E 3A          	LD	A,':'
D48A CD A3 DB       	CALL	MSG_A
D48D 7D             	LD	A,L
D48E 0F             	RRCA
D48F 0F             	RRCA
D490 E6 3F          	AND	03FH
D492 CD 9E D4       	CALL	PRDEC_A
D495 3E 3A          	LD	A,':'
D497 CD A3 DB       	CALL	MSG_A
D49A 7C             	LD	A,H
D49B E6 1F          	AND	01FH
D49D 87             	ADD	A,A
D49E                
D49E                ;	PRINT10
D49E                
D49E                PRDEC_A:
D49E E5             	PUSH	HL
D49F 06 08          	LD	B,8
D4A1 4F             	LD	C,A
D4A2 AF             	XOR	A
D4A3                PRTA1:
D4A3 CB 01          	RLC	C
D4A5 8F             	ADC	A,A
D4A6 27             	DAA
D4A7 10 FA          	DJNZ	PRTA1
D4A9 21 0F EF       	LD	HL,DECBF
D4AC 77             	LD	(HL),A
D4AD AF             	XOR	A
D4AE CD 14 D4       	CALL	DECX
D4B1 E1             	POP	HL
D4B2 C9             	RET
D4B3                
D4B3                SETFCB:
D4B3 CD 49 E1       	CALL	SPCUT
D4B6 1A             	LD	A,(DE)
D4B7 FE 20          	CP	020H
D4B9 38 01          	JR	C,SETFCBA
D4BB 1B             	DEC	DE
D4BC                SETFCBA:
D4BC 06 24          	LD	B,36
D4BE 21 5C 00       	LD	HL,FCB1
D4C1 E5             	PUSH	HL
D4C2 AF             	XOR	A
D4C3 CD 1E E1       	CALL	FILL_MEMORY
D4C6 E1             	POP	HL
D4C7 D5             	PUSH	DE
D4C8 CD 68 DA       	CALL	_SYS5C		;(BDOS)ファイル名の解析
D4CB 21 6C 00       	LD	HL,FCB2
D4CE CD 68 DA       	CALL	_SYS5C		;(BDOS)ファイル名の解析
D4D1 E1             	POP	HL
D4D2 01 00 50       	LD	BC,05000H
D4D5 11 81 00       	LD	DE,00081H
D4D8                SETFCB1:
D4D8 7E             	LD	A,(HL)
D4D9 23             	INC	HL
D4DA FE 20          	CP	020H
D4DC 38 05          	JR	C,SETFCB2
D4DE 12             	LD	(DE),A
D4DF 13             	INC	DE
D4E0 0C             	INC	C
D4E1 10 F5          	DJNZ	SETFCB1
D4E3                SETFCB2:
D4E3 79             	LD	A,C
D4E4 32 80 00       	LD	(DTA1),A
D4E7 04             	INC	B
D4E8                ZERO_MEMORY_DE:
D4E8 AF             	XOR	A
D4E9                FILL_MEMORY_DE:
D4E9 12             	LD	(DE),A
D4EA 13             	INC	DE
D4EB 10 FC          	DJNZ	FILL_MEMORY_DE
D4ED C9             	RET
D4EE                
D4EE                C_COPY:
D4EE CD B3 D4       	CALL	SETFCB
D4F1                
D4F1 11 61 EF       	LD	DE,ZERO
D4F4 CD 6A E0       	CALL	FILEC2
D4F7 21 6C 00       	LD	HL,FCB2
D4FA CD 6F DA       	CALL	S29X1
D4FD                
D4FD 3E 10          	LD	A,010H
D4FF 32 69 00       	LD	(FCB1+13),A
D502 21 6D 00       	LD	HL,FCB2+1
D505 CD FE D5       	CALL	CWILD1
D508                COPY0:
D508 CD FB D5       	CALL	CWILD
D50B 21 5C 00       	LD	HL,FCB1
D50E CD D9 D1       	CALL	OPEN
D511 37             	SCF
D512                COPY1:
D512 C0             	RET	NZ
D513 CD EC D1       	CALL	DEFCB
D516                
D516 3A 16 D6       	LD	A,(DTA_CCP+13)
D519 CB 67          	BIT	4,A
D51B 28 21          	JR	Z,COPY1A
D51D                
D51D 21 5D 00       	LD	HL,FCB1+1
D520 CD AD E4       	CALL	CHKWILD
D523 38 14          	JR	C,COPY9
D525                
D525 3E 20          	LD	A,020H
D527 32 5D 00       	LD	(FCB1+1),A
D52A 2A 23 D6       	LD	HL,(DTA_CCP+26)
D52D 23             	INC	HL
D52E 22 6A 00       	LD	(FCB1+14),HL
D531 18 D5          	JR	COPY0
D533                
D533                COPY8:
D533 CD FE D7       	CALL	_SYS09		;(BDOS)文字列出力
D536 CD AA D3       	CALL	LTNL
D539                COPY9:
D539 CD E8 D1       	CALL	OPEN2
D53C 18 D4          	JR	COPY1
D53E                
D53E                COPY1A:
D53E 21 6C 00       	LD	HL,FCB2
D541 11 14 EF       	LD	DE,FDRV
D544 01 0B D6       	LD	BC,DTA_CCP+2
D547 ED A0          	LDI
D549 3E 0B          	LD	A,11
D54B                COPY2:
D54B F5             	PUSH	AF
D54C 7E             	LD	A,(HL)
D54D FE 3F          	CP	'?'
D54F 20 01          	JR	NZ,COPY3
D551 0A             	LD	A,(BC)
D552                COPY3:
D552 12             	LD	(DE),A
D553 03             	INC	BC
D554 13             	INC	DE
D555 23             	INC	HL
D556 F1             	POP	AF
D557 3D             	DEC	A
D558 20 F1          	JR	NZ,COPY2
D55A 01 05 00       	LD	BC,16-11
D55D ED B0          	LDIR
D55F                PUTNAME:
D55F 21 5D 00       	LD	HL,FCB1+1
D562 CD AD E4       	CALL	CHKWILD
D565 30 0B          	JR	NC,PUTN1
D567 21 15 EF       	LD	HL,FDRV+1
D56A CD 22 D4       	CALL	FPRNT
D56D 3E 20          	LD	A,020H
D56F CD A3 DB       	CALL	MSG_A
D572                PUTN1:
D572 11 14 EF       	LD	DE,FDRV
D575 0E 16          	LD	C,016H		;(BDOS)ファイルの作成
D577 CD 07 D2       	CALL	SYSTEM0
D57A 20 48          	JR	NZ,COPYE2
D57C 67             	LD	H,A		;A=0
D57D 6F             	LD	L,A
D57E 22 35 EF       	LD	(FDRV+33),HL	;(FCB)ランダムレコード
D581 22 37 EF       	LD	(FDRV+35),HL
D584                COPY6:
D584 CD 10 D2       	CALL	S27BUF
D587 47             	LD	B,A
D588 3C             	INC	A
D589 28 31          	JR	Z,COPYE
D58B 7C             	LD	A,H
D58C B5             	OR	L
D58D 28 0C          	JR	Z,COPY7
D58F 11 14 EF       	LD	DE,FDRV
D592 0E 26          	LD	C,026H		;(BDOS)ランダムブロック書き込み
D594 CD 07 D2       	CALL	SYSTEM0
D597 20 23          	JR	NZ,COPYE
D599 10 E9          	DJNZ	COPY6
D59B                COPY7:
D59B 3A 16 D6       	LD	A,(DTA_CCP+13)	;(FCB)属性
D59E 32 21 EF       	LD	(FDRV+13),A
D5A1 21 1D D6       	LD	HL,DTA_CCP+20	;(FCB)タイムスタンプ
D5A4 11 28 EF       	LD	DE,FDRV+20
D5A7 01 04 00       	LD	BC,4
D5AA ED B0          	LDIR
D5AC                
D5AC 11 14 EF       	LD	DE,FDRV
D5AF 0E 10          	LD	C,010H		;(BDOS)ファイルのクローズ
D5B1 CD 07 D2       	CALL	SYSTEM0
D5B4 20 06          	JR	NZ,COPYE
D5B6                
D5B6 11 71 EF       	LD	DE,OK
D5B9 C3 33 D5       	JP	COPY8
D5BC                
D5BC                COPYE:
D5BC 11 14 EF       	LD	DE,FDRV
D5BF 0E 13          	LD	C,013H		;(BDOS)ファイルの削除
D5C1 CD 05 00       	CALL	SYSTEM
D5C4                COPYE2:
D5C4 37             	SCF
D5C5 C9             	RET
D5C6                
D5C6                C_TYPE:
D5C6 CD B3 D4       	CALL	SETFCB
D5C9 21 5C 00       	LD	HL,FCB1
D5CC CD D9 D1       	CALL	OPEN
D5CF 37             	SCF
D5D0                TYPE1:
D5D0 C0             	RET	NZ
D5D1 CD EC D1       	CALL	DEFCB
D5D4 3E 06          	LD	A,6
D5D6 CD A3 DB       	CALL	MSG_A
D5D9                TYPE2:
D5D9 CD 10 D2       	CALL	S27BUF
D5DC C6 FE          	ADD	A,0FEH
D5DE D8             	RET	C
D5DF 7C             	LD	A,H
D5E0 B5             	OR	L
D5E1 28 13          	JR	Z,TYPEE
D5E3 01 00 01       	LD	BC,00100H
D5E6                TYPE3:
D5E6 0A             	LD	A,(BC)
D5E7 03             	INC	BC
D5E8 FE 1A          	CP	01AH
D5EA 28 0A          	JR	Z,TYPEE
D5EC CD A3 DB       	CALL	MSG_A
D5EF 2B             	DEC	HL
D5F0 7C             	LD	A,H
D5F1 B5             	OR	L
D5F2 20 F2          	JR	NZ,TYPE3
D5F4 18 E3          	JR	TYPE2
D5F6                TYPEE:
D5F6 CD E8 D1       	CALL	OPEN2
D5F9 18 D5          	JR	TYPE1
D5FB                
D5FB                CWILD:
D5FB 21 5D 00       	LD	HL,FCB1+1
D5FE                CWILD1:
D5FE 7E             	LD	A,(HL)
D5FF FE 20          	CP	020H
D601 C0             	RET	NZ
D602                CWILD2:
D602 3E 3F          	LD	A,'?'
D604 06 0B          	LD	B,11
D606 C3 1E E1       	JP	FILL_MEMORY
D609                
D609                DTA_CCP:
D609                	DS	37
D62E                
D62E 00 00 00 40    PATHX	EQU	64
D62E                PATHD:	DS	PATHX
D66E 00             PATHE:	DB	0
D66F                
D66F 20 62 79 74    FREE:	DB	" bytes free",9,'$'
D673 65 73 20 66
D677 72 65 65 09
D67B 24
D67C 20 20 20 20    DIRMES:	DB	"     <DIR>$"
D680 20 3C 44 49
D684 52 3E 24
D687 20 20 3A 24    DIRHD:	DB	"  :$"
D68B                
D68B                COMTB:
D68B 44 20 20 20    	DB	"D   "	;1
D68F 0A D3          	DW	C_DIR
D691 44 49 52 20    	DB	"DIR "	;2
D695 0A D3          	DW	C_DIR
D697 43 4F 50 59    	DB	"COPY"	;3
D69B EE D4          	DW	C_COPY
D69D 43 44 20 20    	DB	"CD  "	;4
D6A1 0C D2          	DW	C_CD
D6A3 44 45 4C 20    	DB	"DEL "	;5
D6A7 ED D2          	DW	C_DEL
D6A9 50 41 54 48    	DB	"PATH"	;6
D6AD AF D3          	DW	C_PATH
D6AF 52 45 4E 20    	DB	"REN "	;7
D6B3 F7 D2          	DW	C_REN
D6B5 54 59 50 45    	DB	"TYPE"	;8
D6B9 C6 D5          	DW	C_TYPE
D6BB 52 45 4D 20    	DB	"REM "	;9
D6BF FB D7          	DW	C_REM
D6C1                	INCLUDE	"X1DISK2.ASM"
D6C1                
D6C1                ;	LSX-Dodgers DISK2
D6C1                ;	X1/turbo/Z
D6C1                
D6C1                ;	GRAPHIC RAM DISK DRIVER
D6C1                
D6C1                
D6C1                GDRD:
D6C1 C5             	PUSH	BC
D6C2 CD EA D6       	CALL	GADR
D6C5 F1             	POP	AF
D6C6                GDRD1:
D6C6 ED A2          	INI
D6C8 04             	INC	B
D6C9 0C             	INC	C
D6CA 20 FA          	JR	NZ,GDRD1
D6CC 04             	INC	B
D6CD 13             	INC	DE
D6CE 3D             	DEC	A
D6CF 20 F5          	JR	NZ,GDRD1
D6D1                GBANK0:
D6D1 3A BF EF       	LD	A,(WK1FD0)
D6D4 E6 EF          	AND	0EFH		;BANK0
D6D6 18 1D          	JR	S1FD0
D6D8                
D6D8                GDWT:
D6D8 C5             	PUSH	BC
D6D9 CD EA D6       	CALL	GADR
D6DC F1             	POP	AF
D6DD                GDWT1:
D6DD 04             	INC	B
D6DE ED A3          	OUTI
D6E0 0C             	INC	C
D6E1 20 FA          	JR	NZ,GDWT1
D6E3 04             	INC	B
D6E4 13             	INC	DE
D6E5 3D             	DEC	A
D6E6 20 F5          	JR	NZ,GDWT1
D6E8 18 E7          	JR	GBANK0
D6EA                
D6EA                GADR:
D6EA 0E 00          	LD	C,0
D6EC 7B             	LD	A,E
D6ED C6 40          	ADD	A,040H
D6EF 47             	LD	B,A
D6F0 3A BF EF       	LD	A,(WK1FD0)
D6F3 F6 10          	OR	010H		;BANK1
D6F5                S1FD0:
D6F5 C5             	PUSH	BC
D6F6 32 BF EF       	LD	(WK1FD0),A
D6F9 01 D0 1F       	LD	BC,01FD0H
D6FC ED 79          	OUT	(C),A
D6FE C1             	POP	BC
D6FF C9             	RET
D700                
D700                
D700                ;	BANK RAM DISK DRIVER
D700                
D700                BDWT:
D700 3E             	DB	03EH	;LD A,??
D701 37             	SCF
D702 18 02          	JR	BRW
D704                
D704                BDRD:
D704 3E             	DB	03EH	;LD A,??
D705 A7             	AND	A
D706                BRW:
D706 F3             	DI
D707 32 2F D7       	LD	(BRWPAT),A
D70A ED 73 4F D7    	LD	(BANKSP+1),SP
D70E 3A 50 D7       	LD	A,(BANKSP+2)
D711 87             	ADD	A,A
D712 38 03          	JR	C,BRW0
D714 31 CA FF       	LD	SP,EXTSP
D717                BRW0:
D717 D9             	EXX		;裏レジスタ
D718 C5             	 PUSH	 BC
D719 D5             	 PUSH	 DE
D71A 01 00 0B       	 LD	 BC,00B00H	 ;バンクメモリ
D71D 11 10 10       	 LD	 DE,01010H
D720 D9             	 EXX		;表レジスタ
D721                BRW1:
D721 C5             	PUSH	BC
D722 D5             	PUSH	DE
D723 EB             	EX	DE,HL
D724 29             	ADD	HL,HL
D725 29             	ADD	HL,HL
D726 7C             	LD	A,H
D727 E6 0F          	AND	00FH	;バンク
D729 65             	LD	H,L
D72A CB 3C          	SRL	H	;/2
D72C 2E 00          	LD	L,0
D72E D9             	EXX		;裏レジスタ
D72F A7             BRWPAT:	 AND	 A	;自己書き換え(AND A:読み出し/SCF:書き込み)
D730 38 08          	 JR	 C,BRWT
D732 57             	 LD	 D,A	 ;D=バンク
D733 D9             	 EXX		;表レジスタ
D734 EB             	EX	DE,HL
D735 CD 53 D7       	CALL	BTFR
D738 18 06          	JR	BRW2
D73A                BRWT:
D73A 5F             	 LD	E,A	 ;E=バンク
D73B D9             	 EXX		;表レジスタ
D73C CD 53 D7       	CALL	BTFR
D73F EB             	EX	DE,HL
D740                BRW2:
D740 D1             	POP	DE
D741 C1             	POP	BC
D742 13             	INC	DE
D743 10 DC          	DJNZ	BRW1
D745                
D745 D9             	EXX		;裏レジスタ
D746 3E 10          	 LD	 A,10H
D748 ED 79          	 OUT	 (C),A		;メインメモリに切り替える
D74A D1             	 POP	 DE
D74B C1             	 POP	 BC
D74C D9             	 EXX		;表レジスタ
D74D AF             	XOR	A
D74E 31 00 00       BANKSP:	LD	SP,0
D751 FB             	EI
D752 C9             	RET
D753                
D753                ;メインメモリ←→バンクメモリ 512バイトの転送を行う
D753                ; DE:転送元アドレス
D753                ; HL:転送先アドレス
D753                ; 裏BC:バンク切り替えポート(0B00H)
D753                ; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
D753                ; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
D753                
D753                BTFR:
D753 06 00          	LD	B,0	;256回ループ(256*2)
D755                BTFR1:
D755 D9             	EXX		;裏レジスタ
D756 ED 51          	 OUT	 (C),D	 ;BANK(MAIN)
D758 D9             	 EXX		;表レジスタ
D759 1A             	LD	A,(DE)
D75A 4F             	LD	C,A
D75B 13             	INC	DE
D75C 1A             	LD	A,(DE)
D75D 13             	INC	DE
D75E D9             	EXX		;裏レジスタ
D75F ED 59          	 OUT	 (C),E	 ;MAIN(BANK)
D761 D9             	 EXX		;表レジスタ
D762 71             	LD	(HL),C
D763 23             	INC	HL
D764 77             	LD	(HL),A
D765 23             	INC	HL
D766 10 ED          	DJNZ	BTFR1
D768 C9             	RET
D769                
D769                ;	EMM DRIVER(DMA)
D769                
D769                
D769                EDWT:
D769 0E 0F          	LD	C,15
D76B 18 02          	JR	EDWT1
D76D                EDRD:
D76D 0E 0E          	LD	C,14
D76F                EDWT1:
D76F C5             	PUSH	BC
D770 D5             	PUSH	DE
D771 22 B1 D7       	LD	(DMAB),HL
D774 78             	LD	A,B
D775 87             	ADD	A,A
D776 3D             	DEC	A
D777 32 AA D7       	LD	(DMALEN+1),A
D77A 3C             	INC	A
D77B 84             	ADD	A,H	;HL(アドレス)を先に進めておく
D77C 67             	LD	H,A
D77D EB             	EX	DE,HL
D77E 29             	ADD	HL,HL
D77F DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
D782 79             	LD	A,C
D783 DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
D786 09             	ADD	HL,BC
D787 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
D78A 06 0D          	LD	B,00DH
D78C ED 49          	OUT	(C),C
D78E 0C             	INC	C
D78F ED 69          	OUT	(C),L
D791 0C             	INC	C
D792 ED 61          	OUT	(C),H
D794                
D794 21 A5 D7       	LD	HL,EDMAD
D797 CD 7C DF       	CALL	SETDMA
D79A CD A4 DF       	CALL	GO_DMA
D79D EB             	EX	DE,HL
D79E D1             	POP	DE
D79F C1             	POP	BC
D7A0                DMA_ADD_SEC:
D7A0 13             	INC	DE
D7A1 10 FD          	DJNZ	DMA_ADD_SEC
D7A3 AF             	XOR	A
D7A4 C9             	RET
D7A5                
D7A5                EDMAD:
D7A5 C3             	DB	0C3H	;WR6 リセット
D7A6 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
D7A7 03 0D          	DW	00D03H	;ポートA開始アドレス EMMリード/ライト
D7A9 FF 01          DMALEN:	DW	001FFH	;ブロック長(転送サイズ-1)
D7AB 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
D7AC 50             	DB	050H	;WR2 ポートBアドレスインクリメント メモリ
D7AD 02             	DB	002H	;ポートBタイミング
D7AE 80             	DB	080H	;WR3
D7AF 9A             	DB	09AH	;WR5 WAIT RDY:HIGH
D7B0 AD             	DB	0ADH	;WR4 連続 ポートB開始アドレス
D7B1 00 00          DMAB:	DW	0
D7B3 01             	DB	001H	;WR0 ポートA←ポートB 転送
D7B4                EMME:
D7B4                
D7B4 00 00 07 5F    AT_RE	EQU	EDWT-AT_EDWT
D7B4                
D7B4                	INCLUDE	"LDOS.ASM"
D7B4                
D7B4                ;	LSX-Dodgers OS
D7B4                
D7B4                BDOS0:
D7B4 ED 73 C8 D7    	LD	(BDSP+1),SP
D7B8 F5             	PUSH	AF
D7B9 3A C9 D7       	LD	A,(BDSP+2)
D7BC FE FF          	CP	EXTSP/256
D7BE 28 0B          	JR	Z,BDOS1X
D7C0                BDOS2:
D7C0 F1             	POP	AF
D7C1 31 CA FF       	LD	SP,EXTSP
D7C4 CD CC D7       	CALL	BDOS1
D7C7 31 00 00       BDSP:	LD	SP,0
D7CA C9             	RET
D7CB                BDOS1X:
D7CB F1             	POP	AF
D7CC                BDOS1:
D7CC E5             	PUSH	HL
D7CD 79             	LD	A,C
D7CE FE 3C          	CP	03CH
D7D0 38 02          	JR	C,DOS1
D7D2 3E 3C          	LD	A,03CH
D7D4                DOS1:
D7D4 87             	ADD	A,A
D7D5 6F             	LD	L,A
D7D6 26 F0          	LD	H,STABLE/256
D7D8 7E             	LD	A,(HL)
D7D9 2C             	INC	L
D7DA 66             	LD	H,(HL)
D7DB 6F             	LD	L,A
D7DC E3             	EX	(SP),HL
D7DD 79             	LD	A,C
D7DE C9             	RET
D7DF                _DOS2:
D7DF FE 5A          	CP	05AH		;(BDOS)カレントディレクトリの変更(_CHDIR)
D7E1 CA AC DA       	JP	Z,_SYS5A
D7E4 FE 5C          	CP	05CH		;(BDOS)ファイル名の解析(_PFILE)
D7E6 CA 68 DA       	JP	Z,_SYS5C
D7E9 FE 5F          	CP	05FH		;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
D7EB CA 8B ED       	JP	Z,_SYS5F
D7EE FE 6F          	CP	06FH		;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
D7F0 20 0A          	JR	NZ,_ERROR
D7F2 01 1D 01       	LD	BC,011DH
D7F5 11 47 01       	LD	DE,VER
D7F8 21 00 00       	LD	HL,MACD
D7FB                C_REM:
D7FB AF             	XOR	A
D7FC                _ERROR:
D7FC A7             	AND	A
D7FD C9             	RET
D7FE                
D7FE                _SYS09:		;文字列出力
D7FE D5             	PUSH	DE
D7FF                _SX09:
D7FF 1A             	LD	A,(DE)
D800 13             	INC	DE
D801 FE 24          	CP	'$'
D803 28 31          	JR	Z,SX0E2
D805 CD A3 DB       	CALL	MSG_A
D808 18 F5          	JR	_SX09
D80A                
D80A                MSX1:
D80A CD A3 DB       	CALL	MSG_A
D80D                MSX:
D80D 7E             	LD	A,(HL)
D80E 23             	INC	HL
D80F B7             	OR	A
D810 20 F8          	JR	NZ,MSX1
D812 C9             	RET
D813                
D813                _SYS0C:		;(BDOS)バージョン番号の獲得
D813 21 22 00       	LD	HL,00022H
D816 7D             	LD	A,L
D817 C9             	RET
D818                
D818                _SYS0D:		;(BDOS)ディスクリセット
D818 CD DF EF       	CALL	_FFLUSH
D81B E5             	PUSH	HL
D81C 21 80 00       	LD	HL,00080H
D81F 22 8A EF       	LD	(_DTA),HL
D822 E1             	POP	HL
D823 D5             	PUSH	DE
D824 1E 00          	LD	E,0
D826 3E             	DB	03EH
D827                
D827                _SYS0E:		;(BDOS)カレントドライブの設定
D827 D5             	PUSH	DE
D828 7B             	LD	A,E
D829 DD E5          	PUSH	IX
D82B CD DC EF       	CALL	_GETDPB
D82E DD E1          	POP	IX
D830 38 04          	JR	C,SX0E2
D832 7B             	LD	A,E
D833 32 87 EF       	LD	(_DVSW),A
D836                SX0E2:
D836 3E 08          	LD	A,8
D838 D1             	POP	DE
D839 C9             	RET
D83A                
D83A                _SYS0F:		;(BDOS)ファイルのオープン
D83A CD 5B E1       	CALL	SETDRV
D83D FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D840 C6 02          	ADD	A,002H		;Write
D842 28 48          	JR	Z,FEND0F
D844 CD A9 E4       	CALL	CHKWILDX
D847                
D847 D4 7B E1       	CALL	NC,SOPENX
D84A                _S16XX:
D84A 38 40          	JR	C,FEND0F
D84C                				;Directory location
D84C 3A 9F EF       	LD	A,(_FILEN)
D84F FD 77 19       	LD	(IY+25),A	;(FCB)ディレクトリロケーション
D852                ;				_DIRF
D852 3A A0 EF       	LD	A,(_DIRF)
D855 FD 77 1D       	LD	(IY+29),A	;(FCB)ディレクトリモード
D858                ;				_FBPS
D858 FD 73 1E       	LD	(IY+30),E	;(FCB)ディレクトリポジション
D85B FD 72 1F       	LD	(IY+31),D
D85E                ;				Open(Read)
D85E FD 36 1C FF    	LD	(IY+28),0FFH	;(FCB)オープンモード
D862                ;				FILENAME
D862 FD E5          	PUSH	IY
D864 D1             	POP	DE
D865 13             	INC	DE
D866 01 0B 00       	LD	BC,11
D869 ED B0          	LDIR
D86B                ;				Attribute
D86B 7E             	LD	A,(HL)
D86C FD 77 0D       	LD	(IY+13),A	;(FCB)属性(アトリビュート)
D86F 11 0B 00       	LD	DE,11		;Reserved
D872 19             	ADD	HL,DE
D873                					;(FCB)ファイルを最後に変更した時刻
D873 11 EA F0       	LD	DE,SDDATA		;(FCB)ファイルを最後に変更した日付
D876 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
D878                S16LOOP:				;(FCB)ファイルのサイズ(バイト単位)
D878 1A             	LD	A,(DE)
D879 13             	INC	DE
D87A 32 81 D8       	LD	(S16PAT+2),A
D87D 7E             	LD	A,(HL)
D87E 23             	INC	HL
D87F FD 77 00       S16PAT:	LD	(IY+0),A
D882 10 F4          	DJNZ	S16LOOP
D884                
D884 AF             	XOR	A
D885 FD 77 0C       	LD	(IY+12),A	;(FCB)カレントブロック
D888 FD 22 30 D9    	LD	(OFCB+1),IY
D88C                FEND0F:
D88C 18 45          	JR	FEND10
D88E                
D88E                _SYS10:		;(BDOS)ファイルのクローズ
D88E CD 5B E1       	CALL	SETDRV
D891 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D894 D6 FE          	SUB	0FEH
D896 37             	SCF
D897 3F             	CCF
D898 20 39          	JR	NZ,FEND10
D89A                _S10A:				;Write
D89A FD 77 0E       	LD	(IY+14),A	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D89D FD 77 0F       	LD	(IY+15),A
D8A0                
D8A0 FD 34 1C       	INC	(IY+28)		;0FEH->0FFH ;オープンモード
D8A3 CD A1 E5       	CALL	SETTMS
D8A6                
D8A6 FD 7E 1D       	LD	A,(IY+29)	;(FCB)ディレクトリモード
D8A9 32 A0 EF       	LD	(_DIRF),A
D8AC E6 7F          	AND	07FH
D8AE 32 C0 EA       	LD	(_SECPS+1),A
D8B1 FD 5E 1E       	LD	E,(IY+30)	;(FCB)ディレクトリポジション
D8B4 FD 56 1F       	LD	D,(IY+31)
D8B7 CD AF E2       	CALL	READ_DIR
D8BA 38 17          	JR	C,FEND10
D8BC                
D8BC 3A D9 E1       SDECM1:	LD	A,(SDECPAT+1)	;1セクタ辺りのディレクトリエントリ数
D8BF 3D              	DEC	A		;1024=01FH / 512=00FH / 256=7
D8C0 FD A6 19       	AND	(IY+25)		;(FCB)ディレクトリロケーション
D8C3 6F             	LD	L,A
D8C4 26 00          	LD	H,0
D8C6 29             	ADD	HL,HL		;*2
D8C7 29             	ADD	HL,HL		;*4
D8C8 29             	ADD	HL,HL		;*8
D8C9 29             	ADD	HL,HL		;*16
D8CA 29             	ADD	HL,HL		;*32
D8CB ED 4B 7E F0    	LD	BC,(_DTBUF)
D8CF 09             	ADD	HL,BC
D8D0                
D8D0 CD B9 E4       	CALL	SDIRENT
D8D3                FEND10:
D8D3 18 42          	JR	FEND
D8D5                
D8D5                _SYS11:		;(BDOS)最初のファイルの検索
D8D5 CD 5B E1       	CALL	SETDRV
D8D8 CD A8 E1       	CALL	SOPEN
D8DB                _S12X1:
D8DB 38 3A          	JR	C,FEND
D8DD CD 48 E2       	CALL	SOPENE2
D8E0 ED 5B 8A EF    	LD	DE,(_DTA)
D8E4 3A 88 EF       	LD	A,(_DRV)
D8E7 3C             	INC	A
D8E8 12             	LD	(DE),A
D8E9 D5             	PUSH	DE
D8EA 13             	INC	DE
D8EB 01 20 00       	LD	BC,32
D8EE ED B0          	LDIR
D8F0 FD 6E 0E       	LD	L,(IY+14)	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D8F3 FD 66 0F       	LD	H,(IY+15)
D8F6 22 F4 F0       	LD	(SCDIR),HL
D8F9 2A 9A EF       	LD	HL,(_FBPS)
D8FC 22 F6 F0       	LD	(SFBPS),HL
D8FF 2A 9F EF       	LD	HL,(_FILEN)
D902 7C             	LD	A,H
D903 B7             	OR	A
D904 28 06          	JR	Z,_S12DIR
D906 3A C0 EA       	LD	A,(_SECPS+1)
D909 F6 80          	OR	080H
D90B 67             	LD	H,A
D90C                _S12DIR:
D90C 22 F8 F0       	LD	(SFNDF),HL	;Directory position and Flags
D90F E1             	POP	HL
D910 11 39 EF       	LD	DE,SFILE
D913 0E 21          	LD	C,33
D915                _S11B:
D915 ED B0          	LDIR
D917                FEND:
D917 9F             	SBC	A,A		;CF=0 A=0 : CF=1 A=0FFH
D918                FENDE:
D918 FD E1          	POP	IY
D91A C1             	POP	BC
D91B D1             	POP	DE
D91C E1             	POP	HL
D91D C9             	RET
D91E                
D91E                _SYS12:		;(BDOS)次のファイルの検索
D91E E5             	PUSH	HL
D91F D5             	PUSH	DE
D920 C5             	PUSH	BC
D921 FD E5          	PUSH	IY
D923 CD 0C E2       	CALL	NOPEN
D926 18 B3          	JR	_S12X1
D928                
D928                _S16K:
D928 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D92B FE FD          	CP	0FDH		;Device(0FDH)
D92D 37             	SCF
D92E C8             	RET	Z
D92F                
D92F 11 00 00       OFCB:	LD	DE,0
D932 D5             	PUSH	DE
D933 06 1A          	LD	B,26		;First cluster
D935                S16K1:
D935 13             	INC	DE
D936 23             	INC	HL
D937 10 FC          	DJNZ	S16K1
D939                
D939 1A             	LD	A,(DE)
D93A BE             	CP	(HL)
D93B 20 13          	JR	NZ,S16K2
D93D 13             	INC	DE
D93E 23             	INC	HL
D93F 1A             	LD	A,(DE)
D940 BE             	CP	(HL)
D941 20 0D          	JR	NZ,S16K2
D943                
D943 E1             	POP	HL
D944 FD E5          	PUSH	IY
D946 D1             	POP	DE
D947 1A             	LD	A,(DE)		;Drive
D948 BE             	CP	(HL)
D949 20 06          	JR	NZ,S16K3
D94B                				;ここはCFが必ず0
D94B ED 52          	SBC	HL,DE		;CP HL,DE
D94D 37             	SCF
D94E C0             	RET	NZ
D94F E5             	PUSH	HL
D950                S16K2:
D950 E1             	POP	HL
D951                S16K3:
D951 FD E5          	PUSH	IY
D953 D1             	POP	DE
D954                _SYS13:		;(BDOS)ファイルの削除
D954 CD 5B E1       	CALL	SETDRV
D957 CD D9 E3       	CALL	KILL
D95A                FEND13:
D95A 18 BB          	JR	FEND
D95C                
D95C                _SYS14:		;(BDOS)シーケンシャルな読み出し
D95C CD 5B E1       	CALL	SETDRV
D95F CD D3 E5       	CALL	PUSHRR
D962 CD 16 E6       	CALL	GETSEQ
D965                
D965 CD 2B E6       	CALL	RB_READ
D968 E5             	PUSH	HL
D969 CD E7 E5       	CALL	SETSEQ
D96C                SREAD:
D96C E1             	POP	HL
D96D                
D96D C6 01          	ADD	A,001H
D96F 38 A6          	JR	C,FEND
D971                
D971 7D             	LD	A,L
D972 D6 01          	SUB	001H
D974                FENDX:
D974 9F             	SBC	A,A
D975 E6 03          	AND	3
D977 1F             	RRA
D978 18 9E          	JR	FENDE
D97A                
D97A                _SYS15:		;(BDOS)シーケンシャルな書き込み
D97A CD 5B E1       	CALL	SETDRV
D97D CD D3 E5       	CALL	PUSHRR
D980 CD 16 E6       	CALL	GETSEQ
D983                
D983 CD 24 E6       	CALL	RB_WRITE
D986 E5             	PUSH	HL
D987 CD E7 E5       	CALL	SETSEQ
D98A                SWRITE:
D98A E1             	POP	HL
D98B                
D98B C6 FF          	ADD	A,0FFH
D98D 18 E5          	JR	FENDX
D98F                
D98F                _SYS17:		;(BDOS)ファイル名の変更
D98F CD 5B E1       	CALL	SETDRV
D992 CD 2F E4       	CALL	NAME
D995 18 C3          	JR	FEND13
D997                
D997                _SYS16:		;(BDOS)ファイルの作成
D997 CD 5B E1       	CALL	SETDRV
D99A                
D99A CD A9 E4       	CALL	CHKWILDX
D99D 38 BB          	JR	C,FEND13
D99F FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
D9A2 FE 05          	CP	5
D9A4 28 05          	JR	Z,_S16X2
D9A6 FE 21          	CP	021H
D9A8 DA 5A D9       	JP	C,FEND13
D9AB                _S16X2:
D9AB                ;				Clear FCB
D9AB FD E5          	PUSH	IY
D9AD E1             	POP	HL
D9AE 01 10 00       	LD	BC,16
D9B1 09             	ADD	HL,BC
D9B2                _S16X1:
D9B2 70             	LD	(HL),B		;B=0
D9B3 23             	INC	HL
D9B4 0D             	DEC	C
D9B5 20 FB          	JR	NZ,_S16X1
D9B7                
D9B7 CD A6 E5       	CALL	SETTMSX
D9BA FD 36 0D FF    	LD	(IY+13),0FFH	;(FCB)Attribute
D9BE CD 7B E1       	CALL	SOPENX
D9C1 3F             	CCF
D9C2 CC 28 D9       	CALL	Z,_S16K
D9C5 D4 59 E2       	CALL	NC,COPEN
D9C8 D4 B9 E4       	CALL	NC,SDIRENT
D9CB C3 4A D8       	JP	_S16XX
D9CE                
D9CE                _SYS21:		;(BDOS)ランダムな読み出し
D9CE                
D9CE CD 5B E1       	CALL	SETDRV
D9D1 CD D3 E5       	CALL	PUSHRR
D9D4 CD AC E8       	CALL	GET_RR_AHL
D9D7                
D9D7 CD 2B E6       	CALL	RB_READ
D9DA E5             	PUSH	HL
D9DB CD 02 E6       	CALL	POPRR
D9DE 18 8C          	JR	SREAD
D9E0                
D9E0                _SYS22:		;(BDOS)ランダムな書き込み
D9E0                _SYS28:		;(BDOS)ランダムな書き込み・その2
D9E0 CD 5B E1       	CALL	SETDRV
D9E3 CD D3 E5       	CALL	PUSHRR
D9E6 CD AC E8       	CALL	GET_RR_AHL
D9E9                
D9E9 CD 24 E6       	CALL	RB_WRITE
D9EC E5             	PUSH	HL
D9ED CD 02 E6       	CALL	POPRR
D9F0 18 98          	JR	SWRITE
D9F2                
D9F2                _SYS18:		;(BDOS)ログインベクトルの獲得
D9F2 21 FF 00       	LD	HL,000FFH
D9F5 AF             	XOR	A
D9F6 C9             	RET
D9F7                
D9F7                _SYS19:		;(BDOS)カレントドライブ番号の獲得
D9F7 3A 87 EF       	LD	A,(_DVSW)
D9FA A7             	AND	A
D9FB C9             	RET
D9FC                
D9FC                _SYS1A:		;(BDOS)DTAの設定
D9FC ED 53 8A EF    	LD	(_DTA),DE
DA00 AF             	XOR	A
DA01 C9             	RET
DA02                
DA02                _SYS1B:		;(BDOS)ディスク情報の獲得
DA02 7B             	LD	A,E
DA03 CD 6E E1       	CALL	GETDRV
DA06 CD DC EF       	CALL	_GETDPB
DA09 D4 E2 EF       	CALL	NC,_RDFATX
DA0C 21 00 00       	LD	HL,0
DA0F D4 7F E5       	CALL	NC,DSKF
DA12                
DA12 ED 5B 80 E5    	LD	DE,(MAXCLP+1)	;DPB_08_MAXCL-1
DA16 1B             	DEC	DE		;DE←クラスタの総数
DA17 FD 2A 7C F0    	LD	IY,(_FATBF)	;IY←メモリ上のFATの先頭アドレス
DA1B 9F             	SBC	A,A
DA1C D8             	RET	C
DA1D 4F             	LD	C,A		;C=0
DA1E DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS
DA21 E6 0F          	AND	00FH
DA23 47             	LD	B,A
DA24 DD 7E 07       	LD	A,(IX+7)	;DPB_07_SECPCL
DA27 C9             	RET
DA28                
DA28                _SYS1D:		;(BDOS)書き込みが禁止されているディスクの調査
DA28 AF             	XOR	A
DA29 67             	LD	H,A
DA2A 6F             	LD	L,A
DA2B C9             	RET
DA2C                
DA2C                _SYS1F:		;(BDOS)ディスク装置のパラメータの読み出し
DA2C 21 00 F1       	LD	HL,DEVICE
DA2F 7B             	LD	A,E
DA30 C3 DC EF       	JP	_GETDPB
DA33                
DA33                _SYS23:		;(BDOS)ファイルサイズの獲得
DA33 E5             	PUSH	HL
DA34 2A 1E F0       	LD	HL,(STABLE+2*00FH)	;ファイルのオープン
DA37 CD 0F 00       	CALL	JP_HL
DA3A 38 21          	JR	C,_S23X1
DA3C                
DA3C D5             	PUSH	DE		;EX DE,IY
DA3D FD E3          	EX	(SP),IY		;
DA3F                ;	POP	DE		;
DA3F                ;	PUSH	DE		;DEを破壊しないように注意vv
DA3F FD 7E 10       	LD	A,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
DA42 FD 6E 11       	LD	L,(IY+17)	;
DA45 FD 66 12       	LD	H,(IY+18)	;
DA48 C5             	PUSH	BC		;
DA49 FD 46 13       	LD	B,(IY+19)	;
DA4C CD 08 E6       	CALL	GET_CPM_R_SIZE
DA4F C1             	POP	BC
DA50                _S24X1:
DA50 FD 75 21       	LD	(IY+33),L	;(FCB)Random record
DA53 FD 74 22       	LD	(IY+34),H
DA56 FD 77 23       	LD	(IY+35),A
DA59                ;	POP	DE		;^^^^^^^^^^^^^^^^^^^^^^^^
DA59                ;	PUSH	DE		;EX DE,IY
DA59 FD E3          	EX	(SP),IY		;
DA5B D1             	POP	DE		;
DA5C                
DA5C AF             	XOR	A
DA5D                _S23X1:
DA5D E1             	POP	HL
DA5E C9             	RET
DA5F                
DA5F                _SYS24:		;(BDOS)ランダムレコードフィールドの設定
DA5F E5             	PUSH	HL
DA60 D5             	PUSH	DE		;EX DE,IY
DA61 FD E3          	EX	(SP),IY		;
DA63                ;	POP	DE		;
DA63                ;	PUSH	DE		;DEを破壊しないように注意vv
DA63 CD 16 E6       	CALL	GETSEQ
DA66 18 E8          	JR	_S24X1		;^^^^^^^^^^^^^^^^^^^^^^^^
DA68                
DA68                _SYS5C:		;(BDOS)ファイル名の解析
DA68 C5             	PUSH	BC
DA69 E5             	PUSH	HL
DA6A CD 72 E0       	CALL	FILE
DA6D E1             	POP	HL
DA6E C1             	POP	BC
DA6F                S29X1:
DA6F C5             	PUSH	BC
DA70 D5             	PUSH	DE
DA71 E5             	PUSH	HL
DA72 EB             	EX	DE,HL
DA73 21 14 EF       	LD	HL,FDRV
DA76 01 0D 00       	LD	BC,13
DA79 ED B0          	LDIR
DA7B 70             	LD	(HL),B		;B=0
DA7C 0E 03          	LD	C,3
DA7E ED B0          	LDIR
DA80 E1             	POP	HL
DA81 D1             	POP	DE
DA82 C1             	POP	BC
DA83 AF             	XOR	A
DA84 C9             	RET
DA85                
DA85                _SYS30:		;(BDOS)論理セクタを用いた書き込み
DA85 C5             	PUSH	BC
DA86 01 2E EC       	LD	BC,DWT24B
DA89 18 04          	JR	S2FX
DA8B                _SYS2F:
DA8B C5             	PUSH	BC
DA8C 01 1E EC       	LD	BC,DRD24B
DA8F                S2FX:
DA8F ED 43 A5 DA    	LD	(S2FPAT+1),BC
DA93 CD DF EF       	CALL	_FFLUSH
DA96                
DA96 D5             	PUSH	DE
DA97 E5             	PUSH	HL
DA98 7D             	LD	A,L		;Drive
DA99 CD D9 EF       	CALL	_CHGDRV
DA9C 38 09          	JR	C,S30X2
DA9E 44             	LD	B,H		;Number of clusters
DA9F 2A 8A EF       	LD	HL,(_DTA)
DAA2                
DAA2 0E 00          	LD	C,0
DAA4 CD 1E EC       S2FPAT:	CALL	DRD24B
DAA7                S30X2:
DAA7 E1             	POP	HL
DAA8 D1             	POP	DE
DAA9 C1             	POP	BC
DAAA 9F             	SBC	A,A
DAAB C9             	RET
DAAC                
DAAC                _SYS5A:		;(BDOS)カレントディレクトリの変更
DAAC C5             	PUSH	BC
DAAD D5             	PUSH	DE
DAAE E5             	PUSH	HL
DAAF CD 67 E0       	CALL	FILEC
DAB2 21 00 00       	LD	HL,0
DAB5 11 14 EF       	LD	DE,FDRV
DAB8 2A 4E F0       	LD	HL,(STABLE+2*027H)	;ランダムブロック読み込み
DABB CD 0F 00       	CALL	JP_HL
DABE 18 E7          	JR	S30X2
DAC0                	INCLUDE	"X1IO.ASM"
DAC0                
DAC0                ;	LSX-Dodgers IO
DAC0                ;	X1/turbo/Z
DAC0                
DAC0 00 00 D7 FC    _SYS04	EQU	_ERROR		;(BDOS)外部出力
DAC0 00 00 D7 FC    _SYS05	EQU	_ERROR		;(BDOS)プリンタ出力
DAC0 00 00 D7 FC    _SYS1C	EQU	_ERROR		;(BDOS)ディスクの書き込み禁止化
DAC0 00 00 D7 FC    _SYS1E	EQU	_ERROR		;(BDOS)ファイル属性の設定
DAC0 00 00 D7 FC    _SYS20	EQU	_ERROR		;(BDOS)利用者番号の設定と読み出し
DAC0 00 00 D7 FC    _SYS2E	EQU	_ERROR		;(BDOS)ベリファイ・フラグの設定
DAC0                
DAC0                BIOS:
DAC0 E5             	PUSH	HL
DAC1 21 10 80       	LD	HL,08010H
DAC4 39             	ADD	HL,SP
DAC5 E1             	POP	HL
DAC6 30 0E          	JR	NC,BIOS2
DAC8                BIOS1:
DAC8 CD D0 DA       	CALL	BIOS3
DACB 06 1E          	LD	B,01EH
DACD ED 79          	OUT	(C),A
DACF C9             	RET
DAD0                BIOS3:
DAD0 C5             	PUSH	BC
DAD1 06 1D          	LD	B,01DH
DAD3 ED 79          	OUT	(C),A
DAD5 C9             	RET
DAD6                BIOS2:
DAD6 ED 73 E1 DA    	LD	(SPPAT+1),SP	;スタックがBIOS-ROMと被っている場合
DADA 31 CA FF       	LD	SP,EXTSP
DADD CD C8 DA       	CALL	BIOS1
DAE0 31 00 00       SPPAT:	LD	SP,0
DAE3 C9             	RET
DAE4                
DAE4                INT:
DAE4 F5             	PUSH	AF
DAE5 E5             	PUSH	HL
DAE6 ED 73 F7 DA    	LD	(INTSP+1),SP
DAEA 21 00 01       	LD	HL,00100H
DAED 39             	ADD	HL,SP
DAEE 38 03          	JR	C,INTP1X
DAF0 31 CA FF       	LD	SP,EXTSP
DAF3                INTP1X:
DAF3 CD FE DA       	CALL	INTP1
DAF6 31 00 00       INTSP:	LD	SP,0
DAF9                INTPE:
DAF9 E1             	POP	HL
DAFA                INTPE2:
DAFA F1             	POP	AF
DAFB                INTCTCE:
DAFB FB             	EI
DAFC ED 4D          	RETI
DAFE                INTP1:
DAFE C5             	PUSH	BC
DAFF                
DAFF CD AB DE       	CALL	IN49SB
DB02 67             	LD	H,A
DB03 CD AB DE       	CALL	IN49SB
DB06 6F             	LD	L,A
DB07                
DB07 FE 08          	CP	8		;DELキー
DB09 20 05          	JR	NZ,SCEXE
DB0B 7C             	LD	A,H
DB0C E6 11          	AND	011H		;CTRLキー + GRAPHキー
DB0E 28 08          	JR	Z,RESET
DB10                SCEXE:
DB10 22 92 EF       	LD	(_KEYD),HL
DB13 CD 44 DB       	CALL	KEYSET1
DB16                
DB16 C1             	POP	BC
DB17 C9             	RET
DB18                
DB18                RESET:
DB18 3E 1D          	LD	A,01DH
DB1A D3 00          	OUT	(0),A
DB1C C7             	RST	0
DB1D                
DB1D                INTCTC2:
DB1D F5             	PUSH	AF
DB1E 3E 00          INTCPAT:LD	A,000H
DB20 3D             	DEC	A
DB21 32 1F DB       	LD	(INTCPAT+1),A
DB24 20 D4          	JR	NZ,INTPE2
DB26                
DB26 3A 92 EF       	LD	A,(_KEYD)
DB29 B7             	OR	A
DB2A 28 CE          	JR	Z,INTPE2
DB2C                KEYSET0:
DB2C E5             	PUSH	HL
DB2D 2A 90 EF       	LD	HL,(_KEYPS)
DB30 7C             	LD	A,H
DB31 AD             	XOR	L
DB32 20 06          	JR	NZ,INTC2A
DB34                
DB34 2A 92 EF       	LD	HL,(_KEYD)
DB37 CD 6E DB       	CALL	KEYSET
DB3A                INTC2A:
DB3A 3A 94 EF       	LD	A,(_KEYSP)
DB3D E6 0F          	AND	00FH
DB3F 32 1F DB       	LD	(INTCPAT+1),A
DB42                
DB42 18 B5          	JR	INTPE
DB44                
DB44                KEYSET1:
DB44 CB 6C          	BIT	5,H
DB46 F5             	PUSH	AF
DB47 ED 4B 8C EF    	LD	BC,(_CTC)
DB4B 78             	LD	A,B
DB4C B1             	OR	C
DB4D 20 06          	JR	NZ,KEYS10E
DB4F                
DB4F F1             	POP	AF
DB50 20 1C          	JR	NZ,KEYSET
DB52 F5             	PUSH	AF
DB53 18 D7          	JR	KEYSET0
DB55                KEYS10E:
DB55 F1             	POP	AF
DB56 C8             	RET	Z
DB57 F5             	PUSH	AF
DB58 3E 03          	LD	A,3		;CTC STOP
DB5A ED 79          	OUT	(C),A
DB5C F1             	POP	AF
DB5D                
DB5D B7             	OR	A
DB5E C8             	RET	Z
DB5F                
DB5F E5             	PUSH	HL
DB60 2A 94 EF       	LD	HL,(_KEYSP)
DB63 3E A7          	LD	A,0A7H
DB65 ED 79          	OUT	(C),A
DB67 ED 69          	OUT	(C),L
DB69 7C             	LD	A,H
DB6A 32 1F DB       	LD	(INTCPAT+1),A
DB6D E1             	POP	HL
DB6E                
DB6E                KEYSET:
DB6E 7D             	LD	A,L
DB6F CB 7C          	BIT	7,H
DB71 C8             	RET	Z
DB72 CB 74          	BIT	6,H
DB74 C0             	RET	NZ
DB75                KEYBS:
DB75 B7             	OR	A
DB76 C8             	RET	Z
DB77                KEYBS1:
DB77 CD 8D DB       	CALL	KEYBC_IFBREAK
DB7A E5             	PUSH	HL
DB7B F5             	PUSH	AF
DB7C 2A 90 EF       	LD	HL,(_KEYPS)
DB7F 2C             	INC	L
DB80 7D             	LD	A,L
DB81 BC             	CP	H
DB82 28 15          	JR	Z,POP_AF_HL_SCF_RET
DB84 32 90 EF       	LD	(_KEYPS),A
DB87 26 FE          	LD	H,KEYBF/256
DB89 F1             	POP	AF
DB8A 77             	LD	(HL),A
DB8B E1             	POP	HL
DB8C C9             	RET
DB8D                KEYBC_IFBREAK:
DB8D FE 03          	CP	3
DB8F C0             	RET	NZ
DB90                KEYBC:
DB90 E5             	PUSH	HL
DB91 21 00 00       	LD	HL,0
DB94 22 90 EF       	LD	(_KEYPS),HL
DB97 E1             	POP	HL
DB98 C9             	RET
DB99                
DB99                POP_AF_HL_SCF_RET:
DB99 F1             	POP	AF
DB9A E1             	POP	HL
DB9B 37             	SCF
DB9C C9             	RET
DB9D                
DB9D                KEYBSL:
DB9D 7D             	LD	A,L
DB9E 18 D7          	JR	KEYBS1
DBA0                
DBA0                _SYS01:		;(BDOS)コンソール入力
DBA0 CD 09 EF       	CALL	_SYS07
DBA3                MSG_A:
DBA3 F5             	PUSH	AF
DBA4 D5             	PUSH	DE
DBA5 5F             	LD	E,A
DBA6 CD AC DB       	CALL	_SYS02
DBA9 D1             	POP	DE
DBAA F1             	POP	AF
DBAB C9             	RET
DBAC                
DBAC                _SYS02:		;(BDOS)コンソール出力
DBAC CD BE DB       	CALL	BREAK
DBAF 18 05          	JR	PRINTX
DBB1                
DBB1                _SYS06:		;(BDOS)コンソール直接入出力
DBB1 7B             	LD	A,E
DBB2 3C             	INC	A
DBB3 CA CA EF       	JP	Z,_INKEY
DBB6                PRINTX:
DBB6 C3 CD EF       	JP	_PRINT
DBB9                
DBB9                _SYS08:		;(BDOS)エコーなしコンソール入力
DBB9 CD 09 EF       	CALL	_SYS07
DBBC 18 04          	JR	BREAK1
DBBE                BREAK:
DBBE FB             	EI
DBBF 3A 92 EF       	LD	A,(_KEYD)
DBC2                BREAK1:
DBC2 FE 03          	CP	3		;CTRL+C
DBC4 CA 00 EF       	JP	Z,CPM_BOOT
DBC7 FE 13          	CP	013H		;CTRL+S
DBC9 C0             	RET	NZ
DBCA                
DBCA                PAUSE:
DBCA CD 90 DB       	CALL	KEYBC
DBCD                
DBCD                FLGET:
DBCD CD DF EF       	CALL	_FFLUSH
DBD0 C5             	PUSH	BC
DBD1 E5             	PUSH	HL
DBD2 ED 4B 8E EF    	LD	BC,(_TXADR)
DBD6 CB E8          	SET	5,B
DBD8 ED 60          	IN	H,(C)
DBDA                FLGET1:
DBDA 3A 93 EF       	LD	A,(_KEYD+1)
DBDD 0F             	RRCA
DBDE 0F             	RRCA
DBDF E6 10          	AND	010H
DBE1 F6 08          	OR	8
DBE3 ED 68          	IN	L,(C)
DBE5 B5             	OR	L
DBE6 ED 79          	OUT	(C),A
DBE8 CD CA EF       	CALL	_INKEY
DBEB 28 ED          	JR	Z,FLGET1
DBED ED 61          	OUT	(C),H
DBEF E1             	POP	HL
DBF0 C1             	POP	BC
DBF1 C9             	RET
DBF2                
DBF2                _SYS0A:		;(BDOS)文字列入力
DBF2 C5             	PUSH	BC
DBF3 E5             	PUSH	HL
DBF4 D5             	PUSH	DE
DBF5 CD F8 DF       	CALL	GETL
DBF8 11 00 FF       	LD	DE,KBUF
DBFB E1             	POP	HL
DBFC E5             	PUSH	HL
DBFD 0E 00          	LD	C,0
DBFF 30 04          	JR	NC,SAX0
DC01 23             	INC	HL
DC02 23             	INC	HL
DC03 18 08          	JR	SAX4
DC05                SAX0:
DC05 46             	LD	B,(HL)
DC06 23             	INC	HL
DC07                SAX1:
DC07 23             	INC	HL
DC08 1A             	LD	A,(DE)
DC09 13             	INC	DE
DC0A B7             	OR	A
DC0B 20 04          	JR	NZ,SAX2
DC0D                SAX4:
DC0D 36 0D          	LD	(HL),00DH
DC0F 18 04          	JR	SAX3
DC11                SAX2:
DC11 77             	LD	(HL),A
DC12 0C             	INC	C
DC13 10 F2          	DJNZ	SAX1
DC15                SAX3:
DC15 D1             	POP	DE
DC16 79             	LD	A,C
DC17 13             	INC	DE
DC18 12             	LD	(DE),A
DC19 1B             	DEC	DE
DC1A E1             	POP	HL
DC1B C1             	POP	BC
DC1C A7             	AND	A
DC1D C9             	RET
DC1E                
DC1E                _SYS0B:		;(BDOS)コンソール状態のチェック
DC1E CD BE DB       	CALL	BREAK
DC21 3A 92 EF       	LD	A,(_KEYD)
DC24 B7             	OR	A
DC25 C8             	RET	Z
DC26                CONSTX:
DC26 CD DF EF       	CALL	_FFLUSH
DC29 E5             	PUSH	HL
DC2A 2A 90 EF       	LD	HL,(_KEYPS)
DC2D 7C             	LD	A,H
DC2E AD             	XOR	L
DC2F E1             	POP	HL
DC30 C6 FF          	ADD	A,0FFH
DC32 9F             	SBC	A,A
DC33 C9             	RET
DC34                
DC34                _SYS2A:		;(BDOS)日付の獲得
DC34 C5             	PUSH	BC
DC35 3E ED          	LD	A,0EDH		;Read calendar
DC37 CD C6 DE       	CALL	COMOUT
DC3A CD 6C DC       	CALL	IN49SB_BCD	;YY
DC3D 6F             	LD	L,A
DC3E 26 00          	LD	H,0
DC40                ;	LD	DE,1900		;0076CH
DC40                ;	CP	90		;90以上は1900年代 1990-1999
DC40                ;	JR	NC,RDDATE1	;90未満は2000年代 2000-2089
DC40                ;	LD	E,0D0H		;2000 & 0FFH D=007H
DC40 11 D0 07       	LD	DE,2000		;すべて2000年代で処理 2000-2099
DC43                RDDATE1:
DC43 19             	ADD	HL,DE
DC44 CD AB DE       	CALL	IN49SB		;MW
DC47 57             	LD	D,A
DC48 CD 6C DC       	CALL	IN49SB_BCD	;DD
DC4B 5F             	LD	E,A
DC4C 7A             	LD	A,D
DC4D 06 04          	LD	B,4
DC4F                RDDATE2:
DC4F CB 3A          	SRL	D
DC51 10 FC          	DJNZ	RDDATE2
DC53 C1             	POP	BC
DC54 E6 07          	AND	7
DC56 C9             	RET
DC57                
DC57                _SYS2C:		;(BDOS)時刻の獲得
DC57 C5             	PUSH	BC
DC58 3E EF          	LD	A,0EFH		;Read time
DC5A CD C6 DE       	CALL	COMOUT
DC5D CD 6C DC       	CALL	IN49SB_BCD	;TT
DC60 67             	LD	H,A
DC61 CD 6C DC       	CALL	IN49SB_BCD	;MM
DC64 6F             	LD	L,A
DC65 CD 6C DC       	CALL	IN49SB_BCD	;SS
DC68 57             	LD	D,A
DC69 C1             	POP	BC
DC6A AF             	XOR	A
DC6B C9             	RET
DC6C                
DC6C                IN49SB_BCD:
DC6C CD AB DE       	CALL	IN49SB
DC6F                ;------------------------
DC6F                ;BCDの10進数化
DC6F                ;in
DC6F                ;	A  : BCD
DC6F                ;out
DC6F                ;	A  : 10進数
DC6F                ;------------------------
DC6F 4F             	LD	C,A
DC70 E6 F0          	AND	0F0H	;10の位
DC72 0F             	RRCA
DC73 47             	LD	B,A
DC74 0F             	RRCA
DC75 0F             	RRCA
DC76 80             	ADD	A,B
DC77 47             	LD	B,A
DC78 79             	LD	A,C
DC79 E6 0F          	AND	00FH	;1の位
DC7B 80             	ADD	A,B
DC7C C9             	RET
DC7D                
DC7D                ESC1:
DC7D 7B             	LD	A,E
DC7E FE 41          	CP	'A'
DC80 CA C7 DD       	JP	Z,CTRL1E
DC83 FE 42          	CP	'B'
DC85 CA 31 DF       	JP	Z,CTRL1F
DC88 FE 43          	CP	'C'
DC8A CA D2 DD       	JP	Z,CTRL1C
DC8D FE 44          	CP	'D'
DC8F CA BE DD       	JP	Z,CTRL1D
DC92 FE 45          	CP	'E'
DC94 28 02          	JR	Z,CT0CX
DC96 FE 6A          	CP	'j'
DC98                CT0CX:
DC98 CA 04 DF       	JP	Z,CTRL0C
DC9B FE 48          	CP	'H'
DC9D CA 4C DE       	JP	Z,CTRL0B
DCA0 FE 4A          	CP	'J'
DCA2 CA 07 DF       	JP	Z,CTRL06
DCA5 FE 4B          	CP	'K'
DCA7 CA 0B DE       	JP	Z,CTRL05
DCAA FE 4C          	CP	'L'
DCAC CA 46 DF       	JP	Z,CTRL0E
DCAF FE 54          	CP	'T'
DCB1 CA 0B DE       	JP	Z,CTRL05
DCB4 FE 78          	CP	'x'
DCB6 28 04          	JR	Z,ESC1X
DCB8 FE 79          	CP	'y'
DCBA 20 02          	JR	NZ,ESC1Y
DCBC                ESC1X:
DCBC 36 01          	LD	(HL),1
DCBE                ESC1Y:
DCBE FE 3D          	CP	'='
DCC0 28 04          	JR	Z,ESC1W
DCC2 FE 59          	CP	'Y'
DCC4 20 02          	JR	NZ,ESC1Z
DCC6                ESC1W:
DCC6 36 02          	LD	(HL),2
DCC8                ESC1Z:
DCC8 FE 20          	CP	020H
DCCA 38 02          	JR	C,ESC1C
DCCC 87             	ADD	A,A
DCCD D0             	RET	NC
DCCE                ESC1C:
DCCE E1             	POP	HL
DCCF 18 4F          	JR	ANK
DCD1                
DCD1                ESC:
DCD1 21 31 DD       	LD	HL,PRINTE5
DCD4 E5             	PUSH	HL
DCD5 21 F7 DC       	LD	HL,ESCFLG+1
DCD8 36 00          	LD	(HL),0
DCDA 3D             	DEC	A
DCDB 28 A0          	JR	Z,ESC1
DCDD 3D             	DEC	A
DCDE 20 09          	JR	NZ,ESC2
DCE0 36 03          	LD	(HL),3
DCE2 7B             	LD	A,E
DCE3 D6 20          	SUB	020H
DCE5 32 EC DC       	LD	(ESCYP+1),A
DCE8 C9             	RET
DCE9                ESC2:
DCE9 3D             	DEC	A
DCEA C0             	RET	NZ
DCEB 26 00          ESCYP:	LD	H,0
DCED 7B             	LD	A,E
DCEE D6 20          	SUB	020H
DCF0 6F             	LD	L,A
DCF1 C3 D6 EF       	JP	_LOC
DCF4                
DCF4                PRINT:
DCF4 C5             	PUSH	BC
DCF5 E5             	PUSH	HL
DCF6 3E 00          ESCFLG:	LD	A,000H
DCF8 B7             	OR	A
DCF9 20 D6          	JR	NZ,ESC
DCFB                
DCFB 3E 1F          	LD	A,01FH
DCFD BB             	CP	E
DCFE 30 35          	JR	NC,CTRL
DD00 01 CF DE       INSFLG:	LD	BC,INSERT
DD03                
DD03 3A 18 00       	LD	A,(00018H)
DD06 3C             	INC	A
DD07 28 17          	JR	Z,ANK
DD09 3E 00          KANFLG:	LD	A,000H
DD0B B7             	OR	A
DD0C 20 3A          	JR	NZ,KANJI2
DD0E 7B             	LD	A,E
DD0F FE 80          	CP	080H
DD11 38 0D          	JR	C,ANK
DD13 FE A0          	CP	0A0H
DD15 38 04          	JR	C,KANJI1
DD17 FE E0          	CP	0E0H
DD19 38 05          	JR	C,ANK
DD1B                KANJI1:
DD1B 32 0A DD       	LD	(KANFLG+1),A
DD1E 18 11          	JR	PRINTE5
DD20                ANK:
DD20 ED 4B 8E EF    	LD	BC,(_TXADR)
DD24 78             	LD	A,B
DD25 F6 38          	OR	038H
DD27 47             	LD	B,A
DD28 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DD2A CB 98          	RES	3,B
DD2C ED 59          	OUT	(C),E		;Text
DD2E                KANJIE:
DD2E CD 93 DD       	CALL	PRINTE7
DD31                PRINTE5:
DD31 E1             	POP	HL
DD32 C1             	POP	BC
DD33 AF             	XOR	A
DD34 C9             	RET
DD35                
DD35                CTRL:
DD35 CD 7A DD       	CALL	KANCLR
DD38 7B             	LD	A,E
DD39 87             	ADD	A,A
DD3A F6 80          	OR	080H
DD3C 6F             	LD	L,A
DD3D 26 F0          	LD	H,CTRLTB/256
DD3F 7E             	LD	A,(HL)
DD40 2C             	INC	L
DD41 66             	LD	H,(HL)
DD42 6F             	LD	L,A
DD43 CD 0F 00       	CALL	JP_HL
DD46 18 E9          	JR	PRINTE5
DD48                
DD48                KANJI2:
DD48 D5             	PUSH	DE
DD49 57             	LD	D,A
DD4A 01 81 2F       	LD	BC,02F81H	;SFTJIS
DD4D DF             	RST	018H
DD4E 01 C3 2F       	LD	BC,02FC3H	;Instead or JISVRM
DD51 DF             	RST	018H
DD52                
DD52 ED 4B 8E EF    	LD	BC,(_TXADR)
DD56 78             	LD	A,B
DD57 F6 38          	OR	038H
DD59 47             	LD	B,A
DD5A ED 51          	OUT	(C),D		;kanji
DD5C CB 98          	RES	3,B
DD5E ED 59          	OUT	(C),E		;Text
DD60 CD 93 DD       	CALL	PRINTE7
DD63 ED 4B 8E EF    	LD	BC,(_TXADR)
DD67 78             	LD	A,B
DD68 F6 38          	OR	038H
DD6A 47             	LD	B,A
DD6B CB F2          	SET	6,D
DD6D ED 51          	OUT	(C),D		;Kanji
DD6F CB 98          	RES	3,B
DD71 ED 59          	OUT	(C),E		;Text
DD73 D1             	POP	DE
DD74 AF             	XOR	A
DD75 32 0A DD       	LD	(KANFLG+1),A
DD78 18 B4          	JR	KANJIE
DD7A                
DD7A                KANCLR:
DD7A 3A 0A DD       	LD	A,(KANFLG+1)
DD7D B7             	OR	A
DD7E C8             	RET	Z
DD7F ED 4B 8E EF    	LD	BC,(_TXADR)
DD83 78             	LD	A,B
DD84 F6 38          	OR	038H
DD86 47             	LD	B,A
DD87 AF             	XOR	A
DD88 32 0A DD       	LD	(KANFLG+1),A
DD8B ED 79          	OUT	(C),A		;Kanji
DD8D CB 98          	RES	3,B
DD8F 3E 20          	LD	A,020H
DD91 ED 79          	OUT	(C),A		;Text
DD93                PRINTE7:
DD93 CB A0          	RES	4,B
DD95                PRINTE6:
DD95 3A 96 EF       	LD	A,(_COLORF)
DD98                PRINTE4:
DD98 ED 79          	OUT	(C),A		;Color
DD9A 78             	LD	A,B
DD9B E6 07          	AND	7
DD9D 47             	LD	B,A
DD9E                PRINTE2:
DD9E 03             	INC	BC
DD9F                PRINTE3:
DD9F 2A BA EF       	LD	HL,(_PAGE_MINUS)
DDA2 A7             	AND	A
DDA3 ED 4A          	ADC	HL,BC
DDA5                PRINTE8:
DDA5 28 05          	JR	Z,PRINT2
DDA7 ED 43 8E EF    	LD	(_TXADR),BC
DDAB                CTRL00:
DDAB C9             	RET
DDAC                
DDAC                PRINT2:
DDAC CD 4C DF       	CALL	SCR
DDAF 2A BC EF       	LD	HL,(_WIDTH_MINUS)
DDB2 09             	ADD	HL,BC
DDB3                SET_TXADR_HL:
DDB3 22 8E EF       	LD	(_TXADR),HL
DDB6 C9             	RET
DDB7                
DDB7                CTRL08:
DDB7 3A 00 DD       	LD	A,(INSFLG)
DDBA FE CD          	CP	0CDH		;CALL ????
DDBC 28 29          	JR	Z,CTRL02
DDBE                CTRL1D:
DDBE 2A 8E EF       	LD	HL,(_TXADR)
DDC1 7C             	LD	A,H
DDC2 B5             	OR	L
DDC3 C8             	RET	Z
DDC4 2B             	DEC	HL
DDC5 18 EC          	JR	SET_TXADR_HL
DDC7                
DDC7                CTRL1E:
DDC7 ED 4B 8E EF    	LD	BC,(_TXADR)
DDCB 2A BC EF       	LD	HL,(_WIDTH_MINUS)
DDCE 09             	ADD	HL,BC
DDCF D0             	RET	NC
DDD0 18 E1          	JR	SET_TXADR_HL
DDD2                
DDD2                CTRL1C:
DDD2 ED 4B 8E EF    	LD	BC,(_TXADR)
DDD6 18 C6          	JR	PRINTE2
DDD8                
DDD8                CTRL09:
DDD8 ED 4B 8E EF    	LD	BC,(_TXADR)
DDDC 79             	LD	A,C
DDDD E6 F8          	AND	0F8H
DDDF C6 08          	ADD	A,8
DDE1 4F             	LD	C,A
DDE2 88             	ADC	A,B
DDE3 91             	SUB	C
DDE4 47             	LD	B,A
DDE5 18 B8          	JR	PRINTE3
DDE7                
DDE7                CTRL02:
DDE7 CD BE DD       	CALL	CTRL1D
DDEA C8             	RET	Z
DDEB D5             	PUSH	DE
DDEC CD D3 EF       	CALL	_POS
DDEF 3A B1 EF       	LD	A,(_WIDTH)
DDF2 95             	SUB	L
DDF3 4F             	LD	C,A
DDF4 0D             	DEC	C
DDF5 06 38          	LD	B,038H
DDF7 2A 8E EF       	LD	HL,(_TXADR)
DDFA 09             	ADD	HL,BC
DDFB 44             	LD	B,H
DDFC 4D             	LD	C,L
DDFD 11 00 20       	LD	DE,02000H	;D:Text E:kanji
DE00 2A 96 EF       	LD	HL,(_COLORF)	;L:Color
DE03                C8X1:
DE03 CD EB DE       	CALL	C12S
DE06 0B             	DEC	BC
DE07 20 FA          	JR	NZ,C8X1
DE09 D1             	POP	DE
DE0A C9             	RET
DE0B                
DE0B                CTRL05:
DE0B CD D3 EF       	CALL	_POS
DE0E 3A B1 EF       	LD	A,(_WIDTH)
DE11 95             	SUB	L
DE12 6F             	LD	L,A
DE13                C08X1:
DE13 ED 4B 8E EF    	LD	BC,(_TXADR)
DE17                LINECL:
DE17 26 20          	LD	H,020H
DE19 3A 96 EF       	LD	A,(_COLORF)
DE1C CB E8          	SET	5,B
DE1E                LINECL1:
DE1E CB D8          	SET	3,B
DE20 CB E0          	SET	4,B
DE22 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DE24 CB 98          	RES	3,B
DE26 ED 61          	OUT	(C),H		;Text
DE28 CB A0          	RES	4,B
DE2A ED 79          	OUT	(C),A		;Color
DE2C 03             	INC	BC
DE2D 2D             	DEC	L
DE2E 20 EE          	JR	NZ,LINECL1
DE30 C9             	RET
DE31                
DE31                CTRL0D:
DE31 CD D3 EF       	CALL	_POS
DE34 2E 00          	LD	L,0
DE36                LOC:
DE36 C5             	PUSH	BC
DE37 E5             	PUSH	HL
DE38 CD 7A DD       	CALL	KANCLR
DE3B CD 59 DE       	CALL	LOC1
DE3E 22 8E EF       	LD	(_TXADR),HL
DE41 E1             	POP	HL
DE42 C1             	POP	BC
DE43 C9             	RET
DE44                
DE44                CTRL12:
DE44 21 00 DD       	LD	HL,INSFLG
DE47 7E             	LD	A,(HL)
DE48 EE CC          	XOR	0CCH		;CD:CALL ???? 1:LD BC,????
DE4A 77             	LD	(HL),A
DE4B C9             	RET
DE4C                
DE4C                CTRL0B:
DE4C 21 00 00       	LD	HL,0
DE4F 22 8E EF       	LD	(_TXADR),HL
DE52 C9             	RET
DE53                
DE53                CTRL1B:
DE53 3E 01          	LD	A,1
DE55 32 F7 DC       	LD	(ESCFLG+1),A
DE58 C9             	RET
DE59                
DE59                LOC1:
DE59 D5             	PUSH	DE
DE5A 4D             	LD	C,L
DE5B 06 08          	LD	B,8
DE5D 5C             	LD	E,H
DE5E 16 00          	LD	D,0
DE60 2A B0 EF       	LD	HL,(CRTCD)
DE63 6A             	LD	L,D
DE64                LOC2:
DE64 29             	ADD	HL,HL
DE65 30 01          	JR	NC,LOC3
DE67 19             	ADD	HL,DE
DE68                LOC3:
DE68 10 FA          	DJNZ	LOC2
DE6A 09             	ADD	HL,BC
DE6B D1             	POP	DE
DE6C C9             	RET
DE6D                
DE6D                CONOUT1:
DE6D CD 7F DE       	CALL	CURSOR
DE70 59             	LD	E,C
DE71 CD CD EF       	CALL	_PRINT
DE74 7B             	LD	A,E
DE75 FE 0A          	CP	00AH
DE77 20 06          	JR	NZ,CURSOR
DE79 CD 31 DE       	CALL	CTRL0D
DE7C CD 0B DE       	CALL	CTRL05
DE7F                CURSOR:
DE7F C5             	PUSH	BC
DE80 ED 4B 8E EF    	LD	BC,(_TXADR)
DE84 CB E8          	SET	5,B
DE86 ED 78          	IN	A,(C)
DE88 EE 18          	XOR	018H
DE8A ED 79          	OUT	(C),A
DE8C C1             	POP	BC
DE8D C9             	RET
DE8E                
DE8E                CTRL07:
DE8E 21 61 EF       	LD	HL,BEEPD
DE91                BEEP1:
DE91 7E             	LD	A,(HL)
DE92 23             	INC	HL
DE93 FE FF          	CP	0FFH
DE95 C8             	RET	Z
DE96 F3             	DI
DE97 06 1C          	LD	B,01CH
DE99 ED 79          	OUT	(C),A
DE9B ED A3          	OUTI
DE9D FB             	EI
DE9E 18 F1          	JR	BEEP1
DEA0                
DEA0                OT49SB:
DEA0 C5             	PUSH	BC
DEA1 CD BC DE       	CALL	CANW
DEA4 01 00 19       	LD	BC,01900H
DEA7 ED 79          	OUT	(C),A
DEA9 C1             	POP	BC
DEAA C9             	RET
DEAB                
DEAB                IN49SB:
DEAB C5             	PUSH	BC
DEAC 01 01 1A       	LD	BC,01A01H
DEAF                CANR:
DEAF ED 78          	IN	A,(C)
DEB1 E6 20          	AND	020H
DEB3 20 FA          	JR	NZ,CANR
DEB5 01 00 19       	LD	BC,01900H
DEB8 ED 78          	IN	A,(C)
DEBA C1             	POP	BC
DEBB C9             	RET
DEBC                
DEBC                CANW:
DEBC 01 01 1A       	LD	BC,01A01H
DEBF ED 48          	IN	C,(C)
DEC1 CB 71          	BIT	6,C
DEC3 20 F7          	JR	NZ,CANW
DEC5 C9             	RET
DEC6                
DEC6                COMOUT:
DEC6 FB             	EI
DEC7 CD A0 DE       	CALL	OT49SB
DECA CD BC DE       	CALL	CANW
DECD F3             	DI
DECE C9             	RET
DECF                
DECF                INSERT:
DECF D5             	PUSH	DE
DED0 CD D3 EF       	CALL	_POS
DED3 3A B1 EF       	LD	A,(_WIDTH)
DED6 95             	SUB	L
DED7 ED 4B 8E EF    	LD	BC,(_TXADR)
DEDB 11 00 20       	LD	DE,02000H	;D:Text E:Kanji
DEDE 2A 96 EF       	LD	HL,(_COLORF)	;L:Color
DEE1 CB E8          	SET	5,B
DEE3                C12X1:
DEE3 CD EB DE       	CALL	C12S
DEE6 03             	INC	BC
DEE7 20 FA          	JR	NZ,C12X1
DEE9 D1             	POP	DE
DEEA C9             	RET
DEEB                
DEEB                C12S:
DEEB CB E0          	SET	4,B
DEED CB D8          	SET	3,B
DEEF ED 60          	IN	H,(C)
DEF1 ED 59          X1PAT:	OUT	(C),E
DEF3 5C             	LD	E,H
DEF4 CB 98          	RES	3,B
DEF6 ED 60          	IN	H,(C)
DEF8 ED 51          	OUT	(C),D
DEFA 54             	LD	D,H
DEFB CB A0          	RES	4,B
DEFD ED 60          	IN	H,(C)
DEFF ED 69          	OUT	(C),L
DF01 6C             	LD	L,H
DF02 3D             	DEC	A
DF03 C9             	RET
DF04                
DF04                CTRL0C:
DF04 CD 4C DE       	CALL	CTRL0B
DF07                CTRL06:
DF07 ED 4B 8E EF    	LD	BC,(_TXADR)
DF0B                C1AX1:
DF0B 78             	LD	A,B
DF0C F6 38          	OR	038H
DF0E 47             	LD	B,A
DF0F ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DF11 CB 98          	RES	3,B
DF13 3E 20          	LD	A,020H
DF15 ED 79          	OUT	(C),A		;Text
DF17 CB A0          	RES	4,B
DF19 3A 96 EF       	LD	A,(_COLORF)
DF1C ED 79          	OUT	(C),A		;Color
DF1E 03             	INC	BC
DF1F CB A8          	RES	5,B
DF21 2A BA EF       	LD	HL,(_PAGE_MINUS)
DF24 09             	ADD	HL,BC
DF25 30 E4          	JR	NC,C1AX1
DF27 C9             	RET
DF28                
DF28                CTRL04:
DF28 CD D3 EF       	CALL	_POS
DF2B 7D             	LD	A,L
DF2C B7             	OR	A
DF2D C8             	RET	Z
DF2E                CTRL03:
DF2E CD 31 DE       	CALL	CTRL0D
DF31                CTRL0A:
DF31                CTRL1F:
DF31 ED 4B 8E EF    	LD	BC,(_TXADR)
DF35 2A B1 EF       	LD	HL,(_WIDTH)
DF38 26 00          	LD	H,0
DF3A 09             	ADD	HL,BC
DF3B 44             	LD	B,H
DF3C 4D             	LD	C,L
DF3D 2A BA EF       	LD	HL,(_PAGE_MINUS)
DF40 09             	ADD	HL,BC
DF41 3F             	CCF
DF42 9F             	SBC	A,A
DF43 C3 A5 DD       	JP	PRINTE8
DF46                
DF46                CTRL0E:
DF46 CD D3 EF       	CALL	_POS
DF49 7C             	LD	A,H
DF4A 18 04          	JR	SCR1
DF4C                SCR:
DF4C 3A 97 EF       	LD	A,(_LINE)
DF4F 3D             	DEC	A
DF50                SCR1:
DF50 C5             	PUSH	BC
DF51 D5             	PUSH	DE
DF52 F5             	PUSH	AF
DF53 3E 07          	LD	A,7
DF55 21 86 DF       	LD	HL,SCRDMAD
DF58 CD 7C DF       	CALL	SETDMA
DF5B F1             	POP	AF
DF5C 21 00 38       	LD	HL,03800H
DF5F                
DF5F                SCRUP1:
DF5F B7             	OR	A
DF60 28 4D          	JR	Z,SCRCL
DF62 F5             	PUSH	AF
DF63 CD 8D DF       	CALL	UPSUB		;kanji
DF66 3A BC EF       	LD	A,(_WIDTH_MINUS)
DF69 5F             	LD	E,A
DF6A 16 F7          	LD	D,0F7H
DF6C 19             	ADD	HL,DE
DF6D D5             	PUSH	DE
DF6E CD 8D DF       	CALL	UPSUB		;Text
DF71 D1             	POP	DE
DF72 19             	ADD	HL,DE
DF73 CD 8D DF       	CALL	UPSUB		;Color
DF76 CB E4          	SET	4,H
DF78 F1             	POP	AF
DF79 3D             	DEC	A
DF7A 18 E3          	JR	SCRUP1
DF7C                
DF7C                SETDMA:
DF7C 01 87 1F       	LD	BC,01F87H
DF7F                SDMA:
DF7F 04             	INC	B
DF80 ED A3          	OUTI
DF82 3D             	DEC	A
DF83 20 FA          	JR	NZ,SDMA
DF85 C9             	RET
DF86                
DF86                SCRDMAD:
DF86 C3             	DB	0C3H		;WR6 リセット
DF87 9A             	DB	09AH		;WR5 ストップ WAIT READY:HIGH
DF88 65             	DB	065H		;WR0 ブロック長(LH)
DF89 4F 00          	DW	79
DF8B 1C             	DB	01CH		;WR1 ポートAインクリメント I/O
DF8C 18             	DB	018H		;WR0 ポートAアドレス(LH)
DF8D                
DF8D                UPSUB:
DF8D 3A B1 EF       	LD	A,(_WIDTH)
DF90 5F             	LD	E,A
DF91 16 00          	LD	D,0
DF93 3E CD          	LD	A,0CDH		;WR4 バースト ポートB開始アドレス(LH)
DF95 ED 79          	OUT	(C),A
DF97 ED 69          	OUT	(C),L		;SOURCE
DF99 ED 61          	OUT	(C),H
DF9B 19             	ADD	HL,DE
DF9C 3E 1D          	LD	A,01DH		;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
DF9E ED 79          	OUT	(C),A
DFA0 ED 69          	OUT	(C),L		;DEST
DFA2 ED 61          	OUT	(C),H
DFA4                GO_DMA:
DFA4 3E CF          	LD	A,0CFH
DFA6 ED 79          	OUT	(C),A		;WR6 ロード
DFA8 3E B3          	LD	A,0B3H
DFAA ED 79          	OUT	(C),A		;WR6 強制RDY
DFAC ED 49          	OUT	(C),C		;WR6 イネーブル
DFAE C9             	RET
DFAF                
DFAF                SCRCL:
DFAF 44             	LD	B,H
DFB0 4D             	LD	C,L
DFB1 2A B1 EF       	LD	HL,(_WIDTH)
DFB4 CD 17 DE       	CALL	LINECL
DFB7 D1             	POP	DE
DFB8 C1             	POP	BC
DFB9 C9             	RET
DFBA                
DFBA                SCRN:
DFBA D5             	PUSH	DE
DFBB ED 58          	IN	E,(C)		;Text
DFBD 3A 18 00       	LD	A,(00018H)
DFC0 3C             	INC	A
DFC1 28 1E          	JR	Z,SCRN2
DFC3 CB D8          	SET	3,B
DFC5 ED 50          	IN	D,(C)		;Kanji
DFC7 28 16          	JR	Z,SCRN1
DFC9 AF             	XOR	A
DFCA C5             	PUSH	BC
DFCB 01 37 30       	LD	BC,03037H	;VRMJIS
DFCE DF             	RST	018H
DFCF 01 52 2F       	LD	BC,02F52H	;JISSFT
DFD2 DF             	RST	018H
DFD3 C1             	POP	BC
DFD4 ED 78          	IN	A,(C)
DFD6 CB 98          	RES	3,B
DFD8 E6 40          	AND	040H
DFDA 20 05          	JR	NZ,SCRN2
DFDC 7A             	LD	A,D
DFDD D1             	POP	DE
DFDE C9             	RET
DFDF                SCRN1:
DFDF CB 98          	RES	3,B
DFE1                SCRN2:
DFE1 7B             	LD	A,E
DFE2 D1             	POP	DE
DFE3 C9             	RET
DFE4                SCRNE:
DFE4                POS:
DFE4 2A 8E EF       	LD	HL,(_TXADR)
DFE7 C5             	PUSH	BC
DFE8 ED 4B BC EF    	LD	BC,(_WIDTH_MINUS)
DFEC AF             	XOR	A
DFED                POS1:
DFED 09             	ADD	HL,BC
DFEE 3C             	INC	A
DFEF 38 FC          	JR	C,POS1
DFF1 ED 42          	SBC	HL,BC
DFF3 3D             	DEC	A
DFF4 67             	LD	H,A
DFF5 C1             	POP	BC
DFF6 A7             	AND	A
DFF7 C9             	RET
DFF8                
DFF8                GETL:
DFF8 CD D3 EF       	CALL	_POS
DFFB E5             	PUSH	HL
DFFC 3E CD          	LD	A,0CDH		;CALL ????
DFFE 32 00 DD       	LD	(INSFLG),A
E001                GETL1:
E001 CD B9 DB       	CALL	_SYS08
E004 FE 09          	CP	9
E006 20 08          	JR	NZ,GETL1V
E008 21 00 FF       	LD	HL,KBUF
E00B CD 0D D8       	CALL	MSX
E00E 18 F1          	JR	GETL1
E010                GETL1V:
E010 5F             	LD	E,A
E011 CD CD EF       	CALL	_PRINT
E014                
E014 7B             	LD	A,E
E015 FE 0D          	CP	00DH
E017 20 E8          	JR	NZ,GETL1
E019 3E 01          	LD	A,1		;LD BC,????
E01B 32 00 DD       	LD	(INSFLG),A
E01E 11 00 FF       	LD	DE,KBUF
E021 3A B1 EF       	LD	A,(_WIDTH)
E024 47             	LD	B,A
E025 CD E8 D4       	CALL	ZERO_MEMORY_DE
E028                
E028 D1             	POP	DE
E029 CD D3 EF       	CALL	_POS
E02C 6B             	LD	L,E
E02D 3A B1 EF       	LD	A,(_WIDTH)
E030 95             	SUB	L
E031 57             	LD	D,A
E032 CD 59 DE       	CALL	LOC1
E035 4D             	LD	C,L
E036 7C             	LD	A,H
E037 F6 30          	OR	030H
E039 47             	LD	B,A
E03A 5A             	LD	E,D
E03B 21 00 FF       	LD	HL,KBUF
E03E                GETL2:
E03E CD D0 EF       	CALL	_SCRN
E041 03             	INC	BC
E042 77             	LD	(HL),A
E043 23             	INC	HL
E044 1D             	DEC	E
E045 20 F7          	JR	NZ,GETL2
E047                GETL3:
E047 2B             	DEC	HL
E048 7E             	LD	A,(HL)
E049 FE 21          	CP	021H
E04B D0             	RET	NC
E04C 36 00          	LD	(HL),0
E04E 15             	DEC	D
E04F 20 F6          	JR	NZ,GETL3
E051 C9             	RET
E052                
E052                INKEY:
E052 FB             	EI
E053 E5             	PUSH	HL
E054 2A 90 EF       	LD	HL,(_KEYPS)
E057 7C             	LD	A,H
E058 AD             	XOR	L
E059 28 09          	JR	Z,INKEY1
E05B 7C             	LD	A,H
E05C 3C             	INC	A
E05D 32 91 EF       	LD	(_KEYPS+1),A
E060 6F             	LD	L,A
E061 26 FE          	LD	H,KEYBF/256
E063 7E             	LD	A,(HL)
E064                INKEY1:
E064 E1             	POP	HL
E065 B7             	OR	A
E066 C9             	RET
E067                
E067 00 00 10 59    AT_RS	EQU	SCR1-AT_SCR1
E067                	INCLUDE	"LDFILE.ASM"
E067                
E067                ;	LSX-Dodgers FILE
E067                
E067                FILEC:
E067 CD 72 E0       	CALL	FILE
E06A                FILEC2:
E06A 3A 15 EF       	LD	A,(FDRV+1)
E06D FE 20          	CP	020H
E06F C8             	RET	Z
E070 18 39          	JR	SETDIR1
E072                
E072                FILE:
E072 AF             	XOR	A
E073 32 14 EF       	LD	(FDRV),A
E076 67             	LD	H,A
E077 6F             	LD	L,A
E078 22 22 EF       	LD	(FDRV+14),HL
E07B CD 49 E1       	CALL	SPCUT
E07E CD 2E E1       	CALL	CCHK3
E081 28 12          	JR	Z,DEVI1
E083 13             	INC	DE
E084 1A             	LD	A,(DE)
E085 1B             	DEC	DE
E086 FE 3A          	CP	':'
E088 20 0B          	JR	NZ,DEVI1
E08A 1A             	LD	A,(DE)		;DRIVE
E08B CD 7E E3       	CALL	CAP
E08E D6 40          	SUB	'@'
E090 13             	INC	DE
E091 13             	INC	DE
E092 32 14 EF       	LD	(FDRV),A
E095                DEVI1:
E095 1A             	LD	A,(DE)
E096 D6 5C          	SUB	05CH		;\
E098 20 09          	JR	NZ,NOROOT
E09A 6F             	LD	L,A		;A=0でH=0のはずなのでHL=0
E09B 22 2E EF       	LD	(FDRV+26),HL
E09E 2C             	INC	L
E09F 22 22 EF       	LD	(FDRV+14),HL
E0A2 13             	INC	DE
E0A3                NOROOT:
E0A3                
E0A3                SETDIR:
E0A3 CD CF E0       	CALL	FILED
E0A6 1A             	LD	A,(DE)
E0A7 FE 5C          	CP	05CH		;\
E0A9 C0             	RET	NZ
E0AA 13             	INC	DE
E0AB                SETDIR1:
E0AB 3E 10          	LD	A,010H		;Directory
E0AD 32 21 EF       	LD	(FDRV+13),A
E0B0 D5             	PUSH	DE
E0B1 11 14 EF       	LD	DE,FDRV
E0B4 2A 1E F0       	LD	HL,(STABLE+2*00FH)
E0B7 CD 0F 00       	CALL	JP_HL
E0BA D1             	POP	DE
E0BB B7             	OR	A
E0BC C0             	RET	NZ
E0BD                
E0BD 3A 21 EF       	LD	A,(FDRV+13)
E0C0 CB 67          	BIT	4,A
E0C2 C8             	RET	Z
E0C3                
E0C3 CD 16 E1       	CALL	FILEI
E0C6 2A 2E EF       	LD	HL,(FDRV+26)
E0C9 23             	INC	HL
E0CA 22 22 EF       	LD	(FDRV+14),HL
E0CD 18 D4          	JR	SETDIR
E0CF                
E0CF                FILED:
E0CF CD 16 E1       	CALL	FILEI
E0D2 21 15 EF       	LD	HL,FNAME
E0D5                
E0D5 06 08          	LD	B,8
E0D7                FILE2:
E0D7 CD 23 E1       	CALL	CCHKF
E0DA C8             	RET	Z
E0DB FE 2A          	CP	'*'
E0DD 28 2E          	JR	Z,FILE9
E0DF FE 2E          	CP	'.'
E0E1 28 0C          	JR	Z,FILE4
E0E3 77             	LD	(HL),A
E0E4 23             	INC	HL
E0E5 10 F0          	DJNZ	FILE2
E0E7                
E0E7                FILE3:
E0E7 CD 23 E1       	CALL	CCHKF
E0EA C8             	RET	Z
E0EB FE 2E          	CP	'.'
E0ED 20 F8          	JR	NZ,FILE3
E0EF                
E0EF                FILE4:
E0EF 21 1D EF       	LD	HL,FNAME+8
E0F2 06 03          	LD	B,3
E0F4                
E0F4                FILE4L:
E0F4 CD 23 E1       	CALL	CCHKF
E0F7 C8             	RET	Z
E0F8 FE 2E          	CP	'.'
E0FA 20 08          	JR	NZ,FILE12
E0FC 32 15 EF       	LD	(FNAME),A	;Parent directory(..)
E0FF 32 16 EF       	LD	(FNAME+1),A
E102 3E 20          	LD	A,020H
E104                FILE12:
E104 FE 2A          	CP	'*'
E106 28 0A          	JR	Z,FILE10
E108 77             	LD	(HL),A
E109 23             	INC	HL
E10A 10 E8          	DJNZ	FILE4L
E10C C9             	RET
E10D                
E10D                FILE9:				;名前の*処理、名前の残りを?で埋める
E10D CD 12 E1       	CALL	FILE10
E110 18 D5          	JR	FILE3
E112                
E112                FILE10:
E112 3E 3F          	LD	A,'?'
E114 18 08          	JR	FILL_MEMORY
E116                FILEI:				;名前＋拡張子をスペースで初期化
E116 3E 20          	LD	A,020H
E118 01 00 0B       	LD	BC,11*256	;C=0にしておく
E11B 21 15 EF       	LD	HL,FNAME
E11E                FILL_MEMORY:			;HLからBバイトAで埋める
E11E 77             	LD	(HL),A
E11F 23             	INC	HL
E120 10 FC          	DJNZ	FILL_MEMORY
E122 C9             	RET
E123                
E123                CCHKF:
E123 1A             	LD	A,(DE)
E124 CD 2B E1       	CALL	CCHK2
E127 C8             	RET	Z
E128 C3 96 E4       	JP	FKAN
E12B                
E12B                CCHK2:
E12B 0C             	INC	C
E12C 0D             	DEC	C
E12D C0             	RET	NZ
E12E                CCHK3:				;ZF=1 で使えない文字
E12E FE 2B          	CP	'+'
E130 C8             	RET	Z
E131 FE 2C          	CP	','
E133 C8             	RET	Z
E134 FE 2F          	CP	'/'
E136 C8             	RET	Z
E137 FE 3A          	CP	':'
E139 C8             	RET	Z
E13A FE 3B          	CP	';'
E13C C8             	RET	Z
E13D FE 3D          	CP	'='
E13F C8             	RET	Z
E140 FE 5C          	CP	05CH	;\
E142 C8             	RET	Z
E143 FE 20          	CP	020H
E145 D0             	RET	NC
E146 BF             	CP	A		;Z=1
E147 C9             	RET
E148                
E148                SS1:
E148 13             	INC	DE
E149                SPCUT:				;スペースをカット
E149 1A             	LD	A,(DE)
E14A FE 20          	CP	020H
E14C 28 FA          	JR	Z,SS1
E14E C9             	RET
E14F                
E14F                SETDRVF:
E14F 11 14 EF       	LD	DE,FDRV
E152                SETDRV0:
E152 CD 5B E1       	CALL	SETDRV
E155 FD E1          	POP	IY
E157 C1             	POP	BC
E158 D1             	POP	DE
E159 E1             	POP	HL
E15A C9             	RET
E15B                
E15B                SETDRV:
E15B E3             	EX	(SP),HL		;HL=RETRN ADDRESS
E15C D5             	PUSH	DE		;PUSH HL/DE/BC/IY
E15D C5             	PUSH	BC
E15E 1A             	LD	A,(DE)
E15F D5             	PUSH	DE
E160 FD E3          	EX	(SP),IY
E162                
E162 CD 6E E1       	CALL	GETDRV
E165 3C             	INC	A
E166 FD 77 00       	LD	(IY+0),A	;(FCB)ドライブ番号
E169 3D             	DEC	A
E16A CD D9 EF       	CALL	_CHGDRV
E16D                
E16D E9             	JP	(HL)
E16E                
E16E                GETDRV:
E16E E6 7F          	AND	07FH
E170 D6 01          	SUB	001H
E172 30 03          	JR	NC,GETDRV1
E174 3A 87 EF       	LD	A,(_DVSW)	;Current Drive
E177                GETDRV1:
E177 32 88 EF       	LD	(_DRV),A
E17A C9             	RET
E17B                
E17B                SOPENX:
E17B 11 39 EF       	LD	DE,SFILE
E17E 1A             	LD	A,(DE)
E17F FD BE 00       	CP	(IY+0)		;(FCB)ドライブ番号
E182 20 24          	JR	NZ,SOPEN
E184 13             	INC	DE
E185 FD E5          	PUSH	IY
E187 E1             	POP	HL
E188 23             	INC	HL
E189 CD 16 E3       	CALL	CPFILE
E18C 20 1A          	JR	NZ,SOPEN
E18E                
E18E 2A F4 F0       	LD	HL,(SCDIR)
E191 FD 75 0E       	LD	(IY+14),L	;(FCB)アクセスするディレクトリのクラスタ番号+1
E194 FD 74 0F       	LD	(IY+15),H
E197                
E197 2A F8 F0       	LD	HL,(SFNDF)	;Direcroty location and Flags
E19A 22 9F EF       	LD	(_FILEN),HL
E19D                
E19D ED 5B F6 F0    	LD	DE,(SFBPS)
E1A1 21 39 EF       	LD	HL,SFILE
E1A4 36 FF          	LD	(HL),0FFH
E1A6 23             	INC	HL
E1A7 C9             	RET
E1A8                SOPEN:
E1A8 21 BE E2       	LD	HL,FILESE
E1AB                SOPENC:
E1AB 22 E4 E1       	LD	(OPENPAT+1),HL
E1AE                
E1AE CD E2 EF       	CALL	_RDFATX		;Detect Media
E1B1 38 56          	JR	C,RDDERR
E1B3                
E1B3 AF             	XOR	A
E1B4 32 9F EF       	LD	(_FILEN),A
E1B7 CD C3 E3       	CALL	LDDIRX1		;A=0で呼び出す
E1BA 28 18          	JR	Z,SDIRX1
E1BC                
E1BC CD AF E2       	CALL	READ_DIR	;Sub Directory
E1BF 38 08          	JR	C,SDIRX0
E1C1 2A 7E F0       	LD	HL,(_DTBUF)
E1C4 7E             	LD	A,(HL)
E1C5 FE 2E          	CP	'.'
E1C7 28 0F          	JR	Z,SOPEN1
E1C9                SDIRX0:
E1C9 AF             	XOR	A
E1CA 32 A0 EF       	LD	(_DIRF),A
E1CD FD 36 0E 01    	LD	(IY+14),1	;(FCB)レコードサイズ
E1D1 FD 77 0F       	LD	(IY+15),A
E1D4                SDIRX1:
E1D4 ED 5B FC F0    	LD	DE,(_DIRPS)	;Root Directory
E1D8                SOPEN1:
E1D8 0E 20          SDECPAT:LD	C,32		;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
E1DA                SOPEN1X:
E1DA CD AF E2       	CALL	READ_DIR	;FILE SEARCH
E1DD 38 2A          	JR	C,RDDERR
E1DF 2A 7E F0       	LD	HL,(_DTBUF)
E1E2                SOPEN2:
E1E2 D5             	PUSH	DE
E1E3 CD BE E2       OPENPAT:CALL	FILESE		;(self-modifying code)
E1E6 D1             	POP	DE
E1E7 38 6E          	JR	C,SOPENE
E1E9 28 1B          	JR	Z,SCF_FF_RET
E1EB                SOPEN3:
E1EB 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E1EE B7             	OR	A
E1EF 20 0C          	JR	NZ,SOPEN5
E1F1 13             	INC	DE		;ルートディレクトリ
E1F2 E5             	PUSH	HL
E1F3 21 0C 00       MD_PAT:	LD	HL,12		;(self-modifying code)MAXDIR
E1F6 ED 52          	SBC	HL,DE		;CF=0 なので SUB HL,DE
E1F8 E1             	POP	HL
E1F9 20 DD          	JR	NZ,SOPEN1
E1FB 18 07          	JR	SOPEN6
E1FD                SOPEN5:
E1FD CD C8 EA       	CALL	GNCLX		;END DIR
E200 D8             	RET	C
E201 CD 76 E3       	CALL	ENDCL
E204                SOPEN6:
E204 38 D2          	JR	C,SOPEN1
E206                SCF_FF_RET:
E206 37             	SCF			;CF=1
E207 9F             	SBC	A,A		;A=0FFH
E208 C9             	RET
E209                
E209                RDDERR:
E209 BF             	CP	A		;READ ERR CF=1 ZF=1
E20A 37             	SCF
E20B C9             	RET
E20C                
E20C                NOPEN:
E20C 21 BE E2       	LD	HL,FILESE
E20F 22 E4 E1       	LD	(OPENPAT+1),HL
E212 FD 2A 98 EF    	LD	IY,(_FCB)
E216 CD A9 E4       	CALL	CHKWILDX
E219 30 EB          	JR	NC,SCF_FF_RET
E21B FD 7E 00       	LD	A,(IY+0)	;(FCB)ドライブ番号
E21E 3D             	DEC	A
E21F 32 88 EF       	LD	(_DRV),A
E222 CD D9 EF       	CALL	_CHGDRV
E225 D8             	RET	C
E226 2A F8 F0       	LD	HL,(SFNDF)	;Direcroty location and Flags
E229 22 9F EF       	LD	(_FILEN),HL
E22C                
E22C CD BE E3       	CALL	LDDIRX
E22F ED 5B 9A EF    	LD	DE,(_FBPS)
E233 CD AF E2       	CALL	READ_DIR
E236 38 D1          	JR	C,RDDERR
E238 3A 9E EF       	LD	A,(_FBCNT)
E23B 3D             	DEC	A
E23C 28 AD          	JR	Z,SOPEN3
E23E                NOPEN2:
E23E 2A 9C EF       	LD	HL,(_FBAD)
E241 01 20 00       	LD	BC,020H
E244 09             	ADD	HL,BC
E245 4F             	LD	C,A
E246 18 9A          	JR	SOPEN2
E248                
E248                SOPENE2:
E248 22 9C EF       	LD	(_FBAD),HL
E24B 79             	LD	A,C
E24C 32 9E EF       	LD	(_FBCNT),A
E24F ED 53 9A EF    	LD	(_FBPS),DE
E253 FD 22 98 EF    	LD	(_FCB),IY
E257                SOPENE:
E257 AF             	XOR	A
E258 C9             	RET
E259                
E259                COPEN:
E259 FD 36 0D 20    	LD	(IY+13),020H	;(FCB)属性(アトリビュート)
E25D                
E25D 21 DB E2       	LD	HL,NEXTSE
E260 CD AB E1       	CALL	SOPENC
E263 D0             	RET	NC
E264 C8             	RET	Z
E265 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E268 B7             	OR	A
E269 37             	SCF
E26A C8             	RET	Z		;ルートディレクトリ
E26B 06 01          	LD	B,1
E26D CD 07 E5       	CALL	WRDF
E270 D8             	RET	C
E271 ED 5B FE F0    	LD	DE,(_CLPS)
E275 D5             	PUSH	DE
E276 CD 3F E3       	CALL	DCPAT
E279 CD 53 E9       	CALL	DRDNX
E27C 2A 7E F0       	LD	HL,(_DTBUF)	;ディレクトリエントリを0クリア
E27F 3A 47 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E282 47             	LD	B,A
E283 AF             	XOR	A
E284 4F             	LD	C,A
E285                COPENCL:
E285 77             	LD	(HL),A
E286 ED A1          	CPI			;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
E288 EA 85 E2       	JP	PE,COPENCL
E28B                
E28B 3A 5D E3       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ数
E28E 3D             	DEC	A
E28F 28 19          	JR	Z,COPENE
E291 3E 01          	LD	A,1		;1セクタ辺りのセクタ数が2以上の場合
E293 32 C0 EA       	LD	(_SECPS+1),A
E296 D1             	POP	DE		;DE=(_CLPS)
E297 D5             	PUSH	DE
E298                COPEN1:
E298 D5             	PUSH	DE		;データバッファに入らないセクタもゼロクリア
E299 C5             	PUSH	BC
E29A 2A 7E F0       	LD	HL,(_DTBUF)
E29D CD 59 E3       	CALL	CLUSTX
E2A0 CD 2C EC       	CALL	DWT24
E2A3 C1             	POP	BC
E2A4 D1             	POP	DE
E2A5 CD BF EA       	CALL	NEXTX
E2A8 20 EE          	JR	NZ,COPEN1
E2AA                COPENE:
E2AA 2A 7E F0       	LD	HL,(_DTBUF)
E2AD D1             	POP	DE
E2AE C9             	RET
E2AF                
E2AF                READ_DIR:
E2AF ED 53 FE F0    	LD	(_CLPS),DE
E2B3 C5             	PUSH	BC
E2B4 D5             	PUSH	DE
E2B5 CD 3F E3       	CALL	DCPAT
E2B8 CD 33 E9       	CALL	DRDX
E2BB D1             	POP	DE
E2BC C1             	POP	BC
E2BD C9             	RET
E2BE                
E2BE                FILESE:
E2BE 7E             	LD	A,(HL)
E2BF B7             	OR	A
E2C0 C8             	RET	Z		;END:ZF=1 CF=0
E2C1 FE E5          	CP	0E5H
E2C3 28 0E          	JR	Z,FILESE1
E2C5 FD E5          	PUSH	IY
E2C7 D1             	POP	DE
E2C8 13             	INC	DE
E2C9 E5             	PUSH	HL
E2CA CD 16 E3       	CALL	CPFILE
E2CD CC 37 E3       	CALL	Z,CPFILE2
E2D0 E1             	POP	HL
E2D1 37             	SCF
E2D2 C8             	RET	Z		;!!!:(ZF=1) CF=1
E2D3                FILESE1:
E2D3 CD EA E2       	CALL	FNEXT
E2D6 20 E6          	JR	NZ,FILESE
E2D8                ZF0_CF0_AFF_RET:
E2D8 F6 FF          	OR	0FFH		;ZF=0 CF=0
E2DA C9             	RET
E2DB                
E2DB                NEXTSE:
E2DB 7E             	LD	A,(HL)
E2DC B7             	OR	A
E2DD 37             	SCF
E2DE C8             	RET	Z		;!!!:ZF=1 CF=1
E2DF FE E5          	CP	0E5H
E2E1 37             	SCF
E2E2 C8             	RET	Z		;!!!:(ZF=1) CF=1
E2E3 CD EA E2       	CALL	FNEXT
E2E6 20 F3          	JR	NZ,NEXTSE
E2E8 18 EE          	JR	ZF0_CF0_AFF_RET
E2EA                
E2EA                FNEXT:
E2EA E5             	PUSH	HL
E2EB 21 9F EF       	LD	HL,_FILEN
E2EE 34             	INC	(HL)
E2EF E1             	POP	HL
E2F0 11 20 00       	LD	DE,020H
E2F3 19             	ADD	HL,DE
E2F4 0D             	DEC	C
E2F5 C9             	RET
E2F6                
E2F6                CPNAME:
E2F6 C5             	PUSH	BC
E2F7 D5             	PUSH	DE
E2F8 E5             	PUSH	HL
E2F9 CD 10 E3       	CALL	CPFILE4
E2FC E1             	POP	HL
E2FD 23             	INC	HL
E2FE 23             	INC	HL
E2FF 23             	INC	HL
E300 23             	INC	HL
E301 D1             	POP	DE
E302 C1             	POP	BC
E303 20 05          	JR	NZ,CPNAME1
E305 7E             	LD	A,(HL)
E306 23             	INC	HL
E307 66             	LD	H,(HL)
E308 6F             	LD	L,A
E309 C9             	RET
E30A                CPNAME1:
E30A 23             	INC	HL
E30B 23             	INC	HL
E30C 10 E8          	DJNZ	CPNAME
E30E 37             	SCF
E30F C9             	RET
E310                
E310                CPFILE4:
E310 C5             	PUSH	BC
E311 01 00 04       	LD	BC,00400H
E314 18 04          	JR	CPSTR1
E316                CPFILE:
E316 C5             	PUSH	BC
E317 01 00 0B       	LD	BC,00B00H
E31A                CPSTR1:
E31A 1A             	LD	A,(DE)
E31B FE 3F          	CP	'?'		;Wild card
E31D 28 12          	JR	Z,CPSTR2
E31F 7E             	LD	A,(HL)
E320 CD 8F E4       	CALL	FKANC
E323 E5             	PUSH	HL
E324 67             	LD	H,A
E325 1A             	LD	A,(DE)
E326 CB 01          	RLC	C
E328 CD 8F E4       	CALL	FKANC
E32B CB 09          	RRC	C
E32D BC             	CP	H		;CP (HL),(DE)
E32E E1             	POP	HL
E32F 20 04          	JR	NZ,CPSTR3
E331                CPSTR2:
E331 13             	INC	DE
E332 23             	INC	HL
E333 10 E5          	DJNZ	CPSTR1
E335                CPSTR3:
E335 C1             	POP	BC
E336 C9             	RET
E337                
E337                CPFILE2:
E337 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E33A F6 E1          	OR	0E1H
E33C 2F             	CPL
E33D A6             	AND	(HL)
E33E C9             	RET
E33F                
E33F                DCPAT:
E33F 0E 00          	LD	C,0
E341 2A 7E F0       	LD	HL,(_DTBUF)
E344 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E347 B7             	OR	A
E348 C8             	RET	Z		;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
E349 3A 5D E3       	LD	A,(SPCPAT+1)
E34C 4F             	LD	C,A
E34D 3A C0 EA       	LD	A,(_SECPS+1)
E350 B9             	CP	C
E351 38 01          	JR	C,DC1
E353 AF             	XOR	A
E354                DC1:
E354 F6 80          	OR	080H
E356 32 A0 EF       	LD	(_DIRF),A	;bit0-6:セクタインデックス
E359                CLUSTX:
E359 E5             	PUSH	HL
E35A EB             	EX	DE,HL
E35B AF             	XOR	A
E35C 0E 01          SPCPAT:	LD	C,1		;自己書き換え（1クラスタの論理セクタ数）
E35E                L_CLDBL:
E35E CB 19          	RR	C		;->CF
E360 38 04          	JR	C,E_CLDBL
E362 29             	ADD	HL,HL		;*2
E363 8F             	ADC	A,A
E364 18 F8          	JR	L_CLDBL
E366                E_CLDBL:
E366 4F             	LD	C,A
E367 3A C0 EA       	LD	A,(_SECPS+1)
E36A B5             	OR	L
E36B 6F             	LD	L,A
E36C 11 08 00       CLSPAT:	LD	DE,8	;+8 (2D)  !ADDCL (self-modifying code)
E36F AF             	XOR	A
E370 19             	ADD	HL,DE	;データ格納領域の先頭論理セクタ番号
E371 89             	ADC	A,C
E372 4F             	LD	C,A
E373 EB             	EX	DE,HL
E374 E1             	POP	HL
E375 C9             	RET
E376                
E376                ENDCL:
E376 7A             	LD	A,D	;END CLUSTER
E377 FE 01          CLPAT1:	CP	1	;164=356	(self-modifying code)
E379 C0             	RET	NZ
E37A 7B             	LD	A,E
E37B FE 64          CLPAT2:	CP	064H	;		(self-modifying code)
E37D C9             	RET
E37E                
E37E                CAP:
E37E FE 61          	CP	'a'
E380 D8             	RET	C
E381 FE 7B          	CP	'z'+1
E383 D0             	RET	NC
E384 D6 20          	SUB	020H
E386 C9             	RET
E387                CAP2:
E387 CD 7E E3       	CALL	CAP
E38A                CAP3:
E38A CD 93 E3       	CALL	CAP4
E38D FE 21          	CP	021H
E38F D0             	RET	NC
E390 3E A0          	LD	A,0A0H
E392 C9             	RET
E393                CAP4:
E393 FE 05          	CP	5
E395 C0             	RET	NZ
E396 3E E5          	LD	A,0E5H
E398 C9             	RET
E399                
E399                CHDIR:
E399 CD 5B ED       	CALL	GETDPBD
E39C 38 1D          	JR	C,CHDIR2
E39E DD 75 1A       	LD	(IX+01AH),L		;_SDIR_
E3A1 DD 74 1B       	LD	(IX+01BH),H		;_SDIR_+1
E3A4 18 15          	JR	CHDIR2		;POP_IX_RET
E3A6                
E3A6                LDDIR:
E3A6 CD 5B ED       	CALL	GETDPBD
E3A9 DD 5E 1A       	LD	E,(IX+01AH)		;_SDIR_
E3AC DD 56 1B       	LD	D,(IX+01BH)		;_SDIR_+1
E3AF 13             	INC	DE
E3B0 FD 73 0E       	LD	(IY+14),E	;(FCB)アクセスするディレクトリのクラスタ番号+1
E3B3 FD 72 0F       	LD	(IY+15),D
E3B6 1B             	DEC	DE
E3B7 AF             	XOR	A
E3B8 32 A0 EF       	LD	(_DIRF),A
E3BB                CHDIR2:
E3BB DD E1          	POP	IX
E3BD C9             	RET
E3BE                
E3BE                LDDIRX:
E3BE 3A A0 EF       	LD	A,(_DIRF)	;(FCB)アクセスするディレクトリのセクタインデックス
E3C1 E6 7F          	AND	07FH
E3C3                LDDIRX1:
E3C3 32 C0 EA       	LD	(_SECPS+1),A
E3C6 FD 5E 0E       	LD	E,(IY+14)	;(FCB)アクセスするディレクトリのクラスタ番号+1
E3C9 FD 56 0F       	LD	D,(IY+15)
E3CC 1B             	DEC	DE
E3CD CD 76 E3       	CALL	ENDCL
E3D0 D4 A6 E3       	CALL	NC,LDDIR
E3D3                LDDIRS:
E3D3 7A             	LD	A,D
E3D4 B3             	OR	E
E3D5 32 A0 EF       	LD	(_DIRF),A	;ディレクトリか判別
E3D8 C9             	RET
E3D9                
E3D9                KILL:
E3D9 CD A9 E4       	CALL	CHKWILDX
E3DC 38 34          	JR	C,KILLW
E3DE CD 7B E1       	CALL	SOPENX
E3E1                KILLS:
E3E1 3E 1F          	LD	A,01FH
E3E3 D4 25 E4       	CALL	NC,CHKATT
E3E6 D8             	RET	C
E3E7                KILLSX:
E3E7 36 E5          	LD	(HL),0E5H	;DIR
E3E9 CD 83 E4       	CALL	WTDB
E3EC 11 1A 00       	LD	DE,01AH
E3EF 19             	ADD	HL,DE
E3F0 5E             	LD	E,(HL)
E3F1 23             	INC	HL
E3F2 56             	LD	D,(HL)
E3F3                KILLS1:
E3F3 CD 76 E3       	CALL	ENDCL
E3F6 D0             	RET	NC		;CF=0
E3F7 21 FE FF       	LD	HL,0-2
E3FA 19             	ADD	HL,DE
E3FB D0             	RET	NC		;DE= 0 or 1
E3FC D5             	PUSH	DE
E3FD CD F7 EF       	CALL	_GNCL
E400 ED 53 FE F0    	LD	(_CLPS),DE
E404 D1             	POP	DE
E405 21 00 00       	LD	HL,0
E408 D4 FA EF       	CALL	NC,_SNCL
E40B D8             	RET	C
E40C ED 5B FE F0    	LD	DE,(_CLPS)	;FAT
E410 18 E1          	JR	KILLS1
E412                
E412                KILLW:
E412 CD A8 E1       	CALL	SOPEN
E415                KILLW1:
E415 38 0B          	JR	C,KILLW2
E417 CD 48 E2       	CALL	SOPENE2
E41A CD E1 E3       	CALL	KILLS
E41D CD 0C E2       	CALL	NOPEN
E420 18 F3          	JR	KILLW1
E422                KILLW2:
E422 C8             	RET	Z
E423 3F             	CCF
E424 C9             	RET
E425                
E425                CHKATT:
E425 E5             	PUSH	HL
E426 11 0B 00       	LD	DE,00BH
E429 19             	ADD	HL,DE
E42A A6             	AND	(HL)
E42B E1             	POP	HL
E42C C8             	RET	Z
E42D 37             	SCF
E42E C9             	RET
E42F                
E42F                NAME:
E42F CD A9 E4       	CALL	CHKWILDX
E432 D8             	RET	C
E433 11 04 00       	LD	DE,4
E436 19             	ADD	HL,DE
E437 22 4F E4       	LD	(NAMEP+2),HL
E43A 23             	INC	HL
E43B CD AD E4       	CALL	CHKWILD
E43E D8             	RET	C
E43F                
E43F CD 7B E1       	CALL	SOPENX
E442 3E 0F          	LD	A,00FH
E444 D4 25 E4       	CALL	NC,CHKATT
E447 D8             	RET	C
E448                
E448 FD 7E 00       	LD	A,(IY+0)
E44B FD E5          	PUSH	IY
E44D FD 21 00 00    NAMEP:	LD	IY,0		;自己書き換え
E451 FD 77 00       	LD	(IY+0),A
E454 CD 7B E1       	CALL	SOPENX
E457 FD E3          	EX	(SP),IY
E459 3F             	CCF
E45A D4 A8 E1       	CALL	NC,SOPEN
E45D EB             	EX	DE,HL
E45E E1             	POP	HL
E45F D8             	RET	C
E460                
E460                SETNAME:
E460 01 00 0B       	LD	BC,11*256
E463 23             	INC	HL
E464 7E             	LD	A,(HL)
E465 FE E5          	CP	0E5H
E467 20 04          	JR	NZ,SNAME1
E469 3E 05          	LD	A,5
E46B 18 0E          	JR	SNAME3
E46D                SNAME1:
E46D 7E             	LD	A,(HL)
E46E 0C             	INC	C
E46F 0D             	DEC	C
E470 20 09          	JR	NZ,SNAME3
E472 CD 7E E3       	CALL	CAP
E475 FE A0          	CP	0A0H
E477 20 02          	JR	NZ,SNAME3
E479 3E 20          	LD	A,020H
E47B                SNAME3:
E47B 12             	LD	(DE),A
E47C 7E             	LD	A,(HL)
E47D 23             	INC	HL
E47E CD 96 E4       	CALL	FKAN
E481 10 EA          	DJNZ	SNAME1
E483                WTDB:
E483 3E FF          	LD	A,0FFH
E485 32 39 EF       	LD	(SFILE),A
E488                SWTDBF:
E488 3E 01          	LD	A,1
E48A 32 A4 EF       	LD	(_WTDBF),A
E48D AF             	XOR	A
E48E C9             	RET
E48F                
E48F                FKANC:
E48F CB 41          	BIT	0,C
E491 CC 87 E3       	CALL	Z,CAP2
E494 18 01          	JR	FKANX
E496                FKAN:			;漢字チェック
E496 13             	INC	DE
E497                FKANX:
E497 CB 41          	BIT	0,C
E499 CB 81          	RES	0,C
E49B C0             	RET	NZ
E49C FE 80          	CP	080H
E49E D8             	RET	C
E49F FE A0          	CP	0A0H
E4A1 38 03          	JR	C,FKAN1
E4A3 FE E0          	CP	0E0H
E4A5 D8             	RET	C
E4A6                FKAN1:
E4A6 0C             	INC	C
E4A7 A7             	AND	A
E4A8 C9             	RET
E4A9                
E4A9                CHKWILDX:
E4A9 FD E5          	PUSH	IY
E4AB E1             	POP	HL
E4AC 23             	INC	HL
E4AD                CHKWILD:
E4AD 06 0B          	LD	B,11
E4AF 3E 3F          	LD	A,'?'
E4B1                CHKWIL1:
E4B1 BE             	CP	(HL)
E4B2 23             	INC	HL
E4B3 37             	SCF
E4B4 C8             	RET	Z
E4B5 10 FA          	DJNZ	CHKWIL1
E4B7 AF             	XOR	A
E4B8 C9             	RET
E4B9                
E4B9                SDIRENT:		;IY=FCB HL=DIR
E4B9 D5             	PUSH	DE
E4BA E5             	PUSH	HL
E4BB FD E5          	PUSH	IY
E4BD D1             	POP	DE
E4BE EB             	EX	DE,HL
E4BF CD 60 E4       	CALL	SETNAME
E4C2                ;				Attribute
E4C2 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E4C5 12             	LD	(DE),A
E4C6 13             	INC	DE
E4C7                ;				Reserved
E4C7 AF             	XOR	A
E4C8 06 0A          	LD	B,10
E4CA                SDE1:
E4CA 12             	LD	(DE),A
E4CB 13             	INC	DE
E4CC 10 FC          	DJNZ	SDE1
E4CE                					;(FCB)更新時刻
E4CE 21 EA F0       	LD	HL,SDDATA		;(FCB)更新年月日
E4D1 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
E4D3                SDLOOP:					;(FCB)ファイルのサイズ(バイト単位)
E4D3 7E             	LD	A,(HL)
E4D4 23             	INC	HL
E4D5 32 DA E4       	LD	(SDPAT+2),A
E4D8 FD 7E 00       SDPAT:	LD	A,(IY+0)	;LD A,(IY+A)
E4DB 12             	LD	(DE),A
E4DC 13             	INC	DE
E4DD 10 F4          	DJNZ	SDLOOP
E4DF                
E4DF AF             	XOR	A
E4E0 E1             	POP	HL
E4E1 D1             	POP	DE
E4E2 C9             	RET
E4E3                
E4E3                WOPEN:
E4E3 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E4E6 E6 1F          	AND	01FH
E4E8 37             	SCF
E4E9 C0             	RET	NZ
E4EA FD 36 1C FE    	LD	(IY+28),0FEH	;(FCB)オープンモード
E4EE                TOPEN2:
E4EE AF             	XOR	A
E4EF                TOPEN:				;Initializes the time stamp
E4EF FD 36 17 FF    	LD	(IY+23),0FFH	;(FCB)更新時刻
E4F3 C9             	RET
E4F4                
E4F4                WRDFX:
E4F4 3A 5D E3       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ
E4F7                L_WRFX:
E4F7 1F             	RRA			;->CF
E4F8 38 06          	JR	C,E_WRFX
E4FA CB 39          	SRL	C
E4FC CB 1C          	RR	H		;CH=CH/2
E4FE 18 F7          	JR	L_WRFX
E500                E_WRFX:
E500 44             	LD	B,H
E501 04             	INC	B
E502 3E 37          	LD	A,037H		;SCF
E504 32 50 E9       	LD	(DRDN1),A
E507                
E507                WRDF:				;Bクラスタ分FATを確保する
E507 11 02 00       	LD	DE,2
E50A AF             	XOR	A
E50B 32 C0 EA       	LD	(_SECPS+1),A
E50E                WRDF1:
E50E C5             	PUSH	BC
E50F D5             	PUSH	DE
E510 CD F7 EF       	CALL	_GNCL
E513 38 1C          	JR	C,WRDF3
E515 7A             	LD	A,D		;空いているかチェック
E516 B3             	OR	E
E517 20 27          	JR	NZ,WRDF4
E519 E1             	POP	HL		;HL=空いているクラスタ
E51A E5             	PUSH	HL
E51B ED 5B FE F0    	LD	DE,(_CLPS)	;DE=元の(_CLPS)
E51F 22 FE F0       	LD	(_CLPS),HL
E522 7A             	LD	A,D		;元の(_CLPS)が 0 か?
E523 B3             	OR	E
E524 20 08          	JR	NZ,WRDF2
E526 FD 75 1A       	LD	(IY+26),L	;(FCB)ファイルの先頭クラスタ
E529 FD 74 1B       	LD	(IY+27),H	;元が空の場合はFCBにクラスタをセットする
E52C 18 03          	JR	WRDF3
E52E                WRDF2:
E52E CD FA EF       	CALL	_SNCL
E531                WRDF3:
E531 D1             	POP	DE
E532 C1             	POP	BC
E533 D8             	RET	C
E534 10 0C          	DJNZ	WRDF5		;ここでループカウンタチェック
E536 ED 5B FE F0    	LD	DE,(_CLPS)
E53A 21 FF FF       	LD	HL,0FFFFH	;FATエントリ終了(EOCマーク)
E53D C3 FA EF       	JP	_SNCL
E540                
E540                WRDF4:				;DEクラスタが空じゃないので次に移動する
E540 D1             	POP	DE
E541 C1             	POP	BC
E542                WRDF5:
E542 13             	INC	DE
E543 CD 76 E3       	CALL	ENDCL
E546 38 C6          	JR	C,WRDF1
E548 37             	SCF
E549 C9             	RET
E54A                
E54A                RWXR:
E54A 3A 47 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E54D                L_RWX:
E54D 1F             	RRA		;->CF
E54E 38 08          	JR	C,E_RWX
E550 CB 38          	SRL	B	;BCH=BCH/2
E552 CB 19          	RR	C	;
E554 CB 1C          	RR	H	;
E556 18 F5          	JR	L_RWX
E558                E_RWX:
E558 FD 5E 1A       	LD	E,(IY+26)	;(FCB)ファイルの先頭クラスタ
E55B FD 56 1B       	LD	D,(IY+27)
E55E AF             	XOR	A
E55F 32 C0 EA       	LD	(_SECPS+1),A
E562                RWX1:
E562 ED 53 FE F0    	LD	(_CLPS),DE
E566 7A             	LD	A,D
E567 B3             	OR	E
E568 28 13          	JR	Z,SCF_RET	;RET DE==0 => CF=1
E56A                
E56A 78             	LD	A,B
E56B B1             	OR	C
E56C B4             	OR	H
E56D C8             	RET	Z		;RET BCH==0 => CF=0
E56E                
E56E CD C8 EA       	CALL	GNCLX
E571 D8             	RET	C
E572 7C             	LD	A,H		;
E573 25             	DEC	H		;
E574 B7             	OR	A		;DEC BCH
E575 20 01          	JR	NZ,RWX2		;
E577 0B             	DEC	BC		;
E578                RWX2:
E578 CD 76 E3       	CALL	ENDCL
E57B 38 E5          	JR	C,RWX1
E57D                SCF_RET:
E57D 37             	SCF
E57E C9             	RET
E57F                
E57F                DSKF:
E57F 11 00 00       MAXCLP:	LD	DE,0
E582 2A AC EF       	LD	HL,(_FAKEFREE)
E585 7C             	LD	A,H
E586 B5             	OR	L
E587 28 03          	JR	Z,DSKF1
E589 11 01 00       	LD	DE,1
E58C                DSKF1:
E58C D5             	PUSH	DE
E58D CD F7 EF       	CALL	_GNCL
E590 38 0C          	JR	C,POPSCF
E592 7A             	LD	A,D
E593 B3             	OR	E
E594 20 01          	JR	NZ,DSKF2
E596 23             	INC	HL
E597                DSKF2:
E597 D1             	POP	DE
E598 1B             	DEC	DE
E599 7A             	LD	A,D
E59A B3             	OR	E
E59B 20 EF          	JR	NZ,DSKF1
E59D C9             	RET
E59E                
E59E                POPSCF:
E59E F1             	POP	AF
E59F 37             	SCF
E5A0 C9             	RET
E5A1                
E5A1                SETTMS:
E5A1 FD 7E 17       	LD	A,(IY+23)	;(FCB)ファイルを最後に変更した時刻
E5A4 3C             	INC	A
E5A5 C0             	RET	NZ		;ファイルが更新されていない
E5A6                SETTMSX:			;FCBに日付時刻をセットする
E5A6 CD 57 DC       	CALL	_SYS2C		;(BDOS)時刻の獲得
E5A9                				;H←時  L←分  D←秒
E5A9 CB 25          	SLA	L		;   *2
E5AB CB 25          	SLA	L		;   *4
E5AD 29             	ADD	HL,HL		;*2 *8
E5AE 29             	ADD	HL,HL		;*4 *16
E5AF 29             	ADD	HL,HL		;*8 *32
E5B0 7A             	LD	A,D
E5B1 0F             	RRCA			;bit.0->7->->->0->C
E5B2 E6 1F          	AND	01FH
E5B4 B5             	OR	L
E5B5 FD 77 16       	LD	(IY+22),A	;(FCB)ファイルを最後に変更した時刻
E5B8 FD 74 17       	LD	(IY+23),H
E5BB                
E5BB CD 34 DC       	CALL	_SYS2A		;(BDOS)日付の獲得
E5BE                				;HL←年  D←月  E←日
E5BE 01 44 F8       	LD	BC,0-1980
E5C1 09             	ADD	HL,BC
E5C2 65             	LD	H,L
E5C3                
E5C3 7A             	LD	A,D
E5C4 87             	ADD	A,A		;*2
E5C5 87             	ADD	A,A		;*4
E5C6 87             	ADD	A,A		;*8
E5C7 87             	ADD	A,A		;*16
E5C8 6F             	LD	L,A
E5C9 29             	ADD	HL,HL		;*32
E5CA 7D             	LD	A,L
E5CB B3             	OR	E
E5CC FD 77 14       	LD	(IY+20),A	;(FCB)ファイルを最後に変更した日付
E5CF FD 74 15       	LD	(IY+21),H
E5D2 C9             	RET
E5D3                
E5D3                PUSHRR:
E5D3 CD D9 E5       	CALL	SUBRR
E5D6                POPRR1:
E5D6 ED B0          	LDIR
E5D8 C9             	RET
E5D9                
E5D9                SUBRR:
E5D9 FD E5          	PUSH	IY
E5DB E1             	POP	HL
E5DC 11 21 00       	LD	DE,33
E5DF 19             	ADD	HL,DE
E5E0 11 5A EF       	LD	DE,HLBUF
E5E3 01 03 00       	LD	BC,3
E5E6 C9             	RET
E5E7                
E5E7                SETSEQ:
E5E7 F5             	PUSH	AF		;AHL=Random record
E5E8 C5             	PUSH	BC
E5E9 FD 7E 21       	LD	A,(IY+33)	;(FCB)ランダムレコード
E5EC FD 6E 22       	LD	L,(IY+34)
E5EF FD 66 23       	LD	H,(IY+35)
E5F2 06 00          	LD	B,0
E5F4                
E5F4 CD 08 E6       	CALL	GET_CPM_R_SIZE
E5F7                
E5F7 29             	ADD	HL,HL
E5F8 CB 3D          	SRL	L		;L=L/2
E5FA FD 75 20       	LD	(IY+32),L	;(FCB)カレントレコード
E5FD FD 74 0C       	LD	(IY+12),H	;(FCB)カレントブロック
E600 C1             	POP	BC
E601 F1             	POP	AF
E602                
E602                POPRR:
E602 CD D9 E5       	CALL	SUBRR
E605 EB             	EX	DE,HL
E606 18 CE          	JR	POPRR1
E608                
E608                GET_CPM_R_SIZE:		;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
E608 87             	ADD	A,A		;in BHLA => out AHL
E609 ED 6A          	ADC	HL,HL
E60B CB 18          	RR	B
E60D B7             	OR	A
E60E 78             	LD	A,B		;ここでフラグは変化しない
E60F C8             	RET	Z
E610 2C             	INC	L		;INC AHL
E611 C0             	RET	NZ		;
E612 24             	INC	H		;
E613 C0             	RET	NZ		;
E614 3C             	INC	A		;
E615 C9             	RET
E616                
E616                GETSEQ:
E616 FD 6E 20       	LD	L,(IY+32)	;(FCB)カレントレコード
E619 FD 66 0C       	LD	H,(IY+12)	;(FCB)カレントブロック
E61C AF             	XOR	A
E61D                
E61D CB 25          	SLA	L	;L=L*2
E61F                
E61F CB 3C          	SRL	H	;HL=HL/2
E621 CB 1D          	RR	L	;
E623 C9             	RET
E624                
E624                RB_WRITE:
E624 C5             	PUSH	BC
E625 ED 4B 4C F0    	LD	BC,(STABLE+2*026H)	;(BDOS)ランダムブロック書き込み
E629 18 05          	JR	RBRW
E62B                RB_READ:
E62B C5             	PUSH	BC
E62C ED 4B 4E F0    	LD	BC,(STABLE+2*027H)	;(BDOS)ランダムブロック読み込み
E630                RBRW:
E630 CB 3F          	SRL	A	;AHLA' = HL*128
E632 CB 1C          	RR	H	;AHL=AHL/2
E634 CB 1D          	RR	L	;
E636 3E 00          	LD	A,0
E638 1F             	RRA		;A'HLA
E639 FD 77 21       	LD	(IY+33),A	;(FCB)ランダムレコード
E63C FD 75 22       	LD	(IY+34),L
E63F FD 74 23       	LD	(IY+35),H
E642 FD CB 20 FE    	SET	7,(IY+32)	;(FCB)カレントレコード
E646 21 80 00       	LD	HL,128
E649                
E649 FD E5          	PUSH	IY
E64B D1             	POP	DE
E64C D5             	PUSH	DE
E64D CD 58 E6       	CALL	JP_BC
E650 FD E1          	POP	IY
E652 C1             	POP	BC
E653 FD CB 20 BE    	RES	7,(IY+32)	;(FCB)カレントレコード
E657 C9             	RET
E658                JP_BC:
E658 C5             	PUSH	BC
E659 C9             	RET
E65A                
E65A 00 00 E2 06    _SYS03	EQU	SCF_FF_RET	;(BDOS)外部入力
E65A 00 00 E2 06    _SYS2B	EQU	SCF_FF_RET	;(BDOS)日付の設定
E65A 00 00 E2 06    _SYS2D	EQU	SCF_FF_RET	;(BDOS)時刻の設定
E65A 00 00 E2 06    _SYS39	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの作成
E65A 00 00 E2 06    _SYS3A	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの削除
E65A                
E65A                	INCLUDE	"LDFILE2.ASM"
E65A                
E65A                ;	LSX-Dodgers FILE2
E65A                
E65A                				;Write random block
E65A                _SYS26:		;(BDOS)ランダムブロック書き込み
E65A AF             	XOR	A
E65B 32 50 E9       	LD	(DRDN1),A	;NOP
E65E 22 8A E8       	LD	(LEFT+1),HL	;HL←書き込むレコード数
E661 22 5D EF       	LD	(LEFTX),HL
E664 CD 5B E1       	CALL	SETDRV
E667                
E667 CD E1 E7       	CALL	RBX0
E66A DA 04 E7       	JP	C,RBWERR
E66D CD E3 E4       	CALL	WOPEN
E670 DA 04 E7       	JP	C,RBWERR
E673 7C             	LD	A,H
E674 B5             	OR	L
E675 CA FD E6       	JP	Z,RBW1
E678                
E678 2B             	DEC	HL
E679                
E679 CD B6 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E67C                
E67C 19             	ADD	HL,DE		;BCHL=HL+BCDE
E67D 30 01          	JR	NC,S26X1	;
E67F 03             	INC	BC		;
E680                S26X1:
E680 CD 4A E5       	CALL	RWXR
E683 DC F4 E4       	CALL	C,WRDFX
E686 DA 04 E7       	JP	C,RBWERR
E689                
E689 CD 10 E8       	CALL	RBX2
E68C 28 1A          	JR	Z,RBWB		;NZ=セクタ以下の端数がある
E68E CD 2F E8       	CALL	RBXA
E691 38 71          	JR	C,RBWERR
E693 EB             	EX	DE,HL
E694 C5             	PUSH	BC
E695 ED B0          	LDIR
E697 22 5F EF       	LD	(DTAX),HL
E69A                
E69A CD 88 E4       	CALL	SWTDBF		;バッファデータは更新された
E69D                
E69D 2A 5D EF       	LD	HL,(LEFTX)
E6A0 D1             	POP	DE
E6A1 ED 52          	SBC	HL,DE
E6A3 22 5D EF       	LD	(LEFTX),HL
E6A6 28 33          	JR	Z,RBWEND
E6A8                
E6A8                RBWB:
E6A8 CD 65 E8       	CALL	RBXB
E6AB 28 16          	JR	Z,RBWC
E6AD                RBWB1:
E6AD C5             	PUSH	BC
E6AE D5             	PUSH	DE
E6AF CD 59 E3       	CALL	CLUSTX
E6B2 CD CA E8       	CALL	DWTC
E6B5 D1             	POP	DE
E6B6 C1             	POP	BC
E6B7 38 4B          	JR	C,RBWERR
E6B9 CD C8 EA       	CALL	GNCLX
E6BC 38 46          	JR	C,RBWERR
E6BE 10 ED          	DJNZ	RBWB1
E6C0 CD 1A E9       	CALL	DRW_FLUSH
E6C3                RBWC:
E6C3 CD 7D E8       	CALL	RBXC
E6C6 28 13          	JR	Z,RBWEND
E6C8 C5             	PUSH	BC
E6C9 CD 59 E3       	CALL	CLUSTX
E6CC CD 4F E9       	CALL	DRDN
E6CF C1             	POP	BC
E6D0 38 32          	JR	C,RBWERR
E6D2 ED 5B 7E F0    	LD	DE,(_DTBUF)
E6D6 ED B0          	LDIR
E6D8 CD 88 E4       	CALL	SWTDBF		;バッファデータは更新された
E6DB                RBWEND:
E6DB CD 89 E8       	CALL	RBXEND
E6DE                
E6DE CD F0 E7       	CALL	RBX1
E6E1 30 1A          	JR	NC,RBW1
E6E3 2A 8A E8       	LD	HL,(LEFT+1)
E6E6 FD 5E 10       	LD	E,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
E6E9 FD 56 11       	LD	D,(IY+17)	;DE=File size
E6EC 19             	ADD	HL,DE
E6ED FD 75 10       	LD	(IY+16),L	;(FCB)ファイルのサイズ(バイト単位)
E6F0 FD 74 11       	LD	(IY+17),H
E6F3 30 08          	JR	NC,RBW1
E6F5 FD 34 12       	INC	(IY+18)
E6F8 20 03          	JR	NZ,RBW1
E6FA FD 34 13       	INC	(IY+19)
E6FD                RBW1:
E6FD FD E1          	POP	IY
E6FF C1             	POP	BC
E700 D1             	POP	DE
E701 E1             	POP	HL
E702                DD_NUL:
E702 AF             	XOR	A
E703                DRDF0:
E703                DWTF0:
E703 C9             	RET
E704                
E704                RBWERR:
E704 FD E5          	PUSH	IY
E706 D1             	POP	DE
E707 2A 20 F0       	LD	HL,(STABLE+2*010H)
E70A CD 0F 00       	CALL	JP_HL
E70D                RBRERR1:
E70D 3E 01          	LD	A,001H
E70F                RBRERR2:
E70F FD E1          	POP	IY
E711 C1             	POP	BC
E712 D1             	POP	DE
E713 E1             	POP	HL
E714 37             	SCF
E715 21 00 00       	LD	HL,0
E718 C9             	RET
E719                
E719                RBRERR:
E719 3E FF          	LD	A,0FFH
E71B 18 F2          	JR	RBRERR2
E71D                
E71D                RBRFL:
E71D 3E 00          RBRFLP:	LD	A,000H
E71F FE 0D          	CP	00DH
E721 20 05          	JR	NZ,RBRFL1
E723 D5             	PUSH	DE
E724 1E 0A          	LD	E,00AH
E726 18 05          	JR	RBRFL2
E728                RBRFL1:
E728 D5             	PUSH	DE
E729 CD 09 EF       	CALL	_SYS07
E72C 5F             	LD	E,A
E72D                RBRFL2:
E72D CD CD EF       	CALL	_PRINT
E730 7B             	LD	A,E
E731 D1             	POP	DE
E732 32 1E E7       	LD	(RBRFLP+1),A
E735 C9             	RET
E736                DDX:
E736 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
E739 CD 7E E3       	CALL	CAP
E73C FE 41          	CP	'A'
E73E C9             	RET
E73F                
E73F                				;Read random block
E73F                _SYS27:		;(BDOS)ランダムブロック読み込み
E73F 22 5D EF       	LD	(LEFTX),HL
E742 CD 5B E1       	CALL	SETDRV
E745                
E745 FD CB 0D 66    	BIT	4,(IY+13)	;(FCB)属性(アトリビュート)
E749 C2 CF E7       	JP	NZ,RBRDIR	;ディレクトリ
E74C CD E1 E7       	CALL	RBX0
E74F DA 19 E7       	JP	C,RBRERR
E752 CD F0 E7       	CALL	RBX1
E755 DA 0D E7       	JP	C,RBRERR1
E758 EB             	EX	DE,HL
E759 ED 52          	SBC	HL,DE		;CP 00HL,BCDE
E75B 19             	ADD	HL,DE
E75C 79             	LD	A,C
E75D DE 00          	SBC	A,0
E75F 78             	LD	A,B
E760 DE 00          	SBC	A,0
E762 38 01          	JR	C,RBR1
E764 EB             	EX	DE,HL
E765                RBR1:
E765 9F             	SBC	A,A
E766 E6 01          	AND	1
E768 32 CD E7       	LD	(RBRAP+1),A
E76B                
E76B 7C             	LD	A,H
E76C B5             	OR	L
E76D 28 57          	JR	Z,RBREND0
E76F                
E76F 22 8A E8       	LD	(LEFT+1),HL	;Read record byte
E772 22 5D EF       	LD	(LEFTX),HL
E775                
E775 CD 10 E8       	CALL	RBX2
E778 28 19          	JR	Z,RBRB
E77A CD 2F E8       	CALL	RBXA
E77D DA 19 E7       	JP	C,RBRERR
E780 C5             	PUSH	BC
E781 ED B0          	LDIR
E783 ED 53 5F EF    	LD	(DTAX),DE
E787 2A 5D EF       	LD	HL,(LEFTX)
E78A D1             	POP	DE
E78B A7             	AND	A
E78C ED 52          	SBC	HL,DE
E78E 22 5D EF       	LD	(LEFTX),HL
E791 28 30          	JR	Z,RBREND
E793                
E793                RBRB:
E793 CD 65 E8       	CALL	RBXB
E796 28 15          	JR	Z,RBRC
E798                RBRB1:
E798 C5             	PUSH	BC
E799 D5             	PUSH	DE
E79A CD 59 E3       	CALL	CLUSTX
E79D CD D0 E8       	CALL	DRDC
E7A0 D1             	POP	DE
E7A1 C1             	POP	BC
E7A2 D4 C8 EA       	CALL	NC,GNCLX
E7A5 DA 19 E7       	JP	C,RBRERR
E7A8 10 EE          	DJNZ	RBRB1
E7AA CD 1A E9       	CALL	DRW_FLUSH
E7AD                RBRC:
E7AD CD 7D E8       	CALL	RBXC
E7B0 28 11          	JR	Z,RBREND
E7B2 C5             	PUSH	BC
E7B3 CD 59 E3       	CALL	CLUSTX
E7B6 CD 33 E9       	CALL	DRDX
E7B9 C1             	POP	BC
E7BA DA 19 E7       	JP	C,RBRERR
E7BD EB             	EX	DE,HL
E7BE 2A 7E F0       	LD	HL,(_DTBUF)
E7C1 ED B0          	LDIR
E7C3                RBREND:
E7C3 CD 89 E8       	CALL	RBXEND
E7C6                RBREND0:
E7C6 FD E1          	POP	IY
E7C8 C1             	POP	BC
E7C9 D1             	POP	DE
E7CA F1             	POP	AF	;(HL)
E7CB AF             	XOR	A
E7CC 3E 00          RBRAP:	LD	A,000H
E7CE C9             	RET
E7CF                
E7CF                RBRDIR:
E7CF FD 6E 1A       	LD	L,(IY+26)	;(FCB)ファイルの先頭クラスタ
E7D2 FD 66 1B       	LD	H,(IY+27)
E7D5 CD 99 E3       	CALL	CHDIR
E7D8 AF             	XOR	A
E7D9 67             	LD	H,A
E7DA 6F             	LD	L,A
E7DB 3C             	INC	A
E7DC 32 CD E7       	LD	(RBRAP+1),A
E7DF 18 E5          	JR	RBREND0
E7E1                
E7E1                RBX0:
E7E1 2A 8A EF       	LD	HL,(_DTA)
E7E4 22 5F EF       	LD	(DTAX),HL
E7E7 2A 5D EF       	LD	HL,(LEFTX)
E7EA FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
E7ED D6 FD          	SUB	0FDH
E7EF C9             	RET
E7F0                
E7F0                RBX1:
E7F0 E5             	PUSH	HL		;Record byte
E7F1                				;AHL=File size
E7F1 FD 6E 10       	LD	L,(IY+16)	;ファイルのサイズ(バイト単位)
E7F4 FD 66 11       	LD	H,(IY+17)	;
E7F7 FD 7E 12       	LD	A,(IY+18)	;
E7FA                
E7FA CD B6 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E7FD                
E7FD A7             	AND	A
E7FE ED 52          	SBC	HL,DE
E800 99             	SBC	A,C
E801 4F             	LD	C,A
E802 FD 7E 13       	LD	A,(IY+19)	;ファイルのサイズ
E805 98             	SBC	A,B
E806 D1             	POP	DE
E807                
E807 D8             	RET	C
E808 47             	LD	B,A
E809 B1             	OR	C
E80A EB             	EX	DE,HL	;BCDE=File byte	HL=Record byte
E80B B2             	OR	D
E80C B3             	OR	E
E80D C0             	RET	NZ
E80E 37             	SCF
E80F C9             	RET
E810                
E810                RBX2:				;Cluster settings
E810 FD 66 22       	LD	H,(IY+34)	;(+33)(FCB)ランダムレコード
E813 FD 4E 23       	LD	C,(IY+35)
E816 06 00          	LD	B,0
E818 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E81C 20 03          	JR	NZ,RBX3
E81E FD 46 24       	LD	B,(IY+36)
E821                RBX3:
E821 CD 4A E5       	CALL	RWXR
E824 3A 47 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E827 3D             	DEC	A
E828 FD A6 22       	AND	(IY+34)
E82B FD B6 21       	OR	(IY+33)
E82E C9             	RET
E82F                
E82F                RBXA:
E82F C5             	PUSH	BC
E830 D5             	PUSH	DE
E831 CD 59 E3       	CALL	CLUSTX
E834 CD 33 E9       	CALL	DRDX
E837 D1             	POP	DE
E838 C1             	POP	BC
E839 D8             	RET	C
E83A CD C8 EA       	CALL	GNCLX
E83D D8             	RET	C
E83E ED 53 FE F0    	LD	(_CLPS),DE
E842                
E842 FD 4E 21       	LD	C,(IY+33)	;(FCB)ランダムレコード
E845 21 00 04       SECSZ:	LD	HL,0400H	;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
E848 7C             	LD	A,H
E849 3D             	DEC	A		;1024=3 / 512=1
E84A FD A6 22       	AND	(IY+34)		;(FCB)ランダムレコード
E84D 47             	LD	B,A		;BCに1セクタ以下の端数が入る
E84E ED 42          	SBC	HL,BC		;残りを計算
E850                
E850 ED 5B 5D EF    	LD	DE,(LEFTX)
E854 ED 52          	SBC	HL,DE		;CP HL,DE
E856 19             	ADD	HL,DE		;
E857 38 01          	JR	C,RBXA1		;DEとHLを比較して大きい方をHLに
E859 EB             	EX	DE,HL
E85A                RBXA1:
E85A E5             	PUSH	HL
E85B 2A 7E F0       	LD	HL,(_DTBUF)
E85E 09             	ADD	HL,BC
E85F ED 5B 5F EF    	LD	DE,(DTAX)
E863 C1             	POP	BC
E864 C9             	RET
E865                
E865                RBXB:
E865 2A 5F EF       	LD	HL,(DTAX)
E868 ED 5B FE F0    	LD	DE,(_CLPS)
E86C 3A 5E EF       	LD	A,(LEFTX+1)
E86F 47             	LD	B,A
E870 3A 47 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E873                RBXB1:
E873 1F             	RRA		;->CF
E874 38 04          	JR	C,RBXB2
E876 CB 38          	SRL	B	;B=B/2
E878 18 F9          	JR	RBXB1
E87A                RBXB2:
E87A 78             	LD	A,B
E87B B7             	OR	A
E87C C9             	RET
E87D                
E87D                RBXC:
E87D ED 4B 5D EF    	LD	BC,(LEFTX)
E881 3A 47 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E884 3D             	DEC	A
E885 A0             	AND	B
E886 47             	LD	B,A		;1セクタ以下の端数がない場合はZ
E887 B1             	OR	C
E888 C9             	RET
E889                
E889                RBXEND:
E889 11 00 00       LEFT:	LD	DE,0
E88C AF             	XOR	A
E88D FD 6E 21       	LD	L,(IY+33)	;(FCB)ランダムレコード
E890 FD 66 22       	LD	H,(IY+34)
E893 19             	ADD	HL,DE
E894 FD 75 21       	LD	(IY+33),L	;(FCB)ランダムレコード
E897 FD 74 22       	LD	(IY+34),H
E89A 30 0E          	JR	NC,RBXEND1
E89C FD 34 23       	INC	(IY+35)
E89F 20 09          	JR	NZ,RBXEND1
E8A1 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E8A5 20 03          	JR	NZ,RBXEND1
E8A7 FD 34 24       	INC	(IY+36)
E8AA                RBXEND1:
E8AA EB             	EX	DE,HL		;HL=Read byte
E8AB C9             	RET
E8AC                
E8AC                GET_RR_AHL:
E8AC FD 6E 21       	LD	L,(IY+33)	;(FCB)Random record
E8AF FD 66 22       	LD	H,(IY+34)	;
E8B2 FD 7E 23       	LD	A,(IY+35)	;
E8B5 C9             	RET
E8B6                
E8B6                GET_RR_BCDE:			;BCDE=Random record
E8B6 FD 5E 21       	LD	E,(IY+33)	;(FCB)ランダムレコード
E8B9 FD 56 22       	LD	D,(IY+34)
E8BC FD 4E 23       	LD	C,(IY+35)
E8BF FD 46 24       	LD	B,(IY+36)
E8C2 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E8C6 C8             	RET	Z
E8C7 06 00          	LD	B,0		;CP/M互換のアクセスの場合はFCBは36バイト
E8C9 C9             	RET
E8CA                
E8CA                ;	ランダムブロックアクセスの連続したセクタをまとめる
E8CA                
E8CA                DWTC:
E8CA E5             	PUSH	HL
E8CB 21 2E EC       	LD	HL,DWT24B
E8CE 18 04          	JR	DWTC1
E8D0                DRDC:
E8D0 E5             	PUSH	HL
E8D1 21 1E EC       	LD	HL,DRD24B
E8D4                DWTC1:
E8D4 22 2E E9       	LD	(DRWF_MODE),HL
E8D7 E1             	POP	HL
E8D8 3A 1E E9       	LD	A,(DRWF_B)
E8DB B7             	OR	A
E8DC 20 0F          	JR	NZ,DRDC1
E8DE                SAVE_DRWC:
E8DE 06 01          	LD	B,1
E8E0 ED 43 1D E9    	LD	(DRWF_C),BC
E8E4 ED 53 24 E9    	LD	(DRWF_E),DE
E8E8 22 27 E9       	LD	(DRWF_HL),HL
E8EB 18 20          	JR	INC_HL_DRWC
E8ED                DRDC1:
E8ED E5             	PUSH	HL
E8EE 21 24 E9       	LD	HL,DRWF_E
E8F1 86             	ADD	A,(HL)
E8F2 F5             	PUSH	AF
E8F3 BB             	CP	E
E8F4 20 1D          	JR	NZ,DRDC2
E8F6 F1             	POP	AF
E8F7 23             	INC	HL
E8F8 7E             	LD	A,(HL)
E8F9 CE 00          	ADC	A,0
E8FB F5             	PUSH	AF
E8FC BA             	CP	D
E8FD 20 14          	JR	NZ,DRDC2
E8FF F1             	POP	AF
E900 3A 1D E9       	LD	A,(DRWF_C)
E903 CE 00          	ADC	A,0
E905 B9             	CP	C
E906 20 0C          	JR	NZ,DRDC3
E908 21 1E E9       	LD	HL,DRWF_B
E90B 34             	INC	(HL)
E90C E1             	POP	HL
E90D                INC_HL_DRWC:
E90D 3A 47 E8       	LD	A,(SECSZ+2)		;1セクタのサイズの上位1バイト
E910 84             	ADD	A,H
E911 67             	LD	H,A
E912 C9             	RET
E913                DRDC2:
E913 F1             	POP	AF
E914                DRDC3:
E914 CD 1A E9       	CALL	DRW_FLUSH
E917 E1             	POP	HL
E918 18 C4          	JR	SAVE_DRWC
E91A                
E91A                ;	ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
E91A                DRW_FLUSH:
E91A C5             	PUSH	BC
E91B D5             	PUSH	DE
E91C 00 00 E9 1D    DRWF_C	EQU	$+1
E91C 00 00 E9 1E    DRWF_B	EQU	$+2
E91C 01 00 00       	LD	BC,0
E91F 78             	LD	A,B
E920 B7             	OR	A
E921 28 0D          	JR	Z,DRDF1
E923 00 00 E9 24    DRWF_E	EQU	$+1
E923 00 00 E9 25    DRWF_D	EQU	$+2
E923 11 00 00       	LD	DE,0
E926 00 00 E9 27    DRWF_HL	EQU	$+1
E926 21 00 00       	LD	HL,0
E929 AF             	XOR	A
E92A 32 1E E9       	LD	(DRWF_B),A
E92D 00 00 E9 2E    DRWF_MODE	EQU	$+1
E92D CD 1E EC       	CALL	DRD24B
E930                DRDF1:
E930 D1             	POP	DE
E931 C1             	POP	BC
E932 C9             	RET
E933                	INCLUDE	"LDDIO.ASM"
E933                
E933                ;	LSX-Dodgers DIO
E933                
E933                DRDX:
E933 CD 71 E9       	CALL	DRDY
E936 C8             	RET	Z
E937 CD 57 E9       	CALL	DRDX1		;データバッファの情報を保存
E93A D8             	RET	C
E93B E5             	PUSH	HL
E93C C5             	PUSH	BC
E93D D5             	PUSH	DE
E93E 2A 7E F0       	LD	HL,(_DTBUF)
E941 3A 9A E9       	LD	A,(_DBS24+1)
E944 4F             	LD	C,A
E945 CD 1C EC       	CALL	DRD24
E948 DC 6C E9       	CALL	C,DRDNE
E94B                POP_DE_BC_HL_RET:
E94B D1             	POP	DE
E94C C1             	POP	BC
E94D E1             	POP	HL
E94E C9             	RET
E94F                
E94F                ;	CDE:セクタ番号
E94F                DRDN:
E94F AF             	XOR	A
E950 00             DRDN1:	NOP			;自己書き換え NOP / SCF
E951 30 E0          	JR	NC,DRDX
E953                DRDNX:
E953 CD 71 E9       	CALL	DRDY
E956 C8             	RET	Z
E957                DRDX1:
E957 CD 87 E9       	CALL	DWTX
E95A                				;データバッファの読み込んだドライブ・セクタ情報を保存
E95A ED 53 A6 EF    	LD	(_DBSEC),DE
E95E 79             	LD	A,C
E95F 32 9A E9       	LD	(_DBS24+1),A
E962                
E962 3A 88 EF       	LD	A,(_DRV)
E965 32 A5 EF       	LD	(_DBDRV),A
E968 CD D9 EF       	CALL	_CHGDRV
E96B D0             	RET	NC
E96C                DRDNE:
E96C 9F             	SBC	A,A		;CF=1ならばA=0FFH
E96D 32 A5 EF       	LD	(_DBDRV),A
E970 C9             	RET
E971                
E971                ;	CDE:セクタ番号
E971                DRDY:
E971 3A 9A E9       	LD	A,(_DBS24+1)
E974 B9             	CP	C
E975 C0             	RET	NZ
E976                
E976 E5             	PUSH	HL
E977 3A 88 EF       	LD	A,(_DRV)
E97A 21 A5 EF       	LD	HL,_DBDRV
E97D AE             	XOR	(HL)
E97E 20 05          	JR	NZ,POP_HL_RET
E980                
E980 2A A6 EF       	LD	HL,(_DBSEC)
E983 ED 52          	SBC	HL,DE		;CF=0
E985                POP_HL_RET:
E985 E1             	POP	HL
E986 C9             	RET
E987                
E987                DWTX:
E987 3A A4 EF       	LD	A,(_WTDBF)
E98A B7             	OR	A
E98B C8             	RET	Z
E98C AF             	XOR	A
E98D 32 A4 EF       	LD	(_WTDBF),A
E990                
E990 E5             	PUSH	HL
E991 C5             	PUSH	BC
E992 D5             	PUSH	DE
E993 3A A5 EF       	LD	A,(_DBDRV)
E996 CD D9 EF       	CALL	_CHGDRV
E999 0E 00          _DBS24:	LD	C,0
E99B ED 5B A6 EF    	LD	DE,(_DBSEC)
E99F 2A 7E F0       	LD	HL,(_DTBUF)
E9A2 D4 2C EC       	CALL	NC,DWT24
E9A5                POP_DE_BC_HL_RET2:
E9A5 18 A4          	JR	POP_DE_BC_HL_RET
E9A7                
E9A7                RDFATX:
E9A7 E5             	PUSH	HL
E9A8 3A 88 EF       	LD	A,(_DRV)
E9AB 21 AA EF       	LD	HL,_FATDRV
E9AE AE             	XOR	(HL)
E9AF 28 D4          	JR	Z,POP_HL_RET
E9B1                
E9B1 C5             	PUSH	BC
E9B2 D5             	PUSH	DE
E9B3 DD E5          	PUSH	IX
E9B5 CD D1 E9       	CALL	WTFATX
E9B8 38 13          	JR	C,POP_IX_DE_BC_HL_RET
E9BA                
E9BA AF             	XOR	A
E9BB 32 AB EF       	LD	(_FATIX),A
E9BE 3A 88 EF       	LD	A,(_DRV)
E9C1 32 AA EF       	LD	(_FATDRV),A
E9C4 CD E5 EF       	CALL	_RDFAT
E9C7                RDFATE2:
E9C7 30 04          	JR	NC,POP_IX_DE_BC_HL_RET
E9C9 9F             	SBC	A,A		;A=0xFF
E9CA 32 AA EF       	LD	(_FATDRV),A
E9CD                POP_IX_DE_BC_HL_RET:
E9CD DD E1          	POP	IX
E9CF 18 D4          	JR	POP_DE_BC_HL_RET2
E9D1                
E9D1                WTFATX:
E9D1 3A A2 EF       	LD	A,(_WTFATF)
E9D4 B7             	OR	A
E9D5 C8             	RET	Z
E9D6 E5             	PUSH	HL
E9D7 3A AA EF       	LD	A,(_FATDRV)
E9DA 21 A5 EF       	LD	HL,_DBDRV
E9DD AE             	XOR	(HL)
E9DE CC 87 E9       	CALL	Z,DWTX
E9E1 38 A2          	JR	C,POP_HL_RET
E9E3 C5             	PUSH	BC
E9E4 D5             	PUSH	DE
E9E5 DD E5          	PUSH	IX
E9E7 CD 39 EC       	CALL	WTFAT
E9EA AF             	XOR	A
E9EB 32 A2 EF       	LD	(_WTFATF),A
E9EE 18 DD          	JR	POP_IX_DE_BC_HL_RET
E9F0                
E9F0                NCL1:
E9F0 7A             	LD	A,D
E9F1 B3             	OR	E
E9F2 37             	SCF
E9F3 C8             	RET	Z
E9F4                
E9F4 7A             	LD	A,D
E9F5 CB 3F          	SRL	A	;/2
E9F7 CB 3F          	SRL	A	;/2
E9F9                
E9F9 E5             	PUSH	HL
E9FA 32 19 EA       	LD	(NCLPAT+2),A	;_FATIX
E9FD 2A AA EF       	LD	HL,(_FATDRV)	;L=_FATDRV H=_FATIX
EA00 BC             	CP	H
EA01 3A 88 EF       	LD	A,(_DRV)	;この間でフラグは変化しない
EA04 32 18 EA       	LD	(NCLPAT+1),A	;_FATDRV
EA07 20 05          	JR	NZ,NCL2		;FATIXが違う
EA09 BD             	CP	L
EA0A 20 02          	JR	NZ,NCL2		;ドライブが違う
EA0C E1             	POP	HL
EA0D C9             	RET
EA0E                NCL2:
EA0E C5             	PUSH	BC
EA0F D5             	PUSH	DE
EA10 DD E5          	PUSH	IX
EA12 CD D1 E9       	CALL	WTFATX
EA15 38 B6          	JR	C,POP_IX_DE_BC_HL_RET
EA17 01 00 00       NCLPAT:	LD	BC,0		;自己書き換え C=_FATDRV B=_FATIX
EA1A ED 43 AA EF    	LD	(_FATDRV),BC
EA1E CD 0E EC       	CALL	RDFATS
EA21 18 A4          	JR	RDFATE2
EA23                
EA23                NCL3:
EA23 CB 9A          	RES	3,D
EA25 CB 92          	RES	2,D
EA27 6B             	LD	L,E
EA28 62             	LD	H,D
EA29 CB 3C          	SRL	H	;
EA2B CB 1D          	RR	L	;HLA=HLA/2
EA2D 1F             	RRA		;
EA2E F5             	PUSH	AF
EA2F 3A AB EF       	LD	A,(_FATIX)
EA32 0F             	RRCA
EA33 30 0B          	JR	NC,NCL3X1
EA35 3A 47 E8       	LD	A,(SECSZ+2)
EA38 FE 04          	CP	4		;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
EA3A 20 04          	JR	NZ,NCL3X1
EA3C 01 00 02       	LD	BC,512
EA3F 09             	ADD	HL,BC
EA40                NCL3X1:
EA40 F1             	POP	AF
EA41 ED 4B 7C F0    	LD	BC,(_FATBF)
EA45 19             	ADD	HL,DE
EA46 09             	ADD	HL,BC
EA47 17             	RLA
EA48 C9             	RET
EA49                
EA49                GNCL:
EA49 CD F0 E9       	CALL	NCL1		;GET NEXT CLUSTER
EA4C D8             	RET	C
EA4D C5             	PUSH	BC
EA4E E5             	PUSH	HL
EA4F CD 23 EA       	CALL	NCL3
EA52 38 09          	JR	C,GNC1
EA54 5E             	LD	E,(HL)
EA55 23             	INC	HL
EA56 7E             	LD	A,(HL)
EA57 E6 0F          	AND	00FH
EA59 57             	LD	D,A
EA5A E1             	POP	HL
EA5B C1             	POP	BC
EA5C C9             	RET
EA5D                GNC1:
EA5D 7E             	LD	A,(HL)
EA5E 23             	INC	HL
EA5F 56             	LD	D,(HL)
EA60 06 04          	LD	B,4
EA62                GNC1L:
EA62 CB 3A          	SRL	D	;DA=DA/2
EA64 1F             	RRA		;
EA65 10 FB          	DJNZ	GNC1L
EA67                
EA67 5F             	LD	E,A
EA68 E1             	POP	HL
EA69 C1             	POP	BC
EA6A A7             	AND	A
EA6B C9             	RET
EA6C                
EA6C                SNCL:
EA6C CD F0 E9       	CALL	NCL1
EA6F D8             	RET	C
EA70                ;				SET NEXT CLUSTER
EA70 E5             	PUSH	HL
EA71 C5             	PUSH	BC
EA72 D5             	PUSH	DE
EA73 E5             	PUSH	HL
EA74 CD 23 EA       	CALL	NCL3
EA77 D1             	POP	DE
EA78                ;CF=ODD
EA78 7E             	LD	A,(HL)
EA79 73             	LD	(HL),E
EA7A 38 06          	JR	C,SNC1
EA7C                ;EVEN
EA7C                ;M[0] = E
EA7C                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
EA7C 23             	INC	HL
EA7D ED 67          	RRD		;M={A[3:0],E[3:0]}
EA7F 7A             	LD	A,D
EA80 18 04          	JR	SNC11
EA82                SNC1:
EA82                ;ODD
EA82                ;HL[0] = (HL[0]&0x0F) | (E<<4)
EA82                ;HL[1] = DE>>4
EA82 ED 6F          	RLD		;M={D[3:0],E[7:4]}
EA84 23             	INC	HL
EA85 72             	LD	(HL),D	;M={D[3:0],E[7:4]}
EA86                SNC11:
EA86 ED 6F          	RLD		;M={M[7:4],D[3:0]}
EA88 B7             	OR	A
EA89 D1             	POP	DE
EA8A C1             	POP	BC
EA8B E1             	POP	HL
EA8C                FAT_CHANGED:
EA8C 3E 01          	LD	A,1
EA8E 32 A2 EF       	LD	(_WTFATF),A
EA91 C9             	RET
EA92                
EA92                N16CL3:
EA92 C5             	PUSH	BC
EA93 6B             	LD	L,E
EA94 7A             	LD	A,D
EA95 E6 03          	AND	3
EA97 67             	LD	H,A
EA98 29             	ADD	HL,HL
EA99 ED 4B 7C F0    	LD	BC,(_FATBF)
EA9D 09             	ADD	HL,BC
EA9E C1             	POP	BC
EA9F C9             	RET
EAA0                
EAA0                GNCL16:
EAA0 CD F0 E9       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EAA3 D8             	RET	C
EAA4 E5             	PUSH	HL
EAA5 CD 92 EA       	CALL	N16CL3
EAA8 5E             	LD	E,(HL)
EAA9 23             	INC	HL
EAAA 56             	LD	D,(HL)
EAAB E1             	POP	HL
EAAC C9             	RET
EAAD                
EAAD                SNCL16:
EAAD CD F0 E9       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EAB0 D8             	RET	C
EAB1 D5             	PUSH	DE
EAB2 E5             	PUSH	HL
EAB3 CD 92 EA       	CALL	N16CL3
EAB6 D1             	POP	DE		;HL
EAB7 73             	LD	(HL),E
EAB8 23             	INC	HL
EAB9 72             	LD	(HL),D
EABA 6B             	LD	L,E
EABB 62             	LD	H,D
EABC D1             	POP	DE
EABD 18 CD          	JR	FAT_CHANGED
EABF                
EABF                ;------------------------
EABF                ;次のセクタを探す際に_SECPSの値をチェック
EABF                ;in
EABF                ;	DE : セクタ番号
EABF                ;out
EABF                ;	DE : 次のセクタ番号
EABF                ;note
EABF                ;
EABF                ;------------------------
EABF                NEXTX:
EABF 3E 00          _SECPS:	LD	A,0	;自己書き換え
EAC1 3C             	INC	A
EAC2 E6 00          NCPAT:	AND	0	;自己書き換え　1クラスタの論理セクタ数-1
EAC4 32 C0 EA       	LD	(_SECPS+1),A
EAC7 C9             	RET
EAC8                
EAC8                GNCLX:
EAC8 CD BF EA       	CALL	NEXTX
EACB C0             	RET	NZ	;1クラスタのセクタ未満の場合は戻る
EACC C3 F7 EF       	JP	_GNCL	;次のクラスタを探す
EACF                
EACF                RDFAT:
EACF 3E 80          	LD	A,080H
EAD1 32 70 EF       	LD	(CHECK),A
EAD4                RDFAT1:
EAD4 3A 88 EF       	LD	A,(_DRV)
EAD7 CD 64 ED       	CALL	CHGDRVR
EADA D8             	RET	C
EADB DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EADE CB 6F          	BIT	5,A
EAE0 28 43          	JR	Z,RDFAT0X
EAE2 21 70 EF       	LD	HL,CHECK
EAE5 A6             	AND	(HL)
EAE6 77             	LD	(HL),A
EAE7 11 00 00       	LD	DE,0		;BPB
EAEA 2A 7C F0       	LD	HL,(_FATBF)
EAED CD 1A EC       	CALL	DRD16
EAF0 30 24          	JR	NC,GETBPB
EAF2 21 70 EF       	LD	HL,CHECK
EAF5 CB 06          	RLC	(HL)
EAF7 3F             	CCF
EAF8 D8             	RET	C
EAF9 DD CB 0A 1E    	RR	(IX+00AH)	;DPB_0A_FDMODE
EAFD 3F             	CCF			;フロッピーディスクのMFMモードを切り替える
EAFE DD CB 0A 16    	RL	(IX+00AH)	;DPB_0A_FDMODE
EB02 3E FF          	LD	A,0FFH
EB04 32 89 EF       	LD	(_DSK),A
EB07 3A 84 EF       	LD	A,(_DRIVE)
EB0A E6 03          	AND	3
EB0C F6 80          	OR	080H
EB0E 6F             	LD	L,A
EB0F 26 EF          	LD	H,_CYL0/256
EB11 3E FF          	LD	A,0FFH
EB13 77             	LD	(HL),A
EB14 18 BE          	JR	RDFAT1
EB16                GETBPB:
EB16 FD E5          	PUSH	IY
EB18 FD 2A 7C F0    	LD	IY,(_FATBF)	;BPB
EB1C CD F1 EF       	CALL	_BPB2DPB
EB1F FD E1          	POP	IY
EB21 D8             	RET	C
EB22 CD C2 EC       	CALL	CHGDRV2
EB25                RDFAT0X:
EB25 CD 0E EC       	CALL	RDFATS
EB28 D8             	RET	C
EB29 DD BE 06       	CP	(IX+6)		;DPB_06_FATID
EB2C C8             	RET	Z
EB2D DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
EB31 C0             	RET	NZ		;BPBを取得している場合はFATIDをチェックしない
EB32 37             	SCF
EB33 C9             	RET
EB34                
EB34                BPB2DPB:
EB34 FD 7E 00       	LD	A,(IY+0)	;BS_JmpBoot
EB37 FE EB          	CP	0EBH		;Short jump
EB39 28 08          	JR	Z,BPBOK
EB3B FE E9          	CP	0E9H		;Near jump
EB3D 28 04          	JR	Z,BPBOK
EB3F FE 60          	CP	060H		;X68k
EB41 37             	SCF
EB42 C0             	RET	NZ
EB43                BPBOK:
EB43 FD 7E 0D       	LD	A,(IY+13)	;BPB_SecPerClus
EB46 DD 77 07       	LD	(IX+7),A	;DPB_07_SECPCL
EB49                
EB49 FD 7E 16       	LD	A,(IY+22)	;BPB_FATSz16
EB4C DD 77 00       	LD	(IX+0),A	;DPB_00_FATLN
EB4F FD 7E 17       	LD	A,(IY+23)	;BPB_FATSz16
EB52 DD 77 01       	LD	(IX+1),A	;DPB_00_FATLN
EB55                
EB55 FD 6E 0E       	LD	L,(IY+14)	;BPB_RsvdSecCnt
EB58 FD 66 0F       	LD	H,(IY+15)
EB5B DD 75 0E       	LD	(IX+00EH),L	;DPB_0E_FATPS
EB5E FD 5E 16       	LD	E,(IY+22)	;BPB_FATSz16
EB61 FD 56 17       	LD	D,(IY+23)
EB64 FD 46 10       	LD	B,(IY+16)	;BPB_NumFATs
EB67                BPBDP1:				;BPB_FATSz16 * BPB_NumFATs
EB67 19             	ADD	HL,DE
EB68 10 FD          	DJNZ	BPBDP1
EB6A                BPBDP2:
EB6A DD 75 10       	LD	(IX+010H),L	;DPB_10_DIRPS
EB6D DD 74 11       	LD	(IX+011H),H
EB70 E5             	PUSH	HL
EB71                
EB71 FD 6E 11       	LD	L,(IY+17)	;BPB_RootEntCnt
EB74 FD 66 12       	LD	H,(IY+18)
EB77 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EB7A 06 06          	LD	B,6
EB7C                BPBBPS1:
EB7C 05             	DEC	B
EB7D 0F             	RRCA
EB7E 30 FC          	JR	NC,BPBBPS1
EB80                BPBDE1:
EB80 29             	ADD	HL,HL
EB81 10 FD          	DJNZ	BPBDE1
EB83                
EB83 7C             	LD	A,H
EB84 DD 77 0B       	LD	(IX+00BH),A	;DPB_0B_DIRSCNT
EB87                
EB87 D1             	POP	DE		;DPB_10_DIRPS
EB88 6C             	LD	L,H
EB89 26 00          	LD	H,0
EB8B 19             	ADD	HL,DE		;MAXDIR
EB8C E5             	PUSH	HL
EB8D FD 4E 0D       	LD	C,(IY+13)	;BPB_SecPerClus
EB90 CB 21          	SLA	C		;*2
EB92 AF             	XOR	A
EB93 47             	LD	B,A
EB94 ED 42          	SBC	HL,BC
EB96 DD 75 14       	LD	(IX+014H),L	;DPB_14_ADDCL16
EB99 DD 74 15       	LD	(IX+015H),H
EB9C                
EB9C D1             	POP	DE		;DE=DPB_0B_MAXDIR
EB9D FD 6E 13       	LD	L,(IY+19)	;BPB_TotSec16
EBA0 FD 66 14       	LD	H,(IY+20)
EBA3 7C             	LD	A,H
EBA4 B5             	OR	L
EBA5 3E 00          	LD	A,0		;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
EBA7 20 10          	JR	NZ,BPB16BIT	;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
EBA9 FD 7E 23       	LD	A,(IY+35)	;念のために総セクタ数が24ビットを超える場合はエラーを返す
EBAC B7             	OR	A
EBAD 37             	SCF
EBAE C0             	RET	NZ
EBAF FD 6E 20       	LD	L,(IY+32)	;BPB_TotSec32 は AHL の24ビットで扱う
EBB2 FD 66 21       	LD	H,(IY+33)	;1クラスタの論理セクタ数(DPB_07_SECPCL)が最大128なので
EBB5 FD 7E 22       	LD	A,(IY+34)	;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
EBB8 A7             	AND	A		;CF=0
EBB9                BPB16BIT:
EBB9 ED 52          	SBC	HL,DE
EBBB DE 00          	SBC	A,0
EBBD FD 46 0D       	LD	B,(IY+13)	;BPB_SecPerClus
EBC0                BPBTC1:				;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
EBC0 CB 18          	RR	B		;->CY
EBC2 38 08          	JR	C,BPBTC2
EBC4 CB 3F          	SRL	A
EBC6 CB 1C          	RR	H		;AHL=AHL/2
EBC8 CB 1D          	RR	L
EBCA 18 F4          	JR	BPBTC1
EBCC                BPBTC2:
EBCC B7             	OR	A
EBCD 37             	SCF
EBCE C0             	RET	NZ		;念のため(クラスタ数が16ビットを超える場合)
EBCF 23             	INC	HL
EBD0 23             	INC	HL
EBD1 DD 75 08       	LD	(IX+8),L	;DPB_08_MAXCL
EBD4 DD 74 09       	LD	(IX+9),H
EBD7                
EBD7 FD 7E 15       	LD	A,(IY+21)	;BPB_Media
EBDA DD 77 06       	LD	(IX+6),A	;DPB_06_FATID
EBDD                
EBDD DD CB 0A 7E    	BIT	7,(IX+00AH)	;DPB_0A_FDMODE
EBE1 28 17          	JR	Z,NOT_FD
EBE3 2E 28          	LD	L,40		;MAXCYLの設定（要検討）ここから下はフロッピーのみ書き換える
EBE5 FE FD          	CP	0FDH	;2D
EBE7 28 08          	JR	Z,SETCYL
EBE9 2E 4D          	LD	L,77
EBEB FE FE          	CP	0FEH	;2HD
EBED 28 02          	JR	Z,SETCYL
EBEF 2E 50          	LD	L,80	;その他2DD等
EBF1                SETCYL:
EBF1 DD 75 0C       	LD	(IX+00CH),L	;DPB_0C_MAXCYL
EBF4 FD 7E 18       	LD	A,(IY+24)	;BPB_SecPerTr
EBF7 DD 77 0D       	LD	(IX+00DH),A	;DPB_0D_MAXSEC	;ここまでフロッピー専用
EBFA                NOT_FD:
EBFA FD 7E 10       	LD	A,(IY+16)	;BPB_NumFATs
EBFD FE 02          	CP	2		;>2:NC
EBFF FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EC02 38 02          	JR	C,BPBFAT1
EC04 F6 80          	OR	080H
EC06                BPBFAT1:
EC06 DD 77 0F       	LD	(IX+00FH),A	;DPB_0F_BPS
EC09                
EC09 E6 7F          	AND	07FH		;セクタバッファが1KBしかないので1KBを超える場合はCF=1でエラーにする
EC0B C6 FB          	ADD	A,0-5		;0-4:CF=0 5以上:CF=1
EC0D C9             	RET
EC0E                
EC0E                RDFATS:
EC0E CD 54 EC       	CALL	FATSETUP
EC11 D8             	RET	C
EC12 CD 1E EC       	CALL	DRD24B
EC15 2A 7C F0       	LD	HL,(_FATBF)
EC18 7E             	LD	A,(HL)
EC19 C9             	RET
EC1A                
EC1A                DRD16:
EC1A 0E 00          	LD	C,0
EC1C                DRD24:
EC1C 06 01          	LD	B,1
EC1E                DRD24B:
EC1E DD E5          	PUSH	IX
EC20 DD 2A A8 EF    	LD	IX,(_DPB)
EC24 CD 7F EE       DRDPAT:	CALL	FDRD		;自己書き換え（ディスク読み込み）
EC27                POP_IX_RET:
EC27 DD E1          	POP	IX
EC29 C9             	RET
EC2A                
EC2A                DWT16:
EC2A 0E 00          	LD	C,0
EC2C                DWT24:
EC2C 06 01          	LD	B,1
EC2E                DWT24B:
EC2E DD E5          	PUSH	IX
EC30 DD 2A A8 EF    	LD	IX,(_DPB)
EC34 CD 71 EE       DWTPAT:	CALL	FDWT		;自己書き換え（ディスク書き込み）
EC37 18 EE          	JR	POP_IX_RET
EC39                
EC39                WTFAT:
EC39 CD 54 EC       	CALL	FATSETUP
EC3C D4 2E EC       	CALL	NC,DWT24B
EC3F D8             	RET	C
EC40 DD CB 0F 7E    	BIT	7,(IX+00FH)	;DPB_0F_BPS
EC44 C8             	RET	Z		;予備FATが無い
EC45 CD 5B EC       	CALL	FATS2
EC48 E5             	PUSH	HL		;予備FAT
EC49 DD 6E 00       	LD	L,(IX+0)	;DPB_00_FATLN
EC4C DD 66 01       	LD	H,(IX+1)
EC4F 19             	ADD	HL,DE
EC50 EB             	EX	DE,HL
EC51 E1             	POP	HL
EC52 18 DA          	JR	DWT24B
EC54                ;------------------------
EC54                ;FATのセットアップ
EC54                ;out
EC54                ;	B  : FATセクタ数
EC54                ;	DE : FAT先頭セクタ番号
EC54                ;	HL : FATバッファポインタ
EC54                ;	CF : 1=ドライブ切り替えエラー
EC54                ;note
EC54                ;	FATサイズがFATバッファを超える場合は
EC54                ;	対象クラスタ領域==(_FATIX)によって
EC54                ;	FAT12:対象クラスタ1024毎に1.5KBを切り替える
EC54                ;	FAT16:対象クラスタ1024毎に2KBを切り替える
EC54                ;------------------------
EC54                FATSETUP:
EC54 3A AA EF       	LD	A,(_FATDRV)
EC57 CD 64 ED       	CALL	CHGDRVR		;ドライブ切り替え
EC5A D8             	RET	C
EC5B                FATS2:
EC5B DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS 512=2 1024=4
EC5E 0F             	RRCA
EC5F CD 88 EC       FATSX:	CALL	FATSETUP12	;自己書き換え
EC62 21 00 00       	LD	HL,0
EC65 4A             	LD	C,D
EC66 54             	LD	D,H
EC67 3A AB EF       	LD	A,(_FATIX)	;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
EC6A 47             	LD	B,A
EC6B 04             	INC	B
EC6C DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
EC6F                FAT_SKP:
EC6F 05             	DEC	B
EC70 28 05          	JR	Z,FAT1
EC72 19             	ADD	HL,DE
EC73 93             	SUB	E
EC74 30 F9          	JR	NC,FAT_SKP
EC76 C9             	RET
EC77                FAT1:
EC77 EB             	EX	DE,HL
EC78 B9             	CP	C		;C=FATバッファに読み込めるセクタ数
EC79 38 01          	JR	C,FAT2
EC7B 79             	LD	A,C
EC7C                FAT2:
EC7C 47             	LD	B,A
EC7D                
EC7D 2A FA F0       	LD	HL,(_FATPS)	;fat sector pos
EC80 19             	ADD	HL,DE
EC81 EB             	EX	DE,HL
EC82 2A 7C F0       	LD	HL,(_FATBF)
EC85 AF             	XOR	A		;CF=0
EC86 4F             	LD	C,A
EC87 C9             	RET
EC88                ;
EC88                ;	FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
EC88                ;	FATSETUP* (FAT12/FAT16)
EC88                ;out
EC88                ;	D : FATバッファに読み込める最大のセクタ数
EC88                ;	E : _FATIXで進めるセクタ数
EC88                FATSETUP12:
EC88 11 06 06       	LD	DE,0606H	;256
EC8B D8             	RET	C
EC8C 11 03 03       	LD	DE,0303H	;512
EC8F 0F             	RRCA
EC90 D8             	RET	C
EC91 11 01 02       	LD	DE,0201H	;1024
EC94 C9             	RET
EC95                
EC95                FATSETUP16:
EC95 11 08 08       	LD	DE,0808H	;256
EC98 D8             	RET	C
EC99 11 04 04       	LD	DE,0404H
EC9C 0F             	RRCA			;512
EC9D D8             	RET	C
EC9E 11 02 02       	LD	DE,0202H	;1024
ECA1 C9             	RET
ECA2                
ECA2                CHGDRV:
ECA2 E5             	PUSH	HL
ECA3 21 89 EF       	LD	HL,_DSK
ECA6 BE             	CP	(HL)
ECA7 28 0A          	JR	Z,CHGDRVE
ECA9                CHGDRV1:
ECA9 DD E5          	PUSH	IX
ECAB CD B5 EC       	CALL	CHGDRV0
ECAE 3A 89 EF       	LD	A,(_DSK)
ECB1 DD E1          	POP	IX
ECB3                CHGDRVE:
ECB3 E1             	POP	HL
ECB4 C9             	RET
ECB5                
ECB5                CHGDRV0:
ECB5 6F             	LD	L,A
ECB6 CD DC EF       	CALL	_GETDPB
ECB9 D8             	RET	C
ECBA DD 22 A8 EF    	LD	(_DPB),IX
ECBE 7D             	LD	A,L
ECBF 32 89 EF       	LD	(_DSK),A
ECC2                CHGDRV2:
ECC2 C5             	PUSH	BC
ECC3 D5             	PUSH	DE
ECC4 ED 73 19 ED    	LD	(SPPAT2+1),SP
ECC8 F3             	DI
ECC9 DD F9          	LD	SP,IX
ECCB                
ECCB E1             	POP	HL		;DPB_00_FATLN
ECCC E1             	POP	HL		;DPB_02_DRD
ECCD 22 25 EC       	LD	(DRDPAT+1),HL
ECD0                
ECD0 E1             	POP	HL
ECD1 22 35 EC       	LD	(DWTPAT+1),HL	;DPB_04_DWT
ECD4                
ECD4 E1             	POP	HL		;L=DPB_06_FATID H=DPB_07_SECPCL
ECD5 7C             	LD	A,H
ECD6 32 5D E3       	LD	(SPCPAT+1),A	;1クラスタの論理セクタ数
ECD9 3D             	DEC	A
ECDA 32 C3 EA       	LD	(NCPAT+1),A
ECDD                
ECDD E1             	POP	HL		;DPB_08_MAXCL
ECDE 7D             	LD	A,L
ECDF 32 7C E3       	LD	(CLPAT2+1),A
ECE2 7C             	LD	A,H
ECE3 32 78 E3       	LD	(CLPAT1+1),A
ECE6 2B             	DEC	HL
ECE7 22 80 E5       	LD	(MAXCLP+1),HL
ECEA                
ECEA E1             	POP	HL		;L=DPB_0A_FDMODE H=DPB_0B_DIRSCNT
ECEB 7D             	LD	A,L
ECEC F6 FE          	OR	0FEH
ECEE 32 1A EE       	LD	(FDMODE+1),A
ECF1 07             	RLCA
ECF2 E6 03          	AND	3
ECF4 32 02 EE       	LD	(FSPAT+1),A
ECF7 4C             	LD	C,H
ECF8                
ECF8 E1             	POP	HL		;L=DPB_0C_MAXCYL H=DPB_0D_MAXSEC
ECF9                
ECF9 E1             	POP	HL		;L=DPB_0E_FATPS H=DPB_0F_BPS
ECFA 7C             	LD	A,H		;DPB_0F_BPS
ECFB E6 07          	AND	7
ECFD 32 47 E8       	LD	(SECSZ+2),A	;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
ED00                				;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM等
ED00                				;1セクタ1024 2HD/2HDE98
ED00                				;1セクタ256 GRAM/RAMF/CMOS/等
ED00                				;1024	512	256
ED00                				;4	2	1
ED00 87             	ADD	A,A		;8	4	2
ED01 87             	ADD	A,A		;010H	8	4
ED02 87             	ADD	A,A		;020H	010H	8
ED03 32 D9 E1       	LD	(SDECPAT+1),A	;1セクタ辺りのディレクトリエントリ数
ED06                
ED06 26 00          	LD	H,0
ED08 22 FA F0       	LD	(_FATPS),HL
ED0B                
ED0B E1             	POP	HL		;L=DPB_10_DIRPS
ED0C 22 FC F0       	LD	(_DIRPS),HL
ED0F                
ED0F E1             	POP	HL		;L=DPB_12_DEVICE H=DPB_13_UNITNO
ED10 7C             	LD	A,H
ED11 32 84 EF       	LD	(_DRIVE),A
ED14                
ED14 E1             	POP	HL		;DPB_14_ADDCL16
ED15 22 6D E3       	LD	(CLSPAT+1),HL
ED18                
ED18 31 00 00       SPPAT2:	LD	SP,0		;元のSPを復元
ED1B FB             	EI
ED1C 2A FC F0       	LD	HL,(_DIRPS)
ED1F 06 00          	LD	B,0
ED21 09             	ADD	HL,BC
ED22 22 F4 E1       	LD	(MD_PAT+1),HL
ED25                
ED25 2A 80 E5       	LD	HL,(MAXCLP+1);
ED28 11 F6 0F       	LD	DE,4086
ED2B B7             	OR	A
ED2C ED 52          	SBC	HL,DE
ED2E 30 0F          	JR	NC,SETFAT16
ED30 21 49 EA       	LD	HL,GNCL		;FAT12
ED33 11 6C EA       	LD	DE,SNCL
ED36 01 88 EC       	LD	BC,FATSETUP12
ED39 DD CB 0F AE    	RES	5,(IX+00FH)	;DPB_0F_BPS(FAT12)
ED3D 18 0D          	JR	EXTRA1
ED3F                SETFAT16:
ED3F 21 A0 EA       	LD	HL,GNCL16	;FAT16
ED42 11 AD EA       	LD	DE,SNCL16
ED45 01 95 EC       	LD	BC,FATSETUP16
ED48 DD CB 0F EE    	SET	5,(IX+00FH)	;DPB_0F_BPS(FAT16)
ED4C                EXTRA1:
ED4C 22 F8 EF       	LD	(GNCPAT+1),HL
ED4F ED 53 FB EF    	LD	(SNCPAT+1),DE
ED53 ED 43 60 EC    	LD	(FATSX+1),BC
ED57 D1             	POP	DE
ED58 C1             	POP	BC
ED59 AF             	XOR	A
ED5A C9             	RET
ED5B                
ED5B                GETDPBD:
ED5B DD E3          	EX	(SP),IX
ED5D DD E5          	PUSH	IX
ED5F 3A 88 EF       	LD	A,(_DRV)
ED62 18 07          	JR	GETDPB1
ED64                
ED64                CHGDRVR:
ED64 CD D9 EF       	CALL	_CHGDRV
ED67 D8             	RET	C
ED68 3A 89 EF       	LD	A,(_DSK)
ED6B                GETDPB1:
ED6B C3 DC EF       	JP	_GETDPB
ED6E                
ED6E                GETDPB:
ED6E FE 08          	CP	8
ED70 3F             	CCF
ED71 D8             	RET	C
ED72 0F             	RRCA
ED73 0F             	RRCA
ED74 0F             	RRCA
ED75 DD             	DB	0DDH		;Z80未定義命令
ED76 6F             	LD	L,A		;LD	IXL,A
ED77 DD             	DB	0DDH		;Z80未定義命令
ED78 26 F1          	LD	H,DEVICE/256	;LD	IXH,DEVICE/256
ED7A DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
ED7D B7             	OR	A		;CF=0の為
ED7E DD CB 0F 6E    	BIT	5,(IX+00FH)	;DPB_0F_BPS
ED82 C0             	RET	NZ		;FAT16
ED83 DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
ED87 C0             	RET	NZ		;BPB
ED88 FE 01          	CP	001H		;A=0 THEN CF=1
ED8A C9             	RET
ED8B                
ED8B                _SYS5F:
ED8B AF             	XOR	A
ED8C                FFLUSH:
ED8C F5             	PUSH	AF
ED8D 3E FF          	LD	A,0FFH
ED8F 32 39 EF       	LD	(SFILE),A
ED92 CD 87 E9       	CALL	DWTX
ED95 3E FF          	LD	A,0FFH
ED97 32 A5 EF       	LD	(_DBDRV),A
ED9A CD D1 E9       	CALL	WTFATX
ED9D AF             	XOR	A
ED9E 32 AB EF       	LD	(_FATIX),A
EDA1 2F             	CPL
EDA2 32 AA EF       	LD	(_FATDRV),A
EDA5 F1             	POP	AF
EDA6 C9             	RET
EDA7                
EDA7                	INCLUDE	"X1DISK.ASM"
EDA7                
EDA7                ;	LSX-Dodgers DISK
EDA7                ;	X1/turbo/Z
EDA7                
EDA7                SEEK:
EDA7 06 10          	LD	B,16
EDA9 DD 4E 0D       MAXSEC:	LD	C,(IX+0DH)	;DPB_0D_MAXSEC
EDAC AF             	XOR	A
EDAD EB             	EX	DE,HL
EDAE                DIV1:
EDAE 29             	ADD	HL,HL
EDAF 8F             	ADC	A,A
EDB0 B9             	CP	C
EDB1 38 02          	JR	C,DIV2
EDB3 91             	SUB	C
EDB4 2C             	INC	L
EDB5                DIV2:
EDB5 10 F7          	DJNZ	DIV1
EDB7                
EDB7 3C             	INC	A	;最小のセクタは１固定
EDB8 55             	LD	D,L	;TRACK
EDB9 5F             	LD	E,A	;SECTOR
EDBA CB 3A          	SRL	D	;CYLINDER
EDBC 9F             	SBC	A,A
EDBD E6 10          	AND	010H	;SIDE
EDBF 4F             	LD	C,A
EDC0                
EDC0 3A 84 EF       	LD	A,(_DRIVE)
EDC3 FE 04          	CP	4
EDC5 3F             	CCF
EDC6 D8             	RET	C
EDC7 B1             	OR	C
EDC8 32 46 EE       	LD	(MOPAT+1),A	;Motor off data
EDCB 01 FC 0F       	LD	BC,00FFCH
EDCE F6 80          	OR	080H		;Motor on
EDD0 ED 79          	OUT	(C),A
EDD2                
EDD2 CD 18 EE       	CALL	SETMODE
EDD5 D8             	RET	C
EDD6                
EDD6 CD 5B EE       	CALL	DRIVE
EDD9 FE FF          	CP	0FFH		;A=0FFH Unknown CYLINDER
EDDB CC 3A EE       	CALL	Z,FDCRES	;Restore
EDDE 0E F9          	LD	C,0F9H
EDE0 ED 79          	OUT	(C),A		;Currrent CYLINDER
EDE2 92             	SUB	D
EDE3 C8             	RET	Z		;No seek
EDE4                
EDE4 3A 86 EF       	LD	A,(_ISEEK)
EDE7 4F             	LD	C,A
EDE8                
EDE8 DD 7E 0C       	LD	A,(IX+00CH)	;DPB_0C_MAXCYL
EDEB 3D             	DEC	A
EDEC BA             	CP	D		;Over CYLINDER
EDED D8             	RET	C
EDEE                
EDEE B9             	CP	C		;for Built-in 2DD
EDEF 38 03          	JR	C,SETM2
EDF1 78             	LD	A,B		;B=00FH
EDF2 DB FE          	IN	A,(0FEH)		;2HD mode for 2DD seek
EDF4                SETM2:
EDF4 78             	LD	A,B
EDF5 DB FD          	IN	A,(0FDH)		;MFM mode
EDF7                
EDF7 0E FB          	LD	C,0FBH
EDF9 ED 51          	OUT	(C),D
EDFB 72             	LD	(HL),D
EDFC 0E 18          	LD	C,018H		;Seek
EDFE                FDCCMD2:
EDFE 3A 85 EF       	LD	A,(_SEEKSP)
EE01 E6 FF          FSPAT:	AND	0FFH
EE03 B1             	OR	C
EE04                
EE04                FDCCMD:
EE04 CD 51 EE       	CALL	COMSET
EE07                
EE07 3E 80          FDCPAT:	LD	A,080H		;FDC COMMAND(Self-modifying code)
EE09 E6 20          	AND	020H		;Write data Write track
EE0B 3C             	INC	A
EE0C                
EE0C                SST:
EE0C 0E 00          	LD	C,0
EE0E                SST1:
EE0E 0D             	DEC	C		; 4
EE0F 20 FD          	JR	NZ,SST1		;12 * 256 / 4 = About 1ms
EE11 3D             	DEC	A
EE12 20 FA          	JR	NZ,SST1
EE14                
EE14 3C             	INC	A		;A=1
EE15 CD 23 EE       	CALL	READY
EE18                SETMODE:
EE18 78             	LD	A,B		;B=00FH
EE19 DB FF          FDMODE:	IN	A,(0FFH)	;Floppy mode(2D/2HD) (Self-modifying code)
EE1B                
EE1B 78             	LD	A,B
EE1C DB FD          	IN	A,(0FDH)	;MFM mode
EE1E                
EE1E CD 55 EE       	CALL	DELAY0		;Head select time
EE21 3E 81          	LD	A,081H
EE23                READY:
EE23 32 2D EE       	LD	(WAITA+1),A
EE26 E5             	PUSH	HL
EE27 0E F8          	LD	C,0F8H
EE29 61             	LD	H,C
EE2A                READY2:
EE2A ED 78          	IN	A,(C)
EE2C E6 81          WAITA:	AND	081H		;NOT READY,BUSY
EE2E 28 08          	JR	Z,READYE
EE30 E3             	EX	(SP),HL		;wait 19clock
EE31 E3             	EX	(SP),HL		; //
EE32 2B             	DEC	HL
EE33 7C             	LD	A,H
EE34 B5             	OR	L
EE35 20 F3          	JR	NZ,READY2
EE37 37             	SCF
EE38                READYE:
EE38 E1             	POP	HL
EE39 C9             	RET
EE3A                
EE3A                FDCRES:
EE3A 36 00          	LD	(HL),0
EE3C 0E 08          	LD	C,8
EE3E 18 BE          	JR	FDCCMD2
EE40                
EE40                FDMOFF:
EE40 F5             	PUSH	AF
EE41 C5             	PUSH	BC
EE42 01 FC 0F       	LD	BC,00FFCH	;Motor off
EE45 3E 00          MOPAT:	LD	A,000H		;(Self-rewriting)
EE47 ED 79          	OUT	(C),A
EE49 C1             	POP	BC
EE4A F1             	POP	AF
EE4B C9             	RET
EE4C                
EE4C                SECSET:
EE4C 01 FA 0F       	LD	BC,00FFAH
EE4F ED 59          	OUT	(C),E
EE51                COMSET:
EE51 0E F8          	LD	C,0F8H
EE53 ED 79          	OUT	(C),A
EE55                DELAY0:
EE55 3E 1A          	LD	A,26
EE57                DELAY:
EE57 3D             	DEC	A
EE58 20 FD          	JR	NZ,DELAY
EE5A C9             	RET
EE5B                
EE5B                DRIVE:
EE5B 2A 84 EF       	LD	HL,(_DRIVE)
EE5E 26 EF          	LD	H,_CYL0/256
EE60 CB FD          	SET	7,L
EE62 7E             	LD	A,(HL)
EE63 C9             	RET
EE64                
EE64                RNF:
EE64 CD 5B EE       	CALL	DRIVE
EE67 36 FF          	LD	(HL),0FFH
EE69 C9             	RET
EE6A                
EE6A 02             RETRY:	DB	2
EE6B                
EE6B                
EE6B                ;	FLOPPY DISK DRIVER(DMA)
EE6B                
EE6B                
EE6B                WTTRK:
EE6B 06 01          	LD	B,1
EE6D 3E F4          	LD	A,0F4H
EE6F 18 02          	JR	WTTRK1
EE71                FDWT:
EE71 3E A0          	LD	A,0A0H
EE73                WTTRK1:
EE73 32 08 EE       	LD	(FDCPAT+1),A
EE76 3E 10          	LD	A,16
EE78 18 0C          	JR	DISK
EE7A                
EE7A                DISKOK:
EE7A 06 01          FDCNT:	LD	B,1
EE7C 10 0B          	DJNZ	DISK1
EE7E C9             	RET
EE7F                
EE7F                FDRD:
EE7F 3E 80          	LD	A,080H
EE81 32 08 EE       	LD	(FDCPAT+1),A
EE84 3E 0E          	LD	A,14
EE86                
EE86                DISK:
EE86 32 9D EE       	LD	(DMAPAT+1),A
EE89                DISK1:
EE89 78             	LD	A,B
EE8A 32 7B EE       	LD	(FDCNT+1),A
EE8D 22 F5 EE       	LD	(DMAD+11),HL
EE90                DISKR:
EE90 3E 02          	LD	A,2		;Retry count
EE92 32 6A EE       	LD	(RETRY),A
EE95                DISK2:
EE95 D5             	PUSH	DE
EE96 CD A7 ED       	CALL	SEEK
EE99 38 43          	JR	C,ERRF
EE9B F3             	DI
EE9C                
EE9C 3E 0E          DMAPAT:	LD	A,14		;自己書き換え
EE9E 21 EA EE       	LD	HL,DMAD
EEA1 CD 7C DF       	CALL	SETDMA
EEA4 ED 49          	OUT	(C),C		;OUT 01F87H,087H WR6 イネーブル
EEA6 3A 08 EE       	LD	A,(FDCPAT+1)
EEA9 C5             	PUSH	BC
EEAA CD 4C EE       	CALL	SECSET
EEAD 2A F5 EE       	LD	HL,(DMAHL)
EEB0 23             	INC	HL
EEB1 11 06 BB       	LD	DE,0BB06H	;READ DMA
EEB4                
EEB4 3E 03          	LD	A,3
EEB6 CD 23 EE       	CALL	READY
EEB9 ED 78          	IN	A,(C)
EEBB                
EEBB C1             	POP	BC
EEBC ED 51          	OUT	(C),D		;読み出しマスク設定
EEBE ED 59          	OUT	(C),E		;バイトカウンタ(LH)
EEC0 ED 58          	IN	E,(C)
EEC2 ED 50          	IN	D,(C)
EEC4 19             	ADD	HL,DE
EEC5 D1             	POP	DE
EEC6 13             	INC	DE
EEC7 FB             	EI
EEC8 CD 40 EE       	CALL	FDMOFF
EECB B7             	OR	A
EECC 28 AC          	JR	Z,DISKOK
EECE 1B             	DEC	DE
EECF CB 67          	BIT	4,A
EED1 C4 64 EE       	CALL	NZ,RNF
EED4                DISKE2:
EED4 21 6A EE       	LD	HL,RETRY
EED7 35             	DEC	(HL)
EED8 20 BB          	JR	NZ,DISK2
EEDA B7             	OR	A
EEDB 28 0A          	JR	Z,ERR
EEDD D5             	PUSH	DE
EEDE                ERRF:
EEDE D1             	POP	DE
EEDF                DELP:
EEDF CD 64 EE       	CALL	RNF
EEE2 CD 40 EE       	CALL	FDMOFF
EEE5 3E FF          	LD	A,0FFH
EEE7                ERR:
EEE7 BF             	CP	A
EEE8 37             	SCF
EEE9 C9             	RET
EEEA                
EEEA                			;X1turbo DISK DMA
EEEA C3             DMAD:	DB	0C3H	;WR6 リセット
EEEB 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
EEEC FB 0F          	DW	00FFBH	;ポートA開始アドレス FDC データレジスタ
EEEE FF FF          	DW	0FFFFH	;ブロック長(転送サイズ-1)
EEF0 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
EEF1 10             	DB	010H	;WR2 ポートBインクリメント
EEF2 80             	DB	080H	;WR3
EEF3 92             	DB	092H	;WR5 WAIT RDY:LOW
EEF4 8D             	DB	08DH	;WR4 バイト ポートB開始アドレス(LH)
EEF5 00 00          DMAHL:	DW	0	;ポートB開始アドレス
EEF7 CF             	DB	0CFH	;WR6 ロード
EEF8 01             	DB	001H	;WR0 ポートB←ポートB 転送
EEF9 CF             	DB	0CFH	;WR6 ロード
EEFA                
EEFA                DMAE:
EEFA                
EEFA 00 00 1E EF    AT_R	EQU	WTTRK-AT_DWT
EEFA                
EEFA                	INCLUDE	"LDWORK.ASM"
EEFA                
EEFA                ;	LSX-Dodgers WORK0
EEFA                ;
EEFA                ;	CP/M互換BIOS
EEFA                ;	BOOT:アドレス下位1バイトが0になるように
EEFA                AT_WORK:
EEFA                	DS	WORKAD-AT_WORK
EF00                
EF00                CPM_BOOT:
EF00 C3 00 00       	JP	0
EF03                _SYS00:		;(BDOS)プログラム終了
EF03                CPM_WBOOT:
EF03 C3 09 D1       	JP	WBOOT1
EF06                CPM_CONST:
EF06 C3 26 DC       	JP	CONSTX
EF09                _SYS07:		;(BDOS)コンソール直接入力
EF09                CPM_CONIN:
EF09 C3 CD DB       	JP	FLGET
EF0C                CPM_CONOUT:
EF0C C3 6D DE       	JP	CONOUT1
EF0F                
EF0F                DECBF:
EF0F                	DS	5
EF14 00             FDRV	DB	0
EF15                FNAME	DS	36
EF39                SFILE:	DS	33		;DRV FILENAME
EF5A                HLBUF:	DS	3		;Random record buffer
EF5D                
EF5D 00 00          LEFTX:	DW	0
EF5F 00 00          DTAX:	DW	0
EF61                
EF61                ZERO:
EF61                BEEPD:
EF61 00 8E 01 00    	DB	0,08EH,1,0,00BH,0,00CH,010H
EF65 0B 00 0C 10
EF69 07 3E 08 10    	DB	007H,03EH,008H,010H,00DH,0,0FFH
EF6D 0D 00 FF
EF70 00 00 EF 62    RTC_YY	EQU	BEEPD+1
EF70 00 00 EF 63    RTC_MW	EQU	BEEPD+2
EF70 00 00 EF 64    RTC_DD	EQU	BEEPD+3
EF70 00 00 EF 65    RTC_TT	EQU	BEEPD+4
EF70 00 00 EF 66    RTC_MM	EQU	BEEPD+5
EF70 00 00 EF 67    RTC_SS	EQU	BEEPD+6
EF70                
EF70 00             CHECK:	DB	0
EF71                
EF71 4F 4B 24       OK:	DB	"OK$"
EF74                	DS	5
EF79 45 72 72 6F    COMERM:	DB	"Error!$"
EF7D 72 21 24
EF80                ;	システムワークエリア
EF80                ;	_CYL0:アドレス下位1バイトが080Hになるように
EF80 FF             _CYL0:	DB	0FFH	;Cylinder
EF81 FF             _CYL1:	DB	0FFH	;Cylinder
EF82 FF             _CYL2:	DB	0FFH	;Cylinder
EF83 FF             _CYL3:	DB	0FFH	;Cylinder
EF84 00             _DRIVE:	DB	0	;unit number
EF85 00             _SEEKSP:DB	0	;Seek speed
EF86 FF             _ISEEK:	DB	0FFH	;
EF87 00             _DVSW:	DB	0
EF88 00             _DRV:	DB	0
EF89 FF             _DSK:	DB	0FFH
EF8A 80 00          _DTA:	DW	00080H
EF8C 00 00          _CTC:	DW	0
EF8E 00 00          _TXADR:	DW	0
EF90 00 00          _KEYPS:	DW	0
EF92 00 FF          _KEYD:	DW	0FF00H	;キーデータ
EF94 C2 10          _KEYSP:	DW	010C2H
EF96 07             _COLORF:DB	COLORF	;色
EF97 18             _LINE:	DB	LINE
EF98                
EF98 00 00          _FCB:	DW	0
EF9A 00 00          _FBPS:	DW	0	;SEARCH FILES
EF9C 00 00          _FBAD:	DW	0	;    //
EF9E 00             _FBCNT:	DB	0	;    //
EF9F 00             _FILEN:	DB	0
EFA0 00             _DIRF:	DB	0	;bit7:ディレクトリ bit0-6:セクタインデックス
EFA1                	DS	1
EFA2 00             _WTFATF:DB	0	;FATバッファの更新フラグ
EFA3                	DS	1
EFA4 00             _WTDBF:	DB	0	;データバッファの更新フラグ
EFA5 FF             _DBDRV:	DB	0FFH	;データバッファにあるデータを読み込んだドライブ
EFA6 00 00          _DBSEC:	DW	0	;データバッファにあるデータを読み込んだセクタ番号
EFA8 00 00          _DPB:	DW	0
EFAA                _FATDRV:
EFAA FF             	DB	0FFH	;FATバッファに読み込んでいるドライブ
EFAB 00             _FATIX:	DB	0	;FATバッファに読み込んでいるインデックス
EFAC                _FAKEFREE:
EFAC 00 00          	DW	0	;偽の残量（FATサイズが大きくなると重くなるのでその対策）
EFAE                
EFAE                	DS	2
EFB0                
EFB0                CRTCD:	
EFB0 6F             	DB	06FH
EFB1                _WIDTH:	
EFB1 50             	DB	WIDTH
EFB2                TVRAMTOP:
EFB2 59 38          	DB	059H,038H
EFB4 1F 02          	DB	01FH,002H
EFB6                _LINE2:
EFB6 19             	DB	019H
EFB7 1C             	DB	01CH
EFB8                WKE4:
EFB8 00             	DB	000H
EFB9                WK40:
EFB9 07             	DB	007H
EFBA                _PAGE_MINUS:
EFBA 80 F8          	DW	0-WIDTH*LINE
EFBC                _WIDTH_MINUS:
EFBC B0 FF          	DW	0-WIDTH
EFBE                WK30:
EFBE 0C             	DB	00CH
EFBF                WK31:
EFBF                WK1FD0:
EFBF 20             	DB	020H
EFC0                
EFC0 FB DA          CTC0:	DW	INTCTCE
EFC2 FB DA          CTC1:	DW	INTCTCE
EFC4 1D DB          CTC2:	DW	INTCTC2
EFC6 FB DA          CTC3:	DW	INTCTCE
EFC8 E4 DA          INTVEC:	DW	INT
EFCA                
EFCA                ;	LSX-Dodgers 独自BIOS
EFCA                
EFCA C3 52 E0       _INKEY:	JP	INKEY
EFCD C3 F4 DC       _PRINT:	JP	PRINT
EFD0 C3 BA DF       _SCRN:	JP	SCRN
EFD3 C3 E4 DF       _POS:	JP	POS
EFD6 C3 36 DE       _LOC:	JP	LOC
EFD9                _CHGDRV:
EFD9 C3 A2 EC       	JP	CHGDRV
EFDC                _GETDPB:
EFDC C3 6E ED       	JP	GETDPB
EFDF                _FFLUSH:
EFDF C3 8C ED       	JP	FFLUSH
EFE2                _RDFATX:
EFE2 C3 A7 E9       	JP	RDFATX
EFE5 C3 CF EA       _RDFAT:	JP	RDFAT
EFE8 C3 6B EE       _WTTRK:	JP	WTTRK
EFEB C3 7F EE       _FDRD:	JP	FDRD
EFEE C3 71 EE       _FDWT:	JP	FDWT
EFF1                _BPB2DPB:
EFF1 C3 34 EB       	JP	BPB2DPB
EFF4                	DS	3
EFF7                _GNCL:
EFF7 C3 49 EA       GNCPAT:	JP	GNCL		; self-modifying code
EFFA                _SNCL:
EFFA C3 6C EA       SNCPAT:	JP	SNCL		; self-modifying code
EFFD C3 75 D1       _COMANL:JP	COMANL
F000                
F000                _WE:
F000                	INCLUDE	"LDCALL.ASM"
F000                
F000                ;	LSX-Dodgers システムコール(BDOS)
F000                ;
F000                ;	LSX-Dodgers SYSTEM CALL
F000                ;	STABLE:アドレス下位1バイトが0になるように
F000                
F000                STABLE:
F000                ;0
F000 03 EF A0 DB    	DW	_SYS00,_SYS01,_SYS02,_SYS03
F004 AC DB 06 E2
F008 FC D7 FC D7    	DW	_SYS04,_SYS05,_SYS06,_SYS07
F00C B1 DB 09 EF
F010 B9 DB FE D7    	DW	_SYS08,_SYS09,_SYS0A,_SYS0B
F014 F2 DB 1E DC
F018 13 D8 18 D8    	DW	_SYS0C,_SYS0D,_SYS0E,_SYS0F
F01C 27 D8 3A D8
F020                ;1
F020 8E D8 D5 D8    	DW	_SYS10,_SYS11,_SYS12,_SYS13
F024 1E D9 54 D9
F028 5C D9 7A D9    	DW	_SYS14,_SYS15,_SYS16,_SYS17
F02C 97 D9 8F D9
F030 F2 D9 F7 D9    	DW	_SYS18,_SYS19,_SYS1A,_SYS1B
F034 FC D9 02 DA
F038 FC D7 28 DA    	DW	_SYS1C,_SYS1D,_SYS1E,_SYS1F
F03C FC D7 2C DA
F040                ;2
F040 FC D7 CE D9    	DW	_SYS20,_SYS21,_SYS22,_SYS23
F044 E0 D9 33 DA
F048 5F DA FC D7    	DW	_SYS24,_ERROR,_SYS26,_SYS27
F04C 5A E6 3F E7
F050 E0 D9 68 DA    	DW	_SYS28,_SYS5C,_SYS2A,_SYS2B
F054 34 DC 06 E2
F058 57 DC 06 E2    	DW	_SYS2C,_SYS2D,_SYS2E,_SYS2F
F05C FC D7 8B DA
F060                ;3
F060 85 DA FC D7    	DW	_SYS30,_ERROR,_ERROR,_ERROR
F064 FC D7 FC D7
F068 FC D7 FC D7    	DW	_ERROR,_ERROR,_ERROR,_ERROR
F06C FC D7 FC D7
F070 FC D7 06 E2    	DW	_ERROR,_SYS39,_SYS3A,_SYS5A
F074 06 E2 AC DA
F078                ;DOS2
F078 DF D7          	DW	_DOS2
F07A                
F07A                	DS	2
F07C 00 F2          _FATBF:	DW	FATBF
F07E 00 FA          _DTBUF:	DW	DTBUF
F080                
F080                ;	コントロールコードテーブル
F080                ;	CTRLTB:アドレス下位1バイトが080Hになるように
F080                
F080                CTRLTB:
F080 AB DD AB DD    	DW	CTRL00,CTRL00,CTRL02,CTRL03	;  A,B,C
F084 E7 DD 2E DF
F088 28 DF 0B DE    	DW	CTRL04,CTRL05,CTRL06,CTRL07	;D,E,F,G
F08C 07 DF 8E DE
F090 B7 DD D8 DD    	DW	CTRL08,CTRL09,CTRL0A,CTRL0B	;H,I,J,K
F094 31 DF 4C DE
F098 04 DF 31 DE    	DW	CTRL0C,CTRL0D,CTRL0E,CTRL00	;L,M,N,O
F09C 46 DF AB DD
F0A0 AB DD AB DD    	DW	CTRL00,CTRL00,CTRL12,CTRL00	;P,Q,R,S
F0A4 44 DE AB DD
F0A8 AB DD AB DD    	DW	CTRL00,CTRL00,CTRL00,CTRL00	;T,U,V,W
F0AC AB DD AB DD
F0B0 AB DD AB DD    	DW	CTRL00,CTRL00,CTRL0C,CTRL1B	;X,Y,Z,ESC
F0B4 04 DF 53 DE
F0B8 D2 DD BE DD    	DW	CTRL1C,CTRL1D,CTRL1E,CTRL1F	;→,←,↑,↓
F0BC C7 DD 31 DF
F0C0                
F0C0                	DS	02AH
F0EA                
F0EA 16 17          SDDATA:	DB	22,23		;(FCB)ファイルを最後に変更した時刻
F0EC 14 15          	DB	20,21		;(FCB)ファイルを最後に変更した日付
F0EE 1A 1B          	DB	26,27		;(FCB)ファイルの先頭クラスタ
F0F0 10 11 12 13    	DB	16,17,18,19	;(FCB)ファイルのサイズ(バイト単位)
F0F4                SDDATAE:
F0F4                
F0F4                SCDIR:	DS	2		;+14 +15
F0F6                SFBPS:	DS	2		;FBPS
F0F8                SFNDF:	DS	2		;FILEN DIRF
F0FA                
F0FA 00 00          _FATPS:	DW	0
F0FC 00 00          _DIRPS:	DW	0
F0FE 00 00          _CLPS:	DW	0
F100                
F100                _PE:
F100                	INCLUDE	"X1DPB.ASM"
F100                
F100                ;	LSX-Dodgers DPB
F100                ;	X1/turbo/Z
F100                
F100                DEVICE:
F100                
F100                ;	A:
F100                
F100 02 00          	DW	2	;DPB_00_FATLN
F102 EB EF          	DW	_FDRD	;DPB_02_DRD
F104 EE EF          	DW	_FDWT	;DPB_04_DWT
F106 FD             	DB	0FDH	;DPB_06_FATID
F107 02             	DB	2	;DPB_07_SECPCL
F108 64 01          	DW	356	;DPB_08_MAXCL
F10A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F10B 07             	DB	7	;DPB_0B_DIRSCNT
F10C 28             	DB	40	;DPB_0C_MAXCYL
F10D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F10E 01             	DB	1	;DPB_0E_FATPS
F10F 82             	DB	082H	;DPB_0F_BPS
F110 05 00          	DW	5	;DPB_10_DIRPS
F112 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F113 00             	DB	0	;DPB_13_UNITNO
F114 08 00          	DW	8	;DPB_14_ADDCL16
F116 00 00          	DW	0	;DPB_16
F118 00 00          	DW	0	;DPB_18
F11A 00 00          	DW	0	;DPB_1A_SDIR
F11C 46 44 44 30    	DB	"FDD0"	;DPB_1C_NAME
F120                
F120                ;	B:
F120                
F120 02 00          	DW	2	;DPB_00_FATLN
F122 EB EF          	DW	_FDRD	;DPB_02_DRD
F124 EE EF          	DW	_FDWT	;DPB_04_DWT
F126 FD             	DB	0FDH	;DPB_06_FATID
F127 02             	DB	2	;DPB_07_SECPCL
F128 64 01          	DW	356	;DPB_08_MAXCL
F12A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F12B 07             	DB	7	;DPB_0B_DIRSCNT
F12C 28             	DB	40	;DPB_0C_MAXCYL
F12D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F12E 01             	DB	1	;DPB_0E_FATPS
F12F 82             	DB	082H	;DPB_0F_BPS
F130 05 00          	DW	5	;DPB_10_DIRPS
F132 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F133 01             	DB	1	;DPB_13_UNITNO
F134 08 00          	DW	8	;DPB_14_ADDCL16
F136 00 00          	DW	0	;DPB_16
F138 00 00          	DW	0	;DPB_18
F13A 00 00          	DW	0	;DPB_1A_SDIR
F13C 46 44 44 31    	DB	"FDD1"	;DPB_1C_NAME
F140                
F140                ;	C:
F140                
F140 02 00          	DW	2	;DPB_00_FATLN
F142 EB EF          	DW	_FDRD	;DPB_02_DRD
F144 EE EF          	DW	_FDWT	;DPB_04_DWT
F146 FD             	DB	0FDH	;DPB_06_FATID
F147 02             	DB	2	;DPB_07_SECPCL
F148 64 01          	DW	356	;DPB_08_MAXCL
F14A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F14B 07             	DB	7	;DPB_0B_DIRSCNT
F14C 28             	DB	40	;DPB_0C_MAXCYL
F14D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F14E 01             	DB	1	;DPB_0E_FATPS
F14F 82             	DB	082H	;DPB_0F_BPS
F150 05 00          	DW	5	;DPB_10_DIRPS
F152 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F153 02             	DB	2	;DPB_13_UNITNO
F154 08 00          	DW	8	;DPB_14_ADDCL16
F156 00 00          	DW	0	;DPB_16
F158 00 00          	DW	0	;DPB_18
F15A 00 00          	DW	0	;DPB_1A_SDIR
F15C 46 44 44 32    	DB	"FDD2"	;DPB_1C_NAME
F160                
F160                ;	D:
F160                
F160 02 00          	DW	2	;DPB_00_FATLN
F162 EB EF          	DW	_FDRD	;DPB_02_DRD
F164 EE EF          	DW	_FDWT	;DPB_04_DWT
F166 FD             	DB	0FDH	;DPB_06_FATID
F167 02             	DB	2	;DPB_07_SECPCL
F168 64 01          	DW	356	;DPB_08_MAXCL
F16A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F16B 07             	DB	7	;DPB_0B_DIRSCNT
F16C 28             	DB	40	;DPB_0C_MAXCYL
F16D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F16E 01             	DB	1	;DPB_0E_FATPS
F16F 82             	DB	082H	;DPB_0F_BPS
F170 05 00          	DW	5	;DPB_10_DIRPS
F172 A7             	DB	0A7H	;DPB_12_DEVICE
F173 03             	DB	3	;DPB_13_UNITNO
F174 08 00          	DW	8	;DPB_14_ADDCL16
F176 00 00          	DW	0	;DPB_16
F178 00 00          	DW	0	;DPB_18
F17A 00 00          	DW	0	;DPB_1A_SDIR
F17C 46 44 44 33    	DB	"FDD3"	;DPB_1C_NAME
F180                
F180                ;	E:
F180                
F180 00 00          EMMFL:	DW	0	;DPB_00_FATLN
F182 6D D7          EMMRD:	DW	EDRD	;DPB_02_DRD
F184 69 D7          EMMWR:	DW	EDWT	;DPB_04_DWT
F186 FE             	DB	0FEH	;DPB_06_FATID
F187 02             	DB	2	;DPB_07_SECPCL
F188 00 00          EMMCL:	DW	0	;DPB_08_MAXCL
F18A 00             	DB	0	;DPB_0A_FDMODE
F18B 0C             	DB	12	;DPB_0B_DIRSCNT
F18C 00             	DB	0	;DPB_0C_MAXCYL
F18D 00             	DB	0	;DPB_0D_MAXSEC
F18E 02             	DB	2	;DPB_0E_FATPS
F18F 02             	DB	2	;DPB_0F_BPS
F190 0A 00          	DW	10	;DPB_10_DIRPS
F192 06             	DB	6	;DPB_12_DEVICE
F193 00             	DB	0	;DPB_13_UNITNO
F194 12 00          	DW	18	;DPB_14_ADDCL16
F196 00 00          	DW	0	;DPB_16
F198 00 00          	DW	0	;DPB_18
F19A 00 00          	DW	0	;DPB_1A_SDIR
F19C 45 4D 4D 30    	DB	"EMM0"	;DPB_1C_NAME
F1A0                
F1A0                ;	F:
F1A0                
F1A0 00 00          BANKFL:	DW	0	;DPB_00_FATLN
F1A2 04 D7          	DW	BDRD	;DPB_02_DRD
F1A4 00 D7          	DW	BDWT	;DPB_04_DWT
F1A6 F9             	DB	0F9H	;DPB_06_FATID
F1A7 02             	DB	2	;DPB_07_SECPCL
F1A8 00 00          BANKCL:	DW	0	;DPB_08_MAXCL
F1AA 00             	DB	0	;DPB_0A_FDMODE
F1AB 08             	DB	8	;DPB_0B_DIRSCNT
F1AC 00             	DB	0	;DPB_0C_MAXCYL
F1AD 01             	DB	1	;DPB_0D_MAXSEC
F1AE 00             	DB	0	;DPB_0E_FATPS
F1AF 02             	DB	2	;DPB_0F_BPS
F1B0 02 00          	DW	2	;DPB_10_DIRPS
F1B2 0B             	DB	00BH	;DPB_12_DEVICE
F1B3 00             	DB	0	;DPB_13_UNITNO
F1B4 06 00          	DW	6	;DPB_14_ADDCL16
F1B6 00 00          	DW	0	;DPB_16
F1B8 00 00          	DW	0	;DPB_18
F1BA 00 00          	DW	0	;DPB_1A_SDIR
F1BC 42 52 41 4D    	DB	"BRAM"	;DPB_1C_NAME
F1C0                
F1C0                ;	G:
F1C0                
F1C0 02 00          	DW	2	;DPB_00_FATLN
F1C2 C1 D6          	DW	GDRD	;DPB_02_DRD
F1C4 D8 D6          	DW	GDWT	;DPB_04_DWT
F1C6 FA             	DB	0FAH	;DPB_06_FATID
F1C7 01             	DB	1	;DPB_07_SECPCL
F1C8 B8 00          	DW	184	;DPB_08_MAXCL
F1CA 00             	DB	0	;DPB_0A_FDMODE
F1CB 07             	DB	7	;DPB_0B_DIRSCNT
F1CC 00             	DB	0	;DPB_0C_MAXCYL
F1CD 01             	DB	1	;DPB_0D_MAXSEC
F1CE 01             	DB	1	;DPB_0E_FATPS
F1CF 01             	DB	1	;DPB_0F_BPS
F1D0 03 00          	DW	3	;DPB_10_DIRPS
F1D2 05             	DB	5	;DPB_12_DEVICE
F1D3 01             	DB	1	;DPB_13_UNITNO
F1D4 08 00          	DW	8	;DPB_14_ADDCL16
F1D6 00 00          	DW	0	;DPB_16
F1D8 00 00          	DW	0	;DPB_18
F1DA 00 00          	DW	0	;DPB_1A_SDIR
F1DC 47 52 41 4D    	DB	"GRAM"	;DPB_1C_NAME
F1E0                
F1E0                ;	H:
F1E0                	DS	32-8
F1F8 00             	DB	0
F1F9                
F1F9                LAST_ADR:
F1F9                
F1F9                	END
F1F9                
