0000                ;	LSX-Dodgers for X1/turbo/Z
0000                ;	Programmed by
0000                ;	Gaku (Lovers/Tablacus)
0000                
0000                	INCLUDE	"X1DEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                ;	X1/turbo/Z
0000                
0000 00 00 00 00    MAC	EQU	0		;X1
0000 00 00 00 00    DEV	EQU	0
0000                
0000 00 00 01 1D    VER_6F	EQU	0011DH
0000                
0000 00 00 CD 00    RUN	EQU	0CD00H
0000 00 00 D3 06    BDOS	EQU	0D306H
0000 00 00 F0 00    WORKAD	EQU	0F000H
0000 00 00 F3 00    FATBF	EQU	0F300H
0000 00 00 FB 00    DTBUF	EQU	0FB00H
0000 00 00 FF 00    KEYBF	EQU	0FF00H
0000 00 00 FF 20    KBUF	EQU	0FF20H
0000 00 00 FF CA    EXTSP	EQU	0FFCAH
0000 00 00 FF D9    TRAP38	EQU	0FFD9H
0000 00 00 00 50    WIDTH	EQU	80
0000 00 00 00 18    LINE	EQU	24
0000 00 00 00 07    COLORF	EQU	7
0000 00 00 00 10    KEYSP_H	EQU	16
0000 00 00 00 C2    KEYSP_L	EQU	0C2H
0000 00 00 00 08    COMS	EQU	8
0000                
0000                	INCLUDE	"LDDEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                
0000 00 00 00 01    VER_1   EQU	1
0000 00 00 00 06    VER_2   EQU	6
0000 00 00 00 00    VER_3   EQU	0
0000 00 00 1D 00    MACW	EQU	MAC + 01D00H	;機種フラグとLD判別フラグ
0000 00 00 00 00    MACD	EQU	MAC + DEV * 256	;機種フラグとデバイスフラグ
0000 00 00 01 60    VER	EQU	VER_1 * 256 + VER_2 * 16 + VER_3
0000                
0000 00 00 00 05    SYSTEM	EQU	00005H
0000 00 00 00 0F    JP_HL	EQU	0000FH
0000 00 00 00 5C    FCB1	EQU	0005CH
0000 00 00 00 6C    FCB2	EQU	0006CH
0000 00 00 00 5D    FCB1FN	EQU	FCB1+1
0000 00 00 00 6D    FCB2FN	EQU	FCB2+1
0000 00 00 00 80    DTA1	EQU	00080H
0000                
0000 00 00 FF CA    EXTBIO	EQU	0FFCAH
0000                
0000 00 00 00 00    DPB_FATLN	EQU	00H
0000 00 00 00 02    DPB_DRD		EQU	02H
0000 00 00 00 04    DPB_DWT		EQU	04H
0000 00 00 00 06    DPB_FATID	EQU	06H
0000 00 00 00 07    DPB_SECPCL	EQU	07H
0000 00 00 00 08    DPB_MAXCL	EQU	08H
0000 00 00 00 0A    DPB_FDMODE	EQU	0AH
0000 00 00 00 0B    DPB_DIRSCNT	EQU	0BH
0000 00 00 00 0C    DPB_MAXCYL	EQU	0CH
0000 00 00 00 0D    DPB_MAXSEC	EQU	0DH
0000 00 00 00 0E    DPB_FATPS	EQU	0EH
0000 00 00 00 0F    DPB_BPS		EQU	0FH
0000 00 00 00 10    DPB_DIRPS	EQU	10H
0000 00 00 00 12    DPB_DEVICE	EQU	12H
0000 00 00 00 13    DPB_UNITNO	EQU	13H
0000 00 00 00 14    DPB_ADDCL	EQU	14H
0000                
0000 00 00 00 1A    DPB_SDIR	EQU	1AH
0000 00 00 00 1C    DPB_NAME	EQU	1CH
0000                
0000                
0000                	ORG	RUN-7
CCF9                
CCF9                ;	MSX BINARY HEADER
CCF9 FE             	DB	0FEH
CCFA                ;	MSX BINARY START ADDRESS
CCFA 00 CD          	DW	RUN
CCFC                ;	MSX BINARY END ADDRESS
CCFC F9 F2          	DW	LAST_ADR
CCFE                ;	MSX BINARY EXEC ADDRESS
CCFE 07 CD          	DW	START
CD00                
CD00                	INCLUDE	"X1INIT.ASM"
CD00                
CD00                ;	LSX-Dodgers INIT
CD00                ;	X1/turbo/Z
CD00                
CD00 C3 07 CD       	JP	START
CD03 00 1D          	DW	MACW
CD05 60 01          	DW	VER
CD07                
CD07                START:
CD07 F3             	DI
CD08 ED 5E          	IM	2
CD0A 31 CA FF       	LD	SP,EXTSP
CD0D CD 1B CD       	CALL	INIT		;NZならAUTOEXECを実行
CD10 21 00 00       	LD	HL,0
CD13 E5             	PUSH	HL
CD14 C8             	RET	Z
CD15 11 79 D0       	LD	DE,AUTOD
CD18 C3 FD F0       	JP	_COMANL
CD1B                
CD1B                INIT:
CD1B 3E 1E          	LD	A,01EH
CD1D D3 00          	OUT	(0),A
CD1F                
CD1F 01 00 00       	LD	BC,0
CD22 ED 43 8C F0    	LD	(_CTC),BC
CD26 01 04 0A       	LD	BC,00A04H
CD29 CD 23 D0       	CALL	CHKCTC
CD2C 01 04 07       	LD	BC,00704H
CD2F CD 23 D0       	CALL	CHKCTC
CD32 01 A8 1F       	LD	BC,01FA8H
CD35 CD 23 D0       	CALL	CHKCTC
CD38 01 A0 1F       	LD	BC,01FA0H
CD3B CD 23 D0       	CALL	CHKCTC
CD3E                ;
CD3E                INISIO:
CD3E 01 91 1F       	LD	BC,01F91H	;INIT SIO
CD41 16 01          	LD	D,1
CD43 ED 51          	OUT	(C),D
CD45                
CD45 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CD47 0E 93          	LD	C,093H
CD49 ED 51          	OUT	(C),D
CD4B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CD4D 0E 99          	LD	C,099H		;INIT SIO
CD4F 16 01          	LD	D,1
CD51 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CD53 0E 9B          	LD	C,09BH
CD55 ED 51          	OUT	(C),D
CD57 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CD59                
CD59 0E 80          	LD	C,080H		;INIT DMA
CD5B 21 06 C3       	LD	HL,0C306H
CD5E                INIDMA:
CD5E ED 61          	OUT	(C),H
CD60 2D             	DEC	L
CD61 20 FB          	JR	NZ,INIDMA
CD63                
CD63 3E E4          	LD	A,0E4H
CD65 CD F6 DE       	CALL	COMOUT
CD68 AF             	XOR	A
CD69 CD D0 DE       	CALL	OT49SB
CD6C                
CD6C 3E F0          	LD	A,INTVEC/256
CD6E ED 47          	LD	I,A
CD70                
CD70 ED 4B 8C F0    	LD	BC,(_CTC)
CD74 0D             	DEC	C
CD75 0D             	DEC	C
CD76                
CD76 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CD78 3E C0          	LD	A,CTC0-CPM_BOOT
CD7A ED 79          	OUT	(C),A
CD7C                
CD7C 0C             	INC	C
CD7D 3E 47          	LD	A,047H
CD7F ED 79          	OUT	(C),A
CD81 3E 0D          	LD	A,13		;Baudrate 9600-13
CD83 ED 79          	OUT	(C),A
CD85                
CD85 79             	LD	A,C
CD86 D6 10          	SUB	010H
CD88 4F             	LD	C,A
CD89                ;	LD	(SIOAD+1),BC
CD89                ;	LD	(SIOAD0+1),BC
CD89                ;	LD	(SIOAD1+1),BC
CD89                
CD89 21 CA D0       	LD	HL,SIODATA
CD8C                SINIT1:
CD8C 7E             	LD	A,(HL)
CD8D 23             	INC	HL
CD8E FE FF          	CP	0FFH
CD90 28 04          	JR	Z,SINIT2
CD92 ED 79          	OUT	(C),A
CD94 18 F6          	JR	SINIT1
CD96                SINIT2:
CD96 3E E4          	LD	A,0E4H
CD98 CD F6 DE       	CALL	COMOUT
CD9B 3E C8          	LD	A,INTVEC-CPM_BOOT
CD9D CD D0 DE       	CALL	OT49SB
CDA0                ;
CDA0 01 C4 1F       	LD	BC,01FC4H
CDA3 3E 0C          	LD	A,00CH
CDA5 ED 79          	OUT	(C),A
CDA7                
CDA7 0E C0          	LD	C,0C0H
CDA9 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDAB                
CDAB 0C             	INC	C
CDAC 3E 28          	LD	A,40
CDAE ED 79          	OUT	(C),A
CDB0                
CDB0 0C             	INC	C
CDB1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDB3                
CDB3 0C             	INC	C
CDB4 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDB6                
CDB6 0E C5          	LD	C,0C5H
CDB8 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDBA                
CDBA                TEXT:
CDBA 0E B0          	LD	C,0B0H
CDBC 3E 80          	LD	A,080H
CDBE ED 79          	OUT	(C),A
CDC0 16 07          	LD	D,7
CDC2 0E B9          	LD	C,0B9H
CDC4 21 C3 D0       	LD	HL,TEXTDT
CDC7                TEXT1:
CDC7 04             	INC	B
CDC8 ED A3          	OUTI
CDCA 0C             	INC	C
CDCB 15             	DEC	D
CDCC 20 F9          	JR	NZ,TEXT1
CDCE 01 B0 1F       	LD	BC,01FB0H
CDD1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDD3                
CDD3 0E C4          	LD	C,0C4H
CDD5 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDD7                
CDD7 01 01 1A       	LD	BC,01A01H
CDDA ED 78          	IN	A,(C)
CDDC E6 08          	AND	8
CDDE 28 09          	JR	Z,PRN
CDE0 0E 03          	LD	C,003H
CDE2 3E 0F          	LD	A,00FH
CDE4 ED 79          	OUT	(C),A
CDE6 01 04 0A       	LD	BC,00A04H
CDE9                PRN:
CDE9 21 00 00       	LD	HL,0
CDEC 06 5C          	LD	B,05CH
CDEE 3E             	DB	03EH	;LD A,??
CDEF FF             	RST	38H
CDF0 CD 50 E1       	CALL	FILL_MEMORY
CDF3 06 A4          	LD	B,0A4H
CDF5 AF             	XOR	A
CDF6 CD 50 E1       	CALL	FILL_MEMORY
CDF9                
CDF9 3E C3          	LD	A,0C3H		;JP
CDFB 21 03 F0       	LD	HL,CPM_WBOOT
CDFE 32 00 00       	LD	(00000H),A
CE01 22 01 00       	LD	(00001H),HL	;IPL
CE04                
CE04 21 00 1D       	LD	HL,MACW	;3 bit7  DPB Compatible LA(1)
CE07 22 03 00       	LD	(00003H),HL	;  bit6-0 Machine X1(0)
CE0A                ;				;4 LSX-Dodgers(01DH)
CE0A 21 06 D3       	LD	HL,BDOS
CE0D 32 05 00       	LD	(00005H),A
CE10 22 06 00       	LD	(00006H),HL	;BDOS
CE13                
CE13 21 27 DB       	LD	HL,BIOS
CE16 22 19 00       	LD	(00019H),HL	;BIOS-ROM
CE19                
CE19 21 D9 FF       	LD	HL,TRAP38	;TRAP38
CE1C 32 38 00       	LD	(00038H),A
CE1F 22 39 00       	LD	(00039H),HL	;RST 038H
CE22                
CE22 3E F0          	LD	A,CPM_BOOT/256
CE24 32 0B 00       	LD	(0000BH),A
CE27                
CE27 3E             	DB	03EH	;LD A,??
CE28 E9             	JP	(HL)
CE29 32 0F 00       	LD	(0000FH),A
CE2C                
CE2C 3E E6          	LD	A,0E6H
CE2E CD F6 DE       	CALL	COMOUT
CE31 CD DB DE       	CALL	IN49SB
CE34 F5             	PUSH	AF
CE35 CD DB DE       	CALL	IN49SB
CE38 F1             	POP	AF
CE39 F5             	PUSH	AF
CE3A E6 12          	AND	012H
CE3C 20 05          	JR	NZ,KEYR
CE3E 3E 01          	LD	A,1
CE40 32 96 CF       	LD	(KEYREP+1),A
CE43                KEYR:
CE43 F1             	POP	AF
CE44 E6 03          	AND	3
CE46 28 0E          	JR	Z,NON
CE48                
CE48 01 D0 3F       	LD	BC,03FD0H
CE4B ED 49          	OUT	(C),C
CE4D 3E 37          	LD	A,037H
CE4F D3 D0          	OUT	(0D0H),A
CE51 ED 78          	IN	A,(C)
CE53 B9             	CP	C
CE54 28 4B          	JR	Z,TURBO
CE56                NON:
CE56 21 FD D0       	LD	HL,AT_SCR1
CE59 11 80 DF       	LD	DE,SCR1
CE5C 01 94 00       	LD	BC,SCRNE-SCR1	;転送先のサイズ確認用
CE5F 01 85 00       	LD	BC,AT_SCRE-AT_SCR1
CE62 ED B0          	LDIR
CE64                
CE64 21 82 D1       	LD	HL,AT_DWT
CE67 11 D9 EE       	LD	DE,WTTRK
CE6A 01 8F 00       	LD	BC,DMAE-WTTRK	;転送先のサイズ確認用
CE6D 01 8E 00       	LD	BC,AT_CPUE-AT_DWT
CE70 ED B0          	LDIR
CE72                
CE72 21 FB DF       	LD	HL,AT_WTTRK+AT_RS
CE75 22 E9 F0       	LD	(_WTTRK+1),HL
CE78 21 22 EF       	LD	HL,AT_DRD+AT_R
CE7B 22 EC F0       	LD	(_FDRD+1),HL
CE7E 21 D9 EE       	LD	HL,AT_DWT+AT_R
CE81 22 EF F0       	LD	(_FDWT+1),HL
CE84 21 02 E0       	LD	HL,AT_SCRN+AT_RS
CE87 22 D1 F0       	LD	(_SCRN+1),HL
CE8A                
CE8A 3E 27          	LD	A,027H			;ノンターボはMFM切り替えを行わない
CE8C 32 12 F2       	LD	(_DEVICE+012H),A	;Aドライブ
CE8F 32 32 F2       	LD	(_DEVICE+012H+32),A	;Bドライブ
CE92 32 52 F2       	LD	(_DEVICE+012H+32*2),A	;Cドライブ
CE95 32 72 F2       	LD	(_DEVICE+012H+32*3),A	;Dドライブ
CE98                
CE98 21 00 00       	LD	HL,0
CE9B 22 21 DF       	LD	(X1PAT),HL
CE9E C3 2A CF       	JP	NOBANK
CEA1                
CEA1                TURBO:
CEA1 F3             	DI			;Check BIOS
CEA2 06 1D          	LD	B,01DH
CEA4 ED 79          	OUT	(C),A		;BIOS ON
CEA6 3A 51 2F       	LD	A,(02F51H)
CEA9 04             	INC	B		;B=01EH
CEAA ED 79          	OUT	(C),A		;BIOS OFF
CEAC FB             	EI
CEAD FE C9          	CP	0C9H
CEAF 28 02          	JR	Z,BIOSOK
CEB1 18 05          	JR	NOBIOS
CEB3                BIOSOK:
CEB3 3E C3          	LD	A,0C3H		;JP
CEB5 32 18 00       	LD	(00018H),A
CEB8                NOBIOS:
CEB8 3E 1F          	LD	A,01FH		;スタートポート
CEBA DB F0          	IN	A,(0F0H)
CEBC 0F             	RRCA
CEBD 38 0B          	JR	C,CRT1
CEBF 21 B3 D0       	LD	HL,_C8025H
CEC2 11 B0 F0       	LD	DE,CRTCD
CEC5 01 10 00       	LD	BC,16
CEC8 ED B0          	LDIR
CECA                CRT1:
CECA 3E 1F          	LD	A,01FH		;スタートポート
CECC DB F0          	IN	A,(0F0H)
CECE CB 57          	BIT	2,A
CED0 28 18          	JR	Z,BANK
CED2                
CED2 AF             	XOR	A
CED3                TZ1:				;前面スイッチが2HDの場合はMFMモードを2HDにしておく
CED3 F5             	PUSH	AF
CED4 CD DC F0       	CALL	_GETDPB
CED7 DD 7E 12       	LD	A,(IX+DPB_DEVICE)
CEDA E6 8F          	AND	08FH
CEDC FE 87          	CP	087H		;フロッピーでMEM切り替えがON
CEDE 20 04          	JR	NZ,TZ2
CEE0 DD CB 0A 86    	RES	0,(IX+DPB_FDMODE)
CEE4                TZ2:
CEE4 F1             	POP	AF
CEE5 3C             	INC	A
CEE6 FE 08          	CP	8
CEE8 38 E9          	JR	C,TZ1
CEEA                
CEEA                BANK:
CEEA 01 00 0B       	LD	BC,00B00H
CEED 21 00 7F       	LD	HL,07F00H
CEF0 F3             	DI
CEF1 ED 69          	OUT	(C),L
CEF3 3A 00 00       	LD	A,(0)
CEF6 FE EB          	CP	0EBH
CEF8 20 05          	JR	NZ,BANK1
CEFA 3E 2B          	LD	A,02BH
CEFC 32 B2 F2       	LD	(BANKDV),A
CEFF                BANK1:
CEFF ED 69          	OUT	(C),L
CF01 5E             	LD	E,(HL)
CF02 7B             	LD	A,E
CF03 C6 A5          	ADD	A,0A5H
CF05 77             	LD	(HL),A
CF06 BE             	CP	(HL)
CF07 73             	LD	(HL),E
CF08 20 05          	JR	NZ,BANK2
CF0A 2C             	INC	L
CF0B CB 65          	BIT	4,L
CF0D 28 F0          	JR	Z,BANK1
CF0F                BANK2:
CF0F 3E 10          	LD	A,010H
CF11 ED 79          	OUT	(C),A
CF13 7D             	LD	A,L
CF14 B7             	OR	A
CF15 28 13          	JR	Z,NOBANK
CF17 26 00          	LD	H,0
CF19 29             	ADD	HL,HL	;*2
CF1A 29             	ADD	HL,HL	;*4
CF1B 29             	ADD	HL,HL	;*8
CF1C 29             	ADD	HL,HL	;*16
CF1D 29             	ADD	HL,HL	;*32
CF1E 2B             	DEC	HL	;-1
CF1F 2B             	DEC	HL	;-2
CF20 2B             	DEC	HL	;-3
CF21 22 A8 F2       	LD	(BANKCL),HL
CF24 CD 69 D0       	CALL	CALC_FATLN
CF27 32 A0 F2       	LD	(BANKFL),A
CF2A                NOBANK:
CF2A                EMM:
CF2A DD 21 80 F2    	LD	IX,EMMFL
CF2E CD 14 D0       	CALL	EADR0
CF31 ED 78          	IN	A,(C)
CF33 F5             	PUSH	AF
CF34                
CF34 11 00 00       	LD	DE,0
CF37                ECHECK1:
CF37 13             	INC	DE
CF38 CD 1D D0       	CALL	EADRX
CF3B ED 60          	IN	H,(C)
CF3D CD 1D D0       	CALL	EADRX
CF40 7C             	LD	A,H
CF41 C6 E5          	ADD	A,0E5H
CF43 ED 79          	OUT	(C),A
CF45 3C             	INC	A
CF46 CD 14 D0       	CALL	EADR0
CF49 ED 79          	OUT	(C),A
CF4B 3D             	DEC	A
CF4C CD 1D D0       	CALL	EADRX
CF4F ED 68          	IN	L,(C)
CF51 CD 1D D0       	CALL	EADRX
CF54 ED 61          	OUT	(C),H
CF56 BD             	CP	L
CF57 20 04          	JR	NZ,ECHECK2
CF59 CB 5A          	BIT	3,D
CF5B 28 DA          	JR	Z,ECHECK1
CF5D                ECHECK2:
CF5D CD 14 D0       	CALL	EADR0
CF60 F1             	POP	AF
CF61 ED 79          	OUT	(C),A
CF63 FE EB          	CP	0EBH
CF65 28 17          	JR	Z,EMM_BPB
CF67 DD 36 0D 02    	LD	(IX+DPB_MAXSEC),2	;BPBが512バイト目から始まる場合を調べる
CF6B CD 14 D0       	CALL	EADR0
CF6E ED 78          	IN	A,(C)
CF70 DD BE 06       	CP	(IX+DPB_FATID)
CF73 28 0D          	JR	Z,EMM_NOBPB
CF75 DD 36 12 26    	LD	(IX+DPB_DEVICE),026H	;BPPを使う
CF79 21 F5 FF       	LD	HL,0-11
CF7C 18 0B          	JR	EMM_BPB1
CF7E                EMM_BPB:
CF7E DD 36 12 26    	LD	(IX+DPB_DEVICE),026H	;BPPを使う
CF82                EMM_NOBPB:
CF82 DD 36 0D 00    	LD	(IX+DPB_MAXSEC),0
CF86 21 F7 FF       	LD	HL,0-9
CF89                EMM_BPB1:
CF89 19             	ADD	HL,DE
CF8A 30 09          	JR	NC,NOEMM
CF8C 22 88 F2       	LD	(EMMCL),HL
CF8F CD 69 D0       	CALL	CALC_FATLN
CF92 32 80 F2       	LD	(EMMFL),A
CF95                NOEMM:
CF95 3E 00          KEYREP:	LD	A,000H
CF97 B7             	OR	A
CF98 28 07          	JR	Z,KEYR1
CF9A 01 00 00       	LD	BC,0
CF9D ED 43 8C F0    	LD	(_CTC),BC
CFA1                KEYR1:
CFA1 CD 4A D0       	CALL	SETCRTC
CFA4 01 30 F8       	LD	BC,0-80*25
CFA7 2A BA F0       	LD	HL,(_PAGE_MINUS)
CFAA ED 43 BA F0    	LD	(_PAGE_MINUS),BC
CFAE 1E 0C          	LD	E,00CH
CFB0 CD CD F0       	CALL	_PRINT
CFB3 22 BA F0       	LD	(_PAGE_MINUS),HL
CFB6                
CFB6 21 85 D0       	LD	HL,INIMES
CFB9 CD A7 D8       	CALL	MSX
CFBC                
CFBC 3A 87 FF       	LD	A,(0FF87H)
CFBF FE 08          	CP	8
CFC1 30 14          	JR	NC,INIT0
CFC3 5F             	LD	E,A
CFC4 C6 41          	ADD	A,'A'
CFC6 32 82 D0       	LD	(AUTODV),A
CFC9 0E 0E          	LD	C,00EH
CFCB CD 05 00       	CALL	SYSTEM
CFCE 1C             	INC	E
CFCF 0E 1B          	LD	C,01BH
CFD1 CD 05 00       	CALL	SYSTEM
CFD4                
CFD4 3C             	INC	A
CFD5 20 08          	JR	NZ,INIT1
CFD7                INIT0:
CFD7 1E 00          	LD	E,0
CFD9 0E 0E          	LD	C,00EH
CFDB CD 05 00       	CALL	SYSTEM
CFDE AF             	XOR	A
CFDF                INIT1:
CFDF F3             	DI
CFE0 08             	EX	AF,AF'
CFE1 2E FE          	LD	L,0-2		;CALLのスタック分減らす
CFE3 39             	ADD	HL,SP
CFE4 11 00 FF       	LD	DE,0FF00H
CFE7 45             	LD	B,L
CFE8 CD 59 D6       	CALL	ZERO_MEMORY_DE
CFEB 21 CA FF       	LD	HL,EXTBIO
CFEE 36 C9          	LD	(HL),0C9H	;RET
CFF0 23             	INC	HL
CFF1 06 0E          	LD	B,TRAP38-EXTBIO-1
CFF3 3E             	DB	03EH	;LD A,??
CFF4 FF             	RST	38H
CFF5 CD 50 E1       	CALL	FILL_MEMORY
CFF8 21 D6 D0       	LD	HL,AT_TRAP38
CFFB 11 D9 FF       	LD	DE,TRAP38
CFFE 01 27 00       	LD	BC,AT_TRAPE-AT_TRAP38
D001 ED B0          	LDIR
D003 08             	EX	AF,AF'
D004 B7             	OR	A
D005 C8             	RET	Z
D006                
D006 3E E6          	LD	A,0E6H
D008 CD F6 DE       	CALL	COMOUT
D00B CD DB DE       	CALL	IN49SB
D00E CD DB DE       	CALL	IN49SB
D011 FE 1B          	CP	01BH
D013 C9             	RET
D014                
D014                EADR0:
D014 D5             	PUSH	DE
D015 11 00 00       	LD	DE,0
D018 CD 1D D0       	CALL	EADRX
D01B D1             	POP	DE
D01C C9             	RET
D01D                
D01D                EADRX:
D01D F5             	PUSH	AF
D01E CD 48 D8       	CALL	EADR
D021 F1             	POP	AF
D022 C9             	RET
D023                
D023                CHKCTC:
D023 C5             	PUSH	BC
D024 11 03 47       	LD	DE,04703H
D027                INICTC1:
D027 0C             	INC	C
D028 ED 51          	OUT	(C),D
D02A ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
D02C 1D             	DEC	E
D02D 20 F8          	JR	NZ,INICTC1
D02F C1             	POP	BC
D030                
D030 11 FA 07       	LD	DE,007FAH
D033 ED 51          	OUT	(C),D
D035 ED 59          	OUT	(C),E
D037 ED 78          	IN	A,(C)
D039 BB             	CP	E
D03A C0             	RET	NZ
D03B ED 51          	OUT	(C),D
D03D ED 51          	OUT	(C),D
D03F ED 78          	IN	A,(C)
D041 BA             	CP	D
D042 C0             	RET	NZ
D043 0C             	INC	C
D044 0C             	INC	C
D045 ED 43 8C F0    	LD	(_CTC),BC
D049 C9             	RET
D04A                
D04A                SETCRTC:
D04A 21 B0 F0       	LD	HL,CRTCD
D04D AF             	XOR	A
D04E                SETCRT1:
D04E 01 00 18       	LD	BC,01800H
D051 ED 79          	OUT	(C),A
D053 0C             	INC	C
D054 04             	INC	B
D055 ED A3          	OUTI
D057 3C             	INC	A
D058 FE 0C          	CP	12
D05A 20 F2          	JR	NZ,SETCRT1
D05C 23             	INC	HL
D05D 23             	INC	HL
D05E 01 03 1B       	LD	BC,01A03H+00100H
D061 ED A3          	OUTI
D063 01 D0 20       	LD	BC,01FD0H+00100H
D066 ED A3          	OUTI
D068 C9             	RET
D069                
D069                CALC_FATLN:	;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
D069 5D             	LD	E,L
D06A 54             	LD	D,H
D06B 29             	ADD	HL,HL	;*2
D06C 19             	ADD	HL,DE	;*3
D06D CB 3C          	SRL	H	;/2
D06F CB 1D          	RR	L	;1クラスタ辺り1.5バイト必要
D071 11 FF 01       	LD	DE,511	;切り上げる
D074 19             	ADD	HL,DE
D075 7C             	LD	A,H
D076 CB 3F          	SRL	A
D078 C9             	RET
D079                
D079 41 55 54 4F    AUTOD:	DB	"AUTOEXEC "
D07D 45 58 45 43
D081 20
D082 41 3A 00       AUTODV:	DB	"A:",0
D085                
D085 4C 53 58 2D    INIMES:	DB	"LSX-Dodgers for X1/turbo version "
D089 44 6F 64 67
D08D 65 72 73 20
D091 66 6F 72 20
D095 58 31 2F 74
D099 75 72 62 6F
D09D 20 76 65 72
D0A1 73 69 6F 6E
D0A5 20
D0A6 31 2E          	DB	030H + VER_1, '.'
D0A8 36 30          	DB	030H + VER_2 ,030H + VER_3
D0AA 42             	DB	"B"
D0AB 20 47 61 6B    	DB	' Gaku',0DH,0AH
D0AF 75 0D 0A
D0B2 00             	DB	0
D0B3                
D0B3                _C8025H:
D0B3 6B 50 59 88    	DB	06BH,050H,059H,088H,01BH,000H,019H,01AH
D0B7 1B 00 19 1A
D0BB 00 0F          	DB	000H,00FH
D0BD 80 F8 B0 FF    	DW	0-80*LINE,0-80
D0C1 0C 23          	DB	00CH,023H
D0C3                
D0C3 03 0C 0F 30    TEXTDT:	DB	003H,00CH,00FH,030H,033H,03CH,03FH
D0C7 33 3C 3F
D0CA                
D0CA                SIODATA:
D0CA 18             	DB	018H
D0CB 01 00          	DB	1,0
D0CD 02 00          	DB	2,0
D0CF 03 C1          	DB	3,0C1H
D0D1 04 44          	DB	4,044H
D0D3 05 E8          	DB	5,0E8H
D0D5 FF             	DB	0FFH
D0D6                
D0D6                AT_TRAP38:
D0D6 21 00 00       	LD	HL,0
D0D9 E3             	EX	(SP),HL
D0DA 3E 24          	LD	A,'$'
D0DC CD A5 DB       	CALL	MSG_A
D0DF 2B             	DEC	HL
D0E0 7C             	LD	A,H
D0E1 CD E8 FF       	CALL	PRHX+AT_RT
D0E4 7D             	LD	A,L
D0E5                PRHX:
D0E5 F5             	PUSH	AF
D0E6 07             	RLCA
D0E7 07             	RLCA
D0E8 07             	RLCA
D0E9 07             	RLCA
D0EA CD F1 FF       	CALL	PRHX2+AT_RT
D0ED F1             	POP	AF
D0EE                PRHX2:
D0EE E6 0F          	AND	00FH
D0F0 FE 0A          	CP	10
D0F2 3F             	CCF
D0F3 CE 30          	ADC	A,'0'
D0F5 27             	DAA
D0F6 C3 A5 DB       	JP	MSG_A
D0F9                	DS	4
D0FD                AT_TRAPE:
D0FD                	INCLUDE	"X1CPU.ASM"
D0FD                
D0FD                ;	LSX-Dodgers CPU
D0FD                ;	X1/turbo/Z
D0FD                
D0FD                ;	ノンターボ用パッチ
D0FD                ;	DMAを使って転送している部分をCPUに差し替える
D0FD                
D0FD                AT_SCR1:
D0FD D9             	EXX
D0FE C5             	PUSH	BC
D0FF ED 4B B1 F0    	LD	BC,(_WIDTH)
D103 06 20          	LD	B,020H
D105 D9             	EXX
D106 C5             	PUSH	BC
D107 01 00 20       	LD	BC,02000H
D10A                
D10A 67             	LD	H,A
D10B B7             	OR	A
D10C                AT_SCRUP1:
D10C 28 15          	JR	Z,AT_SCRCL
D10E C5             	PUSH	BC
D10F CB E0          	SET	4,B
D111 D9             	EXX
D112 C5             	PUSH	BC
D113 CB E0          	SET	4,B
D115 D9             	EXX
D116 CD B1 DF       	CALL	AT_UPSUB+AT_RS
D119 D9             	EXX
D11A C1             	POP	BC
D11B D9             	EXX
D11C C1             	POP	BC
D11D CD B1 DF       	CALL	AT_UPSUB+AT_RS
D120 25             	DEC	H
D121 18 E9          	JR	AT_SCRUP1
D123                
D123                AT_SCRCL:
D123 2A B1 F0       	LD	HL,(_WIDTH)
D126 CD 49 DE       	CALL	LINECL
D129 C1             	POP	BC
D12A D9             	EXX
D12B C1             	POP	BC
D12C D9             	EXX
D12D C9             	RET
D12E                
D12E                AT_UPSUB:
D12E 3A B1 F0       	LD	A,(_WIDTH)
D131 6F             	LD	L,A
D132                AT_UPSUB1:
D132 D9             	EXX
D133 ED 78          	IN	A,(C)
D135 03             	INC	BC
D136 D9             	EXX
D137 ED 79          	OUT	(C),A
D139 03             	INC	BC
D13A 2D             	DEC	L
D13B 20 F5          	JR	NZ,AT_UPSUB1
D13D C9             	RET
D13E                
D13E                ;	FLOPPY DISK DRIVER(CPU)
D13E                
D13E                DISKC:
D13E 1B             	DEC	DE
D13F CB 5F          	BIT	3,A
D141 C4 D2 EE       	CALL	NZ,RNF
D144                DISKD:
D144 E5             	PUSH	HL
D145 21 D8 EE       	LD	HL,RETRY
D148 35             	DEC	(HL)
D149 E1             	POP	HL
D14A 20 0C          	JR	NZ,AT_ERR		;Retry
D14C B7             	OR	A
D14D 28 09          	JR	Z,AT_ERR		;Error
D14F                
D14F                AT_DELP:
D14F CD D2 EE       	CALL	RNF
D152 CD AE EE       	CALL	FDMOFF
D155 3E FF          	LD	A,0FFH
D157                AT_ERRZ:
D157 BF             	CP	A
D158                AT_ERR:
D158 3E FF          	LD	A,0FFH
D15A C9             	RET
D15B                ERRW:
D15B 3E FF          	LD	A,0FFH
D15D BF             	CP	A
D15E 37             	SCF
D15F C3 AE EE       	JP	FDMOFF
D162                
D162                ERRDW:
D162 D1             	POP	DE
D163 CD D2 DF       	CALL	AT_DELP+AT_RS
D166 C2 E7 EE       	JP	NZ,DWT0+AT_R
D169 B7             	OR	A
D16A 20 EF          	JR	NZ,ERRW
D16C C9             	RET
D16D                
D16D                ERRDR:
D16D D1             	POP	DE
D16E CD D2 DF       	CALL	AT_DELP+AT_RS
D171 C2 30 EF       	JP	NZ,DRD0+AT_R
D174 B7             	OR	A
D175 20 E4          	JR	NZ,ERRW
D177 C9             	RET
D178                
D178                AT_WTTRK:
D178 06 01          	LD	B,1
D17A 3E F4          	LD	A,0F4H
D17C C3 DB EE       	JP	AT_WTTRK1+AT_R
D17F                
D17F                AT_SCRN:
D17F ED 78          	IN	A,(C)
D181 C9             	RET
D182                AT_SCRE:
D182                
D182                AT_DWT:
D182 3E A0          	LD	A,0A0H
D184                AT_WTTRK1:
D184 32 67 EE       	LD	(FDCPAT+1),A
D187                DWTBL:
D187 78             	LD	A,B
D188 32 1E EF       	LD	(AT_WTB+1+AT_R),A
D18B 3E 02          	LD	A,2		;Retry count
D18D 32 D8 EE       	LD	(RETRY),A
D190                
D190                DWT0:
D190 D5             	PUSH	DE
D191 E5             	PUSH	HL
D192 CD 08 EE       	CALL	SEEK		;Write disk
D195 E1             	POP	HL
D196 DA E5 DF       	JP	C,ERRDW+AT_RS
D199 F3             	DI
D19A 3A 67 EE       	LD	A,(FDCPAT+1)
D19D CD BA EE       	CALL	SECSET
D1A0 0E FB          	LD	C,0FBH
D1A2                
D1A2                DWT1:
D1A2 56             	LD	D,(HL)
D1A3                DWT2:
D1A3 78             	LD	A,B
D1A4 DB F8          	IN	A,(0F8H)
D1A6 0F             	RRCA
D1A7 30 08          	JR	NC,DWT4
D1A9 0F             	RRCA
D1AA 30 F7          	JR	NC,DWT2
D1AC                DWT3:
D1AC ED 51          	OUT	(C),D
D1AE 23             	INC	HL
D1AF 18 F1          	JR	DWT1
D1B1                
D1B1                DWT4:
D1B1 3D             	DEC	A
D1B2 28 F8          	JR	Z,DWT3
D1B4 3C             	INC	A
D1B5 FB             	EI
D1B6 D1             	POP	DE
D1B7 13             	INC	DE
D1B8 CD AE EE       	CALL	FDMOFF
D1BB 28 09          	JR	Z,DISKOK_WT
D1BD CD C1 DF       	CALL	DISKC+AT_RS
D1C0 20 CE          	JR	NZ,DWT0
D1C2 B7             	OR	A
D1C3 C2 DE DF       	JP	NZ,ERRW+AT_RS
D1C6                
D1C6                DISKOK_WT:
D1C6 06 01          AT_WTB:	LD	B,1
D1C8 10 BD          	DJNZ	DWTBL
D1CA C9             	RET
D1CB                
D1CB                AT_DRD:
D1CB 3E 80          	LD	A,080H
D1CD 32 67 EE       	LD	(FDCPAT+1),A
D1D0                DRDBL:
D1D0 78             	LD	A,B
D1D1 32 63 EF       	LD	(AT_RDB+1+AT_R),A
D1D4 3E 02          	LD	A,2		;Retry count
D1D6 32 D8 EE       	LD	(RETRY),A
D1D9                DRD0:
D1D9 D5             	PUSH	DE
D1DA E5             	PUSH	HL
D1DB CD 08 EE       	CALL	SEEK		;Read disk
D1DE E1             	POP	HL
D1DF DA F0 DF       	JP	C,ERRDR+AT_RS
D1E2 F3             	DI
D1E3 3A 67 EE       	LD	A,(FDCPAT+1)
D1E6 CD BA EE       	CALL	SECSET
D1E9 0E FB          	LD	C,0FBH
D1EB                DRD1:
D1EB 78             	LD	A,B
D1EC DB F8          	IN	A,(0F8H)
D1EE 0F             	RRCA
D1EF 30 08          	JR	NC,DRD3
D1F1 0F             	RRCA
D1F2 30 F7          	JR	NC,DRD1
D1F4 ED A2          	INI
D1F6 04             	INC	B
D1F7 18 F2          	JR	DRD1
D1F9                
D1F9                DRD3:
D1F9 B7             	OR	A
D1FA FB             	EI
D1FB D1             	POP	DE
D1FC 13             	INC	DE
D1FD CD AE EE       	CALL	FDMOFF
D200 28 09          	JR	Z,DISKOK_RD
D202 CD C1 DF       	CALL	DISKC+AT_RS
D205 20 D2          	JR	NZ,DRD0
D207 B7             	OR	A
D208 C2 DE DF       	JP	NZ,ERRW+AT_RS
D20B                
D20B                DISKOK_RD:
D20B 06 01          AT_RDB:	LD	B,1
D20D 10 C1          	DJNZ	DRDBL
D20F C9             	RET
D210                
D210                AT_CPUE:
D210                
D210 00 00 2F 03    AT_RT	EQU	TRAP38-AT_TRAP38
D210                
D210                INITE:
D210                	DS	BDOS-INITE
D306 C3 66 D8       	JP	BDOS0
D309                	INCLUDE	"X1CCP.ASM"
D309                
D309                ;	LSX-Dodgers CCP
D309                ;	X1/turbo/Z
D309                
D309                WBOOT1:
D309 F3             	DI
D30A ED 7B 06 00    	LD	SP,(SYSTEM+1)
D30E                
D30E 3E F0          	LD	A,INTVEC/256
D310 ED 47          	LD	I,A
D312                
D312 3E E4          	LD	A,0E4H
D314 CD F6 DE       	CALL	COMOUT
D317 3E C8          	LD	A,INTVEC-CPM_BOOT
D319 CD D0 DE       	CALL	OT49SB
D31C                
D31C 21 B0 F0       	LD	HL,CRTCD
D31F AF             	XOR	A
D320                SETCRT2:
D320 01 00 18       	LD	BC,01800H
D323 ED 79          	OUT	(C),A
D325 0C             	INC	C
D326 56             	LD	D,(HL)
D327 FE 0D          	CP	13
D329 38 02          	JR	C,SETCRT3
D32B 16 00          	LD	D,0
D32D                SETCRT3:
D32D ED 51          	OUT	(C),D
D32F 23             	INC	HL
D330 3C             	INC	A
D331 FE 0E          	CP	14
D333 20 EB          	JR	NZ,SETCRT2
D335                
D335 01 03 1B       	LD	BC,01A03H+00100H
D338 ED A3          	OUTI
D33A 01 D0 20       	LD	BC,01FD0H+00100H
D33D ED A3          	OUTI
D33F 21 92 F0       	LD	HL,_KEYD
D342 7E             	LD	A,(HL)
D343 36 00          	LD	(HL),0
D345 CD 92 DB       	CALL	KEYBC_IFBREAK
D348 3E 04          	LD	A,4
D34A CD A5 DB       	CALL	MSG_A
D34D                	INCLUDE	"LDCCP.ASM"
D34D                
D34D                ;	LSX-Dodgers CCP
D34D                
D34D                COMMAND:
D34D 3A C9 EF       	LD	A,(FCB_BAT)
D350 B7             	OR	A
D351 C2 93 D4       	JP	NZ,C_BAT1
D354 CD 07 D4       	CALL	SETDTA1
D357 3A 87 F0       	LD	A,(_DVSW)
D35A C6 41          	ADD	A,'A'
D35C CD A5 DB       	CALL	MSG_A
D35F 3E 3E          	LD	A,'>'
D361 CD A5 DB       	CALL	MSG_A
D364 3E 50          	LD	A,80
D366 12             	LD	(DE),A
D367 CD 26 DC       	CALL	_SYS0A		;(BDOS)文字列入力
D36A CD 88 D5       	CALL	LTNL
D36D                COMMAND2:
D36D 11 82 00       	LD	DE,DTA1+2
D370 CD FD F0       	CALL	_COMANL
D373 30 D8          	JR	NC,COMMAND
D375 11 79 F0       	LD	DE,COMERM
D378 CD 98 D8       	CALL	_SYS09		;(BDOS)文字列出力
D37B C7             	RST	0
D37C                
D37C                COMANL:
D37C CD A4 E0       	CALL	FILE
D37F 3A 19 F0       	LD	A,(FNAME+4)
D382 FE 20          	CP	020H
D384 20 1C          	JR	NZ,COMB2
D386 D5             	PUSH	DE
D387 11 15 F0       	LD	DE,FNAME
D38A 1A             	LD	A,(DE)
D38B FE 20          	CP	020H
D38D 28 44          	JR	Z,SDVSW
D38F 1B             	DEC	DE
D390 1A             	LD	A,(DE)
D391 C6 FF          	ADD	A,0FFH
D393 38 09          	JR	C,COMB
D395 13             	INC	DE
D396                
D396 21 45 D7       	LD	HL,COMTB
D399 06 08          	LD	B,COMS
D39B CD 33 E3       	CALL	CPNAME
D39E                COMB:
D39E D1             	POP	DE
D39F D2 0F 00       	JP	NC,JP_HL
D3A2                COMB2:
D3A2 EB             	EX	DE,HL
D3A3 22 70 D4       	LD	(COMSWC),HL
D3A6 F5             	PUSH	AF
D3A7 CD 28 D4       	CALL	CEXE4
D3AA F1             	POP	AF
D3AB 21 15 F0       	LD	HL,FNAME
D3AE 11 6D 00       	LD	DE,FCB2+1	;COMMAND NAME
D3B1 01 0B 00       	LD	BC,11
D3B4 ED B0          	LDIR
D3B6 11 68 EF       	LD	DE,PATHD
D3B9                CEX1:
D3B9 1A             	LD	A,(DE)
D3BA FE 20          	CP	020H
D3BC D8             	RET	C
D3BD CD 99 E0       	CALL	FILEC
D3C0 D5             	PUSH	DE
D3C1 21 6D 00       	LD	HL,FCB2+1	;COMMAND NAME
D3C4 11 15 F0       	LD	DE,FNAME
D3C7 01 0B 00       	LD	BC,11
D3CA ED B0          	LDIR
D3CC CD 28 D4       	CALL	CEXE4
D3CF D1             	POP	DE
D3D0 13             	INC	DE
D3D1 18 E6          	JR	CEX1
D3D3                
D3D3                SDVSW:
D3D3 F1             	POP	AF
D3D4 3A 14 F0       	LD	A,(FDRV)
D3D7 3D             	DEC	A
D3D8 5F             	LD	E,A
D3D9 0E 0E          	LD	C,00EH		;(BDOS)カレントドライブの設定
D3DB 18 31          	JR	SYSTEM0
D3DD                
D3DD                OPEN1:
D3DD 21 14 F0       	LD	HL,FDRV
D3E0                OPEN:
D3E0 0E 11          	LD	C,011H		;(BDOS)ファイルの検索
D3E2                OPEN3:
D3E2 D5             	PUSH	DE
D3E3 11 A4 EF       	LD	DE,DTA_CCP
D3E6 CD 04 D4       	CALL	SETDTA
D3E9 EB             	EX	DE,HL
D3EA CD 0E D4       	CALL	SYSTEM0
D3ED D1             	POP	DE
D3EE C9             	RET
D3EF                
D3EF                OPEN2:
D3EF 0E 12          	LD	C,012H
D3F1 18 EF          	JR	OPEN3
D3F3                
D3F3                DEFCB:				;Z=Ok NZ=Error
D3F3 11 A4 EF       	LD	DE,DTA_CCP
D3F6 CD 0C D4       	CALL	SYSC0F
D3F9                
D3F9 11 C5 EF       	LD	DE,DTA_CCP+33	;(FCB)ランダムレコード
D3FC 06 04          	LD	B,4
D3FE CD 59 D6       	CALL	ZERO_MEMORY_DE
D401                SETDTA100:
D401 11 00 01       	LD	DE,00100H
D404                SETDTA:
D404 C3 6B DA       	JP	_SYS1A		;(BDOS)DTAの設定
D407                
D407                SETDTA1:
D407 11 80 00       	LD	DE,DTA1
D40A 18 F8          	JR	SETDTA
D40C                
D40C                SYSC0F:
D40C 0E 0F          	LD	C,00FH		;(BDOS)ファイルのオープン
D40E                SYSTEM0:
D40E CD 05 00       	CALL	SYSTEM
D411 B7             	OR	A
D412 C9             	RET
D413                
D413                C_CD:
D413 0E 5A          	LD	C,05AH
D415 18 F7          	JR	SYSTEM0
D417                
D417                S27BUF:
D417 21 00 FE       	LD	HL,-00200H	;スクラッチエリア(0100H)+スタック予備(0100H)
D41A 39             	ADD	HL,SP
D41B 2E 00          	LD	L,0
D41D 7C             	LD	A,H
D41E E6 F8          	AND	0F8H
D420 67             	LD	H,A
D421                S27DTA:
D421 11 A4 EF       	LD	DE,DTA_CCP
D424                S27:
D424 0E 27          	LD	C,027H		;(BDOS)ランダムブロック読み込み
D426 18 E6          	JR	SYSTEM0
D428                
D428                CEXE4:
D428 21 1D F0       	LD	HL,FNAME+8
D42B 7E             	LD	A,(HL)
D42C FE 20          	CP	020H
D42E 20 07          	JR	NZ,CEXE7
D430 3E 3F          	LD	A,'?'
D432 77             	LD	(HL),A
D433 23             	INC	HL
D434 77             	LD	(HL),A
D435 23             	INC	HL
D436 77             	LD	(HL),A
D437                CEXE7:
D437 CD DD D3       	CALL	OPEN1
D43A                CEXE5:
D43A C0             	RET	NZ
D43B 2A AE EF       	LD	HL,(DTA_CCP+1+9)
D43E 7C             	LD	A,H
D43F CD BB E3       	CALL	CAP
D442 67             	LD	H,A
D443 7D             	LD	A,L
D444 CD BB E3       	CALL	CAP
D447 6F             	LD	L,A
D448 3A AD EF       	LD	A,(DTA_CCP+1+8)
D44B CD BB E3       	CALL	CAP
D44E D6 42          	SUB	'B'
D450 28 2C          	JR	Z,C_BAT
D452 3D             	DEC	A		;'C'
D453 28 05          	JR	Z,C_EXE
D455                CEXE6:
D455 CD EF D3       	CALL	OPEN2
D458 18 E0          	JR	CEXE5
D45A                
D45A                C_EXE:
D45A 7C             	LD	A,H
D45B FE 4D          	CP	'M'
D45D 20 F6          	JR	NZ,CEXE6
D45F                
D45F CD F3 D3       	CALL	DEFCB
D462 CD 17 D4       	CALL	S27BUF
D465 3D             	DEC	A
D466 37             	SCF
D467 C0             	RET	NZ
D468 7C             	LD	A,H
D469 B5             	OR	L
D46A 37             	SCF
D46B C8             	RET	Z
D46C CD 07 D4       	CALL	SETDTA1
D46F 11 00 00       	LD	DE,0				; self-modifying code
D472 00 00 D4 70    COMSWC	EQU	$-2
D472 ED 7B 06 00    	LD	SP,(SYSTEM+1)
D476 67             	LD	H,A				; A=0 in SETDTA1(_SYS1A)
D477 6F             	LD	L,A
D478 E5             	PUSH	HL				; push $0000 (reboot address)
D479 24             	INC	H
D47A E5             	PUSH	HL				; push $0100 (TPA address)
D47B C3 24 D6       	JP	SETFCB				; and JP $0100
D47E                
D47E                C_BAT:
D47E 11 41 54       	LD	DE,'A'+'T'*256
D481 ED 52          	SBC	HL,DE
D483 20 D0          	JR	NZ,CEXE6
D485                
D485 CD F3 D3       	CALL	DEFCB
D488                
D488 21 A4 EF       	LD	HL,DTA_CCP
D48B 11 C9 EF       	LD	DE,FCB_BAT
D48E 01 25 00       	LD	BC,37
D491 ED B0          	LDIR
D493                C_BAT1:
D493 CD 01 D4       	CALL	SETDTA100
D496 CD CA D4       	CALL	FGETC_BAT
D499 21 81 00       	LD	HL,DTA1+1
D49C 20 25          	JR	NZ,END_BATCH
D49E FE 21          	CP	021H		;スペースや改行など制御文字を飛ばす
D4A0 38 F1          	JR	C,C_BAT1
D4A2 36 20          	LD	(HL),' '
D4A4 23             	INC	HL
D4A5                C_BAT2:
D4A5 77             	LD	(HL),A
D4A6 23             	INC	HL
D4A7 7D             	LD	A,L
D4A8 3C             	INC	A		;L==0FFH
D4A9 28 09          	JR	Z,RUN_BATCH
D4AB CD CA D4       	CALL	FGETC_BAT
D4AE 20 04          	JR	NZ,RUN_BATCH
D4B0 FE 20          	CP	020H
D4B2 30 F1          	JR	NC,C_BAT2
D4B4                RUN_BATCH:
D4B4 7D             	LD	A,L
D4B5 D6 7F          	SUB	DTA1-1
D4B7 32 80 00       	LD	(DTA1),A
D4BA FE 04          	CP	4
D4BC 38 05          	JR	C,END_BATCH
D4BE 36 00          	LD	(HL),0
D4C0 C3 6D D3       	JP	COMMAND2
D4C3                END_BATCH:
D4C3 AF             	XOR	A		;バッチファイルを閉じる
D4C4 32 C9 EF       	LD	(FCB_BAT),A
D4C7 C3 00 F0       	JP	CPM_BOOT
D4CA                
D4CA                FGETC_BAT:
D4CA 11 C9 EF       	LD	DE,FCB_BAT
D4CD                FGETC:				;1文字ずつ読み込む
D4CD E5             	PUSH	HL		;Z:成功
D4CE 21 01 00       	LD	HL,1
D4D1 CD 24 D4       	CALL	S27
D4D4 E1             	POP	HL
D4D5 3A 00 01       	LD	A,(00100H)
D4D8 C9             	RET
D4D9                
D4D9                C_DEL:
D4D9 CD 24 D6       	CALL	SETFCB
D4DC CD BB DB       	CALL	_SYS08		;(BDOS)エコーなしコンソール入力
D4DF                
D4DF 0E 13          	LD	C,013H
D4E1 18 0A          	JR	CDEL1		;(BDOS)ファイルの削除
D4E3                
D4E3                C_REN:
D4E3 CD 24 D6       	CALL	SETFCB
D4E6 3E 10          	LD	A,010H		;ディレクトリも対象にする
D4E8 32 69 00       	LD	(FCB1+13),A	;属性
D4EB 0E 17          	LD	C,017H		;(BDOS)ファイル名の変更
D4ED                CDEL1:
D4ED 11 5C 00       	LD	DE,FCB1
D4F0 CD 05 00       	CALL	SYSTEM
D4F3 C6 FF          	ADD	A,0FFH
D4F5 C9             	RET
D4F6                
D4F6                C_DIR:
D4F6 CD 99 E0       	CALL	FILEC
D4F9 21 15 F0       	LD	HL,FDRV+1
D4FC CD 3A D7       	CALL	CWILD1
D4FF 3E F1          	LD	A,0F1H
D501 32 21 F0       	LD	(FDRV+13),A
D504 CD DD D3       	CALL	OPEN1
D507                CDIR1:
D507 B7             	OR	A
D508 20 08          	JR	NZ,PDSKF
D50A CD 55 D5       	CALL	P_NAME
D50D CD EF D3       	CALL	OPEN2
D510 18 F5          	JR	CDIR1
D512                PDSKF:
D512 3A 14 F0       	LD	A,(FDRV)
D515 5F             	LD	E,A
D516 0E 1B          	LD	C,01BH		;(BDOS)ディスク情報の獲得
D518 CD 05 00       	CALL	SYSTEM
D51B 4F             	LD	C,A		;C←1クラスタ辺りの論理セクタ数
D51C C6 01          	ADD	A,001H
D51E D8             	RET	C		;Aが0FFHだった場合
D51F 3E 06          	LD	A,8-2
D521                PDS1:				;HL=未使用クラスタの総数
D521 3C             	INC	A
D522 CB 19          	RR	C
D524 30 FB          	JR	NC,PDS1
D526                PDS2:				;B←論理セクタのサイズの上位8ビット
D526 3C             	INC	A
D527 CB 18          	RR	B
D529 30 FB          	JR	NC,PDS2
D52B 47             	LD	B,A
D52C                
D52C 11 00 00       	LD	DE,0
D52F                PDS3:
D52F 29             	ADD	HL,HL
D530 EB             	EX	DE,HL
D531 ED 6A          	ADC	HL,HL
D533 EB             	EX	DE,HL
D534 10 F9          	DJNZ	PDS3
D536                PDSKF1:
D536 CD C2 D5       	CALL	PRDEC_DEHL
D539 11 F9 EF       	LD	DE,FREE
D53C CD 98 D8       	CALL	_SYS09		;(BDOS)文字列出力
D53F CD AF D5       	CALL	PUTDRV
D542 3E 5C          	LD	A,05CH		;\
D544 CD A5 DB       	CALL	MSG_A
D547 2A 22 F0       	LD	HL,(FDRV+14)	;ディレクトリのクラスタ番号
D54A AF             	XOR	A
D54B 11 FE FF       	LD	DE,0-2
D54E 19             	ADD	HL,DE
D54F 23             	INC	HL
D550 DC BF D5       	CALL	C,PRDEC_HL
D553 18 33          	JR	LTNL
D555                
D555                P_NAME:
D555 3A A5 EF       	LD	A,(DTA_CCP+1)
D558 FE 2E          	CP	'.'
D55A C8             	RET	Z
D55B                
D55B 3A B0 EF       	LD	A,(DTA_CCP+1+00BH)
D55E F5             	PUSH	AF
D55F CB 67          	BIT	4,A
D561 28 08          	JR	Z,DIR3
D563 11 EE EF       	LD	DE,DIRMES
D566 CD 98 D8       	CALL	_SYS09		;(BDOS)文字列出力
D569 18 0A          	JR	DIR6
D56B                DIR3:
D56B ED 5B C3 EF    	LD	DE,(DTA_CCP+1+01EH)
D56F 2A C1 EF       	LD	HL,(DTA_CCP+1+01CH)
D572 CD C2 D5       	CALL	PRDEC_DEHL
D575                DIR6:
D575 F1             	POP	AF
D576 0F             	RRCA
D577 9F             	SBC	A,A
D578 E6 0A          	AND	'*'-020H
D57A C6 20          	ADD	A,020H
D57C CD A5 DB       	CALL	MSG_A
D57F CD AF D5       	CALL	PUTDRV
D582 21 A5 EF       	LD	HL,DTA_CCP+1
D585 CD 02 D6       	CALL	FPRNT
D588                
D588                LTNL:
D588 1E 03          	LD	E,3
D58A C3 CD F0       	JP	_PRINT
D58D                
D58D                C_PATH:
D58D CD 7B E1       	CALL	SPCUT
D590 21 68 EF       	LD	HL,PATHD
D593 FE 21          	CP	021H
D595 30 0C          	JR	NC,CPATH0
D597                CPATHP:
D597 7E             	LD	A,(HL)
D598 23             	INC	HL
D599 FE 20          	CP	020H
D59B 3F             	CCF
D59C 30 EA          	JR	NC,LTNL
D59E CD A5 DB       	CALL	MSG_A
D5A1 18 F4          	JR	CPATHP
D5A3                CPATH0:
D5A3 FE 3B          	CP	';'
D5A5 20 01          	JR	NZ,CPATH1
D5A7 13             	INC	DE
D5A8                CPATH1:
D5A8 EB             	EX	DE,HL
D5A9 01 3B 00       	LD	BC,PATHX
D5AC ED B0          	LDIR
D5AE C9             	RET
D5AF                
D5AF                PUTDRV:
D5AF 3A 14 F0       	LD	A,(FDRV)
D5B2 CD AE E1       	CALL	GETDRV1
D5B5 C6 41          	ADD	A,'A'
D5B7 CD A5 DB       	CALL	MSG_A
D5BA 3E 3A          	LD	A,':'
D5BC                MSG_AR:
D5BC C3 A5 DB       	JP	MSG_A
D5BF                
D5BF                PRDEC_HL:
D5BF AF             	XOR	A
D5C0 5F             	LD	E,A
D5C1 57             	LD	D,A
D5C2                PRDEC_DEHL:
D5C2 D5             	PUSH	DE
D5C3 11 0F F0       	LD	DE,DECBF
D5C6 06 05          	LD	B,5
D5C8 CD 59 D6       	CALL	ZERO_MEMORY_DE	;A=0
D5CB D1             	POP	DE
D5CC                
D5CC 0E 20          	LD	C,32
D5CE                DEC1:
D5CE 29             	ADD	HL,HL
D5CF EB             	EX	DE,HL
D5D0 ED 6A          	ADC	HL,HL
D5D2 EB             	EX	DE,HL
D5D3 E5             	PUSH	HL
D5D4 21 13 F0       	LD	HL,DECBF+4
D5D7 06 05          	LD	B,5
D5D9                DEC2:
D5D9 7E             	LD	A,(HL)
D5DA 8F             	ADC	A,A
D5DB 27             	DAA
D5DC 77             	LD	(HL),A
D5DD 2B             	DEC	HL
D5DE 10 F9          	DJNZ	DEC2
D5E0 E1             	POP	HL
D5E1 0D             	DEC	C
D5E2 20 EA          	JR	NZ,DEC1
D5E4                
D5E4 21 0F F0       	LD	HL,DECBF
D5E7 3E 20          	LD	A,020H
D5E9 06 04          	LD	B,4
D5EB                DEC3:
D5EB CD F8 D5       	CALL	DEC4
D5EE CD F8 D5       	CALL	DEC4
D5F1 23             	INC	HL
D5F2 10 F7          	DJNZ	DEC3
D5F4                DECX:
D5F4 CD F8 D5       	CALL	DEC4
D5F7 AF             	XOR	A
D5F8                DEC4:
D5F8 ED 6F          	RLD
D5FA FE 20          	CP	020H
D5FC 28 02          	JR	Z,DEC5
D5FE F6 30          	OR	030H
D600                DEC5:
D600 18 BA          	JR	MSG_AR
D602                
D602                FPRNT:
D602 06 08          	LD	B,8	;ファイル名を表示
D604 CD 13 D6       	CALL	P_N1
D607 7E             	LD	A,(HL)
D608 CD C7 E3       	CALL	CAP3
D60B D8             	RET	C	;拡張子が無い
D60C                
D60C 3E 2E          	LD	A,'.'
D60E CD A5 DB       	CALL	MSG_A
D611 06 03          	LD	B,3	;拡張子を表示
D613                P_N1:
D613 7E             	LD	A,(HL)
D614 CD C7 E3       	CALL	CAP3
D617 38 07          	JR	C,P_N2
D619 CD A5 DB       	CALL	MSG_A
D61C 23             	INC	HL
D61D 10 F4          	DJNZ	P_N1
D61F C9             	RET
D620                P_N2:
D620 23             	INC	HL
D621 10 FD          	DJNZ	P_N2
D623 C9             	RET
D624                
D624                SETFCB:
D624 CD 7B E1       	CALL	SPCUT
D627 1A             	LD	A,(DE)
D628 FE 20          	CP	020H
D62A 38 01          	JR	C,SETFCBA
D62C 1B             	DEC	DE
D62D                SETFCBA:
D62D 06 24          	LD	B,36
D62F 21 5C 00       	LD	HL,FCB1
D632 E5             	PUSH	HL
D633 AF             	XOR	A
D634 CD 50 E1       	CALL	FILL_MEMORY
D637 E1             	POP	HL
D638 D5             	PUSH	DE
D639 CD D1 DA       	CALL	_SYS29		;(BDOS)ファイル名の解析
D63C 21 6C 00       	LD	HL,FCB2
D63F CD D1 DA       	CALL	_SYS29		;(BDOS)ファイル名の解析
D642 E1             	POP	HL
D643 01 00 50       	LD	BC,05000H
D646 11 81 00       	LD	DE,00081H
D649                SETFCB1:
D649 7E             	LD	A,(HL)
D64A 23             	INC	HL
D64B FE 20          	CP	020H
D64D 38 05          	JR	C,SETFCB2
D64F 12             	LD	(DE),A
D650 13             	INC	DE
D651 0C             	INC	C
D652 10 F5          	DJNZ	SETFCB1
D654                SETFCB2:
D654 79             	LD	A,C
D655 32 80 00       	LD	(DTA1),A
D658 04             	INC	B
D659                ZERO_MEMORY_DE:
D659 AF             	XOR	A
D65A                FILL_MEMORY_DE:
D65A 12             	LD	(DE),A
D65B 13             	INC	DE
D65C 10 FC          	DJNZ	FILL_MEMORY_DE
D65E C9             	RET
D65F                
D65F                C_COPY:
D65F CD 24 D6       	CALL	SETFCB
D662                
D662 11 61 F0       	LD	DE,ZERO
D665 CD 9C E0       	CALL	FILEC2
D668 21 6C 00       	LD	HL,FCB2
D66B CD D8 DA       	CALL	S29X1
D66E                
D66E 3E 10          	LD	A,010H
D670 32 69 00       	LD	(FCB1+13),A
D673 21 6D 00       	LD	HL,FCB2+1
D676 CD 3A D7       	CALL	CWILD1
D679                COPY0:
D679 CD 37 D7       	CALL	CWILD
D67C 21 5C 00       	LD	HL,FCB1
D67F CD E0 D3       	CALL	OPEN
D682 37             	SCF
D683                COPY1:
D683 C0             	RET	NZ
D684 CD F3 D3       	CALL	DEFCB
D687                
D687 3A B1 EF       	LD	A,(DTA_CCP+13)
D68A CB 67          	BIT	4,A
D68C 28 21          	JR	Z,COPY1A
D68E                
D68E 21 5D 00       	LD	HL,FCB1+1
D691 CD DF E4       	CALL	CHKWILD
D694 38 14          	JR	C,COPY9
D696                
D696 3E 20          	LD	A,020H
D698 32 5D 00       	LD	(FCB1+1),A
D69B 2A BE EF       	LD	HL,(DTA_CCP+26)
D69E 23             	INC	HL
D69F 22 6A 00       	LD	(FCB1+14),HL
D6A2 18 D5          	JR	COPY0
D6A4                
D6A4                COPY8:
D6A4 CD 98 D8       	CALL	_SYS09		;(BDOS)文字列出力
D6A7 CD 88 D5       	CALL	LTNL
D6AA                COPY9:
D6AA CD EF D3       	CALL	OPEN2
D6AD 18 D4          	JR	COPY1
D6AF                
D6AF                COPY1A:
D6AF 21 6C 00       	LD	HL,FCB2
D6B2 11 14 F0       	LD	DE,FDRV
D6B5 01 A6 EF       	LD	BC,DTA_CCP+2
D6B8 ED A0          	LDI
D6BA 3E 0B          	LD	A,11
D6BC                COPY2:
D6BC F5             	PUSH	AF
D6BD 7E             	LD	A,(HL)
D6BE FE 3F          	CP	'?'
D6C0 20 01          	JR	NZ,COPY3
D6C2 0A             	LD	A,(BC)
D6C3                COPY3:
D6C3 12             	LD	(DE),A
D6C4 03             	INC	BC
D6C5 13             	INC	DE
D6C6 23             	INC	HL
D6C7 F1             	POP	AF
D6C8 3D             	DEC	A
D6C9 20 F1          	JR	NZ,COPY2
D6CB 01 05 00       	LD	BC,16-11
D6CE ED B0          	LDIR
D6D0                PUTNAME:
D6D0 21 5D 00       	LD	HL,FCB1+1
D6D3 CD DF E4       	CALL	CHKWILD
D6D6 30 0B          	JR	NC,PUTN1
D6D8 21 15 F0       	LD	HL,FDRV+1
D6DB CD 02 D6       	CALL	FPRNT
D6DE 3E 20          	LD	A,020H
D6E0 CD A5 DB       	CALL	MSG_A
D6E3                PUTN1:
D6E3 11 14 F0       	LD	DE,FDRV
D6E6 0E 16          	LD	C,016H		;(BDOS)ファイルの作成
D6E8 CD 0E D4       	CALL	SYSTEM0
D6EB 20 48          	JR	NZ,COPYE2
D6ED 67             	LD	H,A		;A=0
D6EE 6F             	LD	L,A
D6EF 22 35 F0       	LD	(FDRV+33),HL	;(FCB)ランダムレコード
D6F2 22 37 F0       	LD	(FDRV+35),HL
D6F5                COPY6:
D6F5 CD 17 D4       	CALL	S27BUF
D6F8 47             	LD	B,A
D6F9 3C             	INC	A
D6FA 28 31          	JR	Z,COPYE
D6FC 7C             	LD	A,H
D6FD B5             	OR	L
D6FE 28 0C          	JR	Z,COPY7
D700 11 14 F0       	LD	DE,FDRV
D703 0E 26          	LD	C,026H		;(BDOS)ランダムブロック書き込み
D705 CD 0E D4       	CALL	SYSTEM0
D708 20 23          	JR	NZ,COPYE
D70A 10 E9          	DJNZ	COPY6
D70C                COPY7:
D70C 3A B1 EF       	LD	A,(DTA_CCP+13)	;(FCB)属性
D70F 32 21 F0       	LD	(FDRV+13),A
D712 21 B8 EF       	LD	HL,DTA_CCP+20	;(FCB)タイムスタンプ
D715 11 28 F0       	LD	DE,FDRV+20
D718 01 04 00       	LD	BC,4
D71B ED B0          	LDIR
D71D                
D71D 11 14 F0       	LD	DE,FDRV
D720 0E 10          	LD	C,010H		;(BDOS)ファイルのクローズ
D722 CD 0E D4       	CALL	SYSTEM0
D725 20 06          	JR	NZ,COPYE
D727                
D727 11 71 F0       	LD	DE,OK
D72A C3 A4 D6       	JP	COPY8
D72D                
D72D                COPYE:
D72D 11 14 F0       	LD	DE,FDRV
D730 0E 13          	LD	C,013H		;(BDOS)ファイルの削除
D732 CD 05 00       	CALL	SYSTEM
D735                COPYE2:
D735 37             	SCF
D736 C9             	RET
D737                
D737                CWILD:
D737 21 5D 00       	LD	HL,FCB1+1
D73A                CWILD1:
D73A 7E             	LD	A,(HL)
D73B FE 20          	CP	020H
D73D C0             	RET	NZ
D73E                CWILD2:
D73E 3E 3F          	LD	A,'?'
D740 06 0B          	LD	B,11
D742 C3 50 E1       	JP	FILL_MEMORY
D745                
D745                COMTB:
D745 44 20 20 20    	DB	"D   "	;1
D749 F6 D4          	DW	C_DIR
D74B 44 49 52 20    	DB	"DIR "	;2
D74F F6 D4          	DW	C_DIR
D751 43 4F 50 59    	DB	"COPY"	;3
D755 5F D6          	DW	C_COPY
D757 43 44 20 20    	DB	"CD  "	;4
D75B 13 D4          	DW	C_CD
D75D 44 45 4C 20    	DB	"DEL "	;5
D761 D9 D4          	DW	C_DEL
D763 50 41 54 48    	DB	"PATH"	;6
D767 8D D5          	DW	C_PATH
D769 52 45 4E 20    	DB	"REN "	;7
D76D E3 D4          	DW	C_REN
D76F 52 45 4D 20    	DB	"REM "	;8
D773 95 D8          	DW	C_REM
D775                	INCLUDE	"X1DISK2.ASM"
D775                
D775                ;	LSX-Dodgers DISK2
D775                ;	X1/turbo/Z
D775                
D775                ;	GRAPHIC RAM DISK DRIVER
D775                
D775                
D775                GDRD:
D775 C5             	PUSH	BC
D776 CD 9E D7       	CALL	GADR
D779 F1             	POP	AF
D77A                GDRD1:
D77A ED A2          	INI
D77C 04             	INC	B
D77D 0C             	INC	C
D77E 20 FA          	JR	NZ,GDRD1
D780 04             	INC	B
D781 13             	INC	DE
D782 3D             	DEC	A
D783 20 F5          	JR	NZ,GDRD1
D785                GBANK0:
D785 3A BF F0       	LD	A,(WK1FD0)
D788 E6 EF          	AND	0EFH		;BANK0
D78A 18 1D          	JR	S1FD0
D78C                
D78C                GDWT:
D78C C5             	PUSH	BC
D78D CD 9E D7       	CALL	GADR
D790 F1             	POP	AF
D791                GDWT1:
D791 04             	INC	B
D792 ED A3          	OUTI
D794 0C             	INC	C
D795 20 FA          	JR	NZ,GDWT1
D797 04             	INC	B
D798 13             	INC	DE
D799 3D             	DEC	A
D79A 20 F5          	JR	NZ,GDWT1
D79C 18 E7          	JR	GBANK0
D79E                
D79E                GADR:
D79E 0E 00          	LD	C,0
D7A0 7B             	LD	A,E
D7A1 C6 40          	ADD	A,040H
D7A3 47             	LD	B,A
D7A4 3A BF F0       	LD	A,(WK1FD0)
D7A7 F6 10          	OR	010H		;BANK1
D7A9                S1FD0:
D7A9 C5             	PUSH	BC
D7AA 32 BF F0       	LD	(WK1FD0),A
D7AD 01 D0 1F       	LD	BC,01FD0H
D7B0 ED 79          	OUT	(C),A
D7B2 C1             	POP	BC
D7B3 C9             	RET
D7B4                
D7B4                
D7B4                ;	BANK RAM DISK DRIVER
D7B4                
D7B4                BDWT:
D7B4 3E             	DB	03EH	;LD A,??
D7B5 37             	SCF
D7B6 18 02          	JR	BRW
D7B8                
D7B8                BDRD:
D7B8 3E             	DB	03EH	;LD A,??
D7B9 A7             	AND	A
D7BA                BRW:
D7BA F3             	DI
D7BB 32 E6 D7       	LD	(BRWPAT),A
D7BE ED 73 06 D8    	LD	(BANKSP),SP
D7C2 3A 07 D8       	LD	A,(BANKSP_H)
D7C5 87             	ADD	A,A
D7C6 38 03          	JR	C,BRW0
D7C8 31 CA FF       	LD	SP,EXTSP
D7CB                BRW0:
D7CB D9             	EXX		;裏レジスタ
D7CC C5             	 PUSH	 BC
D7CD D5             	 PUSH	 DE
D7CE 01 00 0B       	 LD	 BC,00B00H	 ;バンクメモリ
D7D1 11 10 10       	 LD	 DE,01010H
D7D4 D9             	 EXX		;表レジスタ
D7D5                BRW1:
D7D5 C5             	PUSH	BC
D7D6 D5             	PUSH	DE
D7D7 EB             	EX	DE,HL
D7D8 29             	ADD	HL,HL
D7D9 29             	ADD	HL,HL
D7DA 7C             	LD	A,H
D7DB DD 86 0C       	ADD	A,(IX+DPB_MAXCYL)
D7DE E6 0F          	AND	00FH	;バンク
D7E0 65             	LD	H,L
D7E1 CB 3C          	SRL	H	;/2
D7E3 2E 00          	LD	L,0
D7E5 D9             	EXX		;裏レジスタ
D7E6 A7             BRWPAT:	 AND	 A	;自己書き換え(AND A:読み出し/SCF:書き込み)
D7E7 38 08          	 JR	 C,BRWT
D7E9 57             	 LD	 D,A	 ;D=バンク
D7EA D9             	 EXX		;表レジスタ
D7EB EB             	EX	DE,HL
D7EC CD 0A D8       	CALL	BTFR
D7EF 18 06          	JR	BRW2
D7F1                BRWT:
D7F1 5F             	 LD	E,A	 ;E=バンク
D7F2 D9             	 EXX		;表レジスタ
D7F3 CD 0A D8       	CALL	BTFR
D7F6 EB             	EX	DE,HL
D7F7                BRW2:
D7F7 D1             	POP	DE
D7F8 C1             	POP	BC
D7F9 13             	INC	DE
D7FA 10 D9          	DJNZ	BRW1
D7FC                
D7FC D9             	EXX		;裏レジスタ
D7FD 3E 10          	 LD	 A,10H
D7FF ED 79          	 OUT	 (C),A		;メインメモリに切り替える
D801 D1             	 POP	 DE
D802 C1             	 POP	 BC
D803 D9             	 EXX		;表レジスタ
D804 AF             	XOR	A
D805 31 00 00       	LD	SP,0
D808 00 00 D8 07    BANKSP_H	EQU	$-1
D808 00 00 D8 06    BANKSP		EQU	$-2
D808 FB             	EI
D809 C9             	RET
D80A                
D80A                ;メインメモリ←→バンクメモリ 512バイトの転送を行う
D80A                ; DE:転送元アドレス
D80A                ; HL:転送先アドレス
D80A                ; 裏BC:バンク切り替えポート(0B00H)
D80A                ; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
D80A                ; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
D80A                
D80A                BTFR:
D80A 06 00          	LD	B,0	;256回ループ(256*2)
D80C                BTFR1:
D80C D9             	EXX		;裏レジスタ
D80D ED 51          	 OUT	 (C),D	 ;BANK(MAIN)
D80F D9             	 EXX		;表レジスタ
D810 1A             	LD	A,(DE)
D811 4F             	LD	C,A
D812 13             	INC	DE
D813 1A             	LD	A,(DE)
D814 13             	INC	DE
D815 D9             	EXX		;裏レジスタ
D816 ED 59          	 OUT	 (C),E	 ;MAIN(BANK)
D818 D9             	 EXX		;表レジスタ
D819 71             	LD	(HL),C
D81A 23             	INC	HL
D81B 77             	LD	(HL),A
D81C 23             	INC	HL
D81D 10 ED          	DJNZ	BTFR1
D81F C9             	RET
D820                
D820                ;	EMM DRIVER(CPU)
D820                
D820                EDWT:
D820 CD 48 D8       	CALL	EADR
D823                EDWT0:
D823 F5             	PUSH	AF
D824 AF             	XOR	A
D825                EDWT1:
D825 04             	INC	B
D826 ED A3          	OUTI
D828 04             	INC	B
D829 ED A3          	OUTI
D82B 3D             	DEC	A
D82C 20 F7          	JR	NZ,EDWT1
D82E 13             	INC	DE
D82F F1             	POP	AF
D830 3D             	DEC	A
D831 20 F0          	JR	NZ,EDWT0
D833 C9             	RET
D834                
D834                EDRD:
D834 CD 48 D8       	CALL	EADR
D837                EDRD0:
D837 F5             	PUSH	AF
D838 AF             	XOR	A
D839                EDRD1:
D839 ED A2          	INI
D83B 04             	INC	B
D83C ED A2          	INI
D83E 04             	INC	B
D83F 3D             	DEC	A
D840 20 F7          	JR	NZ,EDRD1
D842 13             	INC	DE
D843 F1             	POP	AF
D844 3D             	DEC	A
D845 20 F0          	JR	NZ,EDRD0
D847 C9             	RET
D848                
D848                EADR:
D848 C5             	PUSH	BC
D849 D5             	PUSH	DE
D84A EB             	EX	DE,HL
D84B 29             	ADD	HL,HL
D84C DD 4E 0D       	LD	C,(IX+DPB_MAXSEC)
D84F DD 46 0C       	LD	B,(IX+DPB_MAXCYL)
D852 09             	ADD	HL,BC
D853 DD 4E 13       	LD	C,(IX+DPB_UNITNO)
D856 06 0D          	LD	B,00DH
D858 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
D85A 0C             	INC	C
D85B ED 69          	OUT	(C),L
D85D 0C             	INC	C
D85E ED 61          	OUT	(C),H
D860 0C             	INC	C
D861 EB             	EX	DE,HL
D862 D1             	POP	DE
D863 F1             	POP	AF
D864 A7             	AND	A	;CF=0
D865 C9             	RET
D866                
D866                
D866                	INCLUDE	"LDOS.ASM"
D866                
D866                ;	LSX-Dodgers OS
D866                
D866                BDOS0:
D866 E5             	PUSH	HL
D867 79             	LD	A,C
D868 FE 3C          	CP	03CH
D86A 38 02          	JR	C,DOS1
D86C 3E 3C          	LD	A,03CH
D86E                DOS1:
D86E 87             	ADD	A,A
D86F 6F             	LD	L,A
D870 26 F1          	LD	H,STABLE/256
D872 7E             	LD	A,(HL)
D873 2C             	INC	L
D874 66             	LD	H,(HL)
D875 6F             	LD	L,A
D876 E3             	EX	(SP),HL
D877 79             	LD	A,C
D878                ;確認用
D878                ;	LD	(0050H),A
D878 C9             	RET
D879                _DOS2:
D879 FE 5A          	CP	05AH		;(BDOS)カレントディレクトリの変更(_CHDIR)
D87B CA 13 DB       	JP	Z,_SYS5A
D87E FE 5C          	CP	05CH		;(BDOS)ファイル名の解析(_PFILE)
D880 CA D1 DA       	JP	Z,_SYS29
D883 FE 5F          	CP	05FH		;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
D885 CA EC ED       	JP	Z,_SYS5F
D888 FE 6F          	CP	06FH		;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
D88A 20 0A          	JR	NZ,_ERROR
D88C 01 1D 01       	LD	BC,VER_6F
D88F 11 60 01       	LD	DE,VER
D892 21 00 00       	LD	HL,MACD
D895                C_REM:
D895 AF             	XOR	A
D896                _ERROR:
D896 A7             	AND	A
D897 C9             	RET
D898                
D898                _SYS09:		;文字列出力
D898 D5             	PUSH	DE
D899                _SX09:
D899 1A             	LD	A,(DE)
D89A 13             	INC	DE
D89B FE 24          	CP	'$'
D89D 28 31          	JR	Z,SX0E2
D89F CD A5 DB       	CALL	MSG_A
D8A2 18 F5          	JR	_SX09
D8A4                
D8A4                MSX1:
D8A4 CD A5 DB       	CALL	MSG_A
D8A7                MSX:
D8A7 7E             	LD	A,(HL)
D8A8 23             	INC	HL
D8A9 B7             	OR	A
D8AA 20 F8          	JR	NZ,MSX1
D8AC C9             	RET
D8AD                
D8AD                _SYS0C:		;(BDOS)バージョン番号の獲得
D8AD 21 22 00       	LD	HL,00022H
D8B0 7D             	LD	A,L
D8B1 C9             	RET
D8B2                
D8B2                _SYS0D:		;(BDOS)ディスクリセット
D8B2 CD DF F0       	CALL	_FFLUSH
D8B5 E5             	PUSH	HL
D8B6 21 80 00       	LD	HL,00080H
D8B9 22 8A F0       	LD	(_DTA),HL
D8BC E1             	POP	HL
D8BD D5             	PUSH	DE
D8BE 1E 00          	LD	E,0
D8C0 3E             	DB	03EH	;次の PUSH DE をスキップ
D8C1                
D8C1                _SYS0E:		;(BDOS)カレントドライブの設定
D8C1 D5             	PUSH	DE
D8C2 7B             	LD	A,E
D8C3 DD E5          	PUSH	IX
D8C5 CD DC F0       	CALL	_GETDPB
D8C8 DD E1          	POP	IX
D8CA 38 04          	JR	C,SX0E2
D8CC 7B             	LD	A,E
D8CD 32 87 F0       	LD	(_DVSW),A
D8D0                SX0E2:
D8D0 D1             	POP	DE
D8D1 C9             	RET
D8D2                
D8D2                _SYS0F:		;(BDOS)ファイルのオープン
D8D2 CD 8D E1       	CALL	SETDRV
D8D5 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D8D8 C6 02          	ADD	A,002H		;Write
D8DA 28 48          	JR	Z,FEND0F
D8DC CD DB E4       	CALL	CHKWILDX
D8DF                
D8DF D4 B7 E1       	CALL	NC,SOPENX
D8E2                _S16XX:
D8E2 38 40          	JR	C,FEND0F
D8E4                				;Directory location
D8E4 3A 9F F0       	LD	A,(_FILEN)
D8E7 FD 77 19       	LD	(IY+25),A	;(FCB)ディレクトリロケーション
D8EA                ;				_DIRF
D8EA 3A A0 F0       	LD	A,(_DIRF)
D8ED FD 77 1D       	LD	(IY+29),A	;(FCB)ディレクトリモード
D8F0                ;				_FBPS
D8F0 FD 73 1E       	LD	(IY+30),E	;(FCB)ディレクトリポジション
D8F3 FD 72 1F       	LD	(IY+31),D
D8F6                ;				Open(Read)
D8F6 FD 36 1C FF    	LD	(IY+28),0FFH	;(FCB)オープンモード
D8FA                ;				FILENAME
D8FA FD E5          	PUSH	IY
D8FC D1             	POP	DE
D8FD 13             	INC	DE
D8FE 01 0B 00       	LD	BC,11
D901 ED B0          	LDIR
D903                ;				Attribute
D903 7E             	LD	A,(HL)
D904 FD 77 0D       	LD	(IY+13),A	;(FCB)属性(アトリビュート)
D907 11 0B 00       	LD	DE,11		;Reserved
D90A 19             	ADD	HL,DE
D90B                					;(FCB)ファイルを最後に変更した時刻
D90B 11 E4 F1       	LD	DE,SDDATA		;(FCB)ファイルを最後に変更した日付
D90E 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
D910                S16LOOP:				;(FCB)ファイルのサイズ(バイト単位)
D910 1A             	LD	A,(DE)
D911 13             	INC	DE
D912 32 19 D9       	LD	(S16PAT),A
D915 7E             	LD	A,(HL)
D916 23             	INC	HL
D917 FD 77 00       	LD	(IY+0),A
D91A 00 00 D9 19    S16PAT	EQU	$-1
D91A 10 F4          	DJNZ	S16LOOP
D91C                
D91C AF             	XOR	A
D91D FD 77 0C       	LD	(IY+12),A	;(FCB)カレントブロック
D920 FD 22 C1 D9    	LD	(OFCB_SWC),IY
D924                FEND0F:
D924 18 45          	JR	FEND10
D926                
D926                _SYS10:		;(BDOS)ファイルのクローズ
D926 CD 8D E1       	CALL	SETDRV
D929 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D92C D6 FE          	SUB	0FEH
D92E 37             	SCF
D92F 3F             	CCF
D930 20 39          	JR	NZ,FEND10
D932                _S10A:				;Write
D932 FD 77 0E       	LD	(IY+14),A	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D935 FD 77 0F       	LD	(IY+15),A
D938                
D938 FD 34 1C       	INC	(IY+28)		;(FCB)オープンモード 0FEH->0FFH
D93B CD D7 E5       	CALL	SETTMS
D93E                
D93E FD 7E 1D       	LD	A,(IY+29)	;(FCB)ディレクトリモード
D941 32 A0 F0       	LD	(_DIRF),A
D944 E6 7F          	AND	07FH
D946 32 02 EB       	LD	(_SECPS),A
D949 FD 5E 1E       	LD	E,(IY+30)	;(FCB)ディレクトリポジション
D94C FD 56 1F       	LD	D,(IY+31)
D94F CD EC E2       	CALL	READ_DIR
D952 38 17          	JR	C,FEND10
D954                
D954 3A 17 E2       SDECM1:	LD	A,(SDECPAT)	;1セクタ辺りのディレクトリエントリ数
D957 3D              	DEC	A		;1024=01FH / 512=00FH / 256=7
D958 FD A6 19       	AND	(IY+25)		;(FCB)ディレクトリロケーション
D95B 6F             	LD	L,A
D95C 26 00          	LD	H,0
D95E 29             	ADD	HL,HL		;*2
D95F 29             	ADD	HL,HL		;*4
D960 29             	ADD	HL,HL		;*8
D961 29             	ADD	HL,HL		;*16
D962 29             	ADD	HL,HL		;*32
D963 ED 4B 7E F1    	LD	BC,(_DTBUF)
D967 09             	ADD	HL,BC
D968                
D968 CD EB E4       	CALL	SDIRENT
D96B                FEND10:
D96B 18 42          	JR	FEND
D96D                
D96D                _SYS11:		;(BDOS)最初のファイルの検索
D96D CD 8D E1       	CALL	SETDRV
D970 CD E6 E1       	CALL	SOPEN
D973                _S12X1:
D973 38 3A          	JR	C,FEND
D975 CD 85 E2       	CALL	SOPENE2
D978 ED 5B 8A F0    	LD	DE,(_DTA)
D97C 3A 88 F0       	LD	A,(_DRV)
D97F 3C             	INC	A
D980 12             	LD	(DE),A
D981 D5             	PUSH	DE
D982 13             	INC	DE
D983 01 20 00       	LD	BC,32
D986 ED B0          	LDIR
D988 FD 6E 0E       	LD	L,(IY+14)	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D98B FD 66 0F       	LD	H,(IY+15)
D98E 22 F4 F1       	LD	(SCDIR),HL
D991 2A 9A F0       	LD	HL,(_FBPS)
D994 22 F6 F1       	LD	(SFBPS),HL
D997 2A 9F F0       	LD	HL,(_FILEN)
D99A 7C             	LD	A,H
D99B B7             	OR	A
D99C 28 06          	JR	Z,_S12DIR
D99E 3A 02 EB       	LD	A,(_SECPS)
D9A1 F6 80          	OR	080H
D9A3 67             	LD	H,A
D9A4                _S12DIR:
D9A4 22 F8 F1       	LD	(SFNDF),HL	;Directory position and Flags
D9A7 E1             	POP	HL
D9A8 11 39 F0       	LD	DE,SFILE
D9AB 0E 21          	LD	C,33
D9AD                _S11B:
D9AD ED B0          	LDIR
D9AF                FEND:
D9AF 9F             	SBC	A,A		;CF=0 A=0 : CF=1 A=0FFH
D9B0                FENDE:
D9B0 FD E1          	POP	IY
D9B2 C1             	POP	BC
D9B3 D1             	POP	DE
D9B4 E1             	POP	HL
D9B5 C9             	RET
D9B6                
D9B6                _SYS12:		;(BDOS)次のファイルの検索
D9B6 E5             	PUSH	HL
D9B7 D5             	PUSH	DE
D9B8 C5             	PUSH	BC
D9B9 FD E5          	PUSH	IY
D9BB CD 4A E2       	CALL	NOPEN
D9BE 18 B3          	JR	_S12X1
D9C0                
D9C0                _S16K:
D9C0 11 00 00       	LD	DE,0
D9C3 00 00 D9 C1    OFCB_SWC	EQU	$-2
D9C3 D5             	PUSH	DE
D9C4 06 1A          	LD	B,26		;First cluster
D9C6                S16K1:
D9C6 13             	INC	DE
D9C7 23             	INC	HL
D9C8 10 FC          	DJNZ	S16K1
D9CA                
D9CA 1A             	LD	A,(DE)
D9CB BE             	CP	(HL)
D9CC 20 15          	JR	NZ,S16K2
D9CE 13             	INC	DE
D9CF 23             	INC	HL
D9D0 1A             	LD	A,(DE)
D9D1 BE             	CP	(HL)
D9D2 20 0F          	JR	NZ,S16K2
D9D4                
D9D4 E1             	POP	HL
D9D5 FD E5          	PUSH	IY
D9D7 D1             	POP	DE
D9D8 7E             	LD	A,(HL)
D9D9 CD A2 E1       	CALL	IS_SAME_DRV_A_DE
D9DC 20 06          	JR	NZ,S16K3
D9DE                				;ここはCFが必ず0
D9DE ED 52          	SBC	HL,DE		;CP HL,DE
D9E0 37             	SCF
D9E1 C0             	RET	NZ
D9E2 E5             	PUSH	HL
D9E3                S16K2:
D9E3 E1             	POP	HL
D9E4                S16K3:
D9E4 FD E5          	PUSH	IY
D9E6 D1             	POP	DE
D9E7                _SYS13:		;(BDOS)ファイルの削除
D9E7 CD 8D E1       	CALL	SETDRV
D9EA CD 11 E4       	CALL	KILL
D9ED                FEND13:
D9ED 18 C0          	JR	FEND
D9EF                
D9EF                _SYS14:		;(BDOS)シーケンシャルな読み出し
D9EF CD 8D E1       	CALL	SETDRV
D9F2 CD 43 E6       	CALL	INIT_SEQ
D9F5                SREAD:
D9F5 CD 8B E6       	CALL	RB_READ
D9F8                
D9F8 C6 01          	ADD	A,001H
D9FA 38 B3          	JR	C,FEND
D9FC                
D9FC 7D             	LD	A,L
D9FD D6 01          	SUB	001H
D9FF                FENDX:
D9FF 9F             	SBC	A,A
DA00 E6 03          	AND	3
DA02 1F             	RRA
DA03 18 AB          	JR	FENDE
DA05                
DA05                _SYS15:		;(BDOS)シーケンシャルな書き込み
DA05 CD 8D E1       	CALL	SETDRV
DA08 CD 43 E6       	CALL	INIT_SEQ
DA0B                SWRITE:
DA0B CD 84 E6       	CALL	RB_WRITE
DA0E                
DA0E C6 FF          	ADD	A,0FFH
DA10 18 ED          	JR	FENDX
DA12                
DA12                _SYS17:		;(BDOS)ファイル名の変更
DA12 CD 8D E1       	CALL	SETDRV
DA15 CD 67 E4       	CALL	NAME
DA18 18 D3          	JR	FEND13
DA1A                
DA1A                _SYS16:		;(BDOS)ファイルの作成
DA1A CD 8D E1       	CALL	SETDRV
DA1D                
DA1D CD DB E4       	CALL	CHKWILDX
DA20 38 CB          	JR	C,FEND13
DA22 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
DA25 FE 05          	CP	5
DA27 28 05          	JR	Z,_S16X2
DA29 FE 21          	CP	021H
DA2B DA ED D9       	JP	C,FEND13
DA2E                _S16X2:
DA2E                ;				Clear FCB
DA2E FD E5          	PUSH	IY
DA30 E1             	POP	HL
DA31 01 10 00       	LD	BC,16
DA34 09             	ADD	HL,BC
DA35                _S16X1:
DA35 70             	LD	(HL),B		;B=0
DA36 23             	INC	HL
DA37 0D             	DEC	C
DA38 20 FB          	JR	NZ,_S16X1
DA3A                
DA3A CD DC E5       	CALL	SETTMSX
DA3D FD 36 0D FF    	LD	(IY+13),0FFH	;(FCB)Attribute
DA41 CD B7 E1       	CALL	SOPENX
DA44 3F             	CCF
DA45 CC C0 D9       	CALL	Z,_S16K
DA48 D4 96 E2       	CALL	NC,COPEN
DA4B D4 EB E4       	CALL	NC,SDIRENT
DA4E C3 E2 D8       	JP	_S16XX
DA51                
DA51                _SYS21:		;(BDOS)ランダムな読み出し
DA51 CD 8D E1       	CALL	SETDRV
DA54 CD 27 E6       	CALL	INIT_RND
DA57 18 9C          	JR	SREAD
DA59                
DA59                _SYS22:		;(BDOS)ランダムな書き込み
DA59                _SYS28:		;(BDOS)ランダムな書き込み・その2
DA59 CD 8D E1       	CALL	SETDRV
DA5C CD 27 E6       	CALL	INIT_RND
DA5F 18 AA          	JR	SWRITE
DA61                
DA61                _SYS18:		;(BDOS)ログインベクトルの獲得
DA61 21 FF 00       	LD	HL,000FFH
DA64 AF             	XOR	A
DA65 C9             	RET
DA66                
DA66                _SYS19:		;(BDOS)カレントドライブ番号の獲得
DA66 3A 87 F0       	LD	A,(_DVSW)
DA69 A7             	AND	A
DA6A C9             	RET
DA6B                
DA6B                _SYS1A:		;(BDOS)DTAの設定
DA6B ED 53 8A F0    	LD	(_DTA),DE
DA6F AF             	XOR	A
DA70 C9             	RET
DA71                
DA71                _SYS1B:		;(BDOS)ディスク情報の獲得
DA71 7B             	LD	A,E
DA72 CD 9B E1       	CALL	GETDRV
DA75 CD DC F0       	CALL	_GETDPB
DA78 D4 E2 F0       	CALL	NC,_RDFATX
DA7B 21 00 00       	LD	HL,0
DA7E D4 B5 E5       	CALL	NC,DSKF
DA81                
DA81 ED 5B B6 E5    	LD	DE,(MAXCLP)	;DPB_MAXCL-1
DA85 1B             	DEC	DE		;DE←クラスタの総数
DA86 FD 2A 7C F1    	LD	IY,(_FATBF)	;IY←メモリ上のFATの先頭アドレス
DA8A 9F             	SBC	A,A
DA8B D8             	RET	C
DA8C 4F             	LD	C,A		;C=0
DA8D DD 7E 0F       	LD	A,(IX+DPB_BPS)
DA90 E6 07          	AND	7
DA92 47             	LD	B,A
DA93 DD 7E 07       	LD	A,(IX+DPB_SECPCL)
DA96 C9             	RET
DA97                
DA97                _SYS1D:		;(BDOS)書き込みが禁止されているディスクの調査
DA97 AF             	XOR	A
DA98 67             	LD	H,A
DA99 6F             	LD	L,A
DA9A C9             	RET
DA9B                
DA9B                _SYS1F:		;(BDOS)ディスク装置のパラメータの読み出し
DA9B 21 00 F2       	LD	HL,_DEVICE
DA9E 7B             	LD	A,E
DA9F C3 DC F0       	JP	_GETDPB
DAA2                
DAA2                _SYS23:		;(BDOS)ファイルサイズの獲得
DAA2 E5             	PUSH	HL
DAA3 2A 1E F1       	LD	HL,(STABLE+2*00FH)	;ファイルのオープン
DAA6 CD 0F 00       	CALL	JP_HL
DAA9 38 1B          	JR	C,_S23X1
DAAB                
DAAB D5             	PUSH	DE		;EX DE,IY
DAAC FD E3          	EX	(SP),IY		;
DAAE                ;	POP	DE		;
DAAE                ;	PUSH	DE		;DEを破壊しないように注意vv
DAAE FD 7E 10       	LD	A,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
DAB1 FD 6E 11       	LD	L,(IY+17)	;
DAB4 FD 66 12       	LD	H,(IY+18)	;
DAB7 C5             	PUSH	BC		;
DAB8 FD 46 13       	LD	B,(IY+19)	;
DABB CD 19 E6       	CALL	GET_CPM_R_SIZE
DABE C1             	POP	BC
DABF                _S24X1:
DABF CD 39 E6       	CALL	SET_RR_AHL
DAC2                ;	POP	DE		;^^^^^^^^^^^^^^^^^^^^^^^^
DAC2                ;	PUSH	DE		;EX DE,IY
DAC2 FD E3          	EX	(SP),IY		;
DAC4 D1             	POP	DE		;
DAC5                
DAC5 AF             	XOR	A
DAC6                _S23X1:
DAC6 E1             	POP	HL
DAC7 C9             	RET
DAC8                
DAC8                _SYS24:		;(BDOS)ランダムレコードフィールドの設定
DAC8 E5             	PUSH	HL
DAC9 D5             	PUSH	DE		;EX DE,IY
DACA FD E3          	EX	(SP),IY		;
DACC                ;	POP	DE		;
DACC                ;	PUSH	DE		;DEを破壊しないように注意vv
DACC CD 4B E6       	CALL	GETSEQ
DACF 18 EE          	JR	_S24X1		;^^^^^^^^^^^^^^^^^^^^^^^^
DAD1                
DAD1                _SYS29:		;(BDOS)ファイル名の解析(_PPATH)
DAD1 C5             	PUSH	BC
DAD2 E5             	PUSH	HL
DAD3 CD A4 E0       	CALL	FILE
DAD6 E1             	POP	HL
DAD7 C1             	POP	BC
DAD8                S29X1:
DAD8 C5             	PUSH	BC
DAD9 D5             	PUSH	DE
DADA E5             	PUSH	HL
DADB EB             	EX	DE,HL
DADC AF             	XOR	A
DADD 32 21 F0       	LD	(FDRV+13),A
DAE0 21 14 F0       	LD	HL,FDRV
DAE3 01 10 00       	LD	BC,16
DAE6 ED B0          	LDIR
DAE8 E1             	POP	HL
DAE9 D1             	POP	DE
DAEA C1             	POP	BC
DAEB C9             	RET
DAEC                
DAEC                _SYS30:		;(BDOS)論理セクタを用いた書き込み
DAEC C5             	PUSH	BC
DAED 01 9C EC       	LD	BC,DWT24B
DAF0 18 04          	JR	S2FX
DAF2                _SYS2F:
DAF2 C5             	PUSH	BC
DAF3 01 8C EC       	LD	BC,DRD24B
DAF6                S2FX:
DAF6 ED 43 0C DB    	LD	(S2FPAT+1),BC
DAFA CD DF F0       	CALL	_FFLUSH
DAFD                
DAFD D5             	PUSH	DE
DAFE E5             	PUSH	HL
DAFF 7D             	LD	A,L		;Drive
DB00 CD D9 F0       	CALL	_CHGDRV
DB03 38 09          	JR	C,S30X2
DB05 44             	LD	B,H		;Number of clusters
DB06 2A 8A F0       	LD	HL,(_DTA)
DB09                
DB09 0E 00          	LD	C,0
DB0B CD 8C EC       S2FPAT:	CALL	DRD24B
DB0E                S30X2:
DB0E E1             	POP	HL
DB0F D1             	POP	DE
DB10 C1             	POP	BC
DB11 9F             	SBC	A,A
DB12 C9             	RET
DB13                
DB13                _SYS5A:		;(BDOS)カレントディレクトリの変更
DB13 C5             	PUSH	BC
DB14 D5             	PUSH	DE
DB15 E5             	PUSH	HL
DB16 CD 99 E0       	CALL	FILEC
DB19 21 00 00       	LD	HL,0
DB1C 11 14 F0       	LD	DE,FDRV
DB1F 2A 4E F1       	LD	HL,(STABLE+2*027H)	;ランダムブロック読み込み
DB22 CD 0F 00       	CALL	JP_HL
DB25 18 E7          	JR	S30X2
DB27                	INCLUDE	"X1IO.ASM"
DB27                
DB27                ;	LSX-Dodgers IO
DB27                ;	X1/turbo/Z
DB27                
DB27 00 00 D8 96    _SYS04	EQU	_ERROR		;(BDOS)外部出力
DB27 00 00 D8 96    _SYS05	EQU	_ERROR		;(BDOS)プリンタ出力
DB27 00 00 D8 96    _SYS1C	EQU	_ERROR		;(BDOS)ディスクの書き込み禁止化
DB27 00 00 D8 96    _SYS1E	EQU	_ERROR		;(BDOS)ファイル属性の設定
DB27 00 00 D8 96    _SYS20	EQU	_ERROR		;(BDOS)利用者番号の設定と読み出し
DB27 00 00 D8 96    _SYS2E	EQU	_ERROR		;(BDOS)ベリファイ・フラグの設定
DB27                
DB27                BIOS:
DB27 E5             	PUSH	HL
DB28 21 10 80       	LD	HL,08010H
DB2B 39             	ADD	HL,SP
DB2C E1             	POP	HL
DB2D 30 0E          	JR	NC,BIOS2
DB2F                BIOS1:
DB2F CD 37 DB       	CALL	BIOS3
DB32 06 1E          	LD	B,01EH
DB34 ED 79          	OUT	(C),A
DB36 C9             	RET
DB37                BIOS3:
DB37 C5             	PUSH	BC
DB38 06 1D          	LD	B,01DH
DB3A ED 79          	OUT	(C),A
DB3C C9             	RET
DB3D                BIOS2:
DB3D ED 73 48 DB    	LD	(BIOS_SP),SP	;スタックがBIOS-ROMと被っている場合
DB41 31 CA FF       	LD	SP,EXTSP
DB44 CD 2F DB       	CALL	BIOS1
DB47 31 00 00       	LD	SP,0
DB4A 00 00 DB 48    BIOS_SP	EQU	$-2
DB4A C9             	RET
DB4B                
DB4B                INT:
DB4B F5             	PUSH	AF
DB4C E5             	PUSH	HL
DB4D C5             	PUSH	BC
DB4E                
DB4E CD DB DE       	CALL	IN49SB
DB51 67             	LD	H,A
DB52 CD DB DE       	CALL	IN49SB
DB55 6F             	LD	L,A
DB56                SCEXE:
DB56 22 92 F0       	LD	(_KEYD),HL
DB59 CD 62 DB       	CALL	KEYSET1
DB5C                
DB5C C1             	POP	BC
DB5D                INTPE:
DB5D E1             	POP	HL
DB5E                INTPE2:
DB5E F1             	POP	AF
DB5F                INTCTCE:
DB5F FB             	EI
DB60 ED 4D          	RETI
DB62                
DB62                KEYSET1:
DB62 F5             	PUSH	AF
DB63 AF             	XOR	A
DB64 32 FF DB       	LD	(FLGET_SWC),A
DB67 F1             	POP	AF
DB68 B7             	OR	A
DB69 C8             	RET	Z
DB6A                
DB6A CB 6C          	BIT	5,H
DB6C 28 06          	JR	Z,KEYSET
DB6E 3A 95 F0       	LD	A,(_KEYSP+1)
DB71 32 14 DC       	LD	(KEYREPEAT_SWC),A
DB74                KEYSET:
DB74 7D             	LD	A,L
DB75 CB 74          	BIT	6,H
DB77 C0             	RET	NZ
DB78                KEYBS:
DB78 B7             	OR	A
DB79 C8             	RET	Z
DB7A                KEYBS1:
DB7A CD 92 DB       	CALL	KEYBC_IFBREAK
DB7D E5             	PUSH	HL
DB7E F5             	PUSH	AF
DB7F 2A 90 F0       	LD	HL,(_KEYPS)
DB82 2C             	INC	L
DB83 CB AD          	RES	5,L
DB85 7D             	LD	A,L
DB86 BC             	CP	H
DB87 28 15          	JR	Z,POP_AF_HL_SCF_RET
DB89 32 90 F0       	LD	(_KEYPS),A
DB8C 26 FF          	LD	H,KEYBF/256
DB8E F1             	POP	AF
DB8F 77             	LD	(HL),A
DB90 E1             	POP	HL
DB91 C9             	RET
DB92                KEYBC_IFBREAK:
DB92 FE 03          	CP	3
DB94 C0             	RET	NZ
DB95                KEYBC:
DB95 E5             	PUSH	HL
DB96 21 00 00       	LD	HL,0
DB99 22 90 F0       	LD	(_KEYPS),HL
DB9C E1             	POP	HL
DB9D C9             	RET
DB9E                
DB9E                POP_AF_HL_SCF_RET:
DB9E F1             	POP	AF
DB9F E1             	POP	HL
DBA0 37             	SCF
DBA1 C9             	RET
DBA2                
DBA2                _SYS01:		;(BDOS)コンソール入力
DBA2 CD 09 F0       	CALL	_SYS07
DBA5                MSG_A:
DBA5 F5             	PUSH	AF
DBA6 D5             	PUSH	DE
DBA7 5F             	LD	E,A
DBA8 CD AE DB       	CALL	_SYS02
DBAB D1             	POP	DE
DBAC F1             	POP	AF
DBAD C9             	RET
DBAE                
DBAE                _SYS02:		;(BDOS)コンソール出力
DBAE CD C0 DB       	CALL	BREAK
DBB1 18 05          	JR	PRINTX
DBB3                
DBB3                _SYS06:		;(BDOS)コンソール直接入出力
DBB3 7B             	LD	A,E
DBB4 3C             	INC	A
DBB5 CA CA F0       	JP	Z,_INKEY
DBB8                PRINTX:
DBB8 C3 CD F0       	JP	_PRINT
DBBB                
DBBB                _SYS08:		;(BDOS)エコーなしコンソール入力
DBBB CD 09 F0       	CALL	_SYS07
DBBE 18 04          	JR	BREAK1
DBC0                BREAK:
DBC0 FB             	EI
DBC1 3A 92 F0       	LD	A,(_KEYD)
DBC4                BREAK1:
DBC4 FE 03          	CP	3		;CTRL+C
DBC6 CC F4 F0       	CALL	Z,_BREAK
DBC9 FE 13          	CP	013H		;CTRL+S
DBCB C0             	RET	NZ
DBCC                
DBCC                PAUSE:
DBCC CD 95 DB       	CALL	KEYBC
DBCF                
DBCF                FLGET:
DBCF CD DF F0       	CALL	_FFLUSH
DBD2 C5             	PUSH	BC
DBD3 E5             	PUSH	HL
DBD4 ED 4B 8E F0    	LD	BC,(_TXADR)
DBD8 CB E8          	SET	5,B
DBDA ED 60          	IN	H,(C)
DBDC                FLGET1:
DBDC 3A 93 F0       	LD	A,(_KEYD+1)
DBDF 0F             	RRCA
DBE0 0F             	RRCA
DBE1 E6 10          	AND	010H
DBE3 F6 08          	OR	8
DBE5 ED 68          	IN	L,(C)
DBE7 B5             	OR	L
DBE8 ED 79          	OUT	(C),A
DBEA                FLGETR:
DBEA CD CA F0       	CALL	_INKEY
DBED 20 32          	JR	NZ,FLGETE
DBEF CB 5D          	BIT	3,L
DBF1 28 E9          	JR	Z,FLGET1
DBF3 3A 92 F0       	LD	A,(_KEYD)
DBF6 B7             	OR	A
DBF7 28 E3          	JR	Z,FLGET1
DBF9                
DBF9 3E 1A          	LD	A,01AH
DBFB 32 FF DB       	LD	(FLGET_SWC),A
DBFE                FLGET2:
DBFE 3E 1A          	LD	A,1AH
DC00 00 00 DB FF    FLGET_SWC	EQU	$-1
DC00 B7             	OR	A
DC01 28 E7          	JR	Z,FLGETR
DC03 DB 01          	IN	A,(01H)
DC05 87             	ADD	A,A
DC06 30 F6          	JR	NC,FLGET2
DC08                FLGET3:
DC08 3A FF DB       	LD	A,(FLGET_SWC)
DC0B B7             	OR	A
DC0C 28 DC          	JR	Z,FLGETR
DC0E DB 01          	IN	A,(01H)
DC10 87             	ADD	A,A
DC11 38 F5          	JR	C,FLGET3
DC13                
DC13 3E 00          	LD	A,0
DC15 00 00 DC 14    KEYREPEAT_SWC	EQU $-1
DC15 B7             	OR	A
DC16 28 06          	JR	Z,FLGET4
DC18 3D             	DEC	A
DC19 32 14 DC       	LD	(KEYREPEAT_SWC),A
DC1C 18 E0          	JR	FLGET2
DC1E                FLGET4:
DC1E 3A 92 F0       	LD	A,(_KEYD)
DC21                FLGETE:
DC21 ED 61          	OUT	(C),H
DC23 E1             	POP	HL
DC24 C1             	POP	BC
DC25 C9             	RET
DC26                
DC26                _SYS0A:		;(BDOS)文字列入力
DC26 C5             	PUSH	BC
DC27 E5             	PUSH	HL
DC28 D5             	PUSH	DE
DC29 CD 28 E0       	CALL	GETL
DC2C 11 20 FF       	LD	DE,KBUF
DC2F E1             	POP	HL
DC30 E5             	PUSH	HL
DC31 0E 00          	LD	C,0
DC33 30 04          	JR	NC,SAX0
DC35 23             	INC	HL
DC36 23             	INC	HL
DC37 18 08          	JR	SAX4
DC39                SAX0:
DC39 46             	LD	B,(HL)
DC3A 23             	INC	HL
DC3B                SAX1:
DC3B 23             	INC	HL
DC3C 1A             	LD	A,(DE)
DC3D 13             	INC	DE
DC3E B7             	OR	A
DC3F 20 04          	JR	NZ,SAX2
DC41                SAX4:
DC41 36 0D          	LD	(HL),00DH
DC43 18 04          	JR	SAX3
DC45                SAX2:
DC45 77             	LD	(HL),A
DC46 0C             	INC	C
DC47 10 F2          	DJNZ	SAX1
DC49                SAX3:
DC49 D1             	POP	DE
DC4A 79             	LD	A,C
DC4B 13             	INC	DE
DC4C 12             	LD	(DE),A
DC4D 1B             	DEC	DE
DC4E E1             	POP	HL
DC4F C1             	POP	BC
DC50 A7             	AND	A
DC51 C9             	RET
DC52                
DC52                _SYS0B:		;(BDOS)コンソール状態のチェック
DC52 CD C0 DB       	CALL	BREAK
DC55 3A 92 F0       	LD	A,(_KEYD)
DC58 B7             	OR	A
DC59 C8             	RET	Z
DC5A                CONSTX:
DC5A CD DF F0       	CALL	_FFLUSH
DC5D E5             	PUSH	HL
DC5E 2A 90 F0       	LD	HL,(_KEYPS)
DC61 7C             	LD	A,H
DC62 AD             	XOR	L
DC63 E1             	POP	HL
DC64 C6 FF          	ADD	A,0FFH
DC66 9F             	SBC	A,A
DC67 C9             	RET
DC68                
DC68                _SYS2A:		;(BDOS)日付の獲得
DC68 C5             	PUSH	BC
DC69 3E ED          	LD	A,0EDH		;Read calendar
DC6B CD F6 DE       	CALL	COMOUT
DC6E CD A0 DC       	CALL	IN49SB_BCD	;YY
DC71 6F             	LD	L,A
DC72 26 00          	LD	H,0
DC74                ;	LD	DE,1900		;0076CH
DC74                ;	CP	90		;90以上は1900年代 1990-1999
DC74                ;	JR	NC,RDDATE1	;90未満は2000年代 2000-2089
DC74                ;	LD	E,0D0H		;2000 & 0FFH D=007H
DC74 11 D0 07       	LD	DE,2000		;すべて2000年代で処理 2000-2099
DC77                RDDATE1:
DC77 19             	ADD	HL,DE
DC78 CD DB DE       	CALL	IN49SB		;MW
DC7B 57             	LD	D,A
DC7C CD A0 DC       	CALL	IN49SB_BCD	;DD
DC7F 5F             	LD	E,A
DC80 7A             	LD	A,D
DC81 06 04          	LD	B,4
DC83                RDDATE2:
DC83 CB 3A          	SRL	D
DC85 10 FC          	DJNZ	RDDATE2
DC87 C1             	POP	BC
DC88 E6 07          	AND	7
DC8A C9             	RET
DC8B                
DC8B                _SYS2C:		;(BDOS)時刻の獲得
DC8B C5             	PUSH	BC
DC8C 3E EF          	LD	A,0EFH		;Read time
DC8E CD F6 DE       	CALL	COMOUT
DC91 CD A0 DC       	CALL	IN49SB_BCD	;TT
DC94 67             	LD	H,A
DC95 CD A0 DC       	CALL	IN49SB_BCD	;MM
DC98 6F             	LD	L,A
DC99 CD A0 DC       	CALL	IN49SB_BCD	;SS
DC9C 57             	LD	D,A
DC9D C1             	POP	BC
DC9E AF             	XOR	A
DC9F C9             	RET
DCA0                
DCA0                IN49SB_BCD:
DCA0 CD DB DE       	CALL	IN49SB
DCA3                ;------------------------
DCA3                ;BCDの10進数化
DCA3                ;in
DCA3                ;	A  : BCD
DCA3                ;out
DCA3                ;	A  : 10進数
DCA3                ;------------------------
DCA3 4F             	LD	C,A
DCA4 E6 F0          	AND	0F0H	;10の位
DCA6 0F             	RRCA
DCA7 47             	LD	B,A
DCA8 0F             	RRCA
DCA9 0F             	RRCA
DCAA 80             	ADD	A,B
DCAB 47             	LD	B,A
DCAC 79             	LD	A,C
DCAD E6 0F          	AND	00FH	;1の位
DCAF 80             	ADD	A,B
DCB0 C9             	RET
DCB1                
DCB1                ESC1:
DCB1 7B             	LD	A,E
DCB2 FE 41          	CP	'A'
DCB4 CA F9 DD       	JP	Z,CTRL1E
DCB7 FE 42          	CP	'B'
DCB9 CA 61 DF       	JP	Z,CTRL1F
DCBC FE 43          	CP	'C'
DCBE CA 04 DE       	JP	Z,CTRL1C
DCC1 FE 44          	CP	'D'
DCC3 CA F0 DD       	JP	Z,CTRL1D
DCC6 FE 45          	CP	'E'
DCC8 28 02          	JR	Z,CT0CX
DCCA FE 6A          	CP	'j'
DCCC                CT0CX:
DCCC CA 34 DF       	JP	Z,CTRL0C
DCCF FE 48          	CP	'H'
DCD1 CA 7E DE       	JP	Z,CTRL0B
DCD4 FE 4A          	CP	'J'
DCD6 CA 37 DF       	JP	Z,CTRL06
DCD9 FE 4B          	CP	'K'
DCDB 28 07          	JR	Z,CT05X
DCDD FE 4C          	CP	'L'
DCDF CA 76 DF       	JP	Z,CTRL0E
DCE2 FE 54          	CP	'T'
DCE4                CT05X:
DCE4 CA 3D DE       	JP	Z,CTRL05
DCE7 FE 78          	CP	'x'
DCE9 28 04          	JR	Z,ESC1X
DCEB FE 79          	CP	'y'
DCED 20 02          	JR	NZ,ESC1Y
DCEF                ESC1X:
DCEF 36 01          	LD	(HL),1
DCF1                ESC1Y:
DCF1 FE 3D          	CP	'='
DCF3 28 04          	JR	Z,ESC1W
DCF5 FE 59          	CP	'Y'
DCF7 20 02          	JR	NZ,ESC1Z
DCF9                ESC1W:
DCF9 36 02          	LD	(HL),2
DCFB                ESC1Z:
DCFB FE 20          	CP	020H
DCFD 38 02          	JR	C,ESC1C
DCFF 87             	ADD	A,A
DD00 D0             	RET	NC
DD01                ESC1C:
DD01 E1             	POP	HL
DD02                ANK:
DD02 ED 4B 8E F0    	LD	BC,(_TXADR)
DD06 78             	LD	A,B
DD07 F6 38          	OR	038H
DD09 47             	LD	B,A
DD0A ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DD0C CB 98          	RES	3,B
DD0E ED 59          	OUT	(C),E		;Text
DD10                KANJIE:
DD10 CD C5 DD       	CALL	PRINTE7
DD13                PRINTE5:
DD13 E1             	POP	HL
DD14 C1             	POP	BC
DD15 AF             	XOR	A
DD16 C9             	RET
DD17                
DD17                ESC:
DD17 21 13 DD       	LD	HL,PRINTE5
DD1A E5             	PUSH	HL
DD1B 21 3D DD       	LD	HL,ESCFLG+1
DD1E 36 00          	LD	(HL),0
DD20 3D             	DEC	A
DD21 28 8E          	JR	Z,ESC1
DD23 3D             	DEC	A
DD24 20 09          	JR	NZ,ESC2
DD26 36 03          	LD	(HL),3
DD28 7B             	LD	A,E
DD29 D6 20          	SUB	020H
DD2B 32 32 DD       	LD	(ESCYP+1),A
DD2E C9             	RET
DD2F                ESC2:
DD2F 3D             	DEC	A
DD30 C0             	RET	NZ
DD31 26 00          ESCYP:	LD	H,0
DD33 7B             	LD	A,E
DD34 D6 20          	SUB	020H
DD36 6F             	LD	L,A
DD37 C3 D6 F0       	JP	_LOC
DD3A                
DD3A                PRINT:
DD3A C5             	PUSH	BC
DD3B E5             	PUSH	HL
DD3C 3E 00          ESCFLG:	LD	A,000H
DD3E B7             	OR	A
DD3F 20 D6          	JR	NZ,ESC
DD41                
DD41 3E 1F          	LD	A,01FH
DD43 BB             	CP	E
DD44 30 20          	JR	NC,CTRL
DD46 01 FF DE       INSFLG:	LD	BC,INSERT
DD49                
DD49 3A 18 00       	LD	A,(00018H)
DD4C 3C             	INC	A
DD4D 28 B3          	JR	Z,ANK
DD4F 3E 00          KANFLG:	LD	A,000H
DD51 B7             	OR	A
DD52 20 25          	JR	NZ,KANJI2
DD54 7B             	LD	A,E
DD55 FE 80          	CP	080H
DD57 38 A9          	JR	C,ANK
DD59 FE A0          	CP	0A0H
DD5B 38 04          	JR	C,KANJI1
DD5D FE E0          	CP	0E0H
DD5F 38 A1          	JR	C,ANK
DD61                KANJI1:
DD61 32 50 DD       	LD	(KANFLG+1),A
DD64 18 AD          	JR	PRINTE5
DD66                
DD66                CTRL:
DD66 CD AC DD       	CALL	KANCLR
DD69 7B             	LD	A,E
DD6A 87             	ADD	A,A
DD6B F6 80          	OR	080H
DD6D 6F             	LD	L,A
DD6E 26 F1          	LD	H,CTRLTB/256
DD70 7E             	LD	A,(HL)
DD71 2C             	INC	L
DD72 66             	LD	H,(HL)
DD73 6F             	LD	L,A
DD74 CD 0F 00       	CALL	JP_HL
DD77 18 9A          	JR	PRINTE5
DD79                
DD79                KANJI2:
DD79 D5             	PUSH	DE
DD7A 57             	LD	D,A
DD7B 01 81 2F       	LD	BC,02F81H	;SFTJIS
DD7E DF             	RST	018H
DD7F 01 C3 2F       	LD	BC,02FC3H	;Instead or JISVRM
DD82 DF             	RST	018H
DD83                
DD83 ED 4B 8E F0    	LD	BC,(_TXADR)
DD87 78             	LD	A,B
DD88 F6 38          	OR	038H
DD8A 47             	LD	B,A
DD8B ED 51          	OUT	(C),D		;kanji
DD8D CB 98          	RES	3,B
DD8F ED 59          	OUT	(C),E		;Text
DD91 CD C5 DD       	CALL	PRINTE7
DD94 ED 4B 8E F0    	LD	BC,(_TXADR)
DD98 78             	LD	A,B
DD99 F6 38          	OR	038H
DD9B 47             	LD	B,A
DD9C CB F2          	SET	6,D
DD9E ED 51          	OUT	(C),D		;Kanji
DDA0 CB 98          	RES	3,B
DDA2 ED 59          	OUT	(C),E		;Text
DDA4 D1             	POP	DE
DDA5 AF             	XOR	A
DDA6 32 50 DD       	LD	(KANFLG+1),A
DDA9 C3 10 DD       	JP	KANJIE
DDAC                
DDAC                KANCLR:
DDAC 3A 50 DD       	LD	A,(KANFLG+1)
DDAF B7             	OR	A
DDB0 C8             	RET	Z
DDB1 ED 4B 8E F0    	LD	BC,(_TXADR)
DDB5 78             	LD	A,B
DDB6 F6 38          	OR	038H
DDB8 47             	LD	B,A
DDB9 AF             	XOR	A
DDBA 32 50 DD       	LD	(KANFLG+1),A
DDBD ED 79          	OUT	(C),A		;Kanji
DDBF CB 98          	RES	3,B
DDC1 3E 20          	LD	A,020H
DDC3 ED 79          	OUT	(C),A		;Text
DDC5                PRINTE7:
DDC5 CB A0          	RES	4,B
DDC7                PRINTE6:
DDC7 3A 96 F0       	LD	A,(_COLORF)
DDCA                PRINTE4:
DDCA ED 79          	OUT	(C),A		;Color
DDCC 78             	LD	A,B
DDCD E6 07          	AND	7
DDCF 47             	LD	B,A
DDD0                PRINTE2:
DDD0 03             	INC	BC
DDD1                PRINTE3:
DDD1 2A BA F0       	LD	HL,(_PAGE_MINUS)
DDD4 A7             	AND	A
DDD5 ED 4A          	ADC	HL,BC
DDD7                PRINTE8:
DDD7 28 05          	JR	Z,PRINT2
DDD9 ED 43 8E F0    	LD	(_TXADR),BC
DDDD                CTRL00:
DDDD C9             	RET
DDDE                
DDDE                PRINT2:
DDDE CD 7C DF       	CALL	SCR
DDE1 2A BC F0       	LD	HL,(_WIDTH_MINUS)
DDE4 09             	ADD	HL,BC
DDE5                SET_TXADR_HL:
DDE5 22 8E F0       	LD	(_TXADR),HL
DDE8 C9             	RET
DDE9                
DDE9                CTRL08:
DDE9 3A 46 DD       	LD	A,(INSFLG)
DDEC FE CD          	CP	0CDH		;CALL ????
DDEE 28 29          	JR	Z,CTRL02
DDF0                CTRL1D:
DDF0 2A 8E F0       	LD	HL,(_TXADR)
DDF3 7C             	LD	A,H
DDF4 B5             	OR	L
DDF5 C8             	RET	Z
DDF6 2B             	DEC	HL
DDF7 18 EC          	JR	SET_TXADR_HL
DDF9                
DDF9                CTRL1E:
DDF9 ED 4B 8E F0    	LD	BC,(_TXADR)
DDFD 2A BC F0       	LD	HL,(_WIDTH_MINUS)
DE00 09             	ADD	HL,BC
DE01 D0             	RET	NC
DE02 18 E1          	JR	SET_TXADR_HL
DE04                
DE04                CTRL1C:
DE04 ED 4B 8E F0    	LD	BC,(_TXADR)
DE08 18 C6          	JR	PRINTE2
DE0A                
DE0A                CTRL09:
DE0A ED 4B 8E F0    	LD	BC,(_TXADR)
DE0E 79             	LD	A,C
DE0F E6 F8          	AND	0F8H
DE11 C6 08          	ADD	A,8
DE13 4F             	LD	C,A
DE14 88             	ADC	A,B
DE15 91             	SUB	C
DE16 47             	LD	B,A
DE17 18 B8          	JR	PRINTE3
DE19                
DE19                CTRL02:
DE19 CD F0 DD       	CALL	CTRL1D
DE1C C8             	RET	Z
DE1D D5             	PUSH	DE
DE1E CD D3 F0       	CALL	_POS
DE21 3A B1 F0       	LD	A,(_WIDTH)
DE24 95             	SUB	L
DE25 4F             	LD	C,A
DE26 0D             	DEC	C
DE27 06 38          	LD	B,038H
DE29 2A 8E F0       	LD	HL,(_TXADR)
DE2C 09             	ADD	HL,BC
DE2D 44             	LD	B,H
DE2E 4D             	LD	C,L
DE2F 11 00 20       	LD	DE,02000H	;D:Text E:kanji
DE32 2A 96 F0       	LD	HL,(_COLORF)	;L:Color
DE35                C8X1:
DE35 CD 1B DF       	CALL	C12S
DE38 0B             	DEC	BC
DE39 20 FA          	JR	NZ,C8X1
DE3B D1             	POP	DE
DE3C C9             	RET
DE3D                
DE3D                CTRL05:
DE3D CD D3 F0       	CALL	_POS
DE40 3A B1 F0       	LD	A,(_WIDTH)
DE43 95             	SUB	L
DE44 6F             	LD	L,A
DE45                C08X1:
DE45 ED 4B 8E F0    	LD	BC,(_TXADR)
DE49                LINECL:
DE49 26 20          	LD	H,020H
DE4B 3A 96 F0       	LD	A,(_COLORF)
DE4E CB E8          	SET	5,B
DE50                LINECL1:
DE50 CB D8          	SET	3,B
DE52 CB E0          	SET	4,B
DE54 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DE56 CB 98          	RES	3,B
DE58 ED 61          	OUT	(C),H		;Text
DE5A CB A0          	RES	4,B
DE5C ED 79          	OUT	(C),A		;Color
DE5E 03             	INC	BC
DE5F 2D             	DEC	L
DE60 20 EE          	JR	NZ,LINECL1
DE62 C9             	RET
DE63                
DE63                CTRL0D:
DE63 CD D3 F0       	CALL	_POS
DE66 2E 00          	LD	L,0
DE68                LOC:
DE68 C5             	PUSH	BC
DE69 E5             	PUSH	HL
DE6A CD AC DD       	CALL	KANCLR
DE6D CD 8B DE       	CALL	LOC1
DE70 22 8E F0       	LD	(_TXADR),HL
DE73 E1             	POP	HL
DE74 C1             	POP	BC
DE75 C9             	RET
DE76                
DE76                CTRL12:
DE76 21 46 DD       	LD	HL,INSFLG
DE79 7E             	LD	A,(HL)
DE7A EE CC          	XOR	0CCH		;CD:CALL ???? 1:LD BC,????
DE7C 77             	LD	(HL),A
DE7D C9             	RET
DE7E                
DE7E                CTRL0B:
DE7E 21 00 00       	LD	HL,0
DE81 22 8E F0       	LD	(_TXADR),HL
DE84 C9             	RET
DE85                
DE85                CTRL1B:
DE85 3E 01          	LD	A,1
DE87 32 3D DD       	LD	(ESCFLG+1),A
DE8A C9             	RET
DE8B                
DE8B                LOC1:
DE8B D5             	PUSH	DE
DE8C 4D             	LD	C,L
DE8D 06 08          	LD	B,8
DE8F 5C             	LD	E,H
DE90 16 00          	LD	D,0
DE92 2A B0 F0       	LD	HL,(CRTCD)
DE95 6A             	LD	L,D
DE96                LOC2:
DE96 29             	ADD	HL,HL
DE97 30 01          	JR	NC,LOC3
DE99 19             	ADD	HL,DE
DE9A                LOC3:
DE9A 10 FA          	DJNZ	LOC2
DE9C 09             	ADD	HL,BC
DE9D D1             	POP	DE
DE9E C9             	RET
DE9F                
DE9F                CONOUT1:
DE9F CD B1 DE       	CALL	CURSOR
DEA2 59             	LD	E,C
DEA3 CD CD F0       	CALL	_PRINT
DEA6 7B             	LD	A,E
DEA7 FE 0A          	CP	00AH
DEA9 20 06          	JR	NZ,CURSOR
DEAB CD 63 DE       	CALL	CTRL0D
DEAE CD 3D DE       	CALL	CTRL05
DEB1                CURSOR:
DEB1 C5             	PUSH	BC
DEB2 ED 4B 8E F0    	LD	BC,(_TXADR)
DEB6 CB E8          	SET	5,B
DEB8 ED 78          	IN	A,(C)
DEBA EE 18          	XOR	018H
DEBC ED 79          	OUT	(C),A
DEBE C1             	POP	BC
DEBF C9             	RET
DEC0                
DEC0                CTRL07:
DEC0 21 61 F0       	LD	HL,BEEPD
DEC3                BEEP1:
DEC3 7E             	LD	A,(HL)
DEC4 23             	INC	HL
DEC5 FE FF          	CP	0FFH
DEC7 C8             	RET	Z
DEC8 06 1C          	LD	B,01CH
DECA ED 79          	OUT	(C),A
DECC ED A3          	OUTI
DECE 18 F3          	JR	BEEP1
DED0                
DED0                OT49SB:
DED0 C5             	PUSH	BC
DED1 CD EC DE       	CALL	CANW
DED4 01 00 19       	LD	BC,01900H
DED7 ED 79          	OUT	(C),A
DED9 C1             	POP	BC
DEDA C9             	RET
DEDB                
DEDB                IN49SB:
DEDB C5             	PUSH	BC
DEDC 01 01 1A       	LD	BC,01A01H
DEDF                CANR:
DEDF ED 78          	IN	A,(C)
DEE1 E6 20          	AND	020H
DEE3 20 FA          	JR	NZ,CANR
DEE5 01 00 19       	LD	BC,01900H
DEE8 ED 78          	IN	A,(C)
DEEA C1             	POP	BC
DEEB C9             	RET
DEEC                
DEEC                CANW:
DEEC 01 01 1A       	LD	BC,01A01H
DEEF ED 48          	IN	C,(C)
DEF1 CB 71          	BIT	6,C
DEF3 20 F7          	JR	NZ,CANW
DEF5 C9             	RET
DEF6                
DEF6                COMOUT:
DEF6 FB             	EI
DEF7 CD D0 DE       	CALL	OT49SB
DEFA CD EC DE       	CALL	CANW
DEFD F3             	DI
DEFE C9             	RET
DEFF                
DEFF                INSERT:
DEFF D5             	PUSH	DE
DF00 CD D3 F0       	CALL	_POS
DF03 3A B1 F0       	LD	A,(_WIDTH)
DF06 95             	SUB	L
DF07 ED 4B 8E F0    	LD	BC,(_TXADR)
DF0B 11 00 20       	LD	DE,02000H	;D:Text E:Kanji
DF0E 2A 96 F0       	LD	HL,(_COLORF)	;L:Color
DF11 CB E8          	SET	5,B
DF13                C12X1:
DF13 CD 1B DF       	CALL	C12S
DF16 03             	INC	BC
DF17 20 FA          	JR	NZ,C12X1
DF19 D1             	POP	DE
DF1A C9             	RET
DF1B                
DF1B                C12S:
DF1B CB E0          	SET	4,B
DF1D CB D8          	SET	3,B
DF1F ED 60          	IN	H,(C)
DF21 ED 59          X1PAT:	OUT	(C),E
DF23 5C             	LD	E,H
DF24 CB 98          	RES	3,B
DF26 ED 60          	IN	H,(C)
DF28 ED 51          	OUT	(C),D
DF2A 54             	LD	D,H
DF2B CB A0          	RES	4,B
DF2D ED 60          	IN	H,(C)
DF2F ED 69          	OUT	(C),L
DF31 6C             	LD	L,H
DF32 3D             	DEC	A
DF33 C9             	RET
DF34                
DF34                CTRL0C:
DF34 CD 7E DE       	CALL	CTRL0B
DF37                CTRL06:
DF37 ED 4B 8E F0    	LD	BC,(_TXADR)
DF3B                C1AX1:
DF3B 78             	LD	A,B
DF3C F6 38          	OR	038H
DF3E 47             	LD	B,A
DF3F ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DF41 CB 98          	RES	3,B
DF43 3E 20          	LD	A,020H
DF45 ED 79          	OUT	(C),A		;Text
DF47 CB A0          	RES	4,B
DF49 3A 96 F0       	LD	A,(_COLORF)
DF4C ED 79          	OUT	(C),A		;Color
DF4E 03             	INC	BC
DF4F CB A8          	RES	5,B
DF51 2A BA F0       	LD	HL,(_PAGE_MINUS)
DF54 09             	ADD	HL,BC
DF55 30 E4          	JR	NC,C1AX1
DF57 C9             	RET
DF58                
DF58                CTRL04:
DF58 CD D3 F0       	CALL	_POS
DF5B 7D             	LD	A,L
DF5C B7             	OR	A
DF5D C8             	RET	Z
DF5E                CTRL03:
DF5E CD 63 DE       	CALL	CTRL0D
DF61                CTRL0A:
DF61                CTRL1F:
DF61 ED 4B 8E F0    	LD	BC,(_TXADR)
DF65 2A B1 F0       	LD	HL,(_WIDTH)
DF68 26 00          	LD	H,0
DF6A 09             	ADD	HL,BC
DF6B 44             	LD	B,H
DF6C 4D             	LD	C,L
DF6D 2A BA F0       	LD	HL,(_PAGE_MINUS)
DF70 09             	ADD	HL,BC
DF71 3F             	CCF
DF72 9F             	SBC	A,A
DF73 C3 D7 DD       	JP	PRINTE8
DF76                
DF76                CTRL0E:
DF76 CD D3 F0       	CALL	_POS
DF79 7C             	LD	A,H
DF7A 18 04          	JR	SCR1
DF7C                SCR:
DF7C 3A 97 F0       	LD	A,(_LINE)
DF7F 3D             	DEC	A
DF80                SCR1:
DF80 C5             	PUSH	BC
DF81 D5             	PUSH	DE
DF82 F5             	PUSH	AF
DF83 3E 07          	LD	A,7
DF85 21 B6 DF       	LD	HL,SCRDMAD
DF88 CD AC DF       	CALL	SETDMA
DF8B F1             	POP	AF
DF8C 21 00 38       	LD	HL,03800H
DF8F                
DF8F                SCRUP1:
DF8F B7             	OR	A
DF90 28 4D          	JR	Z,SCRCL
DF92 F5             	PUSH	AF
DF93 CD BD DF       	CALL	UPSUB		;kanji
DF96 3A BC F0       	LD	A,(_WIDTH_MINUS)
DF99 5F             	LD	E,A
DF9A 16 F7          	LD	D,0F7H
DF9C 19             	ADD	HL,DE
DF9D D5             	PUSH	DE
DF9E CD BD DF       	CALL	UPSUB		;Text
DFA1 D1             	POP	DE
DFA2 19             	ADD	HL,DE
DFA3 CD BD DF       	CALL	UPSUB		;Color
DFA6 CB E4          	SET	4,H
DFA8 F1             	POP	AF
DFA9 3D             	DEC	A
DFAA 18 E3          	JR	SCRUP1
DFAC                
DFAC                SETDMA:
DFAC 01 87 1F       	LD	BC,01F87H
DFAF                SDMA:
DFAF 04             	INC	B
DFB0 ED A3          	OUTI
DFB2 3D             	DEC	A
DFB3 20 FA          	JR	NZ,SDMA
DFB5 C9             	RET
DFB6                
DFB6                SCRDMAD:
DFB6 C3             	DB	0C3H		;WR6 リセット
DFB7 9A             	DB	09AH		;WR5 ストップ WAIT READY:HIGH
DFB8 65             	DB	065H		;WR0 ブロック長(LH)
DFB9 4F 00          	DW	79
DFBB 1C             	DB	01CH		;WR1 ポートAインクリメント I/O
DFBC 18             	DB	018H		;WR0 ポートAアドレス(LH)
DFBD                
DFBD                UPSUB:
DFBD 3A B1 F0       	LD	A,(_WIDTH)
DFC0 5F             	LD	E,A
DFC1 16 00          	LD	D,0
DFC3 3E AD          	LD	A,0ADH		;WR4 連続 ポートB開始アドレス(LH)
DFC5 ED 79          	OUT	(C),A
DFC7 ED 69          	OUT	(C),L		;SOURCE
DFC9 ED 61          	OUT	(C),H
DFCB 19             	ADD	HL,DE
DFCC 3E 1D          	LD	A,01DH		;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
DFCE ED 79          	OUT	(C),A
DFD0 ED 69          	OUT	(C),L		;DEST
DFD2 ED 61          	OUT	(C),H
DFD4                GO_DMA:
DFD4 3E CF          	LD	A,0CFH
DFD6 ED 79          	OUT	(C),A		;WR6 ロード
DFD8 3E B3          	LD	A,0B3H
DFDA ED 79          	OUT	(C),A		;WR6 強制RDY
DFDC ED 49          	OUT	(C),C		;WR6 イネーブル
DFDE C9             	RET
DFDF                
DFDF                SCRCL:
DFDF 44             	LD	B,H
DFE0 4D             	LD	C,L
DFE1 2A B1 F0       	LD	HL,(_WIDTH)
DFE4 CD 49 DE       	CALL	LINECL
DFE7 D1             	POP	DE
DFE8 C1             	POP	BC
DFE9 C9             	RET
DFEA                
DFEA                SCRN:
DFEA D5             	PUSH	DE
DFEB ED 58          	IN	E,(C)		;Text
DFED 3A 18 00       	LD	A,(00018H)
DFF0 3C             	INC	A
DFF1 28 1E          	JR	Z,SCRN2
DFF3 CB D8          	SET	3,B
DFF5 ED 50          	IN	D,(C)		;Kanji
DFF7 28 16          	JR	Z,SCRN1
DFF9 AF             	XOR	A
DFFA C5             	PUSH	BC
DFFB 01 37 30       	LD	BC,03037H	;VRMJIS
DFFE DF             	RST	018H
DFFF 01 52 2F       	LD	BC,02F52H	;JISSFT
E002 DF             	RST	018H
E003 C1             	POP	BC
E004 ED 78          	IN	A,(C)
E006 CB 98          	RES	3,B
E008 E6 40          	AND	040H
E00A 20 05          	JR	NZ,SCRN2
E00C 7A             	LD	A,D
E00D D1             	POP	DE
E00E C9             	RET
E00F                SCRN1:
E00F CB 98          	RES	3,B
E011                SCRN2:
E011 7B             	LD	A,E
E012 D1             	POP	DE
E013 C9             	RET
E014                SCRNE:
E014                POS:
E014 2A 8E F0       	LD	HL,(_TXADR)
E017 C5             	PUSH	BC
E018 ED 4B BC F0    	LD	BC,(_WIDTH_MINUS)
E01C AF             	XOR	A
E01D                POS1:
E01D 09             	ADD	HL,BC
E01E 3C             	INC	A
E01F 38 FC          	JR	C,POS1
E021 ED 42          	SBC	HL,BC
E023 3D             	DEC	A
E024 67             	LD	H,A
E025 C1             	POP	BC
E026 A7             	AND	A
E027 C9             	RET
E028                
E028                GETL:
E028 CD D3 F0       	CALL	_POS
E02B E5             	PUSH	HL
E02C 3E CD          	LD	A,0CDH		;CALL ????
E02E 32 46 DD       	LD	(INSFLG),A
E031                GETL1:
E031 CD BB DB       	CALL	_SYS08
E034 FE 09          	CP	9
E036 20 08          	JR	NZ,GETL1V
E038 21 20 FF       	LD	HL,KBUF
E03B CD A7 D8       	CALL	MSX
E03E 18 F1          	JR	GETL1
E040                GETL1V:
E040 5F             	LD	E,A
E041 CD CD F0       	CALL	_PRINT
E044                
E044 7B             	LD	A,E
E045 FE 0D          	CP	00DH
E047 20 E8          	JR	NZ,GETL1
E049 3E 01          	LD	A,1		;LD BC,????
E04B 32 46 DD       	LD	(INSFLG),A
E04E 11 20 FF       	LD	DE,KBUF
E051 3A B1 F0       	LD	A,(_WIDTH)
E054 47             	LD	B,A
E055 CD 59 D6       	CALL	ZERO_MEMORY_DE
E058                
E058 D1             	POP	DE
E059 CD D3 F0       	CALL	_POS
E05C 6B             	LD	L,E
E05D 3A B1 F0       	LD	A,(_WIDTH)
E060 95             	SUB	L
E061 57             	LD	D,A
E062 CD 8B DE       	CALL	LOC1
E065 4D             	LD	C,L
E066 7C             	LD	A,H
E067 F6 30          	OR	030H
E069 47             	LD	B,A
E06A 5A             	LD	E,D
E06B 21 20 FF       	LD	HL,KBUF
E06E                GETL2:
E06E CD D0 F0       	CALL	_SCRN
E071 03             	INC	BC
E072 77             	LD	(HL),A
E073 23             	INC	HL
E074 1D             	DEC	E
E075 20 F7          	JR	NZ,GETL2
E077                GETL3:
E077 2B             	DEC	HL
E078 7E             	LD	A,(HL)
E079 FE 21          	CP	021H
E07B D0             	RET	NC
E07C 36 00          	LD	(HL),0
E07E 15             	DEC	D
E07F 20 F6          	JR	NZ,GETL3
E081 C9             	RET
E082                
E082                INKEY:
E082 FB             	EI
E083 E5             	PUSH	HL
E084 2A 90 F0       	LD	HL,(_KEYPS)
E087 7C             	LD	A,H
E088 AD             	XOR	L
E089 28 0B          	JR	Z,INKEY1
E08B 7C             	LD	A,H
E08C 3C             	INC	A
E08D E6 1F          	AND	01FH
E08F 32 91 F0       	LD	(_KEYPS+1),A
E092 6F             	LD	L,A
E093 26 FF          	LD	H,KEYBF/256
E095 7E             	LD	A,(HL)
E096                INKEY1:
E096 E1             	POP	HL
E097 B7             	OR	A
E098 C9             	RET
E099                
E099 00 00 0E 83    AT_RS	EQU	SCR1-AT_SCR1
E099                	INCLUDE	"LDFILE.ASM"
E099                
E099                ;	LSX-Dodgers FILE
E099                
E099                FILEC:
E099 CD A4 E0       	CALL	FILE
E09C                FILEC2:
E09C 3A 15 F0       	LD	A,(FDRV+1)
E09F FE 20          	CP	020H
E0A1 C8             	RET	Z
E0A2 18 39          	JR	SETDIR1
E0A4                
E0A4                FILE:
E0A4 AF             	XOR	A
E0A5 32 14 F0       	LD	(FDRV),A
E0A8 67             	LD	H,A
E0A9 6F             	LD	L,A
E0AA 22 22 F0       	LD	(FDRV+14),HL
E0AD CD 7B E1       	CALL	SPCUT
E0B0 CD 60 E1       	CALL	CCHK3
E0B3 28 12          	JR	Z,DEVI1
E0B5 13             	INC	DE
E0B6 1A             	LD	A,(DE)
E0B7 1B             	DEC	DE
E0B8 FE 3A          	CP	':'
E0BA 20 0B          	JR	NZ,DEVI1
E0BC 1A             	LD	A,(DE)		;DRIVE
E0BD CD BB E3       	CALL	CAP
E0C0 D6 40          	SUB	'@'
E0C2 13             	INC	DE
E0C3 13             	INC	DE
E0C4 32 14 F0       	LD	(FDRV),A
E0C7                DEVI1:
E0C7 1A             	LD	A,(DE)
E0C8 D6 5C          	SUB	05CH		;\
E0CA 20 09          	JR	NZ,NOROOT
E0CC 6F             	LD	L,A		;A=0でH=0のはずなのでHL=0
E0CD 22 2E F0       	LD	(FDRV+26),HL
E0D0 2C             	INC	L
E0D1 22 22 F0       	LD	(FDRV+14),HL
E0D4 13             	INC	DE
E0D5                NOROOT:
E0D5                
E0D5                SETDIR:
E0D5 CD 01 E1       	CALL	FILED
E0D8 1A             	LD	A,(DE)
E0D9 FE 5C          	CP	05CH		;\
E0DB C0             	RET	NZ
E0DC 13             	INC	DE
E0DD                SETDIR1:
E0DD 3E 10          	LD	A,010H		;Directory
E0DF 32 21 F0       	LD	(FDRV+13),A
E0E2 D5             	PUSH	DE
E0E3 11 14 F0       	LD	DE,FDRV
E0E6 2A 1E F1       	LD	HL,(STABLE+2*00FH)
E0E9 CD 0F 00       	CALL	JP_HL
E0EC D1             	POP	DE
E0ED B7             	OR	A
E0EE C0             	RET	NZ
E0EF                
E0EF 3A 21 F0       	LD	A,(FDRV+13)
E0F2 CB 67          	BIT	4,A
E0F4 C8             	RET	Z
E0F5                
E0F5 CD 48 E1       	CALL	FILEI
E0F8 2A 2E F0       	LD	HL,(FDRV+26)
E0FB 23             	INC	HL
E0FC 22 22 F0       	LD	(FDRV+14),HL
E0FF 18 D4          	JR	SETDIR
E101                
E101                FILED:
E101 CD 48 E1       	CALL	FILEI
E104 21 15 F0       	LD	HL,FNAME
E107                
E107 06 08          	LD	B,8
E109                FILE2:
E109 CD 55 E1       	CALL	CCHKF
E10C C8             	RET	Z
E10D FE 2A          	CP	'*'
E10F 28 2E          	JR	Z,FILE9
E111 FE 2E          	CP	'.'
E113 28 0C          	JR	Z,FILE4
E115 77             	LD	(HL),A
E116 23             	INC	HL
E117 10 F0          	DJNZ	FILE2
E119                
E119                FILE3:
E119 CD 55 E1       	CALL	CCHKF
E11C C8             	RET	Z
E11D FE 2E          	CP	'.'
E11F 20 F8          	JR	NZ,FILE3
E121                
E121                FILE4:
E121 21 1D F0       	LD	HL,FNAME+8
E124 06 03          	LD	B,3
E126                
E126                FILE4L:
E126 CD 55 E1       	CALL	CCHKF
E129 C8             	RET	Z
E12A FE 2E          	CP	'.'
E12C 20 08          	JR	NZ,FILE12
E12E 32 15 F0       	LD	(FNAME),A	;Parent directory(..)
E131 32 16 F0       	LD	(FNAME+1),A
E134 3E 20          	LD	A,020H
E136                FILE12:
E136 FE 2A          	CP	'*'
E138 28 0A          	JR	Z,FILE10
E13A 77             	LD	(HL),A
E13B 23             	INC	HL
E13C 10 E8          	DJNZ	FILE4L
E13E C9             	RET
E13F                
E13F                FILE9:				;名前の*処理、名前の残りを?で埋める
E13F CD 44 E1       	CALL	FILE10
E142 18 D5          	JR	FILE3
E144                
E144                FILE10:
E144 3E 3F          	LD	A,'?'
E146 18 08          	JR	FILL_MEMORY
E148                FILEI:				;名前＋拡張子をスペースで初期化
E148 3E 20          	LD	A,020H
E14A 01 00 0B       	LD	BC,11*256	;C=0にしておく
E14D 21 15 F0       	LD	HL,FNAME
E150                FILL_MEMORY:			;HLからBバイトAで埋める
E150 77             	LD	(HL),A
E151 23             	INC	HL
E152 10 FC          	DJNZ	FILL_MEMORY
E154 C9             	RET
E155                
E155                CCHKF:
E155 1A             	LD	A,(DE)
E156 CD 5D E1       	CALL	CCHK2
E159 C8             	RET	Z
E15A C3 C8 E4       	JP	FKAN
E15D                
E15D                CCHK2:
E15D 0C             	INC	C
E15E 0D             	DEC	C
E15F C0             	RET	NZ
E160                CCHK3:				;ZF=1 で使えない文字
E160 FE 2B          	CP	'+'
E162 C8             	RET	Z
E163 FE 2C          	CP	','
E165 C8             	RET	Z
E166 FE 2F          	CP	'/'
E168 C8             	RET	Z
E169 FE 3A          	CP	':'
E16B C8             	RET	Z
E16C FE 3B          	CP	';'
E16E C8             	RET	Z
E16F FE 3D          	CP	'='
E171 C8             	RET	Z
E172 FE 5C          	CP	05CH	;\
E174 C8             	RET	Z
E175 FE 20          	CP	020H
E177 D0             	RET	NC
E178 BF             	CP	A		;Z=1
E179 C9             	RET
E17A                
E17A                SS1:
E17A 13             	INC	DE
E17B                SPCUT:				;スペースをカット
E17B 1A             	LD	A,(DE)
E17C FE 20          	CP	020H
E17E 28 FA          	JR	Z,SS1
E180 C9             	RET
E181                
E181                SETDRVF:
E181 11 14 F0       	LD	DE,FDRV
E184                SETDRV0:
E184 CD 8D E1       	CALL	SETDRV
E187 FD E1          	POP	IY
E189 C1             	POP	BC
E18A D1             	POP	DE
E18B E1             	POP	HL
E18C C9             	RET
E18D                
E18D                SETDRV:
E18D E3             	EX	(SP),HL		;HL=RETRN ADDRESS
E18E D5             	PUSH	DE		;PUSH HL/DE/BC/IY
E18F C5             	PUSH	BC
E190 1A             	LD	A,(DE)
E191 D5             	PUSH	DE
E192 FD E3          	EX	(SP),IY
E194                
E194 CD 9B E1       	CALL	GETDRV
E197 CD D9 F0       	CALL	_CHGDRV
E19A                
E19A E9             	JP	(HL)
E19B                
E19B                GETDRV:
E19B CD AE E1       	CALL	GETDRV1
E19E 32 88 F0       	LD	(_DRV),A
E1A1 C9             	RET
E1A2                
E1A2                IS_SAME_DRV_A_DE:
E1A2                ;	A と (DE) が同じドライブか調べる
E1A2                ;	ZF=1ならば同じドライブ
E1A2 CD AE E1       	CALL	GETDRV1
E1A5 C5             	PUSH	BC
E1A6 4F             	LD	C,A
E1A7 1A             	LD	A,(DE)
E1A8 CD AE E1       	CALL	GETDRV1
E1AB A9             	XOR	C
E1AC C1             	POP	BC
E1AD C9             	RET
E1AE                GETDRV1:
E1AE E6 7F          	AND	07FH
E1B0 D6 01          	SUB	001H
E1B2 D0             	RET	NC
E1B3 3A 87 F0       	LD	A,(_DVSW)	;Current Drive
E1B6 C9             	RET
E1B7                
E1B7                SOPENX:
E1B7 11 39 F0       	LD	DE,SFILE
E1BA FD 7E 00       	LD	A,(IY+0)		;(FCB)ドライブ番号
E1BD CD A2 E1       	CALL	IS_SAME_DRV_A_DE
E1C0 20 24          	JR	NZ,SOPEN
E1C2 13             	INC	DE
E1C3 FD E5          	PUSH	IY
E1C5 E1             	POP	HL
E1C6 23             	INC	HL
E1C7 CD 53 E3       	CALL	CPFILE
E1CA 20 1A          	JR	NZ,SOPEN
E1CC                
E1CC 2A F4 F1       	LD	HL,(SCDIR)
E1CF FD 75 0E       	LD	(IY+14),L	;(FCB)アクセスするディレクトリのクラスタ番号+1
E1D2 FD 74 0F       	LD	(IY+15),H
E1D5                
E1D5 2A F8 F1       	LD	HL,(SFNDF)	;Direcroty location and Flags
E1D8 22 9F F0       	LD	(_FILEN),HL
E1DB                
E1DB ED 5B F6 F1    	LD	DE,(SFBPS)
E1DF 21 39 F0       	LD	HL,SFILE
E1E2 36 FF          	LD	(HL),0FFH
E1E4 23             	INC	HL
E1E5 C9             	RET
E1E6                SOPEN:
E1E6 21 FB E2       	LD	HL,FILESE
E1E9                SOPENC:
E1E9 22 22 E2       	LD	(OPENPAT),HL
E1EC                
E1EC CD E2 F0       	CALL	_RDFATX		;Detect Media
E1EF 38 56          	JR	C,RDDERR
E1F1                
E1F1 AF             	XOR	A
E1F2 32 9F F0       	LD	(_FILEN),A
E1F5 CD FB E3       	CALL	LDDIRX1		;A=0で呼び出す
E1F8 28 18          	JR	Z,SDIRX1
E1FA                
E1FA CD EC E2       	CALL	READ_DIR	;Sub Directory
E1FD 38 08          	JR	C,SDIRX0
E1FF 2A 7E F1       	LD	HL,(_DTBUF)
E202 7E             	LD	A,(HL)
E203 FE 2E          	CP	'.'
E205 28 0F          	JR	Z,SOPEN1
E207                SDIRX0:
E207 AF             	XOR	A
E208 32 A0 F0       	LD	(_DIRF),A
E20B FD 36 0E 01    	LD	(IY+14),1	;(FCB)レコードサイズ
E20F FD 77 0F       	LD	(IY+15),A
E212                SDIRX1:
E212 ED 5B FC F1    	LD	DE,(_DIRPS)	;Root Directory
E216                SOPEN1:
E216 0E 20          	LD	C,32		;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
E218 00 00 E2 17    SDECPAT	EQU	$-1
E218                SOPEN1X:
E218 CD EC E2       	CALL	READ_DIR	;FILE SEARCH
E21B 38 2A          	JR	C,RDDERR
E21D 2A 7E F1       	LD	HL,(_DTBUF)
E220                SOPEN2:
E220 D5             	PUSH	DE
E221 CD FB E2       	CALL	FILESE		;(self-modifying code)
E224 00 00 E2 22    OPENPAT	EQU	$-2
E224 D1             	POP	DE
E225 38 6D          	JR	C,SOPENE
E227 28 1B          	JR	Z,SCF_FF_RET
E229                SOPEN3:
E229 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E22C B7             	OR	A
E22D 20 0C          	JR	NZ,SOPEN5
E22F 13             	INC	DE		;ルートディレクトリ
E230 E5             	PUSH	HL
E231 21 0C 00       	LD	HL,12		;(self-modifying code)MAXDIR
E234 00 00 E2 32    MD_PAT	EQU	$-2
E234 ED 52          	SBC	HL,DE		;CF=0 なので SUB HL,DE
E236 E1             	POP	HL
E237 20 DD          	JR	NZ,SOPEN1
E239 18 07          	JR	SOPEN6
E23B                SOPEN5:
E23B CD 0A EB       	CALL	GNCLX		;END DIR
E23E D8             	RET	C
E23F CD B3 E3       	CALL	ENDCL
E242                SOPEN6:
E242 38 D2          	JR	C,SOPEN1
E244                SCF_FF_RET:
E244 37             	SCF			;CF=1
E245 9F             	SBC	A,A		;A=0FFH
E246 C9             	RET
E247                
E247                RDDERR:
E247 BF             	CP	A		;READ ERR CF=1 ZF=1
E248 37             	SCF
E249 C9             	RET
E24A                
E24A                NOPEN:
E24A 21 FB E2       	LD	HL,FILESE
E24D 22 22 E2       	LD	(OPENPAT),HL
E250 FD 2A 98 F0    	LD	IY,(_FCB)
E254 CD DB E4       	CALL	CHKWILDX
E257 30 EB          	JR	NC,SCF_FF_RET
E259 FD 7E 00       	LD	A,(IY+0)
E25C CD 9B E1       	CALL	GETDRV
E25F CD D9 F0       	CALL	_CHGDRV
E262 D8             	RET	C
E263 2A F8 F1       	LD	HL,(SFNDF)	;Direcroty location and Flags
E266 22 9F F0       	LD	(_FILEN),HL
E269                
E269 CD F6 E3       	CALL	LDDIRX
E26C ED 5B 9A F0    	LD	DE,(_FBPS)
E270 CD EC E2       	CALL	READ_DIR
E273 38 D2          	JR	C,RDDERR
E275 3A 9E F0       	LD	A,(_FBCNT)
E278 3D             	DEC	A
E279 28 AE          	JR	Z,SOPEN3
E27B                NOPEN2:
E27B 2A 9C F0       	LD	HL,(_FBAD)
E27E 01 20 00       	LD	BC,020H
E281 09             	ADD	HL,BC
E282 4F             	LD	C,A
E283 18 9B          	JR	SOPEN2
E285                
E285                SOPENE2:
E285 22 9C F0       	LD	(_FBAD),HL
E288 79             	LD	A,C
E289 32 9E F0       	LD	(_FBCNT),A
E28C ED 53 9A F0    	LD	(_FBPS),DE
E290 FD 22 98 F0    	LD	(_FCB),IY
E294                SOPENE:
E294 AF             	XOR	A
E295 C9             	RET
E296                
E296                COPEN:
E296 FD 36 0D 20    	LD	(IY+13),020H	;(FCB)属性(アトリビュート)
E29A                
E29A 21 18 E3       	LD	HL,NEXTSE
E29D CD E9 E1       	CALL	SOPENC
E2A0 D0             	RET	NC
E2A1 C8             	RET	Z
E2A2 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E2A5 B7             	OR	A
E2A6 37             	SCF
E2A7 C8             	RET	Z		;ルートディレクトリ
E2A8 06 01          	LD	B,1
E2AA CD 3A E5       	CALL	WRDF
E2AD D8             	RET	C
E2AE ED 5B FE F1    	LD	DE,(_CLPS)
E2B2 D5             	PUSH	DE
E2B3 CD 7C E3       	CALL	DCPAT
E2B6 CD 95 E9       	CALL	DRDNX
E2B9 2A 7E F1       	LD	HL,(_DTBUF)	;ディレクトリエントリを0クリア
E2BC 3A 9F E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E2BF 47             	LD	B,A
E2C0 AF             	XOR	A
E2C1 4F             	LD	C,A
E2C2                COPENCL:
E2C2 77             	LD	(HL),A
E2C3 ED A1          	CPI			;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
E2C5 EA C2 E2       	JP	PE,COPENCL
E2C8                
E2C8 3A 9A E3       	LD	A,(SPCPAT)	;1クラスタの論理セクタ数
E2CB 3D             	DEC	A
E2CC 28 19          	JR	Z,COPENE
E2CE 3E 01          	LD	A,1		;1セクタ辺りのセクタ数が2以上の場合
E2D0 32 02 EB       	LD	(_SECPS),A
E2D3 D1             	POP	DE		;DE=(_CLPS)
E2D4 D5             	PUSH	DE
E2D5                COPEN1:
E2D5 D5             	PUSH	DE		;データバッファに入らないセクタもゼロクリア
E2D6 C5             	PUSH	BC
E2D7 2A 7E F1       	LD	HL,(_DTBUF)
E2DA CD 96 E3       	CALL	CLUSTX
E2DD CD 9A EC       	CALL	DWT24
E2E0 C1             	POP	BC
E2E1 D1             	POP	DE
E2E2 CD 01 EB       	CALL	NEXTX
E2E5 20 EE          	JR	NZ,COPEN1
E2E7                COPENE:
E2E7 2A 7E F1       	LD	HL,(_DTBUF)
E2EA D1             	POP	DE
E2EB C9             	RET
E2EC                
E2EC                READ_DIR:
E2EC ED 53 FE F1    	LD	(_CLPS),DE
E2F0 C5             	PUSH	BC
E2F1 D5             	PUSH	DE
E2F2 CD 7C E3       	CALL	DCPAT
E2F5 CD 75 E9       	CALL	DRDX
E2F8 D1             	POP	DE
E2F9 C1             	POP	BC
E2FA C9             	RET
E2FB                
E2FB                FILESE:
E2FB 7E             	LD	A,(HL)
E2FC B7             	OR	A
E2FD C8             	RET	Z		;END:ZF=1 CF=0
E2FE FE E5          	CP	0E5H
E300 28 0E          	JR	Z,FILESE1
E302 FD E5          	PUSH	IY
E304 D1             	POP	DE
E305 13             	INC	DE
E306 E5             	PUSH	HL
E307 CD 53 E3       	CALL	CPFILE
E30A CC 74 E3       	CALL	Z,CPFILE2
E30D E1             	POP	HL
E30E 37             	SCF
E30F C8             	RET	Z		;!!!:(ZF=1) CF=1
E310                FILESE1:
E310 CD 27 E3       	CALL	FNEXT
E313 20 E6          	JR	NZ,FILESE
E315                ZF0_CF0_AFF_RET:
E315 F6 FF          	OR	0FFH		;ZF=0 CF=0
E317 C9             	RET
E318                
E318                NEXTSE:
E318 7E             	LD	A,(HL)
E319 B7             	OR	A
E31A 37             	SCF
E31B C8             	RET	Z		;!!!:ZF=1 CF=1
E31C FE E5          	CP	0E5H
E31E 37             	SCF
E31F C8             	RET	Z		;!!!:(ZF=1) CF=1
E320 CD 27 E3       	CALL	FNEXT
E323 20 F3          	JR	NZ,NEXTSE
E325 18 EE          	JR	ZF0_CF0_AFF_RET
E327                
E327                FNEXT:
E327 E5             	PUSH	HL
E328 21 9F F0       	LD	HL,_FILEN
E32B 34             	INC	(HL)
E32C E1             	POP	HL
E32D 11 20 00       	LD	DE,020H
E330 19             	ADD	HL,DE
E331 0D             	DEC	C
E332 C9             	RET
E333                
E333                CPNAME:
E333 C5             	PUSH	BC
E334 D5             	PUSH	DE
E335 E5             	PUSH	HL
E336 CD 4D E3       	CALL	CPFILE4
E339 E1             	POP	HL
E33A 23             	INC	HL
E33B 23             	INC	HL
E33C 23             	INC	HL
E33D 23             	INC	HL
E33E D1             	POP	DE
E33F C1             	POP	BC
E340 20 05          	JR	NZ,CPNAME1
E342 7E             	LD	A,(HL)
E343 23             	INC	HL
E344 66             	LD	H,(HL)
E345 6F             	LD	L,A
E346 C9             	RET
E347                CPNAME1:
E347 23             	INC	HL
E348 23             	INC	HL
E349 10 E8          	DJNZ	CPNAME
E34B 37             	SCF
E34C C9             	RET
E34D                
E34D                CPFILE4:
E34D C5             	PUSH	BC
E34E 01 00 04       	LD	BC,00400H
E351 18 04          	JR	CPSTR1
E353                CPFILE:
E353 C5             	PUSH	BC
E354 01 00 0B       	LD	BC,00B00H
E357                CPSTR1:
E357 1A             	LD	A,(DE)
E358 FE 3F          	CP	'?'		;Wild card
E35A 28 12          	JR	Z,CPSTR2
E35C 7E             	LD	A,(HL)
E35D CD C1 E4       	CALL	FKANC
E360 E5             	PUSH	HL
E361 67             	LD	H,A
E362 1A             	LD	A,(DE)
E363 CB 01          	RLC	C
E365 CD C1 E4       	CALL	FKANC
E368 CB 09          	RRC	C
E36A BC             	CP	H		;CP (HL),(DE)
E36B E1             	POP	HL
E36C 20 04          	JR	NZ,CPSTR3
E36E                CPSTR2:
E36E 13             	INC	DE
E36F 23             	INC	HL
E370 10 E5          	DJNZ	CPSTR1
E372                CPSTR3:
E372 C1             	POP	BC
E373 C9             	RET
E374                
E374                CPFILE2:
E374 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E377 F6 E1          	OR	0E1H
E379 2F             	CPL
E37A A6             	AND	(HL)
E37B C9             	RET
E37C                
E37C                DCPAT:
E37C 0E 00          	LD	C,0
E37E 2A 7E F1       	LD	HL,(_DTBUF)
E381 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E384 B7             	OR	A
E385 C8             	RET	Z		;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
E386 3A 9A E3       	LD	A,(SPCPAT)
E389 4F             	LD	C,A
E38A 3A 02 EB       	LD	A,(_SECPS)
E38D B9             	CP	C
E38E 38 01          	JR	C,DC1
E390 AF             	XOR	A
E391                DC1:
E391 F6 80          	OR	080H
E393 32 A0 F0       	LD	(_DIRF),A	;bit0-6:セクタインデックス
E396                CLUSTX:
E396 E5             	PUSH	HL
E397 EB             	EX	DE,HL
E398 AF             	XOR	A
E399 0E 01          	LD	C,1		;自己書き換え（1クラスタの論理セクタ数）
E39B 00 00 E3 9A    SPCPAT	EQU	$-1
E39B                L_CLDBL:
E39B CB 19          	RR	C		;->CF
E39D 38 04          	JR	C,E_CLDBL
E39F 29             	ADD	HL,HL		;*2
E3A0 8F             	ADC	A,A
E3A1 18 F8          	JR	L_CLDBL
E3A3                E_CLDBL:
E3A3 4F             	LD	C,A
E3A4 3A 02 EB       	LD	A,(_SECPS)
E3A7 B5             	OR	L
E3A8 6F             	LD	L,A
E3A9 11 08 00       	LD	DE,8	;+8 (2D)  !ADDCL (self-modifying code)
E3AC 00 00 E3 AA    CLSPAT	EQU	$-2
E3AC AF             	XOR	A
E3AD 19             	ADD	HL,DE	;データ格納領域の先頭論理セクタ番号
E3AE 89             	ADC	A,C
E3AF 4F             	LD	C,A
E3B0 EB             	EX	DE,HL
E3B1 E1             	POP	HL
E3B2 C9             	RET
E3B3                
E3B3                ENDCL:
E3B3 7A             	LD	A,D	;END CLUSTER
E3B4 FE 01          	CP	1	;164=356	(self-modifying code)
E3B6 00 00 E3 B5    CLPAT1	EQU	$-1
E3B6 C0             	RET	NZ
E3B7 7B             	LD	A,E
E3B8 FE 64          	CP	064H	;		(self-modifying code)
E3BA 00 00 E3 B9    CLPAT2	EQU	$-1
E3BA C9             	RET
E3BB                
E3BB                CAP:
E3BB FE 61          	CP	'a'
E3BD D8             	RET	C
E3BE FE 7B          	CP	'z'+1
E3C0 D0             	RET	NC
E3C1 D6 20          	SUB	020H
E3C3 C9             	RET
E3C4                CAP2:
E3C4 CD BB E3       	CALL	CAP
E3C7                CAP3:				;
E3C7 FE 05          	CP	5
E3C9 28 03          	JR	Z,CAP4
E3CB FE 21          	CP	021H
E3CD C9             	RET
E3CE                CAP4:
E3CE 3E E5          	LD	A,0E5H
E3D0 C9             	RET
E3D1                
E3D1                CHDIR:
E3D1 CD BC ED       	CALL	GETDPBD
E3D4 38 1D          	JR	C,CHDIR2
E3D6 DD 75 1A       	LD	(IX+DPB_SDIR),L
E3D9 DD 74 1B       	LD	(IX+DPB_SDIR+1),H
E3DC 18 15          	JR	CHDIR2		;POP_IX_RET
E3DE                
E3DE                LDDIR:
E3DE CD BC ED       	CALL	GETDPBD
E3E1 DD 5E 1A       	LD	E,(IX+DPB_SDIR)
E3E4 DD 56 1B       	LD	D,(IX+DPB_SDIR+1)
E3E7 13             	INC	DE
E3E8 FD 73 0E       	LD	(IY+14),E	;(FCB)アクセスするディレクトリのクラスタ番号+1
E3EB FD 72 0F       	LD	(IY+15),D
E3EE 1B             	DEC	DE
E3EF AF             	XOR	A
E3F0 32 A0 F0       	LD	(_DIRF),A
E3F3                CHDIR2:
E3F3 DD E1          	POP	IX
E3F5 C9             	RET
E3F6                
E3F6                LDDIRX:
E3F6 3A A0 F0       	LD	A,(_DIRF)	;(FCB)アクセスするディレクトリのセクタインデックス
E3F9 E6 7F          	AND	07FH
E3FB                LDDIRX1:
E3FB 32 02 EB       	LD	(_SECPS),A
E3FE FD 5E 0E       	LD	E,(IY+14)	;(FCB)アクセスするディレクトリのクラスタ番号+1
E401 FD 56 0F       	LD	D,(IY+15)
E404 1B             	DEC	DE
E405 CD B3 E3       	CALL	ENDCL
E408 D4 DE E3       	CALL	NC,LDDIR
E40B                LDDIRS:
E40B 7A             	LD	A,D
E40C B3             	OR	E
E40D 32 A0 F0       	LD	(_DIRF),A	;ディレクトリか判別
E410 C9             	RET
E411                
E411                KILL:
E411 CD DB E4       	CALL	CHKWILDX
E414 38 34          	JR	C,KILLW
E416 CD B7 E1       	CALL	SOPENX
E419                KILLS:
E419 3E 1F          	LD	A,01FH
E41B D4 5D E4       	CALL	NC,CHKATT
E41E D8             	RET	C
E41F                KILLSX:
E41F 36 E5          	LD	(HL),0E5H	;DIR
E421 CD B5 E4       	CALL	WTDB
E424 11 1A 00       	LD	DE,01AH
E427 19             	ADD	HL,DE
E428 5E             	LD	E,(HL)
E429 23             	INC	HL
E42A 56             	LD	D,(HL)
E42B                KILLS1:
E42B CD B3 E3       	CALL	ENDCL
E42E D0             	RET	NC		;CF=0
E42F 21 FE FF       	LD	HL,0-2
E432 19             	ADD	HL,DE
E433 D0             	RET	NC		;DE= 0 or 1
E434 D5             	PUSH	DE
E435 CD F7 F0       	CALL	_GNCL
E438 ED 53 FE F1    	LD	(_CLPS),DE
E43C D1             	POP	DE
E43D 21 00 00       	LD	HL,0
E440 D4 FA F0       	CALL	NC,_SNCL
E443 D8             	RET	C
E444 ED 5B FE F1    	LD	DE,(_CLPS)	;FAT
E448 18 E1          	JR	KILLS1
E44A                
E44A                KILLW:
E44A CD E6 E1       	CALL	SOPEN
E44D                KILLW1:
E44D 38 0B          	JR	C,KILLW2
E44F CD 85 E2       	CALL	SOPENE2
E452 CD 19 E4       	CALL	KILLS
E455 CD 4A E2       	CALL	NOPEN
E458 18 F3          	JR	KILLW1
E45A                KILLW2:
E45A C8             	RET	Z
E45B 3F             	CCF
E45C C9             	RET
E45D                
E45D                CHKATT:
E45D E5             	PUSH	HL
E45E 11 0B 00       	LD	DE,00BH
E461 19             	ADD	HL,DE
E462 A6             	AND	(HL)
E463 E1             	POP	HL
E464 C8             	RET	Z
E465 37             	SCF
E466 C9             	RET
E467                
E467                NAME:
E467 CD DB E4       	CALL	CHKWILDX
E46A D8             	RET	C
E46B 11 04 00       	LD	DE,4
E46E 19             	ADD	HL,DE
E46F 22 84 E4       	LD	(NAMEP),HL
E472 23             	INC	HL
E473 CD DF E4       	CALL	CHKWILD
E476 D8             	RET	C
E477                
E477 CD B7 E1       	CALL	SOPENX
E47A 3E 0F          	LD	A,00FH
E47C D4 5D E4       	CALL	NC,CHKATT
E47F D8             	RET	C
E480                
E480 FD E5          	PUSH	IY
E482 FD 21 00 00    	LD	IY,0		;自己書き換え
E486 00 00 E4 84    NAMEP	EQU	$-2
E486 CD B7 E1       	CALL	SOPENX
E489 FD E3          	EX	(SP),IY
E48B 3F             	CCF
E48C D4 E6 E1       	CALL	NC,SOPEN
E48F EB             	EX	DE,HL
E490 E1             	POP	HL
E491 D8             	RET	C
E492                
E492                SETNAME:
E492 01 00 0B       	LD	BC,11*256
E495 23             	INC	HL
E496 7E             	LD	A,(HL)
E497 FE E5          	CP	0E5H
E499 20 04          	JR	NZ,SNAME1
E49B 3E 05          	LD	A,5
E49D 18 0E          	JR	SNAME3
E49F                SNAME1:
E49F 7E             	LD	A,(HL)
E4A0 0C             	INC	C
E4A1 0D             	DEC	C
E4A2 20 09          	JR	NZ,SNAME3
E4A4 CD BB E3       	CALL	CAP
E4A7 FE A0          	CP	0A0H
E4A9 20 02          	JR	NZ,SNAME3
E4AB 3E 20          	LD	A,020H
E4AD                SNAME3:
E4AD 12             	LD	(DE),A
E4AE 7E             	LD	A,(HL)
E4AF 23             	INC	HL
E4B0 CD C8 E4       	CALL	FKAN
E4B3 10 EA          	DJNZ	SNAME1
E4B5                WTDB:
E4B5 3E FF          	LD	A,0FFH
E4B7 32 39 F0       	LD	(SFILE),A
E4BA                SWTDBF:
E4BA 3E 01          	LD	A,1
E4BC 32 A4 F0       	LD	(_WTDBF),A
E4BF AF             	XOR	A
E4C0 C9             	RET
E4C1                
E4C1                FKANC:
E4C1 CB 41          	BIT	0,C
E4C3 CC C4 E3       	CALL	Z,CAP2
E4C6 18 01          	JR	FKANX
E4C8                FKAN:			;漢字チェック
E4C8 13             	INC	DE
E4C9                FKANX:
E4C9 CB 41          	BIT	0,C
E4CB CB 81          	RES	0,C
E4CD C0             	RET	NZ
E4CE FE 80          	CP	080H
E4D0 D8             	RET	C
E4D1 FE A0          	CP	0A0H
E4D3 38 03          	JR	C,FKAN1
E4D5 FE E0          	CP	0E0H
E4D7 D8             	RET	C
E4D8                FKAN1:
E4D8 0C             	INC	C
E4D9 A7             	AND	A
E4DA C9             	RET
E4DB                
E4DB                CHKWILDX:
E4DB FD E5          	PUSH	IY
E4DD E1             	POP	HL
E4DE 23             	INC	HL
E4DF                CHKWILD:
E4DF 06 0B          	LD	B,11
E4E1 3E 3F          	LD	A,'?'
E4E3                CHKWIL1:
E4E3 BE             	CP	(HL)
E4E4 23             	INC	HL
E4E5 37             	SCF
E4E6 C8             	RET	Z
E4E7 10 FA          	DJNZ	CHKWIL1
E4E9 AF             	XOR	A
E4EA C9             	RET
E4EB                
E4EB                SDIRENT:		;IY=FCB HL=DIR
E4EB D5             	PUSH	DE
E4EC E5             	PUSH	HL
E4ED FD E5          	PUSH	IY
E4EF D1             	POP	DE
E4F0 EB             	EX	DE,HL
E4F1 CD 92 E4       	CALL	SETNAME
E4F4                ;				Attribute
E4F4 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E4F7 12             	LD	(DE),A
E4F8 13             	INC	DE
E4F9                ;				Reserved
E4F9 AF             	XOR	A
E4FA 06 0A          	LD	B,10
E4FC                SDE1:
E4FC 12             	LD	(DE),A
E4FD 13             	INC	DE
E4FE 10 FC          	DJNZ	SDE1
E500                					;(FCB)更新時刻
E500 21 E4 F1       	LD	HL,SDDATA		;(FCB)更新年月日
E503 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
E505                SDLOOP:					;(FCB)ファイルのサイズ(バイト単位)
E505 7E             	LD	A,(HL)
E506 23             	INC	HL
E507 32 0C E5       	LD	(SDPAT),A
E50A FD 7E 00       	LD	A,(IY+0)	;LD A,(IY+A)
E50D 00 00 E5 0C    SDPAT	EQU	$-1
E50D 12             	LD	(DE),A
E50E 13             	INC	DE
E50F 10 F4          	DJNZ	SDLOOP
E511                
E511 AF             	XOR	A
E512 E1             	POP	HL
E513 D1             	POP	DE
E514 C9             	RET
E515                
E515                WOPEN:
E515 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E518 E6 1F          	AND	01FH
E51A 37             	SCF
E51B C0             	RET	NZ
E51C FD 36 1C FE    	LD	(IY+28),0FEH	;(FCB)オープンモード
E520                TOPEN2:
E520 AF             	XOR	A
E521                TOPEN:				;Initializes the time stamp
E521 FD 36 17 FF    	LD	(IY+23),0FFH	;(FCB)更新時刻
E525 C9             	RET
E526                
E526                WRDFX:
E526 3A 9A E3       	LD	A,(SPCPAT)	;1クラスタの論理セクタ
E529                L_WRFX:
E529 1F             	RRA			;->CF
E52A 38 06          	JR	C,E_WRFX
E52C CB 39          	SRL	C
E52E CB 1C          	RR	H		;CH=CH/2
E530 18 F7          	JR	L_WRFX
E532                E_WRFX:
E532 41             	LD	B,C
E533 4C             	LD	C,H
E534 03             	INC	BC
E535 3E 37          	LD	A,037H		;SCF
E537 32 92 E9       	LD	(DRDN1),A
E53A                
E53A                WRDF:				;BCクラスタ分FATを確保する
E53A 11 02 00       	LD	DE,2
E53D AF             	XOR	A
E53E 32 02 EB       	LD	(_SECPS),A
E541                WRDF1:
E541 C5             	PUSH	BC
E542 D5             	PUSH	DE
E543 CD F7 F0       	CALL	_GNCL
E546 38 1C          	JR	C,WRDF3
E548 7A             	LD	A,D		;空いているかチェック
E549 B3             	OR	E
E54A 20 2A          	JR	NZ,WRDF4
E54C E1             	POP	HL		;HL=空いているクラスタ
E54D E5             	PUSH	HL
E54E ED 5B FE F1    	LD	DE,(_CLPS)	;DE=元の(_CLPS)
E552 22 FE F1       	LD	(_CLPS),HL
E555 7A             	LD	A,D		;元の(_CLPS)が 0 か?
E556 B3             	OR	E
E557 20 08          	JR	NZ,WRDF2
E559 FD 75 1A       	LD	(IY+26),L	;(FCB)ファイルの先頭クラスタ
E55C FD 74 1B       	LD	(IY+27),H	;元が空の場合はFCBにクラスタをセットする
E55F 18 03          	JR	WRDF3
E561                WRDF2:
E561 CD FA F0       	CALL	_SNCL
E564                WRDF3:
E564 D1             	POP	DE
E565 C1             	POP	BC
E566 D8             	RET	C
E567 0B             	DEC	BC
E568 78             	LD	A,B
E569 B1             	OR	C
E56A 20 0C          	JR	NZ,WRDF5	;ここでループカウンタチェック
E56C ED 5B FE F1    	LD	DE,(_CLPS)
E570 21 FF FF       	LD	HL,0FFFFH	;FATエントリ終了(EOCマーク)
E573 C3 FA F0       	JP	_SNCL
E576                
E576                WRDF4:				;DEクラスタが空じゃないので次に移動する
E576 D1             	POP	DE
E577 C1             	POP	BC
E578                WRDF5:
E578 13             	INC	DE
E579 CD B3 E3       	CALL	ENDCL
E57C 38 C3          	JR	C,WRDF1
E57E 37             	SCF
E57F C9             	RET
E580                
E580                RWXR:
E580 3A 9F E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E583                L_RWX:
E583 1F             	RRA		;->CF
E584 38 08          	JR	C,E_RWX
E586 CB 38          	SRL	B	;BCH=BCH/2
E588 CB 19          	RR	C	;
E58A CB 1C          	RR	H	;
E58C 18 F5          	JR	L_RWX
E58E                E_RWX:
E58E FD 5E 1A       	LD	E,(IY+26)	;(FCB)ファイルの先頭クラスタ
E591 FD 56 1B       	LD	D,(IY+27)
E594 AF             	XOR	A
E595 32 02 EB       	LD	(_SECPS),A
E598                RWX1:
E598 ED 53 FE F1    	LD	(_CLPS),DE
E59C 7A             	LD	A,D
E59D B3             	OR	E
E59E 28 13          	JR	Z,SCF_RET	;RET DE==0 => CF=1
E5A0                
E5A0 78             	LD	A,B
E5A1 B1             	OR	C
E5A2 B4             	OR	H
E5A3 C8             	RET	Z		;RET BCH==0 => CF=0
E5A4                
E5A4 CD 0A EB       	CALL	GNCLX
E5A7 D8             	RET	C
E5A8 7C             	LD	A,H		;
E5A9 25             	DEC	H		;
E5AA B7             	OR	A		;DEC BCH
E5AB 20 01          	JR	NZ,RWX2		;
E5AD 0B             	DEC	BC		;
E5AE                RWX2:
E5AE CD B3 E3       	CALL	ENDCL
E5B1 38 E5          	JR	C,RWX1
E5B3                SCF_RET:
E5B3 37             	SCF
E5B4 C9             	RET
E5B5                
E5B5                DSKF:
E5B5 11 00 00       	LD	DE,0
E5B8 00 00 E5 B6    MAXCLP	EQU	$-2
E5B8 2A AC F0       	LD	HL,(_FAKEFREE)
E5BB 7C             	LD	A,H
E5BC B5             	OR	L
E5BD 28 03          	JR	Z,DSKF1
E5BF 11 01 00       	LD	DE,1
E5C2                DSKF1:
E5C2 D5             	PUSH	DE
E5C3 CD F7 F0       	CALL	_GNCL
E5C6 38 0C          	JR	C,POPSCF
E5C8 7A             	LD	A,D
E5C9 B3             	OR	E
E5CA 20 01          	JR	NZ,DSKF2
E5CC 23             	INC	HL
E5CD                DSKF2:
E5CD D1             	POP	DE
E5CE 1B             	DEC	DE
E5CF 7A             	LD	A,D
E5D0 B3             	OR	E
E5D1 20 EF          	JR	NZ,DSKF1
E5D3 C9             	RET
E5D4                
E5D4                POPSCF:
E5D4 F1             	POP	AF
E5D5 37             	SCF
E5D6 C9             	RET
E5D7                
E5D7                SETTMS:
E5D7 FD 7E 17       	LD	A,(IY+23)	;(FCB)ファイルを最後に変更した時刻
E5DA 3C             	INC	A
E5DB C0             	RET	NZ		;ファイルが更新されていない
E5DC                SETTMSX:			;FCBに日付時刻をセットする
E5DC CD 8B DC       	CALL	_SYS2C		;(BDOS)時刻の獲得
E5DF                				;H←時  L←分  D←秒
E5DF CB 25          	SLA	L		;   *2
E5E1 CB 25          	SLA	L		;   *4
E5E3 29             	ADD	HL,HL		;*2 *8
E5E4 29             	ADD	HL,HL		;*4 *16
E5E5 29             	ADD	HL,HL		;*8 *32
E5E6 7A             	LD	A,D
E5E7 0F             	RRCA			;bit.0->7->->->0->C
E5E8 E6 1F          	AND	01FH
E5EA B5             	OR	L
E5EB FD 77 16       	LD	(IY+22),A	;(FCB)ファイルを最後に変更した時刻
E5EE FD 74 17       	LD	(IY+23),H
E5F1                
E5F1 CD 68 DC       	CALL	_SYS2A		;(BDOS)日付の獲得
E5F4                				;HL←年  D←月  E←日
E5F4 01 44 F8       	LD	BC,0-1980
E5F7 09             	ADD	HL,BC
E5F8 65             	LD	H,L
E5F9                
E5F9 7A             	LD	A,D
E5FA 87             	ADD	A,A		;*2
E5FB 87             	ADD	A,A		;*4
E5FC 87             	ADD	A,A		;*8
E5FD 87             	ADD	A,A		;*16
E5FE 6F             	LD	L,A
E5FF 29             	ADD	HL,HL		;*32
E600 7D             	LD	A,L
E601 B3             	OR	E
E602 FD 77 14       	LD	(IY+20),A	;(FCB)ファイルを最後に変更した日付
E605 FD 74 15       	LD	(IY+21),H
E608 C9             	RET
E609                
E609                PUSHRR:
E609 32 A1 E6       	LD	(SETSEQ_SWC_RND),A
E60C 22 B3 E6       	LD	(SETSEQ_SWC_SEQ_RR),HL
E60F CD 2F E6       	CALL	GET_RR_AHL
E612 22 0F F0       	LD	(RR_BUF_HL),HL
E615 32 11 F0       	LD	(RR_BUF_A),A
E618 C9             	RET
E619                
E619                GET_CPM_R_SIZE:		;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
E619 87             	ADD	A,A		;in BHLA => out AHL
E61A ED 6A          	ADC	HL,HL
E61C CB 18          	RR	B
E61E B7             	OR	A
E61F 78             	LD	A,B		;ここでフラグは変化しない
E620 C8             	RET	Z
E621 2C             	INC	L		;INC AHL
E622 C0             	RET	NZ		;
E623 24             	INC	H		;
E624 C0             	RET	NZ		;
E625 3C             	INC	A		;
E626 C9             	RET
E627                
E627                INIT_RND:
E627 3E CD          	LD	A,0CDH		;CALL ????
E629 21 76 E6       	LD	HL,POPRR
E62C CD 09 E6       	CALL	PUSHRR
E62F                GET_RR_AHL:
E62F FD 6E 21       	LD	L,(IY+33)	;(FCB)Random record
E632 FD 66 22       	LD	H,(IY+34)	;
E635 FD 7E 23       	LD	A,(IY+35)	;
E638 C9             	RET
E639                SET_RR_AHL:
E639 FD 75 21       	LD	(IY+33),L	;(FCB)Random record
E63C FD 74 22       	LD	(IY+34),H
E63F FD 77 23       	LD	(IY+35),A
E642 C9             	RET
E643                INIT_SEQ:
E643 3E 01          	LD	A,1		;LD BC,????
E645 21 73 E6       	LD	HL,SETSEQ
E648 CD 09 E6       	CALL	PUSHRR
E64B                GETSEQ:
E64B FD 6E 20       	LD	L,(IY+32)	;(FCB)カレントレコード
E64E FD 66 0C       	LD	H,(IY+12)	;(FCB)カレントブロック
E651 AF             	XOR	A
E652                
E652 CB 25          	SLA	L	;L=L*2
E654                
E654 CB 3C          	SRL	H	;HL=HL/2
E656 CB 1D          	RR	L	;
E658 C9             	RET
E659                
E659                SETSEQ1:
E659 F5             	PUSH	AF
E65A E5             	PUSH	HL		;AHL=Random record
E65B CD 2F E6       	CALL	GET_RR_AHL
E65E 47             	LD	B,A		;AHL→HLA
E65F 7D             	LD	A,L		;(IY+33)(FCB)ランダムレコード
E660 6C             	LD	L,H		;(IY+34)
E661 60             	LD	H,B		;(IY+35)
E662 06 00          	LD	B,0
E664                
E664 CD 19 E6       	CALL	GET_CPM_R_SIZE
E667                
E667 29             	ADD	HL,HL
E668 CB 3D          	SRL	L		;L=L/2
E66A FD 75 20       	LD	(IY+32),L	;(FCB)カレントレコード
E66D FD 74 0C       	LD	(IY+12),H	;(FCB)カレントブロック
E670 E1             	POP	HL
E671 F1             	POP	AF
E672 C9             	RET
E673                SETSEQ:
E673 CD 59 E6       	CALL	SETSEQ1
E676                POPRR:
E676 F5             	PUSH	AF
E677 E5             	PUSH	HL
E678 2A 0F F0       	LD	HL,(RR_BUF_HL)
E67B 3A 11 F0       	LD	A,(RR_BUF_A)
E67E CD 39 E6       	CALL	SET_RR_AHL
E681 E1             	POP	HL
E682 F1             	POP	AF
E683 C9             	RET
E684                
E684                RB_WRITE:
E684 C5             	PUSH	BC
E685 ED 4B 4C F1    	LD	BC,(STABLE+2*026H)	;(BDOS)ランダムブロック書き込み
E689 18 05          	JR	RBRW
E68B                RB_READ:
E68B C5             	PUSH	BC
E68C ED 4B 4E F1    	LD	BC,(STABLE+2*027H)	;(BDOS)ランダムブロック読み込み
E690                RBRW:
E690 1F             	RRA		;AHL = AHL*128
E691 7C             	LD	A,H	;AHL = AHL0/2
E692 1F             	RRA		;A
E693 65             	LD	H,L	;
E694 CB 1C          	RR	H	;H
E696 2E 00          	LD	L,0	;
E698 CB 1D          	RR	L	;L
E69A CD 39 E6       	CALL	SET_RR_AHL
E69D 21 80 00       	LD	HL,128
E6A0 C5             	PUSH	BC
E6A1                SETSEQ_SWC_RND:
E6A1 CD 59 E6       	CALL	SETSEQ1
E6A4 C1             	POP	BC
E6A5 FD CB 20 FE    	SET	7,(IY+32)	;(FCB)カレントレコード
E6A9 FD E5          	PUSH	IY
E6AB D1             	POP	DE
E6AC D5             	PUSH	DE
E6AD CD BB E6       	CALL	JP_BC
E6B0 FD E1          	POP	IY
E6B2 CD 73 E6       	CALL	SETSEQ
E6B5 00 00 E6 B3    SETSEQ_SWC_SEQ_RR	EQU $-2
E6B5 FD CB 20 BE    	RES	7,(IY+32)	;(FCB)カレントレコード
E6B9                
E6B9 C1             	POP	BC
E6BA C9             	RET
E6BB                JP_BC:
E6BB C5             	PUSH	BC
E6BC C9             	RET
E6BD                
E6BD 00 00 E2 44    _SYS03	EQU	SCF_FF_RET	;(BDOS)外部入力
E6BD 00 00 E2 44    _SYS2B	EQU	SCF_FF_RET	;(BDOS)日付の設定
E6BD 00 00 E2 44    _SYS2D	EQU	SCF_FF_RET	;(BDOS)時刻の設定
E6BD 00 00 E2 44    _SYS39	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの作成
E6BD 00 00 E2 44    _SYS3A	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの削除
E6BD                
E6BD                	INCLUDE	"LDFILE2.ASM"
E6BD                
E6BD                ;	LSX-Dodgers FILE2
E6BD                
E6BD                				;Write random block
E6BD                _SYS26:		;(BDOS)ランダムブロック書き込み
E6BD AF             	XOR	A
E6BE 32 92 E9       	LD	(DRDN1),A	;NOP
E6C1 22 E2 E8       	LD	(RBSIZE),HL	;HL←書き込むレコード数
E6C4 22 5D F0       	LD	(LEFTX),HL
E6C7 CD 8D E1       	CALL	SETDRV
E6CA                
E6CA CD 3A E8       	CALL	RBX0
E6CD DA 5A E7       	JP	C,RBWERR
E6D0 CD 15 E5       	CALL	WOPEN
E6D3 DA 5A E7       	JP	C,RBWERR
E6D6 7C             	LD	A,H
E6D7 B5             	OR	L
E6D8 CA 53 E7       	JP	Z,RBW1
E6DB                
E6DB 2B             	DEC	HL
E6DC                
E6DC CD F8 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E6DF                
E6DF 19             	ADD	HL,DE		;BCHL=HL+BCDE
E6E0 30 01          	JR	NC,S26X1	;
E6E2 03             	INC	BC		;
E6E3                S26X1:
E6E3 CD 80 E5       	CALL	RWXR
E6E6 DC 26 E5       	CALL	C,WRDFX
E6E9 DA 5A E7       	JP	C,RBWERR
E6EC                
E6EC CD 69 E8       	CALL	RBX2
E6EF 28 1A          	JR	Z,RBWB		;NZ=セクタ以下の端数がある
E6F1 CD 88 E8       	CALL	RBXA
E6F4 38 64          	JR	C,RBWERR
E6F6 EB             	EX	DE,HL
E6F7 C5             	PUSH	BC
E6F8 ED B0          	LDIR
E6FA 22 5F F0       	LD	(DTAX),HL
E6FD                
E6FD CD BA E4       	CALL	SWTDBF		;バッファデータは更新された
E700                
E700 2A 5D F0       	LD	HL,(LEFTX)
E703 D1             	POP	DE
E704 ED 52          	SBC	HL,DE
E706 22 5D F0       	LD	(LEFTX),HL
E709 28 31          	JR	Z,RBWEND
E70B                
E70B                RBWB:
E70B CD BD E8       	CALL	RBXB
E70E 28 14          	JR	Z,RBWC
E710                RBWB1:
E710 C5             	PUSH	BC
E711 D5             	PUSH	DE
E712 CD 96 E3       	CALL	CLUSTX
E715 CD 0C E9       	CALL	DWTC
E718 D1             	POP	DE
E719 C1             	POP	BC
E71A D4 0A EB       	CALL	NC,GNCLX
E71D 38 3B          	JR	C,RBWERR
E71F 10 EF          	DJNZ	RBWB1
E721 CD 5C E9       	CALL	DRW_FLUSH
E724                RBWC:
E724 CD D5 E8       	CALL	RBXC
E727 28 13          	JR	Z,RBWEND
E729 C5             	PUSH	BC
E72A CD 96 E3       	CALL	CLUSTX
E72D CD 91 E9       	CALL	DRDN
E730 C1             	POP	BC
E731 38 27          	JR	C,RBWERR
E733 ED 5B 7E F1    	LD	DE,(_DTBUF)
E737 ED B0          	LDIR
E739 CD BA E4       	CALL	SWTDBF		;バッファデータは更新された
E73C                RBWEND:
E73C CD E1 E8       	CALL	RBXEND
E73F                
E73F CD 49 E8       	CALL	RBX1
E742 30 0F          	JR	NC,RBW1		;ランダムレコードの方が大きい場合はサイズを合わせる
E744 CD F8 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E747 FD 73 10       	LD	(IY+16),E	;ファイルのサイズ(バイト単位)
E74A FD 72 11       	LD	(IY+17),D	;
E74D FD 71 12       	LD	(IY+18),C	;
E750 FD 70 13       	LD	(IY+19),B	;
E753                RBW1:
E753 FD E1          	POP	IY
E755 C1             	POP	BC
E756 D1             	POP	DE
E757 E1             	POP	HL
E758                DD_NUL:
E758 AF             	XOR	A
E759                DRDF0:
E759                DWTF0:
E759 C9             	RET
E75A                
E75A                RBWERR:
E75A FD E5          	PUSH	IY
E75C D1             	POP	DE
E75D 2A 20 F1       	LD	HL,(STABLE+2*010H)
E760 CD 0F 00       	CALL	JP_HL
E763                RBRERR1:
E763 3E 01          	LD	A,001H
E765                RBRERR2:
E765 FD E1          	POP	IY
E767 C1             	POP	BC
E768 D1             	POP	DE
E769 E1             	POP	HL
E76A 37             	SCF
E76B 21 00 00       	LD	HL,0
E76E C9             	RET
E76F                
E76F                RBRERR:
E76F 3E FF          	LD	A,0FFH
E771 18 F2          	JR	RBRERR2
E773                
E773                RBRFL:
E773 3E 00          RBRFLP:	LD	A,000H
E775 FE 0D          	CP	00DH
E777 20 05          	JR	NZ,RBRFL1
E779 D5             	PUSH	DE
E77A 1E 0A          	LD	E,00AH
E77C 18 05          	JR	RBRFL2
E77E                RBRFL1:
E77E D5             	PUSH	DE
E77F CD 09 F0       	CALL	_SYS07
E782 5F             	LD	E,A
E783                RBRFL2:
E783 CD CD F0       	CALL	_PRINT
E786 7B             	LD	A,E
E787 D1             	POP	DE
E788 32 74 E7       	LD	(RBRFLP+1),A
E78B C9             	RET
E78C                DDX:
E78C FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
E78F CD BB E3       	CALL	CAP
E792 FE 41          	CP	'A'
E794 C9             	RET
E795                
E795                				;Read random block
E795                _SYS27:		;(BDOS)ランダムブロック読み込み
E795 22 5D F0       	LD	(LEFTX),HL
E798 CD 8D E1       	CALL	SETDRV
E79B                
E79B FD CB 0D 66    	BIT	4,(IY+13)	;(FCB)属性(アトリビュート)
E79F C2 28 E8       	JP	NZ,RBRDIR	;ディレクトリ
E7A2 CD 3A E8       	CALL	RBX0
E7A5 DA 6F E7       	JP	C,RBRERR
E7A8 CD 49 E8       	CALL	RBX1
E7AB D4 61 E8       	CALL	NC,RBX1R
E7AE DA 63 E7       	JP	C,RBRERR1
E7B1 EB             	EX	DE,HL
E7B2 ED 52          	SBC	HL,DE		;CP 00HL,BCDE
E7B4 19             	ADD	HL,DE
E7B5 79             	LD	A,C
E7B6 DE 00          	SBC	A,0
E7B8 78             	LD	A,B
E7B9 DE 00          	SBC	A,0
E7BB 38 01          	JR	C,RBR1
E7BD EB             	EX	DE,HL
E7BE                RBR1:
E7BE 9F             	SBC	A,A
E7BF E6 01          	AND	1
E7C1 32 26 E8       	LD	(RBRAP+1),A
E7C4                
E7C4 7C             	LD	A,H
E7C5 B5             	OR	L
E7C6 28 57          	JR	Z,RBREND0
E7C8                
E7C8 22 E2 E8       	LD	(RBSIZE),HL	;HL←読み込むレコード数
E7CB 22 5D F0       	LD	(LEFTX),HL
E7CE                
E7CE CD 69 E8       	CALL	RBX2
E7D1 28 19          	JR	Z,RBRB
E7D3 CD 88 E8       	CALL	RBXA
E7D6 DA 6F E7       	JP	C,RBRERR
E7D9 C5             	PUSH	BC
E7DA ED B0          	LDIR
E7DC ED 53 5F F0    	LD	(DTAX),DE
E7E0 2A 5D F0       	LD	HL,(LEFTX)
E7E3 D1             	POP	DE
E7E4 A7             	AND	A
E7E5 ED 52          	SBC	HL,DE
E7E7 22 5D F0       	LD	(LEFTX),HL
E7EA 28 30          	JR	Z,RBREND
E7EC                
E7EC                RBRB:
E7EC CD BD E8       	CALL	RBXB
E7EF 28 15          	JR	Z,RBRC
E7F1                RBRB1:
E7F1 C5             	PUSH	BC
E7F2 D5             	PUSH	DE
E7F3 CD 96 E3       	CALL	CLUSTX
E7F6 CD 12 E9       	CALL	DRDC
E7F9 D1             	POP	DE
E7FA C1             	POP	BC
E7FB D4 0A EB       	CALL	NC,GNCLX
E7FE DA 6F E7       	JP	C,RBRERR
E801 10 EE          	DJNZ	RBRB1
E803 CD 5C E9       	CALL	DRW_FLUSH
E806                RBRC:
E806 CD D5 E8       	CALL	RBXC
E809 28 11          	JR	Z,RBREND
E80B C5             	PUSH	BC
E80C CD 96 E3       	CALL	CLUSTX
E80F CD 75 E9       	CALL	DRDX
E812 C1             	POP	BC
E813 DA 6F E7       	JP	C,RBRERR
E816 EB             	EX	DE,HL
E817 2A 7E F1       	LD	HL,(_DTBUF)
E81A ED B0          	LDIR
E81C                RBREND:
E81C CD E1 E8       	CALL	RBXEND
E81F                RBREND0:
E81F FD E1          	POP	IY
E821 C1             	POP	BC
E822 D1             	POP	DE
E823 F1             	POP	AF	;(HL)
E824 AF             	XOR	A
E825 3E 00          RBRAP:	LD	A,000H
E827 C9             	RET
E828                
E828                RBRDIR:
E828 FD 6E 1A       	LD	L,(IY+26)	;(FCB)ファイルの先頭クラスタ
E82B FD 66 1B       	LD	H,(IY+27)
E82E CD D1 E3       	CALL	CHDIR
E831 AF             	XOR	A
E832 67             	LD	H,A
E833 6F             	LD	L,A
E834 3C             	INC	A
E835 32 26 E8       	LD	(RBRAP+1),A
E838 18 E5          	JR	RBREND0
E83A                
E83A                RBX0:
E83A 2A 8A F0       	LD	HL,(_DTA)
E83D 22 5F F0       	LD	(DTAX),HL
E840 2A 5D F0       	LD	HL,(LEFTX)
E843 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
E846 D6 FD          	SUB	0FDH
E848 C9             	RET
E849                
E849                RBX1:				;ファイルサイズとランダムレコードを比べる
E849 E5             	PUSH	HL		;Record byte
E84A                				;AHL=File size
E84A FD 6E 10       	LD	L,(IY+16)	;ファイルのサイズ(バイト単位)
E84D FD 66 11       	LD	H,(IY+17)	;
E850 FD 7E 12       	LD	A,(IY+18)	;
E853                
E853 CD F8 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E856                
E856 A7             	AND	A
E857 ED 52          	SBC	HL,DE
E859 99             	SBC	A,C
E85A 4F             	LD	C,A
E85B FD 7E 13       	LD	A,(IY+19)	;ファイルのサイズ
E85E 98             	SBC	A,B
E85F D1             	POP	DE
E860 C9             	RET
E861                RBX1R:
E861 47             	LD	B,A
E862 B1             	OR	C
E863 EB             	EX	DE,HL	;BCDE=File byte	HL=Record byte
E864 B2             	OR	D
E865 B3             	OR	E
E866 C0             	RET	NZ
E867 37             	SCF
E868 C9             	RET
E869                
E869                RBX2:				;Cluster settings
E869 FD 66 22       	LD	H,(IY+34)	;(+33)(FCB)ランダムレコード
E86C FD 4E 23       	LD	C,(IY+35)
E86F 06 00          	LD	B,0
E871 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E875 20 03          	JR	NZ,RBX3
E877 FD 46 24       	LD	B,(IY+36)
E87A                RBX3:
E87A CD 80 E5       	CALL	RWXR
E87D 3A 9F E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E880 3D             	DEC	A
E881 FD A6 22       	AND	(IY+34)
E884 FD B6 21       	OR	(IY+33)
E887 C9             	RET
E888                
E888                RBXA:
E888 C5             	PUSH	BC
E889 D5             	PUSH	DE
E88A CD 96 E3       	CALL	CLUSTX
E88D CD 75 E9       	CALL	DRDX
E890 D1             	POP	DE
E891 C1             	POP	BC
E892 D4 0A EB       	CALL	NC,GNCLX
E895 D8             	RET	C
E896 ED 53 FE F1    	LD	(_CLPS),DE
E89A                
E89A FD 4E 21       	LD	C,(IY+33)	;(FCB)ランダムレコード
E89D 21 00 04       SECSZ:	LD	HL,0400H	;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
E8A0 7C             	LD	A,H
E8A1 3D             	DEC	A		;1024=3 / 512=1
E8A2 FD A6 22       	AND	(IY+34)		;(FCB)ランダムレコード
E8A5 47             	LD	B,A		;BCに1セクタ以下の端数が入る
E8A6 ED 42          	SBC	HL,BC		;残りを計算
E8A8                
E8A8 ED 5B 5D F0    	LD	DE,(LEFTX)
E8AC ED 52          	SBC	HL,DE		;CP HL,DE
E8AE 19             	ADD	HL,DE		;
E8AF 38 01          	JR	C,RBXA1		;DEとHLを比較して大きい方をHLに
E8B1 EB             	EX	DE,HL
E8B2                RBXA1:
E8B2 E5             	PUSH	HL
E8B3 2A 7E F1       	LD	HL,(_DTBUF)
E8B6 09             	ADD	HL,BC
E8B7 ED 5B 5F F0    	LD	DE,(DTAX)
E8BB C1             	POP	BC
E8BC C9             	RET
E8BD                
E8BD                RBXB:
E8BD 2A 5F F0       	LD	HL,(DTAX)
E8C0 ED 5B FE F1    	LD	DE,(_CLPS)
E8C4 3A 5E F0       	LD	A,(LEFTX+1)
E8C7 47             	LD	B,A
E8C8 3A 9F E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8CB                RBXB1:
E8CB 1F             	RRA		;->CF
E8CC 38 04          	JR	C,RBXB2
E8CE CB 38          	SRL	B	;B=B/2
E8D0 18 F9          	JR	RBXB1
E8D2                RBXB2:
E8D2 78             	LD	A,B
E8D3 B7             	OR	A
E8D4 C9             	RET
E8D5                
E8D5                RBXC:
E8D5 ED 4B 5D F0    	LD	BC,(LEFTX)
E8D9 3A 9F E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8DC 3D             	DEC	A
E8DD A0             	AND	B
E8DE 47             	LD	B,A		;1セクタ以下の端数がない場合はZ
E8DF B1             	OR	C
E8E0 C9             	RET
E8E1                
E8E1                RBXEND:				;レコード数だけランダムレコードを進める
E8E1 11 00 00       	LD	DE,0		;進めるレコード数(RBSIZE)
E8E4 00 00 E8 E2    RBSIZE	EQU	$-2
E8E4 CD 2F E6       	CALL	GET_RR_AHL
E8E7 19             	ADD	HL,DE
E8E8 CE 00          	ADC	A,0
E8EA CD 39 E6       	CALL	SET_RR_AHL
E8ED EB             	EX	DE,HL		;HL=進めるレコード数
E8EE D0             	RET	NC
E8EF FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E8F3 C0             	RET	NZ
E8F4 FD 34 24       	INC	(IY+36)
E8F7 C9             	RET
E8F8                
E8F8                GET_RR_BCDE:			;BCDE=Random record
E8F8 FD 5E 21       	LD	E,(IY+33)	;(FCB)ランダムレコード
E8FB FD 56 22       	LD	D,(IY+34)
E8FE FD 4E 23       	LD	C,(IY+35)
E901 06 00          	LD	B,0		;CP/M互換のアクセスの場合はFCBは36バイト
E903 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E907 C0             	RET	NZ
E908 FD 46 24       	LD	B,(IY+36)
E90B C9             	RET
E90C                
E90C                ;	ランダムブロックアクセスの連続したセクタをまとめる
E90C                
E90C                DWTC:
E90C E5             	PUSH	HL
E90D 21 9C EC       	LD	HL,DWT24B
E910 18 04          	JR	DWTC1
E912                DRDC:
E912 E5             	PUSH	HL
E913 21 8C EC       	LD	HL,DRD24B
E916                DWTC1:
E916 22 70 E9       	LD	(DRWF_MODE),HL
E919 E1             	POP	HL
E91A 3A 60 E9       	LD	A,(DRWF_B)
E91D B7             	OR	A
E91E 20 0F          	JR	NZ,DRDC1
E920                SAVE_DRWC:
E920 06 01          	LD	B,1
E922 ED 43 5F E9    	LD	(DRWF_C),BC
E926 ED 53 66 E9    	LD	(DRWF_E),DE
E92A 22 69 E9       	LD	(DRWF_HL),HL
E92D 18 20          	JR	INC_HL_DRWC
E92F                DRDC1:
E92F E5             	PUSH	HL
E930 21 66 E9       	LD	HL,DRWF_E
E933 86             	ADD	A,(HL)
E934 F5             	PUSH	AF
E935 BB             	CP	E
E936 20 1D          	JR	NZ,DRDC2
E938 F1             	POP	AF
E939 23             	INC	HL
E93A 7E             	LD	A,(HL)
E93B CE 00          	ADC	A,0
E93D F5             	PUSH	AF
E93E BA             	CP	D
E93F 20 14          	JR	NZ,DRDC2
E941 F1             	POP	AF
E942 3A 5F E9       	LD	A,(DRWF_C)
E945 CE 00          	ADC	A,0
E947 B9             	CP	C
E948 20 0C          	JR	NZ,DRDC3
E94A 21 60 E9       	LD	HL,DRWF_B
E94D 34             	INC	(HL)
E94E E1             	POP	HL
E94F                INC_HL_DRWC:
E94F 3A 9F E8       	LD	A,(SECSZ+2)		;1セクタのサイズの上位1バイト
E952 84             	ADD	A,H
E953 67             	LD	H,A
E954 C9             	RET
E955                DRDC2:
E955 F1             	POP	AF
E956                DRDC3:
E956 CD 5C E9       	CALL	DRW_FLUSH
E959 E1             	POP	HL
E95A 18 C4          	JR	SAVE_DRWC
E95C                
E95C                ;	ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
E95C                DRW_FLUSH:
E95C C5             	PUSH	BC
E95D D5             	PUSH	DE
E95E 01 00 00       	LD	BC,0
E961 00 00 E9 5F    DRWF_C	EQU	$-2
E961 00 00 E9 60    DRWF_B	EQU	$-1
E961 78             	LD	A,B
E962 B7             	OR	A
E963 28 0D          	JR	Z,DRDF1
E965 11 00 00       	LD	DE,0
E968 00 00 E9 66    DRWF_E	EQU	$-2
E968 00 00 E9 67    DRWF_D	EQU	$-1
E968 21 00 00       	LD	HL,0
E96B 00 00 E9 69    DRWF_HL	EQU	$-2
E96B AF             	XOR	A
E96C 32 60 E9       	LD	(DRWF_B),A
E96F CD 8C EC       	CALL	DRD24B
E972 00 00 E9 70    DRWF_MODE	EQU	$-2
E972                DRDF1:
E972 D1             	POP	DE
E973 C1             	POP	BC
E974 C9             	RET
E975                	INCLUDE	"LDDIO.ASM"
E975                
E975                ;	LSX-Dodgers DIO
E975                
E975                DRDX:
E975 CD B3 E9       	CALL	DRDY
E978 C8             	RET	Z
E979 CD 99 E9       	CALL	DRDX1		;データバッファの情報を保存
E97C D8             	RET	C
E97D E5             	PUSH	HL
E97E C5             	PUSH	BC
E97F D5             	PUSH	DE
E980 2A 7E F1       	LD	HL,(_DTBUF)
E983 3A DC E9       	LD	A,(_DBS24)
E986 4F             	LD	C,A
E987 CD 8A EC       	CALL	DRD24
E98A DC AE E9       	CALL	C,DRDNE
E98D                POP_DE_BC_HL_RET:
E98D D1             	POP	DE
E98E C1             	POP	BC
E98F E1             	POP	HL
E990 C9             	RET
E991                
E991                ;	CDE:セクタ番号
E991                DRDN:
E991 AF             	XOR	A
E992 00             DRDN1:	NOP			;自己書き換え NOP / SCF
E993 30 E0          	JR	NC,DRDX
E995                DRDNX:
E995 CD B3 E9       	CALL	DRDY
E998 C8             	RET	Z
E999                DRDX1:
E999 CD C9 E9       	CALL	DWTX
E99C                				;データバッファの読み込んだドライブ・セクタ情報を保存
E99C ED 53 A6 F0    	LD	(_DBSEC),DE
E9A0 79             	LD	A,C
E9A1 32 DC E9       	LD	(_DBS24),A
E9A4                
E9A4 3A 88 F0       	LD	A,(_DRV)
E9A7 32 A5 F0       	LD	(_DBDRV),A
E9AA CD D9 F0       	CALL	_CHGDRV
E9AD D0             	RET	NC
E9AE                DRDNE:
E9AE 9F             	SBC	A,A		;CF=1ならばA=0FFH
E9AF 32 A5 F0       	LD	(_DBDRV),A
E9B2 C9             	RET
E9B3                
E9B3                ;	CDE:セクタ番号
E9B3                DRDY:
E9B3 3A DC E9       	LD	A,(_DBS24)
E9B6 B9             	CP	C
E9B7 C0             	RET	NZ
E9B8                
E9B8 E5             	PUSH	HL
E9B9 3A 88 F0       	LD	A,(_DRV)
E9BC 21 A5 F0       	LD	HL,_DBDRV
E9BF AE             	XOR	(HL)
E9C0 20 05          	JR	NZ,POP_HL_RET
E9C2                
E9C2 2A A6 F0       	LD	HL,(_DBSEC)
E9C5 ED 52          	SBC	HL,DE		;上でXORを使っているのでCF=0のはず
E9C7                POP_HL_RET:
E9C7 E1             	POP	HL
E9C8 C9             	RET
E9C9                
E9C9                DWTX:
E9C9 3A A4 F0       	LD	A,(_WTDBF)
E9CC B7             	OR	A
E9CD C8             	RET	Z
E9CE AF             	XOR	A
E9CF 32 A4 F0       	LD	(_WTDBF),A
E9D2                
E9D2 E5             	PUSH	HL
E9D3 C5             	PUSH	BC
E9D4 D5             	PUSH	DE
E9D5 3A A5 F0       	LD	A,(_DBDRV)
E9D8 CD D9 F0       	CALL	_CHGDRV
E9DB 0E 00          	LD	C,0
E9DD 00 00 E9 DC    _DBS24	EQU	$-1
E9DD ED 5B A6 F0    	LD	DE,(_DBSEC)
E9E1 2A 7E F1       	LD	HL,(_DTBUF)
E9E4 D4 9A EC       	CALL	NC,DWT24
E9E7                POP_DE_BC_HL_RET2:
E9E7 18 A4          	JR	POP_DE_BC_HL_RET
E9E9                
E9E9                RDFATX:
E9E9 E5             	PUSH	HL
E9EA 3A 88 F0       	LD	A,(_DRV)
E9ED 21 AA F0       	LD	HL,_FATDRV
E9F0 AE             	XOR	(HL)
E9F1 28 D4          	JR	Z,POP_HL_RET
E9F3                
E9F3 C5             	PUSH	BC
E9F4 D5             	PUSH	DE
E9F5 DD E5          	PUSH	IX
E9F7 CD 13 EA       	CALL	WTFATX
E9FA 38 13          	JR	C,POP_IX_DE_BC_HL_RET
E9FC                
E9FC AF             	XOR	A
E9FD 32 AB F0       	LD	(_FATIX),A
EA00 3A 88 F0       	LD	A,(_DRV)
EA03 32 AA F0       	LD	(_FATDRV),A
EA06 CD E5 F0       	CALL	_RDFAT
EA09                RDFATE2:
EA09 30 04          	JR	NC,POP_IX_DE_BC_HL_RET
EA0B 9F             	SBC	A,A		;A=0xFF
EA0C 32 AA F0       	LD	(_FATDRV),A
EA0F                POP_IX_DE_BC_HL_RET:
EA0F DD E1          	POP	IX
EA11 18 D4          	JR	POP_DE_BC_HL_RET2
EA13                
EA13                WTFATX:
EA13 3A A2 F0       	LD	A,(_WTFATF)
EA16 B7             	OR	A
EA17 C8             	RET	Z
EA18 E5             	PUSH	HL
EA19 3A AA F0       	LD	A,(_FATDRV)
EA1C 21 A5 F0       	LD	HL,_DBDRV
EA1F AE             	XOR	(HL)
EA20 CC C9 E9       	CALL	Z,DWTX
EA23 38 A2          	JR	C,POP_HL_RET
EA25 C5             	PUSH	BC
EA26 D5             	PUSH	DE
EA27 DD E5          	PUSH	IX
EA29 CD A7 EC       	CALL	WTFAT
EA2C AF             	XOR	A
EA2D 32 A2 F0       	LD	(_WTFATF),A
EA30 18 DD          	JR	POP_IX_DE_BC_HL_RET
EA32                
EA32                NCL1:
EA32 7A             	LD	A,D
EA33 B3             	OR	E
EA34 37             	SCF
EA35 C8             	RET	Z
EA36                
EA36 7A             	LD	A,D
EA37 CB 3F          	SRL	A	;/2
EA39 CB 3F          	SRL	A	;/2
EA3B                
EA3B E5             	PUSH	HL
EA3C 32 5B EA       	LD	(NCLPAT_FATIX),A	;_FATIX
EA3F 2A AA F0       	LD	HL,(_FATDRV)	;L=_FATDRV H=_FATIX
EA42 BC             	CP	H
EA43 3A 88 F0       	LD	A,(_DRV)	;LDではフラグは変化しない
EA46 32 5A EA       	LD	(NCLPAT_FATDRV),A	;_FATDRV
EA49 20 05          	JR	NZ,NCL2		;FATIXが違う
EA4B BD             	CP	L
EA4C 20 02          	JR	NZ,NCL2		;ドライブが違う
EA4E E1             	POP	HL
EA4F C9             	RET
EA50                NCL2:
EA50 C5             	PUSH	BC
EA51 D5             	PUSH	DE
EA52 DD E5          	PUSH	IX
EA54 CD 13 EA       	CALL	WTFATX
EA57 38 B6          	JR	C,POP_IX_DE_BC_HL_RET
EA59 01 00 00       	LD	BC,0		;自己書き換え C=_FATDRV B=_FATIX
EA5C 00 00 EA 5B    NCLPAT_FATIX	EQU	$-1
EA5C 00 00 EA 5A    NCLPAT_FATDRV	EQU	$-2
EA5C ED 43 AA F0    	LD	(_FATDRV),BC
EA60 CD 7C EC       	CALL	RDFATS
EA63 18 A4          	JR	RDFATE2
EA65                
EA65                NCL3:
EA65 CB 9A          	RES	3,D
EA67 CB 92          	RES	2,D
EA69 6B             	LD	L,E
EA6A 62             	LD	H,D
EA6B CB 3C          	SRL	H	;
EA6D CB 1D          	RR	L	;HLA=HLA/2
EA6F 1F             	RRA		;
EA70 F5             	PUSH	AF
EA71 3A AB F0       	LD	A,(_FATIX)
EA74 0F             	RRCA
EA75 30 0B          	JR	NC,NCL3X1
EA77 3A 9F E8       	LD	A,(SECSZ+2)
EA7A FE 04          	CP	4		;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
EA7C 20 04          	JR	NZ,NCL3X1
EA7E 01 00 02       	LD	BC,512
EA81 09             	ADD	HL,BC
EA82                NCL3X1:
EA82 F1             	POP	AF
EA83 ED 4B 7C F1    	LD	BC,(_FATBF)
EA87 19             	ADD	HL,DE
EA88 09             	ADD	HL,BC
EA89 17             	RLA
EA8A C9             	RET
EA8B                
EA8B                GNCL:
EA8B CD 32 EA       	CALL	NCL1		;GET NEXT CLUSTER
EA8E D8             	RET	C
EA8F C5             	PUSH	BC
EA90 E5             	PUSH	HL
EA91 CD 65 EA       	CALL	NCL3
EA94 38 09          	JR	C,GNC1
EA96 5E             	LD	E,(HL)
EA97 23             	INC	HL
EA98 7E             	LD	A,(HL)
EA99 E6 0F          	AND	00FH
EA9B 57             	LD	D,A
EA9C E1             	POP	HL
EA9D C1             	POP	BC
EA9E C9             	RET
EA9F                GNC1:
EA9F 7E             	LD	A,(HL)
EAA0 23             	INC	HL
EAA1 56             	LD	D,(HL)
EAA2 06 04          	LD	B,4
EAA4                GNC1L:
EAA4 CB 3A          	SRL	D	;DA=DA/2
EAA6 1F             	RRA		;
EAA7 10 FB          	DJNZ	GNC1L
EAA9                
EAA9 5F             	LD	E,A
EAAA E1             	POP	HL
EAAB C1             	POP	BC
EAAC A7             	AND	A
EAAD C9             	RET
EAAE                
EAAE                SNCL:
EAAE CD 32 EA       	CALL	NCL1
EAB1 D8             	RET	C
EAB2                ;				SET NEXT CLUSTER
EAB2 E5             	PUSH	HL
EAB3 C5             	PUSH	BC
EAB4 D5             	PUSH	DE
EAB5 E5             	PUSH	HL
EAB6 CD 65 EA       	CALL	NCL3
EAB9 D1             	POP	DE
EABA                ;CF=ODD
EABA 7E             	LD	A,(HL)
EABB 73             	LD	(HL),E
EABC 38 06          	JR	C,SNC1
EABE                ;EVEN
EABE                ;M[0] = E
EABE                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
EABE 23             	INC	HL
EABF ED 67          	RRD		;M={A[3:0],E[3:0]}
EAC1 7A             	LD	A,D
EAC2 18 04          	JR	SNC11
EAC4                SNC1:
EAC4                ;ODD
EAC4                ;HL[0] = (HL[0]&0x0F) | (E<<4)
EAC4                ;HL[1] = DE>>4
EAC4 ED 6F          	RLD		;M={D[3:0],E[7:4]}
EAC6 23             	INC	HL
EAC7 72             	LD	(HL),D	;M={D[3:0],E[7:4]}
EAC8                SNC11:
EAC8 ED 6F          	RLD		;M={M[7:4],D[3:0]}
EACA B7             	OR	A
EACB D1             	POP	DE
EACC C1             	POP	BC
EACD E1             	POP	HL
EACE                FAT_CHANGED:
EACE 3E 01          	LD	A,1
EAD0 32 A2 F0       	LD	(_WTFATF),A
EAD3 C9             	RET
EAD4                
EAD4                N16CL3:
EAD4 C5             	PUSH	BC
EAD5 6B             	LD	L,E
EAD6 7A             	LD	A,D
EAD7 E6 03          	AND	3
EAD9 67             	LD	H,A
EADA 29             	ADD	HL,HL
EADB ED 4B 7C F1    	LD	BC,(_FATBF)
EADF 09             	ADD	HL,BC
EAE0 C1             	POP	BC
EAE1 C9             	RET
EAE2                
EAE2                GNCL16:
EAE2 CD 32 EA       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EAE5 D8             	RET	C
EAE6 E5             	PUSH	HL
EAE7 CD D4 EA       	CALL	N16CL3
EAEA 5E             	LD	E,(HL)
EAEB 23             	INC	HL
EAEC 56             	LD	D,(HL)
EAED E1             	POP	HL
EAEE C9             	RET
EAEF                
EAEF                SNCL16:
EAEF CD 32 EA       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EAF2 D8             	RET	C
EAF3 D5             	PUSH	DE
EAF4 E5             	PUSH	HL
EAF5 CD D4 EA       	CALL	N16CL3
EAF8 D1             	POP	DE		;HL
EAF9 73             	LD	(HL),E
EAFA 23             	INC	HL
EAFB 72             	LD	(HL),D
EAFC 6B             	LD	L,E
EAFD 62             	LD	H,D
EAFE D1             	POP	DE
EAFF 18 CD          	JR	FAT_CHANGED
EB01                
EB01                ;------------------------
EB01                ;次のセクタを探す際に_SECPSの値をチェック
EB01                ;in
EB01                ;	DE : セクタ番号
EB01                ;out
EB01                ;	DE : 次のセクタ番号
EB01                ;note
EB01                ;
EB01                ;------------------------
EB01                NEXTX:
EB01 3E 00          	LD	A,0	;自己書き換え
EB03 00 00 EB 02    _SECPS	EQU	$-1
EB03 3C             	INC	A
EB04 E6 00          	AND	0	;自己書き換え　1クラスタの論理セクタ数-1
EB06 00 00 EB 05    _NCPAT	EQU	$-1
EB06 32 02 EB       	LD	(_SECPS),A
EB09 C9             	RET
EB0A                
EB0A                GNCLX:
EB0A CD 01 EB       	CALL	NEXTX
EB0D C0             	RET	NZ	;1クラスタのセクタ未満の場合は戻る
EB0E C3 F7 F0       	JP	_GNCL	;次のクラスタを探す
EB11                
EB11                RDFAT:
EB11 3E 80          	LD	A,080H
EB13 32 70 F0       	LD	(CHECK),A
EB16                RDFAT1:
EB16 3A 88 F0       	LD	A,(_DRV)
EB19 CD C5 ED       	CALL	CHGDRVR
EB1C D8             	RET	C
EB1D DD 7E 12       	LD	A,(IX+DPB_DEVICE)
EB20 CB 6F          	BIT	5,A
EB22 28 68          	JR	Z,RDFAT0X
EB24 21 70 F0       	LD	HL,CHECK
EB27 A6             	AND	(HL)
EB28 77             	LD	(HL),A
EB29 11 00 00       	LD	DE,0		;BPB
EB2C 2A 7C F1       	LD	HL,(_FATBF)
EB2F CD 88 EC       	CALL	DRD16
EB32 30 24          	JR	NC,GETBPB
EB34 21 70 F0       	LD	HL,CHECK
EB37 CB 06          	RLC	(HL)
EB39 3F             	CCF
EB3A D8             	RET	C
EB3B DD CB 0A 1E    	RR	(IX+DPB_FDMODE)
EB3F 3F             	CCF			;フロッピーディスクのFDモードを切り替える
EB40 DD CB 0A 16    	RL	(IX+DPB_FDMODE)
EB44 3E FF          	LD	A,0FFH
EB46 32 89 F0       	LD	(_DSK),A
EB49 3A 84 F0       	LD	A,(_DRIVE)
EB4C E6 03          	AND	3
EB4E F6 80          	OR	080H
EB50 6F             	LD	L,A
EB51 26 F0          	LD	H,_CYL0/256
EB53 3E FF          	LD	A,0FFH
EB55 77             	LD	(HL),A
EB56 18 BE          	JR	RDFAT1
EB58                GETBPB:
EB58 FD E5          	PUSH	IY
EB5A FD 2A 7C F1    	LD	IY,(_FATBF)	;BPB
EB5E CD F1 F0       	CALL	_BPB2DPB
EB61 FD E1          	POP	IY
EB63 DD 7E 12       	LD	A,(IX+DPB_DEVICE)
EB66 30 21          	JR	NC,GETBPBOK
EB68 E6 0F          	AND	00FH
EB6A FE 07          	CP	7
EB6C 37             	SCF
EB6D C0             	RET	NZ
EB6E DD CB 0A 46    	BIT	0,(IX+DPB_FDMODE)
EB72 21 C0 F1       	LD	HL,M2D
EB75 20 02          	JR	NZ,SETFDMODE
EB77 2E D2          	LD	L,M2HD-STABLE
EB79                SETFDMODE:
EB79 DD E5          	PUSH	IX
EB7B D1             	POP	DE
EB7C ED A0          	LDI
EB7E ED A0          	LDI
EB80 13             	INC	DE
EB81 13             	INC	DE
EB82 13             	INC	DE
EB83 13             	INC	DE
EB84 01 0C 00       	LD	BC,12
EB87 ED B0          	LDIR
EB89                GETBPBOK:
EB89 CD 30 ED       	CALL	CHGDRV2
EB8C                RDFAT0X:
EB8C CD 7C EC       	CALL	RDFATS
EB8F D8             	RET	C
EB90 DD AE 06       	XOR	(IX+DPB_FATID)
EB93 C8             	RET	Z
EB94 DD CB 12 6E    	BIT	5,(IX+DPB_DEVICE)
EB98 C0             	RET	NZ		;BPBを取得している場合はFATIDをチェックしない
EB99 37             	SCF
EB9A C9             	RET
EB9B                
EB9B                POP_HL_SCF_RET:
EB9B E1             	POP	HL
EB9C 37             	SCF
EB9D C9             	RET
EB9E                
EB9E                BPB2DPB:
EB9E FD 7E 0B       	LD	A,(IY+11)	;BPB_BytsPerSec
EBA1 B7             	OR	A
EBA2 37             	SCF
EBA3 C0             	RET	NZ
EBA4                BPBOK:
EBA4 FD 7E 0D       	LD	A,(IY+13)	;BPB_SecPerClus
EBA7 DD 77 07       	LD	(IX+DPB_SECPCL),A
EBAA                
EBAA FD 7E 16       	LD	A,(IY+22)	;BPB_FATSz16
EBAD DD 77 00       	LD	(IX+DPB_FATLN),A
EBB0 FD 7E 17       	LD	A,(IY+23)	;BPB_FATSz16
EBB3 DD 77 01       	LD	(IX+DPB_FATLN+1),A
EBB6                
EBB6 FD 6E 0E       	LD	L,(IY+14)	;BPB_RsvdSecCnt
EBB9 FD 66 0F       	LD	H,(IY+15)
EBBC DD 75 0E       	LD	(IX+DPB_FATPS),L
EBBF FD 5E 16       	LD	E,(IY+22)	;BPB_FATSz16
EBC2 FD 56 17       	LD	D,(IY+23)
EBC5 FD 46 10       	LD	B,(IY+16)	;BPB_NumFATs
EBC8                BPBDP1:				;BPB_FATSz16 * BPB_NumFATs
EBC8 19             	ADD	HL,DE
EBC9 10 FD          	DJNZ	BPBDP1
EBCB                BPBDP2:
EBCB DD 75 10       	LD	(IX+DPB_DIRPS),L
EBCE DD 74 11       	LD	(IX+DPB_DIRPS+1),H
EBD1 E5             	PUSH	HL
EBD2                
EBD2 FD 6E 11       	LD	L,(IY+17)	;BPB_RootEntCnt
EBD5 FD 66 12       	LD	H,(IY+18)
EBD8 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EBDB B7             	OR	A
EBDC 28 BD          	JR	Z,POP_HL_SCF_RET
EBDE 06 06          	LD	B,6
EBE0                BPBBPS1:
EBE0 05             	DEC	B
EBE1 0F             	RRCA
EBE2 30 FC          	JR	NC,BPBBPS1
EBE4                BPBDE1:
EBE4 29             	ADD	HL,HL
EBE5 10 FD          	DJNZ	BPBDE1
EBE7                
EBE7 7C             	LD	A,H
EBE8 DD 77 0B       	LD	(IX+DPB_DIRSCNT),A	;
EBEB                
EBEB D1             	POP	DE		;DPB_DIRPS
EBEC 6C             	LD	L,H
EBED 26 00          	LD	H,0
EBEF 19             	ADD	HL,DE		;MAXDIR
EBF0 E5             	PUSH	HL
EBF1 FD 4E 0D       	LD	C,(IY+13)	;BPB_SecPerClus
EBF4 CB 21          	SLA	C		;*2
EBF6 AF             	XOR	A
EBF7 47             	LD	B,A
EBF8 ED 42          	SBC	HL,BC
EBFA DD 75 14       	LD	(IX+DPB_ADDCL),L
EBFD DD 74 15       	LD	(IX+DPB_ADDCL+1),H
EC00                
EC00 D1             	POP	DE		;DE=DPB_MAXDIR
EC01 FD 6E 13       	LD	L,(IY+19)	;BPB_TotSec16
EC04 FD 66 14       	LD	H,(IY+20)
EC07                
EC07 DD 7E 12       	LD	A,(IX+DPB_DEVICE)
EC0A E6 0F          	AND	00FH
EC0C FE 07          	CP	7		;フロッピー
EC0E 20 19          	JR	NZ,NOT_FD
EC10 E5             	PUSH	HL
EC11 FD 4E 18       	LD	C,(IY+24)	;BPB_SecPerTr
EC14 DD 71 0D       	LD	(IX+DPB_MAXSEC),C
EC17 AF             	XOR	A
EC18 CB 21          	SLA	C		;両面なのでセクタ数を２倍
EC1A 06 10          	LD	B,16
EC1C                DIVSEC:				;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
EC1C 29             	ADD	HL,HL
EC1D 17             	RLA
EC1E B9             	CP	C
EC1F 38 02             	JR	C,DIVSEC1
EC21 91                	SUB	C
EC22 2C             	INC	L
EC23                DIVSEC1:
EC23 10 F7           	DJNZ	DIVSEC
EC25 DD 75 0C       	LD	(IX+DPB_MAXCYL),L
EC28 E1             	POP	HL	;ここまでフロッピー専用
EC29                NOT_FD:
EC29 7C             	LD	A,H
EC2A B5             	OR	L
EC2B 3E 00          	LD	A,0		;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
EC2D 20 10          	JR	NZ,BPB16BIT	;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
EC2F FD 7E 23       	LD	A,(IY+35)	;念のために総セクタ数が24ビットを超える場合はエラーを返す
EC32 B7             	OR	A
EC33 37             	SCF
EC34 C0             	RET	NZ
EC35 FD 6E 20       	LD	L,(IY+32)	;BPB_TotSec32 は AHL の24ビットで扱う
EC38 FD 66 21       	LD	H,(IY+33)	;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので
EC3B FD 7E 22       	LD	A,(IY+34)	;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
EC3E A7             	AND	A		;CF=0
EC3F                BPB16BIT:
EC3F ED 52          	SBC	HL,DE
EC41 DE 00          	SBC	A,0
EC43 FD 46 0D       	LD	B,(IY+13)	;BPB_SecPerClus
EC46                BPBTC1:				;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
EC46 CB 18          	RR	B		;->CY
EC48 38 08          	JR	C,BPBTC2
EC4A CB 3F          	SRL	A
EC4C CB 1C          	RR	H		;AHL=AHL/2
EC4E CB 1D          	RR	L
EC50 18 F4          	JR	BPBTC1
EC52                BPBTC2:
EC52 B7             	OR	A
EC53 37             	SCF
EC54 C0             	RET	NZ		;念のため(クラスタ数が16ビットを超える場合)
EC55 23             	INC	HL
EC56 23             	INC	HL
EC57 DD 75 08       	LD	(IX+DPB_MAXCL),L
EC5A DD 74 09       	LD	(IX+DPB_MAXCL+1),H
EC5D                
EC5D FD 7E 15       	LD	A,(IY+21)	;BPB_Media
EC60 DD 77 06       	LD	(IX+DPB_FATID),A
EC63                
EC63 FD 7E 10       	LD	A,(IY+16)	;BPB_NumFATs
EC66 C6 FE          	ADD	A,0-2		;>2:CF=1
EC68 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EC6B 6F             	LD	L,A
EC6C 30 02          	JR	NC,BPBFAT1
EC6E F6 80          	OR	080H
EC70                BPBFAT1:			;ここではCF=0
EC70 DD 77 0F       	LD	(IX+DPB_BPS),A
EC73 2D             	DEC	L		;以下のセクタサイズに合致しない場合はCF=1でエラーにする
EC74 C8             	RET	Z		;1セクタ256バイト
EC75 2D             	DEC	L
EC76 C8             	RET	Z		;1セクタ512バイト
EC77 2D             	DEC	L
EC78 2D             	DEC	L
EC79 C8             	RET	Z		;1セクタ1024バイト
EC7A 37             	SCF
EC7B C9             	RET
EC7C                
EC7C                RDFATS:
EC7C CD C2 EC       	CALL	FATSETUP
EC7F D8             	RET	C
EC80 CD 8C EC       	CALL	DRD24B
EC83 2A 7C F1       	LD	HL,(_FATBF)
EC86 7E             	LD	A,(HL)
EC87 C9             	RET
EC88                
EC88                DRD16:
EC88 0E 00          	LD	C,0
EC8A                DRD24:
EC8A 06 01          	LD	B,1
EC8C                DRD24B:
EC8C DD E5          	PUSH	IX
EC8E DD 2A A8 F0    	LD	IX,(_DPB)
EC92 CD ED EE       	CALL	FDRD		;自己書き換え（ディスク読み込み）
EC95 00 00 EC 93    DRDPAT	EQU	$-2
EC95                POP_IX_RET:
EC95 DD E1          	POP	IX
EC97 C9             	RET
EC98                
EC98                DWT16:
EC98 0E 00          	LD	C,0
EC9A                DWT24:
EC9A 06 01          	LD	B,1
EC9C                DWT24B:
EC9C DD E5          	PUSH	IX
EC9E DD 2A A8 F0    	LD	IX,(_DPB)
ECA2 CD DF EE       	CALL	FDWT		;自己書き換え（ディスク書き込み）
ECA5 00 00 EC A3    DWTPAT	EQU	$-2
ECA5 18 EE          	JR	POP_IX_RET
ECA7                
ECA7                WTFAT:
ECA7 CD C2 EC       	CALL	FATSETUP
ECAA D4 9C EC       	CALL	NC,DWT24B
ECAD D8             	RET	C
ECAE DD CB 0F 7E    	BIT	7,(IX+DPB_BPS)
ECB2 C8             	RET	Z		;予備FATが無い
ECB3 CD C9 EC       	CALL	FATS2
ECB6 E5             	PUSH	HL		;予備FAT
ECB7 DD 6E 00       	LD	L,(IX+DPB_FATLN)
ECBA DD 66 01       	LD	H,(IX+DPB_FATLN+1)
ECBD 19             	ADD	HL,DE
ECBE EB             	EX	DE,HL
ECBF E1             	POP	HL
ECC0 18 DA          	JR	DWT24B
ECC2                ;------------------------
ECC2                ;FATのセットアップ
ECC2                ;out
ECC2                ;	B  : FATセクタ数
ECC2                ;	DE : FAT先頭セクタ番号
ECC2                ;	HL : FATバッファポインタ
ECC2                ;	CF : 1=ドライブ切り替えエラー
ECC2                ;note
ECC2                ;	FATサイズがFATバッファを超える場合は
ECC2                ;	対象クラスタ領域==(_FATIX)によって
ECC2                ;	FAT12:対象クラスタ1024毎に1.5KBを切り替える
ECC2                ;	FAT16:対象クラスタ1024毎に2KBを切り替える
ECC2                ;------------------------
ECC2                FATSETUP:
ECC2 3A AA F0       	LD	A,(_FATDRV)
ECC5 CD C5 ED       	CALL	CHGDRVR		;ドライブ切り替え
ECC8 D8             	RET	C
ECC9                FATS2:
ECC9 DD 7E 0F       	LD	A,(IX+DPB_BPS)	;512=2 1024=4
ECCC 0F             	RRCA
ECCD CD F6 EC       	CALL	FATSETUP12	;自己書き換え
ECD0 00 00 EC CE    FATSX	EQU	$-2
ECD0 21 00 00       	LD	HL,0
ECD3 4A             	LD	C,D
ECD4 54             	LD	D,H
ECD5 3A AB F0       	LD	A,(_FATIX)	;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
ECD8 47             	LD	B,A
ECD9 04             	INC	B
ECDA DD 7E 00       	LD	A,(IX+DPB_FATLN)
ECDD                FAT_SKP:
ECDD 05             	DEC	B
ECDE 28 05          	JR	Z,FAT1
ECE0 19             	ADD	HL,DE
ECE1 93             	SUB	E
ECE2 30 F9          	JR	NC,FAT_SKP
ECE4 C9             	RET
ECE5                FAT1:
ECE5 EB             	EX	DE,HL
ECE6 B9             	CP	C		;C=FATバッファに読み込めるセクタ数
ECE7 38 01          	JR	C,FAT2
ECE9 79             	LD	A,C
ECEA                FAT2:
ECEA 47             	LD	B,A
ECEB                
ECEB 2A FA F1       	LD	HL,(_FATPS)	;fat sector pos
ECEE 19             	ADD	HL,DE
ECEF EB             	EX	DE,HL
ECF0 2A 7C F1       	LD	HL,(_FATBF)
ECF3 AF             	XOR	A		;CF=0
ECF4 4F             	LD	C,A
ECF5 C9             	RET
ECF6                ;
ECF6                ;	FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
ECF6                ;	FATSETUP* (FAT12/FAT16)
ECF6                ;out
ECF6                ;	D : FATバッファに読み込める最大のセクタ数
ECF6                ;	E : _FATIXで進めるセクタ数
ECF6                FATSETUP12:
ECF6 11 06 06       	LD	DE,0606H	;256
ECF9 D8             	RET	C
ECFA 11 03 03       	LD	DE,0303H	;512
ECFD 0F             	RRCA
ECFE D8             	RET	C
ECFF 11 01 02       	LD	DE,0201H	;1024
ED02 C9             	RET
ED03                
ED03                FATSETUP16:
ED03 11 08 08       	LD	DE,0808H	;256
ED06 D8             	RET	C
ED07 11 04 04       	LD	DE,0404H
ED0A 0F             	RRCA			;512
ED0B D8             	RET	C
ED0C 11 02 02       	LD	DE,0202H	;1024
ED0F C9             	RET
ED10                
ED10                CHGDRV:
ED10 E5             	PUSH	HL
ED11 21 89 F0       	LD	HL,_DSK
ED14 BE             	CP	(HL)
ED15 28 0A          	JR	Z,CHGDRVE
ED17                CHGDRV1:
ED17 DD E5          	PUSH	IX
ED19 CD 23 ED       	CALL	CHGDRV0
ED1C 3A 89 F0       	LD	A,(_DSK)
ED1F DD E1          	POP	IX
ED21                CHGDRVE:
ED21 E1             	POP	HL
ED22 C9             	RET
ED23                
ED23                CHGDRV0:
ED23 6F             	LD	L,A
ED24 CD DC F0       	CALL	_GETDPB
ED27 D8             	RET	C
ED28 DD 22 A8 F0    	LD	(_DPB),IX
ED2C 7D             	LD	A,L
ED2D 32 89 F0       	LD	(_DSK),A
ED30                CHGDRV2:
ED30 C5             	PUSH	BC
ED31 D5             	PUSH	DE
ED32 ED 73 7B ED    	LD	(SPPAT2),SP
ED36 F3             	DI
ED37 DD F9          	LD	SP,IX
ED39                
ED39 E1             	POP	HL		;00:DPB_FATLN
ED3A E1             	POP	HL		;02:DPB_DRD
ED3B 22 93 EC       	LD	(DRDPAT),HL
ED3E                
ED3E E1             	POP	HL
ED3F 22 A3 EC       	LD	(DWTPAT),HL	;04:DPB_DWT
ED42                
ED42 E1             	POP	HL		;L=06:DPB_FATID H=07:DPB_SECPCL
ED43 7C             	LD	A,H
ED44 32 9A E3       	LD	(SPCPAT),A	;1クラスタの論理セクタ数
ED47 3D             	DEC	A
ED48 32 05 EB       	LD	(_NCPAT),A
ED4B                
ED4B E1             	POP	HL		;08:DPB_MAXCL
ED4C 7D             	LD	A,L
ED4D 32 B9 E3       	LD	(CLPAT2),A
ED50 7C             	LD	A,H
ED51 32 B5 E3       	LD	(CLPAT1),A
ED54 2B             	DEC	HL
ED55 22 B6 E5       	LD	(MAXCLP),HL
ED58                
ED58 E1             	POP	HL		;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
ED59 4C             	LD	C,H
ED5A                
ED5A E1             	POP	HL		;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
ED5B                
ED5B E1             	POP	HL		;L=0E:DPB_FATPS H=0F:DPB_BPS
ED5C 7C             	LD	A,H		;DPB_BPS
ED5D E6 07          	AND	7
ED5F 32 9F E8       	LD	(SECSZ+2),A	;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
ED62                				;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
ED62                				;1セクタ1024 2HD/2HDE98
ED62                				;1セクタ256 GRAM/RAMF/CMOS/等
ED62                				;1024	512	256
ED62                				;4	2	1
ED62 87             	ADD	A,A		;8	4	2
ED63 87             	ADD	A,A		;010H	8	4
ED64 87             	ADD	A,A		;020H	010H	8
ED65 32 17 E2       	LD	(SDECPAT),A	;1セクタ辺りのディレクトリエントリ数
ED68                
ED68 26 00          	LD	H,0
ED6A 22 FA F1       	LD	(_FATPS),HL
ED6D                
ED6D E1             	POP	HL		;10:DPB_DIRPS
ED6E 22 FC F1       	LD	(_DIRPS),HL
ED71                
ED71 E1             	POP	HL		;L=12:DPB_DEVICE H=13:DPB_UNITNO
ED72 7C             	LD	A,H
ED73 32 84 F0       	LD	(_DRIVE),A
ED76                
ED76 E1             	POP	HL		;14:DPB_ADDCL
ED77 22 AA E3       	LD	(CLSPAT),HL
ED7A                
ED7A 31 00 00       	LD	SP,0		;元のSPを復元
ED7D 00 00 ED 7B    SPPAT2	EQU	$-2
ED7D FB             	EI
ED7E 2A FC F1       	LD	HL,(_DIRPS)
ED81 06 00          	LD	B,0
ED83 09             	ADD	HL,BC		;C=DPB_DIRSCNT
ED84 22 32 E2       	LD	(MD_PAT),HL
ED87                
ED87 2A B6 E5       	LD	HL,(MAXCLP);
ED8A 11 F6 0F       	LD	DE,4086		;クラスタ数が4086未満:FAT12 4086以上:FAT16
ED8D ED 52          	SBC	HL,DE		;CF=0のはず
ED8F 30 0F          	JR	NC,SETFAT16
ED91 21 8B EA       	LD	HL,GNCL		;FAT12
ED94 11 AE EA       	LD	DE,SNCL
ED97 01 F6 EC       	LD	BC,FATSETUP12
ED9A DD CB 0F AE    	RES	5,(IX+DPB_BPS)	;DPB_BPS(FAT12)
ED9E 18 0D          	JR	EXTRA1
EDA0                SETFAT16:
EDA0 21 E2 EA       	LD	HL,GNCL16	;FAT16
EDA3 11 EF EA       	LD	DE,SNCL16
EDA6 01 03 ED       	LD	BC,FATSETUP16
EDA9 DD CB 0F EE    	SET	5,(IX+DPB_BPS)	;DPB_BPS(FAT16)
EDAD                EXTRA1:
EDAD 22 F8 F0       	LD	(GNCPAT),HL
EDB0 ED 53 FB F0    	LD	(SNCPAT),DE
EDB4 ED 43 CE EC    	LD	(FATSX),BC
EDB8 D1             	POP	DE
EDB9 C1             	POP	BC
EDBA AF             	XOR	A
EDBB C9             	RET
EDBC                
EDBC                GETDPBD:
EDBC DD E3          	EX	(SP),IX
EDBE DD E5          	PUSH	IX
EDC0 3A 88 F0       	LD	A,(_DRV)
EDC3 18 07          	JR	GETDPB1
EDC5                
EDC5                CHGDRVR:
EDC5 CD D9 F0       	CALL	_CHGDRV
EDC8 D8             	RET	C
EDC9 3A 89 F0       	LD	A,(_DSK)
EDCC                GETDPB1:
EDCC C3 DC F0       	JP	_GETDPB
EDCF                
EDCF                GETDPB:
EDCF FE 08          	CP	8
EDD1 3F             	CCF
EDD2 D8             	RET	C
EDD3 0F             	RRCA
EDD4 0F             	RRCA
EDD5 0F             	RRCA
EDD6 DD             	DB	0DDH		;Z80未定義命令
EDD7 6F             	LD	L,A		;LD	IXL,A
EDD8 DD             	DB	0DDH		;Z80未定義命令
EDD9 26 F2          	LD	H,_DEVICE/256	;LD	IXH,_DEVICE/256
EDDB DD 7E 00       	LD	A,(IX+DPB_FATLN)
EDDE A7             	AND	A		;CF=0の為
EDDF DD CB 0F 6E    	BIT	5,(IX+DPB_BPS)
EDE3 C0             	RET	NZ		;FAT16
EDE4 DD CB 12 6E    	BIT	5,(IX+DPB_DEVICE)
EDE8 C0             	RET	NZ		;BPB
EDE9 FE 01          	CP	001H		;A=0 THEN CF=1
EDEB C9             	RET
EDEC                
EDEC                _SYS5F:
EDEC AF             	XOR	A
EDED                FFLUSH:
EDED F5             	PUSH	AF
EDEE CD 13 EA       	CALL	WTFATX
EDF1 AF             	XOR	A
EDF2 32 AB F0       	LD	(_FATIX),A
EDF5 2F             	CPL			;0FFH
EDF6 32 AA F0       	LD	(_FATDRV),A
EDF9 3E             	DB	03EH		;次のPUSH AFをスキップ
EDFA                FFLUSHBUF:
EDFA F5             	PUSH	AF
EDFB CD C9 E9       	CALL	DWTX
EDFE 3E FF          	LD	A,0FFH
EE00 32 39 F0       	LD	(SFILE),A
EE03 32 A5 F0       	LD	(_DBDRV),A
EE06 F1             	POP	AF
EE07 C9             	RET
EE08                
EE08                	INCLUDE	"X1DISK.ASM"
EE08                
EE08                ;	LSX-Dodgers DISK
EE08                ;	X1/turbo/Z
EE08                
EE08                SEEK:
EE08 06 10          	LD	B,16
EE0A DD 4E 0D       	LD	C,(IX+DPB_MAXSEC)
EE0D AF             	XOR	A
EE0E EB             	EX	DE,HL
EE0F                DIV1:
EE0F 29             	ADD	HL,HL
EE10 8F             	ADC	A,A
EE11 B9             	CP	C
EE12 38 02          	JR	C,DIV2
EE14 91             	SUB	C
EE15 2C             	INC	L
EE16                DIV2:
EE16 10 F7          	DJNZ	DIV1
EE18                
EE18 3C             	INC	A	;最小のセクタは１固定
EE19 55             	LD	D,L	;TRACK
EE1A 5F             	LD	E,A	;SECTOR
EE1B CB 3A          	SRL	D	;CYLINDER
EE1D 9F             	SBC	A,A
EE1E E6 10          	AND	010H	;SIDE
EE20 4F             	LD	C,A
EE21                
EE21 3A 84 F0       	LD	A,(_DRIVE)
EE24 FE 04          	CP	4
EE26 3F             	CCF
EE27 D8             	RET	C
EE28 B1             	OR	C
EE29 32 B4 EE       	LD	(MOPAT+1),A	;Motor off data
EE2C 01 FC 0F       	LD	BC,00FFCH
EE2F F6 80          	OR	080H		;Motor on
EE31 ED 79          	OUT	(C),A
EE33                
EE33 CD 77 EE       	CALL	SETMODE
EE36 D8             	RET	C
EE37                
EE37 CD C9 EE       	CALL	DRIVE
EE3A FE FF          	CP	0FFH		;A=0FFH Unknown CYLINDER
EE3C CC A8 EE       	CALL	Z,FDCRES	;Restore
EE3F 0E F9          	LD	C,0F9H
EE41 ED 79          	OUT	(C),A		;Currrent CYLINDER
EE43 92             	SUB	D
EE44 C8             	RET	Z		;No seek
EE45                
EE45 3A 86 F0       	LD	A,(_ISEEK)
EE48 4F             	LD	C,A
EE49                
EE49 DD 7E 0C       	LD	A,(IX+DPB_MAXCYL)
EE4C 3D             	DEC	A
EE4D BA             	CP	D		;Over CYLINDER
EE4E D8             	RET	C
EE4F                
EE4F B9             	CP	C		;for Built-in 2DD
EE50 38 03          	JR	C,SETM2
EE52 78             	LD	A,B		;B=00FH
EE53 DB FE          	IN	A,(0FEH)		;2HD mode for 2DD seek
EE55                SETM2:
EE55 78             	LD	A,B
EE56 DB FD          	IN	A,(0FDH)		;MFM mode
EE58                
EE58 0E FB          	LD	C,0FBH
EE5A ED 51          	OUT	(C),D
EE5C 72             	LD	(HL),D
EE5D 0E 18          	LD	C,018H		;Seek
EE5F                FDCCMD2:
EE5F 3A 85 F0       	LD	A,(_SEEKSP)
EE62 B1             	OR	C
EE63                
EE63                FDCCMD:
EE63 CD BF EE       	CALL	COMSET
EE66                
EE66 3E 80          FDCPAT:	LD	A,080H		;FDC COMMAND(Self-modifying code)
EE68 E6 20          	AND	020H		;Write data Write track
EE6A 3C             	INC	A
EE6B                
EE6B                SST:
EE6B 0E 00          	LD	C,0
EE6D                SST1:
EE6D 0D             	DEC	C		; 4
EE6E 20 FD          	JR	NZ,SST1		;12 * 256 / 4 = About 1ms
EE70 3D             	DEC	A
EE71 20 FA          	JR	NZ,SST1
EE73                
EE73 3C             	INC	A		;A=1
EE74 CD 84 EE       	CALL	READY
EE77                SETMODE:
EE77 DD 4E 0A       	LD	C,(IX+DPB_FDMODE)	;フロッピーディスクのモード
EE7A ED 78          	IN	A,(C)
EE7C                
EE7C 78             	LD	A,B
EE7D DB FD          	IN	A,(0FDH)	;MFM mode
EE7F                
EE7F CD C3 EE       	CALL	DELAY0		;Head select time
EE82 3E 81          	LD	A,081H		;NOT READY,BUSY
EE84                READY:
EE84 E5             	PUSH	HL
EE85 2E 00          	LD	L,0
EE87 67             	LD	H,A
EE88 0E F8          	LD	C,0F8H
EE8A                READY2:
EE8A ED 78          	IN	A,(C)
EE8C A4             	AND	H
EE8D 28 17          	JR	Z,READYE
EE8F 3E 1A          	LD	A,1AH
EE91 DB 01          	IN	A,(01H)
EE93 87             	ADD	A,A
EE94 30 F4          	JR	NC,READY2
EE96                READY3:
EE96 ED 78          	IN	A,(C)
EE98 A4             	AND	H
EE99 28 0B          	JR	Z,READYE
EE9B 3E 1A          	LD	A,1AH
EE9D DB 01          	IN	A,(01H)
EE9F 87             	ADD	A,A
EEA0 38 F4          	JR	C,READY3
EEA2 2D             	DEC	L
EEA3 20 E5          	JR	NZ,READY2
EEA5 37             	SCF
EEA6                READYE:
EEA6 E1             	POP	HL
EEA7 C9             	RET
EEA8                
EEA8                FDCRES:
EEA8 36 00          	LD	(HL),0
EEAA 0E 08          	LD	C,8
EEAC 18 B1          	JR	FDCCMD2
EEAE                
EEAE                FDMOFF:
EEAE F5             	PUSH	AF
EEAF C5             	PUSH	BC
EEB0 01 FC 0F       	LD	BC,00FFCH	;Motor off
EEB3 3E 00          MOPAT:	LD	A,000H		;(Self-rewriting)
EEB5 ED 79          	OUT	(C),A
EEB7 C1             	POP	BC
EEB8 F1             	POP	AF
EEB9 C9             	RET
EEBA                
EEBA                SECSET:
EEBA 01 FA 0F       	LD	BC,00FFAH
EEBD ED 59          	OUT	(C),E
EEBF                COMSET:
EEBF 0E F8          	LD	C,0F8H
EEC1 ED 79          	OUT	(C),A
EEC3                DELAY0:
EEC3 3E 1A          	LD	A,26
EEC5                DELAY:
EEC5 3D             	DEC	A
EEC6 20 FD          	JR	NZ,DELAY
EEC8 C9             	RET
EEC9                
EEC9                DRIVE:
EEC9 2A 84 F0       	LD	HL,(_DRIVE)
EECC 26 F0          	LD	H,_CYL0/256
EECE CB FD          	SET	7,L
EED0 7E             	LD	A,(HL)
EED1 C9             	RET
EED2                
EED2                RNF:
EED2 CD C9 EE       	CALL	DRIVE
EED5 36 FF          	LD	(HL),0FFH
EED7 C9             	RET
EED8                
EED8 02             RETRY:	DB	2
EED9                
EED9                
EED9                ;	FLOPPY DISK DRIVER(DMA)
EED9                
EED9                
EED9                WTTRK:
EED9 06 01          	LD	B,1
EEDB 3E F4          	LD	A,0F4H
EEDD 18 02          	JR	WTTRK1
EEDF                FDWT:
EEDF 3E A0          	LD	A,0A0H
EEE1                WTTRK1:
EEE1 32 67 EE       	LD	(FDCPAT+1),A
EEE4 3E 10          	LD	A,16
EEE6 18 0C          	JR	DISK
EEE8                
EEE8                DISKOK:
EEE8 06 01          FDCNT:	LD	B,1
EEEA 10 0B          	DJNZ	DISK1
EEEC C9             	RET
EEED                
EEED                FDRD:
EEED 3E 80          	LD	A,080H
EEEF 32 67 EE       	LD	(FDCPAT+1),A
EEF2 3E 0E          	LD	A,14
EEF4                
EEF4                DISK:
EEF4 32 0B EF       	LD	(DMAPAT+1),A
EEF7                DISK1:
EEF7 78             	LD	A,B
EEF8 32 E9 EE       	LD	(FDCNT+1),A
EEFB 22 63 EF       	LD	(DMAD+11),HL
EEFE                DISKR:
EEFE 3E 02          	LD	A,2		;Retry count
EF00 32 D8 EE       	LD	(RETRY),A
EF03                DISK2:
EF03 D5             	PUSH	DE
EF04 CD 08 EE       	CALL	SEEK
EF07 38 43          	JR	C,ERRF
EF09 F3             	DI
EF0A                
EF0A 3E 0E          DMAPAT:	LD	A,14		;自己書き換え
EF0C 21 58 EF       	LD	HL,DMAD
EF0F CD AC DF       	CALL	SETDMA
EF12 ED 49          	OUT	(C),C		;OUT 01F87H,087H WR6 イネーブル
EF14 3A 67 EE       	LD	A,(FDCPAT+1)
EF17 C5             	PUSH	BC
EF18 CD BA EE       	CALL	SECSET
EF1B 2A 63 EF       	LD	HL,(DMAHL)
EF1E 23             	INC	HL
EF1F 11 06 BB       	LD	DE,0BB06H	;READ DMA
EF22                
EF22 3E 03          	LD	A,3
EF24 CD 84 EE       	CALL	READY
EF27 ED 78          	IN	A,(C)
EF29                
EF29 C1             	POP	BC
EF2A ED 51          	OUT	(C),D		;読み出しマスク設定
EF2C ED 59          	OUT	(C),E		;バイトカウンタ(LH)
EF2E ED 58          	IN	E,(C)
EF30 ED 50          	IN	D,(C)
EF32 19             	ADD	HL,DE
EF33 D1             	POP	DE
EF34 13             	INC	DE
EF35 FB             	EI
EF36 CD AE EE       	CALL	FDMOFF
EF39 B7             	OR	A
EF3A 28 AC          	JR	Z,DISKOK
EF3C 1B             	DEC	DE
EF3D CB 67          	BIT	4,A
EF3F C4 D2 EE       	CALL	NZ,RNF
EF42                DISKE2:
EF42 21 D8 EE       	LD	HL,RETRY
EF45 35             	DEC	(HL)
EF46 20 BB          	JR	NZ,DISK2
EF48 B7             	OR	A
EF49 28 0A          	JR	Z,ERR
EF4B D5             	PUSH	DE
EF4C                ERRF:
EF4C D1             	POP	DE
EF4D                DELP:
EF4D CD D2 EE       	CALL	RNF
EF50 CD AE EE       	CALL	FDMOFF
EF53 3E FF          	LD	A,0FFH
EF55                ERR:
EF55 BF             	CP	A
EF56 37             	SCF
EF57 C9             	RET
EF58                
EF58                			;X1turbo DISK DMA
EF58 C3             DMAD:	DB	0C3H	;WR6 リセット
EF59 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
EF5A FB 0F          	DW	00FFBH	;ポートA開始アドレス FDC データレジスタ
EF5C FF FF          	DW	0FFFFH	;ブロック長(転送サイズ-1)
EF5E 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
EF5F 10             	DB	010H	;WR2 ポートBインクリメント
EF60 80             	DB	080H	;WR3
EF61 92             	DB	092H	;WR5 WAIT RDY:LOW
EF62 8D             	DB	08DH	;WR4 バイト ポートB開始アドレス(LH)
EF63 00 00          DMAHL:	DW	0	;ポートB開始アドレス
EF65 CF             	DB	0CFH	;WR6 ロード
EF66 01             	DB	001H	;WR0 ポートB←ポートB 転送
EF67 CF             	DB	0CFH	;WR6 ロード
EF68                
EF68                DMAE:
EF68                
EF68 00 00 1D 57    AT_R	EQU	WTTRK-AT_DWT
EF68                AT_TABLE:
EF68                	INCLUDE	"LDCCPWK.ASM"
EF68                
EF68                ;	LSX-Dodgers CCP WORK
EF68                
EF68 00 00 00 3B    PATHX	EQU	59
EF68                PATHD:	DS	PATHX
EFA3 00             PATHE:	DB	0
EFA4                
EFA4                DTA_CCP:
EFA4                	DS	37
EFC9                
EFC9                FCB_BAT:
EFC9                	DS	37
EFEE                
EFEE 20 20 20 3C    DIRMES:	DB	"   <DIR>  $"
EFF2 44 49 52 3E
EFF6 20 20 24
EFF9 20 66 72 65    FREE:	DB	" free $"
EFFD 65 20 24
F000                	INCLUDE	"LDWORK.ASM"
F000                
F000                ;	LSX-Dodgers WORK0
F000                ;
F000                ;	CP/M互換BIOS
F000                ;	BOOT:アドレス下位1バイトが0になるように
F000                AT_WORK:
F000                	DS	WORKAD-AT_WORK
F000                
F000                CPM_BOOT:
F000 C3 00 00       	JP	0
F003                _SYS00:		;(BDOS)プログラム終了
F003                CPM_WBOOT:
F003 C3 09 D3       	JP	WBOOT1
F006                CPM_CONST:
F006 C3 5A DC       	JP	CONSTX
F009                _SYS07:		;(BDOS)コンソール直接入力
F009                CPM_CONIN:
F009 C3 CF DB       	JP	FLGET
F00C                CPM_CONOUT:
F00C C3 9F DE       	JP	CONOUT1
F00F                
F00F                DECBF:				;10進数表示時のバッファ(5バイト)
F00F                	DS	5
F014 00 00 F0 0F    RR_BUF_HL	EQU	DECBF	;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
F014 00 00 F0 11    RR_BUF_A	EQU	DECBF+2	;計3バイト
F014                
F014 00             FDRV:	DB	0
F015                FNAME:	DS	36
F039                SFILE:	DS	33		;DRV FILENAME
F05A                
F05A                	DS	3
F05D                
F05D 00 00          LEFTX:	DW	0
F05F 00 00          DTAX:	DW	0
F061                
F061                ZERO:
F061                BEEPD:
F061 00 8E 01 00    	DB	0,08EH,1,0,00BH,0,00CH,010H
F065 0B 00 0C 10
F069 07 3E 08 10    	DB	007H,03EH,008H,010H,00DH,0,0FFH
F06D 0D 00 FF
F070 00 00 F0 62    RTC_YY	EQU	BEEPD+1
F070 00 00 F0 63    RTC_MW	EQU	BEEPD+2
F070 00 00 F0 64    RTC_DD	EQU	BEEPD+3
F070 00 00 F0 65    RTC_TT	EQU	BEEPD+4
F070 00 00 F0 66    RTC_MM	EQU	BEEPD+5
F070 00 00 F0 67    RTC_SS	EQU	BEEPD+6
F070 00 00 F0 62    ROM_SLT	EQU	BEEPD+1
F070                
F070 00             CHECK:	DB	0
F071                
F071 4F 4B 24       OK:	DB	"OK$"
F074                	DS	5
F079 45 72 72 6F    COMERM:	DB	"Error!$"
F07D 72 21 24
F080                ;	システムワークエリア
F080                ;	_CYL0:アドレス下位1バイトが080Hになるように
F080 FF             _CYL0:	DB	0FFH	;Cylinder
F081 FF             _CYL1:	DB	0FFH	;Cylinder
F082 FF             _CYL2:	DB	0FFH	;Cylinder
F083 FF             _CYL3:	DB	0FFH	;Cylinder
F084 00             _DRIVE:	DB	0	;unit number
F085 00             _SEEKSP:DB	0	;Seek speed
F086 FF             _ISEEK:	DB	0FFH	;
F087 00             _DVSW:	DB	0
F088 00             _DRV:	DB	0
F089 FF             _DSK:	DB	0FFH
F08A 80 00          _DTA:	DW	00080H
F08C 00 00          _CTC:	DW	0
F08E 00 00          _TXADR:	DW	0
F090 00 00          _KEYPS:	DW	0
F092 00 FF          _KEYD:	DW	0FF00H	;キーデータ
F094 C2 10          _KEYSP:	DB	KEYSP_L,KEYSP_H	;オートリピートの速度
F096 07             _COLORF:DB	COLORF	;色
F097 18             _LINE:	DB	LINE
F098                
F098 00 00          _FCB:	DW	0	;SEARCH FILES
F09A 00 00          _FBPS:	DW	0	;    //
F09C 00 00          _FBAD:	DW	0	;    //
F09E 00             _FBCNT:	DB	0	;    //
F09F 00             _FILEN:	DB	0	;    //
F0A0 00             _DIRF:	DB	0	;bit7:ディレクトリ bit0-6:セクタインデックス
F0A1                	DS	1
F0A2 00             _WTFATF:DB	0	;FATバッファの更新フラグ
F0A3                	DS	1
F0A4 00             _WTDBF:	DB	0	;データバッファの更新フラグ
F0A5 FF             _DBDRV:	DB	0FFH	;データバッファにあるデータを読み込んだドライブ
F0A6 00 00          _DBSEC:	DW	0	;データバッファにあるデータを読み込んだセクタ番号
F0A8 00 00          _DPB:	DW	0
F0AA                _FATDRV:
F0AA FF             	DB	0FFH	;FATバッファに読み込んでいるドライブ
F0AB 00             _FATIX:	DB	0	;FATバッファに読み込んでいるインデックス
F0AC                _FAKEFREE:
F0AC 00 00          	DW	0	;偽の残量（FATサイズが大きくなると重くなるのでその対策）
F0AE                
F0AE                	DS	2
F0B0                
F0B0                CRTCD:
F0B0 6F             	DB	06FH
F0B1                _WIDTH:
F0B1 50             	DB	WIDTH
F0B2                TVRAMTOP:
F0B2 59 38          	DB	059H,038H
F0B4 1F 02          	DB	01FH,002H
F0B6                _LINE2:
F0B6 19             	DB	019H
F0B7                WKE4:
F0B7 1C             	DB	01CH
F0B8                WKE6:
F0B8 00             	DB	000H
F0B9                WK40:
F0B9 07             	DB	007H
F0BA                _PAGE_MINUS:
F0BA 80 F8          	DW	0-WIDTH*LINE
F0BC                _WIDTH_MINUS:
F0BC B0 FF          	DW	0-WIDTH
F0BE                WK30:
F0BE 0C             	DB	00CH
F0BF                WK31:
F0BF                WK1FD0:
F0BF 20             	DB	020H
F0C0                
F0C0 5F DB          CTC0:	DW	INTCTCE
F0C2 5F DB          CTC1:	DW	INTCTCE
F0C4 5F DB          CTC2:	DW	INTCTCE
F0C6 5F DB          CTC3:	DW	INTCTCE
F0C8 4B DB          INTVEC:	DW	INT
F0CA                
F0CA                ;	LSX-Dodgers 独自BIOS
F0CA                
F0CA C3 82 E0       _INKEY:	JP	INKEY
F0CD C3 3A DD       _PRINT:	JP	PRINT
F0D0 C3 EA DF       _SCRN:	JP	SCRN
F0D3 C3 14 E0       _POS:	JP	POS
F0D6 C3 68 DE       _LOC:	JP	LOC
F0D9                _CHGDRV:
F0D9 C3 10 ED       	JP	CHGDRV
F0DC                _GETDPB:
F0DC C3 CF ED       	JP	GETDPB
F0DF                _FFLUSH:
F0DF C3 ED ED       	JP	FFLUSH
F0E2                _RDFATX:
F0E2 C3 E9 E9       	JP	RDFATX
F0E5 C3 11 EB       _RDFAT:	JP	RDFAT
F0E8 C3 D9 EE       _WTTRK:	JP	WTTRK
F0EB C3 ED EE       _FDRD:	JP	FDRD
F0EE C3 DF EE       _FDWT:	JP	FDWT
F0F1                _BPB2DPB:
F0F1 C3 9E EB       	JP	BPB2DPB
F0F4                _BREAK:
F0F4 C3 C3 D4       	JP	END_BATCH
F0F7                _GNCL:
F0F7 C3 8B EA       	JP	GNCL		; self-modifying code
F0FA 00 00 F0 F8    GNCPAT	EQU	$-2
F0FA                _SNCL:
F0FA C3 AE EA       	JP	SNCL		; self-modifying code
F0FD 00 00 F0 FB    SNCPAT	EQU	$-2
F0FD C3 7C D3       _COMANL:JP	COMANL
F100                
F100                _WE:
F100                	INCLUDE	"LDCALL.ASM"
F100                
F100                ;	LSX-Dodgers システムコール(BDOS)
F100                ;
F100                ;	LSX-Dodgers SYSTEM CALL
F100                ;	STABLE:アドレス下位1バイトが0になるように
F100                
F100                STABLE:
F100                ;0
F100 03 F0 A2 DB    	DW	_SYS00,_SYS01,_SYS02,_SYS03
F104 AE DB 44 E2
F108 96 D8 96 D8    	DW	_SYS04,_SYS05,_SYS06,_SYS07
F10C B3 DB 09 F0
F110 BB DB 98 D8    	DW	_SYS08,_SYS09,_SYS0A,_SYS0B
F114 26 DC 52 DC
F118 AD D8 B2 D8    	DW	_SYS0C,_SYS0D,_SYS0E,_SYS0F
F11C C1 D8 D2 D8
F120                ;1
F120 26 D9 6D D9    	DW	_SYS10,_SYS11,_SYS12,_SYS13
F124 B6 D9 E7 D9
F128 EF D9 05 DA    	DW	_SYS14,_SYS15,_SYS16,_SYS17
F12C 1A DA 12 DA
F130 61 DA 66 DA    	DW	_SYS18,_SYS19,_SYS1A,_SYS1B
F134 6B DA 71 DA
F138 96 D8 97 DA    	DW	_SYS1C,_SYS1D,_SYS1E,_SYS1F
F13C 96 D8 9B DA
F140                ;2
F140 96 D8 51 DA    	DW	_SYS20,_SYS21,_SYS22,_SYS23
F144 59 DA A2 DA
F148 C8 DA 96 D8    	DW	_SYS24,_ERROR,_SYS26,_SYS27
F14C BD E6 95 E7
F150 59 DA D1 DA    	DW	_SYS28,_SYS29,_SYS2A,_SYS2B
F154 68 DC 44 E2
F158 8B DC 44 E2    	DW	_SYS2C,_SYS2D,_SYS2E,_SYS2F
F15C 96 D8 F2 DA
F160                ;3
F160 EC DA 96 D8    	DW	_SYS30,_ERROR,_ERROR,_ERROR
F164 96 D8 96 D8
F168 96 D8 96 D8    	DW	_ERROR,_ERROR,_ERROR,_ERROR
F16C 96 D8 96 D8
F170 96 D8 44 E2    	DW	_ERROR,_SYS39,_SYS3A,_SYS5A
F174 44 E2 13 DB
F178                ;DOS2
F178 79 D8          	DW	_DOS2
F17A                
F17A                	DS	2
F17C 00 F3          _FATBF:	DW	FATBF
F17E 00 FB          _DTBUF:	DW	DTBUF
F180                
F180                ;	コントロールコードテーブル
F180                ;	CTRLTB:アドレス下位1バイトが080Hになるように
F180                
F180                CTRLTB:
F180 DD DD DD DD    	DW	CTRL00,CTRL00,CTRL02,CTRL03	;  A,B,C
F184 19 DE 5E DF
F188 58 DF 3D DE    	DW	CTRL04,CTRL05,CTRL06,CTRL07	;D,E,F,G
F18C 37 DF C0 DE
F190 E9 DD 0A DE    	DW	CTRL08,CTRL09,CTRL0A,CTRL0B	;H,I,J,K
F194 61 DF 7E DE
F198 34 DF 63 DE    	DW	CTRL0C,CTRL0D,CTRL0E,CTRL00	;L,M,N,O
F19C 76 DF DD DD
F1A0 DD DD DD DD    	DW	CTRL00,CTRL00,CTRL12,CTRL00	;P,Q,R,S
F1A4 76 DE DD DD
F1A8 DD DD DD DD    	DW	CTRL00,CTRL00,CTRL00,CTRL00	;T,U,V,W
F1AC DD DD DD DD
F1B0 DD DD DD DD    	DW	CTRL00,CTRL00,CTRL0C,CTRL1B	;X,Y,Z,ESC
F1B4 34 DF 85 DE
F1B8 04 DE F0 DD    	DW	CTRL1C,CTRL1D,CTRL1E,CTRL1F	;→,←,↑,↓
F1BC F9 DD 61 DF
F1C0                
F1C0 02 00          M2D:	DW	2
F1C2 FD 02          	DB	0FDH,2
F1C4 64 01          	DW	356
F1C6 FF 07 28 09    	DB	0FFH,7,40,9,1,082H
F1CA 01 82
F1CC 05 00 A7 00    	DW	5,0A7H,8
F1D0 08 00
F1D2                
F1D2 02 00          M2HD:	DW	2
F1D4 FE 01          	DB	0FEH,1
F1D6 C7 04          	DW	1223
F1D8 FE 06 4D 08    	DB	0FEH,6,77,8,1,084H
F1DC 01 84
F1DE 05 00 A7 00    	DW	5,0A7H,9
F1E2 09 00
F1E4                
F1E4 16 17          SDDATA:	DB	22,23		;(FCB)ファイルを最後に変更した時刻
F1E6 14 15          	DB	20,21		;(FCB)ファイルを最後に変更した日付
F1E8 1A 1B          	DB	26,27		;(FCB)ファイルの先頭クラスタ
F1EA 10 11 12 13    	DB	16,17,18,19	;(FCB)ファイルのサイズ(バイト単位)
F1EE                SDDATAE:
F1EE                
F1EE                	DS	2
F1F0                _FCB_BAT:
F1F0 C9 EF          	DW	FCB_BAT
F1F2                _PATH:
F1F2 68 EF          	DW	PATHD
F1F4                
F1F4                SCDIR:	DS	2		;+14 +15
F1F6                SFBPS:	DS	2		;FBPS
F1F8                SFNDF:	DS	2		;FILEN DIRF
F1FA                
F1FA 00 00          _FATPS:	DW	0
F1FC 00 00          _DIRPS:	DW	0
F1FE 00 00          _CLPS:	DW	0
F200                
F200                _PE:
F200                	INCLUDE	"X1DPB.ASM"
F200                
F200                ;	LSX-Dodgers DPB
F200                ;	X1/turbo/Z
F200                
F200                _DEVICE:
F200                
F200                ;	A:
F200                
F200 02 00          	DW	2	;DPB_FATLN
F202 EB F0          	DW	_FDRD	;DPB_DRD
F204 EE F0          	DW	_FDWT	;DPB_DWT
F206 FD             	DB	0FDH	;DPB_FATID
F207 02             	DB	2	;DPB_SECPCL
F208 64 01          	DW	356	;DPB_MAXCL
F20A FF             	DB	0FFH	;DPB_FDMODE	0FFH=2D / 0FEH=2HD
F20B 07             	DB	7	;DPB_DIRSCNT
F20C 28             	DB	40	;DPB_MAXCYL
F20D 09             	DB	9	;DPB_MAXSEC	Number of sectors
F20E 01             	DB	1	;DPB_FATPS
F20F 82             	DB	082H	;DPB_BPS
F210 05 00          	DW	5	;DPB_DIRPS
F212 A7             	DB	0A7H	;DPB_DEVICE	Device Number
F213 00             	DB	0	;DPB_UNITNO
F214 08 00          	DW	8	;DPB_ADDCL
F216 00 00          	DW	0	;DPB_16
F218 00 00          	DW	0	;DPB_18
F21A 00 00          	DW	0	;DPB_SDIR
F21C 46 44 44 30    	DB	"FDD0"	;DPB_NAME
F220                
F220                ;	B:
F220                
F220 02 00          	DW	2	;DPB_FATLN
F222 EB F0          	DW	_FDRD	;DPB_DRD
F224 EE F0          	DW	_FDWT	;DPB_DWT
F226 FD             	DB	0FDH	;DPB_FATID
F227 02             	DB	2	;DPB_SECPCL
F228 64 01          	DW	356	;DPB_MAXCL
F22A FF             	DB	0FFH	;DPB_FDMODE	0FFH=2D / 0FEH=2HD
F22B 07             	DB	7	;DPB_DIRSCNT
F22C 28             	DB	40	;DPB_MAXCYL
F22D 09             	DB	9	;DPB_MAXSEC	Number of sectors
F22E 01             	DB	1	;DPB_FATPS
F22F 82             	DB	082H	;DPB_BPS
F230 05 00          	DW	5	;DPB_DIRPS
F232 A7             	DB	0A7H	;DPB_DEVICE	Device Number
F233 01             	DB	1	;DPB_UNITNO
F234 08 00          	DW	8	;DPB_ADDCL
F236 00 00          	DW	0	;DPB_16
F238 00 00          	DW	0	;DPB_18
F23A 00 00          	DW	0	;DPB_SDIR
F23C 46 44 44 31    	DB	"FDD1"	;DPB_NAME
F240                
F240                ;	C:
F240                
F240 02 00          	DW	2	;DPB_FATLN
F242 EB F0          	DW	_FDRD	;DPB_DRD
F244 EE F0          	DW	_FDWT	;DPB_DWT
F246 FD             	DB	0FDH	;DPB_FATID
F247 02             	DB	2	;DPB_SECPCL
F248 64 01          	DW	356	;DPB_MAXCL
F24A FF             	DB	0FFH	;DPB_FDMODE	0FFH=2D / 0FEH=2HD
F24B 07             	DB	7	;DPB_DIRSCNT
F24C 28             	DB	40	;DPB_MAXCYL
F24D 09             	DB	9	;DPB_MAXSEC	Number of sectors
F24E 01             	DB	1	;DPB_FATPS
F24F 82             	DB	082H	;DPB_BPS
F250 05 00          	DW	5	;DPB_DIRPS
F252 A7             	DB	0A7H	;DPB_DEVICE	Device Number
F253 02             	DB	2	;DPB_UNITNO
F254 08 00          	DW	8	;DPB_ADDCL
F256 00 00          	DW	0	;DPB_16
F258 00 00          	DW	0	;DPB_18
F25A 00 00          	DW	0	;DPB_SDIR
F25C 46 44 44 32    	DB	"FDD2"	;DPB_NAME
F260                
F260                ;	D:
F260                
F260 02 00          	DW	2	;DPB_FATLN
F262 EB F0          	DW	_FDRD	;DPB_DRD
F264 EE F0          	DW	_FDWT	;DPB_DWT
F266 FD             	DB	0FDH	;DPB_FATID
F267 02             	DB	2	;DPB_SECPCL
F268 64 01          	DW	356	;DPB_MAXCL
F26A FF             	DB	0FFH	;DPB_FDMODE	0FFH=2D / 0FEH=2HD
F26B 07             	DB	7	;DPB_DIRSCNT
F26C 28             	DB	40	;DPB_MAXCYL
F26D 09             	DB	9	;DPB_MAXSEC	Number of sectors
F26E 01             	DB	1	;DPB_FATPS
F26F 82             	DB	082H	;DPB_BPS
F270 05 00          	DW	5	;DPB_DIRPS
F272 A7             	DB	0A7H	;DPB_DEVICE
F273 03             	DB	3	;DPB_UNITNO
F274 08 00          	DW	8	;DPB_ADDCL
F276 00 00          	DW	0	;DPB_16
F278 00 00          	DW	0	;DPB_18
F27A 00 00          	DW	0	;DPB_SDIR
F27C 46 44 44 33    	DB	"FDD3"	;DPB_NAME
F280                
F280                ;	E:
F280                
F280 00 00          EMMFL:	DW	0	;DPB_FATLN
F282 34 D8          EMMRD:	DW	EDRD	;DPB_DRD
F284 20 D8          EMMWR:	DW	EDWT	;DPB_DWT
F286 FE             	DB	0FEH	;DPB_FATID
F287 02             	DB	2	;DPB_SECPCL
F288 00 00          EMMCL:	DW	0	;DPB_MAXCL
F28A 00             	DB	0	;DPB_FDMODE
F28B 0C             	DB	12	;DPB_DIRSCNT
F28C 00             	DB	0	;DPB_MAXCYL
F28D 00             	DB	0	;DPB_MAXSEC
F28E 02             	DB	2	;DPB_FATPS
F28F 02             	DB	2	;DPB_BPS
F290 0A 00          	DW	10	;DPB_DIRPS
F292 06             	DB	6	;DPB_DEVICE
F293 00             	DB	0	;DPB_UNITNO
F294 12 00          	DW	18	;DPB_ADDCL
F296 00 00          	DW	0	;DPB_16
F298 00 00          	DW	0	;DPB_18
F29A 00 00          	DW	0	;DPB_SDIR
F29C 45 4D 4D 30    	DB	"EMM0"	;DPB_NAME
F2A0                
F2A0                ;	F:
F2A0                
F2A0 00 00          BANKFL:	DW	0	;DPB_FATLN
F2A2 B8 D7          	DW	BDRD	;DPB_DRD
F2A4 B4 D7          	DW	BDWT	;DPB_DWT
F2A6 F9             	DB	0F9H	;DPB_FATID
F2A7 02             	DB	2	;DPB_SECPCL
F2A8 00 00          BANKCL:	DW	0	;DPB_MAXCL
F2AA 00             	DB	0	;DPB_FDMODE
F2AB 08             	DB	8	;DPB_DIRSCNT
F2AC 00             	DB	0	;DPB_MAXCYL
F2AD 01             	DB	1	;DPB_MAXSEC
F2AE 00             	DB	0	;DPB_FATPS
F2AF 02             	DB	2	;DPB_BPS
F2B0 02 00          	DW	2	;DPB_DIRPS
F2B2 0B             BANKDV:	DB	00BH	;DPB_DEVICE
F2B3 00             	DB	0	;DPB_UNITNO
F2B4 06 00          	DW	6	;DPB_ADDCL
F2B6 00 00          	DW	0	;DPB_16
F2B8 00 00          	DW	0	;DPB_18
F2BA 00 00          	DW	0	;DPB_SDIR
F2BC 42 52 41 4D    	DB	"BRAM"	;DPB_NAME
F2C0                
F2C0                ;	G:
F2C0                
F2C0 02 00          	DW	2	;DPB_FATLN
F2C2 75 D7          	DW	GDRD	;DPB_DRD
F2C4 8C D7          	DW	GDWT	;DPB_DWT
F2C6 FA             	DB	0FAH	;DPB_FATID
F2C7 01             	DB	1	;DPB_SECPCL
F2C8 B8 00          	DW	184	;DPB_MAXCL
F2CA 00             	DB	0	;DPB_FDMODE
F2CB 07             	DB	7	;DPB_DIRSCNT
F2CC 00             	DB	0	;DPB_MAXCYL
F2CD 01             	DB	1	;DPB_MAXSEC
F2CE 01             	DB	1	;DPB_FATPS
F2CF 01             	DB	1	;DPB_BPS
F2D0 03 00          	DW	3	;DPB_DIRPS
F2D2 05             	DB	5	;DPB_DEVICE
F2D3 01             	DB	1	;DPB_UNITNO
F2D4 08 00          	DW	8	;DPB_ADDCL
F2D6 00 00          	DW	0	;DPB_16
F2D8 00 00          	DW	0	;DPB_18
F2DA 00 00          	DW	0	;DPB_SDIR
F2DC 47 52 41 4D    	DB	"GRAM"	;DPB_NAME
F2E0                
F2E0                ;	H:
F2E0                	DS	32-8
F2F8 00             	DB	0
F2F9                
F2F9                LAST_ADR:
F2F9                
F2F9                	END
F2F9                
