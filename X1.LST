0000                ;	LSX-Dodgers for X1/turbo/Z
0000                ;	Programmed by
0000                ;	Gaku (Lovers/Tablacus)
0000                
0000                	INCLUDE	"X1DEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                ;	X1/turbo/Z
0000                
0000 00 00 00 00    MAC	EQU	0		;X1
0000 00 00 00 00    DEV EQU 0
0000                
0000 00 00 CC 00    RUN	EQU	0CC00H
0000 00 00 D2 06    BDOS	EQU	0D206H
0000 00 00 F0 00    WORKAD	EQU	0F000H
0000 00 00 F3 00    FATBF	EQU	0F300H
0000 00 00 FB 00    DTBUF	EQU	0FB00H
0000 00 00 FF 00    KEYBF	EQU	0FF00H
0000 00 00 FF 20    KBUF	EQU	0FF20H
0000 00 00 FF CA    EXTSP	EQU	0FFCAH
0000 00 00 FF D9    TRAP38	EQU	0FFD9H
0000 00 00 00 50    WIDTH	EQU	80
0000 00 00 00 18    LINE	EQU	24
0000 00 00 00 07    COLORF	EQU	7
0000 00 00 00 10    KEYSP_H	EQU	16
0000 00 00 00 C2    KEYSP_L	EQU	0C2H
0000 00 00 00 09    COMS	EQU	9
0000                
0000                	INCLUDE	"LDDEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                
0000 00 00 00 01    VER_1   EQU	1
0000 00 00 00 05    VER_2   EQU	5
0000 00 00 00 04    VER_3   EQU	4
0000 00 00 1D 00    MACW	EQU	MAC + 01D00H	;機種フラグとLD判別フラグ
0000 00 00 00 00    MACD	EQU	MAC + DEV * 256	;機種フラグとデバイスフラグ
0000 00 00 01 54    VER	EQU	VER_1 * 256 + VER_2 * 16 + VER_3
0000                
0000 00 00 00 05    SYSTEM	EQU	00005H
0000 00 00 00 0F    JP_HL	EQU	0000FH
0000 00 00 00 5C    FCB1	EQU	0005CH
0000 00 00 00 6C    FCB2	EQU	0006CH
0000 00 00 00 5D    FCB1FN	EQU	FCB1+1
0000 00 00 00 6D    FCB2FN	EQU	FCB2+1
0000 00 00 00 80    DTA1	EQU	00080H
0000                
0000 00 00 FF CA    EXTBIO	EQU	0FFCAH
0000                
0000                
0000                	ORG	RUN-7
CBF9                
CBF9                ;	MSX BINARY HEADER
CBF9 FE             	DB	0FEH
CBFA                ;	MSX BINARY START ADDRESS
CBFA 00 CC          	DW	RUN
CBFC                ;	MSX BINARY END ADDRESS
CBFC F9 F2          	DW	LAST_ADR
CBFE                ;	MSX BINARY EXEC ADDRESS
CBFE 07 CC          	DW	START
CC00                
CC00                	INCLUDE	"X1INIT.ASM"
CC00                
CC00                ;	LSX-Dodgers INIT
CC00                ;	X1/turbo/Z
CC00                
CC00 C3 07 CC       	JP	START
CC03 00 1D          	DW	MACW
CC05 54 01          	DW	VER
CC07                
CC07                START:
CC07 F3             	DI
CC08 ED 5E          	IM	2
CC0A 31 CA FF       	LD	SP,EXTSP
CC0D CD 1B CC       	CALL	INIT		;NZならAUTOEXECを実行
CC10 21 00 00       	LD	HL,0
CC13 E5             	PUSH	HL
CC14 C8             	RET	Z
CC15 11 99 CF       	LD	DE,AUTOD
CC18 C3 FD F0       	JP	_COMANL
CC1B                
CC1B                INIT:
CC1B 3E 1E          	LD	A,01EH
CC1D D3 00          	OUT	(0),A
CC1F                
CC1F 01 00 00       	LD	BC,0
CC22 ED 43 8C F0    	LD	(_CTC),BC
CC26 01 04 0A       	LD	BC,00A04H
CC29 CD 43 CF       	CALL	CHKCTC
CC2C 01 04 07       	LD	BC,00704H
CC2F CD 43 CF       	CALL	CHKCTC
CC32 01 A8 1F       	LD	BC,01FA8H
CC35 CD 43 CF       	CALL	CHKCTC
CC38 01 A0 1F       	LD	BC,01FA0H
CC3B CD 43 CF       	CALL	CHKCTC
CC3E                ;
CC3E                INISIO:
CC3E 01 91 1F       	LD	BC,01F91H	;INIT SIO
CC41 16 01          	LD	D,1
CC43 ED 51          	OUT	(C),D
CC45                
CC45 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CC47 0E 93          	LD	C,093H
CC49 ED 51          	OUT	(C),D
CC4B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CC4D 0E 99          	LD	C,099H		;INIT SIO
CC4F 16 01          	LD	D,1
CC51 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CC53 0E 9B          	LD	C,09BH
CC55 ED 51          	OUT	(C),D
CC57 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CC59                
CC59 0E 80          	LD	C,080H		;INIT DMA
CC5B 21 06 C3       	LD	HL,0C306H
CC5E                INIDMA:
CC5E ED 61          	OUT	(C),H
CC60 2D             	DEC	L
CC61 20 FB          	JR	NZ,INIDMA
CC63                
CC63 3E E4          	LD	A,0E4H
CC65 CD DD DE       	CALL	COMOUT
CC68 AF             	XOR	A
CC69 CD B7 DE       	CALL	OT49SB
CC6C                
CC6C 3E F0          	LD	A,INTVEC/256
CC6E ED 47          	LD	I,A
CC70                
CC70 ED 4B 8C F0    	LD	BC,(_CTC)
CC74 0D             	DEC	C
CC75 0D             	DEC	C
CC76                
CC76 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CC78 3E C0          	LD	A,CTC0
CC7A ED 79          	OUT	(C),A
CC7C                
CC7C 0C             	INC	C
CC7D 3E 47          	LD	A,047H
CC7F ED 79          	OUT	(C),A
CC81 3E 0D          	LD	A,13		;Baudrate 9600-13
CC83 ED 79          	OUT	(C),A
CC85                
CC85 79             	LD	A,C
CC86 D6 10          	SUB	010H
CC88 4F             	LD	C,A
CC89                ;	LD	(SIOAD+1),BC
CC89                ;	LD	(SIOAD0+1),BC
CC89                ;	LD	(SIOAD1+1),BC
CC89                
CC89 21 E9 CF       	LD	HL,SIODATA
CC8C                SINIT1:
CC8C 7E             	LD	A,(HL)
CC8D 23             	INC	HL
CC8E FE FF          	CP	0FFH
CC90 28 04          	JR	Z,SINIT2
CC92 ED 79          	OUT	(C),A
CC94 18 F6          	JR	SINIT1
CC96                SINIT2:
CC96 3E E4          	LD	A,0E4H
CC98 CD DD DE       	CALL	COMOUT
CC9B 3E C8          	LD	A,INTVEC
CC9D CD B7 DE       	CALL	OT49SB
CCA0                ;
CCA0 01 C4 1F       	LD	BC,01FC4H
CCA3 3E 0C          	LD	A,00CH
CCA5 ED 79          	OUT	(C),A
CCA7                
CCA7 0E C0          	LD	C,0C0H
CCA9 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCAB                
CCAB 0C             	INC	C
CCAC 3E 28          	LD	A,40
CCAE ED 79          	OUT	(C),A
CCB0                
CCB0 0C             	INC	C
CCB1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCB3                
CCB3 0C             	INC	C
CCB4 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCB6                
CCB6 0E C5          	LD	C,0C5H
CCB8 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCBA                
CCBA                TEXT:
CCBA 0E B0          	LD	C,0B0H
CCBC 3E 80          	LD	A,080H
CCBE ED 79          	OUT	(C),A
CCC0 16 07          	LD	D,7
CCC2 0E B9          	LD	C,0B9H
CCC4 21 E2 CF       	LD	HL,TEXTDT
CCC7                TEXT1:
CCC7 04             	INC	B
CCC8 ED A3          	OUTI
CCCA 0C             	INC	C
CCCB 15             	DEC	D
CCCC 20 F9          	JR	NZ,TEXT1
CCCE 01 B0 1F       	LD	BC,01FB0H
CCD1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCD3                
CCD3 0E C4          	LD	C,0C4H
CCD5 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCD7                
CCD7 01 01 1A       	LD	BC,01A01H
CCDA ED 78          	IN	A,(C)
CCDC E6 08          	AND	8
CCDE 28 09          	JR	Z,PRN
CCE0 0E 03          	LD	C,003H
CCE2 3E 0F          	LD	A,00FH
CCE4 ED 79          	OUT	(C),A
CCE6 01 04 0A       	LD	BC,00A04H
CCE9                PRN:
CCE9 21 00 00       	LD	HL,0
CCEC 06 5C          	LD	B,05CH
CCEE 3E FF          	LD	A,0FFH		;RST 38H
CCF0 CD 37 E1       	CALL	FILL_MEMORY
CCF3 06 A4          	LD	B,0A4H
CCF5 AF             	XOR	A
CCF6 CD 37 E1       	CALL	FILL_MEMORY
CCF9                
CCF9 3E C3          	LD	A,0C3H		;JP
CCFB 21 03 F0       	LD	HL,CPM_WBOOT
CCFE 32 00 00       	LD	(00000H),A
CD01 22 01 00       	LD	(00001H),HL	;IPL
CD04                
CD04 21 00 1D       	LD	HL,MACW	;3 bit7  DPB Compatible LA(1)
CD07 22 03 00       	LD	(00003H),HL	;  bit6-0 Machine X1(0)
CD0A                ;				;4 LSX-Dodgers(01DH)
CD0A 21 06 D2       	LD	HL,BDOS
CD0D 32 05 00       	LD	(00005H),A
CD10 22 06 00       	LD	(00006H),HL	;BDOS
CD13                
CD13 21 F7 DA       	LD	HL,BIOS
CD16 22 19 00       	LD	(00019H),HL	;BIOS-ROM
CD19                
CD19 21 D9 FF       	LD	HL,TRAP38	;TRAP38
CD1C 32 38 00       	LD	(00038H),A
CD1F 22 39 00       	LD	(00039H),HL	;RST 038H
CD22                
CD22 3E F0          	LD	A,CPM_BOOT/256
CD24 32 0B 00       	LD	(0000BH),A
CD27                
CD27 3E E9          	LD	A,0E9H		;JP (HL)
CD29 32 0F 00       	LD	(0000FH),A
CD2C                
CD2C 3E E6          	LD	A,0E6H
CD2E CD DD DE       	CALL	COMOUT
CD31 CD C2 DE       	CALL	IN49SB
CD34 F5             	PUSH	AF
CD35 CD C2 DE       	CALL	IN49SB
CD38 F1             	POP	AF
CD39 F5             	PUSH	AF
CD3A E6 12          	AND	012H
CD3C 20 05          	JR	NZ,KEYR
CD3E 3E 01          	LD	A,1
CD40 32 96 CE       	LD	(KEYREP+1),A
CD43                KEYR:
CD43 F1             	POP	AF
CD44 E6 03          	AND	3
CD46 28 0E          	JR	Z,NON
CD48                
CD48 01 D0 3F       	LD	BC,03FD0H
CD4B ED 49          	OUT	(C),C
CD4D 3E 37          	LD	A,037H
CD4F D3 D0          	OUT	(0D0H),A
CD51 ED 78          	IN	A,(C)
CD53 B9             	CP	C
CD54 28 65          	JR	Z,TURBO
CD56                NON:
CD56 21 1C D0       	LD	HL,AT_SCR1
CD59 11 67 DF       	LD	DE,SCR1
CD5C 01 94 00       	LD	BC,SCRNE-SCR1	;転送先のサイズ確認用
CD5F 01 85 00       	LD	BC,AT_SCRE-AT_SCR1
CD62 ED B0          	LDIR
CD64                
CD64 21 A1 D0       	LD	HL,AT_DWT
CD67 11 D9 EE       	LD	DE,WTTRK
CD6A 01 8F 00       	LD	BC,DMAE-WTTRK	;転送先のサイズ確認用
CD6D 01 8E 00       	LD	BC,AT_CPUE-AT_DWT
CD70 ED B0          	LDIR
CD72                
CD72 21 2F D1       	LD	HL,AT_EDWT
CD75 11 E4 D7       	LD	DE,EDWT
CD78 01 4B 00       	LD	BC,EMME-EDWT	;転送先のサイズ確認用
CD7B 01 46 00       	LD	BC,AT_EMME-AT_EDWT
CD7E ED B0          	LDIR
CD80                
CD80 21 E2 DF       	LD	HL,AT_WTTRK+AT_RS
CD83 22 E9 F0       	LD	(_WTTRK+1),HL
CD86 21 22 EF       	LD	HL,AT_DRD+AT_R
CD89 22 EC F0       	LD	(_FDRD+1),HL
CD8C 21 D9 EE       	LD	HL,AT_DWT+AT_R
CD8F 22 EF F0       	LD	(_FDWT+1),HL
CD92 21 F8 D7       	LD	HL,AT_EDRD+AT_RE
CD95 22 82 F2       	LD	(EMMRD),HL
CD98 21 E4 D7       	LD	HL,AT_EDWT+AT_RE
CD9B 22 84 F2       	LD	(EMMWR),HL
CD9E 21 E9 DF       	LD	HL,AT_SCRN+AT_RS
CDA1 22 D1 F0       	LD	(_SCRN+1),HL
CDA4                
CDA4 3E 27          	LD	A,027H			;ノンターボはMFM切り替えを行わない
CDA6 32 12 F2       	LD	(DEVICE+012H),A		;Aドライブ
CDA9 32 32 F2       	LD	(DEVICE+012H+32),A	;Bドライブ
CDAC 32 52 F2       	LD	(DEVICE+012H+32*2),A	;Cドライブ
CDAF 32 72 F2       	LD	(DEVICE+012H+32*3),A	;Dドライブ
CDB2                
CDB2 21 00 00       	LD	HL,0
CDB5 22 08 DF       	LD	(X1PAT),HL
CDB8 C3 44 CE       	JP	NOBANK
CDBB                
CDBB                TURBO:
CDBB F3             	DI			;Check BIOS
CDBC 06 1D          	LD	B,01DH
CDBE ED 79          	OUT	(C),A		;BIOS ON
CDC0 3A 51 2F       	LD	A,(02F51H)
CDC3 04             	INC	B		;B=01EH
CDC4 ED 79          	OUT	(C),A		;BIOS OFF
CDC6 FB             	EI
CDC7 FE C9          	CP	0C9H
CDC9 28 02          	JR	Z,BIOSOK
CDCB 18 05          	JR	NOBIOS
CDCD                BIOSOK:
CDCD 3E C3          	LD	A,0C3H		;JP
CDCF 32 18 00       	LD	(00018H),A
CDD2                NOBIOS:
CDD2 3E 1F          	LD	A,01FH		;スタートポート
CDD4 DB F0          	IN	A,(0F0H)
CDD6 0F             	RRCA
CDD7 38 0B          	JR	C,CRT1
CDD9 21 D2 CF       	LD	HL,_C8025H
CDDC 11 B0 F0       	LD	DE,CRTCD
CDDF 01 10 00       	LD	BC,16
CDE2 ED B0          	LDIR
CDE4                CRT1:
CDE4 3E 1F          	LD	A,01FH		;スタートポート
CDE6 DB F0          	IN	A,(0F0H)
CDE8 CB 57          	BIT	2,A
CDEA 28 18          	JR	Z,BANK
CDEC                
CDEC AF             	XOR	A
CDED                TZ1:				;前面スイッチが2HDの場合はMFMモードを2HDにしておく
CDED F5             	PUSH	AF
CDEE CD DC F0       	CALL	_GETDPB
CDF1 DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
CDF4 E6 8F          	AND	08FH
CDF6 FE 87          	CP	087H		;フロッピーでMEM切り替えがON
CDF8 20 04          	JR	NZ,TZ2
CDFA DD CB 0A 86    	RES	0,(IX+0AH)	;(DPB_0A_FDMODE)
CDFE                TZ2:
CDFE F1             	POP	AF
CDFF 3C             	INC	A
CE00 FE 08          	CP	8
CE02 38 E9          	JR	C,TZ1
CE04                
CE04                BANK:
CE04 01 00 0B       	LD	BC,00B00H
CE07 21 00 7F       	LD	HL,07F00H
CE0A F3             	DI
CE0B ED 69          	OUT	(C),L
CE0D 3A 00 00       	LD	A,(0)
CE10 FE EB          	CP	0EBH
CE12 20 05          	JR	NZ,BANK1
CE14 3E 2B          	LD	A,02BH
CE16 32 B2 F2       	LD	(BANKDV),A
CE19                BANK1:
CE19 ED 69          	OUT	(C),L
CE1B 5E             	LD	E,(HL)
CE1C 7B             	LD	A,E
CE1D C6 A5          	ADD	A,0A5H
CE1F 77             	LD	(HL),A
CE20 BE             	CP	(HL)
CE21 73             	LD	(HL),E
CE22 20 05          	JR	NZ,BANK2
CE24 2C             	INC	L
CE25 CB 65          	BIT	4,L
CE27 28 F0          	JR	Z,BANK1
CE29                BANK2:
CE29 3E 10          	LD	A,010H
CE2B ED 79          	OUT	(C),A
CE2D 7D             	LD	A,L
CE2E B7             	OR	A
CE2F 28 13          	JR	Z,NOBANK
CE31 26 00          	LD	H,0
CE33 29             	ADD	HL,HL	;*2
CE34 29             	ADD	HL,HL	;*4
CE35 29             	ADD	HL,HL	;*8
CE36 29             	ADD	HL,HL	;*16
CE37 29             	ADD	HL,HL	;*32
CE38 2B             	DEC	HL	;-1
CE39 2B             	DEC	HL	;-2
CE3A 2B             	DEC	HL	;-3
CE3B 22 A8 F2       	LD	(BANKCL),HL
CE3E CD 89 CF       	CALL	CALC_FATLN
CE41 32 A0 F2       	LD	(BANKFL),A
CE44                NOBANK:
CE44                EMM:
CE44 DD 21 80 F2    	LD	IX,EMMFL
CE48 CD 3A CF       	CALL	EADR0
CE4B ED 78          	IN	A,(C)
CE4D F5             	PUSH	AF
CE4E                
CE4E 11 00 00       	LD	DE,0
CE51                ECHECK1:
CE51 13             	INC	DE
CE52 CD 1E CF       	CALL	EADR2
CE55 ED 60          	IN	H,(C)
CE57 CD 1E CF       	CALL	EADR2
CE5A 7C             	LD	A,H
CE5B C6 E5          	ADD	A,0E5H
CE5D ED 79          	OUT	(C),A
CE5F 3C             	INC	A
CE60 CD 3A CF       	CALL	EADR0
CE63 ED 79          	OUT	(C),A
CE65 3D             	DEC	A
CE66 CD 1E CF       	CALL	EADR2
CE69 ED 68          	IN	L,(C)
CE6B CD 1E CF       	CALL	EADR2
CE6E ED 61          	OUT	(C),H
CE70 BD             	CP	L
CE71 20 04          	JR	NZ,ECHECK2
CE73 CB 5A          	BIT	3,D
CE75 28 DA          	JR	Z,ECHECK1
CE77                ECHECK2:
CE77 CD 3A CF       	CALL	EADR0
CE7A F1             	POP	AF
CE7B ED 79          	OUT	(C),A
CE7D FE EB          	CP	0EBH
CE7F 20 05          	JR	NZ,EMM_BPB
CE81 3E 26          	LD	A,026H
CE83 32 92 F2       	LD	(EMMDV),A
CE86                EMM_BPB:
CE86 21 F7 FF       	LD	HL,0-9
CE89 19             	ADD	HL,DE
CE8A 30 09          	JR	NC,NOEMM
CE8C 22 88 F2       	LD	(EMMCL),HL
CE8F CD 89 CF       	CALL	CALC_FATLN
CE92 32 80 F2       	LD	(EMMFL),A
CE95                NOEMM:
CE95 3E 00          KEYREP:	LD	A,000H
CE97 B7             	OR	A
CE98 28 07          	JR	Z,KEYR1
CE9A 01 00 00       	LD	BC,0
CE9D ED 43 8C F0    	LD	(_CTC),BC
CEA1                KEYR1:
CEA1 CD 6A CF       	CALL	SETCRTC
CEA4 01 30 F8       	LD	BC,0-80*25
CEA7 2A BA F0       	LD	HL,(_PAGE_MINUS)
CEAA ED 43 BA F0    	LD	(_PAGE_MINUS),BC
CEAE 1E 0C          	LD	E,00CH
CEB0 CD CD F0       	CALL	_PRINT
CEB3 22 BA F0       	LD	(_PAGE_MINUS),HL
CEB6                
CEB6 21 A5 CF       	LD	HL,INIMES
CEB9 CD 70 D8       	CALL	MSX
CEBC                
CEBC 3A 87 FF       	LD	A,(0FF87H)
CEBF FE 08          	CP	8
CEC1 30 1E          	JR	NC,INIT0
CEC3 5F             	LD	E,A
CEC4 C6 41          	ADD	A,'A'
CEC6 32 A2 CF       	LD	(AUTODV),A
CEC9 0E 0E          	LD	C,00EH
CECB CD 05 00       	CALL	SYSTEM
CECE 1C             	INC	E
CECF 21 85 F0       	LD	HL,_SEEKSP	;Disk error Ignore
CED2 CB FE          	SET	7,(HL)
CED4 0E 1B          	LD	C,01BH
CED6 CD 05 00       	CALL	SYSTEM
CED9                
CED9 21 85 F0       	LD	HL,_SEEKSP
CEDC CB BE          	RES	7,(HL)
CEDE                
CEDE 3C             	INC	A
CEDF 20 08          	JR	NZ,INIT1
CEE1                INIT0:
CEE1 1E 00          	LD	E,0
CEE3 0E 0E          	LD	C,00EH
CEE5 CD 05 00       	CALL	SYSTEM
CEE8 AF             	XOR	A
CEE9                INIT1:
CEE9 F3             	DI
CEEA 08             	EX	AF,AF'
CEEB 2E FE          	LD	L,0-2		;CALLのスタック分減らす
CEED 39             	ADD	HL,SP
CEEE 11 00 FF       	LD	DE,0FF00H
CEF1 45             	LD	B,L
CEF2 CD D3 D5       	CALL	ZERO_MEMORY_DE
CEF5 21 CA FF       	LD	HL,EXTBIO
CEF8 36 C9          	LD	(HL),0C9H	;RET
CEFA 23             	INC	HL
CEFB 06 0E          	LD	B,TRAP38-EXTBIO-1
CEFD 3E FF          	LD	A,0FFH		;RST 38H
CEFF CD 37 E1       	CALL	FILL_MEMORY
CF02 21 F5 CF       	LD	HL,AT_TRAP38
CF05 11 D9 FF       	LD	DE,TRAP38
CF08 01 27 00       	LD	BC,AT_TRAPE-AT_TRAP38
CF0B ED B0          	LDIR
CF0D 08             	EX	AF,AF'
CF0E B7             	OR	A
CF0F C8             	RET	Z
CF10                
CF10 3E E6          	LD	A,0E6H
CF12 CD DD DE       	CALL	COMOUT
CF15 CD C2 DE       	CALL	IN49SB
CF18 CD C2 DE       	CALL	IN49SB
CF1B FE 1B          	CP	01BH
CF1D C9             	RET
CF1E                
CF1E                EADR2:
CF1E D5             	PUSH	DE
CF1F EB             	EX	DE,HL
CF20 29             	ADD	HL,HL
CF21 29             	ADD	HL,HL
CF22 DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
CF25 DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
CF28 09             	ADD	HL,BC
CF29 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
CF2C 06 0D          	LD	B,00DH
CF2E ED 49          	OUT	(C),C
CF30 0C             	INC	C
CF31 ED 69          	OUT	(C),L
CF33 0C             	INC	C
CF34 ED 61          	OUT	(C),H
CF36 0C             	INC	C
CF37 EB             	EX	DE,HL
CF38 D1             	POP	DE
CF39 C9             	RET
CF3A                
CF3A                EADR0:
CF3A D5             	PUSH	DE
CF3B 11 00 00       	LD	DE,0
CF3E CD 1E CF       	CALL	EADR2
CF41 D1             	POP	DE
CF42 C9             	RET
CF43                
CF43                CHKCTC:
CF43 C5             	PUSH	BC
CF44 11 03 47       	LD	DE,04703H
CF47                INICTC1:
CF47 0C             	INC	C
CF48 ED 51          	OUT	(C),D
CF4A ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CF4C 1D             	DEC	E
CF4D 20 F8          	JR	NZ,INICTC1
CF4F C1             	POP	BC
CF50                
CF50 11 FA 07       	LD	DE,007FAH
CF53 ED 51          	OUT	(C),D
CF55 ED 59          	OUT	(C),E
CF57 ED 78          	IN	A,(C)
CF59 BB             	CP	E
CF5A C0             	RET	NZ
CF5B ED 51          	OUT	(C),D
CF5D ED 51          	OUT	(C),D
CF5F ED 78          	IN	A,(C)
CF61 BA             	CP	D
CF62 C0             	RET	NZ
CF63 0C             	INC	C
CF64 0C             	INC	C
CF65 ED 43 8C F0    	LD	(_CTC),BC
CF69 C9             	RET
CF6A                
CF6A                SETCRTC:
CF6A 21 B0 F0       	LD	HL,CRTCD
CF6D AF             	XOR	A
CF6E                SETCRT1:
CF6E 01 00 18       	LD	BC,01800H
CF71 ED 79          	OUT	(C),A
CF73 0C             	INC	C
CF74 04             	INC	B
CF75 ED A3          	OUTI
CF77 3C             	INC	A
CF78 FE 0C          	CP	12
CF7A 20 F2          	JR	NZ,SETCRT1
CF7C 23             	INC	HL
CF7D 23             	INC	HL
CF7E 01 03 1B       	LD	BC,01A03H+00100H
CF81 ED A3          	OUTI
CF83 01 D0 20       	LD	BC,01FD0H+00100H
CF86 ED A3          	OUTI
CF88 C9             	RET
CF89                
CF89                CALC_FATLN:	;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
CF89 5D             	LD	E,L
CF8A 54             	LD	D,H
CF8B 29             	ADD	HL,HL	;*2
CF8C 19             	ADD	HL,DE	;*3
CF8D CB 3C          	SRL	H	;/2
CF8F CB 1D          	RR	L	;1クラスタ辺り1.5バイト必要
CF91 11 FF 01       	LD	DE,511	;切り上げる
CF94 19             	ADD	HL,DE
CF95 7C             	LD	A,H
CF96 CB 3F          	SRL	A
CF98 C9             	RET
CF99                
CF99 41 55 54 4F    AUTOD:	DB	"AUTOEXEC "
CF9D 45 58 45 43
CFA1 20
CFA2 41 3A 00       AUTODV:	DB	"A:",0
CFA5                
CFA5 4C 53 58 2D    INIMES:	DB	"LSX-Dodgers for X1/turbo version "
CFA9 44 6F 64 67
CFAD 65 72 73 20
CFB1 66 6F 72 20
CFB5 58 31 2F 74
CFB9 75 72 62 6F
CFBD 20 76 65 72
CFC1 73 69 6F 6E
CFC5 20
CFC6 31 2E          	DB	030H + VER_1, '.'
CFC8 35 34          	DB	030H + VER_2 ,030H + VER_3
CFCA                ;	DB	""
CFCA 20 47 61 6B    	DB	' Gaku',0DH,0AH
CFCE 75 0D 0A
CFD1 00             	DB	0
CFD2                
CFD2                _C8025H:
CFD2 6B 50 59 88    	DB	06BH,050H,059H,088H,01BH,001H,019H,01AH
CFD6 1B 01 19 1A
CFDA 00 0F          	DB	000H,00FH
CFDC 80 F8 B0 FF    	DW	0-80*LINE,0-80
CFE0 0C 23          	DB	00CH,023H
CFE2                
CFE2 03 0C 0F 30    TEXTDT:	DB	003H,00CH,00FH,030H,033H,03CH,03FH
CFE6 33 3C 3F
CFE9                
CFE9                SIODATA:
CFE9 18             	DB	018H
CFEA 01 00          	DB	1,0
CFEC 02 00          	DB	2,0
CFEE 03 C1          	DB	3,0C1H
CFF0 04 44          	DB	4,044H
CFF2 05 E8          	DB	5,0E8H
CFF4 FF             	DB	0FFH
CFF5                
CFF5                AT_TRAP38:
CFF5 21 00 00       	LD	HL,0
CFF8 E3             	EX	(SP),HL
CFF9 3E 24          	LD	A,'$'
CFFB CD BE DB       	CALL	MSG_A
CFFE 2B             	DEC	HL
CFFF 7C             	LD	A,H
D000 CD E8 FF       	CALL	PRHX+AT_RT
D003 7D             	LD	A,L
D004                PRHX:
D004 F5             	PUSH	AF
D005 07             	RLCA
D006 07             	RLCA
D007 07             	RLCA
D008 07             	RLCA
D009 CD F1 FF       	CALL	PRHX2+AT_RT
D00C F1             	POP	AF
D00D                PRHX2:
D00D E6 0F          	AND	00FH
D00F FE 0A          	CP	10
D011 3F             	CCF
D012 CE 30          	ADC	A,'0'
D014 27             	DAA
D015 C3 BE DB       	JP	MSG_A
D018                	DS	4
D01C                AT_TRAPE:
D01C                	INCLUDE	"X1CPU.ASM"
D01C                
D01C                ;	LSX-Dodgers CPU
D01C                ;	X1/turbo/Z
D01C                
D01C                ;	ノンターボ用パッチ
D01C                ;	DMAを使って転送している部分をCPUに差し替える
D01C                
D01C                AT_SCR1:
D01C D9             	EXX
D01D C5             	PUSH	BC
D01E ED 4B B1 F0    	LD	BC,(_WIDTH)
D022 06 20          	LD	B,020H
D024 D9             	EXX
D025 C5             	PUSH	BC
D026 01 00 20       	LD	BC,02000H
D029                
D029 67             	LD	H,A
D02A B7             	OR	A
D02B                AT_SCRUP1:
D02B 28 15          	JR	Z,AT_SCRCL
D02D C5             	PUSH	BC
D02E CB E0          	SET	4,B
D030 D9             	EXX
D031 C5             	PUSH	BC
D032 CB E0          	SET	4,B
D034 D9             	EXX
D035 CD 98 DF       	CALL	AT_UPSUB+AT_RS
D038 D9             	EXX
D039 C1             	POP	BC
D03A D9             	EXX
D03B C1             	POP	BC
D03C CD 98 DF       	CALL	AT_UPSUB+AT_RS
D03F 25             	DEC	H
D040 18 E9          	JR	AT_SCRUP1
D042                
D042                AT_SCRCL:
D042 2A B1 F0       	LD	HL,(_WIDTH)
D045 CD 30 DE       	CALL	LINECL
D048 C1             	POP	BC
D049 D9             	EXX
D04A C1             	POP	BC
D04B D9             	EXX
D04C C9             	RET
D04D                
D04D                AT_UPSUB:
D04D 3A B1 F0       	LD	A,(_WIDTH)
D050 6F             	LD	L,A
D051                AT_UPSUB1:
D051 D9             	EXX
D052 ED 78          	IN	A,(C)
D054 03             	INC	BC
D055 D9             	EXX
D056 ED 79          	OUT	(C),A
D058 03             	INC	BC
D059 2D             	DEC	L
D05A 20 F5          	JR	NZ,AT_UPSUB1
D05C C9             	RET
D05D                
D05D                ;	FLOPPY DISK DRIVER(CPU)
D05D                
D05D                DISKC:
D05D 1B             	DEC	DE
D05E CB 5F          	BIT	3,A
D060 C4 D2 EE       	CALL	NZ,RNF
D063                DISKD:
D063 E5             	PUSH	HL
D064 21 D8 EE       	LD	HL,RETRY
D067 35             	DEC	(HL)
D068 E1             	POP	HL
D069 20 0C          	JR	NZ,AT_ERR		;Retry
D06B B7             	OR	A
D06C 28 09          	JR	Z,AT_ERR		;Error
D06E                
D06E                AT_DELP:
D06E CD D2 EE       	CALL	RNF
D071 CD AE EE       	CALL	FDMOFF
D074 3E FF          	LD	A,0FFH
D076                AT_ERRZ:
D076 BF             	CP	A
D077                AT_ERR:
D077 3E FF          	LD	A,0FFH
D079 C9             	RET
D07A                ERRW:
D07A 3E FF          	LD	A,0FFH
D07C BF             	CP	A
D07D 37             	SCF
D07E C3 AE EE       	JP	FDMOFF
D081                
D081                ERRDW:
D081 D1             	POP	DE
D082 CD B9 DF       	CALL	AT_DELP+AT_RS
D085 C2 E7 EE       	JP	NZ,DWT0+AT_R
D088 B7             	OR	A
D089 20 EF          	JR	NZ,ERRW
D08B C9             	RET
D08C                
D08C                ERRDR:
D08C D1             	POP	DE
D08D CD B9 DF       	CALL	AT_DELP+AT_RS
D090 C2 30 EF       	JP	NZ,DRD0+AT_R
D093 B7             	OR	A
D094 20 E4          	JR	NZ,ERRW
D096 C9             	RET
D097                
D097                AT_WTTRK:
D097 06 01          	LD	B,1
D099 3E F4          	LD	A,0F4H
D09B C3 DB EE       	JP	AT_WTTRK1+AT_R
D09E                
D09E                AT_SCRN:
D09E ED 78          	IN	A,(C)
D0A0 C9             	RET
D0A1                AT_SCRE:
D0A1                
D0A1                AT_DWT:
D0A1 3E A0          	LD	A,0A0H
D0A3                AT_WTTRK1:
D0A3 32 76 EE       	LD	(FDCPAT+1),A
D0A6                DWTBL:
D0A6 78             	LD	A,B
D0A7 32 1E EF       	LD	(AT_WTB+1+AT_R),A
D0AA 3E 02          	LD	A,2		;Retry count
D0AC 32 D8 EE       	LD	(RETRY),A
D0AF                
D0AF                DWT0:
D0AF D5             	PUSH	DE
D0B0 E5             	PUSH	HL
D0B1 CD 15 EE       	CALL	SEEK		;Write disk
D0B4 E1             	POP	HL
D0B5 DA CC DF       	JP	C,ERRDW+AT_RS
D0B8 F3             	DI
D0B9 3A 76 EE       	LD	A,(FDCPAT+1)
D0BC CD BA EE       	CALL	SECSET
D0BF 0E FB          	LD	C,0FBH
D0C1                
D0C1                DWT1:
D0C1 56             	LD	D,(HL)
D0C2                DWT2:
D0C2 78             	LD	A,B
D0C3 DB F8          	IN	A,(0F8H)
D0C5 0F             	RRCA
D0C6 30 08          	JR	NC,DWT4
D0C8 0F             	RRCA
D0C9 30 F7          	JR	NC,DWT2
D0CB                DWT3:
D0CB ED 51          	OUT	(C),D
D0CD 23             	INC	HL
D0CE 18 F1          	JR	DWT1
D0D0                
D0D0                DWT4:
D0D0 3D             	DEC	A
D0D1 28 F8          	JR	Z,DWT3
D0D3 3C             	INC	A
D0D4 FB             	EI
D0D5 D1             	POP	DE
D0D6 13             	INC	DE
D0D7 CD AE EE       	CALL	FDMOFF
D0DA 28 09          	JR	Z,DISKOK_WT
D0DC CD A8 DF       	CALL	DISKC+AT_RS
D0DF 20 CE          	JR	NZ,DWT0
D0E1 B7             	OR	A
D0E2 C2 C5 DF       	JP	NZ,ERRW+AT_RS
D0E5                
D0E5                DISKOK_WT:
D0E5 06 01          AT_WTB:	LD	B,1
D0E7 10 BD          	DJNZ	DWTBL
D0E9 C9             	RET
D0EA                
D0EA                AT_DRD:
D0EA 3E 80          	LD	A,080H
D0EC 32 76 EE       	LD	(FDCPAT+1),A
D0EF                DRDBL:
D0EF 78             	LD	A,B
D0F0 32 63 EF       	LD	(AT_RDB+1+AT_R),A
D0F3 3E 02          	LD	A,2		;Retry count
D0F5 32 D8 EE       	LD	(RETRY),A
D0F8                DRD0:
D0F8 D5             	PUSH	DE
D0F9 E5             	PUSH	HL
D0FA CD 15 EE       	CALL	SEEK		;Read disk
D0FD E1             	POP	HL
D0FE DA D7 DF       	JP	C,ERRDR+AT_RS
D101 F3             	DI
D102 3A 76 EE       	LD	A,(FDCPAT+1)
D105 CD BA EE       	CALL	SECSET
D108 0E FB          	LD	C,0FBH
D10A                DRD1:
D10A 78             	LD	A,B
D10B DB F8          	IN	A,(0F8H)
D10D 0F             	RRCA
D10E 30 08          	JR	NC,DRD3
D110 0F             	RRCA
D111 30 F7          	JR	NC,DRD1
D113 ED A2          	INI
D115 04             	INC	B
D116 18 F2          	JR	DRD1
D118                
D118                DRD3:
D118 B7             	OR	A
D119 FB             	EI
D11A D1             	POP	DE
D11B 13             	INC	DE
D11C CD AE EE       	CALL	FDMOFF
D11F 28 09          	JR	Z,DISKOK_RD
D121 CD A8 DF       	CALL	DISKC+AT_RS
D124 20 D2          	JR	NZ,DRD0
D126 B7             	OR	A
D127 C2 C5 DF       	JP	NZ,ERRW+AT_RS
D12A                
D12A                DISKOK_RD:
D12A 06 01          AT_RDB:	LD	B,1
D12C 10 C1          	DJNZ	DRDBL
D12E C9             	RET
D12F                
D12F                AT_CPUE:
D12F                
D12F                
D12F                ;	EMM DRIVER(CPU)
D12F                
D12F                
D12F                AT_EDWT:
D12F CD 0C D8       	CALL	AT_EADR+AT_RE
D132                AT_EDWT0:
D132 F5             	PUSH	AF
D133 AF             	XOR	A
D134                AT_EDWT1:
D134 04             	INC	B
D135 ED A3          	OUTI
D137 04             	INC	B
D138 ED A3          	OUTI
D13A 3D             	DEC	A
D13B 20 F7          	JR	NZ,AT_EDWT1
D13D 13             	INC	DE
D13E F1             	POP	AF
D13F 3D             	DEC	A
D140 20 F0          	JR	NZ,AT_EDWT0
D142 C9             	RET
D143                
D143                AT_EDRD:
D143 CD 0C D8       	CALL	AT_EADR+AT_RE
D146                AT_EDRD0:
D146 F5             	PUSH	AF
D147 AF             	XOR	A
D148                AT_EDRD1:
D148 ED A2          	INI
D14A 04             	INC	B
D14B ED A2          	INI
D14D 04             	INC	B
D14E 3D             	DEC	A
D14F 20 F7          	JR	NZ,AT_EDRD1
D151 13             	INC	DE
D152 F1             	POP	AF
D153 3D             	DEC	A
D154 20 F0          	JR	NZ,AT_EDRD0
D156 C9             	RET
D157                
D157                AT_EADR:
D157 C5             	PUSH	BC
D158 D5             	PUSH	DE
D159 EB             	EX	DE,HL
D15A 29             	ADD	HL,HL
D15B DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
D15E DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
D161 09             	ADD	HL,BC
D162 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
D165 06 0D          	LD	B,00DH
D167 ED 49          	OUT	(C),C
D169 0C             	INC	C
D16A ED 69          	OUT	(C),L
D16C 0C             	INC	C
D16D ED 61          	OUT	(C),H
D16F 0C             	INC	C
D170 EB             	EX	DE,HL
D171 D1             	POP	DE
D172 F1             	POP	AF
D173 A7             	AND	A	;CF=0
D174 C9             	RET
D175                AT_EMME:
D175                
D175 00 00 2F E4    AT_RT	EQU	TRAP38-AT_TRAP38
D175                
D175                INITE:
D175                	DS	BDOS-INITE
D206 C3 2F D8       	JP	BDOS0
D209                	INCLUDE	"X1CCP.ASM"
D209                
D209                ;	LSX-Dodgers CCP
D209                ;	X1/turbo/Z
D209                
D209                WBOOT1:
D209 F3             	DI
D20A ED 7B 06 00    	LD	SP,(SYSTEM+1)
D20E                
D20E 3E F0          	LD	A,INTVEC/256
D210 ED 47          	LD	I,A
D212                
D212 3E E4          	LD	A,0E4H
D214 CD DD DE       	CALL	COMOUT
D217 3E C8          	LD	A,INTVEC
D219 CD B7 DE       	CALL	OT49SB
D21C                
D21C 21 B0 F0       	LD	HL,CRTCD
D21F AF             	XOR	A
D220                SETCRT2:
D220 01 00 18       	LD	BC,01800H
D223 ED 79          	OUT	(C),A
D225 0C             	INC	C
D226 56             	LD	D,(HL)
D227 FE 0D          	CP	13
D229 38 02          	JR	C,SETCRT3
D22B 16 00          	LD	D,0
D22D                SETCRT3:
D22D ED 51          	OUT	(C),D
D22F 23             	INC	HL
D230 3C             	INC	A
D231 FE 0E          	CP	14
D233 20 EB          	JR	NZ,SETCRT2
D235                
D235 01 03 1B       	LD	BC,01A03H+00100H
D238 ED A3          	OUTI
D23A 01 D0 20       	LD	BC,01FD0H+00100H
D23D ED A3          	OUTI
D23F 21 92 F0       	LD	HL,_KEYD
D242 7E             	LD	A,(HL)
D243 36 00          	LD	(HL),0
D245 CD AB DB       	CALL	KEYBC_IFBREAK
D248 3E 04          	LD	A,4
D24A CD BE DB       	CALL	MSG_A
D24D                	INCLUDE	"LDCCP.ASM"
D24D                
D24D                ;	LSX-Dodgers CCP
D24D                
D24D                COMMAND:
D24D 3A CE EF       	LD	A,(FCB_BAT)
D250 B7             	OR	A
D251 C2 92 D3       	JP	NZ,C_BAT1
D254 CD 07 D3       	CALL	SETDTA1
D257 3A 87 F0       	LD	A,(_DVSW)
D25A C6 41          	ADD	A,'A'
D25C CD BE DB       	CALL	MSG_A
D25F 3E 3E          	LD	A,'>'
D261 CD BE DB       	CALL	MSG_A
D264 3E 50          	LD	A,80
D266 12             	LD	(DE),A
D267 CD 0D DC       	CALL	_SYS0A		;(BDOS)文字列入力
D26A CD 95 D4       	CALL	LTNL
D26D                COMMAND2:
D26D 11 82 00       	LD	DE,DTA1+2
D270 CD FD F0       	CALL	_COMANL
D273 30 D8          	JR	NC,COMMAND
D275 11 79 F0       	LD	DE,COMERM
D278 CD 61 D8       	CALL	_SYS09		;(BDOS)文字列出力
D27B C7             	RST	0
D27C                
D27C                COMANL:
D27C CD 8B E0       	CALL	FILE
D27F 3A 19 F0       	LD	A,(FNAME+4)
D282 FE 20          	CP	020H
D284 20 1C          	JR	NZ,COMB2
D286 D5             	PUSH	DE
D287 11 15 F0       	LD	DE,FNAME
D28A 1A             	LD	A,(DE)
D28B FE 20          	CP	020H
D28D 28 44          	JR	Z,SDVSW
D28F 1B             	DEC	DE
D290 1A             	LD	A,(DE)
D291 C6 FF          	ADD	A,0FFH
D293 38 09          	JR	C,COMB
D295 13             	INC	DE
D296                
D296 21 03 D7       	LD	HL,COMTB
D299 06 09          	LD	B,COMS
D29B CD 0F E3       	CALL	CPNAME
D29E                COMB:
D29E D1             	POP	DE
D29F D2 0F 00       	JP	NC,JP_HL
D2A2                COMB2:
D2A2 EB             	EX	DE,HL
D2A3 22 6F D3       	LD	(COMPAT+1),HL
D2A6 F5             	PUSH	AF
D2A7 CD 27 D3       	CALL	CEXE4
D2AA F1             	POP	AF
D2AB 21 15 F0       	LD	HL,FNAME
D2AE 11 6D 00       	LD	DE,FCB2+1	;COMMAND NAME
D2B1 01 0B 00       	LD	BC,11
D2B4 ED B0          	LDIR
D2B6 11 68 EF       	LD	DE,PATHD
D2B9                CEX1:
D2B9 1A             	LD	A,(DE)
D2BA FE 20          	CP	020H
D2BC D8             	RET	C
D2BD CD 80 E0       	CALL	FILEC
D2C0 D5             	PUSH	DE
D2C1 21 6D 00       	LD	HL,FCB2+1	;COMMAND NAME
D2C4 11 15 F0       	LD	DE,FNAME
D2C7 01 0B 00       	LD	BC,11
D2CA ED B0          	LDIR
D2CC CD 27 D3       	CALL	CEXE4
D2CF D1             	POP	DE
D2D0 13             	INC	DE
D2D1 18 E6          	JR	CEX1
D2D3                
D2D3                SDVSW:
D2D3 F1             	POP	AF
D2D4 3A 14 F0       	LD	A,(FDRV)
D2D7 3D             	DEC	A
D2D8 5F             	LD	E,A
D2D9 0E 0E          	LD	C,00EH		;(BDOS)カレントドライブの設定
D2DB 18 31          	JR	SYSTEM0
D2DD                
D2DD                OPEN1:
D2DD 21 14 F0       	LD	HL,FDRV
D2E0                OPEN:
D2E0 0E 11          	LD	C,011H		;(BDOS)ファイルの検索
D2E2                OPEN3:
D2E2 D5             	PUSH	DE
D2E3 11 A9 EF       	LD	DE,DTA_CCP
D2E6 CD 04 D3       	CALL	SETDTA
D2E9 EB             	EX	DE,HL
D2EA CD 0E D3       	CALL	SYSTEM0
D2ED D1             	POP	DE
D2EE C9             	RET
D2EF                
D2EF                OPEN2:
D2EF 0E 12          	LD	C,012H
D2F1 18 EF          	JR	OPEN3
D2F3                
D2F3                DEFCB:				;Z=Ok NZ=Error
D2F3 11 A9 EF       	LD	DE,DTA_CCP
D2F6 CD 0C D3       	CALL	SYSC0F
D2F9                
D2F9 11 CA EF       	LD	DE,DTA_CCP+33	;(FCB)ランダムレコード
D2FC 06 04          	LD	B,4
D2FE CD D3 D5       	CALL	ZERO_MEMORY_DE
D301                SETDTA100:
D301 11 00 01       	LD	DE,00100H
D304                SETDTA:
D304 C3 39 DA       	JP	_SYS1A		;(BDOS)DTAの設定
D307                
D307                SETDTA1:
D307 11 80 00       	LD	DE,DTA1
D30A 18 F8          	JR	SETDTA
D30C                
D30C                SYSC0F:
D30C 0E 0F          	LD	C,00FH		;(BDOS)ファイルのオープン
D30E                SYSTEM0:
D30E CD 05 00       	CALL	SYSTEM
D311 B7             	OR	A
D312 C9             	RET
D313                
D313                C_CD:
D313 0E 5A          	LD	C,5AH
D315 18 F7          	JR	SYSTEM0
D317                
D317                S27BUF:
D317 3A 07 00       	LD	A,(SYSTEM+2)
D31A 3D             	DEC	A
D31B E6 F8          	AND	0F8H
D31D 67             	LD	H,A
D31E 2E 00          	LD	L,0
D320                S27DTA:
D320 11 A9 EF       	LD	DE,DTA_CCP
D323                S27:
D323 0E 27          	LD	C,027H		;(BDOS)ランダムブロック読み込み
D325 18 E7          	JR	SYSTEM0
D327                
D327                CEXE4:
D327 21 1D F0       	LD	HL,FNAME+8
D32A 7E             	LD	A,(HL)
D32B FE 20          	CP	020H
D32D 20 07          	JR	NZ,CEXE7
D32F 3E 3F          	LD	A,'?'
D331 77             	LD	(HL),A
D332 23             	INC	HL
D333 77             	LD	(HL),A
D334 23             	INC	HL
D335 77             	LD	(HL),A
D336                CEXE7:
D336 CD DD D2       	CALL	OPEN1
D339                CEXE5:
D339 C0             	RET	NZ
D33A 2A B3 EF       	LD	HL,(DTA_CCP+1+9)
D33D 7C             	LD	A,H
D33E CD 97 E3       	CALL	CAP
D341 67             	LD	H,A
D342 7D             	LD	A,L
D343 CD 97 E3       	CALL	CAP
D346 6F             	LD	L,A
D347 3A B2 EF       	LD	A,(DTA_CCP+1+8)
D34A CD 97 E3       	CALL	CAP
D34D D6 42          	SUB	'B'
D34F 28 2C          	JR	Z,C_BAT
D351 3D             	DEC	A		;'C'
D352 28 05          	JR	Z,C_EXE
D354                CEXE6:
D354 CD EF D2       	CALL	OPEN2
D357 18 E0          	JR	CEXE5
D359                
D359                C_EXE:
D359 7C             	LD	A,H
D35A FE 4D          	CP	'M'
D35C 20 F6          	JR	NZ,CEXE6
D35E                
D35E CD F3 D2       	CALL	DEFCB
D361 CD 17 D3       	CALL	S27BUF
D364 3D             	DEC	A
D365 37             	SCF
D366 C0             	RET	NZ
D367 7C             	LD	A,H
D368 B5             	OR	L
D369 37             	SCF
D36A C8             	RET	Z
D36B CD 07 D3       	CALL	SETDTA1
D36E 11 00 00       COMPAT:	LD	DE,0				; self-modifying code
D371 ED 7B 06 00    	LD	SP,(SYSTEM+1)
D375 67             	LD	H,A				; A=0 in SETDTA1(_SYS1A)
D376 6F             	LD	L,A
D377 E5             	PUSH	HL				; push $0000 (reboot address)
D378 24             	INC	H
D379 E5             	PUSH	HL				; push $0100 (TPA address)
D37A C3 9E D5       	JP	SETFCB				; and JP $0100
D37D                
D37D                C_BAT:
D37D 11 41 54       	LD	DE,'A'+'T'*256
D380 ED 52          	SBC	HL,DE
D382 20 D0          	JR	NZ,CEXE6
D384                
D384 CD F3 D2       	CALL	DEFCB
D387                
D387 21 A9 EF       	LD	HL,DTA_CCP
D38A 11 CE EF       	LD	DE,FCB_BAT
D38D 01 25 00       	LD	BC,37
D390 ED B0          	LDIR
D392                C_BAT1:
D392 CD 01 D3       	CALL	SETDTA100
D395 CD C9 D3       	CALL	FGETC_BAT
D398 21 81 00       	LD	HL,DTA1+1
D39B 20 25          	JR	NZ,END_BATCH
D39D FE 21          	CP	021H		;スペースや改行など制御文字を飛ばす
D39F 38 F1          	JR	C,C_BAT1
D3A1 36 20          	LD	(HL),' '
D3A3 23             	INC	HL
D3A4                C_BAT2:
D3A4 77             	LD	(HL),A
D3A5 23             	INC	HL
D3A6 7D             	LD	A,L
D3A7 3C             	INC	A		;L==0FFH
D3A8 28 09          	JR	Z,RUN_BATCH
D3AA CD C9 D3       	CALL	FGETC_BAT
D3AD 20 04          	JR	NZ,RUN_BATCH
D3AF FE 20          	CP	020H
D3B1 30 F1          	JR	NC,C_BAT2
D3B3                RUN_BATCH:
D3B3 7D             	LD	A,L
D3B4 D6 7F          	SUB	DTA1-1
D3B6 32 80 00       	LD	(DTA1),A
D3B9 FE 04          	CP	4
D3BB 38 05          	JR	C,END_BATCH
D3BD 36 00          	LD	(HL),0
D3BF C3 6D D2       	JP	COMMAND2
D3C2                END_BATCH:
D3C2 AF             	XOR	A		;バッチファイルを閉じる
D3C3 32 CE EF       	LD	(FCB_BAT),A
D3C6 C3 00 F0       	JP	CPM_BOOT
D3C9                
D3C9                FGETC_BAT:
D3C9 11 CE EF       	LD	DE,FCB_BAT
D3CC                FGETC:				;1文字ずつ読み込む
D3CC E5             	PUSH	HL		;Z:成功
D3CD 21 01 00       	LD	HL,1
D3D0 CD 23 D3       	CALL	S27
D3D3 E1             	POP	HL
D3D4 3A 00 01       	LD	A,(00100H)
D3D7 C9             	RET
D3D8                
D3D8                C_DEL:
D3D8 CD 9E D5       	CALL	SETFCB
D3DB CD D4 DB       	CALL	_SYS08		;(BDOS)エコーなしコンソール入力
D3DE                
D3DE 0E 13          	LD	C,013H
D3E0 18 0A          	JR	CDEL1		;(BDOS)ファイルの削除
D3E2                
D3E2                C_REN:
D3E2 CD 9E D5       	CALL	SETFCB
D3E5 3E 10          	LD	A,010H		;ディレクトリも対象にする
D3E7 32 69 00       	LD	(FCB1+13),A	;属性
D3EA 0E 17          	LD	C,017H		;(BDOS)ファイル名の変更
D3EC                CDEL1:
D3EC 11 5C 00       	LD	DE,FCB1
D3EF CD 05 00       	CALL	SYSTEM
D3F2 C6 FF          	ADD	A,0FFH
D3F4 C9             	RET
D3F5                
D3F5                C_DIR:
D3F5 CD 80 E0       	CALL	FILEC
D3F8 21 15 F0       	LD	HL,FDRV+1
D3FB CD E9 D6       	CALL	CWILD1
D3FE 3E F1          	LD	A,0F1H
D400 32 21 F0       	LD	(FDRV+13),A
D403 CD DD D2       	CALL	OPEN1
D406                CDIR1:
D406 B7             	OR	A
D407 20 08          	JR	NZ,PDSKF
D409 CD 54 D4       	CALL	P_NAME
D40C CD EF D2       	CALL	OPEN2
D40F 18 F5          	JR	CDIR1
D411                
D411                PDSKF:
D411 3A 14 F0       	LD	A,(FDRV)
D414 5F             	LD	E,A
D415 0E 1B          	LD	C,01BH		;(BDOS)ディスク情報の獲得
D417 CD 05 00       	CALL	SYSTEM
D41A 4F             	LD	C,A		;C←1クラスタ辺りの論理セクタ数
D41B C6 01          	ADD	A,001H
D41D D8             	RET	C		;Aが0FFHだった場合
D41E 3E 06          	LD	A,8-2
D420                PDS1:				;HL=未使用クラスタの総数
D420 3C             	INC	A
D421 CB 19          	RR	C
D423 30 FB          	JR	NC,PDS1
D425                PDS2:				;B←論理セクタのサイズの上位8ビット
D425 3C             	INC	A
D426 CB 18          	RR	B
D428 30 FB          	JR	NC,PDS2
D42A 47             	LD	B,A
D42B                
D42B 11 00 00       	LD	DE,0
D42E                PDS3:
D42E 29             	ADD	HL,HL
D42F EB             	EX	DE,HL
D430 ED 6A          	ADC	HL,HL
D432 EB             	EX	DE,HL
D433 10 F9          	DJNZ	PDS3
D435                PDSKF1:
D435 CD CD D4       	CALL	PRDEC_DEHL
D438 11 F3 EF       	LD	DE,FREE
D43B CD 61 D8       	CALL	_SYS09		;(BDOS)文字列出力
D43E CD BC D4       	CALL	PUTDRV
D441 3E 5C          	LD	A,05CH		;\
D443 CD BE DB       	CALL	MSG_A
D446 2A 22 F0       	LD	HL,(FDRV+14)	;ディレクトリのクラスタ番号
D449 AF             	XOR	A
D44A 11 FE FF       	LD	DE,0-2
D44D 19             	ADD	HL,DE
D44E 23             	INC	HL
D44F DC C9 D4       	CALL	C,PRDEC_HL
D452 18 41          	JR	LTNL
D454                
D454                P_NAME:
D454 3A AA EF       	LD	A,(DTA_CCP+1)
D457 FE 2E          	CP	'.'
D459 C8             	RET	Z
D45A 11 FF D6       	LD	DE,DIRHD
D45D CD 61 D8       	CALL	_SYS09		;(BDOS)文字列出力
D460 3A B5 EF       	LD	A,(DTA_CCP+1+00BH)
D463 F5             	PUSH	AF
D464 0F             	RRCA
D465 9F             	SBC	A,A
D466 E6 0A          	AND	'*'-020H
D468 C6 20          	ADD	A,020H
D46A CD BE DB       	CALL	MSG_A
D46D CD BC D4       	CALL	PUTDRV
D470 21 AA EF       	LD	HL,DTA_CCP+1
D473 CD 0D D5       	CALL	FPRNT
D476                
D476 F1             	POP	AF
D477 CB 67          	BIT	4,A
D479 28 08          	JR	Z,DIR3
D47B 11 F4 D6       	LD	DE,DIRMES
D47E CD 61 D8       	CALL	_SYS09		;(BDOS)文字列出力
D481 18 0A          	JR	DIR6
D483                DIR3:
D483 ED 5B C8 EF    	LD	DE,(DTA_CCP+1+01EH)
D487 2A C6 EF       	LD	HL,(DTA_CCP+1+01CH)
D48A CD CD D4       	CALL	PRDEC_DEHL
D48D                DIR6:
D48D 3A B1 F0       	LD	A,(_WIDTH)
D490 FE 29          	CP	40+1
D492 D4 2F D5       	CALL	NC,PRTTMS
D495                
D495                LTNL:
D495 1E 03          	LD	E,3
D497 C3 CD F0       	JP	_PRINT
D49A                
D49A                C_PATH:
D49A CD 62 E1       	CALL	SPCUT
D49D 21 68 EF       	LD	HL,PATHD
D4A0 FE 21          	CP	021H
D4A2 30 0C          	JR	NC,CPATH0
D4A4                CPATHP:
D4A4 7E             	LD	A,(HL)
D4A5 23             	INC	HL
D4A6 FE 20          	CP	020H
D4A8 3F             	CCF
D4A9 30 EA          	JR	NC,LTNL
D4AB CD BE DB       	CALL	MSG_A
D4AE 18 F4          	JR	CPATHP
D4B0                CPATH0:
D4B0 FE 3B          	CP	';'
D4B2 20 01          	JR	NZ,CPATH1
D4B4 13             	INC	DE
D4B5                CPATH1:
D4B5 EB             	EX	DE,HL
D4B6 01 40 00       	LD	BC,PATHX
D4B9 ED B0          	LDIR
D4BB C9             	RET
D4BC                
D4BC                PUTDRV:
D4BC 3A 14 F0       	LD	A,(FDRV)
D4BF C6 40          	ADD	A,'A'-1
D4C1 CD BE DB       	CALL	MSG_A
D4C4 3E 3A          	LD	A,':'
D4C6                MSG_AR:
D4C6 C3 BE DB       	JP	MSG_A
D4C9                
D4C9                PRDEC_HL:
D4C9 AF             	XOR	A
D4CA                PRDEC_AHL:
D4CA 5F             	LD	E,A
D4CB 16 00          	LD	D,0
D4CD                PRDEC_DEHL:
D4CD D5             	PUSH	DE
D4CE 11 0F F0       	LD	DE,DECBF
D4D1 06 05          	LD	B,5
D4D3 CD D3 D5       	CALL	ZERO_MEMORY_DE	;A=0
D4D6 D1             	POP	DE
D4D7                
D4D7 0E 20          	LD	C,32
D4D9                DEC1:
D4D9 29             	ADD	HL,HL
D4DA EB             	EX	DE,HL
D4DB ED 6A          	ADC	HL,HL
D4DD EB             	EX	DE,HL
D4DE E5             	PUSH	HL
D4DF 21 13 F0       	LD	HL,DECBF+4
D4E2 06 05          	LD	B,5
D4E4                DEC2:
D4E4 7E             	LD	A,(HL)
D4E5 8F             	ADC	A,A
D4E6 27             	DAA
D4E7 77             	LD	(HL),A
D4E8 2B             	DEC	HL
D4E9 10 F9          	DJNZ	DEC2
D4EB E1             	POP	HL
D4EC 0D             	DEC	C
D4ED 20 EA          	JR	NZ,DEC1
D4EF                
D4EF 21 0F F0       	LD	HL,DECBF
D4F2 3E 20          	LD	A,020H
D4F4 06 04          	LD	B,4
D4F6                DEC3:
D4F6 CD 03 D5       	CALL	DEC4
D4F9 CD 03 D5       	CALL	DEC4
D4FC 23             	INC	HL
D4FD 10 F7          	DJNZ	DEC3
D4FF                DECX:
D4FF CD 03 D5       	CALL	DEC4
D502 AF             	XOR	A
D503                DEC4:
D503 ED 6F          	RLD
D505 FE 20          	CP	020H
D507 28 02          	JR	Z,DEC5
D509 F6 30          	OR	030H
D50B                DEC5:
D50B 18 B9          	JR	MSG_AR
D50D                
D50D                FPRNT:
D50D 06 08          	LD	B,8
D50F CD 20 D5       	CALL	P_N1
D512 7E             	LD	A,(HL)
D513 C6 80          	ADD	A,0A0H-020H
D515 FE A0          	CP	0A0H
D517 28 02          	JR	Z,FPR1
D519 3E 2E          	LD	A,'.'
D51B                FPR1:
D51B CD BE DB       	CALL	MSG_A
D51E 06 03          	LD	B,3
D520                
D520                P_N1:
D520 C5             	PUSH	BC
D521 E5             	PUSH	HL
D522 7E             	LD	A,(HL)
D523 CD A3 E3       	CALL	CAP3
D526 CD BE DB       	CALL	MSG_A
D529 E1             	POP	HL
D52A C1             	POP	BC
D52B 23             	INC	HL
D52C 10 F2          	DJNZ	P_N1
D52E C9             	RET
D52F                
D52F                PRTTMS:
D52F 3E 20          	LD	A,020H
D531 CD BE DB       	CALL	MSG_A
D534                
D534 2A C2 EF       	LD	HL,(DTA_CCP+1+24)
D537 7D             	LD	A,L
D538 B7             	OR	A
D539 C8             	RET	Z
D53A CB 3C          	SRL	H
D53C 17             	RLA
D53D 17             	RLA
D53E 17             	RLA
D53F 17             	RLA
D540 E6 0F          	AND	00FH
D542 57             	LD	D,A
D543 7C             	LD	A,H
D544 C6 50          	ADD	A,80
D546 CD 89 D5       	CALL	PRDEC_A
D549 3E 2D          	LD	A,'-'
D54B CD BE DB       	CALL	MSG_A
D54E 7A             	LD	A,D
D54F CD 89 D5       	CALL	PRDEC_A
D552 3E 2D          	LD	A,'-'
D554 CD BE DB       	CALL	MSG_A
D557 7D             	LD	A,L
D558 E6 1F          	AND	01FH
D55A CD 89 D5       	CALL	PRDEC_A
D55D                
D55D 2A C0 EF       	LD	HL,(DTA_CCP+1+22)
D560                
D560 3E 20          	LD	A,020H
D562 CD BE DB       	CALL	MSG_A
D565 7C             	LD	A,H
D566 65             	LD	H,L
D567 06 03          	LD	B,3
D569                PRTTMS1:
D569 1F             	RRA
D56A CB 1D          	RR	L
D56C 10 FB          	DJNZ	PRTTMS1
D56E E6 1F          	AND	01FH
D570 CD 89 D5       	CALL	PRDEC_A
D573 3E 3A          	LD	A,':'
D575 CD BE DB       	CALL	MSG_A
D578 7D             	LD	A,L
D579 0F             	RRCA
D57A 0F             	RRCA
D57B E6 3F          	AND	03FH
D57D CD 89 D5       	CALL	PRDEC_A
D580 3E 3A          	LD	A,':'
D582 CD BE DB       	CALL	MSG_A
D585 7C             	LD	A,H
D586 E6 1F          	AND	01FH
D588 87             	ADD	A,A
D589                
D589                ;	PRINT10
D589                
D589                PRDEC_A:
D589 E5             	PUSH	HL
D58A 06 08          	LD	B,8
D58C 4F             	LD	C,A
D58D AF             	XOR	A
D58E                PRTA1:
D58E CB 01          	RLC	C
D590 8F             	ADC	A,A
D591 27             	DAA
D592 10 FA          	DJNZ	PRTA1
D594 21 0F F0       	LD	HL,DECBF
D597 77             	LD	(HL),A
D598 AF             	XOR	A
D599 CD FF D4       	CALL	DECX
D59C E1             	POP	HL
D59D C9             	RET
D59E                
D59E                SETFCB:
D59E CD 62 E1       	CALL	SPCUT
D5A1 1A             	LD	A,(DE)
D5A2 FE 20          	CP	020H
D5A4 38 01          	JR	C,SETFCBA
D5A6 1B             	DEC	DE
D5A7                SETFCBA:
D5A7 06 24          	LD	B,36
D5A9 21 5C 00       	LD	HL,FCB1
D5AC E5             	PUSH	HL
D5AD AF             	XOR	A
D5AE CD 37 E1       	CALL	FILL_MEMORY
D5B1 E1             	POP	HL
D5B2 D5             	PUSH	DE
D5B3 CD 9F DA       	CALL	_SYS29		;(BDOS)ファイル名の解析
D5B6 21 6C 00       	LD	HL,FCB2
D5B9 CD 9F DA       	CALL	_SYS29		;(BDOS)ファイル名の解析
D5BC E1             	POP	HL
D5BD 01 00 50       	LD	BC,05000H
D5C0 11 81 00       	LD	DE,00081H
D5C3                SETFCB1:
D5C3 7E             	LD	A,(HL)
D5C4 23             	INC	HL
D5C5 FE 20          	CP	020H
D5C7 38 05          	JR	C,SETFCB2
D5C9 12             	LD	(DE),A
D5CA 13             	INC	DE
D5CB 0C             	INC	C
D5CC 10 F5          	DJNZ	SETFCB1
D5CE                SETFCB2:
D5CE 79             	LD	A,C
D5CF 32 80 00       	LD	(DTA1),A
D5D2 04             	INC	B
D5D3                ZERO_MEMORY_DE:
D5D3 AF             	XOR	A
D5D4                FILL_MEMORY_DE:
D5D4 12             	LD	(DE),A
D5D5 13             	INC	DE
D5D6 10 FC          	DJNZ	FILL_MEMORY_DE
D5D8 C9             	RET
D5D9                
D5D9                C_COPY:
D5D9 CD 9E D5       	CALL	SETFCB
D5DC                
D5DC 11 61 F0       	LD	DE,ZERO
D5DF CD 83 E0       	CALL	FILEC2
D5E2 21 6C 00       	LD	HL,FCB2
D5E5 CD A6 DA       	CALL	S29X1
D5E8                
D5E8 3E 10          	LD	A,010H
D5EA 32 69 00       	LD	(FCB1+13),A
D5ED 21 6D 00       	LD	HL,FCB2+1
D5F0 CD E9 D6       	CALL	CWILD1
D5F3                COPY0:
D5F3 CD E6 D6       	CALL	CWILD
D5F6 21 5C 00       	LD	HL,FCB1
D5F9 CD E0 D2       	CALL	OPEN
D5FC 37             	SCF
D5FD                COPY1:
D5FD C0             	RET	NZ
D5FE CD F3 D2       	CALL	DEFCB
D601                
D601 3A B6 EF       	LD	A,(DTA_CCP+13)
D604 CB 67          	BIT	4,A
D606 28 21          	JR	Z,COPY1A
D608                
D608 21 5D 00       	LD	HL,FCB1+1
D60B CD C6 E4       	CALL	CHKWILD
D60E 38 14          	JR	C,COPY9
D610                
D610 3E 20          	LD	A,020H
D612 32 5D 00       	LD	(FCB1+1),A
D615 2A C3 EF       	LD	HL,(DTA_CCP+26)
D618 23             	INC	HL
D619 22 6A 00       	LD	(FCB1+14),HL
D61C 18 D5          	JR	COPY0
D61E                
D61E                COPY8:
D61E CD 61 D8       	CALL	_SYS09		;(BDOS)文字列出力
D621 CD 95 D4       	CALL	LTNL
D624                COPY9:
D624 CD EF D2       	CALL	OPEN2
D627 18 D4          	JR	COPY1
D629                
D629                COPY1A:
D629 21 6C 00       	LD	HL,FCB2
D62C 11 14 F0       	LD	DE,FDRV
D62F 01 AB EF       	LD	BC,DTA_CCP+2
D632 ED A0          	LDI
D634 3E 0B          	LD	A,11
D636                COPY2:
D636 F5             	PUSH	AF
D637 7E             	LD	A,(HL)
D638 FE 3F          	CP	'?'
D63A 20 01          	JR	NZ,COPY3
D63C 0A             	LD	A,(BC)
D63D                COPY3:
D63D 12             	LD	(DE),A
D63E 03             	INC	BC
D63F 13             	INC	DE
D640 23             	INC	HL
D641 F1             	POP	AF
D642 3D             	DEC	A
D643 20 F1          	JR	NZ,COPY2
D645 01 05 00       	LD	BC,16-11
D648 ED B0          	LDIR
D64A                PUTNAME:
D64A 21 5D 00       	LD	HL,FCB1+1
D64D CD C6 E4       	CALL	CHKWILD
D650 30 0B          	JR	NC,PUTN1
D652 21 15 F0       	LD	HL,FDRV+1
D655 CD 0D D5       	CALL	FPRNT
D658 3E 20          	LD	A,020H
D65A CD BE DB       	CALL	MSG_A
D65D                PUTN1:
D65D 11 14 F0       	LD	DE,FDRV
D660 0E 16          	LD	C,016H		;(BDOS)ファイルの作成
D662 CD 0E D3       	CALL	SYSTEM0
D665 20 48          	JR	NZ,COPYE2
D667 67             	LD	H,A		;A=0
D668 6F             	LD	L,A
D669 22 35 F0       	LD	(FDRV+33),HL	;(FCB)ランダムレコード
D66C 22 37 F0       	LD	(FDRV+35),HL
D66F                COPY6:
D66F CD 17 D3       	CALL	S27BUF
D672 47             	LD	B,A
D673 3C             	INC	A
D674 28 31          	JR	Z,COPYE
D676 7C             	LD	A,H
D677 B5             	OR	L
D678 28 0C          	JR	Z,COPY7
D67A 11 14 F0       	LD	DE,FDRV
D67D 0E 26          	LD	C,026H		;(BDOS)ランダムブロック書き込み
D67F CD 0E D3       	CALL	SYSTEM0
D682 20 23          	JR	NZ,COPYE
D684 10 E9          	DJNZ	COPY6
D686                COPY7:
D686 3A B6 EF       	LD	A,(DTA_CCP+13)	;(FCB)属性
D689 32 21 F0       	LD	(FDRV+13),A
D68C 21 BD EF       	LD	HL,DTA_CCP+20	;(FCB)タイムスタンプ
D68F 11 28 F0       	LD	DE,FDRV+20
D692 01 04 00       	LD	BC,4
D695 ED B0          	LDIR
D697                
D697 11 14 F0       	LD	DE,FDRV
D69A 0E 10          	LD	C,010H		;(BDOS)ファイルのクローズ
D69C CD 0E D3       	CALL	SYSTEM0
D69F 20 06          	JR	NZ,COPYE
D6A1                
D6A1 11 71 F0       	LD	DE,OK
D6A4 C3 1E D6       	JP	COPY8
D6A7                
D6A7                COPYE:
D6A7 11 14 F0       	LD	DE,FDRV
D6AA 0E 13          	LD	C,013H		;(BDOS)ファイルの削除
D6AC CD 05 00       	CALL	SYSTEM
D6AF                COPYE2:
D6AF 37             	SCF
D6B0 C9             	RET
D6B1                
D6B1                C_TYPE:
D6B1 CD 9E D5       	CALL	SETFCB
D6B4 21 5C 00       	LD	HL,FCB1
D6B7 CD E0 D2       	CALL	OPEN
D6BA 37             	SCF
D6BB                TYPE1:
D6BB C0             	RET	NZ
D6BC CD F3 D2       	CALL	DEFCB
D6BF 3E 06          	LD	A,6
D6C1 CD BE DB       	CALL	MSG_A
D6C4                TYPE2:
D6C4 CD 17 D3       	CALL	S27BUF
D6C7 C6 FE          	ADD	A,0FEH
D6C9 D8             	RET	C
D6CA 7C             	LD	A,H
D6CB B5             	OR	L
D6CC 28 13          	JR	Z,TYPEE
D6CE 01 00 01       	LD	BC,00100H
D6D1                TYPE3:
D6D1 0A             	LD	A,(BC)
D6D2 03             	INC	BC
D6D3 FE 1A          	CP	01AH
D6D5 28 0A          	JR	Z,TYPEE
D6D7 CD BE DB       	CALL	MSG_A
D6DA 2B             	DEC	HL
D6DB 7C             	LD	A,H
D6DC B5             	OR	L
D6DD 20 F2          	JR	NZ,TYPE3
D6DF 18 E3          	JR	TYPE2
D6E1                TYPEE:
D6E1 CD EF D2       	CALL	OPEN2
D6E4 18 D5          	JR	TYPE1
D6E6                
D6E6                CWILD:
D6E6 21 5D 00       	LD	HL,FCB1+1
D6E9                CWILD1:
D6E9 7E             	LD	A,(HL)
D6EA FE 20          	CP	020H
D6EC C0             	RET	NZ
D6ED                CWILD2:
D6ED 3E 3F          	LD	A,'?'
D6EF 06 0B          	LD	B,11
D6F1 C3 37 E1       	JP	FILL_MEMORY
D6F4                
D6F4 20 20 20 20    DIRMES:	DB	"     <DIR>$"
D6F8 20 3C 44 49
D6FC 52 3E 24
D6FF 20 20 3A 24    DIRHD:	DB	"  :$"
D703                
D703                COMTB:
D703 44 20 20 20    	DB	"D   "	;1
D707 F5 D3          	DW	C_DIR
D709 44 49 52 20    	DB	"DIR "	;2
D70D F5 D3          	DW	C_DIR
D70F 43 4F 50 59    	DB	"COPY"	;3
D713 D9 D5          	DW	C_COPY
D715 43 44 20 20    	DB	"CD  "	;4
D719 13 D3          	DW	C_CD
D71B 44 45 4C 20    	DB	"DEL "	;5
D71F D8 D3          	DW	C_DEL
D721 50 41 54 48    	DB	"PATH"	;6
D725 9A D4          	DW	C_PATH
D727 52 45 4E 20    	DB	"REN "	;7
D72B E2 D3          	DW	C_REN
D72D 54 59 50 45    	DB	"TYPE"	;8
D731 B1 D6          	DW	C_TYPE
D733 52 45 4D 20    	DB	"REM "	;9
D737 5E D8          	DW	C_REM
D739                	INCLUDE	"X1DISK2.ASM"
D739                
D739                ;	LSX-Dodgers DISK2
D739                ;	X1/turbo/Z
D739                
D739                ;	GRAPHIC RAM DISK DRIVER
D739                
D739                
D739                GDRD:
D739 C5             	PUSH	BC
D73A CD 62 D7       	CALL	GADR
D73D F1             	POP	AF
D73E                GDRD1:
D73E ED A2          	INI
D740 04             	INC	B
D741 0C             	INC	C
D742 20 FA          	JR	NZ,GDRD1
D744 04             	INC	B
D745 13             	INC	DE
D746 3D             	DEC	A
D747 20 F5          	JR	NZ,GDRD1
D749                GBANK0:
D749 3A BF F0       	LD	A,(WK1FD0)
D74C E6 EF          	AND	0EFH		;BANK0
D74E 18 1D          	JR	S1FD0
D750                
D750                GDWT:
D750 C5             	PUSH	BC
D751 CD 62 D7       	CALL	GADR
D754 F1             	POP	AF
D755                GDWT1:
D755 04             	INC	B
D756 ED A3          	OUTI
D758 0C             	INC	C
D759 20 FA          	JR	NZ,GDWT1
D75B 04             	INC	B
D75C 13             	INC	DE
D75D 3D             	DEC	A
D75E 20 F5          	JR	NZ,GDWT1
D760 18 E7          	JR	GBANK0
D762                
D762                GADR:
D762 0E 00          	LD	C,0
D764 7B             	LD	A,E
D765 C6 40          	ADD	A,040H
D767 47             	LD	B,A
D768 3A BF F0       	LD	A,(WK1FD0)
D76B F6 10          	OR	010H		;BANK1
D76D                S1FD0:
D76D C5             	PUSH	BC
D76E 32 BF F0       	LD	(WK1FD0),A
D771 01 D0 1F       	LD	BC,01FD0H
D774 ED 79          	OUT	(C),A
D776 C1             	POP	BC
D777 C9             	RET
D778                
D778                
D778                ;	BANK RAM DISK DRIVER
D778                
D778                BDWT:
D778 3E             	DB	03EH	;LD A,??
D779 37             	SCF
D77A 18 02          	JR	BRW
D77C                
D77C                BDRD:
D77C 3E             	DB	03EH	;LD A,??
D77D A7             	AND	A
D77E                BRW:
D77E F3             	DI
D77F 32 AA D7       	LD	(BRWPAT),A
D782 ED 73 CA D7    	LD	(BANKSP),SP
D786 3A CB D7       	LD	A,(BANKSP_H)
D789 87             	ADD	A,A
D78A 38 03          	JR	C,BRW0
D78C 31 CA FF       	LD	SP,EXTSP
D78F                BRW0:
D78F D9             	EXX		;裏レジスタ
D790 C5             	 PUSH	 BC
D791 D5             	 PUSH	 DE
D792 01 00 0B       	 LD	 BC,00B00H	 ;バンクメモリ
D795 11 10 10       	 LD	 DE,01010H
D798 D9             	 EXX		;表レジスタ
D799                BRW1:
D799 C5             	PUSH	BC
D79A D5             	PUSH	DE
D79B EB             	EX	DE,HL
D79C 29             	ADD	HL,HL
D79D 29             	ADD	HL,HL
D79E 7C             	LD	A,H
D79F DD 86 0C       	ADD	A,(IX+00CH)	;DPB_0C_MAXCYL
D7A2 E6 0F          	AND	00FH	;バンク
D7A4 65             	LD	H,L
D7A5 CB 3C          	SRL	H	;/2
D7A7 2E 00          	LD	L,0
D7A9 D9             	EXX		;裏レジスタ
D7AA A7             BRWPAT:	 AND	 A	;自己書き換え(AND A:読み出し/SCF:書き込み)
D7AB 38 08          	 JR	 C,BRWT
D7AD 57             	 LD	 D,A	 ;D=バンク
D7AE D9             	 EXX		;表レジスタ
D7AF EB             	EX	DE,HL
D7B0 CD CE D7       	CALL	BTFR
D7B3 18 06          	JR	BRW2
D7B5                BRWT:
D7B5 5F             	 LD	E,A	 ;E=バンク
D7B6 D9             	 EXX		;表レジスタ
D7B7 CD CE D7       	CALL	BTFR
D7BA EB             	EX	DE,HL
D7BB                BRW2:
D7BB D1             	POP	DE
D7BC C1             	POP	BC
D7BD 13             	INC	DE
D7BE 10 D9          	DJNZ	BRW1
D7C0                
D7C0 D9             	EXX		;裏レジスタ
D7C1 3E 10          	 LD	 A,10H
D7C3 ED 79          	 OUT	 (C),A		;メインメモリに切り替える
D7C5 D1             	 POP	 DE
D7C6 C1             	 POP	 BC
D7C7 D9             	 EXX		;表レジスタ
D7C8 AF             	XOR	A
D7C9 31 00 00       	LD	SP,0
D7CC 00 00 D7 CB    BANKSP_H	EQU	$-1
D7CC 00 00 D7 CA    BANKSP		EQU	$-2
D7CC FB             	EI
D7CD C9             	RET
D7CE                
D7CE                ;メインメモリ←→バンクメモリ 512バイトの転送を行う
D7CE                ; DE:転送元アドレス
D7CE                ; HL:転送先アドレス
D7CE                ; 裏BC:バンク切り替えポート(0B00H)
D7CE                ; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
D7CE                ; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
D7CE                
D7CE                BTFR:
D7CE 06 00          	LD	B,0	;256回ループ(256*2)
D7D0                BTFR1:
D7D0 D9             	EXX		;裏レジスタ
D7D1 ED 51          	 OUT	 (C),D	 ;BANK(MAIN)
D7D3 D9             	 EXX		;表レジスタ
D7D4 1A             	LD	A,(DE)
D7D5 4F             	LD	C,A
D7D6 13             	INC	DE
D7D7 1A             	LD	A,(DE)
D7D8 13             	INC	DE
D7D9 D9             	EXX		;裏レジスタ
D7DA ED 59          	 OUT	 (C),E	 ;MAIN(BANK)
D7DC D9             	 EXX		;表レジスタ
D7DD 71             	LD	(HL),C
D7DE 23             	INC	HL
D7DF 77             	LD	(HL),A
D7E0 23             	INC	HL
D7E1 10 ED          	DJNZ	BTFR1
D7E3 C9             	RET
D7E4                
D7E4                ;	EMM DRIVER(DMA)
D7E4                
D7E4                
D7E4                EDWT:
D7E4 0E 0F          	LD	C,15
D7E6 18 02          	JR	EDWT1
D7E8                EDRD:
D7E8 0E 0E          	LD	C,14
D7EA                EDWT1:
D7EA C5             	PUSH	BC
D7EB D5             	PUSH	DE
D7EC 22 2C D8       	LD	(DMAB),HL
D7EF 78             	LD	A,B
D7F0 87             	ADD	A,A
D7F1 3D             	DEC	A
D7F2 32 25 D8       	LD	(DMALEN+1),A
D7F5 3C             	INC	A
D7F6 84             	ADD	A,H	;HL(アドレス)を先に進めておく
D7F7 67             	LD	H,A
D7F8 EB             	EX	DE,HL
D7F9 29             	ADD	HL,HL
D7FA DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
D7FD 79             	LD	A,C
D7FE DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
D801 09             	ADD	HL,BC
D802 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
D805 06 0D          	LD	B,00DH
D807 ED 49          	OUT	(C),C
D809 0C             	INC	C
D80A ED 69          	OUT	(C),L
D80C 0C             	INC	C
D80D ED 61          	OUT	(C),H
D80F                
D80F 21 20 D8       	LD	HL,EDMAD
D812 CD 93 DF       	CALL	SETDMA
D815 CD BB DF       	CALL	GO_DMA
D818 EB             	EX	DE,HL
D819 D1             	POP	DE
D81A C1             	POP	BC
D81B                DMA_ADD_SEC:
D81B 13             	INC	DE
D81C 10 FD          	DJNZ	DMA_ADD_SEC
D81E AF             	XOR	A
D81F C9             	RET
D820                
D820                EDMAD:
D820 C3             	DB	0C3H	;WR6 リセット
D821 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
D822 03 0D          	DW	00D03H	;ポートA開始アドレス EMMリード/ライト
D824 FF 01          DMALEN:	DW	001FFH	;ブロック長(転送サイズ-1)
D826 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
D827 50             	DB	050H	;WR2 ポートBアドレスインクリメント メモリ
D828 02             	DB	002H	;ポートBタイミング
D829 80             	DB	080H	;WR3
D82A 9A             	DB	09AH	;WR5 WAIT RDY:HIGH
D82B AD             	DB	0ADH	;WR4 連続 ポートB開始アドレス
D82C 00 00          DMAB:	DW	0
D82E 01             	DB	001H	;WR0 ポートA←ポートB 転送
D82F                EMME:
D82F                
D82F 00 00 06 B5    AT_RE	EQU	EDWT-AT_EDWT
D82F                
D82F                	INCLUDE	"LDOS.ASM"
D82F                
D82F                ;	LSX-Dodgers OS
D82F                
D82F                BDOS0:
D82F E5             	PUSH	HL
D830 79             	LD	A,C
D831 FE 3C          	CP	03CH
D833 38 02          	JR	C,DOS1
D835 3E 3C          	LD	A,03CH
D837                DOS1:
D837 87             	ADD	A,A
D838 6F             	LD	L,A
D839 26 F1          	LD	H,STABLE/256
D83B 7E             	LD	A,(HL)
D83C 2C             	INC	L
D83D 66             	LD	H,(HL)
D83E 6F             	LD	L,A
D83F E3             	EX	(SP),HL
D840 79             	LD	A,C
D841                ;確認用
D841                ;	LD	(0050H),A
D841 C9             	RET
D842                _DOS2:
D842 FE 5A          	CP	05AH		;(BDOS)カレントディレクトリの変更(_CHDIR)
D844 CA E3 DA       	JP	Z,_SYS5A
D847 FE 5C          	CP	05CH		;(BDOS)ファイル名の解析(_PFILE)
D849 CA 9F DA       	JP	Z,_SYS29
D84C FE 5F          	CP	05FH		;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
D84E CA F9 ED       	JP	Z,_SYS5F
D851 FE 6F          	CP	06FH		;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
D853 20 0A          	JR	NZ,_ERROR
D855 01 1D 01       	LD	BC,011DH
D858 11 54 01       	LD	DE,VER
D85B 21 00 00       	LD	HL,MACD
D85E                C_REM:
D85E AF             	XOR	A
D85F                _ERROR:
D85F A7             	AND	A
D860 C9             	RET
D861                
D861                _SYS09:		;文字列出力
D861 D5             	PUSH	DE
D862                _SX09:
D862 1A             	LD	A,(DE)
D863 13             	INC	DE
D864 FE 24          	CP	'$'
D866 28 31          	JR	Z,SX0E2
D868 CD BE DB       	CALL	MSG_A
D86B 18 F5          	JR	_SX09
D86D                
D86D                MSX1:
D86D CD BE DB       	CALL	MSG_A
D870                MSX:
D870 7E             	LD	A,(HL)
D871 23             	INC	HL
D872 B7             	OR	A
D873 20 F8          	JR	NZ,MSX1
D875 C9             	RET
D876                
D876                _SYS0C:		;(BDOS)バージョン番号の獲得
D876 21 22 00       	LD	HL,00022H
D879 7D             	LD	A,L
D87A C9             	RET
D87B                
D87B                _SYS0D:		;(BDOS)ディスクリセット
D87B CD DF F0       	CALL	_FFLUSH
D87E E5             	PUSH	HL
D87F 21 80 00       	LD	HL,00080H
D882 22 8A F0       	LD	(_DTA),HL
D885 E1             	POP	HL
D886 D5             	PUSH	DE
D887 1E 00          	LD	E,0
D889 3E             	DB	03EH
D88A                
D88A                _SYS0E:		;(BDOS)カレントドライブの設定
D88A D5             	PUSH	DE
D88B 7B             	LD	A,E
D88C DD E5          	PUSH	IX
D88E CD DC F0       	CALL	_GETDPB
D891 DD E1          	POP	IX
D893 38 04          	JR	C,SX0E2
D895 7B             	LD	A,E
D896 32 87 F0       	LD	(_DVSW),A
D899                SX0E2:
D899 D1             	POP	DE
D89A C9             	RET
D89B                
D89B                _SYS0F:		;(BDOS)ファイルのオープン
D89B CD 74 E1       	CALL	SETDRV
D89E FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D8A1 C6 02          	ADD	A,002H		;Write
D8A3 28 48          	JR	Z,FEND0F
D8A5 CD C2 E4       	CALL	CHKWILDX
D8A8                
D8A8 D4 94 E1       	CALL	NC,SOPENX
D8AB                _S16XX:
D8AB 38 40          	JR	C,FEND0F
D8AD                				;Directory location
D8AD 3A 9F F0       	LD	A,(_FILEN)
D8B0 FD 77 19       	LD	(IY+25),A	;(FCB)ディレクトリロケーション
D8B3                ;				_DIRF
D8B3 3A A0 F0       	LD	A,(_DIRF)
D8B6 FD 77 1D       	LD	(IY+29),A	;(FCB)ディレクトリモード
D8B9                ;				_FBPS
D8B9 FD 73 1E       	LD	(IY+30),E	;(FCB)ディレクトリポジション
D8BC FD 72 1F       	LD	(IY+31),D
D8BF                ;				Open(Read)
D8BF FD 36 1C FF    	LD	(IY+28),0FFH	;(FCB)オープンモード
D8C3                ;				FILENAME
D8C3 FD E5          	PUSH	IY
D8C5 D1             	POP	DE
D8C6 13             	INC	DE
D8C7 01 0B 00       	LD	BC,11
D8CA ED B0          	LDIR
D8CC                ;				Attribute
D8CC 7E             	LD	A,(HL)
D8CD FD 77 0D       	LD	(IY+13),A	;(FCB)属性(アトリビュート)
D8D0 11 0B 00       	LD	DE,11		;Reserved
D8D3 19             	ADD	HL,DE
D8D4                					;(FCB)ファイルを最後に変更した時刻
D8D4 11 EA F1       	LD	DE,SDDATA		;(FCB)ファイルを最後に変更した日付
D8D7 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
D8D9                S16LOOP:				;(FCB)ファイルのサイズ(バイト単位)
D8D9 1A             	LD	A,(DE)
D8DA 13             	INC	DE
D8DB 32 E2 D8       	LD	(S16PAT+2),A
D8DE 7E             	LD	A,(HL)
D8DF 23             	INC	HL
D8E0 FD 77 00       S16PAT:	LD	(IY+0),A
D8E3 10 F4          	DJNZ	S16LOOP
D8E5                
D8E5 AF             	XOR	A
D8E6 FD 77 0C       	LD	(IY+12),A	;(FCB)カレントブロック
D8E9 FD 22 91 D9    	LD	(OFCB+1),IY
D8ED                FEND0F:
D8ED 18 45          	JR	FEND10
D8EF                
D8EF                _SYS10:		;(BDOS)ファイルのクローズ
D8EF CD 74 E1       	CALL	SETDRV
D8F2 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D8F5 D6 FE          	SUB	0FEH
D8F7 37             	SCF
D8F8 3F             	CCF
D8F9 20 39          	JR	NZ,FEND10
D8FB                _S10A:				;Write
D8FB FD 77 0E       	LD	(IY+14),A	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D8FE FD 77 0F       	LD	(IY+15),A
D901                
D901 FD 34 1C       	INC	(IY+28)		;0FEH->0FFH ;オープンモード
D904 CD BA E5       	CALL	SETTMS
D907                
D907 FD 7E 1D       	LD	A,(IY+29)	;(FCB)ディレクトリモード
D90A 32 A0 F0       	LD	(_DIRF),A
D90D E6 7F          	AND	07FH
D90F 32 03 EB       	LD	(_SECPS+1),A
D912 FD 5E 1E       	LD	E,(IY+30)	;(FCB)ディレクトリポジション
D915 FD 56 1F       	LD	D,(IY+31)
D918 CD C8 E2       	CALL	READ_DIR
D91B 38 17          	JR	C,FEND10
D91D                
D91D 3A F2 E1       SDECM1:	LD	A,(SDECPAT+1)	;1セクタ辺りのディレクトリエントリ数
D920 3D              	DEC	A		;1024=01FH / 512=00FH / 256=7
D921 FD A6 19       	AND	(IY+25)		;(FCB)ディレクトリロケーション
D924 6F             	LD	L,A
D925 26 00          	LD	H,0
D927 29             	ADD	HL,HL		;*2
D928 29             	ADD	HL,HL		;*4
D929 29             	ADD	HL,HL		;*8
D92A 29             	ADD	HL,HL		;*16
D92B 29             	ADD	HL,HL		;*32
D92C ED 4B 7E F1    	LD	BC,(_DTBUF)
D930 09             	ADD	HL,BC
D931                
D931 CD D2 E4       	CALL	SDIRENT
D934                FEND10:
D934 18 42          	JR	FEND
D936                
D936                _SYS11:		;(BDOS)最初のファイルの検索
D936 CD 74 E1       	CALL	SETDRV
D939 CD C1 E1       	CALL	SOPEN
D93C                _S12X1:
D93C 38 3A          	JR	C,FEND
D93E CD 61 E2       	CALL	SOPENE2
D941 ED 5B 8A F0    	LD	DE,(_DTA)
D945 3A 88 F0       	LD	A,(_DRV)
D948 3C             	INC	A
D949 12             	LD	(DE),A
D94A D5             	PUSH	DE
D94B 13             	INC	DE
D94C 01 20 00       	LD	BC,32
D94F ED B0          	LDIR
D951 FD 6E 0E       	LD	L,(IY+14)	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D954 FD 66 0F       	LD	H,(IY+15)
D957 22 F4 F1       	LD	(SCDIR),HL
D95A 2A 9A F0       	LD	HL,(_FBPS)
D95D 22 F6 F1       	LD	(SFBPS),HL
D960 2A 9F F0       	LD	HL,(_FILEN)
D963 7C             	LD	A,H
D964 B7             	OR	A
D965 28 06          	JR	Z,_S12DIR
D967 3A 03 EB       	LD	A,(_SECPS+1)
D96A F6 80          	OR	080H
D96C 67             	LD	H,A
D96D                _S12DIR:
D96D 22 F8 F1       	LD	(SFNDF),HL	;Directory position and Flags
D970 E1             	POP	HL
D971 11 39 F0       	LD	DE,SFILE
D974 0E 21          	LD	C,33
D976                _S11B:
D976 ED B0          	LDIR
D978                FEND:
D978 9F             	SBC	A,A		;CF=0 A=0 : CF=1 A=0FFH
D979                FENDE:
D979 FD E1          	POP	IY
D97B C1             	POP	BC
D97C D1             	POP	DE
D97D E1             	POP	HL
D97E C9             	RET
D97F                
D97F                _SYS12:		;(BDOS)次のファイルの検索
D97F E5             	PUSH	HL
D980 D5             	PUSH	DE
D981 C5             	PUSH	BC
D982 FD E5          	PUSH	IY
D984 CD 25 E2       	CALL	NOPEN
D987 18 B3          	JR	_S12X1
D989                
D989                _S16K:
D989 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D98C FE FD          	CP	0FDH		;Device(0FDH)
D98E 37             	SCF
D98F C8             	RET	Z
D990                
D990 11 00 00       OFCB:	LD	DE,0
D993 D5             	PUSH	DE
D994 06 1A          	LD	B,26		;First cluster
D996                S16K1:
D996 13             	INC	DE
D997 23             	INC	HL
D998 10 FC          	DJNZ	S16K1
D99A                
D99A 1A             	LD	A,(DE)
D99B BE             	CP	(HL)
D99C 20 13          	JR	NZ,S16K2
D99E 13             	INC	DE
D99F 23             	INC	HL
D9A0 1A             	LD	A,(DE)
D9A1 BE             	CP	(HL)
D9A2 20 0D          	JR	NZ,S16K2
D9A4                
D9A4 E1             	POP	HL
D9A5 FD E5          	PUSH	IY
D9A7 D1             	POP	DE
D9A8 1A             	LD	A,(DE)		;Drive
D9A9 BE             	CP	(HL)
D9AA 20 06          	JR	NZ,S16K3
D9AC                				;ここはCFが必ず0
D9AC ED 52          	SBC	HL,DE		;CP HL,DE
D9AE 37             	SCF
D9AF C0             	RET	NZ
D9B0 E5             	PUSH	HL
D9B1                S16K2:
D9B1 E1             	POP	HL
D9B2                S16K3:
D9B2 FD E5          	PUSH	IY
D9B4 D1             	POP	DE
D9B5                _SYS13:		;(BDOS)ファイルの削除
D9B5 CD 74 E1       	CALL	SETDRV
D9B8 CD F2 E3       	CALL	KILL
D9BB                FEND13:
D9BB 18 BB          	JR	FEND
D9BD                
D9BD                _SYS14:		;(BDOS)シーケンシャルな読み出し
D9BD CD 74 E1       	CALL	SETDRV
D9C0 CD 26 E6       	CALL	INIT_SEQ
D9C3                SREAD:
D9C3 CD 70 E6       	CALL	RB_READ
D9C6                
D9C6 C6 01          	ADD	A,001H
D9C8 38 AE          	JR	C,FEND
D9CA                
D9CA 7D             	LD	A,L
D9CB D6 01          	SUB	001H
D9CD                FENDX:
D9CD 9F             	SBC	A,A
D9CE E6 03          	AND	3
D9D0 1F             	RRA
D9D1 18 A6          	JR	FENDE
D9D3                
D9D3                _SYS15:		;(BDOS)シーケンシャルな書き込み
D9D3 CD 74 E1       	CALL	SETDRV
D9D6 CD 26 E6       	CALL	INIT_SEQ
D9D9                SWRITE:
D9D9 CD 69 E6       	CALL	RB_WRITE
D9DC                
D9DC C6 FF          	ADD	A,0FFH
D9DE 18 ED          	JR	FENDX
D9E0                
D9E0                _SYS17:		;(BDOS)ファイル名の変更
D9E0 CD 74 E1       	CALL	SETDRV
D9E3 CD 48 E4       	CALL	NAME
D9E6 18 D3          	JR	FEND13
D9E8                
D9E8                _SYS16:		;(BDOS)ファイルの作成
D9E8 CD 74 E1       	CALL	SETDRV
D9EB                
D9EB CD C2 E4       	CALL	CHKWILDX
D9EE 38 CB          	JR	C,FEND13
D9F0 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
D9F3 FE 05          	CP	5
D9F5 28 05          	JR	Z,_S16X2
D9F7 FE 21          	CP	021H
D9F9 DA BB D9       	JP	C,FEND13
D9FC                _S16X2:
D9FC                ;				Clear FCB
D9FC FD E5          	PUSH	IY
D9FE E1             	POP	HL
D9FF 01 10 00       	LD	BC,16
DA02 09             	ADD	HL,BC
DA03                _S16X1:
DA03 70             	LD	(HL),B		;B=0
DA04 23             	INC	HL
DA05 0D             	DEC	C
DA06 20 FB          	JR	NZ,_S16X1
DA08                
DA08 CD BF E5       	CALL	SETTMSX
DA0B FD 36 0D FF    	LD	(IY+13),0FFH	;(FCB)Attribute
DA0F CD 94 E1       	CALL	SOPENX
DA12 3F             	CCF
DA13 CC 89 D9       	CALL	Z,_S16K
DA16 D4 72 E2       	CALL	NC,COPEN
DA19 D4 D2 E4       	CALL	NC,SDIRENT
DA1C C3 AB D8       	JP	_S16XX
DA1F                
DA1F                _SYS21:		;(BDOS)ランダムな読み出し
DA1F CD 74 E1       	CALL	SETDRV
DA22 CD 0A E6       	CALL	INIT_RND
DA25 18 9C          	JR	SREAD
DA27                
DA27                _SYS22:		;(BDOS)ランダムな書き込み
DA27                _SYS28:		;(BDOS)ランダムな書き込み・その2
DA27 CD 74 E1       	CALL	SETDRV
DA2A CD 0A E6       	CALL	INIT_RND
DA2D 18 AA          	JR	SWRITE
DA2F                
DA2F                _SYS18:		;(BDOS)ログインベクトルの獲得
DA2F 21 FF 00       	LD	HL,000FFH
DA32 AF             	XOR	A
DA33 C9             	RET
DA34                
DA34                _SYS19:		;(BDOS)カレントドライブ番号の獲得
DA34 3A 87 F0       	LD	A,(_DVSW)
DA37 A7             	AND	A
DA38 C9             	RET
DA39                
DA39                _SYS1A:		;(BDOS)DTAの設定
DA39 ED 53 8A F0    	LD	(_DTA),DE
DA3D AF             	XOR	A
DA3E C9             	RET
DA3F                
DA3F                _SYS1B:		;(BDOS)ディスク情報の獲得
DA3F 7B             	LD	A,E
DA40 CD 87 E1       	CALL	GETDRV
DA43 CD DC F0       	CALL	_GETDPB
DA46 D4 E2 F0       	CALL	NC,_RDFATX
DA49 21 00 00       	LD	HL,0
DA4C D4 98 E5       	CALL	NC,DSKF
DA4F                
DA4F ED 5B 99 E5    	LD	DE,(MAXCLP+1)	;DPB_08_MAXCL-1
DA53 1B             	DEC	DE		;DE←クラスタの総数
DA54 FD 2A 7C F1    	LD	IY,(_FATBF)	;IY←メモリ上のFATの先頭アドレス
DA58 9F             	SBC	A,A
DA59 D8             	RET	C
DA5A 4F             	LD	C,A		;C=0
DA5B DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS
DA5E E6 0F          	AND	00FH
DA60 47             	LD	B,A
DA61 DD 7E 07       	LD	A,(IX+7)	;DPB_07_SECPCL
DA64 C9             	RET
DA65                
DA65                _SYS1D:		;(BDOS)書き込みが禁止されているディスクの調査
DA65 AF             	XOR	A
DA66 67             	LD	H,A
DA67 6F             	LD	L,A
DA68 C9             	RET
DA69                
DA69                _SYS1F:		;(BDOS)ディスク装置のパラメータの読み出し
DA69 21 00 F2       	LD	HL,DEVICE
DA6C 7B             	LD	A,E
DA6D C3 DC F0       	JP	_GETDPB
DA70                
DA70                _SYS23:		;(BDOS)ファイルサイズの獲得
DA70 E5             	PUSH	HL
DA71 2A 1E F1       	LD	HL,(STABLE+2*00FH)	;ファイルのオープン
DA74 CD 0F 00       	CALL	JP_HL
DA77 38 1B          	JR	C,_S23X1
DA79                
DA79 D5             	PUSH	DE		;EX DE,IY
DA7A FD E3          	EX	(SP),IY		;
DA7C                ;	POP	DE		;
DA7C                ;	PUSH	DE		;DEを破壊しないように注意vv
DA7C FD 7E 10       	LD	A,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
DA7F FD 6E 11       	LD	L,(IY+17)	;
DA82 FD 66 12       	LD	H,(IY+18)	;
DA85 C5             	PUSH	BC		;
DA86 FD 46 13       	LD	B,(IY+19)	;
DA89 CD FC E5       	CALL	GET_CPM_R_SIZE
DA8C C1             	POP	BC
DA8D                _S24X1:
DA8D CD 1C E6       	CALL	SET_RR_AHL
DA90                ;	POP	DE		;^^^^^^^^^^^^^^^^^^^^^^^^
DA90                ;	PUSH	DE		;EX DE,IY
DA90 FD E3          	EX	(SP),IY		;
DA92 D1             	POP	DE		;
DA93                
DA93 AF             	XOR	A
DA94                _S23X1:
DA94 E1             	POP	HL
DA95 C9             	RET
DA96                
DA96                _SYS24:		;(BDOS)ランダムレコードフィールドの設定
DA96 E5             	PUSH	HL
DA97 D5             	PUSH	DE		;EX DE,IY
DA98 FD E3          	EX	(SP),IY		;
DA9A                ;	POP	DE		;
DA9A                ;	PUSH	DE		;DEを破壊しないように注意vv
DA9A CD 2E E6       	CALL	GETSEQ
DA9D 18 EE          	JR	_S24X1		;^^^^^^^^^^^^^^^^^^^^^^^^
DA9F                
DA9F                _SYS29:		;(BDOS)ファイル名の解析(_PPATH)
DA9F C5             	PUSH	BC
DAA0 E5             	PUSH	HL
DAA1 CD 8B E0       	CALL	FILE
DAA4 E1             	POP	HL
DAA5 C1             	POP	BC
DAA6                S29X1:
DAA6 C5             	PUSH	BC
DAA7 D5             	PUSH	DE
DAA8 E5             	PUSH	HL
DAA9 EB             	EX	DE,HL
DAAA 21 14 F0       	LD	HL,FDRV
DAAD 01 0D 00       	LD	BC,13
DAB0 ED B0          	LDIR
DAB2 70             	LD	(HL),B		;B=0
DAB3 0E 03          	LD	C,3
DAB5 ED B0          	LDIR
DAB7 E1             	POP	HL
DAB8 D1             	POP	DE
DAB9 C1             	POP	BC
DABA AF             	XOR	A
DABB C9             	RET
DABC                
DABC                _SYS30:		;(BDOS)論理セクタを用いた書き込み
DABC C5             	PUSH	BC
DABD 01 9D EC       	LD	BC,DWT24B
DAC0 18 04          	JR	S2FX
DAC2                _SYS2F:
DAC2 C5             	PUSH	BC
DAC3 01 8D EC       	LD	BC,DRD24B
DAC6                S2FX:
DAC6 ED 43 DC DA    	LD	(S2FPAT+1),BC
DACA CD DF F0       	CALL	_FFLUSH
DACD                
DACD D5             	PUSH	DE
DACE E5             	PUSH	HL
DACF 7D             	LD	A,L		;Drive
DAD0 CD D9 F0       	CALL	_CHGDRV
DAD3 38 09          	JR	C,S30X2
DAD5 44             	LD	B,H		;Number of clusters
DAD6 2A 8A F0       	LD	HL,(_DTA)
DAD9                
DAD9 0E 00          	LD	C,0
DADB CD 8D EC       S2FPAT:	CALL	DRD24B
DADE                S30X2:
DADE E1             	POP	HL
DADF D1             	POP	DE
DAE0 C1             	POP	BC
DAE1 9F             	SBC	A,A
DAE2 C9             	RET
DAE3                
DAE3                _SYS5A:		;(BDOS)カレントディレクトリの変更
DAE3 C5             	PUSH	BC
DAE4 D5             	PUSH	DE
DAE5 E5             	PUSH	HL
DAE6 CD 80 E0       	CALL	FILEC
DAE9 21 00 00       	LD	HL,0
DAEC 11 14 F0       	LD	DE,FDRV
DAEF 2A 4E F1       	LD	HL,(STABLE+2*027H)	;ランダムブロック読み込み
DAF2 CD 0F 00       	CALL	JP_HL
DAF5 18 E7          	JR	S30X2
DAF7                	INCLUDE	"X1IO.ASM"
DAF7                
DAF7                ;	LSX-Dodgers IO
DAF7                ;	X1/turbo/Z
DAF7                
DAF7 00 00 D8 5F    _SYS04	EQU	_ERROR		;(BDOS)外部出力
DAF7 00 00 D8 5F    _SYS05	EQU	_ERROR		;(BDOS)プリンタ出力
DAF7 00 00 D8 5F    _SYS1C	EQU	_ERROR		;(BDOS)ディスクの書き込み禁止化
DAF7 00 00 D8 5F    _SYS1E	EQU	_ERROR		;(BDOS)ファイル属性の設定
DAF7 00 00 D8 5F    _SYS20	EQU	_ERROR		;(BDOS)利用者番号の設定と読み出し
DAF7 00 00 D8 5F    _SYS2E	EQU	_ERROR		;(BDOS)ベリファイ・フラグの設定
DAF7                
DAF7                BIOS:
DAF7 E5             	PUSH	HL
DAF8 21 10 80       	LD	HL,08010H
DAFB 39             	ADD	HL,SP
DAFC E1             	POP	HL
DAFD 30 0E          	JR	NC,BIOS2
DAFF                BIOS1:
DAFF CD 07 DB       	CALL	BIOS3
DB02 06 1E          	LD	B,01EH
DB04 ED 79          	OUT	(C),A
DB06 C9             	RET
DB07                BIOS3:
DB07 C5             	PUSH	BC
DB08 06 1D          	LD	B,01DH
DB0A ED 79          	OUT	(C),A
DB0C C9             	RET
DB0D                BIOS2:
DB0D ED 73 18 DB    	LD	(BIOS_SP),SP	;スタックがBIOS-ROMと被っている場合
DB11 31 CA FF       	LD	SP,EXTSP
DB14 CD FF DA       	CALL	BIOS1
DB17 31 00 00       	LD	SP,0
DB1A 00 00 DB 18    BIOS_SP	EQU	$-2
DB1A C9             	RET
DB1B                
DB1B                INT:
DB1B F5             	PUSH	AF
DB1C E5             	PUSH	HL
DB1D C5             	PUSH	BC
DB1E                
DB1E CD C2 DE       	CALL	IN49SB
DB21 67             	LD	H,A
DB22 CD C2 DE       	CALL	IN49SB
DB25 6F             	LD	L,A
DB26                SCEXE:
DB26 22 92 F0       	LD	(_KEYD),HL
DB29 CD 59 DB       	CALL	KEYSET1
DB2C                
DB2C C1             	POP	BC
DB2D                INTPE:
DB2D E1             	POP	HL
DB2E                INTPE2:
DB2E F1             	POP	AF
DB2F                INTCTCE:
DB2F FB             	EI
DB30 ED 4D          	RETI
DB32                
DB32                INTCTC2:
DB32 F5             	PUSH	AF
DB33 3E 00          INTCPAT:LD	A,000H
DB35 3D             	DEC	A
DB36 32 34 DB       	LD	(INTCPAT+1),A
DB39 20 F3          	JR	NZ,INTPE2
DB3B                
DB3B 3A 92 F0       	LD	A,(_KEYD)
DB3E B7             	OR	A
DB3F 28 ED          	JR	Z,INTPE2
DB41                KEYSET0:
DB41 E5             	PUSH	HL
DB42 2A 90 F0       	LD	HL,(_KEYPS)
DB45 7C             	LD	A,H
DB46 AD             	XOR	L
DB47 20 06          	JR	NZ,INTC2A
DB49                
DB49 2A 92 F0       	LD	HL,(_KEYD)
DB4C CD 8D DB       	CALL	KEYSET
DB4F                INTC2A:
DB4F 3A 94 F0       	LD	A,(_KEYSP)
DB52 E6 0F          	AND	00FH
DB54 32 34 DB       	LD	(INTCPAT+1),A
DB57                
DB57 18 D4          	JR	INTPE
DB59                
DB59                KEYSET1:
DB59 CB 6C          	BIT	5,H
DB5B F5             	PUSH	AF
DB5C ED 4B 8C F0    	LD	BC,(_CTC)
DB60 78             	LD	A,B
DB61 B1             	OR	C
DB62 20 06          	JR	NZ,KEYS10E
DB64                
DB64 F1             	POP	AF
DB65 20 26          	JR	NZ,KEYSET
DB67 F5             	PUSH	AF
DB68 18 D7          	JR	KEYSET0
DB6A                KEYS10E:
DB6A F1             	POP	AF
DB6B C8             	RET	Z
DB6C F5             	PUSH	AF
DB6D 3E 03          	LD	A,3		;CTC STOP
DB6F ED 79          	OUT	(C),A
DB71 F1             	POP	AF
DB72                
DB72 B7             	OR	A
DB73 C8             	RET	Z
DB74                
DB74 3E A7          	LD	A,0A7H
DB76 ED 79          	OUT	(C),A
DB78 3A 94 F0       	LD	A,(_KEYSP)
DB7B ED 79          	OUT	(C),A
DB7D 79             	LD	A,C
DB7E E6 FC          	AND	0FCH
DB80 4F             	LD	C,A
DB81 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
DB83 3E C0          	LD	A,CTC0
DB85 ED 79          	OUT	(C),A
DB87 3A 95 F0       	LD	A,(_KEYSP+1)
DB8A 32 34 DB       	LD	(INTCPAT+1),A
DB8D                
DB8D                KEYSET:
DB8D 7D             	LD	A,L
DB8E CB 74          	BIT	6,H
DB90 C0             	RET	NZ
DB91                KEYBS:
DB91 B7             	OR	A
DB92 C8             	RET	Z
DB93                KEYBS1:
DB93 CD AB DB       	CALL	KEYBC_IFBREAK
DB96 E5             	PUSH	HL
DB97 F5             	PUSH	AF
DB98 2A 90 F0       	LD	HL,(_KEYPS)
DB9B 2C             	INC	L
DB9C CB AD          	RES	5,L
DB9E 7D             	LD	A,L
DB9F BC             	CP	H
DBA0 28 15          	JR	Z,POP_AF_HL_SCF_RET
DBA2 32 90 F0       	LD	(_KEYPS),A
DBA5 26 FF          	LD	H,KEYBF/256
DBA7 F1             	POP	AF
DBA8 77             	LD	(HL),A
DBA9 E1             	POP	HL
DBAA C9             	RET
DBAB                KEYBC_IFBREAK:
DBAB FE 03          	CP	3
DBAD C0             	RET	NZ
DBAE                KEYBC:
DBAE E5             	PUSH	HL
DBAF 21 00 00       	LD	HL,0
DBB2 22 90 F0       	LD	(_KEYPS),HL
DBB5 E1             	POP	HL
DBB6 C9             	RET
DBB7                
DBB7                POP_AF_HL_SCF_RET:
DBB7 F1             	POP	AF
DBB8 E1             	POP	HL
DBB9 37             	SCF
DBBA C9             	RET
DBBB                
DBBB                _SYS01:		;(BDOS)コンソール入力
DBBB CD 09 F0       	CALL	_SYS07
DBBE                MSG_A:
DBBE F5             	PUSH	AF
DBBF D5             	PUSH	DE
DBC0 5F             	LD	E,A
DBC1 CD C7 DB       	CALL	_SYS02
DBC4 D1             	POP	DE
DBC5 F1             	POP	AF
DBC6 C9             	RET
DBC7                
DBC7                _SYS02:		;(BDOS)コンソール出力
DBC7 CD D9 DB       	CALL	BREAK
DBCA 18 05          	JR	PRINTX
DBCC                
DBCC                _SYS06:		;(BDOS)コンソール直接入出力
DBCC 7B             	LD	A,E
DBCD 3C             	INC	A
DBCE CA CA F0       	JP	Z,_INKEY
DBD1                PRINTX:
DBD1 C3 CD F0       	JP	_PRINT
DBD4                
DBD4                _SYS08:		;(BDOS)エコーなしコンソール入力
DBD4 CD 09 F0       	CALL	_SYS07
DBD7 18 04          	JR	BREAK1
DBD9                BREAK:
DBD9 FB             	EI
DBDA 3A 92 F0       	LD	A,(_KEYD)
DBDD                BREAK1:
DBDD FE 03          	CP	3		;CTRL+C
DBDF CC F4 F0       	CALL	Z,_BREAK
DBE2 FE 13          	CP	013H		;CTRL+S
DBE4 C0             	RET	NZ
DBE5                
DBE5                PAUSE:
DBE5 CD AE DB       	CALL	KEYBC
DBE8                
DBE8                FLGET:
DBE8 CD DF F0       	CALL	_FFLUSH
DBEB C5             	PUSH	BC
DBEC E5             	PUSH	HL
DBED ED 4B 8E F0    	LD	BC,(_TXADR)
DBF1 CB E8          	SET	5,B
DBF3 ED 60          	IN	H,(C)
DBF5                FLGET1:
DBF5 3A 93 F0       	LD	A,(_KEYD+1)
DBF8 0F             	RRCA
DBF9 0F             	RRCA
DBFA E6 10          	AND	010H
DBFC F6 08          	OR	8
DBFE ED 68          	IN	L,(C)
DC00 B5             	OR	L
DC01 ED 79          	OUT	(C),A
DC03 CD CA F0       	CALL	_INKEY
DC06 28 ED          	JR	Z,FLGET1
DC08 ED 61          	OUT	(C),H
DC0A E1             	POP	HL
DC0B C1             	POP	BC
DC0C C9             	RET
DC0D                
DC0D                _SYS0A:		;(BDOS)文字列入力
DC0D C5             	PUSH	BC
DC0E E5             	PUSH	HL
DC0F D5             	PUSH	DE
DC10 CD 0F E0       	CALL	GETL
DC13 11 20 FF       	LD	DE,KBUF
DC16 E1             	POP	HL
DC17 E5             	PUSH	HL
DC18 0E 00          	LD	C,0
DC1A 30 04          	JR	NC,SAX0
DC1C 23             	INC	HL
DC1D 23             	INC	HL
DC1E 18 08          	JR	SAX4
DC20                SAX0:
DC20 46             	LD	B,(HL)
DC21 23             	INC	HL
DC22                SAX1:
DC22 23             	INC	HL
DC23 1A             	LD	A,(DE)
DC24 13             	INC	DE
DC25 B7             	OR	A
DC26 20 04          	JR	NZ,SAX2
DC28                SAX4:
DC28 36 0D          	LD	(HL),00DH
DC2A 18 04          	JR	SAX3
DC2C                SAX2:
DC2C 77             	LD	(HL),A
DC2D 0C             	INC	C
DC2E 10 F2          	DJNZ	SAX1
DC30                SAX3:
DC30 D1             	POP	DE
DC31 79             	LD	A,C
DC32 13             	INC	DE
DC33 12             	LD	(DE),A
DC34 1B             	DEC	DE
DC35 E1             	POP	HL
DC36 C1             	POP	BC
DC37 A7             	AND	A
DC38 C9             	RET
DC39                
DC39                _SYS0B:		;(BDOS)コンソール状態のチェック
DC39 CD D9 DB       	CALL	BREAK
DC3C 3A 92 F0       	LD	A,(_KEYD)
DC3F B7             	OR	A
DC40 C8             	RET	Z
DC41                CONSTX:
DC41 CD DF F0       	CALL	_FFLUSH
DC44 E5             	PUSH	HL
DC45 2A 90 F0       	LD	HL,(_KEYPS)
DC48 7C             	LD	A,H
DC49 AD             	XOR	L
DC4A E1             	POP	HL
DC4B C6 FF          	ADD	A,0FFH
DC4D 9F             	SBC	A,A
DC4E C9             	RET
DC4F                
DC4F                _SYS2A:		;(BDOS)日付の獲得
DC4F C5             	PUSH	BC
DC50 3E ED          	LD	A,0EDH		;Read calendar
DC52 CD DD DE       	CALL	COMOUT
DC55 CD 87 DC       	CALL	IN49SB_BCD	;YY
DC58 6F             	LD	L,A
DC59 26 00          	LD	H,0
DC5B                ;	LD	DE,1900		;0076CH
DC5B                ;	CP	90		;90以上は1900年代 1990-1999
DC5B                ;	JR	NC,RDDATE1	;90未満は2000年代 2000-2089
DC5B                ;	LD	E,0D0H		;2000 & 0FFH D=007H
DC5B 11 D0 07       	LD	DE,2000		;すべて2000年代で処理 2000-2099
DC5E                RDDATE1:
DC5E 19             	ADD	HL,DE
DC5F CD C2 DE       	CALL	IN49SB		;MW
DC62 57             	LD	D,A
DC63 CD 87 DC       	CALL	IN49SB_BCD	;DD
DC66 5F             	LD	E,A
DC67 7A             	LD	A,D
DC68 06 04          	LD	B,4
DC6A                RDDATE2:
DC6A CB 3A          	SRL	D
DC6C 10 FC          	DJNZ	RDDATE2
DC6E C1             	POP	BC
DC6F E6 07          	AND	7
DC71 C9             	RET
DC72                
DC72                _SYS2C:		;(BDOS)時刻の獲得
DC72 C5             	PUSH	BC
DC73 3E EF          	LD	A,0EFH		;Read time
DC75 CD DD DE       	CALL	COMOUT
DC78 CD 87 DC       	CALL	IN49SB_BCD	;TT
DC7B 67             	LD	H,A
DC7C CD 87 DC       	CALL	IN49SB_BCD	;MM
DC7F 6F             	LD	L,A
DC80 CD 87 DC       	CALL	IN49SB_BCD	;SS
DC83 57             	LD	D,A
DC84 C1             	POP	BC
DC85 AF             	XOR	A
DC86 C9             	RET
DC87                
DC87                IN49SB_BCD:
DC87 CD C2 DE       	CALL	IN49SB
DC8A                ;------------------------
DC8A                ;BCDの10進数化
DC8A                ;in
DC8A                ;	A  : BCD
DC8A                ;out
DC8A                ;	A  : 10進数
DC8A                ;------------------------
DC8A 4F             	LD	C,A
DC8B E6 F0          	AND	0F0H	;10の位
DC8D 0F             	RRCA
DC8E 47             	LD	B,A
DC8F 0F             	RRCA
DC90 0F             	RRCA
DC91 80             	ADD	A,B
DC92 47             	LD	B,A
DC93 79             	LD	A,C
DC94 E6 0F          	AND	00FH	;1の位
DC96 80             	ADD	A,B
DC97 C9             	RET
DC98                
DC98                ESC1:
DC98 7B             	LD	A,E
DC99 FE 41          	CP	'A'
DC9B CA E0 DD       	JP	Z,CTRL1E
DC9E FE 42          	CP	'B'
DCA0 CA 48 DF       	JP	Z,CTRL1F
DCA3 FE 43          	CP	'C'
DCA5 CA EB DD       	JP	Z,CTRL1C
DCA8 FE 44          	CP	'D'
DCAA CA D7 DD       	JP	Z,CTRL1D
DCAD FE 45          	CP	'E'
DCAF 28 02          	JR	Z,CT0CX
DCB1 FE 6A          	CP	'j'
DCB3                CT0CX:
DCB3 CA 1B DF       	JP	Z,CTRL0C
DCB6 FE 48          	CP	'H'
DCB8 CA 65 DE       	JP	Z,CTRL0B
DCBB FE 4A          	CP	'J'
DCBD CA 1E DF       	JP	Z,CTRL06
DCC0 FE 4B          	CP	'K'
DCC2 28 07          	JR	Z,CT05X
DCC4 FE 4C          	CP	'L'
DCC6 CA 5D DF       	JP	Z,CTRL0E
DCC9 FE 54          	CP	'T'
DCCB                CT05X:
DCCB CA 24 DE       	JP	Z,CTRL05
DCCE FE 78          	CP	'x'
DCD0 28 04          	JR	Z,ESC1X
DCD2 FE 79          	CP	'y'
DCD4 20 02          	JR	NZ,ESC1Y
DCD6                ESC1X:
DCD6 36 01          	LD	(HL),1
DCD8                ESC1Y:
DCD8 FE 3D          	CP	'='
DCDA 28 04          	JR	Z,ESC1W
DCDC FE 59          	CP	'Y'
DCDE 20 02          	JR	NZ,ESC1Z
DCE0                ESC1W:
DCE0 36 02          	LD	(HL),2
DCE2                ESC1Z:
DCE2 FE 20          	CP	020H
DCE4 38 02          	JR	C,ESC1C
DCE6 87             	ADD	A,A
DCE7 D0             	RET	NC
DCE8                ESC1C:
DCE8 E1             	POP	HL
DCE9                ANK:
DCE9 ED 4B 8E F0    	LD	BC,(_TXADR)
DCED 78             	LD	A,B
DCEE F6 38          	OR	038H
DCF0 47             	LD	B,A
DCF1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DCF3 CB 98          	RES	3,B
DCF5 ED 59          	OUT	(C),E		;Text
DCF7                KANJIE:
DCF7 CD AC DD       	CALL	PRINTE7
DCFA                PRINTE5:
DCFA E1             	POP	HL
DCFB C1             	POP	BC
DCFC AF             	XOR	A
DCFD C9             	RET
DCFE                
DCFE                ESC:
DCFE 21 FA DC       	LD	HL,PRINTE5
DD01 E5             	PUSH	HL
DD02 21 24 DD       	LD	HL,ESCFLG+1
DD05 36 00          	LD	(HL),0
DD07 3D             	DEC	A
DD08 28 8E          	JR	Z,ESC1
DD0A 3D             	DEC	A
DD0B 20 09          	JR	NZ,ESC2
DD0D 36 03          	LD	(HL),3
DD0F 7B             	LD	A,E
DD10 D6 20          	SUB	020H
DD12 32 19 DD       	LD	(ESCYP+1),A
DD15 C9             	RET
DD16                ESC2:
DD16 3D             	DEC	A
DD17 C0             	RET	NZ
DD18 26 00          ESCYP:	LD	H,0
DD1A 7B             	LD	A,E
DD1B D6 20          	SUB	020H
DD1D 6F             	LD	L,A
DD1E C3 D6 F0       	JP	_LOC
DD21                
DD21                PRINT:
DD21 C5             	PUSH	BC
DD22 E5             	PUSH	HL
DD23 3E 00          ESCFLG:	LD	A,000H
DD25 B7             	OR	A
DD26 20 D6          	JR	NZ,ESC
DD28                
DD28 3E 1F          	LD	A,01FH
DD2A BB             	CP	E
DD2B 30 20          	JR	NC,CTRL
DD2D 01 E6 DE       INSFLG:	LD	BC,INSERT
DD30                
DD30 3A 18 00       	LD	A,(00018H)
DD33 3C             	INC	A
DD34 28 B3          	JR	Z,ANK
DD36 3E 00          KANFLG:	LD	A,000H
DD38 B7             	OR	A
DD39 20 25          	JR	NZ,KANJI2
DD3B 7B             	LD	A,E
DD3C FE 80          	CP	080H
DD3E 38 A9          	JR	C,ANK
DD40 FE A0          	CP	0A0H
DD42 38 04          	JR	C,KANJI1
DD44 FE E0          	CP	0E0H
DD46 38 A1          	JR	C,ANK
DD48                KANJI1:
DD48 32 37 DD       	LD	(KANFLG+1),A
DD4B 18 AD          	JR	PRINTE5
DD4D                
DD4D                CTRL:
DD4D CD 93 DD       	CALL	KANCLR
DD50 7B             	LD	A,E
DD51 87             	ADD	A,A
DD52 F6 80          	OR	080H
DD54 6F             	LD	L,A
DD55 26 F1          	LD	H,CTRLTB/256
DD57 7E             	LD	A,(HL)
DD58 2C             	INC	L
DD59 66             	LD	H,(HL)
DD5A 6F             	LD	L,A
DD5B CD 0F 00       	CALL	JP_HL
DD5E 18 9A          	JR	PRINTE5
DD60                
DD60                KANJI2:
DD60 D5             	PUSH	DE
DD61 57             	LD	D,A
DD62 01 81 2F       	LD	BC,02F81H	;SFTJIS
DD65 DF             	RST	018H
DD66 01 C3 2F       	LD	BC,02FC3H	;Instead or JISVRM
DD69 DF             	RST	018H
DD6A                
DD6A ED 4B 8E F0    	LD	BC,(_TXADR)
DD6E 78             	LD	A,B
DD6F F6 38          	OR	038H
DD71 47             	LD	B,A
DD72 ED 51          	OUT	(C),D		;kanji
DD74 CB 98          	RES	3,B
DD76 ED 59          	OUT	(C),E		;Text
DD78 CD AC DD       	CALL	PRINTE7
DD7B ED 4B 8E F0    	LD	BC,(_TXADR)
DD7F 78             	LD	A,B
DD80 F6 38          	OR	038H
DD82 47             	LD	B,A
DD83 CB F2          	SET	6,D
DD85 ED 51          	OUT	(C),D		;Kanji
DD87 CB 98          	RES	3,B
DD89 ED 59          	OUT	(C),E		;Text
DD8B D1             	POP	DE
DD8C AF             	XOR	A
DD8D 32 37 DD       	LD	(KANFLG+1),A
DD90 C3 F7 DC       	JP	KANJIE
DD93                
DD93                KANCLR:
DD93 3A 37 DD       	LD	A,(KANFLG+1)
DD96 B7             	OR	A
DD97 C8             	RET	Z
DD98 ED 4B 8E F0    	LD	BC,(_TXADR)
DD9C 78             	LD	A,B
DD9D F6 38          	OR	038H
DD9F 47             	LD	B,A
DDA0 AF             	XOR	A
DDA1 32 37 DD       	LD	(KANFLG+1),A
DDA4 ED 79          	OUT	(C),A		;Kanji
DDA6 CB 98          	RES	3,B
DDA8 3E 20          	LD	A,020H
DDAA ED 79          	OUT	(C),A		;Text
DDAC                PRINTE7:
DDAC CB A0          	RES	4,B
DDAE                PRINTE6:
DDAE 3A 96 F0       	LD	A,(_COLORF)
DDB1                PRINTE4:
DDB1 ED 79          	OUT	(C),A		;Color
DDB3 78             	LD	A,B
DDB4 E6 07          	AND	7
DDB6 47             	LD	B,A
DDB7                PRINTE2:
DDB7 03             	INC	BC
DDB8                PRINTE3:
DDB8 2A BA F0       	LD	HL,(_PAGE_MINUS)
DDBB A7             	AND	A
DDBC ED 4A          	ADC	HL,BC
DDBE                PRINTE8:
DDBE 28 05          	JR	Z,PRINT2
DDC0 ED 43 8E F0    	LD	(_TXADR),BC
DDC4                CTRL00:
DDC4 C9             	RET
DDC5                
DDC5                PRINT2:
DDC5 CD 63 DF       	CALL	SCR
DDC8 2A BC F0       	LD	HL,(_WIDTH_MINUS)
DDCB 09             	ADD	HL,BC
DDCC                SET_TXADR_HL:
DDCC 22 8E F0       	LD	(_TXADR),HL
DDCF C9             	RET
DDD0                
DDD0                CTRL08:
DDD0 3A 2D DD       	LD	A,(INSFLG)
DDD3 FE CD          	CP	0CDH		;CALL ????
DDD5 28 29          	JR	Z,CTRL02
DDD7                CTRL1D:
DDD7 2A 8E F0       	LD	HL,(_TXADR)
DDDA 7C             	LD	A,H
DDDB B5             	OR	L
DDDC C8             	RET	Z
DDDD 2B             	DEC	HL
DDDE 18 EC          	JR	SET_TXADR_HL
DDE0                
DDE0                CTRL1E:
DDE0 ED 4B 8E F0    	LD	BC,(_TXADR)
DDE4 2A BC F0       	LD	HL,(_WIDTH_MINUS)
DDE7 09             	ADD	HL,BC
DDE8 D0             	RET	NC
DDE9 18 E1          	JR	SET_TXADR_HL
DDEB                
DDEB                CTRL1C:
DDEB ED 4B 8E F0    	LD	BC,(_TXADR)
DDEF 18 C6          	JR	PRINTE2
DDF1                
DDF1                CTRL09:
DDF1 ED 4B 8E F0    	LD	BC,(_TXADR)
DDF5 79             	LD	A,C
DDF6 E6 F8          	AND	0F8H
DDF8 C6 08          	ADD	A,8
DDFA 4F             	LD	C,A
DDFB 88             	ADC	A,B
DDFC 91             	SUB	C
DDFD 47             	LD	B,A
DDFE 18 B8          	JR	PRINTE3
DE00                
DE00                CTRL02:
DE00 CD D7 DD       	CALL	CTRL1D
DE03 C8             	RET	Z
DE04 D5             	PUSH	DE
DE05 CD D3 F0       	CALL	_POS
DE08 3A B1 F0       	LD	A,(_WIDTH)
DE0B 95             	SUB	L
DE0C 4F             	LD	C,A
DE0D 0D             	DEC	C
DE0E 06 38          	LD	B,038H
DE10 2A 8E F0       	LD	HL,(_TXADR)
DE13 09             	ADD	HL,BC
DE14 44             	LD	B,H
DE15 4D             	LD	C,L
DE16 11 00 20       	LD	DE,02000H	;D:Text E:kanji
DE19 2A 96 F0       	LD	HL,(_COLORF)	;L:Color
DE1C                C8X1:
DE1C CD 02 DF       	CALL	C12S
DE1F 0B             	DEC	BC
DE20 20 FA          	JR	NZ,C8X1
DE22 D1             	POP	DE
DE23 C9             	RET
DE24                
DE24                CTRL05:
DE24 CD D3 F0       	CALL	_POS
DE27 3A B1 F0       	LD	A,(_WIDTH)
DE2A 95             	SUB	L
DE2B 6F             	LD	L,A
DE2C                C08X1:
DE2C ED 4B 8E F0    	LD	BC,(_TXADR)
DE30                LINECL:
DE30 26 20          	LD	H,020H
DE32 3A 96 F0       	LD	A,(_COLORF)
DE35 CB E8          	SET	5,B
DE37                LINECL1:
DE37 CB D8          	SET	3,B
DE39 CB E0          	SET	4,B
DE3B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DE3D CB 98          	RES	3,B
DE3F ED 61          	OUT	(C),H		;Text
DE41 CB A0          	RES	4,B
DE43 ED 79          	OUT	(C),A		;Color
DE45 03             	INC	BC
DE46 2D             	DEC	L
DE47 20 EE          	JR	NZ,LINECL1
DE49 C9             	RET
DE4A                
DE4A                CTRL0D:
DE4A CD D3 F0       	CALL	_POS
DE4D 2E 00          	LD	L,0
DE4F                LOC:
DE4F C5             	PUSH	BC
DE50 E5             	PUSH	HL
DE51 CD 93 DD       	CALL	KANCLR
DE54 CD 72 DE       	CALL	LOC1
DE57 22 8E F0       	LD	(_TXADR),HL
DE5A E1             	POP	HL
DE5B C1             	POP	BC
DE5C C9             	RET
DE5D                
DE5D                CTRL12:
DE5D 21 2D DD       	LD	HL,INSFLG
DE60 7E             	LD	A,(HL)
DE61 EE CC          	XOR	0CCH		;CD:CALL ???? 1:LD BC,????
DE63 77             	LD	(HL),A
DE64 C9             	RET
DE65                
DE65                CTRL0B:
DE65 21 00 00       	LD	HL,0
DE68 22 8E F0       	LD	(_TXADR),HL
DE6B C9             	RET
DE6C                
DE6C                CTRL1B:
DE6C 3E 01          	LD	A,1
DE6E 32 24 DD       	LD	(ESCFLG+1),A
DE71 C9             	RET
DE72                
DE72                LOC1:
DE72 D5             	PUSH	DE
DE73 4D             	LD	C,L
DE74 06 08          	LD	B,8
DE76 5C             	LD	E,H
DE77 16 00          	LD	D,0
DE79 2A B0 F0       	LD	HL,(CRTCD)
DE7C 6A             	LD	L,D
DE7D                LOC2:
DE7D 29             	ADD	HL,HL
DE7E 30 01          	JR	NC,LOC3
DE80 19             	ADD	HL,DE
DE81                LOC3:
DE81 10 FA          	DJNZ	LOC2
DE83 09             	ADD	HL,BC
DE84 D1             	POP	DE
DE85 C9             	RET
DE86                
DE86                CONOUT1:
DE86 CD 98 DE       	CALL	CURSOR
DE89 59             	LD	E,C
DE8A CD CD F0       	CALL	_PRINT
DE8D 7B             	LD	A,E
DE8E FE 0A          	CP	00AH
DE90 20 06          	JR	NZ,CURSOR
DE92 CD 4A DE       	CALL	CTRL0D
DE95 CD 24 DE       	CALL	CTRL05
DE98                CURSOR:
DE98 C5             	PUSH	BC
DE99 ED 4B 8E F0    	LD	BC,(_TXADR)
DE9D CB E8          	SET	5,B
DE9F ED 78          	IN	A,(C)
DEA1 EE 18          	XOR	018H
DEA3 ED 79          	OUT	(C),A
DEA5 C1             	POP	BC
DEA6 C9             	RET
DEA7                
DEA7                CTRL07:
DEA7 21 61 F0       	LD	HL,BEEPD
DEAA                BEEP1:
DEAA 7E             	LD	A,(HL)
DEAB 23             	INC	HL
DEAC FE FF          	CP	0FFH
DEAE C8             	RET	Z
DEAF 06 1C          	LD	B,01CH
DEB1 ED 79          	OUT	(C),A
DEB3 ED A3          	OUTI
DEB5 18 F3          	JR	BEEP1
DEB7                
DEB7                OT49SB:
DEB7 C5             	PUSH	BC
DEB8 CD D3 DE       	CALL	CANW
DEBB 01 00 19       	LD	BC,01900H
DEBE ED 79          	OUT	(C),A
DEC0 C1             	POP	BC
DEC1 C9             	RET
DEC2                
DEC2                IN49SB:
DEC2 C5             	PUSH	BC
DEC3 01 01 1A       	LD	BC,01A01H
DEC6                CANR:
DEC6 ED 78          	IN	A,(C)
DEC8 E6 20          	AND	020H
DECA 20 FA          	JR	NZ,CANR
DECC 01 00 19       	LD	BC,01900H
DECF ED 78          	IN	A,(C)
DED1 C1             	POP	BC
DED2 C9             	RET
DED3                
DED3                CANW:
DED3 01 01 1A       	LD	BC,01A01H
DED6 ED 48          	IN	C,(C)
DED8 CB 71          	BIT	6,C
DEDA 20 F7          	JR	NZ,CANW
DEDC C9             	RET
DEDD                
DEDD                COMOUT:
DEDD FB             	EI
DEDE CD B7 DE       	CALL	OT49SB
DEE1 CD D3 DE       	CALL	CANW
DEE4 F3             	DI
DEE5 C9             	RET
DEE6                
DEE6                INSERT:
DEE6 D5             	PUSH	DE
DEE7 CD D3 F0       	CALL	_POS
DEEA 3A B1 F0       	LD	A,(_WIDTH)
DEED 95             	SUB	L
DEEE ED 4B 8E F0    	LD	BC,(_TXADR)
DEF2 11 00 20       	LD	DE,02000H	;D:Text E:Kanji
DEF5 2A 96 F0       	LD	HL,(_COLORF)	;L:Color
DEF8 CB E8          	SET	5,B
DEFA                C12X1:
DEFA CD 02 DF       	CALL	C12S
DEFD 03             	INC	BC
DEFE 20 FA          	JR	NZ,C12X1
DF00 D1             	POP	DE
DF01 C9             	RET
DF02                
DF02                C12S:
DF02 CB E0          	SET	4,B
DF04 CB D8          	SET	3,B
DF06 ED 60          	IN	H,(C)
DF08 ED 59          X1PAT:	OUT	(C),E
DF0A 5C             	LD	E,H
DF0B CB 98          	RES	3,B
DF0D ED 60          	IN	H,(C)
DF0F ED 51          	OUT	(C),D
DF11 54             	LD	D,H
DF12 CB A0          	RES	4,B
DF14 ED 60          	IN	H,(C)
DF16 ED 69          	OUT	(C),L
DF18 6C             	LD	L,H
DF19 3D             	DEC	A
DF1A C9             	RET
DF1B                
DF1B                CTRL0C:
DF1B CD 65 DE       	CALL	CTRL0B
DF1E                CTRL06:
DF1E ED 4B 8E F0    	LD	BC,(_TXADR)
DF22                C1AX1:
DF22 78             	LD	A,B
DF23 F6 38          	OR	038H
DF25 47             	LD	B,A
DF26 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DF28 CB 98          	RES	3,B
DF2A 3E 20          	LD	A,020H
DF2C ED 79          	OUT	(C),A		;Text
DF2E CB A0          	RES	4,B
DF30 3A 96 F0       	LD	A,(_COLORF)
DF33 ED 79          	OUT	(C),A		;Color
DF35 03             	INC	BC
DF36 CB A8          	RES	5,B
DF38 2A BA F0       	LD	HL,(_PAGE_MINUS)
DF3B 09             	ADD	HL,BC
DF3C 30 E4          	JR	NC,C1AX1
DF3E C9             	RET
DF3F                
DF3F                CTRL04:
DF3F CD D3 F0       	CALL	_POS
DF42 7D             	LD	A,L
DF43 B7             	OR	A
DF44 C8             	RET	Z
DF45                CTRL03:
DF45 CD 4A DE       	CALL	CTRL0D
DF48                CTRL0A:
DF48                CTRL1F:
DF48 ED 4B 8E F0    	LD	BC,(_TXADR)
DF4C 2A B1 F0       	LD	HL,(_WIDTH)
DF4F 26 00          	LD	H,0
DF51 09             	ADD	HL,BC
DF52 44             	LD	B,H
DF53 4D             	LD	C,L
DF54 2A BA F0       	LD	HL,(_PAGE_MINUS)
DF57 09             	ADD	HL,BC
DF58 3F             	CCF
DF59 9F             	SBC	A,A
DF5A C3 BE DD       	JP	PRINTE8
DF5D                
DF5D                CTRL0E:
DF5D CD D3 F0       	CALL	_POS
DF60 7C             	LD	A,H
DF61 18 04          	JR	SCR1
DF63                SCR:
DF63 3A 97 F0       	LD	A,(_LINE)
DF66 3D             	DEC	A
DF67                SCR1:
DF67 C5             	PUSH	BC
DF68 D5             	PUSH	DE
DF69 F5             	PUSH	AF
DF6A 3E 07          	LD	A,7
DF6C 21 9D DF       	LD	HL,SCRDMAD
DF6F CD 93 DF       	CALL	SETDMA
DF72 F1             	POP	AF
DF73 21 00 38       	LD	HL,03800H
DF76                
DF76                SCRUP1:
DF76 B7             	OR	A
DF77 28 4D          	JR	Z,SCRCL
DF79 F5             	PUSH	AF
DF7A CD A4 DF       	CALL	UPSUB		;kanji
DF7D 3A BC F0       	LD	A,(_WIDTH_MINUS)
DF80 5F             	LD	E,A
DF81 16 F7          	LD	D,0F7H
DF83 19             	ADD	HL,DE
DF84 D5             	PUSH	DE
DF85 CD A4 DF       	CALL	UPSUB		;Text
DF88 D1             	POP	DE
DF89 19             	ADD	HL,DE
DF8A CD A4 DF       	CALL	UPSUB		;Color
DF8D CB E4          	SET	4,H
DF8F F1             	POP	AF
DF90 3D             	DEC	A
DF91 18 E3          	JR	SCRUP1
DF93                
DF93                SETDMA:
DF93 01 87 1F       	LD	BC,01F87H
DF96                SDMA:
DF96 04             	INC	B
DF97 ED A3          	OUTI
DF99 3D             	DEC	A
DF9A 20 FA          	JR	NZ,SDMA
DF9C C9             	RET
DF9D                
DF9D                SCRDMAD:
DF9D C3             	DB	0C3H		;WR6 リセット
DF9E 9A             	DB	09AH		;WR5 ストップ WAIT READY:HIGH
DF9F 65             	DB	065H		;WR0 ブロック長(LH)
DFA0 4F 00          	DW	79
DFA2 1C             	DB	01CH		;WR1 ポートAインクリメント I/O
DFA3 18             	DB	018H		;WR0 ポートAアドレス(LH)
DFA4                
DFA4                UPSUB:
DFA4 3A B1 F0       	LD	A,(_WIDTH)
DFA7 5F             	LD	E,A
DFA8 16 00          	LD	D,0
DFAA 3E CD          	LD	A,0CDH		;WR4 バースト ポートB開始アドレス(LH)
DFAC ED 79          	OUT	(C),A
DFAE ED 69          	OUT	(C),L		;SOURCE
DFB0 ED 61          	OUT	(C),H
DFB2 19             	ADD	HL,DE
DFB3 3E 1D          	LD	A,01DH		;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
DFB5 ED 79          	OUT	(C),A
DFB7 ED 69          	OUT	(C),L		;DEST
DFB9 ED 61          	OUT	(C),H
DFBB                GO_DMA:
DFBB 3E CF          	LD	A,0CFH
DFBD ED 79          	OUT	(C),A		;WR6 ロード
DFBF 3E B3          	LD	A,0B3H
DFC1 ED 79          	OUT	(C),A		;WR6 強制RDY
DFC3 ED 49          	OUT	(C),C		;WR6 イネーブル
DFC5 C9             	RET
DFC6                
DFC6                SCRCL:
DFC6 44             	LD	B,H
DFC7 4D             	LD	C,L
DFC8 2A B1 F0       	LD	HL,(_WIDTH)
DFCB CD 30 DE       	CALL	LINECL
DFCE D1             	POP	DE
DFCF C1             	POP	BC
DFD0 C9             	RET
DFD1                
DFD1                SCRN:
DFD1 D5             	PUSH	DE
DFD2 ED 58          	IN	E,(C)		;Text
DFD4 3A 18 00       	LD	A,(00018H)
DFD7 3C             	INC	A
DFD8 28 1E          	JR	Z,SCRN2
DFDA CB D8          	SET	3,B
DFDC ED 50          	IN	D,(C)		;Kanji
DFDE 28 16          	JR	Z,SCRN1
DFE0 AF             	XOR	A
DFE1 C5             	PUSH	BC
DFE2 01 37 30       	LD	BC,03037H	;VRMJIS
DFE5 DF             	RST	018H
DFE6 01 52 2F       	LD	BC,02F52H	;JISSFT
DFE9 DF             	RST	018H
DFEA C1             	POP	BC
DFEB ED 78          	IN	A,(C)
DFED CB 98          	RES	3,B
DFEF E6 40          	AND	040H
DFF1 20 05          	JR	NZ,SCRN2
DFF3 7A             	LD	A,D
DFF4 D1             	POP	DE
DFF5 C9             	RET
DFF6                SCRN1:
DFF6 CB 98          	RES	3,B
DFF8                SCRN2:
DFF8 7B             	LD	A,E
DFF9 D1             	POP	DE
DFFA C9             	RET
DFFB                SCRNE:
DFFB                POS:
DFFB 2A 8E F0       	LD	HL,(_TXADR)
DFFE C5             	PUSH	BC
DFFF ED 4B BC F0    	LD	BC,(_WIDTH_MINUS)
E003 AF             	XOR	A
E004                POS1:
E004 09             	ADD	HL,BC
E005 3C             	INC	A
E006 38 FC          	JR	C,POS1
E008 ED 42          	SBC	HL,BC
E00A 3D             	DEC	A
E00B 67             	LD	H,A
E00C C1             	POP	BC
E00D A7             	AND	A
E00E C9             	RET
E00F                
E00F                GETL:
E00F CD D3 F0       	CALL	_POS
E012 E5             	PUSH	HL
E013 3E CD          	LD	A,0CDH		;CALL ????
E015 32 2D DD       	LD	(INSFLG),A
E018                GETL1:
E018 CD D4 DB       	CALL	_SYS08
E01B FE 09          	CP	9
E01D 20 08          	JR	NZ,GETL1V
E01F 21 20 FF       	LD	HL,KBUF
E022 CD 70 D8       	CALL	MSX
E025 18 F1          	JR	GETL1
E027                GETL1V:
E027 5F             	LD	E,A
E028 CD CD F0       	CALL	_PRINT
E02B                
E02B 7B             	LD	A,E
E02C FE 0D          	CP	00DH
E02E 20 E8          	JR	NZ,GETL1
E030 3E 01          	LD	A,1		;LD BC,????
E032 32 2D DD       	LD	(INSFLG),A
E035 11 20 FF       	LD	DE,KBUF
E038 3A B1 F0       	LD	A,(_WIDTH)
E03B 47             	LD	B,A
E03C CD D3 D5       	CALL	ZERO_MEMORY_DE
E03F                
E03F D1             	POP	DE
E040 CD D3 F0       	CALL	_POS
E043 6B             	LD	L,E
E044 3A B1 F0       	LD	A,(_WIDTH)
E047 95             	SUB	L
E048 57             	LD	D,A
E049 CD 72 DE       	CALL	LOC1
E04C 4D             	LD	C,L
E04D 7C             	LD	A,H
E04E F6 30          	OR	030H
E050 47             	LD	B,A
E051 5A             	LD	E,D
E052 21 20 FF       	LD	HL,KBUF
E055                GETL2:
E055 CD D0 F0       	CALL	_SCRN
E058 03             	INC	BC
E059 77             	LD	(HL),A
E05A 23             	INC	HL
E05B 1D             	DEC	E
E05C 20 F7          	JR	NZ,GETL2
E05E                GETL3:
E05E 2B             	DEC	HL
E05F 7E             	LD	A,(HL)
E060 FE 21          	CP	021H
E062 D0             	RET	NC
E063 36 00          	LD	(HL),0
E065 15             	DEC	D
E066 20 F6          	JR	NZ,GETL3
E068 C9             	RET
E069                
E069                INKEY:
E069 FB             	EI
E06A E5             	PUSH	HL
E06B 2A 90 F0       	LD	HL,(_KEYPS)
E06E 7C             	LD	A,H
E06F AD             	XOR	L
E070 28 0B          	JR	Z,INKEY1
E072 7C             	LD	A,H
E073 3C             	INC	A
E074 E6 1F          	AND	01FH
E076 32 91 F0       	LD	(_KEYPS+1),A
E079 6F             	LD	L,A
E07A 26 FF          	LD	H,KEYBF/256
E07C 7E             	LD	A,(HL)
E07D                INKEY1:
E07D E1             	POP	HL
E07E B7             	OR	A
E07F C9             	RET
E080                
E080 00 00 0F 4B    AT_RS	EQU	SCR1-AT_SCR1
E080                	INCLUDE	"LDFILE.ASM"
E080                
E080                ;	LSX-Dodgers FILE
E080                
E080                FILEC:
E080 CD 8B E0       	CALL	FILE
E083                FILEC2:
E083 3A 15 F0       	LD	A,(FDRV+1)
E086 FE 20          	CP	020H
E088 C8             	RET	Z
E089 18 39          	JR	SETDIR1
E08B                
E08B                FILE:
E08B AF             	XOR	A
E08C 32 14 F0       	LD	(FDRV),A
E08F 67             	LD	H,A
E090 6F             	LD	L,A
E091 22 22 F0       	LD	(FDRV+14),HL
E094 CD 62 E1       	CALL	SPCUT
E097 CD 47 E1       	CALL	CCHK3
E09A 28 12          	JR	Z,DEVI1
E09C 13             	INC	DE
E09D 1A             	LD	A,(DE)
E09E 1B             	DEC	DE
E09F FE 3A          	CP	':'
E0A1 20 0B          	JR	NZ,DEVI1
E0A3 1A             	LD	A,(DE)		;DRIVE
E0A4 CD 97 E3       	CALL	CAP
E0A7 D6 40          	SUB	'@'
E0A9 13             	INC	DE
E0AA 13             	INC	DE
E0AB 32 14 F0       	LD	(FDRV),A
E0AE                DEVI1:
E0AE 1A             	LD	A,(DE)
E0AF D6 5C          	SUB	05CH		;\
E0B1 20 09          	JR	NZ,NOROOT
E0B3 6F             	LD	L,A		;A=0でH=0のはずなのでHL=0
E0B4 22 2E F0       	LD	(FDRV+26),HL
E0B7 2C             	INC	L
E0B8 22 22 F0       	LD	(FDRV+14),HL
E0BB 13             	INC	DE
E0BC                NOROOT:
E0BC                
E0BC                SETDIR:
E0BC CD E8 E0       	CALL	FILED
E0BF 1A             	LD	A,(DE)
E0C0 FE 5C          	CP	05CH		;\
E0C2 C0             	RET	NZ
E0C3 13             	INC	DE
E0C4                SETDIR1:
E0C4 3E 10          	LD	A,010H		;Directory
E0C6 32 21 F0       	LD	(FDRV+13),A
E0C9 D5             	PUSH	DE
E0CA 11 14 F0       	LD	DE,FDRV
E0CD 2A 1E F1       	LD	HL,(STABLE+2*00FH)
E0D0 CD 0F 00       	CALL	JP_HL
E0D3 D1             	POP	DE
E0D4 B7             	OR	A
E0D5 C0             	RET	NZ
E0D6                
E0D6 3A 21 F0       	LD	A,(FDRV+13)
E0D9 CB 67          	BIT	4,A
E0DB C8             	RET	Z
E0DC                
E0DC CD 2F E1       	CALL	FILEI
E0DF 2A 2E F0       	LD	HL,(FDRV+26)
E0E2 23             	INC	HL
E0E3 22 22 F0       	LD	(FDRV+14),HL
E0E6 18 D4          	JR	SETDIR
E0E8                
E0E8                FILED:
E0E8 CD 2F E1       	CALL	FILEI
E0EB 21 15 F0       	LD	HL,FNAME
E0EE                
E0EE 06 08          	LD	B,8
E0F0                FILE2:
E0F0 CD 3C E1       	CALL	CCHKF
E0F3 C8             	RET	Z
E0F4 FE 2A          	CP	'*'
E0F6 28 2E          	JR	Z,FILE9
E0F8 FE 2E          	CP	'.'
E0FA 28 0C          	JR	Z,FILE4
E0FC 77             	LD	(HL),A
E0FD 23             	INC	HL
E0FE 10 F0          	DJNZ	FILE2
E100                
E100                FILE3:
E100 CD 3C E1       	CALL	CCHKF
E103 C8             	RET	Z
E104 FE 2E          	CP	'.'
E106 20 F8          	JR	NZ,FILE3
E108                
E108                FILE4:
E108 21 1D F0       	LD	HL,FNAME+8
E10B 06 03          	LD	B,3
E10D                
E10D                FILE4L:
E10D CD 3C E1       	CALL	CCHKF
E110 C8             	RET	Z
E111 FE 2E          	CP	'.'
E113 20 08          	JR	NZ,FILE12
E115 32 15 F0       	LD	(FNAME),A	;Parent directory(..)
E118 32 16 F0       	LD	(FNAME+1),A
E11B 3E 20          	LD	A,020H
E11D                FILE12:
E11D FE 2A          	CP	'*'
E11F 28 0A          	JR	Z,FILE10
E121 77             	LD	(HL),A
E122 23             	INC	HL
E123 10 E8          	DJNZ	FILE4L
E125 C9             	RET
E126                
E126                FILE9:				;名前の*処理、名前の残りを?で埋める
E126 CD 2B E1       	CALL	FILE10
E129 18 D5          	JR	FILE3
E12B                
E12B                FILE10:
E12B 3E 3F          	LD	A,'?'
E12D 18 08          	JR	FILL_MEMORY
E12F                FILEI:				;名前＋拡張子をスペースで初期化
E12F 3E 20          	LD	A,020H
E131 01 00 0B       	LD	BC,11*256	;C=0にしておく
E134 21 15 F0       	LD	HL,FNAME
E137                FILL_MEMORY:			;HLからBバイトAで埋める
E137 77             	LD	(HL),A
E138 23             	INC	HL
E139 10 FC          	DJNZ	FILL_MEMORY
E13B C9             	RET
E13C                
E13C                CCHKF:
E13C 1A             	LD	A,(DE)
E13D CD 44 E1       	CALL	CCHK2
E140 C8             	RET	Z
E141 C3 AF E4       	JP	FKAN
E144                
E144                CCHK2:
E144 0C             	INC	C
E145 0D             	DEC	C
E146 C0             	RET	NZ
E147                CCHK3:				;ZF=1 で使えない文字
E147 FE 2B          	CP	'+'
E149 C8             	RET	Z
E14A FE 2C          	CP	','
E14C C8             	RET	Z
E14D FE 2F          	CP	'/'
E14F C8             	RET	Z
E150 FE 3A          	CP	':'
E152 C8             	RET	Z
E153 FE 3B          	CP	';'
E155 C8             	RET	Z
E156 FE 3D          	CP	'='
E158 C8             	RET	Z
E159 FE 5C          	CP	05CH	;\
E15B C8             	RET	Z
E15C FE 20          	CP	020H
E15E D0             	RET	NC
E15F BF             	CP	A		;Z=1
E160 C9             	RET
E161                
E161                SS1:
E161 13             	INC	DE
E162                SPCUT:				;スペースをカット
E162 1A             	LD	A,(DE)
E163 FE 20          	CP	020H
E165 28 FA          	JR	Z,SS1
E167 C9             	RET
E168                
E168                SETDRVF:
E168 11 14 F0       	LD	DE,FDRV
E16B                SETDRV0:
E16B CD 74 E1       	CALL	SETDRV
E16E FD E1          	POP	IY
E170 C1             	POP	BC
E171 D1             	POP	DE
E172 E1             	POP	HL
E173 C9             	RET
E174                
E174                SETDRV:
E174 E3             	EX	(SP),HL		;HL=RETRN ADDRESS
E175 D5             	PUSH	DE		;PUSH HL/DE/BC/IY
E176 C5             	PUSH	BC
E177 1A             	LD	A,(DE)
E178 D5             	PUSH	DE
E179 FD E3          	EX	(SP),IY
E17B                
E17B CD 87 E1       	CALL	GETDRV
E17E 3C             	INC	A
E17F FD 77 00       	LD	(IY+0),A	;(FCB)ドライブ番号
E182 3D             	DEC	A
E183 CD D9 F0       	CALL	_CHGDRV
E186                
E186 E9             	JP	(HL)
E187                
E187                GETDRV:
E187 E6 7F          	AND	07FH
E189 D6 01          	SUB	001H
E18B 30 03          	JR	NC,GETDRV1
E18D 3A 87 F0       	LD	A,(_DVSW)	;Current Drive
E190                GETDRV1:
E190 32 88 F0       	LD	(_DRV),A
E193 C9             	RET
E194                
E194                SOPENX:
E194 11 39 F0       	LD	DE,SFILE
E197 1A             	LD	A,(DE)
E198 FD BE 00       	CP	(IY+0)		;(FCB)ドライブ番号
E19B 20 24          	JR	NZ,SOPEN
E19D 13             	INC	DE
E19E FD E5          	PUSH	IY
E1A0 E1             	POP	HL
E1A1 23             	INC	HL
E1A2 CD 2F E3       	CALL	CPFILE
E1A5 20 1A          	JR	NZ,SOPEN
E1A7                
E1A7 2A F4 F1       	LD	HL,(SCDIR)
E1AA FD 75 0E       	LD	(IY+14),L	;(FCB)アクセスするディレクトリのクラスタ番号+1
E1AD FD 74 0F       	LD	(IY+15),H
E1B0                
E1B0 2A F8 F1       	LD	HL,(SFNDF)	;Direcroty location and Flags
E1B3 22 9F F0       	LD	(_FILEN),HL
E1B6                
E1B6 ED 5B F6 F1    	LD	DE,(SFBPS)
E1BA 21 39 F0       	LD	HL,SFILE
E1BD 36 FF          	LD	(HL),0FFH
E1BF 23             	INC	HL
E1C0 C9             	RET
E1C1                SOPEN:
E1C1 21 D7 E2       	LD	HL,FILESE
E1C4                SOPENC:
E1C4 22 FD E1       	LD	(OPENPAT+1),HL
E1C7                
E1C7 CD E2 F0       	CALL	_RDFATX		;Detect Media
E1CA 38 56          	JR	C,RDDERR
E1CC                
E1CC AF             	XOR	A
E1CD 32 9F F0       	LD	(_FILEN),A
E1D0 CD DC E3       	CALL	LDDIRX1		;A=0で呼び出す
E1D3 28 18          	JR	Z,SDIRX1
E1D5                
E1D5 CD C8 E2       	CALL	READ_DIR	;Sub Directory
E1D8 38 08          	JR	C,SDIRX0
E1DA 2A 7E F1       	LD	HL,(_DTBUF)
E1DD 7E             	LD	A,(HL)
E1DE FE 2E          	CP	'.'
E1E0 28 0F          	JR	Z,SOPEN1
E1E2                SDIRX0:
E1E2 AF             	XOR	A
E1E3 32 A0 F0       	LD	(_DIRF),A
E1E6 FD 36 0E 01    	LD	(IY+14),1	;(FCB)レコードサイズ
E1EA FD 77 0F       	LD	(IY+15),A
E1ED                SDIRX1:
E1ED ED 5B FC F1    	LD	DE,(_DIRPS)	;Root Directory
E1F1                SOPEN1:
E1F1 0E 20          SDECPAT:LD	C,32		;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
E1F3                SOPEN1X:
E1F3 CD C8 E2       	CALL	READ_DIR	;FILE SEARCH
E1F6 38 2A          	JR	C,RDDERR
E1F8 2A 7E F1       	LD	HL,(_DTBUF)
E1FB                SOPEN2:
E1FB D5             	PUSH	DE
E1FC CD D7 E2       OPENPAT:CALL	FILESE		;(self-modifying code)
E1FF D1             	POP	DE
E200 38 6E          	JR	C,SOPENE
E202 28 1B          	JR	Z,SCF_FF_RET
E204                SOPEN3:
E204 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E207 B7             	OR	A
E208 20 0C          	JR	NZ,SOPEN5
E20A 13             	INC	DE		;ルートディレクトリ
E20B E5             	PUSH	HL
E20C 21 0C 00       MD_PAT:	LD	HL,12		;(self-modifying code)MAXDIR
E20F ED 52          	SBC	HL,DE		;CF=0 なので SUB HL,DE
E211 E1             	POP	HL
E212 20 DD          	JR	NZ,SOPEN1
E214 18 07          	JR	SOPEN6
E216                SOPEN5:
E216 CD 0B EB       	CALL	GNCLX		;END DIR
E219 D8             	RET	C
E21A CD 8F E3       	CALL	ENDCL
E21D                SOPEN6:
E21D 38 D2          	JR	C,SOPEN1
E21F                SCF_FF_RET:
E21F 37             	SCF			;CF=1
E220 9F             	SBC	A,A		;A=0FFH
E221 C9             	RET
E222                
E222                RDDERR:
E222 BF             	CP	A		;READ ERR CF=1 ZF=1
E223 37             	SCF
E224 C9             	RET
E225                
E225                NOPEN:
E225 21 D7 E2       	LD	HL,FILESE
E228 22 FD E1       	LD	(OPENPAT+1),HL
E22B FD 2A 98 F0    	LD	IY,(_FCB)
E22F CD C2 E4       	CALL	CHKWILDX
E232 30 EB          	JR	NC,SCF_FF_RET
E234 FD 7E 00       	LD	A,(IY+0)	;(FCB)ドライブ番号
E237 3D             	DEC	A
E238 32 88 F0       	LD	(_DRV),A
E23B CD D9 F0       	CALL	_CHGDRV
E23E D8             	RET	C
E23F 2A F8 F1       	LD	HL,(SFNDF)	;Direcroty location and Flags
E242 22 9F F0       	LD	(_FILEN),HL
E245                
E245 CD D7 E3       	CALL	LDDIRX
E248 ED 5B 9A F0    	LD	DE,(_FBPS)
E24C CD C8 E2       	CALL	READ_DIR
E24F 38 D1          	JR	C,RDDERR
E251 3A 9E F0       	LD	A,(_FBCNT)
E254 3D             	DEC	A
E255 28 AD          	JR	Z,SOPEN3
E257                NOPEN2:
E257 2A 9C F0       	LD	HL,(_FBAD)
E25A 01 20 00       	LD	BC,020H
E25D 09             	ADD	HL,BC
E25E 4F             	LD	C,A
E25F 18 9A          	JR	SOPEN2
E261                
E261                SOPENE2:
E261 22 9C F0       	LD	(_FBAD),HL
E264 79             	LD	A,C
E265 32 9E F0       	LD	(_FBCNT),A
E268 ED 53 9A F0    	LD	(_FBPS),DE
E26C FD 22 98 F0    	LD	(_FCB),IY
E270                SOPENE:
E270 AF             	XOR	A
E271 C9             	RET
E272                
E272                COPEN:
E272 FD 36 0D 20    	LD	(IY+13),020H	;(FCB)属性(アトリビュート)
E276                
E276 21 F4 E2       	LD	HL,NEXTSE
E279 CD C4 E1       	CALL	SOPENC
E27C D0             	RET	NC
E27D C8             	RET	Z
E27E 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E281 B7             	OR	A
E282 37             	SCF
E283 C8             	RET	Z		;ルートディレクトリ
E284 06 01          	LD	B,1
E286 CD 20 E5       	CALL	WRDF
E289 D8             	RET	C
E28A ED 5B FE F1    	LD	DE,(_CLPS)
E28E D5             	PUSH	DE
E28F CD 58 E3       	CALL	DCPAT
E292 CD 96 E9       	CALL	DRDNX
E295 2A 7E F1       	LD	HL,(_DTBUF)	;ディレクトリエントリを0クリア
E298 3A 94 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E29B 47             	LD	B,A
E29C AF             	XOR	A
E29D 4F             	LD	C,A
E29E                COPENCL:
E29E 77             	LD	(HL),A
E29F ED A1          	CPI			;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
E2A1 EA 9E E2       	JP	PE,COPENCL
E2A4                
E2A4 3A 76 E3       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ数
E2A7 3D             	DEC	A
E2A8 28 19          	JR	Z,COPENE
E2AA 3E 01          	LD	A,1		;1セクタ辺りのセクタ数が2以上の場合
E2AC 32 03 EB       	LD	(_SECPS+1),A
E2AF D1             	POP	DE		;DE=(_CLPS)
E2B0 D5             	PUSH	DE
E2B1                COPEN1:
E2B1 D5             	PUSH	DE		;データバッファに入らないセクタもゼロクリア
E2B2 C5             	PUSH	BC
E2B3 2A 7E F1       	LD	HL,(_DTBUF)
E2B6 CD 72 E3       	CALL	CLUSTX
E2B9 CD 9B EC       	CALL	DWT24
E2BC C1             	POP	BC
E2BD D1             	POP	DE
E2BE CD 02 EB       	CALL	NEXTX
E2C1 20 EE          	JR	NZ,COPEN1
E2C3                COPENE:
E2C3 2A 7E F1       	LD	HL,(_DTBUF)
E2C6 D1             	POP	DE
E2C7 C9             	RET
E2C8                
E2C8                READ_DIR:
E2C8 ED 53 FE F1    	LD	(_CLPS),DE
E2CC C5             	PUSH	BC
E2CD D5             	PUSH	DE
E2CE CD 58 E3       	CALL	DCPAT
E2D1 CD 76 E9       	CALL	DRDX
E2D4 D1             	POP	DE
E2D5 C1             	POP	BC
E2D6 C9             	RET
E2D7                
E2D7                FILESE:
E2D7 7E             	LD	A,(HL)
E2D8 B7             	OR	A
E2D9 C8             	RET	Z		;END:ZF=1 CF=0
E2DA FE E5          	CP	0E5H
E2DC 28 0E          	JR	Z,FILESE1
E2DE FD E5          	PUSH	IY
E2E0 D1             	POP	DE
E2E1 13             	INC	DE
E2E2 E5             	PUSH	HL
E2E3 CD 2F E3       	CALL	CPFILE
E2E6 CC 50 E3       	CALL	Z,CPFILE2
E2E9 E1             	POP	HL
E2EA 37             	SCF
E2EB C8             	RET	Z		;!!!:(ZF=1) CF=1
E2EC                FILESE1:
E2EC CD 03 E3       	CALL	FNEXT
E2EF 20 E6          	JR	NZ,FILESE
E2F1                ZF0_CF0_AFF_RET:
E2F1 F6 FF          	OR	0FFH		;ZF=0 CF=0
E2F3 C9             	RET
E2F4                
E2F4                NEXTSE:
E2F4 7E             	LD	A,(HL)
E2F5 B7             	OR	A
E2F6 37             	SCF
E2F7 C8             	RET	Z		;!!!:ZF=1 CF=1
E2F8 FE E5          	CP	0E5H
E2FA 37             	SCF
E2FB C8             	RET	Z		;!!!:(ZF=1) CF=1
E2FC CD 03 E3       	CALL	FNEXT
E2FF 20 F3          	JR	NZ,NEXTSE
E301 18 EE          	JR	ZF0_CF0_AFF_RET
E303                
E303                FNEXT:
E303 E5             	PUSH	HL
E304 21 9F F0       	LD	HL,_FILEN
E307 34             	INC	(HL)
E308 E1             	POP	HL
E309 11 20 00       	LD	DE,020H
E30C 19             	ADD	HL,DE
E30D 0D             	DEC	C
E30E C9             	RET
E30F                
E30F                CPNAME:
E30F C5             	PUSH	BC
E310 D5             	PUSH	DE
E311 E5             	PUSH	HL
E312 CD 29 E3       	CALL	CPFILE4
E315 E1             	POP	HL
E316 23             	INC	HL
E317 23             	INC	HL
E318 23             	INC	HL
E319 23             	INC	HL
E31A D1             	POP	DE
E31B C1             	POP	BC
E31C 20 05          	JR	NZ,CPNAME1
E31E 7E             	LD	A,(HL)
E31F 23             	INC	HL
E320 66             	LD	H,(HL)
E321 6F             	LD	L,A
E322 C9             	RET
E323                CPNAME1:
E323 23             	INC	HL
E324 23             	INC	HL
E325 10 E8          	DJNZ	CPNAME
E327 37             	SCF
E328 C9             	RET
E329                
E329                CPFILE4:
E329 C5             	PUSH	BC
E32A 01 00 04       	LD	BC,00400H
E32D 18 04          	JR	CPSTR1
E32F                CPFILE:
E32F C5             	PUSH	BC
E330 01 00 0B       	LD	BC,00B00H
E333                CPSTR1:
E333 1A             	LD	A,(DE)
E334 FE 3F          	CP	'?'		;Wild card
E336 28 12          	JR	Z,CPSTR2
E338 7E             	LD	A,(HL)
E339 CD A8 E4       	CALL	FKANC
E33C E5             	PUSH	HL
E33D 67             	LD	H,A
E33E 1A             	LD	A,(DE)
E33F CB 01          	RLC	C
E341 CD A8 E4       	CALL	FKANC
E344 CB 09          	RRC	C
E346 BC             	CP	H		;CP (HL),(DE)
E347 E1             	POP	HL
E348 20 04          	JR	NZ,CPSTR3
E34A                CPSTR2:
E34A 13             	INC	DE
E34B 23             	INC	HL
E34C 10 E5          	DJNZ	CPSTR1
E34E                CPSTR3:
E34E C1             	POP	BC
E34F C9             	RET
E350                
E350                CPFILE2:
E350 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E353 F6 E1          	OR	0E1H
E355 2F             	CPL
E356 A6             	AND	(HL)
E357 C9             	RET
E358                
E358                DCPAT:
E358 0E 00          	LD	C,0
E35A 2A 7E F1       	LD	HL,(_DTBUF)
E35D 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E360 B7             	OR	A
E361 C8             	RET	Z		;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
E362 3A 76 E3       	LD	A,(SPCPAT+1)
E365 4F             	LD	C,A
E366 3A 03 EB       	LD	A,(_SECPS+1)
E369 B9             	CP	C
E36A 38 01          	JR	C,DC1
E36C AF             	XOR	A
E36D                DC1:
E36D F6 80          	OR	080H
E36F 32 A0 F0       	LD	(_DIRF),A	;bit0-6:セクタインデックス
E372                CLUSTX:
E372 E5             	PUSH	HL
E373 EB             	EX	DE,HL
E374 AF             	XOR	A
E375 0E 01          SPCPAT:	LD	C,1		;自己書き換え（1クラスタの論理セクタ数）
E377                L_CLDBL:
E377 CB 19          	RR	C		;->CF
E379 38 04          	JR	C,E_CLDBL
E37B 29             	ADD	HL,HL		;*2
E37C 8F             	ADC	A,A
E37D 18 F8          	JR	L_CLDBL
E37F                E_CLDBL:
E37F 4F             	LD	C,A
E380 3A 03 EB       	LD	A,(_SECPS+1)
E383 B5             	OR	L
E384 6F             	LD	L,A
E385 11 08 00       CLSPAT:	LD	DE,8	;+8 (2D)  !ADDCL (self-modifying code)
E388 AF             	XOR	A
E389 19             	ADD	HL,DE	;データ格納領域の先頭論理セクタ番号
E38A 89             	ADC	A,C
E38B 4F             	LD	C,A
E38C EB             	EX	DE,HL
E38D E1             	POP	HL
E38E C9             	RET
E38F                
E38F                ENDCL:
E38F 7A             	LD	A,D	;END CLUSTER
E390 FE 01          CLPAT1:	CP	1	;164=356	(self-modifying code)
E392 C0             	RET	NZ
E393 7B             	LD	A,E
E394 FE 64          CLPAT2:	CP	064H	;		(self-modifying code)
E396 C9             	RET
E397                
E397                CAP:
E397 FE 61          	CP	'a'
E399 D8             	RET	C
E39A FE 7B          	CP	'z'+1
E39C D0             	RET	NC
E39D D6 20          	SUB	020H
E39F C9             	RET
E3A0                CAP2:
E3A0 CD 97 E3       	CALL	CAP
E3A3                CAP3:
E3A3 CD AC E3       	CALL	CAP4
E3A6 FE 21          	CP	021H
E3A8 D0             	RET	NC
E3A9 3E A0          	LD	A,0A0H
E3AB C9             	RET
E3AC                CAP4:
E3AC FE 05          	CP	5
E3AE C0             	RET	NZ
E3AF 3E E5          	LD	A,0E5H
E3B1 C9             	RET
E3B2                
E3B2                CHDIR:
E3B2 CD C9 ED       	CALL	GETDPBD
E3B5 38 1D          	JR	C,CHDIR2
E3B7 DD 75 1A       	LD	(IX+01AH),L		;_SDIR_
E3BA DD 74 1B       	LD	(IX+01BH),H		;_SDIR_+1
E3BD 18 15          	JR	CHDIR2		;POP_IX_RET
E3BF                
E3BF                LDDIR:
E3BF CD C9 ED       	CALL	GETDPBD
E3C2 DD 5E 1A       	LD	E,(IX+01AH)		;_SDIR_
E3C5 DD 56 1B       	LD	D,(IX+01BH)		;_SDIR_+1
E3C8 13             	INC	DE
E3C9 FD 73 0E       	LD	(IY+14),E	;(FCB)アクセスするディレクトリのクラスタ番号+1
E3CC FD 72 0F       	LD	(IY+15),D
E3CF 1B             	DEC	DE
E3D0 AF             	XOR	A
E3D1 32 A0 F0       	LD	(_DIRF),A
E3D4                CHDIR2:
E3D4 DD E1          	POP	IX
E3D6 C9             	RET
E3D7                
E3D7                LDDIRX:
E3D7 3A A0 F0       	LD	A,(_DIRF)	;(FCB)アクセスするディレクトリのセクタインデックス
E3DA E6 7F          	AND	07FH
E3DC                LDDIRX1:
E3DC 32 03 EB       	LD	(_SECPS+1),A
E3DF FD 5E 0E       	LD	E,(IY+14)	;(FCB)アクセスするディレクトリのクラスタ番号+1
E3E2 FD 56 0F       	LD	D,(IY+15)
E3E5 1B             	DEC	DE
E3E6 CD 8F E3       	CALL	ENDCL
E3E9 D4 BF E3       	CALL	NC,LDDIR
E3EC                LDDIRS:
E3EC 7A             	LD	A,D
E3ED B3             	OR	E
E3EE 32 A0 F0       	LD	(_DIRF),A	;ディレクトリか判別
E3F1 C9             	RET
E3F2                
E3F2                KILL:
E3F2 CD C2 E4       	CALL	CHKWILDX
E3F5 38 34          	JR	C,KILLW
E3F7 CD 94 E1       	CALL	SOPENX
E3FA                KILLS:
E3FA 3E 1F          	LD	A,01FH
E3FC D4 3E E4       	CALL	NC,CHKATT
E3FF D8             	RET	C
E400                KILLSX:
E400 36 E5          	LD	(HL),0E5H	;DIR
E402 CD 9C E4       	CALL	WTDB
E405 11 1A 00       	LD	DE,01AH
E408 19             	ADD	HL,DE
E409 5E             	LD	E,(HL)
E40A 23             	INC	HL
E40B 56             	LD	D,(HL)
E40C                KILLS1:
E40C CD 8F E3       	CALL	ENDCL
E40F D0             	RET	NC		;CF=0
E410 21 FE FF       	LD	HL,0-2
E413 19             	ADD	HL,DE
E414 D0             	RET	NC		;DE= 0 or 1
E415 D5             	PUSH	DE
E416 CD F7 F0       	CALL	_GNCL
E419 ED 53 FE F1    	LD	(_CLPS),DE
E41D D1             	POP	DE
E41E 21 00 00       	LD	HL,0
E421 D4 FA F0       	CALL	NC,_SNCL
E424 D8             	RET	C
E425 ED 5B FE F1    	LD	DE,(_CLPS)	;FAT
E429 18 E1          	JR	KILLS1
E42B                
E42B                KILLW:
E42B CD C1 E1       	CALL	SOPEN
E42E                KILLW1:
E42E 38 0B          	JR	C,KILLW2
E430 CD 61 E2       	CALL	SOPENE2
E433 CD FA E3       	CALL	KILLS
E436 CD 25 E2       	CALL	NOPEN
E439 18 F3          	JR	KILLW1
E43B                KILLW2:
E43B C8             	RET	Z
E43C 3F             	CCF
E43D C9             	RET
E43E                
E43E                CHKATT:
E43E E5             	PUSH	HL
E43F 11 0B 00       	LD	DE,00BH
E442 19             	ADD	HL,DE
E443 A6             	AND	(HL)
E444 E1             	POP	HL
E445 C8             	RET	Z
E446 37             	SCF
E447 C9             	RET
E448                
E448                NAME:
E448 CD C2 E4       	CALL	CHKWILDX
E44B D8             	RET	C
E44C 11 04 00       	LD	DE,4
E44F 19             	ADD	HL,DE
E450 22 68 E4       	LD	(NAMEP+2),HL
E453 23             	INC	HL
E454 CD C6 E4       	CALL	CHKWILD
E457 D8             	RET	C
E458                
E458 CD 94 E1       	CALL	SOPENX
E45B 3E 0F          	LD	A,00FH
E45D D4 3E E4       	CALL	NC,CHKATT
E460 D8             	RET	C
E461                
E461 FD 7E 00       	LD	A,(IY+0)
E464 FD E5          	PUSH	IY
E466 FD 21 00 00    NAMEP:	LD	IY,0		;自己書き換え
E46A FD 77 00       	LD	(IY+0),A
E46D CD 94 E1       	CALL	SOPENX
E470 FD E3          	EX	(SP),IY
E472 3F             	CCF
E473 D4 C1 E1       	CALL	NC,SOPEN
E476 EB             	EX	DE,HL
E477 E1             	POP	HL
E478 D8             	RET	C
E479                
E479                SETNAME:
E479 01 00 0B       	LD	BC,11*256
E47C 23             	INC	HL
E47D 7E             	LD	A,(HL)
E47E FE E5          	CP	0E5H
E480 20 04          	JR	NZ,SNAME1
E482 3E 05          	LD	A,5
E484 18 0E          	JR	SNAME3
E486                SNAME1:
E486 7E             	LD	A,(HL)
E487 0C             	INC	C
E488 0D             	DEC	C
E489 20 09          	JR	NZ,SNAME3
E48B CD 97 E3       	CALL	CAP
E48E FE A0          	CP	0A0H
E490 20 02          	JR	NZ,SNAME3
E492 3E 20          	LD	A,020H
E494                SNAME3:
E494 12             	LD	(DE),A
E495 7E             	LD	A,(HL)
E496 23             	INC	HL
E497 CD AF E4       	CALL	FKAN
E49A 10 EA          	DJNZ	SNAME1
E49C                WTDB:
E49C 3E FF          	LD	A,0FFH
E49E 32 39 F0       	LD	(SFILE),A
E4A1                SWTDBF:
E4A1 3E 01          	LD	A,1
E4A3 32 A4 F0       	LD	(_WTDBF),A
E4A6 AF             	XOR	A
E4A7 C9             	RET
E4A8                
E4A8                FKANC:
E4A8 CB 41          	BIT	0,C
E4AA CC A0 E3       	CALL	Z,CAP2
E4AD 18 01          	JR	FKANX
E4AF                FKAN:			;漢字チェック
E4AF 13             	INC	DE
E4B0                FKANX:
E4B0 CB 41          	BIT	0,C
E4B2 CB 81          	RES	0,C
E4B4 C0             	RET	NZ
E4B5 FE 80          	CP	080H
E4B7 D8             	RET	C
E4B8 FE A0          	CP	0A0H
E4BA 38 03          	JR	C,FKAN1
E4BC FE E0          	CP	0E0H
E4BE D8             	RET	C
E4BF                FKAN1:
E4BF 0C             	INC	C
E4C0 A7             	AND	A
E4C1 C9             	RET
E4C2                
E4C2                CHKWILDX:
E4C2 FD E5          	PUSH	IY
E4C4 E1             	POP	HL
E4C5 23             	INC	HL
E4C6                CHKWILD:
E4C6 06 0B          	LD	B,11
E4C8 3E 3F          	LD	A,'?'
E4CA                CHKWIL1:
E4CA BE             	CP	(HL)
E4CB 23             	INC	HL
E4CC 37             	SCF
E4CD C8             	RET	Z
E4CE 10 FA          	DJNZ	CHKWIL1
E4D0 AF             	XOR	A
E4D1 C9             	RET
E4D2                
E4D2                SDIRENT:		;IY=FCB HL=DIR
E4D2 D5             	PUSH	DE
E4D3 E5             	PUSH	HL
E4D4 FD E5          	PUSH	IY
E4D6 D1             	POP	DE
E4D7 EB             	EX	DE,HL
E4D8 CD 79 E4       	CALL	SETNAME
E4DB                ;				Attribute
E4DB FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E4DE 12             	LD	(DE),A
E4DF 13             	INC	DE
E4E0                ;				Reserved
E4E0 AF             	XOR	A
E4E1 06 0A          	LD	B,10
E4E3                SDE1:
E4E3 12             	LD	(DE),A
E4E4 13             	INC	DE
E4E5 10 FC          	DJNZ	SDE1
E4E7                					;(FCB)更新時刻
E4E7 21 EA F1       	LD	HL,SDDATA		;(FCB)更新年月日
E4EA 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
E4EC                SDLOOP:					;(FCB)ファイルのサイズ(バイト単位)
E4EC 7E             	LD	A,(HL)
E4ED 23             	INC	HL
E4EE 32 F3 E4       	LD	(SDPAT+2),A
E4F1 FD 7E 00       SDPAT:	LD	A,(IY+0)	;LD A,(IY+A)
E4F4 12             	LD	(DE),A
E4F5 13             	INC	DE
E4F6 10 F4          	DJNZ	SDLOOP
E4F8                
E4F8 AF             	XOR	A
E4F9 E1             	POP	HL
E4FA D1             	POP	DE
E4FB C9             	RET
E4FC                
E4FC                WOPEN:
E4FC FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E4FF E6 1F          	AND	01FH
E501 37             	SCF
E502 C0             	RET	NZ
E503 FD 36 1C FE    	LD	(IY+28),0FEH	;(FCB)オープンモード
E507                TOPEN2:
E507 AF             	XOR	A
E508                TOPEN:				;Initializes the time stamp
E508 FD 36 17 FF    	LD	(IY+23),0FFH	;(FCB)更新時刻
E50C C9             	RET
E50D                
E50D                WRDFX:
E50D 3A 76 E3       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ
E510                L_WRFX:
E510 1F             	RRA			;->CF
E511 38 06          	JR	C,E_WRFX
E513 CB 39          	SRL	C
E515 CB 1C          	RR	H		;CH=CH/2
E517 18 F7          	JR	L_WRFX
E519                E_WRFX:
E519 44             	LD	B,H
E51A 04             	INC	B
E51B 3E 37          	LD	A,037H		;SCF
E51D 32 93 E9       	LD	(DRDN1),A
E520                
E520                WRDF:				;Bクラスタ分FATを確保する
E520 11 02 00       	LD	DE,2
E523 AF             	XOR	A
E524 32 03 EB       	LD	(_SECPS+1),A
E527                WRDF1:
E527 C5             	PUSH	BC
E528 D5             	PUSH	DE
E529 CD F7 F0       	CALL	_GNCL
E52C 38 1C          	JR	C,WRDF3
E52E 7A             	LD	A,D		;空いているかチェック
E52F B3             	OR	E
E530 20 27          	JR	NZ,WRDF4
E532 E1             	POP	HL		;HL=空いているクラスタ
E533 E5             	PUSH	HL
E534 ED 5B FE F1    	LD	DE,(_CLPS)	;DE=元の(_CLPS)
E538 22 FE F1       	LD	(_CLPS),HL
E53B 7A             	LD	A,D		;元の(_CLPS)が 0 か?
E53C B3             	OR	E
E53D 20 08          	JR	NZ,WRDF2
E53F FD 75 1A       	LD	(IY+26),L	;(FCB)ファイルの先頭クラスタ
E542 FD 74 1B       	LD	(IY+27),H	;元が空の場合はFCBにクラスタをセットする
E545 18 03          	JR	WRDF3
E547                WRDF2:
E547 CD FA F0       	CALL	_SNCL
E54A                WRDF3:
E54A D1             	POP	DE
E54B C1             	POP	BC
E54C D8             	RET	C
E54D 10 0C          	DJNZ	WRDF5		;ここでループカウンタチェック
E54F ED 5B FE F1    	LD	DE,(_CLPS)
E553 21 FF FF       	LD	HL,0FFFFH	;FATエントリ終了(EOCマーク)
E556 C3 FA F0       	JP	_SNCL
E559                
E559                WRDF4:				;DEクラスタが空じゃないので次に移動する
E559 D1             	POP	DE
E55A C1             	POP	BC
E55B                WRDF5:
E55B 13             	INC	DE
E55C CD 8F E3       	CALL	ENDCL
E55F 38 C6          	JR	C,WRDF1
E561 37             	SCF
E562 C9             	RET
E563                
E563                RWXR:
E563 3A 94 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E566                L_RWX:
E566 1F             	RRA		;->CF
E567 38 08          	JR	C,E_RWX
E569 CB 38          	SRL	B	;BCH=BCH/2
E56B CB 19          	RR	C	;
E56D CB 1C          	RR	H	;
E56F 18 F5          	JR	L_RWX
E571                E_RWX:
E571 FD 5E 1A       	LD	E,(IY+26)	;(FCB)ファイルの先頭クラスタ
E574 FD 56 1B       	LD	D,(IY+27)
E577 AF             	XOR	A
E578 32 03 EB       	LD	(_SECPS+1),A
E57B                RWX1:
E57B ED 53 FE F1    	LD	(_CLPS),DE
E57F 7A             	LD	A,D
E580 B3             	OR	E
E581 28 13          	JR	Z,SCF_RET	;RET DE==0 => CF=1
E583                
E583 78             	LD	A,B
E584 B1             	OR	C
E585 B4             	OR	H
E586 C8             	RET	Z		;RET BCH==0 => CF=0
E587                
E587 CD 0B EB       	CALL	GNCLX
E58A D8             	RET	C
E58B 7C             	LD	A,H		;
E58C 25             	DEC	H		;
E58D B7             	OR	A		;DEC BCH
E58E 20 01          	JR	NZ,RWX2		;
E590 0B             	DEC	BC		;
E591                RWX2:
E591 CD 8F E3       	CALL	ENDCL
E594 38 E5          	JR	C,RWX1
E596                SCF_RET:
E596 37             	SCF
E597 C9             	RET
E598                
E598                DSKF:
E598 11 00 00       MAXCLP:	LD	DE,0
E59B 2A AC F0       	LD	HL,(_FAKEFREE)
E59E 7C             	LD	A,H
E59F B5             	OR	L
E5A0 28 03          	JR	Z,DSKF1
E5A2 11 01 00       	LD	DE,1
E5A5                DSKF1:
E5A5 D5             	PUSH	DE
E5A6 CD F7 F0       	CALL	_GNCL
E5A9 38 0C          	JR	C,POPSCF
E5AB 7A             	LD	A,D
E5AC B3             	OR	E
E5AD 20 01          	JR	NZ,DSKF2
E5AF 23             	INC	HL
E5B0                DSKF2:
E5B0 D1             	POP	DE
E5B1 1B             	DEC	DE
E5B2 7A             	LD	A,D
E5B3 B3             	OR	E
E5B4 20 EF          	JR	NZ,DSKF1
E5B6 C9             	RET
E5B7                
E5B7                POPSCF:
E5B7 F1             	POP	AF
E5B8 37             	SCF
E5B9 C9             	RET
E5BA                
E5BA                SETTMS:
E5BA FD 7E 17       	LD	A,(IY+23)	;(FCB)ファイルを最後に変更した時刻
E5BD 3C             	INC	A
E5BE C0             	RET	NZ		;ファイルが更新されていない
E5BF                SETTMSX:			;FCBに日付時刻をセットする
E5BF CD 72 DC       	CALL	_SYS2C		;(BDOS)時刻の獲得
E5C2                				;H←時  L←分  D←秒
E5C2 CB 25          	SLA	L		;   *2
E5C4 CB 25          	SLA	L		;   *4
E5C6 29             	ADD	HL,HL		;*2 *8
E5C7 29             	ADD	HL,HL		;*4 *16
E5C8 29             	ADD	HL,HL		;*8 *32
E5C9 7A             	LD	A,D
E5CA 0F             	RRCA			;bit.0->7->->->0->C
E5CB E6 1F          	AND	01FH
E5CD B5             	OR	L
E5CE FD 77 16       	LD	(IY+22),A	;(FCB)ファイルを最後に変更した時刻
E5D1 FD 74 17       	LD	(IY+23),H
E5D4                
E5D4 CD 4F DC       	CALL	_SYS2A		;(BDOS)日付の獲得
E5D7                				;HL←年  D←月  E←日
E5D7 01 44 F8       	LD	BC,0-1980
E5DA 09             	ADD	HL,BC
E5DB 65             	LD	H,L
E5DC                
E5DC 7A             	LD	A,D
E5DD 87             	ADD	A,A		;*2
E5DE 87             	ADD	A,A		;*4
E5DF 87             	ADD	A,A		;*8
E5E0 87             	ADD	A,A		;*16
E5E1 6F             	LD	L,A
E5E2 29             	ADD	HL,HL		;*32
E5E3 7D             	LD	A,L
E5E4 B3             	OR	E
E5E5 FD 77 14       	LD	(IY+20),A	;(FCB)ファイルを最後に変更した日付
E5E8 FD 74 15       	LD	(IY+21),H
E5EB C9             	RET
E5EC                
E5EC                PUSHRR:
E5EC 32 8B E6       	LD	(SETSEQ_SWC_RND),A
E5EF 22 9D E6       	LD	(SETSEQ_SWC_SEQ_RR),HL
E5F2 CD 12 E6       	CALL	GET_RR_AHL
E5F5 22 5A F0       	LD	(HLBUF),HL
E5F8 32 5C F0       	LD	(HLBUF+2),A
E5FB C9             	RET
E5FC                
E5FC                GET_CPM_R_SIZE:		;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
E5FC 87             	ADD	A,A		;in BHLA => out AHL
E5FD ED 6A          	ADC	HL,HL
E5FF CB 18          	RR	B
E601 B7             	OR	A
E602 78             	LD	A,B		;ここでフラグは変化しない
E603 C8             	RET	Z
E604 2C             	INC	L		;INC AHL
E605 C0             	RET	NZ		;
E606 24             	INC	H		;
E607 C0             	RET	NZ		;
E608 3C             	INC	A		;
E609 C9             	RET
E60A                
E60A                INIT_RND:
E60A 3E CD          	LD	A,0CDH		;CALL ????
E60C 21 5B E6       	LD	HL,POPRR
E60F CD EC E5       	CALL	PUSHRR
E612                GET_RR_AHL:
E612 FD 6E 21       	LD	L,(IY+33)	;(FCB)Random record
E615 FD 66 22       	LD	H,(IY+34)	;
E618 FD 7E 23       	LD	A,(IY+35)	;
E61B C9             	RET
E61C                SET_RR_AHL:
E61C FD 75 21       	LD	(IY+33),L	;(FCB)Random record
E61F FD 74 22       	LD	(IY+34),H
E622 FD 77 23       	LD	(IY+35),A
E625 C9             	RET
E626                INIT_SEQ:
E626 3E 01          	LD	A,1		;LD BC,????
E628 21 58 E6       	LD	HL,SETSEQ
E62B CD EC E5       	CALL	PUSHRR
E62E                GETSEQ:
E62E FD 6E 20       	LD	L,(IY+32)	;(FCB)カレントレコード
E631 FD 66 0C       	LD	H,(IY+12)	;(FCB)カレントブロック
E634 AF             	XOR	A
E635                
E635 CB 25          	SLA	L	;L=L*2
E637                
E637 CB 3C          	SRL	H	;HL=HL/2
E639 CB 1D          	RR	L	;
E63B C9             	RET
E63C                
E63C                SETSEQ1:
E63C F5             	PUSH	AF
E63D E5             	PUSH	HL		;AHL=Random record
E63E FD 7E 21       	LD	A,(IY+33)	;(FCB)ランダムレコード
E641 FD 6E 22       	LD	L,(IY+34)
E644 FD 66 23       	LD	H,(IY+35)
E647 06 00          	LD	B,0
E649                
E649 CD FC E5       	CALL	GET_CPM_R_SIZE
E64C                
E64C 29             	ADD	HL,HL
E64D CB 3D          	SRL	L		;L=L/2
E64F FD 75 20       	LD	(IY+32),L	;(FCB)カレントレコード
E652 FD 74 0C       	LD	(IY+12),H	;(FCB)カレントブロック
E655 E1             	POP	HL
E656 F1             	POP	AF
E657 C9             	RET
E658                SETSEQ:
E658 CD 3C E6       	CALL	SETSEQ1
E65B                POPRR:
E65B F5             	PUSH	AF
E65C E5             	PUSH	HL
E65D 2A 5A F0       	LD	HL,(HLBUF)
E660 3A 5C F0       	LD	A,(HLBUF+2)
E663 CD 1C E6       	CALL	SET_RR_AHL
E666 E1             	POP	HL
E667 F1             	POP	AF
E668 C9             	RET
E669                
E669                RB_WRITE:
E669 C5             	PUSH	BC
E66A ED 4B 4C F1    	LD	BC,(STABLE+2*026H)	;(BDOS)ランダムブロック書き込み
E66E 18 05          	JR	RBRW
E670                RB_READ:
E670 C5             	PUSH	BC
E671 ED 4B 4E F1    	LD	BC,(STABLE+2*027H)	;(BDOS)ランダムブロック読み込み
E675                RBRW:
E675 CB 3F          	SRL	A	;AHLA' = HL*128
E677 CB 1C          	RR	H	;AHL=AHL/2
E679 CB 1D          	RR	L	;
E67B 3E 00          	LD	A,0
E67D 1F             	RRA		;A'HLA
E67E FD 77 21       	LD	(IY+33),A	;(FCB)ランダムレコード
E681 FD 75 22       	LD	(IY+34),L
E684 FD 74 23       	LD	(IY+35),H
E687 21 80 00       	LD	HL,128
E68A C5             	PUSH	BC
E68B                SETSEQ_SWC_RND:
E68B CD 3C E6       	CALL	SETSEQ1
E68E C1             	POP	BC
E68F FD CB 20 FE    	SET	7,(IY+32)	;(FCB)カレントレコード
E693 FD E5          	PUSH	IY
E695 D1             	POP	DE
E696 D5             	PUSH	DE
E697 CD A5 E6       	CALL	JP_BC
E69A FD E1          	POP	IY
E69C CD 58 E6       	CALL	SETSEQ
E69F 00 00 E6 9D    SETSEQ_SWC_SEQ_RR	EQU $-2
E69F FD CB 20 BE    	RES	7,(IY+32)	;(FCB)カレントレコード
E6A3                
E6A3 C1             	POP	BC
E6A4 C9             	RET
E6A5                JP_BC:
E6A5 C5             	PUSH	BC
E6A6 C9             	RET
E6A7                
E6A7 00 00 E2 1F    _SYS03	EQU	SCF_FF_RET	;(BDOS)外部入力
E6A7 00 00 E2 1F    _SYS2B	EQU	SCF_FF_RET	;(BDOS)日付の設定
E6A7 00 00 E2 1F    _SYS2D	EQU	SCF_FF_RET	;(BDOS)時刻の設定
E6A7 00 00 E2 1F    _SYS39	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの作成
E6A7 00 00 E2 1F    _SYS3A	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの削除
E6A7                
E6A7                	INCLUDE	"LDFILE2.ASM"
E6A7                
E6A7                ;	LSX-Dodgers FILE2
E6A7                
E6A7                				;Write random block
E6A7                _SYS26:		;(BDOS)ランダムブロック書き込み
E6A7 AF             	XOR	A
E6A8 32 93 E9       	LD	(DRDN1),A	;NOP
E6AB 22 D7 E8       	LD	(LEFT+1),HL	;HL←書き込むレコード数
E6AE 22 5D F0       	LD	(LEFTX),HL
E6B1 CD 74 E1       	CALL	SETDRV
E6B4                
E6B4 CD 2E E8       	CALL	RBX0
E6B7 DA 51 E7       	JP	C,RBWERR
E6BA CD FC E4       	CALL	WOPEN
E6BD DA 51 E7       	JP	C,RBWERR
E6C0 7C             	LD	A,H
E6C1 B5             	OR	L
E6C2 CA 4A E7       	JP	Z,RBW1
E6C5                
E6C5 2B             	DEC	HL
E6C6                
E6C6 CD F9 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E6C9                
E6C9 19             	ADD	HL,DE		;BCHL=HL+BCDE
E6CA 30 01          	JR	NC,S26X1	;
E6CC 03             	INC	BC		;
E6CD                S26X1:
E6CD CD 63 E5       	CALL	RWXR
E6D0 DC 0D E5       	CALL	C,WRDFX
E6D3 DA 51 E7       	JP	C,RBWERR
E6D6                
E6D6 CD 5D E8       	CALL	RBX2
E6D9 28 1A          	JR	Z,RBWB		;NZ=セクタ以下の端数がある
E6DB CD 7C E8       	CALL	RBXA
E6DE 38 71          	JR	C,RBWERR
E6E0 EB             	EX	DE,HL
E6E1 C5             	PUSH	BC
E6E2 ED B0          	LDIR
E6E4 22 5F F0       	LD	(DTAX),HL
E6E7                
E6E7 CD A1 E4       	CALL	SWTDBF		;バッファデータは更新された
E6EA                
E6EA 2A 5D F0       	LD	HL,(LEFTX)
E6ED D1             	POP	DE
E6EE ED 52          	SBC	HL,DE
E6F0 22 5D F0       	LD	(LEFTX),HL
E6F3 28 33          	JR	Z,RBWEND
E6F5                
E6F5                RBWB:
E6F5 CD B2 E8       	CALL	RBXB
E6F8 28 16          	JR	Z,RBWC
E6FA                RBWB1:
E6FA C5             	PUSH	BC
E6FB D5             	PUSH	DE
E6FC CD 72 E3       	CALL	CLUSTX
E6FF CD 0D E9       	CALL	DWTC
E702 D1             	POP	DE
E703 C1             	POP	BC
E704 38 4B          	JR	C,RBWERR
E706 CD 0B EB       	CALL	GNCLX
E709 38 46          	JR	C,RBWERR
E70B 10 ED          	DJNZ	RBWB1
E70D CD 5D E9       	CALL	DRW_FLUSH
E710                RBWC:
E710 CD CA E8       	CALL	RBXC
E713 28 13          	JR	Z,RBWEND
E715 C5             	PUSH	BC
E716 CD 72 E3       	CALL	CLUSTX
E719 CD 92 E9       	CALL	DRDN
E71C C1             	POP	BC
E71D 38 32          	JR	C,RBWERR
E71F ED 5B 7E F1    	LD	DE,(_DTBUF)
E723 ED B0          	LDIR
E725 CD A1 E4       	CALL	SWTDBF		;バッファデータは更新された
E728                RBWEND:
E728 CD D6 E8       	CALL	RBXEND
E72B                
E72B CD 3D E8       	CALL	RBX1
E72E 30 1A          	JR	NC,RBW1
E730 2A D7 E8       	LD	HL,(LEFT+1)
E733 FD 5E 10       	LD	E,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
E736 FD 56 11       	LD	D,(IY+17)	;DE=File size
E739 19             	ADD	HL,DE
E73A FD 75 10       	LD	(IY+16),L	;(FCB)ファイルのサイズ(バイト単位)
E73D FD 74 11       	LD	(IY+17),H
E740 30 08          	JR	NC,RBW1
E742 FD 34 12       	INC	(IY+18)
E745 20 03          	JR	NZ,RBW1
E747 FD 34 13       	INC	(IY+19)
E74A                RBW1:
E74A FD E1          	POP	IY
E74C C1             	POP	BC
E74D D1             	POP	DE
E74E E1             	POP	HL
E74F                DD_NUL:
E74F AF             	XOR	A
E750                DRDF0:
E750                DWTF0:
E750 C9             	RET
E751                
E751                RBWERR:
E751 FD E5          	PUSH	IY
E753 D1             	POP	DE
E754 2A 20 F1       	LD	HL,(STABLE+2*010H)
E757 CD 0F 00       	CALL	JP_HL
E75A                RBRERR1:
E75A 3E 01          	LD	A,001H
E75C                RBRERR2:
E75C FD E1          	POP	IY
E75E C1             	POP	BC
E75F D1             	POP	DE
E760 E1             	POP	HL
E761 37             	SCF
E762 21 00 00       	LD	HL,0
E765 C9             	RET
E766                
E766                RBRERR:
E766 3E FF          	LD	A,0FFH
E768 18 F2          	JR	RBRERR2
E76A                
E76A                RBRFL:
E76A 3E 00          RBRFLP:	LD	A,000H
E76C FE 0D          	CP	00DH
E76E 20 05          	JR	NZ,RBRFL1
E770 D5             	PUSH	DE
E771 1E 0A          	LD	E,00AH
E773 18 05          	JR	RBRFL2
E775                RBRFL1:
E775 D5             	PUSH	DE
E776 CD 09 F0       	CALL	_SYS07
E779 5F             	LD	E,A
E77A                RBRFL2:
E77A CD CD F0       	CALL	_PRINT
E77D 7B             	LD	A,E
E77E D1             	POP	DE
E77F 32 6B E7       	LD	(RBRFLP+1),A
E782 C9             	RET
E783                DDX:
E783 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
E786 CD 97 E3       	CALL	CAP
E789 FE 41          	CP	'A'
E78B C9             	RET
E78C                
E78C                				;Read random block
E78C                _SYS27:		;(BDOS)ランダムブロック読み込み
E78C 22 5D F0       	LD	(LEFTX),HL
E78F CD 74 E1       	CALL	SETDRV
E792                
E792 FD CB 0D 66    	BIT	4,(IY+13)	;(FCB)属性(アトリビュート)
E796 C2 1C E8       	JP	NZ,RBRDIR	;ディレクトリ
E799 CD 2E E8       	CALL	RBX0
E79C DA 66 E7       	JP	C,RBRERR
E79F CD 3D E8       	CALL	RBX1
E7A2 DA 5A E7       	JP	C,RBRERR1
E7A5 EB             	EX	DE,HL
E7A6 ED 52          	SBC	HL,DE		;CP 00HL,BCDE
E7A8 19             	ADD	HL,DE
E7A9 79             	LD	A,C
E7AA DE 00          	SBC	A,0
E7AC 78             	LD	A,B
E7AD DE 00          	SBC	A,0
E7AF 38 01          	JR	C,RBR1
E7B1 EB             	EX	DE,HL
E7B2                RBR1:
E7B2 9F             	SBC	A,A
E7B3 E6 01          	AND	1
E7B5 32 1A E8       	LD	(RBRAP+1),A
E7B8                
E7B8 7C             	LD	A,H
E7B9 B5             	OR	L
E7BA 28 57          	JR	Z,RBREND0
E7BC                
E7BC 22 D7 E8       	LD	(LEFT+1),HL	;Read record byte
E7BF 22 5D F0       	LD	(LEFTX),HL
E7C2                
E7C2 CD 5D E8       	CALL	RBX2
E7C5 28 19          	JR	Z,RBRB
E7C7 CD 7C E8       	CALL	RBXA
E7CA DA 66 E7       	JP	C,RBRERR
E7CD C5             	PUSH	BC
E7CE ED B0          	LDIR
E7D0 ED 53 5F F0    	LD	(DTAX),DE
E7D4 2A 5D F0       	LD	HL,(LEFTX)
E7D7 D1             	POP	DE
E7D8 A7             	AND	A
E7D9 ED 52          	SBC	HL,DE
E7DB 22 5D F0       	LD	(LEFTX),HL
E7DE 28 30          	JR	Z,RBREND
E7E0                
E7E0                RBRB:
E7E0 CD B2 E8       	CALL	RBXB
E7E3 28 15          	JR	Z,RBRC
E7E5                RBRB1:
E7E5 C5             	PUSH	BC
E7E6 D5             	PUSH	DE
E7E7 CD 72 E3       	CALL	CLUSTX
E7EA CD 13 E9       	CALL	DRDC
E7ED D1             	POP	DE
E7EE C1             	POP	BC
E7EF D4 0B EB       	CALL	NC,GNCLX
E7F2 DA 66 E7       	JP	C,RBRERR
E7F5 10 EE          	DJNZ	RBRB1
E7F7 CD 5D E9       	CALL	DRW_FLUSH
E7FA                RBRC:
E7FA CD CA E8       	CALL	RBXC
E7FD 28 11          	JR	Z,RBREND
E7FF C5             	PUSH	BC
E800 CD 72 E3       	CALL	CLUSTX
E803 CD 76 E9       	CALL	DRDX
E806 C1             	POP	BC
E807 DA 66 E7       	JP	C,RBRERR
E80A EB             	EX	DE,HL
E80B 2A 7E F1       	LD	HL,(_DTBUF)
E80E ED B0          	LDIR
E810                RBREND:
E810 CD D6 E8       	CALL	RBXEND
E813                RBREND0:
E813 FD E1          	POP	IY
E815 C1             	POP	BC
E816 D1             	POP	DE
E817 F1             	POP	AF	;(HL)
E818 AF             	XOR	A
E819 3E 00          RBRAP:	LD	A,000H
E81B C9             	RET
E81C                
E81C                RBRDIR:
E81C FD 6E 1A       	LD	L,(IY+26)	;(FCB)ファイルの先頭クラスタ
E81F FD 66 1B       	LD	H,(IY+27)
E822 CD B2 E3       	CALL	CHDIR
E825 AF             	XOR	A
E826 67             	LD	H,A
E827 6F             	LD	L,A
E828 3C             	INC	A
E829 32 1A E8       	LD	(RBRAP+1),A
E82C 18 E5          	JR	RBREND0
E82E                
E82E                RBX0:
E82E 2A 8A F0       	LD	HL,(_DTA)
E831 22 5F F0       	LD	(DTAX),HL
E834 2A 5D F0       	LD	HL,(LEFTX)
E837 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
E83A D6 FD          	SUB	0FDH
E83C C9             	RET
E83D                
E83D                RBX1:
E83D E5             	PUSH	HL		;Record byte
E83E                				;AHL=File size
E83E FD 6E 10       	LD	L,(IY+16)	;ファイルのサイズ(バイト単位)
E841 FD 66 11       	LD	H,(IY+17)	;
E844 FD 7E 12       	LD	A,(IY+18)	;
E847                
E847 CD F9 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E84A                
E84A A7             	AND	A
E84B ED 52          	SBC	HL,DE
E84D 99             	SBC	A,C
E84E 4F             	LD	C,A
E84F FD 7E 13       	LD	A,(IY+19)	;ファイルのサイズ
E852 98             	SBC	A,B
E853 D1             	POP	DE
E854                
E854 D8             	RET	C
E855 47             	LD	B,A
E856 B1             	OR	C
E857 EB             	EX	DE,HL	;BCDE=File byte	HL=Record byte
E858 B2             	OR	D
E859 B3             	OR	E
E85A C0             	RET	NZ
E85B 37             	SCF
E85C C9             	RET
E85D                
E85D                RBX2:				;Cluster settings
E85D FD 66 22       	LD	H,(IY+34)	;(+33)(FCB)ランダムレコード
E860 FD 4E 23       	LD	C,(IY+35)
E863 06 00          	LD	B,0
E865 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E869 20 03          	JR	NZ,RBX3
E86B FD 46 24       	LD	B,(IY+36)
E86E                RBX3:
E86E CD 63 E5       	CALL	RWXR
E871 3A 94 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E874 3D             	DEC	A
E875 FD A6 22       	AND	(IY+34)
E878 FD B6 21       	OR	(IY+33)
E87B C9             	RET
E87C                
E87C                RBXA:
E87C C5             	PUSH	BC
E87D D5             	PUSH	DE
E87E CD 72 E3       	CALL	CLUSTX
E881 CD 76 E9       	CALL	DRDX
E884 D1             	POP	DE
E885 C1             	POP	BC
E886 D8             	RET	C
E887 CD 0B EB       	CALL	GNCLX
E88A D8             	RET	C
E88B ED 53 FE F1    	LD	(_CLPS),DE
E88F                
E88F FD 4E 21       	LD	C,(IY+33)	;(FCB)ランダムレコード
E892 21 00 04       SECSZ:	LD	HL,0400H	;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
E895 7C             	LD	A,H
E896 3D             	DEC	A		;1024=3 / 512=1
E897 FD A6 22       	AND	(IY+34)		;(FCB)ランダムレコード
E89A 47             	LD	B,A		;BCに1セクタ以下の端数が入る
E89B ED 42          	SBC	HL,BC		;残りを計算
E89D                
E89D ED 5B 5D F0    	LD	DE,(LEFTX)
E8A1 ED 52          	SBC	HL,DE		;CP HL,DE
E8A3 19             	ADD	HL,DE		;
E8A4 38 01          	JR	C,RBXA1		;DEとHLを比較して大きい方をHLに
E8A6 EB             	EX	DE,HL
E8A7                RBXA1:
E8A7 E5             	PUSH	HL
E8A8 2A 7E F1       	LD	HL,(_DTBUF)
E8AB 09             	ADD	HL,BC
E8AC ED 5B 5F F0    	LD	DE,(DTAX)
E8B0 C1             	POP	BC
E8B1 C9             	RET
E8B2                
E8B2                RBXB:
E8B2 2A 5F F0       	LD	HL,(DTAX)
E8B5 ED 5B FE F1    	LD	DE,(_CLPS)
E8B9 3A 5E F0       	LD	A,(LEFTX+1)
E8BC 47             	LD	B,A
E8BD 3A 94 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8C0                RBXB1:
E8C0 1F             	RRA		;->CF
E8C1 38 04          	JR	C,RBXB2
E8C3 CB 38          	SRL	B	;B=B/2
E8C5 18 F9          	JR	RBXB1
E8C7                RBXB2:
E8C7 78             	LD	A,B
E8C8 B7             	OR	A
E8C9 C9             	RET
E8CA                
E8CA                RBXC:
E8CA ED 4B 5D F0    	LD	BC,(LEFTX)
E8CE 3A 94 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8D1 3D             	DEC	A
E8D2 A0             	AND	B
E8D3 47             	LD	B,A		;1セクタ以下の端数がない場合はZ
E8D4 B1             	OR	C
E8D5 C9             	RET
E8D6                
E8D6                RBXEND:
E8D6 11 00 00       LEFT:	LD	DE,0
E8D9 AF             	XOR	A
E8DA FD 6E 21       	LD	L,(IY+33)	;(FCB)ランダムレコード
E8DD FD 66 22       	LD	H,(IY+34)
E8E0 19             	ADD	HL,DE
E8E1 FD 75 21       	LD	(IY+33),L	;(FCB)ランダムレコード
E8E4 FD 74 22       	LD	(IY+34),H
E8E7 30 0E          	JR	NC,RBXEND1
E8E9 FD 34 23       	INC	(IY+35)
E8EC 20 09          	JR	NZ,RBXEND1
E8EE FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E8F2 20 03          	JR	NZ,RBXEND1
E8F4 FD 34 24       	INC	(IY+36)
E8F7                RBXEND1:
E8F7 EB             	EX	DE,HL		;HL=Read byte
E8F8 C9             	RET
E8F9                
E8F9                GET_RR_BCDE:			;BCDE=Random record
E8F9 FD 5E 21       	LD	E,(IY+33)	;(FCB)ランダムレコード
E8FC FD 56 22       	LD	D,(IY+34)
E8FF FD 4E 23       	LD	C,(IY+35)
E902 FD 46 24       	LD	B,(IY+36)
E905 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E909 C8             	RET	Z
E90A 06 00          	LD	B,0		;CP/M互換のアクセスの場合はFCBは36バイト
E90C C9             	RET
E90D                
E90D                ;	ランダムブロックアクセスの連続したセクタをまとめる
E90D                
E90D                DWTC:
E90D E5             	PUSH	HL
E90E 21 9D EC       	LD	HL,DWT24B
E911 18 04          	JR	DWTC1
E913                DRDC:
E913 E5             	PUSH	HL
E914 21 8D EC       	LD	HL,DRD24B
E917                DWTC1:
E917 22 71 E9       	LD	(DRWF_MODE),HL
E91A E1             	POP	HL
E91B 3A 61 E9       	LD	A,(DRWF_B)
E91E B7             	OR	A
E91F 20 0F          	JR	NZ,DRDC1
E921                SAVE_DRWC:
E921 06 01          	LD	B,1
E923 ED 43 60 E9    	LD	(DRWF_C),BC
E927 ED 53 67 E9    	LD	(DRWF_E),DE
E92B 22 6A E9       	LD	(DRWF_HL),HL
E92E 18 20          	JR	INC_HL_DRWC
E930                DRDC1:
E930 E5             	PUSH	HL
E931 21 67 E9       	LD	HL,DRWF_E
E934 86             	ADD	A,(HL)
E935 F5             	PUSH	AF
E936 BB             	CP	E
E937 20 1D          	JR	NZ,DRDC2
E939 F1             	POP	AF
E93A 23             	INC	HL
E93B 7E             	LD	A,(HL)
E93C CE 00          	ADC	A,0
E93E F5             	PUSH	AF
E93F BA             	CP	D
E940 20 14          	JR	NZ,DRDC2
E942 F1             	POP	AF
E943 3A 60 E9       	LD	A,(DRWF_C)
E946 CE 00          	ADC	A,0
E948 B9             	CP	C
E949 20 0C          	JR	NZ,DRDC3
E94B 21 61 E9       	LD	HL,DRWF_B
E94E 34             	INC	(HL)
E94F E1             	POP	HL
E950                INC_HL_DRWC:
E950 3A 94 E8       	LD	A,(SECSZ+2)		;1セクタのサイズの上位1バイト
E953 84             	ADD	A,H
E954 67             	LD	H,A
E955 C9             	RET
E956                DRDC2:
E956 F1             	POP	AF
E957                DRDC3:
E957 CD 5D E9       	CALL	DRW_FLUSH
E95A E1             	POP	HL
E95B 18 C4          	JR	SAVE_DRWC
E95D                
E95D                ;	ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
E95D                DRW_FLUSH:
E95D C5             	PUSH	BC
E95E D5             	PUSH	DE
E95F 01 00 00       	LD	BC,0
E962 00 00 E9 60    DRWF_C	EQU	$-2
E962 00 00 E9 61    DRWF_B	EQU	$-1
E962 78             	LD	A,B
E963 B7             	OR	A
E964 28 0D          	JR	Z,DRDF1
E966 11 00 00       	LD	DE,0
E969 00 00 E9 67    DRWF_E	EQU	$-2
E969 00 00 E9 68    DRWF_D	EQU	$-1
E969 21 00 00       	LD	HL,0
E96C 00 00 E9 6A    DRWF_HL	EQU	$-2
E96C AF             	XOR	A
E96D 32 61 E9       	LD	(DRWF_B),A
E970 CD 8D EC       	CALL	DRD24B
E973 00 00 E9 71    DRWF_MODE	EQU	$-2
E973                DRDF1:
E973 D1             	POP	DE
E974 C1             	POP	BC
E975 C9             	RET
E976                	INCLUDE	"LDDIO.ASM"
E976                
E976                ;	LSX-Dodgers DIO
E976                
E976                DRDX:
E976 CD B4 E9       	CALL	DRDY
E979 C8             	RET	Z
E97A CD 9A E9       	CALL	DRDX1		;データバッファの情報を保存
E97D D8             	RET	C
E97E E5             	PUSH	HL
E97F C5             	PUSH	BC
E980 D5             	PUSH	DE
E981 2A 7E F1       	LD	HL,(_DTBUF)
E984 3A DD E9       	LD	A,(_DBS24+1)
E987 4F             	LD	C,A
E988 CD 8B EC       	CALL	DRD24
E98B DC AF E9       	CALL	C,DRDNE
E98E                POP_DE_BC_HL_RET:
E98E D1             	POP	DE
E98F C1             	POP	BC
E990 E1             	POP	HL
E991 C9             	RET
E992                
E992                ;	CDE:セクタ番号
E992                DRDN:
E992 AF             	XOR	A
E993 00             DRDN1:	NOP			;自己書き換え NOP / SCF
E994 30 E0          	JR	NC,DRDX
E996                DRDNX:
E996 CD B4 E9       	CALL	DRDY
E999 C8             	RET	Z
E99A                DRDX1:
E99A CD CA E9       	CALL	DWTX
E99D                				;データバッファの読み込んだドライブ・セクタ情報を保存
E99D ED 53 A6 F0    	LD	(_DBSEC),DE
E9A1 79             	LD	A,C
E9A2 32 DD E9       	LD	(_DBS24+1),A
E9A5                
E9A5 3A 88 F0       	LD	A,(_DRV)
E9A8 32 A5 F0       	LD	(_DBDRV),A
E9AB CD D9 F0       	CALL	_CHGDRV
E9AE D0             	RET	NC
E9AF                DRDNE:
E9AF 9F             	SBC	A,A		;CF=1ならばA=0FFH
E9B0 32 A5 F0       	LD	(_DBDRV),A
E9B3 C9             	RET
E9B4                
E9B4                ;	CDE:セクタ番号
E9B4                DRDY:
E9B4 3A DD E9       	LD	A,(_DBS24+1)
E9B7 B9             	CP	C
E9B8 C0             	RET	NZ
E9B9                
E9B9 E5             	PUSH	HL
E9BA 3A 88 F0       	LD	A,(_DRV)
E9BD 21 A5 F0       	LD	HL,_DBDRV
E9C0 AE             	XOR	(HL)
E9C1 20 05          	JR	NZ,POP_HL_RET
E9C3                
E9C3 2A A6 F0       	LD	HL,(_DBSEC)
E9C6 ED 52          	SBC	HL,DE		;CF=0
E9C8                POP_HL_RET:
E9C8 E1             	POP	HL
E9C9 C9             	RET
E9CA                
E9CA                DWTX:
E9CA 3A A4 F0       	LD	A,(_WTDBF)
E9CD B7             	OR	A
E9CE C8             	RET	Z
E9CF AF             	XOR	A
E9D0 32 A4 F0       	LD	(_WTDBF),A
E9D3                
E9D3 E5             	PUSH	HL
E9D4 C5             	PUSH	BC
E9D5 D5             	PUSH	DE
E9D6 3A A5 F0       	LD	A,(_DBDRV)
E9D9 CD D9 F0       	CALL	_CHGDRV
E9DC 0E 00          _DBS24:	LD	C,0
E9DE ED 5B A6 F0    	LD	DE,(_DBSEC)
E9E2 2A 7E F1       	LD	HL,(_DTBUF)
E9E5 D4 9B EC       	CALL	NC,DWT24
E9E8                POP_DE_BC_HL_RET2:
E9E8 18 A4          	JR	POP_DE_BC_HL_RET
E9EA                
E9EA                RDFATX:
E9EA E5             	PUSH	HL
E9EB 3A 88 F0       	LD	A,(_DRV)
E9EE 21 AA F0       	LD	HL,_FATDRV
E9F1 AE             	XOR	(HL)
E9F2 28 D4          	JR	Z,POP_HL_RET
E9F4                
E9F4 C5             	PUSH	BC
E9F5 D5             	PUSH	DE
E9F6 DD E5          	PUSH	IX
E9F8 CD 14 EA       	CALL	WTFATX
E9FB 38 13          	JR	C,POP_IX_DE_BC_HL_RET
E9FD                
E9FD AF             	XOR	A
E9FE 32 AB F0       	LD	(_FATIX),A
EA01 3A 88 F0       	LD	A,(_DRV)
EA04 32 AA F0       	LD	(_FATDRV),A
EA07 CD E5 F0       	CALL	_RDFAT
EA0A                RDFATE2:
EA0A 30 04          	JR	NC,POP_IX_DE_BC_HL_RET
EA0C 9F             	SBC	A,A		;A=0xFF
EA0D 32 AA F0       	LD	(_FATDRV),A
EA10                POP_IX_DE_BC_HL_RET:
EA10 DD E1          	POP	IX
EA12 18 D4          	JR	POP_DE_BC_HL_RET2
EA14                
EA14                WTFATX:
EA14 3A A2 F0       	LD	A,(_WTFATF)
EA17 B7             	OR	A
EA18 C8             	RET	Z
EA19 E5             	PUSH	HL
EA1A 3A AA F0       	LD	A,(_FATDRV)
EA1D 21 A5 F0       	LD	HL,_DBDRV
EA20 AE             	XOR	(HL)
EA21 CC CA E9       	CALL	Z,DWTX
EA24 38 A2          	JR	C,POP_HL_RET
EA26 C5             	PUSH	BC
EA27 D5             	PUSH	DE
EA28 DD E5          	PUSH	IX
EA2A CD A8 EC       	CALL	WTFAT
EA2D AF             	XOR	A
EA2E 32 A2 F0       	LD	(_WTFATF),A
EA31 18 DD          	JR	POP_IX_DE_BC_HL_RET
EA33                
EA33                NCL1:
EA33 7A             	LD	A,D
EA34 B3             	OR	E
EA35 37             	SCF
EA36 C8             	RET	Z
EA37                
EA37 7A             	LD	A,D
EA38 CB 3F          	SRL	A	;/2
EA3A CB 3F          	SRL	A	;/2
EA3C                
EA3C E5             	PUSH	HL
EA3D 32 5C EA       	LD	(NCLPAT+2),A	;_FATIX
EA40 2A AA F0       	LD	HL,(_FATDRV)	;L=_FATDRV H=_FATIX
EA43 BC             	CP	H
EA44 3A 88 F0       	LD	A,(_DRV)	;この間でフラグは変化しない
EA47 32 5B EA       	LD	(NCLPAT+1),A	;_FATDRV
EA4A 20 05          	JR	NZ,NCL2		;FATIXが違う
EA4C BD             	CP	L
EA4D 20 02          	JR	NZ,NCL2		;ドライブが違う
EA4F E1             	POP	HL
EA50 C9             	RET
EA51                NCL2:
EA51 C5             	PUSH	BC
EA52 D5             	PUSH	DE
EA53 DD E5          	PUSH	IX
EA55 CD 14 EA       	CALL	WTFATX
EA58 38 B6          	JR	C,POP_IX_DE_BC_HL_RET
EA5A 01 00 00       NCLPAT:	LD	BC,0		;自己書き換え C=_FATDRV B=_FATIX
EA5D ED 43 AA F0    	LD	(_FATDRV),BC
EA61 CD 7D EC       	CALL	RDFATS
EA64 18 A4          	JR	RDFATE2
EA66                
EA66                NCL3:
EA66 CB 9A          	RES	3,D
EA68 CB 92          	RES	2,D
EA6A 6B             	LD	L,E
EA6B 62             	LD	H,D
EA6C CB 3C          	SRL	H	;
EA6E CB 1D          	RR	L	;HLA=HLA/2
EA70 1F             	RRA		;
EA71 F5             	PUSH	AF
EA72 3A AB F0       	LD	A,(_FATIX)
EA75 0F             	RRCA
EA76 30 0B          	JR	NC,NCL3X1
EA78 3A 94 E8       	LD	A,(SECSZ+2)
EA7B FE 04          	CP	4		;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
EA7D 20 04          	JR	NZ,NCL3X1
EA7F 01 00 02       	LD	BC,512
EA82 09             	ADD	HL,BC
EA83                NCL3X1:
EA83 F1             	POP	AF
EA84 ED 4B 7C F1    	LD	BC,(_FATBF)
EA88 19             	ADD	HL,DE
EA89 09             	ADD	HL,BC
EA8A 17             	RLA
EA8B C9             	RET
EA8C                
EA8C                GNCL:
EA8C CD 33 EA       	CALL	NCL1		;GET NEXT CLUSTER
EA8F D8             	RET	C
EA90 C5             	PUSH	BC
EA91 E5             	PUSH	HL
EA92 CD 66 EA       	CALL	NCL3
EA95 38 09          	JR	C,GNC1
EA97 5E             	LD	E,(HL)
EA98 23             	INC	HL
EA99 7E             	LD	A,(HL)
EA9A E6 0F          	AND	00FH
EA9C 57             	LD	D,A
EA9D E1             	POP	HL
EA9E C1             	POP	BC
EA9F C9             	RET
EAA0                GNC1:
EAA0 7E             	LD	A,(HL)
EAA1 23             	INC	HL
EAA2 56             	LD	D,(HL)
EAA3 06 04          	LD	B,4
EAA5                GNC1L:
EAA5 CB 3A          	SRL	D	;DA=DA/2
EAA7 1F             	RRA		;
EAA8 10 FB          	DJNZ	GNC1L
EAAA                
EAAA 5F             	LD	E,A
EAAB E1             	POP	HL
EAAC C1             	POP	BC
EAAD A7             	AND	A
EAAE C9             	RET
EAAF                
EAAF                SNCL:
EAAF CD 33 EA       	CALL	NCL1
EAB2 D8             	RET	C
EAB3                ;				SET NEXT CLUSTER
EAB3 E5             	PUSH	HL
EAB4 C5             	PUSH	BC
EAB5 D5             	PUSH	DE
EAB6 E5             	PUSH	HL
EAB7 CD 66 EA       	CALL	NCL3
EABA D1             	POP	DE
EABB                ;CF=ODD
EABB 7E             	LD	A,(HL)
EABC 73             	LD	(HL),E
EABD 38 06          	JR	C,SNC1
EABF                ;EVEN
EABF                ;M[0] = E
EABF                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
EABF 23             	INC	HL
EAC0 ED 67          	RRD		;M={A[3:0],E[3:0]}
EAC2 7A             	LD	A,D
EAC3 18 04          	JR	SNC11
EAC5                SNC1:
EAC5                ;ODD
EAC5                ;HL[0] = (HL[0]&0x0F) | (E<<4)
EAC5                ;HL[1] = DE>>4
EAC5 ED 6F          	RLD		;M={D[3:0],E[7:4]}
EAC7 23             	INC	HL
EAC8 72             	LD	(HL),D	;M={D[3:0],E[7:4]}
EAC9                SNC11:
EAC9 ED 6F          	RLD		;M={M[7:4],D[3:0]}
EACB B7             	OR	A
EACC D1             	POP	DE
EACD C1             	POP	BC
EACE E1             	POP	HL
EACF                FAT_CHANGED:
EACF 3E 01          	LD	A,1
EAD1 32 A2 F0       	LD	(_WTFATF),A
EAD4 C9             	RET
EAD5                
EAD5                N16CL3:
EAD5 C5             	PUSH	BC
EAD6 6B             	LD	L,E
EAD7 7A             	LD	A,D
EAD8 E6 03          	AND	3
EADA 67             	LD	H,A
EADB 29             	ADD	HL,HL
EADC ED 4B 7C F1    	LD	BC,(_FATBF)
EAE0 09             	ADD	HL,BC
EAE1 C1             	POP	BC
EAE2 C9             	RET
EAE3                
EAE3                GNCL16:
EAE3 CD 33 EA       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EAE6 D8             	RET	C
EAE7 E5             	PUSH	HL
EAE8 CD D5 EA       	CALL	N16CL3
EAEB 5E             	LD	E,(HL)
EAEC 23             	INC	HL
EAED 56             	LD	D,(HL)
EAEE E1             	POP	HL
EAEF C9             	RET
EAF0                
EAF0                SNCL16:
EAF0 CD 33 EA       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EAF3 D8             	RET	C
EAF4 D5             	PUSH	DE
EAF5 E5             	PUSH	HL
EAF6 CD D5 EA       	CALL	N16CL3
EAF9 D1             	POP	DE		;HL
EAFA 73             	LD	(HL),E
EAFB 23             	INC	HL
EAFC 72             	LD	(HL),D
EAFD 6B             	LD	L,E
EAFE 62             	LD	H,D
EAFF D1             	POP	DE
EB00 18 CD          	JR	FAT_CHANGED
EB02                
EB02                ;------------------------
EB02                ;次のセクタを探す際に_SECPSの値をチェック
EB02                ;in
EB02                ;	DE : セクタ番号
EB02                ;out
EB02                ;	DE : 次のセクタ番号
EB02                ;note
EB02                ;
EB02                ;------------------------
EB02                NEXTX:
EB02 3E 00          _SECPS:	LD	A,0	;自己書き換え
EB04 3C             	INC	A
EB05 E6 00          NCPAT:	AND	0	;自己書き換え　1クラスタの論理セクタ数-1
EB07 32 03 EB       	LD	(_SECPS+1),A
EB0A C9             	RET
EB0B                
EB0B                GNCLX:
EB0B CD 02 EB       	CALL	NEXTX
EB0E C0             	RET	NZ	;1クラスタのセクタ未満の場合は戻る
EB0F C3 F7 F0       	JP	_GNCL	;次のクラスタを探す
EB12                
EB12                RDFAT:
EB12 3E 80          	LD	A,080H
EB14 32 70 F0       	LD	(CHECK),A
EB17                RDFAT1:
EB17 3A 88 F0       	LD	A,(_DRV)
EB1A CD D2 ED       	CALL	CHGDRVR
EB1D D8             	RET	C
EB1E DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EB21 CB 6F          	BIT	5,A
EB23 28 6B          	JR	Z,RDFAT0X
EB25 21 70 F0       	LD	HL,CHECK
EB28 A6             	AND	(HL)
EB29 77             	LD	(HL),A
EB2A 11 00 00       	LD	DE,0		;BPB
EB2D 2A 7C F1       	LD	HL,(_FATBF)
EB30 CD 89 EC       	CALL	DRD16
EB33 30 24          	JR	NC,GETBPB
EB35 21 70 F0       	LD	HL,CHECK
EB38 CB 06          	RLC	(HL)
EB3A 3F             	CCF
EB3B D8             	RET	C
EB3C DD CB 0A 1E    	RR	(IX+00AH)	;DPB_0A_FDMODE
EB40 3F             	CCF			;フロッピーディスクのFDモードを切り替える
EB41 DD CB 0A 16    	RL	(IX+00AH)	;DPB_0A_FDMODE
EB45 3E FF          	LD	A,0FFH
EB47 32 89 F0       	LD	(_DSK),A
EB4A 3A 84 F0       	LD	A,(_DRIVE)
EB4D E6 03          	AND	3
EB4F F6 80          	OR	080H
EB51 6F             	LD	L,A
EB52 26 F0          	LD	H,_CYL0/256
EB54 3E FF          	LD	A,0FFH
EB56 77             	LD	(HL),A
EB57 18 BE          	JR	RDFAT1
EB59                GETBPB:
EB59 FD E5          	PUSH	IY
EB5B FD 2A 7C F1    	LD	IY,(_FATBF)	;BPB
EB5F CD F1 F0       	CALL	_BPB2DPB
EB62 FD E1          	POP	IY
EB64 DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EB67 30 21          	JR	NC,GETBPBOK
EB69 E6 0F          	AND	00FH
EB6B FE 07          	CP	7
EB6D 37             	SCF
EB6E C0             	RET	NZ
EB6F DD CB 0A 46    	BIT	0,(IX+00AH)	;DPB_0A_FDMODE
EB73 21 C0 F1       	LD	HL,M2D
EB76 20 02          	JR	NZ,SETFDMODE
EB78 2E D2          	LD	L,M2HD-STABLE
EB7A                SETFDMODE:
EB7A DD E5          	PUSH	IX
EB7C D1             	POP	DE
EB7D ED A0          	LDI
EB7F ED A0          	LDI
EB81 13             	INC	DE
EB82 13             	INC	DE
EB83 13             	INC	DE
EB84 13             	INC	DE
EB85 01 0C 00       	LD	BC,12
EB88 ED B0          	LDIR
EB8A                GETBPBOK:
EB8A 32 99 EB       	LD	(DEVSWC),A
EB8D CD 31 ED       	CALL	CHGDRV2
EB90                RDFAT0X:
EB90 CD 7D EC       	CALL	RDFATS
EB93 D8             	RET	C
EB94 DD AE 06       	XOR	(IX+6)		;DPB_06_FATID
EB97 C8             	RET	Z
EB98 3E 00          	LD	A,0		;DPB_12_DEVICE
EB9A 00 00 EB 99    DEVSWC	EQU	$-1
EB9A CB 6F          	BIT	5,A
EB9C C0             	RET	NZ		;BPBを取得している場合はFATIDをチェックしない
EB9D 37             	SCF
EB9E C9             	RET
EB9F                
EB9F                BPB2DPB:
EB9F FD 7E 0B       	LD	A,(IY+11)	;BPB_BytsPerSec
EBA2 B7             	OR	A
EBA3 37             	SCF
EBA4 C0             	RET	NZ
EBA5                BPBOK:
EBA5 FD 7E 0D       	LD	A,(IY+13)	;BPB_SecPerClus
EBA8 DD 77 07       	LD	(IX+7),A	;DPB_07_SECPCL
EBAB                
EBAB FD 7E 16       	LD	A,(IY+22)	;BPB_FATSz16
EBAE DD 77 00       	LD	(IX+0),A	;DPB_00_FATLN
EBB1 FD 7E 17       	LD	A,(IY+23)	;BPB_FATSz16
EBB4 DD 77 01       	LD	(IX+1),A	;DPB_00_FATLN
EBB7                
EBB7 FD 6E 0E       	LD	L,(IY+14)	;BPB_RsvdSecCnt
EBBA FD 66 0F       	LD	H,(IY+15)
EBBD DD 75 0E       	LD	(IX+00EH),L	;DPB_0E_FATPS
EBC0 FD 5E 16       	LD	E,(IY+22)	;BPB_FATSz16
EBC3 FD 56 17       	LD	D,(IY+23)
EBC6 FD 46 10       	LD	B,(IY+16)	;BPB_NumFATs
EBC9                BPBDP1:				;BPB_FATSz16 * BPB_NumFATs
EBC9 19             	ADD	HL,DE
EBCA 10 FD          	DJNZ	BPBDP1
EBCC                BPBDP2:
EBCC DD 75 10       	LD	(IX+010H),L	;DPB_10_DIRPS
EBCF DD 74 11       	LD	(IX+011H),H
EBD2 E5             	PUSH	HL
EBD3                
EBD3 FD 6E 11       	LD	L,(IY+17)	;BPB_RootEntCnt
EBD6 FD 66 12       	LD	H,(IY+18)
EBD9 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EBDC B7             	OR	A
EBDD 37             	SCF
EBDE C8             	RET	Z
EBDF 06 06          	LD	B,6
EBE1                BPBBPS1:
EBE1 05             	DEC	B
EBE2 0F             	RRCA
EBE3 30 FC          	JR	NC,BPBBPS1
EBE5                BPBDE1:
EBE5 29             	ADD	HL,HL
EBE6 10 FD          	DJNZ	BPBDE1
EBE8                
EBE8 7C             	LD	A,H
EBE9 DD 77 0B       	LD	(IX+00BH),A	;DPB_0B_DIRSCNT
EBEC                
EBEC D1             	POP	DE		;DPB_10_DIRPS
EBED 6C             	LD	L,H
EBEE 26 00          	LD	H,0
EBF0 19             	ADD	HL,DE		;MAXDIR
EBF1 E5             	PUSH	HL
EBF2 FD 4E 0D       	LD	C,(IY+13)	;BPB_SecPerClus
EBF5 CB 21          	SLA	C		;*2
EBF7 AF             	XOR	A
EBF8 47             	LD	B,A
EBF9 ED 42          	SBC	HL,BC
EBFB DD 75 14       	LD	(IX+014H),L	;DPB_14_ADDCL16
EBFE DD 74 15       	LD	(IX+015H),H
EC01                
EC01 D1             	POP	DE		;DE=DPB_0B_MAXDIR
EC02 FD 6E 13       	LD	L,(IY+19)	;BPB_TotSec16
EC05 FD 66 14       	LD	H,(IY+20)
EC08                
EC08 DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EC0B E6 0F          	AND	00FH
EC0D FE 07          	CP	7		;フロッピー
EC0F 20 19          	JR	NZ,NOT_FD
EC11 E5             	PUSH	HL
EC12 FD 4E 18       	LD	C,(IY+24)	;BPB_SecPerTr
EC15 DD 71 0D       	LD	(IX+00DH),C	;DPB_0D_MAXSEC
EC18 AF             	XOR	A
EC19 CB 21          	SLA	C		;両面なのでセクタ数を２倍
EC1B 06 10          	LD	B,16
EC1D                DIVSEC:				;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
EC1D 29             	ADD	HL,HL
EC1E 17             	RLA
EC1F B9             	CP	C
EC20 38 02             	JR	C,DIVSEC1
EC22 91                	SUB	C
EC23 2C             	INC	L
EC24                DIVSEC1:
EC24 10 F7           	DJNZ	DIVSEC
EC26 DD 75 0C       	LD	(IX+00CH),L	;DPB_0C_MAXCYL
EC29 E1             	POP	HL	;ここまでフロッピー専用
EC2A                NOT_FD:
EC2A 7C             	LD	A,H
EC2B B5             	OR	L
EC2C 3E 00          	LD	A,0		;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
EC2E 20 10          	JR	NZ,BPB16BIT	;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
EC30 FD 7E 23       	LD	A,(IY+35)	;念のために総セクタ数が24ビットを超える場合はエラーを返す
EC33 B7             	OR	A
EC34 37             	SCF
EC35 C0             	RET	NZ
EC36 FD 6E 20       	LD	L,(IY+32)	;BPB_TotSec32 は AHL の24ビットで扱う
EC39 FD 66 21       	LD	H,(IY+33)	;1クラスタの論理セクタ数(DPB_07_SECPCL)が最大128なので
EC3C FD 7E 22       	LD	A,(IY+34)	;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
EC3F A7             	AND	A		;CF=0
EC40                BPB16BIT:
EC40 ED 52          	SBC	HL,DE
EC42 DE 00          	SBC	A,0
EC44 FD 46 0D       	LD	B,(IY+13)	;BPB_SecPerClus
EC47                BPBTC1:				;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
EC47 CB 18          	RR	B		;->CY
EC49 38 08          	JR	C,BPBTC2
EC4B CB 3F          	SRL	A
EC4D CB 1C          	RR	H		;AHL=AHL/2
EC4F CB 1D          	RR	L
EC51 18 F4          	JR	BPBTC1
EC53                BPBTC2:
EC53 B7             	OR	A
EC54 37             	SCF
EC55 C0             	RET	NZ		;念のため(クラスタ数が16ビットを超える場合)
EC56 23             	INC	HL
EC57 23             	INC	HL
EC58 DD 75 08       	LD	(IX+8),L	;DPB_08_MAXCL
EC5B DD 74 09       	LD	(IX+9),H
EC5E                
EC5E FD 7E 15       	LD	A,(IY+21)	;BPB_Media
EC61 DD 77 06       	LD	(IX+6),A	;DPB_06_FATID
EC64                
EC64 FD 7E 10       	LD	A,(IY+16)	;BPB_NumFATs
EC67 C6 FE          	ADD	A,0-2		;>2:CF=1
EC69 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EC6C 6F             	LD	L,A
EC6D 30 02          	JR	NC,BPBFAT1
EC6F F6 80          	OR	080H
EC71                BPBFAT1:
EC71 DD 77 0F       	LD	(IX+00FH),A	;DPB_0F_BPS
EC74 2D             	DEC	L		;以下のセクタサイズに合致しない場合はCF=1でエラーにする
EC75 C8             	RET	Z		;1セクタ256バイト
EC76 2D             	DEC	L
EC77 C8             	RET	Z		;1セクタ512バイト
EC78 2D             	DEC	L
EC79 2D             	DEC	L
EC7A C8             	RET	Z		;1セクタ1024バイト
EC7B 37             	SCF
EC7C C9             	RET
EC7D                
EC7D                RDFATS:
EC7D CD C3 EC       	CALL	FATSETUP
EC80 D8             	RET	C
EC81 CD 8D EC       	CALL	DRD24B
EC84 2A 7C F1       	LD	HL,(_FATBF)
EC87 7E             	LD	A,(HL)
EC88 C9             	RET
EC89                
EC89                DRD16:
EC89 0E 00          	LD	C,0
EC8B                DRD24:
EC8B 06 01          	LD	B,1
EC8D                DRD24B:
EC8D DD E5          	PUSH	IX
EC8F DD 2A A8 F0    	LD	IX,(_DPB)
EC93 CD ED EE       DRDPAT:	CALL	FDRD		;自己書き換え（ディスク読み込み）
EC96                POP_IX_RET:
EC96 DD E1          	POP	IX
EC98 C9             	RET
EC99                
EC99                DWT16:
EC99 0E 00          	LD	C,0
EC9B                DWT24:
EC9B 06 01          	LD	B,1
EC9D                DWT24B:
EC9D DD E5          	PUSH	IX
EC9F DD 2A A8 F0    	LD	IX,(_DPB)
ECA3 CD DF EE       DWTPAT:	CALL	FDWT		;自己書き換え（ディスク書き込み）
ECA6 18 EE          	JR	POP_IX_RET
ECA8                
ECA8                WTFAT:
ECA8 CD C3 EC       	CALL	FATSETUP
ECAB D4 9D EC       	CALL	NC,DWT24B
ECAE D8             	RET	C
ECAF DD CB 0F 7E    	BIT	7,(IX+00FH)	;DPB_0F_BPS
ECB3 C8             	RET	Z		;予備FATが無い
ECB4 CD CA EC       	CALL	FATS2
ECB7 E5             	PUSH	HL		;予備FAT
ECB8 DD 6E 00       	LD	L,(IX+0)	;DPB_00_FATLN
ECBB DD 66 01       	LD	H,(IX+1)
ECBE 19             	ADD	HL,DE
ECBF EB             	EX	DE,HL
ECC0 E1             	POP	HL
ECC1 18 DA          	JR	DWT24B
ECC3                ;------------------------
ECC3                ;FATのセットアップ
ECC3                ;out
ECC3                ;	B  : FATセクタ数
ECC3                ;	DE : FAT先頭セクタ番号
ECC3                ;	HL : FATバッファポインタ
ECC3                ;	CF : 1=ドライブ切り替えエラー
ECC3                ;note
ECC3                ;	FATサイズがFATバッファを超える場合は
ECC3                ;	対象クラスタ領域==(_FATIX)によって
ECC3                ;	FAT12:対象クラスタ1024毎に1.5KBを切り替える
ECC3                ;	FAT16:対象クラスタ1024毎に2KBを切り替える
ECC3                ;------------------------
ECC3                FATSETUP:
ECC3 3A AA F0       	LD	A,(_FATDRV)
ECC6 CD D2 ED       	CALL	CHGDRVR		;ドライブ切り替え
ECC9 D8             	RET	C
ECCA                FATS2:
ECCA DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS 512=2 1024=4
ECCD 0F             	RRCA
ECCE CD F7 EC       FATSX:	CALL	FATSETUP12	;自己書き換え
ECD1 21 00 00       	LD	HL,0
ECD4 4A             	LD	C,D
ECD5 54             	LD	D,H
ECD6 3A AB F0       	LD	A,(_FATIX)	;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
ECD9 47             	LD	B,A
ECDA 04             	INC	B
ECDB DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
ECDE                FAT_SKP:
ECDE 05             	DEC	B
ECDF 28 05          	JR	Z,FAT1
ECE1 19             	ADD	HL,DE
ECE2 93             	SUB	E
ECE3 30 F9          	JR	NC,FAT_SKP
ECE5 C9             	RET
ECE6                FAT1:
ECE6 EB             	EX	DE,HL
ECE7 B9             	CP	C		;C=FATバッファに読み込めるセクタ数
ECE8 38 01          	JR	C,FAT2
ECEA 79             	LD	A,C
ECEB                FAT2:
ECEB 47             	LD	B,A
ECEC                
ECEC 2A FA F1       	LD	HL,(_FATPS)	;fat sector pos
ECEF 19             	ADD	HL,DE
ECF0 EB             	EX	DE,HL
ECF1 2A 7C F1       	LD	HL,(_FATBF)
ECF4 AF             	XOR	A		;CF=0
ECF5 4F             	LD	C,A
ECF6 C9             	RET
ECF7                ;
ECF7                ;	FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
ECF7                ;	FATSETUP* (FAT12/FAT16)
ECF7                ;out
ECF7                ;	D : FATバッファに読み込める最大のセクタ数
ECF7                ;	E : _FATIXで進めるセクタ数
ECF7                FATSETUP12:
ECF7 11 06 06       	LD	DE,0606H	;256
ECFA D8             	RET	C
ECFB 11 03 03       	LD	DE,0303H	;512
ECFE 0F             	RRCA
ECFF D8             	RET	C
ED00 11 01 02       	LD	DE,0201H	;1024
ED03 C9             	RET
ED04                
ED04                FATSETUP16:
ED04 11 08 08       	LD	DE,0808H	;256
ED07 D8             	RET	C
ED08 11 04 04       	LD	DE,0404H
ED0B 0F             	RRCA			;512
ED0C D8             	RET	C
ED0D 11 02 02       	LD	DE,0202H	;1024
ED10 C9             	RET
ED11                
ED11                CHGDRV:
ED11 E5             	PUSH	HL
ED12 21 89 F0       	LD	HL,_DSK
ED15 BE             	CP	(HL)
ED16 28 0A          	JR	Z,CHGDRVE
ED18                CHGDRV1:
ED18 DD E5          	PUSH	IX
ED1A CD 24 ED       	CALL	CHGDRV0
ED1D 3A 89 F0       	LD	A,(_DSK)
ED20 DD E1          	POP	IX
ED22                CHGDRVE:
ED22 E1             	POP	HL
ED23 C9             	RET
ED24                
ED24                CHGDRV0:
ED24 6F             	LD	L,A
ED25 CD DC F0       	CALL	_GETDPB
ED28 D8             	RET	C
ED29 DD 22 A8 F0    	LD	(_DPB),IX
ED2D 7D             	LD	A,L
ED2E 32 89 F0       	LD	(_DSK),A
ED31                CHGDRV2:
ED31 C5             	PUSH	BC
ED32 D5             	PUSH	DE
ED33 ED 73 88 ED    	LD	(SPPAT2+1),SP
ED37 F3             	DI
ED38 DD F9          	LD	SP,IX
ED3A                
ED3A E1             	POP	HL		;DPB_00_FATLN
ED3B E1             	POP	HL		;DPB_02_DRD
ED3C 22 94 EC       	LD	(DRDPAT+1),HL
ED3F                
ED3F E1             	POP	HL
ED40 22 A4 EC       	LD	(DWTPAT+1),HL	;DPB_04_DWT
ED43                
ED43 E1             	POP	HL		;L=DPB_06_FATID H=DPB_07_SECPCL
ED44 7C             	LD	A,H
ED45 32 76 E3       	LD	(SPCPAT+1),A	;1クラスタの論理セクタ数
ED48 3D             	DEC	A
ED49 32 06 EB       	LD	(NCPAT+1),A
ED4C                
ED4C E1             	POP	HL		;DPB_08_MAXCL
ED4D 7D             	LD	A,L
ED4E 32 95 E3       	LD	(CLPAT2+1),A
ED51 7C             	LD	A,H
ED52 32 91 E3       	LD	(CLPAT1+1),A
ED55 2B             	DEC	HL
ED56 22 99 E5       	LD	(MAXCLP+1),HL
ED59                
ED59 E1             	POP	HL		;L=DPB_0A_FDMODE H=DPB_0B_DIRSCNT
ED5A 7D             	LD	A,L
ED5B F6 FE          	OR	0FEH
ED5D 32 88 EE       	LD	(FDMODE+1),A
ED60 07             	RLCA
ED61 E6 03          	AND	3
ED63 32 70 EE       	LD	(FSPAT+1),A
ED66 4C             	LD	C,H
ED67                
ED67 E1             	POP	HL		;L=DPB_0C_MAXCYL H=DPB_0D_MAXSEC
ED68                
ED68 E1             	POP	HL		;L=DPB_0E_FATPS H=DPB_0F_BPS
ED69 7C             	LD	A,H		;DPB_0F_BPS
ED6A E6 07          	AND	7
ED6C 32 94 E8       	LD	(SECSZ+2),A	;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
ED6F                				;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
ED6F                				;1セクタ1024 2HD/2HDE98
ED6F                				;1セクタ256 GRAM/RAMF/CMOS/等
ED6F                				;1024	512	256
ED6F                				;4	2	1
ED6F 87             	ADD	A,A		;8	4	2
ED70 87             	ADD	A,A		;010H	8	4
ED71 87             	ADD	A,A		;020H	010H	8
ED72 32 F2 E1       	LD	(SDECPAT+1),A	;1セクタ辺りのディレクトリエントリ数
ED75                
ED75 26 00          	LD	H,0
ED77 22 FA F1       	LD	(_FATPS),HL
ED7A                
ED7A E1             	POP	HL		;DPB_10_DIRPS
ED7B 22 FC F1       	LD	(_DIRPS),HL
ED7E                
ED7E E1             	POP	HL		;L=DPB_12_DEVICE H=DPB_13_UNITNO
ED7F 7C             	LD	A,H
ED80 32 84 F0       	LD	(_DRIVE),A
ED83                
ED83 E1             	POP	HL		;DPB_14_ADDCL16
ED84 22 86 E3       	LD	(CLSPAT+1),HL
ED87                
ED87 31 00 00       SPPAT2:	LD	SP,0		;元のSPを復元
ED8A FB             	EI
ED8B 2A FC F1       	LD	HL,(_DIRPS)
ED8E 06 00          	LD	B,0
ED90 09             	ADD	HL,BC		;C=DPB_0B_DIRSCNT
ED91 22 0D E2       	LD	(MD_PAT+1),HL
ED94                
ED94 2A 99 E5       	LD	HL,(MAXCLP+1);
ED97 11 F6 0F       	LD	DE,4086		;クラスタ数が4086未満:FAT12 4086以上:FAT16
ED9A ED 52          	SBC	HL,DE		;CF=0のはず
ED9C 30 0F          	JR	NC,SETFAT16
ED9E 21 8C EA       	LD	HL,GNCL		;FAT12
EDA1 11 AF EA       	LD	DE,SNCL
EDA4 01 F7 EC       	LD	BC,FATSETUP12
EDA7 DD CB 0F AE    	RES	5,(IX+00FH)	;DPB_0F_BPS(FAT12)
EDAB 18 0D          	JR	EXTRA1
EDAD                SETFAT16:
EDAD 21 E3 EA       	LD	HL,GNCL16	;FAT16
EDB0 11 F0 EA       	LD	DE,SNCL16
EDB3 01 04 ED       	LD	BC,FATSETUP16
EDB6 DD CB 0F EE    	SET	5,(IX+00FH)	;DPB_0F_BPS(FAT16)
EDBA                EXTRA1:
EDBA 22 F8 F0       	LD	(GNCPAT+1),HL
EDBD ED 53 FB F0    	LD	(SNCPAT+1),DE
EDC1 ED 43 CF EC    	LD	(FATSX+1),BC
EDC5 D1             	POP	DE
EDC6 C1             	POP	BC
EDC7 AF             	XOR	A
EDC8 C9             	RET
EDC9                
EDC9                GETDPBD:
EDC9 DD E3          	EX	(SP),IX
EDCB DD E5          	PUSH	IX
EDCD 3A 88 F0       	LD	A,(_DRV)
EDD0 18 07          	JR	GETDPB1
EDD2                
EDD2                CHGDRVR:
EDD2 CD D9 F0       	CALL	_CHGDRV
EDD5 D8             	RET	C
EDD6 3A 89 F0       	LD	A,(_DSK)
EDD9                GETDPB1:
EDD9 C3 DC F0       	JP	_GETDPB
EDDC                
EDDC                GETDPB:
EDDC FE 08          	CP	8
EDDE 3F             	CCF
EDDF D8             	RET	C
EDE0 0F             	RRCA
EDE1 0F             	RRCA
EDE2 0F             	RRCA
EDE3 DD             	DB	0DDH		;Z80未定義命令
EDE4 6F             	LD	L,A		;LD	IXL,A
EDE5 DD             	DB	0DDH		;Z80未定義命令
EDE6 26 F2          	LD	H,DEVICE/256	;LD	IXH,DEVICE/256
EDE8 DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
EDEB A7             	AND	A		;CF=0の為
EDEC DD CB 0F 6E    	BIT	5,(IX+00FH)	;DPB_0F_BPS
EDF0 C0             	RET	NZ		;FAT16
EDF1 DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
EDF5 C0             	RET	NZ		;BPB
EDF6 FE 01          	CP	001H		;A=0 THEN CF=1
EDF8 C9             	RET
EDF9                
EDF9                _SYS5F:
EDF9 AF             	XOR	A
EDFA                FFLUSH:
EDFA F5             	PUSH	AF
EDFB 3E FF          	LD	A,0FFH
EDFD 32 39 F0       	LD	(SFILE),A
EE00 CD CA E9       	CALL	DWTX
EE03 3E FF          	LD	A,0FFH
EE05 32 A5 F0       	LD	(_DBDRV),A
EE08 CD 14 EA       	CALL	WTFATX
EE0B AF             	XOR	A
EE0C 32 AB F0       	LD	(_FATIX),A
EE0F 2F             	CPL			;0FFH
EE10 32 AA F0       	LD	(_FATDRV),A
EE13 F1             	POP	AF
EE14 C9             	RET
EE15                
EE15                	INCLUDE	"X1DISK.ASM"
EE15                
EE15                ;	LSX-Dodgers DISK
EE15                ;	X1/turbo/Z
EE15                
EE15                SEEK:
EE15 06 10          	LD	B,16
EE17 DD 4E 0D       	LD	C,(IX+0DH)	;DPB_0D_MAXSEC
EE1A AF             	XOR	A
EE1B EB             	EX	DE,HL
EE1C                DIV1:
EE1C 29             	ADD	HL,HL
EE1D 8F             	ADC	A,A
EE1E B9             	CP	C
EE1F 38 02          	JR	C,DIV2
EE21 91             	SUB	C
EE22 2C             	INC	L
EE23                DIV2:
EE23 10 F7          	DJNZ	DIV1
EE25                
EE25 3C             	INC	A	;最小のセクタは１固定
EE26 55             	LD	D,L	;TRACK
EE27 5F             	LD	E,A	;SECTOR
EE28 CB 3A          	SRL	D	;CYLINDER
EE2A 9F             	SBC	A,A
EE2B E6 10          	AND	010H	;SIDE
EE2D 4F             	LD	C,A
EE2E                
EE2E 3A 84 F0       	LD	A,(_DRIVE)
EE31 FE 04          	CP	4
EE33 3F             	CCF
EE34 D8             	RET	C
EE35 B1             	OR	C
EE36 32 B4 EE       	LD	(MOPAT+1),A	;Motor off data
EE39 01 FC 0F       	LD	BC,00FFCH
EE3C F6 80          	OR	080H		;Motor on
EE3E ED 79          	OUT	(C),A
EE40                
EE40 CD 86 EE       	CALL	SETMODE
EE43 D8             	RET	C
EE44                
EE44 CD C9 EE       	CALL	DRIVE
EE47 FE FF          	CP	0FFH		;A=0FFH Unknown CYLINDER
EE49 CC A8 EE       	CALL	Z,FDCRES	;Restore
EE4C 0E F9          	LD	C,0F9H
EE4E ED 79          	OUT	(C),A		;Currrent CYLINDER
EE50 92             	SUB	D
EE51 C8             	RET	Z		;No seek
EE52                
EE52 3A 86 F0       	LD	A,(_ISEEK)
EE55 4F             	LD	C,A
EE56                
EE56 DD 7E 0C       	LD	A,(IX+00CH)	;DPB_0C_MAXCYL
EE59 3D             	DEC	A
EE5A BA             	CP	D		;Over CYLINDER
EE5B D8             	RET	C
EE5C                
EE5C B9             	CP	C		;for Built-in 2DD
EE5D 38 03          	JR	C,SETM2
EE5F 78             	LD	A,B		;B=00FH
EE60 DB FE          	IN	A,(0FEH)		;2HD mode for 2DD seek
EE62                SETM2:
EE62 78             	LD	A,B
EE63 DB FD          	IN	A,(0FDH)		;MFM mode
EE65                
EE65 0E FB          	LD	C,0FBH
EE67 ED 51          	OUT	(C),D
EE69 72             	LD	(HL),D
EE6A 0E 18          	LD	C,018H		;Seek
EE6C                FDCCMD2:
EE6C 3A 85 F0       	LD	A,(_SEEKSP)
EE6F E6 FF          FSPAT:	AND	0FFH
EE71 B1             	OR	C
EE72                
EE72                FDCCMD:
EE72 CD BF EE       	CALL	COMSET
EE75                
EE75 3E 80          FDCPAT:	LD	A,080H		;FDC COMMAND(Self-modifying code)
EE77 E6 20          	AND	020H		;Write data Write track
EE79 3C             	INC	A
EE7A                
EE7A                SST:
EE7A 0E 00          	LD	C,0
EE7C                SST1:
EE7C 0D             	DEC	C		; 4
EE7D 20 FD          	JR	NZ,SST1		;12 * 256 / 4 = About 1ms
EE7F 3D             	DEC	A
EE80 20 FA          	JR	NZ,SST1
EE82                
EE82 3C             	INC	A		;A=1
EE83 CD 91 EE       	CALL	READY
EE86                SETMODE:
EE86 78             	LD	A,B		;B=00FH
EE87 DB FF          FDMODE:	IN	A,(0FFH)	;Floppy mode(2D/2HD) (Self-modifying code)
EE89                
EE89 78             	LD	A,B
EE8A DB FD          	IN	A,(0FDH)	;MFM mode
EE8C                
EE8C CD C3 EE       	CALL	DELAY0		;Head select time
EE8F 3E 81          	LD	A,081H
EE91                READY:
EE91 32 9B EE       	LD	(WAITA+1),A
EE94 E5             	PUSH	HL
EE95 0E F8          	LD	C,0F8H
EE97 61             	LD	H,C
EE98                READY2:
EE98 ED 78          	IN	A,(C)
EE9A E6 81          WAITA:	AND	081H		;NOT READY,BUSY
EE9C 28 08          	JR	Z,READYE
EE9E E3             	EX	(SP),HL		;wait 19clock
EE9F E3             	EX	(SP),HL		; //
EEA0 2B             	DEC	HL
EEA1 7C             	LD	A,H
EEA2 B5             	OR	L
EEA3 20 F3          	JR	NZ,READY2
EEA5 37             	SCF
EEA6                READYE:
EEA6 E1             	POP	HL
EEA7 C9             	RET
EEA8                
EEA8                FDCRES:
EEA8 36 00          	LD	(HL),0
EEAA 0E 08          	LD	C,8
EEAC 18 BE          	JR	FDCCMD2
EEAE                
EEAE                FDMOFF:
EEAE F5             	PUSH	AF
EEAF C5             	PUSH	BC
EEB0 01 FC 0F       	LD	BC,00FFCH	;Motor off
EEB3 3E 00          MOPAT:	LD	A,000H		;(Self-rewriting)
EEB5 ED 79          	OUT	(C),A
EEB7 C1             	POP	BC
EEB8 F1             	POP	AF
EEB9 C9             	RET
EEBA                
EEBA                SECSET:
EEBA 01 FA 0F       	LD	BC,00FFAH
EEBD ED 59          	OUT	(C),E
EEBF                COMSET:
EEBF 0E F8          	LD	C,0F8H
EEC1 ED 79          	OUT	(C),A
EEC3                DELAY0:
EEC3 3E 1A          	LD	A,26
EEC5                DELAY:
EEC5 3D             	DEC	A
EEC6 20 FD          	JR	NZ,DELAY
EEC8 C9             	RET
EEC9                
EEC9                DRIVE:
EEC9 2A 84 F0       	LD	HL,(_DRIVE)
EECC 26 F0          	LD	H,_CYL0/256
EECE CB FD          	SET	7,L
EED0 7E             	LD	A,(HL)
EED1 C9             	RET
EED2                
EED2                RNF:
EED2 CD C9 EE       	CALL	DRIVE
EED5 36 FF          	LD	(HL),0FFH
EED7 C9             	RET
EED8                
EED8 02             RETRY:	DB	2
EED9                
EED9                
EED9                ;	FLOPPY DISK DRIVER(DMA)
EED9                
EED9                
EED9                WTTRK:
EED9 06 01          	LD	B,1
EEDB 3E F4          	LD	A,0F4H
EEDD 18 02          	JR	WTTRK1
EEDF                FDWT:
EEDF 3E A0          	LD	A,0A0H
EEE1                WTTRK1:
EEE1 32 76 EE       	LD	(FDCPAT+1),A
EEE4 3E 10          	LD	A,16
EEE6 18 0C          	JR	DISK
EEE8                
EEE8                DISKOK:
EEE8 06 01          FDCNT:	LD	B,1
EEEA 10 0B          	DJNZ	DISK1
EEEC C9             	RET
EEED                
EEED                FDRD:
EEED 3E 80          	LD	A,080H
EEEF 32 76 EE       	LD	(FDCPAT+1),A
EEF2 3E 0E          	LD	A,14
EEF4                
EEF4                DISK:
EEF4 32 0B EF       	LD	(DMAPAT+1),A
EEF7                DISK1:
EEF7 78             	LD	A,B
EEF8 32 E9 EE       	LD	(FDCNT+1),A
EEFB 22 63 EF       	LD	(DMAD+11),HL
EEFE                DISKR:
EEFE 3E 02          	LD	A,2		;Retry count
EF00 32 D8 EE       	LD	(RETRY),A
EF03                DISK2:
EF03 D5             	PUSH	DE
EF04 CD 15 EE       	CALL	SEEK
EF07 38 43          	JR	C,ERRF
EF09 F3             	DI
EF0A                
EF0A 3E 0E          DMAPAT:	LD	A,14		;自己書き換え
EF0C 21 58 EF       	LD	HL,DMAD
EF0F CD 93 DF       	CALL	SETDMA
EF12 ED 49          	OUT	(C),C		;OUT 01F87H,087H WR6 イネーブル
EF14 3A 76 EE       	LD	A,(FDCPAT+1)
EF17 C5             	PUSH	BC
EF18 CD BA EE       	CALL	SECSET
EF1B 2A 63 EF       	LD	HL,(DMAHL)
EF1E 23             	INC	HL
EF1F 11 06 BB       	LD	DE,0BB06H	;READ DMA
EF22                
EF22 3E 03          	LD	A,3
EF24 CD 91 EE       	CALL	READY
EF27 ED 78          	IN	A,(C)
EF29                
EF29 C1             	POP	BC
EF2A ED 51          	OUT	(C),D		;読み出しマスク設定
EF2C ED 59          	OUT	(C),E		;バイトカウンタ(LH)
EF2E ED 58          	IN	E,(C)
EF30 ED 50          	IN	D,(C)
EF32 19             	ADD	HL,DE
EF33 D1             	POP	DE
EF34 13             	INC	DE
EF35 FB             	EI
EF36 CD AE EE       	CALL	FDMOFF
EF39 B7             	OR	A
EF3A 28 AC          	JR	Z,DISKOK
EF3C 1B             	DEC	DE
EF3D CB 67          	BIT	4,A
EF3F C4 D2 EE       	CALL	NZ,RNF
EF42                DISKE2:
EF42 21 D8 EE       	LD	HL,RETRY
EF45 35             	DEC	(HL)
EF46 20 BB          	JR	NZ,DISK2
EF48 B7             	OR	A
EF49 28 0A          	JR	Z,ERR
EF4B D5             	PUSH	DE
EF4C                ERRF:
EF4C D1             	POP	DE
EF4D                DELP:
EF4D CD D2 EE       	CALL	RNF
EF50 CD AE EE       	CALL	FDMOFF
EF53 3E FF          	LD	A,0FFH
EF55                ERR:
EF55 BF             	CP	A
EF56 37             	SCF
EF57 C9             	RET
EF58                
EF58                			;X1turbo DISK DMA
EF58 C3             DMAD:	DB	0C3H	;WR6 リセット
EF59 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
EF5A FB 0F          	DW	00FFBH	;ポートA開始アドレス FDC データレジスタ
EF5C FF FF          	DW	0FFFFH	;ブロック長(転送サイズ-1)
EF5E 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
EF5F 10             	DB	010H	;WR2 ポートBインクリメント
EF60 80             	DB	080H	;WR3
EF61 92             	DB	092H	;WR5 WAIT RDY:LOW
EF62 8D             	DB	08DH	;WR4 バイト ポートB開始アドレス(LH)
EF63 00 00          DMAHL:	DW	0	;ポートB開始アドレス
EF65 CF             	DB	0CFH	;WR6 ロード
EF66 01             	DB	001H	;WR0 ポートB←ポートB 転送
EF67 CF             	DB	0CFH	;WR6 ロード
EF68                
EF68                DMAE:
EF68                
EF68 00 00 1E 38    AT_R	EQU	WTTRK-AT_DWT
EF68                AT_TABLE:
EF68                	INCLUDE	"LDCCPWK.ASM"
EF68                
EF68                ;	LSX-Dodgers CCP WORK
EF68                
EF68 00 00 00 40    PATHX	EQU	64
EF68                PATHD:	DS	PATHX
EFA8 00             PATHE:	DB	0
EFA9                
EFA9                DTA_CCP:
EFA9                	DS	37
EFCE                
EFCE                FCB_BAT:
EFCE                	DS	37
EFF3                
EFF3                
EFF3 20 62 79 74    FREE:	DB	" bytes free",9,'$'
EFF7 65 73 20 66
EFFB 72 65 65 09
EFFF 24
F000                	INCLUDE	"LDWORK.ASM"
F000                
F000                ;	LSX-Dodgers WORK0
F000                ;
F000                ;	CP/M互換BIOS
F000                ;	BOOT:アドレス下位1バイトが0になるように
F000                AT_WORK:
F000                	DS	WORKAD-AT_WORK
F000                
F000                CPM_BOOT:
F000 C3 00 00       	JP	0
F003                _SYS00:		;(BDOS)プログラム終了
F003                CPM_WBOOT:
F003 C3 09 D2       	JP	WBOOT1
F006                CPM_CONST:
F006 C3 41 DC       	JP	CONSTX
F009                _SYS07:		;(BDOS)コンソール直接入力
F009                CPM_CONIN:
F009 C3 E8 DB       	JP	FLGET
F00C                CPM_CONOUT:
F00C C3 86 DE       	JP	CONOUT1
F00F                
F00F                DECBF:
F00F                	DS	5
F014 00             FDRV	DB	0
F015                FNAME	DS	36
F039                SFILE:	DS	33		;DRV FILENAME
F05A                HLBUF:	DS	3		;Random record buffer
F05D                
F05D 00 00          LEFTX:	DW	0
F05F 00 00          DTAX:	DW	0
F061                
F061                ZERO:
F061                BEEPD:
F061 00 8E 01 00    	DB	0,08EH,1,0,00BH,0,00CH,010H
F065 0B 00 0C 10
F069 07 3E 08 10    	DB	007H,03EH,008H,010H,00DH,0,0FFH
F06D 0D 00 FF
F070 00 00 F0 62    RTC_YY	EQU	BEEPD+1
F070 00 00 F0 63    RTC_MW	EQU	BEEPD+2
F070 00 00 F0 64    RTC_DD	EQU	BEEPD+3
F070 00 00 F0 65    RTC_TT	EQU	BEEPD+4
F070 00 00 F0 66    RTC_MM	EQU	BEEPD+5
F070 00 00 F0 67    RTC_SS	EQU	BEEPD+6
F070                
F070 00             CHECK:	DB	0
F071                
F071 4F 4B 24       OK:	DB	"OK$"
F074                	DS	5
F079 45 72 72 6F    COMERM:	DB	"Error!$"
F07D 72 21 24
F080                ;	システムワークエリア
F080                ;	_CYL0:アドレス下位1バイトが080Hになるように
F080 FF             _CYL0:	DB	0FFH	;Cylinder
F081 FF             _CYL1:	DB	0FFH	;Cylinder
F082 FF             _CYL2:	DB	0FFH	;Cylinder
F083 FF             _CYL3:	DB	0FFH	;Cylinder
F084 00             _DRIVE:	DB	0	;unit number
F085 00             _SEEKSP:DB	0	;Seek speed
F086 FF             _ISEEK:	DB	0FFH	;
F087 00             _DVSW:	DB	0
F088 00             _DRV:	DB	0
F089 FF             _DSK:	DB	0FFH
F08A 80 00          _DTA:	DW	00080H
F08C 00 00          _CTC:	DW	0
F08E 00 00          _TXADR:	DW	0
F090 00 00          _KEYPS:	DW	0
F092 00 FF          _KEYD:	DW	0FF00H	;キーデータ
F094 C2 10          _KEYSP:	DB	KEYSP_L,KEYSP_H	;オートリピートの速度
F096 07             _COLORF:DB	COLORF	;色
F097 18             _LINE:	DB	LINE
F098                
F098 00 00          _FCB:	DW	0	;SEARCH FILES
F09A 00 00          _FBPS:	DW	0	;    //
F09C 00 00          _FBAD:	DW	0	;    //
F09E 00             _FBCNT:	DB	0	;    //
F09F 00             _FILEN:	DB	0	;    //
F0A0 00             _DIRF:	DB	0	;bit7:ディレクトリ bit0-6:セクタインデックス
F0A1                	DS	1
F0A2 00             _WTFATF:DB	0	;FATバッファの更新フラグ
F0A3                	DS	1
F0A4 00             _WTDBF:	DB	0	;データバッファの更新フラグ
F0A5 FF             _DBDRV:	DB	0FFH	;データバッファにあるデータを読み込んだドライブ
F0A6 00 00          _DBSEC:	DW	0	;データバッファにあるデータを読み込んだセクタ番号
F0A8 00 00          _DPB:	DW	0
F0AA                _FATDRV:
F0AA FF             	DB	0FFH	;FATバッファに読み込んでいるドライブ
F0AB 00             _FATIX:	DB	0	;FATバッファに読み込んでいるインデックス
F0AC                _FAKEFREE:
F0AC 00 00          	DW	0	;偽の残量（FATサイズが大きくなると重くなるのでその対策）
F0AE                
F0AE                	DS	2
F0B0                
F0B0                CRTCD:
F0B0 6F             	DB	06FH
F0B1                _WIDTH:
F0B1 50             	DB	WIDTH
F0B2                TVRAMTOP:
F0B2 59 38          	DB	059H,038H
F0B4 1F 02          	DB	01FH,002H
F0B6                _LINE2:
F0B6 19             	DB	019H
F0B7                WKE4:
F0B7 1C             	DB	01CH
F0B8                WKE6:
F0B8 00             	DB	000H
F0B9                WK40:
F0B9 07             	DB	007H
F0BA                _PAGE_MINUS:
F0BA 80 F8          	DW	0-WIDTH*LINE
F0BC                _WIDTH_MINUS:
F0BC B0 FF          	DW	0-WIDTH
F0BE                WK30:
F0BE 0C             	DB	00CH
F0BF                WK31:
F0BF                WK1FD0:
F0BF 20             	DB	020H
F0C0                
F0C0 2F DB          CTC0:	DW	INTCTCE
F0C2 2F DB          CTC1:	DW	INTCTCE
F0C4 32 DB          CTC2:	DW	INTCTC2
F0C6 2F DB          CTC3:	DW	INTCTCE
F0C8 1B DB          INTVEC:	DW	INT
F0CA                
F0CA                ;	LSX-Dodgers 独自BIOS
F0CA                
F0CA C3 69 E0       _INKEY:	JP	INKEY
F0CD C3 21 DD       _PRINT:	JP	PRINT
F0D0 C3 D1 DF       _SCRN:	JP	SCRN
F0D3 C3 FB DF       _POS:	JP	POS
F0D6 C3 4F DE       _LOC:	JP	LOC
F0D9                _CHGDRV:
F0D9 C3 11 ED       	JP	CHGDRV
F0DC                _GETDPB:
F0DC C3 DC ED       	JP	GETDPB
F0DF                _FFLUSH:
F0DF C3 FA ED       	JP	FFLUSH
F0E2                _RDFATX:
F0E2 C3 EA E9       	JP	RDFATX
F0E5 C3 12 EB       _RDFAT:	JP	RDFAT
F0E8 C3 D9 EE       _WTTRK:	JP	WTTRK
F0EB C3 ED EE       _FDRD:	JP	FDRD
F0EE C3 DF EE       _FDWT:	JP	FDWT
F0F1                _BPB2DPB:
F0F1 C3 9F EB       	JP	BPB2DPB
F0F4                _BREAK:
F0F4 C3 C2 D3       	JP	END_BATCH
F0F7                _GNCL:
F0F7 C3 8C EA       GNCPAT:	JP	GNCL		; self-modifying code
F0FA                _SNCL:
F0FA C3 AF EA       SNCPAT:	JP	SNCL		; self-modifying code
F0FD C3 7C D2       _COMANL:JP	COMANL
F100                
F100                _WE:
F100                	INCLUDE	"LDCALL.ASM"
F100                
F100                ;	LSX-Dodgers システムコール(BDOS)
F100                ;
F100                ;	LSX-Dodgers SYSTEM CALL
F100                ;	STABLE:アドレス下位1バイトが0になるように
F100                
F100                STABLE:
F100                ;0
F100 03 F0 BB DB    	DW	_SYS00,_SYS01,_SYS02,_SYS03
F104 C7 DB 1F E2
F108 5F D8 5F D8    	DW	_SYS04,_SYS05,_SYS06,_SYS07
F10C CC DB 09 F0
F110 D4 DB 61 D8    	DW	_SYS08,_SYS09,_SYS0A,_SYS0B
F114 0D DC 39 DC
F118 76 D8 7B D8    	DW	_SYS0C,_SYS0D,_SYS0E,_SYS0F
F11C 8A D8 9B D8
F120                ;1
F120 EF D8 36 D9    	DW	_SYS10,_SYS11,_SYS12,_SYS13
F124 7F D9 B5 D9
F128 BD D9 D3 D9    	DW	_SYS14,_SYS15,_SYS16,_SYS17
F12C E8 D9 E0 D9
F130 2F DA 34 DA    	DW	_SYS18,_SYS19,_SYS1A,_SYS1B
F134 39 DA 3F DA
F138 5F D8 65 DA    	DW	_SYS1C,_SYS1D,_SYS1E,_SYS1F
F13C 5F D8 69 DA
F140                ;2
F140 5F D8 1F DA    	DW	_SYS20,_SYS21,_SYS22,_SYS23
F144 27 DA 70 DA
F148 96 DA 5F D8    	DW	_SYS24,_ERROR,_SYS26,_SYS27
F14C A7 E6 8C E7
F150 27 DA 9F DA    	DW	_SYS28,_SYS29,_SYS2A,_SYS2B
F154 4F DC 1F E2
F158 72 DC 1F E2    	DW	_SYS2C,_SYS2D,_SYS2E,_SYS2F
F15C 5F D8 C2 DA
F160                ;3
F160 BC DA 5F D8    	DW	_SYS30,_ERROR,_ERROR,_ERROR
F164 5F D8 5F D8
F168 5F D8 5F D8    	DW	_ERROR,_ERROR,_ERROR,_ERROR
F16C 5F D8 5F D8
F170 5F D8 1F E2    	DW	_ERROR,_SYS39,_SYS3A,_SYS5A
F174 1F E2 E3 DA
F178                ;DOS2
F178 42 D8          	DW	_DOS2
F17A                
F17A                	DS	2
F17C 00 F3          _FATBF:	DW	FATBF
F17E 00 FB          _DTBUF:	DW	DTBUF
F180                
F180                ;	コントロールコードテーブル
F180                ;	CTRLTB:アドレス下位1バイトが080Hになるように
F180                
F180                CTRLTB:
F180 C4 DD C4 DD    	DW	CTRL00,CTRL00,CTRL02,CTRL03	;  A,B,C
F184 00 DE 45 DF
F188 3F DF 24 DE    	DW	CTRL04,CTRL05,CTRL06,CTRL07	;D,E,F,G
F18C 1E DF A7 DE
F190 D0 DD F1 DD    	DW	CTRL08,CTRL09,CTRL0A,CTRL0B	;H,I,J,K
F194 48 DF 65 DE
F198 1B DF 4A DE    	DW	CTRL0C,CTRL0D,CTRL0E,CTRL00	;L,M,N,O
F19C 5D DF C4 DD
F1A0 C4 DD C4 DD    	DW	CTRL00,CTRL00,CTRL12,CTRL00	;P,Q,R,S
F1A4 5D DE C4 DD
F1A8 C4 DD C4 DD    	DW	CTRL00,CTRL00,CTRL00,CTRL00	;T,U,V,W
F1AC C4 DD C4 DD
F1B0 C4 DD C4 DD    	DW	CTRL00,CTRL00,CTRL0C,CTRL1B	;X,Y,Z,ESC
F1B4 1B DF 6C DE
F1B8 EB DD D7 DD    	DW	CTRL1C,CTRL1D,CTRL1E,CTRL1F	;→,←,↑,↓
F1BC E0 DD 48 DF
F1C0                
F1C0 02 00          M2D:	DW	2
F1C2 FD 02          	DB	0FDH,2
F1C4 64 01          	DW	356
F1C6 FF 07 28 09    	DB	0FFH,7,40,9,1,082H
F1CA 01 82
F1CC 05 00 A7 00    	DW	5,0A7H,8
F1D0 08 00
F1D2                
F1D2 02 00          M2HD:	DW	2
F1D4 FE 01          	DB	0FEH,1
F1D6 C7 04          	DW	1223
F1D8 FE 06 4D 08    	DB	0FEH,6,77,8,1,084H
F1DC 01 84
F1DE 05 00 A7 00    	DW	5,0A7H,9
F1E2 09 00
F1E4                
F1E4                	DS	6
F1EA                
F1EA 16 17          SDDATA:	DB	22,23		;(FCB)ファイルを最後に変更した時刻
F1EC 14 15          	DB	20,21		;(FCB)ファイルを最後に変更した日付
F1EE 1A 1B          	DB	26,27		;(FCB)ファイルの先頭クラスタ
F1F0 10 11 12 13    	DB	16,17,18,19	;(FCB)ファイルのサイズ(バイト単位)
F1F4                SDDATAE:
F1F4                
F1F4                SCDIR:	DS	2		;+14 +15
F1F6                SFBPS:	DS	2		;FBPS
F1F8                SFNDF:	DS	2		;FILEN DIRF
F1FA                
F1FA 00 00          _FATPS:	DW	0
F1FC 00 00          _DIRPS:	DW	0
F1FE 00 00          _CLPS:	DW	0
F200                
F200                _PE:
F200                	INCLUDE	"X1DPB.ASM"
F200                
F200                ;	LSX-Dodgers DPB
F200                ;	X1/turbo/Z
F200                
F200                DEVICE:
F200                
F200                ;	A:
F200                
F200 02 00          	DW	2	;DPB_00_FATLN
F202 EB F0          	DW	_FDRD	;DPB_02_DRD
F204 EE F0          	DW	_FDWT	;DPB_04_DWT
F206 FD             	DB	0FDH	;DPB_06_FATID
F207 02             	DB	2	;DPB_07_SECPCL
F208 64 01          	DW	356	;DPB_08_MAXCL
F20A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F20B 07             	DB	7	;DPB_0B_DIRSCNT
F20C 28             	DB	40	;DPB_0C_MAXCYL
F20D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F20E 01             	DB	1	;DPB_0E_FATPS
F20F 82             	DB	082H	;DPB_0F_BPS
F210 05 00          	DW	5	;DPB_10_DIRPS
F212 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F213 00             	DB	0	;DPB_13_UNITNO
F214 08 00          	DW	8	;DPB_14_ADDCL16
F216 00 00          	DW	0	;DPB_16
F218 00 00          	DW	0	;DPB_18
F21A 00 00          	DW	0	;DPB_1A_SDIR
F21C 46 44 44 30    	DB	"FDD0"	;DPB_1C_NAME
F220                
F220                ;	B:
F220                
F220 02 00          	DW	2	;DPB_00_FATLN
F222 EB F0          	DW	_FDRD	;DPB_02_DRD
F224 EE F0          	DW	_FDWT	;DPB_04_DWT
F226 FD             	DB	0FDH	;DPB_06_FATID
F227 02             	DB	2	;DPB_07_SECPCL
F228 64 01          	DW	356	;DPB_08_MAXCL
F22A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F22B 07             	DB	7	;DPB_0B_DIRSCNT
F22C 28             	DB	40	;DPB_0C_MAXCYL
F22D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F22E 01             	DB	1	;DPB_0E_FATPS
F22F 82             	DB	082H	;DPB_0F_BPS
F230 05 00          	DW	5	;DPB_10_DIRPS
F232 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F233 01             	DB	1	;DPB_13_UNITNO
F234 08 00          	DW	8	;DPB_14_ADDCL16
F236 00 00          	DW	0	;DPB_16
F238 00 00          	DW	0	;DPB_18
F23A 00 00          	DW	0	;DPB_1A_SDIR
F23C 46 44 44 31    	DB	"FDD1"	;DPB_1C_NAME
F240                
F240                ;	C:
F240                
F240 02 00          	DW	2	;DPB_00_FATLN
F242 EB F0          	DW	_FDRD	;DPB_02_DRD
F244 EE F0          	DW	_FDWT	;DPB_04_DWT
F246 FD             	DB	0FDH	;DPB_06_FATID
F247 02             	DB	2	;DPB_07_SECPCL
F248 64 01          	DW	356	;DPB_08_MAXCL
F24A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F24B 07             	DB	7	;DPB_0B_DIRSCNT
F24C 28             	DB	40	;DPB_0C_MAXCYL
F24D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F24E 01             	DB	1	;DPB_0E_FATPS
F24F 82             	DB	082H	;DPB_0F_BPS
F250 05 00          	DW	5	;DPB_10_DIRPS
F252 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F253 02             	DB	2	;DPB_13_UNITNO
F254 08 00          	DW	8	;DPB_14_ADDCL16
F256 00 00          	DW	0	;DPB_16
F258 00 00          	DW	0	;DPB_18
F25A 00 00          	DW	0	;DPB_1A_SDIR
F25C 46 44 44 32    	DB	"FDD2"	;DPB_1C_NAME
F260                
F260                ;	D:
F260                
F260 02 00          	DW	2	;DPB_00_FATLN
F262 EB F0          	DW	_FDRD	;DPB_02_DRD
F264 EE F0          	DW	_FDWT	;DPB_04_DWT
F266 FD             	DB	0FDH	;DPB_06_FATID
F267 02             	DB	2	;DPB_07_SECPCL
F268 64 01          	DW	356	;DPB_08_MAXCL
F26A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F26B 07             	DB	7	;DPB_0B_DIRSCNT
F26C 28             	DB	40	;DPB_0C_MAXCYL
F26D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F26E 01             	DB	1	;DPB_0E_FATPS
F26F 82             	DB	082H	;DPB_0F_BPS
F270 05 00          	DW	5	;DPB_10_DIRPS
F272 A7             	DB	0A7H	;DPB_12_DEVICE
F273 03             	DB	3	;DPB_13_UNITNO
F274 08 00          	DW	8	;DPB_14_ADDCL16
F276 00 00          	DW	0	;DPB_16
F278 00 00          	DW	0	;DPB_18
F27A 00 00          	DW	0	;DPB_1A_SDIR
F27C 46 44 44 33    	DB	"FDD3"	;DPB_1C_NAME
F280                
F280                ;	E:
F280                
F280 00 00          EMMFL:	DW	0	;DPB_00_FATLN
F282 E8 D7          EMMRD:	DW	EDRD	;DPB_02_DRD
F284 E4 D7          EMMWR:	DW	EDWT	;DPB_04_DWT
F286 FE             	DB	0FEH	;DPB_06_FATID
F287 02             	DB	2	;DPB_07_SECPCL
F288 00 00          EMMCL:	DW	0	;DPB_08_MAXCL
F28A 00             	DB	0	;DPB_0A_FDMODE
F28B 0C             	DB	12	;DPB_0B_DIRSCNT
F28C 00             	DB	0	;DPB_0C_MAXCYL
F28D 00             	DB	0	;DPB_0D_MAXSEC
F28E 02             	DB	2	;DPB_0E_FATPS
F28F 02             	DB	2	;DPB_0F_BPS
F290 0A 00          	DW	10	;DPB_10_DIRPS
F292 06             EMMDV:	DB	6	;DPB_12_DEVICE
F293 00             	DB	0	;DPB_13_UNITNO
F294 12 00          	DW	18	;DPB_14_ADDCL16
F296 00 00          	DW	0	;DPB_16
F298 00 00          	DW	0	;DPB_18
F29A 00 00          	DW	0	;DPB_1A_SDIR
F29C 45 4D 4D 30    	DB	"EMM0"	;DPB_1C_NAME
F2A0                
F2A0                ;	F:
F2A0                
F2A0 00 00          BANKFL:	DW	0	;DPB_00_FATLN
F2A2 7C D7          	DW	BDRD	;DPB_02_DRD
F2A4 78 D7          	DW	BDWT	;DPB_04_DWT
F2A6 F9             	DB	0F9H	;DPB_06_FATID
F2A7 02             	DB	2	;DPB_07_SECPCL
F2A8 00 00          BANKCL:	DW	0	;DPB_08_MAXCL
F2AA 00             	DB	0	;DPB_0A_FDMODE
F2AB 08             	DB	8	;DPB_0B_DIRSCNT
F2AC 00             	DB	0	;DPB_0C_MAXCYL
F2AD 01             	DB	1	;DPB_0D_MAXSEC
F2AE 00             	DB	0	;DPB_0E_FATPS
F2AF 02             	DB	2	;DPB_0F_BPS
F2B0 02 00          	DW	2	;DPB_10_DIRPS
F2B2 0B             BANKDV:	DB	00BH	;DPB_12_DEVICE
F2B3 00             	DB	0	;DPB_13_UNITNO
F2B4 06 00          	DW	6	;DPB_14_ADDCL16
F2B6 00 00          	DW	0	;DPB_16
F2B8 00 00          	DW	0	;DPB_18
F2BA 00 00          	DW	0	;DPB_1A_SDIR
F2BC 42 52 41 4D    	DB	"BRAM"	;DPB_1C_NAME
F2C0                
F2C0                ;	G:
F2C0                
F2C0 02 00          	DW	2	;DPB_00_FATLN
F2C2 39 D7          	DW	GDRD	;DPB_02_DRD
F2C4 50 D7          	DW	GDWT	;DPB_04_DWT
F2C6 FA             	DB	0FAH	;DPB_06_FATID
F2C7 01             	DB	1	;DPB_07_SECPCL
F2C8 B8 00          	DW	184	;DPB_08_MAXCL
F2CA 00             	DB	0	;DPB_0A_FDMODE
F2CB 07             	DB	7	;DPB_0B_DIRSCNT
F2CC 00             	DB	0	;DPB_0C_MAXCYL
F2CD 01             	DB	1	;DPB_0D_MAXSEC
F2CE 01             	DB	1	;DPB_0E_FATPS
F2CF 01             	DB	1	;DPB_0F_BPS
F2D0 03 00          	DW	3	;DPB_10_DIRPS
F2D2 05             	DB	5	;DPB_12_DEVICE
F2D3 01             	DB	1	;DPB_13_UNITNO
F2D4 08 00          	DW	8	;DPB_14_ADDCL16
F2D6 00 00          	DW	0	;DPB_16
F2D8 00 00          	DW	0	;DPB_18
F2DA 00 00          	DW	0	;DPB_1A_SDIR
F2DC 47 52 41 4D    	DB	"GRAM"	;DPB_1C_NAME
F2E0                
F2E0                ;	H:
F2E0                	DS	32-8
F2F8 00             	DB	0
F2F9                
F2F9                LAST_ADR:
F2F9                
F2F9                	END
F2F9                
