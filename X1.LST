0000                ;	LSX-Dodgers for X1/turbo/Z
0000                ;	Programmed by
0000                ;	Gaku (Lovers/Tablacus)
0000                
0000                	INCLUDE	"X1DEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                ;	X1/turbo/Z
0000                
0000 00 00 00 00    MAC	EQU	0		;X1
0000 00 00 00 00    DEV	EQU	0
0000                
0000 00 00 01 1D    VER_6F	EQU	0011DH
0000                
0000 00 00 CD 00    RUN	EQU	0CD00H
0000 00 00 D3 06    BDOS	EQU	0D306H
0000 00 00 F0 00    WORKAD	EQU	0F000H
0000 00 00 F3 00    FATBF	EQU	0F300H
0000 00 00 FB 00    DTBUF	EQU	0FB00H
0000 00 00 FF 00    KEYBF	EQU	0FF00H
0000 00 00 FF 20    KBUF	EQU	0FF20H
0000 00 00 FF CA    EXTSP	EQU	0FFCAH
0000 00 00 FF D9    TRAP38	EQU	0FFD9H
0000 00 00 00 50    WIDTH	EQU	80
0000 00 00 00 18    LINE	EQU	24
0000 00 00 00 07    COLORF	EQU	7
0000 00 00 00 10    KEYSP_H	EQU	16
0000 00 00 00 C2    KEYSP_L	EQU	0C2H
0000 00 00 00 08    COMS	EQU	8
0000                
0000                	INCLUDE	"LDDEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                
0000 00 00 00 01    VER_1   EQU	1
0000 00 00 00 05    VER_2   EQU	5
0000 00 00 00 09    VER_3   EQU	9
0000 00 00 1D 00    MACW	EQU	MAC + 01D00H	;機種フラグとLD判別フラグ
0000 00 00 00 00    MACD	EQU	MAC + DEV * 256	;機種フラグとデバイスフラグ
0000 00 00 01 59    VER	EQU	VER_1 * 256 + VER_2 * 16 + VER_3
0000                
0000 00 00 00 05    SYSTEM	EQU	00005H
0000 00 00 00 0F    JP_HL	EQU	0000FH
0000 00 00 00 5C    FCB1	EQU	0005CH
0000 00 00 00 6C    FCB2	EQU	0006CH
0000 00 00 00 5D    FCB1FN	EQU	FCB1+1
0000 00 00 00 6D    FCB2FN	EQU	FCB2+1
0000 00 00 00 80    DTA1	EQU	00080H
0000                
0000 00 00 FF CA    EXTBIO	EQU	0FFCAH
0000                
0000 00 00 00 00    DPB_FATLN	EQU	00H
0000 00 00 00 02    DPB_DRD		EQU	02H
0000 00 00 00 04    DPB_DWT		EQU	04H
0000 00 00 00 06    DPB_FATID	EQU	06H
0000 00 00 00 07    DPB_SECPCL	EQU	07H
0000 00 00 00 08    DPB_MAXCL	EQU	08H
0000 00 00 00 0A    DPB_FDMODE	EQU	0AH
0000 00 00 00 0B    DPB_DIRSCNT	EQU	0BH
0000 00 00 00 0C    DPB_MAXCYL	EQU	0CH
0000 00 00 00 0D    DPB_MAXSEC	EQU	0DH
0000 00 00 00 0E    DPB_FATPS	EQU	0EH
0000 00 00 00 0F    DPB_BPS		EQU	0FH
0000 00 00 00 10    DPB_DIRPS	EQU	10H
0000 00 00 00 12    DPB_DEVICE	EQU	12H
0000 00 00 00 13    DPB_UNITNO	EQU	13H
0000 00 00 00 14    DPB_ADDCL	EQU	14H
0000                
0000 00 00 00 1A    DPB_SDIR	EQU	1AH
0000 00 00 00 1C    DPB_NAME	EQU	1CH
0000                
0000                
0000                	ORG	RUN-7
CCF9                
CCF9                ;	MSX BINARY HEADER
CCF9 FE             	DB	0FEH
CCFA                ;	MSX BINARY START ADDRESS
CCFA 00 CD          	DW	RUN
CCFC                ;	MSX BINARY END ADDRESS
CCFC F9 F2          	DW	LAST_ADR
CCFE                ;	MSX BINARY EXEC ADDRESS
CCFE 07 CD          	DW	START
CD00                
CD00                	INCLUDE	"X1INIT.ASM"
CD00                
CD00                ;	LSX-Dodgers INIT
CD00                ;	X1/turbo/Z
CD00                
CD00 C3 07 CD       	JP	START
CD03 00 1D          	DW	MACW
CD05 59 01          	DW	VER
CD07                
CD07                START:
CD07 F3             	DI
CD08 ED 5E          	IM	2
CD0A 31 CA FF       	LD	SP,EXTSP
CD0D CD 1B CD       	CALL	INIT		;NZならAUTOEXECを実行
CD10 21 00 00       	LD	HL,0
CD13 E5             	PUSH	HL
CD14 C8             	RET	Z
CD15 11 79 D0       	LD	DE,AUTOD
CD18 C3 FD F0       	JP	_COMANL
CD1B                
CD1B                INIT:
CD1B 3E 1E          	LD	A,01EH
CD1D D3 00          	OUT	(0),A
CD1F                
CD1F 01 00 00       	LD	BC,0
CD22 ED 43 8C F0    	LD	(_CTC),BC
CD26 01 04 0A       	LD	BC,00A04H
CD29 CD 23 D0       	CALL	CHKCTC
CD2C 01 04 07       	LD	BC,00704H
CD2F CD 23 D0       	CALL	CHKCTC
CD32 01 A8 1F       	LD	BC,01FA8H
CD35 CD 23 D0       	CALL	CHKCTC
CD38 01 A0 1F       	LD	BC,01FA0H
CD3B CD 23 D0       	CALL	CHKCTC
CD3E                ;
CD3E                INISIO:
CD3E 01 91 1F       	LD	BC,01F91H	;INIT SIO
CD41 16 01          	LD	D,1
CD43 ED 51          	OUT	(C),D
CD45                
CD45 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CD47 0E 93          	LD	C,093H
CD49 ED 51          	OUT	(C),D
CD4B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CD4D 0E 99          	LD	C,099H		;INIT SIO
CD4F 16 01          	LD	D,1
CD51 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CD53 0E 9B          	LD	C,09BH
CD55 ED 51          	OUT	(C),D
CD57 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CD59                
CD59 0E 80          	LD	C,080H		;INIT DMA
CD5B 21 06 C3       	LD	HL,0C306H
CD5E                INIDMA:
CD5E ED 61          	OUT	(C),H
CD60 2D             	DEC	L
CD61 20 FB          	JR	NZ,INIDMA
CD63                
CD63 3E E4          	LD	A,0E4H
CD65 CD F3 DE       	CALL	COMOUT
CD68 AF             	XOR	A
CD69 CD CD DE       	CALL	OT49SB
CD6C                
CD6C 3E F0          	LD	A,INTVEC/256
CD6E ED 47          	LD	I,A
CD70                
CD70 ED 4B 8C F0    	LD	BC,(_CTC)
CD74 0D             	DEC	C
CD75 0D             	DEC	C
CD76                
CD76 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CD78 3E C0          	LD	A,CTC0-CPM_BOOT
CD7A ED 79          	OUT	(C),A
CD7C                
CD7C 0C             	INC	C
CD7D 3E 47          	LD	A,047H
CD7F ED 79          	OUT	(C),A
CD81 3E 0D          	LD	A,13		;Baudrate 9600-13
CD83 ED 79          	OUT	(C),A
CD85                
CD85 79             	LD	A,C
CD86 D6 10          	SUB	010H
CD88 4F             	LD	C,A
CD89                ;	LD	(SIOAD+1),BC
CD89                ;	LD	(SIOAD0+1),BC
CD89                ;	LD	(SIOAD1+1),BC
CD89                
CD89 21 C9 D0       	LD	HL,SIODATA
CD8C                SINIT1:
CD8C 7E             	LD	A,(HL)
CD8D 23             	INC	HL
CD8E FE FF          	CP	0FFH
CD90 28 04          	JR	Z,SINIT2
CD92 ED 79          	OUT	(C),A
CD94 18 F6          	JR	SINIT1
CD96                SINIT2:
CD96 3E E4          	LD	A,0E4H
CD98 CD F3 DE       	CALL	COMOUT
CD9B 3E C8          	LD	A,INTVEC-CPM_BOOT
CD9D CD CD DE       	CALL	OT49SB
CDA0                ;
CDA0 01 C4 1F       	LD	BC,01FC4H
CDA3 3E 0C          	LD	A,00CH
CDA5 ED 79          	OUT	(C),A
CDA7                
CDA7 0E C0          	LD	C,0C0H
CDA9 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDAB                
CDAB 0C             	INC	C
CDAC 3E 28          	LD	A,40
CDAE ED 79          	OUT	(C),A
CDB0                
CDB0 0C             	INC	C
CDB1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDB3                
CDB3 0C             	INC	C
CDB4 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDB6                
CDB6 0E C5          	LD	C,0C5H
CDB8 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDBA                
CDBA                TEXT:
CDBA 0E B0          	LD	C,0B0H
CDBC 3E 80          	LD	A,080H
CDBE ED 79          	OUT	(C),A
CDC0 16 07          	LD	D,7
CDC2 0E B9          	LD	C,0B9H
CDC4 21 C2 D0       	LD	HL,TEXTDT
CDC7                TEXT1:
CDC7 04             	INC	B
CDC8 ED A3          	OUTI
CDCA 0C             	INC	C
CDCB 15             	DEC	D
CDCC 20 F9          	JR	NZ,TEXT1
CDCE 01 B0 1F       	LD	BC,01FB0H
CDD1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDD3                
CDD3 0E C4          	LD	C,0C4H
CDD5 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CDD7                
CDD7 01 01 1A       	LD	BC,01A01H
CDDA ED 78          	IN	A,(C)
CDDC E6 08          	AND	8
CDDE 28 09          	JR	Z,PRN
CDE0 0E 03          	LD	C,003H
CDE2 3E 0F          	LD	A,00FH
CDE4 ED 79          	OUT	(C),A
CDE6 01 04 0A       	LD	BC,00A04H
CDE9                PRN:
CDE9 21 00 00       	LD	HL,0
CDEC 06 5C          	LD	B,05CH
CDEE 3E             	DB	03EH	;LD A,??
CDEF FF             	RST	38H
CDF0 CD 4D E1       	CALL	FILL_MEMORY
CDF3 06 A4          	LD	B,0A4H
CDF5 AF             	XOR	A
CDF6 CD 4D E1       	CALL	FILL_MEMORY
CDF9                
CDF9 3E C3          	LD	A,0C3H		;JP
CDFB 21 03 F0       	LD	HL,CPM_WBOOT
CDFE 32 00 00       	LD	(00000H),A
CE01 22 01 00       	LD	(00001H),HL	;IPL
CE04                
CE04 21 00 1D       	LD	HL,MACW	;3 bit7  DPB Compatible LA(1)
CE07 22 03 00       	LD	(00003H),HL	;  bit6-0 Machine X1(0)
CE0A                ;				;4 LSX-Dodgers(01DH)
CE0A 21 06 D3       	LD	HL,BDOS
CE0D 32 05 00       	LD	(00005H),A
CE10 22 06 00       	LD	(00006H),HL	;BDOS
CE13                
CE13 21 24 DB       	LD	HL,BIOS
CE16 22 19 00       	LD	(00019H),HL	;BIOS-ROM
CE19                
CE19 21 D9 FF       	LD	HL,TRAP38	;TRAP38
CE1C 32 38 00       	LD	(00038H),A
CE1F 22 39 00       	LD	(00039H),HL	;RST 038H
CE22                
CE22 3E F0          	LD	A,CPM_BOOT/256
CE24 32 0B 00       	LD	(0000BH),A
CE27                
CE27 3E             	DB	03EH	;LD A,??
CE28 E9             	JP	(HL)
CE29 32 0F 00       	LD	(0000FH),A
CE2C                
CE2C 3E E6          	LD	A,0E6H
CE2E CD F3 DE       	CALL	COMOUT
CE31 CD D8 DE       	CALL	IN49SB
CE34 F5             	PUSH	AF
CE35 CD D8 DE       	CALL	IN49SB
CE38 F1             	POP	AF
CE39 F5             	PUSH	AF
CE3A E6 12          	AND	012H
CE3C 20 05          	JR	NZ,KEYR
CE3E 3E 01          	LD	A,1
CE40 32 96 CF       	LD	(KEYREP+1),A
CE43                KEYR:
CE43 F1             	POP	AF
CE44 E6 03          	AND	3
CE46 28 0E          	JR	Z,NON
CE48                
CE48 01 D0 3F       	LD	BC,03FD0H
CE4B ED 49          	OUT	(C),C
CE4D 3E 37          	LD	A,037H
CE4F D3 D0          	OUT	(0D0H),A
CE51 ED 78          	IN	A,(C)
CE53 B9             	CP	C
CE54 28 4B          	JR	Z,TURBO
CE56                NON:
CE56 21 FC D0       	LD	HL,AT_SCR1
CE59 11 7D DF       	LD	DE,SCR1
CE5C 01 94 00       	LD	BC,SCRNE-SCR1	;転送先のサイズ確認用
CE5F 01 85 00       	LD	BC,AT_SCRE-AT_SCR1
CE62 ED B0          	LDIR
CE64                
CE64 21 81 D1       	LD	HL,AT_DWT
CE67 11 D6 EE       	LD	DE,WTTRK
CE6A 01 8F 00       	LD	BC,DMAE-WTTRK	;転送先のサイズ確認用
CE6D 01 8E 00       	LD	BC,AT_CPUE-AT_DWT
CE70 ED B0          	LDIR
CE72                
CE72 21 F8 DF       	LD	HL,AT_WTTRK+AT_RS
CE75 22 E9 F0       	LD	(_WTTRK+1),HL
CE78 21 1F EF       	LD	HL,AT_DRD+AT_R
CE7B 22 EC F0       	LD	(_FDRD+1),HL
CE7E 21 D6 EE       	LD	HL,AT_DWT+AT_R
CE81 22 EF F0       	LD	(_FDWT+1),HL
CE84 21 FF DF       	LD	HL,AT_SCRN+AT_RS
CE87 22 D1 F0       	LD	(_SCRN+1),HL
CE8A                
CE8A 3E 27          	LD	A,027H			;ノンターボはMFM切り替えを行わない
CE8C 32 12 F2       	LD	(_DEVICE+012H),A	;Aドライブ
CE8F 32 32 F2       	LD	(_DEVICE+012H+32),A	;Bドライブ
CE92 32 52 F2       	LD	(_DEVICE+012H+32*2),A	;Cドライブ
CE95 32 72 F2       	LD	(_DEVICE+012H+32*3),A	;Dドライブ
CE98                
CE98 21 00 00       	LD	HL,0
CE9B 22 1E DF       	LD	(X1PAT),HL
CE9E C3 2A CF       	JP	NOBANK
CEA1                
CEA1                TURBO:
CEA1 F3             	DI			;Check BIOS
CEA2 06 1D          	LD	B,01DH
CEA4 ED 79          	OUT	(C),A		;BIOS ON
CEA6 3A 51 2F       	LD	A,(02F51H)
CEA9 04             	INC	B		;B=01EH
CEAA ED 79          	OUT	(C),A		;BIOS OFF
CEAC FB             	EI
CEAD FE C9          	CP	0C9H
CEAF 28 02          	JR	Z,BIOSOK
CEB1 18 05          	JR	NOBIOS
CEB3                BIOSOK:
CEB3 3E C3          	LD	A,0C3H		;JP
CEB5 32 18 00       	LD	(00018H),A
CEB8                NOBIOS:
CEB8 3E 1F          	LD	A,01FH		;スタートポート
CEBA DB F0          	IN	A,(0F0H)
CEBC 0F             	RRCA
CEBD 38 0B          	JR	C,CRT1
CEBF 21 B2 D0       	LD	HL,_C8025H
CEC2 11 B0 F0       	LD	DE,CRTCD
CEC5 01 10 00       	LD	BC,16
CEC8 ED B0          	LDIR
CECA                CRT1:
CECA 3E 1F          	LD	A,01FH		;スタートポート
CECC DB F0          	IN	A,(0F0H)
CECE CB 57          	BIT	2,A
CED0 28 18          	JR	Z,BANK
CED2                
CED2 AF             	XOR	A
CED3                TZ1:				;前面スイッチが2HDの場合はMFMモードを2HDにしておく
CED3 F5             	PUSH	AF
CED4 CD DC F0       	CALL	_GETDPB
CED7 DD 7E 12       	LD	A,(IX+DPB_DEVICE)
CEDA E6 8F          	AND	08FH
CEDC FE 87          	CP	087H		;フロッピーでMEM切り替えがON
CEDE 20 04          	JR	NZ,TZ2
CEE0 DD CB 0A 86    	RES	0,(IX+DPB_FDMODE)
CEE4                TZ2:
CEE4 F1             	POP	AF
CEE5 3C             	INC	A
CEE6 FE 08          	CP	8
CEE8 38 E9          	JR	C,TZ1
CEEA                
CEEA                BANK:
CEEA 01 00 0B       	LD	BC,00B00H
CEED 21 00 7F       	LD	HL,07F00H
CEF0 F3             	DI
CEF1 ED 69          	OUT	(C),L
CEF3 3A 00 00       	LD	A,(0)
CEF6 FE EB          	CP	0EBH
CEF8 20 05          	JR	NZ,BANK1
CEFA 3E 2B          	LD	A,02BH
CEFC 32 B2 F2       	LD	(BANKDV),A
CEFF                BANK1:
CEFF ED 69          	OUT	(C),L
CF01 5E             	LD	E,(HL)
CF02 7B             	LD	A,E
CF03 C6 A5          	ADD	A,0A5H
CF05 77             	LD	(HL),A
CF06 BE             	CP	(HL)
CF07 73             	LD	(HL),E
CF08 20 05          	JR	NZ,BANK2
CF0A 2C             	INC	L
CF0B CB 65          	BIT	4,L
CF0D 28 F0          	JR	Z,BANK1
CF0F                BANK2:
CF0F 3E 10          	LD	A,010H
CF11 ED 79          	OUT	(C),A
CF13 7D             	LD	A,L
CF14 B7             	OR	A
CF15 28 13          	JR	Z,NOBANK
CF17 26 00          	LD	H,0
CF19 29             	ADD	HL,HL	;*2
CF1A 29             	ADD	HL,HL	;*4
CF1B 29             	ADD	HL,HL	;*8
CF1C 29             	ADD	HL,HL	;*16
CF1D 29             	ADD	HL,HL	;*32
CF1E 2B             	DEC	HL	;-1
CF1F 2B             	DEC	HL	;-2
CF20 2B             	DEC	HL	;-3
CF21 22 A8 F2       	LD	(BANKCL),HL
CF24 CD 69 D0       	CALL	CALC_FATLN
CF27 32 A0 F2       	LD	(BANKFL),A
CF2A                NOBANK:
CF2A                EMM:
CF2A DD 21 80 F2    	LD	IX,EMMFL
CF2E CD 14 D0       	CALL	EADR0
CF31 ED 78          	IN	A,(C)
CF33 F5             	PUSH	AF
CF34                
CF34 11 00 00       	LD	DE,0
CF37                ECHECK1:
CF37 13             	INC	DE
CF38 CD 1D D0       	CALL	EADRX
CF3B ED 60          	IN	H,(C)
CF3D CD 1D D0       	CALL	EADRX
CF40 7C             	LD	A,H
CF41 C6 E5          	ADD	A,0E5H
CF43 ED 79          	OUT	(C),A
CF45 3C             	INC	A
CF46 CD 14 D0       	CALL	EADR0
CF49 ED 79          	OUT	(C),A
CF4B 3D             	DEC	A
CF4C CD 1D D0       	CALL	EADRX
CF4F ED 68          	IN	L,(C)
CF51 CD 1D D0       	CALL	EADRX
CF54 ED 61          	OUT	(C),H
CF56 BD             	CP	L
CF57 20 04          	JR	NZ,ECHECK2
CF59 CB 5A          	BIT	3,D
CF5B 28 DA          	JR	Z,ECHECK1
CF5D                ECHECK2:
CF5D CD 14 D0       	CALL	EADR0
CF60 F1             	POP	AF
CF61 ED 79          	OUT	(C),A
CF63 FE EB          	CP	0EBH
CF65 28 17          	JR	Z,EMM_BPB
CF67 DD 36 0D 02    	LD	(IX+DPB_MAXSEC),2	;BPBが512バイト目から始まる場合を調べる
CF6B CD 14 D0       	CALL	EADR0
CF6E ED 78          	IN	A,(C)
CF70 DD BE 06       	CP	(IX+DPB_FATID)
CF73 28 0D          	JR	Z,EMM_NOBPB
CF75 DD 36 12 26    	LD	(IX+DPB_DEVICE),026H	;BPPを使う
CF79 21 F5 FF       	LD	HL,0-11
CF7C 18 0B          	JR	EMM_BPB1
CF7E                EMM_BPB:
CF7E DD 36 12 26    	LD	(IX+DPB_DEVICE),026H	;BPPを使う
CF82                EMM_NOBPB:
CF82 DD 36 0D 00    	LD	(IX+DPB_MAXSEC),0
CF86 21 F7 FF       	LD	HL,0-9
CF89                EMM_BPB1:
CF89 19             	ADD	HL,DE
CF8A 30 09          	JR	NC,NOEMM
CF8C 22 88 F2       	LD	(EMMCL),HL
CF8F CD 69 D0       	CALL	CALC_FATLN
CF92 32 80 F2       	LD	(EMMFL),A
CF95                NOEMM:
CF95 3E 00          KEYREP:	LD	A,000H
CF97 B7             	OR	A
CF98 28 07          	JR	Z,KEYR1
CF9A 01 00 00       	LD	BC,0
CF9D ED 43 8C F0    	LD	(_CTC),BC
CFA1                KEYR1:
CFA1 CD 4A D0       	CALL	SETCRTC
CFA4 01 30 F8       	LD	BC,0-80*25
CFA7 2A BA F0       	LD	HL,(_PAGE_MINUS)
CFAA ED 43 BA F0    	LD	(_PAGE_MINUS),BC
CFAE 1E 0C          	LD	E,00CH
CFB0 CD CD F0       	CALL	_PRINT
CFB3 22 BA F0       	LD	(_PAGE_MINUS),HL
CFB6                
CFB6 21 85 D0       	LD	HL,INIMES
CFB9 CD A4 D8       	CALL	MSX
CFBC                
CFBC 3A 87 FF       	LD	A,(0FF87H)
CFBF FE 08          	CP	8
CFC1 30 14          	JR	NC,INIT0
CFC3 5F             	LD	E,A
CFC4 C6 41          	ADD	A,'A'
CFC6 32 82 D0       	LD	(AUTODV),A
CFC9 0E 0E          	LD	C,00EH
CFCB CD 05 00       	CALL	SYSTEM
CFCE 1C             	INC	E
CFCF 0E 1B          	LD	C,01BH
CFD1 CD 05 00       	CALL	SYSTEM
CFD4                
CFD4 3C             	INC	A
CFD5 20 08          	JR	NZ,INIT1
CFD7                INIT0:
CFD7 1E 00          	LD	E,0
CFD9 0E 0E          	LD	C,00EH
CFDB CD 05 00       	CALL	SYSTEM
CFDE AF             	XOR	A
CFDF                INIT1:
CFDF F3             	DI
CFE0 08             	EX	AF,AF'
CFE1 2E FE          	LD	L,0-2		;CALLのスタック分減らす
CFE3 39             	ADD	HL,SP
CFE4 11 00 FF       	LD	DE,0FF00H
CFE7 45             	LD	B,L
CFE8 CD 56 D6       	CALL	ZERO_MEMORY_DE
CFEB 21 CA FF       	LD	HL,EXTBIO
CFEE 36 C9          	LD	(HL),0C9H	;RET
CFF0 23             	INC	HL
CFF1 06 0E          	LD	B,TRAP38-EXTBIO-1
CFF3 3E             	DB	03EH	;LD A,??
CFF4 FF             	RST	38H
CFF5 CD 4D E1       	CALL	FILL_MEMORY
CFF8 21 D5 D0       	LD	HL,AT_TRAP38
CFFB 11 D9 FF       	LD	DE,TRAP38
CFFE 01 27 00       	LD	BC,AT_TRAPE-AT_TRAP38
D001 ED B0          	LDIR
D003 08             	EX	AF,AF'
D004 B7             	OR	A
D005 C8             	RET	Z
D006                
D006 3E E6          	LD	A,0E6H
D008 CD F3 DE       	CALL	COMOUT
D00B CD D8 DE       	CALL	IN49SB
D00E CD D8 DE       	CALL	IN49SB
D011 FE 1B          	CP	01BH
D013 C9             	RET
D014                
D014                EADR0:
D014 D5             	PUSH	DE
D015 11 00 00       	LD	DE,0
D018 CD 1D D0       	CALL	EADRX
D01B D1             	POP	DE
D01C C9             	RET
D01D                
D01D                EADRX:
D01D F5             	PUSH	AF
D01E CD 45 D8       	CALL	EADR
D021 F1             	POP	AF
D022 C9             	RET
D023                
D023                CHKCTC:
D023 C5             	PUSH	BC
D024 11 03 47       	LD	DE,04703H
D027                INICTC1:
D027 0C             	INC	C
D028 ED 51          	OUT	(C),D
D02A ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
D02C 1D             	DEC	E
D02D 20 F8          	JR	NZ,INICTC1
D02F C1             	POP	BC
D030                
D030 11 FA 07       	LD	DE,007FAH
D033 ED 51          	OUT	(C),D
D035 ED 59          	OUT	(C),E
D037 ED 78          	IN	A,(C)
D039 BB             	CP	E
D03A C0             	RET	NZ
D03B ED 51          	OUT	(C),D
D03D ED 51          	OUT	(C),D
D03F ED 78          	IN	A,(C)
D041 BA             	CP	D
D042 C0             	RET	NZ
D043 0C             	INC	C
D044 0C             	INC	C
D045 ED 43 8C F0    	LD	(_CTC),BC
D049 C9             	RET
D04A                
D04A                SETCRTC:
D04A 21 B0 F0       	LD	HL,CRTCD
D04D AF             	XOR	A
D04E                SETCRT1:
D04E 01 00 18       	LD	BC,01800H
D051 ED 79          	OUT	(C),A
D053 0C             	INC	C
D054 04             	INC	B
D055 ED A3          	OUTI
D057 3C             	INC	A
D058 FE 0C          	CP	12
D05A 20 F2          	JR	NZ,SETCRT1
D05C 23             	INC	HL
D05D 23             	INC	HL
D05E 01 03 1B       	LD	BC,01A03H+00100H
D061 ED A3          	OUTI
D063 01 D0 20       	LD	BC,01FD0H+00100H
D066 ED A3          	OUTI
D068 C9             	RET
D069                
D069                CALC_FATLN:	;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
D069 5D             	LD	E,L
D06A 54             	LD	D,H
D06B 29             	ADD	HL,HL	;*2
D06C 19             	ADD	HL,DE	;*3
D06D CB 3C          	SRL	H	;/2
D06F CB 1D          	RR	L	;1クラスタ辺り1.5バイト必要
D071 11 FF 01       	LD	DE,511	;切り上げる
D074 19             	ADD	HL,DE
D075 7C             	LD	A,H
D076 CB 3F          	SRL	A
D078 C9             	RET
D079                
D079 41 55 54 4F    AUTOD:	DB	"AUTOEXEC "
D07D 45 58 45 43
D081 20
D082 41 3A 00       AUTODV:	DB	"A:",0
D085                
D085 4C 53 58 2D    INIMES:	DB	"LSX-Dodgers for X1/turbo version "
D089 44 6F 64 67
D08D 65 72 73 20
D091 66 6F 72 20
D095 58 31 2F 74
D099 75 72 62 6F
D09D 20 76 65 72
D0A1 73 69 6F 6E
D0A5 20
D0A6 31 2E          	DB	030H + VER_1, '.'
D0A8 35 39          	DB	030H + VER_2 ,030H + VER_3
D0AA                ;	DB	""
D0AA 20 47 61 6B    	DB	' Gaku',0DH,0AH
D0AE 75 0D 0A
D0B1 00             	DB	0
D0B2                
D0B2                _C8025H:
D0B2 6B 50 59 88    	DB	06BH,050H,059H,088H,01BH,001H,019H,01AH
D0B6 1B 01 19 1A
D0BA 00 0F          	DB	000H,00FH
D0BC 80 F8 B0 FF    	DW	0-80*LINE,0-80
D0C0 0C 23          	DB	00CH,023H
D0C2                
D0C2 03 0C 0F 30    TEXTDT:	DB	003H,00CH,00FH,030H,033H,03CH,03FH
D0C6 33 3C 3F
D0C9                
D0C9                SIODATA:
D0C9 18             	DB	018H
D0CA 01 00          	DB	1,0
D0CC 02 00          	DB	2,0
D0CE 03 C1          	DB	3,0C1H
D0D0 04 44          	DB	4,044H
D0D2 05 E8          	DB	5,0E8H
D0D4 FF             	DB	0FFH
D0D5                
D0D5                AT_TRAP38:
D0D5 21 00 00       	LD	HL,0
D0D8 E3             	EX	(SP),HL
D0D9 3E 24          	LD	A,'$'
D0DB CD A2 DB       	CALL	MSG_A
D0DE 2B             	DEC	HL
D0DF 7C             	LD	A,H
D0E0 CD E8 FF       	CALL	PRHX+AT_RT
D0E3 7D             	LD	A,L
D0E4                PRHX:
D0E4 F5             	PUSH	AF
D0E5 07             	RLCA
D0E6 07             	RLCA
D0E7 07             	RLCA
D0E8 07             	RLCA
D0E9 CD F1 FF       	CALL	PRHX2+AT_RT
D0EC F1             	POP	AF
D0ED                PRHX2:
D0ED E6 0F          	AND	00FH
D0EF FE 0A          	CP	10
D0F1 3F             	CCF
D0F2 CE 30          	ADC	A,'0'
D0F4 27             	DAA
D0F5 C3 A2 DB       	JP	MSG_A
D0F8                	DS	4
D0FC                AT_TRAPE:
D0FC                	INCLUDE	"X1CPU.ASM"
D0FC                
D0FC                ;	LSX-Dodgers CPU
D0FC                ;	X1/turbo/Z
D0FC                
D0FC                ;	ノンターボ用パッチ
D0FC                ;	DMAを使って転送している部分をCPUに差し替える
D0FC                
D0FC                AT_SCR1:
D0FC D9             	EXX
D0FD C5             	PUSH	BC
D0FE ED 4B B1 F0    	LD	BC,(_WIDTH)
D102 06 20          	LD	B,020H
D104 D9             	EXX
D105 C5             	PUSH	BC
D106 01 00 20       	LD	BC,02000H
D109                
D109 67             	LD	H,A
D10A B7             	OR	A
D10B                AT_SCRUP1:
D10B 28 15          	JR	Z,AT_SCRCL
D10D C5             	PUSH	BC
D10E CB E0          	SET	4,B
D110 D9             	EXX
D111 C5             	PUSH	BC
D112 CB E0          	SET	4,B
D114 D9             	EXX
D115 CD AE DF       	CALL	AT_UPSUB+AT_RS
D118 D9             	EXX
D119 C1             	POP	BC
D11A D9             	EXX
D11B C1             	POP	BC
D11C CD AE DF       	CALL	AT_UPSUB+AT_RS
D11F 25             	DEC	H
D120 18 E9          	JR	AT_SCRUP1
D122                
D122                AT_SCRCL:
D122 2A B1 F0       	LD	HL,(_WIDTH)
D125 CD 46 DE       	CALL	LINECL
D128 C1             	POP	BC
D129 D9             	EXX
D12A C1             	POP	BC
D12B D9             	EXX
D12C C9             	RET
D12D                
D12D                AT_UPSUB:
D12D 3A B1 F0       	LD	A,(_WIDTH)
D130 6F             	LD	L,A
D131                AT_UPSUB1:
D131 D9             	EXX
D132 ED 78          	IN	A,(C)
D134 03             	INC	BC
D135 D9             	EXX
D136 ED 79          	OUT	(C),A
D138 03             	INC	BC
D139 2D             	DEC	L
D13A 20 F5          	JR	NZ,AT_UPSUB1
D13C C9             	RET
D13D                
D13D                ;	FLOPPY DISK DRIVER(CPU)
D13D                
D13D                DISKC:
D13D 1B             	DEC	DE
D13E CB 5F          	BIT	3,A
D140 C4 CF EE       	CALL	NZ,RNF
D143                DISKD:
D143 E5             	PUSH	HL
D144 21 D5 EE       	LD	HL,RETRY
D147 35             	DEC	(HL)
D148 E1             	POP	HL
D149 20 0C          	JR	NZ,AT_ERR		;Retry
D14B B7             	OR	A
D14C 28 09          	JR	Z,AT_ERR		;Error
D14E                
D14E                AT_DELP:
D14E CD CF EE       	CALL	RNF
D151 CD AB EE       	CALL	FDMOFF
D154 3E FF          	LD	A,0FFH
D156                AT_ERRZ:
D156 BF             	CP	A
D157                AT_ERR:
D157 3E FF          	LD	A,0FFH
D159 C9             	RET
D15A                ERRW:
D15A 3E FF          	LD	A,0FFH
D15C BF             	CP	A
D15D 37             	SCF
D15E C3 AB EE       	JP	FDMOFF
D161                
D161                ERRDW:
D161 D1             	POP	DE
D162 CD CF DF       	CALL	AT_DELP+AT_RS
D165 C2 E4 EE       	JP	NZ,DWT0+AT_R
D168 B7             	OR	A
D169 20 EF          	JR	NZ,ERRW
D16B C9             	RET
D16C                
D16C                ERRDR:
D16C D1             	POP	DE
D16D CD CF DF       	CALL	AT_DELP+AT_RS
D170 C2 2D EF       	JP	NZ,DRD0+AT_R
D173 B7             	OR	A
D174 20 E4          	JR	NZ,ERRW
D176 C9             	RET
D177                
D177                AT_WTTRK:
D177 06 01          	LD	B,1
D179 3E F4          	LD	A,0F4H
D17B C3 D8 EE       	JP	AT_WTTRK1+AT_R
D17E                
D17E                AT_SCRN:
D17E ED 78          	IN	A,(C)
D180 C9             	RET
D181                AT_SCRE:
D181                
D181                AT_DWT:
D181 3E A0          	LD	A,0A0H
D183                AT_WTTRK1:
D183 32 64 EE       	LD	(FDCPAT+1),A
D186                DWTBL:
D186 78             	LD	A,B
D187 32 1B EF       	LD	(AT_WTB+1+AT_R),A
D18A 3E 02          	LD	A,2		;Retry count
D18C 32 D5 EE       	LD	(RETRY),A
D18F                
D18F                DWT0:
D18F D5             	PUSH	DE
D190 E5             	PUSH	HL
D191 CD 05 EE       	CALL	SEEK		;Write disk
D194 E1             	POP	HL
D195 DA E2 DF       	JP	C,ERRDW+AT_RS
D198 F3             	DI
D199 3A 64 EE       	LD	A,(FDCPAT+1)
D19C CD B7 EE       	CALL	SECSET
D19F 0E FB          	LD	C,0FBH
D1A1                
D1A1                DWT1:
D1A1 56             	LD	D,(HL)
D1A2                DWT2:
D1A2 78             	LD	A,B
D1A3 DB F8          	IN	A,(0F8H)
D1A5 0F             	RRCA
D1A6 30 08          	JR	NC,DWT4
D1A8 0F             	RRCA
D1A9 30 F7          	JR	NC,DWT2
D1AB                DWT3:
D1AB ED 51          	OUT	(C),D
D1AD 23             	INC	HL
D1AE 18 F1          	JR	DWT1
D1B0                
D1B0                DWT4:
D1B0 3D             	DEC	A
D1B1 28 F8          	JR	Z,DWT3
D1B3 3C             	INC	A
D1B4 FB             	EI
D1B5 D1             	POP	DE
D1B6 13             	INC	DE
D1B7 CD AB EE       	CALL	FDMOFF
D1BA 28 09          	JR	Z,DISKOK_WT
D1BC CD BE DF       	CALL	DISKC+AT_RS
D1BF 20 CE          	JR	NZ,DWT0
D1C1 B7             	OR	A
D1C2 C2 DB DF       	JP	NZ,ERRW+AT_RS
D1C5                
D1C5                DISKOK_WT:
D1C5 06 01          AT_WTB:	LD	B,1
D1C7 10 BD          	DJNZ	DWTBL
D1C9 C9             	RET
D1CA                
D1CA                AT_DRD:
D1CA 3E 80          	LD	A,080H
D1CC 32 64 EE       	LD	(FDCPAT+1),A
D1CF                DRDBL:
D1CF 78             	LD	A,B
D1D0 32 60 EF       	LD	(AT_RDB+1+AT_R),A
D1D3 3E 02          	LD	A,2		;Retry count
D1D5 32 D5 EE       	LD	(RETRY),A
D1D8                DRD0:
D1D8 D5             	PUSH	DE
D1D9 E5             	PUSH	HL
D1DA CD 05 EE       	CALL	SEEK		;Read disk
D1DD E1             	POP	HL
D1DE DA ED DF       	JP	C,ERRDR+AT_RS
D1E1 F3             	DI
D1E2 3A 64 EE       	LD	A,(FDCPAT+1)
D1E5 CD B7 EE       	CALL	SECSET
D1E8 0E FB          	LD	C,0FBH
D1EA                DRD1:
D1EA 78             	LD	A,B
D1EB DB F8          	IN	A,(0F8H)
D1ED 0F             	RRCA
D1EE 30 08          	JR	NC,DRD3
D1F0 0F             	RRCA
D1F1 30 F7          	JR	NC,DRD1
D1F3 ED A2          	INI
D1F5 04             	INC	B
D1F6 18 F2          	JR	DRD1
D1F8                
D1F8                DRD3:
D1F8 B7             	OR	A
D1F9 FB             	EI
D1FA D1             	POP	DE
D1FB 13             	INC	DE
D1FC CD AB EE       	CALL	FDMOFF
D1FF 28 09          	JR	Z,DISKOK_RD
D201 CD BE DF       	CALL	DISKC+AT_RS
D204 20 D2          	JR	NZ,DRD0
D206 B7             	OR	A
D207 C2 DB DF       	JP	NZ,ERRW+AT_RS
D20A                
D20A                DISKOK_RD:
D20A 06 01          AT_RDB:	LD	B,1
D20C 10 C1          	DJNZ	DRDBL
D20E C9             	RET
D20F                
D20F                AT_CPUE:
D20F                
D20F 00 00 2F 04    AT_RT	EQU	TRAP38-AT_TRAP38
D20F                
D20F                INITE:
D20F                	DS	BDOS-INITE
D306 C3 63 D8       	JP	BDOS0
D309                	INCLUDE	"X1CCP.ASM"
D309                
D309                ;	LSX-Dodgers CCP
D309                ;	X1/turbo/Z
D309                
D309                WBOOT1:
D309 F3             	DI
D30A ED 7B 06 00    	LD	SP,(SYSTEM+1)
D30E                
D30E 3E F0          	LD	A,INTVEC/256
D310 ED 47          	LD	I,A
D312                
D312 3E E4          	LD	A,0E4H
D314 CD F3 DE       	CALL	COMOUT
D317 3E C8          	LD	A,INTVEC-CPM_BOOT
D319 CD CD DE       	CALL	OT49SB
D31C                
D31C 21 B0 F0       	LD	HL,CRTCD
D31F AF             	XOR	A
D320                SETCRT2:
D320 01 00 18       	LD	BC,01800H
D323 ED 79          	OUT	(C),A
D325 0C             	INC	C
D326 56             	LD	D,(HL)
D327 FE 0D          	CP	13
D329 38 02          	JR	C,SETCRT3
D32B 16 00          	LD	D,0
D32D                SETCRT3:
D32D ED 51          	OUT	(C),D
D32F 23             	INC	HL
D330 3C             	INC	A
D331 FE 0E          	CP	14
D333 20 EB          	JR	NZ,SETCRT2
D335                
D335 01 03 1B       	LD	BC,01A03H+00100H
D338 ED A3          	OUTI
D33A 01 D0 20       	LD	BC,01FD0H+00100H
D33D ED A3          	OUTI
D33F 21 92 F0       	LD	HL,_KEYD
D342 7E             	LD	A,(HL)
D343 36 00          	LD	(HL),0
D345 CD 8F DB       	CALL	KEYBC_IFBREAK
D348 3E 04          	LD	A,4
D34A CD A2 DB       	CALL	MSG_A
D34D                	INCLUDE	"LDCCP.ASM"
D34D                
D34D                ;	LSX-Dodgers CCP
D34D                
D34D                COMMAND:
D34D 3A C6 EF       	LD	A,(FCB_BAT)
D350 B7             	OR	A
D351 C2 93 D4       	JP	NZ,C_BAT1
D354 CD 07 D4       	CALL	SETDTA1
D357 3A 87 F0       	LD	A,(_DVSW)
D35A C6 41          	ADD	A,'A'
D35C CD A2 DB       	CALL	MSG_A
D35F 3E 3E          	LD	A,'>'
D361 CD A2 DB       	CALL	MSG_A
D364 3E 50          	LD	A,80
D366 12             	LD	(DE),A
D367 CD 23 DC       	CALL	_SYS0A		;(BDOS)文字列入力
D36A CD 88 D5       	CALL	LTNL
D36D                COMMAND2:
D36D 11 82 00       	LD	DE,DTA1+2
D370 CD FD F0       	CALL	_COMANL
D373 30 D8          	JR	NC,COMMAND
D375 11 79 F0       	LD	DE,COMERM
D378 CD 95 D8       	CALL	_SYS09		;(BDOS)文字列出力
D37B C7             	RST	0
D37C                
D37C                COMANL:
D37C CD A1 E0       	CALL	FILE
D37F 3A 19 F0       	LD	A,(FNAME+4)
D382 FE 20          	CP	020H
D384 20 1C          	JR	NZ,COMB2
D386 D5             	PUSH	DE
D387 11 15 F0       	LD	DE,FNAME
D38A 1A             	LD	A,(DE)
D38B FE 20          	CP	020H
D38D 28 44          	JR	Z,SDVSW
D38F 1B             	DEC	DE
D390 1A             	LD	A,(DE)
D391 C6 FF          	ADD	A,0FFH
D393 38 09          	JR	C,COMB
D395 13             	INC	DE
D396                
D396 21 42 D7       	LD	HL,COMTB
D399 06 08          	LD	B,COMS
D39B CD 30 E3       	CALL	CPNAME
D39E                COMB:
D39E D1             	POP	DE
D39F D2 0F 00       	JP	NC,JP_HL
D3A2                COMB2:
D3A2 EB             	EX	DE,HL
D3A3 22 70 D4       	LD	(COMSWC),HL
D3A6 F5             	PUSH	AF
D3A7 CD 28 D4       	CALL	CEXE4
D3AA F1             	POP	AF
D3AB 21 15 F0       	LD	HL,FNAME
D3AE 11 6D 00       	LD	DE,FCB2+1	;COMMAND NAME
D3B1 01 0B 00       	LD	BC,11
D3B4 ED B0          	LDIR
D3B6 11 65 EF       	LD	DE,PATHD
D3B9                CEX1:
D3B9 1A             	LD	A,(DE)
D3BA FE 20          	CP	020H
D3BC D8             	RET	C
D3BD CD 96 E0       	CALL	FILEC
D3C0 D5             	PUSH	DE
D3C1 21 6D 00       	LD	HL,FCB2+1	;COMMAND NAME
D3C4 11 15 F0       	LD	DE,FNAME
D3C7 01 0B 00       	LD	BC,11
D3CA ED B0          	LDIR
D3CC CD 28 D4       	CALL	CEXE4
D3CF D1             	POP	DE
D3D0 13             	INC	DE
D3D1 18 E6          	JR	CEX1
D3D3                
D3D3                SDVSW:
D3D3 F1             	POP	AF
D3D4 3A 14 F0       	LD	A,(FDRV)
D3D7 3D             	DEC	A
D3D8 5F             	LD	E,A
D3D9 0E 0E          	LD	C,00EH		;(BDOS)カレントドライブの設定
D3DB 18 31          	JR	SYSTEM0
D3DD                
D3DD                OPEN1:
D3DD 21 14 F0       	LD	HL,FDRV
D3E0                OPEN:
D3E0 0E 11          	LD	C,011H		;(BDOS)ファイルの検索
D3E2                OPEN3:
D3E2 D5             	PUSH	DE
D3E3 11 A1 EF       	LD	DE,DTA_CCP
D3E6 CD 04 D4       	CALL	SETDTA
D3E9 EB             	EX	DE,HL
D3EA CD 0E D4       	CALL	SYSTEM0
D3ED D1             	POP	DE
D3EE C9             	RET
D3EF                
D3EF                OPEN2:
D3EF 0E 12          	LD	C,012H
D3F1 18 EF          	JR	OPEN3
D3F3                
D3F3                DEFCB:				;Z=Ok NZ=Error
D3F3 11 A1 EF       	LD	DE,DTA_CCP
D3F6 CD 0C D4       	CALL	SYSC0F
D3F9                
D3F9 11 C2 EF       	LD	DE,DTA_CCP+33	;(FCB)ランダムレコード
D3FC 06 04          	LD	B,4
D3FE CD 56 D6       	CALL	ZERO_MEMORY_DE
D401                SETDTA100:
D401 11 00 01       	LD	DE,00100H
D404                SETDTA:
D404 C3 68 DA       	JP	_SYS1A		;(BDOS)DTAの設定
D407                
D407                SETDTA1:
D407 11 80 00       	LD	DE,DTA1
D40A 18 F8          	JR	SETDTA
D40C                
D40C                SYSC0F:
D40C 0E 0F          	LD	C,00FH		;(BDOS)ファイルのオープン
D40E                SYSTEM0:
D40E CD 05 00       	CALL	SYSTEM
D411 B7             	OR	A
D412 C9             	RET
D413                
D413                C_CD:
D413 0E 5A          	LD	C,05AH
D415 18 F7          	JR	SYSTEM0
D417                
D417                S27BUF:
D417 21 00 FE       	LD	HL,-00200H	;スクラッチエリア(0100H)+スタック予備(0100H)
D41A 39             	ADD	HL,SP
D41B 2E 00          	LD	L,0
D41D 7C             	LD	A,H
D41E E6 F8          	AND	0F8H
D420 67             	LD	H,A
D421                S27DTA:
D421 11 A1 EF       	LD	DE,DTA_CCP
D424                S27:
D424 0E 27          	LD	C,027H		;(BDOS)ランダムブロック読み込み
D426 18 E6          	JR	SYSTEM0
D428                
D428                CEXE4:
D428 21 1D F0       	LD	HL,FNAME+8
D42B 7E             	LD	A,(HL)
D42C FE 20          	CP	020H
D42E 20 07          	JR	NZ,CEXE7
D430 3E 3F          	LD	A,'?'
D432 77             	LD	(HL),A
D433 23             	INC	HL
D434 77             	LD	(HL),A
D435 23             	INC	HL
D436 77             	LD	(HL),A
D437                CEXE7:
D437 CD DD D3       	CALL	OPEN1
D43A                CEXE5:
D43A C0             	RET	NZ
D43B 2A AB EF       	LD	HL,(DTA_CCP+1+9)
D43E 7C             	LD	A,H
D43F CD B8 E3       	CALL	CAP
D442 67             	LD	H,A
D443 7D             	LD	A,L
D444 CD B8 E3       	CALL	CAP
D447 6F             	LD	L,A
D448 3A AA EF       	LD	A,(DTA_CCP+1+8)
D44B CD B8 E3       	CALL	CAP
D44E D6 42          	SUB	'B'
D450 28 2C          	JR	Z,C_BAT
D452 3D             	DEC	A		;'C'
D453 28 05          	JR	Z,C_EXE
D455                CEXE6:
D455 CD EF D3       	CALL	OPEN2
D458 18 E0          	JR	CEXE5
D45A                
D45A                C_EXE:
D45A 7C             	LD	A,H
D45B FE 4D          	CP	'M'
D45D 20 F6          	JR	NZ,CEXE6
D45F                
D45F CD F3 D3       	CALL	DEFCB
D462 CD 17 D4       	CALL	S27BUF
D465 3D             	DEC	A
D466 37             	SCF
D467 C0             	RET	NZ
D468 7C             	LD	A,H
D469 B5             	OR	L
D46A 37             	SCF
D46B C8             	RET	Z
D46C CD 07 D4       	CALL	SETDTA1
D46F 11 00 00       	LD	DE,0				; self-modifying code
D472 00 00 D4 70    COMSWC	EQU	$-2
D472 ED 7B 06 00    	LD	SP,(SYSTEM+1)
D476 67             	LD	H,A				; A=0 in SETDTA1(_SYS1A)
D477 6F             	LD	L,A
D478 E5             	PUSH	HL				; push $0000 (reboot address)
D479 24             	INC	H
D47A E5             	PUSH	HL				; push $0100 (TPA address)
D47B C3 21 D6       	JP	SETFCB				; and JP $0100
D47E                
D47E                C_BAT:
D47E 11 41 54       	LD	DE,'A'+'T'*256
D481 ED 52          	SBC	HL,DE
D483 20 D0          	JR	NZ,CEXE6
D485                
D485 CD F3 D3       	CALL	DEFCB
D488                
D488 21 A1 EF       	LD	HL,DTA_CCP
D48B 11 C6 EF       	LD	DE,FCB_BAT
D48E 01 25 00       	LD	BC,37
D491 ED B0          	LDIR
D493                C_BAT1:
D493 CD 01 D4       	CALL	SETDTA100
D496 CD CA D4       	CALL	FGETC_BAT
D499 21 81 00       	LD	HL,DTA1+1
D49C 20 25          	JR	NZ,END_BATCH
D49E FE 21          	CP	021H		;スペースや改行など制御文字を飛ばす
D4A0 38 F1          	JR	C,C_BAT1
D4A2 36 20          	LD	(HL),' '
D4A4 23             	INC	HL
D4A5                C_BAT2:
D4A5 77             	LD	(HL),A
D4A6 23             	INC	HL
D4A7 7D             	LD	A,L
D4A8 3C             	INC	A		;L==0FFH
D4A9 28 09          	JR	Z,RUN_BATCH
D4AB CD CA D4       	CALL	FGETC_BAT
D4AE 20 04          	JR	NZ,RUN_BATCH
D4B0 FE 20          	CP	020H
D4B2 30 F1          	JR	NC,C_BAT2
D4B4                RUN_BATCH:
D4B4 7D             	LD	A,L
D4B5 D6 7F          	SUB	DTA1-1
D4B7 32 80 00       	LD	(DTA1),A
D4BA FE 04          	CP	4
D4BC 38 05          	JR	C,END_BATCH
D4BE 36 00          	LD	(HL),0
D4C0 C3 6D D3       	JP	COMMAND2
D4C3                END_BATCH:
D4C3 AF             	XOR	A		;バッチファイルを閉じる
D4C4 32 C6 EF       	LD	(FCB_BAT),A
D4C7 C3 00 F0       	JP	CPM_BOOT
D4CA                
D4CA                FGETC_BAT:
D4CA 11 C6 EF       	LD	DE,FCB_BAT
D4CD                FGETC:				;1文字ずつ読み込む
D4CD E5             	PUSH	HL		;Z:成功
D4CE 21 01 00       	LD	HL,1
D4D1 CD 24 D4       	CALL	S27
D4D4 E1             	POP	HL
D4D5 3A 00 01       	LD	A,(00100H)
D4D8 C9             	RET
D4D9                
D4D9                C_DEL:
D4D9 CD 21 D6       	CALL	SETFCB
D4DC CD B8 DB       	CALL	_SYS08		;(BDOS)エコーなしコンソール入力
D4DF                
D4DF 0E 13          	LD	C,013H
D4E1 18 0A          	JR	CDEL1		;(BDOS)ファイルの削除
D4E3                
D4E3                C_REN:
D4E3 CD 21 D6       	CALL	SETFCB
D4E6 3E 10          	LD	A,010H		;ディレクトリも対象にする
D4E8 32 69 00       	LD	(FCB1+13),A	;属性
D4EB 0E 17          	LD	C,017H		;(BDOS)ファイル名の変更
D4ED                CDEL1:
D4ED 11 5C 00       	LD	DE,FCB1
D4F0 CD 05 00       	CALL	SYSTEM
D4F3 C6 FF          	ADD	A,0FFH
D4F5 C9             	RET
D4F6                
D4F6                C_DIR:
D4F6 CD 96 E0       	CALL	FILEC
D4F9 21 15 F0       	LD	HL,FDRV+1
D4FC CD 37 D7       	CALL	CWILD1
D4FF 3E F1          	LD	A,0F1H
D501 32 21 F0       	LD	(FDRV+13),A
D504 CD DD D3       	CALL	OPEN1
D507                CDIR1:
D507 B7             	OR	A
D508 20 08          	JR	NZ,PDSKF
D50A CD 55 D5       	CALL	P_NAME
D50D CD EF D3       	CALL	OPEN2
D510 18 F5          	JR	CDIR1
D512                PDSKF:
D512 3A 14 F0       	LD	A,(FDRV)
D515 5F             	LD	E,A
D516 0E 1B          	LD	C,01BH		;(BDOS)ディスク情報の獲得
D518 CD 05 00       	CALL	SYSTEM
D51B 4F             	LD	C,A		;C←1クラスタ辺りの論理セクタ数
D51C C6 01          	ADD	A,001H
D51E D8             	RET	C		;Aが0FFHだった場合
D51F 3E 06          	LD	A,8-2
D521                PDS1:				;HL=未使用クラスタの総数
D521 3C             	INC	A
D522 CB 19          	RR	C
D524 30 FB          	JR	NC,PDS1
D526                PDS2:				;B←論理セクタのサイズの上位8ビット
D526 3C             	INC	A
D527 CB 18          	RR	B
D529 30 FB          	JR	NC,PDS2
D52B 47             	LD	B,A
D52C                
D52C 11 00 00       	LD	DE,0
D52F                PDS3:
D52F 29             	ADD	HL,HL
D530 EB             	EX	DE,HL
D531 ED 6A          	ADC	HL,HL
D533 EB             	EX	DE,HL
D534 10 F9          	DJNZ	PDS3
D536                PDSKF1:
D536 CD BF D5       	CALL	PRDEC_DEHL
D539 11 F6 EF       	LD	DE,FREE
D53C CD 95 D8       	CALL	_SYS09		;(BDOS)文字列出力
D53F CD AF D5       	CALL	PUTDRV
D542 3E 5C          	LD	A,05CH		;\
D544 CD A2 DB       	CALL	MSG_A
D547 2A 22 F0       	LD	HL,(FDRV+14)	;ディレクトリのクラスタ番号
D54A AF             	XOR	A
D54B 11 FE FF       	LD	DE,0-2
D54E 19             	ADD	HL,DE
D54F 23             	INC	HL
D550 DC BC D5       	CALL	C,PRDEC_HL
D553 18 33          	JR	LTNL
D555                
D555                P_NAME:
D555 3A A2 EF       	LD	A,(DTA_CCP+1)
D558 FE 2E          	CP	'.'
D55A C8             	RET	Z
D55B                
D55B 3A AD EF       	LD	A,(DTA_CCP+1+00BH)
D55E F5             	PUSH	AF
D55F CB 67          	BIT	4,A
D561 28 08          	JR	Z,DIR3
D563 11 EB EF       	LD	DE,DIRMES
D566 CD 95 D8       	CALL	_SYS09		;(BDOS)文字列出力
D569 18 0A          	JR	DIR6
D56B                DIR3:
D56B ED 5B C0 EF    	LD	DE,(DTA_CCP+1+01EH)
D56F 2A BE EF       	LD	HL,(DTA_CCP+1+01CH)
D572 CD BF D5       	CALL	PRDEC_DEHL
D575                DIR6:
D575 F1             	POP	AF
D576 0F             	RRCA
D577 9F             	SBC	A,A
D578 E6 0A          	AND	'*'-020H
D57A C6 20          	ADD	A,020H
D57C CD A2 DB       	CALL	MSG_A
D57F CD AF D5       	CALL	PUTDRV
D582 21 A2 EF       	LD	HL,DTA_CCP+1
D585 CD FF D5       	CALL	FPRNT
D588                
D588                LTNL:
D588 1E 03          	LD	E,3
D58A C3 CD F0       	JP	_PRINT
D58D                
D58D                C_PATH:
D58D CD 78 E1       	CALL	SPCUT
D590 21 65 EF       	LD	HL,PATHD
D593 FE 21          	CP	021H
D595 30 0C          	JR	NC,CPATH0
D597                CPATHP:
D597 7E             	LD	A,(HL)
D598 23             	INC	HL
D599 FE 20          	CP	020H
D59B 3F             	CCF
D59C 30 EA          	JR	NC,LTNL
D59E CD A2 DB       	CALL	MSG_A
D5A1 18 F4          	JR	CPATHP
D5A3                CPATH0:
D5A3 FE 3B          	CP	';'
D5A5 20 01          	JR	NZ,CPATH1
D5A7 13             	INC	DE
D5A8                CPATH1:
D5A8 EB             	EX	DE,HL
D5A9 01 3B 00       	LD	BC,PATHX
D5AC ED B0          	LDIR
D5AE C9             	RET
D5AF                
D5AF                PUTDRV:
D5AF 3A 89 F0       	LD	A,(_DSK)
D5B2 C6 41          	ADD	A,'A'
D5B4 CD A2 DB       	CALL	MSG_A
D5B7 3E 3A          	LD	A,':'
D5B9                MSG_AR:
D5B9 C3 A2 DB       	JP	MSG_A
D5BC                
D5BC                PRDEC_HL:
D5BC AF             	XOR	A
D5BD 5F             	LD	E,A
D5BE 57             	LD	D,A
D5BF                PRDEC_DEHL:
D5BF D5             	PUSH	DE
D5C0 11 0F F0       	LD	DE,DECBF
D5C3 06 05          	LD	B,5
D5C5 CD 56 D6       	CALL	ZERO_MEMORY_DE	;A=0
D5C8 D1             	POP	DE
D5C9                
D5C9 0E 20          	LD	C,32
D5CB                DEC1:
D5CB 29             	ADD	HL,HL
D5CC EB             	EX	DE,HL
D5CD ED 6A          	ADC	HL,HL
D5CF EB             	EX	DE,HL
D5D0 E5             	PUSH	HL
D5D1 21 13 F0       	LD	HL,DECBF+4
D5D4 06 05          	LD	B,5
D5D6                DEC2:
D5D6 7E             	LD	A,(HL)
D5D7 8F             	ADC	A,A
D5D8 27             	DAA
D5D9 77             	LD	(HL),A
D5DA 2B             	DEC	HL
D5DB 10 F9          	DJNZ	DEC2
D5DD E1             	POP	HL
D5DE 0D             	DEC	C
D5DF 20 EA          	JR	NZ,DEC1
D5E1                
D5E1 21 0F F0       	LD	HL,DECBF
D5E4 3E 20          	LD	A,020H
D5E6 06 04          	LD	B,4
D5E8                DEC3:
D5E8 CD F5 D5       	CALL	DEC4
D5EB CD F5 D5       	CALL	DEC4
D5EE 23             	INC	HL
D5EF 10 F7          	DJNZ	DEC3
D5F1                DECX:
D5F1 CD F5 D5       	CALL	DEC4
D5F4 AF             	XOR	A
D5F5                DEC4:
D5F5 ED 6F          	RLD
D5F7 FE 20          	CP	020H
D5F9 28 02          	JR	Z,DEC5
D5FB F6 30          	OR	030H
D5FD                DEC5:
D5FD 18 BA          	JR	MSG_AR
D5FF                
D5FF                FPRNT:
D5FF 06 08          	LD	B,8	;ファイル名を表示
D601 CD 10 D6       	CALL	P_N1
D604 7E             	LD	A,(HL)
D605 CD C4 E3       	CALL	CAP3
D608 D8             	RET	C	;拡張子が無い
D609                
D609 3E 2E          	LD	A,'.'
D60B CD A2 DB       	CALL	MSG_A
D60E 06 03          	LD	B,3	;拡張子を表示
D610                P_N1:
D610 7E             	LD	A,(HL)
D611 CD C4 E3       	CALL	CAP3
D614 38 07          	JR	C,P_N2
D616 CD A2 DB       	CALL	MSG_A
D619 23             	INC	HL
D61A 10 F4          	DJNZ	P_N1
D61C C9             	RET
D61D                P_N2:
D61D 23             	INC	HL
D61E 10 FD          	DJNZ	P_N2
D620 C9             	RET
D621                
D621                SETFCB:
D621 CD 78 E1       	CALL	SPCUT
D624 1A             	LD	A,(DE)
D625 FE 20          	CP	020H
D627 38 01          	JR	C,SETFCBA
D629 1B             	DEC	DE
D62A                SETFCBA:
D62A 06 24          	LD	B,36
D62C 21 5C 00       	LD	HL,FCB1
D62F E5             	PUSH	HL
D630 AF             	XOR	A
D631 CD 4D E1       	CALL	FILL_MEMORY
D634 E1             	POP	HL
D635 D5             	PUSH	DE
D636 CD CE DA       	CALL	_SYS29		;(BDOS)ファイル名の解析
D639 21 6C 00       	LD	HL,FCB2
D63C CD CE DA       	CALL	_SYS29		;(BDOS)ファイル名の解析
D63F E1             	POP	HL
D640 01 00 50       	LD	BC,05000H
D643 11 81 00       	LD	DE,00081H
D646                SETFCB1:
D646 7E             	LD	A,(HL)
D647 23             	INC	HL
D648 FE 20          	CP	020H
D64A 38 05          	JR	C,SETFCB2
D64C 12             	LD	(DE),A
D64D 13             	INC	DE
D64E 0C             	INC	C
D64F 10 F5          	DJNZ	SETFCB1
D651                SETFCB2:
D651 79             	LD	A,C
D652 32 80 00       	LD	(DTA1),A
D655 04             	INC	B
D656                ZERO_MEMORY_DE:
D656 AF             	XOR	A
D657                FILL_MEMORY_DE:
D657 12             	LD	(DE),A
D658 13             	INC	DE
D659 10 FC          	DJNZ	FILL_MEMORY_DE
D65B C9             	RET
D65C                
D65C                C_COPY:
D65C CD 21 D6       	CALL	SETFCB
D65F                
D65F 11 61 F0       	LD	DE,ZERO
D662 CD 99 E0       	CALL	FILEC2
D665 21 6C 00       	LD	HL,FCB2
D668 CD D5 DA       	CALL	S29X1
D66B                
D66B 3E 10          	LD	A,010H
D66D 32 69 00       	LD	(FCB1+13),A
D670 21 6D 00       	LD	HL,FCB2+1
D673 CD 37 D7       	CALL	CWILD1
D676                COPY0:
D676 CD 34 D7       	CALL	CWILD
D679 21 5C 00       	LD	HL,FCB1
D67C CD E0 D3       	CALL	OPEN
D67F 37             	SCF
D680                COPY1:
D680 C0             	RET	NZ
D681 CD F3 D3       	CALL	DEFCB
D684                
D684 3A AE EF       	LD	A,(DTA_CCP+13)
D687 CB 67          	BIT	4,A
D689 28 21          	JR	Z,COPY1A
D68B                
D68B 21 5D 00       	LD	HL,FCB1+1
D68E CD DC E4       	CALL	CHKWILD
D691 38 14          	JR	C,COPY9
D693                
D693 3E 20          	LD	A,020H
D695 32 5D 00       	LD	(FCB1+1),A
D698 2A BB EF       	LD	HL,(DTA_CCP+26)
D69B 23             	INC	HL
D69C 22 6A 00       	LD	(FCB1+14),HL
D69F 18 D5          	JR	COPY0
D6A1                
D6A1                COPY8:
D6A1 CD 95 D8       	CALL	_SYS09		;(BDOS)文字列出力
D6A4 CD 88 D5       	CALL	LTNL
D6A7                COPY9:
D6A7 CD EF D3       	CALL	OPEN2
D6AA 18 D4          	JR	COPY1
D6AC                
D6AC                COPY1A:
D6AC 21 6C 00       	LD	HL,FCB2
D6AF 11 14 F0       	LD	DE,FDRV
D6B2 01 A3 EF       	LD	BC,DTA_CCP+2
D6B5 ED A0          	LDI
D6B7 3E 0B          	LD	A,11
D6B9                COPY2:
D6B9 F5             	PUSH	AF
D6BA 7E             	LD	A,(HL)
D6BB FE 3F          	CP	'?'
D6BD 20 01          	JR	NZ,COPY3
D6BF 0A             	LD	A,(BC)
D6C0                COPY3:
D6C0 12             	LD	(DE),A
D6C1 03             	INC	BC
D6C2 13             	INC	DE
D6C3 23             	INC	HL
D6C4 F1             	POP	AF
D6C5 3D             	DEC	A
D6C6 20 F1          	JR	NZ,COPY2
D6C8 01 05 00       	LD	BC,16-11
D6CB ED B0          	LDIR
D6CD                PUTNAME:
D6CD 21 5D 00       	LD	HL,FCB1+1
D6D0 CD DC E4       	CALL	CHKWILD
D6D3 30 0B          	JR	NC,PUTN1
D6D5 21 15 F0       	LD	HL,FDRV+1
D6D8 CD FF D5       	CALL	FPRNT
D6DB 3E 20          	LD	A,020H
D6DD CD A2 DB       	CALL	MSG_A
D6E0                PUTN1:
D6E0 11 14 F0       	LD	DE,FDRV
D6E3 0E 16          	LD	C,016H		;(BDOS)ファイルの作成
D6E5 CD 0E D4       	CALL	SYSTEM0
D6E8 20 48          	JR	NZ,COPYE2
D6EA 67             	LD	H,A		;A=0
D6EB 6F             	LD	L,A
D6EC 22 35 F0       	LD	(FDRV+33),HL	;(FCB)ランダムレコード
D6EF 22 37 F0       	LD	(FDRV+35),HL
D6F2                COPY6:
D6F2 CD 17 D4       	CALL	S27BUF
D6F5 47             	LD	B,A
D6F6 3C             	INC	A
D6F7 28 31          	JR	Z,COPYE
D6F9 7C             	LD	A,H
D6FA B5             	OR	L
D6FB 28 0C          	JR	Z,COPY7
D6FD 11 14 F0       	LD	DE,FDRV
D700 0E 26          	LD	C,026H		;(BDOS)ランダムブロック書き込み
D702 CD 0E D4       	CALL	SYSTEM0
D705 20 23          	JR	NZ,COPYE
D707 10 E9          	DJNZ	COPY6
D709                COPY7:
D709 3A AE EF       	LD	A,(DTA_CCP+13)	;(FCB)属性
D70C 32 21 F0       	LD	(FDRV+13),A
D70F 21 B5 EF       	LD	HL,DTA_CCP+20	;(FCB)タイムスタンプ
D712 11 28 F0       	LD	DE,FDRV+20
D715 01 04 00       	LD	BC,4
D718 ED B0          	LDIR
D71A                
D71A 11 14 F0       	LD	DE,FDRV
D71D 0E 10          	LD	C,010H		;(BDOS)ファイルのクローズ
D71F CD 0E D4       	CALL	SYSTEM0
D722 20 06          	JR	NZ,COPYE
D724                
D724 11 71 F0       	LD	DE,OK
D727 C3 A1 D6       	JP	COPY8
D72A                
D72A                COPYE:
D72A 11 14 F0       	LD	DE,FDRV
D72D 0E 13          	LD	C,013H		;(BDOS)ファイルの削除
D72F CD 05 00       	CALL	SYSTEM
D732                COPYE2:
D732 37             	SCF
D733 C9             	RET
D734                
D734                CWILD:
D734 21 5D 00       	LD	HL,FCB1+1
D737                CWILD1:
D737 7E             	LD	A,(HL)
D738 FE 20          	CP	020H
D73A C0             	RET	NZ
D73B                CWILD2:
D73B 3E 3F          	LD	A,'?'
D73D 06 0B          	LD	B,11
D73F C3 4D E1       	JP	FILL_MEMORY
D742                
D742                COMTB:
D742 44 20 20 20    	DB	"D   "	;1
D746 F6 D4          	DW	C_DIR
D748 44 49 52 20    	DB	"DIR "	;2
D74C F6 D4          	DW	C_DIR
D74E 43 4F 50 59    	DB	"COPY"	;3
D752 5C D6          	DW	C_COPY
D754 43 44 20 20    	DB	"CD  "	;4
D758 13 D4          	DW	C_CD
D75A 44 45 4C 20    	DB	"DEL "	;5
D75E D9 D4          	DW	C_DEL
D760 50 41 54 48    	DB	"PATH"	;6
D764 8D D5          	DW	C_PATH
D766 52 45 4E 20    	DB	"REN "	;7
D76A E3 D4          	DW	C_REN
D76C 52 45 4D 20    	DB	"REM "	;8
D770 92 D8          	DW	C_REM
D772                	INCLUDE	"X1DISK2.ASM"
D772                
D772                ;	LSX-Dodgers DISK2
D772                ;	X1/turbo/Z
D772                
D772                ;	GRAPHIC RAM DISK DRIVER
D772                
D772                
D772                GDRD:
D772 C5             	PUSH	BC
D773 CD 9B D7       	CALL	GADR
D776 F1             	POP	AF
D777                GDRD1:
D777 ED A2          	INI
D779 04             	INC	B
D77A 0C             	INC	C
D77B 20 FA          	JR	NZ,GDRD1
D77D 04             	INC	B
D77E 13             	INC	DE
D77F 3D             	DEC	A
D780 20 F5          	JR	NZ,GDRD1
D782                GBANK0:
D782 3A BF F0       	LD	A,(WK1FD0)
D785 E6 EF          	AND	0EFH		;BANK0
D787 18 1D          	JR	S1FD0
D789                
D789                GDWT:
D789 C5             	PUSH	BC
D78A CD 9B D7       	CALL	GADR
D78D F1             	POP	AF
D78E                GDWT1:
D78E 04             	INC	B
D78F ED A3          	OUTI
D791 0C             	INC	C
D792 20 FA          	JR	NZ,GDWT1
D794 04             	INC	B
D795 13             	INC	DE
D796 3D             	DEC	A
D797 20 F5          	JR	NZ,GDWT1
D799 18 E7          	JR	GBANK0
D79B                
D79B                GADR:
D79B 0E 00          	LD	C,0
D79D 7B             	LD	A,E
D79E C6 40          	ADD	A,040H
D7A0 47             	LD	B,A
D7A1 3A BF F0       	LD	A,(WK1FD0)
D7A4 F6 10          	OR	010H		;BANK1
D7A6                S1FD0:
D7A6 C5             	PUSH	BC
D7A7 32 BF F0       	LD	(WK1FD0),A
D7AA 01 D0 1F       	LD	BC,01FD0H
D7AD ED 79          	OUT	(C),A
D7AF C1             	POP	BC
D7B0 C9             	RET
D7B1                
D7B1                
D7B1                ;	BANK RAM DISK DRIVER
D7B1                
D7B1                BDWT:
D7B1 3E             	DB	03EH	;LD A,??
D7B2 37             	SCF
D7B3 18 02          	JR	BRW
D7B5                
D7B5                BDRD:
D7B5 3E             	DB	03EH	;LD A,??
D7B6 A7             	AND	A
D7B7                BRW:
D7B7 F3             	DI
D7B8 32 E3 D7       	LD	(BRWPAT),A
D7BB ED 73 03 D8    	LD	(BANKSP),SP
D7BF 3A 04 D8       	LD	A,(BANKSP_H)
D7C2 87             	ADD	A,A
D7C3 38 03          	JR	C,BRW0
D7C5 31 CA FF       	LD	SP,EXTSP
D7C8                BRW0:
D7C8 D9             	EXX		;裏レジスタ
D7C9 C5             	 PUSH	 BC
D7CA D5             	 PUSH	 DE
D7CB 01 00 0B       	 LD	 BC,00B00H	 ;バンクメモリ
D7CE 11 10 10       	 LD	 DE,01010H
D7D1 D9             	 EXX		;表レジスタ
D7D2                BRW1:
D7D2 C5             	PUSH	BC
D7D3 D5             	PUSH	DE
D7D4 EB             	EX	DE,HL
D7D5 29             	ADD	HL,HL
D7D6 29             	ADD	HL,HL
D7D7 7C             	LD	A,H
D7D8 DD 86 0C       	ADD	A,(IX+DPB_MAXCYL)
D7DB E6 0F          	AND	00FH	;バンク
D7DD 65             	LD	H,L
D7DE CB 3C          	SRL	H	;/2
D7E0 2E 00          	LD	L,0
D7E2 D9             	EXX		;裏レジスタ
D7E3 A7             BRWPAT:	 AND	 A	;自己書き換え(AND A:読み出し/SCF:書き込み)
D7E4 38 08          	 JR	 C,BRWT
D7E6 57             	 LD	 D,A	 ;D=バンク
D7E7 D9             	 EXX		;表レジスタ
D7E8 EB             	EX	DE,HL
D7E9 CD 07 D8       	CALL	BTFR
D7EC 18 06          	JR	BRW2
D7EE                BRWT:
D7EE 5F             	 LD	E,A	 ;E=バンク
D7EF D9             	 EXX		;表レジスタ
D7F0 CD 07 D8       	CALL	BTFR
D7F3 EB             	EX	DE,HL
D7F4                BRW2:
D7F4 D1             	POP	DE
D7F5 C1             	POP	BC
D7F6 13             	INC	DE
D7F7 10 D9          	DJNZ	BRW1
D7F9                
D7F9 D9             	EXX		;裏レジスタ
D7FA 3E 10          	 LD	 A,10H
D7FC ED 79          	 OUT	 (C),A		;メインメモリに切り替える
D7FE D1             	 POP	 DE
D7FF C1             	 POP	 BC
D800 D9             	 EXX		;表レジスタ
D801 AF             	XOR	A
D802 31 00 00       	LD	SP,0
D805 00 00 D8 04    BANKSP_H	EQU	$-1
D805 00 00 D8 03    BANKSP		EQU	$-2
D805 FB             	EI
D806 C9             	RET
D807                
D807                ;メインメモリ←→バンクメモリ 512バイトの転送を行う
D807                ; DE:転送元アドレス
D807                ; HL:転送先アドレス
D807                ; 裏BC:バンク切り替えポート(0B00H)
D807                ; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
D807                ; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
D807                
D807                BTFR:
D807 06 00          	LD	B,0	;256回ループ(256*2)
D809                BTFR1:
D809 D9             	EXX		;裏レジスタ
D80A ED 51          	 OUT	 (C),D	 ;BANK(MAIN)
D80C D9             	 EXX		;表レジスタ
D80D 1A             	LD	A,(DE)
D80E 4F             	LD	C,A
D80F 13             	INC	DE
D810 1A             	LD	A,(DE)
D811 13             	INC	DE
D812 D9             	EXX		;裏レジスタ
D813 ED 59          	 OUT	 (C),E	 ;MAIN(BANK)
D815 D9             	 EXX		;表レジスタ
D816 71             	LD	(HL),C
D817 23             	INC	HL
D818 77             	LD	(HL),A
D819 23             	INC	HL
D81A 10 ED          	DJNZ	BTFR1
D81C C9             	RET
D81D                
D81D                ;	EMM DRIVER(CPU)
D81D                
D81D                EDWT:
D81D CD 45 D8       	CALL	EADR
D820                EDWT0:
D820 F5             	PUSH	AF
D821 AF             	XOR	A
D822                EDWT1:
D822 04             	INC	B
D823 ED A3          	OUTI
D825 04             	INC	B
D826 ED A3          	OUTI
D828 3D             	DEC	A
D829 20 F7          	JR	NZ,EDWT1
D82B 13             	INC	DE
D82C F1             	POP	AF
D82D 3D             	DEC	A
D82E 20 F0          	JR	NZ,EDWT0
D830 C9             	RET
D831                
D831                EDRD:
D831 CD 45 D8       	CALL	EADR
D834                EDRD0:
D834 F5             	PUSH	AF
D835 AF             	XOR	A
D836                EDRD1:
D836 ED A2          	INI
D838 04             	INC	B
D839 ED A2          	INI
D83B 04             	INC	B
D83C 3D             	DEC	A
D83D 20 F7          	JR	NZ,EDRD1
D83F 13             	INC	DE
D840 F1             	POP	AF
D841 3D             	DEC	A
D842 20 F0          	JR	NZ,EDRD0
D844 C9             	RET
D845                
D845                EADR:
D845 C5             	PUSH	BC
D846 D5             	PUSH	DE
D847 EB             	EX	DE,HL
D848 29             	ADD	HL,HL
D849 DD 4E 0D       	LD	C,(IX+DPB_MAXSEC)
D84C DD 46 0C       	LD	B,(IX+DPB_MAXCYL)
D84F 09             	ADD	HL,BC
D850 DD 4E 13       	LD	C,(IX+DPB_UNITNO)
D853 06 0D          	LD	B,00DH
D855 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
D857 0C             	INC	C
D858 ED 69          	OUT	(C),L
D85A 0C             	INC	C
D85B ED 61          	OUT	(C),H
D85D 0C             	INC	C
D85E EB             	EX	DE,HL
D85F D1             	POP	DE
D860 F1             	POP	AF
D861 A7             	AND	A	;CF=0
D862 C9             	RET
D863                
D863                
D863                	INCLUDE	"LDOS.ASM"
D863                
D863                ;	LSX-Dodgers OS
D863                
D863                BDOS0:
D863 E5             	PUSH	HL
D864 79             	LD	A,C
D865 FE 3C          	CP	03CH
D867 38 02          	JR	C,DOS1
D869 3E 3C          	LD	A,03CH
D86B                DOS1:
D86B 87             	ADD	A,A
D86C 6F             	LD	L,A
D86D 26 F1          	LD	H,STABLE/256
D86F 7E             	LD	A,(HL)
D870 2C             	INC	L
D871 66             	LD	H,(HL)
D872 6F             	LD	L,A
D873 E3             	EX	(SP),HL
D874 79             	LD	A,C
D875                ;確認用
D875                ;	LD	(0050H),A
D875 C9             	RET
D876                _DOS2:
D876 FE 5A          	CP	05AH		;(BDOS)カレントディレクトリの変更(_CHDIR)
D878 CA 10 DB       	JP	Z,_SYS5A
D87B FE 5C          	CP	05CH		;(BDOS)ファイル名の解析(_PFILE)
D87D CA CE DA       	JP	Z,_SYS29
D880 FE 5F          	CP	05FH		;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
D882 CA E9 ED       	JP	Z,_SYS5F
D885 FE 6F          	CP	06FH		;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
D887 20 0A          	JR	NZ,_ERROR
D889 01 1D 01       	LD	BC,VER_6F
D88C 11 59 01       	LD	DE,VER
D88F 21 00 00       	LD	HL,MACD
D892                C_REM:
D892 AF             	XOR	A
D893                _ERROR:
D893 A7             	AND	A
D894 C9             	RET
D895                
D895                _SYS09:		;文字列出力
D895 D5             	PUSH	DE
D896                _SX09:
D896 1A             	LD	A,(DE)
D897 13             	INC	DE
D898 FE 24          	CP	'$'
D89A 28 31          	JR	Z,SX0E2
D89C CD A2 DB       	CALL	MSG_A
D89F 18 F5          	JR	_SX09
D8A1                
D8A1                MSX1:
D8A1 CD A2 DB       	CALL	MSG_A
D8A4                MSX:
D8A4 7E             	LD	A,(HL)
D8A5 23             	INC	HL
D8A6 B7             	OR	A
D8A7 20 F8          	JR	NZ,MSX1
D8A9 C9             	RET
D8AA                
D8AA                _SYS0C:		;(BDOS)バージョン番号の獲得
D8AA 21 22 00       	LD	HL,00022H
D8AD 7D             	LD	A,L
D8AE C9             	RET
D8AF                
D8AF                _SYS0D:		;(BDOS)ディスクリセット
D8AF CD DF F0       	CALL	_FFLUSH
D8B2 E5             	PUSH	HL
D8B3 21 80 00       	LD	HL,00080H
D8B6 22 8A F0       	LD	(_DTA),HL
D8B9 E1             	POP	HL
D8BA D5             	PUSH	DE
D8BB 1E 00          	LD	E,0
D8BD 3E             	DB	03EH	;次の PUSH DE をスキップ
D8BE                
D8BE                _SYS0E:		;(BDOS)カレントドライブの設定
D8BE D5             	PUSH	DE
D8BF 7B             	LD	A,E
D8C0 DD E5          	PUSH	IX
D8C2 CD DC F0       	CALL	_GETDPB
D8C5 DD E1          	POP	IX
D8C7 38 04          	JR	C,SX0E2
D8C9 7B             	LD	A,E
D8CA 32 87 F0       	LD	(_DVSW),A
D8CD                SX0E2:
D8CD D1             	POP	DE
D8CE C9             	RET
D8CF                
D8CF                _SYS0F:		;(BDOS)ファイルのオープン
D8CF CD 8A E1       	CALL	SETDRV
D8D2 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D8D5 C6 02          	ADD	A,002H		;Write
D8D7 28 48          	JR	Z,FEND0F
D8D9 CD D8 E4       	CALL	CHKWILDX
D8DC                
D8DC D4 B4 E1       	CALL	NC,SOPENX
D8DF                _S16XX:
D8DF 38 40          	JR	C,FEND0F
D8E1                				;Directory location
D8E1 3A 9F F0       	LD	A,(_FILEN)
D8E4 FD 77 19       	LD	(IY+25),A	;(FCB)ディレクトリロケーション
D8E7                ;				_DIRF
D8E7 3A A0 F0       	LD	A,(_DIRF)
D8EA FD 77 1D       	LD	(IY+29),A	;(FCB)ディレクトリモード
D8ED                ;				_FBPS
D8ED FD 73 1E       	LD	(IY+30),E	;(FCB)ディレクトリポジション
D8F0 FD 72 1F       	LD	(IY+31),D
D8F3                ;				Open(Read)
D8F3 FD 36 1C FF    	LD	(IY+28),0FFH	;(FCB)オープンモード
D8F7                ;				FILENAME
D8F7 FD E5          	PUSH	IY
D8F9 D1             	POP	DE
D8FA 13             	INC	DE
D8FB 01 0B 00       	LD	BC,11
D8FE ED B0          	LDIR
D900                ;				Attribute
D900 7E             	LD	A,(HL)
D901 FD 77 0D       	LD	(IY+13),A	;(FCB)属性(アトリビュート)
D904 11 0B 00       	LD	DE,11		;Reserved
D907 19             	ADD	HL,DE
D908                					;(FCB)ファイルを最後に変更した時刻
D908 11 E4 F1       	LD	DE,SDDATA		;(FCB)ファイルを最後に変更した日付
D90B 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
D90D                S16LOOP:				;(FCB)ファイルのサイズ(バイト単位)
D90D 1A             	LD	A,(DE)
D90E 13             	INC	DE
D90F 32 16 D9       	LD	(S16PAT),A
D912 7E             	LD	A,(HL)
D913 23             	INC	HL
D914 FD 77 00       	LD	(IY+0),A
D917 00 00 D9 16    S16PAT	EQU	$-1
D917 10 F4          	DJNZ	S16LOOP
D919                
D919 AF             	XOR	A
D91A FD 77 0C       	LD	(IY+12),A	;(FCB)カレントブロック
D91D FD 22 BE D9    	LD	(OFCB_SWC),IY
D921                FEND0F:
D921 18 45          	JR	FEND10
D923                
D923                _SYS10:		;(BDOS)ファイルのクローズ
D923 CD 8A E1       	CALL	SETDRV
D926 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D929 D6 FE          	SUB	0FEH
D92B 37             	SCF
D92C 3F             	CCF
D92D 20 39          	JR	NZ,FEND10
D92F                _S10A:				;Write
D92F FD 77 0E       	LD	(IY+14),A	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D932 FD 77 0F       	LD	(IY+15),A
D935                
D935 FD 34 1C       	INC	(IY+28)		;(FCB)オープンモード 0FEH->0FFH
D938 CD D4 E5       	CALL	SETTMS
D93B                
D93B FD 7E 1D       	LD	A,(IY+29)	;(FCB)ディレクトリモード
D93E 32 A0 F0       	LD	(_DIRF),A
D941 E6 7F          	AND	07FH
D943 32 FF EA       	LD	(_SECPS),A
D946 FD 5E 1E       	LD	E,(IY+30)	;(FCB)ディレクトリポジション
D949 FD 56 1F       	LD	D,(IY+31)
D94C CD E9 E2       	CALL	READ_DIR
D94F 38 17          	JR	C,FEND10
D951                
D951 3A 14 E2       SDECM1:	LD	A,(SDECPAT)	;1セクタ辺りのディレクトリエントリ数
D954 3D              	DEC	A		;1024=01FH / 512=00FH / 256=7
D955 FD A6 19       	AND	(IY+25)		;(FCB)ディレクトリロケーション
D958 6F             	LD	L,A
D959 26 00          	LD	H,0
D95B 29             	ADD	HL,HL		;*2
D95C 29             	ADD	HL,HL		;*4
D95D 29             	ADD	HL,HL		;*8
D95E 29             	ADD	HL,HL		;*16
D95F 29             	ADD	HL,HL		;*32
D960 ED 4B 7E F1    	LD	BC,(_DTBUF)
D964 09             	ADD	HL,BC
D965                
D965 CD E8 E4       	CALL	SDIRENT
D968                FEND10:
D968 18 42          	JR	FEND
D96A                
D96A                _SYS11:		;(BDOS)最初のファイルの検索
D96A CD 8A E1       	CALL	SETDRV
D96D CD E3 E1       	CALL	SOPEN
D970                _S12X1:
D970 38 3A          	JR	C,FEND
D972 CD 82 E2       	CALL	SOPENE2
D975 ED 5B 8A F0    	LD	DE,(_DTA)
D979 3A 88 F0       	LD	A,(_DRV)
D97C 3C             	INC	A
D97D 12             	LD	(DE),A
D97E D5             	PUSH	DE
D97F 13             	INC	DE
D980 01 20 00       	LD	BC,32
D983 ED B0          	LDIR
D985 FD 6E 0E       	LD	L,(IY+14)	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D988 FD 66 0F       	LD	H,(IY+15)
D98B 22 F4 F1       	LD	(SCDIR),HL
D98E 2A 9A F0       	LD	HL,(_FBPS)
D991 22 F6 F1       	LD	(SFBPS),HL
D994 2A 9F F0       	LD	HL,(_FILEN)
D997 7C             	LD	A,H
D998 B7             	OR	A
D999 28 06          	JR	Z,_S12DIR
D99B 3A FF EA       	LD	A,(_SECPS)
D99E F6 80          	OR	080H
D9A0 67             	LD	H,A
D9A1                _S12DIR:
D9A1 22 F8 F1       	LD	(SFNDF),HL	;Directory position and Flags
D9A4 E1             	POP	HL
D9A5 11 39 F0       	LD	DE,SFILE
D9A8 0E 21          	LD	C,33
D9AA                _S11B:
D9AA ED B0          	LDIR
D9AC                FEND:
D9AC 9F             	SBC	A,A		;CF=0 A=0 : CF=1 A=0FFH
D9AD                FENDE:
D9AD FD E1          	POP	IY
D9AF C1             	POP	BC
D9B0 D1             	POP	DE
D9B1 E1             	POP	HL
D9B2 C9             	RET
D9B3                
D9B3                _SYS12:		;(BDOS)次のファイルの検索
D9B3 E5             	PUSH	HL
D9B4 D5             	PUSH	DE
D9B5 C5             	PUSH	BC
D9B6 FD E5          	PUSH	IY
D9B8 CD 47 E2       	CALL	NOPEN
D9BB 18 B3          	JR	_S12X1
D9BD                
D9BD                _S16K:
D9BD 11 00 00       	LD	DE,0
D9C0 00 00 D9 BE    OFCB_SWC	EQU	$-2
D9C0 D5             	PUSH	DE
D9C1 06 1A          	LD	B,26		;First cluster
D9C3                S16K1:
D9C3 13             	INC	DE
D9C4 23             	INC	HL
D9C5 10 FC          	DJNZ	S16K1
D9C7                
D9C7 1A             	LD	A,(DE)
D9C8 BE             	CP	(HL)
D9C9 20 15          	JR	NZ,S16K2
D9CB 13             	INC	DE
D9CC 23             	INC	HL
D9CD 1A             	LD	A,(DE)
D9CE BE             	CP	(HL)
D9CF 20 0F          	JR	NZ,S16K2
D9D1                
D9D1 E1             	POP	HL
D9D2 FD E5          	PUSH	IY
D9D4 D1             	POP	DE
D9D5 7E             	LD	A,(HL)
D9D6 CD 9F E1       	CALL	IS_SAME_DRV_A_DE
D9D9 20 06          	JR	NZ,S16K3
D9DB                				;ここはCFが必ず0
D9DB ED 52          	SBC	HL,DE		;CP HL,DE
D9DD 37             	SCF
D9DE C0             	RET	NZ
D9DF E5             	PUSH	HL
D9E0                S16K2:
D9E0 E1             	POP	HL
D9E1                S16K3:
D9E1 FD E5          	PUSH	IY
D9E3 D1             	POP	DE
D9E4                _SYS13:		;(BDOS)ファイルの削除
D9E4 CD 8A E1       	CALL	SETDRV
D9E7 CD 0E E4       	CALL	KILL
D9EA                FEND13:
D9EA 18 C0          	JR	FEND
D9EC                
D9EC                _SYS14:		;(BDOS)シーケンシャルな読み出し
D9EC CD 8A E1       	CALL	SETDRV
D9EF CD 40 E6       	CALL	INIT_SEQ
D9F2                SREAD:
D9F2 CD 88 E6       	CALL	RB_READ
D9F5                
D9F5 C6 01          	ADD	A,001H
D9F7 38 B3          	JR	C,FEND
D9F9                
D9F9 7D             	LD	A,L
D9FA D6 01          	SUB	001H
D9FC                FENDX:
D9FC 9F             	SBC	A,A
D9FD E6 03          	AND	3
D9FF 1F             	RRA
DA00 18 AB          	JR	FENDE
DA02                
DA02                _SYS15:		;(BDOS)シーケンシャルな書き込み
DA02 CD 8A E1       	CALL	SETDRV
DA05 CD 40 E6       	CALL	INIT_SEQ
DA08                SWRITE:
DA08 CD 81 E6       	CALL	RB_WRITE
DA0B                
DA0B C6 FF          	ADD	A,0FFH
DA0D 18 ED          	JR	FENDX
DA0F                
DA0F                _SYS17:		;(BDOS)ファイル名の変更
DA0F CD 8A E1       	CALL	SETDRV
DA12 CD 64 E4       	CALL	NAME
DA15 18 D3          	JR	FEND13
DA17                
DA17                _SYS16:		;(BDOS)ファイルの作成
DA17 CD 8A E1       	CALL	SETDRV
DA1A                
DA1A CD D8 E4       	CALL	CHKWILDX
DA1D 38 CB          	JR	C,FEND13
DA1F FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
DA22 FE 05          	CP	5
DA24 28 05          	JR	Z,_S16X2
DA26 FE 21          	CP	021H
DA28 DA EA D9       	JP	C,FEND13
DA2B                _S16X2:
DA2B                ;				Clear FCB
DA2B FD E5          	PUSH	IY
DA2D E1             	POP	HL
DA2E 01 10 00       	LD	BC,16
DA31 09             	ADD	HL,BC
DA32                _S16X1:
DA32 70             	LD	(HL),B		;B=0
DA33 23             	INC	HL
DA34 0D             	DEC	C
DA35 20 FB          	JR	NZ,_S16X1
DA37                
DA37 CD D9 E5       	CALL	SETTMSX
DA3A FD 36 0D FF    	LD	(IY+13),0FFH	;(FCB)Attribute
DA3E CD B4 E1       	CALL	SOPENX
DA41 3F             	CCF
DA42 CC BD D9       	CALL	Z,_S16K
DA45 D4 93 E2       	CALL	NC,COPEN
DA48 D4 E8 E4       	CALL	NC,SDIRENT
DA4B C3 DF D8       	JP	_S16XX
DA4E                
DA4E                _SYS21:		;(BDOS)ランダムな読み出し
DA4E CD 8A E1       	CALL	SETDRV
DA51 CD 24 E6       	CALL	INIT_RND
DA54 18 9C          	JR	SREAD
DA56                
DA56                _SYS22:		;(BDOS)ランダムな書き込み
DA56                _SYS28:		;(BDOS)ランダムな書き込み・その2
DA56 CD 8A E1       	CALL	SETDRV
DA59 CD 24 E6       	CALL	INIT_RND
DA5C 18 AA          	JR	SWRITE
DA5E                
DA5E                _SYS18:		;(BDOS)ログインベクトルの獲得
DA5E 21 FF 00       	LD	HL,000FFH
DA61 AF             	XOR	A
DA62 C9             	RET
DA63                
DA63                _SYS19:		;(BDOS)カレントドライブ番号の獲得
DA63 3A 87 F0       	LD	A,(_DVSW)
DA66 A7             	AND	A
DA67 C9             	RET
DA68                
DA68                _SYS1A:		;(BDOS)DTAの設定
DA68 ED 53 8A F0    	LD	(_DTA),DE
DA6C AF             	XOR	A
DA6D C9             	RET
DA6E                
DA6E                _SYS1B:		;(BDOS)ディスク情報の獲得
DA6E 7B             	LD	A,E
DA6F CD 98 E1       	CALL	GETDRV
DA72 CD DC F0       	CALL	_GETDPB
DA75 D4 E2 F0       	CALL	NC,_RDFATX
DA78 21 00 00       	LD	HL,0
DA7B D4 B2 E5       	CALL	NC,DSKF
DA7E                
DA7E ED 5B B3 E5    	LD	DE,(MAXCLP)	;DPB_MAXCL-1
DA82 1B             	DEC	DE		;DE←クラスタの総数
DA83 FD 2A 7C F1    	LD	IY,(_FATBF)	;IY←メモリ上のFATの先頭アドレス
DA87 9F             	SBC	A,A
DA88 D8             	RET	C
DA89 4F             	LD	C,A		;C=0
DA8A DD 7E 0F       	LD	A,(IX+DPB_BPS)
DA8D E6 07          	AND	7
DA8F 47             	LD	B,A
DA90 DD 7E 07       	LD	A,(IX+DPB_SECPCL)
DA93 C9             	RET
DA94                
DA94                _SYS1D:		;(BDOS)書き込みが禁止されているディスクの調査
DA94 AF             	XOR	A
DA95 67             	LD	H,A
DA96 6F             	LD	L,A
DA97 C9             	RET
DA98                
DA98                _SYS1F:		;(BDOS)ディスク装置のパラメータの読み出し
DA98 21 00 F2       	LD	HL,_DEVICE
DA9B 7B             	LD	A,E
DA9C C3 DC F0       	JP	_GETDPB
DA9F                
DA9F                _SYS23:		;(BDOS)ファイルサイズの獲得
DA9F E5             	PUSH	HL
DAA0 2A 1E F1       	LD	HL,(STABLE+2*00FH)	;ファイルのオープン
DAA3 CD 0F 00       	CALL	JP_HL
DAA6 38 1B          	JR	C,_S23X1
DAA8                
DAA8 D5             	PUSH	DE		;EX DE,IY
DAA9 FD E3          	EX	(SP),IY		;
DAAB                ;	POP	DE		;
DAAB                ;	PUSH	DE		;DEを破壊しないように注意vv
DAAB FD 7E 10       	LD	A,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
DAAE FD 6E 11       	LD	L,(IY+17)	;
DAB1 FD 66 12       	LD	H,(IY+18)	;
DAB4 C5             	PUSH	BC		;
DAB5 FD 46 13       	LD	B,(IY+19)	;
DAB8 CD 16 E6       	CALL	GET_CPM_R_SIZE
DABB C1             	POP	BC
DABC                _S24X1:
DABC CD 36 E6       	CALL	SET_RR_AHL
DABF                ;	POP	DE		;^^^^^^^^^^^^^^^^^^^^^^^^
DABF                ;	PUSH	DE		;EX DE,IY
DABF FD E3          	EX	(SP),IY		;
DAC1 D1             	POP	DE		;
DAC2                
DAC2 AF             	XOR	A
DAC3                _S23X1:
DAC3 E1             	POP	HL
DAC4 C9             	RET
DAC5                
DAC5                _SYS24:		;(BDOS)ランダムレコードフィールドの設定
DAC5 E5             	PUSH	HL
DAC6 D5             	PUSH	DE		;EX DE,IY
DAC7 FD E3          	EX	(SP),IY		;
DAC9                ;	POP	DE		;
DAC9                ;	PUSH	DE		;DEを破壊しないように注意vv
DAC9 CD 48 E6       	CALL	GETSEQ
DACC 18 EE          	JR	_S24X1		;^^^^^^^^^^^^^^^^^^^^^^^^
DACE                
DACE                _SYS29:		;(BDOS)ファイル名の解析(_PPATH)
DACE C5             	PUSH	BC
DACF E5             	PUSH	HL
DAD0 CD A1 E0       	CALL	FILE
DAD3 E1             	POP	HL
DAD4 C1             	POP	BC
DAD5                S29X1:
DAD5 C5             	PUSH	BC
DAD6 D5             	PUSH	DE
DAD7 E5             	PUSH	HL
DAD8 EB             	EX	DE,HL
DAD9 AF             	XOR	A
DADA 32 21 F0       	LD	(FDRV+13),A
DADD 21 14 F0       	LD	HL,FDRV
DAE0 01 10 00       	LD	BC,16
DAE3 ED B0          	LDIR
DAE5 E1             	POP	HL
DAE6 D1             	POP	DE
DAE7 C1             	POP	BC
DAE8 C9             	RET
DAE9                
DAE9                _SYS30:		;(BDOS)論理セクタを用いた書き込み
DAE9 C5             	PUSH	BC
DAEA 01 99 EC       	LD	BC,DWT24B
DAED 18 04          	JR	S2FX
DAEF                _SYS2F:
DAEF C5             	PUSH	BC
DAF0 01 89 EC       	LD	BC,DRD24B
DAF3                S2FX:
DAF3 ED 43 09 DB    	LD	(S2FPAT+1),BC
DAF7 CD DF F0       	CALL	_FFLUSH
DAFA                
DAFA D5             	PUSH	DE
DAFB E5             	PUSH	HL
DAFC 7D             	LD	A,L		;Drive
DAFD CD D9 F0       	CALL	_CHGDRV
DB00 38 09          	JR	C,S30X2
DB02 44             	LD	B,H		;Number of clusters
DB03 2A 8A F0       	LD	HL,(_DTA)
DB06                
DB06 0E 00          	LD	C,0
DB08 CD 89 EC       S2FPAT:	CALL	DRD24B
DB0B                S30X2:
DB0B E1             	POP	HL
DB0C D1             	POP	DE
DB0D C1             	POP	BC
DB0E 9F             	SBC	A,A
DB0F C9             	RET
DB10                
DB10                _SYS5A:		;(BDOS)カレントディレクトリの変更
DB10 C5             	PUSH	BC
DB11 D5             	PUSH	DE
DB12 E5             	PUSH	HL
DB13 CD 96 E0       	CALL	FILEC
DB16 21 00 00       	LD	HL,0
DB19 11 14 F0       	LD	DE,FDRV
DB1C 2A 4E F1       	LD	HL,(STABLE+2*027H)	;ランダムブロック読み込み
DB1F CD 0F 00       	CALL	JP_HL
DB22 18 E7          	JR	S30X2
DB24                	INCLUDE	"X1IO.ASM"
DB24                
DB24                ;	LSX-Dodgers IO
DB24                ;	X1/turbo/Z
DB24                
DB24 00 00 D8 93    _SYS04	EQU	_ERROR		;(BDOS)外部出力
DB24 00 00 D8 93    _SYS05	EQU	_ERROR		;(BDOS)プリンタ出力
DB24 00 00 D8 93    _SYS1C	EQU	_ERROR		;(BDOS)ディスクの書き込み禁止化
DB24 00 00 D8 93    _SYS1E	EQU	_ERROR		;(BDOS)ファイル属性の設定
DB24 00 00 D8 93    _SYS20	EQU	_ERROR		;(BDOS)利用者番号の設定と読み出し
DB24 00 00 D8 93    _SYS2E	EQU	_ERROR		;(BDOS)ベリファイ・フラグの設定
DB24                
DB24                BIOS:
DB24 E5             	PUSH	HL
DB25 21 10 80       	LD	HL,08010H
DB28 39             	ADD	HL,SP
DB29 E1             	POP	HL
DB2A 30 0E          	JR	NC,BIOS2
DB2C                BIOS1:
DB2C CD 34 DB       	CALL	BIOS3
DB2F 06 1E          	LD	B,01EH
DB31 ED 79          	OUT	(C),A
DB33 C9             	RET
DB34                BIOS3:
DB34 C5             	PUSH	BC
DB35 06 1D          	LD	B,01DH
DB37 ED 79          	OUT	(C),A
DB39 C9             	RET
DB3A                BIOS2:
DB3A ED 73 45 DB    	LD	(BIOS_SP),SP	;スタックがBIOS-ROMと被っている場合
DB3E 31 CA FF       	LD	SP,EXTSP
DB41 CD 2C DB       	CALL	BIOS1
DB44 31 00 00       	LD	SP,0
DB47 00 00 DB 45    BIOS_SP	EQU	$-2
DB47 C9             	RET
DB48                
DB48                INT:
DB48 F5             	PUSH	AF
DB49 E5             	PUSH	HL
DB4A C5             	PUSH	BC
DB4B                
DB4B CD D8 DE       	CALL	IN49SB
DB4E 67             	LD	H,A
DB4F CD D8 DE       	CALL	IN49SB
DB52 6F             	LD	L,A
DB53                SCEXE:
DB53 22 92 F0       	LD	(_KEYD),HL
DB56 CD 5F DB       	CALL	KEYSET1
DB59                
DB59 C1             	POP	BC
DB5A                INTPE:
DB5A E1             	POP	HL
DB5B                INTPE2:
DB5B F1             	POP	AF
DB5C                INTCTCE:
DB5C FB             	EI
DB5D ED 4D          	RETI
DB5F                
DB5F                KEYSET1:
DB5F F5             	PUSH	AF
DB60 AF             	XOR	A
DB61 32 FC DB       	LD	(FLGET_SWC),A
DB64 F1             	POP	AF
DB65 B7             	OR	A
DB66 C8             	RET	Z
DB67                
DB67 CB 6C          	BIT	5,H
DB69 28 06          	JR	Z,KEYSET
DB6B 3A 95 F0       	LD	A,(_KEYSP+1)
DB6E 32 11 DC       	LD	(KEYREPEAT_SWC),A
DB71                KEYSET:
DB71 7D             	LD	A,L
DB72 CB 74          	BIT	6,H
DB74 C0             	RET	NZ
DB75                KEYBS:
DB75 B7             	OR	A
DB76 C8             	RET	Z
DB77                KEYBS1:
DB77 CD 8F DB       	CALL	KEYBC_IFBREAK
DB7A E5             	PUSH	HL
DB7B F5             	PUSH	AF
DB7C 2A 90 F0       	LD	HL,(_KEYPS)
DB7F 2C             	INC	L
DB80 CB AD          	RES	5,L
DB82 7D             	LD	A,L
DB83 BC             	CP	H
DB84 28 15          	JR	Z,POP_AF_HL_SCF_RET
DB86 32 90 F0       	LD	(_KEYPS),A
DB89 26 FF          	LD	H,KEYBF/256
DB8B F1             	POP	AF
DB8C 77             	LD	(HL),A
DB8D E1             	POP	HL
DB8E C9             	RET
DB8F                KEYBC_IFBREAK:
DB8F FE 03          	CP	3
DB91 C0             	RET	NZ
DB92                KEYBC:
DB92 E5             	PUSH	HL
DB93 21 00 00       	LD	HL,0
DB96 22 90 F0       	LD	(_KEYPS),HL
DB99 E1             	POP	HL
DB9A C9             	RET
DB9B                
DB9B                POP_AF_HL_SCF_RET:
DB9B F1             	POP	AF
DB9C E1             	POP	HL
DB9D 37             	SCF
DB9E C9             	RET
DB9F                
DB9F                _SYS01:		;(BDOS)コンソール入力
DB9F CD 09 F0       	CALL	_SYS07
DBA2                MSG_A:
DBA2 F5             	PUSH	AF
DBA3 D5             	PUSH	DE
DBA4 5F             	LD	E,A
DBA5 CD AB DB       	CALL	_SYS02
DBA8 D1             	POP	DE
DBA9 F1             	POP	AF
DBAA C9             	RET
DBAB                
DBAB                _SYS02:		;(BDOS)コンソール出力
DBAB CD BD DB       	CALL	BREAK
DBAE 18 05          	JR	PRINTX
DBB0                
DBB0                _SYS06:		;(BDOS)コンソール直接入出力
DBB0 7B             	LD	A,E
DBB1 3C             	INC	A
DBB2 CA CA F0       	JP	Z,_INKEY
DBB5                PRINTX:
DBB5 C3 CD F0       	JP	_PRINT
DBB8                
DBB8                _SYS08:		;(BDOS)エコーなしコンソール入力
DBB8 CD 09 F0       	CALL	_SYS07
DBBB 18 04          	JR	BREAK1
DBBD                BREAK:
DBBD FB             	EI
DBBE 3A 92 F0       	LD	A,(_KEYD)
DBC1                BREAK1:
DBC1 FE 03          	CP	3		;CTRL+C
DBC3 CC F4 F0       	CALL	Z,_BREAK
DBC6 FE 13          	CP	013H		;CTRL+S
DBC8 C0             	RET	NZ
DBC9                
DBC9                PAUSE:
DBC9 CD 92 DB       	CALL	KEYBC
DBCC                
DBCC                FLGET:
DBCC CD DF F0       	CALL	_FFLUSH
DBCF C5             	PUSH	BC
DBD0 E5             	PUSH	HL
DBD1 ED 4B 8E F0    	LD	BC,(_TXADR)
DBD5 CB E8          	SET	5,B
DBD7 ED 60          	IN	H,(C)
DBD9                FLGET1:
DBD9 3A 93 F0       	LD	A,(_KEYD+1)
DBDC 0F             	RRCA
DBDD 0F             	RRCA
DBDE E6 10          	AND	010H
DBE0 F6 08          	OR	8
DBE2 ED 68          	IN	L,(C)
DBE4 B5             	OR	L
DBE5 ED 79          	OUT	(C),A
DBE7                FLGETR:
DBE7 CD CA F0       	CALL	_INKEY
DBEA 20 32          	JR	NZ,FLGETE
DBEC CB 5D          	BIT	3,L
DBEE 28 E9          	JR	Z,FLGET1
DBF0 3A 92 F0       	LD	A,(_KEYD)
DBF3 B7             	OR	A
DBF4 28 E3          	JR	Z,FLGET1
DBF6                
DBF6 3E 1A          	LD	A,01AH
DBF8 32 FC DB       	LD	(FLGET_SWC),A
DBFB                FLGET2:
DBFB 3E 1A          	LD	A,1AH
DBFD 00 00 DB FC    FLGET_SWC	EQU	$-1
DBFD B7             	OR	A
DBFE 28 E7          	JR	Z,FLGETR
DC00 DB 01          	IN	A,(01H)
DC02 87             	ADD	A,A
DC03 30 F6          	JR	NC,FLGET2
DC05                FLGET3:
DC05 3A FC DB       	LD	A,(FLGET_SWC)
DC08 B7             	OR	A
DC09 28 DC          	JR	Z,FLGETR
DC0B DB 01          	IN	A,(01H)
DC0D 87             	ADD	A,A
DC0E 38 F5          	JR	C,FLGET3
DC10                
DC10 3E 00          	LD	A,0
DC12 00 00 DC 11    KEYREPEAT_SWC	EQU $-1
DC12 B7             	OR	A
DC13 28 06          	JR	Z,FLGET4
DC15 3D             	DEC	A
DC16 32 11 DC       	LD	(KEYREPEAT_SWC),A
DC19 18 E0          	JR	FLGET2
DC1B                FLGET4:
DC1B 3A 92 F0       	LD	A,(_KEYD)
DC1E                FLGETE:
DC1E ED 61          	OUT	(C),H
DC20 E1             	POP	HL
DC21 C1             	POP	BC
DC22 C9             	RET
DC23                
DC23                _SYS0A:		;(BDOS)文字列入力
DC23 C5             	PUSH	BC
DC24 E5             	PUSH	HL
DC25 D5             	PUSH	DE
DC26 CD 25 E0       	CALL	GETL
DC29 11 20 FF       	LD	DE,KBUF
DC2C E1             	POP	HL
DC2D E5             	PUSH	HL
DC2E 0E 00          	LD	C,0
DC30 30 04          	JR	NC,SAX0
DC32 23             	INC	HL
DC33 23             	INC	HL
DC34 18 08          	JR	SAX4
DC36                SAX0:
DC36 46             	LD	B,(HL)
DC37 23             	INC	HL
DC38                SAX1:
DC38 23             	INC	HL
DC39 1A             	LD	A,(DE)
DC3A 13             	INC	DE
DC3B B7             	OR	A
DC3C 20 04          	JR	NZ,SAX2
DC3E                SAX4:
DC3E 36 0D          	LD	(HL),00DH
DC40 18 04          	JR	SAX3
DC42                SAX2:
DC42 77             	LD	(HL),A
DC43 0C             	INC	C
DC44 10 F2          	DJNZ	SAX1
DC46                SAX3:
DC46 D1             	POP	DE
DC47 79             	LD	A,C
DC48 13             	INC	DE
DC49 12             	LD	(DE),A
DC4A 1B             	DEC	DE
DC4B E1             	POP	HL
DC4C C1             	POP	BC
DC4D A7             	AND	A
DC4E C9             	RET
DC4F                
DC4F                _SYS0B:		;(BDOS)コンソール状態のチェック
DC4F CD BD DB       	CALL	BREAK
DC52 3A 92 F0       	LD	A,(_KEYD)
DC55 B7             	OR	A
DC56 C8             	RET	Z
DC57                CONSTX:
DC57 CD DF F0       	CALL	_FFLUSH
DC5A E5             	PUSH	HL
DC5B 2A 90 F0       	LD	HL,(_KEYPS)
DC5E 7C             	LD	A,H
DC5F AD             	XOR	L
DC60 E1             	POP	HL
DC61 C6 FF          	ADD	A,0FFH
DC63 9F             	SBC	A,A
DC64 C9             	RET
DC65                
DC65                _SYS2A:		;(BDOS)日付の獲得
DC65 C5             	PUSH	BC
DC66 3E ED          	LD	A,0EDH		;Read calendar
DC68 CD F3 DE       	CALL	COMOUT
DC6B CD 9D DC       	CALL	IN49SB_BCD	;YY
DC6E 6F             	LD	L,A
DC6F 26 00          	LD	H,0
DC71                ;	LD	DE,1900		;0076CH
DC71                ;	CP	90		;90以上は1900年代 1990-1999
DC71                ;	JR	NC,RDDATE1	;90未満は2000年代 2000-2089
DC71                ;	LD	E,0D0H		;2000 & 0FFH D=007H
DC71 11 D0 07       	LD	DE,2000		;すべて2000年代で処理 2000-2099
DC74                RDDATE1:
DC74 19             	ADD	HL,DE
DC75 CD D8 DE       	CALL	IN49SB		;MW
DC78 57             	LD	D,A
DC79 CD 9D DC       	CALL	IN49SB_BCD	;DD
DC7C 5F             	LD	E,A
DC7D 7A             	LD	A,D
DC7E 06 04          	LD	B,4
DC80                RDDATE2:
DC80 CB 3A          	SRL	D
DC82 10 FC          	DJNZ	RDDATE2
DC84 C1             	POP	BC
DC85 E6 07          	AND	7
DC87 C9             	RET
DC88                
DC88                _SYS2C:		;(BDOS)時刻の獲得
DC88 C5             	PUSH	BC
DC89 3E EF          	LD	A,0EFH		;Read time
DC8B CD F3 DE       	CALL	COMOUT
DC8E CD 9D DC       	CALL	IN49SB_BCD	;TT
DC91 67             	LD	H,A
DC92 CD 9D DC       	CALL	IN49SB_BCD	;MM
DC95 6F             	LD	L,A
DC96 CD 9D DC       	CALL	IN49SB_BCD	;SS
DC99 57             	LD	D,A
DC9A C1             	POP	BC
DC9B AF             	XOR	A
DC9C C9             	RET
DC9D                
DC9D                IN49SB_BCD:
DC9D CD D8 DE       	CALL	IN49SB
DCA0                ;------------------------
DCA0                ;BCDの10進数化
DCA0                ;in
DCA0                ;	A  : BCD
DCA0                ;out
DCA0                ;	A  : 10進数
DCA0                ;------------------------
DCA0 4F             	LD	C,A
DCA1 E6 F0          	AND	0F0H	;10の位
DCA3 0F             	RRCA
DCA4 47             	LD	B,A
DCA5 0F             	RRCA
DCA6 0F             	RRCA
DCA7 80             	ADD	A,B
DCA8 47             	LD	B,A
DCA9 79             	LD	A,C
DCAA E6 0F          	AND	00FH	;1の位
DCAC 80             	ADD	A,B
DCAD C9             	RET
DCAE                
DCAE                ESC1:
DCAE 7B             	LD	A,E
DCAF FE 41          	CP	'A'
DCB1 CA F6 DD       	JP	Z,CTRL1E
DCB4 FE 42          	CP	'B'
DCB6 CA 5E DF       	JP	Z,CTRL1F
DCB9 FE 43          	CP	'C'
DCBB CA 01 DE       	JP	Z,CTRL1C
DCBE FE 44          	CP	'D'
DCC0 CA ED DD       	JP	Z,CTRL1D
DCC3 FE 45          	CP	'E'
DCC5 28 02          	JR	Z,CT0CX
DCC7 FE 6A          	CP	'j'
DCC9                CT0CX:
DCC9 CA 31 DF       	JP	Z,CTRL0C
DCCC FE 48          	CP	'H'
DCCE CA 7B DE       	JP	Z,CTRL0B
DCD1 FE 4A          	CP	'J'
DCD3 CA 34 DF       	JP	Z,CTRL06
DCD6 FE 4B          	CP	'K'
DCD8 28 07          	JR	Z,CT05X
DCDA FE 4C          	CP	'L'
DCDC CA 73 DF       	JP	Z,CTRL0E
DCDF FE 54          	CP	'T'
DCE1                CT05X:
DCE1 CA 3A DE       	JP	Z,CTRL05
DCE4 FE 78          	CP	'x'
DCE6 28 04          	JR	Z,ESC1X
DCE8 FE 79          	CP	'y'
DCEA 20 02          	JR	NZ,ESC1Y
DCEC                ESC1X:
DCEC 36 01          	LD	(HL),1
DCEE                ESC1Y:
DCEE FE 3D          	CP	'='
DCF0 28 04          	JR	Z,ESC1W
DCF2 FE 59          	CP	'Y'
DCF4 20 02          	JR	NZ,ESC1Z
DCF6                ESC1W:
DCF6 36 02          	LD	(HL),2
DCF8                ESC1Z:
DCF8 FE 20          	CP	020H
DCFA 38 02          	JR	C,ESC1C
DCFC 87             	ADD	A,A
DCFD D0             	RET	NC
DCFE                ESC1C:
DCFE E1             	POP	HL
DCFF                ANK:
DCFF ED 4B 8E F0    	LD	BC,(_TXADR)
DD03 78             	LD	A,B
DD04 F6 38          	OR	038H
DD06 47             	LD	B,A
DD07 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DD09 CB 98          	RES	3,B
DD0B ED 59          	OUT	(C),E		;Text
DD0D                KANJIE:
DD0D CD C2 DD       	CALL	PRINTE7
DD10                PRINTE5:
DD10 E1             	POP	HL
DD11 C1             	POP	BC
DD12 AF             	XOR	A
DD13 C9             	RET
DD14                
DD14                ESC:
DD14 21 10 DD       	LD	HL,PRINTE5
DD17 E5             	PUSH	HL
DD18 21 3A DD       	LD	HL,ESCFLG+1
DD1B 36 00          	LD	(HL),0
DD1D 3D             	DEC	A
DD1E 28 8E          	JR	Z,ESC1
DD20 3D             	DEC	A
DD21 20 09          	JR	NZ,ESC2
DD23 36 03          	LD	(HL),3
DD25 7B             	LD	A,E
DD26 D6 20          	SUB	020H
DD28 32 2F DD       	LD	(ESCYP+1),A
DD2B C9             	RET
DD2C                ESC2:
DD2C 3D             	DEC	A
DD2D C0             	RET	NZ
DD2E 26 00          ESCYP:	LD	H,0
DD30 7B             	LD	A,E
DD31 D6 20          	SUB	020H
DD33 6F             	LD	L,A
DD34 C3 D6 F0       	JP	_LOC
DD37                
DD37                PRINT:
DD37 C5             	PUSH	BC
DD38 E5             	PUSH	HL
DD39 3E 00          ESCFLG:	LD	A,000H
DD3B B7             	OR	A
DD3C 20 D6          	JR	NZ,ESC
DD3E                
DD3E 3E 1F          	LD	A,01FH
DD40 BB             	CP	E
DD41 30 20          	JR	NC,CTRL
DD43 01 FC DE       INSFLG:	LD	BC,INSERT
DD46                
DD46 3A 18 00       	LD	A,(00018H)
DD49 3C             	INC	A
DD4A 28 B3          	JR	Z,ANK
DD4C 3E 00          KANFLG:	LD	A,000H
DD4E B7             	OR	A
DD4F 20 25          	JR	NZ,KANJI2
DD51 7B             	LD	A,E
DD52 FE 80          	CP	080H
DD54 38 A9          	JR	C,ANK
DD56 FE A0          	CP	0A0H
DD58 38 04          	JR	C,KANJI1
DD5A FE E0          	CP	0E0H
DD5C 38 A1          	JR	C,ANK
DD5E                KANJI1:
DD5E 32 4D DD       	LD	(KANFLG+1),A
DD61 18 AD          	JR	PRINTE5
DD63                
DD63                CTRL:
DD63 CD A9 DD       	CALL	KANCLR
DD66 7B             	LD	A,E
DD67 87             	ADD	A,A
DD68 F6 80          	OR	080H
DD6A 6F             	LD	L,A
DD6B 26 F1          	LD	H,CTRLTB/256
DD6D 7E             	LD	A,(HL)
DD6E 2C             	INC	L
DD6F 66             	LD	H,(HL)
DD70 6F             	LD	L,A
DD71 CD 0F 00       	CALL	JP_HL
DD74 18 9A          	JR	PRINTE5
DD76                
DD76                KANJI2:
DD76 D5             	PUSH	DE
DD77 57             	LD	D,A
DD78 01 81 2F       	LD	BC,02F81H	;SFTJIS
DD7B DF             	RST	018H
DD7C 01 C3 2F       	LD	BC,02FC3H	;Instead or JISVRM
DD7F DF             	RST	018H
DD80                
DD80 ED 4B 8E F0    	LD	BC,(_TXADR)
DD84 78             	LD	A,B
DD85 F6 38          	OR	038H
DD87 47             	LD	B,A
DD88 ED 51          	OUT	(C),D		;kanji
DD8A CB 98          	RES	3,B
DD8C ED 59          	OUT	(C),E		;Text
DD8E CD C2 DD       	CALL	PRINTE7
DD91 ED 4B 8E F0    	LD	BC,(_TXADR)
DD95 78             	LD	A,B
DD96 F6 38          	OR	038H
DD98 47             	LD	B,A
DD99 CB F2          	SET	6,D
DD9B ED 51          	OUT	(C),D		;Kanji
DD9D CB 98          	RES	3,B
DD9F ED 59          	OUT	(C),E		;Text
DDA1 D1             	POP	DE
DDA2 AF             	XOR	A
DDA3 32 4D DD       	LD	(KANFLG+1),A
DDA6 C3 0D DD       	JP	KANJIE
DDA9                
DDA9                KANCLR:
DDA9 3A 4D DD       	LD	A,(KANFLG+1)
DDAC B7             	OR	A
DDAD C8             	RET	Z
DDAE ED 4B 8E F0    	LD	BC,(_TXADR)
DDB2 78             	LD	A,B
DDB3 F6 38          	OR	038H
DDB5 47             	LD	B,A
DDB6 AF             	XOR	A
DDB7 32 4D DD       	LD	(KANFLG+1),A
DDBA ED 79          	OUT	(C),A		;Kanji
DDBC CB 98          	RES	3,B
DDBE 3E 20          	LD	A,020H
DDC0 ED 79          	OUT	(C),A		;Text
DDC2                PRINTE7:
DDC2 CB A0          	RES	4,B
DDC4                PRINTE6:
DDC4 3A 96 F0       	LD	A,(_COLORF)
DDC7                PRINTE4:
DDC7 ED 79          	OUT	(C),A		;Color
DDC9 78             	LD	A,B
DDCA E6 07          	AND	7
DDCC 47             	LD	B,A
DDCD                PRINTE2:
DDCD 03             	INC	BC
DDCE                PRINTE3:
DDCE 2A BA F0       	LD	HL,(_PAGE_MINUS)
DDD1 A7             	AND	A
DDD2 ED 4A          	ADC	HL,BC
DDD4                PRINTE8:
DDD4 28 05          	JR	Z,PRINT2
DDD6 ED 43 8E F0    	LD	(_TXADR),BC
DDDA                CTRL00:
DDDA C9             	RET
DDDB                
DDDB                PRINT2:
DDDB CD 79 DF       	CALL	SCR
DDDE 2A BC F0       	LD	HL,(_WIDTH_MINUS)
DDE1 09             	ADD	HL,BC
DDE2                SET_TXADR_HL:
DDE2 22 8E F0       	LD	(_TXADR),HL
DDE5 C9             	RET
DDE6                
DDE6                CTRL08:
DDE6 3A 43 DD       	LD	A,(INSFLG)
DDE9 FE CD          	CP	0CDH		;CALL ????
DDEB 28 29          	JR	Z,CTRL02
DDED                CTRL1D:
DDED 2A 8E F0       	LD	HL,(_TXADR)
DDF0 7C             	LD	A,H
DDF1 B5             	OR	L
DDF2 C8             	RET	Z
DDF3 2B             	DEC	HL
DDF4 18 EC          	JR	SET_TXADR_HL
DDF6                
DDF6                CTRL1E:
DDF6 ED 4B 8E F0    	LD	BC,(_TXADR)
DDFA 2A BC F0       	LD	HL,(_WIDTH_MINUS)
DDFD 09             	ADD	HL,BC
DDFE D0             	RET	NC
DDFF 18 E1          	JR	SET_TXADR_HL
DE01                
DE01                CTRL1C:
DE01 ED 4B 8E F0    	LD	BC,(_TXADR)
DE05 18 C6          	JR	PRINTE2
DE07                
DE07                CTRL09:
DE07 ED 4B 8E F0    	LD	BC,(_TXADR)
DE0B 79             	LD	A,C
DE0C E6 F8          	AND	0F8H
DE0E C6 08          	ADD	A,8
DE10 4F             	LD	C,A
DE11 88             	ADC	A,B
DE12 91             	SUB	C
DE13 47             	LD	B,A
DE14 18 B8          	JR	PRINTE3
DE16                
DE16                CTRL02:
DE16 CD ED DD       	CALL	CTRL1D
DE19 C8             	RET	Z
DE1A D5             	PUSH	DE
DE1B CD D3 F0       	CALL	_POS
DE1E 3A B1 F0       	LD	A,(_WIDTH)
DE21 95             	SUB	L
DE22 4F             	LD	C,A
DE23 0D             	DEC	C
DE24 06 38          	LD	B,038H
DE26 2A 8E F0       	LD	HL,(_TXADR)
DE29 09             	ADD	HL,BC
DE2A 44             	LD	B,H
DE2B 4D             	LD	C,L
DE2C 11 00 20       	LD	DE,02000H	;D:Text E:kanji
DE2F 2A 96 F0       	LD	HL,(_COLORF)	;L:Color
DE32                C8X1:
DE32 CD 18 DF       	CALL	C12S
DE35 0B             	DEC	BC
DE36 20 FA          	JR	NZ,C8X1
DE38 D1             	POP	DE
DE39 C9             	RET
DE3A                
DE3A                CTRL05:
DE3A CD D3 F0       	CALL	_POS
DE3D 3A B1 F0       	LD	A,(_WIDTH)
DE40 95             	SUB	L
DE41 6F             	LD	L,A
DE42                C08X1:
DE42 ED 4B 8E F0    	LD	BC,(_TXADR)
DE46                LINECL:
DE46 26 20          	LD	H,020H
DE48 3A 96 F0       	LD	A,(_COLORF)
DE4B CB E8          	SET	5,B
DE4D                LINECL1:
DE4D CB D8          	SET	3,B
DE4F CB E0          	SET	4,B
DE51 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DE53 CB 98          	RES	3,B
DE55 ED 61          	OUT	(C),H		;Text
DE57 CB A0          	RES	4,B
DE59 ED 79          	OUT	(C),A		;Color
DE5B 03             	INC	BC
DE5C 2D             	DEC	L
DE5D 20 EE          	JR	NZ,LINECL1
DE5F C9             	RET
DE60                
DE60                CTRL0D:
DE60 CD D3 F0       	CALL	_POS
DE63 2E 00          	LD	L,0
DE65                LOC:
DE65 C5             	PUSH	BC
DE66 E5             	PUSH	HL
DE67 CD A9 DD       	CALL	KANCLR
DE6A CD 88 DE       	CALL	LOC1
DE6D 22 8E F0       	LD	(_TXADR),HL
DE70 E1             	POP	HL
DE71 C1             	POP	BC
DE72 C9             	RET
DE73                
DE73                CTRL12:
DE73 21 43 DD       	LD	HL,INSFLG
DE76 7E             	LD	A,(HL)
DE77 EE CC          	XOR	0CCH		;CD:CALL ???? 1:LD BC,????
DE79 77             	LD	(HL),A
DE7A C9             	RET
DE7B                
DE7B                CTRL0B:
DE7B 21 00 00       	LD	HL,0
DE7E 22 8E F0       	LD	(_TXADR),HL
DE81 C9             	RET
DE82                
DE82                CTRL1B:
DE82 3E 01          	LD	A,1
DE84 32 3A DD       	LD	(ESCFLG+1),A
DE87 C9             	RET
DE88                
DE88                LOC1:
DE88 D5             	PUSH	DE
DE89 4D             	LD	C,L
DE8A 06 08          	LD	B,8
DE8C 5C             	LD	E,H
DE8D 16 00          	LD	D,0
DE8F 2A B0 F0       	LD	HL,(CRTCD)
DE92 6A             	LD	L,D
DE93                LOC2:
DE93 29             	ADD	HL,HL
DE94 30 01          	JR	NC,LOC3
DE96 19             	ADD	HL,DE
DE97                LOC3:
DE97 10 FA          	DJNZ	LOC2
DE99 09             	ADD	HL,BC
DE9A D1             	POP	DE
DE9B C9             	RET
DE9C                
DE9C                CONOUT1:
DE9C CD AE DE       	CALL	CURSOR
DE9F 59             	LD	E,C
DEA0 CD CD F0       	CALL	_PRINT
DEA3 7B             	LD	A,E
DEA4 FE 0A          	CP	00AH
DEA6 20 06          	JR	NZ,CURSOR
DEA8 CD 60 DE       	CALL	CTRL0D
DEAB CD 3A DE       	CALL	CTRL05
DEAE                CURSOR:
DEAE C5             	PUSH	BC
DEAF ED 4B 8E F0    	LD	BC,(_TXADR)
DEB3 CB E8          	SET	5,B
DEB5 ED 78          	IN	A,(C)
DEB7 EE 18          	XOR	018H
DEB9 ED 79          	OUT	(C),A
DEBB C1             	POP	BC
DEBC C9             	RET
DEBD                
DEBD                CTRL07:
DEBD 21 61 F0       	LD	HL,BEEPD
DEC0                BEEP1:
DEC0 7E             	LD	A,(HL)
DEC1 23             	INC	HL
DEC2 FE FF          	CP	0FFH
DEC4 C8             	RET	Z
DEC5 06 1C          	LD	B,01CH
DEC7 ED 79          	OUT	(C),A
DEC9 ED A3          	OUTI
DECB 18 F3          	JR	BEEP1
DECD                
DECD                OT49SB:
DECD C5             	PUSH	BC
DECE CD E9 DE       	CALL	CANW
DED1 01 00 19       	LD	BC,01900H
DED4 ED 79          	OUT	(C),A
DED6 C1             	POP	BC
DED7 C9             	RET
DED8                
DED8                IN49SB:
DED8 C5             	PUSH	BC
DED9 01 01 1A       	LD	BC,01A01H
DEDC                CANR:
DEDC ED 78          	IN	A,(C)
DEDE E6 20          	AND	020H
DEE0 20 FA          	JR	NZ,CANR
DEE2 01 00 19       	LD	BC,01900H
DEE5 ED 78          	IN	A,(C)
DEE7 C1             	POP	BC
DEE8 C9             	RET
DEE9                
DEE9                CANW:
DEE9 01 01 1A       	LD	BC,01A01H
DEEC ED 48          	IN	C,(C)
DEEE CB 71          	BIT	6,C
DEF0 20 F7          	JR	NZ,CANW
DEF2 C9             	RET
DEF3                
DEF3                COMOUT:
DEF3 FB             	EI
DEF4 CD CD DE       	CALL	OT49SB
DEF7 CD E9 DE       	CALL	CANW
DEFA F3             	DI
DEFB C9             	RET
DEFC                
DEFC                INSERT:
DEFC D5             	PUSH	DE
DEFD CD D3 F0       	CALL	_POS
DF00 3A B1 F0       	LD	A,(_WIDTH)
DF03 95             	SUB	L
DF04 ED 4B 8E F0    	LD	BC,(_TXADR)
DF08 11 00 20       	LD	DE,02000H	;D:Text E:Kanji
DF0B 2A 96 F0       	LD	HL,(_COLORF)	;L:Color
DF0E CB E8          	SET	5,B
DF10                C12X1:
DF10 CD 18 DF       	CALL	C12S
DF13 03             	INC	BC
DF14 20 FA          	JR	NZ,C12X1
DF16 D1             	POP	DE
DF17 C9             	RET
DF18                
DF18                C12S:
DF18 CB E0          	SET	4,B
DF1A CB D8          	SET	3,B
DF1C ED 60          	IN	H,(C)
DF1E ED 59          X1PAT:	OUT	(C),E
DF20 5C             	LD	E,H
DF21 CB 98          	RES	3,B
DF23 ED 60          	IN	H,(C)
DF25 ED 51          	OUT	(C),D
DF27 54             	LD	D,H
DF28 CB A0          	RES	4,B
DF2A ED 60          	IN	H,(C)
DF2C ED 69          	OUT	(C),L
DF2E 6C             	LD	L,H
DF2F 3D             	DEC	A
DF30 C9             	RET
DF31                
DF31                CTRL0C:
DF31 CD 7B DE       	CALL	CTRL0B
DF34                CTRL06:
DF34 ED 4B 8E F0    	LD	BC,(_TXADR)
DF38                C1AX1:
DF38 78             	LD	A,B
DF39 F6 38          	OR	038H
DF3B 47             	LD	B,A
DF3C ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DF3E CB 98          	RES	3,B
DF40 3E 20          	LD	A,020H
DF42 ED 79          	OUT	(C),A		;Text
DF44 CB A0          	RES	4,B
DF46 3A 96 F0       	LD	A,(_COLORF)
DF49 ED 79          	OUT	(C),A		;Color
DF4B 03             	INC	BC
DF4C CB A8          	RES	5,B
DF4E 2A BA F0       	LD	HL,(_PAGE_MINUS)
DF51 09             	ADD	HL,BC
DF52 30 E4          	JR	NC,C1AX1
DF54 C9             	RET
DF55                
DF55                CTRL04:
DF55 CD D3 F0       	CALL	_POS
DF58 7D             	LD	A,L
DF59 B7             	OR	A
DF5A C8             	RET	Z
DF5B                CTRL03:
DF5B CD 60 DE       	CALL	CTRL0D
DF5E                CTRL0A:
DF5E                CTRL1F:
DF5E ED 4B 8E F0    	LD	BC,(_TXADR)
DF62 2A B1 F0       	LD	HL,(_WIDTH)
DF65 26 00          	LD	H,0
DF67 09             	ADD	HL,BC
DF68 44             	LD	B,H
DF69 4D             	LD	C,L
DF6A 2A BA F0       	LD	HL,(_PAGE_MINUS)
DF6D 09             	ADD	HL,BC
DF6E 3F             	CCF
DF6F 9F             	SBC	A,A
DF70 C3 D4 DD       	JP	PRINTE8
DF73                
DF73                CTRL0E:
DF73 CD D3 F0       	CALL	_POS
DF76 7C             	LD	A,H
DF77 18 04          	JR	SCR1
DF79                SCR:
DF79 3A 97 F0       	LD	A,(_LINE)
DF7C 3D             	DEC	A
DF7D                SCR1:
DF7D C5             	PUSH	BC
DF7E D5             	PUSH	DE
DF7F F5             	PUSH	AF
DF80 3E 07          	LD	A,7
DF82 21 B3 DF       	LD	HL,SCRDMAD
DF85 CD A9 DF       	CALL	SETDMA
DF88 F1             	POP	AF
DF89 21 00 38       	LD	HL,03800H
DF8C                
DF8C                SCRUP1:
DF8C B7             	OR	A
DF8D 28 4D          	JR	Z,SCRCL
DF8F F5             	PUSH	AF
DF90 CD BA DF       	CALL	UPSUB		;kanji
DF93 3A BC F0       	LD	A,(_WIDTH_MINUS)
DF96 5F             	LD	E,A
DF97 16 F7          	LD	D,0F7H
DF99 19             	ADD	HL,DE
DF9A D5             	PUSH	DE
DF9B CD BA DF       	CALL	UPSUB		;Text
DF9E D1             	POP	DE
DF9F 19             	ADD	HL,DE
DFA0 CD BA DF       	CALL	UPSUB		;Color
DFA3 CB E4          	SET	4,H
DFA5 F1             	POP	AF
DFA6 3D             	DEC	A
DFA7 18 E3          	JR	SCRUP1
DFA9                
DFA9                SETDMA:
DFA9 01 87 1F       	LD	BC,01F87H
DFAC                SDMA:
DFAC 04             	INC	B
DFAD ED A3          	OUTI
DFAF 3D             	DEC	A
DFB0 20 FA          	JR	NZ,SDMA
DFB2 C9             	RET
DFB3                
DFB3                SCRDMAD:
DFB3 C3             	DB	0C3H		;WR6 リセット
DFB4 9A             	DB	09AH		;WR5 ストップ WAIT READY:HIGH
DFB5 65             	DB	065H		;WR0 ブロック長(LH)
DFB6 4F 00          	DW	79
DFB8 1C             	DB	01CH		;WR1 ポートAインクリメント I/O
DFB9 18             	DB	018H		;WR0 ポートAアドレス(LH)
DFBA                
DFBA                UPSUB:
DFBA 3A B1 F0       	LD	A,(_WIDTH)
DFBD 5F             	LD	E,A
DFBE 16 00          	LD	D,0
DFC0 3E AD          	LD	A,0ADH		;WR4 連続 ポートB開始アドレス(LH)
DFC2 ED 79          	OUT	(C),A
DFC4 ED 69          	OUT	(C),L		;SOURCE
DFC6 ED 61          	OUT	(C),H
DFC8 19             	ADD	HL,DE
DFC9 3E 1D          	LD	A,01DH		;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
DFCB ED 79          	OUT	(C),A
DFCD ED 69          	OUT	(C),L		;DEST
DFCF ED 61          	OUT	(C),H
DFD1                GO_DMA:
DFD1 3E CF          	LD	A,0CFH
DFD3 ED 79          	OUT	(C),A		;WR6 ロード
DFD5 3E B3          	LD	A,0B3H
DFD7 ED 79          	OUT	(C),A		;WR6 強制RDY
DFD9 ED 49          	OUT	(C),C		;WR6 イネーブル
DFDB C9             	RET
DFDC                
DFDC                SCRCL:
DFDC 44             	LD	B,H
DFDD 4D             	LD	C,L
DFDE 2A B1 F0       	LD	HL,(_WIDTH)
DFE1 CD 46 DE       	CALL	LINECL
DFE4 D1             	POP	DE
DFE5 C1             	POP	BC
DFE6 C9             	RET
DFE7                
DFE7                SCRN:
DFE7 D5             	PUSH	DE
DFE8 ED 58          	IN	E,(C)		;Text
DFEA 3A 18 00       	LD	A,(00018H)
DFED 3C             	INC	A
DFEE 28 1E          	JR	Z,SCRN2
DFF0 CB D8          	SET	3,B
DFF2 ED 50          	IN	D,(C)		;Kanji
DFF4 28 16          	JR	Z,SCRN1
DFF6 AF             	XOR	A
DFF7 C5             	PUSH	BC
DFF8 01 37 30       	LD	BC,03037H	;VRMJIS
DFFB DF             	RST	018H
DFFC 01 52 2F       	LD	BC,02F52H	;JISSFT
DFFF DF             	RST	018H
E000 C1             	POP	BC
E001 ED 78          	IN	A,(C)
E003 CB 98          	RES	3,B
E005 E6 40          	AND	040H
E007 20 05          	JR	NZ,SCRN2
E009 7A             	LD	A,D
E00A D1             	POP	DE
E00B C9             	RET
E00C                SCRN1:
E00C CB 98          	RES	3,B
E00E                SCRN2:
E00E 7B             	LD	A,E
E00F D1             	POP	DE
E010 C9             	RET
E011                SCRNE:
E011                POS:
E011 2A 8E F0       	LD	HL,(_TXADR)
E014 C5             	PUSH	BC
E015 ED 4B BC F0    	LD	BC,(_WIDTH_MINUS)
E019 AF             	XOR	A
E01A                POS1:
E01A 09             	ADD	HL,BC
E01B 3C             	INC	A
E01C 38 FC          	JR	C,POS1
E01E ED 42          	SBC	HL,BC
E020 3D             	DEC	A
E021 67             	LD	H,A
E022 C1             	POP	BC
E023 A7             	AND	A
E024 C9             	RET
E025                
E025                GETL:
E025 CD D3 F0       	CALL	_POS
E028 E5             	PUSH	HL
E029 3E CD          	LD	A,0CDH		;CALL ????
E02B 32 43 DD       	LD	(INSFLG),A
E02E                GETL1:
E02E CD B8 DB       	CALL	_SYS08
E031 FE 09          	CP	9
E033 20 08          	JR	NZ,GETL1V
E035 21 20 FF       	LD	HL,KBUF
E038 CD A4 D8       	CALL	MSX
E03B 18 F1          	JR	GETL1
E03D                GETL1V:
E03D 5F             	LD	E,A
E03E CD CD F0       	CALL	_PRINT
E041                
E041 7B             	LD	A,E
E042 FE 0D          	CP	00DH
E044 20 E8          	JR	NZ,GETL1
E046 3E 01          	LD	A,1		;LD BC,????
E048 32 43 DD       	LD	(INSFLG),A
E04B 11 20 FF       	LD	DE,KBUF
E04E 3A B1 F0       	LD	A,(_WIDTH)
E051 47             	LD	B,A
E052 CD 56 D6       	CALL	ZERO_MEMORY_DE
E055                
E055 D1             	POP	DE
E056 CD D3 F0       	CALL	_POS
E059 6B             	LD	L,E
E05A 3A B1 F0       	LD	A,(_WIDTH)
E05D 95             	SUB	L
E05E 57             	LD	D,A
E05F CD 88 DE       	CALL	LOC1
E062 4D             	LD	C,L
E063 7C             	LD	A,H
E064 F6 30          	OR	030H
E066 47             	LD	B,A
E067 5A             	LD	E,D
E068 21 20 FF       	LD	HL,KBUF
E06B                GETL2:
E06B CD D0 F0       	CALL	_SCRN
E06E 03             	INC	BC
E06F 77             	LD	(HL),A
E070 23             	INC	HL
E071 1D             	DEC	E
E072 20 F7          	JR	NZ,GETL2
E074                GETL3:
E074 2B             	DEC	HL
E075 7E             	LD	A,(HL)
E076 FE 21          	CP	021H
E078 D0             	RET	NC
E079 36 00          	LD	(HL),0
E07B 15             	DEC	D
E07C 20 F6          	JR	NZ,GETL3
E07E C9             	RET
E07F                
E07F                INKEY:
E07F FB             	EI
E080 E5             	PUSH	HL
E081 2A 90 F0       	LD	HL,(_KEYPS)
E084 7C             	LD	A,H
E085 AD             	XOR	L
E086 28 0B          	JR	Z,INKEY1
E088 7C             	LD	A,H
E089 3C             	INC	A
E08A E6 1F          	AND	01FH
E08C 32 91 F0       	LD	(_KEYPS+1),A
E08F 6F             	LD	L,A
E090 26 FF          	LD	H,KEYBF/256
E092 7E             	LD	A,(HL)
E093                INKEY1:
E093 E1             	POP	HL
E094 B7             	OR	A
E095 C9             	RET
E096                
E096 00 00 0E 81    AT_RS	EQU	SCR1-AT_SCR1
E096                	INCLUDE	"LDFILE.ASM"
E096                
E096                ;	LSX-Dodgers FILE
E096                
E096                FILEC:
E096 CD A1 E0       	CALL	FILE
E099                FILEC2:
E099 3A 15 F0       	LD	A,(FDRV+1)
E09C FE 20          	CP	020H
E09E C8             	RET	Z
E09F 18 39          	JR	SETDIR1
E0A1                
E0A1                FILE:
E0A1 AF             	XOR	A
E0A2 32 14 F0       	LD	(FDRV),A
E0A5 67             	LD	H,A
E0A6 6F             	LD	L,A
E0A7 22 22 F0       	LD	(FDRV+14),HL
E0AA CD 78 E1       	CALL	SPCUT
E0AD CD 5D E1       	CALL	CCHK3
E0B0 28 12          	JR	Z,DEVI1
E0B2 13             	INC	DE
E0B3 1A             	LD	A,(DE)
E0B4 1B             	DEC	DE
E0B5 FE 3A          	CP	':'
E0B7 20 0B          	JR	NZ,DEVI1
E0B9 1A             	LD	A,(DE)		;DRIVE
E0BA CD B8 E3       	CALL	CAP
E0BD D6 40          	SUB	'@'
E0BF 13             	INC	DE
E0C0 13             	INC	DE
E0C1 32 14 F0       	LD	(FDRV),A
E0C4                DEVI1:
E0C4 1A             	LD	A,(DE)
E0C5 D6 5C          	SUB	05CH		;\
E0C7 20 09          	JR	NZ,NOROOT
E0C9 6F             	LD	L,A		;A=0でH=0のはずなのでHL=0
E0CA 22 2E F0       	LD	(FDRV+26),HL
E0CD 2C             	INC	L
E0CE 22 22 F0       	LD	(FDRV+14),HL
E0D1 13             	INC	DE
E0D2                NOROOT:
E0D2                
E0D2                SETDIR:
E0D2 CD FE E0       	CALL	FILED
E0D5 1A             	LD	A,(DE)
E0D6 FE 5C          	CP	05CH		;\
E0D8 C0             	RET	NZ
E0D9 13             	INC	DE
E0DA                SETDIR1:
E0DA 3E 10          	LD	A,010H		;Directory
E0DC 32 21 F0       	LD	(FDRV+13),A
E0DF D5             	PUSH	DE
E0E0 11 14 F0       	LD	DE,FDRV
E0E3 2A 1E F1       	LD	HL,(STABLE+2*00FH)
E0E6 CD 0F 00       	CALL	JP_HL
E0E9 D1             	POP	DE
E0EA B7             	OR	A
E0EB C0             	RET	NZ
E0EC                
E0EC 3A 21 F0       	LD	A,(FDRV+13)
E0EF CB 67          	BIT	4,A
E0F1 C8             	RET	Z
E0F2                
E0F2 CD 45 E1       	CALL	FILEI
E0F5 2A 2E F0       	LD	HL,(FDRV+26)
E0F8 23             	INC	HL
E0F9 22 22 F0       	LD	(FDRV+14),HL
E0FC 18 D4          	JR	SETDIR
E0FE                
E0FE                FILED:
E0FE CD 45 E1       	CALL	FILEI
E101 21 15 F0       	LD	HL,FNAME
E104                
E104 06 08          	LD	B,8
E106                FILE2:
E106 CD 52 E1       	CALL	CCHKF
E109 C8             	RET	Z
E10A FE 2A          	CP	'*'
E10C 28 2E          	JR	Z,FILE9
E10E FE 2E          	CP	'.'
E110 28 0C          	JR	Z,FILE4
E112 77             	LD	(HL),A
E113 23             	INC	HL
E114 10 F0          	DJNZ	FILE2
E116                
E116                FILE3:
E116 CD 52 E1       	CALL	CCHKF
E119 C8             	RET	Z
E11A FE 2E          	CP	'.'
E11C 20 F8          	JR	NZ,FILE3
E11E                
E11E                FILE4:
E11E 21 1D F0       	LD	HL,FNAME+8
E121 06 03          	LD	B,3
E123                
E123                FILE4L:
E123 CD 52 E1       	CALL	CCHKF
E126 C8             	RET	Z
E127 FE 2E          	CP	'.'
E129 20 08          	JR	NZ,FILE12
E12B 32 15 F0       	LD	(FNAME),A	;Parent directory(..)
E12E 32 16 F0       	LD	(FNAME+1),A
E131 3E 20          	LD	A,020H
E133                FILE12:
E133 FE 2A          	CP	'*'
E135 28 0A          	JR	Z,FILE10
E137 77             	LD	(HL),A
E138 23             	INC	HL
E139 10 E8          	DJNZ	FILE4L
E13B C9             	RET
E13C                
E13C                FILE9:				;名前の*処理、名前の残りを?で埋める
E13C CD 41 E1       	CALL	FILE10
E13F 18 D5          	JR	FILE3
E141                
E141                FILE10:
E141 3E 3F          	LD	A,'?'
E143 18 08          	JR	FILL_MEMORY
E145                FILEI:				;名前＋拡張子をスペースで初期化
E145 3E 20          	LD	A,020H
E147 01 00 0B       	LD	BC,11*256	;C=0にしておく
E14A 21 15 F0       	LD	HL,FNAME
E14D                FILL_MEMORY:			;HLからBバイトAで埋める
E14D 77             	LD	(HL),A
E14E 23             	INC	HL
E14F 10 FC          	DJNZ	FILL_MEMORY
E151 C9             	RET
E152                
E152                CCHKF:
E152 1A             	LD	A,(DE)
E153 CD 5A E1       	CALL	CCHK2
E156 C8             	RET	Z
E157 C3 C5 E4       	JP	FKAN
E15A                
E15A                CCHK2:
E15A 0C             	INC	C
E15B 0D             	DEC	C
E15C C0             	RET	NZ
E15D                CCHK3:				;ZF=1 で使えない文字
E15D FE 2B          	CP	'+'
E15F C8             	RET	Z
E160 FE 2C          	CP	','
E162 C8             	RET	Z
E163 FE 2F          	CP	'/'
E165 C8             	RET	Z
E166 FE 3A          	CP	':'
E168 C8             	RET	Z
E169 FE 3B          	CP	';'
E16B C8             	RET	Z
E16C FE 3D          	CP	'='
E16E C8             	RET	Z
E16F FE 5C          	CP	05CH	;\
E171 C8             	RET	Z
E172 FE 20          	CP	020H
E174 D0             	RET	NC
E175 BF             	CP	A		;Z=1
E176 C9             	RET
E177                
E177                SS1:
E177 13             	INC	DE
E178                SPCUT:				;スペースをカット
E178 1A             	LD	A,(DE)
E179 FE 20          	CP	020H
E17B 28 FA          	JR	Z,SS1
E17D C9             	RET
E17E                
E17E                SETDRVF:
E17E 11 14 F0       	LD	DE,FDRV
E181                SETDRV0:
E181 CD 8A E1       	CALL	SETDRV
E184 FD E1          	POP	IY
E186 C1             	POP	BC
E187 D1             	POP	DE
E188 E1             	POP	HL
E189 C9             	RET
E18A                
E18A                SETDRV:
E18A E3             	EX	(SP),HL		;HL=RETRN ADDRESS
E18B D5             	PUSH	DE		;PUSH HL/DE/BC/IY
E18C C5             	PUSH	BC
E18D 1A             	LD	A,(DE)
E18E D5             	PUSH	DE
E18F FD E3          	EX	(SP),IY
E191                
E191 CD 98 E1       	CALL	GETDRV
E194 CD D9 F0       	CALL	_CHGDRV
E197                
E197 E9             	JP	(HL)
E198                
E198                GETDRV:
E198 CD AB E1       	CALL	GETDRV1
E19B 32 88 F0       	LD	(_DRV),A
E19E C9             	RET
E19F                
E19F                IS_SAME_DRV_A_DE:
E19F                ;	A と (DE) が同じドライブか調べる
E19F                ;	ZF=1ならば同じドライブ
E19F CD AB E1       	CALL	GETDRV1
E1A2 C5             	PUSH	BC
E1A3 4F             	LD	C,A
E1A4 1A             	LD	A,(DE)
E1A5 CD AB E1       	CALL	GETDRV1
E1A8 A9             	XOR	C
E1A9 C1             	POP	BC
E1AA C9             	RET
E1AB                GETDRV1:
E1AB E6 7F          	AND	07FH
E1AD D6 01          	SUB	001H
E1AF D0             	RET	NC
E1B0 3A 87 F0       	LD	A,(_DVSW)	;Current Drive
E1B3 C9             	RET
E1B4                
E1B4                SOPENX:
E1B4 11 39 F0       	LD	DE,SFILE
E1B7 FD 7E 00       	LD	A,(IY+0)		;(FCB)ドライブ番号
E1BA CD 9F E1       	CALL	IS_SAME_DRV_A_DE
E1BD 20 24          	JR	NZ,SOPEN
E1BF 13             	INC	DE
E1C0 FD E5          	PUSH	IY
E1C2 E1             	POP	HL
E1C3 23             	INC	HL
E1C4 CD 50 E3       	CALL	CPFILE
E1C7 20 1A          	JR	NZ,SOPEN
E1C9                
E1C9 2A F4 F1       	LD	HL,(SCDIR)
E1CC FD 75 0E       	LD	(IY+14),L	;(FCB)アクセスするディレクトリのクラスタ番号+1
E1CF FD 74 0F       	LD	(IY+15),H
E1D2                
E1D2 2A F8 F1       	LD	HL,(SFNDF)	;Direcroty location and Flags
E1D5 22 9F F0       	LD	(_FILEN),HL
E1D8                
E1D8 ED 5B F6 F1    	LD	DE,(SFBPS)
E1DC 21 39 F0       	LD	HL,SFILE
E1DF 36 FF          	LD	(HL),0FFH
E1E1 23             	INC	HL
E1E2 C9             	RET
E1E3                SOPEN:
E1E3 21 F8 E2       	LD	HL,FILESE
E1E6                SOPENC:
E1E6 22 1F E2       	LD	(OPENPAT),HL
E1E9                
E1E9 CD E2 F0       	CALL	_RDFATX		;Detect Media
E1EC 38 56          	JR	C,RDDERR
E1EE                
E1EE AF             	XOR	A
E1EF 32 9F F0       	LD	(_FILEN),A
E1F2 CD F8 E3       	CALL	LDDIRX1		;A=0で呼び出す
E1F5 28 18          	JR	Z,SDIRX1
E1F7                
E1F7 CD E9 E2       	CALL	READ_DIR	;Sub Directory
E1FA 38 08          	JR	C,SDIRX0
E1FC 2A 7E F1       	LD	HL,(_DTBUF)
E1FF 7E             	LD	A,(HL)
E200 FE 2E          	CP	'.'
E202 28 0F          	JR	Z,SOPEN1
E204                SDIRX0:
E204 AF             	XOR	A
E205 32 A0 F0       	LD	(_DIRF),A
E208 FD 36 0E 01    	LD	(IY+14),1	;(FCB)レコードサイズ
E20C FD 77 0F       	LD	(IY+15),A
E20F                SDIRX1:
E20F ED 5B FC F1    	LD	DE,(_DIRPS)	;Root Directory
E213                SOPEN1:
E213 0E 20          	LD	C,32		;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
E215 00 00 E2 14    SDECPAT	EQU	$-1
E215                SOPEN1X:
E215 CD E9 E2       	CALL	READ_DIR	;FILE SEARCH
E218 38 2A          	JR	C,RDDERR
E21A 2A 7E F1       	LD	HL,(_DTBUF)
E21D                SOPEN2:
E21D D5             	PUSH	DE
E21E CD F8 E2       	CALL	FILESE		;(self-modifying code)
E221 00 00 E2 1F    OPENPAT	EQU	$-2
E221 D1             	POP	DE
E222 38 6D          	JR	C,SOPENE
E224 28 1B          	JR	Z,SCF_FF_RET
E226                SOPEN3:
E226 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E229 B7             	OR	A
E22A 20 0C          	JR	NZ,SOPEN5
E22C 13             	INC	DE		;ルートディレクトリ
E22D E5             	PUSH	HL
E22E 21 0C 00       	LD	HL,12		;(self-modifying code)MAXDIR
E231 00 00 E2 2F    MD_PAT	EQU	$-2
E231 ED 52          	SBC	HL,DE		;CF=0 なので SUB HL,DE
E233 E1             	POP	HL
E234 20 DD          	JR	NZ,SOPEN1
E236 18 07          	JR	SOPEN6
E238                SOPEN5:
E238 CD 07 EB       	CALL	GNCLX		;END DIR
E23B D8             	RET	C
E23C CD B0 E3       	CALL	ENDCL
E23F                SOPEN6:
E23F 38 D2          	JR	C,SOPEN1
E241                SCF_FF_RET:
E241 37             	SCF			;CF=1
E242 9F             	SBC	A,A		;A=0FFH
E243 C9             	RET
E244                
E244                RDDERR:
E244 BF             	CP	A		;READ ERR CF=1 ZF=1
E245 37             	SCF
E246 C9             	RET
E247                
E247                NOPEN:
E247 21 F8 E2       	LD	HL,FILESE
E24A 22 1F E2       	LD	(OPENPAT),HL
E24D FD 2A 98 F0    	LD	IY,(_FCB)
E251 CD D8 E4       	CALL	CHKWILDX
E254 30 EB          	JR	NC,SCF_FF_RET
E256 FD 7E 00       	LD	A,(IY+0)
E259 CD 98 E1       	CALL	GETDRV
E25C CD D9 F0       	CALL	_CHGDRV
E25F D8             	RET	C
E260 2A F8 F1       	LD	HL,(SFNDF)	;Direcroty location and Flags
E263 22 9F F0       	LD	(_FILEN),HL
E266                
E266 CD F3 E3       	CALL	LDDIRX
E269 ED 5B 9A F0    	LD	DE,(_FBPS)
E26D CD E9 E2       	CALL	READ_DIR
E270 38 D2          	JR	C,RDDERR
E272 3A 9E F0       	LD	A,(_FBCNT)
E275 3D             	DEC	A
E276 28 AE          	JR	Z,SOPEN3
E278                NOPEN2:
E278 2A 9C F0       	LD	HL,(_FBAD)
E27B 01 20 00       	LD	BC,020H
E27E 09             	ADD	HL,BC
E27F 4F             	LD	C,A
E280 18 9B          	JR	SOPEN2
E282                
E282                SOPENE2:
E282 22 9C F0       	LD	(_FBAD),HL
E285 79             	LD	A,C
E286 32 9E F0       	LD	(_FBCNT),A
E289 ED 53 9A F0    	LD	(_FBPS),DE
E28D FD 22 98 F0    	LD	(_FCB),IY
E291                SOPENE:
E291 AF             	XOR	A
E292 C9             	RET
E293                
E293                COPEN:
E293 FD 36 0D 20    	LD	(IY+13),020H	;(FCB)属性(アトリビュート)
E297                
E297 21 15 E3       	LD	HL,NEXTSE
E29A CD E6 E1       	CALL	SOPENC
E29D D0             	RET	NC
E29E C8             	RET	Z
E29F 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E2A2 B7             	OR	A
E2A3 37             	SCF
E2A4 C8             	RET	Z		;ルートディレクトリ
E2A5 06 01          	LD	B,1
E2A7 CD 37 E5       	CALL	WRDF
E2AA D8             	RET	C
E2AB ED 5B FE F1    	LD	DE,(_CLPS)
E2AF D5             	PUSH	DE
E2B0 CD 79 E3       	CALL	DCPAT
E2B3 CD 92 E9       	CALL	DRDNX
E2B6 2A 7E F1       	LD	HL,(_DTBUF)	;ディレクトリエントリを0クリア
E2B9 3A 9C E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E2BC 47             	LD	B,A
E2BD AF             	XOR	A
E2BE 4F             	LD	C,A
E2BF                COPENCL:
E2BF 77             	LD	(HL),A
E2C0 ED A1          	CPI			;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
E2C2 EA BF E2       	JP	PE,COPENCL
E2C5                
E2C5 3A 97 E3       	LD	A,(SPCPAT)	;1クラスタの論理セクタ数
E2C8 3D             	DEC	A
E2C9 28 19          	JR	Z,COPENE
E2CB 3E 01          	LD	A,1		;1セクタ辺りのセクタ数が2以上の場合
E2CD 32 FF EA       	LD	(_SECPS),A
E2D0 D1             	POP	DE		;DE=(_CLPS)
E2D1 D5             	PUSH	DE
E2D2                COPEN1:
E2D2 D5             	PUSH	DE		;データバッファに入らないセクタもゼロクリア
E2D3 C5             	PUSH	BC
E2D4 2A 7E F1       	LD	HL,(_DTBUF)
E2D7 CD 93 E3       	CALL	CLUSTX
E2DA CD 97 EC       	CALL	DWT24
E2DD C1             	POP	BC
E2DE D1             	POP	DE
E2DF CD FE EA       	CALL	NEXTX
E2E2 20 EE          	JR	NZ,COPEN1
E2E4                COPENE:
E2E4 2A 7E F1       	LD	HL,(_DTBUF)
E2E7 D1             	POP	DE
E2E8 C9             	RET
E2E9                
E2E9                READ_DIR:
E2E9 ED 53 FE F1    	LD	(_CLPS),DE
E2ED C5             	PUSH	BC
E2EE D5             	PUSH	DE
E2EF CD 79 E3       	CALL	DCPAT
E2F2 CD 72 E9       	CALL	DRDX
E2F5 D1             	POP	DE
E2F6 C1             	POP	BC
E2F7 C9             	RET
E2F8                
E2F8                FILESE:
E2F8 7E             	LD	A,(HL)
E2F9 B7             	OR	A
E2FA C8             	RET	Z		;END:ZF=1 CF=0
E2FB FE E5          	CP	0E5H
E2FD 28 0E          	JR	Z,FILESE1
E2FF FD E5          	PUSH	IY
E301 D1             	POP	DE
E302 13             	INC	DE
E303 E5             	PUSH	HL
E304 CD 50 E3       	CALL	CPFILE
E307 CC 71 E3       	CALL	Z,CPFILE2
E30A E1             	POP	HL
E30B 37             	SCF
E30C C8             	RET	Z		;!!!:(ZF=1) CF=1
E30D                FILESE1:
E30D CD 24 E3       	CALL	FNEXT
E310 20 E6          	JR	NZ,FILESE
E312                ZF0_CF0_AFF_RET:
E312 F6 FF          	OR	0FFH		;ZF=0 CF=0
E314 C9             	RET
E315                
E315                NEXTSE:
E315 7E             	LD	A,(HL)
E316 B7             	OR	A
E317 37             	SCF
E318 C8             	RET	Z		;!!!:ZF=1 CF=1
E319 FE E5          	CP	0E5H
E31B 37             	SCF
E31C C8             	RET	Z		;!!!:(ZF=1) CF=1
E31D CD 24 E3       	CALL	FNEXT
E320 20 F3          	JR	NZ,NEXTSE
E322 18 EE          	JR	ZF0_CF0_AFF_RET
E324                
E324                FNEXT:
E324 E5             	PUSH	HL
E325 21 9F F0       	LD	HL,_FILEN
E328 34             	INC	(HL)
E329 E1             	POP	HL
E32A 11 20 00       	LD	DE,020H
E32D 19             	ADD	HL,DE
E32E 0D             	DEC	C
E32F C9             	RET
E330                
E330                CPNAME:
E330 C5             	PUSH	BC
E331 D5             	PUSH	DE
E332 E5             	PUSH	HL
E333 CD 4A E3       	CALL	CPFILE4
E336 E1             	POP	HL
E337 23             	INC	HL
E338 23             	INC	HL
E339 23             	INC	HL
E33A 23             	INC	HL
E33B D1             	POP	DE
E33C C1             	POP	BC
E33D 20 05          	JR	NZ,CPNAME1
E33F 7E             	LD	A,(HL)
E340 23             	INC	HL
E341 66             	LD	H,(HL)
E342 6F             	LD	L,A
E343 C9             	RET
E344                CPNAME1:
E344 23             	INC	HL
E345 23             	INC	HL
E346 10 E8          	DJNZ	CPNAME
E348 37             	SCF
E349 C9             	RET
E34A                
E34A                CPFILE4:
E34A C5             	PUSH	BC
E34B 01 00 04       	LD	BC,00400H
E34E 18 04          	JR	CPSTR1
E350                CPFILE:
E350 C5             	PUSH	BC
E351 01 00 0B       	LD	BC,00B00H
E354                CPSTR1:
E354 1A             	LD	A,(DE)
E355 FE 3F          	CP	'?'		;Wild card
E357 28 12          	JR	Z,CPSTR2
E359 7E             	LD	A,(HL)
E35A CD BE E4       	CALL	FKANC
E35D E5             	PUSH	HL
E35E 67             	LD	H,A
E35F 1A             	LD	A,(DE)
E360 CB 01          	RLC	C
E362 CD BE E4       	CALL	FKANC
E365 CB 09          	RRC	C
E367 BC             	CP	H		;CP (HL),(DE)
E368 E1             	POP	HL
E369 20 04          	JR	NZ,CPSTR3
E36B                CPSTR2:
E36B 13             	INC	DE
E36C 23             	INC	HL
E36D 10 E5          	DJNZ	CPSTR1
E36F                CPSTR3:
E36F C1             	POP	BC
E370 C9             	RET
E371                
E371                CPFILE2:
E371 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E374 F6 E1          	OR	0E1H
E376 2F             	CPL
E377 A6             	AND	(HL)
E378 C9             	RET
E379                
E379                DCPAT:
E379 0E 00          	LD	C,0
E37B 2A 7E F1       	LD	HL,(_DTBUF)
E37E 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E381 B7             	OR	A
E382 C8             	RET	Z		;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
E383 3A 97 E3       	LD	A,(SPCPAT)
E386 4F             	LD	C,A
E387 3A FF EA       	LD	A,(_SECPS)
E38A B9             	CP	C
E38B 38 01          	JR	C,DC1
E38D AF             	XOR	A
E38E                DC1:
E38E F6 80          	OR	080H
E390 32 A0 F0       	LD	(_DIRF),A	;bit0-6:セクタインデックス
E393                CLUSTX:
E393 E5             	PUSH	HL
E394 EB             	EX	DE,HL
E395 AF             	XOR	A
E396 0E 01          	LD	C,1		;自己書き換え（1クラスタの論理セクタ数）
E398 00 00 E3 97    SPCPAT	EQU	$-1
E398                L_CLDBL:
E398 CB 19          	RR	C		;->CF
E39A 38 04          	JR	C,E_CLDBL
E39C 29             	ADD	HL,HL		;*2
E39D 8F             	ADC	A,A
E39E 18 F8          	JR	L_CLDBL
E3A0                E_CLDBL:
E3A0 4F             	LD	C,A
E3A1 3A FF EA       	LD	A,(_SECPS)
E3A4 B5             	OR	L
E3A5 6F             	LD	L,A
E3A6 11 08 00       	LD	DE,8	;+8 (2D)  !ADDCL (self-modifying code)
E3A9 00 00 E3 A7    CLSPAT	EQU	$-2
E3A9 AF             	XOR	A
E3AA 19             	ADD	HL,DE	;データ格納領域の先頭論理セクタ番号
E3AB 89             	ADC	A,C
E3AC 4F             	LD	C,A
E3AD EB             	EX	DE,HL
E3AE E1             	POP	HL
E3AF C9             	RET
E3B0                
E3B0                ENDCL:
E3B0 7A             	LD	A,D	;END CLUSTER
E3B1 FE 01          	CP	1	;164=356	(self-modifying code)
E3B3 00 00 E3 B2    CLPAT1	EQU	$-1
E3B3 C0             	RET	NZ
E3B4 7B             	LD	A,E
E3B5 FE 64          	CP	064H	;		(self-modifying code)
E3B7 00 00 E3 B6    CLPAT2	EQU	$-1
E3B7 C9             	RET
E3B8                
E3B8                CAP:
E3B8 FE 61          	CP	'a'
E3BA D8             	RET	C
E3BB FE 7B          	CP	'z'+1
E3BD D0             	RET	NC
E3BE D6 20          	SUB	020H
E3C0 C9             	RET
E3C1                CAP2:
E3C1 CD B8 E3       	CALL	CAP
E3C4                CAP3:				;
E3C4 FE 05          	CP	5
E3C6 28 03          	JR	Z,CAP4
E3C8 FE 21          	CP	021H
E3CA C9             	RET
E3CB                CAP4:
E3CB 3E E5          	LD	A,0E5H
E3CD C9             	RET
E3CE                
E3CE                CHDIR:
E3CE CD B9 ED       	CALL	GETDPBD
E3D1 38 1D          	JR	C,CHDIR2
E3D3 DD 75 1A       	LD	(IX+DPB_SDIR),L
E3D6 DD 74 1B       	LD	(IX+DPB_SDIR+1),H
E3D9 18 15          	JR	CHDIR2		;POP_IX_RET
E3DB                
E3DB                LDDIR:
E3DB CD B9 ED       	CALL	GETDPBD
E3DE DD 5E 1A       	LD	E,(IX+DPB_SDIR)
E3E1 DD 56 1B       	LD	D,(IX+DPB_SDIR+1)
E3E4 13             	INC	DE
E3E5 FD 73 0E       	LD	(IY+14),E	;(FCB)アクセスするディレクトリのクラスタ番号+1
E3E8 FD 72 0F       	LD	(IY+15),D
E3EB 1B             	DEC	DE
E3EC AF             	XOR	A
E3ED 32 A0 F0       	LD	(_DIRF),A
E3F0                CHDIR2:
E3F0 DD E1          	POP	IX
E3F2 C9             	RET
E3F3                
E3F3                LDDIRX:
E3F3 3A A0 F0       	LD	A,(_DIRF)	;(FCB)アクセスするディレクトリのセクタインデックス
E3F6 E6 7F          	AND	07FH
E3F8                LDDIRX1:
E3F8 32 FF EA       	LD	(_SECPS),A
E3FB FD 5E 0E       	LD	E,(IY+14)	;(FCB)アクセスするディレクトリのクラスタ番号+1
E3FE FD 56 0F       	LD	D,(IY+15)
E401 1B             	DEC	DE
E402 CD B0 E3       	CALL	ENDCL
E405 D4 DB E3       	CALL	NC,LDDIR
E408                LDDIRS:
E408 7A             	LD	A,D
E409 B3             	OR	E
E40A 32 A0 F0       	LD	(_DIRF),A	;ディレクトリか判別
E40D C9             	RET
E40E                
E40E                KILL:
E40E CD D8 E4       	CALL	CHKWILDX
E411 38 34          	JR	C,KILLW
E413 CD B4 E1       	CALL	SOPENX
E416                KILLS:
E416 3E 1F          	LD	A,01FH
E418 D4 5A E4       	CALL	NC,CHKATT
E41B D8             	RET	C
E41C                KILLSX:
E41C 36 E5          	LD	(HL),0E5H	;DIR
E41E CD B2 E4       	CALL	WTDB
E421 11 1A 00       	LD	DE,01AH
E424 19             	ADD	HL,DE
E425 5E             	LD	E,(HL)
E426 23             	INC	HL
E427 56             	LD	D,(HL)
E428                KILLS1:
E428 CD B0 E3       	CALL	ENDCL
E42B D0             	RET	NC		;CF=0
E42C 21 FE FF       	LD	HL,0-2
E42F 19             	ADD	HL,DE
E430 D0             	RET	NC		;DE= 0 or 1
E431 D5             	PUSH	DE
E432 CD F7 F0       	CALL	_GNCL
E435 ED 53 FE F1    	LD	(_CLPS),DE
E439 D1             	POP	DE
E43A 21 00 00       	LD	HL,0
E43D D4 FA F0       	CALL	NC,_SNCL
E440 D8             	RET	C
E441 ED 5B FE F1    	LD	DE,(_CLPS)	;FAT
E445 18 E1          	JR	KILLS1
E447                
E447                KILLW:
E447 CD E3 E1       	CALL	SOPEN
E44A                KILLW1:
E44A 38 0B          	JR	C,KILLW2
E44C CD 82 E2       	CALL	SOPENE2
E44F CD 16 E4       	CALL	KILLS
E452 CD 47 E2       	CALL	NOPEN
E455 18 F3          	JR	KILLW1
E457                KILLW2:
E457 C8             	RET	Z
E458 3F             	CCF
E459 C9             	RET
E45A                
E45A                CHKATT:
E45A E5             	PUSH	HL
E45B 11 0B 00       	LD	DE,00BH
E45E 19             	ADD	HL,DE
E45F A6             	AND	(HL)
E460 E1             	POP	HL
E461 C8             	RET	Z
E462 37             	SCF
E463 C9             	RET
E464                
E464                NAME:
E464 CD D8 E4       	CALL	CHKWILDX
E467 D8             	RET	C
E468 11 04 00       	LD	DE,4
E46B 19             	ADD	HL,DE
E46C 22 81 E4       	LD	(NAMEP),HL
E46F 23             	INC	HL
E470 CD DC E4       	CALL	CHKWILD
E473 D8             	RET	C
E474                
E474 CD B4 E1       	CALL	SOPENX
E477 3E 0F          	LD	A,00FH
E479 D4 5A E4       	CALL	NC,CHKATT
E47C D8             	RET	C
E47D                
E47D FD E5          	PUSH	IY
E47F FD 21 00 00    	LD	IY,0		;自己書き換え
E483 00 00 E4 81    NAMEP	EQU	$-2
E483 CD B4 E1       	CALL	SOPENX
E486 FD E3          	EX	(SP),IY
E488 3F             	CCF
E489 D4 E3 E1       	CALL	NC,SOPEN
E48C EB             	EX	DE,HL
E48D E1             	POP	HL
E48E D8             	RET	C
E48F                
E48F                SETNAME:
E48F 01 00 0B       	LD	BC,11*256
E492 23             	INC	HL
E493 7E             	LD	A,(HL)
E494 FE E5          	CP	0E5H
E496 20 04          	JR	NZ,SNAME1
E498 3E 05          	LD	A,5
E49A 18 0E          	JR	SNAME3
E49C                SNAME1:
E49C 7E             	LD	A,(HL)
E49D 0C             	INC	C
E49E 0D             	DEC	C
E49F 20 09          	JR	NZ,SNAME3
E4A1 CD B8 E3       	CALL	CAP
E4A4 FE A0          	CP	0A0H
E4A6 20 02          	JR	NZ,SNAME3
E4A8 3E 20          	LD	A,020H
E4AA                SNAME3:
E4AA 12             	LD	(DE),A
E4AB 7E             	LD	A,(HL)
E4AC 23             	INC	HL
E4AD CD C5 E4       	CALL	FKAN
E4B0 10 EA          	DJNZ	SNAME1
E4B2                WTDB:
E4B2 3E FF          	LD	A,0FFH
E4B4 32 39 F0       	LD	(SFILE),A
E4B7                SWTDBF:
E4B7 3E 01          	LD	A,1
E4B9 32 A4 F0       	LD	(_WTDBF),A
E4BC AF             	XOR	A
E4BD C9             	RET
E4BE                
E4BE                FKANC:
E4BE CB 41          	BIT	0,C
E4C0 CC C1 E3       	CALL	Z,CAP2
E4C3 18 01          	JR	FKANX
E4C5                FKAN:			;漢字チェック
E4C5 13             	INC	DE
E4C6                FKANX:
E4C6 CB 41          	BIT	0,C
E4C8 CB 81          	RES	0,C
E4CA C0             	RET	NZ
E4CB FE 80          	CP	080H
E4CD D8             	RET	C
E4CE FE A0          	CP	0A0H
E4D0 38 03          	JR	C,FKAN1
E4D2 FE E0          	CP	0E0H
E4D4 D8             	RET	C
E4D5                FKAN1:
E4D5 0C             	INC	C
E4D6 A7             	AND	A
E4D7 C9             	RET
E4D8                
E4D8                CHKWILDX:
E4D8 FD E5          	PUSH	IY
E4DA E1             	POP	HL
E4DB 23             	INC	HL
E4DC                CHKWILD:
E4DC 06 0B          	LD	B,11
E4DE 3E 3F          	LD	A,'?'
E4E0                CHKWIL1:
E4E0 BE             	CP	(HL)
E4E1 23             	INC	HL
E4E2 37             	SCF
E4E3 C8             	RET	Z
E4E4 10 FA          	DJNZ	CHKWIL1
E4E6 AF             	XOR	A
E4E7 C9             	RET
E4E8                
E4E8                SDIRENT:		;IY=FCB HL=DIR
E4E8 D5             	PUSH	DE
E4E9 E5             	PUSH	HL
E4EA FD E5          	PUSH	IY
E4EC D1             	POP	DE
E4ED EB             	EX	DE,HL
E4EE CD 8F E4       	CALL	SETNAME
E4F1                ;				Attribute
E4F1 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E4F4 12             	LD	(DE),A
E4F5 13             	INC	DE
E4F6                ;				Reserved
E4F6 AF             	XOR	A
E4F7 06 0A          	LD	B,10
E4F9                SDE1:
E4F9 12             	LD	(DE),A
E4FA 13             	INC	DE
E4FB 10 FC          	DJNZ	SDE1
E4FD                					;(FCB)更新時刻
E4FD 21 E4 F1       	LD	HL,SDDATA		;(FCB)更新年月日
E500 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
E502                SDLOOP:					;(FCB)ファイルのサイズ(バイト単位)
E502 7E             	LD	A,(HL)
E503 23             	INC	HL
E504 32 09 E5       	LD	(SDPAT),A
E507 FD 7E 00       	LD	A,(IY+0)	;LD A,(IY+A)
E50A 00 00 E5 09    SDPAT	EQU	$-1
E50A 12             	LD	(DE),A
E50B 13             	INC	DE
E50C 10 F4          	DJNZ	SDLOOP
E50E                
E50E AF             	XOR	A
E50F E1             	POP	HL
E510 D1             	POP	DE
E511 C9             	RET
E512                
E512                WOPEN:
E512 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E515 E6 1F          	AND	01FH
E517 37             	SCF
E518 C0             	RET	NZ
E519 FD 36 1C FE    	LD	(IY+28),0FEH	;(FCB)オープンモード
E51D                TOPEN2:
E51D AF             	XOR	A
E51E                TOPEN:				;Initializes the time stamp
E51E FD 36 17 FF    	LD	(IY+23),0FFH	;(FCB)更新時刻
E522 C9             	RET
E523                
E523                WRDFX:
E523 3A 97 E3       	LD	A,(SPCPAT)	;1クラスタの論理セクタ
E526                L_WRFX:
E526 1F             	RRA			;->CF
E527 38 06          	JR	C,E_WRFX
E529 CB 39          	SRL	C
E52B CB 1C          	RR	H		;CH=CH/2
E52D 18 F7          	JR	L_WRFX
E52F                E_WRFX:
E52F 41             	LD	B,C
E530 4C             	LD	C,H
E531 03             	INC	BC
E532 3E 37          	LD	A,037H		;SCF
E534 32 8F E9       	LD	(DRDN1),A
E537                
E537                WRDF:				;BCクラスタ分FATを確保する
E537 11 02 00       	LD	DE,2
E53A AF             	XOR	A
E53B 32 FF EA       	LD	(_SECPS),A
E53E                WRDF1:
E53E C5             	PUSH	BC
E53F D5             	PUSH	DE
E540 CD F7 F0       	CALL	_GNCL
E543 38 1C          	JR	C,WRDF3
E545 7A             	LD	A,D		;空いているかチェック
E546 B3             	OR	E
E547 20 2A          	JR	NZ,WRDF4
E549 E1             	POP	HL		;HL=空いているクラスタ
E54A E5             	PUSH	HL
E54B ED 5B FE F1    	LD	DE,(_CLPS)	;DE=元の(_CLPS)
E54F 22 FE F1       	LD	(_CLPS),HL
E552 7A             	LD	A,D		;元の(_CLPS)が 0 か?
E553 B3             	OR	E
E554 20 08          	JR	NZ,WRDF2
E556 FD 75 1A       	LD	(IY+26),L	;(FCB)ファイルの先頭クラスタ
E559 FD 74 1B       	LD	(IY+27),H	;元が空の場合はFCBにクラスタをセットする
E55C 18 03          	JR	WRDF3
E55E                WRDF2:
E55E CD FA F0       	CALL	_SNCL
E561                WRDF3:
E561 D1             	POP	DE
E562 C1             	POP	BC
E563 D8             	RET	C
E564 0B             	DEC	BC
E565 78             	LD	A,B
E566 B1             	OR	C
E567 20 0C          	JR	NZ,WRDF5	;ここでループカウンタチェック
E569 ED 5B FE F1    	LD	DE,(_CLPS)
E56D 21 FF FF       	LD	HL,0FFFFH	;FATエントリ終了(EOCマーク)
E570 C3 FA F0       	JP	_SNCL
E573                
E573                WRDF4:				;DEクラスタが空じゃないので次に移動する
E573 D1             	POP	DE
E574 C1             	POP	BC
E575                WRDF5:
E575 13             	INC	DE
E576 CD B0 E3       	CALL	ENDCL
E579 38 C3          	JR	C,WRDF1
E57B 37             	SCF
E57C C9             	RET
E57D                
E57D                RWXR:
E57D 3A 9C E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E580                L_RWX:
E580 1F             	RRA		;->CF
E581 38 08          	JR	C,E_RWX
E583 CB 38          	SRL	B	;BCH=BCH/2
E585 CB 19          	RR	C	;
E587 CB 1C          	RR	H	;
E589 18 F5          	JR	L_RWX
E58B                E_RWX:
E58B FD 5E 1A       	LD	E,(IY+26)	;(FCB)ファイルの先頭クラスタ
E58E FD 56 1B       	LD	D,(IY+27)
E591 AF             	XOR	A
E592 32 FF EA       	LD	(_SECPS),A
E595                RWX1:
E595 ED 53 FE F1    	LD	(_CLPS),DE
E599 7A             	LD	A,D
E59A B3             	OR	E
E59B 28 13          	JR	Z,SCF_RET	;RET DE==0 => CF=1
E59D                
E59D 78             	LD	A,B
E59E B1             	OR	C
E59F B4             	OR	H
E5A0 C8             	RET	Z		;RET BCH==0 => CF=0
E5A1                
E5A1 CD 07 EB       	CALL	GNCLX
E5A4 D8             	RET	C
E5A5 7C             	LD	A,H		;
E5A6 25             	DEC	H		;
E5A7 B7             	OR	A		;DEC BCH
E5A8 20 01          	JR	NZ,RWX2		;
E5AA 0B             	DEC	BC		;
E5AB                RWX2:
E5AB CD B0 E3       	CALL	ENDCL
E5AE 38 E5          	JR	C,RWX1
E5B0                SCF_RET:
E5B0 37             	SCF
E5B1 C9             	RET
E5B2                
E5B2                DSKF:
E5B2 11 00 00       	LD	DE,0
E5B5 00 00 E5 B3    MAXCLP	EQU	$-2
E5B5 2A AC F0       	LD	HL,(_FAKEFREE)
E5B8 7C             	LD	A,H
E5B9 B5             	OR	L
E5BA 28 03          	JR	Z,DSKF1
E5BC 11 01 00       	LD	DE,1
E5BF                DSKF1:
E5BF D5             	PUSH	DE
E5C0 CD F7 F0       	CALL	_GNCL
E5C3 38 0C          	JR	C,POPSCF
E5C5 7A             	LD	A,D
E5C6 B3             	OR	E
E5C7 20 01          	JR	NZ,DSKF2
E5C9 23             	INC	HL
E5CA                DSKF2:
E5CA D1             	POP	DE
E5CB 1B             	DEC	DE
E5CC 7A             	LD	A,D
E5CD B3             	OR	E
E5CE 20 EF          	JR	NZ,DSKF1
E5D0 C9             	RET
E5D1                
E5D1                POPSCF:
E5D1 F1             	POP	AF
E5D2 37             	SCF
E5D3 C9             	RET
E5D4                
E5D4                SETTMS:
E5D4 FD 7E 17       	LD	A,(IY+23)	;(FCB)ファイルを最後に変更した時刻
E5D7 3C             	INC	A
E5D8 C0             	RET	NZ		;ファイルが更新されていない
E5D9                SETTMSX:			;FCBに日付時刻をセットする
E5D9 CD 88 DC       	CALL	_SYS2C		;(BDOS)時刻の獲得
E5DC                				;H←時  L←分  D←秒
E5DC CB 25          	SLA	L		;   *2
E5DE CB 25          	SLA	L		;   *4
E5E0 29             	ADD	HL,HL		;*2 *8
E5E1 29             	ADD	HL,HL		;*4 *16
E5E2 29             	ADD	HL,HL		;*8 *32
E5E3 7A             	LD	A,D
E5E4 0F             	RRCA			;bit.0->7->->->0->C
E5E5 E6 1F          	AND	01FH
E5E7 B5             	OR	L
E5E8 FD 77 16       	LD	(IY+22),A	;(FCB)ファイルを最後に変更した時刻
E5EB FD 74 17       	LD	(IY+23),H
E5EE                
E5EE CD 65 DC       	CALL	_SYS2A		;(BDOS)日付の獲得
E5F1                				;HL←年  D←月  E←日
E5F1 01 44 F8       	LD	BC,0-1980
E5F4 09             	ADD	HL,BC
E5F5 65             	LD	H,L
E5F6                
E5F6 7A             	LD	A,D
E5F7 87             	ADD	A,A		;*2
E5F8 87             	ADD	A,A		;*4
E5F9 87             	ADD	A,A		;*8
E5FA 87             	ADD	A,A		;*16
E5FB 6F             	LD	L,A
E5FC 29             	ADD	HL,HL		;*32
E5FD 7D             	LD	A,L
E5FE B3             	OR	E
E5FF FD 77 14       	LD	(IY+20),A	;(FCB)ファイルを最後に変更した日付
E602 FD 74 15       	LD	(IY+21),H
E605 C9             	RET
E606                
E606                PUSHRR:
E606 32 9E E6       	LD	(SETSEQ_SWC_RND),A
E609 22 B0 E6       	LD	(SETSEQ_SWC_SEQ_RR),HL
E60C CD 2C E6       	CALL	GET_RR_AHL
E60F 22 0F F0       	LD	(RR_BUF_HL),HL
E612 32 11 F0       	LD	(RR_BUF_A),A
E615 C9             	RET
E616                
E616                GET_CPM_R_SIZE:		;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
E616 87             	ADD	A,A		;in BHLA => out AHL
E617 ED 6A          	ADC	HL,HL
E619 CB 18          	RR	B
E61B B7             	OR	A
E61C 78             	LD	A,B		;ここでフラグは変化しない
E61D C8             	RET	Z
E61E 2C             	INC	L		;INC AHL
E61F C0             	RET	NZ		;
E620 24             	INC	H		;
E621 C0             	RET	NZ		;
E622 3C             	INC	A		;
E623 C9             	RET
E624                
E624                INIT_RND:
E624 3E CD          	LD	A,0CDH		;CALL ????
E626 21 73 E6       	LD	HL,POPRR
E629 CD 06 E6       	CALL	PUSHRR
E62C                GET_RR_AHL:
E62C FD 6E 21       	LD	L,(IY+33)	;(FCB)Random record
E62F FD 66 22       	LD	H,(IY+34)	;
E632 FD 7E 23       	LD	A,(IY+35)	;
E635 C9             	RET
E636                SET_RR_AHL:
E636 FD 75 21       	LD	(IY+33),L	;(FCB)Random record
E639 FD 74 22       	LD	(IY+34),H
E63C FD 77 23       	LD	(IY+35),A
E63F C9             	RET
E640                INIT_SEQ:
E640 3E 01          	LD	A,1		;LD BC,????
E642 21 70 E6       	LD	HL,SETSEQ
E645 CD 06 E6       	CALL	PUSHRR
E648                GETSEQ:
E648 FD 6E 20       	LD	L,(IY+32)	;(FCB)カレントレコード
E64B FD 66 0C       	LD	H,(IY+12)	;(FCB)カレントブロック
E64E AF             	XOR	A
E64F                
E64F CB 25          	SLA	L	;L=L*2
E651                
E651 CB 3C          	SRL	H	;HL=HL/2
E653 CB 1D          	RR	L	;
E655 C9             	RET
E656                
E656                SETSEQ1:
E656 F5             	PUSH	AF
E657 E5             	PUSH	HL		;AHL=Random record
E658 CD 2C E6       	CALL	GET_RR_AHL
E65B 47             	LD	B,A		;AHL→HLA
E65C 7D             	LD	A,L		;(IY+33)(FCB)ランダムレコード
E65D 6C             	LD	L,H		;(IY+34)
E65E 60             	LD	H,B		;(IY+35)
E65F 06 00          	LD	B,0
E661                
E661 CD 16 E6       	CALL	GET_CPM_R_SIZE
E664                
E664 29             	ADD	HL,HL
E665 CB 3D          	SRL	L		;L=L/2
E667 FD 75 20       	LD	(IY+32),L	;(FCB)カレントレコード
E66A FD 74 0C       	LD	(IY+12),H	;(FCB)カレントブロック
E66D E1             	POP	HL
E66E F1             	POP	AF
E66F C9             	RET
E670                SETSEQ:
E670 CD 56 E6       	CALL	SETSEQ1
E673                POPRR:
E673 F5             	PUSH	AF
E674 E5             	PUSH	HL
E675 2A 0F F0       	LD	HL,(RR_BUF_HL)
E678 3A 11 F0       	LD	A,(RR_BUF_A)
E67B CD 36 E6       	CALL	SET_RR_AHL
E67E E1             	POP	HL
E67F F1             	POP	AF
E680 C9             	RET
E681                
E681                RB_WRITE:
E681 C5             	PUSH	BC
E682 ED 4B 4C F1    	LD	BC,(STABLE+2*026H)	;(BDOS)ランダムブロック書き込み
E686 18 05          	JR	RBRW
E688                RB_READ:
E688 C5             	PUSH	BC
E689 ED 4B 4E F1    	LD	BC,(STABLE+2*027H)	;(BDOS)ランダムブロック読み込み
E68D                RBRW:
E68D 1F             	RRA		;AHL = AHL*128
E68E 7C             	LD	A,H	;AHL = AHL0/2
E68F 1F             	RRA		;A
E690 65             	LD	H,L	;
E691 CB 1C          	RR	H	;H
E693 2E 00          	LD	L,0	;
E695 CB 1D          	RR	L	;L
E697 CD 36 E6       	CALL	SET_RR_AHL
E69A 21 80 00       	LD	HL,128
E69D C5             	PUSH	BC
E69E                SETSEQ_SWC_RND:
E69E CD 56 E6       	CALL	SETSEQ1
E6A1 C1             	POP	BC
E6A2 FD CB 20 FE    	SET	7,(IY+32)	;(FCB)カレントレコード
E6A6 FD E5          	PUSH	IY
E6A8 D1             	POP	DE
E6A9 D5             	PUSH	DE
E6AA CD B8 E6       	CALL	JP_BC
E6AD FD E1          	POP	IY
E6AF CD 70 E6       	CALL	SETSEQ
E6B2 00 00 E6 B0    SETSEQ_SWC_SEQ_RR	EQU $-2
E6B2 FD CB 20 BE    	RES	7,(IY+32)	;(FCB)カレントレコード
E6B6                
E6B6 C1             	POP	BC
E6B7 C9             	RET
E6B8                JP_BC:
E6B8 C5             	PUSH	BC
E6B9 C9             	RET
E6BA                
E6BA 00 00 E2 41    _SYS03	EQU	SCF_FF_RET	;(BDOS)外部入力
E6BA 00 00 E2 41    _SYS2B	EQU	SCF_FF_RET	;(BDOS)日付の設定
E6BA 00 00 E2 41    _SYS2D	EQU	SCF_FF_RET	;(BDOS)時刻の設定
E6BA 00 00 E2 41    _SYS39	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの作成
E6BA 00 00 E2 41    _SYS3A	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの削除
E6BA                
E6BA                	INCLUDE	"LDFILE2.ASM"
E6BA                
E6BA                ;	LSX-Dodgers FILE2
E6BA                
E6BA                				;Write random block
E6BA                _SYS26:		;(BDOS)ランダムブロック書き込み
E6BA AF             	XOR	A
E6BB 32 8F E9       	LD	(DRDN1),A	;NOP
E6BE 22 DF E8       	LD	(RBSIZE),HL	;HL←書き込むレコード数
E6C1 22 5D F0       	LD	(LEFTX),HL
E6C4 CD 8A E1       	CALL	SETDRV
E6C7                
E6C7 CD 37 E8       	CALL	RBX0
E6CA DA 57 E7       	JP	C,RBWERR
E6CD CD 12 E5       	CALL	WOPEN
E6D0 DA 57 E7       	JP	C,RBWERR
E6D3 7C             	LD	A,H
E6D4 B5             	OR	L
E6D5 CA 50 E7       	JP	Z,RBW1
E6D8                
E6D8 2B             	DEC	HL
E6D9                
E6D9 CD F5 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E6DC                
E6DC 19             	ADD	HL,DE		;BCHL=HL+BCDE
E6DD 30 01          	JR	NC,S26X1	;
E6DF 03             	INC	BC		;
E6E0                S26X1:
E6E0 CD 7D E5       	CALL	RWXR
E6E3 DC 23 E5       	CALL	C,WRDFX
E6E6 DA 57 E7       	JP	C,RBWERR
E6E9                
E6E9 CD 66 E8       	CALL	RBX2
E6EC 28 1A          	JR	Z,RBWB		;NZ=セクタ以下の端数がある
E6EE CD 85 E8       	CALL	RBXA
E6F1 38 64          	JR	C,RBWERR
E6F3 EB             	EX	DE,HL
E6F4 C5             	PUSH	BC
E6F5 ED B0          	LDIR
E6F7 22 5F F0       	LD	(DTAX),HL
E6FA                
E6FA CD B7 E4       	CALL	SWTDBF		;バッファデータは更新された
E6FD                
E6FD 2A 5D F0       	LD	HL,(LEFTX)
E700 D1             	POP	DE
E701 ED 52          	SBC	HL,DE
E703 22 5D F0       	LD	(LEFTX),HL
E706 28 31          	JR	Z,RBWEND
E708                
E708                RBWB:
E708 CD BA E8       	CALL	RBXB
E70B 28 14          	JR	Z,RBWC
E70D                RBWB1:
E70D C5             	PUSH	BC
E70E D5             	PUSH	DE
E70F CD 93 E3       	CALL	CLUSTX
E712 CD 09 E9       	CALL	DWTC
E715 D1             	POP	DE
E716 C1             	POP	BC
E717 D4 07 EB       	CALL	NC,GNCLX
E71A 38 3B          	JR	C,RBWERR
E71C 10 EF          	DJNZ	RBWB1
E71E CD 59 E9       	CALL	DRW_FLUSH
E721                RBWC:
E721 CD D2 E8       	CALL	RBXC
E724 28 13          	JR	Z,RBWEND
E726 C5             	PUSH	BC
E727 CD 93 E3       	CALL	CLUSTX
E72A CD 8E E9       	CALL	DRDN
E72D C1             	POP	BC
E72E 38 27          	JR	C,RBWERR
E730 ED 5B 7E F1    	LD	DE,(_DTBUF)
E734 ED B0          	LDIR
E736 CD B7 E4       	CALL	SWTDBF		;バッファデータは更新された
E739                RBWEND:
E739 CD DE E8       	CALL	RBXEND
E73C                
E73C CD 46 E8       	CALL	RBX1
E73F 30 0F          	JR	NC,RBW1		;ランダムレコードの方が大きい場合はサイズを合わせる
E741 CD F5 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E744 FD 73 10       	LD	(IY+16),E	;ファイルのサイズ(バイト単位)
E747 FD 72 11       	LD	(IY+17),D	;
E74A FD 71 12       	LD	(IY+18),C	;
E74D FD 70 13       	LD	(IY+19),B	;
E750                RBW1:
E750 FD E1          	POP	IY
E752 C1             	POP	BC
E753 D1             	POP	DE
E754 E1             	POP	HL
E755                DD_NUL:
E755 AF             	XOR	A
E756                DRDF0:
E756                DWTF0:
E756 C9             	RET
E757                
E757                RBWERR:
E757 FD E5          	PUSH	IY
E759 D1             	POP	DE
E75A 2A 20 F1       	LD	HL,(STABLE+2*010H)
E75D CD 0F 00       	CALL	JP_HL
E760                RBRERR1:
E760 3E 01          	LD	A,001H
E762                RBRERR2:
E762 FD E1          	POP	IY
E764 C1             	POP	BC
E765 D1             	POP	DE
E766 E1             	POP	HL
E767 37             	SCF
E768 21 00 00       	LD	HL,0
E76B C9             	RET
E76C                
E76C                RBRERR:
E76C 3E FF          	LD	A,0FFH
E76E 18 F2          	JR	RBRERR2
E770                
E770                RBRFL:
E770 3E 00          RBRFLP:	LD	A,000H
E772 FE 0D          	CP	00DH
E774 20 05          	JR	NZ,RBRFL1
E776 D5             	PUSH	DE
E777 1E 0A          	LD	E,00AH
E779 18 05          	JR	RBRFL2
E77B                RBRFL1:
E77B D5             	PUSH	DE
E77C CD 09 F0       	CALL	_SYS07
E77F 5F             	LD	E,A
E780                RBRFL2:
E780 CD CD F0       	CALL	_PRINT
E783 7B             	LD	A,E
E784 D1             	POP	DE
E785 32 71 E7       	LD	(RBRFLP+1),A
E788 C9             	RET
E789                DDX:
E789 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
E78C CD B8 E3       	CALL	CAP
E78F FE 41          	CP	'A'
E791 C9             	RET
E792                
E792                				;Read random block
E792                _SYS27:		;(BDOS)ランダムブロック読み込み
E792 22 5D F0       	LD	(LEFTX),HL
E795 CD 8A E1       	CALL	SETDRV
E798                
E798 FD CB 0D 66    	BIT	4,(IY+13)	;(FCB)属性(アトリビュート)
E79C C2 25 E8       	JP	NZ,RBRDIR	;ディレクトリ
E79F CD 37 E8       	CALL	RBX0
E7A2 DA 6C E7       	JP	C,RBRERR
E7A5 CD 46 E8       	CALL	RBX1
E7A8 D4 5E E8       	CALL	NC,RBX1R
E7AB DA 60 E7       	JP	C,RBRERR1
E7AE EB             	EX	DE,HL
E7AF ED 52          	SBC	HL,DE		;CP 00HL,BCDE
E7B1 19             	ADD	HL,DE
E7B2 79             	LD	A,C
E7B3 DE 00          	SBC	A,0
E7B5 78             	LD	A,B
E7B6 DE 00          	SBC	A,0
E7B8 38 01          	JR	C,RBR1
E7BA EB             	EX	DE,HL
E7BB                RBR1:
E7BB 9F             	SBC	A,A
E7BC E6 01          	AND	1
E7BE 32 23 E8       	LD	(RBRAP+1),A
E7C1                
E7C1 7C             	LD	A,H
E7C2 B5             	OR	L
E7C3 28 57          	JR	Z,RBREND0
E7C5                
E7C5 22 DF E8       	LD	(RBSIZE),HL	;HL←読み込むレコード数
E7C8 22 5D F0       	LD	(LEFTX),HL
E7CB                
E7CB CD 66 E8       	CALL	RBX2
E7CE 28 19          	JR	Z,RBRB
E7D0 CD 85 E8       	CALL	RBXA
E7D3 DA 6C E7       	JP	C,RBRERR
E7D6 C5             	PUSH	BC
E7D7 ED B0          	LDIR
E7D9 ED 53 5F F0    	LD	(DTAX),DE
E7DD 2A 5D F0       	LD	HL,(LEFTX)
E7E0 D1             	POP	DE
E7E1 A7             	AND	A
E7E2 ED 52          	SBC	HL,DE
E7E4 22 5D F0       	LD	(LEFTX),HL
E7E7 28 30          	JR	Z,RBREND
E7E9                
E7E9                RBRB:
E7E9 CD BA E8       	CALL	RBXB
E7EC 28 15          	JR	Z,RBRC
E7EE                RBRB1:
E7EE C5             	PUSH	BC
E7EF D5             	PUSH	DE
E7F0 CD 93 E3       	CALL	CLUSTX
E7F3 CD 0F E9       	CALL	DRDC
E7F6 D1             	POP	DE
E7F7 C1             	POP	BC
E7F8 D4 07 EB       	CALL	NC,GNCLX
E7FB DA 6C E7       	JP	C,RBRERR
E7FE 10 EE          	DJNZ	RBRB1
E800 CD 59 E9       	CALL	DRW_FLUSH
E803                RBRC:
E803 CD D2 E8       	CALL	RBXC
E806 28 11          	JR	Z,RBREND
E808 C5             	PUSH	BC
E809 CD 93 E3       	CALL	CLUSTX
E80C CD 72 E9       	CALL	DRDX
E80F C1             	POP	BC
E810 DA 6C E7       	JP	C,RBRERR
E813 EB             	EX	DE,HL
E814 2A 7E F1       	LD	HL,(_DTBUF)
E817 ED B0          	LDIR
E819                RBREND:
E819 CD DE E8       	CALL	RBXEND
E81C                RBREND0:
E81C FD E1          	POP	IY
E81E C1             	POP	BC
E81F D1             	POP	DE
E820 F1             	POP	AF	;(HL)
E821 AF             	XOR	A
E822 3E 00          RBRAP:	LD	A,000H
E824 C9             	RET
E825                
E825                RBRDIR:
E825 FD 6E 1A       	LD	L,(IY+26)	;(FCB)ファイルの先頭クラスタ
E828 FD 66 1B       	LD	H,(IY+27)
E82B CD CE E3       	CALL	CHDIR
E82E AF             	XOR	A
E82F 67             	LD	H,A
E830 6F             	LD	L,A
E831 3C             	INC	A
E832 32 23 E8       	LD	(RBRAP+1),A
E835 18 E5          	JR	RBREND0
E837                
E837                RBX0:
E837 2A 8A F0       	LD	HL,(_DTA)
E83A 22 5F F0       	LD	(DTAX),HL
E83D 2A 5D F0       	LD	HL,(LEFTX)
E840 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
E843 D6 FD          	SUB	0FDH
E845 C9             	RET
E846                
E846                RBX1:				;ファイルサイズとランダムレコードを比べる
E846 E5             	PUSH	HL		;Record byte
E847                				;AHL=File size
E847 FD 6E 10       	LD	L,(IY+16)	;ファイルのサイズ(バイト単位)
E84A FD 66 11       	LD	H,(IY+17)	;
E84D FD 7E 12       	LD	A,(IY+18)	;
E850                
E850 CD F5 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E853                
E853 A7             	AND	A
E854 ED 52          	SBC	HL,DE
E856 99             	SBC	A,C
E857 4F             	LD	C,A
E858 FD 7E 13       	LD	A,(IY+19)	;ファイルのサイズ
E85B 98             	SBC	A,B
E85C D1             	POP	DE
E85D C9             	RET
E85E                RBX1R:
E85E 47             	LD	B,A
E85F B1             	OR	C
E860 EB             	EX	DE,HL	;BCDE=File byte	HL=Record byte
E861 B2             	OR	D
E862 B3             	OR	E
E863 C0             	RET	NZ
E864 37             	SCF
E865 C9             	RET
E866                
E866                RBX2:				;Cluster settings
E866 FD 66 22       	LD	H,(IY+34)	;(+33)(FCB)ランダムレコード
E869 FD 4E 23       	LD	C,(IY+35)
E86C 06 00          	LD	B,0
E86E FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E872 20 03          	JR	NZ,RBX3
E874 FD 46 24       	LD	B,(IY+36)
E877                RBX3:
E877 CD 7D E5       	CALL	RWXR
E87A 3A 9C E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E87D 3D             	DEC	A
E87E FD A6 22       	AND	(IY+34)
E881 FD B6 21       	OR	(IY+33)
E884 C9             	RET
E885                
E885                RBXA:
E885 C5             	PUSH	BC
E886 D5             	PUSH	DE
E887 CD 93 E3       	CALL	CLUSTX
E88A CD 72 E9       	CALL	DRDX
E88D D1             	POP	DE
E88E C1             	POP	BC
E88F D4 07 EB       	CALL	NC,GNCLX
E892 D8             	RET	C
E893 ED 53 FE F1    	LD	(_CLPS),DE
E897                
E897 FD 4E 21       	LD	C,(IY+33)	;(FCB)ランダムレコード
E89A 21 00 04       SECSZ:	LD	HL,0400H	;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
E89D 7C             	LD	A,H
E89E 3D             	DEC	A		;1024=3 / 512=1
E89F FD A6 22       	AND	(IY+34)		;(FCB)ランダムレコード
E8A2 47             	LD	B,A		;BCに1セクタ以下の端数が入る
E8A3 ED 42          	SBC	HL,BC		;残りを計算
E8A5                
E8A5 ED 5B 5D F0    	LD	DE,(LEFTX)
E8A9 ED 52          	SBC	HL,DE		;CP HL,DE
E8AB 19             	ADD	HL,DE		;
E8AC 38 01          	JR	C,RBXA1		;DEとHLを比較して大きい方をHLに
E8AE EB             	EX	DE,HL
E8AF                RBXA1:
E8AF E5             	PUSH	HL
E8B0 2A 7E F1       	LD	HL,(_DTBUF)
E8B3 09             	ADD	HL,BC
E8B4 ED 5B 5F F0    	LD	DE,(DTAX)
E8B8 C1             	POP	BC
E8B9 C9             	RET
E8BA                
E8BA                RBXB:
E8BA 2A 5F F0       	LD	HL,(DTAX)
E8BD ED 5B FE F1    	LD	DE,(_CLPS)
E8C1 3A 5E F0       	LD	A,(LEFTX+1)
E8C4 47             	LD	B,A
E8C5 3A 9C E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8C8                RBXB1:
E8C8 1F             	RRA		;->CF
E8C9 38 04          	JR	C,RBXB2
E8CB CB 38          	SRL	B	;B=B/2
E8CD 18 F9          	JR	RBXB1
E8CF                RBXB2:
E8CF 78             	LD	A,B
E8D0 B7             	OR	A
E8D1 C9             	RET
E8D2                
E8D2                RBXC:
E8D2 ED 4B 5D F0    	LD	BC,(LEFTX)
E8D6 3A 9C E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8D9 3D             	DEC	A
E8DA A0             	AND	B
E8DB 47             	LD	B,A		;1セクタ以下の端数がない場合はZ
E8DC B1             	OR	C
E8DD C9             	RET
E8DE                
E8DE                RBXEND:				;レコード数だけランダムレコードを進める
E8DE 11 00 00       	LD	DE,0		;進めるレコード数(RBSIZE)
E8E1 00 00 E8 DF    RBSIZE	EQU	$-2
E8E1 CD 2C E6       	CALL	GET_RR_AHL
E8E4 19             	ADD	HL,DE
E8E5 CE 00          	ADC	A,0
E8E7 CD 36 E6       	CALL	SET_RR_AHL
E8EA EB             	EX	DE,HL		;HL=進めるレコード数
E8EB D0             	RET	NC
E8EC FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E8F0 C0             	RET	NZ
E8F1 FD 34 24       	INC	(IY+36)
E8F4 C9             	RET
E8F5                
E8F5                GET_RR_BCDE:			;BCDE=Random record
E8F5 FD 5E 21       	LD	E,(IY+33)	;(FCB)ランダムレコード
E8F8 FD 56 22       	LD	D,(IY+34)
E8FB FD 4E 23       	LD	C,(IY+35)
E8FE 06 00          	LD	B,0		;CP/M互換のアクセスの場合はFCBは36バイト
E900 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E904 C0             	RET	NZ
E905 FD 46 24       	LD	B,(IY+36)
E908 C9             	RET
E909                
E909                ;	ランダムブロックアクセスの連続したセクタをまとめる
E909                
E909                DWTC:
E909 E5             	PUSH	HL
E90A 21 99 EC       	LD	HL,DWT24B
E90D 18 04          	JR	DWTC1
E90F                DRDC:
E90F E5             	PUSH	HL
E910 21 89 EC       	LD	HL,DRD24B
E913                DWTC1:
E913 22 6D E9       	LD	(DRWF_MODE),HL
E916 E1             	POP	HL
E917 3A 5D E9       	LD	A,(DRWF_B)
E91A B7             	OR	A
E91B 20 0F          	JR	NZ,DRDC1
E91D                SAVE_DRWC:
E91D 06 01          	LD	B,1
E91F ED 43 5C E9    	LD	(DRWF_C),BC
E923 ED 53 63 E9    	LD	(DRWF_E),DE
E927 22 66 E9       	LD	(DRWF_HL),HL
E92A 18 20          	JR	INC_HL_DRWC
E92C                DRDC1:
E92C E5             	PUSH	HL
E92D 21 63 E9       	LD	HL,DRWF_E
E930 86             	ADD	A,(HL)
E931 F5             	PUSH	AF
E932 BB             	CP	E
E933 20 1D          	JR	NZ,DRDC2
E935 F1             	POP	AF
E936 23             	INC	HL
E937 7E             	LD	A,(HL)
E938 CE 00          	ADC	A,0
E93A F5             	PUSH	AF
E93B BA             	CP	D
E93C 20 14          	JR	NZ,DRDC2
E93E F1             	POP	AF
E93F 3A 5C E9       	LD	A,(DRWF_C)
E942 CE 00          	ADC	A,0
E944 B9             	CP	C
E945 20 0C          	JR	NZ,DRDC3
E947 21 5D E9       	LD	HL,DRWF_B
E94A 34             	INC	(HL)
E94B E1             	POP	HL
E94C                INC_HL_DRWC:
E94C 3A 9C E8       	LD	A,(SECSZ+2)		;1セクタのサイズの上位1バイト
E94F 84             	ADD	A,H
E950 67             	LD	H,A
E951 C9             	RET
E952                DRDC2:
E952 F1             	POP	AF
E953                DRDC3:
E953 CD 59 E9       	CALL	DRW_FLUSH
E956 E1             	POP	HL
E957 18 C4          	JR	SAVE_DRWC
E959                
E959                ;	ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
E959                DRW_FLUSH:
E959 C5             	PUSH	BC
E95A D5             	PUSH	DE
E95B 01 00 00       	LD	BC,0
E95E 00 00 E9 5C    DRWF_C	EQU	$-2
E95E 00 00 E9 5D    DRWF_B	EQU	$-1
E95E 78             	LD	A,B
E95F B7             	OR	A
E960 28 0D          	JR	Z,DRDF1
E962 11 00 00       	LD	DE,0
E965 00 00 E9 63    DRWF_E	EQU	$-2
E965 00 00 E9 64    DRWF_D	EQU	$-1
E965 21 00 00       	LD	HL,0
E968 00 00 E9 66    DRWF_HL	EQU	$-2
E968 AF             	XOR	A
E969 32 5D E9       	LD	(DRWF_B),A
E96C CD 89 EC       	CALL	DRD24B
E96F 00 00 E9 6D    DRWF_MODE	EQU	$-2
E96F                DRDF1:
E96F D1             	POP	DE
E970 C1             	POP	BC
E971 C9             	RET
E972                	INCLUDE	"LDDIO.ASM"
E972                
E972                ;	LSX-Dodgers DIO
E972                
E972                DRDX:
E972 CD B0 E9       	CALL	DRDY
E975 C8             	RET	Z
E976 CD 96 E9       	CALL	DRDX1		;データバッファの情報を保存
E979 D8             	RET	C
E97A E5             	PUSH	HL
E97B C5             	PUSH	BC
E97C D5             	PUSH	DE
E97D 2A 7E F1       	LD	HL,(_DTBUF)
E980 3A D9 E9       	LD	A,(_DBS24)
E983 4F             	LD	C,A
E984 CD 87 EC       	CALL	DRD24
E987 DC AB E9       	CALL	C,DRDNE
E98A                POP_DE_BC_HL_RET:
E98A D1             	POP	DE
E98B C1             	POP	BC
E98C E1             	POP	HL
E98D C9             	RET
E98E                
E98E                ;	CDE:セクタ番号
E98E                DRDN:
E98E AF             	XOR	A
E98F 00             DRDN1:	NOP			;自己書き換え NOP / SCF
E990 30 E0          	JR	NC,DRDX
E992                DRDNX:
E992 CD B0 E9       	CALL	DRDY
E995 C8             	RET	Z
E996                DRDX1:
E996 CD C6 E9       	CALL	DWTX
E999                				;データバッファの読み込んだドライブ・セクタ情報を保存
E999 ED 53 A6 F0    	LD	(_DBSEC),DE
E99D 79             	LD	A,C
E99E 32 D9 E9       	LD	(_DBS24),A
E9A1                
E9A1 3A 88 F0       	LD	A,(_DRV)
E9A4 32 A5 F0       	LD	(_DBDRV),A
E9A7 CD D9 F0       	CALL	_CHGDRV
E9AA D0             	RET	NC
E9AB                DRDNE:
E9AB 9F             	SBC	A,A		;CF=1ならばA=0FFH
E9AC 32 A5 F0       	LD	(_DBDRV),A
E9AF C9             	RET
E9B0                
E9B0                ;	CDE:セクタ番号
E9B0                DRDY:
E9B0 3A D9 E9       	LD	A,(_DBS24)
E9B3 B9             	CP	C
E9B4 C0             	RET	NZ
E9B5                
E9B5 E5             	PUSH	HL
E9B6 3A 88 F0       	LD	A,(_DRV)
E9B9 21 A5 F0       	LD	HL,_DBDRV
E9BC AE             	XOR	(HL)
E9BD 20 05          	JR	NZ,POP_HL_RET
E9BF                
E9BF 2A A6 F0       	LD	HL,(_DBSEC)
E9C2 ED 52          	SBC	HL,DE		;上でXORを使っているのでCF=0のはず
E9C4                POP_HL_RET:
E9C4 E1             	POP	HL
E9C5 C9             	RET
E9C6                
E9C6                DWTX:
E9C6 3A A4 F0       	LD	A,(_WTDBF)
E9C9 B7             	OR	A
E9CA C8             	RET	Z
E9CB AF             	XOR	A
E9CC 32 A4 F0       	LD	(_WTDBF),A
E9CF                
E9CF E5             	PUSH	HL
E9D0 C5             	PUSH	BC
E9D1 D5             	PUSH	DE
E9D2 3A A5 F0       	LD	A,(_DBDRV)
E9D5 CD D9 F0       	CALL	_CHGDRV
E9D8 0E 00          	LD	C,0
E9DA 00 00 E9 D9    _DBS24	EQU	$-1
E9DA ED 5B A6 F0    	LD	DE,(_DBSEC)
E9DE 2A 7E F1       	LD	HL,(_DTBUF)
E9E1 D4 97 EC       	CALL	NC,DWT24
E9E4                POP_DE_BC_HL_RET2:
E9E4 18 A4          	JR	POP_DE_BC_HL_RET
E9E6                
E9E6                RDFATX:
E9E6 E5             	PUSH	HL
E9E7 3A 88 F0       	LD	A,(_DRV)
E9EA 21 AA F0       	LD	HL,_FATDRV
E9ED AE             	XOR	(HL)
E9EE 28 D4          	JR	Z,POP_HL_RET
E9F0                
E9F0 C5             	PUSH	BC
E9F1 D5             	PUSH	DE
E9F2 DD E5          	PUSH	IX
E9F4 CD 10 EA       	CALL	WTFATX
E9F7 38 13          	JR	C,POP_IX_DE_BC_HL_RET
E9F9                
E9F9 AF             	XOR	A
E9FA 32 AB F0       	LD	(_FATIX),A
E9FD 3A 88 F0       	LD	A,(_DRV)
EA00 32 AA F0       	LD	(_FATDRV),A
EA03 CD E5 F0       	CALL	_RDFAT
EA06                RDFATE2:
EA06 30 04          	JR	NC,POP_IX_DE_BC_HL_RET
EA08 9F             	SBC	A,A		;A=0xFF
EA09 32 AA F0       	LD	(_FATDRV),A
EA0C                POP_IX_DE_BC_HL_RET:
EA0C DD E1          	POP	IX
EA0E 18 D4          	JR	POP_DE_BC_HL_RET2
EA10                
EA10                WTFATX:
EA10 3A A2 F0       	LD	A,(_WTFATF)
EA13 B7             	OR	A
EA14 C8             	RET	Z
EA15 E5             	PUSH	HL
EA16 3A AA F0       	LD	A,(_FATDRV)
EA19 21 A5 F0       	LD	HL,_DBDRV
EA1C AE             	XOR	(HL)
EA1D CC C6 E9       	CALL	Z,DWTX
EA20 38 A2          	JR	C,POP_HL_RET
EA22 C5             	PUSH	BC
EA23 D5             	PUSH	DE
EA24 DD E5          	PUSH	IX
EA26 CD A4 EC       	CALL	WTFAT
EA29 AF             	XOR	A
EA2A 32 A2 F0       	LD	(_WTFATF),A
EA2D 18 DD          	JR	POP_IX_DE_BC_HL_RET
EA2F                
EA2F                NCL1:
EA2F 7A             	LD	A,D
EA30 B3             	OR	E
EA31 37             	SCF
EA32 C8             	RET	Z
EA33                
EA33 7A             	LD	A,D
EA34 CB 3F          	SRL	A	;/2
EA36 CB 3F          	SRL	A	;/2
EA38                
EA38 E5             	PUSH	HL
EA39 32 58 EA       	LD	(NCLPAT_FATIX),A	;_FATIX
EA3C 2A AA F0       	LD	HL,(_FATDRV)	;L=_FATDRV H=_FATIX
EA3F BC             	CP	H
EA40 3A 88 F0       	LD	A,(_DRV)	;LDではフラグは変化しない
EA43 32 57 EA       	LD	(NCLPAT_FATDRV),A	;_FATDRV
EA46 20 05          	JR	NZ,NCL2		;FATIXが違う
EA48 BD             	CP	L
EA49 20 02          	JR	NZ,NCL2		;ドライブが違う
EA4B E1             	POP	HL
EA4C C9             	RET
EA4D                NCL2:
EA4D C5             	PUSH	BC
EA4E D5             	PUSH	DE
EA4F DD E5          	PUSH	IX
EA51 CD 10 EA       	CALL	WTFATX
EA54 38 B6          	JR	C,POP_IX_DE_BC_HL_RET
EA56 01 00 00       	LD	BC,0		;自己書き換え C=_FATDRV B=_FATIX
EA59 00 00 EA 58    NCLPAT_FATIX	EQU	$-1
EA59 00 00 EA 57    NCLPAT_FATDRV	EQU	$-2
EA59 ED 43 AA F0    	LD	(_FATDRV),BC
EA5D CD 79 EC       	CALL	RDFATS
EA60 18 A4          	JR	RDFATE2
EA62                
EA62                NCL3:
EA62 CB 9A          	RES	3,D
EA64 CB 92          	RES	2,D
EA66 6B             	LD	L,E
EA67 62             	LD	H,D
EA68 CB 3C          	SRL	H	;
EA6A CB 1D          	RR	L	;HLA=HLA/2
EA6C 1F             	RRA		;
EA6D F5             	PUSH	AF
EA6E 3A AB F0       	LD	A,(_FATIX)
EA71 0F             	RRCA
EA72 30 0B          	JR	NC,NCL3X1
EA74 3A 9C E8       	LD	A,(SECSZ+2)
EA77 FE 04          	CP	4		;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
EA79 20 04          	JR	NZ,NCL3X1
EA7B 01 00 02       	LD	BC,512
EA7E 09             	ADD	HL,BC
EA7F                NCL3X1:
EA7F F1             	POP	AF
EA80 ED 4B 7C F1    	LD	BC,(_FATBF)
EA84 19             	ADD	HL,DE
EA85 09             	ADD	HL,BC
EA86 17             	RLA
EA87 C9             	RET
EA88                
EA88                GNCL:
EA88 CD 2F EA       	CALL	NCL1		;GET NEXT CLUSTER
EA8B D8             	RET	C
EA8C C5             	PUSH	BC
EA8D E5             	PUSH	HL
EA8E CD 62 EA       	CALL	NCL3
EA91 38 09          	JR	C,GNC1
EA93 5E             	LD	E,(HL)
EA94 23             	INC	HL
EA95 7E             	LD	A,(HL)
EA96 E6 0F          	AND	00FH
EA98 57             	LD	D,A
EA99 E1             	POP	HL
EA9A C1             	POP	BC
EA9B C9             	RET
EA9C                GNC1:
EA9C 7E             	LD	A,(HL)
EA9D 23             	INC	HL
EA9E 56             	LD	D,(HL)
EA9F 06 04          	LD	B,4
EAA1                GNC1L:
EAA1 CB 3A          	SRL	D	;DA=DA/2
EAA3 1F             	RRA		;
EAA4 10 FB          	DJNZ	GNC1L
EAA6                
EAA6 5F             	LD	E,A
EAA7 E1             	POP	HL
EAA8 C1             	POP	BC
EAA9 A7             	AND	A
EAAA C9             	RET
EAAB                
EAAB                SNCL:
EAAB CD 2F EA       	CALL	NCL1
EAAE D8             	RET	C
EAAF                ;				SET NEXT CLUSTER
EAAF E5             	PUSH	HL
EAB0 C5             	PUSH	BC
EAB1 D5             	PUSH	DE
EAB2 E5             	PUSH	HL
EAB3 CD 62 EA       	CALL	NCL3
EAB6 D1             	POP	DE
EAB7                ;CF=ODD
EAB7 7E             	LD	A,(HL)
EAB8 73             	LD	(HL),E
EAB9 38 06          	JR	C,SNC1
EABB                ;EVEN
EABB                ;M[0] = E
EABB                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
EABB 23             	INC	HL
EABC ED 67          	RRD		;M={A[3:0],E[3:0]}
EABE 7A             	LD	A,D
EABF 18 04          	JR	SNC11
EAC1                SNC1:
EAC1                ;ODD
EAC1                ;HL[0] = (HL[0]&0x0F) | (E<<4)
EAC1                ;HL[1] = DE>>4
EAC1 ED 6F          	RLD		;M={D[3:0],E[7:4]}
EAC3 23             	INC	HL
EAC4 72             	LD	(HL),D	;M={D[3:0],E[7:4]}
EAC5                SNC11:
EAC5 ED 6F          	RLD		;M={M[7:4],D[3:0]}
EAC7 B7             	OR	A
EAC8 D1             	POP	DE
EAC9 C1             	POP	BC
EACA E1             	POP	HL
EACB                FAT_CHANGED:
EACB 3E 01          	LD	A,1
EACD 32 A2 F0       	LD	(_WTFATF),A
EAD0 C9             	RET
EAD1                
EAD1                N16CL3:
EAD1 C5             	PUSH	BC
EAD2 6B             	LD	L,E
EAD3 7A             	LD	A,D
EAD4 E6 03          	AND	3
EAD6 67             	LD	H,A
EAD7 29             	ADD	HL,HL
EAD8 ED 4B 7C F1    	LD	BC,(_FATBF)
EADC 09             	ADD	HL,BC
EADD C1             	POP	BC
EADE C9             	RET
EADF                
EADF                GNCL16:
EADF CD 2F EA       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EAE2 D8             	RET	C
EAE3 E5             	PUSH	HL
EAE4 CD D1 EA       	CALL	N16CL3
EAE7 5E             	LD	E,(HL)
EAE8 23             	INC	HL
EAE9 56             	LD	D,(HL)
EAEA E1             	POP	HL
EAEB C9             	RET
EAEC                
EAEC                SNCL16:
EAEC CD 2F EA       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EAEF D8             	RET	C
EAF0 D5             	PUSH	DE
EAF1 E5             	PUSH	HL
EAF2 CD D1 EA       	CALL	N16CL3
EAF5 D1             	POP	DE		;HL
EAF6 73             	LD	(HL),E
EAF7 23             	INC	HL
EAF8 72             	LD	(HL),D
EAF9 6B             	LD	L,E
EAFA 62             	LD	H,D
EAFB D1             	POP	DE
EAFC 18 CD          	JR	FAT_CHANGED
EAFE                
EAFE                ;------------------------
EAFE                ;次のセクタを探す際に_SECPSの値をチェック
EAFE                ;in
EAFE                ;	DE : セクタ番号
EAFE                ;out
EAFE                ;	DE : 次のセクタ番号
EAFE                ;note
EAFE                ;
EAFE                ;------------------------
EAFE                NEXTX:
EAFE 3E 00          	LD	A,0	;自己書き換え
EB00 00 00 EA FF    _SECPS	EQU	$-1
EB00 3C             	INC	A
EB01 E6 00          	AND	0	;自己書き換え　1クラスタの論理セクタ数-1
EB03 00 00 EB 02    _NCPAT	EQU	$-1
EB03 32 FF EA       	LD	(_SECPS),A
EB06 C9             	RET
EB07                
EB07                GNCLX:
EB07 CD FE EA       	CALL	NEXTX
EB0A C0             	RET	NZ	;1クラスタのセクタ未満の場合は戻る
EB0B C3 F7 F0       	JP	_GNCL	;次のクラスタを探す
EB0E                
EB0E                RDFAT:
EB0E 3E 80          	LD	A,080H
EB10 32 70 F0       	LD	(CHECK),A
EB13                RDFAT1:
EB13 3A 88 F0       	LD	A,(_DRV)
EB16 CD C2 ED       	CALL	CHGDRVR
EB19 D8             	RET	C
EB1A DD 7E 12       	LD	A,(IX+DPB_DEVICE)
EB1D CB 6F          	BIT	5,A
EB1F 28 68          	JR	Z,RDFAT0X
EB21 21 70 F0       	LD	HL,CHECK
EB24 A6             	AND	(HL)
EB25 77             	LD	(HL),A
EB26 11 00 00       	LD	DE,0		;BPB
EB29 2A 7C F1       	LD	HL,(_FATBF)
EB2C CD 85 EC       	CALL	DRD16
EB2F 30 24          	JR	NC,GETBPB
EB31 21 70 F0       	LD	HL,CHECK
EB34 CB 06          	RLC	(HL)
EB36 3F             	CCF
EB37 D8             	RET	C
EB38 DD CB 0A 1E    	RR	(IX+DPB_FDMODE)
EB3C 3F             	CCF			;フロッピーディスクのFDモードを切り替える
EB3D DD CB 0A 16    	RL	(IX+DPB_FDMODE)
EB41 3E FF          	LD	A,0FFH
EB43 32 89 F0       	LD	(_DSK),A
EB46 3A 84 F0       	LD	A,(_DRIVE)
EB49 E6 03          	AND	3
EB4B F6 80          	OR	080H
EB4D 6F             	LD	L,A
EB4E 26 F0          	LD	H,_CYL0/256
EB50 3E FF          	LD	A,0FFH
EB52 77             	LD	(HL),A
EB53 18 BE          	JR	RDFAT1
EB55                GETBPB:
EB55 FD E5          	PUSH	IY
EB57 FD 2A 7C F1    	LD	IY,(_FATBF)	;BPB
EB5B CD F1 F0       	CALL	_BPB2DPB
EB5E FD E1          	POP	IY
EB60 DD 7E 12       	LD	A,(IX+DPB_DEVICE)
EB63 30 21          	JR	NC,GETBPBOK
EB65 E6 0F          	AND	00FH
EB67 FE 07          	CP	7
EB69 37             	SCF
EB6A C0             	RET	NZ
EB6B DD CB 0A 46    	BIT	0,(IX+DPB_FDMODE)
EB6F 21 C0 F1       	LD	HL,M2D
EB72 20 02          	JR	NZ,SETFDMODE
EB74 2E D2          	LD	L,M2HD-STABLE
EB76                SETFDMODE:
EB76 DD E5          	PUSH	IX
EB78 D1             	POP	DE
EB79 ED A0          	LDI
EB7B ED A0          	LDI
EB7D 13             	INC	DE
EB7E 13             	INC	DE
EB7F 13             	INC	DE
EB80 13             	INC	DE
EB81 01 0C 00       	LD	BC,12
EB84 ED B0          	LDIR
EB86                GETBPBOK:
EB86 CD 2D ED       	CALL	CHGDRV2
EB89                RDFAT0X:
EB89 CD 79 EC       	CALL	RDFATS
EB8C D8             	RET	C
EB8D DD AE 06       	XOR	(IX+DPB_FATID)
EB90 C8             	RET	Z
EB91 DD CB 12 6E    	BIT	5,(IX+DPB_DEVICE)
EB95 C0             	RET	NZ		;BPBを取得している場合はFATIDをチェックしない
EB96 37             	SCF
EB97 C9             	RET
EB98                
EB98                POP_HL_SCF_RET:
EB98 E1             	POP	HL
EB99 37             	SCF
EB9A C9             	RET
EB9B                
EB9B                BPB2DPB:
EB9B FD 7E 0B       	LD	A,(IY+11)	;BPB_BytsPerSec
EB9E B7             	OR	A
EB9F 37             	SCF
EBA0 C0             	RET	NZ
EBA1                BPBOK:
EBA1 FD 7E 0D       	LD	A,(IY+13)	;BPB_SecPerClus
EBA4 DD 77 07       	LD	(IX+DPB_SECPCL),A
EBA7                
EBA7 FD 7E 16       	LD	A,(IY+22)	;BPB_FATSz16
EBAA DD 77 00       	LD	(IX+DPB_FATLN),A
EBAD FD 7E 17       	LD	A,(IY+23)	;BPB_FATSz16
EBB0 DD 77 01       	LD	(IX+DPB_FATLN+1),A
EBB3                
EBB3 FD 6E 0E       	LD	L,(IY+14)	;BPB_RsvdSecCnt
EBB6 FD 66 0F       	LD	H,(IY+15)
EBB9 DD 75 0E       	LD	(IX+DPB_FATPS),L
EBBC FD 5E 16       	LD	E,(IY+22)	;BPB_FATSz16
EBBF FD 56 17       	LD	D,(IY+23)
EBC2 FD 46 10       	LD	B,(IY+16)	;BPB_NumFATs
EBC5                BPBDP1:				;BPB_FATSz16 * BPB_NumFATs
EBC5 19             	ADD	HL,DE
EBC6 10 FD          	DJNZ	BPBDP1
EBC8                BPBDP2:
EBC8 DD 75 10       	LD	(IX+DPB_DIRPS),L
EBCB DD 74 11       	LD	(IX+DPB_DIRPS+1),H
EBCE E5             	PUSH	HL
EBCF                
EBCF FD 6E 11       	LD	L,(IY+17)	;BPB_RootEntCnt
EBD2 FD 66 12       	LD	H,(IY+18)
EBD5 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EBD8 B7             	OR	A
EBD9 28 BD          	JR	Z,POP_HL_SCF_RET
EBDB 06 06          	LD	B,6
EBDD                BPBBPS1:
EBDD 05             	DEC	B
EBDE 0F             	RRCA
EBDF 30 FC          	JR	NC,BPBBPS1
EBE1                BPBDE1:
EBE1 29             	ADD	HL,HL
EBE2 10 FD          	DJNZ	BPBDE1
EBE4                
EBE4 7C             	LD	A,H
EBE5 DD 77 0B       	LD	(IX+DPB_DIRSCNT),A	;
EBE8                
EBE8 D1             	POP	DE		;DPB_DIRPS
EBE9 6C             	LD	L,H
EBEA 26 00          	LD	H,0
EBEC 19             	ADD	HL,DE		;MAXDIR
EBED E5             	PUSH	HL
EBEE FD 4E 0D       	LD	C,(IY+13)	;BPB_SecPerClus
EBF1 CB 21          	SLA	C		;*2
EBF3 AF             	XOR	A
EBF4 47             	LD	B,A
EBF5 ED 42          	SBC	HL,BC
EBF7 DD 75 14       	LD	(IX+DPB_ADDCL),L
EBFA DD 74 15       	LD	(IX+DPB_ADDCL+1),H
EBFD                
EBFD D1             	POP	DE		;DE=DPB_MAXDIR
EBFE FD 6E 13       	LD	L,(IY+19)	;BPB_TotSec16
EC01 FD 66 14       	LD	H,(IY+20)
EC04                
EC04 DD 7E 12       	LD	A,(IX+DPB_DEVICE)
EC07 E6 0F          	AND	00FH
EC09 FE 07          	CP	7		;フロッピー
EC0B 20 19          	JR	NZ,NOT_FD
EC0D E5             	PUSH	HL
EC0E FD 4E 18       	LD	C,(IY+24)	;BPB_SecPerTr
EC11 DD 71 0D       	LD	(IX+DPB_MAXSEC),C
EC14 AF             	XOR	A
EC15 CB 21          	SLA	C		;両面なのでセクタ数を２倍
EC17 06 10          	LD	B,16
EC19                DIVSEC:				;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
EC19 29             	ADD	HL,HL
EC1A 17             	RLA
EC1B B9             	CP	C
EC1C 38 02             	JR	C,DIVSEC1
EC1E 91                	SUB	C
EC1F 2C             	INC	L
EC20                DIVSEC1:
EC20 10 F7           	DJNZ	DIVSEC
EC22 DD 75 0C       	LD	(IX+DPB_MAXCYL),L
EC25 E1             	POP	HL	;ここまでフロッピー専用
EC26                NOT_FD:
EC26 7C             	LD	A,H
EC27 B5             	OR	L
EC28 3E 00          	LD	A,0		;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
EC2A 20 10          	JR	NZ,BPB16BIT	;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
EC2C FD 7E 23       	LD	A,(IY+35)	;念のために総セクタ数が24ビットを超える場合はエラーを返す
EC2F B7             	OR	A
EC30 37             	SCF
EC31 C0             	RET	NZ
EC32 FD 6E 20       	LD	L,(IY+32)	;BPB_TotSec32 は AHL の24ビットで扱う
EC35 FD 66 21       	LD	H,(IY+33)	;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので
EC38 FD 7E 22       	LD	A,(IY+34)	;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
EC3B A7             	AND	A		;CF=0
EC3C                BPB16BIT:
EC3C ED 52          	SBC	HL,DE
EC3E DE 00          	SBC	A,0
EC40 FD 46 0D       	LD	B,(IY+13)	;BPB_SecPerClus
EC43                BPBTC1:				;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
EC43 CB 18          	RR	B		;->CY
EC45 38 08          	JR	C,BPBTC2
EC47 CB 3F          	SRL	A
EC49 CB 1C          	RR	H		;AHL=AHL/2
EC4B CB 1D          	RR	L
EC4D 18 F4          	JR	BPBTC1
EC4F                BPBTC2:
EC4F B7             	OR	A
EC50 37             	SCF
EC51 C0             	RET	NZ		;念のため(クラスタ数が16ビットを超える場合)
EC52 23             	INC	HL
EC53 23             	INC	HL
EC54 DD 75 08       	LD	(IX+DPB_MAXCL),L
EC57 DD 74 09       	LD	(IX+DPB_MAXCL+1),H
EC5A                
EC5A FD 7E 15       	LD	A,(IY+21)	;BPB_Media
EC5D DD 77 06       	LD	(IX+DPB_FATID),A
EC60                
EC60 FD 7E 10       	LD	A,(IY+16)	;BPB_NumFATs
EC63 C6 FE          	ADD	A,0-2		;>2:CF=1
EC65 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EC68 6F             	LD	L,A
EC69 30 02          	JR	NC,BPBFAT1
EC6B F6 80          	OR	080H
EC6D                BPBFAT1:			;ここではCF=0
EC6D DD 77 0F       	LD	(IX+DPB_BPS),A
EC70 2D             	DEC	L		;以下のセクタサイズに合致しない場合はCF=1でエラーにする
EC71 C8             	RET	Z		;1セクタ256バイト
EC72 2D             	DEC	L
EC73 C8             	RET	Z		;1セクタ512バイト
EC74 2D             	DEC	L
EC75 2D             	DEC	L
EC76 C8             	RET	Z		;1セクタ1024バイト
EC77 37             	SCF
EC78 C9             	RET
EC79                
EC79                RDFATS:
EC79 CD BF EC       	CALL	FATSETUP
EC7C D8             	RET	C
EC7D CD 89 EC       	CALL	DRD24B
EC80 2A 7C F1       	LD	HL,(_FATBF)
EC83 7E             	LD	A,(HL)
EC84 C9             	RET
EC85                
EC85                DRD16:
EC85 0E 00          	LD	C,0
EC87                DRD24:
EC87 06 01          	LD	B,1
EC89                DRD24B:
EC89 DD E5          	PUSH	IX
EC8B DD 2A A8 F0    	LD	IX,(_DPB)
EC8F CD EA EE       	CALL	FDRD		;自己書き換え（ディスク読み込み）
EC92 00 00 EC 90    DRDPAT	EQU	$-2
EC92                POP_IX_RET:
EC92 DD E1          	POP	IX
EC94 C9             	RET
EC95                
EC95                DWT16:
EC95 0E 00          	LD	C,0
EC97                DWT24:
EC97 06 01          	LD	B,1
EC99                DWT24B:
EC99 DD E5          	PUSH	IX
EC9B DD 2A A8 F0    	LD	IX,(_DPB)
EC9F CD DC EE       	CALL	FDWT		;自己書き換え（ディスク書き込み）
ECA2 00 00 EC A0    DWTPAT	EQU	$-2
ECA2 18 EE          	JR	POP_IX_RET
ECA4                
ECA4                WTFAT:
ECA4 CD BF EC       	CALL	FATSETUP
ECA7 D4 99 EC       	CALL	NC,DWT24B
ECAA D8             	RET	C
ECAB DD CB 0F 7E    	BIT	7,(IX+DPB_BPS)
ECAF C8             	RET	Z		;予備FATが無い
ECB0 CD C6 EC       	CALL	FATS2
ECB3 E5             	PUSH	HL		;予備FAT
ECB4 DD 6E 00       	LD	L,(IX+DPB_FATLN)
ECB7 DD 66 01       	LD	H,(IX+DPB_FATLN+1)
ECBA 19             	ADD	HL,DE
ECBB EB             	EX	DE,HL
ECBC E1             	POP	HL
ECBD 18 DA          	JR	DWT24B
ECBF                ;------------------------
ECBF                ;FATのセットアップ
ECBF                ;out
ECBF                ;	B  : FATセクタ数
ECBF                ;	DE : FAT先頭セクタ番号
ECBF                ;	HL : FATバッファポインタ
ECBF                ;	CF : 1=ドライブ切り替えエラー
ECBF                ;note
ECBF                ;	FATサイズがFATバッファを超える場合は
ECBF                ;	対象クラスタ領域==(_FATIX)によって
ECBF                ;	FAT12:対象クラスタ1024毎に1.5KBを切り替える
ECBF                ;	FAT16:対象クラスタ1024毎に2KBを切り替える
ECBF                ;------------------------
ECBF                FATSETUP:
ECBF 3A AA F0       	LD	A,(_FATDRV)
ECC2 CD C2 ED       	CALL	CHGDRVR		;ドライブ切り替え
ECC5 D8             	RET	C
ECC6                FATS2:
ECC6 DD 7E 0F       	LD	A,(IX+DPB_BPS)	;512=2 1024=4
ECC9 0F             	RRCA
ECCA CD F3 EC       	CALL	FATSETUP12	;自己書き換え
ECCD 00 00 EC CB    FATSX	EQU	$-2
ECCD 21 00 00       	LD	HL,0
ECD0 4A             	LD	C,D
ECD1 54             	LD	D,H
ECD2 3A AB F0       	LD	A,(_FATIX)	;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
ECD5 47             	LD	B,A
ECD6 04             	INC	B
ECD7 DD 7E 00       	LD	A,(IX+DPB_FATLN)
ECDA                FAT_SKP:
ECDA 05             	DEC	B
ECDB 28 05          	JR	Z,FAT1
ECDD 19             	ADD	HL,DE
ECDE 93             	SUB	E
ECDF 30 F9          	JR	NC,FAT_SKP
ECE1 C9             	RET
ECE2                FAT1:
ECE2 EB             	EX	DE,HL
ECE3 B9             	CP	C		;C=FATバッファに読み込めるセクタ数
ECE4 38 01          	JR	C,FAT2
ECE6 79             	LD	A,C
ECE7                FAT2:
ECE7 47             	LD	B,A
ECE8                
ECE8 2A FA F1       	LD	HL,(_FATPS)	;fat sector pos
ECEB 19             	ADD	HL,DE
ECEC EB             	EX	DE,HL
ECED 2A 7C F1       	LD	HL,(_FATBF)
ECF0 AF             	XOR	A		;CF=0
ECF1 4F             	LD	C,A
ECF2 C9             	RET
ECF3                ;
ECF3                ;	FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
ECF3                ;	FATSETUP* (FAT12/FAT16)
ECF3                ;out
ECF3                ;	D : FATバッファに読み込める最大のセクタ数
ECF3                ;	E : _FATIXで進めるセクタ数
ECF3                FATSETUP12:
ECF3 11 06 06       	LD	DE,0606H	;256
ECF6 D8             	RET	C
ECF7 11 03 03       	LD	DE,0303H	;512
ECFA 0F             	RRCA
ECFB D8             	RET	C
ECFC 11 01 02       	LD	DE,0201H	;1024
ECFF C9             	RET
ED00                
ED00                FATSETUP16:
ED00 11 08 08       	LD	DE,0808H	;256
ED03 D8             	RET	C
ED04 11 04 04       	LD	DE,0404H
ED07 0F             	RRCA			;512
ED08 D8             	RET	C
ED09 11 02 02       	LD	DE,0202H	;1024
ED0C C9             	RET
ED0D                
ED0D                CHGDRV:
ED0D E5             	PUSH	HL
ED0E 21 89 F0       	LD	HL,_DSK
ED11 BE             	CP	(HL)
ED12 28 0A          	JR	Z,CHGDRVE
ED14                CHGDRV1:
ED14 DD E5          	PUSH	IX
ED16 CD 20 ED       	CALL	CHGDRV0
ED19 3A 89 F0       	LD	A,(_DSK)
ED1C DD E1          	POP	IX
ED1E                CHGDRVE:
ED1E E1             	POP	HL
ED1F C9             	RET
ED20                
ED20                CHGDRV0:
ED20 6F             	LD	L,A
ED21 CD DC F0       	CALL	_GETDPB
ED24 D8             	RET	C
ED25 DD 22 A8 F0    	LD	(_DPB),IX
ED29 7D             	LD	A,L
ED2A 32 89 F0       	LD	(_DSK),A
ED2D                CHGDRV2:
ED2D C5             	PUSH	BC
ED2E D5             	PUSH	DE
ED2F ED 73 78 ED    	LD	(SPPAT2),SP
ED33 F3             	DI
ED34 DD F9          	LD	SP,IX
ED36                
ED36 E1             	POP	HL		;00:DPB_FATLN
ED37 E1             	POP	HL		;02:DPB_DRD
ED38 22 90 EC       	LD	(DRDPAT),HL
ED3B                
ED3B E1             	POP	HL
ED3C 22 A0 EC       	LD	(DWTPAT),HL	;04:DPB_DWT
ED3F                
ED3F E1             	POP	HL		;L=06:DPB_FATID H=07:DPB_SECPCL
ED40 7C             	LD	A,H
ED41 32 97 E3       	LD	(SPCPAT),A	;1クラスタの論理セクタ数
ED44 3D             	DEC	A
ED45 32 02 EB       	LD	(_NCPAT),A
ED48                
ED48 E1             	POP	HL		;08:DPB_MAXCL
ED49 7D             	LD	A,L
ED4A 32 B6 E3       	LD	(CLPAT2),A
ED4D 7C             	LD	A,H
ED4E 32 B2 E3       	LD	(CLPAT1),A
ED51 2B             	DEC	HL
ED52 22 B3 E5       	LD	(MAXCLP),HL
ED55                
ED55 E1             	POP	HL		;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
ED56 4C             	LD	C,H
ED57                
ED57 E1             	POP	HL		;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
ED58                
ED58 E1             	POP	HL		;L=0E:DPB_FATPS H=0F:DPB_BPS
ED59 7C             	LD	A,H		;DPB_BPS
ED5A E6 07          	AND	7
ED5C 32 9C E8       	LD	(SECSZ+2),A	;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
ED5F                				;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
ED5F                				;1セクタ1024 2HD/2HDE98
ED5F                				;1セクタ256 GRAM/RAMF/CMOS/等
ED5F                				;1024	512	256
ED5F                				;4	2	1
ED5F 87             	ADD	A,A		;8	4	2
ED60 87             	ADD	A,A		;010H	8	4
ED61 87             	ADD	A,A		;020H	010H	8
ED62 32 14 E2       	LD	(SDECPAT),A	;1セクタ辺りのディレクトリエントリ数
ED65                
ED65 26 00          	LD	H,0
ED67 22 FA F1       	LD	(_FATPS),HL
ED6A                
ED6A E1             	POP	HL		;10:DPB_DIRPS
ED6B 22 FC F1       	LD	(_DIRPS),HL
ED6E                
ED6E E1             	POP	HL		;L=12:DPB_DEVICE H=13:DPB_UNITNO
ED6F 7C             	LD	A,H
ED70 32 84 F0       	LD	(_DRIVE),A
ED73                
ED73 E1             	POP	HL		;14:DPB_ADDCL
ED74 22 A7 E3       	LD	(CLSPAT),HL
ED77                
ED77 31 00 00       	LD	SP,0		;元のSPを復元
ED7A 00 00 ED 78    SPPAT2	EQU	$-2
ED7A FB             	EI
ED7B 2A FC F1       	LD	HL,(_DIRPS)
ED7E 06 00          	LD	B,0
ED80 09             	ADD	HL,BC		;C=DPB_DIRSCNT
ED81 22 2F E2       	LD	(MD_PAT),HL
ED84                
ED84 2A B3 E5       	LD	HL,(MAXCLP);
ED87 11 F6 0F       	LD	DE,4086		;クラスタ数が4086未満:FAT12 4086以上:FAT16
ED8A ED 52          	SBC	HL,DE		;CF=0のはず
ED8C 30 0F          	JR	NC,SETFAT16
ED8E 21 88 EA       	LD	HL,GNCL		;FAT12
ED91 11 AB EA       	LD	DE,SNCL
ED94 01 F3 EC       	LD	BC,FATSETUP12
ED97 DD CB 0F AE    	RES	5,(IX+DPB_BPS)	;DPB_BPS(FAT12)
ED9B 18 0D          	JR	EXTRA1
ED9D                SETFAT16:
ED9D 21 DF EA       	LD	HL,GNCL16	;FAT16
EDA0 11 EC EA       	LD	DE,SNCL16
EDA3 01 00 ED       	LD	BC,FATSETUP16
EDA6 DD CB 0F EE    	SET	5,(IX+DPB_BPS)	;DPB_BPS(FAT16)
EDAA                EXTRA1:
EDAA 22 F8 F0       	LD	(GNCPAT),HL
EDAD ED 53 FB F0    	LD	(SNCPAT),DE
EDB1 ED 43 CB EC    	LD	(FATSX),BC
EDB5 D1             	POP	DE
EDB6 C1             	POP	BC
EDB7 AF             	XOR	A
EDB8 C9             	RET
EDB9                
EDB9                GETDPBD:
EDB9 DD E3          	EX	(SP),IX
EDBB DD E5          	PUSH	IX
EDBD 3A 88 F0       	LD	A,(_DRV)
EDC0 18 07          	JR	GETDPB1
EDC2                
EDC2                CHGDRVR:
EDC2 CD D9 F0       	CALL	_CHGDRV
EDC5 D8             	RET	C
EDC6 3A 89 F0       	LD	A,(_DSK)
EDC9                GETDPB1:
EDC9 C3 DC F0       	JP	_GETDPB
EDCC                
EDCC                GETDPB:
EDCC FE 08          	CP	8
EDCE 3F             	CCF
EDCF D8             	RET	C
EDD0 0F             	RRCA
EDD1 0F             	RRCA
EDD2 0F             	RRCA
EDD3 DD             	DB	0DDH		;Z80未定義命令
EDD4 6F             	LD	L,A		;LD	IXL,A
EDD5 DD             	DB	0DDH		;Z80未定義命令
EDD6 26 F2          	LD	H,_DEVICE/256	;LD	IXH,_DEVICE/256
EDD8 DD 7E 00       	LD	A,(IX+DPB_FATLN)
EDDB A7             	AND	A		;CF=0の為
EDDC DD CB 0F 6E    	BIT	5,(IX+DPB_BPS)
EDE0 C0             	RET	NZ		;FAT16
EDE1 DD CB 12 6E    	BIT	5,(IX+DPB_DEVICE)
EDE5 C0             	RET	NZ		;BPB
EDE6 FE 01          	CP	001H		;A=0 THEN CF=1
EDE8 C9             	RET
EDE9                
EDE9                _SYS5F:
EDE9 AF             	XOR	A
EDEA                FFLUSH:
EDEA F5             	PUSH	AF
EDEB CD 10 EA       	CALL	WTFATX
EDEE AF             	XOR	A
EDEF 32 AB F0       	LD	(_FATIX),A
EDF2 2F             	CPL			;0FFH
EDF3 32 AA F0       	LD	(_FATDRV),A
EDF6 3E             	DB	03EH		;次のPUSH AFをスキップ
EDF7                FFLUSHBUF:
EDF7 F5             	PUSH	AF
EDF8 CD C6 E9       	CALL	DWTX
EDFB 3E FF          	LD	A,0FFH
EDFD 32 39 F0       	LD	(SFILE),A
EE00 32 A5 F0       	LD	(_DBDRV),A
EE03 F1             	POP	AF
EE04 C9             	RET
EE05                
EE05                	INCLUDE	"X1DISK.ASM"
EE05                
EE05                ;	LSX-Dodgers DISK
EE05                ;	X1/turbo/Z
EE05                
EE05                SEEK:
EE05 06 10          	LD	B,16
EE07 DD 4E 0D       	LD	C,(IX+DPB_MAXSEC)
EE0A AF             	XOR	A
EE0B EB             	EX	DE,HL
EE0C                DIV1:
EE0C 29             	ADD	HL,HL
EE0D 8F             	ADC	A,A
EE0E B9             	CP	C
EE0F 38 02          	JR	C,DIV2
EE11 91             	SUB	C
EE12 2C             	INC	L
EE13                DIV2:
EE13 10 F7          	DJNZ	DIV1
EE15                
EE15 3C             	INC	A	;最小のセクタは１固定
EE16 55             	LD	D,L	;TRACK
EE17 5F             	LD	E,A	;SECTOR
EE18 CB 3A          	SRL	D	;CYLINDER
EE1A 9F             	SBC	A,A
EE1B E6 10          	AND	010H	;SIDE
EE1D 4F             	LD	C,A
EE1E                
EE1E 3A 84 F0       	LD	A,(_DRIVE)
EE21 FE 04          	CP	4
EE23 3F             	CCF
EE24 D8             	RET	C
EE25 B1             	OR	C
EE26 32 B1 EE       	LD	(MOPAT+1),A	;Motor off data
EE29 01 FC 0F       	LD	BC,00FFCH
EE2C F6 80          	OR	080H		;Motor on
EE2E ED 79          	OUT	(C),A
EE30                
EE30 CD 74 EE       	CALL	SETMODE
EE33 D8             	RET	C
EE34                
EE34 CD C6 EE       	CALL	DRIVE
EE37 FE FF          	CP	0FFH		;A=0FFH Unknown CYLINDER
EE39 CC A5 EE       	CALL	Z,FDCRES	;Restore
EE3C 0E F9          	LD	C,0F9H
EE3E ED 79          	OUT	(C),A		;Currrent CYLINDER
EE40 92             	SUB	D
EE41 C8             	RET	Z		;No seek
EE42                
EE42 3A 86 F0       	LD	A,(_ISEEK)
EE45 4F             	LD	C,A
EE46                
EE46 DD 7E 0C       	LD	A,(IX+DPB_MAXCYL)
EE49 3D             	DEC	A
EE4A BA             	CP	D		;Over CYLINDER
EE4B D8             	RET	C
EE4C                
EE4C B9             	CP	C		;for Built-in 2DD
EE4D 38 03          	JR	C,SETM2
EE4F 78             	LD	A,B		;B=00FH
EE50 DB FE          	IN	A,(0FEH)		;2HD mode for 2DD seek
EE52                SETM2:
EE52 78             	LD	A,B
EE53 DB FD          	IN	A,(0FDH)		;MFM mode
EE55                
EE55 0E FB          	LD	C,0FBH
EE57 ED 51          	OUT	(C),D
EE59 72             	LD	(HL),D
EE5A 0E 18          	LD	C,018H		;Seek
EE5C                FDCCMD2:
EE5C 3A 85 F0       	LD	A,(_SEEKSP)
EE5F B1             	OR	C
EE60                
EE60                FDCCMD:
EE60 CD BC EE       	CALL	COMSET
EE63                
EE63 3E 80          FDCPAT:	LD	A,080H		;FDC COMMAND(Self-modifying code)
EE65 E6 20          	AND	020H		;Write data Write track
EE67 3C             	INC	A
EE68                
EE68                SST:
EE68 0E 00          	LD	C,0
EE6A                SST1:
EE6A 0D             	DEC	C		; 4
EE6B 20 FD          	JR	NZ,SST1		;12 * 256 / 4 = About 1ms
EE6D 3D             	DEC	A
EE6E 20 FA          	JR	NZ,SST1
EE70                
EE70 3C             	INC	A		;A=1
EE71 CD 81 EE       	CALL	READY
EE74                SETMODE:
EE74 DD 4E 0A       	LD	C,(IX+DPB_FDMODE)	;フロッピーディスクのモード
EE77 ED 78          	IN	A,(C)
EE79                
EE79 78             	LD	A,B
EE7A DB FD          	IN	A,(0FDH)	;MFM mode
EE7C                
EE7C CD C0 EE       	CALL	DELAY0		;Head select time
EE7F 3E 81          	LD	A,081H		;NOT READY,BUSY
EE81                READY:
EE81 E5             	PUSH	HL
EE82 2E 00          	LD	L,0
EE84 67             	LD	H,A
EE85 0E F8          	LD	C,0F8H
EE87                READY2:
EE87 ED 78          	IN	A,(C)
EE89 A4             	AND	H
EE8A 28 17          	JR	Z,READYE
EE8C 3E 1A          	LD	A,1AH
EE8E DB 01          	IN	A,(01H)
EE90 87             	ADD	A,A
EE91 30 F4          	JR	NC,READY2
EE93                READY3:
EE93 ED 78          	IN	A,(C)
EE95 A4             	AND	H
EE96 28 0B          	JR	Z,READYE
EE98 3E 1A          	LD	A,1AH
EE9A DB 01          	IN	A,(01H)
EE9C 87             	ADD	A,A
EE9D 38 F4          	JR	C,READY3
EE9F 2D             	DEC	L
EEA0 20 E5          	JR	NZ,READY2
EEA2 37             	SCF
EEA3                READYE:
EEA3 E1             	POP	HL
EEA4 C9             	RET
EEA5                
EEA5                FDCRES:
EEA5 36 00          	LD	(HL),0
EEA7 0E 08          	LD	C,8
EEA9 18 B1          	JR	FDCCMD2
EEAB                
EEAB                FDMOFF:
EEAB F5             	PUSH	AF
EEAC C5             	PUSH	BC
EEAD 01 FC 0F       	LD	BC,00FFCH	;Motor off
EEB0 3E 00          MOPAT:	LD	A,000H		;(Self-rewriting)
EEB2 ED 79          	OUT	(C),A
EEB4 C1             	POP	BC
EEB5 F1             	POP	AF
EEB6 C9             	RET
EEB7                
EEB7                SECSET:
EEB7 01 FA 0F       	LD	BC,00FFAH
EEBA ED 59          	OUT	(C),E
EEBC                COMSET:
EEBC 0E F8          	LD	C,0F8H
EEBE ED 79          	OUT	(C),A
EEC0                DELAY0:
EEC0 3E 1A          	LD	A,26
EEC2                DELAY:
EEC2 3D             	DEC	A
EEC3 20 FD          	JR	NZ,DELAY
EEC5 C9             	RET
EEC6                
EEC6                DRIVE:
EEC6 2A 84 F0       	LD	HL,(_DRIVE)
EEC9 26 F0          	LD	H,_CYL0/256
EECB CB FD          	SET	7,L
EECD 7E             	LD	A,(HL)
EECE C9             	RET
EECF                
EECF                RNF:
EECF CD C6 EE       	CALL	DRIVE
EED2 36 FF          	LD	(HL),0FFH
EED4 C9             	RET
EED5                
EED5 02             RETRY:	DB	2
EED6                
EED6                
EED6                ;	FLOPPY DISK DRIVER(DMA)
EED6                
EED6                
EED6                WTTRK:
EED6 06 01          	LD	B,1
EED8 3E F4          	LD	A,0F4H
EEDA 18 02          	JR	WTTRK1
EEDC                FDWT:
EEDC 3E A0          	LD	A,0A0H
EEDE                WTTRK1:
EEDE 32 64 EE       	LD	(FDCPAT+1),A
EEE1 3E 10          	LD	A,16
EEE3 18 0C          	JR	DISK
EEE5                
EEE5                DISKOK:
EEE5 06 01          FDCNT:	LD	B,1
EEE7 10 0B          	DJNZ	DISK1
EEE9 C9             	RET
EEEA                
EEEA                FDRD:
EEEA 3E 80          	LD	A,080H
EEEC 32 64 EE       	LD	(FDCPAT+1),A
EEEF 3E 0E          	LD	A,14
EEF1                
EEF1                DISK:
EEF1 32 08 EF       	LD	(DMAPAT+1),A
EEF4                DISK1:
EEF4 78             	LD	A,B
EEF5 32 E6 EE       	LD	(FDCNT+1),A
EEF8 22 60 EF       	LD	(DMAD+11),HL
EEFB                DISKR:
EEFB 3E 02          	LD	A,2		;Retry count
EEFD 32 D5 EE       	LD	(RETRY),A
EF00                DISK2:
EF00 D5             	PUSH	DE
EF01 CD 05 EE       	CALL	SEEK
EF04 38 43          	JR	C,ERRF
EF06 F3             	DI
EF07                
EF07 3E 0E          DMAPAT:	LD	A,14		;自己書き換え
EF09 21 55 EF       	LD	HL,DMAD
EF0C CD A9 DF       	CALL	SETDMA
EF0F ED 49          	OUT	(C),C		;OUT 01F87H,087H WR6 イネーブル
EF11 3A 64 EE       	LD	A,(FDCPAT+1)
EF14 C5             	PUSH	BC
EF15 CD B7 EE       	CALL	SECSET
EF18 2A 60 EF       	LD	HL,(DMAHL)
EF1B 23             	INC	HL
EF1C 11 06 BB       	LD	DE,0BB06H	;READ DMA
EF1F                
EF1F 3E 03          	LD	A,3
EF21 CD 81 EE       	CALL	READY
EF24 ED 78          	IN	A,(C)
EF26                
EF26 C1             	POP	BC
EF27 ED 51          	OUT	(C),D		;読み出しマスク設定
EF29 ED 59          	OUT	(C),E		;バイトカウンタ(LH)
EF2B ED 58          	IN	E,(C)
EF2D ED 50          	IN	D,(C)
EF2F 19             	ADD	HL,DE
EF30 D1             	POP	DE
EF31 13             	INC	DE
EF32 FB             	EI
EF33 CD AB EE       	CALL	FDMOFF
EF36 B7             	OR	A
EF37 28 AC          	JR	Z,DISKOK
EF39 1B             	DEC	DE
EF3A CB 67          	BIT	4,A
EF3C C4 CF EE       	CALL	NZ,RNF
EF3F                DISKE2:
EF3F 21 D5 EE       	LD	HL,RETRY
EF42 35             	DEC	(HL)
EF43 20 BB          	JR	NZ,DISK2
EF45 B7             	OR	A
EF46 28 0A          	JR	Z,ERR
EF48 D5             	PUSH	DE
EF49                ERRF:
EF49 D1             	POP	DE
EF4A                DELP:
EF4A CD CF EE       	CALL	RNF
EF4D CD AB EE       	CALL	FDMOFF
EF50 3E FF          	LD	A,0FFH
EF52                ERR:
EF52 BF             	CP	A
EF53 37             	SCF
EF54 C9             	RET
EF55                
EF55                			;X1turbo DISK DMA
EF55 C3             DMAD:	DB	0C3H	;WR6 リセット
EF56 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
EF57 FB 0F          	DW	00FFBH	;ポートA開始アドレス FDC データレジスタ
EF59 FF FF          	DW	0FFFFH	;ブロック長(転送サイズ-1)
EF5B 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
EF5C 10             	DB	010H	;WR2 ポートBインクリメント
EF5D 80             	DB	080H	;WR3
EF5E 92             	DB	092H	;WR5 WAIT RDY:LOW
EF5F 8D             	DB	08DH	;WR4 バイト ポートB開始アドレス(LH)
EF60 00 00          DMAHL:	DW	0	;ポートB開始アドレス
EF62 CF             	DB	0CFH	;WR6 ロード
EF63 01             	DB	001H	;WR0 ポートB←ポートB 転送
EF64 CF             	DB	0CFH	;WR6 ロード
EF65                
EF65                DMAE:
EF65                
EF65 00 00 1D 55    AT_R	EQU	WTTRK-AT_DWT
EF65                AT_TABLE:
EF65                	INCLUDE	"LDCCPWK.ASM"
EF65                
EF65                ;	LSX-Dodgers CCP WORK
EF65                
EF65 00 00 00 3B    PATHX	EQU	59
EF65                PATHD:	DS	PATHX
EFA0 00             PATHE:	DB	0
EFA1                
EFA1                DTA_CCP:
EFA1                	DS	37
EFC6                
EFC6                FCB_BAT:
EFC6                	DS	37
EFEB                
EFEB 20 20 20 3C    DIRMES:	DB	"   <DIR>  $"
EFEF 44 49 52 3E
EFF3 20 20 24
EFF6 20 66 72 65    FREE:	DB	" free $"
EFFA 65 20 24
EFFD                	INCLUDE	"LDWORK.ASM"
EFFD                
EFFD                ;	LSX-Dodgers WORK0
EFFD                ;
EFFD                ;	CP/M互換BIOS
EFFD                ;	BOOT:アドレス下位1バイトが0になるように
EFFD                AT_WORK:
EFFD                	DS	WORKAD-AT_WORK
F000                
F000                CPM_BOOT:
F000 C3 00 00       	JP	0
F003                _SYS00:		;(BDOS)プログラム終了
F003                CPM_WBOOT:
F003 C3 09 D3       	JP	WBOOT1
F006                CPM_CONST:
F006 C3 57 DC       	JP	CONSTX
F009                _SYS07:		;(BDOS)コンソール直接入力
F009                CPM_CONIN:
F009 C3 CC DB       	JP	FLGET
F00C                CPM_CONOUT:
F00C C3 9C DE       	JP	CONOUT1
F00F                
F00F                DECBF:				;10進数表示時のバッファ(5バイト)
F00F                	DS	5
F014 00 00 F0 0F    RR_BUF_HL	EQU	DECBF	;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
F014 00 00 F0 11    RR_BUF_A	EQU	DECBF+2	;計3バイト
F014                
F014 00             FDRV:	DB	0
F015                FNAME:	DS	36
F039                SFILE:	DS	33		;DRV FILENAME
F05A                
F05A                	DS	3
F05D                
F05D 00 00          LEFTX:	DW	0
F05F 00 00          DTAX:	DW	0
F061                
F061                ZERO:
F061                BEEPD:
F061 00 8E 01 00    	DB	0,08EH,1,0,00BH,0,00CH,010H
F065 0B 00 0C 10
F069 07 3E 08 10    	DB	007H,03EH,008H,010H,00DH,0,0FFH
F06D 0D 00 FF
F070 00 00 F0 62    RTC_YY	EQU	BEEPD+1
F070 00 00 F0 63    RTC_MW	EQU	BEEPD+2
F070 00 00 F0 64    RTC_DD	EQU	BEEPD+3
F070 00 00 F0 65    RTC_TT	EQU	BEEPD+4
F070 00 00 F0 66    RTC_MM	EQU	BEEPD+5
F070 00 00 F0 67    RTC_SS	EQU	BEEPD+6
F070 00 00 F0 62    ROM_SLT	EQU	BEEPD+1
F070                
F070 00             CHECK:	DB	0
F071                
F071 4F 4B 24       OK:	DB	"OK$"
F074                	DS	5
F079 45 72 72 6F    COMERM:	DB	"Error!$"
F07D 72 21 24
F080                ;	システムワークエリア
F080                ;	_CYL0:アドレス下位1バイトが080Hになるように
F080 FF             _CYL0:	DB	0FFH	;Cylinder
F081 FF             _CYL1:	DB	0FFH	;Cylinder
F082 FF             _CYL2:	DB	0FFH	;Cylinder
F083 FF             _CYL3:	DB	0FFH	;Cylinder
F084 00             _DRIVE:	DB	0	;unit number
F085 00             _SEEKSP:DB	0	;Seek speed
F086 FF             _ISEEK:	DB	0FFH	;
F087 00             _DVSW:	DB	0
F088 00             _DRV:	DB	0
F089 FF             _DSK:	DB	0FFH
F08A 80 00          _DTA:	DW	00080H
F08C 00 00          _CTC:	DW	0
F08E 00 00          _TXADR:	DW	0
F090 00 00          _KEYPS:	DW	0
F092 00 FF          _KEYD:	DW	0FF00H	;キーデータ
F094 C2 10          _KEYSP:	DB	KEYSP_L,KEYSP_H	;オートリピートの速度
F096 07             _COLORF:DB	COLORF	;色
F097 18             _LINE:	DB	LINE
F098                
F098 00 00          _FCB:	DW	0	;SEARCH FILES
F09A 00 00          _FBPS:	DW	0	;    //
F09C 00 00          _FBAD:	DW	0	;    //
F09E 00             _FBCNT:	DB	0	;    //
F09F 00             _FILEN:	DB	0	;    //
F0A0 00             _DIRF:	DB	0	;bit7:ディレクトリ bit0-6:セクタインデックス
F0A1                	DS	1
F0A2 00             _WTFATF:DB	0	;FATバッファの更新フラグ
F0A3                	DS	1
F0A4 00             _WTDBF:	DB	0	;データバッファの更新フラグ
F0A5 FF             _DBDRV:	DB	0FFH	;データバッファにあるデータを読み込んだドライブ
F0A6 00 00          _DBSEC:	DW	0	;データバッファにあるデータを読み込んだセクタ番号
F0A8 00 00          _DPB:	DW	0
F0AA                _FATDRV:
F0AA FF             	DB	0FFH	;FATバッファに読み込んでいるドライブ
F0AB 00             _FATIX:	DB	0	;FATバッファに読み込んでいるインデックス
F0AC                _FAKEFREE:
F0AC 00 00          	DW	0	;偽の残量（FATサイズが大きくなると重くなるのでその対策）
F0AE                
F0AE                	DS	2
F0B0                
F0B0                CRTCD:
F0B0 6F             	DB	06FH
F0B1                _WIDTH:
F0B1 50             	DB	WIDTH
F0B2                TVRAMTOP:
F0B2 59 38          	DB	059H,038H
F0B4 1F 02          	DB	01FH,002H
F0B6                _LINE2:
F0B6 19             	DB	019H
F0B7                WKE4:
F0B7 1C             	DB	01CH
F0B8                WKE6:
F0B8 00             	DB	000H
F0B9                WK40:
F0B9 07             	DB	007H
F0BA                _PAGE_MINUS:
F0BA 80 F8          	DW	0-WIDTH*LINE
F0BC                _WIDTH_MINUS:
F0BC B0 FF          	DW	0-WIDTH
F0BE                WK30:
F0BE 0C             	DB	00CH
F0BF                WK31:
F0BF                WK1FD0:
F0BF 20             	DB	020H
F0C0                
F0C0 5C DB          CTC0:	DW	INTCTCE
F0C2 5C DB          CTC1:	DW	INTCTCE
F0C4 5C DB          CTC2:	DW	INTCTCE
F0C6 5C DB          CTC3:	DW	INTCTCE
F0C8 48 DB          INTVEC:	DW	INT
F0CA                
F0CA                ;	LSX-Dodgers 独自BIOS
F0CA                
F0CA C3 7F E0       _INKEY:	JP	INKEY
F0CD C3 37 DD       _PRINT:	JP	PRINT
F0D0 C3 E7 DF       _SCRN:	JP	SCRN
F0D3 C3 11 E0       _POS:	JP	POS
F0D6 C3 65 DE       _LOC:	JP	LOC
F0D9                _CHGDRV:
F0D9 C3 0D ED       	JP	CHGDRV
F0DC                _GETDPB:
F0DC C3 CC ED       	JP	GETDPB
F0DF                _FFLUSH:
F0DF C3 EA ED       	JP	FFLUSH
F0E2                _RDFATX:
F0E2 C3 E6 E9       	JP	RDFATX
F0E5 C3 0E EB       _RDFAT:	JP	RDFAT
F0E8 C3 D6 EE       _WTTRK:	JP	WTTRK
F0EB C3 EA EE       _FDRD:	JP	FDRD
F0EE C3 DC EE       _FDWT:	JP	FDWT
F0F1                _BPB2DPB:
F0F1 C3 9B EB       	JP	BPB2DPB
F0F4                _BREAK:
F0F4 C3 C3 D4       	JP	END_BATCH
F0F7                _GNCL:
F0F7 C3 88 EA       	JP	GNCL		; self-modifying code
F0FA 00 00 F0 F8    GNCPAT	EQU	$-2
F0FA                _SNCL:
F0FA C3 AB EA       	JP	SNCL		; self-modifying code
F0FD 00 00 F0 FB    SNCPAT	EQU	$-2
F0FD C3 7C D3       _COMANL:JP	COMANL
F100                
F100                _WE:
F100                	INCLUDE	"LDCALL.ASM"
F100                
F100                ;	LSX-Dodgers システムコール(BDOS)
F100                ;
F100                ;	LSX-Dodgers SYSTEM CALL
F100                ;	STABLE:アドレス下位1バイトが0になるように
F100                
F100                STABLE:
F100                ;0
F100 03 F0 9F DB    	DW	_SYS00,_SYS01,_SYS02,_SYS03
F104 AB DB 41 E2
F108 93 D8 93 D8    	DW	_SYS04,_SYS05,_SYS06,_SYS07
F10C B0 DB 09 F0
F110 B8 DB 95 D8    	DW	_SYS08,_SYS09,_SYS0A,_SYS0B
F114 23 DC 4F DC
F118 AA D8 AF D8    	DW	_SYS0C,_SYS0D,_SYS0E,_SYS0F
F11C BE D8 CF D8
F120                ;1
F120 23 D9 6A D9    	DW	_SYS10,_SYS11,_SYS12,_SYS13
F124 B3 D9 E4 D9
F128 EC D9 02 DA    	DW	_SYS14,_SYS15,_SYS16,_SYS17
F12C 17 DA 0F DA
F130 5E DA 63 DA    	DW	_SYS18,_SYS19,_SYS1A,_SYS1B
F134 68 DA 6E DA
F138 93 D8 94 DA    	DW	_SYS1C,_SYS1D,_SYS1E,_SYS1F
F13C 93 D8 98 DA
F140                ;2
F140 93 D8 4E DA    	DW	_SYS20,_SYS21,_SYS22,_SYS23
F144 56 DA 9F DA
F148 C5 DA 93 D8    	DW	_SYS24,_ERROR,_SYS26,_SYS27
F14C BA E6 92 E7
F150 56 DA CE DA    	DW	_SYS28,_SYS29,_SYS2A,_SYS2B
F154 65 DC 41 E2
F158 88 DC 41 E2    	DW	_SYS2C,_SYS2D,_SYS2E,_SYS2F
F15C 93 D8 EF DA
F160                ;3
F160 E9 DA 93 D8    	DW	_SYS30,_ERROR,_ERROR,_ERROR
F164 93 D8 93 D8
F168 93 D8 93 D8    	DW	_ERROR,_ERROR,_ERROR,_ERROR
F16C 93 D8 93 D8
F170 93 D8 41 E2    	DW	_ERROR,_SYS39,_SYS3A,_SYS5A
F174 41 E2 10 DB
F178                ;DOS2
F178 76 D8          	DW	_DOS2
F17A                
F17A                	DS	2
F17C 00 F3          _FATBF:	DW	FATBF
F17E 00 FB          _DTBUF:	DW	DTBUF
F180                
F180                ;	コントロールコードテーブル
F180                ;	CTRLTB:アドレス下位1バイトが080Hになるように
F180                
F180                CTRLTB:
F180 DA DD DA DD    	DW	CTRL00,CTRL00,CTRL02,CTRL03	;  A,B,C
F184 16 DE 5B DF
F188 55 DF 3A DE    	DW	CTRL04,CTRL05,CTRL06,CTRL07	;D,E,F,G
F18C 34 DF BD DE
F190 E6 DD 07 DE    	DW	CTRL08,CTRL09,CTRL0A,CTRL0B	;H,I,J,K
F194 5E DF 7B DE
F198 31 DF 60 DE    	DW	CTRL0C,CTRL0D,CTRL0E,CTRL00	;L,M,N,O
F19C 73 DF DA DD
F1A0 DA DD DA DD    	DW	CTRL00,CTRL00,CTRL12,CTRL00	;P,Q,R,S
F1A4 73 DE DA DD
F1A8 DA DD DA DD    	DW	CTRL00,CTRL00,CTRL00,CTRL00	;T,U,V,W
F1AC DA DD DA DD
F1B0 DA DD DA DD    	DW	CTRL00,CTRL00,CTRL0C,CTRL1B	;X,Y,Z,ESC
F1B4 31 DF 82 DE
F1B8 01 DE ED DD    	DW	CTRL1C,CTRL1D,CTRL1E,CTRL1F	;→,←,↑,↓
F1BC F6 DD 5E DF
F1C0                
F1C0 02 00          M2D:	DW	2
F1C2 FD 02          	DB	0FDH,2
F1C4 64 01          	DW	356
F1C6 FF 07 28 09    	DB	0FFH,7,40,9,1,082H
F1CA 01 82
F1CC 05 00 A7 00    	DW	5,0A7H,8
F1D0 08 00
F1D2                
F1D2 02 00          M2HD:	DW	2
F1D4 FE 01          	DB	0FEH,1
F1D6 C7 04          	DW	1223
F1D8 FE 06 4D 08    	DB	0FEH,6,77,8,1,084H
F1DC 01 84
F1DE 05 00 A7 00    	DW	5,0A7H,9
F1E2 09 00
F1E4                
F1E4 16 17          SDDATA:	DB	22,23		;(FCB)ファイルを最後に変更した時刻
F1E6 14 15          	DB	20,21		;(FCB)ファイルを最後に変更した日付
F1E8 1A 1B          	DB	26,27		;(FCB)ファイルの先頭クラスタ
F1EA 10 11 12 13    	DB	16,17,18,19	;(FCB)ファイルのサイズ(バイト単位)
F1EE                SDDATAE:
F1EE                
F1EE                	DS	2
F1F0                _FCB_BAT:
F1F0 C6 EF          	DW	FCB_BAT
F1F2                _PATH:
F1F2 65 EF          	DW	PATHD
F1F4                
F1F4                SCDIR:	DS	2		;+14 +15
F1F6                SFBPS:	DS	2		;FBPS
F1F8                SFNDF:	DS	2		;FILEN DIRF
F1FA                
F1FA 00 00          _FATPS:	DW	0
F1FC 00 00          _DIRPS:	DW	0
F1FE 00 00          _CLPS:	DW	0
F200                
F200                _PE:
F200                	INCLUDE	"X1DPB.ASM"
F200                
F200                ;	LSX-Dodgers DPB
F200                ;	X1/turbo/Z
F200                
F200                _DEVICE:
F200                
F200                ;	A:
F200                
F200 02 00          	DW	2	;DPB_FATLN
F202 EB F0          	DW	_FDRD	;DPB_DRD
F204 EE F0          	DW	_FDWT	;DPB_DWT
F206 FD             	DB	0FDH	;DPB_FATID
F207 02             	DB	2	;DPB_SECPCL
F208 64 01          	DW	356	;DPB_MAXCL
F20A FF             	DB	0FFH	;DPB_FDMODE	0FFH=2D / 0FEH=2HD
F20B 07             	DB	7	;DPB_DIRSCNT
F20C 28             	DB	40	;DPB_MAXCYL
F20D 09             	DB	9	;DPB_MAXSEC	Number of sectors
F20E 01             	DB	1	;DPB_FATPS
F20F 82             	DB	082H	;DPB_BPS
F210 05 00          	DW	5	;DPB_DIRPS
F212 A7             	DB	0A7H	;DPB_DEVICE	Device Number
F213 00             	DB	0	;DPB_UNITNO
F214 08 00          	DW	8	;DPB_ADDCL
F216 00 00          	DW	0	;DPB_16
F218 00 00          	DW	0	;DPB_18
F21A 00 00          	DW	0	;DPB_SDIR
F21C 46 44 44 30    	DB	"FDD0"	;DPB_NAME
F220                
F220                ;	B:
F220                
F220 02 00          	DW	2	;DPB_FATLN
F222 EB F0          	DW	_FDRD	;DPB_DRD
F224 EE F0          	DW	_FDWT	;DPB_DWT
F226 FD             	DB	0FDH	;DPB_FATID
F227 02             	DB	2	;DPB_SECPCL
F228 64 01          	DW	356	;DPB_MAXCL
F22A FF             	DB	0FFH	;DPB_FDMODE	0FFH=2D / 0FEH=2HD
F22B 07             	DB	7	;DPB_DIRSCNT
F22C 28             	DB	40	;DPB_MAXCYL
F22D 09             	DB	9	;DPB_MAXSEC	Number of sectors
F22E 01             	DB	1	;DPB_FATPS
F22F 82             	DB	082H	;DPB_BPS
F230 05 00          	DW	5	;DPB_DIRPS
F232 A7             	DB	0A7H	;DPB_DEVICE	Device Number
F233 01             	DB	1	;DPB_UNITNO
F234 08 00          	DW	8	;DPB_ADDCL
F236 00 00          	DW	0	;DPB_16
F238 00 00          	DW	0	;DPB_18
F23A 00 00          	DW	0	;DPB_SDIR
F23C 46 44 44 31    	DB	"FDD1"	;DPB_NAME
F240                
F240                ;	C:
F240                
F240 02 00          	DW	2	;DPB_FATLN
F242 EB F0          	DW	_FDRD	;DPB_DRD
F244 EE F0          	DW	_FDWT	;DPB_DWT
F246 FD             	DB	0FDH	;DPB_FATID
F247 02             	DB	2	;DPB_SECPCL
F248 64 01          	DW	356	;DPB_MAXCL
F24A FF             	DB	0FFH	;DPB_FDMODE	0FFH=2D / 0FEH=2HD
F24B 07             	DB	7	;DPB_DIRSCNT
F24C 28             	DB	40	;DPB_MAXCYL
F24D 09             	DB	9	;DPB_MAXSEC	Number of sectors
F24E 01             	DB	1	;DPB_FATPS
F24F 82             	DB	082H	;DPB_BPS
F250 05 00          	DW	5	;DPB_DIRPS
F252 A7             	DB	0A7H	;DPB_DEVICE	Device Number
F253 02             	DB	2	;DPB_UNITNO
F254 08 00          	DW	8	;DPB_ADDCL
F256 00 00          	DW	0	;DPB_16
F258 00 00          	DW	0	;DPB_18
F25A 00 00          	DW	0	;DPB_SDIR
F25C 46 44 44 32    	DB	"FDD2"	;DPB_NAME
F260                
F260                ;	D:
F260                
F260 02 00          	DW	2	;DPB_FATLN
F262 EB F0          	DW	_FDRD	;DPB_DRD
F264 EE F0          	DW	_FDWT	;DPB_DWT
F266 FD             	DB	0FDH	;DPB_FATID
F267 02             	DB	2	;DPB_SECPCL
F268 64 01          	DW	356	;DPB_MAXCL
F26A FF             	DB	0FFH	;DPB_FDMODE	0FFH=2D / 0FEH=2HD
F26B 07             	DB	7	;DPB_DIRSCNT
F26C 28             	DB	40	;DPB_MAXCYL
F26D 09             	DB	9	;DPB_MAXSEC	Number of sectors
F26E 01             	DB	1	;DPB_FATPS
F26F 82             	DB	082H	;DPB_BPS
F270 05 00          	DW	5	;DPB_DIRPS
F272 A7             	DB	0A7H	;DPB_DEVICE
F273 03             	DB	3	;DPB_UNITNO
F274 08 00          	DW	8	;DPB_ADDCL
F276 00 00          	DW	0	;DPB_16
F278 00 00          	DW	0	;DPB_18
F27A 00 00          	DW	0	;DPB_SDIR
F27C 46 44 44 33    	DB	"FDD3"	;DPB_NAME
F280                
F280                ;	E:
F280                
F280 00 00          EMMFL:	DW	0	;DPB_FATLN
F282 31 D8          EMMRD:	DW	EDRD	;DPB_DRD
F284 1D D8          EMMWR:	DW	EDWT	;DPB_DWT
F286 FE             	DB	0FEH	;DPB_FATID
F287 02             	DB	2	;DPB_SECPCL
F288 00 00          EMMCL:	DW	0	;DPB_MAXCL
F28A 00             	DB	0	;DPB_FDMODE
F28B 0C             	DB	12	;DPB_DIRSCNT
F28C 00             	DB	0	;DPB_MAXCYL
F28D 00             	DB	0	;DPB_MAXSEC
F28E 02             	DB	2	;DPB_FATPS
F28F 02             	DB	2	;DPB_BPS
F290 0A 00          	DW	10	;DPB_DIRPS
F292 06             	DB	6	;DPB_DEVICE
F293 00             	DB	0	;DPB_UNITNO
F294 12 00          	DW	18	;DPB_ADDCL
F296 00 00          	DW	0	;DPB_16
F298 00 00          	DW	0	;DPB_18
F29A 00 00          	DW	0	;DPB_SDIR
F29C 45 4D 4D 30    	DB	"EMM0"	;DPB_NAME
F2A0                
F2A0                ;	F:
F2A0                
F2A0 00 00          BANKFL:	DW	0	;DPB_FATLN
F2A2 B5 D7          	DW	BDRD	;DPB_DRD
F2A4 B1 D7          	DW	BDWT	;DPB_DWT
F2A6 F9             	DB	0F9H	;DPB_FATID
F2A7 02             	DB	2	;DPB_SECPCL
F2A8 00 00          BANKCL:	DW	0	;DPB_MAXCL
F2AA 00             	DB	0	;DPB_FDMODE
F2AB 08             	DB	8	;DPB_DIRSCNT
F2AC 00             	DB	0	;DPB_MAXCYL
F2AD 01             	DB	1	;DPB_MAXSEC
F2AE 00             	DB	0	;DPB_FATPS
F2AF 02             	DB	2	;DPB_BPS
F2B0 02 00          	DW	2	;DPB_DIRPS
F2B2 0B             BANKDV:	DB	00BH	;DPB_DEVICE
F2B3 00             	DB	0	;DPB_UNITNO
F2B4 06 00          	DW	6	;DPB_ADDCL
F2B6 00 00          	DW	0	;DPB_16
F2B8 00 00          	DW	0	;DPB_18
F2BA 00 00          	DW	0	;DPB_SDIR
F2BC 42 52 41 4D    	DB	"BRAM"	;DPB_NAME
F2C0                
F2C0                ;	G:
F2C0                
F2C0 02 00          	DW	2	;DPB_FATLN
F2C2 72 D7          	DW	GDRD	;DPB_DRD
F2C4 89 D7          	DW	GDWT	;DPB_DWT
F2C6 FA             	DB	0FAH	;DPB_FATID
F2C7 01             	DB	1	;DPB_SECPCL
F2C8 B8 00          	DW	184	;DPB_MAXCL
F2CA 00             	DB	0	;DPB_FDMODE
F2CB 07             	DB	7	;DPB_DIRSCNT
F2CC 00             	DB	0	;DPB_MAXCYL
F2CD 01             	DB	1	;DPB_MAXSEC
F2CE 01             	DB	1	;DPB_FATPS
F2CF 01             	DB	1	;DPB_BPS
F2D0 03 00          	DW	3	;DPB_DIRPS
F2D2 05             	DB	5	;DPB_DEVICE
F2D3 01             	DB	1	;DPB_UNITNO
F2D4 08 00          	DW	8	;DPB_ADDCL
F2D6 00 00          	DW	0	;DPB_16
F2D8 00 00          	DW	0	;DPB_18
F2DA 00 00          	DW	0	;DPB_SDIR
F2DC 47 52 41 4D    	DB	"GRAM"	;DPB_NAME
F2E0                
F2E0                ;	H:
F2E0                	DS	32-8
F2F8 00             	DB	0
F2F9                
F2F9                LAST_ADR:
F2F9                
F2F9                	END
F2F9                
