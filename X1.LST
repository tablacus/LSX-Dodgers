0000                ;	LSX-Dodgers for X1/turbo/Z
0000                ;	Programmed by
0000                ;	Gaku (Lovers/Tablacus)
0000                
0000                	INCLUDE	"X1DEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                ;	X1/turbo/Z
0000                
0000 00 00 00 00    MAC	EQU	0		;X1
0000 00 00 00 00    DEV EQU 0
0000                
0000 00 00 CC 00    RUN	EQU	0CC00H
0000 00 00 D2 06    BDOS	EQU	0D206H
0000 00 00 F0 00    WORKAD	EQU	0F000H
0000 00 00 F3 00    FATBF	EQU	0F300H
0000 00 00 FB 00    DTBUF	EQU	0FB00H
0000 00 00 FF 00    KEYBF	EQU	0FF00H
0000 00 00 FF 20    KBUF	EQU	0FF20H
0000 00 00 FF CA    EXTSP	EQU	0FFCAH
0000 00 00 FF D9    TRAP38	EQU	0FFD9H
0000 00 00 00 50    WIDTH	EQU	80
0000 00 00 00 18    LINE	EQU	24
0000 00 00 00 07    COLORF	EQU	7
0000 00 00 00 10    KEYSP_H	EQU	16
0000 00 00 00 C2    KEYSP_L	EQU	0C2H
0000 00 00 00 09    COMS	EQU	9
0000                
0000                	INCLUDE	"LDDEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                
0000 00 00 00 01    VER_1   EQU	1
0000 00 00 00 05    VER_2   EQU	5
0000 00 00 00 03    VER_3   EQU	3
0000 00 00 1D 00    MACW	EQU	MAC + 01D00H	;機種フラグとLD判別フラグ
0000 00 00 00 00    MACD	EQU	MAC + DEV * 256	;機種フラグとデバイスフラグ
0000 00 00 01 53    VER	EQU	VER_1 * 256 + VER_2 * 16 + VER_3
0000                
0000 00 00 00 05    SYSTEM	EQU	00005H
0000 00 00 00 0F    JP_HL	EQU	0000FH
0000 00 00 00 5C    FCB1	EQU	0005CH
0000 00 00 00 6C    FCB2	EQU	0006CH
0000 00 00 00 5D    FCB1FN	EQU	FCB1+1
0000 00 00 00 6D    FCB2FN	EQU	FCB2+1
0000 00 00 00 80    DTA1	EQU	00080H
0000                
0000 00 00 FF CA    EXTBIO	EQU	0FFCAH
0000                
0000                
0000                	ORG	RUN-7
CBF9                
CBF9                ;	MSX BINARY HEADER
CBF9 FE             	DB	0FEH
CBFA                ;	MSX BINARY START ADDRESS
CBFA 00 CC          	DW	RUN
CBFC                ;	MSX BINARY END ADDRESS
CBFC F9 F2          	DW	LAST_ADR
CBFE                ;	MSX BINARY EXEC ADDRESS
CBFE 07 CC          	DW	START
CC00                
CC00                	INCLUDE	"X1INIT.ASM"
CC00                
CC00                ;	LSX-Dodgers INIT
CC00                ;	X1/turbo/Z
CC00                
CC00 C3 07 CC       	JP	START
CC03 00 1D          	DW	MACW
CC05 53 01          	DW	VER
CC07                
CC07                START:
CC07 F3             	DI
CC08 ED 5E          	IM	2
CC0A 31 CA FF       	LD	SP,EXTSP
CC0D CD 1B CC       	CALL	INIT		;NZならAUTOEXECを実行
CC10 21 00 00       	LD	HL,0
CC13 E5             	PUSH	HL
CC14 C8             	RET	Z
CC15 11 99 CF       	LD	DE,AUTOD
CC18 C3 FD F0       	JP	_COMANL
CC1B                
CC1B                INIT:
CC1B 3E 1E          	LD	A,01EH
CC1D D3 00          	OUT	(0),A
CC1F                
CC1F 01 00 00       	LD	BC,0
CC22 ED 43 8C F0    	LD	(_CTC),BC
CC26 01 04 0A       	LD	BC,00A04H
CC29 CD 43 CF       	CALL	CHKCTC
CC2C 01 04 07       	LD	BC,00704H
CC2F CD 43 CF       	CALL	CHKCTC
CC32 01 A8 1F       	LD	BC,01FA8H
CC35 CD 43 CF       	CALL	CHKCTC
CC38 01 A0 1F       	LD	BC,01FA0H
CC3B CD 43 CF       	CALL	CHKCTC
CC3E                ;
CC3E                INISIO:
CC3E 01 91 1F       	LD	BC,01F91H	;INIT SIO
CC41 16 01          	LD	D,1
CC43 ED 51          	OUT	(C),D
CC45                
CC45 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CC47 0E 93          	LD	C,093H
CC49 ED 51          	OUT	(C),D
CC4B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CC4D 0E 99          	LD	C,099H		;INIT SIO
CC4F 16 01          	LD	D,1
CC51 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CC53 0E 9B          	LD	C,09BH
CC55 ED 51          	OUT	(C),D
CC57 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CC59                
CC59 0E 80          	LD	C,080H		;INIT DMA
CC5B 21 06 C3       	LD	HL,0C306H
CC5E                INIDMA:
CC5E ED 61          	OUT	(C),H
CC60 2D             	DEC	L
CC61 20 FB          	JR	NZ,INIDMA
CC63                
CC63 3E E4          	LD	A,0E4H
CC65 CD D9 DE       	CALL	COMOUT
CC68 AF             	XOR	A
CC69 CD B3 DE       	CALL	OT49SB
CC6C                
CC6C 3E F0          	LD	A,INTVEC/256
CC6E ED 47          	LD	I,A
CC70                
CC70 ED 4B 8C F0    	LD	BC,(_CTC)
CC74 0D             	DEC	C
CC75 0D             	DEC	C
CC76                
CC76 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CC78 3E C0          	LD	A,CTC0
CC7A ED 79          	OUT	(C),A
CC7C                
CC7C 0C             	INC	C
CC7D 3E 47          	LD	A,047H
CC7F ED 79          	OUT	(C),A
CC81 3E 0D          	LD	A,13		;Baudrate 9600-13
CC83 ED 79          	OUT	(C),A
CC85                
CC85 79             	LD	A,C
CC86 D6 10          	SUB	010H
CC88 4F             	LD	C,A
CC89                ;	LD	(SIOAD+1),BC
CC89                ;	LD	(SIOAD0+1),BC
CC89                ;	LD	(SIOAD1+1),BC
CC89                
CC89 21 E9 CF       	LD	HL,SIODATA
CC8C                SINIT1:
CC8C 7E             	LD	A,(HL)
CC8D 23             	INC	HL
CC8E FE FF          	CP	0FFH
CC90 28 04          	JR	Z,SINIT2
CC92 ED 79          	OUT	(C),A
CC94 18 F6          	JR	SINIT1
CC96                SINIT2:
CC96 3E E4          	LD	A,0E4H
CC98 CD D9 DE       	CALL	COMOUT
CC9B 3E C8          	LD	A,INTVEC
CC9D CD B3 DE       	CALL	OT49SB
CCA0                ;
CCA0 01 C4 1F       	LD	BC,01FC4H
CCA3 3E 0C          	LD	A,00CH
CCA5 ED 79          	OUT	(C),A
CCA7                
CCA7 0E C0          	LD	C,0C0H
CCA9 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCAB                
CCAB 0C             	INC	C
CCAC 3E 28          	LD	A,40
CCAE ED 79          	OUT	(C),A
CCB0                
CCB0 0C             	INC	C
CCB1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCB3                
CCB3 0C             	INC	C
CCB4 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCB6                
CCB6 0E C5          	LD	C,0C5H
CCB8 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCBA                
CCBA                TEXT:
CCBA 0E B0          	LD	C,0B0H
CCBC 3E 80          	LD	A,080H
CCBE ED 79          	OUT	(C),A
CCC0 16 07          	LD	D,7
CCC2 0E B9          	LD	C,0B9H
CCC4 21 E2 CF       	LD	HL,TEXTDT
CCC7                TEXT1:
CCC7 04             	INC	B
CCC8 ED A3          	OUTI
CCCA 0C             	INC	C
CCCB 15             	DEC	D
CCCC 20 F9          	JR	NZ,TEXT1
CCCE 01 B0 1F       	LD	BC,01FB0H
CCD1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCD3                
CCD3 0E C4          	LD	C,0C4H
CCD5 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCD7                
CCD7 01 01 1A       	LD	BC,01A01H
CCDA ED 78          	IN	A,(C)
CCDC E6 08          	AND	8
CCDE 28 09          	JR	Z,PRN
CCE0 0E 03          	LD	C,003H
CCE2 3E 0F          	LD	A,00FH
CCE4 ED 79          	OUT	(C),A
CCE6 01 04 0A       	LD	BC,00A04H
CCE9                PRN:
CCE9 21 00 00       	LD	HL,0
CCEC 06 5C          	LD	B,05CH
CCEE 3E FF          	LD	A,0FFH		;RST 38H
CCF0 CD 33 E1       	CALL	FILL_MEMORY
CCF3 06 A4          	LD	B,0A4H
CCF5 AF             	XOR	A
CCF6 CD 33 E1       	CALL	FILL_MEMORY
CCF9                
CCF9 3E C3          	LD	A,0C3H		;JP
CCFB 21 03 F0       	LD	HL,CPM_WBOOT
CCFE 32 00 00       	LD	(00000H),A
CD01 22 01 00       	LD	(00001H),HL	;IPL
CD04                
CD04 21 00 1D       	LD	HL,MACW	;3 bit7  DPB Compatible LA(1)
CD07 22 03 00       	LD	(00003H),HL	;  bit6-0 Machine X1(0)
CD0A                ;				;4 LSX-Dodgers(01DH)
CD0A 21 06 D2       	LD	HL,BDOS
CD0D 32 05 00       	LD	(00005H),A
CD10 22 06 00       	LD	(00006H),HL	;BDOS
CD13                
CD13 21 F7 DA       	LD	HL,BIOS
CD16 22 19 00       	LD	(00019H),HL	;BIOS-ROM
CD19                
CD19 21 D9 FF       	LD	HL,TRAP38	;TRAP38
CD1C 32 38 00       	LD	(00038H),A
CD1F 22 39 00       	LD	(00039H),HL	;RST 038H
CD22                
CD22 3E F0          	LD	A,CPM_BOOT/256
CD24 32 0B 00       	LD	(0000BH),A
CD27                
CD27 3E E9          	LD	A,0E9H		;JP (HL)
CD29 32 0F 00       	LD	(0000FH),A
CD2C                
CD2C 3E E6          	LD	A,0E6H
CD2E CD D9 DE       	CALL	COMOUT
CD31 CD BE DE       	CALL	IN49SB
CD34 F5             	PUSH	AF
CD35 CD BE DE       	CALL	IN49SB
CD38 F1             	POP	AF
CD39 F5             	PUSH	AF
CD3A E6 12          	AND	012H
CD3C 20 05          	JR	NZ,KEYR
CD3E 3E 01          	LD	A,1
CD40 32 96 CE       	LD	(KEYREP+1),A
CD43                KEYR:
CD43 F1             	POP	AF
CD44 E6 03          	AND	3
CD46 28 0E          	JR	Z,NON
CD48                
CD48 01 D0 3F       	LD	BC,03FD0H
CD4B ED 49          	OUT	(C),C
CD4D 3E 37          	LD	A,037H
CD4F D3 D0          	OUT	(0D0H),A
CD51 ED 78          	IN	A,(C)
CD53 B9             	CP	C
CD54 28 65          	JR	Z,TURBO
CD56                NON:
CD56 21 1C D0       	LD	HL,AT_SCR1
CD59 11 63 DF       	LD	DE,SCR1
CD5C 01 94 00       	LD	BC,SCRNE-SCR1	;転送先のサイズ確認用
CD5F 01 85 00       	LD	BC,AT_SCRE-AT_SCR1
CD62 ED B0          	LDIR
CD64                
CD64 21 A1 D0       	LD	HL,AT_DWT
CD67 11 D7 EE       	LD	DE,WTTRK
CD6A 01 8F 00       	LD	BC,DMAE-WTTRK	;転送先のサイズ確認用
CD6D 01 8E 00       	LD	BC,AT_CPUE-AT_DWT
CD70 ED B0          	LDIR
CD72                
CD72 21 2F D1       	LD	HL,AT_EDWT
CD75 11 E4 D7       	LD	DE,EDWT
CD78 01 4B 00       	LD	BC,EMME-EDWT	;転送先のサイズ確認用
CD7B 01 46 00       	LD	BC,AT_EMME-AT_EDWT
CD7E ED B0          	LDIR
CD80                
CD80 21 DE DF       	LD	HL,AT_WTTRK+AT_RS
CD83 22 E9 F0       	LD	(_WTTRK+1),HL
CD86 21 20 EF       	LD	HL,AT_DRD+AT_R
CD89 22 EC F0       	LD	(_FDRD+1),HL
CD8C 21 D7 EE       	LD	HL,AT_DWT+AT_R
CD8F 22 EF F0       	LD	(_FDWT+1),HL
CD92 21 F8 D7       	LD	HL,AT_EDRD+AT_RE
CD95 22 82 F2       	LD	(EMMRD),HL
CD98 21 E4 D7       	LD	HL,AT_EDWT+AT_RE
CD9B 22 84 F2       	LD	(EMMWR),HL
CD9E 21 E5 DF       	LD	HL,AT_SCRN+AT_RS
CDA1 22 D1 F0       	LD	(_SCRN+1),HL
CDA4                
CDA4 3E 27          	LD	A,027H			;ノンターボはMFM切り替えを行わない
CDA6 32 12 F2       	LD	(DEVICE+012H),A		;Aドライブ
CDA9 32 32 F2       	LD	(DEVICE+012H+32),A	;Bドライブ
CDAC 32 52 F2       	LD	(DEVICE+012H+32*2),A	;Cドライブ
CDAF 32 72 F2       	LD	(DEVICE+012H+32*3),A	;Dドライブ
CDB2                
CDB2 21 00 00       	LD	HL,0
CDB5 22 04 DF       	LD	(X1PAT),HL
CDB8 C3 44 CE       	JP	NOBANK
CDBB                
CDBB                TURBO:
CDBB F3             	DI			;Check BIOS
CDBC 06 1D          	LD	B,01DH
CDBE ED 79          	OUT	(C),A		;BIOS ON
CDC0 3A 51 2F       	LD	A,(02F51H)
CDC3 04             	INC	B		;B=01EH
CDC4 ED 79          	OUT	(C),A		;BIOS OFF
CDC6 FB             	EI
CDC7 FE C9          	CP	0C9H
CDC9 28 02          	JR	Z,BIOSOK
CDCB 18 05          	JR	NOBIOS
CDCD                BIOSOK:
CDCD 3E C3          	LD	A,0C3H		;JP
CDCF 32 18 00       	LD	(00018H),A
CDD2                NOBIOS:
CDD2 3E 1F          	LD	A,01FH		;スタートポート
CDD4 DB F0          	IN	A,(0F0H)
CDD6 0F             	RRCA
CDD7 38 0B          	JR	C,CRT1
CDD9 21 D2 CF       	LD	HL,_C8025H
CDDC 11 B0 F0       	LD	DE,CRTCD
CDDF 01 10 00       	LD	BC,16
CDE2 ED B0          	LDIR
CDE4                CRT1:
CDE4 3E 1F          	LD	A,01FH		;スタートポート
CDE6 DB F0          	IN	A,(0F0H)
CDE8 CB 57          	BIT	2,A
CDEA 28 18          	JR	Z,BANK
CDEC                
CDEC AF             	XOR	A
CDED                TZ1:				;前面スイッチが2HDの場合はMFMモードを2HDにしておく
CDED F5             	PUSH	AF
CDEE CD DC F0       	CALL	_GETDPB
CDF1 DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
CDF4 E6 8F          	AND	08FH
CDF6 FE 87          	CP	087H		;フロッピーでMEM切り替えがON
CDF8 20 04          	JR	NZ,TZ2
CDFA DD CB 0A 86    	RES	0,(IX+0AH)	;(DPB_0A_FDMODE)
CDFE                TZ2:
CDFE F1             	POP	AF
CDFF 3C             	INC	A
CE00 FE 08          	CP	8
CE02 38 E9          	JR	C,TZ1
CE04                
CE04                BANK:
CE04 01 00 0B       	LD	BC,00B00H
CE07 21 00 7F       	LD	HL,07F00H
CE0A F3             	DI
CE0B ED 69          	OUT	(C),L
CE0D 3A 00 00       	LD	A,(0)
CE10 FE EB          	CP	0EBH
CE12 20 05          	JR	NZ,BANK1
CE14 3E 2B          	LD	A,02BH
CE16 32 B2 F2       	LD	(BANKDV),A
CE19                BANK1:
CE19 ED 69          	OUT	(C),L
CE1B 5E             	LD	E,(HL)
CE1C 7B             	LD	A,E
CE1D C6 A5          	ADD	A,0A5H
CE1F 77             	LD	(HL),A
CE20 BE             	CP	(HL)
CE21 73             	LD	(HL),E
CE22 20 05          	JR	NZ,BANK2
CE24 2C             	INC	L
CE25 CB 65          	BIT	4,L
CE27 28 F0          	JR	Z,BANK1
CE29                BANK2:
CE29 3E 10          	LD	A,010H
CE2B ED 79          	OUT	(C),A
CE2D 7D             	LD	A,L
CE2E B7             	OR	A
CE2F 28 13          	JR	Z,NOBANK
CE31 26 00          	LD	H,0
CE33 29             	ADD	HL,HL	;*2
CE34 29             	ADD	HL,HL	;*4
CE35 29             	ADD	HL,HL	;*8
CE36 29             	ADD	HL,HL	;*16
CE37 29             	ADD	HL,HL	;*32
CE38 2B             	DEC	HL	;-1
CE39 2B             	DEC	HL	;-2
CE3A 2B             	DEC	HL	;-3
CE3B 22 A8 F2       	LD	(BANKCL),HL
CE3E CD 89 CF       	CALL	CALC_FATLN
CE41 32 A0 F2       	LD	(BANKFL),A
CE44                NOBANK:
CE44                EMM:
CE44 DD 21 80 F2    	LD	IX,EMMFL
CE48 CD 3A CF       	CALL	EADR0
CE4B ED 78          	IN	A,(C)
CE4D F5             	PUSH	AF
CE4E                
CE4E 11 00 00       	LD	DE,0
CE51                ECHECK1:
CE51 13             	INC	DE
CE52 CD 1E CF       	CALL	EADR2
CE55 ED 60          	IN	H,(C)
CE57 CD 1E CF       	CALL	EADR2
CE5A 7C             	LD	A,H
CE5B C6 E5          	ADD	A,0E5H
CE5D ED 79          	OUT	(C),A
CE5F 3C             	INC	A
CE60 CD 3A CF       	CALL	EADR0
CE63 ED 79          	OUT	(C),A
CE65 3D             	DEC	A
CE66 CD 1E CF       	CALL	EADR2
CE69 ED 68          	IN	L,(C)
CE6B CD 1E CF       	CALL	EADR2
CE6E ED 61          	OUT	(C),H
CE70 BD             	CP	L
CE71 20 04          	JR	NZ,ECHECK2
CE73 CB 5A          	BIT	3,D
CE75 28 DA          	JR	Z,ECHECK1
CE77                ECHECK2:
CE77 CD 3A CF       	CALL	EADR0
CE7A F1             	POP	AF
CE7B ED 79          	OUT	(C),A
CE7D FE EB          	CP	0EBH
CE7F 20 05          	JR	NZ,EMM_BPB
CE81 3E 26          	LD	A,026H
CE83 32 92 F2       	LD	(EMMDV),A
CE86                EMM_BPB:
CE86 21 F7 FF       	LD	HL,0-9
CE89 19             	ADD	HL,DE
CE8A 30 09          	JR	NC,NOEMM
CE8C 22 88 F2       	LD	(EMMCL),HL
CE8F CD 89 CF       	CALL	CALC_FATLN
CE92 32 80 F2       	LD	(EMMFL),A
CE95                NOEMM:
CE95 3E 00          KEYREP:	LD	A,000H
CE97 B7             	OR	A
CE98 28 07          	JR	Z,KEYR1
CE9A 01 00 00       	LD	BC,0
CE9D ED 43 8C F0    	LD	(_CTC),BC
CEA1                KEYR1:
CEA1 CD 6A CF       	CALL	SETCRTC
CEA4 01 30 F8       	LD	BC,0-80*25
CEA7 2A BA F0       	LD	HL,(_PAGE_MINUS)
CEAA ED 43 BA F0    	LD	(_PAGE_MINUS),BC
CEAE 1E 0C          	LD	E,00CH
CEB0 CD CD F0       	CALL	_PRINT
CEB3 22 BA F0       	LD	(_PAGE_MINUS),HL
CEB6                
CEB6 21 A5 CF       	LD	HL,INIMES
CEB9 CD 70 D8       	CALL	MSX
CEBC                
CEBC 3A 87 FF       	LD	A,(0FF87H)
CEBF FE 08          	CP	8
CEC1 30 1E          	JR	NC,INIT0
CEC3 5F             	LD	E,A
CEC4 C6 41          	ADD	A,'A'
CEC6 32 A2 CF       	LD	(AUTODV),A
CEC9 0E 0E          	LD	C,00EH
CECB CD 05 00       	CALL	SYSTEM
CECE 1C             	INC	E
CECF 21 85 F0       	LD	HL,_SEEKSP	;Disk error Ignore
CED2 CB FE          	SET	7,(HL)
CED4 0E 1B          	LD	C,01BH
CED6 CD 05 00       	CALL	SYSTEM
CED9                
CED9 21 85 F0       	LD	HL,_SEEKSP
CEDC CB BE          	RES	7,(HL)
CEDE                
CEDE 3C             	INC	A
CEDF 20 08          	JR	NZ,INIT1
CEE1                INIT0:
CEE1 1E 00          	LD	E,0
CEE3 0E 0E          	LD	C,00EH
CEE5 CD 05 00       	CALL	SYSTEM
CEE8 AF             	XOR	A
CEE9                INIT1:
CEE9 F3             	DI
CEEA 08             	EX	AF,AF'
CEEB 2E FE          	LD	L,0-2		;CALLのスタック分減らす
CEED 39             	ADD	HL,SP
CEEE 11 00 FF       	LD	DE,0FF00H
CEF1 45             	LD	B,L
CEF2 CD D3 D5       	CALL	ZERO_MEMORY_DE
CEF5 21 CA FF       	LD	HL,EXTBIO
CEF8 36 C9          	LD	(HL),0C9H	;RET
CEFA 23             	INC	HL
CEFB 06 0E          	LD	B,TRAP38-EXTBIO-1
CEFD 3E FF          	LD	A,0FFH		;RST 38H
CEFF CD 33 E1       	CALL	FILL_MEMORY
CF02 21 F5 CF       	LD	HL,AT_TRAP38
CF05 11 D9 FF       	LD	DE,TRAP38
CF08 01 27 00       	LD	BC,AT_TRAPE-AT_TRAP38
CF0B ED B0          	LDIR
CF0D 08             	EX	AF,AF'
CF0E B7             	OR	A
CF0F C8             	RET	Z
CF10                
CF10 3E E6          	LD	A,0E6H
CF12 CD D9 DE       	CALL	COMOUT
CF15 CD BE DE       	CALL	IN49SB
CF18 CD BE DE       	CALL	IN49SB
CF1B FE 1B          	CP	01BH
CF1D C9             	RET
CF1E                
CF1E                EADR2:
CF1E D5             	PUSH	DE
CF1F EB             	EX	DE,HL
CF20 29             	ADD	HL,HL
CF21 29             	ADD	HL,HL
CF22 DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
CF25 DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
CF28 09             	ADD	HL,BC
CF29 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
CF2C 06 0D          	LD	B,00DH
CF2E ED 49          	OUT	(C),C
CF30 0C             	INC	C
CF31 ED 69          	OUT	(C),L
CF33 0C             	INC	C
CF34 ED 61          	OUT	(C),H
CF36 0C             	INC	C
CF37 EB             	EX	DE,HL
CF38 D1             	POP	DE
CF39 C9             	RET
CF3A                
CF3A                EADR0:
CF3A D5             	PUSH	DE
CF3B 11 00 00       	LD	DE,0
CF3E CD 1E CF       	CALL	EADR2
CF41 D1             	POP	DE
CF42 C9             	RET
CF43                
CF43                CHKCTC:
CF43 C5             	PUSH	BC
CF44 11 03 47       	LD	DE,04703H
CF47                INICTC1:
CF47 0C             	INC	C
CF48 ED 51          	OUT	(C),D
CF4A ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CF4C 1D             	DEC	E
CF4D 20 F8          	JR	NZ,INICTC1
CF4F C1             	POP	BC
CF50                
CF50 11 FA 07       	LD	DE,007FAH
CF53 ED 51          	OUT	(C),D
CF55 ED 59          	OUT	(C),E
CF57 ED 78          	IN	A,(C)
CF59 BB             	CP	E
CF5A C0             	RET	NZ
CF5B ED 51          	OUT	(C),D
CF5D ED 51          	OUT	(C),D
CF5F ED 78          	IN	A,(C)
CF61 BA             	CP	D
CF62 C0             	RET	NZ
CF63 0C             	INC	C
CF64 0C             	INC	C
CF65 ED 43 8C F0    	LD	(_CTC),BC
CF69 C9             	RET
CF6A                
CF6A                SETCRTC:
CF6A 21 B0 F0       	LD	HL,CRTCD
CF6D AF             	XOR	A
CF6E                SETCRT1:
CF6E 01 00 18       	LD	BC,01800H
CF71 ED 79          	OUT	(C),A
CF73 0C             	INC	C
CF74 04             	INC	B
CF75 ED A3          	OUTI
CF77 3C             	INC	A
CF78 FE 0C          	CP	12
CF7A 20 F2          	JR	NZ,SETCRT1
CF7C 23             	INC	HL
CF7D 23             	INC	HL
CF7E 01 03 1B       	LD	BC,01A03H+00100H
CF81 ED A3          	OUTI
CF83 01 D0 20       	LD	BC,01FD0H+00100H
CF86 ED A3          	OUTI
CF88 C9             	RET
CF89                
CF89                CALC_FATLN:	;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
CF89 5D             	LD	E,L
CF8A 54             	LD	D,H
CF8B 29             	ADD	HL,HL	;*2
CF8C 19             	ADD	HL,DE	;*3
CF8D CB 3C          	SRL	H	;/2
CF8F CB 1D          	RR	L	;1クラスタ辺り1.5バイト必要
CF91 11 FF 01       	LD	DE,511	;切り上げる
CF94 19             	ADD	HL,DE
CF95 7C             	LD	A,H
CF96 CB 3F          	SRL	A
CF98 C9             	RET
CF99                
CF99 41 55 54 4F    AUTOD:	DB	"AUTOEXEC "
CF9D 45 58 45 43
CFA1 20
CFA2 41 3A 00       AUTODV:	DB	"A:",0
CFA5                
CFA5 4C 53 58 2D    INIMES:	DB	"LSX-Dodgers for X1/turbo version "
CFA9 44 6F 64 67
CFAD 65 72 73 20
CFB1 66 6F 72 20
CFB5 58 31 2F 74
CFB9 75 72 62 6F
CFBD 20 76 65 72
CFC1 73 69 6F 6E
CFC5 20
CFC6 31 2E          	DB	030H + VER_1, '.'
CFC8 35 33          	DB	030H + VER_2 ,030H + VER_3
CFCA                ;	DB	""
CFCA 20 47 61 6B    	DB	' Gaku',0DH,0AH
CFCE 75 0D 0A
CFD1 00             	DB	0
CFD2                
CFD2                _C8025H:
CFD2 6B 50 59 88    	DB	06BH,050H,059H,088H,01BH,001H,019H,01AH
CFD6 1B 01 19 1A
CFDA 00 0F          	DB	000H,00FH
CFDC 80 F8 B0 FF    	DW	0-80*LINE,0-80
CFE0 0C 23          	DB	00CH,023H
CFE2                
CFE2 03 0C 0F 30    TEXTDT:	DB	003H,00CH,00FH,030H,033H,03CH,03FH
CFE6 33 3C 3F
CFE9                
CFE9                SIODATA:
CFE9 18             	DB	018H
CFEA 01 00          	DB	1,0
CFEC 02 00          	DB	2,0
CFEE 03 C1          	DB	3,0C1H
CFF0 04 44          	DB	4,044H
CFF2 05 E8          	DB	5,0E8H
CFF4 FF             	DB	0FFH
CFF5                
CFF5                AT_TRAP38:
CFF5 21 00 00       	LD	HL,0
CFF8 E3             	EX	(SP),HL
CFF9 3E 24          	LD	A,'$'
CFFB CD B6 DB       	CALL	MSG_A
CFFE 2B             	DEC	HL
CFFF 7C             	LD	A,H
D000 CD E8 FF       	CALL	PRHX+AT_RT
D003 7D             	LD	A,L
D004                PRHX:
D004 F5             	PUSH	AF
D005 07             	RLCA
D006 07             	RLCA
D007 07             	RLCA
D008 07             	RLCA
D009 CD F1 FF       	CALL	PRHX2+AT_RT
D00C F1             	POP	AF
D00D                PRHX2:
D00D E6 0F          	AND	00FH
D00F FE 0A          	CP	10
D011 3F             	CCF
D012 CE 30          	ADC	A,'0'
D014 27             	DAA
D015 C3 B6 DB       	JP	MSG_A
D018                	DS	4
D01C                AT_TRAPE:
D01C                	INCLUDE	"X1CPU.ASM"
D01C                
D01C                ;	LSX-Dodgers CPU
D01C                ;	X1/turbo/Z
D01C                
D01C                ;	ノンターボ用パッチ
D01C                ;	DMAを使って転送している部分をCPUに差し替える
D01C                
D01C                AT_SCR1:
D01C D9             	EXX
D01D C5             	PUSH	BC
D01E ED 4B B1 F0    	LD	BC,(_WIDTH)
D022 06 20          	LD	B,020H
D024 D9             	EXX
D025 C5             	PUSH	BC
D026 01 00 20       	LD	BC,02000H
D029                
D029 67             	LD	H,A
D02A B7             	OR	A
D02B                AT_SCRUP1:
D02B 28 15          	JR	Z,AT_SCRCL
D02D C5             	PUSH	BC
D02E CB E0          	SET	4,B
D030 D9             	EXX
D031 C5             	PUSH	BC
D032 CB E0          	SET	4,B
D034 D9             	EXX
D035 CD 94 DF       	CALL	AT_UPSUB+AT_RS
D038 D9             	EXX
D039 C1             	POP	BC
D03A D9             	EXX
D03B C1             	POP	BC
D03C CD 94 DF       	CALL	AT_UPSUB+AT_RS
D03F 25             	DEC	H
D040 18 E9          	JR	AT_SCRUP1
D042                
D042                AT_SCRCL:
D042 2A B1 F0       	LD	HL,(_WIDTH)
D045 CD 2A DE       	CALL	LINECL
D048 C1             	POP	BC
D049 D9             	EXX
D04A C1             	POP	BC
D04B D9             	EXX
D04C C9             	RET
D04D                
D04D                AT_UPSUB:
D04D 3A B1 F0       	LD	A,(_WIDTH)
D050 6F             	LD	L,A
D051                AT_UPSUB1:
D051 D9             	EXX
D052 ED 78          	IN	A,(C)
D054 03             	INC	BC
D055 D9             	EXX
D056 ED 79          	OUT	(C),A
D058 03             	INC	BC
D059 2D             	DEC	L
D05A 20 F5          	JR	NZ,AT_UPSUB1
D05C C9             	RET
D05D                
D05D                ;	FLOPPY DISK DRIVER(CPU)
D05D                
D05D                DISKC:
D05D 1B             	DEC	DE
D05E CB 5F          	BIT	3,A
D060 C4 D0 EE       	CALL	NZ,RNF
D063                DISKD:
D063 E5             	PUSH	HL
D064 21 D6 EE       	LD	HL,RETRY
D067 35             	DEC	(HL)
D068 E1             	POP	HL
D069 20 0C          	JR	NZ,AT_ERR		;Retry
D06B B7             	OR	A
D06C 28 09          	JR	Z,AT_ERR		;Error
D06E                
D06E                AT_DELP:
D06E CD D0 EE       	CALL	RNF
D071 CD AC EE       	CALL	FDMOFF
D074 3E FF          	LD	A,0FFH
D076                AT_ERRZ:
D076 BF             	CP	A
D077                AT_ERR:
D077 3E FF          	LD	A,0FFH
D079 C9             	RET
D07A                ERRW:
D07A 3E FF          	LD	A,0FFH
D07C BF             	CP	A
D07D 37             	SCF
D07E C3 AC EE       	JP	FDMOFF
D081                
D081                ERRDW:
D081 D1             	POP	DE
D082 CD B5 DF       	CALL	AT_DELP+AT_RS
D085 C2 E5 EE       	JP	NZ,DWT0+AT_R
D088 B7             	OR	A
D089 20 EF          	JR	NZ,ERRW
D08B C9             	RET
D08C                
D08C                ERRDR:
D08C D1             	POP	DE
D08D CD B5 DF       	CALL	AT_DELP+AT_RS
D090 C2 2E EF       	JP	NZ,DRD0+AT_R
D093 B7             	OR	A
D094 20 E4          	JR	NZ,ERRW
D096 C9             	RET
D097                
D097                AT_WTTRK:
D097 06 01          	LD	B,1
D099 3E F4          	LD	A,0F4H
D09B C3 D9 EE       	JP	AT_WTTRK1+AT_R
D09E                
D09E                AT_SCRN:
D09E ED 78          	IN	A,(C)
D0A0 C9             	RET
D0A1                AT_SCRE:
D0A1                
D0A1                AT_DWT:
D0A1 3E A0          	LD	A,0A0H
D0A3                AT_WTTRK1:
D0A3 32 74 EE       	LD	(FDCPAT+1),A
D0A6                DWTBL:
D0A6 78             	LD	A,B
D0A7 32 1C EF       	LD	(AT_WTB+1+AT_R),A
D0AA 3E 02          	LD	A,2		;Retry count
D0AC 32 D6 EE       	LD	(RETRY),A
D0AF                
D0AF                DWT0:
D0AF D5             	PUSH	DE
D0B0 E5             	PUSH	HL
D0B1 CD 13 EE       	CALL	SEEK		;Write disk
D0B4 E1             	POP	HL
D0B5 DA C8 DF       	JP	C,ERRDW+AT_RS
D0B8 F3             	DI
D0B9 3A 74 EE       	LD	A,(FDCPAT+1)
D0BC CD B8 EE       	CALL	SECSET
D0BF 0E FB          	LD	C,0FBH
D0C1                
D0C1                DWT1:
D0C1 56             	LD	D,(HL)
D0C2                DWT2:
D0C2 78             	LD	A,B
D0C3 DB F8          	IN	A,(0F8H)
D0C5 0F             	RRCA
D0C6 30 08          	JR	NC,DWT4
D0C8 0F             	RRCA
D0C9 30 F7          	JR	NC,DWT2
D0CB                DWT3:
D0CB ED 51          	OUT	(C),D
D0CD 23             	INC	HL
D0CE 18 F1          	JR	DWT1
D0D0                
D0D0                DWT4:
D0D0 3D             	DEC	A
D0D1 28 F8          	JR	Z,DWT3
D0D3 3C             	INC	A
D0D4 FB             	EI
D0D5 D1             	POP	DE
D0D6 13             	INC	DE
D0D7 CD AC EE       	CALL	FDMOFF
D0DA 28 09          	JR	Z,DISKOK_WT
D0DC CD A4 DF       	CALL	DISKC+AT_RS
D0DF 20 CE          	JR	NZ,DWT0
D0E1 B7             	OR	A
D0E2 C2 C1 DF       	JP	NZ,ERRW+AT_RS
D0E5                
D0E5                DISKOK_WT:
D0E5 06 01          AT_WTB:	LD	B,1
D0E7 10 BD          	DJNZ	DWTBL
D0E9 C9             	RET
D0EA                
D0EA                AT_DRD:
D0EA 3E 80          	LD	A,080H
D0EC 32 74 EE       	LD	(FDCPAT+1),A
D0EF                DRDBL:
D0EF 78             	LD	A,B
D0F0 32 61 EF       	LD	(AT_RDB+1+AT_R),A
D0F3 3E 02          	LD	A,2		;Retry count
D0F5 32 D6 EE       	LD	(RETRY),A
D0F8                DRD0:
D0F8 D5             	PUSH	DE
D0F9 E5             	PUSH	HL
D0FA CD 13 EE       	CALL	SEEK		;Read disk
D0FD E1             	POP	HL
D0FE DA D3 DF       	JP	C,ERRDR+AT_RS
D101 F3             	DI
D102 3A 74 EE       	LD	A,(FDCPAT+1)
D105 CD B8 EE       	CALL	SECSET
D108 0E FB          	LD	C,0FBH
D10A                DRD1:
D10A 78             	LD	A,B
D10B DB F8          	IN	A,(0F8H)
D10D 0F             	RRCA
D10E 30 08          	JR	NC,DRD3
D110 0F             	RRCA
D111 30 F7          	JR	NC,DRD1
D113 ED A2          	INI
D115 04             	INC	B
D116 18 F2          	JR	DRD1
D118                
D118                DRD3:
D118 B7             	OR	A
D119 FB             	EI
D11A D1             	POP	DE
D11B 13             	INC	DE
D11C CD AC EE       	CALL	FDMOFF
D11F 28 09          	JR	Z,DISKOK_RD
D121 CD A4 DF       	CALL	DISKC+AT_RS
D124 20 D2          	JR	NZ,DRD0
D126 B7             	OR	A
D127 C2 C1 DF       	JP	NZ,ERRW+AT_RS
D12A                
D12A                DISKOK_RD:
D12A 06 01          AT_RDB:	LD	B,1
D12C 10 C1          	DJNZ	DRDBL
D12E C9             	RET
D12F                
D12F                AT_CPUE:
D12F                
D12F                
D12F                ;	EMM DRIVER(CPU)
D12F                
D12F                
D12F                AT_EDWT:
D12F CD 0C D8       	CALL	AT_EADR+AT_RE
D132                AT_EDWT0:
D132 F5             	PUSH	AF
D133 AF             	XOR	A
D134                AT_EDWT1:
D134 04             	INC	B
D135 ED A3          	OUTI
D137 04             	INC	B
D138 ED A3          	OUTI
D13A 3D             	DEC	A
D13B 20 F7          	JR	NZ,AT_EDWT1
D13D 13             	INC	DE
D13E F1             	POP	AF
D13F 3D             	DEC	A
D140 20 F0          	JR	NZ,AT_EDWT0
D142 C9             	RET
D143                
D143                AT_EDRD:
D143 CD 0C D8       	CALL	AT_EADR+AT_RE
D146                AT_EDRD0:
D146 F5             	PUSH	AF
D147 AF             	XOR	A
D148                AT_EDRD1:
D148 ED A2          	INI
D14A 04             	INC	B
D14B ED A2          	INI
D14D 04             	INC	B
D14E 3D             	DEC	A
D14F 20 F7          	JR	NZ,AT_EDRD1
D151 13             	INC	DE
D152 F1             	POP	AF
D153 3D             	DEC	A
D154 20 F0          	JR	NZ,AT_EDRD0
D156 C9             	RET
D157                
D157                AT_EADR:
D157 C5             	PUSH	BC
D158 D5             	PUSH	DE
D159 EB             	EX	DE,HL
D15A 29             	ADD	HL,HL
D15B DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
D15E DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
D161 09             	ADD	HL,BC
D162 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
D165 06 0D          	LD	B,00DH
D167 ED 49          	OUT	(C),C
D169 0C             	INC	C
D16A ED 69          	OUT	(C),L
D16C 0C             	INC	C
D16D ED 61          	OUT	(C),H
D16F 0C             	INC	C
D170 EB             	EX	DE,HL
D171 D1             	POP	DE
D172 F1             	POP	AF
D173 A7             	AND	A	;CF=0
D174 C9             	RET
D175                AT_EMME:
D175                
D175 00 00 2F E4    AT_RT	EQU	TRAP38-AT_TRAP38
D175                
D175                INITE:
D175                	DS	BDOS-INITE
D206 C3 2F D8       	JP	BDOS0
D209                	INCLUDE	"X1CCP.ASM"
D209                
D209                ;	LSX-Dodgers CCP
D209                ;	X1/turbo/Z
D209                
D209                WBOOT1:
D209 F3             	DI
D20A ED 7B 06 00    	LD	SP,(SYSTEM+1)
D20E                
D20E 3E F0          	LD	A,INTVEC/256
D210 ED 47          	LD	I,A
D212                
D212 3E E4          	LD	A,0E4H
D214 CD D9 DE       	CALL	COMOUT
D217 3E C8          	LD	A,INTVEC
D219 CD B3 DE       	CALL	OT49SB
D21C                
D21C 21 B0 F0       	LD	HL,CRTCD
D21F AF             	XOR	A
D220                SETCRT2:
D220 01 00 18       	LD	BC,01800H
D223 ED 79          	OUT	(C),A
D225 0C             	INC	C
D226 56             	LD	D,(HL)
D227 FE 0D          	CP	13
D229 38 02          	JR	C,SETCRT3
D22B 16 00          	LD	D,0
D22D                SETCRT3:
D22D ED 51          	OUT	(C),D
D22F 23             	INC	HL
D230 3C             	INC	A
D231 FE 0E          	CP	14
D233 20 EB          	JR	NZ,SETCRT2
D235                
D235 01 03 1B       	LD	BC,01A03H+00100H
D238 ED A3          	OUTI
D23A 01 D0 20       	LD	BC,01FD0H+00100H
D23D ED A3          	OUTI
D23F 21 92 F0       	LD	HL,_KEYD
D242 7E             	LD	A,(HL)
D243 36 00          	LD	(HL),0
D245 CD A3 DB       	CALL	KEYBC_IFBREAK
D248 3E 04          	LD	A,4
D24A CD B6 DB       	CALL	MSG_A
D24D                	INCLUDE	"LDCCP.ASM"
D24D                
D24D                ;	LSX-Dodgers CCP
D24D                
D24D                COMMAND:
D24D 3A CC EF       	LD	A,(FCB_BAT)
D250 B7             	OR	A
D251 C2 92 D3       	JP	NZ,C_BAT1
D254 CD 07 D3       	CALL	SETDTA1
D257 3A 87 F0       	LD	A,(_DVSW)
D25A C6 41          	ADD	A,'A'
D25C CD B6 DB       	CALL	MSG_A
D25F 3E 3E          	LD	A,'>'
D261 CD B6 DB       	CALL	MSG_A
D264 3E 50          	LD	A,80
D266 12             	LD	(DE),A
D267 CD 05 DC       	CALL	_SYS0A		;(BDOS)文字列入力
D26A CD 95 D4       	CALL	LTNL
D26D                COMMAND2:
D26D 11 82 00       	LD	DE,DTA1+2
D270 CD FD F0       	CALL	_COMANL
D273 30 D8          	JR	NC,COMMAND
D275 11 79 F0       	LD	DE,COMERM
D278 CD 61 D8       	CALL	_SYS09		;(BDOS)文字列出力
D27B C7             	RST	0
D27C                
D27C                COMANL:
D27C CD 87 E0       	CALL	FILE
D27F 3A 19 F0       	LD	A,(FNAME+4)
D282 FE 20          	CP	020H
D284 20 1C          	JR	NZ,COMB2
D286 D5             	PUSH	DE
D287 11 15 F0       	LD	DE,FNAME
D28A 1A             	LD	A,(DE)
D28B FE 20          	CP	020H
D28D 28 44          	JR	Z,SDVSW
D28F 1B             	DEC	DE
D290 1A             	LD	A,(DE)
D291 C6 FF          	ADD	A,0FFH
D293 38 09          	JR	C,COMB
D295 13             	INC	DE
D296                
D296 21 03 D7       	LD	HL,COMTB
D299 06 09          	LD	B,COMS
D29B CD 0B E3       	CALL	CPNAME
D29E                COMB:
D29E D1             	POP	DE
D29F D2 0F 00       	JP	NC,JP_HL
D2A2                COMB2:
D2A2 EB             	EX	DE,HL
D2A3 22 6F D3       	LD	(COMPAT+1),HL
D2A6 F5             	PUSH	AF
D2A7 CD 27 D3       	CALL	CEXE4
D2AA F1             	POP	AF
D2AB 21 15 F0       	LD	HL,FNAME
D2AE 11 6D 00       	LD	DE,FCB2+1	;COMMAND NAME
D2B1 01 0B 00       	LD	BC,11
D2B4 ED B0          	LDIR
D2B6 11 66 EF       	LD	DE,PATHD
D2B9                CEX1:
D2B9 1A             	LD	A,(DE)
D2BA FE 20          	CP	020H
D2BC D8             	RET	C
D2BD CD 7C E0       	CALL	FILEC
D2C0 D5             	PUSH	DE
D2C1 21 6D 00       	LD	HL,FCB2+1	;COMMAND NAME
D2C4 11 15 F0       	LD	DE,FNAME
D2C7 01 0B 00       	LD	BC,11
D2CA ED B0          	LDIR
D2CC CD 27 D3       	CALL	CEXE4
D2CF D1             	POP	DE
D2D0 13             	INC	DE
D2D1 18 E6          	JR	CEX1
D2D3                
D2D3                SDVSW:
D2D3 F1             	POP	AF
D2D4 3A 14 F0       	LD	A,(FDRV)
D2D7 3D             	DEC	A
D2D8 5F             	LD	E,A
D2D9 0E 0E          	LD	C,00EH		;(BDOS)カレントドライブの設定
D2DB 18 31          	JR	SYSTEM0
D2DD                
D2DD                OPEN1:
D2DD 21 14 F0       	LD	HL,FDRV
D2E0                OPEN:
D2E0 0E 11          	LD	C,011H		;(BDOS)ファイルの検索
D2E2                OPEN3:
D2E2 D5             	PUSH	DE
D2E3 11 A7 EF       	LD	DE,DTA_CCP
D2E6 CD 04 D3       	CALL	SETDTA
D2E9 EB             	EX	DE,HL
D2EA CD 0E D3       	CALL	SYSTEM0
D2ED D1             	POP	DE
D2EE C9             	RET
D2EF                
D2EF                OPEN2:
D2EF 0E 12          	LD	C,012H
D2F1 18 EF          	JR	OPEN3
D2F3                
D2F3                DEFCB:				;Z=Ok NZ=Error
D2F3 11 A7 EF       	LD	DE,DTA_CCP
D2F6 CD 0C D3       	CALL	SYSC0F
D2F9                
D2F9 11 C8 EF       	LD	DE,DTA_CCP+33	;(FCB)ランダムレコード
D2FC 06 04          	LD	B,4
D2FE CD D3 D5       	CALL	ZERO_MEMORY_DE
D301                SETDTA100:
D301 11 00 01       	LD	DE,00100H
D304                SETDTA:
D304 C3 39 DA       	JP	_SYS1A		;(BDOS)DTAの設定
D307                
D307                SETDTA1:
D307 11 80 00       	LD	DE,DTA1
D30A 18 F8          	JR	SETDTA
D30C                
D30C                SYSC0F:
D30C 0E 0F          	LD	C,00FH		;(BDOS)ファイルのオープン
D30E                SYSTEM0:
D30E CD 05 00       	CALL	SYSTEM
D311 B7             	OR	A
D312 C9             	RET
D313                
D313                C_CD:
D313 0E 5A          	LD	C,5AH
D315 18 F7          	JR	SYSTEM0
D317                
D317                S27BUF:
D317 3A 07 00       	LD	A,(SYSTEM+2)
D31A 3D             	DEC	A
D31B E6 F8          	AND	0F8H
D31D 67             	LD	H,A
D31E 2E 00          	LD	L,0
D320                S27DTA:
D320 11 A7 EF       	LD	DE,DTA_CCP
D323                S27:
D323 0E 27          	LD	C,027H		;(BDOS)ランダムブロック読み込み
D325 18 E7          	JR	SYSTEM0
D327                
D327                CEXE4:
D327 21 1D F0       	LD	HL,FNAME+8
D32A 7E             	LD	A,(HL)
D32B FE 20          	CP	020H
D32D 20 07          	JR	NZ,CEXE7
D32F 3E 3F          	LD	A,'?'
D331 77             	LD	(HL),A
D332 23             	INC	HL
D333 77             	LD	(HL),A
D334 23             	INC	HL
D335 77             	LD	(HL),A
D336                CEXE7:
D336 CD DD D2       	CALL	OPEN1
D339                CEXE5:
D339 C0             	RET	NZ
D33A 2A B1 EF       	LD	HL,(DTA_CCP+1+9)
D33D 7C             	LD	A,H
D33E CD 93 E3       	CALL	CAP
D341 67             	LD	H,A
D342 7D             	LD	A,L
D343 CD 93 E3       	CALL	CAP
D346 6F             	LD	L,A
D347 3A B0 EF       	LD	A,(DTA_CCP+1+8)
D34A CD 93 E3       	CALL	CAP
D34D D6 42          	SUB	'B'
D34F 28 2C          	JR	Z,C_BAT
D351 3D             	DEC	A		;'C'
D352 28 05          	JR	Z,C_EXE
D354                CEXE6:
D354 CD EF D2       	CALL	OPEN2
D357 18 E0          	JR	CEXE5
D359                
D359                C_EXE:
D359 7C             	LD	A,H
D35A FE 4D          	CP	'M'
D35C 20 F6          	JR	NZ,CEXE6
D35E                
D35E CD F3 D2       	CALL	DEFCB
D361 CD 17 D3       	CALL	S27BUF
D364 3D             	DEC	A
D365 37             	SCF
D366 C0             	RET	NZ
D367 7C             	LD	A,H
D368 B5             	OR	L
D369 37             	SCF
D36A C8             	RET	Z
D36B CD 07 D3       	CALL	SETDTA1
D36E 11 00 00       COMPAT:	LD	DE,0				; self-modifying code
D371 ED 7B 06 00    	LD	SP,(SYSTEM+1)
D375 67             	LD	H,A				; A=0 in SETDTA1(_SYS1A)
D376 6F             	LD	L,A
D377 E5             	PUSH	HL				; push $0000 (reboot address)
D378 24             	INC	H
D379 E5             	PUSH	HL				; push $0100 (TPA address)
D37A C3 9E D5       	JP	SETFCB				; and JP $0100
D37D                
D37D                C_BAT:
D37D 11 41 54       	LD	DE,'A'+'T'*256
D380 ED 52          	SBC	HL,DE
D382 20 D0          	JR	NZ,CEXE6
D384                
D384 CD F3 D2       	CALL	DEFCB
D387                
D387 21 A7 EF       	LD	HL,DTA_CCP
D38A 11 CC EF       	LD	DE,FCB_BAT
D38D 01 25 00       	LD	BC,37
D390 ED B0          	LDIR
D392                C_BAT1:
D392 CD 01 D3       	CALL	SETDTA100
D395 CD C9 D3       	CALL	FGETC_BAT
D398 21 81 00       	LD	HL,DTA1+1
D39B 20 25          	JR	NZ,END_BATCH
D39D FE 21          	CP	021H		;スペースや改行など制御文字を飛ばす
D39F 38 F1          	JR	C,C_BAT1
D3A1 36 20          	LD	(HL),' '
D3A3 23             	INC	HL
D3A4                C_BAT2:
D3A4 77             	LD	(HL),A
D3A5 23             	INC	HL
D3A6 7D             	LD	A,L
D3A7 3C             	INC	A		;L==0FFH
D3A8 28 09          	JR	Z,RUN_BATCH
D3AA CD C9 D3       	CALL	FGETC_BAT
D3AD 20 04          	JR	NZ,RUN_BATCH
D3AF FE 20          	CP	020H
D3B1 30 F1          	JR	NC,C_BAT2
D3B3                RUN_BATCH:
D3B3 7D             	LD	A,L
D3B4 D6 7F          	SUB	DTA1-1
D3B6 32 80 00       	LD	(DTA1),A
D3B9 FE 04          	CP	4
D3BB 38 05          	JR	C,END_BATCH
D3BD 36 00          	LD	(HL),0
D3BF C3 6D D2       	JP	COMMAND2
D3C2                END_BATCH:
D3C2 AF             	XOR	A		;バッチファイルを閉じる
D3C3 32 CC EF       	LD	(FCB_BAT),A
D3C6 C3 00 F0       	JP	CPM_BOOT
D3C9                
D3C9                FGETC_BAT:
D3C9 11 CC EF       	LD	DE,FCB_BAT
D3CC                FGETC:				;1文字ずつ読み込む
D3CC E5             	PUSH	HL		;Z:成功
D3CD 21 01 00       	LD	HL,1
D3D0 CD 23 D3       	CALL	S27
D3D3 E1             	POP	HL
D3D4 3A 00 01       	LD	A,(00100H)
D3D7 C9             	RET
D3D8                
D3D8                C_DEL:
D3D8 CD 9E D5       	CALL	SETFCB
D3DB CD CC DB       	CALL	_SYS08		;(BDOS)エコーなしコンソール入力
D3DE                
D3DE 0E 13          	LD	C,013H
D3E0 18 0A          	JR	CDEL1		;(BDOS)ファイルの削除
D3E2                
D3E2                C_REN:
D3E2 CD 9E D5       	CALL	SETFCB
D3E5 3E 10          	LD	A,010H		;ディレクトリも対象にする
D3E7 32 69 00       	LD	(FCB1+13),A	;属性
D3EA 0E 17          	LD	C,017H		;(BDOS)ファイル名の変更
D3EC                CDEL1:
D3EC 11 5C 00       	LD	DE,FCB1
D3EF CD 05 00       	CALL	SYSTEM
D3F2 C6 FF          	ADD	A,0FFH
D3F4 C9             	RET
D3F5                
D3F5                C_DIR:
D3F5 CD 7C E0       	CALL	FILEC
D3F8 21 15 F0       	LD	HL,FDRV+1
D3FB CD E9 D6       	CALL	CWILD1
D3FE 3E F1          	LD	A,0F1H
D400 32 21 F0       	LD	(FDRV+13),A
D403 CD DD D2       	CALL	OPEN1
D406                CDIR1:
D406 B7             	OR	A
D407 20 08          	JR	NZ,PDSKF
D409 CD 54 D4       	CALL	P_NAME
D40C CD EF D2       	CALL	OPEN2
D40F 18 F5          	JR	CDIR1
D411                
D411                PDSKF:
D411 3A 14 F0       	LD	A,(FDRV)
D414 5F             	LD	E,A
D415 0E 1B          	LD	C,01BH		;(BDOS)ディスク情報の獲得
D417 CD 05 00       	CALL	SYSTEM
D41A 4F             	LD	C,A		;C←1クラスタ辺りの論理セクタ数
D41B C6 01          	ADD	A,001H
D41D D8             	RET	C		;Aが0FFHだった場合
D41E 3E 06          	LD	A,8-2
D420                PDS1:				;HL=未使用クラスタの総数
D420 3C             	INC	A
D421 CB 19          	RR	C
D423 30 FB          	JR	NC,PDS1
D425                PDS2:				;B←論理セクタのサイズの上位8ビット
D425 3C             	INC	A
D426 CB 18          	RR	B
D428 30 FB          	JR	NC,PDS2
D42A 47             	LD	B,A
D42B                
D42B 11 00 00       	LD	DE,0
D42E                PDS3:
D42E 29             	ADD	HL,HL
D42F EB             	EX	DE,HL
D430 ED 6A          	ADC	HL,HL
D432 EB             	EX	DE,HL
D433 10 F9          	DJNZ	PDS3
D435                PDSKF1:
D435 CD CD D4       	CALL	PRDEC_DEHL
D438 11 F1 EF       	LD	DE,FREE
D43B CD 61 D8       	CALL	_SYS09		;(BDOS)文字列出力
D43E CD BC D4       	CALL	PUTDRV
D441 3E 5C          	LD	A,05CH		;\
D443 CD B6 DB       	CALL	MSG_A
D446 2A 22 F0       	LD	HL,(FDRV+14)	;ディレクトリのクラスタ番号
D449 AF             	XOR	A
D44A 11 FE FF       	LD	DE,0-2
D44D 19             	ADD	HL,DE
D44E 23             	INC	HL
D44F DC C9 D4       	CALL	C,PRDEC_HL
D452 18 41          	JR	LTNL
D454                
D454                P_NAME:
D454 3A A8 EF       	LD	A,(DTA_CCP+1)
D457 FE 2E          	CP	'.'
D459 C8             	RET	Z
D45A 11 FF D6       	LD	DE,DIRHD
D45D CD 61 D8       	CALL	_SYS09		;(BDOS)文字列出力
D460 3A B3 EF       	LD	A,(DTA_CCP+1+00BH)
D463 F5             	PUSH	AF
D464 0F             	RRCA
D465 9F             	SBC	A,A
D466 E6 0A          	AND	'*'-020H
D468 C6 20          	ADD	A,020H
D46A CD B6 DB       	CALL	MSG_A
D46D CD BC D4       	CALL	PUTDRV
D470 21 A8 EF       	LD	HL,DTA_CCP+1
D473 CD 0D D5       	CALL	FPRNT
D476                
D476 F1             	POP	AF
D477 CB 67          	BIT	4,A
D479 28 08          	JR	Z,DIR3
D47B 11 F4 D6       	LD	DE,DIRMES
D47E CD 61 D8       	CALL	_SYS09		;(BDOS)文字列出力
D481 18 0A          	JR	DIR6
D483                DIR3:
D483 ED 5B C6 EF    	LD	DE,(DTA_CCP+1+01EH)
D487 2A C4 EF       	LD	HL,(DTA_CCP+1+01CH)
D48A CD CD D4       	CALL	PRDEC_DEHL
D48D                DIR6:
D48D 3A B1 F0       	LD	A,(_WIDTH)
D490 FE 29          	CP	40+1
D492 D4 2F D5       	CALL	NC,PRTTMS
D495                
D495                LTNL:
D495 1E 03          	LD	E,3
D497 C3 CD F0       	JP	_PRINT
D49A                
D49A                C_PATH:
D49A CD 5E E1       	CALL	SPCUT
D49D 21 66 EF       	LD	HL,PATHD
D4A0 FE 21          	CP	021H
D4A2 30 0C          	JR	NC,CPATH0
D4A4                CPATHP:
D4A4 7E             	LD	A,(HL)
D4A5 23             	INC	HL
D4A6 FE 20          	CP	020H
D4A8 3F             	CCF
D4A9 30 EA          	JR	NC,LTNL
D4AB CD B6 DB       	CALL	MSG_A
D4AE 18 F4          	JR	CPATHP
D4B0                CPATH0:
D4B0 FE 3B          	CP	';'
D4B2 20 01          	JR	NZ,CPATH1
D4B4 13             	INC	DE
D4B5                CPATH1:
D4B5 EB             	EX	DE,HL
D4B6 01 40 00       	LD	BC,PATHX
D4B9 ED B0          	LDIR
D4BB C9             	RET
D4BC                
D4BC                PUTDRV:
D4BC 3A 14 F0       	LD	A,(FDRV)
D4BF C6 40          	ADD	A,'A'-1
D4C1 CD B6 DB       	CALL	MSG_A
D4C4 3E 3A          	LD	A,':'
D4C6                MSG_AR:
D4C6 C3 B6 DB       	JP	MSG_A
D4C9                
D4C9                PRDEC_HL:
D4C9 AF             	XOR	A
D4CA                PRDEC_AHL:
D4CA 5F             	LD	E,A
D4CB 16 00          	LD	D,0
D4CD                PRDEC_DEHL:
D4CD D5             	PUSH	DE
D4CE 11 0F F0       	LD	DE,DECBF
D4D1 06 05          	LD	B,5
D4D3 CD D3 D5       	CALL	ZERO_MEMORY_DE	;A=0
D4D6 D1             	POP	DE
D4D7                
D4D7 0E 20          	LD	C,32
D4D9                DEC1:
D4D9 29             	ADD	HL,HL
D4DA EB             	EX	DE,HL
D4DB ED 6A          	ADC	HL,HL
D4DD EB             	EX	DE,HL
D4DE E5             	PUSH	HL
D4DF 21 13 F0       	LD	HL,DECBF+4
D4E2 06 05          	LD	B,5
D4E4                DEC2:
D4E4 7E             	LD	A,(HL)
D4E5 8F             	ADC	A,A
D4E6 27             	DAA
D4E7 77             	LD	(HL),A
D4E8 2B             	DEC	HL
D4E9 10 F9          	DJNZ	DEC2
D4EB E1             	POP	HL
D4EC 0D             	DEC	C
D4ED 20 EA          	JR	NZ,DEC1
D4EF                
D4EF 21 0F F0       	LD	HL,DECBF
D4F2 3E 20          	LD	A,020H
D4F4 06 04          	LD	B,4
D4F6                DEC3:
D4F6 CD 03 D5       	CALL	DEC4
D4F9 CD 03 D5       	CALL	DEC4
D4FC 23             	INC	HL
D4FD 10 F7          	DJNZ	DEC3
D4FF                DECX:
D4FF CD 03 D5       	CALL	DEC4
D502 AF             	XOR	A
D503                DEC4:
D503 ED 6F          	RLD
D505 FE 20          	CP	020H
D507 28 02          	JR	Z,DEC5
D509 F6 30          	OR	030H
D50B                DEC5:
D50B 18 B9          	JR	MSG_AR
D50D                
D50D                FPRNT:
D50D 06 08          	LD	B,8
D50F CD 20 D5       	CALL	P_N1
D512 7E             	LD	A,(HL)
D513 C6 80          	ADD	A,0A0H-020H
D515 FE A0          	CP	0A0H
D517 28 02          	JR	Z,FPR1
D519 3E 2E          	LD	A,'.'
D51B                FPR1:
D51B CD B6 DB       	CALL	MSG_A
D51E 06 03          	LD	B,3
D520                
D520                P_N1:
D520 C5             	PUSH	BC
D521 E5             	PUSH	HL
D522 7E             	LD	A,(HL)
D523 CD 9F E3       	CALL	CAP3
D526 CD B6 DB       	CALL	MSG_A
D529 E1             	POP	HL
D52A C1             	POP	BC
D52B 23             	INC	HL
D52C 10 F2          	DJNZ	P_N1
D52E C9             	RET
D52F                
D52F                PRTTMS:
D52F 3E 20          	LD	A,020H
D531 CD B6 DB       	CALL	MSG_A
D534                
D534 2A C0 EF       	LD	HL,(DTA_CCP+1+24)
D537 7D             	LD	A,L
D538 B7             	OR	A
D539 C8             	RET	Z
D53A CB 3C          	SRL	H
D53C 17             	RLA
D53D 17             	RLA
D53E 17             	RLA
D53F 17             	RLA
D540 E6 0F          	AND	00FH
D542 57             	LD	D,A
D543 7C             	LD	A,H
D544 C6 50          	ADD	A,80
D546 CD 89 D5       	CALL	PRDEC_A
D549 3E 2D          	LD	A,'-'
D54B CD B6 DB       	CALL	MSG_A
D54E 7A             	LD	A,D
D54F CD 89 D5       	CALL	PRDEC_A
D552 3E 2D          	LD	A,'-'
D554 CD B6 DB       	CALL	MSG_A
D557 7D             	LD	A,L
D558 E6 1F          	AND	01FH
D55A CD 89 D5       	CALL	PRDEC_A
D55D                
D55D 2A BE EF       	LD	HL,(DTA_CCP+1+22)
D560                
D560 3E 20          	LD	A,020H
D562 CD B6 DB       	CALL	MSG_A
D565 7C             	LD	A,H
D566 65             	LD	H,L
D567 06 03          	LD	B,3
D569                PRTTMS1:
D569 1F             	RRA
D56A CB 1D          	RR	L
D56C 10 FB          	DJNZ	PRTTMS1
D56E E6 1F          	AND	01FH
D570 CD 89 D5       	CALL	PRDEC_A
D573 3E 3A          	LD	A,':'
D575 CD B6 DB       	CALL	MSG_A
D578 7D             	LD	A,L
D579 0F             	RRCA
D57A 0F             	RRCA
D57B E6 3F          	AND	03FH
D57D CD 89 D5       	CALL	PRDEC_A
D580 3E 3A          	LD	A,':'
D582 CD B6 DB       	CALL	MSG_A
D585 7C             	LD	A,H
D586 E6 1F          	AND	01FH
D588 87             	ADD	A,A
D589                
D589                ;	PRINT10
D589                
D589                PRDEC_A:
D589 E5             	PUSH	HL
D58A 06 08          	LD	B,8
D58C 4F             	LD	C,A
D58D AF             	XOR	A
D58E                PRTA1:
D58E CB 01          	RLC	C
D590 8F             	ADC	A,A
D591 27             	DAA
D592 10 FA          	DJNZ	PRTA1
D594 21 0F F0       	LD	HL,DECBF
D597 77             	LD	(HL),A
D598 AF             	XOR	A
D599 CD FF D4       	CALL	DECX
D59C E1             	POP	HL
D59D C9             	RET
D59E                
D59E                SETFCB:
D59E CD 5E E1       	CALL	SPCUT
D5A1 1A             	LD	A,(DE)
D5A2 FE 20          	CP	020H
D5A4 38 01          	JR	C,SETFCBA
D5A6 1B             	DEC	DE
D5A7                SETFCBA:
D5A7 06 24          	LD	B,36
D5A9 21 5C 00       	LD	HL,FCB1
D5AC E5             	PUSH	HL
D5AD AF             	XOR	A
D5AE CD 33 E1       	CALL	FILL_MEMORY
D5B1 E1             	POP	HL
D5B2 D5             	PUSH	DE
D5B3 CD 9F DA       	CALL	_SYS5C		;(BDOS)ファイル名の解析
D5B6 21 6C 00       	LD	HL,FCB2
D5B9 CD 9F DA       	CALL	_SYS5C		;(BDOS)ファイル名の解析
D5BC E1             	POP	HL
D5BD 01 00 50       	LD	BC,05000H
D5C0 11 81 00       	LD	DE,00081H
D5C3                SETFCB1:
D5C3 7E             	LD	A,(HL)
D5C4 23             	INC	HL
D5C5 FE 20          	CP	020H
D5C7 38 05          	JR	C,SETFCB2
D5C9 12             	LD	(DE),A
D5CA 13             	INC	DE
D5CB 0C             	INC	C
D5CC 10 F5          	DJNZ	SETFCB1
D5CE                SETFCB2:
D5CE 79             	LD	A,C
D5CF 32 80 00       	LD	(DTA1),A
D5D2 04             	INC	B
D5D3                ZERO_MEMORY_DE:
D5D3 AF             	XOR	A
D5D4                FILL_MEMORY_DE:
D5D4 12             	LD	(DE),A
D5D5 13             	INC	DE
D5D6 10 FC          	DJNZ	FILL_MEMORY_DE
D5D8 C9             	RET
D5D9                
D5D9                C_COPY:
D5D9 CD 9E D5       	CALL	SETFCB
D5DC                
D5DC 11 61 F0       	LD	DE,ZERO
D5DF CD 7F E0       	CALL	FILEC2
D5E2 21 6C 00       	LD	HL,FCB2
D5E5 CD A6 DA       	CALL	S29X1
D5E8                
D5E8 3E 10          	LD	A,010H
D5EA 32 69 00       	LD	(FCB1+13),A
D5ED 21 6D 00       	LD	HL,FCB2+1
D5F0 CD E9 D6       	CALL	CWILD1
D5F3                COPY0:
D5F3 CD E6 D6       	CALL	CWILD
D5F6 21 5C 00       	LD	HL,FCB1
D5F9 CD E0 D2       	CALL	OPEN
D5FC 37             	SCF
D5FD                COPY1:
D5FD C0             	RET	NZ
D5FE CD F3 D2       	CALL	DEFCB
D601                
D601 3A B4 EF       	LD	A,(DTA_CCP+13)
D604 CB 67          	BIT	4,A
D606 28 21          	JR	Z,COPY1A
D608                
D608 21 5D 00       	LD	HL,FCB1+1
D60B CD C2 E4       	CALL	CHKWILD
D60E 38 14          	JR	C,COPY9
D610                
D610 3E 20          	LD	A,020H
D612 32 5D 00       	LD	(FCB1+1),A
D615 2A C1 EF       	LD	HL,(DTA_CCP+26)
D618 23             	INC	HL
D619 22 6A 00       	LD	(FCB1+14),HL
D61C 18 D5          	JR	COPY0
D61E                
D61E                COPY8:
D61E CD 61 D8       	CALL	_SYS09		;(BDOS)文字列出力
D621 CD 95 D4       	CALL	LTNL
D624                COPY9:
D624 CD EF D2       	CALL	OPEN2
D627 18 D4          	JR	COPY1
D629                
D629                COPY1A:
D629 21 6C 00       	LD	HL,FCB2
D62C 11 14 F0       	LD	DE,FDRV
D62F 01 A9 EF       	LD	BC,DTA_CCP+2
D632 ED A0          	LDI
D634 3E 0B          	LD	A,11
D636                COPY2:
D636 F5             	PUSH	AF
D637 7E             	LD	A,(HL)
D638 FE 3F          	CP	'?'
D63A 20 01          	JR	NZ,COPY3
D63C 0A             	LD	A,(BC)
D63D                COPY3:
D63D 12             	LD	(DE),A
D63E 03             	INC	BC
D63F 13             	INC	DE
D640 23             	INC	HL
D641 F1             	POP	AF
D642 3D             	DEC	A
D643 20 F1          	JR	NZ,COPY2
D645 01 05 00       	LD	BC,16-11
D648 ED B0          	LDIR
D64A                PUTNAME:
D64A 21 5D 00       	LD	HL,FCB1+1
D64D CD C2 E4       	CALL	CHKWILD
D650 30 0B          	JR	NC,PUTN1
D652 21 15 F0       	LD	HL,FDRV+1
D655 CD 0D D5       	CALL	FPRNT
D658 3E 20          	LD	A,020H
D65A CD B6 DB       	CALL	MSG_A
D65D                PUTN1:
D65D 11 14 F0       	LD	DE,FDRV
D660 0E 16          	LD	C,016H		;(BDOS)ファイルの作成
D662 CD 0E D3       	CALL	SYSTEM0
D665 20 48          	JR	NZ,COPYE2
D667 67             	LD	H,A		;A=0
D668 6F             	LD	L,A
D669 22 35 F0       	LD	(FDRV+33),HL	;(FCB)ランダムレコード
D66C 22 37 F0       	LD	(FDRV+35),HL
D66F                COPY6:
D66F CD 17 D3       	CALL	S27BUF
D672 47             	LD	B,A
D673 3C             	INC	A
D674 28 31          	JR	Z,COPYE
D676 7C             	LD	A,H
D677 B5             	OR	L
D678 28 0C          	JR	Z,COPY7
D67A 11 14 F0       	LD	DE,FDRV
D67D 0E 26          	LD	C,026H		;(BDOS)ランダムブロック書き込み
D67F CD 0E D3       	CALL	SYSTEM0
D682 20 23          	JR	NZ,COPYE
D684 10 E9          	DJNZ	COPY6
D686                COPY7:
D686 3A B4 EF       	LD	A,(DTA_CCP+13)	;(FCB)属性
D689 32 21 F0       	LD	(FDRV+13),A
D68C 21 BB EF       	LD	HL,DTA_CCP+20	;(FCB)タイムスタンプ
D68F 11 28 F0       	LD	DE,FDRV+20
D692 01 04 00       	LD	BC,4
D695 ED B0          	LDIR
D697                
D697 11 14 F0       	LD	DE,FDRV
D69A 0E 10          	LD	C,010H		;(BDOS)ファイルのクローズ
D69C CD 0E D3       	CALL	SYSTEM0
D69F 20 06          	JR	NZ,COPYE
D6A1                
D6A1 11 71 F0       	LD	DE,OK
D6A4 C3 1E D6       	JP	COPY8
D6A7                
D6A7                COPYE:
D6A7 11 14 F0       	LD	DE,FDRV
D6AA 0E 13          	LD	C,013H		;(BDOS)ファイルの削除
D6AC CD 05 00       	CALL	SYSTEM
D6AF                COPYE2:
D6AF 37             	SCF
D6B0 C9             	RET
D6B1                
D6B1                C_TYPE:
D6B1 CD 9E D5       	CALL	SETFCB
D6B4 21 5C 00       	LD	HL,FCB1
D6B7 CD E0 D2       	CALL	OPEN
D6BA 37             	SCF
D6BB                TYPE1:
D6BB C0             	RET	NZ
D6BC CD F3 D2       	CALL	DEFCB
D6BF 3E 06          	LD	A,6
D6C1 CD B6 DB       	CALL	MSG_A
D6C4                TYPE2:
D6C4 CD 17 D3       	CALL	S27BUF
D6C7 C6 FE          	ADD	A,0FEH
D6C9 D8             	RET	C
D6CA 7C             	LD	A,H
D6CB B5             	OR	L
D6CC 28 13          	JR	Z,TYPEE
D6CE 01 00 01       	LD	BC,00100H
D6D1                TYPE3:
D6D1 0A             	LD	A,(BC)
D6D2 03             	INC	BC
D6D3 FE 1A          	CP	01AH
D6D5 28 0A          	JR	Z,TYPEE
D6D7 CD B6 DB       	CALL	MSG_A
D6DA 2B             	DEC	HL
D6DB 7C             	LD	A,H
D6DC B5             	OR	L
D6DD 20 F2          	JR	NZ,TYPE3
D6DF 18 E3          	JR	TYPE2
D6E1                TYPEE:
D6E1 CD EF D2       	CALL	OPEN2
D6E4 18 D5          	JR	TYPE1
D6E6                
D6E6                CWILD:
D6E6 21 5D 00       	LD	HL,FCB1+1
D6E9                CWILD1:
D6E9 7E             	LD	A,(HL)
D6EA FE 20          	CP	020H
D6EC C0             	RET	NZ
D6ED                CWILD2:
D6ED 3E 3F          	LD	A,'?'
D6EF 06 0B          	LD	B,11
D6F1 C3 33 E1       	JP	FILL_MEMORY
D6F4                
D6F4 20 20 20 20    DIRMES:	DB	"     <DIR>$"
D6F8 20 3C 44 49
D6FC 52 3E 24
D6FF 20 20 3A 24    DIRHD:	DB	"  :$"
D703                
D703                COMTB:
D703 44 20 20 20    	DB	"D   "	;1
D707 F5 D3          	DW	C_DIR
D709 44 49 52 20    	DB	"DIR "	;2
D70D F5 D3          	DW	C_DIR
D70F 43 4F 50 59    	DB	"COPY"	;3
D713 D9 D5          	DW	C_COPY
D715 43 44 20 20    	DB	"CD  "	;4
D719 13 D3          	DW	C_CD
D71B 44 45 4C 20    	DB	"DEL "	;5
D71F D8 D3          	DW	C_DEL
D721 50 41 54 48    	DB	"PATH"	;6
D725 9A D4          	DW	C_PATH
D727 52 45 4E 20    	DB	"REN "	;7
D72B E2 D3          	DW	C_REN
D72D 54 59 50 45    	DB	"TYPE"	;8
D731 B1 D6          	DW	C_TYPE
D733 52 45 4D 20    	DB	"REM "	;9
D737 5E D8          	DW	C_REM
D739                	INCLUDE	"X1DISK2.ASM"
D739                
D739                ;	LSX-Dodgers DISK2
D739                ;	X1/turbo/Z
D739                
D739                ;	GRAPHIC RAM DISK DRIVER
D739                
D739                
D739                GDRD:
D739 C5             	PUSH	BC
D73A CD 62 D7       	CALL	GADR
D73D F1             	POP	AF
D73E                GDRD1:
D73E ED A2          	INI
D740 04             	INC	B
D741 0C             	INC	C
D742 20 FA          	JR	NZ,GDRD1
D744 04             	INC	B
D745 13             	INC	DE
D746 3D             	DEC	A
D747 20 F5          	JR	NZ,GDRD1
D749                GBANK0:
D749 3A BF F0       	LD	A,(WK1FD0)
D74C E6 EF          	AND	0EFH		;BANK0
D74E 18 1D          	JR	S1FD0
D750                
D750                GDWT:
D750 C5             	PUSH	BC
D751 CD 62 D7       	CALL	GADR
D754 F1             	POP	AF
D755                GDWT1:
D755 04             	INC	B
D756 ED A3          	OUTI
D758 0C             	INC	C
D759 20 FA          	JR	NZ,GDWT1
D75B 04             	INC	B
D75C 13             	INC	DE
D75D 3D             	DEC	A
D75E 20 F5          	JR	NZ,GDWT1
D760 18 E7          	JR	GBANK0
D762                
D762                GADR:
D762 0E 00          	LD	C,0
D764 7B             	LD	A,E
D765 C6 40          	ADD	A,040H
D767 47             	LD	B,A
D768 3A BF F0       	LD	A,(WK1FD0)
D76B F6 10          	OR	010H		;BANK1
D76D                S1FD0:
D76D C5             	PUSH	BC
D76E 32 BF F0       	LD	(WK1FD0),A
D771 01 D0 1F       	LD	BC,01FD0H
D774 ED 79          	OUT	(C),A
D776 C1             	POP	BC
D777 C9             	RET
D778                
D778                
D778                ;	BANK RAM DISK DRIVER
D778                
D778                BDWT:
D778 3E             	DB	03EH	;LD A,??
D779 37             	SCF
D77A 18 02          	JR	BRW
D77C                
D77C                BDRD:
D77C 3E             	DB	03EH	;LD A,??
D77D A7             	AND	A
D77E                BRW:
D77E F3             	DI
D77F 32 AA D7       	LD	(BRWPAT),A
D782 ED 73 CA D7    	LD	(BANKSP+1),SP
D786 3A CB D7       	LD	A,(BANKSP+2)
D789 87             	ADD	A,A
D78A 38 03          	JR	C,BRW0
D78C 31 CA FF       	LD	SP,EXTSP
D78F                BRW0:
D78F D9             	EXX		;裏レジスタ
D790 C5             	 PUSH	 BC
D791 D5             	 PUSH	 DE
D792 01 00 0B       	 LD	 BC,00B00H	 ;バンクメモリ
D795 11 10 10       	 LD	 DE,01010H
D798 D9             	 EXX		;表レジスタ
D799                BRW1:
D799 C5             	PUSH	BC
D79A D5             	PUSH	DE
D79B EB             	EX	DE,HL
D79C 29             	ADD	HL,HL
D79D 29             	ADD	HL,HL
D79E 7C             	LD	A,H
D79F DD 86 0C       	ADD	A,(IX+00CH)	;DPB_0C_MAXCYL
D7A2 E6 0F          	AND	00FH	;バンク
D7A4 65             	LD	H,L
D7A5 CB 3C          	SRL	H	;/2
D7A7 2E 00          	LD	L,0
D7A9 D9             	EXX		;裏レジスタ
D7AA A7             BRWPAT:	 AND	 A	;自己書き換え(AND A:読み出し/SCF:書き込み)
D7AB 38 08          	 JR	 C,BRWT
D7AD 57             	 LD	 D,A	 ;D=バンク
D7AE D9             	 EXX		;表レジスタ
D7AF EB             	EX	DE,HL
D7B0 CD CE D7       	CALL	BTFR
D7B3 18 06          	JR	BRW2
D7B5                BRWT:
D7B5 5F             	 LD	E,A	 ;E=バンク
D7B6 D9             	 EXX		;表レジスタ
D7B7 CD CE D7       	CALL	BTFR
D7BA EB             	EX	DE,HL
D7BB                BRW2:
D7BB D1             	POP	DE
D7BC C1             	POP	BC
D7BD 13             	INC	DE
D7BE 10 D9          	DJNZ	BRW1
D7C0                
D7C0 D9             	EXX		;裏レジスタ
D7C1 3E 10          	 LD	 A,10H
D7C3 ED 79          	 OUT	 (C),A		;メインメモリに切り替える
D7C5 D1             	 POP	 DE
D7C6 C1             	 POP	 BC
D7C7 D9             	 EXX		;表レジスタ
D7C8 AF             	XOR	A
D7C9 31 00 00       BANKSP:	LD	SP,0
D7CC FB             	EI
D7CD C9             	RET
D7CE                
D7CE                ;メインメモリ←→バンクメモリ 512バイトの転送を行う
D7CE                ; DE:転送元アドレス
D7CE                ; HL:転送先アドレス
D7CE                ; 裏BC:バンク切り替えポート(0B00H)
D7CE                ; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
D7CE                ; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
D7CE                
D7CE                BTFR:
D7CE 06 00          	LD	B,0	;256回ループ(256*2)
D7D0                BTFR1:
D7D0 D9             	EXX		;裏レジスタ
D7D1 ED 51          	 OUT	 (C),D	 ;BANK(MAIN)
D7D3 D9             	 EXX		;表レジスタ
D7D4 1A             	LD	A,(DE)
D7D5 4F             	LD	C,A
D7D6 13             	INC	DE
D7D7 1A             	LD	A,(DE)
D7D8 13             	INC	DE
D7D9 D9             	EXX		;裏レジスタ
D7DA ED 59          	 OUT	 (C),E	 ;MAIN(BANK)
D7DC D9             	 EXX		;表レジスタ
D7DD 71             	LD	(HL),C
D7DE 23             	INC	HL
D7DF 77             	LD	(HL),A
D7E0 23             	INC	HL
D7E1 10 ED          	DJNZ	BTFR1
D7E3 C9             	RET
D7E4                
D7E4                ;	EMM DRIVER(DMA)
D7E4                
D7E4                
D7E4                EDWT:
D7E4 0E 0F          	LD	C,15
D7E6 18 02          	JR	EDWT1
D7E8                EDRD:
D7E8 0E 0E          	LD	C,14
D7EA                EDWT1:
D7EA C5             	PUSH	BC
D7EB D5             	PUSH	DE
D7EC 22 2C D8       	LD	(DMAB),HL
D7EF 78             	LD	A,B
D7F0 87             	ADD	A,A
D7F1 3D             	DEC	A
D7F2 32 25 D8       	LD	(DMALEN+1),A
D7F5 3C             	INC	A
D7F6 84             	ADD	A,H	;HL(アドレス)を先に進めておく
D7F7 67             	LD	H,A
D7F8 EB             	EX	DE,HL
D7F9 29             	ADD	HL,HL
D7FA DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
D7FD 79             	LD	A,C
D7FE DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
D801 09             	ADD	HL,BC
D802 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
D805 06 0D          	LD	B,00DH
D807 ED 49          	OUT	(C),C
D809 0C             	INC	C
D80A ED 69          	OUT	(C),L
D80C 0C             	INC	C
D80D ED 61          	OUT	(C),H
D80F                
D80F 21 20 D8       	LD	HL,EDMAD
D812 CD 8F DF       	CALL	SETDMA
D815 CD B7 DF       	CALL	GO_DMA
D818 EB             	EX	DE,HL
D819 D1             	POP	DE
D81A C1             	POP	BC
D81B                DMA_ADD_SEC:
D81B 13             	INC	DE
D81C 10 FD          	DJNZ	DMA_ADD_SEC
D81E AF             	XOR	A
D81F C9             	RET
D820                
D820                EDMAD:
D820 C3             	DB	0C3H	;WR6 リセット
D821 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
D822 03 0D          	DW	00D03H	;ポートA開始アドレス EMMリード/ライト
D824 FF 01          DMALEN:	DW	001FFH	;ブロック長(転送サイズ-1)
D826 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
D827 50             	DB	050H	;WR2 ポートBアドレスインクリメント メモリ
D828 02             	DB	002H	;ポートBタイミング
D829 80             	DB	080H	;WR3
D82A 9A             	DB	09AH	;WR5 WAIT RDY:HIGH
D82B AD             	DB	0ADH	;WR4 連続 ポートB開始アドレス
D82C 00 00          DMAB:	DW	0
D82E 01             	DB	001H	;WR0 ポートA←ポートB 転送
D82F                EMME:
D82F                
D82F 00 00 06 B5    AT_RE	EQU	EDWT-AT_EDWT
D82F                
D82F                	INCLUDE	"LDOS.ASM"
D82F                
D82F                ;	LSX-Dodgers OS
D82F                
D82F                BDOS0:
D82F E5             	PUSH	HL
D830 79             	LD	A,C
D831 FE 3C          	CP	03CH
D833 38 02          	JR	C,DOS1
D835 3E 3C          	LD	A,03CH
D837                DOS1:
D837 87             	ADD	A,A
D838 6F             	LD	L,A
D839 26 F1          	LD	H,STABLE/256
D83B 7E             	LD	A,(HL)
D83C 2C             	INC	L
D83D 66             	LD	H,(HL)
D83E 6F             	LD	L,A
D83F E3             	EX	(SP),HL
D840 79             	LD	A,C
D841                ;確認用
D841                ;	LD	(0050H),A
D841 C9             	RET
D842                _DOS2:
D842 FE 5A          	CP	05AH		;(BDOS)カレントディレクトリの変更(_CHDIR)
D844 CA E3 DA       	JP	Z,_SYS5A
D847 FE 5C          	CP	05CH		;(BDOS)ファイル名の解析(_PFILE)
D849 CA 9F DA       	JP	Z,_SYS5C
D84C FE 5F          	CP	05FH		;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
D84E CA F7 ED       	JP	Z,_SYS5F
D851 FE 6F          	CP	06FH		;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
D853 20 0A          	JR	NZ,_ERROR
D855 01 1D 01       	LD	BC,011DH
D858 11 53 01       	LD	DE,VER
D85B 21 00 00       	LD	HL,MACD
D85E                C_REM:
D85E AF             	XOR	A
D85F                _ERROR:
D85F A7             	AND	A
D860 C9             	RET
D861                
D861                _SYS09:		;文字列出力
D861 D5             	PUSH	DE
D862                _SX09:
D862 1A             	LD	A,(DE)
D863 13             	INC	DE
D864 FE 24          	CP	'$'
D866 28 31          	JR	Z,SX0E2
D868 CD B6 DB       	CALL	MSG_A
D86B 18 F5          	JR	_SX09
D86D                
D86D                MSX1:
D86D CD B6 DB       	CALL	MSG_A
D870                MSX:
D870 7E             	LD	A,(HL)
D871 23             	INC	HL
D872 B7             	OR	A
D873 20 F8          	JR	NZ,MSX1
D875 C9             	RET
D876                
D876                _SYS0C:		;(BDOS)バージョン番号の獲得
D876 21 22 00       	LD	HL,00022H
D879 7D             	LD	A,L
D87A C9             	RET
D87B                
D87B                _SYS0D:		;(BDOS)ディスクリセット
D87B CD DF F0       	CALL	_FFLUSH
D87E E5             	PUSH	HL
D87F 21 80 00       	LD	HL,00080H
D882 22 8A F0       	LD	(_DTA),HL
D885 E1             	POP	HL
D886 D5             	PUSH	DE
D887 1E 00          	LD	E,0
D889 3E             	DB	03EH
D88A                
D88A                _SYS0E:		;(BDOS)カレントドライブの設定
D88A D5             	PUSH	DE
D88B 7B             	LD	A,E
D88C DD E5          	PUSH	IX
D88E CD DC F0       	CALL	_GETDPB
D891 DD E1          	POP	IX
D893 38 04          	JR	C,SX0E2
D895 7B             	LD	A,E
D896 32 87 F0       	LD	(_DVSW),A
D899                SX0E2:
D899 D1             	POP	DE
D89A C9             	RET
D89B                
D89B                _SYS0F:		;(BDOS)ファイルのオープン
D89B CD 70 E1       	CALL	SETDRV
D89E FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D8A1 C6 02          	ADD	A,002H		;Write
D8A3 28 48          	JR	Z,FEND0F
D8A5 CD BE E4       	CALL	CHKWILDX
D8A8                
D8A8 D4 90 E1       	CALL	NC,SOPENX
D8AB                _S16XX:
D8AB 38 40          	JR	C,FEND0F
D8AD                				;Directory location
D8AD 3A 9F F0       	LD	A,(_FILEN)
D8B0 FD 77 19       	LD	(IY+25),A	;(FCB)ディレクトリロケーション
D8B3                ;				_DIRF
D8B3 3A A0 F0       	LD	A,(_DIRF)
D8B6 FD 77 1D       	LD	(IY+29),A	;(FCB)ディレクトリモード
D8B9                ;				_FBPS
D8B9 FD 73 1E       	LD	(IY+30),E	;(FCB)ディレクトリポジション
D8BC FD 72 1F       	LD	(IY+31),D
D8BF                ;				Open(Read)
D8BF FD 36 1C FF    	LD	(IY+28),0FFH	;(FCB)オープンモード
D8C3                ;				FILENAME
D8C3 FD E5          	PUSH	IY
D8C5 D1             	POP	DE
D8C6 13             	INC	DE
D8C7 01 0B 00       	LD	BC,11
D8CA ED B0          	LDIR
D8CC                ;				Attribute
D8CC 7E             	LD	A,(HL)
D8CD FD 77 0D       	LD	(IY+13),A	;(FCB)属性(アトリビュート)
D8D0 11 0B 00       	LD	DE,11		;Reserved
D8D3 19             	ADD	HL,DE
D8D4                					;(FCB)ファイルを最後に変更した時刻
D8D4 11 EA F1       	LD	DE,SDDATA		;(FCB)ファイルを最後に変更した日付
D8D7 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
D8D9                S16LOOP:				;(FCB)ファイルのサイズ(バイト単位)
D8D9 1A             	LD	A,(DE)
D8DA 13             	INC	DE
D8DB 32 E2 D8       	LD	(S16PAT+2),A
D8DE 7E             	LD	A,(HL)
D8DF 23             	INC	HL
D8E0 FD 77 00       S16PAT:	LD	(IY+0),A
D8E3 10 F4          	DJNZ	S16LOOP
D8E5                
D8E5 AF             	XOR	A
D8E6 FD 77 0C       	LD	(IY+12),A	;(FCB)カレントブロック
D8E9 FD 22 91 D9    	LD	(OFCB+1),IY
D8ED                FEND0F:
D8ED 18 45          	JR	FEND10
D8EF                
D8EF                _SYS10:		;(BDOS)ファイルのクローズ
D8EF CD 70 E1       	CALL	SETDRV
D8F2 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D8F5 D6 FE          	SUB	0FEH
D8F7 37             	SCF
D8F8 3F             	CCF
D8F9 20 39          	JR	NZ,FEND10
D8FB                _S10A:				;Write
D8FB FD 77 0E       	LD	(IY+14),A	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D8FE FD 77 0F       	LD	(IY+15),A
D901                
D901 FD 34 1C       	INC	(IY+28)		;0FEH->0FFH ;オープンモード
D904 CD B6 E5       	CALL	SETTMS
D907                
D907 FD 7E 1D       	LD	A,(IY+29)	;(FCB)ディレクトリモード
D90A 32 A0 F0       	LD	(_DIRF),A
D90D E6 7F          	AND	07FH
D90F 32 01 EB       	LD	(_SECPS+1),A
D912 FD 5E 1E       	LD	E,(IY+30)	;(FCB)ディレクトリポジション
D915 FD 56 1F       	LD	D,(IY+31)
D918 CD C4 E2       	CALL	READ_DIR
D91B 38 17          	JR	C,FEND10
D91D                
D91D 3A EE E1       SDECM1:	LD	A,(SDECPAT+1)	;1セクタ辺りのディレクトリエントリ数
D920 3D              	DEC	A		;1024=01FH / 512=00FH / 256=7
D921 FD A6 19       	AND	(IY+25)		;(FCB)ディレクトリロケーション
D924 6F             	LD	L,A
D925 26 00          	LD	H,0
D927 29             	ADD	HL,HL		;*2
D928 29             	ADD	HL,HL		;*4
D929 29             	ADD	HL,HL		;*8
D92A 29             	ADD	HL,HL		;*16
D92B 29             	ADD	HL,HL		;*32
D92C ED 4B 7E F1    	LD	BC,(_DTBUF)
D930 09             	ADD	HL,BC
D931                
D931 CD CE E4       	CALL	SDIRENT
D934                FEND10:
D934 18 42          	JR	FEND
D936                
D936                _SYS11:		;(BDOS)最初のファイルの検索
D936 CD 70 E1       	CALL	SETDRV
D939 CD BD E1       	CALL	SOPEN
D93C                _S12X1:
D93C 38 3A          	JR	C,FEND
D93E CD 5D E2       	CALL	SOPENE2
D941 ED 5B 8A F0    	LD	DE,(_DTA)
D945 3A 88 F0       	LD	A,(_DRV)
D948 3C             	INC	A
D949 12             	LD	(DE),A
D94A D5             	PUSH	DE
D94B 13             	INC	DE
D94C 01 20 00       	LD	BC,32
D94F ED B0          	LDIR
D951 FD 6E 0E       	LD	L,(IY+14)	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D954 FD 66 0F       	LD	H,(IY+15)
D957 22 F4 F1       	LD	(SCDIR),HL
D95A 2A 9A F0       	LD	HL,(_FBPS)
D95D 22 F6 F1       	LD	(SFBPS),HL
D960 2A 9F F0       	LD	HL,(_FILEN)
D963 7C             	LD	A,H
D964 B7             	OR	A
D965 28 06          	JR	Z,_S12DIR
D967 3A 01 EB       	LD	A,(_SECPS+1)
D96A F6 80          	OR	080H
D96C 67             	LD	H,A
D96D                _S12DIR:
D96D 22 F8 F1       	LD	(SFNDF),HL	;Directory position and Flags
D970 E1             	POP	HL
D971 11 39 F0       	LD	DE,SFILE
D974 0E 21          	LD	C,33
D976                _S11B:
D976 ED B0          	LDIR
D978                FEND:
D978 9F             	SBC	A,A		;CF=0 A=0 : CF=1 A=0FFH
D979                FENDE:
D979 FD E1          	POP	IY
D97B C1             	POP	BC
D97C D1             	POP	DE
D97D E1             	POP	HL
D97E C9             	RET
D97F                
D97F                _SYS12:		;(BDOS)次のファイルの検索
D97F E5             	PUSH	HL
D980 D5             	PUSH	DE
D981 C5             	PUSH	BC
D982 FD E5          	PUSH	IY
D984 CD 21 E2       	CALL	NOPEN
D987 18 B3          	JR	_S12X1
D989                
D989                _S16K:
D989 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D98C FE FD          	CP	0FDH		;Device(0FDH)
D98E 37             	SCF
D98F C8             	RET	Z
D990                
D990 11 00 00       OFCB:	LD	DE,0
D993 D5             	PUSH	DE
D994 06 1A          	LD	B,26		;First cluster
D996                S16K1:
D996 13             	INC	DE
D997 23             	INC	HL
D998 10 FC          	DJNZ	S16K1
D99A                
D99A 1A             	LD	A,(DE)
D99B BE             	CP	(HL)
D99C 20 13          	JR	NZ,S16K2
D99E 13             	INC	DE
D99F 23             	INC	HL
D9A0 1A             	LD	A,(DE)
D9A1 BE             	CP	(HL)
D9A2 20 0D          	JR	NZ,S16K2
D9A4                
D9A4 E1             	POP	HL
D9A5 FD E5          	PUSH	IY
D9A7 D1             	POP	DE
D9A8 1A             	LD	A,(DE)		;Drive
D9A9 BE             	CP	(HL)
D9AA 20 06          	JR	NZ,S16K3
D9AC                				;ここはCFが必ず0
D9AC ED 52          	SBC	HL,DE		;CP HL,DE
D9AE 37             	SCF
D9AF C0             	RET	NZ
D9B0 E5             	PUSH	HL
D9B1                S16K2:
D9B1 E1             	POP	HL
D9B2                S16K3:
D9B2 FD E5          	PUSH	IY
D9B4 D1             	POP	DE
D9B5                _SYS13:		;(BDOS)ファイルの削除
D9B5 CD 70 E1       	CALL	SETDRV
D9B8 CD EE E3       	CALL	KILL
D9BB                FEND13:
D9BB 18 BB          	JR	FEND
D9BD                
D9BD                _SYS14:		;(BDOS)シーケンシャルな読み出し
D9BD CD 70 E1       	CALL	SETDRV
D9C0 CD 22 E6       	CALL	INIT_SEQ
D9C3                SREAD:
D9C3 CD 6C E6       	CALL	RB_READ
D9C6                
D9C6 C6 01          	ADD	A,001H
D9C8 38 AE          	JR	C,FEND
D9CA                
D9CA 7D             	LD	A,L
D9CB D6 01          	SUB	001H
D9CD                FENDX:
D9CD 9F             	SBC	A,A
D9CE E6 03          	AND	3
D9D0 1F             	RRA
D9D1 18 A6          	JR	FENDE
D9D3                
D9D3                _SYS15:		;(BDOS)シーケンシャルな書き込み
D9D3 CD 70 E1       	CALL	SETDRV
D9D6 CD 22 E6       	CALL	INIT_SEQ
D9D9                SWRITE:
D9D9 CD 65 E6       	CALL	RB_WRITE
D9DC                
D9DC C6 FF          	ADD	A,0FFH
D9DE 18 ED          	JR	FENDX
D9E0                
D9E0                _SYS17:		;(BDOS)ファイル名の変更
D9E0 CD 70 E1       	CALL	SETDRV
D9E3 CD 44 E4       	CALL	NAME
D9E6 18 D3          	JR	FEND13
D9E8                
D9E8                _SYS16:		;(BDOS)ファイルの作成
D9E8 CD 70 E1       	CALL	SETDRV
D9EB                
D9EB CD BE E4       	CALL	CHKWILDX
D9EE 38 CB          	JR	C,FEND13
D9F0 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
D9F3 FE 05          	CP	5
D9F5 28 05          	JR	Z,_S16X2
D9F7 FE 21          	CP	021H
D9F9 DA BB D9       	JP	C,FEND13
D9FC                _S16X2:
D9FC                ;				Clear FCB
D9FC FD E5          	PUSH	IY
D9FE E1             	POP	HL
D9FF 01 10 00       	LD	BC,16
DA02 09             	ADD	HL,BC
DA03                _S16X1:
DA03 70             	LD	(HL),B		;B=0
DA04 23             	INC	HL
DA05 0D             	DEC	C
DA06 20 FB          	JR	NZ,_S16X1
DA08                
DA08 CD BB E5       	CALL	SETTMSX
DA0B FD 36 0D FF    	LD	(IY+13),0FFH	;(FCB)Attribute
DA0F CD 90 E1       	CALL	SOPENX
DA12 3F             	CCF
DA13 CC 89 D9       	CALL	Z,_S16K
DA16 D4 6E E2       	CALL	NC,COPEN
DA19 D4 CE E4       	CALL	NC,SDIRENT
DA1C C3 AB D8       	JP	_S16XX
DA1F                
DA1F                _SYS21:		;(BDOS)ランダムな読み出し
DA1F CD 70 E1       	CALL	SETDRV
DA22 CD 06 E6       	CALL	INIT_RND
DA25 18 9C          	JR	SREAD
DA27                
DA27                _SYS22:		;(BDOS)ランダムな書き込み
DA27                _SYS28:		;(BDOS)ランダムな書き込み・その2
DA27 CD 70 E1       	CALL	SETDRV
DA2A CD 06 E6       	CALL	INIT_RND
DA2D 18 AA          	JR	SWRITE
DA2F                
DA2F                _SYS18:		;(BDOS)ログインベクトルの獲得
DA2F 21 FF 00       	LD	HL,000FFH
DA32 AF             	XOR	A
DA33 C9             	RET
DA34                
DA34                _SYS19:		;(BDOS)カレントドライブ番号の獲得
DA34 3A 87 F0       	LD	A,(_DVSW)
DA37 A7             	AND	A
DA38 C9             	RET
DA39                
DA39                _SYS1A:		;(BDOS)DTAの設定
DA39 ED 53 8A F0    	LD	(_DTA),DE
DA3D AF             	XOR	A
DA3E C9             	RET
DA3F                
DA3F                _SYS1B:		;(BDOS)ディスク情報の獲得
DA3F 7B             	LD	A,E
DA40 CD 83 E1       	CALL	GETDRV
DA43 CD DC F0       	CALL	_GETDPB
DA46 D4 E2 F0       	CALL	NC,_RDFATX
DA49 21 00 00       	LD	HL,0
DA4C D4 94 E5       	CALL	NC,DSKF
DA4F                
DA4F ED 5B 95 E5    	LD	DE,(MAXCLP+1)	;DPB_08_MAXCL-1
DA53 1B             	DEC	DE		;DE←クラスタの総数
DA54 FD 2A 7C F1    	LD	IY,(_FATBF)	;IY←メモリ上のFATの先頭アドレス
DA58 9F             	SBC	A,A
DA59 D8             	RET	C
DA5A 4F             	LD	C,A		;C=0
DA5B DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS
DA5E E6 0F          	AND	00FH
DA60 47             	LD	B,A
DA61 DD 7E 07       	LD	A,(IX+7)	;DPB_07_SECPCL
DA64 C9             	RET
DA65                
DA65                _SYS1D:		;(BDOS)書き込みが禁止されているディスクの調査
DA65 AF             	XOR	A
DA66 67             	LD	H,A
DA67 6F             	LD	L,A
DA68 C9             	RET
DA69                
DA69                _SYS1F:		;(BDOS)ディスク装置のパラメータの読み出し
DA69 21 00 F2       	LD	HL,DEVICE
DA6C 7B             	LD	A,E
DA6D C3 DC F0       	JP	_GETDPB
DA70                
DA70                _SYS23:		;(BDOS)ファイルサイズの獲得
DA70 E5             	PUSH	HL
DA71 2A 1E F1       	LD	HL,(STABLE+2*00FH)	;ファイルのオープン
DA74 CD 0F 00       	CALL	JP_HL
DA77 38 1B          	JR	C,_S23X1
DA79                
DA79 D5             	PUSH	DE		;EX DE,IY
DA7A FD E3          	EX	(SP),IY		;
DA7C                ;	POP	DE		;
DA7C                ;	PUSH	DE		;DEを破壊しないように注意vv
DA7C FD 7E 10       	LD	A,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
DA7F FD 6E 11       	LD	L,(IY+17)	;
DA82 FD 66 12       	LD	H,(IY+18)	;
DA85 C5             	PUSH	BC		;
DA86 FD 46 13       	LD	B,(IY+19)	;
DA89 CD F8 E5       	CALL	GET_CPM_R_SIZE
DA8C C1             	POP	BC
DA8D                _S24X1:
DA8D CD 18 E6       	CALL	SET_RR_AHL
DA90                ;	POP	DE		;^^^^^^^^^^^^^^^^^^^^^^^^
DA90                ;	PUSH	DE		;EX DE,IY
DA90 FD E3          	EX	(SP),IY		;
DA92 D1             	POP	DE		;
DA93                
DA93 AF             	XOR	A
DA94                _S23X1:
DA94 E1             	POP	HL
DA95 C9             	RET
DA96                
DA96                _SYS24:		;(BDOS)ランダムレコードフィールドの設定
DA96 E5             	PUSH	HL
DA97 D5             	PUSH	DE		;EX DE,IY
DA98 FD E3          	EX	(SP),IY		;
DA9A                ;	POP	DE		;
DA9A                ;	PUSH	DE		;DEを破壊しないように注意vv
DA9A CD 2A E6       	CALL	GETSEQ
DA9D 18 EE          	JR	_S24X1		;^^^^^^^^^^^^^^^^^^^^^^^^
DA9F                
DA9F                _SYS5C:		;(BDOS)ファイル名の解析
DA9F C5             	PUSH	BC
DAA0 E5             	PUSH	HL
DAA1 CD 87 E0       	CALL	FILE
DAA4 E1             	POP	HL
DAA5 C1             	POP	BC
DAA6                S29X1:
DAA6 C5             	PUSH	BC
DAA7 D5             	PUSH	DE
DAA8 E5             	PUSH	HL
DAA9 EB             	EX	DE,HL
DAAA 21 14 F0       	LD	HL,FDRV
DAAD 01 0D 00       	LD	BC,13
DAB0 ED B0          	LDIR
DAB2 70             	LD	(HL),B		;B=0
DAB3 0E 03          	LD	C,3
DAB5 ED B0          	LDIR
DAB7 E1             	POP	HL
DAB8 D1             	POP	DE
DAB9 C1             	POP	BC
DABA AF             	XOR	A
DABB C9             	RET
DABC                
DABC                _SYS30:		;(BDOS)論理セクタを用いた書き込み
DABC C5             	PUSH	BC
DABD 01 9B EC       	LD	BC,DWT24B
DAC0 18 04          	JR	S2FX
DAC2                _SYS2F:
DAC2 C5             	PUSH	BC
DAC3 01 8B EC       	LD	BC,DRD24B
DAC6                S2FX:
DAC6 ED 43 DC DA    	LD	(S2FPAT+1),BC
DACA CD DF F0       	CALL	_FFLUSH
DACD                
DACD D5             	PUSH	DE
DACE E5             	PUSH	HL
DACF 7D             	LD	A,L		;Drive
DAD0 CD D9 F0       	CALL	_CHGDRV
DAD3 38 09          	JR	C,S30X2
DAD5 44             	LD	B,H		;Number of clusters
DAD6 2A 8A F0       	LD	HL,(_DTA)
DAD9                
DAD9 0E 00          	LD	C,0
DADB CD 8B EC       S2FPAT:	CALL	DRD24B
DADE                S30X2:
DADE E1             	POP	HL
DADF D1             	POP	DE
DAE0 C1             	POP	BC
DAE1 9F             	SBC	A,A
DAE2 C9             	RET
DAE3                
DAE3                _SYS5A:		;(BDOS)カレントディレクトリの変更
DAE3 C5             	PUSH	BC
DAE4 D5             	PUSH	DE
DAE5 E5             	PUSH	HL
DAE6 CD 7C E0       	CALL	FILEC
DAE9 21 00 00       	LD	HL,0
DAEC 11 14 F0       	LD	DE,FDRV
DAEF 2A 4E F1       	LD	HL,(STABLE+2*027H)	;ランダムブロック読み込み
DAF2 CD 0F 00       	CALL	JP_HL
DAF5 18 E7          	JR	S30X2
DAF7                	INCLUDE	"X1IO.ASM"
DAF7                
DAF7                ;	LSX-Dodgers IO
DAF7                ;	X1/turbo/Z
DAF7                
DAF7 00 00 D8 5F    _SYS04	EQU	_ERROR		;(BDOS)外部出力
DAF7 00 00 D8 5F    _SYS05	EQU	_ERROR		;(BDOS)プリンタ出力
DAF7 00 00 D8 5F    _SYS1C	EQU	_ERROR		;(BDOS)ディスクの書き込み禁止化
DAF7 00 00 D8 5F    _SYS1E	EQU	_ERROR		;(BDOS)ファイル属性の設定
DAF7 00 00 D8 5F    _SYS20	EQU	_ERROR		;(BDOS)利用者番号の設定と読み出し
DAF7 00 00 D8 5F    _SYS2E	EQU	_ERROR		;(BDOS)ベリファイ・フラグの設定
DAF7                
DAF7                BIOS:
DAF7 CD FF DA       	CALL	BIOS3
DAFA 06 1E          	LD	B,01EH
DAFC ED 79          	OUT	(C),A
DAFE C9             	RET
DAFF                BIOS3:
DAFF C5             	PUSH	BC
DB00 06 1D          	LD	B,01DH
DB02 ED 79          	OUT	(C),A
DB04 C9             	RET
DB05                
DB05                INT:
DB05 F5             	PUSH	AF
DB06 E5             	PUSH	HL
DB07 C5             	PUSH	BC
DB08                
DB08 CD BE DE       	CALL	IN49SB
DB0B 67             	LD	H,A
DB0C CD BE DE       	CALL	IN49SB
DB0F 6F             	LD	L,A
DB10                
DB10 FE 08          	CP	8		;DELキー
DB12 20 05          	JR	NZ,SCEXE
DB14 7C             	LD	A,H
DB15 E6 11          	AND	011H		;CTRLキー + GRAPHキー
DB17 28 0C          	JR	Z,RESET
DB19                SCEXE:
DB19 22 92 F0       	LD	(_KEYD),HL
DB1C CD 51 DB       	CALL	KEYSET1
DB1F                
DB1F C1             	POP	BC
DB20                INTPE:
DB20 E1             	POP	HL
DB21                INTPE2:
DB21 F1             	POP	AF
DB22                INTCTCE:
DB22 FB             	EI
DB23 ED 4D          	RETI
DB25                
DB25                RESET:
DB25 3E 1D          	LD	A,01DH
DB27 D3 00          	OUT	(0),A
DB29 C7             	RST	0
DB2A                
DB2A                INTCTC2:
DB2A F5             	PUSH	AF
DB2B 3E 00          INTCPAT:LD	A,000H
DB2D 3D             	DEC	A
DB2E 32 2C DB       	LD	(INTCPAT+1),A
DB31 20 EE          	JR	NZ,INTPE2
DB33                
DB33 3A 92 F0       	LD	A,(_KEYD)
DB36 B7             	OR	A
DB37 28 E8          	JR	Z,INTPE2
DB39                KEYSET0:
DB39 E5             	PUSH	HL
DB3A 2A 90 F0       	LD	HL,(_KEYPS)
DB3D 7C             	LD	A,H
DB3E AD             	XOR	L
DB3F 20 06          	JR	NZ,INTC2A
DB41                
DB41 2A 92 F0       	LD	HL,(_KEYD)
DB44 CD 85 DB       	CALL	KEYSET
DB47                INTC2A:
DB47 3A 94 F0       	LD	A,(_KEYSP)
DB4A E6 0F          	AND	00FH
DB4C 32 2C DB       	LD	(INTCPAT+1),A
DB4F                
DB4F 18 CF          	JR	INTPE
DB51                
DB51                KEYSET1:
DB51 CB 6C          	BIT	5,H
DB53 F5             	PUSH	AF
DB54 ED 4B 8C F0    	LD	BC,(_CTC)
DB58 78             	LD	A,B
DB59 B1             	OR	C
DB5A 20 06          	JR	NZ,KEYS10E
DB5C                
DB5C F1             	POP	AF
DB5D 20 26          	JR	NZ,KEYSET
DB5F F5             	PUSH	AF
DB60 18 D7          	JR	KEYSET0
DB62                KEYS10E:
DB62 F1             	POP	AF
DB63 C8             	RET	Z
DB64 F5             	PUSH	AF
DB65 3E 03          	LD	A,3		;CTC STOP
DB67 ED 79          	OUT	(C),A
DB69 F1             	POP	AF
DB6A                
DB6A B7             	OR	A
DB6B C8             	RET	Z
DB6C                
DB6C 3E A7          	LD	A,0A7H
DB6E ED 79          	OUT	(C),A
DB70 3A 94 F0       	LD	A,(_KEYSP)
DB73 ED 79          	OUT	(C),A
DB75 79             	LD	A,C
DB76 E6 FC          	AND	0FCH
DB78 4F             	LD	C,A
DB79 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
DB7B 3E C0          	LD	A,CTC0
DB7D ED 79          	OUT	(C),A
DB7F 3A 95 F0       	LD	A,(_KEYSP+1)
DB82 32 2C DB       	LD	(INTCPAT+1),A
DB85                
DB85                KEYSET:
DB85 7D             	LD	A,L
DB86 CB 74          	BIT	6,H
DB88 C0             	RET	NZ
DB89                KEYBS:
DB89 B7             	OR	A
DB8A C8             	RET	Z
DB8B                KEYBS1:
DB8B CD A3 DB       	CALL	KEYBC_IFBREAK
DB8E E5             	PUSH	HL
DB8F F5             	PUSH	AF
DB90 2A 90 F0       	LD	HL,(_KEYPS)
DB93 2C             	INC	L
DB94 CB AD          	RES	5,L
DB96 7D             	LD	A,L
DB97 BC             	CP	H
DB98 28 15          	JR	Z,POP_AF_HL_SCF_RET
DB9A 32 90 F0       	LD	(_KEYPS),A
DB9D 26 FF          	LD	H,KEYBF/256
DB9F F1             	POP	AF
DBA0 77             	LD	(HL),A
DBA1 E1             	POP	HL
DBA2 C9             	RET
DBA3                KEYBC_IFBREAK:
DBA3 FE 03          	CP	3
DBA5 C0             	RET	NZ
DBA6                KEYBC:
DBA6 E5             	PUSH	HL
DBA7 21 00 00       	LD	HL,0
DBAA 22 90 F0       	LD	(_KEYPS),HL
DBAD E1             	POP	HL
DBAE C9             	RET
DBAF                
DBAF                POP_AF_HL_SCF_RET:
DBAF F1             	POP	AF
DBB0 E1             	POP	HL
DBB1 37             	SCF
DBB2 C9             	RET
DBB3                
DBB3                _SYS01:		;(BDOS)コンソール入力
DBB3 CD 09 F0       	CALL	_SYS07
DBB6                MSG_A:
DBB6 F5             	PUSH	AF
DBB7 D5             	PUSH	DE
DBB8 5F             	LD	E,A
DBB9 CD BF DB       	CALL	_SYS02
DBBC D1             	POP	DE
DBBD F1             	POP	AF
DBBE C9             	RET
DBBF                
DBBF                _SYS02:		;(BDOS)コンソール出力
DBBF CD D1 DB       	CALL	BREAK
DBC2 18 05          	JR	PRINTX
DBC4                
DBC4                _SYS06:		;(BDOS)コンソール直接入出力
DBC4 7B             	LD	A,E
DBC5 3C             	INC	A
DBC6 CA CA F0       	JP	Z,_INKEY
DBC9                PRINTX:
DBC9 C3 CD F0       	JP	_PRINT
DBCC                
DBCC                _SYS08:		;(BDOS)エコーなしコンソール入力
DBCC CD 09 F0       	CALL	_SYS07
DBCF 18 04          	JR	BREAK1
DBD1                BREAK:
DBD1 FB             	EI
DBD2 3A 92 F0       	LD	A,(_KEYD)
DBD5                BREAK1:
DBD5 FE 03          	CP	3		;CTRL+C
DBD7 CC F4 F0       	CALL	Z,_BREAK
DBDA FE 13          	CP	013H		;CTRL+S
DBDC C0             	RET	NZ
DBDD                
DBDD                PAUSE:
DBDD CD A6 DB       	CALL	KEYBC
DBE0                
DBE0                FLGET:
DBE0 CD DF F0       	CALL	_FFLUSH
DBE3 C5             	PUSH	BC
DBE4 E5             	PUSH	HL
DBE5 ED 4B 8E F0    	LD	BC,(_TXADR)
DBE9 CB E8          	SET	5,B
DBEB ED 60          	IN	H,(C)
DBED                FLGET1:
DBED 3A 93 F0       	LD	A,(_KEYD+1)
DBF0 0F             	RRCA
DBF1 0F             	RRCA
DBF2 E6 10          	AND	010H
DBF4 F6 08          	OR	8
DBF6 ED 68          	IN	L,(C)
DBF8 B5             	OR	L
DBF9 ED 79          	OUT	(C),A
DBFB CD CA F0       	CALL	_INKEY
DBFE 28 ED          	JR	Z,FLGET1
DC00 ED 61          	OUT	(C),H
DC02 E1             	POP	HL
DC03 C1             	POP	BC
DC04 C9             	RET
DC05                
DC05                _SYS0A:		;(BDOS)文字列入力
DC05 C5             	PUSH	BC
DC06 E5             	PUSH	HL
DC07 D5             	PUSH	DE
DC08 CD 0B E0       	CALL	GETL
DC0B 11 20 FF       	LD	DE,KBUF
DC0E E1             	POP	HL
DC0F E5             	PUSH	HL
DC10 0E 00          	LD	C,0
DC12 30 04          	JR	NC,SAX0
DC14 23             	INC	HL
DC15 23             	INC	HL
DC16 18 08          	JR	SAX4
DC18                SAX0:
DC18 46             	LD	B,(HL)
DC19 23             	INC	HL
DC1A                SAX1:
DC1A 23             	INC	HL
DC1B 1A             	LD	A,(DE)
DC1C 13             	INC	DE
DC1D B7             	OR	A
DC1E 20 04          	JR	NZ,SAX2
DC20                SAX4:
DC20 36 0D          	LD	(HL),00DH
DC22 18 04          	JR	SAX3
DC24                SAX2:
DC24 77             	LD	(HL),A
DC25 0C             	INC	C
DC26 10 F2          	DJNZ	SAX1
DC28                SAX3:
DC28 D1             	POP	DE
DC29 79             	LD	A,C
DC2A 13             	INC	DE
DC2B 12             	LD	(DE),A
DC2C 1B             	DEC	DE
DC2D E1             	POP	HL
DC2E C1             	POP	BC
DC2F A7             	AND	A
DC30 C9             	RET
DC31                
DC31                _SYS0B:		;(BDOS)コンソール状態のチェック
DC31 CD D1 DB       	CALL	BREAK
DC34 3A 92 F0       	LD	A,(_KEYD)
DC37 B7             	OR	A
DC38 C8             	RET	Z
DC39                CONSTX:
DC39 CD DF F0       	CALL	_FFLUSH
DC3C E5             	PUSH	HL
DC3D 2A 90 F0       	LD	HL,(_KEYPS)
DC40 7C             	LD	A,H
DC41 AD             	XOR	L
DC42 E1             	POP	HL
DC43 C6 FF          	ADD	A,0FFH
DC45 9F             	SBC	A,A
DC46 C9             	RET
DC47                
DC47                _SYS2A:		;(BDOS)日付の獲得
DC47 C5             	PUSH	BC
DC48 3E ED          	LD	A,0EDH		;Read calendar
DC4A CD D9 DE       	CALL	COMOUT
DC4D CD 7F DC       	CALL	IN49SB_BCD	;YY
DC50 6F             	LD	L,A
DC51 26 00          	LD	H,0
DC53                ;	LD	DE,1900		;0076CH
DC53                ;	CP	90		;90以上は1900年代 1990-1999
DC53                ;	JR	NC,RDDATE1	;90未満は2000年代 2000-2089
DC53                ;	LD	E,0D0H		;2000 & 0FFH D=007H
DC53 11 D0 07       	LD	DE,2000		;すべて2000年代で処理 2000-2099
DC56                RDDATE1:
DC56 19             	ADD	HL,DE
DC57 CD BE DE       	CALL	IN49SB		;MW
DC5A 57             	LD	D,A
DC5B CD 7F DC       	CALL	IN49SB_BCD	;DD
DC5E 5F             	LD	E,A
DC5F 7A             	LD	A,D
DC60 06 04          	LD	B,4
DC62                RDDATE2:
DC62 CB 3A          	SRL	D
DC64 10 FC          	DJNZ	RDDATE2
DC66 C1             	POP	BC
DC67 E6 07          	AND	7
DC69 C9             	RET
DC6A                
DC6A                _SYS2C:		;(BDOS)時刻の獲得
DC6A C5             	PUSH	BC
DC6B 3E EF          	LD	A,0EFH		;Read time
DC6D CD D9 DE       	CALL	COMOUT
DC70 CD 7F DC       	CALL	IN49SB_BCD	;TT
DC73 67             	LD	H,A
DC74 CD 7F DC       	CALL	IN49SB_BCD	;MM
DC77 6F             	LD	L,A
DC78 CD 7F DC       	CALL	IN49SB_BCD	;SS
DC7B 57             	LD	D,A
DC7C C1             	POP	BC
DC7D AF             	XOR	A
DC7E C9             	RET
DC7F                
DC7F                IN49SB_BCD:
DC7F CD BE DE       	CALL	IN49SB
DC82                ;------------------------
DC82                ;BCDの10進数化
DC82                ;in
DC82                ;	A  : BCD
DC82                ;out
DC82                ;	A  : 10進数
DC82                ;------------------------
DC82 4F             	LD	C,A
DC83 E6 F0          	AND	0F0H	;10の位
DC85 0F             	RRCA
DC86 47             	LD	B,A
DC87 0F             	RRCA
DC88 0F             	RRCA
DC89 80             	ADD	A,B
DC8A 47             	LD	B,A
DC8B 79             	LD	A,C
DC8C E6 0F          	AND	00FH	;1の位
DC8E 80             	ADD	A,B
DC8F C9             	RET
DC90                
DC90                ESC1:
DC90 7B             	LD	A,E
DC91 FE 41          	CP	'A'
DC93 CA DA DD       	JP	Z,CTRL1E
DC96 FE 42          	CP	'B'
DC98 CA 44 DF       	JP	Z,CTRL1F
DC9B FE 43          	CP	'C'
DC9D CA E5 DD       	JP	Z,CTRL1C
DCA0 FE 44          	CP	'D'
DCA2 CA D1 DD       	JP	Z,CTRL1D
DCA5 FE 45          	CP	'E'
DCA7 28 02          	JR	Z,CT0CX
DCA9 FE 6A          	CP	'j'
DCAB                CT0CX:
DCAB CA 17 DF       	JP	Z,CTRL0C
DCAE FE 48          	CP	'H'
DCB0 CA 5F DE       	JP	Z,CTRL0B
DCB3 FE 4A          	CP	'J'
DCB5 CA 1A DF       	JP	Z,CTRL06
DCB8 FE 4B          	CP	'K'
DCBA CA 1E DE       	JP	Z,CTRL05
DCBD FE 4C          	CP	'L'
DCBF CA 59 DF       	JP	Z,CTRL0E
DCC2 FE 54          	CP	'T'
DCC4 CA 1E DE       	JP	Z,CTRL05
DCC7 FE 78          	CP	'x'
DCC9 28 04          	JR	Z,ESC1X
DCCB FE 79          	CP	'y'
DCCD 20 02          	JR	NZ,ESC1Y
DCCF                ESC1X:
DCCF 36 01          	LD	(HL),1
DCD1                ESC1Y:
DCD1 FE 3D          	CP	'='
DCD3 28 04          	JR	Z,ESC1W
DCD5 FE 59          	CP	'Y'
DCD7 20 02          	JR	NZ,ESC1Z
DCD9                ESC1W:
DCD9 36 02          	LD	(HL),2
DCDB                ESC1Z:
DCDB FE 20          	CP	020H
DCDD 38 02          	JR	C,ESC1C
DCDF 87             	ADD	A,A
DCE0 D0             	RET	NC
DCE1                ESC1C:
DCE1 E1             	POP	HL
DCE2 18 4F          	JR	ANK
DCE4                
DCE4                ESC:
DCE4 21 44 DD       	LD	HL,PRINTE5
DCE7 E5             	PUSH	HL
DCE8 21 0A DD       	LD	HL,ESCFLG+1
DCEB 36 00          	LD	(HL),0
DCED 3D             	DEC	A
DCEE 28 A0          	JR	Z,ESC1
DCF0 3D             	DEC	A
DCF1 20 09          	JR	NZ,ESC2
DCF3 36 03          	LD	(HL),3
DCF5 7B             	LD	A,E
DCF6 D6 20          	SUB	020H
DCF8 32 FF DC       	LD	(ESCYP+1),A
DCFB C9             	RET
DCFC                ESC2:
DCFC 3D             	DEC	A
DCFD C0             	RET	NZ
DCFE 26 00          ESCYP:	LD	H,0
DD00 7B             	LD	A,E
DD01 D6 20          	SUB	020H
DD03 6F             	LD	L,A
DD04 C3 D6 F0       	JP	_LOC
DD07                
DD07                PRINT:
DD07 C5             	PUSH	BC
DD08 E5             	PUSH	HL
DD09 3E 00          ESCFLG:	LD	A,000H
DD0B B7             	OR	A
DD0C 20 D6          	JR	NZ,ESC
DD0E                
DD0E 3E 1F          	LD	A,01FH
DD10 BB             	CP	E
DD11 30 35          	JR	NC,CTRL
DD13 01 E2 DE       INSFLG:	LD	BC,INSERT
DD16                
DD16 3A 18 00       	LD	A,(00018H)
DD19 3C             	INC	A
DD1A 28 17          	JR	Z,ANK
DD1C 3E 00          KANFLG:	LD	A,000H
DD1E B7             	OR	A
DD1F 20 3A          	JR	NZ,KANJI2
DD21 7B             	LD	A,E
DD22 FE 80          	CP	080H
DD24 38 0D          	JR	C,ANK
DD26 FE A0          	CP	0A0H
DD28 38 04          	JR	C,KANJI1
DD2A FE E0          	CP	0E0H
DD2C 38 05          	JR	C,ANK
DD2E                KANJI1:
DD2E 32 1D DD       	LD	(KANFLG+1),A
DD31 18 11          	JR	PRINTE5
DD33                ANK:
DD33 ED 4B 8E F0    	LD	BC,(_TXADR)
DD37 78             	LD	A,B
DD38 F6 38          	OR	038H
DD3A 47             	LD	B,A
DD3B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DD3D CB 98          	RES	3,B
DD3F ED 59          	OUT	(C),E		;Text
DD41                KANJIE:
DD41 CD A6 DD       	CALL	PRINTE7
DD44                PRINTE5:
DD44 E1             	POP	HL
DD45 C1             	POP	BC
DD46 AF             	XOR	A
DD47 C9             	RET
DD48                
DD48                CTRL:
DD48 CD 8D DD       	CALL	KANCLR
DD4B 7B             	LD	A,E
DD4C 87             	ADD	A,A
DD4D F6 80          	OR	080H
DD4F 6F             	LD	L,A
DD50 26 F1          	LD	H,CTRLTB/256
DD52 7E             	LD	A,(HL)
DD53 2C             	INC	L
DD54 66             	LD	H,(HL)
DD55 6F             	LD	L,A
DD56 CD 0F 00       	CALL	JP_HL
DD59 18 E9          	JR	PRINTE5
DD5B                
DD5B                KANJI2:
DD5B D5             	PUSH	DE
DD5C 57             	LD	D,A
DD5D 01 81 2F       	LD	BC,02F81H	;SFTJIS
DD60 DF             	RST	018H
DD61 01 C3 2F       	LD	BC,02FC3H	;Instead or JISVRM
DD64 DF             	RST	018H
DD65                
DD65 ED 4B 8E F0    	LD	BC,(_TXADR)
DD69 78             	LD	A,B
DD6A F6 38          	OR	038H
DD6C 47             	LD	B,A
DD6D ED 51          	OUT	(C),D		;kanji
DD6F CB 98          	RES	3,B
DD71 ED 59          	OUT	(C),E		;Text
DD73 CD A6 DD       	CALL	PRINTE7
DD76 ED 4B 8E F0    	LD	BC,(_TXADR)
DD7A 78             	LD	A,B
DD7B F6 38          	OR	038H
DD7D 47             	LD	B,A
DD7E CB F2          	SET	6,D
DD80 ED 51          	OUT	(C),D		;Kanji
DD82 CB 98          	RES	3,B
DD84 ED 59          	OUT	(C),E		;Text
DD86 D1             	POP	DE
DD87 AF             	XOR	A
DD88 32 1D DD       	LD	(KANFLG+1),A
DD8B 18 B4          	JR	KANJIE
DD8D                
DD8D                KANCLR:
DD8D 3A 1D DD       	LD	A,(KANFLG+1)
DD90 B7             	OR	A
DD91 C8             	RET	Z
DD92 ED 4B 8E F0    	LD	BC,(_TXADR)
DD96 78             	LD	A,B
DD97 F6 38          	OR	038H
DD99 47             	LD	B,A
DD9A AF             	XOR	A
DD9B 32 1D DD       	LD	(KANFLG+1),A
DD9E ED 79          	OUT	(C),A		;Kanji
DDA0 CB 98          	RES	3,B
DDA2 3E 20          	LD	A,020H
DDA4 ED 79          	OUT	(C),A		;Text
DDA6                PRINTE7:
DDA6 CB A0          	RES	4,B
DDA8                PRINTE6:
DDA8 3A 96 F0       	LD	A,(_COLORF)
DDAB                PRINTE4:
DDAB ED 79          	OUT	(C),A		;Color
DDAD 78             	LD	A,B
DDAE E6 07          	AND	7
DDB0 47             	LD	B,A
DDB1                PRINTE2:
DDB1 03             	INC	BC
DDB2                PRINTE3:
DDB2 2A BA F0       	LD	HL,(_PAGE_MINUS)
DDB5 A7             	AND	A
DDB6 ED 4A          	ADC	HL,BC
DDB8                PRINTE8:
DDB8 28 05          	JR	Z,PRINT2
DDBA ED 43 8E F0    	LD	(_TXADR),BC
DDBE                CTRL00:
DDBE C9             	RET
DDBF                
DDBF                PRINT2:
DDBF CD 5F DF       	CALL	SCR
DDC2 2A BC F0       	LD	HL,(_WIDTH_MINUS)
DDC5 09             	ADD	HL,BC
DDC6                SET_TXADR_HL:
DDC6 22 8E F0       	LD	(_TXADR),HL
DDC9 C9             	RET
DDCA                
DDCA                CTRL08:
DDCA 3A 13 DD       	LD	A,(INSFLG)
DDCD FE CD          	CP	0CDH		;CALL ????
DDCF 28 29          	JR	Z,CTRL02
DDD1                CTRL1D:
DDD1 2A 8E F0       	LD	HL,(_TXADR)
DDD4 7C             	LD	A,H
DDD5 B5             	OR	L
DDD6 C8             	RET	Z
DDD7 2B             	DEC	HL
DDD8 18 EC          	JR	SET_TXADR_HL
DDDA                
DDDA                CTRL1E:
DDDA ED 4B 8E F0    	LD	BC,(_TXADR)
DDDE 2A BC F0       	LD	HL,(_WIDTH_MINUS)
DDE1 09             	ADD	HL,BC
DDE2 D0             	RET	NC
DDE3 18 E1          	JR	SET_TXADR_HL
DDE5                
DDE5                CTRL1C:
DDE5 ED 4B 8E F0    	LD	BC,(_TXADR)
DDE9 18 C6          	JR	PRINTE2
DDEB                
DDEB                CTRL09:
DDEB ED 4B 8E F0    	LD	BC,(_TXADR)
DDEF 79             	LD	A,C
DDF0 E6 F8          	AND	0F8H
DDF2 C6 08          	ADD	A,8
DDF4 4F             	LD	C,A
DDF5 88             	ADC	A,B
DDF6 91             	SUB	C
DDF7 47             	LD	B,A
DDF8 18 B8          	JR	PRINTE3
DDFA                
DDFA                CTRL02:
DDFA CD D1 DD       	CALL	CTRL1D
DDFD C8             	RET	Z
DDFE D5             	PUSH	DE
DDFF CD D3 F0       	CALL	_POS
DE02 3A B1 F0       	LD	A,(_WIDTH)
DE05 95             	SUB	L
DE06 4F             	LD	C,A
DE07 0D             	DEC	C
DE08 06 38          	LD	B,038H
DE0A 2A 8E F0       	LD	HL,(_TXADR)
DE0D 09             	ADD	HL,BC
DE0E 44             	LD	B,H
DE0F 4D             	LD	C,L
DE10 11 00 20       	LD	DE,02000H	;D:Text E:kanji
DE13 2A 96 F0       	LD	HL,(_COLORF)	;L:Color
DE16                C8X1:
DE16 CD FE DE       	CALL	C12S
DE19 0B             	DEC	BC
DE1A 20 FA          	JR	NZ,C8X1
DE1C D1             	POP	DE
DE1D C9             	RET
DE1E                
DE1E                CTRL05:
DE1E CD D3 F0       	CALL	_POS
DE21 3A B1 F0       	LD	A,(_WIDTH)
DE24 95             	SUB	L
DE25 6F             	LD	L,A
DE26                C08X1:
DE26 ED 4B 8E F0    	LD	BC,(_TXADR)
DE2A                LINECL:
DE2A 26 20          	LD	H,020H
DE2C 3A 96 F0       	LD	A,(_COLORF)
DE2F CB E8          	SET	5,B
DE31                LINECL1:
DE31 CB D8          	SET	3,B
DE33 CB E0          	SET	4,B
DE35 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DE37 CB 98          	RES	3,B
DE39 ED 61          	OUT	(C),H		;Text
DE3B CB A0          	RES	4,B
DE3D ED 79          	OUT	(C),A		;Color
DE3F 03             	INC	BC
DE40 2D             	DEC	L
DE41 20 EE          	JR	NZ,LINECL1
DE43 C9             	RET
DE44                
DE44                CTRL0D:
DE44 CD D3 F0       	CALL	_POS
DE47 2E 00          	LD	L,0
DE49                LOC:
DE49 C5             	PUSH	BC
DE4A E5             	PUSH	HL
DE4B CD 8D DD       	CALL	KANCLR
DE4E CD 6C DE       	CALL	LOC1
DE51 22 8E F0       	LD	(_TXADR),HL
DE54 E1             	POP	HL
DE55 C1             	POP	BC
DE56 C9             	RET
DE57                
DE57                CTRL12:
DE57 21 13 DD       	LD	HL,INSFLG
DE5A 7E             	LD	A,(HL)
DE5B EE CC          	XOR	0CCH		;CD:CALL ???? 1:LD BC,????
DE5D 77             	LD	(HL),A
DE5E C9             	RET
DE5F                
DE5F                CTRL0B:
DE5F 21 00 00       	LD	HL,0
DE62 22 8E F0       	LD	(_TXADR),HL
DE65 C9             	RET
DE66                
DE66                CTRL1B:
DE66 3E 01          	LD	A,1
DE68 32 0A DD       	LD	(ESCFLG+1),A
DE6B C9             	RET
DE6C                
DE6C                LOC1:
DE6C D5             	PUSH	DE
DE6D 4D             	LD	C,L
DE6E 06 08          	LD	B,8
DE70 5C             	LD	E,H
DE71 16 00          	LD	D,0
DE73 2A B0 F0       	LD	HL,(CRTCD)
DE76 6A             	LD	L,D
DE77                LOC2:
DE77 29             	ADD	HL,HL
DE78 30 01          	JR	NC,LOC3
DE7A 19             	ADD	HL,DE
DE7B                LOC3:
DE7B 10 FA          	DJNZ	LOC2
DE7D 09             	ADD	HL,BC
DE7E D1             	POP	DE
DE7F C9             	RET
DE80                
DE80                CONOUT1:
DE80 CD 92 DE       	CALL	CURSOR
DE83 59             	LD	E,C
DE84 CD CD F0       	CALL	_PRINT
DE87 7B             	LD	A,E
DE88 FE 0A          	CP	00AH
DE8A 20 06          	JR	NZ,CURSOR
DE8C CD 44 DE       	CALL	CTRL0D
DE8F CD 1E DE       	CALL	CTRL05
DE92                CURSOR:
DE92 C5             	PUSH	BC
DE93 ED 4B 8E F0    	LD	BC,(_TXADR)
DE97 CB E8          	SET	5,B
DE99 ED 78          	IN	A,(C)
DE9B EE 18          	XOR	018H
DE9D ED 79          	OUT	(C),A
DE9F C1             	POP	BC
DEA0 C9             	RET
DEA1                
DEA1                CTRL07:
DEA1 21 61 F0       	LD	HL,BEEPD
DEA4                BEEP1:
DEA4 7E             	LD	A,(HL)
DEA5 23             	INC	HL
DEA6 FE FF          	CP	0FFH
DEA8 C8             	RET	Z
DEA9 F3             	DI
DEAA 06 1C          	LD	B,01CH
DEAC ED 79          	OUT	(C),A
DEAE ED A3          	OUTI
DEB0 FB             	EI
DEB1 18 F1          	JR	BEEP1
DEB3                
DEB3                OT49SB:
DEB3 C5             	PUSH	BC
DEB4 CD CF DE       	CALL	CANW
DEB7 01 00 19       	LD	BC,01900H
DEBA ED 79          	OUT	(C),A
DEBC C1             	POP	BC
DEBD C9             	RET
DEBE                
DEBE                IN49SB:
DEBE C5             	PUSH	BC
DEBF 01 01 1A       	LD	BC,01A01H
DEC2                CANR:
DEC2 ED 78          	IN	A,(C)
DEC4 E6 20          	AND	020H
DEC6 20 FA          	JR	NZ,CANR
DEC8 01 00 19       	LD	BC,01900H
DECB ED 78          	IN	A,(C)
DECD C1             	POP	BC
DECE C9             	RET
DECF                
DECF                CANW:
DECF 01 01 1A       	LD	BC,01A01H
DED2 ED 48          	IN	C,(C)
DED4 CB 71          	BIT	6,C
DED6 20 F7          	JR	NZ,CANW
DED8 C9             	RET
DED9                
DED9                COMOUT:
DED9 FB             	EI
DEDA CD B3 DE       	CALL	OT49SB
DEDD CD CF DE       	CALL	CANW
DEE0 F3             	DI
DEE1 C9             	RET
DEE2                
DEE2                INSERT:
DEE2 D5             	PUSH	DE
DEE3 CD D3 F0       	CALL	_POS
DEE6 3A B1 F0       	LD	A,(_WIDTH)
DEE9 95             	SUB	L
DEEA ED 4B 8E F0    	LD	BC,(_TXADR)
DEEE 11 00 20       	LD	DE,02000H	;D:Text E:Kanji
DEF1 2A 96 F0       	LD	HL,(_COLORF)	;L:Color
DEF4 CB E8          	SET	5,B
DEF6                C12X1:
DEF6 CD FE DE       	CALL	C12S
DEF9 03             	INC	BC
DEFA 20 FA          	JR	NZ,C12X1
DEFC D1             	POP	DE
DEFD C9             	RET
DEFE                
DEFE                C12S:
DEFE CB E0          	SET	4,B
DF00 CB D8          	SET	3,B
DF02 ED 60          	IN	H,(C)
DF04 ED 59          X1PAT:	OUT	(C),E
DF06 5C             	LD	E,H
DF07 CB 98          	RES	3,B
DF09 ED 60          	IN	H,(C)
DF0B ED 51          	OUT	(C),D
DF0D 54             	LD	D,H
DF0E CB A0          	RES	4,B
DF10 ED 60          	IN	H,(C)
DF12 ED 69          	OUT	(C),L
DF14 6C             	LD	L,H
DF15 3D             	DEC	A
DF16 C9             	RET
DF17                
DF17                CTRL0C:
DF17 CD 5F DE       	CALL	CTRL0B
DF1A                CTRL06:
DF1A ED 4B 8E F0    	LD	BC,(_TXADR)
DF1E                C1AX1:
DF1E 78             	LD	A,B
DF1F F6 38          	OR	038H
DF21 47             	LD	B,A
DF22 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DF24 CB 98          	RES	3,B
DF26 3E 20          	LD	A,020H
DF28 ED 79          	OUT	(C),A		;Text
DF2A CB A0          	RES	4,B
DF2C 3A 96 F0       	LD	A,(_COLORF)
DF2F ED 79          	OUT	(C),A		;Color
DF31 03             	INC	BC
DF32 CB A8          	RES	5,B
DF34 2A BA F0       	LD	HL,(_PAGE_MINUS)
DF37 09             	ADD	HL,BC
DF38 30 E4          	JR	NC,C1AX1
DF3A C9             	RET
DF3B                
DF3B                CTRL04:
DF3B CD D3 F0       	CALL	_POS
DF3E 7D             	LD	A,L
DF3F B7             	OR	A
DF40 C8             	RET	Z
DF41                CTRL03:
DF41 CD 44 DE       	CALL	CTRL0D
DF44                CTRL0A:
DF44                CTRL1F:
DF44 ED 4B 8E F0    	LD	BC,(_TXADR)
DF48 2A B1 F0       	LD	HL,(_WIDTH)
DF4B 26 00          	LD	H,0
DF4D 09             	ADD	HL,BC
DF4E 44             	LD	B,H
DF4F 4D             	LD	C,L
DF50 2A BA F0       	LD	HL,(_PAGE_MINUS)
DF53 09             	ADD	HL,BC
DF54 3F             	CCF
DF55 9F             	SBC	A,A
DF56 C3 B8 DD       	JP	PRINTE8
DF59                
DF59                CTRL0E:
DF59 CD D3 F0       	CALL	_POS
DF5C 7C             	LD	A,H
DF5D 18 04          	JR	SCR1
DF5F                SCR:
DF5F 3A 97 F0       	LD	A,(_LINE)
DF62 3D             	DEC	A
DF63                SCR1:
DF63 C5             	PUSH	BC
DF64 D5             	PUSH	DE
DF65 F5             	PUSH	AF
DF66 3E 07          	LD	A,7
DF68 21 99 DF       	LD	HL,SCRDMAD
DF6B CD 8F DF       	CALL	SETDMA
DF6E F1             	POP	AF
DF6F 21 00 38       	LD	HL,03800H
DF72                
DF72                SCRUP1:
DF72 B7             	OR	A
DF73 28 4D          	JR	Z,SCRCL
DF75 F5             	PUSH	AF
DF76 CD A0 DF       	CALL	UPSUB		;kanji
DF79 3A BC F0       	LD	A,(_WIDTH_MINUS)
DF7C 5F             	LD	E,A
DF7D 16 F7          	LD	D,0F7H
DF7F 19             	ADD	HL,DE
DF80 D5             	PUSH	DE
DF81 CD A0 DF       	CALL	UPSUB		;Text
DF84 D1             	POP	DE
DF85 19             	ADD	HL,DE
DF86 CD A0 DF       	CALL	UPSUB		;Color
DF89 CB E4          	SET	4,H
DF8B F1             	POP	AF
DF8C 3D             	DEC	A
DF8D 18 E3          	JR	SCRUP1
DF8F                
DF8F                SETDMA:
DF8F 01 87 1F       	LD	BC,01F87H
DF92                SDMA:
DF92 04             	INC	B
DF93 ED A3          	OUTI
DF95 3D             	DEC	A
DF96 20 FA          	JR	NZ,SDMA
DF98 C9             	RET
DF99                
DF99                SCRDMAD:
DF99 C3             	DB	0C3H		;WR6 リセット
DF9A 9A             	DB	09AH		;WR5 ストップ WAIT READY:HIGH
DF9B 65             	DB	065H		;WR0 ブロック長(LH)
DF9C 4F 00          	DW	79
DF9E 1C             	DB	01CH		;WR1 ポートAインクリメント I/O
DF9F 18             	DB	018H		;WR0 ポートAアドレス(LH)
DFA0                
DFA0                UPSUB:
DFA0 3A B1 F0       	LD	A,(_WIDTH)
DFA3 5F             	LD	E,A
DFA4 16 00          	LD	D,0
DFA6 3E CD          	LD	A,0CDH		;WR4 バースト ポートB開始アドレス(LH)
DFA8 ED 79          	OUT	(C),A
DFAA ED 69          	OUT	(C),L		;SOURCE
DFAC ED 61          	OUT	(C),H
DFAE 19             	ADD	HL,DE
DFAF 3E 1D          	LD	A,01DH		;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
DFB1 ED 79          	OUT	(C),A
DFB3 ED 69          	OUT	(C),L		;DEST
DFB5 ED 61          	OUT	(C),H
DFB7                GO_DMA:
DFB7 3E CF          	LD	A,0CFH
DFB9 ED 79          	OUT	(C),A		;WR6 ロード
DFBB 3E B3          	LD	A,0B3H
DFBD ED 79          	OUT	(C),A		;WR6 強制RDY
DFBF ED 49          	OUT	(C),C		;WR6 イネーブル
DFC1 C9             	RET
DFC2                
DFC2                SCRCL:
DFC2 44             	LD	B,H
DFC3 4D             	LD	C,L
DFC4 2A B1 F0       	LD	HL,(_WIDTH)
DFC7 CD 2A DE       	CALL	LINECL
DFCA D1             	POP	DE
DFCB C1             	POP	BC
DFCC C9             	RET
DFCD                
DFCD                SCRN:
DFCD D5             	PUSH	DE
DFCE ED 58          	IN	E,(C)		;Text
DFD0 3A 18 00       	LD	A,(00018H)
DFD3 3C             	INC	A
DFD4 28 1E          	JR	Z,SCRN2
DFD6 CB D8          	SET	3,B
DFD8 ED 50          	IN	D,(C)		;Kanji
DFDA 28 16          	JR	Z,SCRN1
DFDC AF             	XOR	A
DFDD C5             	PUSH	BC
DFDE 01 37 30       	LD	BC,03037H	;VRMJIS
DFE1 DF             	RST	018H
DFE2 01 52 2F       	LD	BC,02F52H	;JISSFT
DFE5 DF             	RST	018H
DFE6 C1             	POP	BC
DFE7 ED 78          	IN	A,(C)
DFE9 CB 98          	RES	3,B
DFEB E6 40          	AND	040H
DFED 20 05          	JR	NZ,SCRN2
DFEF 7A             	LD	A,D
DFF0 D1             	POP	DE
DFF1 C9             	RET
DFF2                SCRN1:
DFF2 CB 98          	RES	3,B
DFF4                SCRN2:
DFF4 7B             	LD	A,E
DFF5 D1             	POP	DE
DFF6 C9             	RET
DFF7                SCRNE:
DFF7                POS:
DFF7 2A 8E F0       	LD	HL,(_TXADR)
DFFA C5             	PUSH	BC
DFFB ED 4B BC F0    	LD	BC,(_WIDTH_MINUS)
DFFF AF             	XOR	A
E000                POS1:
E000 09             	ADD	HL,BC
E001 3C             	INC	A
E002 38 FC          	JR	C,POS1
E004 ED 42          	SBC	HL,BC
E006 3D             	DEC	A
E007 67             	LD	H,A
E008 C1             	POP	BC
E009 A7             	AND	A
E00A C9             	RET
E00B                
E00B                GETL:
E00B CD D3 F0       	CALL	_POS
E00E E5             	PUSH	HL
E00F 3E CD          	LD	A,0CDH		;CALL ????
E011 32 13 DD       	LD	(INSFLG),A
E014                GETL1:
E014 CD CC DB       	CALL	_SYS08
E017 FE 09          	CP	9
E019 20 08          	JR	NZ,GETL1V
E01B 21 20 FF       	LD	HL,KBUF
E01E CD 70 D8       	CALL	MSX
E021 18 F1          	JR	GETL1
E023                GETL1V:
E023 5F             	LD	E,A
E024 CD CD F0       	CALL	_PRINT
E027                
E027 7B             	LD	A,E
E028 FE 0D          	CP	00DH
E02A 20 E8          	JR	NZ,GETL1
E02C 3E 01          	LD	A,1		;LD BC,????
E02E 32 13 DD       	LD	(INSFLG),A
E031 11 20 FF       	LD	DE,KBUF
E034 3A B1 F0       	LD	A,(_WIDTH)
E037 47             	LD	B,A
E038 CD D3 D5       	CALL	ZERO_MEMORY_DE
E03B                
E03B D1             	POP	DE
E03C CD D3 F0       	CALL	_POS
E03F 6B             	LD	L,E
E040 3A B1 F0       	LD	A,(_WIDTH)
E043 95             	SUB	L
E044 57             	LD	D,A
E045 CD 6C DE       	CALL	LOC1
E048 4D             	LD	C,L
E049 7C             	LD	A,H
E04A F6 30          	OR	030H
E04C 47             	LD	B,A
E04D 5A             	LD	E,D
E04E 21 20 FF       	LD	HL,KBUF
E051                GETL2:
E051 CD D0 F0       	CALL	_SCRN
E054 03             	INC	BC
E055 77             	LD	(HL),A
E056 23             	INC	HL
E057 1D             	DEC	E
E058 20 F7          	JR	NZ,GETL2
E05A                GETL3:
E05A 2B             	DEC	HL
E05B 7E             	LD	A,(HL)
E05C FE 21          	CP	021H
E05E D0             	RET	NC
E05F 36 00          	LD	(HL),0
E061 15             	DEC	D
E062 20 F6          	JR	NZ,GETL3
E064 C9             	RET
E065                
E065                INKEY:
E065 FB             	EI
E066 E5             	PUSH	HL
E067 2A 90 F0       	LD	HL,(_KEYPS)
E06A 7C             	LD	A,H
E06B AD             	XOR	L
E06C 28 0B          	JR	Z,INKEY1
E06E 7C             	LD	A,H
E06F 3C             	INC	A
E070 E6 1F          	AND	01FH
E072 32 91 F0       	LD	(_KEYPS+1),A
E075 6F             	LD	L,A
E076 26 FF          	LD	H,KEYBF/256
E078 7E             	LD	A,(HL)
E079                INKEY1:
E079 E1             	POP	HL
E07A B7             	OR	A
E07B C9             	RET
E07C                
E07C 00 00 0F 47    AT_RS	EQU	SCR1-AT_SCR1
E07C                	INCLUDE	"LDFILE.ASM"
E07C                
E07C                ;	LSX-Dodgers FILE
E07C                
E07C                FILEC:
E07C CD 87 E0       	CALL	FILE
E07F                FILEC2:
E07F 3A 15 F0       	LD	A,(FDRV+1)
E082 FE 20          	CP	020H
E084 C8             	RET	Z
E085 18 39          	JR	SETDIR1
E087                
E087                FILE:
E087 AF             	XOR	A
E088 32 14 F0       	LD	(FDRV),A
E08B 67             	LD	H,A
E08C 6F             	LD	L,A
E08D 22 22 F0       	LD	(FDRV+14),HL
E090 CD 5E E1       	CALL	SPCUT
E093 CD 43 E1       	CALL	CCHK3
E096 28 12          	JR	Z,DEVI1
E098 13             	INC	DE
E099 1A             	LD	A,(DE)
E09A 1B             	DEC	DE
E09B FE 3A          	CP	':'
E09D 20 0B          	JR	NZ,DEVI1
E09F 1A             	LD	A,(DE)		;DRIVE
E0A0 CD 93 E3       	CALL	CAP
E0A3 D6 40          	SUB	'@'
E0A5 13             	INC	DE
E0A6 13             	INC	DE
E0A7 32 14 F0       	LD	(FDRV),A
E0AA                DEVI1:
E0AA 1A             	LD	A,(DE)
E0AB D6 5C          	SUB	05CH		;\
E0AD 20 09          	JR	NZ,NOROOT
E0AF 6F             	LD	L,A		;A=0でH=0のはずなのでHL=0
E0B0 22 2E F0       	LD	(FDRV+26),HL
E0B3 2C             	INC	L
E0B4 22 22 F0       	LD	(FDRV+14),HL
E0B7 13             	INC	DE
E0B8                NOROOT:
E0B8                
E0B8                SETDIR:
E0B8 CD E4 E0       	CALL	FILED
E0BB 1A             	LD	A,(DE)
E0BC FE 5C          	CP	05CH		;\
E0BE C0             	RET	NZ
E0BF 13             	INC	DE
E0C0                SETDIR1:
E0C0 3E 10          	LD	A,010H		;Directory
E0C2 32 21 F0       	LD	(FDRV+13),A
E0C5 D5             	PUSH	DE
E0C6 11 14 F0       	LD	DE,FDRV
E0C9 2A 1E F1       	LD	HL,(STABLE+2*00FH)
E0CC CD 0F 00       	CALL	JP_HL
E0CF D1             	POP	DE
E0D0 B7             	OR	A
E0D1 C0             	RET	NZ
E0D2                
E0D2 3A 21 F0       	LD	A,(FDRV+13)
E0D5 CB 67          	BIT	4,A
E0D7 C8             	RET	Z
E0D8                
E0D8 CD 2B E1       	CALL	FILEI
E0DB 2A 2E F0       	LD	HL,(FDRV+26)
E0DE 23             	INC	HL
E0DF 22 22 F0       	LD	(FDRV+14),HL
E0E2 18 D4          	JR	SETDIR
E0E4                
E0E4                FILED:
E0E4 CD 2B E1       	CALL	FILEI
E0E7 21 15 F0       	LD	HL,FNAME
E0EA                
E0EA 06 08          	LD	B,8
E0EC                FILE2:
E0EC CD 38 E1       	CALL	CCHKF
E0EF C8             	RET	Z
E0F0 FE 2A          	CP	'*'
E0F2 28 2E          	JR	Z,FILE9
E0F4 FE 2E          	CP	'.'
E0F6 28 0C          	JR	Z,FILE4
E0F8 77             	LD	(HL),A
E0F9 23             	INC	HL
E0FA 10 F0          	DJNZ	FILE2
E0FC                
E0FC                FILE3:
E0FC CD 38 E1       	CALL	CCHKF
E0FF C8             	RET	Z
E100 FE 2E          	CP	'.'
E102 20 F8          	JR	NZ,FILE3
E104                
E104                FILE4:
E104 21 1D F0       	LD	HL,FNAME+8
E107 06 03          	LD	B,3
E109                
E109                FILE4L:
E109 CD 38 E1       	CALL	CCHKF
E10C C8             	RET	Z
E10D FE 2E          	CP	'.'
E10F 20 08          	JR	NZ,FILE12
E111 32 15 F0       	LD	(FNAME),A	;Parent directory(..)
E114 32 16 F0       	LD	(FNAME+1),A
E117 3E 20          	LD	A,020H
E119                FILE12:
E119 FE 2A          	CP	'*'
E11B 28 0A          	JR	Z,FILE10
E11D 77             	LD	(HL),A
E11E 23             	INC	HL
E11F 10 E8          	DJNZ	FILE4L
E121 C9             	RET
E122                
E122                FILE9:				;名前の*処理、名前の残りを?で埋める
E122 CD 27 E1       	CALL	FILE10
E125 18 D5          	JR	FILE3
E127                
E127                FILE10:
E127 3E 3F          	LD	A,'?'
E129 18 08          	JR	FILL_MEMORY
E12B                FILEI:				;名前＋拡張子をスペースで初期化
E12B 3E 20          	LD	A,020H
E12D 01 00 0B       	LD	BC,11*256	;C=0にしておく
E130 21 15 F0       	LD	HL,FNAME
E133                FILL_MEMORY:			;HLからBバイトAで埋める
E133 77             	LD	(HL),A
E134 23             	INC	HL
E135 10 FC          	DJNZ	FILL_MEMORY
E137 C9             	RET
E138                
E138                CCHKF:
E138 1A             	LD	A,(DE)
E139 CD 40 E1       	CALL	CCHK2
E13C C8             	RET	Z
E13D C3 AB E4       	JP	FKAN
E140                
E140                CCHK2:
E140 0C             	INC	C
E141 0D             	DEC	C
E142 C0             	RET	NZ
E143                CCHK3:				;ZF=1 で使えない文字
E143 FE 2B          	CP	'+'
E145 C8             	RET	Z
E146 FE 2C          	CP	','
E148 C8             	RET	Z
E149 FE 2F          	CP	'/'
E14B C8             	RET	Z
E14C FE 3A          	CP	':'
E14E C8             	RET	Z
E14F FE 3B          	CP	';'
E151 C8             	RET	Z
E152 FE 3D          	CP	'='
E154 C8             	RET	Z
E155 FE 5C          	CP	05CH	;\
E157 C8             	RET	Z
E158 FE 20          	CP	020H
E15A D0             	RET	NC
E15B BF             	CP	A		;Z=1
E15C C9             	RET
E15D                
E15D                SS1:
E15D 13             	INC	DE
E15E                SPCUT:				;スペースをカット
E15E 1A             	LD	A,(DE)
E15F FE 20          	CP	020H
E161 28 FA          	JR	Z,SS1
E163 C9             	RET
E164                
E164                SETDRVF:
E164 11 14 F0       	LD	DE,FDRV
E167                SETDRV0:
E167 CD 70 E1       	CALL	SETDRV
E16A FD E1          	POP	IY
E16C C1             	POP	BC
E16D D1             	POP	DE
E16E E1             	POP	HL
E16F C9             	RET
E170                
E170                SETDRV:
E170 E3             	EX	(SP),HL		;HL=RETRN ADDRESS
E171 D5             	PUSH	DE		;PUSH HL/DE/BC/IY
E172 C5             	PUSH	BC
E173 1A             	LD	A,(DE)
E174 D5             	PUSH	DE
E175 FD E3          	EX	(SP),IY
E177                
E177 CD 83 E1       	CALL	GETDRV
E17A 3C             	INC	A
E17B FD 77 00       	LD	(IY+0),A	;(FCB)ドライブ番号
E17E 3D             	DEC	A
E17F CD D9 F0       	CALL	_CHGDRV
E182                
E182 E9             	JP	(HL)
E183                
E183                GETDRV:
E183 E6 7F          	AND	07FH
E185 D6 01          	SUB	001H
E187 30 03          	JR	NC,GETDRV1
E189 3A 87 F0       	LD	A,(_DVSW)	;Current Drive
E18C                GETDRV1:
E18C 32 88 F0       	LD	(_DRV),A
E18F C9             	RET
E190                
E190                SOPENX:
E190 11 39 F0       	LD	DE,SFILE
E193 1A             	LD	A,(DE)
E194 FD BE 00       	CP	(IY+0)		;(FCB)ドライブ番号
E197 20 24          	JR	NZ,SOPEN
E199 13             	INC	DE
E19A FD E5          	PUSH	IY
E19C E1             	POP	HL
E19D 23             	INC	HL
E19E CD 2B E3       	CALL	CPFILE
E1A1 20 1A          	JR	NZ,SOPEN
E1A3                
E1A3 2A F4 F1       	LD	HL,(SCDIR)
E1A6 FD 75 0E       	LD	(IY+14),L	;(FCB)アクセスするディレクトリのクラスタ番号+1
E1A9 FD 74 0F       	LD	(IY+15),H
E1AC                
E1AC 2A F8 F1       	LD	HL,(SFNDF)	;Direcroty location and Flags
E1AF 22 9F F0       	LD	(_FILEN),HL
E1B2                
E1B2 ED 5B F6 F1    	LD	DE,(SFBPS)
E1B6 21 39 F0       	LD	HL,SFILE
E1B9 36 FF          	LD	(HL),0FFH
E1BB 23             	INC	HL
E1BC C9             	RET
E1BD                SOPEN:
E1BD 21 D3 E2       	LD	HL,FILESE
E1C0                SOPENC:
E1C0 22 F9 E1       	LD	(OPENPAT+1),HL
E1C3                
E1C3 CD E2 F0       	CALL	_RDFATX		;Detect Media
E1C6 38 56          	JR	C,RDDERR
E1C8                
E1C8 AF             	XOR	A
E1C9 32 9F F0       	LD	(_FILEN),A
E1CC CD D8 E3       	CALL	LDDIRX1		;A=0で呼び出す
E1CF 28 18          	JR	Z,SDIRX1
E1D1                
E1D1 CD C4 E2       	CALL	READ_DIR	;Sub Directory
E1D4 38 08          	JR	C,SDIRX0
E1D6 2A 7E F1       	LD	HL,(_DTBUF)
E1D9 7E             	LD	A,(HL)
E1DA FE 2E          	CP	'.'
E1DC 28 0F          	JR	Z,SOPEN1
E1DE                SDIRX0:
E1DE AF             	XOR	A
E1DF 32 A0 F0       	LD	(_DIRF),A
E1E2 FD 36 0E 01    	LD	(IY+14),1	;(FCB)レコードサイズ
E1E6 FD 77 0F       	LD	(IY+15),A
E1E9                SDIRX1:
E1E9 ED 5B FC F1    	LD	DE,(_DIRPS)	;Root Directory
E1ED                SOPEN1:
E1ED 0E 20          SDECPAT:LD	C,32		;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
E1EF                SOPEN1X:
E1EF CD C4 E2       	CALL	READ_DIR	;FILE SEARCH
E1F2 38 2A          	JR	C,RDDERR
E1F4 2A 7E F1       	LD	HL,(_DTBUF)
E1F7                SOPEN2:
E1F7 D5             	PUSH	DE
E1F8 CD D3 E2       OPENPAT:CALL	FILESE		;(self-modifying code)
E1FB D1             	POP	DE
E1FC 38 6E          	JR	C,SOPENE
E1FE 28 1B          	JR	Z,SCF_FF_RET
E200                SOPEN3:
E200 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E203 B7             	OR	A
E204 20 0C          	JR	NZ,SOPEN5
E206 13             	INC	DE		;ルートディレクトリ
E207 E5             	PUSH	HL
E208 21 0C 00       MD_PAT:	LD	HL,12		;(self-modifying code)MAXDIR
E20B ED 52          	SBC	HL,DE		;CF=0 なので SUB HL,DE
E20D E1             	POP	HL
E20E 20 DD          	JR	NZ,SOPEN1
E210 18 07          	JR	SOPEN6
E212                SOPEN5:
E212 CD 09 EB       	CALL	GNCLX		;END DIR
E215 D8             	RET	C
E216 CD 8B E3       	CALL	ENDCL
E219                SOPEN6:
E219 38 D2          	JR	C,SOPEN1
E21B                SCF_FF_RET:
E21B 37             	SCF			;CF=1
E21C 9F             	SBC	A,A		;A=0FFH
E21D C9             	RET
E21E                
E21E                RDDERR:
E21E BF             	CP	A		;READ ERR CF=1 ZF=1
E21F 37             	SCF
E220 C9             	RET
E221                
E221                NOPEN:
E221 21 D3 E2       	LD	HL,FILESE
E224 22 F9 E1       	LD	(OPENPAT+1),HL
E227 FD 2A 98 F0    	LD	IY,(_FCB)
E22B CD BE E4       	CALL	CHKWILDX
E22E 30 EB          	JR	NC,SCF_FF_RET
E230 FD 7E 00       	LD	A,(IY+0)	;(FCB)ドライブ番号
E233 3D             	DEC	A
E234 32 88 F0       	LD	(_DRV),A
E237 CD D9 F0       	CALL	_CHGDRV
E23A D8             	RET	C
E23B 2A F8 F1       	LD	HL,(SFNDF)	;Direcroty location and Flags
E23E 22 9F F0       	LD	(_FILEN),HL
E241                
E241 CD D3 E3       	CALL	LDDIRX
E244 ED 5B 9A F0    	LD	DE,(_FBPS)
E248 CD C4 E2       	CALL	READ_DIR
E24B 38 D1          	JR	C,RDDERR
E24D 3A 9E F0       	LD	A,(_FBCNT)
E250 3D             	DEC	A
E251 28 AD          	JR	Z,SOPEN3
E253                NOPEN2:
E253 2A 9C F0       	LD	HL,(_FBAD)
E256 01 20 00       	LD	BC,020H
E259 09             	ADD	HL,BC
E25A 4F             	LD	C,A
E25B 18 9A          	JR	SOPEN2
E25D                
E25D                SOPENE2:
E25D 22 9C F0       	LD	(_FBAD),HL
E260 79             	LD	A,C
E261 32 9E F0       	LD	(_FBCNT),A
E264 ED 53 9A F0    	LD	(_FBPS),DE
E268 FD 22 98 F0    	LD	(_FCB),IY
E26C                SOPENE:
E26C AF             	XOR	A
E26D C9             	RET
E26E                
E26E                COPEN:
E26E FD 36 0D 20    	LD	(IY+13),020H	;(FCB)属性(アトリビュート)
E272                
E272 21 F0 E2       	LD	HL,NEXTSE
E275 CD C0 E1       	CALL	SOPENC
E278 D0             	RET	NC
E279 C8             	RET	Z
E27A 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E27D B7             	OR	A
E27E 37             	SCF
E27F C8             	RET	Z		;ルートディレクトリ
E280 06 01          	LD	B,1
E282 CD 1C E5       	CALL	WRDF
E285 D8             	RET	C
E286 ED 5B FE F1    	LD	DE,(_CLPS)
E28A D5             	PUSH	DE
E28B CD 54 E3       	CALL	DCPAT
E28E CD 94 E9       	CALL	DRDNX
E291 2A 7E F1       	LD	HL,(_DTBUF)	;ディレクトリエントリを0クリア
E294 3A 90 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E297 47             	LD	B,A
E298 AF             	XOR	A
E299 4F             	LD	C,A
E29A                COPENCL:
E29A 77             	LD	(HL),A
E29B ED A1          	CPI			;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
E29D EA 9A E2       	JP	PE,COPENCL
E2A0                
E2A0 3A 72 E3       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ数
E2A3 3D             	DEC	A
E2A4 28 19          	JR	Z,COPENE
E2A6 3E 01          	LD	A,1		;1セクタ辺りのセクタ数が2以上の場合
E2A8 32 01 EB       	LD	(_SECPS+1),A
E2AB D1             	POP	DE		;DE=(_CLPS)
E2AC D5             	PUSH	DE
E2AD                COPEN1:
E2AD D5             	PUSH	DE		;データバッファに入らないセクタもゼロクリア
E2AE C5             	PUSH	BC
E2AF 2A 7E F1       	LD	HL,(_DTBUF)
E2B2 CD 6E E3       	CALL	CLUSTX
E2B5 CD 99 EC       	CALL	DWT24
E2B8 C1             	POP	BC
E2B9 D1             	POP	DE
E2BA CD 00 EB       	CALL	NEXTX
E2BD 20 EE          	JR	NZ,COPEN1
E2BF                COPENE:
E2BF 2A 7E F1       	LD	HL,(_DTBUF)
E2C2 D1             	POP	DE
E2C3 C9             	RET
E2C4                
E2C4                READ_DIR:
E2C4 ED 53 FE F1    	LD	(_CLPS),DE
E2C8 C5             	PUSH	BC
E2C9 D5             	PUSH	DE
E2CA CD 54 E3       	CALL	DCPAT
E2CD CD 74 E9       	CALL	DRDX
E2D0 D1             	POP	DE
E2D1 C1             	POP	BC
E2D2 C9             	RET
E2D3                
E2D3                FILESE:
E2D3 7E             	LD	A,(HL)
E2D4 B7             	OR	A
E2D5 C8             	RET	Z		;END:ZF=1 CF=0
E2D6 FE E5          	CP	0E5H
E2D8 28 0E          	JR	Z,FILESE1
E2DA FD E5          	PUSH	IY
E2DC D1             	POP	DE
E2DD 13             	INC	DE
E2DE E5             	PUSH	HL
E2DF CD 2B E3       	CALL	CPFILE
E2E2 CC 4C E3       	CALL	Z,CPFILE2
E2E5 E1             	POP	HL
E2E6 37             	SCF
E2E7 C8             	RET	Z		;!!!:(ZF=1) CF=1
E2E8                FILESE1:
E2E8 CD FF E2       	CALL	FNEXT
E2EB 20 E6          	JR	NZ,FILESE
E2ED                ZF0_CF0_AFF_RET:
E2ED F6 FF          	OR	0FFH		;ZF=0 CF=0
E2EF C9             	RET
E2F0                
E2F0                NEXTSE:
E2F0 7E             	LD	A,(HL)
E2F1 B7             	OR	A
E2F2 37             	SCF
E2F3 C8             	RET	Z		;!!!:ZF=1 CF=1
E2F4 FE E5          	CP	0E5H
E2F6 37             	SCF
E2F7 C8             	RET	Z		;!!!:(ZF=1) CF=1
E2F8 CD FF E2       	CALL	FNEXT
E2FB 20 F3          	JR	NZ,NEXTSE
E2FD 18 EE          	JR	ZF0_CF0_AFF_RET
E2FF                
E2FF                FNEXT:
E2FF E5             	PUSH	HL
E300 21 9F F0       	LD	HL,_FILEN
E303 34             	INC	(HL)
E304 E1             	POP	HL
E305 11 20 00       	LD	DE,020H
E308 19             	ADD	HL,DE
E309 0D             	DEC	C
E30A C9             	RET
E30B                
E30B                CPNAME:
E30B C5             	PUSH	BC
E30C D5             	PUSH	DE
E30D E5             	PUSH	HL
E30E CD 25 E3       	CALL	CPFILE4
E311 E1             	POP	HL
E312 23             	INC	HL
E313 23             	INC	HL
E314 23             	INC	HL
E315 23             	INC	HL
E316 D1             	POP	DE
E317 C1             	POP	BC
E318 20 05          	JR	NZ,CPNAME1
E31A 7E             	LD	A,(HL)
E31B 23             	INC	HL
E31C 66             	LD	H,(HL)
E31D 6F             	LD	L,A
E31E C9             	RET
E31F                CPNAME1:
E31F 23             	INC	HL
E320 23             	INC	HL
E321 10 E8          	DJNZ	CPNAME
E323 37             	SCF
E324 C9             	RET
E325                
E325                CPFILE4:
E325 C5             	PUSH	BC
E326 01 00 04       	LD	BC,00400H
E329 18 04          	JR	CPSTR1
E32B                CPFILE:
E32B C5             	PUSH	BC
E32C 01 00 0B       	LD	BC,00B00H
E32F                CPSTR1:
E32F 1A             	LD	A,(DE)
E330 FE 3F          	CP	'?'		;Wild card
E332 28 12          	JR	Z,CPSTR2
E334 7E             	LD	A,(HL)
E335 CD A4 E4       	CALL	FKANC
E338 E5             	PUSH	HL
E339 67             	LD	H,A
E33A 1A             	LD	A,(DE)
E33B CB 01          	RLC	C
E33D CD A4 E4       	CALL	FKANC
E340 CB 09          	RRC	C
E342 BC             	CP	H		;CP (HL),(DE)
E343 E1             	POP	HL
E344 20 04          	JR	NZ,CPSTR3
E346                CPSTR2:
E346 13             	INC	DE
E347 23             	INC	HL
E348 10 E5          	DJNZ	CPSTR1
E34A                CPSTR3:
E34A C1             	POP	BC
E34B C9             	RET
E34C                
E34C                CPFILE2:
E34C FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E34F F6 E1          	OR	0E1H
E351 2F             	CPL
E352 A6             	AND	(HL)
E353 C9             	RET
E354                
E354                DCPAT:
E354 0E 00          	LD	C,0
E356 2A 7E F1       	LD	HL,(_DTBUF)
E359 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E35C B7             	OR	A
E35D C8             	RET	Z		;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
E35E 3A 72 E3       	LD	A,(SPCPAT+1)
E361 4F             	LD	C,A
E362 3A 01 EB       	LD	A,(_SECPS+1)
E365 B9             	CP	C
E366 38 01          	JR	C,DC1
E368 AF             	XOR	A
E369                DC1:
E369 F6 80          	OR	080H
E36B 32 A0 F0       	LD	(_DIRF),A	;bit0-6:セクタインデックス
E36E                CLUSTX:
E36E E5             	PUSH	HL
E36F EB             	EX	DE,HL
E370 AF             	XOR	A
E371 0E 01          SPCPAT:	LD	C,1		;自己書き換え（1クラスタの論理セクタ数）
E373                L_CLDBL:
E373 CB 19          	RR	C		;->CF
E375 38 04          	JR	C,E_CLDBL
E377 29             	ADD	HL,HL		;*2
E378 8F             	ADC	A,A
E379 18 F8          	JR	L_CLDBL
E37B                E_CLDBL:
E37B 4F             	LD	C,A
E37C 3A 01 EB       	LD	A,(_SECPS+1)
E37F B5             	OR	L
E380 6F             	LD	L,A
E381 11 08 00       CLSPAT:	LD	DE,8	;+8 (2D)  !ADDCL (self-modifying code)
E384 AF             	XOR	A
E385 19             	ADD	HL,DE	;データ格納領域の先頭論理セクタ番号
E386 89             	ADC	A,C
E387 4F             	LD	C,A
E388 EB             	EX	DE,HL
E389 E1             	POP	HL
E38A C9             	RET
E38B                
E38B                ENDCL:
E38B 7A             	LD	A,D	;END CLUSTER
E38C FE 01          CLPAT1:	CP	1	;164=356	(self-modifying code)
E38E C0             	RET	NZ
E38F 7B             	LD	A,E
E390 FE 64          CLPAT2:	CP	064H	;		(self-modifying code)
E392 C9             	RET
E393                
E393                CAP:
E393 FE 61          	CP	'a'
E395 D8             	RET	C
E396 FE 7B          	CP	'z'+1
E398 D0             	RET	NC
E399 D6 20          	SUB	020H
E39B C9             	RET
E39C                CAP2:
E39C CD 93 E3       	CALL	CAP
E39F                CAP3:
E39F CD A8 E3       	CALL	CAP4
E3A2 FE 21          	CP	021H
E3A4 D0             	RET	NC
E3A5 3E A0          	LD	A,0A0H
E3A7 C9             	RET
E3A8                CAP4:
E3A8 FE 05          	CP	5
E3AA C0             	RET	NZ
E3AB 3E E5          	LD	A,0E5H
E3AD C9             	RET
E3AE                
E3AE                CHDIR:
E3AE CD C7 ED       	CALL	GETDPBD
E3B1 38 1D          	JR	C,CHDIR2
E3B3 DD 75 1A       	LD	(IX+01AH),L		;_SDIR_
E3B6 DD 74 1B       	LD	(IX+01BH),H		;_SDIR_+1
E3B9 18 15          	JR	CHDIR2		;POP_IX_RET
E3BB                
E3BB                LDDIR:
E3BB CD C7 ED       	CALL	GETDPBD
E3BE DD 5E 1A       	LD	E,(IX+01AH)		;_SDIR_
E3C1 DD 56 1B       	LD	D,(IX+01BH)		;_SDIR_+1
E3C4 13             	INC	DE
E3C5 FD 73 0E       	LD	(IY+14),E	;(FCB)アクセスするディレクトリのクラスタ番号+1
E3C8 FD 72 0F       	LD	(IY+15),D
E3CB 1B             	DEC	DE
E3CC AF             	XOR	A
E3CD 32 A0 F0       	LD	(_DIRF),A
E3D0                CHDIR2:
E3D0 DD E1          	POP	IX
E3D2 C9             	RET
E3D3                
E3D3                LDDIRX:
E3D3 3A A0 F0       	LD	A,(_DIRF)	;(FCB)アクセスするディレクトリのセクタインデックス
E3D6 E6 7F          	AND	07FH
E3D8                LDDIRX1:
E3D8 32 01 EB       	LD	(_SECPS+1),A
E3DB FD 5E 0E       	LD	E,(IY+14)	;(FCB)アクセスするディレクトリのクラスタ番号+1
E3DE FD 56 0F       	LD	D,(IY+15)
E3E1 1B             	DEC	DE
E3E2 CD 8B E3       	CALL	ENDCL
E3E5 D4 BB E3       	CALL	NC,LDDIR
E3E8                LDDIRS:
E3E8 7A             	LD	A,D
E3E9 B3             	OR	E
E3EA 32 A0 F0       	LD	(_DIRF),A	;ディレクトリか判別
E3ED C9             	RET
E3EE                
E3EE                KILL:
E3EE CD BE E4       	CALL	CHKWILDX
E3F1 38 34          	JR	C,KILLW
E3F3 CD 90 E1       	CALL	SOPENX
E3F6                KILLS:
E3F6 3E 1F          	LD	A,01FH
E3F8 D4 3A E4       	CALL	NC,CHKATT
E3FB D8             	RET	C
E3FC                KILLSX:
E3FC 36 E5          	LD	(HL),0E5H	;DIR
E3FE CD 98 E4       	CALL	WTDB
E401 11 1A 00       	LD	DE,01AH
E404 19             	ADD	HL,DE
E405 5E             	LD	E,(HL)
E406 23             	INC	HL
E407 56             	LD	D,(HL)
E408                KILLS1:
E408 CD 8B E3       	CALL	ENDCL
E40B D0             	RET	NC		;CF=0
E40C 21 FE FF       	LD	HL,0-2
E40F 19             	ADD	HL,DE
E410 D0             	RET	NC		;DE= 0 or 1
E411 D5             	PUSH	DE
E412 CD F7 F0       	CALL	_GNCL
E415 ED 53 FE F1    	LD	(_CLPS),DE
E419 D1             	POP	DE
E41A 21 00 00       	LD	HL,0
E41D D4 FA F0       	CALL	NC,_SNCL
E420 D8             	RET	C
E421 ED 5B FE F1    	LD	DE,(_CLPS)	;FAT
E425 18 E1          	JR	KILLS1
E427                
E427                KILLW:
E427 CD BD E1       	CALL	SOPEN
E42A                KILLW1:
E42A 38 0B          	JR	C,KILLW2
E42C CD 5D E2       	CALL	SOPENE2
E42F CD F6 E3       	CALL	KILLS
E432 CD 21 E2       	CALL	NOPEN
E435 18 F3          	JR	KILLW1
E437                KILLW2:
E437 C8             	RET	Z
E438 3F             	CCF
E439 C9             	RET
E43A                
E43A                CHKATT:
E43A E5             	PUSH	HL
E43B 11 0B 00       	LD	DE,00BH
E43E 19             	ADD	HL,DE
E43F A6             	AND	(HL)
E440 E1             	POP	HL
E441 C8             	RET	Z
E442 37             	SCF
E443 C9             	RET
E444                
E444                NAME:
E444 CD BE E4       	CALL	CHKWILDX
E447 D8             	RET	C
E448 11 04 00       	LD	DE,4
E44B 19             	ADD	HL,DE
E44C 22 64 E4       	LD	(NAMEP+2),HL
E44F 23             	INC	HL
E450 CD C2 E4       	CALL	CHKWILD
E453 D8             	RET	C
E454                
E454 CD 90 E1       	CALL	SOPENX
E457 3E 0F          	LD	A,00FH
E459 D4 3A E4       	CALL	NC,CHKATT
E45C D8             	RET	C
E45D                
E45D FD 7E 00       	LD	A,(IY+0)
E460 FD E5          	PUSH	IY
E462 FD 21 00 00    NAMEP:	LD	IY,0		;自己書き換え
E466 FD 77 00       	LD	(IY+0),A
E469 CD 90 E1       	CALL	SOPENX
E46C FD E3          	EX	(SP),IY
E46E 3F             	CCF
E46F D4 BD E1       	CALL	NC,SOPEN
E472 EB             	EX	DE,HL
E473 E1             	POP	HL
E474 D8             	RET	C
E475                
E475                SETNAME:
E475 01 00 0B       	LD	BC,11*256
E478 23             	INC	HL
E479 7E             	LD	A,(HL)
E47A FE E5          	CP	0E5H
E47C 20 04          	JR	NZ,SNAME1
E47E 3E 05          	LD	A,5
E480 18 0E          	JR	SNAME3
E482                SNAME1:
E482 7E             	LD	A,(HL)
E483 0C             	INC	C
E484 0D             	DEC	C
E485 20 09          	JR	NZ,SNAME3
E487 CD 93 E3       	CALL	CAP
E48A FE A0          	CP	0A0H
E48C 20 02          	JR	NZ,SNAME3
E48E 3E 20          	LD	A,020H
E490                SNAME3:
E490 12             	LD	(DE),A
E491 7E             	LD	A,(HL)
E492 23             	INC	HL
E493 CD AB E4       	CALL	FKAN
E496 10 EA          	DJNZ	SNAME1
E498                WTDB:
E498 3E FF          	LD	A,0FFH
E49A 32 39 F0       	LD	(SFILE),A
E49D                SWTDBF:
E49D 3E 01          	LD	A,1
E49F 32 A4 F0       	LD	(_WTDBF),A
E4A2 AF             	XOR	A
E4A3 C9             	RET
E4A4                
E4A4                FKANC:
E4A4 CB 41          	BIT	0,C
E4A6 CC 9C E3       	CALL	Z,CAP2
E4A9 18 01          	JR	FKANX
E4AB                FKAN:			;漢字チェック
E4AB 13             	INC	DE
E4AC                FKANX:
E4AC CB 41          	BIT	0,C
E4AE CB 81          	RES	0,C
E4B0 C0             	RET	NZ
E4B1 FE 80          	CP	080H
E4B3 D8             	RET	C
E4B4 FE A0          	CP	0A0H
E4B6 38 03          	JR	C,FKAN1
E4B8 FE E0          	CP	0E0H
E4BA D8             	RET	C
E4BB                FKAN1:
E4BB 0C             	INC	C
E4BC A7             	AND	A
E4BD C9             	RET
E4BE                
E4BE                CHKWILDX:
E4BE FD E5          	PUSH	IY
E4C0 E1             	POP	HL
E4C1 23             	INC	HL
E4C2                CHKWILD:
E4C2 06 0B          	LD	B,11
E4C4 3E 3F          	LD	A,'?'
E4C6                CHKWIL1:
E4C6 BE             	CP	(HL)
E4C7 23             	INC	HL
E4C8 37             	SCF
E4C9 C8             	RET	Z
E4CA 10 FA          	DJNZ	CHKWIL1
E4CC AF             	XOR	A
E4CD C9             	RET
E4CE                
E4CE                SDIRENT:		;IY=FCB HL=DIR
E4CE D5             	PUSH	DE
E4CF E5             	PUSH	HL
E4D0 FD E5          	PUSH	IY
E4D2 D1             	POP	DE
E4D3 EB             	EX	DE,HL
E4D4 CD 75 E4       	CALL	SETNAME
E4D7                ;				Attribute
E4D7 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E4DA 12             	LD	(DE),A
E4DB 13             	INC	DE
E4DC                ;				Reserved
E4DC AF             	XOR	A
E4DD 06 0A          	LD	B,10
E4DF                SDE1:
E4DF 12             	LD	(DE),A
E4E0 13             	INC	DE
E4E1 10 FC          	DJNZ	SDE1
E4E3                					;(FCB)更新時刻
E4E3 21 EA F1       	LD	HL,SDDATA		;(FCB)更新年月日
E4E6 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
E4E8                SDLOOP:					;(FCB)ファイルのサイズ(バイト単位)
E4E8 7E             	LD	A,(HL)
E4E9 23             	INC	HL
E4EA 32 EF E4       	LD	(SDPAT+2),A
E4ED FD 7E 00       SDPAT:	LD	A,(IY+0)	;LD A,(IY+A)
E4F0 12             	LD	(DE),A
E4F1 13             	INC	DE
E4F2 10 F4          	DJNZ	SDLOOP
E4F4                
E4F4 AF             	XOR	A
E4F5 E1             	POP	HL
E4F6 D1             	POP	DE
E4F7 C9             	RET
E4F8                
E4F8                WOPEN:
E4F8 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E4FB E6 1F          	AND	01FH
E4FD 37             	SCF
E4FE C0             	RET	NZ
E4FF FD 36 1C FE    	LD	(IY+28),0FEH	;(FCB)オープンモード
E503                TOPEN2:
E503 AF             	XOR	A
E504                TOPEN:				;Initializes the time stamp
E504 FD 36 17 FF    	LD	(IY+23),0FFH	;(FCB)更新時刻
E508 C9             	RET
E509                
E509                WRDFX:
E509 3A 72 E3       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ
E50C                L_WRFX:
E50C 1F             	RRA			;->CF
E50D 38 06          	JR	C,E_WRFX
E50F CB 39          	SRL	C
E511 CB 1C          	RR	H		;CH=CH/2
E513 18 F7          	JR	L_WRFX
E515                E_WRFX:
E515 44             	LD	B,H
E516 04             	INC	B
E517 3E 37          	LD	A,037H		;SCF
E519 32 91 E9       	LD	(DRDN1),A
E51C                
E51C                WRDF:				;Bクラスタ分FATを確保する
E51C 11 02 00       	LD	DE,2
E51F AF             	XOR	A
E520 32 01 EB       	LD	(_SECPS+1),A
E523                WRDF1:
E523 C5             	PUSH	BC
E524 D5             	PUSH	DE
E525 CD F7 F0       	CALL	_GNCL
E528 38 1C          	JR	C,WRDF3
E52A 7A             	LD	A,D		;空いているかチェック
E52B B3             	OR	E
E52C 20 27          	JR	NZ,WRDF4
E52E E1             	POP	HL		;HL=空いているクラスタ
E52F E5             	PUSH	HL
E530 ED 5B FE F1    	LD	DE,(_CLPS)	;DE=元の(_CLPS)
E534 22 FE F1       	LD	(_CLPS),HL
E537 7A             	LD	A,D		;元の(_CLPS)が 0 か?
E538 B3             	OR	E
E539 20 08          	JR	NZ,WRDF2
E53B FD 75 1A       	LD	(IY+26),L	;(FCB)ファイルの先頭クラスタ
E53E FD 74 1B       	LD	(IY+27),H	;元が空の場合はFCBにクラスタをセットする
E541 18 03          	JR	WRDF3
E543                WRDF2:
E543 CD FA F0       	CALL	_SNCL
E546                WRDF3:
E546 D1             	POP	DE
E547 C1             	POP	BC
E548 D8             	RET	C
E549 10 0C          	DJNZ	WRDF5		;ここでループカウンタチェック
E54B ED 5B FE F1    	LD	DE,(_CLPS)
E54F 21 FF FF       	LD	HL,0FFFFH	;FATエントリ終了(EOCマーク)
E552 C3 FA F0       	JP	_SNCL
E555                
E555                WRDF4:				;DEクラスタが空じゃないので次に移動する
E555 D1             	POP	DE
E556 C1             	POP	BC
E557                WRDF5:
E557 13             	INC	DE
E558 CD 8B E3       	CALL	ENDCL
E55B 38 C6          	JR	C,WRDF1
E55D 37             	SCF
E55E C9             	RET
E55F                
E55F                RWXR:
E55F 3A 90 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E562                L_RWX:
E562 1F             	RRA		;->CF
E563 38 08          	JR	C,E_RWX
E565 CB 38          	SRL	B	;BCH=BCH/2
E567 CB 19          	RR	C	;
E569 CB 1C          	RR	H	;
E56B 18 F5          	JR	L_RWX
E56D                E_RWX:
E56D FD 5E 1A       	LD	E,(IY+26)	;(FCB)ファイルの先頭クラスタ
E570 FD 56 1B       	LD	D,(IY+27)
E573 AF             	XOR	A
E574 32 01 EB       	LD	(_SECPS+1),A
E577                RWX1:
E577 ED 53 FE F1    	LD	(_CLPS),DE
E57B 7A             	LD	A,D
E57C B3             	OR	E
E57D 28 13          	JR	Z,SCF_RET	;RET DE==0 => CF=1
E57F                
E57F 78             	LD	A,B
E580 B1             	OR	C
E581 B4             	OR	H
E582 C8             	RET	Z		;RET BCH==0 => CF=0
E583                
E583 CD 09 EB       	CALL	GNCLX
E586 D8             	RET	C
E587 7C             	LD	A,H		;
E588 25             	DEC	H		;
E589 B7             	OR	A		;DEC BCH
E58A 20 01          	JR	NZ,RWX2		;
E58C 0B             	DEC	BC		;
E58D                RWX2:
E58D CD 8B E3       	CALL	ENDCL
E590 38 E5          	JR	C,RWX1
E592                SCF_RET:
E592 37             	SCF
E593 C9             	RET
E594                
E594                DSKF:
E594 11 00 00       MAXCLP:	LD	DE,0
E597 2A AC F0       	LD	HL,(_FAKEFREE)
E59A 7C             	LD	A,H
E59B B5             	OR	L
E59C 28 03          	JR	Z,DSKF1
E59E 11 01 00       	LD	DE,1
E5A1                DSKF1:
E5A1 D5             	PUSH	DE
E5A2 CD F7 F0       	CALL	_GNCL
E5A5 38 0C          	JR	C,POPSCF
E5A7 7A             	LD	A,D
E5A8 B3             	OR	E
E5A9 20 01          	JR	NZ,DSKF2
E5AB 23             	INC	HL
E5AC                DSKF2:
E5AC D1             	POP	DE
E5AD 1B             	DEC	DE
E5AE 7A             	LD	A,D
E5AF B3             	OR	E
E5B0 20 EF          	JR	NZ,DSKF1
E5B2 C9             	RET
E5B3                
E5B3                POPSCF:
E5B3 F1             	POP	AF
E5B4 37             	SCF
E5B5 C9             	RET
E5B6                
E5B6                SETTMS:
E5B6 FD 7E 17       	LD	A,(IY+23)	;(FCB)ファイルを最後に変更した時刻
E5B9 3C             	INC	A
E5BA C0             	RET	NZ		;ファイルが更新されていない
E5BB                SETTMSX:			;FCBに日付時刻をセットする
E5BB CD 6A DC       	CALL	_SYS2C		;(BDOS)時刻の獲得
E5BE                				;H←時  L←分  D←秒
E5BE CB 25          	SLA	L		;   *2
E5C0 CB 25          	SLA	L		;   *4
E5C2 29             	ADD	HL,HL		;*2 *8
E5C3 29             	ADD	HL,HL		;*4 *16
E5C4 29             	ADD	HL,HL		;*8 *32
E5C5 7A             	LD	A,D
E5C6 0F             	RRCA			;bit.0->7->->->0->C
E5C7 E6 1F          	AND	01FH
E5C9 B5             	OR	L
E5CA FD 77 16       	LD	(IY+22),A	;(FCB)ファイルを最後に変更した時刻
E5CD FD 74 17       	LD	(IY+23),H
E5D0                
E5D0 CD 47 DC       	CALL	_SYS2A		;(BDOS)日付の獲得
E5D3                				;HL←年  D←月  E←日
E5D3 01 44 F8       	LD	BC,0-1980
E5D6 09             	ADD	HL,BC
E5D7 65             	LD	H,L
E5D8                
E5D8 7A             	LD	A,D
E5D9 87             	ADD	A,A		;*2
E5DA 87             	ADD	A,A		;*4
E5DB 87             	ADD	A,A		;*8
E5DC 87             	ADD	A,A		;*16
E5DD 6F             	LD	L,A
E5DE 29             	ADD	HL,HL		;*32
E5DF 7D             	LD	A,L
E5E0 B3             	OR	E
E5E1 FD 77 14       	LD	(IY+20),A	;(FCB)ファイルを最後に変更した日付
E5E4 FD 74 15       	LD	(IY+21),H
E5E7 C9             	RET
E5E8                
E5E8                PUSHRR:
E5E8 32 87 E6       	LD	(SETSEQ_SWC_RND),A
E5EB 22 99 E6       	LD	(SETSEQ_SWC_SEQ_RR),HL
E5EE CD 0E E6       	CALL	GET_RR_AHL
E5F1 22 5A F0       	LD	(HLBUF),HL
E5F4 32 5C F0       	LD	(HLBUF+2),A
E5F7 C9             	RET
E5F8                
E5F8                GET_CPM_R_SIZE:		;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
E5F8 87             	ADD	A,A		;in BHLA => out AHL
E5F9 ED 6A          	ADC	HL,HL
E5FB CB 18          	RR	B
E5FD B7             	OR	A
E5FE 78             	LD	A,B		;ここでフラグは変化しない
E5FF C8             	RET	Z
E600 2C             	INC	L		;INC AHL
E601 C0             	RET	NZ		;
E602 24             	INC	H		;
E603 C0             	RET	NZ		;
E604 3C             	INC	A		;
E605 C9             	RET
E606                
E606                INIT_RND:
E606 3E CD          	LD	A,0CDH		;CALL ????
E608 21 57 E6       	LD	HL,POPRR
E60B CD E8 E5       	CALL	PUSHRR
E60E                GET_RR_AHL:
E60E FD 6E 21       	LD	L,(IY+33)	;(FCB)Random record
E611 FD 66 22       	LD	H,(IY+34)	;
E614 FD 7E 23       	LD	A,(IY+35)	;
E617 C9             	RET
E618                SET_RR_AHL:
E618 FD 75 21       	LD	(IY+33),L	;(FCB)Random record
E61B FD 74 22       	LD	(IY+34),H
E61E FD 77 23       	LD	(IY+35),A
E621 C9             	RET
E622                INIT_SEQ:
E622 3E 01          	LD	A,1		;LD BC,????
E624 21 54 E6       	LD	HL,SETSEQ
E627 CD E8 E5       	CALL	PUSHRR
E62A                GETSEQ:
E62A FD 6E 20       	LD	L,(IY+32)	;(FCB)カレントレコード
E62D FD 66 0C       	LD	H,(IY+12)	;(FCB)カレントブロック
E630 AF             	XOR	A
E631                
E631 CB 25          	SLA	L	;L=L*2
E633                
E633 CB 3C          	SRL	H	;HL=HL/2
E635 CB 1D          	RR	L	;
E637 C9             	RET
E638                
E638                SETSEQ1:
E638 F5             	PUSH	AF		
E639 E5             	PUSH	HL		;AHL=Random record
E63A FD 7E 21       	LD	A,(IY+33)	;(FCB)ランダムレコード
E63D FD 6E 22       	LD	L,(IY+34)
E640 FD 66 23       	LD	H,(IY+35)
E643 06 00          	LD	B,0
E645                
E645 CD F8 E5       	CALL	GET_CPM_R_SIZE
E648                
E648 29             	ADD	HL,HL
E649 CB 3D          	SRL	L		;L=L/2
E64B FD 75 20       	LD	(IY+32),L	;(FCB)カレントレコード
E64E FD 74 0C       	LD	(IY+12),H	;(FCB)カレントブロック
E651 E1             	POP	HL
E652 F1             	POP	AF
E653 C9             	RET
E654                SETSEQ:
E654 CD 38 E6       	CALL	SETSEQ1
E657                POPRR:
E657 F5             	PUSH	AF
E658 E5             	PUSH	HL
E659 2A 5A F0       	LD	HL,(HLBUF)
E65C 3A 5C F0       	LD	A,(HLBUF+2)
E65F CD 18 E6       	CALL	SET_RR_AHL
E662 E1             	POP	HL
E663 F1             	POP	AF
E664 C9             	RET
E665                
E665                RB_WRITE:
E665 C5             	PUSH	BC
E666 ED 4B 4C F1    	LD	BC,(STABLE+2*026H)	;(BDOS)ランダムブロック書き込み
E66A 18 05          	JR	RBRW
E66C                RB_READ:
E66C C5             	PUSH	BC
E66D ED 4B 4E F1    	LD	BC,(STABLE+2*027H)	;(BDOS)ランダムブロック読み込み
E671                RBRW:
E671 CB 3F          	SRL	A	;AHLA' = HL*128
E673 CB 1C          	RR	H	;AHL=AHL/2
E675 CB 1D          	RR	L	;
E677 3E 00          	LD	A,0
E679 1F             	RRA		;A'HLA
E67A FD 77 21       	LD	(IY+33),A	;(FCB)ランダムレコード
E67D FD 75 22       	LD	(IY+34),L
E680 FD 74 23       	LD	(IY+35),H
E683 21 80 00       	LD	HL,128
E686 C5             	PUSH	BC
E687                SETSEQ_SWC_RND:
E687 CD 38 E6       	CALL	SETSEQ1
E68A C1             	POP	BC
E68B FD CB 20 FE    	SET	7,(IY+32)	;(FCB)カレントレコード
E68F FD E5          	PUSH	IY
E691 D1             	POP	DE
E692 D5             	PUSH	DE
E693 CD A1 E6       	CALL	JP_BC
E696 FD E1          	POP	IY
E698 00 00 E6 99    SETSEQ_SWC_SEQ_RR	EQU $+1
E698 CD 54 E6       	CALL	SETSEQ
E69B FD CB 20 BE    	RES	7,(IY+32)	;(FCB)カレントレコード
E69F                
E69F C1             	POP	BC
E6A0 C9             	RET
E6A1                JP_BC:
E6A1 C5             	PUSH	BC
E6A2 C9             	RET
E6A3                
E6A3 00 00 E2 1B    _SYS03	EQU	SCF_FF_RET	;(BDOS)外部入力
E6A3 00 00 E2 1B    _SYS2B	EQU	SCF_FF_RET	;(BDOS)日付の設定
E6A3 00 00 E2 1B    _SYS2D	EQU	SCF_FF_RET	;(BDOS)時刻の設定
E6A3 00 00 E2 1B    _SYS39	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの作成
E6A3 00 00 E2 1B    _SYS3A	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの削除
E6A3                
E6A3                	INCLUDE	"LDFILE2.ASM"
E6A3                
E6A3                ;	LSX-Dodgers FILE2
E6A3                
E6A3                				;Write random block
E6A3                _SYS26:		;(BDOS)ランダムブロック書き込み
E6A3 AF             	XOR	A
E6A4 32 91 E9       	LD	(DRDN1),A	;NOP
E6A7 22 D5 E8       	LD	(LEFT+1),HL	;HL←書き込むレコード数
E6AA 22 5D F0       	LD	(LEFTX),HL
E6AD CD 70 E1       	CALL	SETDRV
E6B0                
E6B0 CD 2A E8       	CALL	RBX0
E6B3 DA 4D E7       	JP	C,RBWERR
E6B6 CD F8 E4       	CALL	WOPEN
E6B9 DA 4D E7       	JP	C,RBWERR
E6BC 7C             	LD	A,H
E6BD B5             	OR	L
E6BE CA 46 E7       	JP	Z,RBW1
E6C1                
E6C1 2B             	DEC	HL
E6C2                
E6C2 CD F7 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E6C5                
E6C5 19             	ADD	HL,DE		;BCHL=HL+BCDE
E6C6 30 01          	JR	NC,S26X1	;
E6C8 03             	INC	BC		;
E6C9                S26X1:
E6C9 CD 5F E5       	CALL	RWXR
E6CC DC 09 E5       	CALL	C,WRDFX
E6CF DA 4D E7       	JP	C,RBWERR
E6D2                
E6D2 CD 59 E8       	CALL	RBX2
E6D5 28 1A          	JR	Z,RBWB		;NZ=セクタ以下の端数がある
E6D7 CD 78 E8       	CALL	RBXA
E6DA 38 71          	JR	C,RBWERR
E6DC EB             	EX	DE,HL
E6DD C5             	PUSH	BC
E6DE ED B0          	LDIR
E6E0 22 5F F0       	LD	(DTAX),HL
E6E3                
E6E3 CD 9D E4       	CALL	SWTDBF		;バッファデータは更新された
E6E6                
E6E6 2A 5D F0       	LD	HL,(LEFTX)
E6E9 D1             	POP	DE
E6EA ED 52          	SBC	HL,DE
E6EC 22 5D F0       	LD	(LEFTX),HL
E6EF 28 33          	JR	Z,RBWEND
E6F1                
E6F1                RBWB:
E6F1 CD AE E8       	CALL	RBXB
E6F4 28 16          	JR	Z,RBWC
E6F6                RBWB1:
E6F6 C5             	PUSH	BC
E6F7 D5             	PUSH	DE
E6F8 CD 6E E3       	CALL	CLUSTX
E6FB CD 0B E9       	CALL	DWTC
E6FE D1             	POP	DE
E6FF C1             	POP	BC
E700 38 4B          	JR	C,RBWERR
E702 CD 09 EB       	CALL	GNCLX
E705 38 46          	JR	C,RBWERR
E707 10 ED          	DJNZ	RBWB1
E709 CD 5B E9       	CALL	DRW_FLUSH
E70C                RBWC:
E70C CD C8 E8       	CALL	RBXC
E70F 28 13          	JR	Z,RBWEND
E711 C5             	PUSH	BC
E712 CD 6E E3       	CALL	CLUSTX
E715 CD 90 E9       	CALL	DRDN
E718 C1             	POP	BC
E719 38 32          	JR	C,RBWERR
E71B ED 5B 7E F1    	LD	DE,(_DTBUF)
E71F ED B0          	LDIR
E721 CD 9D E4       	CALL	SWTDBF		;バッファデータは更新された
E724                RBWEND:
E724 CD D4 E8       	CALL	RBXEND
E727                
E727 CD 39 E8       	CALL	RBX1
E72A 30 1A          	JR	NC,RBW1
E72C 2A D5 E8       	LD	HL,(LEFT+1)
E72F FD 5E 10       	LD	E,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
E732 FD 56 11       	LD	D,(IY+17)	;DE=File size
E735 19             	ADD	HL,DE
E736 FD 75 10       	LD	(IY+16),L	;(FCB)ファイルのサイズ(バイト単位)
E739 FD 74 11       	LD	(IY+17),H
E73C 30 08          	JR	NC,RBW1
E73E FD 34 12       	INC	(IY+18)
E741 20 03          	JR	NZ,RBW1
E743 FD 34 13       	INC	(IY+19)
E746                RBW1:
E746 FD E1          	POP	IY
E748 C1             	POP	BC
E749 D1             	POP	DE
E74A E1             	POP	HL
E74B                DD_NUL:
E74B AF             	XOR	A
E74C                DRDF0:
E74C                DWTF0:
E74C C9             	RET
E74D                
E74D                RBWERR:
E74D FD E5          	PUSH	IY
E74F D1             	POP	DE
E750 2A 20 F1       	LD	HL,(STABLE+2*010H)
E753 CD 0F 00       	CALL	JP_HL
E756                RBRERR1:
E756 3E 01          	LD	A,001H
E758                RBRERR2:
E758 FD E1          	POP	IY
E75A C1             	POP	BC
E75B D1             	POP	DE
E75C E1             	POP	HL
E75D 37             	SCF
E75E 21 00 00       	LD	HL,0
E761 C9             	RET
E762                
E762                RBRERR:
E762 3E FF          	LD	A,0FFH
E764 18 F2          	JR	RBRERR2
E766                
E766                RBRFL:
E766 3E 00          RBRFLP:	LD	A,000H
E768 FE 0D          	CP	00DH
E76A 20 05          	JR	NZ,RBRFL1
E76C D5             	PUSH	DE
E76D 1E 0A          	LD	E,00AH
E76F 18 05          	JR	RBRFL2
E771                RBRFL1:
E771 D5             	PUSH	DE
E772 CD 09 F0       	CALL	_SYS07
E775 5F             	LD	E,A
E776                RBRFL2:
E776 CD CD F0       	CALL	_PRINT
E779 7B             	LD	A,E
E77A D1             	POP	DE
E77B 32 67 E7       	LD	(RBRFLP+1),A
E77E C9             	RET
E77F                DDX:
E77F FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
E782 CD 93 E3       	CALL	CAP
E785 FE 41          	CP	'A'
E787 C9             	RET
E788                
E788                				;Read random block
E788                _SYS27:		;(BDOS)ランダムブロック読み込み
E788 22 5D F0       	LD	(LEFTX),HL
E78B CD 70 E1       	CALL	SETDRV
E78E                
E78E FD CB 0D 66    	BIT	4,(IY+13)	;(FCB)属性(アトリビュート)
E792 C2 18 E8       	JP	NZ,RBRDIR	;ディレクトリ
E795 CD 2A E8       	CALL	RBX0
E798 DA 62 E7       	JP	C,RBRERR
E79B CD 39 E8       	CALL	RBX1
E79E DA 56 E7       	JP	C,RBRERR1
E7A1 EB             	EX	DE,HL
E7A2 ED 52          	SBC	HL,DE		;CP 00HL,BCDE
E7A4 19             	ADD	HL,DE
E7A5 79             	LD	A,C
E7A6 DE 00          	SBC	A,0
E7A8 78             	LD	A,B
E7A9 DE 00          	SBC	A,0
E7AB 38 01          	JR	C,RBR1
E7AD EB             	EX	DE,HL
E7AE                RBR1:
E7AE 9F             	SBC	A,A
E7AF E6 01          	AND	1
E7B1 32 16 E8       	LD	(RBRAP+1),A
E7B4                
E7B4 7C             	LD	A,H
E7B5 B5             	OR	L
E7B6 28 57          	JR	Z,RBREND0
E7B8                
E7B8 22 D5 E8       	LD	(LEFT+1),HL	;Read record byte
E7BB 22 5D F0       	LD	(LEFTX),HL
E7BE                
E7BE CD 59 E8       	CALL	RBX2
E7C1 28 19          	JR	Z,RBRB
E7C3 CD 78 E8       	CALL	RBXA
E7C6 DA 62 E7       	JP	C,RBRERR
E7C9 C5             	PUSH	BC
E7CA ED B0          	LDIR
E7CC ED 53 5F F0    	LD	(DTAX),DE
E7D0 2A 5D F0       	LD	HL,(LEFTX)
E7D3 D1             	POP	DE
E7D4 A7             	AND	A
E7D5 ED 52          	SBC	HL,DE
E7D7 22 5D F0       	LD	(LEFTX),HL
E7DA 28 30          	JR	Z,RBREND
E7DC                
E7DC                RBRB:
E7DC CD AE E8       	CALL	RBXB
E7DF 28 15          	JR	Z,RBRC
E7E1                RBRB1:
E7E1 C5             	PUSH	BC
E7E2 D5             	PUSH	DE
E7E3 CD 6E E3       	CALL	CLUSTX
E7E6 CD 11 E9       	CALL	DRDC
E7E9 D1             	POP	DE
E7EA C1             	POP	BC
E7EB D4 09 EB       	CALL	NC,GNCLX
E7EE DA 62 E7       	JP	C,RBRERR
E7F1 10 EE          	DJNZ	RBRB1
E7F3 CD 5B E9       	CALL	DRW_FLUSH
E7F6                RBRC:
E7F6 CD C8 E8       	CALL	RBXC
E7F9 28 11          	JR	Z,RBREND
E7FB C5             	PUSH	BC
E7FC CD 6E E3       	CALL	CLUSTX
E7FF CD 74 E9       	CALL	DRDX
E802 C1             	POP	BC
E803 DA 62 E7       	JP	C,RBRERR
E806 EB             	EX	DE,HL
E807 2A 7E F1       	LD	HL,(_DTBUF)
E80A ED B0          	LDIR
E80C                RBREND:
E80C CD D4 E8       	CALL	RBXEND
E80F                RBREND0:
E80F FD E1          	POP	IY
E811 C1             	POP	BC
E812 D1             	POP	DE
E813 F1             	POP	AF	;(HL)
E814 AF             	XOR	A
E815 3E 00          RBRAP:	LD	A,000H
E817 C9             	RET
E818                
E818                RBRDIR:
E818 FD 6E 1A       	LD	L,(IY+26)	;(FCB)ファイルの先頭クラスタ
E81B FD 66 1B       	LD	H,(IY+27)
E81E CD AE E3       	CALL	CHDIR
E821 AF             	XOR	A
E822 67             	LD	H,A
E823 6F             	LD	L,A
E824 3C             	INC	A
E825 32 16 E8       	LD	(RBRAP+1),A
E828 18 E5          	JR	RBREND0
E82A                
E82A                RBX0:
E82A 2A 8A F0       	LD	HL,(_DTA)
E82D 22 5F F0       	LD	(DTAX),HL
E830 2A 5D F0       	LD	HL,(LEFTX)
E833 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
E836 D6 FD          	SUB	0FDH
E838 C9             	RET
E839                
E839                RBX1:
E839 E5             	PUSH	HL		;Record byte
E83A                				;AHL=File size
E83A FD 6E 10       	LD	L,(IY+16)	;ファイルのサイズ(バイト単位)
E83D FD 66 11       	LD	H,(IY+17)	;
E840 FD 7E 12       	LD	A,(IY+18)	;
E843                
E843 CD F7 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E846                
E846 A7             	AND	A
E847 ED 52          	SBC	HL,DE
E849 99             	SBC	A,C
E84A 4F             	LD	C,A
E84B FD 7E 13       	LD	A,(IY+19)	;ファイルのサイズ
E84E 98             	SBC	A,B
E84F D1             	POP	DE
E850                
E850 D8             	RET	C
E851 47             	LD	B,A
E852 B1             	OR	C
E853 EB             	EX	DE,HL	;BCDE=File byte	HL=Record byte
E854 B2             	OR	D
E855 B3             	OR	E
E856 C0             	RET	NZ
E857 37             	SCF
E858 C9             	RET
E859                
E859                RBX2:				;Cluster settings
E859 FD 66 22       	LD	H,(IY+34)	;(+33)(FCB)ランダムレコード
E85C FD 4E 23       	LD	C,(IY+35)
E85F 06 00          	LD	B,0
E861 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E865 20 03          	JR	NZ,RBX3
E867 FD 46 24       	LD	B,(IY+36)
E86A                RBX3:
E86A CD 5F E5       	CALL	RWXR
E86D 3A 90 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E870 3D             	DEC	A
E871 FD A6 22       	AND	(IY+34)
E874 FD B6 21       	OR	(IY+33)
E877 C9             	RET
E878                
E878                RBXA:
E878 C5             	PUSH	BC
E879 D5             	PUSH	DE
E87A CD 6E E3       	CALL	CLUSTX
E87D CD 74 E9       	CALL	DRDX
E880 D1             	POP	DE
E881 C1             	POP	BC
E882 D8             	RET	C
E883 CD 09 EB       	CALL	GNCLX
E886 D8             	RET	C
E887 ED 53 FE F1    	LD	(_CLPS),DE
E88B                
E88B FD 4E 21       	LD	C,(IY+33)	;(FCB)ランダムレコード
E88E 21 00 04       SECSZ:	LD	HL,0400H	;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
E891 7C             	LD	A,H
E892 3D             	DEC	A		;1024=3 / 512=1
E893 FD A6 22       	AND	(IY+34)		;(FCB)ランダムレコード
E896 47             	LD	B,A		;BCに1セクタ以下の端数が入る
E897 ED 42          	SBC	HL,BC		;残りを計算
E899                
E899 ED 5B 5D F0    	LD	DE,(LEFTX)
E89D ED 52          	SBC	HL,DE		;CP HL,DE
E89F 19             	ADD	HL,DE		;
E8A0 38 01          	JR	C,RBXA1		;DEとHLを比較して大きい方をHLに
E8A2 EB             	EX	DE,HL
E8A3                RBXA1:
E8A3 E5             	PUSH	HL
E8A4 2A 7E F1       	LD	HL,(_DTBUF)
E8A7 09             	ADD	HL,BC
E8A8 ED 5B 5F F0    	LD	DE,(DTAX)
E8AC C1             	POP	BC
E8AD C9             	RET
E8AE                
E8AE                RBXB:
E8AE 2A 5F F0       	LD	HL,(DTAX)
E8B1 FD 5E 1A       	LD	E,(IY+26)	;(FCB)ファイルの先頭クラスタ
E8B4 FD 56 1B       	LD	D,(IY+27)
E8B7 3A 5E F0       	LD	A,(LEFTX+1)
E8BA 47             	LD	B,A
E8BB 3A 90 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8BE                RBXB1:
E8BE 1F             	RRA		;->CF
E8BF 38 04          	JR	C,RBXB2
E8C1 CB 38          	SRL	B	;B=B/2
E8C3 18 F9          	JR	RBXB1
E8C5                RBXB2:
E8C5 78             	LD	A,B
E8C6 B7             	OR	A
E8C7 C9             	RET
E8C8                
E8C8                RBXC:
E8C8 ED 4B 5D F0    	LD	BC,(LEFTX)
E8CC 3A 90 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8CF 3D             	DEC	A
E8D0 A0             	AND	B
E8D1 47             	LD	B,A		;1セクタ以下の端数がない場合はZ
E8D2 B1             	OR	C
E8D3 C9             	RET
E8D4                
E8D4                RBXEND:
E8D4 11 00 00       LEFT:	LD	DE,0
E8D7 AF             	XOR	A
E8D8 FD 6E 21       	LD	L,(IY+33)	;(FCB)ランダムレコード
E8DB FD 66 22       	LD	H,(IY+34)
E8DE 19             	ADD	HL,DE
E8DF FD 75 21       	LD	(IY+33),L	;(FCB)ランダムレコード
E8E2 FD 74 22       	LD	(IY+34),H
E8E5 30 0E          	JR	NC,RBXEND1
E8E7 FD 34 23       	INC	(IY+35)
E8EA 20 09          	JR	NZ,RBXEND1
E8EC FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E8F0 20 03          	JR	NZ,RBXEND1
E8F2 FD 34 24       	INC	(IY+36)
E8F5                RBXEND1:
E8F5 EB             	EX	DE,HL		;HL=Read byte
E8F6 C9             	RET
E8F7                
E8F7                GET_RR_BCDE:			;BCDE=Random record
E8F7 FD 5E 21       	LD	E,(IY+33)	;(FCB)ランダムレコード
E8FA FD 56 22       	LD	D,(IY+34)
E8FD FD 4E 23       	LD	C,(IY+35)
E900 FD 46 24       	LD	B,(IY+36)
E903 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E907 C8             	RET	Z
E908 06 00          	LD	B,0		;CP/M互換のアクセスの場合はFCBは36バイト
E90A C9             	RET
E90B                
E90B                ;	ランダムブロックアクセスの連続したセクタをまとめる
E90B                
E90B                DWTC:
E90B E5             	PUSH	HL
E90C 21 9B EC       	LD	HL,DWT24B
E90F 18 04          	JR	DWTC1
E911                DRDC:
E911 E5             	PUSH	HL
E912 21 8B EC       	LD	HL,DRD24B
E915                DWTC1:
E915 22 6F E9       	LD	(DRWF_MODE),HL
E918 E1             	POP	HL
E919 3A 5F E9       	LD	A,(DRWF_B)
E91C B7             	OR	A
E91D 20 0F          	JR	NZ,DRDC1
E91F                SAVE_DRWC:
E91F 06 01          	LD	B,1
E921 ED 43 5E E9    	LD	(DRWF_C),BC
E925 ED 53 65 E9    	LD	(DRWF_E),DE
E929 22 68 E9       	LD	(DRWF_HL),HL
E92C 18 20          	JR	INC_HL_DRWC
E92E                DRDC1:
E92E E5             	PUSH	HL
E92F 21 65 E9       	LD	HL,DRWF_E
E932 86             	ADD	A,(HL)
E933 F5             	PUSH	AF
E934 BB             	CP	E
E935 20 1D          	JR	NZ,DRDC2
E937 F1             	POP	AF
E938 23             	INC	HL
E939 7E             	LD	A,(HL)
E93A CE 00          	ADC	A,0
E93C F5             	PUSH	AF
E93D BA             	CP	D
E93E 20 14          	JR	NZ,DRDC2
E940 F1             	POP	AF
E941 3A 5E E9       	LD	A,(DRWF_C)
E944 CE 00          	ADC	A,0
E946 B9             	CP	C
E947 20 0C          	JR	NZ,DRDC3
E949 21 5F E9       	LD	HL,DRWF_B
E94C 34             	INC	(HL)
E94D E1             	POP	HL
E94E                INC_HL_DRWC:
E94E 3A 90 E8       	LD	A,(SECSZ+2)		;1セクタのサイズの上位1バイト
E951 84             	ADD	A,H
E952 67             	LD	H,A
E953 C9             	RET
E954                DRDC2:
E954 F1             	POP	AF
E955                DRDC3:
E955 CD 5B E9       	CALL	DRW_FLUSH
E958 E1             	POP	HL
E959 18 C4          	JR	SAVE_DRWC
E95B                
E95B                ;	ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
E95B                DRW_FLUSH:
E95B C5             	PUSH	BC
E95C D5             	PUSH	DE
E95D 00 00 E9 5E    DRWF_C	EQU	$+1
E95D 00 00 E9 5F    DRWF_B	EQU	$+2
E95D 01 00 00       	LD	BC,0
E960 78             	LD	A,B
E961 B7             	OR	A
E962 28 0D          	JR	Z,DRDF1
E964 00 00 E9 65    DRWF_E	EQU	$+1
E964 00 00 E9 66    DRWF_D	EQU	$+2
E964 11 00 00       	LD	DE,0
E967 00 00 E9 68    DRWF_HL	EQU	$+1
E967 21 00 00       	LD	HL,0
E96A AF             	XOR	A
E96B 32 5F E9       	LD	(DRWF_B),A
E96E 00 00 E9 6F    DRWF_MODE	EQU	$+1
E96E CD 8B EC       	CALL	DRD24B
E971                DRDF1:
E971 D1             	POP	DE
E972 C1             	POP	BC
E973 C9             	RET
E974                	INCLUDE	"LDDIO.ASM"
E974                
E974                ;	LSX-Dodgers DIO
E974                
E974                DRDX:
E974 CD B2 E9       	CALL	DRDY
E977 C8             	RET	Z
E978 CD 98 E9       	CALL	DRDX1		;データバッファの情報を保存
E97B D8             	RET	C
E97C E5             	PUSH	HL
E97D C5             	PUSH	BC
E97E D5             	PUSH	DE
E97F 2A 7E F1       	LD	HL,(_DTBUF)
E982 3A DB E9       	LD	A,(_DBS24+1)
E985 4F             	LD	C,A
E986 CD 89 EC       	CALL	DRD24
E989 DC AD E9       	CALL	C,DRDNE
E98C                POP_DE_BC_HL_RET:
E98C D1             	POP	DE
E98D C1             	POP	BC
E98E E1             	POP	HL
E98F C9             	RET
E990                
E990                ;	CDE:セクタ番号
E990                DRDN:
E990 AF             	XOR	A
E991 00             DRDN1:	NOP			;自己書き換え NOP / SCF
E992 30 E0          	JR	NC,DRDX
E994                DRDNX:
E994 CD B2 E9       	CALL	DRDY
E997 C8             	RET	Z
E998                DRDX1:
E998 CD C8 E9       	CALL	DWTX
E99B                				;データバッファの読み込んだドライブ・セクタ情報を保存
E99B ED 53 A6 F0    	LD	(_DBSEC),DE
E99F 79             	LD	A,C
E9A0 32 DB E9       	LD	(_DBS24+1),A
E9A3                
E9A3 3A 88 F0       	LD	A,(_DRV)
E9A6 32 A5 F0       	LD	(_DBDRV),A
E9A9 CD D9 F0       	CALL	_CHGDRV
E9AC D0             	RET	NC
E9AD                DRDNE:
E9AD 9F             	SBC	A,A		;CF=1ならばA=0FFH
E9AE 32 A5 F0       	LD	(_DBDRV),A
E9B1 C9             	RET
E9B2                
E9B2                ;	CDE:セクタ番号
E9B2                DRDY:
E9B2 3A DB E9       	LD	A,(_DBS24+1)
E9B5 B9             	CP	C
E9B6 C0             	RET	NZ
E9B7                
E9B7 E5             	PUSH	HL
E9B8 3A 88 F0       	LD	A,(_DRV)
E9BB 21 A5 F0       	LD	HL,_DBDRV
E9BE AE             	XOR	(HL)
E9BF 20 05          	JR	NZ,POP_HL_RET
E9C1                
E9C1 2A A6 F0       	LD	HL,(_DBSEC)
E9C4 ED 52          	SBC	HL,DE		;CF=0
E9C6                POP_HL_RET:
E9C6 E1             	POP	HL
E9C7 C9             	RET
E9C8                
E9C8                DWTX:
E9C8 3A A4 F0       	LD	A,(_WTDBF)
E9CB B7             	OR	A
E9CC C8             	RET	Z
E9CD AF             	XOR	A
E9CE 32 A4 F0       	LD	(_WTDBF),A
E9D1                
E9D1 E5             	PUSH	HL
E9D2 C5             	PUSH	BC
E9D3 D5             	PUSH	DE
E9D4 3A A5 F0       	LD	A,(_DBDRV)
E9D7 CD D9 F0       	CALL	_CHGDRV
E9DA 0E 00          _DBS24:	LD	C,0
E9DC ED 5B A6 F0    	LD	DE,(_DBSEC)
E9E0 2A 7E F1       	LD	HL,(_DTBUF)
E9E3 D4 99 EC       	CALL	NC,DWT24
E9E6                POP_DE_BC_HL_RET2:
E9E6 18 A4          	JR	POP_DE_BC_HL_RET
E9E8                
E9E8                RDFATX:
E9E8 E5             	PUSH	HL
E9E9 3A 88 F0       	LD	A,(_DRV)
E9EC 21 AA F0       	LD	HL,_FATDRV
E9EF AE             	XOR	(HL)
E9F0 28 D4          	JR	Z,POP_HL_RET
E9F2                
E9F2 C5             	PUSH	BC
E9F3 D5             	PUSH	DE
E9F4 DD E5          	PUSH	IX
E9F6 CD 12 EA       	CALL	WTFATX
E9F9 38 13          	JR	C,POP_IX_DE_BC_HL_RET
E9FB                
E9FB AF             	XOR	A
E9FC 32 AB F0       	LD	(_FATIX),A
E9FF 3A 88 F0       	LD	A,(_DRV)
EA02 32 AA F0       	LD	(_FATDRV),A
EA05 CD E5 F0       	CALL	_RDFAT
EA08                RDFATE2:
EA08 30 04          	JR	NC,POP_IX_DE_BC_HL_RET
EA0A 9F             	SBC	A,A		;A=0xFF
EA0B 32 AA F0       	LD	(_FATDRV),A
EA0E                POP_IX_DE_BC_HL_RET:
EA0E DD E1          	POP	IX
EA10 18 D4          	JR	POP_DE_BC_HL_RET2
EA12                
EA12                WTFATX:
EA12 3A A2 F0       	LD	A,(_WTFATF)
EA15 B7             	OR	A
EA16 C8             	RET	Z
EA17 E5             	PUSH	HL
EA18 3A AA F0       	LD	A,(_FATDRV)
EA1B 21 A5 F0       	LD	HL,_DBDRV
EA1E AE             	XOR	(HL)
EA1F CC C8 E9       	CALL	Z,DWTX
EA22 38 A2          	JR	C,POP_HL_RET
EA24 C5             	PUSH	BC
EA25 D5             	PUSH	DE
EA26 DD E5          	PUSH	IX
EA28 CD A6 EC       	CALL	WTFAT
EA2B AF             	XOR	A
EA2C 32 A2 F0       	LD	(_WTFATF),A
EA2F 18 DD          	JR	POP_IX_DE_BC_HL_RET
EA31                
EA31                NCL1:
EA31 7A             	LD	A,D
EA32 B3             	OR	E
EA33 37             	SCF
EA34 C8             	RET	Z
EA35                
EA35 7A             	LD	A,D
EA36 CB 3F          	SRL	A	;/2
EA38 CB 3F          	SRL	A	;/2
EA3A                
EA3A E5             	PUSH	HL
EA3B 32 5A EA       	LD	(NCLPAT+2),A	;_FATIX
EA3E 2A AA F0       	LD	HL,(_FATDRV)	;L=_FATDRV H=_FATIX
EA41 BC             	CP	H
EA42 3A 88 F0       	LD	A,(_DRV)	;この間でフラグは変化しない
EA45 32 59 EA       	LD	(NCLPAT+1),A	;_FATDRV
EA48 20 05          	JR	NZ,NCL2		;FATIXが違う
EA4A BD             	CP	L
EA4B 20 02          	JR	NZ,NCL2		;ドライブが違う
EA4D E1             	POP	HL
EA4E C9             	RET
EA4F                NCL2:
EA4F C5             	PUSH	BC
EA50 D5             	PUSH	DE
EA51 DD E5          	PUSH	IX
EA53 CD 12 EA       	CALL	WTFATX
EA56 38 B6          	JR	C,POP_IX_DE_BC_HL_RET
EA58 01 00 00       NCLPAT:	LD	BC,0		;自己書き換え C=_FATDRV B=_FATIX
EA5B ED 43 AA F0    	LD	(_FATDRV),BC
EA5F CD 7B EC       	CALL	RDFATS
EA62 18 A4          	JR	RDFATE2
EA64                
EA64                NCL3:
EA64 CB 9A          	RES	3,D
EA66 CB 92          	RES	2,D
EA68 6B             	LD	L,E
EA69 62             	LD	H,D
EA6A CB 3C          	SRL	H	;
EA6C CB 1D          	RR	L	;HLA=HLA/2
EA6E 1F             	RRA		;
EA6F F5             	PUSH	AF
EA70 3A AB F0       	LD	A,(_FATIX)
EA73 0F             	RRCA
EA74 30 0B          	JR	NC,NCL3X1
EA76 3A 90 E8       	LD	A,(SECSZ+2)
EA79 FE 04          	CP	4		;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
EA7B 20 04          	JR	NZ,NCL3X1
EA7D 01 00 02       	LD	BC,512
EA80 09             	ADD	HL,BC
EA81                NCL3X1:
EA81 F1             	POP	AF
EA82 ED 4B 7C F1    	LD	BC,(_FATBF)
EA86 19             	ADD	HL,DE
EA87 09             	ADD	HL,BC
EA88 17             	RLA
EA89 C9             	RET
EA8A                
EA8A                GNCL:
EA8A CD 31 EA       	CALL	NCL1		;GET NEXT CLUSTER
EA8D D8             	RET	C
EA8E C5             	PUSH	BC
EA8F E5             	PUSH	HL
EA90 CD 64 EA       	CALL	NCL3
EA93 38 09          	JR	C,GNC1
EA95 5E             	LD	E,(HL)
EA96 23             	INC	HL
EA97 7E             	LD	A,(HL)
EA98 E6 0F          	AND	00FH
EA9A 57             	LD	D,A
EA9B E1             	POP	HL
EA9C C1             	POP	BC
EA9D C9             	RET
EA9E                GNC1:
EA9E 7E             	LD	A,(HL)
EA9F 23             	INC	HL
EAA0 56             	LD	D,(HL)
EAA1 06 04          	LD	B,4
EAA3                GNC1L:
EAA3 CB 3A          	SRL	D	;DA=DA/2
EAA5 1F             	RRA		;
EAA6 10 FB          	DJNZ	GNC1L
EAA8                
EAA8 5F             	LD	E,A
EAA9 E1             	POP	HL
EAAA C1             	POP	BC
EAAB A7             	AND	A
EAAC C9             	RET
EAAD                
EAAD                SNCL:
EAAD CD 31 EA       	CALL	NCL1
EAB0 D8             	RET	C
EAB1                ;				SET NEXT CLUSTER
EAB1 E5             	PUSH	HL
EAB2 C5             	PUSH	BC
EAB3 D5             	PUSH	DE
EAB4 E5             	PUSH	HL
EAB5 CD 64 EA       	CALL	NCL3
EAB8 D1             	POP	DE
EAB9                ;CF=ODD
EAB9 7E             	LD	A,(HL)
EABA 73             	LD	(HL),E
EABB 38 06          	JR	C,SNC1
EABD                ;EVEN
EABD                ;M[0] = E
EABD                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
EABD 23             	INC	HL
EABE ED 67          	RRD		;M={A[3:0],E[3:0]}
EAC0 7A             	LD	A,D
EAC1 18 04          	JR	SNC11
EAC3                SNC1:
EAC3                ;ODD
EAC3                ;HL[0] = (HL[0]&0x0F) | (E<<4)
EAC3                ;HL[1] = DE>>4
EAC3 ED 6F          	RLD		;M={D[3:0],E[7:4]}
EAC5 23             	INC	HL
EAC6 72             	LD	(HL),D	;M={D[3:0],E[7:4]}
EAC7                SNC11:
EAC7 ED 6F          	RLD		;M={M[7:4],D[3:0]}
EAC9 B7             	OR	A
EACA D1             	POP	DE
EACB C1             	POP	BC
EACC E1             	POP	HL
EACD                FAT_CHANGED:
EACD 3E 01          	LD	A,1
EACF 32 A2 F0       	LD	(_WTFATF),A
EAD2 C9             	RET
EAD3                
EAD3                N16CL3:
EAD3 C5             	PUSH	BC
EAD4 6B             	LD	L,E
EAD5 7A             	LD	A,D
EAD6 E6 03          	AND	3
EAD8 67             	LD	H,A
EAD9 29             	ADD	HL,HL
EADA ED 4B 7C F1    	LD	BC,(_FATBF)
EADE 09             	ADD	HL,BC
EADF C1             	POP	BC
EAE0 C9             	RET
EAE1                
EAE1                GNCL16:
EAE1 CD 31 EA       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EAE4 D8             	RET	C
EAE5 E5             	PUSH	HL
EAE6 CD D3 EA       	CALL	N16CL3
EAE9 5E             	LD	E,(HL)
EAEA 23             	INC	HL
EAEB 56             	LD	D,(HL)
EAEC E1             	POP	HL
EAED C9             	RET
EAEE                
EAEE                SNCL16:
EAEE CD 31 EA       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EAF1 D8             	RET	C
EAF2 D5             	PUSH	DE
EAF3 E5             	PUSH	HL
EAF4 CD D3 EA       	CALL	N16CL3
EAF7 D1             	POP	DE		;HL
EAF8 73             	LD	(HL),E
EAF9 23             	INC	HL
EAFA 72             	LD	(HL),D
EAFB 6B             	LD	L,E
EAFC 62             	LD	H,D
EAFD D1             	POP	DE
EAFE 18 CD          	JR	FAT_CHANGED
EB00                
EB00                ;------------------------
EB00                ;次のセクタを探す際に_SECPSの値をチェック
EB00                ;in
EB00                ;	DE : セクタ番号
EB00                ;out
EB00                ;	DE : 次のセクタ番号
EB00                ;note
EB00                ;
EB00                ;------------------------
EB00                NEXTX:
EB00 3E 00          _SECPS:	LD	A,0	;自己書き換え
EB02 3C             	INC	A
EB03 E6 00          NCPAT:	AND	0	;自己書き換え　1クラスタの論理セクタ数-1
EB05 32 01 EB       	LD	(_SECPS+1),A
EB08 C9             	RET
EB09                
EB09                GNCLX:
EB09 CD 00 EB       	CALL	NEXTX
EB0C C0             	RET	NZ	;1クラスタのセクタ未満の場合は戻る
EB0D C3 F7 F0       	JP	_GNCL	;次のクラスタを探す
EB10                
EB10                RDFAT:
EB10 3E 80          	LD	A,080H
EB12 32 70 F0       	LD	(CHECK),A
EB15                RDFAT1:
EB15 3A 88 F0       	LD	A,(_DRV)
EB18 CD D0 ED       	CALL	CHGDRVR
EB1B D8             	RET	C
EB1C DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EB1F CB 6F          	BIT	5,A
EB21 28 6B          	JR	Z,RDFAT0X
EB23 21 70 F0       	LD	HL,CHECK
EB26 A6             	AND	(HL)
EB27 77             	LD	(HL),A
EB28 11 00 00       	LD	DE,0		;BPB
EB2B 2A 7C F1       	LD	HL,(_FATBF)
EB2E CD 87 EC       	CALL	DRD16
EB31 30 24          	JR	NC,GETBPB
EB33 21 70 F0       	LD	HL,CHECK
EB36 CB 06          	RLC	(HL)
EB38 3F             	CCF
EB39 D8             	RET	C
EB3A DD CB 0A 1E    	RR	(IX+00AH)	;DPB_0A_FDMODE
EB3E 3F             	CCF			;フロッピーディスクのFDモードを切り替える
EB3F DD CB 0A 16    	RL	(IX+00AH)	;DPB_0A_FDMODE
EB43 3E FF          	LD	A,0FFH
EB45 32 89 F0       	LD	(_DSK),A
EB48 3A 84 F0       	LD	A,(_DRIVE)
EB4B E6 03          	AND	3
EB4D F6 80          	OR	080H
EB4F 6F             	LD	L,A
EB50 26 F0          	LD	H,_CYL0/256
EB52 3E FF          	LD	A,0FFH
EB54 77             	LD	(HL),A
EB55 18 BE          	JR	RDFAT1
EB57                GETBPB:
EB57 FD E5          	PUSH	IY
EB59 FD 2A 7C F1    	LD	IY,(_FATBF)	;BPB
EB5D CD F1 F0       	CALL	_BPB2DPB
EB60 FD E1          	POP	IY
EB62 DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EB65 30 21          	JR	NC,GETBPBOK
EB67 E6 0F          	AND	00FH
EB69 FE 07          	CP	7
EB6B 37             	SCF
EB6C C0             	RET	NZ
EB6D DD CB 0A 46    	BIT	0,(IX+00AH)	;DPB_0A_FDMODE
EB71 21 C0 F1       	LD	HL,M2D
EB74 20 02          	JR	NZ,SETFDMODE
EB76 2E D2          	LD	L,M2HD-STABLE
EB78                SETFDMODE:
EB78 DD E5          	PUSH	IX
EB7A D1             	POP	DE
EB7B ED A0          	LDI
EB7D ED A0          	LDI
EB7F 13             	INC	DE
EB80 13             	INC	DE
EB81 13             	INC	DE
EB82 13             	INC	DE
EB83 01 0C 00       	LD	BC,12
EB86 ED B0          	LDIR
EB88                GETBPBOK:
EB88 32 97 EB       	LD	(DEVSWC),A
EB8B CD 2F ED       	CALL	CHGDRV2
EB8E                RDFAT0X:
EB8E CD 7B EC       	CALL	RDFATS
EB91 D8             	RET	C
EB92 DD AE 06       	XOR	(IX+6)		;DPB_06_FATID
EB95 C8             	RET	Z
EB96 00 00 EB 97    DEVSWC	EQU	$+1
EB96 3E 00          	LD	A,0		;DPB_12_DEVICE
EB98 CB 6F          	BIT	5,A
EB9A C0             	RET	NZ		;BPBを取得している場合はFATIDをチェックしない
EB9B 37             	SCF
EB9C C9             	RET
EB9D                
EB9D                BPB2DPB:
EB9D FD 7E 0B       	LD	A,(IY+11)	;BPB_BytsPerSec
EBA0 B7             	OR	A
EBA1 37             	SCF
EBA2 C0             	RET	NZ
EBA3                BPBOK:
EBA3 FD 7E 0D       	LD	A,(IY+13)	;BPB_SecPerClus
EBA6 DD 77 07       	LD	(IX+7),A	;DPB_07_SECPCL
EBA9                
EBA9 FD 7E 16       	LD	A,(IY+22)	;BPB_FATSz16
EBAC DD 77 00       	LD	(IX+0),A	;DPB_00_FATLN
EBAF FD 7E 17       	LD	A,(IY+23)	;BPB_FATSz16
EBB2 DD 77 01       	LD	(IX+1),A	;DPB_00_FATLN
EBB5                
EBB5 FD 6E 0E       	LD	L,(IY+14)	;BPB_RsvdSecCnt
EBB8 FD 66 0F       	LD	H,(IY+15)
EBBB DD 75 0E       	LD	(IX+00EH),L	;DPB_0E_FATPS
EBBE FD 5E 16       	LD	E,(IY+22)	;BPB_FATSz16
EBC1 FD 56 17       	LD	D,(IY+23)
EBC4 FD 46 10       	LD	B,(IY+16)	;BPB_NumFATs
EBC7                BPBDP1:				;BPB_FATSz16 * BPB_NumFATs
EBC7 19             	ADD	HL,DE
EBC8 10 FD          	DJNZ	BPBDP1
EBCA                BPBDP2:
EBCA DD 75 10       	LD	(IX+010H),L	;DPB_10_DIRPS
EBCD DD 74 11       	LD	(IX+011H),H
EBD0 E5             	PUSH	HL
EBD1                
EBD1 FD 6E 11       	LD	L,(IY+17)	;BPB_RootEntCnt
EBD4 FD 66 12       	LD	H,(IY+18)
EBD7 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EBDA B7             	OR	A
EBDB 37             	SCF
EBDC C8             	RET	Z
EBDD 06 06          	LD	B,6
EBDF                BPBBPS1:
EBDF 05             	DEC	B
EBE0 0F             	RRCA
EBE1 30 FC          	JR	NC,BPBBPS1
EBE3                BPBDE1:
EBE3 29             	ADD	HL,HL
EBE4 10 FD          	DJNZ	BPBDE1
EBE6                
EBE6 7C             	LD	A,H
EBE7 DD 77 0B       	LD	(IX+00BH),A	;DPB_0B_DIRSCNT
EBEA                
EBEA D1             	POP	DE		;DPB_10_DIRPS
EBEB 6C             	LD	L,H
EBEC 26 00          	LD	H,0
EBEE 19             	ADD	HL,DE		;MAXDIR
EBEF E5             	PUSH	HL
EBF0 FD 4E 0D       	LD	C,(IY+13)	;BPB_SecPerClus
EBF3 CB 21          	SLA	C		;*2
EBF5 AF             	XOR	A
EBF6 47             	LD	B,A
EBF7 ED 42          	SBC	HL,BC
EBF9 DD 75 14       	LD	(IX+014H),L	;DPB_14_ADDCL16
EBFC DD 74 15       	LD	(IX+015H),H
EBFF                
EBFF D1             	POP	DE		;DE=DPB_0B_MAXDIR
EC00 FD 6E 13       	LD	L,(IY+19)	;BPB_TotSec16
EC03 FD 66 14       	LD	H,(IY+20)
EC06                
EC06 DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EC09 E6 0F          	AND	00FH
EC0B FE 07          	CP	7		;フロッピー
EC0D 20 19          	JR	NZ,NOT_FD
EC0F E5             	PUSH	HL
EC10 FD 4E 18       	LD	C,(IY+24)	;BPB_SecPerTr
EC13 DD 71 0D       	LD	(IX+00DH),C	;DPB_0D_MAXSEC
EC16 AF             	XOR	A
EC17 CB 21          	SLA	C		;両面なのでセクタ数を２倍
EC19 06 10          	LD	B,16
EC1B                DIVSEC:				;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
EC1B 29             	ADD	HL,HL
EC1C 17             	RLA
EC1D B9             	CP	C
EC1E 38 02             	JR	C,DIVSEC1
EC20 91                	SUB	C
EC21 2C             	INC	L
EC22                DIVSEC1:
EC22 10 F7           	DJNZ	DIVSEC
EC24 DD 75 0C       	LD	(IX+00CH),L	;DPB_0C_MAXCYL
EC27 E1             	POP	HL	;ここまでフロッピー専用
EC28                NOT_FD:
EC28 7C             	LD	A,H
EC29 B5             	OR	L
EC2A 3E 00          	LD	A,0		;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
EC2C 20 10          	JR	NZ,BPB16BIT	;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
EC2E FD 7E 23       	LD	A,(IY+35)	;念のために総セクタ数が24ビットを超える場合はエラーを返す
EC31 B7             	OR	A
EC32 37             	SCF
EC33 C0             	RET	NZ
EC34 FD 6E 20       	LD	L,(IY+32)	;BPB_TotSec32 は AHL の24ビットで扱う
EC37 FD 66 21       	LD	H,(IY+33)	;1クラスタの論理セクタ数(DPB_07_SECPCL)が最大128なので
EC3A FD 7E 22       	LD	A,(IY+34)	;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
EC3D A7             	AND	A		;CF=0
EC3E                BPB16BIT:
EC3E ED 52          	SBC	HL,DE
EC40 DE 00          	SBC	A,0
EC42 FD 46 0D       	LD	B,(IY+13)	;BPB_SecPerClus
EC45                BPBTC1:				;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
EC45 CB 18          	RR	B		;->CY
EC47 38 08          	JR	C,BPBTC2
EC49 CB 3F          	SRL	A
EC4B CB 1C          	RR	H		;AHL=AHL/2
EC4D CB 1D          	RR	L
EC4F 18 F4          	JR	BPBTC1
EC51                BPBTC2:
EC51 B7             	OR	A
EC52 37             	SCF
EC53 C0             	RET	NZ		;念のため(クラスタ数が16ビットを超える場合)
EC54 23             	INC	HL
EC55 23             	INC	HL
EC56 DD 75 08       	LD	(IX+8),L	;DPB_08_MAXCL
EC59 DD 74 09       	LD	(IX+9),H
EC5C                
EC5C FD 7E 15       	LD	A,(IY+21)	;BPB_Media
EC5F DD 77 06       	LD	(IX+6),A	;DPB_06_FATID
EC62                
EC62 FD 7E 10       	LD	A,(IY+16)	;BPB_NumFATs
EC65 C6 FE          	ADD	A,0-2		;>2:CF=1
EC67 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EC6A 6F             	LD	L,A
EC6B 30 02          	JR	NC,BPBFAT1
EC6D F6 80          	OR	080H
EC6F                BPBFAT1:
EC6F DD 77 0F       	LD	(IX+00FH),A	;DPB_0F_BPS
EC72 2D             	DEC	L		;以下のセクタサイズに合致しない場合はCF=1でエラーにする
EC73 C8             	RET	Z		;1セクタ256バイト
EC74 2D             	DEC	L
EC75 C8             	RET	Z		;1セクタ512バイト
EC76 2D             	DEC	L
EC77 2D             	DEC	L
EC78 C8             	RET	Z		;1セクタ1024バイト
EC79 37             	SCF
EC7A C9             	RET
EC7B                
EC7B                RDFATS:
EC7B CD C1 EC       	CALL	FATSETUP
EC7E D8             	RET	C
EC7F CD 8B EC       	CALL	DRD24B
EC82 2A 7C F1       	LD	HL,(_FATBF)
EC85 7E             	LD	A,(HL)
EC86 C9             	RET
EC87                
EC87                DRD16:
EC87 0E 00          	LD	C,0
EC89                DRD24:
EC89 06 01          	LD	B,1
EC8B                DRD24B:
EC8B DD E5          	PUSH	IX
EC8D DD 2A A8 F0    	LD	IX,(_DPB)
EC91 CD EB EE       DRDPAT:	CALL	FDRD		;自己書き換え（ディスク読み込み）
EC94                POP_IX_RET:
EC94 DD E1          	POP	IX
EC96 C9             	RET
EC97                
EC97                DWT16:
EC97 0E 00          	LD	C,0
EC99                DWT24:
EC99 06 01          	LD	B,1
EC9B                DWT24B:
EC9B DD E5          	PUSH	IX
EC9D DD 2A A8 F0    	LD	IX,(_DPB)
ECA1 CD DD EE       DWTPAT:	CALL	FDWT		;自己書き換え（ディスク書き込み）
ECA4 18 EE          	JR	POP_IX_RET
ECA6                
ECA6                WTFAT:
ECA6 CD C1 EC       	CALL	FATSETUP
ECA9 D4 9B EC       	CALL	NC,DWT24B
ECAC D8             	RET	C
ECAD DD CB 0F 7E    	BIT	7,(IX+00FH)	;DPB_0F_BPS
ECB1 C8             	RET	Z		;予備FATが無い
ECB2 CD C8 EC       	CALL	FATS2
ECB5 E5             	PUSH	HL		;予備FAT
ECB6 DD 6E 00       	LD	L,(IX+0)	;DPB_00_FATLN
ECB9 DD 66 01       	LD	H,(IX+1)
ECBC 19             	ADD	HL,DE
ECBD EB             	EX	DE,HL
ECBE E1             	POP	HL
ECBF 18 DA          	JR	DWT24B
ECC1                ;------------------------
ECC1                ;FATのセットアップ
ECC1                ;out
ECC1                ;	B  : FATセクタ数
ECC1                ;	DE : FAT先頭セクタ番号
ECC1                ;	HL : FATバッファポインタ
ECC1                ;	CF : 1=ドライブ切り替えエラー
ECC1                ;note
ECC1                ;	FATサイズがFATバッファを超える場合は
ECC1                ;	対象クラスタ領域==(_FATIX)によって
ECC1                ;	FAT12:対象クラスタ1024毎に1.5KBを切り替える
ECC1                ;	FAT16:対象クラスタ1024毎に2KBを切り替える
ECC1                ;------------------------
ECC1                FATSETUP:
ECC1 3A AA F0       	LD	A,(_FATDRV)
ECC4 CD D0 ED       	CALL	CHGDRVR		;ドライブ切り替え
ECC7 D8             	RET	C
ECC8                FATS2:
ECC8 DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS 512=2 1024=4
ECCB 0F             	RRCA
ECCC CD F5 EC       FATSX:	CALL	FATSETUP12	;自己書き換え
ECCF 21 00 00       	LD	HL,0
ECD2 4A             	LD	C,D
ECD3 54             	LD	D,H
ECD4 3A AB F0       	LD	A,(_FATIX)	;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
ECD7 47             	LD	B,A
ECD8 04             	INC	B
ECD9 DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
ECDC                FAT_SKP:
ECDC 05             	DEC	B
ECDD 28 05          	JR	Z,FAT1
ECDF 19             	ADD	HL,DE
ECE0 93             	SUB	E
ECE1 30 F9          	JR	NC,FAT_SKP
ECE3 C9             	RET
ECE4                FAT1:
ECE4 EB             	EX	DE,HL
ECE5 B9             	CP	C		;C=FATバッファに読み込めるセクタ数
ECE6 38 01          	JR	C,FAT2
ECE8 79             	LD	A,C
ECE9                FAT2:
ECE9 47             	LD	B,A
ECEA                
ECEA 2A FA F1       	LD	HL,(_FATPS)	;fat sector pos
ECED 19             	ADD	HL,DE
ECEE EB             	EX	DE,HL
ECEF 2A 7C F1       	LD	HL,(_FATBF)
ECF2 AF             	XOR	A		;CF=0
ECF3 4F             	LD	C,A
ECF4 C9             	RET
ECF5                ;
ECF5                ;	FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
ECF5                ;	FATSETUP* (FAT12/FAT16)
ECF5                ;out
ECF5                ;	D : FATバッファに読み込める最大のセクタ数
ECF5                ;	E : _FATIXで進めるセクタ数
ECF5                FATSETUP12:
ECF5 11 06 06       	LD	DE,0606H	;256
ECF8 D8             	RET	C
ECF9 11 03 03       	LD	DE,0303H	;512
ECFC 0F             	RRCA
ECFD D8             	RET	C
ECFE 11 01 02       	LD	DE,0201H	;1024
ED01 C9             	RET
ED02                
ED02                FATSETUP16:
ED02 11 08 08       	LD	DE,0808H	;256
ED05 D8             	RET	C
ED06 11 04 04       	LD	DE,0404H
ED09 0F             	RRCA			;512
ED0A D8             	RET	C
ED0B 11 02 02       	LD	DE,0202H	;1024
ED0E C9             	RET
ED0F                
ED0F                CHGDRV:
ED0F E5             	PUSH	HL
ED10 21 89 F0       	LD	HL,_DSK
ED13 BE             	CP	(HL)
ED14 28 0A          	JR	Z,CHGDRVE
ED16                CHGDRV1:
ED16 DD E5          	PUSH	IX
ED18 CD 22 ED       	CALL	CHGDRV0
ED1B 3A 89 F0       	LD	A,(_DSK)
ED1E DD E1          	POP	IX
ED20                CHGDRVE:
ED20 E1             	POP	HL
ED21 C9             	RET
ED22                
ED22                CHGDRV0:
ED22 6F             	LD	L,A
ED23 CD DC F0       	CALL	_GETDPB
ED26 D8             	RET	C
ED27 DD 22 A8 F0    	LD	(_DPB),IX
ED2B 7D             	LD	A,L
ED2C 32 89 F0       	LD	(_DSK),A
ED2F                CHGDRV2:
ED2F C5             	PUSH	BC
ED30 D5             	PUSH	DE
ED31 ED 73 86 ED    	LD	(SPPAT2+1),SP
ED35 F3             	DI
ED36 DD F9          	LD	SP,IX
ED38                
ED38 E1             	POP	HL		;DPB_00_FATLN
ED39 E1             	POP	HL		;DPB_02_DRD
ED3A 22 92 EC       	LD	(DRDPAT+1),HL
ED3D                
ED3D E1             	POP	HL
ED3E 22 A2 EC       	LD	(DWTPAT+1),HL	;DPB_04_DWT
ED41                
ED41 E1             	POP	HL		;L=DPB_06_FATID H=DPB_07_SECPCL
ED42 7C             	LD	A,H
ED43 32 72 E3       	LD	(SPCPAT+1),A	;1クラスタの論理セクタ数
ED46 3D             	DEC	A
ED47 32 04 EB       	LD	(NCPAT+1),A
ED4A                
ED4A E1             	POP	HL		;DPB_08_MAXCL
ED4B 7D             	LD	A,L
ED4C 32 91 E3       	LD	(CLPAT2+1),A
ED4F 7C             	LD	A,H
ED50 32 8D E3       	LD	(CLPAT1+1),A
ED53 2B             	DEC	HL
ED54 22 95 E5       	LD	(MAXCLP+1),HL
ED57                
ED57 E1             	POP	HL		;L=DPB_0A_FDMODE H=DPB_0B_DIRSCNT
ED58 7D             	LD	A,L
ED59 F6 FE          	OR	0FEH
ED5B 32 86 EE       	LD	(FDMODE+1),A
ED5E 07             	RLCA
ED5F E6 03          	AND	3
ED61 32 6E EE       	LD	(FSPAT+1),A
ED64 4C             	LD	C,H
ED65                
ED65 E1             	POP	HL		;L=DPB_0C_MAXCYL H=DPB_0D_MAXSEC
ED66                
ED66 E1             	POP	HL		;L=DPB_0E_FATPS H=DPB_0F_BPS
ED67 7C             	LD	A,H		;DPB_0F_BPS
ED68 E6 07          	AND	7
ED6A 32 90 E8       	LD	(SECSZ+2),A	;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
ED6D                				;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
ED6D                				;1セクタ1024 2HD/2HDE98
ED6D                				;1セクタ256 GRAM/RAMF/CMOS/等
ED6D                				;1024	512	256
ED6D                				;4	2	1
ED6D 87             	ADD	A,A		;8	4	2
ED6E 87             	ADD	A,A		;010H	8	4
ED6F 87             	ADD	A,A		;020H	010H	8
ED70 32 EE E1       	LD	(SDECPAT+1),A	;1セクタ辺りのディレクトリエントリ数
ED73                
ED73 26 00          	LD	H,0
ED75 22 FA F1       	LD	(_FATPS),HL
ED78                
ED78 E1             	POP	HL		;DPB_10_DIRPS
ED79 22 FC F1       	LD	(_DIRPS),HL
ED7C                
ED7C E1             	POP	HL		;L=DPB_12_DEVICE H=DPB_13_UNITNO
ED7D 7C             	LD	A,H
ED7E 32 84 F0       	LD	(_DRIVE),A
ED81                
ED81 E1             	POP	HL		;DPB_14_ADDCL16
ED82 22 82 E3       	LD	(CLSPAT+1),HL
ED85                
ED85 31 00 00       SPPAT2:	LD	SP,0		;元のSPを復元
ED88 FB             	EI
ED89 2A FC F1       	LD	HL,(_DIRPS)
ED8C 06 00          	LD	B,0
ED8E 09             	ADD	HL,BC		;C=DPB_0B_DIRSCNT
ED8F 22 09 E2       	LD	(MD_PAT+1),HL
ED92                
ED92 2A 95 E5       	LD	HL,(MAXCLP+1);
ED95 11 F6 0F       	LD	DE,4086		;クラスタ数が4086未満:FAT12 4086以上:FAT16
ED98 ED 52          	SBC	HL,DE		;CF=0のはず
ED9A 30 0F          	JR	NC,SETFAT16
ED9C 21 8A EA       	LD	HL,GNCL		;FAT12
ED9F 11 AD EA       	LD	DE,SNCL
EDA2 01 F5 EC       	LD	BC,FATSETUP12
EDA5 DD CB 0F AE    	RES	5,(IX+00FH)	;DPB_0F_BPS(FAT12)
EDA9 18 0D          	JR	EXTRA1
EDAB                SETFAT16:
EDAB 21 E1 EA       	LD	HL,GNCL16	;FAT16
EDAE 11 EE EA       	LD	DE,SNCL16
EDB1 01 02 ED       	LD	BC,FATSETUP16
EDB4 DD CB 0F EE    	SET	5,(IX+00FH)	;DPB_0F_BPS(FAT16)
EDB8                EXTRA1:
EDB8 22 F8 F0       	LD	(GNCPAT+1),HL
EDBB ED 53 FB F0    	LD	(SNCPAT+1),DE
EDBF ED 43 CD EC    	LD	(FATSX+1),BC
EDC3 D1             	POP	DE
EDC4 C1             	POP	BC
EDC5 AF             	XOR	A
EDC6 C9             	RET
EDC7                
EDC7                GETDPBD:
EDC7 DD E3          	EX	(SP),IX
EDC9 DD E5          	PUSH	IX
EDCB 3A 88 F0       	LD	A,(_DRV)
EDCE 18 07          	JR	GETDPB1
EDD0                
EDD0                CHGDRVR:
EDD0 CD D9 F0       	CALL	_CHGDRV
EDD3 D8             	RET	C
EDD4 3A 89 F0       	LD	A,(_DSK)
EDD7                GETDPB1:
EDD7 C3 DC F0       	JP	_GETDPB
EDDA                
EDDA                GETDPB:
EDDA FE 08          	CP	8
EDDC 3F             	CCF
EDDD D8             	RET	C
EDDE 0F             	RRCA
EDDF 0F             	RRCA
EDE0 0F             	RRCA
EDE1 DD             	DB	0DDH		;Z80未定義命令
EDE2 6F             	LD	L,A		;LD	IXL,A
EDE3 DD             	DB	0DDH		;Z80未定義命令
EDE4 26 F2          	LD	H,DEVICE/256	;LD	IXH,DEVICE/256
EDE6 DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
EDE9 A7             	AND	A		;CF=0の為
EDEA DD CB 0F 6E    	BIT	5,(IX+00FH)	;DPB_0F_BPS
EDEE C0             	RET	NZ		;FAT16
EDEF DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
EDF3 C0             	RET	NZ		;BPB
EDF4 FE 01          	CP	001H		;A=0 THEN CF=1
EDF6 C9             	RET
EDF7                
EDF7                _SYS5F:
EDF7 AF             	XOR	A
EDF8                FFLUSH:
EDF8 F5             	PUSH	AF
EDF9 3E FF          	LD	A,0FFH
EDFB 32 39 F0       	LD	(SFILE),A
EDFE CD C8 E9       	CALL	DWTX
EE01 3E FF          	LD	A,0FFH
EE03 32 A5 F0       	LD	(_DBDRV),A
EE06 CD 12 EA       	CALL	WTFATX
EE09 AF             	XOR	A
EE0A 32 AB F0       	LD	(_FATIX),A
EE0D 2F             	CPL			;0FFH
EE0E 32 AA F0       	LD	(_FATDRV),A
EE11 F1             	POP	AF
EE12 C9             	RET
EE13                
EE13                	INCLUDE	"X1DISK.ASM"
EE13                
EE13                ;	LSX-Dodgers DISK
EE13                ;	X1/turbo/Z
EE13                
EE13                SEEK:
EE13 06 10          	LD	B,16
EE15 DD 4E 0D       	LD	C,(IX+0DH)	;DPB_0D_MAXSEC
EE18 AF             	XOR	A
EE19 EB             	EX	DE,HL
EE1A                DIV1:
EE1A 29             	ADD	HL,HL
EE1B 8F             	ADC	A,A
EE1C B9             	CP	C
EE1D 38 02          	JR	C,DIV2
EE1F 91             	SUB	C
EE20 2C             	INC	L
EE21                DIV2:
EE21 10 F7          	DJNZ	DIV1
EE23                
EE23 3C             	INC	A	;最小のセクタは１固定
EE24 55             	LD	D,L	;TRACK
EE25 5F             	LD	E,A	;SECTOR
EE26 CB 3A          	SRL	D	;CYLINDER
EE28 9F             	SBC	A,A
EE29 E6 10          	AND	010H	;SIDE
EE2B 4F             	LD	C,A
EE2C                
EE2C 3A 84 F0       	LD	A,(_DRIVE)
EE2F FE 04          	CP	4
EE31 3F             	CCF
EE32 D8             	RET	C
EE33 B1             	OR	C
EE34 32 B2 EE       	LD	(MOPAT+1),A	;Motor off data
EE37 01 FC 0F       	LD	BC,00FFCH
EE3A F6 80          	OR	080H		;Motor on
EE3C ED 79          	OUT	(C),A
EE3E                
EE3E CD 84 EE       	CALL	SETMODE
EE41 D8             	RET	C
EE42                
EE42 CD C7 EE       	CALL	DRIVE
EE45 FE FF          	CP	0FFH		;A=0FFH Unknown CYLINDER
EE47 CC A6 EE       	CALL	Z,FDCRES	;Restore
EE4A 0E F9          	LD	C,0F9H
EE4C ED 79          	OUT	(C),A		;Currrent CYLINDER
EE4E 92             	SUB	D
EE4F C8             	RET	Z		;No seek
EE50                
EE50 3A 86 F0       	LD	A,(_ISEEK)
EE53 4F             	LD	C,A
EE54                
EE54 DD 7E 0C       	LD	A,(IX+00CH)	;DPB_0C_MAXCYL
EE57 3D             	DEC	A
EE58 BA             	CP	D		;Over CYLINDER
EE59 D8             	RET	C
EE5A                
EE5A B9             	CP	C		;for Built-in 2DD
EE5B 38 03          	JR	C,SETM2
EE5D 78             	LD	A,B		;B=00FH
EE5E DB FE          	IN	A,(0FEH)		;2HD mode for 2DD seek
EE60                SETM2:
EE60 78             	LD	A,B
EE61 DB FD          	IN	A,(0FDH)		;MFM mode
EE63                
EE63 0E FB          	LD	C,0FBH
EE65 ED 51          	OUT	(C),D
EE67 72             	LD	(HL),D
EE68 0E 18          	LD	C,018H		;Seek
EE6A                FDCCMD2:
EE6A 3A 85 F0       	LD	A,(_SEEKSP)
EE6D E6 FF          FSPAT:	AND	0FFH
EE6F B1             	OR	C
EE70                
EE70                FDCCMD:
EE70 CD BD EE       	CALL	COMSET
EE73                
EE73 3E 80          FDCPAT:	LD	A,080H		;FDC COMMAND(Self-modifying code)
EE75 E6 20          	AND	020H		;Write data Write track
EE77 3C             	INC	A
EE78                
EE78                SST:
EE78 0E 00          	LD	C,0
EE7A                SST1:
EE7A 0D             	DEC	C		; 4
EE7B 20 FD          	JR	NZ,SST1		;12 * 256 / 4 = About 1ms
EE7D 3D             	DEC	A
EE7E 20 FA          	JR	NZ,SST1
EE80                
EE80 3C             	INC	A		;A=1
EE81 CD 8F EE       	CALL	READY
EE84                SETMODE:
EE84 78             	LD	A,B		;B=00FH
EE85 DB FF          FDMODE:	IN	A,(0FFH)	;Floppy mode(2D/2HD) (Self-modifying code)
EE87                
EE87 78             	LD	A,B
EE88 DB FD          	IN	A,(0FDH)	;MFM mode
EE8A                
EE8A CD C1 EE       	CALL	DELAY0		;Head select time
EE8D 3E 81          	LD	A,081H
EE8F                READY:
EE8F 32 99 EE       	LD	(WAITA+1),A
EE92 E5             	PUSH	HL
EE93 0E F8          	LD	C,0F8H
EE95 61             	LD	H,C
EE96                READY2:
EE96 ED 78          	IN	A,(C)
EE98 E6 81          WAITA:	AND	081H		;NOT READY,BUSY
EE9A 28 08          	JR	Z,READYE
EE9C E3             	EX	(SP),HL		;wait 19clock
EE9D E3             	EX	(SP),HL		; //
EE9E 2B             	DEC	HL
EE9F 7C             	LD	A,H
EEA0 B5             	OR	L
EEA1 20 F3          	JR	NZ,READY2
EEA3 37             	SCF
EEA4                READYE:
EEA4 E1             	POP	HL
EEA5 C9             	RET
EEA6                
EEA6                FDCRES:
EEA6 36 00          	LD	(HL),0
EEA8 0E 08          	LD	C,8
EEAA 18 BE          	JR	FDCCMD2
EEAC                
EEAC                FDMOFF:
EEAC F5             	PUSH	AF
EEAD C5             	PUSH	BC
EEAE 01 FC 0F       	LD	BC,00FFCH	;Motor off
EEB1 3E 00          MOPAT:	LD	A,000H		;(Self-rewriting)
EEB3 ED 79          	OUT	(C),A
EEB5 C1             	POP	BC
EEB6 F1             	POP	AF
EEB7 C9             	RET
EEB8                
EEB8                SECSET:
EEB8 01 FA 0F       	LD	BC,00FFAH
EEBB ED 59          	OUT	(C),E
EEBD                COMSET:
EEBD 0E F8          	LD	C,0F8H
EEBF ED 79          	OUT	(C),A
EEC1                DELAY0:
EEC1 3E 1A          	LD	A,26
EEC3                DELAY:
EEC3 3D             	DEC	A
EEC4 20 FD          	JR	NZ,DELAY
EEC6 C9             	RET
EEC7                
EEC7                DRIVE:
EEC7 2A 84 F0       	LD	HL,(_DRIVE)
EECA 26 F0          	LD	H,_CYL0/256
EECC CB FD          	SET	7,L
EECE 7E             	LD	A,(HL)
EECF C9             	RET
EED0                
EED0                RNF:
EED0 CD C7 EE       	CALL	DRIVE
EED3 36 FF          	LD	(HL),0FFH
EED5 C9             	RET
EED6                
EED6 02             RETRY:	DB	2
EED7                
EED7                
EED7                ;	FLOPPY DISK DRIVER(DMA)
EED7                
EED7                
EED7                WTTRK:
EED7 06 01          	LD	B,1
EED9 3E F4          	LD	A,0F4H
EEDB 18 02          	JR	WTTRK1
EEDD                FDWT:
EEDD 3E A0          	LD	A,0A0H
EEDF                WTTRK1:
EEDF 32 74 EE       	LD	(FDCPAT+1),A
EEE2 3E 10          	LD	A,16
EEE4 18 0C          	JR	DISK
EEE6                
EEE6                DISKOK:
EEE6 06 01          FDCNT:	LD	B,1
EEE8 10 0B          	DJNZ	DISK1
EEEA C9             	RET
EEEB                
EEEB                FDRD:
EEEB 3E 80          	LD	A,080H
EEED 32 74 EE       	LD	(FDCPAT+1),A
EEF0 3E 0E          	LD	A,14
EEF2                
EEF2                DISK:
EEF2 32 09 EF       	LD	(DMAPAT+1),A
EEF5                DISK1:
EEF5 78             	LD	A,B
EEF6 32 E7 EE       	LD	(FDCNT+1),A
EEF9 22 61 EF       	LD	(DMAD+11),HL
EEFC                DISKR:
EEFC 3E 02          	LD	A,2		;Retry count
EEFE 32 D6 EE       	LD	(RETRY),A
EF01                DISK2:
EF01 D5             	PUSH	DE
EF02 CD 13 EE       	CALL	SEEK
EF05 38 43          	JR	C,ERRF
EF07 F3             	DI
EF08                
EF08 3E 0E          DMAPAT:	LD	A,14		;自己書き換え
EF0A 21 56 EF       	LD	HL,DMAD
EF0D CD 8F DF       	CALL	SETDMA
EF10 ED 49          	OUT	(C),C		;OUT 01F87H,087H WR6 イネーブル
EF12 3A 74 EE       	LD	A,(FDCPAT+1)
EF15 C5             	PUSH	BC
EF16 CD B8 EE       	CALL	SECSET
EF19 2A 61 EF       	LD	HL,(DMAHL)
EF1C 23             	INC	HL
EF1D 11 06 BB       	LD	DE,0BB06H	;READ DMA
EF20                
EF20 3E 03          	LD	A,3
EF22 CD 8F EE       	CALL	READY
EF25 ED 78          	IN	A,(C)
EF27                
EF27 C1             	POP	BC
EF28 ED 51          	OUT	(C),D		;読み出しマスク設定
EF2A ED 59          	OUT	(C),E		;バイトカウンタ(LH)
EF2C ED 58          	IN	E,(C)
EF2E ED 50          	IN	D,(C)
EF30 19             	ADD	HL,DE
EF31 D1             	POP	DE
EF32 13             	INC	DE
EF33 FB             	EI
EF34 CD AC EE       	CALL	FDMOFF
EF37 B7             	OR	A
EF38 28 AC          	JR	Z,DISKOK
EF3A 1B             	DEC	DE
EF3B CB 67          	BIT	4,A
EF3D C4 D0 EE       	CALL	NZ,RNF
EF40                DISKE2:
EF40 21 D6 EE       	LD	HL,RETRY
EF43 35             	DEC	(HL)
EF44 20 BB          	JR	NZ,DISK2
EF46 B7             	OR	A
EF47 28 0A          	JR	Z,ERR
EF49 D5             	PUSH	DE
EF4A                ERRF:
EF4A D1             	POP	DE
EF4B                DELP:
EF4B CD D0 EE       	CALL	RNF
EF4E CD AC EE       	CALL	FDMOFF
EF51 3E FF          	LD	A,0FFH
EF53                ERR:
EF53 BF             	CP	A
EF54 37             	SCF
EF55 C9             	RET
EF56                
EF56                			;X1turbo DISK DMA
EF56 C3             DMAD:	DB	0C3H	;WR6 リセット
EF57 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
EF58 FB 0F          	DW	00FFBH	;ポートA開始アドレス FDC データレジスタ
EF5A FF FF          	DW	0FFFFH	;ブロック長(転送サイズ-1)
EF5C 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
EF5D 10             	DB	010H	;WR2 ポートBインクリメント
EF5E 80             	DB	080H	;WR3
EF5F 92             	DB	092H	;WR5 WAIT RDY:LOW
EF60 8D             	DB	08DH	;WR4 バイト ポートB開始アドレス(LH)
EF61 00 00          DMAHL:	DW	0	;ポートB開始アドレス
EF63 CF             	DB	0CFH	;WR6 ロード
EF64 01             	DB	001H	;WR0 ポートB←ポートB 転送
EF65 CF             	DB	0CFH	;WR6 ロード
EF66                
EF66                DMAE:
EF66                
EF66 00 00 1E 36    AT_R	EQU	WTTRK-AT_DWT
EF66                AT_TABLE:
EF66                	INCLUDE	"LDCCPWK.ASM"
EF66                
EF66                ;	LSX-Dodgers CCP WORK
EF66                
EF66 00 00 00 40    PATHX	EQU	64
EF66                PATHD:	DS	PATHX
EFA6 00             PATHE:	DB	0
EFA7                
EFA7                DTA_CCP:
EFA7                	DS	37
EFCC                
EFCC                FCB_BAT:
EFCC                	DS	37
EFF1                
EFF1                
EFF1 20 62 79 74    FREE:	DB	" bytes free",9,'$'
EFF5 65 73 20 66
EFF9 72 65 65 09
EFFD 24
EFFE                	INCLUDE	"LDWORK.ASM"
EFFE                
EFFE                ;	LSX-Dodgers WORK0
EFFE                ;
EFFE                ;	CP/M互換BIOS
EFFE                ;	BOOT:アドレス下位1バイトが0になるように
EFFE                AT_WORK:
EFFE                	DS	WORKAD-AT_WORK
F000                
F000                CPM_BOOT:
F000 C3 00 00       	JP	0
F003                _SYS00:		;(BDOS)プログラム終了
F003                CPM_WBOOT:
F003 C3 09 D2       	JP	WBOOT1
F006                CPM_CONST:
F006 C3 39 DC       	JP	CONSTX
F009                _SYS07:		;(BDOS)コンソール直接入力
F009                CPM_CONIN:
F009 C3 E0 DB       	JP	FLGET
F00C                CPM_CONOUT:
F00C C3 80 DE       	JP	CONOUT1
F00F                
F00F                DECBF:
F00F                	DS	5
F014 00             FDRV	DB	0
F015                FNAME	DS	36
F039                SFILE:	DS	33		;DRV FILENAME
F05A                HLBUF:	DS	3		;Random record buffer
F05D                
F05D 00 00          LEFTX:	DW	0
F05F 00 00          DTAX:	DW	0
F061                
F061                ZERO:
F061                BEEPD:
F061 00 8E 01 00    	DB	0,08EH,1,0,00BH,0,00CH,010H
F065 0B 00 0C 10
F069 07 3E 08 10    	DB	007H,03EH,008H,010H,00DH,0,0FFH
F06D 0D 00 FF
F070 00 00 F0 62    RTC_YY	EQU	BEEPD+1
F070 00 00 F0 63    RTC_MW	EQU	BEEPD+2
F070 00 00 F0 64    RTC_DD	EQU	BEEPD+3
F070 00 00 F0 65    RTC_TT	EQU	BEEPD+4
F070 00 00 F0 66    RTC_MM	EQU	BEEPD+5
F070 00 00 F0 67    RTC_SS	EQU	BEEPD+6
F070                
F070 00             CHECK:	DB	0
F071                
F071 4F 4B 24       OK:	DB	"OK$"
F074                	DS	5
F079 45 72 72 6F    COMERM:	DB	"Error!$"
F07D 72 21 24
F080                ;	システムワークエリア
F080                ;	_CYL0:アドレス下位1バイトが080Hになるように
F080 FF             _CYL0:	DB	0FFH	;Cylinder
F081 FF             _CYL1:	DB	0FFH	;Cylinder
F082 FF             _CYL2:	DB	0FFH	;Cylinder
F083 FF             _CYL3:	DB	0FFH	;Cylinder
F084 00             _DRIVE:	DB	0	;unit number
F085 00             _SEEKSP:DB	0	;Seek speed
F086 FF             _ISEEK:	DB	0FFH	;
F087 00             _DVSW:	DB	0
F088 00             _DRV:	DB	0
F089 FF             _DSK:	DB	0FFH
F08A 80 00          _DTA:	DW	00080H
F08C 00 00          _CTC:	DW	0
F08E 00 00          _TXADR:	DW	0
F090 00 00          _KEYPS:	DW	0
F092 00 FF          _KEYD:	DW	0FF00H	;キーデータ
F094 C2 10          _KEYSP:	DB	KEYSP_L,KEYSP_H	;オートリピートの速度
F096 07             _COLORF:DB	COLORF	;色
F097 18             _LINE:	DB	LINE
F098                
F098 00 00          _FCB:	DW	0	;SEARCH FILES
F09A 00 00          _FBPS:	DW	0	;    //
F09C 00 00          _FBAD:	DW	0	;    //
F09E 00             _FBCNT:	DB	0	;    //
F09F 00             _FILEN:	DB	0	;    //
F0A0 00             _DIRF:	DB	0	;bit7:ディレクトリ bit0-6:セクタインデックス
F0A1                	DS	1
F0A2 00             _WTFATF:DB	0	;FATバッファの更新フラグ
F0A3                	DS	1
F0A4 00             _WTDBF:	DB	0	;データバッファの更新フラグ
F0A5 FF             _DBDRV:	DB	0FFH	;データバッファにあるデータを読み込んだドライブ
F0A6 00 00          _DBSEC:	DW	0	;データバッファにあるデータを読み込んだセクタ番号
F0A8 00 00          _DPB:	DW	0
F0AA                _FATDRV:
F0AA FF             	DB	0FFH	;FATバッファに読み込んでいるドライブ
F0AB 00             _FATIX:	DB	0	;FATバッファに読み込んでいるインデックス
F0AC                _FAKEFREE:
F0AC 00 00          	DW	0	;偽の残量（FATサイズが大きくなると重くなるのでその対策）
F0AE                
F0AE                	DS	2
F0B0                
F0B0                CRTCD:
F0B0 6F             	DB	06FH
F0B1                _WIDTH:
F0B1 50             	DB	WIDTH
F0B2                TVRAMTOP:
F0B2 59 38          	DB	059H,038H
F0B4 1F 02          	DB	01FH,002H
F0B6                _LINE2:
F0B6 19             	DB	019H
F0B7                WKE4:
F0B7 1C             	DB	01CH
F0B8                WKE6:
F0B8 00             	DB	000H
F0B9                WK40:
F0B9 07             	DB	007H
F0BA                _PAGE_MINUS:
F0BA 80 F8          	DW	0-WIDTH*LINE
F0BC                _WIDTH_MINUS:
F0BC B0 FF          	DW	0-WIDTH
F0BE                WK30:
F0BE 0C             	DB	00CH
F0BF                WK31:
F0BF                WK1FD0:
F0BF 20             	DB	020H
F0C0                
F0C0 22 DB          CTC0:	DW	INTCTCE
F0C2 22 DB          CTC1:	DW	INTCTCE
F0C4 2A DB          CTC2:	DW	INTCTC2
F0C6 22 DB          CTC3:	DW	INTCTCE
F0C8 05 DB          INTVEC:	DW	INT
F0CA                
F0CA                ;	LSX-Dodgers 独自BIOS
F0CA                
F0CA C3 65 E0       _INKEY:	JP	INKEY
F0CD C3 07 DD       _PRINT:	JP	PRINT
F0D0 C3 CD DF       _SCRN:	JP	SCRN
F0D3 C3 F7 DF       _POS:	JP	POS
F0D6 C3 49 DE       _LOC:	JP	LOC
F0D9                _CHGDRV:
F0D9 C3 0F ED       	JP	CHGDRV
F0DC                _GETDPB:
F0DC C3 DA ED       	JP	GETDPB
F0DF                _FFLUSH:
F0DF C3 F8 ED       	JP	FFLUSH
F0E2                _RDFATX:
F0E2 C3 E8 E9       	JP	RDFATX
F0E5 C3 10 EB       _RDFAT:	JP	RDFAT
F0E8 C3 D7 EE       _WTTRK:	JP	WTTRK
F0EB C3 EB EE       _FDRD:	JP	FDRD
F0EE C3 DD EE       _FDWT:	JP	FDWT
F0F1                _BPB2DPB:
F0F1 C3 9D EB       	JP	BPB2DPB
F0F4                _BREAK:
F0F4 C3 C2 D3       	JP	END_BATCH
F0F7                _GNCL:
F0F7 C3 8A EA       GNCPAT:	JP	GNCL		; self-modifying code
F0FA                _SNCL:
F0FA C3 AD EA       SNCPAT:	JP	SNCL		; self-modifying code
F0FD C3 7C D2       _COMANL:JP	COMANL
F100                
F100                _WE:
F100                	INCLUDE	"LDCALL.ASM"
F100                
F100                ;	LSX-Dodgers システムコール(BDOS)
F100                ;
F100                ;	LSX-Dodgers SYSTEM CALL
F100                ;	STABLE:アドレス下位1バイトが0になるように
F100                
F100                STABLE:
F100                ;0
F100 03 F0 B3 DB    	DW	_SYS00,_SYS01,_SYS02,_SYS03
F104 BF DB 1B E2
F108 5F D8 5F D8    	DW	_SYS04,_SYS05,_SYS06,_SYS07
F10C C4 DB 09 F0
F110 CC DB 61 D8    	DW	_SYS08,_SYS09,_SYS0A,_SYS0B
F114 05 DC 31 DC
F118 76 D8 7B D8    	DW	_SYS0C,_SYS0D,_SYS0E,_SYS0F
F11C 8A D8 9B D8
F120                ;1
F120 EF D8 36 D9    	DW	_SYS10,_SYS11,_SYS12,_SYS13
F124 7F D9 B5 D9
F128 BD D9 D3 D9    	DW	_SYS14,_SYS15,_SYS16,_SYS17
F12C E8 D9 E0 D9
F130 2F DA 34 DA    	DW	_SYS18,_SYS19,_SYS1A,_SYS1B
F134 39 DA 3F DA
F138 5F D8 65 DA    	DW	_SYS1C,_SYS1D,_SYS1E,_SYS1F
F13C 5F D8 69 DA
F140                ;2
F140 5F D8 1F DA    	DW	_SYS20,_SYS21,_SYS22,_SYS23
F144 27 DA 70 DA
F148 96 DA 5F D8    	DW	_SYS24,_ERROR,_SYS26,_SYS27
F14C A3 E6 88 E7
F150 27 DA 9F DA    	DW	_SYS28,_SYS5C,_SYS2A,_SYS2B
F154 47 DC 1B E2
F158 6A DC 1B E2    	DW	_SYS2C,_SYS2D,_SYS2E,_SYS2F
F15C 5F D8 C2 DA
F160                ;3
F160 BC DA 5F D8    	DW	_SYS30,_ERROR,_ERROR,_ERROR
F164 5F D8 5F D8
F168 5F D8 5F D8    	DW	_ERROR,_ERROR,_ERROR,_ERROR
F16C 5F D8 5F D8
F170 5F D8 1B E2    	DW	_ERROR,_SYS39,_SYS3A,_SYS5A
F174 1B E2 E3 DA
F178                ;DOS2
F178 42 D8          	DW	_DOS2
F17A                
F17A                	DS	2
F17C 00 F3          _FATBF:	DW	FATBF
F17E 00 FB          _DTBUF:	DW	DTBUF
F180                
F180                ;	コントロールコードテーブル
F180                ;	CTRLTB:アドレス下位1バイトが080Hになるように
F180                
F180                CTRLTB:
F180 BE DD BE DD    	DW	CTRL00,CTRL00,CTRL02,CTRL03	;  A,B,C
F184 FA DD 41 DF
F188 3B DF 1E DE    	DW	CTRL04,CTRL05,CTRL06,CTRL07	;D,E,F,G
F18C 1A DF A1 DE
F190 CA DD EB DD    	DW	CTRL08,CTRL09,CTRL0A,CTRL0B	;H,I,J,K
F194 44 DF 5F DE
F198 17 DF 44 DE    	DW	CTRL0C,CTRL0D,CTRL0E,CTRL00	;L,M,N,O
F19C 59 DF BE DD
F1A0 BE DD BE DD    	DW	CTRL00,CTRL00,CTRL12,CTRL00	;P,Q,R,S
F1A4 57 DE BE DD
F1A8 BE DD BE DD    	DW	CTRL00,CTRL00,CTRL00,CTRL00	;T,U,V,W
F1AC BE DD BE DD
F1B0 BE DD BE DD    	DW	CTRL00,CTRL00,CTRL0C,CTRL1B	;X,Y,Z,ESC
F1B4 17 DF 66 DE
F1B8 E5 DD D1 DD    	DW	CTRL1C,CTRL1D,CTRL1E,CTRL1F	;→,←,↑,↓
F1BC DA DD 44 DF
F1C0                
F1C0 02 00          M2D:	DW	2
F1C2 FD 02          	DB	0FDH,2
F1C4 64 01          	DW	356
F1C6 FF 07 28 09    	DB	0FFH,7,40,9,1,082H
F1CA 01 82
F1CC 05 00 A7 00    	DW	5,0A7H,8
F1D0 08 00
F1D2                
F1D2 02 00          M2HD:	DW	2
F1D4 FE 01          	DB	0FEH,1
F1D6 C7 04          	DW	1223
F1D8 FE 06 4D 08    	DB	0FEH,6,77,8,1,084H
F1DC 01 84
F1DE 05 00 A7 00    	DW	5,0A7H,9
F1E2 09 00
F1E4                
F1E4                	DS	6
F1EA                
F1EA 16 17          SDDATA:	DB	22,23		;(FCB)ファイルを最後に変更した時刻
F1EC 14 15          	DB	20,21		;(FCB)ファイルを最後に変更した日付
F1EE 1A 1B          	DB	26,27		;(FCB)ファイルの先頭クラスタ
F1F0 10 11 12 13    	DB	16,17,18,19	;(FCB)ファイルのサイズ(バイト単位)
F1F4                SDDATAE:
F1F4                
F1F4                SCDIR:	DS	2		;+14 +15
F1F6                SFBPS:	DS	2		;FBPS
F1F8                SFNDF:	DS	2		;FILEN DIRF
F1FA                
F1FA 00 00          _FATPS:	DW	0
F1FC 00 00          _DIRPS:	DW	0
F1FE 00 00          _CLPS:	DW	0
F200                
F200                _PE:
F200                	INCLUDE	"X1DPB.ASM"
F200                
F200                ;	LSX-Dodgers DPB
F200                ;	X1/turbo/Z
F200                
F200                DEVICE:
F200                
F200                ;	A:
F200                
F200 02 00          	DW	2	;DPB_00_FATLN
F202 EB F0          	DW	_FDRD	;DPB_02_DRD
F204 EE F0          	DW	_FDWT	;DPB_04_DWT
F206 FD             	DB	0FDH	;DPB_06_FATID
F207 02             	DB	2	;DPB_07_SECPCL
F208 64 01          	DW	356	;DPB_08_MAXCL
F20A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F20B 07             	DB	7	;DPB_0B_DIRSCNT
F20C 28             	DB	40	;DPB_0C_MAXCYL
F20D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F20E 01             	DB	1	;DPB_0E_FATPS
F20F 82             	DB	082H	;DPB_0F_BPS
F210 05 00          	DW	5	;DPB_10_DIRPS
F212 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F213 00             	DB	0	;DPB_13_UNITNO
F214 08 00          	DW	8	;DPB_14_ADDCL16
F216 00 00          	DW	0	;DPB_16
F218 00 00          	DW	0	;DPB_18
F21A 00 00          	DW	0	;DPB_1A_SDIR
F21C 46 44 44 30    	DB	"FDD0"	;DPB_1C_NAME
F220                
F220                ;	B:
F220                
F220 02 00          	DW	2	;DPB_00_FATLN
F222 EB F0          	DW	_FDRD	;DPB_02_DRD
F224 EE F0          	DW	_FDWT	;DPB_04_DWT
F226 FD             	DB	0FDH	;DPB_06_FATID
F227 02             	DB	2	;DPB_07_SECPCL
F228 64 01          	DW	356	;DPB_08_MAXCL
F22A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F22B 07             	DB	7	;DPB_0B_DIRSCNT
F22C 28             	DB	40	;DPB_0C_MAXCYL
F22D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F22E 01             	DB	1	;DPB_0E_FATPS
F22F 82             	DB	082H	;DPB_0F_BPS
F230 05 00          	DW	5	;DPB_10_DIRPS
F232 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F233 01             	DB	1	;DPB_13_UNITNO
F234 08 00          	DW	8	;DPB_14_ADDCL16
F236 00 00          	DW	0	;DPB_16
F238 00 00          	DW	0	;DPB_18
F23A 00 00          	DW	0	;DPB_1A_SDIR
F23C 46 44 44 31    	DB	"FDD1"	;DPB_1C_NAME
F240                
F240                ;	C:
F240                
F240 02 00          	DW	2	;DPB_00_FATLN
F242 EB F0          	DW	_FDRD	;DPB_02_DRD
F244 EE F0          	DW	_FDWT	;DPB_04_DWT
F246 FD             	DB	0FDH	;DPB_06_FATID
F247 02             	DB	2	;DPB_07_SECPCL
F248 64 01          	DW	356	;DPB_08_MAXCL
F24A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F24B 07             	DB	7	;DPB_0B_DIRSCNT
F24C 28             	DB	40	;DPB_0C_MAXCYL
F24D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F24E 01             	DB	1	;DPB_0E_FATPS
F24F 82             	DB	082H	;DPB_0F_BPS
F250 05 00          	DW	5	;DPB_10_DIRPS
F252 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F253 02             	DB	2	;DPB_13_UNITNO
F254 08 00          	DW	8	;DPB_14_ADDCL16
F256 00 00          	DW	0	;DPB_16
F258 00 00          	DW	0	;DPB_18
F25A 00 00          	DW	0	;DPB_1A_SDIR
F25C 46 44 44 32    	DB	"FDD2"	;DPB_1C_NAME
F260                
F260                ;	D:
F260                
F260 02 00          	DW	2	;DPB_00_FATLN
F262 EB F0          	DW	_FDRD	;DPB_02_DRD
F264 EE F0          	DW	_FDWT	;DPB_04_DWT
F266 FD             	DB	0FDH	;DPB_06_FATID
F267 02             	DB	2	;DPB_07_SECPCL
F268 64 01          	DW	356	;DPB_08_MAXCL
F26A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F26B 07             	DB	7	;DPB_0B_DIRSCNT
F26C 28             	DB	40	;DPB_0C_MAXCYL
F26D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F26E 01             	DB	1	;DPB_0E_FATPS
F26F 82             	DB	082H	;DPB_0F_BPS
F270 05 00          	DW	5	;DPB_10_DIRPS
F272 A7             	DB	0A7H	;DPB_12_DEVICE
F273 03             	DB	3	;DPB_13_UNITNO
F274 08 00          	DW	8	;DPB_14_ADDCL16
F276 00 00          	DW	0	;DPB_16
F278 00 00          	DW	0	;DPB_18
F27A 00 00          	DW	0	;DPB_1A_SDIR
F27C 46 44 44 33    	DB	"FDD3"	;DPB_1C_NAME
F280                
F280                ;	E:
F280                
F280 00 00          EMMFL:	DW	0	;DPB_00_FATLN
F282 E8 D7          EMMRD:	DW	EDRD	;DPB_02_DRD
F284 E4 D7          EMMWR:	DW	EDWT	;DPB_04_DWT
F286 FE             	DB	0FEH	;DPB_06_FATID
F287 02             	DB	2	;DPB_07_SECPCL
F288 00 00          EMMCL:	DW	0	;DPB_08_MAXCL
F28A 00             	DB	0	;DPB_0A_FDMODE
F28B 0C             	DB	12	;DPB_0B_DIRSCNT
F28C 00             	DB	0	;DPB_0C_MAXCYL
F28D 00             	DB	0	;DPB_0D_MAXSEC
F28E 02             	DB	2	;DPB_0E_FATPS
F28F 02             	DB	2	;DPB_0F_BPS
F290 0A 00          	DW	10	;DPB_10_DIRPS
F292 06             EMMDV:	DB	6	;DPB_12_DEVICE
F293 00             	DB	0	;DPB_13_UNITNO
F294 12 00          	DW	18	;DPB_14_ADDCL16
F296 00 00          	DW	0	;DPB_16
F298 00 00          	DW	0	;DPB_18
F29A 00 00          	DW	0	;DPB_1A_SDIR
F29C 45 4D 4D 30    	DB	"EMM0"	;DPB_1C_NAME
F2A0                
F2A0                ;	F:
F2A0                
F2A0 00 00          BANKFL:	DW	0	;DPB_00_FATLN
F2A2 7C D7          	DW	BDRD	;DPB_02_DRD
F2A4 78 D7          	DW	BDWT	;DPB_04_DWT
F2A6 F9             	DB	0F9H	;DPB_06_FATID
F2A7 02             	DB	2	;DPB_07_SECPCL
F2A8 00 00          BANKCL:	DW	0	;DPB_08_MAXCL
F2AA 00             	DB	0	;DPB_0A_FDMODE
F2AB 08             	DB	8	;DPB_0B_DIRSCNT
F2AC 00             	DB	0	;DPB_0C_MAXCYL
F2AD 01             	DB	1	;DPB_0D_MAXSEC
F2AE 00             	DB	0	;DPB_0E_FATPS
F2AF 02             	DB	2	;DPB_0F_BPS
F2B0 02 00          	DW	2	;DPB_10_DIRPS
F2B2 0B             BANKDV:	DB	00BH	;DPB_12_DEVICE
F2B3 00             	DB	0	;DPB_13_UNITNO
F2B4 06 00          	DW	6	;DPB_14_ADDCL16
F2B6 00 00          	DW	0	;DPB_16
F2B8 00 00          	DW	0	;DPB_18
F2BA 00 00          	DW	0	;DPB_1A_SDIR
F2BC 42 52 41 4D    	DB	"BRAM"	;DPB_1C_NAME
F2C0                
F2C0                ;	G:
F2C0                
F2C0 02 00          	DW	2	;DPB_00_FATLN
F2C2 39 D7          	DW	GDRD	;DPB_02_DRD
F2C4 50 D7          	DW	GDWT	;DPB_04_DWT
F2C6 FA             	DB	0FAH	;DPB_06_FATID
F2C7 01             	DB	1	;DPB_07_SECPCL
F2C8 B8 00          	DW	184	;DPB_08_MAXCL
F2CA 00             	DB	0	;DPB_0A_FDMODE
F2CB 07             	DB	7	;DPB_0B_DIRSCNT
F2CC 00             	DB	0	;DPB_0C_MAXCYL
F2CD 01             	DB	1	;DPB_0D_MAXSEC
F2CE 01             	DB	1	;DPB_0E_FATPS
F2CF 01             	DB	1	;DPB_0F_BPS
F2D0 03 00          	DW	3	;DPB_10_DIRPS
F2D2 05             	DB	5	;DPB_12_DEVICE
F2D3 01             	DB	1	;DPB_13_UNITNO
F2D4 08 00          	DW	8	;DPB_14_ADDCL16
F2D6 00 00          	DW	0	;DPB_16
F2D8 00 00          	DW	0	;DPB_18
F2DA 00 00          	DW	0	;DPB_1A_SDIR
F2DC 47 52 41 4D    	DB	"GRAM"	;DPB_1C_NAME
F2E0                
F2E0                ;	H:
F2E0                	DS	32-8
F2F8 00             	DB	0
F2F9                
F2F9                LAST_ADR:
F2F9                
F2F9                	END
F2F9                
