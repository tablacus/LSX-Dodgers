                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for X1/turbo/Z
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "X1DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   X1/turbo/Z
                                
       0000                     MAC EQU 0       ;X1
       0000                     DEV EQU 0
                                
       011D                     VER_6F  EQU 0011DH
                                
       D100                     RUN EQU 0D100H
       D0F9                     OFFSET  EQU RUN-7
                                
       D706                     BDOS    EQU 0D706H
       EE00                     WORKAD  EQU 0EE00H
       F700                     FATBF   EQU 0F700H
       FD00                     DTBUF   EQU 0FD00H
       FF00                     KEYBF   EQU 0FF00H
       FF20                     KBUF    EQU 0FF20H
       FFCA                     EXTSP   EQU 0FFCAH
       FFD9                     TRAP38  EQU 0FFD9H
       0050                     WIDTH   EQU 80
       0018                     LINE    EQU 24
       0007                     COLORF  EQU 7
       0014                     KEYSP_H EQU 20
       00C2                     KEYSP_L EQU 0C2H
       0008                     COMS    EQU 8
       0002                     MAX_SEC_SZ_H    EQU 2       ;1セクタ1024バイトのサポート(2:off 4:on)
       0100                     BUFFER  EQU 00100H
       D814                     S27BUF_COM  EQU S27BUF
[EOF:X1DEF.ASM:UTF_8]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0002                     VER_3   EQU 2
       1D00                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0000                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0162                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 D0F9                         ORG RUN-7
                                
                                ;   MSX BINARY HEADER
000000 D0F9 FE                      DB  0FEH
                                ;   MSX BINARY START ADDRESS
000001 D0FA 00D1                    DW  RUN
                                ;   MSX BINARY END ADDRESS
000003 D0FC F9F6                    DW  LAST_ADR
                                ;   MSX BINARY EXEC ADDRESS
000005 D0FE 07D1                    DW  START
                                
                                    INCLUDE "X1INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   X1/turbo/Z
                                
000007 D100 C307D1          10      JP  START
00000A D103 001D                    DW  MACW
00000C D105 6201                    DW  VER
                                
       D107                     START:
00000E D107 F3               4      DI
00000F D108 ED5E             8      IM  2
000011 D10A 31CAFF          10      LD  SP,EXTSP
000014 D10D CD58D1          17      CALL    INIT        ;NZならAUTOEXECを実行
000017 D110 210000          10      LD  HL,0
00001A D113 E5              11      PUSH    HL
00001B D114 F5              11      PUSH    AF
                                                ;2HD等1セクタ1024バイトで起動時(Japan2HD)
00001C D115 3A0CFE          13      LD  A,(0FE0CH)
00001F D118 FE04             7      CP  4
000021 D11A 201B            12      JR  NZ,NOT_2HD2014
000023 D11C 2A0600          16      LD  HL,(00006H)
000026 D11F 5D               4      LD  E,L
000027 D120 54               4      LD  D,H
000028 D121 15               4      DEC D
000029 D122 15               4      DEC D
00002A D123 15               4      DEC D
00002B D124 15               4      DEC D
00002C D125 ED530600        20      LD  (00006H),DE
000030 D129 010300          10      LD  BC,3
000033 D12C EDB0                    LDIR
000035 D12E 3E04             7      LD  A,4
000037 D130 327BEF          13      LD  (_MAX_SEC_SZ_H),A
00003A D133 ED537EEF        20      LD  (_DTBUF),DE
       D137                     NOT_2HD2014:
00003E D137 3A0400          13      LD  A,(_DVSW)
000041 D13A CDDCEE          17      CALL    _GETDPB
000044 D13D 380A            12      JR  C,INIT1
000046 D13F 3A0400          13      LD  A,(_DVSW)
000049 D142 C641             7      ADD A,'A'
00004B D144 32AAD4          13      LD  (AUTODV),A
00004E D147 1807            12      JR  INIT2
       D149                     INIT1:
000050 D149 1E00             7      LD  E,0
000052 D14B 0E0E             7      LD  C,00EH
000054 D14D CD0500          17      CALL    SYSTEM
       D150                     INIT2:
000057 D150 F1              10      POP AF
000058 D151 C8              11      RET Z
000059 D152 11A1D4          10      LD  DE,AUTOD
00005C D155 C3FDEE          10      JP  _COMANL
                                
       D158                     INIT:
00005F D158 01031A          10      LD  BC,1A03H
000062 D15B 3E82             7      LD  A,82H
000064 D15D ED79            12      OUT (C),A
000066 D15F 3E1E             7      LD  A,01EH
000068 D161 D300            11      OUT (0),A
                                
00006A D163 010000          10      LD  BC,0
00006D D166 ED438CEE        20      LD  (_CTC),BC
000071 D16A 01040A          10      LD  BC,00A04H
000074 D16D CD4BD4          17      CALL    CHKCTC
000077 D170 010407          10      LD  BC,00704H
00007A D173 CD4BD4          17      CALL    CHKCTC
00007D D176 01A81F          10      LD  BC,01FA8H
000080 D179 CD4BD4          17      CALL    CHKCTC
000083 D17C 01A01F          10      LD  BC,01FA0H
000086 D17F CD4BD4          17      CALL    CHKCTC
                                
       D182                     INISIO:
000089 D182 01911F          10      LD  BC,01F91H   ;INIT SIO
00008C D185 1601             7      LD  D,1
00008E D187 ED51            12      OUT (C),D
                                
000090 D189 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
000092 D18B 0E93             7      LD  C,093H
000094 D18D ED51            12      OUT (C),D
000096 D18F ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
000098 D191 0E99             7      LD  C,099H      ;INIT SIO
00009A D193 1601             7      LD  D,1
00009C D195 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
00009E D197 0E9B             7      LD  C,09BH
0000A0 D199 ED51            12      OUT (C),D
0000A2 D19B ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
0000A4 D19D 0E80             7      LD  C,080H      ;INIT DMA
0000A6 D19F 2106C3          10      LD  HL,0C306H
       D1A2                     INIDMA:
0000A9 D1A2 ED61            12      OUT (C),H
0000AB D1A4 2D               4      DEC L
0000AC D1A5 20FB            12      JR  NZ,INIDMA
                                
0000AE D1A7 3EE4             7      LD  A,0E4H
0000B0 D1A9 CD13E3          17      CALL    COMOUT
0000B3 D1AC AF               4      XOR A
0000B4 D1AD CDEDE2          17      CALL    OT49SB
                                
0000B7 D1B0 3EEE             7      LD  A,INTVEC/256
0000B9 D1B2 ED47             9      LD  I,A
                                
0000BB D1B4 ED4B8CEE        20      LD  BC,(_CTC)
0000BF D1B8 0D               4      DEC C
0000C0 D1B9 0D               4      DEC C
                                
0000C1 D1BA ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
0000C3 D1BC 3EC0             7      LD  A,CTC0-CPM_BOOT
0000C5 D1BE ED79            12      OUT (C),A
                                
0000C7 D1C0 0C               4      INC C
0000C8 D1C1 3E47             7      LD  A,047H
0000CA D1C3 ED79            12      OUT (C),A
0000CC D1C5 3E0D             7      LD  A,13        ;Baudrate 9600-13
0000CE D1C7 ED79            12      OUT (C),A
                                
0000D0 D1C9 79               4      LD  A,C
0000D1 D1CA D610             7      SUB 010H
0000D3 D1CC 4F               4      LD  C,A
                                ;   LD  (SIOAD+1),BC
                                ;   LD  (SIOAD0+1),BC
                                ;   LD  (SIOAD1+1),BC
                                
0000D4 D1CD 21F1D4          10      LD  HL,SIODATA
       D1D0                     SINIT1:
0000D7 D1D0 7E               7      LD  A,(HL)
0000D8 D1D1 23               6      INC HL
0000D9 D1D2 FEFF             7      CP  0FFH
0000DB D1D4 2804            12      JR  Z,SINIT2
0000DD D1D6 ED79            12      OUT (C),A
0000DF D1D8 18F6            12      JR  SINIT1
       D1DA                     SINIT2:
0000E1 D1DA 3EE4             7      LD  A,0E4H
0000E3 D1DC CD13E3          17      CALL    COMOUT
0000E6 D1DF 3EC8             7      LD  A,INTVEC-CPM_BOOT
0000E8 D1E1 CDEDE2          17      CALL    OT49SB
                                ;
0000EB D1E4 01C41F          10      LD  BC,01FC4H
0000EE D1E7 3E0C             7      LD  A,00CH
0000F0 D1E9 ED79            12      OUT (C),A
                                
0000F2 D1EB 0EC0             7      LD  C,0C0H
0000F4 D1ED ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
0000F6 D1EF 0C               4      INC C
0000F7 D1F0 3E28             7      LD  A,40
0000F9 D1F2 ED79            12      OUT (C),A
                                
0000FB D1F4 0C               4      INC C
0000FC D1F5 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
0000FE D1F7 0C               4      INC C
0000FF D1F8 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
000101 D1FA 0EC5             7      LD  C,0C5H
000103 D1FC ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
       D1FE                     TEXT:
000105 D1FE 0EB0             7      LD  C,0B0H
000107 D200 3E80             7      LD  A,080H
000109 D202 ED79            12      OUT (C),A
00010B D204 1607             7      LD  D,7
00010D D206 0EB9             7      LD  C,0B9H
00010F D208 21EAD4          10      LD  HL,TEXTDT
       D20B                     TEXT1:
000112 D20B 04               4      INC B
000113 D20C EDA3            16      OUTI
000115 D20E 0C               4      INC C
000116 D20F 15               4      DEC D
000117 D210 20F9            12      JR  NZ,TEXT1
000119 D212 01B01F          10      LD  BC,01FB0H
00011C D215 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
00011E D217 0EC4             7      LD  C,0C4H
000120 D219 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
000122 D21B 01011A          10      LD  BC,01A01H
000125 D21E ED78            12      IN  A,(C)
000127 D220 E608             7      AND 8
000129 D222 2809            12      JR  Z,PRN
00012B D224 0E03             7      LD  C,003H
00012D D226 3E0F             7      LD  A,00FH
00012F D228 ED79            12      OUT (C),A
000131 D22A 01040A          10      LD  BC,00A04H
       D22D                     PRN:
000134 D22D 210000          10      LD  HL,0
000137 D230 065C             7      LD  B,05CH
000139 D232 3E                      DB  03EH    ;LD A,??
00013A D233 FF              12      RST 38H
00013B D234 CDB6F0          17      CALL    FILL_MEMORY
00013E D237 06A4             7      LD  B,0A4H
000140 D239 AF               4      XOR A
000141 D23A CDB6F0          17      CALL    FILL_MEMORY
                                
000144 D23D 3A87FF          13      LD  A,(0FF87H)  ;起動ドライブ
000147 D240 E66F             7      AND 06FH
000149 D242 FE08             7      CP  8
00014B D244 3801            12      JR  C,INIDRV
00014D D246 AF               4      XOR A
       D247                     INIDRV:
00014E D247 320400          13      LD  (_DVSW),A   ;カレントドライブ
                                
000151 D24A 3EC3             7      LD  A,0C3H      ;JP
000153 D24C 2103EE          10      LD  HL,CPM_WBOOT
000156 D24F 320000          13      LD  (00000H),A
000159 D252 220100          16      LD  (00001H),HL ;IPL
                                
00015C D255 2106D7          10      LD  HL,BDOS
00015F D258 320500          13      LD  (00005H),A
000162 D25B 220600          16      LD  (00006H),HL ;BDOS
                                
000165 D25E 2130DF          10      LD  HL,BIOS
000168 D261 221900          16      LD  (00019H),HL ;BIOS-ROM
                                
00016B D264 21D9FF          10      LD  HL,TRAP38   ;TRAP38
00016E D267 323800          13      LD  (00038H),A
000171 D26A 223900          16      LD  (00039H),HL ;RST 038H
                                
000174 D26D 3EEE             7      LD  A,CPM_BOOT/256
000176 D26F 320B00          13      LD  (0000BH),A
                                
000179 D272 3E                      DB  03EH    ;LD A,??
00017A D273 E9               4      JP  (HL)
00017B D274 320F00          13      LD  (0000FH),A
                                                ;KEY
00017E D277 3EE6             7      LD  A,0E6H      ;キーデータ読み出し
000180 D279 CD13E3          17      CALL    COMOUT
000183 D27C CDF8E2          17      CALL    IN49SB
000186 D27F F5              11      PUSH    AF
000187 D280 CDF8E2          17      CALL    IN49SB
00018A D283 F1              10      POP AF
00018B D284 F5              11      PUSH    AF
00018C D285 E612             7      AND 012H
00018E D287 2005            12      JR  NZ,KEYR
000190 D289 3E01             7      LD  A,1
000192 D28B 32E5D3          13      LD  (KEYREP_SWC),A
       D28E                     KEYR:
000195 D28E F1              10      POP AF
000196 D28F E603             7      AND 3
000198 D291 280E            12      JR  Z,NON
                                
00019A D293 01D03F          10      LD  BC,03FD0H
00019D D296 ED49            12      OUT (C),C
00019F D298 3E37             7      LD  A,037H
0001A1 D29A D3D0            11      OUT (0D0H),A
0001A3 D29C ED78            12      IN  A,(C)
0001A5 D29E B9               4      CP  C
0001A6 D29F 2851            12      JR  Z,TURBO
       D2A1                     NON:
0001A8 D2A1 2124D5          10      LD  HL,AT_SCR1
0001AB D2A4 119DE3          10      LD  DE,SCR1
0001AE D2A7 019400          10      LD  BC,SCRNE-SCR1   ;転送先のサイズ確認用
0001B1 D2AA 018500          10      LD  BC,AT_SCRE-AT_SCR1
0001B4 D2AD EDB0                    LDIR
                                
0001B6 D2AF 21A9D5          10      LD  HL,AT_DWT
0001B9 D2B2 11DFEC          10      LD  DE,WTTRK
0001BC D2B5 018900          10      LD  BC,DMAE-WTTRK   ;転送先のサイズ確認用
0001BF D2B8 018800          10      LD  BC,AT_CPUE-AT_DWT
0001C2 D2BB EDB0                    LDIR
                                
0001C4 D2BD 2118E4          10      LD  HL,AT_WTTRK+AT_RS
0001C7 D2C0 22E9EE          16      LD  (_WTTRK+1),HL
0001CA D2C3 2125ED          10      LD  HL,AT_DRD+AT_R
0001CD D2C6 22ECEE          16      LD  (_FDRD+1),HL
0001D0 D2C9 21DFEC          10      LD  HL,AT_DWT+AT_R
0001D3 D2CC 22EFEE          16      LD  (_FDWT+1),HL
0001D6 D2CF 211FE4          10      LD  HL,AT_SCRN+AT_RS
0001D9 D2D2 22D1EE          16      LD  (_SCRN+1),HL
                                                        ;ノンターボは2D/2HD切り替えを行わない
0001DC D2D5 DD2100F6        14      LD  IX,_DEVICE
0001E0 D2D9 DDCB12BE        23      RES 7,(IX+DPB_DEVICE)       ;Aドライブ
0001E4 D2DD DDCB32BE        23      RES 7,(IX+DPB_DEVICE+32)        ;Bドライブ
0001E8 D2E1 DDCB52BE        23      RES 7,(IX+DPB_DEVICE+32*2)      ;Cドライブ
0001EC D2E5 DDCB72BE        23      RES 7,(IX+DPB_DEVICE+32*3)      ;Dドライブ
                                
0001F0 D2E9 210000          10      LD  HL,0
0001F3 D2EC 223EE3          16      LD  (X1PAT),HL
0001F6 D2EF C379D3          10      JP  NOBANK
                                
       D2F2                     TURBO:
0001F9 D2F2 F3               4      DI          ;Check BIOS
0001FA D2F3 061D             7      LD  B,01DH
0001FC D2F5 ED79            12      OUT (C),A       ;BIOS ON
0001FE D2F7 3A512F          13      LD  A,(02F51H)
000201 D2FA 04               4      INC B       ;B=01EH
000202 D2FB ED79            12      OUT (C),A       ;BIOS OFF
000204 D2FD FB               4      EI
000205 D2FE FEC9             7      CP  0C9H
000207 D300 2802            12      JR  Z,BIOSOK
000209 D302 1805            12      JR  NOBIOS
       D304                     BIOSOK:
00020B D304 3EC3             7      LD  A,0C3H      ;JP
00020D D306 321800          13      LD  (00018H),A
       D309                     NOBIOS:
000210 D309 3E1F             7      LD  A,01FH      ;スタートポート
000212 D30B DBF0            11      IN  A,(0F0H)
000214 D30D 0F               4      RRCA
000215 D30E 380B            12      JR  C,CRT1
000217 D310 21DAD4          10      LD  HL,_C8025H
00021A D313 11B0EE          10      LD  DE,CRTCD
00021D D316 011000          10      LD  BC,16
000220 D319 EDB0                    LDIR
       D31B                     CRT1:
000222 D31B 3A8CFF          13      LD  A,(0FF8CH)  ;IPL DEVICE (0:2D/1:2DD/2:2HD)
000225 D31E D602             7      SUB 2
000227 D320 2017            12      JR  NZ,BANK
                                
                                ;   XOR A       ;すでに0のハズ
       D322                     TZ1:                ;DPBのモードを2HDにしておく
000229 D322 F5              11      PUSH    AF
00022A D323 CDDCEE          17      CALL    _GETDPB
00022D D326 DD7E12          19      LD  A,(IX+DPB_DEVICE)
000230 D329 E68F             7      AND 08FH
000232 D32B FE87             7      CP  087H        ;フロッピーで切り替えがON
000234 D32D 2004            12      JR  NZ,TZ2
000236 D32F DDCB0A86        23      RES 0,(IX+DPB_FDMODE)
       D333                     TZ2:
00023A D333 F1              10      POP AF
00023B D334 3C               4      INC A
00023C D335 FE08             7      CP  8
00023E D337 38E9            12      JR  C,TZ1
                                
       D339                     BANK:
000240 D339 01000B          10      LD  BC,00B00H
000243 D33C 21007F          10      LD  HL,07F00H
000246 D33F F3               4      DI
000247 D340 ED69            12      OUT (C),L
000249 D342 3A0000          13      LD  A,(0)
00024C D345 FEEB             7      CP  0EBH
00024E D347 2005            12      JR  NZ,BANK1
000250 D349 3E2B             7      LD  A,02BH
000252 D34B 32B2F6          13      LD  (BANKDV),A
       D34E                     BANK1:
000255 D34E ED69            12      OUT (C),L
000257 D350 5E               7      LD  E,(HL)
000258 D351 7B               4      LD  A,E
000259 D352 C6A5             7      ADD A,0A5H
00025B D354 77               7      LD  (HL),A
00025C D355 BE               7      CP  (HL)
00025D D356 73               7      LD  (HL),E
00025E D357 2005            12      JR  NZ,BANK2
000260 D359 2C               4      INC L
000261 D35A CB65             8      BIT 4,L
000263 D35C 28F0            12      JR  Z,BANK1
       D35E                     BANK2:
000265 D35E 3E10             7      LD  A,010H
000267 D360 ED79            12      OUT (C),A
000269 D362 7D               4      LD  A,L
00026A D363 B7               4      OR  A
00026B D364 2813            12      JR  Z,NOBANK
00026D D366 2600             7      LD  H,0
00026F D368 29              11      ADD HL,HL   ;*2
000270 D369 29              11      ADD HL,HL   ;*4
000271 D36A 29              11      ADD HL,HL   ;*8
000272 D36B 29              11      ADD HL,HL   ;*16
000273 D36C 29              11      ADD HL,HL   ;*32
000274 D36D 2B               6      DEC HL  ;-1
000275 D36E 2B               6      DEC HL  ;-2
000276 D36F 2B               6      DEC HL  ;-3
000277 D370 22A8F6          16      LD  (BANKCL),HL
00027A D373 CD91D4          17      CALL    CALC_FATLN
00027D D376 32A0F6          13      LD  (BANKFL),A
       D379                     NOBANK:
       D379                     EMM:
000280 D379 DD2180F6        14      LD  IX,EMMFL
000284 D37D CD3CD4          17      CALL    EADR0
000287 D380 ED78            12      IN  A,(C)
000289 D382 F5              11      PUSH    AF
                                
00028A D383 110000          10      LD  DE,0
       D386                     ECHECK1:
00028D D386 13               6      INC DE
00028E D387 CD45D4          17      CALL    EADRX
000291 D38A ED60            12      IN  H,(C)
000293 D38C CD45D4          17      CALL    EADRX
000296 D38F 7C               4      LD  A,H
000297 D390 C6E5             7      ADD A,0E5H
000299 D392 ED79            12      OUT (C),A
00029B D394 3C               4      INC A
00029C D395 CD3CD4          17      CALL    EADR0
00029F D398 ED79            12      OUT (C),A
0002A1 D39A 3D               4      DEC A
0002A2 D39B CD45D4          17      CALL    EADRX
0002A5 D39E ED68            12      IN  L,(C)
0002A7 D3A0 CD45D4          17      CALL    EADRX
0002AA D3A3 ED61            12      OUT (C),H
0002AC D3A5 BD               4      CP  L
0002AD D3A6 2004            12      JR  NZ,ECHECK2
0002AF D3A8 CB5A             8      BIT 3,D
0002B1 D3AA 28DA            12      JR  Z,ECHECK1
       D3AC                     ECHECK2:
0002B3 D3AC CD3CD4          17      CALL    EADR0
0002B6 D3AF F1              10      POP AF
0002B7 D3B0 ED79            12      OUT (C),A
0002B9 D3B2 FEEB             7      CP  0EBH
0002BB D3B4 2817            12      JR  Z,EMM_BPB
0002BD D3B6 DD360D02        19      LD  (IX+DPB_MAXSEC),2   ;BPBが512バイト目から始まる場合を調べる
0002C1 D3BA CD3CD4          17      CALL    EADR0
0002C4 D3BD ED78            12      IN  A,(C)
0002C6 D3BF DDBE06          19      CP  (IX+DPB_FATID)
0002C9 D3C2 280D            12      JR  Z,EMM_NOBPB
0002CB D3C4 DD361226        19      LD  (IX+DPB_DEVICE),026H    ;BPBを使う
0002CF D3C8 21F5FF          10      LD  HL,0-11
0002D2 D3CB 180B            12      JR  EMM_BPB1
       D3CD                     EMM_BPB:
0002D4 D3CD DD361226        19      LD  (IX+DPB_DEVICE),026H    ;BPBを使う
       D3D1                     EMM_NOBPB:
0002D8 D3D1 DD360D00        19      LD  (IX+DPB_MAXSEC),0
0002DC D3D5 21F7FF          10      LD  HL,0-9
       D3D8                     EMM_BPB1:
0002DF D3D8 19              11      ADD HL,DE
0002E0 D3D9 3009            12      JR  NC,NOEMM
0002E2 D3DB 2288F6          16      LD  (EMMCL),HL
0002E5 D3DE CD91D4          17      CALL    CALC_FATLN
0002E8 D3E1 3280F6          13      LD  (EMMFL),A
       D3E4                     NOEMM:
0002EB D3E4 3E00             7      LD  A,000H
       D3E5                     KEYREP_SWC  EQU $-1
0002ED D3E6 B7               4      OR  A
0002EE D3E7 2807            12      JR  Z,KEYR1
0002F0 D3E9 010000          10      LD  BC,0
0002F3 D3EC ED438CEE        20      LD  (_CTC),BC
       D3F0                     KEYR1:
0002F7 D3F0 CD72D4          17      CALL    SETCRTC
0002FA D3F3 0130F8          10      LD  BC,0-80*25
0002FD D3F6 2ABAEE          16      LD  HL,(_PAGE_MINUS)
000300 D3F9 ED43BAEE        20      LD  (_PAGE_MINUS),BC
000304 D3FD 1E0C             7      LD  E,00CH
000306 D3FF CDCDEE          17      CALL    _PRINT
000309 D402 22BAEE          16      LD  (_PAGE_MINUS),HL
                                
00030C D405 21ADD4          10      LD  HL,INIMES
00030F D408 CDA3DC          17      CALL    MSX
                                
000312 D40B F3               4      DI
000313 D40C 2EFE             7      LD  L,0-2       ;CALLのスタック分減らす
000315 D40E 39              11      ADD HL,SP
000316 D40F 1100FF          10      LD  DE,0FF00H
000319 D412 45               4      LD  B,L
00031A D413 CD56DA          17      CALL    ZERO_MEMORY_DE
00031D D416 21CAFF          10      LD  HL,EXTBIO
000320 D419 36C9            10      LD  (HL),0C9H   ;RET
000322 D41B 23               6      INC HL
000323 D41C 060E             7      LD  B,TRAP38-EXTBIO-1
000325 D41E 3E                      DB  03EH    ;LD A,??
000326 D41F FF              12      RST 38H
000327 D420 CDB6F0          17      CALL    FILL_MEMORY
00032A D423 21FDD4          10      LD  HL,AT_TRAP38
00032D D426 11D9FF          10      LD  DE,TRAP38
000330 D429 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
000333 D42C EDB0                    LDIR
                                
000335 D42E 3EE6             7      LD  A,0E6H      ;キーデータ読み出し
000337 D430 CD13E3          17      CALL    COMOUT
00033A D433 CDF8E2          17      CALL    IN49SB
00033D D436 CDF8E2          17      CALL    IN49SB
000340 D439 FE1B             7      CP  01BH
000342 D43B C9              10      RET
                                
       D43C                     EADR0:
000343 D43C D5              11      PUSH    DE
000344 D43D 110000          10      LD  DE,0
000347 D440 CD45D4          17      CALL    EADRX
00034A D443 D1              10      POP DE
00034B D444 C9              10      RET
                                
       D445                     EADRX:
00034C D445 F5              11      PUSH    AF
00034D D446 CD45DC          17      CALL    EADR
000350 D449 F1              10      POP AF
000351 D44A C9              10      RET
                                
       D44B                     CHKCTC:
000352 D44B C5              11      PUSH    BC
000353 D44C 110347          10      LD  DE,04703H
       D44F                     INICTC1:
000356 D44F 0C               4      INC C
000357 D450 ED51            12      OUT (C),D
000359 D452 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
00035B D454 1D               4      DEC E
00035C D455 20F8            12      JR  NZ,INICTC1
00035E D457 C1              10      POP BC
                                
00035F D458 11FA07          10      LD  DE,007FAH
000362 D45B ED51            12      OUT (C),D
000364 D45D ED59            12      OUT (C),E
000366 D45F ED78            12      IN  A,(C)
000368 D461 BB               4      CP  E
000369 D462 C0              11      RET NZ
00036A D463 ED51            12      OUT (C),D
00036C D465 ED51            12      OUT (C),D
00036E D467 ED78            12      IN  A,(C)
000370 D469 BA               4      CP  D
000371 D46A C0              11      RET NZ
000372 D46B 0C               4      INC C
000373 D46C 0C               4      INC C
000374 D46D ED438CEE        20      LD  (_CTC),BC
000378 D471 C9              10      RET
                                
       D472                     SETCRTC:
000379 D472 21B0EE          10      LD  HL,CRTCD
00037C D475 AF               4      XOR A
       D476                     SETCRT1:
00037D D476 010018          10      LD  BC,01800H
000380 D479 ED79            12      OUT (C),A
000382 D47B 0C               4      INC C
000383 D47C 04               4      INC B
000384 D47D EDA3            16      OUTI
000386 D47F 3C               4      INC A
000387 D480 FE0C             7      CP  12
000389 D482 20F2            12      JR  NZ,SETCRT1
00038B D484 23               6      INC HL
00038C D485 23               6      INC HL
00038D D486 01031B          10      LD  BC,01A03H+00100H
000390 D489 EDA3            16      OUTI
000392 D48B 01D020          10      LD  BC,01FD0H+00100H
000395 D48E EDA3            16      OUTI
000397 D490 C9              10      RET
                                
       D491                     CALC_FATLN: ;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
000398 D491 5D               4      LD  E,L
000399 D492 54               4      LD  D,H
00039A D493 29              11      ADD HL,HL   ;*2
00039B D494 19              11      ADD HL,DE   ;*3
00039C D495 CB3C             8      SRL H   ;/2
00039E D497 CB1D             8      RR  L   ;1クラスタ辺り1.5バイト必要
0003A0 D499 11FF01          10      LD  DE,511  ;切り上げる
0003A3 D49C 19              11      ADD HL,DE
0003A4 D49D 7C               4      LD  A,H
0003A5 D49E CB3F             8      SRL A
0003A7 D4A0 C9              10      RET
                                
0003A8 D4A1 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
0003B1 D4AA 413A00              AUTODV: DB  "A:",0
                                
0003B4 D4AD 4C53582D446F6467    INIMES: DB  "LSX-Dodgers for X1/turbo version "
            65727320666F7220    
            58312F747572626F    
            2076657273696F6E    
            20                  
0003D5 D4CE 312E                    DB  030H + VER_1, '.'
0003D7 D4D0 3632                    DB  030H + VER_2 ,030H + VER_3
0003D9 D4D2                         DB  ''
0003D9 D4D2 2047616B750D0A          DB  " Gaku",0DH,0AH
0003E0 D4D9 00                      DB  0
                                
       D4DA                     _C8025H:
0003E1 D4DA 6B5059881B00191A        DB  06BH,050H,059H,088H,01BH,000H,019H,01AH
0003E9 D4E2 000F                    DB  000H,00FH
0003EB D4E4 80F8B0FF                DW  0-80*LINE,0-80
0003EF D4E8 0C23                    DB  00CH,023H
                                
0003F1 D4EA 030C0F30333C3F      TEXTDT: DB  003H,00CH,00FH,030H,033H,03CH,03FH
                                
       D4F1                     SIODATA:
0003F8 D4F1 18                      DB  018H
0003F9 D4F2 0100                    DB  1,0
0003FB D4F4 0200                    DB  2,0
0003FD D4F6 03C1                    DB  3,0C1H
0003FF D4F8 0444                    DB  4,044H
000401 D4FA 05E8                    DB  5,0E8H
000403 D4FC FF                      DB  0FFH
                                
       D4FD                     AT_TRAP38:
000404 D4FD 210000          10      LD  HL,0
000407 D500 E3              19      EX  (SP),HL
000408 D501 3E24             7      LD  A,'$'
00040A D503 CDC1DF          17      CALL    MSG_A
00040D D506 2B               6      DEC HL
00040E D507 7C               4      LD  A,H
00040F D508 CDE8FF          17      CALL    PRHX+AT_RT
000412 D50B 7D               4      LD  A,L
       D50C                     PRHX:
000413 D50C F5              11      PUSH    AF
000414 D50D 07               4      RLCA
000415 D50E 07               4      RLCA
000416 D50F 07               4      RLCA
000417 D510 07               4      RLCA
000418 D511 CDF1FF          17      CALL    PRHX2+AT_RT
00041B D514 F1              10      POP AF
       D515                     PRHX2:
00041C D515 E60F             7      AND 00FH
00041E D517 FE0A             7      CP  10
000420 D519 3F               4      CCF
000421 D51A CE30             7      ADC A,'0'
000423 D51C 27               4      DAA
000424 D51D C3C1DF          10      JP  MSG_A
000427 D520                         DS  4
       D524                     AT_TRAPE:
[EOF:X1INIT.ASM:SHIFT_JIS]
                                    INCLUDE "X1CPU.ASM"
                                
                                ;   LSX-Dodgers CPU
                                ;   X1/turbo/Z
                                
                                ;   ノンターボ用パッチ
                                ;   DMAを使って転送している部分をCPUに差し替える
                                
       D524                     AT_SCR1:
00042B D524 D9               4      EXX
00042C D525 C5              11      PUSH    BC
00042D D526 ED4BB1EE        20      LD  BC,(_WIDTH)
000431 D52A 0620             7      LD  B,020H
000433 D52C D9               4      EXX
000434 D52D C5              11      PUSH    BC
000435 D52E 010020          10      LD  BC,02000H
                                
000438 D531 67               4      LD  H,A
000439 D532 B7               4      OR  A
       D533                     AT_SCRUP1:
00043A D533 2815            12      JR  Z,AT_SCRCL
00043C D535 C5              11      PUSH    BC
00043D D536 CBE0             8      SET 4,B
00043F D538 D9               4      EXX
000440 D539 C5              11      PUSH    BC
000441 D53A CBE0             8      SET 4,B
000443 D53C D9               4      EXX
000444 D53D CDCEE3          17      CALL    AT_UPSUB+AT_RS
000447 D540 D9               4      EXX
000448 D541 C1              10      POP BC
000449 D542 D9               4      EXX
00044A D543 C1              10      POP BC
00044B D544 CDCEE3          17      CALL    AT_UPSUB+AT_RS
00044E D547 25               4      DEC H
00044F D548 18E9            12      JR  AT_SCRUP1
                                
       D54A                     AT_SCRCL:
000451 D54A 2AB1EE          16      LD  HL,(_WIDTH)
000454 D54D CD66E2          17      CALL    LINECL
000457 D550 C1              10      POP BC
000458 D551 D9               4      EXX
000459 D552 C1              10      POP BC
00045A D553 D9               4      EXX
00045B D554 C9              10      RET
                                
       D555                     AT_UPSUB:
00045C D555 3AB1EE          13      LD  A,(_WIDTH)
00045F D558 6F               4      LD  L,A
       D559                     AT_UPSUB1:
000460 D559 D9               4      EXX
000461 D55A ED78            12      IN  A,(C)
000463 D55C 03               6      INC BC
000464 D55D D9               4      EXX
000465 D55E ED79            12      OUT (C),A
000467 D560 03               6      INC BC
000468 D561 2D               4      DEC L
000469 D562 20F5            12      JR  NZ,AT_UPSUB1
00046B D564 C9              10      RET
                                
                                ;   FLOPPY DISK DRIVER(CPU)
                                
       D565                     DISKC:
00046C D565 1B               6      DEC DE
00046D D566 CB5F             8      BIT 3,A
00046F D568 C4D8EC          17      CALL    NZ,RNF
       D56B                     DISKD:
000472 D56B E5              11      PUSH    HL
000473 D56C 21DEEC          10      LD  HL,RETRY
000476 D56F 35              11      DEC (HL)
000477 D570 E1              10      POP HL
000478 D571 200C            12      JR  NZ,AT_ERR       ;Retry
00047A D573 B7               4      OR  A
00047B D574 2809            12      JR  Z,AT_ERR        ;Error
                                
       D576                     AT_DELP:
00047D D576 CDD8EC          17      CALL    RNF
000480 D579 CDB0EC          17      CALL    FDMOFF
000483 D57C 3EFF             7      LD  A,0FFH
       D57E                     AT_ERRZ:
000485 D57E BF               4      CP  A
       D57F                     AT_ERR:
000486 D57F 3EFF             7      LD  A,0FFH
000488 D581 C9              10      RET
       D582                     ERRW:
000489 D582 3EFF             7      LD  A,0FFH
00048B D584 BF               4      CP  A
00048C D585 37               4      SCF
00048D D586 C3B0EC          10      JP  FDMOFF
                                
       D589                     ERRDW:
000490 D589 D1              10      POP DE
000491 D58A CDEFE3          17      CALL    AT_DELP+AT_RS
000494 D58D C2EDEC          10      JP  NZ,DWT0+AT_R
000497 D590 B7               4      OR  A
000498 D591 20EF            12      JR  NZ,ERRW
00049A D593 C9              10      RET
                                
       D594                     ERRDR:
00049B D594 D1              10      POP DE
00049C D595 CDEFE3          17      CALL    AT_DELP+AT_RS
00049F D598 C233ED          10      JP  NZ,DRD0+AT_R
0004A2 D59B B7               4      OR  A
0004A3 D59C 20E4            12      JR  NZ,ERRW
0004A5 D59E C9              10      RET
                                
       D59F                     AT_WTTRK:
0004A6 D59F 0601             7      LD  B,1
0004A8 D5A1 3EF4             7      LD  A,0F4H      ;FDC TypeIIIコマンド Write Track
0004AA D5A3 C3E1EC          10      JP  AT_WTTRK1+AT_R
                                
       D5A6                     AT_SCRN:
0004AD D5A6 ED78            12      IN  A,(C)
0004AF D5A8 C9              10      RET
       D5A9                     AT_SCRE:
                                
       D5A9                     AT_DWT:
0004B0 D5A9 3EA0             7      LD  A,0A0H      ;FDC TypeIIコマンド Write Sector
       D5AB                     AT_WTTRK1:
0004B2 D5AB 3275EC          13      LD  (FDCSWC),A
       D5AE                     DWTBL:
0004B5 D5AE 78               4      LD  A,B
0004B6 D5AF 3221ED          13      LD  (AT_WTB+1+AT_R),A
0004B9 D5B2 3E02             7      LD  A,2     ;Retry count
0004BB D5B4 32DEEC          13      LD  (RETRY),A
       D5B7                     DWT0:
0004BE D5B7 D5              11      PUSH    DE
0004BF D5B8 E5              11      PUSH    HL
0004C0 D5B9 CD15EC          17      CALL    SEEK        ;Write disk
0004C3 D5BC E1              10      POP HL
0004C4 D5BD DA02E4          10      JP  C,ERRDW+AT_RS
0004C7 D5C0 F3               4      DI
0004C8 D5C1 CDBDEC          17      CALL    SECSET_FDCCMD
0004CB D5C4 0EFB             7      LD  C,0FBH      ;MB8877A データレジスタ
       D5C6                     DWT1:
0004CD D5C6 56               7      LD  D,(HL)
       D5C7                     DWT2:
0004CE D5C7 78               4      LD  A,B
0004CF D5C8 DBF8            11      IN  A,(0F8H)    ;MB8877A ステータス／コマンドレジスタ
0004D1 D5CA 0F               4      RRCA
0004D2 D5CB 3008            12      JR  NC,DWT4
0004D4 D5CD 0F               4      RRCA
0004D5 D5CE 30F7            12      JR  NC,DWT2
       D5D0                     DWT3:
0004D7 D5D0 ED51            12      OUT (C),D
0004D9 D5D2 23               6      INC HL
0004DA D5D3 18F1            12      JR  DWT1
                                
       D5D5                     DWT4:
0004DC D5D5 3D               4      DEC A
0004DD D5D6 28F8            12      JR  Z,DWT3
0004DF D5D8 3C               4      INC A
0004E0 D5D9 FB               4      EI
0004E1 D5DA D1              10      POP DE
0004E2 D5DB 13               6      INC DE
0004E3 D5DC CDB0EC          17      CALL    FDMOFF
0004E6 D5DF 2809            12      JR  Z,DISKOK_WT
0004E8 D5E1 CDDEE3          17      CALL    DISKC+AT_RS
0004EB D5E4 20D1            12      JR  NZ,DWT0
0004ED D5E6 B7               4      OR  A
0004EE D5E7 C2FBE3          10      JP  NZ,ERRW+AT_RS
                                
       D5EA                     DISKOK_WT:
0004F1 D5EA 0601             7  AT_WTB: LD  B,1
0004F3 D5EC 10C0            13      DJNZ    DWTBL
0004F5 D5EE C9              10      RET
                                
       D5EF                     AT_DRD:
0004F6 D5EF 3E80             7      LD  A,080H      ;FDC TypeIIコマンド Read Sector
0004F8 D5F1 3275EC          13      LD  (FDCSWC),A
       D5F4                     DRDBL:
0004FB D5F4 78               4      LD  A,B
0004FC D5F5 3263ED          13      LD  (AT_RDB+1+AT_R),A
0004FF D5F8 3E02             7      LD  A,2     ;Retry count
000501 D5FA 32DEEC          13      LD  (RETRY),A
       D5FD                     DRD0:
000504 D5FD D5              11      PUSH    DE
000505 D5FE E5              11      PUSH    HL
000506 D5FF CD15EC          17      CALL    SEEK        ;Read disk
000509 D602 E1              10      POP HL
00050A D603 DA0DE4          10      JP  C,ERRDR+AT_RS
00050D D606 F3               4      DI
00050E D607 CDBDEC          17      CALL    SECSET_FDCCMD
000511 D60A 0EFB             7      LD  C,0FBH      ;MB8877A データレジスタ
       D60C                     DRD1:
000513 D60C 78               4      LD  A,B
000514 D60D DBF8            11      IN  A,(0F8H)    ;MB8877A ステータス／コマンドレジスタ
000516 D60F 0F               4      RRCA
000517 D610 3008            12      JR  NC,DRD3
000519 D612 0F               4      RRCA
00051A D613 30F7            12      JR  NC,DRD1
00051C D615 EDA2            16      INI
00051E D617 04               4      INC B
00051F D618 18F2            12      JR  DRD1
                                
       D61A                     DRD3:
000521 D61A B7               4      OR  A
000522 D61B FB               4      EI
000523 D61C D1              10      POP DE
000524 D61D 13               6      INC DE
000525 D61E CDB0EC          17      CALL    FDMOFF
000528 D621 2809            12      JR  Z,DISKOK_RD
00052A D623 CDDEE3          17      CALL    DISKC+AT_RS
00052D D626 20D5            12      JR  NZ,DRD0
00052F D628 B7               4      OR  A
000530 D629 C2FBE3          10      JP  NZ,ERRW+AT_RS
                                
       D62C                     DISKOK_RD:
000533 D62C 0601             7  AT_RDB: LD  B,1
000535 D62E 10C4            13      DJNZ    DRDBL
000537 D630 C9              10      RET
                                
       D631                     AT_CPUE:
                                
       2ADC                     AT_RT   EQU TRAP38-AT_TRAP38
                                
       D631                     INITE:
000538 D631                         DS  BDOS-INITE
00060D D706 C363DC          10      JP  BDOS0
[EOF:X1CPU.ASM:SHIFT_JIS]
                                    INCLUDE "X1CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   X1/turbo/Z
                                
       D709                     WBOOT1:
000610 D709 F3               4      DI
000611 D70A ED7B0600        20      LD  SP,(SYSTEM+1)
                                
000615 D70E 3EEE             7      LD  A,INTVEC/256
000617 D710 ED47             9      LD  I,A
                                
000619 D712 3EE4             7      LD  A,0E4H
00061B D714 CD13E3          17      CALL    COMOUT
00061E D717 3EC8             7      LD  A,INTVEC-CPM_BOOT
000620 D719 00               4      NOP         ;必ずBDOS0+13Hが「0」になるようにする
000621 D71A CDEDE2          17      CALL    OT49SB
                                
000624 D71D 21B0EE          10      LD  HL,CRTCD
000627 D720 AF               4      XOR A
       D721                     SETCRT2:
000628 D721 010018          10      LD  BC,01800H
00062B D724 ED79            12      OUT (C),A
00062D D726 0C               4      INC C
00062E D727 56               7      LD  D,(HL)
00062F D728 FE0D             7      CP  13
000631 D72A 3802            12      JR  C,SETCRT3
000633 D72C 1600             7      LD  D,0
       D72E                     SETCRT3:
000635 D72E ED51            12      OUT (C),D
000637 D730 23               6      INC HL
000638 D731 3C               4      INC A
000639 D732 FE0E             7      CP  14
00063B D734 20EB            12      JR  NZ,SETCRT2
                                
00063D D736 01031B          10      LD  BC,01A03H+00100H
000640 D739 EDA3            16      OUTI
000642 D73B 01D020          10      LD  BC,01FD0H+00100H
000645 D73E EDA3            16      OUTI
000647 D740 2192EE          10      LD  HL,_KEYD
00064A D743 7E               7      LD  A,(HL)
00064B D744 3600            10      LD  (HL),0
00064D D746 CDAEDF          17      CALL    KEYBC_IFBREAK
000650 D749 3E04             7      LD  A,4
000652 D74B CDC1DF          17      CALL    MSG_A
[EOF:X1CCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D74E                     COMMAND:
000655 D74E 3AC9ED          13      LD  A,(FCB_BAT)
000658 D751 B7               4      OR  A
000659 D752 C290D8          10      JP  NZ,C_BAT1
00065C D755 CD04D8          17      CALL    SETDTA1
00065F D758 3A0400          13      LD  A,(_DVSW)
000662 D75B C641             7      ADD A,'A'
000664 D75D CDC1DF          17      CALL    MSG_A
000667 D760 3E3E             7      LD  A,'>'
000669 D762 CDC1DF          17      CALL    MSG_A
00066C D765 3E50             7      LD  A,80
00066E D767 12               7      LD  (DE),A
00066F D768 CD42E0          17      CALL    _SYS0A      ;(BDOS)文字列入力
000672 D76B CD85D9          17      CALL    LTNL
       D76E                     COMMAND2:
000675 D76E 118200          10      LD  DE,DTA1+2
000678 D771 CDFDEE          17      CALL    _COMANL
00067B D774 DC27DF          17      CALL    C,SHOW_ERROR
00067E D777 18D5            12      JR  COMMAND
                                
       D779                     COMANL:
000680 D779 CD0BF0          17      CALL    FILE
000683 D77C 3A19EE          13      LD  A,(FNAME+4)
000686 D77F FE20             7      CP  020H
000688 D781 201C            12      JR  NZ,COMB2
00068A D783 D5              11      PUSH    DE
00068B D784 1115EE          10      LD  DE,FNAME
00068E D787 1A               7      LD  A,(DE)
00068F D788 FE20             7      CP  020H
000691 D78A 2844            12      JR  Z,SDVSW
000693 D78C 1B               6      DEC DE
000694 D78D 1A               7      LD  A,(DE)
000695 D78E C6FF             7      ADD A,0FFH
000697 D790 3809            12      JR  C,COMB
000699 D792 13               6      INC DE
                                
00069A D793 2142DB          10      LD  HL,COMTB
00069D D796 0608             7      LD  B,COMS
00069F D798 CD98F2          17      CALL    CPNAME
       D79B                     COMB:
0006A2 D79B D1              10      POP DE
0006A3 D79C D226DF          10      JP  NC,JPHL
       D79F                     COMB2:
0006A6 D79F EB               4      EX  DE,HL
0006A7 D7A0 226DD8          16      LD  (COMSWC),HL
0006AA D7A3 F5              11      PUSH    AF
0006AB D7A4 CD25D8          17      CALL    CEXE4
0006AE D7A7 F1              10      POP AF
0006AF D7A8 2115EE          10      LD  HL,FNAME
0006B2 D7AB 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
0006B5 D7AE 010B00          10      LD  BC,11
0006B8 D7B1 EDB0                    LDIR
0006BA D7B3 1168ED          10      LD  DE,PATHD
       D7B6                     CEX1:
0006BD D7B6 1A               7      LD  A,(DE)
0006BE D7B7 FE20             7      CP  020H
0006C0 D7B9 D8              11      RET C
0006C1 D7BA CD00F0          17      CALL    FILEC
0006C4 D7BD D5              11      PUSH    DE
0006C5 D7BE 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
0006C8 D7C1 1115EE          10      LD  DE,FNAME
0006CB D7C4 010B00          10      LD  BC,11
0006CE D7C7 EDB0                    LDIR
0006D0 D7C9 CD25D8          17      CALL    CEXE4
0006D3 D7CC D1              10      POP DE
0006D4 D7CD 13               6      INC DE
0006D5 D7CE 18E6            12      JR  CEX1
                                
       D7D0                     SDVSW:
0006D7 D7D0 F1              10      POP AF
0006D8 D7D1 3A14EE          13      LD  A,(FDRV)
0006DB D7D4 3D               4      DEC A
0006DC D7D5 5F               4      LD  E,A
0006DD D7D6 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
0006DF D7D8 1831            12      JR  SYSTEM0
                                
       D7DA                     OPEN1:
0006E1 D7DA 2114EE          10      LD  HL,FDRV
       D7DD                     OPEN:
0006E4 D7DD 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D7DF                     OPEN3:
0006E6 D7DF D5              11      PUSH    DE
0006E7 D7E0 11A4ED          10      LD  DE,DTA_CCP
0006EA D7E3 CD01D8          17      CALL    SETDTA
0006ED D7E6 EB               4      EX  DE,HL
0006EE D7E7 CD0BD8          17      CALL    SYSTEM0
0006F1 D7EA D1              10      POP DE
0006F2 D7EB C9              10      RET
                                
       D7EC                     OPEN2:
0006F3 D7EC 0E12             7      LD  C,012H
0006F5 D7EE 18EF            12      JR  OPEN3
                                
       D7F0                     DEFCB:              ;Z=Ok NZ=Error
0006F7 D7F0 11A4ED          10      LD  DE,DTA_CCP
0006FA D7F3 CD09D8          17      CALL    SYSC0F
                                
0006FD D7F6 11C5ED          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
000700 D7F9 0604             7      LD  B,4
000702 D7FB CD56DA          17      CALL    ZERO_MEMORY_DE
       D7FE                     SETDTA100:
000705 D7FE 110001          10      LD  DE,BUFFER
       D801                     SETDTA:
000708 D801 C367DE          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D804                     SETDTA1:
00070B D804 118000          10      LD  DE,DTA1
00070E D807 18F8            12      JR  SETDTA
                                
       D809                     SYSC0F:
000710 D809 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D80B                     SYSTEM0:
000712 D80B CD0500          17      CALL    SYSTEM
000715 D80E B7               4      OR  A
000716 D80F C9              10      RET
                                
       D810                     C_CD:
000717 D810 0E5A             7      LD  C,05AH
000719 D812 18F7            12      JR  SYSTEM0
                                
       D814                     S27BUF:
00071B D814 2100FE          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       D817                     S27BUF2:
00071E D817 39              11      ADD HL,SP
00071F D818 2E00             7      LD  L,0
000721 D81A 7C               4      LD  A,H
000722 D81B E6F8             7      AND 0F8H
000724 D81D 67               4      LD  H,A
       D81E                     S27DTA:
000725 D81E 11A4ED          10      LD  DE,DTA_CCP
       D821                     S27:
000728 D821 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
00072A D823 18E6            12      JR  SYSTEM0
                                
       D825                     CEXE4:
00072C D825 211DEE          10      LD  HL,FNAME+8
00072F D828 7E               7      LD  A,(HL)
000730 D829 FE20             7      CP  020H
000732 D82B 2007            12      JR  NZ,CEXE7
000734 D82D 3E3F             7      LD  A,'?'
000736 D82F 77               7      LD  (HL),A
000737 D830 23               6      INC HL
000738 D831 77               7      LD  (HL),A
000739 D832 23               6      INC HL
00073A D833 77               7      LD  (HL),A
       D834                     CEXE7:
00073B D834 CDDAD7          17      CALL    OPEN1
       D837                     CEXE5:
00073E D837 C0              11      RET NZ
00073F D838 2AAEED          16      LD  HL,(DTA_CCP+1+9)
000742 D83B 7C               4      LD  A,H
000743 D83C CD27F3          17      CALL    CAP
000746 D83F 67               4      LD  H,A
000747 D840 7D               4      LD  A,L
000748 D841 CD27F3          17      CALL    CAP
00074B D844 6F               4      LD  L,A
00074C D845 3AADED          13      LD  A,(DTA_CCP+1+8)
00074F D848 CD27F3          17      CALL    CAP
000752 D84B D642             7      SUB 'B'
000754 D84D 282C            12      JR  Z,C_BAT
000756 D84F 3D               4      DEC A       ;'C'
000757 D850 2805            12      JR  Z,C_EXE
       D852                     CEXE6:
000759 D852 CDECD7          17      CALL    OPEN2
00075C D855 18E0            12      JR  CEXE5
                                
       D857                     C_EXE:
00075E D857 7C               4      LD  A,H
00075F D858 FE4D             7      CP  'M'
000761 D85A 20F6            12      JR  NZ,CEXE6
                                
000763 D85C CDF0D7          17      CALL    DEFCB
000766 D85F CD14D8          17      CALL    S27BUF_COM
000769 D862 3D               4      DEC A
00076A D863 37               4      SCF
00076B D864 C0              11      RET NZ
00076C D865 7C               4      LD  A,H
00076D D866 B5               4      OR  L
00076E D867 37               4      SCF
00076F D868 C8              11      RET Z
000770 D869 CD04D8          17      CALL    SETDTA1
000773 D86C 110000          10      LD  DE,0                ; self-modifying code
       D86D                     COMSWC  EQU $-2
000776 D86F ED7B0600        20      LD  SP,(SYSTEM+1)
00077A D873 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
00077B D874 6F               4      LD  L,A
00077C D875 E5              11      PUSH    HL              ; push $0000 (reboot address)
00077D D876 24               4      INC H
00077E D877 E5              11      PUSH    HL              ; push $0100 (TPA address)
00077F D878 C321DA          10      JP  SETFCB              ; and JP $0100
                                
       D87B                     C_BAT:
000782 D87B 114154          10      LD  DE,'A'+'T'*256
000785 D87E ED52            15      SBC HL,DE
000787 D880 20D0            12      JR  NZ,CEXE6
                                
000789 D882 CDF0D7          17      CALL    DEFCB
                                
00078C D885 21A4ED          10      LD  HL,DTA_CCP
00078F D888 11C9ED          10      LD  DE,FCB_BAT
000792 D88B 012500          10      LD  BC,37
000795 D88E EDB0                    LDIR
       D890                     C_BAT1:
000797 D890 CDFED7          17      CALL    SETDTA100
00079A D893 CDC7D8          17      CALL    FGETC_BAT
00079D D896 218100          10      LD  HL,DTA1+1
0007A0 D899 2025            12      JR  NZ,END_BATCH
0007A2 D89B FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
0007A4 D89D 38F1            12      JR  C,C_BAT1
0007A6 D89F 3620            10      LD  (HL),' '
0007A8 D8A1 23               6      INC HL
       D8A2                     C_BAT2:
0007A9 D8A2 77               7      LD  (HL),A
0007AA D8A3 23               6      INC HL
0007AB D8A4 7D               4      LD  A,L
0007AC D8A5 3C               4      INC A       ;L==0FFH
0007AD D8A6 2809            12      JR  Z,RUN_BATCH
0007AF D8A8 CDC7D8          17      CALL    FGETC_BAT
0007B2 D8AB 2004            12      JR  NZ,RUN_BATCH
0007B4 D8AD FE20             7      CP  020H
0007B6 D8AF 30F1            12      JR  NC,C_BAT2
       D8B1                     RUN_BATCH:
0007B8 D8B1 7D               4      LD  A,L
0007B9 D8B2 D67F             7      SUB DTA1-1
0007BB D8B4 328000          13      LD  (DTA1),A
0007BE D8B7 FE04             7      CP  4
0007C0 D8B9 3805            12      JR  C,END_BATCH
0007C2 D8BB 3600            10      LD  (HL),0
0007C4 D8BD C36ED7          10      JP  COMMAND2
       D8C0                     END_BATCH:
0007C7 D8C0 AF               4      XOR A       ;バッチファイルを閉じる
0007C8 D8C1 32C9ED          13      LD  (FCB_BAT),A
0007CB D8C4 C300EE          10      JP  CPM_BOOT
                                
       D8C7                     FGETC_BAT:
0007CE D8C7 11C9ED          10      LD  DE,FCB_BAT
       D8CA                     FGETC:              ;1文字ずつ読み込む
0007D1 D8CA E5              11      PUSH    HL      ;Z:成功
0007D2 D8CB 210100          10      LD  HL,1
0007D5 D8CE CD21D8          17      CALL    S27
0007D8 D8D1 E1              10      POP HL
0007D9 D8D2 3A0001          13      LD  A,(BUFFER)
0007DC D8D5 C9              10      RET
                                
       D8D6                     C_DEL:
0007DD D8D6 CD21DA          17      CALL    SETFCB
0007E0 D8D9 CDD7DF          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
0007E3 D8DC 0E13             7      LD  C,013H
0007E5 D8DE 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D8E0                     C_REN:
0007E7 D8E0 CD21DA          17      CALL    SETFCB
0007EA D8E3 3E10             7      LD  A,010H      ;ディレクトリも対象にする
0007EC D8E5 326900          13      LD  (FCB1+13),A ;属性
0007EF D8E8 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D8EA                     CDEL1:
0007F1 D8EA 115C00          10      LD  DE,FCB1
0007F4 D8ED CD0500          17      CALL    SYSTEM
0007F7 D8F0 C6FF             7      ADD A,0FFH
0007F9 D8F2 C9              10      RET
                                
       D8F3                     C_DIR:
0007FA D8F3 CD00F0          17      CALL    FILEC
0007FD D8F6 2115EE          10      LD  HL,FDRV+1
000800 D8F9 CD37DB          17      CALL    CWILD1
000803 D8FC 3EF1             7      LD  A,0F1H
000805 D8FE 3221EE          13      LD  (FDRV+13),A
000808 D901 CDDAD7          17      CALL    OPEN1
       D904                     CDIR1:
00080B D904 B7               4      OR  A
00080C D905 2008            12      JR  NZ,PDSKF
00080E D907 CD52D9          17      CALL    P_NAME
000811 D90A CDECD7          17      CALL    OPEN2
000814 D90D 18F5            12      JR  CDIR1
       D90F                     PDSKF:
000816 D90F 3A14EE          13      LD  A,(FDRV)
000819 D912 5F               4      LD  E,A
00081A D913 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
00081C D915 CD0500          17      CALL    SYSTEM
00081F D918 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
000820 D919 C601             7      ADD A,001H
000822 D91B D8              11      RET C       ;Aが0FFHだった場合
000823 D91C 3E06             7      LD  A,8-2
       D91E                     PDS1:               ;HL=未使用クラスタの総数
000825 D91E 3C               4      INC A
000826 D91F CB19             8      RR  C
000828 D921 30FB            12      JR  NC,PDS1
       D923                     PDS2:               ;B←論理セクタのサイズの上位8ビット
00082A D923 3C               4      INC A
00082B D924 CB18             8      RR  B
00082D D926 30FB            12      JR  NC,PDS2
00082F D928 47               4      LD  B,A
                                
000830 D929 110000          10      LD  DE,0
       D92C                     PDS3:
000833 D92C 29              11      ADD HL,HL
000834 D92D EB               4      EX  DE,HL
000835 D92E ED6A            15      ADC HL,HL
000837 D930 EB               4      EX  DE,HL
000838 D931 10F9            13      DJNZ    PDS3
       D933                     PDSKF1:
00083A D933 CDBFD9          17      CALL    PRDEC_DEHL
00083D D936 11F9ED          10      LD  DE,FREE
000840 D939 CD94DC          17      CALL    _SYS09      ;(BDOS)文字列出力
000843 D93C CDACD9          17      CALL    PUTDRV
000846 D93F 3E5C             7      LD  A,05CH      ;\
000848 D941 CDC1DF          17      CALL    MSG_A
00084B D944 2A22EE          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
00084E D947 AF               4      XOR A
00084F D948 11FEFF          10      LD  DE,0-2
000852 D94B 19              11      ADD HL,DE
000853 D94C 23               6      INC HL
000854 D94D DCBCD9          17      CALL    C,PRDEC_HL
000857 D950 1833            12      JR  LTNL
                                
       D952                     P_NAME:
000859 D952 3AA5ED          13      LD  A,(DTA_CCP+1)
00085C D955 FE2E             7      CP  '.'
00085E D957 C8              11      RET Z
                                
00085F D958 3AB0ED          13      LD  A,(DTA_CCP+1+00BH)
000862 D95B F5              11      PUSH    AF
000863 D95C CB67             8      BIT 4,A
000865 D95E 2808            12      JR  Z,DIR3
000867 D960 11EEED          10      LD  DE,DIRMES
00086A D963 CD94DC          17      CALL    _SYS09      ;(BDOS)文字列出力
00086D D966 180A            12      JR  DIR6
       D968                     DIR3:
00086F D968 ED5BC3ED        20      LD  DE,(DTA_CCP+1+01EH)
000873 D96C 2AC1ED          16      LD  HL,(DTA_CCP+1+01CH)
000876 D96F CDBFD9          17      CALL    PRDEC_DEHL
       D972                     DIR6:
000879 D972 F1              10      POP AF
00087A D973 0F               4      RRCA
00087B D974 9F               4      SBC A,A
00087C D975 E60A             7      AND '*'-020H
00087E D977 C620             7      ADD A,020H
000880 D979 CDC1DF          17      CALL    MSG_A
000883 D97C CDACD9          17      CALL    PUTDRV
000886 D97F 21A5ED          10      LD  HL,DTA_CCP+1
000889 D982 CDFFD9          17      CALL    FPRNT
                                
       D985                     LTNL:
00088C D985 1E03             7      LD  E,3
00088E D987 C3CDEE          10      JP  _PRINT
                                
       D98A                     C_PATH:
000891 D98A CDE1F0          17      CALL    SPCUT
000894 D98D 2168ED          10      LD  HL,PATHD
000897 D990 FE21             7      CP  021H
000899 D992 300C            12      JR  NC,CPATH0
       D994                     CPATHP:
00089B D994 7E               7      LD  A,(HL)
00089C D995 23               6      INC HL
00089D D996 FE20             7      CP  020H
00089F D998 3F               4      CCF
0008A0 D999 30EA            12      JR  NC,LTNL
0008A2 D99B CDC1DF          17      CALL    MSG_A
0008A5 D99E 18F4            12      JR  CPATHP
       D9A0                     CPATH0:
0008A7 D9A0 FE3B             7      CP  ';'
0008A9 D9A2 2001            12      JR  NZ,CPATH1
0008AB D9A4 13               6      INC DE
       D9A5                     CPATH1:
0008AC D9A5 EB               4      EX  DE,HL
0008AD D9A6 013B00          10      LD  BC,PATHX
0008B0 D9A9 EDB0                    LDIR
0008B2 D9AB C9              10      RET
                                
       D9AC                     PUTDRV:
0008B3 D9AC 3A14EE          13      LD  A,(FDRV)
0008B6 D9AF CD14F1          17      CALL    GETDRV1
0008B9 D9B2 C641             7      ADD A,'A'
0008BB D9B4 CDC1DF          17      CALL    MSG_A
0008BE D9B7 3E3A             7      LD  A,':'
       D9B9                     MSG_AR:
0008C0 D9B9 C3C1DF          10      JP  MSG_A
                                
       D9BC                     PRDEC_HL:
0008C3 D9BC AF               4      XOR A
0008C4 D9BD 5F               4      LD  E,A
0008C5 D9BE 57               4      LD  D,A
       D9BF                     PRDEC_DEHL:
0008C6 D9BF D5              11      PUSH    DE
0008C7 D9C0 110FEE          10      LD  DE,DECBF
0008CA D9C3 0605             7      LD  B,5
0008CC D9C5 CD56DA          17      CALL    ZERO_MEMORY_DE  ;A=0
0008CF D9C8 D1              10      POP DE
                                
0008D0 D9C9 0E20             7      LD  C,32
       D9CB                     DEC1:
0008D2 D9CB 29              11      ADD HL,HL
0008D3 D9CC EB               4      EX  DE,HL
0008D4 D9CD ED6A            15      ADC HL,HL
0008D6 D9CF EB               4      EX  DE,HL
0008D7 D9D0 E5              11      PUSH    HL
0008D8 D9D1 2113EE          10      LD  HL,DECBF+4
0008DB D9D4 0605             7      LD  B,5
       D9D6                     DEC2:
0008DD D9D6 7E               7      LD  A,(HL)
0008DE D9D7 8F               4      ADC A,A
0008DF D9D8 27               4      DAA
0008E0 D9D9 77               7      LD  (HL),A
0008E1 D9DA 2B               6      DEC HL
0008E2 D9DB 10F9            13      DJNZ    DEC2
0008E4 D9DD E1              10      POP HL
0008E5 D9DE 0D               4      DEC C
0008E6 D9DF 20EA            12      JR  NZ,DEC1
                                
0008E8 D9E1 210FEE          10      LD  HL,DECBF
0008EB D9E4 3E20             7      LD  A,020H
0008ED D9E6 0604             7      LD  B,4
       D9E8                     DEC3:
0008EF D9E8 CDF5D9          17      CALL    DEC4
0008F2 D9EB CDF5D9          17      CALL    DEC4
0008F5 D9EE 23               6      INC HL
0008F6 D9EF 10F7            13      DJNZ    DEC3
       D9F1                     DECX:
0008F8 D9F1 CDF5D9          17      CALL    DEC4
0008FB D9F4 AF               4      XOR A
       D9F5                     DEC4:
0008FC D9F5 ED6F            18      RLD
0008FE D9F7 FE20             7      CP  020H
000900 D9F9 2802            12      JR  Z,DEC5
000902 D9FB F630             7      OR  030H
       D9FD                     DEC5:
000904 D9FD 18BA            12      JR  MSG_AR
                                
       D9FF                     FPRNT:
000906 D9FF 0608             7      LD  B,8 ;ファイル名を表示
000908 DA01 CD10DA          17      CALL    P_N1
00090B DA04 7E               7      LD  A,(HL)
00090C DA05 CD33F3          17      CALL    CAP3
00090F DA08 D8              11      RET C   ;拡張子が無い
                                
000910 DA09 3E2E             7      LD  A,'.'
000912 DA0B CDC1DF          17      CALL    MSG_A
000915 DA0E 0603             7      LD  B,3 ;拡張子を表示
       DA10                     P_N1:
000917 DA10 7E               7      LD  A,(HL)
000918 DA11 CD33F3          17      CALL    CAP3
00091B DA14 3807            12      JR  C,P_N2
00091D DA16 CDC1DF          17      CALL    MSG_A
000920 DA19 23               6      INC HL
000921 DA1A 10F4            13      DJNZ    P_N1
000923 DA1C C9              10      RET
       DA1D                     P_N2:
000924 DA1D 23               6      INC HL
000925 DA1E 10FD            13      DJNZ    P_N2
000927 DA20 C9              10      RET
                                
       DA21                     SETFCB:
000928 DA21 CDE1F0          17      CALL    SPCUT
00092B DA24 1A               7      LD  A,(DE)
00092C DA25 FE20             7      CP  020H
00092E DA27 3801            12      JR  C,SETFCBA
000930 DA29 1B               6      DEC DE
       DA2A                     SETFCBA:
000931 DA2A 0624             7      LD  B,36
000933 DA2C 215C00          10      LD  HL,FCB1
000936 DA2F E5              11      PUSH    HL
000937 DA30 AF               4      XOR A
000938 DA31 CDB6F0          17      CALL    FILL_MEMORY
00093B DA34 E1              10      POP HL
00093C DA35 D5              11      PUSH    DE
00093D DA36 CDCDDE          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000940 DA39 216C00          10      LD  HL,FCB2
000943 DA3C CDCDDE          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000946 DA3F E1              10      POP HL
000947 DA40 010050          10      LD  BC,05000H
00094A DA43 118100          10      LD  DE,00081H
       DA46                     SETFCB1:
00094D DA46 7E               7      LD  A,(HL)
00094E DA47 23               6      INC HL
00094F DA48 FE20             7      CP  020H
000951 DA4A 3805            12      JR  C,SETFCB2
000953 DA4C 12               7      LD  (DE),A
000954 DA4D 13               6      INC DE
000955 DA4E 0C               4      INC C
000956 DA4F 10F5            13      DJNZ    SETFCB1
       DA51                     SETFCB2:
000958 DA51 79               4      LD  A,C
000959 DA52 328000          13      LD  (DTA1),A
00095C DA55 04               4      INC B
       DA56                     ZERO_MEMORY_DE:
00095D DA56 AF               4      XOR A
       DA57                     FILL_MEMORY_DE:
00095E DA57 12               7      LD  (DE),A
00095F DA58 13               6      INC DE
000960 DA59 10FC            13      DJNZ    FILL_MEMORY_DE
000962 DA5B C9              10      RET
                                
       DA5C                     C_COPY:
000963 DA5C CD21DA          17      CALL    SETFCB
                                
000966 DA5F 1161EE          10      LD  DE,ZERO
000969 DA62 CD03F0          17      CALL    FILEC2
00096C DA65 216C00          10      LD  HL,FCB2
00096F DA68 CDD4DE          17      CALL    S29X1
                                
000972 DA6B 3E10             7      LD  A,010H
000974 DA6D 326900          13      LD  (FCB1+13),A
000977 DA70 216D00          10      LD  HL,FCB2FN
00097A DA73 CD37DB          17      CALL    CWILD1
       DA76                     COPY0:
00097D DA76 CD34DB          17      CALL    CWILD
000980 DA79 215C00          10      LD  HL,FCB1
000983 DA7C CDDDD7          17      CALL    OPEN
000986 DA7F 37               4      SCF
       DA80                     COPY1:
000987 DA80 C0              11      RET NZ
000988 DA81 CDF0D7          17      CALL    DEFCB
                                
00098B DA84 3AB1ED          13      LD  A,(DTA_CCP+13)
00098E DA87 CB67             8      BIT 4,A
000990 DA89 2821            12      JR  Z,COPY1A
                                
000992 DA8B 215D00          10      LD  HL,FCB1FN
000995 DA8E CD46F4          17      CALL    CHKWILD
000998 DA91 3814            12      JR  C,COPY9
                                
00099A DA93 3E20             7      LD  A,020H
00099C DA95 325D00          13      LD  (FCB1FN),A
00099F DA98 2ABEED          16      LD  HL,(DTA_CCP+26)
0009A2 DA9B 23               6      INC HL
0009A3 DA9C 226A00          16      LD  (FCB1+14),HL
0009A6 DA9F 18D5            12      JR  COPY0
                                
       DAA1                     COPY8:
0009A8 DAA1 CD94DC          17      CALL    _SYS09      ;(BDOS)文字列出力
0009AB DAA4 CD85D9          17      CALL    LTNL
       DAA7                     COPY9:
0009AE DAA7 CDECD7          17      CALL    OPEN2
0009B1 DAAA 18D4            12      JR  COPY1
                                
       DAAC                     COPY1A:
0009B3 DAAC 216C00          10      LD  HL,FCB2
0009B6 DAAF 1114EE          10      LD  DE,FDRV
0009B9 DAB2 01A6ED          10      LD  BC,DTA_CCP+2
0009BC DAB5 EDA0            16      LDI
0009BE DAB7 3E0B             7      LD  A,11
       DAB9                     COPY2:
0009C0 DAB9 F5              11      PUSH    AF
0009C1 DABA 7E               7      LD  A,(HL)
0009C2 DABB FE3F             7      CP  '?'
0009C4 DABD 2001            12      JR  NZ,COPY3
0009C6 DABF 0A               7      LD  A,(BC)
       DAC0                     COPY3:
0009C7 DAC0 12               7      LD  (DE),A
0009C8 DAC1 03               6      INC BC
0009C9 DAC2 13               6      INC DE
0009CA DAC3 23               6      INC HL
0009CB DAC4 F1              10      POP AF
0009CC DAC5 3D               4      DEC A
0009CD DAC6 20F1            12      JR  NZ,COPY2
0009CF DAC8 010500          10      LD  BC,16-11
0009D2 DACB EDB0                    LDIR
       DACD                     PUTNAME:
0009D4 DACD 215D00          10      LD  HL,FCB1FN
0009D7 DAD0 CD46F4          17      CALL    CHKWILD
0009DA DAD3 300B            12      JR  NC,PUTN1
0009DC DAD5 2115EE          10      LD  HL,FDRV+1
0009DF DAD8 CDFFD9          17      CALL    FPRNT
0009E2 DADB 3E20             7      LD  A,020H
0009E4 DADD CDC1DF          17      CALL    MSG_A
       DAE0                     PUTN1:
0009E7 DAE0 1114EE          10      LD  DE,FDRV
0009EA DAE3 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
0009EC DAE5 CD0BD8          17      CALL    SYSTEM0
0009EF DAE8 2048            12      JR  NZ,COPYE2
0009F1 DAEA 67               4      LD  H,A     ;A=0
0009F2 DAEB 6F               4      LD  L,A
0009F3 DAEC 2235EE          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0009F6 DAEF 2237EE          16      LD  (FDRV+35),HL
       DAF2                     COPY6:
0009F9 DAF2 CD14D8          17      CALL    S27BUF
0009FC DAF5 47               4      LD  B,A
0009FD DAF6 3C               4      INC A
0009FE DAF7 2831            12      JR  Z,COPYE
000A00 DAF9 7C               4      LD  A,H
000A01 DAFA B5               4      OR  L
000A02 DAFB 280C            12      JR  Z,COPY7
000A04 DAFD 1114EE          10      LD  DE,FDRV
000A07 DB00 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
000A09 DB02 CD0BD8          17      CALL    SYSTEM0
000A0C DB05 2023            12      JR  NZ,COPYE
000A0E DB07 10E9            13      DJNZ    COPY6
       DB09                     COPY7:
000A10 DB09 3AB1ED          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
000A13 DB0C 3221EE          13      LD  (FDRV+13),A
000A16 DB0F 21B8ED          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
000A19 DB12 1128EE          10      LD  DE,FDRV+20
000A1C DB15 010400          10      LD  BC,4
000A1F DB18 EDB0                    LDIR
                                
000A21 DB1A 1114EE          10      LD  DE,FDRV
000A24 DB1D 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
000A26 DB1F CD0BD8          17      CALL    SYSTEM0
000A29 DB22 2006            12      JR  NZ,COPYE
                                
000A2B DB24 1171EE          10      LD  DE,OK
000A2E DB27 C3A1DA          10      JP  COPY8
                                
       DB2A                     COPYE:
000A31 DB2A 1114EE          10      LD  DE,FDRV
000A34 DB2D 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
000A36 DB2F CD0500          17      CALL    SYSTEM
       DB32                     COPYE2:
000A39 DB32 37               4      SCF
000A3A DB33 C9              10      RET
                                
       DB34                     CWILD:
000A3B DB34 215D00          10      LD  HL,FCB1FN
       DB37                     CWILD1:
000A3E DB37 7E               7      LD  A,(HL)
000A3F DB38 FE20             7      CP  020H
000A41 DB3A C0              11      RET NZ
       DB3B                     CWILD2:
000A42 DB3B 3E3F             7      LD  A,'?'
000A44 DB3D 060B             7      LD  B,11
000A46 DB3F C3B6F0          10      JP  FILL_MEMORY
                                
       DB42                     COMTB:
000A49 DB42 44202020                DB  "D   "  ;1
000A4D DB46 F3D8                    DW  C_DIR
000A4F DB48 44495220                DB  "DIR "  ;2
000A53 DB4C F3D8                    DW  C_DIR
000A55 DB4E 434F5059                DB  "COPY"  ;3
000A59 DB52 5CDA                    DW  C_COPY
000A5B DB54 43442020                DB  "CD  "  ;4
000A5F DB58 10D8                    DW  C_CD
000A61 DB5A 44454C20                DB  "DEL "  ;5
000A65 DB5E D6D8                    DW  C_DEL
000A67 DB60 50415448                DB  "PATH"  ;6
000A6B DB64 8AD9                    DW  C_PATH
000A6D DB66 52454E20                DB  "REN "  ;7
000A71 DB6A E0D8                    DW  C_REN
000A73 DB6C 52454D20                DB  "REM "  ;8
000A77 DB70 91DC                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "X1DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   X1/turbo/Z
                                
                                ;   GRAPHIC RAM DISK DRIVER
                                
                                
       DB72                     GDRD:
000A79 DB72 C5              11      PUSH    BC
000A7A DB73 CD9BDB          17      CALL    GADR
000A7D DB76 F1              10      POP AF
       DB77                     GDRD1:
000A7E DB77 EDA2            16      INI
000A80 DB79 04               4      INC B
000A81 DB7A 0C               4      INC C
000A82 DB7B 20FA            12      JR  NZ,GDRD1
000A84 DB7D 04               4      INC B
000A85 DB7E 13               6      INC DE
000A86 DB7F 3D               4      DEC A
000A87 DB80 20F5            12      JR  NZ,GDRD1
       DB82                     GBANK0:
000A89 DB82 3ABFEE          13      LD  A,(WK1FD0)
000A8C DB85 E6EF             7      AND 0EFH        ;BANK0
000A8E DB87 181D            12      JR  S1FD0
                                
       DB89                     GDWT:
000A90 DB89 C5              11      PUSH    BC
000A91 DB8A CD9BDB          17      CALL    GADR
000A94 DB8D F1              10      POP AF
       DB8E                     GDWT1:
000A95 DB8E 04               4      INC B
000A96 DB8F EDA3            16      OUTI
000A98 DB91 0C               4      INC C
000A99 DB92 20FA            12      JR  NZ,GDWT1
000A9B DB94 04               4      INC B
000A9C DB95 13               6      INC DE
000A9D DB96 3D               4      DEC A
000A9E DB97 20F5            12      JR  NZ,GDWT1
000AA0 DB99 18E7            12      JR  GBANK0
                                
       DB9B                     GADR:
000AA2 DB9B 0E00             7      LD  C,0
000AA4 DB9D 7B               4      LD  A,E
000AA5 DB9E C640             7      ADD A,040H
000AA7 DBA0 47               4      LD  B,A
000AA8 DBA1 3ABFEE          13      LD  A,(WK1FD0)
000AAB DBA4 F610             7      OR  010H        ;BANK1
       DBA6                     S1FD0:
000AAD DBA6 C5              11      PUSH    BC
000AAE DBA7 32BFEE          13      LD  (WK1FD0),A
000AB1 DBAA 01D01F          10      LD  BC,01FD0H
000AB4 DBAD ED79            12      OUT (C),A
000AB6 DBAF C1              10      POP BC
000AB7 DBB0 C9              10      RET
                                
                                
                                ;   BANK RAM DISK DRIVER
                                
       DBB1                     BDWT:
000AB8 DBB1 3E                      DB  03EH    ;LD A,??
000AB9 DBB2 37               4      SCF
000ABA DBB3 1802            12      JR  BRW
                                
       DBB5                     BDRD:
000ABC DBB5 3E                      DB  03EH    ;LD A,??
000ABD DBB6 A7               4      AND A
       DBB7                     BRW:
000ABE DBB7 F3               4      DI
000ABF DBB8 32E3DB          13      LD  (BRWPAT),A
000AC2 DBBB ED7303DC        20      LD  (BANKSP),SP
000AC6 DBBF 3A04DC          13      LD  A,(BANKSP_H)
000AC9 DBC2 87               4      ADD A,A
000ACA DBC3 3803            12      JR  C,BRW0
000ACC DBC5 31CAFF          10      LD  SP,EXTSP
       DBC8                     BRW0:
000ACF DBC8 D9               4      EXX     ;裏レジスタ
000AD0 DBC9 C5              11       PUSH    BC
000AD1 DBCA D5              11       PUSH    DE
000AD2 DBCB 01000B          10       LD  BC,00B00H   ;バンクメモリ
000AD5 DBCE 111010          10       LD  DE,01010H
000AD8 DBD1 D9               4       EXX        ;表レジスタ
       DBD2                     BRW1:
000AD9 DBD2 C5              11      PUSH    BC
000ADA DBD3 D5              11      PUSH    DE
000ADB DBD4 EB               4      EX  DE,HL
000ADC DBD5 29              11      ADD HL,HL
000ADD DBD6 29              11      ADD HL,HL
000ADE DBD7 7C               4      LD  A,H
000ADF DBD8 DD860C          19      ADD A,(IX+DPB_MAXCYL)
000AE2 DBDB E60F             7      AND 00FH    ;バンク
000AE4 DBDD 65               4      LD  H,L
000AE5 DBDE CB3C             8      SRL H   ;/2
000AE7 DBE0 2E00             7      LD  L,0
000AE9 DBE2 D9               4      EXX     ;裏レジスタ
000AEA DBE3 A7               4  BRWPAT:  AND     A  ;自己書き換え(AND A:読み出し/SCF:書き込み)
000AEB DBE4 3808            12       JR  C,BRWT
000AED DBE6 57               4       LD  D,A     ;D=バンク
000AEE DBE7 D9               4       EXX        ;表レジスタ
000AEF DBE8 EB               4      EX  DE,HL
000AF0 DBE9 CD07DC          17      CALL    BTFR
000AF3 DBEC 1806            12      JR  BRW2
       DBEE                     BRWT:
000AF5 DBEE 5F               4       LD E,A  ;E=バンク
000AF6 DBEF D9               4       EXX        ;表レジスタ
000AF7 DBF0 CD07DC          17      CALL    BTFR
000AFA DBF3 EB               4      EX  DE,HL
       DBF4                     BRW2:
000AFB DBF4 D1              10      POP DE
000AFC DBF5 C1              10      POP BC
000AFD DBF6 13               6      INC DE
000AFE DBF7 10D9            13      DJNZ    BRW1
                                
000B00 DBF9 D9               4      EXX     ;裏レジスタ
000B01 DBFA 3E10             7       LD  A,10H
000B03 DBFC ED79            12       OUT     (C),A      ;メインメモリに切り替える
000B05 DBFE D1              10       POP     DE
000B06 DBFF C1              10       POP     BC
000B07 DC00 D9               4       EXX        ;表レジスタ
000B08 DC01 AF               4      XOR A
000B09 DC02 310000          10      LD  SP,0
       DC04                     BANKSP_H    EQU $-1
       DC03                     BANKSP      EQU $-2
000B0C DC05 FB               4      EI
000B0D DC06 C9              10      RET
                                
                                ;メインメモリ←→バンクメモリ 512バイトの転送を行う
                                ; DE:転送元アドレス
                                ; HL:転送先アドレス
                                ; 裏BC:バンク切り替えポート(0B00H)
                                ; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
                                ; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
                                
       DC07                     BTFR:
000B0E DC07 0600             7      LD  B,0 ;256回ループ(256*2)
       DC09                     BTFR1:
000B10 DC09 D9               4      EXX     ;裏レジスタ
000B11 DC0A ED51            12       OUT     (C),D   ;BANK(MAIN)
000B13 DC0C D9               4       EXX        ;表レジスタ
000B14 DC0D 1A               7      LD  A,(DE)
000B15 DC0E 4F               4      LD  C,A
000B16 DC0F 13               6      INC DE
000B17 DC10 1A               7      LD  A,(DE)
000B18 DC11 13               6      INC DE
000B19 DC12 D9               4      EXX     ;裏レジスタ
000B1A DC13 ED59            12       OUT     (C),E   ;MAIN(BANK)
000B1C DC15 D9               4       EXX        ;表レジスタ
000B1D DC16 71               7      LD  (HL),C
000B1E DC17 23               6      INC HL
000B1F DC18 77               7      LD  (HL),A
000B20 DC19 23               6      INC HL
000B21 DC1A 10ED            13      DJNZ    BTFR1
000B23 DC1C C9              10      RET
                                
                                ;   EMM DRIVER(CPU)
                                
       DC1D                     EDWT:
000B24 DC1D CD45DC          17      CALL    EADR
       DC20                     EDWT0:
000B27 DC20 F5              11      PUSH    AF
000B28 DC21 AF               4      XOR A
       DC22                     EDWT1:
000B29 DC22 04               4      INC B
000B2A DC23 EDA3            16      OUTI
000B2C DC25 04               4      INC B
000B2D DC26 EDA3            16      OUTI
000B2F DC28 3D               4      DEC A
000B30 DC29 20F7            12      JR  NZ,EDWT1
000B32 DC2B 13               6      INC DE
000B33 DC2C F1              10      POP AF
000B34 DC2D 3D               4      DEC A
000B35 DC2E 20F0            12      JR  NZ,EDWT0
000B37 DC30 C9              10      RET
                                
       DC31                     EDRD:
000B38 DC31 CD45DC          17      CALL    EADR
       DC34                     EDRD0:
000B3B DC34 F5              11      PUSH    AF
000B3C DC35 AF               4      XOR A
       DC36                     EDRD1:
000B3D DC36 EDA2            16      INI
000B3F DC38 04               4      INC B
000B40 DC39 EDA2            16      INI
000B42 DC3B 04               4      INC B
000B43 DC3C 3D               4      DEC A
000B44 DC3D 20F7            12      JR  NZ,EDRD1
000B46 DC3F 13               6      INC DE
000B47 DC40 F1              10      POP AF
000B48 DC41 3D               4      DEC A
000B49 DC42 20F0            12      JR  NZ,EDRD0
000B4B DC44 C9              10      RET
                                
       DC45                     EADR:
000B4C DC45 C5              11      PUSH    BC
000B4D DC46 D5              11      PUSH    DE
000B4E DC47 EB               4      EX  DE,HL
000B4F DC48 29              11      ADD HL,HL
000B50 DC49 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
000B53 DC4C DD460C          19      LD  B,(IX+DPB_MAXCYL)
000B56 DC4F 09              11      ADD HL,BC
000B57 DC50 DD4E13          19      LD  C,(IX+DPB_UNITNO)
000B5A DC53 060D             7      LD  B,00DH
000B5C DC55 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
000B5E DC57 0C               4      INC C
000B5F DC58 ED69            12      OUT (C),L
000B61 DC5A 0C               4      INC C
000B62 DC5B ED61            12      OUT (C),H
000B64 DC5D 0C               4      INC C
000B65 DC5E EB               4      EX  DE,HL
000B66 DC5F D1              10      POP DE
000B67 DC60 F1              10      POP AF
000B68 DC61 A7               4      AND A   ;CF=0
000B69 DC62 C9              10      RET
                                
                                
[EOF:X1DISK2.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       DC63                     BDOS0:
000B6A DC63 E5              11      PUSH    HL
000B6B DC64 79               4      LD  A,C
000B6C DC65 FE3C             7      CP  03CH
000B6E DC67 3802            12      JR  C,DOS1
000B70 DC69 3E3C             7      LD  A,03CH
       DC6B                     DOS1:
000B72 DC6B 87               4      ADD A,A
000B73 DC6C 3270DC          13      LD  (DOS1_SWC),A
000B76 DC6F 2A00EF          16      LD  HL,(STABLE)
       DC70                     DOS1_SWC    EQU $-2
000B79 DC72 E3              19      EX  (SP),HL
000B7A DC73 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
000B7B DC74 C9              10      RET
       DC75                     _DOS2:
000B7C DC75 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000B7E DC77 CA0FDF          10      JP  Z,_SYS5A
000B81 DC7A FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000B83 DC7C CACCDE          10      JP  Z,_SYS5C
000B86 DC7F FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
000B88 DC81 CAF9EB          10      JP  Z,_SYS5F
000B8B DC84 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000B8D DC86 200A            12      JR  NZ,_ERROR
000B8F DC88 011D01          10      LD  BC,VER_6F
000B92 DC8B 116201          10      LD  DE,VER
000B95 DC8E 210000          10      LD  HL,MACD
       DC91                     C_REM:
000B98 DC91 AF               4      XOR A
       DC92                     _ERROR:
000B99 DC92 A7               4      AND A
000B9A DC93 C9              10      RET
                                
       DC94                     _SYS09:     ;文字列出力
000B9B DC94 D5              11      PUSH    DE
       DC95                     _SX09:
000B9C DC95 1A               7      LD  A,(DE)
000B9D DC96 13               6      INC DE
000B9E DC97 FE24             7      CP  '$'
000BA0 DC99 2831            12      JR  Z,SX0E2
000BA2 DC9B CDC1DF          17      CALL    MSG_A
000BA5 DC9E 18F5            12      JR  _SX09
                                
       DCA0                     MSX1:
000BA7 DCA0 CDC1DF          17      CALL    MSG_A
       DCA3                     MSX:
000BAA DCA3 7E               7      LD  A,(HL)
000BAB DCA4 23               6      INC HL
000BAC DCA5 B7               4      OR  A
000BAD DCA6 20F8            12      JR  NZ,MSX1
000BAF DCA8 C9              10      RET
                                
       DCA9                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000BB0 DCA9 212200          10      LD  HL,00022H
000BB3 DCAC 7D               4      LD  A,L
000BB4 DCAD C9              10      RET
                                
       DCAE                     _SYS0D:     ;(BDOS)ディスクリセット
000BB5 DCAE CDDFEE          17      CALL    _FFLUSH
000BB8 DCB1 E5              11      PUSH    HL
000BB9 DCB2 218000          10      LD  HL,00080H
000BBC DCB5 228AEE          16      LD  (_DTA),HL
000BBF DCB8 E1              10      POP HL
000BC0 DCB9 D5              11      PUSH    DE
000BC1 DCBA 1E00             7      LD  E,0
000BC3 DCBC 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       DCBD                     _SYS0E:     ;(BDOS)カレントドライブの設定
000BC4 DCBD D5              11      PUSH    DE
000BC5 DCBE 7B               4      LD  A,E
000BC6 DCBF DDE5            15      PUSH    IX
000BC8 DCC1 CDDCEE          17      CALL    _GETDPB
000BCB DCC4 DDE1            14      POP IX
000BCD DCC6 3804            12      JR  C,SX0E2
000BCF DCC8 7B               4      LD  A,E
000BD0 DCC9 320400          13      LD  (_DVSW),A
       DCCC                     SX0E2:
000BD3 DCCC D1              10      POP DE
000BD4 DCCD C9              10      RET
                                
       DCCE                     _SYS0F:     ;(BDOS)ファイルのオープン
000BD5 DCCE CDF3F0          17      CALL    SETDRV
000BD8 DCD1 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000BDB DCD4 C602             7      ADD A,002H      ;Write
000BDD DCD6 2848            12      JR  Z,FEND0F
000BDF DCD8 CD42F4          17      CALL    CHKWILDX
                                
000BE2 DCDB D41DF1          17      CALL    NC,SOPENX
       DCDE                     _S16XX:
000BE5 DCDE 3840            12      JR  C,FEND0F
                                                ;Directory location
000BE7 DCE0 3A9FEE          13      LD  A,(_FILEN)
000BEA DCE3 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
000BED DCE6 3AA0EE          13      LD  A,(_DIRF)
000BF0 DCE9 FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000BF3 DCEC FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
000BF6 DCEF FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
000BF9 DCF2 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
000BFD DCF6 FDE5            15      PUSH    IY
000BFF DCF8 D1              10      POP DE
000C00 DCF9 13               6      INC DE
000C01 DCFA 010B00          10      LD  BC,11
000C04 DCFD EDB0                    LDIR
                                ;               Attribute
000C06 DCFF 7E               7      LD  A,(HL)
000C07 DD00 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
000C0A DD03 110B00          10      LD  DE,11       ;Reserved
000C0D DD06 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
000C0E DD07 11E4EF          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
000C11 DD0A 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DD0C                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000C13 DD0C 1A               7      LD  A,(DE)
000C14 DD0D 13               6      INC DE
000C15 DD0E 3215DD          13      LD  (S16PAT),A
000C18 DD11 7E               7      LD  A,(HL)
000C19 DD12 23               6      INC HL
000C1A DD13 FD7700          19      LD  (IY+0),A
       DD15                     S16PAT  EQU $-1
000C1D DD16 10F4            13      DJNZ    S16LOOP
                                
000C1F DD18 AF               4      XOR A
000C20 DD19 FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000C23 DD1C FD22BDDD        20      LD  (OFCB_SWC),IY
       DD20                     FEND0F:
000C27 DD20 1845            12      JR  FEND10
                                
       DD22                     _SYS10:     ;(BDOS)ファイルのクローズ
000C29 DD22 CDF3F0          17      CALL    SETDRV
000C2C DD25 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000C2F DD28 D6FE             7      SUB 0FEH
000C31 DD2A 37               4      SCF
000C32 DD2B 3F               4      CCF
000C33 DD2C 2039            12      JR  NZ,FEND10
       DD2E                     _S10A:              ;Write
000C35 DD2E FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000C38 DD31 FD770F          19      LD  (IY+15),A
                                
000C3B DD34 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
000C3E DD37 CD3EF5          17      CALL    SETTMS
                                
000C41 DD3A FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000C44 DD3D 32A0EE          13      LD  (_DIRF),A
000C47 DD40 E67F             7      AND 07FH
000C49 DD42 3219E9          13      LD  (_SECPS),A
000C4C DD45 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000C4F DD48 FD561F          19      LD  D,(IY+31)
000C52 DD4B CD51F2          17      CALL    READ_DIR
000C55 DD4E 3817            12      JR  C,FEND10
                                
000C57 DD50 3A7DF1          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000C5A DD53 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000C5B DD54 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000C5E DD57 6F               4      LD  L,A
000C5F DD58 2600             7      LD  H,0
000C61 DD5A 29              11      ADD HL,HL       ;*2
000C62 DD5B 29              11      ADD HL,HL       ;*4
000C63 DD5C 29              11      ADD HL,HL       ;*8
000C64 DD5D 29              11      ADD HL,HL       ;*16
000C65 DD5E 29              11      ADD HL,HL       ;*32
000C66 DD5F ED4B7EEF        20      LD  BC,(_DTBUF)
000C6A DD63 09              11      ADD HL,BC
                                
000C6B DD64 CD52F4          17      CALL    SDIRENT
       DD67                     FEND10:
000C6E DD67 1842            12      JR  FEND
                                
       DD69                     _SYS11:     ;(BDOS)最初のファイルの検索
000C70 DD69 CDF3F0          17      CALL    SETDRV
000C73 DD6C CD4CF1          17      CALL    SOPEN
       DD6F                     _S12X1:
000C76 DD6F 383A            12      JR  C,FEND
000C78 DD71 CDEBF1          17      CALL    SOPENE2
000C7B DD74 ED5B8AEE        20      LD  DE,(_DTA)
000C7F DD78 3A88EE          13      LD  A,(_DRV)
000C82 DD7B 3C               4      INC A
000C83 DD7C 12               7      LD  (DE),A
000C84 DD7D D5              11      PUSH    DE
000C85 DD7E 13               6      INC DE
000C86 DD7F 012000          10      LD  BC,32
000C89 DD82 EDB0                    LDIR
000C8B DD84 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000C8E DD87 FD660F          19      LD  H,(IY+15)
000C91 DD8A 22F4EF          16      LD  (SCDIR),HL
000C94 DD8D 2A9AEE          16      LD  HL,(_FBPS)
000C97 DD90 22F6EF          16      LD  (SFBPS),HL
000C9A DD93 2A9FEE          16      LD  HL,(_FILEN)
000C9D DD96 7C               4      LD  A,H
000C9E DD97 B7               4      OR  A
000C9F DD98 2806            12      JR  Z,_S12DIR
000CA1 DD9A 3A19E9          13      LD  A,(_SECPS)
000CA4 DD9D F680             7      OR  080H
000CA6 DD9F 67               4      LD  H,A
       DDA0                     _S12DIR:
000CA7 DDA0 22F8EF          16      LD  (SFNDF),HL  ;Directory position and Flags
000CAA DDA3 E1              10      POP HL
000CAB DDA4 1139EE          10      LD  DE,SFILE
000CAE DDA7 0E21             7      LD  C,33
       DDA9                     _S11B:
000CB0 DDA9 EDB0                    LDIR
       DDAB                     FEND:
000CB2 DDAB 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       DDAC                     FENDE:
000CB3 DDAC FDE1            14      POP IY
000CB5 DDAE C1              10      POP BC
000CB6 DDAF D1              10      POP DE
000CB7 DDB0 E1              10      POP HL
000CB8 DDB1 C9              10      RET
                                
       DDB2                     _SYS12:     ;(BDOS)次のファイルの検索
000CB9 DDB2 E5              11      PUSH    HL
000CBA DDB3 D5              11      PUSH    DE
000CBB DDB4 C5              11      PUSH    BC
000CBC DDB5 FDE5            15      PUSH    IY
000CBE DDB7 CDB0F1          17      CALL    NOPEN
000CC1 DDBA 18B3            12      JR  _S12X1
                                
       DDBC                     _S16K:
000CC3 DDBC 110000          10      LD  DE,0
       DDBD                     OFCB_SWC    EQU $-2
000CC6 DDBF D5              11      PUSH    DE
000CC7 DDC0 061A             7      LD  B,26        ;First cluster
       DDC2                     S16K1:
000CC9 DDC2 13               6      INC DE
000CCA DDC3 23               6      INC HL
000CCB DDC4 10FC            13      DJNZ    S16K1
                                
000CCD DDC6 1A               7      LD  A,(DE)
000CCE DDC7 BE               7      CP  (HL)
000CCF DDC8 2015            12      JR  NZ,S16K2
000CD1 DDCA 13               6      INC DE
000CD2 DDCB 23               6      INC HL
000CD3 DDCC 1A               7      LD  A,(DE)
000CD4 DDCD BE               7      CP  (HL)
000CD5 DDCE 200F            12      JR  NZ,S16K2
                                
000CD7 DDD0 E1              10      POP HL
000CD8 DDD1 FDE5            15      PUSH    IY
000CDA DDD3 D1              10      POP DE
000CDB DDD4 7E               7      LD  A,(HL)
000CDC DDD5 CD08F1          17      CALL    IS_SAME_DRV_A_DE
000CDF DDD8 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000CE1 DDDA ED52            15      SBC HL,DE       ;CP HL,DE
000CE3 DDDC 37               4      SCF
000CE4 DDDD C0              11      RET NZ
000CE5 DDDE E5              11      PUSH    HL
       DDDF                     S16K2:
000CE6 DDDF E1              10      POP HL
       DDE0                     S16K3:
000CE7 DDE0 FDE5            15      PUSH    IY
000CE9 DDE2 D1              10      POP DE
       DDE3                     _SYS13:     ;(BDOS)ファイルの削除
000CEA DDE3 CDF3F0          17      CALL    SETDRV
000CED DDE6 CD7AF3          17      CALL    KILL
       DDE9                     FEND13:
000CF0 DDE9 18C0            12      JR  FEND
                                
       DDEB                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000CF2 DDEB CDF3F0          17      CALL    SETDRV
000CF5 DDEE CD6CE7          17      CALL    INIT_SEQ
       DDF1                     SREAD:
000CF8 DDF1 CD3EE7          17      CALL    RB_READ
                                
000CFB DDF4 C601             7      ADD A,001H
000CFD DDF6 38B3            12      JR  C,FEND
                                
000CFF DDF8 7D               4      LD  A,L
000D00 DDF9 D601             7      SUB 001H
       DDFB                     FENDX:
000D02 DDFB 9F               4      SBC A,A
000D03 DDFC E603             7      AND 3
000D05 DDFE 1F               4      RRA
000D06 DDFF 18AB            12      JR  FENDE
                                
       DE01                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000D08 DE01 CDF3F0          17      CALL    SETDRV
000D0B DE04 CD6CE7          17      CALL    INIT_SEQ
       DE07                     SWRITE:
000D0E DE07 CD39E7          17      CALL    RB_WRITE
                                
000D11 DE0A C6FF             7      ADD A,0FFH
000D13 DE0C 18ED            12      JR  FENDX
                                
       DE0E                     _SYS17:     ;(BDOS)ファイル名の変更
000D15 DE0E CDF3F0          17      CALL    SETDRV
000D18 DE11 CDD0F3          17      CALL    NAME
000D1B DE14 18D3            12      JR  FEND13
                                
       DE16                     _SYS16:     ;(BDOS)ファイルの作成
000D1D DE16 CDF3F0          17      CALL    SETDRV
                                
000D20 DE19 CD42F4          17      CALL    CHKWILDX
000D23 DE1C 38CB            12      JR  C,FEND13
000D25 DE1E FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000D28 DE21 FE05             7      CP  5
000D2A DE23 2805            12      JR  Z,_S16X2
000D2C DE25 FE21             7      CP  021H
000D2E DE27 DAE9DD          10      JP  C,FEND13
       DE2A                     _S16X2:
                                ;               Clear FCB
000D31 DE2A FDE5            15      PUSH    IY
000D33 DE2C E1              10      POP HL
000D34 DE2D 011000          10      LD  BC,16
000D37 DE30 09              11      ADD HL,BC
       DE31                     _S16X1:
000D38 DE31 70               7      LD  (HL),B      ;B=0
000D39 DE32 23               6      INC HL
000D3A DE33 0D               4      DEC C
000D3B DE34 20FB            12      JR  NZ,_S16X1
                                
000D3D DE36 CD43F5          17      CALL    SETTMSX
000D40 DE39 FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000D44 DE3D CD1DF1          17      CALL    SOPENX
000D47 DE40 3F               4      CCF
000D48 DE41 CCBCDD          17      CALL    Z,_S16K
000D4B DE44 D4FCF1          17      CALL    NC,COPEN
000D4E DE47 D452F4          17      CALL    NC,SDIRENT
000D51 DE4A C3DEDC          10      JP  _S16XX
                                
       DE4D                     _SYS21:     ;(BDOS)ランダムな読み出し
000D54 DE4D CDF3F0          17      CALL    SETDRV
000D57 DE50 CD8EF5          17      CALL    INIT_RND
000D5A DE53 189C            12      JR  SREAD
                                
       DE55                     _SYS22:     ;(BDOS)ランダムな書き込み
       DE55                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000D5C DE55 CDF3F0          17      CALL    SETDRV
000D5F DE58 CD8EF5          17      CALL    INIT_RND
000D62 DE5B 18AA            12      JR  SWRITE
                                
       DE5D                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000D64 DE5D 21FF00          10      LD  HL,000FFH
000D67 DE60 AF               4      XOR A
000D68 DE61 C9              10      RET
                                
       DE62                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000D69 DE62 3A0400          13      LD  A,(_DVSW)   ;from LDOS
000D6C DE65 A7               4      AND A
000D6D DE66 C9              10      RET
                                
       DE67                     _SYS1A:     ;(BDOS)DTAの設定
000D6E DE67 ED538AEE        20      LD  (_DTA),DE
000D72 DE6B AF               4      XOR A
000D73 DE6C C9              10      RET
                                
       DE6D                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000D74 DE6D 7B               4      LD  A,E
000D75 DE6E CD01F1          17      CALL    GETDRV
000D78 DE71 CDDCEE          17      CALL    _GETDPB
000D7B DE74 D4E2EE          17      CALL    NC,_RDFATX
000D7E DE77 210000          10      LD  HL,0
000D81 DE7A D41CF5          17      CALL    NC,DSKF
                                
000D84 DE7D ED5B1DF5        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000D88 DE81 1B               6      DEC DE      ;DE←クラスタの総数
000D89 DE82 FD2A7CEF        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000D8D DE86 9F               4      SBC A,A
000D8E DE87 D8              11      RET C
000D8F DE88 4F               4      LD  C,A     ;C=0
000D90 DE89 DD7E0F          19      LD  A,(IX+DPB_BPS)
000D93 DE8C E607             7      AND 7
000D95 DE8E 47               4      LD  B,A
000D96 DE8F DD7E07          19      LD  A,(IX+DPB_SECPCL)
000D99 DE92 C9              10      RET
                                
       DE93                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000D9A DE93 AF               4      XOR A
000D9B DE94 67               4      LD  H,A
000D9C DE95 6F               4      LD  L,A
000D9D DE96 C9              10      RET
                                
       DE97                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000D9E DE97 2100F6          10      LD  HL,_DEVICE
000DA1 DE9A 7B               4      LD  A,E
000DA2 DE9B C3DCEE          10      JP  _GETDPB
                                
       DE9E                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000DA5 DE9E E5              11      PUSH    HL
000DA6 DE9F 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000DA8 DEA1 CD63DC          17      CALL    BDOS0
000DAB DEA4 381B            12      JR  C,_S23X1
                                
000DAD DEA6 D5              11      PUSH    DE      ;EX DE,IY
000DAE DEA7 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000DB0 DEA9 FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000DB3 DEAC FD6E11          19      LD  L,(IY+17)   ;
000DB6 DEAF FD6612          19      LD  H,(IY+18)   ;
000DB9 DEB2 C5              11      PUSH    BC      ;
000DBA DEB3 FD4613          19      LD  B,(IY+19)   ;
000DBD DEB6 CD80F5          17      CALL    GET_CPM_R_SIZE
000DC0 DEB9 C1              10      POP BC
       DEBA                     _S24X1:
000DC1 DEBA CDA0F5          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000DC4 DEBD FDE3            23      EX  (SP),IY     ;
000DC6 DEBF D1              10      POP DE      ;
                                
000DC7 DEC0 AF               4      XOR A
       DEC1                     _S23X1:
000DC8 DEC1 E1              10      POP HL
000DC9 DEC2 C9              10      RET
                                
       DEC3                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000DCA DEC3 E5              11      PUSH    HL
000DCB DEC4 D5              11      PUSH    DE      ;EX DE,IY
000DCC DEC5 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000DCE DEC7 CD74E7          17      CALL    GETSEQ
000DD1 DECA 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       DECC                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000DD3 DECC 2B               6      DEC HL
       DECD                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000DD4 DECD C5              11      PUSH    BC
000DD5 DECE E5              11      PUSH    HL
000DD6 DECF CD0BF0          17      CALL    FILE
000DD9 DED2 E1              10      POP HL
000DDA DED3 C1              10      POP BC
       DED4                     S29X1:
000DDB DED4 C5              11      PUSH    BC
000DDC DED5 D5              11      PUSH    DE
000DDD DED6 E5              11      PUSH    HL
000DDE DED7 EB               4      EX  DE,HL
000DDF DED8 AF               4      XOR A
000DE0 DED9 3221EE          13      LD  (FDRV+13),A
000DE3 DEDC 2114EE          10      LD  HL,FDRV
000DE6 DEDF 011000          10      LD  BC,16
000DE9 DEE2 EDB0                    LDIR
000DEB DEE4 E1              10      POP HL
000DEC DEE5 D1              10      POP DE
000DED DEE6 C1              10      POP BC
000DEE DEE7 C9              10      RET
                                
       DEE8                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000DEF DEE8 C5              11      PUSH    BC
000DF0 DEE9 01BAEA          10      LD  BC,DWT24B
000DF3 DEEC 1804            12      JR  S2FX
       DEEE                     _SYS2F:
000DF5 DEEE C5              11      PUSH    BC
000DF6 DEEF 01ACEA          10      LD  BC,DRD24B
       DEF2                     S2FX:
000DF9 DEF2 ED4308DF        20      LD  (S2F_SWC),BC
000DFD DEF6 CDDFEE          17      CALL    _FFLUSH
                                
000E00 DEF9 D5              11      PUSH    DE
000E01 DEFA E5              11      PUSH    HL
000E02 DEFB 7D               4      LD  A,L     ;Drive
000E03 DEFC CDD9EE          17      CALL    _CHGDRV
000E06 DEFF 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
000E08 DF01 44               4      LD  B,H     ;Number of clusters
000E09 DF02 2A8AEE          16      LD  HL,(_DTA)
                                
000E0C DF05 0E00             7      LD  C,0
000E0E DF07 CDACEA          17      CALL    DRD24B
       DF08                     S2F_SWC EQU $-2
       DF0A                     POP_HL_DE_BC_SBCAA_RET:
000E11 DF0A E1              10      POP HL
000E12 DF0B D1              10      POP DE
000E13 DF0C C1              10      POP BC
000E14 DF0D 9F               4      SBC A,A
000E15 DF0E C9              10      RET
                                
       DF0F                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000E16 DF0F C5              11      PUSH    BC
000E17 DF10 D5              11      PUSH    DE
000E18 DF11 E5              11      PUSH    HL
000E19 DF12 CD00F0          17      CALL    FILEC
000E1C DF15 210ADF          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
000E1F DF18 E5              11      PUSH    HL
000E20 DF19 3A21EE          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
000E23 DF1C E610             7      AND 010H        ;ディレクトリ
000E25 DF1E 37               4      SCF
000E26 DF1F C8              11      RET Z
000E27 DF20 1114EE          10      LD  DE,FDRV
000E2A DF23 2A4EEF          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       DF26                     JPHL:
000E2D DF26 E9               4      JP  (HL)
                                
       DF27                     SHOW_ERROR:         ;(9)
000E2E DF27 1179EE          10      LD  DE,COMERM
000E31 DF2A CD94DC          17      CALL    _SYS09      ;(BDOS)文字列出力
000E34 DF2D C300EE          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "X1IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   X1/turbo/Z
                                
       DC92                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       DC92                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       DC92                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       DC92                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       DC92                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       DC92                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       DF30                     BIOS:
000E37 DF30 E5              11      PUSH    HL
000E38 DF31 211080          10      LD  HL,08010H
000E3B DF34 39              11      ADD HL,SP
000E3C DF35 E1              10      POP HL
000E3D DF36 300E            12      JR  NC,BIOS2
       DF38                     BIOS1:
000E3F DF38 CD40DF          17      CALL    BIOS3
000E42 DF3B 061E             7      LD  B,01EH
000E44 DF3D ED79            12      OUT (C),A
000E46 DF3F C9              10      RET
       DF40                     BIOS3:
000E47 DF40 C5              11      PUSH    BC
000E48 DF41 061D             7      LD  B,01DH
000E4A DF43 ED79            12      OUT (C),A
000E4C DF45 C9              10      RET
       DF46                     BIOS2:
000E4D DF46 ED7351DF        20      LD  (BIOS_SP),SP    ;スタックがBIOS-ROMと被っている場合
000E51 DF4A 31CAFF          10      LD  SP,EXTSP
000E54 DF4D CD38DF          17      CALL    BIOS1
000E57 DF50 310000          10      LD  SP,0
       DF51                     BIOS_SP EQU $-2
000E5A DF53 C9              10      RET
                                
       DF54                     INT:
000E5B DF54 F5              11      PUSH    AF
000E5C DF55 E5              11      PUSH    HL
000E5D DF56 C5              11      PUSH    BC
                                
000E5E DF57 CDF8E2          17      CALL    IN49SB
000E61 DF5A 67               4      LD  H,A
000E62 DF5B CDF8E2          17      CALL    IN49SB
000E65 DF5E 6F               4      LD  L,A
000E66 DF5F B7               4      OR  A
000E67 DF60 2810            12      JR  Z,SCEXE
000E69 DF62 CB6C             8      BIT 5,H
000E6B DF64 200C            12      JR  NZ,SCEXE
000E6D DF66 3A93EE          13      LD  A,(_KEYST)
000E70 DF69 47               4      LD  B,A
000E71 DF6A AC               4      XOR H
000E72 DF6B E603             7      AND 3       ;SHIFT,CTRL
000E74 DF6D 2803            12      JR  Z,SCEXE
000E76 DF6F 60               4      LD  H,B
000E77 DF70 2E00             7      LD  L,0
       DF72                     SCEXE:
000E79 DF72 2292EE          16      LD  (_KEYD),HL
000E7C DF75 CD7EDF          17      CALL    KEYSET1
000E7F DF78 C1              10      POP BC
       DF79                     INTPE:
000E80 DF79 E1              10      POP HL
       DF7A                     INTPE2:
000E81 DF7A F1              10      POP AF
       DF7B                     INTCTCE:
000E82 DF7B FB               4      EI
000E83 DF7C ED4D            15      RETI
                                
       DF7E                     KEYSET1:
000E85 DF7E F5              11      PUSH    AF
000E86 DF7F AF               4      XOR A
000E87 DF80 321BE0          13      LD  (FLGET_SWC),A
000E8A DF83 F1              10      POP AF
000E8B DF84 B7               4      OR  A
000E8C DF85 C8              11      RET Z
                                
000E8D DF86 CB6C             8      BIT 5,H
000E8F DF88 2806            12      JR  Z,KEYSET
000E91 DF8A 3A95EE          13      LD  A,(_KEYSP_H)
000E94 DF8D 3230E0          13      LD  (KEYREPEAT_SWC),A
       DF90                     KEYSET:
000E97 DF90 7D               4      LD  A,L
000E98 DF91 CB74             8      BIT 6,H
000E9A DF93 C0              11      RET NZ
       DF94                     KEYBS:
000E9B DF94 B7               4      OR  A
000E9C DF95 C8              11      RET Z
       DF96                     KEYBS1:
000E9D DF96 CDAEDF          17      CALL    KEYBC_IFBREAK
000EA0 DF99 E5              11      PUSH    HL
000EA1 DF9A F5              11      PUSH    AF
000EA2 DF9B 2A90EE          16      LD  HL,(_KEYPS)
000EA5 DF9E 2C               4      INC L
000EA6 DF9F CBAD             8      RES 5,L
000EA8 DFA1 7D               4      LD  A,L
000EA9 DFA2 BC               4      CP  H
000EAA DFA3 2815            12      JR  Z,POP_AF_HL_SCF_RET
000EAC DFA5 3290EE          13      LD  (_KEYPS),A
000EAF DFA8 26FF             7      LD  H,KEYBF/256
000EB1 DFAA F1              10      POP AF
000EB2 DFAB 77               7      LD  (HL),A
000EB3 DFAC E1              10      POP HL
000EB4 DFAD C9              10      RET
       DFAE                     KEYBC_IFBREAK:
000EB5 DFAE FE03             7      CP  3
000EB7 DFB0 C0              11      RET NZ
       DFB1                     KEYBC:
000EB8 DFB1 E5              11      PUSH    HL
000EB9 DFB2 210000          10      LD  HL,0
000EBC DFB5 2290EE          16      LD  (_KEYPS),HL
000EBF DFB8 E1              10      POP HL
000EC0 DFB9 C9              10      RET
                                
       DFBA                     POP_AF_HL_SCF_RET:
000EC1 DFBA F1              10      POP AF
000EC2 DFBB E1              10      POP HL
000EC3 DFBC 37               4      SCF
000EC4 DFBD C9              10      RET
                                
       DFBE                     _SYS01:     ;(BDOS)コンソール入力
000EC5 DFBE CD09EE          17      CALL    _SYS07
       DFC1                     MSG_A:
000EC8 DFC1 F5              11      PUSH    AF
000EC9 DFC2 D5              11      PUSH    DE
000ECA DFC3 5F               4      LD  E,A
000ECB DFC4 CDCADF          17      CALL    _SYS02
000ECE DFC7 D1              10      POP DE
000ECF DFC8 F1              10      POP AF
000ED0 DFC9 C9              10      RET
                                
       DFCA                     _SYS02:     ;(BDOS)コンソール出力
000ED1 DFCA CDDCDF          17      CALL    BREAK
000ED4 DFCD 1805            12      JR  PRINTX
                                
       DFCF                     _SYS06:     ;(BDOS)コンソール直接入出力
000ED6 DFCF 7B               4      LD  A,E
000ED7 DFD0 3C               4      INC A
000ED8 DFD1 CACAEE          10      JP  Z,_INKEY
       DFD4                     PRINTX:
000EDB DFD4 C3CDEE          10      JP  _PRINT
                                
       DFD7                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000EDE DFD7 CD09EE          17      CALL    _SYS07
000EE1 DFDA 1804            12      JR  BREAK1
       DFDC                     BREAK:
000EE3 DFDC FB               4      EI
000EE4 DFDD 3A92EE          13      LD  A,(_KEYD)
       DFE0                     BREAK1:
000EE7 DFE0 FE03             7      CP  3       ;CTRL+C
000EE9 DFE2 CCF4EE          17      CALL    Z,_BREAK
000EEC DFE5 FE13             7      CP  013H        ;CTRL+S
000EEE DFE7 C0              11      RET NZ
                                
       DFE8                     PAUSE:
000EEF DFE8 CDB1DF          17      CALL    KEYBC
                                
       DFEB                     FLGET:
000EF2 DFEB CDDFEE          17      CALL    _FFLUSH
000EF5 DFEE C5              11      PUSH    BC
000EF6 DFEF E5              11      PUSH    HL
000EF7 DFF0 ED4B8EEE        20      LD  BC,(_TXADR)
000EFB DFF4 CBE8             8      SET 5,B
000EFD DFF6 ED60            12      IN  H,(C)
       DFF8                     FLGET1:
000EFF DFF8 3A93EE          13      LD  A,(_KEYST)
000F02 DFFB 0F               4      RRCA
000F03 DFFC 0F               4      RRCA
000F04 DFFD E610             7      AND 010H
000F06 DFFF F608             7      OR  8
000F08 E001 ED68            12      IN  L,(C)
000F0A E003 B5               4      OR  L
000F0B E004 ED79            12      OUT (C),A
       E006                     FLGETR:
000F0D E006 CDCAEE          17      CALL    _INKEY
000F10 E009 2032            12      JR  NZ,FLGETE
000F12 E00B CB5D             8      BIT 3,L
000F14 E00D 28E9            12      JR  Z,FLGET1
000F16 E00F 3A92EE          13      LD  A,(_KEYD)
000F19 E012 B7               4      OR  A
000F1A E013 28E3            12      JR  Z,FLGET1
                                
000F1C E015 3E1A             7      LD  A,01AH
000F1E E017 321BE0          13      LD  (FLGET_SWC),A
       E01A                     FLGET2:
000F21 E01A 3E1A             7      LD  A,1AH
       E01B                     FLGET_SWC   EQU $-1
000F23 E01C B7               4      OR  A
000F24 E01D 28E7            12      JR  Z,FLGETR
000F26 E01F DB01            11      IN  A,(01H)
000F28 E021 87               4      ADD A,A
000F29 E022 30F6            12      JR  NC,FLGET2
       E024                     FLGET3:
000F2B E024 3A1BE0          13      LD  A,(FLGET_SWC)
000F2E E027 B7               4      OR  A
000F2F E028 28DC            12      JR  Z,FLGETR
000F31 E02A DB01            11      IN  A,(01H)
000F33 E02C 87               4      ADD A,A
000F34 E02D 38F5            12      JR  C,FLGET3
                                
000F36 E02F 3E00             7      LD  A,0
       E030                     KEYREPEAT_SWC   EQU $-1
000F38 E031 B7               4      OR  A
000F39 E032 2806            12      JR  Z,FLGET4
000F3B E034 3D               4      DEC A
000F3C E035 3230E0          13      LD  (KEYREPEAT_SWC),A
000F3F E038 18E0            12      JR  FLGET2
       E03A                     FLGET4:
000F41 E03A 3A92EE          13      LD  A,(_KEYD)
       E03D                     FLGETE:
000F44 E03D ED61            12      OUT (C),H
000F46 E03F E1              10      POP HL
000F47 E040 C1              10      POP BC
000F48 E041 C9              10      RET
                                
       E042                     _SYS0A:     ;(BDOS)文字列入力
000F49 E042 C5              11      PUSH    BC
000F4A E043 E5              11      PUSH    HL
000F4B E044 D5              11      PUSH    DE
000F4C E045 CD45E4          17      CALL    GETL
000F4F E048 1120FF          10      LD  DE,KBUF
000F52 E04B E1              10      POP HL
000F53 E04C E5              11      PUSH    HL
000F54 E04D 0E00             7      LD  C,0
000F56 E04F 3004            12      JR  NC,SAX0
000F58 E051 23               6      INC HL
000F59 E052 23               6      INC HL
000F5A E053 1808            12      JR  SAX4
       E055                     SAX0:
000F5C E055 46               7      LD  B,(HL)
000F5D E056 23               6      INC HL
       E057                     SAX1:
000F5E E057 23               6      INC HL
000F5F E058 1A               7      LD  A,(DE)
000F60 E059 13               6      INC DE
000F61 E05A B7               4      OR  A
000F62 E05B 2004            12      JR  NZ,SAX2
       E05D                     SAX4:
000F64 E05D 360D            10      LD  (HL),00DH
000F66 E05F 1804            12      JR  SAX3
       E061                     SAX2:
000F68 E061 77               7      LD  (HL),A
000F69 E062 0C               4      INC C
000F6A E063 10F2            13      DJNZ    SAX1
       E065                     SAX3:
000F6C E065 D1              10      POP DE
000F6D E066 79               4      LD  A,C
000F6E E067 13               6      INC DE
000F6F E068 12               7      LD  (DE),A
000F70 E069 1B               6      DEC DE
000F71 E06A E1              10      POP HL
000F72 E06B C1              10      POP BC
000F73 E06C A7               4      AND A
000F74 E06D C9              10      RET
                                
       E06E                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000F75 E06E CDDCDF          17      CALL    BREAK
000F78 E071 3A92EE          13      LD  A,(_KEYD)
000F7B E074 B7               4      OR  A
000F7C E075 C8              11      RET Z
       E076                     CONSTX:
000F7D E076 CDDFEE          17      CALL    _FFLUSH
000F80 E079 E5              11      PUSH    HL
000F81 E07A 2A90EE          16      LD  HL,(_KEYPS)
000F84 E07D 7C               4      LD  A,H
000F85 E07E AD               4      XOR L
000F86 E07F E1              10      POP HL
000F87 E080 C6FF             7      ADD A,0FFH
000F89 E082 9F               4      SBC A,A
000F8A E083 C9              10      RET
                                
       E084                     _SYS2A:     ;(BDOS)日付の獲得
000F8B E084 C5              11      PUSH    BC
000F8C E085 3EED             7      LD  A,0EDH      ;Read calendar
000F8E E087 CD13E3          17      CALL    COMOUT
000F91 E08A CDBDE0          17      CALL    IN49SB_BCD  ;YY
000F94 E08D 6F               4      LD  L,A
000F95 E08E 2600             7      LD  H,0
                                ;   LD  DE,1900     ;0076CH
                                ;   CP  90      ;90以上は1900年代 1990-1999
                                ;   JR  NC,RDDATE1  ;90未満は2000年代 2000-2089
                                ;   LD  E,0D0H      ;2000 & 0FFH D=007H
000F97 E090 11D007          10      LD  DE,2000     ;すべて2000年代で処理 2000-2099
       E093                     RDDATE1:
000F9A E093 19              11      ADD HL,DE
000F9B E094 CDF8E2          17      CALL    IN49SB      ;MW
000F9E E097 57               4      LD  D,A
000F9F E098 CDBDE0          17      CALL    IN49SB_BCD  ;DD
000FA2 E09B 5F               4      LD  E,A
000FA3 E09C 7A               4      LD  A,D
000FA4 E09D 0604             7      LD  B,4
       E09F                     RDDATE2:
000FA6 E09F CB3A             8      SRL D
000FA8 E0A1 10FC            13      DJNZ    RDDATE2
000FAA E0A3 C1              10      POP BC
000FAB E0A4 E607             7      AND 7
000FAD E0A6 C9              10      RET
                                
       E0A7                     _SYS2C:     ;(BDOS)時刻の獲得
000FAE E0A7 C5              11      PUSH    BC
000FAF E0A8 3EEF             7      LD  A,0EFH      ;Read time
000FB1 E0AA CD13E3          17      CALL    COMOUT
000FB4 E0AD CDBDE0          17      CALL    IN49SB_BCD  ;TT
000FB7 E0B0 67               4      LD  H,A
000FB8 E0B1 CDBDE0          17      CALL    IN49SB_BCD  ;MM
000FBB E0B4 6F               4      LD  L,A
000FBC E0B5 CDBDE0          17      CALL    IN49SB_BCD  ;SS
000FBF E0B8 57               4      LD  D,A
000FC0 E0B9 C1              10      POP BC
000FC1 E0BA AF               4      XOR A
000FC2 E0BB 5F               4      LD  E,A
000FC3 E0BC C9              10      RET
                                
       E0BD                     IN49SB_BCD:
000FC4 E0BD CDF8E2          17      CALL    IN49SB
                                ;------------------------
                                ;BCDの10進数化
                                ;in
                                ;   A  : BCD
                                ;out
                                ;   A  : 10進数
                                ;------------------------
000FC7 E0C0 4F               4      LD  C,A
000FC8 E0C1 E6F0             7      AND 0F0H    ;10の位
000FCA E0C3 0F               4      RRCA
000FCB E0C4 47               4      LD  B,A
000FCC E0C5 0F               4      RRCA
000FCD E0C6 0F               4      RRCA
000FCE E0C7 80               4      ADD A,B
000FCF E0C8 47               4      LD  B,A
000FD0 E0C9 79               4      LD  A,C
000FD1 E0CA E60F             7      AND 00FH    ;1の位
000FD3 E0CC 80               4      ADD A,B
000FD4 E0CD C9              10      RET
                                
       E0CE                     ESC1:
000FD5 E0CE 7B               4      LD  A,E
000FD6 E0CF FE41             7      CP  'A'
000FD8 E0D1 CA16E2          10      JP  Z,CTRL1E
000FDB E0D4 FE42             7      CP  'B'
000FDD E0D6 CA7EE3          10      JP  Z,CTRL1F
000FE0 E0D9 FE43             7      CP  'C'
000FE2 E0DB CA21E2          10      JP  Z,CTRL1C
000FE5 E0DE FE44             7      CP  'D'
000FE7 E0E0 CA0DE2          10      JP  Z,CTRL1D
000FEA E0E3 FE45             7      CP  'E'
000FEC E0E5 2802            12      JR  Z,CT0CX
000FEE E0E7 FE6A             7      CP  'j'
       E0E9                     CT0CX:
000FF0 E0E9 CA51E3          10      JP  Z,CTRL0C
000FF3 E0EC FE48             7      CP  'H'
000FF5 E0EE CA9BE2          10      JP  Z,CTRL0B
000FF8 E0F1 FE4A             7      CP  'J'
000FFA E0F3 CA54E3          10      JP  Z,CTRL06
000FFD E0F6 FE4B             7      CP  'K'
000FFF E0F8 2807            12      JR  Z,CT05X
001001 E0FA FE4C             7      CP  'L'
001003 E0FC CA93E3          10      JP  Z,CTRL0E
001006 E0FF FE54             7      CP  'T'
       E101                     CT05X:
001008 E101 CA5AE2          10      JP  Z,CTRL05
00100B E104 FE78             7      CP  'x'
00100D E106 2804            12      JR  Z,ESC1X
00100F E108 FE79             7      CP  'y'
001011 E10A 2002            12      JR  NZ,ESC1Y
       E10C                     ESC1X:
001013 E10C 3601            10      LD  (HL),1
       E10E                     ESC1Y:
001015 E10E FE3D             7      CP  '='
001017 E110 2804            12      JR  Z,ESC1W
001019 E112 FE59             7      CP  'Y'
00101B E114 2002            12      JR  NZ,ESC1Z
       E116                     ESC1W:
00101D E116 3602            10      LD  (HL),2
       E118                     ESC1Z:
00101F E118 FE20             7      CP  020H
001021 E11A 3802            12      JR  C,ESC1C
001023 E11C 87               4      ADD A,A
001024 E11D D0              11      RET NC
       E11E                     ESC1C:
001025 E11E E1              10      POP HL
       E11F                     ANK:
001026 E11F ED4B8EEE        20      LD  BC,(_TXADR)
00102A E123 78               4      LD  A,B
00102B E124 F638             7      OR  038H
00102D E126 47               4      LD  B,A
00102E E127 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令   kanji
001030 E129 CB98             8      RES 3,B
001032 E12B ED59            12      OUT (C),E       ;Text
       E12D                     KANJIE:
001034 E12D CDE2E1          17      CALL    PRINTE7
       E130                     PRINTE5:
001037 E130 E1              10      POP HL
001038 E131 C1              10      POP BC
001039 E132 AF               4      XOR A
00103A E133 C9              10      RET
                                
       E134                     ESC:
00103B E134 2130E1          10      LD  HL,PRINTE5
00103E E137 E5              11      PUSH    HL
00103F E138 215AE1          10      LD  HL,ESCFLG+1
001042 E13B 3600            10      LD  (HL),0
001044 E13D 3D               4      DEC A
001045 E13E 288E            12      JR  Z,ESC1
001047 E140 3D               4      DEC A
001048 E141 2009            12      JR  NZ,ESC2
00104A E143 3603            10      LD  (HL),3
00104C E145 7B               4      LD  A,E
00104D E146 D620             7      SUB 020H
00104F E148 324FE1          13      LD  (ESCYP+1),A
001052 E14B C9              10      RET
       E14C                     ESC2:
001053 E14C 3D               4      DEC A
001054 E14D C0              11      RET NZ
001055 E14E 2600             7  ESCYP:  LD  H,0
001057 E150 7B               4      LD  A,E
001058 E151 D620             7      SUB 020H
00105A E153 6F               4      LD  L,A
00105B E154 C3D6EE          10      JP  _LOC
                                
       E157                     PRINT:
00105E E157 C5              11      PUSH    BC
00105F E158 E5              11      PUSH    HL
001060 E159 3E00             7  ESCFLG: LD  A,000H
001062 E15B B7               4      OR  A
001063 E15C 20D6            12      JR  NZ,ESC
                                
001065 E15E 3E1F             7      LD  A,01FH
001067 E160 BB               4      CP  E
001068 E161 3020            12      JR  NC,CTRL
00106A E163 011CE3          10  INSFLG: LD  BC,INSERT
                                
00106D E166 3A1800          13      LD  A,(00018H)
001070 E169 3C               4      INC A
001071 E16A 28B3            12      JR  Z,ANK
001073 E16C 3E00             7  KANFLG: LD  A,000H
001075 E16E B7               4      OR  A
001076 E16F 2025            12      JR  NZ,KANJI2
001078 E171 7B               4      LD  A,E
001079 E172 FE80             7      CP  080H
00107B E174 38A9            12      JR  C,ANK
00107D E176 FEA0             7      CP  0A0H
00107F E178 3804            12      JR  C,KANJI1
001081 E17A FEE0             7      CP  0E0H
001083 E17C 38A1            12      JR  C,ANK
       E17E                     KANJI1:
001085 E17E 326DE1          13      LD  (KANFLG+1),A
001088 E181 18AD            12      JR  PRINTE5
                                
       E183                     CTRL:
00108A E183 CDC9E1          17      CALL    KANCLR
00108D E186 7B               4      LD  A,E
00108E E187 87               4      ADD A,A
00108F E188 F680             7      OR  080H
001091 E18A 6F               4      LD  L,A
001092 E18B 26EF             7      LD  H,CTRLTB/256
001094 E18D 7E               7      LD  A,(HL)
001095 E18E 2C               4      INC L
001096 E18F 66               7      LD  H,(HL)
001097 E190 6F               4      LD  L,A
001098 E191 CD26DF          17      CALL    JPHL
00109B E194 189A            12      JR  PRINTE5
                                
       E196                     KANJI2:
00109D E196 D5              11      PUSH    DE
00109E E197 57               4      LD  D,A
00109F E198 01812F          10      LD  BC,02F81H   ;SFTJIS
0010A2 E19B DF              12      RST 018H
0010A3 E19C 01C32F          10      LD  BC,02FC3H   ;Instead or JISVRM
0010A6 E19F DF              12      RST 018H
                                
0010A7 E1A0 ED4B8EEE        20      LD  BC,(_TXADR)
0010AB E1A4 78               4      LD  A,B
0010AC E1A5 F638             7      OR  038H
0010AE E1A7 47               4      LD  B,A
0010AF E1A8 ED51            12      OUT (C),D       ;kanji
0010B1 E1AA CB98             8      RES 3,B
0010B3 E1AC ED59            12      OUT (C),E       ;Text
0010B5 E1AE CDE2E1          17      CALL    PRINTE7
0010B8 E1B1 ED4B8EEE        20      LD  BC,(_TXADR)
0010BC E1B5 78               4      LD  A,B
0010BD E1B6 F638             7      OR  038H
0010BF E1B8 47               4      LD  B,A
0010C0 E1B9 CBF2             8      SET 6,D
0010C2 E1BB ED51            12      OUT (C),D       ;Kanji
0010C4 E1BD CB98             8      RES 3,B
0010C6 E1BF ED59            12      OUT (C),E       ;Text
0010C8 E1C1 D1              10      POP DE
0010C9 E1C2 AF               4      XOR A
0010CA E1C3 326DE1          13      LD  (KANFLG+1),A
0010CD E1C6 C32DE1          10      JP  KANJIE
                                
       E1C9                     KANCLR:
0010D0 E1C9 3A6DE1          13      LD  A,(KANFLG+1)
0010D3 E1CC B7               4      OR  A
0010D4 E1CD C8              11      RET Z
0010D5 E1CE ED4B8EEE        20      LD  BC,(_TXADR)
0010D9 E1D2 78               4      LD  A,B
0010DA E1D3 F638             7      OR  038H
0010DC E1D5 47               4      LD  B,A
0010DD E1D6 AF               4      XOR A
0010DE E1D7 326DE1          13      LD  (KANFLG+1),A
0010E1 E1DA ED79            12      OUT (C),A       ;Kanji
0010E3 E1DC CB98             8      RES 3,B
0010E5 E1DE 3E20             7      LD  A,020H
0010E7 E1E0 ED79            12      OUT (C),A       ;Text
       E1E2                     PRINTE7:
0010E9 E1E2 CBA0             8      RES 4,B
       E1E4                     PRINTE6:
0010EB E1E4 3A96EE          13      LD  A,(_COLORF)
       E1E7                     PRINTE4:
0010EE E1E7 ED79            12      OUT (C),A       ;Color
0010F0 E1E9 78               4      LD  A,B
0010F1 E1EA E607             7      AND 7
0010F3 E1EC 47               4      LD  B,A
       E1ED                     PRINTE2:
0010F4 E1ED 03               6      INC BC
       E1EE                     PRINTE3:
0010F5 E1EE 2ABAEE          16      LD  HL,(_PAGE_MINUS)
0010F8 E1F1 A7               4      AND A
0010F9 E1F2 ED4A            15      ADC HL,BC
       E1F4                     PRINTE8:
0010FB E1F4 2805            12      JR  Z,PRINT2
0010FD E1F6 ED438EEE        20      LD  (_TXADR),BC
       E1FA                     CTRL00:
001101 E1FA C9              10      RET
                                
       E1FB                     PRINT2:
001102 E1FB CD99E3          17      CALL    SCR
001105 E1FE 2ABCEE          16      LD  HL,(_WIDTH_MINUS)
001108 E201 09              11      ADD HL,BC
       E202                     SET_TXADR_HL:
001109 E202 228EEE          16      LD  (_TXADR),HL
00110C E205 C9              10      RET
                                
       E206                     CTRL08:
00110D E206 3A63E1          13      LD  A,(INSFLG)
001110 E209 FECD             7      CP  0CDH        ;CALL ????
001112 E20B 2829            12      JR  Z,CTRL02
       E20D                     CTRL1D:
001114 E20D 2A8EEE          16      LD  HL,(_TXADR)
001117 E210 7C               4      LD  A,H
001118 E211 B5               4      OR  L
001119 E212 C8              11      RET Z
00111A E213 2B               6      DEC HL
00111B E214 18EC            12      JR  SET_TXADR_HL
                                
       E216                     CTRL1E:
00111D E216 ED4B8EEE        20      LD  BC,(_TXADR)
001121 E21A 2ABCEE          16      LD  HL,(_WIDTH_MINUS)
001124 E21D 09              11      ADD HL,BC
001125 E21E D0              11      RET NC
001126 E21F 18E1            12      JR  SET_TXADR_HL
                                
       E221                     CTRL1C:
001128 E221 ED4B8EEE        20      LD  BC,(_TXADR)
00112C E225 18C6            12      JR  PRINTE2
                                
       E227                     CTRL09:
00112E E227 ED4B8EEE        20      LD  BC,(_TXADR)
001132 E22B 79               4      LD  A,C
001133 E22C E6F8             7      AND 0F8H
001135 E22E C608             7      ADD A,8
001137 E230 4F               4      LD  C,A
001138 E231 88               4      ADC A,B
001139 E232 91               4      SUB C
00113A E233 47               4      LD  B,A
00113B E234 18B8            12      JR  PRINTE3
                                
       E236                     CTRL02:
00113D E236 CD0DE2          17      CALL    CTRL1D
001140 E239 C8              11      RET Z
001141 E23A D5              11      PUSH    DE
001142 E23B CDD3EE          17      CALL    _POS
001145 E23E 3AB1EE          13      LD  A,(_WIDTH)
001148 E241 95               4      SUB L
001149 E242 4F               4      LD  C,A
00114A E243 0D               4      DEC C
00114B E244 0638             7      LD  B,038H
00114D E246 2A8EEE          16      LD  HL,(_TXADR)
001150 E249 09              11      ADD HL,BC
001151 E24A 44               4      LD  B,H
001152 E24B 4D               4      LD  C,L
001153 E24C 110020          10      LD  DE,02000H   ;D:Text E:kanji
001156 E24F 2A96EE          16      LD  HL,(_COLORF)    ;L:Color
       E252                     C8X1:
001159 E252 CD38E3          17      CALL    C12S
00115C E255 0B               6      DEC BC
00115D E256 20FA            12      JR  NZ,C8X1
00115F E258 D1              10      POP DE
001160 E259 C9              10      RET
                                
       E25A                     CTRL05:
001161 E25A CDD3EE          17      CALL    _POS
001164 E25D 3AB1EE          13      LD  A,(_WIDTH)
001167 E260 95               4      SUB L
001168 E261 6F               4      LD  L,A
       E262                     C08X1:
001169 E262 ED4B8EEE        20      LD  BC,(_TXADR)
       E266                     LINECL:
00116D E266 2620             7      LD  H,020H
00116F E268 3A96EE          13      LD  A,(_COLORF)
001172 E26B CBE8             8      SET 5,B
       E26D                     LINECL1:
001174 E26D CBD8             8      SET 3,B
001176 E26F CBE0             8      SET 4,B
001178 E271 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令   kanji
00117A E273 CB98             8      RES 3,B
00117C E275 ED61            12      OUT (C),H       ;Text
00117E E277 CBA0             8      RES 4,B
001180 E279 ED79            12      OUT (C),A       ;Color
001182 E27B 03               6      INC BC
001183 E27C 2D               4      DEC L
001184 E27D 20EE            12      JR  NZ,LINECL1
001186 E27F C9              10      RET
                                
       E280                     CTRL0D:
001187 E280 CDD3EE          17      CALL    _POS
00118A E283 2E00             7      LD  L,0
       E285                     LOC:
00118C E285 C5              11      PUSH    BC
00118D E286 E5              11      PUSH    HL
00118E E287 CDC9E1          17      CALL    KANCLR
001191 E28A CDA8E2          17      CALL    LOC1
001194 E28D 228EEE          16      LD  (_TXADR),HL
001197 E290 E1              10      POP HL
001198 E291 C1              10      POP BC
001199 E292 C9              10      RET
                                
       E293                     CTRL12:
00119A E293 2163E1          10      LD  HL,INSFLG
00119D E296 7E               7      LD  A,(HL)
00119E E297 EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
0011A0 E299 77               7      LD  (HL),A
0011A1 E29A C9              10      RET
                                
       E29B                     CTRL0B:
0011A2 E29B 210000          10      LD  HL,0
0011A5 E29E 228EEE          16      LD  (_TXADR),HL
0011A8 E2A1 C9              10      RET
                                
       E2A2                     CTRL1B:
0011A9 E2A2 3E01             7      LD  A,1
0011AB E2A4 325AE1          13      LD  (ESCFLG+1),A
0011AE E2A7 C9              10      RET
                                
       E2A8                     LOC1:
0011AF E2A8 D5              11      PUSH    DE
0011B0 E2A9 4D               4      LD  C,L
0011B1 E2AA 0608             7      LD  B,8
0011B3 E2AC 5C               4      LD  E,H
0011B4 E2AD 1600             7      LD  D,0
0011B6 E2AF 2AB0EE          16      LD  HL,(CRTCD)
0011B9 E2B2 6A               4      LD  L,D
       E2B3                     LOC2:
0011BA E2B3 29              11      ADD HL,HL
0011BB E2B4 3001            12      JR  NC,LOC3
0011BD E2B6 19              11      ADD HL,DE
       E2B7                     LOC3:
0011BE E2B7 10FA            13      DJNZ    LOC2
0011C0 E2B9 09              11      ADD HL,BC
0011C1 E2BA D1              10      POP DE
0011C2 E2BB C9              10      RET
                                
       E2BC                     CONOUT1:
0011C3 E2BC CDCEE2          17      CALL    CURSOR
0011C6 E2BF 59               4      LD  E,C
0011C7 E2C0 CDCDEE          17      CALL    _PRINT
0011CA E2C3 7B               4      LD  A,E
0011CB E2C4 FE0A             7      CP  00AH
0011CD E2C6 2006            12      JR  NZ,CURSOR
0011CF E2C8 CD80E2          17      CALL    CTRL0D
0011D2 E2CB CD5AE2          17      CALL    CTRL05
       E2CE                     CURSOR:
0011D5 E2CE C5              11      PUSH    BC
0011D6 E2CF ED4B8EEE        20      LD  BC,(_TXADR)
0011DA E2D3 CBE8             8      SET 5,B
0011DC E2D5 ED78            12      IN  A,(C)
0011DE E2D7 EE18             7      XOR 018H
0011E0 E2D9 ED79            12      OUT (C),A
0011E2 E2DB C1              10      POP BC
0011E3 E2DC C9              10      RET
                                
       E2DD                     CTRL07:
0011E4 E2DD 2161EE          10      LD  HL,BEEPD
       E2E0                     BEEP1:
0011E7 E2E0 7E               7      LD  A,(HL)
0011E8 E2E1 23               6      INC HL
0011E9 E2E2 FEFF             7      CP  0FFH
0011EB E2E4 C8              11      RET Z
0011EC E2E5 061C             7      LD  B,01CH
0011EE E2E7 ED79            12      OUT (C),A
0011F0 E2E9 EDA3            16      OUTI
0011F2 E2EB 18F3            12      JR  BEEP1
                                
       E2ED                     OT49SB:
0011F4 E2ED C5              11      PUSH    BC
0011F5 E2EE CD09E3          17      CALL    CANW
0011F8 E2F1 010019          10      LD  BC,01900H
0011FB E2F4 ED79            12      OUT (C),A
0011FD E2F6 C1              10      POP BC
0011FE E2F7 C9              10      RET
                                
       E2F8                     IN49SB:
0011FF E2F8 C5              11      PUSH    BC
001200 E2F9 01011A          10      LD  BC,01A01H
       E2FC                     CANR:
001203 E2FC ED78            12      IN  A,(C)
001205 E2FE E620             7      AND 020H
001207 E300 20FA            12      JR  NZ,CANR
001209 E302 010019          10      LD  BC,01900H
00120C E305 ED78            12      IN  A,(C)
00120E E307 C1              10      POP BC
00120F E308 C9              10      RET
                                
       E309                     CANW:
001210 E309 01011A          10      LD  BC,01A01H
001213 E30C ED48            12      IN  C,(C)
001215 E30E CB71             8      BIT 6,C
001217 E310 20F7            12      JR  NZ,CANW
001219 E312 C9              10      RET
                                
       E313                     COMOUT:
00121A E313 FB               4      EI
00121B E314 CDEDE2          17      CALL    OT49SB
00121E E317 CD09E3          17      CALL    CANW
001221 E31A F3               4      DI
001222 E31B C9              10      RET
                                
       E31C                     INSERT:
001223 E31C D5              11      PUSH    DE
001224 E31D CDD3EE          17      CALL    _POS
001227 E320 3AB1EE          13      LD  A,(_WIDTH)
00122A E323 95               4      SUB L
00122B E324 ED4B8EEE        20      LD  BC,(_TXADR)
00122F E328 110020          10      LD  DE,02000H   ;D:Text E:Kanji
001232 E32B 2A96EE          16      LD  HL,(_COLORF)    ;L:Color
001235 E32E CBE8             8      SET 5,B
       E330                     C12X1:
001237 E330 CD38E3          17      CALL    C12S
00123A E333 03               6      INC BC
00123B E334 20FA            12      JR  NZ,C12X1
00123D E336 D1              10      POP DE
00123E E337 C9              10      RET
                                
       E338                     C12S:
00123F E338 CBE0             8      SET 4,B
001241 E33A CBD8             8      SET 3,B
001243 E33C ED60            12      IN  H,(C)
001245 E33E ED59            12  X1PAT:  OUT (C),E
001247 E340 5C               4      LD  E,H
001248 E341 CB98             8      RES 3,B
00124A E343 ED60            12      IN  H,(C)
00124C E345 ED51            12      OUT (C),D
00124E E347 54               4      LD  D,H
00124F E348 CBA0             8      RES 4,B
001251 E34A ED60            12      IN  H,(C)
001253 E34C ED69            12      OUT (C),L
001255 E34E 6C               4      LD  L,H
001256 E34F 3D               4      DEC A
001257 E350 C9              10      RET
                                
       E351                     CTRL0C:
001258 E351 CD9BE2          17      CALL    CTRL0B
       E354                     CTRL06:
00125B E354 ED4B8EEE        20      LD  BC,(_TXADR)
       E358                     C1AX1:
00125F E358 78               4      LD  A,B
001260 E359 F638             7      OR  038H
001262 E35B 47               4      LD  B,A
001263 E35C ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令   kanji
001265 E35E CB98             8      RES 3,B
001267 E360 3E20             7      LD  A,020H
001269 E362 ED79            12      OUT (C),A       ;Text
00126B E364 CBA0             8      RES 4,B
00126D E366 3A96EE          13      LD  A,(_COLORF)
001270 E369 ED79            12      OUT (C),A       ;Color
001272 E36B 03               6      INC BC
001273 E36C CBA8             8      RES 5,B
001275 E36E 2ABAEE          16      LD  HL,(_PAGE_MINUS)
001278 E371 09              11      ADD HL,BC
001279 E372 30E4            12      JR  NC,C1AX1
00127B E374 C9              10      RET
                                
       E375                     CTRL04:
00127C E375 CDD3EE          17      CALL    _POS
00127F E378 7D               4      LD  A,L
001280 E379 B7               4      OR  A
001281 E37A C8              11      RET Z
       E37B                     CTRL03:
001282 E37B CD80E2          17      CALL    CTRL0D
       E37E                     CTRL0A:
       E37E                     CTRL1F:
001285 E37E ED4B8EEE        20      LD  BC,(_TXADR)
001289 E382 2AB1EE          16      LD  HL,(_WIDTH)
00128C E385 2600             7      LD  H,0
00128E E387 09              11      ADD HL,BC
00128F E388 44               4      LD  B,H
001290 E389 4D               4      LD  C,L
001291 E38A 2ABAEE          16      LD  HL,(_PAGE_MINUS)
001294 E38D 09              11      ADD HL,BC
001295 E38E 3F               4      CCF
001296 E38F 9F               4      SBC A,A
001297 E390 C3F4E1          10      JP  PRINTE8
                                
       E393                     CTRL0E:
00129A E393 CDD3EE          17      CALL    _POS
00129D E396 7C               4      LD  A,H
00129E E397 1804            12      JR  SCR1
       E399                     SCR:
0012A0 E399 3A97EE          13      LD  A,(_LINE)
0012A3 E39C 3D               4      DEC A
       E39D                     SCR1:
0012A4 E39D C5              11      PUSH    BC
0012A5 E39E D5              11      PUSH    DE
0012A6 E39F F5              11      PUSH    AF
0012A7 E3A0 3E07             7      LD  A,7
0012A9 E3A2 21D3E3          10      LD  HL,SCRDMAD
0012AC E3A5 CDC9E3          17      CALL    SETDMA
0012AF E3A8 F1              10      POP AF
0012B0 E3A9 210038          10      LD  HL,03800H
                                
       E3AC                     SCRUP1:
0012B3 E3AC B7               4      OR  A
0012B4 E3AD 284D            12      JR  Z,SCRCL
0012B6 E3AF F5              11      PUSH    AF
0012B7 E3B0 CDDAE3          17      CALL    UPSUB       ;kanji
0012BA E3B3 3ABCEE          13      LD  A,(_WIDTH_MINUS)
0012BD E3B6 5F               4      LD  E,A
0012BE E3B7 16F7             7      LD  D,0F7H
0012C0 E3B9 19              11      ADD HL,DE
0012C1 E3BA D5              11      PUSH    DE
0012C2 E3BB CDDAE3          17      CALL    UPSUB       ;Text
0012C5 E3BE D1              10      POP DE
0012C6 E3BF 19              11      ADD HL,DE
0012C7 E3C0 CDDAE3          17      CALL    UPSUB       ;Color
0012CA E3C3 CBE4             8      SET 4,H
0012CC E3C5 F1              10      POP AF
0012CD E3C6 3D               4      DEC A
0012CE E3C7 18E3            12      JR  SCRUP1
                                
       E3C9                     SETDMA:
0012D0 E3C9 01871F          10      LD  BC,01F87H
       E3CC                     SDMA:
0012D3 E3CC 04               4      INC B
0012D4 E3CD EDA3            16      OUTI
0012D6 E3CF 3D               4      DEC A
0012D7 E3D0 20FA            12      JR  NZ,SDMA
0012D9 E3D2 C9              10      RET
                                
       E3D3                     SCRDMAD:
0012DA E3D3 C3                      DB  0C3H        ;WR6 リセット
0012DB E3D4 9A                      DB  09AH        ;WR5 ストップ WAIT READY:HIGH
0012DC E3D5 65                      DB  065H        ;WR0 ブロック長(LH)
0012DD E3D6 4F00                    DW  79
0012DF E3D8 1C                      DB  01CH        ;WR1 ポートAインクリメント I/O
0012E0 E3D9 18                      DB  018H        ;WR0 ポートAアドレス(LH)
                                
       E3DA                     UPSUB:
0012E1 E3DA 3AB1EE          13      LD  A,(_WIDTH)
0012E4 E3DD 5F               4      LD  E,A
0012E5 E3DE 1600             7      LD  D,0
0012E7 E3E0 3EAD             7      LD  A,0ADH      ;WR4 連続 ポートB開始アドレス(LH)
0012E9 E3E2 ED79            12      OUT (C),A
0012EB E3E4 ED69            12      OUT (C),L       ;SOURCE
0012ED E3E6 ED61            12      OUT (C),H
0012EF E3E8 19              11      ADD HL,DE
0012F0 E3E9 3E1D             7      LD  A,01DH      ;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
0012F2 E3EB ED79            12      OUT (C),A
0012F4 E3ED ED69            12      OUT (C),L       ;DEST
0012F6 E3EF ED61            12      OUT (C),H
       E3F1                     GO_DMA:
0012F8 E3F1 3ECF             7      LD  A,0CFH
0012FA E3F3 ED79            12      OUT (C),A       ;WR6 ロード
0012FC E3F5 3EB3             7      LD  A,0B3H
0012FE E3F7 ED79            12      OUT (C),A       ;WR6 強制RDY
001300 E3F9 ED49            12      OUT (C),C       ;WR6 イネーブル
001302 E3FB C9              10      RET
                                
       E3FC                     SCRCL:
001303 E3FC 44               4      LD  B,H
001304 E3FD 4D               4      LD  C,L
001305 E3FE 2AB1EE          16      LD  HL,(_WIDTH)
001308 E401 CD66E2          17      CALL    LINECL
00130B E404 D1              10      POP DE
00130C E405 C1              10      POP BC
00130D E406 C9              10      RET
                                
       E407                     SCRN:
00130E E407 D5              11      PUSH    DE
00130F E408 ED58            12      IN  E,(C)       ;Text
001311 E40A 3A1800          13      LD  A,(00018H)
001314 E40D 3C               4      INC A
001315 E40E 281E            12      JR  Z,SCRN2
001317 E410 CBD8             8      SET 3,B
001319 E412 ED50            12      IN  D,(C)       ;Kanji
00131B E414 2816            12      JR  Z,SCRN1
00131D E416 AF               4      XOR A
00131E E417 C5              11      PUSH    BC
00131F E418 013730          10      LD  BC,03037H   ;VRMJIS
001322 E41B DF              12      RST 018H
001323 E41C 01522F          10      LD  BC,02F52H   ;JISSFT
001326 E41F DF              12      RST 018H
001327 E420 C1              10      POP BC
001328 E421 ED78            12      IN  A,(C)
00132A E423 CB98             8      RES 3,B
00132C E425 E640             7      AND 040H
00132E E427 2005            12      JR  NZ,SCRN2
001330 E429 7A               4      LD  A,D
001331 E42A D1              10      POP DE
001332 E42B C9              10      RET
       E42C                     SCRN1:
001333 E42C CB98             8      RES 3,B
       E42E                     SCRN2:
001335 E42E 7B               4      LD  A,E
001336 E42F D1              10      POP DE
001337 E430 C9              10      RET
       E431                     SCRNE:
       E431                     POS:
001338 E431 2A8EEE          16      LD  HL,(_TXADR)
00133B E434 C5              11      PUSH    BC
00133C E435 ED4BBCEE        20      LD  BC,(_WIDTH_MINUS)
001340 E439 AF               4      XOR A
       E43A                     POS1:
001341 E43A 09              11      ADD HL,BC
001342 E43B 3C               4      INC A
001343 E43C 38FC            12      JR  C,POS1
001345 E43E ED42            15      SBC HL,BC
001347 E440 3D               4      DEC A
001348 E441 67               4      LD  H,A
001349 E442 C1              10      POP BC
00134A E443 A7               4      AND A
00134B E444 C9              10      RET
                                
       E445                     GETL:
00134C E445 CDD3EE          17      CALL    _POS
00134F E448 E5              11      PUSH    HL
001350 E449 3ECD             7      LD  A,0CDH      ;CALL ????
001352 E44B 3263E1          13      LD  (INSFLG),A
       E44E                     GETL1:
001355 E44E CDD7DF          17      CALL    _SYS08
001358 E451 FE09             7      CP  9
00135A E453 2008            12      JR  NZ,GETL1V
00135C E455 2120FF          10      LD  HL,KBUF
00135F E458 CDA3DC          17      CALL    MSX
001362 E45B 18F1            12      JR  GETL1
       E45D                     GETL1V:
001364 E45D 5F               4      LD  E,A
001365 E45E CDCDEE          17      CALL    _PRINT
                                
001368 E461 7B               4      LD  A,E
001369 E462 FE0D             7      CP  00DH
00136B E464 20E8            12      JR  NZ,GETL1
00136D E466 3E01             7      LD  A,1     ;LD BC,????
00136F E468 3263E1          13      LD  (INSFLG),A
001372 E46B 1120FF          10      LD  DE,KBUF
001375 E46E 3AB1EE          13      LD  A,(_WIDTH)
001378 E471 47               4      LD  B,A
001379 E472 CD56DA          17      CALL    ZERO_MEMORY_DE
                                
00137C E475 D1              10      POP DE
00137D E476 CDD3EE          17      CALL    _POS
001380 E479 6B               4      LD  L,E
001381 E47A 3AB1EE          13      LD  A,(_WIDTH)
001384 E47D 95               4      SUB L
001385 E47E 57               4      LD  D,A
001386 E47F CDA8E2          17      CALL    LOC1
001389 E482 4D               4      LD  C,L
00138A E483 7C               4      LD  A,H
00138B E484 F630             7      OR  030H
00138D E486 47               4      LD  B,A
00138E E487 5A               4      LD  E,D
00138F E488 2120FF          10      LD  HL,KBUF
       E48B                     GETL2:
001392 E48B CDD0EE          17      CALL    _SCRN
001395 E48E 03               6      INC BC
001396 E48F 77               7      LD  (HL),A
001397 E490 23               6      INC HL
001398 E491 1D               4      DEC E
001399 E492 20F7            12      JR  NZ,GETL2
       E494                     GETL3:
00139B E494 2B               6      DEC HL
00139C E495 7E               7      LD  A,(HL)
00139D E496 FE21             7      CP  021H
00139F E498 D0              11      RET NC
0013A0 E499 3600            10      LD  (HL),0
0013A2 E49B 15               4      DEC D
0013A3 E49C 20F6            12      JR  NZ,GETL3
0013A5 E49E C9              10      RET
                                
       E49F                     INKEY:
0013A6 E49F FB               4      EI
0013A7 E4A0 E5              11      PUSH    HL
0013A8 E4A1 2A90EE          16      LD  HL,(_KEYPS)
0013AB E4A4 7C               4      LD  A,H
0013AC E4A5 AD               4      XOR L
0013AD E4A6 280B            12      JR  Z,INKEY1
0013AF E4A8 7C               4      LD  A,H
0013B0 E4A9 3C               4      INC A
0013B1 E4AA E61F             7      AND 01FH
0013B3 E4AC 3291EE          13      LD  (_KEYPS+1),A
0013B6 E4AF 6F               4      LD  L,A
0013B7 E4B0 26FF             7      LD  H,KEYBF/256
0013B9 E4B2 7E               7      LD  A,(HL)
       E4B3                     INKEY1:
0013BA E4B3 E1              10      POP HL
0013BB E4B4 B7               4      OR  A
0013BC E4B5 C9              10      RET
                                
       0E79                     AT_RS   EQU SCR1-AT_SCR1
[EOF:X1IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E4B6                     _SYS26:     ;(BDOS)ランダムブロック書き込み
0013BD E4B6 AF               4      XOR A
0013BE E4B7 329FE7          13      LD  (DRDN1),A   ;NOP
0013C1 E4BA 22EAF5          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
0013C4 E4BD 225DEE          16      LD  (LEFTX),HL
0013C7 E4C0 CDF3F0          17      CALL    SETDRV
                                
0013CA E4C3 CD29E6          17      CALL    RBX0
0013CD E4C6 DA53E5          10      JP  C,RBWERR
0013D0 E4C9 CD7CF4          17      CALL    WOPEN
0013D3 E4CC DA53E5          10      JP  C,RBWERR
0013D6 E4CF 7C               4      LD  A,H
0013D7 E4D0 B5               4      OR  L
0013D8 E4D1 CA4CE5          10      JP  Z,RBW1
                                
0013DB E4D4 2B               6      DEC HL
                                
0013DC E4D5 CDBBF5          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0013DF E4D8 19              11      ADD HL,DE       ;BCHL=HL+BCDE
0013E0 E4D9 3001            12      JR  NC,S26X1    ;
0013E2 E4DB 03               6      INC BC      ;
       E4DC                     S26X1:
0013E3 E4DC CDE7F4          17      CALL    RWXR
0013E6 E4DF DC8DF4          17      CALL    C,WRDFX
0013E9 E4E2 DA53E5          10      JP  C,RBWERR
                                
0013EC E4E5 CD58E6          17      CALL    RBX2
0013EF E4E8 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
0013F1 E4EA CD77E6          17      CALL    RBXA
0013F4 E4ED 3864            12      JR  C,RBWERR
0013F6 E4EF EB               4      EX  DE,HL
0013F7 E4F0 C5              11      PUSH    BC
0013F8 E4F1 EDB0                    LDIR
0013FA E4F3 225FEE          16      LD  (DTAX),HL
                                
0013FD E4F6 CD1EF4          17      CALL    WTDB        ;バッファデータは更新された
                                
001400 E4F9 2A5DEE          16      LD  HL,(LEFTX)
001403 E4FC D1              10      POP DE
001404 E4FD ED52            15      SBC HL,DE
001406 E4FF 225DEE          16      LD  (LEFTX),HL
001409 E502 2831            12      JR  Z,RBWEND
                                
       E504                     RBWB:
00140B E504 CDACE6          17      CALL    RBXB
00140E E507 2814            12      JR  Z,RBWC
       E509                     RBWB1:
001410 E509 C5              11      PUSH    BC
001411 E50A D5              11      PUSH    DE
001412 E50B CDFBF2          17      CALL    CLUSTX
001415 E50E CDD0E6          17      CALL    DWTC
001418 E511 D1              10      POP DE
001419 E512 C1              10      POP BC
00141A E513 D421E9          17      CALL    NC,GNCLX
00141D E516 383B            12      JR  C,RBWERR
00141F E518 10EF            13      DJNZ    RBWB1
001421 E51A CD20E7          17      CALL    DRW_FLUSH
       E51D                     RBWC:
001424 E51D CDC4E6          17      CALL    RBXC
001427 E520 2813            12      JR  Z,RBWEND
001429 E522 C5              11      PUSH    BC
00142A E523 CDFBF2          17      CALL    CLUSTX
00142D E526 CD9EE7          17      CALL    DRDN
001430 E529 C1              10      POP BC
001431 E52A 3827            12      JR  C,RBWERR
001433 E52C ED5B7EEF        20      LD  DE,(_DTBUF)
001437 E530 EDB0                    LDIR
001439 E532 CD1EF4          17      CALL    WTDB        ;バッファデータは更新された
       E535                     RBWEND:
00143C E535 CDE9F5          17      CALL    RBXEND
                                
00143F E538 CD38E6          17      CALL    RBX1
001442 E53B 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
001444 E53D CDBBF5          17      CALL    GET_RR_BCDE ;BCDE=Random record
001447 E540 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
00144A E543 FD7211          19      LD  (IY+17),D   ;
00144D E546 FD7112          19      LD  (IY+18),C   ;
001450 E549 FD7013          19      LD  (IY+19),B   ;
       E54C                     RBW1:
001453 E54C FDE1            14      POP IY
001455 E54E C1              10      POP BC
001456 E54F D1              10      POP DE
001457 E550 E1              10      POP HL
       E551                     DD_NUL:
001458 E551 AF               4      XOR A
       E552                     DRDF0:
       E552                     DWTF0:
001459 E552 C9              10      RET
                                
       E553                     RBWERR:
00145A E553 FDE5            15      PUSH    IY
00145C E555 D1              10      POP DE
00145D E556 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
00145F E558 CD63DC          17      CALL    BDOS0
       E55B                     RBRERR1:
001462 E55B 3E01             7      LD  A,001H
       E55D                     RBRERR2:
001464 E55D FDE1            14      POP IY
001466 E55F C1              10      POP BC
001467 E560 D1              10      POP DE
001468 E561 E1              10      POP HL
001469 E562 37               4      SCF
00146A E563 210000          10      LD  HL,0
00146D E566 C9              10      RET
                                
       E567                     RBRERR:
00146E E567 3EFF             7      LD  A,0FFH
001470 E569 18F2            12      JR  RBRERR2
                                
       E56B                     RBRFL:
001472 E56B 3E00             7  RBRFLP: LD  A,000H
001474 E56D FE0D             7      CP  00DH
001476 E56F 2005            12      JR  NZ,RBRFL1
001478 E571 D5              11      PUSH    DE
001479 E572 1E0A             7      LD  E,00AH
00147B E574 1805            12      JR  RBRFL2
       E576                     RBRFL1:
00147D E576 D5              11      PUSH    DE
00147E E577 CD09EE          17      CALL    _SYS07
001481 E57A 5F               4      LD  E,A
       E57B                     RBRFL2:
001482 E57B CDCDEE          17      CALL    _PRINT
001485 E57E 7B               4      LD  A,E
001486 E57F D1              10      POP DE
001487 E580 326CE5          13      LD  (RBRFLP+1),A
00148A E583 C9              10      RET
                                
                                                ;Read random block
       E584                     _SYS27:     ;(BDOS)ランダムブロック読み込み
00148B E584 225DEE          16      LD  (LEFTX),HL
00148E E587 CDF3F0          17      CALL    SETDRV
                                
001491 E58A FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
001495 E58E C217E6          10      JP  NZ,RBRDIR   ;ディレクトリ
001498 E591 CD29E6          17      CALL    RBX0
00149B E594 DA67E5          10      JP  C,RBRERR
00149E E597 CD38E6          17      CALL    RBX1
0014A1 E59A D450E6          17      CALL    NC,RBX1R
0014A4 E59D DA5BE5          10      JP  C,RBRERR1
0014A7 E5A0 EB               4      EX  DE,HL
0014A8 E5A1 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
0014AA E5A3 19              11      ADD HL,DE
0014AB E5A4 79               4      LD  A,C
0014AC E5A5 DE00             7      SBC A,0
0014AE E5A7 78               4      LD  A,B
0014AF E5A8 DE00             7      SBC A,0
0014B1 E5AA 3801            12      JR  C,RBR1
0014B3 E5AC EB               4      EX  DE,HL
       E5AD                     RBR1:
0014B4 E5AD 9F               4      SBC A,A
0014B5 E5AE E601             7      AND 1
0014B7 E5B0 3215E6          13      LD  (RBRA_SWC),A
                                
0014BA E5B3 7C               4      LD  A,H
0014BB E5B4 B5               4      OR  L
0014BC E5B5 2857            12      JR  Z,RBREND0
                                
0014BE E5B7 22EAF5          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
0014C1 E5BA 225DEE          16      LD  (LEFTX),HL
                                
0014C4 E5BD CD58E6          17      CALL    RBX2
0014C7 E5C0 2819            12      JR  Z,RBRB
0014C9 E5C2 CD77E6          17      CALL    RBXA
0014CC E5C5 DA67E5          10      JP  C,RBRERR
0014CF E5C8 C5              11      PUSH    BC
0014D0 E5C9 EDB0                    LDIR
0014D2 E5CB ED535FEE        20      LD  (DTAX),DE
0014D6 E5CF 2A5DEE          16      LD  HL,(LEFTX)
0014D9 E5D2 D1              10      POP DE
0014DA E5D3 A7               4      AND A
0014DB E5D4 ED52            15      SBC HL,DE
0014DD E5D6 225DEE          16      LD  (LEFTX),HL
0014E0 E5D9 2830            12      JR  Z,RBREND
                                
       E5DB                     RBRB:
0014E2 E5DB CDACE6          17      CALL    RBXB
0014E5 E5DE 2815            12      JR  Z,RBRC
       E5E0                     RBRB1:
0014E7 E5E0 C5              11      PUSH    BC
0014E8 E5E1 D5              11      PUSH    DE
0014E9 E5E2 CDFBF2          17      CALL    CLUSTX
0014EC E5E5 CDD6E6          17      CALL    DRDC
0014EF E5E8 D1              10      POP DE
0014F0 E5E9 C1              10      POP BC
0014F1 E5EA D421E9          17      CALL    NC,GNCLX
0014F4 E5ED DA67E5          10      JP  C,RBRERR
0014F7 E5F0 10EE            13      DJNZ    RBRB1
0014F9 E5F2 CD20E7          17      CALL    DRW_FLUSH
       E5F5                     RBRC:
0014FC E5F5 CDC4E6          17      CALL    RBXC
0014FF E5F8 2811            12      JR  Z,RBREND
001501 E5FA C5              11      PUSH    BC
001502 E5FB CDFBF2          17      CALL    CLUSTX
001505 E5FE CD82E7          17      CALL    DRDX
001508 E601 C1              10      POP BC
001509 E602 DA67E5          10      JP  C,RBRERR
00150C E605 EB               4      EX  DE,HL
00150D E606 2A7EEF          16      LD  HL,(_DTBUF)
001510 E609 EDB0                    LDIR
       E60B                     RBREND:
001512 E60B CDE9F5          17      CALL    RBXEND
       E60E                     RBREND0:
001515 E60E FDE1            14      POP IY
001517 E610 C1              10      POP BC
001518 E611 D1              10      POP DE
001519 E612 F1              10      POP AF  ;(HL)
00151A E613 AF               4      XOR A
00151B E614 3E00             7      LD  A,000H
       E615                     RBRA_SWC    EQU $-1
00151D E616 C9              10      RET
                                
       E617                     RBRDIR:
00151E E617 FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001521 E61A FD661B          19      LD  H,(IY+27)
001524 E61D CD3AF3          17      CALL    CHDIR
001527 E620 AF               4      XOR A
001528 E621 67               4      LD  H,A
001529 E622 6F               4      LD  L,A
00152A E623 3C               4      INC A
00152B E624 3215E6          13      LD  (RBRA_SWC),A
00152E E627 18E5            12      JR  RBREND0
                                ;(15)
       E629                     RBX0:
001530 E629 2A8AEE          16      LD  HL,(_DTA)
001533 E62C 225FEE          16      LD  (DTAX),HL
001536 E62F 2A5DEE          16      LD  HL,(LEFTX)
001539 E632 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00153C E635 D6FD             7      SUB 0FDH
00153E E637 C9              10      RET
                                
       E638                     RBX1:               ;ファイルサイズとランダムレコードを比べる
00153F E638 E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
001540 E639 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
001543 E63C FD6611          19      LD  H,(IY+17)   ;
001546 E63F FD7E12          19      LD  A,(IY+18)   ;
                                
001549 E642 CDBBF5          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
00154C E645 A7               4      AND A
00154D E646 ED52            15      SBC HL,DE
00154F E648 99               4      SBC A,C
001550 E649 4F               4      LD  C,A
001551 E64A FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
001554 E64D 98               4      SBC A,B
001555 E64E D1              10      POP DE
001556 E64F C9              10      RET
       E650                     RBX1R:              ;(8)
001557 E650 47               4      LD  B,A
001558 E651 B1               4      OR  C
001559 E652 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
00155A E653 B2               4      OR  D
00155B E654 B3               4      OR  E
00155C E655 C0              11      RET NZ
00155D E656 37               4      SCF
00155E E657 C9              10      RET
                                
       E658                     RBX2:               ;Cluster settings
00155F E658 FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001562 E65B FD4E23          19      LD  C,(IY+35)
001565 E65E 0600             7      LD  B,0
001567 E660 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00156B E664 2003            12      JR  NZ,RBX3
00156D E666 FD4624          19      LD  B,(IY+36)
       E669                     RBX3:
001570 E669 CDE7F4          17      CALL    RWXR
001573 E66C 3A8EE6          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001576 E66F 3D               4      DEC A
001577 E670 FDA622          19      AND (IY+34)
00157A E673 FDB621          19      OR  (IY+33)
00157D E676 C9              10      RET
                                
       E677                     RBXA:
00157E E677 C5              11      PUSH    BC
00157F E678 D5              11      PUSH    DE
001580 E679 CDFBF2          17      CALL    CLUSTX
001583 E67C CD82E7          17      CALL    DRDX
001586 E67F D1              10      POP DE
001587 E680 C1              10      POP BC
001588 E681 D421E9          17      CALL    NC,GNCLX
00158B E684 D8              11      RET C
00158C E685 ED53FEEF        20      LD  (_CLPS),DE
                                
001590 E689 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
001593 E68C 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       E68D                     SECSZ   EQU $-2
       E68E                     SECSZ_H EQU $-1
001596 E68F 7C               4      LD  A,H
001597 E690 3D               4      DEC A       ;1024=3 / 512=1
001598 E691 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
00159B E694 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
00159C E695 ED42            15      SBC HL,BC       ;残りを計算
                                
00159E E697 ED5B5DEE        20      LD  DE,(LEFTX)
0015A2 E69B ED52            15      SBC HL,DE       ;CP HL,DE
0015A4 E69D 19              11      ADD HL,DE       ;
0015A5 E69E 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
0015A7 E6A0 EB               4      EX  DE,HL
       E6A1                     RBXA1:
0015A8 E6A1 E5              11      PUSH    HL
0015A9 E6A2 2A7EEF          16      LD  HL,(_DTBUF)
0015AC E6A5 09              11      ADD HL,BC
0015AD E6A6 ED5B5FEE        20      LD  DE,(DTAX)
0015B1 E6AA C1              10      POP BC
0015B2 E6AB C9              10      RET
                                
       E6AC                     RBXB:
0015B3 E6AC 2A5FEE          16      LD  HL,(DTAX)
0015B6 E6AF ED5BFEEF        20      LD  DE,(_CLPS)
0015BA E6B3 3A5EEE          13      LD  A,(LEFTX+1)
0015BD E6B6 47               4      LD  B,A
0015BE E6B7 3A8EE6          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E6BA                     RBXB1:
0015C1 E6BA 1F               4      RRA     ;->CF
0015C2 E6BB 3804            12      JR  C,RBXB2
0015C4 E6BD CB38             8      SRL B   ;B=B/2
0015C6 E6BF 18F9            12      JR  RBXB1
       E6C1                     RBXB2:
0015C8 E6C1 78               4      LD  A,B
0015C9 E6C2 B7               4      OR  A
0015CA E6C3 C9              10      RET
                                ;(12)
       E6C4                     RBXC:
0015CB E6C4 ED4B5DEE        20      LD  BC,(LEFTX)
0015CF E6C8 3A8EE6          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
0015D2 E6CB 3D               4      DEC A
0015D3 E6CC A0               4      AND B
0015D4 E6CD 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
0015D5 E6CE B1               4      OR  C
0015D6 E6CF C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E6D0                     DWTC:
0015D7 E6D0 E5              11      PUSH    HL
0015D8 E6D1 21BAEA          10      LD  HL,DWT24B
0015DB E6D4 1804            12      JR  DWTC1
       E6D6                     DRDC:
0015DD E6D6 E5              11      PUSH    HL
0015DE E6D7 21ACEA          10      LD  HL,DRD24B
       E6DA                     DWTC1:
0015E1 E6DA 2234E7          16      LD  (DRWF_MODE),HL
0015E4 E6DD E1              10      POP HL
0015E5 E6DE 3A24E7          13      LD  A,(DRWF_B)
0015E8 E6E1 B7               4      OR  A
0015E9 E6E2 200F            12      JR  NZ,DRDC1
       E6E4                     SAVE_DRWC:
0015EB E6E4 0601             7      LD  B,1
0015ED E6E6 ED4323E7        20      LD  (DRWF_C),BC
0015F1 E6EA ED532AE7        20      LD  (DRWF_E),DE
0015F5 E6EE 222DE7          16      LD  (DRWF_HL),HL
0015F8 E6F1 1820            12      JR  INC_HL_DRWC
       E6F3                     DRDC1:
0015FA E6F3 E5              11      PUSH    HL
0015FB E6F4 212AE7          10      LD  HL,DRWF_E
0015FE E6F7 86               7      ADD A,(HL)
0015FF E6F8 F5              11      PUSH    AF
001600 E6F9 BB               4      CP  E
001601 E6FA 201D            12      JR  NZ,DRDC2
001603 E6FC F1              10      POP AF
001604 E6FD 23               6      INC HL
001605 E6FE 7E               7      LD  A,(HL)
001606 E6FF CE00             7      ADC A,0
001608 E701 F5              11      PUSH    AF
001609 E702 BA               4      CP  D
00160A E703 2014            12      JR  NZ,DRDC2
00160C E705 F1              10      POP AF
00160D E706 3A23E7          13      LD  A,(DRWF_C)
001610 E709 CE00             7      ADC A,0
001612 E70B B9               4      CP  C
001613 E70C 200C            12      JR  NZ,DRDC3
001615 E70E 2124E7          10      LD  HL,DRWF_B
001618 E711 34              11      INC (HL)
001619 E712 E1              10      POP HL
       E713                     INC_HL_DRWC:
00161A E713 3A8EE6          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
00161D E716 84               4      ADD A,H
00161E E717 67               4      LD  H,A
00161F E718 C9              10      RET
       E719                     DRDC2:
001620 E719 F1              10      POP AF
       E71A                     DRDC3:
001621 E71A CD20E7          17      CALL    DRW_FLUSH
001624 E71D E1              10      POP HL
001625 E71E 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E720                     DRW_FLUSH:
001627 E720 C5              11      PUSH    BC
001628 E721 D5              11      PUSH    DE
001629 E722 010000          10      LD  BC,0
       E723                     DRWF_C  EQU $-2
       E724                     DRWF_B  EQU $-1
00162C E725 78               4      LD  A,B
00162D E726 B7               4      OR  A
00162E E727 280D            12      JR  Z,DRDF1
001630 E729 110000          10      LD  DE,0
       E72A                     DRWF_E  EQU $-2
       E72B                     DRWF_D  EQU $-1
001633 E72C 210000          10      LD  HL,0
       E72D                     DRWF_HL EQU $-2
001636 E72F AF               4      XOR A
001637 E730 3224E7          13      LD  (DRWF_B),A
00163A E733 CDACEA          17      CALL    DRD24B
       E734                     DRWF_MODE   EQU $-2
       E736                     DRDF1:
00163D E736 D1              10      POP DE
00163E E737 C1              10      POP BC
00163F E738 C9              10      RET
                                
       E739                     RB_WRITE:
001640 E739 C5              11      PUSH    BC
001641 E73A 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
001643 E73C 1803            12      JR  RBRW
       E73E                     RB_READ:
001645 E73E C5              11      PUSH    BC
001646 E73F 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       E741                     RBRW:
001648 E741 1F               4      RRA     ;AHL = AHL*128
001649 E742 7C               4      LD  A,H ;AHL = AHL0/2
00164A E743 1F               4      RRA     ;A
00164B E744 65               4      LD  H,L ;
00164C E745 CB1C             8      RR  H   ;H
00164E E747 2E00             7      LD  L,0 ;
001650 E749 CB1D             8      RR  L   ;L
001652 E74B CDA0F5          17      CALL    SET_RR_AHL
001655 E74E 218000          10      LD  HL,128
001658 E751 C5              11      PUSH    BC
       E752                     SETSEQ_SWC_RND:
001659 E752 CDCFF5          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
00165C E755 C1              10      POP BC
00165D E756 FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
001661 E75A FDE5            15      PUSH    IY
001663 E75C D1              10      POP DE
001664 E75D D5              11      PUSH    DE
001665 E75E CD63DC          17      CALL    BDOS0
001668 E761 FDE1            14      POP IY
00166A E763 CDAAF5          17      CALL    SETSEQ      ;SETSEQ or POPRR
       E764                     SETSEQ_SWC_SEQ_RR   EQU $-2
00166D E766 FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
001671 E76A C1              10      POP BC
001672 E76B C9              10      RET
                                
                                ;(22)
       E76C                     INIT_SEQ:
001673 E76C 3E01             7      LD  A,1     ;LD BC,????
001675 E76E 21AAF5          10      LD  HL,SETSEQ
001678 E771 CD70F5          17      CALL    PUSHRR
       E774                     GETSEQ:
00167B E774 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
00167E E777 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
001681 E77A AF               4      XOR A
                                
001682 E77B CB25             8      SLA L   ;L=L*2
                                
001684 E77D CB3C             8      SRL H   ;HL=HL/2
001686 E77F CB1D             8      RR  L   ;
001688 E781 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E782                     DRDX:
001689 E782 CDC0E7          17      CALL    DRDY
00168C E785 C8              11      RET Z
00168D E786 CDA6E7          17      CALL    DRDX1       ;データバッファの情報を保存
001690 E789 D8              11      RET C
001691 E78A E5              11      PUSH    HL
001692 E78B C5              11      PUSH    BC
001693 E78C D5              11      PUSH    DE
001694 E78D 2A7EEF          16      LD  HL,(_DTBUF)
001697 E790 3AE9E7          13      LD  A,(_DBS24)
00169A E793 4F               4      LD  C,A
00169B E794 CDAAEA          17      CALL    DRD24
00169E E797 DCBBE7          17      CALL    C,DRDNE
       E79A                     POP_DE_BC_HL_RET:
0016A1 E79A D1              10      POP DE
0016A2 E79B C1              10      POP BC
0016A3 E79C E1              10      POP HL
0016A4 E79D C9              10      RET
                                
                                ;   CDE:セクタ番号
       E79E                     DRDN:
0016A5 E79E AF               4      XOR A
0016A6 E79F 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
0016A7 E7A0 30E0            12      JR  NC,DRDX
       E7A2                     DRDNX:
0016A9 E7A2 CDC0E7          17      CALL    DRDY
0016AC E7A5 C8              11      RET Z
       E7A6                     DRDX1:
0016AD E7A6 CDD6E7          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
0016B0 E7A9 ED53A6EE        20      LD  (_DBSEC),DE
0016B4 E7AD 79               4      LD  A,C
0016B5 E7AE 32E9E7          13      LD  (_DBS24),A
                                
0016B8 E7B1 3A88EE          13      LD  A,(_DRV)
0016BB E7B4 32A5EE          13      LD  (_DBDRV),A
0016BE E7B7 CDD9EE          17      CALL    _CHGDRV
0016C1 E7BA D0              11      RET NC
       E7BB                     DRDNE:
0016C2 E7BB 9F               4      SBC A,A     ;CF=1ならばA=0FFH
0016C3 E7BC 32A5EE          13      LD  (_DBDRV),A
0016C6 E7BF C9              10      RET
                                
                                ;   CDE:セクタ番号
       E7C0                     DRDY:
0016C7 E7C0 3AE9E7          13      LD  A,(_DBS24)
0016CA E7C3 B9               4      CP  C
0016CB E7C4 C0              11      RET NZ
                                
0016CC E7C5 E5              11      PUSH    HL
0016CD E7C6 3A88EE          13      LD  A,(_DRV)
0016D0 E7C9 21A5EE          10      LD  HL,_DBDRV
0016D3 E7CC AE               7      XOR (HL)
0016D4 E7CD 2005            12      JR  NZ,POP_HL_RET
                                
0016D6 E7CF 2AA6EE          16      LD  HL,(_DBSEC)
0016D9 E7D2 ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E7D4                     POP_HL_RET:
0016DB E7D4 E1              10      POP HL
0016DC E7D5 C9              10      RET
                                
       E7D6                     DWTX:
0016DD E7D6 3AA4EE          13      LD  A,(_WTDBF)
0016E0 E7D9 B7               4      OR  A
0016E1 E7DA C8              11      RET Z
0016E2 E7DB AF               4      XOR A
0016E3 E7DC 32A4EE          13      LD  (_WTDBF),A
                                
0016E6 E7DF E5              11      PUSH    HL
0016E7 E7E0 C5              11      PUSH    BC
0016E8 E7E1 D5              11      PUSH    DE
0016E9 E7E2 3AA5EE          13      LD  A,(_DBDRV)
0016EC E7E5 CDD9EE          17      CALL    _CHGDRV
0016EF E7E8 0E00             7      LD  C,0
       E7E9                     _DBS24  EQU $-1
0016F1 E7EA ED5BA6EE        20      LD  DE,(_DBSEC)
0016F5 E7EE 2A7EEF          16      LD  HL,(_DTBUF)
0016F8 E7F1 D4B8EA          17      CALL    NC,DWT24
       E7F4                     POP_DE_BC_HL_RET2:
0016FB E7F4 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E7F6                     RDFATX:
0016FD E7F6 E5              11      PUSH    HL
0016FE E7F7 3A88EE          13      LD  A,(_DRV)
001701 E7FA 21AAEE          10      LD  HL,_FATDRV
001704 E7FD AE               7      XOR (HL)
001705 E7FE 28D4            12      JR  Z,POP_HL_RET
                                
001707 E800 C5              11      PUSH    BC
001708 E801 D5              11      PUSH    DE
001709 E802 DDE5            15      PUSH    IX
00170B E804 CD20E8          17      CALL    WTFATX
00170E E807 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
001710 E809 AF               4      XOR A
001711 E80A 32ABEE          13      LD  (_FATIX),A
001714 E80D 3A88EE          13      LD  A,(_DRV)
001717 E810 32AAEE          13      LD  (_FATDRV),A
00171A E813 CDE5EE          17      CALL    _RDFAT
       E816                     RDFATE2:
00171D E816 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
00171F E818 9F               4      SBC A,A     ;A=0xFF
001720 E819 32AAEE          13      LD  (_FATDRV),A
       E81C                     POP_IX_DE_BC_HL_RET:
001723 E81C DDE1            14      POP IX
001725 E81E 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E820                     WTFATX:
001727 E820 3AA2EE          13      LD  A,(_WTFATF)
00172A E823 B7               4      OR  A
00172B E824 C8              11      RET Z
00172C E825 AF               4      XOR A
00172D E826 32A2EE          13      LD  (_WTFATF),A
                                
001730 E829 E5              11      PUSH    HL
001731 E82A 3AAAEE          13      LD  A,(_FATDRV)
001734 E82D 21A5EE          10      LD  HL,_DBDRV
001737 E830 AE               7      XOR (HL)
001738 E831 CCD6E7          17      CALL    Z,DWTX
00173B E834 389E            12      JR  C,POP_HL_RET
00173D E836 C5              11      PUSH    BC
00173E E837 D5              11      PUSH    DE
00173F E838 DDE5            15      PUSH    IX
001741 E83A CDC9EA          17      CALL    FATSETUP
001744 E83D D4BAEA          17      CALL    NC,DWT24B
001747 E840 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E842                     N16CL1:
001749 E842 7A               4      LD  A,D
00174A E843 B3               4      OR  E
00174B E844 37               4      SCF
00174C E845 C8              11      RET Z
                                
00174D E846 7A               4      LD  A,D
00174E E847 1807            12      JR  NCL1X
       E849                     NCL1:
001750 E849 7A               4      LD  A,D
001751 E84A B3               4      OR  E
001752 E84B 37               4      SCF
001753 E84C C8              11      RET Z
                                
001754 E84D 7A               4      LD  A,D
001755 E84E CB3F             8      SRL A   ;/2
       E850                     NCL1X:
001757 E850 CB3F             8      SRL A   ;/2
                                
001759 E852 E5              11      PUSH    HL
00175A E853 3272E8          13      LD  (NCLPAT_FATIX),A    ;_FATIX
00175D E856 2AAAEE          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001760 E859 BC               4      CP  H
001761 E85A 3A88EE          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001764 E85D 3271E8          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001767 E860 2005            12      JR  NZ,NCL2     ;FATIXが違う
001769 E862 BD               4      CP  L
00176A E863 2002            12      JR  NZ,NCL2     ;ドライブが違う
00176C E865 E1              10      POP HL
00176D E866 C9              10      RET
       E867                     NCL2:
00176E E867 C5              11      PUSH    BC
00176F E868 D5              11      PUSH    DE
001770 E869 DDE5            15      PUSH    IX
001772 E86B CD20E8          17      CALL    WTFATX
001775 E86E 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
001777 E870 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E872                     NCLPAT_FATIX    EQU $-1
       E871                     NCLPAT_FATDRV   EQU $-2
00177A E873 ED43AAEE        20      LD  (_FATDRV),BC
00177E E877 CD9EEA          17      CALL    RDFATS
001781 E87A 189A            12      JR  RDFATE2
                                
       E87C                     NCL3:
001783 E87C CB9A             8      RES 3,D
001785 E87E CB92             8      RES 2,D
001787 E880 6B               4      LD  L,E
001788 E881 62               4      LD  H,D
001789 E882 CB3C             8      SRL H   ;
00178B E884 CB1D             8      RR  L   ;HLA=HLA/2
00178D E886 1F               4      RRA     ;
00178E E887 F5              11      PUSH    AF
00178F E888 3AABEE          13      LD  A,(_FATIX)
001792 E88B 0F               4      RRCA
001793 E88C 300B            12      JR  NC,NCL3X1
001795 E88E 3A8EE6          13      LD  A,(SECSZ_H)
001798 E891 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの際に先頭を512バイトずらす
00179A E893 2004            12      JR  NZ,NCL3X1
00179C E895 010002          10      LD  BC,512
00179F E898 09              11      ADD HL,BC
       E899                     NCL3X1:
0017A0 E899 F1              10      POP AF
0017A1 E89A ED4B7CEF        20      LD  BC,(_FATBF)
0017A5 E89E 19              11      ADD HL,DE
0017A6 E89F 09              11      ADD HL,BC
0017A7 E8A0 17               4      RLA
0017A8 E8A1 C9              10      RET
                                
       E8A2                     GNCL:
0017A9 E8A2 CD49E8          17      CALL    NCL1        ;GET NEXT CLUSTER
0017AC E8A5 D8              11      RET C
0017AD E8A6 C5              11      PUSH    BC
0017AE E8A7 E5              11      PUSH    HL
0017AF E8A8 CD7CE8          17      CALL    NCL3
0017B2 E8AB 3809            12      JR  C,GNC1
0017B4 E8AD 5E               7      LD  E,(HL)
0017B5 E8AE 23               6      INC HL
0017B6 E8AF 7E               7      LD  A,(HL)
0017B7 E8B0 E60F             7      AND 00FH
0017B9 E8B2 57               4      LD  D,A
0017BA E8B3 E1              10      POP HL
0017BB E8B4 C1              10      POP BC
0017BC E8B5 C9              10      RET
       E8B6                     GNC1:
0017BD E8B6 7E               7      LD  A,(HL)
0017BE E8B7 23               6      INC HL
0017BF E8B8 56               7      LD  D,(HL)
0017C0 E8B9 0604             7      LD  B,4
       E8BB                     GNC1L:
0017C2 E8BB CB3A             8      SRL D   ;DA=DA/2
0017C4 E8BD 1F               4      RRA     ;
0017C5 E8BE 10FB            13      DJNZ    GNC1L
                                
0017C7 E8C0 5F               4      LD  E,A
0017C8 E8C1 E1              10      POP HL
0017C9 E8C2 C1              10      POP BC
0017CA E8C3 A7               4      AND A
0017CB E8C4 C9              10      RET
                                
       E8C5                     SNCL:
0017CC E8C5 CD49E8          17      CALL    NCL1
0017CF E8C8 D8              11      RET C
                                ;               SET NEXT CLUSTER
0017D0 E8C9 E5              11      PUSH    HL
0017D1 E8CA C5              11      PUSH    BC
0017D2 E8CB D5              11      PUSH    DE
0017D3 E8CC E5              11      PUSH    HL
0017D4 E8CD CD7CE8          17      CALL    NCL3
0017D7 E8D0 D1              10      POP DE
                                ;CF=ODD
0017D8 E8D1 7E               7      LD  A,(HL)
0017D9 E8D2 73               7      LD  (HL),E
0017DA E8D3 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
0017DC E8D5 23               6      INC HL
0017DD E8D6 ED67            18      RRD     ;M={A[3:0],E[3:0]}
0017DF E8D8 7A               4      LD  A,D
0017E0 E8D9 1804            12      JR  SNC11
       E8DB                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
0017E2 E8DB ED6F            18      RLD     ;M={D[3:0],E[7:4]}
0017E4 E8DD 23               6      INC HL
0017E5 E8DE 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E8DF                     SNC11:
0017E6 E8DF ED6F            18      RLD     ;M={M[7:4],D[3:0]}
0017E8 E8E1 B7               4      OR  A
0017E9 E8E2 D1              10      POP DE
0017EA E8E3 C1              10      POP BC
0017EB E8E4 E1              10      POP HL
       E8E5                     FAT_CHANGED:
0017EC E8E5 3EFF             7      LD  A,0FFH
0017EE E8E7 32A2EE          13      LD  (_WTFATF),A
0017F1 E8EA C9              10      RET
                                
       E8EB                     N16CL3:
0017F2 E8EB C5              11      PUSH    BC
0017F3 E8EC 6B               4      LD  L,E
0017F4 E8ED 7A               4      LD  A,D
0017F5 E8EE E601             7      AND 1
0017F7 E8F0 67               4      LD  H,A
0017F8 E8F1 29              11      ADD HL,HL
0017F9 E8F2 ED4B7CEF        20      LD  BC,(_FATBF)
0017FD E8F6 09              11      ADD HL,BC
0017FE E8F7 C1              10      POP BC
0017FF E8F8 C9              10      RET
                                
       E8F9                     GNCL16:
001800 E8F9 CD42E8          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
001803 E8FC D8              11      RET C
001804 E8FD E5              11      PUSH    HL
001805 E8FE CDEBE8          17      CALL    N16CL3
001808 E901 5E               7      LD  E,(HL)
001809 E902 23               6      INC HL
00180A E903 56               7      LD  D,(HL)
00180B E904 E1              10      POP HL
00180C E905 C9              10      RET
                                
       E906                     SNCL16:
00180D E906 CD42E8          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
001810 E909 D8              11      RET C
001811 E90A D5              11      PUSH    DE
001812 E90B E5              11      PUSH    HL
001813 E90C CDEBE8          17      CALL    N16CL3
001816 E90F D1              10      POP DE      ;HL
001817 E910 73               7      LD  (HL),E
001818 E911 23               6      INC HL
001819 E912 72               7      LD  (HL),D
00181A E913 6B               4      LD  L,E
00181B E914 62               4      LD  H,D
00181C E915 D1              10      POP DE
00181D E916 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E918                     NEXTX:
00181F E918 3E00             7      LD  A,0 ;自己書き換え
       E919                     _SECPS  EQU $-1
001821 E91A 3C               4      INC A
001822 E91B E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E91C                     _NCPAT  EQU $-1
001824 E91D 3219E9          13      LD  (_SECPS),A
001827 E920 C9              10      RET
                                
       E921                     GNCLX:
001828 E921 CD18E9          17      CALL    NEXTX
00182B E924 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
00182C E925 C3F7EE          10      JP  _GNCL   ;次のクラスタを探す
                                
       E928                     RDFAT:
00182F E928 3E80             7      LD  A,080H
001831 E92A 3270EE          13      LD  (CHECK),A
       E92D                     RDFAT1:
001834 E92D 3A88EE          13      LD  A,(_DRV)
001837 E930 CDD2EB          17      CALL    CHGDRVR
00183A E933 D8              11      RET C
00183B E934 DD7E12          19      LD  A,(IX+DPB_DEVICE)
00183E E937 CB6F             8      BIT 5,A
001840 E939 286E            12      JR  Z,RDFAT0X
001842 E93B 2170EE          10      LD  HL,CHECK
001845 E93E A6               7      AND (HL)
001846 E93F 77               7      LD  (HL),A
001847 E940 110000          10      LD  DE,0        ;BPB
00184A E943 2A7CEF          16      LD  HL,(_FATBF)
00184D E946 0E00             7      LD  C,0
00184F E948 CDAAEA          17      CALL    DRD24
001852 E94B 3022            12      JR  NC,GETBPB
001854 E94D 2170EE          10      LD  HL,CHECK
001857 E950 CB06            15      RLC (HL)
001859 E952 3F               4      CCF
00185A E953 D8              11      RET C
00185B E954 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
00185F E958 3F               4      CCF         ;フロッピーディスクのFDモード(2D/2HD)を切り替える
001860 E959 DDCB0A16        23      RL  (IX+DPB_FDMODE)
001864 E95D 3A84EE          13      LD  A,(_DRIVE)
001867 E960 E603             7      AND 3
001869 E962 F680             7      OR  080H
00186B E964 6F               4      LD  L,A
00186C E965 26EE             7      LD  H,_CYL0/256
00186E E967 3EFF             7      LD  A,0FFH
001870 E969 3289EE          13      LD  (_DSK),A
001873 E96C 77               7      LD  (HL),A
001874 E96D 18BE            12      JR  RDFAT1
       E96F                     GETBPB:
001876 E96F FDE5            15      PUSH    IY
001878 E971 FD2A7CEF        20      LD  IY,(_FATBF) ;BPB
00187C E975 CDF1EE          17      CALL    _BPB2DPB
00187F E978 FDE1            14      POP IY
001881 E97A DD7E12          19      LD  A,(IX+DPB_DEVICE)
001884 E97D 3027            12      JR  NC,GETBPBOK
001886 E97F E60F             7      AND 00FH
001888 E981 FE07             7      CP  7
00188A E983 37               4      SCF
00188B E984 C0              11      RET NZ
00188C E985 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001890 E989 21C0EF          10      LD  HL,M2D
001893 E98C 2008            12      JR  NZ,SETFDMODE
001895 E98E 2E04             7      LD  L,4
001897 E990 CD93EA          17      CALL    CHECK_MAXSECSZ
00189A E993 D8              11      RET C
00189B E994 2ED2             7      LD  L,M2HD-STABLE
       E996                     SETFDMODE:
00189D E996 DDE5            15      PUSH    IX
00189F E998 D1              10      POP DE
0018A0 E999 EDA0            16      LDI
0018A2 E99B EDA0            16      LDI
0018A4 E99D 13               6      INC DE
0018A5 E99E 13               6      INC DE
0018A6 E99F 13               6      INC DE
0018A7 E9A0 13               6      INC DE
0018A8 E9A1 010C00          10      LD  BC,12
0018AB E9A4 EDB0                    LDIR
       E9A6                     GETBPBOK:
0018AD E9A6 CD3EEB          17      CALL    CHGDRV2
       E9A9                     RDFAT0X:
0018B0 E9A9 CD9EEA          17      CALL    RDFATS
0018B3 E9AC D8              11      RET C
0018B4 E9AD DDAE06          19      XOR (IX+DPB_FATID)
0018B7 E9B0 C8              11      RET Z
0018B8 E9B1 DD7E12          19      LD  A,(IX+DPB_DEVICE)
0018BB E9B4 CB5F             8      BIT 3,A
0018BD E9B6 2803            12      JR  Z,RDFAT0X1
0018BF E9B8 CB6F             8      BIT 5,A
0018C1 E9BA C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E9BB                     RDFAT0X1:
0018C2 E9BB 37               4      SCF
0018C3 E9BC C9              10      RET
                                
       E9BD                     POP_HL_SCF_RET:
0018C4 E9BD E1              10      POP HL
0018C5 E9BE 37               4      SCF
0018C6 E9BF C9              10      RET
                                
       E9C0                     BPB2DPB:
0018C7 E9C0 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
0018CA E9C3 B7               4      OR  A
0018CB E9C4 37               4      SCF
0018CC E9C5 C0              11      RET NZ
       E9C6                     BPBOK:
0018CD E9C6 FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
0018D0 E9C9 DD7707          19      LD  (IX+DPB_SECPCL),A
                                
0018D3 E9CC FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
0018D6 E9CF DD7700          19      LD  (IX+DPB_FATLN),A
0018D9 E9D2 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
0018DC E9D5 DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
0018DF E9D8 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
0018E2 E9DB FD660F          19      LD  H,(IY+15)
0018E5 E9DE DD750E          19      LD  (IX+DPB_FATPS),L
0018E8 E9E1 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
0018EB E9E4 FD5617          19      LD  D,(IY+23)
0018EE E9E7 FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E9EA                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
0018F1 E9EA 19              11      ADD HL,DE
0018F2 E9EB 10FD            13      DJNZ    BPBDP1
       E9ED                     BPBDP2:
0018F4 E9ED DD7510          19      LD  (IX+DPB_DIRPS),L
0018F7 E9F0 DD7411          19      LD  (IX+DPB_DIRPS+1),H
0018FA E9F3 E5              11      PUSH    HL
                                
0018FB E9F4 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
0018FE E9F7 FD6612          19      LD  H,(IY+18)
001901 E9FA FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001904 E9FD B7               4      OR  A
001905 E9FE 28BD            12      JR  Z,POP_HL_SCF_RET
001907 EA00 0606             7      LD  B,6
       EA02                     BPBBPS1:
001909 EA02 05               4      DEC B
00190A EA03 0F               4      RRCA
00190B EA04 30FC            12      JR  NC,BPBBPS1
       EA06                     BPBDE1:
00190D EA06 29              11      ADD HL,HL
00190E EA07 10FD            13      DJNZ    BPBDE1
                                
001910 EA09 7C               4      LD  A,H
001911 EA0A DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
001914 EA0D D1              10      POP DE      ;DPB_DIRPS
001915 EA0E 6C               4      LD  L,H
001916 EA0F 2600             7      LD  H,0
001918 EA11 19              11      ADD HL,DE       ;MAXDIR
001919 EA12 E5              11      PUSH    HL
00191A EA13 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
00191D EA16 CB21             8      SLA C       ;*2
00191F EA18 AF               4      XOR A
001920 EA19 47               4      LD  B,A
001921 EA1A ED42            15      SBC HL,BC
001923 EA1C DD7514          19      LD  (IX+DPB_ADDCL),L
001926 EA1F DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
001929 EA22 D1              10      POP DE      ;DE=DPB_MAXDIR
00192A EA23 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
00192D EA26 FD6614          19      LD  H,(IY+20)
                                
001930 EA29 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001933 EA2C E60F             7      AND 00FH
001935 EA2E FE07             7      CP  7       ;フロッピー
001937 EA30 2019            12      JR  NZ,NOT_FD
001939 EA32 E5              11      PUSH    HL
00193A EA33 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
00193D EA36 DD710D          19      LD  (IX+DPB_MAXSEC),C
001940 EA39 AF               4      XOR A
001941 EA3A CB21             8      SLA C       ;両面なのでセクタ数を２倍
001943 EA3C 0610             7      LD  B,16
       EA3E                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001945 EA3E 29              11      ADD HL,HL
001946 EA3F 17               4      RLA
001947 EA40 B9               4      CP  C
001948 EA41 3802            12      JR  C,DIVSEC1
00194A EA43 91               4      SUB C
00194B EA44 2C               4      INC L
       EA45                     DIVSEC1:
00194C EA45 10F7            13      DJNZ    DIVSEC
00194E EA47 DD750C          19      LD  (IX+DPB_MAXCYL),L
001951 EA4A E1              10      POP HL  ;ここまでフロッピー専用
       EA4B                     NOT_FD:
001952 EA4B 7C               4      LD  A,H
001953 EA4C B5               4      OR  L
001954 EA4D 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001956 EA4F 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001958 EA51 2F               4      CPL         ;A=0FFH
001959 EA52 FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
00195C EA55 D8              11      RET C
00195D EA56 FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001960 EA59 FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001963 EA5C FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       EA5F                     BPB16BIT:
001966 EA5F ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001968 EA61 DE00             7      SBC A,0
00196A EA63 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       EA66                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
00196D EA66 CB18             8      RR  B       ;->CY
00196F EA68 3808            12      JR  C,BPBTC2
001971 EA6A CB3F             8      SRL A
001973 EA6C CB1C             8      RR  H       ;AHL=AHL/2
001975 EA6E CB1D             8      RR  L
001977 EA70 18F4            12      JR  BPBTC1
       EA72                     BPBTC2:
001979 EA72 C6FF             7      ADD A,0FFH
00197B EA74 D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
00197C EA75 23               6      INC HL
00197D EA76 23               6      INC HL
00197E EA77 DD7508          19      LD  (IX+DPB_MAXCL),L
001981 EA7A DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001984 EA7D FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001987 EA80 DD7706          19      LD  (IX+DPB_FATID),A
                                
00198A EA83 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
00198D EA86 C6FE             7      ADD A,0-2       ;>2:CF=1
00198F EA88 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001992 EA8B 6F               4      LD  L,A
001993 EA8C 3002            12      JR  NC,BPBFAT1
001995 EA8E F680             7      OR  080H
       EA90                     BPBFAT1:            ;ここではCF=0
001997 EA90 DD770F          19      LD  (IX+DPB_BPS),A
       EA93                     CHECK_MAXSECSZ:
00199A EA93 3A7BEF          13      LD  A,(_MAX_SEC_SZ_H)
00199D EA96 BD               4      CP  L
00199E EA97 C8              11      RET Z       ;1セクタ1024バイト
00199F EA98 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
0019A0 EA99 C8              11      RET Z       ;1セクタ256バイト
0019A1 EA9A 2D               4      DEC L
0019A2 EA9B C8              11      RET Z       ;1セクタ512バイト
0019A3 EA9C 37               4      SCF
0019A4 EA9D C9              10      RET
                                
       EA9E                     RDFATS:
0019A5 EA9E CDC9EA          17      CALL    FATSETUP
0019A8 EAA1 D8              11      RET C
0019A9 EAA2 CDACEA          17      CALL    DRD24B
0019AC EAA5 2A7CEF          16      LD  HL,(_FATBF)
0019AF EAA8 7E               7      LD  A,(HL)
0019B0 EAA9 C9              10      RET
                                
       EAAA                     DRD24:
0019B1 EAAA 0601             7      LD  B,1
       EAAC                     DRD24B:
0019B3 EAAC DDE5            15      PUSH    IX
0019B5 EAAE DD2AA8EE        20      LD  IX,(_DPB)
0019B9 EAB2 CDF3EC          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       EAB3                     DRDPAT  EQU $-2
0019BC EAB5 DDE1            14      POP IX
0019BE EAB7 C9              10      RET
                                
       EAB8                     DWT24:
0019BF EAB8 0601             7      LD  B,1
       EABA                     DWT24B:
0019C1 EABA DDE5            15      PUSH    IX
0019C3 EABC DD2AA8EE        20      LD  IX,(_DPB)
0019C7 EAC0 CDE5EC          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       EAC1                     DWTPAT  EQU $-2
0019CA EAC3 DDE1            14      POP IX
0019CC EAC5 D0              11      RET NC
0019CD EAC6 C35AEE          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       EAC9                     FATSETUP:
0019D0 EAC9 3AAAEE          13      LD  A,(_FATDRV)
0019D3 EACC CDD2EB          17      CALL    CHGDRVR     ;ドライブ切り替え
0019D6 EACF D8              11      RET C
       EAD0                     FATS2:
0019D7 EAD0 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
0019DA EAD3 0F               4      RRCA
0019DB EAD4 CD04EB          17      CALL    FATSETUP12  ;自己書き換え
       EAD5                     FATSX   EQU $-2
0019DE EAD7 210000          10      LD  HL,0
0019E1 EADA 4A               4      LD  C,D
0019E2 EADB 54               4      LD  D,H
0019E3 EADC 3AABEE          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
0019E6 EADF 47               4      LD  B,A
0019E7 EAE0 04               4      INC B
0019E8 EAE1 DD7E00          19      LD  A,(IX+DPB_FATLN)
       EAE4                     FAT_SKP:
0019EB EAE4 05               4      DEC B
0019EC EAE5 2809            12      JR  Z,FAT1
0019EE EAE7 19              11      ADD HL,DE
0019EF EAE8 93               4      SUB E
0019F0 EAE9 30F9            12      JR  NC,FAT_SKP
0019F2 EAEB DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
0019F6 EAEF C8              11      RET Z
       EAF0                     FAT1:
0019F7 EAF0 EB               4      EX  DE,HL
0019F8 EAF1 B7               4      OR  A       ;0の場合は0100Hとして扱う
0019F9 EAF2 2803            12      JR  Z,FAT3
0019FB EAF4 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
0019FC EAF5 3801            12      JR  C,FAT2
       EAF7                     FAT3:
0019FE EAF7 79               4      LD  A,C
       EAF8                     FAT2:
0019FF EAF8 47               4      LD  B,A
                                
001A00 EAF9 2AFAEF          16      LD  HL,(_FATPS) ;fat sector pos
001A03 EAFC 19              11      ADD HL,DE
001A04 EAFD EB               4      EX  DE,HL
001A05 EAFE 2A7CEF          16      LD  HL,(_FATBF)
001A08 EB01 AF               4      XOR A       ;CF=0
001A09 EB02 4F               4      LD  C,A
001A0A EB03 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       EB04                     FATSETUP12:
001A0B EB04 110606          10      LD  DE,0606H    ;256
001A0E EB07 D8              11      RET C
001A0F EB08 110303          10      LD  DE,0303H    ;512
001A12 EB0B 0F               4      RRCA
001A13 EB0C D8              11      RET C
001A14 EB0D 110102          10      LD  DE,0201H    ;1024
001A17 EB10 C9              10      RET
                                
       EB11                     FATSETUP16:
001A18 EB11 110404          10      LD  DE,0404H    ;256
001A1B EB14 D8              11      RET C
001A1C EB15 110202          10      LD  DE,0202H    ;512
001A1F EB18 0F               4      RRCA
001A20 EB19 D8              11      RET C
001A21 EB1A 110101          10      LD  DE,0101H    ;1024
001A24 EB1D C9              10      RET
                                
       EB1E                     CHGDRV:
001A25 EB1E E5              11      PUSH    HL
001A26 EB1F 2189EE          10      LD  HL,_DSK
001A29 EB22 BE               7      CP  (HL)
001A2A EB23 280A            12      JR  Z,CHGDRVE
       EB25                     CHGDRV1:
001A2C EB25 DDE5            15      PUSH    IX
001A2E EB27 CD31EB          17      CALL    CHGDRV0
001A31 EB2A 3A89EE          13      LD  A,(_DSK)
001A34 EB2D DDE1            14      POP IX
       EB2F                     CHGDRVE:
001A36 EB2F E1              10      POP HL
001A37 EB30 C9              10      RET
                                
       EB31                     CHGDRV0:
001A38 EB31 6F               4      LD  L,A
001A39 EB32 CDDCEE          17      CALL    _GETDPB
001A3C EB35 D8              11      RET C
001A3D EB36 DD22A8EE        20      LD  (_DPB),IX
001A41 EB3A 7D               4      LD  A,L
001A42 EB3B 3289EE          13      LD  (_DSK),A
       EB3E                     CHGDRV2:
001A45 EB3E C5              11      PUSH    BC
001A46 EB3F D5              11      PUSH    DE
001A47 EB40 ED7389EB        20      LD  (SPPAT2),SP
001A4B EB44 F3               4      DI
001A4C EB45 DDF9            10      LD  SP,IX
                                
001A4E EB47 E1              10      POP HL      ;00:DPB_FATLN
001A4F EB48 E1              10      POP HL      ;02:DPB_DRD
001A50 EB49 22B3EA          16      LD  (DRDPAT),HL
                                
001A53 EB4C E1              10      POP HL
001A54 EB4D 22C1EA          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001A57 EB50 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001A58 EB51 7C               4      LD  A,H
001A59 EB52 32FFF2          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001A5C EB55 3D               4      DEC A
001A5D EB56 321CE9          13      LD  (_NCPAT),A
                                
001A60 EB59 E1              10      POP HL      ;08:DPB_MAXCL
001A61 EB5A 7D               4      LD  A,L
001A62 EB5B 321EF3          13      LD  (CLPAT2),A
001A65 EB5E 7C               4      LD  A,H
001A66 EB5F 321AF3          13      LD  (CLPAT1),A
001A69 EB62 2B               6      DEC HL
001A6A EB63 221DF5          16      LD  (MAXCLP),HL
                                
001A6D EB66 E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001A6E EB67 4C               4      LD  C,H
                                
001A6F EB68 E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001A70 EB69 E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001A71 EB6A 7C               4      LD  A,H     ;DPB_BPS
001A72 EB6B E607             7      AND 7
001A74 EB6D 328EE6          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001A77 EB70 87               4      ADD A,A     ;8  4   2
001A78 EB71 87               4      ADD A,A     ;010H   8   4
001A79 EB72 87               4      ADD A,A     ;020H   010H    8
001A7A EB73 327DF1          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001A7D EB76 2600             7      LD  H,0
001A7F EB78 22FAEF          16      LD  (_FATPS),HL
                                
001A82 EB7B E1              10      POP HL      ;10:DPB_DIRPS
001A83 EB7C 22FCEF          16      LD  (_DIRPS),HL
                                
001A86 EB7F E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001A87 EB80 7C               4      LD  A,H
001A88 EB81 3284EE          13      LD  (_DRIVE),A
                                
001A8B EB84 E1              10      POP HL      ;14:DPB_ADDCL
001A8C EB85 220FF3          16      LD  (CLSPAT),HL
                                
001A8F EB88 310000          10      LD  SP,0        ;元のSPを復元
       EB89                     SPPAT2  EQU $-2
001A92 EB8B FB               4      EI
001A93 EB8C 2AFCEF          16      LD  HL,(_DIRPS)
001A96 EB8F 0600             7      LD  B,0
001A98 EB91 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001A99 EB92 2298F1          16      LD  (MD_PAT),HL
                                
001A9C EB95 2A1DF5          16      LD  HL,(MAXCLP)
001A9F EB98 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001AA2 EB9B 19              11      ADD HL,DE
001AA3 EB9C 380F            12      JR  C,SETFAT16
001AA5 EB9E 21A2E8          10      LD  HL,GNCL     ;FAT12
001AA8 EBA1 11C5E8          10      LD  DE,SNCL
001AAB EBA4 0104EB          10      LD  BC,FATSETUP12
001AAE EBA7 DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001AB2 EBAB 180D            12      JR  EXTRA1
       EBAD                     SETFAT16:
001AB4 EBAD 21F9E8          10      LD  HL,GNCL16   ;FAT16
001AB7 EBB0 1106E9          10      LD  DE,SNCL16
001ABA EBB3 0111EB          10      LD  BC,FATSETUP16
001ABD EBB6 DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       EBBA                     EXTRA1:
001AC1 EBBA 22F8EE          16      LD  (GNCPAT),HL
001AC4 EBBD ED53FBEE        20      LD  (SNCPAT),DE
001AC8 EBC1 ED43D5EA        20      LD  (FATSX),BC
001ACC EBC5 D1              10      POP DE
001ACD EBC6 C1              10      POP BC
001ACE EBC7 AF               4      XOR A
001ACF EBC8 C9              10      RET
                                
       EBC9                     GETDPBD:
001AD0 EBC9 DDE3            23      EX  (SP),IX
001AD2 EBCB DDE5            15      PUSH    IX
001AD4 EBCD 3A88EE          13      LD  A,(_DRV)
001AD7 EBD0 1807            12      JR  GETDPB1
                                
       EBD2                     CHGDRVR:
001AD9 EBD2 CDD9EE          17      CALL    _CHGDRV
001ADC EBD5 D8              11      RET C
001ADD EBD6 3A89EE          13      LD  A,(_DSK)
       EBD9                     GETDPB1:
001AE0 EBD9 C3DCEE          10      JP  _GETDPB
                                
       EBDC                     GETDPB:
001AE3 EBDC FE08             7      CP  8
001AE5 EBDE 3F               4      CCF
001AE6 EBDF D8              11      RET C
001AE7 EBE0 0F               4      RRCA
001AE8 EBE1 0F               4      RRCA
001AE9 EBE2 0F               4      RRCA
001AEA EBE3 DD                      DB  0DDH        ;Z80未定義命令
001AEB EBE4 6F               4      LD  L,A     ;LD IXL,A
001AEC EBE5 DD                      DB  0DDH        ;Z80未定義命令
001AED EBE6 26F6             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001AEF EBE8 DD7E00          19      LD  A,(IX+DPB_FATLN)
001AF2 EBEB A7               4      AND A       ;CF=0の為
001AF3 EBEC DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001AF7 EBF0 C0              11      RET NZ      ;FAT16
001AF8 EBF1 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001AFC EBF5 C0              11      RET NZ      ;BPB
001AFD EBF6 FE01             7      CP  001H        ;A=0 THEN CF=1
001AFF EBF8 C9              10      RET
                                
       EBF9                     _SYS5F:
001B00 EBF9 AF               4      XOR A
       EBFA                     FFLUSH:
001B01 EBFA F5              11      PUSH    AF
001B02 EBFB CD20E8          17      CALL    WTFATX
001B05 EBFE AF               4      XOR A
001B06 EBFF 32ABEE          13      LD  (_FATIX),A
001B09 EC02 2F               4      CPL         ;0FFH
001B0A EC03 32AAEE          13      LD  (_FATDRV),A
001B0D EC06 3E                      DB  03EH        ;次のPUSH AFをスキップ
       EC07                     FFLUSHBUF:
001B0E EC07 F5              11      PUSH    AF
001B0F EC08 CDD6E7          17      CALL    DWTX
001B12 EC0B 3EFF             7      LD  A,0FFH
001B14 EC0D 3239EE          13      LD  (SFILE),A
001B17 EC10 32A5EE          13      LD  (_DBDRV),A
001B1A EC13 F1              10      POP AF
001B1B EC14 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "X1DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   X1/turbo/Z
                                
       EC15                     SEEK:
001B1C EC15 0610             7      LD  B,16
001B1E EC17 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001B21 EC1A AF               4      XOR A
001B22 EC1B EB               4      EX  DE,HL
       EC1C                     DIV1:
001B23 EC1C 29              11      ADD HL,HL
001B24 EC1D 8F               4      ADC A,A
001B25 EC1E B9               4      CP  C
001B26 EC1F 3802            12      JR  C,DIV2
001B28 EC21 91               4      SUB C
001B29 EC22 2C               4      INC L
       EC23                     DIV2:
001B2A EC23 10F7            13      DJNZ    DIV1
                                
001B2C EC25 3C               4      INC A   ;最小のセクタは１固定
001B2D EC26 55               4      LD  D,L ;TRACK
001B2E EC27 5F               4      LD  E,A ;SECTOR
001B2F EC28 CB3A             8      SRL D   ;CYLINDER
001B31 EC2A 9F               4      SBC A,A
001B32 EC2B E610             7      AND 010H    ;SIDE
001B34 EC2D 4F               4      LD  C,A
                                
001B35 EC2E 3A84EE          13      LD  A,(_DRIVE)
001B38 EC31 E603             7      AND 3
001B3A EC33 B1               4      OR  C
001B3B EC34 3284EE          13      LD  (_DRIVE),A  ;サイド選択とドライブを保存
001B3E EC37 01FC0F          10      LD  BC,00FFCH   ;モーター制御、サイド選択、 ドライブ選択
001B41 EC3A F680             7      OR  080H        ;Motor on
001B43 EC3C ED79            12      OUT (C),A
                                
001B45 EC3E CD85EC          17      CALL    SETMODE
001B48 EC41 D8              11      RET C
                                
001B49 EC42 CDCFEC          17      CALL    DRIVE
001B4C EC45 FEFF             7      CP  0FFH        ;A=0FFH Unknown CYLINDER
001B4E EC47 CCAAEC          17      CALL    Z,FDCRES    ;Restore
001B51 EC4A 0EF9             7      LD  C,0F9H      ;MB8877A トラックレジスタ
001B53 EC4C ED79            12      OUT (C),A       ;Currrent CYLINDER
001B55 EC4E 92               4      SUB D
001B56 EC4F C8              11      RET Z       ;No seek シークの必要なし
                                
001B57 EC50 3A86EE          13      LD  A,(_ISEEK)
001B5A EC53 4F               4      LD  C,A
                                
001B5B EC54 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)
001B5E EC57 3D               4      DEC A
001B5F EC58 BA               4      CP  D       ;Over CYLINDER
001B60 EC59 D8              11      RET C
                                
001B61 EC5A B9               4      CP  C
001B62 EC5B 3809            12      JR  C,SETM2     ;2D
001B64 EC5D DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001B68 EC61 2803            12      JR  Z,SETM2     ;2HD
001B6A EC63 78               4      LD  A,B     ;2DD
001B6B EC64 DBFE            11      IN  A,(0FEH)    ;1.6M(2HD) タイプ指定 (turbo/Z/CZ-8BF1のみ)
       EC66                     SETM2:
001B6D EC66 0EFB             7      LD  C,0FBH      ;MB8877A データレジスタ
001B6F EC68 ED51            12      OUT (C),D
001B71 EC6A 72               7      LD  (HL),D
001B72 EC6B 0E18             7      LD  C,018H      ;FDC TypeIコマンド Seek
       EC6D                     FDCCMD2:
001B74 EC6D 3A85EE          13      LD  A,(_SEEKSP)
001B77 EC70 B1               4      OR  C
                                
       EC71                     FDCCMD:
001B78 EC71 CDC5EC          17      CALL    COMSET
                                
001B7B EC74 3E80             7      LD  A,080H      ;FDC COMMAND(Self-modifying code)
       EC75                     FDCSWC  EQU $-1
001B7D EC76 E620             7      AND 020H        ;Write data Write track
001B7F EC78 3C               4      INC A
                                
       EC79                     SST:
001B80 EC79 0E00             7      LD  C,0
       EC7B                     SST1:
001B82 EC7B 0D               4      DEC C       ; 4
001B83 EC7C 20FD            12      JR  NZ,SST1     ;12 * 256 / 4 = About 1ms
001B85 EC7E 3D               4      DEC A
001B86 EC7F 20FA            12      JR  NZ,SST1
                                
001B88 EC81 3C               4      INC A       ;A=1
001B89 EC82 CD92EC          17      CALL    READY
       EC85                     SETMODE:
001B8C EC85 DD4E0A          19      LD  C,(IX+DPB_FDMODE)   ;フロッピーディスクのモード
001B8F EC88 ED78            12      IN  A,(C)
                                
001B91 EC8A 78               4      LD  A,B
001B92 EC8B DBFD            11      IN  A,(0FDH)    ;MFM 方式指定
                                
001B94 EC8D CDC9EC          17      CALL    DELAY0      ;Head select time
001B97 EC90 3E81             7      LD  A,081H      ;NOT READY,BUSY
       EC92                     READY:
001B99 EC92 E5              11      PUSH    HL
001B9A EC93 67               4      LD  H,A
001B9B EC94 0EF8             7      LD  C,0F8H      ;MB8877A ステータス／コマンドレジスタ
001B9D EC96 69               4      LD  L,C
       EC97                     READY2:
001B9E EC97 ED78            12      IN  A,(C)
001BA0 EC99 A4               4      AND H
001BA1 EC9A 280C            12      JR  Z,READYE
001BA3 EC9C 3E1A             7      LD  A,1AH
001BA5 EC9E DB01            11      IN  A,(01H)
001BA7 ECA0 07               4      RLCA
001BA8 ECA1 AD               4      XOR L
001BA9 ECA2 0F               4      RRCA
001BAA ECA3 30F2            12      JR  NC,READY2
001BAC ECA5 2D               4      DEC L
001BAD ECA6 20EF            12      JR  NZ,READY2
       ECA8                     READYE:
001BAF ECA8 E1              10      POP HL
001BB0 ECA9 C9              10      RET
                                
       ECAA                     FDCRES:
001BB1 ECAA 3600            10      LD  (HL),0
001BB3 ECAC 0E08             7      LD  C,8     ;FDC TypeIコマンド Restore
001BB5 ECAE 18BD            12      JR  FDCCMD2
                                
       ECB0                     FDMOFF:
001BB7 ECB0 F5              11      PUSH    AF
001BB8 ECB1 C5              11      PUSH    BC      ;Motor off
001BB9 ECB2 01FC0F          10      LD  BC,00FFCH   ;モーター制御、サイド選択、 ドライブ選択
001BBC ECB5 3A84EE          13      LD  A,(_DRIVE)
001BBF ECB8 ED79            12      OUT (C),A
001BC1 ECBA C1              10      POP BC
001BC2 ECBB F1              10      POP AF
001BC3 ECBC C9              10      RET
                                
       ECBD                     SECSET_FDCCMD:
001BC4 ECBD 3A75EC          13      LD  A,(FDCSWC)
       ECC0                     SECSET:
001BC7 ECC0 01FA0F          10      LD  BC,00FFAH   ;MB8877A セレクタレジスタ
001BCA ECC3 ED59            12      OUT (C),E
       ECC5                     COMSET:
001BCC ECC5 0EF8             7      LD  C,0F8H      ;MB8877A ステータス／コマンドレジスタ
001BCE ECC7 ED79            12      OUT (C),A
       ECC9                     DELAY0:
001BD0 ECC9 3E1A             7      LD  A,26
       ECCB                     DELAY:
001BD2 ECCB 3D               4      DEC A
001BD3 ECCC 20FD            12      JR  NZ,DELAY
001BD5 ECCE C9              10      RET
                                
       ECCF                     DRIVE:                  ;ドライブのシリンダを得る
001BD6 ECCF DD6E13          19      LD  L,(IX+DPB_UNITNO)
001BD9 ECD2 26EE             7      LD  H,_CYL0/256
001BDB ECD4 CBFD             8      SET 7,L
001BDD ECD6 7E               7      LD  A,(HL)
001BDE ECD7 C9              10      RET
                                
       ECD8                     RNF:                    ;ドライブのシリンダをリセット
001BDF ECD8 CDCFEC          17      CALL    DRIVE
001BE2 ECDB 36FF            10      LD  (HL),0FFH
001BE4 ECDD C9              10      RET
                                
001BE5 ECDE 02                  RETRY:  DB  2
                                
                                
                                ;   FLOPPY DISK DRIVER(DMA)
                                
                                
       ECDF                     WTTRK:
001BE6 ECDF 0601             7      LD  B,1
001BE8 ECE1 3EF4             7      LD  A,0F4H      ;FDC TypeIIIコマンド Write Track
001BEA ECE3 1802            12      JR  WTTRK1
       ECE5                     FDWT:
001BEC ECE5 3EA0             7      LD  A,0A0H      ;FDC TypeIIコマンド Write Sector
       ECE7                     WTTRK1:
001BEE ECE7 3275EC          13      LD  (FDCSWC),A
001BF1 ECEA 3E79             7      LD  A,079H      ;WR0 ポートB←ポートB 転送  （書き込み）
001BF3 ECEC 180C            12      JR  DISK
                                
       ECEE                     DISKOK:
001BF5 ECEE 0601             7      LD  B,1
       ECEF                     FDCNT   EQU $-1
001BF7 ECF0 100B            13      DJNZ    DISK1
001BF9 ECF2 C9              10      RET
                                
       ECF3                     FDRD:
001BFA ECF3 3E80             7      LD  A,080H      ;FDC TypeIIコマンド Read Sector
001BFC ECF5 3275EC          13      LD  (FDCSWC),A
001BFF ECF8 3E7D             7      LD  A,07DH      ;WR0 ポートA→ポートB 転送  （読み込み)
                                
       ECFA                     DISK:
001C01 ECFA 325AED          13      LD  (DMASWC),A
       ECFD                     DISK1:
001C04 ECFD 78               4      LD  A,B
001C05 ECFE 32EFEC          13      LD  (FDCNT),A
001C08 ED01 2264ED          16      LD  (DMAHL),HL
       ED04                     DISKR:
001C0B ED04 3E02             7      LD  A,2     ;Retry count
001C0D ED06 32DEEC          13      LD  (RETRY),A
       ED09                     DISK2:
001C10 ED09 D5              11      PUSH    DE
001C11 ED0A CD15EC          17      CALL    SEEK
001C14 ED0D 383E            12      JR  C,ERRF
001C16 ED0F F3               4      DI
                                
001C17 ED10 3E0F             7      LD  A,DMAE-DMAD
001C19 ED12 2159ED          10      LD  HL,DMAD
001C1C ED15 CDC9E3          17      CALL    SETDMA
001C1F ED18 C5              11      PUSH    BC
001C20 ED19 CDBDEC          17      CALL    SECSET_FDCCMD
001C23 ED1C 2A64ED          16      LD  HL,(DMAHL)
001C26 ED1F 23               6      INC HL
001C27 ED20 1106BB          10      LD  DE,0BB06H   ;READ DMA
                                
001C2A ED23 3E03             7      LD  A,3
001C2C ED25 CD92EC          17      CALL    READY
001C2F ED28 ED78            12      IN  A,(C)
                                
001C31 ED2A C1              10      POP BC
001C32 ED2B ED51            12      OUT (C),D       ;読み出しマスク設定
001C34 ED2D ED59            12      OUT (C),E       ;バイトカウンタ(LH)
001C36 ED2F ED58            12      IN  E,(C)
001C38 ED31 ED50            12      IN  D,(C)
001C3A ED33 19              11      ADD HL,DE
001C3B ED34 D1              10      POP DE
001C3C ED35 13               6      INC DE
001C3D ED36 FB               4      EI
001C3E ED37 CDB0EC          17      CALL    FDMOFF
001C41 ED3A B7               4      OR  A
001C42 ED3B 28B1            12      JR  Z,DISKOK
001C44 ED3D 1B               6      DEC DE
001C45 ED3E CB67             8      BIT 4,A
001C47 ED40 C4D8EC          17      CALL    NZ,RNF
       ED43                     DISKE2:
001C4A ED43 21DEEC          10      LD  HL,RETRY
001C4D ED46 35              11      DEC (HL)
001C4E ED47 20C0            12      JR  NZ,DISK2
001C50 ED49 B7               4      OR  A
001C51 ED4A 280A            12      JR  Z,ERR
001C53 ED4C D5              11      PUSH    DE
       ED4D                     ERRF:
001C54 ED4D D1              10      POP DE
       ED4E                     DELP:
001C55 ED4E CDD8EC          17      CALL    RNF
001C58 ED51 CDB0EC          17      CALL    FDMOFF
001C5B ED54 3EFF             7      LD  A,0FFH
       ED56                     ERR:
001C5D ED56 BF               4      CP  A
001C5E ED57 37               4      SCF
001C5F ED58 C9              10      RET
                                
       ED59                     DMAD:           ;X1turbo DISK DMA
001C60 ED59 C3                      DB  0C3H    ;WR6 リセット
001C61 ED5A 7D                  DMASWC: DB  07DH    ;WR0 ポートA→ポートB 転送  （読み込み）
                                ;   DB  079H    ;WR0 ポートB←ポートB 転送  （書き込み）
001C62 ED5B FB0F                    DW  00FFBH  ;ポートA開始アドレス (FDC MB8877A データレジスタ)
001C64 ED5D FFFF                    DW  0FFFFH  ;ブロック長(転送サイズ-1)
001C66 ED5F 2C                      DB  02CH    ;WR1 ポートAアドレス固定 I/O
001C67 ED60 10                      DB  010H    ;WR2 ポートBインクリメント
001C68 ED61 80                      DB  080H    ;WR3
001C69 ED62 92                      DB  092H    ;WR5 WAIT RDY:LOW
001C6A ED63 8D                      DB  08DH    ;WR4 バイト ポートB開始アドレス(LH)
001C6B ED64 0000                DMAHL:  DW  0   ;ポートB開始アドレス
001C6D ED66 CF                      DB  0CFH    ;WR6 ロード
001C6E ED67 87                      DB  087H    ;WR6 イネーブル
       ED68                     DMAE:
                                
       1736                     AT_R    EQU WTTRK-AT_DWT
       ED68                     AT_TABLE:
[EOF:X1DISK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001C6F ED68                     PATHD:  DS  PATHX
001CAA EDA3 00                  PATHE:  DB  0
                                
       EDA4                     DTA_CCP:
001CAB EDA4                         DS  37
                                
       EDC9                     FCB_BAT:
001CD0 EDC9                         DS  37
                                
001CF5 EDEE 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001D00 EDF9 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
                                ;   ALIGN   256
       EE00                     AT_WORK:
001D07 EE00                         DS  WORKAD-AT_WORK
                                
       EE00                     CPM_BOOT:
001D07 EE00 C30000          10      JP  0
       EE03                     _SYS00:     ;(BDOS)プログラム終了
       EE03                     CPM_WBOOT:
001D0A EE03 C309D7          10      JP  WBOOT1
       EE06                     CPM_CONST:
001D0D EE06 C376E0          10      JP  CONSTX
       EE09                     _SYS07:     ;(BDOS)コンソール直接入力
       EE09                     CPM_CONIN:
001D10 EE09 C3EBDF          10      JP  FLGET
       EE0C                     CPM_CONOUT:
001D13 EE0C C3BCE2          10      JP  CONOUT1
                                
       EE0F                     DECBF:              ;10進数表示時のバッファ(5バイト)
001D16 EE0F                         DS  5
       EE0F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       EE11                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       EE14                     FDRV:
001D1B EE14 00                      DB  0
       EE15                     FNAME:
001D1C EE15                         DS  36
       EE39                     SFILE:
001D40 EE39                         DS  33      ;DRV FILENAME
       EE5A                     _DISKE:
001D61 EE5A C327DF          10      JP  SHOW_ERROR
                                
001D64 EE5D 0000                LEFTX:  DW  0
001D66 EE5F 0000                DTAX:   DW  0
                                
                                ;   PSGのビープ音のデータ(X1)
       EE61                     BEEPD:
001D68 EE61 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
001D70 EE69 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                ;
       EE62                     RTC_YY  EQU BEEPD+1 ;RTCのバッファ年(88)
       EE63                     RTC_MW  EQU BEEPD+2 ;RTCのバッファ月(88)
       EE64                     RTC_DD  EQU BEEPD+3 ;RTCのバッファ日(88)
       EE65                     RTC_TT  EQU BEEPD+4 ;RTCのバッファ時(88)
       EE66                     RTC_MM  EQU BEEPD+5 ;RTCのバッファ分(88)
       EE67                     RTC_SS  EQU BEEPD+6 ;RTCのバッファ秒(88)
       EE62                     ROM_SLT EQU BEEPD+1 ;ROMのスロット(MSX)
       EE61                     ZERO    EQU BEEPD
                                
       EE70                     CHECK:
001D77 EE70 00                      DB  0
                                
       EE71                     OK:
001D78 EE71 4F4B24                  DB  "OK$"
001D7B EE74                         DS  5
       EE79                     COMERM:
001D80 EE79 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       EE80                     _CYL0:
001D87 EE80 FF                      DB  0FFH    ;Cylinder
       EE81                     _CYL1:
001D88 EE81 FF                      DB  0FFH    ;Cylinder
       EE82                     _CYL2:
001D89 EE82 FF                      DB  0FFH    ;Cylinder
       EE83                     _CYL3:
001D8A EE83 FF                      DB  0FFH    ;Cylinder
       EE84                     _DRIVE:
001D8B EE84 00                      DB  0   ;unit number
       EE85                     _SEEKSP:
001D8C EE85 00                      DB  0   ;Seek speed
       EE86                     _ISEEK:
001D8D EE86 32                      DB  50  ;
001D8E EE87                         DS  1
       EE88                     _DRV:
001D8F EE88 00                      DB  0
       EE89                     _DSK:
001D90 EE89 FF                      DB  0FFH
       EE8A                     _DTA:
001D91 EE8A 8000                    DW  00080H
       EE8C                     _CTC:
001D93 EE8C 0000                    DW  0
       EE8E                     _TXADR:
001D95 EE8E 0000                    DW  0
       EE90                     _KEYPS:
001D97 EE90 0000                    DW  0
       EE92                     _KEYD:
001D99 EE92 00                      DB  000H    ;キーデータ
       EE93                     _KEYST:
001D9A EE93 FF                      DB  0FFH    ;キーステータス(SHIFT,CTRLの状態)
       EE94                     _KEYSP_L:
001D9B EE94 C2                      DB  KEYSP_L ;オートリピートの速度
       EE95                     _KEYSP_H:
001D9C EE95 14                      DB  KEYSP_H ;オートリピートの速度
       EE96                     _COLORF:
001D9D EE96 07                      DB  COLORF  ;色
       EE97                     _LINE:
001D9E EE97 18                      DB  LINE
                                
                                            ;次のファイルの検索(C=12)で使用するFCB
       EE98                     _FCB:
001D9F EE98 0000                    DW  0   ;SEARCH FILES
       EE9A                     _FBPS:
001DA1 EE9A 0000                    DW  0   ;    //
       EE9C                     _FBAD:
001DA3 EE9C 0000                    DW  0   ;    //
       EE9E                     _FBCNT:
001DA5 EE9E 00                      DB  0   ;    //
       EE9F                     _FILEN:
001DA6 EE9F 00                      DB  0   ;    //
       EEA0                     _DIRF:
001DA7 EEA0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
001DA8 EEA1                         DS  1
       EEA2                     _WTFATF:
001DA9 EEA2 00                      DB  0   ;FATバッファの更新フラグ
001DAA EEA3                         DS  1
       EEA4                     _WTDBF:
001DAB EEA4 00                      DB  0   ;データバッファの更新フラグ
       EEA5                     _DBDRV:
001DAC EEA5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       EEA6                     _DBSEC:
001DAD EEA6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       EEA8                     _DPB:
001DAF EEA8 0000                    DW  0
       EEAA                     _FATDRV:
001DB1 EEAA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       EEAB                     _FATIX:
001DB2 EEAB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       EEAC                     _FAKEFREE:
001DB3 EEAC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
001DB5 EEAE                         DS  2
                                ;   画面周りのデータ
       EEB0                     CRTCD:
001DB7 EEB0 6F                      DB  06FH
       EEB1                     _WIDTH:
001DB8 EEB1 50                      DB  WIDTH
       EEB2                     TVRAMTOP:
001DB9 EEB2 5938                    DB  059H,038H
001DBB EEB4 1F02                    DB  01FH,002H
       EEB6                     _LINE2:
001DBD EEB6 19                      DB  019H
       EEB7                     WKE4:
001DBE EEB7 1C                      DB  01CH
       EEB8                     WKE6:
001DBF EEB8 00                      DB  000H
       EEB9                     WK40:
001DC0 EEB9 07                      DB  007H
       EEBA                     _PAGE_MINUS:
001DC1 EEBA 80F8                    DW  0-WIDTH*LINE
       EEBC                     _WIDTH_MINUS:
001DC3 EEBC B0FF                    DW  0-WIDTH
       EEBE                     WK30:
001DC5 EEBE 0C                      DB  00CH
       EEBF                     WK31:
       EEBF                     WK1FD0:
001DC6 EEBF 20                      DB  020H
                                
                                ;   割り込みベクタ(X1)
001DC7 EEC0 7BDF                CTC0:   DW  INTCTCE
001DC9 EEC2 7BDF                CTC1:   DW  INTCTCE
001DCB EEC4 7BDF                CTC2:   DW  INTCTCE
001DCD EEC6 7BDF                CTC3:   DW  INTCTCE
001DCF EEC8 54DF                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
001DD1 EECA C39FE4          10  _INKEY: JP  INKEY
001DD4 EECD C357E1          10  _PRINT: JP  PRINT
001DD7 EED0 C307E4          10  _SCRN:  JP  SCRN
001DDA EED3 C331E4          10  _POS:   JP  POS
001DDD EED6 C385E2          10  _LOC:   JP  LOC
       EED9                     _CHGDRV:
001DE0 EED9 C31EEB          10      JP  CHGDRV
       EEDC                     _GETDPB:
001DE3 EEDC C3DCEB          10      JP  GETDPB
       EEDF                     _FFLUSH:
001DE6 EEDF C3FAEB          10      JP  FFLUSH
       EEE2                     _RDFATX:
001DE9 EEE2 C3F6E7          10      JP  RDFATX
001DEC EEE5 C328E9          10  _RDFAT: JP  RDFAT
001DEF EEE8 C3DFEC          10  _WTTRK: JP  WTTRK
001DF2 EEEB C3F3EC          10  _FDRD:  JP  FDRD
001DF5 EEEE C3E5EC          10  _FDWT:  JP  FDWT
       EEF1                     _BPB2DPB:
001DF8 EEF1 C3C0E9          10      JP  BPB2DPB
       EEF4                     _BREAK:
001DFB EEF4 C3C0D8          10      JP  END_BATCH
       EEF7                     _GNCL:
001DFE EEF7 C3A2E8          10      JP  GNCL        ; self-modifying code
       EEF8                     GNCPAT  EQU $-2
       EEFA                     _SNCL:
001E01 EEFA C3C5E8          10      JP  SNCL        ; self-modifying code
       EEFB                     SNCPAT  EQU $-2
       EEFD                     _COMANL:
001E04 EEFD C379D7          10      JP  COMANL
                                
       EF00                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       EF00                     STABLE:
                                ;0
001E07 EF00 03EEBEDFCADFAAF1        DW  _SYS00,_SYS01,_SYS02,_SYS03
001E0F EF08 92DC92DCCFDF09EE        DW  _SYS04,_SYS05,_SYS06,_SYS07
001E17 EF10 D7DF94DC42E06EE0        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
001E1F EF18 A9DCAEDCBDDCCEDC        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001E27 EF20 22DD69DDB2DDE3DD        DW  _SYS10,_SYS11,_SYS12,_SYS13
001E2F EF28 EBDD01DE16DE0EDE        DW  _SYS14,_SYS15,_SYS16,_SYS17
001E37 EF30 5DDE62DE67DE6DDE        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001E3F EF38 92DC93DE92DC97DE        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
001E47 EF40 92DC4DDE55DE9EDE        DW  _SYS20,_SYS21,_SYS22,_SYS23
001E4F EF48 C3DE92DCB6E484E5        DW  _SYS24,_ERROR,_SYS26,_SYS27
001E57 EF50 55DECDDE84E0AAF1        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
001E5F EF58 A7E0AAF192DCEEDE        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
001E67 EF60 E8DE92DC92DC92DC        DW  _SYS30,_ERROR,_ERROR,_ERROR
001E6F EF68 92DC92DC92DC92DC        DW  _ERROR,_ERROR,_ERROR,_ERROR
001E77 EF70 92DCAAF1AAF10FDF        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
001E7F EF78 75DC                    DW  _DOS2
                                
001E81 EF7A                         DS  1
       EF7B                     _MAX_SEC_SZ_H:
001E82 EF7B 02                      DB  MAX_SEC_SZ_H
                                
                                ;   FATバッファのアドレス
       EF7C                     _FATBF:
001E83 EF7C 00F7                    DW  FATBF
                                
                                ;   データバッファのアドレス
       EF7E                     _DTBUF:
001E85 EF7E 00FD                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       EF80                     CTRLTB:
001E87 EF80 FAE1FAE136E27BE3        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
001E8F EF88 75E35AE254E3DDE2        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
001E97 EF90 06E227E27EE39BE2        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
001E9F EF98 51E380E293E3FAE1        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
001EA7 EFA0 FAE1FAE193E2FAE1        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
001EAF EFA8 FAE1FAE1FAE1FAE1        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
001EB7 EFB0 FAE1FAE151E3A2E2        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
001EBF EFB8 21E20DE216E27EE3        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
                                ;   2D/2DDでBPBがない場合のデフォルト値(2D/360KB/9セクタ1024バイト)
001EC7 EFC0 0200                M2D:    DW  2
001EC9 EFC2 FD02                    DB  0FDH,2
001ECB EFC4 6401                    DW  356
001ECD EFC6 FF0728090182            DB  0FFH,7,40,9,1,082H
001ED3 EFCC 0500A7000800            DW  5,0A7H,8
                                
                                ;   2HDでBPBがない場合のデフォルト値(2HD/1.23MB/8セクタ1024バイト)
001ED9 EFD2 0200                M2HD:   DW  2
001EDB EFD4 FE01                    DB  0FEH,1
001EDD EFD6 C704                    DW  1223
001EDF EFD8 FE064D080184            DB  0FEH,6,77,8,1,084H
001EE5 EFDE 0500A7000900            DW  5,0A7H,9
                                
                                ;   ディレクトリエントリとFCBの変換テーブル(日付+時刻+サイズ)
001EEB EFE4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
001EED EFE6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
001EEF EFE8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
001EF1 EFEA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       EFEE                     SDDATAE:
                                
001EF5 EFEE                         DS  2
                                
                                ;   バッチファイルのFCB
       EFF0                     _FCB_BAT:
001EF7 EFF0 C9ED                    DW  FCB_BAT
       EFF2                     _PATH:
001EF9 EFF2 68ED                    DW  PATHD
                                
001EFB EFF4                     SCDIR:  DS  2       ;+14 +15
001EFD EFF6                     SFBPS:  DS  2       ;FBPS
001EFF EFF8                     SFNDF:  DS  2       ;FILEN DIRF
                                
001F01 EFFA 0000                _FATPS: DW  0
001F03 EFFC 0000                _DIRPS: DW  0
001F05 EFFE 0000                _CLPS:  DW  0
                                
       F000                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       F000                     FILEC:
001F07 F000 CD0BF0          17      CALL    FILE
       F003                     FILEC2:
001F0A F003 3A15EE          13      LD  A,(FDRV+1)
001F0D F006 FE20             7      CP  020H
001F0F F008 C8              11      RET Z
001F10 F009 1839            12      JR  SETDIR1
                                
       F00B                     FILE:
001F12 F00B AF               4      XOR A
001F13 F00C 3214EE          13      LD  (FDRV),A
001F16 F00F 67               4      LD  H,A
001F17 F010 6F               4      LD  L,A
001F18 F011 2222EE          16      LD  (FDRV+14),HL
001F1B F014 CDE1F0          17      CALL    SPCUT
001F1E F017 CDC6F0          17      CALL    CCHK3
001F21 F01A 2812            12      JR  Z,DEVI1
001F23 F01C 13               6      INC DE
001F24 F01D 1A               7      LD  A,(DE)
001F25 F01E 1B               6      DEC DE
001F26 F01F FE3A             7      CP  ':'
001F28 F021 200B            12      JR  NZ,DEVI1
001F2A F023 1A               7      LD  A,(DE)      ;DRIVE
001F2B F024 CD27F3          17      CALL    CAP
001F2E F027 D640             7      SUB '@'
001F30 F029 13               6      INC DE
001F31 F02A 13               6      INC DE
001F32 F02B 3214EE          13      LD  (FDRV),A
       F02E                     DEVI1:
001F35 F02E 1A               7      LD  A,(DE)
001F36 F02F D65C             7      SUB 05CH        ;\
001F38 F031 2009            12      JR  NZ,NOROOT
001F3A F033 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
001F3B F034 222EEE          16      LD  (FDRV+26),HL
001F3E F037 2C               4      INC L
001F3F F038 2222EE          16      LD  (FDRV+14),HL
001F42 F03B 13               6      INC DE
       F03C                     NOROOT:
                                
       F03C                     SETDIR:
001F43 F03C CD67F0          17      CALL    FILED
001F46 F03F 1A               7      LD  A,(DE)
001F47 F040 FE5C             7      CP  05CH        ;\
001F49 F042 C0              11      RET NZ
001F4A F043 13               6      INC DE
       F044                     SETDIR1:
001F4B F044 3E10             7      LD  A,010H      ;Directory
001F4D F046 3221EE          13      LD  (FDRV+13),A
001F50 F049 D5              11      PUSH    DE
001F51 F04A 1114EE          10      LD  DE,FDRV
001F54 F04D 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
001F56 F04F CD63DC          17      CALL    BDOS0
001F59 F052 D1              10      POP DE
001F5A F053 B7               4      OR  A
001F5B F054 C0              11      RET NZ
                                
001F5C F055 3A21EE          13      LD  A,(FDRV+13)
001F5F F058 E610             7      AND 010H        ;ディレクトリ
001F61 F05A C8              11      RET Z
                                
001F62 F05B CDAEF0          17      CALL    FILEI
001F65 F05E 2A2EEE          16      LD  HL,(FDRV+26)
001F68 F061 23               6      INC HL
001F69 F062 2222EE          16      LD  (FDRV+14),HL
001F6C F065 18D5            12      JR  SETDIR
                                
       F067                     FILED:
001F6E F067 CDAEF0          17      CALL    FILEI
001F71 F06A 2115EE          10      LD  HL,FNAME
                                
001F74 F06D 0608             7      LD  B,8
       F06F                     FILE2:
001F76 F06F CDBBF0          17      CALL    CCHKF
001F79 F072 C8              11      RET Z
001F7A F073 FE2A             7      CP  '*'
001F7C F075 282E            12      JR  Z,FILE9
001F7E F077 FE2E             7      CP  '.'
001F80 F079 280C            12      JR  Z,FILE4
001F82 F07B 77               7      LD  (HL),A
001F83 F07C 23               6      INC HL
001F84 F07D 10F0            13      DJNZ    FILE2
                                
       F07F                     FILE3:
001F86 F07F CDBBF0          17      CALL    CCHKF
001F89 F082 C8              11      RET Z
001F8A F083 FE2E             7      CP  '.'
001F8C F085 20F8            12      JR  NZ,FILE3
                                
       F087                     FILE4:
001F8E F087 211DEE          10      LD  HL,FNAME+8
001F91 F08A 0603             7      LD  B,3
                                
       F08C                     FILE4L:
001F93 F08C CDBBF0          17      CALL    CCHKF
001F96 F08F C8              11      RET Z
001F97 F090 FE2E             7      CP  '.'
001F99 F092 2008            12      JR  NZ,FILE12
001F9B F094 3215EE          13      LD  (FNAME),A   ;Parent directory(..)
001F9E F097 3216EE          13      LD  (FNAME+1),A
001FA1 F09A 3E20             7      LD  A,020H
       F09C                     FILE12:
001FA3 F09C FE2A             7      CP  '*'
001FA5 F09E 280A            12      JR  Z,FILE10
001FA7 F0A0 77               7      LD  (HL),A
001FA8 F0A1 23               6      INC HL
001FA9 F0A2 10E8            13      DJNZ    FILE4L
001FAB F0A4 C9              10      RET
                                
       F0A5                     FILE9:              ;名前の*処理、名前の残りを?で埋める
001FAC F0A5 CDAAF0          17      CALL    FILE10
001FAF F0A8 18D5            12      JR  FILE3
                                
       F0AA                     FILE10:
001FB1 F0AA 3E3F             7      LD  A,'?'
001FB3 F0AC 1808            12      JR  FILL_MEMORY
       F0AE                     FILEI:              ;名前＋拡張子をスペースで初期化
001FB5 F0AE 3E20             7      LD  A,020H
001FB7 F0B0 01000B          10      LD  BC,11*256   ;C=0にしておく
001FBA F0B3 2115EE          10      LD  HL,FNAME
       F0B6                     FILL_MEMORY:            ;HLからBバイトAで埋める
001FBD F0B6 77               7      LD  (HL),A
001FBE F0B7 23               6      INC HL
001FBF F0B8 10FC            13      DJNZ    FILL_MEMORY
001FC1 F0BA C9              10      RET
                                
       F0BB                     CCHKF:
001FC2 F0BB 1A               7      LD  A,(DE)
001FC3 F0BC CDC3F0          17      CALL    CCHK2
001FC6 F0BF C8              11      RET Z
001FC7 F0C0 C32FF4          10      JP  FKAN
                                
       F0C3                     CCHK2:
001FCA F0C3 0C               4      INC C
001FCB F0C4 0D               4      DEC C
001FCC F0C5 C0              11      RET NZ
       F0C6                     CCHK3:              ;ZF=1 で使えない文字
001FCD F0C6 FE2B             7      CP  '+'
001FCF F0C8 C8              11      RET Z
001FD0 F0C9 FE2C             7      CP  ','
001FD2 F0CB C8              11      RET Z
001FD3 F0CC FE2F             7      CP  '/'
001FD5 F0CE C8              11      RET Z
001FD6 F0CF FE3A             7      CP  ':'
001FD8 F0D1 C8              11      RET Z
001FD9 F0D2 FE3B             7      CP  ';'
001FDB F0D4 C8              11      RET Z
001FDC F0D5 FE3D             7      CP  '='
001FDE F0D7 C8              11      RET Z
001FDF F0D8 FE5C             7      CP  05CH    ;\
001FE1 F0DA C8              11      RET Z
001FE2 F0DB FE20             7      CP  020H
001FE4 F0DD D0              11      RET NC
001FE5 F0DE BF               4      CP  A       ;Z=1
001FE6 F0DF C9              10      RET
                                
       F0E0                     SS1:
001FE7 F0E0 13               6      INC DE
       F0E1                     SPCUT:              ;スペースをカット
001FE8 F0E1 1A               7      LD  A,(DE)
001FE9 F0E2 FE20             7      CP  020H
001FEB F0E4 28FA            12      JR  Z,SS1
001FED F0E6 C9              10      RET
                                
       F0E7                     SETDRVF:
001FEE F0E7 1114EE          10      LD  DE,FDRV
       F0EA                     SETDRV0:
001FF1 F0EA CDF3F0          17      CALL    SETDRV
001FF4 F0ED FDE1            14      POP IY
001FF6 F0EF C1              10      POP BC
001FF7 F0F0 D1              10      POP DE
001FF8 F0F1 E1              10      POP HL
001FF9 F0F2 C9              10      RET
                                
       F0F3                     SETDRV:
001FFA F0F3 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
001FFB F0F4 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
001FFC F0F5 C5              11      PUSH    BC
001FFD F0F6 1A               7      LD  A,(DE)
001FFE F0F7 D5              11      PUSH    DE
001FFF F0F8 FDE3            23      EX  (SP),IY
                                
002001 F0FA CD01F1          17      CALL    GETDRV
002004 F0FD CDD9EE          17      CALL    _CHGDRV
                                
002007 F100 E9               4      JP  (HL)
                                
       F101                     GETDRV:
002008 F101 CD14F1          17      CALL    GETDRV1
00200B F104 3288EE          13      LD  (_DRV),A
00200E F107 C9              10      RET
                                
       F108                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
00200F F108 CD14F1          17      CALL    GETDRV1
002012 F10B C5              11      PUSH    BC
002013 F10C 4F               4      LD  C,A
002014 F10D 1A               7      LD  A,(DE)
002015 F10E CD14F1          17      CALL    GETDRV1
002018 F111 A9               4      XOR C
002019 F112 C1              10      POP BC
00201A F113 C9              10      RET
       F114                     GETDRV1:
00201B F114 E67F             7      AND 07FH
00201D F116 D601             7      SUB 001H
00201F F118 D0              11      RET NC
002020 F119 3A0400          13      LD  A,(_DVSW)   ;Current Drive
002023 F11C C9              10      RET
                                
       F11D                     SOPENX:
002024 F11D 1139EE          10      LD  DE,SFILE
002027 F120 FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
00202A F123 CD08F1          17      CALL    IS_SAME_DRV_A_DE
00202D F126 2024            12      JR  NZ,SOPEN
00202F F128 13               6      INC DE
002030 F129 FDE5            15      PUSH    IY
002032 F12B E1              10      POP HL
002033 F12C 23               6      INC HL
002034 F12D CDB8F2          17      CALL    CPFILE
002037 F130 201A            12      JR  NZ,SOPEN
                                
002039 F132 2AF4EF          16      LD  HL,(SCDIR)
00203C F135 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00203F F138 FD740F          19      LD  (IY+15),H
                                
002042 F13B 2AF8EF          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
002045 F13E 229FEE          16      LD  (_FILEN),HL
                                
002048 F141 ED5BF6EF        20      LD  DE,(SFBPS)
00204C F145 2139EE          10      LD  HL,SFILE
00204F F148 36FF            10      LD  (HL),0FFH
002051 F14A 23               6      INC HL
002052 F14B C9              10      RET
       F14C                     SOPEN:
002053 F14C 2160F2          10      LD  HL,FILESE
       F14F                     SOPENC:
002056 F14F 2288F1          16      LD  (OPENPAT),HL
                                
002059 F152 CDE2EE          17      CALL    _RDFATX     ;Detect Media
00205C F155 3856            12      JR  C,RDDERR
                                
00205E F157 AF               4      XOR A
00205F F158 329FEE          13      LD  (_FILEN),A
002062 F15B CD64F3          17      CALL    LDDIRX1     ;A=0で呼び出す
002065 F15E 2818            12      JR  Z,SDIRX1
                                
002067 F160 CD51F2          17      CALL    READ_DIR    ;Sub Directory
00206A F163 3808            12      JR  C,SDIRX0
00206C F165 2A7EEF          16      LD  HL,(_DTBUF)
00206F F168 7E               7      LD  A,(HL)
002070 F169 FE2E             7      CP  '.'
002072 F16B 280F            12      JR  Z,SOPEN1
       F16D                     SDIRX0:
002074 F16D AF               4      XOR A
002075 F16E 32A0EE          13      LD  (_DIRF),A
002078 F171 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
00207C F175 FD770F          19      LD  (IY+15),A
       F178                     SDIRX1:
00207F F178 ED5BFCEF        20      LD  DE,(_DIRPS) ;Root Directory
       F17C                     SOPEN1:
002083 F17C 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       F17D                     SDECPAT EQU $-1
       F17E                     SOPEN1X:
002085 F17E CD51F2          17      CALL    READ_DIR    ;FILE SEARCH
002088 F181 382A            12      JR  C,RDDERR
00208A F183 2A7EEF          16      LD  HL,(_DTBUF)
       F186                     SOPEN2:
00208D F186 D5              11      PUSH    DE
00208E F187 CD60F2          17      CALL    FILESE      ;(self-modifying code)
       F188                     OPENPAT EQU $-2
002091 F18A D1              10      POP DE
002092 F18B 386D            12      JR  C,SOPENE
002094 F18D 281B            12      JR  Z,SCF_FF_RET
       F18F                     SOPEN3:
002096 F18F 3AA0EE          13      LD  A,(_DIRF)   ;ディレクトリか判別
002099 F192 B7               4      OR  A
00209A F193 200C            12      JR  NZ,SOPEN5
00209C F195 13               6      INC DE      ;ルートディレクトリ
00209D F196 E5              11      PUSH    HL
00209E F197 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       F198                     MD_PAT  EQU $-2
0020A1 F19A ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
0020A3 F19C E1              10      POP HL
0020A4 F19D 20DD            12      JR  NZ,SOPEN1
0020A6 F19F 1807            12      JR  SOPEN6
       F1A1                     SOPEN5:
0020A8 F1A1 CD21E9          17      CALL    GNCLX       ;END DIR
0020AB F1A4 D8              11      RET C
0020AC F1A5 CD18F3          17      CALL    ENDCL
       F1A8                     SOPEN6:
0020AF F1A8 38D2            12      JR  C,SOPEN1
       F1AA                     SCF_FF_RET:
0020B1 F1AA 37               4      SCF         ;CF=1
0020B2 F1AB 9F               4      SBC A,A     ;A=0FFH
0020B3 F1AC C9              10      RET
                                
       F1AD                     RDDERR:
0020B4 F1AD BF               4      CP  A       ;READ ERR CF=1 ZF=1
0020B5 F1AE 37               4      SCF
0020B6 F1AF C9              10      RET
                                
       F1B0                     NOPEN:
0020B7 F1B0 2160F2          10      LD  HL,FILESE
0020BA F1B3 2288F1          16      LD  (OPENPAT),HL
0020BD F1B6 FD2A98EE        20      LD  IY,(_FCB)
0020C1 F1BA CD42F4          17      CALL    CHKWILDX
0020C4 F1BD 30EB            12      JR  NC,SCF_FF_RET
0020C6 F1BF FD7E00          19      LD  A,(IY+0)
0020C9 F1C2 CD01F1          17      CALL    GETDRV
0020CC F1C5 CDD9EE          17      CALL    _CHGDRV
0020CF F1C8 D8              11      RET C
0020D0 F1C9 2AF8EF          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
0020D3 F1CC 229FEE          16      LD  (_FILEN),HL
                                
0020D6 F1CF CD5FF3          17      CALL    LDDIRX
0020D9 F1D2 ED5B9AEE        20      LD  DE,(_FBPS)
0020DD F1D6 CD51F2          17      CALL    READ_DIR
0020E0 F1D9 38D2            12      JR  C,RDDERR
0020E2 F1DB 3A9EEE          13      LD  A,(_FBCNT)
0020E5 F1DE 3D               4      DEC A
0020E6 F1DF 28AE            12      JR  Z,SOPEN3
       F1E1                     NOPEN2:
0020E8 F1E1 2A9CEE          16      LD  HL,(_FBAD)
0020EB F1E4 012000          10      LD  BC,020H
0020EE F1E7 09              11      ADD HL,BC
0020EF F1E8 4F               4      LD  C,A
0020F0 F1E9 189B            12      JR  SOPEN2
                                
       F1EB                     SOPENE2:
0020F2 F1EB 229CEE          16      LD  (_FBAD),HL
0020F5 F1EE 79               4      LD  A,C
0020F6 F1EF 329EEE          13      LD  (_FBCNT),A
0020F9 F1F2 ED539AEE        20      LD  (_FBPS),DE
0020FD F1F6 FD2298EE        20      LD  (_FCB),IY
       F1FA                     SOPENE:
002101 F1FA AF               4      XOR A
002102 F1FB C9              10      RET
                                
       F1FC                     COPEN:
002103 F1FC FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
002107 F200 217DF2          10      LD  HL,NEXTSE
00210A F203 CD4FF1          17      CALL    SOPENC
00210D F206 D0              11      RET NC
00210E F207 C8              11      RET Z
00210F F208 3AA0EE          13      LD  A,(_DIRF)   ;ディレクトリか判別
002112 F20B B7               4      OR  A
002113 F20C 37               4      SCF
002114 F20D C8              11      RET Z       ;ルートディレクトリ
002115 F20E 0601             7      LD  B,1
002117 F210 CDA1F4          17      CALL    WRDF
00211A F213 D8              11      RET C
00211B F214 ED5BFEEF        20      LD  DE,(_CLPS)
00211F F218 D5              11      PUSH    DE
002120 F219 CDE1F2          17      CALL    DCPAT
002123 F21C CDA2E7          17      CALL    DRDNX
002126 F21F 2A7EEF          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
002129 F222 ED4B8DE6        20      LD  BC,(SECSZ)  ;1セクタのサイズ
00212D F226 AF               4      XOR A
       F227                     COPENCL:
00212E F227 77               7      LD  (HL),A
00212F F228 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
002131 F22A EA27F2          10      JP  PE,COPENCL
                                
002134 F22D 3AFFF2          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
002137 F230 3D               4      DEC A
002138 F231 2819            12      JR  Z,COPENE
00213A F233 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
00213C F235 3219E9          13      LD  (_SECPS),A
00213F F238 D1              10      POP DE      ;DE=(_CLPS)
002140 F239 D5              11      PUSH    DE
       F23A                     COPEN1:
002141 F23A D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
002142 F23B C5              11      PUSH    BC
002143 F23C 2A7EEF          16      LD  HL,(_DTBUF)
002146 F23F CDFBF2          17      CALL    CLUSTX
002149 F242 CDB8EA          17      CALL    DWT24
00214C F245 C1              10      POP BC
00214D F246 D1              10      POP DE
00214E F247 CD18E9          17      CALL    NEXTX
002151 F24A 20EE            12      JR  NZ,COPEN1
       F24C                     COPENE:
002153 F24C 2A7EEF          16      LD  HL,(_DTBUF)
002156 F24F D1              10      POP DE
002157 F250 C9              10      RET
                                
       F251                     READ_DIR:
002158 F251 ED53FEEF        20      LD  (_CLPS),DE
00215C F255 C5              11      PUSH    BC
00215D F256 D5              11      PUSH    DE
00215E F257 CDE1F2          17      CALL    DCPAT
002161 F25A CD82E7          17      CALL    DRDX
002164 F25D D1              10      POP DE
002165 F25E C1              10      POP BC
002166 F25F C9              10      RET
                                
       F260                     FILESE:
002167 F260 7E               7      LD  A,(HL)
002168 F261 B7               4      OR  A
002169 F262 C8              11      RET Z       ;END:ZF=1 CF=0
00216A F263 FEE5             7      CP  0E5H
00216C F265 280E            12      JR  Z,FILESE1
00216E F267 FDE5            15      PUSH    IY
002170 F269 D1              10      POP DE
002171 F26A 13               6      INC DE
002172 F26B E5              11      PUSH    HL
002173 F26C CDB8F2          17      CALL    CPFILE
002176 F26F CCD9F2          17      CALL    Z,CPFILE2
002179 F272 E1              10      POP HL
00217A F273 37               4      SCF
00217B F274 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       F275                     FILESE1:
00217C F275 CD8CF2          17      CALL    FNEXT
00217F F278 20E6            12      JR  NZ,FILESE
       F27A                     ZF0_CF0_AFF_RET:
002181 F27A F6FF             7      OR  0FFH        ;ZF=0 CF=0
002183 F27C C9              10      RET
                                
       F27D                     NEXTSE:
002184 F27D 7E               7      LD  A,(HL)
002185 F27E B7               4      OR  A
002186 F27F 37               4      SCF
002187 F280 C8              11      RET Z       ;!!!:ZF=1 CF=1
002188 F281 FEE5             7      CP  0E5H
00218A F283 37               4      SCF
00218B F284 C8              11      RET Z       ;!!!:(ZF=1) CF=1
00218C F285 CD8CF2          17      CALL    FNEXT
00218F F288 20F3            12      JR  NZ,NEXTSE
002191 F28A 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       F28C                     FNEXT:
002193 F28C E5              11      PUSH    HL
002194 F28D 219FEE          10      LD  HL,_FILEN
002197 F290 34              11      INC (HL)
002198 F291 E1              10      POP HL
002199 F292 112000          10      LD  DE,020H
00219C F295 19              11      ADD HL,DE
00219D F296 0D               4      DEC C
00219E F297 C9              10      RET
                                
       F298                     CPNAME:
00219F F298 C5              11      PUSH    BC
0021A0 F299 D5              11      PUSH    DE
0021A1 F29A E5              11      PUSH    HL
0021A2 F29B CDB2F2          17      CALL    CPFILE4
0021A5 F29E E1              10      POP HL
0021A6 F29F 23               6      INC HL
0021A7 F2A0 23               6      INC HL
0021A8 F2A1 23               6      INC HL
0021A9 F2A2 23               6      INC HL
0021AA F2A3 D1              10      POP DE
0021AB F2A4 C1              10      POP BC
0021AC F2A5 2005            12      JR  NZ,CPNAME1
0021AE F2A7 7E               7      LD  A,(HL)
0021AF F2A8 23               6      INC HL
0021B0 F2A9 66               7      LD  H,(HL)
0021B1 F2AA 6F               4      LD  L,A
0021B2 F2AB C9              10      RET
       F2AC                     CPNAME1:
0021B3 F2AC 23               6      INC HL
0021B4 F2AD 23               6      INC HL
0021B5 F2AE 10E8            13      DJNZ    CPNAME
0021B7 F2B0 37               4      SCF
0021B8 F2B1 C9              10      RET
                                
       F2B2                     CPFILE4:
0021B9 F2B2 C5              11      PUSH    BC
0021BA F2B3 010004          10      LD  BC,00400H
0021BD F2B6 1804            12      JR  CPSTR1
       F2B8                     CPFILE:
0021BF F2B8 C5              11      PUSH    BC
0021C0 F2B9 01000B          10      LD  BC,00B00H
       F2BC                     CPSTR1:
0021C3 F2BC 1A               7      LD  A,(DE)
0021C4 F2BD FE3F             7      CP  '?'     ;Wild card
0021C6 F2BF 2812            12      JR  Z,CPSTR2
0021C8 F2C1 7E               7      LD  A,(HL)
0021C9 F2C2 CD28F4          17      CALL    FKANC
0021CC F2C5 E5              11      PUSH    HL
0021CD F2C6 67               4      LD  H,A
0021CE F2C7 1A               7      LD  A,(DE)
0021CF F2C8 CB01             8      RLC C
0021D1 F2CA CD28F4          17      CALL    FKANC
0021D4 F2CD CB09             8      RRC C
0021D6 F2CF BC               4      CP  H       ;CP (HL),(DE)
0021D7 F2D0 E1              10      POP HL
0021D8 F2D1 2004            12      JR  NZ,CPSTR3
       F2D3                     CPSTR2:
0021DA F2D3 13               6      INC DE
0021DB F2D4 23               6      INC HL
0021DC F2D5 10E5            13      DJNZ    CPSTR1
       F2D7                     CPSTR3:
0021DE F2D7 C1              10      POP BC
0021DF F2D8 C9              10      RET
                                
       F2D9                     CPFILE2:
0021E0 F2D9 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0021E3 F2DC F6E1             7      OR  0E1H
0021E5 F2DE 2F               4      CPL
0021E6 F2DF A6               7      AND (HL)
0021E7 F2E0 C9              10      RET
                                
       F2E1                     DCPAT:
0021E8 F2E1 0E00             7      LD  C,0
0021EA F2E3 2A7EEF          16      LD  HL,(_DTBUF)
0021ED F2E6 3AA0EE          13      LD  A,(_DIRF)   ;ディレクトリか判別
0021F0 F2E9 B7               4      OR  A
0021F1 F2EA C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
0021F2 F2EB 3AFFF2          13      LD  A,(SPCPAT)
0021F5 F2EE 4F               4      LD  C,A
0021F6 F2EF 3A19E9          13      LD  A,(_SECPS)
0021F9 F2F2 B9               4      CP  C
0021FA F2F3 3801            12      JR  C,DC1
0021FC F2F5 AF               4      XOR A
       F2F6                     DC1:
0021FD F2F6 F680             7      OR  080H
0021FF F2F8 32A0EE          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       F2FB                     CLUSTX:
002202 F2FB E5              11      PUSH    HL
002203 F2FC EB               4      EX  DE,HL
002204 F2FD AF               4      XOR A
002205 F2FE 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       F2FF                     SPCPAT  EQU $-1
       F300                     L_CLDBL:
002207 F300 CB19             8      RR  C       ;->CF
002209 F302 3804            12      JR  C,E_CLDBL
00220B F304 29              11      ADD HL,HL       ;*2
00220C F305 8F               4      ADC A,A
00220D F306 18F8            12      JR  L_CLDBL
       F308                     E_CLDBL:
00220F F308 4F               4      LD  C,A
002210 F309 3A19E9          13      LD  A,(_SECPS)
002213 F30C B5               4      OR  L
002214 F30D 6F               4      LD  L,A
002215 F30E 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       F30F                     CLSPAT  EQU $-2
002218 F311 AF               4      XOR A
002219 F312 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
00221A F313 89               4      ADC A,C
00221B F314 4F               4      LD  C,A
00221C F315 EB               4      EX  DE,HL
00221D F316 E1              10      POP HL
00221E F317 C9              10      RET
                                ;(8)
       F318                     ENDCL:
00221F F318 7A               4      LD  A,D ;END CLUSTER
002220 F319 FE01             7      CP  1   ;164=356    (self-modifying code)
       F31A                     CLPAT1  EQU $-1
002222 F31B C0              11      RET NZ
002223 F31C 7B               4      LD  A,E
002224 F31D FE64             7      CP  064H    ;       (self-modifying code)
       F31E                     CLPAT2  EQU $-1
002226 F31F C9              10      RET
                                ;(3)
       F320                     CAP4:
002227 F320 3EE5             7      LD  A,0E5H
002229 F322 C9              10      RET
                                                    ;for X1/88 ワークエリア
00222A F323 5BEE                    DW  _DISKE+1        ;DISKVE($F323)
00222C F325 F5EE                    DW  _BREAK+1        ;BREAKV($F325)
                                
       F327                     CAP:            ;(9)
00222E F327 FE61             7      CP  'a'
002230 F329 D8              11      RET C
002231 F32A FE7B             7      CP  'z'+1
002233 F32C D0              11      RET NC
002234 F32D D620             7      SUB 020H
002236 F32F C9              10      RET
                                ;(10)
       F330                     CAP2:
002237 F330 CD27F3          17      CALL    CAP
       F333                     CAP3:               ;
00223A F333 FE05             7      CP  5
00223C F335 28E9            12      JR  Z,CAP4
00223E F337 FE21             7      CP  021H
002240 F339 C9              10      RET
                                                    ;
       F33A                     CHDIR:
002241 F33A CDC9EB          17      CALL    GETDPBD
002244 F33D 381D            12      JR  C,CHDIR2
002246 F33F DD751A          19      LD  (IX+DPB_SDIR),L
002249 F342 DD741B          19      LD  (IX+DPB_SDIR+1),H
00224C F345 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       F347                     LDDIR:
00224E F347 CDC9EB          17      CALL    GETDPBD
002251 F34A DD5E1A          19      LD  E,(IX+DPB_SDIR)
002254 F34D DD561B          19      LD  D,(IX+DPB_SDIR+1)
002257 F350 13               6      INC DE
002258 F351 FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00225B F354 FD720F          19      LD  (IY+15),D
00225E F357 1B               6      DEC DE
00225F F358 AF               4      XOR A
002260 F359 32A0EE          13      LD  (_DIRF),A
       F35C                     CHDIR2:
002263 F35C DDE1            14      POP IX
002265 F35E C9              10      RET
                                
       F35F                     LDDIRX:
002266 F35F 3AA0EE          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
002269 F362 E67F             7      AND 07FH
       F364                     LDDIRX1:
00226B F364 3219E9          13      LD  (_SECPS),A
00226E F367 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
002271 F36A FD560F          19      LD  D,(IY+15)
002274 F36D 1B               6      DEC DE
002275 F36E CD18F3          17      CALL    ENDCL
002278 F371 D447F3          17      CALL    NC,LDDIR
       F374                     LDDIRS:
00227B F374 7A               4      LD  A,D
00227C F375 B3               4      OR  E
00227D F376 32A0EE          13      LD  (_DIRF),A   ;ディレクトリか判別
002280 F379 C9              10      RET
                                
       F37A                     KILL:
002281 F37A CD42F4          17      CALL    CHKWILDX
002284 F37D 3834            12      JR  C,KILLW
002286 F37F CD1DF1          17      CALL    SOPENX
       F382                     KILLS:
002289 F382 3E1F             7      LD  A,01FH
00228B F384 D4C6F3          17      CALL    NC,CHKATT
00228E F387 D8              11      RET C
       F388                     KILLSX:
00228F F388 36E5            10      LD  (HL),0E5H   ;DIR
002291 F38A CD1EF4          17      CALL    WTDB
002294 F38D 111A00          10      LD  DE,01AH
002297 F390 19              11      ADD HL,DE
002298 F391 5E               7      LD  E,(HL)
002299 F392 23               6      INC HL
00229A F393 56               7      LD  D,(HL)
       F394                     KILLS1:
00229B F394 CD18F3          17      CALL    ENDCL
00229E F397 D0              11      RET NC      ;CF=0
00229F F398 21FEFF          10      LD  HL,0-2
0022A2 F39B 19              11      ADD HL,DE
0022A3 F39C D0              11      RET NC      ;DE= 0 or 1
0022A4 F39D D5              11      PUSH    DE
0022A5 F39E CDF7EE          17      CALL    _GNCL
0022A8 F3A1 ED53FEEF        20      LD  (_CLPS),DE
0022AC F3A5 D1              10      POP DE
0022AD F3A6 210000          10      LD  HL,0
0022B0 F3A9 D4FAEE          17      CALL    NC,_SNCL
0022B3 F3AC D8              11      RET C
0022B4 F3AD ED5BFEEF        20      LD  DE,(_CLPS)  ;FAT
0022B8 F3B1 18E1            12      JR  KILLS1
                                
       F3B3                     KILLW:
0022BA F3B3 CD4CF1          17      CALL    SOPEN
       F3B6                     KILLW1:
0022BD F3B6 380B            12      JR  C,KILLW2
0022BF F3B8 CDEBF1          17      CALL    SOPENE2
0022C2 F3BB CD82F3          17      CALL    KILLS
0022C5 F3BE CDB0F1          17      CALL    NOPEN
0022C8 F3C1 18F3            12      JR  KILLW1
       F3C3                     KILLW2:
0022CA F3C3 C8              11      RET Z
0022CB F3C4 3F               4      CCF
0022CC F3C5 C9              10      RET
                                
       F3C6                     CHKATT:
0022CD F3C6 E5              11      PUSH    HL
0022CE F3C7 110B00          10      LD  DE,00BH
0022D1 F3CA 19              11      ADD HL,DE
0022D2 F3CB A6               7      AND (HL)
0022D3 F3CC E1              10      POP HL
0022D4 F3CD C8              11      RET Z
0022D5 F3CE 37               4      SCF
0022D6 F3CF C9              10      RET
                                
       F3D0                     NAME:
0022D7 F3D0 CD42F4          17      CALL    CHKWILDX
0022DA F3D3 D8              11      RET C
0022DB F3D4 110400          10      LD  DE,4
0022DE F3D7 19              11      ADD HL,DE
0022DF F3D8 22EDF3          16      LD  (NAMEP),HL
0022E2 F3DB 23               6      INC HL
0022E3 F3DC CD46F4          17      CALL    CHKWILD
0022E6 F3DF D8              11      RET C
                                
0022E7 F3E0 CD1DF1          17      CALL    SOPENX
0022EA F3E3 3E0F             7      LD  A,00FH
0022EC F3E5 D4C6F3          17      CALL    NC,CHKATT
0022EF F3E8 D8              11      RET C
                                
0022F0 F3E9 FDE5            15      PUSH    IY
0022F2 F3EB FD210000        14      LD  IY,0        ;自己書き換え
       F3ED                     NAMEP   EQU $-2
0022F6 F3EF CD1DF1          17      CALL    SOPENX
0022F9 F3F2 FDE3            23      EX  (SP),IY
0022FB F3F4 3F               4      CCF
0022FC F3F5 D44CF1          17      CALL    NC,SOPEN
0022FF F3F8 EB               4      EX  DE,HL
002300 F3F9 E1              10      POP HL
002301 F3FA D8              11      RET C
                                
       F3FB                     SETNAME:
002302 F3FB 01000B          10      LD  BC,11*256
002305 F3FE 23               6      INC HL
002306 F3FF 7E               7      LD  A,(HL)
002307 F400 FEE5             7      CP  0E5H
002309 F402 2004            12      JR  NZ,SNAME1
00230B F404 3E05             7      LD  A,5
00230D F406 180E            12      JR  SNAME3
       F408                     SNAME1:
00230F F408 7E               7      LD  A,(HL)
002310 F409 0C               4      INC C
002311 F40A 0D               4      DEC C
002312 F40B 2009            12      JR  NZ,SNAME3
002314 F40D CD27F3          17      CALL    CAP
002317 F410 FEA0             7      CP  0A0H
002319 F412 2002            12      JR  NZ,SNAME3
00231B F414 3E20             7      LD  A,020H
       F416                     SNAME3:
00231D F416 12               7      LD  (DE),A
00231E F417 7E               7      LD  A,(HL)
00231F F418 23               6      INC HL
002320 F419 CD2FF4          17      CALL    FKAN
002323 F41C 10EA            13      DJNZ    SNAME1
       F41E                     WTDB:               ;バッファデータが更新された
002325 F41E 3EFF             7      LD  A,0FFH
002327 F420 3239EE          13      LD  (SFILE),A
00232A F423 32A4EE          13      LD  (_WTDBF),A
00232D F426 AF               4      XOR A
00232E F427 C9              10      RET
                                
       F428                     FKANC:
00232F F428 CB41             8      BIT 0,C
002331 F42A CC30F3          17      CALL    Z,CAP2
002334 F42D 1801            12      JR  FKANX
       F42F                     FKAN:           ;漢字チェック
002336 F42F 13               6      INC DE
       F430                     FKANX:
002337 F430 CB41             8      BIT 0,C
002339 F432 CB81             8      RES 0,C
00233B F434 C0              11      RET NZ
00233C F435 FE80             7      CP  080H
00233E F437 D8              11      RET C
00233F F438 FEA0             7      CP  0A0H
002341 F43A 3803            12      JR  C,FKAN1
002343 F43C FEE0             7      CP  0E0H
002345 F43E D8              11      RET C
       F43F                     FKAN1:
002346 F43F 0C               4      INC C
002347 F440 A7               4      AND A
002348 F441 C9              10      RET
                                
       F442                     CHKWILDX:
002349 F442 FDE5            15      PUSH    IY
00234B F444 E1              10      POP HL
00234C F445 23               6      INC HL
       F446                     CHKWILD:
00234D F446 060B             7      LD  B,11
00234F F448 3E3F             7      LD  A,'?'
       F44A                     CHKWIL1:
002351 F44A BE               7      CP  (HL)
002352 F44B 23               6      INC HL
002353 F44C 37               4      SCF
002354 F44D C8              11      RET Z
002355 F44E 10FA            13      DJNZ    CHKWIL1
002357 F450 AF               4      XOR A
002358 F451 C9              10      RET
                                
       F452                     SDIRENT:        ;IY=FCB HL=DIR
002359 F452 D5              11      PUSH    DE
00235A F453 E5              11      PUSH    HL
00235B F454 FDE5            15      PUSH    IY
00235D F456 D1              10      POP DE
00235E F457 EB               4      EX  DE,HL
00235F F458 CDFBF3          17      CALL    SETNAME
                                ;               Attribute
002362 F45B FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
002365 F45E 12               7      LD  (DE),A
002366 F45F 13               6      INC DE
                                ;               Reserved
002367 F460 AF               4      XOR A
002368 F461 060A             7      LD  B,10
       F463                     SDE1:
00236A F463 12               7      LD  (DE),A
00236B F464 13               6      INC DE
00236C F465 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
00236E F467 21E4EF          10      LD  HL,SDDATA       ;(FCB)更新年月日
002371 F46A 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       F46C                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
002373 F46C 7E               7      LD  A,(HL)
002374 F46D 23               6      INC HL
002375 F46E 3273F4          13      LD  (SDPAT),A
002378 F471 FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       F473                     SDPAT   EQU $-1
00237B F474 12               7      LD  (DE),A
00237C F475 13               6      INC DE
00237D F476 10F4            13      DJNZ    SDLOOP
                                
00237F F478 AF               4      XOR A
002380 F479 E1              10      POP HL
002381 F47A D1              10      POP DE
002382 F47B C9              10      RET
                                
       F47C                     WOPEN:
002383 F47C FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
002386 F47F E61F             7      AND 01FH
002388 F481 37               4      SCF
002389 F482 C0              11      RET NZ
00238A F483 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       F487                     TOPEN2:
00238E F487 AF               4      XOR A
       F488                     TOPEN:              ;Initializes the time stamp
00238F F488 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
002393 F48C C9              10      RET
                                
       F48D                     WRDFX:
002394 F48D 3AFFF2          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       F490                     L_WRFX:
002397 F490 1F               4      RRA         ;->CF
002398 F491 3806            12      JR  C,E_WRFX
00239A F493 CB39             8      SRL C
00239C F495 CB1C             8      RR  H       ;CH=CH/2
00239E F497 18F7            12      JR  L_WRFX
       F499                     E_WRFX:
0023A0 F499 41               4      LD  B,C
0023A1 F49A 4C               4      LD  C,H
0023A2 F49B 03               6      INC BC
0023A3 F49C 3E37             7      LD  A,037H      ;SCF
0023A5 F49E 329FE7          13      LD  (DRDN1),A
                                
       F4A1                     WRDF:               ;BCクラスタ分FATを確保する
0023A8 F4A1 110200          10      LD  DE,2
0023AB F4A4 AF               4      XOR A
0023AC F4A5 3219E9          13      LD  (_SECPS),A
       F4A8                     WRDF1:
0023AF F4A8 C5              11      PUSH    BC
0023B0 F4A9 D5              11      PUSH    DE
0023B1 F4AA CDF7EE          17      CALL    _GNCL
0023B4 F4AD 381C            12      JR  C,WRDF3
0023B6 F4AF 7A               4      LD  A,D     ;空いているかチェック
0023B7 F4B0 B3               4      OR  E
0023B8 F4B1 202A            12      JR  NZ,WRDF4
0023BA F4B3 E1              10      POP HL      ;HL=空いているクラスタ
0023BB F4B4 E5              11      PUSH    HL
0023BC F4B5 ED5BFEEF        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
0023C0 F4B9 22FEEF          16      LD  (_CLPS),HL
0023C3 F4BC 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
0023C4 F4BD B3               4      OR  E
0023C5 F4BE 2008            12      JR  NZ,WRDF2
0023C7 F4C0 FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
0023CA F4C3 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
0023CD F4C6 1803            12      JR  WRDF3
       F4C8                     WRDF2:
0023CF F4C8 CDFAEE          17      CALL    _SNCL
       F4CB                     WRDF3:
0023D2 F4CB D1              10      POP DE
0023D3 F4CC C1              10      POP BC
0023D4 F4CD D8              11      RET C
0023D5 F4CE 0B               6      DEC BC
0023D6 F4CF 78               4      LD  A,B
0023D7 F4D0 B1               4      OR  C
0023D8 F4D1 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
0023DA F4D3 ED5BFEEF        20      LD  DE,(_CLPS)
0023DE F4D7 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
0023E1 F4DA C3FAEE          10      JP  _SNCL
                                
       F4DD                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
0023E4 F4DD D1              10      POP DE
0023E5 F4DE C1              10      POP BC
       F4DF                     WRDF5:
0023E6 F4DF 13               6      INC DE
0023E7 F4E0 CD18F3          17      CALL    ENDCL
0023EA F4E3 38C3            12      JR  C,WRDF1
0023EC F4E5 37               4      SCF
0023ED F4E6 C9              10      RET
                                
       F4E7                     RWXR:
0023EE F4E7 3A8EE6          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       F4EA                     L_RWX:
0023F1 F4EA 1F               4      RRA     ;->CF
0023F2 F4EB 3808            12      JR  C,E_RWX
0023F4 F4ED CB38             8      SRL B   ;BCH=BCH/2
0023F6 F4EF CB19             8      RR  C   ;
0023F8 F4F1 CB1C             8      RR  H   ;
0023FA F4F3 18F5            12      JR  L_RWX
       F4F5                     E_RWX:
0023FC F4F5 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0023FF F4F8 FD561B          19      LD  D,(IY+27)
002402 F4FB AF               4      XOR A
002403 F4FC 3219E9          13      LD  (_SECPS),A
       F4FF                     RWX1:
002406 F4FF ED53FEEF        20      LD  (_CLPS),DE
00240A F503 7A               4      LD  A,D
00240B F504 B3               4      OR  E
00240C F505 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
00240E F507 78               4      LD  A,B
00240F F508 B1               4      OR  C
002410 F509 B4               4      OR  H
002411 F50A C8              11      RET Z       ;RET BCH==0 => CF=0
                                
002412 F50B CD21E9          17      CALL    GNCLX
002415 F50E D8              11      RET C
002416 F50F 7C               4      LD  A,H     ;
002417 F510 25               4      DEC H       ;
002418 F511 B7               4      OR  A       ;DEC BCH
002419 F512 2001            12      JR  NZ,RWX2     ;
00241B F514 0B               6      DEC BC      ;
       F515                     RWX2:
00241C F515 CD18F3          17      CALL    ENDCL
00241F F518 38E5            12      JR  C,RWX1
       F51A                     SCF_RET:
002421 F51A 37               4      SCF
002422 F51B C9              10      RET
                                
       F51C                     DSKF:
002423 F51C 110000          10      LD  DE,0
       F51D                     MAXCLP  EQU $-2
002426 F51F 2AACEE          16      LD  HL,(_FAKEFREE)
002429 F522 7C               4      LD  A,H
00242A F523 B5               4      OR  L
00242B F524 2803            12      JR  Z,DSKF1
00242D F526 110100          10      LD  DE,1
       F529                     DSKF1:
002430 F529 D5              11      PUSH    DE
002431 F52A CDF7EE          17      CALL    _GNCL
002434 F52D 380C            12      JR  C,POPSCF
002436 F52F 7A               4      LD  A,D
002437 F530 B3               4      OR  E
002438 F531 2001            12      JR  NZ,DSKF2
00243A F533 23               6      INC HL
       F534                     DSKF2:
00243B F534 D1              10      POP DE
00243C F535 1B               6      DEC DE
00243D F536 7A               4      LD  A,D
00243E F537 B3               4      OR  E
00243F F538 20EF            12      JR  NZ,DSKF1
002441 F53A C9              10      RET
                                
       F53B                     POPSCF:
002442 F53B F1              10      POP AF
002443 F53C 37               4      SCF
002444 F53D C9              10      RET
                                
       F53E                     SETTMS:
002445 F53E FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
002448 F541 3C               4      INC A
002449 F542 C0              11      RET NZ      ;ファイルが更新されていない
       F543                     SETTMSX:            ;FCBに日付時刻をセットする
00244A F543 CDA7E0          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
00244D F546 CB25             8      SLA L       ;   *2
00244F F548 CB25             8      SLA L       ;   *4
002451 F54A 29              11      ADD HL,HL       ;*2 *8
002452 F54B 29              11      ADD HL,HL       ;*4 *16
002453 F54C 29              11      ADD HL,HL       ;*8 *32
002454 F54D 7A               4      LD  A,D
002455 F54E 0F               4      RRCA            ;bit.0->7->->->0->C
002456 F54F E61F             7      AND 01FH
002458 F551 B5               4      OR  L
002459 F552 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
00245C F555 FD7417          19      LD  (IY+23),H
                                
00245F F558 CD84E0          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
002462 F55B 0144F8          10      LD  BC,0-1980
002465 F55E 09              11      ADD HL,BC
002466 F55F 65               4      LD  H,L
                                
002467 F560 7A               4      LD  A,D
002468 F561 87               4      ADD A,A     ;*2
002469 F562 87               4      ADD A,A     ;*4
00246A F563 87               4      ADD A,A     ;*8
00246B F564 87               4      ADD A,A     ;*16
00246C F565 6F               4      LD  L,A
00246D F566 29              11      ADD HL,HL       ;*32
00246E F567 7D               4      LD  A,L
00246F F568 B3               4      OR  E
002470 F569 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
002473 F56C FD7415          19      LD  (IY+21),H
002476 F56F C9              10      RET
                                ;(16)
       F570                     PUSHRR:
002477 F570 3252E7          13      LD  (SETSEQ_SWC_RND),A
00247A F573 2264E7          16      LD  (SETSEQ_SWC_SEQ_RR),HL
00247D F576 CD96F5          17      CALL    GET_RR_AHL
002480 F579 220FEE          16      LD  (RR_BUF_HL),HL
002483 F57C 3211EE          13      LD  (RR_BUF_A),A
002486 F57F C9              10      RET
                                ;(14)
       F580                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
002487 F580 87               4      ADD A,A     ;in BHLA => out AHL
002488 F581 ED6A            15      ADC HL,HL
00248A F583 CB18             8      RR  B
00248C F585 B7               4      OR  A
00248D F586 78               4      LD  A,B     ;ここでフラグは変化しない
00248E F587 C8              11      RET Z
00248F F588 2C               4      INC L       ;INC AHL
002490 F589 C0              11      RET NZ      ;
002491 F58A 24               4      INC H       ;
002492 F58B C0              11      RET NZ      ;
002493 F58C 3C               4      INC A       ;
002494 F58D C9              10      RET
                                ;(18)
       F58E                     INIT_RND:
002495 F58E 3ECD             7      LD  A,0CDH      ;CALL ????
002497 F590 21ADF5          10      LD  HL,POPRR
00249A F593 CD70F5          17      CALL    PUSHRR
       F596                     GET_RR_AHL:
00249D F596 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0024A0 F599 FD6622          19      LD  H,(IY+34)   ;
0024A3 F59C FD7E23          19      LD  A,(IY+35)   ;
0024A6 F59F C9              10      RET
                                ;(10)
       F5A0                     SET_RR_AHL:
0024A7 F5A0 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0024AA F5A3 FD7422          19      LD  (IY+34),H   ;
0024AD F5A6 FD7723          19      LD  (IY+35),A   ;
0024B0 F5A9 C9              10      RET
                                ;(17)
       F5AA                     SETSEQ:
0024B1 F5AA CDCFF5          17      CALL    SETSEQ1
       F5AD                     POPRR:
0024B4 F5AD F5              11      PUSH    AF
0024B5 F5AE E5              11      PUSH    HL
0024B6 F5AF 2A0FEE          16      LD  HL,(RR_BUF_HL)
0024B9 F5B2 3A11EE          13      LD  A,(RR_BUF_A)
0024BC F5B5 CDA0F5          17      CALL    SET_RR_AHL
0024BF F5B8 E1              10      POP HL
0024C0 F5B9 F1              10      POP AF
0024C1 F5BA C9              10      RET
                                ;(20)
       F5BB                     GET_RR_BCDE:            ;BCDE=Random record
0024C2 F5BB FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
0024C5 F5BE FD5622          19      LD  D,(IY+34)
0024C8 F5C1 FD4E23          19      LD  C,(IY+35)
0024CB F5C4 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
0024CD F5C6 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0024D1 F5CA C0              11      RET NZ
0024D2 F5CB FD4624          19      LD  B,(IY+36)
0024D5 F5CE C9              10      RET
                                
       F5CF                     SETSEQ1:
0024D6 F5CF F5              11      PUSH    AF
0024D7 F5D0 E5              11      PUSH    HL      ;AHL=Random record
0024D8 F5D1 CD96F5          17      CALL    GET_RR_AHL
0024DB F5D4 47               4      LD  B,A     ;AHL→HLA
0024DC F5D5 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
0024DD F5D6 6C               4      LD  L,H     ;(IY+34)
0024DE F5D7 60               4      LD  H,B     ;(IY+35)
0024DF F5D8 0600             7      LD  B,0
                                
0024E1 F5DA CD80F5          17      CALL    GET_CPM_R_SIZE
                                
0024E4 F5DD 29              11      ADD HL,HL
0024E5 F5DE CB3D             8      SRL L       ;L=L/2
0024E7 F5E0 FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
0024EA F5E3 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
0024ED F5E6 E1              10      POP HL
0024EE F5E7 F1              10      POP AF
0024EF F5E8 C9              10      RET
                                
                                ;(23)
       F5E9                     RBXEND:             ;レコード数だけランダムレコードを進める
0024F0 F5E9 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       F5EA                     RBSIZE  EQU $-2
0024F3 F5EC CD96F5          17      CALL    GET_RR_AHL
0024F6 F5EF 19              11      ADD HL,DE
0024F7 F5F0 CE00             7      ADC A,0
0024F9 F5F2 CDA0F5          17      CALL    SET_RR_AHL
0024FC F5F5 EB               4      EX  DE,HL       ;HL=進めるレコード数
0024FD F5F6 D0              11      RET NC
0024FE F5F7 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
002502 F5FB C0              11      RET NZ
002503 F5FC FD3424          23      INC (IY+36)
002506 F5FF C9              10      RET
       F600                     FILE_E:
                                
       F1AA                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       F1AA                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       F1AA                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       F1AA                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       F1AA                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "X1DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   X1/turbo/Z
                                
       F600                     _DEVICE:
                                
                                ;   A:
                                
002507 F600 0200                    DW  2   ;DPB_FATLN
002509 F602 EBEE                    DW  _FDRD   ;DPB_DRD
00250B F604 EEEE                    DW  _FDWT   ;DPB_DWT
00250D F606 FD                      DB  0FDH    ;DPB_FATID
00250E F607 02                      DB  2   ;DPB_SECPCL
00250F F608 6401                    DW  356 ;DPB_MAXCL
002511 F60A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002512 F60B 07                      DB  7   ;DPB_DIRSCNT
002513 F60C 28                      DB  40  ;DPB_MAXCYL
002514 F60D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002515 F60E 01                      DB  1   ;DPB_FATPS
002516 F60F 82                      DB  082H    ;DPB_BPS
002517 F610 0500                    DW  5   ;DPB_DIRPS
002519 F612 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00251A F613 00                      DB  0   ;DPB_UNITNO
00251B F614 0800                    DW  8   ;DPB_ADDCL
00251D F616 0000                    DW  0   ;DPB_16
00251F F618 0000                    DW  0   ;DPB_18
002521 F61A 0000                    DW  0   ;DPB_SDIR
002523 F61C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002527 F620 0200                    DW  2   ;DPB_FATLN
002529 F622 EBEE                    DW  _FDRD   ;DPB_DRD
00252B F624 EEEE                    DW  _FDWT   ;DPB_DWT
00252D F626 FD                      DB  0FDH    ;DPB_FATID
00252E F627 02                      DB  2   ;DPB_SECPCL
00252F F628 6401                    DW  356 ;DPB_MAXCL
002531 F62A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002532 F62B 07                      DB  7   ;DPB_DIRSCNT
002533 F62C 28                      DB  40  ;DPB_MAXCYL
002534 F62D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002535 F62E 01                      DB  1   ;DPB_FATPS
002536 F62F 82                      DB  082H    ;DPB_BPS
002537 F630 0500                    DW  5   ;DPB_DIRPS
002539 F632 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00253A F633 01                      DB  1   ;DPB_UNITNO
00253B F634 0800                    DW  8   ;DPB_ADDCL
00253D F636 0000                    DW  0   ;DPB_16
00253F F638 0000                    DW  0   ;DPB_18
002541 F63A 0000                    DW  0   ;DPB_SDIR
002543 F63C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002547 F640 0200                    DW  2   ;DPB_FATLN
002549 F642 EBEE                    DW  _FDRD   ;DPB_DRD
00254B F644 EEEE                    DW  _FDWT   ;DPB_DWT
00254D F646 FD                      DB  0FDH    ;DPB_FATID
00254E F647 02                      DB  2   ;DPB_SECPCL
00254F F648 6401                    DW  356 ;DPB_MAXCL
002551 F64A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002552 F64B 07                      DB  7   ;DPB_DIRSCNT
002553 F64C 28                      DB  40  ;DPB_MAXCYL
002554 F64D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002555 F64E 01                      DB  1   ;DPB_FATPS
002556 F64F 82                      DB  082H    ;DPB_BPS
002557 F650 0500                    DW  5   ;DPB_DIRPS
002559 F652 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00255A F653 02                      DB  2   ;DPB_UNITNO
00255B F654 0800                    DW  8   ;DPB_ADDCL
00255D F656 0000                    DW  0   ;DPB_16
00255F F658 0000                    DW  0   ;DPB_18
002561 F65A 0000                    DW  0   ;DPB_SDIR
002563 F65C 46444432                DB  "FDD2"  ;DPB_NAME
                                
                                ;   D:
                                
002567 F660 0200                    DW  2   ;DPB_FATLN
002569 F662 EBEE                    DW  _FDRD   ;DPB_DRD
00256B F664 EEEE                    DW  _FDWT   ;DPB_DWT
00256D F666 FD                      DB  0FDH    ;DPB_FATID
00256E F667 02                      DB  2   ;DPB_SECPCL
00256F F668 6401                    DW  356 ;DPB_MAXCL
002571 F66A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002572 F66B 07                      DB  7   ;DPB_DIRSCNT
002573 F66C 28                      DB  40  ;DPB_MAXCYL
002574 F66D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002575 F66E 01                      DB  1   ;DPB_FATPS
002576 F66F 82                      DB  082H    ;DPB_BPS
002577 F670 0500                    DW  5   ;DPB_DIRPS
002579 F672 A7                      DB  0A7H    ;DPB_DEVICE
00257A F673 03                      DB  3   ;DPB_UNITNO
00257B F674 0800                    DW  8   ;DPB_ADDCL
00257D F676 0000                    DW  0   ;DPB_16
00257F F678 0000                    DW  0   ;DPB_18
002581 F67A 0000                    DW  0   ;DPB_SDIR
002583 F67C 46444433                DB  "FDD3"  ;DPB_NAME
                                
                                ;   E:
                                
002587 F680 0000                EMMFL:  DW  0   ;DPB_FATLN
002589 F682 31DC                EMMRD:  DW  EDRD    ;DPB_DRD
00258B F684 1DDC                EMMWR:  DW  EDWT    ;DPB_DWT
00258D F686 FE                      DB  0FEH    ;DPB_FATID
00258E F687 02                      DB  2   ;DPB_SECPCL
00258F F688 0000                EMMCL:  DW  0   ;DPB_MAXCL
002591 F68A 00                      DB  0   ;DPB_FDMODE
002592 F68B 0C                      DB  12  ;DPB_DIRSCNT
002593 F68C 00                      DB  0   ;DPB_MAXCYL
002594 F68D 00                      DB  0   ;DPB_MAXSEC
002595 F68E 02                      DB  2   ;DPB_FATPS
002596 F68F 02                      DB  2   ;DPB_BPS
002597 F690 0A00                    DW  10  ;DPB_DIRPS
002599 F692 06                      DB  6   ;DPB_DEVICE
00259A F693 00                      DB  0   ;DPB_UNITNO
00259B F694 1200                    DW  18  ;DPB_ADDCL
00259D F696 0000                    DW  0   ;DPB_16
00259F F698 0000                    DW  0   ;DPB_18
0025A1 F69A 0000                    DW  0   ;DPB_SDIR
0025A3 F69C 454D4D30                DB  "EMM0"  ;DPB_NAME
                                
                                ;   F:
                                
0025A7 F6A0 0000                BANKFL: DW  0   ;DPB_FATLN
0025A9 F6A2 B5DB                    DW  BDRD    ;DPB_DRD
0025AB F6A4 B1DB                    DW  BDWT    ;DPB_DWT
0025AD F6A6 F9                      DB  0F9H    ;DPB_FATID
0025AE F6A7 02                      DB  2   ;DPB_SECPCL
0025AF F6A8 0000                BANKCL: DW  0   ;DPB_MAXCL
0025B1 F6AA 00                      DB  0   ;DPB_FDMODE
0025B2 F6AB 08                      DB  8   ;DPB_DIRSCNT
0025B3 F6AC 00                      DB  0   ;DPB_MAXCYL
0025B4 F6AD 01                      DB  1   ;DPB_MAXSEC
0025B5 F6AE 00                      DB  0   ;DPB_FATPS
0025B6 F6AF 02                      DB  2   ;DPB_BPS
0025B7 F6B0 0200                    DW  2   ;DPB_DIRPS
0025B9 F6B2 0B                  BANKDV: DB  00BH    ;DPB_DEVICE
0025BA F6B3 00                      DB  0   ;DPB_UNITNO
0025BB F6B4 0600                    DW  6   ;DPB_ADDCL
0025BD F6B6 0000                    DW  0   ;DPB_16
0025BF F6B8 0000                    DW  0   ;DPB_18
0025C1 F6BA 0000                    DW  0   ;DPB_SDIR
0025C3 F6BC 4252414D                DB  "BRAM"  ;DPB_NAME
                                
                                ;   G:
                                
0025C7 F6C0 0200                    DW  2   ;DPB_FATLN
0025C9 F6C2 72DB                    DW  GDRD    ;DPB_DRD
0025CB F6C4 89DB                    DW  GDWT    ;DPB_DWT
0025CD F6C6 FA                      DB  0FAH    ;DPB_FATID
0025CE F6C7 01                      DB  1   ;DPB_SECPCL
0025CF F6C8 B800                    DW  184 ;DPB_MAXCL
0025D1 F6CA 00                      DB  0   ;DPB_FDMODE
0025D2 F6CB 07                      DB  7   ;DPB_DIRSCNT
0025D3 F6CC 00                      DB  0   ;DPB_MAXCYL
0025D4 F6CD 01                      DB  1   ;DPB_MAXSEC
0025D5 F6CE 01                      DB  1   ;DPB_FATPS
0025D6 F6CF 01                      DB  1   ;DPB_BPS
0025D7 F6D0 0300                    DW  3   ;DPB_DIRPS
0025D9 F6D2 05                      DB  5   ;DPB_DEVICE
0025DA F6D3 01                      DB  1   ;DPB_UNITNO
0025DB F6D4 0800                    DW  8   ;DPB_ADDCL
0025DD F6D6 0000                    DW  0   ;DPB_16
0025DF F6D8 0000                    DW  0   ;DPB_18
0025E1 F6DA 0000                    DW  0   ;DPB_SDIR
0025E3 F6DC 4752414D                DB  "GRAM"  ;DPB_NAME
                                
                                ;   H:
0025E7 F6E0                         DS  32-8
0025FF F6F8 00                      DB  0
[EOF:X1DPB.ASM:UTF_8]
                                
       F6F9                     LAST_ADR:
                                
                                    END
[EOF:X1.ASZ:UTF_8]
