0000                ;	LSX-Dodgers for X1/turbo/Z
0000                ;	Programmed by
0000                ;	Gaku (Lovers/Tablacus)
0000                
0000                	INCLUDE	"X1DEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                ;	X1/turbo/Z
0000                
0000 00 00 00 00    MAC	EQU	0		;X1
0000 00 00 00 00    DEV EQU 0
0000                
0000 00 00 CC 00    RUN	EQU	0CC00H
0000 00 00 D2 06    BDOS	EQU	0D206H
0000 00 00 F0 00    WORKAD	EQU	0F000H
0000 00 00 F3 00    FATBF	EQU	0F300H
0000 00 00 FB 00    DTBUF	EQU	0FB00H
0000 00 00 FF 00    KEYBF	EQU	0FF00H
0000 00 00 FF 20    KBUF	EQU	0FF20H
0000 00 00 FF CA    EXTSP	EQU	0FFCAH
0000 00 00 FF D9    TRAP38	EQU	0FFD9H
0000 00 00 00 50    WIDTH	EQU	80
0000 00 00 00 18    LINE	EQU	24
0000 00 00 00 07    COLORF	EQU	7
0000 00 00 00 10    KEYSP_H	EQU	16
0000 00 00 00 C2    KEYSP_L	EQU	0C2H
0000 00 00 00 09    COMS	EQU	9
0000                
0000                	INCLUDE	"LDDEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                
0000 00 00 00 01    VER_1   EQU	1
0000 00 00 00 05    VER_2   EQU	5
0000 00 00 00 06    VER_3   EQU	6
0000 00 00 1D 00    MACW	EQU	MAC + 01D00H	;機種フラグとLD判別フラグ
0000 00 00 00 00    MACD	EQU	MAC + DEV * 256	;機種フラグとデバイスフラグ
0000 00 00 01 56    VER	EQU	VER_1 * 256 + VER_2 * 16 + VER_3
0000                
0000 00 00 00 05    SYSTEM	EQU	00005H
0000 00 00 00 0F    JP_HL	EQU	0000FH
0000 00 00 00 5C    FCB1	EQU	0005CH
0000 00 00 00 6C    FCB2	EQU	0006CH
0000 00 00 00 5D    FCB1FN	EQU	FCB1+1
0000 00 00 00 6D    FCB2FN	EQU	FCB2+1
0000 00 00 00 80    DTA1	EQU	00080H
0000                
0000 00 00 FF CA    EXTBIO	EQU	0FFCAH
0000                
0000                
0000                	ORG	RUN-7
CBF9                
CBF9                ;	MSX BINARY HEADER
CBF9 FE             	DB	0FEH
CBFA                ;	MSX BINARY START ADDRESS
CBFA 00 CC          	DW	RUN
CBFC                ;	MSX BINARY END ADDRESS
CBFC F9 F2          	DW	LAST_ADR
CBFE                ;	MSX BINARY EXEC ADDRESS
CBFE 07 CC          	DW	START
CC00                
CC00                	INCLUDE	"X1INIT.ASM"
CC00                
CC00                ;	LSX-Dodgers INIT
CC00                ;	X1/turbo/Z
CC00                
CC00 C3 07 CC       	JP	START
CC03 00 1D          	DW	MACW
CC05 56 01          	DW	VER
CC07                
CC07                START:
CC07 F3             	DI
CC08 ED 5E          	IM	2
CC0A 31 CA FF       	LD	SP,EXTSP
CC0D CD 1B CC       	CALL	INIT		;NZならAUTOEXECを実行
CC10 21 00 00       	LD	HL,0
CC13 E5             	PUSH	HL
CC14 C8             	RET	Z
CC15 11 99 CF       	LD	DE,AUTOD
CC18 C3 FD F0       	JP	_COMANL
CC1B                
CC1B                INIT:
CC1B 3E 1E          	LD	A,01EH
CC1D D3 00          	OUT	(0),A
CC1F                
CC1F 01 00 00       	LD	BC,0
CC22 ED 43 8C F0    	LD	(_CTC),BC
CC26 01 04 0A       	LD	BC,00A04H
CC29 CD 43 CF       	CALL	CHKCTC
CC2C 01 04 07       	LD	BC,00704H
CC2F CD 43 CF       	CALL	CHKCTC
CC32 01 A8 1F       	LD	BC,01FA8H
CC35 CD 43 CF       	CALL	CHKCTC
CC38 01 A0 1F       	LD	BC,01FA0H
CC3B CD 43 CF       	CALL	CHKCTC
CC3E                ;
CC3E                INISIO:
CC3E 01 91 1F       	LD	BC,01F91H	;INIT SIO
CC41 16 01          	LD	D,1
CC43 ED 51          	OUT	(C),D
CC45                
CC45 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CC47 0E 93          	LD	C,093H
CC49 ED 51          	OUT	(C),D
CC4B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CC4D 0E 99          	LD	C,099H		;INIT SIO
CC4F 16 01          	LD	D,1
CC51 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CC53 0E 9B          	LD	C,09BH
CC55 ED 51          	OUT	(C),D
CC57 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CC59                
CC59 0E 80          	LD	C,080H		;INIT DMA
CC5B 21 06 C3       	LD	HL,0C306H
CC5E                INIDMA:
CC5E ED 61          	OUT	(C),H
CC60 2D             	DEC	L
CC61 20 FB          	JR	NZ,INIDMA
CC63                
CC63 3E E4          	LD	A,0E4H
CC65 CD DB DE       	CALL	COMOUT
CC68 AF             	XOR	A
CC69 CD B5 DE       	CALL	OT49SB
CC6C                
CC6C 3E F0          	LD	A,INTVEC/256
CC6E ED 47          	LD	I,A
CC70                
CC70 ED 4B 8C F0    	LD	BC,(_CTC)
CC74 0D             	DEC	C
CC75 0D             	DEC	C
CC76                
CC76 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CC78 3E C0          	LD	A,CTC0
CC7A ED 79          	OUT	(C),A
CC7C                
CC7C 0C             	INC	C
CC7D 3E 47          	LD	A,047H
CC7F ED 79          	OUT	(C),A
CC81 3E 0D          	LD	A,13		;Baudrate 9600-13
CC83 ED 79          	OUT	(C),A
CC85                
CC85 79             	LD	A,C
CC86 D6 10          	SUB	010H
CC88 4F             	LD	C,A
CC89                ;	LD	(SIOAD+1),BC
CC89                ;	LD	(SIOAD0+1),BC
CC89                ;	LD	(SIOAD1+1),BC
CC89                
CC89 21 E9 CF       	LD	HL,SIODATA
CC8C                SINIT1:
CC8C 7E             	LD	A,(HL)
CC8D 23             	INC	HL
CC8E FE FF          	CP	0FFH
CC90 28 04          	JR	Z,SINIT2
CC92 ED 79          	OUT	(C),A
CC94 18 F6          	JR	SINIT1
CC96                SINIT2:
CC96 3E E4          	LD	A,0E4H
CC98 CD DB DE       	CALL	COMOUT
CC9B 3E C8          	LD	A,INTVEC
CC9D CD B5 DE       	CALL	OT49SB
CCA0                ;
CCA0 01 C4 1F       	LD	BC,01FC4H
CCA3 3E 0C          	LD	A,00CH
CCA5 ED 79          	OUT	(C),A
CCA7                
CCA7 0E C0          	LD	C,0C0H
CCA9 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCAB                
CCAB 0C             	INC	C
CCAC 3E 28          	LD	A,40
CCAE ED 79          	OUT	(C),A
CCB0                
CCB0 0C             	INC	C
CCB1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCB3                
CCB3 0C             	INC	C
CCB4 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCB6                
CCB6 0E C5          	LD	C,0C5H
CCB8 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCBA                
CCBA                TEXT:
CCBA 0E B0          	LD	C,0B0H
CCBC 3E 80          	LD	A,080H
CCBE ED 79          	OUT	(C),A
CCC0 16 07          	LD	D,7
CCC2 0E B9          	LD	C,0B9H
CCC4 21 E2 CF       	LD	HL,TEXTDT
CCC7                TEXT1:
CCC7 04             	INC	B
CCC8 ED A3          	OUTI
CCCA 0C             	INC	C
CCCB 15             	DEC	D
CCCC 20 F9          	JR	NZ,TEXT1
CCCE 01 B0 1F       	LD	BC,01FB0H
CCD1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCD3                
CCD3 0E C4          	LD	C,0C4H
CCD5 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CCD7                
CCD7 01 01 1A       	LD	BC,01A01H
CCDA ED 78          	IN	A,(C)
CCDC E6 08          	AND	8
CCDE 28 09          	JR	Z,PRN
CCE0 0E 03          	LD	C,003H
CCE2 3E 0F          	LD	A,00FH
CCE4 ED 79          	OUT	(C),A
CCE6 01 04 0A       	LD	BC,00A04H
CCE9                PRN:
CCE9 21 00 00       	LD	HL,0
CCEC 06 5C          	LD	B,05CH
CCEE 3E FF          	LD	A,0FFH		;RST 38H
CCF0 CD 35 E1       	CALL	FILL_MEMORY
CCF3 06 A4          	LD	B,0A4H
CCF5 AF             	XOR	A
CCF6 CD 35 E1       	CALL	FILL_MEMORY
CCF9                
CCF9 3E C3          	LD	A,0C3H		;JP
CCFB 21 03 F0       	LD	HL,CPM_WBOOT
CCFE 32 00 00       	LD	(00000H),A
CD01 22 01 00       	LD	(00001H),HL	;IPL
CD04                
CD04 21 00 1D       	LD	HL,MACW	;3 bit7  DPB Compatible LA(1)
CD07 22 03 00       	LD	(00003H),HL	;  bit6-0 Machine X1(0)
CD0A                ;				;4 LSX-Dodgers(01DH)
CD0A 21 06 D2       	LD	HL,BDOS
CD0D 32 05 00       	LD	(00005H),A
CD10 22 06 00       	LD	(00006H),HL	;BDOS
CD13                
CD13 21 F5 DA       	LD	HL,BIOS
CD16 22 19 00       	LD	(00019H),HL	;BIOS-ROM
CD19                
CD19 21 D9 FF       	LD	HL,TRAP38	;TRAP38
CD1C 32 38 00       	LD	(00038H),A
CD1F 22 39 00       	LD	(00039H),HL	;RST 038H
CD22                
CD22 3E F0          	LD	A,CPM_BOOT/256
CD24 32 0B 00       	LD	(0000BH),A
CD27                
CD27 3E E9          	LD	A,0E9H		;JP (HL)
CD29 32 0F 00       	LD	(0000FH),A
CD2C                
CD2C 3E E6          	LD	A,0E6H
CD2E CD DB DE       	CALL	COMOUT
CD31 CD C0 DE       	CALL	IN49SB
CD34 F5             	PUSH	AF
CD35 CD C0 DE       	CALL	IN49SB
CD38 F1             	POP	AF
CD39 F5             	PUSH	AF
CD3A E6 12          	AND	012H
CD3C 20 05          	JR	NZ,KEYR
CD3E 3E 01          	LD	A,1
CD40 32 96 CE       	LD	(KEYREP+1),A
CD43                KEYR:
CD43 F1             	POP	AF
CD44 E6 03          	AND	3
CD46 28 0E          	JR	Z,NON
CD48                
CD48 01 D0 3F       	LD	BC,03FD0H
CD4B ED 49          	OUT	(C),C
CD4D 3E 37          	LD	A,037H
CD4F D3 D0          	OUT	(0D0H),A
CD51 ED 78          	IN	A,(C)
CD53 B9             	CP	C
CD54 28 65          	JR	Z,TURBO
CD56                NON:
CD56 21 1C D0       	LD	HL,AT_SCR1
CD59 11 65 DF       	LD	DE,SCR1
CD5C 01 94 00       	LD	BC,SCRNE-SCR1	;転送先のサイズ確認用
CD5F 01 85 00       	LD	BC,AT_SCRE-AT_SCR1
CD62 ED B0          	LDIR
CD64                
CD64 21 A1 D0       	LD	HL,AT_DWT
CD67 11 BD EE       	LD	DE,WTTRK
CD6A 01 8F 00       	LD	BC,DMAE-WTTRK	;転送先のサイズ確認用
CD6D 01 8E 00       	LD	BC,AT_CPUE-AT_DWT
CD70 ED B0          	LDIR
CD72                
CD72 21 2F D1       	LD	HL,AT_EDWT
CD75 11 E4 D7       	LD	DE,EDWT
CD78 01 4B 00       	LD	BC,EMME-EDWT	;転送先のサイズ確認用
CD7B 01 46 00       	LD	BC,AT_EMME-AT_EDWT
CD7E ED B0          	LDIR
CD80                
CD80 21 E0 DF       	LD	HL,AT_WTTRK+AT_RS
CD83 22 E9 F0       	LD	(_WTTRK+1),HL
CD86 21 06 EF       	LD	HL,AT_DRD+AT_R
CD89 22 EC F0       	LD	(_FDRD+1),HL
CD8C 21 BD EE       	LD	HL,AT_DWT+AT_R
CD8F 22 EF F0       	LD	(_FDWT+1),HL
CD92 21 F8 D7       	LD	HL,AT_EDRD+AT_RE
CD95 22 82 F2       	LD	(EMMRD),HL
CD98 21 E4 D7       	LD	HL,AT_EDWT+AT_RE
CD9B 22 84 F2       	LD	(EMMWR),HL
CD9E 21 E7 DF       	LD	HL,AT_SCRN+AT_RS
CDA1 22 D1 F0       	LD	(_SCRN+1),HL
CDA4                
CDA4 3E 27          	LD	A,027H			;ノンターボはMFM切り替えを行わない
CDA6 32 12 F2       	LD	(DEVICE+012H),A		;Aドライブ
CDA9 32 32 F2       	LD	(DEVICE+012H+32),A	;Bドライブ
CDAC 32 52 F2       	LD	(DEVICE+012H+32*2),A	;Cドライブ
CDAF 32 72 F2       	LD	(DEVICE+012H+32*3),A	;Dドライブ
CDB2                
CDB2 21 00 00       	LD	HL,0
CDB5 22 06 DF       	LD	(X1PAT),HL
CDB8 C3 44 CE       	JP	NOBANK
CDBB                
CDBB                TURBO:
CDBB F3             	DI			;Check BIOS
CDBC 06 1D          	LD	B,01DH
CDBE ED 79          	OUT	(C),A		;BIOS ON
CDC0 3A 51 2F       	LD	A,(02F51H)
CDC3 04             	INC	B		;B=01EH
CDC4 ED 79          	OUT	(C),A		;BIOS OFF
CDC6 FB             	EI
CDC7 FE C9          	CP	0C9H
CDC9 28 02          	JR	Z,BIOSOK
CDCB 18 05          	JR	NOBIOS
CDCD                BIOSOK:
CDCD 3E C3          	LD	A,0C3H		;JP
CDCF 32 18 00       	LD	(00018H),A
CDD2                NOBIOS:
CDD2 3E 1F          	LD	A,01FH		;スタートポート
CDD4 DB F0          	IN	A,(0F0H)
CDD6 0F             	RRCA
CDD7 38 0B          	JR	C,CRT1
CDD9 21 D2 CF       	LD	HL,_C8025H
CDDC 11 B0 F0       	LD	DE,CRTCD
CDDF 01 10 00       	LD	BC,16
CDE2 ED B0          	LDIR
CDE4                CRT1:
CDE4 3E 1F          	LD	A,01FH		;スタートポート
CDE6 DB F0          	IN	A,(0F0H)
CDE8 CB 57          	BIT	2,A
CDEA 28 18          	JR	Z,BANK
CDEC                
CDEC AF             	XOR	A
CDED                TZ1:				;前面スイッチが2HDの場合はMFMモードを2HDにしておく
CDED F5             	PUSH	AF
CDEE CD DC F0       	CALL	_GETDPB
CDF1 DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
CDF4 E6 8F          	AND	08FH
CDF6 FE 87          	CP	087H		;フロッピーでMEM切り替えがON
CDF8 20 04          	JR	NZ,TZ2
CDFA DD CB 0A 86    	RES	0,(IX+0AH)	;(DPB_0A_FDMODE)
CDFE                TZ2:
CDFE F1             	POP	AF
CDFF 3C             	INC	A
CE00 FE 08          	CP	8
CE02 38 E9          	JR	C,TZ1
CE04                
CE04                BANK:
CE04 01 00 0B       	LD	BC,00B00H
CE07 21 00 7F       	LD	HL,07F00H
CE0A F3             	DI
CE0B ED 69          	OUT	(C),L
CE0D 3A 00 00       	LD	A,(0)
CE10 FE EB          	CP	0EBH
CE12 20 05          	JR	NZ,BANK1
CE14 3E 2B          	LD	A,02BH
CE16 32 B2 F2       	LD	(BANKDV),A
CE19                BANK1:
CE19 ED 69          	OUT	(C),L
CE1B 5E             	LD	E,(HL)
CE1C 7B             	LD	A,E
CE1D C6 A5          	ADD	A,0A5H
CE1F 77             	LD	(HL),A
CE20 BE             	CP	(HL)
CE21 73             	LD	(HL),E
CE22 20 05          	JR	NZ,BANK2
CE24 2C             	INC	L
CE25 CB 65          	BIT	4,L
CE27 28 F0          	JR	Z,BANK1
CE29                BANK2:
CE29 3E 10          	LD	A,010H
CE2B ED 79          	OUT	(C),A
CE2D 7D             	LD	A,L
CE2E B7             	OR	A
CE2F 28 13          	JR	Z,NOBANK
CE31 26 00          	LD	H,0
CE33 29             	ADD	HL,HL	;*2
CE34 29             	ADD	HL,HL	;*4
CE35 29             	ADD	HL,HL	;*8
CE36 29             	ADD	HL,HL	;*16
CE37 29             	ADD	HL,HL	;*32
CE38 2B             	DEC	HL	;-1
CE39 2B             	DEC	HL	;-2
CE3A 2B             	DEC	HL	;-3
CE3B 22 A8 F2       	LD	(BANKCL),HL
CE3E CD 89 CF       	CALL	CALC_FATLN
CE41 32 A0 F2       	LD	(BANKFL),A
CE44                NOBANK:
CE44                EMM:
CE44 DD 21 80 F2    	LD	IX,EMMFL
CE48 CD 3A CF       	CALL	EADR0
CE4B ED 78          	IN	A,(C)
CE4D F5             	PUSH	AF
CE4E                
CE4E 11 00 00       	LD	DE,0
CE51                ECHECK1:
CE51 13             	INC	DE
CE52 CD 1E CF       	CALL	EADR2
CE55 ED 60          	IN	H,(C)
CE57 CD 1E CF       	CALL	EADR2
CE5A 7C             	LD	A,H
CE5B C6 E5          	ADD	A,0E5H
CE5D ED 79          	OUT	(C),A
CE5F 3C             	INC	A
CE60 CD 3A CF       	CALL	EADR0
CE63 ED 79          	OUT	(C),A
CE65 3D             	DEC	A
CE66 CD 1E CF       	CALL	EADR2
CE69 ED 68          	IN	L,(C)
CE6B CD 1E CF       	CALL	EADR2
CE6E ED 61          	OUT	(C),H
CE70 BD             	CP	L
CE71 20 04          	JR	NZ,ECHECK2
CE73 CB 5A          	BIT	3,D
CE75 28 DA          	JR	Z,ECHECK1
CE77                ECHECK2:
CE77 CD 3A CF       	CALL	EADR0
CE7A F1             	POP	AF
CE7B ED 79          	OUT	(C),A
CE7D FE EB          	CP	0EBH
CE7F 20 05          	JR	NZ,EMM_BPB
CE81 3E 26          	LD	A,026H
CE83 32 92 F2       	LD	(EMMDV),A
CE86                EMM_BPB:
CE86 21 F7 FF       	LD	HL,0-9
CE89 19             	ADD	HL,DE
CE8A 30 09          	JR	NC,NOEMM
CE8C 22 88 F2       	LD	(EMMCL),HL
CE8F CD 89 CF       	CALL	CALC_FATLN
CE92 32 80 F2       	LD	(EMMFL),A
CE95                NOEMM:
CE95 3E 00          KEYREP:	LD	A,000H
CE97 B7             	OR	A
CE98 28 07          	JR	Z,KEYR1
CE9A 01 00 00       	LD	BC,0
CE9D ED 43 8C F0    	LD	(_CTC),BC
CEA1                KEYR1:
CEA1 CD 6A CF       	CALL	SETCRTC
CEA4 01 30 F8       	LD	BC,0-80*25
CEA7 2A BA F0       	LD	HL,(_PAGE_MINUS)
CEAA ED 43 BA F0    	LD	(_PAGE_MINUS),BC
CEAE 1E 0C          	LD	E,00CH
CEB0 CD CD F0       	CALL	_PRINT
CEB3 22 BA F0       	LD	(_PAGE_MINUS),HL
CEB6                
CEB6 21 A5 CF       	LD	HL,INIMES
CEB9 CD 70 D8       	CALL	MSX
CEBC                
CEBC 3A 87 FF       	LD	A,(0FF87H)
CEBF FE 08          	CP	8
CEC1 30 1E          	JR	NC,INIT0
CEC3 5F             	LD	E,A
CEC4 C6 41          	ADD	A,'A'
CEC6 32 A2 CF       	LD	(AUTODV),A
CEC9 0E 0E          	LD	C,00EH
CECB CD 05 00       	CALL	SYSTEM
CECE 1C             	INC	E
CECF 21 85 F0       	LD	HL,_SEEKSP	;Disk error Ignore
CED2 CB FE          	SET	7,(HL)
CED4 0E 1B          	LD	C,01BH
CED6 CD 05 00       	CALL	SYSTEM
CED9                
CED9 21 85 F0       	LD	HL,_SEEKSP
CEDC CB BE          	RES	7,(HL)
CEDE                
CEDE 3C             	INC	A
CEDF 20 08          	JR	NZ,INIT1
CEE1                INIT0:
CEE1 1E 00          	LD	E,0
CEE3 0E 0E          	LD	C,00EH
CEE5 CD 05 00       	CALL	SYSTEM
CEE8 AF             	XOR	A
CEE9                INIT1:
CEE9 F3             	DI
CEEA 08             	EX	AF,AF'
CEEB 2E FE          	LD	L,0-2		;CALLのスタック分減らす
CEED 39             	ADD	HL,SP
CEEE 11 00 FF       	LD	DE,0FF00H
CEF1 45             	LD	B,L
CEF2 CD D3 D5       	CALL	ZERO_MEMORY_DE
CEF5 21 CA FF       	LD	HL,EXTBIO
CEF8 36 C9          	LD	(HL),0C9H	;RET
CEFA 23             	INC	HL
CEFB 06 0E          	LD	B,TRAP38-EXTBIO-1
CEFD 3E FF          	LD	A,0FFH		;RST 38H
CEFF CD 35 E1       	CALL	FILL_MEMORY
CF02 21 F5 CF       	LD	HL,AT_TRAP38
CF05 11 D9 FF       	LD	DE,TRAP38
CF08 01 27 00       	LD	BC,AT_TRAPE-AT_TRAP38
CF0B ED B0          	LDIR
CF0D 08             	EX	AF,AF'
CF0E B7             	OR	A
CF0F C8             	RET	Z
CF10                
CF10 3E E6          	LD	A,0E6H
CF12 CD DB DE       	CALL	COMOUT
CF15 CD C0 DE       	CALL	IN49SB
CF18 CD C0 DE       	CALL	IN49SB
CF1B FE 1B          	CP	01BH
CF1D C9             	RET
CF1E                
CF1E                EADR2:
CF1E D5             	PUSH	DE
CF1F EB             	EX	DE,HL
CF20 29             	ADD	HL,HL
CF21 29             	ADD	HL,HL
CF22 DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
CF25 DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
CF28 09             	ADD	HL,BC
CF29 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
CF2C 06 0D          	LD	B,00DH
CF2E ED 49          	OUT	(C),C
CF30 0C             	INC	C
CF31 ED 69          	OUT	(C),L
CF33 0C             	INC	C
CF34 ED 61          	OUT	(C),H
CF36 0C             	INC	C
CF37 EB             	EX	DE,HL
CF38 D1             	POP	DE
CF39 C9             	RET
CF3A                
CF3A                EADR0:
CF3A D5             	PUSH	DE
CF3B 11 00 00       	LD	DE,0
CF3E CD 1E CF       	CALL	EADR2
CF41 D1             	POP	DE
CF42 C9             	RET
CF43                
CF43                CHKCTC:
CF43 C5             	PUSH	BC
CF44 11 03 47       	LD	DE,04703H
CF47                INICTC1:
CF47 0C             	INC	C
CF48 ED 51          	OUT	(C),D
CF4A ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CF4C 1D             	DEC	E
CF4D 20 F8          	JR	NZ,INICTC1
CF4F C1             	POP	BC
CF50                
CF50 11 FA 07       	LD	DE,007FAH
CF53 ED 51          	OUT	(C),D
CF55 ED 59          	OUT	(C),E
CF57 ED 78          	IN	A,(C)
CF59 BB             	CP	E
CF5A C0             	RET	NZ
CF5B ED 51          	OUT	(C),D
CF5D ED 51          	OUT	(C),D
CF5F ED 78          	IN	A,(C)
CF61 BA             	CP	D
CF62 C0             	RET	NZ
CF63 0C             	INC	C
CF64 0C             	INC	C
CF65 ED 43 8C F0    	LD	(_CTC),BC
CF69 C9             	RET
CF6A                
CF6A                SETCRTC:
CF6A 21 B0 F0       	LD	HL,CRTCD
CF6D AF             	XOR	A
CF6E                SETCRT1:
CF6E 01 00 18       	LD	BC,01800H
CF71 ED 79          	OUT	(C),A
CF73 0C             	INC	C
CF74 04             	INC	B
CF75 ED A3          	OUTI
CF77 3C             	INC	A
CF78 FE 0C          	CP	12
CF7A 20 F2          	JR	NZ,SETCRT1
CF7C 23             	INC	HL
CF7D 23             	INC	HL
CF7E 01 03 1B       	LD	BC,01A03H+00100H
CF81 ED A3          	OUTI
CF83 01 D0 20       	LD	BC,01FD0H+00100H
CF86 ED A3          	OUTI
CF88 C9             	RET
CF89                
CF89                CALC_FATLN:	;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
CF89 5D             	LD	E,L
CF8A 54             	LD	D,H
CF8B 29             	ADD	HL,HL	;*2
CF8C 19             	ADD	HL,DE	;*3
CF8D CB 3C          	SRL	H	;/2
CF8F CB 1D          	RR	L	;1クラスタ辺り1.5バイト必要
CF91 11 FF 01       	LD	DE,511	;切り上げる
CF94 19             	ADD	HL,DE
CF95 7C             	LD	A,H
CF96 CB 3F          	SRL	A
CF98 C9             	RET
CF99                
CF99 41 55 54 4F    AUTOD:	DB	"AUTOEXEC "
CF9D 45 58 45 43
CFA1 20
CFA2 41 3A 00       AUTODV:	DB	"A:",0
CFA5                
CFA5 4C 53 58 2D    INIMES:	DB	"LSX-Dodgers for X1/turbo version "
CFA9 44 6F 64 67
CFAD 65 72 73 20
CFB1 66 6F 72 20
CFB5 58 31 2F 74
CFB9 75 72 62 6F
CFBD 20 76 65 72
CFC1 73 69 6F 6E
CFC5 20
CFC6 31 2E          	DB	030H + VER_1, '.'
CFC8 35 36          	DB	030H + VER_2 ,030H + VER_3
CFCA                ;	DB	""
CFCA 20 47 61 6B    	DB	' Gaku',0DH,0AH
CFCE 75 0D 0A
CFD1 00             	DB	0
CFD2                
CFD2                _C8025H:
CFD2 6B 50 59 88    	DB	06BH,050H,059H,088H,01BH,001H,019H,01AH
CFD6 1B 01 19 1A
CFDA 00 0F          	DB	000H,00FH
CFDC 80 F8 B0 FF    	DW	0-80*LINE,0-80
CFE0 0C 23          	DB	00CH,023H
CFE2                
CFE2 03 0C 0F 30    TEXTDT:	DB	003H,00CH,00FH,030H,033H,03CH,03FH
CFE6 33 3C 3F
CFE9                
CFE9                SIODATA:
CFE9 18             	DB	018H
CFEA 01 00          	DB	1,0
CFEC 02 00          	DB	2,0
CFEE 03 C1          	DB	3,0C1H
CFF0 04 44          	DB	4,044H
CFF2 05 E8          	DB	5,0E8H
CFF4 FF             	DB	0FFH
CFF5                
CFF5                AT_TRAP38:
CFF5 21 00 00       	LD	HL,0
CFF8 E3             	EX	(SP),HL
CFF9 3E 24          	LD	A,'$'
CFFB CD BC DB       	CALL	MSG_A
CFFE 2B             	DEC	HL
CFFF 7C             	LD	A,H
D000 CD E8 FF       	CALL	PRHX+AT_RT
D003 7D             	LD	A,L
D004                PRHX:
D004 F5             	PUSH	AF
D005 07             	RLCA
D006 07             	RLCA
D007 07             	RLCA
D008 07             	RLCA
D009 CD F1 FF       	CALL	PRHX2+AT_RT
D00C F1             	POP	AF
D00D                PRHX2:
D00D E6 0F          	AND	00FH
D00F FE 0A          	CP	10
D011 3F             	CCF
D012 CE 30          	ADC	A,'0'
D014 27             	DAA
D015 C3 BC DB       	JP	MSG_A
D018                	DS	4
D01C                AT_TRAPE:
D01C                	INCLUDE	"X1CPU.ASM"
D01C                
D01C                ;	LSX-Dodgers CPU
D01C                ;	X1/turbo/Z
D01C                
D01C                ;	ノンターボ用パッチ
D01C                ;	DMAを使って転送している部分をCPUに差し替える
D01C                
D01C                AT_SCR1:
D01C D9             	EXX
D01D C5             	PUSH	BC
D01E ED 4B B1 F0    	LD	BC,(_WIDTH)
D022 06 20          	LD	B,020H
D024 D9             	EXX
D025 C5             	PUSH	BC
D026 01 00 20       	LD	BC,02000H
D029                
D029 67             	LD	H,A
D02A B7             	OR	A
D02B                AT_SCRUP1:
D02B 28 15          	JR	Z,AT_SCRCL
D02D C5             	PUSH	BC
D02E CB E0          	SET	4,B
D030 D9             	EXX
D031 C5             	PUSH	BC
D032 CB E0          	SET	4,B
D034 D9             	EXX
D035 CD 96 DF       	CALL	AT_UPSUB+AT_RS
D038 D9             	EXX
D039 C1             	POP	BC
D03A D9             	EXX
D03B C1             	POP	BC
D03C CD 96 DF       	CALL	AT_UPSUB+AT_RS
D03F 25             	DEC	H
D040 18 E9          	JR	AT_SCRUP1
D042                
D042                AT_SCRCL:
D042 2A B1 F0       	LD	HL,(_WIDTH)
D045 CD 2E DE       	CALL	LINECL
D048 C1             	POP	BC
D049 D9             	EXX
D04A C1             	POP	BC
D04B D9             	EXX
D04C C9             	RET
D04D                
D04D                AT_UPSUB:
D04D 3A B1 F0       	LD	A,(_WIDTH)
D050 6F             	LD	L,A
D051                AT_UPSUB1:
D051 D9             	EXX
D052 ED 78          	IN	A,(C)
D054 03             	INC	BC
D055 D9             	EXX
D056 ED 79          	OUT	(C),A
D058 03             	INC	BC
D059 2D             	DEC	L
D05A 20 F5          	JR	NZ,AT_UPSUB1
D05C C9             	RET
D05D                
D05D                ;	FLOPPY DISK DRIVER(CPU)
D05D                
D05D                DISKC:
D05D 1B             	DEC	DE
D05E CB 5F          	BIT	3,A
D060 C4 B6 EE       	CALL	NZ,RNF
D063                DISKD:
D063 E5             	PUSH	HL
D064 21 BC EE       	LD	HL,RETRY
D067 35             	DEC	(HL)
D068 E1             	POP	HL
D069 20 0C          	JR	NZ,AT_ERR		;Retry
D06B B7             	OR	A
D06C 28 09          	JR	Z,AT_ERR		;Error
D06E                
D06E                AT_DELP:
D06E CD B6 EE       	CALL	RNF
D071 CD 92 EE       	CALL	FDMOFF
D074 3E FF          	LD	A,0FFH
D076                AT_ERRZ:
D076 BF             	CP	A
D077                AT_ERR:
D077 3E FF          	LD	A,0FFH
D079 C9             	RET
D07A                ERRW:
D07A 3E FF          	LD	A,0FFH
D07C BF             	CP	A
D07D 37             	SCF
D07E C3 92 EE       	JP	FDMOFF
D081                
D081                ERRDW:
D081 D1             	POP	DE
D082 CD B7 DF       	CALL	AT_DELP+AT_RS
D085 C2 CB EE       	JP	NZ,DWT0+AT_R
D088 B7             	OR	A
D089 20 EF          	JR	NZ,ERRW
D08B C9             	RET
D08C                
D08C                ERRDR:
D08C D1             	POP	DE
D08D CD B7 DF       	CALL	AT_DELP+AT_RS
D090 C2 14 EF       	JP	NZ,DRD0+AT_R
D093 B7             	OR	A
D094 20 E4          	JR	NZ,ERRW
D096 C9             	RET
D097                
D097                AT_WTTRK:
D097 06 01          	LD	B,1
D099 3E F4          	LD	A,0F4H
D09B C3 BF EE       	JP	AT_WTTRK1+AT_R
D09E                
D09E                AT_SCRN:
D09E ED 78          	IN	A,(C)
D0A0 C9             	RET
D0A1                AT_SCRE:
D0A1                
D0A1                AT_DWT:
D0A1 3E A0          	LD	A,0A0H
D0A3                AT_WTTRK1:
D0A3 32 5A EE       	LD	(FDCPAT+1),A
D0A6                DWTBL:
D0A6 78             	LD	A,B
D0A7 32 02 EF       	LD	(AT_WTB+1+AT_R),A
D0AA 3E 02          	LD	A,2		;Retry count
D0AC 32 BC EE       	LD	(RETRY),A
D0AF                
D0AF                DWT0:
D0AF D5             	PUSH	DE
D0B0 E5             	PUSH	HL
D0B1 CD F9 ED       	CALL	SEEK		;Write disk
D0B4 E1             	POP	HL
D0B5 DA CA DF       	JP	C,ERRDW+AT_RS
D0B8 F3             	DI
D0B9 3A 5A EE       	LD	A,(FDCPAT+1)
D0BC CD 9E EE       	CALL	SECSET
D0BF 0E FB          	LD	C,0FBH
D0C1                
D0C1                DWT1:
D0C1 56             	LD	D,(HL)
D0C2                DWT2:
D0C2 78             	LD	A,B
D0C3 DB F8          	IN	A,(0F8H)
D0C5 0F             	RRCA
D0C6 30 08          	JR	NC,DWT4
D0C8 0F             	RRCA
D0C9 30 F7          	JR	NC,DWT2
D0CB                DWT3:
D0CB ED 51          	OUT	(C),D
D0CD 23             	INC	HL
D0CE 18 F1          	JR	DWT1
D0D0                
D0D0                DWT4:
D0D0 3D             	DEC	A
D0D1 28 F8          	JR	Z,DWT3
D0D3 3C             	INC	A
D0D4 FB             	EI
D0D5 D1             	POP	DE
D0D6 13             	INC	DE
D0D7 CD 92 EE       	CALL	FDMOFF
D0DA 28 09          	JR	Z,DISKOK_WT
D0DC CD A6 DF       	CALL	DISKC+AT_RS
D0DF 20 CE          	JR	NZ,DWT0
D0E1 B7             	OR	A
D0E2 C2 C3 DF       	JP	NZ,ERRW+AT_RS
D0E5                
D0E5                DISKOK_WT:
D0E5 06 01          AT_WTB:	LD	B,1
D0E7 10 BD          	DJNZ	DWTBL
D0E9 C9             	RET
D0EA                
D0EA                AT_DRD:
D0EA 3E 80          	LD	A,080H
D0EC 32 5A EE       	LD	(FDCPAT+1),A
D0EF                DRDBL:
D0EF 78             	LD	A,B
D0F0 32 47 EF       	LD	(AT_RDB+1+AT_R),A
D0F3 3E 02          	LD	A,2		;Retry count
D0F5 32 BC EE       	LD	(RETRY),A
D0F8                DRD0:
D0F8 D5             	PUSH	DE
D0F9 E5             	PUSH	HL
D0FA CD F9 ED       	CALL	SEEK		;Read disk
D0FD E1             	POP	HL
D0FE DA D5 DF       	JP	C,ERRDR+AT_RS
D101 F3             	DI
D102 3A 5A EE       	LD	A,(FDCPAT+1)
D105 CD 9E EE       	CALL	SECSET
D108 0E FB          	LD	C,0FBH
D10A                DRD1:
D10A 78             	LD	A,B
D10B DB F8          	IN	A,(0F8H)
D10D 0F             	RRCA
D10E 30 08          	JR	NC,DRD3
D110 0F             	RRCA
D111 30 F7          	JR	NC,DRD1
D113 ED A2          	INI
D115 04             	INC	B
D116 18 F2          	JR	DRD1
D118                
D118                DRD3:
D118 B7             	OR	A
D119 FB             	EI
D11A D1             	POP	DE
D11B 13             	INC	DE
D11C CD 92 EE       	CALL	FDMOFF
D11F 28 09          	JR	Z,DISKOK_RD
D121 CD A6 DF       	CALL	DISKC+AT_RS
D124 20 D2          	JR	NZ,DRD0
D126 B7             	OR	A
D127 C2 C3 DF       	JP	NZ,ERRW+AT_RS
D12A                
D12A                DISKOK_RD:
D12A 06 01          AT_RDB:	LD	B,1
D12C 10 C1          	DJNZ	DRDBL
D12E C9             	RET
D12F                
D12F                AT_CPUE:
D12F                
D12F                
D12F                ;	EMM DRIVER(CPU)
D12F                
D12F                
D12F                AT_EDWT:
D12F CD 0C D8       	CALL	AT_EADR+AT_RE
D132                AT_EDWT0:
D132 F5             	PUSH	AF
D133 AF             	XOR	A
D134                AT_EDWT1:
D134 04             	INC	B
D135 ED A3          	OUTI
D137 04             	INC	B
D138 ED A3          	OUTI
D13A 3D             	DEC	A
D13B 20 F7          	JR	NZ,AT_EDWT1
D13D 13             	INC	DE
D13E F1             	POP	AF
D13F 3D             	DEC	A
D140 20 F0          	JR	NZ,AT_EDWT0
D142 C9             	RET
D143                
D143                AT_EDRD:
D143 CD 0C D8       	CALL	AT_EADR+AT_RE
D146                AT_EDRD0:
D146 F5             	PUSH	AF
D147 AF             	XOR	A
D148                AT_EDRD1:
D148 ED A2          	INI
D14A 04             	INC	B
D14B ED A2          	INI
D14D 04             	INC	B
D14E 3D             	DEC	A
D14F 20 F7          	JR	NZ,AT_EDRD1
D151 13             	INC	DE
D152 F1             	POP	AF
D153 3D             	DEC	A
D154 20 F0          	JR	NZ,AT_EDRD0
D156 C9             	RET
D157                
D157                AT_EADR:
D157 C5             	PUSH	BC
D158 D5             	PUSH	DE
D159 EB             	EX	DE,HL
D15A 29             	ADD	HL,HL
D15B DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
D15E DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
D161 09             	ADD	HL,BC
D162 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
D165 06 0D          	LD	B,00DH
D167 ED 49          	OUT	(C),C
D169 0C             	INC	C
D16A ED 69          	OUT	(C),L
D16C 0C             	INC	C
D16D ED 61          	OUT	(C),H
D16F 0C             	INC	C
D170 EB             	EX	DE,HL
D171 D1             	POP	DE
D172 F1             	POP	AF
D173 A7             	AND	A	;CF=0
D174 C9             	RET
D175                AT_EMME:
D175                
D175 00 00 2F E4    AT_RT	EQU	TRAP38-AT_TRAP38
D175                
D175                INITE:
D175                	DS	BDOS-INITE
D206 C3 2F D8       	JP	BDOS0
D209                	INCLUDE	"X1CCP.ASM"
D209                
D209                ;	LSX-Dodgers CCP
D209                ;	X1/turbo/Z
D209                
D209                WBOOT1:
D209 F3             	DI
D20A ED 7B 06 00    	LD	SP,(SYSTEM+1)
D20E                
D20E 3E F0          	LD	A,INTVEC/256
D210 ED 47          	LD	I,A
D212                
D212 3E E4          	LD	A,0E4H
D214 CD DB DE       	CALL	COMOUT
D217 3E C8          	LD	A,INTVEC
D219 CD B5 DE       	CALL	OT49SB
D21C                
D21C 21 B0 F0       	LD	HL,CRTCD
D21F AF             	XOR	A
D220                SETCRT2:
D220 01 00 18       	LD	BC,01800H
D223 ED 79          	OUT	(C),A
D225 0C             	INC	C
D226 56             	LD	D,(HL)
D227 FE 0D          	CP	13
D229 38 02          	JR	C,SETCRT3
D22B 16 00          	LD	D,0
D22D                SETCRT3:
D22D ED 51          	OUT	(C),D
D22F 23             	INC	HL
D230 3C             	INC	A
D231 FE 0E          	CP	14
D233 20 EB          	JR	NZ,SETCRT2
D235                
D235 01 03 1B       	LD	BC,01A03H+00100H
D238 ED A3          	OUTI
D23A 01 D0 20       	LD	BC,01FD0H+00100H
D23D ED A3          	OUTI
D23F 21 92 F0       	LD	HL,_KEYD
D242 7E             	LD	A,(HL)
D243 36 00          	LD	(HL),0
D245 CD A9 DB       	CALL	KEYBC_IFBREAK
D248 3E 04          	LD	A,4
D24A CD BC DB       	CALL	MSG_A
D24D                	INCLUDE	"LDCCP.ASM"
D24D                
D24D                ;	LSX-Dodgers CCP
D24D                
D24D                COMMAND:
D24D 3A B2 EF       	LD	A,(FCB_BAT)
D250 B7             	OR	A
D251 C2 92 D3       	JP	NZ,C_BAT1
D254 CD 07 D3       	CALL	SETDTA1
D257 3A 87 F0       	LD	A,(_DVSW)
D25A C6 41          	ADD	A,'A'
D25C CD BC DB       	CALL	MSG_A
D25F 3E 3E          	LD	A,'>'
D261 CD BC DB       	CALL	MSG_A
D264 3E 50          	LD	A,80
D266 12             	LD	(DE),A
D267 CD 0B DC       	CALL	_SYS0A		;(BDOS)文字列入力
D26A CD 95 D4       	CALL	LTNL
D26D                COMMAND2:
D26D 11 82 00       	LD	DE,DTA1+2
D270 CD FD F0       	CALL	_COMANL
D273 30 D8          	JR	NC,COMMAND
D275 11 79 F0       	LD	DE,COMERM
D278 CD 61 D8       	CALL	_SYS09		;(BDOS)文字列出力
D27B C7             	RST	0
D27C                
D27C                COMANL:
D27C CD 89 E0       	CALL	FILE
D27F 3A 19 F0       	LD	A,(FNAME+4)
D282 FE 20          	CP	020H
D284 20 1C          	JR	NZ,COMB2
D286 D5             	PUSH	DE
D287 11 15 F0       	LD	DE,FNAME
D28A 1A             	LD	A,(DE)
D28B FE 20          	CP	020H
D28D 28 44          	JR	Z,SDVSW
D28F 1B             	DEC	DE
D290 1A             	LD	A,(DE)
D291 C6 FF          	ADD	A,0FFH
D293 38 09          	JR	C,COMB
D295 13             	INC	DE
D296                
D296 21 03 D7       	LD	HL,COMTB
D299 06 09          	LD	B,COMS
D29B CD 0D E3       	CALL	CPNAME
D29E                COMB:
D29E D1             	POP	DE
D29F D2 0F 00       	JP	NC,JP_HL
D2A2                COMB2:
D2A2 EB             	EX	DE,HL
D2A3 22 6F D3       	LD	(COMPAT+1),HL
D2A6 F5             	PUSH	AF
D2A7 CD 27 D3       	CALL	CEXE4
D2AA F1             	POP	AF
D2AB 21 15 F0       	LD	HL,FNAME
D2AE 11 6D 00       	LD	DE,FCB2+1	;COMMAND NAME
D2B1 01 0B 00       	LD	BC,11
D2B4 ED B0          	LDIR
D2B6 11 4C EF       	LD	DE,PATHD
D2B9                CEX1:
D2B9 1A             	LD	A,(DE)
D2BA FE 20          	CP	020H
D2BC D8             	RET	C
D2BD CD 7E E0       	CALL	FILEC
D2C0 D5             	PUSH	DE
D2C1 21 6D 00       	LD	HL,FCB2+1	;COMMAND NAME
D2C4 11 15 F0       	LD	DE,FNAME
D2C7 01 0B 00       	LD	BC,11
D2CA ED B0          	LDIR
D2CC CD 27 D3       	CALL	CEXE4
D2CF D1             	POP	DE
D2D0 13             	INC	DE
D2D1 18 E6          	JR	CEX1
D2D3                
D2D3                SDVSW:
D2D3 F1             	POP	AF
D2D4 3A 14 F0       	LD	A,(FDRV)
D2D7 3D             	DEC	A
D2D8 5F             	LD	E,A
D2D9 0E 0E          	LD	C,00EH		;(BDOS)カレントドライブの設定
D2DB 18 31          	JR	SYSTEM0
D2DD                
D2DD                OPEN1:
D2DD 21 14 F0       	LD	HL,FDRV
D2E0                OPEN:
D2E0 0E 11          	LD	C,011H		;(BDOS)ファイルの検索
D2E2                OPEN3:
D2E2 D5             	PUSH	DE
D2E3 11 8D EF       	LD	DE,DTA_CCP
D2E6 CD 04 D3       	CALL	SETDTA
D2E9 EB             	EX	DE,HL
D2EA CD 0E D3       	CALL	SYSTEM0
D2ED D1             	POP	DE
D2EE C9             	RET
D2EF                
D2EF                OPEN2:
D2EF 0E 12          	LD	C,012H
D2F1 18 EF          	JR	OPEN3
D2F3                
D2F3                DEFCB:				;Z=Ok NZ=Error
D2F3 11 8D EF       	LD	DE,DTA_CCP
D2F6 CD 0C D3       	CALL	SYSC0F
D2F9                
D2F9 11 AE EF       	LD	DE,DTA_CCP+33	;(FCB)ランダムレコード
D2FC 06 04          	LD	B,4
D2FE CD D3 D5       	CALL	ZERO_MEMORY_DE
D301                SETDTA100:
D301 11 00 01       	LD	DE,00100H
D304                SETDTA:
D304 C3 39 DA       	JP	_SYS1A		;(BDOS)DTAの設定
D307                
D307                SETDTA1:
D307 11 80 00       	LD	DE,DTA1
D30A 18 F8          	JR	SETDTA
D30C                
D30C                SYSC0F:
D30C 0E 0F          	LD	C,00FH		;(BDOS)ファイルのオープン
D30E                SYSTEM0:
D30E CD 05 00       	CALL	SYSTEM
D311 B7             	OR	A
D312 C9             	RET
D313                
D313                C_CD:
D313 0E 5A          	LD	C,5AH
D315 18 F7          	JR	SYSTEM0
D317                
D317                S27BUF:
D317 3A 07 00       	LD	A,(SYSTEM+2)
D31A 3D             	DEC	A
D31B E6 F8          	AND	0F8H
D31D 67             	LD	H,A
D31E 2E 00          	LD	L,0
D320                S27DTA:
D320 11 8D EF       	LD	DE,DTA_CCP
D323                S27:
D323 0E 27          	LD	C,027H		;(BDOS)ランダムブロック読み込み
D325 18 E7          	JR	SYSTEM0
D327                
D327                CEXE4:
D327 21 1D F0       	LD	HL,FNAME+8
D32A 7E             	LD	A,(HL)
D32B FE 20          	CP	020H
D32D 20 07          	JR	NZ,CEXE7
D32F 3E 3F          	LD	A,'?'
D331 77             	LD	(HL),A
D332 23             	INC	HL
D333 77             	LD	(HL),A
D334 23             	INC	HL
D335 77             	LD	(HL),A
D336                CEXE7:
D336 CD DD D2       	CALL	OPEN1
D339                CEXE5:
D339 C0             	RET	NZ
D33A 2A 97 EF       	LD	HL,(DTA_CCP+1+9)
D33D 7C             	LD	A,H
D33E CD 95 E3       	CALL	CAP
D341 67             	LD	H,A
D342 7D             	LD	A,L
D343 CD 95 E3       	CALL	CAP
D346 6F             	LD	L,A
D347 3A 96 EF       	LD	A,(DTA_CCP+1+8)
D34A CD 95 E3       	CALL	CAP
D34D D6 42          	SUB	'B'
D34F 28 2C          	JR	Z,C_BAT
D351 3D             	DEC	A		;'C'
D352 28 05          	JR	Z,C_EXE
D354                CEXE6:
D354 CD EF D2       	CALL	OPEN2
D357 18 E0          	JR	CEXE5
D359                
D359                C_EXE:
D359 7C             	LD	A,H
D35A FE 4D          	CP	'M'
D35C 20 F6          	JR	NZ,CEXE6
D35E                
D35E CD F3 D2       	CALL	DEFCB
D361 CD 17 D3       	CALL	S27BUF
D364 3D             	DEC	A
D365 37             	SCF
D366 C0             	RET	NZ
D367 7C             	LD	A,H
D368 B5             	OR	L
D369 37             	SCF
D36A C8             	RET	Z
D36B CD 07 D3       	CALL	SETDTA1
D36E 11 00 00       COMPAT:	LD	DE,0				; self-modifying code
D371 ED 7B 06 00    	LD	SP,(SYSTEM+1)
D375 67             	LD	H,A				; A=0 in SETDTA1(_SYS1A)
D376 6F             	LD	L,A
D377 E5             	PUSH	HL				; push $0000 (reboot address)
D378 24             	INC	H
D379 E5             	PUSH	HL				; push $0100 (TPA address)
D37A C3 9E D5       	JP	SETFCB				; and JP $0100
D37D                
D37D                C_BAT:
D37D 11 41 54       	LD	DE,'A'+'T'*256
D380 ED 52          	SBC	HL,DE
D382 20 D0          	JR	NZ,CEXE6
D384                
D384 CD F3 D2       	CALL	DEFCB
D387                
D387 21 8D EF       	LD	HL,DTA_CCP
D38A 11 B2 EF       	LD	DE,FCB_BAT
D38D 01 25 00       	LD	BC,37
D390 ED B0          	LDIR
D392                C_BAT1:
D392 CD 01 D3       	CALL	SETDTA100
D395 CD C9 D3       	CALL	FGETC_BAT
D398 21 81 00       	LD	HL,DTA1+1
D39B 20 25          	JR	NZ,END_BATCH
D39D FE 21          	CP	021H		;スペースや改行など制御文字を飛ばす
D39F 38 F1          	JR	C,C_BAT1
D3A1 36 20          	LD	(HL),' '
D3A3 23             	INC	HL
D3A4                C_BAT2:
D3A4 77             	LD	(HL),A
D3A5 23             	INC	HL
D3A6 7D             	LD	A,L
D3A7 3C             	INC	A		;L==0FFH
D3A8 28 09          	JR	Z,RUN_BATCH
D3AA CD C9 D3       	CALL	FGETC_BAT
D3AD 20 04          	JR	NZ,RUN_BATCH
D3AF FE 20          	CP	020H
D3B1 30 F1          	JR	NC,C_BAT2
D3B3                RUN_BATCH:
D3B3 7D             	LD	A,L
D3B4 D6 7F          	SUB	DTA1-1
D3B6 32 80 00       	LD	(DTA1),A
D3B9 FE 04          	CP	4
D3BB 38 05          	JR	C,END_BATCH
D3BD 36 00          	LD	(HL),0
D3BF C3 6D D2       	JP	COMMAND2
D3C2                END_BATCH:
D3C2 AF             	XOR	A		;バッチファイルを閉じる
D3C3 32 B2 EF       	LD	(FCB_BAT),A
D3C6 C3 00 F0       	JP	CPM_BOOT
D3C9                
D3C9                FGETC_BAT:
D3C9 11 B2 EF       	LD	DE,FCB_BAT
D3CC                FGETC:				;1文字ずつ読み込む
D3CC E5             	PUSH	HL		;Z:成功
D3CD 21 01 00       	LD	HL,1
D3D0 CD 23 D3       	CALL	S27
D3D3 E1             	POP	HL
D3D4 3A 00 01       	LD	A,(00100H)
D3D7 C9             	RET
D3D8                
D3D8                C_DEL:
D3D8 CD 9E D5       	CALL	SETFCB
D3DB CD D2 DB       	CALL	_SYS08		;(BDOS)エコーなしコンソール入力
D3DE                
D3DE 0E 13          	LD	C,013H
D3E0 18 0A          	JR	CDEL1		;(BDOS)ファイルの削除
D3E2                
D3E2                C_REN:
D3E2 CD 9E D5       	CALL	SETFCB
D3E5 3E 10          	LD	A,010H		;ディレクトリも対象にする
D3E7 32 69 00       	LD	(FCB1+13),A	;属性
D3EA 0E 17          	LD	C,017H		;(BDOS)ファイル名の変更
D3EC                CDEL1:
D3EC 11 5C 00       	LD	DE,FCB1
D3EF CD 05 00       	CALL	SYSTEM
D3F2 C6 FF          	ADD	A,0FFH
D3F4 C9             	RET
D3F5                
D3F5                C_DIR:
D3F5 CD 7E E0       	CALL	FILEC
D3F8 21 15 F0       	LD	HL,FDRV+1
D3FB CD E9 D6       	CALL	CWILD1
D3FE 3E F1          	LD	A,0F1H
D400 32 21 F0       	LD	(FDRV+13),A
D403 CD DD D2       	CALL	OPEN1
D406                CDIR1:
D406 B7             	OR	A
D407 20 08          	JR	NZ,PDSKF
D409 CD 54 D4       	CALL	P_NAME
D40C CD EF D2       	CALL	OPEN2
D40F 18 F5          	JR	CDIR1
D411                
D411                PDSKF:
D411 3A 14 F0       	LD	A,(FDRV)
D414 5F             	LD	E,A
D415 0E 1B          	LD	C,01BH		;(BDOS)ディスク情報の獲得
D417 CD 05 00       	CALL	SYSTEM
D41A 4F             	LD	C,A		;C←1クラスタ辺りの論理セクタ数
D41B C6 01          	ADD	A,001H
D41D D8             	RET	C		;Aが0FFHだった場合
D41E 3E 06          	LD	A,8-2
D420                PDS1:				;HL=未使用クラスタの総数
D420 3C             	INC	A
D421 CB 19          	RR	C
D423 30 FB          	JR	NC,PDS1
D425                PDS2:				;B←論理セクタのサイズの上位8ビット
D425 3C             	INC	A
D426 CB 18          	RR	B
D428 30 FB          	JR	NC,PDS2
D42A 47             	LD	B,A
D42B                
D42B 11 00 00       	LD	DE,0
D42E                PDS3:
D42E 29             	ADD	HL,HL
D42F EB             	EX	DE,HL
D430 ED 6A          	ADC	HL,HL
D432 EB             	EX	DE,HL
D433 10 F9          	DJNZ	PDS3
D435                PDSKF1:
D435 CD CD D4       	CALL	PRDEC_DEHL
D438 11 D7 EF       	LD	DE,FREE
D43B CD 61 D8       	CALL	_SYS09		;(BDOS)文字列出力
D43E CD BC D4       	CALL	PUTDRV
D441 3E 5C          	LD	A,05CH		;\
D443 CD BC DB       	CALL	MSG_A
D446 2A 22 F0       	LD	HL,(FDRV+14)	;ディレクトリのクラスタ番号
D449 AF             	XOR	A
D44A 11 FE FF       	LD	DE,0-2
D44D 19             	ADD	HL,DE
D44E 23             	INC	HL
D44F DC C9 D4       	CALL	C,PRDEC_HL
D452 18 41          	JR	LTNL
D454                
D454                P_NAME:
D454 3A 8E EF       	LD	A,(DTA_CCP+1)
D457 FE 2E          	CP	'.'
D459 C8             	RET	Z
D45A 11 FF D6       	LD	DE,DIRHD
D45D CD 61 D8       	CALL	_SYS09		;(BDOS)文字列出力
D460 3A 99 EF       	LD	A,(DTA_CCP+1+00BH)
D463 F5             	PUSH	AF
D464 0F             	RRCA
D465 9F             	SBC	A,A
D466 E6 0A          	AND	'*'-020H
D468 C6 20          	ADD	A,020H
D46A CD BC DB       	CALL	MSG_A
D46D CD BC D4       	CALL	PUTDRV
D470 21 8E EF       	LD	HL,DTA_CCP+1
D473 CD 0D D5       	CALL	FPRNT
D476                
D476 F1             	POP	AF
D477 CB 67          	BIT	4,A
D479 28 08          	JR	Z,DIR3
D47B 11 F4 D6       	LD	DE,DIRMES
D47E CD 61 D8       	CALL	_SYS09		;(BDOS)文字列出力
D481 18 0A          	JR	DIR6
D483                DIR3:
D483 ED 5B AC EF    	LD	DE,(DTA_CCP+1+01EH)
D487 2A AA EF       	LD	HL,(DTA_CCP+1+01CH)
D48A CD CD D4       	CALL	PRDEC_DEHL
D48D                DIR6:
D48D 3A B1 F0       	LD	A,(_WIDTH)
D490 FE 29          	CP	40+1
D492 D4 2F D5       	CALL	NC,PRTTMS
D495                
D495                LTNL:
D495 1E 03          	LD	E,3
D497 C3 CD F0       	JP	_PRINT
D49A                
D49A                C_PATH:
D49A CD 60 E1       	CALL	SPCUT
D49D 21 4C EF       	LD	HL,PATHD
D4A0 FE 21          	CP	021H
D4A2 30 0C          	JR	NC,CPATH0
D4A4                CPATHP:
D4A4 7E             	LD	A,(HL)
D4A5 23             	INC	HL
D4A6 FE 20          	CP	020H
D4A8 3F             	CCF
D4A9 30 EA          	JR	NC,LTNL
D4AB CD BC DB       	CALL	MSG_A
D4AE 18 F4          	JR	CPATHP
D4B0                CPATH0:
D4B0 FE 3B          	CP	';'
D4B2 20 01          	JR	NZ,CPATH1
D4B4 13             	INC	DE
D4B5                CPATH1:
D4B5 EB             	EX	DE,HL
D4B6 01 40 00       	LD	BC,PATHX
D4B9 ED B0          	LDIR
D4BB C9             	RET
D4BC                
D4BC                PUTDRV:
D4BC 3A 14 F0       	LD	A,(FDRV)
D4BF C6 40          	ADD	A,'A'-1
D4C1 CD BC DB       	CALL	MSG_A
D4C4 3E 3A          	LD	A,':'
D4C6                MSG_AR:
D4C6 C3 BC DB       	JP	MSG_A
D4C9                
D4C9                PRDEC_HL:
D4C9 AF             	XOR	A
D4CA                PRDEC_AHL:
D4CA 5F             	LD	E,A
D4CB 16 00          	LD	D,0
D4CD                PRDEC_DEHL:
D4CD D5             	PUSH	DE
D4CE 11 0F F0       	LD	DE,DECBF
D4D1 06 05          	LD	B,5
D4D3 CD D3 D5       	CALL	ZERO_MEMORY_DE	;A=0
D4D6 D1             	POP	DE
D4D7                
D4D7 0E 20          	LD	C,32
D4D9                DEC1:
D4D9 29             	ADD	HL,HL
D4DA EB             	EX	DE,HL
D4DB ED 6A          	ADC	HL,HL
D4DD EB             	EX	DE,HL
D4DE E5             	PUSH	HL
D4DF 21 13 F0       	LD	HL,DECBF+4
D4E2 06 05          	LD	B,5
D4E4                DEC2:
D4E4 7E             	LD	A,(HL)
D4E5 8F             	ADC	A,A
D4E6 27             	DAA
D4E7 77             	LD	(HL),A
D4E8 2B             	DEC	HL
D4E9 10 F9          	DJNZ	DEC2
D4EB E1             	POP	HL
D4EC 0D             	DEC	C
D4ED 20 EA          	JR	NZ,DEC1
D4EF                
D4EF 21 0F F0       	LD	HL,DECBF
D4F2 3E 20          	LD	A,020H
D4F4 06 04          	LD	B,4
D4F6                DEC3:
D4F6 CD 03 D5       	CALL	DEC4
D4F9 CD 03 D5       	CALL	DEC4
D4FC 23             	INC	HL
D4FD 10 F7          	DJNZ	DEC3
D4FF                DECX:
D4FF CD 03 D5       	CALL	DEC4
D502 AF             	XOR	A
D503                DEC4:
D503 ED 6F          	RLD
D505 FE 20          	CP	020H
D507 28 02          	JR	Z,DEC5
D509 F6 30          	OR	030H
D50B                DEC5:
D50B 18 B9          	JR	MSG_AR
D50D                
D50D                FPRNT:
D50D 06 08          	LD	B,8
D50F CD 20 D5       	CALL	P_N1
D512 7E             	LD	A,(HL)
D513 C6 80          	ADD	A,0A0H-020H
D515 FE A0          	CP	0A0H
D517 28 02          	JR	Z,FPR1
D519 3E 2E          	LD	A,'.'
D51B                FPR1:
D51B CD BC DB       	CALL	MSG_A
D51E 06 03          	LD	B,3
D520                
D520                P_N1:
D520 C5             	PUSH	BC
D521 E5             	PUSH	HL
D522 7E             	LD	A,(HL)
D523 CD A1 E3       	CALL	CAP3
D526 CD BC DB       	CALL	MSG_A
D529 E1             	POP	HL
D52A C1             	POP	BC
D52B 23             	INC	HL
D52C 10 F2          	DJNZ	P_N1
D52E C9             	RET
D52F                
D52F                PRTTMS:
D52F 3E 20          	LD	A,020H
D531 CD BC DB       	CALL	MSG_A
D534                
D534 2A A6 EF       	LD	HL,(DTA_CCP+1+24)
D537 7D             	LD	A,L
D538 B7             	OR	A
D539 C8             	RET	Z
D53A CB 3C          	SRL	H
D53C 17             	RLA
D53D 17             	RLA
D53E 17             	RLA
D53F 17             	RLA
D540 E6 0F          	AND	00FH
D542 57             	LD	D,A
D543 7C             	LD	A,H
D544 C6 50          	ADD	A,80
D546 CD 89 D5       	CALL	PRDEC_A
D549 3E 2D          	LD	A,'-'
D54B CD BC DB       	CALL	MSG_A
D54E 7A             	LD	A,D
D54F CD 89 D5       	CALL	PRDEC_A
D552 3E 2D          	LD	A,'-'
D554 CD BC DB       	CALL	MSG_A
D557 7D             	LD	A,L
D558 E6 1F          	AND	01FH
D55A CD 89 D5       	CALL	PRDEC_A
D55D                
D55D 2A A4 EF       	LD	HL,(DTA_CCP+1+22)
D560                
D560 3E 20          	LD	A,020H
D562 CD BC DB       	CALL	MSG_A
D565 7C             	LD	A,H
D566 65             	LD	H,L
D567 06 03          	LD	B,3
D569                PRTTMS1:
D569 1F             	RRA
D56A CB 1D          	RR	L
D56C 10 FB          	DJNZ	PRTTMS1
D56E E6 1F          	AND	01FH
D570 CD 89 D5       	CALL	PRDEC_A
D573 3E 3A          	LD	A,':'
D575 CD BC DB       	CALL	MSG_A
D578 7D             	LD	A,L
D579 0F             	RRCA
D57A 0F             	RRCA
D57B E6 3F          	AND	03FH
D57D CD 89 D5       	CALL	PRDEC_A
D580 3E 3A          	LD	A,':'
D582 CD BC DB       	CALL	MSG_A
D585 7C             	LD	A,H
D586 E6 1F          	AND	01FH
D588 87             	ADD	A,A
D589                
D589                ;	PRINT10
D589                
D589                PRDEC_A:
D589 E5             	PUSH	HL
D58A 06 08          	LD	B,8
D58C 4F             	LD	C,A
D58D AF             	XOR	A
D58E                PRTA1:
D58E CB 01          	RLC	C
D590 8F             	ADC	A,A
D591 27             	DAA
D592 10 FA          	DJNZ	PRTA1
D594 21 0F F0       	LD	HL,DECBF
D597 77             	LD	(HL),A
D598 AF             	XOR	A
D599 CD FF D4       	CALL	DECX
D59C E1             	POP	HL
D59D C9             	RET
D59E                
D59E                SETFCB:
D59E CD 60 E1       	CALL	SPCUT
D5A1 1A             	LD	A,(DE)
D5A2 FE 20          	CP	020H
D5A4 38 01          	JR	C,SETFCBA
D5A6 1B             	DEC	DE
D5A7                SETFCBA:
D5A7 06 24          	LD	B,36
D5A9 21 5C 00       	LD	HL,FCB1
D5AC E5             	PUSH	HL
D5AD AF             	XOR	A
D5AE CD 35 E1       	CALL	FILL_MEMORY
D5B1 E1             	POP	HL
D5B2 D5             	PUSH	DE
D5B3 CD 9F DA       	CALL	_SYS29		;(BDOS)ファイル名の解析
D5B6 21 6C 00       	LD	HL,FCB2
D5B9 CD 9F DA       	CALL	_SYS29		;(BDOS)ファイル名の解析
D5BC E1             	POP	HL
D5BD 01 00 50       	LD	BC,05000H
D5C0 11 81 00       	LD	DE,00081H
D5C3                SETFCB1:
D5C3 7E             	LD	A,(HL)
D5C4 23             	INC	HL
D5C5 FE 20          	CP	020H
D5C7 38 05          	JR	C,SETFCB2
D5C9 12             	LD	(DE),A
D5CA 13             	INC	DE
D5CB 0C             	INC	C
D5CC 10 F5          	DJNZ	SETFCB1
D5CE                SETFCB2:
D5CE 79             	LD	A,C
D5CF 32 80 00       	LD	(DTA1),A
D5D2 04             	INC	B
D5D3                ZERO_MEMORY_DE:
D5D3 AF             	XOR	A
D5D4                FILL_MEMORY_DE:
D5D4 12             	LD	(DE),A
D5D5 13             	INC	DE
D5D6 10 FC          	DJNZ	FILL_MEMORY_DE
D5D8 C9             	RET
D5D9                
D5D9                C_COPY:
D5D9 CD 9E D5       	CALL	SETFCB
D5DC                
D5DC 11 61 F0       	LD	DE,ZERO
D5DF CD 81 E0       	CALL	FILEC2
D5E2 21 6C 00       	LD	HL,FCB2
D5E5 CD A6 DA       	CALL	S29X1
D5E8                
D5E8 3E 10          	LD	A,010H
D5EA 32 69 00       	LD	(FCB1+13),A
D5ED 21 6D 00       	LD	HL,FCB2+1
D5F0 CD E9 D6       	CALL	CWILD1
D5F3                COPY0:
D5F3 CD E6 D6       	CALL	CWILD
D5F6 21 5C 00       	LD	HL,FCB1
D5F9 CD E0 D2       	CALL	OPEN
D5FC 37             	SCF
D5FD                COPY1:
D5FD C0             	RET	NZ
D5FE CD F3 D2       	CALL	DEFCB
D601                
D601 3A 9A EF       	LD	A,(DTA_CCP+13)
D604 CB 67          	BIT	4,A
D606 28 21          	JR	Z,COPY1A
D608                
D608 21 5D 00       	LD	HL,FCB1+1
D60B CD C4 E4       	CALL	CHKWILD
D60E 38 14          	JR	C,COPY9
D610                
D610 3E 20          	LD	A,020H
D612 32 5D 00       	LD	(FCB1+1),A
D615 2A A7 EF       	LD	HL,(DTA_CCP+26)
D618 23             	INC	HL
D619 22 6A 00       	LD	(FCB1+14),HL
D61C 18 D5          	JR	COPY0
D61E                
D61E                COPY8:
D61E CD 61 D8       	CALL	_SYS09		;(BDOS)文字列出力
D621 CD 95 D4       	CALL	LTNL
D624                COPY9:
D624 CD EF D2       	CALL	OPEN2
D627 18 D4          	JR	COPY1
D629                
D629                COPY1A:
D629 21 6C 00       	LD	HL,FCB2
D62C 11 14 F0       	LD	DE,FDRV
D62F 01 8F EF       	LD	BC,DTA_CCP+2
D632 ED A0          	LDI
D634 3E 0B          	LD	A,11
D636                COPY2:
D636 F5             	PUSH	AF
D637 7E             	LD	A,(HL)
D638 FE 3F          	CP	'?'
D63A 20 01          	JR	NZ,COPY3
D63C 0A             	LD	A,(BC)
D63D                COPY3:
D63D 12             	LD	(DE),A
D63E 03             	INC	BC
D63F 13             	INC	DE
D640 23             	INC	HL
D641 F1             	POP	AF
D642 3D             	DEC	A
D643 20 F1          	JR	NZ,COPY2
D645 01 05 00       	LD	BC,16-11
D648 ED B0          	LDIR
D64A                PUTNAME:
D64A 21 5D 00       	LD	HL,FCB1+1
D64D CD C4 E4       	CALL	CHKWILD
D650 30 0B          	JR	NC,PUTN1
D652 21 15 F0       	LD	HL,FDRV+1
D655 CD 0D D5       	CALL	FPRNT
D658 3E 20          	LD	A,020H
D65A CD BC DB       	CALL	MSG_A
D65D                PUTN1:
D65D 11 14 F0       	LD	DE,FDRV
D660 0E 16          	LD	C,016H		;(BDOS)ファイルの作成
D662 CD 0E D3       	CALL	SYSTEM0
D665 20 48          	JR	NZ,COPYE2
D667 67             	LD	H,A		;A=0
D668 6F             	LD	L,A
D669 22 35 F0       	LD	(FDRV+33),HL	;(FCB)ランダムレコード
D66C 22 37 F0       	LD	(FDRV+35),HL
D66F                COPY6:
D66F CD 17 D3       	CALL	S27BUF
D672 47             	LD	B,A
D673 3C             	INC	A
D674 28 31          	JR	Z,COPYE
D676 7C             	LD	A,H
D677 B5             	OR	L
D678 28 0C          	JR	Z,COPY7
D67A 11 14 F0       	LD	DE,FDRV
D67D 0E 26          	LD	C,026H		;(BDOS)ランダムブロック書き込み
D67F CD 0E D3       	CALL	SYSTEM0
D682 20 23          	JR	NZ,COPYE
D684 10 E9          	DJNZ	COPY6
D686                COPY7:
D686 3A 9A EF       	LD	A,(DTA_CCP+13)	;(FCB)属性
D689 32 21 F0       	LD	(FDRV+13),A
D68C 21 A1 EF       	LD	HL,DTA_CCP+20	;(FCB)タイムスタンプ
D68F 11 28 F0       	LD	DE,FDRV+20
D692 01 04 00       	LD	BC,4
D695 ED B0          	LDIR
D697                
D697 11 14 F0       	LD	DE,FDRV
D69A 0E 10          	LD	C,010H		;(BDOS)ファイルのクローズ
D69C CD 0E D3       	CALL	SYSTEM0
D69F 20 06          	JR	NZ,COPYE
D6A1                
D6A1 11 71 F0       	LD	DE,OK
D6A4 C3 1E D6       	JP	COPY8
D6A7                
D6A7                COPYE:
D6A7 11 14 F0       	LD	DE,FDRV
D6AA 0E 13          	LD	C,013H		;(BDOS)ファイルの削除
D6AC CD 05 00       	CALL	SYSTEM
D6AF                COPYE2:
D6AF 37             	SCF
D6B0 C9             	RET
D6B1                
D6B1                C_TYPE:
D6B1 CD 9E D5       	CALL	SETFCB
D6B4 21 5C 00       	LD	HL,FCB1
D6B7 CD E0 D2       	CALL	OPEN
D6BA 37             	SCF
D6BB                TYPE1:
D6BB C0             	RET	NZ
D6BC CD F3 D2       	CALL	DEFCB
D6BF 3E 06          	LD	A,6
D6C1 CD BC DB       	CALL	MSG_A
D6C4                TYPE2:
D6C4 CD 17 D3       	CALL	S27BUF
D6C7 C6 FE          	ADD	A,0FEH
D6C9 D8             	RET	C
D6CA 7C             	LD	A,H
D6CB B5             	OR	L
D6CC 28 13          	JR	Z,TYPEE
D6CE 01 00 01       	LD	BC,00100H
D6D1                TYPE3:
D6D1 0A             	LD	A,(BC)
D6D2 03             	INC	BC
D6D3 FE 1A          	CP	01AH
D6D5 28 0A          	JR	Z,TYPEE
D6D7 CD BC DB       	CALL	MSG_A
D6DA 2B             	DEC	HL
D6DB 7C             	LD	A,H
D6DC B5             	OR	L
D6DD 20 F2          	JR	NZ,TYPE3
D6DF 18 E3          	JR	TYPE2
D6E1                TYPEE:
D6E1 CD EF D2       	CALL	OPEN2
D6E4 18 D5          	JR	TYPE1
D6E6                
D6E6                CWILD:
D6E6 21 5D 00       	LD	HL,FCB1+1
D6E9                CWILD1:
D6E9 7E             	LD	A,(HL)
D6EA FE 20          	CP	020H
D6EC C0             	RET	NZ
D6ED                CWILD2:
D6ED 3E 3F          	LD	A,'?'
D6EF 06 0B          	LD	B,11
D6F1 C3 35 E1       	JP	FILL_MEMORY
D6F4                
D6F4 20 20 20 20    DIRMES:	DB	"     <DIR>$"
D6F8 20 3C 44 49
D6FC 52 3E 24
D6FF 20 20 3A 24    DIRHD:	DB	"  :$"
D703                
D703                COMTB:
D703 44 20 20 20    	DB	"D   "	;1
D707 F5 D3          	DW	C_DIR
D709 44 49 52 20    	DB	"DIR "	;2
D70D F5 D3          	DW	C_DIR
D70F 43 4F 50 59    	DB	"COPY"	;3
D713 D9 D5          	DW	C_COPY
D715 43 44 20 20    	DB	"CD  "	;4
D719 13 D3          	DW	C_CD
D71B 44 45 4C 20    	DB	"DEL "	;5
D71F D8 D3          	DW	C_DEL
D721 50 41 54 48    	DB	"PATH"	;6
D725 9A D4          	DW	C_PATH
D727 52 45 4E 20    	DB	"REN "	;7
D72B E2 D3          	DW	C_REN
D72D 54 59 50 45    	DB	"TYPE"	;8
D731 B1 D6          	DW	C_TYPE
D733 52 45 4D 20    	DB	"REM "	;9
D737 5E D8          	DW	C_REM
D739                	INCLUDE	"X1DISK2.ASM"
D739                
D739                ;	LSX-Dodgers DISK2
D739                ;	X1/turbo/Z
D739                
D739                ;	GRAPHIC RAM DISK DRIVER
D739                
D739                
D739                GDRD:
D739 C5             	PUSH	BC
D73A CD 62 D7       	CALL	GADR
D73D F1             	POP	AF
D73E                GDRD1:
D73E ED A2          	INI
D740 04             	INC	B
D741 0C             	INC	C
D742 20 FA          	JR	NZ,GDRD1
D744 04             	INC	B
D745 13             	INC	DE
D746 3D             	DEC	A
D747 20 F5          	JR	NZ,GDRD1
D749                GBANK0:
D749 3A BF F0       	LD	A,(WK1FD0)
D74C E6 EF          	AND	0EFH		;BANK0
D74E 18 1D          	JR	S1FD0
D750                
D750                GDWT:
D750 C5             	PUSH	BC
D751 CD 62 D7       	CALL	GADR
D754 F1             	POP	AF
D755                GDWT1:
D755 04             	INC	B
D756 ED A3          	OUTI
D758 0C             	INC	C
D759 20 FA          	JR	NZ,GDWT1
D75B 04             	INC	B
D75C 13             	INC	DE
D75D 3D             	DEC	A
D75E 20 F5          	JR	NZ,GDWT1
D760 18 E7          	JR	GBANK0
D762                
D762                GADR:
D762 0E 00          	LD	C,0
D764 7B             	LD	A,E
D765 C6 40          	ADD	A,040H
D767 47             	LD	B,A
D768 3A BF F0       	LD	A,(WK1FD0)
D76B F6 10          	OR	010H		;BANK1
D76D                S1FD0:
D76D C5             	PUSH	BC
D76E 32 BF F0       	LD	(WK1FD0),A
D771 01 D0 1F       	LD	BC,01FD0H
D774 ED 79          	OUT	(C),A
D776 C1             	POP	BC
D777 C9             	RET
D778                
D778                
D778                ;	BANK RAM DISK DRIVER
D778                
D778                BDWT:
D778 3E             	DB	03EH	;LD A,??
D779 37             	SCF
D77A 18 02          	JR	BRW
D77C                
D77C                BDRD:
D77C 3E             	DB	03EH	;LD A,??
D77D A7             	AND	A
D77E                BRW:
D77E F3             	DI
D77F 32 AA D7       	LD	(BRWPAT),A
D782 ED 73 CA D7    	LD	(BANKSP),SP
D786 3A CB D7       	LD	A,(BANKSP_H)
D789 87             	ADD	A,A
D78A 38 03          	JR	C,BRW0
D78C 31 CA FF       	LD	SP,EXTSP
D78F                BRW0:
D78F D9             	EXX		;裏レジスタ
D790 C5             	 PUSH	 BC
D791 D5             	 PUSH	 DE
D792 01 00 0B       	 LD	 BC,00B00H	 ;バンクメモリ
D795 11 10 10       	 LD	 DE,01010H
D798 D9             	 EXX		;表レジスタ
D799                BRW1:
D799 C5             	PUSH	BC
D79A D5             	PUSH	DE
D79B EB             	EX	DE,HL
D79C 29             	ADD	HL,HL
D79D 29             	ADD	HL,HL
D79E 7C             	LD	A,H
D79F DD 86 0C       	ADD	A,(IX+00CH)	;DPB_0C_MAXCYL
D7A2 E6 0F          	AND	00FH	;バンク
D7A4 65             	LD	H,L
D7A5 CB 3C          	SRL	H	;/2
D7A7 2E 00          	LD	L,0
D7A9 D9             	EXX		;裏レジスタ
D7AA A7             BRWPAT:	 AND	 A	;自己書き換え(AND A:読み出し/SCF:書き込み)
D7AB 38 08          	 JR	 C,BRWT
D7AD 57             	 LD	 D,A	 ;D=バンク
D7AE D9             	 EXX		;表レジスタ
D7AF EB             	EX	DE,HL
D7B0 CD CE D7       	CALL	BTFR
D7B3 18 06          	JR	BRW2
D7B5                BRWT:
D7B5 5F             	 LD	E,A	 ;E=バンク
D7B6 D9             	 EXX		;表レジスタ
D7B7 CD CE D7       	CALL	BTFR
D7BA EB             	EX	DE,HL
D7BB                BRW2:
D7BB D1             	POP	DE
D7BC C1             	POP	BC
D7BD 13             	INC	DE
D7BE 10 D9          	DJNZ	BRW1
D7C0                
D7C0 D9             	EXX		;裏レジスタ
D7C1 3E 10          	 LD	 A,10H
D7C3 ED 79          	 OUT	 (C),A		;メインメモリに切り替える
D7C5 D1             	 POP	 DE
D7C6 C1             	 POP	 BC
D7C7 D9             	 EXX		;表レジスタ
D7C8 AF             	XOR	A
D7C9 31 00 00       	LD	SP,0
D7CC 00 00 D7 CB    BANKSP_H	EQU	$-1
D7CC 00 00 D7 CA    BANKSP		EQU	$-2
D7CC FB             	EI
D7CD C9             	RET
D7CE                
D7CE                ;メインメモリ←→バンクメモリ 512バイトの転送を行う
D7CE                ; DE:転送元アドレス
D7CE                ; HL:転送先アドレス
D7CE                ; 裏BC:バンク切り替えポート(0B00H)
D7CE                ; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
D7CE                ; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
D7CE                
D7CE                BTFR:
D7CE 06 00          	LD	B,0	;256回ループ(256*2)
D7D0                BTFR1:
D7D0 D9             	EXX		;裏レジスタ
D7D1 ED 51          	 OUT	 (C),D	 ;BANK(MAIN)
D7D3 D9             	 EXX		;表レジスタ
D7D4 1A             	LD	A,(DE)
D7D5 4F             	LD	C,A
D7D6 13             	INC	DE
D7D7 1A             	LD	A,(DE)
D7D8 13             	INC	DE
D7D9 D9             	EXX		;裏レジスタ
D7DA ED 59          	 OUT	 (C),E	 ;MAIN(BANK)
D7DC D9             	 EXX		;表レジスタ
D7DD 71             	LD	(HL),C
D7DE 23             	INC	HL
D7DF 77             	LD	(HL),A
D7E0 23             	INC	HL
D7E1 10 ED          	DJNZ	BTFR1
D7E3 C9             	RET
D7E4                
D7E4                ;	EMM DRIVER(DMA)
D7E4                
D7E4                
D7E4                EDWT:
D7E4 0E 0F          	LD	C,15
D7E6 18 02          	JR	EDWT1
D7E8                EDRD:
D7E8 0E 0E          	LD	C,14
D7EA                EDWT1:
D7EA C5             	PUSH	BC
D7EB D5             	PUSH	DE
D7EC 22 2C D8       	LD	(DMAB),HL
D7EF 78             	LD	A,B
D7F0 87             	ADD	A,A
D7F1 3D             	DEC	A
D7F2 32 25 D8       	LD	(DMALEN+1),A
D7F5 3C             	INC	A
D7F6 84             	ADD	A,H	;HL(アドレス)を先に進めておく
D7F7 67             	LD	H,A
D7F8 EB             	EX	DE,HL
D7F9 29             	ADD	HL,HL
D7FA DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
D7FD 79             	LD	A,C
D7FE DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
D801 09             	ADD	HL,BC
D802 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
D805 06 0D          	LD	B,00DH
D807 ED 49          	OUT	(C),C
D809 0C             	INC	C
D80A ED 69          	OUT	(C),L
D80C 0C             	INC	C
D80D ED 61          	OUT	(C),H
D80F                
D80F 21 20 D8       	LD	HL,EDMAD
D812 CD 91 DF       	CALL	SETDMA
D815 CD B9 DF       	CALL	GO_DMA
D818 EB             	EX	DE,HL
D819 D1             	POP	DE
D81A C1             	POP	BC
D81B                DMA_ADD_SEC:
D81B 13             	INC	DE
D81C 10 FD          	DJNZ	DMA_ADD_SEC
D81E AF             	XOR	A
D81F C9             	RET
D820                
D820                EDMAD:
D820 C3             	DB	0C3H	;WR6 リセット
D821 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
D822 03 0D          	DW	00D03H	;ポートA開始アドレス EMMリード/ライト
D824 FF 01          DMALEN:	DW	001FFH	;ブロック長(転送サイズ-1)
D826 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
D827 50             	DB	050H	;WR2 ポートBアドレスインクリメント メモリ
D828 02             	DB	002H	;ポートBタイミング
D829 80             	DB	080H	;WR3
D82A 9A             	DB	09AH	;WR5 WAIT RDY:HIGH
D82B AD             	DB	0ADH	;WR4 連続 ポートB開始アドレス
D82C 00 00          DMAB:	DW	0
D82E 01             	DB	001H	;WR0 ポートA←ポートB 転送
D82F                EMME:
D82F                
D82F 00 00 06 B5    AT_RE	EQU	EDWT-AT_EDWT
D82F                
D82F                	INCLUDE	"LDOS.ASM"
D82F                
D82F                ;	LSX-Dodgers OS
D82F                
D82F                BDOS0:
D82F E5             	PUSH	HL
D830 79             	LD	A,C
D831 FE 3C          	CP	03CH
D833 38 02          	JR	C,DOS1
D835 3E 3C          	LD	A,03CH
D837                DOS1:
D837 87             	ADD	A,A
D838 6F             	LD	L,A
D839 26 F1          	LD	H,STABLE/256
D83B 7E             	LD	A,(HL)
D83C 2C             	INC	L
D83D 66             	LD	H,(HL)
D83E 6F             	LD	L,A
D83F E3             	EX	(SP),HL
D840 79             	LD	A,C
D841                ;確認用
D841                ;	LD	(0050H),A
D841 C9             	RET
D842                _DOS2:
D842 FE 5A          	CP	05AH		;(BDOS)カレントディレクトリの変更(_CHDIR)
D844 CA E1 DA       	JP	Z,_SYS5A
D847 FE 5C          	CP	05CH		;(BDOS)ファイル名の解析(_PFILE)
D849 CA 9F DA       	JP	Z,_SYS29
D84C FE 5F          	CP	05FH		;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
D84E CA DD ED       	JP	Z,_SYS5F
D851 FE 6F          	CP	06FH		;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
D853 20 0A          	JR	NZ,_ERROR
D855 01 1D 01       	LD	BC,011DH
D858 11 56 01       	LD	DE,VER
D85B 21 00 00       	LD	HL,MACD
D85E                C_REM:
D85E AF             	XOR	A
D85F                _ERROR:
D85F A7             	AND	A
D860 C9             	RET
D861                
D861                _SYS09:		;文字列出力
D861 D5             	PUSH	DE
D862                _SX09:
D862 1A             	LD	A,(DE)
D863 13             	INC	DE
D864 FE 24          	CP	'$'
D866 28 31          	JR	Z,SX0E2
D868 CD BC DB       	CALL	MSG_A
D86B 18 F5          	JR	_SX09
D86D                
D86D                MSX1:
D86D CD BC DB       	CALL	MSG_A
D870                MSX:
D870 7E             	LD	A,(HL)
D871 23             	INC	HL
D872 B7             	OR	A
D873 20 F8          	JR	NZ,MSX1
D875 C9             	RET
D876                
D876                _SYS0C:		;(BDOS)バージョン番号の獲得
D876 21 22 00       	LD	HL,00022H
D879 7D             	LD	A,L
D87A C9             	RET
D87B                
D87B                _SYS0D:		;(BDOS)ディスクリセット
D87B CD DF F0       	CALL	_FFLUSH
D87E E5             	PUSH	HL
D87F 21 80 00       	LD	HL,00080H
D882 22 8A F0       	LD	(_DTA),HL
D885 E1             	POP	HL
D886 D5             	PUSH	DE
D887 1E 00          	LD	E,0
D889 3E             	DB	03EH
D88A                
D88A                _SYS0E:		;(BDOS)カレントドライブの設定
D88A D5             	PUSH	DE
D88B 7B             	LD	A,E
D88C DD E5          	PUSH	IX
D88E CD DC F0       	CALL	_GETDPB
D891 DD E1          	POP	IX
D893 38 04          	JR	C,SX0E2
D895 7B             	LD	A,E
D896 32 87 F0       	LD	(_DVSW),A
D899                SX0E2:
D899 D1             	POP	DE
D89A C9             	RET
D89B                
D89B                _SYS0F:		;(BDOS)ファイルのオープン
D89B CD 72 E1       	CALL	SETDRV
D89E FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D8A1 C6 02          	ADD	A,002H		;Write
D8A3 28 48          	JR	Z,FEND0F
D8A5 CD C0 E4       	CALL	CHKWILDX
D8A8                
D8A8 D4 92 E1       	CALL	NC,SOPENX
D8AB                _S16XX:
D8AB 38 40          	JR	C,FEND0F
D8AD                				;Directory location
D8AD 3A 9F F0       	LD	A,(_FILEN)
D8B0 FD 77 19       	LD	(IY+25),A	;(FCB)ディレクトリロケーション
D8B3                ;				_DIRF
D8B3 3A A0 F0       	LD	A,(_DIRF)
D8B6 FD 77 1D       	LD	(IY+29),A	;(FCB)ディレクトリモード
D8B9                ;				_FBPS
D8B9 FD 73 1E       	LD	(IY+30),E	;(FCB)ディレクトリポジション
D8BC FD 72 1F       	LD	(IY+31),D
D8BF                ;				Open(Read)
D8BF FD 36 1C FF    	LD	(IY+28),0FFH	;(FCB)オープンモード
D8C3                ;				FILENAME
D8C3 FD E5          	PUSH	IY
D8C5 D1             	POP	DE
D8C6 13             	INC	DE
D8C7 01 0B 00       	LD	BC,11
D8CA ED B0          	LDIR
D8CC                ;				Attribute
D8CC 7E             	LD	A,(HL)
D8CD FD 77 0D       	LD	(IY+13),A	;(FCB)属性(アトリビュート)
D8D0 11 0B 00       	LD	DE,11		;Reserved
D8D3 19             	ADD	HL,DE
D8D4                					;(FCB)ファイルを最後に変更した時刻
D8D4 11 EA F1       	LD	DE,SDDATA		;(FCB)ファイルを最後に変更した日付
D8D7 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
D8D9                S16LOOP:				;(FCB)ファイルのサイズ(バイト単位)
D8D9 1A             	LD	A,(DE)
D8DA 13             	INC	DE
D8DB 32 E2 D8       	LD	(S16PAT+2),A
D8DE 7E             	LD	A,(HL)
D8DF 23             	INC	HL
D8E0 FD 77 00       S16PAT:	LD	(IY+0),A
D8E3 10 F4          	DJNZ	S16LOOP
D8E5                
D8E5 AF             	XOR	A
D8E6 FD 77 0C       	LD	(IY+12),A	;(FCB)カレントブロック
D8E9 FD 22 91 D9    	LD	(OFCB+1),IY
D8ED                FEND0F:
D8ED 18 45          	JR	FEND10
D8EF                
D8EF                _SYS10:		;(BDOS)ファイルのクローズ
D8EF CD 72 E1       	CALL	SETDRV
D8F2 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D8F5 D6 FE          	SUB	0FEH
D8F7 37             	SCF
D8F8 3F             	CCF
D8F9 20 39          	JR	NZ,FEND10
D8FB                _S10A:				;Write
D8FB FD 77 0E       	LD	(IY+14),A	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D8FE FD 77 0F       	LD	(IY+15),A
D901                
D901 FD 34 1C       	INC	(IY+28)		;0FEH->0FFH ;オープンモード
D904 CD BC E5       	CALL	SETTMS
D907                
D907 FD 7E 1D       	LD	A,(IY+29)	;(FCB)ディレクトリモード
D90A 32 A0 F0       	LD	(_DIRF),A
D90D E6 7F          	AND	07FH
D90F 32 E7 EA       	LD	(_SECPS+1),A
D912 FD 5E 1E       	LD	E,(IY+30)	;(FCB)ディレクトリポジション
D915 FD 56 1F       	LD	D,(IY+31)
D918 CD C6 E2       	CALL	READ_DIR
D91B 38 17          	JR	C,FEND10
D91D                
D91D 3A F0 E1       SDECM1:	LD	A,(SDECPAT+1)	;1セクタ辺りのディレクトリエントリ数
D920 3D              	DEC	A		;1024=01FH / 512=00FH / 256=7
D921 FD A6 19       	AND	(IY+25)		;(FCB)ディレクトリロケーション
D924 6F             	LD	L,A
D925 26 00          	LD	H,0
D927 29             	ADD	HL,HL		;*2
D928 29             	ADD	HL,HL		;*4
D929 29             	ADD	HL,HL		;*8
D92A 29             	ADD	HL,HL		;*16
D92B 29             	ADD	HL,HL		;*32
D92C ED 4B 7E F1    	LD	BC,(_DTBUF)
D930 09             	ADD	HL,BC
D931                
D931 CD D0 E4       	CALL	SDIRENT
D934                FEND10:
D934 18 42          	JR	FEND
D936                
D936                _SYS11:		;(BDOS)最初のファイルの検索
D936 CD 72 E1       	CALL	SETDRV
D939 CD BF E1       	CALL	SOPEN
D93C                _S12X1:
D93C 38 3A          	JR	C,FEND
D93E CD 5F E2       	CALL	SOPENE2
D941 ED 5B 8A F0    	LD	DE,(_DTA)
D945 3A 88 F0       	LD	A,(_DRV)
D948 3C             	INC	A
D949 12             	LD	(DE),A
D94A D5             	PUSH	DE
D94B 13             	INC	DE
D94C 01 20 00       	LD	BC,32
D94F ED B0          	LDIR
D951 FD 6E 0E       	LD	L,(IY+14)	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D954 FD 66 0F       	LD	H,(IY+15)
D957 22 F4 F1       	LD	(SCDIR),HL
D95A 2A 9A F0       	LD	HL,(_FBPS)
D95D 22 F6 F1       	LD	(SFBPS),HL
D960 2A 9F F0       	LD	HL,(_FILEN)
D963 7C             	LD	A,H
D964 B7             	OR	A
D965 28 06          	JR	Z,_S12DIR
D967 3A E7 EA       	LD	A,(_SECPS+1)
D96A F6 80          	OR	080H
D96C 67             	LD	H,A
D96D                _S12DIR:
D96D 22 F8 F1       	LD	(SFNDF),HL	;Directory position and Flags
D970 E1             	POP	HL
D971 11 39 F0       	LD	DE,SFILE
D974 0E 21          	LD	C,33
D976                _S11B:
D976 ED B0          	LDIR
D978                FEND:
D978 9F             	SBC	A,A		;CF=0 A=0 : CF=1 A=0FFH
D979                FENDE:
D979 FD E1          	POP	IY
D97B C1             	POP	BC
D97C D1             	POP	DE
D97D E1             	POP	HL
D97E C9             	RET
D97F                
D97F                _SYS12:		;(BDOS)次のファイルの検索
D97F E5             	PUSH	HL
D980 D5             	PUSH	DE
D981 C5             	PUSH	BC
D982 FD E5          	PUSH	IY
D984 CD 23 E2       	CALL	NOPEN
D987 18 B3          	JR	_S12X1
D989                
D989                _S16K:
D989 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D98C FE FD          	CP	0FDH		;Device(0FDH)
D98E 37             	SCF
D98F C8             	RET	Z
D990                
D990 11 00 00       OFCB:	LD	DE,0
D993 D5             	PUSH	DE
D994 06 1A          	LD	B,26		;First cluster
D996                S16K1:
D996 13             	INC	DE
D997 23             	INC	HL
D998 10 FC          	DJNZ	S16K1
D99A                
D99A 1A             	LD	A,(DE)
D99B BE             	CP	(HL)
D99C 20 13          	JR	NZ,S16K2
D99E 13             	INC	DE
D99F 23             	INC	HL
D9A0 1A             	LD	A,(DE)
D9A1 BE             	CP	(HL)
D9A2 20 0D          	JR	NZ,S16K2
D9A4                
D9A4 E1             	POP	HL
D9A5 FD E5          	PUSH	IY
D9A7 D1             	POP	DE
D9A8 1A             	LD	A,(DE)		;Drive
D9A9 BE             	CP	(HL)
D9AA 20 06          	JR	NZ,S16K3
D9AC                				;ここはCFが必ず0
D9AC ED 52          	SBC	HL,DE		;CP HL,DE
D9AE 37             	SCF
D9AF C0             	RET	NZ
D9B0 E5             	PUSH	HL
D9B1                S16K2:
D9B1 E1             	POP	HL
D9B2                S16K3:
D9B2 FD E5          	PUSH	IY
D9B4 D1             	POP	DE
D9B5                _SYS13:		;(BDOS)ファイルの削除
D9B5 CD 72 E1       	CALL	SETDRV
D9B8 CD F0 E3       	CALL	KILL
D9BB                FEND13:
D9BB 18 BB          	JR	FEND
D9BD                
D9BD                _SYS14:		;(BDOS)シーケンシャルな読み出し
D9BD CD 72 E1       	CALL	SETDRV
D9C0 CD 28 E6       	CALL	INIT_SEQ
D9C3                SREAD:
D9C3 CD 70 E6       	CALL	RB_READ
D9C6                
D9C6 C6 01          	ADD	A,001H
D9C8 38 AE          	JR	C,FEND
D9CA                
D9CA 7D             	LD	A,L
D9CB D6 01          	SUB	001H
D9CD                FENDX:
D9CD 9F             	SBC	A,A
D9CE E6 03          	AND	3
D9D0 1F             	RRA
D9D1 18 A6          	JR	FENDE
D9D3                
D9D3                _SYS15:		;(BDOS)シーケンシャルな書き込み
D9D3 CD 72 E1       	CALL	SETDRV
D9D6 CD 28 E6       	CALL	INIT_SEQ
D9D9                SWRITE:
D9D9 CD 69 E6       	CALL	RB_WRITE
D9DC                
D9DC C6 FF          	ADD	A,0FFH
D9DE 18 ED          	JR	FENDX
D9E0                
D9E0                _SYS17:		;(BDOS)ファイル名の変更
D9E0 CD 72 E1       	CALL	SETDRV
D9E3 CD 46 E4       	CALL	NAME
D9E6 18 D3          	JR	FEND13
D9E8                
D9E8                _SYS16:		;(BDOS)ファイルの作成
D9E8 CD 72 E1       	CALL	SETDRV
D9EB                
D9EB CD C0 E4       	CALL	CHKWILDX
D9EE 38 CB          	JR	C,FEND13
D9F0 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
D9F3 FE 05          	CP	5
D9F5 28 05          	JR	Z,_S16X2
D9F7 FE 21          	CP	021H
D9F9 DA BB D9       	JP	C,FEND13
D9FC                _S16X2:
D9FC                ;				Clear FCB
D9FC FD E5          	PUSH	IY
D9FE E1             	POP	HL
D9FF 01 10 00       	LD	BC,16
DA02 09             	ADD	HL,BC
DA03                _S16X1:
DA03 70             	LD	(HL),B		;B=0
DA04 23             	INC	HL
DA05 0D             	DEC	C
DA06 20 FB          	JR	NZ,_S16X1
DA08                
DA08 CD C1 E5       	CALL	SETTMSX
DA0B FD 36 0D FF    	LD	(IY+13),0FFH	;(FCB)Attribute
DA0F CD 92 E1       	CALL	SOPENX
DA12 3F             	CCF
DA13 CC 89 D9       	CALL	Z,_S16K
DA16 D4 70 E2       	CALL	NC,COPEN
DA19 D4 D0 E4       	CALL	NC,SDIRENT
DA1C C3 AB D8       	JP	_S16XX
DA1F                
DA1F                _SYS21:		;(BDOS)ランダムな読み出し
DA1F CD 72 E1       	CALL	SETDRV
DA22 CD 0C E6       	CALL	INIT_RND
DA25 18 9C          	JR	SREAD
DA27                
DA27                _SYS22:		;(BDOS)ランダムな書き込み
DA27                _SYS28:		;(BDOS)ランダムな書き込み・その2
DA27 CD 72 E1       	CALL	SETDRV
DA2A CD 0C E6       	CALL	INIT_RND
DA2D 18 AA          	JR	SWRITE
DA2F                
DA2F                _SYS18:		;(BDOS)ログインベクトルの獲得
DA2F 21 FF 00       	LD	HL,000FFH
DA32 AF             	XOR	A
DA33 C9             	RET
DA34                
DA34                _SYS19:		;(BDOS)カレントドライブ番号の獲得
DA34 3A 87 F0       	LD	A,(_DVSW)
DA37 A7             	AND	A
DA38 C9             	RET
DA39                
DA39                _SYS1A:		;(BDOS)DTAの設定
DA39 ED 53 8A F0    	LD	(_DTA),DE
DA3D AF             	XOR	A
DA3E C9             	RET
DA3F                
DA3F                _SYS1B:		;(BDOS)ディスク情報の獲得
DA3F 7B             	LD	A,E
DA40 CD 85 E1       	CALL	GETDRV
DA43 CD DC F0       	CALL	_GETDPB
DA46 D4 E2 F0       	CALL	NC,_RDFATX
DA49 21 00 00       	LD	HL,0
DA4C D4 9A E5       	CALL	NC,DSKF
DA4F                
DA4F ED 5B 9B E5    	LD	DE,(MAXCLP+1)	;DPB_08_MAXCL-1
DA53 1B             	DEC	DE		;DE←クラスタの総数
DA54 FD 2A 7C F1    	LD	IY,(_FATBF)	;IY←メモリ上のFATの先頭アドレス
DA58 9F             	SBC	A,A
DA59 D8             	RET	C
DA5A 4F             	LD	C,A		;C=0
DA5B DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS
DA5E E6 0F          	AND	00FH
DA60 47             	LD	B,A
DA61 DD 7E 07       	LD	A,(IX+7)	;DPB_07_SECPCL
DA64 C9             	RET
DA65                
DA65                _SYS1D:		;(BDOS)書き込みが禁止されているディスクの調査
DA65 AF             	XOR	A
DA66 67             	LD	H,A
DA67 6F             	LD	L,A
DA68 C9             	RET
DA69                
DA69                _SYS1F:		;(BDOS)ディスク装置のパラメータの読み出し
DA69 21 00 F2       	LD	HL,DEVICE
DA6C 7B             	LD	A,E
DA6D C3 DC F0       	JP	_GETDPB
DA70                
DA70                _SYS23:		;(BDOS)ファイルサイズの獲得
DA70 E5             	PUSH	HL
DA71 2A 1E F1       	LD	HL,(STABLE+2*00FH)	;ファイルのオープン
DA74 CD 0F 00       	CALL	JP_HL
DA77 38 1B          	JR	C,_S23X1
DA79                
DA79 D5             	PUSH	DE		;EX DE,IY
DA7A FD E3          	EX	(SP),IY		;
DA7C                ;	POP	DE		;
DA7C                ;	PUSH	DE		;DEを破壊しないように注意vv
DA7C FD 7E 10       	LD	A,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
DA7F FD 6E 11       	LD	L,(IY+17)	;
DA82 FD 66 12       	LD	H,(IY+18)	;
DA85 C5             	PUSH	BC		;
DA86 FD 46 13       	LD	B,(IY+19)	;
DA89 CD FE E5       	CALL	GET_CPM_R_SIZE
DA8C C1             	POP	BC
DA8D                _S24X1:
DA8D CD 1E E6       	CALL	SET_RR_AHL
DA90                ;	POP	DE		;^^^^^^^^^^^^^^^^^^^^^^^^
DA90                ;	PUSH	DE		;EX DE,IY
DA90 FD E3          	EX	(SP),IY		;
DA92 D1             	POP	DE		;
DA93                
DA93 AF             	XOR	A
DA94                _S23X1:
DA94 E1             	POP	HL
DA95 C9             	RET
DA96                
DA96                _SYS24:		;(BDOS)ランダムレコードフィールドの設定
DA96 E5             	PUSH	HL
DA97 D5             	PUSH	DE		;EX DE,IY
DA98 FD E3          	EX	(SP),IY		;
DA9A                ;	POP	DE		;
DA9A                ;	PUSH	DE		;DEを破壊しないように注意vv
DA9A CD 30 E6       	CALL	GETSEQ
DA9D 18 EE          	JR	_S24X1		;^^^^^^^^^^^^^^^^^^^^^^^^
DA9F                
DA9F                _SYS29:		;(BDOS)ファイル名の解析(_PPATH)
DA9F C5             	PUSH	BC
DAA0 E5             	PUSH	HL
DAA1 CD 89 E0       	CALL	FILE
DAA4 E1             	POP	HL
DAA5 C1             	POP	BC
DAA6                S29X1:
DAA6 C5             	PUSH	BC
DAA7 D5             	PUSH	DE
DAA8 E5             	PUSH	HL
DAA9 EB             	EX	DE,HL
DAAA AF             	XOR	A
DAAB 32 21 F0       	LD	(FDRV+13),A
DAAE 21 14 F0       	LD	HL,FDRV
DAB1 01 10 00       	LD	BC,16
DAB4 ED B0          	LDIR
DAB6 E1             	POP	HL
DAB7 D1             	POP	DE
DAB8 C1             	POP	BC
DAB9 C9             	RET
DABA                
DABA                _SYS30:		;(BDOS)論理セクタを用いた書き込み
DABA C5             	PUSH	BC
DABB 01 81 EC       	LD	BC,DWT24B
DABE 18 04          	JR	S2FX
DAC0                _SYS2F:
DAC0 C5             	PUSH	BC
DAC1 01 71 EC       	LD	BC,DRD24B
DAC4                S2FX:
DAC4 ED 43 DA DA    	LD	(S2FPAT+1),BC
DAC8 CD DF F0       	CALL	_FFLUSH
DACB                
DACB D5             	PUSH	DE
DACC E5             	PUSH	HL
DACD 7D             	LD	A,L		;Drive
DACE CD D9 F0       	CALL	_CHGDRV
DAD1 38 09          	JR	C,S30X2
DAD3 44             	LD	B,H		;Number of clusters
DAD4 2A 8A F0       	LD	HL,(_DTA)
DAD7                
DAD7 0E 00          	LD	C,0
DAD9 CD 71 EC       S2FPAT:	CALL	DRD24B
DADC                S30X2:
DADC E1             	POP	HL
DADD D1             	POP	DE
DADE C1             	POP	BC
DADF 9F             	SBC	A,A
DAE0 C9             	RET
DAE1                
DAE1                _SYS5A:		;(BDOS)カレントディレクトリの変更
DAE1 C5             	PUSH	BC
DAE2 D5             	PUSH	DE
DAE3 E5             	PUSH	HL
DAE4 CD 7E E0       	CALL	FILEC
DAE7 21 00 00       	LD	HL,0
DAEA 11 14 F0       	LD	DE,FDRV
DAED 2A 4E F1       	LD	HL,(STABLE+2*027H)	;ランダムブロック読み込み
DAF0 CD 0F 00       	CALL	JP_HL
DAF3 18 E7          	JR	S30X2
DAF5                	INCLUDE	"X1IO.ASM"
DAF5                
DAF5                ;	LSX-Dodgers IO
DAF5                ;	X1/turbo/Z
DAF5                
DAF5 00 00 D8 5F    _SYS04	EQU	_ERROR		;(BDOS)外部出力
DAF5 00 00 D8 5F    _SYS05	EQU	_ERROR		;(BDOS)プリンタ出力
DAF5 00 00 D8 5F    _SYS1C	EQU	_ERROR		;(BDOS)ディスクの書き込み禁止化
DAF5 00 00 D8 5F    _SYS1E	EQU	_ERROR		;(BDOS)ファイル属性の設定
DAF5 00 00 D8 5F    _SYS20	EQU	_ERROR		;(BDOS)利用者番号の設定と読み出し
DAF5 00 00 D8 5F    _SYS2E	EQU	_ERROR		;(BDOS)ベリファイ・フラグの設定
DAF5                
DAF5                BIOS:
DAF5 E5             	PUSH	HL
DAF6 21 10 80       	LD	HL,08010H
DAF9 39             	ADD	HL,SP
DAFA E1             	POP	HL
DAFB 30 0E          	JR	NC,BIOS2
DAFD                BIOS1:
DAFD CD 05 DB       	CALL	BIOS3
DB00 06 1E          	LD	B,01EH
DB02 ED 79          	OUT	(C),A
DB04 C9             	RET
DB05                BIOS3:
DB05 C5             	PUSH	BC
DB06 06 1D          	LD	B,01DH
DB08 ED 79          	OUT	(C),A
DB0A C9             	RET
DB0B                BIOS2:
DB0B ED 73 16 DB    	LD	(BIOS_SP),SP	;スタックがBIOS-ROMと被っている場合
DB0F 31 CA FF       	LD	SP,EXTSP
DB12 CD FD DA       	CALL	BIOS1
DB15 31 00 00       	LD	SP,0
DB18 00 00 DB 16    BIOS_SP	EQU	$-2
DB18 C9             	RET
DB19                
DB19                INT:
DB19 F5             	PUSH	AF
DB1A E5             	PUSH	HL
DB1B C5             	PUSH	BC
DB1C                
DB1C CD C0 DE       	CALL	IN49SB
DB1F 67             	LD	H,A
DB20 CD C0 DE       	CALL	IN49SB
DB23 6F             	LD	L,A
DB24                SCEXE:
DB24 22 92 F0       	LD	(_KEYD),HL
DB27 CD 57 DB       	CALL	KEYSET1
DB2A                
DB2A C1             	POP	BC
DB2B                INTPE:
DB2B E1             	POP	HL
DB2C                INTPE2:
DB2C F1             	POP	AF
DB2D                INTCTCE:
DB2D FB             	EI
DB2E ED 4D          	RETI
DB30                
DB30                INTCTC2:
DB30 F5             	PUSH	AF
DB31 3E 00          INTCPAT:LD	A,000H
DB33 3D             	DEC	A
DB34 32 32 DB       	LD	(INTCPAT+1),A
DB37 20 F3          	JR	NZ,INTPE2
DB39                
DB39 3A 92 F0       	LD	A,(_KEYD)
DB3C B7             	OR	A
DB3D 28 ED          	JR	Z,INTPE2
DB3F                KEYSET0:
DB3F E5             	PUSH	HL
DB40 2A 90 F0       	LD	HL,(_KEYPS)
DB43 7C             	LD	A,H
DB44 AD             	XOR	L
DB45 20 06          	JR	NZ,INTC2A
DB47                
DB47 2A 92 F0       	LD	HL,(_KEYD)
DB4A CD 8B DB       	CALL	KEYSET
DB4D                INTC2A:
DB4D 3A 94 F0       	LD	A,(_KEYSP)
DB50 E6 0F          	AND	00FH
DB52 32 32 DB       	LD	(INTCPAT+1),A
DB55                
DB55 18 D4          	JR	INTPE
DB57                
DB57                KEYSET1:
DB57 CB 6C          	BIT	5,H
DB59 F5             	PUSH	AF
DB5A ED 4B 8C F0    	LD	BC,(_CTC)
DB5E 78             	LD	A,B
DB5F B1             	OR	C
DB60 20 06          	JR	NZ,KEYS10E
DB62                
DB62 F1             	POP	AF
DB63 20 26          	JR	NZ,KEYSET
DB65 F5             	PUSH	AF
DB66 18 D7          	JR	KEYSET0
DB68                KEYS10E:
DB68 F1             	POP	AF
DB69 C8             	RET	Z
DB6A F5             	PUSH	AF
DB6B 3E 03          	LD	A,3		;CTC STOP
DB6D ED 79          	OUT	(C),A
DB6F F1             	POP	AF
DB70                
DB70 B7             	OR	A
DB71 C8             	RET	Z
DB72                
DB72 3E A7          	LD	A,0A7H
DB74 ED 79          	OUT	(C),A
DB76 3A 94 F0       	LD	A,(_KEYSP)
DB79 ED 79          	OUT	(C),A
DB7B 79             	LD	A,C
DB7C E6 FC          	AND	0FCH
DB7E 4F             	LD	C,A
DB7F ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
DB81 3E C0          	LD	A,CTC0
DB83 ED 79          	OUT	(C),A
DB85 3A 95 F0       	LD	A,(_KEYSP+1)
DB88 32 32 DB       	LD	(INTCPAT+1),A
DB8B                
DB8B                KEYSET:
DB8B 7D             	LD	A,L
DB8C CB 74          	BIT	6,H
DB8E C0             	RET	NZ
DB8F                KEYBS:
DB8F B7             	OR	A
DB90 C8             	RET	Z
DB91                KEYBS1:
DB91 CD A9 DB       	CALL	KEYBC_IFBREAK
DB94 E5             	PUSH	HL
DB95 F5             	PUSH	AF
DB96 2A 90 F0       	LD	HL,(_KEYPS)
DB99 2C             	INC	L
DB9A CB AD          	RES	5,L
DB9C 7D             	LD	A,L
DB9D BC             	CP	H
DB9E 28 15          	JR	Z,POP_AF_HL_SCF_RET
DBA0 32 90 F0       	LD	(_KEYPS),A
DBA3 26 FF          	LD	H,KEYBF/256
DBA5 F1             	POP	AF
DBA6 77             	LD	(HL),A
DBA7 E1             	POP	HL
DBA8 C9             	RET
DBA9                KEYBC_IFBREAK:
DBA9 FE 03          	CP	3
DBAB C0             	RET	NZ
DBAC                KEYBC:
DBAC E5             	PUSH	HL
DBAD 21 00 00       	LD	HL,0
DBB0 22 90 F0       	LD	(_KEYPS),HL
DBB3 E1             	POP	HL
DBB4 C9             	RET
DBB5                
DBB5                POP_AF_HL_SCF_RET:
DBB5 F1             	POP	AF
DBB6 E1             	POP	HL
DBB7 37             	SCF
DBB8 C9             	RET
DBB9                
DBB9                _SYS01:		;(BDOS)コンソール入力
DBB9 CD 09 F0       	CALL	_SYS07
DBBC                MSG_A:
DBBC F5             	PUSH	AF
DBBD D5             	PUSH	DE
DBBE 5F             	LD	E,A
DBBF CD C5 DB       	CALL	_SYS02
DBC2 D1             	POP	DE
DBC3 F1             	POP	AF
DBC4 C9             	RET
DBC5                
DBC5                _SYS02:		;(BDOS)コンソール出力
DBC5 CD D7 DB       	CALL	BREAK
DBC8 18 05          	JR	PRINTX
DBCA                
DBCA                _SYS06:		;(BDOS)コンソール直接入出力
DBCA 7B             	LD	A,E
DBCB 3C             	INC	A
DBCC CA CA F0       	JP	Z,_INKEY
DBCF                PRINTX:
DBCF C3 CD F0       	JP	_PRINT
DBD2                
DBD2                _SYS08:		;(BDOS)エコーなしコンソール入力
DBD2 CD 09 F0       	CALL	_SYS07
DBD5 18 04          	JR	BREAK1
DBD7                BREAK:
DBD7 FB             	EI
DBD8 3A 92 F0       	LD	A,(_KEYD)
DBDB                BREAK1:
DBDB FE 03          	CP	3		;CTRL+C
DBDD CC F4 F0       	CALL	Z,_BREAK
DBE0 FE 13          	CP	013H		;CTRL+S
DBE2 C0             	RET	NZ
DBE3                
DBE3                PAUSE:
DBE3 CD AC DB       	CALL	KEYBC
DBE6                
DBE6                FLGET:
DBE6 CD DF F0       	CALL	_FFLUSH
DBE9 C5             	PUSH	BC
DBEA E5             	PUSH	HL
DBEB ED 4B 8E F0    	LD	BC,(_TXADR)
DBEF CB E8          	SET	5,B
DBF1 ED 60          	IN	H,(C)
DBF3                FLGET1:
DBF3 3A 93 F0       	LD	A,(_KEYD+1)
DBF6 0F             	RRCA
DBF7 0F             	RRCA
DBF8 E6 10          	AND	010H
DBFA F6 08          	OR	8
DBFC ED 68          	IN	L,(C)
DBFE B5             	OR	L
DBFF ED 79          	OUT	(C),A
DC01 CD CA F0       	CALL	_INKEY
DC04 28 ED          	JR	Z,FLGET1
DC06 ED 61          	OUT	(C),H
DC08 E1             	POP	HL
DC09 C1             	POP	BC
DC0A C9             	RET
DC0B                
DC0B                _SYS0A:		;(BDOS)文字列入力
DC0B C5             	PUSH	BC
DC0C E5             	PUSH	HL
DC0D D5             	PUSH	DE
DC0E CD 0D E0       	CALL	GETL
DC11 11 20 FF       	LD	DE,KBUF
DC14 E1             	POP	HL
DC15 E5             	PUSH	HL
DC16 0E 00          	LD	C,0
DC18 30 04          	JR	NC,SAX0
DC1A 23             	INC	HL
DC1B 23             	INC	HL
DC1C 18 08          	JR	SAX4
DC1E                SAX0:
DC1E 46             	LD	B,(HL)
DC1F 23             	INC	HL
DC20                SAX1:
DC20 23             	INC	HL
DC21 1A             	LD	A,(DE)
DC22 13             	INC	DE
DC23 B7             	OR	A
DC24 20 04          	JR	NZ,SAX2
DC26                SAX4:
DC26 36 0D          	LD	(HL),00DH
DC28 18 04          	JR	SAX3
DC2A                SAX2:
DC2A 77             	LD	(HL),A
DC2B 0C             	INC	C
DC2C 10 F2          	DJNZ	SAX1
DC2E                SAX3:
DC2E D1             	POP	DE
DC2F 79             	LD	A,C
DC30 13             	INC	DE
DC31 12             	LD	(DE),A
DC32 1B             	DEC	DE
DC33 E1             	POP	HL
DC34 C1             	POP	BC
DC35 A7             	AND	A
DC36 C9             	RET
DC37                
DC37                _SYS0B:		;(BDOS)コンソール状態のチェック
DC37 CD D7 DB       	CALL	BREAK
DC3A 3A 92 F0       	LD	A,(_KEYD)
DC3D B7             	OR	A
DC3E C8             	RET	Z
DC3F                CONSTX:
DC3F CD DF F0       	CALL	_FFLUSH
DC42 E5             	PUSH	HL
DC43 2A 90 F0       	LD	HL,(_KEYPS)
DC46 7C             	LD	A,H
DC47 AD             	XOR	L
DC48 E1             	POP	HL
DC49 C6 FF          	ADD	A,0FFH
DC4B 9F             	SBC	A,A
DC4C C9             	RET
DC4D                
DC4D                _SYS2A:		;(BDOS)日付の獲得
DC4D C5             	PUSH	BC
DC4E 3E ED          	LD	A,0EDH		;Read calendar
DC50 CD DB DE       	CALL	COMOUT
DC53 CD 85 DC       	CALL	IN49SB_BCD	;YY
DC56 6F             	LD	L,A
DC57 26 00          	LD	H,0
DC59                ;	LD	DE,1900		;0076CH
DC59                ;	CP	90		;90以上は1900年代 1990-1999
DC59                ;	JR	NC,RDDATE1	;90未満は2000年代 2000-2089
DC59                ;	LD	E,0D0H		;2000 & 0FFH D=007H
DC59 11 D0 07       	LD	DE,2000		;すべて2000年代で処理 2000-2099
DC5C                RDDATE1:
DC5C 19             	ADD	HL,DE
DC5D CD C0 DE       	CALL	IN49SB		;MW
DC60 57             	LD	D,A
DC61 CD 85 DC       	CALL	IN49SB_BCD	;DD
DC64 5F             	LD	E,A
DC65 7A             	LD	A,D
DC66 06 04          	LD	B,4
DC68                RDDATE2:
DC68 CB 3A          	SRL	D
DC6A 10 FC          	DJNZ	RDDATE2
DC6C C1             	POP	BC
DC6D E6 07          	AND	7
DC6F C9             	RET
DC70                
DC70                _SYS2C:		;(BDOS)時刻の獲得
DC70 C5             	PUSH	BC
DC71 3E EF          	LD	A,0EFH		;Read time
DC73 CD DB DE       	CALL	COMOUT
DC76 CD 85 DC       	CALL	IN49SB_BCD	;TT
DC79 67             	LD	H,A
DC7A CD 85 DC       	CALL	IN49SB_BCD	;MM
DC7D 6F             	LD	L,A
DC7E CD 85 DC       	CALL	IN49SB_BCD	;SS
DC81 57             	LD	D,A
DC82 C1             	POP	BC
DC83 AF             	XOR	A
DC84 C9             	RET
DC85                
DC85                IN49SB_BCD:
DC85 CD C0 DE       	CALL	IN49SB
DC88                ;------------------------
DC88                ;BCDの10進数化
DC88                ;in
DC88                ;	A  : BCD
DC88                ;out
DC88                ;	A  : 10進数
DC88                ;------------------------
DC88 4F             	LD	C,A
DC89 E6 F0          	AND	0F0H	;10の位
DC8B 0F             	RRCA
DC8C 47             	LD	B,A
DC8D 0F             	RRCA
DC8E 0F             	RRCA
DC8F 80             	ADD	A,B
DC90 47             	LD	B,A
DC91 79             	LD	A,C
DC92 E6 0F          	AND	00FH	;1の位
DC94 80             	ADD	A,B
DC95 C9             	RET
DC96                
DC96                ESC1:
DC96 7B             	LD	A,E
DC97 FE 41          	CP	'A'
DC99 CA DE DD       	JP	Z,CTRL1E
DC9C FE 42          	CP	'B'
DC9E CA 46 DF       	JP	Z,CTRL1F
DCA1 FE 43          	CP	'C'
DCA3 CA E9 DD       	JP	Z,CTRL1C
DCA6 FE 44          	CP	'D'
DCA8 CA D5 DD       	JP	Z,CTRL1D
DCAB FE 45          	CP	'E'
DCAD 28 02          	JR	Z,CT0CX
DCAF FE 6A          	CP	'j'
DCB1                CT0CX:
DCB1 CA 19 DF       	JP	Z,CTRL0C
DCB4 FE 48          	CP	'H'
DCB6 CA 63 DE       	JP	Z,CTRL0B
DCB9 FE 4A          	CP	'J'
DCBB CA 1C DF       	JP	Z,CTRL06
DCBE FE 4B          	CP	'K'
DCC0 28 07          	JR	Z,CT05X
DCC2 FE 4C          	CP	'L'
DCC4 CA 5B DF       	JP	Z,CTRL0E
DCC7 FE 54          	CP	'T'
DCC9                CT05X:
DCC9 CA 22 DE       	JP	Z,CTRL05
DCCC FE 78          	CP	'x'
DCCE 28 04          	JR	Z,ESC1X
DCD0 FE 79          	CP	'y'
DCD2 20 02          	JR	NZ,ESC1Y
DCD4                ESC1X:
DCD4 36 01          	LD	(HL),1
DCD6                ESC1Y:
DCD6 FE 3D          	CP	'='
DCD8 28 04          	JR	Z,ESC1W
DCDA FE 59          	CP	'Y'
DCDC 20 02          	JR	NZ,ESC1Z
DCDE                ESC1W:
DCDE 36 02          	LD	(HL),2
DCE0                ESC1Z:
DCE0 FE 20          	CP	020H
DCE2 38 02          	JR	C,ESC1C
DCE4 87             	ADD	A,A
DCE5 D0             	RET	NC
DCE6                ESC1C:
DCE6 E1             	POP	HL
DCE7                ANK:
DCE7 ED 4B 8E F0    	LD	BC,(_TXADR)
DCEB 78             	LD	A,B
DCEC F6 38          	OR	038H
DCEE 47             	LD	B,A
DCEF ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DCF1 CB 98          	RES	3,B
DCF3 ED 59          	OUT	(C),E		;Text
DCF5                KANJIE:
DCF5 CD AA DD       	CALL	PRINTE7
DCF8                PRINTE5:
DCF8 E1             	POP	HL
DCF9 C1             	POP	BC
DCFA AF             	XOR	A
DCFB C9             	RET
DCFC                
DCFC                ESC:
DCFC 21 F8 DC       	LD	HL,PRINTE5
DCFF E5             	PUSH	HL
DD00 21 22 DD       	LD	HL,ESCFLG+1
DD03 36 00          	LD	(HL),0
DD05 3D             	DEC	A
DD06 28 8E          	JR	Z,ESC1
DD08 3D             	DEC	A
DD09 20 09          	JR	NZ,ESC2
DD0B 36 03          	LD	(HL),3
DD0D 7B             	LD	A,E
DD0E D6 20          	SUB	020H
DD10 32 17 DD       	LD	(ESCYP+1),A
DD13 C9             	RET
DD14                ESC2:
DD14 3D             	DEC	A
DD15 C0             	RET	NZ
DD16 26 00          ESCYP:	LD	H,0
DD18 7B             	LD	A,E
DD19 D6 20          	SUB	020H
DD1B 6F             	LD	L,A
DD1C C3 D6 F0       	JP	_LOC
DD1F                
DD1F                PRINT:
DD1F C5             	PUSH	BC
DD20 E5             	PUSH	HL
DD21 3E 00          ESCFLG:	LD	A,000H
DD23 B7             	OR	A
DD24 20 D6          	JR	NZ,ESC
DD26                
DD26 3E 1F          	LD	A,01FH
DD28 BB             	CP	E
DD29 30 20          	JR	NC,CTRL
DD2B 01 E4 DE       INSFLG:	LD	BC,INSERT
DD2E                
DD2E 3A 18 00       	LD	A,(00018H)
DD31 3C             	INC	A
DD32 28 B3          	JR	Z,ANK
DD34 3E 00          KANFLG:	LD	A,000H
DD36 B7             	OR	A
DD37 20 25          	JR	NZ,KANJI2
DD39 7B             	LD	A,E
DD3A FE 80          	CP	080H
DD3C 38 A9          	JR	C,ANK
DD3E FE A0          	CP	0A0H
DD40 38 04          	JR	C,KANJI1
DD42 FE E0          	CP	0E0H
DD44 38 A1          	JR	C,ANK
DD46                KANJI1:
DD46 32 35 DD       	LD	(KANFLG+1),A
DD49 18 AD          	JR	PRINTE5
DD4B                
DD4B                CTRL:
DD4B CD 91 DD       	CALL	KANCLR
DD4E 7B             	LD	A,E
DD4F 87             	ADD	A,A
DD50 F6 80          	OR	080H
DD52 6F             	LD	L,A
DD53 26 F1          	LD	H,CTRLTB/256
DD55 7E             	LD	A,(HL)
DD56 2C             	INC	L
DD57 66             	LD	H,(HL)
DD58 6F             	LD	L,A
DD59 CD 0F 00       	CALL	JP_HL
DD5C 18 9A          	JR	PRINTE5
DD5E                
DD5E                KANJI2:
DD5E D5             	PUSH	DE
DD5F 57             	LD	D,A
DD60 01 81 2F       	LD	BC,02F81H	;SFTJIS
DD63 DF             	RST	018H
DD64 01 C3 2F       	LD	BC,02FC3H	;Instead or JISVRM
DD67 DF             	RST	018H
DD68                
DD68 ED 4B 8E F0    	LD	BC,(_TXADR)
DD6C 78             	LD	A,B
DD6D F6 38          	OR	038H
DD6F 47             	LD	B,A
DD70 ED 51          	OUT	(C),D		;kanji
DD72 CB 98          	RES	3,B
DD74 ED 59          	OUT	(C),E		;Text
DD76 CD AA DD       	CALL	PRINTE7
DD79 ED 4B 8E F0    	LD	BC,(_TXADR)
DD7D 78             	LD	A,B
DD7E F6 38          	OR	038H
DD80 47             	LD	B,A
DD81 CB F2          	SET	6,D
DD83 ED 51          	OUT	(C),D		;Kanji
DD85 CB 98          	RES	3,B
DD87 ED 59          	OUT	(C),E		;Text
DD89 D1             	POP	DE
DD8A AF             	XOR	A
DD8B 32 35 DD       	LD	(KANFLG+1),A
DD8E C3 F5 DC       	JP	KANJIE
DD91                
DD91                KANCLR:
DD91 3A 35 DD       	LD	A,(KANFLG+1)
DD94 B7             	OR	A
DD95 C8             	RET	Z
DD96 ED 4B 8E F0    	LD	BC,(_TXADR)
DD9A 78             	LD	A,B
DD9B F6 38          	OR	038H
DD9D 47             	LD	B,A
DD9E AF             	XOR	A
DD9F 32 35 DD       	LD	(KANFLG+1),A
DDA2 ED 79          	OUT	(C),A		;Kanji
DDA4 CB 98          	RES	3,B
DDA6 3E 20          	LD	A,020H
DDA8 ED 79          	OUT	(C),A		;Text
DDAA                PRINTE7:
DDAA CB A0          	RES	4,B
DDAC                PRINTE6:
DDAC 3A 96 F0       	LD	A,(_COLORF)
DDAF                PRINTE4:
DDAF ED 79          	OUT	(C),A		;Color
DDB1 78             	LD	A,B
DDB2 E6 07          	AND	7
DDB4 47             	LD	B,A
DDB5                PRINTE2:
DDB5 03             	INC	BC
DDB6                PRINTE3:
DDB6 2A BA F0       	LD	HL,(_PAGE_MINUS)
DDB9 A7             	AND	A
DDBA ED 4A          	ADC	HL,BC
DDBC                PRINTE8:
DDBC 28 05          	JR	Z,PRINT2
DDBE ED 43 8E F0    	LD	(_TXADR),BC
DDC2                CTRL00:
DDC2 C9             	RET
DDC3                
DDC3                PRINT2:
DDC3 CD 61 DF       	CALL	SCR
DDC6 2A BC F0       	LD	HL,(_WIDTH_MINUS)
DDC9 09             	ADD	HL,BC
DDCA                SET_TXADR_HL:
DDCA 22 8E F0       	LD	(_TXADR),HL
DDCD C9             	RET
DDCE                
DDCE                CTRL08:
DDCE 3A 2B DD       	LD	A,(INSFLG)
DDD1 FE CD          	CP	0CDH		;CALL ????
DDD3 28 29          	JR	Z,CTRL02
DDD5                CTRL1D:
DDD5 2A 8E F0       	LD	HL,(_TXADR)
DDD8 7C             	LD	A,H
DDD9 B5             	OR	L
DDDA C8             	RET	Z
DDDB 2B             	DEC	HL
DDDC 18 EC          	JR	SET_TXADR_HL
DDDE                
DDDE                CTRL1E:
DDDE ED 4B 8E F0    	LD	BC,(_TXADR)
DDE2 2A BC F0       	LD	HL,(_WIDTH_MINUS)
DDE5 09             	ADD	HL,BC
DDE6 D0             	RET	NC
DDE7 18 E1          	JR	SET_TXADR_HL
DDE9                
DDE9                CTRL1C:
DDE9 ED 4B 8E F0    	LD	BC,(_TXADR)
DDED 18 C6          	JR	PRINTE2
DDEF                
DDEF                CTRL09:
DDEF ED 4B 8E F0    	LD	BC,(_TXADR)
DDF3 79             	LD	A,C
DDF4 E6 F8          	AND	0F8H
DDF6 C6 08          	ADD	A,8
DDF8 4F             	LD	C,A
DDF9 88             	ADC	A,B
DDFA 91             	SUB	C
DDFB 47             	LD	B,A
DDFC 18 B8          	JR	PRINTE3
DDFE                
DDFE                CTRL02:
DDFE CD D5 DD       	CALL	CTRL1D
DE01 C8             	RET	Z
DE02 D5             	PUSH	DE
DE03 CD D3 F0       	CALL	_POS
DE06 3A B1 F0       	LD	A,(_WIDTH)
DE09 95             	SUB	L
DE0A 4F             	LD	C,A
DE0B 0D             	DEC	C
DE0C 06 38          	LD	B,038H
DE0E 2A 8E F0       	LD	HL,(_TXADR)
DE11 09             	ADD	HL,BC
DE12 44             	LD	B,H
DE13 4D             	LD	C,L
DE14 11 00 20       	LD	DE,02000H	;D:Text E:kanji
DE17 2A 96 F0       	LD	HL,(_COLORF)	;L:Color
DE1A                C8X1:
DE1A CD 00 DF       	CALL	C12S
DE1D 0B             	DEC	BC
DE1E 20 FA          	JR	NZ,C8X1
DE20 D1             	POP	DE
DE21 C9             	RET
DE22                
DE22                CTRL05:
DE22 CD D3 F0       	CALL	_POS
DE25 3A B1 F0       	LD	A,(_WIDTH)
DE28 95             	SUB	L
DE29 6F             	LD	L,A
DE2A                C08X1:
DE2A ED 4B 8E F0    	LD	BC,(_TXADR)
DE2E                LINECL:
DE2E 26 20          	LD	H,020H
DE30 3A 96 F0       	LD	A,(_COLORF)
DE33 CB E8          	SET	5,B
DE35                LINECL1:
DE35 CB D8          	SET	3,B
DE37 CB E0          	SET	4,B
DE39 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DE3B CB 98          	RES	3,B
DE3D ED 61          	OUT	(C),H		;Text
DE3F CB A0          	RES	4,B
DE41 ED 79          	OUT	(C),A		;Color
DE43 03             	INC	BC
DE44 2D             	DEC	L
DE45 20 EE          	JR	NZ,LINECL1
DE47 C9             	RET
DE48                
DE48                CTRL0D:
DE48 CD D3 F0       	CALL	_POS
DE4B 2E 00          	LD	L,0
DE4D                LOC:
DE4D C5             	PUSH	BC
DE4E E5             	PUSH	HL
DE4F CD 91 DD       	CALL	KANCLR
DE52 CD 70 DE       	CALL	LOC1
DE55 22 8E F0       	LD	(_TXADR),HL
DE58 E1             	POP	HL
DE59 C1             	POP	BC
DE5A C9             	RET
DE5B                
DE5B                CTRL12:
DE5B 21 2B DD       	LD	HL,INSFLG
DE5E 7E             	LD	A,(HL)
DE5F EE CC          	XOR	0CCH		;CD:CALL ???? 1:LD BC,????
DE61 77             	LD	(HL),A
DE62 C9             	RET
DE63                
DE63                CTRL0B:
DE63 21 00 00       	LD	HL,0
DE66 22 8E F0       	LD	(_TXADR),HL
DE69 C9             	RET
DE6A                
DE6A                CTRL1B:
DE6A 3E 01          	LD	A,1
DE6C 32 22 DD       	LD	(ESCFLG+1),A
DE6F C9             	RET
DE70                
DE70                LOC1:
DE70 D5             	PUSH	DE
DE71 4D             	LD	C,L
DE72 06 08          	LD	B,8
DE74 5C             	LD	E,H
DE75 16 00          	LD	D,0
DE77 2A B0 F0       	LD	HL,(CRTCD)
DE7A 6A             	LD	L,D
DE7B                LOC2:
DE7B 29             	ADD	HL,HL
DE7C 30 01          	JR	NC,LOC3
DE7E 19             	ADD	HL,DE
DE7F                LOC3:
DE7F 10 FA          	DJNZ	LOC2
DE81 09             	ADD	HL,BC
DE82 D1             	POP	DE
DE83 C9             	RET
DE84                
DE84                CONOUT1:
DE84 CD 96 DE       	CALL	CURSOR
DE87 59             	LD	E,C
DE88 CD CD F0       	CALL	_PRINT
DE8B 7B             	LD	A,E
DE8C FE 0A          	CP	00AH
DE8E 20 06          	JR	NZ,CURSOR
DE90 CD 48 DE       	CALL	CTRL0D
DE93 CD 22 DE       	CALL	CTRL05
DE96                CURSOR:
DE96 C5             	PUSH	BC
DE97 ED 4B 8E F0    	LD	BC,(_TXADR)
DE9B CB E8          	SET	5,B
DE9D ED 78          	IN	A,(C)
DE9F EE 18          	XOR	018H
DEA1 ED 79          	OUT	(C),A
DEA3 C1             	POP	BC
DEA4 C9             	RET
DEA5                
DEA5                CTRL07:
DEA5 21 61 F0       	LD	HL,BEEPD
DEA8                BEEP1:
DEA8 7E             	LD	A,(HL)
DEA9 23             	INC	HL
DEAA FE FF          	CP	0FFH
DEAC C8             	RET	Z
DEAD 06 1C          	LD	B,01CH
DEAF ED 79          	OUT	(C),A
DEB1 ED A3          	OUTI
DEB3 18 F3          	JR	BEEP1
DEB5                
DEB5                OT49SB:
DEB5 C5             	PUSH	BC
DEB6 CD D1 DE       	CALL	CANW
DEB9 01 00 19       	LD	BC,01900H
DEBC ED 79          	OUT	(C),A
DEBE C1             	POP	BC
DEBF C9             	RET
DEC0                
DEC0                IN49SB:
DEC0 C5             	PUSH	BC
DEC1 01 01 1A       	LD	BC,01A01H
DEC4                CANR:
DEC4 ED 78          	IN	A,(C)
DEC6 E6 20          	AND	020H
DEC8 20 FA          	JR	NZ,CANR
DECA 01 00 19       	LD	BC,01900H
DECD ED 78          	IN	A,(C)
DECF C1             	POP	BC
DED0 C9             	RET
DED1                
DED1                CANW:
DED1 01 01 1A       	LD	BC,01A01H
DED4 ED 48          	IN	C,(C)
DED6 CB 71          	BIT	6,C
DED8 20 F7          	JR	NZ,CANW
DEDA C9             	RET
DEDB                
DEDB                COMOUT:
DEDB FB             	EI
DEDC CD B5 DE       	CALL	OT49SB
DEDF CD D1 DE       	CALL	CANW
DEE2 F3             	DI
DEE3 C9             	RET
DEE4                
DEE4                INSERT:
DEE4 D5             	PUSH	DE
DEE5 CD D3 F0       	CALL	_POS
DEE8 3A B1 F0       	LD	A,(_WIDTH)
DEEB 95             	SUB	L
DEEC ED 4B 8E F0    	LD	BC,(_TXADR)
DEF0 11 00 20       	LD	DE,02000H	;D:Text E:Kanji
DEF3 2A 96 F0       	LD	HL,(_COLORF)	;L:Color
DEF6 CB E8          	SET	5,B
DEF8                C12X1:
DEF8 CD 00 DF       	CALL	C12S
DEFB 03             	INC	BC
DEFC 20 FA          	JR	NZ,C12X1
DEFE D1             	POP	DE
DEFF C9             	RET
DF00                
DF00                C12S:
DF00 CB E0          	SET	4,B
DF02 CB D8          	SET	3,B
DF04 ED 60          	IN	H,(C)
DF06 ED 59          X1PAT:	OUT	(C),E
DF08 5C             	LD	E,H
DF09 CB 98          	RES	3,B
DF0B ED 60          	IN	H,(C)
DF0D ED 51          	OUT	(C),D
DF0F 54             	LD	D,H
DF10 CB A0          	RES	4,B
DF12 ED 60          	IN	H,(C)
DF14 ED 69          	OUT	(C),L
DF16 6C             	LD	L,H
DF17 3D             	DEC	A
DF18 C9             	RET
DF19                
DF19                CTRL0C:
DF19 CD 63 DE       	CALL	CTRL0B
DF1C                CTRL06:
DF1C ED 4B 8E F0    	LD	BC,(_TXADR)
DF20                C1AX1:
DF20 78             	LD	A,B
DF21 F6 38          	OR	038H
DF23 47             	LD	B,A
DF24 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DF26 CB 98          	RES	3,B
DF28 3E 20          	LD	A,020H
DF2A ED 79          	OUT	(C),A		;Text
DF2C CB A0          	RES	4,B
DF2E 3A 96 F0       	LD	A,(_COLORF)
DF31 ED 79          	OUT	(C),A		;Color
DF33 03             	INC	BC
DF34 CB A8          	RES	5,B
DF36 2A BA F0       	LD	HL,(_PAGE_MINUS)
DF39 09             	ADD	HL,BC
DF3A 30 E4          	JR	NC,C1AX1
DF3C C9             	RET
DF3D                
DF3D                CTRL04:
DF3D CD D3 F0       	CALL	_POS
DF40 7D             	LD	A,L
DF41 B7             	OR	A
DF42 C8             	RET	Z
DF43                CTRL03:
DF43 CD 48 DE       	CALL	CTRL0D
DF46                CTRL0A:
DF46                CTRL1F:
DF46 ED 4B 8E F0    	LD	BC,(_TXADR)
DF4A 2A B1 F0       	LD	HL,(_WIDTH)
DF4D 26 00          	LD	H,0
DF4F 09             	ADD	HL,BC
DF50 44             	LD	B,H
DF51 4D             	LD	C,L
DF52 2A BA F0       	LD	HL,(_PAGE_MINUS)
DF55 09             	ADD	HL,BC
DF56 3F             	CCF
DF57 9F             	SBC	A,A
DF58 C3 BC DD       	JP	PRINTE8
DF5B                
DF5B                CTRL0E:
DF5B CD D3 F0       	CALL	_POS
DF5E 7C             	LD	A,H
DF5F 18 04          	JR	SCR1
DF61                SCR:
DF61 3A 97 F0       	LD	A,(_LINE)
DF64 3D             	DEC	A
DF65                SCR1:
DF65 C5             	PUSH	BC
DF66 D5             	PUSH	DE
DF67 F5             	PUSH	AF
DF68 3E 07          	LD	A,7
DF6A 21 9B DF       	LD	HL,SCRDMAD
DF6D CD 91 DF       	CALL	SETDMA
DF70 F1             	POP	AF
DF71 21 00 38       	LD	HL,03800H
DF74                
DF74                SCRUP1:
DF74 B7             	OR	A
DF75 28 4D          	JR	Z,SCRCL
DF77 F5             	PUSH	AF
DF78 CD A2 DF       	CALL	UPSUB		;kanji
DF7B 3A BC F0       	LD	A,(_WIDTH_MINUS)
DF7E 5F             	LD	E,A
DF7F 16 F7          	LD	D,0F7H
DF81 19             	ADD	HL,DE
DF82 D5             	PUSH	DE
DF83 CD A2 DF       	CALL	UPSUB		;Text
DF86 D1             	POP	DE
DF87 19             	ADD	HL,DE
DF88 CD A2 DF       	CALL	UPSUB		;Color
DF8B CB E4          	SET	4,H
DF8D F1             	POP	AF
DF8E 3D             	DEC	A
DF8F 18 E3          	JR	SCRUP1
DF91                
DF91                SETDMA:
DF91 01 87 1F       	LD	BC,01F87H
DF94                SDMA:
DF94 04             	INC	B
DF95 ED A3          	OUTI
DF97 3D             	DEC	A
DF98 20 FA          	JR	NZ,SDMA
DF9A C9             	RET
DF9B                
DF9B                SCRDMAD:
DF9B C3             	DB	0C3H		;WR6 リセット
DF9C 9A             	DB	09AH		;WR5 ストップ WAIT READY:HIGH
DF9D 65             	DB	065H		;WR0 ブロック長(LH)
DF9E 4F 00          	DW	79
DFA0 1C             	DB	01CH		;WR1 ポートAインクリメント I/O
DFA1 18             	DB	018H		;WR0 ポートAアドレス(LH)
DFA2                
DFA2                UPSUB:
DFA2 3A B1 F0       	LD	A,(_WIDTH)
DFA5 5F             	LD	E,A
DFA6 16 00          	LD	D,0
DFA8 3E CD          	LD	A,0CDH		;WR4 バースト ポートB開始アドレス(LH)
DFAA ED 79          	OUT	(C),A
DFAC ED 69          	OUT	(C),L		;SOURCE
DFAE ED 61          	OUT	(C),H
DFB0 19             	ADD	HL,DE
DFB1 3E 1D          	LD	A,01DH		;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
DFB3 ED 79          	OUT	(C),A
DFB5 ED 69          	OUT	(C),L		;DEST
DFB7 ED 61          	OUT	(C),H
DFB9                GO_DMA:
DFB9 3E CF          	LD	A,0CFH
DFBB ED 79          	OUT	(C),A		;WR6 ロード
DFBD 3E B3          	LD	A,0B3H
DFBF ED 79          	OUT	(C),A		;WR6 強制RDY
DFC1 ED 49          	OUT	(C),C		;WR6 イネーブル
DFC3 C9             	RET
DFC4                
DFC4                SCRCL:
DFC4 44             	LD	B,H
DFC5 4D             	LD	C,L
DFC6 2A B1 F0       	LD	HL,(_WIDTH)
DFC9 CD 2E DE       	CALL	LINECL
DFCC D1             	POP	DE
DFCD C1             	POP	BC
DFCE C9             	RET
DFCF                
DFCF                SCRN:
DFCF D5             	PUSH	DE
DFD0 ED 58          	IN	E,(C)		;Text
DFD2 3A 18 00       	LD	A,(00018H)
DFD5 3C             	INC	A
DFD6 28 1E          	JR	Z,SCRN2
DFD8 CB D8          	SET	3,B
DFDA ED 50          	IN	D,(C)		;Kanji
DFDC 28 16          	JR	Z,SCRN1
DFDE AF             	XOR	A
DFDF C5             	PUSH	BC
DFE0 01 37 30       	LD	BC,03037H	;VRMJIS
DFE3 DF             	RST	018H
DFE4 01 52 2F       	LD	BC,02F52H	;JISSFT
DFE7 DF             	RST	018H
DFE8 C1             	POP	BC
DFE9 ED 78          	IN	A,(C)
DFEB CB 98          	RES	3,B
DFED E6 40          	AND	040H
DFEF 20 05          	JR	NZ,SCRN2
DFF1 7A             	LD	A,D
DFF2 D1             	POP	DE
DFF3 C9             	RET
DFF4                SCRN1:
DFF4 CB 98          	RES	3,B
DFF6                SCRN2:
DFF6 7B             	LD	A,E
DFF7 D1             	POP	DE
DFF8 C9             	RET
DFF9                SCRNE:
DFF9                POS:
DFF9 2A 8E F0       	LD	HL,(_TXADR)
DFFC C5             	PUSH	BC
DFFD ED 4B BC F0    	LD	BC,(_WIDTH_MINUS)
E001 AF             	XOR	A
E002                POS1:
E002 09             	ADD	HL,BC
E003 3C             	INC	A
E004 38 FC          	JR	C,POS1
E006 ED 42          	SBC	HL,BC
E008 3D             	DEC	A
E009 67             	LD	H,A
E00A C1             	POP	BC
E00B A7             	AND	A
E00C C9             	RET
E00D                
E00D                GETL:
E00D CD D3 F0       	CALL	_POS
E010 E5             	PUSH	HL
E011 3E CD          	LD	A,0CDH		;CALL ????
E013 32 2B DD       	LD	(INSFLG),A
E016                GETL1:
E016 CD D2 DB       	CALL	_SYS08
E019 FE 09          	CP	9
E01B 20 08          	JR	NZ,GETL1V
E01D 21 20 FF       	LD	HL,KBUF
E020 CD 70 D8       	CALL	MSX
E023 18 F1          	JR	GETL1
E025                GETL1V:
E025 5F             	LD	E,A
E026 CD CD F0       	CALL	_PRINT
E029                
E029 7B             	LD	A,E
E02A FE 0D          	CP	00DH
E02C 20 E8          	JR	NZ,GETL1
E02E 3E 01          	LD	A,1		;LD BC,????
E030 32 2B DD       	LD	(INSFLG),A
E033 11 20 FF       	LD	DE,KBUF
E036 3A B1 F0       	LD	A,(_WIDTH)
E039 47             	LD	B,A
E03A CD D3 D5       	CALL	ZERO_MEMORY_DE
E03D                
E03D D1             	POP	DE
E03E CD D3 F0       	CALL	_POS
E041 6B             	LD	L,E
E042 3A B1 F0       	LD	A,(_WIDTH)
E045 95             	SUB	L
E046 57             	LD	D,A
E047 CD 70 DE       	CALL	LOC1
E04A 4D             	LD	C,L
E04B 7C             	LD	A,H
E04C F6 30          	OR	030H
E04E 47             	LD	B,A
E04F 5A             	LD	E,D
E050 21 20 FF       	LD	HL,KBUF
E053                GETL2:
E053 CD D0 F0       	CALL	_SCRN
E056 03             	INC	BC
E057 77             	LD	(HL),A
E058 23             	INC	HL
E059 1D             	DEC	E
E05A 20 F7          	JR	NZ,GETL2
E05C                GETL3:
E05C 2B             	DEC	HL
E05D 7E             	LD	A,(HL)
E05E FE 21          	CP	021H
E060 D0             	RET	NC
E061 36 00          	LD	(HL),0
E063 15             	DEC	D
E064 20 F6          	JR	NZ,GETL3
E066 C9             	RET
E067                
E067                INKEY:
E067 FB             	EI
E068 E5             	PUSH	HL
E069 2A 90 F0       	LD	HL,(_KEYPS)
E06C 7C             	LD	A,H
E06D AD             	XOR	L
E06E 28 0B          	JR	Z,INKEY1
E070 7C             	LD	A,H
E071 3C             	INC	A
E072 E6 1F          	AND	01FH
E074 32 91 F0       	LD	(_KEYPS+1),A
E077 6F             	LD	L,A
E078 26 FF          	LD	H,KEYBF/256
E07A 7E             	LD	A,(HL)
E07B                INKEY1:
E07B E1             	POP	HL
E07C B7             	OR	A
E07D C9             	RET
E07E                
E07E 00 00 0F 49    AT_RS	EQU	SCR1-AT_SCR1
E07E                	INCLUDE	"LDFILE.ASM"
E07E                
E07E                ;	LSX-Dodgers FILE
E07E                
E07E                FILEC:
E07E CD 89 E0       	CALL	FILE
E081                FILEC2:
E081 3A 15 F0       	LD	A,(FDRV+1)
E084 FE 20          	CP	020H
E086 C8             	RET	Z
E087 18 39          	JR	SETDIR1
E089                
E089                FILE:
E089 AF             	XOR	A
E08A 32 14 F0       	LD	(FDRV),A
E08D 67             	LD	H,A
E08E 6F             	LD	L,A
E08F 22 22 F0       	LD	(FDRV+14),HL
E092 CD 60 E1       	CALL	SPCUT
E095 CD 45 E1       	CALL	CCHK3
E098 28 12          	JR	Z,DEVI1
E09A 13             	INC	DE
E09B 1A             	LD	A,(DE)
E09C 1B             	DEC	DE
E09D FE 3A          	CP	':'
E09F 20 0B          	JR	NZ,DEVI1
E0A1 1A             	LD	A,(DE)		;DRIVE
E0A2 CD 95 E3       	CALL	CAP
E0A5 D6 40          	SUB	'@'
E0A7 13             	INC	DE
E0A8 13             	INC	DE
E0A9 32 14 F0       	LD	(FDRV),A
E0AC                DEVI1:
E0AC 1A             	LD	A,(DE)
E0AD D6 5C          	SUB	05CH		;\
E0AF 20 09          	JR	NZ,NOROOT
E0B1 6F             	LD	L,A		;A=0でH=0のはずなのでHL=0
E0B2 22 2E F0       	LD	(FDRV+26),HL
E0B5 2C             	INC	L
E0B6 22 22 F0       	LD	(FDRV+14),HL
E0B9 13             	INC	DE
E0BA                NOROOT:
E0BA                
E0BA                SETDIR:
E0BA CD E6 E0       	CALL	FILED
E0BD 1A             	LD	A,(DE)
E0BE FE 5C          	CP	05CH		;\
E0C0 C0             	RET	NZ
E0C1 13             	INC	DE
E0C2                SETDIR1:
E0C2 3E 10          	LD	A,010H		;Directory
E0C4 32 21 F0       	LD	(FDRV+13),A
E0C7 D5             	PUSH	DE
E0C8 11 14 F0       	LD	DE,FDRV
E0CB 2A 1E F1       	LD	HL,(STABLE+2*00FH)
E0CE CD 0F 00       	CALL	JP_HL
E0D1 D1             	POP	DE
E0D2 B7             	OR	A
E0D3 C0             	RET	NZ
E0D4                
E0D4 3A 21 F0       	LD	A,(FDRV+13)
E0D7 CB 67          	BIT	4,A
E0D9 C8             	RET	Z
E0DA                
E0DA CD 2D E1       	CALL	FILEI
E0DD 2A 2E F0       	LD	HL,(FDRV+26)
E0E0 23             	INC	HL
E0E1 22 22 F0       	LD	(FDRV+14),HL
E0E4 18 D4          	JR	SETDIR
E0E6                
E0E6                FILED:
E0E6 CD 2D E1       	CALL	FILEI
E0E9 21 15 F0       	LD	HL,FNAME
E0EC                
E0EC 06 08          	LD	B,8
E0EE                FILE2:
E0EE CD 3A E1       	CALL	CCHKF
E0F1 C8             	RET	Z
E0F2 FE 2A          	CP	'*'
E0F4 28 2E          	JR	Z,FILE9
E0F6 FE 2E          	CP	'.'
E0F8 28 0C          	JR	Z,FILE4
E0FA 77             	LD	(HL),A
E0FB 23             	INC	HL
E0FC 10 F0          	DJNZ	FILE2
E0FE                
E0FE                FILE3:
E0FE CD 3A E1       	CALL	CCHKF
E101 C8             	RET	Z
E102 FE 2E          	CP	'.'
E104 20 F8          	JR	NZ,FILE3
E106                
E106                FILE4:
E106 21 1D F0       	LD	HL,FNAME+8
E109 06 03          	LD	B,3
E10B                
E10B                FILE4L:
E10B CD 3A E1       	CALL	CCHKF
E10E C8             	RET	Z
E10F FE 2E          	CP	'.'
E111 20 08          	JR	NZ,FILE12
E113 32 15 F0       	LD	(FNAME),A	;Parent directory(..)
E116 32 16 F0       	LD	(FNAME+1),A
E119 3E 20          	LD	A,020H
E11B                FILE12:
E11B FE 2A          	CP	'*'
E11D 28 0A          	JR	Z,FILE10
E11F 77             	LD	(HL),A
E120 23             	INC	HL
E121 10 E8          	DJNZ	FILE4L
E123 C9             	RET
E124                
E124                FILE9:				;名前の*処理、名前の残りを?で埋める
E124 CD 29 E1       	CALL	FILE10
E127 18 D5          	JR	FILE3
E129                
E129                FILE10:
E129 3E 3F          	LD	A,'?'
E12B 18 08          	JR	FILL_MEMORY
E12D                FILEI:				;名前＋拡張子をスペースで初期化
E12D 3E 20          	LD	A,020H
E12F 01 00 0B       	LD	BC,11*256	;C=0にしておく
E132 21 15 F0       	LD	HL,FNAME
E135                FILL_MEMORY:			;HLからBバイトAで埋める
E135 77             	LD	(HL),A
E136 23             	INC	HL
E137 10 FC          	DJNZ	FILL_MEMORY
E139 C9             	RET
E13A                
E13A                CCHKF:
E13A 1A             	LD	A,(DE)
E13B CD 42 E1       	CALL	CCHK2
E13E C8             	RET	Z
E13F C3 AD E4       	JP	FKAN
E142                
E142                CCHK2:
E142 0C             	INC	C
E143 0D             	DEC	C
E144 C0             	RET	NZ
E145                CCHK3:				;ZF=1 で使えない文字
E145 FE 2B          	CP	'+'
E147 C8             	RET	Z
E148 FE 2C          	CP	','
E14A C8             	RET	Z
E14B FE 2F          	CP	'/'
E14D C8             	RET	Z
E14E FE 3A          	CP	':'
E150 C8             	RET	Z
E151 FE 3B          	CP	';'
E153 C8             	RET	Z
E154 FE 3D          	CP	'='
E156 C8             	RET	Z
E157 FE 5C          	CP	05CH	;\
E159 C8             	RET	Z
E15A FE 20          	CP	020H
E15C D0             	RET	NC
E15D BF             	CP	A		;Z=1
E15E C9             	RET
E15F                
E15F                SS1:
E15F 13             	INC	DE
E160                SPCUT:				;スペースをカット
E160 1A             	LD	A,(DE)
E161 FE 20          	CP	020H
E163 28 FA          	JR	Z,SS1
E165 C9             	RET
E166                
E166                SETDRVF:
E166 11 14 F0       	LD	DE,FDRV
E169                SETDRV0:
E169 CD 72 E1       	CALL	SETDRV
E16C FD E1          	POP	IY
E16E C1             	POP	BC
E16F D1             	POP	DE
E170 E1             	POP	HL
E171 C9             	RET
E172                
E172                SETDRV:
E172 E3             	EX	(SP),HL		;HL=RETRN ADDRESS
E173 D5             	PUSH	DE		;PUSH HL/DE/BC/IY
E174 C5             	PUSH	BC
E175 1A             	LD	A,(DE)
E176 D5             	PUSH	DE
E177 FD E3          	EX	(SP),IY
E179                
E179 CD 85 E1       	CALL	GETDRV
E17C 3C             	INC	A
E17D FD 77 00       	LD	(IY+0),A	;(FCB)ドライブ番号
E180 3D             	DEC	A
E181 CD D9 F0       	CALL	_CHGDRV
E184                
E184 E9             	JP	(HL)
E185                
E185                GETDRV:
E185 E6 7F          	AND	07FH
E187 D6 01          	SUB	001H
E189 30 03          	JR	NC,GETDRV1
E18B 3A 87 F0       	LD	A,(_DVSW)	;Current Drive
E18E                GETDRV1:
E18E 32 88 F0       	LD	(_DRV),A
E191 C9             	RET
E192                
E192                SOPENX:
E192 11 39 F0       	LD	DE,SFILE
E195 1A             	LD	A,(DE)
E196 FD BE 00       	CP	(IY+0)		;(FCB)ドライブ番号
E199 20 24          	JR	NZ,SOPEN
E19B 13             	INC	DE
E19C FD E5          	PUSH	IY
E19E E1             	POP	HL
E19F 23             	INC	HL
E1A0 CD 2D E3       	CALL	CPFILE
E1A3 20 1A          	JR	NZ,SOPEN
E1A5                
E1A5 2A F4 F1       	LD	HL,(SCDIR)
E1A8 FD 75 0E       	LD	(IY+14),L	;(FCB)アクセスするディレクトリのクラスタ番号+1
E1AB FD 74 0F       	LD	(IY+15),H
E1AE                
E1AE 2A F8 F1       	LD	HL,(SFNDF)	;Direcroty location and Flags
E1B1 22 9F F0       	LD	(_FILEN),HL
E1B4                
E1B4 ED 5B F6 F1    	LD	DE,(SFBPS)
E1B8 21 39 F0       	LD	HL,SFILE
E1BB 36 FF          	LD	(HL),0FFH
E1BD 23             	INC	HL
E1BE C9             	RET
E1BF                SOPEN:
E1BF 21 D5 E2       	LD	HL,FILESE
E1C2                SOPENC:
E1C2 22 FB E1       	LD	(OPENPAT+1),HL
E1C5                
E1C5 CD E2 F0       	CALL	_RDFATX		;Detect Media
E1C8 38 56          	JR	C,RDDERR
E1CA                
E1CA AF             	XOR	A
E1CB 32 9F F0       	LD	(_FILEN),A
E1CE CD DA E3       	CALL	LDDIRX1		;A=0で呼び出す
E1D1 28 18          	JR	Z,SDIRX1
E1D3                
E1D3 CD C6 E2       	CALL	READ_DIR	;Sub Directory
E1D6 38 08          	JR	C,SDIRX0
E1D8 2A 7E F1       	LD	HL,(_DTBUF)
E1DB 7E             	LD	A,(HL)
E1DC FE 2E          	CP	'.'
E1DE 28 0F          	JR	Z,SOPEN1
E1E0                SDIRX0:
E1E0 AF             	XOR	A
E1E1 32 A0 F0       	LD	(_DIRF),A
E1E4 FD 36 0E 01    	LD	(IY+14),1	;(FCB)レコードサイズ
E1E8 FD 77 0F       	LD	(IY+15),A
E1EB                SDIRX1:
E1EB ED 5B FC F1    	LD	DE,(_DIRPS)	;Root Directory
E1EF                SOPEN1:
E1EF 0E 20          SDECPAT:LD	C,32		;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
E1F1                SOPEN1X:
E1F1 CD C6 E2       	CALL	READ_DIR	;FILE SEARCH
E1F4 38 2A          	JR	C,RDDERR
E1F6 2A 7E F1       	LD	HL,(_DTBUF)
E1F9                SOPEN2:
E1F9 D5             	PUSH	DE
E1FA CD D5 E2       OPENPAT:CALL	FILESE		;(self-modifying code)
E1FD D1             	POP	DE
E1FE 38 6E          	JR	C,SOPENE
E200 28 1B          	JR	Z,SCF_FF_RET
E202                SOPEN3:
E202 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E205 B7             	OR	A
E206 20 0C          	JR	NZ,SOPEN5
E208 13             	INC	DE		;ルートディレクトリ
E209 E5             	PUSH	HL
E20A 21 0C 00       MD_PAT:	LD	HL,12		;(self-modifying code)MAXDIR
E20D ED 52          	SBC	HL,DE		;CF=0 なので SUB HL,DE
E20F E1             	POP	HL
E210 20 DD          	JR	NZ,SOPEN1
E212 18 07          	JR	SOPEN6
E214                SOPEN5:
E214 CD EF EA       	CALL	GNCLX		;END DIR
E217 D8             	RET	C
E218 CD 8D E3       	CALL	ENDCL
E21B                SOPEN6:
E21B 38 D2          	JR	C,SOPEN1
E21D                SCF_FF_RET:
E21D 37             	SCF			;CF=1
E21E 9F             	SBC	A,A		;A=0FFH
E21F C9             	RET
E220                
E220                RDDERR:
E220 BF             	CP	A		;READ ERR CF=1 ZF=1
E221 37             	SCF
E222 C9             	RET
E223                
E223                NOPEN:
E223 21 D5 E2       	LD	HL,FILESE
E226 22 FB E1       	LD	(OPENPAT+1),HL
E229 FD 2A 98 F0    	LD	IY,(_FCB)
E22D CD C0 E4       	CALL	CHKWILDX
E230 30 EB          	JR	NC,SCF_FF_RET
E232 FD 7E 00       	LD	A,(IY+0)	;(FCB)ドライブ番号
E235 3D             	DEC	A
E236 32 88 F0       	LD	(_DRV),A
E239 CD D9 F0       	CALL	_CHGDRV
E23C D8             	RET	C
E23D 2A F8 F1       	LD	HL,(SFNDF)	;Direcroty location and Flags
E240 22 9F F0       	LD	(_FILEN),HL
E243                
E243 CD D5 E3       	CALL	LDDIRX
E246 ED 5B 9A F0    	LD	DE,(_FBPS)
E24A CD C6 E2       	CALL	READ_DIR
E24D 38 D1          	JR	C,RDDERR
E24F 3A 9E F0       	LD	A,(_FBCNT)
E252 3D             	DEC	A
E253 28 AD          	JR	Z,SOPEN3
E255                NOPEN2:
E255 2A 9C F0       	LD	HL,(_FBAD)
E258 01 20 00       	LD	BC,020H
E25B 09             	ADD	HL,BC
E25C 4F             	LD	C,A
E25D 18 9A          	JR	SOPEN2
E25F                
E25F                SOPENE2:
E25F 22 9C F0       	LD	(_FBAD),HL
E262 79             	LD	A,C
E263 32 9E F0       	LD	(_FBCNT),A
E266 ED 53 9A F0    	LD	(_FBPS),DE
E26A FD 22 98 F0    	LD	(_FCB),IY
E26E                SOPENE:
E26E AF             	XOR	A
E26F C9             	RET
E270                
E270                COPEN:
E270 FD 36 0D 20    	LD	(IY+13),020H	;(FCB)属性(アトリビュート)
E274                
E274 21 F2 E2       	LD	HL,NEXTSE
E277 CD C2 E1       	CALL	SOPENC
E27A D0             	RET	NC
E27B C8             	RET	Z
E27C 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E27F B7             	OR	A
E280 37             	SCF
E281 C8             	RET	Z		;ルートディレクトリ
E282 06 01          	LD	B,1
E284 CD 1F E5       	CALL	WRDF
E287 D8             	RET	C
E288 ED 5B FE F1    	LD	DE,(_CLPS)
E28C D5             	PUSH	DE
E28D CD 56 E3       	CALL	DCPAT
E290 CD 7A E9       	CALL	DRDNX
E293 2A 7E F1       	LD	HL,(_DTBUF)	;ディレクトリエントリを0クリア
E296 3A 84 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E299 47             	LD	B,A
E29A AF             	XOR	A
E29B 4F             	LD	C,A
E29C                COPENCL:
E29C 77             	LD	(HL),A
E29D ED A1          	CPI			;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
E29F EA 9C E2       	JP	PE,COPENCL
E2A2                
E2A2 3A 74 E3       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ数
E2A5 3D             	DEC	A
E2A6 28 19          	JR	Z,COPENE
E2A8 3E 01          	LD	A,1		;1セクタ辺りのセクタ数が2以上の場合
E2AA 32 E7 EA       	LD	(_SECPS+1),A
E2AD D1             	POP	DE		;DE=(_CLPS)
E2AE D5             	PUSH	DE
E2AF                COPEN1:
E2AF D5             	PUSH	DE		;データバッファに入らないセクタもゼロクリア
E2B0 C5             	PUSH	BC
E2B1 2A 7E F1       	LD	HL,(_DTBUF)
E2B4 CD 70 E3       	CALL	CLUSTX
E2B7 CD 7F EC       	CALL	DWT24
E2BA C1             	POP	BC
E2BB D1             	POP	DE
E2BC CD E6 EA       	CALL	NEXTX
E2BF 20 EE          	JR	NZ,COPEN1
E2C1                COPENE:
E2C1 2A 7E F1       	LD	HL,(_DTBUF)
E2C4 D1             	POP	DE
E2C5 C9             	RET
E2C6                
E2C6                READ_DIR:
E2C6 ED 53 FE F1    	LD	(_CLPS),DE
E2CA C5             	PUSH	BC
E2CB D5             	PUSH	DE
E2CC CD 56 E3       	CALL	DCPAT
E2CF CD 5A E9       	CALL	DRDX
E2D2 D1             	POP	DE
E2D3 C1             	POP	BC
E2D4 C9             	RET
E2D5                
E2D5                FILESE:
E2D5 7E             	LD	A,(HL)
E2D6 B7             	OR	A
E2D7 C8             	RET	Z		;END:ZF=1 CF=0
E2D8 FE E5          	CP	0E5H
E2DA 28 0E          	JR	Z,FILESE1
E2DC FD E5          	PUSH	IY
E2DE D1             	POP	DE
E2DF 13             	INC	DE
E2E0 E5             	PUSH	HL
E2E1 CD 2D E3       	CALL	CPFILE
E2E4 CC 4E E3       	CALL	Z,CPFILE2
E2E7 E1             	POP	HL
E2E8 37             	SCF
E2E9 C8             	RET	Z		;!!!:(ZF=1) CF=1
E2EA                FILESE1:
E2EA CD 01 E3       	CALL	FNEXT
E2ED 20 E6          	JR	NZ,FILESE
E2EF                ZF0_CF0_AFF_RET:
E2EF F6 FF          	OR	0FFH		;ZF=0 CF=0
E2F1 C9             	RET
E2F2                
E2F2                NEXTSE:
E2F2 7E             	LD	A,(HL)
E2F3 B7             	OR	A
E2F4 37             	SCF
E2F5 C8             	RET	Z		;!!!:ZF=1 CF=1
E2F6 FE E5          	CP	0E5H
E2F8 37             	SCF
E2F9 C8             	RET	Z		;!!!:(ZF=1) CF=1
E2FA CD 01 E3       	CALL	FNEXT
E2FD 20 F3          	JR	NZ,NEXTSE
E2FF 18 EE          	JR	ZF0_CF0_AFF_RET
E301                
E301                FNEXT:
E301 E5             	PUSH	HL
E302 21 9F F0       	LD	HL,_FILEN
E305 34             	INC	(HL)
E306 E1             	POP	HL
E307 11 20 00       	LD	DE,020H
E30A 19             	ADD	HL,DE
E30B 0D             	DEC	C
E30C C9             	RET
E30D                
E30D                CPNAME:
E30D C5             	PUSH	BC
E30E D5             	PUSH	DE
E30F E5             	PUSH	HL
E310 CD 27 E3       	CALL	CPFILE4
E313 E1             	POP	HL
E314 23             	INC	HL
E315 23             	INC	HL
E316 23             	INC	HL
E317 23             	INC	HL
E318 D1             	POP	DE
E319 C1             	POP	BC
E31A 20 05          	JR	NZ,CPNAME1
E31C 7E             	LD	A,(HL)
E31D 23             	INC	HL
E31E 66             	LD	H,(HL)
E31F 6F             	LD	L,A
E320 C9             	RET
E321                CPNAME1:
E321 23             	INC	HL
E322 23             	INC	HL
E323 10 E8          	DJNZ	CPNAME
E325 37             	SCF
E326 C9             	RET
E327                
E327                CPFILE4:
E327 C5             	PUSH	BC
E328 01 00 04       	LD	BC,00400H
E32B 18 04          	JR	CPSTR1
E32D                CPFILE:
E32D C5             	PUSH	BC
E32E 01 00 0B       	LD	BC,00B00H
E331                CPSTR1:
E331 1A             	LD	A,(DE)
E332 FE 3F          	CP	'?'		;Wild card
E334 28 12          	JR	Z,CPSTR2
E336 7E             	LD	A,(HL)
E337 CD A6 E4       	CALL	FKANC
E33A E5             	PUSH	HL
E33B 67             	LD	H,A
E33C 1A             	LD	A,(DE)
E33D CB 01          	RLC	C
E33F CD A6 E4       	CALL	FKANC
E342 CB 09          	RRC	C
E344 BC             	CP	H		;CP (HL),(DE)
E345 E1             	POP	HL
E346 20 04          	JR	NZ,CPSTR3
E348                CPSTR2:
E348 13             	INC	DE
E349 23             	INC	HL
E34A 10 E5          	DJNZ	CPSTR1
E34C                CPSTR3:
E34C C1             	POP	BC
E34D C9             	RET
E34E                
E34E                CPFILE2:
E34E FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E351 F6 E1          	OR	0E1H
E353 2F             	CPL
E354 A6             	AND	(HL)
E355 C9             	RET
E356                
E356                DCPAT:
E356 0E 00          	LD	C,0
E358 2A 7E F1       	LD	HL,(_DTBUF)
E35B 3A A0 F0       	LD	A,(_DIRF)	;ディレクトリか判別
E35E B7             	OR	A
E35F C8             	RET	Z		;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
E360 3A 74 E3       	LD	A,(SPCPAT+1)
E363 4F             	LD	C,A
E364 3A E7 EA       	LD	A,(_SECPS+1)
E367 B9             	CP	C
E368 38 01          	JR	C,DC1
E36A AF             	XOR	A
E36B                DC1:
E36B F6 80          	OR	080H
E36D 32 A0 F0       	LD	(_DIRF),A	;bit0-6:セクタインデックス
E370                CLUSTX:
E370 E5             	PUSH	HL
E371 EB             	EX	DE,HL
E372 AF             	XOR	A
E373 0E 01          SPCPAT:	LD	C,1		;自己書き換え（1クラスタの論理セクタ数）
E375                L_CLDBL:
E375 CB 19          	RR	C		;->CF
E377 38 04          	JR	C,E_CLDBL
E379 29             	ADD	HL,HL		;*2
E37A 8F             	ADC	A,A
E37B 18 F8          	JR	L_CLDBL
E37D                E_CLDBL:
E37D 4F             	LD	C,A
E37E 3A E7 EA       	LD	A,(_SECPS+1)
E381 B5             	OR	L
E382 6F             	LD	L,A
E383 11 08 00       CLSPAT:	LD	DE,8	;+8 (2D)  !ADDCL (self-modifying code)
E386 AF             	XOR	A
E387 19             	ADD	HL,DE	;データ格納領域の先頭論理セクタ番号
E388 89             	ADC	A,C
E389 4F             	LD	C,A
E38A EB             	EX	DE,HL
E38B E1             	POP	HL
E38C C9             	RET
E38D                
E38D                ENDCL:
E38D 7A             	LD	A,D	;END CLUSTER
E38E FE 01          CLPAT1:	CP	1	;164=356	(self-modifying code)
E390 C0             	RET	NZ
E391 7B             	LD	A,E
E392 FE 64          CLPAT2:	CP	064H	;		(self-modifying code)
E394 C9             	RET
E395                
E395                CAP:
E395 FE 61          	CP	'a'
E397 D8             	RET	C
E398 FE 7B          	CP	'z'+1
E39A D0             	RET	NC
E39B D6 20          	SUB	020H
E39D C9             	RET
E39E                CAP2:
E39E CD 95 E3       	CALL	CAP
E3A1                CAP3:
E3A1 CD AA E3       	CALL	CAP4
E3A4 FE 21          	CP	021H
E3A6 D0             	RET	NC
E3A7 3E A0          	LD	A,0A0H
E3A9 C9             	RET
E3AA                CAP4:
E3AA FE 05          	CP	5
E3AC C0             	RET	NZ
E3AD 3E E5          	LD	A,0E5H
E3AF C9             	RET
E3B0                
E3B0                CHDIR:
E3B0 CD AD ED       	CALL	GETDPBD
E3B3 38 1D          	JR	C,CHDIR2
E3B5 DD 75 1A       	LD	(IX+01AH),L		;_SDIR_
E3B8 DD 74 1B       	LD	(IX+01BH),H		;_SDIR_+1
E3BB 18 15          	JR	CHDIR2		;POP_IX_RET
E3BD                
E3BD                LDDIR:
E3BD CD AD ED       	CALL	GETDPBD
E3C0 DD 5E 1A       	LD	E,(IX+01AH)		;_SDIR_
E3C3 DD 56 1B       	LD	D,(IX+01BH)		;_SDIR_+1
E3C6 13             	INC	DE
E3C7 FD 73 0E       	LD	(IY+14),E	;(FCB)アクセスするディレクトリのクラスタ番号+1
E3CA FD 72 0F       	LD	(IY+15),D
E3CD 1B             	DEC	DE
E3CE AF             	XOR	A
E3CF 32 A0 F0       	LD	(_DIRF),A
E3D2                CHDIR2:
E3D2 DD E1          	POP	IX
E3D4 C9             	RET
E3D5                
E3D5                LDDIRX:
E3D5 3A A0 F0       	LD	A,(_DIRF)	;(FCB)アクセスするディレクトリのセクタインデックス
E3D8 E6 7F          	AND	07FH
E3DA                LDDIRX1:
E3DA 32 E7 EA       	LD	(_SECPS+1),A
E3DD FD 5E 0E       	LD	E,(IY+14)	;(FCB)アクセスするディレクトリのクラスタ番号+1
E3E0 FD 56 0F       	LD	D,(IY+15)
E3E3 1B             	DEC	DE
E3E4 CD 8D E3       	CALL	ENDCL
E3E7 D4 BD E3       	CALL	NC,LDDIR
E3EA                LDDIRS:
E3EA 7A             	LD	A,D
E3EB B3             	OR	E
E3EC 32 A0 F0       	LD	(_DIRF),A	;ディレクトリか判別
E3EF C9             	RET
E3F0                
E3F0                KILL:
E3F0 CD C0 E4       	CALL	CHKWILDX
E3F3 38 34          	JR	C,KILLW
E3F5 CD 92 E1       	CALL	SOPENX
E3F8                KILLS:
E3F8 3E 1F          	LD	A,01FH
E3FA D4 3C E4       	CALL	NC,CHKATT
E3FD D8             	RET	C
E3FE                KILLSX:
E3FE 36 E5          	LD	(HL),0E5H	;DIR
E400 CD 9A E4       	CALL	WTDB
E403 11 1A 00       	LD	DE,01AH
E406 19             	ADD	HL,DE
E407 5E             	LD	E,(HL)
E408 23             	INC	HL
E409 56             	LD	D,(HL)
E40A                KILLS1:
E40A CD 8D E3       	CALL	ENDCL
E40D D0             	RET	NC		;CF=0
E40E 21 FE FF       	LD	HL,0-2
E411 19             	ADD	HL,DE
E412 D0             	RET	NC		;DE= 0 or 1
E413 D5             	PUSH	DE
E414 CD F7 F0       	CALL	_GNCL
E417 ED 53 FE F1    	LD	(_CLPS),DE
E41B D1             	POP	DE
E41C 21 00 00       	LD	HL,0
E41F D4 FA F0       	CALL	NC,_SNCL
E422 D8             	RET	C
E423 ED 5B FE F1    	LD	DE,(_CLPS)	;FAT
E427 18 E1          	JR	KILLS1
E429                
E429                KILLW:
E429 CD BF E1       	CALL	SOPEN
E42C                KILLW1:
E42C 38 0B          	JR	C,KILLW2
E42E CD 5F E2       	CALL	SOPENE2
E431 CD F8 E3       	CALL	KILLS
E434 CD 23 E2       	CALL	NOPEN
E437 18 F3          	JR	KILLW1
E439                KILLW2:
E439 C8             	RET	Z
E43A 3F             	CCF
E43B C9             	RET
E43C                
E43C                CHKATT:
E43C E5             	PUSH	HL
E43D 11 0B 00       	LD	DE,00BH
E440 19             	ADD	HL,DE
E441 A6             	AND	(HL)
E442 E1             	POP	HL
E443 C8             	RET	Z
E444 37             	SCF
E445 C9             	RET
E446                
E446                NAME:
E446 CD C0 E4       	CALL	CHKWILDX
E449 D8             	RET	C
E44A 11 04 00       	LD	DE,4
E44D 19             	ADD	HL,DE
E44E 22 66 E4       	LD	(NAMEP+2),HL
E451 23             	INC	HL
E452 CD C4 E4       	CALL	CHKWILD
E455 D8             	RET	C
E456                
E456 CD 92 E1       	CALL	SOPENX
E459 3E 0F          	LD	A,00FH
E45B D4 3C E4       	CALL	NC,CHKATT
E45E D8             	RET	C
E45F                
E45F FD 7E 00       	LD	A,(IY+0)
E462 FD E5          	PUSH	IY
E464 FD 21 00 00    NAMEP:	LD	IY,0		;自己書き換え
E468 FD 77 00       	LD	(IY+0),A
E46B CD 92 E1       	CALL	SOPENX
E46E FD E3          	EX	(SP),IY
E470 3F             	CCF
E471 D4 BF E1       	CALL	NC,SOPEN
E474 EB             	EX	DE,HL
E475 E1             	POP	HL
E476 D8             	RET	C
E477                
E477                SETNAME:
E477 01 00 0B       	LD	BC,11*256
E47A 23             	INC	HL
E47B 7E             	LD	A,(HL)
E47C FE E5          	CP	0E5H
E47E 20 04          	JR	NZ,SNAME1
E480 3E 05          	LD	A,5
E482 18 0E          	JR	SNAME3
E484                SNAME1:
E484 7E             	LD	A,(HL)
E485 0C             	INC	C
E486 0D             	DEC	C
E487 20 09          	JR	NZ,SNAME3
E489 CD 95 E3       	CALL	CAP
E48C FE A0          	CP	0A0H
E48E 20 02          	JR	NZ,SNAME3
E490 3E 20          	LD	A,020H
E492                SNAME3:
E492 12             	LD	(DE),A
E493 7E             	LD	A,(HL)
E494 23             	INC	HL
E495 CD AD E4       	CALL	FKAN
E498 10 EA          	DJNZ	SNAME1
E49A                WTDB:
E49A 3E FF          	LD	A,0FFH
E49C 32 39 F0       	LD	(SFILE),A
E49F                SWTDBF:
E49F 3E 01          	LD	A,1
E4A1 32 A4 F0       	LD	(_WTDBF),A
E4A4 AF             	XOR	A
E4A5 C9             	RET
E4A6                
E4A6                FKANC:
E4A6 CB 41          	BIT	0,C
E4A8 CC 9E E3       	CALL	Z,CAP2
E4AB 18 01          	JR	FKANX
E4AD                FKAN:			;漢字チェック
E4AD 13             	INC	DE
E4AE                FKANX:
E4AE CB 41          	BIT	0,C
E4B0 CB 81          	RES	0,C
E4B2 C0             	RET	NZ
E4B3 FE 80          	CP	080H
E4B5 D8             	RET	C
E4B6 FE A0          	CP	0A0H
E4B8 38 03          	JR	C,FKAN1
E4BA FE E0          	CP	0E0H
E4BC D8             	RET	C
E4BD                FKAN1:
E4BD 0C             	INC	C
E4BE A7             	AND	A
E4BF C9             	RET
E4C0                
E4C0                CHKWILDX:
E4C0 FD E5          	PUSH	IY
E4C2 E1             	POP	HL
E4C3 23             	INC	HL
E4C4                CHKWILD:
E4C4 06 0B          	LD	B,11
E4C6 3E 3F          	LD	A,'?'
E4C8                CHKWIL1:
E4C8 BE             	CP	(HL)
E4C9 23             	INC	HL
E4CA 37             	SCF
E4CB C8             	RET	Z
E4CC 10 FA          	DJNZ	CHKWIL1
E4CE AF             	XOR	A
E4CF C9             	RET
E4D0                
E4D0                SDIRENT:		;IY=FCB HL=DIR
E4D0 D5             	PUSH	DE
E4D1 E5             	PUSH	HL
E4D2 FD E5          	PUSH	IY
E4D4 D1             	POP	DE
E4D5 EB             	EX	DE,HL
E4D6 CD 77 E4       	CALL	SETNAME
E4D9                ;				Attribute
E4D9 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E4DC 12             	LD	(DE),A
E4DD 13             	INC	DE
E4DE                ;				Reserved
E4DE AF             	XOR	A
E4DF 06 0A          	LD	B,10
E4E1                SDE1:
E4E1 12             	LD	(DE),A
E4E2 13             	INC	DE
E4E3 10 FC          	DJNZ	SDE1
E4E5                					;(FCB)更新時刻
E4E5 21 EA F1       	LD	HL,SDDATA		;(FCB)更新年月日
E4E8 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
E4EA                SDLOOP:					;(FCB)ファイルのサイズ(バイト単位)
E4EA 7E             	LD	A,(HL)
E4EB 23             	INC	HL
E4EC 32 F1 E4       	LD	(SDPAT+2),A
E4EF FD 7E 00       SDPAT:	LD	A,(IY+0)	;LD A,(IY+A)
E4F2 12             	LD	(DE),A
E4F3 13             	INC	DE
E4F4 10 F4          	DJNZ	SDLOOP
E4F6                
E4F6 AF             	XOR	A
E4F7 E1             	POP	HL
E4F8 D1             	POP	DE
E4F9 C9             	RET
E4FA                
E4FA                WOPEN:
E4FA FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E4FD E6 1F          	AND	01FH
E4FF 37             	SCF
E500 C0             	RET	NZ
E501 FD 36 1C FE    	LD	(IY+28),0FEH	;(FCB)オープンモード
E505                TOPEN2:
E505 AF             	XOR	A
E506                TOPEN:				;Initializes the time stamp
E506 FD 36 17 FF    	LD	(IY+23),0FFH	;(FCB)更新時刻
E50A C9             	RET
E50B                
E50B                WRDFX:
E50B 3A 74 E3       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ
E50E                L_WRFX:
E50E 1F             	RRA			;->CF
E50F 38 06          	JR	C,E_WRFX
E511 CB 39          	SRL	C
E513 CB 1C          	RR	H		;CH=CH/2
E515 18 F7          	JR	L_WRFX
E517                E_WRFX:
E517 41             	LD	B,C
E518 4C             	LD	C,H
E519 03             	INC	BC
E51A 3E 37          	LD	A,037H		;SCF
E51C 32 77 E9       	LD	(DRDN1),A
E51F                
E51F                WRDF:				;BCクラスタ分FATを確保する
E51F 11 02 00       	LD	DE,2
E522 AF             	XOR	A
E523 32 E7 EA       	LD	(_SECPS+1),A
E526                WRDF1:
E526 C5             	PUSH	BC
E527 D5             	PUSH	DE
E528 CD F7 F0       	CALL	_GNCL
E52B 38 1C          	JR	C,WRDF3
E52D 7A             	LD	A,D		;空いているかチェック
E52E B3             	OR	E
E52F 20 2A          	JR	NZ,WRDF4
E531 E1             	POP	HL		;HL=空いているクラスタ
E532 E5             	PUSH	HL
E533 ED 5B FE F1    	LD	DE,(_CLPS)	;DE=元の(_CLPS)
E537 22 FE F1       	LD	(_CLPS),HL
E53A 7A             	LD	A,D		;元の(_CLPS)が 0 か?
E53B B3             	OR	E
E53C 20 08          	JR	NZ,WRDF2
E53E FD 75 1A       	LD	(IY+26),L	;(FCB)ファイルの先頭クラスタ
E541 FD 74 1B       	LD	(IY+27),H	;元が空の場合はFCBにクラスタをセットする
E544 18 03          	JR	WRDF3
E546                WRDF2:
E546 CD FA F0       	CALL	_SNCL
E549                WRDF3:
E549 D1             	POP	DE
E54A C1             	POP	BC
E54B D8             	RET	C
E54C 0B             	DEC	BC
E54D 78             	LD	A,B
E54E B1             	OR	C
E54F 20 0C          	JR	NZ,WRDF5	;ここでループカウンタチェック
E551 ED 5B FE F1    	LD	DE,(_CLPS)
E555 21 FF FF       	LD	HL,0FFFFH	;FATエントリ終了(EOCマーク)
E558 C3 FA F0       	JP	_SNCL
E55B                
E55B                WRDF4:				;DEクラスタが空じゃないので次に移動する
E55B D1             	POP	DE
E55C C1             	POP	BC
E55D                WRDF5:
E55D 13             	INC	DE
E55E CD 8D E3       	CALL	ENDCL
E561 38 C3          	JR	C,WRDF1
E563 37             	SCF
E564 C9             	RET
E565                
E565                RWXR:
E565 3A 84 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E568                L_RWX:
E568 1F             	RRA		;->CF
E569 38 08          	JR	C,E_RWX
E56B CB 38          	SRL	B	;BCH=BCH/2
E56D CB 19          	RR	C	;
E56F CB 1C          	RR	H	;
E571 18 F5          	JR	L_RWX
E573                E_RWX:
E573 FD 5E 1A       	LD	E,(IY+26)	;(FCB)ファイルの先頭クラスタ
E576 FD 56 1B       	LD	D,(IY+27)
E579 AF             	XOR	A
E57A 32 E7 EA       	LD	(_SECPS+1),A
E57D                RWX1:
E57D ED 53 FE F1    	LD	(_CLPS),DE
E581 7A             	LD	A,D
E582 B3             	OR	E
E583 28 13          	JR	Z,SCF_RET	;RET DE==0 => CF=1
E585                
E585 78             	LD	A,B
E586 B1             	OR	C
E587 B4             	OR	H
E588 C8             	RET	Z		;RET BCH==0 => CF=0
E589                
E589 CD EF EA       	CALL	GNCLX
E58C D8             	RET	C
E58D 7C             	LD	A,H		;
E58E 25             	DEC	H		;
E58F B7             	OR	A		;DEC BCH
E590 20 01          	JR	NZ,RWX2		;
E592 0B             	DEC	BC		;
E593                RWX2:
E593 CD 8D E3       	CALL	ENDCL
E596 38 E5          	JR	C,RWX1
E598                SCF_RET:
E598 37             	SCF
E599 C9             	RET
E59A                
E59A                DSKF:
E59A 11 00 00       MAXCLP:	LD	DE,0
E59D 2A AC F0       	LD	HL,(_FAKEFREE)
E5A0 7C             	LD	A,H
E5A1 B5             	OR	L
E5A2 28 03          	JR	Z,DSKF1
E5A4 11 01 00       	LD	DE,1
E5A7                DSKF1:
E5A7 D5             	PUSH	DE
E5A8 CD F7 F0       	CALL	_GNCL
E5AB 38 0C          	JR	C,POPSCF
E5AD 7A             	LD	A,D
E5AE B3             	OR	E
E5AF 20 01          	JR	NZ,DSKF2
E5B1 23             	INC	HL
E5B2                DSKF2:
E5B2 D1             	POP	DE
E5B3 1B             	DEC	DE
E5B4 7A             	LD	A,D
E5B5 B3             	OR	E
E5B6 20 EF          	JR	NZ,DSKF1
E5B8 C9             	RET
E5B9                
E5B9                POPSCF:
E5B9 F1             	POP	AF
E5BA 37             	SCF
E5BB C9             	RET
E5BC                
E5BC                SETTMS:
E5BC FD 7E 17       	LD	A,(IY+23)	;(FCB)ファイルを最後に変更した時刻
E5BF 3C             	INC	A
E5C0 C0             	RET	NZ		;ファイルが更新されていない
E5C1                SETTMSX:			;FCBに日付時刻をセットする
E5C1 CD 70 DC       	CALL	_SYS2C		;(BDOS)時刻の獲得
E5C4                				;H←時  L←分  D←秒
E5C4 CB 25          	SLA	L		;   *2
E5C6 CB 25          	SLA	L		;   *4
E5C8 29             	ADD	HL,HL		;*2 *8
E5C9 29             	ADD	HL,HL		;*4 *16
E5CA 29             	ADD	HL,HL		;*8 *32
E5CB 7A             	LD	A,D
E5CC 0F             	RRCA			;bit.0->7->->->0->C
E5CD E6 1F          	AND	01FH
E5CF B5             	OR	L
E5D0 FD 77 16       	LD	(IY+22),A	;(FCB)ファイルを最後に変更した時刻
E5D3 FD 74 17       	LD	(IY+23),H
E5D6                
E5D6 CD 4D DC       	CALL	_SYS2A		;(BDOS)日付の獲得
E5D9                				;HL←年  D←月  E←日
E5D9 01 44 F8       	LD	BC,0-1980
E5DC 09             	ADD	HL,BC
E5DD 65             	LD	H,L
E5DE                
E5DE 7A             	LD	A,D
E5DF 87             	ADD	A,A		;*2
E5E0 87             	ADD	A,A		;*4
E5E1 87             	ADD	A,A		;*8
E5E2 87             	ADD	A,A		;*16
E5E3 6F             	LD	L,A
E5E4 29             	ADD	HL,HL		;*32
E5E5 7D             	LD	A,L
E5E6 B3             	OR	E
E5E7 FD 77 14       	LD	(IY+20),A	;(FCB)ファイルを最後に変更した日付
E5EA FD 74 15       	LD	(IY+21),H
E5ED C9             	RET
E5EE                
E5EE                PUSHRR:
E5EE 32 86 E6       	LD	(SETSEQ_SWC_RND),A
E5F1 22 98 E6       	LD	(SETSEQ_SWC_SEQ_RR),HL
E5F4 CD 14 E6       	CALL	GET_RR_AHL
E5F7 22 0F F0       	LD	(RR_BUF_HL),HL
E5FA 32 11 F0       	LD	(RR_BUF_A),A
E5FD C9             	RET
E5FE                
E5FE                GET_CPM_R_SIZE:		;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
E5FE 87             	ADD	A,A		;in BHLA => out AHL
E5FF ED 6A          	ADC	HL,HL
E601 CB 18          	RR	B
E603 B7             	OR	A
E604 78             	LD	A,B		;ここでフラグは変化しない
E605 C8             	RET	Z
E606 2C             	INC	L		;INC AHL
E607 C0             	RET	NZ		;
E608 24             	INC	H		;
E609 C0             	RET	NZ		;
E60A 3C             	INC	A		;
E60B C9             	RET
E60C                
E60C                INIT_RND:
E60C 3E CD          	LD	A,0CDH		;CALL ????
E60E 21 5B E6       	LD	HL,POPRR
E611 CD EE E5       	CALL	PUSHRR
E614                GET_RR_AHL:
E614 FD 6E 21       	LD	L,(IY+33)	;(FCB)Random record
E617 FD 66 22       	LD	H,(IY+34)	;
E61A FD 7E 23       	LD	A,(IY+35)	;
E61D C9             	RET
E61E                SET_RR_AHL:
E61E FD 75 21       	LD	(IY+33),L	;(FCB)Random record
E621 FD 74 22       	LD	(IY+34),H
E624 FD 77 23       	LD	(IY+35),A
E627 C9             	RET
E628                INIT_SEQ:
E628 3E 01          	LD	A,1		;LD BC,????
E62A 21 58 E6       	LD	HL,SETSEQ
E62D CD EE E5       	CALL	PUSHRR
E630                GETSEQ:
E630 FD 6E 20       	LD	L,(IY+32)	;(FCB)カレントレコード
E633 FD 66 0C       	LD	H,(IY+12)	;(FCB)カレントブロック
E636 AF             	XOR	A
E637                
E637 CB 25          	SLA	L	;L=L*2
E639                
E639 CB 3C          	SRL	H	;HL=HL/2
E63B CB 1D          	RR	L	;
E63D C9             	RET
E63E                
E63E                SETSEQ1:
E63E F5             	PUSH	AF
E63F E5             	PUSH	HL		;AHL=Random record
E640 CD 14 E6       	CALL	GET_RR_AHL
E643 47             	LD	B,A		;AHL→HLA
E644 7D             	LD	A,L		;(IY+33)(FCB)ランダムレコード
E645 6C             	LD	L,H		;(IY+34)
E646 60             	LD	H,B		;(IY+35)
E647 06 00          	LD	B,0
E649                
E649 CD FE E5       	CALL	GET_CPM_R_SIZE
E64C                
E64C 29             	ADD	HL,HL
E64D CB 3D          	SRL	L		;L=L/2
E64F FD 75 20       	LD	(IY+32),L	;(FCB)カレントレコード
E652 FD 74 0C       	LD	(IY+12),H	;(FCB)カレントブロック
E655 E1             	POP	HL
E656 F1             	POP	AF
E657 C9             	RET
E658                SETSEQ:
E658 CD 3E E6       	CALL	SETSEQ1
E65B                POPRR:
E65B F5             	PUSH	AF
E65C E5             	PUSH	HL
E65D 2A 0F F0       	LD	HL,(RR_BUF_HL)
E660 3A 11 F0       	LD	A,(RR_BUF_A)
E663 CD 1E E6       	CALL	SET_RR_AHL
E666 E1             	POP	HL
E667 F1             	POP	AF
E668 C9             	RET
E669                
E669                RB_WRITE:
E669 C5             	PUSH	BC
E66A ED 4B 4C F1    	LD	BC,(STABLE+2*026H)	;(BDOS)ランダムブロック書き込み
E66E 18 05          	JR	RBRW
E670                RB_READ:
E670 C5             	PUSH	BC
E671 ED 4B 4E F1    	LD	BC,(STABLE+2*027H)	;(BDOS)ランダムブロック読み込み
E675                RBRW:
E675 1F             	RRA		;AHL = AHL*128
E676 7C             	LD	A,H	;AHL = AHL0/2
E677 1F             	RRA		;A
E678 65             	LD	H,L	;
E679 CB 1C          	RR	H	;H
E67B 2E 00          	LD	L,0	;
E67D CB 1D          	RR	L	;L
E67F CD 1E E6       	CALL	SET_RR_AHL
E682 21 80 00       	LD	HL,128
E685 C5             	PUSH	BC
E686                SETSEQ_SWC_RND:
E686 CD 3E E6       	CALL	SETSEQ1
E689 C1             	POP	BC
E68A FD CB 20 FE    	SET	7,(IY+32)	;(FCB)カレントレコード
E68E FD E5          	PUSH	IY
E690 D1             	POP	DE
E691 D5             	PUSH	DE
E692 CD A0 E6       	CALL	JP_BC
E695 FD E1          	POP	IY
E697 CD 58 E6       	CALL	SETSEQ
E69A 00 00 E6 98    SETSEQ_SWC_SEQ_RR	EQU $-2
E69A FD CB 20 BE    	RES	7,(IY+32)	;(FCB)カレントレコード
E69E                
E69E C1             	POP	BC
E69F C9             	RET
E6A0                JP_BC:
E6A0 C5             	PUSH	BC
E6A1 C9             	RET
E6A2                
E6A2 00 00 E2 1D    _SYS03	EQU	SCF_FF_RET	;(BDOS)外部入力
E6A2 00 00 E2 1D    _SYS2B	EQU	SCF_FF_RET	;(BDOS)日付の設定
E6A2 00 00 E2 1D    _SYS2D	EQU	SCF_FF_RET	;(BDOS)時刻の設定
E6A2 00 00 E2 1D    _SYS39	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの作成
E6A2 00 00 E2 1D    _SYS3A	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの削除
E6A2                
E6A2                	INCLUDE	"LDFILE2.ASM"
E6A2                
E6A2                ;	LSX-Dodgers FILE2
E6A2                
E6A2                				;Write random block
E6A2                _SYS26:		;(BDOS)ランダムブロック書き込み
E6A2 AF             	XOR	A
E6A3 32 77 E9       	LD	(DRDN1),A	;NOP
E6A6 22 C7 E8       	LD	(RBSIZE),HL	;HL←書き込むレコード数
E6A9 22 5D F0       	LD	(LEFTX),HL
E6AC CD 72 E1       	CALL	SETDRV
E6AF                
E6AF CD 1F E8       	CALL	RBX0
E6B2 DA 3F E7       	JP	C,RBWERR
E6B5 CD FA E4       	CALL	WOPEN
E6B8 DA 3F E7       	JP	C,RBWERR
E6BB 7C             	LD	A,H
E6BC B5             	OR	L
E6BD CA 38 E7       	JP	Z,RBW1
E6C0                
E6C0 2B             	DEC	HL
E6C1                
E6C1 CD DD E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E6C4                
E6C4 19             	ADD	HL,DE		;BCHL=HL+BCDE
E6C5 30 01          	JR	NC,S26X1	;
E6C7 03             	INC	BC		;
E6C8                S26X1:
E6C8 CD 65 E5       	CALL	RWXR
E6CB DC 0B E5       	CALL	C,WRDFX
E6CE DA 3F E7       	JP	C,RBWERR
E6D1                
E6D1 CD 4E E8       	CALL	RBX2
E6D4 28 1A          	JR	Z,RBWB		;NZ=セクタ以下の端数がある
E6D6 CD 6D E8       	CALL	RBXA
E6D9 38 64          	JR	C,RBWERR
E6DB EB             	EX	DE,HL
E6DC C5             	PUSH	BC
E6DD ED B0          	LDIR
E6DF 22 5F F0       	LD	(DTAX),HL
E6E2                
E6E2 CD 9F E4       	CALL	SWTDBF		;バッファデータは更新された
E6E5                
E6E5 2A 5D F0       	LD	HL,(LEFTX)
E6E8 D1             	POP	DE
E6E9 ED 52          	SBC	HL,DE
E6EB 22 5D F0       	LD	(LEFTX),HL
E6EE 28 31          	JR	Z,RBWEND
E6F0                
E6F0                RBWB:
E6F0 CD A2 E8       	CALL	RBXB
E6F3 28 14          	JR	Z,RBWC
E6F5                RBWB1:
E6F5 C5             	PUSH	BC
E6F6 D5             	PUSH	DE
E6F7 CD 70 E3       	CALL	CLUSTX
E6FA CD F1 E8       	CALL	DWTC
E6FD D1             	POP	DE
E6FE C1             	POP	BC
E6FF D4 EF EA       	CALL	NC,GNCLX
E702 38 3B          	JR	C,RBWERR
E704 10 EF          	DJNZ	RBWB1
E706 CD 41 E9       	CALL	DRW_FLUSH
E709                RBWC:
E709 CD BA E8       	CALL	RBXC
E70C 28 13          	JR	Z,RBWEND
E70E C5             	PUSH	BC
E70F CD 70 E3       	CALL	CLUSTX
E712 CD 76 E9       	CALL	DRDN
E715 C1             	POP	BC
E716 38 27          	JR	C,RBWERR
E718 ED 5B 7E F1    	LD	DE,(_DTBUF)
E71C ED B0          	LDIR
E71E CD 9F E4       	CALL	SWTDBF		;バッファデータは更新された
E721                RBWEND:
E721 CD C6 E8       	CALL	RBXEND
E724                
E724 CD 2E E8       	CALL	RBX1
E727 30 0F          	JR	NC,RBW1		;ランダムレコードの方が大きい場合はサイズを合わせる
E729 CD DD E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E72C FD 73 10       	LD	(IY+16),E	;ファイルのサイズ(バイト単位)
E72F FD 72 11       	LD	(IY+17),D	;
E732 FD 71 12       	LD	(IY+18),C	;
E735 FD 70 13       	LD	(IY+19),B	;
E738                RBW1:
E738 FD E1          	POP	IY
E73A C1             	POP	BC
E73B D1             	POP	DE
E73C E1             	POP	HL
E73D                DD_NUL:
E73D AF             	XOR	A
E73E                DRDF0:
E73E                DWTF0:
E73E C9             	RET
E73F                
E73F                RBWERR:
E73F FD E5          	PUSH	IY
E741 D1             	POP	DE
E742 2A 20 F1       	LD	HL,(STABLE+2*010H)
E745 CD 0F 00       	CALL	JP_HL
E748                RBRERR1:
E748 3E 01          	LD	A,001H
E74A                RBRERR2:
E74A FD E1          	POP	IY
E74C C1             	POP	BC
E74D D1             	POP	DE
E74E E1             	POP	HL
E74F 37             	SCF
E750 21 00 00       	LD	HL,0
E753 C9             	RET
E754                
E754                RBRERR:
E754 3E FF          	LD	A,0FFH
E756 18 F2          	JR	RBRERR2
E758                
E758                RBRFL:
E758 3E 00          RBRFLP:	LD	A,000H
E75A FE 0D          	CP	00DH
E75C 20 05          	JR	NZ,RBRFL1
E75E D5             	PUSH	DE
E75F 1E 0A          	LD	E,00AH
E761 18 05          	JR	RBRFL2
E763                RBRFL1:
E763 D5             	PUSH	DE
E764 CD 09 F0       	CALL	_SYS07
E767 5F             	LD	E,A
E768                RBRFL2:
E768 CD CD F0       	CALL	_PRINT
E76B 7B             	LD	A,E
E76C D1             	POP	DE
E76D 32 59 E7       	LD	(RBRFLP+1),A
E770 C9             	RET
E771                DDX:
E771 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
E774 CD 95 E3       	CALL	CAP
E777 FE 41          	CP	'A'
E779 C9             	RET
E77A                
E77A                				;Read random block
E77A                _SYS27:		;(BDOS)ランダムブロック読み込み
E77A 22 5D F0       	LD	(LEFTX),HL
E77D CD 72 E1       	CALL	SETDRV
E780                
E780 FD CB 0D 66    	BIT	4,(IY+13)	;(FCB)属性(アトリビュート)
E784 C2 0D E8       	JP	NZ,RBRDIR	;ディレクトリ
E787 CD 1F E8       	CALL	RBX0
E78A DA 54 E7       	JP	C,RBRERR
E78D CD 2E E8       	CALL	RBX1
E790 D4 46 E8       	CALL	NC,RBX1R
E793 DA 48 E7       	JP	C,RBRERR1
E796 EB             	EX	DE,HL
E797 ED 52          	SBC	HL,DE		;CP 00HL,BCDE
E799 19             	ADD	HL,DE
E79A 79             	LD	A,C
E79B DE 00          	SBC	A,0
E79D 78             	LD	A,B
E79E DE 00          	SBC	A,0
E7A0 38 01          	JR	C,RBR1
E7A2 EB             	EX	DE,HL
E7A3                RBR1:
E7A3 9F             	SBC	A,A
E7A4 E6 01          	AND	1
E7A6 32 0B E8       	LD	(RBRAP+1),A
E7A9                
E7A9 7C             	LD	A,H
E7AA B5             	OR	L
E7AB 28 57          	JR	Z,RBREND0
E7AD                
E7AD 22 C7 E8       	LD	(RBSIZE),HL	;HL←読み込むレコード数
E7B0 22 5D F0       	LD	(LEFTX),HL
E7B3                
E7B3 CD 4E E8       	CALL	RBX2
E7B6 28 19          	JR	Z,RBRB
E7B8 CD 6D E8       	CALL	RBXA
E7BB DA 54 E7       	JP	C,RBRERR
E7BE C5             	PUSH	BC
E7BF ED B0          	LDIR
E7C1 ED 53 5F F0    	LD	(DTAX),DE
E7C5 2A 5D F0       	LD	HL,(LEFTX)
E7C8 D1             	POP	DE
E7C9 A7             	AND	A
E7CA ED 52          	SBC	HL,DE
E7CC 22 5D F0       	LD	(LEFTX),HL
E7CF 28 30          	JR	Z,RBREND
E7D1                
E7D1                RBRB:
E7D1 CD A2 E8       	CALL	RBXB
E7D4 28 15          	JR	Z,RBRC
E7D6                RBRB1:
E7D6 C5             	PUSH	BC
E7D7 D5             	PUSH	DE
E7D8 CD 70 E3       	CALL	CLUSTX
E7DB CD F7 E8       	CALL	DRDC
E7DE D1             	POP	DE
E7DF C1             	POP	BC
E7E0 D4 EF EA       	CALL	NC,GNCLX
E7E3 DA 54 E7       	JP	C,RBRERR
E7E6 10 EE          	DJNZ	RBRB1
E7E8 CD 41 E9       	CALL	DRW_FLUSH
E7EB                RBRC:
E7EB CD BA E8       	CALL	RBXC
E7EE 28 11          	JR	Z,RBREND
E7F0 C5             	PUSH	BC
E7F1 CD 70 E3       	CALL	CLUSTX
E7F4 CD 5A E9       	CALL	DRDX
E7F7 C1             	POP	BC
E7F8 DA 54 E7       	JP	C,RBRERR
E7FB EB             	EX	DE,HL
E7FC 2A 7E F1       	LD	HL,(_DTBUF)
E7FF ED B0          	LDIR
E801                RBREND:
E801 CD C6 E8       	CALL	RBXEND
E804                RBREND0:
E804 FD E1          	POP	IY
E806 C1             	POP	BC
E807 D1             	POP	DE
E808 F1             	POP	AF	;(HL)
E809 AF             	XOR	A
E80A 3E 00          RBRAP:	LD	A,000H
E80C C9             	RET
E80D                
E80D                RBRDIR:
E80D FD 6E 1A       	LD	L,(IY+26)	;(FCB)ファイルの先頭クラスタ
E810 FD 66 1B       	LD	H,(IY+27)
E813 CD B0 E3       	CALL	CHDIR
E816 AF             	XOR	A
E817 67             	LD	H,A
E818 6F             	LD	L,A
E819 3C             	INC	A
E81A 32 0B E8       	LD	(RBRAP+1),A
E81D 18 E5          	JR	RBREND0
E81F                
E81F                RBX0:
E81F 2A 8A F0       	LD	HL,(_DTA)
E822 22 5F F0       	LD	(DTAX),HL
E825 2A 5D F0       	LD	HL,(LEFTX)
E828 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
E82B D6 FD          	SUB	0FDH
E82D C9             	RET
E82E                
E82E                RBX1:				;ファイルサイズとランダムレコードを比べる
E82E E5             	PUSH	HL		;Record byte
E82F                				;AHL=File size
E82F FD 6E 10       	LD	L,(IY+16)	;ファイルのサイズ(バイト単位)
E832 FD 66 11       	LD	H,(IY+17)	;
E835 FD 7E 12       	LD	A,(IY+18)	;
E838                
E838 CD DD E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E83B                
E83B A7             	AND	A
E83C ED 52          	SBC	HL,DE
E83E 99             	SBC	A,C
E83F 4F             	LD	C,A
E840 FD 7E 13       	LD	A,(IY+19)	;ファイルのサイズ
E843 98             	SBC	A,B
E844 D1             	POP	DE
E845 C9             	RET
E846                RBX1R:
E846 47             	LD	B,A
E847 B1             	OR	C
E848 EB             	EX	DE,HL	;BCDE=File byte	HL=Record byte
E849 B2             	OR	D
E84A B3             	OR	E
E84B C0             	RET	NZ
E84C 37             	SCF
E84D C9             	RET
E84E                
E84E                RBX2:				;Cluster settings
E84E FD 66 22       	LD	H,(IY+34)	;(+33)(FCB)ランダムレコード
E851 FD 4E 23       	LD	C,(IY+35)
E854 06 00          	LD	B,0
E856 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E85A 20 03          	JR	NZ,RBX3
E85C FD 46 24       	LD	B,(IY+36)
E85F                RBX3:
E85F CD 65 E5       	CALL	RWXR
E862 3A 84 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E865 3D             	DEC	A
E866 FD A6 22       	AND	(IY+34)
E869 FD B6 21       	OR	(IY+33)
E86C C9             	RET
E86D                
E86D                RBXA:
E86D C5             	PUSH	BC
E86E D5             	PUSH	DE
E86F CD 70 E3       	CALL	CLUSTX
E872 CD 5A E9       	CALL	DRDX
E875 D1             	POP	DE
E876 C1             	POP	BC
E877 D4 EF EA       	CALL	NC,GNCLX
E87A D8             	RET	C
E87B ED 53 FE F1    	LD	(_CLPS),DE
E87F                
E87F FD 4E 21       	LD	C,(IY+33)	;(FCB)ランダムレコード
E882 21 00 04       SECSZ:	LD	HL,0400H	;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
E885 7C             	LD	A,H
E886 3D             	DEC	A		;1024=3 / 512=1
E887 FD A6 22       	AND	(IY+34)		;(FCB)ランダムレコード
E88A 47             	LD	B,A		;BCに1セクタ以下の端数が入る
E88B ED 42          	SBC	HL,BC		;残りを計算
E88D                
E88D ED 5B 5D F0    	LD	DE,(LEFTX)
E891 ED 52          	SBC	HL,DE		;CP HL,DE
E893 19             	ADD	HL,DE		;
E894 38 01          	JR	C,RBXA1		;DEとHLを比較して大きい方をHLに
E896 EB             	EX	DE,HL
E897                RBXA1:
E897 E5             	PUSH	HL
E898 2A 7E F1       	LD	HL,(_DTBUF)
E89B 09             	ADD	HL,BC
E89C ED 5B 5F F0    	LD	DE,(DTAX)
E8A0 C1             	POP	BC
E8A1 C9             	RET
E8A2                
E8A2                RBXB:
E8A2 2A 5F F0       	LD	HL,(DTAX)
E8A5 ED 5B FE F1    	LD	DE,(_CLPS)
E8A9 3A 5E F0       	LD	A,(LEFTX+1)
E8AC 47             	LD	B,A
E8AD 3A 84 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8B0                RBXB1:
E8B0 1F             	RRA		;->CF
E8B1 38 04          	JR	C,RBXB2
E8B3 CB 38          	SRL	B	;B=B/2
E8B5 18 F9          	JR	RBXB1
E8B7                RBXB2:
E8B7 78             	LD	A,B
E8B8 B7             	OR	A
E8B9 C9             	RET
E8BA                
E8BA                RBXC:
E8BA ED 4B 5D F0    	LD	BC,(LEFTX)
E8BE 3A 84 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8C1 3D             	DEC	A
E8C2 A0             	AND	B
E8C3 47             	LD	B,A		;1セクタ以下の端数がない場合はZ
E8C4 B1             	OR	C
E8C5 C9             	RET
E8C6                
E8C6                RBXEND:				;レコード数だけランダムレコードを進める
E8C6 11 00 00       	LD	DE,0		;進めるレコード数(RBSIZE)
E8C9 00 00 E8 C7    RBSIZE	EQU	$-2
E8C9 CD 14 E6       	CALL	GET_RR_AHL
E8CC 19             	ADD	HL,DE
E8CD CE 00          	ADC	A,0
E8CF CD 1E E6       	CALL	SET_RR_AHL
E8D2 EB             	EX	DE,HL		;HL=進めるレコード数
E8D3 D0             	RET	NC
E8D4 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E8D8 C0             	RET	NZ
E8D9 FD 34 24       	INC	(IY+36)
E8DC C9             	RET
E8DD                
E8DD                GET_RR_BCDE:			;BCDE=Random record
E8DD FD 5E 21       	LD	E,(IY+33)	;(FCB)ランダムレコード
E8E0 FD 56 22       	LD	D,(IY+34)
E8E3 FD 4E 23       	LD	C,(IY+35)
E8E6 06 00          	LD	B,0		;CP/M互換のアクセスの場合はFCBは36バイト
E8E8 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E8EC C0             	RET	NZ
E8ED FD 46 24       	LD	B,(IY+36)
E8F0 C9             	RET
E8F1                
E8F1                ;	ランダムブロックアクセスの連続したセクタをまとめる
E8F1                
E8F1                DWTC:
E8F1 E5             	PUSH	HL
E8F2 21 81 EC       	LD	HL,DWT24B
E8F5 18 04          	JR	DWTC1
E8F7                DRDC:
E8F7 E5             	PUSH	HL
E8F8 21 71 EC       	LD	HL,DRD24B
E8FB                DWTC1:
E8FB 22 55 E9       	LD	(DRWF_MODE),HL
E8FE E1             	POP	HL
E8FF 3A 45 E9       	LD	A,(DRWF_B)
E902 B7             	OR	A
E903 20 0F          	JR	NZ,DRDC1
E905                SAVE_DRWC:
E905 06 01          	LD	B,1
E907 ED 43 44 E9    	LD	(DRWF_C),BC
E90B ED 53 4B E9    	LD	(DRWF_E),DE
E90F 22 4E E9       	LD	(DRWF_HL),HL
E912 18 20          	JR	INC_HL_DRWC
E914                DRDC1:
E914 E5             	PUSH	HL
E915 21 4B E9       	LD	HL,DRWF_E
E918 86             	ADD	A,(HL)
E919 F5             	PUSH	AF
E91A BB             	CP	E
E91B 20 1D          	JR	NZ,DRDC2
E91D F1             	POP	AF
E91E 23             	INC	HL
E91F 7E             	LD	A,(HL)
E920 CE 00          	ADC	A,0
E922 F5             	PUSH	AF
E923 BA             	CP	D
E924 20 14          	JR	NZ,DRDC2
E926 F1             	POP	AF
E927 3A 44 E9       	LD	A,(DRWF_C)
E92A CE 00          	ADC	A,0
E92C B9             	CP	C
E92D 20 0C          	JR	NZ,DRDC3
E92F 21 45 E9       	LD	HL,DRWF_B
E932 34             	INC	(HL)
E933 E1             	POP	HL
E934                INC_HL_DRWC:
E934 3A 84 E8       	LD	A,(SECSZ+2)		;1セクタのサイズの上位1バイト
E937 84             	ADD	A,H
E938 67             	LD	H,A
E939 C9             	RET
E93A                DRDC2:
E93A F1             	POP	AF
E93B                DRDC3:
E93B CD 41 E9       	CALL	DRW_FLUSH
E93E E1             	POP	HL
E93F 18 C4          	JR	SAVE_DRWC
E941                
E941                ;	ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
E941                DRW_FLUSH:
E941 C5             	PUSH	BC
E942 D5             	PUSH	DE
E943 01 00 00       	LD	BC,0
E946 00 00 E9 44    DRWF_C	EQU	$-2
E946 00 00 E9 45    DRWF_B	EQU	$-1
E946 78             	LD	A,B
E947 B7             	OR	A
E948 28 0D          	JR	Z,DRDF1
E94A 11 00 00       	LD	DE,0
E94D 00 00 E9 4B    DRWF_E	EQU	$-2
E94D 00 00 E9 4C    DRWF_D	EQU	$-1
E94D 21 00 00       	LD	HL,0
E950 00 00 E9 4E    DRWF_HL	EQU	$-2
E950 AF             	XOR	A
E951 32 45 E9       	LD	(DRWF_B),A
E954 CD 71 EC       	CALL	DRD24B
E957 00 00 E9 55    DRWF_MODE	EQU	$-2
E957                DRDF1:
E957 D1             	POP	DE
E958 C1             	POP	BC
E959 C9             	RET
E95A                	INCLUDE	"LDDIO.ASM"
E95A                
E95A                ;	LSX-Dodgers DIO
E95A                
E95A                DRDX:
E95A CD 98 E9       	CALL	DRDY
E95D C8             	RET	Z
E95E CD 7E E9       	CALL	DRDX1		;データバッファの情報を保存
E961 D8             	RET	C
E962 E5             	PUSH	HL
E963 C5             	PUSH	BC
E964 D5             	PUSH	DE
E965 2A 7E F1       	LD	HL,(_DTBUF)
E968 3A C1 E9       	LD	A,(_DBS24+1)
E96B 4F             	LD	C,A
E96C CD 6F EC       	CALL	DRD24
E96F DC 93 E9       	CALL	C,DRDNE
E972                POP_DE_BC_HL_RET:
E972 D1             	POP	DE
E973 C1             	POP	BC
E974 E1             	POP	HL
E975 C9             	RET
E976                
E976                ;	CDE:セクタ番号
E976                DRDN:
E976 AF             	XOR	A
E977 00             DRDN1:	NOP			;自己書き換え NOP / SCF
E978 30 E0          	JR	NC,DRDX
E97A                DRDNX:
E97A CD 98 E9       	CALL	DRDY
E97D C8             	RET	Z
E97E                DRDX1:
E97E CD AE E9       	CALL	DWTX
E981                				;データバッファの読み込んだドライブ・セクタ情報を保存
E981 ED 53 A6 F0    	LD	(_DBSEC),DE
E985 79             	LD	A,C
E986 32 C1 E9       	LD	(_DBS24+1),A
E989                
E989 3A 88 F0       	LD	A,(_DRV)
E98C 32 A5 F0       	LD	(_DBDRV),A
E98F CD D9 F0       	CALL	_CHGDRV
E992 D0             	RET	NC
E993                DRDNE:
E993 9F             	SBC	A,A		;CF=1ならばA=0FFH
E994 32 A5 F0       	LD	(_DBDRV),A
E997 C9             	RET
E998                
E998                ;	CDE:セクタ番号
E998                DRDY:
E998 3A C1 E9       	LD	A,(_DBS24+1)
E99B B9             	CP	C
E99C C0             	RET	NZ
E99D                
E99D E5             	PUSH	HL
E99E 3A 88 F0       	LD	A,(_DRV)
E9A1 21 A5 F0       	LD	HL,_DBDRV
E9A4 AE             	XOR	(HL)
E9A5 20 05          	JR	NZ,POP_HL_RET
E9A7                
E9A7 2A A6 F0       	LD	HL,(_DBSEC)
E9AA ED 52          	SBC	HL,DE		;CF=0
E9AC                POP_HL_RET:
E9AC E1             	POP	HL
E9AD C9             	RET
E9AE                
E9AE                DWTX:
E9AE 3A A4 F0       	LD	A,(_WTDBF)
E9B1 B7             	OR	A
E9B2 C8             	RET	Z
E9B3 AF             	XOR	A
E9B4 32 A4 F0       	LD	(_WTDBF),A
E9B7                
E9B7 E5             	PUSH	HL
E9B8 C5             	PUSH	BC
E9B9 D5             	PUSH	DE
E9BA 3A A5 F0       	LD	A,(_DBDRV)
E9BD CD D9 F0       	CALL	_CHGDRV
E9C0 0E 00          _DBS24:	LD	C,0
E9C2 ED 5B A6 F0    	LD	DE,(_DBSEC)
E9C6 2A 7E F1       	LD	HL,(_DTBUF)
E9C9 D4 7F EC       	CALL	NC,DWT24
E9CC                POP_DE_BC_HL_RET2:
E9CC 18 A4          	JR	POP_DE_BC_HL_RET
E9CE                
E9CE                RDFATX:
E9CE E5             	PUSH	HL
E9CF 3A 88 F0       	LD	A,(_DRV)
E9D2 21 AA F0       	LD	HL,_FATDRV
E9D5 AE             	XOR	(HL)
E9D6 28 D4          	JR	Z,POP_HL_RET
E9D8                
E9D8 C5             	PUSH	BC
E9D9 D5             	PUSH	DE
E9DA DD E5          	PUSH	IX
E9DC CD F8 E9       	CALL	WTFATX
E9DF 38 13          	JR	C,POP_IX_DE_BC_HL_RET
E9E1                
E9E1 AF             	XOR	A
E9E2 32 AB F0       	LD	(_FATIX),A
E9E5 3A 88 F0       	LD	A,(_DRV)
E9E8 32 AA F0       	LD	(_FATDRV),A
E9EB CD E5 F0       	CALL	_RDFAT
E9EE                RDFATE2:
E9EE 30 04          	JR	NC,POP_IX_DE_BC_HL_RET
E9F0 9F             	SBC	A,A		;A=0xFF
E9F1 32 AA F0       	LD	(_FATDRV),A
E9F4                POP_IX_DE_BC_HL_RET:
E9F4 DD E1          	POP	IX
E9F6 18 D4          	JR	POP_DE_BC_HL_RET2
E9F8                
E9F8                WTFATX:
E9F8 3A A2 F0       	LD	A,(_WTFATF)
E9FB B7             	OR	A
E9FC C8             	RET	Z
E9FD E5             	PUSH	HL
E9FE 3A AA F0       	LD	A,(_FATDRV)
EA01 21 A5 F0       	LD	HL,_DBDRV
EA04 AE             	XOR	(HL)
EA05 CC AE E9       	CALL	Z,DWTX
EA08 38 A2          	JR	C,POP_HL_RET
EA0A C5             	PUSH	BC
EA0B D5             	PUSH	DE
EA0C DD E5          	PUSH	IX
EA0E CD 8C EC       	CALL	WTFAT
EA11 AF             	XOR	A
EA12 32 A2 F0       	LD	(_WTFATF),A
EA15 18 DD          	JR	POP_IX_DE_BC_HL_RET
EA17                
EA17                NCL1:
EA17 7A             	LD	A,D
EA18 B3             	OR	E
EA19 37             	SCF
EA1A C8             	RET	Z
EA1B                
EA1B 7A             	LD	A,D
EA1C CB 3F          	SRL	A	;/2
EA1E CB 3F          	SRL	A	;/2
EA20                
EA20 E5             	PUSH	HL
EA21 32 40 EA       	LD	(NCLPAT+2),A	;_FATIX
EA24 2A AA F0       	LD	HL,(_FATDRV)	;L=_FATDRV H=_FATIX
EA27 BC             	CP	H
EA28 3A 88 F0       	LD	A,(_DRV)	;この間でフラグは変化しない
EA2B 32 3F EA       	LD	(NCLPAT+1),A	;_FATDRV
EA2E 20 05          	JR	NZ,NCL2		;FATIXが違う
EA30 BD             	CP	L
EA31 20 02          	JR	NZ,NCL2		;ドライブが違う
EA33 E1             	POP	HL
EA34 C9             	RET
EA35                NCL2:
EA35 C5             	PUSH	BC
EA36 D5             	PUSH	DE
EA37 DD E5          	PUSH	IX
EA39 CD F8 E9       	CALL	WTFATX
EA3C 38 B6          	JR	C,POP_IX_DE_BC_HL_RET
EA3E 01 00 00       NCLPAT:	LD	BC,0		;自己書き換え C=_FATDRV B=_FATIX
EA41 ED 43 AA F0    	LD	(_FATDRV),BC
EA45 CD 61 EC       	CALL	RDFATS
EA48 18 A4          	JR	RDFATE2
EA4A                
EA4A                NCL3:
EA4A CB 9A          	RES	3,D
EA4C CB 92          	RES	2,D
EA4E 6B             	LD	L,E
EA4F 62             	LD	H,D
EA50 CB 3C          	SRL	H	;
EA52 CB 1D          	RR	L	;HLA=HLA/2
EA54 1F             	RRA		;
EA55 F5             	PUSH	AF
EA56 3A AB F0       	LD	A,(_FATIX)
EA59 0F             	RRCA
EA5A 30 0B          	JR	NC,NCL3X1
EA5C 3A 84 E8       	LD	A,(SECSZ+2)
EA5F FE 04          	CP	4		;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
EA61 20 04          	JR	NZ,NCL3X1
EA63 01 00 02       	LD	BC,512
EA66 09             	ADD	HL,BC
EA67                NCL3X1:
EA67 F1             	POP	AF
EA68 ED 4B 7C F1    	LD	BC,(_FATBF)
EA6C 19             	ADD	HL,DE
EA6D 09             	ADD	HL,BC
EA6E 17             	RLA
EA6F C9             	RET
EA70                
EA70                GNCL:
EA70 CD 17 EA       	CALL	NCL1		;GET NEXT CLUSTER
EA73 D8             	RET	C
EA74 C5             	PUSH	BC
EA75 E5             	PUSH	HL
EA76 CD 4A EA       	CALL	NCL3
EA79 38 09          	JR	C,GNC1
EA7B 5E             	LD	E,(HL)
EA7C 23             	INC	HL
EA7D 7E             	LD	A,(HL)
EA7E E6 0F          	AND	00FH
EA80 57             	LD	D,A
EA81 E1             	POP	HL
EA82 C1             	POP	BC
EA83 C9             	RET
EA84                GNC1:
EA84 7E             	LD	A,(HL)
EA85 23             	INC	HL
EA86 56             	LD	D,(HL)
EA87 06 04          	LD	B,4
EA89                GNC1L:
EA89 CB 3A          	SRL	D	;DA=DA/2
EA8B 1F             	RRA		;
EA8C 10 FB          	DJNZ	GNC1L
EA8E                
EA8E 5F             	LD	E,A
EA8F E1             	POP	HL
EA90 C1             	POP	BC
EA91 A7             	AND	A
EA92 C9             	RET
EA93                
EA93                SNCL:
EA93 CD 17 EA       	CALL	NCL1
EA96 D8             	RET	C
EA97                ;				SET NEXT CLUSTER
EA97 E5             	PUSH	HL
EA98 C5             	PUSH	BC
EA99 D5             	PUSH	DE
EA9A E5             	PUSH	HL
EA9B CD 4A EA       	CALL	NCL3
EA9E D1             	POP	DE
EA9F                ;CF=ODD
EA9F 7E             	LD	A,(HL)
EAA0 73             	LD	(HL),E
EAA1 38 06          	JR	C,SNC1
EAA3                ;EVEN
EAA3                ;M[0] = E
EAA3                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
EAA3 23             	INC	HL
EAA4 ED 67          	RRD		;M={A[3:0],E[3:0]}
EAA6 7A             	LD	A,D
EAA7 18 04          	JR	SNC11
EAA9                SNC1:
EAA9                ;ODD
EAA9                ;HL[0] = (HL[0]&0x0F) | (E<<4)
EAA9                ;HL[1] = DE>>4
EAA9 ED 6F          	RLD		;M={D[3:0],E[7:4]}
EAAB 23             	INC	HL
EAAC 72             	LD	(HL),D	;M={D[3:0],E[7:4]}
EAAD                SNC11:
EAAD ED 6F          	RLD		;M={M[7:4],D[3:0]}
EAAF B7             	OR	A
EAB0 D1             	POP	DE
EAB1 C1             	POP	BC
EAB2 E1             	POP	HL
EAB3                FAT_CHANGED:
EAB3 3E 01          	LD	A,1
EAB5 32 A2 F0       	LD	(_WTFATF),A
EAB8 C9             	RET
EAB9                
EAB9                N16CL3:
EAB9 C5             	PUSH	BC
EABA 6B             	LD	L,E
EABB 7A             	LD	A,D
EABC E6 03          	AND	3
EABE 67             	LD	H,A
EABF 29             	ADD	HL,HL
EAC0 ED 4B 7C F1    	LD	BC,(_FATBF)
EAC4 09             	ADD	HL,BC
EAC5 C1             	POP	BC
EAC6 C9             	RET
EAC7                
EAC7                GNCL16:
EAC7 CD 17 EA       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EACA D8             	RET	C
EACB E5             	PUSH	HL
EACC CD B9 EA       	CALL	N16CL3
EACF 5E             	LD	E,(HL)
EAD0 23             	INC	HL
EAD1 56             	LD	D,(HL)
EAD2 E1             	POP	HL
EAD3 C9             	RET
EAD4                
EAD4                SNCL16:
EAD4 CD 17 EA       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EAD7 D8             	RET	C
EAD8 D5             	PUSH	DE
EAD9 E5             	PUSH	HL
EADA CD B9 EA       	CALL	N16CL3
EADD D1             	POP	DE		;HL
EADE 73             	LD	(HL),E
EADF 23             	INC	HL
EAE0 72             	LD	(HL),D
EAE1 6B             	LD	L,E
EAE2 62             	LD	H,D
EAE3 D1             	POP	DE
EAE4 18 CD          	JR	FAT_CHANGED
EAE6                
EAE6                ;------------------------
EAE6                ;次のセクタを探す際に_SECPSの値をチェック
EAE6                ;in
EAE6                ;	DE : セクタ番号
EAE6                ;out
EAE6                ;	DE : 次のセクタ番号
EAE6                ;note
EAE6                ;
EAE6                ;------------------------
EAE6                NEXTX:
EAE6 3E 00          _SECPS:	LD	A,0	;自己書き換え
EAE8 3C             	INC	A
EAE9 E6 00          NCPAT:	AND	0	;自己書き換え　1クラスタの論理セクタ数-1
EAEB 32 E7 EA       	LD	(_SECPS+1),A
EAEE C9             	RET
EAEF                
EAEF                GNCLX:
EAEF CD E6 EA       	CALL	NEXTX
EAF2 C0             	RET	NZ	;1クラスタのセクタ未満の場合は戻る
EAF3 C3 F7 F0       	JP	_GNCL	;次のクラスタを探す
EAF6                
EAF6                RDFAT:
EAF6 3E 80          	LD	A,080H
EAF8 32 70 F0       	LD	(CHECK),A
EAFB                RDFAT1:
EAFB 3A 88 F0       	LD	A,(_DRV)
EAFE CD B6 ED       	CALL	CHGDRVR
EB01 D8             	RET	C
EB02 DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EB05 CB 6F          	BIT	5,A
EB07 28 6B          	JR	Z,RDFAT0X
EB09 21 70 F0       	LD	HL,CHECK
EB0C A6             	AND	(HL)
EB0D 77             	LD	(HL),A
EB0E 11 00 00       	LD	DE,0		;BPB
EB11 2A 7C F1       	LD	HL,(_FATBF)
EB14 CD 6D EC       	CALL	DRD16
EB17 30 24          	JR	NC,GETBPB
EB19 21 70 F0       	LD	HL,CHECK
EB1C CB 06          	RLC	(HL)
EB1E 3F             	CCF
EB1F D8             	RET	C
EB20 DD CB 0A 1E    	RR	(IX+00AH)	;DPB_0A_FDMODE
EB24 3F             	CCF			;フロッピーディスクのFDモードを切り替える
EB25 DD CB 0A 16    	RL	(IX+00AH)	;DPB_0A_FDMODE
EB29 3E FF          	LD	A,0FFH
EB2B 32 89 F0       	LD	(_DSK),A
EB2E 3A 84 F0       	LD	A,(_DRIVE)
EB31 E6 03          	AND	3
EB33 F6 80          	OR	080H
EB35 6F             	LD	L,A
EB36 26 F0          	LD	H,_CYL0/256
EB38 3E FF          	LD	A,0FFH
EB3A 77             	LD	(HL),A
EB3B 18 BE          	JR	RDFAT1
EB3D                GETBPB:
EB3D FD E5          	PUSH	IY
EB3F FD 2A 7C F1    	LD	IY,(_FATBF)	;BPB
EB43 CD F1 F0       	CALL	_BPB2DPB
EB46 FD E1          	POP	IY
EB48 DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EB4B 30 21          	JR	NC,GETBPBOK
EB4D E6 0F          	AND	00FH
EB4F FE 07          	CP	7
EB51 37             	SCF
EB52 C0             	RET	NZ
EB53 DD CB 0A 46    	BIT	0,(IX+00AH)	;DPB_0A_FDMODE
EB57 21 C0 F1       	LD	HL,M2D
EB5A 20 02          	JR	NZ,SETFDMODE
EB5C 2E D2          	LD	L,M2HD-STABLE
EB5E                SETFDMODE:
EB5E DD E5          	PUSH	IX
EB60 D1             	POP	DE
EB61 ED A0          	LDI
EB63 ED A0          	LDI
EB65 13             	INC	DE
EB66 13             	INC	DE
EB67 13             	INC	DE
EB68 13             	INC	DE
EB69 01 0C 00       	LD	BC,12
EB6C ED B0          	LDIR
EB6E                GETBPBOK:
EB6E 32 7D EB       	LD	(DEVSWC),A
EB71 CD 15 ED       	CALL	CHGDRV2
EB74                RDFAT0X:
EB74 CD 61 EC       	CALL	RDFATS
EB77 D8             	RET	C
EB78 DD AE 06       	XOR	(IX+6)		;DPB_06_FATID
EB7B C8             	RET	Z
EB7C 3E 00          	LD	A,0		;DPB_12_DEVICE
EB7E 00 00 EB 7D    DEVSWC	EQU	$-1
EB7E CB 6F          	BIT	5,A
EB80 C0             	RET	NZ		;BPBを取得している場合はFATIDをチェックしない
EB81 37             	SCF
EB82 C9             	RET
EB83                
EB83                BPB2DPB:
EB83 FD 7E 0B       	LD	A,(IY+11)	;BPB_BytsPerSec
EB86 B7             	OR	A
EB87 37             	SCF
EB88 C0             	RET	NZ
EB89                BPBOK:
EB89 FD 7E 0D       	LD	A,(IY+13)	;BPB_SecPerClus
EB8C DD 77 07       	LD	(IX+7),A	;DPB_07_SECPCL
EB8F                
EB8F FD 7E 16       	LD	A,(IY+22)	;BPB_FATSz16
EB92 DD 77 00       	LD	(IX+0),A	;DPB_00_FATLN
EB95 FD 7E 17       	LD	A,(IY+23)	;BPB_FATSz16
EB98 DD 77 01       	LD	(IX+1),A	;DPB_00_FATLN
EB9B                
EB9B FD 6E 0E       	LD	L,(IY+14)	;BPB_RsvdSecCnt
EB9E FD 66 0F       	LD	H,(IY+15)
EBA1 DD 75 0E       	LD	(IX+00EH),L	;DPB_0E_FATPS
EBA4 FD 5E 16       	LD	E,(IY+22)	;BPB_FATSz16
EBA7 FD 56 17       	LD	D,(IY+23)
EBAA FD 46 10       	LD	B,(IY+16)	;BPB_NumFATs
EBAD                BPBDP1:				;BPB_FATSz16 * BPB_NumFATs
EBAD 19             	ADD	HL,DE
EBAE 10 FD          	DJNZ	BPBDP1
EBB0                BPBDP2:
EBB0 DD 75 10       	LD	(IX+010H),L	;DPB_10_DIRPS
EBB3 DD 74 11       	LD	(IX+011H),H
EBB6 E5             	PUSH	HL
EBB7                
EBB7 FD 6E 11       	LD	L,(IY+17)	;BPB_RootEntCnt
EBBA FD 66 12       	LD	H,(IY+18)
EBBD FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EBC0 B7             	OR	A
EBC1 37             	SCF
EBC2 C8             	RET	Z
EBC3 06 06          	LD	B,6
EBC5                BPBBPS1:
EBC5 05             	DEC	B
EBC6 0F             	RRCA
EBC7 30 FC          	JR	NC,BPBBPS1
EBC9                BPBDE1:
EBC9 29             	ADD	HL,HL
EBCA 10 FD          	DJNZ	BPBDE1
EBCC                
EBCC 7C             	LD	A,H
EBCD DD 77 0B       	LD	(IX+00BH),A	;DPB_0B_DIRSCNT
EBD0                
EBD0 D1             	POP	DE		;DPB_10_DIRPS
EBD1 6C             	LD	L,H
EBD2 26 00          	LD	H,0
EBD4 19             	ADD	HL,DE		;MAXDIR
EBD5 E5             	PUSH	HL
EBD6 FD 4E 0D       	LD	C,(IY+13)	;BPB_SecPerClus
EBD9 CB 21          	SLA	C		;*2
EBDB AF             	XOR	A
EBDC 47             	LD	B,A
EBDD ED 42          	SBC	HL,BC
EBDF DD 75 14       	LD	(IX+014H),L	;DPB_14_ADDCL16
EBE2 DD 74 15       	LD	(IX+015H),H
EBE5                
EBE5 D1             	POP	DE		;DE=DPB_0B_MAXDIR
EBE6 FD 6E 13       	LD	L,(IY+19)	;BPB_TotSec16
EBE9 FD 66 14       	LD	H,(IY+20)
EBEC                
EBEC DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EBEF E6 0F          	AND	00FH
EBF1 FE 07          	CP	7		;フロッピー
EBF3 20 19          	JR	NZ,NOT_FD
EBF5 E5             	PUSH	HL
EBF6 FD 4E 18       	LD	C,(IY+24)	;BPB_SecPerTr
EBF9 DD 71 0D       	LD	(IX+00DH),C	;DPB_0D_MAXSEC
EBFC AF             	XOR	A
EBFD CB 21          	SLA	C		;両面なのでセクタ数を２倍
EBFF 06 10          	LD	B,16
EC01                DIVSEC:				;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
EC01 29             	ADD	HL,HL
EC02 17             	RLA
EC03 B9             	CP	C
EC04 38 02             	JR	C,DIVSEC1
EC06 91                	SUB	C
EC07 2C             	INC	L
EC08                DIVSEC1:
EC08 10 F7           	DJNZ	DIVSEC
EC0A DD 75 0C       	LD	(IX+00CH),L	;DPB_0C_MAXCYL
EC0D E1             	POP	HL	;ここまでフロッピー専用
EC0E                NOT_FD:
EC0E 7C             	LD	A,H
EC0F B5             	OR	L
EC10 3E 00          	LD	A,0		;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
EC12 20 10          	JR	NZ,BPB16BIT	;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
EC14 FD 7E 23       	LD	A,(IY+35)	;念のために総セクタ数が24ビットを超える場合はエラーを返す
EC17 B7             	OR	A
EC18 37             	SCF
EC19 C0             	RET	NZ
EC1A FD 6E 20       	LD	L,(IY+32)	;BPB_TotSec32 は AHL の24ビットで扱う
EC1D FD 66 21       	LD	H,(IY+33)	;1クラスタの論理セクタ数(DPB_07_SECPCL)が最大128なので
EC20 FD 7E 22       	LD	A,(IY+34)	;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
EC23 A7             	AND	A		;CF=0
EC24                BPB16BIT:
EC24 ED 52          	SBC	HL,DE
EC26 DE 00          	SBC	A,0
EC28 FD 46 0D       	LD	B,(IY+13)	;BPB_SecPerClus
EC2B                BPBTC1:				;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
EC2B CB 18          	RR	B		;->CY
EC2D 38 08          	JR	C,BPBTC2
EC2F CB 3F          	SRL	A
EC31 CB 1C          	RR	H		;AHL=AHL/2
EC33 CB 1D          	RR	L
EC35 18 F4          	JR	BPBTC1
EC37                BPBTC2:
EC37 B7             	OR	A
EC38 37             	SCF
EC39 C0             	RET	NZ		;念のため(クラスタ数が16ビットを超える場合)
EC3A 23             	INC	HL
EC3B 23             	INC	HL
EC3C DD 75 08       	LD	(IX+8),L	;DPB_08_MAXCL
EC3F DD 74 09       	LD	(IX+9),H
EC42                
EC42 FD 7E 15       	LD	A,(IY+21)	;BPB_Media
EC45 DD 77 06       	LD	(IX+6),A	;DPB_06_FATID
EC48                
EC48 FD 7E 10       	LD	A,(IY+16)	;BPB_NumFATs
EC4B C6 FE          	ADD	A,0-2		;>2:CF=1
EC4D FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EC50 6F             	LD	L,A
EC51 30 02          	JR	NC,BPBFAT1
EC53 F6 80          	OR	080H
EC55                BPBFAT1:
EC55 DD 77 0F       	LD	(IX+00FH),A	;DPB_0F_BPS
EC58 2D             	DEC	L		;以下のセクタサイズに合致しない場合はCF=1でエラーにする
EC59 C8             	RET	Z		;1セクタ256バイト
EC5A 2D             	DEC	L
EC5B C8             	RET	Z		;1セクタ512バイト
EC5C 2D             	DEC	L
EC5D 2D             	DEC	L
EC5E C8             	RET	Z		;1セクタ1024バイト
EC5F 37             	SCF
EC60 C9             	RET
EC61                
EC61                RDFATS:
EC61 CD A7 EC       	CALL	FATSETUP
EC64 D8             	RET	C
EC65 CD 71 EC       	CALL	DRD24B
EC68 2A 7C F1       	LD	HL,(_FATBF)
EC6B 7E             	LD	A,(HL)
EC6C C9             	RET
EC6D                
EC6D                DRD16:
EC6D 0E 00          	LD	C,0
EC6F                DRD24:
EC6F 06 01          	LD	B,1
EC71                DRD24B:
EC71 DD E5          	PUSH	IX
EC73 DD 2A A8 F0    	LD	IX,(_DPB)
EC77 CD D1 EE       DRDPAT:	CALL	FDRD		;自己書き換え（ディスク読み込み）
EC7A                POP_IX_RET:
EC7A DD E1          	POP	IX
EC7C C9             	RET
EC7D                
EC7D                DWT16:
EC7D 0E 00          	LD	C,0
EC7F                DWT24:
EC7F 06 01          	LD	B,1
EC81                DWT24B:
EC81 DD E5          	PUSH	IX
EC83 DD 2A A8 F0    	LD	IX,(_DPB)
EC87 CD C3 EE       DWTPAT:	CALL	FDWT		;自己書き換え（ディスク書き込み）
EC8A 18 EE          	JR	POP_IX_RET
EC8C                
EC8C                WTFAT:
EC8C CD A7 EC       	CALL	FATSETUP
EC8F D4 81 EC       	CALL	NC,DWT24B
EC92 D8             	RET	C
EC93 DD CB 0F 7E    	BIT	7,(IX+00FH)	;DPB_0F_BPS
EC97 C8             	RET	Z		;予備FATが無い
EC98 CD AE EC       	CALL	FATS2
EC9B E5             	PUSH	HL		;予備FAT
EC9C DD 6E 00       	LD	L,(IX+0)	;DPB_00_FATLN
EC9F DD 66 01       	LD	H,(IX+1)
ECA2 19             	ADD	HL,DE
ECA3 EB             	EX	DE,HL
ECA4 E1             	POP	HL
ECA5 18 DA          	JR	DWT24B
ECA7                ;------------------------
ECA7                ;FATのセットアップ
ECA7                ;out
ECA7                ;	B  : FATセクタ数
ECA7                ;	DE : FAT先頭セクタ番号
ECA7                ;	HL : FATバッファポインタ
ECA7                ;	CF : 1=ドライブ切り替えエラー
ECA7                ;note
ECA7                ;	FATサイズがFATバッファを超える場合は
ECA7                ;	対象クラスタ領域==(_FATIX)によって
ECA7                ;	FAT12:対象クラスタ1024毎に1.5KBを切り替える
ECA7                ;	FAT16:対象クラスタ1024毎に2KBを切り替える
ECA7                ;------------------------
ECA7                FATSETUP:
ECA7 3A AA F0       	LD	A,(_FATDRV)
ECAA CD B6 ED       	CALL	CHGDRVR		;ドライブ切り替え
ECAD D8             	RET	C
ECAE                FATS2:
ECAE DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS 512=2 1024=4
ECB1 0F             	RRCA
ECB2 CD DB EC       FATSX:	CALL	FATSETUP12	;自己書き換え
ECB5 21 00 00       	LD	HL,0
ECB8 4A             	LD	C,D
ECB9 54             	LD	D,H
ECBA 3A AB F0       	LD	A,(_FATIX)	;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
ECBD 47             	LD	B,A
ECBE 04             	INC	B
ECBF DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
ECC2                FAT_SKP:
ECC2 05             	DEC	B
ECC3 28 05          	JR	Z,FAT1
ECC5 19             	ADD	HL,DE
ECC6 93             	SUB	E
ECC7 30 F9          	JR	NC,FAT_SKP
ECC9 C9             	RET
ECCA                FAT1:
ECCA EB             	EX	DE,HL
ECCB B9             	CP	C		;C=FATバッファに読み込めるセクタ数
ECCC 38 01          	JR	C,FAT2
ECCE 79             	LD	A,C
ECCF                FAT2:
ECCF 47             	LD	B,A
ECD0                
ECD0 2A FA F1       	LD	HL,(_FATPS)	;fat sector pos
ECD3 19             	ADD	HL,DE
ECD4 EB             	EX	DE,HL
ECD5 2A 7C F1       	LD	HL,(_FATBF)
ECD8 AF             	XOR	A		;CF=0
ECD9 4F             	LD	C,A
ECDA C9             	RET
ECDB                ;
ECDB                ;	FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
ECDB                ;	FATSETUP* (FAT12/FAT16)
ECDB                ;out
ECDB                ;	D : FATバッファに読み込める最大のセクタ数
ECDB                ;	E : _FATIXで進めるセクタ数
ECDB                FATSETUP12:
ECDB 11 06 06       	LD	DE,0606H	;256
ECDE D8             	RET	C
ECDF 11 03 03       	LD	DE,0303H	;512
ECE2 0F             	RRCA
ECE3 D8             	RET	C
ECE4 11 01 02       	LD	DE,0201H	;1024
ECE7 C9             	RET
ECE8                
ECE8                FATSETUP16:
ECE8 11 08 08       	LD	DE,0808H	;256
ECEB D8             	RET	C
ECEC 11 04 04       	LD	DE,0404H
ECEF 0F             	RRCA			;512
ECF0 D8             	RET	C
ECF1 11 02 02       	LD	DE,0202H	;1024
ECF4 C9             	RET
ECF5                
ECF5                CHGDRV:
ECF5 E5             	PUSH	HL
ECF6 21 89 F0       	LD	HL,_DSK
ECF9 BE             	CP	(HL)
ECFA 28 0A          	JR	Z,CHGDRVE
ECFC                CHGDRV1:
ECFC DD E5          	PUSH	IX
ECFE CD 08 ED       	CALL	CHGDRV0
ED01 3A 89 F0       	LD	A,(_DSK)
ED04 DD E1          	POP	IX
ED06                CHGDRVE:
ED06 E1             	POP	HL
ED07 C9             	RET
ED08                
ED08                CHGDRV0:
ED08 6F             	LD	L,A
ED09 CD DC F0       	CALL	_GETDPB
ED0C D8             	RET	C
ED0D DD 22 A8 F0    	LD	(_DPB),IX
ED11 7D             	LD	A,L
ED12 32 89 F0       	LD	(_DSK),A
ED15                CHGDRV2:
ED15 C5             	PUSH	BC
ED16 D5             	PUSH	DE
ED17 ED 73 6C ED    	LD	(SPPAT2+1),SP
ED1B F3             	DI
ED1C DD F9          	LD	SP,IX
ED1E                
ED1E E1             	POP	HL		;DPB_00_FATLN
ED1F E1             	POP	HL		;DPB_02_DRD
ED20 22 78 EC       	LD	(DRDPAT+1),HL
ED23                
ED23 E1             	POP	HL
ED24 22 88 EC       	LD	(DWTPAT+1),HL	;DPB_04_DWT
ED27                
ED27 E1             	POP	HL		;L=DPB_06_FATID H=DPB_07_SECPCL
ED28 7C             	LD	A,H
ED29 32 74 E3       	LD	(SPCPAT+1),A	;1クラスタの論理セクタ数
ED2C 3D             	DEC	A
ED2D 32 EA EA       	LD	(NCPAT+1),A
ED30                
ED30 E1             	POP	HL		;DPB_08_MAXCL
ED31 7D             	LD	A,L
ED32 32 93 E3       	LD	(CLPAT2+1),A
ED35 7C             	LD	A,H
ED36 32 8F E3       	LD	(CLPAT1+1),A
ED39 2B             	DEC	HL
ED3A 22 9B E5       	LD	(MAXCLP+1),HL
ED3D                
ED3D E1             	POP	HL		;L=DPB_0A_FDMODE H=DPB_0B_DIRSCNT
ED3E 7D             	LD	A,L
ED3F F6 FE          	OR	0FEH
ED41 32 6C EE       	LD	(FDMODE+1),A
ED44 07             	RLCA
ED45 E6 03          	AND	3
ED47 32 54 EE       	LD	(FSPAT+1),A
ED4A 4C             	LD	C,H
ED4B                
ED4B E1             	POP	HL		;L=DPB_0C_MAXCYL H=DPB_0D_MAXSEC
ED4C                
ED4C E1             	POP	HL		;L=DPB_0E_FATPS H=DPB_0F_BPS
ED4D 7C             	LD	A,H		;DPB_0F_BPS
ED4E E6 07          	AND	7
ED50 32 84 E8       	LD	(SECSZ+2),A	;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
ED53                				;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
ED53                				;1セクタ1024 2HD/2HDE98
ED53                				;1セクタ256 GRAM/RAMF/CMOS/等
ED53                				;1024	512	256
ED53                				;4	2	1
ED53 87             	ADD	A,A		;8	4	2
ED54 87             	ADD	A,A		;010H	8	4
ED55 87             	ADD	A,A		;020H	010H	8
ED56 32 F0 E1       	LD	(SDECPAT+1),A	;1セクタ辺りのディレクトリエントリ数
ED59                
ED59 26 00          	LD	H,0
ED5B 22 FA F1       	LD	(_FATPS),HL
ED5E                
ED5E E1             	POP	HL		;DPB_10_DIRPS
ED5F 22 FC F1       	LD	(_DIRPS),HL
ED62                
ED62 E1             	POP	HL		;L=DPB_12_DEVICE H=DPB_13_UNITNO
ED63 7C             	LD	A,H
ED64 32 84 F0       	LD	(_DRIVE),A
ED67                
ED67 E1             	POP	HL		;DPB_14_ADDCL16
ED68 22 84 E3       	LD	(CLSPAT+1),HL
ED6B                
ED6B 31 00 00       SPPAT2:	LD	SP,0		;元のSPを復元
ED6E FB             	EI
ED6F 2A FC F1       	LD	HL,(_DIRPS)
ED72 06 00          	LD	B,0
ED74 09             	ADD	HL,BC		;C=DPB_0B_DIRSCNT
ED75 22 0B E2       	LD	(MD_PAT+1),HL
ED78                
ED78 2A 9B E5       	LD	HL,(MAXCLP+1);
ED7B 11 F6 0F       	LD	DE,4086		;クラスタ数が4086未満:FAT12 4086以上:FAT16
ED7E ED 52          	SBC	HL,DE		;CF=0のはず
ED80 30 0F          	JR	NC,SETFAT16
ED82 21 70 EA       	LD	HL,GNCL		;FAT12
ED85 11 93 EA       	LD	DE,SNCL
ED88 01 DB EC       	LD	BC,FATSETUP12
ED8B DD CB 0F AE    	RES	5,(IX+00FH)	;DPB_0F_BPS(FAT12)
ED8F 18 0D          	JR	EXTRA1
ED91                SETFAT16:
ED91 21 C7 EA       	LD	HL,GNCL16	;FAT16
ED94 11 D4 EA       	LD	DE,SNCL16
ED97 01 E8 EC       	LD	BC,FATSETUP16
ED9A DD CB 0F EE    	SET	5,(IX+00FH)	;DPB_0F_BPS(FAT16)
ED9E                EXTRA1:
ED9E 22 F8 F0       	LD	(GNCPAT+1),HL
EDA1 ED 53 FB F0    	LD	(SNCPAT+1),DE
EDA5 ED 43 B3 EC    	LD	(FATSX+1),BC
EDA9 D1             	POP	DE
EDAA C1             	POP	BC
EDAB AF             	XOR	A
EDAC C9             	RET
EDAD                
EDAD                GETDPBD:
EDAD DD E3          	EX	(SP),IX
EDAF DD E5          	PUSH	IX
EDB1 3A 88 F0       	LD	A,(_DRV)
EDB4 18 07          	JR	GETDPB1
EDB6                
EDB6                CHGDRVR:
EDB6 CD D9 F0       	CALL	_CHGDRV
EDB9 D8             	RET	C
EDBA 3A 89 F0       	LD	A,(_DSK)
EDBD                GETDPB1:
EDBD C3 DC F0       	JP	_GETDPB
EDC0                
EDC0                GETDPB:
EDC0 FE 08          	CP	8
EDC2 3F             	CCF
EDC3 D8             	RET	C
EDC4 0F             	RRCA
EDC5 0F             	RRCA
EDC6 0F             	RRCA
EDC7 DD             	DB	0DDH		;Z80未定義命令
EDC8 6F             	LD	L,A		;LD	IXL,A
EDC9 DD             	DB	0DDH		;Z80未定義命令
EDCA 26 F2          	LD	H,DEVICE/256	;LD	IXH,DEVICE/256
EDCC DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
EDCF A7             	AND	A		;CF=0の為
EDD0 DD CB 0F 6E    	BIT	5,(IX+00FH)	;DPB_0F_BPS
EDD4 C0             	RET	NZ		;FAT16
EDD5 DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
EDD9 C0             	RET	NZ		;BPB
EDDA FE 01          	CP	001H		;A=0 THEN CF=1
EDDC C9             	RET
EDDD                
EDDD                _SYS5F:
EDDD AF             	XOR	A
EDDE                FFLUSH:
EDDE F5             	PUSH	AF
EDDF 3E FF          	LD	A,0FFH
EDE1 32 39 F0       	LD	(SFILE),A
EDE4 CD AE E9       	CALL	DWTX
EDE7 3E FF          	LD	A,0FFH
EDE9 32 A5 F0       	LD	(_DBDRV),A
EDEC CD F8 E9       	CALL	WTFATX
EDEF AF             	XOR	A
EDF0 32 AB F0       	LD	(_FATIX),A
EDF3 2F             	CPL			;0FFH
EDF4 32 AA F0       	LD	(_FATDRV),A
EDF7 F1             	POP	AF
EDF8 C9             	RET
EDF9                
EDF9                	INCLUDE	"X1DISK.ASM"
EDF9                
EDF9                ;	LSX-Dodgers DISK
EDF9                ;	X1/turbo/Z
EDF9                
EDF9                SEEK:
EDF9 06 10          	LD	B,16
EDFB DD 4E 0D       	LD	C,(IX+0DH)	;DPB_0D_MAXSEC
EDFE AF             	XOR	A
EDFF EB             	EX	DE,HL
EE00                DIV1:
EE00 29             	ADD	HL,HL
EE01 8F             	ADC	A,A
EE02 B9             	CP	C
EE03 38 02          	JR	C,DIV2
EE05 91             	SUB	C
EE06 2C             	INC	L
EE07                DIV2:
EE07 10 F7          	DJNZ	DIV1
EE09                
EE09 3C             	INC	A	;最小のセクタは１固定
EE0A 55             	LD	D,L	;TRACK
EE0B 5F             	LD	E,A	;SECTOR
EE0C CB 3A          	SRL	D	;CYLINDER
EE0E 9F             	SBC	A,A
EE0F E6 10          	AND	010H	;SIDE
EE11 4F             	LD	C,A
EE12                
EE12 3A 84 F0       	LD	A,(_DRIVE)
EE15 FE 04          	CP	4
EE17 3F             	CCF
EE18 D8             	RET	C
EE19 B1             	OR	C
EE1A 32 98 EE       	LD	(MOPAT+1),A	;Motor off data
EE1D 01 FC 0F       	LD	BC,00FFCH
EE20 F6 80          	OR	080H		;Motor on
EE22 ED 79          	OUT	(C),A
EE24                
EE24 CD 6A EE       	CALL	SETMODE
EE27 D8             	RET	C
EE28                
EE28 CD AD EE       	CALL	DRIVE
EE2B FE FF          	CP	0FFH		;A=0FFH Unknown CYLINDER
EE2D CC 8C EE       	CALL	Z,FDCRES	;Restore
EE30 0E F9          	LD	C,0F9H
EE32 ED 79          	OUT	(C),A		;Currrent CYLINDER
EE34 92             	SUB	D
EE35 C8             	RET	Z		;No seek
EE36                
EE36 3A 86 F0       	LD	A,(_ISEEK)
EE39 4F             	LD	C,A
EE3A                
EE3A DD 7E 0C       	LD	A,(IX+00CH)	;DPB_0C_MAXCYL
EE3D 3D             	DEC	A
EE3E BA             	CP	D		;Over CYLINDER
EE3F D8             	RET	C
EE40                
EE40 B9             	CP	C		;for Built-in 2DD
EE41 38 03          	JR	C,SETM2
EE43 78             	LD	A,B		;B=00FH
EE44 DB FE          	IN	A,(0FEH)		;2HD mode for 2DD seek
EE46                SETM2:
EE46 78             	LD	A,B
EE47 DB FD          	IN	A,(0FDH)		;MFM mode
EE49                
EE49 0E FB          	LD	C,0FBH
EE4B ED 51          	OUT	(C),D
EE4D 72             	LD	(HL),D
EE4E 0E 18          	LD	C,018H		;Seek
EE50                FDCCMD2:
EE50 3A 85 F0       	LD	A,(_SEEKSP)
EE53 E6 FF          FSPAT:	AND	0FFH
EE55 B1             	OR	C
EE56                
EE56                FDCCMD:
EE56 CD A3 EE       	CALL	COMSET
EE59                
EE59 3E 80          FDCPAT:	LD	A,080H		;FDC COMMAND(Self-modifying code)
EE5B E6 20          	AND	020H		;Write data Write track
EE5D 3C             	INC	A
EE5E                
EE5E                SST:
EE5E 0E 00          	LD	C,0
EE60                SST1:
EE60 0D             	DEC	C		; 4
EE61 20 FD          	JR	NZ,SST1		;12 * 256 / 4 = About 1ms
EE63 3D             	DEC	A
EE64 20 FA          	JR	NZ,SST1
EE66                
EE66 3C             	INC	A		;A=1
EE67 CD 75 EE       	CALL	READY
EE6A                SETMODE:
EE6A 78             	LD	A,B		;B=00FH
EE6B DB FF          FDMODE:	IN	A,(0FFH)	;Floppy mode(2D/2HD) (Self-modifying code)
EE6D                
EE6D 78             	LD	A,B
EE6E DB FD          	IN	A,(0FDH)	;MFM mode
EE70                
EE70 CD A7 EE       	CALL	DELAY0		;Head select time
EE73 3E 81          	LD	A,081H
EE75                READY:
EE75 32 7F EE       	LD	(WAITA+1),A
EE78 E5             	PUSH	HL
EE79 0E F8          	LD	C,0F8H
EE7B 61             	LD	H,C
EE7C                READY2:
EE7C ED 78          	IN	A,(C)
EE7E E6 81          WAITA:	AND	081H		;NOT READY,BUSY
EE80 28 08          	JR	Z,READYE
EE82 E3             	EX	(SP),HL		;wait 19clock
EE83 E3             	EX	(SP),HL		; //
EE84 2B             	DEC	HL
EE85 7C             	LD	A,H
EE86 B5             	OR	L
EE87 20 F3          	JR	NZ,READY2
EE89 37             	SCF
EE8A                READYE:
EE8A E1             	POP	HL
EE8B C9             	RET
EE8C                
EE8C                FDCRES:
EE8C 36 00          	LD	(HL),0
EE8E 0E 08          	LD	C,8
EE90 18 BE          	JR	FDCCMD2
EE92                
EE92                FDMOFF:
EE92 F5             	PUSH	AF
EE93 C5             	PUSH	BC
EE94 01 FC 0F       	LD	BC,00FFCH	;Motor off
EE97 3E 00          MOPAT:	LD	A,000H		;(Self-rewriting)
EE99 ED 79          	OUT	(C),A
EE9B C1             	POP	BC
EE9C F1             	POP	AF
EE9D C9             	RET
EE9E                
EE9E                SECSET:
EE9E 01 FA 0F       	LD	BC,00FFAH
EEA1 ED 59          	OUT	(C),E
EEA3                COMSET:
EEA3 0E F8          	LD	C,0F8H
EEA5 ED 79          	OUT	(C),A
EEA7                DELAY0:
EEA7 3E 1A          	LD	A,26
EEA9                DELAY:
EEA9 3D             	DEC	A
EEAA 20 FD          	JR	NZ,DELAY
EEAC C9             	RET
EEAD                
EEAD                DRIVE:
EEAD 2A 84 F0       	LD	HL,(_DRIVE)
EEB0 26 F0          	LD	H,_CYL0/256
EEB2 CB FD          	SET	7,L
EEB4 7E             	LD	A,(HL)
EEB5 C9             	RET
EEB6                
EEB6                RNF:
EEB6 CD AD EE       	CALL	DRIVE
EEB9 36 FF          	LD	(HL),0FFH
EEBB C9             	RET
EEBC                
EEBC 02             RETRY:	DB	2
EEBD                
EEBD                
EEBD                ;	FLOPPY DISK DRIVER(DMA)
EEBD                
EEBD                
EEBD                WTTRK:
EEBD 06 01          	LD	B,1
EEBF 3E F4          	LD	A,0F4H
EEC1 18 02          	JR	WTTRK1
EEC3                FDWT:
EEC3 3E A0          	LD	A,0A0H
EEC5                WTTRK1:
EEC5 32 5A EE       	LD	(FDCPAT+1),A
EEC8 3E 10          	LD	A,16
EECA 18 0C          	JR	DISK
EECC                
EECC                DISKOK:
EECC 06 01          FDCNT:	LD	B,1
EECE 10 0B          	DJNZ	DISK1
EED0 C9             	RET
EED1                
EED1                FDRD:
EED1 3E 80          	LD	A,080H
EED3 32 5A EE       	LD	(FDCPAT+1),A
EED6 3E 0E          	LD	A,14
EED8                
EED8                DISK:
EED8 32 EF EE       	LD	(DMAPAT+1),A
EEDB                DISK1:
EEDB 78             	LD	A,B
EEDC 32 CD EE       	LD	(FDCNT+1),A
EEDF 22 47 EF       	LD	(DMAD+11),HL
EEE2                DISKR:
EEE2 3E 02          	LD	A,2		;Retry count
EEE4 32 BC EE       	LD	(RETRY),A
EEE7                DISK2:
EEE7 D5             	PUSH	DE
EEE8 CD F9 ED       	CALL	SEEK
EEEB 38 43          	JR	C,ERRF
EEED F3             	DI
EEEE                
EEEE 3E 0E          DMAPAT:	LD	A,14		;自己書き換え
EEF0 21 3C EF       	LD	HL,DMAD
EEF3 CD 91 DF       	CALL	SETDMA
EEF6 ED 49          	OUT	(C),C		;OUT 01F87H,087H WR6 イネーブル
EEF8 3A 5A EE       	LD	A,(FDCPAT+1)
EEFB C5             	PUSH	BC
EEFC CD 9E EE       	CALL	SECSET
EEFF 2A 47 EF       	LD	HL,(DMAHL)
EF02 23             	INC	HL
EF03 11 06 BB       	LD	DE,0BB06H	;READ DMA
EF06                
EF06 3E 03          	LD	A,3
EF08 CD 75 EE       	CALL	READY
EF0B ED 78          	IN	A,(C)
EF0D                
EF0D C1             	POP	BC
EF0E ED 51          	OUT	(C),D		;読み出しマスク設定
EF10 ED 59          	OUT	(C),E		;バイトカウンタ(LH)
EF12 ED 58          	IN	E,(C)
EF14 ED 50          	IN	D,(C)
EF16 19             	ADD	HL,DE
EF17 D1             	POP	DE
EF18 13             	INC	DE
EF19 FB             	EI
EF1A CD 92 EE       	CALL	FDMOFF
EF1D B7             	OR	A
EF1E 28 AC          	JR	Z,DISKOK
EF20 1B             	DEC	DE
EF21 CB 67          	BIT	4,A
EF23 C4 B6 EE       	CALL	NZ,RNF
EF26                DISKE2:
EF26 21 BC EE       	LD	HL,RETRY
EF29 35             	DEC	(HL)
EF2A 20 BB          	JR	NZ,DISK2
EF2C B7             	OR	A
EF2D 28 0A          	JR	Z,ERR
EF2F D5             	PUSH	DE
EF30                ERRF:
EF30 D1             	POP	DE
EF31                DELP:
EF31 CD B6 EE       	CALL	RNF
EF34 CD 92 EE       	CALL	FDMOFF
EF37 3E FF          	LD	A,0FFH
EF39                ERR:
EF39 BF             	CP	A
EF3A 37             	SCF
EF3B C9             	RET
EF3C                
EF3C                			;X1turbo DISK DMA
EF3C C3             DMAD:	DB	0C3H	;WR6 リセット
EF3D 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
EF3E FB 0F          	DW	00FFBH	;ポートA開始アドレス FDC データレジスタ
EF40 FF FF          	DW	0FFFFH	;ブロック長(転送サイズ-1)
EF42 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
EF43 10             	DB	010H	;WR2 ポートBインクリメント
EF44 80             	DB	080H	;WR3
EF45 92             	DB	092H	;WR5 WAIT RDY:LOW
EF46 8D             	DB	08DH	;WR4 バイト ポートB開始アドレス(LH)
EF47 00 00          DMAHL:	DW	0	;ポートB開始アドレス
EF49 CF             	DB	0CFH	;WR6 ロード
EF4A 01             	DB	001H	;WR0 ポートB←ポートB 転送
EF4B CF             	DB	0CFH	;WR6 ロード
EF4C                
EF4C                DMAE:
EF4C                
EF4C 00 00 1E 1C    AT_R	EQU	WTTRK-AT_DWT
EF4C                AT_TABLE:
EF4C                	INCLUDE	"LDCCPWK.ASM"
EF4C                
EF4C                ;	LSX-Dodgers CCP WORK
EF4C                
EF4C 00 00 00 40    PATHX	EQU	64
EF4C                PATHD:	DS	PATHX
EF8C 00             PATHE:	DB	0
EF8D                
EF8D                DTA_CCP:
EF8D                	DS	37
EFB2                
EFB2                FCB_BAT:
EFB2                	DS	37
EFD7                
EFD7                
EFD7 20 62 79 74    FREE:	DB	" bytes free",9,'$'
EFDB 65 73 20 66
EFDF 72 65 65 09
EFE3 24
EFE4                	INCLUDE	"LDWORK.ASM"
EFE4                
EFE4                ;	LSX-Dodgers WORK0
EFE4                ;
EFE4                ;	CP/M互換BIOS
EFE4                ;	BOOT:アドレス下位1バイトが0になるように
EFE4                AT_WORK:
EFE4                	DS	WORKAD-AT_WORK
F000                
F000                CPM_BOOT:
F000 C3 00 00       	JP	0
F003                _SYS00:		;(BDOS)プログラム終了
F003                CPM_WBOOT:
F003 C3 09 D2       	JP	WBOOT1
F006                CPM_CONST:
F006 C3 3F DC       	JP	CONSTX
F009                _SYS07:		;(BDOS)コンソール直接入力
F009                CPM_CONIN:
F009 C3 E6 DB       	JP	FLGET
F00C                CPM_CONOUT:
F00C C3 84 DE       	JP	CONOUT1
F00F                
F00F                DECBF:				;10進数表示時のバッファ(5バイト)
F00F                	DS	5
F014 00 00 F0 0F    RR_BUF_HL	EQU	DECBF	;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
F014 00 00 F0 11    RR_BUF_A	EQU	DECBF+2	;計3バイト
F014                
F014 00             FDRV:	DB	0
F015                FNAME:	DS	36
F039                SFILE:	DS	33		;DRV FILENAME
F05A                
F05A                	DS	3
F05D                
F05D 00 00          LEFTX:	DW	0
F05F 00 00          DTAX:	DW	0
F061                
F061                ZERO:
F061                BEEPD:
F061 00 8E 01 00    	DB	0,08EH,1,0,00BH,0,00CH,010H
F065 0B 00 0C 10
F069 07 3E 08 10    	DB	007H,03EH,008H,010H,00DH,0,0FFH
F06D 0D 00 FF
F070 00 00 F0 62    RTC_YY	EQU	BEEPD+1
F070 00 00 F0 63    RTC_MW	EQU	BEEPD+2
F070 00 00 F0 64    RTC_DD	EQU	BEEPD+3
F070 00 00 F0 65    RTC_TT	EQU	BEEPD+4
F070 00 00 F0 66    RTC_MM	EQU	BEEPD+5
F070 00 00 F0 67    RTC_SS	EQU	BEEPD+6
F070                
F070 00             CHECK:	DB	0
F071                
F071 4F 4B 24       OK:	DB	"OK$"
F074                	DS	5
F079 45 72 72 6F    COMERM:	DB	"Error!$"
F07D 72 21 24
F080                ;	システムワークエリア
F080                ;	_CYL0:アドレス下位1バイトが080Hになるように
F080 FF             _CYL0:	DB	0FFH	;Cylinder
F081 FF             _CYL1:	DB	0FFH	;Cylinder
F082 FF             _CYL2:	DB	0FFH	;Cylinder
F083 FF             _CYL3:	DB	0FFH	;Cylinder
F084 00             _DRIVE:	DB	0	;unit number
F085 00             _SEEKSP:DB	0	;Seek speed
F086 FF             _ISEEK:	DB	0FFH	;
F087 00             _DVSW:	DB	0
F088 00             _DRV:	DB	0
F089 FF             _DSK:	DB	0FFH
F08A 80 00          _DTA:	DW	00080H
F08C 00 00          _CTC:	DW	0
F08E 00 00          _TXADR:	DW	0
F090 00 00          _KEYPS:	DW	0
F092 00 FF          _KEYD:	DW	0FF00H	;キーデータ
F094 C2 10          _KEYSP:	DB	KEYSP_L,KEYSP_H	;オートリピートの速度
F096 07             _COLORF:DB	COLORF	;色
F097 18             _LINE:	DB	LINE
F098                
F098 00 00          _FCB:	DW	0	;SEARCH FILES
F09A 00 00          _FBPS:	DW	0	;    //
F09C 00 00          _FBAD:	DW	0	;    //
F09E 00             _FBCNT:	DB	0	;    //
F09F 00             _FILEN:	DB	0	;    //
F0A0 00             _DIRF:	DB	0	;bit7:ディレクトリ bit0-6:セクタインデックス
F0A1                	DS	1
F0A2 00             _WTFATF:DB	0	;FATバッファの更新フラグ
F0A3                	DS	1
F0A4 00             _WTDBF:	DB	0	;データバッファの更新フラグ
F0A5 FF             _DBDRV:	DB	0FFH	;データバッファにあるデータを読み込んだドライブ
F0A6 00 00          _DBSEC:	DW	0	;データバッファにあるデータを読み込んだセクタ番号
F0A8 00 00          _DPB:	DW	0
F0AA                _FATDRV:
F0AA FF             	DB	0FFH	;FATバッファに読み込んでいるドライブ
F0AB 00             _FATIX:	DB	0	;FATバッファに読み込んでいるインデックス
F0AC                _FAKEFREE:
F0AC 00 00          	DW	0	;偽の残量（FATサイズが大きくなると重くなるのでその対策）
F0AE                
F0AE                	DS	2
F0B0                
F0B0                CRTCD:
F0B0 6F             	DB	06FH
F0B1                _WIDTH:
F0B1 50             	DB	WIDTH
F0B2                TVRAMTOP:
F0B2 59 38          	DB	059H,038H
F0B4 1F 02          	DB	01FH,002H
F0B6                _LINE2:
F0B6 19             	DB	019H
F0B7                WKE4:
F0B7 1C             	DB	01CH
F0B8                WKE6:
F0B8 00             	DB	000H
F0B9                WK40:
F0B9 07             	DB	007H
F0BA                _PAGE_MINUS:
F0BA 80 F8          	DW	0-WIDTH*LINE
F0BC                _WIDTH_MINUS:
F0BC B0 FF          	DW	0-WIDTH
F0BE                WK30:
F0BE 0C             	DB	00CH
F0BF                WK31:
F0BF                WK1FD0:
F0BF 20             	DB	020H
F0C0                
F0C0 2D DB          CTC0:	DW	INTCTCE
F0C2 2D DB          CTC1:	DW	INTCTCE
F0C4 30 DB          CTC2:	DW	INTCTC2
F0C6 2D DB          CTC3:	DW	INTCTCE
F0C8 19 DB          INTVEC:	DW	INT
F0CA                
F0CA                ;	LSX-Dodgers 独自BIOS
F0CA                
F0CA C3 67 E0       _INKEY:	JP	INKEY
F0CD C3 1F DD       _PRINT:	JP	PRINT
F0D0 C3 CF DF       _SCRN:	JP	SCRN
F0D3 C3 F9 DF       _POS:	JP	POS
F0D6 C3 4D DE       _LOC:	JP	LOC
F0D9                _CHGDRV:
F0D9 C3 F5 EC       	JP	CHGDRV
F0DC                _GETDPB:
F0DC C3 C0 ED       	JP	GETDPB
F0DF                _FFLUSH:
F0DF C3 DE ED       	JP	FFLUSH
F0E2                _RDFATX:
F0E2 C3 CE E9       	JP	RDFATX
F0E5 C3 F6 EA       _RDFAT:	JP	RDFAT
F0E8 C3 BD EE       _WTTRK:	JP	WTTRK
F0EB C3 D1 EE       _FDRD:	JP	FDRD
F0EE C3 C3 EE       _FDWT:	JP	FDWT
F0F1                _BPB2DPB:
F0F1 C3 83 EB       	JP	BPB2DPB
F0F4                _BREAK:
F0F4 C3 C2 D3       	JP	END_BATCH
F0F7                _GNCL:
F0F7 C3 70 EA       GNCPAT:	JP	GNCL		; self-modifying code
F0FA                _SNCL:
F0FA C3 93 EA       SNCPAT:	JP	SNCL		; self-modifying code
F0FD C3 7C D2       _COMANL:JP	COMANL
F100                
F100                _WE:
F100                	INCLUDE	"LDCALL.ASM"
F100                
F100                ;	LSX-Dodgers システムコール(BDOS)
F100                ;
F100                ;	LSX-Dodgers SYSTEM CALL
F100                ;	STABLE:アドレス下位1バイトが0になるように
F100                
F100                STABLE:
F100                ;0
F100 03 F0 B9 DB    	DW	_SYS00,_SYS01,_SYS02,_SYS03
F104 C5 DB 1D E2
F108 5F D8 5F D8    	DW	_SYS04,_SYS05,_SYS06,_SYS07
F10C CA DB 09 F0
F110 D2 DB 61 D8    	DW	_SYS08,_SYS09,_SYS0A,_SYS0B
F114 0B DC 37 DC
F118 76 D8 7B D8    	DW	_SYS0C,_SYS0D,_SYS0E,_SYS0F
F11C 8A D8 9B D8
F120                ;1
F120 EF D8 36 D9    	DW	_SYS10,_SYS11,_SYS12,_SYS13
F124 7F D9 B5 D9
F128 BD D9 D3 D9    	DW	_SYS14,_SYS15,_SYS16,_SYS17
F12C E8 D9 E0 D9
F130 2F DA 34 DA    	DW	_SYS18,_SYS19,_SYS1A,_SYS1B
F134 39 DA 3F DA
F138 5F D8 65 DA    	DW	_SYS1C,_SYS1D,_SYS1E,_SYS1F
F13C 5F D8 69 DA
F140                ;2
F140 5F D8 1F DA    	DW	_SYS20,_SYS21,_SYS22,_SYS23
F144 27 DA 70 DA
F148 96 DA 5F D8    	DW	_SYS24,_ERROR,_SYS26,_SYS27
F14C A2 E6 7A E7
F150 27 DA 9F DA    	DW	_SYS28,_SYS29,_SYS2A,_SYS2B
F154 4D DC 1D E2
F158 70 DC 1D E2    	DW	_SYS2C,_SYS2D,_SYS2E,_SYS2F
F15C 5F D8 C0 DA
F160                ;3
F160 BA DA 5F D8    	DW	_SYS30,_ERROR,_ERROR,_ERROR
F164 5F D8 5F D8
F168 5F D8 5F D8    	DW	_ERROR,_ERROR,_ERROR,_ERROR
F16C 5F D8 5F D8
F170 5F D8 1D E2    	DW	_ERROR,_SYS39,_SYS3A,_SYS5A
F174 1D E2 E1 DA
F178                ;DOS2
F178 42 D8          	DW	_DOS2
F17A                
F17A                	DS	2
F17C 00 F3          _FATBF:	DW	FATBF
F17E 00 FB          _DTBUF:	DW	DTBUF
F180                
F180                ;	コントロールコードテーブル
F180                ;	CTRLTB:アドレス下位1バイトが080Hになるように
F180                
F180                CTRLTB:
F180 C2 DD C2 DD    	DW	CTRL00,CTRL00,CTRL02,CTRL03	;  A,B,C
F184 FE DD 43 DF
F188 3D DF 22 DE    	DW	CTRL04,CTRL05,CTRL06,CTRL07	;D,E,F,G
F18C 1C DF A5 DE
F190 CE DD EF DD    	DW	CTRL08,CTRL09,CTRL0A,CTRL0B	;H,I,J,K
F194 46 DF 63 DE
F198 19 DF 48 DE    	DW	CTRL0C,CTRL0D,CTRL0E,CTRL00	;L,M,N,O
F19C 5B DF C2 DD
F1A0 C2 DD C2 DD    	DW	CTRL00,CTRL00,CTRL12,CTRL00	;P,Q,R,S
F1A4 5B DE C2 DD
F1A8 C2 DD C2 DD    	DW	CTRL00,CTRL00,CTRL00,CTRL00	;T,U,V,W
F1AC C2 DD C2 DD
F1B0 C2 DD C2 DD    	DW	CTRL00,CTRL00,CTRL0C,CTRL1B	;X,Y,Z,ESC
F1B4 19 DF 6A DE
F1B8 E9 DD D5 DD    	DW	CTRL1C,CTRL1D,CTRL1E,CTRL1F	;→,←,↑,↓
F1BC DE DD 46 DF
F1C0                
F1C0 02 00          M2D:	DW	2
F1C2 FD 02          	DB	0FDH,2
F1C4 64 01          	DW	356
F1C6 FF 07 28 09    	DB	0FFH,7,40,9,1,082H
F1CA 01 82
F1CC 05 00 A7 00    	DW	5,0A7H,8
F1D0 08 00
F1D2                
F1D2 02 00          M2HD:	DW	2
F1D4 FE 01          	DB	0FEH,1
F1D6 C7 04          	DW	1223
F1D8 FE 06 4D 08    	DB	0FEH,6,77,8,1,084H
F1DC 01 84
F1DE 05 00 A7 00    	DW	5,0A7H,9
F1E2 09 00
F1E4                
F1E4                	DS	6
F1EA                
F1EA 16 17          SDDATA:	DB	22,23		;(FCB)ファイルを最後に変更した時刻
F1EC 14 15          	DB	20,21		;(FCB)ファイルを最後に変更した日付
F1EE 1A 1B          	DB	26,27		;(FCB)ファイルの先頭クラスタ
F1F0 10 11 12 13    	DB	16,17,18,19	;(FCB)ファイルのサイズ(バイト単位)
F1F4                SDDATAE:
F1F4                
F1F4                SCDIR:	DS	2		;+14 +15
F1F6                SFBPS:	DS	2		;FBPS
F1F8                SFNDF:	DS	2		;FILEN DIRF
F1FA                
F1FA 00 00          _FATPS:	DW	0
F1FC 00 00          _DIRPS:	DW	0
F1FE 00 00          _CLPS:	DW	0
F200                
F200                _PE:
F200                	INCLUDE	"X1DPB.ASM"
F200                
F200                ;	LSX-Dodgers DPB
F200                ;	X1/turbo/Z
F200                
F200                DEVICE:
F200                
F200                ;	A:
F200                
F200 02 00          	DW	2	;DPB_00_FATLN
F202 EB F0          	DW	_FDRD	;DPB_02_DRD
F204 EE F0          	DW	_FDWT	;DPB_04_DWT
F206 FD             	DB	0FDH	;DPB_06_FATID
F207 02             	DB	2	;DPB_07_SECPCL
F208 64 01          	DW	356	;DPB_08_MAXCL
F20A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F20B 07             	DB	7	;DPB_0B_DIRSCNT
F20C 28             	DB	40	;DPB_0C_MAXCYL
F20D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F20E 01             	DB	1	;DPB_0E_FATPS
F20F 82             	DB	082H	;DPB_0F_BPS
F210 05 00          	DW	5	;DPB_10_DIRPS
F212 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F213 00             	DB	0	;DPB_13_UNITNO
F214 08 00          	DW	8	;DPB_14_ADDCL16
F216 00 00          	DW	0	;DPB_16
F218 00 00          	DW	0	;DPB_18
F21A 00 00          	DW	0	;DPB_1A_SDIR
F21C 46 44 44 30    	DB	"FDD0"	;DPB_1C_NAME
F220                
F220                ;	B:
F220                
F220 02 00          	DW	2	;DPB_00_FATLN
F222 EB F0          	DW	_FDRD	;DPB_02_DRD
F224 EE F0          	DW	_FDWT	;DPB_04_DWT
F226 FD             	DB	0FDH	;DPB_06_FATID
F227 02             	DB	2	;DPB_07_SECPCL
F228 64 01          	DW	356	;DPB_08_MAXCL
F22A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F22B 07             	DB	7	;DPB_0B_DIRSCNT
F22C 28             	DB	40	;DPB_0C_MAXCYL
F22D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F22E 01             	DB	1	;DPB_0E_FATPS
F22F 82             	DB	082H	;DPB_0F_BPS
F230 05 00          	DW	5	;DPB_10_DIRPS
F232 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F233 01             	DB	1	;DPB_13_UNITNO
F234 08 00          	DW	8	;DPB_14_ADDCL16
F236 00 00          	DW	0	;DPB_16
F238 00 00          	DW	0	;DPB_18
F23A 00 00          	DW	0	;DPB_1A_SDIR
F23C 46 44 44 31    	DB	"FDD1"	;DPB_1C_NAME
F240                
F240                ;	C:
F240                
F240 02 00          	DW	2	;DPB_00_FATLN
F242 EB F0          	DW	_FDRD	;DPB_02_DRD
F244 EE F0          	DW	_FDWT	;DPB_04_DWT
F246 FD             	DB	0FDH	;DPB_06_FATID
F247 02             	DB	2	;DPB_07_SECPCL
F248 64 01          	DW	356	;DPB_08_MAXCL
F24A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F24B 07             	DB	7	;DPB_0B_DIRSCNT
F24C 28             	DB	40	;DPB_0C_MAXCYL
F24D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F24E 01             	DB	1	;DPB_0E_FATPS
F24F 82             	DB	082H	;DPB_0F_BPS
F250 05 00          	DW	5	;DPB_10_DIRPS
F252 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F253 02             	DB	2	;DPB_13_UNITNO
F254 08 00          	DW	8	;DPB_14_ADDCL16
F256 00 00          	DW	0	;DPB_16
F258 00 00          	DW	0	;DPB_18
F25A 00 00          	DW	0	;DPB_1A_SDIR
F25C 46 44 44 32    	DB	"FDD2"	;DPB_1C_NAME
F260                
F260                ;	D:
F260                
F260 02 00          	DW	2	;DPB_00_FATLN
F262 EB F0          	DW	_FDRD	;DPB_02_DRD
F264 EE F0          	DW	_FDWT	;DPB_04_DWT
F266 FD             	DB	0FDH	;DPB_06_FATID
F267 02             	DB	2	;DPB_07_SECPCL
F268 64 01          	DW	356	;DPB_08_MAXCL
F26A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F26B 07             	DB	7	;DPB_0B_DIRSCNT
F26C 28             	DB	40	;DPB_0C_MAXCYL
F26D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F26E 01             	DB	1	;DPB_0E_FATPS
F26F 82             	DB	082H	;DPB_0F_BPS
F270 05 00          	DW	5	;DPB_10_DIRPS
F272 A7             	DB	0A7H	;DPB_12_DEVICE
F273 03             	DB	3	;DPB_13_UNITNO
F274 08 00          	DW	8	;DPB_14_ADDCL16
F276 00 00          	DW	0	;DPB_16
F278 00 00          	DW	0	;DPB_18
F27A 00 00          	DW	0	;DPB_1A_SDIR
F27C 46 44 44 33    	DB	"FDD3"	;DPB_1C_NAME
F280                
F280                ;	E:
F280                
F280 00 00          EMMFL:	DW	0	;DPB_00_FATLN
F282 E8 D7          EMMRD:	DW	EDRD	;DPB_02_DRD
F284 E4 D7          EMMWR:	DW	EDWT	;DPB_04_DWT
F286 FE             	DB	0FEH	;DPB_06_FATID
F287 02             	DB	2	;DPB_07_SECPCL
F288 00 00          EMMCL:	DW	0	;DPB_08_MAXCL
F28A 00             	DB	0	;DPB_0A_FDMODE
F28B 0C             	DB	12	;DPB_0B_DIRSCNT
F28C 00             	DB	0	;DPB_0C_MAXCYL
F28D 00             	DB	0	;DPB_0D_MAXSEC
F28E 02             	DB	2	;DPB_0E_FATPS
F28F 02             	DB	2	;DPB_0F_BPS
F290 0A 00          	DW	10	;DPB_10_DIRPS
F292 06             EMMDV:	DB	6	;DPB_12_DEVICE
F293 00             	DB	0	;DPB_13_UNITNO
F294 12 00          	DW	18	;DPB_14_ADDCL16
F296 00 00          	DW	0	;DPB_16
F298 00 00          	DW	0	;DPB_18
F29A 00 00          	DW	0	;DPB_1A_SDIR
F29C 45 4D 4D 30    	DB	"EMM0"	;DPB_1C_NAME
F2A0                
F2A0                ;	F:
F2A0                
F2A0 00 00          BANKFL:	DW	0	;DPB_00_FATLN
F2A2 7C D7          	DW	BDRD	;DPB_02_DRD
F2A4 78 D7          	DW	BDWT	;DPB_04_DWT
F2A6 F9             	DB	0F9H	;DPB_06_FATID
F2A7 02             	DB	2	;DPB_07_SECPCL
F2A8 00 00          BANKCL:	DW	0	;DPB_08_MAXCL
F2AA 00             	DB	0	;DPB_0A_FDMODE
F2AB 08             	DB	8	;DPB_0B_DIRSCNT
F2AC 00             	DB	0	;DPB_0C_MAXCYL
F2AD 01             	DB	1	;DPB_0D_MAXSEC
F2AE 00             	DB	0	;DPB_0E_FATPS
F2AF 02             	DB	2	;DPB_0F_BPS
F2B0 02 00          	DW	2	;DPB_10_DIRPS
F2B2 0B             BANKDV:	DB	00BH	;DPB_12_DEVICE
F2B3 00             	DB	0	;DPB_13_UNITNO
F2B4 06 00          	DW	6	;DPB_14_ADDCL16
F2B6 00 00          	DW	0	;DPB_16
F2B8 00 00          	DW	0	;DPB_18
F2BA 00 00          	DW	0	;DPB_1A_SDIR
F2BC 42 52 41 4D    	DB	"BRAM"	;DPB_1C_NAME
F2C0                
F2C0                ;	G:
F2C0                
F2C0 02 00          	DW	2	;DPB_00_FATLN
F2C2 39 D7          	DW	GDRD	;DPB_02_DRD
F2C4 50 D7          	DW	GDWT	;DPB_04_DWT
F2C6 FA             	DB	0FAH	;DPB_06_FATID
F2C7 01             	DB	1	;DPB_07_SECPCL
F2C8 B8 00          	DW	184	;DPB_08_MAXCL
F2CA 00             	DB	0	;DPB_0A_FDMODE
F2CB 07             	DB	7	;DPB_0B_DIRSCNT
F2CC 00             	DB	0	;DPB_0C_MAXCYL
F2CD 01             	DB	1	;DPB_0D_MAXSEC
F2CE 01             	DB	1	;DPB_0E_FATPS
F2CF 01             	DB	1	;DPB_0F_BPS
F2D0 03 00          	DW	3	;DPB_10_DIRPS
F2D2 05             	DB	5	;DPB_12_DEVICE
F2D3 01             	DB	1	;DPB_13_UNITNO
F2D4 08 00          	DW	8	;DPB_14_ADDCL16
F2D6 00 00          	DW	0	;DPB_16
F2D8 00 00          	DW	0	;DPB_18
F2DA 00 00          	DW	0	;DPB_1A_SDIR
F2DC 47 52 41 4D    	DB	"GRAM"	;DPB_1C_NAME
F2E0                
F2E0                ;	H:
F2E0                	DS	32-8
F2F8 00             	DB	0
F2F9                
F2F9                LAST_ADR:
F2F9                
F2F9                	END
F2F9                
