0000                ;	LSX-Dodgers for X1/turbo/Z
0000                ;	Programmed by
0000                ;	Gaku (Lovers/Tablacus)
0000                
0000                	INCLUDE	"X1DEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                ;	X1/turbo/Z
0000                
0000 00 00 00 00    MAC	EQU	0		;X1
0000 00 00 00 00    DEV EQU 0
0000                
0000 00 00 CB 00    RUN	EQU	0CB00H
0000 00 00 D1 06    BDOS	EQU	0D106H
0000 00 00 EF 00    WORKAD	EQU	0EF00H
0000 00 00 F2 00    FATBF	EQU	0F200H
0000 00 00 FA 00    DTBUF	EQU	0FA00H
0000 00 00 FE 00    KEYBF	EQU	0FE00H
0000 00 00 FF 00    KBUF	EQU	0FF00H
0000 00 00 FF CA    EXTSP	EQU	0FFCAH
0000 00 00 FF D9    TRAP38	EQU	0FFD9H
0000 00 00 00 50    WIDTH	EQU	80
0000 00 00 00 18    LINE	EQU	24
0000 00 00 00 07    COLORF	EQU	7
0000 00 00 00 09    COMS	EQU	9
0000                
0000                	INCLUDE	"LDDEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                
0000 00 00 00 01    VER_1   EQU	1
0000 00 00 00 04    VER_2   EQU	4
0000 00 00 00 08    VER_3   EQU	8
0000 00 00 1D 00    MACW	EQU	MAC + 01D00H	;機種フラグとLD判別フラグ
0000 00 00 00 00    MACD	EQU	MAC + DEV * 256	;機種フラグとデバイスフラグ
0000 00 00 01 48    VER	EQU	VER_1 * 256 + VER_2 * 16 + VER_3
0000                
0000 00 00 00 05    SYSTEM	EQU	00005H
0000 00 00 00 0F    JP_HL	EQU	0000FH
0000 00 00 00 5C    FCB1	EQU	0005CH
0000 00 00 00 6C    FCB2	EQU	0006CH
0000 00 00 00 5D    FCB1FN	EQU	FCB1+1
0000 00 00 00 6D    FCB2FN	EQU	FCB2+1
0000 00 00 00 80    DTA1	EQU	00080H
0000                
0000 00 00 FF CA    EXTBIO	EQU	0FFCAH
0000                
0000                
0000                	ORG	RUN-7
CAF9                
CAF9                ;	MSX BINARY HEADER
CAF9 FE             	DB	0FEH
CAFA                ;	MSX BINARY START ADDRESS
CAFA 00 CB          	DW	RUN
CAFC                ;	MSX BINARY END ADDRESS
CAFC F9 F1          	DW	LAST_ADR
CAFE                ;	MSX BINARY EXEC ADDRESS
CAFE 07 CB          	DW	START
CB00                
CB00                	INCLUDE	"X1INIT.ASM"
CB00                
CB00                ;	LSX-Dodgers INIT
CB00                ;	X1/turbo/Z
CB00                
CB00 C3 07 CB       	JP	START
CB03 00 1D          	DW	MACW
CB05 48 01          	DW	VER
CB07                
CB07                START:
CB07 F3             	DI
CB08 ED 5E          	IM	2
CB0A 31 CA FF       	LD	SP,EXTSP
CB0D CD 1B CB       	CALL	INIT		;NZならAUTOEXECを実行
CB10 21 00 00       	LD	HL,0
CB13 E5             	PUSH	HL
CB14 C8             	RET	Z
CB15 11 B2 CE       	LD	DE,AUTOD
CB18 C3 FD EF       	JP	_COMANL
CB1B                
CB1B                INIT:
CB1B 3E 1E          	LD	A,01EH
CB1D D3 00          	OUT	(0),A
CB1F                
CB1F 01 00 00       	LD	BC,0
CB22 ED 43 8C EF    	LD	(_CTC),BC
CB26 01 04 0A       	LD	BC,00A04H
CB29 CD 5C CE       	CALL	CHKCTC
CB2C 01 04 07       	LD	BC,00704H
CB2F CD 5C CE       	CALL	CHKCTC
CB32 01 A8 1F       	LD	BC,01FA8H
CB35 CD 5C CE       	CALL	CHKCTC
CB38 01 A0 1F       	LD	BC,01FA0H
CB3B CD 5C CE       	CALL	CHKCTC
CB3E                ;
CB3E                INISIO:
CB3E 01 91 1F       	LD	BC,01F91H	;INIT SIO
CB41 16 01          	LD	D,1
CB43 ED 51          	OUT	(C),D
CB45                
CB45 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB47 0E 93          	LD	C,093H
CB49 ED 51          	OUT	(C),D
CB4B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB4D 0E 99          	LD	C,099H		;INIT SIO
CB4F 16 01          	LD	D,1
CB51 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB53 0E 9B          	LD	C,09BH
CB55 ED 51          	OUT	(C),D
CB57 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB59                
CB59 0E 80          	LD	C,080H		;INIT DMA
CB5B 21 06 C3       	LD	HL,0C306H
CB5E                INIDMA:
CB5E ED 61          	OUT	(C),H
CB60 2D             	DEC	L
CB61 20 FB          	JR	NZ,INIDMA
CB63                
CB63 3E E4          	LD	A,0E4H
CB65 CD 99 DE       	CALL	COMOUT
CB68 AF             	XOR	A
CB69 CD 73 DE       	CALL	OT49SB
CB6C                
CB6C 3E EF          	LD	A,INTVEC/256
CB6E ED 47          	LD	I,A
CB70                
CB70 ED 4B 8C EF    	LD	BC,(_CTC)
CB74 0B             	DEC	BC
CB75 0B             	DEC	BC
CB76                
CB76 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB78 3E C0          	LD	A,CTC0
CB7A ED 79          	OUT	(C),A
CB7C                
CB7C 0C             	INC	C
CB7D 3E 47          	LD	A,047H
CB7F ED 79          	OUT	(C),A
CB81 3E 0D          	LD	A,13		;Baudrate 9600-13
CB83 ED 79          	OUT	(C),A
CB85                
CB85 79             	LD	A,C
CB86 D6 10          	SUB	010H
CB88 4F             	LD	C,A
CB89                ;	LD	(SIOAD+1),BC
CB89                ;	LD	(SIOAD0+1),BC
CB89                ;	LD	(SIOAD1+1),BC
CB89                
CB89 21 02 CF       	LD	HL,SIODATA
CB8C                SINIT1:
CB8C 7E             	LD	A,(HL)
CB8D 23             	INC	HL
CB8E FE FF          	CP	0FFH
CB90 28 04          	JR	Z,SINIT2
CB92 ED 79          	OUT	(C),A
CB94 18 F6          	JR	SINIT1
CB96                SINIT2:
CB96 3E E4          	LD	A,0E4H
CB98 CD 99 DE       	CALL	COMOUT
CB9B 3E C8          	LD	A,INTVEC
CB9D CD 73 DE       	CALL	OT49SB
CBA0                ;
CBA0 01 C4 1F       	LD	BC,01FC4H
CBA3 3E 0C          	LD	A,00CH
CBA5 ED 79          	OUT	(C),A
CBA7                
CBA7 0E C0          	LD	C,0C0H
CBA9 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBAB                
CBAB 0C             	INC	C
CBAC 3E 28          	LD	A,40
CBAE ED 79          	OUT	(C),A
CBB0                
CBB0 0C             	INC	C
CBB1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBB3                
CBB3 0C             	INC	C
CBB4 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBB6                
CBB6 0E C5          	LD	C,0C5H
CBB8 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBBA                
CBBA                TEXT:
CBBA 0E B0          	LD	C,0B0H
CBBC 3E 80          	LD	A,080H
CBBE ED 79          	OUT	(C),A
CBC0 16 07          	LD	D,7
CBC2 0E B9          	LD	C,0B9H
CBC4 21 FB CE       	LD	HL,TEXTDT
CBC7                TEXT1:
CBC7 04             	INC	B
CBC8 ED A3          	OUTI
CBCA 0C             	INC	C
CBCB 15             	DEC	D
CBCC 20 F9          	JR	NZ,TEXT1
CBCE 01 B0 1F       	LD	BC,01FB0H
CBD1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBD3                
CBD3 0E C4          	LD	C,0C4H
CBD5 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBD7                
CBD7 01 01 1A       	LD	BC,01A01H
CBDA ED 78          	IN	A,(C)
CBDC E6 08          	AND	8
CBDE 28 09          	JR	Z,PRN
CBE0 0E 03          	LD	C,003H
CBE2 3E 0F          	LD	A,00FH
CBE4 ED 79          	OUT	(C),A
CBE6 01 04 0A       	LD	BC,00A04H
CBE9                PRN:
CBE9 21 00 00       	LD	HL,0
CBEC 06 5C          	LD	B,05CH
CBEE 3E FF          	LD	A,0FFH		;RST 38H
CBF0 CD F1 E0       	CALL	FILL_MEMORY
CBF3 06 A4          	LD	B,0A4H
CBF5 AF             	XOR	A
CBF6 CD F1 E0       	CALL	FILL_MEMORY
CBF9                
CBF9 3E C3          	LD	A,0C3H		;JP
CBFB 21 03 EF       	LD	HL,CPM_WBOOT
CBFE 32 00 00       	LD	(00000H),A
CC01 22 01 00       	LD	(00001H),HL	;IPL
CC04                
CC04 21 00 1D       	LD	HL,MACW	;3 bit7  DPB Compatible LA(1)
CC07 22 03 00       	LD	(00003H),HL	;  bit6-0 Machine X1(0)
CC0A                ;				;4 LSX-Dodgers(01DH)
CC0A 21 06 D1       	LD	HL,BDOS
CC0D 32 05 00       	LD	(00005H),A
CC10 22 06 00       	LD	(00006H),HL	;BDOS
CC13                
CC13 21 96 DA       	LD	HL,BIOS
CC16 22 19 00       	LD	(00019H),HL	;BIOS-ROM
CC19                
CC19 21 D9 FF       	LD	HL,TRAP38	;TRAP38
CC1C 32 38 00       	LD	(00038H),A
CC1F 22 39 00       	LD	(00039H),HL	;RST 038H
CC22                
CC22 3E EF          	LD	A,CPM_BOOT/256
CC24 32 0B 00       	LD	(0000BH),A
CC27                
CC27 3E E9          	LD	A,0E9H		;JP (HL)
CC29 32 0F 00       	LD	(0000FH),A
CC2C                
CC2C 3A 7D F0       	LD	A,(_FATBF+1)
CC2F 32 13 00       	LD	(00013H),A
CC32                
CC32 3A 7F F0       	LD	A,(_DTBUF+1)
CC35 32 17 00       	LD	(00017H),A
CC38                
CC38 3E FE          	LD	A,KEYBF/256
CC3A 32 1B 00       	LD	(0001BH),A
CC3D                
CC3D 3E FF          	LD	A,KBUF/256
CC3F 32 1F 00       	LD	(0001FH),A
CC42                
CC42 21 48 01       	LD	HL,VER
CC45 22 5A 00       	LD	(0005AH),HL
CC48                
CC48 3E E6          	LD	A,0E6H
CC4A CD 99 DE       	CALL	COMOUT
CC4D CD 7E DE       	CALL	IN49SB
CC50 F5             	PUSH	AF
CC51 CD 7E DE       	CALL	IN49SB
CC54 F1             	POP	AF
CC55 F5             	PUSH	AF
CC56 E6 12          	AND	012H
CC58 20 05          	JR	NZ,KEYR
CC5A 3E 01          	LD	A,1
CC5C 32 B2 CD       	LD	(KEYREP+1),A
CC5F                KEYR:
CC5F F1             	POP	AF
CC60 E6 03          	AND	3
CC62 28 0E          	JR	Z,NON
CC64                
CC64 01 D0 3F       	LD	BC,03FD0H
CC67 ED 49          	OUT	(C),C
CC69 3E 37          	LD	A,037H
CC6B D3 D0          	OUT	(0D0H),A
CC6D ED 78          	IN	A,(C)
CC6F B9             	CP	C
CC70 28 65          	JR	Z,TURBO
CC72                NON:
CC72 21 0E CF       	LD	HL,AT_SCR1
CC75 11 23 DF       	LD	DE,SCR1
CC78 01 94 00       	LD	BC,SCRNE-SCR1	;転送先のサイズ確認用
CC7B 01 85 00       	LD	BC,AT_SCRE-AT_SCR1
CC7E ED B0          	LDIR
CC80                
CC80 21 93 CF       	LD	HL,AT_DWT
CC83 11 67 EE       	LD	DE,WTTRK
CC86 01 8F 00       	LD	BC,DMAE-WTTRK	;転送先のサイズ確認用
CC89 01 8E 00       	LD	BC,AT_CPUE-AT_DWT
CC8C ED B0          	LDIR
CC8E                
CC8E 21 21 D0       	LD	HL,AT_EDWT
CC91 11 69 D7       	LD	DE,EDWT
CC94 01 4B 00       	LD	BC,EMME-EDWT	;転送先のサイズ確認用
CC97 01 46 00       	LD	BC,AT_EMME-AT_EDWT
CC9A ED B0          	LDIR
CC9C                
CC9C 21 9E DF       	LD	HL,AT_WTTRK+AT_RS
CC9F 22 E9 EF       	LD	(_WTTRK+1),HL
CCA2 21 B0 EE       	LD	HL,AT_DRD+AT_R
CCA5 22 EC EF       	LD	(_FDRD+1),HL
CCA8 21 67 EE       	LD	HL,AT_DWT+AT_R
CCAB 22 EF EF       	LD	(_FDWT+1),HL
CCAE 21 7D D7       	LD	HL,AT_EDRD+AT_RE
CCB1 22 82 F1       	LD	(EMMRD),HL
CCB4 21 69 D7       	LD	HL,AT_EDWT+AT_RE
CCB7 22 84 F1       	LD	(EMMWR),HL
CCBA 21 A5 DF       	LD	HL,AT_SCRN+AT_RS
CCBD 22 D1 EF       	LD	(_SCRN+1),HL
CCC0                
CCC0 3E 27          	LD	A,027H			;ノンターボはMFM切り替えを行わない
CCC2 32 12 F1       	LD	(DEVICE+012H),A		;Aドライブ
CCC5 32 32 F1       	LD	(DEVICE+012H+32),A	;Bドライブ
CCC8 32 52 F1       	LD	(DEVICE+012H+32*2),A	;Cドライブ
CCCB 32 72 F1       	LD	(DEVICE+012H+32*3),A	;Dドライブ
CCCE                
CCCE 21 00 00       	LD	HL,0
CCD1 22 C4 DE       	LD	(X1PAT),HL
CCD4 C3 60 CD       	JP	NOBANK
CCD7                
CCD7                TURBO:
CCD7 F3             	DI			;Check BIOS
CCD8 06 1D          	LD	B,01DH
CCDA ED 79          	OUT	(C),A		;BIOS ON
CCDC 3A 51 2F       	LD	A,(02F51H)
CCDF 04             	INC	B		;B=01EH
CCE0 ED 79          	OUT	(C),A		;BIOS OFF
CCE2 FB             	EI
CCE3 FE C9          	CP	0C9H
CCE5 28 02          	JR	Z,BIOSOK
CCE7 18 05          	JR	NOBIOS
CCE9                BIOSOK:
CCE9 3E C3          	LD	A,0C3H		;JP
CCEB 32 18 00       	LD	(00018H),A
CCEE                NOBIOS:
CCEE 3E 1F          	LD	A,01FH		;スタートポート
CCF0 DB F0          	IN	A,(0F0H)
CCF2 0F             	RRCA
CCF3 38 0B          	JR	C,CRT1
CCF5 21 EB CE       	LD	HL,_C8025H
CCF8 11 B0 EF       	LD	DE,CRTCD
CCFB 01 10 00       	LD	BC,16
CCFE ED B0          	LDIR
CD00                CRT1:
CD00 3E 1F          	LD	A,01FH		;スタートポート
CD02 DB F0          	IN	A,(0F0H)
CD04 CB 57          	BIT	2,A
CD06 28 18          	JR	Z,BANK
CD08                
CD08 AF             	XOR	A
CD09                TZ1:				;前面スイッチが2HDの場合はMFMモードを2HDにしておく
CD09 F5             	PUSH	AF
CD0A CD DC EF       	CALL	_GETDPB
CD0D DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
CD10 E6 8F          	AND	08FH
CD12 FE 87          	CP	087H		;フロッピーでMEM切り替えがON
CD14 20 04          	JR	NZ,TZ2
CD16 DD CB 0A 86    	RES	0,(IX+0AH)	;(DPB_0A_FDMODE)
CD1A                TZ2:
CD1A F1             	POP	AF
CD1B 3C             	INC	A
CD1C FE 08          	CP	8
CD1E 38 E9          	JR	C,TZ1
CD20                
CD20                BANK:
CD20 01 00 0B       	LD	BC,00B00H
CD23 21 00 7F       	LD	HL,07F00H
CD26 F3             	DI
CD27 ED 69          	OUT	(C),L
CD29 3A 00 00       	LD	A,(0)
CD2C FE EB          	CP	0EBH
CD2E 20 05          	JR	NZ,BANK1
CD30 3E 2B          	LD	A,02BH
CD32 32 B2 F1       	LD	(BANKDV),A
CD35                BANK1:
CD35 ED 69          	OUT	(C),L
CD37 5E             	LD	E,(HL)
CD38 7B             	LD	A,E
CD39 C6 A5          	ADD	A,0A5H
CD3B 77             	LD	(HL),A
CD3C BE             	CP	(HL)
CD3D 73             	LD	(HL),E
CD3E 20 05          	JR	NZ,BANK2
CD40 2C             	INC	L
CD41 CB 65          	BIT	4,L
CD43 28 F0          	JR	Z,BANK1
CD45                BANK2:
CD45 3E 10          	LD	A,010H
CD47 ED 79          	OUT	(C),A
CD49 7D             	LD	A,L
CD4A B7             	OR	A
CD4B 28 13          	JR	Z,NOBANK
CD4D 26 00          	LD	H,0
CD4F 29             	ADD	HL,HL	;*2
CD50 29             	ADD	HL,HL	;*4
CD51 29             	ADD	HL,HL	;*8
CD52 29             	ADD	HL,HL	;*16
CD53 29             	ADD	HL,HL	;*32
CD54 2B             	DEC	HL	;-1
CD55 2B             	DEC	HL	;-2
CD56 2B             	DEC	HL	;-3
CD57 22 A8 F1       	LD	(BANKCL),HL
CD5A CD A2 CE       	CALL	CALC_FATLN
CD5D 32 A0 F1       	LD	(BANKFL),A
CD60                NOBANK:
CD60                EMM:
CD60 DD 21 80 F1    	LD	IX,EMMFL
CD64 CD 53 CE       	CALL	EADR0
CD67 ED 78          	IN	A,(C)
CD69 F5             	PUSH	AF
CD6A                
CD6A 11 00 00       	LD	DE,0
CD6D                ECHECK1:
CD6D 13             	INC	DE
CD6E CD 37 CE       	CALL	EADR2
CD71 ED 60          	IN	H,(C)
CD73 CD 37 CE       	CALL	EADR2
CD76 7C             	LD	A,H
CD77 C6 E5          	ADD	A,0E5H
CD79 ED 79          	OUT	(C),A
CD7B 3C             	INC	A
CD7C CD 53 CE       	CALL	EADR0
CD7F ED 79          	OUT	(C),A
CD81 3D             	DEC	A
CD82 CD 37 CE       	CALL	EADR2
CD85 ED 68          	IN	L,(C)
CD87 CD 37 CE       	CALL	EADR2
CD8A ED 61          	OUT	(C),H
CD8C BD             	CP	L
CD8D 20 04          	JR	NZ,ECHECK2
CD8F CB 5A          	BIT	3,D
CD91 28 DA          	JR	Z,ECHECK1
CD93                ECHECK2:
CD93 CD 53 CE       	CALL	EADR0
CD96 F1             	POP	AF
CD97 ED 79          	OUT	(C),A
CD99 FE EB          	CP	0EBH
CD9B 20 05          	JR	NZ,EMM_BPB
CD9D 3E 26          	LD	A,026H
CD9F 32 92 F1       	LD	(EMMDV),A
CDA2                EMM_BPB:
CDA2 21 F7 FF       	LD	HL,0-9
CDA5 19             	ADD	HL,DE
CDA6 30 09          	JR	NC,NOEMM
CDA8 22 88 F1       	LD	(EMMCL),HL
CDAB CD A2 CE       	CALL	CALC_FATLN
CDAE 32 80 F1       	LD	(EMMFL),A
CDB1                NOEMM:
CDB1 3E 00          KEYREP:	LD	A,000H
CDB3 B7             	OR	A
CDB4 28 07          	JR	Z,KEYR1
CDB6 01 00 00       	LD	BC,0
CDB9 ED 43 8C EF    	LD	(_CTC),BC
CDBD                KEYR1:
CDBD CD 83 CE       	CALL	SETCRTC
CDC0 01 30 F8       	LD	BC,0-80*25
CDC3 2A BA EF       	LD	HL,(_PAGE_MINUS)
CDC6 ED 43 BA EF    	LD	(_PAGE_MINUS),BC
CDCA 1E 0C          	LD	E,00CH
CDCC CD CD EF       	CALL	_PRINT
CDCF 22 BA EF       	LD	(_PAGE_MINUS),HL
CDD2                
CDD2 21 BE CE       	LD	HL,INIMES
CDD5 CD 0D D8       	CALL	MSX
CDD8                
CDD8 3A 87 FF       	LD	A,(0FF87H)
CDDB FE 08          	CP	8
CDDD 30 1E          	JR	NC,INIT0
CDDF 5F             	LD	E,A
CDE0 C6 41          	ADD	A,'A'
CDE2 32 BB CE       	LD	(AUTODV),A
CDE5 0E 0E          	LD	C,00EH
CDE7 CD 05 00       	CALL	SYSTEM
CDEA 1C             	INC	E
CDEB 21 85 EF       	LD	HL,_SEEKSP	;Disk error Ignore
CDEE CB FE          	SET	7,(HL)
CDF0 0E 1B          	LD	C,01BH
CDF2 CD 05 00       	CALL	SYSTEM
CDF5                
CDF5 21 85 EF       	LD	HL,_SEEKSP
CDF8 CB BE          	RES	7,(HL)
CDFA                
CDFA 3C             	INC	A
CDFB 20 08          	JR	NZ,INIT1
CDFD                INIT0:
CDFD 1E 00          	LD	E,0
CDFF 0E 0E          	LD	C,00EH
CE01 CD 05 00       	CALL	SYSTEM
CE04 AF             	XOR	A
CE05                INIT1:
CE05 F3             	DI
CE06 08             	EX	AF,AF'
CE07 2E FE          	LD	L,0-2		;CALLのスタック分減らす
CE09 39             	ADD	HL,SP
CE0A 11 00 FF       	LD	DE,0FF00H
CE0D 45             	LD	B,L
CE0E CD E8 D4       	CALL	ZERO_MEMORY_DE
CE11 21 CA FF       	LD	HL,EXTSP
CE14 06 0F          	LD	B,TRAP38-EXTBIO
CE16 3E FF          	LD	A,0FFH		;RST 38H
CE18 CD F1 E0       	CALL	FILL_MEMORY
CE1B 21 67 D0       	LD	HL,AT_TRAP38
CE1E 11 D9 FF       	LD	DE,TRAP38
CE21 01 27 00       	LD	BC,AT_TRAPE-AT_TRAP38
CE24 ED B0          	LDIR
CE26 08             	EX	AF,AF'
CE27 B7             	OR	A
CE28 C8             	RET	Z
CE29                
CE29 3E E6          	LD	A,0E6H
CE2B CD 99 DE       	CALL	COMOUT
CE2E CD 7E DE       	CALL	IN49SB
CE31 CD 7E DE       	CALL	IN49SB
CE34 FE 1B          	CP	01BH
CE36 C9             	RET
CE37                
CE37                EADR2:
CE37 D5             	PUSH	DE
CE38 EB             	EX	DE,HL
CE39 29             	ADD	HL,HL
CE3A 29             	ADD	HL,HL
CE3B DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
CE3E DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
CE41 09             	ADD	HL,BC
CE42 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
CE45 06 0D          	LD	B,00DH
CE47 ED 49          	OUT	(C),C
CE49 0C             	INC	C
CE4A ED 69          	OUT	(C),L
CE4C 0C             	INC	C
CE4D ED 61          	OUT	(C),H
CE4F 0C             	INC	C
CE50 EB             	EX	DE,HL
CE51 D1             	POP	DE
CE52 C9             	RET
CE53                
CE53                EADR0:
CE53 D5             	PUSH	DE
CE54 11 00 00       	LD	DE,0
CE57 CD 37 CE       	CALL	EADR2
CE5A D1             	POP	DE
CE5B C9             	RET
CE5C                
CE5C                CHKCTC:
CE5C C5             	PUSH	BC
CE5D 11 03 47       	LD	DE,04703H
CE60                INICTC1:
CE60 0C             	INC	C
CE61 ED 51          	OUT	(C),D
CE63 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CE65 1D             	DEC	E
CE66 20 F8          	JR	NZ,INICTC1
CE68 C1             	POP	BC
CE69                
CE69 11 FA 07       	LD	DE,007FAH
CE6C ED 51          	OUT	(C),D
CE6E ED 59          	OUT	(C),E
CE70 ED 78          	IN	A,(C)
CE72 BB             	CP	E
CE73 C0             	RET	NZ
CE74 ED 51          	OUT	(C),D
CE76 ED 51          	OUT	(C),D
CE78 ED 78          	IN	A,(C)
CE7A BA             	CP	D
CE7B C0             	RET	NZ
CE7C 03             	INC	BC
CE7D 03             	INC	BC
CE7E ED 43 8C EF    	LD	(_CTC),BC
CE82 C9             	RET
CE83                
CE83                SETCRTC:
CE83 21 B0 EF       	LD	HL,CRTCD
CE86 AF             	XOR	A
CE87                SETCRT1:
CE87 01 00 18       	LD	BC,01800H
CE8A ED 79          	OUT	(C),A
CE8C 0C             	INC	C
CE8D 04             	INC	B
CE8E ED A3          	OUTI
CE90 3C             	INC	A
CE91 FE 0C          	CP	12
CE93 20 F2          	JR	NZ,SETCRT1
CE95 23             	INC	HL
CE96 23             	INC	HL
CE97 01 03 1B       	LD	BC,01A03H+00100H
CE9A ED A3          	OUTI
CE9C 01 D0 20       	LD	BC,01FD0H+00100H
CE9F ED A3          	OUTI
CEA1 C9             	RET
CEA2                
CEA2                CALC_FATLN:	;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
CEA2 5D             	LD	E,L
CEA3 54             	LD	D,H
CEA4 29             	ADD	HL,HL	;*2
CEA5 19             	ADD	HL,DE	;*3
CEA6 CB 3C          	SRL	H	;/2
CEA8 CB 1D          	RR	L	;1クラスタ辺り1.5バイト必要
CEAA 11 FF 01       	LD	DE,511	;切り上げる
CEAD 19             	ADD	HL,DE
CEAE 7C             	LD	A,H
CEAF CB 3F          	SRL	A
CEB1 C9             	RET
CEB2                
CEB2 41 55 54 4F    AUTOD:	DB	"AUTOEXEC "
CEB6 45 58 45 43
CEBA 20
CEBB 41 3A 00       AUTODV:	DB	"A:",0
CEBE                
CEBE 4C 53 58 2D    INIMES:	DB	"LSX-Dodgers for X1/turbo version "
CEC2 44 6F 64 67
CEC6 65 72 73 20
CECA 66 6F 72 20
CECE 58 31 2F 74
CED2 75 72 62 6F
CED6 20 76 65 72
CEDA 73 69 6F 6E
CEDE 20
CEDF 31 2E          	DB	030H + VER_1, '.'
CEE1 34 38          	DB	030H + VER_2 ,030H + VER_3
CEE3                ;	DB	"PR3"
CEE3 20 47 61 6B    	DB	' Gaku',0DH,0AH
CEE7 75 0D 0A
CEEA 00             	DB	0
CEEB                
CEEB                _C8025H:
CEEB 6B 50 59 88    	DB	06BH,050H,059H,088H,01BH,001H,019H,01AH
CEEF 1B 01 19 1A
CEF3 00 0F          	DB	000H,00FH
CEF5 80 F8 B0 FF    	DW	0-80*LINE,0-80
CEF9 0C 23          	DB	00CH,023H
CEFB                
CEFB 03 0C 0F 30    TEXTDT:	DB	003H,00CH,00FH,030H,033H,03CH,03FH
CEFF 33 3C 3F
CF02                
CF02                SIODATA:
CF02 18             	DB	018H
CF03 01 00          	DB	1,0
CF05 02 00          	DB	2,0
CF07 03 C1          	DB	3,0C1H
CF09 04 44          	DB	4,044H
CF0B 05 E8          	DB	5,0E8H
CF0D FF             	DB	0FFH
CF0E                
CF0E                ;	ノンターボ用パッチ
CF0E                
CF0E                AT_SCR1:
CF0E D9             	EXX
CF0F C5             	PUSH	BC
CF10 ED 4B B1 EF    	LD	BC,(_WIDTH)
CF14 06 20          	LD	B,020H
CF16 D9             	EXX
CF17 C5             	PUSH	BC
CF18 01 00 20       	LD	BC,02000H
CF1B                
CF1B 67             	LD	H,A
CF1C B7             	OR	A
CF1D                AT_SCRUP1:
CF1D 28 15          	JR	Z,AT_SCRCL
CF1F C5             	PUSH	BC
CF20 CB E0          	SET	4,B
CF22 D9             	EXX
CF23 C5             	PUSH	BC
CF24 CB E0          	SET	4,B
CF26 D9             	EXX
CF27 CD 54 DF       	CALL	AT_UPSUB+AT_RS
CF2A D9             	EXX
CF2B C1             	POP	BC
CF2C D9             	EXX
CF2D C1             	POP	BC
CF2E CD 54 DF       	CALL	AT_UPSUB+AT_RS
CF31 25             	DEC	H
CF32 18 E9          	JR	AT_SCRUP1
CF34                
CF34                AT_SCRCL:
CF34 2A B1 EF       	LD	HL,(_WIDTH)
CF37 CD EA DD       	CALL	LINECL
CF3A C1             	POP	BC
CF3B D9             	EXX
CF3C C1             	POP	BC
CF3D D9             	EXX
CF3E C9             	RET
CF3F                
CF3F                AT_UPSUB:
CF3F 3A B1 EF       	LD	A,(_WIDTH)
CF42 6F             	LD	L,A
CF43                AT_UPSUB1:
CF43 D9             	EXX
CF44 ED 78          	IN	A,(C)
CF46 03             	INC	BC
CF47 D9             	EXX
CF48 ED 79          	OUT	(C),A
CF4A 03             	INC	BC
CF4B 2D             	DEC	L
CF4C 20 F5          	JR	NZ,AT_UPSUB1
CF4E C9             	RET
CF4F                
CF4F                ;	FLOPPY DISK DRIVER(CPU)
CF4F                
CF4F                DISKC:
CF4F 1B             	DEC	DE
CF50 CB 5F          	BIT	3,A
CF52 C4 60 EE       	CALL	NZ,RNF
CF55                DISKD:
CF55 E5             	PUSH	HL
CF56 21 66 EE       	LD	HL,RETRY
CF59 35             	DEC	(HL)
CF5A E1             	POP	HL
CF5B 20 0C          	JR	NZ,AT_ERR		;Retry
CF5D B7             	OR	A
CF5E 28 09          	JR	Z,AT_ERR		;Error
CF60                
CF60                AT_DELP:
CF60 CD 60 EE       	CALL	RNF
CF63 CD 3C EE       	CALL	FDMOFF
CF66 3E FF          	LD	A,0FFH
CF68                AT_ERRZ:
CF68 BF             	CP	A
CF69                AT_ERR:
CF69 3E FF          	LD	A,0FFH
CF6B C9             	RET
CF6C                ERRW:
CF6C 3E FF          	LD	A,0FFH
CF6E BF             	CP	A
CF6F 37             	SCF
CF70 C3 3C EE       	JP	FDMOFF
CF73                
CF73                ERRDW:
CF73 D1             	POP	DE
CF74 CD 75 DF       	CALL	AT_DELP+AT_RS
CF77 C2 75 EE       	JP	NZ,DWT0+AT_R
CF7A B7             	OR	A
CF7B 20 EF          	JR	NZ,ERRW
CF7D C9             	RET
CF7E                
CF7E                ERRDR:
CF7E D1             	POP	DE
CF7F CD 75 DF       	CALL	AT_DELP+AT_RS
CF82 C2 BE EE       	JP	NZ,DRD0+AT_R
CF85 B7             	OR	A
CF86 20 E4          	JR	NZ,ERRW
CF88 C9             	RET
CF89                
CF89                AT_WTTRK:
CF89 06 01          	LD	B,1
CF8B 3E F4          	LD	A,0F4H
CF8D C3 69 EE       	JP	AT_WTTRK1+AT_R
CF90                
CF90                AT_SCRN:
CF90 ED 78          	IN	A,(C)
CF92 C9             	RET
CF93                AT_SCRE:
CF93                
CF93                AT_DWT:
CF93 3E A0          	LD	A,0A0H
CF95                AT_WTTRK1:
CF95 32 04 EE       	LD	(FDCPAT+1),A
CF98                DWTBL:
CF98 78             	LD	A,B
CF99 32 AC EE       	LD	(AT_WTB+1+AT_R),A
CF9C 3E 02          	LD	A,2		;Retry count
CF9E 32 66 EE       	LD	(RETRY),A
CFA1                
CFA1                DWT0:
CFA1 D5             	PUSH	DE
CFA2 E5             	PUSH	HL
CFA3 CD A3 ED       	CALL	SEEK		;Write disk
CFA6 E1             	POP	HL
CFA7 DA 88 DF       	JP	C,ERRDW+AT_RS
CFAA F3             	DI
CFAB 3A 04 EE       	LD	A,(FDCPAT+1)
CFAE CD 48 EE       	CALL	SECSET
CFB1 0E FB          	LD	C,0FBH
CFB3                
CFB3                DWT1:
CFB3 56             	LD	D,(HL)
CFB4                DWT2:
CFB4 78             	LD	A,B
CFB5 DB F8          	IN	A,(0F8H)
CFB7 0F             	RRCA
CFB8 30 08          	JR	NC,DWT4
CFBA 0F             	RRCA
CFBB 30 F7          	JR	NC,DWT2
CFBD                DWT3:
CFBD ED 51          	OUT	(C),D
CFBF 23             	INC	HL
CFC0 18 F1          	JR	DWT1
CFC2                
CFC2                DWT4:
CFC2 3D             	DEC	A
CFC3 28 F8          	JR	Z,DWT3
CFC5 3C             	INC	A
CFC6 FB             	EI
CFC7 D1             	POP	DE
CFC8 13             	INC	DE
CFC9 CD 3C EE       	CALL	FDMOFF
CFCC 28 09          	JR	Z,DISKOK_WT
CFCE CD 64 DF       	CALL	DISKC+AT_RS
CFD1 20 CE          	JR	NZ,DWT0
CFD3 B7             	OR	A
CFD4 C2 81 DF       	JP	NZ,ERRW+AT_RS
CFD7                
CFD7                DISKOK_WT:
CFD7 06 01          AT_WTB:	LD	B,1
CFD9 10 BD          	DJNZ	DWTBL
CFDB C9             	RET
CFDC                
CFDC                AT_DRD:
CFDC 3E 80          	LD	A,080H
CFDE 32 04 EE       	LD	(FDCPAT+1),A
CFE1                DRDBL:
CFE1 78             	LD	A,B
CFE2 32 F1 EE       	LD	(AT_RDB+1+AT_R),A
CFE5 3E 02          	LD	A,2		;Retry count
CFE7 32 66 EE       	LD	(RETRY),A
CFEA                DRD0:
CFEA D5             	PUSH	DE
CFEB E5             	PUSH	HL
CFEC CD A3 ED       	CALL	SEEK		;Read disk
CFEF E1             	POP	HL
CFF0 DA 93 DF       	JP	C,ERRDR+AT_RS
CFF3 F3             	DI
CFF4 3A 04 EE       	LD	A,(FDCPAT+1)
CFF7 CD 48 EE       	CALL	SECSET
CFFA 0E FB          	LD	C,0FBH
CFFC                DRD1:
CFFC 78             	LD	A,B
CFFD DB F8          	IN	A,(0F8H)
CFFF 0F             	RRCA
D000 30 08          	JR	NC,DRD3
D002 0F             	RRCA
D003 30 F7          	JR	NC,DRD1
D005 ED A2          	INI
D007 04             	INC	B
D008 18 F2          	JR	DRD1
D00A                
D00A                DRD3:
D00A B7             	OR	A
D00B FB             	EI
D00C D1             	POP	DE
D00D 13             	INC	DE
D00E CD 3C EE       	CALL	FDMOFF
D011 28 09          	JR	Z,DISKOK_RD
D013 CD 64 DF       	CALL	DISKC+AT_RS
D016 20 D2          	JR	NZ,DRD0
D018 B7             	OR	A
D019 C2 81 DF       	JP	NZ,ERRW+AT_RS
D01C                
D01C                DISKOK_RD:
D01C 06 01          AT_RDB:	LD	B,1
D01E 10 C1          	DJNZ	DRDBL
D020 C9             	RET
D021                
D021                AT_CPUE:
D021                
D021                
D021                ;	EMM DRIVER(CPU)
D021                
D021                
D021                AT_EDWT:
D021 CD 91 D7       	CALL	AT_EADR+AT_RE
D024                AT_EDWT0:
D024 F5             	PUSH	AF
D025 AF             	XOR	A
D026                AT_EDWT1:
D026 04             	INC	B
D027 ED A3          	OUTI
D029 04             	INC	B
D02A ED A3          	OUTI
D02C 3D             	DEC	A
D02D 20 F7          	JR	NZ,AT_EDWT1
D02F 13             	INC	DE
D030 F1             	POP	AF
D031 3D             	DEC	A
D032 20 F0          	JR	NZ,AT_EDWT0
D034 C9             	RET
D035                
D035                AT_EDRD:
D035 CD 91 D7       	CALL	AT_EADR+AT_RE
D038                AT_EDRD0:
D038 F5             	PUSH	AF
D039 AF             	XOR	A
D03A                AT_EDRD1:
D03A ED A2          	INI
D03C 04             	INC	B
D03D ED A2          	INI
D03F 04             	INC	B
D040 3D             	DEC	A
D041 20 F7          	JR	NZ,AT_EDRD1
D043 13             	INC	DE
D044 F1             	POP	AF
D045 3D             	DEC	A
D046 20 F0          	JR	NZ,AT_EDRD0
D048 C9             	RET
D049                
D049                AT_EADR:
D049 C5             	PUSH	BC
D04A D5             	PUSH	DE
D04B EB             	EX	DE,HL
D04C 29             	ADD	HL,HL
D04D DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
D050 DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
D053 09             	ADD	HL,BC
D054 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
D057 06 0D          	LD	B,00DH
D059 ED 49          	OUT	(C),C
D05B 0C             	INC	C
D05C ED 69          	OUT	(C),L
D05E 0C             	INC	C
D05F ED 61          	OUT	(C),H
D061 0C             	INC	C
D062 EB             	EX	DE,HL
D063 D1             	POP	DE
D064 F1             	POP	AF
D065 A7             	AND	A	;CF=0
D066 C9             	RET
D067                AT_EMME:
D067                
D067                AT_TRAP38:
D067 21 00 00       	LD	HL,0
D06A E3             	EX	(SP),HL
D06B 3E 24          	LD	A,'$'
D06D CD 76 DB       	CALL	MSG_A
D070 2B             	DEC	HL
D071 7C             	LD	A,H
D072 CD E8 FF       	CALL	PRHX+AT_RT
D075 7D             	LD	A,L
D076                PRHX:
D076 F5             	PUSH	AF
D077 07             	RLCA
D078 07             	RLCA
D079 07             	RLCA
D07A 07             	RLCA
D07B CD F1 FF       	CALL	PRHX2+AT_RT
D07E F1             	POP	AF
D07F                PRHX2:
D07F E6 0F          	AND	00FH
D081 FE 0A          	CP	10
D083 3F             	CCF
D084 CE 30          	ADC	A,'0'
D086 27             	DAA
D087 C3 76 DB       	JP	MSG_A
D08A                	DS	4
D08E                AT_TRAPE:
D08E                
D08E 00 00 2F 72    AT_RT	EQU	TRAP38-AT_TRAP38
D08E                
D08E                INITE:
D08E                	DS	BDOS-INITE
D106                
D106 C3 B4 D7       	JP	BDOS0
D109                	INCLUDE	"X1CCP.ASM"
D109                
D109                ;	LSX-Dodgers CCP
D109                ;	X1/turbo/Z
D109                
D109                WBOOT1:
D109 F3             	DI
D10A ED 7B 06 00    	LD	SP,(SYSTEM+1)
D10E                
D10E 3E EF          	LD	A,INTVEC/256
D110 ED 47          	LD	I,A
D112                
D112 3E E4          	LD	A,0E4H
D114 CD 99 DE       	CALL	COMOUT
D117 3E C8          	LD	A,INTVEC
D119 CD 73 DE       	CALL	OT49SB
D11C                
D11C 21 B0 EF       	LD	HL,CRTCD
D11F AF             	XOR	A
D120                SETCRT2:
D120 01 00 18       	LD	BC,01800H
D123 ED 79          	OUT	(C),A
D125 0C             	INC	C
D126 56             	LD	D,(HL)
D127 FE 0D          	CP	13
D129 38 02          	JR	C,SETCRT3
D12B 16 00          	LD	D,0
D12D                SETCRT3:
D12D ED 51          	OUT	(C),D
D12F 23             	INC	HL
D130 3C             	INC	A
D131 FE 0E          	CP	14
D133 20 EB          	JR	NZ,SETCRT2
D135                
D135 01 03 1B       	LD	BC,01A03H+00100H
D138 ED A3          	OUTI
D13A 01 D0 20       	LD	BC,01FD0H+00100H
D13D ED A3          	OUTI
D13F 21 92 EF       	LD	HL,_KEYD
D142 7E             	LD	A,(HL)
D143 36 00          	LD	(HL),0
D145 CD 60 DB       	CALL	KEYBC_IFBREAK
D148 3E 04          	LD	A,4
D14A CD 76 DB       	CALL	MSG_A
D14D                	INCLUDE	"LDCCP.ASM"
D14D                
D14D                ;	LSX-Dodgers CCP
D14D                
D14D                COMMAND:
D14D CD 00 D2       	CALL	SETDTA1
D150 3A 87 EF       	LD	A,(_DVSW)
D153 C6 41          	ADD	A,'A'
D155 CD 76 DB       	CALL	MSG_A
D158 3E 3E          	LD	A,'>'
D15A CD 76 DB       	CALL	MSG_A
D15D 3E 50          	LD	A,80
D15F 12             	LD	(DE),A
D160 CD C5 DB       	CALL	_SYS0A		;(BDOS)文字列入力
D163 CD AA D3       	CALL	LTNL
D166                
D166 11 82 00       	LD	DE,DTA1+2
D169 CD FD EF       	CALL	_COMANL
D16C 30 DF          	JR	NC,COMMAND
D16E 11 79 EF       	LD	DE,COMERM
D171 CD FE D7       	CALL	_SYS09		;(BDOS)文字列出力
D174 C7             	RST	0
D175                
D175                COMANL:
D175 CD 45 E0       	CALL	FILE
D178 3A 19 EF       	LD	A,(FNAME+4)
D17B FE 20          	CP	020H
D17D 20 1C          	JR	NZ,COMB2
D17F D5             	PUSH	DE
D180 11 15 EF       	LD	DE,FNAME
D183 1A             	LD	A,(DE)
D184 FE 20          	CP	020H
D186 28 44          	JR	Z,SDVSW
D188 1B             	DEC	DE
D189 1A             	LD	A,(DE)
D18A C6 FF          	ADD	A,0FFH
D18C 38 09          	JR	C,COMB
D18E 13             	INC	DE
D18F                
D18F 21 8B D6       	LD	HL,COMTB
D192 06 09          	LD	B,COMS
D194 CD C9 E2       	CALL	CPNAME
D197                COMB:
D197 D1             	POP	DE
D198 D2 0F 00       	JP	NC,JP_HL
D19B                COMB2:
D19B EB             	EX	DE,HL
D19C 22 74 D2       	LD	(COMPAT+1),HL
D19F F5             	PUSH	AF
D1A0 CD 20 D2       	CALL	CEXE4
D1A3 F1             	POP	AF
D1A4 21 15 EF       	LD	HL,FNAME
D1A7 11 6D 00       	LD	DE,FCB2+1	;COMMAND NAME
D1AA 01 0B 00       	LD	BC,11
D1AD ED B0          	LDIR
D1AF 11 2E D6       	LD	DE,PATHD
D1B2                CEX1:
D1B2 1A             	LD	A,(DE)
D1B3 FE 20          	CP	020H
D1B5 D8             	RET	C
D1B6 CD 3A E0       	CALL	FILEC
D1B9 D5             	PUSH	DE
D1BA 21 6D 00       	LD	HL,FCB2+1	;COMMAND NAME
D1BD 11 15 EF       	LD	DE,FNAME
D1C0 01 0B 00       	LD	BC,11
D1C3 ED B0          	LDIR
D1C5 CD 20 D2       	CALL	CEXE4
D1C8 D1             	POP	DE
D1C9 13             	INC	DE
D1CA 18 E6          	JR	CEX1
D1CC                
D1CC                SDVSW:
D1CC F1             	POP	AF
D1CD 3A 14 EF       	LD	A,(FDRV)
D1D0 3D             	DEC	A
D1D1 5F             	LD	E,A
D1D2 0E 0E          	LD	C,00EH		;(BDOS)カレントドライブの設定
D1D4 18 31          	JR	SYSTEM0
D1D6                
D1D6                OPEN1:
D1D6 21 14 EF       	LD	HL,FDRV
D1D9                OPEN:
D1D9 0E 11          	LD	C,011H		;(BDOS)ファイルの検索
D1DB                OPEN3:
D1DB D5             	PUSH	DE
D1DC 11 09 D6       	LD	DE,DTA_CCP
D1DF CD FD D1       	CALL	SETDTA
D1E2 EB             	EX	DE,HL
D1E3 CD 07 D2       	CALL	SYSTEM0
D1E6 D1             	POP	DE
D1E7 C9             	RET
D1E8                
D1E8                OPEN2:
D1E8 0E 12          	LD	C,012H
D1EA 18 EF          	JR	OPEN3
D1EC                
D1EC                DEFCB:				;Z=Ok NZ=Error
D1EC 11 09 D6       	LD	DE,DTA_CCP
D1EF CD 05 D2       	CALL	SYSC0F
D1F2                
D1F2 11 2A D6       	LD	DE,DTA_CCP+33	;(FCB)ランダムレコード
D1F5 06 04          	LD	B,4
D1F7 CD E8 D4       	CALL	ZERO_MEMORY_DE
D1FA 11 00 01       	LD	DE,00100H
D1FD                SETDTA:
D1FD C3 D8 D9       	JP	_SYS1A		;(BDOS)DTAの設定
D200                
D200                SETDTA1:
D200 11 80 00       	LD	DE,DTA1
D203 18 F8          	JR	SETDTA
D205                
D205                SYSC0F:
D205 0E 0F          	LD	C,00FH		;(BDOS)ファイルのオープン
D207                SYSTEM0:
D207 CD 05 00       	CALL	SYSTEM
D20A B7             	OR	A
D20B C9             	RET
D20C                
D20C                C_CD:
D20C 0E 5A          	LD	C,5AH
D20E 18 F7          	JR	SYSTEM0
D210                
D210                S27BUF:
D210 3A 07 00       	LD	A,(SYSTEM+2)
D213 3D             	DEC	A
D214 E6 F8          	AND	0F8H
D216 67             	LD	H,A
D217 2E 00          	LD	L,0
D219                S27DTA:
D219 11 09 D6       	LD	DE,DTA_CCP
D21C                S27:
D21C 0E 27          	LD	C,027H		;(BDOS)ランダムブロック読み込み
D21E 18 E7          	JR	SYSTEM0
D220                
D220                CEXE4:
D220 3A 14 EF       	LD	A,(FDRV)
D223 32 57 00       	LD	(00057H),A
D226 2A 22 EF       	LD	HL,(FDRV+14)
D229 22 58 00       	LD	(00058H),HL
D22C                
D22C 21 1D EF       	LD	HL,FNAME+8
D22F 7E             	LD	A,(HL)
D230 FE 20          	CP	020H
D232 20 07          	JR	NZ,CEXE7
D234 3E 3F          	LD	A,'?'
D236 77             	LD	(HL),A
D237 23             	INC	HL
D238 77             	LD	(HL),A
D239 23             	INC	HL
D23A 77             	LD	(HL),A
D23B                CEXE7:
D23B CD D6 D1       	CALL	OPEN1
D23E                CEXE5:
D23E C0             	RET	NZ
D23F 2A 13 D6       	LD	HL,(DTA_CCP+1+9)
D242 7C             	LD	A,H
D243 CD 51 E3       	CALL	CAP
D246 67             	LD	H,A
D247 7D             	LD	A,L
D248 CD 51 E3       	CALL	CAP
D24B 6F             	LD	L,A
D24C 3A 12 D6       	LD	A,(DTA_CCP+1+8)
D24F CD 51 E3       	CALL	CAP
D252 D6 42          	SUB	'B'
D254 28 2C          	JR	Z,C_BAT
D256 3D             	DEC	A		;'C'
D257 28 05          	JR	Z,C_EXE
D259                CEXE6:
D259 CD E8 D1       	CALL	OPEN2
D25C 18 E0          	JR	CEXE5
D25E                
D25E                C_EXE:
D25E 7C             	LD	A,H
D25F FE 4D          	CP	'M'
D261 20 F6          	JR	NZ,CEXE6
D263                
D263 CD EC D1       	CALL	DEFCB
D266 CD 10 D2       	CALL	S27BUF
D269 3D             	DEC	A
D26A 37             	SCF
D26B C0             	RET	NZ
D26C 7C             	LD	A,H
D26D B5             	OR	L
D26E 37             	SCF
D26F C8             	RET	Z
D270 CD 00 D2       	CALL	SETDTA1
D273 11 00 00       COMPAT:	LD	DE,0				; self-modifying code
D276 ED 7B 06 00    	LD	SP,(SYSTEM+1)
D27A 67             	LD	H,A				; A=0 in SETDTA1(_SYS1A)
D27B 6F             	LD	L,A
D27C E5             	PUSH	HL				; push $0000 (reboot address)
D27D 24             	INC	H
D27E E5             	PUSH	HL				; push $0100 (TPA address)
D27F C3 B3 D4       	JP	SETFCB				; and JP $0100
D282                
D282                C_BAT:
D282 11 41 54       	LD	DE,'A'+'T'*256
D285 ED 52          	SBC	HL,DE
D287 20 D0          	JR	NZ,CEXE6
D289                
D289 F1             	POP	AF
D28A F1             	POP	AF
D28B CD EC D1       	CALL	DEFCB
D28E 21 00 02       	LD	HL,00200H
D291 CD 19 D2       	CALL	S27DTA
D294 C6 FE          	ADD	A,0FEH
D296 D8             	RET	C
D297 7D             	LD	A,L
D298 B7             	OR	A
D299 37             	SCF
D29A C8             	RET	Z
D29B 3C             	INC	A
D29C F5             	PUSH	AF
D29D                
D29D CD 63 DB       	CALL	KEYBC
D2A0 3E 06          	LD	A,6
D2A2 CD 76 DB       	CALL	MSG_A
D2A5 C1             	POP	BC
D2A6 21 00 01       	LD	HL,00100H
D2A9                BAT1:
D2A9 A7             	AND	A
D2AA 05             	DEC	B
D2AB C8             	RET	Z
D2AC 7E             	LD	A,(HL)
D2AD FE 25          	CP	'%'
D2AF 28 0C          	JR	Z,BAT2
D2B1                BAT1X:
D2B1 7E             	LD	A,(HL)
D2B2 23             	INC	HL
D2B3 FE 1A          	CP	01AH
D2B5 C8             	RET	Z
D2B6 FE 0A          	CP	00AH
D2B8 C4 48 DB       	CALL	NZ,KEYBS
D2BB 18 EC          	JR	BAT1
D2BD                
D2BD                BAT2:
D2BD 23             	INC	HL
D2BE 7E             	LD	A,(HL)
D2BF 2B             	DEC	HL
D2C0 D6 31          	SUB	'1'
D2C2 38 ED          	JR	C,BAT1X
D2C4 FE 09          	CP	9
D2C6 30 E9          	JR	NC,BAT1X
D2C8 23             	INC	HL
D2C9 23             	INC	HL
D2CA 3C             	INC	A
D2CB 4F             	LD	C,A
D2CC ED 5B 74 D2    	LD	DE,(COMPAT+1)
D2D0                BAT3:
D2D0 1A             	LD	A,(DE)
D2D1 B7             	OR	A
D2D2 28 D5          	JR	Z,BAT1
D2D4 CD 1C E1       	CALL	SPCUT
D2D7 0D             	DEC	C
D2D8 28 08          	JR	Z,BAT5
D2DA                BAT4:
D2DA 1A             	LD	A,(DE)
D2DB FE 21          	CP	021H
D2DD 38 F1          	JR	C,BAT3
D2DF 13             	INC	DE
D2E0 18 F8          	JR	BAT4
D2E2                BAT5:
D2E2 1A             	LD	A,(DE)
D2E3 FE 21          	CP	021H
D2E5 38 C2          	JR	C,BAT1
D2E7 13             	INC	DE
D2E8 CD 48 DB       	CALL	KEYBS
D2EB 18 F5          	JR	BAT5
D2ED                
D2ED                C_DEL:
D2ED CD B3 D4       	CALL	SETFCB
D2F0 CD 8C DB       	CALL	_SYS08		;(BDOS)エコーなしコンソール入力
D2F3                
D2F3 0E 13          	LD	C,013H
D2F5 18 0A          	JR	CDEL1		;(BDOS)ファイルの削除
D2F7                
D2F7                C_REN:
D2F7 CD B3 D4       	CALL	SETFCB
D2FA 3E 10          	LD	A,010H		;ディレクトリも対象にする
D2FC 32 69 00       	LD	(FCB1+13),A	;属性
D2FF 0E 17          	LD	C,017H		;(BDOS)ファイル名の変更
D301                CDEL1:
D301 11 5C 00       	LD	DE,FCB1
D304 CD 05 00       	CALL	SYSTEM
D307 C6 FF          	ADD	A,0FFH
D309 C9             	RET
D30A                
D30A                C_DIR:
D30A CD 3A E0       	CALL	FILEC
D30D 21 15 EF       	LD	HL,FDRV+1
D310 CD FE D5       	CALL	CWILD1
D313 3E F1          	LD	A,0F1H
D315 32 21 EF       	LD	(FDRV+13),A
D318 CD D6 D1       	CALL	OPEN1
D31B                CDIR1:
D31B B7             	OR	A
D31C 20 08          	JR	NZ,PDSKF
D31E CD 69 D3       	CALL	P_NAME
D321 CD E8 D1       	CALL	OPEN2
D324 18 F5          	JR	CDIR1
D326                
D326                PDSKF:
D326 3A 14 EF       	LD	A,(FDRV)
D329 5F             	LD	E,A
D32A 0E 1B          	LD	C,01BH		;(BDOS)ディスク情報の獲得
D32C CD 05 00       	CALL	SYSTEM
D32F 4F             	LD	C,A		;C←1クラスタ辺りの論理セクタ数
D330 C6 01          	ADD	A,001H
D332 D8             	RET	C		;Aが0FFHだった場合
D333 3E 06          	LD	A,8-2
D335                PDS1:				;HL=未使用クラスタの総数
D335 3C             	INC	A
D336 CB 19          	RR	C
D338 30 FB          	JR	NC,PDS1
D33A                PDS2:				;B←論理セクタのサイズの上位8ビット
D33A 3C             	INC	A
D33B CB 18          	RR	B
D33D 30 FB          	JR	NC,PDS2
D33F 47             	LD	B,A
D340                
D340 11 00 00       	LD	DE,0
D343                PDS3:
D343 29             	ADD	HL,HL
D344 EB             	EX	DE,HL
D345 ED 6A          	ADC	HL,HL
D347 EB             	EX	DE,HL
D348 10 F9          	DJNZ	PDS3
D34A                PDSKF1:
D34A CD E2 D3       	CALL	PRDEC_DEHL
D34D 11 6F D6       	LD	DE,FREE
D350 CD FE D7       	CALL	_SYS09		;(BDOS)文字列出力
D353 CD D1 D3       	CALL	PUTDRV
D356 3E 5C          	LD	A,05CH		;\
D358 CD 76 DB       	CALL	MSG_A
D35B 2A 22 EF       	LD	HL,(FDRV+14)	;ディレクトリのクラスタ番号
D35E AF             	XOR	A
D35F 11 FE FF       	LD	DE,0-2
D362 19             	ADD	HL,DE
D363 23             	INC	HL
D364 DC DE D3       	CALL	C,PRDEC_HL
D367 18 41          	JR	LTNL
D369                
D369                P_NAME:
D369 3A 0A D6       	LD	A,(DTA_CCP+1)
D36C FE 2E          	CP	'.'
D36E C8             	RET	Z
D36F 11 87 D6       	LD	DE,DIRHD
D372 CD FE D7       	CALL	_SYS09		;(BDOS)文字列出力
D375 3A 15 D6       	LD	A,(DTA_CCP+1+00BH)
D378 F5             	PUSH	AF
D379 0F             	RRCA
D37A 9F             	SBC	A,A
D37B E6 0A          	AND	'*'-020H
D37D C6 20          	ADD	A,020H
D37F CD 76 DB       	CALL	MSG_A
D382 CD D1 D3       	CALL	PUTDRV
D385 21 0A D6       	LD	HL,DTA_CCP+1
D388 CD 22 D4       	CALL	FPRNT
D38B                
D38B F1             	POP	AF
D38C CB 67          	BIT	4,A
D38E 28 08          	JR	Z,DIR3
D390 11 7C D6       	LD	DE,DIRMES
D393 CD FE D7       	CALL	_SYS09		;(BDOS)文字列出力
D396 18 0A          	JR	DIR6
D398                DIR3:
D398 ED 5B 28 D6    	LD	DE,(DTA_CCP+1+01EH)
D39C 2A 26 D6       	LD	HL,(DTA_CCP+1+01CH)
D39F CD E2 D3       	CALL	PRDEC_DEHL
D3A2                DIR6:
D3A2 3A B1 EF       	LD	A,(_WIDTH)
D3A5 FE 29          	CP	40+1
D3A7 D4 44 D4       	CALL	NC,PRTTMS
D3AA                
D3AA                LTNL:
D3AA 1E 03          	LD	E,3
D3AC C3 CD EF       	JP	_PRINT
D3AF                
D3AF                C_PATH:
D3AF CD 1C E1       	CALL	SPCUT
D3B2 21 2E D6       	LD	HL,PATHD
D3B5 FE 21          	CP	021H
D3B7 30 0C          	JR	NC,CPATH0
D3B9                CPATHP:
D3B9 7E             	LD	A,(HL)
D3BA 23             	INC	HL
D3BB FE 20          	CP	020H
D3BD 3F             	CCF
D3BE 30 EA          	JR	NC,LTNL
D3C0 CD 76 DB       	CALL	MSG_A
D3C3 18 F4          	JR	CPATHP
D3C5                CPATH0:
D3C5 FE 3B          	CP	';'
D3C7 20 01          	JR	NZ,CPATH1
D3C9 13             	INC	DE
D3CA                CPATH1:
D3CA EB             	EX	DE,HL
D3CB 01 40 00       	LD	BC,PATHX
D3CE ED B0          	LDIR
D3D0 C9             	RET
D3D1                
D3D1                PUTDRV:
D3D1 3A 14 EF       	LD	A,(FDRV)
D3D4 C6 40          	ADD	A,'A'-1
D3D6 CD 76 DB       	CALL	MSG_A
D3D9 3E 3A          	LD	A,':'
D3DB                MSG_AR:
D3DB C3 76 DB       	JP	MSG_A
D3DE                
D3DE                PRDEC_HL:
D3DE AF             	XOR	A
D3DF                PRDEC_AHL:
D3DF 5F             	LD	E,A
D3E0 16 00          	LD	D,0
D3E2                PRDEC_DEHL:
D3E2 D5             	PUSH	DE
D3E3 11 0F EF       	LD	DE,DECBF
D3E6 06 05          	LD	B,5
D3E8 CD E8 D4       	CALL	ZERO_MEMORY_DE	;A=0
D3EB D1             	POP	DE
D3EC                
D3EC 0E 20          	LD	C,32
D3EE                DEC1:
D3EE 29             	ADD	HL,HL
D3EF EB             	EX	DE,HL
D3F0 ED 6A          	ADC	HL,HL
D3F2 EB             	EX	DE,HL
D3F3 E5             	PUSH	HL
D3F4 21 13 EF       	LD	HL,DECBF+4
D3F7 06 05          	LD	B,5
D3F9                DEC2:
D3F9 7E             	LD	A,(HL)
D3FA 8F             	ADC	A,A
D3FB 27             	DAA
D3FC 77             	LD	(HL),A
D3FD 2B             	DEC	HL
D3FE 10 F9          	DJNZ	DEC2
D400 E1             	POP	HL
D401 0D             	DEC	C
D402 20 EA          	JR	NZ,DEC1
D404                
D404 21 0F EF       	LD	HL,DECBF
D407 3E 20          	LD	A,020H
D409 06 04          	LD	B,4
D40B                DEC3:
D40B CD 18 D4       	CALL	DEC4
D40E CD 18 D4       	CALL	DEC4
D411 23             	INC	HL
D412 10 F7          	DJNZ	DEC3
D414                DECX:
D414 CD 18 D4       	CALL	DEC4
D417 AF             	XOR	A
D418                DEC4:
D418 ED 6F          	RLD
D41A FE 20          	CP	020H
D41C 28 02          	JR	Z,DEC5
D41E F6 30          	OR	030H
D420                DEC5:
D420 18 B9          	JR	MSG_AR
D422                
D422                FPRNT:
D422 06 08          	LD	B,8
D424 CD 35 D4       	CALL	P_N1
D427 7E             	LD	A,(HL)
D428 C6 80          	ADD	A,0A0H-020H
D42A FE A0          	CP	0A0H
D42C 28 02          	JR	Z,FPR1
D42E 3E 2E          	LD	A,'.'
D430                FPR1:
D430 CD 76 DB       	CALL	MSG_A
D433 06 03          	LD	B,3
D435                
D435                P_N1:
D435 C5             	PUSH	BC
D436 E5             	PUSH	HL
D437 7E             	LD	A,(HL)
D438 CD 5D E3       	CALL	CAP3
D43B CD 76 DB       	CALL	MSG_A
D43E E1             	POP	HL
D43F C1             	POP	BC
D440 23             	INC	HL
D441 10 F2          	DJNZ	P_N1
D443 C9             	RET
D444                
D444                PRTTMS:
D444 3E 20          	LD	A,020H
D446 CD 76 DB       	CALL	MSG_A
D449                
D449 2A 22 D6       	LD	HL,(DTA_CCP+1+24)
D44C 7D             	LD	A,L
D44D B7             	OR	A
D44E C8             	RET	Z
D44F CB 3C          	SRL	H
D451 17             	RLA
D452 17             	RLA
D453 17             	RLA
D454 17             	RLA
D455 E6 0F          	AND	00FH
D457 57             	LD	D,A
D458 7C             	LD	A,H
D459 C6 50          	ADD	A,80
D45B CD 9E D4       	CALL	PRDEC_A
D45E 3E 2D          	LD	A,'-'
D460 CD 76 DB       	CALL	MSG_A
D463 7A             	LD	A,D
D464 CD 9E D4       	CALL	PRDEC_A
D467 3E 2D          	LD	A,'-'
D469 CD 76 DB       	CALL	MSG_A
D46C 7D             	LD	A,L
D46D E6 1F          	AND	01FH
D46F CD 9E D4       	CALL	PRDEC_A
D472                
D472 2A 20 D6       	LD	HL,(DTA_CCP+1+22)
D475                
D475 3E 20          	LD	A,020H
D477 CD 76 DB       	CALL	MSG_A
D47A 7C             	LD	A,H
D47B 65             	LD	H,L
D47C 06 03          	LD	B,3
D47E                PRTTMS1:
D47E 1F             	RRA
D47F CB 1D          	RR	L
D481 10 FB          	DJNZ	PRTTMS1
D483 E6 1F          	AND	01FH
D485 CD 9E D4       	CALL	PRDEC_A
D488 3E 3A          	LD	A,':'
D48A CD 76 DB       	CALL	MSG_A
D48D 7D             	LD	A,L
D48E 0F             	RRCA
D48F 0F             	RRCA
D490 E6 3F          	AND	03FH
D492 CD 9E D4       	CALL	PRDEC_A
D495 3E 3A          	LD	A,':'
D497 CD 76 DB       	CALL	MSG_A
D49A 7C             	LD	A,H
D49B E6 1F          	AND	01FH
D49D 87             	ADD	A,A
D49E                
D49E                ;	PRINT10
D49E                
D49E                PRDEC_A:
D49E E5             	PUSH	HL
D49F 06 08          	LD	B,8
D4A1 4F             	LD	C,A
D4A2 AF             	XOR	A
D4A3                PRTA1:
D4A3 CB 01          	RLC	C
D4A5 8F             	ADC	A,A
D4A6 27             	DAA
D4A7 10 FA          	DJNZ	PRTA1
D4A9 21 0F EF       	LD	HL,DECBF
D4AC 77             	LD	(HL),A
D4AD AF             	XOR	A
D4AE CD 14 D4       	CALL	DECX
D4B1 E1             	POP	HL
D4B2 C9             	RET
D4B3                
D4B3                SETFCB:
D4B3 CD 1C E1       	CALL	SPCUT
D4B6 1A             	LD	A,(DE)
D4B7 FE 20          	CP	020H
D4B9 38 01          	JR	C,SETFCBA
D4BB 1B             	DEC	DE
D4BC                SETFCBA:
D4BC 06 24          	LD	B,36
D4BE 21 5C 00       	LD	HL,FCB1
D4C1 E5             	PUSH	HL
D4C2 AF             	XOR	A
D4C3 CD F1 E0       	CALL	FILL_MEMORY
D4C6 E1             	POP	HL
D4C7 D5             	PUSH	DE
D4C8 CD 3E DA       	CALL	_SYS5C		;(BDOS)ファイル名の解析
D4CB 21 6C 00       	LD	HL,FCB2
D4CE CD 3E DA       	CALL	_SYS5C		;(BDOS)ファイル名の解析
D4D1 E1             	POP	HL
D4D2 01 00 50       	LD	BC,05000H
D4D5 11 81 00       	LD	DE,00081H
D4D8                SETFCB1:
D4D8 7E             	LD	A,(HL)
D4D9 23             	INC	HL
D4DA FE 20          	CP	020H
D4DC 38 05          	JR	C,SETFCB2
D4DE 12             	LD	(DE),A
D4DF 13             	INC	DE
D4E0 0C             	INC	C
D4E1 10 F5          	DJNZ	SETFCB1
D4E3                SETFCB2:
D4E3 79             	LD	A,C
D4E4 32 80 00       	LD	(DTA1),A
D4E7 04             	INC	B
D4E8                ZERO_MEMORY_DE:
D4E8 AF             	XOR	A
D4E9                FILL_MEMORY_DE:
D4E9 12             	LD	(DE),A
D4EA 13             	INC	DE
D4EB 10 FC          	DJNZ	FILL_MEMORY_DE
D4ED C9             	RET
D4EE                
D4EE                C_COPY:
D4EE CD B3 D4       	CALL	SETFCB
D4F1                
D4F1 11 61 EF       	LD	DE,ZERO
D4F4 CD 3D E0       	CALL	FILEC2
D4F7 21 6C 00       	LD	HL,FCB2
D4FA CD 45 DA       	CALL	S29X1
D4FD                
D4FD 3E 10          	LD	A,010H
D4FF 32 69 00       	LD	(FCB1+13),A
D502 21 6D 00       	LD	HL,FCB2+1
D505 CD FE D5       	CALL	CWILD1
D508                COPY0:
D508 CD FB D5       	CALL	CWILD
D50B 21 5C 00       	LD	HL,FCB1
D50E CD D9 D1       	CALL	OPEN
D511 37             	SCF
D512                COPY1:
D512 C0             	RET	NZ
D513 CD EC D1       	CALL	DEFCB
D516                
D516 3A 16 D6       	LD	A,(DTA_CCP+13)
D519 CB 67          	BIT	4,A
D51B 28 21          	JR	Z,COPY1A
D51D                
D51D 21 5D 00       	LD	HL,FCB1+1
D520 CD 80 E4       	CALL	CHKWILD
D523 38 14          	JR	C,COPY9
D525                
D525 3E 20          	LD	A,020H
D527 32 5D 00       	LD	(FCB1+1),A
D52A 2A 23 D6       	LD	HL,(DTA_CCP+26)
D52D 23             	INC	HL
D52E 22 6A 00       	LD	(FCB1+14),HL
D531 18 D5          	JR	COPY0
D533                
D533                COPY8:
D533 CD FE D7       	CALL	_SYS09		;(BDOS)文字列出力
D536 CD AA D3       	CALL	LTNL
D539                COPY9:
D539 CD E8 D1       	CALL	OPEN2
D53C 18 D4          	JR	COPY1
D53E                
D53E                COPY1A:
D53E 21 6C 00       	LD	HL,FCB2
D541 11 14 EF       	LD	DE,FDRV
D544 01 0B D6       	LD	BC,DTA_CCP+2
D547 ED A0          	LDI
D549 3E 0B          	LD	A,11
D54B                COPY2:
D54B F5             	PUSH	AF
D54C 7E             	LD	A,(HL)
D54D FE 3F          	CP	'?'
D54F 20 01          	JR	NZ,COPY3
D551 0A             	LD	A,(BC)
D552                COPY3:
D552 12             	LD	(DE),A
D553 03             	INC	BC
D554 13             	INC	DE
D555 23             	INC	HL
D556 F1             	POP	AF
D557 3D             	DEC	A
D558 20 F1          	JR	NZ,COPY2
D55A 01 05 00       	LD	BC,16-11
D55D ED B0          	LDIR
D55F                PUTNAME:
D55F 21 5D 00       	LD	HL,FCB1+1
D562 CD 80 E4       	CALL	CHKWILD
D565 30 0B          	JR	NC,PUTN1
D567 21 15 EF       	LD	HL,FDRV+1
D56A CD 22 D4       	CALL	FPRNT
D56D 3E 20          	LD	A,020H
D56F CD 76 DB       	CALL	MSG_A
D572                PUTN1:
D572 11 14 EF       	LD	DE,FDRV
D575 0E 16          	LD	C,016H		;(BDOS)ファイルの作成
D577 CD 07 D2       	CALL	SYSTEM0
D57A 20 48          	JR	NZ,COPYE2
D57C 67             	LD	H,A		;A=0
D57D 6F             	LD	L,A
D57E 22 35 EF       	LD	(FDRV+33),HL	;(FCB)ランダムレコード
D581 22 37 EF       	LD	(FDRV+35),HL
D584                COPY6:
D584 CD 10 D2       	CALL	S27BUF
D587 47             	LD	B,A
D588 3C             	INC	A
D589 28 31          	JR	Z,COPYE
D58B 7C             	LD	A,H
D58C B5             	OR	L
D58D 28 0C          	JR	Z,COPY7
D58F 11 14 EF       	LD	DE,FDRV
D592 0E 26          	LD	C,026H		;(BDOS)ランダムブロック書き込み
D594 CD 07 D2       	CALL	SYSTEM0
D597 20 23          	JR	NZ,COPYE
D599 10 E9          	DJNZ	COPY6
D59B                COPY7:
D59B 3A 16 D6       	LD	A,(DTA_CCP+13)	;(FCB)属性
D59E 32 21 EF       	LD	(FDRV+13),A
D5A1 21 1D D6       	LD	HL,DTA_CCP+20	;(FCB)タイムスタンプ
D5A4 11 28 EF       	LD	DE,FDRV+20
D5A7 01 04 00       	LD	BC,4
D5AA ED B0          	LDIR
D5AC                
D5AC 11 14 EF       	LD	DE,FDRV
D5AF 0E 10          	LD	C,010H		;(BDOS)ファイルのクローズ
D5B1 CD 07 D2       	CALL	SYSTEM0
D5B4 20 06          	JR	NZ,COPYE
D5B6                
D5B6 11 71 EF       	LD	DE,OK
D5B9 C3 33 D5       	JP	COPY8
D5BC                
D5BC                COPYE:
D5BC 11 14 EF       	LD	DE,FDRV
D5BF 0E 13          	LD	C,013H		;(BDOS)ファイルの削除
D5C1 CD 05 00       	CALL	SYSTEM
D5C4                COPYE2:
D5C4 37             	SCF
D5C5 C9             	RET
D5C6                
D5C6                C_TYPE:
D5C6 CD B3 D4       	CALL	SETFCB
D5C9 21 5C 00       	LD	HL,FCB1
D5CC CD D9 D1       	CALL	OPEN
D5CF 37             	SCF
D5D0                TYPE1:
D5D0 C0             	RET	NZ
D5D1 CD EC D1       	CALL	DEFCB
D5D4 3E 06          	LD	A,6
D5D6 CD 76 DB       	CALL	MSG_A
D5D9                TYPE2:
D5D9 CD 10 D2       	CALL	S27BUF
D5DC C6 FE          	ADD	A,0FEH
D5DE D8             	RET	C
D5DF 7C             	LD	A,H
D5E0 B5             	OR	L
D5E1 28 13          	JR	Z,TYPEE
D5E3 01 00 01       	LD	BC,00100H
D5E6                TYPE3:
D5E6 0A             	LD	A,(BC)
D5E7 03             	INC	BC
D5E8 FE 1A          	CP	01AH
D5EA 28 0A          	JR	Z,TYPEE
D5EC CD 76 DB       	CALL	MSG_A
D5EF 2B             	DEC	HL
D5F0 7C             	LD	A,H
D5F1 B5             	OR	L
D5F2 20 F2          	JR	NZ,TYPE3
D5F4 18 E3          	JR	TYPE2
D5F6                TYPEE:
D5F6 CD E8 D1       	CALL	OPEN2
D5F9 18 D5          	JR	TYPE1
D5FB                
D5FB                CWILD:
D5FB 21 5D 00       	LD	HL,FCB1+1
D5FE                CWILD1:
D5FE 7E             	LD	A,(HL)
D5FF FE 20          	CP	020H
D601 C0             	RET	NZ
D602                CWILD2:
D602 3E 3F          	LD	A,'?'
D604 06 0B          	LD	B,11
D606 C3 F1 E0       	JP	FILL_MEMORY
D609                
D609                DTA_CCP:
D609                	DS	37
D62E                
D62E 00 00 00 40    PATHX	EQU	64
D62E                PATHD:	DS	PATHX
D66E 00             PATHE:	DB	0
D66F                
D66F 20 62 79 74    FREE:	DB	" bytes free",9,'$'
D673 65 73 20 66
D677 72 65 65 09
D67B 24
D67C 20 20 20 20    DIRMES:	DB	"     <DIR>$"
D680 20 3C 44 49
D684 52 3E 24
D687 20 20 3A 24    DIRHD:	DB	"  :$"
D68B                
D68B                COMTB:
D68B 44 20 20 20    	DB	"D   "	;1
D68F 0A D3          	DW	C_DIR
D691 44 49 52 20    	DB	"DIR "	;2
D695 0A D3          	DW	C_DIR
D697 43 4F 50 59    	DB	"COPY"	;3
D69B EE D4          	DW	C_COPY
D69D 43 44 20 20    	DB	"CD  "	;4
D6A1 0C D2          	DW	C_CD
D6A3 44 45 4C 20    	DB	"DEL "	;5
D6A7 ED D2          	DW	C_DEL
D6A9 50 41 54 48    	DB	"PATH"	;6
D6AD AF D3          	DW	C_PATH
D6AF 52 45 4E 20    	DB	"REN "	;7
D6B3 F7 D2          	DW	C_REN
D6B5 54 59 50 45    	DB	"TYPE"	;8
D6B9 C6 D5          	DW	C_TYPE
D6BB 52 45 4D 20    	DB	"REM "	;9
D6BF FB D7          	DW	C_REM
D6C1                	INCLUDE	"X1DISK2.ASM"
D6C1                
D6C1                ;	LSX-Dodgers DISK2
D6C1                ;	X1/turbo/Z
D6C1                
D6C1                ;	GRAPHIC RAM DISK DRIVER
D6C1                
D6C1                
D6C1                GDRD:
D6C1 C5             	PUSH	BC
D6C2 CD EA D6       	CALL	GADR
D6C5 F1             	POP	AF
D6C6                GDRD1:
D6C6 ED A2          	INI
D6C8 04             	INC	B
D6C9 0C             	INC	C
D6CA 20 FA          	JR	NZ,GDRD1
D6CC 04             	INC	B
D6CD 13             	INC	DE
D6CE 3D             	DEC	A
D6CF 20 F5          	JR	NZ,GDRD1
D6D1                GBANK0:
D6D1 3A BF EF       	LD	A,(WK1FD0)
D6D4 E6 EF          	AND	0EFH		;BANK0
D6D6 18 1D          	JR	S1FD0
D6D8                
D6D8                GDWT:
D6D8 C5             	PUSH	BC
D6D9 CD EA D6       	CALL	GADR
D6DC F1             	POP	AF
D6DD                GDWT1:
D6DD 04             	INC	B
D6DE ED A3          	OUTI
D6E0 0C             	INC	C
D6E1 20 FA          	JR	NZ,GDWT1
D6E3 04             	INC	B
D6E4 13             	INC	DE
D6E5 3D             	DEC	A
D6E6 20 F5          	JR	NZ,GDWT1
D6E8 18 E7          	JR	GBANK0
D6EA                
D6EA                GADR:
D6EA 0E 00          	LD	C,0
D6EC 7B             	LD	A,E
D6ED C6 40          	ADD	A,040H
D6EF 47             	LD	B,A
D6F0 3A BF EF       	LD	A,(WK1FD0)
D6F3 F6 10          	OR	010H		;BANK1
D6F5                S1FD0:
D6F5 C5             	PUSH	BC
D6F6 32 BF EF       	LD	(WK1FD0),A
D6F9 01 D0 1F       	LD	BC,01FD0H
D6FC ED 79          	OUT	(C),A
D6FE C1             	POP	BC
D6FF C9             	RET
D700                
D700                
D700                ;	BANK RAM DISK DRIVER
D700                
D700                BDWT:
D700 3E             	DB	03EH	;LD A,??
D701 37             	SCF
D702 18 02          	JR	BRW
D704                
D704                BDRD:
D704 3E             	DB	03EH	;LD A,??
D705 A7             	AND	A
D706                BRW:
D706 F3             	DI
D707 32 2F D7       	LD	(BRWPAT),A
D70A ED 73 4F D7    	LD	(BANKSP+1),SP
D70E 3A 50 D7       	LD	A,(BANKSP+2)
D711 87             	ADD	A,A
D712 38 03          	JR	C,BRW0
D714 31 CA FF       	LD	SP,EXTSP
D717                BRW0:
D717 D9             	EXX		;裏レジスタ
D718 C5             	 PUSH	 BC
D719 D5             	 PUSH	 DE
D71A 01 00 0B       	 LD	 BC,00B00H	 ;バンクメモリ
D71D 11 10 10       	 LD	 DE,01010H
D720 D9             	 EXX		;表レジスタ
D721                BRW1:
D721 C5             	PUSH	BC
D722 D5             	PUSH	DE
D723 EB             	EX	DE,HL
D724 29             	ADD	HL,HL
D725 29             	ADD	HL,HL
D726 7C             	LD	A,H
D727 E6 0F          	AND	00FH	;バンク
D729 65             	LD	H,L
D72A CB 3C          	SRL	H	;/2
D72C 2E 00          	LD	L,0
D72E D9             	EXX		;裏レジスタ
D72F A7             BRWPAT:	 AND	 A	;自己書き換え(AND A:読み出し/SCF:書き込み)
D730 38 08          	 JR	 C,BRWT
D732 57             	 LD	 D,A	 ;D=バンク
D733 D9             	 EXX		;表レジスタ
D734 EB             	EX	DE,HL
D735 CD 53 D7       	CALL	BTFR
D738 18 06          	JR	BRW2
D73A                BRWT:
D73A 5F             	 LD	E,A	 ;E=バンク
D73B D9             	 EXX		;表レジスタ
D73C CD 53 D7       	CALL	BTFR
D73F EB             	EX	DE,HL
D740                BRW2:
D740 D1             	POP	DE
D741 C1             	POP	BC
D742 13             	INC	DE
D743 10 DC          	DJNZ	BRW1
D745                
D745 D9             	EXX		;裏レジスタ
D746 3E 10          	 LD	 A,10H
D748 ED 79          	 OUT	 (C),A		;メインメモリに切り替える
D74A D1             	 POP	 DE
D74B C1             	 POP	 BC
D74C D9             	 EXX		;表レジスタ
D74D AF             	XOR	A
D74E 31 00 00       BANKSP:	LD	SP,0
D751 FB             	EI
D752 C9             	RET
D753                
D753                ;メインメモリ←→バンクメモリ 512バイトの転送を行う
D753                ; DE:転送元アドレス
D753                ; HL:転送先アドレス
D753                ; 裏BC:バンク切り替えポート(0B00H)
D753                ; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
D753                ; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
D753                
D753                BTFR:
D753 06 00          	LD	B,0	;256回ループ(256*2)
D755                BTFR1:
D755 D9             	EXX		;裏レジスタ
D756 ED 51          	 OUT	 (C),D	 ;BANK(MAIN)
D758 D9             	 EXX		;表レジスタ
D759 1A             	LD	A,(DE)
D75A 4F             	LD	C,A
D75B 13             	INC	DE
D75C 1A             	LD	A,(DE)
D75D 13             	INC	DE
D75E D9             	EXX		;裏レジスタ
D75F ED 59          	 OUT	 (C),E	 ;MAIN(BANK)
D761 D9             	 EXX		;表レジスタ
D762 71             	LD	(HL),C
D763 23             	INC	HL
D764 77             	LD	(HL),A
D765 23             	INC	HL
D766 10 ED          	DJNZ	BTFR1
D768 C9             	RET
D769                
D769                ;	EMM DRIVER(DMA)
D769                
D769                
D769                EDWT:
D769 0E 0F          	LD	C,15
D76B 18 02          	JR	EDWT1
D76D                EDRD:
D76D 0E 0E          	LD	C,14
D76F                EDWT1:
D76F C5             	PUSH	BC
D770 D5             	PUSH	DE
D771 22 B1 D7       	LD	(DMAB),HL
D774 78             	LD	A,B
D775 87             	ADD	A,A
D776 3D             	DEC	A
D777 32 AA D7       	LD	(DMALEN+1),A
D77A 3C             	INC	A
D77B 84             	ADD	A,H	;HL(アドレス)を先に進めておく
D77C 67             	LD	H,A
D77D EB             	EX	DE,HL
D77E 29             	ADD	HL,HL
D77F DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
D782 79             	LD	A,C
D783 DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
D786 09             	ADD	HL,BC
D787 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
D78A 06 0D          	LD	B,00DH
D78C ED 49          	OUT	(C),C
D78E 0C             	INC	C
D78F ED 69          	OUT	(C),L
D791 0C             	INC	C
D792 ED 61          	OUT	(C),H
D794                
D794 21 A5 D7       	LD	HL,EDMAD
D797 CD 4F DF       	CALL	SETDMA
D79A CD 77 DF       	CALL	GO_DMA
D79D EB             	EX	DE,HL
D79E D1             	POP	DE
D79F C1             	POP	BC
D7A0                DMA_ADD_SEC:
D7A0 13             	INC	DE
D7A1 10 FD          	DJNZ	DMA_ADD_SEC
D7A3 AF             	XOR	A
D7A4 C9             	RET
D7A5                
D7A5                EDMAD:
D7A5 C3             	DB	0C3H	;WR6 リセット
D7A6 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
D7A7 03 0D          	DW	00D03H	;ポートA開始アドレス EMMリード/ライト
D7A9 FF 01          DMALEN:	DW	001FFH	;ブロック長(転送サイズ-1)
D7AB 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
D7AC 50             	DB	050H	;WR2 ポートBアドレスインクリメント メモリ
D7AD 02             	DB	002H	;ポートBタイミング
D7AE 80             	DB	080H	;WR3
D7AF 9A             	DB	09AH	;WR5 WAIT RDY:HIGH
D7B0 AD             	DB	0ADH	;WR4 連続 ポートB開始アドレス
D7B1 00 00          DMAB:	DW	0
D7B3 01             	DB	001H	;WR0 ポートA←ポートB 転送
D7B4                EMME:
D7B4                
D7B4 00 00 07 48    AT_RE	EQU	EDWT-AT_EDWT
D7B4                
D7B4                	INCLUDE	"LDOS.ASM"
D7B4                
D7B4                ;	LSX-Dodgers OS
D7B4                
D7B4                BDOS0:
D7B4 ED 73 C8 D7    	LD	(BDSP+1),SP
D7B8 F5             	PUSH	AF
D7B9 3A C9 D7       	LD	A,(BDSP+2)
D7BC FE FF          	CP	EXTSP/256
D7BE 28 0B          	JR	Z,BDOS1X
D7C0                BDOS2:
D7C0 F1             	POP	AF
D7C1 31 CA FF       	LD	SP,EXTSP
D7C4 CD CC D7       	CALL	BDOS1
D7C7 31 00 00       BDSP:	LD	SP,0
D7CA C9             	RET
D7CB                BDOS1X:
D7CB F1             	POP	AF
D7CC                BDOS1:
D7CC E5             	PUSH	HL
D7CD 79             	LD	A,C
D7CE FE 3C          	CP	03CH
D7D0 38 02          	JR	C,DOS1
D7D2 3E 3C          	LD	A,03CH
D7D4                DOS1:
D7D4 87             	ADD	A,A
D7D5 6F             	LD	L,A
D7D6 26 F0          	LD	H,STABLE/256
D7D8 7E             	LD	A,(HL)
D7D9 2C             	INC	L
D7DA 66             	LD	H,(HL)
D7DB 6F             	LD	L,A
D7DC E3             	EX	(SP),HL
D7DD 79             	LD	A,C
D7DE C9             	RET
D7DF                _DOS2:
D7DF FE 5A          	CP	05AH		;(BDOS)カレントディレクトリの変更(_CHDIR)
D7E1 CA 82 DA       	JP	Z,_SYS5A
D7E4 FE 5C          	CP	05CH		;(BDOS)ファイル名の解析(_PFILE)
D7E6 CA 3E DA       	JP	Z,_SYS5C
D7E9 FE 5F          	CP	05FH		;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
D7EB CA 87 ED       	JP	Z,_SYS5F
D7EE FE 6F          	CP	06FH		;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
D7F0 20 0A          	JR	NZ,_ERROR
D7F2 01 1D 01       	LD	BC,011DH
D7F5 11 48 01       	LD	DE,VER
D7F8 21 00 00       	LD	HL,MACD
D7FB                C_REM:
D7FB AF             	XOR	A
D7FC                _ERROR:
D7FC A7             	AND	A
D7FD C9             	RET
D7FE                
D7FE                _SYS09:		;文字列出力
D7FE D5             	PUSH	DE
D7FF                _SX09:
D7FF 1A             	LD	A,(DE)
D800 13             	INC	DE
D801 FE 24          	CP	'$'
D803 28 31          	JR	Z,SX0E2
D805 CD 76 DB       	CALL	MSG_A
D808 18 F5          	JR	_SX09
D80A                
D80A                MSX1:
D80A CD 76 DB       	CALL	MSG_A
D80D                MSX:
D80D 7E             	LD	A,(HL)
D80E 23             	INC	HL
D80F B7             	OR	A
D810 20 F8          	JR	NZ,MSX1
D812 C9             	RET
D813                
D813                _SYS0C:		;(BDOS)バージョン番号の獲得
D813 21 22 00       	LD	HL,00022H
D816 7D             	LD	A,L
D817 C9             	RET
D818                
D818                _SYS0D:		;(BDOS)ディスクリセット
D818 CD DF EF       	CALL	_FFLUSH
D81B E5             	PUSH	HL
D81C 21 80 00       	LD	HL,00080H
D81F 22 8A EF       	LD	(_DTA),HL
D822 E1             	POP	HL
D823 D5             	PUSH	DE
D824 1E 00          	LD	E,0
D826 3E             	DB	03EH
D827                
D827                _SYS0E:		;(BDOS)カレントドライブの設定
D827 D5             	PUSH	DE
D828 7B             	LD	A,E
D829 DD E5          	PUSH	IX
D82B CD DC EF       	CALL	_GETDPB
D82E DD E1          	POP	IX
D830 38 04          	JR	C,SX0E2
D832 7B             	LD	A,E
D833 32 87 EF       	LD	(_DVSW),A
D836                SX0E2:
D836 3E 08          	LD	A,8
D838 D1             	POP	DE
D839 C9             	RET
D83A                
D83A                _SYS0F:		;(BDOS)ファイルのオープン
D83A CD 2E E1       	CALL	SETDRV
D83D FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D840 C6 02          	ADD	A,002H		;Write
D842 28 48          	JR	Z,FEND0F
D844 CD 7C E4       	CALL	CHKWILDX
D847                
D847 D4 4E E1       	CALL	NC,SOPENX
D84A                _S16XX:
D84A 38 40          	JR	C,FEND0F
D84C                				;Directory location
D84C 3A 9F EF       	LD	A,(_FILEN)
D84F FD 77 19       	LD	(IY+25),A	;(FCB)ディレクトリロケーション
D852                ;				_DIRF
D852 3A A0 EF       	LD	A,(_DIRF)
D855 FD 77 1D       	LD	(IY+29),A	;(FCB)ディレクトリモード
D858                ;				_FBPS
D858 FD 73 1E       	LD	(IY+30),E	;(FCB)ディレクトリポジション
D85B FD 72 1F       	LD	(IY+31),D
D85E                ;				Open(Read)
D85E FD 36 1C FF    	LD	(IY+28),0FFH	;(FCB)オープンモード
D862                ;				FILENAME
D862 FD E5          	PUSH	IY
D864 D1             	POP	DE
D865 13             	INC	DE
D866 01 0B 00       	LD	BC,11
D869 ED B0          	LDIR
D86B                ;				Attribute
D86B 7E             	LD	A,(HL)
D86C FD 77 0D       	LD	(IY+13),A	;(FCB)属性(アトリビュート)
D86F 11 0B 00       	LD	DE,11		;Reserved
D872 19             	ADD	HL,DE
D873                					;(FCB)ファイルを最後に変更した時刻
D873 11 EA F0       	LD	DE,SDDATA		;(FCB)ファイルを最後に変更した日付
D876 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
D878                S16LOOP:				;(FCB)ファイルのサイズ(バイト単位)
D878 1A             	LD	A,(DE)
D879 13             	INC	DE
D87A 32 81 D8       	LD	(S16PAT+2),A
D87D 7E             	LD	A,(HL)
D87E 23             	INC	HL
D87F FD 77 00       S16PAT:	LD	(IY+0),A
D882 10 F4          	DJNZ	S16LOOP
D884                
D884 AF             	XOR	A
D885 FD 77 0C       	LD	(IY+12),A	;(FCB)カレントブロック
D888 FD 22 30 D9    	LD	(OFCB+1),IY
D88C                FEND0F:
D88C 18 45          	JR	FEND10
D88E                
D88E                _SYS10:		;(BDOS)ファイルのクローズ
D88E CD 2E E1       	CALL	SETDRV
D891 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D894 D6 FE          	SUB	0FEH
D896 37             	SCF
D897 3F             	CCF
D898 20 39          	JR	NZ,FEND10
D89A                _S10A:				;Write
D89A FD 77 0E       	LD	(IY+14),A	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D89D FD 77 0F       	LD	(IY+15),A
D8A0                
D8A0 FD 34 1C       	INC	(IY+28)		;0FEH->0FFH ;オープンモード
D8A3 CD 74 E5       	CALL	SETTMS
D8A6                
D8A6 FD 7E 1D       	LD	A,(IY+29)	;(FCB)ディレクトリモード
D8A9 32 A0 EF       	LD	(_DIRF),A
D8AC E6 7F          	AND	07FH
D8AE 32 BD EA       	LD	(_SECPS+1),A
D8B1 FD 5E 1E       	LD	E,(IY+30)	;(FCB)ディレクトリポジション
D8B4 FD 56 1F       	LD	D,(IY+31)
D8B7 CD 82 E2       	CALL	READ_DIR
D8BA 38 17          	JR	C,FEND10
D8BC                
D8BC 3A AC E1       SDECM1:	LD	A,(SDECPAT+1)	;1セクタ辺りのディレクトリエントリ数
D8BF 3D              	DEC	A		;1024=01FH / 512=00FH / 256=7
D8C0 FD A6 19       	AND	(IY+25)		;(FCB)ディレクトリロケーション
D8C3 6F             	LD	L,A
D8C4 26 00          	LD	H,0
D8C6 29             	ADD	HL,HL		;*2
D8C7 29             	ADD	HL,HL		;*4
D8C8 29             	ADD	HL,HL		;*8
D8C9 29             	ADD	HL,HL		;*16
D8CA 29             	ADD	HL,HL		;*32
D8CB ED 4B 7E F0    	LD	BC,(_DTBUF)
D8CF 09             	ADD	HL,BC
D8D0                
D8D0 CD 8C E4       	CALL	SDIRENT
D8D3                FEND10:
D8D3 18 42          	JR	FEND
D8D5                
D8D5                _SYS11:		;(BDOS)最初のファイルの検索
D8D5 CD 2E E1       	CALL	SETDRV
D8D8 CD 7B E1       	CALL	SOPEN
D8DB                _S12X1:
D8DB 38 3A          	JR	C,FEND
D8DD CD 1B E2       	CALL	SOPENE2
D8E0 ED 5B 8A EF    	LD	DE,(_DTA)
D8E4 3A 88 EF       	LD	A,(_DRV)
D8E7 3C             	INC	A
D8E8 12             	LD	(DE),A
D8E9 D5             	PUSH	DE
D8EA 13             	INC	DE
D8EB 01 20 00       	LD	BC,32
D8EE ED B0          	LDIR
D8F0 FD 6E 0E       	LD	L,(IY+14)	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D8F3 FD 66 0F       	LD	H,(IY+15)
D8F6 22 F4 F0       	LD	(SCDIR),HL
D8F9 2A 9A EF       	LD	HL,(_FBPS)
D8FC 22 F6 F0       	LD	(SFBPS),HL
D8FF 2A 9F EF       	LD	HL,(_FILEN)
D902 7C             	LD	A,H
D903 B7             	OR	A
D904 28 06          	JR	Z,_S12DIR
D906 3A BD EA       	LD	A,(_SECPS+1)
D909 F6 80          	OR	080H
D90B 67             	LD	H,A
D90C                _S12DIR:
D90C 22 F8 F0       	LD	(SFNDF),HL	;Directory position and Flags
D90F E1             	POP	HL
D910 11 39 EF       	LD	DE,SFILE
D913 0E 21          	LD	C,33
D915                _S11B:
D915 ED B0          	LDIR
D917                FEND:
D917 9F             	SBC	A,A		;CF=0 A=0 : CF=1 A=0FFH
D918                FENDE:
D918 FD E1          	POP	IY
D91A C1             	POP	BC
D91B D1             	POP	DE
D91C E1             	POP	HL
D91D C9             	RET
D91E                
D91E                _SYS12:		;(BDOS)次のファイルの検索
D91E E5             	PUSH	HL
D91F D5             	PUSH	DE
D920 C5             	PUSH	BC
D921 FD E5          	PUSH	IY
D923 CD DF E1       	CALL	NOPEN
D926 18 B3          	JR	_S12X1
D928                
D928                _S16K:
D928 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D92B FE FD          	CP	0FDH		;Device(0FDH)
D92D 37             	SCF
D92E C8             	RET	Z
D92F                
D92F 11 00 00       OFCB:	LD	DE,0
D932 D5             	PUSH	DE
D933 06 1A          	LD	B,26		;First cluster
D935                S16K1:
D935 13             	INC	DE
D936 23             	INC	HL
D937 10 FC          	DJNZ	S16K1
D939                
D939 1A             	LD	A,(DE)
D93A BE             	CP	(HL)
D93B 20 13          	JR	NZ,S16K2
D93D 13             	INC	DE
D93E 23             	INC	HL
D93F 1A             	LD	A,(DE)
D940 BE             	CP	(HL)
D941 20 0D          	JR	NZ,S16K2
D943                
D943 E1             	POP	HL
D944 FD E5          	PUSH	IY
D946 D1             	POP	DE
D947 1A             	LD	A,(DE)		;Drive
D948 BE             	CP	(HL)
D949 20 06          	JR	NZ,S16K3
D94B                				;ここはCFが必ず0
D94B ED 52          	SBC	HL,DE		;CP HL,DE
D94D 37             	SCF
D94E C0             	RET	NZ
D94F E5             	PUSH	HL
D950                S16K2:
D950 E1             	POP	HL
D951                S16K3:
D951 FD E5          	PUSH	IY
D953 D1             	POP	DE
D954                _SYS13:		;(BDOS)ファイルの削除
D954 CD 2E E1       	CALL	SETDRV
D957 CD AC E3       	CALL	KILL
D95A                FEND13:
D95A 18 BB          	JR	FEND
D95C                
D95C                _SYS14:		;(BDOS)シーケンシャルな読み出し
D95C CD 2E E1       	CALL	SETDRV
D95F CD E0 E5       	CALL	INIT_SEQ
D962                SREAD:
D962 CD 2A E6       	CALL	RB_READ
D965                
D965 C6 01          	ADD	A,001H
D967 38 AE          	JR	C,FEND
D969                
D969 7D             	LD	A,L
D96A D6 01          	SUB	001H
D96C                FENDX:
D96C 9F             	SBC	A,A
D96D E6 03          	AND	3
D96F 1F             	RRA
D970 18 A6          	JR	FENDE
D972                
D972                _SYS15:		;(BDOS)シーケンシャルな書き込み
D972 CD 2E E1       	CALL	SETDRV
D975 CD E0 E5       	CALL	INIT_SEQ
D978                SWRITE:
D978 CD 23 E6       	CALL	RB_WRITE
D97B                
D97B C6 FF          	ADD	A,0FFH
D97D 18 ED          	JR	FENDX
D97F                
D97F                _SYS17:		;(BDOS)ファイル名の変更
D97F CD 2E E1       	CALL	SETDRV
D982 CD 02 E4       	CALL	NAME
D985 18 D3          	JR	FEND13
D987                
D987                _SYS16:		;(BDOS)ファイルの作成
D987 CD 2E E1       	CALL	SETDRV
D98A                
D98A CD 7C E4       	CALL	CHKWILDX
D98D 38 CB          	JR	C,FEND13
D98F FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
D992 FE 05          	CP	5
D994 28 05          	JR	Z,_S16X2
D996 FE 21          	CP	021H
D998 DA 5A D9       	JP	C,FEND13
D99B                _S16X2:
D99B                ;				Clear FCB
D99B FD E5          	PUSH	IY
D99D E1             	POP	HL
D99E 01 10 00       	LD	BC,16
D9A1 09             	ADD	HL,BC
D9A2                _S16X1:
D9A2 70             	LD	(HL),B		;B=0
D9A3 23             	INC	HL
D9A4 0D             	DEC	C
D9A5 20 FB          	JR	NZ,_S16X1
D9A7                
D9A7 CD 79 E5       	CALL	SETTMSX
D9AA FD 36 0D FF    	LD	(IY+13),0FFH	;(FCB)Attribute
D9AE CD 4E E1       	CALL	SOPENX
D9B1 3F             	CCF
D9B2 CC 28 D9       	CALL	Z,_S16K
D9B5 D4 2C E2       	CALL	NC,COPEN
D9B8 D4 8C E4       	CALL	NC,SDIRENT
D9BB C3 4A D8       	JP	_S16XX
D9BE                
D9BE                _SYS21:		;(BDOS)ランダムな読み出し
D9BE CD 2E E1       	CALL	SETDRV
D9C1 CD C4 E5       	CALL	INIT_RND
D9C4 18 9C          	JR	SREAD
D9C6                
D9C6                _SYS22:		;(BDOS)ランダムな書き込み
D9C6                _SYS28:		;(BDOS)ランダムな書き込み・その2
D9C6 CD 2E E1       	CALL	SETDRV
D9C9 CD C4 E5       	CALL	INIT_RND
D9CC 18 AA          	JR	SWRITE
D9CE                
D9CE                _SYS18:		;(BDOS)ログインベクトルの獲得
D9CE 21 FF 00       	LD	HL,000FFH
D9D1 AF             	XOR	A
D9D2 C9             	RET
D9D3                
D9D3                _SYS19:		;(BDOS)カレントドライブ番号の獲得
D9D3 3A 87 EF       	LD	A,(_DVSW)
D9D6 A7             	AND	A
D9D7 C9             	RET
D9D8                
D9D8                _SYS1A:		;(BDOS)DTAの設定
D9D8 ED 53 8A EF    	LD	(_DTA),DE
D9DC AF             	XOR	A
D9DD C9             	RET
D9DE                
D9DE                _SYS1B:		;(BDOS)ディスク情報の獲得
D9DE 7B             	LD	A,E
D9DF CD 41 E1       	CALL	GETDRV
D9E2 CD DC EF       	CALL	_GETDPB
D9E5 D4 E2 EF       	CALL	NC,_RDFATX
D9E8 21 00 00       	LD	HL,0
D9EB D4 52 E5       	CALL	NC,DSKF
D9EE                
D9EE ED 5B 53 E5    	LD	DE,(MAXCLP+1)	;DPB_08_MAXCL-1
D9F2 1B             	DEC	DE		;DE←クラスタの総数
D9F3 FD 2A 7C F0    	LD	IY,(_FATBF)	;IY←メモリ上のFATの先頭アドレス
D9F7 9F             	SBC	A,A
D9F8 D8             	RET	C
D9F9 4F             	LD	C,A		;C=0
D9FA DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS
D9FD E6 0F          	AND	00FH
D9FF 47             	LD	B,A
DA00 DD 7E 07       	LD	A,(IX+7)	;DPB_07_SECPCL
DA03 C9             	RET
DA04                
DA04                _SYS1D:		;(BDOS)書き込みが禁止されているディスクの調査
DA04 AF             	XOR	A
DA05 67             	LD	H,A
DA06 6F             	LD	L,A
DA07 C9             	RET
DA08                
DA08                _SYS1F:		;(BDOS)ディスク装置のパラメータの読み出し
DA08 21 00 F1       	LD	HL,DEVICE
DA0B 7B             	LD	A,E
DA0C C3 DC EF       	JP	_GETDPB
DA0F                
DA0F                _SYS23:		;(BDOS)ファイルサイズの獲得
DA0F E5             	PUSH	HL
DA10 2A 1E F0       	LD	HL,(STABLE+2*00FH)	;ファイルのオープン
DA13 CD 0F 00       	CALL	JP_HL
DA16 38 1B          	JR	C,_S23X1
DA18                
DA18 D5             	PUSH	DE		;EX DE,IY
DA19 FD E3          	EX	(SP),IY		;
DA1B                ;	POP	DE		;
DA1B                ;	PUSH	DE		;DEを破壊しないように注意vv
DA1B FD 7E 10       	LD	A,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
DA1E FD 6E 11       	LD	L,(IY+17)	;
DA21 FD 66 12       	LD	H,(IY+18)	;
DA24 C5             	PUSH	BC		;
DA25 FD 46 13       	LD	B,(IY+19)	;
DA28 CD B6 E5       	CALL	GET_CPM_R_SIZE
DA2B C1             	POP	BC
DA2C                _S24X1:
DA2C CD D6 E5       	CALL	SET_RR_AHL
DA2F                ;	POP	DE		;^^^^^^^^^^^^^^^^^^^^^^^^
DA2F                ;	PUSH	DE		;EX DE,IY
DA2F FD E3          	EX	(SP),IY		;
DA31 D1             	POP	DE		;
DA32                
DA32 AF             	XOR	A
DA33                _S23X1:
DA33 E1             	POP	HL
DA34 C9             	RET
DA35                
DA35                _SYS24:		;(BDOS)ランダムレコードフィールドの設定
DA35 E5             	PUSH	HL
DA36 D5             	PUSH	DE		;EX DE,IY
DA37 FD E3          	EX	(SP),IY		;
DA39                ;	POP	DE		;
DA39                ;	PUSH	DE		;DEを破壊しないように注意vv
DA39 CD E8 E5       	CALL	GETSEQ
DA3C 18 EE          	JR	_S24X1		;^^^^^^^^^^^^^^^^^^^^^^^^
DA3E                
DA3E                _SYS5C:		;(BDOS)ファイル名の解析
DA3E C5             	PUSH	BC
DA3F E5             	PUSH	HL
DA40 CD 45 E0       	CALL	FILE
DA43 E1             	POP	HL
DA44 C1             	POP	BC
DA45                S29X1:
DA45 C5             	PUSH	BC
DA46 D5             	PUSH	DE
DA47 E5             	PUSH	HL
DA48 EB             	EX	DE,HL
DA49 21 14 EF       	LD	HL,FDRV
DA4C 01 0D 00       	LD	BC,13
DA4F ED B0          	LDIR
DA51 70             	LD	(HL),B		;B=0
DA52 0E 03          	LD	C,3
DA54 ED B0          	LDIR
DA56 E1             	POP	HL
DA57 D1             	POP	DE
DA58 C1             	POP	BC
DA59 AF             	XOR	A
DA5A C9             	RET
DA5B                
DA5B                _SYS30:		;(BDOS)論理セクタを用いた書き込み
DA5B C5             	PUSH	BC
DA5C 01 2A EC       	LD	BC,DWT24B
DA5F 18 04          	JR	S2FX
DA61                _SYS2F:
DA61 C5             	PUSH	BC
DA62 01 1A EC       	LD	BC,DRD24B
DA65                S2FX:
DA65 ED 43 7B DA    	LD	(S2FPAT+1),BC
DA69 CD DF EF       	CALL	_FFLUSH
DA6C                
DA6C D5             	PUSH	DE
DA6D E5             	PUSH	HL
DA6E 7D             	LD	A,L		;Drive
DA6F CD D9 EF       	CALL	_CHGDRV
DA72 38 09          	JR	C,S30X2
DA74 44             	LD	B,H		;Number of clusters
DA75 2A 8A EF       	LD	HL,(_DTA)
DA78                
DA78 0E 00          	LD	C,0
DA7A CD 1A EC       S2FPAT:	CALL	DRD24B
DA7D                S30X2:
DA7D E1             	POP	HL
DA7E D1             	POP	DE
DA7F C1             	POP	BC
DA80 9F             	SBC	A,A
DA81 C9             	RET
DA82                
DA82                _SYS5A:		;(BDOS)カレントディレクトリの変更
DA82 C5             	PUSH	BC
DA83 D5             	PUSH	DE
DA84 E5             	PUSH	HL
DA85 CD 3A E0       	CALL	FILEC
DA88 21 00 00       	LD	HL,0
DA8B 11 14 EF       	LD	DE,FDRV
DA8E 2A 4E F0       	LD	HL,(STABLE+2*027H)	;ランダムブロック読み込み
DA91 CD 0F 00       	CALL	JP_HL
DA94 18 E7          	JR	S30X2
DA96                	INCLUDE	"X1IO.ASM"
DA96                
DA96                ;	LSX-Dodgers IO
DA96                ;	X1/turbo/Z
DA96                
DA96 00 00 D7 FC    _SYS04	EQU	_ERROR		;(BDOS)外部出力
DA96 00 00 D7 FC    _SYS05	EQU	_ERROR		;(BDOS)プリンタ出力
DA96 00 00 D7 FC    _SYS1C	EQU	_ERROR		;(BDOS)ディスクの書き込み禁止化
DA96 00 00 D7 FC    _SYS1E	EQU	_ERROR		;(BDOS)ファイル属性の設定
DA96 00 00 D7 FC    _SYS20	EQU	_ERROR		;(BDOS)利用者番号の設定と読み出し
DA96 00 00 D7 FC    _SYS2E	EQU	_ERROR		;(BDOS)ベリファイ・フラグの設定
DA96                
DA96                BIOS:
DA96 E5             	PUSH	HL
DA97 21 10 80       	LD	HL,08010H
DA9A 39             	ADD	HL,SP
DA9B E1             	POP	HL
DA9C 30 0E          	JR	NC,BIOS2
DA9E                BIOS1:
DA9E CD A6 DA       	CALL	BIOS3
DAA1 06 1E          	LD	B,01EH
DAA3 ED 79          	OUT	(C),A
DAA5 C9             	RET
DAA6                BIOS3:
DAA6 C5             	PUSH	BC
DAA7 06 1D          	LD	B,01DH
DAA9 ED 79          	OUT	(C),A
DAAB C9             	RET
DAAC                BIOS2:
DAAC ED 73 B7 DA    	LD	(SPPAT+1),SP	;スタックがBIOS-ROMと被っている場合
DAB0 31 CA FF       	LD	SP,EXTSP
DAB3 CD 9E DA       	CALL	BIOS1
DAB6 31 00 00       SPPAT:	LD	SP,0
DAB9 C9             	RET
DABA                
DABA                INT:
DABA F5             	PUSH	AF
DABB E5             	PUSH	HL
DABC ED 73 CD DA    	LD	(INTSP+1),SP
DAC0 21 00 01       	LD	HL,00100H
DAC3 39             	ADD	HL,SP
DAC4 38 03          	JR	C,INTP1X
DAC6 31 CA FF       	LD	SP,EXTSP
DAC9                INTP1X:
DAC9 CD D4 DA       	CALL	INTP1
DACC 31 00 00       INTSP:	LD	SP,0
DACF                INTPE:
DACF E1             	POP	HL
DAD0                INTPE2:
DAD0 F1             	POP	AF
DAD1                INTCTCE:
DAD1 FB             	EI
DAD2 ED 4D          	RETI
DAD4                INTP1:
DAD4 C5             	PUSH	BC
DAD5                
DAD5 CD 7E DE       	CALL	IN49SB
DAD8 67             	LD	H,A
DAD9 CD 7E DE       	CALL	IN49SB
DADC 6F             	LD	L,A
DADD                
DADD FE 08          	CP	8		;DELキー
DADF 20 05          	JR	NZ,SCEXE
DAE1 7C             	LD	A,H
DAE2 E6 11          	AND	011H		;CTRLキー + GRAPHキー
DAE4 28 08          	JR	Z,RESET
DAE6                SCEXE:
DAE6 22 92 EF       	LD	(_KEYD),HL
DAE9 CD 1A DB       	CALL	KEYSET1
DAEC                
DAEC C1             	POP	BC
DAED C9             	RET
DAEE                
DAEE                RESET:
DAEE 3E 1D          	LD	A,01DH
DAF0 D3 00          	OUT	(0),A
DAF2 C7             	RST	0
DAF3                
DAF3                INTCTC2:
DAF3 F5             	PUSH	AF
DAF4 3E 00          INTCPAT:LD	A,000H
DAF6 3D             	DEC	A
DAF7 32 F5 DA       	LD	(INTCPAT+1),A
DAFA 20 D4          	JR	NZ,INTPE2
DAFC                
DAFC 3A 92 EF       	LD	A,(_KEYD)
DAFF B7             	OR	A
DB00 28 CE          	JR	Z,INTPE2
DB02                KEYSET0:
DB02 E5             	PUSH	HL
DB03 2A 90 EF       	LD	HL,(_KEYPS)
DB06 7C             	LD	A,H
DB07 AD             	XOR	L
DB08 20 06          	JR	NZ,INTC2A
DB0A                
DB0A 2A 92 EF       	LD	HL,(_KEYD)
DB0D CD 44 DB       	CALL	KEYSET
DB10                INTC2A:
DB10 3A 94 EF       	LD	A,(_KEYSP)
DB13 E6 0F          	AND	00FH
DB15 32 F5 DA       	LD	(INTCPAT+1),A
DB18                
DB18 18 B5          	JR	INTPE
DB1A                
DB1A                KEYSET1:
DB1A CB 6C          	BIT	5,H
DB1C F5             	PUSH	AF
DB1D ED 4B 8C EF    	LD	BC,(_CTC)
DB21 78             	LD	A,B
DB22 B1             	OR	C
DB23 20 06          	JR	NZ,KEYS10E
DB25                
DB25 F1             	POP	AF
DB26 20 1C          	JR	NZ,KEYSET
DB28 F5             	PUSH	AF
DB29 18 D7          	JR	KEYSET0
DB2B                KEYS10E:
DB2B F1             	POP	AF
DB2C C8             	RET	Z
DB2D F5             	PUSH	AF
DB2E 3E 03          	LD	A,3		;CTC STOP
DB30 ED 79          	OUT	(C),A
DB32 F1             	POP	AF
DB33                
DB33 B7             	OR	A
DB34 C8             	RET	Z
DB35                
DB35 E5             	PUSH	HL
DB36 2A 94 EF       	LD	HL,(_KEYSP)
DB39 3E A7          	LD	A,0A7H
DB3B ED 79          	OUT	(C),A
DB3D ED 69          	OUT	(C),L
DB3F 7C             	LD	A,H
DB40 32 F5 DA       	LD	(INTCPAT+1),A
DB43 E1             	POP	HL
DB44                
DB44                KEYSET:
DB44 7D             	LD	A,L
DB45 CB 74          	BIT	6,H
DB47 C0             	RET	NZ
DB48                KEYBS:
DB48 B7             	OR	A
DB49 C8             	RET	Z
DB4A                KEYBS1:
DB4A CD 60 DB       	CALL	KEYBC_IFBREAK
DB4D E5             	PUSH	HL
DB4E F5             	PUSH	AF
DB4F 2A 90 EF       	LD	HL,(_KEYPS)
DB52 2C             	INC	L
DB53 7D             	LD	A,L
DB54 BC             	CP	H
DB55 28 15          	JR	Z,POP_AF_HL_SCF_RET
DB57 32 90 EF       	LD	(_KEYPS),A
DB5A 26 FE          	LD	H,KEYBF/256
DB5C F1             	POP	AF
DB5D 77             	LD	(HL),A
DB5E E1             	POP	HL
DB5F C9             	RET
DB60                KEYBC_IFBREAK:
DB60 FE 03          	CP	3
DB62 C0             	RET	NZ
DB63                KEYBC:
DB63 E5             	PUSH	HL
DB64 21 00 00       	LD	HL,0
DB67 22 90 EF       	LD	(_KEYPS),HL
DB6A E1             	POP	HL
DB6B C9             	RET
DB6C                
DB6C                POP_AF_HL_SCF_RET:
DB6C F1             	POP	AF
DB6D E1             	POP	HL
DB6E 37             	SCF
DB6F C9             	RET
DB70                
DB70                KEYBSL:
DB70 7D             	LD	A,L
DB71 18 D7          	JR	KEYBS1
DB73                
DB73                _SYS01:		;(BDOS)コンソール入力
DB73 CD 09 EF       	CALL	_SYS07
DB76                MSG_A:
DB76 F5             	PUSH	AF
DB77 D5             	PUSH	DE
DB78 5F             	LD	E,A
DB79 CD 7F DB       	CALL	_SYS02
DB7C D1             	POP	DE
DB7D F1             	POP	AF
DB7E C9             	RET
DB7F                
DB7F                _SYS02:		;(BDOS)コンソール出力
DB7F CD 91 DB       	CALL	BREAK
DB82 18 05          	JR	PRINTX
DB84                
DB84                _SYS06:		;(BDOS)コンソール直接入出力
DB84 7B             	LD	A,E
DB85 3C             	INC	A
DB86 CA CA EF       	JP	Z,_INKEY
DB89                PRINTX:
DB89 C3 CD EF       	JP	_PRINT
DB8C                
DB8C                _SYS08:		;(BDOS)エコーなしコンソール入力
DB8C CD 09 EF       	CALL	_SYS07
DB8F 18 04          	JR	BREAK1
DB91                BREAK:
DB91 FB             	EI
DB92 3A 92 EF       	LD	A,(_KEYD)
DB95                BREAK1:
DB95 FE 03          	CP	3		;CTRL+C
DB97 CA 00 EF       	JP	Z,CPM_BOOT
DB9A FE 13          	CP	013H		;CTRL+S
DB9C C0             	RET	NZ
DB9D                
DB9D                PAUSE:
DB9D CD 63 DB       	CALL	KEYBC
DBA0                
DBA0                FLGET:
DBA0 CD DF EF       	CALL	_FFLUSH
DBA3 C5             	PUSH	BC
DBA4 E5             	PUSH	HL
DBA5 ED 4B 8E EF    	LD	BC,(_TXADR)
DBA9 CB E8          	SET	5,B
DBAB ED 60          	IN	H,(C)
DBAD                FLGET1:
DBAD 3A 93 EF       	LD	A,(_KEYD+1)
DBB0 0F             	RRCA
DBB1 0F             	RRCA
DBB2 E6 10          	AND	010H
DBB4 F6 08          	OR	8
DBB6 ED 68          	IN	L,(C)
DBB8 B5             	OR	L
DBB9 ED 79          	OUT	(C),A
DBBB CD CA EF       	CALL	_INKEY
DBBE 28 ED          	JR	Z,FLGET1
DBC0 ED 61          	OUT	(C),H
DBC2 E1             	POP	HL
DBC3 C1             	POP	BC
DBC4 C9             	RET
DBC5                
DBC5                _SYS0A:		;(BDOS)文字列入力
DBC5 C5             	PUSH	BC
DBC6 E5             	PUSH	HL
DBC7 D5             	PUSH	DE
DBC8 CD CB DF       	CALL	GETL
DBCB 11 00 FF       	LD	DE,KBUF
DBCE E1             	POP	HL
DBCF E5             	PUSH	HL
DBD0 0E 00          	LD	C,0
DBD2 30 04          	JR	NC,SAX0
DBD4 23             	INC	HL
DBD5 23             	INC	HL
DBD6 18 08          	JR	SAX4
DBD8                SAX0:
DBD8 46             	LD	B,(HL)
DBD9 23             	INC	HL
DBDA                SAX1:
DBDA 23             	INC	HL
DBDB 1A             	LD	A,(DE)
DBDC 13             	INC	DE
DBDD B7             	OR	A
DBDE 20 04          	JR	NZ,SAX2
DBE0                SAX4:
DBE0 36 0D          	LD	(HL),00DH
DBE2 18 04          	JR	SAX3
DBE4                SAX2:
DBE4 77             	LD	(HL),A
DBE5 0C             	INC	C
DBE6 10 F2          	DJNZ	SAX1
DBE8                SAX3:
DBE8 D1             	POP	DE
DBE9 79             	LD	A,C
DBEA 13             	INC	DE
DBEB 12             	LD	(DE),A
DBEC 1B             	DEC	DE
DBED E1             	POP	HL
DBEE C1             	POP	BC
DBEF A7             	AND	A
DBF0 C9             	RET
DBF1                
DBF1                _SYS0B:		;(BDOS)コンソール状態のチェック
DBF1 CD 91 DB       	CALL	BREAK
DBF4 3A 92 EF       	LD	A,(_KEYD)
DBF7 B7             	OR	A
DBF8 C8             	RET	Z
DBF9                CONSTX:
DBF9 CD DF EF       	CALL	_FFLUSH
DBFC E5             	PUSH	HL
DBFD 2A 90 EF       	LD	HL,(_KEYPS)
DC00 7C             	LD	A,H
DC01 AD             	XOR	L
DC02 E1             	POP	HL
DC03 C6 FF          	ADD	A,0FFH
DC05 9F             	SBC	A,A
DC06 C9             	RET
DC07                
DC07                _SYS2A:		;(BDOS)日付の獲得
DC07 C5             	PUSH	BC
DC08 3E ED          	LD	A,0EDH		;Read calendar
DC0A CD 99 DE       	CALL	COMOUT
DC0D CD 3F DC       	CALL	IN49SB_BCD	;YY
DC10 6F             	LD	L,A
DC11 26 00          	LD	H,0
DC13                ;	LD	DE,1900		;0076CH
DC13                ;	CP	90		;90以上は1900年代 1990-1999
DC13                ;	JR	NC,RDDATE1	;90未満は2000年代 2000-2089
DC13                ;	LD	E,0D0H		;2000 & 0FFH D=007H
DC13 11 D0 07       	LD	DE,2000		;すべて2000年代で処理 2000-2099
DC16                RDDATE1:
DC16 19             	ADD	HL,DE
DC17 CD 7E DE       	CALL	IN49SB		;MW
DC1A 57             	LD	D,A
DC1B CD 3F DC       	CALL	IN49SB_BCD	;DD
DC1E 5F             	LD	E,A
DC1F 7A             	LD	A,D
DC20 06 04          	LD	B,4
DC22                RDDATE2:
DC22 CB 3A          	SRL	D
DC24 10 FC          	DJNZ	RDDATE2
DC26 C1             	POP	BC
DC27 E6 07          	AND	7
DC29 C9             	RET
DC2A                
DC2A                _SYS2C:		;(BDOS)時刻の獲得
DC2A C5             	PUSH	BC
DC2B 3E EF          	LD	A,0EFH		;Read time
DC2D CD 99 DE       	CALL	COMOUT
DC30 CD 3F DC       	CALL	IN49SB_BCD	;TT
DC33 67             	LD	H,A
DC34 CD 3F DC       	CALL	IN49SB_BCD	;MM
DC37 6F             	LD	L,A
DC38 CD 3F DC       	CALL	IN49SB_BCD	;SS
DC3B 57             	LD	D,A
DC3C C1             	POP	BC
DC3D AF             	XOR	A
DC3E C9             	RET
DC3F                
DC3F                IN49SB_BCD:
DC3F CD 7E DE       	CALL	IN49SB
DC42                ;------------------------
DC42                ;BCDの10進数化
DC42                ;in
DC42                ;	A  : BCD
DC42                ;out
DC42                ;	A  : 10進数
DC42                ;------------------------
DC42 4F             	LD	C,A
DC43 E6 F0          	AND	0F0H	;10の位
DC45 0F             	RRCA
DC46 47             	LD	B,A
DC47 0F             	RRCA
DC48 0F             	RRCA
DC49 80             	ADD	A,B
DC4A 47             	LD	B,A
DC4B 79             	LD	A,C
DC4C E6 0F          	AND	00FH	;1の位
DC4E 80             	ADD	A,B
DC4F C9             	RET
DC50                
DC50                ESC1:
DC50 7B             	LD	A,E
DC51 FE 41          	CP	'A'
DC53 CA 9A DD       	JP	Z,CTRL1E
DC56 FE 42          	CP	'B'
DC58 CA 04 DF       	JP	Z,CTRL1F
DC5B FE 43          	CP	'C'
DC5D CA A5 DD       	JP	Z,CTRL1C
DC60 FE 44          	CP	'D'
DC62 CA 91 DD       	JP	Z,CTRL1D
DC65 FE 45          	CP	'E'
DC67 28 02          	JR	Z,CT0CX
DC69 FE 6A          	CP	'j'
DC6B                CT0CX:
DC6B CA D7 DE       	JP	Z,CTRL0C
DC6E FE 48          	CP	'H'
DC70 CA 1F DE       	JP	Z,CTRL0B
DC73 FE 4A          	CP	'J'
DC75 CA DA DE       	JP	Z,CTRL06
DC78 FE 4B          	CP	'K'
DC7A CA DE DD       	JP	Z,CTRL05
DC7D FE 4C          	CP	'L'
DC7F CA 19 DF       	JP	Z,CTRL0E
DC82 FE 54          	CP	'T'
DC84 CA DE DD       	JP	Z,CTRL05
DC87 FE 78          	CP	'x'
DC89 28 04          	JR	Z,ESC1X
DC8B FE 79          	CP	'y'
DC8D 20 02          	JR	NZ,ESC1Y
DC8F                ESC1X:
DC8F 36 01          	LD	(HL),1
DC91                ESC1Y:
DC91 FE 3D          	CP	'='
DC93 28 04          	JR	Z,ESC1W
DC95 FE 59          	CP	'Y'
DC97 20 02          	JR	NZ,ESC1Z
DC99                ESC1W:
DC99 36 02          	LD	(HL),2
DC9B                ESC1Z:
DC9B FE 20          	CP	020H
DC9D 38 02          	JR	C,ESC1C
DC9F 87             	ADD	A,A
DCA0 D0             	RET	NC
DCA1                ESC1C:
DCA1 E1             	POP	HL
DCA2 18 4F          	JR	ANK
DCA4                
DCA4                ESC:
DCA4 21 04 DD       	LD	HL,PRINTE5
DCA7 E5             	PUSH	HL
DCA8 21 CA DC       	LD	HL,ESCFLG+1
DCAB 36 00          	LD	(HL),0
DCAD 3D             	DEC	A
DCAE 28 A0          	JR	Z,ESC1
DCB0 3D             	DEC	A
DCB1 20 09          	JR	NZ,ESC2
DCB3 36 03          	LD	(HL),3
DCB5 7B             	LD	A,E
DCB6 D6 20          	SUB	020H
DCB8 32 BF DC       	LD	(ESCYP+1),A
DCBB C9             	RET
DCBC                ESC2:
DCBC 3D             	DEC	A
DCBD C0             	RET	NZ
DCBE 26 00          ESCYP:	LD	H,0
DCC0 7B             	LD	A,E
DCC1 D6 20          	SUB	020H
DCC3 6F             	LD	L,A
DCC4 C3 D6 EF       	JP	_LOC
DCC7                
DCC7                PRINT:
DCC7 C5             	PUSH	BC
DCC8 E5             	PUSH	HL
DCC9 3E 00          ESCFLG:	LD	A,000H
DCCB B7             	OR	A
DCCC 20 D6          	JR	NZ,ESC
DCCE                
DCCE 3E 1F          	LD	A,01FH
DCD0 BB             	CP	E
DCD1 30 35          	JR	NC,CTRL
DCD3 01 A2 DE       INSFLG:	LD	BC,INSERT
DCD6                
DCD6 3A 18 00       	LD	A,(00018H)
DCD9 3C             	INC	A
DCDA 28 17          	JR	Z,ANK
DCDC 3E 00          KANFLG:	LD	A,000H
DCDE B7             	OR	A
DCDF 20 3A          	JR	NZ,KANJI2
DCE1 7B             	LD	A,E
DCE2 FE 80          	CP	080H
DCE4 38 0D          	JR	C,ANK
DCE6 FE A0          	CP	0A0H
DCE8 38 04          	JR	C,KANJI1
DCEA FE E0          	CP	0E0H
DCEC 38 05          	JR	C,ANK
DCEE                KANJI1:
DCEE 32 DD DC       	LD	(KANFLG+1),A
DCF1 18 11          	JR	PRINTE5
DCF3                ANK:
DCF3 ED 4B 8E EF    	LD	BC,(_TXADR)
DCF7 78             	LD	A,B
DCF8 F6 38          	OR	038H
DCFA 47             	LD	B,A
DCFB ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DCFD CB 98          	RES	3,B
DCFF ED 59          	OUT	(C),E		;Text
DD01                KANJIE:
DD01 CD 66 DD       	CALL	PRINTE7
DD04                PRINTE5:
DD04 E1             	POP	HL
DD05 C1             	POP	BC
DD06 AF             	XOR	A
DD07 C9             	RET
DD08                
DD08                CTRL:
DD08 CD 4D DD       	CALL	KANCLR
DD0B 7B             	LD	A,E
DD0C 87             	ADD	A,A
DD0D F6 80          	OR	080H
DD0F 6F             	LD	L,A
DD10 26 F0          	LD	H,CTRLTB/256
DD12 7E             	LD	A,(HL)
DD13 2C             	INC	L
DD14 66             	LD	H,(HL)
DD15 6F             	LD	L,A
DD16 CD 0F 00       	CALL	JP_HL
DD19 18 E9          	JR	PRINTE5
DD1B                
DD1B                KANJI2:
DD1B D5             	PUSH	DE
DD1C 57             	LD	D,A
DD1D 01 81 2F       	LD	BC,02F81H	;SFTJIS
DD20 DF             	RST	018H
DD21 01 C3 2F       	LD	BC,02FC3H	;Instead or JISVRM
DD24 DF             	RST	018H
DD25                
DD25 ED 4B 8E EF    	LD	BC,(_TXADR)
DD29 78             	LD	A,B
DD2A F6 38          	OR	038H
DD2C 47             	LD	B,A
DD2D ED 51          	OUT	(C),D		;kanji
DD2F CB 98          	RES	3,B
DD31 ED 59          	OUT	(C),E		;Text
DD33 CD 66 DD       	CALL	PRINTE7
DD36 ED 4B 8E EF    	LD	BC,(_TXADR)
DD3A 78             	LD	A,B
DD3B F6 38          	OR	038H
DD3D 47             	LD	B,A
DD3E CB F2          	SET	6,D
DD40 ED 51          	OUT	(C),D		;Kanji
DD42 CB 98          	RES	3,B
DD44 ED 59          	OUT	(C),E		;Text
DD46 D1             	POP	DE
DD47 AF             	XOR	A
DD48 32 DD DC       	LD	(KANFLG+1),A
DD4B 18 B4          	JR	KANJIE
DD4D                
DD4D                KANCLR:
DD4D 3A DD DC       	LD	A,(KANFLG+1)
DD50 B7             	OR	A
DD51 C8             	RET	Z
DD52 ED 4B 8E EF    	LD	BC,(_TXADR)
DD56 78             	LD	A,B
DD57 F6 38          	OR	038H
DD59 47             	LD	B,A
DD5A AF             	XOR	A
DD5B 32 DD DC       	LD	(KANFLG+1),A
DD5E ED 79          	OUT	(C),A		;Kanji
DD60 CB 98          	RES	3,B
DD62 3E 20          	LD	A,020H
DD64 ED 79          	OUT	(C),A		;Text
DD66                PRINTE7:
DD66 CB A0          	RES	4,B
DD68                PRINTE6:
DD68 3A 96 EF       	LD	A,(_COLORF)
DD6B                PRINTE4:
DD6B ED 79          	OUT	(C),A		;Color
DD6D 78             	LD	A,B
DD6E E6 07          	AND	7
DD70 47             	LD	B,A
DD71                PRINTE2:
DD71 03             	INC	BC
DD72                PRINTE3:
DD72 2A BA EF       	LD	HL,(_PAGE_MINUS)
DD75 A7             	AND	A
DD76 ED 4A          	ADC	HL,BC
DD78                PRINTE8:
DD78 28 05          	JR	Z,PRINT2
DD7A ED 43 8E EF    	LD	(_TXADR),BC
DD7E                CTRL00:
DD7E C9             	RET
DD7F                
DD7F                PRINT2:
DD7F CD 1F DF       	CALL	SCR
DD82 2A BC EF       	LD	HL,(_WIDTH_MINUS)
DD85 09             	ADD	HL,BC
DD86                SET_TXADR_HL:
DD86 22 8E EF       	LD	(_TXADR),HL
DD89 C9             	RET
DD8A                
DD8A                CTRL08:
DD8A 3A D3 DC       	LD	A,(INSFLG)
DD8D FE CD          	CP	0CDH		;CALL ????
DD8F 28 29          	JR	Z,CTRL02
DD91                CTRL1D:
DD91 2A 8E EF       	LD	HL,(_TXADR)
DD94 7C             	LD	A,H
DD95 B5             	OR	L
DD96 C8             	RET	Z
DD97 2B             	DEC	HL
DD98 18 EC          	JR	SET_TXADR_HL
DD9A                
DD9A                CTRL1E:
DD9A ED 4B 8E EF    	LD	BC,(_TXADR)
DD9E 2A BC EF       	LD	HL,(_WIDTH_MINUS)
DDA1 09             	ADD	HL,BC
DDA2 D0             	RET	NC
DDA3 18 E1          	JR	SET_TXADR_HL
DDA5                
DDA5                CTRL1C:
DDA5 ED 4B 8E EF    	LD	BC,(_TXADR)
DDA9 18 C6          	JR	PRINTE2
DDAB                
DDAB                CTRL09:
DDAB ED 4B 8E EF    	LD	BC,(_TXADR)
DDAF 79             	LD	A,C
DDB0 E6 F8          	AND	0F8H
DDB2 C6 08          	ADD	A,8
DDB4 4F             	LD	C,A
DDB5 88             	ADC	A,B
DDB6 91             	SUB	C
DDB7 47             	LD	B,A
DDB8 18 B8          	JR	PRINTE3
DDBA                
DDBA                CTRL02:
DDBA CD 91 DD       	CALL	CTRL1D
DDBD C8             	RET	Z
DDBE D5             	PUSH	DE
DDBF CD D3 EF       	CALL	_POS
DDC2 3A B1 EF       	LD	A,(_WIDTH)
DDC5 95             	SUB	L
DDC6 4F             	LD	C,A
DDC7 0D             	DEC	C
DDC8 06 38          	LD	B,038H
DDCA 2A 8E EF       	LD	HL,(_TXADR)
DDCD 09             	ADD	HL,BC
DDCE 44             	LD	B,H
DDCF 4D             	LD	C,L
DDD0 11 00 20       	LD	DE,02000H	;D:Text E:kanji
DDD3 2A 96 EF       	LD	HL,(_COLORF)	;L:Color
DDD6                C8X1:
DDD6 CD BE DE       	CALL	C12S
DDD9 0B             	DEC	BC
DDDA 20 FA          	JR	NZ,C8X1
DDDC D1             	POP	DE
DDDD C9             	RET
DDDE                
DDDE                CTRL05:
DDDE CD D3 EF       	CALL	_POS
DDE1 3A B1 EF       	LD	A,(_WIDTH)
DDE4 95             	SUB	L
DDE5 6F             	LD	L,A
DDE6                C08X1:
DDE6 ED 4B 8E EF    	LD	BC,(_TXADR)
DDEA                LINECL:
DDEA 26 20          	LD	H,020H
DDEC 3A 96 EF       	LD	A,(_COLORF)
DDEF CB E8          	SET	5,B
DDF1                LINECL1:
DDF1 CB D8          	SET	3,B
DDF3 CB E0          	SET	4,B
DDF5 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DDF7 CB 98          	RES	3,B
DDF9 ED 61          	OUT	(C),H		;Text
DDFB CB A0          	RES	4,B
DDFD ED 79          	OUT	(C),A		;Color
DDFF 03             	INC	BC
DE00 2D             	DEC	L
DE01 20 EE          	JR	NZ,LINECL1
DE03 C9             	RET
DE04                
DE04                CTRL0D:
DE04 CD D3 EF       	CALL	_POS
DE07 2E 00          	LD	L,0
DE09                LOC:
DE09 C5             	PUSH	BC
DE0A E5             	PUSH	HL
DE0B CD 4D DD       	CALL	KANCLR
DE0E CD 2C DE       	CALL	LOC1
DE11 22 8E EF       	LD	(_TXADR),HL
DE14 E1             	POP	HL
DE15 C1             	POP	BC
DE16 C9             	RET
DE17                
DE17                CTRL12:
DE17 21 D3 DC       	LD	HL,INSFLG
DE1A 7E             	LD	A,(HL)
DE1B EE CC          	XOR	0CCH		;CD:CALL ???? 1:LD BC,????
DE1D 77             	LD	(HL),A
DE1E C9             	RET
DE1F                
DE1F                CTRL0B:
DE1F 21 00 00       	LD	HL,0
DE22 22 8E EF       	LD	(_TXADR),HL
DE25 C9             	RET
DE26                
DE26                CTRL1B:
DE26 3E 01          	LD	A,1
DE28 32 CA DC       	LD	(ESCFLG+1),A
DE2B C9             	RET
DE2C                
DE2C                LOC1:
DE2C D5             	PUSH	DE
DE2D 4D             	LD	C,L
DE2E 06 08          	LD	B,8
DE30 5C             	LD	E,H
DE31 16 00          	LD	D,0
DE33 2A B0 EF       	LD	HL,(CRTCD)
DE36 6A             	LD	L,D
DE37                LOC2:
DE37 29             	ADD	HL,HL
DE38 30 01          	JR	NC,LOC3
DE3A 19             	ADD	HL,DE
DE3B                LOC3:
DE3B 10 FA          	DJNZ	LOC2
DE3D 09             	ADD	HL,BC
DE3E D1             	POP	DE
DE3F C9             	RET
DE40                
DE40                CONOUT1:
DE40 CD 52 DE       	CALL	CURSOR
DE43 59             	LD	E,C
DE44 CD CD EF       	CALL	_PRINT
DE47 7B             	LD	A,E
DE48 FE 0A          	CP	00AH
DE4A 20 06          	JR	NZ,CURSOR
DE4C CD 04 DE       	CALL	CTRL0D
DE4F CD DE DD       	CALL	CTRL05
DE52                CURSOR:
DE52 C5             	PUSH	BC
DE53 ED 4B 8E EF    	LD	BC,(_TXADR)
DE57 CB E8          	SET	5,B
DE59 ED 78          	IN	A,(C)
DE5B EE 18          	XOR	018H
DE5D ED 79          	OUT	(C),A
DE5F C1             	POP	BC
DE60 C9             	RET
DE61                
DE61                CTRL07:
DE61 21 61 EF       	LD	HL,BEEPD
DE64                BEEP1:
DE64 7E             	LD	A,(HL)
DE65 23             	INC	HL
DE66 FE FF          	CP	0FFH
DE68 C8             	RET	Z
DE69 F3             	DI
DE6A 06 1C          	LD	B,01CH
DE6C ED 79          	OUT	(C),A
DE6E ED A3          	OUTI
DE70 FB             	EI
DE71 18 F1          	JR	BEEP1
DE73                
DE73                OT49SB:
DE73 C5             	PUSH	BC
DE74 CD 8F DE       	CALL	CANW
DE77 01 00 19       	LD	BC,01900H
DE7A ED 79          	OUT	(C),A
DE7C C1             	POP	BC
DE7D C9             	RET
DE7E                
DE7E                IN49SB:
DE7E C5             	PUSH	BC
DE7F 01 01 1A       	LD	BC,01A01H
DE82                CANR:
DE82 ED 78          	IN	A,(C)
DE84 E6 20          	AND	020H
DE86 20 FA          	JR	NZ,CANR
DE88 01 00 19       	LD	BC,01900H
DE8B ED 78          	IN	A,(C)
DE8D C1             	POP	BC
DE8E C9             	RET
DE8F                
DE8F                CANW:
DE8F 01 01 1A       	LD	BC,01A01H
DE92 ED 48          	IN	C,(C)
DE94 CB 71          	BIT	6,C
DE96 20 F7          	JR	NZ,CANW
DE98 C9             	RET
DE99                
DE99                COMOUT:
DE99 FB             	EI
DE9A CD 73 DE       	CALL	OT49SB
DE9D CD 8F DE       	CALL	CANW
DEA0 F3             	DI
DEA1 C9             	RET
DEA2                
DEA2                INSERT:
DEA2 D5             	PUSH	DE
DEA3 CD D3 EF       	CALL	_POS
DEA6 3A B1 EF       	LD	A,(_WIDTH)
DEA9 95             	SUB	L
DEAA ED 4B 8E EF    	LD	BC,(_TXADR)
DEAE 11 00 20       	LD	DE,02000H	;D:Text E:Kanji
DEB1 2A 96 EF       	LD	HL,(_COLORF)	;L:Color
DEB4 CB E8          	SET	5,B
DEB6                C12X1:
DEB6 CD BE DE       	CALL	C12S
DEB9 03             	INC	BC
DEBA 20 FA          	JR	NZ,C12X1
DEBC D1             	POP	DE
DEBD C9             	RET
DEBE                
DEBE                C12S:
DEBE CB E0          	SET	4,B
DEC0 CB D8          	SET	3,B
DEC2 ED 60          	IN	H,(C)
DEC4 ED 59          X1PAT:	OUT	(C),E
DEC6 5C             	LD	E,H
DEC7 CB 98          	RES	3,B
DEC9 ED 60          	IN	H,(C)
DECB ED 51          	OUT	(C),D
DECD 54             	LD	D,H
DECE CB A0          	RES	4,B
DED0 ED 60          	IN	H,(C)
DED2 ED 69          	OUT	(C),L
DED4 6C             	LD	L,H
DED5 3D             	DEC	A
DED6 C9             	RET
DED7                
DED7                CTRL0C:
DED7 CD 1F DE       	CALL	CTRL0B
DEDA                CTRL06:
DEDA ED 4B 8E EF    	LD	BC,(_TXADR)
DEDE                C1AX1:
DEDE 78             	LD	A,B
DEDF F6 38          	OR	038H
DEE1 47             	LD	B,A
DEE2 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DEE4 CB 98          	RES	3,B
DEE6 3E 20          	LD	A,020H
DEE8 ED 79          	OUT	(C),A		;Text
DEEA CB A0          	RES	4,B
DEEC 3A 96 EF       	LD	A,(_COLORF)
DEEF ED 79          	OUT	(C),A		;Color
DEF1 03             	INC	BC
DEF2 CB A8          	RES	5,B
DEF4 2A BA EF       	LD	HL,(_PAGE_MINUS)
DEF7 09             	ADD	HL,BC
DEF8 30 E4          	JR	NC,C1AX1
DEFA C9             	RET
DEFB                
DEFB                CTRL04:
DEFB CD D3 EF       	CALL	_POS
DEFE 7D             	LD	A,L
DEFF B7             	OR	A
DF00 C8             	RET	Z
DF01                CTRL03:
DF01 CD 04 DE       	CALL	CTRL0D
DF04                CTRL0A:
DF04                CTRL1F:
DF04 ED 4B 8E EF    	LD	BC,(_TXADR)
DF08 2A B1 EF       	LD	HL,(_WIDTH)
DF0B 26 00          	LD	H,0
DF0D 09             	ADD	HL,BC
DF0E 44             	LD	B,H
DF0F 4D             	LD	C,L
DF10 2A BA EF       	LD	HL,(_PAGE_MINUS)
DF13 09             	ADD	HL,BC
DF14 3F             	CCF
DF15 9F             	SBC	A,A
DF16 C3 78 DD       	JP	PRINTE8
DF19                
DF19                CTRL0E:
DF19 CD D3 EF       	CALL	_POS
DF1C 7C             	LD	A,H
DF1D 18 04          	JR	SCR1
DF1F                SCR:
DF1F 3A 97 EF       	LD	A,(_LINE)
DF22 3D             	DEC	A
DF23                SCR1:
DF23 C5             	PUSH	BC
DF24 D5             	PUSH	DE
DF25 F5             	PUSH	AF
DF26 3E 07          	LD	A,7
DF28 21 59 DF       	LD	HL,SCRDMAD
DF2B CD 4F DF       	CALL	SETDMA
DF2E F1             	POP	AF
DF2F 21 00 38       	LD	HL,03800H
DF32                
DF32                SCRUP1:
DF32 B7             	OR	A
DF33 28 4D          	JR	Z,SCRCL
DF35 F5             	PUSH	AF
DF36 CD 60 DF       	CALL	UPSUB		;kanji
DF39 3A BC EF       	LD	A,(_WIDTH_MINUS)
DF3C 5F             	LD	E,A
DF3D 16 F7          	LD	D,0F7H
DF3F 19             	ADD	HL,DE
DF40 D5             	PUSH	DE
DF41 CD 60 DF       	CALL	UPSUB		;Text
DF44 D1             	POP	DE
DF45 19             	ADD	HL,DE
DF46 CD 60 DF       	CALL	UPSUB		;Color
DF49 CB E4          	SET	4,H
DF4B F1             	POP	AF
DF4C 3D             	DEC	A
DF4D 18 E3          	JR	SCRUP1
DF4F                
DF4F                SETDMA:
DF4F 01 87 1F       	LD	BC,01F87H
DF52                SDMA:
DF52 04             	INC	B
DF53 ED A3          	OUTI
DF55 3D             	DEC	A
DF56 20 FA          	JR	NZ,SDMA
DF58 C9             	RET
DF59                
DF59                SCRDMAD:
DF59 C3             	DB	0C3H		;WR6 リセット
DF5A 9A             	DB	09AH		;WR5 ストップ WAIT READY:HIGH
DF5B 65             	DB	065H		;WR0 ブロック長(LH)
DF5C 4F 00          	DW	79
DF5E 1C             	DB	01CH		;WR1 ポートAインクリメント I/O
DF5F 18             	DB	018H		;WR0 ポートAアドレス(LH)
DF60                
DF60                UPSUB:
DF60 3A B1 EF       	LD	A,(_WIDTH)
DF63 5F             	LD	E,A
DF64 16 00          	LD	D,0
DF66 3E CD          	LD	A,0CDH		;WR4 バースト ポートB開始アドレス(LH)
DF68 ED 79          	OUT	(C),A
DF6A ED 69          	OUT	(C),L		;SOURCE
DF6C ED 61          	OUT	(C),H
DF6E 19             	ADD	HL,DE
DF6F 3E 1D          	LD	A,01DH		;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
DF71 ED 79          	OUT	(C),A
DF73 ED 69          	OUT	(C),L		;DEST
DF75 ED 61          	OUT	(C),H
DF77                GO_DMA:
DF77 3E CF          	LD	A,0CFH
DF79 ED 79          	OUT	(C),A		;WR6 ロード
DF7B 3E B3          	LD	A,0B3H
DF7D ED 79          	OUT	(C),A		;WR6 強制RDY
DF7F ED 49          	OUT	(C),C		;WR6 イネーブル
DF81 C9             	RET
DF82                
DF82                SCRCL:
DF82 44             	LD	B,H
DF83 4D             	LD	C,L
DF84 2A B1 EF       	LD	HL,(_WIDTH)
DF87 CD EA DD       	CALL	LINECL
DF8A D1             	POP	DE
DF8B C1             	POP	BC
DF8C C9             	RET
DF8D                
DF8D                SCRN:
DF8D D5             	PUSH	DE
DF8E ED 58          	IN	E,(C)		;Text
DF90 3A 18 00       	LD	A,(00018H)
DF93 3C             	INC	A
DF94 28 1E          	JR	Z,SCRN2
DF96 CB D8          	SET	3,B
DF98 ED 50          	IN	D,(C)		;Kanji
DF9A 28 16          	JR	Z,SCRN1
DF9C AF             	XOR	A
DF9D C5             	PUSH	BC
DF9E 01 37 30       	LD	BC,03037H	;VRMJIS
DFA1 DF             	RST	018H
DFA2 01 52 2F       	LD	BC,02F52H	;JISSFT
DFA5 DF             	RST	018H
DFA6 C1             	POP	BC
DFA7 ED 78          	IN	A,(C)
DFA9 CB 98          	RES	3,B
DFAB E6 40          	AND	040H
DFAD 20 05          	JR	NZ,SCRN2
DFAF 7A             	LD	A,D
DFB0 D1             	POP	DE
DFB1 C9             	RET
DFB2                SCRN1:
DFB2 CB 98          	RES	3,B
DFB4                SCRN2:
DFB4 7B             	LD	A,E
DFB5 D1             	POP	DE
DFB6 C9             	RET
DFB7                SCRNE:
DFB7                POS:
DFB7 2A 8E EF       	LD	HL,(_TXADR)
DFBA C5             	PUSH	BC
DFBB ED 4B BC EF    	LD	BC,(_WIDTH_MINUS)
DFBF AF             	XOR	A
DFC0                POS1:
DFC0 09             	ADD	HL,BC
DFC1 3C             	INC	A
DFC2 38 FC          	JR	C,POS1
DFC4 ED 42          	SBC	HL,BC
DFC6 3D             	DEC	A
DFC7 67             	LD	H,A
DFC8 C1             	POP	BC
DFC9 A7             	AND	A
DFCA C9             	RET
DFCB                
DFCB                GETL:
DFCB CD D3 EF       	CALL	_POS
DFCE E5             	PUSH	HL
DFCF 3E CD          	LD	A,0CDH		;CALL ????
DFD1 32 D3 DC       	LD	(INSFLG),A
DFD4                GETL1:
DFD4 CD 8C DB       	CALL	_SYS08
DFD7 FE 09          	CP	9
DFD9 20 08          	JR	NZ,GETL1V
DFDB 21 00 FF       	LD	HL,KBUF
DFDE CD 0D D8       	CALL	MSX
DFE1 18 F1          	JR	GETL1
DFE3                GETL1V:
DFE3 5F             	LD	E,A
DFE4 CD CD EF       	CALL	_PRINT
DFE7                
DFE7 7B             	LD	A,E
DFE8 FE 0D          	CP	00DH
DFEA 20 E8          	JR	NZ,GETL1
DFEC 3E 01          	LD	A,1		;LD BC,????
DFEE 32 D3 DC       	LD	(INSFLG),A
DFF1 11 00 FF       	LD	DE,KBUF
DFF4 3A B1 EF       	LD	A,(_WIDTH)
DFF7 47             	LD	B,A
DFF8 CD E8 D4       	CALL	ZERO_MEMORY_DE
DFFB                
DFFB D1             	POP	DE
DFFC CD D3 EF       	CALL	_POS
DFFF 6B             	LD	L,E
E000 3A B1 EF       	LD	A,(_WIDTH)
E003 95             	SUB	L
E004 57             	LD	D,A
E005 CD 2C DE       	CALL	LOC1
E008 4D             	LD	C,L
E009 7C             	LD	A,H
E00A F6 30          	OR	030H
E00C 47             	LD	B,A
E00D 5A             	LD	E,D
E00E 21 00 FF       	LD	HL,KBUF
E011                GETL2:
E011 CD D0 EF       	CALL	_SCRN
E014 03             	INC	BC
E015 77             	LD	(HL),A
E016 23             	INC	HL
E017 1D             	DEC	E
E018 20 F7          	JR	NZ,GETL2
E01A                GETL3:
E01A 2B             	DEC	HL
E01B 7E             	LD	A,(HL)
E01C FE 21          	CP	021H
E01E D0             	RET	NC
E01F 36 00          	LD	(HL),0
E021 15             	DEC	D
E022 20 F6          	JR	NZ,GETL3
E024 C9             	RET
E025                
E025                INKEY:
E025 FB             	EI
E026 E5             	PUSH	HL
E027 2A 90 EF       	LD	HL,(_KEYPS)
E02A 7C             	LD	A,H
E02B AD             	XOR	L
E02C 28 09          	JR	Z,INKEY1
E02E 7C             	LD	A,H
E02F 3C             	INC	A
E030 32 91 EF       	LD	(_KEYPS+1),A
E033 6F             	LD	L,A
E034 26 FE          	LD	H,KEYBF/256
E036 7E             	LD	A,(HL)
E037                INKEY1:
E037 E1             	POP	HL
E038 B7             	OR	A
E039 C9             	RET
E03A                
E03A 00 00 10 15    AT_RS	EQU	SCR1-AT_SCR1
E03A                	INCLUDE	"LDFILE.ASM"
E03A                
E03A                ;	LSX-Dodgers FILE
E03A                
E03A                FILEC:
E03A CD 45 E0       	CALL	FILE
E03D                FILEC2:
E03D 3A 15 EF       	LD	A,(FDRV+1)
E040 FE 20          	CP	020H
E042 C8             	RET	Z
E043 18 39          	JR	SETDIR1
E045                
E045                FILE:
E045 AF             	XOR	A
E046 32 14 EF       	LD	(FDRV),A
E049 67             	LD	H,A
E04A 6F             	LD	L,A
E04B 22 22 EF       	LD	(FDRV+14),HL
E04E CD 1C E1       	CALL	SPCUT
E051 CD 01 E1       	CALL	CCHK3
E054 28 12          	JR	Z,DEVI1
E056 13             	INC	DE
E057 1A             	LD	A,(DE)
E058 1B             	DEC	DE
E059 FE 3A          	CP	':'
E05B 20 0B          	JR	NZ,DEVI1
E05D 1A             	LD	A,(DE)		;DRIVE
E05E CD 51 E3       	CALL	CAP
E061 D6 40          	SUB	'@'
E063 13             	INC	DE
E064 13             	INC	DE
E065 32 14 EF       	LD	(FDRV),A
E068                DEVI1:
E068 1A             	LD	A,(DE)
E069 D6 5C          	SUB	05CH		;\
E06B 20 09          	JR	NZ,NOROOT
E06D 6F             	LD	L,A		;A=0でH=0のはずなのでHL=0
E06E 22 2E EF       	LD	(FDRV+26),HL
E071 2C             	INC	L
E072 22 22 EF       	LD	(FDRV+14),HL
E075 13             	INC	DE
E076                NOROOT:
E076                
E076                SETDIR:
E076 CD A2 E0       	CALL	FILED
E079 1A             	LD	A,(DE)
E07A FE 5C          	CP	05CH		;\
E07C C0             	RET	NZ
E07D 13             	INC	DE
E07E                SETDIR1:
E07E 3E 10          	LD	A,010H		;Directory
E080 32 21 EF       	LD	(FDRV+13),A
E083 D5             	PUSH	DE
E084 11 14 EF       	LD	DE,FDRV
E087 2A 1E F0       	LD	HL,(STABLE+2*00FH)
E08A CD 0F 00       	CALL	JP_HL
E08D D1             	POP	DE
E08E B7             	OR	A
E08F C0             	RET	NZ
E090                
E090 3A 21 EF       	LD	A,(FDRV+13)
E093 CB 67          	BIT	4,A
E095 C8             	RET	Z
E096                
E096 CD E9 E0       	CALL	FILEI
E099 2A 2E EF       	LD	HL,(FDRV+26)
E09C 23             	INC	HL
E09D 22 22 EF       	LD	(FDRV+14),HL
E0A0 18 D4          	JR	SETDIR
E0A2                
E0A2                FILED:
E0A2 CD E9 E0       	CALL	FILEI
E0A5 21 15 EF       	LD	HL,FNAME
E0A8                
E0A8 06 08          	LD	B,8
E0AA                FILE2:
E0AA CD F6 E0       	CALL	CCHKF
E0AD C8             	RET	Z
E0AE FE 2A          	CP	'*'
E0B0 28 2E          	JR	Z,FILE9
E0B2 FE 2E          	CP	'.'
E0B4 28 0C          	JR	Z,FILE4
E0B6 77             	LD	(HL),A
E0B7 23             	INC	HL
E0B8 10 F0          	DJNZ	FILE2
E0BA                
E0BA                FILE3:
E0BA CD F6 E0       	CALL	CCHKF
E0BD C8             	RET	Z
E0BE FE 2E          	CP	'.'
E0C0 20 F8          	JR	NZ,FILE3
E0C2                
E0C2                FILE4:
E0C2 21 1D EF       	LD	HL,FNAME+8
E0C5 06 03          	LD	B,3
E0C7                
E0C7                FILE4L:
E0C7 CD F6 E0       	CALL	CCHKF
E0CA C8             	RET	Z
E0CB FE 2E          	CP	'.'
E0CD 20 08          	JR	NZ,FILE12
E0CF 32 15 EF       	LD	(FNAME),A	;Parent directory(..)
E0D2 32 16 EF       	LD	(FNAME+1),A
E0D5 3E 20          	LD	A,020H
E0D7                FILE12:
E0D7 FE 2A          	CP	'*'
E0D9 28 0A          	JR	Z,FILE10
E0DB 77             	LD	(HL),A
E0DC 23             	INC	HL
E0DD 10 E8          	DJNZ	FILE4L
E0DF C9             	RET
E0E0                
E0E0                FILE9:				;名前の*処理、名前の残りを?で埋める
E0E0 CD E5 E0       	CALL	FILE10
E0E3 18 D5          	JR	FILE3
E0E5                
E0E5                FILE10:
E0E5 3E 3F          	LD	A,'?'
E0E7 18 08          	JR	FILL_MEMORY
E0E9                FILEI:				;名前＋拡張子をスペースで初期化
E0E9 3E 20          	LD	A,020H
E0EB 01 00 0B       	LD	BC,11*256	;C=0にしておく
E0EE 21 15 EF       	LD	HL,FNAME
E0F1                FILL_MEMORY:			;HLからBバイトAで埋める
E0F1 77             	LD	(HL),A
E0F2 23             	INC	HL
E0F3 10 FC          	DJNZ	FILL_MEMORY
E0F5 C9             	RET
E0F6                
E0F6                CCHKF:
E0F6 1A             	LD	A,(DE)
E0F7 CD FE E0       	CALL	CCHK2
E0FA C8             	RET	Z
E0FB C3 69 E4       	JP	FKAN
E0FE                
E0FE                CCHK2:
E0FE 0C             	INC	C
E0FF 0D             	DEC	C
E100 C0             	RET	NZ
E101                CCHK3:				;ZF=1 で使えない文字
E101 FE 2B          	CP	'+'
E103 C8             	RET	Z
E104 FE 2C          	CP	','
E106 C8             	RET	Z
E107 FE 2F          	CP	'/'
E109 C8             	RET	Z
E10A FE 3A          	CP	':'
E10C C8             	RET	Z
E10D FE 3B          	CP	';'
E10F C8             	RET	Z
E110 FE 3D          	CP	'='
E112 C8             	RET	Z
E113 FE 5C          	CP	05CH	;\
E115 C8             	RET	Z
E116 FE 20          	CP	020H
E118 D0             	RET	NC
E119 BF             	CP	A		;Z=1
E11A C9             	RET
E11B                
E11B                SS1:
E11B 13             	INC	DE
E11C                SPCUT:				;スペースをカット
E11C 1A             	LD	A,(DE)
E11D FE 20          	CP	020H
E11F 28 FA          	JR	Z,SS1
E121 C9             	RET
E122                
E122                SETDRVF:
E122 11 14 EF       	LD	DE,FDRV
E125                SETDRV0:
E125 CD 2E E1       	CALL	SETDRV
E128 FD E1          	POP	IY
E12A C1             	POP	BC
E12B D1             	POP	DE
E12C E1             	POP	HL
E12D C9             	RET
E12E                
E12E                SETDRV:
E12E E3             	EX	(SP),HL		;HL=RETRN ADDRESS
E12F D5             	PUSH	DE		;PUSH HL/DE/BC/IY
E130 C5             	PUSH	BC
E131 1A             	LD	A,(DE)
E132 D5             	PUSH	DE
E133 FD E3          	EX	(SP),IY
E135                
E135 CD 41 E1       	CALL	GETDRV
E138 3C             	INC	A
E139 FD 77 00       	LD	(IY+0),A	;(FCB)ドライブ番号
E13C 3D             	DEC	A
E13D CD D9 EF       	CALL	_CHGDRV
E140                
E140 E9             	JP	(HL)
E141                
E141                GETDRV:
E141 E6 7F          	AND	07FH
E143 D6 01          	SUB	001H
E145 30 03          	JR	NC,GETDRV1
E147 3A 87 EF       	LD	A,(_DVSW)	;Current Drive
E14A                GETDRV1:
E14A 32 88 EF       	LD	(_DRV),A
E14D C9             	RET
E14E                
E14E                SOPENX:
E14E 11 39 EF       	LD	DE,SFILE
E151 1A             	LD	A,(DE)
E152 FD BE 00       	CP	(IY+0)		;(FCB)ドライブ番号
E155 20 24          	JR	NZ,SOPEN
E157 13             	INC	DE
E158 FD E5          	PUSH	IY
E15A E1             	POP	HL
E15B 23             	INC	HL
E15C CD E9 E2       	CALL	CPFILE
E15F 20 1A          	JR	NZ,SOPEN
E161                
E161 2A F4 F0       	LD	HL,(SCDIR)
E164 FD 75 0E       	LD	(IY+14),L	;(FCB)アクセスするディレクトリのクラスタ番号+1
E167 FD 74 0F       	LD	(IY+15),H
E16A                
E16A 2A F8 F0       	LD	HL,(SFNDF)	;Direcroty location and Flags
E16D 22 9F EF       	LD	(_FILEN),HL
E170                
E170 ED 5B F6 F0    	LD	DE,(SFBPS)
E174 21 39 EF       	LD	HL,SFILE
E177 36 FF          	LD	(HL),0FFH
E179 23             	INC	HL
E17A C9             	RET
E17B                SOPEN:
E17B 21 91 E2       	LD	HL,FILESE
E17E                SOPENC:
E17E 22 B7 E1       	LD	(OPENPAT+1),HL
E181                
E181 CD E2 EF       	CALL	_RDFATX		;Detect Media
E184 38 56          	JR	C,RDDERR
E186                
E186 AF             	XOR	A
E187 32 9F EF       	LD	(_FILEN),A
E18A CD 96 E3       	CALL	LDDIRX1		;A=0で呼び出す
E18D 28 18          	JR	Z,SDIRX1
E18F                
E18F CD 82 E2       	CALL	READ_DIR	;Sub Directory
E192 38 08          	JR	C,SDIRX0
E194 2A 7E F0       	LD	HL,(_DTBUF)
E197 7E             	LD	A,(HL)
E198 FE 2E          	CP	'.'
E19A 28 0F          	JR	Z,SOPEN1
E19C                SDIRX0:
E19C AF             	XOR	A
E19D 32 A0 EF       	LD	(_DIRF),A
E1A0 FD 36 0E 01    	LD	(IY+14),1	;(FCB)レコードサイズ
E1A4 FD 77 0F       	LD	(IY+15),A
E1A7                SDIRX1:
E1A7 ED 5B FC F0    	LD	DE,(_DIRPS)	;Root Directory
E1AB                SOPEN1:
E1AB 0E 20          SDECPAT:LD	C,32		;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
E1AD                SOPEN1X:
E1AD CD 82 E2       	CALL	READ_DIR	;FILE SEARCH
E1B0 38 2A          	JR	C,RDDERR
E1B2 2A 7E F0       	LD	HL,(_DTBUF)
E1B5                SOPEN2:
E1B5 D5             	PUSH	DE
E1B6 CD 91 E2       OPENPAT:CALL	FILESE		;(self-modifying code)
E1B9 D1             	POP	DE
E1BA 38 6E          	JR	C,SOPENE
E1BC 28 1B          	JR	Z,SCF_FF_RET
E1BE                SOPEN3:
E1BE 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E1C1 B7             	OR	A
E1C2 20 0C          	JR	NZ,SOPEN5
E1C4 13             	INC	DE		;ルートディレクトリ
E1C5 E5             	PUSH	HL
E1C6 21 0C 00       MD_PAT:	LD	HL,12		;(self-modifying code)MAXDIR
E1C9 ED 52          	SBC	HL,DE		;CF=0 なので SUB HL,DE
E1CB E1             	POP	HL
E1CC 20 DD          	JR	NZ,SOPEN1
E1CE 18 07          	JR	SOPEN6
E1D0                SOPEN5:
E1D0 CD C5 EA       	CALL	GNCLX		;END DIR
E1D3 D8             	RET	C
E1D4 CD 49 E3       	CALL	ENDCL
E1D7                SOPEN6:
E1D7 38 D2          	JR	C,SOPEN1
E1D9                SCF_FF_RET:
E1D9 37             	SCF			;CF=1
E1DA 9F             	SBC	A,A		;A=0FFH
E1DB C9             	RET
E1DC                
E1DC                RDDERR:
E1DC BF             	CP	A		;READ ERR CF=1 ZF=1
E1DD 37             	SCF
E1DE C9             	RET
E1DF                
E1DF                NOPEN:
E1DF 21 91 E2       	LD	HL,FILESE
E1E2 22 B7 E1       	LD	(OPENPAT+1),HL
E1E5 FD 2A 98 EF    	LD	IY,(_FCB)
E1E9 CD 7C E4       	CALL	CHKWILDX
E1EC 30 EB          	JR	NC,SCF_FF_RET
E1EE FD 7E 00       	LD	A,(IY+0)	;(FCB)ドライブ番号
E1F1 3D             	DEC	A
E1F2 32 88 EF       	LD	(_DRV),A
E1F5 CD D9 EF       	CALL	_CHGDRV
E1F8 D8             	RET	C
E1F9 2A F8 F0       	LD	HL,(SFNDF)	;Direcroty location and Flags
E1FC 22 9F EF       	LD	(_FILEN),HL
E1FF                
E1FF CD 91 E3       	CALL	LDDIRX
E202 ED 5B 9A EF    	LD	DE,(_FBPS)
E206 CD 82 E2       	CALL	READ_DIR
E209 38 D1          	JR	C,RDDERR
E20B 3A 9E EF       	LD	A,(_FBCNT)
E20E 3D             	DEC	A
E20F 28 AD          	JR	Z,SOPEN3
E211                NOPEN2:
E211 2A 9C EF       	LD	HL,(_FBAD)
E214 01 20 00       	LD	BC,020H
E217 09             	ADD	HL,BC
E218 4F             	LD	C,A
E219 18 9A          	JR	SOPEN2
E21B                
E21B                SOPENE2:
E21B 22 9C EF       	LD	(_FBAD),HL
E21E 79             	LD	A,C
E21F 32 9E EF       	LD	(_FBCNT),A
E222 ED 53 9A EF    	LD	(_FBPS),DE
E226 FD 22 98 EF    	LD	(_FCB),IY
E22A                SOPENE:
E22A AF             	XOR	A
E22B C9             	RET
E22C                
E22C                COPEN:
E22C FD 36 0D 20    	LD	(IY+13),020H	;(FCB)属性(アトリビュート)
E230                
E230 21 AE E2       	LD	HL,NEXTSE
E233 CD 7E E1       	CALL	SOPENC
E236 D0             	RET	NC
E237 C8             	RET	Z
E238 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E23B B7             	OR	A
E23C 37             	SCF
E23D C8             	RET	Z		;ルートディレクトリ
E23E 06 01          	LD	B,1
E240 CD DA E4       	CALL	WRDF
E243 D8             	RET	C
E244 ED 5B FE F0    	LD	DE,(_CLPS)
E248 D5             	PUSH	DE
E249 CD 12 E3       	CALL	DCPAT
E24C CD 50 E9       	CALL	DRDNX
E24F 2A 7E F0       	LD	HL,(_DTBUF)	;ディレクトリエントリを0クリア
E252 3A 4E E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E255 47             	LD	B,A
E256 AF             	XOR	A
E257 4F             	LD	C,A
E258                COPENCL:
E258 77             	LD	(HL),A
E259 ED A1          	CPI			;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
E25B EA 58 E2       	JP	PE,COPENCL
E25E                
E25E 3A 30 E3       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ数
E261 3D             	DEC	A
E262 28 19          	JR	Z,COPENE
E264 3E 01          	LD	A,1		;1セクタ辺りのセクタ数が2以上の場合
E266 32 BD EA       	LD	(_SECPS+1),A
E269 D1             	POP	DE		;DE=(_CLPS)
E26A D5             	PUSH	DE
E26B                COPEN1:
E26B D5             	PUSH	DE		;データバッファに入らないセクタもゼロクリア
E26C C5             	PUSH	BC
E26D 2A 7E F0       	LD	HL,(_DTBUF)
E270 CD 2C E3       	CALL	CLUSTX
E273 CD 28 EC       	CALL	DWT24
E276 C1             	POP	BC
E277 D1             	POP	DE
E278 CD BC EA       	CALL	NEXTX
E27B 20 EE          	JR	NZ,COPEN1
E27D                COPENE:
E27D 2A 7E F0       	LD	HL,(_DTBUF)
E280 D1             	POP	DE
E281 C9             	RET
E282                
E282                READ_DIR:
E282 ED 53 FE F0    	LD	(_CLPS),DE
E286 C5             	PUSH	BC
E287 D5             	PUSH	DE
E288 CD 12 E3       	CALL	DCPAT
E28B CD 30 E9       	CALL	DRDX
E28E D1             	POP	DE
E28F C1             	POP	BC
E290 C9             	RET
E291                
E291                FILESE:
E291 7E             	LD	A,(HL)
E292 B7             	OR	A
E293 C8             	RET	Z		;END:ZF=1 CF=0
E294 FE E5          	CP	0E5H
E296 28 0E          	JR	Z,FILESE1
E298 FD E5          	PUSH	IY
E29A D1             	POP	DE
E29B 13             	INC	DE
E29C E5             	PUSH	HL
E29D CD E9 E2       	CALL	CPFILE
E2A0 CC 0A E3       	CALL	Z,CPFILE2
E2A3 E1             	POP	HL
E2A4 37             	SCF
E2A5 C8             	RET	Z		;!!!:(ZF=1) CF=1
E2A6                FILESE1:
E2A6 CD BD E2       	CALL	FNEXT
E2A9 20 E6          	JR	NZ,FILESE
E2AB                ZF0_CF0_AFF_RET:
E2AB F6 FF          	OR	0FFH		;ZF=0 CF=0
E2AD C9             	RET
E2AE                
E2AE                NEXTSE:
E2AE 7E             	LD	A,(HL)
E2AF B7             	OR	A
E2B0 37             	SCF
E2B1 C8             	RET	Z		;!!!:ZF=1 CF=1
E2B2 FE E5          	CP	0E5H
E2B4 37             	SCF
E2B5 C8             	RET	Z		;!!!:(ZF=1) CF=1
E2B6 CD BD E2       	CALL	FNEXT
E2B9 20 F3          	JR	NZ,NEXTSE
E2BB 18 EE          	JR	ZF0_CF0_AFF_RET
E2BD                
E2BD                FNEXT:
E2BD E5             	PUSH	HL
E2BE 21 9F EF       	LD	HL,_FILEN
E2C1 34             	INC	(HL)
E2C2 E1             	POP	HL
E2C3 11 20 00       	LD	DE,020H
E2C6 19             	ADD	HL,DE
E2C7 0D             	DEC	C
E2C8 C9             	RET
E2C9                
E2C9                CPNAME:
E2C9 C5             	PUSH	BC
E2CA D5             	PUSH	DE
E2CB E5             	PUSH	HL
E2CC CD E3 E2       	CALL	CPFILE4
E2CF E1             	POP	HL
E2D0 23             	INC	HL
E2D1 23             	INC	HL
E2D2 23             	INC	HL
E2D3 23             	INC	HL
E2D4 D1             	POP	DE
E2D5 C1             	POP	BC
E2D6 20 05          	JR	NZ,CPNAME1
E2D8 7E             	LD	A,(HL)
E2D9 23             	INC	HL
E2DA 66             	LD	H,(HL)
E2DB 6F             	LD	L,A
E2DC C9             	RET
E2DD                CPNAME1:
E2DD 23             	INC	HL
E2DE 23             	INC	HL
E2DF 10 E8          	DJNZ	CPNAME
E2E1 37             	SCF
E2E2 C9             	RET
E2E3                
E2E3                CPFILE4:
E2E3 C5             	PUSH	BC
E2E4 01 00 04       	LD	BC,00400H
E2E7 18 04          	JR	CPSTR1
E2E9                CPFILE:
E2E9 C5             	PUSH	BC
E2EA 01 00 0B       	LD	BC,00B00H
E2ED                CPSTR1:
E2ED 1A             	LD	A,(DE)
E2EE FE 3F          	CP	'?'		;Wild card
E2F0 28 12          	JR	Z,CPSTR2
E2F2 7E             	LD	A,(HL)
E2F3 CD 62 E4       	CALL	FKANC
E2F6 E5             	PUSH	HL
E2F7 67             	LD	H,A
E2F8 1A             	LD	A,(DE)
E2F9 CB 01          	RLC	C
E2FB CD 62 E4       	CALL	FKANC
E2FE CB 09          	RRC	C
E300 BC             	CP	H		;CP (HL),(DE)
E301 E1             	POP	HL
E302 20 04          	JR	NZ,CPSTR3
E304                CPSTR2:
E304 13             	INC	DE
E305 23             	INC	HL
E306 10 E5          	DJNZ	CPSTR1
E308                CPSTR3:
E308 C1             	POP	BC
E309 C9             	RET
E30A                
E30A                CPFILE2:
E30A FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E30D F6 E1          	OR	0E1H
E30F 2F             	CPL
E310 A6             	AND	(HL)
E311 C9             	RET
E312                
E312                DCPAT:
E312 0E 00          	LD	C,0
E314 2A 7E F0       	LD	HL,(_DTBUF)
E317 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E31A B7             	OR	A
E31B C8             	RET	Z		;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
E31C 3A 30 E3       	LD	A,(SPCPAT+1)
E31F 4F             	LD	C,A
E320 3A BD EA       	LD	A,(_SECPS+1)
E323 B9             	CP	C
E324 38 01          	JR	C,DC1
E326 AF             	XOR	A
E327                DC1:
E327 F6 80          	OR	080H
E329 32 A0 EF       	LD	(_DIRF),A	;bit0-6:セクタインデックス
E32C                CLUSTX:
E32C E5             	PUSH	HL
E32D EB             	EX	DE,HL
E32E AF             	XOR	A
E32F 0E 01          SPCPAT:	LD	C,1		;自己書き換え（1クラスタの論理セクタ数）
E331                L_CLDBL:
E331 CB 19          	RR	C		;->CF
E333 38 04          	JR	C,E_CLDBL
E335 29             	ADD	HL,HL		;*2
E336 8F             	ADC	A,A
E337 18 F8          	JR	L_CLDBL
E339                E_CLDBL:
E339 4F             	LD	C,A
E33A 3A BD EA       	LD	A,(_SECPS+1)
E33D B5             	OR	L
E33E 6F             	LD	L,A
E33F 11 08 00       CLSPAT:	LD	DE,8	;+8 (2D)  !ADDCL (self-modifying code)
E342 AF             	XOR	A
E343 19             	ADD	HL,DE	;データ格納領域の先頭論理セクタ番号
E344 89             	ADC	A,C
E345 4F             	LD	C,A
E346 EB             	EX	DE,HL
E347 E1             	POP	HL
E348 C9             	RET
E349                
E349                ENDCL:
E349 7A             	LD	A,D	;END CLUSTER
E34A FE 01          CLPAT1:	CP	1	;164=356	(self-modifying code)
E34C C0             	RET	NZ
E34D 7B             	LD	A,E
E34E FE 64          CLPAT2:	CP	064H	;		(self-modifying code)
E350 C9             	RET
E351                
E351                CAP:
E351 FE 61          	CP	'a'
E353 D8             	RET	C
E354 FE 7B          	CP	'z'+1
E356 D0             	RET	NC
E357 D6 20          	SUB	020H
E359 C9             	RET
E35A                CAP2:
E35A CD 51 E3       	CALL	CAP
E35D                CAP3:
E35D CD 66 E3       	CALL	CAP4
E360 FE 21          	CP	021H
E362 D0             	RET	NC
E363 3E A0          	LD	A,0A0H
E365 C9             	RET
E366                CAP4:
E366 FE 05          	CP	5
E368 C0             	RET	NZ
E369 3E E5          	LD	A,0E5H
E36B C9             	RET
E36C                
E36C                CHDIR:
E36C CD 57 ED       	CALL	GETDPBD
E36F 38 1D          	JR	C,CHDIR2
E371 DD 75 1A       	LD	(IX+01AH),L		;_SDIR_
E374 DD 74 1B       	LD	(IX+01BH),H		;_SDIR_+1
E377 18 15          	JR	CHDIR2		;POP_IX_RET
E379                
E379                LDDIR:
E379 CD 57 ED       	CALL	GETDPBD
E37C DD 5E 1A       	LD	E,(IX+01AH)		;_SDIR_
E37F DD 56 1B       	LD	D,(IX+01BH)		;_SDIR_+1
E382 13             	INC	DE
E383 FD 73 0E       	LD	(IY+14),E	;(FCB)アクセスするディレクトリのクラスタ番号+1
E386 FD 72 0F       	LD	(IY+15),D
E389 1B             	DEC	DE
E38A AF             	XOR	A
E38B 32 A0 EF       	LD	(_DIRF),A
E38E                CHDIR2:
E38E DD E1          	POP	IX
E390 C9             	RET
E391                
E391                LDDIRX:
E391 3A A0 EF       	LD	A,(_DIRF)	;(FCB)アクセスするディレクトリのセクタインデックス
E394 E6 7F          	AND	07FH
E396                LDDIRX1:
E396 32 BD EA       	LD	(_SECPS+1),A
E399 FD 5E 0E       	LD	E,(IY+14)	;(FCB)アクセスするディレクトリのクラスタ番号+1
E39C FD 56 0F       	LD	D,(IY+15)
E39F 1B             	DEC	DE
E3A0 CD 49 E3       	CALL	ENDCL
E3A3 D4 79 E3       	CALL	NC,LDDIR
E3A6                LDDIRS:
E3A6 7A             	LD	A,D
E3A7 B3             	OR	E
E3A8 32 A0 EF       	LD	(_DIRF),A	;ディレクトリか判別
E3AB C9             	RET
E3AC                
E3AC                KILL:
E3AC CD 7C E4       	CALL	CHKWILDX
E3AF 38 34          	JR	C,KILLW
E3B1 CD 4E E1       	CALL	SOPENX
E3B4                KILLS:
E3B4 3E 1F          	LD	A,01FH
E3B6 D4 F8 E3       	CALL	NC,CHKATT
E3B9 D8             	RET	C
E3BA                KILLSX:
E3BA 36 E5          	LD	(HL),0E5H	;DIR
E3BC CD 56 E4       	CALL	WTDB
E3BF 11 1A 00       	LD	DE,01AH
E3C2 19             	ADD	HL,DE
E3C3 5E             	LD	E,(HL)
E3C4 23             	INC	HL
E3C5 56             	LD	D,(HL)
E3C6                KILLS1:
E3C6 CD 49 E3       	CALL	ENDCL
E3C9 D0             	RET	NC		;CF=0
E3CA 21 FE FF       	LD	HL,0-2
E3CD 19             	ADD	HL,DE
E3CE D0             	RET	NC		;DE= 0 or 1
E3CF D5             	PUSH	DE
E3D0 CD F7 EF       	CALL	_GNCL
E3D3 ED 53 FE F0    	LD	(_CLPS),DE
E3D7 D1             	POP	DE
E3D8 21 00 00       	LD	HL,0
E3DB D4 FA EF       	CALL	NC,_SNCL
E3DE D8             	RET	C
E3DF ED 5B FE F0    	LD	DE,(_CLPS)	;FAT
E3E3 18 E1          	JR	KILLS1
E3E5                
E3E5                KILLW:
E3E5 CD 7B E1       	CALL	SOPEN
E3E8                KILLW1:
E3E8 38 0B          	JR	C,KILLW2
E3EA CD 1B E2       	CALL	SOPENE2
E3ED CD B4 E3       	CALL	KILLS
E3F0 CD DF E1       	CALL	NOPEN
E3F3 18 F3          	JR	KILLW1
E3F5                KILLW2:
E3F5 C8             	RET	Z
E3F6 3F             	CCF
E3F7 C9             	RET
E3F8                
E3F8                CHKATT:
E3F8 E5             	PUSH	HL
E3F9 11 0B 00       	LD	DE,00BH
E3FC 19             	ADD	HL,DE
E3FD A6             	AND	(HL)
E3FE E1             	POP	HL
E3FF C8             	RET	Z
E400 37             	SCF
E401 C9             	RET
E402                
E402                NAME:
E402 CD 7C E4       	CALL	CHKWILDX
E405 D8             	RET	C
E406 11 04 00       	LD	DE,4
E409 19             	ADD	HL,DE
E40A 22 22 E4       	LD	(NAMEP+2),HL
E40D 23             	INC	HL
E40E CD 80 E4       	CALL	CHKWILD
E411 D8             	RET	C
E412                
E412 CD 4E E1       	CALL	SOPENX
E415 3E 0F          	LD	A,00FH
E417 D4 F8 E3       	CALL	NC,CHKATT
E41A D8             	RET	C
E41B                
E41B FD 7E 00       	LD	A,(IY+0)
E41E FD E5          	PUSH	IY
E420 FD 21 00 00    NAMEP:	LD	IY,0		;自己書き換え
E424 FD 77 00       	LD	(IY+0),A
E427 CD 4E E1       	CALL	SOPENX
E42A FD E3          	EX	(SP),IY
E42C 3F             	CCF
E42D D4 7B E1       	CALL	NC,SOPEN
E430 EB             	EX	DE,HL
E431 E1             	POP	HL
E432 D8             	RET	C
E433                
E433                SETNAME:
E433 01 00 0B       	LD	BC,11*256
E436 23             	INC	HL
E437 7E             	LD	A,(HL)
E438 FE E5          	CP	0E5H
E43A 20 04          	JR	NZ,SNAME1
E43C 3E 05          	LD	A,5
E43E 18 0E          	JR	SNAME3
E440                SNAME1:
E440 7E             	LD	A,(HL)
E441 0C             	INC	C
E442 0D             	DEC	C
E443 20 09          	JR	NZ,SNAME3
E445 CD 51 E3       	CALL	CAP
E448 FE A0          	CP	0A0H
E44A 20 02          	JR	NZ,SNAME3
E44C 3E 20          	LD	A,020H
E44E                SNAME3:
E44E 12             	LD	(DE),A
E44F 7E             	LD	A,(HL)
E450 23             	INC	HL
E451 CD 69 E4       	CALL	FKAN
E454 10 EA          	DJNZ	SNAME1
E456                WTDB:
E456 3E FF          	LD	A,0FFH
E458 32 39 EF       	LD	(SFILE),A
E45B                SWTDBF:
E45B 3E 01          	LD	A,1
E45D 32 A4 EF       	LD	(_WTDBF),A
E460 AF             	XOR	A
E461 C9             	RET
E462                
E462                FKANC:
E462 CB 41          	BIT	0,C
E464 CC 5A E3       	CALL	Z,CAP2
E467 18 01          	JR	FKANX
E469                FKAN:			;漢字チェック
E469 13             	INC	DE
E46A                FKANX:
E46A CB 41          	BIT	0,C
E46C CB 81          	RES	0,C
E46E C0             	RET	NZ
E46F FE 80          	CP	080H
E471 D8             	RET	C
E472 FE A0          	CP	0A0H
E474 38 03          	JR	C,FKAN1
E476 FE E0          	CP	0E0H
E478 D8             	RET	C
E479                FKAN1:
E479 0C             	INC	C
E47A A7             	AND	A
E47B C9             	RET
E47C                
E47C                CHKWILDX:
E47C FD E5          	PUSH	IY
E47E E1             	POP	HL
E47F 23             	INC	HL
E480                CHKWILD:
E480 06 0B          	LD	B,11
E482 3E 3F          	LD	A,'?'
E484                CHKWIL1:
E484 BE             	CP	(HL)
E485 23             	INC	HL
E486 37             	SCF
E487 C8             	RET	Z
E488 10 FA          	DJNZ	CHKWIL1
E48A AF             	XOR	A
E48B C9             	RET
E48C                
E48C                SDIRENT:		;IY=FCB HL=DIR
E48C D5             	PUSH	DE
E48D E5             	PUSH	HL
E48E FD E5          	PUSH	IY
E490 D1             	POP	DE
E491 EB             	EX	DE,HL
E492 CD 33 E4       	CALL	SETNAME
E495                ;				Attribute
E495 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E498 12             	LD	(DE),A
E499 13             	INC	DE
E49A                ;				Reserved
E49A AF             	XOR	A
E49B 06 0A          	LD	B,10
E49D                SDE1:
E49D 12             	LD	(DE),A
E49E 13             	INC	DE
E49F 10 FC          	DJNZ	SDE1
E4A1                					;(FCB)更新時刻
E4A1 21 EA F0       	LD	HL,SDDATA		;(FCB)更新年月日
E4A4 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
E4A6                SDLOOP:					;(FCB)ファイルのサイズ(バイト単位)
E4A6 7E             	LD	A,(HL)
E4A7 23             	INC	HL
E4A8 32 AD E4       	LD	(SDPAT+2),A
E4AB FD 7E 00       SDPAT:	LD	A,(IY+0)	;LD A,(IY+A)
E4AE 12             	LD	(DE),A
E4AF 13             	INC	DE
E4B0 10 F4          	DJNZ	SDLOOP
E4B2                
E4B2 AF             	XOR	A
E4B3 E1             	POP	HL
E4B4 D1             	POP	DE
E4B5 C9             	RET
E4B6                
E4B6                WOPEN:
E4B6 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E4B9 E6 1F          	AND	01FH
E4BB 37             	SCF
E4BC C0             	RET	NZ
E4BD FD 36 1C FE    	LD	(IY+28),0FEH	;(FCB)オープンモード
E4C1                TOPEN2:
E4C1 AF             	XOR	A
E4C2                TOPEN:				;Initializes the time stamp
E4C2 FD 36 17 FF    	LD	(IY+23),0FFH	;(FCB)更新時刻
E4C6 C9             	RET
E4C7                
E4C7                WRDFX:
E4C7 3A 30 E3       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ
E4CA                L_WRFX:
E4CA 1F             	RRA			;->CF
E4CB 38 06          	JR	C,E_WRFX
E4CD CB 39          	SRL	C
E4CF CB 1C          	RR	H		;CH=CH/2
E4D1 18 F7          	JR	L_WRFX
E4D3                E_WRFX:
E4D3 44             	LD	B,H
E4D4 04             	INC	B
E4D5 3E 37          	LD	A,037H		;SCF
E4D7 32 4D E9       	LD	(DRDN1),A
E4DA                
E4DA                WRDF:				;Bクラスタ分FATを確保する
E4DA 11 02 00       	LD	DE,2
E4DD AF             	XOR	A
E4DE 32 BD EA       	LD	(_SECPS+1),A
E4E1                WRDF1:
E4E1 C5             	PUSH	BC
E4E2 D5             	PUSH	DE
E4E3 CD F7 EF       	CALL	_GNCL
E4E6 38 1C          	JR	C,WRDF3
E4E8 7A             	LD	A,D		;空いているかチェック
E4E9 B3             	OR	E
E4EA 20 27          	JR	NZ,WRDF4
E4EC E1             	POP	HL		;HL=空いているクラスタ
E4ED E5             	PUSH	HL
E4EE ED 5B FE F0    	LD	DE,(_CLPS)	;DE=元の(_CLPS)
E4F2 22 FE F0       	LD	(_CLPS),HL
E4F5 7A             	LD	A,D		;元の(_CLPS)が 0 か?
E4F6 B3             	OR	E
E4F7 20 08          	JR	NZ,WRDF2
E4F9 FD 75 1A       	LD	(IY+26),L	;(FCB)ファイルの先頭クラスタ
E4FC FD 74 1B       	LD	(IY+27),H	;元が空の場合はFCBにクラスタをセットする
E4FF 18 03          	JR	WRDF3
E501                WRDF2:
E501 CD FA EF       	CALL	_SNCL
E504                WRDF3:
E504 D1             	POP	DE
E505 C1             	POP	BC
E506 D8             	RET	C
E507 10 0C          	DJNZ	WRDF5		;ここでループカウンタチェック
E509 ED 5B FE F0    	LD	DE,(_CLPS)
E50D 21 FF FF       	LD	HL,0FFFFH	;FATエントリ終了(EOCマーク)
E510 C3 FA EF       	JP	_SNCL
E513                
E513                WRDF4:				;DEクラスタが空じゃないので次に移動する
E513 D1             	POP	DE
E514 C1             	POP	BC
E515                WRDF5:
E515 13             	INC	DE
E516 CD 49 E3       	CALL	ENDCL
E519 38 C6          	JR	C,WRDF1
E51B 37             	SCF
E51C C9             	RET
E51D                
E51D                RWXR:
E51D 3A 4E E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E520                L_RWX:
E520 1F             	RRA		;->CF
E521 38 08          	JR	C,E_RWX
E523 CB 38          	SRL	B	;BCH=BCH/2
E525 CB 19          	RR	C	;
E527 CB 1C          	RR	H	;
E529 18 F5          	JR	L_RWX
E52B                E_RWX:
E52B FD 5E 1A       	LD	E,(IY+26)	;(FCB)ファイルの先頭クラスタ
E52E FD 56 1B       	LD	D,(IY+27)
E531 AF             	XOR	A
E532 32 BD EA       	LD	(_SECPS+1),A
E535                RWX1:
E535 ED 53 FE F0    	LD	(_CLPS),DE
E539 7A             	LD	A,D
E53A B3             	OR	E
E53B 28 13          	JR	Z,SCF_RET	;RET DE==0 => CF=1
E53D                
E53D 78             	LD	A,B
E53E B1             	OR	C
E53F B4             	OR	H
E540 C8             	RET	Z		;RET BCH==0 => CF=0
E541                
E541 CD C5 EA       	CALL	GNCLX
E544 D8             	RET	C
E545 7C             	LD	A,H		;
E546 25             	DEC	H		;
E547 B7             	OR	A		;DEC BCH
E548 20 01          	JR	NZ,RWX2		;
E54A 0B             	DEC	BC		;
E54B                RWX2:
E54B CD 49 E3       	CALL	ENDCL
E54E 38 E5          	JR	C,RWX1
E550                SCF_RET:
E550 37             	SCF
E551 C9             	RET
E552                
E552                DSKF:
E552 11 00 00       MAXCLP:	LD	DE,0
E555 2A AC EF       	LD	HL,(_FAKEFREE)
E558 7C             	LD	A,H
E559 B5             	OR	L
E55A 28 03          	JR	Z,DSKF1
E55C 11 01 00       	LD	DE,1
E55F                DSKF1:
E55F D5             	PUSH	DE
E560 CD F7 EF       	CALL	_GNCL
E563 38 0C          	JR	C,POPSCF
E565 7A             	LD	A,D
E566 B3             	OR	E
E567 20 01          	JR	NZ,DSKF2
E569 23             	INC	HL
E56A                DSKF2:
E56A D1             	POP	DE
E56B 1B             	DEC	DE
E56C 7A             	LD	A,D
E56D B3             	OR	E
E56E 20 EF          	JR	NZ,DSKF1
E570 C9             	RET
E571                
E571                POPSCF:
E571 F1             	POP	AF
E572 37             	SCF
E573 C9             	RET
E574                
E574                SETTMS:
E574 FD 7E 17       	LD	A,(IY+23)	;(FCB)ファイルを最後に変更した時刻
E577 3C             	INC	A
E578 C0             	RET	NZ		;ファイルが更新されていない
E579                SETTMSX:			;FCBに日付時刻をセットする
E579 CD 2A DC       	CALL	_SYS2C		;(BDOS)時刻の獲得
E57C                				;H←時  L←分  D←秒
E57C CB 25          	SLA	L		;   *2
E57E CB 25          	SLA	L		;   *4
E580 29             	ADD	HL,HL		;*2 *8
E581 29             	ADD	HL,HL		;*4 *16
E582 29             	ADD	HL,HL		;*8 *32
E583 7A             	LD	A,D
E584 0F             	RRCA			;bit.0->7->->->0->C
E585 E6 1F          	AND	01FH
E587 B5             	OR	L
E588 FD 77 16       	LD	(IY+22),A	;(FCB)ファイルを最後に変更した時刻
E58B FD 74 17       	LD	(IY+23),H
E58E                
E58E CD 07 DC       	CALL	_SYS2A		;(BDOS)日付の獲得
E591                				;HL←年  D←月  E←日
E591 01 44 F8       	LD	BC,0-1980
E594 09             	ADD	HL,BC
E595 65             	LD	H,L
E596                
E596 7A             	LD	A,D
E597 87             	ADD	A,A		;*2
E598 87             	ADD	A,A		;*4
E599 87             	ADD	A,A		;*8
E59A 87             	ADD	A,A		;*16
E59B 6F             	LD	L,A
E59C 29             	ADD	HL,HL		;*32
E59D 7D             	LD	A,L
E59E B3             	OR	E
E59F FD 77 14       	LD	(IY+20),A	;(FCB)ファイルを最後に変更した日付
E5A2 FD 74 15       	LD	(IY+21),H
E5A5 C9             	RET
E5A6                
E5A6                PUSHRR:
E5A6 32 45 E6       	LD	(SETSEQ_SWC_RND),A
E5A9 22 57 E6       	LD	(SETSEQ_SWC_SEQ_RR),HL
E5AC CD CC E5       	CALL	GET_RR_AHL
E5AF 22 5A EF       	LD	(HLBUF),HL
E5B2 32 5C EF       	LD	(HLBUF+2),A
E5B5 C9             	RET
E5B6                
E5B6                GET_CPM_R_SIZE:		;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
E5B6 87             	ADD	A,A		;in BHLA => out AHL
E5B7 ED 6A          	ADC	HL,HL
E5B9 CB 18          	RR	B
E5BB B7             	OR	A
E5BC 78             	LD	A,B		;ここでフラグは変化しない
E5BD C8             	RET	Z
E5BE 2C             	INC	L		;INC AHL
E5BF C0             	RET	NZ		;
E5C0 24             	INC	H		;
E5C1 C0             	RET	NZ		;
E5C2 3C             	INC	A		;
E5C3 C9             	RET
E5C4                
E5C4                INIT_RND:
E5C4 3E CD          	LD	A,0CDH		;CALL ????
E5C6 21 15 E6       	LD	HL,POPRR
E5C9 CD A6 E5       	CALL	PUSHRR
E5CC                GET_RR_AHL:
E5CC FD 6E 21       	LD	L,(IY+33)	;(FCB)Random record
E5CF FD 66 22       	LD	H,(IY+34)	;
E5D2 FD 7E 23       	LD	A,(IY+35)	;
E5D5 C9             	RET
E5D6                SET_RR_AHL:
E5D6 FD 75 21       	LD	(IY+33),L	;(FCB)Random record
E5D9 FD 74 22       	LD	(IY+34),H
E5DC FD 77 23       	LD	(IY+35),A
E5DF C9             	RET
E5E0                INIT_SEQ:
E5E0 3E 01          	LD	A,1		;LD BC,????
E5E2 21 12 E6       	LD	HL,SETSEQ
E5E5 CD A6 E5       	CALL	PUSHRR
E5E8                GETSEQ:
E5E8 FD 6E 20       	LD	L,(IY+32)	;(FCB)カレントレコード
E5EB FD 66 0C       	LD	H,(IY+12)	;(FCB)カレントブロック
E5EE AF             	XOR	A
E5EF                
E5EF CB 25          	SLA	L	;L=L*2
E5F1                
E5F1 CB 3C          	SRL	H	;HL=HL/2
E5F3 CB 1D          	RR	L	;
E5F5 C9             	RET
E5F6                
E5F6                SETSEQ1:
E5F6 F5             	PUSH	AF		
E5F7 E5             	PUSH	HL		;AHL=Random record
E5F8 FD 7E 21       	LD	A,(IY+33)	;(FCB)ランダムレコード
E5FB FD 6E 22       	LD	L,(IY+34)
E5FE FD 66 23       	LD	H,(IY+35)
E601 06 00          	LD	B,0
E603                
E603 CD B6 E5       	CALL	GET_CPM_R_SIZE
E606                
E606 29             	ADD	HL,HL
E607 CB 3D          	SRL	L		;L=L/2
E609 FD 75 20       	LD	(IY+32),L	;(FCB)カレントレコード
E60C FD 74 0C       	LD	(IY+12),H	;(FCB)カレントブロック
E60F E1             	POP	HL
E610 F1             	POP	AF
E611 C9             	RET
E612                SETSEQ:
E612 CD F6 E5       	CALL	SETSEQ1
E615                POPRR:
E615 F5             	PUSH	AF
E616 E5             	PUSH	HL
E617 2A 5A EF       	LD	HL,(HLBUF)
E61A 3A 5C EF       	LD	A,(HLBUF+2)
E61D CD D6 E5       	CALL	SET_RR_AHL
E620 E1             	POP	HL
E621 F1             	POP	AF
E622 C9             	RET
E623                
E623                RB_WRITE:
E623 C5             	PUSH	BC
E624 ED 4B 4C F0    	LD	BC,(STABLE+2*026H)	;(BDOS)ランダムブロック書き込み
E628 18 05          	JR	RBRW
E62A                RB_READ:
E62A C5             	PUSH	BC
E62B ED 4B 4E F0    	LD	BC,(STABLE+2*027H)	;(BDOS)ランダムブロック読み込み
E62F                RBRW:
E62F CB 3F          	SRL	A	;AHLA' = HL*128
E631 CB 1C          	RR	H	;AHL=AHL/2
E633 CB 1D          	RR	L	;
E635 3E 00          	LD	A,0
E637 1F             	RRA		;A'HLA
E638 FD 77 21       	LD	(IY+33),A	;(FCB)ランダムレコード
E63B FD 75 22       	LD	(IY+34),L
E63E FD 74 23       	LD	(IY+35),H
E641 21 80 00       	LD	HL,128
E644 C5             	PUSH	BC
E645                SETSEQ_SWC_RND:
E645 CD F6 E5       	CALL	SETSEQ1
E648 C1             	POP	BC
E649 FD CB 20 FE    	SET	7,(IY+32)	;(FCB)カレントレコード
E64D FD E5          	PUSH	IY
E64F D1             	POP	DE
E650 D5             	PUSH	DE
E651 CD 5F E6       	CALL	JP_BC
E654 FD E1          	POP	IY
E656 00 00 E6 57    SETSEQ_SWC_SEQ_RR	EQU $+1
E656 CD 12 E6       	CALL	SETSEQ
E659 FD CB 20 BE    	RES	7,(IY+32)	;(FCB)カレントレコード
E65D                
E65D C1             	POP	BC
E65E C9             	RET
E65F                JP_BC:
E65F C5             	PUSH	BC
E660 C9             	RET
E661                
E661 00 00 E1 D9    _SYS03	EQU	SCF_FF_RET	;(BDOS)外部入力
E661 00 00 E1 D9    _SYS2B	EQU	SCF_FF_RET	;(BDOS)日付の設定
E661 00 00 E1 D9    _SYS2D	EQU	SCF_FF_RET	;(BDOS)時刻の設定
E661 00 00 E1 D9    _SYS39	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの作成
E661 00 00 E1 D9    _SYS3A	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの削除
E661                
E661                	INCLUDE	"LDFILE2.ASM"
E661                
E661                ;	LSX-Dodgers FILE2
E661                
E661                				;Write random block
E661                _SYS26:		;(BDOS)ランダムブロック書き込み
E661 AF             	XOR	A
E662 32 4D E9       	LD	(DRDN1),A	;NOP
E665 22 91 E8       	LD	(LEFT+1),HL	;HL←書き込むレコード数
E668 22 5D EF       	LD	(LEFTX),HL
E66B CD 2E E1       	CALL	SETDRV
E66E                
E66E CD E8 E7       	CALL	RBX0
E671 DA 0B E7       	JP	C,RBWERR
E674 CD B6 E4       	CALL	WOPEN
E677 DA 0B E7       	JP	C,RBWERR
E67A 7C             	LD	A,H
E67B B5             	OR	L
E67C CA 04 E7       	JP	Z,RBW1
E67F                
E67F 2B             	DEC	HL
E680                
E680 CD B3 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E683                
E683 19             	ADD	HL,DE		;BCHL=HL+BCDE
E684 30 01          	JR	NC,S26X1	;
E686 03             	INC	BC		;
E687                S26X1:
E687 CD 1D E5       	CALL	RWXR
E68A DC C7 E4       	CALL	C,WRDFX
E68D DA 0B E7       	JP	C,RBWERR
E690                
E690 CD 17 E8       	CALL	RBX2
E693 28 1A          	JR	Z,RBWB		;NZ=セクタ以下の端数がある
E695 CD 36 E8       	CALL	RBXA
E698 38 71          	JR	C,RBWERR
E69A EB             	EX	DE,HL
E69B C5             	PUSH	BC
E69C ED B0          	LDIR
E69E 22 5F EF       	LD	(DTAX),HL
E6A1                
E6A1 CD 5B E4       	CALL	SWTDBF		;バッファデータは更新された
E6A4                
E6A4 2A 5D EF       	LD	HL,(LEFTX)
E6A7 D1             	POP	DE
E6A8 ED 52          	SBC	HL,DE
E6AA 22 5D EF       	LD	(LEFTX),HL
E6AD 28 33          	JR	Z,RBWEND
E6AF                
E6AF                RBWB:
E6AF CD 6C E8       	CALL	RBXB
E6B2 28 16          	JR	Z,RBWC
E6B4                RBWB1:
E6B4 C5             	PUSH	BC
E6B5 D5             	PUSH	DE
E6B6 CD 2C E3       	CALL	CLUSTX
E6B9 CD C7 E8       	CALL	DWTC
E6BC D1             	POP	DE
E6BD C1             	POP	BC
E6BE 38 4B          	JR	C,RBWERR
E6C0 CD C5 EA       	CALL	GNCLX
E6C3 38 46          	JR	C,RBWERR
E6C5 10 ED          	DJNZ	RBWB1
E6C7 CD 17 E9       	CALL	DRW_FLUSH
E6CA                RBWC:
E6CA CD 84 E8       	CALL	RBXC
E6CD 28 13          	JR	Z,RBWEND
E6CF C5             	PUSH	BC
E6D0 CD 2C E3       	CALL	CLUSTX
E6D3 CD 4C E9       	CALL	DRDN
E6D6 C1             	POP	BC
E6D7 38 32          	JR	C,RBWERR
E6D9 ED 5B 7E F0    	LD	DE,(_DTBUF)
E6DD ED B0          	LDIR
E6DF CD 5B E4       	CALL	SWTDBF		;バッファデータは更新された
E6E2                RBWEND:
E6E2 CD 90 E8       	CALL	RBXEND
E6E5                
E6E5 CD F7 E7       	CALL	RBX1
E6E8 30 1A          	JR	NC,RBW1
E6EA 2A 91 E8       	LD	HL,(LEFT+1)
E6ED FD 5E 10       	LD	E,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
E6F0 FD 56 11       	LD	D,(IY+17)	;DE=File size
E6F3 19             	ADD	HL,DE
E6F4 FD 75 10       	LD	(IY+16),L	;(FCB)ファイルのサイズ(バイト単位)
E6F7 FD 74 11       	LD	(IY+17),H
E6FA 30 08          	JR	NC,RBW1
E6FC FD 34 12       	INC	(IY+18)
E6FF 20 03          	JR	NZ,RBW1
E701 FD 34 13       	INC	(IY+19)
E704                RBW1:
E704 FD E1          	POP	IY
E706 C1             	POP	BC
E707 D1             	POP	DE
E708 E1             	POP	HL
E709                DD_NUL:
E709 AF             	XOR	A
E70A                DRDF0:
E70A                DWTF0:
E70A C9             	RET
E70B                
E70B                RBWERR:
E70B FD E5          	PUSH	IY
E70D D1             	POP	DE
E70E 2A 20 F0       	LD	HL,(STABLE+2*010H)
E711 CD 0F 00       	CALL	JP_HL
E714                RBRERR1:
E714 3E 01          	LD	A,001H
E716                RBRERR2:
E716 FD E1          	POP	IY
E718 C1             	POP	BC
E719 D1             	POP	DE
E71A E1             	POP	HL
E71B 37             	SCF
E71C 21 00 00       	LD	HL,0
E71F C9             	RET
E720                
E720                RBRERR:
E720 3E FF          	LD	A,0FFH
E722 18 F2          	JR	RBRERR2
E724                
E724                RBRFL:
E724 3E 00          RBRFLP:	LD	A,000H
E726 FE 0D          	CP	00DH
E728 20 05          	JR	NZ,RBRFL1
E72A D5             	PUSH	DE
E72B 1E 0A          	LD	E,00AH
E72D 18 05          	JR	RBRFL2
E72F                RBRFL1:
E72F D5             	PUSH	DE
E730 CD 09 EF       	CALL	_SYS07
E733 5F             	LD	E,A
E734                RBRFL2:
E734 CD CD EF       	CALL	_PRINT
E737 7B             	LD	A,E
E738 D1             	POP	DE
E739 32 25 E7       	LD	(RBRFLP+1),A
E73C C9             	RET
E73D                DDX:
E73D FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
E740 CD 51 E3       	CALL	CAP
E743 FE 41          	CP	'A'
E745 C9             	RET
E746                
E746                				;Read random block
E746                _SYS27:		;(BDOS)ランダムブロック読み込み
E746 22 5D EF       	LD	(LEFTX),HL
E749 CD 2E E1       	CALL	SETDRV
E74C                
E74C FD CB 0D 66    	BIT	4,(IY+13)	;(FCB)属性(アトリビュート)
E750 C2 D6 E7       	JP	NZ,RBRDIR	;ディレクトリ
E753 CD E8 E7       	CALL	RBX0
E756 DA 20 E7       	JP	C,RBRERR
E759 CD F7 E7       	CALL	RBX1
E75C DA 14 E7       	JP	C,RBRERR1
E75F EB             	EX	DE,HL
E760 ED 52          	SBC	HL,DE		;CP 00HL,BCDE
E762 19             	ADD	HL,DE
E763 79             	LD	A,C
E764 DE 00          	SBC	A,0
E766 78             	LD	A,B
E767 DE 00          	SBC	A,0
E769 38 01          	JR	C,RBR1
E76B EB             	EX	DE,HL
E76C                RBR1:
E76C 9F             	SBC	A,A
E76D E6 01          	AND	1
E76F 32 D4 E7       	LD	(RBRAP+1),A
E772                
E772 7C             	LD	A,H
E773 B5             	OR	L
E774 28 57          	JR	Z,RBREND0
E776                
E776 22 91 E8       	LD	(LEFT+1),HL	;Read record byte
E779 22 5D EF       	LD	(LEFTX),HL
E77C                
E77C CD 17 E8       	CALL	RBX2
E77F 28 19          	JR	Z,RBRB
E781 CD 36 E8       	CALL	RBXA
E784 DA 20 E7       	JP	C,RBRERR
E787 C5             	PUSH	BC
E788 ED B0          	LDIR
E78A ED 53 5F EF    	LD	(DTAX),DE
E78E 2A 5D EF       	LD	HL,(LEFTX)
E791 D1             	POP	DE
E792 A7             	AND	A
E793 ED 52          	SBC	HL,DE
E795 22 5D EF       	LD	(LEFTX),HL
E798 28 30          	JR	Z,RBREND
E79A                
E79A                RBRB:
E79A CD 6C E8       	CALL	RBXB
E79D 28 15          	JR	Z,RBRC
E79F                RBRB1:
E79F C5             	PUSH	BC
E7A0 D5             	PUSH	DE
E7A1 CD 2C E3       	CALL	CLUSTX
E7A4 CD CD E8       	CALL	DRDC
E7A7 D1             	POP	DE
E7A8 C1             	POP	BC
E7A9 D4 C5 EA       	CALL	NC,GNCLX
E7AC DA 20 E7       	JP	C,RBRERR
E7AF 10 EE          	DJNZ	RBRB1
E7B1 CD 17 E9       	CALL	DRW_FLUSH
E7B4                RBRC:
E7B4 CD 84 E8       	CALL	RBXC
E7B7 28 11          	JR	Z,RBREND
E7B9 C5             	PUSH	BC
E7BA CD 2C E3       	CALL	CLUSTX
E7BD CD 30 E9       	CALL	DRDX
E7C0 C1             	POP	BC
E7C1 DA 20 E7       	JP	C,RBRERR
E7C4 EB             	EX	DE,HL
E7C5 2A 7E F0       	LD	HL,(_DTBUF)
E7C8 ED B0          	LDIR
E7CA                RBREND:
E7CA CD 90 E8       	CALL	RBXEND
E7CD                RBREND0:
E7CD FD E1          	POP	IY
E7CF C1             	POP	BC
E7D0 D1             	POP	DE
E7D1 F1             	POP	AF	;(HL)
E7D2 AF             	XOR	A
E7D3 3E 00          RBRAP:	LD	A,000H
E7D5 C9             	RET
E7D6                
E7D6                RBRDIR:
E7D6 FD 6E 1A       	LD	L,(IY+26)	;(FCB)ファイルの先頭クラスタ
E7D9 FD 66 1B       	LD	H,(IY+27)
E7DC CD 6C E3       	CALL	CHDIR
E7DF AF             	XOR	A
E7E0 67             	LD	H,A
E7E1 6F             	LD	L,A
E7E2 3C             	INC	A
E7E3 32 D4 E7       	LD	(RBRAP+1),A
E7E6 18 E5          	JR	RBREND0
E7E8                
E7E8                RBX0:
E7E8 2A 8A EF       	LD	HL,(_DTA)
E7EB 22 5F EF       	LD	(DTAX),HL
E7EE 2A 5D EF       	LD	HL,(LEFTX)
E7F1 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
E7F4 D6 FD          	SUB	0FDH
E7F6 C9             	RET
E7F7                
E7F7                RBX1:
E7F7 E5             	PUSH	HL		;Record byte
E7F8                				;AHL=File size
E7F8 FD 6E 10       	LD	L,(IY+16)	;ファイルのサイズ(バイト単位)
E7FB FD 66 11       	LD	H,(IY+17)	;
E7FE FD 7E 12       	LD	A,(IY+18)	;
E801                
E801 CD B3 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E804                
E804 A7             	AND	A
E805 ED 52          	SBC	HL,DE
E807 99             	SBC	A,C
E808 4F             	LD	C,A
E809 FD 7E 13       	LD	A,(IY+19)	;ファイルのサイズ
E80C 98             	SBC	A,B
E80D D1             	POP	DE
E80E                
E80E D8             	RET	C
E80F 47             	LD	B,A
E810 B1             	OR	C
E811 EB             	EX	DE,HL	;BCDE=File byte	HL=Record byte
E812 B2             	OR	D
E813 B3             	OR	E
E814 C0             	RET	NZ
E815 37             	SCF
E816 C9             	RET
E817                
E817                RBX2:				;Cluster settings
E817 FD 66 22       	LD	H,(IY+34)	;(+33)(FCB)ランダムレコード
E81A FD 4E 23       	LD	C,(IY+35)
E81D 06 00          	LD	B,0
E81F FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E823 20 03          	JR	NZ,RBX3
E825 FD 46 24       	LD	B,(IY+36)
E828                RBX3:
E828 CD 1D E5       	CALL	RWXR
E82B 3A 4E E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E82E 3D             	DEC	A
E82F FD A6 22       	AND	(IY+34)
E832 FD B6 21       	OR	(IY+33)
E835 C9             	RET
E836                
E836                RBXA:
E836 C5             	PUSH	BC
E837 D5             	PUSH	DE
E838 CD 2C E3       	CALL	CLUSTX
E83B CD 30 E9       	CALL	DRDX
E83E D1             	POP	DE
E83F C1             	POP	BC
E840 D8             	RET	C
E841 CD C5 EA       	CALL	GNCLX
E844 D8             	RET	C
E845 ED 53 FE F0    	LD	(_CLPS),DE
E849                
E849 FD 4E 21       	LD	C,(IY+33)	;(FCB)ランダムレコード
E84C 21 00 04       SECSZ:	LD	HL,0400H	;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
E84F 7C             	LD	A,H
E850 3D             	DEC	A		;1024=3 / 512=1
E851 FD A6 22       	AND	(IY+34)		;(FCB)ランダムレコード
E854 47             	LD	B,A		;BCに1セクタ以下の端数が入る
E855 ED 42          	SBC	HL,BC		;残りを計算
E857                
E857 ED 5B 5D EF    	LD	DE,(LEFTX)
E85B ED 52          	SBC	HL,DE		;CP HL,DE
E85D 19             	ADD	HL,DE		;
E85E 38 01          	JR	C,RBXA1		;DEとHLを比較して大きい方をHLに
E860 EB             	EX	DE,HL
E861                RBXA1:
E861 E5             	PUSH	HL
E862 2A 7E F0       	LD	HL,(_DTBUF)
E865 09             	ADD	HL,BC
E866 ED 5B 5F EF    	LD	DE,(DTAX)
E86A C1             	POP	BC
E86B C9             	RET
E86C                
E86C                RBXB:
E86C 2A 5F EF       	LD	HL,(DTAX)
E86F ED 5B FE F0    	LD	DE,(_CLPS)
E873 3A 5E EF       	LD	A,(LEFTX+1)
E876 47             	LD	B,A
E877 3A 4E E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E87A                RBXB1:
E87A 1F             	RRA		;->CF
E87B 38 04          	JR	C,RBXB2
E87D CB 38          	SRL	B	;B=B/2
E87F 18 F9          	JR	RBXB1
E881                RBXB2:
E881 78             	LD	A,B
E882 B7             	OR	A
E883 C9             	RET
E884                
E884                RBXC:
E884 ED 4B 5D EF    	LD	BC,(LEFTX)
E888 3A 4E E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E88B 3D             	DEC	A
E88C A0             	AND	B
E88D 47             	LD	B,A		;1セクタ以下の端数がない場合はZ
E88E B1             	OR	C
E88F C9             	RET
E890                
E890                RBXEND:
E890 11 00 00       LEFT:	LD	DE,0
E893 AF             	XOR	A
E894 FD 6E 21       	LD	L,(IY+33)	;(FCB)ランダムレコード
E897 FD 66 22       	LD	H,(IY+34)
E89A 19             	ADD	HL,DE
E89B FD 75 21       	LD	(IY+33),L	;(FCB)ランダムレコード
E89E FD 74 22       	LD	(IY+34),H
E8A1 30 0E          	JR	NC,RBXEND1
E8A3 FD 34 23       	INC	(IY+35)
E8A6 20 09          	JR	NZ,RBXEND1
E8A8 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E8AC 20 03          	JR	NZ,RBXEND1
E8AE FD 34 24       	INC	(IY+36)
E8B1                RBXEND1:
E8B1 EB             	EX	DE,HL		;HL=Read byte
E8B2 C9             	RET
E8B3                
E8B3                GET_RR_BCDE:			;BCDE=Random record
E8B3 FD 5E 21       	LD	E,(IY+33)	;(FCB)ランダムレコード
E8B6 FD 56 22       	LD	D,(IY+34)
E8B9 FD 4E 23       	LD	C,(IY+35)
E8BC FD 46 24       	LD	B,(IY+36)
E8BF FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E8C3 C8             	RET	Z
E8C4 06 00          	LD	B,0		;CP/M互換のアクセスの場合はFCBは36バイト
E8C6 C9             	RET
E8C7                
E8C7                ;	ランダムブロックアクセスの連続したセクタをまとめる
E8C7                
E8C7                DWTC:
E8C7 E5             	PUSH	HL
E8C8 21 2A EC       	LD	HL,DWT24B
E8CB 18 04          	JR	DWTC1
E8CD                DRDC:
E8CD E5             	PUSH	HL
E8CE 21 1A EC       	LD	HL,DRD24B
E8D1                DWTC1:
E8D1 22 2B E9       	LD	(DRWF_MODE),HL
E8D4 E1             	POP	HL
E8D5 3A 1B E9       	LD	A,(DRWF_B)
E8D8 B7             	OR	A
E8D9 20 0F          	JR	NZ,DRDC1
E8DB                SAVE_DRWC:
E8DB 06 01          	LD	B,1
E8DD ED 43 1A E9    	LD	(DRWF_C),BC
E8E1 ED 53 21 E9    	LD	(DRWF_E),DE
E8E5 22 24 E9       	LD	(DRWF_HL),HL
E8E8 18 20          	JR	INC_HL_DRWC
E8EA                DRDC1:
E8EA E5             	PUSH	HL
E8EB 21 21 E9       	LD	HL,DRWF_E
E8EE 86             	ADD	A,(HL)
E8EF F5             	PUSH	AF
E8F0 BB             	CP	E
E8F1 20 1D          	JR	NZ,DRDC2
E8F3 F1             	POP	AF
E8F4 23             	INC	HL
E8F5 7E             	LD	A,(HL)
E8F6 CE 00          	ADC	A,0
E8F8 F5             	PUSH	AF
E8F9 BA             	CP	D
E8FA 20 14          	JR	NZ,DRDC2
E8FC F1             	POP	AF
E8FD 3A 1A E9       	LD	A,(DRWF_C)
E900 CE 00          	ADC	A,0
E902 B9             	CP	C
E903 20 0C          	JR	NZ,DRDC3
E905 21 1B E9       	LD	HL,DRWF_B
E908 34             	INC	(HL)
E909 E1             	POP	HL
E90A                INC_HL_DRWC:
E90A 3A 4E E8       	LD	A,(SECSZ+2)		;1セクタのサイズの上位1バイト
E90D 84             	ADD	A,H
E90E 67             	LD	H,A
E90F C9             	RET
E910                DRDC2:
E910 F1             	POP	AF
E911                DRDC3:
E911 CD 17 E9       	CALL	DRW_FLUSH
E914 E1             	POP	HL
E915 18 C4          	JR	SAVE_DRWC
E917                
E917                ;	ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
E917                DRW_FLUSH:
E917 C5             	PUSH	BC
E918 D5             	PUSH	DE
E919 00 00 E9 1A    DRWF_C	EQU	$+1
E919 00 00 E9 1B    DRWF_B	EQU	$+2
E919 01 00 00       	LD	BC,0
E91C 78             	LD	A,B
E91D B7             	OR	A
E91E 28 0D          	JR	Z,DRDF1
E920 00 00 E9 21    DRWF_E	EQU	$+1
E920 00 00 E9 22    DRWF_D	EQU	$+2
E920 11 00 00       	LD	DE,0
E923 00 00 E9 24    DRWF_HL	EQU	$+1
E923 21 00 00       	LD	HL,0
E926 AF             	XOR	A
E927 32 1B E9       	LD	(DRWF_B),A
E92A 00 00 E9 2B    DRWF_MODE	EQU	$+1
E92A CD 1A EC       	CALL	DRD24B
E92D                DRDF1:
E92D D1             	POP	DE
E92E C1             	POP	BC
E92F C9             	RET
E930                	INCLUDE	"LDDIO.ASM"
E930                
E930                ;	LSX-Dodgers DIO
E930                
E930                DRDX:
E930 CD 6E E9       	CALL	DRDY
E933 C8             	RET	Z
E934 CD 54 E9       	CALL	DRDX1		;データバッファの情報を保存
E937 D8             	RET	C
E938 E5             	PUSH	HL
E939 C5             	PUSH	BC
E93A D5             	PUSH	DE
E93B 2A 7E F0       	LD	HL,(_DTBUF)
E93E 3A 97 E9       	LD	A,(_DBS24+1)
E941 4F             	LD	C,A
E942 CD 18 EC       	CALL	DRD24
E945 DC 69 E9       	CALL	C,DRDNE
E948                POP_DE_BC_HL_RET:
E948 D1             	POP	DE
E949 C1             	POP	BC
E94A E1             	POP	HL
E94B C9             	RET
E94C                
E94C                ;	CDE:セクタ番号
E94C                DRDN:
E94C AF             	XOR	A
E94D 00             DRDN1:	NOP			;自己書き換え NOP / SCF
E94E 30 E0          	JR	NC,DRDX
E950                DRDNX:
E950 CD 6E E9       	CALL	DRDY
E953 C8             	RET	Z
E954                DRDX1:
E954 CD 84 E9       	CALL	DWTX
E957                				;データバッファの読み込んだドライブ・セクタ情報を保存
E957 ED 53 A6 EF    	LD	(_DBSEC),DE
E95B 79             	LD	A,C
E95C 32 97 E9       	LD	(_DBS24+1),A
E95F                
E95F 3A 88 EF       	LD	A,(_DRV)
E962 32 A5 EF       	LD	(_DBDRV),A
E965 CD D9 EF       	CALL	_CHGDRV
E968 D0             	RET	NC
E969                DRDNE:
E969 9F             	SBC	A,A		;CF=1ならばA=0FFH
E96A 32 A5 EF       	LD	(_DBDRV),A
E96D C9             	RET
E96E                
E96E                ;	CDE:セクタ番号
E96E                DRDY:
E96E 3A 97 E9       	LD	A,(_DBS24+1)
E971 B9             	CP	C
E972 C0             	RET	NZ
E973                
E973 E5             	PUSH	HL
E974 3A 88 EF       	LD	A,(_DRV)
E977 21 A5 EF       	LD	HL,_DBDRV
E97A AE             	XOR	(HL)
E97B 20 05          	JR	NZ,POP_HL_RET
E97D                
E97D 2A A6 EF       	LD	HL,(_DBSEC)
E980 ED 52          	SBC	HL,DE		;CF=0
E982                POP_HL_RET:
E982 E1             	POP	HL
E983 C9             	RET
E984                
E984                DWTX:
E984 3A A4 EF       	LD	A,(_WTDBF)
E987 B7             	OR	A
E988 C8             	RET	Z
E989 AF             	XOR	A
E98A 32 A4 EF       	LD	(_WTDBF),A
E98D                
E98D E5             	PUSH	HL
E98E C5             	PUSH	BC
E98F D5             	PUSH	DE
E990 3A A5 EF       	LD	A,(_DBDRV)
E993 CD D9 EF       	CALL	_CHGDRV
E996 0E 00          _DBS24:	LD	C,0
E998 ED 5B A6 EF    	LD	DE,(_DBSEC)
E99C 2A 7E F0       	LD	HL,(_DTBUF)
E99F D4 28 EC       	CALL	NC,DWT24
E9A2                POP_DE_BC_HL_RET2:
E9A2 18 A4          	JR	POP_DE_BC_HL_RET
E9A4                
E9A4                RDFATX:
E9A4 E5             	PUSH	HL
E9A5 3A 88 EF       	LD	A,(_DRV)
E9A8 21 AA EF       	LD	HL,_FATDRV
E9AB AE             	XOR	(HL)
E9AC 28 D4          	JR	Z,POP_HL_RET
E9AE                
E9AE C5             	PUSH	BC
E9AF D5             	PUSH	DE
E9B0 DD E5          	PUSH	IX
E9B2 CD CE E9       	CALL	WTFATX
E9B5 38 13          	JR	C,POP_IX_DE_BC_HL_RET
E9B7                
E9B7 AF             	XOR	A
E9B8 32 AB EF       	LD	(_FATIX),A
E9BB 3A 88 EF       	LD	A,(_DRV)
E9BE 32 AA EF       	LD	(_FATDRV),A
E9C1 CD E5 EF       	CALL	_RDFAT
E9C4                RDFATE2:
E9C4 30 04          	JR	NC,POP_IX_DE_BC_HL_RET
E9C6 9F             	SBC	A,A		;A=0xFF
E9C7 32 AA EF       	LD	(_FATDRV),A
E9CA                POP_IX_DE_BC_HL_RET:
E9CA DD E1          	POP	IX
E9CC 18 D4          	JR	POP_DE_BC_HL_RET2
E9CE                
E9CE                WTFATX:
E9CE 3A A2 EF       	LD	A,(_WTFATF)
E9D1 B7             	OR	A
E9D2 C8             	RET	Z
E9D3 E5             	PUSH	HL
E9D4 3A AA EF       	LD	A,(_FATDRV)
E9D7 21 A5 EF       	LD	HL,_DBDRV
E9DA AE             	XOR	(HL)
E9DB CC 84 E9       	CALL	Z,DWTX
E9DE 38 A2          	JR	C,POP_HL_RET
E9E0 C5             	PUSH	BC
E9E1 D5             	PUSH	DE
E9E2 DD E5          	PUSH	IX
E9E4 CD 35 EC       	CALL	WTFAT
E9E7 AF             	XOR	A
E9E8 32 A2 EF       	LD	(_WTFATF),A
E9EB 18 DD          	JR	POP_IX_DE_BC_HL_RET
E9ED                
E9ED                NCL1:
E9ED 7A             	LD	A,D
E9EE B3             	OR	E
E9EF 37             	SCF
E9F0 C8             	RET	Z
E9F1                
E9F1 7A             	LD	A,D
E9F2 CB 3F          	SRL	A	;/2
E9F4 CB 3F          	SRL	A	;/2
E9F6                
E9F6 E5             	PUSH	HL
E9F7 32 16 EA       	LD	(NCLPAT+2),A	;_FATIX
E9FA 2A AA EF       	LD	HL,(_FATDRV)	;L=_FATDRV H=_FATIX
E9FD BC             	CP	H
E9FE 3A 88 EF       	LD	A,(_DRV)	;この間でフラグは変化しない
EA01 32 15 EA       	LD	(NCLPAT+1),A	;_FATDRV
EA04 20 05          	JR	NZ,NCL2		;FATIXが違う
EA06 BD             	CP	L
EA07 20 02          	JR	NZ,NCL2		;ドライブが違う
EA09 E1             	POP	HL
EA0A C9             	RET
EA0B                NCL2:
EA0B C5             	PUSH	BC
EA0C D5             	PUSH	DE
EA0D DD E5          	PUSH	IX
EA0F CD CE E9       	CALL	WTFATX
EA12 38 B6          	JR	C,POP_IX_DE_BC_HL_RET
EA14 01 00 00       NCLPAT:	LD	BC,0		;自己書き換え C=_FATDRV B=_FATIX
EA17 ED 43 AA EF    	LD	(_FATDRV),BC
EA1B CD 0A EC       	CALL	RDFATS
EA1E 18 A4          	JR	RDFATE2
EA20                
EA20                NCL3:
EA20 CB 9A          	RES	3,D
EA22 CB 92          	RES	2,D
EA24 6B             	LD	L,E
EA25 62             	LD	H,D
EA26 CB 3C          	SRL	H	;
EA28 CB 1D          	RR	L	;HLA=HLA/2
EA2A 1F             	RRA		;
EA2B F5             	PUSH	AF
EA2C 3A AB EF       	LD	A,(_FATIX)
EA2F 0F             	RRCA
EA30 30 0B          	JR	NC,NCL3X1
EA32 3A 4E E8       	LD	A,(SECSZ+2)
EA35 FE 04          	CP	4		;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
EA37 20 04          	JR	NZ,NCL3X1
EA39 01 00 02       	LD	BC,512
EA3C 09             	ADD	HL,BC
EA3D                NCL3X1:
EA3D F1             	POP	AF
EA3E ED 4B 7C F0    	LD	BC,(_FATBF)
EA42 19             	ADD	HL,DE
EA43 09             	ADD	HL,BC
EA44 17             	RLA
EA45 C9             	RET
EA46                
EA46                GNCL:
EA46 CD ED E9       	CALL	NCL1		;GET NEXT CLUSTER
EA49 D8             	RET	C
EA4A C5             	PUSH	BC
EA4B E5             	PUSH	HL
EA4C CD 20 EA       	CALL	NCL3
EA4F 38 09          	JR	C,GNC1
EA51 5E             	LD	E,(HL)
EA52 23             	INC	HL
EA53 7E             	LD	A,(HL)
EA54 E6 0F          	AND	00FH
EA56 57             	LD	D,A
EA57 E1             	POP	HL
EA58 C1             	POP	BC
EA59 C9             	RET
EA5A                GNC1:
EA5A 7E             	LD	A,(HL)
EA5B 23             	INC	HL
EA5C 56             	LD	D,(HL)
EA5D 06 04          	LD	B,4
EA5F                GNC1L:
EA5F CB 3A          	SRL	D	;DA=DA/2
EA61 1F             	RRA		;
EA62 10 FB          	DJNZ	GNC1L
EA64                
EA64 5F             	LD	E,A
EA65 E1             	POP	HL
EA66 C1             	POP	BC
EA67 A7             	AND	A
EA68 C9             	RET
EA69                
EA69                SNCL:
EA69 CD ED E9       	CALL	NCL1
EA6C D8             	RET	C
EA6D                ;				SET NEXT CLUSTER
EA6D E5             	PUSH	HL
EA6E C5             	PUSH	BC
EA6F D5             	PUSH	DE
EA70 E5             	PUSH	HL
EA71 CD 20 EA       	CALL	NCL3
EA74 D1             	POP	DE
EA75                ;CF=ODD
EA75 7E             	LD	A,(HL)
EA76 73             	LD	(HL),E
EA77 38 06          	JR	C,SNC1
EA79                ;EVEN
EA79                ;M[0] = E
EA79                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
EA79 23             	INC	HL
EA7A ED 67          	RRD		;M={A[3:0],E[3:0]}
EA7C 7A             	LD	A,D
EA7D 18 04          	JR	SNC11
EA7F                SNC1:
EA7F                ;ODD
EA7F                ;HL[0] = (HL[0]&0x0F) | (E<<4)
EA7F                ;HL[1] = DE>>4
EA7F ED 6F          	RLD		;M={D[3:0],E[7:4]}
EA81 23             	INC	HL
EA82 72             	LD	(HL),D	;M={D[3:0],E[7:4]}
EA83                SNC11:
EA83 ED 6F          	RLD		;M={M[7:4],D[3:0]}
EA85 B7             	OR	A
EA86 D1             	POP	DE
EA87 C1             	POP	BC
EA88 E1             	POP	HL
EA89                FAT_CHANGED:
EA89 3E 01          	LD	A,1
EA8B 32 A2 EF       	LD	(_WTFATF),A
EA8E C9             	RET
EA8F                
EA8F                N16CL3:
EA8F C5             	PUSH	BC
EA90 6B             	LD	L,E
EA91 7A             	LD	A,D
EA92 E6 03          	AND	3
EA94 67             	LD	H,A
EA95 29             	ADD	HL,HL
EA96 ED 4B 7C F0    	LD	BC,(_FATBF)
EA9A 09             	ADD	HL,BC
EA9B C1             	POP	BC
EA9C C9             	RET
EA9D                
EA9D                GNCL16:
EA9D CD ED E9       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EAA0 D8             	RET	C
EAA1 E5             	PUSH	HL
EAA2 CD 8F EA       	CALL	N16CL3
EAA5 5E             	LD	E,(HL)
EAA6 23             	INC	HL
EAA7 56             	LD	D,(HL)
EAA8 E1             	POP	HL
EAA9 C9             	RET
EAAA                
EAAA                SNCL16:
EAAA CD ED E9       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EAAD D8             	RET	C
EAAE D5             	PUSH	DE
EAAF E5             	PUSH	HL
EAB0 CD 8F EA       	CALL	N16CL3
EAB3 D1             	POP	DE		;HL
EAB4 73             	LD	(HL),E
EAB5 23             	INC	HL
EAB6 72             	LD	(HL),D
EAB7 6B             	LD	L,E
EAB8 62             	LD	H,D
EAB9 D1             	POP	DE
EABA 18 CD          	JR	FAT_CHANGED
EABC                
EABC                ;------------------------
EABC                ;次のセクタを探す際に_SECPSの値をチェック
EABC                ;in
EABC                ;	DE : セクタ番号
EABC                ;out
EABC                ;	DE : 次のセクタ番号
EABC                ;note
EABC                ;
EABC                ;------------------------
EABC                NEXTX:
EABC 3E 00          _SECPS:	LD	A,0	;自己書き換え
EABE 3C             	INC	A
EABF E6 00          NCPAT:	AND	0	;自己書き換え　1クラスタの論理セクタ数-1
EAC1 32 BD EA       	LD	(_SECPS+1),A
EAC4 C9             	RET
EAC5                
EAC5                GNCLX:
EAC5 CD BC EA       	CALL	NEXTX
EAC8 C0             	RET	NZ	;1クラスタのセクタ未満の場合は戻る
EAC9 C3 F7 EF       	JP	_GNCL	;次のクラスタを探す
EACC                
EACC                RDFAT:
EACC 3E 80          	LD	A,080H
EACE 32 70 EF       	LD	(CHECK),A
EAD1                RDFAT1:
EAD1 3A 88 EF       	LD	A,(_DRV)
EAD4 CD 60 ED       	CALL	CHGDRVR
EAD7 D8             	RET	C
EAD8 DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EADB CB 6F          	BIT	5,A
EADD 28 43          	JR	Z,RDFAT0X
EADF 21 70 EF       	LD	HL,CHECK
EAE2 A6             	AND	(HL)
EAE3 77             	LD	(HL),A
EAE4 11 00 00       	LD	DE,0		;BPB
EAE7 2A 7C F0       	LD	HL,(_FATBF)
EAEA CD 16 EC       	CALL	DRD16
EAED 30 24          	JR	NC,GETBPB
EAEF 21 70 EF       	LD	HL,CHECK
EAF2 CB 06          	RLC	(HL)
EAF4 3F             	CCF
EAF5 D8             	RET	C
EAF6 DD CB 0A 1E    	RR	(IX+00AH)	;DPB_0A_FDMODE
EAFA 3F             	CCF			;フロッピーディスクのMFMモードを切り替える
EAFB DD CB 0A 16    	RL	(IX+00AH)	;DPB_0A_FDMODE
EAFF 3E FF          	LD	A,0FFH
EB01 32 89 EF       	LD	(_DSK),A
EB04 3A 84 EF       	LD	A,(_DRIVE)
EB07 E6 03          	AND	3
EB09 F6 80          	OR	080H
EB0B 6F             	LD	L,A
EB0C 26 EF          	LD	H,_CYL0/256
EB0E 3E FF          	LD	A,0FFH
EB10 77             	LD	(HL),A
EB11 18 BE          	JR	RDFAT1
EB13                GETBPB:
EB13 FD E5          	PUSH	IY
EB15 FD 2A 7C F0    	LD	IY,(_FATBF)	;BPB
EB19 CD F1 EF       	CALL	_BPB2DPB
EB1C FD E1          	POP	IY
EB1E D8             	RET	C
EB1F CD BE EC       	CALL	CHGDRV2
EB22                RDFAT0X:
EB22 CD 0A EC       	CALL	RDFATS
EB25 D8             	RET	C
EB26 DD BE 06       	CP	(IX+6)		;DPB_06_FATID
EB29 C8             	RET	Z
EB2A DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
EB2E C0             	RET	NZ		;BPBを取得している場合はFATIDをチェックしない
EB2F 37             	SCF
EB30 C9             	RET
EB31                
EB31                BPB2DPB:
EB31 FD 7E 0B       	LD	A,(IY+11)	;BPB_BytsPerSec
EB34 B7             	OR	A
EB35 37             	SCF
EB36 C0             	RET	NZ
EB37                BPBOK:
EB37 FD 7E 0D       	LD	A,(IY+13)	;BPB_SecPerClus
EB3A DD 77 07       	LD	(IX+7),A	;DPB_07_SECPCL
EB3D                
EB3D FD 7E 16       	LD	A,(IY+22)	;BPB_FATSz16
EB40 DD 77 00       	LD	(IX+0),A	;DPB_00_FATLN
EB43 FD 7E 17       	LD	A,(IY+23)	;BPB_FATSz16
EB46 DD 77 01       	LD	(IX+1),A	;DPB_00_FATLN
EB49                
EB49 FD 6E 0E       	LD	L,(IY+14)	;BPB_RsvdSecCnt
EB4C FD 66 0F       	LD	H,(IY+15)
EB4F DD 75 0E       	LD	(IX+00EH),L	;DPB_0E_FATPS
EB52 FD 5E 16       	LD	E,(IY+22)	;BPB_FATSz16
EB55 FD 56 17       	LD	D,(IY+23)
EB58 FD 46 10       	LD	B,(IY+16)	;BPB_NumFATs
EB5B                BPBDP1:				;BPB_FATSz16 * BPB_NumFATs
EB5B 19             	ADD	HL,DE
EB5C 10 FD          	DJNZ	BPBDP1
EB5E                BPBDP2:
EB5E DD 75 10       	LD	(IX+010H),L	;DPB_10_DIRPS
EB61 DD 74 11       	LD	(IX+011H),H
EB64 E5             	PUSH	HL
EB65                
EB65 FD 6E 11       	LD	L,(IY+17)	;BPB_RootEntCnt
EB68 FD 66 12       	LD	H,(IY+18)
EB6B FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EB6E B7             	OR	A
EB6F 37             	SCF
EB70 C8             	RET	Z
EB71 06 06          	LD	B,6
EB73                BPBBPS1:
EB73 05             	DEC	B
EB74 0F             	RRCA
EB75 30 FC          	JR	NC,BPBBPS1
EB77                BPBDE1:
EB77 29             	ADD	HL,HL
EB78 10 FD          	DJNZ	BPBDE1
EB7A                
EB7A 7C             	LD	A,H
EB7B DD 77 0B       	LD	(IX+00BH),A	;DPB_0B_DIRSCNT
EB7E                
EB7E D1             	POP	DE		;DPB_10_DIRPS
EB7F 6C             	LD	L,H
EB80 26 00          	LD	H,0
EB82 19             	ADD	HL,DE		;MAXDIR
EB83 E5             	PUSH	HL
EB84 FD 4E 0D       	LD	C,(IY+13)	;BPB_SecPerClus
EB87 CB 21          	SLA	C		;*2
EB89 AF             	XOR	A
EB8A 47             	LD	B,A
EB8B ED 42          	SBC	HL,BC
EB8D DD 75 14       	LD	(IX+014H),L	;DPB_14_ADDCL16
EB90 DD 74 15       	LD	(IX+015H),H
EB93                
EB93 D1             	POP	DE		;DE=DPB_0B_MAXDIR
EB94 FD 6E 13       	LD	L,(IY+19)	;BPB_TotSec16
EB97 FD 66 14       	LD	H,(IY+20)
EB9A                
EB9A DD CB 0A 7E    	BIT	7,(IX+00AH)	;DPB_0A_FDMODE
EB9E 28 17          	JR	Z,NOT_FD
EBA0 E5             	PUSH	HL
EBA1 FD 4E 18       	LD	C,(IY+24)	;BPB_SecPerTr
EBA4 DD 71 0D       	LD	(IX+00DH),C	;DPB_0D_MAXSEC
EBA7 AF             	XOR	A
EBA8 47             	LD	B,A
EBA9 CB 21          	SLA	C		;両面なのでセクタ数を２倍
EBAB 2B             	DEC	HL
EBAC                CNTSEC:				;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
EBAC 3C             	INC	A
EBAD 28 04          	JR	Z,CNTSECE
EBAF ED 42          	SBC	HL,BC
EBB1 30 F9          	JR	NC,CNTSEC
EBB3                CNTSECE:
EBB3 DD 77 0C       	LD	(IX+00CH),A	;DPB_0C_MAXCYL
EBB6 E1             	POP	HL	;ここまでフロッピー専用
EBB7                NOT_FD:
EBB7 7C             	LD	A,H
EBB8 B5             	OR	L
EBB9 3E 00          	LD	A,0		;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
EBBB 20 10          	JR	NZ,BPB16BIT	;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
EBBD FD 7E 23       	LD	A,(IY+35)	;念のために総セクタ数が24ビットを超える場合はエラーを返す
EBC0 B7             	OR	A
EBC1 37             	SCF
EBC2 C0             	RET	NZ
EBC3 FD 6E 20       	LD	L,(IY+32)	;BPB_TotSec32 は AHL の24ビットで扱う
EBC6 FD 66 21       	LD	H,(IY+33)	;1クラスタの論理セクタ数(DPB_07_SECPCL)が最大128なので
EBC9 FD 7E 22       	LD	A,(IY+34)	;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
EBCC A7             	AND	A		;CF=0
EBCD                BPB16BIT:
EBCD ED 52          	SBC	HL,DE
EBCF DE 00          	SBC	A,0
EBD1 FD 46 0D       	LD	B,(IY+13)	;BPB_SecPerClus
EBD4                BPBTC1:				;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
EBD4 CB 18          	RR	B		;->CY
EBD6 38 08          	JR	C,BPBTC2
EBD8 CB 3F          	SRL	A
EBDA CB 1C          	RR	H		;AHL=AHL/2
EBDC CB 1D          	RR	L
EBDE 18 F4          	JR	BPBTC1
EBE0                BPBTC2:
EBE0 B7             	OR	A
EBE1 37             	SCF
EBE2 C0             	RET	NZ		;念のため(クラスタ数が16ビットを超える場合)
EBE3 23             	INC	HL
EBE4 23             	INC	HL
EBE5 DD 75 08       	LD	(IX+8),L	;DPB_08_MAXCL
EBE8 DD 74 09       	LD	(IX+9),H
EBEB                
EBEB FD 7E 15       	LD	A,(IY+21)	;BPB_Media
EBEE DD 77 06       	LD	(IX+6),A	;DPB_06_FATID
EBF1                
EBF1 FD 7E 10       	LD	A,(IY+16)	;BPB_NumFATs
EBF4 C6 FE          	ADD	A,0-2		;>2:CF=1
EBF6 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EBF9 6F             	LD	L,A
EBFA 30 02          	JR	NC,BPBFAT1
EBFC F6 80          	OR	080H
EBFE                BPBFAT1:
EBFE DD 77 0F       	LD	(IX+00FH),A	;DPB_0F_BPS
EC01 2D             	DEC	L		;以下のセクタサイズに合致しない場合はCF=1でエラーにする
EC02 C8             	RET	Z		;1セクタ256バイト
EC03 2D             	DEC	L
EC04 C8             	RET	Z		;1セクタ512バイト
EC05 2D             	DEC	L
EC06 2D             	DEC	L
EC07 C8             	RET	Z		;1セクタ1024バイト
EC08 37             	SCF
EC09 C9             	RET
EC0A                
EC0A                RDFATS:
EC0A CD 50 EC       	CALL	FATSETUP
EC0D D8             	RET	C
EC0E CD 1A EC       	CALL	DRD24B
EC11 2A 7C F0       	LD	HL,(_FATBF)
EC14 7E             	LD	A,(HL)
EC15 C9             	RET
EC16                
EC16                DRD16:
EC16 0E 00          	LD	C,0
EC18                DRD24:
EC18 06 01          	LD	B,1
EC1A                DRD24B:
EC1A DD E5          	PUSH	IX
EC1C DD 2A A8 EF    	LD	IX,(_DPB)
EC20 CD 7B EE       DRDPAT:	CALL	FDRD		;自己書き換え（ディスク読み込み）
EC23                POP_IX_RET:
EC23 DD E1          	POP	IX
EC25 C9             	RET
EC26                
EC26                DWT16:
EC26 0E 00          	LD	C,0
EC28                DWT24:
EC28 06 01          	LD	B,1
EC2A                DWT24B:
EC2A DD E5          	PUSH	IX
EC2C DD 2A A8 EF    	LD	IX,(_DPB)
EC30 CD 6D EE       DWTPAT:	CALL	FDWT		;自己書き換え（ディスク書き込み）
EC33 18 EE          	JR	POP_IX_RET
EC35                
EC35                WTFAT:
EC35 CD 50 EC       	CALL	FATSETUP
EC38 D4 2A EC       	CALL	NC,DWT24B
EC3B D8             	RET	C
EC3C DD CB 0F 7E    	BIT	7,(IX+00FH)	;DPB_0F_BPS
EC40 C8             	RET	Z		;予備FATが無い
EC41 CD 57 EC       	CALL	FATS2
EC44 E5             	PUSH	HL		;予備FAT
EC45 DD 6E 00       	LD	L,(IX+0)	;DPB_00_FATLN
EC48 DD 66 01       	LD	H,(IX+1)
EC4B 19             	ADD	HL,DE
EC4C EB             	EX	DE,HL
EC4D E1             	POP	HL
EC4E 18 DA          	JR	DWT24B
EC50                ;------------------------
EC50                ;FATのセットアップ
EC50                ;out
EC50                ;	B  : FATセクタ数
EC50                ;	DE : FAT先頭セクタ番号
EC50                ;	HL : FATバッファポインタ
EC50                ;	CF : 1=ドライブ切り替えエラー
EC50                ;note
EC50                ;	FATサイズがFATバッファを超える場合は
EC50                ;	対象クラスタ領域==(_FATIX)によって
EC50                ;	FAT12:対象クラスタ1024毎に1.5KBを切り替える
EC50                ;	FAT16:対象クラスタ1024毎に2KBを切り替える
EC50                ;------------------------
EC50                FATSETUP:
EC50 3A AA EF       	LD	A,(_FATDRV)
EC53 CD 60 ED       	CALL	CHGDRVR		;ドライブ切り替え
EC56 D8             	RET	C
EC57                FATS2:
EC57 DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS 512=2 1024=4
EC5A 0F             	RRCA
EC5B CD 84 EC       FATSX:	CALL	FATSETUP12	;自己書き換え
EC5E 21 00 00       	LD	HL,0
EC61 4A             	LD	C,D
EC62 54             	LD	D,H
EC63 3A AB EF       	LD	A,(_FATIX)	;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
EC66 47             	LD	B,A
EC67 04             	INC	B
EC68 DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
EC6B                FAT_SKP:
EC6B 05             	DEC	B
EC6C 28 05          	JR	Z,FAT1
EC6E 19             	ADD	HL,DE
EC6F 93             	SUB	E
EC70 30 F9          	JR	NC,FAT_SKP
EC72 C9             	RET
EC73                FAT1:
EC73 EB             	EX	DE,HL
EC74 B9             	CP	C		;C=FATバッファに読み込めるセクタ数
EC75 38 01          	JR	C,FAT2
EC77 79             	LD	A,C
EC78                FAT2:
EC78 47             	LD	B,A
EC79                
EC79 2A FA F0       	LD	HL,(_FATPS)	;fat sector pos
EC7C 19             	ADD	HL,DE
EC7D EB             	EX	DE,HL
EC7E 2A 7C F0       	LD	HL,(_FATBF)
EC81 AF             	XOR	A		;CF=0
EC82 4F             	LD	C,A
EC83 C9             	RET
EC84                ;
EC84                ;	FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
EC84                ;	FATSETUP* (FAT12/FAT16)
EC84                ;out
EC84                ;	D : FATバッファに読み込める最大のセクタ数
EC84                ;	E : _FATIXで進めるセクタ数
EC84                FATSETUP12:
EC84 11 06 06       	LD	DE,0606H	;256
EC87 D8             	RET	C
EC88 11 03 03       	LD	DE,0303H	;512
EC8B 0F             	RRCA
EC8C D8             	RET	C
EC8D 11 01 02       	LD	DE,0201H	;1024
EC90 C9             	RET
EC91                
EC91                FATSETUP16:
EC91 11 08 08       	LD	DE,0808H	;256
EC94 D8             	RET	C
EC95 11 04 04       	LD	DE,0404H
EC98 0F             	RRCA			;512
EC99 D8             	RET	C
EC9A 11 02 02       	LD	DE,0202H	;1024
EC9D C9             	RET
EC9E                
EC9E                CHGDRV:
EC9E E5             	PUSH	HL
EC9F 21 89 EF       	LD	HL,_DSK
ECA2 BE             	CP	(HL)
ECA3 28 0A          	JR	Z,CHGDRVE
ECA5                CHGDRV1:
ECA5 DD E5          	PUSH	IX
ECA7 CD B1 EC       	CALL	CHGDRV0
ECAA 3A 89 EF       	LD	A,(_DSK)
ECAD DD E1          	POP	IX
ECAF                CHGDRVE:
ECAF E1             	POP	HL
ECB0 C9             	RET
ECB1                
ECB1                CHGDRV0:
ECB1 6F             	LD	L,A
ECB2 CD DC EF       	CALL	_GETDPB
ECB5 D8             	RET	C
ECB6 DD 22 A8 EF    	LD	(_DPB),IX
ECBA 7D             	LD	A,L
ECBB 32 89 EF       	LD	(_DSK),A
ECBE                CHGDRV2:
ECBE C5             	PUSH	BC
ECBF D5             	PUSH	DE
ECC0 ED 73 15 ED    	LD	(SPPAT2+1),SP
ECC4 F3             	DI
ECC5 DD F9          	LD	SP,IX
ECC7                
ECC7 E1             	POP	HL		;DPB_00_FATLN
ECC8 E1             	POP	HL		;DPB_02_DRD
ECC9 22 21 EC       	LD	(DRDPAT+1),HL
ECCC                
ECCC E1             	POP	HL
ECCD 22 31 EC       	LD	(DWTPAT+1),HL	;DPB_04_DWT
ECD0                
ECD0 E1             	POP	HL		;L=DPB_06_FATID H=DPB_07_SECPCL
ECD1 7C             	LD	A,H
ECD2 32 30 E3       	LD	(SPCPAT+1),A	;1クラスタの論理セクタ数
ECD5 3D             	DEC	A
ECD6 32 C0 EA       	LD	(NCPAT+1),A
ECD9                
ECD9 E1             	POP	HL		;DPB_08_MAXCL
ECDA 7D             	LD	A,L
ECDB 32 4F E3       	LD	(CLPAT2+1),A
ECDE 7C             	LD	A,H
ECDF 32 4B E3       	LD	(CLPAT1+1),A
ECE2 2B             	DEC	HL
ECE3 22 53 E5       	LD	(MAXCLP+1),HL
ECE6                
ECE6 E1             	POP	HL		;L=DPB_0A_FDMODE H=DPB_0B_DIRSCNT
ECE7 7D             	LD	A,L
ECE8 F6 FE          	OR	0FEH
ECEA 32 16 EE       	LD	(FDMODE+1),A
ECED 07             	RLCA
ECEE E6 03          	AND	3
ECF0 32 FE ED       	LD	(FSPAT+1),A
ECF3 4C             	LD	C,H
ECF4                
ECF4 E1             	POP	HL		;L=DPB_0C_MAXCYL H=DPB_0D_MAXSEC
ECF5                
ECF5 E1             	POP	HL		;L=DPB_0E_FATPS H=DPB_0F_BPS
ECF6 7C             	LD	A,H		;DPB_0F_BPS
ECF7 E6 07          	AND	7
ECF9 32 4E E8       	LD	(SECSZ+2),A	;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
ECFC                				;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM等
ECFC                				;1セクタ1024 2HD/2HDE98
ECFC                				;1セクタ256 GRAM/RAMF/CMOS/等
ECFC                				;1024	512	256
ECFC                				;4	2	1
ECFC 87             	ADD	A,A		;8	4	2
ECFD 87             	ADD	A,A		;010H	8	4
ECFE 87             	ADD	A,A		;020H	010H	8
ECFF 32 AC E1       	LD	(SDECPAT+1),A	;1セクタ辺りのディレクトリエントリ数
ED02                
ED02 26 00          	LD	H,0
ED04 22 FA F0       	LD	(_FATPS),HL
ED07                
ED07 E1             	POP	HL		;L=DPB_10_DIRPS
ED08 22 FC F0       	LD	(_DIRPS),HL
ED0B                
ED0B E1             	POP	HL		;L=DPB_12_DEVICE H=DPB_13_UNITNO
ED0C 7C             	LD	A,H
ED0D 32 84 EF       	LD	(_DRIVE),A
ED10                
ED10 E1             	POP	HL		;DPB_14_ADDCL16
ED11 22 40 E3       	LD	(CLSPAT+1),HL
ED14                
ED14 31 00 00       SPPAT2:	LD	SP,0		;元のSPを復元
ED17 FB             	EI
ED18 2A FC F0       	LD	HL,(_DIRPS)
ED1B 06 00          	LD	B,0
ED1D 09             	ADD	HL,BC
ED1E 22 C7 E1       	LD	(MD_PAT+1),HL
ED21                
ED21 2A 53 E5       	LD	HL,(MAXCLP+1);
ED24 11 F6 0F       	LD	DE,4086
ED27 B7             	OR	A
ED28 ED 52          	SBC	HL,DE
ED2A 30 0F          	JR	NC,SETFAT16
ED2C 21 46 EA       	LD	HL,GNCL		;FAT12
ED2F 11 69 EA       	LD	DE,SNCL
ED32 01 84 EC       	LD	BC,FATSETUP12
ED35 DD CB 0F AE    	RES	5,(IX+00FH)	;DPB_0F_BPS(FAT12)
ED39 18 0D          	JR	EXTRA1
ED3B                SETFAT16:
ED3B 21 9D EA       	LD	HL,GNCL16	;FAT16
ED3E 11 AA EA       	LD	DE,SNCL16
ED41 01 91 EC       	LD	BC,FATSETUP16
ED44 DD CB 0F EE    	SET	5,(IX+00FH)	;DPB_0F_BPS(FAT16)
ED48                EXTRA1:
ED48 22 F8 EF       	LD	(GNCPAT+1),HL
ED4B ED 53 FB EF    	LD	(SNCPAT+1),DE
ED4F ED 43 5C EC    	LD	(FATSX+1),BC
ED53 D1             	POP	DE
ED54 C1             	POP	BC
ED55 AF             	XOR	A
ED56 C9             	RET
ED57                
ED57                GETDPBD:
ED57 DD E3          	EX	(SP),IX
ED59 DD E5          	PUSH	IX
ED5B 3A 88 EF       	LD	A,(_DRV)
ED5E 18 07          	JR	GETDPB1
ED60                
ED60                CHGDRVR:
ED60 CD D9 EF       	CALL	_CHGDRV
ED63 D8             	RET	C
ED64 3A 89 EF       	LD	A,(_DSK)
ED67                GETDPB1:
ED67 C3 DC EF       	JP	_GETDPB
ED6A                
ED6A                GETDPB:
ED6A FE 08          	CP	8
ED6C 3F             	CCF
ED6D D8             	RET	C
ED6E 0F             	RRCA
ED6F 0F             	RRCA
ED70 0F             	RRCA
ED71 DD             	DB	0DDH		;Z80未定義命令
ED72 6F             	LD	L,A		;LD	IXL,A
ED73 DD             	DB	0DDH		;Z80未定義命令
ED74 26 F1          	LD	H,DEVICE/256	;LD	IXH,DEVICE/256
ED76 DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
ED79 B7             	OR	A		;CF=0の為
ED7A DD CB 0F 6E    	BIT	5,(IX+00FH)	;DPB_0F_BPS
ED7E C0             	RET	NZ		;FAT16
ED7F DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
ED83 C0             	RET	NZ		;BPB
ED84 FE 01          	CP	001H		;A=0 THEN CF=1
ED86 C9             	RET
ED87                
ED87                _SYS5F:
ED87 AF             	XOR	A
ED88                FFLUSH:
ED88 F5             	PUSH	AF
ED89 3E FF          	LD	A,0FFH
ED8B 32 39 EF       	LD	(SFILE),A
ED8E CD 84 E9       	CALL	DWTX
ED91 3E FF          	LD	A,0FFH
ED93 32 A5 EF       	LD	(_DBDRV),A
ED96 CD CE E9       	CALL	WTFATX
ED99 AF             	XOR	A
ED9A 32 AB EF       	LD	(_FATIX),A
ED9D 2F             	CPL
ED9E 32 AA EF       	LD	(_FATDRV),A
EDA1 F1             	POP	AF
EDA2 C9             	RET
EDA3                
EDA3                	INCLUDE	"X1DISK.ASM"
EDA3                
EDA3                ;	LSX-Dodgers DISK
EDA3                ;	X1/turbo/Z
EDA3                
EDA3                SEEK:
EDA3 06 10          	LD	B,16
EDA5 DD 4E 0D       	LD	C,(IX+0DH)	;DPB_0D_MAXSEC
EDA8 AF             	XOR	A
EDA9 EB             	EX	DE,HL
EDAA                DIV1:
EDAA 29             	ADD	HL,HL
EDAB 8F             	ADC	A,A
EDAC B9             	CP	C
EDAD 38 02          	JR	C,DIV2
EDAF 91             	SUB	C
EDB0 2C             	INC	L
EDB1                DIV2:
EDB1 10 F7          	DJNZ	DIV1
EDB3                
EDB3 3C             	INC	A	;最小のセクタは１固定
EDB4 55             	LD	D,L	;TRACK
EDB5 5F             	LD	E,A	;SECTOR
EDB6 CB 3A          	SRL	D	;CYLINDER
EDB8 9F             	SBC	A,A
EDB9 E6 10          	AND	010H	;SIDE
EDBB 4F             	LD	C,A
EDBC                
EDBC 3A 84 EF       	LD	A,(_DRIVE)
EDBF FE 04          	CP	4
EDC1 3F             	CCF
EDC2 D8             	RET	C
EDC3 B1             	OR	C
EDC4 32 42 EE       	LD	(MOPAT+1),A	;Motor off data
EDC7 01 FC 0F       	LD	BC,00FFCH
EDCA F6 80          	OR	080H		;Motor on
EDCC ED 79          	OUT	(C),A
EDCE                
EDCE CD 14 EE       	CALL	SETMODE
EDD1 D8             	RET	C
EDD2                
EDD2 CD 57 EE       	CALL	DRIVE
EDD5 FE FF          	CP	0FFH		;A=0FFH Unknown CYLINDER
EDD7 CC 36 EE       	CALL	Z,FDCRES	;Restore
EDDA 0E F9          	LD	C,0F9H
EDDC ED 79          	OUT	(C),A		;Currrent CYLINDER
EDDE 92             	SUB	D
EDDF C8             	RET	Z		;No seek
EDE0                
EDE0 3A 86 EF       	LD	A,(_ISEEK)
EDE3 4F             	LD	C,A
EDE4                
EDE4 DD 7E 0C       	LD	A,(IX+00CH)	;DPB_0C_MAXCYL
EDE7 3D             	DEC	A
EDE8 BA             	CP	D		;Over CYLINDER
EDE9 D8             	RET	C
EDEA                
EDEA B9             	CP	C		;for Built-in 2DD
EDEB 38 03          	JR	C,SETM2
EDED 78             	LD	A,B		;B=00FH
EDEE DB FE          	IN	A,(0FEH)		;2HD mode for 2DD seek
EDF0                SETM2:
EDF0 78             	LD	A,B
EDF1 DB FD          	IN	A,(0FDH)		;MFM mode
EDF3                
EDF3 0E FB          	LD	C,0FBH
EDF5 ED 51          	OUT	(C),D
EDF7 72             	LD	(HL),D
EDF8 0E 18          	LD	C,018H		;Seek
EDFA                FDCCMD2:
EDFA 3A 85 EF       	LD	A,(_SEEKSP)
EDFD E6 FF          FSPAT:	AND	0FFH
EDFF B1             	OR	C
EE00                
EE00                FDCCMD:
EE00 CD 4D EE       	CALL	COMSET
EE03                
EE03 3E 80          FDCPAT:	LD	A,080H		;FDC COMMAND(Self-modifying code)
EE05 E6 20          	AND	020H		;Write data Write track
EE07 3C             	INC	A
EE08                
EE08                SST:
EE08 0E 00          	LD	C,0
EE0A                SST1:
EE0A 0D             	DEC	C		; 4
EE0B 20 FD          	JR	NZ,SST1		;12 * 256 / 4 = About 1ms
EE0D 3D             	DEC	A
EE0E 20 FA          	JR	NZ,SST1
EE10                
EE10 3C             	INC	A		;A=1
EE11 CD 1F EE       	CALL	READY
EE14                SETMODE:
EE14 78             	LD	A,B		;B=00FH
EE15 DB FF          FDMODE:	IN	A,(0FFH)	;Floppy mode(2D/2HD) (Self-modifying code)
EE17                
EE17 78             	LD	A,B
EE18 DB FD          	IN	A,(0FDH)	;MFM mode
EE1A                
EE1A CD 51 EE       	CALL	DELAY0		;Head select time
EE1D 3E 81          	LD	A,081H
EE1F                READY:
EE1F 32 29 EE       	LD	(WAITA+1),A
EE22 E5             	PUSH	HL
EE23 0E F8          	LD	C,0F8H
EE25 61             	LD	H,C
EE26                READY2:
EE26 ED 78          	IN	A,(C)
EE28 E6 81          WAITA:	AND	081H		;NOT READY,BUSY
EE2A 28 08          	JR	Z,READYE
EE2C E3             	EX	(SP),HL		;wait 19clock
EE2D E3             	EX	(SP),HL		; //
EE2E 2B             	DEC	HL
EE2F 7C             	LD	A,H
EE30 B5             	OR	L
EE31 20 F3          	JR	NZ,READY2
EE33 37             	SCF
EE34                READYE:
EE34 E1             	POP	HL
EE35 C9             	RET
EE36                
EE36                FDCRES:
EE36 36 00          	LD	(HL),0
EE38 0E 08          	LD	C,8
EE3A 18 BE          	JR	FDCCMD2
EE3C                
EE3C                FDMOFF:
EE3C F5             	PUSH	AF
EE3D C5             	PUSH	BC
EE3E 01 FC 0F       	LD	BC,00FFCH	;Motor off
EE41 3E 00          MOPAT:	LD	A,000H		;(Self-rewriting)
EE43 ED 79          	OUT	(C),A
EE45 C1             	POP	BC
EE46 F1             	POP	AF
EE47 C9             	RET
EE48                
EE48                SECSET:
EE48 01 FA 0F       	LD	BC,00FFAH
EE4B ED 59          	OUT	(C),E
EE4D                COMSET:
EE4D 0E F8          	LD	C,0F8H
EE4F ED 79          	OUT	(C),A
EE51                DELAY0:
EE51 3E 1A          	LD	A,26
EE53                DELAY:
EE53 3D             	DEC	A
EE54 20 FD          	JR	NZ,DELAY
EE56 C9             	RET
EE57                
EE57                DRIVE:
EE57 2A 84 EF       	LD	HL,(_DRIVE)
EE5A 26 EF          	LD	H,_CYL0/256
EE5C CB FD          	SET	7,L
EE5E 7E             	LD	A,(HL)
EE5F C9             	RET
EE60                
EE60                RNF:
EE60 CD 57 EE       	CALL	DRIVE
EE63 36 FF          	LD	(HL),0FFH
EE65 C9             	RET
EE66                
EE66 02             RETRY:	DB	2
EE67                
EE67                
EE67                ;	FLOPPY DISK DRIVER(DMA)
EE67                
EE67                
EE67                WTTRK:
EE67 06 01          	LD	B,1
EE69 3E F4          	LD	A,0F4H
EE6B 18 02          	JR	WTTRK1
EE6D                FDWT:
EE6D 3E A0          	LD	A,0A0H
EE6F                WTTRK1:
EE6F 32 04 EE       	LD	(FDCPAT+1),A
EE72 3E 10          	LD	A,16
EE74 18 0C          	JR	DISK
EE76                
EE76                DISKOK:
EE76 06 01          FDCNT:	LD	B,1
EE78 10 0B          	DJNZ	DISK1
EE7A C9             	RET
EE7B                
EE7B                FDRD:
EE7B 3E 80          	LD	A,080H
EE7D 32 04 EE       	LD	(FDCPAT+1),A
EE80 3E 0E          	LD	A,14
EE82                
EE82                DISK:
EE82 32 99 EE       	LD	(DMAPAT+1),A
EE85                DISK1:
EE85 78             	LD	A,B
EE86 32 77 EE       	LD	(FDCNT+1),A
EE89 22 F1 EE       	LD	(DMAD+11),HL
EE8C                DISKR:
EE8C 3E 02          	LD	A,2		;Retry count
EE8E 32 66 EE       	LD	(RETRY),A
EE91                DISK2:
EE91 D5             	PUSH	DE
EE92 CD A3 ED       	CALL	SEEK
EE95 38 43          	JR	C,ERRF
EE97 F3             	DI
EE98                
EE98 3E 0E          DMAPAT:	LD	A,14		;自己書き換え
EE9A 21 E6 EE       	LD	HL,DMAD
EE9D CD 4F DF       	CALL	SETDMA
EEA0 ED 49          	OUT	(C),C		;OUT 01F87H,087H WR6 イネーブル
EEA2 3A 04 EE       	LD	A,(FDCPAT+1)
EEA5 C5             	PUSH	BC
EEA6 CD 48 EE       	CALL	SECSET
EEA9 2A F1 EE       	LD	HL,(DMAHL)
EEAC 23             	INC	HL
EEAD 11 06 BB       	LD	DE,0BB06H	;READ DMA
EEB0                
EEB0 3E 03          	LD	A,3
EEB2 CD 1F EE       	CALL	READY
EEB5 ED 78          	IN	A,(C)
EEB7                
EEB7 C1             	POP	BC
EEB8 ED 51          	OUT	(C),D		;読み出しマスク設定
EEBA ED 59          	OUT	(C),E		;バイトカウンタ(LH)
EEBC ED 58          	IN	E,(C)
EEBE ED 50          	IN	D,(C)
EEC0 19             	ADD	HL,DE
EEC1 D1             	POP	DE
EEC2 13             	INC	DE
EEC3 FB             	EI
EEC4 CD 3C EE       	CALL	FDMOFF
EEC7 B7             	OR	A
EEC8 28 AC          	JR	Z,DISKOK
EECA 1B             	DEC	DE
EECB CB 67          	BIT	4,A
EECD C4 60 EE       	CALL	NZ,RNF
EED0                DISKE2:
EED0 21 66 EE       	LD	HL,RETRY
EED3 35             	DEC	(HL)
EED4 20 BB          	JR	NZ,DISK2
EED6 B7             	OR	A
EED7 28 0A          	JR	Z,ERR
EED9 D5             	PUSH	DE
EEDA                ERRF:
EEDA D1             	POP	DE
EEDB                DELP:
EEDB CD 60 EE       	CALL	RNF
EEDE CD 3C EE       	CALL	FDMOFF
EEE1 3E FF          	LD	A,0FFH
EEE3                ERR:
EEE3 BF             	CP	A
EEE4 37             	SCF
EEE5 C9             	RET
EEE6                
EEE6                			;X1turbo DISK DMA
EEE6 C3             DMAD:	DB	0C3H	;WR6 リセット
EEE7 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
EEE8 FB 0F          	DW	00FFBH	;ポートA開始アドレス FDC データレジスタ
EEEA FF FF          	DW	0FFFFH	;ブロック長(転送サイズ-1)
EEEC 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
EEED 10             	DB	010H	;WR2 ポートBインクリメント
EEEE 80             	DB	080H	;WR3
EEEF 92             	DB	092H	;WR5 WAIT RDY:LOW
EEF0 8D             	DB	08DH	;WR4 バイト ポートB開始アドレス(LH)
EEF1 00 00          DMAHL:	DW	0	;ポートB開始アドレス
EEF3 CF             	DB	0CFH	;WR6 ロード
EEF4 01             	DB	001H	;WR0 ポートB←ポートB 転送
EEF5 CF             	DB	0CFH	;WR6 ロード
EEF6                
EEF6                DMAE:
EEF6                
EEF6 00 00 1E D4    AT_R	EQU	WTTRK-AT_DWT
EEF6                
EEF6                	INCLUDE	"LDWORK.ASM"
EEF6                
EEF6                ;	LSX-Dodgers WORK0
EEF6                ;
EEF6                ;	CP/M互換BIOS
EEF6                ;	BOOT:アドレス下位1バイトが0になるように
EEF6                AT_WORK:
EEF6                	DS	WORKAD-AT_WORK
EF00                
EF00                CPM_BOOT:
EF00 C3 00 00       	JP	0
EF03                _SYS00:		;(BDOS)プログラム終了
EF03                CPM_WBOOT:
EF03 C3 09 D1       	JP	WBOOT1
EF06                CPM_CONST:
EF06 C3 F9 DB       	JP	CONSTX
EF09                _SYS07:		;(BDOS)コンソール直接入力
EF09                CPM_CONIN:
EF09 C3 A0 DB       	JP	FLGET
EF0C                CPM_CONOUT:
EF0C C3 40 DE       	JP	CONOUT1
EF0F                
EF0F                DECBF:
EF0F                	DS	5
EF14 00             FDRV	DB	0
EF15                FNAME	DS	36
EF39                SFILE:	DS	33		;DRV FILENAME
EF5A                HLBUF:	DS	3		;Random record buffer
EF5D                
EF5D 00 00          LEFTX:	DW	0
EF5F 00 00          DTAX:	DW	0
EF61                
EF61                ZERO:
EF61                BEEPD:
EF61 00 8E 01 00    	DB	0,08EH,1,0,00BH,0,00CH,010H
EF65 0B 00 0C 10
EF69 07 3E 08 10    	DB	007H,03EH,008H,010H,00DH,0,0FFH
EF6D 0D 00 FF
EF70 00 00 EF 62    RTC_YY	EQU	BEEPD+1
EF70 00 00 EF 63    RTC_MW	EQU	BEEPD+2
EF70 00 00 EF 64    RTC_DD	EQU	BEEPD+3
EF70 00 00 EF 65    RTC_TT	EQU	BEEPD+4
EF70 00 00 EF 66    RTC_MM	EQU	BEEPD+5
EF70 00 00 EF 67    RTC_SS	EQU	BEEPD+6
EF70                
EF70 00             CHECK:	DB	0
EF71                
EF71 4F 4B 24       OK:	DB	"OK$"
EF74                	DS	5
EF79 45 72 72 6F    COMERM:	DB	"Error!$"
EF7D 72 21 24
EF80                ;	システムワークエリア
EF80                ;	_CYL0:アドレス下位1バイトが080Hになるように
EF80 FF             _CYL0:	DB	0FFH	;Cylinder
EF81 FF             _CYL1:	DB	0FFH	;Cylinder
EF82 FF             _CYL2:	DB	0FFH	;Cylinder
EF83 FF             _CYL3:	DB	0FFH	;Cylinder
EF84 00             _DRIVE:	DB	0	;unit number
EF85 00             _SEEKSP:DB	0	;Seek speed
EF86 FF             _ISEEK:	DB	0FFH	;
EF87 00             _DVSW:	DB	0
EF88 00             _DRV:	DB	0
EF89 FF             _DSK:	DB	0FFH
EF8A 80 00          _DTA:	DW	00080H
EF8C 00 00          _CTC:	DW	0
EF8E 00 00          _TXADR:	DW	0
EF90 00 00          _KEYPS:	DW	0
EF92 00 FF          _KEYD:	DW	0FF00H	;キーデータ
EF94 C2 10          _KEYSP:	DW	010C2H
EF96 07             _COLORF:DB	COLORF	;色
EF97 18             _LINE:	DB	LINE
EF98                
EF98 00 00          _FCB:	DW	0
EF9A 00 00          _FBPS:	DW	0	;SEARCH FILES
EF9C 00 00          _FBAD:	DW	0	;    //
EF9E 00             _FBCNT:	DB	0	;    //
EF9F 00             _FILEN:	DB	0
EFA0 00             _DIRF:	DB	0	;bit7:ディレクトリ bit0-6:セクタインデックス
EFA1                	DS	1
EFA2 00             _WTFATF:DB	0	;FATバッファの更新フラグ
EFA3                	DS	1
EFA4 00             _WTDBF:	DB	0	;データバッファの更新フラグ
EFA5 FF             _DBDRV:	DB	0FFH	;データバッファにあるデータを読み込んだドライブ
EFA6 00 00          _DBSEC:	DW	0	;データバッファにあるデータを読み込んだセクタ番号
EFA8 00 00          _DPB:	DW	0
EFAA                _FATDRV:
EFAA FF             	DB	0FFH	;FATバッファに読み込んでいるドライブ
EFAB 00             _FATIX:	DB	0	;FATバッファに読み込んでいるインデックス
EFAC                _FAKEFREE:
EFAC 00 00          	DW	0	;偽の残量（FATサイズが大きくなると重くなるのでその対策）
EFAE                
EFAE                	DS	2
EFB0                
EFB0                CRTCD:	
EFB0 6F             	DB	06FH
EFB1                _WIDTH:	
EFB1 50             	DB	WIDTH
EFB2                TVRAMTOP:
EFB2 59 38          	DB	059H,038H
EFB4 1F 02          	DB	01FH,002H
EFB6                _LINE2:
EFB6 19             	DB	019H
EFB7 1C             	DB	01CH
EFB8                WKE4:
EFB8 00             	DB	000H
EFB9                WK40:
EFB9 07             	DB	007H
EFBA                _PAGE_MINUS:
EFBA 80 F8          	DW	0-WIDTH*LINE
EFBC                _WIDTH_MINUS:
EFBC B0 FF          	DW	0-WIDTH
EFBE                WK30:
EFBE 0C             	DB	00CH
EFBF                WK31:
EFBF                WK1FD0:
EFBF 20             	DB	020H
EFC0                
EFC0 D1 DA          CTC0:	DW	INTCTCE
EFC2 D1 DA          CTC1:	DW	INTCTCE
EFC4 F3 DA          CTC2:	DW	INTCTC2
EFC6 D1 DA          CTC3:	DW	INTCTCE
EFC8 BA DA          INTVEC:	DW	INT
EFCA                
EFCA                ;	LSX-Dodgers 独自BIOS
EFCA                
EFCA C3 25 E0       _INKEY:	JP	INKEY
EFCD C3 C7 DC       _PRINT:	JP	PRINT
EFD0 C3 8D DF       _SCRN:	JP	SCRN
EFD3 C3 B7 DF       _POS:	JP	POS
EFD6 C3 09 DE       _LOC:	JP	LOC
EFD9                _CHGDRV:
EFD9 C3 9E EC       	JP	CHGDRV
EFDC                _GETDPB:
EFDC C3 6A ED       	JP	GETDPB
EFDF                _FFLUSH:
EFDF C3 88 ED       	JP	FFLUSH
EFE2                _RDFATX:
EFE2 C3 A4 E9       	JP	RDFATX
EFE5 C3 CC EA       _RDFAT:	JP	RDFAT
EFE8 C3 67 EE       _WTTRK:	JP	WTTRK
EFEB C3 7B EE       _FDRD:	JP	FDRD
EFEE C3 6D EE       _FDWT:	JP	FDWT
EFF1                _BPB2DPB:
EFF1 C3 31 EB       	JP	BPB2DPB
EFF4                	DS	3
EFF7                _GNCL:
EFF7 C3 46 EA       GNCPAT:	JP	GNCL		; self-modifying code
EFFA                _SNCL:
EFFA C3 69 EA       SNCPAT:	JP	SNCL		; self-modifying code
EFFD C3 75 D1       _COMANL:JP	COMANL
F000                
F000                _WE:
F000                	INCLUDE	"LDCALL.ASM"
F000                
F000                ;	LSX-Dodgers システムコール(BDOS)
F000                ;
F000                ;	LSX-Dodgers SYSTEM CALL
F000                ;	STABLE:アドレス下位1バイトが0になるように
F000                
F000                STABLE:
F000                ;0
F000 03 EF 73 DB    	DW	_SYS00,_SYS01,_SYS02,_SYS03
F004 7F DB D9 E1
F008 FC D7 FC D7    	DW	_SYS04,_SYS05,_SYS06,_SYS07
F00C 84 DB 09 EF
F010 8C DB FE D7    	DW	_SYS08,_SYS09,_SYS0A,_SYS0B
F014 C5 DB F1 DB
F018 13 D8 18 D8    	DW	_SYS0C,_SYS0D,_SYS0E,_SYS0F
F01C 27 D8 3A D8
F020                ;1
F020 8E D8 D5 D8    	DW	_SYS10,_SYS11,_SYS12,_SYS13
F024 1E D9 54 D9
F028 5C D9 72 D9    	DW	_SYS14,_SYS15,_SYS16,_SYS17
F02C 87 D9 7F D9
F030 CE D9 D3 D9    	DW	_SYS18,_SYS19,_SYS1A,_SYS1B
F034 D8 D9 DE D9
F038 FC D7 04 DA    	DW	_SYS1C,_SYS1D,_SYS1E,_SYS1F
F03C FC D7 08 DA
F040                ;2
F040 FC D7 BE D9    	DW	_SYS20,_SYS21,_SYS22,_SYS23
F044 C6 D9 0F DA
F048 35 DA FC D7    	DW	_SYS24,_ERROR,_SYS26,_SYS27
F04C 61 E6 46 E7
F050 C6 D9 3E DA    	DW	_SYS28,_SYS5C,_SYS2A,_SYS2B
F054 07 DC D9 E1
F058 2A DC D9 E1    	DW	_SYS2C,_SYS2D,_SYS2E,_SYS2F
F05C FC D7 61 DA
F060                ;3
F060 5B DA FC D7    	DW	_SYS30,_ERROR,_ERROR,_ERROR
F064 FC D7 FC D7
F068 FC D7 FC D7    	DW	_ERROR,_ERROR,_ERROR,_ERROR
F06C FC D7 FC D7
F070 FC D7 D9 E1    	DW	_ERROR,_SYS39,_SYS3A,_SYS5A
F074 D9 E1 82 DA
F078                ;DOS2
F078 DF D7          	DW	_DOS2
F07A                
F07A                	DS	2
F07C 00 F2          _FATBF:	DW	FATBF
F07E 00 FA          _DTBUF:	DW	DTBUF
F080                
F080                ;	コントロールコードテーブル
F080                ;	CTRLTB:アドレス下位1バイトが080Hになるように
F080                
F080                CTRLTB:
F080 7E DD 7E DD    	DW	CTRL00,CTRL00,CTRL02,CTRL03	;  A,B,C
F084 BA DD 01 DF
F088 FB DE DE DD    	DW	CTRL04,CTRL05,CTRL06,CTRL07	;D,E,F,G
F08C DA DE 61 DE
F090 8A DD AB DD    	DW	CTRL08,CTRL09,CTRL0A,CTRL0B	;H,I,J,K
F094 04 DF 1F DE
F098 D7 DE 04 DE    	DW	CTRL0C,CTRL0D,CTRL0E,CTRL00	;L,M,N,O
F09C 19 DF 7E DD
F0A0 7E DD 7E DD    	DW	CTRL00,CTRL00,CTRL12,CTRL00	;P,Q,R,S
F0A4 17 DE 7E DD
F0A8 7E DD 7E DD    	DW	CTRL00,CTRL00,CTRL00,CTRL00	;T,U,V,W
F0AC 7E DD 7E DD
F0B0 7E DD 7E DD    	DW	CTRL00,CTRL00,CTRL0C,CTRL1B	;X,Y,Z,ESC
F0B4 D7 DE 26 DE
F0B8 A5 DD 91 DD    	DW	CTRL1C,CTRL1D,CTRL1E,CTRL1F	;→,←,↑,↓
F0BC 9A DD 04 DF
F0C0                
F0C0                	DS	02AH
F0EA                
F0EA 16 17          SDDATA:	DB	22,23		;(FCB)ファイルを最後に変更した時刻
F0EC 14 15          	DB	20,21		;(FCB)ファイルを最後に変更した日付
F0EE 1A 1B          	DB	26,27		;(FCB)ファイルの先頭クラスタ
F0F0 10 11 12 13    	DB	16,17,18,19	;(FCB)ファイルのサイズ(バイト単位)
F0F4                SDDATAE:
F0F4                
F0F4                SCDIR:	DS	2		;+14 +15
F0F6                SFBPS:	DS	2		;FBPS
F0F8                SFNDF:	DS	2		;FILEN DIRF
F0FA                
F0FA 00 00          _FATPS:	DW	0
F0FC 00 00          _DIRPS:	DW	0
F0FE 00 00          _CLPS:	DW	0
F100                
F100                _PE:
F100                	INCLUDE	"X1DPB.ASM"
F100                
F100                ;	LSX-Dodgers DPB
F100                ;	X1/turbo/Z
F100                
F100                DEVICE:
F100                
F100                ;	A:
F100                
F100 02 00          	DW	2	;DPB_00_FATLN
F102 EB EF          	DW	_FDRD	;DPB_02_DRD
F104 EE EF          	DW	_FDWT	;DPB_04_DWT
F106 FD             	DB	0FDH	;DPB_06_FATID
F107 02             	DB	2	;DPB_07_SECPCL
F108 64 01          	DW	356	;DPB_08_MAXCL
F10A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F10B 07             	DB	7	;DPB_0B_DIRSCNT
F10C 28             	DB	40	;DPB_0C_MAXCYL
F10D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F10E 01             	DB	1	;DPB_0E_FATPS
F10F 82             	DB	082H	;DPB_0F_BPS
F110 05 00          	DW	5	;DPB_10_DIRPS
F112 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F113 00             	DB	0	;DPB_13_UNITNO
F114 08 00          	DW	8	;DPB_14_ADDCL16
F116 00 00          	DW	0	;DPB_16
F118 00 00          	DW	0	;DPB_18
F11A 00 00          	DW	0	;DPB_1A_SDIR
F11C 46 44 44 30    	DB	"FDD0"	;DPB_1C_NAME
F120                
F120                ;	B:
F120                
F120 02 00          	DW	2	;DPB_00_FATLN
F122 EB EF          	DW	_FDRD	;DPB_02_DRD
F124 EE EF          	DW	_FDWT	;DPB_04_DWT
F126 FD             	DB	0FDH	;DPB_06_FATID
F127 02             	DB	2	;DPB_07_SECPCL
F128 64 01          	DW	356	;DPB_08_MAXCL
F12A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F12B 07             	DB	7	;DPB_0B_DIRSCNT
F12C 28             	DB	40	;DPB_0C_MAXCYL
F12D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F12E 01             	DB	1	;DPB_0E_FATPS
F12F 82             	DB	082H	;DPB_0F_BPS
F130 05 00          	DW	5	;DPB_10_DIRPS
F132 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F133 01             	DB	1	;DPB_13_UNITNO
F134 08 00          	DW	8	;DPB_14_ADDCL16
F136 00 00          	DW	0	;DPB_16
F138 00 00          	DW	0	;DPB_18
F13A 00 00          	DW	0	;DPB_1A_SDIR
F13C 46 44 44 31    	DB	"FDD1"	;DPB_1C_NAME
F140                
F140                ;	C:
F140                
F140 02 00          	DW	2	;DPB_00_FATLN
F142 EB EF          	DW	_FDRD	;DPB_02_DRD
F144 EE EF          	DW	_FDWT	;DPB_04_DWT
F146 FD             	DB	0FDH	;DPB_06_FATID
F147 02             	DB	2	;DPB_07_SECPCL
F148 64 01          	DW	356	;DPB_08_MAXCL
F14A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F14B 07             	DB	7	;DPB_0B_DIRSCNT
F14C 28             	DB	40	;DPB_0C_MAXCYL
F14D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F14E 01             	DB	1	;DPB_0E_FATPS
F14F 82             	DB	082H	;DPB_0F_BPS
F150 05 00          	DW	5	;DPB_10_DIRPS
F152 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F153 02             	DB	2	;DPB_13_UNITNO
F154 08 00          	DW	8	;DPB_14_ADDCL16
F156 00 00          	DW	0	;DPB_16
F158 00 00          	DW	0	;DPB_18
F15A 00 00          	DW	0	;DPB_1A_SDIR
F15C 46 44 44 32    	DB	"FDD2"	;DPB_1C_NAME
F160                
F160                ;	D:
F160                
F160 02 00          	DW	2	;DPB_00_FATLN
F162 EB EF          	DW	_FDRD	;DPB_02_DRD
F164 EE EF          	DW	_FDWT	;DPB_04_DWT
F166 FD             	DB	0FDH	;DPB_06_FATID
F167 02             	DB	2	;DPB_07_SECPCL
F168 64 01          	DW	356	;DPB_08_MAXCL
F16A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F16B 07             	DB	7	;DPB_0B_DIRSCNT
F16C 28             	DB	40	;DPB_0C_MAXCYL
F16D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F16E 01             	DB	1	;DPB_0E_FATPS
F16F 82             	DB	082H	;DPB_0F_BPS
F170 05 00          	DW	5	;DPB_10_DIRPS
F172 A7             	DB	0A7H	;DPB_12_DEVICE
F173 03             	DB	3	;DPB_13_UNITNO
F174 08 00          	DW	8	;DPB_14_ADDCL16
F176 00 00          	DW	0	;DPB_16
F178 00 00          	DW	0	;DPB_18
F17A 00 00          	DW	0	;DPB_1A_SDIR
F17C 46 44 44 33    	DB	"FDD3"	;DPB_1C_NAME
F180                
F180                ;	E:
F180                
F180 00 00          EMMFL:	DW	0	;DPB_00_FATLN
F182 6D D7          EMMRD:	DW	EDRD	;DPB_02_DRD
F184 69 D7          EMMWR:	DW	EDWT	;DPB_04_DWT
F186 FE             	DB	0FEH	;DPB_06_FATID
F187 02             	DB	2	;DPB_07_SECPCL
F188 00 00          EMMCL:	DW	0	;DPB_08_MAXCL
F18A 00             	DB	0	;DPB_0A_FDMODE
F18B 0C             	DB	12	;DPB_0B_DIRSCNT
F18C 00             	DB	0	;DPB_0C_MAXCYL
F18D 00             	DB	0	;DPB_0D_MAXSEC
F18E 02             	DB	2	;DPB_0E_FATPS
F18F 02             	DB	2	;DPB_0F_BPS
F190 0A 00          	DW	10	;DPB_10_DIRPS
F192 06             EMMDV:	DB	6	;DPB_12_DEVICE
F193 00             	DB	0	;DPB_13_UNITNO
F194 12 00          	DW	18	;DPB_14_ADDCL16
F196 00 00          	DW	0	;DPB_16
F198 00 00          	DW	0	;DPB_18
F19A 00 00          	DW	0	;DPB_1A_SDIR
F19C 45 4D 4D 30    	DB	"EMM0"	;DPB_1C_NAME
F1A0                
F1A0                ;	F:
F1A0                
F1A0 00 00          BANKFL:	DW	0	;DPB_00_FATLN
F1A2 04 D7          	DW	BDRD	;DPB_02_DRD
F1A4 00 D7          	DW	BDWT	;DPB_04_DWT
F1A6 F9             	DB	0F9H	;DPB_06_FATID
F1A7 02             	DB	2	;DPB_07_SECPCL
F1A8 00 00          BANKCL:	DW	0	;DPB_08_MAXCL
F1AA 00             	DB	0	;DPB_0A_FDMODE
F1AB 08             	DB	8	;DPB_0B_DIRSCNT
F1AC 00             	DB	0	;DPB_0C_MAXCYL
F1AD 01             	DB	1	;DPB_0D_MAXSEC
F1AE 00             	DB	0	;DPB_0E_FATPS
F1AF 02             	DB	2	;DPB_0F_BPS
F1B0 02 00          	DW	2	;DPB_10_DIRPS
F1B2 0B             BANKDV:	DB	00BH	;DPB_12_DEVICE
F1B3 00             	DB	0	;DPB_13_UNITNO
F1B4 06 00          	DW	6	;DPB_14_ADDCL16
F1B6 00 00          	DW	0	;DPB_16
F1B8 00 00          	DW	0	;DPB_18
F1BA 00 00          	DW	0	;DPB_1A_SDIR
F1BC 42 52 41 4D    	DB	"BRAM"	;DPB_1C_NAME
F1C0                
F1C0                ;	G:
F1C0                
F1C0 02 00          	DW	2	;DPB_00_FATLN
F1C2 C1 D6          	DW	GDRD	;DPB_02_DRD
F1C4 D8 D6          	DW	GDWT	;DPB_04_DWT
F1C6 FA             	DB	0FAH	;DPB_06_FATID
F1C7 01             	DB	1	;DPB_07_SECPCL
F1C8 B8 00          	DW	184	;DPB_08_MAXCL
F1CA 00             	DB	0	;DPB_0A_FDMODE
F1CB 07             	DB	7	;DPB_0B_DIRSCNT
F1CC 00             	DB	0	;DPB_0C_MAXCYL
F1CD 01             	DB	1	;DPB_0D_MAXSEC
F1CE 01             	DB	1	;DPB_0E_FATPS
F1CF 01             	DB	1	;DPB_0F_BPS
F1D0 03 00          	DW	3	;DPB_10_DIRPS
F1D2 05             	DB	5	;DPB_12_DEVICE
F1D3 01             	DB	1	;DPB_13_UNITNO
F1D4 08 00          	DW	8	;DPB_14_ADDCL16
F1D6 00 00          	DW	0	;DPB_16
F1D8 00 00          	DW	0	;DPB_18
F1DA 00 00          	DW	0	;DPB_1A_SDIR
F1DC 47 52 41 4D    	DB	"GRAM"	;DPB_1C_NAME
F1E0                
F1E0                ;	H:
F1E0                	DS	32-8
F1F8 00             	DB	0
F1F9                
F1F9                LAST_ADR:
F1F9                
F1F9                	END
F1F9                
