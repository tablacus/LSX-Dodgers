                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for X1/turbo/Z
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "X1DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   X1/turbo/Z
                                
       0000                     MAC EQU 0       ;X1
       0000                     DEV EQU 0
                                
       011D                     VER_6F  EQU 0011DH
                                
       D100                     RUN EQU 0D100H
       D0F9                     OFFSET  EQU RUN-7
                                
       D706                     BDOS    EQU 0D706H
       EE00                     WORKAD  EQU 0EE00H
       F700                     FATBF   EQU 0F700H
       FD00                     DTBUF   EQU 0FD00H
       FF00                     KEYBF   EQU 0FF00H
       FF20                     KBUF    EQU 0FF20H
       FFCA                     EXTSP   EQU 0FFCAH
       FFD9                     TRAP38  EQU 0FFD9H
       0050                     WIDTH   EQU 80
       0018                     LINE    EQU 24
       0007                     COLORF  EQU 7
       0014                     KEYSP_H EQU 20
       00C2                     KEYSP_L EQU 0C2H
       0008                     COMS    EQU 8
       0002                     MAX_SEC_SZ_H    EQU 2       ;1セクタ1024バイトのサポート(2:off 4:on)
       0100                     BUFFER  EQU 00100H
       D813                     S27BUF_COM  EQU S27BUF
[EOF:X1DEF.ASM:UTF_8]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0001                     VER_3   EQU 1
       1D00                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0000                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0161                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 D0F9                         ORG RUN-7
                                
                                ;   MSX BINARY HEADER
000000 D0F9 FE                      DB  0FEH
                                ;   MSX BINARY START ADDRESS
000001 D0FA 00D1                    DW  RUN
                                ;   MSX BINARY END ADDRESS
000003 D0FC F9F6                    DW  LAST_ADR
                                ;   MSX BINARY EXEC ADDRESS
000005 D0FE 07D1                    DW  START
                                
                                    INCLUDE "X1INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   X1/turbo/Z
                                
000007 D100 C307D1          10      JP  START
00000A D103 001D                    DW  MACW
00000C D105 6101                    DW  VER
                                
       D107                     START:
00000E D107 F3               4      DI
00000F D108 ED5E             8      IM  2
000011 D10A 31CAFF          10      LD  SP,EXTSP
000014 D10D CD58D1          17      CALL    INIT        ;NZならAUTOEXECを実行
000017 D110 210000          10      LD  HL,0
00001A D113 E5              11      PUSH    HL
00001B D114 F5              11      PUSH    AF
                                                ;2HD等1セクタ1024バイトで起動時(Japan2HD)
00001C D115 3A0CFE          13      LD  A,(0FE0CH)
00001F D118 FE04             7      CP  4
000021 D11A 201B            12      JR  NZ,NOT_2HD2014
000023 D11C 2A0600          16      LD  HL,(00006H)
000026 D11F 5D               4      LD  E,L
000027 D120 54               4      LD  D,H
000028 D121 15               4      DEC D
000029 D122 15               4      DEC D
00002A D123 15               4      DEC D
00002B D124 15               4      DEC D
00002C D125 ED530600        20      LD  (00006H),DE
000030 D129 010300          10      LD  BC,3
000033 D12C EDB0                    LDIR
000035 D12E 3E04             7      LD  A,4
000037 D130 327BEF          13      LD  (_MAX_SEC_SZ_H),A
00003A D133 ED537EEF        20      LD  (_DTBUF),DE
       D137                     NOT_2HD2014:
00003E D137 3A0400          13      LD  A,(_DVSW)
000041 D13A CDDCEE          17      CALL    _GETDPB
000044 D13D 380A            12      JR  C,INIT1
000046 D13F 3A0400          13      LD  A,(_DVSW)
000049 D142 C641             7      ADD A,'A'
00004B D144 32AAD4          13      LD  (AUTODV),A
00004E D147 1807            12      JR  INIT2
       D149                     INIT1:
000050 D149 1E00             7      LD  E,0
000052 D14B 0E0E             7      LD  C,00EH
000054 D14D CD0500          17      CALL    SYSTEM
       D150                     INIT2:
000057 D150 F1              10      POP AF
000058 D151 C8              11      RET Z
000059 D152 11A1D4          10      LD  DE,AUTOD
00005C D155 C3FDEE          10      JP  _COMANL
                                
       D158                     INIT:
00005F D158 01031A          10      LD  BC,1A03H
000062 D15B 3E82             7      LD  A,82H
000064 D15D ED79            12      OUT (C),A
000066 D15F 3E1E             7      LD  A,01EH
000068 D161 D300            11      OUT (0),A
                                
00006A D163 010000          10      LD  BC,0
00006D D166 ED438CEE        20      LD  (_CTC),BC
000071 D16A 01040A          10      LD  BC,00A04H
000074 D16D CD4BD4          17      CALL    CHKCTC
000077 D170 010407          10      LD  BC,00704H
00007A D173 CD4BD4          17      CALL    CHKCTC
00007D D176 01A81F          10      LD  BC,01FA8H
000080 D179 CD4BD4          17      CALL    CHKCTC
000083 D17C 01A01F          10      LD  BC,01FA0H
000086 D17F CD4BD4          17      CALL    CHKCTC
                                
       D182                     INISIO:
000089 D182 01911F          10      LD  BC,01F91H   ;INIT SIO
00008C D185 1601             7      LD  D,1
00008E D187 ED51            12      OUT (C),D
                                
000090 D189 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
000092 D18B 0E93             7      LD  C,093H
000094 D18D ED51            12      OUT (C),D
000096 D18F ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
000098 D191 0E99             7      LD  C,099H      ;INIT SIO
00009A D193 1601             7      LD  D,1
00009C D195 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
00009E D197 0E9B             7      LD  C,09BH
0000A0 D199 ED51            12      OUT (C),D
0000A2 D19B ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
0000A4 D19D 0E80             7      LD  C,080H      ;INIT DMA
0000A6 D19F 2106C3          10      LD  HL,0C306H
       D1A2                     INIDMA:
0000A9 D1A2 ED61            12      OUT (C),H
0000AB D1A4 2D               4      DEC L
0000AC D1A5 20FB            12      JR  NZ,INIDMA
                                
0000AE D1A7 3EE4             7      LD  A,0E4H
0000B0 D1A9 CD12E3          17      CALL    COMOUT
0000B3 D1AC AF               4      XOR A
0000B4 D1AD CDECE2          17      CALL    OT49SB
                                
0000B7 D1B0 3EEE             7      LD  A,INTVEC/256
0000B9 D1B2 ED47             9      LD  I,A
                                
0000BB D1B4 ED4B8CEE        20      LD  BC,(_CTC)
0000BF D1B8 0D               4      DEC C
0000C0 D1B9 0D               4      DEC C
                                
0000C1 D1BA ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
0000C3 D1BC 3EC0             7      LD  A,CTC0-CPM_BOOT
0000C5 D1BE ED79            12      OUT (C),A
                                
0000C7 D1C0 0C               4      INC C
0000C8 D1C1 3E47             7      LD  A,047H
0000CA D1C3 ED79            12      OUT (C),A
0000CC D1C5 3E0D             7      LD  A,13        ;Baudrate 9600-13
0000CE D1C7 ED79            12      OUT (C),A
                                
0000D0 D1C9 79               4      LD  A,C
0000D1 D1CA D610             7      SUB 010H
0000D3 D1CC 4F               4      LD  C,A
                                ;   LD  (SIOAD+1),BC
                                ;   LD  (SIOAD0+1),BC
                                ;   LD  (SIOAD1+1),BC
                                
0000D4 D1CD 21F2D4          10      LD  HL,SIODATA
       D1D0                     SINIT1:
0000D7 D1D0 7E               7      LD  A,(HL)
0000D8 D1D1 23               6      INC HL
0000D9 D1D2 FEFF             7      CP  0FFH
0000DB D1D4 2804            12      JR  Z,SINIT2
0000DD D1D6 ED79            12      OUT (C),A
0000DF D1D8 18F6            12      JR  SINIT1
       D1DA                     SINIT2:
0000E1 D1DA 3EE4             7      LD  A,0E4H
0000E3 D1DC CD12E3          17      CALL    COMOUT
0000E6 D1DF 3EC8             7      LD  A,INTVEC-CPM_BOOT
0000E8 D1E1 CDECE2          17      CALL    OT49SB
                                ;
0000EB D1E4 01C41F          10      LD  BC,01FC4H
0000EE D1E7 3E0C             7      LD  A,00CH
0000F0 D1E9 ED79            12      OUT (C),A
                                
0000F2 D1EB 0EC0             7      LD  C,0C0H
0000F4 D1ED ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
0000F6 D1EF 0C               4      INC C
0000F7 D1F0 3E28             7      LD  A,40
0000F9 D1F2 ED79            12      OUT (C),A
                                
0000FB D1F4 0C               4      INC C
0000FC D1F5 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
0000FE D1F7 0C               4      INC C
0000FF D1F8 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
000101 D1FA 0EC5             7      LD  C,0C5H
000103 D1FC ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
       D1FE                     TEXT:
000105 D1FE 0EB0             7      LD  C,0B0H
000107 D200 3E80             7      LD  A,080H
000109 D202 ED79            12      OUT (C),A
00010B D204 1607             7      LD  D,7
00010D D206 0EB9             7      LD  C,0B9H
00010F D208 21EBD4          10      LD  HL,TEXTDT
       D20B                     TEXT1:
000112 D20B 04               4      INC B
000113 D20C EDA3            16      OUTI
000115 D20E 0C               4      INC C
000116 D20F 15               4      DEC D
000117 D210 20F9            12      JR  NZ,TEXT1
000119 D212 01B01F          10      LD  BC,01FB0H
00011C D215 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
00011E D217 0EC4             7      LD  C,0C4H
000120 D219 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
                                
000122 D21B 01011A          10      LD  BC,01A01H
000125 D21E ED78            12      IN  A,(C)
000127 D220 E608             7      AND 8
000129 D222 2809            12      JR  Z,PRN
00012B D224 0E03             7      LD  C,003H
00012D D226 3E0F             7      LD  A,00FH
00012F D228 ED79            12      OUT (C),A
000131 D22A 01040A          10      LD  BC,00A04H
       D22D                     PRN:
000134 D22D 210000          10      LD  HL,0
000137 D230 065C             7      LD  B,05CH
000139 D232 3E                      DB  03EH    ;LD A,??
00013A D233 FF              12      RST 38H
00013B D234 CDB6F0          17      CALL    FILL_MEMORY
00013E D237 06A4             7      LD  B,0A4H
000140 D239 AF               4      XOR A
000141 D23A CDB6F0          17      CALL    FILL_MEMORY
                                
000144 D23D 3A87FF          13      LD  A,(0FF87H)  ;起動ドライブ
000147 D240 E66F             7      AND 06FH
000149 D242 FE08             7      CP  8
00014B D244 3801            12      JR  C,INIDRV
00014D D246 AF               4      XOR A
       D247                     INIDRV:
00014E D247 320400          13      LD  (_DVSW),A   ;カレントドライブ
                                
000151 D24A 3EC3             7      LD  A,0C3H      ;JP
000153 D24C 2103EE          10      LD  HL,CPM_WBOOT
000156 D24F 320000          13      LD  (00000H),A
000159 D252 220100          16      LD  (00001H),HL ;IPL
                                
00015C D255 2106D7          10      LD  HL,BDOS
00015F D258 320500          13      LD  (00005H),A
000162 D25B 220600          16      LD  (00006H),HL ;BDOS
                                
000165 D25E 212FDF          10      LD  HL,BIOS
000168 D261 221900          16      LD  (00019H),HL ;BIOS-ROM
                                
00016B D264 21D9FF          10      LD  HL,TRAP38   ;TRAP38
00016E D267 323800          13      LD  (00038H),A
000171 D26A 223900          16      LD  (00039H),HL ;RST 038H
                                
000174 D26D 3EEE             7      LD  A,CPM_BOOT/256
000176 D26F 320B00          13      LD  (0000BH),A
                                
000179 D272 3E                      DB  03EH    ;LD A,??
00017A D273 E9               4      JP  (HL)
00017B D274 320F00          13      LD  (0000FH),A
                                                ;KEY
00017E D277 3EE6             7      LD  A,0E6H      ;キーデータ読み出し
000180 D279 CD12E3          17      CALL    COMOUT
000183 D27C CDF7E2          17      CALL    IN49SB
000186 D27F F5              11      PUSH    AF
000187 D280 CDF7E2          17      CALL    IN49SB
00018A D283 F1              10      POP AF
00018B D284 F5              11      PUSH    AF
00018C D285 E612             7      AND 012H
00018E D287 2005            12      JR  NZ,KEYR
000190 D289 3E01             7      LD  A,1
000192 D28B 32E5D3          13      LD  (KEYREP_SWC),A
       D28E                     KEYR:
000195 D28E F1              10      POP AF
000196 D28F E603             7      AND 3
000198 D291 280E            12      JR  Z,NON
                                
00019A D293 01D03F          10      LD  BC,03FD0H
00019D D296 ED49            12      OUT (C),C
00019F D298 3E37             7      LD  A,037H
0001A1 D29A D3D0            11      OUT (0D0H),A
0001A3 D29C ED78            12      IN  A,(C)
0001A5 D29E B9               4      CP  C
0001A6 D29F 2851            12      JR  Z,TURBO
       D2A1                     NON:
0001A8 D2A1 2125D5          10      LD  HL,AT_SCR1
0001AB D2A4 119CE3          10      LD  DE,SCR1
0001AE D2A7 019400          10      LD  BC,SCRNE-SCR1   ;転送先のサイズ確認用
0001B1 D2AA 018500          10      LD  BC,AT_SCRE-AT_SCR1
0001B4 D2AD EDB0                    LDIR
                                
0001B6 D2AF 21AAD5          10      LD  HL,AT_DWT
0001B9 D2B2 11DCEC          10      LD  DE,WTTRK
0001BC D2B5 018900          10      LD  BC,DMAE-WTTRK   ;転送先のサイズ確認用
0001BF D2B8 018800          10      LD  BC,AT_CPUE-AT_DWT
0001C2 D2BB EDB0                    LDIR
                                
0001C4 D2BD 2117E4          10      LD  HL,AT_WTTRK+AT_RS
0001C7 D2C0 22E9EE          16      LD  (_WTTRK+1),HL
0001CA D2C3 2122ED          10      LD  HL,AT_DRD+AT_R
0001CD D2C6 22ECEE          16      LD  (_FDRD+1),HL
0001D0 D2C9 21DCEC          10      LD  HL,AT_DWT+AT_R
0001D3 D2CC 22EFEE          16      LD  (_FDWT+1),HL
0001D6 D2CF 211EE4          10      LD  HL,AT_SCRN+AT_RS
0001D9 D2D2 22D1EE          16      LD  (_SCRN+1),HL
                                                        ;ノンターボは2D/2HD切り替えを行わない
0001DC D2D5 DD2100F6        14      LD  IX,_DEVICE
0001E0 D2D9 DDCB12BE        23      RES 7,(IX+DPB_DEVICE)       ;Aドライブ
0001E4 D2DD DDCB32BE        23      RES 7,(IX+DPB_DEVICE+32)        ;Bドライブ
0001E8 D2E1 DDCB52BE        23      RES 7,(IX+DPB_DEVICE+32*2)      ;Cドライブ
0001EC D2E5 DDCB72BE        23      RES 7,(IX+DPB_DEVICE+32*3)      ;Dドライブ
                                
0001F0 D2E9 210000          10      LD  HL,0
0001F3 D2EC 223DE3          16      LD  (X1PAT),HL
0001F6 D2EF C379D3          10      JP  NOBANK
                                
       D2F2                     TURBO:
0001F9 D2F2 F3               4      DI          ;Check BIOS
0001FA D2F3 061D             7      LD  B,01DH
0001FC D2F5 ED79            12      OUT (C),A       ;BIOS ON
0001FE D2F7 3A512F          13      LD  A,(02F51H)
000201 D2FA 04               4      INC B       ;B=01EH
000202 D2FB ED79            12      OUT (C),A       ;BIOS OFF
000204 D2FD FB               4      EI
000205 D2FE FEC9             7      CP  0C9H
000207 D300 2802            12      JR  Z,BIOSOK
000209 D302 1805            12      JR  NOBIOS
       D304                     BIOSOK:
00020B D304 3EC3             7      LD  A,0C3H      ;JP
00020D D306 321800          13      LD  (00018H),A
       D309                     NOBIOS:
000210 D309 3E1F             7      LD  A,01FH      ;スタートポート
000212 D30B DBF0            11      IN  A,(0F0H)
000214 D30D 0F               4      RRCA
000215 D30E 380B            12      JR  C,CRT1
000217 D310 21DBD4          10      LD  HL,_C8025H
00021A D313 11B0EE          10      LD  DE,CRTCD
00021D D316 011000          10      LD  BC,16
000220 D319 EDB0                    LDIR
       D31B                     CRT1:
000222 D31B 3A8CFF          13      LD  A,(0FF8CH)  ;IPL DEVICE (0:2D/1:2DD/2:2HD)
000225 D31E D602             7      SUB 2
000227 D320 2017            12      JR  NZ,BANK
                                
                                ;   XOR A       ;すでに0のハズ
       D322                     TZ1:                ;DPBのモードを2HDにしておく
000229 D322 F5              11      PUSH    AF
00022A D323 CDDCEE          17      CALL    _GETDPB
00022D D326 DD7E12          19      LD  A,(IX+DPB_DEVICE)
000230 D329 E68F             7      AND 08FH
000232 D32B FE87             7      CP  087H        ;フロッピーで切り替えがON
000234 D32D 2004            12      JR  NZ,TZ2
000236 D32F DDCB0A86        23      RES 0,(IX+DPB_FDMODE)
       D333                     TZ2:
00023A D333 F1              10      POP AF
00023B D334 3C               4      INC A
00023C D335 FE08             7      CP  8
00023E D337 38E9            12      JR  C,TZ1
                                
       D339                     BANK:
000240 D339 01000B          10      LD  BC,00B00H
000243 D33C 21007F          10      LD  HL,07F00H
000246 D33F F3               4      DI
000247 D340 ED69            12      OUT (C),L
000249 D342 3A0000          13      LD  A,(0)
00024C D345 FEEB             7      CP  0EBH
00024E D347 2005            12      JR  NZ,BANK1
000250 D349 3E2B             7      LD  A,02BH
000252 D34B 32B2F6          13      LD  (BANKDV),A
       D34E                     BANK1:
000255 D34E ED69            12      OUT (C),L
000257 D350 5E               7      LD  E,(HL)
000258 D351 7B               4      LD  A,E
000259 D352 C6A5             7      ADD A,0A5H
00025B D354 77               7      LD  (HL),A
00025C D355 BE               7      CP  (HL)
00025D D356 73               7      LD  (HL),E
00025E D357 2005            12      JR  NZ,BANK2
000260 D359 2C               4      INC L
000261 D35A CB65             8      BIT 4,L
000263 D35C 28F0            12      JR  Z,BANK1
       D35E                     BANK2:
000265 D35E 3E10             7      LD  A,010H
000267 D360 ED79            12      OUT (C),A
000269 D362 7D               4      LD  A,L
00026A D363 B7               4      OR  A
00026B D364 2813            12      JR  Z,NOBANK
00026D D366 2600             7      LD  H,0
00026F D368 29              11      ADD HL,HL   ;*2
000270 D369 29              11      ADD HL,HL   ;*4
000271 D36A 29              11      ADD HL,HL   ;*8
000272 D36B 29              11      ADD HL,HL   ;*16
000273 D36C 29              11      ADD HL,HL   ;*32
000274 D36D 2B               6      DEC HL  ;-1
000275 D36E 2B               6      DEC HL  ;-2
000276 D36F 2B               6      DEC HL  ;-3
000277 D370 22A8F6          16      LD  (BANKCL),HL
00027A D373 CD91D4          17      CALL    CALC_FATLN
00027D D376 32A0F6          13      LD  (BANKFL),A
       D379                     NOBANK:
       D379                     EMM:
000280 D379 DD2180F6        14      LD  IX,EMMFL
000284 D37D CD3CD4          17      CALL    EADR0
000287 D380 ED78            12      IN  A,(C)
000289 D382 F5              11      PUSH    AF
                                
00028A D383 110000          10      LD  DE,0
       D386                     ECHECK1:
00028D D386 13               6      INC DE
00028E D387 CD45D4          17      CALL    EADRX
000291 D38A ED60            12      IN  H,(C)
000293 D38C CD45D4          17      CALL    EADRX
000296 D38F 7C               4      LD  A,H
000297 D390 C6E5             7      ADD A,0E5H
000299 D392 ED79            12      OUT (C),A
00029B D394 3C               4      INC A
00029C D395 CD3CD4          17      CALL    EADR0
00029F D398 ED79            12      OUT (C),A
0002A1 D39A 3D               4      DEC A
0002A2 D39B CD45D4          17      CALL    EADRX
0002A5 D39E ED68            12      IN  L,(C)
0002A7 D3A0 CD45D4          17      CALL    EADRX
0002AA D3A3 ED61            12      OUT (C),H
0002AC D3A5 BD               4      CP  L
0002AD D3A6 2004            12      JR  NZ,ECHECK2
0002AF D3A8 CB5A             8      BIT 3,D
0002B1 D3AA 28DA            12      JR  Z,ECHECK1
       D3AC                     ECHECK2:
0002B3 D3AC CD3CD4          17      CALL    EADR0
0002B6 D3AF F1              10      POP AF
0002B7 D3B0 ED79            12      OUT (C),A
0002B9 D3B2 FEEB             7      CP  0EBH
0002BB D3B4 2817            12      JR  Z,EMM_BPB
0002BD D3B6 DD360D02        19      LD  (IX+DPB_MAXSEC),2   ;BPBが512バイト目から始まる場合を調べる
0002C1 D3BA CD3CD4          17      CALL    EADR0
0002C4 D3BD ED78            12      IN  A,(C)
0002C6 D3BF DDBE06          19      CP  (IX+DPB_FATID)
0002C9 D3C2 280D            12      JR  Z,EMM_NOBPB
0002CB D3C4 DD361226        19      LD  (IX+DPB_DEVICE),026H    ;BPBを使う
0002CF D3C8 21F5FF          10      LD  HL,0-11
0002D2 D3CB 180B            12      JR  EMM_BPB1
       D3CD                     EMM_BPB:
0002D4 D3CD DD361226        19      LD  (IX+DPB_DEVICE),026H    ;BPBを使う
       D3D1                     EMM_NOBPB:
0002D8 D3D1 DD360D00        19      LD  (IX+DPB_MAXSEC),0
0002DC D3D5 21F7FF          10      LD  HL,0-9
       D3D8                     EMM_BPB1:
0002DF D3D8 19              11      ADD HL,DE
0002E0 D3D9 3009            12      JR  NC,NOEMM
0002E2 D3DB 2288F6          16      LD  (EMMCL),HL
0002E5 D3DE CD91D4          17      CALL    CALC_FATLN
0002E8 D3E1 3280F6          13      LD  (EMMFL),A
       D3E4                     NOEMM:
0002EB D3E4 3E00             7      LD  A,000H
       D3E5                     KEYREP_SWC  EQU $-1
0002ED D3E6 B7               4      OR  A
0002EE D3E7 2807            12      JR  Z,KEYR1
0002F0 D3E9 010000          10      LD  BC,0
0002F3 D3EC ED438CEE        20      LD  (_CTC),BC
       D3F0                     KEYR1:
0002F7 D3F0 CD72D4          17      CALL    SETCRTC
0002FA D3F3 0130F8          10      LD  BC,0-80*25
0002FD D3F6 2ABAEE          16      LD  HL,(_PAGE_MINUS)
000300 D3F9 ED43BAEE        20      LD  (_PAGE_MINUS),BC
000304 D3FD 1E0C             7      LD  E,00CH
000306 D3FF CDCDEE          17      CALL    _PRINT
000309 D402 22BAEE          16      LD  (_PAGE_MINUS),HL
                                
00030C D405 21ADD4          10      LD  HL,INIMES
00030F D408 CDA2DC          17      CALL    MSX
                                
000312 D40B F3               4      DI
000313 D40C 2EFE             7      LD  L,0-2       ;CALLのスタック分減らす
000315 D40E 39              11      ADD HL,SP
000316 D40F 1100FF          10      LD  DE,0FF00H
000319 D412 45               4      LD  B,L
00031A D413 CD55DA          17      CALL    ZERO_MEMORY_DE
00031D D416 21CAFF          10      LD  HL,EXTBIO
000320 D419 36C9            10      LD  (HL),0C9H   ;RET
000322 D41B 23               6      INC HL
000323 D41C 060E             7      LD  B,TRAP38-EXTBIO-1
000325 D41E 3E                      DB  03EH    ;LD A,??
000326 D41F FF              12      RST 38H
000327 D420 CDB6F0          17      CALL    FILL_MEMORY
00032A D423 21FED4          10      LD  HL,AT_TRAP38
00032D D426 11D9FF          10      LD  DE,TRAP38
000330 D429 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
000333 D42C EDB0                    LDIR
                                
000335 D42E 3EE6             7      LD  A,0E6H      ;キーデータ読み出し
000337 D430 CD12E3          17      CALL    COMOUT
00033A D433 CDF7E2          17      CALL    IN49SB
00033D D436 CDF7E2          17      CALL    IN49SB
000340 D439 FE1B             7      CP  01BH
000342 D43B C9              10      RET
                                
       D43C                     EADR0:
000343 D43C D5              11      PUSH    DE
000344 D43D 110000          10      LD  DE,0
000347 D440 CD45D4          17      CALL    EADRX
00034A D443 D1              10      POP DE
00034B D444 C9              10      RET
                                
       D445                     EADRX:
00034C D445 F5              11      PUSH    AF
00034D D446 CD44DC          17      CALL    EADR
000350 D449 F1              10      POP AF
000351 D44A C9              10      RET
                                
       D44B                     CHKCTC:
000352 D44B C5              11      PUSH    BC
000353 D44C 110347          10      LD  DE,04703H
       D44F                     INICTC1:
000356 D44F 0C               4      INC C
000357 D450 ED51            12      OUT (C),D
000359 D452 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
00035B D454 1D               4      DEC E
00035C D455 20F8            12      JR  NZ,INICTC1
00035E D457 C1              10      POP BC
                                
00035F D458 11FA07          10      LD  DE,007FAH
000362 D45B ED51            12      OUT (C),D
000364 D45D ED59            12      OUT (C),E
000366 D45F ED78            12      IN  A,(C)
000368 D461 BB               4      CP  E
000369 D462 C0              11      RET NZ
00036A D463 ED51            12      OUT (C),D
00036C D465 ED51            12      OUT (C),D
00036E D467 ED78            12      IN  A,(C)
000370 D469 BA               4      CP  D
000371 D46A C0              11      RET NZ
000372 D46B 0C               4      INC C
000373 D46C 0C               4      INC C
000374 D46D ED438CEE        20      LD  (_CTC),BC
000378 D471 C9              10      RET
                                
       D472                     SETCRTC:
000379 D472 21B0EE          10      LD  HL,CRTCD
00037C D475 AF               4      XOR A
       D476                     SETCRT1:
00037D D476 010018          10      LD  BC,01800H
000380 D479 ED79            12      OUT (C),A
000382 D47B 0C               4      INC C
000383 D47C 04               4      INC B
000384 D47D EDA3            16      OUTI
000386 D47F 3C               4      INC A
000387 D480 FE0C             7      CP  12
000389 D482 20F2            12      JR  NZ,SETCRT1
00038B D484 23               6      INC HL
00038C D485 23               6      INC HL
00038D D486 01031B          10      LD  BC,01A03H+00100H
000390 D489 EDA3            16      OUTI
000392 D48B 01D020          10      LD  BC,01FD0H+00100H
000395 D48E EDA3            16      OUTI
000397 D490 C9              10      RET
                                
       D491                     CALC_FATLN: ;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
000398 D491 5D               4      LD  E,L
000399 D492 54               4      LD  D,H
00039A D493 29              11      ADD HL,HL   ;*2
00039B D494 19              11      ADD HL,DE   ;*3
00039C D495 CB3C             8      SRL H   ;/2
00039E D497 CB1D             8      RR  L   ;1クラスタ辺り1.5バイト必要
0003A0 D499 11FF01          10      LD  DE,511  ;切り上げる
0003A3 D49C 19              11      ADD HL,DE
0003A4 D49D 7C               4      LD  A,H
0003A5 D49E CB3F             8      SRL A
0003A7 D4A0 C9              10      RET
                                
0003A8 D4A1 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
0003B1 D4AA 413A00              AUTODV: DB  "A:",0
                                
0003B4 D4AD 4C53582D446F6467    INIMES: DB  "LSX-Dodgers for X1/turbo version "
            65727320666F7220    
            58312F747572626F    
            2076657273696F6E    
            20                  
0003D5 D4CE 312E                    DB  030H + VER_1, '.'
0003D7 D4D0 3631                    DB  030H + VER_2 ,030H + VER_3
0003D9 D4D2 67                      DB  'g'
0003DA D4D3 2047616B750D0A          DB  " Gaku",0DH,0AH
0003E1 D4DA 00                      DB  0
                                
       D4DB                     _C8025H:
0003E2 D4DB 6B5059881B00191A        DB  06BH,050H,059H,088H,01BH,000H,019H,01AH
0003EA D4E3 000F                    DB  000H,00FH
0003EC D4E5 80F8B0FF                DW  0-80*LINE,0-80
0003F0 D4E9 0C23                    DB  00CH,023H
                                
0003F2 D4EB 030C0F30333C3F      TEXTDT: DB  003H,00CH,00FH,030H,033H,03CH,03FH
                                
       D4F2                     SIODATA:
0003F9 D4F2 18                      DB  018H
0003FA D4F3 0100                    DB  1,0
0003FC D4F5 0200                    DB  2,0
0003FE D4F7 03C1                    DB  3,0C1H
000400 D4F9 0444                    DB  4,044H
000402 D4FB 05E8                    DB  5,0E8H
000404 D4FD FF                      DB  0FFH
                                
       D4FE                     AT_TRAP38:
000405 D4FE 210000          10      LD  HL,0
000408 D501 E3              19      EX  (SP),HL
000409 D502 3E24             7      LD  A,'$'
00040B D504 CDC0DF          17      CALL    MSG_A
00040E D507 2B               6      DEC HL
00040F D508 7C               4      LD  A,H
000410 D509 CDE8FF          17      CALL    PRHX+AT_RT
000413 D50C 7D               4      LD  A,L
       D50D                     PRHX:
000414 D50D F5              11      PUSH    AF
000415 D50E 07               4      RLCA
000416 D50F 07               4      RLCA
000417 D510 07               4      RLCA
000418 D511 07               4      RLCA
000419 D512 CDF1FF          17      CALL    PRHX2+AT_RT
00041C D515 F1              10      POP AF
       D516                     PRHX2:
00041D D516 E60F             7      AND 00FH
00041F D518 FE0A             7      CP  10
000421 D51A 3F               4      CCF
000422 D51B CE30             7      ADC A,'0'
000424 D51D 27               4      DAA
000425 D51E C3C0DF          10      JP  MSG_A
000428 D521                         DS  4
       D525                     AT_TRAPE:
[EOF:X1INIT.ASM:SHIFT_JIS]
                                    INCLUDE "X1CPU.ASM"
                                
                                ;   LSX-Dodgers CPU
                                ;   X1/turbo/Z
                                
                                ;   ノンターボ用パッチ
                                ;   DMAを使って転送している部分をCPUに差し替える
                                
       D525                     AT_SCR1:
00042C D525 D9               4      EXX
00042D D526 C5              11      PUSH    BC
00042E D527 ED4BB1EE        20      LD  BC,(_WIDTH)
000432 D52B 0620             7      LD  B,020H
000434 D52D D9               4      EXX
000435 D52E C5              11      PUSH    BC
000436 D52F 010020          10      LD  BC,02000H
                                
000439 D532 67               4      LD  H,A
00043A D533 B7               4      OR  A
       D534                     AT_SCRUP1:
00043B D534 2815            12      JR  Z,AT_SCRCL
00043D D536 C5              11      PUSH    BC
00043E D537 CBE0             8      SET 4,B
000440 D539 D9               4      EXX
000441 D53A C5              11      PUSH    BC
000442 D53B CBE0             8      SET 4,B
000444 D53D D9               4      EXX
000445 D53E CDCDE3          17      CALL    AT_UPSUB+AT_RS
000448 D541 D9               4      EXX
000449 D542 C1              10      POP BC
00044A D543 D9               4      EXX
00044B D544 C1              10      POP BC
00044C D545 CDCDE3          17      CALL    AT_UPSUB+AT_RS
00044F D548 25               4      DEC H
000450 D549 18E9            12      JR  AT_SCRUP1
                                
       D54B                     AT_SCRCL:
000452 D54B 2AB1EE          16      LD  HL,(_WIDTH)
000455 D54E CD65E2          17      CALL    LINECL
000458 D551 C1              10      POP BC
000459 D552 D9               4      EXX
00045A D553 C1              10      POP BC
00045B D554 D9               4      EXX
00045C D555 C9              10      RET
                                
       D556                     AT_UPSUB:
00045D D556 3AB1EE          13      LD  A,(_WIDTH)
000460 D559 6F               4      LD  L,A
       D55A                     AT_UPSUB1:
000461 D55A D9               4      EXX
000462 D55B ED78            12      IN  A,(C)
000464 D55D 03               6      INC BC
000465 D55E D9               4      EXX
000466 D55F ED79            12      OUT (C),A
000468 D561 03               6      INC BC
000469 D562 2D               4      DEC L
00046A D563 20F5            12      JR  NZ,AT_UPSUB1
00046C D565 C9              10      RET
                                
                                ;   FLOPPY DISK DRIVER(CPU)
                                
       D566                     DISKC:
00046D D566 1B               6      DEC DE
00046E D567 CB5F             8      BIT 3,A
000470 D569 C4D5EC          17      CALL    NZ,RNF
       D56C                     DISKD:
000473 D56C E5              11      PUSH    HL
000474 D56D 21DBEC          10      LD  HL,RETRY
000477 D570 35              11      DEC (HL)
000478 D571 E1              10      POP HL
000479 D572 200C            12      JR  NZ,AT_ERR       ;Retry
00047B D574 B7               4      OR  A
00047C D575 2809            12      JR  Z,AT_ERR        ;Error
                                
       D577                     AT_DELP:
00047E D577 CDD5EC          17      CALL    RNF
000481 D57A CDADEC          17      CALL    FDMOFF
000484 D57D 3EFF             7      LD  A,0FFH
       D57F                     AT_ERRZ:
000486 D57F BF               4      CP  A
       D580                     AT_ERR:
000487 D580 3EFF             7      LD  A,0FFH
000489 D582 C9              10      RET
       D583                     ERRW:
00048A D583 3EFF             7      LD  A,0FFH
00048C D585 BF               4      CP  A
00048D D586 37               4      SCF
00048E D587 C3ADEC          10      JP  FDMOFF
                                
       D58A                     ERRDW:
000491 D58A D1              10      POP DE
000492 D58B CDEEE3          17      CALL    AT_DELP+AT_RS
000495 D58E C2EAEC          10      JP  NZ,DWT0+AT_R
000498 D591 B7               4      OR  A
000499 D592 20EF            12      JR  NZ,ERRW
00049B D594 C9              10      RET
                                
       D595                     ERRDR:
00049C D595 D1              10      POP DE
00049D D596 CDEEE3          17      CALL    AT_DELP+AT_RS
0004A0 D599 C230ED          10      JP  NZ,DRD0+AT_R
0004A3 D59C B7               4      OR  A
0004A4 D59D 20E4            12      JR  NZ,ERRW
0004A6 D59F C9              10      RET
                                
       D5A0                     AT_WTTRK:
0004A7 D5A0 0601             7      LD  B,1
0004A9 D5A2 3EF4             7      LD  A,0F4H      ;FDC TypeIIIコマンド Write Track
0004AB D5A4 C3DEEC          10      JP  AT_WTTRK1+AT_R
                                
       D5A7                     AT_SCRN:
0004AE D5A7 ED78            12      IN  A,(C)
0004B0 D5A9 C9              10      RET
       D5AA                     AT_SCRE:
                                
       D5AA                     AT_DWT:
0004B1 D5AA 3EA0             7      LD  A,0A0H      ;FDC TypeIIコマンド Write Sector
       D5AC                     AT_WTTRK1:
0004B3 D5AC 3272EC          13      LD  (FDCSWC),A
       D5AF                     DWTBL:
0004B6 D5AF 78               4      LD  A,B
0004B7 D5B0 321EED          13      LD  (AT_WTB+1+AT_R),A
0004BA D5B3 3E02             7      LD  A,2     ;Retry count
0004BC D5B5 32DBEC          13      LD  (RETRY),A
       D5B8                     DWT0:
0004BF D5B8 D5              11      PUSH    DE
0004C0 D5B9 E5              11      PUSH    HL
0004C1 D5BA CD12EC          17      CALL    SEEK        ;Write disk
0004C4 D5BD E1              10      POP HL
0004C5 D5BE DA01E4          10      JP  C,ERRDW+AT_RS
0004C8 D5C1 F3               4      DI
0004C9 D5C2 CDBAEC          17      CALL    SECSET_FDCCMD
0004CC D5C5 0EFB             7      LD  C,0FBH      ;MB8877A データレジスタ
       D5C7                     DWT1:
0004CE D5C7 56               7      LD  D,(HL)
       D5C8                     DWT2:
0004CF D5C8 78               4      LD  A,B
0004D0 D5C9 DBF8            11      IN  A,(0F8H)    ;MB8877A ステータス／コマンドレジスタ
0004D2 D5CB 0F               4      RRCA
0004D3 D5CC 3008            12      JR  NC,DWT4
0004D5 D5CE 0F               4      RRCA
0004D6 D5CF 30F7            12      JR  NC,DWT2
       D5D1                     DWT3:
0004D8 D5D1 ED51            12      OUT (C),D
0004DA D5D3 23               6      INC HL
0004DB D5D4 18F1            12      JR  DWT1
                                
       D5D6                     DWT4:
0004DD D5D6 3D               4      DEC A
0004DE D5D7 28F8            12      JR  Z,DWT3
0004E0 D5D9 3C               4      INC A
0004E1 D5DA FB               4      EI
0004E2 D5DB D1              10      POP DE
0004E3 D5DC 13               6      INC DE
0004E4 D5DD CDADEC          17      CALL    FDMOFF
0004E7 D5E0 2809            12      JR  Z,DISKOK_WT
0004E9 D5E2 CDDDE3          17      CALL    DISKC+AT_RS
0004EC D5E5 20D1            12      JR  NZ,DWT0
0004EE D5E7 B7               4      OR  A
0004EF D5E8 C2FAE3          10      JP  NZ,ERRW+AT_RS
                                
       D5EB                     DISKOK_WT:
0004F2 D5EB 0601             7  AT_WTB: LD  B,1
0004F4 D5ED 10C0            13      DJNZ    DWTBL
0004F6 D5EF C9              10      RET
                                
       D5F0                     AT_DRD:
0004F7 D5F0 3E80             7      LD  A,080H      ;FDC TypeIIコマンド Read Sector
0004F9 D5F2 3272EC          13      LD  (FDCSWC),A
       D5F5                     DRDBL:
0004FC D5F5 78               4      LD  A,B
0004FD D5F6 3260ED          13      LD  (AT_RDB+1+AT_R),A
000500 D5F9 3E02             7      LD  A,2     ;Retry count
000502 D5FB 32DBEC          13      LD  (RETRY),A
       D5FE                     DRD0:
000505 D5FE D5              11      PUSH    DE
000506 D5FF E5              11      PUSH    HL
000507 D600 CD12EC          17      CALL    SEEK        ;Read disk
00050A D603 E1              10      POP HL
00050B D604 DA0CE4          10      JP  C,ERRDR+AT_RS
00050E D607 F3               4      DI
00050F D608 CDBAEC          17      CALL    SECSET_FDCCMD
000512 D60B 0EFB             7      LD  C,0FBH      ;MB8877A データレジスタ
       D60D                     DRD1:
000514 D60D 78               4      LD  A,B
000515 D60E DBF8            11      IN  A,(0F8H)    ;MB8877A ステータス／コマンドレジスタ
000517 D610 0F               4      RRCA
000518 D611 3008            12      JR  NC,DRD3
00051A D613 0F               4      RRCA
00051B D614 30F7            12      JR  NC,DRD1
00051D D616 EDA2            16      INI
00051F D618 04               4      INC B
000520 D619 18F2            12      JR  DRD1
                                
       D61B                     DRD3:
000522 D61B B7               4      OR  A
000523 D61C FB               4      EI
000524 D61D D1              10      POP DE
000525 D61E 13               6      INC DE
000526 D61F CDADEC          17      CALL    FDMOFF
000529 D622 2809            12      JR  Z,DISKOK_RD
00052B D624 CDDDE3          17      CALL    DISKC+AT_RS
00052E D627 20D5            12      JR  NZ,DRD0
000530 D629 B7               4      OR  A
000531 D62A C2FAE3          10      JP  NZ,ERRW+AT_RS
                                
       D62D                     DISKOK_RD:
000534 D62D 0601             7  AT_RDB: LD  B,1
000536 D62F 10C4            13      DJNZ    DRDBL
000538 D631 C9              10      RET
                                
       D632                     AT_CPUE:
                                
       2ADB                     AT_RT   EQU TRAP38-AT_TRAP38
                                
       D632                     INITE:
000539 D632                         DS  BDOS-INITE
00060D D706 C362DC          10      JP  BDOS0
[EOF:X1CPU.ASM:SHIFT_JIS]
                                    INCLUDE "X1CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   X1/turbo/Z
                                
       D709                     WBOOT1:
000610 D709 F3               4      DI
000611 D70A ED7B0600        20      LD  SP,(SYSTEM+1)
                                
000615 D70E 3EEE             7      LD  A,INTVEC/256
000617 D710 ED47             9      LD  I,A
                                
000619 D712 3EE4             7      LD  A,0E4H
00061B D714 CD12E3          17      CALL    COMOUT
00061E D717 3EC8             7      LD  A,INTVEC-CPM_BOOT
000620 D719 CDECE2          17      CALL    OT49SB
                                
000623 D71C 21B0EE          10      LD  HL,CRTCD
000626 D71F AF               4      XOR A
       D720                     SETCRT2:
000627 D720 010018          10      LD  BC,01800H
00062A D723 ED79            12      OUT (C),A
00062C D725 0C               4      INC C
00062D D726 56               7      LD  D,(HL)
00062E D727 FE0D             7      CP  13
000630 D729 3802            12      JR  C,SETCRT3
000632 D72B 1600             7      LD  D,0
       D72D                     SETCRT3:
000634 D72D ED51            12      OUT (C),D
000636 D72F 23               6      INC HL
000637 D730 3C               4      INC A
000638 D731 FE0E             7      CP  14
00063A D733 20EB            12      JR  NZ,SETCRT2
                                
00063C D735 01031B          10      LD  BC,01A03H+00100H
00063F D738 EDA3            16      OUTI
000641 D73A 01D020          10      LD  BC,01FD0H+00100H
000644 D73D EDA3            16      OUTI
000646 D73F 2192EE          10      LD  HL,_KEYD
000649 D742 7E               7      LD  A,(HL)
00064A D743 3600            10      LD  (HL),0
00064C D745 CDADDF          17      CALL    KEYBC_IFBREAK
00064F D748 3E04             7      LD  A,4
000651 D74A CDC0DF          17      CALL    MSG_A
[EOF:X1CCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D74D                     COMMAND:
000654 D74D 3AC6ED          13      LD  A,(FCB_BAT)
000657 D750 B7               4      OR  A
000658 D751 C28FD8          10      JP  NZ,C_BAT1
00065B D754 CD03D8          17      CALL    SETDTA1
00065E D757 3A0400          13      LD  A,(_DVSW)
000661 D75A C641             7      ADD A,'A'
000663 D75C CDC0DF          17      CALL    MSG_A
000666 D75F 3E3E             7      LD  A,'>'
000668 D761 CDC0DF          17      CALL    MSG_A
00066B D764 3E50             7      LD  A,80
00066D D766 12               7      LD  (DE),A
00066E D767 CD41E0          17      CALL    _SYS0A      ;(BDOS)文字列入力
000671 D76A CD84D9          17      CALL    LTNL
       D76D                     COMMAND2:
000674 D76D 118200          10      LD  DE,DTA1+2
000677 D770 CDFDEE          17      CALL    _COMANL
00067A D773 DC26DF          17      CALL    C,SHOW_ERROR
00067D D776 18D5            12      JR  COMMAND
                                
       D778                     COMANL:
00067F D778 CD0BF0          17      CALL    FILE
000682 D77B 3A19EE          13      LD  A,(FNAME+4)
000685 D77E FE20             7      CP  020H
000687 D780 201C            12      JR  NZ,COMB2
000689 D782 D5              11      PUSH    DE
00068A D783 1115EE          10      LD  DE,FNAME
00068D D786 1A               7      LD  A,(DE)
00068E D787 FE20             7      CP  020H
000690 D789 2844            12      JR  Z,SDVSW
000692 D78B 1B               6      DEC DE
000693 D78C 1A               7      LD  A,(DE)
000694 D78D C6FF             7      ADD A,0FFH
000696 D78F 3809            12      JR  C,COMB
000698 D791 13               6      INC DE
                                
000699 D792 2141DB          10      LD  HL,COMTB
00069C D795 0608             7      LD  B,COMS
00069E D797 CD98F2          17      CALL    CPNAME
       D79A                     COMB:
0006A1 D79A D1              10      POP DE
0006A2 D79B D225DF          10      JP  NC,JPHL
       D79E                     COMB2:
0006A5 D79E EB               4      EX  DE,HL
0006A6 D79F 226CD8          16      LD  (COMSWC),HL
0006A9 D7A2 F5              11      PUSH    AF
0006AA D7A3 CD24D8          17      CALL    CEXE4
0006AD D7A6 F1              10      POP AF
0006AE D7A7 2115EE          10      LD  HL,FNAME
0006B1 D7AA 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
0006B4 D7AD 010B00          10      LD  BC,11
0006B7 D7B0 EDB0                    LDIR
0006B9 D7B2 1165ED          10      LD  DE,PATHD
       D7B5                     CEX1:
0006BC D7B5 1A               7      LD  A,(DE)
0006BD D7B6 FE20             7      CP  020H
0006BF D7B8 D8              11      RET C
0006C0 D7B9 CD00F0          17      CALL    FILEC
0006C3 D7BC D5              11      PUSH    DE
0006C4 D7BD 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
0006C7 D7C0 1115EE          10      LD  DE,FNAME
0006CA D7C3 010B00          10      LD  BC,11
0006CD D7C6 EDB0                    LDIR
0006CF D7C8 CD24D8          17      CALL    CEXE4
0006D2 D7CB D1              10      POP DE
0006D3 D7CC 13               6      INC DE
0006D4 D7CD 18E6            12      JR  CEX1
                                
       D7CF                     SDVSW:
0006D6 D7CF F1              10      POP AF
0006D7 D7D0 3A14EE          13      LD  A,(FDRV)
0006DA D7D3 3D               4      DEC A
0006DB D7D4 5F               4      LD  E,A
0006DC D7D5 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
0006DE D7D7 1831            12      JR  SYSTEM0
                                
       D7D9                     OPEN1:
0006E0 D7D9 2114EE          10      LD  HL,FDRV
       D7DC                     OPEN:
0006E3 D7DC 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D7DE                     OPEN3:
0006E5 D7DE D5              11      PUSH    DE
0006E6 D7DF 11A1ED          10      LD  DE,DTA_CCP
0006E9 D7E2 CD00D8          17      CALL    SETDTA
0006EC D7E5 EB               4      EX  DE,HL
0006ED D7E6 CD0AD8          17      CALL    SYSTEM0
0006F0 D7E9 D1              10      POP DE
0006F1 D7EA C9              10      RET
                                
       D7EB                     OPEN2:
0006F2 D7EB 0E12             7      LD  C,012H
0006F4 D7ED 18EF            12      JR  OPEN3
                                
       D7EF                     DEFCB:              ;Z=Ok NZ=Error
0006F6 D7EF 11A1ED          10      LD  DE,DTA_CCP
0006F9 D7F2 CD08D8          17      CALL    SYSC0F
                                
0006FC D7F5 11C2ED          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0006FF D7F8 0604             7      LD  B,4
000701 D7FA CD55DA          17      CALL    ZERO_MEMORY_DE
       D7FD                     SETDTA100:
000704 D7FD 110001          10      LD  DE,BUFFER
       D800                     SETDTA:
000707 D800 C366DE          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D803                     SETDTA1:
00070A D803 118000          10      LD  DE,DTA1
00070D D806 18F8            12      JR  SETDTA
                                
       D808                     SYSC0F:
00070F D808 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D80A                     SYSTEM0:
000711 D80A CD0500          17      CALL    SYSTEM
000714 D80D B7               4      OR  A
000715 D80E C9              10      RET
                                
       D80F                     C_CD:
000716 D80F 0E5A             7      LD  C,05AH
000718 D811 18F7            12      JR  SYSTEM0
                                
       D813                     S27BUF:
00071A D813 2100FE          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       D816                     S27BUF2:
00071D D816 39              11      ADD HL,SP
00071E D817 2E00             7      LD  L,0
000720 D819 7C               4      LD  A,H
000721 D81A E6F8             7      AND 0F8H
000723 D81C 67               4      LD  H,A
       D81D                     S27DTA:
000724 D81D 11A1ED          10      LD  DE,DTA_CCP
       D820                     S27:
000727 D820 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
000729 D822 18E6            12      JR  SYSTEM0
                                
       D824                     CEXE4:
00072B D824 211DEE          10      LD  HL,FNAME+8
00072E D827 7E               7      LD  A,(HL)
00072F D828 FE20             7      CP  020H
000731 D82A 2007            12      JR  NZ,CEXE7
000733 D82C 3E3F             7      LD  A,'?'
000735 D82E 77               7      LD  (HL),A
000736 D82F 23               6      INC HL
000737 D830 77               7      LD  (HL),A
000738 D831 23               6      INC HL
000739 D832 77               7      LD  (HL),A
       D833                     CEXE7:
00073A D833 CDD9D7          17      CALL    OPEN1
       D836                     CEXE5:
00073D D836 C0              11      RET NZ
00073E D837 2AABED          16      LD  HL,(DTA_CCP+1+9)
000741 D83A 7C               4      LD  A,H
000742 D83B CD27F3          17      CALL    CAP
000745 D83E 67               4      LD  H,A
000746 D83F 7D               4      LD  A,L
000747 D840 CD27F3          17      CALL    CAP
00074A D843 6F               4      LD  L,A
00074B D844 3AAAED          13      LD  A,(DTA_CCP+1+8)
00074E D847 CD27F3          17      CALL    CAP
000751 D84A D642             7      SUB 'B'
000753 D84C 282C            12      JR  Z,C_BAT
000755 D84E 3D               4      DEC A       ;'C'
000756 D84F 2805            12      JR  Z,C_EXE
       D851                     CEXE6:
000758 D851 CDEBD7          17      CALL    OPEN2
00075B D854 18E0            12      JR  CEXE5
                                
       D856                     C_EXE:
00075D D856 7C               4      LD  A,H
00075E D857 FE4D             7      CP  'M'
000760 D859 20F6            12      JR  NZ,CEXE6
                                
000762 D85B CDEFD7          17      CALL    DEFCB
000765 D85E CD13D8          17      CALL    S27BUF_COM
000768 D861 3D               4      DEC A
000769 D862 37               4      SCF
00076A D863 C0              11      RET NZ
00076B D864 7C               4      LD  A,H
00076C D865 B5               4      OR  L
00076D D866 37               4      SCF
00076E D867 C8              11      RET Z
00076F D868 CD03D8          17      CALL    SETDTA1
000772 D86B 110000          10      LD  DE,0                ; self-modifying code
       D86C                     COMSWC  EQU $-2
000775 D86E ED7B0600        20      LD  SP,(SYSTEM+1)
000779 D872 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
00077A D873 6F               4      LD  L,A
00077B D874 E5              11      PUSH    HL              ; push $0000 (reboot address)
00077C D875 24               4      INC H
00077D D876 E5              11      PUSH    HL              ; push $0100 (TPA address)
00077E D877 C320DA          10      JP  SETFCB              ; and JP $0100
                                
       D87A                     C_BAT:
000781 D87A 114154          10      LD  DE,'A'+'T'*256
000784 D87D ED52            15      SBC HL,DE
000786 D87F 20D0            12      JR  NZ,CEXE6
                                
000788 D881 CDEFD7          17      CALL    DEFCB
                                
00078B D884 21A1ED          10      LD  HL,DTA_CCP
00078E D887 11C6ED          10      LD  DE,FCB_BAT
000791 D88A 012500          10      LD  BC,37
000794 D88D EDB0                    LDIR
       D88F                     C_BAT1:
000796 D88F CDFDD7          17      CALL    SETDTA100
000799 D892 CDC6D8          17      CALL    FGETC_BAT
00079C D895 218100          10      LD  HL,DTA1+1
00079F D898 2025            12      JR  NZ,END_BATCH
0007A1 D89A FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
0007A3 D89C 38F1            12      JR  C,C_BAT1
0007A5 D89E 3620            10      LD  (HL),' '
0007A7 D8A0 23               6      INC HL
       D8A1                     C_BAT2:
0007A8 D8A1 77               7      LD  (HL),A
0007A9 D8A2 23               6      INC HL
0007AA D8A3 7D               4      LD  A,L
0007AB D8A4 3C               4      INC A       ;L==0FFH
0007AC D8A5 2809            12      JR  Z,RUN_BATCH
0007AE D8A7 CDC6D8          17      CALL    FGETC_BAT
0007B1 D8AA 2004            12      JR  NZ,RUN_BATCH
0007B3 D8AC FE20             7      CP  020H
0007B5 D8AE 30F1            12      JR  NC,C_BAT2
       D8B0                     RUN_BATCH:
0007B7 D8B0 7D               4      LD  A,L
0007B8 D8B1 D67F             7      SUB DTA1-1
0007BA D8B3 328000          13      LD  (DTA1),A
0007BD D8B6 FE04             7      CP  4
0007BF D8B8 3805            12      JR  C,END_BATCH
0007C1 D8BA 3600            10      LD  (HL),0
0007C3 D8BC C36DD7          10      JP  COMMAND2
       D8BF                     END_BATCH:
0007C6 D8BF AF               4      XOR A       ;バッチファイルを閉じる
0007C7 D8C0 32C6ED          13      LD  (FCB_BAT),A
0007CA D8C3 C300EE          10      JP  CPM_BOOT
                                
       D8C6                     FGETC_BAT:
0007CD D8C6 11C6ED          10      LD  DE,FCB_BAT
       D8C9                     FGETC:              ;1文字ずつ読み込む
0007D0 D8C9 E5              11      PUSH    HL      ;Z:成功
0007D1 D8CA 210100          10      LD  HL,1
0007D4 D8CD CD20D8          17      CALL    S27
0007D7 D8D0 E1              10      POP HL
0007D8 D8D1 3A0001          13      LD  A,(BUFFER)
0007DB D8D4 C9              10      RET
                                
       D8D5                     C_DEL:
0007DC D8D5 CD20DA          17      CALL    SETFCB
0007DF D8D8 CDD6DF          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
0007E2 D8DB 0E13             7      LD  C,013H
0007E4 D8DD 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D8DF                     C_REN:
0007E6 D8DF CD20DA          17      CALL    SETFCB
0007E9 D8E2 3E10             7      LD  A,010H      ;ディレクトリも対象にする
0007EB D8E4 326900          13      LD  (FCB1+13),A ;属性
0007EE D8E7 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D8E9                     CDEL1:
0007F0 D8E9 115C00          10      LD  DE,FCB1
0007F3 D8EC CD0500          17      CALL    SYSTEM
0007F6 D8EF C6FF             7      ADD A,0FFH
0007F8 D8F1 C9              10      RET
                                
       D8F2                     C_DIR:
0007F9 D8F2 CD00F0          17      CALL    FILEC
0007FC D8F5 2115EE          10      LD  HL,FDRV+1
0007FF D8F8 CD36DB          17      CALL    CWILD1
000802 D8FB 3EF1             7      LD  A,0F1H
000804 D8FD 3221EE          13      LD  (FDRV+13),A
000807 D900 CDD9D7          17      CALL    OPEN1
       D903                     CDIR1:
00080A D903 B7               4      OR  A
00080B D904 2008            12      JR  NZ,PDSKF
00080D D906 CD51D9          17      CALL    P_NAME
000810 D909 CDEBD7          17      CALL    OPEN2
000813 D90C 18F5            12      JR  CDIR1
       D90E                     PDSKF:
000815 D90E 3A14EE          13      LD  A,(FDRV)
000818 D911 5F               4      LD  E,A
000819 D912 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
00081B D914 CD0500          17      CALL    SYSTEM
00081E D917 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
00081F D918 C601             7      ADD A,001H
000821 D91A D8              11      RET C       ;Aが0FFHだった場合
000822 D91B 3E06             7      LD  A,8-2
       D91D                     PDS1:               ;HL=未使用クラスタの総数
000824 D91D 3C               4      INC A
000825 D91E CB19             8      RR  C
000827 D920 30FB            12      JR  NC,PDS1
       D922                     PDS2:               ;B←論理セクタのサイズの上位8ビット
000829 D922 3C               4      INC A
00082A D923 CB18             8      RR  B
00082C D925 30FB            12      JR  NC,PDS2
00082E D927 47               4      LD  B,A
                                
00082F D928 110000          10      LD  DE,0
       D92B                     PDS3:
000832 D92B 29              11      ADD HL,HL
000833 D92C EB               4      EX  DE,HL
000834 D92D ED6A            15      ADC HL,HL
000836 D92F EB               4      EX  DE,HL
000837 D930 10F9            13      DJNZ    PDS3
       D932                     PDSKF1:
000839 D932 CDBED9          17      CALL    PRDEC_DEHL
00083C D935 11F6ED          10      LD  DE,FREE
00083F D938 CD93DC          17      CALL    _SYS09      ;(BDOS)文字列出力
000842 D93B CDABD9          17      CALL    PUTDRV
000845 D93E 3E5C             7      LD  A,05CH      ;\
000847 D940 CDC0DF          17      CALL    MSG_A
00084A D943 2A22EE          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
00084D D946 AF               4      XOR A
00084E D947 11FEFF          10      LD  DE,0-2
000851 D94A 19              11      ADD HL,DE
000852 D94B 23               6      INC HL
000853 D94C DCBBD9          17      CALL    C,PRDEC_HL
000856 D94F 1833            12      JR  LTNL
                                
       D951                     P_NAME:
000858 D951 3AA2ED          13      LD  A,(DTA_CCP+1)
00085B D954 FE2E             7      CP  '.'
00085D D956 C8              11      RET Z
                                
00085E D957 3AADED          13      LD  A,(DTA_CCP+1+00BH)
000861 D95A F5              11      PUSH    AF
000862 D95B CB67             8      BIT 4,A
000864 D95D 2808            12      JR  Z,DIR3
000866 D95F 11EBED          10      LD  DE,DIRMES
000869 D962 CD93DC          17      CALL    _SYS09      ;(BDOS)文字列出力
00086C D965 180A            12      JR  DIR6
       D967                     DIR3:
00086E D967 ED5BC0ED        20      LD  DE,(DTA_CCP+1+01EH)
000872 D96B 2ABEED          16      LD  HL,(DTA_CCP+1+01CH)
000875 D96E CDBED9          17      CALL    PRDEC_DEHL
       D971                     DIR6:
000878 D971 F1              10      POP AF
000879 D972 0F               4      RRCA
00087A D973 9F               4      SBC A,A
00087B D974 E60A             7      AND '*'-020H
00087D D976 C620             7      ADD A,020H
00087F D978 CDC0DF          17      CALL    MSG_A
000882 D97B CDABD9          17      CALL    PUTDRV
000885 D97E 21A2ED          10      LD  HL,DTA_CCP+1
000888 D981 CDFED9          17      CALL    FPRNT
                                
       D984                     LTNL:
00088B D984 1E03             7      LD  E,3
00088D D986 C3CDEE          10      JP  _PRINT
                                
       D989                     C_PATH:
000890 D989 CDE1F0          17      CALL    SPCUT
000893 D98C 2165ED          10      LD  HL,PATHD
000896 D98F FE21             7      CP  021H
000898 D991 300C            12      JR  NC,CPATH0
       D993                     CPATHP:
00089A D993 7E               7      LD  A,(HL)
00089B D994 23               6      INC HL
00089C D995 FE20             7      CP  020H
00089E D997 3F               4      CCF
00089F D998 30EA            12      JR  NC,LTNL
0008A1 D99A CDC0DF          17      CALL    MSG_A
0008A4 D99D 18F4            12      JR  CPATHP
       D99F                     CPATH0:
0008A6 D99F FE3B             7      CP  ';'
0008A8 D9A1 2001            12      JR  NZ,CPATH1
0008AA D9A3 13               6      INC DE
       D9A4                     CPATH1:
0008AB D9A4 EB               4      EX  DE,HL
0008AC D9A5 013B00          10      LD  BC,PATHX
0008AF D9A8 EDB0                    LDIR
0008B1 D9AA C9              10      RET
                                
       D9AB                     PUTDRV:
0008B2 D9AB 3A14EE          13      LD  A,(FDRV)
0008B5 D9AE CD14F1          17      CALL    GETDRV1
0008B8 D9B1 C641             7      ADD A,'A'
0008BA D9B3 CDC0DF          17      CALL    MSG_A
0008BD D9B6 3E3A             7      LD  A,':'
       D9B8                     MSG_AR:
0008BF D9B8 C3C0DF          10      JP  MSG_A
                                
       D9BB                     PRDEC_HL:
0008C2 D9BB AF               4      XOR A
0008C3 D9BC 5F               4      LD  E,A
0008C4 D9BD 57               4      LD  D,A
       D9BE                     PRDEC_DEHL:
0008C5 D9BE D5              11      PUSH    DE
0008C6 D9BF 110FEE          10      LD  DE,DECBF
0008C9 D9C2 0605             7      LD  B,5
0008CB D9C4 CD55DA          17      CALL    ZERO_MEMORY_DE  ;A=0
0008CE D9C7 D1              10      POP DE
                                
0008CF D9C8 0E20             7      LD  C,32
       D9CA                     DEC1:
0008D1 D9CA 29              11      ADD HL,HL
0008D2 D9CB EB               4      EX  DE,HL
0008D3 D9CC ED6A            15      ADC HL,HL
0008D5 D9CE EB               4      EX  DE,HL
0008D6 D9CF E5              11      PUSH    HL
0008D7 D9D0 2113EE          10      LD  HL,DECBF+4
0008DA D9D3 0605             7      LD  B,5
       D9D5                     DEC2:
0008DC D9D5 7E               7      LD  A,(HL)
0008DD D9D6 8F               4      ADC A,A
0008DE D9D7 27               4      DAA
0008DF D9D8 77               7      LD  (HL),A
0008E0 D9D9 2B               6      DEC HL
0008E1 D9DA 10F9            13      DJNZ    DEC2
0008E3 D9DC E1              10      POP HL
0008E4 D9DD 0D               4      DEC C
0008E5 D9DE 20EA            12      JR  NZ,DEC1
                                
0008E7 D9E0 210FEE          10      LD  HL,DECBF
0008EA D9E3 3E20             7      LD  A,020H
0008EC D9E5 0604             7      LD  B,4
       D9E7                     DEC3:
0008EE D9E7 CDF4D9          17      CALL    DEC4
0008F1 D9EA CDF4D9          17      CALL    DEC4
0008F4 D9ED 23               6      INC HL
0008F5 D9EE 10F7            13      DJNZ    DEC3
       D9F0                     DECX:
0008F7 D9F0 CDF4D9          17      CALL    DEC4
0008FA D9F3 AF               4      XOR A
       D9F4                     DEC4:
0008FB D9F4 ED6F            18      RLD
0008FD D9F6 FE20             7      CP  020H
0008FF D9F8 2802            12      JR  Z,DEC5
000901 D9FA F630             7      OR  030H
       D9FC                     DEC5:
000903 D9FC 18BA            12      JR  MSG_AR
                                
       D9FE                     FPRNT:
000905 D9FE 0608             7      LD  B,8 ;ファイル名を表示
000907 DA00 CD0FDA          17      CALL    P_N1
00090A DA03 7E               7      LD  A,(HL)
00090B DA04 CD33F3          17      CALL    CAP3
00090E DA07 D8              11      RET C   ;拡張子が無い
                                
00090F DA08 3E2E             7      LD  A,'.'
000911 DA0A CDC0DF          17      CALL    MSG_A
000914 DA0D 0603             7      LD  B,3 ;拡張子を表示
       DA0F                     P_N1:
000916 DA0F 7E               7      LD  A,(HL)
000917 DA10 CD33F3          17      CALL    CAP3
00091A DA13 3807            12      JR  C,P_N2
00091C DA15 CDC0DF          17      CALL    MSG_A
00091F DA18 23               6      INC HL
000920 DA19 10F4            13      DJNZ    P_N1
000922 DA1B C9              10      RET
       DA1C                     P_N2:
000923 DA1C 23               6      INC HL
000924 DA1D 10FD            13      DJNZ    P_N2
000926 DA1F C9              10      RET
                                
       DA20                     SETFCB:
000927 DA20 CDE1F0          17      CALL    SPCUT
00092A DA23 1A               7      LD  A,(DE)
00092B DA24 FE20             7      CP  020H
00092D DA26 3801            12      JR  C,SETFCBA
00092F DA28 1B               6      DEC DE
       DA29                     SETFCBA:
000930 DA29 0624             7      LD  B,36
000932 DA2B 215C00          10      LD  HL,FCB1
000935 DA2E E5              11      PUSH    HL
000936 DA2F AF               4      XOR A
000937 DA30 CDB6F0          17      CALL    FILL_MEMORY
00093A DA33 E1              10      POP HL
00093B DA34 D5              11      PUSH    DE
00093C DA35 CDCCDE          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
00093F DA38 216C00          10      LD  HL,FCB2
000942 DA3B CDCCDE          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
000945 DA3E E1              10      POP HL
000946 DA3F 010050          10      LD  BC,05000H
000949 DA42 118100          10      LD  DE,00081H
       DA45                     SETFCB1:
00094C DA45 7E               7      LD  A,(HL)
00094D DA46 23               6      INC HL
00094E DA47 FE20             7      CP  020H
000950 DA49 3805            12      JR  C,SETFCB2
000952 DA4B 12               7      LD  (DE),A
000953 DA4C 13               6      INC DE
000954 DA4D 0C               4      INC C
000955 DA4E 10F5            13      DJNZ    SETFCB1
       DA50                     SETFCB2:
000957 DA50 79               4      LD  A,C
000958 DA51 328000          13      LD  (DTA1),A
00095B DA54 04               4      INC B
       DA55                     ZERO_MEMORY_DE:
00095C DA55 AF               4      XOR A
       DA56                     FILL_MEMORY_DE:
00095D DA56 12               7      LD  (DE),A
00095E DA57 13               6      INC DE
00095F DA58 10FC            13      DJNZ    FILL_MEMORY_DE
000961 DA5A C9              10      RET
                                
       DA5B                     C_COPY:
000962 DA5B CD20DA          17      CALL    SETFCB
                                
000965 DA5E 1161EE          10      LD  DE,ZERO
000968 DA61 CD03F0          17      CALL    FILEC2
00096B DA64 216C00          10      LD  HL,FCB2
00096E DA67 CDD3DE          17      CALL    S29X1
                                
000971 DA6A 3E10             7      LD  A,010H
000973 DA6C 326900          13      LD  (FCB1+13),A
000976 DA6F 216D00          10      LD  HL,FCB2FN
000979 DA72 CD36DB          17      CALL    CWILD1
       DA75                     COPY0:
00097C DA75 CD33DB          17      CALL    CWILD
00097F DA78 215C00          10      LD  HL,FCB1
000982 DA7B CDDCD7          17      CALL    OPEN
000985 DA7E 37               4      SCF
       DA7F                     COPY1:
000986 DA7F C0              11      RET NZ
000987 DA80 CDEFD7          17      CALL    DEFCB
                                
00098A DA83 3AAEED          13      LD  A,(DTA_CCP+13)
00098D DA86 CB67             8      BIT 4,A
00098F DA88 2821            12      JR  Z,COPY1A
                                
000991 DA8A 215D00          10      LD  HL,FCB1FN
000994 DA8D CD46F4          17      CALL    CHKWILD
000997 DA90 3814            12      JR  C,COPY9
                                
000999 DA92 3E20             7      LD  A,020H
00099B DA94 325D00          13      LD  (FCB1FN),A
00099E DA97 2ABBED          16      LD  HL,(DTA_CCP+26)
0009A1 DA9A 23               6      INC HL
0009A2 DA9B 226A00          16      LD  (FCB1+14),HL
0009A5 DA9E 18D5            12      JR  COPY0
                                
       DAA0                     COPY8:
0009A7 DAA0 CD93DC          17      CALL    _SYS09      ;(BDOS)文字列出力
0009AA DAA3 CD84D9          17      CALL    LTNL
       DAA6                     COPY9:
0009AD DAA6 CDEBD7          17      CALL    OPEN2
0009B0 DAA9 18D4            12      JR  COPY1
                                
       DAAB                     COPY1A:
0009B2 DAAB 216C00          10      LD  HL,FCB2
0009B5 DAAE 1114EE          10      LD  DE,FDRV
0009B8 DAB1 01A3ED          10      LD  BC,DTA_CCP+2
0009BB DAB4 EDA0            16      LDI
0009BD DAB6 3E0B             7      LD  A,11
       DAB8                     COPY2:
0009BF DAB8 F5              11      PUSH    AF
0009C0 DAB9 7E               7      LD  A,(HL)
0009C1 DABA FE3F             7      CP  '?'
0009C3 DABC 2001            12      JR  NZ,COPY3
0009C5 DABE 0A               7      LD  A,(BC)
       DABF                     COPY3:
0009C6 DABF 12               7      LD  (DE),A
0009C7 DAC0 03               6      INC BC
0009C8 DAC1 13               6      INC DE
0009C9 DAC2 23               6      INC HL
0009CA DAC3 F1              10      POP AF
0009CB DAC4 3D               4      DEC A
0009CC DAC5 20F1            12      JR  NZ,COPY2
0009CE DAC7 010500          10      LD  BC,16-11
0009D1 DACA EDB0                    LDIR
       DACC                     PUTNAME:
0009D3 DACC 215D00          10      LD  HL,FCB1FN
0009D6 DACF CD46F4          17      CALL    CHKWILD
0009D9 DAD2 300B            12      JR  NC,PUTN1
0009DB DAD4 2115EE          10      LD  HL,FDRV+1
0009DE DAD7 CDFED9          17      CALL    FPRNT
0009E1 DADA 3E20             7      LD  A,020H
0009E3 DADC CDC0DF          17      CALL    MSG_A
       DADF                     PUTN1:
0009E6 DADF 1114EE          10      LD  DE,FDRV
0009E9 DAE2 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
0009EB DAE4 CD0AD8          17      CALL    SYSTEM0
0009EE DAE7 2048            12      JR  NZ,COPYE2
0009F0 DAE9 67               4      LD  H,A     ;A=0
0009F1 DAEA 6F               4      LD  L,A
0009F2 DAEB 2235EE          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0009F5 DAEE 2237EE          16      LD  (FDRV+35),HL
       DAF1                     COPY6:
0009F8 DAF1 CD13D8          17      CALL    S27BUF
0009FB DAF4 47               4      LD  B,A
0009FC DAF5 3C               4      INC A
0009FD DAF6 2831            12      JR  Z,COPYE
0009FF DAF8 7C               4      LD  A,H
000A00 DAF9 B5               4      OR  L
000A01 DAFA 280C            12      JR  Z,COPY7
000A03 DAFC 1114EE          10      LD  DE,FDRV
000A06 DAFF 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
000A08 DB01 CD0AD8          17      CALL    SYSTEM0
000A0B DB04 2023            12      JR  NZ,COPYE
000A0D DB06 10E9            13      DJNZ    COPY6
       DB08                     COPY7:
000A0F DB08 3AAEED          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
000A12 DB0B 3221EE          13      LD  (FDRV+13),A
000A15 DB0E 21B5ED          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
000A18 DB11 1128EE          10      LD  DE,FDRV+20
000A1B DB14 010400          10      LD  BC,4
000A1E DB17 EDB0                    LDIR
                                
000A20 DB19 1114EE          10      LD  DE,FDRV
000A23 DB1C 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
000A25 DB1E CD0AD8          17      CALL    SYSTEM0
000A28 DB21 2006            12      JR  NZ,COPYE
                                
000A2A DB23 1171EE          10      LD  DE,OK
000A2D DB26 C3A0DA          10      JP  COPY8
                                
       DB29                     COPYE:
000A30 DB29 1114EE          10      LD  DE,FDRV
000A33 DB2C 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
000A35 DB2E CD0500          17      CALL    SYSTEM
       DB31                     COPYE2:
000A38 DB31 37               4      SCF
000A39 DB32 C9              10      RET
                                
       DB33                     CWILD:
000A3A DB33 215D00          10      LD  HL,FCB1FN
       DB36                     CWILD1:
000A3D DB36 7E               7      LD  A,(HL)
000A3E DB37 FE20             7      CP  020H
000A40 DB39 C0              11      RET NZ
       DB3A                     CWILD2:
000A41 DB3A 3E3F             7      LD  A,'?'
000A43 DB3C 060B             7      LD  B,11
000A45 DB3E C3B6F0          10      JP  FILL_MEMORY
                                
       DB41                     COMTB:
000A48 DB41 44202020                DB  "D   "  ;1
000A4C DB45 F2D8                    DW  C_DIR
000A4E DB47 44495220                DB  "DIR "  ;2
000A52 DB4B F2D8                    DW  C_DIR
000A54 DB4D 434F5059                DB  "COPY"  ;3
000A58 DB51 5BDA                    DW  C_COPY
000A5A DB53 43442020                DB  "CD  "  ;4
000A5E DB57 0FD8                    DW  C_CD
000A60 DB59 44454C20                DB  "DEL "  ;5
000A64 DB5D D5D8                    DW  C_DEL
000A66 DB5F 50415448                DB  "PATH"  ;6
000A6A DB63 89D9                    DW  C_PATH
000A6C DB65 52454E20                DB  "REN "  ;7
000A70 DB69 DFD8                    DW  C_REN
000A72 DB6B 52454D20                DB  "REM "  ;8
000A76 DB6F 90DC                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "X1DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   X1/turbo/Z
                                
                                ;   GRAPHIC RAM DISK DRIVER
                                
                                
       DB71                     GDRD:
000A78 DB71 C5              11      PUSH    BC
000A79 DB72 CD9ADB          17      CALL    GADR
000A7C DB75 F1              10      POP AF
       DB76                     GDRD1:
000A7D DB76 EDA2            16      INI
000A7F DB78 04               4      INC B
000A80 DB79 0C               4      INC C
000A81 DB7A 20FA            12      JR  NZ,GDRD1
000A83 DB7C 04               4      INC B
000A84 DB7D 13               6      INC DE
000A85 DB7E 3D               4      DEC A
000A86 DB7F 20F5            12      JR  NZ,GDRD1
       DB81                     GBANK0:
000A88 DB81 3ABFEE          13      LD  A,(WK1FD0)
000A8B DB84 E6EF             7      AND 0EFH        ;BANK0
000A8D DB86 181D            12      JR  S1FD0
                                
       DB88                     GDWT:
000A8F DB88 C5              11      PUSH    BC
000A90 DB89 CD9ADB          17      CALL    GADR
000A93 DB8C F1              10      POP AF
       DB8D                     GDWT1:
000A94 DB8D 04               4      INC B
000A95 DB8E EDA3            16      OUTI
000A97 DB90 0C               4      INC C
000A98 DB91 20FA            12      JR  NZ,GDWT1
000A9A DB93 04               4      INC B
000A9B DB94 13               6      INC DE
000A9C DB95 3D               4      DEC A
000A9D DB96 20F5            12      JR  NZ,GDWT1
000A9F DB98 18E7            12      JR  GBANK0
                                
       DB9A                     GADR:
000AA1 DB9A 0E00             7      LD  C,0
000AA3 DB9C 7B               4      LD  A,E
000AA4 DB9D C640             7      ADD A,040H
000AA6 DB9F 47               4      LD  B,A
000AA7 DBA0 3ABFEE          13      LD  A,(WK1FD0)
000AAA DBA3 F610             7      OR  010H        ;BANK1
       DBA5                     S1FD0:
000AAC DBA5 C5              11      PUSH    BC
000AAD DBA6 32BFEE          13      LD  (WK1FD0),A
000AB0 DBA9 01D01F          10      LD  BC,01FD0H
000AB3 DBAC ED79            12      OUT (C),A
000AB5 DBAE C1              10      POP BC
000AB6 DBAF C9              10      RET
                                
                                
                                ;   BANK RAM DISK DRIVER
                                
       DBB0                     BDWT:
000AB7 DBB0 3E                      DB  03EH    ;LD A,??
000AB8 DBB1 37               4      SCF
000AB9 DBB2 1802            12      JR  BRW
                                
       DBB4                     BDRD:
000ABB DBB4 3E                      DB  03EH    ;LD A,??
000ABC DBB5 A7               4      AND A
       DBB6                     BRW:
000ABD DBB6 F3               4      DI
000ABE DBB7 32E2DB          13      LD  (BRWPAT),A
000AC1 DBBA ED7302DC        20      LD  (BANKSP),SP
000AC5 DBBE 3A03DC          13      LD  A,(BANKSP_H)
000AC8 DBC1 87               4      ADD A,A
000AC9 DBC2 3803            12      JR  C,BRW0
000ACB DBC4 31CAFF          10      LD  SP,EXTSP
       DBC7                     BRW0:
000ACE DBC7 D9               4      EXX     ;裏レジスタ
000ACF DBC8 C5              11       PUSH    BC
000AD0 DBC9 D5              11       PUSH    DE
000AD1 DBCA 01000B          10       LD  BC,00B00H   ;バンクメモリ
000AD4 DBCD 111010          10       LD  DE,01010H
000AD7 DBD0 D9               4       EXX        ;表レジスタ
       DBD1                     BRW1:
000AD8 DBD1 C5              11      PUSH    BC
000AD9 DBD2 D5              11      PUSH    DE
000ADA DBD3 EB               4      EX  DE,HL
000ADB DBD4 29              11      ADD HL,HL
000ADC DBD5 29              11      ADD HL,HL
000ADD DBD6 7C               4      LD  A,H
000ADE DBD7 DD860C          19      ADD A,(IX+DPB_MAXCYL)
000AE1 DBDA E60F             7      AND 00FH    ;バンク
000AE3 DBDC 65               4      LD  H,L
000AE4 DBDD CB3C             8      SRL H   ;/2
000AE6 DBDF 2E00             7      LD  L,0
000AE8 DBE1 D9               4      EXX     ;裏レジスタ
000AE9 DBE2 A7               4  BRWPAT:  AND     A  ;自己書き換え(AND A:読み出し/SCF:書き込み)
000AEA DBE3 3808            12       JR  C,BRWT
000AEC DBE5 57               4       LD  D,A     ;D=バンク
000AED DBE6 D9               4       EXX        ;表レジスタ
000AEE DBE7 EB               4      EX  DE,HL
000AEF DBE8 CD06DC          17      CALL    BTFR
000AF2 DBEB 1806            12      JR  BRW2
       DBED                     BRWT:
000AF4 DBED 5F               4       LD E,A  ;E=バンク
000AF5 DBEE D9               4       EXX        ;表レジスタ
000AF6 DBEF CD06DC          17      CALL    BTFR
000AF9 DBF2 EB               4      EX  DE,HL
       DBF3                     BRW2:
000AFA DBF3 D1              10      POP DE
000AFB DBF4 C1              10      POP BC
000AFC DBF5 13               6      INC DE
000AFD DBF6 10D9            13      DJNZ    BRW1
                                
000AFF DBF8 D9               4      EXX     ;裏レジスタ
000B00 DBF9 3E10             7       LD  A,10H
000B02 DBFB ED79            12       OUT     (C),A      ;メインメモリに切り替える
000B04 DBFD D1              10       POP     DE
000B05 DBFE C1              10       POP     BC
000B06 DBFF D9               4       EXX        ;表レジスタ
000B07 DC00 AF               4      XOR A
000B08 DC01 310000          10      LD  SP,0
       DC03                     BANKSP_H    EQU $-1
       DC02                     BANKSP      EQU $-2
000B0B DC04 FB               4      EI
000B0C DC05 C9              10      RET
                                
                                ;メインメモリ←→バンクメモリ 512バイトの転送を行う
                                ; DE:転送元アドレス
                                ; HL:転送先アドレス
                                ; 裏BC:バンク切り替えポート(0B00H)
                                ; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
                                ; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
                                
       DC06                     BTFR:
000B0D DC06 0600             7      LD  B,0 ;256回ループ(256*2)
       DC08                     BTFR1:
000B0F DC08 D9               4      EXX     ;裏レジスタ
000B10 DC09 ED51            12       OUT     (C),D   ;BANK(MAIN)
000B12 DC0B D9               4       EXX        ;表レジスタ
000B13 DC0C 1A               7      LD  A,(DE)
000B14 DC0D 4F               4      LD  C,A
000B15 DC0E 13               6      INC DE
000B16 DC0F 1A               7      LD  A,(DE)
000B17 DC10 13               6      INC DE
000B18 DC11 D9               4      EXX     ;裏レジスタ
000B19 DC12 ED59            12       OUT     (C),E   ;MAIN(BANK)
000B1B DC14 D9               4       EXX        ;表レジスタ
000B1C DC15 71               7      LD  (HL),C
000B1D DC16 23               6      INC HL
000B1E DC17 77               7      LD  (HL),A
000B1F DC18 23               6      INC HL
000B20 DC19 10ED            13      DJNZ    BTFR1
000B22 DC1B C9              10      RET
                                
                                ;   EMM DRIVER(CPU)
                                
       DC1C                     EDWT:
000B23 DC1C CD44DC          17      CALL    EADR
       DC1F                     EDWT0:
000B26 DC1F F5              11      PUSH    AF
000B27 DC20 AF               4      XOR A
       DC21                     EDWT1:
000B28 DC21 04               4      INC B
000B29 DC22 EDA3            16      OUTI
000B2B DC24 04               4      INC B
000B2C DC25 EDA3            16      OUTI
000B2E DC27 3D               4      DEC A
000B2F DC28 20F7            12      JR  NZ,EDWT1
000B31 DC2A 13               6      INC DE
000B32 DC2B F1              10      POP AF
000B33 DC2C 3D               4      DEC A
000B34 DC2D 20F0            12      JR  NZ,EDWT0
000B36 DC2F C9              10      RET
                                
       DC30                     EDRD:
000B37 DC30 CD44DC          17      CALL    EADR
       DC33                     EDRD0:
000B3A DC33 F5              11      PUSH    AF
000B3B DC34 AF               4      XOR A
       DC35                     EDRD1:
000B3C DC35 EDA2            16      INI
000B3E DC37 04               4      INC B
000B3F DC38 EDA2            16      INI
000B41 DC3A 04               4      INC B
000B42 DC3B 3D               4      DEC A
000B43 DC3C 20F7            12      JR  NZ,EDRD1
000B45 DC3E 13               6      INC DE
000B46 DC3F F1              10      POP AF
000B47 DC40 3D               4      DEC A
000B48 DC41 20F0            12      JR  NZ,EDRD0
000B4A DC43 C9              10      RET
                                
       DC44                     EADR:
000B4B DC44 C5              11      PUSH    BC
000B4C DC45 D5              11      PUSH    DE
000B4D DC46 EB               4      EX  DE,HL
000B4E DC47 29              11      ADD HL,HL
000B4F DC48 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
000B52 DC4B DD460C          19      LD  B,(IX+DPB_MAXCYL)
000B55 DC4E 09              11      ADD HL,BC
000B56 DC4F DD4E13          19      LD  C,(IX+DPB_UNITNO)
000B59 DC52 060D             7      LD  B,00DH
000B5B DC54 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
000B5D DC56 0C               4      INC C
000B5E DC57 ED69            12      OUT (C),L
000B60 DC59 0C               4      INC C
000B61 DC5A ED61            12      OUT (C),H
000B63 DC5C 0C               4      INC C
000B64 DC5D EB               4      EX  DE,HL
000B65 DC5E D1              10      POP DE
000B66 DC5F F1              10      POP AF
000B67 DC60 A7               4      AND A   ;CF=0
000B68 DC61 C9              10      RET
                                
                                
[EOF:X1DISK2.ASM:SHIFT_JIS]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       DC62                     BDOS0:
000B69 DC62 E5              11      PUSH    HL
000B6A DC63 79               4      LD  A,C
000B6B DC64 FE3C             7      CP  03CH
000B6D DC66 3802            12      JR  C,DOS1
000B6F DC68 3E3C             7      LD  A,03CH
       DC6A                     DOS1:
000B71 DC6A 87               4      ADD A,A
000B72 DC6B 326FDC          13      LD  (DOS1_SWC),A
000B75 DC6E 2A00EF          16      LD  HL,(STABLE)
       DC6F                     DOS1_SWC    EQU $-2
000B78 DC71 E3              19      EX  (SP),HL
000B79 DC72 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
000B7A DC73 C9              10      RET
       DC74                     _DOS2:
000B7B DC74 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000B7D DC76 CA0EDF          10      JP  Z,_SYS5A
000B80 DC79 FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000B82 DC7B CACBDE          10      JP  Z,_SYS5C
000B85 DC7E FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
000B87 DC80 CAF6EB          10      JP  Z,_SYS5F
000B8A DC83 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000B8C DC85 200A            12      JR  NZ,_ERROR
000B8E DC87 011D01          10      LD  BC,VER_6F
000B91 DC8A 116101          10      LD  DE,VER
000B94 DC8D 210000          10      LD  HL,MACD
       DC90                     C_REM:
000B97 DC90 AF               4      XOR A
       DC91                     _ERROR:
000B98 DC91 A7               4      AND A
000B99 DC92 C9              10      RET
                                
       DC93                     _SYS09:     ;文字列出力
000B9A DC93 D5              11      PUSH    DE
       DC94                     _SX09:
000B9B DC94 1A               7      LD  A,(DE)
000B9C DC95 13               6      INC DE
000B9D DC96 FE24             7      CP  '$'
000B9F DC98 2831            12      JR  Z,SX0E2
000BA1 DC9A CDC0DF          17      CALL    MSG_A
000BA4 DC9D 18F5            12      JR  _SX09
                                
       DC9F                     MSX1:
000BA6 DC9F CDC0DF          17      CALL    MSG_A
       DCA2                     MSX:
000BA9 DCA2 7E               7      LD  A,(HL)
000BAA DCA3 23               6      INC HL
000BAB DCA4 B7               4      OR  A
000BAC DCA5 20F8            12      JR  NZ,MSX1
000BAE DCA7 C9              10      RET
                                
       DCA8                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000BAF DCA8 212200          10      LD  HL,00022H
000BB2 DCAB 7D               4      LD  A,L
000BB3 DCAC C9              10      RET
                                
       DCAD                     _SYS0D:     ;(BDOS)ディスクリセット
000BB4 DCAD CDDFEE          17      CALL    _FFLUSH
000BB7 DCB0 E5              11      PUSH    HL
000BB8 DCB1 218000          10      LD  HL,00080H
000BBB DCB4 228AEE          16      LD  (_DTA),HL
000BBE DCB7 E1              10      POP HL
000BBF DCB8 D5              11      PUSH    DE
000BC0 DCB9 1E00             7      LD  E,0
000BC2 DCBB 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       DCBC                     _SYS0E:     ;(BDOS)カレントドライブの設定
000BC3 DCBC D5              11      PUSH    DE
000BC4 DCBD 7B               4      LD  A,E
000BC5 DCBE DDE5            15      PUSH    IX
000BC7 DCC0 CDDCEE          17      CALL    _GETDPB
000BCA DCC3 DDE1            14      POP IX
000BCC DCC5 3804            12      JR  C,SX0E2
000BCE DCC7 7B               4      LD  A,E
000BCF DCC8 320400          13      LD  (_DVSW),A
       DCCB                     SX0E2:
000BD2 DCCB D1              10      POP DE
000BD3 DCCC C9              10      RET
                                
       DCCD                     _SYS0F:     ;(BDOS)ファイルのオープン
000BD4 DCCD CDF3F0          17      CALL    SETDRV
000BD7 DCD0 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000BDA DCD3 C602             7      ADD A,002H      ;Write
000BDC DCD5 2848            12      JR  Z,FEND0F
000BDE DCD7 CD42F4          17      CALL    CHKWILDX
                                
000BE1 DCDA D41DF1          17      CALL    NC,SOPENX
       DCDD                     _S16XX:
000BE4 DCDD 3840            12      JR  C,FEND0F
                                                ;Directory location
000BE6 DCDF 3A9FEE          13      LD  A,(_FILEN)
000BE9 DCE2 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
000BEC DCE5 3AA0EE          13      LD  A,(_DIRF)
000BEF DCE8 FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
000BF2 DCEB FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
000BF5 DCEE FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
000BF8 DCF1 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
000BFC DCF5 FDE5            15      PUSH    IY
000BFE DCF7 D1              10      POP DE
000BFF DCF8 13               6      INC DE
000C00 DCF9 010B00          10      LD  BC,11
000C03 DCFC EDB0                    LDIR
                                ;               Attribute
000C05 DCFE 7E               7      LD  A,(HL)
000C06 DCFF FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
000C09 DD02 110B00          10      LD  DE,11       ;Reserved
000C0C DD05 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
000C0D DD06 11E4EF          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
000C10 DD09 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DD0B                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
000C12 DD0B 1A               7      LD  A,(DE)
000C13 DD0C 13               6      INC DE
000C14 DD0D 3214DD          13      LD  (S16PAT),A
000C17 DD10 7E               7      LD  A,(HL)
000C18 DD11 23               6      INC HL
000C19 DD12 FD7700          19      LD  (IY+0),A
       DD14                     S16PAT  EQU $-1
000C1C DD15 10F4            13      DJNZ    S16LOOP
                                
000C1E DD17 AF               4      XOR A
000C1F DD18 FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
000C22 DD1B FD22BCDD        20      LD  (OFCB_SWC),IY
       DD1F                     FEND0F:
000C26 DD1F 1845            12      JR  FEND10
                                
       DD21                     _SYS10:     ;(BDOS)ファイルのクローズ
000C28 DD21 CDF3F0          17      CALL    SETDRV
000C2B DD24 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000C2E DD27 D6FE             7      SUB 0FEH
000C30 DD29 37               4      SCF
000C31 DD2A 3F               4      CCF
000C32 DD2B 2039            12      JR  NZ,FEND10
       DD2D                     _S10A:              ;Write
000C34 DD2D FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000C37 DD30 FD770F          19      LD  (IY+15),A
                                
000C3A DD33 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
000C3D DD36 CD3EF5          17      CALL    SETTMS
                                
000C40 DD39 FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000C43 DD3C 32A0EE          13      LD  (_DIRF),A
000C46 DD3F E67F             7      AND 07FH
000C48 DD41 3218E9          13      LD  (_SECPS),A
000C4B DD44 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000C4E DD47 FD561F          19      LD  D,(IY+31)
000C51 DD4A CD51F2          17      CALL    READ_DIR
000C54 DD4D 3817            12      JR  C,FEND10
                                
000C56 DD4F 3A7DF1          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000C59 DD52 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000C5A DD53 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000C5D DD56 6F               4      LD  L,A
000C5E DD57 2600             7      LD  H,0
000C60 DD59 29              11      ADD HL,HL       ;*2
000C61 DD5A 29              11      ADD HL,HL       ;*4
000C62 DD5B 29              11      ADD HL,HL       ;*8
000C63 DD5C 29              11      ADD HL,HL       ;*16
000C64 DD5D 29              11      ADD HL,HL       ;*32
000C65 DD5E ED4B7EEF        20      LD  BC,(_DTBUF)
000C69 DD62 09              11      ADD HL,BC
                                
000C6A DD63 CD52F4          17      CALL    SDIRENT
       DD66                     FEND10:
000C6D DD66 1842            12      JR  FEND
                                
       DD68                     _SYS11:     ;(BDOS)最初のファイルの検索
000C6F DD68 CDF3F0          17      CALL    SETDRV
000C72 DD6B CD4CF1          17      CALL    SOPEN
       DD6E                     _S12X1:
000C75 DD6E 383A            12      JR  C,FEND
000C77 DD70 CDEBF1          17      CALL    SOPENE2
000C7A DD73 ED5B8AEE        20      LD  DE,(_DTA)
000C7E DD77 3A88EE          13      LD  A,(_DRV)
000C81 DD7A 3C               4      INC A
000C82 DD7B 12               7      LD  (DE),A
000C83 DD7C D5              11      PUSH    DE
000C84 DD7D 13               6      INC DE
000C85 DD7E 012000          10      LD  BC,32
000C88 DD81 EDB0                    LDIR
000C8A DD83 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000C8D DD86 FD660F          19      LD  H,(IY+15)
000C90 DD89 22F4EF          16      LD  (SCDIR),HL
000C93 DD8C 2A9AEE          16      LD  HL,(_FBPS)
000C96 DD8F 22F6EF          16      LD  (SFBPS),HL
000C99 DD92 2A9FEE          16      LD  HL,(_FILEN)
000C9C DD95 7C               4      LD  A,H
000C9D DD96 B7               4      OR  A
000C9E DD97 2806            12      JR  Z,_S12DIR
000CA0 DD99 3A18E9          13      LD  A,(_SECPS)
000CA3 DD9C F680             7      OR  080H
000CA5 DD9E 67               4      LD  H,A
       DD9F                     _S12DIR:
000CA6 DD9F 22F8EF          16      LD  (SFNDF),HL  ;Directory position and Flags
000CA9 DDA2 E1              10      POP HL
000CAA DDA3 1139EE          10      LD  DE,SFILE
000CAD DDA6 0E21             7      LD  C,33
       DDA8                     _S11B:
000CAF DDA8 EDB0                    LDIR
       DDAA                     FEND:
000CB1 DDAA 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       DDAB                     FENDE:
000CB2 DDAB FDE1            14      POP IY
000CB4 DDAD C1              10      POP BC
000CB5 DDAE D1              10      POP DE
000CB6 DDAF E1              10      POP HL
000CB7 DDB0 C9              10      RET
                                
       DDB1                     _SYS12:     ;(BDOS)次のファイルの検索
000CB8 DDB1 E5              11      PUSH    HL
000CB9 DDB2 D5              11      PUSH    DE
000CBA DDB3 C5              11      PUSH    BC
000CBB DDB4 FDE5            15      PUSH    IY
000CBD DDB6 CDB0F1          17      CALL    NOPEN
000CC0 DDB9 18B3            12      JR  _S12X1
                                
       DDBB                     _S16K:
000CC2 DDBB 110000          10      LD  DE,0
       DDBC                     OFCB_SWC    EQU $-2
000CC5 DDBE D5              11      PUSH    DE
000CC6 DDBF 061A             7      LD  B,26        ;First cluster
       DDC1                     S16K1:
000CC8 DDC1 13               6      INC DE
000CC9 DDC2 23               6      INC HL
000CCA DDC3 10FC            13      DJNZ    S16K1
                                
000CCC DDC5 1A               7      LD  A,(DE)
000CCD DDC6 BE               7      CP  (HL)
000CCE DDC7 2015            12      JR  NZ,S16K2
000CD0 DDC9 13               6      INC DE
000CD1 DDCA 23               6      INC HL
000CD2 DDCB 1A               7      LD  A,(DE)
000CD3 DDCC BE               7      CP  (HL)
000CD4 DDCD 200F            12      JR  NZ,S16K2
                                
000CD6 DDCF E1              10      POP HL
000CD7 DDD0 FDE5            15      PUSH    IY
000CD9 DDD2 D1              10      POP DE
000CDA DDD3 7E               7      LD  A,(HL)
000CDB DDD4 CD08F1          17      CALL    IS_SAME_DRV_A_DE
000CDE DDD7 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000CE0 DDD9 ED52            15      SBC HL,DE       ;CP HL,DE
000CE2 DDDB 37               4      SCF
000CE3 DDDC C0              11      RET NZ
000CE4 DDDD E5              11      PUSH    HL
       DDDE                     S16K2:
000CE5 DDDE E1              10      POP HL
       DDDF                     S16K3:
000CE6 DDDF FDE5            15      PUSH    IY
000CE8 DDE1 D1              10      POP DE
       DDE2                     _SYS13:     ;(BDOS)ファイルの削除
000CE9 DDE2 CDF3F0          17      CALL    SETDRV
000CEC DDE5 CD7AF3          17      CALL    KILL
       DDE8                     FEND13:
000CEF DDE8 18C0            12      JR  FEND
                                
       DDEA                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
000CF1 DDEA CDF3F0          17      CALL    SETDRV
000CF4 DDED CD6BE7          17      CALL    INIT_SEQ
       DDF0                     SREAD:
000CF7 DDF0 CD3DE7          17      CALL    RB_READ
                                
000CFA DDF3 C601             7      ADD A,001H
000CFC DDF5 38B3            12      JR  C,FEND
                                
000CFE DDF7 7D               4      LD  A,L
000CFF DDF8 D601             7      SUB 001H
       DDFA                     FENDX:
000D01 DDFA 9F               4      SBC A,A
000D02 DDFB E603             7      AND 3
000D04 DDFD 1F               4      RRA
000D05 DDFE 18AB            12      JR  FENDE
                                
       DE00                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
000D07 DE00 CDF3F0          17      CALL    SETDRV
000D0A DE03 CD6BE7          17      CALL    INIT_SEQ
       DE06                     SWRITE:
000D0D DE06 CD38E7          17      CALL    RB_WRITE
                                
000D10 DE09 C6FF             7      ADD A,0FFH
000D12 DE0B 18ED            12      JR  FENDX
                                
       DE0D                     _SYS17:     ;(BDOS)ファイル名の変更
000D14 DE0D CDF3F0          17      CALL    SETDRV
000D17 DE10 CDD0F3          17      CALL    NAME
000D1A DE13 18D3            12      JR  FEND13
                                
       DE15                     _SYS16:     ;(BDOS)ファイルの作成
000D1C DE15 CDF3F0          17      CALL    SETDRV
                                
000D1F DE18 CD42F4          17      CALL    CHKWILDX
000D22 DE1B 38CB            12      JR  C,FEND13
000D24 DE1D FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
000D27 DE20 FE05             7      CP  5
000D29 DE22 2805            12      JR  Z,_S16X2
000D2B DE24 FE21             7      CP  021H
000D2D DE26 DAE8DD          10      JP  C,FEND13
       DE29                     _S16X2:
                                ;               Clear FCB
000D30 DE29 FDE5            15      PUSH    IY
000D32 DE2B E1              10      POP HL
000D33 DE2C 011000          10      LD  BC,16
000D36 DE2F 09              11      ADD HL,BC
       DE30                     _S16X1:
000D37 DE30 70               7      LD  (HL),B      ;B=0
000D38 DE31 23               6      INC HL
000D39 DE32 0D               4      DEC C
000D3A DE33 20FB            12      JR  NZ,_S16X1
                                
000D3C DE35 CD43F5          17      CALL    SETTMSX
000D3F DE38 FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000D43 DE3C CD1DF1          17      CALL    SOPENX
000D46 DE3F 3F               4      CCF
000D47 DE40 CCBBDD          17      CALL    Z,_S16K
000D4A DE43 D4FCF1          17      CALL    NC,COPEN
000D4D DE46 D452F4          17      CALL    NC,SDIRENT
000D50 DE49 C3DDDC          10      JP  _S16XX
                                
       DE4C                     _SYS21:     ;(BDOS)ランダムな読み出し
000D53 DE4C CDF3F0          17      CALL    SETDRV
000D56 DE4F CD8EF5          17      CALL    INIT_RND
000D59 DE52 189C            12      JR  SREAD
                                
       DE54                     _SYS22:     ;(BDOS)ランダムな書き込み
       DE54                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000D5B DE54 CDF3F0          17      CALL    SETDRV
000D5E DE57 CD8EF5          17      CALL    INIT_RND
000D61 DE5A 18AA            12      JR  SWRITE
                                
       DE5C                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000D63 DE5C 21FF00          10      LD  HL,000FFH
000D66 DE5F AF               4      XOR A
000D67 DE60 C9              10      RET
                                
       DE61                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000D68 DE61 3A0400          13      LD  A,(_DVSW)   ;from LDOS
000D6B DE64 A7               4      AND A
000D6C DE65 C9              10      RET
                                
       DE66                     _SYS1A:     ;(BDOS)DTAの設定
000D6D DE66 ED538AEE        20      LD  (_DTA),DE
000D71 DE6A AF               4      XOR A
000D72 DE6B C9              10      RET
                                
       DE6C                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000D73 DE6C 7B               4      LD  A,E
000D74 DE6D CD01F1          17      CALL    GETDRV
000D77 DE70 CDDCEE          17      CALL    _GETDPB
000D7A DE73 D4E2EE          17      CALL    NC,_RDFATX
000D7D DE76 210000          10      LD  HL,0
000D80 DE79 D41CF5          17      CALL    NC,DSKF
                                
000D83 DE7C ED5B1DF5        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000D87 DE80 1B               6      DEC DE      ;DE←クラスタの総数
000D88 DE81 FD2A7CEF        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000D8C DE85 9F               4      SBC A,A
000D8D DE86 D8              11      RET C
000D8E DE87 4F               4      LD  C,A     ;C=0
000D8F DE88 DD7E0F          19      LD  A,(IX+DPB_BPS)
000D92 DE8B E607             7      AND 7
000D94 DE8D 47               4      LD  B,A
000D95 DE8E DD7E07          19      LD  A,(IX+DPB_SECPCL)
000D98 DE91 C9              10      RET
                                
       DE92                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000D99 DE92 AF               4      XOR A
000D9A DE93 67               4      LD  H,A
000D9B DE94 6F               4      LD  L,A
000D9C DE95 C9              10      RET
                                
       DE96                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000D9D DE96 2100F6          10      LD  HL,_DEVICE
000DA0 DE99 7B               4      LD  A,E
000DA1 DE9A C3DCEE          10      JP  _GETDPB
                                
       DE9D                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000DA4 DE9D E5              11      PUSH    HL
000DA5 DE9E 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000DA7 DEA0 CD62DC          17      CALL    BDOS0
000DAA DEA3 381B            12      JR  C,_S23X1
                                
000DAC DEA5 D5              11      PUSH    DE      ;EX DE,IY
000DAD DEA6 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000DAF DEA8 FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000DB2 DEAB FD6E11          19      LD  L,(IY+17)   ;
000DB5 DEAE FD6612          19      LD  H,(IY+18)   ;
000DB8 DEB1 C5              11      PUSH    BC      ;
000DB9 DEB2 FD4613          19      LD  B,(IY+19)   ;
000DBC DEB5 CD80F5          17      CALL    GET_CPM_R_SIZE
000DBF DEB8 C1              10      POP BC
       DEB9                     _S24X1:
000DC0 DEB9 CDA0F5          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000DC3 DEBC FDE3            23      EX  (SP),IY     ;
000DC5 DEBE D1              10      POP DE      ;
                                
000DC6 DEBF AF               4      XOR A
       DEC0                     _S23X1:
000DC7 DEC0 E1              10      POP HL
000DC8 DEC1 C9              10      RET
                                
       DEC2                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000DC9 DEC2 E5              11      PUSH    HL
000DCA DEC3 D5              11      PUSH    DE      ;EX DE,IY
000DCB DEC4 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000DCD DEC6 CD73E7          17      CALL    GETSEQ
000DD0 DEC9 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       DECB                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000DD2 DECB 2B               6      DEC HL
       DECC                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000DD3 DECC C5              11      PUSH    BC
000DD4 DECD E5              11      PUSH    HL
000DD5 DECE CD0BF0          17      CALL    FILE
000DD8 DED1 E1              10      POP HL
000DD9 DED2 C1              10      POP BC
       DED3                     S29X1:
000DDA DED3 C5              11      PUSH    BC
000DDB DED4 D5              11      PUSH    DE
000DDC DED5 E5              11      PUSH    HL
000DDD DED6 EB               4      EX  DE,HL
000DDE DED7 AF               4      XOR A
000DDF DED8 3221EE          13      LD  (FDRV+13),A
000DE2 DEDB 2114EE          10      LD  HL,FDRV
000DE5 DEDE 011000          10      LD  BC,16
000DE8 DEE1 EDB0                    LDIR
000DEA DEE3 E1              10      POP HL
000DEB DEE4 D1              10      POP DE
000DEC DEE5 C1              10      POP BC
000DED DEE6 C9              10      RET
                                
       DEE7                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
000DEE DEE7 C5              11      PUSH    BC
000DEF DEE8 01B7EA          10      LD  BC,DWT24B
000DF2 DEEB 1804            12      JR  S2FX
       DEED                     _SYS2F:
000DF4 DEED C5              11      PUSH    BC
000DF5 DEEE 01A9EA          10      LD  BC,DRD24B
       DEF1                     S2FX:
000DF8 DEF1 ED4307DF        20      LD  (S2F_SWC),BC
000DFC DEF5 CDDFEE          17      CALL    _FFLUSH
                                
000DFF DEF8 D5              11      PUSH    DE
000E00 DEF9 E5              11      PUSH    HL
000E01 DEFA 7D               4      LD  A,L     ;Drive
000E02 DEFB CDD9EE          17      CALL    _CHGDRV
000E05 DEFE 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
000E07 DF00 44               4      LD  B,H     ;Number of clusters
000E08 DF01 2A8AEE          16      LD  HL,(_DTA)
                                
000E0B DF04 0E00             7      LD  C,0
000E0D DF06 CDA9EA          17      CALL    DRD24B
       DF07                     S2F_SWC EQU $-2
       DF09                     POP_HL_DE_BC_SBCAA_RET:
000E10 DF09 E1              10      POP HL
000E11 DF0A D1              10      POP DE
000E12 DF0B C1              10      POP BC
000E13 DF0C 9F               4      SBC A,A
000E14 DF0D C9              10      RET
                                
       DF0E                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
000E15 DF0E C5              11      PUSH    BC
000E16 DF0F D5              11      PUSH    DE
000E17 DF10 E5              11      PUSH    HL
000E18 DF11 CD00F0          17      CALL    FILEC
000E1B DF14 2109DF          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
000E1E DF17 E5              11      PUSH    HL
000E1F DF18 3A21EE          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
000E22 DF1B E610             7      AND 010H        ;ディレクトリ
000E24 DF1D 37               4      SCF
000E25 DF1E C8              11      RET Z
000E26 DF1F 1114EE          10      LD  DE,FDRV
000E29 DF22 2A4EEF          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       DF25                     JPHL:
000E2C DF25 E9               4      JP  (HL)
                                
       DF26                     SHOW_ERROR:         ;(9)
000E2D DF26 1179EE          10      LD  DE,COMERM
000E30 DF29 CD93DC          17      CALL    _SYS09      ;(BDOS)文字列出力
000E33 DF2C C300EE          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "X1IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   X1/turbo/Z
                                
       DC91                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       DC91                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       DC91                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       DC91                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       DC91                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       DC91                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       DF2F                     BIOS:
000E36 DF2F E5              11      PUSH    HL
000E37 DF30 211080          10      LD  HL,08010H
000E3A DF33 39              11      ADD HL,SP
000E3B DF34 E1              10      POP HL
000E3C DF35 300E            12      JR  NC,BIOS2
       DF37                     BIOS1:
000E3E DF37 CD3FDF          17      CALL    BIOS3
000E41 DF3A 061E             7      LD  B,01EH
000E43 DF3C ED79            12      OUT (C),A
000E45 DF3E C9              10      RET
       DF3F                     BIOS3:
000E46 DF3F C5              11      PUSH    BC
000E47 DF40 061D             7      LD  B,01DH
000E49 DF42 ED79            12      OUT (C),A
000E4B DF44 C9              10      RET
       DF45                     BIOS2:
000E4C DF45 ED7350DF        20      LD  (BIOS_SP),SP    ;スタックがBIOS-ROMと被っている場合
000E50 DF49 31CAFF          10      LD  SP,EXTSP
000E53 DF4C CD37DF          17      CALL    BIOS1
000E56 DF4F 310000          10      LD  SP,0
       DF50                     BIOS_SP EQU $-2
000E59 DF52 C9              10      RET
                                
       DF53                     INT:
000E5A DF53 F5              11      PUSH    AF
000E5B DF54 E5              11      PUSH    HL
000E5C DF55 C5              11      PUSH    BC
                                
000E5D DF56 CDF7E2          17      CALL    IN49SB
000E60 DF59 67               4      LD  H,A
000E61 DF5A CDF7E2          17      CALL    IN49SB
000E64 DF5D 6F               4      LD  L,A
000E65 DF5E B7               4      OR  A
000E66 DF5F 2810            12      JR  Z,SCEXE
000E68 DF61 CB6C             8      BIT 5,H
000E6A DF63 200C            12      JR  NZ,SCEXE
000E6C DF65 3A93EE          13      LD  A,(_KEYST)
000E6F DF68 47               4      LD  B,A
000E70 DF69 AC               4      XOR H
000E71 DF6A E603             7      AND 3       ;SHIFT,CTRL
000E73 DF6C 2803            12      JR  Z,SCEXE
000E75 DF6E 60               4      LD  H,B
000E76 DF6F 2E00             7      LD  L,0
       DF71                     SCEXE:
000E78 DF71 2292EE          16      LD  (_KEYD),HL
000E7B DF74 CD7DDF          17      CALL    KEYSET1
000E7E DF77 C1              10      POP BC
       DF78                     INTPE:
000E7F DF78 E1              10      POP HL
       DF79                     INTPE2:
000E80 DF79 F1              10      POP AF
       DF7A                     INTCTCE:
000E81 DF7A FB               4      EI
000E82 DF7B ED4D            15      RETI
                                
       DF7D                     KEYSET1:
000E84 DF7D F5              11      PUSH    AF
000E85 DF7E AF               4      XOR A
000E86 DF7F 321AE0          13      LD  (FLGET_SWC),A
000E89 DF82 F1              10      POP AF
000E8A DF83 B7               4      OR  A
000E8B DF84 C8              11      RET Z
                                
000E8C DF85 CB6C             8      BIT 5,H
000E8E DF87 2806            12      JR  Z,KEYSET
000E90 DF89 3A95EE          13      LD  A,(_KEYSP_H)
000E93 DF8C 322FE0          13      LD  (KEYREPEAT_SWC),A
       DF8F                     KEYSET:
000E96 DF8F 7D               4      LD  A,L
000E97 DF90 CB74             8      BIT 6,H
000E99 DF92 C0              11      RET NZ
       DF93                     KEYBS:
000E9A DF93 B7               4      OR  A
000E9B DF94 C8              11      RET Z
       DF95                     KEYBS1:
000E9C DF95 CDADDF          17      CALL    KEYBC_IFBREAK
000E9F DF98 E5              11      PUSH    HL
000EA0 DF99 F5              11      PUSH    AF
000EA1 DF9A 2A90EE          16      LD  HL,(_KEYPS)
000EA4 DF9D 2C               4      INC L
000EA5 DF9E CBAD             8      RES 5,L
000EA7 DFA0 7D               4      LD  A,L
000EA8 DFA1 BC               4      CP  H
000EA9 DFA2 2815            12      JR  Z,POP_AF_HL_SCF_RET
000EAB DFA4 3290EE          13      LD  (_KEYPS),A
000EAE DFA7 26FF             7      LD  H,KEYBF/256
000EB0 DFA9 F1              10      POP AF
000EB1 DFAA 77               7      LD  (HL),A
000EB2 DFAB E1              10      POP HL
000EB3 DFAC C9              10      RET
       DFAD                     KEYBC_IFBREAK:
000EB4 DFAD FE03             7      CP  3
000EB6 DFAF C0              11      RET NZ
       DFB0                     KEYBC:
000EB7 DFB0 E5              11      PUSH    HL
000EB8 DFB1 210000          10      LD  HL,0
000EBB DFB4 2290EE          16      LD  (_KEYPS),HL
000EBE DFB7 E1              10      POP HL
000EBF DFB8 C9              10      RET
                                
       DFB9                     POP_AF_HL_SCF_RET:
000EC0 DFB9 F1              10      POP AF
000EC1 DFBA E1              10      POP HL
000EC2 DFBB 37               4      SCF
000EC3 DFBC C9              10      RET
                                
       DFBD                     _SYS01:     ;(BDOS)コンソール入力
000EC4 DFBD CD09EE          17      CALL    _SYS07
       DFC0                     MSG_A:
000EC7 DFC0 F5              11      PUSH    AF
000EC8 DFC1 D5              11      PUSH    DE
000EC9 DFC2 5F               4      LD  E,A
000ECA DFC3 CDC9DF          17      CALL    _SYS02
000ECD DFC6 D1              10      POP DE
000ECE DFC7 F1              10      POP AF
000ECF DFC8 C9              10      RET
                                
       DFC9                     _SYS02:     ;(BDOS)コンソール出力
000ED0 DFC9 CDDBDF          17      CALL    BREAK
000ED3 DFCC 1805            12      JR  PRINTX
                                
       DFCE                     _SYS06:     ;(BDOS)コンソール直接入出力
000ED5 DFCE 7B               4      LD  A,E
000ED6 DFCF 3C               4      INC A
000ED7 DFD0 CACAEE          10      JP  Z,_INKEY
       DFD3                     PRINTX:
000EDA DFD3 C3CDEE          10      JP  _PRINT
                                
       DFD6                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000EDD DFD6 CD09EE          17      CALL    _SYS07
000EE0 DFD9 1804            12      JR  BREAK1
       DFDB                     BREAK:
000EE2 DFDB FB               4      EI
000EE3 DFDC 3A92EE          13      LD  A,(_KEYD)
       DFDF                     BREAK1:
000EE6 DFDF FE03             7      CP  3       ;CTRL+C
000EE8 DFE1 CCF4EE          17      CALL    Z,_BREAK
000EEB DFE4 FE13             7      CP  013H        ;CTRL+S
000EED DFE6 C0              11      RET NZ
                                
       DFE7                     PAUSE:
000EEE DFE7 CDB0DF          17      CALL    KEYBC
                                
       DFEA                     FLGET:
000EF1 DFEA CDDFEE          17      CALL    _FFLUSH
000EF4 DFED C5              11      PUSH    BC
000EF5 DFEE E5              11      PUSH    HL
000EF6 DFEF ED4B8EEE        20      LD  BC,(_TXADR)
000EFA DFF3 CBE8             8      SET 5,B
000EFC DFF5 ED60            12      IN  H,(C)
       DFF7                     FLGET1:
000EFE DFF7 3A93EE          13      LD  A,(_KEYST)
000F01 DFFA 0F               4      RRCA
000F02 DFFB 0F               4      RRCA
000F03 DFFC E610             7      AND 010H
000F05 DFFE F608             7      OR  8
000F07 E000 ED68            12      IN  L,(C)
000F09 E002 B5               4      OR  L
000F0A E003 ED79            12      OUT (C),A
       E005                     FLGETR:
000F0C E005 CDCAEE          17      CALL    _INKEY
000F0F E008 2032            12      JR  NZ,FLGETE
000F11 E00A CB5D             8      BIT 3,L
000F13 E00C 28E9            12      JR  Z,FLGET1
000F15 E00E 3A92EE          13      LD  A,(_KEYD)
000F18 E011 B7               4      OR  A
000F19 E012 28E3            12      JR  Z,FLGET1
                                
000F1B E014 3E1A             7      LD  A,01AH
000F1D E016 321AE0          13      LD  (FLGET_SWC),A
       E019                     FLGET2:
000F20 E019 3E1A             7      LD  A,1AH
       E01A                     FLGET_SWC   EQU $-1
000F22 E01B B7               4      OR  A
000F23 E01C 28E7            12      JR  Z,FLGETR
000F25 E01E DB01            11      IN  A,(01H)
000F27 E020 87               4      ADD A,A
000F28 E021 30F6            12      JR  NC,FLGET2
       E023                     FLGET3:
000F2A E023 3A1AE0          13      LD  A,(FLGET_SWC)
000F2D E026 B7               4      OR  A
000F2E E027 28DC            12      JR  Z,FLGETR
000F30 E029 DB01            11      IN  A,(01H)
000F32 E02B 87               4      ADD A,A
000F33 E02C 38F5            12      JR  C,FLGET3
                                
000F35 E02E 3E00             7      LD  A,0
       E02F                     KEYREPEAT_SWC   EQU $-1
000F37 E030 B7               4      OR  A
000F38 E031 2806            12      JR  Z,FLGET4
000F3A E033 3D               4      DEC A
000F3B E034 322FE0          13      LD  (KEYREPEAT_SWC),A
000F3E E037 18E0            12      JR  FLGET2
       E039                     FLGET4:
000F40 E039 3A92EE          13      LD  A,(_KEYD)
       E03C                     FLGETE:
000F43 E03C ED61            12      OUT (C),H
000F45 E03E E1              10      POP HL
000F46 E03F C1              10      POP BC
000F47 E040 C9              10      RET
                                
       E041                     _SYS0A:     ;(BDOS)文字列入力
000F48 E041 C5              11      PUSH    BC
000F49 E042 E5              11      PUSH    HL
000F4A E043 D5              11      PUSH    DE
000F4B E044 CD44E4          17      CALL    GETL
000F4E E047 1120FF          10      LD  DE,KBUF
000F51 E04A E1              10      POP HL
000F52 E04B E5              11      PUSH    HL
000F53 E04C 0E00             7      LD  C,0
000F55 E04E 3004            12      JR  NC,SAX0
000F57 E050 23               6      INC HL
000F58 E051 23               6      INC HL
000F59 E052 1808            12      JR  SAX4
       E054                     SAX0:
000F5B E054 46               7      LD  B,(HL)
000F5C E055 23               6      INC HL
       E056                     SAX1:
000F5D E056 23               6      INC HL
000F5E E057 1A               7      LD  A,(DE)
000F5F E058 13               6      INC DE
000F60 E059 B7               4      OR  A
000F61 E05A 2004            12      JR  NZ,SAX2
       E05C                     SAX4:
000F63 E05C 360D            10      LD  (HL),00DH
000F65 E05E 1804            12      JR  SAX3
       E060                     SAX2:
000F67 E060 77               7      LD  (HL),A
000F68 E061 0C               4      INC C
000F69 E062 10F2            13      DJNZ    SAX1
       E064                     SAX3:
000F6B E064 D1              10      POP DE
000F6C E065 79               4      LD  A,C
000F6D E066 13               6      INC DE
000F6E E067 12               7      LD  (DE),A
000F6F E068 1B               6      DEC DE
000F70 E069 E1              10      POP HL
000F71 E06A C1              10      POP BC
000F72 E06B A7               4      AND A
000F73 E06C C9              10      RET
                                
       E06D                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000F74 E06D CDDBDF          17      CALL    BREAK
000F77 E070 3A92EE          13      LD  A,(_KEYD)
000F7A E073 B7               4      OR  A
000F7B E074 C8              11      RET Z
       E075                     CONSTX:
000F7C E075 CDDFEE          17      CALL    _FFLUSH
000F7F E078 E5              11      PUSH    HL
000F80 E079 2A90EE          16      LD  HL,(_KEYPS)
000F83 E07C 7C               4      LD  A,H
000F84 E07D AD               4      XOR L
000F85 E07E E1              10      POP HL
000F86 E07F C6FF             7      ADD A,0FFH
000F88 E081 9F               4      SBC A,A
000F89 E082 C9              10      RET
                                
       E083                     _SYS2A:     ;(BDOS)日付の獲得
000F8A E083 C5              11      PUSH    BC
000F8B E084 3EED             7      LD  A,0EDH      ;Read calendar
000F8D E086 CD12E3          17      CALL    COMOUT
000F90 E089 CDBCE0          17      CALL    IN49SB_BCD  ;YY
000F93 E08C 6F               4      LD  L,A
000F94 E08D 2600             7      LD  H,0
                                ;   LD  DE,1900     ;0076CH
                                ;   CP  90      ;90以上は1900年代 1990-1999
                                ;   JR  NC,RDDATE1  ;90未満は2000年代 2000-2089
                                ;   LD  E,0D0H      ;2000 & 0FFH D=007H
000F96 E08F 11D007          10      LD  DE,2000     ;すべて2000年代で処理 2000-2099
       E092                     RDDATE1:
000F99 E092 19              11      ADD HL,DE
000F9A E093 CDF7E2          17      CALL    IN49SB      ;MW
000F9D E096 57               4      LD  D,A
000F9E E097 CDBCE0          17      CALL    IN49SB_BCD  ;DD
000FA1 E09A 5F               4      LD  E,A
000FA2 E09B 7A               4      LD  A,D
000FA3 E09C 0604             7      LD  B,4
       E09E                     RDDATE2:
000FA5 E09E CB3A             8      SRL D
000FA7 E0A0 10FC            13      DJNZ    RDDATE2
000FA9 E0A2 C1              10      POP BC
000FAA E0A3 E607             7      AND 7
000FAC E0A5 C9              10      RET
                                
       E0A6                     _SYS2C:     ;(BDOS)時刻の獲得
000FAD E0A6 C5              11      PUSH    BC
000FAE E0A7 3EEF             7      LD  A,0EFH      ;Read time
000FB0 E0A9 CD12E3          17      CALL    COMOUT
000FB3 E0AC CDBCE0          17      CALL    IN49SB_BCD  ;TT
000FB6 E0AF 67               4      LD  H,A
000FB7 E0B0 CDBCE0          17      CALL    IN49SB_BCD  ;MM
000FBA E0B3 6F               4      LD  L,A
000FBB E0B4 CDBCE0          17      CALL    IN49SB_BCD  ;SS
000FBE E0B7 57               4      LD  D,A
000FBF E0B8 C1              10      POP BC
000FC0 E0B9 AF               4      XOR A
000FC1 E0BA 5F               4      LD  E,A
000FC2 E0BB C9              10      RET
                                
       E0BC                     IN49SB_BCD:
000FC3 E0BC CDF7E2          17      CALL    IN49SB
                                ;------------------------
                                ;BCDの10進数化
                                ;in
                                ;   A  : BCD
                                ;out
                                ;   A  : 10進数
                                ;------------------------
000FC6 E0BF 4F               4      LD  C,A
000FC7 E0C0 E6F0             7      AND 0F0H    ;10の位
000FC9 E0C2 0F               4      RRCA
000FCA E0C3 47               4      LD  B,A
000FCB E0C4 0F               4      RRCA
000FCC E0C5 0F               4      RRCA
000FCD E0C6 80               4      ADD A,B
000FCE E0C7 47               4      LD  B,A
000FCF E0C8 79               4      LD  A,C
000FD0 E0C9 E60F             7      AND 00FH    ;1の位
000FD2 E0CB 80               4      ADD A,B
000FD3 E0CC C9              10      RET
                                
       E0CD                     ESC1:
000FD4 E0CD 7B               4      LD  A,E
000FD5 E0CE FE41             7      CP  'A'
000FD7 E0D0 CA15E2          10      JP  Z,CTRL1E
000FDA E0D3 FE42             7      CP  'B'
000FDC E0D5 CA7DE3          10      JP  Z,CTRL1F
000FDF E0D8 FE43             7      CP  'C'
000FE1 E0DA CA20E2          10      JP  Z,CTRL1C
000FE4 E0DD FE44             7      CP  'D'
000FE6 E0DF CA0CE2          10      JP  Z,CTRL1D
000FE9 E0E2 FE45             7      CP  'E'
000FEB E0E4 2802            12      JR  Z,CT0CX
000FED E0E6 FE6A             7      CP  'j'
       E0E8                     CT0CX:
000FEF E0E8 CA50E3          10      JP  Z,CTRL0C
000FF2 E0EB FE48             7      CP  'H'
000FF4 E0ED CA9AE2          10      JP  Z,CTRL0B
000FF7 E0F0 FE4A             7      CP  'J'
000FF9 E0F2 CA53E3          10      JP  Z,CTRL06
000FFC E0F5 FE4B             7      CP  'K'
000FFE E0F7 2807            12      JR  Z,CT05X
001000 E0F9 FE4C             7      CP  'L'
001002 E0FB CA92E3          10      JP  Z,CTRL0E
001005 E0FE FE54             7      CP  'T'
       E100                     CT05X:
001007 E100 CA59E2          10      JP  Z,CTRL05
00100A E103 FE78             7      CP  'x'
00100C E105 2804            12      JR  Z,ESC1X
00100E E107 FE79             7      CP  'y'
001010 E109 2002            12      JR  NZ,ESC1Y
       E10B                     ESC1X:
001012 E10B 3601            10      LD  (HL),1
       E10D                     ESC1Y:
001014 E10D FE3D             7      CP  '='
001016 E10F 2804            12      JR  Z,ESC1W
001018 E111 FE59             7      CP  'Y'
00101A E113 2002            12      JR  NZ,ESC1Z
       E115                     ESC1W:
00101C E115 3602            10      LD  (HL),2
       E117                     ESC1Z:
00101E E117 FE20             7      CP  020H
001020 E119 3802            12      JR  C,ESC1C
001022 E11B 87               4      ADD A,A
001023 E11C D0              11      RET NC
       E11D                     ESC1C:
001024 E11D E1              10      POP HL
       E11E                     ANK:
001025 E11E ED4B8EEE        20      LD  BC,(_TXADR)
001029 E122 78               4      LD  A,B
00102A E123 F638             7      OR  038H
00102C E125 47               4      LD  B,A
00102D E126 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令   kanji
00102F E128 CB98             8      RES 3,B
001031 E12A ED59            12      OUT (C),E       ;Text
       E12C                     KANJIE:
001033 E12C CDE1E1          17      CALL    PRINTE7
       E12F                     PRINTE5:
001036 E12F E1              10      POP HL
001037 E130 C1              10      POP BC
001038 E131 AF               4      XOR A
001039 E132 C9              10      RET
                                
       E133                     ESC:
00103A E133 212FE1          10      LD  HL,PRINTE5
00103D E136 E5              11      PUSH    HL
00103E E137 2159E1          10      LD  HL,ESCFLG+1
001041 E13A 3600            10      LD  (HL),0
001043 E13C 3D               4      DEC A
001044 E13D 288E            12      JR  Z,ESC1
001046 E13F 3D               4      DEC A
001047 E140 2009            12      JR  NZ,ESC2
001049 E142 3603            10      LD  (HL),3
00104B E144 7B               4      LD  A,E
00104C E145 D620             7      SUB 020H
00104E E147 324EE1          13      LD  (ESCYP+1),A
001051 E14A C9              10      RET
       E14B                     ESC2:
001052 E14B 3D               4      DEC A
001053 E14C C0              11      RET NZ
001054 E14D 2600             7  ESCYP:  LD  H,0
001056 E14F 7B               4      LD  A,E
001057 E150 D620             7      SUB 020H
001059 E152 6F               4      LD  L,A
00105A E153 C3D6EE          10      JP  _LOC
                                
       E156                     PRINT:
00105D E156 C5              11      PUSH    BC
00105E E157 E5              11      PUSH    HL
00105F E158 3E00             7  ESCFLG: LD  A,000H
001061 E15A B7               4      OR  A
001062 E15B 20D6            12      JR  NZ,ESC
                                
001064 E15D 3E1F             7      LD  A,01FH
001066 E15F BB               4      CP  E
001067 E160 3020            12      JR  NC,CTRL
001069 E162 011BE3          10  INSFLG: LD  BC,INSERT
                                
00106C E165 3A1800          13      LD  A,(00018H)
00106F E168 3C               4      INC A
001070 E169 28B3            12      JR  Z,ANK
001072 E16B 3E00             7  KANFLG: LD  A,000H
001074 E16D B7               4      OR  A
001075 E16E 2025            12      JR  NZ,KANJI2
001077 E170 7B               4      LD  A,E
001078 E171 FE80             7      CP  080H
00107A E173 38A9            12      JR  C,ANK
00107C E175 FEA0             7      CP  0A0H
00107E E177 3804            12      JR  C,KANJI1
001080 E179 FEE0             7      CP  0E0H
001082 E17B 38A1            12      JR  C,ANK
       E17D                     KANJI1:
001084 E17D 326CE1          13      LD  (KANFLG+1),A
001087 E180 18AD            12      JR  PRINTE5
                                
       E182                     CTRL:
001089 E182 CDC8E1          17      CALL    KANCLR
00108C E185 7B               4      LD  A,E
00108D E186 87               4      ADD A,A
00108E E187 F680             7      OR  080H
001090 E189 6F               4      LD  L,A
001091 E18A 26EF             7      LD  H,CTRLTB/256
001093 E18C 7E               7      LD  A,(HL)
001094 E18D 2C               4      INC L
001095 E18E 66               7      LD  H,(HL)
001096 E18F 6F               4      LD  L,A
001097 E190 CD25DF          17      CALL    JPHL
00109A E193 189A            12      JR  PRINTE5
                                
       E195                     KANJI2:
00109C E195 D5              11      PUSH    DE
00109D E196 57               4      LD  D,A
00109E E197 01812F          10      LD  BC,02F81H   ;SFTJIS
0010A1 E19A DF              12      RST 018H
0010A2 E19B 01C32F          10      LD  BC,02FC3H   ;Instead or JISVRM
0010A5 E19E DF              12      RST 018H
                                
0010A6 E19F ED4B8EEE        20      LD  BC,(_TXADR)
0010AA E1A3 78               4      LD  A,B
0010AB E1A4 F638             7      OR  038H
0010AD E1A6 47               4      LD  B,A
0010AE E1A7 ED51            12      OUT (C),D       ;kanji
0010B0 E1A9 CB98             8      RES 3,B
0010B2 E1AB ED59            12      OUT (C),E       ;Text
0010B4 E1AD CDE1E1          17      CALL    PRINTE7
0010B7 E1B0 ED4B8EEE        20      LD  BC,(_TXADR)
0010BB E1B4 78               4      LD  A,B
0010BC E1B5 F638             7      OR  038H
0010BE E1B7 47               4      LD  B,A
0010BF E1B8 CBF2             8      SET 6,D
0010C1 E1BA ED51            12      OUT (C),D       ;Kanji
0010C3 E1BC CB98             8      RES 3,B
0010C5 E1BE ED59            12      OUT (C),E       ;Text
0010C7 E1C0 D1              10      POP DE
0010C8 E1C1 AF               4      XOR A
0010C9 E1C2 326CE1          13      LD  (KANFLG+1),A
0010CC E1C5 C32CE1          10      JP  KANJIE
                                
       E1C8                     KANCLR:
0010CF E1C8 3A6CE1          13      LD  A,(KANFLG+1)
0010D2 E1CB B7               4      OR  A
0010D3 E1CC C8              11      RET Z
0010D4 E1CD ED4B8EEE        20      LD  BC,(_TXADR)
0010D8 E1D1 78               4      LD  A,B
0010D9 E1D2 F638             7      OR  038H
0010DB E1D4 47               4      LD  B,A
0010DC E1D5 AF               4      XOR A
0010DD E1D6 326CE1          13      LD  (KANFLG+1),A
0010E0 E1D9 ED79            12      OUT (C),A       ;Kanji
0010E2 E1DB CB98             8      RES 3,B
0010E4 E1DD 3E20             7      LD  A,020H
0010E6 E1DF ED79            12      OUT (C),A       ;Text
       E1E1                     PRINTE7:
0010E8 E1E1 CBA0             8      RES 4,B
       E1E3                     PRINTE6:
0010EA E1E3 3A96EE          13      LD  A,(_COLORF)
       E1E6                     PRINTE4:
0010ED E1E6 ED79            12      OUT (C),A       ;Color
0010EF E1E8 78               4      LD  A,B
0010F0 E1E9 E607             7      AND 7
0010F2 E1EB 47               4      LD  B,A
       E1EC                     PRINTE2:
0010F3 E1EC 03               6      INC BC
       E1ED                     PRINTE3:
0010F4 E1ED 2ABAEE          16      LD  HL,(_PAGE_MINUS)
0010F7 E1F0 A7               4      AND A
0010F8 E1F1 ED4A            15      ADC HL,BC
       E1F3                     PRINTE8:
0010FA E1F3 2805            12      JR  Z,PRINT2
0010FC E1F5 ED438EEE        20      LD  (_TXADR),BC
       E1F9                     CTRL00:
001100 E1F9 C9              10      RET
                                
       E1FA                     PRINT2:
001101 E1FA CD98E3          17      CALL    SCR
001104 E1FD 2ABCEE          16      LD  HL,(_WIDTH_MINUS)
001107 E200 09              11      ADD HL,BC
       E201                     SET_TXADR_HL:
001108 E201 228EEE          16      LD  (_TXADR),HL
00110B E204 C9              10      RET
                                
       E205                     CTRL08:
00110C E205 3A62E1          13      LD  A,(INSFLG)
00110F E208 FECD             7      CP  0CDH        ;CALL ????
001111 E20A 2829            12      JR  Z,CTRL02
       E20C                     CTRL1D:
001113 E20C 2A8EEE          16      LD  HL,(_TXADR)
001116 E20F 7C               4      LD  A,H
001117 E210 B5               4      OR  L
001118 E211 C8              11      RET Z
001119 E212 2B               6      DEC HL
00111A E213 18EC            12      JR  SET_TXADR_HL
                                
       E215                     CTRL1E:
00111C E215 ED4B8EEE        20      LD  BC,(_TXADR)
001120 E219 2ABCEE          16      LD  HL,(_WIDTH_MINUS)
001123 E21C 09              11      ADD HL,BC
001124 E21D D0              11      RET NC
001125 E21E 18E1            12      JR  SET_TXADR_HL
                                
       E220                     CTRL1C:
001127 E220 ED4B8EEE        20      LD  BC,(_TXADR)
00112B E224 18C6            12      JR  PRINTE2
                                
       E226                     CTRL09:
00112D E226 ED4B8EEE        20      LD  BC,(_TXADR)
001131 E22A 79               4      LD  A,C
001132 E22B E6F8             7      AND 0F8H
001134 E22D C608             7      ADD A,8
001136 E22F 4F               4      LD  C,A
001137 E230 88               4      ADC A,B
001138 E231 91               4      SUB C
001139 E232 47               4      LD  B,A
00113A E233 18B8            12      JR  PRINTE3
                                
       E235                     CTRL02:
00113C E235 CD0CE2          17      CALL    CTRL1D
00113F E238 C8              11      RET Z
001140 E239 D5              11      PUSH    DE
001141 E23A CDD3EE          17      CALL    _POS
001144 E23D 3AB1EE          13      LD  A,(_WIDTH)
001147 E240 95               4      SUB L
001148 E241 4F               4      LD  C,A
001149 E242 0D               4      DEC C
00114A E243 0638             7      LD  B,038H
00114C E245 2A8EEE          16      LD  HL,(_TXADR)
00114F E248 09              11      ADD HL,BC
001150 E249 44               4      LD  B,H
001151 E24A 4D               4      LD  C,L
001152 E24B 110020          10      LD  DE,02000H   ;D:Text E:kanji
001155 E24E 2A96EE          16      LD  HL,(_COLORF)    ;L:Color
       E251                     C8X1:
001158 E251 CD37E3          17      CALL    C12S
00115B E254 0B               6      DEC BC
00115C E255 20FA            12      JR  NZ,C8X1
00115E E257 D1              10      POP DE
00115F E258 C9              10      RET
                                
       E259                     CTRL05:
001160 E259 CDD3EE          17      CALL    _POS
001163 E25C 3AB1EE          13      LD  A,(_WIDTH)
001166 E25F 95               4      SUB L
001167 E260 6F               4      LD  L,A
       E261                     C08X1:
001168 E261 ED4B8EEE        20      LD  BC,(_TXADR)
       E265                     LINECL:
00116C E265 2620             7      LD  H,020H
00116E E267 3A96EE          13      LD  A,(_COLORF)
001171 E26A CBE8             8      SET 5,B
       E26C                     LINECL1:
001173 E26C CBD8             8      SET 3,B
001175 E26E CBE0             8      SET 4,B
001177 E270 ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令   kanji
001179 E272 CB98             8      RES 3,B
00117B E274 ED61            12      OUT (C),H       ;Text
00117D E276 CBA0             8      RES 4,B
00117F E278 ED79            12      OUT (C),A       ;Color
001181 E27A 03               6      INC BC
001182 E27B 2D               4      DEC L
001183 E27C 20EE            12      JR  NZ,LINECL1
001185 E27E C9              10      RET
                                
       E27F                     CTRL0D:
001186 E27F CDD3EE          17      CALL    _POS
001189 E282 2E00             7      LD  L,0
       E284                     LOC:
00118B E284 C5              11      PUSH    BC
00118C E285 E5              11      PUSH    HL
00118D E286 CDC8E1          17      CALL    KANCLR
001190 E289 CDA7E2          17      CALL    LOC1
001193 E28C 228EEE          16      LD  (_TXADR),HL
001196 E28F E1              10      POP HL
001197 E290 C1              10      POP BC
001198 E291 C9              10      RET
                                
       E292                     CTRL12:
001199 E292 2162E1          10      LD  HL,INSFLG
00119C E295 7E               7      LD  A,(HL)
00119D E296 EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
00119F E298 77               7      LD  (HL),A
0011A0 E299 C9              10      RET
                                
       E29A                     CTRL0B:
0011A1 E29A 210000          10      LD  HL,0
0011A4 E29D 228EEE          16      LD  (_TXADR),HL
0011A7 E2A0 C9              10      RET
                                
       E2A1                     CTRL1B:
0011A8 E2A1 3E01             7      LD  A,1
0011AA E2A3 3259E1          13      LD  (ESCFLG+1),A
0011AD E2A6 C9              10      RET
                                
       E2A7                     LOC1:
0011AE E2A7 D5              11      PUSH    DE
0011AF E2A8 4D               4      LD  C,L
0011B0 E2A9 0608             7      LD  B,8
0011B2 E2AB 5C               4      LD  E,H
0011B3 E2AC 1600             7      LD  D,0
0011B5 E2AE 2AB0EE          16      LD  HL,(CRTCD)
0011B8 E2B1 6A               4      LD  L,D
       E2B2                     LOC2:
0011B9 E2B2 29              11      ADD HL,HL
0011BA E2B3 3001            12      JR  NC,LOC3
0011BC E2B5 19              11      ADD HL,DE
       E2B6                     LOC3:
0011BD E2B6 10FA            13      DJNZ    LOC2
0011BF E2B8 09              11      ADD HL,BC
0011C0 E2B9 D1              10      POP DE
0011C1 E2BA C9              10      RET
                                
       E2BB                     CONOUT1:
0011C2 E2BB CDCDE2          17      CALL    CURSOR
0011C5 E2BE 59               4      LD  E,C
0011C6 E2BF CDCDEE          17      CALL    _PRINT
0011C9 E2C2 7B               4      LD  A,E
0011CA E2C3 FE0A             7      CP  00AH
0011CC E2C5 2006            12      JR  NZ,CURSOR
0011CE E2C7 CD7FE2          17      CALL    CTRL0D
0011D1 E2CA CD59E2          17      CALL    CTRL05
       E2CD                     CURSOR:
0011D4 E2CD C5              11      PUSH    BC
0011D5 E2CE ED4B8EEE        20      LD  BC,(_TXADR)
0011D9 E2D2 CBE8             8      SET 5,B
0011DB E2D4 ED78            12      IN  A,(C)
0011DD E2D6 EE18             7      XOR 018H
0011DF E2D8 ED79            12      OUT (C),A
0011E1 E2DA C1              10      POP BC
0011E2 E2DB C9              10      RET
                                
       E2DC                     CTRL07:
0011E3 E2DC 2161EE          10      LD  HL,BEEPD
       E2DF                     BEEP1:
0011E6 E2DF 7E               7      LD  A,(HL)
0011E7 E2E0 23               6      INC HL
0011E8 E2E1 FEFF             7      CP  0FFH
0011EA E2E3 C8              11      RET Z
0011EB E2E4 061C             7      LD  B,01CH
0011ED E2E6 ED79            12      OUT (C),A
0011EF E2E8 EDA3            16      OUTI
0011F1 E2EA 18F3            12      JR  BEEP1
                                
       E2EC                     OT49SB:
0011F3 E2EC C5              11      PUSH    BC
0011F4 E2ED CD08E3          17      CALL    CANW
0011F7 E2F0 010019          10      LD  BC,01900H
0011FA E2F3 ED79            12      OUT (C),A
0011FC E2F5 C1              10      POP BC
0011FD E2F6 C9              10      RET
                                
       E2F7                     IN49SB:
0011FE E2F7 C5              11      PUSH    BC
0011FF E2F8 01011A          10      LD  BC,01A01H
       E2FB                     CANR:
001202 E2FB ED78            12      IN  A,(C)
001204 E2FD E620             7      AND 020H
001206 E2FF 20FA            12      JR  NZ,CANR
001208 E301 010019          10      LD  BC,01900H
00120B E304 ED78            12      IN  A,(C)
00120D E306 C1              10      POP BC
00120E E307 C9              10      RET
                                
       E308                     CANW:
00120F E308 01011A          10      LD  BC,01A01H
001212 E30B ED48            12      IN  C,(C)
001214 E30D CB71             8      BIT 6,C
001216 E30F 20F7            12      JR  NZ,CANW
001218 E311 C9              10      RET
                                
       E312                     COMOUT:
001219 E312 FB               4      EI
00121A E313 CDECE2          17      CALL    OT49SB
00121D E316 CD08E3          17      CALL    CANW
001220 E319 F3               4      DI
001221 E31A C9              10      RET
                                
       E31B                     INSERT:
001222 E31B D5              11      PUSH    DE
001223 E31C CDD3EE          17      CALL    _POS
001226 E31F 3AB1EE          13      LD  A,(_WIDTH)
001229 E322 95               4      SUB L
00122A E323 ED4B8EEE        20      LD  BC,(_TXADR)
00122E E327 110020          10      LD  DE,02000H   ;D:Text E:Kanji
001231 E32A 2A96EE          16      LD  HL,(_COLORF)    ;L:Color
001234 E32D CBE8             8      SET 5,B
       E32F                     C12X1:
001236 E32F CD37E3          17      CALL    C12S
001239 E332 03               6      INC BC
00123A E333 20FA            12      JR  NZ,C12X1
00123C E335 D1              10      POP DE
00123D E336 C9              10      RET
                                
       E337                     C12S:
00123E E337 CBE0             8      SET 4,B
001240 E339 CBD8             8      SET 3,B
001242 E33B ED60            12      IN  H,(C)
001244 E33D ED59            12  X1PAT:  OUT (C),E
001246 E33F 5C               4      LD  E,H
001247 E340 CB98             8      RES 3,B
001249 E342 ED60            12      IN  H,(C)
00124B E344 ED51            12      OUT (C),D
00124D E346 54               4      LD  D,H
00124E E347 CBA0             8      RES 4,B
001250 E349 ED60            12      IN  H,(C)
001252 E34B ED69            12      OUT (C),L
001254 E34D 6C               4      LD  L,H
001255 E34E 3D               4      DEC A
001256 E34F C9              10      RET
                                
       E350                     CTRL0C:
001257 E350 CD9AE2          17      CALL    CTRL0B
       E353                     CTRL06:
00125A E353 ED4B8EEE        20      LD  BC,(_TXADR)
       E357                     C1AX1:
00125E E357 78               4      LD  A,B
00125F E358 F638             7      OR  038H
001261 E35A 47               4      LD  B,A
001262 E35B ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令   kanji
001264 E35D CB98             8      RES 3,B
001266 E35F 3E20             7      LD  A,020H
001268 E361 ED79            12      OUT (C),A       ;Text
00126A E363 CBA0             8      RES 4,B
00126C E365 3A96EE          13      LD  A,(_COLORF)
00126F E368 ED79            12      OUT (C),A       ;Color
001271 E36A 03               6      INC BC
001272 E36B CBA8             8      RES 5,B
001274 E36D 2ABAEE          16      LD  HL,(_PAGE_MINUS)
001277 E370 09              11      ADD HL,BC
001278 E371 30E4            12      JR  NC,C1AX1
00127A E373 C9              10      RET
                                
       E374                     CTRL04:
00127B E374 CDD3EE          17      CALL    _POS
00127E E377 7D               4      LD  A,L
00127F E378 B7               4      OR  A
001280 E379 C8              11      RET Z
       E37A                     CTRL03:
001281 E37A CD7FE2          17      CALL    CTRL0D
       E37D                     CTRL0A:
       E37D                     CTRL1F:
001284 E37D ED4B8EEE        20      LD  BC,(_TXADR)
001288 E381 2AB1EE          16      LD  HL,(_WIDTH)
00128B E384 2600             7      LD  H,0
00128D E386 09              11      ADD HL,BC
00128E E387 44               4      LD  B,H
00128F E388 4D               4      LD  C,L
001290 E389 2ABAEE          16      LD  HL,(_PAGE_MINUS)
001293 E38C 09              11      ADD HL,BC
001294 E38D 3F               4      CCF
001295 E38E 9F               4      SBC A,A
001296 E38F C3F3E1          10      JP  PRINTE8
                                
       E392                     CTRL0E:
001299 E392 CDD3EE          17      CALL    _POS
00129C E395 7C               4      LD  A,H
00129D E396 1804            12      JR  SCR1
       E398                     SCR:
00129F E398 3A97EE          13      LD  A,(_LINE)
0012A2 E39B 3D               4      DEC A
       E39C                     SCR1:
0012A3 E39C C5              11      PUSH    BC
0012A4 E39D D5              11      PUSH    DE
0012A5 E39E F5              11      PUSH    AF
0012A6 E39F 3E07             7      LD  A,7
0012A8 E3A1 21D2E3          10      LD  HL,SCRDMAD
0012AB E3A4 CDC8E3          17      CALL    SETDMA
0012AE E3A7 F1              10      POP AF
0012AF E3A8 210038          10      LD  HL,03800H
                                
       E3AB                     SCRUP1:
0012B2 E3AB B7               4      OR  A
0012B3 E3AC 284D            12      JR  Z,SCRCL
0012B5 E3AE F5              11      PUSH    AF
0012B6 E3AF CDD9E3          17      CALL    UPSUB       ;kanji
0012B9 E3B2 3ABCEE          13      LD  A,(_WIDTH_MINUS)
0012BC E3B5 5F               4      LD  E,A
0012BD E3B6 16F7             7      LD  D,0F7H
0012BF E3B8 19              11      ADD HL,DE
0012C0 E3B9 D5              11      PUSH    DE
0012C1 E3BA CDD9E3          17      CALL    UPSUB       ;Text
0012C4 E3BD D1              10      POP DE
0012C5 E3BE 19              11      ADD HL,DE
0012C6 E3BF CDD9E3          17      CALL    UPSUB       ;Color
0012C9 E3C2 CBE4             8      SET 4,H
0012CB E3C4 F1              10      POP AF
0012CC E3C5 3D               4      DEC A
0012CD E3C6 18E3            12      JR  SCRUP1
                                
       E3C8                     SETDMA:
0012CF E3C8 01871F          10      LD  BC,01F87H
       E3CB                     SDMA:
0012D2 E3CB 04               4      INC B
0012D3 E3CC EDA3            16      OUTI
0012D5 E3CE 3D               4      DEC A
0012D6 E3CF 20FA            12      JR  NZ,SDMA
0012D8 E3D1 C9              10      RET
                                
       E3D2                     SCRDMAD:
0012D9 E3D2 C3                      DB  0C3H        ;WR6 リセット
0012DA E3D3 9A                      DB  09AH        ;WR5 ストップ WAIT READY:HIGH
0012DB E3D4 65                      DB  065H        ;WR0 ブロック長(LH)
0012DC E3D5 4F00                    DW  79
0012DE E3D7 1C                      DB  01CH        ;WR1 ポートAインクリメント I/O
0012DF E3D8 18                      DB  018H        ;WR0 ポートAアドレス(LH)
                                
       E3D9                     UPSUB:
0012E0 E3D9 3AB1EE          13      LD  A,(_WIDTH)
0012E3 E3DC 5F               4      LD  E,A
0012E4 E3DD 1600             7      LD  D,0
0012E6 E3DF 3EAD             7      LD  A,0ADH      ;WR4 連続 ポートB開始アドレス(LH)
0012E8 E3E1 ED79            12      OUT (C),A
0012EA E3E3 ED69            12      OUT (C),L       ;SOURCE
0012EC E3E5 ED61            12      OUT (C),H
0012EE E3E7 19              11      ADD HL,DE
0012EF E3E8 3E1D             7      LD  A,01DH      ;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
0012F1 E3EA ED79            12      OUT (C),A
0012F3 E3EC ED69            12      OUT (C),L       ;DEST
0012F5 E3EE ED61            12      OUT (C),H
       E3F0                     GO_DMA:
0012F7 E3F0 3ECF             7      LD  A,0CFH
0012F9 E3F2 ED79            12      OUT (C),A       ;WR6 ロード
0012FB E3F4 3EB3             7      LD  A,0B3H
0012FD E3F6 ED79            12      OUT (C),A       ;WR6 強制RDY
0012FF E3F8 ED49            12      OUT (C),C       ;WR6 イネーブル
001301 E3FA C9              10      RET
                                
       E3FB                     SCRCL:
001302 E3FB 44               4      LD  B,H
001303 E3FC 4D               4      LD  C,L
001304 E3FD 2AB1EE          16      LD  HL,(_WIDTH)
001307 E400 CD65E2          17      CALL    LINECL
00130A E403 D1              10      POP DE
00130B E404 C1              10      POP BC
00130C E405 C9              10      RET
                                
       E406                     SCRN:
00130D E406 D5              11      PUSH    DE
00130E E407 ED58            12      IN  E,(C)       ;Text
001310 E409 3A1800          13      LD  A,(00018H)
001313 E40C 3C               4      INC A
001314 E40D 281E            12      JR  Z,SCRN2
001316 E40F CBD8             8      SET 3,B
001318 E411 ED50            12      IN  D,(C)       ;Kanji
00131A E413 2816            12      JR  Z,SCRN1
00131C E415 AF               4      XOR A
00131D E416 C5              11      PUSH    BC
00131E E417 013730          10      LD  BC,03037H   ;VRMJIS
001321 E41A DF              12      RST 018H
001322 E41B 01522F          10      LD  BC,02F52H   ;JISSFT
001325 E41E DF              12      RST 018H
001326 E41F C1              10      POP BC
001327 E420 ED78            12      IN  A,(C)
001329 E422 CB98             8      RES 3,B
00132B E424 E640             7      AND 040H
00132D E426 2005            12      JR  NZ,SCRN2
00132F E428 7A               4      LD  A,D
001330 E429 D1              10      POP DE
001331 E42A C9              10      RET
       E42B                     SCRN1:
001332 E42B CB98             8      RES 3,B
       E42D                     SCRN2:
001334 E42D 7B               4      LD  A,E
001335 E42E D1              10      POP DE
001336 E42F C9              10      RET
       E430                     SCRNE:
       E430                     POS:
001337 E430 2A8EEE          16      LD  HL,(_TXADR)
00133A E433 C5              11      PUSH    BC
00133B E434 ED4BBCEE        20      LD  BC,(_WIDTH_MINUS)
00133F E438 AF               4      XOR A
       E439                     POS1:
001340 E439 09              11      ADD HL,BC
001341 E43A 3C               4      INC A
001342 E43B 38FC            12      JR  C,POS1
001344 E43D ED42            15      SBC HL,BC
001346 E43F 3D               4      DEC A
001347 E440 67               4      LD  H,A
001348 E441 C1              10      POP BC
001349 E442 A7               4      AND A
00134A E443 C9              10      RET
                                
       E444                     GETL:
00134B E444 CDD3EE          17      CALL    _POS
00134E E447 E5              11      PUSH    HL
00134F E448 3ECD             7      LD  A,0CDH      ;CALL ????
001351 E44A 3262E1          13      LD  (INSFLG),A
       E44D                     GETL1:
001354 E44D CDD6DF          17      CALL    _SYS08
001357 E450 FE09             7      CP  9
001359 E452 2008            12      JR  NZ,GETL1V
00135B E454 2120FF          10      LD  HL,KBUF
00135E E457 CDA2DC          17      CALL    MSX
001361 E45A 18F1            12      JR  GETL1
       E45C                     GETL1V:
001363 E45C 5F               4      LD  E,A
001364 E45D CDCDEE          17      CALL    _PRINT
                                
001367 E460 7B               4      LD  A,E
001368 E461 FE0D             7      CP  00DH
00136A E463 20E8            12      JR  NZ,GETL1
00136C E465 3E01             7      LD  A,1     ;LD BC,????
00136E E467 3262E1          13      LD  (INSFLG),A
001371 E46A 1120FF          10      LD  DE,KBUF
001374 E46D 3AB1EE          13      LD  A,(_WIDTH)
001377 E470 47               4      LD  B,A
001378 E471 CD55DA          17      CALL    ZERO_MEMORY_DE
                                
00137B E474 D1              10      POP DE
00137C E475 CDD3EE          17      CALL    _POS
00137F E478 6B               4      LD  L,E
001380 E479 3AB1EE          13      LD  A,(_WIDTH)
001383 E47C 95               4      SUB L
001384 E47D 57               4      LD  D,A
001385 E47E CDA7E2          17      CALL    LOC1
001388 E481 4D               4      LD  C,L
001389 E482 7C               4      LD  A,H
00138A E483 F630             7      OR  030H
00138C E485 47               4      LD  B,A
00138D E486 5A               4      LD  E,D
00138E E487 2120FF          10      LD  HL,KBUF
       E48A                     GETL2:
001391 E48A CDD0EE          17      CALL    _SCRN
001394 E48D 03               6      INC BC
001395 E48E 77               7      LD  (HL),A
001396 E48F 23               6      INC HL
001397 E490 1D               4      DEC E
001398 E491 20F7            12      JR  NZ,GETL2
       E493                     GETL3:
00139A E493 2B               6      DEC HL
00139B E494 7E               7      LD  A,(HL)
00139C E495 FE21             7      CP  021H
00139E E497 D0              11      RET NC
00139F E498 3600            10      LD  (HL),0
0013A1 E49A 15               4      DEC D
0013A2 E49B 20F6            12      JR  NZ,GETL3
0013A4 E49D C9              10      RET
                                
       E49E                     INKEY:
0013A5 E49E FB               4      EI
0013A6 E49F E5              11      PUSH    HL
0013A7 E4A0 2A90EE          16      LD  HL,(_KEYPS)
0013AA E4A3 7C               4      LD  A,H
0013AB E4A4 AD               4      XOR L
0013AC E4A5 280B            12      JR  Z,INKEY1
0013AE E4A7 7C               4      LD  A,H
0013AF E4A8 3C               4      INC A
0013B0 E4A9 E61F             7      AND 01FH
0013B2 E4AB 3291EE          13      LD  (_KEYPS+1),A
0013B5 E4AE 6F               4      LD  L,A
0013B6 E4AF 26FF             7      LD  H,KEYBF/256
0013B8 E4B1 7E               7      LD  A,(HL)
       E4B2                     INKEY1:
0013B9 E4B2 E1              10      POP HL
0013BA E4B3 B7               4      OR  A
0013BB E4B4 C9              10      RET
                                
       0E77                     AT_RS   EQU SCR1-AT_SCR1
[EOF:X1IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E4B5                     _SYS26:     ;(BDOS)ランダムブロック書き込み
0013BC E4B5 AF               4      XOR A
0013BD E4B6 329EE7          13      LD  (DRDN1),A   ;NOP
0013C0 E4B9 22EAF5          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
0013C3 E4BC 225DEE          16      LD  (LEFTX),HL
0013C6 E4BF CDF3F0          17      CALL    SETDRV
                                
0013C9 E4C2 CD28E6          17      CALL    RBX0
0013CC E4C5 DA52E5          10      JP  C,RBWERR
0013CF E4C8 CD7CF4          17      CALL    WOPEN
0013D2 E4CB DA52E5          10      JP  C,RBWERR
0013D5 E4CE 7C               4      LD  A,H
0013D6 E4CF B5               4      OR  L
0013D7 E4D0 CA4BE5          10      JP  Z,RBW1
                                
0013DA E4D3 2B               6      DEC HL
                                
0013DB E4D4 CDBBF5          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0013DE E4D7 19              11      ADD HL,DE       ;BCHL=HL+BCDE
0013DF E4D8 3001            12      JR  NC,S26X1    ;
0013E1 E4DA 03               6      INC BC      ;
       E4DB                     S26X1:
0013E2 E4DB CDE7F4          17      CALL    RWXR
0013E5 E4DE DC8DF4          17      CALL    C,WRDFX
0013E8 E4E1 DA52E5          10      JP  C,RBWERR
                                
0013EB E4E4 CD57E6          17      CALL    RBX2
0013EE E4E7 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
0013F0 E4E9 CD76E6          17      CALL    RBXA
0013F3 E4EC 3864            12      JR  C,RBWERR
0013F5 E4EE EB               4      EX  DE,HL
0013F6 E4EF C5              11      PUSH    BC
0013F7 E4F0 EDB0                    LDIR
0013F9 E4F2 225FEE          16      LD  (DTAX),HL
                                
0013FC E4F5 CD1EF4          17      CALL    WTDB        ;バッファデータは更新された
                                
0013FF E4F8 2A5DEE          16      LD  HL,(LEFTX)
001402 E4FB D1              10      POP DE
001403 E4FC ED52            15      SBC HL,DE
001405 E4FE 225DEE          16      LD  (LEFTX),HL
001408 E501 2831            12      JR  Z,RBWEND
                                
       E503                     RBWB:
00140A E503 CDABE6          17      CALL    RBXB
00140D E506 2814            12      JR  Z,RBWC
       E508                     RBWB1:
00140F E508 C5              11      PUSH    BC
001410 E509 D5              11      PUSH    DE
001411 E50A CDFBF2          17      CALL    CLUSTX
001414 E50D CDCFE6          17      CALL    DWTC
001417 E510 D1              10      POP DE
001418 E511 C1              10      POP BC
001419 E512 D420E9          17      CALL    NC,GNCLX
00141C E515 383B            12      JR  C,RBWERR
00141E E517 10EF            13      DJNZ    RBWB1
001420 E519 CD1FE7          17      CALL    DRW_FLUSH
       E51C                     RBWC:
001423 E51C CDC3E6          17      CALL    RBXC
001426 E51F 2813            12      JR  Z,RBWEND
001428 E521 C5              11      PUSH    BC
001429 E522 CDFBF2          17      CALL    CLUSTX
00142C E525 CD9DE7          17      CALL    DRDN
00142F E528 C1              10      POP BC
001430 E529 3827            12      JR  C,RBWERR
001432 E52B ED5B7EEF        20      LD  DE,(_DTBUF)
001436 E52F EDB0                    LDIR
001438 E531 CD1EF4          17      CALL    WTDB        ;バッファデータは更新された
       E534                     RBWEND:
00143B E534 CDE9F5          17      CALL    RBXEND
                                
00143E E537 CD37E6          17      CALL    RBX1
001441 E53A 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
001443 E53C CDBBF5          17      CALL    GET_RR_BCDE ;BCDE=Random record
001446 E53F FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
001449 E542 FD7211          19      LD  (IY+17),D   ;
00144C E545 FD7112          19      LD  (IY+18),C   ;
00144F E548 FD7013          19      LD  (IY+19),B   ;
       E54B                     RBW1:
001452 E54B FDE1            14      POP IY
001454 E54D C1              10      POP BC
001455 E54E D1              10      POP DE
001456 E54F E1              10      POP HL
       E550                     DD_NUL:
001457 E550 AF               4      XOR A
       E551                     DRDF0:
       E551                     DWTF0:
001458 E551 C9              10      RET
                                
       E552                     RBWERR:
001459 E552 FDE5            15      PUSH    IY
00145B E554 D1              10      POP DE
00145C E555 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
00145E E557 CD62DC          17      CALL    BDOS0
       E55A                     RBRERR1:
001461 E55A 3E01             7      LD  A,001H
       E55C                     RBRERR2:
001463 E55C FDE1            14      POP IY
001465 E55E C1              10      POP BC
001466 E55F D1              10      POP DE
001467 E560 E1              10      POP HL
001468 E561 37               4      SCF
001469 E562 210000          10      LD  HL,0
00146C E565 C9              10      RET
                                
       E566                     RBRERR:
00146D E566 3EFF             7      LD  A,0FFH
00146F E568 18F2            12      JR  RBRERR2
                                
       E56A                     RBRFL:
001471 E56A 3E00             7  RBRFLP: LD  A,000H
001473 E56C FE0D             7      CP  00DH
001475 E56E 2005            12      JR  NZ,RBRFL1
001477 E570 D5              11      PUSH    DE
001478 E571 1E0A             7      LD  E,00AH
00147A E573 1805            12      JR  RBRFL2
       E575                     RBRFL1:
00147C E575 D5              11      PUSH    DE
00147D E576 CD09EE          17      CALL    _SYS07
001480 E579 5F               4      LD  E,A
       E57A                     RBRFL2:
001481 E57A CDCDEE          17      CALL    _PRINT
001484 E57D 7B               4      LD  A,E
001485 E57E D1              10      POP DE
001486 E57F 326BE5          13      LD  (RBRFLP+1),A
001489 E582 C9              10      RET
                                
                                                ;Read random block
       E583                     _SYS27:     ;(BDOS)ランダムブロック読み込み
00148A E583 225DEE          16      LD  (LEFTX),HL
00148D E586 CDF3F0          17      CALL    SETDRV
                                
001490 E589 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
001494 E58D C216E6          10      JP  NZ,RBRDIR   ;ディレクトリ
001497 E590 CD28E6          17      CALL    RBX0
00149A E593 DA66E5          10      JP  C,RBRERR
00149D E596 CD37E6          17      CALL    RBX1
0014A0 E599 D44FE6          17      CALL    NC,RBX1R
0014A3 E59C DA5AE5          10      JP  C,RBRERR1
0014A6 E59F EB               4      EX  DE,HL
0014A7 E5A0 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
0014A9 E5A2 19              11      ADD HL,DE
0014AA E5A3 79               4      LD  A,C
0014AB E5A4 DE00             7      SBC A,0
0014AD E5A6 78               4      LD  A,B
0014AE E5A7 DE00             7      SBC A,0
0014B0 E5A9 3801            12      JR  C,RBR1
0014B2 E5AB EB               4      EX  DE,HL
       E5AC                     RBR1:
0014B3 E5AC 9F               4      SBC A,A
0014B4 E5AD E601             7      AND 1
0014B6 E5AF 3214E6          13      LD  (RBRA_SWC),A
                                
0014B9 E5B2 7C               4      LD  A,H
0014BA E5B3 B5               4      OR  L
0014BB E5B4 2857            12      JR  Z,RBREND0
                                
0014BD E5B6 22EAF5          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
0014C0 E5B9 225DEE          16      LD  (LEFTX),HL
                                
0014C3 E5BC CD57E6          17      CALL    RBX2
0014C6 E5BF 2819            12      JR  Z,RBRB
0014C8 E5C1 CD76E6          17      CALL    RBXA
0014CB E5C4 DA66E5          10      JP  C,RBRERR
0014CE E5C7 C5              11      PUSH    BC
0014CF E5C8 EDB0                    LDIR
0014D1 E5CA ED535FEE        20      LD  (DTAX),DE
0014D5 E5CE 2A5DEE          16      LD  HL,(LEFTX)
0014D8 E5D1 D1              10      POP DE
0014D9 E5D2 A7               4      AND A
0014DA E5D3 ED52            15      SBC HL,DE
0014DC E5D5 225DEE          16      LD  (LEFTX),HL
0014DF E5D8 2830            12      JR  Z,RBREND
                                
       E5DA                     RBRB:
0014E1 E5DA CDABE6          17      CALL    RBXB
0014E4 E5DD 2815            12      JR  Z,RBRC
       E5DF                     RBRB1:
0014E6 E5DF C5              11      PUSH    BC
0014E7 E5E0 D5              11      PUSH    DE
0014E8 E5E1 CDFBF2          17      CALL    CLUSTX
0014EB E5E4 CDD5E6          17      CALL    DRDC
0014EE E5E7 D1              10      POP DE
0014EF E5E8 C1              10      POP BC
0014F0 E5E9 D420E9          17      CALL    NC,GNCLX
0014F3 E5EC DA66E5          10      JP  C,RBRERR
0014F6 E5EF 10EE            13      DJNZ    RBRB1
0014F8 E5F1 CD1FE7          17      CALL    DRW_FLUSH
       E5F4                     RBRC:
0014FB E5F4 CDC3E6          17      CALL    RBXC
0014FE E5F7 2811            12      JR  Z,RBREND
001500 E5F9 C5              11      PUSH    BC
001501 E5FA CDFBF2          17      CALL    CLUSTX
001504 E5FD CD81E7          17      CALL    DRDX
001507 E600 C1              10      POP BC
001508 E601 DA66E5          10      JP  C,RBRERR
00150B E604 EB               4      EX  DE,HL
00150C E605 2A7EEF          16      LD  HL,(_DTBUF)
00150F E608 EDB0                    LDIR
       E60A                     RBREND:
001511 E60A CDE9F5          17      CALL    RBXEND
       E60D                     RBREND0:
001514 E60D FDE1            14      POP IY
001516 E60F C1              10      POP BC
001517 E610 D1              10      POP DE
001518 E611 F1              10      POP AF  ;(HL)
001519 E612 AF               4      XOR A
00151A E613 3E00             7      LD  A,000H
       E614                     RBRA_SWC    EQU $-1
00151C E615 C9              10      RET
                                
       E616                     RBRDIR:
00151D E616 FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001520 E619 FD661B          19      LD  H,(IY+27)
001523 E61C CD3AF3          17      CALL    CHDIR
001526 E61F AF               4      XOR A
001527 E620 67               4      LD  H,A
001528 E621 6F               4      LD  L,A
001529 E622 3C               4      INC A
00152A E623 3214E6          13      LD  (RBRA_SWC),A
00152D E626 18E5            12      JR  RBREND0
                                ;(15)
       E628                     RBX0:
00152F E628 2A8AEE          16      LD  HL,(_DTA)
001532 E62B 225FEE          16      LD  (DTAX),HL
001535 E62E 2A5DEE          16      LD  HL,(LEFTX)
001538 E631 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00153B E634 D6FD             7      SUB 0FDH
00153D E636 C9              10      RET
                                
       E637                     RBX1:               ;ファイルサイズとランダムレコードを比べる
00153E E637 E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
00153F E638 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
001542 E63B FD6611          19      LD  H,(IY+17)   ;
001545 E63E FD7E12          19      LD  A,(IY+18)   ;
                                
001548 E641 CDBBF5          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
00154B E644 A7               4      AND A
00154C E645 ED52            15      SBC HL,DE
00154E E647 99               4      SBC A,C
00154F E648 4F               4      LD  C,A
001550 E649 FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
001553 E64C 98               4      SBC A,B
001554 E64D D1              10      POP DE
001555 E64E C9              10      RET
       E64F                     RBX1R:              ;(8)
001556 E64F 47               4      LD  B,A
001557 E650 B1               4      OR  C
001558 E651 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
001559 E652 B2               4      OR  D
00155A E653 B3               4      OR  E
00155B E654 C0              11      RET NZ
00155C E655 37               4      SCF
00155D E656 C9              10      RET
                                
       E657                     RBX2:               ;Cluster settings
00155E E657 FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001561 E65A FD4E23          19      LD  C,(IY+35)
001564 E65D 0600             7      LD  B,0
001566 E65F FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00156A E663 2003            12      JR  NZ,RBX3
00156C E665 FD4624          19      LD  B,(IY+36)
       E668                     RBX3:
00156F E668 CDE7F4          17      CALL    RWXR
001572 E66B 3A8DE6          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001575 E66E 3D               4      DEC A
001576 E66F FDA622          19      AND (IY+34)
001579 E672 FDB621          19      OR  (IY+33)
00157C E675 C9              10      RET
                                
       E676                     RBXA:
00157D E676 C5              11      PUSH    BC
00157E E677 D5              11      PUSH    DE
00157F E678 CDFBF2          17      CALL    CLUSTX
001582 E67B CD81E7          17      CALL    DRDX
001585 E67E D1              10      POP DE
001586 E67F C1              10      POP BC
001587 E680 D420E9          17      CALL    NC,GNCLX
00158A E683 D8              11      RET C
00158B E684 ED53FEEF        20      LD  (_CLPS),DE
                                
00158F E688 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
001592 E68B 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       E68C                     SECSZ   EQU $-2
       E68D                     SECSZ_H EQU $-1
001595 E68E 7C               4      LD  A,H
001596 E68F 3D               4      DEC A       ;1024=3 / 512=1
001597 E690 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
00159A E693 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
00159B E694 ED42            15      SBC HL,BC       ;残りを計算
                                
00159D E696 ED5B5DEE        20      LD  DE,(LEFTX)
0015A1 E69A ED52            15      SBC HL,DE       ;CP HL,DE
0015A3 E69C 19              11      ADD HL,DE       ;
0015A4 E69D 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
0015A6 E69F EB               4      EX  DE,HL
       E6A0                     RBXA1:
0015A7 E6A0 E5              11      PUSH    HL
0015A8 E6A1 2A7EEF          16      LD  HL,(_DTBUF)
0015AB E6A4 09              11      ADD HL,BC
0015AC E6A5 ED5B5FEE        20      LD  DE,(DTAX)
0015B0 E6A9 C1              10      POP BC
0015B1 E6AA C9              10      RET
                                
       E6AB                     RBXB:
0015B2 E6AB 2A5FEE          16      LD  HL,(DTAX)
0015B5 E6AE ED5BFEEF        20      LD  DE,(_CLPS)
0015B9 E6B2 3A5EEE          13      LD  A,(LEFTX+1)
0015BC E6B5 47               4      LD  B,A
0015BD E6B6 3A8DE6          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E6B9                     RBXB1:
0015C0 E6B9 1F               4      RRA     ;->CF
0015C1 E6BA 3804            12      JR  C,RBXB2
0015C3 E6BC CB38             8      SRL B   ;B=B/2
0015C5 E6BE 18F9            12      JR  RBXB1
       E6C0                     RBXB2:
0015C7 E6C0 78               4      LD  A,B
0015C8 E6C1 B7               4      OR  A
0015C9 E6C2 C9              10      RET
                                ;(12)
       E6C3                     RBXC:
0015CA E6C3 ED4B5DEE        20      LD  BC,(LEFTX)
0015CE E6C7 3A8DE6          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
0015D1 E6CA 3D               4      DEC A
0015D2 E6CB A0               4      AND B
0015D3 E6CC 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
0015D4 E6CD B1               4      OR  C
0015D5 E6CE C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E6CF                     DWTC:
0015D6 E6CF E5              11      PUSH    HL
0015D7 E6D0 21B7EA          10      LD  HL,DWT24B
0015DA E6D3 1804            12      JR  DWTC1
       E6D5                     DRDC:
0015DC E6D5 E5              11      PUSH    HL
0015DD E6D6 21A9EA          10      LD  HL,DRD24B
       E6D9                     DWTC1:
0015E0 E6D9 2233E7          16      LD  (DRWF_MODE),HL
0015E3 E6DC E1              10      POP HL
0015E4 E6DD 3A23E7          13      LD  A,(DRWF_B)
0015E7 E6E0 B7               4      OR  A
0015E8 E6E1 200F            12      JR  NZ,DRDC1
       E6E3                     SAVE_DRWC:
0015EA E6E3 0601             7      LD  B,1
0015EC E6E5 ED4322E7        20      LD  (DRWF_C),BC
0015F0 E6E9 ED5329E7        20      LD  (DRWF_E),DE
0015F4 E6ED 222CE7          16      LD  (DRWF_HL),HL
0015F7 E6F0 1820            12      JR  INC_HL_DRWC
       E6F2                     DRDC1:
0015F9 E6F2 E5              11      PUSH    HL
0015FA E6F3 2129E7          10      LD  HL,DRWF_E
0015FD E6F6 86               7      ADD A,(HL)
0015FE E6F7 F5              11      PUSH    AF
0015FF E6F8 BB               4      CP  E
001600 E6F9 201D            12      JR  NZ,DRDC2
001602 E6FB F1              10      POP AF
001603 E6FC 23               6      INC HL
001604 E6FD 7E               7      LD  A,(HL)
001605 E6FE CE00             7      ADC A,0
001607 E700 F5              11      PUSH    AF
001608 E701 BA               4      CP  D
001609 E702 2014            12      JR  NZ,DRDC2
00160B E704 F1              10      POP AF
00160C E705 3A22E7          13      LD  A,(DRWF_C)
00160F E708 CE00             7      ADC A,0
001611 E70A B9               4      CP  C
001612 E70B 200C            12      JR  NZ,DRDC3
001614 E70D 2123E7          10      LD  HL,DRWF_B
001617 E710 34              11      INC (HL)
001618 E711 E1              10      POP HL
       E712                     INC_HL_DRWC:
001619 E712 3A8DE6          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
00161C E715 84               4      ADD A,H
00161D E716 67               4      LD  H,A
00161E E717 C9              10      RET
       E718                     DRDC2:
00161F E718 F1              10      POP AF
       E719                     DRDC3:
001620 E719 CD1FE7          17      CALL    DRW_FLUSH
001623 E71C E1              10      POP HL
001624 E71D 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E71F                     DRW_FLUSH:
001626 E71F C5              11      PUSH    BC
001627 E720 D5              11      PUSH    DE
001628 E721 010000          10      LD  BC,0
       E722                     DRWF_C  EQU $-2
       E723                     DRWF_B  EQU $-1
00162B E724 78               4      LD  A,B
00162C E725 B7               4      OR  A
00162D E726 280D            12      JR  Z,DRDF1
00162F E728 110000          10      LD  DE,0
       E729                     DRWF_E  EQU $-2
       E72A                     DRWF_D  EQU $-1
001632 E72B 210000          10      LD  HL,0
       E72C                     DRWF_HL EQU $-2
001635 E72E AF               4      XOR A
001636 E72F 3223E7          13      LD  (DRWF_B),A
001639 E732 CDA9EA          17      CALL    DRD24B
       E733                     DRWF_MODE   EQU $-2
       E735                     DRDF1:
00163C E735 D1              10      POP DE
00163D E736 C1              10      POP BC
00163E E737 C9              10      RET
                                
       E738                     RB_WRITE:
00163F E738 C5              11      PUSH    BC
001640 E739 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
001642 E73B 1803            12      JR  RBRW
       E73D                     RB_READ:
001644 E73D C5              11      PUSH    BC
001645 E73E 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       E740                     RBRW:
001647 E740 1F               4      RRA     ;AHL = AHL*128
001648 E741 7C               4      LD  A,H ;AHL = AHL0/2
001649 E742 1F               4      RRA     ;A
00164A E743 65               4      LD  H,L ;
00164B E744 CB1C             8      RR  H   ;H
00164D E746 2E00             7      LD  L,0 ;
00164F E748 CB1D             8      RR  L   ;L
001651 E74A CDA0F5          17      CALL    SET_RR_AHL
001654 E74D 218000          10      LD  HL,128
001657 E750 C5              11      PUSH    BC
       E751                     SETSEQ_SWC_RND:
001658 E751 CDCFF5          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
00165B E754 C1              10      POP BC
00165C E755 FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
001660 E759 FDE5            15      PUSH    IY
001662 E75B D1              10      POP DE
001663 E75C D5              11      PUSH    DE
001664 E75D CD62DC          17      CALL    BDOS0
001667 E760 FDE1            14      POP IY
001669 E762 CDAAF5          17      CALL    SETSEQ      ;SETSEQ or POPRR
       E763                     SETSEQ_SWC_SEQ_RR   EQU $-2
00166C E765 FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
001670 E769 C1              10      POP BC
001671 E76A C9              10      RET
                                
                                ;(22)
       E76B                     INIT_SEQ:
001672 E76B 3E01             7      LD  A,1     ;LD BC,????
001674 E76D 21AAF5          10      LD  HL,SETSEQ
001677 E770 CD70F5          17      CALL    PUSHRR
       E773                     GETSEQ:
00167A E773 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
00167D E776 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
001680 E779 AF               4      XOR A
                                
001681 E77A CB25             8      SLA L   ;L=L*2
                                
001683 E77C CB3C             8      SRL H   ;HL=HL/2
001685 E77E CB1D             8      RR  L   ;
001687 E780 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E781                     DRDX:
001688 E781 CDBFE7          17      CALL    DRDY
00168B E784 C8              11      RET Z
00168C E785 CDA5E7          17      CALL    DRDX1       ;データバッファの情報を保存
00168F E788 D8              11      RET C
001690 E789 E5              11      PUSH    HL
001691 E78A C5              11      PUSH    BC
001692 E78B D5              11      PUSH    DE
001693 E78C 2A7EEF          16      LD  HL,(_DTBUF)
001696 E78F 3AE8E7          13      LD  A,(_DBS24)
001699 E792 4F               4      LD  C,A
00169A E793 CDA7EA          17      CALL    DRD24
00169D E796 DCBAE7          17      CALL    C,DRDNE
       E799                     POP_DE_BC_HL_RET:
0016A0 E799 D1              10      POP DE
0016A1 E79A C1              10      POP BC
0016A2 E79B E1              10      POP HL
0016A3 E79C C9              10      RET
                                
                                ;   CDE:セクタ番号
       E79D                     DRDN:
0016A4 E79D AF               4      XOR A
0016A5 E79E 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
0016A6 E79F 30E0            12      JR  NC,DRDX
       E7A1                     DRDNX:
0016A8 E7A1 CDBFE7          17      CALL    DRDY
0016AB E7A4 C8              11      RET Z
       E7A5                     DRDX1:
0016AC E7A5 CDD5E7          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
0016AF E7A8 ED53A6EE        20      LD  (_DBSEC),DE
0016B3 E7AC 79               4      LD  A,C
0016B4 E7AD 32E8E7          13      LD  (_DBS24),A
                                
0016B7 E7B0 3A88EE          13      LD  A,(_DRV)
0016BA E7B3 32A5EE          13      LD  (_DBDRV),A
0016BD E7B6 CDD9EE          17      CALL    _CHGDRV
0016C0 E7B9 D0              11      RET NC
       E7BA                     DRDNE:
0016C1 E7BA 9F               4      SBC A,A     ;CF=1ならばA=0FFH
0016C2 E7BB 32A5EE          13      LD  (_DBDRV),A
0016C5 E7BE C9              10      RET
                                
                                ;   CDE:セクタ番号
       E7BF                     DRDY:
0016C6 E7BF 3AE8E7          13      LD  A,(_DBS24)
0016C9 E7C2 B9               4      CP  C
0016CA E7C3 C0              11      RET NZ
                                
0016CB E7C4 E5              11      PUSH    HL
0016CC E7C5 3A88EE          13      LD  A,(_DRV)
0016CF E7C8 21A5EE          10      LD  HL,_DBDRV
0016D2 E7CB AE               7      XOR (HL)
0016D3 E7CC 2005            12      JR  NZ,POP_HL_RET
                                
0016D5 E7CE 2AA6EE          16      LD  HL,(_DBSEC)
0016D8 E7D1 ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E7D3                     POP_HL_RET:
0016DA E7D3 E1              10      POP HL
0016DB E7D4 C9              10      RET
                                
       E7D5                     DWTX:
0016DC E7D5 3AA4EE          13      LD  A,(_WTDBF)
0016DF E7D8 B7               4      OR  A
0016E0 E7D9 C8              11      RET Z
0016E1 E7DA AF               4      XOR A
0016E2 E7DB 32A4EE          13      LD  (_WTDBF),A
                                
0016E5 E7DE E5              11      PUSH    HL
0016E6 E7DF C5              11      PUSH    BC
0016E7 E7E0 D5              11      PUSH    DE
0016E8 E7E1 3AA5EE          13      LD  A,(_DBDRV)
0016EB E7E4 CDD9EE          17      CALL    _CHGDRV
0016EE E7E7 0E00             7      LD  C,0
       E7E8                     _DBS24  EQU $-1
0016F0 E7E9 ED5BA6EE        20      LD  DE,(_DBSEC)
0016F4 E7ED 2A7EEF          16      LD  HL,(_DTBUF)
0016F7 E7F0 D4B5EA          17      CALL    NC,DWT24
       E7F3                     POP_DE_BC_HL_RET2:
0016FA E7F3 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E7F5                     RDFATX:
0016FC E7F5 E5              11      PUSH    HL
0016FD E7F6 3A88EE          13      LD  A,(_DRV)
001700 E7F9 21AAEE          10      LD  HL,_FATDRV
001703 E7FC AE               7      XOR (HL)
001704 E7FD 28D4            12      JR  Z,POP_HL_RET
                                
001706 E7FF C5              11      PUSH    BC
001707 E800 D5              11      PUSH    DE
001708 E801 DDE5            15      PUSH    IX
00170A E803 CD1FE8          17      CALL    WTFATX
00170D E806 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
00170F E808 AF               4      XOR A
001710 E809 32ABEE          13      LD  (_FATIX),A
001713 E80C 3A88EE          13      LD  A,(_DRV)
001716 E80F 32AAEE          13      LD  (_FATDRV),A
001719 E812 CDE5EE          17      CALL    _RDFAT
       E815                     RDFATE2:
00171C E815 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
00171E E817 9F               4      SBC A,A     ;A=0xFF
00171F E818 32AAEE          13      LD  (_FATDRV),A
       E81B                     POP_IX_DE_BC_HL_RET:
001722 E81B DDE1            14      POP IX
001724 E81D 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E81F                     WTFATX:
001726 E81F 3AA2EE          13      LD  A,(_WTFATF)
001729 E822 B7               4      OR  A
00172A E823 C8              11      RET Z
00172B E824 AF               4      XOR A
00172C E825 32A2EE          13      LD  (_WTFATF),A
                                
00172F E828 E5              11      PUSH    HL
001730 E829 3AAAEE          13      LD  A,(_FATDRV)
001733 E82C 21A5EE          10      LD  HL,_DBDRV
001736 E82F AE               7      XOR (HL)
001737 E830 CCD5E7          17      CALL    Z,DWTX
00173A E833 389E            12      JR  C,POP_HL_RET
00173C E835 C5              11      PUSH    BC
00173D E836 D5              11      PUSH    DE
00173E E837 DDE5            15      PUSH    IX
001740 E839 CDC6EA          17      CALL    FATSETUP
001743 E83C D4B7EA          17      CALL    NC,DWT24B
001746 E83F 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E841                     N16CL1:
001748 E841 7A               4      LD  A,D
001749 E842 B3               4      OR  E
00174A E843 37               4      SCF
00174B E844 C8              11      RET Z
                                
00174C E845 7A               4      LD  A,D
00174D E846 1807            12      JR  NCL1X
       E848                     NCL1:
00174F E848 7A               4      LD  A,D
001750 E849 B3               4      OR  E
001751 E84A 37               4      SCF
001752 E84B C8              11      RET Z
                                
001753 E84C 7A               4      LD  A,D
001754 E84D CB3F             8      SRL A   ;/2
       E84F                     NCL1X:
001756 E84F CB3F             8      SRL A   ;/2
                                
001758 E851 E5              11      PUSH    HL
001759 E852 3271E8          13      LD  (NCLPAT_FATIX),A    ;_FATIX
00175C E855 2AAAEE          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
00175F E858 BC               4      CP  H
001760 E859 3A88EE          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001763 E85C 3270E8          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001766 E85F 2005            12      JR  NZ,NCL2     ;FATIXが違う
001768 E861 BD               4      CP  L
001769 E862 2002            12      JR  NZ,NCL2     ;ドライブが違う
00176B E864 E1              10      POP HL
00176C E865 C9              10      RET
       E866                     NCL2:
00176D E866 C5              11      PUSH    BC
00176E E867 D5              11      PUSH    DE
00176F E868 DDE5            15      PUSH    IX
001771 E86A CD1FE8          17      CALL    WTFATX
001774 E86D 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
001776 E86F 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E871                     NCLPAT_FATIX    EQU $-1
       E870                     NCLPAT_FATDRV   EQU $-2
001779 E872 ED43AAEE        20      LD  (_FATDRV),BC
00177D E876 CD9BEA          17      CALL    RDFATS
001780 E879 189A            12      JR  RDFATE2
                                
       E87B                     NCL3:
001782 E87B CB9A             8      RES 3,D
001784 E87D CB92             8      RES 2,D
001786 E87F 6B               4      LD  L,E
001787 E880 62               4      LD  H,D
001788 E881 CB3C             8      SRL H   ;
00178A E883 CB1D             8      RR  L   ;HLA=HLA/2
00178C E885 1F               4      RRA     ;
00178D E886 F5              11      PUSH    AF
00178E E887 3AABEE          13      LD  A,(_FATIX)
001791 E88A 0F               4      RRCA
001792 E88B 300B            12      JR  NC,NCL3X1
001794 E88D 3A8DE6          13      LD  A,(SECSZ_H)
001797 E890 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの際に先頭を512バイトずらす
001799 E892 2004            12      JR  NZ,NCL3X1
00179B E894 010002          10      LD  BC,512
00179E E897 09              11      ADD HL,BC
       E898                     NCL3X1:
00179F E898 F1              10      POP AF
0017A0 E899 ED4B7CEF        20      LD  BC,(_FATBF)
0017A4 E89D 19              11      ADD HL,DE
0017A5 E89E 09              11      ADD HL,BC
0017A6 E89F 17               4      RLA
0017A7 E8A0 C9              10      RET
                                
       E8A1                     GNCL:
0017A8 E8A1 CD48E8          17      CALL    NCL1        ;GET NEXT CLUSTER
0017AB E8A4 D8              11      RET C
0017AC E8A5 C5              11      PUSH    BC
0017AD E8A6 E5              11      PUSH    HL
0017AE E8A7 CD7BE8          17      CALL    NCL3
0017B1 E8AA 3809            12      JR  C,GNC1
0017B3 E8AC 5E               7      LD  E,(HL)
0017B4 E8AD 23               6      INC HL
0017B5 E8AE 7E               7      LD  A,(HL)
0017B6 E8AF E60F             7      AND 00FH
0017B8 E8B1 57               4      LD  D,A
0017B9 E8B2 E1              10      POP HL
0017BA E8B3 C1              10      POP BC
0017BB E8B4 C9              10      RET
       E8B5                     GNC1:
0017BC E8B5 7E               7      LD  A,(HL)
0017BD E8B6 23               6      INC HL
0017BE E8B7 56               7      LD  D,(HL)
0017BF E8B8 0604             7      LD  B,4
       E8BA                     GNC1L:
0017C1 E8BA CB3A             8      SRL D   ;DA=DA/2
0017C3 E8BC 1F               4      RRA     ;
0017C4 E8BD 10FB            13      DJNZ    GNC1L
                                
0017C6 E8BF 5F               4      LD  E,A
0017C7 E8C0 E1              10      POP HL
0017C8 E8C1 C1              10      POP BC
0017C9 E8C2 A7               4      AND A
0017CA E8C3 C9              10      RET
                                
       E8C4                     SNCL:
0017CB E8C4 CD48E8          17      CALL    NCL1
0017CE E8C7 D8              11      RET C
                                ;               SET NEXT CLUSTER
0017CF E8C8 E5              11      PUSH    HL
0017D0 E8C9 C5              11      PUSH    BC
0017D1 E8CA D5              11      PUSH    DE
0017D2 E8CB E5              11      PUSH    HL
0017D3 E8CC CD7BE8          17      CALL    NCL3
0017D6 E8CF D1              10      POP DE
                                ;CF=ODD
0017D7 E8D0 7E               7      LD  A,(HL)
0017D8 E8D1 73               7      LD  (HL),E
0017D9 E8D2 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
0017DB E8D4 23               6      INC HL
0017DC E8D5 ED67            18      RRD     ;M={A[3:0],E[3:0]}
0017DE E8D7 7A               4      LD  A,D
0017DF E8D8 1804            12      JR  SNC11
       E8DA                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
0017E1 E8DA ED6F            18      RLD     ;M={D[3:0],E[7:4]}
0017E3 E8DC 23               6      INC HL
0017E4 E8DD 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E8DE                     SNC11:
0017E5 E8DE ED6F            18      RLD     ;M={M[7:4],D[3:0]}
0017E7 E8E0 B7               4      OR  A
0017E8 E8E1 D1              10      POP DE
0017E9 E8E2 C1              10      POP BC
0017EA E8E3 E1              10      POP HL
       E8E4                     FAT_CHANGED:
0017EB E8E4 3EFF             7      LD  A,0FFH
0017ED E8E6 32A2EE          13      LD  (_WTFATF),A
0017F0 E8E9 C9              10      RET
                                
       E8EA                     N16CL3:
0017F1 E8EA C5              11      PUSH    BC
0017F2 E8EB 6B               4      LD  L,E
0017F3 E8EC 7A               4      LD  A,D
0017F4 E8ED E601             7      AND 1
0017F6 E8EF 67               4      LD  H,A
0017F7 E8F0 29              11      ADD HL,HL
0017F8 E8F1 ED4B7CEF        20      LD  BC,(_FATBF)
0017FC E8F5 09              11      ADD HL,BC
0017FD E8F6 C1              10      POP BC
0017FE E8F7 C9              10      RET
                                
       E8F8                     GNCL16:
0017FF E8F8 CD41E8          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
001802 E8FB D8              11      RET C
001803 E8FC E5              11      PUSH    HL
001804 E8FD CDEAE8          17      CALL    N16CL3
001807 E900 5E               7      LD  E,(HL)
001808 E901 23               6      INC HL
001809 E902 56               7      LD  D,(HL)
00180A E903 E1              10      POP HL
00180B E904 C9              10      RET
                                
       E905                     SNCL16:
00180C E905 CD41E8          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
00180F E908 D8              11      RET C
001810 E909 D5              11      PUSH    DE
001811 E90A E5              11      PUSH    HL
001812 E90B CDEAE8          17      CALL    N16CL3
001815 E90E D1              10      POP DE      ;HL
001816 E90F 73               7      LD  (HL),E
001817 E910 23               6      INC HL
001818 E911 72               7      LD  (HL),D
001819 E912 6B               4      LD  L,E
00181A E913 62               4      LD  H,D
00181B E914 D1              10      POP DE
00181C E915 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E917                     NEXTX:
00181E E917 3E00             7      LD  A,0 ;自己書き換え
       E918                     _SECPS  EQU $-1
001820 E919 3C               4      INC A
001821 E91A E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E91B                     _NCPAT  EQU $-1
001823 E91C 3218E9          13      LD  (_SECPS),A
001826 E91F C9              10      RET
                                
       E920                     GNCLX:
001827 E920 CD17E9          17      CALL    NEXTX
00182A E923 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
00182B E924 C3F7EE          10      JP  _GNCL   ;次のクラスタを探す
                                
       E927                     RDFAT:
00182E E927 3E80             7      LD  A,080H
001830 E929 3270EE          13      LD  (CHECK),A
       E92C                     RDFAT1:
001833 E92C 3A88EE          13      LD  A,(_DRV)
001836 E92F CDCFEB          17      CALL    CHGDRVR
001839 E932 D8              11      RET C
00183A E933 DD7E12          19      LD  A,(IX+DPB_DEVICE)
00183D E936 CB6F             8      BIT 5,A
00183F E938 286C            12      JR  Z,RDFAT0X
001841 E93A 2170EE          10      LD  HL,CHECK
001844 E93D A6               7      AND (HL)
001845 E93E 77               7      LD  (HL),A
001846 E93F 110000          10      LD  DE,0        ;BPB
001849 E942 2A7CEF          16      LD  HL,(_FATBF)
00184C E945 0E00             7      LD  C,0
00184E E947 CDA7EA          17      CALL    DRD24
001851 E94A 3022            12      JR  NC,GETBPB
001853 E94C 2170EE          10      LD  HL,CHECK
001856 E94F CB06            15      RLC (HL)
001858 E951 3F               4      CCF
001859 E952 D8              11      RET C
00185A E953 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
00185E E957 3F               4      CCF         ;フロッピーディスクのFDモード(2D/2HD)を切り替える
00185F E958 DDCB0A16        23      RL  (IX+DPB_FDMODE)
001863 E95C 3A84EE          13      LD  A,(_DRIVE)
001866 E95F E603             7      AND 3
001868 E961 F680             7      OR  080H
00186A E963 6F               4      LD  L,A
00186B E964 26EE             7      LD  H,_CYL0/256
00186D E966 3EFF             7      LD  A,0FFH
00186F E968 3289EE          13      LD  (_DSK),A
001872 E96B 77               7      LD  (HL),A
001873 E96C 18BE            12      JR  RDFAT1
       E96E                     GETBPB:
001875 E96E FDE5            15      PUSH    IY
001877 E970 FD2A7CEF        20      LD  IY,(_FATBF) ;BPB
00187B E974 CDF1EE          17      CALL    _BPB2DPB
00187E E977 FDE1            14      POP IY
001880 E979 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001883 E97C 3025            12      JR  NC,GETBPBOK
001885 E97E E60F             7      AND 00FH
001887 E980 FE07             7      CP  7
001889 E982 37               4      SCF
00188A E983 C0              11      RET NZ
00188B E984 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
00188F E988 21C0EF          10      LD  HL,M2D
001892 E98B 2006            12      JR  NZ,SETFDMODE
001894 E98D CD80EA          17      CALL    CHECK1024
001897 E990 D8              11      RET C
001898 E991 2ED2             7      LD  L,M2HD-STABLE
       E993                     SETFDMODE:
00189A E993 DDE5            15      PUSH    IX
00189C E995 D1              10      POP DE
00189D E996 EDA0            16      LDI
00189F E998 EDA0            16      LDI
0018A1 E99A 13               6      INC DE
0018A2 E99B 13               6      INC DE
0018A3 E99C 13               6      INC DE
0018A4 E99D 13               6      INC DE
0018A5 E99E 010C00          10      LD  BC,12
0018A8 E9A1 EDB0                    LDIR
       E9A3                     GETBPBOK:
0018AA E9A3 CD3BEB          17      CALL    CHGDRV2
       E9A6                     RDFAT0X:
0018AD E9A6 CD9BEA          17      CALL    RDFATS
0018B0 E9A9 D8              11      RET C
0018B1 E9AA DDAE06          19      XOR (IX+DPB_FATID)
0018B4 E9AD C8              11      RET Z
0018B5 E9AE DD7E12          19      LD  A,(IX+DPB_DEVICE)
0018B8 E9B1 CB5F             8      BIT 3,A
0018BA E9B3 2803            12      JR  Z,RDFAT0X1
0018BC E9B5 CB6F             8      BIT 5,A
0018BE E9B7 C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E9B8                     RDFAT0X1:
0018BF E9B8 37               4      SCF
0018C0 E9B9 C9              10      RET
                                
       E9BA                     POP_HL_SCF_RET:
0018C1 E9BA E1              10      POP HL
0018C2 E9BB 37               4      SCF
0018C3 E9BC C9              10      RET
                                
       E9BD                     BPB2DPB:
0018C4 E9BD FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
0018C7 E9C0 B7               4      OR  A
0018C8 E9C1 37               4      SCF
0018C9 E9C2 C0              11      RET NZ
       E9C3                     BPBOK:
0018CA E9C3 FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
0018CD E9C6 DD7707          19      LD  (IX+DPB_SECPCL),A
                                
0018D0 E9C9 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
0018D3 E9CC DD7700          19      LD  (IX+DPB_FATLN),A
0018D6 E9CF FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
0018D9 E9D2 DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
0018DC E9D5 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
0018DF E9D8 FD660F          19      LD  H,(IY+15)
0018E2 E9DB DD750E          19      LD  (IX+DPB_FATPS),L
0018E5 E9DE FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
0018E8 E9E1 FD5617          19      LD  D,(IY+23)
0018EB E9E4 FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E9E7                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
0018EE E9E7 19              11      ADD HL,DE
0018EF E9E8 10FD            13      DJNZ    BPBDP1
       E9EA                     BPBDP2:
0018F1 E9EA DD7510          19      LD  (IX+DPB_DIRPS),L
0018F4 E9ED DD7411          19      LD  (IX+DPB_DIRPS+1),H
0018F7 E9F0 E5              11      PUSH    HL
                                
0018F8 E9F1 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
0018FB E9F4 FD6612          19      LD  H,(IY+18)
0018FE E9F7 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001901 E9FA B7               4      OR  A
001902 E9FB 28BD            12      JR  Z,POP_HL_SCF_RET
001904 E9FD 0606             7      LD  B,6
       E9FF                     BPBBPS1:
001906 E9FF 05               4      DEC B
001907 EA00 0F               4      RRCA
001908 EA01 30FC            12      JR  NC,BPBBPS1
       EA03                     BPBDE1:
00190A EA03 29              11      ADD HL,HL
00190B EA04 10FD            13      DJNZ    BPBDE1
                                
00190D EA06 7C               4      LD  A,H
00190E EA07 DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
001911 EA0A D1              10      POP DE      ;DPB_DIRPS
001912 EA0B 6C               4      LD  L,H
001913 EA0C 2600             7      LD  H,0
001915 EA0E 19              11      ADD HL,DE       ;MAXDIR
001916 EA0F E5              11      PUSH    HL
001917 EA10 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
00191A EA13 CB21             8      SLA C       ;*2
00191C EA15 AF               4      XOR A
00191D EA16 47               4      LD  B,A
00191E EA17 ED42            15      SBC HL,BC
001920 EA19 DD7514          19      LD  (IX+DPB_ADDCL),L
001923 EA1C DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
001926 EA1F D1              10      POP DE      ;DE=DPB_MAXDIR
001927 EA20 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
00192A EA23 FD6614          19      LD  H,(IY+20)
                                
00192D EA26 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001930 EA29 E60F             7      AND 00FH
001932 EA2B FE07             7      CP  7       ;フロッピー
001934 EA2D 2019            12      JR  NZ,NOT_FD
001936 EA2F E5              11      PUSH    HL
001937 EA30 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
00193A EA33 DD710D          19      LD  (IX+DPB_MAXSEC),C
00193D EA36 AF               4      XOR A
00193E EA37 CB21             8      SLA C       ;両面なのでセクタ数を２倍
001940 EA39 0610             7      LD  B,16
       EA3B                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001942 EA3B 29              11      ADD HL,HL
001943 EA3C 17               4      RLA
001944 EA3D B9               4      CP  C
001945 EA3E 3802            12      JR  C,DIVSEC1
001947 EA40 91               4      SUB C
001948 EA41 2C               4      INC L
       EA42                     DIVSEC1:
001949 EA42 10F7            13      DJNZ    DIVSEC
00194B EA44 DD750C          19      LD  (IX+DPB_MAXCYL),L
00194E EA47 E1              10      POP HL  ;ここまでフロッピー専用
       EA48                     NOT_FD:
00194F EA48 7C               4      LD  A,H
001950 EA49 B5               4      OR  L
001951 EA4A 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001953 EA4C 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001955 EA4E 2F               4      CPL         ;A=0FFH
001956 EA4F FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001959 EA52 D8              11      RET C
00195A EA53 FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
00195D EA56 FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001960 EA59 FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       EA5C                     BPB16BIT:
001963 EA5C ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001965 EA5E DE00             7      SBC A,0
001967 EA60 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       EA63                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
00196A EA63 CB18             8      RR  B       ;->CY
00196C EA65 3808            12      JR  C,BPBTC2
00196E EA67 CB3F             8      SRL A
001970 EA69 CB1C             8      RR  H       ;AHL=AHL/2
001972 EA6B CB1D             8      RR  L
001974 EA6D 18F4            12      JR  BPBTC1
       EA6F                     BPBTC2:
001976 EA6F C6FF             7      ADD A,0FFH
001978 EA71 D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001979 EA72 23               6      INC HL
00197A EA73 23               6      INC HL
00197B EA74 DD7508          19      LD  (IX+DPB_MAXCL),L
00197E EA77 DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001981 EA7A FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001984 EA7D DD7706          19      LD  (IX+DPB_FATID),A
       EA80                     CHECK1024:
001987 EA80 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
00198A EA83 C6FE             7      ADD A,0-2       ;>2:CF=1
00198C EA85 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
00198F EA88 6F               4      LD  L,A
001990 EA89 3002            12      JR  NC,BPBFAT1
001992 EA8B F680             7      OR  080H
       EA8D                     BPBFAT1:            ;ここではCF=0
001994 EA8D DD770F          19      LD  (IX+DPB_BPS),A
001997 EA90 3A7BEF          13      LD  A,(_MAX_SEC_SZ_H)
00199A EA93 BD               4      CP  L
00199B EA94 C8              11      RET Z       ;1セクタ1024バイト
00199C EA95 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
00199D EA96 C8              11      RET Z       ;1セクタ256バイト
00199E EA97 2D               4      DEC L
00199F EA98 C8              11      RET Z       ;1セクタ512バイト
0019A0 EA99 37               4      SCF
0019A1 EA9A C9              10      RET
                                
       EA9B                     RDFATS:
0019A2 EA9B CDC6EA          17      CALL    FATSETUP
0019A5 EA9E D8              11      RET C
0019A6 EA9F CDA9EA          17      CALL    DRD24B
0019A9 EAA2 2A7CEF          16      LD  HL,(_FATBF)
0019AC EAA5 7E               7      LD  A,(HL)
0019AD EAA6 C9              10      RET
                                
       EAA7                     DRD24:
0019AE EAA7 0601             7      LD  B,1
       EAA9                     DRD24B:
0019B0 EAA9 DDE5            15      PUSH    IX
0019B2 EAAB DD2AA8EE        20      LD  IX,(_DPB)
0019B6 EAAF CDF0EC          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       EAB0                     DRDPAT  EQU $-2
0019B9 EAB2 DDE1            14      POP IX
0019BB EAB4 C9              10      RET
                                
       EAB5                     DWT24:
0019BC EAB5 0601             7      LD  B,1
       EAB7                     DWT24B:
0019BE EAB7 DDE5            15      PUSH    IX
0019C0 EAB9 DD2AA8EE        20      LD  IX,(_DPB)
0019C4 EABD CDE2EC          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       EABE                     DWTPAT  EQU $-2
0019C7 EAC0 DDE1            14      POP IX
0019C9 EAC2 D0              11      RET NC
0019CA EAC3 C35AEE          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       EAC6                     FATSETUP:
0019CD EAC6 3AAAEE          13      LD  A,(_FATDRV)
0019D0 EAC9 CDCFEB          17      CALL    CHGDRVR     ;ドライブ切り替え
0019D3 EACC D8              11      RET C
       EACD                     FATS2:
0019D4 EACD DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
0019D7 EAD0 0F               4      RRCA
0019D8 EAD1 CD01EB          17      CALL    FATSETUP12  ;自己書き換え
       EAD2                     FATSX   EQU $-2
0019DB EAD4 210000          10      LD  HL,0
0019DE EAD7 4A               4      LD  C,D
0019DF EAD8 54               4      LD  D,H
0019E0 EAD9 3AABEE          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
0019E3 EADC 47               4      LD  B,A
0019E4 EADD 04               4      INC B
0019E5 EADE DD7E00          19      LD  A,(IX+DPB_FATLN)
       EAE1                     FAT_SKP:
0019E8 EAE1 05               4      DEC B
0019E9 EAE2 2809            12      JR  Z,FAT1
0019EB EAE4 19              11      ADD HL,DE
0019EC EAE5 93               4      SUB E
0019ED EAE6 30F9            12      JR  NC,FAT_SKP
0019EF EAE8 DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
0019F3 EAEC C8              11      RET Z
       EAED                     FAT1:
0019F4 EAED EB               4      EX  DE,HL
0019F5 EAEE B7               4      OR  A       ;0の場合は0100Hとして扱う
0019F6 EAEF 2803            12      JR  Z,FAT3
0019F8 EAF1 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
0019F9 EAF2 3801            12      JR  C,FAT2
       EAF4                     FAT3:
0019FB EAF4 79               4      LD  A,C
       EAF5                     FAT2:
0019FC EAF5 47               4      LD  B,A
                                
0019FD EAF6 2AFAEF          16      LD  HL,(_FATPS) ;fat sector pos
001A00 EAF9 19              11      ADD HL,DE
001A01 EAFA EB               4      EX  DE,HL
001A02 EAFB 2A7CEF          16      LD  HL,(_FATBF)
001A05 EAFE AF               4      XOR A       ;CF=0
001A06 EAFF 4F               4      LD  C,A
001A07 EB00 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       EB01                     FATSETUP12:
001A08 EB01 110606          10      LD  DE,0606H    ;256
001A0B EB04 D8              11      RET C
001A0C EB05 110303          10      LD  DE,0303H    ;512
001A0F EB08 0F               4      RRCA
001A10 EB09 D8              11      RET C
001A11 EB0A 110102          10      LD  DE,0201H    ;1024
001A14 EB0D C9              10      RET
                                
       EB0E                     FATSETUP16:
001A15 EB0E 110404          10      LD  DE,0404H    ;256
001A18 EB11 D8              11      RET C
001A19 EB12 110202          10      LD  DE,0202H    ;512
001A1C EB15 0F               4      RRCA
001A1D EB16 D8              11      RET C
001A1E EB17 110101          10      LD  DE,0101H    ;1024
001A21 EB1A C9              10      RET
                                
       EB1B                     CHGDRV:
001A22 EB1B E5              11      PUSH    HL
001A23 EB1C 2189EE          10      LD  HL,_DSK
001A26 EB1F BE               7      CP  (HL)
001A27 EB20 280A            12      JR  Z,CHGDRVE
       EB22                     CHGDRV1:
001A29 EB22 DDE5            15      PUSH    IX
001A2B EB24 CD2EEB          17      CALL    CHGDRV0
001A2E EB27 3A89EE          13      LD  A,(_DSK)
001A31 EB2A DDE1            14      POP IX
       EB2C                     CHGDRVE:
001A33 EB2C E1              10      POP HL
001A34 EB2D C9              10      RET
                                
       EB2E                     CHGDRV0:
001A35 EB2E 6F               4      LD  L,A
001A36 EB2F CDDCEE          17      CALL    _GETDPB
001A39 EB32 D8              11      RET C
001A3A EB33 DD22A8EE        20      LD  (_DPB),IX
001A3E EB37 7D               4      LD  A,L
001A3F EB38 3289EE          13      LD  (_DSK),A
       EB3B                     CHGDRV2:
001A42 EB3B C5              11      PUSH    BC
001A43 EB3C D5              11      PUSH    DE
001A44 EB3D ED7386EB        20      LD  (SPPAT2),SP
001A48 EB41 F3               4      DI
001A49 EB42 DDF9            10      LD  SP,IX
                                
001A4B EB44 E1              10      POP HL      ;00:DPB_FATLN
001A4C EB45 E1              10      POP HL      ;02:DPB_DRD
001A4D EB46 22B0EA          16      LD  (DRDPAT),HL
                                
001A50 EB49 E1              10      POP HL
001A51 EB4A 22BEEA          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001A54 EB4D E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001A55 EB4E 7C               4      LD  A,H
001A56 EB4F 32FFF2          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001A59 EB52 3D               4      DEC A
001A5A EB53 321BE9          13      LD  (_NCPAT),A
                                
001A5D EB56 E1              10      POP HL      ;08:DPB_MAXCL
001A5E EB57 7D               4      LD  A,L
001A5F EB58 321EF3          13      LD  (CLPAT2),A
001A62 EB5B 7C               4      LD  A,H
001A63 EB5C 321AF3          13      LD  (CLPAT1),A
001A66 EB5F 2B               6      DEC HL
001A67 EB60 221DF5          16      LD  (MAXCLP),HL
                                
001A6A EB63 E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001A6B EB64 4C               4      LD  C,H
                                
001A6C EB65 E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001A6D EB66 E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001A6E EB67 7C               4      LD  A,H     ;DPB_BPS
001A6F EB68 E607             7      AND 7
001A71 EB6A 328DE6          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001A74 EB6D 87               4      ADD A,A     ;8  4   2
001A75 EB6E 87               4      ADD A,A     ;010H   8   4
001A76 EB6F 87               4      ADD A,A     ;020H   010H    8
001A77 EB70 327DF1          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001A7A EB73 2600             7      LD  H,0
001A7C EB75 22FAEF          16      LD  (_FATPS),HL
                                
001A7F EB78 E1              10      POP HL      ;10:DPB_DIRPS
001A80 EB79 22FCEF          16      LD  (_DIRPS),HL
                                
001A83 EB7C E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001A84 EB7D 7C               4      LD  A,H
001A85 EB7E 3284EE          13      LD  (_DRIVE),A
                                
001A88 EB81 E1              10      POP HL      ;14:DPB_ADDCL
001A89 EB82 220FF3          16      LD  (CLSPAT),HL
                                
001A8C EB85 310000          10      LD  SP,0        ;元のSPを復元
       EB86                     SPPAT2  EQU $-2
001A8F EB88 FB               4      EI
001A90 EB89 2AFCEF          16      LD  HL,(_DIRPS)
001A93 EB8C 0600             7      LD  B,0
001A95 EB8E 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001A96 EB8F 2298F1          16      LD  (MD_PAT),HL
                                
001A99 EB92 2A1DF5          16      LD  HL,(MAXCLP)
001A9C EB95 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001A9F EB98 19              11      ADD HL,DE
001AA0 EB99 380F            12      JR  C,SETFAT16
001AA2 EB9B 21A1E8          10      LD  HL,GNCL     ;FAT12
001AA5 EB9E 11C4E8          10      LD  DE,SNCL
001AA8 EBA1 0101EB          10      LD  BC,FATSETUP12
001AAB EBA4 DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001AAF EBA8 180D            12      JR  EXTRA1
       EBAA                     SETFAT16:
001AB1 EBAA 21F8E8          10      LD  HL,GNCL16   ;FAT16
001AB4 EBAD 1105E9          10      LD  DE,SNCL16
001AB7 EBB0 010EEB          10      LD  BC,FATSETUP16
001ABA EBB3 DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       EBB7                     EXTRA1:
001ABE EBB7 22F8EE          16      LD  (GNCPAT),HL
001AC1 EBBA ED53FBEE        20      LD  (SNCPAT),DE
001AC5 EBBE ED43D2EA        20      LD  (FATSX),BC
001AC9 EBC2 D1              10      POP DE
001ACA EBC3 C1              10      POP BC
001ACB EBC4 AF               4      XOR A
001ACC EBC5 C9              10      RET
                                
       EBC6                     GETDPBD:
001ACD EBC6 DDE3            23      EX  (SP),IX
001ACF EBC8 DDE5            15      PUSH    IX
001AD1 EBCA 3A88EE          13      LD  A,(_DRV)
001AD4 EBCD 1807            12      JR  GETDPB1
                                
       EBCF                     CHGDRVR:
001AD6 EBCF CDD9EE          17      CALL    _CHGDRV
001AD9 EBD2 D8              11      RET C
001ADA EBD3 3A89EE          13      LD  A,(_DSK)
       EBD6                     GETDPB1:
001ADD EBD6 C3DCEE          10      JP  _GETDPB
                                
       EBD9                     GETDPB:
001AE0 EBD9 FE08             7      CP  8
001AE2 EBDB 3F               4      CCF
001AE3 EBDC D8              11      RET C
001AE4 EBDD 0F               4      RRCA
001AE5 EBDE 0F               4      RRCA
001AE6 EBDF 0F               4      RRCA
001AE7 EBE0 DD                      DB  0DDH        ;Z80未定義命令
001AE8 EBE1 6F               4      LD  L,A     ;LD IXL,A
001AE9 EBE2 DD                      DB  0DDH        ;Z80未定義命令
001AEA EBE3 26F6             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001AEC EBE5 DD7E00          19      LD  A,(IX+DPB_FATLN)
001AEF EBE8 A7               4      AND A       ;CF=0の為
001AF0 EBE9 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001AF4 EBED C0              11      RET NZ      ;FAT16
001AF5 EBEE DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001AF9 EBF2 C0              11      RET NZ      ;BPB
001AFA EBF3 FE01             7      CP  001H        ;A=0 THEN CF=1
001AFC EBF5 C9              10      RET
                                
       EBF6                     _SYS5F:
001AFD EBF6 AF               4      XOR A
       EBF7                     FFLUSH:
001AFE EBF7 F5              11      PUSH    AF
001AFF EBF8 CD1FE8          17      CALL    WTFATX
001B02 EBFB AF               4      XOR A
001B03 EBFC 32ABEE          13      LD  (_FATIX),A
001B06 EBFF 2F               4      CPL         ;0FFH
001B07 EC00 32AAEE          13      LD  (_FATDRV),A
001B0A EC03 3E                      DB  03EH        ;次のPUSH AFをスキップ
       EC04                     FFLUSHBUF:
001B0B EC04 F5              11      PUSH    AF
001B0C EC05 CDD5E7          17      CALL    DWTX
001B0F EC08 3EFF             7      LD  A,0FFH
001B11 EC0A 3239EE          13      LD  (SFILE),A
001B14 EC0D 32A5EE          13      LD  (_DBDRV),A
001B17 EC10 F1              10      POP AF
001B18 EC11 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "X1DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   X1/turbo/Z
                                
       EC12                     SEEK:
001B19 EC12 0610             7      LD  B,16
001B1B EC14 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001B1E EC17 AF               4      XOR A
001B1F EC18 EB               4      EX  DE,HL
       EC19                     DIV1:
001B20 EC19 29              11      ADD HL,HL
001B21 EC1A 8F               4      ADC A,A
001B22 EC1B B9               4      CP  C
001B23 EC1C 3802            12      JR  C,DIV2
001B25 EC1E 91               4      SUB C
001B26 EC1F 2C               4      INC L
       EC20                     DIV2:
001B27 EC20 10F7            13      DJNZ    DIV1
                                
001B29 EC22 3C               4      INC A   ;最小のセクタは１固定
001B2A EC23 55               4      LD  D,L ;TRACK
001B2B EC24 5F               4      LD  E,A ;SECTOR
001B2C EC25 CB3A             8      SRL D   ;CYLINDER
001B2E EC27 9F               4      SBC A,A
001B2F EC28 E610             7      AND 010H    ;SIDE
001B31 EC2A 4F               4      LD  C,A
                                
001B32 EC2B 3A84EE          13      LD  A,(_DRIVE)
001B35 EC2E E603             7      AND 3
001B37 EC30 B1               4      OR  C
001B38 EC31 3284EE          13      LD  (_DRIVE),A  ;サイド選択とドライブを保存
001B3B EC34 01FC0F          10      LD  BC,00FFCH   ;モーター制御、サイド選択、 ドライブ選択
001B3E EC37 F680             7      OR  080H        ;Motor on
001B40 EC39 ED79            12      OUT (C),A
                                
001B42 EC3B CD82EC          17      CALL    SETMODE
001B45 EC3E D8              11      RET C
                                
001B46 EC3F CDCCEC          17      CALL    DRIVE
001B49 EC42 FEFF             7      CP  0FFH        ;A=0FFH Unknown CYLINDER
001B4B EC44 CCA7EC          17      CALL    Z,FDCRES    ;Restore
001B4E EC47 0EF9             7      LD  C,0F9H      ;MB8877A トラックレジスタ
001B50 EC49 ED79            12      OUT (C),A       ;Currrent CYLINDER
001B52 EC4B 92               4      SUB D
001B53 EC4C C8              11      RET Z       ;No seek シークの必要なし
                                
001B54 EC4D 3A86EE          13      LD  A,(_ISEEK)
001B57 EC50 4F               4      LD  C,A
                                
001B58 EC51 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)
001B5B EC54 3D               4      DEC A
001B5C EC55 BA               4      CP  D       ;Over CYLINDER
001B5D EC56 D8              11      RET C
                                
001B5E EC57 B9               4      CP  C
001B5F EC58 3809            12      JR  C,SETM2     ;2D
001B61 EC5A DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001B65 EC5E 2803            12      JR  Z,SETM2     ;2HD
001B67 EC60 78               4      LD  A,B     ;2DD
001B68 EC61 DBFE            11      IN  A,(0FEH)    ;1.6M(2HD) タイプ指定 (turbo/Z/CZ-8BF1のみ)
       EC63                     SETM2:
001B6A EC63 0EFB             7      LD  C,0FBH      ;MB8877A データレジスタ
001B6C EC65 ED51            12      OUT (C),D
001B6E EC67 72               7      LD  (HL),D
001B6F EC68 0E18             7      LD  C,018H      ;FDC TypeIコマンド Seek
       EC6A                     FDCCMD2:
001B71 EC6A 3A85EE          13      LD  A,(_SEEKSP)
001B74 EC6D B1               4      OR  C
                                
       EC6E                     FDCCMD:
001B75 EC6E CDC2EC          17      CALL    COMSET
                                
001B78 EC71 3E80             7      LD  A,080H      ;FDC COMMAND(Self-modifying code)
       EC72                     FDCSWC  EQU $-1
001B7A EC73 E620             7      AND 020H        ;Write data Write track
001B7C EC75 3C               4      INC A
                                
       EC76                     SST:
001B7D EC76 0E00             7      LD  C,0
       EC78                     SST1:
001B7F EC78 0D               4      DEC C       ; 4
001B80 EC79 20FD            12      JR  NZ,SST1     ;12 * 256 / 4 = About 1ms
001B82 EC7B 3D               4      DEC A
001B83 EC7C 20FA            12      JR  NZ,SST1
                                
001B85 EC7E 3C               4      INC A       ;A=1
001B86 EC7F CD8FEC          17      CALL    READY
       EC82                     SETMODE:
001B89 EC82 DD4E0A          19      LD  C,(IX+DPB_FDMODE)   ;フロッピーディスクのモード
001B8C EC85 ED78            12      IN  A,(C)
                                
001B8E EC87 78               4      LD  A,B
001B8F EC88 DBFD            11      IN  A,(0FDH)    ;MFM 方式指定
                                
001B91 EC8A CDC6EC          17      CALL    DELAY0      ;Head select time
001B94 EC8D 3E81             7      LD  A,081H      ;NOT READY,BUSY
       EC8F                     READY:
001B96 EC8F E5              11      PUSH    HL
001B97 EC90 67               4      LD  H,A
001B98 EC91 0EF8             7      LD  C,0F8H      ;MB8877A ステータス／コマンドレジスタ
001B9A EC93 69               4      LD  L,C
       EC94                     READY2:
001B9B EC94 ED78            12      IN  A,(C)
001B9D EC96 A4               4      AND H
001B9E EC97 280C            12      JR  Z,READYE
001BA0 EC99 3E1A             7      LD  A,1AH
001BA2 EC9B DB01            11      IN  A,(01H)
001BA4 EC9D 07               4      RLCA
001BA5 EC9E AD               4      XOR L
001BA6 EC9F 0F               4      RRCA
001BA7 ECA0 30F2            12      JR  NC,READY2
001BA9 ECA2 2D               4      DEC L
001BAA ECA3 20EF            12      JR  NZ,READY2
       ECA5                     READYE:
001BAC ECA5 E1              10      POP HL
001BAD ECA6 C9              10      RET
                                
       ECA7                     FDCRES:
001BAE ECA7 3600            10      LD  (HL),0
001BB0 ECA9 0E08             7      LD  C,8     ;FDC TypeIコマンド Restore
001BB2 ECAB 18BD            12      JR  FDCCMD2
                                
       ECAD                     FDMOFF:
001BB4 ECAD F5              11      PUSH    AF
001BB5 ECAE C5              11      PUSH    BC      ;Motor off
001BB6 ECAF 01FC0F          10      LD  BC,00FFCH   ;モーター制御、サイド選択、 ドライブ選択
001BB9 ECB2 3A84EE          13      LD  A,(_DRIVE)
001BBC ECB5 ED79            12      OUT (C),A
001BBE ECB7 C1              10      POP BC
001BBF ECB8 F1              10      POP AF
001BC0 ECB9 C9              10      RET
                                
       ECBA                     SECSET_FDCCMD:
001BC1 ECBA 3A72EC          13      LD  A,(FDCSWC)
       ECBD                     SECSET:
001BC4 ECBD 01FA0F          10      LD  BC,00FFAH   ;MB8877A セレクタレジスタ
001BC7 ECC0 ED59            12      OUT (C),E
       ECC2                     COMSET:
001BC9 ECC2 0EF8             7      LD  C,0F8H      ;MB8877A ステータス／コマンドレジスタ
001BCB ECC4 ED79            12      OUT (C),A
       ECC6                     DELAY0:
001BCD ECC6 3E1A             7      LD  A,26
       ECC8                     DELAY:
001BCF ECC8 3D               4      DEC A
001BD0 ECC9 20FD            12      JR  NZ,DELAY
001BD2 ECCB C9              10      RET
                                
       ECCC                     DRIVE:                  ;ドライブのシリンダを得る
001BD3 ECCC DD6E13          19      LD  L,(IX+DPB_UNITNO)
001BD6 ECCF 26EE             7      LD  H,_CYL0/256
001BD8 ECD1 CBFD             8      SET 7,L
001BDA ECD3 7E               7      LD  A,(HL)
001BDB ECD4 C9              10      RET
                                
       ECD5                     RNF:                    ;ドライブのシリンダをリセット
001BDC ECD5 CDCCEC          17      CALL    DRIVE
001BDF ECD8 36FF            10      LD  (HL),0FFH
001BE1 ECDA C9              10      RET
                                
001BE2 ECDB 02                  RETRY:  DB  2
                                
                                
                                ;   FLOPPY DISK DRIVER(DMA)
                                
                                
       ECDC                     WTTRK:
001BE3 ECDC 0601             7      LD  B,1
001BE5 ECDE 3EF4             7      LD  A,0F4H      ;FDC TypeIIIコマンド Write Track
001BE7 ECE0 1802            12      JR  WTTRK1
       ECE2                     FDWT:
001BE9 ECE2 3EA0             7      LD  A,0A0H      ;FDC TypeIIコマンド Write Sector
       ECE4                     WTTRK1:
001BEB ECE4 3272EC          13      LD  (FDCSWC),A
001BEE ECE7 3E79             7      LD  A,079H      ;WR0 ポートB←ポートB 転送  （書き込み）
001BF0 ECE9 180C            12      JR  DISK
                                
       ECEB                     DISKOK:
001BF2 ECEB 0601             7      LD  B,1
       ECEC                     FDCNT   EQU $-1
001BF4 ECED 100B            13      DJNZ    DISK1
001BF6 ECEF C9              10      RET
                                
       ECF0                     FDRD:
001BF7 ECF0 3E80             7      LD  A,080H      ;FDC TypeIIコマンド Read Sector
001BF9 ECF2 3272EC          13      LD  (FDCSWC),A
001BFC ECF5 3E7D             7      LD  A,07DH      ;WR0 ポートA→ポートB 転送  （読み込み)
                                
       ECF7                     DISK:
001BFE ECF7 3257ED          13      LD  (DMASWC),A
       ECFA                     DISK1:
001C01 ECFA 78               4      LD  A,B
001C02 ECFB 32ECEC          13      LD  (FDCNT),A
001C05 ECFE 2261ED          16      LD  (DMAHL),HL
       ED01                     DISKR:
001C08 ED01 3E02             7      LD  A,2     ;Retry count
001C0A ED03 32DBEC          13      LD  (RETRY),A
       ED06                     DISK2:
001C0D ED06 D5              11      PUSH    DE
001C0E ED07 CD12EC          17      CALL    SEEK
001C11 ED0A 383E            12      JR  C,ERRF
001C13 ED0C F3               4      DI
                                
001C14 ED0D 3E0F             7      LD  A,DMAE-DMAD
001C16 ED0F 2156ED          10      LD  HL,DMAD
001C19 ED12 CDC8E3          17      CALL    SETDMA
001C1C ED15 C5              11      PUSH    BC
001C1D ED16 CDBAEC          17      CALL    SECSET_FDCCMD
001C20 ED19 2A61ED          16      LD  HL,(DMAHL)
001C23 ED1C 23               6      INC HL
001C24 ED1D 1106BB          10      LD  DE,0BB06H   ;READ DMA
                                
001C27 ED20 3E03             7      LD  A,3
001C29 ED22 CD8FEC          17      CALL    READY
001C2C ED25 ED78            12      IN  A,(C)
                                
001C2E ED27 C1              10      POP BC
001C2F ED28 ED51            12      OUT (C),D       ;読み出しマスク設定
001C31 ED2A ED59            12      OUT (C),E       ;バイトカウンタ(LH)
001C33 ED2C ED58            12      IN  E,(C)
001C35 ED2E ED50            12      IN  D,(C)
001C37 ED30 19              11      ADD HL,DE
001C38 ED31 D1              10      POP DE
001C39 ED32 13               6      INC DE
001C3A ED33 FB               4      EI
001C3B ED34 CDADEC          17      CALL    FDMOFF
001C3E ED37 B7               4      OR  A
001C3F ED38 28B1            12      JR  Z,DISKOK
001C41 ED3A 1B               6      DEC DE
001C42 ED3B CB67             8      BIT 4,A
001C44 ED3D C4D5EC          17      CALL    NZ,RNF
       ED40                     DISKE2:
001C47 ED40 21DBEC          10      LD  HL,RETRY
001C4A ED43 35              11      DEC (HL)
001C4B ED44 20C0            12      JR  NZ,DISK2
001C4D ED46 B7               4      OR  A
001C4E ED47 280A            12      JR  Z,ERR
001C50 ED49 D5              11      PUSH    DE
       ED4A                     ERRF:
001C51 ED4A D1              10      POP DE
       ED4B                     DELP:
001C52 ED4B CDD5EC          17      CALL    RNF
001C55 ED4E CDADEC          17      CALL    FDMOFF
001C58 ED51 3EFF             7      LD  A,0FFH
       ED53                     ERR:
001C5A ED53 BF               4      CP  A
001C5B ED54 37               4      SCF
001C5C ED55 C9              10      RET
                                
       ED56                     DMAD:           ;X1turbo DISK DMA
001C5D ED56 C3                      DB  0C3H    ;WR6 リセット
001C5E ED57 7D                  DMASWC: DB  07DH    ;WR0 ポートA→ポートB 転送  （読み込み）
                                ;   DB  079H    ;WR0 ポートB←ポートB 転送  （書き込み）
001C5F ED58 FB0F                    DW  00FFBH  ;ポートA開始アドレス (FDC MB8877A データレジスタ)
001C61 ED5A FFFF                    DW  0FFFFH  ;ブロック長(転送サイズ-1)
001C63 ED5C 2C                      DB  02CH    ;WR1 ポートAアドレス固定 I/O
001C64 ED5D 10                      DB  010H    ;WR2 ポートBインクリメント
001C65 ED5E 80                      DB  080H    ;WR3
001C66 ED5F 92                      DB  092H    ;WR5 WAIT RDY:LOW
001C67 ED60 8D                      DB  08DH    ;WR4 バイト ポートB開始アドレス(LH)
001C68 ED61 0000                DMAHL:  DW  0   ;ポートB開始アドレス
001C6A ED63 CF                      DB  0CFH    ;WR6 ロード
001C6B ED64 87                      DB  087H    ;WR6 イネーブル
       ED65                     DMAE:
                                
       1732                     AT_R    EQU WTTRK-AT_DWT
       ED65                     AT_TABLE:
[EOF:X1DISK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001C6C ED65                     PATHD:  DS  PATHX
001CA7 EDA0 00                  PATHE:  DB  0
                                
       EDA1                     DTA_CCP:
001CA8 EDA1                         DS  37
                                
       EDC6                     FCB_BAT:
001CCD EDC6                         DS  37
                                
001CF2 EDEB 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001CFD EDF6 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
                                ;   ALIGN   256
       EDFD                     AT_WORK:
001D04 EDFD                         DS  WORKAD-AT_WORK
                                
       EE00                     CPM_BOOT:
001D07 EE00 C30000          10      JP  0
       EE03                     _SYS00:     ;(BDOS)プログラム終了
       EE03                     CPM_WBOOT:
001D0A EE03 C309D7          10      JP  WBOOT1
       EE06                     CPM_CONST:
001D0D EE06 C375E0          10      JP  CONSTX
       EE09                     _SYS07:     ;(BDOS)コンソール直接入力
       EE09                     CPM_CONIN:
001D10 EE09 C3EADF          10      JP  FLGET
       EE0C                     CPM_CONOUT:
001D13 EE0C C3BBE2          10      JP  CONOUT1
                                
       EE0F                     DECBF:              ;10進数表示時のバッファ(5バイト)
001D16 EE0F                         DS  5
       EE0F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       EE11                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       EE14                     FDRV:
001D1B EE14 00                      DB  0
       EE15                     FNAME:
001D1C EE15                         DS  36
       EE39                     SFILE:
001D40 EE39                         DS  33      ;DRV FILENAME
       EE5A                     _DISKE:
001D61 EE5A C326DF          10      JP  SHOW_ERROR
                                
001D64 EE5D 0000                LEFTX:  DW  0
001D66 EE5F 0000                DTAX:   DW  0
                                
                                ;   PSGのビープ音のデータ(X1)
       EE61                     BEEPD:
001D68 EE61 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
001D70 EE69 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                ;
       EE62                     RTC_YY  EQU BEEPD+1 ;RTCのバッファ年(88)
       EE63                     RTC_MW  EQU BEEPD+2 ;RTCのバッファ月(88)
       EE64                     RTC_DD  EQU BEEPD+3 ;RTCのバッファ日(88)
       EE65                     RTC_TT  EQU BEEPD+4 ;RTCのバッファ時(88)
       EE66                     RTC_MM  EQU BEEPD+5 ;RTCのバッファ分(88)
       EE67                     RTC_SS  EQU BEEPD+6 ;RTCのバッファ秒(88)
       EE62                     ROM_SLT EQU BEEPD+1 ;ROMのスロット(MSX)
       EE61                     ZERO    EQU BEEPD
                                
       EE70                     CHECK:
001D77 EE70 00                      DB  0
                                
       EE71                     OK:
001D78 EE71 4F4B24                  DB  "OK$"
001D7B EE74                         DS  5
       EE79                     COMERM:
001D80 EE79 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       EE80                     _CYL0:
001D87 EE80 FF                      DB  0FFH    ;Cylinder
       EE81                     _CYL1:
001D88 EE81 FF                      DB  0FFH    ;Cylinder
       EE82                     _CYL2:
001D89 EE82 FF                      DB  0FFH    ;Cylinder
       EE83                     _CYL3:
001D8A EE83 FF                      DB  0FFH    ;Cylinder
       EE84                     _DRIVE:
001D8B EE84 00                      DB  0   ;unit number
       EE85                     _SEEKSP:
001D8C EE85 00                      DB  0   ;Seek speed
       EE86                     _ISEEK:
001D8D EE86 32                      DB  50  ;
001D8E EE87                         DS  1
       EE88                     _DRV:
001D8F EE88 00                      DB  0
       EE89                     _DSK:
001D90 EE89 FF                      DB  0FFH
       EE8A                     _DTA:
001D91 EE8A 8000                    DW  00080H
       EE8C                     _CTC:
001D93 EE8C 0000                    DW  0
       EE8E                     _TXADR:
001D95 EE8E 0000                    DW  0
       EE90                     _KEYPS:
001D97 EE90 0000                    DW  0
       EE92                     _KEYD:
001D99 EE92 00                      DB  000H    ;キーデータ
       EE93                     _KEYST:
001D9A EE93 FF                      DB  0FFH    ;キーステータス(SHIFT,CTRLの状態)
       EE94                     _KEYSP_L:
001D9B EE94 C2                      DB  KEYSP_L ;オートリピートの速度
       EE95                     _KEYSP_H:
001D9C EE95 14                      DB  KEYSP_H ;オートリピートの速度
       EE96                     _COLORF:
001D9D EE96 07                      DB  COLORF  ;色
       EE97                     _LINE:
001D9E EE97 18                      DB  LINE
                                
                                            ;次のファイルの検索(C=12)で使用するFCB
       EE98                     _FCB:
001D9F EE98 0000                    DW  0   ;SEARCH FILES
       EE9A                     _FBPS:
001DA1 EE9A 0000                    DW  0   ;    //
       EE9C                     _FBAD:
001DA3 EE9C 0000                    DW  0   ;    //
       EE9E                     _FBCNT:
001DA5 EE9E 00                      DB  0   ;    //
       EE9F                     _FILEN:
001DA6 EE9F 00                      DB  0   ;    //
       EEA0                     _DIRF:
001DA7 EEA0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
001DA8 EEA1                         DS  1
       EEA2                     _WTFATF:
001DA9 EEA2 00                      DB  0   ;FATバッファの更新フラグ
001DAA EEA3                         DS  1
       EEA4                     _WTDBF:
001DAB EEA4 00                      DB  0   ;データバッファの更新フラグ
       EEA5                     _DBDRV:
001DAC EEA5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       EEA6                     _DBSEC:
001DAD EEA6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       EEA8                     _DPB:
001DAF EEA8 0000                    DW  0
       EEAA                     _FATDRV:
001DB1 EEAA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       EEAB                     _FATIX:
001DB2 EEAB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       EEAC                     _FAKEFREE:
001DB3 EEAC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
001DB5 EEAE                         DS  2
                                ;   画面周りのデータ
       EEB0                     CRTCD:
001DB7 EEB0 6F                      DB  06FH
       EEB1                     _WIDTH:
001DB8 EEB1 50                      DB  WIDTH
       EEB2                     TVRAMTOP:
001DB9 EEB2 5938                    DB  059H,038H
001DBB EEB4 1F02                    DB  01FH,002H
       EEB6                     _LINE2:
001DBD EEB6 19                      DB  019H
       EEB7                     WKE4:
001DBE EEB7 1C                      DB  01CH
       EEB8                     WKE6:
001DBF EEB8 00                      DB  000H
       EEB9                     WK40:
001DC0 EEB9 07                      DB  007H
       EEBA                     _PAGE_MINUS:
001DC1 EEBA 80F8                    DW  0-WIDTH*LINE
       EEBC                     _WIDTH_MINUS:
001DC3 EEBC B0FF                    DW  0-WIDTH
       EEBE                     WK30:
001DC5 EEBE 0C                      DB  00CH
       EEBF                     WK31:
       EEBF                     WK1FD0:
001DC6 EEBF 20                      DB  020H
                                
                                ;   割り込みベクタ(X1)
001DC7 EEC0 7ADF                CTC0:   DW  INTCTCE
001DC9 EEC2 7ADF                CTC1:   DW  INTCTCE
001DCB EEC4 7ADF                CTC2:   DW  INTCTCE
001DCD EEC6 7ADF                CTC3:   DW  INTCTCE
001DCF EEC8 53DF                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
001DD1 EECA C39EE4          10  _INKEY: JP  INKEY
001DD4 EECD C356E1          10  _PRINT: JP  PRINT
001DD7 EED0 C306E4          10  _SCRN:  JP  SCRN
001DDA EED3 C330E4          10  _POS:   JP  POS
001DDD EED6 C384E2          10  _LOC:   JP  LOC
       EED9                     _CHGDRV:
001DE0 EED9 C31BEB          10      JP  CHGDRV
       EEDC                     _GETDPB:
001DE3 EEDC C3D9EB          10      JP  GETDPB
       EEDF                     _FFLUSH:
001DE6 EEDF C3F7EB          10      JP  FFLUSH
       EEE2                     _RDFATX:
001DE9 EEE2 C3F5E7          10      JP  RDFATX
001DEC EEE5 C327E9          10  _RDFAT: JP  RDFAT
001DEF EEE8 C3DCEC          10  _WTTRK: JP  WTTRK
001DF2 EEEB C3F0EC          10  _FDRD:  JP  FDRD
001DF5 EEEE C3E2EC          10  _FDWT:  JP  FDWT
       EEF1                     _BPB2DPB:
001DF8 EEF1 C3BDE9          10      JP  BPB2DPB
       EEF4                     _BREAK:
001DFB EEF4 C3BFD8          10      JP  END_BATCH
       EEF7                     _GNCL:
001DFE EEF7 C3A1E8          10      JP  GNCL        ; self-modifying code
       EEF8                     GNCPAT  EQU $-2
       EEFA                     _SNCL:
001E01 EEFA C3C4E8          10      JP  SNCL        ; self-modifying code
       EEFB                     SNCPAT  EQU $-2
       EEFD                     _COMANL:
001E04 EEFD C378D7          10      JP  COMANL
                                
       EF00                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       EF00                     STABLE:
                                ;0
001E07 EF00 03EEBDDFC9DFAAF1        DW  _SYS00,_SYS01,_SYS02,_SYS03
001E0F EF08 91DC91DCCEDF09EE        DW  _SYS04,_SYS05,_SYS06,_SYS07
001E17 EF10 D6DF93DC41E06DE0        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
001E1F EF18 A8DCADDCBCDCCDDC        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
001E27 EF20 21DD68DDB1DDE2DD        DW  _SYS10,_SYS11,_SYS12,_SYS13
001E2F EF28 EADD00DE15DE0DDE        DW  _SYS14,_SYS15,_SYS16,_SYS17
001E37 EF30 5CDE61DE66DE6CDE        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
001E3F EF38 91DC92DE91DC96DE        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
001E47 EF40 91DC4CDE54DE9DDE        DW  _SYS20,_SYS21,_SYS22,_SYS23
001E4F EF48 C2DE91DCB5E483E5        DW  _SYS24,_ERROR,_SYS26,_SYS27
001E57 EF50 54DECCDE83E0AAF1        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
001E5F EF58 A6E0AAF191DCEDDE        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
001E67 EF60 E7DE91DC91DC91DC        DW  _SYS30,_ERROR,_ERROR,_ERROR
001E6F EF68 91DC91DC91DC91DC        DW  _ERROR,_ERROR,_ERROR,_ERROR
001E77 EF70 91DCAAF1AAF10EDF        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
001E7F EF78 74DC                    DW  _DOS2
                                
001E81 EF7A                         DS  1
       EF7B                     _MAX_SEC_SZ_H:
001E82 EF7B 02                      DB  MAX_SEC_SZ_H
                                
                                ;   FATバッファのアドレス
       EF7C                     _FATBF:
001E83 EF7C 00F7                    DW  FATBF
                                
                                ;   データバッファのアドレス
       EF7E                     _DTBUF:
001E85 EF7E 00FD                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       EF80                     CTRLTB:
001E87 EF80 F9E1F9E135E27AE3        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
001E8F EF88 74E359E253E3DCE2        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
001E97 EF90 05E226E27DE39AE2        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
001E9F EF98 50E37FE292E3F9E1        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
001EA7 EFA0 F9E1F9E192E2F9E1        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
001EAF EFA8 F9E1F9E1F9E1F9E1        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
001EB7 EFB0 F9E1F9E150E3A1E2        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
001EBF EFB8 20E20CE215E27DE3        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
                                ;   2D/2DDでBPBがない場合のデフォルト値(2D/360KB/9セクタ1024バイト)
001EC7 EFC0 0200                M2D:    DW  2
001EC9 EFC2 FD02                    DB  0FDH,2
001ECB EFC4 6401                    DW  356
001ECD EFC6 FF0728090182            DB  0FFH,7,40,9,1,082H
001ED3 EFCC 0500A7000800            DW  5,0A7H,8
                                
                                ;   2HDでBPBがない場合のデフォルト値(2HD/1.23MB/8セクタ1024バイト)
001ED9 EFD2 0200                M2HD:   DW  2
001EDB EFD4 FE01                    DB  0FEH,1
001EDD EFD6 C704                    DW  1223
001EDF EFD8 FE064D080184            DB  0FEH,6,77,8,1,084H
001EE5 EFDE 0500A7000900            DW  5,0A7H,9
                                
                                ;   ディレクトリエントリとFCBの変換テーブル(日付+時刻+サイズ)
001EEB EFE4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
001EED EFE6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
001EEF EFE8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
001EF1 EFEA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       EFEE                     SDDATAE:
                                
001EF5 EFEE                         DS  2
                                
                                ;   バッチファイルのFCB
       EFF0                     _FCB_BAT:
001EF7 EFF0 C6ED                    DW  FCB_BAT
       EFF2                     _PATH:
001EF9 EFF2 65ED                    DW  PATHD
                                
001EFB EFF4                     SCDIR:  DS  2       ;+14 +15
001EFD EFF6                     SFBPS:  DS  2       ;FBPS
001EFF EFF8                     SFNDF:  DS  2       ;FILEN DIRF
                                
001F01 EFFA 0000                _FATPS: DW  0
001F03 EFFC 0000                _DIRPS: DW  0
001F05 EFFE 0000                _CLPS:  DW  0
                                
       F000                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       F000                     FILEC:
001F07 F000 CD0BF0          17      CALL    FILE
       F003                     FILEC2:
001F0A F003 3A15EE          13      LD  A,(FDRV+1)
001F0D F006 FE20             7      CP  020H
001F0F F008 C8              11      RET Z
001F10 F009 1839            12      JR  SETDIR1
                                
       F00B                     FILE:
001F12 F00B AF               4      XOR A
001F13 F00C 3214EE          13      LD  (FDRV),A
001F16 F00F 67               4      LD  H,A
001F17 F010 6F               4      LD  L,A
001F18 F011 2222EE          16      LD  (FDRV+14),HL
001F1B F014 CDE1F0          17      CALL    SPCUT
001F1E F017 CDC6F0          17      CALL    CCHK3
001F21 F01A 2812            12      JR  Z,DEVI1
001F23 F01C 13               6      INC DE
001F24 F01D 1A               7      LD  A,(DE)
001F25 F01E 1B               6      DEC DE
001F26 F01F FE3A             7      CP  ':'
001F28 F021 200B            12      JR  NZ,DEVI1
001F2A F023 1A               7      LD  A,(DE)      ;DRIVE
001F2B F024 CD27F3          17      CALL    CAP
001F2E F027 D640             7      SUB '@'
001F30 F029 13               6      INC DE
001F31 F02A 13               6      INC DE
001F32 F02B 3214EE          13      LD  (FDRV),A
       F02E                     DEVI1:
001F35 F02E 1A               7      LD  A,(DE)
001F36 F02F D65C             7      SUB 05CH        ;\
001F38 F031 2009            12      JR  NZ,NOROOT
001F3A F033 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
001F3B F034 222EEE          16      LD  (FDRV+26),HL
001F3E F037 2C               4      INC L
001F3F F038 2222EE          16      LD  (FDRV+14),HL
001F42 F03B 13               6      INC DE
       F03C                     NOROOT:
                                
       F03C                     SETDIR:
001F43 F03C CD67F0          17      CALL    FILED
001F46 F03F 1A               7      LD  A,(DE)
001F47 F040 FE5C             7      CP  05CH        ;\
001F49 F042 C0              11      RET NZ
001F4A F043 13               6      INC DE
       F044                     SETDIR1:
001F4B F044 3E10             7      LD  A,010H      ;Directory
001F4D F046 3221EE          13      LD  (FDRV+13),A
001F50 F049 D5              11      PUSH    DE
001F51 F04A 1114EE          10      LD  DE,FDRV
001F54 F04D 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
001F56 F04F CD62DC          17      CALL    BDOS0
001F59 F052 D1              10      POP DE
001F5A F053 B7               4      OR  A
001F5B F054 C0              11      RET NZ
                                
001F5C F055 3A21EE          13      LD  A,(FDRV+13)
001F5F F058 E610             7      AND 010H        ;ディレクトリ
001F61 F05A C8              11      RET Z
                                
001F62 F05B CDAEF0          17      CALL    FILEI
001F65 F05E 2A2EEE          16      LD  HL,(FDRV+26)
001F68 F061 23               6      INC HL
001F69 F062 2222EE          16      LD  (FDRV+14),HL
001F6C F065 18D5            12      JR  SETDIR
                                
       F067                     FILED:
001F6E F067 CDAEF0          17      CALL    FILEI
001F71 F06A 2115EE          10      LD  HL,FNAME
                                
001F74 F06D 0608             7      LD  B,8
       F06F                     FILE2:
001F76 F06F CDBBF0          17      CALL    CCHKF
001F79 F072 C8              11      RET Z
001F7A F073 FE2A             7      CP  '*'
001F7C F075 282E            12      JR  Z,FILE9
001F7E F077 FE2E             7      CP  '.'
001F80 F079 280C            12      JR  Z,FILE4
001F82 F07B 77               7      LD  (HL),A
001F83 F07C 23               6      INC HL
001F84 F07D 10F0            13      DJNZ    FILE2
                                
       F07F                     FILE3:
001F86 F07F CDBBF0          17      CALL    CCHKF
001F89 F082 C8              11      RET Z
001F8A F083 FE2E             7      CP  '.'
001F8C F085 20F8            12      JR  NZ,FILE3
                                
       F087                     FILE4:
001F8E F087 211DEE          10      LD  HL,FNAME+8
001F91 F08A 0603             7      LD  B,3
                                
       F08C                     FILE4L:
001F93 F08C CDBBF0          17      CALL    CCHKF
001F96 F08F C8              11      RET Z
001F97 F090 FE2E             7      CP  '.'
001F99 F092 2008            12      JR  NZ,FILE12
001F9B F094 3215EE          13      LD  (FNAME),A   ;Parent directory(..)
001F9E F097 3216EE          13      LD  (FNAME+1),A
001FA1 F09A 3E20             7      LD  A,020H
       F09C                     FILE12:
001FA3 F09C FE2A             7      CP  '*'
001FA5 F09E 280A            12      JR  Z,FILE10
001FA7 F0A0 77               7      LD  (HL),A
001FA8 F0A1 23               6      INC HL
001FA9 F0A2 10E8            13      DJNZ    FILE4L
001FAB F0A4 C9              10      RET
                                
       F0A5                     FILE9:              ;名前の*処理、名前の残りを?で埋める
001FAC F0A5 CDAAF0          17      CALL    FILE10
001FAF F0A8 18D5            12      JR  FILE3
                                
       F0AA                     FILE10:
001FB1 F0AA 3E3F             7      LD  A,'?'
001FB3 F0AC 1808            12      JR  FILL_MEMORY
       F0AE                     FILEI:              ;名前＋拡張子をスペースで初期化
001FB5 F0AE 3E20             7      LD  A,020H
001FB7 F0B0 01000B          10      LD  BC,11*256   ;C=0にしておく
001FBA F0B3 2115EE          10      LD  HL,FNAME
       F0B6                     FILL_MEMORY:            ;HLからBバイトAで埋める
001FBD F0B6 77               7      LD  (HL),A
001FBE F0B7 23               6      INC HL
001FBF F0B8 10FC            13      DJNZ    FILL_MEMORY
001FC1 F0BA C9              10      RET
                                
       F0BB                     CCHKF:
001FC2 F0BB 1A               7      LD  A,(DE)
001FC3 F0BC CDC3F0          17      CALL    CCHK2
001FC6 F0BF C8              11      RET Z
001FC7 F0C0 C32FF4          10      JP  FKAN
                                
       F0C3                     CCHK2:
001FCA F0C3 0C               4      INC C
001FCB F0C4 0D               4      DEC C
001FCC F0C5 C0              11      RET NZ
       F0C6                     CCHK3:              ;ZF=1 で使えない文字
001FCD F0C6 FE2B             7      CP  '+'
001FCF F0C8 C8              11      RET Z
001FD0 F0C9 FE2C             7      CP  ','
001FD2 F0CB C8              11      RET Z
001FD3 F0CC FE2F             7      CP  '/'
001FD5 F0CE C8              11      RET Z
001FD6 F0CF FE3A             7      CP  ':'
001FD8 F0D1 C8              11      RET Z
001FD9 F0D2 FE3B             7      CP  ';'
001FDB F0D4 C8              11      RET Z
001FDC F0D5 FE3D             7      CP  '='
001FDE F0D7 C8              11      RET Z
001FDF F0D8 FE5C             7      CP  05CH    ;\
001FE1 F0DA C8              11      RET Z
001FE2 F0DB FE20             7      CP  020H
001FE4 F0DD D0              11      RET NC
001FE5 F0DE BF               4      CP  A       ;Z=1
001FE6 F0DF C9              10      RET
                                
       F0E0                     SS1:
001FE7 F0E0 13               6      INC DE
       F0E1                     SPCUT:              ;スペースをカット
001FE8 F0E1 1A               7      LD  A,(DE)
001FE9 F0E2 FE20             7      CP  020H
001FEB F0E4 28FA            12      JR  Z,SS1
001FED F0E6 C9              10      RET
                                
       F0E7                     SETDRVF:
001FEE F0E7 1114EE          10      LD  DE,FDRV
       F0EA                     SETDRV0:
001FF1 F0EA CDF3F0          17      CALL    SETDRV
001FF4 F0ED FDE1            14      POP IY
001FF6 F0EF C1              10      POP BC
001FF7 F0F0 D1              10      POP DE
001FF8 F0F1 E1              10      POP HL
001FF9 F0F2 C9              10      RET
                                
       F0F3                     SETDRV:
001FFA F0F3 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
001FFB F0F4 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
001FFC F0F5 C5              11      PUSH    BC
001FFD F0F6 1A               7      LD  A,(DE)
001FFE F0F7 D5              11      PUSH    DE
001FFF F0F8 FDE3            23      EX  (SP),IY
                                
002001 F0FA CD01F1          17      CALL    GETDRV
002004 F0FD CDD9EE          17      CALL    _CHGDRV
                                
002007 F100 E9               4      JP  (HL)
                                
       F101                     GETDRV:
002008 F101 CD14F1          17      CALL    GETDRV1
00200B F104 3288EE          13      LD  (_DRV),A
00200E F107 C9              10      RET
                                
       F108                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
00200F F108 CD14F1          17      CALL    GETDRV1
002012 F10B C5              11      PUSH    BC
002013 F10C 4F               4      LD  C,A
002014 F10D 1A               7      LD  A,(DE)
002015 F10E CD14F1          17      CALL    GETDRV1
002018 F111 A9               4      XOR C
002019 F112 C1              10      POP BC
00201A F113 C9              10      RET
       F114                     GETDRV1:
00201B F114 E67F             7      AND 07FH
00201D F116 D601             7      SUB 001H
00201F F118 D0              11      RET NC
002020 F119 3A0400          13      LD  A,(_DVSW)   ;Current Drive
002023 F11C C9              10      RET
                                
       F11D                     SOPENX:
002024 F11D 1139EE          10      LD  DE,SFILE
002027 F120 FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
00202A F123 CD08F1          17      CALL    IS_SAME_DRV_A_DE
00202D F126 2024            12      JR  NZ,SOPEN
00202F F128 13               6      INC DE
002030 F129 FDE5            15      PUSH    IY
002032 F12B E1              10      POP HL
002033 F12C 23               6      INC HL
002034 F12D CDB8F2          17      CALL    CPFILE
002037 F130 201A            12      JR  NZ,SOPEN
                                
002039 F132 2AF4EF          16      LD  HL,(SCDIR)
00203C F135 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00203F F138 FD740F          19      LD  (IY+15),H
                                
002042 F13B 2AF8EF          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
002045 F13E 229FEE          16      LD  (_FILEN),HL
                                
002048 F141 ED5BF6EF        20      LD  DE,(SFBPS)
00204C F145 2139EE          10      LD  HL,SFILE
00204F F148 36FF            10      LD  (HL),0FFH
002051 F14A 23               6      INC HL
002052 F14B C9              10      RET
       F14C                     SOPEN:
002053 F14C 2160F2          10      LD  HL,FILESE
       F14F                     SOPENC:
002056 F14F 2288F1          16      LD  (OPENPAT),HL
                                
002059 F152 CDE2EE          17      CALL    _RDFATX     ;Detect Media
00205C F155 3856            12      JR  C,RDDERR
                                
00205E F157 AF               4      XOR A
00205F F158 329FEE          13      LD  (_FILEN),A
002062 F15B CD64F3          17      CALL    LDDIRX1     ;A=0で呼び出す
002065 F15E 2818            12      JR  Z,SDIRX1
                                
002067 F160 CD51F2          17      CALL    READ_DIR    ;Sub Directory
00206A F163 3808            12      JR  C,SDIRX0
00206C F165 2A7EEF          16      LD  HL,(_DTBUF)
00206F F168 7E               7      LD  A,(HL)
002070 F169 FE2E             7      CP  '.'
002072 F16B 280F            12      JR  Z,SOPEN1
       F16D                     SDIRX0:
002074 F16D AF               4      XOR A
002075 F16E 32A0EE          13      LD  (_DIRF),A
002078 F171 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
00207C F175 FD770F          19      LD  (IY+15),A
       F178                     SDIRX1:
00207F F178 ED5BFCEF        20      LD  DE,(_DIRPS) ;Root Directory
       F17C                     SOPEN1:
002083 F17C 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       F17D                     SDECPAT EQU $-1
       F17E                     SOPEN1X:
002085 F17E CD51F2          17      CALL    READ_DIR    ;FILE SEARCH
002088 F181 382A            12      JR  C,RDDERR
00208A F183 2A7EEF          16      LD  HL,(_DTBUF)
       F186                     SOPEN2:
00208D F186 D5              11      PUSH    DE
00208E F187 CD60F2          17      CALL    FILESE      ;(self-modifying code)
       F188                     OPENPAT EQU $-2
002091 F18A D1              10      POP DE
002092 F18B 386D            12      JR  C,SOPENE
002094 F18D 281B            12      JR  Z,SCF_FF_RET
       F18F                     SOPEN3:
002096 F18F 3AA0EE          13      LD  A,(_DIRF)   ;ディレクトリか判別
002099 F192 B7               4      OR  A
00209A F193 200C            12      JR  NZ,SOPEN5
00209C F195 13               6      INC DE      ;ルートディレクトリ
00209D F196 E5              11      PUSH    HL
00209E F197 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       F198                     MD_PAT  EQU $-2
0020A1 F19A ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
0020A3 F19C E1              10      POP HL
0020A4 F19D 20DD            12      JR  NZ,SOPEN1
0020A6 F19F 1807            12      JR  SOPEN6
       F1A1                     SOPEN5:
0020A8 F1A1 CD20E9          17      CALL    GNCLX       ;END DIR
0020AB F1A4 D8              11      RET C
0020AC F1A5 CD18F3          17      CALL    ENDCL
       F1A8                     SOPEN6:
0020AF F1A8 38D2            12      JR  C,SOPEN1
       F1AA                     SCF_FF_RET:
0020B1 F1AA 37               4      SCF         ;CF=1
0020B2 F1AB 9F               4      SBC A,A     ;A=0FFH
0020B3 F1AC C9              10      RET
                                
       F1AD                     RDDERR:
0020B4 F1AD BF               4      CP  A       ;READ ERR CF=1 ZF=1
0020B5 F1AE 37               4      SCF
0020B6 F1AF C9              10      RET
                                
       F1B0                     NOPEN:
0020B7 F1B0 2160F2          10      LD  HL,FILESE
0020BA F1B3 2288F1          16      LD  (OPENPAT),HL
0020BD F1B6 FD2A98EE        20      LD  IY,(_FCB)
0020C1 F1BA CD42F4          17      CALL    CHKWILDX
0020C4 F1BD 30EB            12      JR  NC,SCF_FF_RET
0020C6 F1BF FD7E00          19      LD  A,(IY+0)
0020C9 F1C2 CD01F1          17      CALL    GETDRV
0020CC F1C5 CDD9EE          17      CALL    _CHGDRV
0020CF F1C8 D8              11      RET C
0020D0 F1C9 2AF8EF          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
0020D3 F1CC 229FEE          16      LD  (_FILEN),HL
                                
0020D6 F1CF CD5FF3          17      CALL    LDDIRX
0020D9 F1D2 ED5B9AEE        20      LD  DE,(_FBPS)
0020DD F1D6 CD51F2          17      CALL    READ_DIR
0020E0 F1D9 38D2            12      JR  C,RDDERR
0020E2 F1DB 3A9EEE          13      LD  A,(_FBCNT)
0020E5 F1DE 3D               4      DEC A
0020E6 F1DF 28AE            12      JR  Z,SOPEN3
       F1E1                     NOPEN2:
0020E8 F1E1 2A9CEE          16      LD  HL,(_FBAD)
0020EB F1E4 012000          10      LD  BC,020H
0020EE F1E7 09              11      ADD HL,BC
0020EF F1E8 4F               4      LD  C,A
0020F0 F1E9 189B            12      JR  SOPEN2
                                
       F1EB                     SOPENE2:
0020F2 F1EB 229CEE          16      LD  (_FBAD),HL
0020F5 F1EE 79               4      LD  A,C
0020F6 F1EF 329EEE          13      LD  (_FBCNT),A
0020F9 F1F2 ED539AEE        20      LD  (_FBPS),DE
0020FD F1F6 FD2298EE        20      LD  (_FCB),IY
       F1FA                     SOPENE:
002101 F1FA AF               4      XOR A
002102 F1FB C9              10      RET
                                
       F1FC                     COPEN:
002103 F1FC FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
002107 F200 217DF2          10      LD  HL,NEXTSE
00210A F203 CD4FF1          17      CALL    SOPENC
00210D F206 D0              11      RET NC
00210E F207 C8              11      RET Z
00210F F208 3AA0EE          13      LD  A,(_DIRF)   ;ディレクトリか判別
002112 F20B B7               4      OR  A
002113 F20C 37               4      SCF
002114 F20D C8              11      RET Z       ;ルートディレクトリ
002115 F20E 0601             7      LD  B,1
002117 F210 CDA1F4          17      CALL    WRDF
00211A F213 D8              11      RET C
00211B F214 ED5BFEEF        20      LD  DE,(_CLPS)
00211F F218 D5              11      PUSH    DE
002120 F219 CDE1F2          17      CALL    DCPAT
002123 F21C CDA1E7          17      CALL    DRDNX
002126 F21F 2A7EEF          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
002129 F222 ED4B8CE6        20      LD  BC,(SECSZ)  ;1セクタのサイズ
00212D F226 AF               4      XOR A
       F227                     COPENCL:
00212E F227 77               7      LD  (HL),A
00212F F228 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
002131 F22A EA27F2          10      JP  PE,COPENCL
                                
002134 F22D 3AFFF2          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
002137 F230 3D               4      DEC A
002138 F231 2819            12      JR  Z,COPENE
00213A F233 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
00213C F235 3218E9          13      LD  (_SECPS),A
00213F F238 D1              10      POP DE      ;DE=(_CLPS)
002140 F239 D5              11      PUSH    DE
       F23A                     COPEN1:
002141 F23A D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
002142 F23B C5              11      PUSH    BC
002143 F23C 2A7EEF          16      LD  HL,(_DTBUF)
002146 F23F CDFBF2          17      CALL    CLUSTX
002149 F242 CDB5EA          17      CALL    DWT24
00214C F245 C1              10      POP BC
00214D F246 D1              10      POP DE
00214E F247 CD17E9          17      CALL    NEXTX
002151 F24A 20EE            12      JR  NZ,COPEN1
       F24C                     COPENE:
002153 F24C 2A7EEF          16      LD  HL,(_DTBUF)
002156 F24F D1              10      POP DE
002157 F250 C9              10      RET
                                
       F251                     READ_DIR:
002158 F251 ED53FEEF        20      LD  (_CLPS),DE
00215C F255 C5              11      PUSH    BC
00215D F256 D5              11      PUSH    DE
00215E F257 CDE1F2          17      CALL    DCPAT
002161 F25A CD81E7          17      CALL    DRDX
002164 F25D D1              10      POP DE
002165 F25E C1              10      POP BC
002166 F25F C9              10      RET
                                
       F260                     FILESE:
002167 F260 7E               7      LD  A,(HL)
002168 F261 B7               4      OR  A
002169 F262 C8              11      RET Z       ;END:ZF=1 CF=0
00216A F263 FEE5             7      CP  0E5H
00216C F265 280E            12      JR  Z,FILESE1
00216E F267 FDE5            15      PUSH    IY
002170 F269 D1              10      POP DE
002171 F26A 13               6      INC DE
002172 F26B E5              11      PUSH    HL
002173 F26C CDB8F2          17      CALL    CPFILE
002176 F26F CCD9F2          17      CALL    Z,CPFILE2
002179 F272 E1              10      POP HL
00217A F273 37               4      SCF
00217B F274 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       F275                     FILESE1:
00217C F275 CD8CF2          17      CALL    FNEXT
00217F F278 20E6            12      JR  NZ,FILESE
       F27A                     ZF0_CF0_AFF_RET:
002181 F27A F6FF             7      OR  0FFH        ;ZF=0 CF=0
002183 F27C C9              10      RET
                                
       F27D                     NEXTSE:
002184 F27D 7E               7      LD  A,(HL)
002185 F27E B7               4      OR  A
002186 F27F 37               4      SCF
002187 F280 C8              11      RET Z       ;!!!:ZF=1 CF=1
002188 F281 FEE5             7      CP  0E5H
00218A F283 37               4      SCF
00218B F284 C8              11      RET Z       ;!!!:(ZF=1) CF=1
00218C F285 CD8CF2          17      CALL    FNEXT
00218F F288 20F3            12      JR  NZ,NEXTSE
002191 F28A 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       F28C                     FNEXT:
002193 F28C E5              11      PUSH    HL
002194 F28D 219FEE          10      LD  HL,_FILEN
002197 F290 34              11      INC (HL)
002198 F291 E1              10      POP HL
002199 F292 112000          10      LD  DE,020H
00219C F295 19              11      ADD HL,DE
00219D F296 0D               4      DEC C
00219E F297 C9              10      RET
                                
       F298                     CPNAME:
00219F F298 C5              11      PUSH    BC
0021A0 F299 D5              11      PUSH    DE
0021A1 F29A E5              11      PUSH    HL
0021A2 F29B CDB2F2          17      CALL    CPFILE4
0021A5 F29E E1              10      POP HL
0021A6 F29F 23               6      INC HL
0021A7 F2A0 23               6      INC HL
0021A8 F2A1 23               6      INC HL
0021A9 F2A2 23               6      INC HL
0021AA F2A3 D1              10      POP DE
0021AB F2A4 C1              10      POP BC
0021AC F2A5 2005            12      JR  NZ,CPNAME1
0021AE F2A7 7E               7      LD  A,(HL)
0021AF F2A8 23               6      INC HL
0021B0 F2A9 66               7      LD  H,(HL)
0021B1 F2AA 6F               4      LD  L,A
0021B2 F2AB C9              10      RET
       F2AC                     CPNAME1:
0021B3 F2AC 23               6      INC HL
0021B4 F2AD 23               6      INC HL
0021B5 F2AE 10E8            13      DJNZ    CPNAME
0021B7 F2B0 37               4      SCF
0021B8 F2B1 C9              10      RET
                                
       F2B2                     CPFILE4:
0021B9 F2B2 C5              11      PUSH    BC
0021BA F2B3 010004          10      LD  BC,00400H
0021BD F2B6 1804            12      JR  CPSTR1
       F2B8                     CPFILE:
0021BF F2B8 C5              11      PUSH    BC
0021C0 F2B9 01000B          10      LD  BC,00B00H
       F2BC                     CPSTR1:
0021C3 F2BC 1A               7      LD  A,(DE)
0021C4 F2BD FE3F             7      CP  '?'     ;Wild card
0021C6 F2BF 2812            12      JR  Z,CPSTR2
0021C8 F2C1 7E               7      LD  A,(HL)
0021C9 F2C2 CD28F4          17      CALL    FKANC
0021CC F2C5 E5              11      PUSH    HL
0021CD F2C6 67               4      LD  H,A
0021CE F2C7 1A               7      LD  A,(DE)
0021CF F2C8 CB01             8      RLC C
0021D1 F2CA CD28F4          17      CALL    FKANC
0021D4 F2CD CB09             8      RRC C
0021D6 F2CF BC               4      CP  H       ;CP (HL),(DE)
0021D7 F2D0 E1              10      POP HL
0021D8 F2D1 2004            12      JR  NZ,CPSTR3
       F2D3                     CPSTR2:
0021DA F2D3 13               6      INC DE
0021DB F2D4 23               6      INC HL
0021DC F2D5 10E5            13      DJNZ    CPSTR1
       F2D7                     CPSTR3:
0021DE F2D7 C1              10      POP BC
0021DF F2D8 C9              10      RET
                                
       F2D9                     CPFILE2:
0021E0 F2D9 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0021E3 F2DC F6E1             7      OR  0E1H
0021E5 F2DE 2F               4      CPL
0021E6 F2DF A6               7      AND (HL)
0021E7 F2E0 C9              10      RET
                                
       F2E1                     DCPAT:
0021E8 F2E1 0E00             7      LD  C,0
0021EA F2E3 2A7EEF          16      LD  HL,(_DTBUF)
0021ED F2E6 3AA0EE          13      LD  A,(_DIRF)   ;ディレクトリか判別
0021F0 F2E9 B7               4      OR  A
0021F1 F2EA C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
0021F2 F2EB 3AFFF2          13      LD  A,(SPCPAT)
0021F5 F2EE 4F               4      LD  C,A
0021F6 F2EF 3A18E9          13      LD  A,(_SECPS)
0021F9 F2F2 B9               4      CP  C
0021FA F2F3 3801            12      JR  C,DC1
0021FC F2F5 AF               4      XOR A
       F2F6                     DC1:
0021FD F2F6 F680             7      OR  080H
0021FF F2F8 32A0EE          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       F2FB                     CLUSTX:
002202 F2FB E5              11      PUSH    HL
002203 F2FC EB               4      EX  DE,HL
002204 F2FD AF               4      XOR A
002205 F2FE 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       F2FF                     SPCPAT  EQU $-1
       F300                     L_CLDBL:
002207 F300 CB19             8      RR  C       ;->CF
002209 F302 3804            12      JR  C,E_CLDBL
00220B F304 29              11      ADD HL,HL       ;*2
00220C F305 8F               4      ADC A,A
00220D F306 18F8            12      JR  L_CLDBL
       F308                     E_CLDBL:
00220F F308 4F               4      LD  C,A
002210 F309 3A18E9          13      LD  A,(_SECPS)
002213 F30C B5               4      OR  L
002214 F30D 6F               4      LD  L,A
002215 F30E 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       F30F                     CLSPAT  EQU $-2
002218 F311 AF               4      XOR A
002219 F312 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
00221A F313 89               4      ADC A,C
00221B F314 4F               4      LD  C,A
00221C F315 EB               4      EX  DE,HL
00221D F316 E1              10      POP HL
00221E F317 C9              10      RET
                                ;(8)
       F318                     ENDCL:
00221F F318 7A               4      LD  A,D ;END CLUSTER
002220 F319 FE01             7      CP  1   ;164=356    (self-modifying code)
       F31A                     CLPAT1  EQU $-1
002222 F31B C0              11      RET NZ
002223 F31C 7B               4      LD  A,E
002224 F31D FE64             7      CP  064H    ;       (self-modifying code)
       F31E                     CLPAT2  EQU $-1
002226 F31F C9              10      RET
                                ;(3)
       F320                     CAP4:
002227 F320 3EE5             7      LD  A,0E5H
002229 F322 C9              10      RET
                                                    ;for X1/88 ワークエリア
00222A F323 5BEE                    DW  _DISKE+1        ;DISKVE($F323)
00222C F325 F5EE                    DW  _BREAK+1        ;BREAKV($F325)
                                
       F327                     CAP:            ;(9)
00222E F327 FE61             7      CP  'a'
002230 F329 D8              11      RET C
002231 F32A FE7B             7      CP  'z'+1
002233 F32C D0              11      RET NC
002234 F32D D620             7      SUB 020H
002236 F32F C9              10      RET
                                ;(10)
       F330                     CAP2:
002237 F330 CD27F3          17      CALL    CAP
       F333                     CAP3:               ;
00223A F333 FE05             7      CP  5
00223C F335 28E9            12      JR  Z,CAP4
00223E F337 FE21             7      CP  021H
002240 F339 C9              10      RET
                                                    ;
       F33A                     CHDIR:
002241 F33A CDC6EB          17      CALL    GETDPBD
002244 F33D 381D            12      JR  C,CHDIR2
002246 F33F DD751A          19      LD  (IX+DPB_SDIR),L
002249 F342 DD741B          19      LD  (IX+DPB_SDIR+1),H
00224C F345 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       F347                     LDDIR:
00224E F347 CDC6EB          17      CALL    GETDPBD
002251 F34A DD5E1A          19      LD  E,(IX+DPB_SDIR)
002254 F34D DD561B          19      LD  D,(IX+DPB_SDIR+1)
002257 F350 13               6      INC DE
002258 F351 FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00225B F354 FD720F          19      LD  (IY+15),D
00225E F357 1B               6      DEC DE
00225F F358 AF               4      XOR A
002260 F359 32A0EE          13      LD  (_DIRF),A
       F35C                     CHDIR2:
002263 F35C DDE1            14      POP IX
002265 F35E C9              10      RET
                                
       F35F                     LDDIRX:
002266 F35F 3AA0EE          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
002269 F362 E67F             7      AND 07FH
       F364                     LDDIRX1:
00226B F364 3218E9          13      LD  (_SECPS),A
00226E F367 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
002271 F36A FD560F          19      LD  D,(IY+15)
002274 F36D 1B               6      DEC DE
002275 F36E CD18F3          17      CALL    ENDCL
002278 F371 D447F3          17      CALL    NC,LDDIR
       F374                     LDDIRS:
00227B F374 7A               4      LD  A,D
00227C F375 B3               4      OR  E
00227D F376 32A0EE          13      LD  (_DIRF),A   ;ディレクトリか判別
002280 F379 C9              10      RET
                                
       F37A                     KILL:
002281 F37A CD42F4          17      CALL    CHKWILDX
002284 F37D 3834            12      JR  C,KILLW
002286 F37F CD1DF1          17      CALL    SOPENX
       F382                     KILLS:
002289 F382 3E1F             7      LD  A,01FH
00228B F384 D4C6F3          17      CALL    NC,CHKATT
00228E F387 D8              11      RET C
       F388                     KILLSX:
00228F F388 36E5            10      LD  (HL),0E5H   ;DIR
002291 F38A CD1EF4          17      CALL    WTDB
002294 F38D 111A00          10      LD  DE,01AH
002297 F390 19              11      ADD HL,DE
002298 F391 5E               7      LD  E,(HL)
002299 F392 23               6      INC HL
00229A F393 56               7      LD  D,(HL)
       F394                     KILLS1:
00229B F394 CD18F3          17      CALL    ENDCL
00229E F397 D0              11      RET NC      ;CF=0
00229F F398 21FEFF          10      LD  HL,0-2
0022A2 F39B 19              11      ADD HL,DE
0022A3 F39C D0              11      RET NC      ;DE= 0 or 1
0022A4 F39D D5              11      PUSH    DE
0022A5 F39E CDF7EE          17      CALL    _GNCL
0022A8 F3A1 ED53FEEF        20      LD  (_CLPS),DE
0022AC F3A5 D1              10      POP DE
0022AD F3A6 210000          10      LD  HL,0
0022B0 F3A9 D4FAEE          17      CALL    NC,_SNCL
0022B3 F3AC D8              11      RET C
0022B4 F3AD ED5BFEEF        20      LD  DE,(_CLPS)  ;FAT
0022B8 F3B1 18E1            12      JR  KILLS1
                                
       F3B3                     KILLW:
0022BA F3B3 CD4CF1          17      CALL    SOPEN
       F3B6                     KILLW1:
0022BD F3B6 380B            12      JR  C,KILLW2
0022BF F3B8 CDEBF1          17      CALL    SOPENE2
0022C2 F3BB CD82F3          17      CALL    KILLS
0022C5 F3BE CDB0F1          17      CALL    NOPEN
0022C8 F3C1 18F3            12      JR  KILLW1
       F3C3                     KILLW2:
0022CA F3C3 C8              11      RET Z
0022CB F3C4 3F               4      CCF
0022CC F3C5 C9              10      RET
                                
       F3C6                     CHKATT:
0022CD F3C6 E5              11      PUSH    HL
0022CE F3C7 110B00          10      LD  DE,00BH
0022D1 F3CA 19              11      ADD HL,DE
0022D2 F3CB A6               7      AND (HL)
0022D3 F3CC E1              10      POP HL
0022D4 F3CD C8              11      RET Z
0022D5 F3CE 37               4      SCF
0022D6 F3CF C9              10      RET
                                
       F3D0                     NAME:
0022D7 F3D0 CD42F4          17      CALL    CHKWILDX
0022DA F3D3 D8              11      RET C
0022DB F3D4 110400          10      LD  DE,4
0022DE F3D7 19              11      ADD HL,DE
0022DF F3D8 22EDF3          16      LD  (NAMEP),HL
0022E2 F3DB 23               6      INC HL
0022E3 F3DC CD46F4          17      CALL    CHKWILD
0022E6 F3DF D8              11      RET C
                                
0022E7 F3E0 CD1DF1          17      CALL    SOPENX
0022EA F3E3 3E0F             7      LD  A,00FH
0022EC F3E5 D4C6F3          17      CALL    NC,CHKATT
0022EF F3E8 D8              11      RET C
                                
0022F0 F3E9 FDE5            15      PUSH    IY
0022F2 F3EB FD210000        14      LD  IY,0        ;自己書き換え
       F3ED                     NAMEP   EQU $-2
0022F6 F3EF CD1DF1          17      CALL    SOPENX
0022F9 F3F2 FDE3            23      EX  (SP),IY
0022FB F3F4 3F               4      CCF
0022FC F3F5 D44CF1          17      CALL    NC,SOPEN
0022FF F3F8 EB               4      EX  DE,HL
002300 F3F9 E1              10      POP HL
002301 F3FA D8              11      RET C
                                
       F3FB                     SETNAME:
002302 F3FB 01000B          10      LD  BC,11*256
002305 F3FE 23               6      INC HL
002306 F3FF 7E               7      LD  A,(HL)
002307 F400 FEE5             7      CP  0E5H
002309 F402 2004            12      JR  NZ,SNAME1
00230B F404 3E05             7      LD  A,5
00230D F406 180E            12      JR  SNAME3
       F408                     SNAME1:
00230F F408 7E               7      LD  A,(HL)
002310 F409 0C               4      INC C
002311 F40A 0D               4      DEC C
002312 F40B 2009            12      JR  NZ,SNAME3
002314 F40D CD27F3          17      CALL    CAP
002317 F410 FEA0             7      CP  0A0H
002319 F412 2002            12      JR  NZ,SNAME3
00231B F414 3E20             7      LD  A,020H
       F416                     SNAME3:
00231D F416 12               7      LD  (DE),A
00231E F417 7E               7      LD  A,(HL)
00231F F418 23               6      INC HL
002320 F419 CD2FF4          17      CALL    FKAN
002323 F41C 10EA            13      DJNZ    SNAME1
       F41E                     WTDB:               ;バッファデータが更新された
002325 F41E 3EFF             7      LD  A,0FFH
002327 F420 3239EE          13      LD  (SFILE),A
00232A F423 32A4EE          13      LD  (_WTDBF),A
00232D F426 AF               4      XOR A
00232E F427 C9              10      RET
                                
       F428                     FKANC:
00232F F428 CB41             8      BIT 0,C
002331 F42A CC30F3          17      CALL    Z,CAP2
002334 F42D 1801            12      JR  FKANX
       F42F                     FKAN:           ;漢字チェック
002336 F42F 13               6      INC DE
       F430                     FKANX:
002337 F430 CB41             8      BIT 0,C
002339 F432 CB81             8      RES 0,C
00233B F434 C0              11      RET NZ
00233C F435 FE80             7      CP  080H
00233E F437 D8              11      RET C
00233F F438 FEA0             7      CP  0A0H
002341 F43A 3803            12      JR  C,FKAN1
002343 F43C FEE0             7      CP  0E0H
002345 F43E D8              11      RET C
       F43F                     FKAN1:
002346 F43F 0C               4      INC C
002347 F440 A7               4      AND A
002348 F441 C9              10      RET
                                
       F442                     CHKWILDX:
002349 F442 FDE5            15      PUSH    IY
00234B F444 E1              10      POP HL
00234C F445 23               6      INC HL
       F446                     CHKWILD:
00234D F446 060B             7      LD  B,11
00234F F448 3E3F             7      LD  A,'?'
       F44A                     CHKWIL1:
002351 F44A BE               7      CP  (HL)
002352 F44B 23               6      INC HL
002353 F44C 37               4      SCF
002354 F44D C8              11      RET Z
002355 F44E 10FA            13      DJNZ    CHKWIL1
002357 F450 AF               4      XOR A
002358 F451 C9              10      RET
                                
       F452                     SDIRENT:        ;IY=FCB HL=DIR
002359 F452 D5              11      PUSH    DE
00235A F453 E5              11      PUSH    HL
00235B F454 FDE5            15      PUSH    IY
00235D F456 D1              10      POP DE
00235E F457 EB               4      EX  DE,HL
00235F F458 CDFBF3          17      CALL    SETNAME
                                ;               Attribute
002362 F45B FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
002365 F45E 12               7      LD  (DE),A
002366 F45F 13               6      INC DE
                                ;               Reserved
002367 F460 AF               4      XOR A
002368 F461 060A             7      LD  B,10
       F463                     SDE1:
00236A F463 12               7      LD  (DE),A
00236B F464 13               6      INC DE
00236C F465 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
00236E F467 21E4EF          10      LD  HL,SDDATA       ;(FCB)更新年月日
002371 F46A 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       F46C                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
002373 F46C 7E               7      LD  A,(HL)
002374 F46D 23               6      INC HL
002375 F46E 3273F4          13      LD  (SDPAT),A
002378 F471 FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       F473                     SDPAT   EQU $-1
00237B F474 12               7      LD  (DE),A
00237C F475 13               6      INC DE
00237D F476 10F4            13      DJNZ    SDLOOP
                                
00237F F478 AF               4      XOR A
002380 F479 E1              10      POP HL
002381 F47A D1              10      POP DE
002382 F47B C9              10      RET
                                
       F47C                     WOPEN:
002383 F47C FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
002386 F47F E61F             7      AND 01FH
002388 F481 37               4      SCF
002389 F482 C0              11      RET NZ
00238A F483 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       F487                     TOPEN2:
00238E F487 AF               4      XOR A
       F488                     TOPEN:              ;Initializes the time stamp
00238F F488 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
002393 F48C C9              10      RET
                                
       F48D                     WRDFX:
002394 F48D 3AFFF2          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       F490                     L_WRFX:
002397 F490 1F               4      RRA         ;->CF
002398 F491 3806            12      JR  C,E_WRFX
00239A F493 CB39             8      SRL C
00239C F495 CB1C             8      RR  H       ;CH=CH/2
00239E F497 18F7            12      JR  L_WRFX
       F499                     E_WRFX:
0023A0 F499 41               4      LD  B,C
0023A1 F49A 4C               4      LD  C,H
0023A2 F49B 03               6      INC BC
0023A3 F49C 3E37             7      LD  A,037H      ;SCF
0023A5 F49E 329EE7          13      LD  (DRDN1),A
                                
       F4A1                     WRDF:               ;BCクラスタ分FATを確保する
0023A8 F4A1 110200          10      LD  DE,2
0023AB F4A4 AF               4      XOR A
0023AC F4A5 3218E9          13      LD  (_SECPS),A
       F4A8                     WRDF1:
0023AF F4A8 C5              11      PUSH    BC
0023B0 F4A9 D5              11      PUSH    DE
0023B1 F4AA CDF7EE          17      CALL    _GNCL
0023B4 F4AD 381C            12      JR  C,WRDF3
0023B6 F4AF 7A               4      LD  A,D     ;空いているかチェック
0023B7 F4B0 B3               4      OR  E
0023B8 F4B1 202A            12      JR  NZ,WRDF4
0023BA F4B3 E1              10      POP HL      ;HL=空いているクラスタ
0023BB F4B4 E5              11      PUSH    HL
0023BC F4B5 ED5BFEEF        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
0023C0 F4B9 22FEEF          16      LD  (_CLPS),HL
0023C3 F4BC 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
0023C4 F4BD B3               4      OR  E
0023C5 F4BE 2008            12      JR  NZ,WRDF2
0023C7 F4C0 FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
0023CA F4C3 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
0023CD F4C6 1803            12      JR  WRDF3
       F4C8                     WRDF2:
0023CF F4C8 CDFAEE          17      CALL    _SNCL
       F4CB                     WRDF3:
0023D2 F4CB D1              10      POP DE
0023D3 F4CC C1              10      POP BC
0023D4 F4CD D8              11      RET C
0023D5 F4CE 0B               6      DEC BC
0023D6 F4CF 78               4      LD  A,B
0023D7 F4D0 B1               4      OR  C
0023D8 F4D1 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
0023DA F4D3 ED5BFEEF        20      LD  DE,(_CLPS)
0023DE F4D7 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
0023E1 F4DA C3FAEE          10      JP  _SNCL
                                
       F4DD                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
0023E4 F4DD D1              10      POP DE
0023E5 F4DE C1              10      POP BC
       F4DF                     WRDF5:
0023E6 F4DF 13               6      INC DE
0023E7 F4E0 CD18F3          17      CALL    ENDCL
0023EA F4E3 38C3            12      JR  C,WRDF1
0023EC F4E5 37               4      SCF
0023ED F4E6 C9              10      RET
                                
       F4E7                     RWXR:
0023EE F4E7 3A8DE6          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       F4EA                     L_RWX:
0023F1 F4EA 1F               4      RRA     ;->CF
0023F2 F4EB 3808            12      JR  C,E_RWX
0023F4 F4ED CB38             8      SRL B   ;BCH=BCH/2
0023F6 F4EF CB19             8      RR  C   ;
0023F8 F4F1 CB1C             8      RR  H   ;
0023FA F4F3 18F5            12      JR  L_RWX
       F4F5                     E_RWX:
0023FC F4F5 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0023FF F4F8 FD561B          19      LD  D,(IY+27)
002402 F4FB AF               4      XOR A
002403 F4FC 3218E9          13      LD  (_SECPS),A
       F4FF                     RWX1:
002406 F4FF ED53FEEF        20      LD  (_CLPS),DE
00240A F503 7A               4      LD  A,D
00240B F504 B3               4      OR  E
00240C F505 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
00240E F507 78               4      LD  A,B
00240F F508 B1               4      OR  C
002410 F509 B4               4      OR  H
002411 F50A C8              11      RET Z       ;RET BCH==0 => CF=0
                                
002412 F50B CD20E9          17      CALL    GNCLX
002415 F50E D8              11      RET C
002416 F50F 7C               4      LD  A,H     ;
002417 F510 25               4      DEC H       ;
002418 F511 B7               4      OR  A       ;DEC BCH
002419 F512 2001            12      JR  NZ,RWX2     ;
00241B F514 0B               6      DEC BC      ;
       F515                     RWX2:
00241C F515 CD18F3          17      CALL    ENDCL
00241F F518 38E5            12      JR  C,RWX1
       F51A                     SCF_RET:
002421 F51A 37               4      SCF
002422 F51B C9              10      RET
                                
       F51C                     DSKF:
002423 F51C 110000          10      LD  DE,0
       F51D                     MAXCLP  EQU $-2
002426 F51F 2AACEE          16      LD  HL,(_FAKEFREE)
002429 F522 7C               4      LD  A,H
00242A F523 B5               4      OR  L
00242B F524 2803            12      JR  Z,DSKF1
00242D F526 110100          10      LD  DE,1
       F529                     DSKF1:
002430 F529 D5              11      PUSH    DE
002431 F52A CDF7EE          17      CALL    _GNCL
002434 F52D 380C            12      JR  C,POPSCF
002436 F52F 7A               4      LD  A,D
002437 F530 B3               4      OR  E
002438 F531 2001            12      JR  NZ,DSKF2
00243A F533 23               6      INC HL
       F534                     DSKF2:
00243B F534 D1              10      POP DE
00243C F535 1B               6      DEC DE
00243D F536 7A               4      LD  A,D
00243E F537 B3               4      OR  E
00243F F538 20EF            12      JR  NZ,DSKF1
002441 F53A C9              10      RET
                                
       F53B                     POPSCF:
002442 F53B F1              10      POP AF
002443 F53C 37               4      SCF
002444 F53D C9              10      RET
                                
       F53E                     SETTMS:
002445 F53E FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
002448 F541 3C               4      INC A
002449 F542 C0              11      RET NZ      ;ファイルが更新されていない
       F543                     SETTMSX:            ;FCBに日付時刻をセットする
00244A F543 CDA6E0          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
00244D F546 CB25             8      SLA L       ;   *2
00244F F548 CB25             8      SLA L       ;   *4
002451 F54A 29              11      ADD HL,HL       ;*2 *8
002452 F54B 29              11      ADD HL,HL       ;*4 *16
002453 F54C 29              11      ADD HL,HL       ;*8 *32
002454 F54D 7A               4      LD  A,D
002455 F54E 0F               4      RRCA            ;bit.0->7->->->0->C
002456 F54F E61F             7      AND 01FH
002458 F551 B5               4      OR  L
002459 F552 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
00245C F555 FD7417          19      LD  (IY+23),H
                                
00245F F558 CD83E0          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
002462 F55B 0144F8          10      LD  BC,0-1980
002465 F55E 09              11      ADD HL,BC
002466 F55F 65               4      LD  H,L
                                
002467 F560 7A               4      LD  A,D
002468 F561 87               4      ADD A,A     ;*2
002469 F562 87               4      ADD A,A     ;*4
00246A F563 87               4      ADD A,A     ;*8
00246B F564 87               4      ADD A,A     ;*16
00246C F565 6F               4      LD  L,A
00246D F566 29              11      ADD HL,HL       ;*32
00246E F567 7D               4      LD  A,L
00246F F568 B3               4      OR  E
002470 F569 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
002473 F56C FD7415          19      LD  (IY+21),H
002476 F56F C9              10      RET
                                ;(16)
       F570                     PUSHRR:
002477 F570 3251E7          13      LD  (SETSEQ_SWC_RND),A
00247A F573 2263E7          16      LD  (SETSEQ_SWC_SEQ_RR),HL
00247D F576 CD96F5          17      CALL    GET_RR_AHL
002480 F579 220FEE          16      LD  (RR_BUF_HL),HL
002483 F57C 3211EE          13      LD  (RR_BUF_A),A
002486 F57F C9              10      RET
                                ;(14)
       F580                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
002487 F580 87               4      ADD A,A     ;in BHLA => out AHL
002488 F581 ED6A            15      ADC HL,HL
00248A F583 CB18             8      RR  B
00248C F585 B7               4      OR  A
00248D F586 78               4      LD  A,B     ;ここでフラグは変化しない
00248E F587 C8              11      RET Z
00248F F588 2C               4      INC L       ;INC AHL
002490 F589 C0              11      RET NZ      ;
002491 F58A 24               4      INC H       ;
002492 F58B C0              11      RET NZ      ;
002493 F58C 3C               4      INC A       ;
002494 F58D C9              10      RET
                                ;(18)
       F58E                     INIT_RND:
002495 F58E 3ECD             7      LD  A,0CDH      ;CALL ????
002497 F590 21ADF5          10      LD  HL,POPRR
00249A F593 CD70F5          17      CALL    PUSHRR
       F596                     GET_RR_AHL:
00249D F596 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0024A0 F599 FD6622          19      LD  H,(IY+34)   ;
0024A3 F59C FD7E23          19      LD  A,(IY+35)   ;
0024A6 F59F C9              10      RET
                                ;(10)
       F5A0                     SET_RR_AHL:
0024A7 F5A0 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0024AA F5A3 FD7422          19      LD  (IY+34),H   ;
0024AD F5A6 FD7723          19      LD  (IY+35),A   ;
0024B0 F5A9 C9              10      RET
                                ;(17)
       F5AA                     SETSEQ:
0024B1 F5AA CDCFF5          17      CALL    SETSEQ1
       F5AD                     POPRR:
0024B4 F5AD F5              11      PUSH    AF
0024B5 F5AE E5              11      PUSH    HL
0024B6 F5AF 2A0FEE          16      LD  HL,(RR_BUF_HL)
0024B9 F5B2 3A11EE          13      LD  A,(RR_BUF_A)
0024BC F5B5 CDA0F5          17      CALL    SET_RR_AHL
0024BF F5B8 E1              10      POP HL
0024C0 F5B9 F1              10      POP AF
0024C1 F5BA C9              10      RET
                                ;(20)
       F5BB                     GET_RR_BCDE:            ;BCDE=Random record
0024C2 F5BB FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
0024C5 F5BE FD5622          19      LD  D,(IY+34)
0024C8 F5C1 FD4E23          19      LD  C,(IY+35)
0024CB F5C4 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
0024CD F5C6 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0024D1 F5CA C0              11      RET NZ
0024D2 F5CB FD4624          19      LD  B,(IY+36)
0024D5 F5CE C9              10      RET
                                
       F5CF                     SETSEQ1:
0024D6 F5CF F5              11      PUSH    AF
0024D7 F5D0 E5              11      PUSH    HL      ;AHL=Random record
0024D8 F5D1 CD96F5          17      CALL    GET_RR_AHL
0024DB F5D4 47               4      LD  B,A     ;AHL→HLA
0024DC F5D5 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
0024DD F5D6 6C               4      LD  L,H     ;(IY+34)
0024DE F5D7 60               4      LD  H,B     ;(IY+35)
0024DF F5D8 0600             7      LD  B,0
                                
0024E1 F5DA CD80F5          17      CALL    GET_CPM_R_SIZE
                                
0024E4 F5DD 29              11      ADD HL,HL
0024E5 F5DE CB3D             8      SRL L       ;L=L/2
0024E7 F5E0 FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
0024EA F5E3 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
0024ED F5E6 E1              10      POP HL
0024EE F5E7 F1              10      POP AF
0024EF F5E8 C9              10      RET
                                
                                ;(23)
       F5E9                     RBXEND:             ;レコード数だけランダムレコードを進める
0024F0 F5E9 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       F5EA                     RBSIZE  EQU $-2
0024F3 F5EC CD96F5          17      CALL    GET_RR_AHL
0024F6 F5EF 19              11      ADD HL,DE
0024F7 F5F0 CE00             7      ADC A,0
0024F9 F5F2 CDA0F5          17      CALL    SET_RR_AHL
0024FC F5F5 EB               4      EX  DE,HL       ;HL=進めるレコード数
0024FD F5F6 D0              11      RET NC
0024FE F5F7 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
002502 F5FB C0              11      RET NZ
002503 F5FC FD3424          23      INC (IY+36)
002506 F5FF C9              10      RET
       F600                     FILE_E:
                                
       F1AA                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       F1AA                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       F1AA                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       F1AA                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       F1AA                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "X1DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   X1/turbo/Z
                                
       F600                     _DEVICE:
                                
                                ;   A:
                                
002507 F600 0200                    DW  2   ;DPB_FATLN
002509 F602 EBEE                    DW  _FDRD   ;DPB_DRD
00250B F604 EEEE                    DW  _FDWT   ;DPB_DWT
00250D F606 FD                      DB  0FDH    ;DPB_FATID
00250E F607 02                      DB  2   ;DPB_SECPCL
00250F F608 6401                    DW  356 ;DPB_MAXCL
002511 F60A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002512 F60B 07                      DB  7   ;DPB_DIRSCNT
002513 F60C 28                      DB  40  ;DPB_MAXCYL
002514 F60D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002515 F60E 01                      DB  1   ;DPB_FATPS
002516 F60F 82                      DB  082H    ;DPB_BPS
002517 F610 0500                    DW  5   ;DPB_DIRPS
002519 F612 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00251A F613 00                      DB  0   ;DPB_UNITNO
00251B F614 0800                    DW  8   ;DPB_ADDCL
00251D F616 0000                    DW  0   ;DPB_16
00251F F618 0000                    DW  0   ;DPB_18
002521 F61A 0000                    DW  0   ;DPB_SDIR
002523 F61C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002527 F620 0200                    DW  2   ;DPB_FATLN
002529 F622 EBEE                    DW  _FDRD   ;DPB_DRD
00252B F624 EEEE                    DW  _FDWT   ;DPB_DWT
00252D F626 FD                      DB  0FDH    ;DPB_FATID
00252E F627 02                      DB  2   ;DPB_SECPCL
00252F F628 6401                    DW  356 ;DPB_MAXCL
002531 F62A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002532 F62B 07                      DB  7   ;DPB_DIRSCNT
002533 F62C 28                      DB  40  ;DPB_MAXCYL
002534 F62D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002535 F62E 01                      DB  1   ;DPB_FATPS
002536 F62F 82                      DB  082H    ;DPB_BPS
002537 F630 0500                    DW  5   ;DPB_DIRPS
002539 F632 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00253A F633 01                      DB  1   ;DPB_UNITNO
00253B F634 0800                    DW  8   ;DPB_ADDCL
00253D F636 0000                    DW  0   ;DPB_16
00253F F638 0000                    DW  0   ;DPB_18
002541 F63A 0000                    DW  0   ;DPB_SDIR
002543 F63C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002547 F640 0200                    DW  2   ;DPB_FATLN
002549 F642 EBEE                    DW  _FDRD   ;DPB_DRD
00254B F644 EEEE                    DW  _FDWT   ;DPB_DWT
00254D F646 FD                      DB  0FDH    ;DPB_FATID
00254E F647 02                      DB  2   ;DPB_SECPCL
00254F F648 6401                    DW  356 ;DPB_MAXCL
002551 F64A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002552 F64B 07                      DB  7   ;DPB_DIRSCNT
002553 F64C 28                      DB  40  ;DPB_MAXCYL
002554 F64D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002555 F64E 01                      DB  1   ;DPB_FATPS
002556 F64F 82                      DB  082H    ;DPB_BPS
002557 F650 0500                    DW  5   ;DPB_DIRPS
002559 F652 A7                      DB  0A7H    ;DPB_DEVICE Device Number
00255A F653 02                      DB  2   ;DPB_UNITNO
00255B F654 0800                    DW  8   ;DPB_ADDCL
00255D F656 0000                    DW  0   ;DPB_16
00255F F658 0000                    DW  0   ;DPB_18
002561 F65A 0000                    DW  0   ;DPB_SDIR
002563 F65C 46444432                DB  "FDD2"  ;DPB_NAME
                                
                                ;   D:
                                
002567 F660 0200                    DW  2   ;DPB_FATLN
002569 F662 EBEE                    DW  _FDRD   ;DPB_DRD
00256B F664 EEEE                    DW  _FDWT   ;DPB_DWT
00256D F666 FD                      DB  0FDH    ;DPB_FATID
00256E F667 02                      DB  2   ;DPB_SECPCL
00256F F668 6401                    DW  356 ;DPB_MAXCL
002571 F66A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002572 F66B 07                      DB  7   ;DPB_DIRSCNT
002573 F66C 28                      DB  40  ;DPB_MAXCYL
002574 F66D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002575 F66E 01                      DB  1   ;DPB_FATPS
002576 F66F 82                      DB  082H    ;DPB_BPS
002577 F670 0500                    DW  5   ;DPB_DIRPS
002579 F672 A7                      DB  0A7H    ;DPB_DEVICE
00257A F673 03                      DB  3   ;DPB_UNITNO
00257B F674 0800                    DW  8   ;DPB_ADDCL
00257D F676 0000                    DW  0   ;DPB_16
00257F F678 0000                    DW  0   ;DPB_18
002581 F67A 0000                    DW  0   ;DPB_SDIR
002583 F67C 46444433                DB  "FDD3"  ;DPB_NAME
                                
                                ;   E:
                                
002587 F680 0000                EMMFL:  DW  0   ;DPB_FATLN
002589 F682 30DC                EMMRD:  DW  EDRD    ;DPB_DRD
00258B F684 1CDC                EMMWR:  DW  EDWT    ;DPB_DWT
00258D F686 FE                      DB  0FEH    ;DPB_FATID
00258E F687 02                      DB  2   ;DPB_SECPCL
00258F F688 0000                EMMCL:  DW  0   ;DPB_MAXCL
002591 F68A 00                      DB  0   ;DPB_FDMODE
002592 F68B 0C                      DB  12  ;DPB_DIRSCNT
002593 F68C 00                      DB  0   ;DPB_MAXCYL
002594 F68D 00                      DB  0   ;DPB_MAXSEC
002595 F68E 02                      DB  2   ;DPB_FATPS
002596 F68F 02                      DB  2   ;DPB_BPS
002597 F690 0A00                    DW  10  ;DPB_DIRPS
002599 F692 06                      DB  6   ;DPB_DEVICE
00259A F693 00                      DB  0   ;DPB_UNITNO
00259B F694 1200                    DW  18  ;DPB_ADDCL
00259D F696 0000                    DW  0   ;DPB_16
00259F F698 0000                    DW  0   ;DPB_18
0025A1 F69A 0000                    DW  0   ;DPB_SDIR
0025A3 F69C 454D4D30                DB  "EMM0"  ;DPB_NAME
                                
                                ;   F:
                                
0025A7 F6A0 0000                BANKFL: DW  0   ;DPB_FATLN
0025A9 F6A2 B4DB                    DW  BDRD    ;DPB_DRD
0025AB F6A4 B0DB                    DW  BDWT    ;DPB_DWT
0025AD F6A6 F9                      DB  0F9H    ;DPB_FATID
0025AE F6A7 02                      DB  2   ;DPB_SECPCL
0025AF F6A8 0000                BANKCL: DW  0   ;DPB_MAXCL
0025B1 F6AA 00                      DB  0   ;DPB_FDMODE
0025B2 F6AB 08                      DB  8   ;DPB_DIRSCNT
0025B3 F6AC 00                      DB  0   ;DPB_MAXCYL
0025B4 F6AD 01                      DB  1   ;DPB_MAXSEC
0025B5 F6AE 00                      DB  0   ;DPB_FATPS
0025B6 F6AF 02                      DB  2   ;DPB_BPS
0025B7 F6B0 0200                    DW  2   ;DPB_DIRPS
0025B9 F6B2 0B                  BANKDV: DB  00BH    ;DPB_DEVICE
0025BA F6B3 00                      DB  0   ;DPB_UNITNO
0025BB F6B4 0600                    DW  6   ;DPB_ADDCL
0025BD F6B6 0000                    DW  0   ;DPB_16
0025BF F6B8 0000                    DW  0   ;DPB_18
0025C1 F6BA 0000                    DW  0   ;DPB_SDIR
0025C3 F6BC 4252414D                DB  "BRAM"  ;DPB_NAME
                                
                                ;   G:
                                
0025C7 F6C0 0200                    DW  2   ;DPB_FATLN
0025C9 F6C2 71DB                    DW  GDRD    ;DPB_DRD
0025CB F6C4 88DB                    DW  GDWT    ;DPB_DWT
0025CD F6C6 FA                      DB  0FAH    ;DPB_FATID
0025CE F6C7 01                      DB  1   ;DPB_SECPCL
0025CF F6C8 B800                    DW  184 ;DPB_MAXCL
0025D1 F6CA 00                      DB  0   ;DPB_FDMODE
0025D2 F6CB 07                      DB  7   ;DPB_DIRSCNT
0025D3 F6CC 00                      DB  0   ;DPB_MAXCYL
0025D4 F6CD 01                      DB  1   ;DPB_MAXSEC
0025D5 F6CE 01                      DB  1   ;DPB_FATPS
0025D6 F6CF 01                      DB  1   ;DPB_BPS
0025D7 F6D0 0300                    DW  3   ;DPB_DIRPS
0025D9 F6D2 05                      DB  5   ;DPB_DEVICE
0025DA F6D3 01                      DB  1   ;DPB_UNITNO
0025DB F6D4 0800                    DW  8   ;DPB_ADDCL
0025DD F6D6 0000                    DW  0   ;DPB_16
0025DF F6D8 0000                    DW  0   ;DPB_18
0025E1 F6DA 0000                    DW  0   ;DPB_SDIR
0025E3 F6DC 4752414D                DB  "GRAM"  ;DPB_NAME
                                
                                ;   H:
0025E7 F6E0                         DS  32-8
0025FF F6F8 00                      DB  0
[EOF:X1DPB.ASM:UTF_8]
                                
       F6F9                     LAST_ADR:
                                
                                    END
[EOF:X1.ASZ:UTF_8]
