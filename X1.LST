0000                ;	LSX-Dodgers for X1/turbo/Z
0000                ;	Programmed by
0000                ;	Gaku (Lovers/Tablacus)
0000                
0000                	INCLUDE	"X1DEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                ;	X1/turbo/Z
0000                
0000 00 00 00 00    MAC	EQU	0		;X1
0000 00 00 00 00    DEV EQU 0
0000                
0000 00 00 CB 00    RUN	EQU	0CB00H
0000 00 00 D1 06    BDOS	EQU	0D106H
0000 00 00 EF 00    WORKAD	EQU	0EF00H
0000 00 00 F2 00    FATBF	EQU	0F200H
0000 00 00 FA 00    DTBUF	EQU	0FA00H
0000 00 00 FE 00    KEYBF	EQU	0FE00H
0000 00 00 FF 00    KBUF	EQU	0FF00H
0000 00 00 FF CA    EXTSP	EQU	0FFCAH
0000 00 00 FF D9    TRAP38	EQU	0FFD9H
0000 00 00 00 50    WIDTH	EQU	80
0000 00 00 00 18    LINE	EQU	24
0000 00 00 00 07    COLORF	EQU	7
0000 00 00 00 10    KEYSP_H	EQU	16
0000 00 00 00 C2    KEYSP_L	EQU	0C2H
0000 00 00 00 09    COMS	EQU	9
0000                
0000                	INCLUDE	"LDDEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                
0000 00 00 00 01    VER_1   EQU	1
0000 00 00 00 05    VER_2   EQU	5
0000 00 00 00 00    VER_3   EQU	0
0000 00 00 1D 00    MACW	EQU	MAC + 01D00H	;機種フラグとLD判別フラグ
0000 00 00 00 00    MACD	EQU	MAC + DEV * 256	;機種フラグとデバイスフラグ
0000 00 00 01 50    VER	EQU	VER_1 * 256 + VER_2 * 16 + VER_3
0000                
0000 00 00 00 05    SYSTEM	EQU	00005H
0000 00 00 00 0F    JP_HL	EQU	0000FH
0000 00 00 00 5C    FCB1	EQU	0005CH
0000 00 00 00 6C    FCB2	EQU	0006CH
0000 00 00 00 5D    FCB1FN	EQU	FCB1+1
0000 00 00 00 6D    FCB2FN	EQU	FCB2+1
0000 00 00 00 80    DTA1	EQU	00080H
0000                
0000 00 00 FF CA    EXTBIO	EQU	0FFCAH
0000                
0000                
0000                	ORG	RUN-7
CAF9                
CAF9                ;	MSX BINARY HEADER
CAF9 FE             	DB	0FEH
CAFA                ;	MSX BINARY START ADDRESS
CAFA 00 CB          	DW	RUN
CAFC                ;	MSX BINARY END ADDRESS
CAFC F9 F1          	DW	LAST_ADR
CAFE                ;	MSX BINARY EXEC ADDRESS
CAFE 07 CB          	DW	START
CB00                
CB00                	INCLUDE	"X1INIT.ASM"
CB00                
CB00                ;	LSX-Dodgers INIT
CB00                ;	X1/turbo/Z
CB00                
CB00 C3 07 CB       	JP	START
CB03 00 1D          	DW	MACW
CB05 50 01          	DW	VER
CB07                
CB07                START:
CB07 F3             	DI
CB08 ED 5E          	IM	2
CB0A 31 CA FF       	LD	SP,EXTSP
CB0D CD 1B CB       	CALL	INIT		;NZならAUTOEXECを実行
CB10 21 00 00       	LD	HL,0
CB13 E5             	PUSH	HL
CB14 C8             	RET	Z
CB15 11 B5 CE       	LD	DE,AUTOD
CB18 C3 FD EF       	JP	_COMANL
CB1B                
CB1B                INIT:
CB1B 3E 1E          	LD	A,01EH
CB1D D3 00          	OUT	(0),A
CB1F                
CB1F 01 00 00       	LD	BC,0
CB22 ED 43 8C EF    	LD	(_CTC),BC
CB26 01 04 0A       	LD	BC,00A04H
CB29 CD 5F CE       	CALL	CHKCTC
CB2C 01 04 07       	LD	BC,00704H
CB2F CD 5F CE       	CALL	CHKCTC
CB32 01 A8 1F       	LD	BC,01FA8H
CB35 CD 5F CE       	CALL	CHKCTC
CB38 01 A0 1F       	LD	BC,01FA0H
CB3B CD 5F CE       	CALL	CHKCTC
CB3E                ;
CB3E                INISIO:
CB3E 01 91 1F       	LD	BC,01F91H	;INIT SIO
CB41 16 01          	LD	D,1
CB43 ED 51          	OUT	(C),D
CB45                
CB45 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB47 0E 93          	LD	C,093H
CB49 ED 51          	OUT	(C),D
CB4B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB4D 0E 99          	LD	C,099H		;INIT SIO
CB4F 16 01          	LD	D,1
CB51 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB53 0E 9B          	LD	C,09BH
CB55 ED 51          	OUT	(C),D
CB57 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB59                
CB59 0E 80          	LD	C,080H		;INIT DMA
CB5B 21 06 C3       	LD	HL,0C306H
CB5E                INIDMA:
CB5E ED 61          	OUT	(C),H
CB60 2D             	DEC	L
CB61 20 FB          	JR	NZ,INIDMA
CB63                
CB63 3E E4          	LD	A,0E4H
CB65 CD 61 DE       	CALL	COMOUT
CB68 AF             	XOR	A
CB69 CD 3B DE       	CALL	OT49SB
CB6C                
CB6C 3E EF          	LD	A,INTVEC/256
CB6E ED 47          	LD	I,A
CB70                
CB70 ED 4B 8C EF    	LD	BC,(_CTC)
CB74 0D             	DEC	C
CB75 0D             	DEC	C
CB76                
CB76 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB78 3E C0          	LD	A,CTC0
CB7A ED 79          	OUT	(C),A
CB7C                
CB7C 0C             	INC	C
CB7D 3E 47          	LD	A,047H
CB7F ED 79          	OUT	(C),A
CB81 3E 0D          	LD	A,13		;Baudrate 9600-13
CB83 ED 79          	OUT	(C),A
CB85                
CB85 79             	LD	A,C
CB86 D6 10          	SUB	010H
CB88 4F             	LD	C,A
CB89                ;	LD	(SIOAD+1),BC
CB89                ;	LD	(SIOAD0+1),BC
CB89                ;	LD	(SIOAD1+1),BC
CB89                
CB89 21 06 CF       	LD	HL,SIODATA
CB8C                SINIT1:
CB8C 7E             	LD	A,(HL)
CB8D 23             	INC	HL
CB8E FE FF          	CP	0FFH
CB90 28 04          	JR	Z,SINIT2
CB92 ED 79          	OUT	(C),A
CB94 18 F6          	JR	SINIT1
CB96                SINIT2:
CB96 3E E4          	LD	A,0E4H
CB98 CD 61 DE       	CALL	COMOUT
CB9B 3E C8          	LD	A,INTVEC
CB9D CD 3B DE       	CALL	OT49SB
CBA0                ;
CBA0 01 C4 1F       	LD	BC,01FC4H
CBA3 3E 0C          	LD	A,00CH
CBA5 ED 79          	OUT	(C),A
CBA7                
CBA7 0E C0          	LD	C,0C0H
CBA9 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBAB                
CBAB 0C             	INC	C
CBAC 3E 28          	LD	A,40
CBAE ED 79          	OUT	(C),A
CBB0                
CBB0 0C             	INC	C
CBB1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBB3                
CBB3 0C             	INC	C
CBB4 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBB6                
CBB6 0E C5          	LD	C,0C5H
CBB8 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBBA                
CBBA                TEXT:
CBBA 0E B0          	LD	C,0B0H
CBBC 3E 80          	LD	A,080H
CBBE ED 79          	OUT	(C),A
CBC0 16 07          	LD	D,7
CBC2 0E B9          	LD	C,0B9H
CBC4 21 FF CE       	LD	HL,TEXTDT
CBC7                TEXT1:
CBC7 04             	INC	B
CBC8 ED A3          	OUTI
CBCA 0C             	INC	C
CBCB 15             	DEC	D
CBCC 20 F9          	JR	NZ,TEXT1
CBCE 01 B0 1F       	LD	BC,01FB0H
CBD1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBD3                
CBD3 0E C4          	LD	C,0C4H
CBD5 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBD7                
CBD7 01 01 1A       	LD	BC,01A01H
CBDA ED 78          	IN	A,(C)
CBDC E6 08          	AND	8
CBDE 28 09          	JR	Z,PRN
CBE0 0E 03          	LD	C,003H
CBE2 3E 0F          	LD	A,00FH
CBE4 ED 79          	OUT	(C),A
CBE6 01 04 0A       	LD	BC,00A04H
CBE9                PRN:
CBE9 21 00 00       	LD	HL,0
CBEC 06 5C          	LD	B,05CH
CBEE 3E FF          	LD	A,0FFH		;RST 38H
CBF0 CD B9 E0       	CALL	FILL_MEMORY
CBF3 06 A4          	LD	B,0A4H
CBF5 AF             	XOR	A
CBF6 CD B9 E0       	CALL	FILL_MEMORY
CBF9                
CBF9 3E C3          	LD	A,0C3H		;JP
CBFB 21 03 EF       	LD	HL,CPM_WBOOT
CBFE 32 00 00       	LD	(00000H),A
CC01 22 01 00       	LD	(00001H),HL	;IPL
CC04                
CC04 21 00 1D       	LD	HL,MACW	;3 bit7  DPB Compatible LA(1)
CC07 22 03 00       	LD	(00003H),HL	;  bit6-0 Machine X1(0)
CC0A                ;				;4 LSX-Dodgers(01DH)
CC0A 21 06 D1       	LD	HL,BDOS
CC0D 32 05 00       	LD	(00005H),A
CC10 22 06 00       	LD	(00006H),HL	;BDOS
CC13                
CC13 21 81 DA       	LD	HL,BIOS
CC16 22 19 00       	LD	(00019H),HL	;BIOS-ROM
CC19                
CC19 21 D9 FF       	LD	HL,TRAP38	;TRAP38
CC1C 32 38 00       	LD	(00038H),A
CC1F 22 39 00       	LD	(00039H),HL	;RST 038H
CC22                
CC22 3E EF          	LD	A,CPM_BOOT/256
CC24 32 0B 00       	LD	(0000BH),A
CC27                
CC27 3E E9          	LD	A,0E9H		;JP (HL)
CC29 32 0F 00       	LD	(0000FH),A
CC2C                
CC2C 3A 7D F0       	LD	A,(_FATBF+1)
CC2F 32 13 00       	LD	(00013H),A
CC32                
CC32 3A 7F F0       	LD	A,(_DTBUF+1)
CC35 32 17 00       	LD	(00017H),A
CC38                
CC38 3E FE          	LD	A,KEYBF/256
CC3A 32 1B 00       	LD	(0001BH),A
CC3D                
CC3D 3E FF          	LD	A,KBUF/256
CC3F 32 1F 00       	LD	(0001FH),A
CC42                
CC42 21 50 01       	LD	HL,VER
CC45 22 5A 00       	LD	(0005AH),HL
CC48                
CC48 3E E6          	LD	A,0E6H
CC4A CD 61 DE       	CALL	COMOUT
CC4D CD 46 DE       	CALL	IN49SB
CC50 F5             	PUSH	AF
CC51 CD 46 DE       	CALL	IN49SB
CC54 F1             	POP	AF
CC55 F5             	PUSH	AF
CC56 E6 12          	AND	012H
CC58 20 05          	JR	NZ,KEYR
CC5A 3E 01          	LD	A,1
CC5C 32 B2 CD       	LD	(KEYREP+1),A
CC5F                KEYR:
CC5F F1             	POP	AF
CC60 E6 03          	AND	3
CC62 28 0E          	JR	Z,NON
CC64                
CC64 01 D0 3F       	LD	BC,03FD0H
CC67 ED 49          	OUT	(C),C
CC69 3E 37          	LD	A,037H
CC6B D3 D0          	OUT	(0D0H),A
CC6D ED 78          	IN	A,(C)
CC6F B9             	CP	C
CC70 28 65          	JR	Z,TURBO
CC72                NON:
CC72 21 39 CF       	LD	HL,AT_SCR1
CC75 11 EB DE       	LD	DE,SCR1
CC78 01 94 00       	LD	BC,SCRNE-SCR1	;転送先のサイズ確認用
CC7B 01 85 00       	LD	BC,AT_SCRE-AT_SCR1
CC7E ED B0          	LDIR
CC80                
CC80 21 BE CF       	LD	HL,AT_DWT
CC83 11 33 EE       	LD	DE,WTTRK
CC86 01 8F 00       	LD	BC,DMAE-WTTRK	;転送先のサイズ確認用
CC89 01 8E 00       	LD	BC,AT_CPUE-AT_DWT
CC8C ED B0          	LDIR
CC8E                
CC8E 21 4C D0       	LD	HL,AT_EDWT
CC91 11 6C D7       	LD	DE,EDWT
CC94 01 4B 00       	LD	BC,EMME-EDWT	;転送先のサイズ確認用
CC97 01 46 00       	LD	BC,AT_EMME-AT_EDWT
CC9A ED B0          	LDIR
CC9C                
CC9C 21 66 DF       	LD	HL,AT_WTTRK+AT_RS
CC9F 22 E9 EF       	LD	(_WTTRK+1),HL
CCA2 21 7C EE       	LD	HL,AT_DRD+AT_R
CCA5 22 EC EF       	LD	(_FDRD+1),HL
CCA8 21 33 EE       	LD	HL,AT_DWT+AT_R
CCAB 22 EF EF       	LD	(_FDWT+1),HL
CCAE 21 80 D7       	LD	HL,AT_EDRD+AT_RE
CCB1 22 82 F1       	LD	(EMMRD),HL
CCB4 21 6C D7       	LD	HL,AT_EDWT+AT_RE
CCB7 22 84 F1       	LD	(EMMWR),HL
CCBA 21 6D DF       	LD	HL,AT_SCRN+AT_RS
CCBD 22 D1 EF       	LD	(_SCRN+1),HL
CCC0                
CCC0 3E 27          	LD	A,027H			;ノンターボはMFM切り替えを行わない
CCC2 32 12 F1       	LD	(DEVICE+012H),A		;Aドライブ
CCC5 32 32 F1       	LD	(DEVICE+012H+32),A	;Bドライブ
CCC8 32 52 F1       	LD	(DEVICE+012H+32*2),A	;Cドライブ
CCCB 32 72 F1       	LD	(DEVICE+012H+32*3),A	;Dドライブ
CCCE                
CCCE 21 00 00       	LD	HL,0
CCD1 22 8C DE       	LD	(X1PAT),HL
CCD4 C3 60 CD       	JP	NOBANK
CCD7                
CCD7                TURBO:
CCD7 F3             	DI			;Check BIOS
CCD8 06 1D          	LD	B,01DH
CCDA ED 79          	OUT	(C),A		;BIOS ON
CCDC 3A 51 2F       	LD	A,(02F51H)
CCDF 04             	INC	B		;B=01EH
CCE0 ED 79          	OUT	(C),A		;BIOS OFF
CCE2 FB             	EI
CCE3 FE C9          	CP	0C9H
CCE5 28 02          	JR	Z,BIOSOK
CCE7 18 05          	JR	NOBIOS
CCE9                BIOSOK:
CCE9 3E C3          	LD	A,0C3H		;JP
CCEB 32 18 00       	LD	(00018H),A
CCEE                NOBIOS:
CCEE 3E 1F          	LD	A,01FH		;スタートポート
CCF0 DB F0          	IN	A,(0F0H)
CCF2 0F             	RRCA
CCF3 38 0B          	JR	C,CRT1
CCF5 21 EF CE       	LD	HL,_C8025H
CCF8 11 B0 EF       	LD	DE,CRTCD
CCFB 01 10 00       	LD	BC,16
CCFE ED B0          	LDIR
CD00                CRT1:
CD00 3E 1F          	LD	A,01FH		;スタートポート
CD02 DB F0          	IN	A,(0F0H)
CD04 CB 57          	BIT	2,A
CD06 28 18          	JR	Z,BANK
CD08                
CD08 AF             	XOR	A
CD09                TZ1:				;前面スイッチが2HDの場合はMFMモードを2HDにしておく
CD09 F5             	PUSH	AF
CD0A CD DC EF       	CALL	_GETDPB
CD0D DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
CD10 E6 8F          	AND	08FH
CD12 FE 87          	CP	087H		;フロッピーでMEM切り替えがON
CD14 20 04          	JR	NZ,TZ2
CD16 DD CB 0A 86    	RES	0,(IX+0AH)	;(DPB_0A_FDMODE)
CD1A                TZ2:
CD1A F1             	POP	AF
CD1B 3C             	INC	A
CD1C FE 08          	CP	8
CD1E 38 E9          	JR	C,TZ1
CD20                
CD20                BANK:
CD20 01 00 0B       	LD	BC,00B00H
CD23 21 00 7F       	LD	HL,07F00H
CD26 F3             	DI
CD27 ED 69          	OUT	(C),L
CD29 3A 00 00       	LD	A,(0)
CD2C FE EB          	CP	0EBH
CD2E 20 05          	JR	NZ,BANK1
CD30 3E 2B          	LD	A,02BH
CD32 32 B2 F1       	LD	(BANKDV),A
CD35                BANK1:
CD35 ED 69          	OUT	(C),L
CD37 5E             	LD	E,(HL)
CD38 7B             	LD	A,E
CD39 C6 A5          	ADD	A,0A5H
CD3B 77             	LD	(HL),A
CD3C BE             	CP	(HL)
CD3D 73             	LD	(HL),E
CD3E 20 05          	JR	NZ,BANK2
CD40 2C             	INC	L
CD41 CB 65          	BIT	4,L
CD43 28 F0          	JR	Z,BANK1
CD45                BANK2:
CD45 3E 10          	LD	A,010H
CD47 ED 79          	OUT	(C),A
CD49 7D             	LD	A,L
CD4A B7             	OR	A
CD4B 28 13          	JR	Z,NOBANK
CD4D 26 00          	LD	H,0
CD4F 29             	ADD	HL,HL	;*2
CD50 29             	ADD	HL,HL	;*4
CD51 29             	ADD	HL,HL	;*8
CD52 29             	ADD	HL,HL	;*16
CD53 29             	ADD	HL,HL	;*32
CD54 2B             	DEC	HL	;-1
CD55 2B             	DEC	HL	;-2
CD56 2B             	DEC	HL	;-3
CD57 22 A8 F1       	LD	(BANKCL),HL
CD5A CD A5 CE       	CALL	CALC_FATLN
CD5D 32 A0 F1       	LD	(BANKFL),A
CD60                NOBANK:
CD60                EMM:
CD60 DD 21 80 F1    	LD	IX,EMMFL
CD64 CD 56 CE       	CALL	EADR0
CD67 ED 78          	IN	A,(C)
CD69 F5             	PUSH	AF
CD6A                
CD6A 11 00 00       	LD	DE,0
CD6D                ECHECK1:
CD6D 13             	INC	DE
CD6E CD 3A CE       	CALL	EADR2
CD71 ED 60          	IN	H,(C)
CD73 CD 3A CE       	CALL	EADR2
CD76 7C             	LD	A,H
CD77 C6 E5          	ADD	A,0E5H
CD79 ED 79          	OUT	(C),A
CD7B 3C             	INC	A
CD7C CD 56 CE       	CALL	EADR0
CD7F ED 79          	OUT	(C),A
CD81 3D             	DEC	A
CD82 CD 3A CE       	CALL	EADR2
CD85 ED 68          	IN	L,(C)
CD87 CD 3A CE       	CALL	EADR2
CD8A ED 61          	OUT	(C),H
CD8C BD             	CP	L
CD8D 20 04          	JR	NZ,ECHECK2
CD8F CB 5A          	BIT	3,D
CD91 28 DA          	JR	Z,ECHECK1
CD93                ECHECK2:
CD93 CD 56 CE       	CALL	EADR0
CD96 F1             	POP	AF
CD97 ED 79          	OUT	(C),A
CD99 FE EB          	CP	0EBH
CD9B 20 05          	JR	NZ,EMM_BPB
CD9D 3E 26          	LD	A,026H
CD9F 32 92 F1       	LD	(EMMDV),A
CDA2                EMM_BPB:
CDA2 21 F7 FF       	LD	HL,0-9
CDA5 19             	ADD	HL,DE
CDA6 30 09          	JR	NC,NOEMM
CDA8 22 88 F1       	LD	(EMMCL),HL
CDAB CD A5 CE       	CALL	CALC_FATLN
CDAE 32 80 F1       	LD	(EMMFL),A
CDB1                NOEMM:
CDB1 3E 00          KEYREP:	LD	A,000H
CDB3 B7             	OR	A
CDB4 28 07          	JR	Z,KEYR1
CDB6 01 00 00       	LD	BC,0
CDB9 ED 43 8C EF    	LD	(_CTC),BC
CDBD                KEYR1:
CDBD CD 86 CE       	CALL	SETCRTC
CDC0 01 30 F8       	LD	BC,0-80*25
CDC3 2A BA EF       	LD	HL,(_PAGE_MINUS)
CDC6 ED 43 BA EF    	LD	(_PAGE_MINUS),BC
CDCA 1E 0C          	LD	E,00CH
CDCC CD CD EF       	CALL	_PRINT
CDCF 22 BA EF       	LD	(_PAGE_MINUS),HL
CDD2                
CDD2 21 C1 CE       	LD	HL,INIMES
CDD5 CD F8 D7       	CALL	MSX
CDD8                
CDD8 3A 87 FF       	LD	A,(0FF87H)
CDDB FE 08          	CP	8
CDDD 30 1E          	JR	NC,INIT0
CDDF 5F             	LD	E,A
CDE0 C6 41          	ADD	A,'A'
CDE2 32 BE CE       	LD	(AUTODV),A
CDE5 0E 0E          	LD	C,00EH
CDE7 CD 05 00       	CALL	SYSTEM
CDEA 1C             	INC	E
CDEB 21 85 EF       	LD	HL,_SEEKSP	;Disk error Ignore
CDEE CB FE          	SET	7,(HL)
CDF0 0E 1B          	LD	C,01BH
CDF2 CD 05 00       	CALL	SYSTEM
CDF5                
CDF5 21 85 EF       	LD	HL,_SEEKSP
CDF8 CB BE          	RES	7,(HL)
CDFA                
CDFA 3C             	INC	A
CDFB 20 08          	JR	NZ,INIT1
CDFD                INIT0:
CDFD 1E 00          	LD	E,0
CDFF 0E 0E          	LD	C,00EH
CE01 CD 05 00       	CALL	SYSTEM
CE04 AF             	XOR	A
CE05                INIT1:
CE05 F3             	DI
CE06 08             	EX	AF,AF'
CE07 2E FE          	LD	L,0-2		;CALLのスタック分減らす
CE09 39             	ADD	HL,SP
CE0A 11 00 FF       	LD	DE,0FF00H
CE0D 45             	LD	B,L
CE0E CD E8 D4       	CALL	ZERO_MEMORY_DE
CE11 21 CA FF       	LD	HL,EXTBIO
CE14 36 C9          	LD	(HL),0C9H	;RET
CE16 23             	INC	HL
CE17 06 0E          	LD	B,TRAP38-EXTBIO-1
CE19 3E FF          	LD	A,0FFH		;RST 38H
CE1B CD B9 E0       	CALL	FILL_MEMORY
CE1E 21 12 CF       	LD	HL,AT_TRAP38
CE21 11 D9 FF       	LD	DE,TRAP38
CE24 01 27 00       	LD	BC,AT_TRAPE-AT_TRAP38
CE27 ED B0          	LDIR
CE29 08             	EX	AF,AF'
CE2A B7             	OR	A
CE2B C8             	RET	Z
CE2C                
CE2C 3E E6          	LD	A,0E6H
CE2E CD 61 DE       	CALL	COMOUT
CE31 CD 46 DE       	CALL	IN49SB
CE34 CD 46 DE       	CALL	IN49SB
CE37 FE 1B          	CP	01BH
CE39 C9             	RET
CE3A                
CE3A                EADR2:
CE3A D5             	PUSH	DE
CE3B EB             	EX	DE,HL
CE3C 29             	ADD	HL,HL
CE3D 29             	ADD	HL,HL
CE3E DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
CE41 DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
CE44 09             	ADD	HL,BC
CE45 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
CE48 06 0D          	LD	B,00DH
CE4A ED 49          	OUT	(C),C
CE4C 0C             	INC	C
CE4D ED 69          	OUT	(C),L
CE4F 0C             	INC	C
CE50 ED 61          	OUT	(C),H
CE52 0C             	INC	C
CE53 EB             	EX	DE,HL
CE54 D1             	POP	DE
CE55 C9             	RET
CE56                
CE56                EADR0:
CE56 D5             	PUSH	DE
CE57 11 00 00       	LD	DE,0
CE5A CD 3A CE       	CALL	EADR2
CE5D D1             	POP	DE
CE5E C9             	RET
CE5F                
CE5F                CHKCTC:
CE5F C5             	PUSH	BC
CE60 11 03 47       	LD	DE,04703H
CE63                INICTC1:
CE63 0C             	INC	C
CE64 ED 51          	OUT	(C),D
CE66 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CE68 1D             	DEC	E
CE69 20 F8          	JR	NZ,INICTC1
CE6B C1             	POP	BC
CE6C                
CE6C 11 FA 07       	LD	DE,007FAH
CE6F ED 51          	OUT	(C),D
CE71 ED 59          	OUT	(C),E
CE73 ED 78          	IN	A,(C)
CE75 BB             	CP	E
CE76 C0             	RET	NZ
CE77 ED 51          	OUT	(C),D
CE79 ED 51          	OUT	(C),D
CE7B ED 78          	IN	A,(C)
CE7D BA             	CP	D
CE7E C0             	RET	NZ
CE7F 0C             	INC	C
CE80 0C             	INC	C
CE81 ED 43 8C EF    	LD	(_CTC),BC
CE85 C9             	RET
CE86                
CE86                SETCRTC:
CE86 21 B0 EF       	LD	HL,CRTCD
CE89 AF             	XOR	A
CE8A                SETCRT1:
CE8A 01 00 18       	LD	BC,01800H
CE8D ED 79          	OUT	(C),A
CE8F 0C             	INC	C
CE90 04             	INC	B
CE91 ED A3          	OUTI
CE93 3C             	INC	A
CE94 FE 0C          	CP	12
CE96 20 F2          	JR	NZ,SETCRT1
CE98 23             	INC	HL
CE99 23             	INC	HL
CE9A 01 03 1B       	LD	BC,01A03H+00100H
CE9D ED A3          	OUTI
CE9F 01 D0 20       	LD	BC,01FD0H+00100H
CEA2 ED A3          	OUTI
CEA4 C9             	RET
CEA5                
CEA5                CALC_FATLN:	;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
CEA5 5D             	LD	E,L
CEA6 54             	LD	D,H
CEA7 29             	ADD	HL,HL	;*2
CEA8 19             	ADD	HL,DE	;*3
CEA9 CB 3C          	SRL	H	;/2
CEAB CB 1D          	RR	L	;1クラスタ辺り1.5バイト必要
CEAD 11 FF 01       	LD	DE,511	;切り上げる
CEB0 19             	ADD	HL,DE
CEB1 7C             	LD	A,H
CEB2 CB 3F          	SRL	A
CEB4 C9             	RET
CEB5                
CEB5 41 55 54 4F    AUTOD:	DB	"AUTOEXEC "
CEB9 45 58 45 43
CEBD 20
CEBE 41 3A 00       AUTODV:	DB	"A:",0
CEC1                
CEC1 4C 53 58 2D    INIMES:	DB	"LSX-Dodgers for X1/turbo version "
CEC5 44 6F 64 67
CEC9 65 72 73 20
CECD 66 6F 72 20
CED1 58 31 2F 74
CED5 75 72 62 6F
CED9 20 76 65 72
CEDD 73 69 6F 6E
CEE1 20
CEE2 31 2E          	DB	030H + VER_1, '.'
CEE4 35 30          	DB	030H + VER_2 ,030H + VER_3
CEE6 61             	DB	"a"
CEE7 20 47 61 6B    	DB	' Gaku',0DH,0AH
CEEB 75 0D 0A
CEEE 00             	DB	0
CEEF                
CEEF                _C8025H:
CEEF 6B 50 59 88    	DB	06BH,050H,059H,088H,01BH,001H,019H,01AH
CEF3 1B 01 19 1A
CEF7 00 0F          	DB	000H,00FH
CEF9 80 F8 B0 FF    	DW	0-80*LINE,0-80
CEFD 0C 23          	DB	00CH,023H
CEFF                
CEFF 03 0C 0F 30    TEXTDT:	DB	003H,00CH,00FH,030H,033H,03CH,03FH
CF03 33 3C 3F
CF06                
CF06                SIODATA:
CF06 18             	DB	018H
CF07 01 00          	DB	1,0
CF09 02 00          	DB	2,0
CF0B 03 C1          	DB	3,0C1H
CF0D 04 44          	DB	4,044H
CF0F 05 E8          	DB	5,0E8H
CF11 FF             	DB	0FFH
CF12                
CF12                AT_TRAP38:
CF12 21 00 00       	LD	HL,0
CF15 E3             	EX	(SP),HL
CF16 3E 24          	LD	A,'$'
CF18 CD 3E DB       	CALL	MSG_A
CF1B 2B             	DEC	HL
CF1C 7C             	LD	A,H
CF1D CD E8 FF       	CALL	PRHX+AT_RT
CF20 7D             	LD	A,L
CF21                PRHX:
CF21 F5             	PUSH	AF
CF22 07             	RLCA
CF23 07             	RLCA
CF24 07             	RLCA
CF25 07             	RLCA
CF26 CD F1 FF       	CALL	PRHX2+AT_RT
CF29 F1             	POP	AF
CF2A                PRHX2:
CF2A E6 0F          	AND	00FH
CF2C FE 0A          	CP	10
CF2E 3F             	CCF
CF2F CE 30          	ADC	A,'0'
CF31 27             	DAA
CF32 C3 3E DB       	JP	MSG_A
CF35                	DS	4
CF39                AT_TRAPE:
CF39                	INCLUDE	"X1CPU.ASM"
CF39                
CF39                ;	LSX-Dodgers CPU
CF39                ;	X1/turbo/Z
CF39                
CF39                ;	ノンターボ用パッチ
CF39                ;	DMAを使って転送している部分をCPUに差し替える
CF39                
CF39                AT_SCR1:
CF39 D9             	EXX
CF3A C5             	PUSH	BC
CF3B ED 4B B1 EF    	LD	BC,(_WIDTH)
CF3F 06 20          	LD	B,020H
CF41 D9             	EXX
CF42 C5             	PUSH	BC
CF43 01 00 20       	LD	BC,02000H
CF46                
CF46 67             	LD	H,A
CF47 B7             	OR	A
CF48                AT_SCRUP1:
CF48 28 15          	JR	Z,AT_SCRCL
CF4A C5             	PUSH	BC
CF4B CB E0          	SET	4,B
CF4D D9             	EXX
CF4E C5             	PUSH	BC
CF4F CB E0          	SET	4,B
CF51 D9             	EXX
CF52 CD 1C DF       	CALL	AT_UPSUB+AT_RS
CF55 D9             	EXX
CF56 C1             	POP	BC
CF57 D9             	EXX
CF58 C1             	POP	BC
CF59 CD 1C DF       	CALL	AT_UPSUB+AT_RS
CF5C 25             	DEC	H
CF5D 18 E9          	JR	AT_SCRUP1
CF5F                
CF5F                AT_SCRCL:
CF5F 2A B1 EF       	LD	HL,(_WIDTH)
CF62 CD B2 DD       	CALL	LINECL
CF65 C1             	POP	BC
CF66 D9             	EXX
CF67 C1             	POP	BC
CF68 D9             	EXX
CF69 C9             	RET
CF6A                
CF6A                AT_UPSUB:
CF6A 3A B1 EF       	LD	A,(_WIDTH)
CF6D 6F             	LD	L,A
CF6E                AT_UPSUB1:
CF6E D9             	EXX
CF6F ED 78          	IN	A,(C)
CF71 03             	INC	BC
CF72 D9             	EXX
CF73 ED 79          	OUT	(C),A
CF75 03             	INC	BC
CF76 2D             	DEC	L
CF77 20 F5          	JR	NZ,AT_UPSUB1
CF79 C9             	RET
CF7A                
CF7A                ;	FLOPPY DISK DRIVER(CPU)
CF7A                
CF7A                DISKC:
CF7A 1B             	DEC	DE
CF7B CB 5F          	BIT	3,A
CF7D C4 2C EE       	CALL	NZ,RNF
CF80                DISKD:
CF80 E5             	PUSH	HL
CF81 21 32 EE       	LD	HL,RETRY
CF84 35             	DEC	(HL)
CF85 E1             	POP	HL
CF86 20 0C          	JR	NZ,AT_ERR		;Retry
CF88 B7             	OR	A
CF89 28 09          	JR	Z,AT_ERR		;Error
CF8B                
CF8B                AT_DELP:
CF8B CD 2C EE       	CALL	RNF
CF8E CD 08 EE       	CALL	FDMOFF
CF91 3E FF          	LD	A,0FFH
CF93                AT_ERRZ:
CF93 BF             	CP	A
CF94                AT_ERR:
CF94 3E FF          	LD	A,0FFH
CF96 C9             	RET
CF97                ERRW:
CF97 3E FF          	LD	A,0FFH
CF99 BF             	CP	A
CF9A 37             	SCF
CF9B C3 08 EE       	JP	FDMOFF
CF9E                
CF9E                ERRDW:
CF9E D1             	POP	DE
CF9F CD 3D DF       	CALL	AT_DELP+AT_RS
CFA2 C2 41 EE       	JP	NZ,DWT0+AT_R
CFA5 B7             	OR	A
CFA6 20 EF          	JR	NZ,ERRW
CFA8 C9             	RET
CFA9                
CFA9                ERRDR:
CFA9 D1             	POP	DE
CFAA CD 3D DF       	CALL	AT_DELP+AT_RS
CFAD C2 8A EE       	JP	NZ,DRD0+AT_R
CFB0 B7             	OR	A
CFB1 20 E4          	JR	NZ,ERRW
CFB3 C9             	RET
CFB4                
CFB4                AT_WTTRK:
CFB4 06 01          	LD	B,1
CFB6 3E F4          	LD	A,0F4H
CFB8 C3 35 EE       	JP	AT_WTTRK1+AT_R
CFBB                
CFBB                AT_SCRN:
CFBB ED 78          	IN	A,(C)
CFBD C9             	RET
CFBE                AT_SCRE:
CFBE                
CFBE                AT_DWT:
CFBE 3E A0          	LD	A,0A0H
CFC0                AT_WTTRK1:
CFC0 32 D0 ED       	LD	(FDCPAT+1),A
CFC3                DWTBL:
CFC3 78             	LD	A,B
CFC4 32 78 EE       	LD	(AT_WTB+1+AT_R),A
CFC7 3E 02          	LD	A,2		;Retry count
CFC9 32 32 EE       	LD	(RETRY),A
CFCC                
CFCC                DWT0:
CFCC D5             	PUSH	DE
CFCD E5             	PUSH	HL
CFCE CD 6F ED       	CALL	SEEK		;Write disk
CFD1 E1             	POP	HL
CFD2 DA 50 DF       	JP	C,ERRDW+AT_RS
CFD5 F3             	DI
CFD6 3A D0 ED       	LD	A,(FDCPAT+1)
CFD9 CD 14 EE       	CALL	SECSET
CFDC 0E FB          	LD	C,0FBH
CFDE                
CFDE                DWT1:
CFDE 56             	LD	D,(HL)
CFDF                DWT2:
CFDF 78             	LD	A,B
CFE0 DB F8          	IN	A,(0F8H)
CFE2 0F             	RRCA
CFE3 30 08          	JR	NC,DWT4
CFE5 0F             	RRCA
CFE6 30 F7          	JR	NC,DWT2
CFE8                DWT3:
CFE8 ED 51          	OUT	(C),D
CFEA 23             	INC	HL
CFEB 18 F1          	JR	DWT1
CFED                
CFED                DWT4:
CFED 3D             	DEC	A
CFEE 28 F8          	JR	Z,DWT3
CFF0 3C             	INC	A
CFF1 FB             	EI
CFF2 D1             	POP	DE
CFF3 13             	INC	DE
CFF4 CD 08 EE       	CALL	FDMOFF
CFF7 28 09          	JR	Z,DISKOK_WT
CFF9 CD 2C DF       	CALL	DISKC+AT_RS
CFFC 20 CE          	JR	NZ,DWT0
CFFE B7             	OR	A
CFFF C2 49 DF       	JP	NZ,ERRW+AT_RS
D002                
D002                DISKOK_WT:
D002 06 01          AT_WTB:	LD	B,1
D004 10 BD          	DJNZ	DWTBL
D006 C9             	RET
D007                
D007                AT_DRD:
D007 3E 80          	LD	A,080H
D009 32 D0 ED       	LD	(FDCPAT+1),A
D00C                DRDBL:
D00C 78             	LD	A,B
D00D 32 BD EE       	LD	(AT_RDB+1+AT_R),A
D010 3E 02          	LD	A,2		;Retry count
D012 32 32 EE       	LD	(RETRY),A
D015                DRD0:
D015 D5             	PUSH	DE
D016 E5             	PUSH	HL
D017 CD 6F ED       	CALL	SEEK		;Read disk
D01A E1             	POP	HL
D01B DA 5B DF       	JP	C,ERRDR+AT_RS
D01E F3             	DI
D01F 3A D0 ED       	LD	A,(FDCPAT+1)
D022 CD 14 EE       	CALL	SECSET
D025 0E FB          	LD	C,0FBH
D027                DRD1:
D027 78             	LD	A,B
D028 DB F8          	IN	A,(0F8H)
D02A 0F             	RRCA
D02B 30 08          	JR	NC,DRD3
D02D 0F             	RRCA
D02E 30 F7          	JR	NC,DRD1
D030 ED A2          	INI
D032 04             	INC	B
D033 18 F2          	JR	DRD1
D035                
D035                DRD3:
D035 B7             	OR	A
D036 FB             	EI
D037 D1             	POP	DE
D038 13             	INC	DE
D039 CD 08 EE       	CALL	FDMOFF
D03C 28 09          	JR	Z,DISKOK_RD
D03E CD 2C DF       	CALL	DISKC+AT_RS
D041 20 D2          	JR	NZ,DRD0
D043 B7             	OR	A
D044 C2 49 DF       	JP	NZ,ERRW+AT_RS
D047                
D047                DISKOK_RD:
D047 06 01          AT_RDB:	LD	B,1
D049 10 C1          	DJNZ	DRDBL
D04B C9             	RET
D04C                
D04C                AT_CPUE:
D04C                
D04C                
D04C                ;	EMM DRIVER(CPU)
D04C                
D04C                
D04C                AT_EDWT:
D04C CD 94 D7       	CALL	AT_EADR+AT_RE
D04F                AT_EDWT0:
D04F F5             	PUSH	AF
D050 AF             	XOR	A
D051                AT_EDWT1:
D051 04             	INC	B
D052 ED A3          	OUTI
D054 04             	INC	B
D055 ED A3          	OUTI
D057 3D             	DEC	A
D058 20 F7          	JR	NZ,AT_EDWT1
D05A 13             	INC	DE
D05B F1             	POP	AF
D05C 3D             	DEC	A
D05D 20 F0          	JR	NZ,AT_EDWT0
D05F C9             	RET
D060                
D060                AT_EDRD:
D060 CD 94 D7       	CALL	AT_EADR+AT_RE
D063                AT_EDRD0:
D063 F5             	PUSH	AF
D064 AF             	XOR	A
D065                AT_EDRD1:
D065 ED A2          	INI
D067 04             	INC	B
D068 ED A2          	INI
D06A 04             	INC	B
D06B 3D             	DEC	A
D06C 20 F7          	JR	NZ,AT_EDRD1
D06E 13             	INC	DE
D06F F1             	POP	AF
D070 3D             	DEC	A
D071 20 F0          	JR	NZ,AT_EDRD0
D073 C9             	RET
D074                
D074                AT_EADR:
D074 C5             	PUSH	BC
D075 D5             	PUSH	DE
D076 EB             	EX	DE,HL
D077 29             	ADD	HL,HL
D078 DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
D07B DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
D07E 09             	ADD	HL,BC
D07F DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
D082 06 0D          	LD	B,00DH
D084 ED 49          	OUT	(C),C
D086 0C             	INC	C
D087 ED 69          	OUT	(C),L
D089 0C             	INC	C
D08A ED 61          	OUT	(C),H
D08C 0C             	INC	C
D08D EB             	EX	DE,HL
D08E D1             	POP	DE
D08F F1             	POP	AF
D090 A7             	AND	A	;CF=0
D091 C9             	RET
D092                AT_EMME:
D092                
D092 00 00 30 C7    AT_RT	EQU	TRAP38-AT_TRAP38
D092                
D092                INITE:
D092                	DS	BDOS-INITE
D106 C3 B7 D7       	JP	BDOS0
D109                	INCLUDE	"X1CCP.ASM"
D109                
D109                ;	LSX-Dodgers CCP
D109                ;	X1/turbo/Z
D109                
D109                WBOOT1:
D109 F3             	DI
D10A ED 7B 06 00    	LD	SP,(SYSTEM+1)
D10E                
D10E 3E EF          	LD	A,INTVEC/256
D110 ED 47          	LD	I,A
D112                
D112 3E E4          	LD	A,0E4H
D114 CD 61 DE       	CALL	COMOUT
D117 3E C8          	LD	A,INTVEC
D119 CD 3B DE       	CALL	OT49SB
D11C                
D11C 21 B0 EF       	LD	HL,CRTCD
D11F AF             	XOR	A
D120                SETCRT2:
D120 01 00 18       	LD	BC,01800H
D123 ED 79          	OUT	(C),A
D125 0C             	INC	C
D126 56             	LD	D,(HL)
D127 FE 0D          	CP	13
D129 38 02          	JR	C,SETCRT3
D12B 16 00          	LD	D,0
D12D                SETCRT3:
D12D ED 51          	OUT	(C),D
D12F 23             	INC	HL
D130 3C             	INC	A
D131 FE 0E          	CP	14
D133 20 EB          	JR	NZ,SETCRT2
D135                
D135 01 03 1B       	LD	BC,01A03H+00100H
D138 ED A3          	OUTI
D13A 01 D0 20       	LD	BC,01FD0H+00100H
D13D ED A3          	OUTI
D13F 21 92 EF       	LD	HL,_KEYD
D142 7E             	LD	A,(HL)
D143 36 00          	LD	(HL),0
D145 CD 2B DB       	CALL	KEYBC_IFBREAK
D148 3E 04          	LD	A,4
D14A CD 3E DB       	CALL	MSG_A
D14D                	INCLUDE	"LDCCP.ASM"
D14D                
D14D                ;	LSX-Dodgers CCP
D14D                
D14D                COMMAND:
D14D CD 00 D2       	CALL	SETDTA1
D150 3A 87 EF       	LD	A,(_DVSW)
D153 C6 41          	ADD	A,'A'
D155 CD 3E DB       	CALL	MSG_A
D158 3E 3E          	LD	A,'>'
D15A CD 3E DB       	CALL	MSG_A
D15D 3E 50          	LD	A,80
D15F 12             	LD	(DE),A
D160 CD 8D DB       	CALL	_SYS0A		;(BDOS)文字列入力
D163 CD AA D3       	CALL	LTNL
D166                
D166 11 82 00       	LD	DE,DTA1+2
D169 CD FD EF       	CALL	_COMANL
D16C 30 DF          	JR	NC,COMMAND
D16E 11 79 EF       	LD	DE,COMERM
D171 CD E9 D7       	CALL	_SYS09		;(BDOS)文字列出力
D174 C7             	RST	0
D175                
D175                COMANL:
D175 CD 0D E0       	CALL	FILE
D178 3A 19 EF       	LD	A,(FNAME+4)
D17B FE 20          	CP	020H
D17D 20 1C          	JR	NZ,COMB2
D17F D5             	PUSH	DE
D180 11 15 EF       	LD	DE,FNAME
D183 1A             	LD	A,(DE)
D184 FE 20          	CP	020H
D186 28 44          	JR	Z,SDVSW
D188 1B             	DEC	DE
D189 1A             	LD	A,(DE)
D18A C6 FF          	ADD	A,0FFH
D18C 38 09          	JR	C,COMB
D18E 13             	INC	DE
D18F                
D18F 21 8B D6       	LD	HL,COMTB
D192 06 09          	LD	B,COMS
D194 CD 91 E2       	CALL	CPNAME
D197                COMB:
D197 D1             	POP	DE
D198 D2 0F 00       	JP	NC,JP_HL
D19B                COMB2:
D19B EB             	EX	DE,HL
D19C 22 74 D2       	LD	(COMPAT+1),HL
D19F F5             	PUSH	AF
D1A0 CD 20 D2       	CALL	CEXE4
D1A3 F1             	POP	AF
D1A4 21 15 EF       	LD	HL,FNAME
D1A7 11 6D 00       	LD	DE,FCB2+1	;COMMAND NAME
D1AA 01 0B 00       	LD	BC,11
D1AD ED B0          	LDIR
D1AF 11 2E D6       	LD	DE,PATHD
D1B2                CEX1:
D1B2 1A             	LD	A,(DE)
D1B3 FE 20          	CP	020H
D1B5 D8             	RET	C
D1B6 CD 02 E0       	CALL	FILEC
D1B9 D5             	PUSH	DE
D1BA 21 6D 00       	LD	HL,FCB2+1	;COMMAND NAME
D1BD 11 15 EF       	LD	DE,FNAME
D1C0 01 0B 00       	LD	BC,11
D1C3 ED B0          	LDIR
D1C5 CD 20 D2       	CALL	CEXE4
D1C8 D1             	POP	DE
D1C9 13             	INC	DE
D1CA 18 E6          	JR	CEX1
D1CC                
D1CC                SDVSW:
D1CC F1             	POP	AF
D1CD 3A 14 EF       	LD	A,(FDRV)
D1D0 3D             	DEC	A
D1D1 5F             	LD	E,A
D1D2 0E 0E          	LD	C,00EH		;(BDOS)カレントドライブの設定
D1D4 18 31          	JR	SYSTEM0
D1D6                
D1D6                OPEN1:
D1D6 21 14 EF       	LD	HL,FDRV
D1D9                OPEN:
D1D9 0E 11          	LD	C,011H		;(BDOS)ファイルの検索
D1DB                OPEN3:
D1DB D5             	PUSH	DE
D1DC 11 09 D6       	LD	DE,DTA_CCP
D1DF CD FD D1       	CALL	SETDTA
D1E2 EB             	EX	DE,HL
D1E3 CD 07 D2       	CALL	SYSTEM0
D1E6 D1             	POP	DE
D1E7 C9             	RET
D1E8                
D1E8                OPEN2:
D1E8 0E 12          	LD	C,012H
D1EA 18 EF          	JR	OPEN3
D1EC                
D1EC                DEFCB:				;Z=Ok NZ=Error
D1EC 11 09 D6       	LD	DE,DTA_CCP
D1EF CD 05 D2       	CALL	SYSC0F
D1F2                
D1F2 11 2A D6       	LD	DE,DTA_CCP+33	;(FCB)ランダムレコード
D1F5 06 04          	LD	B,4
D1F7 CD E8 D4       	CALL	ZERO_MEMORY_DE
D1FA 11 00 01       	LD	DE,00100H
D1FD                SETDTA:
D1FD C3 C3 D9       	JP	_SYS1A		;(BDOS)DTAの設定
D200                
D200                SETDTA1:
D200 11 80 00       	LD	DE,DTA1
D203 18 F8          	JR	SETDTA
D205                
D205                SYSC0F:
D205 0E 0F          	LD	C,00FH		;(BDOS)ファイルのオープン
D207                SYSTEM0:
D207 CD 05 00       	CALL	SYSTEM
D20A B7             	OR	A
D20B C9             	RET
D20C                
D20C                C_CD:
D20C 0E 5A          	LD	C,5AH
D20E 18 F7          	JR	SYSTEM0
D210                
D210                S27BUF:
D210 3A 07 00       	LD	A,(SYSTEM+2)
D213 3D             	DEC	A
D214 E6 F8          	AND	0F8H
D216 67             	LD	H,A
D217 2E 00          	LD	L,0
D219                S27DTA:
D219 11 09 D6       	LD	DE,DTA_CCP
D21C                S27:
D21C 0E 27          	LD	C,027H		;(BDOS)ランダムブロック読み込み
D21E 18 E7          	JR	SYSTEM0
D220                
D220                CEXE4:
D220 3A 14 EF       	LD	A,(FDRV)
D223 32 57 00       	LD	(00057H),A
D226 2A 22 EF       	LD	HL,(FDRV+14)
D229 22 58 00       	LD	(00058H),HL
D22C                
D22C 21 1D EF       	LD	HL,FNAME+8
D22F 7E             	LD	A,(HL)
D230 FE 20          	CP	020H
D232 20 07          	JR	NZ,CEXE7
D234 3E 3F          	LD	A,'?'
D236 77             	LD	(HL),A
D237 23             	INC	HL
D238 77             	LD	(HL),A
D239 23             	INC	HL
D23A 77             	LD	(HL),A
D23B                CEXE7:
D23B CD D6 D1       	CALL	OPEN1
D23E                CEXE5:
D23E C0             	RET	NZ
D23F 2A 13 D6       	LD	HL,(DTA_CCP+1+9)
D242 7C             	LD	A,H
D243 CD 19 E3       	CALL	CAP
D246 67             	LD	H,A
D247 7D             	LD	A,L
D248 CD 19 E3       	CALL	CAP
D24B 6F             	LD	L,A
D24C 3A 12 D6       	LD	A,(DTA_CCP+1+8)
D24F CD 19 E3       	CALL	CAP
D252 D6 42          	SUB	'B'
D254 28 2C          	JR	Z,C_BAT
D256 3D             	DEC	A		;'C'
D257 28 05          	JR	Z,C_EXE
D259                CEXE6:
D259 CD E8 D1       	CALL	OPEN2
D25C 18 E0          	JR	CEXE5
D25E                
D25E                C_EXE:
D25E 7C             	LD	A,H
D25F FE 4D          	CP	'M'
D261 20 F6          	JR	NZ,CEXE6
D263                
D263 CD EC D1       	CALL	DEFCB
D266 CD 10 D2       	CALL	S27BUF
D269 3D             	DEC	A
D26A 37             	SCF
D26B C0             	RET	NZ
D26C 7C             	LD	A,H
D26D B5             	OR	L
D26E 37             	SCF
D26F C8             	RET	Z
D270 CD 00 D2       	CALL	SETDTA1
D273 11 00 00       COMPAT:	LD	DE,0				; self-modifying code
D276 ED 7B 06 00    	LD	SP,(SYSTEM+1)
D27A 67             	LD	H,A				; A=0 in SETDTA1(_SYS1A)
D27B 6F             	LD	L,A
D27C E5             	PUSH	HL				; push $0000 (reboot address)
D27D 24             	INC	H
D27E E5             	PUSH	HL				; push $0100 (TPA address)
D27F C3 B3 D4       	JP	SETFCB				; and JP $0100
D282                
D282                C_BAT:
D282 11 41 54       	LD	DE,'A'+'T'*256
D285 ED 52          	SBC	HL,DE
D287 20 D0          	JR	NZ,CEXE6
D289                
D289 F1             	POP	AF
D28A F1             	POP	AF
D28B CD EC D1       	CALL	DEFCB
D28E 21 00 02       	LD	HL,00200H
D291 CD 19 D2       	CALL	S27DTA
D294 C6 FE          	ADD	A,0FEH
D296 D8             	RET	C
D297 7D             	LD	A,L
D298 B7             	OR	A
D299 37             	SCF
D29A C8             	RET	Z
D29B 3C             	INC	A
D29C F5             	PUSH	AF
D29D                
D29D CD 2E DB       	CALL	KEYBC
D2A0 3E 06          	LD	A,6
D2A2 CD 3E DB       	CALL	MSG_A
D2A5 C1             	POP	BC
D2A6 21 00 01       	LD	HL,00100H
D2A9                BAT1:
D2A9 A7             	AND	A
D2AA 05             	DEC	B
D2AB C8             	RET	Z
D2AC 7E             	LD	A,(HL)
D2AD FE 25          	CP	'%'
D2AF 28 0C          	JR	Z,BAT2
D2B1                BAT1X:
D2B1 7E             	LD	A,(HL)
D2B2 23             	INC	HL
D2B3 FE 1A          	CP	01AH
D2B5 C8             	RET	Z
D2B6 FE 0A          	CP	00AH
D2B8 C4 13 DB       	CALL	NZ,KEYBS
D2BB 18 EC          	JR	BAT1
D2BD                
D2BD                BAT2:
D2BD 23             	INC	HL
D2BE 7E             	LD	A,(HL)
D2BF 2B             	DEC	HL
D2C0 D6 31          	SUB	'1'
D2C2 38 ED          	JR	C,BAT1X
D2C4 FE 09          	CP	9
D2C6 30 E9          	JR	NC,BAT1X
D2C8 23             	INC	HL
D2C9 23             	INC	HL
D2CA 3C             	INC	A
D2CB 4F             	LD	C,A
D2CC ED 5B 74 D2    	LD	DE,(COMPAT+1)
D2D0                BAT3:
D2D0 1A             	LD	A,(DE)
D2D1 B7             	OR	A
D2D2 28 D5          	JR	Z,BAT1
D2D4 CD E4 E0       	CALL	SPCUT
D2D7 0D             	DEC	C
D2D8 28 08          	JR	Z,BAT5
D2DA                BAT4:
D2DA 1A             	LD	A,(DE)
D2DB FE 21          	CP	021H
D2DD 38 F1          	JR	C,BAT3
D2DF 13             	INC	DE
D2E0 18 F8          	JR	BAT4
D2E2                BAT5:
D2E2 1A             	LD	A,(DE)
D2E3 FE 21          	CP	021H
D2E5 38 C2          	JR	C,BAT1
D2E7 13             	INC	DE
D2E8 CD 13 DB       	CALL	KEYBS
D2EB 18 F5          	JR	BAT5
D2ED                
D2ED                C_DEL:
D2ED CD B3 D4       	CALL	SETFCB
D2F0 CD 54 DB       	CALL	_SYS08		;(BDOS)エコーなしコンソール入力
D2F3                
D2F3 0E 13          	LD	C,013H
D2F5 18 0A          	JR	CDEL1		;(BDOS)ファイルの削除
D2F7                
D2F7                C_REN:
D2F7 CD B3 D4       	CALL	SETFCB
D2FA 3E 10          	LD	A,010H		;ディレクトリも対象にする
D2FC 32 69 00       	LD	(FCB1+13),A	;属性
D2FF 0E 17          	LD	C,017H		;(BDOS)ファイル名の変更
D301                CDEL1:
D301 11 5C 00       	LD	DE,FCB1
D304 CD 05 00       	CALL	SYSTEM
D307 C6 FF          	ADD	A,0FFH
D309 C9             	RET
D30A                
D30A                C_DIR:
D30A CD 02 E0       	CALL	FILEC
D30D 21 15 EF       	LD	HL,FDRV+1
D310 CD FE D5       	CALL	CWILD1
D313 3E F1          	LD	A,0F1H
D315 32 21 EF       	LD	(FDRV+13),A
D318 CD D6 D1       	CALL	OPEN1
D31B                CDIR1:
D31B B7             	OR	A
D31C 20 08          	JR	NZ,PDSKF
D31E CD 69 D3       	CALL	P_NAME
D321 CD E8 D1       	CALL	OPEN2
D324 18 F5          	JR	CDIR1
D326                
D326                PDSKF:
D326 3A 14 EF       	LD	A,(FDRV)
D329 5F             	LD	E,A
D32A 0E 1B          	LD	C,01BH		;(BDOS)ディスク情報の獲得
D32C CD 05 00       	CALL	SYSTEM
D32F 4F             	LD	C,A		;C←1クラスタ辺りの論理セクタ数
D330 C6 01          	ADD	A,001H
D332 D8             	RET	C		;Aが0FFHだった場合
D333 3E 06          	LD	A,8-2
D335                PDS1:				;HL=未使用クラスタの総数
D335 3C             	INC	A
D336 CB 19          	RR	C
D338 30 FB          	JR	NC,PDS1
D33A                PDS2:				;B←論理セクタのサイズの上位8ビット
D33A 3C             	INC	A
D33B CB 18          	RR	B
D33D 30 FB          	JR	NC,PDS2
D33F 47             	LD	B,A
D340                
D340 11 00 00       	LD	DE,0
D343                PDS3:
D343 29             	ADD	HL,HL
D344 EB             	EX	DE,HL
D345 ED 6A          	ADC	HL,HL
D347 EB             	EX	DE,HL
D348 10 F9          	DJNZ	PDS3
D34A                PDSKF1:
D34A CD E2 D3       	CALL	PRDEC_DEHL
D34D 11 6F D6       	LD	DE,FREE
D350 CD E9 D7       	CALL	_SYS09		;(BDOS)文字列出力
D353 CD D1 D3       	CALL	PUTDRV
D356 3E 5C          	LD	A,05CH		;\
D358 CD 3E DB       	CALL	MSG_A
D35B 2A 22 EF       	LD	HL,(FDRV+14)	;ディレクトリのクラスタ番号
D35E AF             	XOR	A
D35F 11 FE FF       	LD	DE,0-2
D362 19             	ADD	HL,DE
D363 23             	INC	HL
D364 DC DE D3       	CALL	C,PRDEC_HL
D367 18 41          	JR	LTNL
D369                
D369                P_NAME:
D369 3A 0A D6       	LD	A,(DTA_CCP+1)
D36C FE 2E          	CP	'.'
D36E C8             	RET	Z
D36F 11 87 D6       	LD	DE,DIRHD
D372 CD E9 D7       	CALL	_SYS09		;(BDOS)文字列出力
D375 3A 15 D6       	LD	A,(DTA_CCP+1+00BH)
D378 F5             	PUSH	AF
D379 0F             	RRCA
D37A 9F             	SBC	A,A
D37B E6 0A          	AND	'*'-020H
D37D C6 20          	ADD	A,020H
D37F CD 3E DB       	CALL	MSG_A
D382 CD D1 D3       	CALL	PUTDRV
D385 21 0A D6       	LD	HL,DTA_CCP+1
D388 CD 22 D4       	CALL	FPRNT
D38B                
D38B F1             	POP	AF
D38C CB 67          	BIT	4,A
D38E 28 08          	JR	Z,DIR3
D390 11 7C D6       	LD	DE,DIRMES
D393 CD E9 D7       	CALL	_SYS09		;(BDOS)文字列出力
D396 18 0A          	JR	DIR6
D398                DIR3:
D398 ED 5B 28 D6    	LD	DE,(DTA_CCP+1+01EH)
D39C 2A 26 D6       	LD	HL,(DTA_CCP+1+01CH)
D39F CD E2 D3       	CALL	PRDEC_DEHL
D3A2                DIR6:
D3A2 3A B1 EF       	LD	A,(_WIDTH)
D3A5 FE 29          	CP	40+1
D3A7 D4 44 D4       	CALL	NC,PRTTMS
D3AA                
D3AA                LTNL:
D3AA 1E 03          	LD	E,3
D3AC C3 CD EF       	JP	_PRINT
D3AF                
D3AF                C_PATH:
D3AF CD E4 E0       	CALL	SPCUT
D3B2 21 2E D6       	LD	HL,PATHD
D3B5 FE 21          	CP	021H
D3B7 30 0C          	JR	NC,CPATH0
D3B9                CPATHP:
D3B9 7E             	LD	A,(HL)
D3BA 23             	INC	HL
D3BB FE 20          	CP	020H
D3BD 3F             	CCF
D3BE 30 EA          	JR	NC,LTNL
D3C0 CD 3E DB       	CALL	MSG_A
D3C3 18 F4          	JR	CPATHP
D3C5                CPATH0:
D3C5 FE 3B          	CP	';'
D3C7 20 01          	JR	NZ,CPATH1
D3C9 13             	INC	DE
D3CA                CPATH1:
D3CA EB             	EX	DE,HL
D3CB 01 40 00       	LD	BC,PATHX
D3CE ED B0          	LDIR
D3D0 C9             	RET
D3D1                
D3D1                PUTDRV:
D3D1 3A 14 EF       	LD	A,(FDRV)
D3D4 C6 40          	ADD	A,'A'-1
D3D6 CD 3E DB       	CALL	MSG_A
D3D9 3E 3A          	LD	A,':'
D3DB                MSG_AR:
D3DB C3 3E DB       	JP	MSG_A
D3DE                
D3DE                PRDEC_HL:
D3DE AF             	XOR	A
D3DF                PRDEC_AHL:
D3DF 5F             	LD	E,A
D3E0 16 00          	LD	D,0
D3E2                PRDEC_DEHL:
D3E2 D5             	PUSH	DE
D3E3 11 0F EF       	LD	DE,DECBF
D3E6 06 05          	LD	B,5
D3E8 CD E8 D4       	CALL	ZERO_MEMORY_DE	;A=0
D3EB D1             	POP	DE
D3EC                
D3EC 0E 20          	LD	C,32
D3EE                DEC1:
D3EE 29             	ADD	HL,HL
D3EF EB             	EX	DE,HL
D3F0 ED 6A          	ADC	HL,HL
D3F2 EB             	EX	DE,HL
D3F3 E5             	PUSH	HL
D3F4 21 13 EF       	LD	HL,DECBF+4
D3F7 06 05          	LD	B,5
D3F9                DEC2:
D3F9 7E             	LD	A,(HL)
D3FA 8F             	ADC	A,A
D3FB 27             	DAA
D3FC 77             	LD	(HL),A
D3FD 2B             	DEC	HL
D3FE 10 F9          	DJNZ	DEC2
D400 E1             	POP	HL
D401 0D             	DEC	C
D402 20 EA          	JR	NZ,DEC1
D404                
D404 21 0F EF       	LD	HL,DECBF
D407 3E 20          	LD	A,020H
D409 06 04          	LD	B,4
D40B                DEC3:
D40B CD 18 D4       	CALL	DEC4
D40E CD 18 D4       	CALL	DEC4
D411 23             	INC	HL
D412 10 F7          	DJNZ	DEC3
D414                DECX:
D414 CD 18 D4       	CALL	DEC4
D417 AF             	XOR	A
D418                DEC4:
D418 ED 6F          	RLD
D41A FE 20          	CP	020H
D41C 28 02          	JR	Z,DEC5
D41E F6 30          	OR	030H
D420                DEC5:
D420 18 B9          	JR	MSG_AR
D422                
D422                FPRNT:
D422 06 08          	LD	B,8
D424 CD 35 D4       	CALL	P_N1
D427 7E             	LD	A,(HL)
D428 C6 80          	ADD	A,0A0H-020H
D42A FE A0          	CP	0A0H
D42C 28 02          	JR	Z,FPR1
D42E 3E 2E          	LD	A,'.'
D430                FPR1:
D430 CD 3E DB       	CALL	MSG_A
D433 06 03          	LD	B,3
D435                
D435                P_N1:
D435 C5             	PUSH	BC
D436 E5             	PUSH	HL
D437 7E             	LD	A,(HL)
D438 CD 25 E3       	CALL	CAP3
D43B CD 3E DB       	CALL	MSG_A
D43E E1             	POP	HL
D43F C1             	POP	BC
D440 23             	INC	HL
D441 10 F2          	DJNZ	P_N1
D443 C9             	RET
D444                
D444                PRTTMS:
D444 3E 20          	LD	A,020H
D446 CD 3E DB       	CALL	MSG_A
D449                
D449 2A 22 D6       	LD	HL,(DTA_CCP+1+24)
D44C 7D             	LD	A,L
D44D B7             	OR	A
D44E C8             	RET	Z
D44F CB 3C          	SRL	H
D451 17             	RLA
D452 17             	RLA
D453 17             	RLA
D454 17             	RLA
D455 E6 0F          	AND	00FH
D457 57             	LD	D,A
D458 7C             	LD	A,H
D459 C6 50          	ADD	A,80
D45B CD 9E D4       	CALL	PRDEC_A
D45E 3E 2D          	LD	A,'-'
D460 CD 3E DB       	CALL	MSG_A
D463 7A             	LD	A,D
D464 CD 9E D4       	CALL	PRDEC_A
D467 3E 2D          	LD	A,'-'
D469 CD 3E DB       	CALL	MSG_A
D46C 7D             	LD	A,L
D46D E6 1F          	AND	01FH
D46F CD 9E D4       	CALL	PRDEC_A
D472                
D472 2A 20 D6       	LD	HL,(DTA_CCP+1+22)
D475                
D475 3E 20          	LD	A,020H
D477 CD 3E DB       	CALL	MSG_A
D47A 7C             	LD	A,H
D47B 65             	LD	H,L
D47C 06 03          	LD	B,3
D47E                PRTTMS1:
D47E 1F             	RRA
D47F CB 1D          	RR	L
D481 10 FB          	DJNZ	PRTTMS1
D483 E6 1F          	AND	01FH
D485 CD 9E D4       	CALL	PRDEC_A
D488 3E 3A          	LD	A,':'
D48A CD 3E DB       	CALL	MSG_A
D48D 7D             	LD	A,L
D48E 0F             	RRCA
D48F 0F             	RRCA
D490 E6 3F          	AND	03FH
D492 CD 9E D4       	CALL	PRDEC_A
D495 3E 3A          	LD	A,':'
D497 CD 3E DB       	CALL	MSG_A
D49A 7C             	LD	A,H
D49B E6 1F          	AND	01FH
D49D 87             	ADD	A,A
D49E                
D49E                ;	PRINT10
D49E                
D49E                PRDEC_A:
D49E E5             	PUSH	HL
D49F 06 08          	LD	B,8
D4A1 4F             	LD	C,A
D4A2 AF             	XOR	A
D4A3                PRTA1:
D4A3 CB 01          	RLC	C
D4A5 8F             	ADC	A,A
D4A6 27             	DAA
D4A7 10 FA          	DJNZ	PRTA1
D4A9 21 0F EF       	LD	HL,DECBF
D4AC 77             	LD	(HL),A
D4AD AF             	XOR	A
D4AE CD 14 D4       	CALL	DECX
D4B1 E1             	POP	HL
D4B2 C9             	RET
D4B3                
D4B3                SETFCB:
D4B3 CD E4 E0       	CALL	SPCUT
D4B6 1A             	LD	A,(DE)
D4B7 FE 20          	CP	020H
D4B9 38 01          	JR	C,SETFCBA
D4BB 1B             	DEC	DE
D4BC                SETFCBA:
D4BC 06 24          	LD	B,36
D4BE 21 5C 00       	LD	HL,FCB1
D4C1 E5             	PUSH	HL
D4C2 AF             	XOR	A
D4C3 CD B9 E0       	CALL	FILL_MEMORY
D4C6 E1             	POP	HL
D4C7 D5             	PUSH	DE
D4C8 CD 29 DA       	CALL	_SYS5C		;(BDOS)ファイル名の解析
D4CB 21 6C 00       	LD	HL,FCB2
D4CE CD 29 DA       	CALL	_SYS5C		;(BDOS)ファイル名の解析
D4D1 E1             	POP	HL
D4D2 01 00 50       	LD	BC,05000H
D4D5 11 81 00       	LD	DE,00081H
D4D8                SETFCB1:
D4D8 7E             	LD	A,(HL)
D4D9 23             	INC	HL
D4DA FE 20          	CP	020H
D4DC 38 05          	JR	C,SETFCB2
D4DE 12             	LD	(DE),A
D4DF 13             	INC	DE
D4E0 0C             	INC	C
D4E1 10 F5          	DJNZ	SETFCB1
D4E3                SETFCB2:
D4E3 79             	LD	A,C
D4E4 32 80 00       	LD	(DTA1),A
D4E7 04             	INC	B
D4E8                ZERO_MEMORY_DE:
D4E8 AF             	XOR	A
D4E9                FILL_MEMORY_DE:
D4E9 12             	LD	(DE),A
D4EA 13             	INC	DE
D4EB 10 FC          	DJNZ	FILL_MEMORY_DE
D4ED C9             	RET
D4EE                
D4EE                C_COPY:
D4EE CD B3 D4       	CALL	SETFCB
D4F1                
D4F1 11 61 EF       	LD	DE,ZERO
D4F4 CD 05 E0       	CALL	FILEC2
D4F7 21 6C 00       	LD	HL,FCB2
D4FA CD 30 DA       	CALL	S29X1
D4FD                
D4FD 3E 10          	LD	A,010H
D4FF 32 69 00       	LD	(FCB1+13),A
D502 21 6D 00       	LD	HL,FCB2+1
D505 CD FE D5       	CALL	CWILD1
D508                COPY0:
D508 CD FB D5       	CALL	CWILD
D50B 21 5C 00       	LD	HL,FCB1
D50E CD D9 D1       	CALL	OPEN
D511 37             	SCF
D512                COPY1:
D512 C0             	RET	NZ
D513 CD EC D1       	CALL	DEFCB
D516                
D516 3A 16 D6       	LD	A,(DTA_CCP+13)
D519 CB 67          	BIT	4,A
D51B 28 21          	JR	Z,COPY1A
D51D                
D51D 21 5D 00       	LD	HL,FCB1+1
D520 CD 48 E4       	CALL	CHKWILD
D523 38 14          	JR	C,COPY9
D525                
D525 3E 20          	LD	A,020H
D527 32 5D 00       	LD	(FCB1+1),A
D52A 2A 23 D6       	LD	HL,(DTA_CCP+26)
D52D 23             	INC	HL
D52E 22 6A 00       	LD	(FCB1+14),HL
D531 18 D5          	JR	COPY0
D533                
D533                COPY8:
D533 CD E9 D7       	CALL	_SYS09		;(BDOS)文字列出力
D536 CD AA D3       	CALL	LTNL
D539                COPY9:
D539 CD E8 D1       	CALL	OPEN2
D53C 18 D4          	JR	COPY1
D53E                
D53E                COPY1A:
D53E 21 6C 00       	LD	HL,FCB2
D541 11 14 EF       	LD	DE,FDRV
D544 01 0B D6       	LD	BC,DTA_CCP+2
D547 ED A0          	LDI
D549 3E 0B          	LD	A,11
D54B                COPY2:
D54B F5             	PUSH	AF
D54C 7E             	LD	A,(HL)
D54D FE 3F          	CP	'?'
D54F 20 01          	JR	NZ,COPY3
D551 0A             	LD	A,(BC)
D552                COPY3:
D552 12             	LD	(DE),A
D553 03             	INC	BC
D554 13             	INC	DE
D555 23             	INC	HL
D556 F1             	POP	AF
D557 3D             	DEC	A
D558 20 F1          	JR	NZ,COPY2
D55A 01 05 00       	LD	BC,16-11
D55D ED B0          	LDIR
D55F                PUTNAME:
D55F 21 5D 00       	LD	HL,FCB1+1
D562 CD 48 E4       	CALL	CHKWILD
D565 30 0B          	JR	NC,PUTN1
D567 21 15 EF       	LD	HL,FDRV+1
D56A CD 22 D4       	CALL	FPRNT
D56D 3E 20          	LD	A,020H
D56F CD 3E DB       	CALL	MSG_A
D572                PUTN1:
D572 11 14 EF       	LD	DE,FDRV
D575 0E 16          	LD	C,016H		;(BDOS)ファイルの作成
D577 CD 07 D2       	CALL	SYSTEM0
D57A 20 48          	JR	NZ,COPYE2
D57C 67             	LD	H,A		;A=0
D57D 6F             	LD	L,A
D57E 22 35 EF       	LD	(FDRV+33),HL	;(FCB)ランダムレコード
D581 22 37 EF       	LD	(FDRV+35),HL
D584                COPY6:
D584 CD 10 D2       	CALL	S27BUF
D587 47             	LD	B,A
D588 3C             	INC	A
D589 28 31          	JR	Z,COPYE
D58B 7C             	LD	A,H
D58C B5             	OR	L
D58D 28 0C          	JR	Z,COPY7
D58F 11 14 EF       	LD	DE,FDRV
D592 0E 26          	LD	C,026H		;(BDOS)ランダムブロック書き込み
D594 CD 07 D2       	CALL	SYSTEM0
D597 20 23          	JR	NZ,COPYE
D599 10 E9          	DJNZ	COPY6
D59B                COPY7:
D59B 3A 16 D6       	LD	A,(DTA_CCP+13)	;(FCB)属性
D59E 32 21 EF       	LD	(FDRV+13),A
D5A1 21 1D D6       	LD	HL,DTA_CCP+20	;(FCB)タイムスタンプ
D5A4 11 28 EF       	LD	DE,FDRV+20
D5A7 01 04 00       	LD	BC,4
D5AA ED B0          	LDIR
D5AC                
D5AC 11 14 EF       	LD	DE,FDRV
D5AF 0E 10          	LD	C,010H		;(BDOS)ファイルのクローズ
D5B1 CD 07 D2       	CALL	SYSTEM0
D5B4 20 06          	JR	NZ,COPYE
D5B6                
D5B6 11 71 EF       	LD	DE,OK
D5B9 C3 33 D5       	JP	COPY8
D5BC                
D5BC                COPYE:
D5BC 11 14 EF       	LD	DE,FDRV
D5BF 0E 13          	LD	C,013H		;(BDOS)ファイルの削除
D5C1 CD 05 00       	CALL	SYSTEM
D5C4                COPYE2:
D5C4 37             	SCF
D5C5 C9             	RET
D5C6                
D5C6                C_TYPE:
D5C6 CD B3 D4       	CALL	SETFCB
D5C9 21 5C 00       	LD	HL,FCB1
D5CC CD D9 D1       	CALL	OPEN
D5CF 37             	SCF
D5D0                TYPE1:
D5D0 C0             	RET	NZ
D5D1 CD EC D1       	CALL	DEFCB
D5D4 3E 06          	LD	A,6
D5D6 CD 3E DB       	CALL	MSG_A
D5D9                TYPE2:
D5D9 CD 10 D2       	CALL	S27BUF
D5DC C6 FE          	ADD	A,0FEH
D5DE D8             	RET	C
D5DF 7C             	LD	A,H
D5E0 B5             	OR	L
D5E1 28 13          	JR	Z,TYPEE
D5E3 01 00 01       	LD	BC,00100H
D5E6                TYPE3:
D5E6 0A             	LD	A,(BC)
D5E7 03             	INC	BC
D5E8 FE 1A          	CP	01AH
D5EA 28 0A          	JR	Z,TYPEE
D5EC CD 3E DB       	CALL	MSG_A
D5EF 2B             	DEC	HL
D5F0 7C             	LD	A,H
D5F1 B5             	OR	L
D5F2 20 F2          	JR	NZ,TYPE3
D5F4 18 E3          	JR	TYPE2
D5F6                TYPEE:
D5F6 CD E8 D1       	CALL	OPEN2
D5F9 18 D5          	JR	TYPE1
D5FB                
D5FB                CWILD:
D5FB 21 5D 00       	LD	HL,FCB1+1
D5FE                CWILD1:
D5FE 7E             	LD	A,(HL)
D5FF FE 20          	CP	020H
D601 C0             	RET	NZ
D602                CWILD2:
D602 3E 3F          	LD	A,'?'
D604 06 0B          	LD	B,11
D606 C3 B9 E0       	JP	FILL_MEMORY
D609                
D609                DTA_CCP:
D609                	DS	37
D62E                
D62E 00 00 00 40    PATHX	EQU	64
D62E                PATHD:	DS	PATHX
D66E 00             PATHE:	DB	0
D66F                
D66F 20 62 79 74    FREE:	DB	" bytes free",9,'$'
D673 65 73 20 66
D677 72 65 65 09
D67B 24
D67C 20 20 20 20    DIRMES:	DB	"     <DIR>$"
D680 20 3C 44 49
D684 52 3E 24
D687 20 20 3A 24    DIRHD:	DB	"  :$"
D68B                
D68B                COMTB:
D68B 44 20 20 20    	DB	"D   "	;1
D68F 0A D3          	DW	C_DIR
D691 44 49 52 20    	DB	"DIR "	;2
D695 0A D3          	DW	C_DIR
D697 43 4F 50 59    	DB	"COPY"	;3
D69B EE D4          	DW	C_COPY
D69D 43 44 20 20    	DB	"CD  "	;4
D6A1 0C D2          	DW	C_CD
D6A3 44 45 4C 20    	DB	"DEL "	;5
D6A7 ED D2          	DW	C_DEL
D6A9 50 41 54 48    	DB	"PATH"	;6
D6AD AF D3          	DW	C_PATH
D6AF 52 45 4E 20    	DB	"REN "	;7
D6B3 F7 D2          	DW	C_REN
D6B5 54 59 50 45    	DB	"TYPE"	;8
D6B9 C6 D5          	DW	C_TYPE
D6BB 52 45 4D 20    	DB	"REM "	;9
D6BF E6 D7          	DW	C_REM
D6C1                	INCLUDE	"X1DISK2.ASM"
D6C1                
D6C1                ;	LSX-Dodgers DISK2
D6C1                ;	X1/turbo/Z
D6C1                
D6C1                ;	GRAPHIC RAM DISK DRIVER
D6C1                
D6C1                
D6C1                GDRD:
D6C1 C5             	PUSH	BC
D6C2 CD EA D6       	CALL	GADR
D6C5 F1             	POP	AF
D6C6                GDRD1:
D6C6 ED A2          	INI
D6C8 04             	INC	B
D6C9 0C             	INC	C
D6CA 20 FA          	JR	NZ,GDRD1
D6CC 04             	INC	B
D6CD 13             	INC	DE
D6CE 3D             	DEC	A
D6CF 20 F5          	JR	NZ,GDRD1
D6D1                GBANK0:
D6D1 3A BF EF       	LD	A,(WK1FD0)
D6D4 E6 EF          	AND	0EFH		;BANK0
D6D6 18 1D          	JR	S1FD0
D6D8                
D6D8                GDWT:
D6D8 C5             	PUSH	BC
D6D9 CD EA D6       	CALL	GADR
D6DC F1             	POP	AF
D6DD                GDWT1:
D6DD 04             	INC	B
D6DE ED A3          	OUTI
D6E0 0C             	INC	C
D6E1 20 FA          	JR	NZ,GDWT1
D6E3 04             	INC	B
D6E4 13             	INC	DE
D6E5 3D             	DEC	A
D6E6 20 F5          	JR	NZ,GDWT1
D6E8 18 E7          	JR	GBANK0
D6EA                
D6EA                GADR:
D6EA 0E 00          	LD	C,0
D6EC 7B             	LD	A,E
D6ED C6 40          	ADD	A,040H
D6EF 47             	LD	B,A
D6F0 3A BF EF       	LD	A,(WK1FD0)
D6F3 F6 10          	OR	010H		;BANK1
D6F5                S1FD0:
D6F5 C5             	PUSH	BC
D6F6 32 BF EF       	LD	(WK1FD0),A
D6F9 01 D0 1F       	LD	BC,01FD0H
D6FC ED 79          	OUT	(C),A
D6FE C1             	POP	BC
D6FF C9             	RET
D700                
D700                
D700                ;	BANK RAM DISK DRIVER
D700                
D700                BDWT:
D700 3E             	DB	03EH	;LD A,??
D701 37             	SCF
D702 18 02          	JR	BRW
D704                
D704                BDRD:
D704 3E             	DB	03EH	;LD A,??
D705 A7             	AND	A
D706                BRW:
D706 F3             	DI
D707 32 32 D7       	LD	(BRWPAT),A
D70A ED 73 52 D7    	LD	(BANKSP+1),SP
D70E 3A 53 D7       	LD	A,(BANKSP+2)
D711 87             	ADD	A,A
D712 38 03          	JR	C,BRW0
D714 31 CA FF       	LD	SP,EXTSP
D717                BRW0:
D717 D9             	EXX		;裏レジスタ
D718 C5             	 PUSH	 BC
D719 D5             	 PUSH	 DE
D71A 01 00 0B       	 LD	 BC,00B00H	 ;バンクメモリ
D71D 11 10 10       	 LD	 DE,01010H
D720 D9             	 EXX		;表レジスタ
D721                BRW1:
D721 C5             	PUSH	BC
D722 D5             	PUSH	DE
D723 EB             	EX	DE,HL
D724 29             	ADD	HL,HL
D725 29             	ADD	HL,HL
D726 7C             	LD	A,H
D727 DD 86 0C       	ADD	A,(IX+00CH)	;DPB_0C_MAXCYL
D72A E6 0F          	AND	00FH	;バンク
D72C 65             	LD	H,L
D72D CB 3C          	SRL	H	;/2
D72F 2E 00          	LD	L,0
D731 D9             	EXX		;裏レジスタ
D732 A7             BRWPAT:	 AND	 A	;自己書き換え(AND A:読み出し/SCF:書き込み)
D733 38 08          	 JR	 C,BRWT
D735 57             	 LD	 D,A	 ;D=バンク
D736 D9             	 EXX		;表レジスタ
D737 EB             	EX	DE,HL
D738 CD 56 D7       	CALL	BTFR
D73B 18 06          	JR	BRW2
D73D                BRWT:
D73D 5F             	 LD	E,A	 ;E=バンク
D73E D9             	 EXX		;表レジスタ
D73F CD 56 D7       	CALL	BTFR
D742 EB             	EX	DE,HL
D743                BRW2:
D743 D1             	POP	DE
D744 C1             	POP	BC
D745 13             	INC	DE
D746 10 D9          	DJNZ	BRW1
D748                
D748 D9             	EXX		;裏レジスタ
D749 3E 10          	 LD	 A,10H
D74B ED 79          	 OUT	 (C),A		;メインメモリに切り替える
D74D D1             	 POP	 DE
D74E C1             	 POP	 BC
D74F D9             	 EXX		;表レジスタ
D750 AF             	XOR	A
D751 31 00 00       BANKSP:	LD	SP,0
D754 FB             	EI
D755 C9             	RET
D756                
D756                ;メインメモリ←→バンクメモリ 512バイトの転送を行う
D756                ; DE:転送元アドレス
D756                ; HL:転送先アドレス
D756                ; 裏BC:バンク切り替えポート(0B00H)
D756                ; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
D756                ; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
D756                
D756                BTFR:
D756 06 00          	LD	B,0	;256回ループ(256*2)
D758                BTFR1:
D758 D9             	EXX		;裏レジスタ
D759 ED 51          	 OUT	 (C),D	 ;BANK(MAIN)
D75B D9             	 EXX		;表レジスタ
D75C 1A             	LD	A,(DE)
D75D 4F             	LD	C,A
D75E 13             	INC	DE
D75F 1A             	LD	A,(DE)
D760 13             	INC	DE
D761 D9             	EXX		;裏レジスタ
D762 ED 59          	 OUT	 (C),E	 ;MAIN(BANK)
D764 D9             	 EXX		;表レジスタ
D765 71             	LD	(HL),C
D766 23             	INC	HL
D767 77             	LD	(HL),A
D768 23             	INC	HL
D769 10 ED          	DJNZ	BTFR1
D76B C9             	RET
D76C                
D76C                ;	EMM DRIVER(DMA)
D76C                
D76C                
D76C                EDWT:
D76C 0E 0F          	LD	C,15
D76E 18 02          	JR	EDWT1
D770                EDRD:
D770 0E 0E          	LD	C,14
D772                EDWT1:
D772 C5             	PUSH	BC
D773 D5             	PUSH	DE
D774 22 B4 D7       	LD	(DMAB),HL
D777 78             	LD	A,B
D778 87             	ADD	A,A
D779 3D             	DEC	A
D77A 32 AD D7       	LD	(DMALEN+1),A
D77D 3C             	INC	A
D77E 84             	ADD	A,H	;HL(アドレス)を先に進めておく
D77F 67             	LD	H,A
D780 EB             	EX	DE,HL
D781 29             	ADD	HL,HL
D782 DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
D785 79             	LD	A,C
D786 DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
D789 09             	ADD	HL,BC
D78A DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
D78D 06 0D          	LD	B,00DH
D78F ED 49          	OUT	(C),C
D791 0C             	INC	C
D792 ED 69          	OUT	(C),L
D794 0C             	INC	C
D795 ED 61          	OUT	(C),H
D797                
D797 21 A8 D7       	LD	HL,EDMAD
D79A CD 17 DF       	CALL	SETDMA
D79D CD 3F DF       	CALL	GO_DMA
D7A0 EB             	EX	DE,HL
D7A1 D1             	POP	DE
D7A2 C1             	POP	BC
D7A3                DMA_ADD_SEC:
D7A3 13             	INC	DE
D7A4 10 FD          	DJNZ	DMA_ADD_SEC
D7A6 AF             	XOR	A
D7A7 C9             	RET
D7A8                
D7A8                EDMAD:
D7A8 C3             	DB	0C3H	;WR6 リセット
D7A9 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
D7AA 03 0D          	DW	00D03H	;ポートA開始アドレス EMMリード/ライト
D7AC FF 01          DMALEN:	DW	001FFH	;ブロック長(転送サイズ-1)
D7AE 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
D7AF 50             	DB	050H	;WR2 ポートBアドレスインクリメント メモリ
D7B0 02             	DB	002H	;ポートBタイミング
D7B1 80             	DB	080H	;WR3
D7B2 9A             	DB	09AH	;WR5 WAIT RDY:HIGH
D7B3 AD             	DB	0ADH	;WR4 連続 ポートB開始アドレス
D7B4 00 00          DMAB:	DW	0
D7B6 01             	DB	001H	;WR0 ポートA←ポートB 転送
D7B7                EMME:
D7B7                
D7B7 00 00 07 20    AT_RE	EQU	EDWT-AT_EDWT
D7B7                
D7B7                	INCLUDE	"LDOS.ASM"
D7B7                
D7B7                ;	LSX-Dodgers OS
D7B7                
D7B7                BDOS0:
D7B7 E5             	PUSH	HL
D7B8 79             	LD	A,C
D7B9 FE 3C          	CP	03CH
D7BB 38 02          	JR	C,DOS1
D7BD 3E 3C          	LD	A,03CH
D7BF                DOS1:
D7BF 87             	ADD	A,A
D7C0 6F             	LD	L,A
D7C1 26 F0          	LD	H,STABLE/256
D7C3 7E             	LD	A,(HL)
D7C4 2C             	INC	L
D7C5 66             	LD	H,(HL)
D7C6 6F             	LD	L,A
D7C7 E3             	EX	(SP),HL
D7C8 79             	LD	A,C
D7C9                ;確認用
D7C9                ;	LD	(0050H),A
D7C9 C9             	RET
D7CA                _DOS2:
D7CA FE 5A          	CP	05AH		;(BDOS)カレントディレクトリの変更(_CHDIR)
D7CC CA 6D DA       	JP	Z,_SYS5A
D7CF FE 5C          	CP	05CH		;(BDOS)ファイル名の解析(_PFILE)
D7D1 CA 29 DA       	JP	Z,_SYS5C
D7D4 FE 5F          	CP	05FH		;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
D7D6 CA 53 ED       	JP	Z,_SYS5F
D7D9 FE 6F          	CP	06FH		;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
D7DB 20 0A          	JR	NZ,_ERROR
D7DD 01 1D 01       	LD	BC,011DH
D7E0 11 50 01       	LD	DE,VER
D7E3 21 00 00       	LD	HL,MACD
D7E6                C_REM:
D7E6 AF             	XOR	A
D7E7                _ERROR:
D7E7 A7             	AND	A
D7E8 C9             	RET
D7E9                
D7E9                _SYS09:		;文字列出力
D7E9 D5             	PUSH	DE
D7EA                _SX09:
D7EA 1A             	LD	A,(DE)
D7EB 13             	INC	DE
D7EC FE 24          	CP	'$'
D7EE 28 31          	JR	Z,SX0E2
D7F0 CD 3E DB       	CALL	MSG_A
D7F3 18 F5          	JR	_SX09
D7F5                
D7F5                MSX1:
D7F5 CD 3E DB       	CALL	MSG_A
D7F8                MSX:
D7F8 7E             	LD	A,(HL)
D7F9 23             	INC	HL
D7FA B7             	OR	A
D7FB 20 F8          	JR	NZ,MSX1
D7FD C9             	RET
D7FE                
D7FE                _SYS0C:		;(BDOS)バージョン番号の獲得
D7FE 21 22 00       	LD	HL,00022H
D801 7D             	LD	A,L
D802 C9             	RET
D803                
D803                _SYS0D:		;(BDOS)ディスクリセット
D803 CD DF EF       	CALL	_FFLUSH
D806 E5             	PUSH	HL
D807 21 80 00       	LD	HL,00080H
D80A 22 8A EF       	LD	(_DTA),HL
D80D E1             	POP	HL
D80E D5             	PUSH	DE
D80F 1E 00          	LD	E,0
D811 3E             	DB	03EH
D812                
D812                _SYS0E:		;(BDOS)カレントドライブの設定
D812 D5             	PUSH	DE
D813 7B             	LD	A,E
D814 DD E5          	PUSH	IX
D816 CD DC EF       	CALL	_GETDPB
D819 DD E1          	POP	IX
D81B 38 04          	JR	C,SX0E2
D81D 7B             	LD	A,E
D81E 32 87 EF       	LD	(_DVSW),A
D821                SX0E2:
D821 3E 08          	LD	A,8
D823 D1             	POP	DE
D824 C9             	RET
D825                
D825                _SYS0F:		;(BDOS)ファイルのオープン
D825 CD F6 E0       	CALL	SETDRV
D828 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D82B C6 02          	ADD	A,002H		;Write
D82D 28 48          	JR	Z,FEND0F
D82F CD 44 E4       	CALL	CHKWILDX
D832                
D832 D4 16 E1       	CALL	NC,SOPENX
D835                _S16XX:
D835 38 40          	JR	C,FEND0F
D837                				;Directory location
D837 3A 9F EF       	LD	A,(_FILEN)
D83A FD 77 19       	LD	(IY+25),A	;(FCB)ディレクトリロケーション
D83D                ;				_DIRF
D83D 3A A0 EF       	LD	A,(_DIRF)
D840 FD 77 1D       	LD	(IY+29),A	;(FCB)ディレクトリモード
D843                ;				_FBPS
D843 FD 73 1E       	LD	(IY+30),E	;(FCB)ディレクトリポジション
D846 FD 72 1F       	LD	(IY+31),D
D849                ;				Open(Read)
D849 FD 36 1C FF    	LD	(IY+28),0FFH	;(FCB)オープンモード
D84D                ;				FILENAME
D84D FD E5          	PUSH	IY
D84F D1             	POP	DE
D850 13             	INC	DE
D851 01 0B 00       	LD	BC,11
D854 ED B0          	LDIR
D856                ;				Attribute
D856 7E             	LD	A,(HL)
D857 FD 77 0D       	LD	(IY+13),A	;(FCB)属性(アトリビュート)
D85A 11 0B 00       	LD	DE,11		;Reserved
D85D 19             	ADD	HL,DE
D85E                					;(FCB)ファイルを最後に変更した時刻
D85E 11 EA F0       	LD	DE,SDDATA		;(FCB)ファイルを最後に変更した日付
D861 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
D863                S16LOOP:				;(FCB)ファイルのサイズ(バイト単位)
D863 1A             	LD	A,(DE)
D864 13             	INC	DE
D865 32 6C D8       	LD	(S16PAT+2),A
D868 7E             	LD	A,(HL)
D869 23             	INC	HL
D86A FD 77 00       S16PAT:	LD	(IY+0),A
D86D 10 F4          	DJNZ	S16LOOP
D86F                
D86F AF             	XOR	A
D870 FD 77 0C       	LD	(IY+12),A	;(FCB)カレントブロック
D873 FD 22 1B D9    	LD	(OFCB+1),IY
D877                FEND0F:
D877 18 45          	JR	FEND10
D879                
D879                _SYS10:		;(BDOS)ファイルのクローズ
D879 CD F6 E0       	CALL	SETDRV
D87C FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D87F D6 FE          	SUB	0FEH
D881 37             	SCF
D882 3F             	CCF
D883 20 39          	JR	NZ,FEND10
D885                _S10A:				;Write
D885 FD 77 0E       	LD	(IY+14),A	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D888 FD 77 0F       	LD	(IY+15),A
D88B                
D88B FD 34 1C       	INC	(IY+28)		;0FEH->0FFH ;オープンモード
D88E CD 3C E5       	CALL	SETTMS
D891                
D891 FD 7E 1D       	LD	A,(IY+29)	;(FCB)ディレクトリモード
D894 32 A0 EF       	LD	(_DIRF),A
D897 E6 7F          	AND	07FH
D899 32 85 EA       	LD	(_SECPS+1),A
D89C FD 5E 1E       	LD	E,(IY+30)	;(FCB)ディレクトリポジション
D89F FD 56 1F       	LD	D,(IY+31)
D8A2 CD 4A E2       	CALL	READ_DIR
D8A5 38 17          	JR	C,FEND10
D8A7                
D8A7 3A 74 E1       SDECM1:	LD	A,(SDECPAT+1)	;1セクタ辺りのディレクトリエントリ数
D8AA 3D              	DEC	A		;1024=01FH / 512=00FH / 256=7
D8AB FD A6 19       	AND	(IY+25)		;(FCB)ディレクトリロケーション
D8AE 6F             	LD	L,A
D8AF 26 00          	LD	H,0
D8B1 29             	ADD	HL,HL		;*2
D8B2 29             	ADD	HL,HL		;*4
D8B3 29             	ADD	HL,HL		;*8
D8B4 29             	ADD	HL,HL		;*16
D8B5 29             	ADD	HL,HL		;*32
D8B6 ED 4B 7E F0    	LD	BC,(_DTBUF)
D8BA 09             	ADD	HL,BC
D8BB                
D8BB CD 54 E4       	CALL	SDIRENT
D8BE                FEND10:
D8BE 18 42          	JR	FEND
D8C0                
D8C0                _SYS11:		;(BDOS)最初のファイルの検索
D8C0 CD F6 E0       	CALL	SETDRV
D8C3 CD 43 E1       	CALL	SOPEN
D8C6                _S12X1:
D8C6 38 3A          	JR	C,FEND
D8C8 CD E3 E1       	CALL	SOPENE2
D8CB ED 5B 8A EF    	LD	DE,(_DTA)
D8CF 3A 88 EF       	LD	A,(_DRV)
D8D2 3C             	INC	A
D8D3 12             	LD	(DE),A
D8D4 D5             	PUSH	DE
D8D5 13             	INC	DE
D8D6 01 20 00       	LD	BC,32
D8D9 ED B0          	LDIR
D8DB FD 6E 0E       	LD	L,(IY+14)	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D8DE FD 66 0F       	LD	H,(IY+15)
D8E1 22 F4 F0       	LD	(SCDIR),HL
D8E4 2A 9A EF       	LD	HL,(_FBPS)
D8E7 22 F6 F0       	LD	(SFBPS),HL
D8EA 2A 9F EF       	LD	HL,(_FILEN)
D8ED 7C             	LD	A,H
D8EE B7             	OR	A
D8EF 28 06          	JR	Z,_S12DIR
D8F1 3A 85 EA       	LD	A,(_SECPS+1)
D8F4 F6 80          	OR	080H
D8F6 67             	LD	H,A
D8F7                _S12DIR:
D8F7 22 F8 F0       	LD	(SFNDF),HL	;Directory position and Flags
D8FA E1             	POP	HL
D8FB 11 39 EF       	LD	DE,SFILE
D8FE 0E 21          	LD	C,33
D900                _S11B:
D900 ED B0          	LDIR
D902                FEND:
D902 9F             	SBC	A,A		;CF=0 A=0 : CF=1 A=0FFH
D903                FENDE:
D903 FD E1          	POP	IY
D905 C1             	POP	BC
D906 D1             	POP	DE
D907 E1             	POP	HL
D908 C9             	RET
D909                
D909                _SYS12:		;(BDOS)次のファイルの検索
D909 E5             	PUSH	HL
D90A D5             	PUSH	DE
D90B C5             	PUSH	BC
D90C FD E5          	PUSH	IY
D90E CD A7 E1       	CALL	NOPEN
D911 18 B3          	JR	_S12X1
D913                
D913                _S16K:
D913 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D916 FE FD          	CP	0FDH		;Device(0FDH)
D918 37             	SCF
D919 C8             	RET	Z
D91A                
D91A 11 00 00       OFCB:	LD	DE,0
D91D D5             	PUSH	DE
D91E 06 1A          	LD	B,26		;First cluster
D920                S16K1:
D920 13             	INC	DE
D921 23             	INC	HL
D922 10 FC          	DJNZ	S16K1
D924                
D924 1A             	LD	A,(DE)
D925 BE             	CP	(HL)
D926 20 13          	JR	NZ,S16K2
D928 13             	INC	DE
D929 23             	INC	HL
D92A 1A             	LD	A,(DE)
D92B BE             	CP	(HL)
D92C 20 0D          	JR	NZ,S16K2
D92E                
D92E E1             	POP	HL
D92F FD E5          	PUSH	IY
D931 D1             	POP	DE
D932 1A             	LD	A,(DE)		;Drive
D933 BE             	CP	(HL)
D934 20 06          	JR	NZ,S16K3
D936                				;ここはCFが必ず0
D936 ED 52          	SBC	HL,DE		;CP HL,DE
D938 37             	SCF
D939 C0             	RET	NZ
D93A E5             	PUSH	HL
D93B                S16K2:
D93B E1             	POP	HL
D93C                S16K3:
D93C FD E5          	PUSH	IY
D93E D1             	POP	DE
D93F                _SYS13:		;(BDOS)ファイルの削除
D93F CD F6 E0       	CALL	SETDRV
D942 CD 74 E3       	CALL	KILL
D945                FEND13:
D945 18 BB          	JR	FEND
D947                
D947                _SYS14:		;(BDOS)シーケンシャルな読み出し
D947 CD F6 E0       	CALL	SETDRV
D94A CD A8 E5       	CALL	INIT_SEQ
D94D                SREAD:
D94D CD F2 E5       	CALL	RB_READ
D950                
D950 C6 01          	ADD	A,001H
D952 38 AE          	JR	C,FEND
D954                
D954 7D             	LD	A,L
D955 D6 01          	SUB	001H
D957                FENDX:
D957 9F             	SBC	A,A
D958 E6 03          	AND	3
D95A 1F             	RRA
D95B 18 A6          	JR	FENDE
D95D                
D95D                _SYS15:		;(BDOS)シーケンシャルな書き込み
D95D CD F6 E0       	CALL	SETDRV
D960 CD A8 E5       	CALL	INIT_SEQ
D963                SWRITE:
D963 CD EB E5       	CALL	RB_WRITE
D966                
D966 C6 FF          	ADD	A,0FFH
D968 18 ED          	JR	FENDX
D96A                
D96A                _SYS17:		;(BDOS)ファイル名の変更
D96A CD F6 E0       	CALL	SETDRV
D96D CD CA E3       	CALL	NAME
D970 18 D3          	JR	FEND13
D972                
D972                _SYS16:		;(BDOS)ファイルの作成
D972 CD F6 E0       	CALL	SETDRV
D975                
D975 CD 44 E4       	CALL	CHKWILDX
D978 38 CB          	JR	C,FEND13
D97A FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
D97D FE 05          	CP	5
D97F 28 05          	JR	Z,_S16X2
D981 FE 21          	CP	021H
D983 DA 45 D9       	JP	C,FEND13
D986                _S16X2:
D986                ;				Clear FCB
D986 FD E5          	PUSH	IY
D988 E1             	POP	HL
D989 01 10 00       	LD	BC,16
D98C 09             	ADD	HL,BC
D98D                _S16X1:
D98D 70             	LD	(HL),B		;B=0
D98E 23             	INC	HL
D98F 0D             	DEC	C
D990 20 FB          	JR	NZ,_S16X1
D992                
D992 CD 41 E5       	CALL	SETTMSX
D995 FD 36 0D FF    	LD	(IY+13),0FFH	;(FCB)Attribute
D999 CD 16 E1       	CALL	SOPENX
D99C 3F             	CCF
D99D CC 13 D9       	CALL	Z,_S16K
D9A0 D4 F4 E1       	CALL	NC,COPEN
D9A3 D4 54 E4       	CALL	NC,SDIRENT
D9A6 C3 35 D8       	JP	_S16XX
D9A9                
D9A9                _SYS21:		;(BDOS)ランダムな読み出し
D9A9 CD F6 E0       	CALL	SETDRV
D9AC CD 8C E5       	CALL	INIT_RND
D9AF 18 9C          	JR	SREAD
D9B1                
D9B1                _SYS22:		;(BDOS)ランダムな書き込み
D9B1                _SYS28:		;(BDOS)ランダムな書き込み・その2
D9B1 CD F6 E0       	CALL	SETDRV
D9B4 CD 8C E5       	CALL	INIT_RND
D9B7 18 AA          	JR	SWRITE
D9B9                
D9B9                _SYS18:		;(BDOS)ログインベクトルの獲得
D9B9 21 FF 00       	LD	HL,000FFH
D9BC AF             	XOR	A
D9BD C9             	RET
D9BE                
D9BE                _SYS19:		;(BDOS)カレントドライブ番号の獲得
D9BE 3A 87 EF       	LD	A,(_DVSW)
D9C1 A7             	AND	A
D9C2 C9             	RET
D9C3                
D9C3                _SYS1A:		;(BDOS)DTAの設定
D9C3 ED 53 8A EF    	LD	(_DTA),DE
D9C7 AF             	XOR	A
D9C8 C9             	RET
D9C9                
D9C9                _SYS1B:		;(BDOS)ディスク情報の獲得
D9C9 7B             	LD	A,E
D9CA CD 09 E1       	CALL	GETDRV
D9CD CD DC EF       	CALL	_GETDPB
D9D0 D4 E2 EF       	CALL	NC,_RDFATX
D9D3 21 00 00       	LD	HL,0
D9D6 D4 1A E5       	CALL	NC,DSKF
D9D9                
D9D9 ED 5B 1B E5    	LD	DE,(MAXCLP+1)	;DPB_08_MAXCL-1
D9DD 1B             	DEC	DE		;DE←クラスタの総数
D9DE FD 2A 7C F0    	LD	IY,(_FATBF)	;IY←メモリ上のFATの先頭アドレス
D9E2 9F             	SBC	A,A
D9E3 D8             	RET	C
D9E4 4F             	LD	C,A		;C=0
D9E5 DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS
D9E8 E6 0F          	AND	00FH
D9EA 47             	LD	B,A
D9EB DD 7E 07       	LD	A,(IX+7)	;DPB_07_SECPCL
D9EE C9             	RET
D9EF                
D9EF                _SYS1D:		;(BDOS)書き込みが禁止されているディスクの調査
D9EF AF             	XOR	A
D9F0 67             	LD	H,A
D9F1 6F             	LD	L,A
D9F2 C9             	RET
D9F3                
D9F3                _SYS1F:		;(BDOS)ディスク装置のパラメータの読み出し
D9F3 21 00 F1       	LD	HL,DEVICE
D9F6 7B             	LD	A,E
D9F7 C3 DC EF       	JP	_GETDPB
D9FA                
D9FA                _SYS23:		;(BDOS)ファイルサイズの獲得
D9FA E5             	PUSH	HL
D9FB 2A 1E F0       	LD	HL,(STABLE+2*00FH)	;ファイルのオープン
D9FE CD 0F 00       	CALL	JP_HL
DA01 38 1B          	JR	C,_S23X1
DA03                
DA03 D5             	PUSH	DE		;EX DE,IY
DA04 FD E3          	EX	(SP),IY		;
DA06                ;	POP	DE		;
DA06                ;	PUSH	DE		;DEを破壊しないように注意vv
DA06 FD 7E 10       	LD	A,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
DA09 FD 6E 11       	LD	L,(IY+17)	;
DA0C FD 66 12       	LD	H,(IY+18)	;
DA0F C5             	PUSH	BC		;
DA10 FD 46 13       	LD	B,(IY+19)	;
DA13 CD 7E E5       	CALL	GET_CPM_R_SIZE
DA16 C1             	POP	BC
DA17                _S24X1:
DA17 CD 9E E5       	CALL	SET_RR_AHL
DA1A                ;	POP	DE		;^^^^^^^^^^^^^^^^^^^^^^^^
DA1A                ;	PUSH	DE		;EX DE,IY
DA1A FD E3          	EX	(SP),IY		;
DA1C D1             	POP	DE		;
DA1D                
DA1D AF             	XOR	A
DA1E                _S23X1:
DA1E E1             	POP	HL
DA1F C9             	RET
DA20                
DA20                _SYS24:		;(BDOS)ランダムレコードフィールドの設定
DA20 E5             	PUSH	HL
DA21 D5             	PUSH	DE		;EX DE,IY
DA22 FD E3          	EX	(SP),IY		;
DA24                ;	POP	DE		;
DA24                ;	PUSH	DE		;DEを破壊しないように注意vv
DA24 CD B0 E5       	CALL	GETSEQ
DA27 18 EE          	JR	_S24X1		;^^^^^^^^^^^^^^^^^^^^^^^^
DA29                
DA29                _SYS5C:		;(BDOS)ファイル名の解析
DA29 C5             	PUSH	BC
DA2A E5             	PUSH	HL
DA2B CD 0D E0       	CALL	FILE
DA2E E1             	POP	HL
DA2F C1             	POP	BC
DA30                S29X1:
DA30 C5             	PUSH	BC
DA31 D5             	PUSH	DE
DA32 E5             	PUSH	HL
DA33 EB             	EX	DE,HL
DA34 21 14 EF       	LD	HL,FDRV
DA37 01 0D 00       	LD	BC,13
DA3A ED B0          	LDIR
DA3C 70             	LD	(HL),B		;B=0
DA3D 0E 03          	LD	C,3
DA3F ED B0          	LDIR
DA41 E1             	POP	HL
DA42 D1             	POP	DE
DA43 C1             	POP	BC
DA44 AF             	XOR	A
DA45 C9             	RET
DA46                
DA46                _SYS30:		;(BDOS)論理セクタを用いた書き込み
DA46 C5             	PUSH	BC
DA47 01 F7 EB       	LD	BC,DWT24B
DA4A 18 04          	JR	S2FX
DA4C                _SYS2F:
DA4C C5             	PUSH	BC
DA4D 01 E7 EB       	LD	BC,DRD24B
DA50                S2FX:
DA50 ED 43 66 DA    	LD	(S2FPAT+1),BC
DA54 CD DF EF       	CALL	_FFLUSH
DA57                
DA57 D5             	PUSH	DE
DA58 E5             	PUSH	HL
DA59 7D             	LD	A,L		;Drive
DA5A CD D9 EF       	CALL	_CHGDRV
DA5D 38 09          	JR	C,S30X2
DA5F 44             	LD	B,H		;Number of clusters
DA60 2A 8A EF       	LD	HL,(_DTA)
DA63                
DA63 0E 00          	LD	C,0
DA65 CD E7 EB       S2FPAT:	CALL	DRD24B
DA68                S30X2:
DA68 E1             	POP	HL
DA69 D1             	POP	DE
DA6A C1             	POP	BC
DA6B 9F             	SBC	A,A
DA6C C9             	RET
DA6D                
DA6D                _SYS5A:		;(BDOS)カレントディレクトリの変更
DA6D C5             	PUSH	BC
DA6E D5             	PUSH	DE
DA6F E5             	PUSH	HL
DA70 CD 02 E0       	CALL	FILEC
DA73 21 00 00       	LD	HL,0
DA76 11 14 EF       	LD	DE,FDRV
DA79 2A 4E F0       	LD	HL,(STABLE+2*027H)	;ランダムブロック読み込み
DA7C CD 0F 00       	CALL	JP_HL
DA7F 18 E7          	JR	S30X2
DA81                	INCLUDE	"X1IO.ASM"
DA81                
DA81                ;	LSX-Dodgers IO
DA81                ;	X1/turbo/Z
DA81                
DA81 00 00 D7 E7    _SYS04	EQU	_ERROR		;(BDOS)外部出力
DA81 00 00 D7 E7    _SYS05	EQU	_ERROR		;(BDOS)プリンタ出力
DA81 00 00 D7 E7    _SYS1C	EQU	_ERROR		;(BDOS)ディスクの書き込み禁止化
DA81 00 00 D7 E7    _SYS1E	EQU	_ERROR		;(BDOS)ファイル属性の設定
DA81 00 00 D7 E7    _SYS20	EQU	_ERROR		;(BDOS)利用者番号の設定と読み出し
DA81 00 00 D7 E7    _SYS2E	EQU	_ERROR		;(BDOS)ベリファイ・フラグの設定
DA81                
DA81                BIOS:
DA81 CD 89 DA       	CALL	BIOS3
DA84 06 1E          	LD	B,01EH
DA86 ED 79          	OUT	(C),A
DA88 C9             	RET
DA89                BIOS3:
DA89 C5             	PUSH	BC
DA8A 06 1D          	LD	B,01DH
DA8C ED 79          	OUT	(C),A
DA8E C9             	RET
DA8F                
DA8F                INT:
DA8F F5             	PUSH	AF
DA90 E5             	PUSH	HL
DA91 C5             	PUSH	BC
DA92                
DA92 CD 46 DE       	CALL	IN49SB
DA95 67             	LD	H,A
DA96 CD 46 DE       	CALL	IN49SB
DA99 6F             	LD	L,A
DA9A                
DA9A FE 08          	CP	8		;DELキー
DA9C 20 05          	JR	NZ,SCEXE
DA9E 7C             	LD	A,H
DA9F E6 11          	AND	011H		;CTRLキー + GRAPHキー
DAA1 28 0C          	JR	Z,RESET
DAA3                SCEXE:
DAA3 22 92 EF       	LD	(_KEYD),HL
DAA6 CD DB DA       	CALL	KEYSET1
DAA9                
DAA9 C1             	POP	BC
DAAA                INTPE:
DAAA E1             	POP	HL
DAAB                INTPE2:
DAAB F1             	POP	AF
DAAC                INTCTCE:
DAAC FB             	EI
DAAD ED 4D          	RETI
DAAF                
DAAF                RESET:
DAAF 3E 1D          	LD	A,01DH
DAB1 D3 00          	OUT	(0),A
DAB3 C7             	RST	0
DAB4                
DAB4                INTCTC2:
DAB4 F5             	PUSH	AF
DAB5 3E 00          INTCPAT:LD	A,000H
DAB7 3D             	DEC	A
DAB8 32 B6 DA       	LD	(INTCPAT+1),A
DABB 20 EE          	JR	NZ,INTPE2
DABD                
DABD 3A 92 EF       	LD	A,(_KEYD)
DAC0 B7             	OR	A
DAC1 28 E8          	JR	Z,INTPE2
DAC3                KEYSET0:
DAC3 E5             	PUSH	HL
DAC4 2A 90 EF       	LD	HL,(_KEYPS)
DAC7 7C             	LD	A,H
DAC8 AD             	XOR	L
DAC9 20 06          	JR	NZ,INTC2A
DACB                
DACB 2A 92 EF       	LD	HL,(_KEYD)
DACE CD 0F DB       	CALL	KEYSET
DAD1                INTC2A:
DAD1 3A 94 EF       	LD	A,(_KEYSP)
DAD4 E6 0F          	AND	00FH
DAD6 32 B6 DA       	LD	(INTCPAT+1),A
DAD9                
DAD9 18 CF          	JR	INTPE
DADB                
DADB                KEYSET1:
DADB CB 6C          	BIT	5,H
DADD F5             	PUSH	AF
DADE ED 4B 8C EF    	LD	BC,(_CTC)
DAE2 78             	LD	A,B
DAE3 B1             	OR	C
DAE4 20 06          	JR	NZ,KEYS10E
DAE6                
DAE6 F1             	POP	AF
DAE7 20 26          	JR	NZ,KEYSET
DAE9 F5             	PUSH	AF
DAEA 18 D7          	JR	KEYSET0
DAEC                KEYS10E:
DAEC F1             	POP	AF
DAED C8             	RET	Z
DAEE F5             	PUSH	AF
DAEF 3E 03          	LD	A,3		;CTC STOP
DAF1 ED 79          	OUT	(C),A
DAF3 F1             	POP	AF
DAF4                
DAF4 B7             	OR	A
DAF5 C8             	RET	Z
DAF6                
DAF6 3E A7          	LD	A,0A7H
DAF8 ED 79          	OUT	(C),A
DAFA 3A 94 EF       	LD	A,(_KEYSP)
DAFD ED 79          	OUT	(C),A
DAFF 79             	LD	A,C
DB00 E6 FC          	AND	0FCH
DB02 4F             	LD	C,A
DB03 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
DB05 3E C0          	LD	A,CTC0
DB07 ED 79          	OUT	(C),A
DB09 3A 95 EF       	LD	A,(_KEYSP+1)
DB0C 32 B6 DA       	LD	(INTCPAT+1),A
DB0F                
DB0F                KEYSET:
DB0F 7D             	LD	A,L
DB10 CB 74          	BIT	6,H
DB12 C0             	RET	NZ
DB13                KEYBS:
DB13 B7             	OR	A
DB14 C8             	RET	Z
DB15                KEYBS1:
DB15 CD 2B DB       	CALL	KEYBC_IFBREAK
DB18 E5             	PUSH	HL
DB19 F5             	PUSH	AF
DB1A 2A 90 EF       	LD	HL,(_KEYPS)
DB1D 2C             	INC	L
DB1E 7D             	LD	A,L
DB1F BC             	CP	H
DB20 28 15          	JR	Z,POP_AF_HL_SCF_RET
DB22 32 90 EF       	LD	(_KEYPS),A
DB25 26 FE          	LD	H,KEYBF/256
DB27 F1             	POP	AF
DB28 77             	LD	(HL),A
DB29 E1             	POP	HL
DB2A C9             	RET
DB2B                KEYBC_IFBREAK:
DB2B FE 03          	CP	3
DB2D C0             	RET	NZ
DB2E                KEYBC:
DB2E E5             	PUSH	HL
DB2F 21 00 00       	LD	HL,0
DB32 22 90 EF       	LD	(_KEYPS),HL
DB35 E1             	POP	HL
DB36 C9             	RET
DB37                
DB37                POP_AF_HL_SCF_RET:
DB37 F1             	POP	AF
DB38 E1             	POP	HL
DB39 37             	SCF
DB3A C9             	RET
DB3B                
DB3B                _SYS01:		;(BDOS)コンソール入力
DB3B CD 09 EF       	CALL	_SYS07
DB3E                MSG_A:
DB3E F5             	PUSH	AF
DB3F D5             	PUSH	DE
DB40 5F             	LD	E,A
DB41 CD 47 DB       	CALL	_SYS02
DB44 D1             	POP	DE
DB45 F1             	POP	AF
DB46 C9             	RET
DB47                
DB47                _SYS02:		;(BDOS)コンソール出力
DB47 CD 59 DB       	CALL	BREAK
DB4A 18 05          	JR	PRINTX
DB4C                
DB4C                _SYS06:		;(BDOS)コンソール直接入出力
DB4C 7B             	LD	A,E
DB4D 3C             	INC	A
DB4E CA CA EF       	JP	Z,_INKEY
DB51                PRINTX:
DB51 C3 CD EF       	JP	_PRINT
DB54                
DB54                _SYS08:		;(BDOS)エコーなしコンソール入力
DB54 CD 09 EF       	CALL	_SYS07
DB57 18 04          	JR	BREAK1
DB59                BREAK:
DB59 FB             	EI
DB5A 3A 92 EF       	LD	A,(_KEYD)
DB5D                BREAK1:
DB5D FE 03          	CP	3		;CTRL+C
DB5F CA 00 EF       	JP	Z,CPM_BOOT
DB62 FE 13          	CP	013H		;CTRL+S
DB64 C0             	RET	NZ
DB65                
DB65                PAUSE:
DB65 CD 2E DB       	CALL	KEYBC
DB68                
DB68                FLGET:
DB68 CD DF EF       	CALL	_FFLUSH
DB6B C5             	PUSH	BC
DB6C E5             	PUSH	HL
DB6D ED 4B 8E EF    	LD	BC,(_TXADR)
DB71 CB E8          	SET	5,B
DB73 ED 60          	IN	H,(C)
DB75                FLGET1:
DB75 3A 93 EF       	LD	A,(_KEYD+1)
DB78 0F             	RRCA
DB79 0F             	RRCA
DB7A E6 10          	AND	010H
DB7C F6 08          	OR	8
DB7E ED 68          	IN	L,(C)
DB80 B5             	OR	L
DB81 ED 79          	OUT	(C),A
DB83 CD CA EF       	CALL	_INKEY
DB86 28 ED          	JR	Z,FLGET1
DB88 ED 61          	OUT	(C),H
DB8A E1             	POP	HL
DB8B C1             	POP	BC
DB8C C9             	RET
DB8D                
DB8D                _SYS0A:		;(BDOS)文字列入力
DB8D C5             	PUSH	BC
DB8E E5             	PUSH	HL
DB8F D5             	PUSH	DE
DB90 CD 93 DF       	CALL	GETL
DB93 11 00 FF       	LD	DE,KBUF
DB96 E1             	POP	HL
DB97 E5             	PUSH	HL
DB98 0E 00          	LD	C,0
DB9A 30 04          	JR	NC,SAX0
DB9C 23             	INC	HL
DB9D 23             	INC	HL
DB9E 18 08          	JR	SAX4
DBA0                SAX0:
DBA0 46             	LD	B,(HL)
DBA1 23             	INC	HL
DBA2                SAX1:
DBA2 23             	INC	HL
DBA3 1A             	LD	A,(DE)
DBA4 13             	INC	DE
DBA5 B7             	OR	A
DBA6 20 04          	JR	NZ,SAX2
DBA8                SAX4:
DBA8 36 0D          	LD	(HL),00DH
DBAA 18 04          	JR	SAX3
DBAC                SAX2:
DBAC 77             	LD	(HL),A
DBAD 0C             	INC	C
DBAE 10 F2          	DJNZ	SAX1
DBB0                SAX3:
DBB0 D1             	POP	DE
DBB1 79             	LD	A,C
DBB2 13             	INC	DE
DBB3 12             	LD	(DE),A
DBB4 1B             	DEC	DE
DBB5 E1             	POP	HL
DBB6 C1             	POP	BC
DBB7 A7             	AND	A
DBB8 C9             	RET
DBB9                
DBB9                _SYS0B:		;(BDOS)コンソール状態のチェック
DBB9 CD 59 DB       	CALL	BREAK
DBBC 3A 92 EF       	LD	A,(_KEYD)
DBBF B7             	OR	A
DBC0 C8             	RET	Z
DBC1                CONSTX:
DBC1 CD DF EF       	CALL	_FFLUSH
DBC4 E5             	PUSH	HL
DBC5 2A 90 EF       	LD	HL,(_KEYPS)
DBC8 7C             	LD	A,H
DBC9 AD             	XOR	L
DBCA E1             	POP	HL
DBCB C6 FF          	ADD	A,0FFH
DBCD 9F             	SBC	A,A
DBCE C9             	RET
DBCF                
DBCF                _SYS2A:		;(BDOS)日付の獲得
DBCF C5             	PUSH	BC
DBD0 3E ED          	LD	A,0EDH		;Read calendar
DBD2 CD 61 DE       	CALL	COMOUT
DBD5 CD 07 DC       	CALL	IN49SB_BCD	;YY
DBD8 6F             	LD	L,A
DBD9 26 00          	LD	H,0
DBDB                ;	LD	DE,1900		;0076CH
DBDB                ;	CP	90		;90以上は1900年代 1990-1999
DBDB                ;	JR	NC,RDDATE1	;90未満は2000年代 2000-2089
DBDB                ;	LD	E,0D0H		;2000 & 0FFH D=007H
DBDB 11 D0 07       	LD	DE,2000		;すべて2000年代で処理 2000-2099
DBDE                RDDATE1:
DBDE 19             	ADD	HL,DE
DBDF CD 46 DE       	CALL	IN49SB		;MW
DBE2 57             	LD	D,A
DBE3 CD 07 DC       	CALL	IN49SB_BCD	;DD
DBE6 5F             	LD	E,A
DBE7 7A             	LD	A,D
DBE8 06 04          	LD	B,4
DBEA                RDDATE2:
DBEA CB 3A          	SRL	D
DBEC 10 FC          	DJNZ	RDDATE2
DBEE C1             	POP	BC
DBEF E6 07          	AND	7
DBF1 C9             	RET
DBF2                
DBF2                _SYS2C:		;(BDOS)時刻の獲得
DBF2 C5             	PUSH	BC
DBF3 3E EF          	LD	A,0EFH		;Read time
DBF5 CD 61 DE       	CALL	COMOUT
DBF8 CD 07 DC       	CALL	IN49SB_BCD	;TT
DBFB 67             	LD	H,A
DBFC CD 07 DC       	CALL	IN49SB_BCD	;MM
DBFF 6F             	LD	L,A
DC00 CD 07 DC       	CALL	IN49SB_BCD	;SS
DC03 57             	LD	D,A
DC04 C1             	POP	BC
DC05 AF             	XOR	A
DC06 C9             	RET
DC07                
DC07                IN49SB_BCD:
DC07 CD 46 DE       	CALL	IN49SB
DC0A                ;------------------------
DC0A                ;BCDの10進数化
DC0A                ;in
DC0A                ;	A  : BCD
DC0A                ;out
DC0A                ;	A  : 10進数
DC0A                ;------------------------
DC0A 4F             	LD	C,A
DC0B E6 F0          	AND	0F0H	;10の位
DC0D 0F             	RRCA
DC0E 47             	LD	B,A
DC0F 0F             	RRCA
DC10 0F             	RRCA
DC11 80             	ADD	A,B
DC12 47             	LD	B,A
DC13 79             	LD	A,C
DC14 E6 0F          	AND	00FH	;1の位
DC16 80             	ADD	A,B
DC17 C9             	RET
DC18                
DC18                ESC1:
DC18 7B             	LD	A,E
DC19 FE 41          	CP	'A'
DC1B CA 62 DD       	JP	Z,CTRL1E
DC1E FE 42          	CP	'B'
DC20 CA CC DE       	JP	Z,CTRL1F
DC23 FE 43          	CP	'C'
DC25 CA 6D DD       	JP	Z,CTRL1C
DC28 FE 44          	CP	'D'
DC2A CA 59 DD       	JP	Z,CTRL1D
DC2D FE 45          	CP	'E'
DC2F 28 02          	JR	Z,CT0CX
DC31 FE 6A          	CP	'j'
DC33                CT0CX:
DC33 CA 9F DE       	JP	Z,CTRL0C
DC36 FE 48          	CP	'H'
DC38 CA E7 DD       	JP	Z,CTRL0B
DC3B FE 4A          	CP	'J'
DC3D CA A2 DE       	JP	Z,CTRL06
DC40 FE 4B          	CP	'K'
DC42 CA A6 DD       	JP	Z,CTRL05
DC45 FE 4C          	CP	'L'
DC47 CA E1 DE       	JP	Z,CTRL0E
DC4A FE 54          	CP	'T'
DC4C CA A6 DD       	JP	Z,CTRL05
DC4F FE 78          	CP	'x'
DC51 28 04          	JR	Z,ESC1X
DC53 FE 79          	CP	'y'
DC55 20 02          	JR	NZ,ESC1Y
DC57                ESC1X:
DC57 36 01          	LD	(HL),1
DC59                ESC1Y:
DC59 FE 3D          	CP	'='
DC5B 28 04          	JR	Z,ESC1W
DC5D FE 59          	CP	'Y'
DC5F 20 02          	JR	NZ,ESC1Z
DC61                ESC1W:
DC61 36 02          	LD	(HL),2
DC63                ESC1Z:
DC63 FE 20          	CP	020H
DC65 38 02          	JR	C,ESC1C
DC67 87             	ADD	A,A
DC68 D0             	RET	NC
DC69                ESC1C:
DC69 E1             	POP	HL
DC6A 18 4F          	JR	ANK
DC6C                
DC6C                ESC:
DC6C 21 CC DC       	LD	HL,PRINTE5
DC6F E5             	PUSH	HL
DC70 21 92 DC       	LD	HL,ESCFLG+1
DC73 36 00          	LD	(HL),0
DC75 3D             	DEC	A
DC76 28 A0          	JR	Z,ESC1
DC78 3D             	DEC	A
DC79 20 09          	JR	NZ,ESC2
DC7B 36 03          	LD	(HL),3
DC7D 7B             	LD	A,E
DC7E D6 20          	SUB	020H
DC80 32 87 DC       	LD	(ESCYP+1),A
DC83 C9             	RET
DC84                ESC2:
DC84 3D             	DEC	A
DC85 C0             	RET	NZ
DC86 26 00          ESCYP:	LD	H,0
DC88 7B             	LD	A,E
DC89 D6 20          	SUB	020H
DC8B 6F             	LD	L,A
DC8C C3 D6 EF       	JP	_LOC
DC8F                
DC8F                PRINT:
DC8F C5             	PUSH	BC
DC90 E5             	PUSH	HL
DC91 3E 00          ESCFLG:	LD	A,000H
DC93 B7             	OR	A
DC94 20 D6          	JR	NZ,ESC
DC96                
DC96 3E 1F          	LD	A,01FH
DC98 BB             	CP	E
DC99 30 35          	JR	NC,CTRL
DC9B 01 6A DE       INSFLG:	LD	BC,INSERT
DC9E                
DC9E 3A 18 00       	LD	A,(00018H)
DCA1 3C             	INC	A
DCA2 28 17          	JR	Z,ANK
DCA4 3E 00          KANFLG:	LD	A,000H
DCA6 B7             	OR	A
DCA7 20 3A          	JR	NZ,KANJI2
DCA9 7B             	LD	A,E
DCAA FE 80          	CP	080H
DCAC 38 0D          	JR	C,ANK
DCAE FE A0          	CP	0A0H
DCB0 38 04          	JR	C,KANJI1
DCB2 FE E0          	CP	0E0H
DCB4 38 05          	JR	C,ANK
DCB6                KANJI1:
DCB6 32 A5 DC       	LD	(KANFLG+1),A
DCB9 18 11          	JR	PRINTE5
DCBB                ANK:
DCBB ED 4B 8E EF    	LD	BC,(_TXADR)
DCBF 78             	LD	A,B
DCC0 F6 38          	OR	038H
DCC2 47             	LD	B,A
DCC3 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DCC5 CB 98          	RES	3,B
DCC7 ED 59          	OUT	(C),E		;Text
DCC9                KANJIE:
DCC9 CD 2E DD       	CALL	PRINTE7
DCCC                PRINTE5:
DCCC E1             	POP	HL
DCCD C1             	POP	BC
DCCE AF             	XOR	A
DCCF C9             	RET
DCD0                
DCD0                CTRL:
DCD0 CD 15 DD       	CALL	KANCLR
DCD3 7B             	LD	A,E
DCD4 87             	ADD	A,A
DCD5 F6 80          	OR	080H
DCD7 6F             	LD	L,A
DCD8 26 F0          	LD	H,CTRLTB/256
DCDA 7E             	LD	A,(HL)
DCDB 2C             	INC	L
DCDC 66             	LD	H,(HL)
DCDD 6F             	LD	L,A
DCDE CD 0F 00       	CALL	JP_HL
DCE1 18 E9          	JR	PRINTE5
DCE3                
DCE3                KANJI2:
DCE3 D5             	PUSH	DE
DCE4 57             	LD	D,A
DCE5 01 81 2F       	LD	BC,02F81H	;SFTJIS
DCE8 DF             	RST	018H
DCE9 01 C3 2F       	LD	BC,02FC3H	;Instead or JISVRM
DCEC DF             	RST	018H
DCED                
DCED ED 4B 8E EF    	LD	BC,(_TXADR)
DCF1 78             	LD	A,B
DCF2 F6 38          	OR	038H
DCF4 47             	LD	B,A
DCF5 ED 51          	OUT	(C),D		;kanji
DCF7 CB 98          	RES	3,B
DCF9 ED 59          	OUT	(C),E		;Text
DCFB CD 2E DD       	CALL	PRINTE7
DCFE ED 4B 8E EF    	LD	BC,(_TXADR)
DD02 78             	LD	A,B
DD03 F6 38          	OR	038H
DD05 47             	LD	B,A
DD06 CB F2          	SET	6,D
DD08 ED 51          	OUT	(C),D		;Kanji
DD0A CB 98          	RES	3,B
DD0C ED 59          	OUT	(C),E		;Text
DD0E D1             	POP	DE
DD0F AF             	XOR	A
DD10 32 A5 DC       	LD	(KANFLG+1),A
DD13 18 B4          	JR	KANJIE
DD15                
DD15                KANCLR:
DD15 3A A5 DC       	LD	A,(KANFLG+1)
DD18 B7             	OR	A
DD19 C8             	RET	Z
DD1A ED 4B 8E EF    	LD	BC,(_TXADR)
DD1E 78             	LD	A,B
DD1F F6 38          	OR	038H
DD21 47             	LD	B,A
DD22 AF             	XOR	A
DD23 32 A5 DC       	LD	(KANFLG+1),A
DD26 ED 79          	OUT	(C),A		;Kanji
DD28 CB 98          	RES	3,B
DD2A 3E 20          	LD	A,020H
DD2C ED 79          	OUT	(C),A		;Text
DD2E                PRINTE7:
DD2E CB A0          	RES	4,B
DD30                PRINTE6:
DD30 3A 96 EF       	LD	A,(_COLORF)
DD33                PRINTE4:
DD33 ED 79          	OUT	(C),A		;Color
DD35 78             	LD	A,B
DD36 E6 07          	AND	7
DD38 47             	LD	B,A
DD39                PRINTE2:
DD39 03             	INC	BC
DD3A                PRINTE3:
DD3A 2A BA EF       	LD	HL,(_PAGE_MINUS)
DD3D A7             	AND	A
DD3E ED 4A          	ADC	HL,BC
DD40                PRINTE8:
DD40 28 05          	JR	Z,PRINT2
DD42 ED 43 8E EF    	LD	(_TXADR),BC
DD46                CTRL00:
DD46 C9             	RET
DD47                
DD47                PRINT2:
DD47 CD E7 DE       	CALL	SCR
DD4A 2A BC EF       	LD	HL,(_WIDTH_MINUS)
DD4D 09             	ADD	HL,BC
DD4E                SET_TXADR_HL:
DD4E 22 8E EF       	LD	(_TXADR),HL
DD51 C9             	RET
DD52                
DD52                CTRL08:
DD52 3A 9B DC       	LD	A,(INSFLG)
DD55 FE CD          	CP	0CDH		;CALL ????
DD57 28 29          	JR	Z,CTRL02
DD59                CTRL1D:
DD59 2A 8E EF       	LD	HL,(_TXADR)
DD5C 7C             	LD	A,H
DD5D B5             	OR	L
DD5E C8             	RET	Z
DD5F 2B             	DEC	HL
DD60 18 EC          	JR	SET_TXADR_HL
DD62                
DD62                CTRL1E:
DD62 ED 4B 8E EF    	LD	BC,(_TXADR)
DD66 2A BC EF       	LD	HL,(_WIDTH_MINUS)
DD69 09             	ADD	HL,BC
DD6A D0             	RET	NC
DD6B 18 E1          	JR	SET_TXADR_HL
DD6D                
DD6D                CTRL1C:
DD6D ED 4B 8E EF    	LD	BC,(_TXADR)
DD71 18 C6          	JR	PRINTE2
DD73                
DD73                CTRL09:
DD73 ED 4B 8E EF    	LD	BC,(_TXADR)
DD77 79             	LD	A,C
DD78 E6 F8          	AND	0F8H
DD7A C6 08          	ADD	A,8
DD7C 4F             	LD	C,A
DD7D 88             	ADC	A,B
DD7E 91             	SUB	C
DD7F 47             	LD	B,A
DD80 18 B8          	JR	PRINTE3
DD82                
DD82                CTRL02:
DD82 CD 59 DD       	CALL	CTRL1D
DD85 C8             	RET	Z
DD86 D5             	PUSH	DE
DD87 CD D3 EF       	CALL	_POS
DD8A 3A B1 EF       	LD	A,(_WIDTH)
DD8D 95             	SUB	L
DD8E 4F             	LD	C,A
DD8F 0D             	DEC	C
DD90 06 38          	LD	B,038H
DD92 2A 8E EF       	LD	HL,(_TXADR)
DD95 09             	ADD	HL,BC
DD96 44             	LD	B,H
DD97 4D             	LD	C,L
DD98 11 00 20       	LD	DE,02000H	;D:Text E:kanji
DD9B 2A 96 EF       	LD	HL,(_COLORF)	;L:Color
DD9E                C8X1:
DD9E CD 86 DE       	CALL	C12S
DDA1 0B             	DEC	BC
DDA2 20 FA          	JR	NZ,C8X1
DDA4 D1             	POP	DE
DDA5 C9             	RET
DDA6                
DDA6                CTRL05:
DDA6 CD D3 EF       	CALL	_POS
DDA9 3A B1 EF       	LD	A,(_WIDTH)
DDAC 95             	SUB	L
DDAD 6F             	LD	L,A
DDAE                C08X1:
DDAE ED 4B 8E EF    	LD	BC,(_TXADR)
DDB2                LINECL:
DDB2 26 20          	LD	H,020H
DDB4 3A 96 EF       	LD	A,(_COLORF)
DDB7 CB E8          	SET	5,B
DDB9                LINECL1:
DDB9 CB D8          	SET	3,B
DDBB CB E0          	SET	4,B
DDBD ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DDBF CB 98          	RES	3,B
DDC1 ED 61          	OUT	(C),H		;Text
DDC3 CB A0          	RES	4,B
DDC5 ED 79          	OUT	(C),A		;Color
DDC7 03             	INC	BC
DDC8 2D             	DEC	L
DDC9 20 EE          	JR	NZ,LINECL1
DDCB C9             	RET
DDCC                
DDCC                CTRL0D:
DDCC CD D3 EF       	CALL	_POS
DDCF 2E 00          	LD	L,0
DDD1                LOC:
DDD1 C5             	PUSH	BC
DDD2 E5             	PUSH	HL
DDD3 CD 15 DD       	CALL	KANCLR
DDD6 CD F4 DD       	CALL	LOC1
DDD9 22 8E EF       	LD	(_TXADR),HL
DDDC E1             	POP	HL
DDDD C1             	POP	BC
DDDE C9             	RET
DDDF                
DDDF                CTRL12:
DDDF 21 9B DC       	LD	HL,INSFLG
DDE2 7E             	LD	A,(HL)
DDE3 EE CC          	XOR	0CCH		;CD:CALL ???? 1:LD BC,????
DDE5 77             	LD	(HL),A
DDE6 C9             	RET
DDE7                
DDE7                CTRL0B:
DDE7 21 00 00       	LD	HL,0
DDEA 22 8E EF       	LD	(_TXADR),HL
DDED C9             	RET
DDEE                
DDEE                CTRL1B:
DDEE 3E 01          	LD	A,1
DDF0 32 92 DC       	LD	(ESCFLG+1),A
DDF3 C9             	RET
DDF4                
DDF4                LOC1:
DDF4 D5             	PUSH	DE
DDF5 4D             	LD	C,L
DDF6 06 08          	LD	B,8
DDF8 5C             	LD	E,H
DDF9 16 00          	LD	D,0
DDFB 2A B0 EF       	LD	HL,(CRTCD)
DDFE 6A             	LD	L,D
DDFF                LOC2:
DDFF 29             	ADD	HL,HL
DE00 30 01          	JR	NC,LOC3
DE02 19             	ADD	HL,DE
DE03                LOC3:
DE03 10 FA          	DJNZ	LOC2
DE05 09             	ADD	HL,BC
DE06 D1             	POP	DE
DE07 C9             	RET
DE08                
DE08                CONOUT1:
DE08 CD 1A DE       	CALL	CURSOR
DE0B 59             	LD	E,C
DE0C CD CD EF       	CALL	_PRINT
DE0F 7B             	LD	A,E
DE10 FE 0A          	CP	00AH
DE12 20 06          	JR	NZ,CURSOR
DE14 CD CC DD       	CALL	CTRL0D
DE17 CD A6 DD       	CALL	CTRL05
DE1A                CURSOR:
DE1A C5             	PUSH	BC
DE1B ED 4B 8E EF    	LD	BC,(_TXADR)
DE1F CB E8          	SET	5,B
DE21 ED 78          	IN	A,(C)
DE23 EE 18          	XOR	018H
DE25 ED 79          	OUT	(C),A
DE27 C1             	POP	BC
DE28 C9             	RET
DE29                
DE29                CTRL07:
DE29 21 61 EF       	LD	HL,BEEPD
DE2C                BEEP1:
DE2C 7E             	LD	A,(HL)
DE2D 23             	INC	HL
DE2E FE FF          	CP	0FFH
DE30 C8             	RET	Z
DE31 F3             	DI
DE32 06 1C          	LD	B,01CH
DE34 ED 79          	OUT	(C),A
DE36 ED A3          	OUTI
DE38 FB             	EI
DE39 18 F1          	JR	BEEP1
DE3B                
DE3B                OT49SB:
DE3B C5             	PUSH	BC
DE3C CD 57 DE       	CALL	CANW
DE3F 01 00 19       	LD	BC,01900H
DE42 ED 79          	OUT	(C),A
DE44 C1             	POP	BC
DE45 C9             	RET
DE46                
DE46                IN49SB:
DE46 C5             	PUSH	BC
DE47 01 01 1A       	LD	BC,01A01H
DE4A                CANR:
DE4A ED 78          	IN	A,(C)
DE4C E6 20          	AND	020H
DE4E 20 FA          	JR	NZ,CANR
DE50 01 00 19       	LD	BC,01900H
DE53 ED 78          	IN	A,(C)
DE55 C1             	POP	BC
DE56 C9             	RET
DE57                
DE57                CANW:
DE57 01 01 1A       	LD	BC,01A01H
DE5A ED 48          	IN	C,(C)
DE5C CB 71          	BIT	6,C
DE5E 20 F7          	JR	NZ,CANW
DE60 C9             	RET
DE61                
DE61                COMOUT:
DE61 FB             	EI
DE62 CD 3B DE       	CALL	OT49SB
DE65 CD 57 DE       	CALL	CANW
DE68 F3             	DI
DE69 C9             	RET
DE6A                
DE6A                INSERT:
DE6A D5             	PUSH	DE
DE6B CD D3 EF       	CALL	_POS
DE6E 3A B1 EF       	LD	A,(_WIDTH)
DE71 95             	SUB	L
DE72 ED 4B 8E EF    	LD	BC,(_TXADR)
DE76 11 00 20       	LD	DE,02000H	;D:Text E:Kanji
DE79 2A 96 EF       	LD	HL,(_COLORF)	;L:Color
DE7C CB E8          	SET	5,B
DE7E                C12X1:
DE7E CD 86 DE       	CALL	C12S
DE81 03             	INC	BC
DE82 20 FA          	JR	NZ,C12X1
DE84 D1             	POP	DE
DE85 C9             	RET
DE86                
DE86                C12S:
DE86 CB E0          	SET	4,B
DE88 CB D8          	SET	3,B
DE8A ED 60          	IN	H,(C)
DE8C ED 59          X1PAT:	OUT	(C),E
DE8E 5C             	LD	E,H
DE8F CB 98          	RES	3,B
DE91 ED 60          	IN	H,(C)
DE93 ED 51          	OUT	(C),D
DE95 54             	LD	D,H
DE96 CB A0          	RES	4,B
DE98 ED 60          	IN	H,(C)
DE9A ED 69          	OUT	(C),L
DE9C 6C             	LD	L,H
DE9D 3D             	DEC	A
DE9E C9             	RET
DE9F                
DE9F                CTRL0C:
DE9F CD E7 DD       	CALL	CTRL0B
DEA2                CTRL06:
DEA2 ED 4B 8E EF    	LD	BC,(_TXADR)
DEA6                C1AX1:
DEA6 78             	LD	A,B
DEA7 F6 38          	OR	038H
DEA9 47             	LD	B,A
DEAA ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DEAC CB 98          	RES	3,B
DEAE 3E 20          	LD	A,020H
DEB0 ED 79          	OUT	(C),A		;Text
DEB2 CB A0          	RES	4,B
DEB4 3A 96 EF       	LD	A,(_COLORF)
DEB7 ED 79          	OUT	(C),A		;Color
DEB9 03             	INC	BC
DEBA CB A8          	RES	5,B
DEBC 2A BA EF       	LD	HL,(_PAGE_MINUS)
DEBF 09             	ADD	HL,BC
DEC0 30 E4          	JR	NC,C1AX1
DEC2 C9             	RET
DEC3                
DEC3                CTRL04:
DEC3 CD D3 EF       	CALL	_POS
DEC6 7D             	LD	A,L
DEC7 B7             	OR	A
DEC8 C8             	RET	Z
DEC9                CTRL03:
DEC9 CD CC DD       	CALL	CTRL0D
DECC                CTRL0A:
DECC                CTRL1F:
DECC ED 4B 8E EF    	LD	BC,(_TXADR)
DED0 2A B1 EF       	LD	HL,(_WIDTH)
DED3 26 00          	LD	H,0
DED5 09             	ADD	HL,BC
DED6 44             	LD	B,H
DED7 4D             	LD	C,L
DED8 2A BA EF       	LD	HL,(_PAGE_MINUS)
DEDB 09             	ADD	HL,BC
DEDC 3F             	CCF
DEDD 9F             	SBC	A,A
DEDE C3 40 DD       	JP	PRINTE8
DEE1                
DEE1                CTRL0E:
DEE1 CD D3 EF       	CALL	_POS
DEE4 7C             	LD	A,H
DEE5 18 04          	JR	SCR1
DEE7                SCR:
DEE7 3A 97 EF       	LD	A,(_LINE)
DEEA 3D             	DEC	A
DEEB                SCR1:
DEEB C5             	PUSH	BC
DEEC D5             	PUSH	DE
DEED F5             	PUSH	AF
DEEE 3E 07          	LD	A,7
DEF0 21 21 DF       	LD	HL,SCRDMAD
DEF3 CD 17 DF       	CALL	SETDMA
DEF6 F1             	POP	AF
DEF7 21 00 38       	LD	HL,03800H
DEFA                
DEFA                SCRUP1:
DEFA B7             	OR	A
DEFB 28 4D          	JR	Z,SCRCL
DEFD F5             	PUSH	AF
DEFE CD 28 DF       	CALL	UPSUB		;kanji
DF01 3A BC EF       	LD	A,(_WIDTH_MINUS)
DF04 5F             	LD	E,A
DF05 16 F7          	LD	D,0F7H
DF07 19             	ADD	HL,DE
DF08 D5             	PUSH	DE
DF09 CD 28 DF       	CALL	UPSUB		;Text
DF0C D1             	POP	DE
DF0D 19             	ADD	HL,DE
DF0E CD 28 DF       	CALL	UPSUB		;Color
DF11 CB E4          	SET	4,H
DF13 F1             	POP	AF
DF14 3D             	DEC	A
DF15 18 E3          	JR	SCRUP1
DF17                
DF17                SETDMA:
DF17 01 87 1F       	LD	BC,01F87H
DF1A                SDMA:
DF1A 04             	INC	B
DF1B ED A3          	OUTI
DF1D 3D             	DEC	A
DF1E 20 FA          	JR	NZ,SDMA
DF20 C9             	RET
DF21                
DF21                SCRDMAD:
DF21 C3             	DB	0C3H		;WR6 リセット
DF22 9A             	DB	09AH		;WR5 ストップ WAIT READY:HIGH
DF23 65             	DB	065H		;WR0 ブロック長(LH)
DF24 4F 00          	DW	79
DF26 1C             	DB	01CH		;WR1 ポートAインクリメント I/O
DF27 18             	DB	018H		;WR0 ポートAアドレス(LH)
DF28                
DF28                UPSUB:
DF28 3A B1 EF       	LD	A,(_WIDTH)
DF2B 5F             	LD	E,A
DF2C 16 00          	LD	D,0
DF2E 3E CD          	LD	A,0CDH		;WR4 バースト ポートB開始アドレス(LH)
DF30 ED 79          	OUT	(C),A
DF32 ED 69          	OUT	(C),L		;SOURCE
DF34 ED 61          	OUT	(C),H
DF36 19             	ADD	HL,DE
DF37 3E 1D          	LD	A,01DH		;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
DF39 ED 79          	OUT	(C),A
DF3B ED 69          	OUT	(C),L		;DEST
DF3D ED 61          	OUT	(C),H
DF3F                GO_DMA:
DF3F 3E CF          	LD	A,0CFH
DF41 ED 79          	OUT	(C),A		;WR6 ロード
DF43 3E B3          	LD	A,0B3H
DF45 ED 79          	OUT	(C),A		;WR6 強制RDY
DF47 ED 49          	OUT	(C),C		;WR6 イネーブル
DF49 C9             	RET
DF4A                
DF4A                SCRCL:
DF4A 44             	LD	B,H
DF4B 4D             	LD	C,L
DF4C 2A B1 EF       	LD	HL,(_WIDTH)
DF4F CD B2 DD       	CALL	LINECL
DF52 D1             	POP	DE
DF53 C1             	POP	BC
DF54 C9             	RET
DF55                
DF55                SCRN:
DF55 D5             	PUSH	DE
DF56 ED 58          	IN	E,(C)		;Text
DF58 3A 18 00       	LD	A,(00018H)
DF5B 3C             	INC	A
DF5C 28 1E          	JR	Z,SCRN2
DF5E CB D8          	SET	3,B
DF60 ED 50          	IN	D,(C)		;Kanji
DF62 28 16          	JR	Z,SCRN1
DF64 AF             	XOR	A
DF65 C5             	PUSH	BC
DF66 01 37 30       	LD	BC,03037H	;VRMJIS
DF69 DF             	RST	018H
DF6A 01 52 2F       	LD	BC,02F52H	;JISSFT
DF6D DF             	RST	018H
DF6E C1             	POP	BC
DF6F ED 78          	IN	A,(C)
DF71 CB 98          	RES	3,B
DF73 E6 40          	AND	040H
DF75 20 05          	JR	NZ,SCRN2
DF77 7A             	LD	A,D
DF78 D1             	POP	DE
DF79 C9             	RET
DF7A                SCRN1:
DF7A CB 98          	RES	3,B
DF7C                SCRN2:
DF7C 7B             	LD	A,E
DF7D D1             	POP	DE
DF7E C9             	RET
DF7F                SCRNE:
DF7F                POS:
DF7F 2A 8E EF       	LD	HL,(_TXADR)
DF82 C5             	PUSH	BC
DF83 ED 4B BC EF    	LD	BC,(_WIDTH_MINUS)
DF87 AF             	XOR	A
DF88                POS1:
DF88 09             	ADD	HL,BC
DF89 3C             	INC	A
DF8A 38 FC          	JR	C,POS1
DF8C ED 42          	SBC	HL,BC
DF8E 3D             	DEC	A
DF8F 67             	LD	H,A
DF90 C1             	POP	BC
DF91 A7             	AND	A
DF92 C9             	RET
DF93                
DF93                GETL:
DF93 CD D3 EF       	CALL	_POS
DF96 E5             	PUSH	HL
DF97 3E CD          	LD	A,0CDH		;CALL ????
DF99 32 9B DC       	LD	(INSFLG),A
DF9C                GETL1:
DF9C CD 54 DB       	CALL	_SYS08
DF9F FE 09          	CP	9
DFA1 20 08          	JR	NZ,GETL1V
DFA3 21 00 FF       	LD	HL,KBUF
DFA6 CD F8 D7       	CALL	MSX
DFA9 18 F1          	JR	GETL1
DFAB                GETL1V:
DFAB 5F             	LD	E,A
DFAC CD CD EF       	CALL	_PRINT
DFAF                
DFAF 7B             	LD	A,E
DFB0 FE 0D          	CP	00DH
DFB2 20 E8          	JR	NZ,GETL1
DFB4 3E 01          	LD	A,1		;LD BC,????
DFB6 32 9B DC       	LD	(INSFLG),A
DFB9 11 00 FF       	LD	DE,KBUF
DFBC 3A B1 EF       	LD	A,(_WIDTH)
DFBF 47             	LD	B,A
DFC0 CD E8 D4       	CALL	ZERO_MEMORY_DE
DFC3                
DFC3 D1             	POP	DE
DFC4 CD D3 EF       	CALL	_POS
DFC7 6B             	LD	L,E
DFC8 3A B1 EF       	LD	A,(_WIDTH)
DFCB 95             	SUB	L
DFCC 57             	LD	D,A
DFCD CD F4 DD       	CALL	LOC1
DFD0 4D             	LD	C,L
DFD1 7C             	LD	A,H
DFD2 F6 30          	OR	030H
DFD4 47             	LD	B,A
DFD5 5A             	LD	E,D
DFD6 21 00 FF       	LD	HL,KBUF
DFD9                GETL2:
DFD9 CD D0 EF       	CALL	_SCRN
DFDC 03             	INC	BC
DFDD 77             	LD	(HL),A
DFDE 23             	INC	HL
DFDF 1D             	DEC	E
DFE0 20 F7          	JR	NZ,GETL2
DFE2                GETL3:
DFE2 2B             	DEC	HL
DFE3 7E             	LD	A,(HL)
DFE4 FE 21          	CP	021H
DFE6 D0             	RET	NC
DFE7 36 00          	LD	(HL),0
DFE9 15             	DEC	D
DFEA 20 F6          	JR	NZ,GETL3
DFEC C9             	RET
DFED                
DFED                INKEY:
DFED FB             	EI
DFEE E5             	PUSH	HL
DFEF 2A 90 EF       	LD	HL,(_KEYPS)
DFF2 7C             	LD	A,H
DFF3 AD             	XOR	L
DFF4 28 09          	JR	Z,INKEY1
DFF6 7C             	LD	A,H
DFF7 3C             	INC	A
DFF8 32 91 EF       	LD	(_KEYPS+1),A
DFFB 6F             	LD	L,A
DFFC 26 FE          	LD	H,KEYBF/256
DFFE 7E             	LD	A,(HL)
DFFF                INKEY1:
DFFF E1             	POP	HL
E000 B7             	OR	A
E001 C9             	RET
E002                
E002 00 00 0F B2    AT_RS	EQU	SCR1-AT_SCR1
E002                	INCLUDE	"LDFILE.ASM"
E002                
E002                ;	LSX-Dodgers FILE
E002                
E002                FILEC:
E002 CD 0D E0       	CALL	FILE
E005                FILEC2:
E005 3A 15 EF       	LD	A,(FDRV+1)
E008 FE 20          	CP	020H
E00A C8             	RET	Z
E00B 18 39          	JR	SETDIR1
E00D                
E00D                FILE:
E00D AF             	XOR	A
E00E 32 14 EF       	LD	(FDRV),A
E011 67             	LD	H,A
E012 6F             	LD	L,A
E013 22 22 EF       	LD	(FDRV+14),HL
E016 CD E4 E0       	CALL	SPCUT
E019 CD C9 E0       	CALL	CCHK3
E01C 28 12          	JR	Z,DEVI1
E01E 13             	INC	DE
E01F 1A             	LD	A,(DE)
E020 1B             	DEC	DE
E021 FE 3A          	CP	':'
E023 20 0B          	JR	NZ,DEVI1
E025 1A             	LD	A,(DE)		;DRIVE
E026 CD 19 E3       	CALL	CAP
E029 D6 40          	SUB	'@'
E02B 13             	INC	DE
E02C 13             	INC	DE
E02D 32 14 EF       	LD	(FDRV),A
E030                DEVI1:
E030 1A             	LD	A,(DE)
E031 D6 5C          	SUB	05CH		;\
E033 20 09          	JR	NZ,NOROOT
E035 6F             	LD	L,A		;A=0でH=0のはずなのでHL=0
E036 22 2E EF       	LD	(FDRV+26),HL
E039 2C             	INC	L
E03A 22 22 EF       	LD	(FDRV+14),HL
E03D 13             	INC	DE
E03E                NOROOT:
E03E                
E03E                SETDIR:
E03E CD 6A E0       	CALL	FILED
E041 1A             	LD	A,(DE)
E042 FE 5C          	CP	05CH		;\
E044 C0             	RET	NZ
E045 13             	INC	DE
E046                SETDIR1:
E046 3E 10          	LD	A,010H		;Directory
E048 32 21 EF       	LD	(FDRV+13),A
E04B D5             	PUSH	DE
E04C 11 14 EF       	LD	DE,FDRV
E04F 2A 1E F0       	LD	HL,(STABLE+2*00FH)
E052 CD 0F 00       	CALL	JP_HL
E055 D1             	POP	DE
E056 B7             	OR	A
E057 C0             	RET	NZ
E058                
E058 3A 21 EF       	LD	A,(FDRV+13)
E05B CB 67          	BIT	4,A
E05D C8             	RET	Z
E05E                
E05E CD B1 E0       	CALL	FILEI
E061 2A 2E EF       	LD	HL,(FDRV+26)
E064 23             	INC	HL
E065 22 22 EF       	LD	(FDRV+14),HL
E068 18 D4          	JR	SETDIR
E06A                
E06A                FILED:
E06A CD B1 E0       	CALL	FILEI
E06D 21 15 EF       	LD	HL,FNAME
E070                
E070 06 08          	LD	B,8
E072                FILE2:
E072 CD BE E0       	CALL	CCHKF
E075 C8             	RET	Z
E076 FE 2A          	CP	'*'
E078 28 2E          	JR	Z,FILE9
E07A FE 2E          	CP	'.'
E07C 28 0C          	JR	Z,FILE4
E07E 77             	LD	(HL),A
E07F 23             	INC	HL
E080 10 F0          	DJNZ	FILE2
E082                
E082                FILE3:
E082 CD BE E0       	CALL	CCHKF
E085 C8             	RET	Z
E086 FE 2E          	CP	'.'
E088 20 F8          	JR	NZ,FILE3
E08A                
E08A                FILE4:
E08A 21 1D EF       	LD	HL,FNAME+8
E08D 06 03          	LD	B,3
E08F                
E08F                FILE4L:
E08F CD BE E0       	CALL	CCHKF
E092 C8             	RET	Z
E093 FE 2E          	CP	'.'
E095 20 08          	JR	NZ,FILE12
E097 32 15 EF       	LD	(FNAME),A	;Parent directory(..)
E09A 32 16 EF       	LD	(FNAME+1),A
E09D 3E 20          	LD	A,020H
E09F                FILE12:
E09F FE 2A          	CP	'*'
E0A1 28 0A          	JR	Z,FILE10
E0A3 77             	LD	(HL),A
E0A4 23             	INC	HL
E0A5 10 E8          	DJNZ	FILE4L
E0A7 C9             	RET
E0A8                
E0A8                FILE9:				;名前の*処理、名前の残りを?で埋める
E0A8 CD AD E0       	CALL	FILE10
E0AB 18 D5          	JR	FILE3
E0AD                
E0AD                FILE10:
E0AD 3E 3F          	LD	A,'?'
E0AF 18 08          	JR	FILL_MEMORY
E0B1                FILEI:				;名前＋拡張子をスペースで初期化
E0B1 3E 20          	LD	A,020H
E0B3 01 00 0B       	LD	BC,11*256	;C=0にしておく
E0B6 21 15 EF       	LD	HL,FNAME
E0B9                FILL_MEMORY:			;HLからBバイトAで埋める
E0B9 77             	LD	(HL),A
E0BA 23             	INC	HL
E0BB 10 FC          	DJNZ	FILL_MEMORY
E0BD C9             	RET
E0BE                
E0BE                CCHKF:
E0BE 1A             	LD	A,(DE)
E0BF CD C6 E0       	CALL	CCHK2
E0C2 C8             	RET	Z
E0C3 C3 31 E4       	JP	FKAN
E0C6                
E0C6                CCHK2:
E0C6 0C             	INC	C
E0C7 0D             	DEC	C
E0C8 C0             	RET	NZ
E0C9                CCHK3:				;ZF=1 で使えない文字
E0C9 FE 2B          	CP	'+'
E0CB C8             	RET	Z
E0CC FE 2C          	CP	','
E0CE C8             	RET	Z
E0CF FE 2F          	CP	'/'
E0D1 C8             	RET	Z
E0D2 FE 3A          	CP	':'
E0D4 C8             	RET	Z
E0D5 FE 3B          	CP	';'
E0D7 C8             	RET	Z
E0D8 FE 3D          	CP	'='
E0DA C8             	RET	Z
E0DB FE 5C          	CP	05CH	;\
E0DD C8             	RET	Z
E0DE FE 20          	CP	020H
E0E0 D0             	RET	NC
E0E1 BF             	CP	A		;Z=1
E0E2 C9             	RET
E0E3                
E0E3                SS1:
E0E3 13             	INC	DE
E0E4                SPCUT:				;スペースをカット
E0E4 1A             	LD	A,(DE)
E0E5 FE 20          	CP	020H
E0E7 28 FA          	JR	Z,SS1
E0E9 C9             	RET
E0EA                
E0EA                SETDRVF:
E0EA 11 14 EF       	LD	DE,FDRV
E0ED                SETDRV0:
E0ED CD F6 E0       	CALL	SETDRV
E0F0 FD E1          	POP	IY
E0F2 C1             	POP	BC
E0F3 D1             	POP	DE
E0F4 E1             	POP	HL
E0F5 C9             	RET
E0F6                
E0F6                SETDRV:
E0F6 E3             	EX	(SP),HL		;HL=RETRN ADDRESS
E0F7 D5             	PUSH	DE		;PUSH HL/DE/BC/IY
E0F8 C5             	PUSH	BC
E0F9 1A             	LD	A,(DE)
E0FA D5             	PUSH	DE
E0FB FD E3          	EX	(SP),IY
E0FD                
E0FD CD 09 E1       	CALL	GETDRV
E100 3C             	INC	A
E101 FD 77 00       	LD	(IY+0),A	;(FCB)ドライブ番号
E104 3D             	DEC	A
E105 CD D9 EF       	CALL	_CHGDRV
E108                
E108 E9             	JP	(HL)
E109                
E109                GETDRV:
E109 E6 7F          	AND	07FH
E10B D6 01          	SUB	001H
E10D 30 03          	JR	NC,GETDRV1
E10F 3A 87 EF       	LD	A,(_DVSW)	;Current Drive
E112                GETDRV1:
E112 32 88 EF       	LD	(_DRV),A
E115 C9             	RET
E116                
E116                SOPENX:
E116 11 39 EF       	LD	DE,SFILE
E119 1A             	LD	A,(DE)
E11A FD BE 00       	CP	(IY+0)		;(FCB)ドライブ番号
E11D 20 24          	JR	NZ,SOPEN
E11F 13             	INC	DE
E120 FD E5          	PUSH	IY
E122 E1             	POP	HL
E123 23             	INC	HL
E124 CD B1 E2       	CALL	CPFILE
E127 20 1A          	JR	NZ,SOPEN
E129                
E129 2A F4 F0       	LD	HL,(SCDIR)
E12C FD 75 0E       	LD	(IY+14),L	;(FCB)アクセスするディレクトリのクラスタ番号+1
E12F FD 74 0F       	LD	(IY+15),H
E132                
E132 2A F8 F0       	LD	HL,(SFNDF)	;Direcroty location and Flags
E135 22 9F EF       	LD	(_FILEN),HL
E138                
E138 ED 5B F6 F0    	LD	DE,(SFBPS)
E13C 21 39 EF       	LD	HL,SFILE
E13F 36 FF          	LD	(HL),0FFH
E141 23             	INC	HL
E142 C9             	RET
E143                SOPEN:
E143 21 59 E2       	LD	HL,FILESE
E146                SOPENC:
E146 22 7F E1       	LD	(OPENPAT+1),HL
E149                
E149 CD E2 EF       	CALL	_RDFATX		;Detect Media
E14C 38 56          	JR	C,RDDERR
E14E                
E14E AF             	XOR	A
E14F 32 9F EF       	LD	(_FILEN),A
E152 CD 5E E3       	CALL	LDDIRX1		;A=0で呼び出す
E155 28 18          	JR	Z,SDIRX1
E157                
E157 CD 4A E2       	CALL	READ_DIR	;Sub Directory
E15A 38 08          	JR	C,SDIRX0
E15C 2A 7E F0       	LD	HL,(_DTBUF)
E15F 7E             	LD	A,(HL)
E160 FE 2E          	CP	'.'
E162 28 0F          	JR	Z,SOPEN1
E164                SDIRX0:
E164 AF             	XOR	A
E165 32 A0 EF       	LD	(_DIRF),A
E168 FD 36 0E 01    	LD	(IY+14),1	;(FCB)レコードサイズ
E16C FD 77 0F       	LD	(IY+15),A
E16F                SDIRX1:
E16F ED 5B FC F0    	LD	DE,(_DIRPS)	;Root Directory
E173                SOPEN1:
E173 0E 20          SDECPAT:LD	C,32		;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
E175                SOPEN1X:
E175 CD 4A E2       	CALL	READ_DIR	;FILE SEARCH
E178 38 2A          	JR	C,RDDERR
E17A 2A 7E F0       	LD	HL,(_DTBUF)
E17D                SOPEN2:
E17D D5             	PUSH	DE
E17E CD 59 E2       OPENPAT:CALL	FILESE		;(self-modifying code)
E181 D1             	POP	DE
E182 38 6E          	JR	C,SOPENE
E184 28 1B          	JR	Z,SCF_FF_RET
E186                SOPEN3:
E186 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E189 B7             	OR	A
E18A 20 0C          	JR	NZ,SOPEN5
E18C 13             	INC	DE		;ルートディレクトリ
E18D E5             	PUSH	HL
E18E 21 0C 00       MD_PAT:	LD	HL,12		;(self-modifying code)MAXDIR
E191 ED 52          	SBC	HL,DE		;CF=0 なので SUB HL,DE
E193 E1             	POP	HL
E194 20 DD          	JR	NZ,SOPEN1
E196 18 07          	JR	SOPEN6
E198                SOPEN5:
E198 CD 8D EA       	CALL	GNCLX		;END DIR
E19B D8             	RET	C
E19C CD 11 E3       	CALL	ENDCL
E19F                SOPEN6:
E19F 38 D2          	JR	C,SOPEN1
E1A1                SCF_FF_RET:
E1A1 37             	SCF			;CF=1
E1A2 9F             	SBC	A,A		;A=0FFH
E1A3 C9             	RET
E1A4                
E1A4                RDDERR:
E1A4 BF             	CP	A		;READ ERR CF=1 ZF=1
E1A5 37             	SCF
E1A6 C9             	RET
E1A7                
E1A7                NOPEN:
E1A7 21 59 E2       	LD	HL,FILESE
E1AA 22 7F E1       	LD	(OPENPAT+1),HL
E1AD FD 2A 98 EF    	LD	IY,(_FCB)
E1B1 CD 44 E4       	CALL	CHKWILDX
E1B4 30 EB          	JR	NC,SCF_FF_RET
E1B6 FD 7E 00       	LD	A,(IY+0)	;(FCB)ドライブ番号
E1B9 3D             	DEC	A
E1BA 32 88 EF       	LD	(_DRV),A
E1BD CD D9 EF       	CALL	_CHGDRV
E1C0 D8             	RET	C
E1C1 2A F8 F0       	LD	HL,(SFNDF)	;Direcroty location and Flags
E1C4 22 9F EF       	LD	(_FILEN),HL
E1C7                
E1C7 CD 59 E3       	CALL	LDDIRX
E1CA ED 5B 9A EF    	LD	DE,(_FBPS)
E1CE CD 4A E2       	CALL	READ_DIR
E1D1 38 D1          	JR	C,RDDERR
E1D3 3A 9E EF       	LD	A,(_FBCNT)
E1D6 3D             	DEC	A
E1D7 28 AD          	JR	Z,SOPEN3
E1D9                NOPEN2:
E1D9 2A 9C EF       	LD	HL,(_FBAD)
E1DC 01 20 00       	LD	BC,020H
E1DF 09             	ADD	HL,BC
E1E0 4F             	LD	C,A
E1E1 18 9A          	JR	SOPEN2
E1E3                
E1E3                SOPENE2:
E1E3 22 9C EF       	LD	(_FBAD),HL
E1E6 79             	LD	A,C
E1E7 32 9E EF       	LD	(_FBCNT),A
E1EA ED 53 9A EF    	LD	(_FBPS),DE
E1EE FD 22 98 EF    	LD	(_FCB),IY
E1F2                SOPENE:
E1F2 AF             	XOR	A
E1F3 C9             	RET
E1F4                
E1F4                COPEN:
E1F4 FD 36 0D 20    	LD	(IY+13),020H	;(FCB)属性(アトリビュート)
E1F8                
E1F8 21 76 E2       	LD	HL,NEXTSE
E1FB CD 46 E1       	CALL	SOPENC
E1FE D0             	RET	NC
E1FF C8             	RET	Z
E200 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E203 B7             	OR	A
E204 37             	SCF
E205 C8             	RET	Z		;ルートディレクトリ
E206 06 01          	LD	B,1
E208 CD A2 E4       	CALL	WRDF
E20B D8             	RET	C
E20C ED 5B FE F0    	LD	DE,(_CLPS)
E210 D5             	PUSH	DE
E211 CD DA E2       	CALL	DCPAT
E214 CD 18 E9       	CALL	DRDNX
E217 2A 7E F0       	LD	HL,(_DTBUF)	;ディレクトリエントリを0クリア
E21A 3A 16 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E21D 47             	LD	B,A
E21E AF             	XOR	A
E21F 4F             	LD	C,A
E220                COPENCL:
E220 77             	LD	(HL),A
E221 ED A1          	CPI			;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
E223 EA 20 E2       	JP	PE,COPENCL
E226                
E226 3A F8 E2       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ数
E229 3D             	DEC	A
E22A 28 19          	JR	Z,COPENE
E22C 3E 01          	LD	A,1		;1セクタ辺りのセクタ数が2以上の場合
E22E 32 85 EA       	LD	(_SECPS+1),A
E231 D1             	POP	DE		;DE=(_CLPS)
E232 D5             	PUSH	DE
E233                COPEN1:
E233 D5             	PUSH	DE		;データバッファに入らないセクタもゼロクリア
E234 C5             	PUSH	BC
E235 2A 7E F0       	LD	HL,(_DTBUF)
E238 CD F4 E2       	CALL	CLUSTX
E23B CD F5 EB       	CALL	DWT24
E23E C1             	POP	BC
E23F D1             	POP	DE
E240 CD 84 EA       	CALL	NEXTX
E243 20 EE          	JR	NZ,COPEN1
E245                COPENE:
E245 2A 7E F0       	LD	HL,(_DTBUF)
E248 D1             	POP	DE
E249 C9             	RET
E24A                
E24A                READ_DIR:
E24A ED 53 FE F0    	LD	(_CLPS),DE
E24E C5             	PUSH	BC
E24F D5             	PUSH	DE
E250 CD DA E2       	CALL	DCPAT
E253 CD F8 E8       	CALL	DRDX
E256 D1             	POP	DE
E257 C1             	POP	BC
E258 C9             	RET
E259                
E259                FILESE:
E259 7E             	LD	A,(HL)
E25A B7             	OR	A
E25B C8             	RET	Z		;END:ZF=1 CF=0
E25C FE E5          	CP	0E5H
E25E 28 0E          	JR	Z,FILESE1
E260 FD E5          	PUSH	IY
E262 D1             	POP	DE
E263 13             	INC	DE
E264 E5             	PUSH	HL
E265 CD B1 E2       	CALL	CPFILE
E268 CC D2 E2       	CALL	Z,CPFILE2
E26B E1             	POP	HL
E26C 37             	SCF
E26D C8             	RET	Z		;!!!:(ZF=1) CF=1
E26E                FILESE1:
E26E CD 85 E2       	CALL	FNEXT
E271 20 E6          	JR	NZ,FILESE
E273                ZF0_CF0_AFF_RET:
E273 F6 FF          	OR	0FFH		;ZF=0 CF=0
E275 C9             	RET
E276                
E276                NEXTSE:
E276 7E             	LD	A,(HL)
E277 B7             	OR	A
E278 37             	SCF
E279 C8             	RET	Z		;!!!:ZF=1 CF=1
E27A FE E5          	CP	0E5H
E27C 37             	SCF
E27D C8             	RET	Z		;!!!:(ZF=1) CF=1
E27E CD 85 E2       	CALL	FNEXT
E281 20 F3          	JR	NZ,NEXTSE
E283 18 EE          	JR	ZF0_CF0_AFF_RET
E285                
E285                FNEXT:
E285 E5             	PUSH	HL
E286 21 9F EF       	LD	HL,_FILEN
E289 34             	INC	(HL)
E28A E1             	POP	HL
E28B 11 20 00       	LD	DE,020H
E28E 19             	ADD	HL,DE
E28F 0D             	DEC	C
E290 C9             	RET
E291                
E291                CPNAME:
E291 C5             	PUSH	BC
E292 D5             	PUSH	DE
E293 E5             	PUSH	HL
E294 CD AB E2       	CALL	CPFILE4
E297 E1             	POP	HL
E298 23             	INC	HL
E299 23             	INC	HL
E29A 23             	INC	HL
E29B 23             	INC	HL
E29C D1             	POP	DE
E29D C1             	POP	BC
E29E 20 05          	JR	NZ,CPNAME1
E2A0 7E             	LD	A,(HL)
E2A1 23             	INC	HL
E2A2 66             	LD	H,(HL)
E2A3 6F             	LD	L,A
E2A4 C9             	RET
E2A5                CPNAME1:
E2A5 23             	INC	HL
E2A6 23             	INC	HL
E2A7 10 E8          	DJNZ	CPNAME
E2A9 37             	SCF
E2AA C9             	RET
E2AB                
E2AB                CPFILE4:
E2AB C5             	PUSH	BC
E2AC 01 00 04       	LD	BC,00400H
E2AF 18 04          	JR	CPSTR1
E2B1                CPFILE:
E2B1 C5             	PUSH	BC
E2B2 01 00 0B       	LD	BC,00B00H
E2B5                CPSTR1:
E2B5 1A             	LD	A,(DE)
E2B6 FE 3F          	CP	'?'		;Wild card
E2B8 28 12          	JR	Z,CPSTR2
E2BA 7E             	LD	A,(HL)
E2BB CD 2A E4       	CALL	FKANC
E2BE E5             	PUSH	HL
E2BF 67             	LD	H,A
E2C0 1A             	LD	A,(DE)
E2C1 CB 01          	RLC	C
E2C3 CD 2A E4       	CALL	FKANC
E2C6 CB 09          	RRC	C
E2C8 BC             	CP	H		;CP (HL),(DE)
E2C9 E1             	POP	HL
E2CA 20 04          	JR	NZ,CPSTR3
E2CC                CPSTR2:
E2CC 13             	INC	DE
E2CD 23             	INC	HL
E2CE 10 E5          	DJNZ	CPSTR1
E2D0                CPSTR3:
E2D0 C1             	POP	BC
E2D1 C9             	RET
E2D2                
E2D2                CPFILE2:
E2D2 FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E2D5 F6 E1          	OR	0E1H
E2D7 2F             	CPL
E2D8 A6             	AND	(HL)
E2D9 C9             	RET
E2DA                
E2DA                DCPAT:
E2DA 0E 00          	LD	C,0
E2DC 2A 7E F0       	LD	HL,(_DTBUF)
E2DF 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E2E2 B7             	OR	A
E2E3 C8             	RET	Z		;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
E2E4 3A F8 E2       	LD	A,(SPCPAT+1)
E2E7 4F             	LD	C,A
E2E8 3A 85 EA       	LD	A,(_SECPS+1)
E2EB B9             	CP	C
E2EC 38 01          	JR	C,DC1
E2EE AF             	XOR	A
E2EF                DC1:
E2EF F6 80          	OR	080H
E2F1 32 A0 EF       	LD	(_DIRF),A	;bit0-6:セクタインデックス
E2F4                CLUSTX:
E2F4 E5             	PUSH	HL
E2F5 EB             	EX	DE,HL
E2F6 AF             	XOR	A
E2F7 0E 01          SPCPAT:	LD	C,1		;自己書き換え（1クラスタの論理セクタ数）
E2F9                L_CLDBL:
E2F9 CB 19          	RR	C		;->CF
E2FB 38 04          	JR	C,E_CLDBL
E2FD 29             	ADD	HL,HL		;*2
E2FE 8F             	ADC	A,A
E2FF 18 F8          	JR	L_CLDBL
E301                E_CLDBL:
E301 4F             	LD	C,A
E302 3A 85 EA       	LD	A,(_SECPS+1)
E305 B5             	OR	L
E306 6F             	LD	L,A
E307 11 08 00       CLSPAT:	LD	DE,8	;+8 (2D)  !ADDCL (self-modifying code)
E30A AF             	XOR	A
E30B 19             	ADD	HL,DE	;データ格納領域の先頭論理セクタ番号
E30C 89             	ADC	A,C
E30D 4F             	LD	C,A
E30E EB             	EX	DE,HL
E30F E1             	POP	HL
E310 C9             	RET
E311                
E311                ENDCL:
E311 7A             	LD	A,D	;END CLUSTER
E312 FE 01          CLPAT1:	CP	1	;164=356	(self-modifying code)
E314 C0             	RET	NZ
E315 7B             	LD	A,E
E316 FE 64          CLPAT2:	CP	064H	;		(self-modifying code)
E318 C9             	RET
E319                
E319                CAP:
E319 FE 61          	CP	'a'
E31B D8             	RET	C
E31C FE 7B          	CP	'z'+1
E31E D0             	RET	NC
E31F D6 20          	SUB	020H
E321 C9             	RET
E322                CAP2:
E322 CD 19 E3       	CALL	CAP
E325                CAP3:
E325 CD 2E E3       	CALL	CAP4
E328 FE 21          	CP	021H
E32A D0             	RET	NC
E32B 3E A0          	LD	A,0A0H
E32D C9             	RET
E32E                CAP4:
E32E FE 05          	CP	5
E330 C0             	RET	NZ
E331 3E E5          	LD	A,0E5H
E333 C9             	RET
E334                
E334                CHDIR:
E334 CD 23 ED       	CALL	GETDPBD
E337 38 1D          	JR	C,CHDIR2
E339 DD 75 1A       	LD	(IX+01AH),L		;_SDIR_
E33C DD 74 1B       	LD	(IX+01BH),H		;_SDIR_+1
E33F 18 15          	JR	CHDIR2		;POP_IX_RET
E341                
E341                LDDIR:
E341 CD 23 ED       	CALL	GETDPBD
E344 DD 5E 1A       	LD	E,(IX+01AH)		;_SDIR_
E347 DD 56 1B       	LD	D,(IX+01BH)		;_SDIR_+1
E34A 13             	INC	DE
E34B FD 73 0E       	LD	(IY+14),E	;(FCB)アクセスするディレクトリのクラスタ番号+1
E34E FD 72 0F       	LD	(IY+15),D
E351 1B             	DEC	DE
E352 AF             	XOR	A
E353 32 A0 EF       	LD	(_DIRF),A
E356                CHDIR2:
E356 DD E1          	POP	IX
E358 C9             	RET
E359                
E359                LDDIRX:
E359 3A A0 EF       	LD	A,(_DIRF)	;(FCB)アクセスするディレクトリのセクタインデックス
E35C E6 7F          	AND	07FH
E35E                LDDIRX1:
E35E 32 85 EA       	LD	(_SECPS+1),A
E361 FD 5E 0E       	LD	E,(IY+14)	;(FCB)アクセスするディレクトリのクラスタ番号+1
E364 FD 56 0F       	LD	D,(IY+15)
E367 1B             	DEC	DE
E368 CD 11 E3       	CALL	ENDCL
E36B D4 41 E3       	CALL	NC,LDDIR
E36E                LDDIRS:
E36E 7A             	LD	A,D
E36F B3             	OR	E
E370 32 A0 EF       	LD	(_DIRF),A	;ディレクトリか判別
E373 C9             	RET
E374                
E374                KILL:
E374 CD 44 E4       	CALL	CHKWILDX
E377 38 34          	JR	C,KILLW
E379 CD 16 E1       	CALL	SOPENX
E37C                KILLS:
E37C 3E 1F          	LD	A,01FH
E37E D4 C0 E3       	CALL	NC,CHKATT
E381 D8             	RET	C
E382                KILLSX:
E382 36 E5          	LD	(HL),0E5H	;DIR
E384 CD 1E E4       	CALL	WTDB
E387 11 1A 00       	LD	DE,01AH
E38A 19             	ADD	HL,DE
E38B 5E             	LD	E,(HL)
E38C 23             	INC	HL
E38D 56             	LD	D,(HL)
E38E                KILLS1:
E38E CD 11 E3       	CALL	ENDCL
E391 D0             	RET	NC		;CF=0
E392 21 FE FF       	LD	HL,0-2
E395 19             	ADD	HL,DE
E396 D0             	RET	NC		;DE= 0 or 1
E397 D5             	PUSH	DE
E398 CD F7 EF       	CALL	_GNCL
E39B ED 53 FE F0    	LD	(_CLPS),DE
E39F D1             	POP	DE
E3A0 21 00 00       	LD	HL,0
E3A3 D4 FA EF       	CALL	NC,_SNCL
E3A6 D8             	RET	C
E3A7 ED 5B FE F0    	LD	DE,(_CLPS)	;FAT
E3AB 18 E1          	JR	KILLS1
E3AD                
E3AD                KILLW:
E3AD CD 43 E1       	CALL	SOPEN
E3B0                KILLW1:
E3B0 38 0B          	JR	C,KILLW2
E3B2 CD E3 E1       	CALL	SOPENE2
E3B5 CD 7C E3       	CALL	KILLS
E3B8 CD A7 E1       	CALL	NOPEN
E3BB 18 F3          	JR	KILLW1
E3BD                KILLW2:
E3BD C8             	RET	Z
E3BE 3F             	CCF
E3BF C9             	RET
E3C0                
E3C0                CHKATT:
E3C0 E5             	PUSH	HL
E3C1 11 0B 00       	LD	DE,00BH
E3C4 19             	ADD	HL,DE
E3C5 A6             	AND	(HL)
E3C6 E1             	POP	HL
E3C7 C8             	RET	Z
E3C8 37             	SCF
E3C9 C9             	RET
E3CA                
E3CA                NAME:
E3CA CD 44 E4       	CALL	CHKWILDX
E3CD D8             	RET	C
E3CE 11 04 00       	LD	DE,4
E3D1 19             	ADD	HL,DE
E3D2 22 EA E3       	LD	(NAMEP+2),HL
E3D5 23             	INC	HL
E3D6 CD 48 E4       	CALL	CHKWILD
E3D9 D8             	RET	C
E3DA                
E3DA CD 16 E1       	CALL	SOPENX
E3DD 3E 0F          	LD	A,00FH
E3DF D4 C0 E3       	CALL	NC,CHKATT
E3E2 D8             	RET	C
E3E3                
E3E3 FD 7E 00       	LD	A,(IY+0)
E3E6 FD E5          	PUSH	IY
E3E8 FD 21 00 00    NAMEP:	LD	IY,0		;自己書き換え
E3EC FD 77 00       	LD	(IY+0),A
E3EF CD 16 E1       	CALL	SOPENX
E3F2 FD E3          	EX	(SP),IY
E3F4 3F             	CCF
E3F5 D4 43 E1       	CALL	NC,SOPEN
E3F8 EB             	EX	DE,HL
E3F9 E1             	POP	HL
E3FA D8             	RET	C
E3FB                
E3FB                SETNAME:
E3FB 01 00 0B       	LD	BC,11*256
E3FE 23             	INC	HL
E3FF 7E             	LD	A,(HL)
E400 FE E5          	CP	0E5H
E402 20 04          	JR	NZ,SNAME1
E404 3E 05          	LD	A,5
E406 18 0E          	JR	SNAME3
E408                SNAME1:
E408 7E             	LD	A,(HL)
E409 0C             	INC	C
E40A 0D             	DEC	C
E40B 20 09          	JR	NZ,SNAME3
E40D CD 19 E3       	CALL	CAP
E410 FE A0          	CP	0A0H
E412 20 02          	JR	NZ,SNAME3
E414 3E 20          	LD	A,020H
E416                SNAME3:
E416 12             	LD	(DE),A
E417 7E             	LD	A,(HL)
E418 23             	INC	HL
E419 CD 31 E4       	CALL	FKAN
E41C 10 EA          	DJNZ	SNAME1
E41E                WTDB:
E41E 3E FF          	LD	A,0FFH
E420 32 39 EF       	LD	(SFILE),A
E423                SWTDBF:
E423 3E 01          	LD	A,1
E425 32 A4 EF       	LD	(_WTDBF),A
E428 AF             	XOR	A
E429 C9             	RET
E42A                
E42A                FKANC:
E42A CB 41          	BIT	0,C
E42C CC 22 E3       	CALL	Z,CAP2
E42F 18 01          	JR	FKANX
E431                FKAN:			;漢字チェック
E431 13             	INC	DE
E432                FKANX:
E432 CB 41          	BIT	0,C
E434 CB 81          	RES	0,C
E436 C0             	RET	NZ
E437 FE 80          	CP	080H
E439 D8             	RET	C
E43A FE A0          	CP	0A0H
E43C 38 03          	JR	C,FKAN1
E43E FE E0          	CP	0E0H
E440 D8             	RET	C
E441                FKAN1:
E441 0C             	INC	C
E442 A7             	AND	A
E443 C9             	RET
E444                
E444                CHKWILDX:
E444 FD E5          	PUSH	IY
E446 E1             	POP	HL
E447 23             	INC	HL
E448                CHKWILD:
E448 06 0B          	LD	B,11
E44A 3E 3F          	LD	A,'?'
E44C                CHKWIL1:
E44C BE             	CP	(HL)
E44D 23             	INC	HL
E44E 37             	SCF
E44F C8             	RET	Z
E450 10 FA          	DJNZ	CHKWIL1
E452 AF             	XOR	A
E453 C9             	RET
E454                
E454                SDIRENT:		;IY=FCB HL=DIR
E454 D5             	PUSH	DE
E455 E5             	PUSH	HL
E456 FD E5          	PUSH	IY
E458 D1             	POP	DE
E459 EB             	EX	DE,HL
E45A CD FB E3       	CALL	SETNAME
E45D                ;				Attribute
E45D FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E460 12             	LD	(DE),A
E461 13             	INC	DE
E462                ;				Reserved
E462 AF             	XOR	A
E463 06 0A          	LD	B,10
E465                SDE1:
E465 12             	LD	(DE),A
E466 13             	INC	DE
E467 10 FC          	DJNZ	SDE1
E469                					;(FCB)更新時刻
E469 21 EA F0       	LD	HL,SDDATA		;(FCB)更新年月日
E46C 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
E46E                SDLOOP:					;(FCB)ファイルのサイズ(バイト単位)
E46E 7E             	LD	A,(HL)
E46F 23             	INC	HL
E470 32 75 E4       	LD	(SDPAT+2),A
E473 FD 7E 00       SDPAT:	LD	A,(IY+0)	;LD A,(IY+A)
E476 12             	LD	(DE),A
E477 13             	INC	DE
E478 10 F4          	DJNZ	SDLOOP
E47A                
E47A AF             	XOR	A
E47B E1             	POP	HL
E47C D1             	POP	DE
E47D C9             	RET
E47E                
E47E                WOPEN:
E47E FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E481 E6 1F          	AND	01FH
E483 37             	SCF
E484 C0             	RET	NZ
E485 FD 36 1C FE    	LD	(IY+28),0FEH	;(FCB)オープンモード
E489                TOPEN2:
E489 AF             	XOR	A
E48A                TOPEN:				;Initializes the time stamp
E48A FD 36 17 FF    	LD	(IY+23),0FFH	;(FCB)更新時刻
E48E C9             	RET
E48F                
E48F                WRDFX:
E48F 3A F8 E2       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ
E492                L_WRFX:
E492 1F             	RRA			;->CF
E493 38 06          	JR	C,E_WRFX
E495 CB 39          	SRL	C
E497 CB 1C          	RR	H		;CH=CH/2
E499 18 F7          	JR	L_WRFX
E49B                E_WRFX:
E49B 44             	LD	B,H
E49C 04             	INC	B
E49D 3E 37          	LD	A,037H		;SCF
E49F 32 15 E9       	LD	(DRDN1),A
E4A2                
E4A2                WRDF:				;Bクラスタ分FATを確保する
E4A2 11 02 00       	LD	DE,2
E4A5 AF             	XOR	A
E4A6 32 85 EA       	LD	(_SECPS+1),A
E4A9                WRDF1:
E4A9 C5             	PUSH	BC
E4AA D5             	PUSH	DE
E4AB CD F7 EF       	CALL	_GNCL
E4AE 38 1C          	JR	C,WRDF3
E4B0 7A             	LD	A,D		;空いているかチェック
E4B1 B3             	OR	E
E4B2 20 27          	JR	NZ,WRDF4
E4B4 E1             	POP	HL		;HL=空いているクラスタ
E4B5 E5             	PUSH	HL
E4B6 ED 5B FE F0    	LD	DE,(_CLPS)	;DE=元の(_CLPS)
E4BA 22 FE F0       	LD	(_CLPS),HL
E4BD 7A             	LD	A,D		;元の(_CLPS)が 0 か?
E4BE B3             	OR	E
E4BF 20 08          	JR	NZ,WRDF2
E4C1 FD 75 1A       	LD	(IY+26),L	;(FCB)ファイルの先頭クラスタ
E4C4 FD 74 1B       	LD	(IY+27),H	;元が空の場合はFCBにクラスタをセットする
E4C7 18 03          	JR	WRDF3
E4C9                WRDF2:
E4C9 CD FA EF       	CALL	_SNCL
E4CC                WRDF3:
E4CC D1             	POP	DE
E4CD C1             	POP	BC
E4CE D8             	RET	C
E4CF 10 0C          	DJNZ	WRDF5		;ここでループカウンタチェック
E4D1 ED 5B FE F0    	LD	DE,(_CLPS)
E4D5 21 FF FF       	LD	HL,0FFFFH	;FATエントリ終了(EOCマーク)
E4D8 C3 FA EF       	JP	_SNCL
E4DB                
E4DB                WRDF4:				;DEクラスタが空じゃないので次に移動する
E4DB D1             	POP	DE
E4DC C1             	POP	BC
E4DD                WRDF5:
E4DD 13             	INC	DE
E4DE CD 11 E3       	CALL	ENDCL
E4E1 38 C6          	JR	C,WRDF1
E4E3 37             	SCF
E4E4 C9             	RET
E4E5                
E4E5                RWXR:
E4E5 3A 16 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E4E8                L_RWX:
E4E8 1F             	RRA		;->CF
E4E9 38 08          	JR	C,E_RWX
E4EB CB 38          	SRL	B	;BCH=BCH/2
E4ED CB 19          	RR	C	;
E4EF CB 1C          	RR	H	;
E4F1 18 F5          	JR	L_RWX
E4F3                E_RWX:
E4F3 FD 5E 1A       	LD	E,(IY+26)	;(FCB)ファイルの先頭クラスタ
E4F6 FD 56 1B       	LD	D,(IY+27)
E4F9 AF             	XOR	A
E4FA 32 85 EA       	LD	(_SECPS+1),A
E4FD                RWX1:
E4FD ED 53 FE F0    	LD	(_CLPS),DE
E501 7A             	LD	A,D
E502 B3             	OR	E
E503 28 13          	JR	Z,SCF_RET	;RET DE==0 => CF=1
E505                
E505 78             	LD	A,B
E506 B1             	OR	C
E507 B4             	OR	H
E508 C8             	RET	Z		;RET BCH==0 => CF=0
E509                
E509 CD 8D EA       	CALL	GNCLX
E50C D8             	RET	C
E50D 7C             	LD	A,H		;
E50E 25             	DEC	H		;
E50F B7             	OR	A		;DEC BCH
E510 20 01          	JR	NZ,RWX2		;
E512 0B             	DEC	BC		;
E513                RWX2:
E513 CD 11 E3       	CALL	ENDCL
E516 38 E5          	JR	C,RWX1
E518                SCF_RET:
E518 37             	SCF
E519 C9             	RET
E51A                
E51A                DSKF:
E51A 11 00 00       MAXCLP:	LD	DE,0
E51D 2A AC EF       	LD	HL,(_FAKEFREE)
E520 7C             	LD	A,H
E521 B5             	OR	L
E522 28 03          	JR	Z,DSKF1
E524 11 01 00       	LD	DE,1
E527                DSKF1:
E527 D5             	PUSH	DE
E528 CD F7 EF       	CALL	_GNCL
E52B 38 0C          	JR	C,POPSCF
E52D 7A             	LD	A,D
E52E B3             	OR	E
E52F 20 01          	JR	NZ,DSKF2
E531 23             	INC	HL
E532                DSKF2:
E532 D1             	POP	DE
E533 1B             	DEC	DE
E534 7A             	LD	A,D
E535 B3             	OR	E
E536 20 EF          	JR	NZ,DSKF1
E538 C9             	RET
E539                
E539                POPSCF:
E539 F1             	POP	AF
E53A 37             	SCF
E53B C9             	RET
E53C                
E53C                SETTMS:
E53C FD 7E 17       	LD	A,(IY+23)	;(FCB)ファイルを最後に変更した時刻
E53F 3C             	INC	A
E540 C0             	RET	NZ		;ファイルが更新されていない
E541                SETTMSX:			;FCBに日付時刻をセットする
E541 CD F2 DB       	CALL	_SYS2C		;(BDOS)時刻の獲得
E544                				;H←時  L←分  D←秒
E544 CB 25          	SLA	L		;   *2
E546 CB 25          	SLA	L		;   *4
E548 29             	ADD	HL,HL		;*2 *8
E549 29             	ADD	HL,HL		;*4 *16
E54A 29             	ADD	HL,HL		;*8 *32
E54B 7A             	LD	A,D
E54C 0F             	RRCA			;bit.0->7->->->0->C
E54D E6 1F          	AND	01FH
E54F B5             	OR	L
E550 FD 77 16       	LD	(IY+22),A	;(FCB)ファイルを最後に変更した時刻
E553 FD 74 17       	LD	(IY+23),H
E556                
E556 CD CF DB       	CALL	_SYS2A		;(BDOS)日付の獲得
E559                				;HL←年  D←月  E←日
E559 01 44 F8       	LD	BC,0-1980
E55C 09             	ADD	HL,BC
E55D 65             	LD	H,L
E55E                
E55E 7A             	LD	A,D
E55F 87             	ADD	A,A		;*2
E560 87             	ADD	A,A		;*4
E561 87             	ADD	A,A		;*8
E562 87             	ADD	A,A		;*16
E563 6F             	LD	L,A
E564 29             	ADD	HL,HL		;*32
E565 7D             	LD	A,L
E566 B3             	OR	E
E567 FD 77 14       	LD	(IY+20),A	;(FCB)ファイルを最後に変更した日付
E56A FD 74 15       	LD	(IY+21),H
E56D C9             	RET
E56E                
E56E                PUSHRR:
E56E 32 0D E6       	LD	(SETSEQ_SWC_RND),A
E571 22 1F E6       	LD	(SETSEQ_SWC_SEQ_RR),HL
E574 CD 94 E5       	CALL	GET_RR_AHL
E577 22 5A EF       	LD	(HLBUF),HL
E57A 32 5C EF       	LD	(HLBUF+2),A
E57D C9             	RET
E57E                
E57E                GET_CPM_R_SIZE:		;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
E57E 87             	ADD	A,A		;in BHLA => out AHL
E57F ED 6A          	ADC	HL,HL
E581 CB 18          	RR	B
E583 B7             	OR	A
E584 78             	LD	A,B		;ここでフラグは変化しない
E585 C8             	RET	Z
E586 2C             	INC	L		;INC AHL
E587 C0             	RET	NZ		;
E588 24             	INC	H		;
E589 C0             	RET	NZ		;
E58A 3C             	INC	A		;
E58B C9             	RET
E58C                
E58C                INIT_RND:
E58C 3E CD          	LD	A,0CDH		;CALL ????
E58E 21 DD E5       	LD	HL,POPRR
E591 CD 6E E5       	CALL	PUSHRR
E594                GET_RR_AHL:
E594 FD 6E 21       	LD	L,(IY+33)	;(FCB)Random record
E597 FD 66 22       	LD	H,(IY+34)	;
E59A FD 7E 23       	LD	A,(IY+35)	;
E59D C9             	RET
E59E                SET_RR_AHL:
E59E FD 75 21       	LD	(IY+33),L	;(FCB)Random record
E5A1 FD 74 22       	LD	(IY+34),H
E5A4 FD 77 23       	LD	(IY+35),A
E5A7 C9             	RET
E5A8                INIT_SEQ:
E5A8 3E 01          	LD	A,1		;LD BC,????
E5AA 21 DA E5       	LD	HL,SETSEQ
E5AD CD 6E E5       	CALL	PUSHRR
E5B0                GETSEQ:
E5B0 FD 6E 20       	LD	L,(IY+32)	;(FCB)カレントレコード
E5B3 FD 66 0C       	LD	H,(IY+12)	;(FCB)カレントブロック
E5B6 AF             	XOR	A
E5B7                
E5B7 CB 25          	SLA	L	;L=L*2
E5B9                
E5B9 CB 3C          	SRL	H	;HL=HL/2
E5BB CB 1D          	RR	L	;
E5BD C9             	RET
E5BE                
E5BE                SETSEQ1:
E5BE F5             	PUSH	AF		
E5BF E5             	PUSH	HL		;AHL=Random record
E5C0 FD 7E 21       	LD	A,(IY+33)	;(FCB)ランダムレコード
E5C3 FD 6E 22       	LD	L,(IY+34)
E5C6 FD 66 23       	LD	H,(IY+35)
E5C9 06 00          	LD	B,0
E5CB                
E5CB CD 7E E5       	CALL	GET_CPM_R_SIZE
E5CE                
E5CE 29             	ADD	HL,HL
E5CF CB 3D          	SRL	L		;L=L/2
E5D1 FD 75 20       	LD	(IY+32),L	;(FCB)カレントレコード
E5D4 FD 74 0C       	LD	(IY+12),H	;(FCB)カレントブロック
E5D7 E1             	POP	HL
E5D8 F1             	POP	AF
E5D9 C9             	RET
E5DA                SETSEQ:
E5DA CD BE E5       	CALL	SETSEQ1
E5DD                POPRR:
E5DD F5             	PUSH	AF
E5DE E5             	PUSH	HL
E5DF 2A 5A EF       	LD	HL,(HLBUF)
E5E2 3A 5C EF       	LD	A,(HLBUF+2)
E5E5 CD 9E E5       	CALL	SET_RR_AHL
E5E8 E1             	POP	HL
E5E9 F1             	POP	AF
E5EA C9             	RET
E5EB                
E5EB                RB_WRITE:
E5EB C5             	PUSH	BC
E5EC ED 4B 4C F0    	LD	BC,(STABLE+2*026H)	;(BDOS)ランダムブロック書き込み
E5F0 18 05          	JR	RBRW
E5F2                RB_READ:
E5F2 C5             	PUSH	BC
E5F3 ED 4B 4E F0    	LD	BC,(STABLE+2*027H)	;(BDOS)ランダムブロック読み込み
E5F7                RBRW:
E5F7 CB 3F          	SRL	A	;AHLA' = HL*128
E5F9 CB 1C          	RR	H	;AHL=AHL/2
E5FB CB 1D          	RR	L	;
E5FD 3E 00          	LD	A,0
E5FF 1F             	RRA		;A'HLA
E600 FD 77 21       	LD	(IY+33),A	;(FCB)ランダムレコード
E603 FD 75 22       	LD	(IY+34),L
E606 FD 74 23       	LD	(IY+35),H
E609 21 80 00       	LD	HL,128
E60C C5             	PUSH	BC
E60D                SETSEQ_SWC_RND:
E60D CD BE E5       	CALL	SETSEQ1
E610 C1             	POP	BC
E611 FD CB 20 FE    	SET	7,(IY+32)	;(FCB)カレントレコード
E615 FD E5          	PUSH	IY
E617 D1             	POP	DE
E618 D5             	PUSH	DE
E619 CD 27 E6       	CALL	JP_BC
E61C FD E1          	POP	IY
E61E 00 00 E6 1F    SETSEQ_SWC_SEQ_RR	EQU $+1
E61E CD DA E5       	CALL	SETSEQ
E621 FD CB 20 BE    	RES	7,(IY+32)	;(FCB)カレントレコード
E625                
E625 C1             	POP	BC
E626 C9             	RET
E627                JP_BC:
E627 C5             	PUSH	BC
E628 C9             	RET
E629                
E629 00 00 E1 A1    _SYS03	EQU	SCF_FF_RET	;(BDOS)外部入力
E629 00 00 E1 A1    _SYS2B	EQU	SCF_FF_RET	;(BDOS)日付の設定
E629 00 00 E1 A1    _SYS2D	EQU	SCF_FF_RET	;(BDOS)時刻の設定
E629 00 00 E1 A1    _SYS39	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの作成
E629 00 00 E1 A1    _SYS3A	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの削除
E629                
E629                	INCLUDE	"LDFILE2.ASM"
E629                
E629                ;	LSX-Dodgers FILE2
E629                
E629                				;Write random block
E629                _SYS26:		;(BDOS)ランダムブロック書き込み
E629 AF             	XOR	A
E62A 32 15 E9       	LD	(DRDN1),A	;NOP
E62D 22 59 E8       	LD	(LEFT+1),HL	;HL←書き込むレコード数
E630 22 5D EF       	LD	(LEFTX),HL
E633 CD F6 E0       	CALL	SETDRV
E636                
E636 CD B0 E7       	CALL	RBX0
E639 DA D3 E6       	JP	C,RBWERR
E63C CD 7E E4       	CALL	WOPEN
E63F DA D3 E6       	JP	C,RBWERR
E642 7C             	LD	A,H
E643 B5             	OR	L
E644 CA CC E6       	JP	Z,RBW1
E647                
E647 2B             	DEC	HL
E648                
E648 CD 7B E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E64B                
E64B 19             	ADD	HL,DE		;BCHL=HL+BCDE
E64C 30 01          	JR	NC,S26X1	;
E64E 03             	INC	BC		;
E64F                S26X1:
E64F CD E5 E4       	CALL	RWXR
E652 DC 8F E4       	CALL	C,WRDFX
E655 DA D3 E6       	JP	C,RBWERR
E658                
E658 CD DF E7       	CALL	RBX2
E65B 28 1A          	JR	Z,RBWB		;NZ=セクタ以下の端数がある
E65D CD FE E7       	CALL	RBXA
E660 38 71          	JR	C,RBWERR
E662 EB             	EX	DE,HL
E663 C5             	PUSH	BC
E664 ED B0          	LDIR
E666 22 5F EF       	LD	(DTAX),HL
E669                
E669 CD 23 E4       	CALL	SWTDBF		;バッファデータは更新された
E66C                
E66C 2A 5D EF       	LD	HL,(LEFTX)
E66F D1             	POP	DE
E670 ED 52          	SBC	HL,DE
E672 22 5D EF       	LD	(LEFTX),HL
E675 28 33          	JR	Z,RBWEND
E677                
E677                RBWB:
E677 CD 34 E8       	CALL	RBXB
E67A 28 16          	JR	Z,RBWC
E67C                RBWB1:
E67C C5             	PUSH	BC
E67D D5             	PUSH	DE
E67E CD F4 E2       	CALL	CLUSTX
E681 CD 8F E8       	CALL	DWTC
E684 D1             	POP	DE
E685 C1             	POP	BC
E686 38 4B          	JR	C,RBWERR
E688 CD 8D EA       	CALL	GNCLX
E68B 38 46          	JR	C,RBWERR
E68D 10 ED          	DJNZ	RBWB1
E68F CD DF E8       	CALL	DRW_FLUSH
E692                RBWC:
E692 CD 4C E8       	CALL	RBXC
E695 28 13          	JR	Z,RBWEND
E697 C5             	PUSH	BC
E698 CD F4 E2       	CALL	CLUSTX
E69B CD 14 E9       	CALL	DRDN
E69E C1             	POP	BC
E69F 38 32          	JR	C,RBWERR
E6A1 ED 5B 7E F0    	LD	DE,(_DTBUF)
E6A5 ED B0          	LDIR
E6A7 CD 23 E4       	CALL	SWTDBF		;バッファデータは更新された
E6AA                RBWEND:
E6AA CD 58 E8       	CALL	RBXEND
E6AD                
E6AD CD BF E7       	CALL	RBX1
E6B0 30 1A          	JR	NC,RBW1
E6B2 2A 59 E8       	LD	HL,(LEFT+1)
E6B5 FD 5E 10       	LD	E,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
E6B8 FD 56 11       	LD	D,(IY+17)	;DE=File size
E6BB 19             	ADD	HL,DE
E6BC FD 75 10       	LD	(IY+16),L	;(FCB)ファイルのサイズ(バイト単位)
E6BF FD 74 11       	LD	(IY+17),H
E6C2 30 08          	JR	NC,RBW1
E6C4 FD 34 12       	INC	(IY+18)
E6C7 20 03          	JR	NZ,RBW1
E6C9 FD 34 13       	INC	(IY+19)
E6CC                RBW1:
E6CC FD E1          	POP	IY
E6CE C1             	POP	BC
E6CF D1             	POP	DE
E6D0 E1             	POP	HL
E6D1                DD_NUL:
E6D1 AF             	XOR	A
E6D2                DRDF0:
E6D2                DWTF0:
E6D2 C9             	RET
E6D3                
E6D3                RBWERR:
E6D3 FD E5          	PUSH	IY
E6D5 D1             	POP	DE
E6D6 2A 20 F0       	LD	HL,(STABLE+2*010H)
E6D9 CD 0F 00       	CALL	JP_HL
E6DC                RBRERR1:
E6DC 3E 01          	LD	A,001H
E6DE                RBRERR2:
E6DE FD E1          	POP	IY
E6E0 C1             	POP	BC
E6E1 D1             	POP	DE
E6E2 E1             	POP	HL
E6E3 37             	SCF
E6E4 21 00 00       	LD	HL,0
E6E7 C9             	RET
E6E8                
E6E8                RBRERR:
E6E8 3E FF          	LD	A,0FFH
E6EA 18 F2          	JR	RBRERR2
E6EC                
E6EC                RBRFL:
E6EC 3E 00          RBRFLP:	LD	A,000H
E6EE FE 0D          	CP	00DH
E6F0 20 05          	JR	NZ,RBRFL1
E6F2 D5             	PUSH	DE
E6F3 1E 0A          	LD	E,00AH
E6F5 18 05          	JR	RBRFL2
E6F7                RBRFL1:
E6F7 D5             	PUSH	DE
E6F8 CD 09 EF       	CALL	_SYS07
E6FB 5F             	LD	E,A
E6FC                RBRFL2:
E6FC CD CD EF       	CALL	_PRINT
E6FF 7B             	LD	A,E
E700 D1             	POP	DE
E701 32 ED E6       	LD	(RBRFLP+1),A
E704 C9             	RET
E705                DDX:
E705 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
E708 CD 19 E3       	CALL	CAP
E70B FE 41          	CP	'A'
E70D C9             	RET
E70E                
E70E                				;Read random block
E70E                _SYS27:		;(BDOS)ランダムブロック読み込み
E70E 22 5D EF       	LD	(LEFTX),HL
E711 CD F6 E0       	CALL	SETDRV
E714                
E714 FD CB 0D 66    	BIT	4,(IY+13)	;(FCB)属性(アトリビュート)
E718 C2 9E E7       	JP	NZ,RBRDIR	;ディレクトリ
E71B CD B0 E7       	CALL	RBX0
E71E DA E8 E6       	JP	C,RBRERR
E721 CD BF E7       	CALL	RBX1
E724 DA DC E6       	JP	C,RBRERR1
E727 EB             	EX	DE,HL
E728 ED 52          	SBC	HL,DE		;CP 00HL,BCDE
E72A 19             	ADD	HL,DE
E72B 79             	LD	A,C
E72C DE 00          	SBC	A,0
E72E 78             	LD	A,B
E72F DE 00          	SBC	A,0
E731 38 01          	JR	C,RBR1
E733 EB             	EX	DE,HL
E734                RBR1:
E734 9F             	SBC	A,A
E735 E6 01          	AND	1
E737 32 9C E7       	LD	(RBRAP+1),A
E73A                
E73A 7C             	LD	A,H
E73B B5             	OR	L
E73C 28 57          	JR	Z,RBREND0
E73E                
E73E 22 59 E8       	LD	(LEFT+1),HL	;Read record byte
E741 22 5D EF       	LD	(LEFTX),HL
E744                
E744 CD DF E7       	CALL	RBX2
E747 28 19          	JR	Z,RBRB
E749 CD FE E7       	CALL	RBXA
E74C DA E8 E6       	JP	C,RBRERR
E74F C5             	PUSH	BC
E750 ED B0          	LDIR
E752 ED 53 5F EF    	LD	(DTAX),DE
E756 2A 5D EF       	LD	HL,(LEFTX)
E759 D1             	POP	DE
E75A A7             	AND	A
E75B ED 52          	SBC	HL,DE
E75D 22 5D EF       	LD	(LEFTX),HL
E760 28 30          	JR	Z,RBREND
E762                
E762                RBRB:
E762 CD 34 E8       	CALL	RBXB
E765 28 15          	JR	Z,RBRC
E767                RBRB1:
E767 C5             	PUSH	BC
E768 D5             	PUSH	DE
E769 CD F4 E2       	CALL	CLUSTX
E76C CD 95 E8       	CALL	DRDC
E76F D1             	POP	DE
E770 C1             	POP	BC
E771 D4 8D EA       	CALL	NC,GNCLX
E774 DA E8 E6       	JP	C,RBRERR
E777 10 EE          	DJNZ	RBRB1
E779 CD DF E8       	CALL	DRW_FLUSH
E77C                RBRC:
E77C CD 4C E8       	CALL	RBXC
E77F 28 11          	JR	Z,RBREND
E781 C5             	PUSH	BC
E782 CD F4 E2       	CALL	CLUSTX
E785 CD F8 E8       	CALL	DRDX
E788 C1             	POP	BC
E789 DA E8 E6       	JP	C,RBRERR
E78C EB             	EX	DE,HL
E78D 2A 7E F0       	LD	HL,(_DTBUF)
E790 ED B0          	LDIR
E792                RBREND:
E792 CD 58 E8       	CALL	RBXEND
E795                RBREND0:
E795 FD E1          	POP	IY
E797 C1             	POP	BC
E798 D1             	POP	DE
E799 F1             	POP	AF	;(HL)
E79A AF             	XOR	A
E79B 3E 00          RBRAP:	LD	A,000H
E79D C9             	RET
E79E                
E79E                RBRDIR:
E79E FD 6E 1A       	LD	L,(IY+26)	;(FCB)ファイルの先頭クラスタ
E7A1 FD 66 1B       	LD	H,(IY+27)
E7A4 CD 34 E3       	CALL	CHDIR
E7A7 AF             	XOR	A
E7A8 67             	LD	H,A
E7A9 6F             	LD	L,A
E7AA 3C             	INC	A
E7AB 32 9C E7       	LD	(RBRAP+1),A
E7AE 18 E5          	JR	RBREND0
E7B0                
E7B0                RBX0:
E7B0 2A 8A EF       	LD	HL,(_DTA)
E7B3 22 5F EF       	LD	(DTAX),HL
E7B6 2A 5D EF       	LD	HL,(LEFTX)
E7B9 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
E7BC D6 FD          	SUB	0FDH
E7BE C9             	RET
E7BF                
E7BF                RBX1:
E7BF E5             	PUSH	HL		;Record byte
E7C0                				;AHL=File size
E7C0 FD 6E 10       	LD	L,(IY+16)	;ファイルのサイズ(バイト単位)
E7C3 FD 66 11       	LD	H,(IY+17)	;
E7C6 FD 7E 12       	LD	A,(IY+18)	;
E7C9                
E7C9 CD 7B E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E7CC                
E7CC A7             	AND	A
E7CD ED 52          	SBC	HL,DE
E7CF 99             	SBC	A,C
E7D0 4F             	LD	C,A
E7D1 FD 7E 13       	LD	A,(IY+19)	;ファイルのサイズ
E7D4 98             	SBC	A,B
E7D5 D1             	POP	DE
E7D6                
E7D6 D8             	RET	C
E7D7 47             	LD	B,A
E7D8 B1             	OR	C
E7D9 EB             	EX	DE,HL	;BCDE=File byte	HL=Record byte
E7DA B2             	OR	D
E7DB B3             	OR	E
E7DC C0             	RET	NZ
E7DD 37             	SCF
E7DE C9             	RET
E7DF                
E7DF                RBX2:				;Cluster settings
E7DF FD 66 22       	LD	H,(IY+34)	;(+33)(FCB)ランダムレコード
E7E2 FD 4E 23       	LD	C,(IY+35)
E7E5 06 00          	LD	B,0
E7E7 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E7EB 20 03          	JR	NZ,RBX3
E7ED FD 46 24       	LD	B,(IY+36)
E7F0                RBX3:
E7F0 CD E5 E4       	CALL	RWXR
E7F3 3A 16 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E7F6 3D             	DEC	A
E7F7 FD A6 22       	AND	(IY+34)
E7FA FD B6 21       	OR	(IY+33)
E7FD C9             	RET
E7FE                
E7FE                RBXA:
E7FE C5             	PUSH	BC
E7FF D5             	PUSH	DE
E800 CD F4 E2       	CALL	CLUSTX
E803 CD F8 E8       	CALL	DRDX
E806 D1             	POP	DE
E807 C1             	POP	BC
E808 D8             	RET	C
E809 CD 8D EA       	CALL	GNCLX
E80C D8             	RET	C
E80D ED 53 FE F0    	LD	(_CLPS),DE
E811                
E811 FD 4E 21       	LD	C,(IY+33)	;(FCB)ランダムレコード
E814 21 00 04       SECSZ:	LD	HL,0400H	;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
E817 7C             	LD	A,H
E818 3D             	DEC	A		;1024=3 / 512=1
E819 FD A6 22       	AND	(IY+34)		;(FCB)ランダムレコード
E81C 47             	LD	B,A		;BCに1セクタ以下の端数が入る
E81D ED 42          	SBC	HL,BC		;残りを計算
E81F                
E81F ED 5B 5D EF    	LD	DE,(LEFTX)
E823 ED 52          	SBC	HL,DE		;CP HL,DE
E825 19             	ADD	HL,DE		;
E826 38 01          	JR	C,RBXA1		;DEとHLを比較して大きい方をHLに
E828 EB             	EX	DE,HL
E829                RBXA1:
E829 E5             	PUSH	HL
E82A 2A 7E F0       	LD	HL,(_DTBUF)
E82D 09             	ADD	HL,BC
E82E ED 5B 5F EF    	LD	DE,(DTAX)
E832 C1             	POP	BC
E833 C9             	RET
E834                
E834                RBXB:
E834 2A 5F EF       	LD	HL,(DTAX)
E837 ED 5B FE F0    	LD	DE,(_CLPS)
E83B 3A 5E EF       	LD	A,(LEFTX+1)
E83E 47             	LD	B,A
E83F 3A 16 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E842                RBXB1:
E842 1F             	RRA		;->CF
E843 38 04          	JR	C,RBXB2
E845 CB 38          	SRL	B	;B=B/2
E847 18 F9          	JR	RBXB1
E849                RBXB2:
E849 78             	LD	A,B
E84A B7             	OR	A
E84B C9             	RET
E84C                
E84C                RBXC:
E84C ED 4B 5D EF    	LD	BC,(LEFTX)
E850 3A 16 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E853 3D             	DEC	A
E854 A0             	AND	B
E855 47             	LD	B,A		;1セクタ以下の端数がない場合はZ
E856 B1             	OR	C
E857 C9             	RET
E858                
E858                RBXEND:
E858 11 00 00       LEFT:	LD	DE,0
E85B AF             	XOR	A
E85C FD 6E 21       	LD	L,(IY+33)	;(FCB)ランダムレコード
E85F FD 66 22       	LD	H,(IY+34)
E862 19             	ADD	HL,DE
E863 FD 75 21       	LD	(IY+33),L	;(FCB)ランダムレコード
E866 FD 74 22       	LD	(IY+34),H
E869 30 0E          	JR	NC,RBXEND1
E86B FD 34 23       	INC	(IY+35)
E86E 20 09          	JR	NZ,RBXEND1
E870 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E874 20 03          	JR	NZ,RBXEND1
E876 FD 34 24       	INC	(IY+36)
E879                RBXEND1:
E879 EB             	EX	DE,HL		;HL=Read byte
E87A C9             	RET
E87B                
E87B                GET_RR_BCDE:			;BCDE=Random record
E87B FD 5E 21       	LD	E,(IY+33)	;(FCB)ランダムレコード
E87E FD 56 22       	LD	D,(IY+34)
E881 FD 4E 23       	LD	C,(IY+35)
E884 FD 46 24       	LD	B,(IY+36)
E887 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E88B C8             	RET	Z
E88C 06 00          	LD	B,0		;CP/M互換のアクセスの場合はFCBは36バイト
E88E C9             	RET
E88F                
E88F                ;	ランダムブロックアクセスの連続したセクタをまとめる
E88F                
E88F                DWTC:
E88F E5             	PUSH	HL
E890 21 F7 EB       	LD	HL,DWT24B
E893 18 04          	JR	DWTC1
E895                DRDC:
E895 E5             	PUSH	HL
E896 21 E7 EB       	LD	HL,DRD24B
E899                DWTC1:
E899 22 F3 E8       	LD	(DRWF_MODE),HL
E89C E1             	POP	HL
E89D 3A E3 E8       	LD	A,(DRWF_B)
E8A0 B7             	OR	A
E8A1 20 0F          	JR	NZ,DRDC1
E8A3                SAVE_DRWC:
E8A3 06 01          	LD	B,1
E8A5 ED 43 E2 E8    	LD	(DRWF_C),BC
E8A9 ED 53 E9 E8    	LD	(DRWF_E),DE
E8AD 22 EC E8       	LD	(DRWF_HL),HL
E8B0 18 20          	JR	INC_HL_DRWC
E8B2                DRDC1:
E8B2 E5             	PUSH	HL
E8B3 21 E9 E8       	LD	HL,DRWF_E
E8B6 86             	ADD	A,(HL)
E8B7 F5             	PUSH	AF
E8B8 BB             	CP	E
E8B9 20 1D          	JR	NZ,DRDC2
E8BB F1             	POP	AF
E8BC 23             	INC	HL
E8BD 7E             	LD	A,(HL)
E8BE CE 00          	ADC	A,0
E8C0 F5             	PUSH	AF
E8C1 BA             	CP	D
E8C2 20 14          	JR	NZ,DRDC2
E8C4 F1             	POP	AF
E8C5 3A E2 E8       	LD	A,(DRWF_C)
E8C8 CE 00          	ADC	A,0
E8CA B9             	CP	C
E8CB 20 0C          	JR	NZ,DRDC3
E8CD 21 E3 E8       	LD	HL,DRWF_B
E8D0 34             	INC	(HL)
E8D1 E1             	POP	HL
E8D2                INC_HL_DRWC:
E8D2 3A 16 E8       	LD	A,(SECSZ+2)		;1セクタのサイズの上位1バイト
E8D5 84             	ADD	A,H
E8D6 67             	LD	H,A
E8D7 C9             	RET
E8D8                DRDC2:
E8D8 F1             	POP	AF
E8D9                DRDC3:
E8D9 CD DF E8       	CALL	DRW_FLUSH
E8DC E1             	POP	HL
E8DD 18 C4          	JR	SAVE_DRWC
E8DF                
E8DF                ;	ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
E8DF                DRW_FLUSH:
E8DF C5             	PUSH	BC
E8E0 D5             	PUSH	DE
E8E1 00 00 E8 E2    DRWF_C	EQU	$+1
E8E1 00 00 E8 E3    DRWF_B	EQU	$+2
E8E1 01 00 00       	LD	BC,0
E8E4 78             	LD	A,B
E8E5 B7             	OR	A
E8E6 28 0D          	JR	Z,DRDF1
E8E8 00 00 E8 E9    DRWF_E	EQU	$+1
E8E8 00 00 E8 EA    DRWF_D	EQU	$+2
E8E8 11 00 00       	LD	DE,0
E8EB 00 00 E8 EC    DRWF_HL	EQU	$+1
E8EB 21 00 00       	LD	HL,0
E8EE AF             	XOR	A
E8EF 32 E3 E8       	LD	(DRWF_B),A
E8F2 00 00 E8 F3    DRWF_MODE	EQU	$+1
E8F2 CD E7 EB       	CALL	DRD24B
E8F5                DRDF1:
E8F5 D1             	POP	DE
E8F6 C1             	POP	BC
E8F7 C9             	RET
E8F8                	INCLUDE	"LDDIO.ASM"
E8F8                
E8F8                ;	LSX-Dodgers DIO
E8F8                
E8F8                DRDX:
E8F8 CD 36 E9       	CALL	DRDY
E8FB C8             	RET	Z
E8FC CD 1C E9       	CALL	DRDX1		;データバッファの情報を保存
E8FF D8             	RET	C
E900 E5             	PUSH	HL
E901 C5             	PUSH	BC
E902 D5             	PUSH	DE
E903 2A 7E F0       	LD	HL,(_DTBUF)
E906 3A 5F E9       	LD	A,(_DBS24+1)
E909 4F             	LD	C,A
E90A CD E5 EB       	CALL	DRD24
E90D DC 31 E9       	CALL	C,DRDNE
E910                POP_DE_BC_HL_RET:
E910 D1             	POP	DE
E911 C1             	POP	BC
E912 E1             	POP	HL
E913 C9             	RET
E914                
E914                ;	CDE:セクタ番号
E914                DRDN:
E914 AF             	XOR	A
E915 00             DRDN1:	NOP			;自己書き換え NOP / SCF
E916 30 E0          	JR	NC,DRDX
E918                DRDNX:
E918 CD 36 E9       	CALL	DRDY
E91B C8             	RET	Z
E91C                DRDX1:
E91C CD 4C E9       	CALL	DWTX
E91F                				;データバッファの読み込んだドライブ・セクタ情報を保存
E91F ED 53 A6 EF    	LD	(_DBSEC),DE
E923 79             	LD	A,C
E924 32 5F E9       	LD	(_DBS24+1),A
E927                
E927 3A 88 EF       	LD	A,(_DRV)
E92A 32 A5 EF       	LD	(_DBDRV),A
E92D CD D9 EF       	CALL	_CHGDRV
E930 D0             	RET	NC
E931                DRDNE:
E931 9F             	SBC	A,A		;CF=1ならばA=0FFH
E932 32 A5 EF       	LD	(_DBDRV),A
E935 C9             	RET
E936                
E936                ;	CDE:セクタ番号
E936                DRDY:
E936 3A 5F E9       	LD	A,(_DBS24+1)
E939 B9             	CP	C
E93A C0             	RET	NZ
E93B                
E93B E5             	PUSH	HL
E93C 3A 88 EF       	LD	A,(_DRV)
E93F 21 A5 EF       	LD	HL,_DBDRV
E942 AE             	XOR	(HL)
E943 20 05          	JR	NZ,POP_HL_RET
E945                
E945 2A A6 EF       	LD	HL,(_DBSEC)
E948 ED 52          	SBC	HL,DE		;CF=0
E94A                POP_HL_RET:
E94A E1             	POP	HL
E94B C9             	RET
E94C                
E94C                DWTX:
E94C 3A A4 EF       	LD	A,(_WTDBF)
E94F B7             	OR	A
E950 C8             	RET	Z
E951 AF             	XOR	A
E952 32 A4 EF       	LD	(_WTDBF),A
E955                
E955 E5             	PUSH	HL
E956 C5             	PUSH	BC
E957 D5             	PUSH	DE
E958 3A A5 EF       	LD	A,(_DBDRV)
E95B CD D9 EF       	CALL	_CHGDRV
E95E 0E 00          _DBS24:	LD	C,0
E960 ED 5B A6 EF    	LD	DE,(_DBSEC)
E964 2A 7E F0       	LD	HL,(_DTBUF)
E967 D4 F5 EB       	CALL	NC,DWT24
E96A                POP_DE_BC_HL_RET2:
E96A 18 A4          	JR	POP_DE_BC_HL_RET
E96C                
E96C                RDFATX:
E96C E5             	PUSH	HL
E96D 3A 88 EF       	LD	A,(_DRV)
E970 21 AA EF       	LD	HL,_FATDRV
E973 AE             	XOR	(HL)
E974 28 D4          	JR	Z,POP_HL_RET
E976                
E976 C5             	PUSH	BC
E977 D5             	PUSH	DE
E978 DD E5          	PUSH	IX
E97A CD 96 E9       	CALL	WTFATX
E97D 38 13          	JR	C,POP_IX_DE_BC_HL_RET
E97F                
E97F AF             	XOR	A
E980 32 AB EF       	LD	(_FATIX),A
E983 3A 88 EF       	LD	A,(_DRV)
E986 32 AA EF       	LD	(_FATDRV),A
E989 CD E5 EF       	CALL	_RDFAT
E98C                RDFATE2:
E98C 30 04          	JR	NC,POP_IX_DE_BC_HL_RET
E98E 9F             	SBC	A,A		;A=0xFF
E98F 32 AA EF       	LD	(_FATDRV),A
E992                POP_IX_DE_BC_HL_RET:
E992 DD E1          	POP	IX
E994 18 D4          	JR	POP_DE_BC_HL_RET2
E996                
E996                WTFATX:
E996 3A A2 EF       	LD	A,(_WTFATF)
E999 B7             	OR	A
E99A C8             	RET	Z
E99B E5             	PUSH	HL
E99C 3A AA EF       	LD	A,(_FATDRV)
E99F 21 A5 EF       	LD	HL,_DBDRV
E9A2 AE             	XOR	(HL)
E9A3 CC 4C E9       	CALL	Z,DWTX
E9A6 38 A2          	JR	C,POP_HL_RET
E9A8 C5             	PUSH	BC
E9A9 D5             	PUSH	DE
E9AA DD E5          	PUSH	IX
E9AC CD 02 EC       	CALL	WTFAT
E9AF AF             	XOR	A
E9B0 32 A2 EF       	LD	(_WTFATF),A
E9B3 18 DD          	JR	POP_IX_DE_BC_HL_RET
E9B5                
E9B5                NCL1:
E9B5 7A             	LD	A,D
E9B6 B3             	OR	E
E9B7 37             	SCF
E9B8 C8             	RET	Z
E9B9                
E9B9 7A             	LD	A,D
E9BA CB 3F          	SRL	A	;/2
E9BC CB 3F          	SRL	A	;/2
E9BE                
E9BE E5             	PUSH	HL
E9BF 32 DE E9       	LD	(NCLPAT+2),A	;_FATIX
E9C2 2A AA EF       	LD	HL,(_FATDRV)	;L=_FATDRV H=_FATIX
E9C5 BC             	CP	H
E9C6 3A 88 EF       	LD	A,(_DRV)	;この間でフラグは変化しない
E9C9 32 DD E9       	LD	(NCLPAT+1),A	;_FATDRV
E9CC 20 05          	JR	NZ,NCL2		;FATIXが違う
E9CE BD             	CP	L
E9CF 20 02          	JR	NZ,NCL2		;ドライブが違う
E9D1 E1             	POP	HL
E9D2 C9             	RET
E9D3                NCL2:
E9D3 C5             	PUSH	BC
E9D4 D5             	PUSH	DE
E9D5 DD E5          	PUSH	IX
E9D7 CD 96 E9       	CALL	WTFATX
E9DA 38 B6          	JR	C,POP_IX_DE_BC_HL_RET
E9DC 01 00 00       NCLPAT:	LD	BC,0		;自己書き換え C=_FATDRV B=_FATIX
E9DF ED 43 AA EF    	LD	(_FATDRV),BC
E9E3 CD D7 EB       	CALL	RDFATS
E9E6 18 A4          	JR	RDFATE2
E9E8                
E9E8                NCL3:
E9E8 CB 9A          	RES	3,D
E9EA CB 92          	RES	2,D
E9EC 6B             	LD	L,E
E9ED 62             	LD	H,D
E9EE CB 3C          	SRL	H	;
E9F0 CB 1D          	RR	L	;HLA=HLA/2
E9F2 1F             	RRA		;
E9F3 F5             	PUSH	AF
E9F4 3A AB EF       	LD	A,(_FATIX)
E9F7 0F             	RRCA
E9F8 30 0B          	JR	NC,NCL3X1
E9FA 3A 16 E8       	LD	A,(SECSZ+2)
E9FD FE 04          	CP	4		;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
E9FF 20 04          	JR	NZ,NCL3X1
EA01 01 00 02       	LD	BC,512
EA04 09             	ADD	HL,BC
EA05                NCL3X1:
EA05 F1             	POP	AF
EA06 ED 4B 7C F0    	LD	BC,(_FATBF)
EA0A 19             	ADD	HL,DE
EA0B 09             	ADD	HL,BC
EA0C 17             	RLA
EA0D C9             	RET
EA0E                
EA0E                GNCL:
EA0E CD B5 E9       	CALL	NCL1		;GET NEXT CLUSTER
EA11 D8             	RET	C
EA12 C5             	PUSH	BC
EA13 E5             	PUSH	HL
EA14 CD E8 E9       	CALL	NCL3
EA17 38 09          	JR	C,GNC1
EA19 5E             	LD	E,(HL)
EA1A 23             	INC	HL
EA1B 7E             	LD	A,(HL)
EA1C E6 0F          	AND	00FH
EA1E 57             	LD	D,A
EA1F E1             	POP	HL
EA20 C1             	POP	BC
EA21 C9             	RET
EA22                GNC1:
EA22 7E             	LD	A,(HL)
EA23 23             	INC	HL
EA24 56             	LD	D,(HL)
EA25 06 04          	LD	B,4
EA27                GNC1L:
EA27 CB 3A          	SRL	D	;DA=DA/2
EA29 1F             	RRA		;
EA2A 10 FB          	DJNZ	GNC1L
EA2C                
EA2C 5F             	LD	E,A
EA2D E1             	POP	HL
EA2E C1             	POP	BC
EA2F A7             	AND	A
EA30 C9             	RET
EA31                
EA31                SNCL:
EA31 CD B5 E9       	CALL	NCL1
EA34 D8             	RET	C
EA35                ;				SET NEXT CLUSTER
EA35 E5             	PUSH	HL
EA36 C5             	PUSH	BC
EA37 D5             	PUSH	DE
EA38 E5             	PUSH	HL
EA39 CD E8 E9       	CALL	NCL3
EA3C D1             	POP	DE
EA3D                ;CF=ODD
EA3D 7E             	LD	A,(HL)
EA3E 73             	LD	(HL),E
EA3F 38 06          	JR	C,SNC1
EA41                ;EVEN
EA41                ;M[0] = E
EA41                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
EA41 23             	INC	HL
EA42 ED 67          	RRD		;M={A[3:0],E[3:0]}
EA44 7A             	LD	A,D
EA45 18 04          	JR	SNC11
EA47                SNC1:
EA47                ;ODD
EA47                ;HL[0] = (HL[0]&0x0F) | (E<<4)
EA47                ;HL[1] = DE>>4
EA47 ED 6F          	RLD		;M={D[3:0],E[7:4]}
EA49 23             	INC	HL
EA4A 72             	LD	(HL),D	;M={D[3:0],E[7:4]}
EA4B                SNC11:
EA4B ED 6F          	RLD		;M={M[7:4],D[3:0]}
EA4D B7             	OR	A
EA4E D1             	POP	DE
EA4F C1             	POP	BC
EA50 E1             	POP	HL
EA51                FAT_CHANGED:
EA51 3E 01          	LD	A,1
EA53 32 A2 EF       	LD	(_WTFATF),A
EA56 C9             	RET
EA57                
EA57                N16CL3:
EA57 C5             	PUSH	BC
EA58 6B             	LD	L,E
EA59 7A             	LD	A,D
EA5A E6 03          	AND	3
EA5C 67             	LD	H,A
EA5D 29             	ADD	HL,HL
EA5E ED 4B 7C F0    	LD	BC,(_FATBF)
EA62 09             	ADD	HL,BC
EA63 C1             	POP	BC
EA64 C9             	RET
EA65                
EA65                GNCL16:
EA65 CD B5 E9       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EA68 D8             	RET	C
EA69 E5             	PUSH	HL
EA6A CD 57 EA       	CALL	N16CL3
EA6D 5E             	LD	E,(HL)
EA6E 23             	INC	HL
EA6F 56             	LD	D,(HL)
EA70 E1             	POP	HL
EA71 C9             	RET
EA72                
EA72                SNCL16:
EA72 CD B5 E9       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EA75 D8             	RET	C
EA76 D5             	PUSH	DE
EA77 E5             	PUSH	HL
EA78 CD 57 EA       	CALL	N16CL3
EA7B D1             	POP	DE		;HL
EA7C 73             	LD	(HL),E
EA7D 23             	INC	HL
EA7E 72             	LD	(HL),D
EA7F 6B             	LD	L,E
EA80 62             	LD	H,D
EA81 D1             	POP	DE
EA82 18 CD          	JR	FAT_CHANGED
EA84                
EA84                ;------------------------
EA84                ;次のセクタを探す際に_SECPSの値をチェック
EA84                ;in
EA84                ;	DE : セクタ番号
EA84                ;out
EA84                ;	DE : 次のセクタ番号
EA84                ;note
EA84                ;
EA84                ;------------------------
EA84                NEXTX:
EA84 3E 00          _SECPS:	LD	A,0	;自己書き換え
EA86 3C             	INC	A
EA87 E6 00          NCPAT:	AND	0	;自己書き換え　1クラスタの論理セクタ数-1
EA89 32 85 EA       	LD	(_SECPS+1),A
EA8C C9             	RET
EA8D                
EA8D                GNCLX:
EA8D CD 84 EA       	CALL	NEXTX
EA90 C0             	RET	NZ	;1クラスタのセクタ未満の場合は戻る
EA91 C3 F7 EF       	JP	_GNCL	;次のクラスタを探す
EA94                
EA94                RDFAT:
EA94 3E 80          	LD	A,080H
EA96 32 70 EF       	LD	(CHECK),A
EA99                RDFAT1:
EA99 3A 88 EF       	LD	A,(_DRV)
EA9C CD 2C ED       	CALL	CHGDRVR
EA9F D8             	RET	C
EAA0 DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EAA3 CB 6F          	BIT	5,A
EAA5 28 43          	JR	Z,RDFAT0X
EAA7 21 70 EF       	LD	HL,CHECK
EAAA A6             	AND	(HL)
EAAB 77             	LD	(HL),A
EAAC 11 00 00       	LD	DE,0		;BPB
EAAF 2A 7C F0       	LD	HL,(_FATBF)
EAB2 CD E3 EB       	CALL	DRD16
EAB5 30 24          	JR	NC,GETBPB
EAB7 21 70 EF       	LD	HL,CHECK
EABA CB 06          	RLC	(HL)
EABC 3F             	CCF
EABD D8             	RET	C
EABE DD CB 0A 1E    	RR	(IX+00AH)	;DPB_0A_FDMODE
EAC2 3F             	CCF			;フロッピーディスクのMFMモードを切り替える
EAC3 DD CB 0A 16    	RL	(IX+00AH)	;DPB_0A_FDMODE
EAC7 3E FF          	LD	A,0FFH
EAC9 32 89 EF       	LD	(_DSK),A
EACC 3A 84 EF       	LD	A,(_DRIVE)
EACF E6 03          	AND	3
EAD1 F6 80          	OR	080H
EAD3 6F             	LD	L,A
EAD4 26 EF          	LD	H,_CYL0/256
EAD6 3E FF          	LD	A,0FFH
EAD8 77             	LD	(HL),A
EAD9 18 BE          	JR	RDFAT1
EADB                GETBPB:
EADB FD E5          	PUSH	IY
EADD FD 2A 7C F0    	LD	IY,(_FATBF)	;BPB
EAE1 CD F1 EF       	CALL	_BPB2DPB
EAE4 FD E1          	POP	IY
EAE6 D8             	RET	C
EAE7 CD 8B EC       	CALL	CHGDRV2
EAEA                RDFAT0X:
EAEA CD D7 EB       	CALL	RDFATS
EAED D8             	RET	C
EAEE DD BE 06       	CP	(IX+6)		;DPB_06_FATID
EAF1 C8             	RET	Z
EAF2 DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
EAF6 C0             	RET	NZ		;BPBを取得している場合はFATIDをチェックしない
EAF7 37             	SCF
EAF8 C9             	RET
EAF9                
EAF9                BPB2DPB:
EAF9 FD 7E 0B       	LD	A,(IY+11)	;BPB_BytsPerSec
EAFC B7             	OR	A
EAFD 37             	SCF
EAFE C0             	RET	NZ
EAFF                BPBOK:
EAFF FD 7E 0D       	LD	A,(IY+13)	;BPB_SecPerClus
EB02 DD 77 07       	LD	(IX+7),A	;DPB_07_SECPCL
EB05                
EB05 FD 7E 16       	LD	A,(IY+22)	;BPB_FATSz16
EB08 DD 77 00       	LD	(IX+0),A	;DPB_00_FATLN
EB0B FD 7E 17       	LD	A,(IY+23)	;BPB_FATSz16
EB0E DD 77 01       	LD	(IX+1),A	;DPB_00_FATLN
EB11                
EB11 FD 6E 0E       	LD	L,(IY+14)	;BPB_RsvdSecCnt
EB14 FD 66 0F       	LD	H,(IY+15)
EB17 DD 75 0E       	LD	(IX+00EH),L	;DPB_0E_FATPS
EB1A FD 5E 16       	LD	E,(IY+22)	;BPB_FATSz16
EB1D FD 56 17       	LD	D,(IY+23)
EB20 FD 46 10       	LD	B,(IY+16)	;BPB_NumFATs
EB23                BPBDP1:				;BPB_FATSz16 * BPB_NumFATs
EB23 19             	ADD	HL,DE
EB24 10 FD          	DJNZ	BPBDP1
EB26                BPBDP2:
EB26 DD 75 10       	LD	(IX+010H),L	;DPB_10_DIRPS
EB29 DD 74 11       	LD	(IX+011H),H
EB2C E5             	PUSH	HL
EB2D                
EB2D FD 6E 11       	LD	L,(IY+17)	;BPB_RootEntCnt
EB30 FD 66 12       	LD	H,(IY+18)
EB33 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EB36 B7             	OR	A
EB37 37             	SCF
EB38 C8             	RET	Z
EB39 06 06          	LD	B,6
EB3B                BPBBPS1:
EB3B 05             	DEC	B
EB3C 0F             	RRCA
EB3D 30 FC          	JR	NC,BPBBPS1
EB3F                BPBDE1:
EB3F 29             	ADD	HL,HL
EB40 10 FD          	DJNZ	BPBDE1
EB42                
EB42 7C             	LD	A,H
EB43 DD 77 0B       	LD	(IX+00BH),A	;DPB_0B_DIRSCNT
EB46                
EB46 D1             	POP	DE		;DPB_10_DIRPS
EB47 6C             	LD	L,H
EB48 26 00          	LD	H,0
EB4A 19             	ADD	HL,DE		;MAXDIR
EB4B E5             	PUSH	HL
EB4C FD 4E 0D       	LD	C,(IY+13)	;BPB_SecPerClus
EB4F CB 21          	SLA	C		;*2
EB51 AF             	XOR	A
EB52 47             	LD	B,A
EB53 ED 42          	SBC	HL,BC
EB55 DD 75 14       	LD	(IX+014H),L	;DPB_14_ADDCL16
EB58 DD 74 15       	LD	(IX+015H),H
EB5B                
EB5B D1             	POP	DE		;DE=DPB_0B_MAXDIR
EB5C FD 6E 13       	LD	L,(IY+19)	;BPB_TotSec16
EB5F FD 66 14       	LD	H,(IY+20)
EB62                
EB62 DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EB65 E6 0F          	AND	00FH
EB67 FE 07          	CP	7		;フロッピー
EB69 20 19          	JR	NZ,NOT_FD
EB6B E5             	PUSH	HL
EB6C FD 4E 18       	LD	C,(IY+24)	;BPB_SecPerTr
EB6F DD 71 0D       	LD	(IX+00DH),C	;DPB_0D_MAXSEC
EB72 AF             	XOR	A
EB73 CB 21          	SLA	C		;両面なのでセクタ数を２倍
EB75 06 10          	LD	B,16
EB77                DIVSEC:				;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
EB77 29             	ADD	HL,HL
EB78 17             	RLA
EB79 B9             	CP	C
EB7A 38 02             	JR	C,DIVSEC1
EB7C 91                	SUB	C
EB7D 2C             	INC	L
EB7E                DIVSEC1:
EB7E 10 F7           	DJNZ	DIVSEC
EB80 DD 75 0C       	LD	(IX+00CH),L	;DPB_0C_MAXCYL
EB83 E1             	POP	HL	;ここまでフロッピー専用
EB84                NOT_FD:
EB84 7C             	LD	A,H
EB85 B5             	OR	L
EB86 3E 00          	LD	A,0		;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
EB88 20 10          	JR	NZ,BPB16BIT	;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
EB8A FD 7E 23       	LD	A,(IY+35)	;念のために総セクタ数が24ビットを超える場合はエラーを返す
EB8D B7             	OR	A
EB8E 37             	SCF
EB8F C0             	RET	NZ
EB90 FD 6E 20       	LD	L,(IY+32)	;BPB_TotSec32 は AHL の24ビットで扱う
EB93 FD 66 21       	LD	H,(IY+33)	;1クラスタの論理セクタ数(DPB_07_SECPCL)が最大128なので
EB96 FD 7E 22       	LD	A,(IY+34)	;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
EB99 A7             	AND	A		;CF=0
EB9A                BPB16BIT:
EB9A ED 52          	SBC	HL,DE
EB9C DE 00          	SBC	A,0
EB9E FD 46 0D       	LD	B,(IY+13)	;BPB_SecPerClus
EBA1                BPBTC1:				;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
EBA1 CB 18          	RR	B		;->CY
EBA3 38 08          	JR	C,BPBTC2
EBA5 CB 3F          	SRL	A
EBA7 CB 1C          	RR	H		;AHL=AHL/2
EBA9 CB 1D          	RR	L
EBAB 18 F4          	JR	BPBTC1
EBAD                BPBTC2:
EBAD B7             	OR	A
EBAE 37             	SCF
EBAF C0             	RET	NZ		;念のため(クラスタ数が16ビットを超える場合)
EBB0 23             	INC	HL
EBB1 23             	INC	HL
EBB2 DD 75 08       	LD	(IX+8),L	;DPB_08_MAXCL
EBB5 DD 74 09       	LD	(IX+9),H
EBB8                
EBB8 FD 7E 15       	LD	A,(IY+21)	;BPB_Media
EBBB DD 77 06       	LD	(IX+6),A	;DPB_06_FATID
EBBE                
EBBE FD 7E 10       	LD	A,(IY+16)	;BPB_NumFATs
EBC1 C6 FE          	ADD	A,0-2		;>2:CF=1
EBC3 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EBC6 6F             	LD	L,A
EBC7 30 02          	JR	NC,BPBFAT1
EBC9 F6 80          	OR	080H
EBCB                BPBFAT1:
EBCB DD 77 0F       	LD	(IX+00FH),A	;DPB_0F_BPS
EBCE 2D             	DEC	L		;以下のセクタサイズに合致しない場合はCF=1でエラーにする
EBCF C8             	RET	Z		;1セクタ256バイト
EBD0 2D             	DEC	L
EBD1 C8             	RET	Z		;1セクタ512バイト
EBD2 2D             	DEC	L
EBD3 2D             	DEC	L
EBD4 C8             	RET	Z		;1セクタ1024バイト
EBD5 37             	SCF
EBD6 C9             	RET
EBD7                
EBD7                RDFATS:
EBD7 CD 1D EC       	CALL	FATSETUP
EBDA D8             	RET	C
EBDB CD E7 EB       	CALL	DRD24B
EBDE 2A 7C F0       	LD	HL,(_FATBF)
EBE1 7E             	LD	A,(HL)
EBE2 C9             	RET
EBE3                
EBE3                DRD16:
EBE3 0E 00          	LD	C,0
EBE5                DRD24:
EBE5 06 01          	LD	B,1
EBE7                DRD24B:
EBE7 DD E5          	PUSH	IX
EBE9 DD 2A A8 EF    	LD	IX,(_DPB)
EBED CD 47 EE       DRDPAT:	CALL	FDRD		;自己書き換え（ディスク読み込み）
EBF0                POP_IX_RET:
EBF0 DD E1          	POP	IX
EBF2 C9             	RET
EBF3                
EBF3                DWT16:
EBF3 0E 00          	LD	C,0
EBF5                DWT24:
EBF5 06 01          	LD	B,1
EBF7                DWT24B:
EBF7 DD E5          	PUSH	IX
EBF9 DD 2A A8 EF    	LD	IX,(_DPB)
EBFD CD 39 EE       DWTPAT:	CALL	FDWT		;自己書き換え（ディスク書き込み）
EC00 18 EE          	JR	POP_IX_RET
EC02                
EC02                WTFAT:
EC02 CD 1D EC       	CALL	FATSETUP
EC05 D4 F7 EB       	CALL	NC,DWT24B
EC08 D8             	RET	C
EC09 DD CB 0F 7E    	BIT	7,(IX+00FH)	;DPB_0F_BPS
EC0D C8             	RET	Z		;予備FATが無い
EC0E CD 24 EC       	CALL	FATS2
EC11 E5             	PUSH	HL		;予備FAT
EC12 DD 6E 00       	LD	L,(IX+0)	;DPB_00_FATLN
EC15 DD 66 01       	LD	H,(IX+1)
EC18 19             	ADD	HL,DE
EC19 EB             	EX	DE,HL
EC1A E1             	POP	HL
EC1B 18 DA          	JR	DWT24B
EC1D                ;------------------------
EC1D                ;FATのセットアップ
EC1D                ;out
EC1D                ;	B  : FATセクタ数
EC1D                ;	DE : FAT先頭セクタ番号
EC1D                ;	HL : FATバッファポインタ
EC1D                ;	CF : 1=ドライブ切り替えエラー
EC1D                ;note
EC1D                ;	FATサイズがFATバッファを超える場合は
EC1D                ;	対象クラスタ領域==(_FATIX)によって
EC1D                ;	FAT12:対象クラスタ1024毎に1.5KBを切り替える
EC1D                ;	FAT16:対象クラスタ1024毎に2KBを切り替える
EC1D                ;------------------------
EC1D                FATSETUP:
EC1D 3A AA EF       	LD	A,(_FATDRV)
EC20 CD 2C ED       	CALL	CHGDRVR		;ドライブ切り替え
EC23 D8             	RET	C
EC24                FATS2:
EC24 DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS 512=2 1024=4
EC27 0F             	RRCA
EC28 CD 51 EC       FATSX:	CALL	FATSETUP12	;自己書き換え
EC2B 21 00 00       	LD	HL,0
EC2E 4A             	LD	C,D
EC2F 54             	LD	D,H
EC30 3A AB EF       	LD	A,(_FATIX)	;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
EC33 47             	LD	B,A
EC34 04             	INC	B
EC35 DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
EC38                FAT_SKP:
EC38 05             	DEC	B
EC39 28 05          	JR	Z,FAT1
EC3B 19             	ADD	HL,DE
EC3C 93             	SUB	E
EC3D 30 F9          	JR	NC,FAT_SKP
EC3F C9             	RET
EC40                FAT1:
EC40 EB             	EX	DE,HL
EC41 B9             	CP	C		;C=FATバッファに読み込めるセクタ数
EC42 38 01          	JR	C,FAT2
EC44 79             	LD	A,C
EC45                FAT2:
EC45 47             	LD	B,A
EC46                
EC46 2A FA F0       	LD	HL,(_FATPS)	;fat sector pos
EC49 19             	ADD	HL,DE
EC4A EB             	EX	DE,HL
EC4B 2A 7C F0       	LD	HL,(_FATBF)
EC4E AF             	XOR	A		;CF=0
EC4F 4F             	LD	C,A
EC50 C9             	RET
EC51                ;
EC51                ;	FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
EC51                ;	FATSETUP* (FAT12/FAT16)
EC51                ;out
EC51                ;	D : FATバッファに読み込める最大のセクタ数
EC51                ;	E : _FATIXで進めるセクタ数
EC51                FATSETUP12:
EC51 11 06 06       	LD	DE,0606H	;256
EC54 D8             	RET	C
EC55 11 03 03       	LD	DE,0303H	;512
EC58 0F             	RRCA
EC59 D8             	RET	C
EC5A 11 01 02       	LD	DE,0201H	;1024
EC5D C9             	RET
EC5E                
EC5E                FATSETUP16:
EC5E 11 08 08       	LD	DE,0808H	;256
EC61 D8             	RET	C
EC62 11 04 04       	LD	DE,0404H
EC65 0F             	RRCA			;512
EC66 D8             	RET	C
EC67 11 02 02       	LD	DE,0202H	;1024
EC6A C9             	RET
EC6B                
EC6B                CHGDRV:
EC6B E5             	PUSH	HL
EC6C 21 89 EF       	LD	HL,_DSK
EC6F BE             	CP	(HL)
EC70 28 0A          	JR	Z,CHGDRVE
EC72                CHGDRV1:
EC72 DD E5          	PUSH	IX
EC74 CD 7E EC       	CALL	CHGDRV0
EC77 3A 89 EF       	LD	A,(_DSK)
EC7A DD E1          	POP	IX
EC7C                CHGDRVE:
EC7C E1             	POP	HL
EC7D C9             	RET
EC7E                
EC7E                CHGDRV0:
EC7E 6F             	LD	L,A
EC7F CD DC EF       	CALL	_GETDPB
EC82 D8             	RET	C
EC83 DD 22 A8 EF    	LD	(_DPB),IX
EC87 7D             	LD	A,L
EC88 32 89 EF       	LD	(_DSK),A
EC8B                CHGDRV2:
EC8B C5             	PUSH	BC
EC8C D5             	PUSH	DE
EC8D ED 73 E2 EC    	LD	(SPPAT2+1),SP
EC91 F3             	DI
EC92 DD F9          	LD	SP,IX
EC94                
EC94 E1             	POP	HL		;DPB_00_FATLN
EC95 E1             	POP	HL		;DPB_02_DRD
EC96 22 EE EB       	LD	(DRDPAT+1),HL
EC99                
EC99 E1             	POP	HL
EC9A 22 FE EB       	LD	(DWTPAT+1),HL	;DPB_04_DWT
EC9D                
EC9D E1             	POP	HL		;L=DPB_06_FATID H=DPB_07_SECPCL
EC9E 7C             	LD	A,H
EC9F 32 F8 E2       	LD	(SPCPAT+1),A	;1クラスタの論理セクタ数
ECA2 3D             	DEC	A
ECA3 32 88 EA       	LD	(NCPAT+1),A
ECA6                
ECA6 E1             	POP	HL		;DPB_08_MAXCL
ECA7 7D             	LD	A,L
ECA8 32 17 E3       	LD	(CLPAT2+1),A
ECAB 7C             	LD	A,H
ECAC 32 13 E3       	LD	(CLPAT1+1),A
ECAF 2B             	DEC	HL
ECB0 22 1B E5       	LD	(MAXCLP+1),HL
ECB3                
ECB3 E1             	POP	HL		;L=DPB_0A_FDMODE H=DPB_0B_DIRSCNT
ECB4 7D             	LD	A,L
ECB5 F6 FE          	OR	0FEH
ECB7 32 E2 ED       	LD	(FDMODE+1),A
ECBA 07             	RLCA
ECBB E6 03          	AND	3
ECBD 32 CA ED       	LD	(FSPAT+1),A
ECC0 4C             	LD	C,H
ECC1                
ECC1 E1             	POP	HL		;L=DPB_0C_MAXCYL H=DPB_0D_MAXSEC
ECC2                
ECC2 E1             	POP	HL		;L=DPB_0E_FATPS H=DPB_0F_BPS
ECC3 7C             	LD	A,H		;DPB_0F_BPS
ECC4 E6 07          	AND	7
ECC6 32 16 E8       	LD	(SECSZ+2),A	;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
ECC9                				;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
ECC9                				;1セクタ1024 2HD/2HDE98
ECC9                				;1セクタ256 GRAM/RAMF/CMOS/等
ECC9                				;1024	512	256
ECC9                				;4	2	1
ECC9 87             	ADD	A,A		;8	4	2
ECCA 87             	ADD	A,A		;010H	8	4
ECCB 87             	ADD	A,A		;020H	010H	8
ECCC 32 74 E1       	LD	(SDECPAT+1),A	;1セクタ辺りのディレクトリエントリ数
ECCF                
ECCF 26 00          	LD	H,0
ECD1 22 FA F0       	LD	(_FATPS),HL
ECD4                
ECD4 E1             	POP	HL		;DPB_10_DIRPS
ECD5 22 FC F0       	LD	(_DIRPS),HL
ECD8                
ECD8 E1             	POP	HL		;L=DPB_12_DEVICE H=DPB_13_UNITNO
ECD9 7C             	LD	A,H
ECDA 32 84 EF       	LD	(_DRIVE),A
ECDD                
ECDD E1             	POP	HL		;DPB_14_ADDCL16
ECDE 22 08 E3       	LD	(CLSPAT+1),HL
ECE1                
ECE1 31 00 00       SPPAT2:	LD	SP,0		;元のSPを復元
ECE4 FB             	EI
ECE5 2A FC F0       	LD	HL,(_DIRPS)
ECE8 06 00          	LD	B,0
ECEA 09             	ADD	HL,BC		;C=DPB_0B_DIRSCNT
ECEB 22 8F E1       	LD	(MD_PAT+1),HL
ECEE                
ECEE 2A 1B E5       	LD	HL,(MAXCLP+1);
ECF1 11 F6 0F       	LD	DE,4086		;クラスタ数が4086未満:FAT12 4086以上:FAT16
ECF4 ED 52          	SBC	HL,DE		;CF=0のはず
ECF6 30 0F          	JR	NC,SETFAT16
ECF8 21 0E EA       	LD	HL,GNCL		;FAT12
ECFB 11 31 EA       	LD	DE,SNCL
ECFE 01 51 EC       	LD	BC,FATSETUP12
ED01 DD CB 0F AE    	RES	5,(IX+00FH)	;DPB_0F_BPS(FAT12)
ED05 18 0D          	JR	EXTRA1
ED07                SETFAT16:
ED07 21 65 EA       	LD	HL,GNCL16	;FAT16
ED0A 11 72 EA       	LD	DE,SNCL16
ED0D 01 5E EC       	LD	BC,FATSETUP16
ED10 DD CB 0F EE    	SET	5,(IX+00FH)	;DPB_0F_BPS(FAT16)
ED14                EXTRA1:
ED14 22 F8 EF       	LD	(GNCPAT+1),HL
ED17 ED 53 FB EF    	LD	(SNCPAT+1),DE
ED1B ED 43 29 EC    	LD	(FATSX+1),BC
ED1F D1             	POP	DE
ED20 C1             	POP	BC
ED21 AF             	XOR	A
ED22 C9             	RET
ED23                
ED23                GETDPBD:
ED23 DD E3          	EX	(SP),IX
ED25 DD E5          	PUSH	IX
ED27 3A 88 EF       	LD	A,(_DRV)
ED2A 18 07          	JR	GETDPB1
ED2C                
ED2C                CHGDRVR:
ED2C CD D9 EF       	CALL	_CHGDRV
ED2F D8             	RET	C
ED30 3A 89 EF       	LD	A,(_DSK)
ED33                GETDPB1:
ED33 C3 DC EF       	JP	_GETDPB
ED36                
ED36                GETDPB:
ED36 FE 08          	CP	8
ED38 3F             	CCF
ED39 D8             	RET	C
ED3A 0F             	RRCA
ED3B 0F             	RRCA
ED3C 0F             	RRCA
ED3D DD             	DB	0DDH		;Z80未定義命令
ED3E 6F             	LD	L,A		;LD	IXL,A
ED3F DD             	DB	0DDH		;Z80未定義命令
ED40 26 F1          	LD	H,DEVICE/256	;LD	IXH,DEVICE/256
ED42 DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
ED45 A7             	AND	A		;CF=0の為
ED46 DD CB 0F 6E    	BIT	5,(IX+00FH)	;DPB_0F_BPS
ED4A C0             	RET	NZ		;FAT16
ED4B DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
ED4F C0             	RET	NZ		;BPB
ED50 FE 01          	CP	001H		;A=0 THEN CF=1
ED52 C9             	RET
ED53                
ED53                _SYS5F:
ED53 AF             	XOR	A
ED54                FFLUSH:
ED54 F5             	PUSH	AF
ED55 3E FF          	LD	A,0FFH
ED57 32 39 EF       	LD	(SFILE),A
ED5A CD 4C E9       	CALL	DWTX
ED5D 3E FF          	LD	A,0FFH
ED5F 32 A5 EF       	LD	(_DBDRV),A
ED62 CD 96 E9       	CALL	WTFATX
ED65 AF             	XOR	A
ED66 32 AB EF       	LD	(_FATIX),A
ED69 2F             	CPL			;0FFH
ED6A 32 AA EF       	LD	(_FATDRV),A
ED6D F1             	POP	AF
ED6E C9             	RET
ED6F                
ED6F                	INCLUDE	"X1DISK.ASM"
ED6F                
ED6F                ;	LSX-Dodgers DISK
ED6F                ;	X1/turbo/Z
ED6F                
ED6F                SEEK:
ED6F 06 10          	LD	B,16
ED71 DD 4E 0D       	LD	C,(IX+0DH)	;DPB_0D_MAXSEC
ED74 AF             	XOR	A
ED75 EB             	EX	DE,HL
ED76                DIV1:
ED76 29             	ADD	HL,HL
ED77 8F             	ADC	A,A
ED78 B9             	CP	C
ED79 38 02          	JR	C,DIV2
ED7B 91             	SUB	C
ED7C 2C             	INC	L
ED7D                DIV2:
ED7D 10 F7          	DJNZ	DIV1
ED7F                
ED7F 3C             	INC	A	;最小のセクタは１固定
ED80 55             	LD	D,L	;TRACK
ED81 5F             	LD	E,A	;SECTOR
ED82 CB 3A          	SRL	D	;CYLINDER
ED84 9F             	SBC	A,A
ED85 E6 10          	AND	010H	;SIDE
ED87 4F             	LD	C,A
ED88                
ED88 3A 84 EF       	LD	A,(_DRIVE)
ED8B FE 04          	CP	4
ED8D 3F             	CCF
ED8E D8             	RET	C
ED8F B1             	OR	C
ED90 32 0E EE       	LD	(MOPAT+1),A	;Motor off data
ED93 01 FC 0F       	LD	BC,00FFCH
ED96 F6 80          	OR	080H		;Motor on
ED98 ED 79          	OUT	(C),A
ED9A                
ED9A CD E0 ED       	CALL	SETMODE
ED9D D8             	RET	C
ED9E                
ED9E CD 23 EE       	CALL	DRIVE
EDA1 FE FF          	CP	0FFH		;A=0FFH Unknown CYLINDER
EDA3 CC 02 EE       	CALL	Z,FDCRES	;Restore
EDA6 0E F9          	LD	C,0F9H
EDA8 ED 79          	OUT	(C),A		;Currrent CYLINDER
EDAA 92             	SUB	D
EDAB C8             	RET	Z		;No seek
EDAC                
EDAC 3A 86 EF       	LD	A,(_ISEEK)
EDAF 4F             	LD	C,A
EDB0                
EDB0 DD 7E 0C       	LD	A,(IX+00CH)	;DPB_0C_MAXCYL
EDB3 3D             	DEC	A
EDB4 BA             	CP	D		;Over CYLINDER
EDB5 D8             	RET	C
EDB6                
EDB6 B9             	CP	C		;for Built-in 2DD
EDB7 38 03          	JR	C,SETM2
EDB9 78             	LD	A,B		;B=00FH
EDBA DB FE          	IN	A,(0FEH)		;2HD mode for 2DD seek
EDBC                SETM2:
EDBC 78             	LD	A,B
EDBD DB FD          	IN	A,(0FDH)		;MFM mode
EDBF                
EDBF 0E FB          	LD	C,0FBH
EDC1 ED 51          	OUT	(C),D
EDC3 72             	LD	(HL),D
EDC4 0E 18          	LD	C,018H		;Seek
EDC6                FDCCMD2:
EDC6 3A 85 EF       	LD	A,(_SEEKSP)
EDC9 E6 FF          FSPAT:	AND	0FFH
EDCB B1             	OR	C
EDCC                
EDCC                FDCCMD:
EDCC CD 19 EE       	CALL	COMSET
EDCF                
EDCF 3E 80          FDCPAT:	LD	A,080H		;FDC COMMAND(Self-modifying code)
EDD1 E6 20          	AND	020H		;Write data Write track
EDD3 3C             	INC	A
EDD4                
EDD4                SST:
EDD4 0E 00          	LD	C,0
EDD6                SST1:
EDD6 0D             	DEC	C		; 4
EDD7 20 FD          	JR	NZ,SST1		;12 * 256 / 4 = About 1ms
EDD9 3D             	DEC	A
EDDA 20 FA          	JR	NZ,SST1
EDDC                
EDDC 3C             	INC	A		;A=1
EDDD CD EB ED       	CALL	READY
EDE0                SETMODE:
EDE0 78             	LD	A,B		;B=00FH
EDE1 DB FF          FDMODE:	IN	A,(0FFH)	;Floppy mode(2D/2HD) (Self-modifying code)
EDE3                
EDE3 78             	LD	A,B
EDE4 DB FD          	IN	A,(0FDH)	;MFM mode
EDE6                
EDE6 CD 1D EE       	CALL	DELAY0		;Head select time
EDE9 3E 81          	LD	A,081H
EDEB                READY:
EDEB 32 F5 ED       	LD	(WAITA+1),A
EDEE E5             	PUSH	HL
EDEF 0E F8          	LD	C,0F8H
EDF1 61             	LD	H,C
EDF2                READY2:
EDF2 ED 78          	IN	A,(C)
EDF4 E6 81          WAITA:	AND	081H		;NOT READY,BUSY
EDF6 28 08          	JR	Z,READYE
EDF8 E3             	EX	(SP),HL		;wait 19clock
EDF9 E3             	EX	(SP),HL		; //
EDFA 2B             	DEC	HL
EDFB 7C             	LD	A,H
EDFC B5             	OR	L
EDFD 20 F3          	JR	NZ,READY2
EDFF 37             	SCF
EE00                READYE:
EE00 E1             	POP	HL
EE01 C9             	RET
EE02                
EE02                FDCRES:
EE02 36 00          	LD	(HL),0
EE04 0E 08          	LD	C,8
EE06 18 BE          	JR	FDCCMD2
EE08                
EE08                FDMOFF:
EE08 F5             	PUSH	AF
EE09 C5             	PUSH	BC
EE0A 01 FC 0F       	LD	BC,00FFCH	;Motor off
EE0D 3E 00          MOPAT:	LD	A,000H		;(Self-rewriting)
EE0F ED 79          	OUT	(C),A
EE11 C1             	POP	BC
EE12 F1             	POP	AF
EE13 C9             	RET
EE14                
EE14                SECSET:
EE14 01 FA 0F       	LD	BC,00FFAH
EE17 ED 59          	OUT	(C),E
EE19                COMSET:
EE19 0E F8          	LD	C,0F8H
EE1B ED 79          	OUT	(C),A
EE1D                DELAY0:
EE1D 3E 1A          	LD	A,26
EE1F                DELAY:
EE1F 3D             	DEC	A
EE20 20 FD          	JR	NZ,DELAY
EE22 C9             	RET
EE23                
EE23                DRIVE:
EE23 2A 84 EF       	LD	HL,(_DRIVE)
EE26 26 EF          	LD	H,_CYL0/256
EE28 CB FD          	SET	7,L
EE2A 7E             	LD	A,(HL)
EE2B C9             	RET
EE2C                
EE2C                RNF:
EE2C CD 23 EE       	CALL	DRIVE
EE2F 36 FF          	LD	(HL),0FFH
EE31 C9             	RET
EE32                
EE32 02             RETRY:	DB	2
EE33                
EE33                
EE33                ;	FLOPPY DISK DRIVER(DMA)
EE33                
EE33                
EE33                WTTRK:
EE33 06 01          	LD	B,1
EE35 3E F4          	LD	A,0F4H
EE37 18 02          	JR	WTTRK1
EE39                FDWT:
EE39 3E A0          	LD	A,0A0H
EE3B                WTTRK1:
EE3B 32 D0 ED       	LD	(FDCPAT+1),A
EE3E 3E 10          	LD	A,16
EE40 18 0C          	JR	DISK
EE42                
EE42                DISKOK:
EE42 06 01          FDCNT:	LD	B,1
EE44 10 0B          	DJNZ	DISK1
EE46 C9             	RET
EE47                
EE47                FDRD:
EE47 3E 80          	LD	A,080H
EE49 32 D0 ED       	LD	(FDCPAT+1),A
EE4C 3E 0E          	LD	A,14
EE4E                
EE4E                DISK:
EE4E 32 65 EE       	LD	(DMAPAT+1),A
EE51                DISK1:
EE51 78             	LD	A,B
EE52 32 43 EE       	LD	(FDCNT+1),A
EE55 22 BD EE       	LD	(DMAD+11),HL
EE58                DISKR:
EE58 3E 02          	LD	A,2		;Retry count
EE5A 32 32 EE       	LD	(RETRY),A
EE5D                DISK2:
EE5D D5             	PUSH	DE
EE5E CD 6F ED       	CALL	SEEK
EE61 38 43          	JR	C,ERRF
EE63 F3             	DI
EE64                
EE64 3E 0E          DMAPAT:	LD	A,14		;自己書き換え
EE66 21 B2 EE       	LD	HL,DMAD
EE69 CD 17 DF       	CALL	SETDMA
EE6C ED 49          	OUT	(C),C		;OUT 01F87H,087H WR6 イネーブル
EE6E 3A D0 ED       	LD	A,(FDCPAT+1)
EE71 C5             	PUSH	BC
EE72 CD 14 EE       	CALL	SECSET
EE75 2A BD EE       	LD	HL,(DMAHL)
EE78 23             	INC	HL
EE79 11 06 BB       	LD	DE,0BB06H	;READ DMA
EE7C                
EE7C 3E 03          	LD	A,3
EE7E CD EB ED       	CALL	READY
EE81 ED 78          	IN	A,(C)
EE83                
EE83 C1             	POP	BC
EE84 ED 51          	OUT	(C),D		;読み出しマスク設定
EE86 ED 59          	OUT	(C),E		;バイトカウンタ(LH)
EE88 ED 58          	IN	E,(C)
EE8A ED 50          	IN	D,(C)
EE8C 19             	ADD	HL,DE
EE8D D1             	POP	DE
EE8E 13             	INC	DE
EE8F FB             	EI
EE90 CD 08 EE       	CALL	FDMOFF
EE93 B7             	OR	A
EE94 28 AC          	JR	Z,DISKOK
EE96 1B             	DEC	DE
EE97 CB 67          	BIT	4,A
EE99 C4 2C EE       	CALL	NZ,RNF
EE9C                DISKE2:
EE9C 21 32 EE       	LD	HL,RETRY
EE9F 35             	DEC	(HL)
EEA0 20 BB          	JR	NZ,DISK2
EEA2 B7             	OR	A
EEA3 28 0A          	JR	Z,ERR
EEA5 D5             	PUSH	DE
EEA6                ERRF:
EEA6 D1             	POP	DE
EEA7                DELP:
EEA7 CD 2C EE       	CALL	RNF
EEAA CD 08 EE       	CALL	FDMOFF
EEAD 3E FF          	LD	A,0FFH
EEAF                ERR:
EEAF BF             	CP	A
EEB0 37             	SCF
EEB1 C9             	RET
EEB2                
EEB2                			;X1turbo DISK DMA
EEB2 C3             DMAD:	DB	0C3H	;WR6 リセット
EEB3 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
EEB4 FB 0F          	DW	00FFBH	;ポートA開始アドレス FDC データレジスタ
EEB6 FF FF          	DW	0FFFFH	;ブロック長(転送サイズ-1)
EEB8 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
EEB9 10             	DB	010H	;WR2 ポートBインクリメント
EEBA 80             	DB	080H	;WR3
EEBB 92             	DB	092H	;WR5 WAIT RDY:LOW
EEBC 8D             	DB	08DH	;WR4 バイト ポートB開始アドレス(LH)
EEBD 00 00          DMAHL:	DW	0	;ポートB開始アドレス
EEBF CF             	DB	0CFH	;WR6 ロード
EEC0 01             	DB	001H	;WR0 ポートB←ポートB 転送
EEC1 CF             	DB	0CFH	;WR6 ロード
EEC2                
EEC2                DMAE:
EEC2                
EEC2 00 00 1E 75    AT_R	EQU	WTTRK-AT_DWT
EEC2                AT_TABLE:
EEC2                
EEC2                	INCLUDE	"LDWORK.ASM"
EEC2                
EEC2                ;	LSX-Dodgers WORK0
EEC2                ;
EEC2                ;	CP/M互換BIOS
EEC2                ;	BOOT:アドレス下位1バイトが0になるように
EEC2                AT_WORK:
EEC2                	DS	WORKAD-AT_WORK
EF00                
EF00                CPM_BOOT:
EF00 C3 00 00       	JP	0
EF03                _SYS00:		;(BDOS)プログラム終了
EF03                CPM_WBOOT:
EF03 C3 09 D1       	JP	WBOOT1
EF06                CPM_CONST:
EF06 C3 C1 DB       	JP	CONSTX
EF09                _SYS07:		;(BDOS)コンソール直接入力
EF09                CPM_CONIN:
EF09 C3 68 DB       	JP	FLGET
EF0C                CPM_CONOUT:
EF0C C3 08 DE       	JP	CONOUT1
EF0F                
EF0F                DECBF:
EF0F                	DS	5
EF14 00             FDRV	DB	0
EF15                FNAME	DS	36
EF39                SFILE:	DS	33		;DRV FILENAME
EF5A                HLBUF:	DS	3		;Random record buffer
EF5D                
EF5D 00 00          LEFTX:	DW	0
EF5F 00 00          DTAX:	DW	0
EF61                
EF61                ZERO:
EF61                BEEPD:
EF61 00 8E 01 00    	DB	0,08EH,1,0,00BH,0,00CH,010H
EF65 0B 00 0C 10
EF69 07 3E 08 10    	DB	007H,03EH,008H,010H,00DH,0,0FFH
EF6D 0D 00 FF
EF70 00 00 EF 62    RTC_YY	EQU	BEEPD+1
EF70 00 00 EF 63    RTC_MW	EQU	BEEPD+2
EF70 00 00 EF 64    RTC_DD	EQU	BEEPD+3
EF70 00 00 EF 65    RTC_TT	EQU	BEEPD+4
EF70 00 00 EF 66    RTC_MM	EQU	BEEPD+5
EF70 00 00 EF 67    RTC_SS	EQU	BEEPD+6
EF70                
EF70 00             CHECK:	DB	0
EF71                
EF71 4F 4B 24       OK:	DB	"OK$"
EF74                	DS	5
EF79 45 72 72 6F    COMERM:	DB	"Error!$"
EF7D 72 21 24
EF80                ;	システムワークエリア
EF80                ;	_CYL0:アドレス下位1バイトが080Hになるように
EF80 FF             _CYL0:	DB	0FFH	;Cylinder
EF81 FF             _CYL1:	DB	0FFH	;Cylinder
EF82 FF             _CYL2:	DB	0FFH	;Cylinder
EF83 FF             _CYL3:	DB	0FFH	;Cylinder
EF84 00             _DRIVE:	DB	0	;unit number
EF85 00             _SEEKSP:DB	0	;Seek speed
EF86 FF             _ISEEK:	DB	0FFH	;
EF87 00             _DVSW:	DB	0
EF88 00             _DRV:	DB	0
EF89 FF             _DSK:	DB	0FFH
EF8A 80 00          _DTA:	DW	00080H
EF8C 00 00          _CTC:	DW	0
EF8E 00 00          _TXADR:	DW	0
EF90 00 00          _KEYPS:	DW	0
EF92 00 FF          _KEYD:	DW	0FF00H	;キーデータ
EF94 C2 10          _KEYSP:	DB	KEYSP_L,KEYSP_H	;オートリピートの速度
EF96 07             _COLORF:DB	COLORF	;色
EF97 18             _LINE:	DB	LINE
EF98                
EF98 00 00          _FCB:	DW	0	;SEARCH FILES
EF9A 00 00          _FBPS:	DW	0	;    //
EF9C 00 00          _FBAD:	DW	0	;    //
EF9E 00             _FBCNT:	DB	0	;    //
EF9F 00             _FILEN:	DB	0	;    //
EFA0 00             _DIRF:	DB	0	;bit7:ディレクトリ bit0-6:セクタインデックス
EFA1                	DS	1
EFA2 00             _WTFATF:DB	0	;FATバッファの更新フラグ
EFA3                	DS	1
EFA4 00             _WTDBF:	DB	0	;データバッファの更新フラグ
EFA5 FF             _DBDRV:	DB	0FFH	;データバッファにあるデータを読み込んだドライブ
EFA6 00 00          _DBSEC:	DW	0	;データバッファにあるデータを読み込んだセクタ番号
EFA8 00 00          _DPB:	DW	0
EFAA                _FATDRV:
EFAA FF             	DB	0FFH	;FATバッファに読み込んでいるドライブ
EFAB 00             _FATIX:	DB	0	;FATバッファに読み込んでいるインデックス
EFAC                _FAKEFREE:
EFAC 00 00          	DW	0	;偽の残量（FATサイズが大きくなると重くなるのでその対策）
EFAE                
EFAE                	DS	2
EFB0                
EFB0                CRTCD:	
EFB0 6F             	DB	06FH
EFB1                _WIDTH:	
EFB1 50             	DB	WIDTH
EFB2                TVRAMTOP:
EFB2 59 38          	DB	059H,038H
EFB4 1F 02          	DB	01FH,002H
EFB6                _LINE2:
EFB6 19             	DB	019H
EFB7                WKE4:
EFB7 1C             	DB	01CH
EFB8                WKE6:
EFB8 00             	DB	000H
EFB9                WK40:
EFB9 07             	DB	007H
EFBA                _PAGE_MINUS:
EFBA 80 F8          	DW	0-WIDTH*LINE
EFBC                _WIDTH_MINUS:
EFBC B0 FF          	DW	0-WIDTH
EFBE                WK30:
EFBE 0C             	DB	00CH
EFBF                WK31:
EFBF                WK1FD0:
EFBF 20             	DB	020H
EFC0                
EFC0 AC DA          CTC0:	DW	INTCTCE
EFC2 AC DA          CTC1:	DW	INTCTCE
EFC4 B4 DA          CTC2:	DW	INTCTC2
EFC6 AC DA          CTC3:	DW	INTCTCE
EFC8 8F DA          INTVEC:	DW	INT
EFCA                
EFCA                ;	LSX-Dodgers 独自BIOS
EFCA                
EFCA C3 ED DF       _INKEY:	JP	INKEY
EFCD C3 8F DC       _PRINT:	JP	PRINT
EFD0 C3 55 DF       _SCRN:	JP	SCRN
EFD3 C3 7F DF       _POS:	JP	POS
EFD6 C3 D1 DD       _LOC:	JP	LOC
EFD9                _CHGDRV:
EFD9 C3 6B EC       	JP	CHGDRV
EFDC                _GETDPB:
EFDC C3 36 ED       	JP	GETDPB
EFDF                _FFLUSH:
EFDF C3 54 ED       	JP	FFLUSH
EFE2                _RDFATX:
EFE2 C3 6C E9       	JP	RDFATX
EFE5 C3 94 EA       _RDFAT:	JP	RDFAT
EFE8 C3 33 EE       _WTTRK:	JP	WTTRK
EFEB C3 47 EE       _FDRD:	JP	FDRD
EFEE C3 39 EE       _FDWT:	JP	FDWT
EFF1                _BPB2DPB:
EFF1 C3 F9 EA       	JP	BPB2DPB
EFF4                	DS	3
EFF7                _GNCL:
EFF7 C3 0E EA       GNCPAT:	JP	GNCL		; self-modifying code
EFFA                _SNCL:
EFFA C3 31 EA       SNCPAT:	JP	SNCL		; self-modifying code
EFFD C3 75 D1       _COMANL:JP	COMANL
F000                
F000                _WE:
F000                	INCLUDE	"LDCALL.ASM"
F000                
F000                ;	LSX-Dodgers システムコール(BDOS)
F000                ;
F000                ;	LSX-Dodgers SYSTEM CALL
F000                ;	STABLE:アドレス下位1バイトが0になるように
F000                
F000                STABLE:
F000                ;0
F000 03 EF 3B DB    	DW	_SYS00,_SYS01,_SYS02,_SYS03
F004 47 DB A1 E1
F008 E7 D7 E7 D7    	DW	_SYS04,_SYS05,_SYS06,_SYS07
F00C 4C DB 09 EF
F010 54 DB E9 D7    	DW	_SYS08,_SYS09,_SYS0A,_SYS0B
F014 8D DB B9 DB
F018 FE D7 03 D8    	DW	_SYS0C,_SYS0D,_SYS0E,_SYS0F
F01C 12 D8 25 D8
F020                ;1
F020 79 D8 C0 D8    	DW	_SYS10,_SYS11,_SYS12,_SYS13
F024 09 D9 3F D9
F028 47 D9 5D D9    	DW	_SYS14,_SYS15,_SYS16,_SYS17
F02C 72 D9 6A D9
F030 B9 D9 BE D9    	DW	_SYS18,_SYS19,_SYS1A,_SYS1B
F034 C3 D9 C9 D9
F038 E7 D7 EF D9    	DW	_SYS1C,_SYS1D,_SYS1E,_SYS1F
F03C E7 D7 F3 D9
F040                ;2
F040 E7 D7 A9 D9    	DW	_SYS20,_SYS21,_SYS22,_SYS23
F044 B1 D9 FA D9
F048 20 DA E7 D7    	DW	_SYS24,_ERROR,_SYS26,_SYS27
F04C 29 E6 0E E7
F050 B1 D9 29 DA    	DW	_SYS28,_SYS5C,_SYS2A,_SYS2B
F054 CF DB A1 E1
F058 F2 DB A1 E1    	DW	_SYS2C,_SYS2D,_SYS2E,_SYS2F
F05C E7 D7 4C DA
F060                ;3
F060 46 DA E7 D7    	DW	_SYS30,_ERROR,_ERROR,_ERROR
F064 E7 D7 E7 D7
F068 E7 D7 E7 D7    	DW	_ERROR,_ERROR,_ERROR,_ERROR
F06C E7 D7 E7 D7
F070 E7 D7 A1 E1    	DW	_ERROR,_SYS39,_SYS3A,_SYS5A
F074 A1 E1 6D DA
F078                ;DOS2
F078 CA D7          	DW	_DOS2
F07A                
F07A                	DS	2
F07C 00 F2          _FATBF:	DW	FATBF
F07E 00 FA          _DTBUF:	DW	DTBUF
F080                
F080                ;	コントロールコードテーブル
F080                ;	CTRLTB:アドレス下位1バイトが080Hになるように
F080                
F080                CTRLTB:
F080 46 DD 46 DD    	DW	CTRL00,CTRL00,CTRL02,CTRL03	;  A,B,C
F084 82 DD C9 DE
F088 C3 DE A6 DD    	DW	CTRL04,CTRL05,CTRL06,CTRL07	;D,E,F,G
F08C A2 DE 29 DE
F090 52 DD 73 DD    	DW	CTRL08,CTRL09,CTRL0A,CTRL0B	;H,I,J,K
F094 CC DE E7 DD
F098 9F DE CC DD    	DW	CTRL0C,CTRL0D,CTRL0E,CTRL00	;L,M,N,O
F09C E1 DE 46 DD
F0A0 46 DD 46 DD    	DW	CTRL00,CTRL00,CTRL12,CTRL00	;P,Q,R,S
F0A4 DF DD 46 DD
F0A8 46 DD 46 DD    	DW	CTRL00,CTRL00,CTRL00,CTRL00	;T,U,V,W
F0AC 46 DD 46 DD
F0B0 46 DD 46 DD    	DW	CTRL00,CTRL00,CTRL0C,CTRL1B	;X,Y,Z,ESC
F0B4 9F DE EE DD
F0B8 6D DD 59 DD    	DW	CTRL1C,CTRL1D,CTRL1E,CTRL1F	;→,←,↑,↓
F0BC 62 DD CC DE
F0C0                
F0C0                	DS	02AH
F0EA                
F0EA 16 17          SDDATA:	DB	22,23		;(FCB)ファイルを最後に変更した時刻
F0EC 14 15          	DB	20,21		;(FCB)ファイルを最後に変更した日付
F0EE 1A 1B          	DB	26,27		;(FCB)ファイルの先頭クラスタ
F0F0 10 11 12 13    	DB	16,17,18,19	;(FCB)ファイルのサイズ(バイト単位)
F0F4                SDDATAE:
F0F4                
F0F4                SCDIR:	DS	2		;+14 +15
F0F6                SFBPS:	DS	2		;FBPS
F0F8                SFNDF:	DS	2		;FILEN DIRF
F0FA                
F0FA 00 00          _FATPS:	DW	0
F0FC 00 00          _DIRPS:	DW	0
F0FE 00 00          _CLPS:	DW	0
F100                
F100                _PE:
F100                	INCLUDE	"X1DPB.ASM"
F100                
F100                ;	LSX-Dodgers DPB
F100                ;	X1/turbo/Z
F100                
F100                DEVICE:
F100                
F100                ;	A:
F100                
F100 02 00          	DW	2	;DPB_00_FATLN
F102 EB EF          	DW	_FDRD	;DPB_02_DRD
F104 EE EF          	DW	_FDWT	;DPB_04_DWT
F106 FD             	DB	0FDH	;DPB_06_FATID
F107 02             	DB	2	;DPB_07_SECPCL
F108 64 01          	DW	356	;DPB_08_MAXCL
F10A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F10B 07             	DB	7	;DPB_0B_DIRSCNT
F10C 28             	DB	40	;DPB_0C_MAXCYL
F10D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F10E 01             	DB	1	;DPB_0E_FATPS
F10F 82             	DB	082H	;DPB_0F_BPS
F110 05 00          	DW	5	;DPB_10_DIRPS
F112 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F113 00             	DB	0	;DPB_13_UNITNO
F114 08 00          	DW	8	;DPB_14_ADDCL16
F116 00 00          	DW	0	;DPB_16
F118 00 00          	DW	0	;DPB_18
F11A 00 00          	DW	0	;DPB_1A_SDIR
F11C 46 44 44 30    	DB	"FDD0"	;DPB_1C_NAME
F120                
F120                ;	B:
F120                
F120 02 00          	DW	2	;DPB_00_FATLN
F122 EB EF          	DW	_FDRD	;DPB_02_DRD
F124 EE EF          	DW	_FDWT	;DPB_04_DWT
F126 FD             	DB	0FDH	;DPB_06_FATID
F127 02             	DB	2	;DPB_07_SECPCL
F128 64 01          	DW	356	;DPB_08_MAXCL
F12A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F12B 07             	DB	7	;DPB_0B_DIRSCNT
F12C 28             	DB	40	;DPB_0C_MAXCYL
F12D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F12E 01             	DB	1	;DPB_0E_FATPS
F12F 82             	DB	082H	;DPB_0F_BPS
F130 05 00          	DW	5	;DPB_10_DIRPS
F132 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F133 01             	DB	1	;DPB_13_UNITNO
F134 08 00          	DW	8	;DPB_14_ADDCL16
F136 00 00          	DW	0	;DPB_16
F138 00 00          	DW	0	;DPB_18
F13A 00 00          	DW	0	;DPB_1A_SDIR
F13C 46 44 44 31    	DB	"FDD1"	;DPB_1C_NAME
F140                
F140                ;	C:
F140                
F140 02 00          	DW	2	;DPB_00_FATLN
F142 EB EF          	DW	_FDRD	;DPB_02_DRD
F144 EE EF          	DW	_FDWT	;DPB_04_DWT
F146 FD             	DB	0FDH	;DPB_06_FATID
F147 02             	DB	2	;DPB_07_SECPCL
F148 64 01          	DW	356	;DPB_08_MAXCL
F14A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F14B 07             	DB	7	;DPB_0B_DIRSCNT
F14C 28             	DB	40	;DPB_0C_MAXCYL
F14D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F14E 01             	DB	1	;DPB_0E_FATPS
F14F 82             	DB	082H	;DPB_0F_BPS
F150 05 00          	DW	5	;DPB_10_DIRPS
F152 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F153 02             	DB	2	;DPB_13_UNITNO
F154 08 00          	DW	8	;DPB_14_ADDCL16
F156 00 00          	DW	0	;DPB_16
F158 00 00          	DW	0	;DPB_18
F15A 00 00          	DW	0	;DPB_1A_SDIR
F15C 46 44 44 32    	DB	"FDD2"	;DPB_1C_NAME
F160                
F160                ;	D:
F160                
F160 02 00          	DW	2	;DPB_00_FATLN
F162 EB EF          	DW	_FDRD	;DPB_02_DRD
F164 EE EF          	DW	_FDWT	;DPB_04_DWT
F166 FD             	DB	0FDH	;DPB_06_FATID
F167 02             	DB	2	;DPB_07_SECPCL
F168 64 01          	DW	356	;DPB_08_MAXCL
F16A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F16B 07             	DB	7	;DPB_0B_DIRSCNT
F16C 28             	DB	40	;DPB_0C_MAXCYL
F16D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F16E 01             	DB	1	;DPB_0E_FATPS
F16F 82             	DB	082H	;DPB_0F_BPS
F170 05 00          	DW	5	;DPB_10_DIRPS
F172 A7             	DB	0A7H	;DPB_12_DEVICE
F173 03             	DB	3	;DPB_13_UNITNO
F174 08 00          	DW	8	;DPB_14_ADDCL16
F176 00 00          	DW	0	;DPB_16
F178 00 00          	DW	0	;DPB_18
F17A 00 00          	DW	0	;DPB_1A_SDIR
F17C 46 44 44 33    	DB	"FDD3"	;DPB_1C_NAME
F180                
F180                ;	E:
F180                
F180 00 00          EMMFL:	DW	0	;DPB_00_FATLN
F182 70 D7          EMMRD:	DW	EDRD	;DPB_02_DRD
F184 6C D7          EMMWR:	DW	EDWT	;DPB_04_DWT
F186 FE             	DB	0FEH	;DPB_06_FATID
F187 02             	DB	2	;DPB_07_SECPCL
F188 00 00          EMMCL:	DW	0	;DPB_08_MAXCL
F18A 00             	DB	0	;DPB_0A_FDMODE
F18B 0C             	DB	12	;DPB_0B_DIRSCNT
F18C 00             	DB	0	;DPB_0C_MAXCYL
F18D 00             	DB	0	;DPB_0D_MAXSEC
F18E 02             	DB	2	;DPB_0E_FATPS
F18F 02             	DB	2	;DPB_0F_BPS
F190 0A 00          	DW	10	;DPB_10_DIRPS
F192 06             EMMDV:	DB	6	;DPB_12_DEVICE
F193 00             	DB	0	;DPB_13_UNITNO
F194 12 00          	DW	18	;DPB_14_ADDCL16
F196 00 00          	DW	0	;DPB_16
F198 00 00          	DW	0	;DPB_18
F19A 00 00          	DW	0	;DPB_1A_SDIR
F19C 45 4D 4D 30    	DB	"EMM0"	;DPB_1C_NAME
F1A0                
F1A0                ;	F:
F1A0                
F1A0 00 00          BANKFL:	DW	0	;DPB_00_FATLN
F1A2 04 D7          	DW	BDRD	;DPB_02_DRD
F1A4 00 D7          	DW	BDWT	;DPB_04_DWT
F1A6 F9             	DB	0F9H	;DPB_06_FATID
F1A7 02             	DB	2	;DPB_07_SECPCL
F1A8 00 00          BANKCL:	DW	0	;DPB_08_MAXCL
F1AA 00             	DB	0	;DPB_0A_FDMODE
F1AB 08             	DB	8	;DPB_0B_DIRSCNT
F1AC 00             	DB	0	;DPB_0C_MAXCYL
F1AD 01             	DB	1	;DPB_0D_MAXSEC
F1AE 00             	DB	0	;DPB_0E_FATPS
F1AF 02             	DB	2	;DPB_0F_BPS
F1B0 02 00          	DW	2	;DPB_10_DIRPS
F1B2 0B             BANKDV:	DB	00BH	;DPB_12_DEVICE
F1B3 00             	DB	0	;DPB_13_UNITNO
F1B4 06 00          	DW	6	;DPB_14_ADDCL16
F1B6 00 00          	DW	0	;DPB_16
F1B8 00 00          	DW	0	;DPB_18
F1BA 00 00          	DW	0	;DPB_1A_SDIR
F1BC 42 52 41 4D    	DB	"BRAM"	;DPB_1C_NAME
F1C0                
F1C0                ;	G:
F1C0                
F1C0 02 00          	DW	2	;DPB_00_FATLN
F1C2 C1 D6          	DW	GDRD	;DPB_02_DRD
F1C4 D8 D6          	DW	GDWT	;DPB_04_DWT
F1C6 FA             	DB	0FAH	;DPB_06_FATID
F1C7 01             	DB	1	;DPB_07_SECPCL
F1C8 B8 00          	DW	184	;DPB_08_MAXCL
F1CA 00             	DB	0	;DPB_0A_FDMODE
F1CB 07             	DB	7	;DPB_0B_DIRSCNT
F1CC 00             	DB	0	;DPB_0C_MAXCYL
F1CD 01             	DB	1	;DPB_0D_MAXSEC
F1CE 01             	DB	1	;DPB_0E_FATPS
F1CF 01             	DB	1	;DPB_0F_BPS
F1D0 03 00          	DW	3	;DPB_10_DIRPS
F1D2 05             	DB	5	;DPB_12_DEVICE
F1D3 01             	DB	1	;DPB_13_UNITNO
F1D4 08 00          	DW	8	;DPB_14_ADDCL16
F1D6 00 00          	DW	0	;DPB_16
F1D8 00 00          	DW	0	;DPB_18
F1DA 00 00          	DW	0	;DPB_1A_SDIR
F1DC 47 52 41 4D    	DB	"GRAM"	;DPB_1C_NAME
F1E0                
F1E0                ;	H:
F1E0                	DS	32-8
F1F8 00             	DB	0
F1F9                
F1F9                LAST_ADR:
F1F9                
F1F9                	END
F1F9                
