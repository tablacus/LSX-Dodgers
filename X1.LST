0000                ;	LSX-Dodgers for X1/turbo/Z
0000                ;	Programmed by
0000                ;	Gaku (Lovers/Tablacus)
0000                
0000                	INCLUDE	"X1DEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                ;	X1/turbo/Z
0000                
0000 00 00 00 00    MAC	EQU	0		;X1
0000 00 00 00 00    DEV EQU 0
0000                
0000 00 00 CB 00    RUN	EQU	0CB00H
0000 00 00 D1 06    BDOS	EQU	0D106H
0000 00 00 EF 00    WORKAD	EQU	0EF00H
0000 00 00 F2 00    FATBF	EQU	0F200H
0000 00 00 FA 00    DTBUF	EQU	0FA00H
0000 00 00 FE 00    KEYBF	EQU	0FE00H
0000 00 00 FF 00    KBUF	EQU	0FF00H
0000 00 00 FF CA    EXTSP	EQU	0FFCAH
0000 00 00 FF D9    TRAP38	EQU	0FFD9H
0000 00 00 00 50    WIDTH	EQU	80
0000 00 00 00 18    LINE	EQU	24
0000 00 00 00 07    COLORF	EQU	7
0000 00 00 00 09    COMS	EQU	9
0000                
0000                	INCLUDE	"LDDEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                
0000 00 00 00 01    VER_1   EQU	1
0000 00 00 00 04    VER_2   EQU	4
0000 00 00 00 09    VER_3   EQU	9
0000 00 00 1D 00    MACW	EQU	MAC + 01D00H	;機種フラグとLD判別フラグ
0000 00 00 00 00    MACD	EQU	MAC + DEV * 256	;機種フラグとデバイスフラグ
0000 00 00 01 49    VER	EQU	VER_1 * 256 + VER_2 * 16 + VER_3
0000                
0000 00 00 00 05    SYSTEM	EQU	00005H
0000 00 00 00 0F    JP_HL	EQU	0000FH
0000 00 00 00 5C    FCB1	EQU	0005CH
0000 00 00 00 6C    FCB2	EQU	0006CH
0000 00 00 00 5D    FCB1FN	EQU	FCB1+1
0000 00 00 00 6D    FCB2FN	EQU	FCB2+1
0000 00 00 00 80    DTA1	EQU	00080H
0000                
0000 00 00 FF CA    EXTBIO	EQU	0FFCAH
0000                
0000                
0000                	ORG	RUN-7
CAF9                
CAF9                ;	MSX BINARY HEADER
CAF9 FE             	DB	0FEH
CAFA                ;	MSX BINARY START ADDRESS
CAFA 00 CB          	DW	RUN
CAFC                ;	MSX BINARY END ADDRESS
CAFC F9 F1          	DW	LAST_ADR
CAFE                ;	MSX BINARY EXEC ADDRESS
CAFE 07 CB          	DW	START
CB00                
CB00                	INCLUDE	"X1INIT.ASM"
CB00                
CB00                ;	LSX-Dodgers INIT
CB00                ;	X1/turbo/Z
CB00                
CB00 C3 07 CB       	JP	START
CB03 00 1D          	DW	MACW
CB05 49 01          	DW	VER
CB07                
CB07                START:
CB07 F3             	DI
CB08 ED 5E          	IM	2
CB0A 31 CA FF       	LD	SP,EXTSP
CB0D CD 1B CB       	CALL	INIT		;NZならAUTOEXECを実行
CB10 21 00 00       	LD	HL,0
CB13 E5             	PUSH	HL
CB14 C8             	RET	Z
CB15 11 B2 CE       	LD	DE,AUTOD
CB18 C3 FD EF       	JP	_COMANL
CB1B                
CB1B                INIT:
CB1B 3E 1E          	LD	A,01EH
CB1D D3 00          	OUT	(0),A
CB1F                
CB1F 01 00 00       	LD	BC,0
CB22 ED 43 8C EF    	LD	(_CTC),BC
CB26 01 04 0A       	LD	BC,00A04H
CB29 CD 5C CE       	CALL	CHKCTC
CB2C 01 04 07       	LD	BC,00704H
CB2F CD 5C CE       	CALL	CHKCTC
CB32 01 A8 1F       	LD	BC,01FA8H
CB35 CD 5C CE       	CALL	CHKCTC
CB38 01 A0 1F       	LD	BC,01FA0H
CB3B CD 5C CE       	CALL	CHKCTC
CB3E                ;
CB3E                INISIO:
CB3E 01 91 1F       	LD	BC,01F91H	;INIT SIO
CB41 16 01          	LD	D,1
CB43 ED 51          	OUT	(C),D
CB45                
CB45 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB47 0E 93          	LD	C,093H
CB49 ED 51          	OUT	(C),D
CB4B ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB4D 0E 99          	LD	C,099H		;INIT SIO
CB4F 16 01          	LD	D,1
CB51 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB53 0E 9B          	LD	C,09BH
CB55 ED 51          	OUT	(C),D
CB57 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB59                
CB59 0E 80          	LD	C,080H		;INIT DMA
CB5B 21 06 C3       	LD	HL,0C306H
CB5E                INIDMA:
CB5E ED 61          	OUT	(C),H
CB60 2D             	DEC	L
CB61 20 FB          	JR	NZ,INIDMA
CB63                
CB63 3E E4          	LD	A,0E4H
CB65 CD 5E DE       	CALL	COMOUT
CB68 AF             	XOR	A
CB69 CD 38 DE       	CALL	OT49SB
CB6C                
CB6C 3E EF          	LD	A,INTVEC/256
CB6E ED 47          	LD	I,A
CB70                
CB70 ED 4B 8C EF    	LD	BC,(_CTC)
CB74 0D             	DEC	C
CB75 0D             	DEC	C
CB76                
CB76 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB78 3E C0          	LD	A,CTC0
CB7A ED 79          	OUT	(C),A
CB7C                
CB7C 0C             	INC	C
CB7D 3E 47          	LD	A,047H
CB7F ED 79          	OUT	(C),A
CB81 3E 0D          	LD	A,13		;Baudrate 9600-13
CB83 ED 79          	OUT	(C),A
CB85                
CB85 79             	LD	A,C
CB86 D6 10          	SUB	010H
CB88 4F             	LD	C,A
CB89                ;	LD	(SIOAD+1),BC
CB89                ;	LD	(SIOAD0+1),BC
CB89                ;	LD	(SIOAD1+1),BC
CB89                
CB89 21 02 CF       	LD	HL,SIODATA
CB8C                SINIT1:
CB8C 7E             	LD	A,(HL)
CB8D 23             	INC	HL
CB8E FE FF          	CP	0FFH
CB90 28 04          	JR	Z,SINIT2
CB92 ED 79          	OUT	(C),A
CB94 18 F6          	JR	SINIT1
CB96                SINIT2:
CB96 3E E4          	LD	A,0E4H
CB98 CD 5E DE       	CALL	COMOUT
CB9B 3E C8          	LD	A,INTVEC
CB9D CD 38 DE       	CALL	OT49SB
CBA0                ;
CBA0 01 C4 1F       	LD	BC,01FC4H
CBA3 3E 0C          	LD	A,00CH
CBA5 ED 79          	OUT	(C),A
CBA7                
CBA7 0E C0          	LD	C,0C0H
CBA9 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBAB                
CBAB 0C             	INC	C
CBAC 3E 28          	LD	A,40
CBAE ED 79          	OUT	(C),A
CBB0                
CBB0 0C             	INC	C
CBB1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBB3                
CBB3 0C             	INC	C
CBB4 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBB6                
CBB6 0E C5          	LD	C,0C5H
CBB8 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBBA                
CBBA                TEXT:
CBBA 0E B0          	LD	C,0B0H
CBBC 3E 80          	LD	A,080H
CBBE ED 79          	OUT	(C),A
CBC0 16 07          	LD	D,7
CBC2 0E B9          	LD	C,0B9H
CBC4 21 FB CE       	LD	HL,TEXTDT
CBC7                TEXT1:
CBC7 04             	INC	B
CBC8 ED A3          	OUTI
CBCA 0C             	INC	C
CBCB 15             	DEC	D
CBCC 20 F9          	JR	NZ,TEXT1
CBCE 01 B0 1F       	LD	BC,01FB0H
CBD1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBD3                
CBD3 0E C4          	LD	C,0C4H
CBD5 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBD7                
CBD7 01 01 1A       	LD	BC,01A01H
CBDA ED 78          	IN	A,(C)
CBDC E6 08          	AND	8
CBDE 28 09          	JR	Z,PRN
CBE0 0E 03          	LD	C,003H
CBE2 3E 0F          	LD	A,00FH
CBE4 ED 79          	OUT	(C),A
CBE6 01 04 0A       	LD	BC,00A04H
CBE9                PRN:
CBE9 21 00 00       	LD	HL,0
CBEC 06 5C          	LD	B,05CH
CBEE 3E FF          	LD	A,0FFH		;RST 38H
CBF0 CD B6 E0       	CALL	FILL_MEMORY
CBF3 06 A4          	LD	B,0A4H
CBF5 AF             	XOR	A
CBF6 CD B6 E0       	CALL	FILL_MEMORY
CBF9                
CBF9 3E C3          	LD	A,0C3H		;JP
CBFB 21 03 EF       	LD	HL,CPM_WBOOT
CBFE 32 00 00       	LD	(00000H),A
CC01 22 01 00       	LD	(00001H),HL	;IPL
CC04                
CC04 21 00 1D       	LD	HL,MACW	;3 bit7  DPB Compatible LA(1)
CC07 22 03 00       	LD	(00003H),HL	;  bit6-0 Machine X1(0)
CC0A                ;				;4 LSX-Dodgers(01DH)
CC0A 21 06 D1       	LD	HL,BDOS
CC0D 32 05 00       	LD	(00005H),A
CC10 22 06 00       	LD	(00006H),HL	;BDOS
CC13                
CC13 21 7E DA       	LD	HL,BIOS
CC16 22 19 00       	LD	(00019H),HL	;BIOS-ROM
CC19                
CC19 21 D9 FF       	LD	HL,TRAP38	;TRAP38
CC1C 32 38 00       	LD	(00038H),A
CC1F 22 39 00       	LD	(00039H),HL	;RST 038H
CC22                
CC22 3E EF          	LD	A,CPM_BOOT/256
CC24 32 0B 00       	LD	(0000BH),A
CC27                
CC27 3E E9          	LD	A,0E9H		;JP (HL)
CC29 32 0F 00       	LD	(0000FH),A
CC2C                
CC2C 3A 7D F0       	LD	A,(_FATBF+1)
CC2F 32 13 00       	LD	(00013H),A
CC32                
CC32 3A 7F F0       	LD	A,(_DTBUF+1)
CC35 32 17 00       	LD	(00017H),A
CC38                
CC38 3E FE          	LD	A,KEYBF/256
CC3A 32 1B 00       	LD	(0001BH),A
CC3D                
CC3D 3E FF          	LD	A,KBUF/256
CC3F 32 1F 00       	LD	(0001FH),A
CC42                
CC42 21 49 01       	LD	HL,VER
CC45 22 5A 00       	LD	(0005AH),HL
CC48                
CC48 3E E6          	LD	A,0E6H
CC4A CD 5E DE       	CALL	COMOUT
CC4D CD 43 DE       	CALL	IN49SB
CC50 F5             	PUSH	AF
CC51 CD 43 DE       	CALL	IN49SB
CC54 F1             	POP	AF
CC55 F5             	PUSH	AF
CC56 E6 12          	AND	012H
CC58 20 05          	JR	NZ,KEYR
CC5A 3E 01          	LD	A,1
CC5C 32 B2 CD       	LD	(KEYREP+1),A
CC5F                KEYR:
CC5F F1             	POP	AF
CC60 E6 03          	AND	3
CC62 28 0E          	JR	Z,NON
CC64                
CC64 01 D0 3F       	LD	BC,03FD0H
CC67 ED 49          	OUT	(C),C
CC69 3E 37          	LD	A,037H
CC6B D3 D0          	OUT	(0D0H),A
CC6D ED 78          	IN	A,(C)
CC6F B9             	CP	C
CC70 28 65          	JR	Z,TURBO
CC72                NON:
CC72 21 0E CF       	LD	HL,AT_SCR1
CC75 11 E8 DE       	LD	DE,SCR1
CC78 01 94 00       	LD	BC,SCRNE-SCR1	;転送先のサイズ確認用
CC7B 01 85 00       	LD	BC,AT_SCRE-AT_SCR1
CC7E ED B0          	LDIR
CC80                
CC80 21 93 CF       	LD	HL,AT_DWT
CC83 11 2B EE       	LD	DE,WTTRK
CC86 01 8F 00       	LD	BC,DMAE-WTTRK	;転送先のサイズ確認用
CC89 01 8E 00       	LD	BC,AT_CPUE-AT_DWT
CC8C ED B0          	LDIR
CC8E                
CC8E 21 21 D0       	LD	HL,AT_EDWT
CC91 11 69 D7       	LD	DE,EDWT
CC94 01 4B 00       	LD	BC,EMME-EDWT	;転送先のサイズ確認用
CC97 01 46 00       	LD	BC,AT_EMME-AT_EDWT
CC9A ED B0          	LDIR
CC9C                
CC9C 21 63 DF       	LD	HL,AT_WTTRK+AT_RS
CC9F 22 E9 EF       	LD	(_WTTRK+1),HL
CCA2 21 74 EE       	LD	HL,AT_DRD+AT_R
CCA5 22 EC EF       	LD	(_FDRD+1),HL
CCA8 21 2B EE       	LD	HL,AT_DWT+AT_R
CCAB 22 EF EF       	LD	(_FDWT+1),HL
CCAE 21 7D D7       	LD	HL,AT_EDRD+AT_RE
CCB1 22 82 F1       	LD	(EMMRD),HL
CCB4 21 69 D7       	LD	HL,AT_EDWT+AT_RE
CCB7 22 84 F1       	LD	(EMMWR),HL
CCBA 21 6A DF       	LD	HL,AT_SCRN+AT_RS
CCBD 22 D1 EF       	LD	(_SCRN+1),HL
CCC0                
CCC0 3E 27          	LD	A,027H			;ノンターボはMFM切り替えを行わない
CCC2 32 12 F1       	LD	(DEVICE+012H),A		;Aドライブ
CCC5 32 32 F1       	LD	(DEVICE+012H+32),A	;Bドライブ
CCC8 32 52 F1       	LD	(DEVICE+012H+32*2),A	;Cドライブ
CCCB 32 72 F1       	LD	(DEVICE+012H+32*3),A	;Dドライブ
CCCE                
CCCE 21 00 00       	LD	HL,0
CCD1 22 89 DE       	LD	(X1PAT),HL
CCD4 C3 60 CD       	JP	NOBANK
CCD7                
CCD7                TURBO:
CCD7 F3             	DI			;Check BIOS
CCD8 06 1D          	LD	B,01DH
CCDA ED 79          	OUT	(C),A		;BIOS ON
CCDC 3A 51 2F       	LD	A,(02F51H)
CCDF 04             	INC	B		;B=01EH
CCE0 ED 79          	OUT	(C),A		;BIOS OFF
CCE2 FB             	EI
CCE3 FE C9          	CP	0C9H
CCE5 28 02          	JR	Z,BIOSOK
CCE7 18 05          	JR	NOBIOS
CCE9                BIOSOK:
CCE9 3E C3          	LD	A,0C3H		;JP
CCEB 32 18 00       	LD	(00018H),A
CCEE                NOBIOS:
CCEE 3E 1F          	LD	A,01FH		;スタートポート
CCF0 DB F0          	IN	A,(0F0H)
CCF2 0F             	RRCA
CCF3 38 0B          	JR	C,CRT1
CCF5 21 EB CE       	LD	HL,_C8025H
CCF8 11 B0 EF       	LD	DE,CRTCD
CCFB 01 10 00       	LD	BC,16
CCFE ED B0          	LDIR
CD00                CRT1:
CD00 3E 1F          	LD	A,01FH		;スタートポート
CD02 DB F0          	IN	A,(0F0H)
CD04 CB 57          	BIT	2,A
CD06 28 18          	JR	Z,BANK
CD08                
CD08 AF             	XOR	A
CD09                TZ1:				;前面スイッチが2HDの場合はMFMモードを2HDにしておく
CD09 F5             	PUSH	AF
CD0A CD DC EF       	CALL	_GETDPB
CD0D DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
CD10 E6 8F          	AND	08FH
CD12 FE 87          	CP	087H		;フロッピーでMEM切り替えがON
CD14 20 04          	JR	NZ,TZ2
CD16 DD CB 0A 86    	RES	0,(IX+0AH)	;(DPB_0A_FDMODE)
CD1A                TZ2:
CD1A F1             	POP	AF
CD1B 3C             	INC	A
CD1C FE 08          	CP	8
CD1E 38 E9          	JR	C,TZ1
CD20                
CD20                BANK:
CD20 01 00 0B       	LD	BC,00B00H
CD23 21 00 7F       	LD	HL,07F00H
CD26 F3             	DI
CD27 ED 69          	OUT	(C),L
CD29 3A 00 00       	LD	A,(0)
CD2C FE EB          	CP	0EBH
CD2E 20 05          	JR	NZ,BANK1
CD30 3E 2B          	LD	A,02BH
CD32 32 B2 F1       	LD	(BANKDV),A
CD35                BANK1:
CD35 ED 69          	OUT	(C),L
CD37 5E             	LD	E,(HL)
CD38 7B             	LD	A,E
CD39 C6 A5          	ADD	A,0A5H
CD3B 77             	LD	(HL),A
CD3C BE             	CP	(HL)
CD3D 73             	LD	(HL),E
CD3E 20 05          	JR	NZ,BANK2
CD40 2C             	INC	L
CD41 CB 65          	BIT	4,L
CD43 28 F0          	JR	Z,BANK1
CD45                BANK2:
CD45 3E 10          	LD	A,010H
CD47 ED 79          	OUT	(C),A
CD49 7D             	LD	A,L
CD4A B7             	OR	A
CD4B 28 13          	JR	Z,NOBANK
CD4D 26 00          	LD	H,0
CD4F 29             	ADD	HL,HL	;*2
CD50 29             	ADD	HL,HL	;*4
CD51 29             	ADD	HL,HL	;*8
CD52 29             	ADD	HL,HL	;*16
CD53 29             	ADD	HL,HL	;*32
CD54 2B             	DEC	HL	;-1
CD55 2B             	DEC	HL	;-2
CD56 2B             	DEC	HL	;-3
CD57 22 A8 F1       	LD	(BANKCL),HL
CD5A CD A2 CE       	CALL	CALC_FATLN
CD5D 32 A0 F1       	LD	(BANKFL),A
CD60                NOBANK:
CD60                EMM:
CD60 DD 21 80 F1    	LD	IX,EMMFL
CD64 CD 53 CE       	CALL	EADR0
CD67 ED 78          	IN	A,(C)
CD69 F5             	PUSH	AF
CD6A                
CD6A 11 00 00       	LD	DE,0
CD6D                ECHECK1:
CD6D 13             	INC	DE
CD6E CD 37 CE       	CALL	EADR2
CD71 ED 60          	IN	H,(C)
CD73 CD 37 CE       	CALL	EADR2
CD76 7C             	LD	A,H
CD77 C6 E5          	ADD	A,0E5H
CD79 ED 79          	OUT	(C),A
CD7B 3C             	INC	A
CD7C CD 53 CE       	CALL	EADR0
CD7F ED 79          	OUT	(C),A
CD81 3D             	DEC	A
CD82 CD 37 CE       	CALL	EADR2
CD85 ED 68          	IN	L,(C)
CD87 CD 37 CE       	CALL	EADR2
CD8A ED 61          	OUT	(C),H
CD8C BD             	CP	L
CD8D 20 04          	JR	NZ,ECHECK2
CD8F CB 5A          	BIT	3,D
CD91 28 DA          	JR	Z,ECHECK1
CD93                ECHECK2:
CD93 CD 53 CE       	CALL	EADR0
CD96 F1             	POP	AF
CD97 ED 79          	OUT	(C),A
CD99 FE EB          	CP	0EBH
CD9B 20 05          	JR	NZ,EMM_BPB
CD9D 3E 26          	LD	A,026H
CD9F 32 92 F1       	LD	(EMMDV),A
CDA2                EMM_BPB:
CDA2 21 F7 FF       	LD	HL,0-9
CDA5 19             	ADD	HL,DE
CDA6 30 09          	JR	NC,NOEMM
CDA8 22 88 F1       	LD	(EMMCL),HL
CDAB CD A2 CE       	CALL	CALC_FATLN
CDAE 32 80 F1       	LD	(EMMFL),A
CDB1                NOEMM:
CDB1 3E 00          KEYREP:	LD	A,000H
CDB3 B7             	OR	A
CDB4 28 07          	JR	Z,KEYR1
CDB6 01 00 00       	LD	BC,0
CDB9 ED 43 8C EF    	LD	(_CTC),BC
CDBD                KEYR1:
CDBD CD 83 CE       	CALL	SETCRTC
CDC0 01 30 F8       	LD	BC,0-80*25
CDC3 2A BA EF       	LD	HL,(_PAGE_MINUS)
CDC6 ED 43 BA EF    	LD	(_PAGE_MINUS),BC
CDCA 1E 0C          	LD	E,00CH
CDCC CD CD EF       	CALL	_PRINT
CDCF 22 BA EF       	LD	(_PAGE_MINUS),HL
CDD2                
CDD2 21 BE CE       	LD	HL,INIMES
CDD5 CD F5 D7       	CALL	MSX
CDD8                
CDD8 3A 87 FF       	LD	A,(0FF87H)
CDDB FE 08          	CP	8
CDDD 30 1E          	JR	NC,INIT0
CDDF 5F             	LD	E,A
CDE0 C6 41          	ADD	A,'A'
CDE2 32 BB CE       	LD	(AUTODV),A
CDE5 0E 0E          	LD	C,00EH
CDE7 CD 05 00       	CALL	SYSTEM
CDEA 1C             	INC	E
CDEB 21 85 EF       	LD	HL,_SEEKSP	;Disk error Ignore
CDEE CB FE          	SET	7,(HL)
CDF0 0E 1B          	LD	C,01BH
CDF2 CD 05 00       	CALL	SYSTEM
CDF5                
CDF5 21 85 EF       	LD	HL,_SEEKSP
CDF8 CB BE          	RES	7,(HL)
CDFA                
CDFA 3C             	INC	A
CDFB 20 08          	JR	NZ,INIT1
CDFD                INIT0:
CDFD 1E 00          	LD	E,0
CDFF 0E 0E          	LD	C,00EH
CE01 CD 05 00       	CALL	SYSTEM
CE04 AF             	XOR	A
CE05                INIT1:
CE05 F3             	DI
CE06 08             	EX	AF,AF'
CE07 2E FE          	LD	L,0-2		;CALLのスタック分減らす
CE09 39             	ADD	HL,SP
CE0A 11 00 FF       	LD	DE,0FF00H
CE0D 45             	LD	B,L
CE0E CD E8 D4       	CALL	ZERO_MEMORY_DE
CE11 21 CA FF       	LD	HL,EXTSP
CE14 06 0F          	LD	B,TRAP38-EXTBIO
CE16 3E FF          	LD	A,0FFH		;RST 38H
CE18 CD B6 E0       	CALL	FILL_MEMORY
CE1B 21 67 D0       	LD	HL,AT_TRAP38
CE1E 11 D9 FF       	LD	DE,TRAP38
CE21 01 27 00       	LD	BC,AT_TRAPE-AT_TRAP38
CE24 ED B0          	LDIR
CE26 08             	EX	AF,AF'
CE27 B7             	OR	A
CE28 C8             	RET	Z
CE29                
CE29 3E E6          	LD	A,0E6H
CE2B CD 5E DE       	CALL	COMOUT
CE2E CD 43 DE       	CALL	IN49SB
CE31 CD 43 DE       	CALL	IN49SB
CE34 FE 1B          	CP	01BH
CE36 C9             	RET
CE37                
CE37                EADR2:
CE37 D5             	PUSH	DE
CE38 EB             	EX	DE,HL
CE39 29             	ADD	HL,HL
CE3A 29             	ADD	HL,HL
CE3B DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
CE3E DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
CE41 09             	ADD	HL,BC
CE42 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
CE45 06 0D          	LD	B,00DH
CE47 ED 49          	OUT	(C),C
CE49 0C             	INC	C
CE4A ED 69          	OUT	(C),L
CE4C 0C             	INC	C
CE4D ED 61          	OUT	(C),H
CE4F 0C             	INC	C
CE50 EB             	EX	DE,HL
CE51 D1             	POP	DE
CE52 C9             	RET
CE53                
CE53                EADR0:
CE53 D5             	PUSH	DE
CE54 11 00 00       	LD	DE,0
CE57 CD 37 CE       	CALL	EADR2
CE5A D1             	POP	DE
CE5B C9             	RET
CE5C                
CE5C                CHKCTC:
CE5C C5             	PUSH	BC
CE5D 11 03 47       	LD	DE,04703H
CE60                INICTC1:
CE60 0C             	INC	C
CE61 ED 51          	OUT	(C),D
CE63 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CE65 1D             	DEC	E
CE66 20 F8          	JR	NZ,INICTC1
CE68 C1             	POP	BC
CE69                
CE69 11 FA 07       	LD	DE,007FAH
CE6C ED 51          	OUT	(C),D
CE6E ED 59          	OUT	(C),E
CE70 ED 78          	IN	A,(C)
CE72 BB             	CP	E
CE73 C0             	RET	NZ
CE74 ED 51          	OUT	(C),D
CE76 ED 51          	OUT	(C),D
CE78 ED 78          	IN	A,(C)
CE7A BA             	CP	D
CE7B C0             	RET	NZ
CE7C 0C             	INC	C
CE7D 0C             	INC	C
CE7E ED 43 8C EF    	LD	(_CTC),BC
CE82 C9             	RET
CE83                
CE83                SETCRTC:
CE83 21 B0 EF       	LD	HL,CRTCD
CE86 AF             	XOR	A
CE87                SETCRT1:
CE87 01 00 18       	LD	BC,01800H
CE8A ED 79          	OUT	(C),A
CE8C 0C             	INC	C
CE8D 04             	INC	B
CE8E ED A3          	OUTI
CE90 3C             	INC	A
CE91 FE 0C          	CP	12
CE93 20 F2          	JR	NZ,SETCRT1
CE95 23             	INC	HL
CE96 23             	INC	HL
CE97 01 03 1B       	LD	BC,01A03H+00100H
CE9A ED A3          	OUTI
CE9C 01 D0 20       	LD	BC,01FD0H+00100H
CE9F ED A3          	OUTI
CEA1 C9             	RET
CEA2                
CEA2                CALC_FATLN:	;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
CEA2 5D             	LD	E,L
CEA3 54             	LD	D,H
CEA4 29             	ADD	HL,HL	;*2
CEA5 19             	ADD	HL,DE	;*3
CEA6 CB 3C          	SRL	H	;/2
CEA8 CB 1D          	RR	L	;1クラスタ辺り1.5バイト必要
CEAA 11 FF 01       	LD	DE,511	;切り上げる
CEAD 19             	ADD	HL,DE
CEAE 7C             	LD	A,H
CEAF CB 3F          	SRL	A
CEB1 C9             	RET
CEB2                
CEB2 41 55 54 4F    AUTOD:	DB	"AUTOEXEC "
CEB6 45 58 45 43
CEBA 20
CEBB 41 3A 00       AUTODV:	DB	"A:",0
CEBE                
CEBE 4C 53 58 2D    INIMES:	DB	"LSX-Dodgers for X1/turbo version "
CEC2 44 6F 64 67
CEC6 65 72 73 20
CECA 66 6F 72 20
CECE 58 31 2F 74
CED2 75 72 62 6F
CED6 20 76 65 72
CEDA 73 69 6F 6E
CEDE 20
CEDF 31 2E          	DB	030H + VER_1, '.'
CEE1 34 39          	DB	030H + VER_2 ,030H + VER_3
CEE3                ;	DB	"PR3"
CEE3 20 47 61 6B    	DB	' Gaku',0DH,0AH
CEE7 75 0D 0A
CEEA 00             	DB	0
CEEB                
CEEB                _C8025H:
CEEB 6B 50 59 88    	DB	06BH,050H,059H,088H,01BH,001H,019H,01AH
CEEF 1B 01 19 1A
CEF3 00 0F          	DB	000H,00FH
CEF5 80 F8 B0 FF    	DW	0-80*LINE,0-80
CEF9 0C 23          	DB	00CH,023H
CEFB                
CEFB 03 0C 0F 30    TEXTDT:	DB	003H,00CH,00FH,030H,033H,03CH,03FH
CEFF 33 3C 3F
CF02                
CF02                SIODATA:
CF02 18             	DB	018H
CF03 01 00          	DB	1,0
CF05 02 00          	DB	2,0
CF07 03 C1          	DB	3,0C1H
CF09 04 44          	DB	4,044H
CF0B 05 E8          	DB	5,0E8H
CF0D FF             	DB	0FFH
CF0E                
CF0E                ;	ノンターボ用パッチ
CF0E                
CF0E                AT_SCR1:
CF0E D9             	EXX
CF0F C5             	PUSH	BC
CF10 ED 4B B1 EF    	LD	BC,(_WIDTH)
CF14 06 20          	LD	B,020H
CF16 D9             	EXX
CF17 C5             	PUSH	BC
CF18 01 00 20       	LD	BC,02000H
CF1B                
CF1B 67             	LD	H,A
CF1C B7             	OR	A
CF1D                AT_SCRUP1:
CF1D 28 15          	JR	Z,AT_SCRCL
CF1F C5             	PUSH	BC
CF20 CB E0          	SET	4,B
CF22 D9             	EXX
CF23 C5             	PUSH	BC
CF24 CB E0          	SET	4,B
CF26 D9             	EXX
CF27 CD 19 DF       	CALL	AT_UPSUB+AT_RS
CF2A D9             	EXX
CF2B C1             	POP	BC
CF2C D9             	EXX
CF2D C1             	POP	BC
CF2E CD 19 DF       	CALL	AT_UPSUB+AT_RS
CF31 25             	DEC	H
CF32 18 E9          	JR	AT_SCRUP1
CF34                
CF34                AT_SCRCL:
CF34 2A B1 EF       	LD	HL,(_WIDTH)
CF37 CD AF DD       	CALL	LINECL
CF3A C1             	POP	BC
CF3B D9             	EXX
CF3C C1             	POP	BC
CF3D D9             	EXX
CF3E C9             	RET
CF3F                
CF3F                AT_UPSUB:
CF3F 3A B1 EF       	LD	A,(_WIDTH)
CF42 6F             	LD	L,A
CF43                AT_UPSUB1:
CF43 D9             	EXX
CF44 ED 78          	IN	A,(C)
CF46 03             	INC	BC
CF47 D9             	EXX
CF48 ED 79          	OUT	(C),A
CF4A 03             	INC	BC
CF4B 2D             	DEC	L
CF4C 20 F5          	JR	NZ,AT_UPSUB1
CF4E C9             	RET
CF4F                
CF4F                ;	FLOPPY DISK DRIVER(CPU)
CF4F                
CF4F                DISKC:
CF4F 1B             	DEC	DE
CF50 CB 5F          	BIT	3,A
CF52 C4 24 EE       	CALL	NZ,RNF
CF55                DISKD:
CF55 E5             	PUSH	HL
CF56 21 2A EE       	LD	HL,RETRY
CF59 35             	DEC	(HL)
CF5A E1             	POP	HL
CF5B 20 0C          	JR	NZ,AT_ERR		;Retry
CF5D B7             	OR	A
CF5E 28 09          	JR	Z,AT_ERR		;Error
CF60                
CF60                AT_DELP:
CF60 CD 24 EE       	CALL	RNF
CF63 CD 00 EE       	CALL	FDMOFF
CF66 3E FF          	LD	A,0FFH
CF68                AT_ERRZ:
CF68 BF             	CP	A
CF69                AT_ERR:
CF69 3E FF          	LD	A,0FFH
CF6B C9             	RET
CF6C                ERRW:
CF6C 3E FF          	LD	A,0FFH
CF6E BF             	CP	A
CF6F 37             	SCF
CF70 C3 00 EE       	JP	FDMOFF
CF73                
CF73                ERRDW:
CF73 D1             	POP	DE
CF74 CD 3A DF       	CALL	AT_DELP+AT_RS
CF77 C2 39 EE       	JP	NZ,DWT0+AT_R
CF7A B7             	OR	A
CF7B 20 EF          	JR	NZ,ERRW
CF7D C9             	RET
CF7E                
CF7E                ERRDR:
CF7E D1             	POP	DE
CF7F CD 3A DF       	CALL	AT_DELP+AT_RS
CF82 C2 82 EE       	JP	NZ,DRD0+AT_R
CF85 B7             	OR	A
CF86 20 E4          	JR	NZ,ERRW
CF88 C9             	RET
CF89                
CF89                AT_WTTRK:
CF89 06 01          	LD	B,1
CF8B 3E F4          	LD	A,0F4H
CF8D C3 2D EE       	JP	AT_WTTRK1+AT_R
CF90                
CF90                AT_SCRN:
CF90 ED 78          	IN	A,(C)
CF92 C9             	RET
CF93                AT_SCRE:
CF93                
CF93                AT_DWT:
CF93 3E A0          	LD	A,0A0H
CF95                AT_WTTRK1:
CF95 32 C8 ED       	LD	(FDCPAT+1),A
CF98                DWTBL:
CF98 78             	LD	A,B
CF99 32 70 EE       	LD	(AT_WTB+1+AT_R),A
CF9C 3E 02          	LD	A,2		;Retry count
CF9E 32 2A EE       	LD	(RETRY),A
CFA1                
CFA1                DWT0:
CFA1 D5             	PUSH	DE
CFA2 E5             	PUSH	HL
CFA3 CD 67 ED       	CALL	SEEK		;Write disk
CFA6 E1             	POP	HL
CFA7 DA 4D DF       	JP	C,ERRDW+AT_RS
CFAA F3             	DI
CFAB 3A C8 ED       	LD	A,(FDCPAT+1)
CFAE CD 0C EE       	CALL	SECSET
CFB1 0E FB          	LD	C,0FBH
CFB3                
CFB3                DWT1:
CFB3 56             	LD	D,(HL)
CFB4                DWT2:
CFB4 78             	LD	A,B
CFB5 DB F8          	IN	A,(0F8H)
CFB7 0F             	RRCA
CFB8 30 08          	JR	NC,DWT4
CFBA 0F             	RRCA
CFBB 30 F7          	JR	NC,DWT2
CFBD                DWT3:
CFBD ED 51          	OUT	(C),D
CFBF 23             	INC	HL
CFC0 18 F1          	JR	DWT1
CFC2                
CFC2                DWT4:
CFC2 3D             	DEC	A
CFC3 28 F8          	JR	Z,DWT3
CFC5 3C             	INC	A
CFC6 FB             	EI
CFC7 D1             	POP	DE
CFC8 13             	INC	DE
CFC9 CD 00 EE       	CALL	FDMOFF
CFCC 28 09          	JR	Z,DISKOK_WT
CFCE CD 29 DF       	CALL	DISKC+AT_RS
CFD1 20 CE          	JR	NZ,DWT0
CFD3 B7             	OR	A
CFD4 C2 46 DF       	JP	NZ,ERRW+AT_RS
CFD7                
CFD7                DISKOK_WT:
CFD7 06 01          AT_WTB:	LD	B,1
CFD9 10 BD          	DJNZ	DWTBL
CFDB C9             	RET
CFDC                
CFDC                AT_DRD:
CFDC 3E 80          	LD	A,080H
CFDE 32 C8 ED       	LD	(FDCPAT+1),A
CFE1                DRDBL:
CFE1 78             	LD	A,B
CFE2 32 B5 EE       	LD	(AT_RDB+1+AT_R),A
CFE5 3E 02          	LD	A,2		;Retry count
CFE7 32 2A EE       	LD	(RETRY),A
CFEA                DRD0:
CFEA D5             	PUSH	DE
CFEB E5             	PUSH	HL
CFEC CD 67 ED       	CALL	SEEK		;Read disk
CFEF E1             	POP	HL
CFF0 DA 58 DF       	JP	C,ERRDR+AT_RS
CFF3 F3             	DI
CFF4 3A C8 ED       	LD	A,(FDCPAT+1)
CFF7 CD 0C EE       	CALL	SECSET
CFFA 0E FB          	LD	C,0FBH
CFFC                DRD1:
CFFC 78             	LD	A,B
CFFD DB F8          	IN	A,(0F8H)
CFFF 0F             	RRCA
D000 30 08          	JR	NC,DRD3
D002 0F             	RRCA
D003 30 F7          	JR	NC,DRD1
D005 ED A2          	INI
D007 04             	INC	B
D008 18 F2          	JR	DRD1
D00A                
D00A                DRD3:
D00A B7             	OR	A
D00B FB             	EI
D00C D1             	POP	DE
D00D 13             	INC	DE
D00E CD 00 EE       	CALL	FDMOFF
D011 28 09          	JR	Z,DISKOK_RD
D013 CD 29 DF       	CALL	DISKC+AT_RS
D016 20 D2          	JR	NZ,DRD0
D018 B7             	OR	A
D019 C2 46 DF       	JP	NZ,ERRW+AT_RS
D01C                
D01C                DISKOK_RD:
D01C 06 01          AT_RDB:	LD	B,1
D01E 10 C1          	DJNZ	DRDBL
D020 C9             	RET
D021                
D021                AT_CPUE:
D021                
D021                
D021                ;	EMM DRIVER(CPU)
D021                
D021                
D021                AT_EDWT:
D021 CD 91 D7       	CALL	AT_EADR+AT_RE
D024                AT_EDWT0:
D024 F5             	PUSH	AF
D025 AF             	XOR	A
D026                AT_EDWT1:
D026 04             	INC	B
D027 ED A3          	OUTI
D029 04             	INC	B
D02A ED A3          	OUTI
D02C 3D             	DEC	A
D02D 20 F7          	JR	NZ,AT_EDWT1
D02F 13             	INC	DE
D030 F1             	POP	AF
D031 3D             	DEC	A
D032 20 F0          	JR	NZ,AT_EDWT0
D034 C9             	RET
D035                
D035                AT_EDRD:
D035 CD 91 D7       	CALL	AT_EADR+AT_RE
D038                AT_EDRD0:
D038 F5             	PUSH	AF
D039 AF             	XOR	A
D03A                AT_EDRD1:
D03A ED A2          	INI
D03C 04             	INC	B
D03D ED A2          	INI
D03F 04             	INC	B
D040 3D             	DEC	A
D041 20 F7          	JR	NZ,AT_EDRD1
D043 13             	INC	DE
D044 F1             	POP	AF
D045 3D             	DEC	A
D046 20 F0          	JR	NZ,AT_EDRD0
D048 C9             	RET
D049                
D049                AT_EADR:
D049 C5             	PUSH	BC
D04A D5             	PUSH	DE
D04B EB             	EX	DE,HL
D04C 29             	ADD	HL,HL
D04D DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
D050 DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
D053 09             	ADD	HL,BC
D054 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
D057 06 0D          	LD	B,00DH
D059 ED 49          	OUT	(C),C
D05B 0C             	INC	C
D05C ED 69          	OUT	(C),L
D05E 0C             	INC	C
D05F ED 61          	OUT	(C),H
D061 0C             	INC	C
D062 EB             	EX	DE,HL
D063 D1             	POP	DE
D064 F1             	POP	AF
D065 A7             	AND	A	;CF=0
D066 C9             	RET
D067                AT_EMME:
D067                
D067                AT_TRAP38:
D067 21 00 00       	LD	HL,0
D06A E3             	EX	(SP),HL
D06B 3E 24          	LD	A,'$'
D06D CD 3B DB       	CALL	MSG_A
D070 2B             	DEC	HL
D071 7C             	LD	A,H
D072 CD E8 FF       	CALL	PRHX+AT_RT
D075 7D             	LD	A,L
D076                PRHX:
D076 F5             	PUSH	AF
D077 07             	RLCA
D078 07             	RLCA
D079 07             	RLCA
D07A 07             	RLCA
D07B CD F1 FF       	CALL	PRHX2+AT_RT
D07E F1             	POP	AF
D07F                PRHX2:
D07F E6 0F          	AND	00FH
D081 FE 0A          	CP	10
D083 3F             	CCF
D084 CE 30          	ADC	A,'0'
D086 27             	DAA
D087 C3 3B DB       	JP	MSG_A
D08A                	DS	4
D08E                AT_TRAPE:
D08E                
D08E 00 00 2F 72    AT_RT	EQU	TRAP38-AT_TRAP38
D08E                
D08E                INITE:
D08E                	DS	BDOS-INITE
D106                
D106 C3 B4 D7       	JP	BDOS0
D109                	INCLUDE	"X1CCP.ASM"
D109                
D109                ;	LSX-Dodgers CCP
D109                ;	X1/turbo/Z
D109                
D109                WBOOT1:
D109 F3             	DI
D10A ED 7B 06 00    	LD	SP,(SYSTEM+1)
D10E                
D10E 3E EF          	LD	A,INTVEC/256
D110 ED 47          	LD	I,A
D112                
D112 3E E4          	LD	A,0E4H
D114 CD 5E DE       	CALL	COMOUT
D117 3E C8          	LD	A,INTVEC
D119 CD 38 DE       	CALL	OT49SB
D11C                
D11C 21 B0 EF       	LD	HL,CRTCD
D11F AF             	XOR	A
D120                SETCRT2:
D120 01 00 18       	LD	BC,01800H
D123 ED 79          	OUT	(C),A
D125 0C             	INC	C
D126 56             	LD	D,(HL)
D127 FE 0D          	CP	13
D129 38 02          	JR	C,SETCRT3
D12B 16 00          	LD	D,0
D12D                SETCRT3:
D12D ED 51          	OUT	(C),D
D12F 23             	INC	HL
D130 3C             	INC	A
D131 FE 0E          	CP	14
D133 20 EB          	JR	NZ,SETCRT2
D135                
D135 01 03 1B       	LD	BC,01A03H+00100H
D138 ED A3          	OUTI
D13A 01 D0 20       	LD	BC,01FD0H+00100H
D13D ED A3          	OUTI
D13F 21 92 EF       	LD	HL,_KEYD
D142 7E             	LD	A,(HL)
D143 36 00          	LD	(HL),0
D145 CD 28 DB       	CALL	KEYBC_IFBREAK
D148 3E 04          	LD	A,4
D14A CD 3B DB       	CALL	MSG_A
D14D                	INCLUDE	"LDCCP.ASM"
D14D                
D14D                ;	LSX-Dodgers CCP
D14D                
D14D                COMMAND:
D14D CD 00 D2       	CALL	SETDTA1
D150 3A 87 EF       	LD	A,(_DVSW)
D153 C6 41          	ADD	A,'A'
D155 CD 3B DB       	CALL	MSG_A
D158 3E 3E          	LD	A,'>'
D15A CD 3B DB       	CALL	MSG_A
D15D 3E 50          	LD	A,80
D15F 12             	LD	(DE),A
D160 CD 8A DB       	CALL	_SYS0A		;(BDOS)文字列入力
D163 CD AA D3       	CALL	LTNL
D166                
D166 11 82 00       	LD	DE,DTA1+2
D169 CD FD EF       	CALL	_COMANL
D16C 30 DF          	JR	NC,COMMAND
D16E 11 79 EF       	LD	DE,COMERM
D171 CD E6 D7       	CALL	_SYS09		;(BDOS)文字列出力
D174 C7             	RST	0
D175                
D175                COMANL:
D175 CD 0A E0       	CALL	FILE
D178 3A 19 EF       	LD	A,(FNAME+4)
D17B FE 20          	CP	020H
D17D 20 1C          	JR	NZ,COMB2
D17F D5             	PUSH	DE
D180 11 15 EF       	LD	DE,FNAME
D183 1A             	LD	A,(DE)
D184 FE 20          	CP	020H
D186 28 44          	JR	Z,SDVSW
D188 1B             	DEC	DE
D189 1A             	LD	A,(DE)
D18A C6 FF          	ADD	A,0FFH
D18C 38 09          	JR	C,COMB
D18E 13             	INC	DE
D18F                
D18F 21 8B D6       	LD	HL,COMTB
D192 06 09          	LD	B,COMS
D194 CD 8E E2       	CALL	CPNAME
D197                COMB:
D197 D1             	POP	DE
D198 D2 0F 00       	JP	NC,JP_HL
D19B                COMB2:
D19B EB             	EX	DE,HL
D19C 22 74 D2       	LD	(COMPAT+1),HL
D19F F5             	PUSH	AF
D1A0 CD 20 D2       	CALL	CEXE4
D1A3 F1             	POP	AF
D1A4 21 15 EF       	LD	HL,FNAME
D1A7 11 6D 00       	LD	DE,FCB2+1	;COMMAND NAME
D1AA 01 0B 00       	LD	BC,11
D1AD ED B0          	LDIR
D1AF 11 2E D6       	LD	DE,PATHD
D1B2                CEX1:
D1B2 1A             	LD	A,(DE)
D1B3 FE 20          	CP	020H
D1B5 D8             	RET	C
D1B6 CD FF DF       	CALL	FILEC
D1B9 D5             	PUSH	DE
D1BA 21 6D 00       	LD	HL,FCB2+1	;COMMAND NAME
D1BD 11 15 EF       	LD	DE,FNAME
D1C0 01 0B 00       	LD	BC,11
D1C3 ED B0          	LDIR
D1C5 CD 20 D2       	CALL	CEXE4
D1C8 D1             	POP	DE
D1C9 13             	INC	DE
D1CA 18 E6          	JR	CEX1
D1CC                
D1CC                SDVSW:
D1CC F1             	POP	AF
D1CD 3A 14 EF       	LD	A,(FDRV)
D1D0 3D             	DEC	A
D1D1 5F             	LD	E,A
D1D2 0E 0E          	LD	C,00EH		;(BDOS)カレントドライブの設定
D1D4 18 31          	JR	SYSTEM0
D1D6                
D1D6                OPEN1:
D1D6 21 14 EF       	LD	HL,FDRV
D1D9                OPEN:
D1D9 0E 11          	LD	C,011H		;(BDOS)ファイルの検索
D1DB                OPEN3:
D1DB D5             	PUSH	DE
D1DC 11 09 D6       	LD	DE,DTA_CCP
D1DF CD FD D1       	CALL	SETDTA
D1E2 EB             	EX	DE,HL
D1E3 CD 07 D2       	CALL	SYSTEM0
D1E6 D1             	POP	DE
D1E7 C9             	RET
D1E8                
D1E8                OPEN2:
D1E8 0E 12          	LD	C,012H
D1EA 18 EF          	JR	OPEN3
D1EC                
D1EC                DEFCB:				;Z=Ok NZ=Error
D1EC 11 09 D6       	LD	DE,DTA_CCP
D1EF CD 05 D2       	CALL	SYSC0F
D1F2                
D1F2 11 2A D6       	LD	DE,DTA_CCP+33	;(FCB)ランダムレコード
D1F5 06 04          	LD	B,4
D1F7 CD E8 D4       	CALL	ZERO_MEMORY_DE
D1FA 11 00 01       	LD	DE,00100H
D1FD                SETDTA:
D1FD C3 C0 D9       	JP	_SYS1A		;(BDOS)DTAの設定
D200                
D200                SETDTA1:
D200 11 80 00       	LD	DE,DTA1
D203 18 F8          	JR	SETDTA
D205                
D205                SYSC0F:
D205 0E 0F          	LD	C,00FH		;(BDOS)ファイルのオープン
D207                SYSTEM0:
D207 CD 05 00       	CALL	SYSTEM
D20A B7             	OR	A
D20B C9             	RET
D20C                
D20C                C_CD:
D20C 0E 5A          	LD	C,5AH
D20E 18 F7          	JR	SYSTEM0
D210                
D210                S27BUF:
D210 3A 07 00       	LD	A,(SYSTEM+2)
D213 3D             	DEC	A
D214 E6 F8          	AND	0F8H
D216 67             	LD	H,A
D217 2E 00          	LD	L,0
D219                S27DTA:
D219 11 09 D6       	LD	DE,DTA_CCP
D21C                S27:
D21C 0E 27          	LD	C,027H		;(BDOS)ランダムブロック読み込み
D21E 18 E7          	JR	SYSTEM0
D220                
D220                CEXE4:
D220 3A 14 EF       	LD	A,(FDRV)
D223 32 57 00       	LD	(00057H),A
D226 2A 22 EF       	LD	HL,(FDRV+14)
D229 22 58 00       	LD	(00058H),HL
D22C                
D22C 21 1D EF       	LD	HL,FNAME+8
D22F 7E             	LD	A,(HL)
D230 FE 20          	CP	020H
D232 20 07          	JR	NZ,CEXE7
D234 3E 3F          	LD	A,'?'
D236 77             	LD	(HL),A
D237 23             	INC	HL
D238 77             	LD	(HL),A
D239 23             	INC	HL
D23A 77             	LD	(HL),A
D23B                CEXE7:
D23B CD D6 D1       	CALL	OPEN1
D23E                CEXE5:
D23E C0             	RET	NZ
D23F 2A 13 D6       	LD	HL,(DTA_CCP+1+9)
D242 7C             	LD	A,H
D243 CD 16 E3       	CALL	CAP
D246 67             	LD	H,A
D247 7D             	LD	A,L
D248 CD 16 E3       	CALL	CAP
D24B 6F             	LD	L,A
D24C 3A 12 D6       	LD	A,(DTA_CCP+1+8)
D24F CD 16 E3       	CALL	CAP
D252 D6 42          	SUB	'B'
D254 28 2C          	JR	Z,C_BAT
D256 3D             	DEC	A		;'C'
D257 28 05          	JR	Z,C_EXE
D259                CEXE6:
D259 CD E8 D1       	CALL	OPEN2
D25C 18 E0          	JR	CEXE5
D25E                
D25E                C_EXE:
D25E 7C             	LD	A,H
D25F FE 4D          	CP	'M'
D261 20 F6          	JR	NZ,CEXE6
D263                
D263 CD EC D1       	CALL	DEFCB
D266 CD 10 D2       	CALL	S27BUF
D269 3D             	DEC	A
D26A 37             	SCF
D26B C0             	RET	NZ
D26C 7C             	LD	A,H
D26D B5             	OR	L
D26E 37             	SCF
D26F C8             	RET	Z
D270 CD 00 D2       	CALL	SETDTA1
D273 11 00 00       COMPAT:	LD	DE,0				; self-modifying code
D276 ED 7B 06 00    	LD	SP,(SYSTEM+1)
D27A 67             	LD	H,A				; A=0 in SETDTA1(_SYS1A)
D27B 6F             	LD	L,A
D27C E5             	PUSH	HL				; push $0000 (reboot address)
D27D 24             	INC	H
D27E E5             	PUSH	HL				; push $0100 (TPA address)
D27F C3 B3 D4       	JP	SETFCB				; and JP $0100
D282                
D282                C_BAT:
D282 11 41 54       	LD	DE,'A'+'T'*256
D285 ED 52          	SBC	HL,DE
D287 20 D0          	JR	NZ,CEXE6
D289                
D289 F1             	POP	AF
D28A F1             	POP	AF
D28B CD EC D1       	CALL	DEFCB
D28E 21 00 02       	LD	HL,00200H
D291 CD 19 D2       	CALL	S27DTA
D294 C6 FE          	ADD	A,0FEH
D296 D8             	RET	C
D297 7D             	LD	A,L
D298 B7             	OR	A
D299 37             	SCF
D29A C8             	RET	Z
D29B 3C             	INC	A
D29C F5             	PUSH	AF
D29D                
D29D CD 2B DB       	CALL	KEYBC
D2A0 3E 06          	LD	A,6
D2A2 CD 3B DB       	CALL	MSG_A
D2A5 C1             	POP	BC
D2A6 21 00 01       	LD	HL,00100H
D2A9                BAT1:
D2A9 A7             	AND	A
D2AA 05             	DEC	B
D2AB C8             	RET	Z
D2AC 7E             	LD	A,(HL)
D2AD FE 25          	CP	'%'
D2AF 28 0C          	JR	Z,BAT2
D2B1                BAT1X:
D2B1 7E             	LD	A,(HL)
D2B2 23             	INC	HL
D2B3 FE 1A          	CP	01AH
D2B5 C8             	RET	Z
D2B6 FE 0A          	CP	00AH
D2B8 C4 10 DB       	CALL	NZ,KEYBS
D2BB 18 EC          	JR	BAT1
D2BD                
D2BD                BAT2:
D2BD 23             	INC	HL
D2BE 7E             	LD	A,(HL)
D2BF 2B             	DEC	HL
D2C0 D6 31          	SUB	'1'
D2C2 38 ED          	JR	C,BAT1X
D2C4 FE 09          	CP	9
D2C6 30 E9          	JR	NC,BAT1X
D2C8 23             	INC	HL
D2C9 23             	INC	HL
D2CA 3C             	INC	A
D2CB 4F             	LD	C,A
D2CC ED 5B 74 D2    	LD	DE,(COMPAT+1)
D2D0                BAT3:
D2D0 1A             	LD	A,(DE)
D2D1 B7             	OR	A
D2D2 28 D5          	JR	Z,BAT1
D2D4 CD E1 E0       	CALL	SPCUT
D2D7 0D             	DEC	C
D2D8 28 08          	JR	Z,BAT5
D2DA                BAT4:
D2DA 1A             	LD	A,(DE)
D2DB FE 21          	CP	021H
D2DD 38 F1          	JR	C,BAT3
D2DF 13             	INC	DE
D2E0 18 F8          	JR	BAT4
D2E2                BAT5:
D2E2 1A             	LD	A,(DE)
D2E3 FE 21          	CP	021H
D2E5 38 C2          	JR	C,BAT1
D2E7 13             	INC	DE
D2E8 CD 10 DB       	CALL	KEYBS
D2EB 18 F5          	JR	BAT5
D2ED                
D2ED                C_DEL:
D2ED CD B3 D4       	CALL	SETFCB
D2F0 CD 51 DB       	CALL	_SYS08		;(BDOS)エコーなしコンソール入力
D2F3                
D2F3 0E 13          	LD	C,013H
D2F5 18 0A          	JR	CDEL1		;(BDOS)ファイルの削除
D2F7                
D2F7                C_REN:
D2F7 CD B3 D4       	CALL	SETFCB
D2FA 3E 10          	LD	A,010H		;ディレクトリも対象にする
D2FC 32 69 00       	LD	(FCB1+13),A	;属性
D2FF 0E 17          	LD	C,017H		;(BDOS)ファイル名の変更
D301                CDEL1:
D301 11 5C 00       	LD	DE,FCB1
D304 CD 05 00       	CALL	SYSTEM
D307 C6 FF          	ADD	A,0FFH
D309 C9             	RET
D30A                
D30A                C_DIR:
D30A CD FF DF       	CALL	FILEC
D30D 21 15 EF       	LD	HL,FDRV+1
D310 CD FE D5       	CALL	CWILD1
D313 3E F1          	LD	A,0F1H
D315 32 21 EF       	LD	(FDRV+13),A
D318 CD D6 D1       	CALL	OPEN1
D31B                CDIR1:
D31B B7             	OR	A
D31C 20 08          	JR	NZ,PDSKF
D31E CD 69 D3       	CALL	P_NAME
D321 CD E8 D1       	CALL	OPEN2
D324 18 F5          	JR	CDIR1
D326                
D326                PDSKF:
D326 3A 14 EF       	LD	A,(FDRV)
D329 5F             	LD	E,A
D32A 0E 1B          	LD	C,01BH		;(BDOS)ディスク情報の獲得
D32C CD 05 00       	CALL	SYSTEM
D32F 4F             	LD	C,A		;C←1クラスタ辺りの論理セクタ数
D330 C6 01          	ADD	A,001H
D332 D8             	RET	C		;Aが0FFHだった場合
D333 3E 06          	LD	A,8-2
D335                PDS1:				;HL=未使用クラスタの総数
D335 3C             	INC	A
D336 CB 19          	RR	C
D338 30 FB          	JR	NC,PDS1
D33A                PDS2:				;B←論理セクタのサイズの上位8ビット
D33A 3C             	INC	A
D33B CB 18          	RR	B
D33D 30 FB          	JR	NC,PDS2
D33F 47             	LD	B,A
D340                
D340 11 00 00       	LD	DE,0
D343                PDS3:
D343 29             	ADD	HL,HL
D344 EB             	EX	DE,HL
D345 ED 6A          	ADC	HL,HL
D347 EB             	EX	DE,HL
D348 10 F9          	DJNZ	PDS3
D34A                PDSKF1:
D34A CD E2 D3       	CALL	PRDEC_DEHL
D34D 11 6F D6       	LD	DE,FREE
D350 CD E6 D7       	CALL	_SYS09		;(BDOS)文字列出力
D353 CD D1 D3       	CALL	PUTDRV
D356 3E 5C          	LD	A,05CH		;\
D358 CD 3B DB       	CALL	MSG_A
D35B 2A 22 EF       	LD	HL,(FDRV+14)	;ディレクトリのクラスタ番号
D35E AF             	XOR	A
D35F 11 FE FF       	LD	DE,0-2
D362 19             	ADD	HL,DE
D363 23             	INC	HL
D364 DC DE D3       	CALL	C,PRDEC_HL
D367 18 41          	JR	LTNL
D369                
D369                P_NAME:
D369 3A 0A D6       	LD	A,(DTA_CCP+1)
D36C FE 2E          	CP	'.'
D36E C8             	RET	Z
D36F 11 87 D6       	LD	DE,DIRHD
D372 CD E6 D7       	CALL	_SYS09		;(BDOS)文字列出力
D375 3A 15 D6       	LD	A,(DTA_CCP+1+00BH)
D378 F5             	PUSH	AF
D379 0F             	RRCA
D37A 9F             	SBC	A,A
D37B E6 0A          	AND	'*'-020H
D37D C6 20          	ADD	A,020H
D37F CD 3B DB       	CALL	MSG_A
D382 CD D1 D3       	CALL	PUTDRV
D385 21 0A D6       	LD	HL,DTA_CCP+1
D388 CD 22 D4       	CALL	FPRNT
D38B                
D38B F1             	POP	AF
D38C CB 67          	BIT	4,A
D38E 28 08          	JR	Z,DIR3
D390 11 7C D6       	LD	DE,DIRMES
D393 CD E6 D7       	CALL	_SYS09		;(BDOS)文字列出力
D396 18 0A          	JR	DIR6
D398                DIR3:
D398 ED 5B 28 D6    	LD	DE,(DTA_CCP+1+01EH)
D39C 2A 26 D6       	LD	HL,(DTA_CCP+1+01CH)
D39F CD E2 D3       	CALL	PRDEC_DEHL
D3A2                DIR6:
D3A2 3A B1 EF       	LD	A,(_WIDTH)
D3A5 FE 29          	CP	40+1
D3A7 D4 44 D4       	CALL	NC,PRTTMS
D3AA                
D3AA                LTNL:
D3AA 1E 03          	LD	E,3
D3AC C3 CD EF       	JP	_PRINT
D3AF                
D3AF                C_PATH:
D3AF CD E1 E0       	CALL	SPCUT
D3B2 21 2E D6       	LD	HL,PATHD
D3B5 FE 21          	CP	021H
D3B7 30 0C          	JR	NC,CPATH0
D3B9                CPATHP:
D3B9 7E             	LD	A,(HL)
D3BA 23             	INC	HL
D3BB FE 20          	CP	020H
D3BD 3F             	CCF
D3BE 30 EA          	JR	NC,LTNL
D3C0 CD 3B DB       	CALL	MSG_A
D3C3 18 F4          	JR	CPATHP
D3C5                CPATH0:
D3C5 FE 3B          	CP	';'
D3C7 20 01          	JR	NZ,CPATH1
D3C9 13             	INC	DE
D3CA                CPATH1:
D3CA EB             	EX	DE,HL
D3CB 01 40 00       	LD	BC,PATHX
D3CE ED B0          	LDIR
D3D0 C9             	RET
D3D1                
D3D1                PUTDRV:
D3D1 3A 14 EF       	LD	A,(FDRV)
D3D4 C6 40          	ADD	A,'A'-1
D3D6 CD 3B DB       	CALL	MSG_A
D3D9 3E 3A          	LD	A,':'
D3DB                MSG_AR:
D3DB C3 3B DB       	JP	MSG_A
D3DE                
D3DE                PRDEC_HL:
D3DE AF             	XOR	A
D3DF                PRDEC_AHL:
D3DF 5F             	LD	E,A
D3E0 16 00          	LD	D,0
D3E2                PRDEC_DEHL:
D3E2 D5             	PUSH	DE
D3E3 11 0F EF       	LD	DE,DECBF
D3E6 06 05          	LD	B,5
D3E8 CD E8 D4       	CALL	ZERO_MEMORY_DE	;A=0
D3EB D1             	POP	DE
D3EC                
D3EC 0E 20          	LD	C,32
D3EE                DEC1:
D3EE 29             	ADD	HL,HL
D3EF EB             	EX	DE,HL
D3F0 ED 6A          	ADC	HL,HL
D3F2 EB             	EX	DE,HL
D3F3 E5             	PUSH	HL
D3F4 21 13 EF       	LD	HL,DECBF+4
D3F7 06 05          	LD	B,5
D3F9                DEC2:
D3F9 7E             	LD	A,(HL)
D3FA 8F             	ADC	A,A
D3FB 27             	DAA
D3FC 77             	LD	(HL),A
D3FD 2B             	DEC	HL
D3FE 10 F9          	DJNZ	DEC2
D400 E1             	POP	HL
D401 0D             	DEC	C
D402 20 EA          	JR	NZ,DEC1
D404                
D404 21 0F EF       	LD	HL,DECBF
D407 3E 20          	LD	A,020H
D409 06 04          	LD	B,4
D40B                DEC3:
D40B CD 18 D4       	CALL	DEC4
D40E CD 18 D4       	CALL	DEC4
D411 23             	INC	HL
D412 10 F7          	DJNZ	DEC3
D414                DECX:
D414 CD 18 D4       	CALL	DEC4
D417 AF             	XOR	A
D418                DEC4:
D418 ED 6F          	RLD
D41A FE 20          	CP	020H
D41C 28 02          	JR	Z,DEC5
D41E F6 30          	OR	030H
D420                DEC5:
D420 18 B9          	JR	MSG_AR
D422                
D422                FPRNT:
D422 06 08          	LD	B,8
D424 CD 35 D4       	CALL	P_N1
D427 7E             	LD	A,(HL)
D428 C6 80          	ADD	A,0A0H-020H
D42A FE A0          	CP	0A0H
D42C 28 02          	JR	Z,FPR1
D42E 3E 2E          	LD	A,'.'
D430                FPR1:
D430 CD 3B DB       	CALL	MSG_A
D433 06 03          	LD	B,3
D435                
D435                P_N1:
D435 C5             	PUSH	BC
D436 E5             	PUSH	HL
D437 7E             	LD	A,(HL)
D438 CD 22 E3       	CALL	CAP3
D43B CD 3B DB       	CALL	MSG_A
D43E E1             	POP	HL
D43F C1             	POP	BC
D440 23             	INC	HL
D441 10 F2          	DJNZ	P_N1
D443 C9             	RET
D444                
D444                PRTTMS:
D444 3E 20          	LD	A,020H
D446 CD 3B DB       	CALL	MSG_A
D449                
D449 2A 22 D6       	LD	HL,(DTA_CCP+1+24)
D44C 7D             	LD	A,L
D44D B7             	OR	A
D44E C8             	RET	Z
D44F CB 3C          	SRL	H
D451 17             	RLA
D452 17             	RLA
D453 17             	RLA
D454 17             	RLA
D455 E6 0F          	AND	00FH
D457 57             	LD	D,A
D458 7C             	LD	A,H
D459 C6 50          	ADD	A,80
D45B CD 9E D4       	CALL	PRDEC_A
D45E 3E 2D          	LD	A,'-'
D460 CD 3B DB       	CALL	MSG_A
D463 7A             	LD	A,D
D464 CD 9E D4       	CALL	PRDEC_A
D467 3E 2D          	LD	A,'-'
D469 CD 3B DB       	CALL	MSG_A
D46C 7D             	LD	A,L
D46D E6 1F          	AND	01FH
D46F CD 9E D4       	CALL	PRDEC_A
D472                
D472 2A 20 D6       	LD	HL,(DTA_CCP+1+22)
D475                
D475 3E 20          	LD	A,020H
D477 CD 3B DB       	CALL	MSG_A
D47A 7C             	LD	A,H
D47B 65             	LD	H,L
D47C 06 03          	LD	B,3
D47E                PRTTMS1:
D47E 1F             	RRA
D47F CB 1D          	RR	L
D481 10 FB          	DJNZ	PRTTMS1
D483 E6 1F          	AND	01FH
D485 CD 9E D4       	CALL	PRDEC_A
D488 3E 3A          	LD	A,':'
D48A CD 3B DB       	CALL	MSG_A
D48D 7D             	LD	A,L
D48E 0F             	RRCA
D48F 0F             	RRCA
D490 E6 3F          	AND	03FH
D492 CD 9E D4       	CALL	PRDEC_A
D495 3E 3A          	LD	A,':'
D497 CD 3B DB       	CALL	MSG_A
D49A 7C             	LD	A,H
D49B E6 1F          	AND	01FH
D49D 87             	ADD	A,A
D49E                
D49E                ;	PRINT10
D49E                
D49E                PRDEC_A:
D49E E5             	PUSH	HL
D49F 06 08          	LD	B,8
D4A1 4F             	LD	C,A
D4A2 AF             	XOR	A
D4A3                PRTA1:
D4A3 CB 01          	RLC	C
D4A5 8F             	ADC	A,A
D4A6 27             	DAA
D4A7 10 FA          	DJNZ	PRTA1
D4A9 21 0F EF       	LD	HL,DECBF
D4AC 77             	LD	(HL),A
D4AD AF             	XOR	A
D4AE CD 14 D4       	CALL	DECX
D4B1 E1             	POP	HL
D4B2 C9             	RET
D4B3                
D4B3                SETFCB:
D4B3 CD E1 E0       	CALL	SPCUT
D4B6 1A             	LD	A,(DE)
D4B7 FE 20          	CP	020H
D4B9 38 01          	JR	C,SETFCBA
D4BB 1B             	DEC	DE
D4BC                SETFCBA:
D4BC 06 24          	LD	B,36
D4BE 21 5C 00       	LD	HL,FCB1
D4C1 E5             	PUSH	HL
D4C2 AF             	XOR	A
D4C3 CD B6 E0       	CALL	FILL_MEMORY
D4C6 E1             	POP	HL
D4C7 D5             	PUSH	DE
D4C8 CD 26 DA       	CALL	_SYS5C		;(BDOS)ファイル名の解析
D4CB 21 6C 00       	LD	HL,FCB2
D4CE CD 26 DA       	CALL	_SYS5C		;(BDOS)ファイル名の解析
D4D1 E1             	POP	HL
D4D2 01 00 50       	LD	BC,05000H
D4D5 11 81 00       	LD	DE,00081H
D4D8                SETFCB1:
D4D8 7E             	LD	A,(HL)
D4D9 23             	INC	HL
D4DA FE 20          	CP	020H
D4DC 38 05          	JR	C,SETFCB2
D4DE 12             	LD	(DE),A
D4DF 13             	INC	DE
D4E0 0C             	INC	C
D4E1 10 F5          	DJNZ	SETFCB1
D4E3                SETFCB2:
D4E3 79             	LD	A,C
D4E4 32 80 00       	LD	(DTA1),A
D4E7 04             	INC	B
D4E8                ZERO_MEMORY_DE:
D4E8 AF             	XOR	A
D4E9                FILL_MEMORY_DE:
D4E9 12             	LD	(DE),A
D4EA 13             	INC	DE
D4EB 10 FC          	DJNZ	FILL_MEMORY_DE
D4ED C9             	RET
D4EE                
D4EE                C_COPY:
D4EE CD B3 D4       	CALL	SETFCB
D4F1                
D4F1 11 61 EF       	LD	DE,ZERO
D4F4 CD 02 E0       	CALL	FILEC2
D4F7 21 6C 00       	LD	HL,FCB2
D4FA CD 2D DA       	CALL	S29X1
D4FD                
D4FD 3E 10          	LD	A,010H
D4FF 32 69 00       	LD	(FCB1+13),A
D502 21 6D 00       	LD	HL,FCB2+1
D505 CD FE D5       	CALL	CWILD1
D508                COPY0:
D508 CD FB D5       	CALL	CWILD
D50B 21 5C 00       	LD	HL,FCB1
D50E CD D9 D1       	CALL	OPEN
D511 37             	SCF
D512                COPY1:
D512 C0             	RET	NZ
D513 CD EC D1       	CALL	DEFCB
D516                
D516 3A 16 D6       	LD	A,(DTA_CCP+13)
D519 CB 67          	BIT	4,A
D51B 28 21          	JR	Z,COPY1A
D51D                
D51D 21 5D 00       	LD	HL,FCB1+1
D520 CD 45 E4       	CALL	CHKWILD
D523 38 14          	JR	C,COPY9
D525                
D525 3E 20          	LD	A,020H
D527 32 5D 00       	LD	(FCB1+1),A
D52A 2A 23 D6       	LD	HL,(DTA_CCP+26)
D52D 23             	INC	HL
D52E 22 6A 00       	LD	(FCB1+14),HL
D531 18 D5          	JR	COPY0
D533                
D533                COPY8:
D533 CD E6 D7       	CALL	_SYS09		;(BDOS)文字列出力
D536 CD AA D3       	CALL	LTNL
D539                COPY9:
D539 CD E8 D1       	CALL	OPEN2
D53C 18 D4          	JR	COPY1
D53E                
D53E                COPY1A:
D53E 21 6C 00       	LD	HL,FCB2
D541 11 14 EF       	LD	DE,FDRV
D544 01 0B D6       	LD	BC,DTA_CCP+2
D547 ED A0          	LDI
D549 3E 0B          	LD	A,11
D54B                COPY2:
D54B F5             	PUSH	AF
D54C 7E             	LD	A,(HL)
D54D FE 3F          	CP	'?'
D54F 20 01          	JR	NZ,COPY3
D551 0A             	LD	A,(BC)
D552                COPY3:
D552 12             	LD	(DE),A
D553 03             	INC	BC
D554 13             	INC	DE
D555 23             	INC	HL
D556 F1             	POP	AF
D557 3D             	DEC	A
D558 20 F1          	JR	NZ,COPY2
D55A 01 05 00       	LD	BC,16-11
D55D ED B0          	LDIR
D55F                PUTNAME:
D55F 21 5D 00       	LD	HL,FCB1+1
D562 CD 45 E4       	CALL	CHKWILD
D565 30 0B          	JR	NC,PUTN1
D567 21 15 EF       	LD	HL,FDRV+1
D56A CD 22 D4       	CALL	FPRNT
D56D 3E 20          	LD	A,020H
D56F CD 3B DB       	CALL	MSG_A
D572                PUTN1:
D572 11 14 EF       	LD	DE,FDRV
D575 0E 16          	LD	C,016H		;(BDOS)ファイルの作成
D577 CD 07 D2       	CALL	SYSTEM0
D57A 20 48          	JR	NZ,COPYE2
D57C 67             	LD	H,A		;A=0
D57D 6F             	LD	L,A
D57E 22 35 EF       	LD	(FDRV+33),HL	;(FCB)ランダムレコード
D581 22 37 EF       	LD	(FDRV+35),HL
D584                COPY6:
D584 CD 10 D2       	CALL	S27BUF
D587 47             	LD	B,A
D588 3C             	INC	A
D589 28 31          	JR	Z,COPYE
D58B 7C             	LD	A,H
D58C B5             	OR	L
D58D 28 0C          	JR	Z,COPY7
D58F 11 14 EF       	LD	DE,FDRV
D592 0E 26          	LD	C,026H		;(BDOS)ランダムブロック書き込み
D594 CD 07 D2       	CALL	SYSTEM0
D597 20 23          	JR	NZ,COPYE
D599 10 E9          	DJNZ	COPY6
D59B                COPY7:
D59B 3A 16 D6       	LD	A,(DTA_CCP+13)	;(FCB)属性
D59E 32 21 EF       	LD	(FDRV+13),A
D5A1 21 1D D6       	LD	HL,DTA_CCP+20	;(FCB)タイムスタンプ
D5A4 11 28 EF       	LD	DE,FDRV+20
D5A7 01 04 00       	LD	BC,4
D5AA ED B0          	LDIR
D5AC                
D5AC 11 14 EF       	LD	DE,FDRV
D5AF 0E 10          	LD	C,010H		;(BDOS)ファイルのクローズ
D5B1 CD 07 D2       	CALL	SYSTEM0
D5B4 20 06          	JR	NZ,COPYE
D5B6                
D5B6 11 71 EF       	LD	DE,OK
D5B9 C3 33 D5       	JP	COPY8
D5BC                
D5BC                COPYE:
D5BC 11 14 EF       	LD	DE,FDRV
D5BF 0E 13          	LD	C,013H		;(BDOS)ファイルの削除
D5C1 CD 05 00       	CALL	SYSTEM
D5C4                COPYE2:
D5C4 37             	SCF
D5C5 C9             	RET
D5C6                
D5C6                C_TYPE:
D5C6 CD B3 D4       	CALL	SETFCB
D5C9 21 5C 00       	LD	HL,FCB1
D5CC CD D9 D1       	CALL	OPEN
D5CF 37             	SCF
D5D0                TYPE1:
D5D0 C0             	RET	NZ
D5D1 CD EC D1       	CALL	DEFCB
D5D4 3E 06          	LD	A,6
D5D6 CD 3B DB       	CALL	MSG_A
D5D9                TYPE2:
D5D9 CD 10 D2       	CALL	S27BUF
D5DC C6 FE          	ADD	A,0FEH
D5DE D8             	RET	C
D5DF 7C             	LD	A,H
D5E0 B5             	OR	L
D5E1 28 13          	JR	Z,TYPEE
D5E3 01 00 01       	LD	BC,00100H
D5E6                TYPE3:
D5E6 0A             	LD	A,(BC)
D5E7 03             	INC	BC
D5E8 FE 1A          	CP	01AH
D5EA 28 0A          	JR	Z,TYPEE
D5EC CD 3B DB       	CALL	MSG_A
D5EF 2B             	DEC	HL
D5F0 7C             	LD	A,H
D5F1 B5             	OR	L
D5F2 20 F2          	JR	NZ,TYPE3
D5F4 18 E3          	JR	TYPE2
D5F6                TYPEE:
D5F6 CD E8 D1       	CALL	OPEN2
D5F9 18 D5          	JR	TYPE1
D5FB                
D5FB                CWILD:
D5FB 21 5D 00       	LD	HL,FCB1+1
D5FE                CWILD1:
D5FE 7E             	LD	A,(HL)
D5FF FE 20          	CP	020H
D601 C0             	RET	NZ
D602                CWILD2:
D602 3E 3F          	LD	A,'?'
D604 06 0B          	LD	B,11
D606 C3 B6 E0       	JP	FILL_MEMORY
D609                
D609                DTA_CCP:
D609                	DS	37
D62E                
D62E 00 00 00 40    PATHX	EQU	64
D62E                PATHD:	DS	PATHX
D66E 00             PATHE:	DB	0
D66F                
D66F 20 62 79 74    FREE:	DB	" bytes free",9,'$'
D673 65 73 20 66
D677 72 65 65 09
D67B 24
D67C 20 20 20 20    DIRMES:	DB	"     <DIR>$"
D680 20 3C 44 49
D684 52 3E 24
D687 20 20 3A 24    DIRHD:	DB	"  :$"
D68B                
D68B                COMTB:
D68B 44 20 20 20    	DB	"D   "	;1
D68F 0A D3          	DW	C_DIR
D691 44 49 52 20    	DB	"DIR "	;2
D695 0A D3          	DW	C_DIR
D697 43 4F 50 59    	DB	"COPY"	;3
D69B EE D4          	DW	C_COPY
D69D 43 44 20 20    	DB	"CD  "	;4
D6A1 0C D2          	DW	C_CD
D6A3 44 45 4C 20    	DB	"DEL "	;5
D6A7 ED D2          	DW	C_DEL
D6A9 50 41 54 48    	DB	"PATH"	;6
D6AD AF D3          	DW	C_PATH
D6AF 52 45 4E 20    	DB	"REN "	;7
D6B3 F7 D2          	DW	C_REN
D6B5 54 59 50 45    	DB	"TYPE"	;8
D6B9 C6 D5          	DW	C_TYPE
D6BB 52 45 4D 20    	DB	"REM "	;9
D6BF E3 D7          	DW	C_REM
D6C1                	INCLUDE	"X1DISK2.ASM"
D6C1                
D6C1                ;	LSX-Dodgers DISK2
D6C1                ;	X1/turbo/Z
D6C1                
D6C1                ;	GRAPHIC RAM DISK DRIVER
D6C1                
D6C1                
D6C1                GDRD:
D6C1 C5             	PUSH	BC
D6C2 CD EA D6       	CALL	GADR
D6C5 F1             	POP	AF
D6C6                GDRD1:
D6C6 ED A2          	INI
D6C8 04             	INC	B
D6C9 0C             	INC	C
D6CA 20 FA          	JR	NZ,GDRD1
D6CC 04             	INC	B
D6CD 13             	INC	DE
D6CE 3D             	DEC	A
D6CF 20 F5          	JR	NZ,GDRD1
D6D1                GBANK0:
D6D1 3A BF EF       	LD	A,(WK1FD0)
D6D4 E6 EF          	AND	0EFH		;BANK0
D6D6 18 1D          	JR	S1FD0
D6D8                
D6D8                GDWT:
D6D8 C5             	PUSH	BC
D6D9 CD EA D6       	CALL	GADR
D6DC F1             	POP	AF
D6DD                GDWT1:
D6DD 04             	INC	B
D6DE ED A3          	OUTI
D6E0 0C             	INC	C
D6E1 20 FA          	JR	NZ,GDWT1
D6E3 04             	INC	B
D6E4 13             	INC	DE
D6E5 3D             	DEC	A
D6E6 20 F5          	JR	NZ,GDWT1
D6E8 18 E7          	JR	GBANK0
D6EA                
D6EA                GADR:
D6EA 0E 00          	LD	C,0
D6EC 7B             	LD	A,E
D6ED C6 40          	ADD	A,040H
D6EF 47             	LD	B,A
D6F0 3A BF EF       	LD	A,(WK1FD0)
D6F3 F6 10          	OR	010H		;BANK1
D6F5                S1FD0:
D6F5 C5             	PUSH	BC
D6F6 32 BF EF       	LD	(WK1FD0),A
D6F9 01 D0 1F       	LD	BC,01FD0H
D6FC ED 79          	OUT	(C),A
D6FE C1             	POP	BC
D6FF C9             	RET
D700                
D700                
D700                ;	BANK RAM DISK DRIVER
D700                
D700                BDWT:
D700 3E             	DB	03EH	;LD A,??
D701 37             	SCF
D702 18 02          	JR	BRW
D704                
D704                BDRD:
D704 3E             	DB	03EH	;LD A,??
D705 A7             	AND	A
D706                BRW:
D706 F3             	DI
D707 32 2F D7       	LD	(BRWPAT),A
D70A ED 73 4F D7    	LD	(BANKSP+1),SP
D70E 3A 50 D7       	LD	A,(BANKSP+2)
D711 87             	ADD	A,A
D712 38 03          	JR	C,BRW0
D714 31 CA FF       	LD	SP,EXTSP
D717                BRW0:
D717 D9             	EXX		;裏レジスタ
D718 C5             	 PUSH	 BC
D719 D5             	 PUSH	 DE
D71A 01 00 0B       	 LD	 BC,00B00H	 ;バンクメモリ
D71D 11 10 10       	 LD	 DE,01010H
D720 D9             	 EXX		;表レジスタ
D721                BRW1:
D721 C5             	PUSH	BC
D722 D5             	PUSH	DE
D723 EB             	EX	DE,HL
D724 29             	ADD	HL,HL
D725 29             	ADD	HL,HL
D726 7C             	LD	A,H
D727 E6 0F          	AND	00FH	;バンク
D729 65             	LD	H,L
D72A CB 3C          	SRL	H	;/2
D72C 2E 00          	LD	L,0
D72E D9             	EXX		;裏レジスタ
D72F A7             BRWPAT:	 AND	 A	;自己書き換え(AND A:読み出し/SCF:書き込み)
D730 38 08          	 JR	 C,BRWT
D732 57             	 LD	 D,A	 ;D=バンク
D733 D9             	 EXX		;表レジスタ
D734 EB             	EX	DE,HL
D735 CD 53 D7       	CALL	BTFR
D738 18 06          	JR	BRW2
D73A                BRWT:
D73A 5F             	 LD	E,A	 ;E=バンク
D73B D9             	 EXX		;表レジスタ
D73C CD 53 D7       	CALL	BTFR
D73F EB             	EX	DE,HL
D740                BRW2:
D740 D1             	POP	DE
D741 C1             	POP	BC
D742 13             	INC	DE
D743 10 DC          	DJNZ	BRW1
D745                
D745 D9             	EXX		;裏レジスタ
D746 3E 10          	 LD	 A,10H
D748 ED 79          	 OUT	 (C),A		;メインメモリに切り替える
D74A D1             	 POP	 DE
D74B C1             	 POP	 BC
D74C D9             	 EXX		;表レジスタ
D74D AF             	XOR	A
D74E 31 00 00       BANKSP:	LD	SP,0
D751 FB             	EI
D752 C9             	RET
D753                
D753                ;メインメモリ←→バンクメモリ 512バイトの転送を行う
D753                ; DE:転送元アドレス
D753                ; HL:転送先アドレス
D753                ; 裏BC:バンク切り替えポート(0B00H)
D753                ; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
D753                ; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
D753                
D753                BTFR:
D753 06 00          	LD	B,0	;256回ループ(256*2)
D755                BTFR1:
D755 D9             	EXX		;裏レジスタ
D756 ED 51          	 OUT	 (C),D	 ;BANK(MAIN)
D758 D9             	 EXX		;表レジスタ
D759 1A             	LD	A,(DE)
D75A 4F             	LD	C,A
D75B 13             	INC	DE
D75C 1A             	LD	A,(DE)
D75D 13             	INC	DE
D75E D9             	EXX		;裏レジスタ
D75F ED 59          	 OUT	 (C),E	 ;MAIN(BANK)
D761 D9             	 EXX		;表レジスタ
D762 71             	LD	(HL),C
D763 23             	INC	HL
D764 77             	LD	(HL),A
D765 23             	INC	HL
D766 10 ED          	DJNZ	BTFR1
D768 C9             	RET
D769                
D769                ;	EMM DRIVER(DMA)
D769                
D769                
D769                EDWT:
D769 0E 0F          	LD	C,15
D76B 18 02          	JR	EDWT1
D76D                EDRD:
D76D 0E 0E          	LD	C,14
D76F                EDWT1:
D76F C5             	PUSH	BC
D770 D5             	PUSH	DE
D771 22 B1 D7       	LD	(DMAB),HL
D774 78             	LD	A,B
D775 87             	ADD	A,A
D776 3D             	DEC	A
D777 32 AA D7       	LD	(DMALEN+1),A
D77A 3C             	INC	A
D77B 84             	ADD	A,H	;HL(アドレス)を先に進めておく
D77C 67             	LD	H,A
D77D EB             	EX	DE,HL
D77E 29             	ADD	HL,HL
D77F DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
D782 79             	LD	A,C
D783 DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
D786 09             	ADD	HL,BC
D787 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
D78A 06 0D          	LD	B,00DH
D78C ED 49          	OUT	(C),C
D78E 0C             	INC	C
D78F ED 69          	OUT	(C),L
D791 0C             	INC	C
D792 ED 61          	OUT	(C),H
D794                
D794 21 A5 D7       	LD	HL,EDMAD
D797 CD 14 DF       	CALL	SETDMA
D79A CD 3C DF       	CALL	GO_DMA
D79D EB             	EX	DE,HL
D79E D1             	POP	DE
D79F C1             	POP	BC
D7A0                DMA_ADD_SEC:
D7A0 13             	INC	DE
D7A1 10 FD          	DJNZ	DMA_ADD_SEC
D7A3 AF             	XOR	A
D7A4 C9             	RET
D7A5                
D7A5                EDMAD:
D7A5 C3             	DB	0C3H	;WR6 リセット
D7A6 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
D7A7 03 0D          	DW	00D03H	;ポートA開始アドレス EMMリード/ライト
D7A9 FF 01          DMALEN:	DW	001FFH	;ブロック長(転送サイズ-1)
D7AB 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
D7AC 50             	DB	050H	;WR2 ポートBアドレスインクリメント メモリ
D7AD 02             	DB	002H	;ポートBタイミング
D7AE 80             	DB	080H	;WR3
D7AF 9A             	DB	09AH	;WR5 WAIT RDY:HIGH
D7B0 AD             	DB	0ADH	;WR4 連続 ポートB開始アドレス
D7B1 00 00          DMAB:	DW	0
D7B3 01             	DB	001H	;WR0 ポートA←ポートB 転送
D7B4                EMME:
D7B4                
D7B4 00 00 07 48    AT_RE	EQU	EDWT-AT_EDWT
D7B4                
D7B4                	INCLUDE	"LDOS.ASM"
D7B4                
D7B4                ;	LSX-Dodgers OS
D7B4                
D7B4                BDOS0:
D7B4 E5             	PUSH	HL
D7B5 79             	LD	A,C
D7B6 FE 3C          	CP	03CH
D7B8 38 02          	JR	C,DOS1
D7BA 3E 3C          	LD	A,03CH
D7BC                DOS1:
D7BC 87             	ADD	A,A
D7BD 6F             	LD	L,A
D7BE 26 F0          	LD	H,STABLE/256
D7C0 7E             	LD	A,(HL)
D7C1 2C             	INC	L
D7C2 66             	LD	H,(HL)
D7C3 6F             	LD	L,A
D7C4 E3             	EX	(SP),HL
D7C5 79             	LD	A,C
D7C6                ;確認用
D7C6                ;	LD	(0050H),A
D7C6 C9             	RET
D7C7                _DOS2:
D7C7 FE 5A          	CP	05AH		;(BDOS)カレントディレクトリの変更(_CHDIR)
D7C9 CA 6A DA       	JP	Z,_SYS5A
D7CC FE 5C          	CP	05CH		;(BDOS)ファイル名の解析(_PFILE)
D7CE CA 26 DA       	JP	Z,_SYS5C
D7D1 FE 5F          	CP	05FH		;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
D7D3 CA 4B ED       	JP	Z,_SYS5F
D7D6 FE 6F          	CP	06FH		;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
D7D8 20 0A          	JR	NZ,_ERROR
D7DA 01 1D 01       	LD	BC,011DH
D7DD 11 49 01       	LD	DE,VER
D7E0 21 00 00       	LD	HL,MACD
D7E3                C_REM:
D7E3 AF             	XOR	A
D7E4                _ERROR:
D7E4 A7             	AND	A
D7E5 C9             	RET
D7E6                
D7E6                _SYS09:		;文字列出力
D7E6 D5             	PUSH	DE
D7E7                _SX09:
D7E7 1A             	LD	A,(DE)
D7E8 13             	INC	DE
D7E9 FE 24          	CP	'$'
D7EB 28 31          	JR	Z,SX0E2
D7ED CD 3B DB       	CALL	MSG_A
D7F0 18 F5          	JR	_SX09
D7F2                
D7F2                MSX1:
D7F2 CD 3B DB       	CALL	MSG_A
D7F5                MSX:
D7F5 7E             	LD	A,(HL)
D7F6 23             	INC	HL
D7F7 B7             	OR	A
D7F8 20 F8          	JR	NZ,MSX1
D7FA C9             	RET
D7FB                
D7FB                _SYS0C:		;(BDOS)バージョン番号の獲得
D7FB 21 22 00       	LD	HL,00022H
D7FE 7D             	LD	A,L
D7FF C9             	RET
D800                
D800                _SYS0D:		;(BDOS)ディスクリセット
D800 CD DF EF       	CALL	_FFLUSH
D803 E5             	PUSH	HL
D804 21 80 00       	LD	HL,00080H
D807 22 8A EF       	LD	(_DTA),HL
D80A E1             	POP	HL
D80B D5             	PUSH	DE
D80C 1E 00          	LD	E,0
D80E 3E             	DB	03EH
D80F                
D80F                _SYS0E:		;(BDOS)カレントドライブの設定
D80F D5             	PUSH	DE
D810 7B             	LD	A,E
D811 DD E5          	PUSH	IX
D813 CD DC EF       	CALL	_GETDPB
D816 DD E1          	POP	IX
D818 38 04          	JR	C,SX0E2
D81A 7B             	LD	A,E
D81B 32 87 EF       	LD	(_DVSW),A
D81E                SX0E2:
D81E 3E 08          	LD	A,8
D820 D1             	POP	DE
D821 C9             	RET
D822                
D822                _SYS0F:		;(BDOS)ファイルのオープン
D822 CD F3 E0       	CALL	SETDRV
D825 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D828 C6 02          	ADD	A,002H		;Write
D82A 28 48          	JR	Z,FEND0F
D82C CD 41 E4       	CALL	CHKWILDX
D82F                
D82F D4 13 E1       	CALL	NC,SOPENX
D832                _S16XX:
D832 38 40          	JR	C,FEND0F
D834                				;Directory location
D834 3A 9F EF       	LD	A,(_FILEN)
D837 FD 77 19       	LD	(IY+25),A	;(FCB)ディレクトリロケーション
D83A                ;				_DIRF
D83A 3A A0 EF       	LD	A,(_DIRF)
D83D FD 77 1D       	LD	(IY+29),A	;(FCB)ディレクトリモード
D840                ;				_FBPS
D840 FD 73 1E       	LD	(IY+30),E	;(FCB)ディレクトリポジション
D843 FD 72 1F       	LD	(IY+31),D
D846                ;				Open(Read)
D846 FD 36 1C FF    	LD	(IY+28),0FFH	;(FCB)オープンモード
D84A                ;				FILENAME
D84A FD E5          	PUSH	IY
D84C D1             	POP	DE
D84D 13             	INC	DE
D84E 01 0B 00       	LD	BC,11
D851 ED B0          	LDIR
D853                ;				Attribute
D853 7E             	LD	A,(HL)
D854 FD 77 0D       	LD	(IY+13),A	;(FCB)属性(アトリビュート)
D857 11 0B 00       	LD	DE,11		;Reserved
D85A 19             	ADD	HL,DE
D85B                					;(FCB)ファイルを最後に変更した時刻
D85B 11 EA F0       	LD	DE,SDDATA		;(FCB)ファイルを最後に変更した日付
D85E 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
D860                S16LOOP:				;(FCB)ファイルのサイズ(バイト単位)
D860 1A             	LD	A,(DE)
D861 13             	INC	DE
D862 32 69 D8       	LD	(S16PAT+2),A
D865 7E             	LD	A,(HL)
D866 23             	INC	HL
D867 FD 77 00       S16PAT:	LD	(IY+0),A
D86A 10 F4          	DJNZ	S16LOOP
D86C                
D86C AF             	XOR	A
D86D FD 77 0C       	LD	(IY+12),A	;(FCB)カレントブロック
D870 FD 22 18 D9    	LD	(OFCB+1),IY
D874                FEND0F:
D874 18 45          	JR	FEND10
D876                
D876                _SYS10:		;(BDOS)ファイルのクローズ
D876 CD F3 E0       	CALL	SETDRV
D879 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D87C D6 FE          	SUB	0FEH
D87E 37             	SCF
D87F 3F             	CCF
D880 20 39          	JR	NZ,FEND10
D882                _S10A:				;Write
D882 FD 77 0E       	LD	(IY+14),A	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D885 FD 77 0F       	LD	(IY+15),A
D888                
D888 FD 34 1C       	INC	(IY+28)		;0FEH->0FFH ;オープンモード
D88B CD 39 E5       	CALL	SETTMS
D88E                
D88E FD 7E 1D       	LD	A,(IY+29)	;(FCB)ディレクトリモード
D891 32 A0 EF       	LD	(_DIRF),A
D894 E6 7F          	AND	07FH
D896 32 82 EA       	LD	(_SECPS+1),A
D899 FD 5E 1E       	LD	E,(IY+30)	;(FCB)ディレクトリポジション
D89C FD 56 1F       	LD	D,(IY+31)
D89F CD 47 E2       	CALL	READ_DIR
D8A2 38 17          	JR	C,FEND10
D8A4                
D8A4 3A 71 E1       SDECM1:	LD	A,(SDECPAT+1)	;1セクタ辺りのディレクトリエントリ数
D8A7 3D              	DEC	A		;1024=01FH / 512=00FH / 256=7
D8A8 FD A6 19       	AND	(IY+25)		;(FCB)ディレクトリロケーション
D8AB 6F             	LD	L,A
D8AC 26 00          	LD	H,0
D8AE 29             	ADD	HL,HL		;*2
D8AF 29             	ADD	HL,HL		;*4
D8B0 29             	ADD	HL,HL		;*8
D8B1 29             	ADD	HL,HL		;*16
D8B2 29             	ADD	HL,HL		;*32
D8B3 ED 4B 7E F0    	LD	BC,(_DTBUF)
D8B7 09             	ADD	HL,BC
D8B8                
D8B8 CD 51 E4       	CALL	SDIRENT
D8BB                FEND10:
D8BB 18 42          	JR	FEND
D8BD                
D8BD                _SYS11:		;(BDOS)最初のファイルの検索
D8BD CD F3 E0       	CALL	SETDRV
D8C0 CD 40 E1       	CALL	SOPEN
D8C3                _S12X1:
D8C3 38 3A          	JR	C,FEND
D8C5 CD E0 E1       	CALL	SOPENE2
D8C8 ED 5B 8A EF    	LD	DE,(_DTA)
D8CC 3A 88 EF       	LD	A,(_DRV)
D8CF 3C             	INC	A
D8D0 12             	LD	(DE),A
D8D1 D5             	PUSH	DE
D8D2 13             	INC	DE
D8D3 01 20 00       	LD	BC,32
D8D6 ED B0          	LDIR
D8D8 FD 6E 0E       	LD	L,(IY+14)	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D8DB FD 66 0F       	LD	H,(IY+15)
D8DE 22 F4 F0       	LD	(SCDIR),HL
D8E1 2A 9A EF       	LD	HL,(_FBPS)
D8E4 22 F6 F0       	LD	(SFBPS),HL
D8E7 2A 9F EF       	LD	HL,(_FILEN)
D8EA 7C             	LD	A,H
D8EB B7             	OR	A
D8EC 28 06          	JR	Z,_S12DIR
D8EE 3A 82 EA       	LD	A,(_SECPS+1)
D8F1 F6 80          	OR	080H
D8F3 67             	LD	H,A
D8F4                _S12DIR:
D8F4 22 F8 F0       	LD	(SFNDF),HL	;Directory position and Flags
D8F7 E1             	POP	HL
D8F8 11 39 EF       	LD	DE,SFILE
D8FB 0E 21          	LD	C,33
D8FD                _S11B:
D8FD ED B0          	LDIR
D8FF                FEND:
D8FF 9F             	SBC	A,A		;CF=0 A=0 : CF=1 A=0FFH
D900                FENDE:
D900 FD E1          	POP	IY
D902 C1             	POP	BC
D903 D1             	POP	DE
D904 E1             	POP	HL
D905 C9             	RET
D906                
D906                _SYS12:		;(BDOS)次のファイルの検索
D906 E5             	PUSH	HL
D907 D5             	PUSH	DE
D908 C5             	PUSH	BC
D909 FD E5          	PUSH	IY
D90B CD A4 E1       	CALL	NOPEN
D90E 18 B3          	JR	_S12X1
D910                
D910                _S16K:
D910 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D913 FE FD          	CP	0FDH		;Device(0FDH)
D915 37             	SCF
D916 C8             	RET	Z
D917                
D917 11 00 00       OFCB:	LD	DE,0
D91A D5             	PUSH	DE
D91B 06 1A          	LD	B,26		;First cluster
D91D                S16K1:
D91D 13             	INC	DE
D91E 23             	INC	HL
D91F 10 FC          	DJNZ	S16K1
D921                
D921 1A             	LD	A,(DE)
D922 BE             	CP	(HL)
D923 20 13          	JR	NZ,S16K2
D925 13             	INC	DE
D926 23             	INC	HL
D927 1A             	LD	A,(DE)
D928 BE             	CP	(HL)
D929 20 0D          	JR	NZ,S16K2
D92B                
D92B E1             	POP	HL
D92C FD E5          	PUSH	IY
D92E D1             	POP	DE
D92F 1A             	LD	A,(DE)		;Drive
D930 BE             	CP	(HL)
D931 20 06          	JR	NZ,S16K3
D933                				;ここはCFが必ず0
D933 ED 52          	SBC	HL,DE		;CP HL,DE
D935 37             	SCF
D936 C0             	RET	NZ
D937 E5             	PUSH	HL
D938                S16K2:
D938 E1             	POP	HL
D939                S16K3:
D939 FD E5          	PUSH	IY
D93B D1             	POP	DE
D93C                _SYS13:		;(BDOS)ファイルの削除
D93C CD F3 E0       	CALL	SETDRV
D93F CD 71 E3       	CALL	KILL
D942                FEND13:
D942 18 BB          	JR	FEND
D944                
D944                _SYS14:		;(BDOS)シーケンシャルな読み出し
D944 CD F3 E0       	CALL	SETDRV
D947 CD A5 E5       	CALL	INIT_SEQ
D94A                SREAD:
D94A CD EF E5       	CALL	RB_READ
D94D                
D94D C6 01          	ADD	A,001H
D94F 38 AE          	JR	C,FEND
D951                
D951 7D             	LD	A,L
D952 D6 01          	SUB	001H
D954                FENDX:
D954 9F             	SBC	A,A
D955 E6 03          	AND	3
D957 1F             	RRA
D958 18 A6          	JR	FENDE
D95A                
D95A                _SYS15:		;(BDOS)シーケンシャルな書き込み
D95A CD F3 E0       	CALL	SETDRV
D95D CD A5 E5       	CALL	INIT_SEQ
D960                SWRITE:
D960 CD E8 E5       	CALL	RB_WRITE
D963                
D963 C6 FF          	ADD	A,0FFH
D965 18 ED          	JR	FENDX
D967                
D967                _SYS17:		;(BDOS)ファイル名の変更
D967 CD F3 E0       	CALL	SETDRV
D96A CD C7 E3       	CALL	NAME
D96D 18 D3          	JR	FEND13
D96F                
D96F                _SYS16:		;(BDOS)ファイルの作成
D96F CD F3 E0       	CALL	SETDRV
D972                
D972 CD 41 E4       	CALL	CHKWILDX
D975 38 CB          	JR	C,FEND13
D977 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
D97A FE 05          	CP	5
D97C 28 05          	JR	Z,_S16X2
D97E FE 21          	CP	021H
D980 DA 42 D9       	JP	C,FEND13
D983                _S16X2:
D983                ;				Clear FCB
D983 FD E5          	PUSH	IY
D985 E1             	POP	HL
D986 01 10 00       	LD	BC,16
D989 09             	ADD	HL,BC
D98A                _S16X1:
D98A 70             	LD	(HL),B		;B=0
D98B 23             	INC	HL
D98C 0D             	DEC	C
D98D 20 FB          	JR	NZ,_S16X1
D98F                
D98F CD 3E E5       	CALL	SETTMSX
D992 FD 36 0D FF    	LD	(IY+13),0FFH	;(FCB)Attribute
D996 CD 13 E1       	CALL	SOPENX
D999 3F             	CCF
D99A CC 10 D9       	CALL	Z,_S16K
D99D D4 F1 E1       	CALL	NC,COPEN
D9A0 D4 51 E4       	CALL	NC,SDIRENT
D9A3 C3 32 D8       	JP	_S16XX
D9A6                
D9A6                _SYS21:		;(BDOS)ランダムな読み出し
D9A6 CD F3 E0       	CALL	SETDRV
D9A9 CD 89 E5       	CALL	INIT_RND
D9AC 18 9C          	JR	SREAD
D9AE                
D9AE                _SYS22:		;(BDOS)ランダムな書き込み
D9AE                _SYS28:		;(BDOS)ランダムな書き込み・その2
D9AE CD F3 E0       	CALL	SETDRV
D9B1 CD 89 E5       	CALL	INIT_RND
D9B4 18 AA          	JR	SWRITE
D9B6                
D9B6                _SYS18:		;(BDOS)ログインベクトルの獲得
D9B6 21 FF 00       	LD	HL,000FFH
D9B9 AF             	XOR	A
D9BA C9             	RET
D9BB                
D9BB                _SYS19:		;(BDOS)カレントドライブ番号の獲得
D9BB 3A 87 EF       	LD	A,(_DVSW)
D9BE A7             	AND	A
D9BF C9             	RET
D9C0                
D9C0                _SYS1A:		;(BDOS)DTAの設定
D9C0 ED 53 8A EF    	LD	(_DTA),DE
D9C4 AF             	XOR	A
D9C5 C9             	RET
D9C6                
D9C6                _SYS1B:		;(BDOS)ディスク情報の獲得
D9C6 7B             	LD	A,E
D9C7 CD 06 E1       	CALL	GETDRV
D9CA CD DC EF       	CALL	_GETDPB
D9CD D4 E2 EF       	CALL	NC,_RDFATX
D9D0 21 00 00       	LD	HL,0
D9D3 D4 17 E5       	CALL	NC,DSKF
D9D6                
D9D6 ED 5B 18 E5    	LD	DE,(MAXCLP+1)	;DPB_08_MAXCL-1
D9DA 1B             	DEC	DE		;DE←クラスタの総数
D9DB FD 2A 7C F0    	LD	IY,(_FATBF)	;IY←メモリ上のFATの先頭アドレス
D9DF 9F             	SBC	A,A
D9E0 D8             	RET	C
D9E1 4F             	LD	C,A		;C=0
D9E2 DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS
D9E5 E6 0F          	AND	00FH
D9E7 47             	LD	B,A
D9E8 DD 7E 07       	LD	A,(IX+7)	;DPB_07_SECPCL
D9EB C9             	RET
D9EC                
D9EC                _SYS1D:		;(BDOS)書き込みが禁止されているディスクの調査
D9EC AF             	XOR	A
D9ED 67             	LD	H,A
D9EE 6F             	LD	L,A
D9EF C9             	RET
D9F0                
D9F0                _SYS1F:		;(BDOS)ディスク装置のパラメータの読み出し
D9F0 21 00 F1       	LD	HL,DEVICE
D9F3 7B             	LD	A,E
D9F4 C3 DC EF       	JP	_GETDPB
D9F7                
D9F7                _SYS23:		;(BDOS)ファイルサイズの獲得
D9F7 E5             	PUSH	HL
D9F8 2A 1E F0       	LD	HL,(STABLE+2*00FH)	;ファイルのオープン
D9FB CD 0F 00       	CALL	JP_HL
D9FE 38 1B          	JR	C,_S23X1
DA00                
DA00 D5             	PUSH	DE		;EX DE,IY
DA01 FD E3          	EX	(SP),IY		;
DA03                ;	POP	DE		;
DA03                ;	PUSH	DE		;DEを破壊しないように注意vv
DA03 FD 7E 10       	LD	A,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
DA06 FD 6E 11       	LD	L,(IY+17)	;
DA09 FD 66 12       	LD	H,(IY+18)	;
DA0C C5             	PUSH	BC		;
DA0D FD 46 13       	LD	B,(IY+19)	;
DA10 CD 7B E5       	CALL	GET_CPM_R_SIZE
DA13 C1             	POP	BC
DA14                _S24X1:
DA14 CD 9B E5       	CALL	SET_RR_AHL
DA17                ;	POP	DE		;^^^^^^^^^^^^^^^^^^^^^^^^
DA17                ;	PUSH	DE		;EX DE,IY
DA17 FD E3          	EX	(SP),IY		;
DA19 D1             	POP	DE		;
DA1A                
DA1A AF             	XOR	A
DA1B                _S23X1:
DA1B E1             	POP	HL
DA1C C9             	RET
DA1D                
DA1D                _SYS24:		;(BDOS)ランダムレコードフィールドの設定
DA1D E5             	PUSH	HL
DA1E D5             	PUSH	DE		;EX DE,IY
DA1F FD E3          	EX	(SP),IY		;
DA21                ;	POP	DE		;
DA21                ;	PUSH	DE		;DEを破壊しないように注意vv
DA21 CD AD E5       	CALL	GETSEQ
DA24 18 EE          	JR	_S24X1		;^^^^^^^^^^^^^^^^^^^^^^^^
DA26                
DA26                _SYS5C:		;(BDOS)ファイル名の解析
DA26 C5             	PUSH	BC
DA27 E5             	PUSH	HL
DA28 CD 0A E0       	CALL	FILE
DA2B E1             	POP	HL
DA2C C1             	POP	BC
DA2D                S29X1:
DA2D C5             	PUSH	BC
DA2E D5             	PUSH	DE
DA2F E5             	PUSH	HL
DA30 EB             	EX	DE,HL
DA31 21 14 EF       	LD	HL,FDRV
DA34 01 0D 00       	LD	BC,13
DA37 ED B0          	LDIR
DA39 70             	LD	(HL),B		;B=0
DA3A 0E 03          	LD	C,3
DA3C ED B0          	LDIR
DA3E E1             	POP	HL
DA3F D1             	POP	DE
DA40 C1             	POP	BC
DA41 AF             	XOR	A
DA42 C9             	RET
DA43                
DA43                _SYS30:		;(BDOS)論理セクタを用いた書き込み
DA43 C5             	PUSH	BC
DA44 01 EF EB       	LD	BC,DWT24B
DA47 18 04          	JR	S2FX
DA49                _SYS2F:
DA49 C5             	PUSH	BC
DA4A 01 DF EB       	LD	BC,DRD24B
DA4D                S2FX:
DA4D ED 43 63 DA    	LD	(S2FPAT+1),BC
DA51 CD DF EF       	CALL	_FFLUSH
DA54                
DA54 D5             	PUSH	DE
DA55 E5             	PUSH	HL
DA56 7D             	LD	A,L		;Drive
DA57 CD D9 EF       	CALL	_CHGDRV
DA5A 38 09          	JR	C,S30X2
DA5C 44             	LD	B,H		;Number of clusters
DA5D 2A 8A EF       	LD	HL,(_DTA)
DA60                
DA60 0E 00          	LD	C,0
DA62 CD DF EB       S2FPAT:	CALL	DRD24B
DA65                S30X2:
DA65 E1             	POP	HL
DA66 D1             	POP	DE
DA67 C1             	POP	BC
DA68 9F             	SBC	A,A
DA69 C9             	RET
DA6A                
DA6A                _SYS5A:		;(BDOS)カレントディレクトリの変更
DA6A C5             	PUSH	BC
DA6B D5             	PUSH	DE
DA6C E5             	PUSH	HL
DA6D CD FF DF       	CALL	FILEC
DA70 21 00 00       	LD	HL,0
DA73 11 14 EF       	LD	DE,FDRV
DA76 2A 4E F0       	LD	HL,(STABLE+2*027H)	;ランダムブロック読み込み
DA79 CD 0F 00       	CALL	JP_HL
DA7C 18 E7          	JR	S30X2
DA7E                	INCLUDE	"X1IO.ASM"
DA7E                
DA7E                ;	LSX-Dodgers IO
DA7E                ;	X1/turbo/Z
DA7E                
DA7E 00 00 D7 E4    _SYS04	EQU	_ERROR		;(BDOS)外部出力
DA7E 00 00 D7 E4    _SYS05	EQU	_ERROR		;(BDOS)プリンタ出力
DA7E 00 00 D7 E4    _SYS1C	EQU	_ERROR		;(BDOS)ディスクの書き込み禁止化
DA7E 00 00 D7 E4    _SYS1E	EQU	_ERROR		;(BDOS)ファイル属性の設定
DA7E 00 00 D7 E4    _SYS20	EQU	_ERROR		;(BDOS)利用者番号の設定と読み出し
DA7E 00 00 D7 E4    _SYS2E	EQU	_ERROR		;(BDOS)ベリファイ・フラグの設定
DA7E                
DA7E                BIOS:
DA7E CD 86 DA       	CALL	BIOS3
DA81 06 1E          	LD	B,01EH
DA83 ED 79          	OUT	(C),A
DA85 C9             	RET
DA86                BIOS3:
DA86 C5             	PUSH	BC
DA87 06 1D          	LD	B,01DH
DA89 ED 79          	OUT	(C),A
DA8B C9             	RET
DA8C                
DA8C                INT:
DA8C F5             	PUSH	AF
DA8D E5             	PUSH	HL
DA8E C5             	PUSH	BC
DA8F                
DA8F CD 43 DE       	CALL	IN49SB
DA92 67             	LD	H,A
DA93 CD 43 DE       	CALL	IN49SB
DA96 6F             	LD	L,A
DA97                
DA97 FE 08          	CP	8		;DELキー
DA99 20 05          	JR	NZ,SCEXE
DA9B 7C             	LD	A,H
DA9C E6 11          	AND	011H		;CTRLキー + GRAPHキー
DA9E 28 0C          	JR	Z,RESET
DAA0                SCEXE:
DAA0 22 92 EF       	LD	(_KEYD),HL
DAA3 CD D8 DA       	CALL	KEYSET1
DAA6                
DAA6 C1             	POP	BC
DAA7                INTPE:
DAA7 E1             	POP	HL
DAA8                INTPE2:
DAA8 F1             	POP	AF
DAA9                INTCTCE:
DAA9 FB             	EI
DAAA ED 4D          	RETI
DAAC                
DAAC                RESET:
DAAC 3E 1D          	LD	A,01DH
DAAE D3 00          	OUT	(0),A
DAB0 C7             	RST	0
DAB1                
DAB1                INTCTC2:
DAB1 F5             	PUSH	AF
DAB2 3E 00          INTCPAT:LD	A,000H
DAB4 3D             	DEC	A
DAB5 32 B3 DA       	LD	(INTCPAT+1),A
DAB8 20 EE          	JR	NZ,INTPE2
DABA                
DABA 3A 92 EF       	LD	A,(_KEYD)
DABD B7             	OR	A
DABE 28 E8          	JR	Z,INTPE2
DAC0                KEYSET0:
DAC0 E5             	PUSH	HL
DAC1 2A 90 EF       	LD	HL,(_KEYPS)
DAC4 7C             	LD	A,H
DAC5 AD             	XOR	L
DAC6 20 06          	JR	NZ,INTC2A
DAC8                
DAC8 2A 92 EF       	LD	HL,(_KEYD)
DACB CD 0C DB       	CALL	KEYSET
DACE                INTC2A:
DACE 3A 94 EF       	LD	A,(_KEYSP)
DAD1 E6 0F          	AND	00FH
DAD3 32 B3 DA       	LD	(INTCPAT+1),A
DAD6                
DAD6 18 CF          	JR	INTPE
DAD8                
DAD8                KEYSET1:
DAD8 CB 6C          	BIT	5,H
DADA F5             	PUSH	AF
DADB ED 4B 8C EF    	LD	BC,(_CTC)
DADF 78             	LD	A,B
DAE0 B1             	OR	C
DAE1 20 06          	JR	NZ,KEYS10E
DAE3                
DAE3 F1             	POP	AF
DAE4 20 26          	JR	NZ,KEYSET
DAE6 F5             	PUSH	AF
DAE7 18 D7          	JR	KEYSET0
DAE9                KEYS10E:
DAE9 F1             	POP	AF
DAEA C8             	RET	Z
DAEB F5             	PUSH	AF
DAEC 3E 03          	LD	A,3		;CTC STOP
DAEE ED 79          	OUT	(C),A
DAF0 F1             	POP	AF
DAF1                
DAF1 B7             	OR	A
DAF2 C8             	RET	Z
DAF3                
DAF3 E5             	PUSH	HL
DAF4 2A 94 EF       	LD	HL,(_KEYSP)
DAF7 3E A7          	LD	A,0A7H
DAF9 ED 79          	OUT	(C),A
DAFB ED 69          	OUT	(C),L
DAFD 79             	LD	A,C
DAFE E6 FC          	AND	0FCH
DB00 4F             	LD	C,A
DB01 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
DB03 3E C0          	LD	A,CTC0
DB05 ED 79          	OUT	(C),A
DB07 7C             	LD	A,H
DB08 32 B3 DA       	LD	(INTCPAT+1),A
DB0B E1             	POP	HL
DB0C                
DB0C                KEYSET:
DB0C 7D             	LD	A,L
DB0D CB 74          	BIT	6,H
DB0F C0             	RET	NZ
DB10                KEYBS:
DB10 B7             	OR	A
DB11 C8             	RET	Z
DB12                KEYBS1:
DB12 CD 28 DB       	CALL	KEYBC_IFBREAK
DB15 E5             	PUSH	HL
DB16 F5             	PUSH	AF
DB17 2A 90 EF       	LD	HL,(_KEYPS)
DB1A 2C             	INC	L
DB1B 7D             	LD	A,L
DB1C BC             	CP	H
DB1D 28 15          	JR	Z,POP_AF_HL_SCF_RET
DB1F 32 90 EF       	LD	(_KEYPS),A
DB22 26 FE          	LD	H,KEYBF/256
DB24 F1             	POP	AF
DB25 77             	LD	(HL),A
DB26 E1             	POP	HL
DB27 C9             	RET
DB28                KEYBC_IFBREAK:
DB28 FE 03          	CP	3
DB2A C0             	RET	NZ
DB2B                KEYBC:
DB2B E5             	PUSH	HL
DB2C 21 00 00       	LD	HL,0
DB2F 22 90 EF       	LD	(_KEYPS),HL
DB32 E1             	POP	HL
DB33 C9             	RET
DB34                
DB34                POP_AF_HL_SCF_RET:
DB34 F1             	POP	AF
DB35 E1             	POP	HL
DB36 37             	SCF
DB37 C9             	RET
DB38                
DB38                _SYS01:		;(BDOS)コンソール入力
DB38 CD 09 EF       	CALL	_SYS07
DB3B                MSG_A:
DB3B F5             	PUSH	AF
DB3C D5             	PUSH	DE
DB3D 5F             	LD	E,A
DB3E CD 44 DB       	CALL	_SYS02
DB41 D1             	POP	DE
DB42 F1             	POP	AF
DB43 C9             	RET
DB44                
DB44                _SYS02:		;(BDOS)コンソール出力
DB44 CD 56 DB       	CALL	BREAK
DB47 18 05          	JR	PRINTX
DB49                
DB49                _SYS06:		;(BDOS)コンソール直接入出力
DB49 7B             	LD	A,E
DB4A 3C             	INC	A
DB4B CA CA EF       	JP	Z,_INKEY
DB4E                PRINTX:
DB4E C3 CD EF       	JP	_PRINT
DB51                
DB51                _SYS08:		;(BDOS)エコーなしコンソール入力
DB51 CD 09 EF       	CALL	_SYS07
DB54 18 04          	JR	BREAK1
DB56                BREAK:
DB56 FB             	EI
DB57 3A 92 EF       	LD	A,(_KEYD)
DB5A                BREAK1:
DB5A FE 03          	CP	3		;CTRL+C
DB5C CA 00 EF       	JP	Z,CPM_BOOT
DB5F FE 13          	CP	013H		;CTRL+S
DB61 C0             	RET	NZ
DB62                
DB62                PAUSE:
DB62 CD 2B DB       	CALL	KEYBC
DB65                
DB65                FLGET:
DB65 CD DF EF       	CALL	_FFLUSH
DB68 C5             	PUSH	BC
DB69 E5             	PUSH	HL
DB6A ED 4B 8E EF    	LD	BC,(_TXADR)
DB6E CB E8          	SET	5,B
DB70 ED 60          	IN	H,(C)
DB72                FLGET1:
DB72 3A 93 EF       	LD	A,(_KEYD+1)
DB75 0F             	RRCA
DB76 0F             	RRCA
DB77 E6 10          	AND	010H
DB79 F6 08          	OR	8
DB7B ED 68          	IN	L,(C)
DB7D B5             	OR	L
DB7E ED 79          	OUT	(C),A
DB80 CD CA EF       	CALL	_INKEY
DB83 28 ED          	JR	Z,FLGET1
DB85 ED 61          	OUT	(C),H
DB87 E1             	POP	HL
DB88 C1             	POP	BC
DB89 C9             	RET
DB8A                
DB8A                _SYS0A:		;(BDOS)文字列入力
DB8A C5             	PUSH	BC
DB8B E5             	PUSH	HL
DB8C D5             	PUSH	DE
DB8D CD 90 DF       	CALL	GETL
DB90 11 00 FF       	LD	DE,KBUF
DB93 E1             	POP	HL
DB94 E5             	PUSH	HL
DB95 0E 00          	LD	C,0
DB97 30 04          	JR	NC,SAX0
DB99 23             	INC	HL
DB9A 23             	INC	HL
DB9B 18 08          	JR	SAX4
DB9D                SAX0:
DB9D 46             	LD	B,(HL)
DB9E 23             	INC	HL
DB9F                SAX1:
DB9F 23             	INC	HL
DBA0 1A             	LD	A,(DE)
DBA1 13             	INC	DE
DBA2 B7             	OR	A
DBA3 20 04          	JR	NZ,SAX2
DBA5                SAX4:
DBA5 36 0D          	LD	(HL),00DH
DBA7 18 04          	JR	SAX3
DBA9                SAX2:
DBA9 77             	LD	(HL),A
DBAA 0C             	INC	C
DBAB 10 F2          	DJNZ	SAX1
DBAD                SAX3:
DBAD D1             	POP	DE
DBAE 79             	LD	A,C
DBAF 13             	INC	DE
DBB0 12             	LD	(DE),A
DBB1 1B             	DEC	DE
DBB2 E1             	POP	HL
DBB3 C1             	POP	BC
DBB4 A7             	AND	A
DBB5 C9             	RET
DBB6                
DBB6                _SYS0B:		;(BDOS)コンソール状態のチェック
DBB6 CD 56 DB       	CALL	BREAK
DBB9 3A 92 EF       	LD	A,(_KEYD)
DBBC B7             	OR	A
DBBD C8             	RET	Z
DBBE                CONSTX:
DBBE CD DF EF       	CALL	_FFLUSH
DBC1 E5             	PUSH	HL
DBC2 2A 90 EF       	LD	HL,(_KEYPS)
DBC5 7C             	LD	A,H
DBC6 AD             	XOR	L
DBC7 E1             	POP	HL
DBC8 C6 FF          	ADD	A,0FFH
DBCA 9F             	SBC	A,A
DBCB C9             	RET
DBCC                
DBCC                _SYS2A:		;(BDOS)日付の獲得
DBCC C5             	PUSH	BC
DBCD 3E ED          	LD	A,0EDH		;Read calendar
DBCF CD 5E DE       	CALL	COMOUT
DBD2 CD 04 DC       	CALL	IN49SB_BCD	;YY
DBD5 6F             	LD	L,A
DBD6 26 00          	LD	H,0
DBD8                ;	LD	DE,1900		;0076CH
DBD8                ;	CP	90		;90以上は1900年代 1990-1999
DBD8                ;	JR	NC,RDDATE1	;90未満は2000年代 2000-2089
DBD8                ;	LD	E,0D0H		;2000 & 0FFH D=007H
DBD8 11 D0 07       	LD	DE,2000		;すべて2000年代で処理 2000-2099
DBDB                RDDATE1:
DBDB 19             	ADD	HL,DE
DBDC CD 43 DE       	CALL	IN49SB		;MW
DBDF 57             	LD	D,A
DBE0 CD 04 DC       	CALL	IN49SB_BCD	;DD
DBE3 5F             	LD	E,A
DBE4 7A             	LD	A,D
DBE5 06 04          	LD	B,4
DBE7                RDDATE2:
DBE7 CB 3A          	SRL	D
DBE9 10 FC          	DJNZ	RDDATE2
DBEB C1             	POP	BC
DBEC E6 07          	AND	7
DBEE C9             	RET
DBEF                
DBEF                _SYS2C:		;(BDOS)時刻の獲得
DBEF C5             	PUSH	BC
DBF0 3E EF          	LD	A,0EFH		;Read time
DBF2 CD 5E DE       	CALL	COMOUT
DBF5 CD 04 DC       	CALL	IN49SB_BCD	;TT
DBF8 67             	LD	H,A
DBF9 CD 04 DC       	CALL	IN49SB_BCD	;MM
DBFC 6F             	LD	L,A
DBFD CD 04 DC       	CALL	IN49SB_BCD	;SS
DC00 57             	LD	D,A
DC01 C1             	POP	BC
DC02 AF             	XOR	A
DC03 C9             	RET
DC04                
DC04                IN49SB_BCD:
DC04 CD 43 DE       	CALL	IN49SB
DC07                ;------------------------
DC07                ;BCDの10進数化
DC07                ;in
DC07                ;	A  : BCD
DC07                ;out
DC07                ;	A  : 10進数
DC07                ;------------------------
DC07 4F             	LD	C,A
DC08 E6 F0          	AND	0F0H	;10の位
DC0A 0F             	RRCA
DC0B 47             	LD	B,A
DC0C 0F             	RRCA
DC0D 0F             	RRCA
DC0E 80             	ADD	A,B
DC0F 47             	LD	B,A
DC10 79             	LD	A,C
DC11 E6 0F          	AND	00FH	;1の位
DC13 80             	ADD	A,B
DC14 C9             	RET
DC15                
DC15                ESC1:
DC15 7B             	LD	A,E
DC16 FE 41          	CP	'A'
DC18 CA 5F DD       	JP	Z,CTRL1E
DC1B FE 42          	CP	'B'
DC1D CA C9 DE       	JP	Z,CTRL1F
DC20 FE 43          	CP	'C'
DC22 CA 6A DD       	JP	Z,CTRL1C
DC25 FE 44          	CP	'D'
DC27 CA 56 DD       	JP	Z,CTRL1D
DC2A FE 45          	CP	'E'
DC2C 28 02          	JR	Z,CT0CX
DC2E FE 6A          	CP	'j'
DC30                CT0CX:
DC30 CA 9C DE       	JP	Z,CTRL0C
DC33 FE 48          	CP	'H'
DC35 CA E4 DD       	JP	Z,CTRL0B
DC38 FE 4A          	CP	'J'
DC3A CA 9F DE       	JP	Z,CTRL06
DC3D FE 4B          	CP	'K'
DC3F CA A3 DD       	JP	Z,CTRL05
DC42 FE 4C          	CP	'L'
DC44 CA DE DE       	JP	Z,CTRL0E
DC47 FE 54          	CP	'T'
DC49 CA A3 DD       	JP	Z,CTRL05
DC4C FE 78          	CP	'x'
DC4E 28 04          	JR	Z,ESC1X
DC50 FE 79          	CP	'y'
DC52 20 02          	JR	NZ,ESC1Y
DC54                ESC1X:
DC54 36 01          	LD	(HL),1
DC56                ESC1Y:
DC56 FE 3D          	CP	'='
DC58 28 04          	JR	Z,ESC1W
DC5A FE 59          	CP	'Y'
DC5C 20 02          	JR	NZ,ESC1Z
DC5E                ESC1W:
DC5E 36 02          	LD	(HL),2
DC60                ESC1Z:
DC60 FE 20          	CP	020H
DC62 38 02          	JR	C,ESC1C
DC64 87             	ADD	A,A
DC65 D0             	RET	NC
DC66                ESC1C:
DC66 E1             	POP	HL
DC67 18 4F          	JR	ANK
DC69                
DC69                ESC:
DC69 21 C9 DC       	LD	HL,PRINTE5
DC6C E5             	PUSH	HL
DC6D 21 8F DC       	LD	HL,ESCFLG+1
DC70 36 00          	LD	(HL),0
DC72 3D             	DEC	A
DC73 28 A0          	JR	Z,ESC1
DC75 3D             	DEC	A
DC76 20 09          	JR	NZ,ESC2
DC78 36 03          	LD	(HL),3
DC7A 7B             	LD	A,E
DC7B D6 20          	SUB	020H
DC7D 32 84 DC       	LD	(ESCYP+1),A
DC80 C9             	RET
DC81                ESC2:
DC81 3D             	DEC	A
DC82 C0             	RET	NZ
DC83 26 00          ESCYP:	LD	H,0
DC85 7B             	LD	A,E
DC86 D6 20          	SUB	020H
DC88 6F             	LD	L,A
DC89 C3 D6 EF       	JP	_LOC
DC8C                
DC8C                PRINT:
DC8C C5             	PUSH	BC
DC8D E5             	PUSH	HL
DC8E 3E 00          ESCFLG:	LD	A,000H
DC90 B7             	OR	A
DC91 20 D6          	JR	NZ,ESC
DC93                
DC93 3E 1F          	LD	A,01FH
DC95 BB             	CP	E
DC96 30 35          	JR	NC,CTRL
DC98 01 67 DE       INSFLG:	LD	BC,INSERT
DC9B                
DC9B 3A 18 00       	LD	A,(00018H)
DC9E 3C             	INC	A
DC9F 28 17          	JR	Z,ANK
DCA1 3E 00          KANFLG:	LD	A,000H
DCA3 B7             	OR	A
DCA4 20 3A          	JR	NZ,KANJI2
DCA6 7B             	LD	A,E
DCA7 FE 80          	CP	080H
DCA9 38 0D          	JR	C,ANK
DCAB FE A0          	CP	0A0H
DCAD 38 04          	JR	C,KANJI1
DCAF FE E0          	CP	0E0H
DCB1 38 05          	JR	C,ANK
DCB3                KANJI1:
DCB3 32 A2 DC       	LD	(KANFLG+1),A
DCB6 18 11          	JR	PRINTE5
DCB8                ANK:
DCB8 ED 4B 8E EF    	LD	BC,(_TXADR)
DCBC 78             	LD	A,B
DCBD F6 38          	OR	038H
DCBF 47             	LD	B,A
DCC0 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DCC2 CB 98          	RES	3,B
DCC4 ED 59          	OUT	(C),E		;Text
DCC6                KANJIE:
DCC6 CD 2B DD       	CALL	PRINTE7
DCC9                PRINTE5:
DCC9 E1             	POP	HL
DCCA C1             	POP	BC
DCCB AF             	XOR	A
DCCC C9             	RET
DCCD                
DCCD                CTRL:
DCCD CD 12 DD       	CALL	KANCLR
DCD0 7B             	LD	A,E
DCD1 87             	ADD	A,A
DCD2 F6 80          	OR	080H
DCD4 6F             	LD	L,A
DCD5 26 F0          	LD	H,CTRLTB/256
DCD7 7E             	LD	A,(HL)
DCD8 2C             	INC	L
DCD9 66             	LD	H,(HL)
DCDA 6F             	LD	L,A
DCDB CD 0F 00       	CALL	JP_HL
DCDE 18 E9          	JR	PRINTE5
DCE0                
DCE0                KANJI2:
DCE0 D5             	PUSH	DE
DCE1 57             	LD	D,A
DCE2 01 81 2F       	LD	BC,02F81H	;SFTJIS
DCE5 DF             	RST	018H
DCE6 01 C3 2F       	LD	BC,02FC3H	;Instead or JISVRM
DCE9 DF             	RST	018H
DCEA                
DCEA ED 4B 8E EF    	LD	BC,(_TXADR)
DCEE 78             	LD	A,B
DCEF F6 38          	OR	038H
DCF1 47             	LD	B,A
DCF2 ED 51          	OUT	(C),D		;kanji
DCF4 CB 98          	RES	3,B
DCF6 ED 59          	OUT	(C),E		;Text
DCF8 CD 2B DD       	CALL	PRINTE7
DCFB ED 4B 8E EF    	LD	BC,(_TXADR)
DCFF 78             	LD	A,B
DD00 F6 38          	OR	038H
DD02 47             	LD	B,A
DD03 CB F2          	SET	6,D
DD05 ED 51          	OUT	(C),D		;Kanji
DD07 CB 98          	RES	3,B
DD09 ED 59          	OUT	(C),E		;Text
DD0B D1             	POP	DE
DD0C AF             	XOR	A
DD0D 32 A2 DC       	LD	(KANFLG+1),A
DD10 18 B4          	JR	KANJIE
DD12                
DD12                KANCLR:
DD12 3A A2 DC       	LD	A,(KANFLG+1)
DD15 B7             	OR	A
DD16 C8             	RET	Z
DD17 ED 4B 8E EF    	LD	BC,(_TXADR)
DD1B 78             	LD	A,B
DD1C F6 38          	OR	038H
DD1E 47             	LD	B,A
DD1F AF             	XOR	A
DD20 32 A2 DC       	LD	(KANFLG+1),A
DD23 ED 79          	OUT	(C),A		;Kanji
DD25 CB 98          	RES	3,B
DD27 3E 20          	LD	A,020H
DD29 ED 79          	OUT	(C),A		;Text
DD2B                PRINTE7:
DD2B CB A0          	RES	4,B
DD2D                PRINTE6:
DD2D 3A 96 EF       	LD	A,(_COLORF)
DD30                PRINTE4:
DD30 ED 79          	OUT	(C),A		;Color
DD32 78             	LD	A,B
DD33 E6 07          	AND	7
DD35 47             	LD	B,A
DD36                PRINTE2:
DD36 03             	INC	BC
DD37                PRINTE3:
DD37 2A BA EF       	LD	HL,(_PAGE_MINUS)
DD3A A7             	AND	A
DD3B ED 4A          	ADC	HL,BC
DD3D                PRINTE8:
DD3D 28 05          	JR	Z,PRINT2
DD3F ED 43 8E EF    	LD	(_TXADR),BC
DD43                CTRL00:
DD43 C9             	RET
DD44                
DD44                PRINT2:
DD44 CD E4 DE       	CALL	SCR
DD47 2A BC EF       	LD	HL,(_WIDTH_MINUS)
DD4A 09             	ADD	HL,BC
DD4B                SET_TXADR_HL:
DD4B 22 8E EF       	LD	(_TXADR),HL
DD4E C9             	RET
DD4F                
DD4F                CTRL08:
DD4F 3A 98 DC       	LD	A,(INSFLG)
DD52 FE CD          	CP	0CDH		;CALL ????
DD54 28 29          	JR	Z,CTRL02
DD56                CTRL1D:
DD56 2A 8E EF       	LD	HL,(_TXADR)
DD59 7C             	LD	A,H
DD5A B5             	OR	L
DD5B C8             	RET	Z
DD5C 2B             	DEC	HL
DD5D 18 EC          	JR	SET_TXADR_HL
DD5F                
DD5F                CTRL1E:
DD5F ED 4B 8E EF    	LD	BC,(_TXADR)
DD63 2A BC EF       	LD	HL,(_WIDTH_MINUS)
DD66 09             	ADD	HL,BC
DD67 D0             	RET	NC
DD68 18 E1          	JR	SET_TXADR_HL
DD6A                
DD6A                CTRL1C:
DD6A ED 4B 8E EF    	LD	BC,(_TXADR)
DD6E 18 C6          	JR	PRINTE2
DD70                
DD70                CTRL09:
DD70 ED 4B 8E EF    	LD	BC,(_TXADR)
DD74 79             	LD	A,C
DD75 E6 F8          	AND	0F8H
DD77 C6 08          	ADD	A,8
DD79 4F             	LD	C,A
DD7A 88             	ADC	A,B
DD7B 91             	SUB	C
DD7C 47             	LD	B,A
DD7D 18 B8          	JR	PRINTE3
DD7F                
DD7F                CTRL02:
DD7F CD 56 DD       	CALL	CTRL1D
DD82 C8             	RET	Z
DD83 D5             	PUSH	DE
DD84 CD D3 EF       	CALL	_POS
DD87 3A B1 EF       	LD	A,(_WIDTH)
DD8A 95             	SUB	L
DD8B 4F             	LD	C,A
DD8C 0D             	DEC	C
DD8D 06 38          	LD	B,038H
DD8F 2A 8E EF       	LD	HL,(_TXADR)
DD92 09             	ADD	HL,BC
DD93 44             	LD	B,H
DD94 4D             	LD	C,L
DD95 11 00 20       	LD	DE,02000H	;D:Text E:kanji
DD98 2A 96 EF       	LD	HL,(_COLORF)	;L:Color
DD9B                C8X1:
DD9B CD 83 DE       	CALL	C12S
DD9E 0B             	DEC	BC
DD9F 20 FA          	JR	NZ,C8X1
DDA1 D1             	POP	DE
DDA2 C9             	RET
DDA3                
DDA3                CTRL05:
DDA3 CD D3 EF       	CALL	_POS
DDA6 3A B1 EF       	LD	A,(_WIDTH)
DDA9 95             	SUB	L
DDAA 6F             	LD	L,A
DDAB                C08X1:
DDAB ED 4B 8E EF    	LD	BC,(_TXADR)
DDAF                LINECL:
DDAF 26 20          	LD	H,020H
DDB1 3A 96 EF       	LD	A,(_COLORF)
DDB4 CB E8          	SET	5,B
DDB6                LINECL1:
DDB6 CB D8          	SET	3,B
DDB8 CB E0          	SET	4,B
DDBA ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DDBC CB 98          	RES	3,B
DDBE ED 61          	OUT	(C),H		;Text
DDC0 CB A0          	RES	4,B
DDC2 ED 79          	OUT	(C),A		;Color
DDC4 03             	INC	BC
DDC5 2D             	DEC	L
DDC6 20 EE          	JR	NZ,LINECL1
DDC8 C9             	RET
DDC9                
DDC9                CTRL0D:
DDC9 CD D3 EF       	CALL	_POS
DDCC 2E 00          	LD	L,0
DDCE                LOC:
DDCE C5             	PUSH	BC
DDCF E5             	PUSH	HL
DDD0 CD 12 DD       	CALL	KANCLR
DDD3 CD F1 DD       	CALL	LOC1
DDD6 22 8E EF       	LD	(_TXADR),HL
DDD9 E1             	POP	HL
DDDA C1             	POP	BC
DDDB C9             	RET
DDDC                
DDDC                CTRL12:
DDDC 21 98 DC       	LD	HL,INSFLG
DDDF 7E             	LD	A,(HL)
DDE0 EE CC          	XOR	0CCH		;CD:CALL ???? 1:LD BC,????
DDE2 77             	LD	(HL),A
DDE3 C9             	RET
DDE4                
DDE4                CTRL0B:
DDE4 21 00 00       	LD	HL,0
DDE7 22 8E EF       	LD	(_TXADR),HL
DDEA C9             	RET
DDEB                
DDEB                CTRL1B:
DDEB 3E 01          	LD	A,1
DDED 32 8F DC       	LD	(ESCFLG+1),A
DDF0 C9             	RET
DDF1                
DDF1                LOC1:
DDF1 D5             	PUSH	DE
DDF2 4D             	LD	C,L
DDF3 06 08          	LD	B,8
DDF5 5C             	LD	E,H
DDF6 16 00          	LD	D,0
DDF8 2A B0 EF       	LD	HL,(CRTCD)
DDFB 6A             	LD	L,D
DDFC                LOC2:
DDFC 29             	ADD	HL,HL
DDFD 30 01          	JR	NC,LOC3
DDFF 19             	ADD	HL,DE
DE00                LOC3:
DE00 10 FA          	DJNZ	LOC2
DE02 09             	ADD	HL,BC
DE03 D1             	POP	DE
DE04 C9             	RET
DE05                
DE05                CONOUT1:
DE05 CD 17 DE       	CALL	CURSOR
DE08 59             	LD	E,C
DE09 CD CD EF       	CALL	_PRINT
DE0C 7B             	LD	A,E
DE0D FE 0A          	CP	00AH
DE0F 20 06          	JR	NZ,CURSOR
DE11 CD C9 DD       	CALL	CTRL0D
DE14 CD A3 DD       	CALL	CTRL05
DE17                CURSOR:
DE17 C5             	PUSH	BC
DE18 ED 4B 8E EF    	LD	BC,(_TXADR)
DE1C CB E8          	SET	5,B
DE1E ED 78          	IN	A,(C)
DE20 EE 18          	XOR	018H
DE22 ED 79          	OUT	(C),A
DE24 C1             	POP	BC
DE25 C9             	RET
DE26                
DE26                CTRL07:
DE26 21 61 EF       	LD	HL,BEEPD
DE29                BEEP1:
DE29 7E             	LD	A,(HL)
DE2A 23             	INC	HL
DE2B FE FF          	CP	0FFH
DE2D C8             	RET	Z
DE2E F3             	DI
DE2F 06 1C          	LD	B,01CH
DE31 ED 79          	OUT	(C),A
DE33 ED A3          	OUTI
DE35 FB             	EI
DE36 18 F1          	JR	BEEP1
DE38                
DE38                OT49SB:
DE38 C5             	PUSH	BC
DE39 CD 54 DE       	CALL	CANW
DE3C 01 00 19       	LD	BC,01900H
DE3F ED 79          	OUT	(C),A
DE41 C1             	POP	BC
DE42 C9             	RET
DE43                
DE43                IN49SB:
DE43 C5             	PUSH	BC
DE44 01 01 1A       	LD	BC,01A01H
DE47                CANR:
DE47 ED 78          	IN	A,(C)
DE49 E6 20          	AND	020H
DE4B 20 FA          	JR	NZ,CANR
DE4D 01 00 19       	LD	BC,01900H
DE50 ED 78          	IN	A,(C)
DE52 C1             	POP	BC
DE53 C9             	RET
DE54                
DE54                CANW:
DE54 01 01 1A       	LD	BC,01A01H
DE57 ED 48          	IN	C,(C)
DE59 CB 71          	BIT	6,C
DE5B 20 F7          	JR	NZ,CANW
DE5D C9             	RET
DE5E                
DE5E                COMOUT:
DE5E FB             	EI
DE5F CD 38 DE       	CALL	OT49SB
DE62 CD 54 DE       	CALL	CANW
DE65 F3             	DI
DE66 C9             	RET
DE67                
DE67                INSERT:
DE67 D5             	PUSH	DE
DE68 CD D3 EF       	CALL	_POS
DE6B 3A B1 EF       	LD	A,(_WIDTH)
DE6E 95             	SUB	L
DE6F ED 4B 8E EF    	LD	BC,(_TXADR)
DE73 11 00 20       	LD	DE,02000H	;D:Text E:Kanji
DE76 2A 96 EF       	LD	HL,(_COLORF)	;L:Color
DE79 CB E8          	SET	5,B
DE7B                C12X1:
DE7B CD 83 DE       	CALL	C12S
DE7E 03             	INC	BC
DE7F 20 FA          	JR	NZ,C12X1
DE81 D1             	POP	DE
DE82 C9             	RET
DE83                
DE83                C12S:
DE83 CB E0          	SET	4,B
DE85 CB D8          	SET	3,B
DE87 ED 60          	IN	H,(C)
DE89 ED 59          X1PAT:	OUT	(C),E
DE8B 5C             	LD	E,H
DE8C CB 98          	RES	3,B
DE8E ED 60          	IN	H,(C)
DE90 ED 51          	OUT	(C),D
DE92 54             	LD	D,H
DE93 CB A0          	RES	4,B
DE95 ED 60          	IN	H,(C)
DE97 ED 69          	OUT	(C),L
DE99 6C             	LD	L,H
DE9A 3D             	DEC	A
DE9B C9             	RET
DE9C                
DE9C                CTRL0C:
DE9C CD E4 DD       	CALL	CTRL0B
DE9F                CTRL06:
DE9F ED 4B 8E EF    	LD	BC,(_TXADR)
DEA3                C1AX1:
DEA3 78             	LD	A,B
DEA4 F6 38          	OR	038H
DEA6 47             	LD	B,A
DEA7 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DEA9 CB 98          	RES	3,B
DEAB 3E 20          	LD	A,020H
DEAD ED 79          	OUT	(C),A		;Text
DEAF CB A0          	RES	4,B
DEB1 3A 96 EF       	LD	A,(_COLORF)
DEB4 ED 79          	OUT	(C),A		;Color
DEB6 03             	INC	BC
DEB7 CB A8          	RES	5,B
DEB9 2A BA EF       	LD	HL,(_PAGE_MINUS)
DEBC 09             	ADD	HL,BC
DEBD 30 E4          	JR	NC,C1AX1
DEBF C9             	RET
DEC0                
DEC0                CTRL04:
DEC0 CD D3 EF       	CALL	_POS
DEC3 7D             	LD	A,L
DEC4 B7             	OR	A
DEC5 C8             	RET	Z
DEC6                CTRL03:
DEC6 CD C9 DD       	CALL	CTRL0D
DEC9                CTRL0A:
DEC9                CTRL1F:
DEC9 ED 4B 8E EF    	LD	BC,(_TXADR)
DECD 2A B1 EF       	LD	HL,(_WIDTH)
DED0 26 00          	LD	H,0
DED2 09             	ADD	HL,BC
DED3 44             	LD	B,H
DED4 4D             	LD	C,L
DED5 2A BA EF       	LD	HL,(_PAGE_MINUS)
DED8 09             	ADD	HL,BC
DED9 3F             	CCF
DEDA 9F             	SBC	A,A
DEDB C3 3D DD       	JP	PRINTE8
DEDE                
DEDE                CTRL0E:
DEDE CD D3 EF       	CALL	_POS
DEE1 7C             	LD	A,H
DEE2 18 04          	JR	SCR1
DEE4                SCR:
DEE4 3A 97 EF       	LD	A,(_LINE)
DEE7 3D             	DEC	A
DEE8                SCR1:
DEE8 C5             	PUSH	BC
DEE9 D5             	PUSH	DE
DEEA F5             	PUSH	AF
DEEB 3E 07          	LD	A,7
DEED 21 1E DF       	LD	HL,SCRDMAD
DEF0 CD 14 DF       	CALL	SETDMA
DEF3 F1             	POP	AF
DEF4 21 00 38       	LD	HL,03800H
DEF7                
DEF7                SCRUP1:
DEF7 B7             	OR	A
DEF8 28 4D          	JR	Z,SCRCL
DEFA F5             	PUSH	AF
DEFB CD 25 DF       	CALL	UPSUB		;kanji
DEFE 3A BC EF       	LD	A,(_WIDTH_MINUS)
DF01 5F             	LD	E,A
DF02 16 F7          	LD	D,0F7H
DF04 19             	ADD	HL,DE
DF05 D5             	PUSH	DE
DF06 CD 25 DF       	CALL	UPSUB		;Text
DF09 D1             	POP	DE
DF0A 19             	ADD	HL,DE
DF0B CD 25 DF       	CALL	UPSUB		;Color
DF0E CB E4          	SET	4,H
DF10 F1             	POP	AF
DF11 3D             	DEC	A
DF12 18 E3          	JR	SCRUP1
DF14                
DF14                SETDMA:
DF14 01 87 1F       	LD	BC,01F87H
DF17                SDMA:
DF17 04             	INC	B
DF18 ED A3          	OUTI
DF1A 3D             	DEC	A
DF1B 20 FA          	JR	NZ,SDMA
DF1D C9             	RET
DF1E                
DF1E                SCRDMAD:
DF1E C3             	DB	0C3H		;WR6 リセット
DF1F 9A             	DB	09AH		;WR5 ストップ WAIT READY:HIGH
DF20 65             	DB	065H		;WR0 ブロック長(LH)
DF21 4F 00          	DW	79
DF23 1C             	DB	01CH		;WR1 ポートAインクリメント I/O
DF24 18             	DB	018H		;WR0 ポートAアドレス(LH)
DF25                
DF25                UPSUB:
DF25 3A B1 EF       	LD	A,(_WIDTH)
DF28 5F             	LD	E,A
DF29 16 00          	LD	D,0
DF2B 3E CD          	LD	A,0CDH		;WR4 バースト ポートB開始アドレス(LH)
DF2D ED 79          	OUT	(C),A
DF2F ED 69          	OUT	(C),L		;SOURCE
DF31 ED 61          	OUT	(C),H
DF33 19             	ADD	HL,DE
DF34 3E 1D          	LD	A,01DH		;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
DF36 ED 79          	OUT	(C),A
DF38 ED 69          	OUT	(C),L		;DEST
DF3A ED 61          	OUT	(C),H
DF3C                GO_DMA:
DF3C 3E CF          	LD	A,0CFH
DF3E ED 79          	OUT	(C),A		;WR6 ロード
DF40 3E B3          	LD	A,0B3H
DF42 ED 79          	OUT	(C),A		;WR6 強制RDY
DF44 ED 49          	OUT	(C),C		;WR6 イネーブル
DF46 C9             	RET
DF47                
DF47                SCRCL:
DF47 44             	LD	B,H
DF48 4D             	LD	C,L
DF49 2A B1 EF       	LD	HL,(_WIDTH)
DF4C CD AF DD       	CALL	LINECL
DF4F D1             	POP	DE
DF50 C1             	POP	BC
DF51 C9             	RET
DF52                
DF52                SCRN:
DF52 D5             	PUSH	DE
DF53 ED 58          	IN	E,(C)		;Text
DF55 3A 18 00       	LD	A,(00018H)
DF58 3C             	INC	A
DF59 28 1E          	JR	Z,SCRN2
DF5B CB D8          	SET	3,B
DF5D ED 50          	IN	D,(C)		;Kanji
DF5F 28 16          	JR	Z,SCRN1
DF61 AF             	XOR	A
DF62 C5             	PUSH	BC
DF63 01 37 30       	LD	BC,03037H	;VRMJIS
DF66 DF             	RST	018H
DF67 01 52 2F       	LD	BC,02F52H	;JISSFT
DF6A DF             	RST	018H
DF6B C1             	POP	BC
DF6C ED 78          	IN	A,(C)
DF6E CB 98          	RES	3,B
DF70 E6 40          	AND	040H
DF72 20 05          	JR	NZ,SCRN2
DF74 7A             	LD	A,D
DF75 D1             	POP	DE
DF76 C9             	RET
DF77                SCRN1:
DF77 CB 98          	RES	3,B
DF79                SCRN2:
DF79 7B             	LD	A,E
DF7A D1             	POP	DE
DF7B C9             	RET
DF7C                SCRNE:
DF7C                POS:
DF7C 2A 8E EF       	LD	HL,(_TXADR)
DF7F C5             	PUSH	BC
DF80 ED 4B BC EF    	LD	BC,(_WIDTH_MINUS)
DF84 AF             	XOR	A
DF85                POS1:
DF85 09             	ADD	HL,BC
DF86 3C             	INC	A
DF87 38 FC          	JR	C,POS1
DF89 ED 42          	SBC	HL,BC
DF8B 3D             	DEC	A
DF8C 67             	LD	H,A
DF8D C1             	POP	BC
DF8E A7             	AND	A
DF8F C9             	RET
DF90                
DF90                GETL:
DF90 CD D3 EF       	CALL	_POS
DF93 E5             	PUSH	HL
DF94 3E CD          	LD	A,0CDH		;CALL ????
DF96 32 98 DC       	LD	(INSFLG),A
DF99                GETL1:
DF99 CD 51 DB       	CALL	_SYS08
DF9C FE 09          	CP	9
DF9E 20 08          	JR	NZ,GETL1V
DFA0 21 00 FF       	LD	HL,KBUF
DFA3 CD F5 D7       	CALL	MSX
DFA6 18 F1          	JR	GETL1
DFA8                GETL1V:
DFA8 5F             	LD	E,A
DFA9 CD CD EF       	CALL	_PRINT
DFAC                
DFAC 7B             	LD	A,E
DFAD FE 0D          	CP	00DH
DFAF 20 E8          	JR	NZ,GETL1
DFB1 3E 01          	LD	A,1		;LD BC,????
DFB3 32 98 DC       	LD	(INSFLG),A
DFB6 11 00 FF       	LD	DE,KBUF
DFB9 3A B1 EF       	LD	A,(_WIDTH)
DFBC 47             	LD	B,A
DFBD CD E8 D4       	CALL	ZERO_MEMORY_DE
DFC0                
DFC0 D1             	POP	DE
DFC1 CD D3 EF       	CALL	_POS
DFC4 6B             	LD	L,E
DFC5 3A B1 EF       	LD	A,(_WIDTH)
DFC8 95             	SUB	L
DFC9 57             	LD	D,A
DFCA CD F1 DD       	CALL	LOC1
DFCD 4D             	LD	C,L
DFCE 7C             	LD	A,H
DFCF F6 30          	OR	030H
DFD1 47             	LD	B,A
DFD2 5A             	LD	E,D
DFD3 21 00 FF       	LD	HL,KBUF
DFD6                GETL2:
DFD6 CD D0 EF       	CALL	_SCRN
DFD9 03             	INC	BC
DFDA 77             	LD	(HL),A
DFDB 23             	INC	HL
DFDC 1D             	DEC	E
DFDD 20 F7          	JR	NZ,GETL2
DFDF                GETL3:
DFDF 2B             	DEC	HL
DFE0 7E             	LD	A,(HL)
DFE1 FE 21          	CP	021H
DFE3 D0             	RET	NC
DFE4 36 00          	LD	(HL),0
DFE6 15             	DEC	D
DFE7 20 F6          	JR	NZ,GETL3
DFE9 C9             	RET
DFEA                
DFEA                INKEY:
DFEA FB             	EI
DFEB E5             	PUSH	HL
DFEC 2A 90 EF       	LD	HL,(_KEYPS)
DFEF 7C             	LD	A,H
DFF0 AD             	XOR	L
DFF1 28 09          	JR	Z,INKEY1
DFF3 7C             	LD	A,H
DFF4 3C             	INC	A
DFF5 32 91 EF       	LD	(_KEYPS+1),A
DFF8 6F             	LD	L,A
DFF9 26 FE          	LD	H,KEYBF/256
DFFB 7E             	LD	A,(HL)
DFFC                INKEY1:
DFFC E1             	POP	HL
DFFD B7             	OR	A
DFFE C9             	RET
DFFF                
DFFF 00 00 0F DA    AT_RS	EQU	SCR1-AT_SCR1
DFFF                	INCLUDE	"LDFILE.ASM"
DFFF                
DFFF                ;	LSX-Dodgers FILE
DFFF                
DFFF                FILEC:
DFFF CD 0A E0       	CALL	FILE
E002                FILEC2:
E002 3A 15 EF       	LD	A,(FDRV+1)
E005 FE 20          	CP	020H
E007 C8             	RET	Z
E008 18 39          	JR	SETDIR1
E00A                
E00A                FILE:
E00A AF             	XOR	A
E00B 32 14 EF       	LD	(FDRV),A
E00E 67             	LD	H,A
E00F 6F             	LD	L,A
E010 22 22 EF       	LD	(FDRV+14),HL
E013 CD E1 E0       	CALL	SPCUT
E016 CD C6 E0       	CALL	CCHK3
E019 28 12          	JR	Z,DEVI1
E01B 13             	INC	DE
E01C 1A             	LD	A,(DE)
E01D 1B             	DEC	DE
E01E FE 3A          	CP	':'
E020 20 0B          	JR	NZ,DEVI1
E022 1A             	LD	A,(DE)		;DRIVE
E023 CD 16 E3       	CALL	CAP
E026 D6 40          	SUB	'@'
E028 13             	INC	DE
E029 13             	INC	DE
E02A 32 14 EF       	LD	(FDRV),A
E02D                DEVI1:
E02D 1A             	LD	A,(DE)
E02E D6 5C          	SUB	05CH		;\
E030 20 09          	JR	NZ,NOROOT
E032 6F             	LD	L,A		;A=0でH=0のはずなのでHL=0
E033 22 2E EF       	LD	(FDRV+26),HL
E036 2C             	INC	L
E037 22 22 EF       	LD	(FDRV+14),HL
E03A 13             	INC	DE
E03B                NOROOT:
E03B                
E03B                SETDIR:
E03B CD 67 E0       	CALL	FILED
E03E 1A             	LD	A,(DE)
E03F FE 5C          	CP	05CH		;\
E041 C0             	RET	NZ
E042 13             	INC	DE
E043                SETDIR1:
E043 3E 10          	LD	A,010H		;Directory
E045 32 21 EF       	LD	(FDRV+13),A
E048 D5             	PUSH	DE
E049 11 14 EF       	LD	DE,FDRV
E04C 2A 1E F0       	LD	HL,(STABLE+2*00FH)
E04F CD 0F 00       	CALL	JP_HL
E052 D1             	POP	DE
E053 B7             	OR	A
E054 C0             	RET	NZ
E055                
E055 3A 21 EF       	LD	A,(FDRV+13)
E058 CB 67          	BIT	4,A
E05A C8             	RET	Z
E05B                
E05B CD AE E0       	CALL	FILEI
E05E 2A 2E EF       	LD	HL,(FDRV+26)
E061 23             	INC	HL
E062 22 22 EF       	LD	(FDRV+14),HL
E065 18 D4          	JR	SETDIR
E067                
E067                FILED:
E067 CD AE E0       	CALL	FILEI
E06A 21 15 EF       	LD	HL,FNAME
E06D                
E06D 06 08          	LD	B,8
E06F                FILE2:
E06F CD BB E0       	CALL	CCHKF
E072 C8             	RET	Z
E073 FE 2A          	CP	'*'
E075 28 2E          	JR	Z,FILE9
E077 FE 2E          	CP	'.'
E079 28 0C          	JR	Z,FILE4
E07B 77             	LD	(HL),A
E07C 23             	INC	HL
E07D 10 F0          	DJNZ	FILE2
E07F                
E07F                FILE3:
E07F CD BB E0       	CALL	CCHKF
E082 C8             	RET	Z
E083 FE 2E          	CP	'.'
E085 20 F8          	JR	NZ,FILE3
E087                
E087                FILE4:
E087 21 1D EF       	LD	HL,FNAME+8
E08A 06 03          	LD	B,3
E08C                
E08C                FILE4L:
E08C CD BB E0       	CALL	CCHKF
E08F C8             	RET	Z
E090 FE 2E          	CP	'.'
E092 20 08          	JR	NZ,FILE12
E094 32 15 EF       	LD	(FNAME),A	;Parent directory(..)
E097 32 16 EF       	LD	(FNAME+1),A
E09A 3E 20          	LD	A,020H
E09C                FILE12:
E09C FE 2A          	CP	'*'
E09E 28 0A          	JR	Z,FILE10
E0A0 77             	LD	(HL),A
E0A1 23             	INC	HL
E0A2 10 E8          	DJNZ	FILE4L
E0A4 C9             	RET
E0A5                
E0A5                FILE9:				;名前の*処理、名前の残りを?で埋める
E0A5 CD AA E0       	CALL	FILE10
E0A8 18 D5          	JR	FILE3
E0AA                
E0AA                FILE10:
E0AA 3E 3F          	LD	A,'?'
E0AC 18 08          	JR	FILL_MEMORY
E0AE                FILEI:				;名前＋拡張子をスペースで初期化
E0AE 3E 20          	LD	A,020H
E0B0 01 00 0B       	LD	BC,11*256	;C=0にしておく
E0B3 21 15 EF       	LD	HL,FNAME
E0B6                FILL_MEMORY:			;HLからBバイトAで埋める
E0B6 77             	LD	(HL),A
E0B7 23             	INC	HL
E0B8 10 FC          	DJNZ	FILL_MEMORY
E0BA C9             	RET
E0BB                
E0BB                CCHKF:
E0BB 1A             	LD	A,(DE)
E0BC CD C3 E0       	CALL	CCHK2
E0BF C8             	RET	Z
E0C0 C3 2E E4       	JP	FKAN
E0C3                
E0C3                CCHK2:
E0C3 0C             	INC	C
E0C4 0D             	DEC	C
E0C5 C0             	RET	NZ
E0C6                CCHK3:				;ZF=1 で使えない文字
E0C6 FE 2B          	CP	'+'
E0C8 C8             	RET	Z
E0C9 FE 2C          	CP	','
E0CB C8             	RET	Z
E0CC FE 2F          	CP	'/'
E0CE C8             	RET	Z
E0CF FE 3A          	CP	':'
E0D1 C8             	RET	Z
E0D2 FE 3B          	CP	';'
E0D4 C8             	RET	Z
E0D5 FE 3D          	CP	'='
E0D7 C8             	RET	Z
E0D8 FE 5C          	CP	05CH	;\
E0DA C8             	RET	Z
E0DB FE 20          	CP	020H
E0DD D0             	RET	NC
E0DE BF             	CP	A		;Z=1
E0DF C9             	RET
E0E0                
E0E0                SS1:
E0E0 13             	INC	DE
E0E1                SPCUT:				;スペースをカット
E0E1 1A             	LD	A,(DE)
E0E2 FE 20          	CP	020H
E0E4 28 FA          	JR	Z,SS1
E0E6 C9             	RET
E0E7                
E0E7                SETDRVF:
E0E7 11 14 EF       	LD	DE,FDRV
E0EA                SETDRV0:
E0EA CD F3 E0       	CALL	SETDRV
E0ED FD E1          	POP	IY
E0EF C1             	POP	BC
E0F0 D1             	POP	DE
E0F1 E1             	POP	HL
E0F2 C9             	RET
E0F3                
E0F3                SETDRV:
E0F3 E3             	EX	(SP),HL		;HL=RETRN ADDRESS
E0F4 D5             	PUSH	DE		;PUSH HL/DE/BC/IY
E0F5 C5             	PUSH	BC
E0F6 1A             	LD	A,(DE)
E0F7 D5             	PUSH	DE
E0F8 FD E3          	EX	(SP),IY
E0FA                
E0FA CD 06 E1       	CALL	GETDRV
E0FD 3C             	INC	A
E0FE FD 77 00       	LD	(IY+0),A	;(FCB)ドライブ番号
E101 3D             	DEC	A
E102 CD D9 EF       	CALL	_CHGDRV
E105                
E105 E9             	JP	(HL)
E106                
E106                GETDRV:
E106 E6 7F          	AND	07FH
E108 D6 01          	SUB	001H
E10A 30 03          	JR	NC,GETDRV1
E10C 3A 87 EF       	LD	A,(_DVSW)	;Current Drive
E10F                GETDRV1:
E10F 32 88 EF       	LD	(_DRV),A
E112 C9             	RET
E113                
E113                SOPENX:
E113 11 39 EF       	LD	DE,SFILE
E116 1A             	LD	A,(DE)
E117 FD BE 00       	CP	(IY+0)		;(FCB)ドライブ番号
E11A 20 24          	JR	NZ,SOPEN
E11C 13             	INC	DE
E11D FD E5          	PUSH	IY
E11F E1             	POP	HL
E120 23             	INC	HL
E121 CD AE E2       	CALL	CPFILE
E124 20 1A          	JR	NZ,SOPEN
E126                
E126 2A F4 F0       	LD	HL,(SCDIR)
E129 FD 75 0E       	LD	(IY+14),L	;(FCB)アクセスするディレクトリのクラスタ番号+1
E12C FD 74 0F       	LD	(IY+15),H
E12F                
E12F 2A F8 F0       	LD	HL,(SFNDF)	;Direcroty location and Flags
E132 22 9F EF       	LD	(_FILEN),HL
E135                
E135 ED 5B F6 F0    	LD	DE,(SFBPS)
E139 21 39 EF       	LD	HL,SFILE
E13C 36 FF          	LD	(HL),0FFH
E13E 23             	INC	HL
E13F C9             	RET
E140                SOPEN:
E140 21 56 E2       	LD	HL,FILESE
E143                SOPENC:
E143 22 7C E1       	LD	(OPENPAT+1),HL
E146                
E146 CD E2 EF       	CALL	_RDFATX		;Detect Media
E149 38 56          	JR	C,RDDERR
E14B                
E14B AF             	XOR	A
E14C 32 9F EF       	LD	(_FILEN),A
E14F CD 5B E3       	CALL	LDDIRX1		;A=0で呼び出す
E152 28 18          	JR	Z,SDIRX1
E154                
E154 CD 47 E2       	CALL	READ_DIR	;Sub Directory
E157 38 08          	JR	C,SDIRX0
E159 2A 7E F0       	LD	HL,(_DTBUF)
E15C 7E             	LD	A,(HL)
E15D FE 2E          	CP	'.'
E15F 28 0F          	JR	Z,SOPEN1
E161                SDIRX0:
E161 AF             	XOR	A
E162 32 A0 EF       	LD	(_DIRF),A
E165 FD 36 0E 01    	LD	(IY+14),1	;(FCB)レコードサイズ
E169 FD 77 0F       	LD	(IY+15),A
E16C                SDIRX1:
E16C ED 5B FC F0    	LD	DE,(_DIRPS)	;Root Directory
E170                SOPEN1:
E170 0E 20          SDECPAT:LD	C,32		;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
E172                SOPEN1X:
E172 CD 47 E2       	CALL	READ_DIR	;FILE SEARCH
E175 38 2A          	JR	C,RDDERR
E177 2A 7E F0       	LD	HL,(_DTBUF)
E17A                SOPEN2:
E17A D5             	PUSH	DE
E17B CD 56 E2       OPENPAT:CALL	FILESE		;(self-modifying code)
E17E D1             	POP	DE
E17F 38 6E          	JR	C,SOPENE
E181 28 1B          	JR	Z,SCF_FF_RET
E183                SOPEN3:
E183 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E186 B7             	OR	A
E187 20 0C          	JR	NZ,SOPEN5
E189 13             	INC	DE		;ルートディレクトリ
E18A E5             	PUSH	HL
E18B 21 0C 00       MD_PAT:	LD	HL,12		;(self-modifying code)MAXDIR
E18E ED 52          	SBC	HL,DE		;CF=0 なので SUB HL,DE
E190 E1             	POP	HL
E191 20 DD          	JR	NZ,SOPEN1
E193 18 07          	JR	SOPEN6
E195                SOPEN5:
E195 CD 8A EA       	CALL	GNCLX		;END DIR
E198 D8             	RET	C
E199 CD 0E E3       	CALL	ENDCL
E19C                SOPEN6:
E19C 38 D2          	JR	C,SOPEN1
E19E                SCF_FF_RET:
E19E 37             	SCF			;CF=1
E19F 9F             	SBC	A,A		;A=0FFH
E1A0 C9             	RET
E1A1                
E1A1                RDDERR:
E1A1 BF             	CP	A		;READ ERR CF=1 ZF=1
E1A2 37             	SCF
E1A3 C9             	RET
E1A4                
E1A4                NOPEN:
E1A4 21 56 E2       	LD	HL,FILESE
E1A7 22 7C E1       	LD	(OPENPAT+1),HL
E1AA FD 2A 98 EF    	LD	IY,(_FCB)
E1AE CD 41 E4       	CALL	CHKWILDX
E1B1 30 EB          	JR	NC,SCF_FF_RET
E1B3 FD 7E 00       	LD	A,(IY+0)	;(FCB)ドライブ番号
E1B6 3D             	DEC	A
E1B7 32 88 EF       	LD	(_DRV),A
E1BA CD D9 EF       	CALL	_CHGDRV
E1BD D8             	RET	C
E1BE 2A F8 F0       	LD	HL,(SFNDF)	;Direcroty location and Flags
E1C1 22 9F EF       	LD	(_FILEN),HL
E1C4                
E1C4 CD 56 E3       	CALL	LDDIRX
E1C7 ED 5B 9A EF    	LD	DE,(_FBPS)
E1CB CD 47 E2       	CALL	READ_DIR
E1CE 38 D1          	JR	C,RDDERR
E1D0 3A 9E EF       	LD	A,(_FBCNT)
E1D3 3D             	DEC	A
E1D4 28 AD          	JR	Z,SOPEN3
E1D6                NOPEN2:
E1D6 2A 9C EF       	LD	HL,(_FBAD)
E1D9 01 20 00       	LD	BC,020H
E1DC 09             	ADD	HL,BC
E1DD 4F             	LD	C,A
E1DE 18 9A          	JR	SOPEN2
E1E0                
E1E0                SOPENE2:
E1E0 22 9C EF       	LD	(_FBAD),HL
E1E3 79             	LD	A,C
E1E4 32 9E EF       	LD	(_FBCNT),A
E1E7 ED 53 9A EF    	LD	(_FBPS),DE
E1EB FD 22 98 EF    	LD	(_FCB),IY
E1EF                SOPENE:
E1EF AF             	XOR	A
E1F0 C9             	RET
E1F1                
E1F1                COPEN:
E1F1 FD 36 0D 20    	LD	(IY+13),020H	;(FCB)属性(アトリビュート)
E1F5                
E1F5 21 73 E2       	LD	HL,NEXTSE
E1F8 CD 43 E1       	CALL	SOPENC
E1FB D0             	RET	NC
E1FC C8             	RET	Z
E1FD 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E200 B7             	OR	A
E201 37             	SCF
E202 C8             	RET	Z		;ルートディレクトリ
E203 06 01          	LD	B,1
E205 CD 9F E4       	CALL	WRDF
E208 D8             	RET	C
E209 ED 5B FE F0    	LD	DE,(_CLPS)
E20D D5             	PUSH	DE
E20E CD D7 E2       	CALL	DCPAT
E211 CD 15 E9       	CALL	DRDNX
E214 2A 7E F0       	LD	HL,(_DTBUF)	;ディレクトリエントリを0クリア
E217 3A 13 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E21A 47             	LD	B,A
E21B AF             	XOR	A
E21C 4F             	LD	C,A
E21D                COPENCL:
E21D 77             	LD	(HL),A
E21E ED A1          	CPI			;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
E220 EA 1D E2       	JP	PE,COPENCL
E223                
E223 3A F5 E2       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ数
E226 3D             	DEC	A
E227 28 19          	JR	Z,COPENE
E229 3E 01          	LD	A,1		;1セクタ辺りのセクタ数が2以上の場合
E22B 32 82 EA       	LD	(_SECPS+1),A
E22E D1             	POP	DE		;DE=(_CLPS)
E22F D5             	PUSH	DE
E230                COPEN1:
E230 D5             	PUSH	DE		;データバッファに入らないセクタもゼロクリア
E231 C5             	PUSH	BC
E232 2A 7E F0       	LD	HL,(_DTBUF)
E235 CD F1 E2       	CALL	CLUSTX
E238 CD ED EB       	CALL	DWT24
E23B C1             	POP	BC
E23C D1             	POP	DE
E23D CD 81 EA       	CALL	NEXTX
E240 20 EE          	JR	NZ,COPEN1
E242                COPENE:
E242 2A 7E F0       	LD	HL,(_DTBUF)
E245 D1             	POP	DE
E246 C9             	RET
E247                
E247                READ_DIR:
E247 ED 53 FE F0    	LD	(_CLPS),DE
E24B C5             	PUSH	BC
E24C D5             	PUSH	DE
E24D CD D7 E2       	CALL	DCPAT
E250 CD F5 E8       	CALL	DRDX
E253 D1             	POP	DE
E254 C1             	POP	BC
E255 C9             	RET
E256                
E256                FILESE:
E256 7E             	LD	A,(HL)
E257 B7             	OR	A
E258 C8             	RET	Z		;END:ZF=1 CF=0
E259 FE E5          	CP	0E5H
E25B 28 0E          	JR	Z,FILESE1
E25D FD E5          	PUSH	IY
E25F D1             	POP	DE
E260 13             	INC	DE
E261 E5             	PUSH	HL
E262 CD AE E2       	CALL	CPFILE
E265 CC CF E2       	CALL	Z,CPFILE2
E268 E1             	POP	HL
E269 37             	SCF
E26A C8             	RET	Z		;!!!:(ZF=1) CF=1
E26B                FILESE1:
E26B CD 82 E2       	CALL	FNEXT
E26E 20 E6          	JR	NZ,FILESE
E270                ZF0_CF0_AFF_RET:
E270 F6 FF          	OR	0FFH		;ZF=0 CF=0
E272 C9             	RET
E273                
E273                NEXTSE:
E273 7E             	LD	A,(HL)
E274 B7             	OR	A
E275 37             	SCF
E276 C8             	RET	Z		;!!!:ZF=1 CF=1
E277 FE E5          	CP	0E5H
E279 37             	SCF
E27A C8             	RET	Z		;!!!:(ZF=1) CF=1
E27B CD 82 E2       	CALL	FNEXT
E27E 20 F3          	JR	NZ,NEXTSE
E280 18 EE          	JR	ZF0_CF0_AFF_RET
E282                
E282                FNEXT:
E282 E5             	PUSH	HL
E283 21 9F EF       	LD	HL,_FILEN
E286 34             	INC	(HL)
E287 E1             	POP	HL
E288 11 20 00       	LD	DE,020H
E28B 19             	ADD	HL,DE
E28C 0D             	DEC	C
E28D C9             	RET
E28E                
E28E                CPNAME:
E28E C5             	PUSH	BC
E28F D5             	PUSH	DE
E290 E5             	PUSH	HL
E291 CD A8 E2       	CALL	CPFILE4
E294 E1             	POP	HL
E295 23             	INC	HL
E296 23             	INC	HL
E297 23             	INC	HL
E298 23             	INC	HL
E299 D1             	POP	DE
E29A C1             	POP	BC
E29B 20 05          	JR	NZ,CPNAME1
E29D 7E             	LD	A,(HL)
E29E 23             	INC	HL
E29F 66             	LD	H,(HL)
E2A0 6F             	LD	L,A
E2A1 C9             	RET
E2A2                CPNAME1:
E2A2 23             	INC	HL
E2A3 23             	INC	HL
E2A4 10 E8          	DJNZ	CPNAME
E2A6 37             	SCF
E2A7 C9             	RET
E2A8                
E2A8                CPFILE4:
E2A8 C5             	PUSH	BC
E2A9 01 00 04       	LD	BC,00400H
E2AC 18 04          	JR	CPSTR1
E2AE                CPFILE:
E2AE C5             	PUSH	BC
E2AF 01 00 0B       	LD	BC,00B00H
E2B2                CPSTR1:
E2B2 1A             	LD	A,(DE)
E2B3 FE 3F          	CP	'?'		;Wild card
E2B5 28 12          	JR	Z,CPSTR2
E2B7 7E             	LD	A,(HL)
E2B8 CD 27 E4       	CALL	FKANC
E2BB E5             	PUSH	HL
E2BC 67             	LD	H,A
E2BD 1A             	LD	A,(DE)
E2BE CB 01          	RLC	C
E2C0 CD 27 E4       	CALL	FKANC
E2C3 CB 09          	RRC	C
E2C5 BC             	CP	H		;CP (HL),(DE)
E2C6 E1             	POP	HL
E2C7 20 04          	JR	NZ,CPSTR3
E2C9                CPSTR2:
E2C9 13             	INC	DE
E2CA 23             	INC	HL
E2CB 10 E5          	DJNZ	CPSTR1
E2CD                CPSTR3:
E2CD C1             	POP	BC
E2CE C9             	RET
E2CF                
E2CF                CPFILE2:
E2CF FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E2D2 F6 E1          	OR	0E1H
E2D4 2F             	CPL
E2D5 A6             	AND	(HL)
E2D6 C9             	RET
E2D7                
E2D7                DCPAT:
E2D7 0E 00          	LD	C,0
E2D9 2A 7E F0       	LD	HL,(_DTBUF)
E2DC 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E2DF B7             	OR	A
E2E0 C8             	RET	Z		;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
E2E1 3A F5 E2       	LD	A,(SPCPAT+1)
E2E4 4F             	LD	C,A
E2E5 3A 82 EA       	LD	A,(_SECPS+1)
E2E8 B9             	CP	C
E2E9 38 01          	JR	C,DC1
E2EB AF             	XOR	A
E2EC                DC1:
E2EC F6 80          	OR	080H
E2EE 32 A0 EF       	LD	(_DIRF),A	;bit0-6:セクタインデックス
E2F1                CLUSTX:
E2F1 E5             	PUSH	HL
E2F2 EB             	EX	DE,HL
E2F3 AF             	XOR	A
E2F4 0E 01          SPCPAT:	LD	C,1		;自己書き換え（1クラスタの論理セクタ数）
E2F6                L_CLDBL:
E2F6 CB 19          	RR	C		;->CF
E2F8 38 04          	JR	C,E_CLDBL
E2FA 29             	ADD	HL,HL		;*2
E2FB 8F             	ADC	A,A
E2FC 18 F8          	JR	L_CLDBL
E2FE                E_CLDBL:
E2FE 4F             	LD	C,A
E2FF 3A 82 EA       	LD	A,(_SECPS+1)
E302 B5             	OR	L
E303 6F             	LD	L,A
E304 11 08 00       CLSPAT:	LD	DE,8	;+8 (2D)  !ADDCL (self-modifying code)
E307 AF             	XOR	A
E308 19             	ADD	HL,DE	;データ格納領域の先頭論理セクタ番号
E309 89             	ADC	A,C
E30A 4F             	LD	C,A
E30B EB             	EX	DE,HL
E30C E1             	POP	HL
E30D C9             	RET
E30E                
E30E                ENDCL:
E30E 7A             	LD	A,D	;END CLUSTER
E30F FE 01          CLPAT1:	CP	1	;164=356	(self-modifying code)
E311 C0             	RET	NZ
E312 7B             	LD	A,E
E313 FE 64          CLPAT2:	CP	064H	;		(self-modifying code)
E315 C9             	RET
E316                
E316                CAP:
E316 FE 61          	CP	'a'
E318 D8             	RET	C
E319 FE 7B          	CP	'z'+1
E31B D0             	RET	NC
E31C D6 20          	SUB	020H
E31E C9             	RET
E31F                CAP2:
E31F CD 16 E3       	CALL	CAP
E322                CAP3:
E322 CD 2B E3       	CALL	CAP4
E325 FE 21          	CP	021H
E327 D0             	RET	NC
E328 3E A0          	LD	A,0A0H
E32A C9             	RET
E32B                CAP4:
E32B FE 05          	CP	5
E32D C0             	RET	NZ
E32E 3E E5          	LD	A,0E5H
E330 C9             	RET
E331                
E331                CHDIR:
E331 CD 1B ED       	CALL	GETDPBD
E334 38 1D          	JR	C,CHDIR2
E336 DD 75 1A       	LD	(IX+01AH),L		;_SDIR_
E339 DD 74 1B       	LD	(IX+01BH),H		;_SDIR_+1
E33C 18 15          	JR	CHDIR2		;POP_IX_RET
E33E                
E33E                LDDIR:
E33E CD 1B ED       	CALL	GETDPBD
E341 DD 5E 1A       	LD	E,(IX+01AH)		;_SDIR_
E344 DD 56 1B       	LD	D,(IX+01BH)		;_SDIR_+1
E347 13             	INC	DE
E348 FD 73 0E       	LD	(IY+14),E	;(FCB)アクセスするディレクトリのクラスタ番号+1
E34B FD 72 0F       	LD	(IY+15),D
E34E 1B             	DEC	DE
E34F AF             	XOR	A
E350 32 A0 EF       	LD	(_DIRF),A
E353                CHDIR2:
E353 DD E1          	POP	IX
E355 C9             	RET
E356                
E356                LDDIRX:
E356 3A A0 EF       	LD	A,(_DIRF)	;(FCB)アクセスするディレクトリのセクタインデックス
E359 E6 7F          	AND	07FH
E35B                LDDIRX1:
E35B 32 82 EA       	LD	(_SECPS+1),A
E35E FD 5E 0E       	LD	E,(IY+14)	;(FCB)アクセスするディレクトリのクラスタ番号+1
E361 FD 56 0F       	LD	D,(IY+15)
E364 1B             	DEC	DE
E365 CD 0E E3       	CALL	ENDCL
E368 D4 3E E3       	CALL	NC,LDDIR
E36B                LDDIRS:
E36B 7A             	LD	A,D
E36C B3             	OR	E
E36D 32 A0 EF       	LD	(_DIRF),A	;ディレクトリか判別
E370 C9             	RET
E371                
E371                KILL:
E371 CD 41 E4       	CALL	CHKWILDX
E374 38 34          	JR	C,KILLW
E376 CD 13 E1       	CALL	SOPENX
E379                KILLS:
E379 3E 1F          	LD	A,01FH
E37B D4 BD E3       	CALL	NC,CHKATT
E37E D8             	RET	C
E37F                KILLSX:
E37F 36 E5          	LD	(HL),0E5H	;DIR
E381 CD 1B E4       	CALL	WTDB
E384 11 1A 00       	LD	DE,01AH
E387 19             	ADD	HL,DE
E388 5E             	LD	E,(HL)
E389 23             	INC	HL
E38A 56             	LD	D,(HL)
E38B                KILLS1:
E38B CD 0E E3       	CALL	ENDCL
E38E D0             	RET	NC		;CF=0
E38F 21 FE FF       	LD	HL,0-2
E392 19             	ADD	HL,DE
E393 D0             	RET	NC		;DE= 0 or 1
E394 D5             	PUSH	DE
E395 CD F7 EF       	CALL	_GNCL
E398 ED 53 FE F0    	LD	(_CLPS),DE
E39C D1             	POP	DE
E39D 21 00 00       	LD	HL,0
E3A0 D4 FA EF       	CALL	NC,_SNCL
E3A3 D8             	RET	C
E3A4 ED 5B FE F0    	LD	DE,(_CLPS)	;FAT
E3A8 18 E1          	JR	KILLS1
E3AA                
E3AA                KILLW:
E3AA CD 40 E1       	CALL	SOPEN
E3AD                KILLW1:
E3AD 38 0B          	JR	C,KILLW2
E3AF CD E0 E1       	CALL	SOPENE2
E3B2 CD 79 E3       	CALL	KILLS
E3B5 CD A4 E1       	CALL	NOPEN
E3B8 18 F3          	JR	KILLW1
E3BA                KILLW2:
E3BA C8             	RET	Z
E3BB 3F             	CCF
E3BC C9             	RET
E3BD                
E3BD                CHKATT:
E3BD E5             	PUSH	HL
E3BE 11 0B 00       	LD	DE,00BH
E3C1 19             	ADD	HL,DE
E3C2 A6             	AND	(HL)
E3C3 E1             	POP	HL
E3C4 C8             	RET	Z
E3C5 37             	SCF
E3C6 C9             	RET
E3C7                
E3C7                NAME:
E3C7 CD 41 E4       	CALL	CHKWILDX
E3CA D8             	RET	C
E3CB 11 04 00       	LD	DE,4
E3CE 19             	ADD	HL,DE
E3CF 22 E7 E3       	LD	(NAMEP+2),HL
E3D2 23             	INC	HL
E3D3 CD 45 E4       	CALL	CHKWILD
E3D6 D8             	RET	C
E3D7                
E3D7 CD 13 E1       	CALL	SOPENX
E3DA 3E 0F          	LD	A,00FH
E3DC D4 BD E3       	CALL	NC,CHKATT
E3DF D8             	RET	C
E3E0                
E3E0 FD 7E 00       	LD	A,(IY+0)
E3E3 FD E5          	PUSH	IY
E3E5 FD 21 00 00    NAMEP:	LD	IY,0		;自己書き換え
E3E9 FD 77 00       	LD	(IY+0),A
E3EC CD 13 E1       	CALL	SOPENX
E3EF FD E3          	EX	(SP),IY
E3F1 3F             	CCF
E3F2 D4 40 E1       	CALL	NC,SOPEN
E3F5 EB             	EX	DE,HL
E3F6 E1             	POP	HL
E3F7 D8             	RET	C
E3F8                
E3F8                SETNAME:
E3F8 01 00 0B       	LD	BC,11*256
E3FB 23             	INC	HL
E3FC 7E             	LD	A,(HL)
E3FD FE E5          	CP	0E5H
E3FF 20 04          	JR	NZ,SNAME1
E401 3E 05          	LD	A,5
E403 18 0E          	JR	SNAME3
E405                SNAME1:
E405 7E             	LD	A,(HL)
E406 0C             	INC	C
E407 0D             	DEC	C
E408 20 09          	JR	NZ,SNAME3
E40A CD 16 E3       	CALL	CAP
E40D FE A0          	CP	0A0H
E40F 20 02          	JR	NZ,SNAME3
E411 3E 20          	LD	A,020H
E413                SNAME3:
E413 12             	LD	(DE),A
E414 7E             	LD	A,(HL)
E415 23             	INC	HL
E416 CD 2E E4       	CALL	FKAN
E419 10 EA          	DJNZ	SNAME1
E41B                WTDB:
E41B 3E FF          	LD	A,0FFH
E41D 32 39 EF       	LD	(SFILE),A
E420                SWTDBF:
E420 3E 01          	LD	A,1
E422 32 A4 EF       	LD	(_WTDBF),A
E425 AF             	XOR	A
E426 C9             	RET
E427                
E427                FKANC:
E427 CB 41          	BIT	0,C
E429 CC 1F E3       	CALL	Z,CAP2
E42C 18 01          	JR	FKANX
E42E                FKAN:			;漢字チェック
E42E 13             	INC	DE
E42F                FKANX:
E42F CB 41          	BIT	0,C
E431 CB 81          	RES	0,C
E433 C0             	RET	NZ
E434 FE 80          	CP	080H
E436 D8             	RET	C
E437 FE A0          	CP	0A0H
E439 38 03          	JR	C,FKAN1
E43B FE E0          	CP	0E0H
E43D D8             	RET	C
E43E                FKAN1:
E43E 0C             	INC	C
E43F A7             	AND	A
E440 C9             	RET
E441                
E441                CHKWILDX:
E441 FD E5          	PUSH	IY
E443 E1             	POP	HL
E444 23             	INC	HL
E445                CHKWILD:
E445 06 0B          	LD	B,11
E447 3E 3F          	LD	A,'?'
E449                CHKWIL1:
E449 BE             	CP	(HL)
E44A 23             	INC	HL
E44B 37             	SCF
E44C C8             	RET	Z
E44D 10 FA          	DJNZ	CHKWIL1
E44F AF             	XOR	A
E450 C9             	RET
E451                
E451                SDIRENT:		;IY=FCB HL=DIR
E451 D5             	PUSH	DE
E452 E5             	PUSH	HL
E453 FD E5          	PUSH	IY
E455 D1             	POP	DE
E456 EB             	EX	DE,HL
E457 CD F8 E3       	CALL	SETNAME
E45A                ;				Attribute
E45A FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E45D 12             	LD	(DE),A
E45E 13             	INC	DE
E45F                ;				Reserved
E45F AF             	XOR	A
E460 06 0A          	LD	B,10
E462                SDE1:
E462 12             	LD	(DE),A
E463 13             	INC	DE
E464 10 FC          	DJNZ	SDE1
E466                					;(FCB)更新時刻
E466 21 EA F0       	LD	HL,SDDATA		;(FCB)更新年月日
E469 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
E46B                SDLOOP:					;(FCB)ファイルのサイズ(バイト単位)
E46B 7E             	LD	A,(HL)
E46C 23             	INC	HL
E46D 32 72 E4       	LD	(SDPAT+2),A
E470 FD 7E 00       SDPAT:	LD	A,(IY+0)	;LD A,(IY+A)
E473 12             	LD	(DE),A
E474 13             	INC	DE
E475 10 F4          	DJNZ	SDLOOP
E477                
E477 AF             	XOR	A
E478 E1             	POP	HL
E479 D1             	POP	DE
E47A C9             	RET
E47B                
E47B                WOPEN:
E47B FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E47E E6 1F          	AND	01FH
E480 37             	SCF
E481 C0             	RET	NZ
E482 FD 36 1C FE    	LD	(IY+28),0FEH	;(FCB)オープンモード
E486                TOPEN2:
E486 AF             	XOR	A
E487                TOPEN:				;Initializes the time stamp
E487 FD 36 17 FF    	LD	(IY+23),0FFH	;(FCB)更新時刻
E48B C9             	RET
E48C                
E48C                WRDFX:
E48C 3A F5 E2       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ
E48F                L_WRFX:
E48F 1F             	RRA			;->CF
E490 38 06          	JR	C,E_WRFX
E492 CB 39          	SRL	C
E494 CB 1C          	RR	H		;CH=CH/2
E496 18 F7          	JR	L_WRFX
E498                E_WRFX:
E498 44             	LD	B,H
E499 04             	INC	B
E49A 3E 37          	LD	A,037H		;SCF
E49C 32 12 E9       	LD	(DRDN1),A
E49F                
E49F                WRDF:				;Bクラスタ分FATを確保する
E49F 11 02 00       	LD	DE,2
E4A2 AF             	XOR	A
E4A3 32 82 EA       	LD	(_SECPS+1),A
E4A6                WRDF1:
E4A6 C5             	PUSH	BC
E4A7 D5             	PUSH	DE
E4A8 CD F7 EF       	CALL	_GNCL
E4AB 38 1C          	JR	C,WRDF3
E4AD 7A             	LD	A,D		;空いているかチェック
E4AE B3             	OR	E
E4AF 20 27          	JR	NZ,WRDF4
E4B1 E1             	POP	HL		;HL=空いているクラスタ
E4B2 E5             	PUSH	HL
E4B3 ED 5B FE F0    	LD	DE,(_CLPS)	;DE=元の(_CLPS)
E4B7 22 FE F0       	LD	(_CLPS),HL
E4BA 7A             	LD	A,D		;元の(_CLPS)が 0 か?
E4BB B3             	OR	E
E4BC 20 08          	JR	NZ,WRDF2
E4BE FD 75 1A       	LD	(IY+26),L	;(FCB)ファイルの先頭クラスタ
E4C1 FD 74 1B       	LD	(IY+27),H	;元が空の場合はFCBにクラスタをセットする
E4C4 18 03          	JR	WRDF3
E4C6                WRDF2:
E4C6 CD FA EF       	CALL	_SNCL
E4C9                WRDF3:
E4C9 D1             	POP	DE
E4CA C1             	POP	BC
E4CB D8             	RET	C
E4CC 10 0C          	DJNZ	WRDF5		;ここでループカウンタチェック
E4CE ED 5B FE F0    	LD	DE,(_CLPS)
E4D2 21 FF FF       	LD	HL,0FFFFH	;FATエントリ終了(EOCマーク)
E4D5 C3 FA EF       	JP	_SNCL
E4D8                
E4D8                WRDF4:				;DEクラスタが空じゃないので次に移動する
E4D8 D1             	POP	DE
E4D9 C1             	POP	BC
E4DA                WRDF5:
E4DA 13             	INC	DE
E4DB CD 0E E3       	CALL	ENDCL
E4DE 38 C6          	JR	C,WRDF1
E4E0 37             	SCF
E4E1 C9             	RET
E4E2                
E4E2                RWXR:
E4E2 3A 13 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E4E5                L_RWX:
E4E5 1F             	RRA		;->CF
E4E6 38 08          	JR	C,E_RWX
E4E8 CB 38          	SRL	B	;BCH=BCH/2
E4EA CB 19          	RR	C	;
E4EC CB 1C          	RR	H	;
E4EE 18 F5          	JR	L_RWX
E4F0                E_RWX:
E4F0 FD 5E 1A       	LD	E,(IY+26)	;(FCB)ファイルの先頭クラスタ
E4F3 FD 56 1B       	LD	D,(IY+27)
E4F6 AF             	XOR	A
E4F7 32 82 EA       	LD	(_SECPS+1),A
E4FA                RWX1:
E4FA ED 53 FE F0    	LD	(_CLPS),DE
E4FE 7A             	LD	A,D
E4FF B3             	OR	E
E500 28 13          	JR	Z,SCF_RET	;RET DE==0 => CF=1
E502                
E502 78             	LD	A,B
E503 B1             	OR	C
E504 B4             	OR	H
E505 C8             	RET	Z		;RET BCH==0 => CF=0
E506                
E506 CD 8A EA       	CALL	GNCLX
E509 D8             	RET	C
E50A 7C             	LD	A,H		;
E50B 25             	DEC	H		;
E50C B7             	OR	A		;DEC BCH
E50D 20 01          	JR	NZ,RWX2		;
E50F 0B             	DEC	BC		;
E510                RWX2:
E510 CD 0E E3       	CALL	ENDCL
E513 38 E5          	JR	C,RWX1
E515                SCF_RET:
E515 37             	SCF
E516 C9             	RET
E517                
E517                DSKF:
E517 11 00 00       MAXCLP:	LD	DE,0
E51A 2A AC EF       	LD	HL,(_FAKEFREE)
E51D 7C             	LD	A,H
E51E B5             	OR	L
E51F 28 03          	JR	Z,DSKF1
E521 11 01 00       	LD	DE,1
E524                DSKF1:
E524 D5             	PUSH	DE
E525 CD F7 EF       	CALL	_GNCL
E528 38 0C          	JR	C,POPSCF
E52A 7A             	LD	A,D
E52B B3             	OR	E
E52C 20 01          	JR	NZ,DSKF2
E52E 23             	INC	HL
E52F                DSKF2:
E52F D1             	POP	DE
E530 1B             	DEC	DE
E531 7A             	LD	A,D
E532 B3             	OR	E
E533 20 EF          	JR	NZ,DSKF1
E535 C9             	RET
E536                
E536                POPSCF:
E536 F1             	POP	AF
E537 37             	SCF
E538 C9             	RET
E539                
E539                SETTMS:
E539 FD 7E 17       	LD	A,(IY+23)	;(FCB)ファイルを最後に変更した時刻
E53C 3C             	INC	A
E53D C0             	RET	NZ		;ファイルが更新されていない
E53E                SETTMSX:			;FCBに日付時刻をセットする
E53E CD EF DB       	CALL	_SYS2C		;(BDOS)時刻の獲得
E541                				;H←時  L←分  D←秒
E541 CB 25          	SLA	L		;   *2
E543 CB 25          	SLA	L		;   *4
E545 29             	ADD	HL,HL		;*2 *8
E546 29             	ADD	HL,HL		;*4 *16
E547 29             	ADD	HL,HL		;*8 *32
E548 7A             	LD	A,D
E549 0F             	RRCA			;bit.0->7->->->0->C
E54A E6 1F          	AND	01FH
E54C B5             	OR	L
E54D FD 77 16       	LD	(IY+22),A	;(FCB)ファイルを最後に変更した時刻
E550 FD 74 17       	LD	(IY+23),H
E553                
E553 CD CC DB       	CALL	_SYS2A		;(BDOS)日付の獲得
E556                				;HL←年  D←月  E←日
E556 01 44 F8       	LD	BC,0-1980
E559 09             	ADD	HL,BC
E55A 65             	LD	H,L
E55B                
E55B 7A             	LD	A,D
E55C 87             	ADD	A,A		;*2
E55D 87             	ADD	A,A		;*4
E55E 87             	ADD	A,A		;*8
E55F 87             	ADD	A,A		;*16
E560 6F             	LD	L,A
E561 29             	ADD	HL,HL		;*32
E562 7D             	LD	A,L
E563 B3             	OR	E
E564 FD 77 14       	LD	(IY+20),A	;(FCB)ファイルを最後に変更した日付
E567 FD 74 15       	LD	(IY+21),H
E56A C9             	RET
E56B                
E56B                PUSHRR:
E56B 32 0A E6       	LD	(SETSEQ_SWC_RND),A
E56E 22 1C E6       	LD	(SETSEQ_SWC_SEQ_RR),HL
E571 CD 91 E5       	CALL	GET_RR_AHL
E574 22 5A EF       	LD	(HLBUF),HL
E577 32 5C EF       	LD	(HLBUF+2),A
E57A C9             	RET
E57B                
E57B                GET_CPM_R_SIZE:		;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
E57B 87             	ADD	A,A		;in BHLA => out AHL
E57C ED 6A          	ADC	HL,HL
E57E CB 18          	RR	B
E580 B7             	OR	A
E581 78             	LD	A,B		;ここでフラグは変化しない
E582 C8             	RET	Z
E583 2C             	INC	L		;INC AHL
E584 C0             	RET	NZ		;
E585 24             	INC	H		;
E586 C0             	RET	NZ		;
E587 3C             	INC	A		;
E588 C9             	RET
E589                
E589                INIT_RND:
E589 3E CD          	LD	A,0CDH		;CALL ????
E58B 21 DA E5       	LD	HL,POPRR
E58E CD 6B E5       	CALL	PUSHRR
E591                GET_RR_AHL:
E591 FD 6E 21       	LD	L,(IY+33)	;(FCB)Random record
E594 FD 66 22       	LD	H,(IY+34)	;
E597 FD 7E 23       	LD	A,(IY+35)	;
E59A C9             	RET
E59B                SET_RR_AHL:
E59B FD 75 21       	LD	(IY+33),L	;(FCB)Random record
E59E FD 74 22       	LD	(IY+34),H
E5A1 FD 77 23       	LD	(IY+35),A
E5A4 C9             	RET
E5A5                INIT_SEQ:
E5A5 3E 01          	LD	A,1		;LD BC,????
E5A7 21 D7 E5       	LD	HL,SETSEQ
E5AA CD 6B E5       	CALL	PUSHRR
E5AD                GETSEQ:
E5AD FD 6E 20       	LD	L,(IY+32)	;(FCB)カレントレコード
E5B0 FD 66 0C       	LD	H,(IY+12)	;(FCB)カレントブロック
E5B3 AF             	XOR	A
E5B4                
E5B4 CB 25          	SLA	L	;L=L*2
E5B6                
E5B6 CB 3C          	SRL	H	;HL=HL/2
E5B8 CB 1D          	RR	L	;
E5BA C9             	RET
E5BB                
E5BB                SETSEQ1:
E5BB F5             	PUSH	AF		
E5BC E5             	PUSH	HL		;AHL=Random record
E5BD FD 7E 21       	LD	A,(IY+33)	;(FCB)ランダムレコード
E5C0 FD 6E 22       	LD	L,(IY+34)
E5C3 FD 66 23       	LD	H,(IY+35)
E5C6 06 00          	LD	B,0
E5C8                
E5C8 CD 7B E5       	CALL	GET_CPM_R_SIZE
E5CB                
E5CB 29             	ADD	HL,HL
E5CC CB 3D          	SRL	L		;L=L/2
E5CE FD 75 20       	LD	(IY+32),L	;(FCB)カレントレコード
E5D1 FD 74 0C       	LD	(IY+12),H	;(FCB)カレントブロック
E5D4 E1             	POP	HL
E5D5 F1             	POP	AF
E5D6 C9             	RET
E5D7                SETSEQ:
E5D7 CD BB E5       	CALL	SETSEQ1
E5DA                POPRR:
E5DA F5             	PUSH	AF
E5DB E5             	PUSH	HL
E5DC 2A 5A EF       	LD	HL,(HLBUF)
E5DF 3A 5C EF       	LD	A,(HLBUF+2)
E5E2 CD 9B E5       	CALL	SET_RR_AHL
E5E5 E1             	POP	HL
E5E6 F1             	POP	AF
E5E7 C9             	RET
E5E8                
E5E8                RB_WRITE:
E5E8 C5             	PUSH	BC
E5E9 ED 4B 4C F0    	LD	BC,(STABLE+2*026H)	;(BDOS)ランダムブロック書き込み
E5ED 18 05          	JR	RBRW
E5EF                RB_READ:
E5EF C5             	PUSH	BC
E5F0 ED 4B 4E F0    	LD	BC,(STABLE+2*027H)	;(BDOS)ランダムブロック読み込み
E5F4                RBRW:
E5F4 CB 3F          	SRL	A	;AHLA' = HL*128
E5F6 CB 1C          	RR	H	;AHL=AHL/2
E5F8 CB 1D          	RR	L	;
E5FA 3E 00          	LD	A,0
E5FC 1F             	RRA		;A'HLA
E5FD FD 77 21       	LD	(IY+33),A	;(FCB)ランダムレコード
E600 FD 75 22       	LD	(IY+34),L
E603 FD 74 23       	LD	(IY+35),H
E606 21 80 00       	LD	HL,128
E609 C5             	PUSH	BC
E60A                SETSEQ_SWC_RND:
E60A CD BB E5       	CALL	SETSEQ1
E60D C1             	POP	BC
E60E FD CB 20 FE    	SET	7,(IY+32)	;(FCB)カレントレコード
E612 FD E5          	PUSH	IY
E614 D1             	POP	DE
E615 D5             	PUSH	DE
E616 CD 24 E6       	CALL	JP_BC
E619 FD E1          	POP	IY
E61B 00 00 E6 1C    SETSEQ_SWC_SEQ_RR	EQU $+1
E61B CD D7 E5       	CALL	SETSEQ
E61E FD CB 20 BE    	RES	7,(IY+32)	;(FCB)カレントレコード
E622                
E622 C1             	POP	BC
E623 C9             	RET
E624                JP_BC:
E624 C5             	PUSH	BC
E625 C9             	RET
E626                
E626 00 00 E1 9E    _SYS03	EQU	SCF_FF_RET	;(BDOS)外部入力
E626 00 00 E1 9E    _SYS2B	EQU	SCF_FF_RET	;(BDOS)日付の設定
E626 00 00 E1 9E    _SYS2D	EQU	SCF_FF_RET	;(BDOS)時刻の設定
E626 00 00 E1 9E    _SYS39	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの作成
E626 00 00 E1 9E    _SYS3A	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの削除
E626                
E626                	INCLUDE	"LDFILE2.ASM"
E626                
E626                ;	LSX-Dodgers FILE2
E626                
E626                				;Write random block
E626                _SYS26:		;(BDOS)ランダムブロック書き込み
E626 AF             	XOR	A
E627 32 12 E9       	LD	(DRDN1),A	;NOP
E62A 22 56 E8       	LD	(LEFT+1),HL	;HL←書き込むレコード数
E62D 22 5D EF       	LD	(LEFTX),HL
E630 CD F3 E0       	CALL	SETDRV
E633                
E633 CD AD E7       	CALL	RBX0
E636 DA D0 E6       	JP	C,RBWERR
E639 CD 7B E4       	CALL	WOPEN
E63C DA D0 E6       	JP	C,RBWERR
E63F 7C             	LD	A,H
E640 B5             	OR	L
E641 CA C9 E6       	JP	Z,RBW1
E644                
E644 2B             	DEC	HL
E645                
E645 CD 78 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E648                
E648 19             	ADD	HL,DE		;BCHL=HL+BCDE
E649 30 01          	JR	NC,S26X1	;
E64B 03             	INC	BC		;
E64C                S26X1:
E64C CD E2 E4       	CALL	RWXR
E64F DC 8C E4       	CALL	C,WRDFX
E652 DA D0 E6       	JP	C,RBWERR
E655                
E655 CD DC E7       	CALL	RBX2
E658 28 1A          	JR	Z,RBWB		;NZ=セクタ以下の端数がある
E65A CD FB E7       	CALL	RBXA
E65D 38 71          	JR	C,RBWERR
E65F EB             	EX	DE,HL
E660 C5             	PUSH	BC
E661 ED B0          	LDIR
E663 22 5F EF       	LD	(DTAX),HL
E666                
E666 CD 20 E4       	CALL	SWTDBF		;バッファデータは更新された
E669                
E669 2A 5D EF       	LD	HL,(LEFTX)
E66C D1             	POP	DE
E66D ED 52          	SBC	HL,DE
E66F 22 5D EF       	LD	(LEFTX),HL
E672 28 33          	JR	Z,RBWEND
E674                
E674                RBWB:
E674 CD 31 E8       	CALL	RBXB
E677 28 16          	JR	Z,RBWC
E679                RBWB1:
E679 C5             	PUSH	BC
E67A D5             	PUSH	DE
E67B CD F1 E2       	CALL	CLUSTX
E67E CD 8C E8       	CALL	DWTC
E681 D1             	POP	DE
E682 C1             	POP	BC
E683 38 4B          	JR	C,RBWERR
E685 CD 8A EA       	CALL	GNCLX
E688 38 46          	JR	C,RBWERR
E68A 10 ED          	DJNZ	RBWB1
E68C CD DC E8       	CALL	DRW_FLUSH
E68F                RBWC:
E68F CD 49 E8       	CALL	RBXC
E692 28 13          	JR	Z,RBWEND
E694 C5             	PUSH	BC
E695 CD F1 E2       	CALL	CLUSTX
E698 CD 11 E9       	CALL	DRDN
E69B C1             	POP	BC
E69C 38 32          	JR	C,RBWERR
E69E ED 5B 7E F0    	LD	DE,(_DTBUF)
E6A2 ED B0          	LDIR
E6A4 CD 20 E4       	CALL	SWTDBF		;バッファデータは更新された
E6A7                RBWEND:
E6A7 CD 55 E8       	CALL	RBXEND
E6AA                
E6AA CD BC E7       	CALL	RBX1
E6AD 30 1A          	JR	NC,RBW1
E6AF 2A 56 E8       	LD	HL,(LEFT+1)
E6B2 FD 5E 10       	LD	E,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
E6B5 FD 56 11       	LD	D,(IY+17)	;DE=File size
E6B8 19             	ADD	HL,DE
E6B9 FD 75 10       	LD	(IY+16),L	;(FCB)ファイルのサイズ(バイト単位)
E6BC FD 74 11       	LD	(IY+17),H
E6BF 30 08          	JR	NC,RBW1
E6C1 FD 34 12       	INC	(IY+18)
E6C4 20 03          	JR	NZ,RBW1
E6C6 FD 34 13       	INC	(IY+19)
E6C9                RBW1:
E6C9 FD E1          	POP	IY
E6CB C1             	POP	BC
E6CC D1             	POP	DE
E6CD E1             	POP	HL
E6CE                DD_NUL:
E6CE AF             	XOR	A
E6CF                DRDF0:
E6CF                DWTF0:
E6CF C9             	RET
E6D0                
E6D0                RBWERR:
E6D0 FD E5          	PUSH	IY
E6D2 D1             	POP	DE
E6D3 2A 20 F0       	LD	HL,(STABLE+2*010H)
E6D6 CD 0F 00       	CALL	JP_HL
E6D9                RBRERR1:
E6D9 3E 01          	LD	A,001H
E6DB                RBRERR2:
E6DB FD E1          	POP	IY
E6DD C1             	POP	BC
E6DE D1             	POP	DE
E6DF E1             	POP	HL
E6E0 37             	SCF
E6E1 21 00 00       	LD	HL,0
E6E4 C9             	RET
E6E5                
E6E5                RBRERR:
E6E5 3E FF          	LD	A,0FFH
E6E7 18 F2          	JR	RBRERR2
E6E9                
E6E9                RBRFL:
E6E9 3E 00          RBRFLP:	LD	A,000H
E6EB FE 0D          	CP	00DH
E6ED 20 05          	JR	NZ,RBRFL1
E6EF D5             	PUSH	DE
E6F0 1E 0A          	LD	E,00AH
E6F2 18 05          	JR	RBRFL2
E6F4                RBRFL1:
E6F4 D5             	PUSH	DE
E6F5 CD 09 EF       	CALL	_SYS07
E6F8 5F             	LD	E,A
E6F9                RBRFL2:
E6F9 CD CD EF       	CALL	_PRINT
E6FC 7B             	LD	A,E
E6FD D1             	POP	DE
E6FE 32 EA E6       	LD	(RBRFLP+1),A
E701 C9             	RET
E702                DDX:
E702 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
E705 CD 16 E3       	CALL	CAP
E708 FE 41          	CP	'A'
E70A C9             	RET
E70B                
E70B                				;Read random block
E70B                _SYS27:		;(BDOS)ランダムブロック読み込み
E70B 22 5D EF       	LD	(LEFTX),HL
E70E CD F3 E0       	CALL	SETDRV
E711                
E711 FD CB 0D 66    	BIT	4,(IY+13)	;(FCB)属性(アトリビュート)
E715 C2 9B E7       	JP	NZ,RBRDIR	;ディレクトリ
E718 CD AD E7       	CALL	RBX0
E71B DA E5 E6       	JP	C,RBRERR
E71E CD BC E7       	CALL	RBX1
E721 DA D9 E6       	JP	C,RBRERR1
E724 EB             	EX	DE,HL
E725 ED 52          	SBC	HL,DE		;CP 00HL,BCDE
E727 19             	ADD	HL,DE
E728 79             	LD	A,C
E729 DE 00          	SBC	A,0
E72B 78             	LD	A,B
E72C DE 00          	SBC	A,0
E72E 38 01          	JR	C,RBR1
E730 EB             	EX	DE,HL
E731                RBR1:
E731 9F             	SBC	A,A
E732 E6 01          	AND	1
E734 32 99 E7       	LD	(RBRAP+1),A
E737                
E737 7C             	LD	A,H
E738 B5             	OR	L
E739 28 57          	JR	Z,RBREND0
E73B                
E73B 22 56 E8       	LD	(LEFT+1),HL	;Read record byte
E73E 22 5D EF       	LD	(LEFTX),HL
E741                
E741 CD DC E7       	CALL	RBX2
E744 28 19          	JR	Z,RBRB
E746 CD FB E7       	CALL	RBXA
E749 DA E5 E6       	JP	C,RBRERR
E74C C5             	PUSH	BC
E74D ED B0          	LDIR
E74F ED 53 5F EF    	LD	(DTAX),DE
E753 2A 5D EF       	LD	HL,(LEFTX)
E756 D1             	POP	DE
E757 A7             	AND	A
E758 ED 52          	SBC	HL,DE
E75A 22 5D EF       	LD	(LEFTX),HL
E75D 28 30          	JR	Z,RBREND
E75F                
E75F                RBRB:
E75F CD 31 E8       	CALL	RBXB
E762 28 15          	JR	Z,RBRC
E764                RBRB1:
E764 C5             	PUSH	BC
E765 D5             	PUSH	DE
E766 CD F1 E2       	CALL	CLUSTX
E769 CD 92 E8       	CALL	DRDC
E76C D1             	POP	DE
E76D C1             	POP	BC
E76E D4 8A EA       	CALL	NC,GNCLX
E771 DA E5 E6       	JP	C,RBRERR
E774 10 EE          	DJNZ	RBRB1
E776 CD DC E8       	CALL	DRW_FLUSH
E779                RBRC:
E779 CD 49 E8       	CALL	RBXC
E77C 28 11          	JR	Z,RBREND
E77E C5             	PUSH	BC
E77F CD F1 E2       	CALL	CLUSTX
E782 CD F5 E8       	CALL	DRDX
E785 C1             	POP	BC
E786 DA E5 E6       	JP	C,RBRERR
E789 EB             	EX	DE,HL
E78A 2A 7E F0       	LD	HL,(_DTBUF)
E78D ED B0          	LDIR
E78F                RBREND:
E78F CD 55 E8       	CALL	RBXEND
E792                RBREND0:
E792 FD E1          	POP	IY
E794 C1             	POP	BC
E795 D1             	POP	DE
E796 F1             	POP	AF	;(HL)
E797 AF             	XOR	A
E798 3E 00          RBRAP:	LD	A,000H
E79A C9             	RET
E79B                
E79B                RBRDIR:
E79B FD 6E 1A       	LD	L,(IY+26)	;(FCB)ファイルの先頭クラスタ
E79E FD 66 1B       	LD	H,(IY+27)
E7A1 CD 31 E3       	CALL	CHDIR
E7A4 AF             	XOR	A
E7A5 67             	LD	H,A
E7A6 6F             	LD	L,A
E7A7 3C             	INC	A
E7A8 32 99 E7       	LD	(RBRAP+1),A
E7AB 18 E5          	JR	RBREND0
E7AD                
E7AD                RBX0:
E7AD 2A 8A EF       	LD	HL,(_DTA)
E7B0 22 5F EF       	LD	(DTAX),HL
E7B3 2A 5D EF       	LD	HL,(LEFTX)
E7B6 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
E7B9 D6 FD          	SUB	0FDH
E7BB C9             	RET
E7BC                
E7BC                RBX1:
E7BC E5             	PUSH	HL		;Record byte
E7BD                				;AHL=File size
E7BD FD 6E 10       	LD	L,(IY+16)	;ファイルのサイズ(バイト単位)
E7C0 FD 66 11       	LD	H,(IY+17)	;
E7C3 FD 7E 12       	LD	A,(IY+18)	;
E7C6                
E7C6 CD 78 E8       	CALL	GET_RR_BCDE	;BCDE=Random record
E7C9                
E7C9 A7             	AND	A
E7CA ED 52          	SBC	HL,DE
E7CC 99             	SBC	A,C
E7CD 4F             	LD	C,A
E7CE FD 7E 13       	LD	A,(IY+19)	;ファイルのサイズ
E7D1 98             	SBC	A,B
E7D2 D1             	POP	DE
E7D3                
E7D3 D8             	RET	C
E7D4 47             	LD	B,A
E7D5 B1             	OR	C
E7D6 EB             	EX	DE,HL	;BCDE=File byte	HL=Record byte
E7D7 B2             	OR	D
E7D8 B3             	OR	E
E7D9 C0             	RET	NZ
E7DA 37             	SCF
E7DB C9             	RET
E7DC                
E7DC                RBX2:				;Cluster settings
E7DC FD 66 22       	LD	H,(IY+34)	;(+33)(FCB)ランダムレコード
E7DF FD 4E 23       	LD	C,(IY+35)
E7E2 06 00          	LD	B,0
E7E4 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E7E8 20 03          	JR	NZ,RBX3
E7EA FD 46 24       	LD	B,(IY+36)
E7ED                RBX3:
E7ED CD E2 E4       	CALL	RWXR
E7F0 3A 13 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E7F3 3D             	DEC	A
E7F4 FD A6 22       	AND	(IY+34)
E7F7 FD B6 21       	OR	(IY+33)
E7FA C9             	RET
E7FB                
E7FB                RBXA:
E7FB C5             	PUSH	BC
E7FC D5             	PUSH	DE
E7FD CD F1 E2       	CALL	CLUSTX
E800 CD F5 E8       	CALL	DRDX
E803 D1             	POP	DE
E804 C1             	POP	BC
E805 D8             	RET	C
E806 CD 8A EA       	CALL	GNCLX
E809 D8             	RET	C
E80A ED 53 FE F0    	LD	(_CLPS),DE
E80E                
E80E FD 4E 21       	LD	C,(IY+33)	;(FCB)ランダムレコード
E811 21 00 04       SECSZ:	LD	HL,0400H	;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
E814 7C             	LD	A,H
E815 3D             	DEC	A		;1024=3 / 512=1
E816 FD A6 22       	AND	(IY+34)		;(FCB)ランダムレコード
E819 47             	LD	B,A		;BCに1セクタ以下の端数が入る
E81A ED 42          	SBC	HL,BC		;残りを計算
E81C                
E81C ED 5B 5D EF    	LD	DE,(LEFTX)
E820 ED 52          	SBC	HL,DE		;CP HL,DE
E822 19             	ADD	HL,DE		;
E823 38 01          	JR	C,RBXA1		;DEとHLを比較して大きい方をHLに
E825 EB             	EX	DE,HL
E826                RBXA1:
E826 E5             	PUSH	HL
E827 2A 7E F0       	LD	HL,(_DTBUF)
E82A 09             	ADD	HL,BC
E82B ED 5B 5F EF    	LD	DE,(DTAX)
E82F C1             	POP	BC
E830 C9             	RET
E831                
E831                RBXB:
E831 2A 5F EF       	LD	HL,(DTAX)
E834 ED 5B FE F0    	LD	DE,(_CLPS)
E838 3A 5E EF       	LD	A,(LEFTX+1)
E83B 47             	LD	B,A
E83C 3A 13 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E83F                RBXB1:
E83F 1F             	RRA		;->CF
E840 38 04          	JR	C,RBXB2
E842 CB 38          	SRL	B	;B=B/2
E844 18 F9          	JR	RBXB1
E846                RBXB2:
E846 78             	LD	A,B
E847 B7             	OR	A
E848 C9             	RET
E849                
E849                RBXC:
E849 ED 4B 5D EF    	LD	BC,(LEFTX)
E84D 3A 13 E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E850 3D             	DEC	A
E851 A0             	AND	B
E852 47             	LD	B,A		;1セクタ以下の端数がない場合はZ
E853 B1             	OR	C
E854 C9             	RET
E855                
E855                RBXEND:
E855 11 00 00       LEFT:	LD	DE,0
E858 AF             	XOR	A
E859 FD 6E 21       	LD	L,(IY+33)	;(FCB)ランダムレコード
E85C FD 66 22       	LD	H,(IY+34)
E85F 19             	ADD	HL,DE
E860 FD 75 21       	LD	(IY+33),L	;(FCB)ランダムレコード
E863 FD 74 22       	LD	(IY+34),H
E866 30 0E          	JR	NC,RBXEND1
E868 FD 34 23       	INC	(IY+35)
E86B 20 09          	JR	NZ,RBXEND1
E86D FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E871 20 03          	JR	NZ,RBXEND1
E873 FD 34 24       	INC	(IY+36)
E876                RBXEND1:
E876 EB             	EX	DE,HL		;HL=Read byte
E877 C9             	RET
E878                
E878                GET_RR_BCDE:			;BCDE=Random record
E878 FD 5E 21       	LD	E,(IY+33)	;(FCB)ランダムレコード
E87B FD 56 22       	LD	D,(IY+34)
E87E FD 4E 23       	LD	C,(IY+35)
E881 FD 46 24       	LD	B,(IY+36)
E884 FD CB 20 7E    	BIT	7,(IY+32)	;(FCB)カレントレコード
E888 C8             	RET	Z
E889 06 00          	LD	B,0		;CP/M互換のアクセスの場合はFCBは36バイト
E88B C9             	RET
E88C                
E88C                ;	ランダムブロックアクセスの連続したセクタをまとめる
E88C                
E88C                DWTC:
E88C E5             	PUSH	HL
E88D 21 EF EB       	LD	HL,DWT24B
E890 18 04          	JR	DWTC1
E892                DRDC:
E892 E5             	PUSH	HL
E893 21 DF EB       	LD	HL,DRD24B
E896                DWTC1:
E896 22 F0 E8       	LD	(DRWF_MODE),HL
E899 E1             	POP	HL
E89A 3A E0 E8       	LD	A,(DRWF_B)
E89D B7             	OR	A
E89E 20 0F          	JR	NZ,DRDC1
E8A0                SAVE_DRWC:
E8A0 06 01          	LD	B,1
E8A2 ED 43 DF E8    	LD	(DRWF_C),BC
E8A6 ED 53 E6 E8    	LD	(DRWF_E),DE
E8AA 22 E9 E8       	LD	(DRWF_HL),HL
E8AD 18 20          	JR	INC_HL_DRWC
E8AF                DRDC1:
E8AF E5             	PUSH	HL
E8B0 21 E6 E8       	LD	HL,DRWF_E
E8B3 86             	ADD	A,(HL)
E8B4 F5             	PUSH	AF
E8B5 BB             	CP	E
E8B6 20 1D          	JR	NZ,DRDC2
E8B8 F1             	POP	AF
E8B9 23             	INC	HL
E8BA 7E             	LD	A,(HL)
E8BB CE 00          	ADC	A,0
E8BD F5             	PUSH	AF
E8BE BA             	CP	D
E8BF 20 14          	JR	NZ,DRDC2
E8C1 F1             	POP	AF
E8C2 3A DF E8       	LD	A,(DRWF_C)
E8C5 CE 00          	ADC	A,0
E8C7 B9             	CP	C
E8C8 20 0C          	JR	NZ,DRDC3
E8CA 21 E0 E8       	LD	HL,DRWF_B
E8CD 34             	INC	(HL)
E8CE E1             	POP	HL
E8CF                INC_HL_DRWC:
E8CF 3A 13 E8       	LD	A,(SECSZ+2)		;1セクタのサイズの上位1バイト
E8D2 84             	ADD	A,H
E8D3 67             	LD	H,A
E8D4 C9             	RET
E8D5                DRDC2:
E8D5 F1             	POP	AF
E8D6                DRDC3:
E8D6 CD DC E8       	CALL	DRW_FLUSH
E8D9 E1             	POP	HL
E8DA 18 C4          	JR	SAVE_DRWC
E8DC                
E8DC                ;	ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
E8DC                DRW_FLUSH:
E8DC C5             	PUSH	BC
E8DD D5             	PUSH	DE
E8DE 00 00 E8 DF    DRWF_C	EQU	$+1
E8DE 00 00 E8 E0    DRWF_B	EQU	$+2
E8DE 01 00 00       	LD	BC,0
E8E1 78             	LD	A,B
E8E2 B7             	OR	A
E8E3 28 0D          	JR	Z,DRDF1
E8E5 00 00 E8 E6    DRWF_E	EQU	$+1
E8E5 00 00 E8 E7    DRWF_D	EQU	$+2
E8E5 11 00 00       	LD	DE,0
E8E8 00 00 E8 E9    DRWF_HL	EQU	$+1
E8E8 21 00 00       	LD	HL,0
E8EB AF             	XOR	A
E8EC 32 E0 E8       	LD	(DRWF_B),A
E8EF 00 00 E8 F0    DRWF_MODE	EQU	$+1
E8EF CD DF EB       	CALL	DRD24B
E8F2                DRDF1:
E8F2 D1             	POP	DE
E8F3 C1             	POP	BC
E8F4 C9             	RET
E8F5                	INCLUDE	"LDDIO.ASM"
E8F5                
E8F5                ;	LSX-Dodgers DIO
E8F5                
E8F5                DRDX:
E8F5 CD 33 E9       	CALL	DRDY
E8F8 C8             	RET	Z
E8F9 CD 19 E9       	CALL	DRDX1		;データバッファの情報を保存
E8FC D8             	RET	C
E8FD E5             	PUSH	HL
E8FE C5             	PUSH	BC
E8FF D5             	PUSH	DE
E900 2A 7E F0       	LD	HL,(_DTBUF)
E903 3A 5C E9       	LD	A,(_DBS24+1)
E906 4F             	LD	C,A
E907 CD DD EB       	CALL	DRD24
E90A DC 2E E9       	CALL	C,DRDNE
E90D                POP_DE_BC_HL_RET:
E90D D1             	POP	DE
E90E C1             	POP	BC
E90F E1             	POP	HL
E910 C9             	RET
E911                
E911                ;	CDE:セクタ番号
E911                DRDN:
E911 AF             	XOR	A
E912 00             DRDN1:	NOP			;自己書き換え NOP / SCF
E913 30 E0          	JR	NC,DRDX
E915                DRDNX:
E915 CD 33 E9       	CALL	DRDY
E918 C8             	RET	Z
E919                DRDX1:
E919 CD 49 E9       	CALL	DWTX
E91C                				;データバッファの読み込んだドライブ・セクタ情報を保存
E91C ED 53 A6 EF    	LD	(_DBSEC),DE
E920 79             	LD	A,C
E921 32 5C E9       	LD	(_DBS24+1),A
E924                
E924 3A 88 EF       	LD	A,(_DRV)
E927 32 A5 EF       	LD	(_DBDRV),A
E92A CD D9 EF       	CALL	_CHGDRV
E92D D0             	RET	NC
E92E                DRDNE:
E92E 9F             	SBC	A,A		;CF=1ならばA=0FFH
E92F 32 A5 EF       	LD	(_DBDRV),A
E932 C9             	RET
E933                
E933                ;	CDE:セクタ番号
E933                DRDY:
E933 3A 5C E9       	LD	A,(_DBS24+1)
E936 B9             	CP	C
E937 C0             	RET	NZ
E938                
E938 E5             	PUSH	HL
E939 3A 88 EF       	LD	A,(_DRV)
E93C 21 A5 EF       	LD	HL,_DBDRV
E93F AE             	XOR	(HL)
E940 20 05          	JR	NZ,POP_HL_RET
E942                
E942 2A A6 EF       	LD	HL,(_DBSEC)
E945 ED 52          	SBC	HL,DE		;CF=0
E947                POP_HL_RET:
E947 E1             	POP	HL
E948 C9             	RET
E949                
E949                DWTX:
E949 3A A4 EF       	LD	A,(_WTDBF)
E94C B7             	OR	A
E94D C8             	RET	Z
E94E AF             	XOR	A
E94F 32 A4 EF       	LD	(_WTDBF),A
E952                
E952 E5             	PUSH	HL
E953 C5             	PUSH	BC
E954 D5             	PUSH	DE
E955 3A A5 EF       	LD	A,(_DBDRV)
E958 CD D9 EF       	CALL	_CHGDRV
E95B 0E 00          _DBS24:	LD	C,0
E95D ED 5B A6 EF    	LD	DE,(_DBSEC)
E961 2A 7E F0       	LD	HL,(_DTBUF)
E964 D4 ED EB       	CALL	NC,DWT24
E967                POP_DE_BC_HL_RET2:
E967 18 A4          	JR	POP_DE_BC_HL_RET
E969                
E969                RDFATX:
E969 E5             	PUSH	HL
E96A 3A 88 EF       	LD	A,(_DRV)
E96D 21 AA EF       	LD	HL,_FATDRV
E970 AE             	XOR	(HL)
E971 28 D4          	JR	Z,POP_HL_RET
E973                
E973 C5             	PUSH	BC
E974 D5             	PUSH	DE
E975 DD E5          	PUSH	IX
E977 CD 93 E9       	CALL	WTFATX
E97A 38 13          	JR	C,POP_IX_DE_BC_HL_RET
E97C                
E97C AF             	XOR	A
E97D 32 AB EF       	LD	(_FATIX),A
E980 3A 88 EF       	LD	A,(_DRV)
E983 32 AA EF       	LD	(_FATDRV),A
E986 CD E5 EF       	CALL	_RDFAT
E989                RDFATE2:
E989 30 04          	JR	NC,POP_IX_DE_BC_HL_RET
E98B 9F             	SBC	A,A		;A=0xFF
E98C 32 AA EF       	LD	(_FATDRV),A
E98F                POP_IX_DE_BC_HL_RET:
E98F DD E1          	POP	IX
E991 18 D4          	JR	POP_DE_BC_HL_RET2
E993                
E993                WTFATX:
E993 3A A2 EF       	LD	A,(_WTFATF)
E996 B7             	OR	A
E997 C8             	RET	Z
E998 E5             	PUSH	HL
E999 3A AA EF       	LD	A,(_FATDRV)
E99C 21 A5 EF       	LD	HL,_DBDRV
E99F AE             	XOR	(HL)
E9A0 CC 49 E9       	CALL	Z,DWTX
E9A3 38 A2          	JR	C,POP_HL_RET
E9A5 C5             	PUSH	BC
E9A6 D5             	PUSH	DE
E9A7 DD E5          	PUSH	IX
E9A9 CD FA EB       	CALL	WTFAT
E9AC AF             	XOR	A
E9AD 32 A2 EF       	LD	(_WTFATF),A
E9B0 18 DD          	JR	POP_IX_DE_BC_HL_RET
E9B2                
E9B2                NCL1:
E9B2 7A             	LD	A,D
E9B3 B3             	OR	E
E9B4 37             	SCF
E9B5 C8             	RET	Z
E9B6                
E9B6 7A             	LD	A,D
E9B7 CB 3F          	SRL	A	;/2
E9B9 CB 3F          	SRL	A	;/2
E9BB                
E9BB E5             	PUSH	HL
E9BC 32 DB E9       	LD	(NCLPAT+2),A	;_FATIX
E9BF 2A AA EF       	LD	HL,(_FATDRV)	;L=_FATDRV H=_FATIX
E9C2 BC             	CP	H
E9C3 3A 88 EF       	LD	A,(_DRV)	;この間でフラグは変化しない
E9C6 32 DA E9       	LD	(NCLPAT+1),A	;_FATDRV
E9C9 20 05          	JR	NZ,NCL2		;FATIXが違う
E9CB BD             	CP	L
E9CC 20 02          	JR	NZ,NCL2		;ドライブが違う
E9CE E1             	POP	HL
E9CF C9             	RET
E9D0                NCL2:
E9D0 C5             	PUSH	BC
E9D1 D5             	PUSH	DE
E9D2 DD E5          	PUSH	IX
E9D4 CD 93 E9       	CALL	WTFATX
E9D7 38 B6          	JR	C,POP_IX_DE_BC_HL_RET
E9D9 01 00 00       NCLPAT:	LD	BC,0		;自己書き換え C=_FATDRV B=_FATIX
E9DC ED 43 AA EF    	LD	(_FATDRV),BC
E9E0 CD CF EB       	CALL	RDFATS
E9E3 18 A4          	JR	RDFATE2
E9E5                
E9E5                NCL3:
E9E5 CB 9A          	RES	3,D
E9E7 CB 92          	RES	2,D
E9E9 6B             	LD	L,E
E9EA 62             	LD	H,D
E9EB CB 3C          	SRL	H	;
E9ED CB 1D          	RR	L	;HLA=HLA/2
E9EF 1F             	RRA		;
E9F0 F5             	PUSH	AF
E9F1 3A AB EF       	LD	A,(_FATIX)
E9F4 0F             	RRCA
E9F5 30 0B          	JR	NC,NCL3X1
E9F7 3A 13 E8       	LD	A,(SECSZ+2)
E9FA FE 04          	CP	4		;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
E9FC 20 04          	JR	NZ,NCL3X1
E9FE 01 00 02       	LD	BC,512
EA01 09             	ADD	HL,BC
EA02                NCL3X1:
EA02 F1             	POP	AF
EA03 ED 4B 7C F0    	LD	BC,(_FATBF)
EA07 19             	ADD	HL,DE
EA08 09             	ADD	HL,BC
EA09 17             	RLA
EA0A C9             	RET
EA0B                
EA0B                GNCL:
EA0B CD B2 E9       	CALL	NCL1		;GET NEXT CLUSTER
EA0E D8             	RET	C
EA0F C5             	PUSH	BC
EA10 E5             	PUSH	HL
EA11 CD E5 E9       	CALL	NCL3
EA14 38 09          	JR	C,GNC1
EA16 5E             	LD	E,(HL)
EA17 23             	INC	HL
EA18 7E             	LD	A,(HL)
EA19 E6 0F          	AND	00FH
EA1B 57             	LD	D,A
EA1C E1             	POP	HL
EA1D C1             	POP	BC
EA1E C9             	RET
EA1F                GNC1:
EA1F 7E             	LD	A,(HL)
EA20 23             	INC	HL
EA21 56             	LD	D,(HL)
EA22 06 04          	LD	B,4
EA24                GNC1L:
EA24 CB 3A          	SRL	D	;DA=DA/2
EA26 1F             	RRA		;
EA27 10 FB          	DJNZ	GNC1L
EA29                
EA29 5F             	LD	E,A
EA2A E1             	POP	HL
EA2B C1             	POP	BC
EA2C A7             	AND	A
EA2D C9             	RET
EA2E                
EA2E                SNCL:
EA2E CD B2 E9       	CALL	NCL1
EA31 D8             	RET	C
EA32                ;				SET NEXT CLUSTER
EA32 E5             	PUSH	HL
EA33 C5             	PUSH	BC
EA34 D5             	PUSH	DE
EA35 E5             	PUSH	HL
EA36 CD E5 E9       	CALL	NCL3
EA39 D1             	POP	DE
EA3A                ;CF=ODD
EA3A 7E             	LD	A,(HL)
EA3B 73             	LD	(HL),E
EA3C 38 06          	JR	C,SNC1
EA3E                ;EVEN
EA3E                ;M[0] = E
EA3E                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
EA3E 23             	INC	HL
EA3F ED 67          	RRD		;M={A[3:0],E[3:0]}
EA41 7A             	LD	A,D
EA42 18 04          	JR	SNC11
EA44                SNC1:
EA44                ;ODD
EA44                ;HL[0] = (HL[0]&0x0F) | (E<<4)
EA44                ;HL[1] = DE>>4
EA44 ED 6F          	RLD		;M={D[3:0],E[7:4]}
EA46 23             	INC	HL
EA47 72             	LD	(HL),D	;M={D[3:0],E[7:4]}
EA48                SNC11:
EA48 ED 6F          	RLD		;M={M[7:4],D[3:0]}
EA4A B7             	OR	A
EA4B D1             	POP	DE
EA4C C1             	POP	BC
EA4D E1             	POP	HL
EA4E                FAT_CHANGED:
EA4E 3E 01          	LD	A,1
EA50 32 A2 EF       	LD	(_WTFATF),A
EA53 C9             	RET
EA54                
EA54                N16CL3:
EA54 C5             	PUSH	BC
EA55 6B             	LD	L,E
EA56 7A             	LD	A,D
EA57 E6 03          	AND	3
EA59 67             	LD	H,A
EA5A 29             	ADD	HL,HL
EA5B ED 4B 7C F0    	LD	BC,(_FATBF)
EA5F 09             	ADD	HL,BC
EA60 C1             	POP	BC
EA61 C9             	RET
EA62                
EA62                GNCL16:
EA62 CD B2 E9       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EA65 D8             	RET	C
EA66 E5             	PUSH	HL
EA67 CD 54 EA       	CALL	N16CL3
EA6A 5E             	LD	E,(HL)
EA6B 23             	INC	HL
EA6C 56             	LD	D,(HL)
EA6D E1             	POP	HL
EA6E C9             	RET
EA6F                
EA6F                SNCL16:
EA6F CD B2 E9       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EA72 D8             	RET	C
EA73 D5             	PUSH	DE
EA74 E5             	PUSH	HL
EA75 CD 54 EA       	CALL	N16CL3
EA78 D1             	POP	DE		;HL
EA79 73             	LD	(HL),E
EA7A 23             	INC	HL
EA7B 72             	LD	(HL),D
EA7C 6B             	LD	L,E
EA7D 62             	LD	H,D
EA7E D1             	POP	DE
EA7F 18 CD          	JR	FAT_CHANGED
EA81                
EA81                ;------------------------
EA81                ;次のセクタを探す際に_SECPSの値をチェック
EA81                ;in
EA81                ;	DE : セクタ番号
EA81                ;out
EA81                ;	DE : 次のセクタ番号
EA81                ;note
EA81                ;
EA81                ;------------------------
EA81                NEXTX:
EA81 3E 00          _SECPS:	LD	A,0	;自己書き換え
EA83 3C             	INC	A
EA84 E6 00          NCPAT:	AND	0	;自己書き換え　1クラスタの論理セクタ数-1
EA86 32 82 EA       	LD	(_SECPS+1),A
EA89 C9             	RET
EA8A                
EA8A                GNCLX:
EA8A CD 81 EA       	CALL	NEXTX
EA8D C0             	RET	NZ	;1クラスタのセクタ未満の場合は戻る
EA8E C3 F7 EF       	JP	_GNCL	;次のクラスタを探す
EA91                
EA91                RDFAT:
EA91 3E 80          	LD	A,080H
EA93 32 70 EF       	LD	(CHECK),A
EA96                RDFAT1:
EA96 3A 88 EF       	LD	A,(_DRV)
EA99 CD 24 ED       	CALL	CHGDRVR
EA9C D8             	RET	C
EA9D DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EAA0 CB 6F          	BIT	5,A
EAA2 28 43          	JR	Z,RDFAT0X
EAA4 21 70 EF       	LD	HL,CHECK
EAA7 A6             	AND	(HL)
EAA8 77             	LD	(HL),A
EAA9 11 00 00       	LD	DE,0		;BPB
EAAC 2A 7C F0       	LD	HL,(_FATBF)
EAAF CD DB EB       	CALL	DRD16
EAB2 30 24          	JR	NC,GETBPB
EAB4 21 70 EF       	LD	HL,CHECK
EAB7 CB 06          	RLC	(HL)
EAB9 3F             	CCF
EABA D8             	RET	C
EABB DD CB 0A 1E    	RR	(IX+00AH)	;DPB_0A_FDMODE
EABF 3F             	CCF			;フロッピーディスクのMFMモードを切り替える
EAC0 DD CB 0A 16    	RL	(IX+00AH)	;DPB_0A_FDMODE
EAC4 3E FF          	LD	A,0FFH
EAC6 32 89 EF       	LD	(_DSK),A
EAC9 3A 84 EF       	LD	A,(_DRIVE)
EACC E6 03          	AND	3
EACE F6 80          	OR	080H
EAD0 6F             	LD	L,A
EAD1 26 EF          	LD	H,_CYL0/256
EAD3 3E FF          	LD	A,0FFH
EAD5 77             	LD	(HL),A
EAD6 18 BE          	JR	RDFAT1
EAD8                GETBPB:
EAD8 FD E5          	PUSH	IY
EADA FD 2A 7C F0    	LD	IY,(_FATBF)	;BPB
EADE CD F1 EF       	CALL	_BPB2DPB
EAE1 FD E1          	POP	IY
EAE3 D8             	RET	C
EAE4 CD 83 EC       	CALL	CHGDRV2
EAE7                RDFAT0X:
EAE7 CD CF EB       	CALL	RDFATS
EAEA D8             	RET	C
EAEB DD BE 06       	CP	(IX+6)		;DPB_06_FATID
EAEE C8             	RET	Z
EAEF DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
EAF3 C0             	RET	NZ		;BPBを取得している場合はFATIDをチェックしない
EAF4 37             	SCF
EAF5 C9             	RET
EAF6                
EAF6                BPB2DPB:
EAF6 FD 7E 0B       	LD	A,(IY+11)	;BPB_BytsPerSec
EAF9 B7             	OR	A
EAFA 37             	SCF
EAFB C0             	RET	NZ
EAFC                BPBOK:
EAFC FD 7E 0D       	LD	A,(IY+13)	;BPB_SecPerClus
EAFF DD 77 07       	LD	(IX+7),A	;DPB_07_SECPCL
EB02                
EB02 FD 7E 16       	LD	A,(IY+22)	;BPB_FATSz16
EB05 DD 77 00       	LD	(IX+0),A	;DPB_00_FATLN
EB08 FD 7E 17       	LD	A,(IY+23)	;BPB_FATSz16
EB0B DD 77 01       	LD	(IX+1),A	;DPB_00_FATLN
EB0E                
EB0E FD 6E 0E       	LD	L,(IY+14)	;BPB_RsvdSecCnt
EB11 FD 66 0F       	LD	H,(IY+15)
EB14 DD 75 0E       	LD	(IX+00EH),L	;DPB_0E_FATPS
EB17 FD 5E 16       	LD	E,(IY+22)	;BPB_FATSz16
EB1A FD 56 17       	LD	D,(IY+23)
EB1D FD 46 10       	LD	B,(IY+16)	;BPB_NumFATs
EB20                BPBDP1:				;BPB_FATSz16 * BPB_NumFATs
EB20 19             	ADD	HL,DE
EB21 10 FD          	DJNZ	BPBDP1
EB23                BPBDP2:
EB23 DD 75 10       	LD	(IX+010H),L	;DPB_10_DIRPS
EB26 DD 74 11       	LD	(IX+011H),H
EB29 E5             	PUSH	HL
EB2A                
EB2A FD 6E 11       	LD	L,(IY+17)	;BPB_RootEntCnt
EB2D FD 66 12       	LD	H,(IY+18)
EB30 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EB33 B7             	OR	A
EB34 37             	SCF
EB35 C8             	RET	Z
EB36 06 06          	LD	B,6
EB38                BPBBPS1:
EB38 05             	DEC	B
EB39 0F             	RRCA
EB3A 30 FC          	JR	NC,BPBBPS1
EB3C                BPBDE1:
EB3C 29             	ADD	HL,HL
EB3D 10 FD          	DJNZ	BPBDE1
EB3F                
EB3F 7C             	LD	A,H
EB40 DD 77 0B       	LD	(IX+00BH),A	;DPB_0B_DIRSCNT
EB43                
EB43 D1             	POP	DE		;DPB_10_DIRPS
EB44 6C             	LD	L,H
EB45 26 00          	LD	H,0
EB47 19             	ADD	HL,DE		;MAXDIR
EB48 E5             	PUSH	HL
EB49 FD 4E 0D       	LD	C,(IY+13)	;BPB_SecPerClus
EB4C CB 21          	SLA	C		;*2
EB4E AF             	XOR	A
EB4F 47             	LD	B,A
EB50 ED 42          	SBC	HL,BC
EB52 DD 75 14       	LD	(IX+014H),L	;DPB_14_ADDCL16
EB55 DD 74 15       	LD	(IX+015H),H
EB58                
EB58 D1             	POP	DE		;DE=DPB_0B_MAXDIR
EB59 FD 6E 13       	LD	L,(IY+19)	;BPB_TotSec16
EB5C FD 66 14       	LD	H,(IY+20)
EB5F                
EB5F DD CB 0A 7E    	BIT	7,(IX+00AH)	;DPB_0A_FDMODE
EB63 28 17          	JR	Z,NOT_FD
EB65 E5             	PUSH	HL
EB66 FD 4E 18       	LD	C,(IY+24)	;BPB_SecPerTr
EB69 DD 71 0D       	LD	(IX+00DH),C	;DPB_0D_MAXSEC
EB6C AF             	XOR	A
EB6D 47             	LD	B,A
EB6E CB 21          	SLA	C		;両面なのでセクタ数を２倍
EB70 2B             	DEC	HL
EB71                CNTSEC:				;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
EB71 3C             	INC	A
EB72 28 04          	JR	Z,CNTSECE
EB74 ED 42          	SBC	HL,BC
EB76 30 F9          	JR	NC,CNTSEC
EB78                CNTSECE:
EB78 DD 77 0C       	LD	(IX+00CH),A	;DPB_0C_MAXCYL
EB7B E1             	POP	HL	;ここまでフロッピー専用
EB7C                NOT_FD:
EB7C 7C             	LD	A,H
EB7D B5             	OR	L
EB7E 3E 00          	LD	A,0		;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
EB80 20 10          	JR	NZ,BPB16BIT	;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
EB82 FD 7E 23       	LD	A,(IY+35)	;念のために総セクタ数が24ビットを超える場合はエラーを返す
EB85 B7             	OR	A
EB86 37             	SCF
EB87 C0             	RET	NZ
EB88 FD 6E 20       	LD	L,(IY+32)	;BPB_TotSec32 は AHL の24ビットで扱う
EB8B FD 66 21       	LD	H,(IY+33)	;1クラスタの論理セクタ数(DPB_07_SECPCL)が最大128なので
EB8E FD 7E 22       	LD	A,(IY+34)	;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
EB91 A7             	AND	A		;CF=0
EB92                BPB16BIT:
EB92 ED 52          	SBC	HL,DE
EB94 DE 00          	SBC	A,0
EB96 FD 46 0D       	LD	B,(IY+13)	;BPB_SecPerClus
EB99                BPBTC1:				;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
EB99 CB 18          	RR	B		;->CY
EB9B 38 08          	JR	C,BPBTC2
EB9D CB 3F          	SRL	A
EB9F CB 1C          	RR	H		;AHL=AHL/2
EBA1 CB 1D          	RR	L
EBA3 18 F4          	JR	BPBTC1
EBA5                BPBTC2:
EBA5 B7             	OR	A
EBA6 37             	SCF
EBA7 C0             	RET	NZ		;念のため(クラスタ数が16ビットを超える場合)
EBA8 23             	INC	HL
EBA9 23             	INC	HL
EBAA DD 75 08       	LD	(IX+8),L	;DPB_08_MAXCL
EBAD DD 74 09       	LD	(IX+9),H
EBB0                
EBB0 FD 7E 15       	LD	A,(IY+21)	;BPB_Media
EBB3 DD 77 06       	LD	(IX+6),A	;DPB_06_FATID
EBB6                
EBB6 FD 7E 10       	LD	A,(IY+16)	;BPB_NumFATs
EBB9 C6 FE          	ADD	A,0-2		;>2:CF=1
EBBB FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EBBE 6F             	LD	L,A
EBBF 30 02          	JR	NC,BPBFAT1
EBC1 F6 80          	OR	080H
EBC3                BPBFAT1:
EBC3 DD 77 0F       	LD	(IX+00FH),A	;DPB_0F_BPS
EBC6 2D             	DEC	L		;以下のセクタサイズに合致しない場合はCF=1でエラーにする
EBC7 C8             	RET	Z		;1セクタ256バイト
EBC8 2D             	DEC	L
EBC9 C8             	RET	Z		;1セクタ512バイト
EBCA 2D             	DEC	L
EBCB 2D             	DEC	L
EBCC C8             	RET	Z		;1セクタ1024バイト
EBCD 37             	SCF
EBCE C9             	RET
EBCF                
EBCF                RDFATS:
EBCF CD 15 EC       	CALL	FATSETUP
EBD2 D8             	RET	C
EBD3 CD DF EB       	CALL	DRD24B
EBD6 2A 7C F0       	LD	HL,(_FATBF)
EBD9 7E             	LD	A,(HL)
EBDA C9             	RET
EBDB                
EBDB                DRD16:
EBDB 0E 00          	LD	C,0
EBDD                DRD24:
EBDD 06 01          	LD	B,1
EBDF                DRD24B:
EBDF DD E5          	PUSH	IX
EBE1 DD 2A A8 EF    	LD	IX,(_DPB)
EBE5 CD 3F EE       DRDPAT:	CALL	FDRD		;自己書き換え（ディスク読み込み）
EBE8                POP_IX_RET:
EBE8 DD E1          	POP	IX
EBEA C9             	RET
EBEB                
EBEB                DWT16:
EBEB 0E 00          	LD	C,0
EBED                DWT24:
EBED 06 01          	LD	B,1
EBEF                DWT24B:
EBEF DD E5          	PUSH	IX
EBF1 DD 2A A8 EF    	LD	IX,(_DPB)
EBF5 CD 31 EE       DWTPAT:	CALL	FDWT		;自己書き換え（ディスク書き込み）
EBF8 18 EE          	JR	POP_IX_RET
EBFA                
EBFA                WTFAT:
EBFA CD 15 EC       	CALL	FATSETUP
EBFD D4 EF EB       	CALL	NC,DWT24B
EC00 D8             	RET	C
EC01 DD CB 0F 7E    	BIT	7,(IX+00FH)	;DPB_0F_BPS
EC05 C8             	RET	Z		;予備FATが無い
EC06 CD 1C EC       	CALL	FATS2
EC09 E5             	PUSH	HL		;予備FAT
EC0A DD 6E 00       	LD	L,(IX+0)	;DPB_00_FATLN
EC0D DD 66 01       	LD	H,(IX+1)
EC10 19             	ADD	HL,DE
EC11 EB             	EX	DE,HL
EC12 E1             	POP	HL
EC13 18 DA          	JR	DWT24B
EC15                ;------------------------
EC15                ;FATのセットアップ
EC15                ;out
EC15                ;	B  : FATセクタ数
EC15                ;	DE : FAT先頭セクタ番号
EC15                ;	HL : FATバッファポインタ
EC15                ;	CF : 1=ドライブ切り替えエラー
EC15                ;note
EC15                ;	FATサイズがFATバッファを超える場合は
EC15                ;	対象クラスタ領域==(_FATIX)によって
EC15                ;	FAT12:対象クラスタ1024毎に1.5KBを切り替える
EC15                ;	FAT16:対象クラスタ1024毎に2KBを切り替える
EC15                ;------------------------
EC15                FATSETUP:
EC15 3A AA EF       	LD	A,(_FATDRV)
EC18 CD 24 ED       	CALL	CHGDRVR		;ドライブ切り替え
EC1B D8             	RET	C
EC1C                FATS2:
EC1C DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS 512=2 1024=4
EC1F 0F             	RRCA
EC20 CD 49 EC       FATSX:	CALL	FATSETUP12	;自己書き換え
EC23 21 00 00       	LD	HL,0
EC26 4A             	LD	C,D
EC27 54             	LD	D,H
EC28 3A AB EF       	LD	A,(_FATIX)	;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
EC2B 47             	LD	B,A
EC2C 04             	INC	B
EC2D DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
EC30                FAT_SKP:
EC30 05             	DEC	B
EC31 28 05          	JR	Z,FAT1
EC33 19             	ADD	HL,DE
EC34 93             	SUB	E
EC35 30 F9          	JR	NC,FAT_SKP
EC37 C9             	RET
EC38                FAT1:
EC38 EB             	EX	DE,HL
EC39 B9             	CP	C		;C=FATバッファに読み込めるセクタ数
EC3A 38 01          	JR	C,FAT2
EC3C 79             	LD	A,C
EC3D                FAT2:
EC3D 47             	LD	B,A
EC3E                
EC3E 2A FA F0       	LD	HL,(_FATPS)	;fat sector pos
EC41 19             	ADD	HL,DE
EC42 EB             	EX	DE,HL
EC43 2A 7C F0       	LD	HL,(_FATBF)
EC46 AF             	XOR	A		;CF=0
EC47 4F             	LD	C,A
EC48 C9             	RET
EC49                ;
EC49                ;	FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
EC49                ;	FATSETUP* (FAT12/FAT16)
EC49                ;out
EC49                ;	D : FATバッファに読み込める最大のセクタ数
EC49                ;	E : _FATIXで進めるセクタ数
EC49                FATSETUP12:
EC49 11 06 06       	LD	DE,0606H	;256
EC4C D8             	RET	C
EC4D 11 03 03       	LD	DE,0303H	;512
EC50 0F             	RRCA
EC51 D8             	RET	C
EC52 11 01 02       	LD	DE,0201H	;1024
EC55 C9             	RET
EC56                
EC56                FATSETUP16:
EC56 11 08 08       	LD	DE,0808H	;256
EC59 D8             	RET	C
EC5A 11 04 04       	LD	DE,0404H
EC5D 0F             	RRCA			;512
EC5E D8             	RET	C
EC5F 11 02 02       	LD	DE,0202H	;1024
EC62 C9             	RET
EC63                
EC63                CHGDRV:
EC63 E5             	PUSH	HL
EC64 21 89 EF       	LD	HL,_DSK
EC67 BE             	CP	(HL)
EC68 28 0A          	JR	Z,CHGDRVE
EC6A                CHGDRV1:
EC6A DD E5          	PUSH	IX
EC6C CD 76 EC       	CALL	CHGDRV0
EC6F 3A 89 EF       	LD	A,(_DSK)
EC72 DD E1          	POP	IX
EC74                CHGDRVE:
EC74 E1             	POP	HL
EC75 C9             	RET
EC76                
EC76                CHGDRV0:
EC76 6F             	LD	L,A
EC77 CD DC EF       	CALL	_GETDPB
EC7A D8             	RET	C
EC7B DD 22 A8 EF    	LD	(_DPB),IX
EC7F 7D             	LD	A,L
EC80 32 89 EF       	LD	(_DSK),A
EC83                CHGDRV2:
EC83 C5             	PUSH	BC
EC84 D5             	PUSH	DE
EC85 ED 73 DA EC    	LD	(SPPAT2+1),SP
EC89 F3             	DI
EC8A DD F9          	LD	SP,IX
EC8C                
EC8C E1             	POP	HL		;DPB_00_FATLN
EC8D E1             	POP	HL		;DPB_02_DRD
EC8E 22 E6 EB       	LD	(DRDPAT+1),HL
EC91                
EC91 E1             	POP	HL
EC92 22 F6 EB       	LD	(DWTPAT+1),HL	;DPB_04_DWT
EC95                
EC95 E1             	POP	HL		;L=DPB_06_FATID H=DPB_07_SECPCL
EC96 7C             	LD	A,H
EC97 32 F5 E2       	LD	(SPCPAT+1),A	;1クラスタの論理セクタ数
EC9A 3D             	DEC	A
EC9B 32 85 EA       	LD	(NCPAT+1),A
EC9E                
EC9E E1             	POP	HL		;DPB_08_MAXCL
EC9F 7D             	LD	A,L
ECA0 32 14 E3       	LD	(CLPAT2+1),A
ECA3 7C             	LD	A,H
ECA4 32 10 E3       	LD	(CLPAT1+1),A
ECA7 2B             	DEC	HL
ECA8 22 18 E5       	LD	(MAXCLP+1),HL
ECAB                
ECAB E1             	POP	HL		;L=DPB_0A_FDMODE H=DPB_0B_DIRSCNT
ECAC 7D             	LD	A,L
ECAD F6 FE          	OR	0FEH
ECAF 32 DA ED       	LD	(FDMODE+1),A
ECB2 07             	RLCA
ECB3 E6 03          	AND	3
ECB5 32 C2 ED       	LD	(FSPAT+1),A
ECB8 4C             	LD	C,H
ECB9                
ECB9 E1             	POP	HL		;L=DPB_0C_MAXCYL H=DPB_0D_MAXSEC
ECBA                
ECBA E1             	POP	HL		;L=DPB_0E_FATPS H=DPB_0F_BPS
ECBB 7C             	LD	A,H		;DPB_0F_BPS
ECBC E6 07          	AND	7
ECBE 32 13 E8       	LD	(SECSZ+2),A	;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
ECC1                				;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
ECC1                				;1セクタ1024 2HD/2HDE98
ECC1                				;1セクタ256 GRAM/RAMF/CMOS/等
ECC1                				;1024	512	256
ECC1                				;4	2	1
ECC1 87             	ADD	A,A		;8	4	2
ECC2 87             	ADD	A,A		;010H	8	4
ECC3 87             	ADD	A,A		;020H	010H	8
ECC4 32 71 E1       	LD	(SDECPAT+1),A	;1セクタ辺りのディレクトリエントリ数
ECC7                
ECC7 26 00          	LD	H,0
ECC9 22 FA F0       	LD	(_FATPS),HL
ECCC                
ECCC E1             	POP	HL		;DPB_10_DIRPS
ECCD 22 FC F0       	LD	(_DIRPS),HL
ECD0                
ECD0 E1             	POP	HL		;L=DPB_12_DEVICE H=DPB_13_UNITNO
ECD1 7C             	LD	A,H
ECD2 32 84 EF       	LD	(_DRIVE),A
ECD5                
ECD5 E1             	POP	HL		;DPB_14_ADDCL16
ECD6 22 05 E3       	LD	(CLSPAT+1),HL
ECD9                
ECD9 31 00 00       SPPAT2:	LD	SP,0		;元のSPを復元
ECDC FB             	EI
ECDD 2A FC F0       	LD	HL,(_DIRPS)
ECE0 06 00          	LD	B,0
ECE2 09             	ADD	HL,BC		;C=DPB_0B_DIRSCNT
ECE3 22 8C E1       	LD	(MD_PAT+1),HL
ECE6                
ECE6 2A 18 E5       	LD	HL,(MAXCLP+1);
ECE9 11 F6 0F       	LD	DE,4086		;クラスタ数が4086未満:FAT12 4086以上:FAT16
ECEC ED 52          	SBC	HL,DE		;CF=0のはず
ECEE 30 0F          	JR	NC,SETFAT16
ECF0 21 0B EA       	LD	HL,GNCL		;FAT12
ECF3 11 2E EA       	LD	DE,SNCL
ECF6 01 49 EC       	LD	BC,FATSETUP12
ECF9 DD CB 0F AE    	RES	5,(IX+00FH)	;DPB_0F_BPS(FAT12)
ECFD 18 0D          	JR	EXTRA1
ECFF                SETFAT16:
ECFF 21 62 EA       	LD	HL,GNCL16	;FAT16
ED02 11 6F EA       	LD	DE,SNCL16
ED05 01 56 EC       	LD	BC,FATSETUP16
ED08 DD CB 0F EE    	SET	5,(IX+00FH)	;DPB_0F_BPS(FAT16)
ED0C                EXTRA1:
ED0C 22 F8 EF       	LD	(GNCPAT+1),HL
ED0F ED 53 FB EF    	LD	(SNCPAT+1),DE
ED13 ED 43 21 EC    	LD	(FATSX+1),BC
ED17 D1             	POP	DE
ED18 C1             	POP	BC
ED19 AF             	XOR	A
ED1A C9             	RET
ED1B                
ED1B                GETDPBD:
ED1B DD E3          	EX	(SP),IX
ED1D DD E5          	PUSH	IX
ED1F 3A 88 EF       	LD	A,(_DRV)
ED22 18 07          	JR	GETDPB1
ED24                
ED24                CHGDRVR:
ED24 CD D9 EF       	CALL	_CHGDRV
ED27 D8             	RET	C
ED28 3A 89 EF       	LD	A,(_DSK)
ED2B                GETDPB1:
ED2B C3 DC EF       	JP	_GETDPB
ED2E                
ED2E                GETDPB:
ED2E FE 08          	CP	8
ED30 3F             	CCF
ED31 D8             	RET	C
ED32 0F             	RRCA
ED33 0F             	RRCA
ED34 0F             	RRCA
ED35 DD             	DB	0DDH		;Z80未定義命令
ED36 6F             	LD	L,A		;LD	IXL,A
ED37 DD             	DB	0DDH		;Z80未定義命令
ED38 26 F1          	LD	H,DEVICE/256	;LD	IXH,DEVICE/256
ED3A DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
ED3D A7             	AND	A		;CF=0の為
ED3E DD CB 0F 6E    	BIT	5,(IX+00FH)	;DPB_0F_BPS
ED42 C0             	RET	NZ		;FAT16
ED43 DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
ED47 C0             	RET	NZ		;BPB
ED48 FE 01          	CP	001H		;A=0 THEN CF=1
ED4A C9             	RET
ED4B                
ED4B                _SYS5F:
ED4B AF             	XOR	A
ED4C                FFLUSH:
ED4C F5             	PUSH	AF
ED4D 3E FF          	LD	A,0FFH
ED4F 32 39 EF       	LD	(SFILE),A
ED52 CD 49 E9       	CALL	DWTX
ED55 3E FF          	LD	A,0FFH
ED57 32 A5 EF       	LD	(_DBDRV),A
ED5A CD 93 E9       	CALL	WTFATX
ED5D AF             	XOR	A
ED5E 32 AB EF       	LD	(_FATIX),A
ED61 2F             	CPL			;0FFH
ED62 32 AA EF       	LD	(_FATDRV),A
ED65 F1             	POP	AF
ED66 C9             	RET
ED67                
ED67                	INCLUDE	"X1DISK.ASM"
ED67                
ED67                ;	LSX-Dodgers DISK
ED67                ;	X1/turbo/Z
ED67                
ED67                SEEK:
ED67 06 10          	LD	B,16
ED69 DD 4E 0D       	LD	C,(IX+0DH)	;DPB_0D_MAXSEC
ED6C AF             	XOR	A
ED6D EB             	EX	DE,HL
ED6E                DIV1:
ED6E 29             	ADD	HL,HL
ED6F 8F             	ADC	A,A
ED70 B9             	CP	C
ED71 38 02          	JR	C,DIV2
ED73 91             	SUB	C
ED74 2C             	INC	L
ED75                DIV2:
ED75 10 F7          	DJNZ	DIV1
ED77                
ED77 3C             	INC	A	;最小のセクタは１固定
ED78 55             	LD	D,L	;TRACK
ED79 5F             	LD	E,A	;SECTOR
ED7A CB 3A          	SRL	D	;CYLINDER
ED7C 9F             	SBC	A,A
ED7D E6 10          	AND	010H	;SIDE
ED7F 4F             	LD	C,A
ED80                
ED80 3A 84 EF       	LD	A,(_DRIVE)
ED83 FE 04          	CP	4
ED85 3F             	CCF
ED86 D8             	RET	C
ED87 B1             	OR	C
ED88 32 06 EE       	LD	(MOPAT+1),A	;Motor off data
ED8B 01 FC 0F       	LD	BC,00FFCH
ED8E F6 80          	OR	080H		;Motor on
ED90 ED 79          	OUT	(C),A
ED92                
ED92 CD D8 ED       	CALL	SETMODE
ED95 D8             	RET	C
ED96                
ED96 CD 1B EE       	CALL	DRIVE
ED99 FE FF          	CP	0FFH		;A=0FFH Unknown CYLINDER
ED9B CC FA ED       	CALL	Z,FDCRES	;Restore
ED9E 0E F9          	LD	C,0F9H
EDA0 ED 79          	OUT	(C),A		;Currrent CYLINDER
EDA2 92             	SUB	D
EDA3 C8             	RET	Z		;No seek
EDA4                
EDA4 3A 86 EF       	LD	A,(_ISEEK)
EDA7 4F             	LD	C,A
EDA8                
EDA8 DD 7E 0C       	LD	A,(IX+00CH)	;DPB_0C_MAXCYL
EDAB 3D             	DEC	A
EDAC BA             	CP	D		;Over CYLINDER
EDAD D8             	RET	C
EDAE                
EDAE B9             	CP	C		;for Built-in 2DD
EDAF 38 03          	JR	C,SETM2
EDB1 78             	LD	A,B		;B=00FH
EDB2 DB FE          	IN	A,(0FEH)		;2HD mode for 2DD seek
EDB4                SETM2:
EDB4 78             	LD	A,B
EDB5 DB FD          	IN	A,(0FDH)		;MFM mode
EDB7                
EDB7 0E FB          	LD	C,0FBH
EDB9 ED 51          	OUT	(C),D
EDBB 72             	LD	(HL),D
EDBC 0E 18          	LD	C,018H		;Seek
EDBE                FDCCMD2:
EDBE 3A 85 EF       	LD	A,(_SEEKSP)
EDC1 E6 FF          FSPAT:	AND	0FFH
EDC3 B1             	OR	C
EDC4                
EDC4                FDCCMD:
EDC4 CD 11 EE       	CALL	COMSET
EDC7                
EDC7 3E 80          FDCPAT:	LD	A,080H		;FDC COMMAND(Self-modifying code)
EDC9 E6 20          	AND	020H		;Write data Write track
EDCB 3C             	INC	A
EDCC                
EDCC                SST:
EDCC 0E 00          	LD	C,0
EDCE                SST1:
EDCE 0D             	DEC	C		; 4
EDCF 20 FD          	JR	NZ,SST1		;12 * 256 / 4 = About 1ms
EDD1 3D             	DEC	A
EDD2 20 FA          	JR	NZ,SST1
EDD4                
EDD4 3C             	INC	A		;A=1
EDD5 CD E3 ED       	CALL	READY
EDD8                SETMODE:
EDD8 78             	LD	A,B		;B=00FH
EDD9 DB FF          FDMODE:	IN	A,(0FFH)	;Floppy mode(2D/2HD) (Self-modifying code)
EDDB                
EDDB 78             	LD	A,B
EDDC DB FD          	IN	A,(0FDH)	;MFM mode
EDDE                
EDDE CD 15 EE       	CALL	DELAY0		;Head select time
EDE1 3E 81          	LD	A,081H
EDE3                READY:
EDE3 32 ED ED       	LD	(WAITA+1),A
EDE6 E5             	PUSH	HL
EDE7 0E F8          	LD	C,0F8H
EDE9 61             	LD	H,C
EDEA                READY2:
EDEA ED 78          	IN	A,(C)
EDEC E6 81          WAITA:	AND	081H		;NOT READY,BUSY
EDEE 28 08          	JR	Z,READYE
EDF0 E3             	EX	(SP),HL		;wait 19clock
EDF1 E3             	EX	(SP),HL		; //
EDF2 2B             	DEC	HL
EDF3 7C             	LD	A,H
EDF4 B5             	OR	L
EDF5 20 F3          	JR	NZ,READY2
EDF7 37             	SCF
EDF8                READYE:
EDF8 E1             	POP	HL
EDF9 C9             	RET
EDFA                
EDFA                FDCRES:
EDFA 36 00          	LD	(HL),0
EDFC 0E 08          	LD	C,8
EDFE 18 BE          	JR	FDCCMD2
EE00                
EE00                FDMOFF:
EE00 F5             	PUSH	AF
EE01 C5             	PUSH	BC
EE02 01 FC 0F       	LD	BC,00FFCH	;Motor off
EE05 3E 00          MOPAT:	LD	A,000H		;(Self-rewriting)
EE07 ED 79          	OUT	(C),A
EE09 C1             	POP	BC
EE0A F1             	POP	AF
EE0B C9             	RET
EE0C                
EE0C                SECSET:
EE0C 01 FA 0F       	LD	BC,00FFAH
EE0F ED 59          	OUT	(C),E
EE11                COMSET:
EE11 0E F8          	LD	C,0F8H
EE13 ED 79          	OUT	(C),A
EE15                DELAY0:
EE15 3E 1A          	LD	A,26
EE17                DELAY:
EE17 3D             	DEC	A
EE18 20 FD          	JR	NZ,DELAY
EE1A C9             	RET
EE1B                
EE1B                DRIVE:
EE1B 2A 84 EF       	LD	HL,(_DRIVE)
EE1E 26 EF          	LD	H,_CYL0/256
EE20 CB FD          	SET	7,L
EE22 7E             	LD	A,(HL)
EE23 C9             	RET
EE24                
EE24                RNF:
EE24 CD 1B EE       	CALL	DRIVE
EE27 36 FF          	LD	(HL),0FFH
EE29 C9             	RET
EE2A                
EE2A 02             RETRY:	DB	2
EE2B                
EE2B                
EE2B                ;	FLOPPY DISK DRIVER(DMA)
EE2B                
EE2B                
EE2B                WTTRK:
EE2B 06 01          	LD	B,1
EE2D 3E F4          	LD	A,0F4H
EE2F 18 02          	JR	WTTRK1
EE31                FDWT:
EE31 3E A0          	LD	A,0A0H
EE33                WTTRK1:
EE33 32 C8 ED       	LD	(FDCPAT+1),A
EE36 3E 10          	LD	A,16
EE38 18 0C          	JR	DISK
EE3A                
EE3A                DISKOK:
EE3A 06 01          FDCNT:	LD	B,1
EE3C 10 0B          	DJNZ	DISK1
EE3E C9             	RET
EE3F                
EE3F                FDRD:
EE3F 3E 80          	LD	A,080H
EE41 32 C8 ED       	LD	(FDCPAT+1),A
EE44 3E 0E          	LD	A,14
EE46                
EE46                DISK:
EE46 32 5D EE       	LD	(DMAPAT+1),A
EE49                DISK1:
EE49 78             	LD	A,B
EE4A 32 3B EE       	LD	(FDCNT+1),A
EE4D 22 B5 EE       	LD	(DMAD+11),HL
EE50                DISKR:
EE50 3E 02          	LD	A,2		;Retry count
EE52 32 2A EE       	LD	(RETRY),A
EE55                DISK2:
EE55 D5             	PUSH	DE
EE56 CD 67 ED       	CALL	SEEK
EE59 38 43          	JR	C,ERRF
EE5B F3             	DI
EE5C                
EE5C 3E 0E          DMAPAT:	LD	A,14		;自己書き換え
EE5E 21 AA EE       	LD	HL,DMAD
EE61 CD 14 DF       	CALL	SETDMA
EE64 ED 49          	OUT	(C),C		;OUT 01F87H,087H WR6 イネーブル
EE66 3A C8 ED       	LD	A,(FDCPAT+1)
EE69 C5             	PUSH	BC
EE6A CD 0C EE       	CALL	SECSET
EE6D 2A B5 EE       	LD	HL,(DMAHL)
EE70 23             	INC	HL
EE71 11 06 BB       	LD	DE,0BB06H	;READ DMA
EE74                
EE74 3E 03          	LD	A,3
EE76 CD E3 ED       	CALL	READY
EE79 ED 78          	IN	A,(C)
EE7B                
EE7B C1             	POP	BC
EE7C ED 51          	OUT	(C),D		;読み出しマスク設定
EE7E ED 59          	OUT	(C),E		;バイトカウンタ(LH)
EE80 ED 58          	IN	E,(C)
EE82 ED 50          	IN	D,(C)
EE84 19             	ADD	HL,DE
EE85 D1             	POP	DE
EE86 13             	INC	DE
EE87 FB             	EI
EE88 CD 00 EE       	CALL	FDMOFF
EE8B B7             	OR	A
EE8C 28 AC          	JR	Z,DISKOK
EE8E 1B             	DEC	DE
EE8F CB 67          	BIT	4,A
EE91 C4 24 EE       	CALL	NZ,RNF
EE94                DISKE2:
EE94 21 2A EE       	LD	HL,RETRY
EE97 35             	DEC	(HL)
EE98 20 BB          	JR	NZ,DISK2
EE9A B7             	OR	A
EE9B 28 0A          	JR	Z,ERR
EE9D D5             	PUSH	DE
EE9E                ERRF:
EE9E D1             	POP	DE
EE9F                DELP:
EE9F CD 24 EE       	CALL	RNF
EEA2 CD 00 EE       	CALL	FDMOFF
EEA5 3E FF          	LD	A,0FFH
EEA7                ERR:
EEA7 BF             	CP	A
EEA8 37             	SCF
EEA9 C9             	RET
EEAA                
EEAA                			;X1turbo DISK DMA
EEAA C3             DMAD:	DB	0C3H	;WR6 リセット
EEAB 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
EEAC FB 0F          	DW	00FFBH	;ポートA開始アドレス FDC データレジスタ
EEAE FF FF          	DW	0FFFFH	;ブロック長(転送サイズ-1)
EEB0 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
EEB1 10             	DB	010H	;WR2 ポートBインクリメント
EEB2 80             	DB	080H	;WR3
EEB3 92             	DB	092H	;WR5 WAIT RDY:LOW
EEB4 8D             	DB	08DH	;WR4 バイト ポートB開始アドレス(LH)
EEB5 00 00          DMAHL:	DW	0	;ポートB開始アドレス
EEB7 CF             	DB	0CFH	;WR6 ロード
EEB8 01             	DB	001H	;WR0 ポートB←ポートB 転送
EEB9 CF             	DB	0CFH	;WR6 ロード
EEBA                
EEBA                DMAE:
EEBA                
EEBA 00 00 1E 98    AT_R	EQU	WTTRK-AT_DWT
EEBA                
EEBA                	INCLUDE	"LDWORK.ASM"
EEBA                
EEBA                ;	LSX-Dodgers WORK0
EEBA                ;
EEBA                ;	CP/M互換BIOS
EEBA                ;	BOOT:アドレス下位1バイトが0になるように
EEBA                AT_WORK:
EEBA                	DS	WORKAD-AT_WORK
EF00                
EF00                CPM_BOOT:
EF00 C3 00 00       	JP	0
EF03                _SYS00:		;(BDOS)プログラム終了
EF03                CPM_WBOOT:
EF03 C3 09 D1       	JP	WBOOT1
EF06                CPM_CONST:
EF06 C3 BE DB       	JP	CONSTX
EF09                _SYS07:		;(BDOS)コンソール直接入力
EF09                CPM_CONIN:
EF09 C3 65 DB       	JP	FLGET
EF0C                CPM_CONOUT:
EF0C C3 05 DE       	JP	CONOUT1
EF0F                
EF0F                DECBF:
EF0F                	DS	5
EF14 00             FDRV	DB	0
EF15                FNAME	DS	36
EF39                SFILE:	DS	33		;DRV FILENAME
EF5A                HLBUF:	DS	3		;Random record buffer
EF5D                
EF5D 00 00          LEFTX:	DW	0
EF5F 00 00          DTAX:	DW	0
EF61                
EF61                ZERO:
EF61                BEEPD:
EF61 00 8E 01 00    	DB	0,08EH,1,0,00BH,0,00CH,010H
EF65 0B 00 0C 10
EF69 07 3E 08 10    	DB	007H,03EH,008H,010H,00DH,0,0FFH
EF6D 0D 00 FF
EF70 00 00 EF 62    RTC_YY	EQU	BEEPD+1
EF70 00 00 EF 63    RTC_MW	EQU	BEEPD+2
EF70 00 00 EF 64    RTC_DD	EQU	BEEPD+3
EF70 00 00 EF 65    RTC_TT	EQU	BEEPD+4
EF70 00 00 EF 66    RTC_MM	EQU	BEEPD+5
EF70 00 00 EF 67    RTC_SS	EQU	BEEPD+6
EF70                
EF70 00             CHECK:	DB	0
EF71                
EF71 4F 4B 24       OK:	DB	"OK$"
EF74                	DS	5
EF79 45 72 72 6F    COMERM:	DB	"Error!$"
EF7D 72 21 24
EF80                ;	システムワークエリア
EF80                ;	_CYL0:アドレス下位1バイトが080Hになるように
EF80 FF             _CYL0:	DB	0FFH	;Cylinder
EF81 FF             _CYL1:	DB	0FFH	;Cylinder
EF82 FF             _CYL2:	DB	0FFH	;Cylinder
EF83 FF             _CYL3:	DB	0FFH	;Cylinder
EF84 00             _DRIVE:	DB	0	;unit number
EF85 00             _SEEKSP:DB	0	;Seek speed
EF86 FF             _ISEEK:	DB	0FFH	;
EF87 00             _DVSW:	DB	0
EF88 00             _DRV:	DB	0
EF89 FF             _DSK:	DB	0FFH
EF8A 80 00          _DTA:	DW	00080H
EF8C 00 00          _CTC:	DW	0
EF8E 00 00          _TXADR:	DW	0
EF90 00 00          _KEYPS:	DW	0
EF92 00 FF          _KEYD:	DW	0FF00H	;キーデータ
EF94 C2 10          _KEYSP:	DW	010C2H
EF96 07             _COLORF:DB	COLORF	;色
EF97 18             _LINE:	DB	LINE
EF98                
EF98 00 00          _FCB:	DW	0
EF9A 00 00          _FBPS:	DW	0	;SEARCH FILES
EF9C 00 00          _FBAD:	DW	0	;    //
EF9E 00             _FBCNT:	DB	0	;    //
EF9F 00             _FILEN:	DB	0
EFA0 00             _DIRF:	DB	0	;bit7:ディレクトリ bit0-6:セクタインデックス
EFA1                	DS	1
EFA2 00             _WTFATF:DB	0	;FATバッファの更新フラグ
EFA3                	DS	1
EFA4 00             _WTDBF:	DB	0	;データバッファの更新フラグ
EFA5 FF             _DBDRV:	DB	0FFH	;データバッファにあるデータを読み込んだドライブ
EFA6 00 00          _DBSEC:	DW	0	;データバッファにあるデータを読み込んだセクタ番号
EFA8 00 00          _DPB:	DW	0
EFAA                _FATDRV:
EFAA FF             	DB	0FFH	;FATバッファに読み込んでいるドライブ
EFAB 00             _FATIX:	DB	0	;FATバッファに読み込んでいるインデックス
EFAC                _FAKEFREE:
EFAC 00 00          	DW	0	;偽の残量（FATサイズが大きくなると重くなるのでその対策）
EFAE                
EFAE                	DS	2
EFB0                
EFB0                CRTCD:	
EFB0 6F             	DB	06FH
EFB1                _WIDTH:	
EFB1 50             	DB	WIDTH
EFB2                TVRAMTOP:
EFB2 59 38          	DB	059H,038H
EFB4 1F 02          	DB	01FH,002H
EFB6                _LINE2:
EFB6 19             	DB	019H
EFB7                WKE4:
EFB7 1C             	DB	01CH
EFB8                WKE6:
EFB8 00             	DB	000H
EFB9                WK40:
EFB9 07             	DB	007H
EFBA                _PAGE_MINUS:
EFBA 80 F8          	DW	0-WIDTH*LINE
EFBC                _WIDTH_MINUS:
EFBC B0 FF          	DW	0-WIDTH
EFBE                WK30:
EFBE 0C             	DB	00CH
EFBF                WK31:
EFBF                WK1FD0:
EFBF 20             	DB	020H
EFC0                
EFC0 A9 DA          CTC0:	DW	INTCTCE
EFC2 A9 DA          CTC1:	DW	INTCTCE
EFC4 B1 DA          CTC2:	DW	INTCTC2
EFC6 A9 DA          CTC3:	DW	INTCTCE
EFC8 8C DA          INTVEC:	DW	INT
EFCA                
EFCA                ;	LSX-Dodgers 独自BIOS
EFCA                
EFCA C3 EA DF       _INKEY:	JP	INKEY
EFCD C3 8C DC       _PRINT:	JP	PRINT
EFD0 C3 52 DF       _SCRN:	JP	SCRN
EFD3 C3 7C DF       _POS:	JP	POS
EFD6 C3 CE DD       _LOC:	JP	LOC
EFD9                _CHGDRV:
EFD9 C3 63 EC       	JP	CHGDRV
EFDC                _GETDPB:
EFDC C3 2E ED       	JP	GETDPB
EFDF                _FFLUSH:
EFDF C3 4C ED       	JP	FFLUSH
EFE2                _RDFATX:
EFE2 C3 69 E9       	JP	RDFATX
EFE5 C3 91 EA       _RDFAT:	JP	RDFAT
EFE8 C3 2B EE       _WTTRK:	JP	WTTRK
EFEB C3 3F EE       _FDRD:	JP	FDRD
EFEE C3 31 EE       _FDWT:	JP	FDWT
EFF1                _BPB2DPB:
EFF1 C3 F6 EA       	JP	BPB2DPB
EFF4                	DS	3
EFF7                _GNCL:
EFF7 C3 0B EA       GNCPAT:	JP	GNCL		; self-modifying code
EFFA                _SNCL:
EFFA C3 2E EA       SNCPAT:	JP	SNCL		; self-modifying code
EFFD C3 75 D1       _COMANL:JP	COMANL
F000                
F000                _WE:
F000                	INCLUDE	"LDCALL.ASM"
F000                
F000                ;	LSX-Dodgers システムコール(BDOS)
F000                ;
F000                ;	LSX-Dodgers SYSTEM CALL
F000                ;	STABLE:アドレス下位1バイトが0になるように
F000                
F000                STABLE:
F000                ;0
F000 03 EF 38 DB    	DW	_SYS00,_SYS01,_SYS02,_SYS03
F004 44 DB 9E E1
F008 E4 D7 E4 D7    	DW	_SYS04,_SYS05,_SYS06,_SYS07
F00C 49 DB 09 EF
F010 51 DB E6 D7    	DW	_SYS08,_SYS09,_SYS0A,_SYS0B
F014 8A DB B6 DB
F018 FB D7 00 D8    	DW	_SYS0C,_SYS0D,_SYS0E,_SYS0F
F01C 0F D8 22 D8
F020                ;1
F020 76 D8 BD D8    	DW	_SYS10,_SYS11,_SYS12,_SYS13
F024 06 D9 3C D9
F028 44 D9 5A D9    	DW	_SYS14,_SYS15,_SYS16,_SYS17
F02C 6F D9 67 D9
F030 B6 D9 BB D9    	DW	_SYS18,_SYS19,_SYS1A,_SYS1B
F034 C0 D9 C6 D9
F038 E4 D7 EC D9    	DW	_SYS1C,_SYS1D,_SYS1E,_SYS1F
F03C E4 D7 F0 D9
F040                ;2
F040 E4 D7 A6 D9    	DW	_SYS20,_SYS21,_SYS22,_SYS23
F044 AE D9 F7 D9
F048 1D DA E4 D7    	DW	_SYS24,_ERROR,_SYS26,_SYS27
F04C 26 E6 0B E7
F050 AE D9 26 DA    	DW	_SYS28,_SYS5C,_SYS2A,_SYS2B
F054 CC DB 9E E1
F058 EF DB 9E E1    	DW	_SYS2C,_SYS2D,_SYS2E,_SYS2F
F05C E4 D7 49 DA
F060                ;3
F060 43 DA E4 D7    	DW	_SYS30,_ERROR,_ERROR,_ERROR
F064 E4 D7 E4 D7
F068 E4 D7 E4 D7    	DW	_ERROR,_ERROR,_ERROR,_ERROR
F06C E4 D7 E4 D7
F070 E4 D7 9E E1    	DW	_ERROR,_SYS39,_SYS3A,_SYS5A
F074 9E E1 6A DA
F078                ;DOS2
F078 C7 D7          	DW	_DOS2
F07A                
F07A                	DS	2
F07C 00 F2          _FATBF:	DW	FATBF
F07E 00 FA          _DTBUF:	DW	DTBUF
F080                
F080                ;	コントロールコードテーブル
F080                ;	CTRLTB:アドレス下位1バイトが080Hになるように
F080                
F080                CTRLTB:
F080 43 DD 43 DD    	DW	CTRL00,CTRL00,CTRL02,CTRL03	;  A,B,C
F084 7F DD C6 DE
F088 C0 DE A3 DD    	DW	CTRL04,CTRL05,CTRL06,CTRL07	;D,E,F,G
F08C 9F DE 26 DE
F090 4F DD 70 DD    	DW	CTRL08,CTRL09,CTRL0A,CTRL0B	;H,I,J,K
F094 C9 DE E4 DD
F098 9C DE C9 DD    	DW	CTRL0C,CTRL0D,CTRL0E,CTRL00	;L,M,N,O
F09C DE DE 43 DD
F0A0 43 DD 43 DD    	DW	CTRL00,CTRL00,CTRL12,CTRL00	;P,Q,R,S
F0A4 DC DD 43 DD
F0A8 43 DD 43 DD    	DW	CTRL00,CTRL00,CTRL00,CTRL00	;T,U,V,W
F0AC 43 DD 43 DD
F0B0 43 DD 43 DD    	DW	CTRL00,CTRL00,CTRL0C,CTRL1B	;X,Y,Z,ESC
F0B4 9C DE EB DD
F0B8 6A DD 56 DD    	DW	CTRL1C,CTRL1D,CTRL1E,CTRL1F	;→,←,↑,↓
F0BC 5F DD C9 DE
F0C0                
F0C0                	DS	02AH
F0EA                
F0EA 16 17          SDDATA:	DB	22,23		;(FCB)ファイルを最後に変更した時刻
F0EC 14 15          	DB	20,21		;(FCB)ファイルを最後に変更した日付
F0EE 1A 1B          	DB	26,27		;(FCB)ファイルの先頭クラスタ
F0F0 10 11 12 13    	DB	16,17,18,19	;(FCB)ファイルのサイズ(バイト単位)
F0F4                SDDATAE:
F0F4                
F0F4                SCDIR:	DS	2		;+14 +15
F0F6                SFBPS:	DS	2		;FBPS
F0F8                SFNDF:	DS	2		;FILEN DIRF
F0FA                
F0FA 00 00          _FATPS:	DW	0
F0FC 00 00          _DIRPS:	DW	0
F0FE 00 00          _CLPS:	DW	0
F100                
F100                _PE:
F100                	INCLUDE	"X1DPB.ASM"
F100                
F100                ;	LSX-Dodgers DPB
F100                ;	X1/turbo/Z
F100                
F100                DEVICE:
F100                
F100                ;	A:
F100                
F100 02 00          	DW	2	;DPB_00_FATLN
F102 EB EF          	DW	_FDRD	;DPB_02_DRD
F104 EE EF          	DW	_FDWT	;DPB_04_DWT
F106 FD             	DB	0FDH	;DPB_06_FATID
F107 02             	DB	2	;DPB_07_SECPCL
F108 64 01          	DW	356	;DPB_08_MAXCL
F10A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F10B 07             	DB	7	;DPB_0B_DIRSCNT
F10C 28             	DB	40	;DPB_0C_MAXCYL
F10D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F10E 01             	DB	1	;DPB_0E_FATPS
F10F 82             	DB	082H	;DPB_0F_BPS
F110 05 00          	DW	5	;DPB_10_DIRPS
F112 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F113 00             	DB	0	;DPB_13_UNITNO
F114 08 00          	DW	8	;DPB_14_ADDCL16
F116 00 00          	DW	0	;DPB_16
F118 00 00          	DW	0	;DPB_18
F11A 00 00          	DW	0	;DPB_1A_SDIR
F11C 46 44 44 30    	DB	"FDD0"	;DPB_1C_NAME
F120                
F120                ;	B:
F120                
F120 02 00          	DW	2	;DPB_00_FATLN
F122 EB EF          	DW	_FDRD	;DPB_02_DRD
F124 EE EF          	DW	_FDWT	;DPB_04_DWT
F126 FD             	DB	0FDH	;DPB_06_FATID
F127 02             	DB	2	;DPB_07_SECPCL
F128 64 01          	DW	356	;DPB_08_MAXCL
F12A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F12B 07             	DB	7	;DPB_0B_DIRSCNT
F12C 28             	DB	40	;DPB_0C_MAXCYL
F12D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F12E 01             	DB	1	;DPB_0E_FATPS
F12F 82             	DB	082H	;DPB_0F_BPS
F130 05 00          	DW	5	;DPB_10_DIRPS
F132 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F133 01             	DB	1	;DPB_13_UNITNO
F134 08 00          	DW	8	;DPB_14_ADDCL16
F136 00 00          	DW	0	;DPB_16
F138 00 00          	DW	0	;DPB_18
F13A 00 00          	DW	0	;DPB_1A_SDIR
F13C 46 44 44 31    	DB	"FDD1"	;DPB_1C_NAME
F140                
F140                ;	C:
F140                
F140 02 00          	DW	2	;DPB_00_FATLN
F142 EB EF          	DW	_FDRD	;DPB_02_DRD
F144 EE EF          	DW	_FDWT	;DPB_04_DWT
F146 FD             	DB	0FDH	;DPB_06_FATID
F147 02             	DB	2	;DPB_07_SECPCL
F148 64 01          	DW	356	;DPB_08_MAXCL
F14A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F14B 07             	DB	7	;DPB_0B_DIRSCNT
F14C 28             	DB	40	;DPB_0C_MAXCYL
F14D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F14E 01             	DB	1	;DPB_0E_FATPS
F14F 82             	DB	082H	;DPB_0F_BPS
F150 05 00          	DW	5	;DPB_10_DIRPS
F152 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F153 02             	DB	2	;DPB_13_UNITNO
F154 08 00          	DW	8	;DPB_14_ADDCL16
F156 00 00          	DW	0	;DPB_16
F158 00 00          	DW	0	;DPB_18
F15A 00 00          	DW	0	;DPB_1A_SDIR
F15C 46 44 44 32    	DB	"FDD2"	;DPB_1C_NAME
F160                
F160                ;	D:
F160                
F160 02 00          	DW	2	;DPB_00_FATLN
F162 EB EF          	DW	_FDRD	;DPB_02_DRD
F164 EE EF          	DW	_FDWT	;DPB_04_DWT
F166 FD             	DB	0FDH	;DPB_06_FATID
F167 02             	DB	2	;DPB_07_SECPCL
F168 64 01          	DW	356	;DPB_08_MAXCL
F16A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F16B 07             	DB	7	;DPB_0B_DIRSCNT
F16C 28             	DB	40	;DPB_0C_MAXCYL
F16D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F16E 01             	DB	1	;DPB_0E_FATPS
F16F 82             	DB	082H	;DPB_0F_BPS
F170 05 00          	DW	5	;DPB_10_DIRPS
F172 A7             	DB	0A7H	;DPB_12_DEVICE
F173 03             	DB	3	;DPB_13_UNITNO
F174 08 00          	DW	8	;DPB_14_ADDCL16
F176 00 00          	DW	0	;DPB_16
F178 00 00          	DW	0	;DPB_18
F17A 00 00          	DW	0	;DPB_1A_SDIR
F17C 46 44 44 33    	DB	"FDD3"	;DPB_1C_NAME
F180                
F180                ;	E:
F180                
F180 00 00          EMMFL:	DW	0	;DPB_00_FATLN
F182 6D D7          EMMRD:	DW	EDRD	;DPB_02_DRD
F184 69 D7          EMMWR:	DW	EDWT	;DPB_04_DWT
F186 FE             	DB	0FEH	;DPB_06_FATID
F187 02             	DB	2	;DPB_07_SECPCL
F188 00 00          EMMCL:	DW	0	;DPB_08_MAXCL
F18A 00             	DB	0	;DPB_0A_FDMODE
F18B 0C             	DB	12	;DPB_0B_DIRSCNT
F18C 00             	DB	0	;DPB_0C_MAXCYL
F18D 00             	DB	0	;DPB_0D_MAXSEC
F18E 02             	DB	2	;DPB_0E_FATPS
F18F 02             	DB	2	;DPB_0F_BPS
F190 0A 00          	DW	10	;DPB_10_DIRPS
F192 06             EMMDV:	DB	6	;DPB_12_DEVICE
F193 00             	DB	0	;DPB_13_UNITNO
F194 12 00          	DW	18	;DPB_14_ADDCL16
F196 00 00          	DW	0	;DPB_16
F198 00 00          	DW	0	;DPB_18
F19A 00 00          	DW	0	;DPB_1A_SDIR
F19C 45 4D 4D 30    	DB	"EMM0"	;DPB_1C_NAME
F1A0                
F1A0                ;	F:
F1A0                
F1A0 00 00          BANKFL:	DW	0	;DPB_00_FATLN
F1A2 04 D7          	DW	BDRD	;DPB_02_DRD
F1A4 00 D7          	DW	BDWT	;DPB_04_DWT
F1A6 F9             	DB	0F9H	;DPB_06_FATID
F1A7 02             	DB	2	;DPB_07_SECPCL
F1A8 00 00          BANKCL:	DW	0	;DPB_08_MAXCL
F1AA 00             	DB	0	;DPB_0A_FDMODE
F1AB 08             	DB	8	;DPB_0B_DIRSCNT
F1AC 00             	DB	0	;DPB_0C_MAXCYL
F1AD 01             	DB	1	;DPB_0D_MAXSEC
F1AE 00             	DB	0	;DPB_0E_FATPS
F1AF 02             	DB	2	;DPB_0F_BPS
F1B0 02 00          	DW	2	;DPB_10_DIRPS
F1B2 0B             BANKDV:	DB	00BH	;DPB_12_DEVICE
F1B3 00             	DB	0	;DPB_13_UNITNO
F1B4 06 00          	DW	6	;DPB_14_ADDCL16
F1B6 00 00          	DW	0	;DPB_16
F1B8 00 00          	DW	0	;DPB_18
F1BA 00 00          	DW	0	;DPB_1A_SDIR
F1BC 42 52 41 4D    	DB	"BRAM"	;DPB_1C_NAME
F1C0                
F1C0                ;	G:
F1C0                
F1C0 02 00          	DW	2	;DPB_00_FATLN
F1C2 C1 D6          	DW	GDRD	;DPB_02_DRD
F1C4 D8 D6          	DW	GDWT	;DPB_04_DWT
F1C6 FA             	DB	0FAH	;DPB_06_FATID
F1C7 01             	DB	1	;DPB_07_SECPCL
F1C8 B8 00          	DW	184	;DPB_08_MAXCL
F1CA 00             	DB	0	;DPB_0A_FDMODE
F1CB 07             	DB	7	;DPB_0B_DIRSCNT
F1CC 00             	DB	0	;DPB_0C_MAXCYL
F1CD 01             	DB	1	;DPB_0D_MAXSEC
F1CE 01             	DB	1	;DPB_0E_FATPS
F1CF 01             	DB	1	;DPB_0F_BPS
F1D0 03 00          	DW	3	;DPB_10_DIRPS
F1D2 05             	DB	5	;DPB_12_DEVICE
F1D3 01             	DB	1	;DPB_13_UNITNO
F1D4 08 00          	DW	8	;DPB_14_ADDCL16
F1D6 00 00          	DW	0	;DPB_16
F1D8 00 00          	DW	0	;DPB_18
F1DA 00 00          	DW	0	;DPB_1A_SDIR
F1DC 47 52 41 4D    	DB	"GRAM"	;DPB_1C_NAME
F1E0                
F1E0                ;	H:
F1E0                	DS	32-8
F1F8 00             	DB	0
F1F9                
F1F9                LAST_ADR:
F1F9                
F1F9                	END
F1F9                
