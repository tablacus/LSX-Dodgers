0000                ;	LSX-Dodgers for X1/turbo/Z
0000                ;	Programmed by
0000                ;	Gaku (Lovers/Tablacus)
0000                
0000                	INCLUDE	"X1DEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                ;	X1/turbo/Z
0000                
0000 00 00 00 00    MAC	EQU	0		;X1
0000                
0000 00 00 CB 00    RUN	EQU	0CB00H
0000 00 00 D1 06    BDOS	EQU	0D106H
0000 00 00 EF 00    WORKAD	EQU	0EF00H
0000 00 00 F2 00    FATBF	EQU	0F200H
0000 00 00 FA 00    DTBUF	EQU	0FA00H
0000 00 00 FE 00    KEYBF	EQU	0FE00H
0000 00 00 FF 00    KBUF	EQU	0FF00H
0000 00 00 FF CA    EXTSP	EQU	0FFCAH
0000 00 00 FF D9    TRAP38	EQU	0FFD9H
0000 00 00 00 50    WIDTH	EQU	80
0000 00 00 00 18    LINE	EQU	24
0000 00 00 00 07    COLORF	EQU	7
0000 00 00 00 09    COMS	EQU	9
0000                
0000                	INCLUDE	"LDDEF.ASM"
0000                
0000                ;	LSX-Dodgers DEF
0000                
0000 00 00 00 01    VER_1   EQU	1
0000 00 00 00 04    VER_2   EQU	4
0000 00 00 00 05    VER_3   EQU	5
0000 00 00 1D 00    MACW	EQU	MAC + 01D00H	;機種フラグとLD判別フラグ
0000 00 00 00 00    MACD	EQU	MAC + 00000H	;機種フラグとデバイスフラグ
0000 00 00 01 45    VER	EQU	VER_1 * 256 + VER_2 * 16 + VER_3
0000                
0000 00 00 00 05    SYSTEM	EQU	00005H
0000 00 00 00 0F    JP_HL	EQU	0000FH
0000 00 00 00 5C    FCB1	EQU	0005CH
0000 00 00 00 6C    FCB2	EQU	0006CH
0000 00 00 00 5D    FCB1FN	EQU	FCB1+1
0000 00 00 00 6D    FCB2FN	EQU	FCB2+1
0000 00 00 00 80    DTA1	EQU	00080H
0000                
0000 00 00 FF CA    EXTBIO	EQU	0FFCAH
0000                
0000                
0000                	ORG	RUN-7
CAF9                
CAF9                ;	MSX BINARY HEADER
CAF9 FE             	DB	0FEH
CAFA                ;	MSX BINARY START ADDRESS
CAFA 00 CB          	DW	RUN
CAFC                ;	MSX BINARY END ADDRESS
CAFC 00 F2          	DW	LAST_ADR
CAFE                ;	MSX BINARY EXEC ADDRESS
CAFE 04 CB          	DW	START
CB00                
CB00                	INCLUDE	"X1INIT.ASM"
CB00                
CB00                ;	LSX-Dodgers INIT
CB00                ;	X1/turbo/Z
CB00                
CB00 00 1D          	DW	MACW
CB02 45 01          	DW	VER
CB04                
CB04                START:
CB04 F3             	DI
CB05 ED 5E          	IM	2
CB07 31 CA FF       	LD	SP,EXTSP
CB0A CD 18 CB       	CALL	INIT		;NZならAUTOEXECを実行
CB0D 21 00 00       	LD	HL,0
CB10 E5             	PUSH	HL
CB11 C8             	RET	Z
CB12 11 B4 CE       	LD	DE,AUTOD
CB15 C3 FD EF       	JP	_COMANL
CB18                
CB18                INIT:
CB18 3E 1E          	LD	A,01EH
CB1A D3 00          	OUT	(0),A
CB1C                
CB1C 01 00 00       	LD	BC,0
CB1F ED 43 8C EF    	LD	(_CTC),BC
CB23 01 04 0A       	LD	BC,00A04H
CB26 CD 5E CE       	CALL	CHKCTC
CB29 01 04 07       	LD	BC,00704H
CB2C CD 5E CE       	CALL	CHKCTC
CB2F 01 A8 1F       	LD	BC,01FA8H
CB32 CD 5E CE       	CALL	CHKCTC
CB35 01 A0 1F       	LD	BC,01FA0H
CB38 CD 5E CE       	CALL	CHKCTC
CB3B                ;
CB3B                INISIO:
CB3B 01 91 1F       	LD	BC,01F91H	;INIT SIO
CB3E 16 01          	LD	D,1
CB40 ED 51          	OUT	(C),D
CB42                
CB42 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB44 0E 93          	LD	C,093H
CB46 ED 51          	OUT	(C),D
CB48 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB4A 0E 99          	LD	C,099H		;INIT SIO
CB4C 16 01          	LD	D,1
CB4E ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB50 0E 9B          	LD	C,09BH
CB52 ED 51          	OUT	(C),D
CB54 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB56                
CB56 0E 80          	LD	C,080H		;INIT DMA
CB58 21 06 C3       	LD	HL,0C306H
CB5B                INIDMA:
CB5B ED 61          	OUT	(C),H
CB5D 2D             	DEC	L
CB5E 20 FB          	JR	NZ,INIDMA
CB60                
CB60 3E E4          	LD	A,0E4H
CB62 CD 40 DF       	CALL	COMOUT
CB65 AF             	XOR	A
CB66 CD 1A DF       	CALL	OT49SB
CB69                
CB69 3E EF          	LD	A,INTVEC/256
CB6B ED 47          	LD	I,A
CB6D                
CB6D ED 4B 8C EF    	LD	BC,(_CTC)
CB71 0B             	DEC	BC
CB72 0B             	DEC	BC
CB73                
CB73 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CB75 3E C0          	LD	A,CTC0
CB77 ED 79          	OUT	(C),A
CB79                
CB79 0C             	INC	C
CB7A 3E 47          	LD	A,047H
CB7C ED 79          	OUT	(C),A
CB7E 3E 0D          	LD	A,13		;Baudrate 9600-13
CB80 ED 79          	OUT	(C),A
CB82                
CB82 79             	LD	A,C
CB83 D6 10          	SUB	010H
CB85 4F             	LD	C,A
CB86                ;	LD	(SIOAD+1),BC
CB86                ;	LD	(SIOAD0+1),BC
CB86                ;	LD	(SIOAD1+1),BC
CB86                
CB86 21 04 CF       	LD	HL,SIODATA
CB89                SINIT1:
CB89 7E             	LD	A,(HL)
CB8A 23             	INC	HL
CB8B FE FF          	CP	0FFH
CB8D 28 04          	JR	Z,SINIT2
CB8F ED 79          	OUT	(C),A
CB91 18 F6          	JR	SINIT1
CB93                SINIT2:
CB93 3E E4          	LD	A,0E4H
CB95 CD 40 DF       	CALL	COMOUT
CB98 3E C8          	LD	A,INTVEC
CB9A CD 1A DF       	CALL	OT49SB
CB9D                ;
CB9D 01 C4 1F       	LD	BC,01FC4H
CBA0 3E 0C          	LD	A,00CH
CBA2 ED 79          	OUT	(C),A
CBA4                
CBA4 0E C0          	LD	C,0C0H
CBA6 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBA8                
CBA8 0C             	INC	C
CBA9 3E 28          	LD	A,40
CBAB ED 79          	OUT	(C),A
CBAD                
CBAD 0C             	INC	C
CBAE ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBB0                
CBB0 0C             	INC	C
CBB1 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBB3                
CBB3 0E C5          	LD	C,0C5H
CBB5 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBB7                
CBB7                TEXT:
CBB7 0E B0          	LD	C,0B0H
CBB9 3E 80          	LD	A,080H
CBBB ED 79          	OUT	(C),A
CBBD 16 07          	LD	D,7
CBBF 0E B9          	LD	C,0B9H
CBC1 21 FD CE       	LD	HL,TEXTDT
CBC4                TEXT1:
CBC4 04             	INC	B
CBC5 ED A3          	OUTI
CBC7 0C             	INC	C
CBC8 15             	DEC	D
CBC9 20 F9          	JR	NZ,TEXT1
CBCB 01 B0 1F       	LD	BC,01FB0H
CBCE ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBD0                
CBD0 0E C4          	LD	C,0C4H
CBD2 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CBD4                
CBD4 01 01 1A       	LD	BC,01A01H
CBD7 ED 78          	IN	A,(C)
CBD9 E6 08          	AND	8
CBDB 28 09          	JR	Z,PRN
CBDD 0E 03          	LD	C,003H
CBDF 3E 0F          	LD	A,00FH
CBE1 ED 79          	OUT	(C),A
CBE3 01 04 0A       	LD	BC,00A04H
CBE6                PRN:
CBE6 21 00 00       	LD	HL,0
CBE9 06 5C          	LD	B,05CH
CBEB 3E FF          	LD	A,0FFH		;RST 38H
CBED CD 96 E1       	CALL	FILL_MEMORY
CBF0 06 A4          	LD	B,0A4H
CBF2 AF             	XOR	A
CBF3 CD 96 E1       	CALL	FILL_MEMORY
CBF6                
CBF6 3E C3          	LD	A,0C3H		;JP
CBF8 21 03 EF       	LD	HL,CPM_WBOOT
CBFB 32 00 00       	LD	(00000H),A
CBFE 22 01 00       	LD	(00001H),HL	;IPL
CC01                
CC01 21 00 1D       	LD	HL,MACW	;3 bit7  DPB Compatible LA(1)
CC04 22 03 00       	LD	(00003H),HL	;  bit6-0 Machine X1(0)
CC07                ;				;4 LSX-Dodgers(01DH)
CC07 21 06 D1       	LD	HL,BDOS
CC0A 32 05 00       	LD	(00005H),A
CC0D 22 06 00       	LD	(00006H),HL	;BDOS
CC10                
CC10 21 1A DB       	LD	HL,BIOS
CC13 22 19 00       	LD	(00019H),HL	;BIOS-ROM
CC16                
CC16 21 D9 FF       	LD	HL,TRAP38	;TRAP38
CC19 32 38 00       	LD	(00038H),A
CC1C 22 39 00       	LD	(00039H),HL	;RST 038H
CC1F                
CC1F 3E EF          	LD	A,CPM_BOOT/256
CC21 32 0B 00       	LD	(0000BH),A
CC24                
CC24 3E E9          	LD	A,0E9H		;JP (HL)
CC26 32 0F 00       	LD	(0000FH),A
CC29                
CC29 3A 7D F0       	LD	A,(_FATBF+1)
CC2C 32 13 00       	LD	(00013H),A
CC2F                
CC2F 3A 7F F0       	LD	A,(_DTBUF+1)
CC32 32 17 00       	LD	(00017H),A
CC35                
CC35 3E FE          	LD	A,KEYBF/256
CC37 32 1B 00       	LD	(0001BH),A
CC3A                
CC3A 3E FF          	LD	A,KBUF/256
CC3C 32 1F 00       	LD	(0001FH),A
CC3F                
CC3F 21 45 01       	LD	HL,VER
CC42 22 5A 00       	LD	(0005AH),HL
CC45                
CC45 3E E6          	LD	A,0E6H
CC47 CD 40 DF       	CALL	COMOUT
CC4A CD 25 DF       	CALL	IN49SB
CC4D F5             	PUSH	AF
CC4E CD 25 DF       	CALL	IN49SB
CC51 F1             	POP	AF
CC52 F5             	PUSH	AF
CC53 E6 12          	AND	012H
CC55 20 05          	JR	NZ,KEYR
CC57 3E 01          	LD	A,1
CC59 32 A2 CD       	LD	(KEYREP+1),A
CC5C                KEYR:
CC5C F1             	POP	AF
CC5D E6 03          	AND	3
CC5F 28 0E          	JR	Z,NON
CC61                
CC61 01 D0 3F       	LD	BC,03FD0H
CC64 ED 49          	OUT	(C),C
CC66 3E 37          	LD	A,037H
CC68 D3 D0          	OUT	(0D0H),A
CC6A ED 78          	IN	A,(C)
CC6C B9             	CP	C
CC6D 28 64          	JR	Z,TURBO
CC6F                NON:
CC6F 21 10 CF       	LD	HL,AT_SCR1
CC72 11 CA DF       	LD	DE,SCR1
CC75 01 8F 00       	LD	BC,SCRNX-SCR1	;転送先のサイズ確認用
CC78 01 8E 00       	LD	BC,AT_SCRE-AT_SCR1
CC7B ED B0          	LDIR
CC7D                
CC7D 21 9E CF       	LD	HL,AT_WTTRK
CC80 11 36 EE       	LD	DE,WTTRK
CC83 01 B9 00       	LD	BC,DMAE-WTTRK	;転送先のサイズ確認用
CC86 01 B1 00       	LD	BC,AT_CPUE-AT_WTTRK
CC89 ED B0          	LDIR
CC8B                
CC8B 21 4F D0       	LD	HL,AT_EDWT
CC8E 11 CC D7       	LD	DE,EDWT
CC91 01 4B 00       	LD	BC,EMME-EDWT	;転送先のサイズ確認用
CC94 01 46 00       	LD	BC,AT_EMME-AT_EDWT
CC97 ED B0          	LDIR
CC99                
CC99 21 97 EE       	LD	HL,AT_DRD+AT_R
CC9C 22 EC EF       	LD	(_FDRD+1),HL
CC9F 21 3C EE       	LD	HL,AT_DWT+AT_R
CCA2 22 EF EF       	LD	(_FDWT+1),HL
CCA5 21 E0 D7       	LD	HL,AT_EDRD+AT_RE
CCA8 22 82 F1       	LD	(EMMRD),HL
CCAB 21 CC D7       	LD	HL,AT_EDWT+AT_RE
CCAE 22 84 F1       	LD	(EMMWR),HL
CCB1                
CCB1 3E 27          	LD	A,027H			;ノンターボはMFM切り替えを行わない
CCB3 32 12 F1       	LD	(DEVICE+012H),A		;Aドライブ
CCB6 32 32 F1       	LD	(DEVICE+012H+32),A	;Bドライブ
CCB9 32 52 F1       	LD	(DEVICE+012H+32*2),A	;Cドライブ
CCBC 32 72 F1       	LD	(DEVICE+012H+32*3),A	;Dドライブ
CCBF                
CCBF 21 00 00       	LD	HL,0
CCC2 22 6B DF       	LD	(X1PAT),HL
CCC5                
CCC5 3E AF          	LD	A,0AFH		;XOR	A
CCC7 32 88 DD       	LD	(X1KPAT),A
CCCA                
CCCA 21 59 E0       	LD	HL,SCRNX
CCCD 22 D1 EF       	LD	(_SCRN+1),HL
CCD0                
CCD0 C3 59 CD       	JP	NOBANK
CCD3                
CCD3                TURBO:
CCD3 F3             	DI			;Check BIOS
CCD4 06 1D          	LD	B,01DH
CCD6 ED 79          	OUT	(C),A		;BIOS ON
CCD8 3A 51 2F       	LD	A,(02F51H)
CCDB 04             	INC	B		;B=01EH
CCDC ED 79          	OUT	(C),A		;BIOS OFF
CCDE FB             	EI
CCDF FE C9          	CP	0C9H
CCE1 28 0D          	JR	Z,BIOSOK
CCE3 3E AF          	LD	A,0AFH		;XOR	A
CCE5 32 88 DD       	LD	(X1KPAT),A
CCE8 21 59 E0       	LD	HL,SCRNX
CCEB 22 D1 EF       	LD	(_SCRN+1),HL
CCEE 18 05          	JR	NOBIOS
CCF0                BIOSOK:
CCF0 3E C3          	LD	A,0C3H		;JP
CCF2 32 18 00       	LD	(00018H),A
CCF5                NOBIOS:
CCF5 3E 1F          	LD	A,01FH		;スタートポート
CCF7 DB F0          	IN	A,(0F0H)
CCF9 0F             	RRCA
CCFA 38 0B          	JR	C,CRT1
CCFC 21 ED CE       	LD	HL,_C8025H
CCFF 11 B0 EF       	LD	DE,CRTCD
CD02 01 10 00       	LD	BC,16
CD05 ED B0          	LDIR
CD07                CRT1:
CD07 3E 1F          	LD	A,01FH		;スタートポート
CD09 DB F0          	IN	A,(0F0H)
CD0B CB 57          	BIT	2,A
CD0D 28 18          	JR	Z,BANK
CD0F                
CD0F AF             	XOR	A
CD10                TZ1:				;前面スイッチが2HDの場合はMFMモードを2HDにしておく
CD10 F5             	PUSH	AF
CD11 CD DC EF       	CALL	_GETDPB
CD14 DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
CD17 E6 8F          	AND	08FH
CD19 FE 87          	CP	087H		;フロッピーでMEM切り替えがON
CD1B 20 04          	JR	NZ,TZ2
CD1D DD CB 0A 86    	RES	0,(IX+0AH)	;(DPB_0A_FDMODE)
CD21                TZ2:
CD21 F1             	POP	AF
CD22 3C             	INC	A
CD23 FE 08          	CP	8
CD25 38 E9          	JR	C,TZ1
CD27                
CD27                BANK:
CD27 01 00 0B       	LD	BC,00B00H
CD2A 21 00 7F       	LD	HL,07F00H
CD2D F3             	DI
CD2E                BANK1:
CD2E ED 69          	OUT	(C),L
CD30 5E             	LD	E,(HL)
CD31 7B             	LD	A,E
CD32 C6 A5          	ADD	A,0A5H
CD34 77             	LD	(HL),A
CD35 BE             	CP	(HL)
CD36 73             	LD	(HL),E
CD37 20 05          	JR	NZ,BANK2
CD39 2C             	INC	L
CD3A CB 65          	BIT	4,L
CD3C 28 F0          	JR	Z,BANK1
CD3E                BANK2:
CD3E 3E 10          	LD	A,010H
CD40 ED 79          	OUT	(C),A
CD42 7D             	LD	A,L
CD43 B7             	OR	A
CD44 28 13          	JR	Z,NOBANK
CD46 26 00          	LD	H,0
CD48 29             	ADD	HL,HL	;*2
CD49 29             	ADD	HL,HL	;*4
CD4A 29             	ADD	HL,HL	;*8
CD4B 29             	ADD	HL,HL	;*16
CD4C 29             	ADD	HL,HL	;*32
CD4D 2B             	DEC	HL	;-1
CD4E 2B             	DEC	HL	;-2
CD4F 2B             	DEC	HL	;-3
CD50 22 A8 F1       	LD	(BANKCL),HL
CD53 CD A4 CE       	CALL	CALC_FATLN
CD56 32 A0 F1       	LD	(BANKFL),A
CD59                NOBANK:
CD59                EMM:
CD59 DD 21 80 F1    	LD	IX,EMMFL
CD5D CD 55 CE       	CALL	EADR0
CD60 ED 78          	IN	A,(C)
CD62 F5             	PUSH	AF
CD63                
CD63 11 00 00       	LD	DE,0
CD66                ECHECK1:
CD66 13             	INC	DE
CD67 CD 39 CE       	CALL	EADR2
CD6A ED 60          	IN	H,(C)
CD6C CD 39 CE       	CALL	EADR2
CD6F 7C             	LD	A,H
CD70 C6 E5          	ADD	A,0E5H
CD72 ED 79          	OUT	(C),A
CD74 3C             	INC	A
CD75 CD 55 CE       	CALL	EADR0
CD78 ED 79          	OUT	(C),A
CD7A 3D             	DEC	A
CD7B CD 39 CE       	CALL	EADR2
CD7E ED 68          	IN	L,(C)
CD80 CD 39 CE       	CALL	EADR2
CD83 ED 61          	OUT	(C),H
CD85 BD             	CP	L
CD86 20 04          	JR	NZ,ECHECK2
CD88 CB 5A          	BIT	3,D
CD8A 28 DA          	JR	Z,ECHECK1
CD8C                ECHECK2:
CD8C CD 55 CE       	CALL	EADR0
CD8F F1             	POP	AF
CD90 ED 79          	OUT	(C),A
CD92                
CD92 21 F7 FF       	LD	HL,0-9
CD95 19             	ADD	HL,DE
CD96 30 09          	JR	NC,NOEMM
CD98 22 88 F1       	LD	(EMMCL),HL
CD9B CD A4 CE       	CALL	CALC_FATLN
CD9E 32 80 F1       	LD	(EMMFL),A
CDA1                NOEMM:
CDA1 3E 00          KEYREP:	LD	A,000H
CDA3 B7             	OR	A
CDA4 28 07          	JR	Z,KEYR1
CDA6 01 00 00       	LD	BC,0
CDA9 ED 43 8C EF    	LD	(_CTC),BC
CDAD                KEYR1:
CDAD CD 85 CE       	CALL	SETCRTC
CDB0 01 AA 10       	LD	BC,010AAH	;PALET
CDB3 ED 49          	OUT	(C),C
CDB5 01 CC 11       	LD	BC,011CCH
CDB8 ED 49          	OUT	(C),C
CDBA 01 F0 12       	LD	BC,012F0H
CDBD ED 49          	OUT	(C),C
CDBF 04             	INC	B
CDC0 ED 71          	DB	0EDH,071H
CDC2                
CDC2 01 30 F8       	LD	BC,0-80*25
CDC5 2A BA EF       	LD	HL,(CRTCD+10)
CDC8 ED 43 BA EF    	LD	(CRTCD+10),BC
CDCC 1E 0C          	LD	E,00CH
CDCE CD CD EF       	CALL	_PRINT
CDD1 22 BA EF       	LD	(CRTCD+10),HL
CDD4                
CDD4 21 C0 CE       	LD	HL,INIMES
CDD7 CD 6E D8       	CALL	MSX
CDDA                
CDDA 3A 87 FF       	LD	A,(0FF87H)
CDDD FE 08          	CP	8
CDDF 30 1E          	JR	NC,INIT0
CDE1 5F             	LD	E,A
CDE2 C6 41          	ADD	A,'A'
CDE4 32 BD CE       	LD	(AUTODV),A
CDE7 0E 0E          	LD	C,00EH
CDE9 CD 05 00       	CALL	SYSTEM
CDEC 1C             	INC	E
CDED 21 85 EF       	LD	HL,_SEEKSP	;Disk error Ignore
CDF0 CB FE          	SET	7,(HL)
CDF2 0E 1B          	LD	C,01BH
CDF4 CD 05 00       	CALL	SYSTEM
CDF7                
CDF7 21 85 EF       	LD	HL,_SEEKSP
CDFA CB BE          	RES	7,(HL)
CDFC                
CDFC 3C             	INC	A
CDFD 20 08          	JR	NZ,INIT1
CDFF                INIT0:
CDFF 1E 00          	LD	E,0
CE01 0E 0E          	LD	C,00EH
CE03 CD 05 00       	CALL	SYSTEM
CE06 AF             	XOR	A
CE07                INIT1:
CE07 F3             	DI
CE08 08             	EX	AF,AF'
CE09 2E FE          	LD	L,0-2		;CALLのスタック分減らす
CE0B 39             	ADD	HL,SP
CE0C 11 00 FF       	LD	DE,0FF00H
CE0F 45             	LD	B,L
CE10 CD 05 D5       	CALL	ZERO_MEMORY_DE
CE13 21 CA FF       	LD	HL,EXTSP
CE16 06 0F          	LD	B,TRAP38-EXTBIO
CE18 3E FF          	LD	A,0FFH		;RST 38H
CE1A CD 96 E1       	CALL	FILL_MEMORY
CE1D 21 95 D0       	LD	HL,AT_TRAP38
CE20 11 D9 FF       	LD	DE,TRAP38
CE23 01 27 00       	LD	BC,AT_TRAPE-AT_TRAP38
CE26 ED B0          	LDIR
CE28 08             	EX	AF,AF'
CE29 B7             	OR	A
CE2A C8             	RET	Z
CE2B                
CE2B 3E E6          	LD	A,0E6H
CE2D CD 40 DF       	CALL	COMOUT
CE30 CD 25 DF       	CALL	IN49SB
CE33 CD 25 DF       	CALL	IN49SB
CE36 FE 1B          	CP	01BH
CE38 C9             	RET
CE39                
CE39                EADR2:
CE39 D5             	PUSH	DE
CE3A EB             	EX	DE,HL
CE3B 29             	ADD	HL,HL
CE3C 29             	ADD	HL,HL
CE3D DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
CE40 DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
CE43 09             	ADD	HL,BC
CE44 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
CE47 06 0D          	LD	B,00DH
CE49 ED 49          	OUT	(C),C
CE4B 0C             	INC	C
CE4C ED 69          	OUT	(C),L
CE4E 0C             	INC	C
CE4F ED 61          	OUT	(C),H
CE51 0C             	INC	C
CE52 EB             	EX	DE,HL
CE53 D1             	POP	DE
CE54 C9             	RET
CE55                
CE55                EADR0:
CE55 D5             	PUSH	DE
CE56 11 00 00       	LD	DE,0
CE59 CD 39 CE       	CALL	EADR2
CE5C D1             	POP	DE
CE5D C9             	RET
CE5E                
CE5E                CHKCTC:
CE5E C5             	PUSH	BC
CE5F 11 03 47       	LD	DE,04703H
CE62                INICTC1:
CE62 0C             	INC	C
CE63 ED 51          	OUT	(C),D
CE65 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令
CE67 1D             	DEC	E
CE68 20 F8          	JR	NZ,INICTC1
CE6A C1             	POP	BC
CE6B                
CE6B 11 FA 07       	LD	DE,007FAH
CE6E ED 51          	OUT	(C),D
CE70 ED 59          	OUT	(C),E
CE72 ED 78          	IN	A,(C)
CE74 BB             	CP	E
CE75 C0             	RET	NZ
CE76 ED 51          	OUT	(C),D
CE78 ED 51          	OUT	(C),D
CE7A ED 78          	IN	A,(C)
CE7C BA             	CP	D
CE7D C0             	RET	NZ
CE7E 03             	INC	BC
CE7F 03             	INC	BC
CE80 ED 43 8C EF    	LD	(_CTC),BC
CE84 C9             	RET
CE85                
CE85                SETCRTC:
CE85 21 B0 EF       	LD	HL,CRTCD
CE88 AF             	XOR	A
CE89                SETCRT1:
CE89 01 00 18       	LD	BC,01800H
CE8C ED 79          	OUT	(C),A
CE8E 0C             	INC	C
CE8F 04             	INC	B
CE90 ED A3          	OUTI
CE92 3C             	INC	A
CE93 FE 0C          	CP	12
CE95 20 F2          	JR	NZ,SETCRT1
CE97 23             	INC	HL
CE98 23             	INC	HL
CE99 01 03 1B       	LD	BC,01A03H+00100H
CE9C ED A3          	OUTI
CE9E 01 D0 20       	LD	BC,01FD0H+00100H
CEA1 ED A3          	OUTI
CEA3 C9             	RET
CEA4                
CEA4                CALC_FATLN:	;FAT12のクラスタ数から必要なFATサイズを求める(セクタサイズ512)
CEA4 5D             	LD	E,L
CEA5 54             	LD	D,H
CEA6 29             	ADD	HL,HL	;*2
CEA7 19             	ADD	HL,DE	;*3
CEA8 CB 3C          	SRL	H	;/2
CEAA CB 1D          	RR	L	;1クラスタ辺り1.5バイト必要
CEAC 11 FF 01       	LD	DE,511	;切り上げる
CEAF 19             	ADD	HL,DE
CEB0 7C             	LD	A,H
CEB1 CB 3F          	SRL	A
CEB3 C9             	RET
CEB4                
CEB4 41 55 54 4F    AUTOD:	DB	"AUTOEXEC "
CEB8 45 58 45 43
CEBC 20
CEBD 41 3A 00       AUTODV:	DB	"A:",0
CEC0                
CEC0 4C 53 58 2D    INIMES:	DB	"LSX-Dodgers for X1/turbo version "
CEC4 44 6F 64 67
CEC8 65 72 73 20
CECC 66 6F 72 20
CED0 58 31 2F 74
CED4 75 72 62 6F
CED8 20 76 65 72
CEDC 73 69 6F 6E
CEE0 20
CEE1 31 2E          	DB	030H + VER_1, '.'
CEE3 34 35          	DB	030H + VER_2 ,030H + VER_3
CEE5 20 47 61 6B    	DB	' Gaku',0DH,0AH
CEE9 75 0D 0A
CEEC 00             	DB	0
CEED                
CEED                _C8025H:
CEED 6B 50 59 88    	DB	06BH,050H,059H,088H,01BH,001H,019H,01AH
CEF1 1B 01 19 1A
CEF5 00 0F          	DB	000H,00FH
CEF7 80 F8 B0 FF    	DW	0-80*LINE,0-80
CEFB 0C 23          	DB	00CH,023H
CEFD                
CEFD 03 0C 0F 30    TEXTDT:	DB	003H,00CH,00FH,030H,033H,03CH,03FH
CF01 33 3C 3F
CF04                
CF04                SIODATA:
CF04 18             	DB	018H
CF05 01 00          	DB	1,0
CF07 02 00          	DB	2,0
CF09 03 C1          	DB	3,0C1H
CF0B 04 44          	DB	4,044H
CF0D 05 E8          	DB	5,0E8H
CF0F FF             	DB	0FFH
CF10                
CF10                ;	ノンターボ用パッチ
CF10                
CF10                AT_SCR1:
CF10 D9             	EXX
CF11 C5             	PUSH	BC
CF12 ED 4B B1 EF    	LD	BC,(CRTCD+1)
CF16 06 20          	LD	B,020H
CF18 D9             	EXX
CF19 C5             	PUSH	BC
CF1A 01 00 20       	LD	BC,02000H
CF1D                
CF1D 67             	LD	H,A
CF1E B7             	OR	A
CF1F                AT_SCRUP1:
CF1F 28 15          	JR	Z,AT_SCRCL
CF21 C5             	PUSH	BC
CF22 CB E0          	SET	4,B
CF24 D9             	EXX
CF25 C5             	PUSH	BC
CF26 CB E0          	SET	4,B
CF28 D9             	EXX
CF29 CD FB DF       	CALL	AT_UPSUB+AT_RS
CF2C D9             	EXX
CF2D C1             	POP	BC
CF2E D9             	EXX
CF2F C1             	POP	BC
CF30 CD FB DF       	CALL	AT_UPSUB+AT_RS
CF33 25             	DEC	H
CF34 18 E9          	JR	AT_SCRUP1
CF36                
CF36                AT_SCRCL:
CF36 2A B1 EF       	LD	HL,(CRTCD+1)
CF39 CD 91 DE       	CALL	LINECL
CF3C C1             	POP	BC
CF3D D9             	EXX
CF3E C1             	POP	BC
CF3F D9             	EXX
CF40 C9             	RET
CF41                
CF41                AT_UPSUB:
CF41 3A B1 EF       	LD	A,(CRTCD+1)
CF44 6F             	LD	L,A
CF45                AT_UPSUB1:
CF45 D9             	EXX
CF46 ED 78          	IN	A,(C)
CF48 03             	INC	BC
CF49 D9             	EXX
CF4A ED 79          	OUT	(C),A
CF4C 03             	INC	BC
CF4D 2D             	DEC	L
CF4E 20 F5          	JR	NZ,AT_UPSUB1
CF50 C9             	RET
CF51                
CF51                ;	FLOPPY DISK DRIVER(CPU)
CF51                
CF51                DISKC:
CF51 1B             	DEC	DE
CF52 CB 5F          	BIT	3,A
CF54 C4 2F EE       	CALL	NZ,RNF
CF57                DISKD:
CF57 E5             	PUSH	HL
CF58 21 35 EE       	LD	HL,RETRY
CF5B 35             	DEC	(HL)
CF5C E1             	POP	HL
CF5D 20 3C          	JR	NZ,AT_ERR		;Retry
CF5F B7             	OR	A
CF60 28 39          	JR	Z,AT_ERR		;Error
CF62                
CF62                AT_DELP:
CF62 CD 2F EE       	CALL	RNF
CF65 CD 0B EE       	CALL	FDMOFF
CF68 3A 85 EF       	LD	A,(_SEEKSP)
CF6B 87             	ADD	A,A
CF6C 38 2C          	JR	C,AT_ERRZ
CF6E                AT_DELP1:
CF6E D5             	PUSH	DE
CF6F 21 C0 F0       	LD	HL,DEMES
CF72 CD 6E D8       	CALL	MSX
CF75 CD EC DB       	CALL	KEYBC
CF78                AT_DELP2:
CF78 CD CA EF       	CALL	_INKEY
CF7B 28 FB          	JR	Z,AT_DELP2
CF7D                
CF7D D1             	POP	DE
CF7E CD F6 E3       	CALL	CAP
CF81 FE 52          	CP	'R'		;Retry
CF83 20 0A          	JR	NZ,AT_DELP3
CF85 21 00 00       DHLPAT:	LD	HL,0
CF88 3E 02          	LD	A,2
CF8A 32 35 EE       	LD	(RETRY),A
CF8D B7             	OR	A
CF8E C9             	RET
CF8F                AT_DELP3:
CF8F FE 49          	CP	'I'		;Ignore
CF91 28 05          	JR	Z,AT_IGNORE
CF93 FE 41          	CP	'A'		;Abort
CF95 20 D7          	JR	NZ,AT_DELP1
CF97 C7             	RST	0
CF98                AT_IGNORE:
CF98 3E FF          	LD	A,0FFH
CF9A                AT_ERRZ:
CF9A BF             	CP	A
CF9B                AT_ERR:
CF9B 3E FF          	LD	A,0FFH
CF9D C9             	RET
CF9E                
CF9E                AT_SCRE:
CF9E                
CF9E                AT_WTTRK:
CF9E 06 01          	LD	B,1
CFA0 3E F4          	LD	A,0F4H
CFA2 18 02          	JR	AT_WTTRK1
CFA4                AT_DWT:
CFA4 3E A0          	LD	A,0A0H
CFA6                AT_WTTRK1:
CFA6 32 D3 ED       	LD	(FDCPAT+1),A
CFA9                DWTBL:
CFA9 78             	LD	A,B
CFAA 32 82 EE       	LD	(AT_WTB+1+AT_R),A
CFAD 3E 02          	LD	A,2		;Retry count
CFAF 32 35 EE       	LD	(RETRY),A
CFB2                
CFB2                DWT0:
CFB2 D5             	PUSH	DE
CFB3 E5             	PUSH	HL
CFB4 22 40 E0       	LD	(DHLPAT+1+AT_RS),HL
CFB7 CD 6D ED       	CALL	SEEK		;Write disk
CFBA E1             	POP	HL
CFBB 38 38          	JR	C,ERRDW
CFBD F3             	DI
CFBE 3A D3 ED       	LD	A,(FDCPAT+1)
CFC1 CD 17 EE       	CALL	SECSET
CFC4 0E FB          	LD	C,0FBH
CFC6                
CFC6                DWT1:
CFC6 56             	LD	D,(HL)
CFC7                DWT2:
CFC7 78             	LD	A,B
CFC8 DB F8          	IN	A,(0F8H)
CFCA 0F             	RRCA
CFCB 30 08          	JR	NC,DWT4
CFCD 0F             	RRCA
CFCE 30 F7          	JR	NC,DWT2
CFD0                DWT3:
CFD0 ED 51          	OUT	(C),D
CFD2 23             	INC	HL
CFD3 18 F1          	JR	DWT1
CFD5                
CFD5                DWT4:
CFD5 3D             	DEC	A
CFD6 28 F8          	JR	Z,DWT3
CFD8 3C             	INC	A
CFD9 FB             	EI
CFDA D1             	POP	DE
CFDB 13             	INC	DE
CFDC CD 0B EE       	CALL	FDMOFF
CFDF 28 08          	JR	Z,DISKOK_WT
CFE1 CD 0B E0       	CALL	DISKC+AT_RS
CFE4 20 CC          	JR	NZ,DWT0
CFE6 B7             	OR	A
CFE7 20 05          	JR	NZ,ERRW
CFE9                
CFE9                DISKOK_WT:
CFE9 06 01          AT_WTB:	LD	B,1
CFEB 10 BC          	DJNZ	DWTBL
CFED C9             	RET
CFEE                
CFEE                ERRW:
CFEE 3E FF          	LD	A,0FFH
CFF0                ERRZ:
CFF0 BF             	CP	A
CFF1 37             	SCF
CFF2 C3 0B EE       	JP	FDMOFF
CFF5                
CFF5                ERRDW:
CFF5 D1             	POP	DE
CFF6 CD 1C E0       	CALL	AT_DELP+AT_RS
CFF9 20 B7          	JR	NZ,DWT0
CFFB B7             	OR	A
CFFC 20 F0          	JR	NZ,ERRW
CFFE C9             	RET
CFFF                
CFFF                AT_DRD:
CFFF 3E 80          	LD	A,080H
D001 32 D3 ED       	LD	(FDCPAT+1),A
D004                DRDBL:
D004 78             	LD	A,B
D005 32 D9 EE       	LD	(AT_RDB+1+AT_R),A
D008 3E 02          	LD	A,2		;Retry count
D00A 32 35 EE       	LD	(RETRY),A
D00D                DRD0:
D00D D5             	PUSH	DE
D00E E5             	PUSH	HL
D00F 22 40 E0       	LD	(DHLPAT+1+AT_RS),HL
D012 CD 6D ED       	CALL	SEEK		;Read disk
D015 E1             	POP	HL
D016 38 2D          	JR	C,ERRDR
D018 F3             	DI
D019 3A D3 ED       	LD	A,(FDCPAT+1)
D01C CD 17 EE       	CALL	SECSET
D01F 0E FB          	LD	C,0FBH
D021                DRD1:
D021 78             	LD	A,B
D022 DB F8          	IN	A,(0F8H)
D024 0F             	RRCA
D025 30 08          	JR	NC,DRD3
D027 0F             	RRCA
D028 30 F7          	JR	NC,DRD1
D02A ED A2          	INI
D02C 04             	INC	B
D02D 18 F2          	JR	DRD1
D02F                
D02F                DRD3:
D02F B7             	OR	A
D030 FB             	EI
D031 D1             	POP	DE
D032 13             	INC	DE
D033 CD 0B EE       	CALL	FDMOFF
D036 28 08          	JR	Z,DISKOK_RD
D038 CD 0B E0       	CALL	DISKC+AT_RS
D03B 20 D0          	JR	NZ,DRD0
D03D B7             	OR	A
D03E 20 AE          	JR	NZ,ERRW
D040                
D040                DISKOK_RD:
D040 06 01          AT_RDB:	LD	B,1
D042 10 C0          	DJNZ	DRDBL
D044 C9             	RET
D045                
D045                ERRDR:
D045 D1             	POP	DE
D046 CD 1C E0       	CALL	AT_DELP+AT_RS
D049 20 C2          	JR	NZ,DRD0
D04B B7             	OR	A
D04C 20 A0          	JR	NZ,ERRW
D04E C9             	RET
D04F                
D04F                AT_CPUE:
D04F                
D04F                
D04F                ;	EMM DRIVER(CPU)
D04F                
D04F                
D04F                AT_EDWT:
D04F CD F4 D7       	CALL	AT_EADR+AT_RE
D052                AT_EDWT0:
D052 F5             	PUSH	AF
D053 AF             	XOR	A
D054                AT_EDWT1:
D054 04             	INC	B
D055 ED A3          	OUTI
D057 04             	INC	B
D058 ED A3          	OUTI
D05A 3D             	DEC	A
D05B 20 F7          	JR	NZ,AT_EDWT1
D05D 13             	INC	DE
D05E F1             	POP	AF
D05F 3D             	DEC	A
D060 20 F0          	JR	NZ,AT_EDWT0
D062 C9             	RET
D063                
D063                AT_EDRD:
D063 CD F4 D7       	CALL	AT_EADR+AT_RE
D066                AT_EDRD0:
D066 F5             	PUSH	AF
D067 AF             	XOR	A
D068                AT_EDRD1:
D068 ED A2          	INI
D06A 04             	INC	B
D06B ED A2          	INI
D06D 04             	INC	B
D06E 3D             	DEC	A
D06F 20 F7          	JR	NZ,AT_EDRD1
D071 13             	INC	DE
D072 F1             	POP	AF
D073 3D             	DEC	A
D074 20 F0          	JR	NZ,AT_EDRD0
D076 C9             	RET
D077                
D077                AT_EADR:
D077 C5             	PUSH	BC
D078 D5             	PUSH	DE
D079 EB             	EX	DE,HL
D07A 29             	ADD	HL,HL
D07B DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
D07E DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
D081 09             	ADD	HL,BC
D082 DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
D085 06 0D          	LD	B,00DH
D087 ED 49          	OUT	(C),C
D089 0C             	INC	C
D08A ED 69          	OUT	(C),L
D08C 0C             	INC	C
D08D ED 61          	OUT	(C),H
D08F 0C             	INC	C
D090 EB             	EX	DE,HL
D091 D1             	POP	DE
D092 F1             	POP	AF
D093 A7             	AND	A	;CF=0
D094 C9             	RET
D095                AT_EMME:
D095                
D095                AT_TRAP38:
D095 21 00 00       	LD	HL,0
D098 E3             	EX	(SP),HL
D099 3E 24          	LD	A,'$'
D09B CD 23 DC       	CALL	MSG_A
D09E 2B             	DEC	HL
D09F 7C             	LD	A,H
D0A0 CD E8 FF       	CALL	PRHX+AT_RT
D0A3 7D             	LD	A,L
D0A4                PRHX:
D0A4 F5             	PUSH	AF
D0A5 07             	RLCA
D0A6 07             	RLCA
D0A7 07             	RLCA
D0A8 07             	RLCA
D0A9 CD F1 FF       	CALL	PRHX2+AT_RT
D0AC F1             	POP	AF
D0AD                PRHX2:
D0AD E6 0F          	AND	00FH
D0AF FE 0A          	CP	10
D0B1 38 02          	JR	C,PRHX3
D0B3 C6 07          	ADD	A,'A'-'0'-10
D0B5                PRHX3:
D0B5 C6 30          	ADD	A,'0'
D0B7 C3 23 DC       	JP	MSG_A
D0BA                	DS	2
D0BC                AT_TRAPE:
D0BC                
D0BC 00 00 2F 44    AT_RT	EQU	TRAP38-AT_TRAP38
D0BC                
D0BC                INITE:
D0BC                	DS	BDOS-INITE
D106                
D106 C3 17 D8       	JP	BDOS0
D109                	INCLUDE	"X1CCP.ASM"
D109                
D109                ;	LSX-Dodgers CCP
D109                ;	X1/turbo/Z
D109                
D109                WBOOT1:
D109 F3             	DI
D10A ED 7B 06 00    	LD	SP,(SYSTEM+1)
D10E                
D10E 3E EF          	LD	A,INTVEC/256
D110 ED 47          	LD	I,A
D112                
D112 3E E4          	LD	A,0E4H
D114 CD 40 DF       	CALL	COMOUT
D117 3E C8          	LD	A,INTVEC
D119 CD 1A DF       	CALL	OT49SB
D11C                
D11C 3A BC EF       	LD	A,(CRTCD+12)
D11F B7             	OR	A
D120 20 0C          	JR	NZ,SETCRT0
D122 21 80 F8       	LD	HL,0-80*LINE
D125 22 BA EF       	LD	(CRTCD+10),HL
D128 21 B0 FF       	LD	HL,0-80
D12B 22 BC EF       	LD	(CRTCD+12),HL
D12E                SETCRT0:
D12E 21 B0 EF       	LD	HL,CRTCD
D131 AF             	XOR	A
D132                SETCRT2:
D132 01 00 18       	LD	BC,01800H
D135 ED 79          	OUT	(C),A
D137 0C             	INC	C
D138 56             	LD	D,(HL)
D139 FE 0D          	CP	13
D13B 38 02          	JR	C,SETCRT3
D13D 16 00          	LD	D,0
D13F                SETCRT3:
D13F ED 51          	OUT	(C),D
D141 23             	INC	HL
D142 3C             	INC	A
D143 FE 0E          	CP	14
D145 20 EB          	JR	NZ,SETCRT2
D147                
D147 01 03 1B       	LD	BC,01A03H+00100H
D14A ED A3          	OUTI
D14C 01 D0 20       	LD	BC,01FD0H+00100H
D14F ED A3          	OUTI
D151 21 92 EF       	LD	HL,_KEYD
D154 7E             	LD	A,(HL)
D155 36 00          	LD	(HL),0
D157 CD E9 DB       	CALL	KEYBC_IFBREAK
D15A 3E 04          	LD	A,4
D15C CD 23 DC       	CALL	MSG_A
D15F                	INCLUDE	"LDCCP.ASM"
D15F                
D15F                ;	LSX-Dodgers CCP
D15F                
D15F                COMMAND:
D15F CD 12 D2       	CALL	SETDTA1
D162 3A 87 EF       	LD	A,(_DVSW)
D165 C6 41          	ADD	A,'A'
D167 CD 23 DC       	CALL	MSG_A
D16A 3E 3E          	LD	A,'>'
D16C CD 23 DC       	CALL	MSG_A
D16F 3E 50          	LD	A,80
D171 12             	LD	(DE),A
D172 CD 72 DC       	CALL	_SYS0A		;(BDOS)文字列入力
D175 CD C7 D3       	CALL	LTNL
D178                
D178 11 82 00       	LD	DE,DTA1+2
D17B CD FD EF       	CALL	_COMANL
D17E 30 DF          	JR	NC,COMMAND
D180 11 79 EF       	LD	DE,COMERM
D183 CD 5F D8       	CALL	_SYS09		;(BDOS)文字列出力
D186 C7             	RST	0
D187                
D187                COMANL:
D187 CD EA E0       	CALL	FILE
D18A 3A 19 EF       	LD	A,(FNAME+4)
D18D FE 20          	CP	020H
D18F 20 1C          	JR	NZ,COMB2
D191 D5             	PUSH	DE
D192 11 15 EF       	LD	DE,FNAME
D195 1A             	LD	A,(DE)
D196 FE 20          	CP	020H
D198 28 44          	JR	Z,SDVSW
D19A 1B             	DEC	DE
D19B 1A             	LD	A,(DE)
D19C C6 FF          	ADD	A,0FFH
D19E 38 09          	JR	C,COMB
D1A0 13             	INC	DE
D1A1                
D1A1 21 EE D6       	LD	HL,COMTB
D1A4 06 09          	LD	B,COMS
D1A6 CD 6E E3       	CALL	CPNAME
D1A9                COMB:
D1A9 D1             	POP	DE
D1AA D2 0F 00       	JP	NC,JP_HL
D1AD                COMB2:
D1AD EB             	EX	DE,HL
D1AE 22 86 D2       	LD	(COMPAT+1),HL
D1B1 F5             	PUSH	AF
D1B2 CD 32 D2       	CALL	CEXE4
D1B5 F1             	POP	AF
D1B6 21 15 EF       	LD	HL,FNAME
D1B9 11 6D 00       	LD	DE,FCB2+1	;COMMAND NAME
D1BC 01 0B 00       	LD	BC,11
D1BF ED B0          	LDIR
D1C1 11 91 D6       	LD	DE,PATHD
D1C4                CEX1:
D1C4 1A             	LD	A,(DE)
D1C5 FE 20          	CP	020H
D1C7 D8             	RET	C
D1C8 CD DF E0       	CALL	FILEC
D1CB D5             	PUSH	DE
D1CC 21 6D 00       	LD	HL,FCB2+1	;COMMAND NAME
D1CF 11 15 EF       	LD	DE,FNAME
D1D2 01 0B 00       	LD	BC,11
D1D5 ED B0          	LDIR
D1D7 CD 32 D2       	CALL	CEXE4
D1DA D1             	POP	DE
D1DB 13             	INC	DE
D1DC 18 E6          	JR	CEX1
D1DE                
D1DE                SDVSW:
D1DE F1             	POP	AF
D1DF 3A 14 EF       	LD	A,(FDRV)
D1E2 3D             	DEC	A
D1E3 5F             	LD	E,A
D1E4 0E 0E          	LD	C,00EH		;(BDOS)カレントドライブの設定
D1E6 18 31          	JR	SYSTEM0
D1E8                
D1E8                OPEN1:
D1E8 21 14 EF       	LD	HL,FDRV
D1EB                OPEN:
D1EB 0E 11          	LD	C,011H		;(BDOS)ファイルの検索
D1ED                OPEN3:
D1ED D5             	PUSH	DE
D1EE 11 6C D6       	LD	DE,DTA_CCP
D1F1 CD 0F D2       	CALL	SETDTA
D1F4 EB             	EX	DE,HL
D1F5 CD 19 D2       	CALL	SYSTEM0
D1F8 D1             	POP	DE
D1F9 C9             	RET
D1FA                
D1FA                OPEN2:
D1FA 0E 12          	LD	C,012H
D1FC 18 EF          	JR	OPEN3
D1FE                
D1FE                DEFCB:				;Z=Ok NZ=Error
D1FE 11 6C D6       	LD	DE,DTA_CCP
D201 CD 17 D2       	CALL	SYSC0F
D204                
D204 11 8D D6       	LD	DE,DTA_CCP+33	;(FCB)ランダムレコード
D207 06 04          	LD	B,4
D209 CD 05 D5       	CALL	ZERO_MEMORY_DE
D20C 11 00 01       	LD	DE,00100H
D20F                SETDTA:
D20F C3 63 DA       	JP	_SYS1A		;(BDOS)DTAの設定
D212                
D212                SETDTA1:
D212 11 80 00       	LD	DE,DTA1
D215 18 F8          	JR	SETDTA
D217                
D217                SYSC0F:
D217 0E 0F          	LD	C,00FH		;(BDOS)ファイルのオープン
D219                SYSTEM0:
D219 CD 05 00       	CALL	SYSTEM
D21C B7             	OR	A
D21D C9             	RET
D21E                
D21E                C_CD:
D21E 0E 5A          	LD	C,5AH
D220 18 F7          	JR	SYSTEM0
D222                
D222                S27BUF:
D222 3A 07 00       	LD	A,(SYSTEM+2)
D225 3D             	DEC	A
D226 E6 F8          	AND	0F8H
D228 67             	LD	H,A
D229 2E 00          	LD	L,0
D22B                S27DTA:
D22B 11 6C D6       	LD	DE,DTA_CCP
D22E                S27:
D22E 0E 27          	LD	C,027H		;(BDOS)ランダムブロック読み込み
D230 18 E7          	JR	SYSTEM0
D232                
D232                CEXE4:
D232 3A 14 EF       	LD	A,(FDRV)
D235 32 57 00       	LD	(00057H),A
D238 2A 22 EF       	LD	HL,(FDRV+14)
D23B 22 58 00       	LD	(00058H),HL
D23E                
D23E 21 1D EF       	LD	HL,FNAME+8
D241 7E             	LD	A,(HL)
D242 FE 20          	CP	020H
D244 20 07          	JR	NZ,CEXE7
D246 3E 3F          	LD	A,'?'
D248 77             	LD	(HL),A
D249 23             	INC	HL
D24A 77             	LD	(HL),A
D24B 23             	INC	HL
D24C 77             	LD	(HL),A
D24D                CEXE7:
D24D CD E8 D1       	CALL	OPEN1
D250                CEXE5:
D250 C0             	RET	NZ
D251 2A 76 D6       	LD	HL,(DTA_CCP+1+9)
D254 7C             	LD	A,H
D255 CD F6 E3       	CALL	CAP
D258 67             	LD	H,A
D259 7D             	LD	A,L
D25A CD F6 E3       	CALL	CAP
D25D 6F             	LD	L,A
D25E 3A 75 D6       	LD	A,(DTA_CCP+1+8)
D261 CD F6 E3       	CALL	CAP
D264 D6 42          	SUB	'B'
D266 28 2C          	JR	Z,C_BAT
D268 3D             	DEC	A		;'C'
D269 28 05          	JR	Z,C_EXE
D26B                CEXE6:
D26B CD FA D1       	CALL	OPEN2
D26E 18 E0          	JR	CEXE5
D270                
D270                C_EXE:
D270 7C             	LD	A,H
D271 FE 4D          	CP	'M'
D273 20 F6          	JR	NZ,CEXE6
D275                
D275 CD FE D1       	CALL	DEFCB
D278 CD 22 D2       	CALL	S27BUF
D27B 3D             	DEC	A
D27C 37             	SCF
D27D C0             	RET	NZ
D27E 7C             	LD	A,H
D27F B5             	OR	L
D280 37             	SCF
D281 C8             	RET	Z
D282 CD 12 D2       	CALL	SETDTA1
D285 11 00 00       COMPAT:	LD	DE,0				; self-modifying code
D288 ED 7B 06 00    	LD	SP,(SYSTEM+1)
D28C 67             	LD	H,A				; A=0 in SETDTA1(_SYS1A)
D28D 6F             	LD	L,A
D28E E5             	PUSH	HL				; push $0000 (reboot address)
D28F 24             	INC	H
D290 E5             	PUSH	HL				; push $0100 (TPA address)
D291 C3 D0 D4       	JP	SETFCB				; and JP $0100
D294                
D294                C_BAT:
D294 11 41 54       	LD	DE,'A'+'T'*256
D297 ED 52          	SBC	HL,DE
D299 20 D0          	JR	NZ,CEXE6
D29B                
D29B F1             	POP	AF
D29C F1             	POP	AF
D29D CD FE D1       	CALL	DEFCB
D2A0 21 00 02       	LD	HL,00200H
D2A3 CD 2B D2       	CALL	S27DTA
D2A6 C6 FE          	ADD	A,0FEH
D2A8 D8             	RET	C
D2A9 7D             	LD	A,L
D2AA B7             	OR	A
D2AB 37             	SCF
D2AC C8             	RET	Z
D2AD 3C             	INC	A
D2AE F5             	PUSH	AF
D2AF                
D2AF CD EC DB       	CALL	KEYBC
D2B2 3E 06          	LD	A,6
D2B4 CD 23 DC       	CALL	MSG_A
D2B7 C1             	POP	BC
D2B8 21 00 01       	LD	HL,00100H
D2BB                BAT1:
D2BB A7             	AND	A
D2BC 05             	DEC	B
D2BD C8             	RET	Z
D2BE 7E             	LD	A,(HL)
D2BF FE 25          	CP	'%'
D2C1 28 0C          	JR	Z,BAT2
D2C3                BAT1X:
D2C3 7E             	LD	A,(HL)
D2C4 23             	INC	HL
D2C5 FE 1A          	CP	01AH
D2C7 C8             	RET	Z
D2C8 FE 0A          	CP	00AH
D2CA C4 D1 DB       	CALL	NZ,KEYBS
D2CD 18 EC          	JR	BAT1
D2CF                
D2CF                BAT2:
D2CF 23             	INC	HL
D2D0 7E             	LD	A,(HL)
D2D1 2B             	DEC	HL
D2D2 D6 31          	SUB	'1'
D2D4 38 ED          	JR	C,BAT1X
D2D6 FE 09          	CP	9
D2D8 30 E9          	JR	NC,BAT1X
D2DA 23             	INC	HL
D2DB 23             	INC	HL
D2DC 3C             	INC	A
D2DD 4F             	LD	C,A
D2DE ED 5B 86 D2    	LD	DE,(COMPAT+1)
D2E2                BAT3:
D2E2 1A             	LD	A,(DE)
D2E3 B7             	OR	A
D2E4 28 D5          	JR	Z,BAT1
D2E6 CD C1 E1       	CALL	SPCUT
D2E9 0D             	DEC	C
D2EA 28 08          	JR	Z,BAT5
D2EC                BAT4:
D2EC 1A             	LD	A,(DE)
D2ED FE 21          	CP	021H
D2EF 38 F1          	JR	C,BAT3
D2F1 13             	INC	DE
D2F2 18 F8          	JR	BAT4
D2F4                BAT5:
D2F4 1A             	LD	A,(DE)
D2F5 FE 21          	CP	021H
D2F7 38 C2          	JR	C,BAT1
D2F9 13             	INC	DE
D2FA CD D1 DB       	CALL	KEYBS
D2FD 18 F5          	JR	BAT5
D2FF                
D2FF                SWITCH:
D2FF 1A             	LD	A,(DE)
D300                SW1:
D300 13             	INC	DE
D301 B9             	CP	C
D302 1A             	LD	A,(DE)
D303 C8             	RET	Z
D304 FE 20          	CP	020H
D306 30 F8          	JR	NC,SW1
D308                C_REM:
D308 AF             	XOR	A
D309 C9             	RET
D30A                
D30A                C_DEL:
D30A CD D0 D4       	CALL	SETFCB
D30D CD 39 DC       	CALL	_SYS08		;(BDOS)エコーなしコンソール入力
D310                
D310 0E 13          	LD	C,013H
D312 18 0A          	JR	CDEL1		;(BDOS)ファイルの削除
D314                
D314                C_REN:
D314 CD D0 D4       	CALL	SETFCB
D317 3E 10          	LD	A,010H		;ディレクトリも対象にする
D319 32 69 00       	LD	(FCB1+13),A	;属性
D31C 0E 17          	LD	C,017H		;(BDOS)ファイル名の変更
D31E                CDEL1:
D31E 11 5C 00       	LD	DE,FCB1
D321 CD 05 00       	CALL	SYSTEM
D324 C6 FF          	ADD	A,0FFH
D326 C9             	RET
D327                
D327                C_DIR:
D327 CD DF E0       	CALL	FILEC
D32A 21 15 EF       	LD	HL,FDRV+1
D32D CD 61 D6       	CALL	CWILD1
D330 3E F1          	LD	A,0F1H
D332 32 21 EF       	LD	(FDRV+13),A
D335 CD E8 D1       	CALL	OPEN1
D338                CDIR1:
D338 B7             	OR	A
D339 20 08          	JR	NZ,PDSKF
D33B CD 86 D3       	CALL	P_NAME
D33E CD FA D1       	CALL	OPEN2
D341 18 F5          	JR	CDIR1
D343                
D343                PDSKF:
D343 3A 14 EF       	LD	A,(FDRV)
D346 5F             	LD	E,A
D347 0E 1B          	LD	C,01BH		;(BDOS)ディスク情報の獲得
D349 CD 05 00       	CALL	SYSTEM
D34C 4F             	LD	C,A		;C←1クラスタ辺りの論理セクタ数
D34D C6 01          	ADD	A,001H
D34F D8             	RET	C		;Aが0FFHだった場合
D350 3E 06          	LD	A,8-2
D352                PDS1:				;HL=未使用クラスタの総数
D352 3C             	INC	A
D353 CB 19          	RR	C
D355 30 FB          	JR	NC,PDS1
D357                PDS2:				;B←論理セクタのサイズの上位8ビット
D357 3C             	INC	A
D358 CB 18          	RR	B
D35A 30 FB          	JR	NC,PDS2
D35C 47             	LD	B,A
D35D                
D35D 11 00 00       	LD	DE,0
D360                PDS3:
D360 29             	ADD	HL,HL
D361 EB             	EX	DE,HL
D362 ED 6A          	ADC	HL,HL
D364 EB             	EX	DE,HL
D365 10 F9          	DJNZ	PDS3
D367                PDSKF1:
D367 CD FF D3       	CALL	PRDEC_DEHL
D36A 11 D2 D6       	LD	DE,FREE
D36D CD 5F D8       	CALL	_SYS09		;(BDOS)文字列出力
D370 CD EE D3       	CALL	PUTDRV
D373 3E 5C          	LD	A,05CH		;\
D375 CD 23 DC       	CALL	MSG_A
D378 2A 22 EF       	LD	HL,(FDRV+14)	;ディレクトリのクラスタ番号
D37B AF             	XOR	A
D37C 11 FE FF       	LD	DE,0-2
D37F 19             	ADD	HL,DE
D380 23             	INC	HL
D381 DC FB D3       	CALL	C,PRDEC_HL
D384 18 41          	JR	LTNL
D386                
D386                P_NAME:
D386 3A 6D D6       	LD	A,(DTA_CCP+1)
D389 FE 2E          	CP	'.'
D38B C8             	RET	Z
D38C 11 EA D6       	LD	DE,DIRHD
D38F CD 5F D8       	CALL	_SYS09		;(BDOS)文字列出力
D392 3A 78 D6       	LD	A,(DTA_CCP+1+00BH)
D395 F5             	PUSH	AF
D396 0F             	RRCA
D397 9F             	SBC	A,A
D398 E6 0A          	AND	'*'-020H
D39A C6 20          	ADD	A,020H
D39C CD 23 DC       	CALL	MSG_A
D39F CD EE D3       	CALL	PUTDRV
D3A2 21 6D D6       	LD	HL,DTA_CCP+1
D3A5 CD 3F D4       	CALL	FPRNT
D3A8                
D3A8 F1             	POP	AF
D3A9 CB 67          	BIT	4,A
D3AB 28 08          	JR	Z,DIR3
D3AD 11 DF D6       	LD	DE,DIRMES
D3B0 CD 5F D8       	CALL	_SYS09		;(BDOS)文字列出力
D3B3 18 0A          	JR	DIR6
D3B5                DIR3:
D3B5 ED 5B 8B D6    	LD	DE,(DTA_CCP+1+01EH)
D3B9 2A 89 D6       	LD	HL,(DTA_CCP+1+01CH)
D3BC CD FF D3       	CALL	PRDEC_DEHL
D3BF                DIR6:
D3BF 3A B1 EF       	LD	A,(CRTCD+1)
D3C2 FE 29          	CP	40+1
D3C4 D4 61 D4       	CALL	NC,PRTTMS
D3C7                
D3C7                LTNL:
D3C7 1E 03          	LD	E,3
D3C9 C3 CD EF       	JP	_PRINT
D3CC                
D3CC                C_PATH:
D3CC CD C1 E1       	CALL	SPCUT
D3CF 21 91 D6       	LD	HL,PATHD
D3D2 FE 21          	CP	021H
D3D4 30 0C          	JR	NC,CPATH0
D3D6                CPATHP:
D3D6 7E             	LD	A,(HL)
D3D7 23             	INC	HL
D3D8 FE 20          	CP	020H
D3DA 3F             	CCF
D3DB 30 EA          	JR	NC,LTNL
D3DD CD 23 DC       	CALL	MSG_A
D3E0 18 F4          	JR	CPATHP
D3E2                CPATH0:
D3E2 FE 3B          	CP	';'
D3E4 20 01          	JR	NZ,CPATH1
D3E6 13             	INC	DE
D3E7                CPATH1:
D3E7 EB             	EX	DE,HL
D3E8 01 40 00       	LD	BC,PATHX
D3EB ED B0          	LDIR
D3ED C9             	RET
D3EE                
D3EE                PUTDRV:
D3EE 3A 14 EF       	LD	A,(FDRV)
D3F1 C6 40          	ADD	A,'A'-1
D3F3 CD 23 DC       	CALL	MSG_A
D3F6 3E 3A          	LD	A,':'
D3F8                MSG_AR:
D3F8 C3 23 DC       	JP	MSG_A
D3FB                
D3FB                PRDEC_HL:
D3FB AF             	XOR	A
D3FC                PRDEC_AHL:
D3FC 5F             	LD	E,A
D3FD 16 00          	LD	D,0
D3FF                PRDEC_DEHL:
D3FF D5             	PUSH	DE
D400 11 0F EF       	LD	DE,DECBF
D403 06 05          	LD	B,5
D405 CD 05 D5       	CALL	ZERO_MEMORY_DE	;A=0
D408 D1             	POP	DE
D409                
D409 0E 20          	LD	C,32
D40B                DEC1:
D40B 29             	ADD	HL,HL
D40C EB             	EX	DE,HL
D40D ED 6A          	ADC	HL,HL
D40F EB             	EX	DE,HL
D410 E5             	PUSH	HL
D411 21 13 EF       	LD	HL,DECBF+4
D414 06 05          	LD	B,5
D416                DEC2:
D416 7E             	LD	A,(HL)
D417 8F             	ADC	A,A
D418 27             	DAA
D419 77             	LD	(HL),A
D41A 2B             	DEC	HL
D41B 10 F9          	DJNZ	DEC2
D41D E1             	POP	HL
D41E 0D             	DEC	C
D41F 20 EA          	JR	NZ,DEC1
D421                
D421 21 0F EF       	LD	HL,DECBF
D424 3E 20          	LD	A,020H
D426 06 04          	LD	B,4
D428                DEC3:
D428 CD 35 D4       	CALL	DEC4
D42B CD 35 D4       	CALL	DEC4
D42E 23             	INC	HL
D42F 10 F7          	DJNZ	DEC3
D431                DECX:
D431 CD 35 D4       	CALL	DEC4
D434 AF             	XOR	A
D435                DEC4:
D435 ED 6F          	RLD
D437 FE 20          	CP	020H
D439 28 02          	JR	Z,DEC5
D43B F6 30          	OR	030H
D43D                DEC5:
D43D 18 B9          	JR	MSG_AR
D43F                
D43F                FPRNT:
D43F 06 08          	LD	B,8
D441 CD 52 D4       	CALL	P_N1
D444 7E             	LD	A,(HL)
D445 C6 80          	ADD	A,0A0H-020H
D447 FE A0          	CP	0A0H
D449 28 02          	JR	Z,FPR1
D44B 3E 2E          	LD	A,'.'
D44D                FPR1:
D44D CD 23 DC       	CALL	MSG_A
D450 06 03          	LD	B,3
D452                
D452                P_N1:
D452 C5             	PUSH	BC
D453 E5             	PUSH	HL
D454 7E             	LD	A,(HL)
D455 CD 02 E4       	CALL	CAP3
D458 CD 23 DC       	CALL	MSG_A
D45B E1             	POP	HL
D45C C1             	POP	BC
D45D 23             	INC	HL
D45E 10 F2          	DJNZ	P_N1
D460 C9             	RET
D461                
D461                PRTTMS:
D461 3E 20          	LD	A,020H
D463 CD 23 DC       	CALL	MSG_A
D466                
D466 2A 85 D6       	LD	HL,(DTA_CCP+1+24)
D469 7D             	LD	A,L
D46A B7             	OR	A
D46B C8             	RET	Z
D46C CB 3C          	SRL	H
D46E 17             	RLA
D46F 17             	RLA
D470 17             	RLA
D471 17             	RLA
D472 E6 0F          	AND	00FH
D474 57             	LD	D,A
D475 7C             	LD	A,H
D476 C6 50          	ADD	A,80
D478 CD BB D4       	CALL	PRDEC_A
D47B 3E 2D          	LD	A,'-'
D47D CD 23 DC       	CALL	MSG_A
D480 7A             	LD	A,D
D481 CD BB D4       	CALL	PRDEC_A
D484 3E 2D          	LD	A,'-'
D486 CD 23 DC       	CALL	MSG_A
D489 7D             	LD	A,L
D48A E6 1F          	AND	01FH
D48C CD BB D4       	CALL	PRDEC_A
D48F                
D48F 2A 83 D6       	LD	HL,(DTA_CCP+1+22)
D492                
D492 3E 20          	LD	A,020H
D494 CD 23 DC       	CALL	MSG_A
D497 7C             	LD	A,H
D498 65             	LD	H,L
D499 06 03          	LD	B,3
D49B                PRTTMS1:
D49B 1F             	RRA
D49C CB 1D          	RR	L
D49E 10 FB          	DJNZ	PRTTMS1
D4A0 E6 1F          	AND	01FH
D4A2 CD BB D4       	CALL	PRDEC_A
D4A5 3E 3A          	LD	A,':'
D4A7 CD 23 DC       	CALL	MSG_A
D4AA 7D             	LD	A,L
D4AB 0F             	RRCA
D4AC 0F             	RRCA
D4AD E6 3F          	AND	03FH
D4AF CD BB D4       	CALL	PRDEC_A
D4B2 3E 3A          	LD	A,':'
D4B4 CD 23 DC       	CALL	MSG_A
D4B7 7C             	LD	A,H
D4B8 E6 1F          	AND	01FH
D4BA 87             	ADD	A,A
D4BB                
D4BB                ;	PRINT10
D4BB                
D4BB                PRDEC_A:
D4BB E5             	PUSH	HL
D4BC 06 08          	LD	B,8
D4BE 4F             	LD	C,A
D4BF AF             	XOR	A
D4C0                PRTA1:
D4C0 CB 01          	RLC	C
D4C2 8F             	ADC	A,A
D4C3 27             	DAA
D4C4 10 FA          	DJNZ	PRTA1
D4C6 21 0F EF       	LD	HL,DECBF
D4C9 77             	LD	(HL),A
D4CA AF             	XOR	A
D4CB CD 31 D4       	CALL	DECX
D4CE E1             	POP	HL
D4CF C9             	RET
D4D0                
D4D0                SETFCB:
D4D0 CD C1 E1       	CALL	SPCUT
D4D3 1A             	LD	A,(DE)
D4D4 FE 20          	CP	020H
D4D6 38 01          	JR	C,SETFCBA
D4D8 1B             	DEC	DE
D4D9                SETFCBA:
D4D9 06 24          	LD	B,36
D4DB 21 5C 00       	LD	HL,FCB1
D4DE E5             	PUSH	HL
D4DF AF             	XOR	A
D4E0 CD 96 E1       	CALL	FILL_MEMORY
D4E3 E1             	POP	HL
D4E4 D5             	PUSH	DE
D4E5 CD C2 DA       	CALL	_SYS5C		;(BDOS)ファイル名の解析
D4E8 21 6C 00       	LD	HL,FCB2
D4EB CD C2 DA       	CALL	_SYS5C		;(BDOS)ファイル名の解析
D4EE E1             	POP	HL
D4EF 01 00 50       	LD	BC,05000H
D4F2 11 81 00       	LD	DE,00081H
D4F5                SETFCB1:
D4F5 7E             	LD	A,(HL)
D4F6 23             	INC	HL
D4F7 FE 20          	CP	020H
D4F9 38 05          	JR	C,SETFCB2
D4FB 12             	LD	(DE),A
D4FC 13             	INC	DE
D4FD 0C             	INC	C
D4FE 10 F5          	DJNZ	SETFCB1
D500                SETFCB2:
D500 79             	LD	A,C
D501 32 80 00       	LD	(DTA1),A
D504 04             	INC	B
D505                ZERO_MEMORY_DE:
D505 AF             	XOR	A
D506                FILL_MEMORY_DE:
D506 12             	LD	(DE),A
D507 13             	INC	DE
D508 10 FC          	DJNZ	FILL_MEMORY_DE
D50A C9             	RET
D50B                
D50B                C_COPY:
D50B CD D0 D4       	CALL	SETFCB
D50E 11 81 00       	LD	DE,DTA1+1
D511 0E 2F          	LD	C,'/'
D513 CD FF D2       	CALL	SWITCH
D516 CD F6 E3       	CALL	CAP
D519 32 A1 D5       	LD	(SW+1),A
D51C                
D51C 11 61 EF       	LD	DE,BEEPD
D51F CD E2 E0       	CALL	FILEC2
D522 21 6C 00       	LD	HL,FCB2
D525 CD C9 DA       	CALL	S29X1
D528                
D528 3E 10          	LD	A,010H
D52A 32 69 00       	LD	(FCB1+13),A
D52D 21 6D 00       	LD	HL,FCB2+1
D530 CD 61 D6       	CALL	CWILD1
D533                COPY0:
D533 CD 5E D6       	CALL	CWILD
D536 21 5C 00       	LD	HL,FCB1
D539 CD EB D1       	CALL	OPEN
D53C 37             	SCF
D53D                COPY1:
D53D C0             	RET	NZ
D53E CD FE D1       	CALL	DEFCB
D541                
D541 3A 79 D6       	LD	A,(DTA_CCP+13)
D544 CB 67          	BIT	4,A
D546 28 24          	JR	Z,COPY1A
D548                
D548 21 5D 00       	LD	HL,FCB1+1
D54B CD 25 E5       	CALL	CHKWILD
D54E 38 17          	JR	C,COPY9
D550                
D550 3E 20          	LD	A,020H
D552 32 5D 00       	LD	(FCB1+1),A
D555 2A 86 D6       	LD	HL,(DTA_CCP+26)
D558 23             	INC	HL
D559 22 6A 00       	LD	(FCB1+14),HL
D55C 18 D5          	JR	COPY0
D55E                
D55E                COPYS:
D55E 11 74 EF       	LD	DE,SKIP
D561                COPY8:
D561 CD 5F D8       	CALL	_SYS09		;(BDOS)文字列出力
D564 CD C7 D3       	CALL	LTNL
D567                COPY9:
D567 CD FA D1       	CALL	OPEN2
D56A 18 D1          	JR	COPY1
D56C                
D56C                COPY1A:
D56C 21 6C 00       	LD	HL,FCB2
D56F 11 14 EF       	LD	DE,FDRV
D572 01 6E D6       	LD	BC,DTA_CCP+2
D575 ED A0          	LDI
D577 3E 0B          	LD	A,11
D579                COPY2:
D579 F5             	PUSH	AF
D57A 7E             	LD	A,(HL)
D57B FE 3F          	CP	'?'
D57D 20 01          	JR	NZ,COPY3
D57F 0A             	LD	A,(BC)
D580                COPY3:
D580 12             	LD	(DE),A
D581 03             	INC	BC
D582 13             	INC	DE
D583 23             	INC	HL
D584 F1             	POP	AF
D585 3D             	DEC	A
D586 20 F1          	JR	NZ,COPY2
D588 01 05 00       	LD	BC,16-11
D58B ED B0          	LDIR
D58D                PUTNAME:
D58D 21 5D 00       	LD	HL,FCB1+1
D590 CD 25 E5       	CALL	CHKWILD
D593 30 0B          	JR	NC,PUTN1
D595 21 15 EF       	LD	HL,FDRV+1
D598 CD 3F D4       	CALL	FPRNT
D59B 3E 20          	LD	A,020H
D59D CD 23 DC       	CALL	MSG_A
D5A0                PUTN1:
D5A0 3E 00          SW:	LD	A,000H
D5A2 FE 54          	CP	'T'
D5A4 20 05          	JR	NZ,CSW1
D5A6 21 C0 D5       	LD	HL,SWNE
D5A9 18 07          	JR	SWT1
D5AB                CSW1:
D5AB FE 4E          	CP	'N'
D5AD 20 11          	JR	NZ,SWNE
D5AF 21 5E D5       	LD	HL,COPYS
D5B2                SWT1:
D5B2 11 14 EF       	LD	DE,FDRV
D5B5 CD 17 D2       	CALL	SYSC0F
D5B8 28 01          	JR	Z,SWN1
D5BA E9             	JP	(HL)
D5BB                SWN1:
D5BB CD 14 D6       	CALL	CTIME
D5BE 30 9E          	JR	NC,COPYS
D5C0                SWNE:
D5C0 11 14 EF       	LD	DE,FDRV
D5C3 0E 16          	LD	C,016H		;(BDOS)ファイルの作成
D5C5 CD 19 D2       	CALL	SYSTEM0
D5C8 20 48          	JR	NZ,COPYE2
D5CA 67             	LD	H,A		;A=0
D5CB 6F             	LD	L,A
D5CC 22 35 EF       	LD	(FDRV+33),HL	;(FCB)ランダムレコード
D5CF 22 37 EF       	LD	(FDRV+35),HL
D5D2                COPY6:
D5D2 CD 22 D2       	CALL	S27BUF
D5D5 47             	LD	B,A
D5D6 3C             	INC	A
D5D7 28 31          	JR	Z,COPYE
D5D9 7C             	LD	A,H
D5DA B5             	OR	L
D5DB 28 0C          	JR	Z,COPY7
D5DD 11 14 EF       	LD	DE,FDRV
D5E0 0E 26          	LD	C,026H		;(BDOS)ランダムブロック書き込み
D5E2 CD 19 D2       	CALL	SYSTEM0
D5E5 20 23          	JR	NZ,COPYE
D5E7 10 E9          	DJNZ	COPY6
D5E9                COPY7:
D5E9 3A 79 D6       	LD	A,(DTA_CCP+13)	;(FCB)属性
D5EC 32 21 EF       	LD	(FDRV+13),A
D5EF 21 80 D6       	LD	HL,DTA_CCP+20	;(FCB)タイムスタンプ
D5F2 11 28 EF       	LD	DE,FDRV+20
D5F5 01 04 00       	LD	BC,4
D5F8 ED B0          	LDIR
D5FA                
D5FA 11 14 EF       	LD	DE,FDRV
D5FD 0E 10          	LD	C,010H		;(BDOS)ファイルのクローズ
D5FF CD 19 D2       	CALL	SYSTEM0
D602 20 06          	JR	NZ,COPYE
D604                
D604 11 71 EF       	LD	DE,OK
D607 C3 61 D5       	JP	COPY8
D60A                
D60A                COPYE:
D60A 11 14 EF       	LD	DE,FDRV
D60D 0E 13          	LD	C,013H		;(BDOS)ファイルの削除
D60F CD 05 00       	CALL	SYSTEM
D612                COPYE2:
D612 37             	SCF
D613 C9             	RET
D614                
D614                CTIME:
D614 ED 5B 80 D6    	LD	DE,(DTA_CCP+20)
D618 2A 28 EF       	LD	HL,(FDRV+20)
D61B A7             	AND	A
D61C ED 52          	SBC	HL,DE
D61E C0             	RET	NZ
D61F ED 5B 82 D6    	LD	DE,(DTA_CCP+22)
D623 2A 2A EF       	LD	HL,(FDRV+22)
D626 ED 52          	SBC	HL,DE
D628 C9             	RET
D629                
D629                C_TYPE:
D629 CD D0 D4       	CALL	SETFCB
D62C 21 5C 00       	LD	HL,FCB1
D62F CD EB D1       	CALL	OPEN
D632 37             	SCF
D633                TYPE1:
D633 C0             	RET	NZ
D634 CD FE D1       	CALL	DEFCB
D637 3E 06          	LD	A,6
D639 CD 23 DC       	CALL	MSG_A
D63C                TYPE2:
D63C CD 22 D2       	CALL	S27BUF
D63F C6 FE          	ADD	A,0FEH
D641 D8             	RET	C
D642 7C             	LD	A,H
D643 B5             	OR	L
D644 28 13          	JR	Z,TYPEE
D646 01 00 01       	LD	BC,00100H
D649                TYPE3:
D649 0A             	LD	A,(BC)
D64A 03             	INC	BC
D64B FE 1A          	CP	01AH
D64D 28 0A          	JR	Z,TYPEE
D64F CD 23 DC       	CALL	MSG_A
D652 2B             	DEC	HL
D653 7C             	LD	A,H
D654 B5             	OR	L
D655 20 F2          	JR	NZ,TYPE3
D657 18 E3          	JR	TYPE2
D659                TYPEE:
D659 CD FA D1       	CALL	OPEN2
D65C 18 D5          	JR	TYPE1
D65E                
D65E                CWILD:
D65E 21 5D 00       	LD	HL,FCB1+1
D661                CWILD1:
D661 7E             	LD	A,(HL)
D662 FE 20          	CP	020H
D664 C0             	RET	NZ
D665                CWILD2:
D665 3E 3F          	LD	A,'?'
D667 06 0B          	LD	B,11
D669 C3 96 E1       	JP	FILL_MEMORY
D66C                
D66C                DTA_CCP:
D66C                	DS	37
D691                
D691 00 00 00 40    PATHX	EQU	64
D691                PATHD:	DS	PATHX
D6D1 00             PATHE:	DB	0
D6D2                
D6D2 20 62 79 74    FREE:	DB	" bytes free",9,'$'
D6D6 65 73 20 66
D6DA 72 65 65 09
D6DE 24
D6DF 20 20 20 20    DIRMES:	DB	"     <DIR>$"
D6E3 20 3C 44 49
D6E7 52 3E 24
D6EA 20 20 3A 24    DIRHD:	DB	"  :$"
D6EE                
D6EE                COMTB:
D6EE 44 20 20 20    	DB	"D   "	;1
D6F2 27 D3          	DW	C_DIR
D6F4 44 49 52 20    	DB	"DIR "	;2
D6F8 27 D3          	DW	C_DIR
D6FA 43 4F 50 59    	DB	"COPY"	;3
D6FE 0B D5          	DW	C_COPY
D700 43 44 20 20    	DB	"CD  "	;4
D704 1E D2          	DW	C_CD
D706 44 45 4C 20    	DB	"DEL "	;5
D70A 0A D3          	DW	C_DEL
D70C 50 41 54 48    	DB	"PATH"	;6
D710 CC D3          	DW	C_PATH
D712 52 45 4E 20    	DB	"REN "	;7
D716 14 D3          	DW	C_REN
D718 54 59 50 45    	DB	"TYPE"	;8
D71C 29 D6          	DW	C_TYPE
D71E 52 45 4D 20    	DB	"REM "	;9
D722 08 D3          	DW	C_REM
D724                	INCLUDE	"X1DISK2.ASM"
D724                
D724                ;	LSX-Dodgers DISK2
D724                ;	X1/turbo/Z
D724                
D724                ;	GRAPHIC RAM DISK DRIVER
D724                
D724                
D724                GDRD:
D724 C5             	PUSH	BC
D725 CD 4D D7       	CALL	GADR
D728 F1             	POP	AF
D729                GDRD1:
D729 ED A2          	INI
D72B 04             	INC	B
D72C 0C             	INC	C
D72D 20 FA          	JR	NZ,GDRD1
D72F 04             	INC	B
D730 13             	INC	DE
D731 3D             	DEC	A
D732 20 F5          	JR	NZ,GDRD1
D734                GBANK0:
D734 3A BF EF       	LD	A,(WK1FD0)
D737 E6 EF          	AND	0EFH		;BANK0
D739 18 1D          	JR	S1FD0
D73B                
D73B                GDWT:
D73B C5             	PUSH	BC
D73C CD 4D D7       	CALL	GADR
D73F F1             	POP	AF
D740                GDWT1:
D740 04             	INC	B
D741 ED A3          	OUTI
D743 0C             	INC	C
D744 20 FA          	JR	NZ,GDWT1
D746 04             	INC	B
D747 13             	INC	DE
D748 3D             	DEC	A
D749 20 F5          	JR	NZ,GDWT1
D74B 18 E7          	JR	GBANK0
D74D                
D74D                GADR:
D74D 0E 00          	LD	C,0
D74F 7B             	LD	A,E
D750 C6 40          	ADD	A,040H
D752 47             	LD	B,A
D753 3A BF EF       	LD	A,(WK1FD0)
D756 F6 10          	OR	010H		;BANK1
D758                S1FD0:
D758 C5             	PUSH	BC
D759 32 BF EF       	LD	(WK1FD0),A
D75C 01 D0 1F       	LD	BC,01FD0H
D75F ED 79          	OUT	(C),A
D761 C1             	POP	BC
D762 C9             	RET
D763                
D763                
D763                ;	BANK RAM DISK DRIVER
D763                
D763                BDWT:
D763 3E             	DB	03EH	;LD A,??
D764 37             	SCF
D765 18 02          	JR	BRW
D767                
D767                BDRD:
D767 3E             	DB	03EH	;LD A,??
D768 A7             	AND	A
D769                BRW:
D769 F3             	DI
D76A 32 92 D7       	LD	(BRWPAT),A
D76D ED 73 B2 D7    	LD	(BANKSP+1),SP
D771 3A B3 D7       	LD	A,(BANKSP+2)
D774 87             	ADD	A,A
D775 38 03          	JR	C,BRW0
D777 31 CA FF       	LD	SP,EXTSP
D77A                BRW0:
D77A D9             	EXX		;裏レジスタ
D77B C5             	 PUSH	 BC
D77C D5             	 PUSH	 DE
D77D 01 00 0B       	 LD	 BC,00B00H	 ;バンクメモリ
D780 11 10 10       	 LD	 DE,01010H
D783 D9             	 EXX		;表レジスタ
D784                BRW1:
D784 C5             	PUSH	BC
D785 D5             	PUSH	DE
D786 EB             	EX	DE,HL
D787 29             	ADD	HL,HL
D788 29             	ADD	HL,HL
D789 7C             	LD	A,H
D78A E6 0F          	AND	00FH	;バンク
D78C 65             	LD	H,L
D78D CB 3C          	SRL	H	;/2
D78F 2E 00          	LD	L,0
D791 D9             	EXX		;裏レジスタ
D792 A7             BRWPAT:	 AND	 A	;自己書き換え(AND A:読み出し/SCF:書き込み)
D793 38 08          	 JR	 C,BRWT
D795 57             	 LD	 D,A	 ;D=バンク
D796 D9             	 EXX		;表レジスタ
D797 EB             	EX	DE,HL
D798 CD B6 D7       	CALL	BTFR
D79B 18 06          	JR	BRW2
D79D                BRWT:
D79D 5F             	 LD	E,A	 ;E=バンク
D79E D9             	 EXX		;表レジスタ
D79F CD B6 D7       	CALL	BTFR
D7A2 EB             	EX	DE,HL
D7A3                BRW2:
D7A3 D1             	POP	DE
D7A4 C1             	POP	BC
D7A5 13             	INC	DE
D7A6 10 DC          	DJNZ	BRW1
D7A8                
D7A8 D9             	EXX		;裏レジスタ
D7A9 3E 10          	 LD	 A,10H
D7AB ED 79          	 OUT	 (C),A		;メインメモリに切り替える
D7AD D1             	 POP	 DE
D7AE C1             	 POP	 BC
D7AF D9             	 EXX		;表レジスタ
D7B0 AF             	XOR	A
D7B1 31 00 00       BANKSP:	LD	SP,0
D7B4 FB             	EI
D7B5 C9             	RET
D7B6                
D7B6                ;メインメモリ←→バンクメモリ 512バイトの転送を行う
D7B6                ; DE:転送元アドレス
D7B6                ; HL:転送先アドレス
D7B6                ; 裏BC:バンク切り替えポート(0B00H)
D7B6                ; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
D7B6                ; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)
D7B6                
D7B6                BTFR:
D7B6 06 00          	LD	B,0	;256回ループ(256*2)
D7B8                BTFR1:
D7B8 D9             	EXX		;裏レジスタ
D7B9 ED 51          	 OUT	 (C),D	 ;BANK(MAIN)
D7BB D9             	 EXX		;表レジスタ
D7BC 1A             	LD	A,(DE)
D7BD 4F             	LD	C,A
D7BE 13             	INC	DE
D7BF 1A             	LD	A,(DE)
D7C0 13             	INC	DE
D7C1 D9             	EXX		;裏レジスタ
D7C2 ED 59          	 OUT	 (C),E	 ;MAIN(BANK)
D7C4 D9             	 EXX		;表レジスタ
D7C5 71             	LD	(HL),C
D7C6 23             	INC	HL
D7C7 77             	LD	(HL),A
D7C8 23             	INC	HL
D7C9 10 ED          	DJNZ	BTFR1
D7CB C9             	RET
D7CC                
D7CC                ;	EMM DRIVER(DMA)
D7CC                
D7CC                
D7CC                EDWT:
D7CC 0E 0F          	LD	C,15
D7CE 18 02          	JR	EDWT1
D7D0                EDRD:
D7D0 0E 0E          	LD	C,14
D7D2                EDWT1:
D7D2 C5             	PUSH	BC
D7D3 D5             	PUSH	DE
D7D4 22 14 D8       	LD	(DMAB),HL
D7D7 78             	LD	A,B
D7D8 87             	ADD	A,A
D7D9 3D             	DEC	A
D7DA 32 0D D8       	LD	(DMALEN+1),A
D7DD 3C             	INC	A
D7DE 84             	ADD	A,H	;HL(アドレス)を先に進めておく
D7DF 67             	LD	H,A
D7E0 EB             	EX	DE,HL
D7E1 29             	ADD	HL,HL
D7E2 DD 46 0C       	LD	B,(IX+00CH)	;DPB_0C_MAXCYL
D7E5 79             	LD	A,C
D7E6 DD 4E 0D       	LD	C,(IX+00DH)	;DPB_0D_MAXSEC
D7E9 09             	ADD	HL,BC
D7EA DD 4E 13       	LD	C,(IX+013H)	;DPB_13_UNITNO
D7ED 06 0D          	LD	B,00DH
D7EF ED 49          	OUT	(C),C
D7F1 0C             	INC	C
D7F2 ED 69          	OUT	(C),L
D7F4 0C             	INC	C
D7F5 ED 61          	OUT	(C),H
D7F7                
D7F7 21 08 D8       	LD	HL,EDMAD
D7FA CD F6 DF       	CALL	SETDMA
D7FD CD 1E E0       	CALL	GO_DMA
D800 EB             	EX	DE,HL
D801 D1             	POP	DE
D802 C1             	POP	BC
D803                DMA_ADD_SEC:
D803 13             	INC	DE
D804 10 FD          	DJNZ	DMA_ADD_SEC
D806 AF             	XOR	A
D807 C9             	RET
D808                
D808                EDMAD:
D808 C3             	DB	0C3H	;WR6 リセット
D809 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
D80A 03 0D          	DW	00D03H	;ポートA開始アドレス EMMリード/ライト
D80C FF 01          DMALEN:	DW	001FFH	;ブロック長(転送サイズ-1)
D80E 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
D80F 50             	DB	050H	;WR2 ポートBアドレスインクリメント メモリ
D810 02             	DB	002H	;ポートBタイミング
D811 80             	DB	080H	;WR3
D812 9A             	DB	09AH	;WR5 WAIT RDY:HIGH
D813 AD             	DB	0ADH	;WR4 連続 ポートB開始アドレス
D814 00 00          DMAB:	DW	0
D816 01             	DB	001H	;WR0 ポートA←ポートB 転送
D817                EMME:
D817                
D817 00 00 07 7D    AT_RE	EQU	EDWT-AT_EDWT
D817                
D817                	INCLUDE	"LDOS.ASM"
D817                
D817                ;	LSX-Dodgers OS
D817                
D817                BDOS0:
D817 E5             	PUSH	HL
D818 21 00 01       	LD	HL,00100H
D81B 39             	ADD	HL,SP
D81C 38 10          	JR	C,BDOS1X
D81E                BDOS2:
D81E E1             	POP	HL
D81F ED 73 2A D8    	LD	(BDSP+1),SP
D823 31 CA FF       	LD	SP,EXTSP
D826 CD 2D D8       	CALL	BDOS1
D829 31 00 00       BDSP:	LD	SP,0
D82C C9             	RET
D82D                BDOS1:
D82D E5             	PUSH	HL
D82E                BDOS1X:
D82E 79             	LD	A,C
D82F FE 3C          	CP	03CH
D831 38 02          	JR	C,DOS1
D833 3E 3C          	LD	A,03CH
D835                DOS1:
D835 87             	ADD	A,A
D836 6F             	LD	L,A
D837 26 F0          	LD	H,STABLE/256
D839 7E             	LD	A,(HL)
D83A 2C             	INC	L
D83B 66             	LD	H,(HL)
D83C 6F             	LD	L,A
D83D E3             	EX	(SP),HL
D83E 79             	LD	A,C
D83F C9             	RET
D840                _DOS2:
D840 FE 5A          	CP	05AH		;(BDOS)カレントディレクトリの変更(_CHDIR)
D842 CA 06 DB       	JP	Z,_SYS5A
D845 FE 5C          	CP	05CH		;(BDOS)ファイル名の解析(_PFILE)
D847 CA C2 DA       	JP	Z,_SYS5C
D84A FE 5F          	CP	05FH		;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
D84C CA 51 ED       	JP	Z,_SYS5F
D84F FE 6F          	CP	06FH		;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
D851 20 0A          	JR	NZ,_ERROR
D853 01 1D 01       	LD	BC,011DH
D856 11 45 01       	LD	DE,VER
D859 21 00 00       	LD	HL,MACD
D85C AF             	XOR	A
D85D                _ERROR:
D85D A7             	AND	A
D85E C9             	RET
D85F                
D85F                _SYS09:		;文字列出力
D85F D5             	PUSH	DE
D860                _SX09:
D860 1A             	LD	A,(DE)
D861 13             	INC	DE
D862 FE 24          	CP	'$'
D864 28 31          	JR	Z,SX0E2
D866 CD 23 DC       	CALL	MSG_A
D869 18 F5          	JR	_SX09
D86B                
D86B                MSX1:
D86B CD 23 DC       	CALL	MSG_A
D86E                MSX:
D86E 7E             	LD	A,(HL)
D86F 23             	INC	HL
D870 B7             	OR	A
D871 20 F8          	JR	NZ,MSX1
D873 C9             	RET
D874                
D874                _SYS0C:		;(BDOS)バージョン番号の獲得
D874 21 22 00       	LD	HL,00022H
D877 7D             	LD	A,L
D878 C9             	RET
D879                
D879                _SYS0D:		;(BDOS)ディスクリセット
D879 CD DF EF       	CALL	_FFLUSH
D87C E5             	PUSH	HL
D87D 21 80 00       	LD	HL,00080H
D880 22 8A EF       	LD	(_DTA),HL
D883 E1             	POP	HL
D884 D5             	PUSH	DE
D885 1E 00          	LD	E,0
D887 3E             	DB	03EH
D888                
D888                _SYS0E:		;(BDOS)カレントドライブの設定
D888 D5             	PUSH	DE
D889 7B             	LD	A,E
D88A DD E5          	PUSH	IX
D88C CD DC EF       	CALL	_GETDPB
D88F DD E1          	POP	IX
D891 38 04          	JR	C,SX0E2
D893 7B             	LD	A,E
D894 32 87 EF       	LD	(_DVSW),A
D897                SX0E2:
D897 3E 08          	LD	A,8
D899 D1             	POP	DE
D89A C9             	RET
D89B                
D89B                _SYS0F:		;(BDOS)ファイルのオープン
D89B CD D3 E1       	CALL	SETDRV
D89E FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D8A1 C6 02          	ADD	A,002H		;Write
D8A3 28 48          	JR	Z,FEND0F
D8A5 CD 21 E5       	CALL	CHKWILDX
D8A8                
D8A8 D4 F3 E1       	CALL	NC,SOPENX
D8AB                _S16XX:
D8AB 38 40          	JR	C,FEND0F
D8AD                				;Directory location
D8AD 3A 9F EF       	LD	A,(_FILEN)
D8B0 FD 77 19       	LD	(IY+25),A	;(FCB)ディレクトリロケーション
D8B3                ;				_DIRF
D8B3 3A A0 EF       	LD	A,(_DIRF)
D8B6 FD 77 1D       	LD	(IY+29),A	;(FCB)ディレクトリモード
D8B9                ;				_FBPS
D8B9 FD 73 1E       	LD	(IY+30),E	;(FCB)ディレクトリポジション
D8BC FD 72 1F       	LD	(IY+31),D
D8BF                ;				Open(Read)
D8BF FD 36 1C FF    	LD	(IY+28),0FFH	;(FCB)オープンモード
D8C3                ;				FILENAME
D8C3 FD E5          	PUSH	IY
D8C5 D1             	POP	DE
D8C6 13             	INC	DE
D8C7 01 0B 00       	LD	BC,11
D8CA ED B0          	LDIR
D8CC                ;				Attribute
D8CC 7E             	LD	A,(HL)
D8CD FD 77 0D       	LD	(IY+13),A	;(FCB)属性(アトリビュート)
D8D0 11 0B 00       	LD	DE,11		;Reserved
D8D3 19             	ADD	HL,DE
D8D4                					;(FCB)ファイルを最後に変更した時刻
D8D4 11 EA F0       	LD	DE,SDDATA		;(FCB)ファイルを最後に変更した日付
D8D7 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
D8D9                S16LOOP:				;(FCB)ファイルのサイズ(バイト単位)
D8D9 1A             	LD	A,(DE)
D8DA 13             	INC	DE
D8DB 32 E2 D8       	LD	(S16PAT+2),A
D8DE 7E             	LD	A,(HL)
D8DF 23             	INC	HL
D8E0 FD 77 00       S16PAT:	LD	(IY+0),A
D8E3 10 F4          	DJNZ	S16LOOP
D8E5                
D8E5 AF             	XOR	A
D8E6 FD 77 0C       	LD	(IY+12),A	;(FCB)カレントブロック
D8E9 FD 22 91 D9    	LD	(OFCB+1),IY
D8ED                FEND0F:
D8ED 18 45          	JR	FEND10
D8EF                
D8EF                _SYS10:		;(BDOS)ファイルのクローズ
D8EF CD D3 E1       	CALL	SETDRV
D8F2 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D8F5 D6 FE          	SUB	0FEH
D8F7 37             	SCF
D8F8 3F             	CCF
D8F9 20 39          	JR	NZ,FEND10
D8FB                _S10A:				;Write
D8FB FD 77 0E       	LD	(IY+14),A	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D8FE FD 77 0F       	LD	(IY+15),A
D901                
D901 FD 34 1C       	INC	(IY+28)		;0FEH->0FFH ;オープンモード
D904 CD 0F E6       	CALL	SETTMS
D907                
D907 FD 7E 1D       	LD	A,(IY+29)	;(FCB)ディレクトリモード
D90A 32 A0 EF       	LD	(_DIRF),A
D90D E6 7F          	AND	07FH
D90F 32 7E EA       	LD	(_SECPS+1),A
D912 FD 5E 1E       	LD	E,(IY+30)	;(FCB)ディレクトリポジション
D915 FD 56 1F       	LD	D,(IY+31)
D918 CD 27 E3       	CALL	READ_DIR
D91B 38 17          	JR	C,FEND10
D91D                
D91D 3A 51 E2       SDECM1:	LD	A,(SDECPAT+1)	;1セクタ辺りのディレクトリエントリ数
D920 3D              	DEC	A		;1024=01FH / 512=00FH / 256=7
D921 FD A6 19       	AND	(IY+25)		;(FCB)ディレクトリロケーション
D924 6F             	LD	L,A
D925 26 00          	LD	H,0
D927 29             	ADD	HL,HL		;*2
D928 29             	ADD	HL,HL		;*4
D929 29             	ADD	HL,HL		;*8
D92A 29             	ADD	HL,HL		;*16
D92B 29             	ADD	HL,HL		;*32
D92C ED 4B 7E F0    	LD	BC,(_DTBUF)
D930 09             	ADD	HL,BC
D931                
D931 CD 31 E5       	CALL	SDIRENT
D934                FEND10:
D934 18 42          	JR	FEND
D936                
D936                _SYS11:		;(BDOS)最初のファイルの検索
D936 CD D3 E1       	CALL	SETDRV
D939 CD 20 E2       	CALL	SOPEN
D93C                _S12X1:
D93C 38 3A          	JR	C,FEND
D93E CD C0 E2       	CALL	SOPENE2
D941 ED 5B 8A EF    	LD	DE,(_DTA)
D945 3A 88 EF       	LD	A,(_DRV)
D948 3C             	INC	A
D949 12             	LD	(DE),A
D94A D5             	PUSH	DE
D94B 13             	INC	DE
D94C 01 20 00       	LD	BC,32
D94F ED B0          	LDIR
D951 FD 6E 0E       	LD	L,(IY+14)	;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
D954 FD 66 0F       	LD	H,(IY+15)
D957 22 F4 F0       	LD	(SCDIR),HL
D95A 2A 9A EF       	LD	HL,(_FBPS)
D95D 22 F6 F0       	LD	(SFBPS),HL
D960 2A 9F EF       	LD	HL,(_FILEN)
D963 7C             	LD	A,H
D964 B7             	OR	A
D965 28 06          	JR	Z,_S12DIR
D967 3A 7E EA       	LD	A,(_SECPS+1)
D96A F6 80          	OR	080H
D96C 67             	LD	H,A
D96D                _S12DIR:
D96D 22 F8 F0       	LD	(SFNDF),HL	;Directory position and Flags
D970 E1             	POP	HL
D971 11 39 EF       	LD	DE,SFILE
D974 0E 21          	LD	C,33
D976                _S11B:
D976 ED B0          	LDIR
D978                FEND:
D978 9F             	SBC	A,A		;CF=0 A=0 : CF=1 A=0FFH
D979                FENDE:
D979 FD E1          	POP	IY
D97B C1             	POP	BC
D97C D1             	POP	DE
D97D E1             	POP	HL
D97E C9             	RET
D97F                
D97F                _SYS12:		;(BDOS)次のファイルの検索
D97F E5             	PUSH	HL
D980 D5             	PUSH	DE
D981 C5             	PUSH	BC
D982 FD E5          	PUSH	IY
D984 CD 84 E2       	CALL	NOPEN
D987 18 B3          	JR	_S12X1
D989                
D989                _S16K:
D989 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
D98C FE FD          	CP	0FDH		;Device(0FDH)
D98E 37             	SCF
D98F C8             	RET	Z
D990                
D990 11 00 00       OFCB:	LD	DE,0
D993 D5             	PUSH	DE
D994 06 1A          	LD	B,26		;First cluster
D996                S16K1:
D996 13             	INC	DE
D997 23             	INC	HL
D998 10 FC          	DJNZ	S16K1
D99A                
D99A 1A             	LD	A,(DE)
D99B BE             	CP	(HL)
D99C 20 13          	JR	NZ,S16K2
D99E 13             	INC	DE
D99F 23             	INC	HL
D9A0 1A             	LD	A,(DE)
D9A1 BE             	CP	(HL)
D9A2 20 0D          	JR	NZ,S16K2
D9A4                
D9A4 E1             	POP	HL
D9A5 FD E5          	PUSH	IY
D9A7 D1             	POP	DE
D9A8 1A             	LD	A,(DE)		;Drive
D9A9 BE             	CP	(HL)
D9AA 20 06          	JR	NZ,S16K3
D9AC                				;ここはCFが必ず0
D9AC ED 52          	SBC	HL,DE		;CP HL,DE
D9AE 37             	SCF
D9AF C0             	RET	NZ
D9B0 E5             	PUSH	HL
D9B1                S16K2:
D9B1 E1             	POP	HL
D9B2                S16K3:
D9B2 FD E5          	PUSH	IY
D9B4 D1             	POP	DE
D9B5                _SYS13:		;(BDOS)ファイルの削除
D9B5 CD D3 E1       	CALL	SETDRV
D9B8 CD 51 E4       	CALL	KILL
D9BB                FEND13:
D9BB 18 BB          	JR	FEND
D9BD                
D9BD                _SYS14:		;(BDOS)シーケンシャルな読み出し
D9BD CD D3 E1       	CALL	SETDRV
D9C0 CD 41 E6       	CALL	PUSHRR
D9C3 CD 82 E6       	CALL	GETSEQ
D9C6                
D9C6 CD 96 E6       	CALL	RB_READ
D9C9 E5             	PUSH	HL
D9CA CD 55 E6       	CALL	SETSEQ
D9CD                SREAD:
D9CD E1             	POP	HL
D9CE                
D9CE C6 01          	ADD	A,001H
D9D0 38 A6          	JR	C,FEND
D9D2                
D9D2 7D             	LD	A,L
D9D3 D6 01          	SUB	001H
D9D5                FENDX:
D9D5 9F             	SBC	A,A
D9D6 E6 03          	AND	3
D9D8 1F             	RRA
D9D9 18 9E          	JR	FENDE
D9DB                
D9DB                _SYS15:		;(BDOS)シーケンシャルな書き込み
D9DB CD D3 E1       	CALL	SETDRV
D9DE CD 41 E6       	CALL	PUSHRR
D9E1 CD 82 E6       	CALL	GETSEQ
D9E4                
D9E4 CD 8F E6       	CALL	RB_WRITE
D9E7 E5             	PUSH	HL
D9E8 CD 55 E6       	CALL	SETSEQ
D9EB                SWRITE:
D9EB E1             	POP	HL
D9EC                
D9EC C6 FF          	ADD	A,0FFH
D9EE 18 E5          	JR	FENDX
D9F0                
D9F0                _SYS17:		;(BDOS)ファイル名の変更
D9F0 CD D3 E1       	CALL	SETDRV
D9F3 CD A7 E4       	CALL	NAME
D9F6 18 C3          	JR	FEND13
D9F8                
D9F8                _SYS16:		;(BDOS)ファイルの作成
D9F8 CD D3 E1       	CALL	SETDRV
D9FB                
D9FB CD 21 E5       	CALL	CHKWILDX
D9FE 38 BB          	JR	C,FEND13
DA00 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
DA03 FE 05          	CP	5
DA05 28 05          	JR	Z,_S16X2
DA07 FE 21          	CP	021H
DA09 DA BB D9       	JP	C,FEND13
DA0C                _S16X2:
DA0C                ;				Clear FCB
DA0C FD E5          	PUSH	IY
DA0E E1             	POP	HL
DA0F 01 10 00       	LD	BC,16
DA12 09             	ADD	HL,BC
DA13                _S16X1:
DA13 70             	LD	(HL),B		;B=0
DA14 23             	INC	HL
DA15 0D             	DEC	C
DA16 20 FB          	JR	NZ,_S16X1
DA18                
DA18 CD 14 E6       	CALL	SETTMSX
DA1B FD 36 0D FF    	LD	(IY+13),0FFH	;(FCB)Attribute
DA1F CD F3 E1       	CALL	SOPENX
DA22 3F             	CCF
DA23 CC 89 D9       	CALL	Z,_S16K
DA26 D4 D1 E2       	CALL	NC,COPEN
DA29 D4 31 E5       	CALL	NC,SDIRENT
DA2C C3 AB D8       	JP	_S16XX
DA2F                
DA2F                _SYS21:		;(BDOS)ランダムな読み出し
DA2F                
DA2F CD D3 E1       	CALL	SETDRV
DA32 CD 41 E6       	CALL	PUSHRR
DA35 FD 6E 21       	LD	L,(IY+33)	;(FCB)Random record
DA38 FD 66 22       	LD	H,(IY+34)
DA3B                
DA3B CD 96 E6       	CALL	RB_READ
DA3E E5             	PUSH	HL
DA3F CD 6C E6       	CALL	POPRR
DA42 18 89          	JR	SREAD
DA44                
DA44                _SYS22:		;(BDOS)ランダムな書き込み
DA44                _SYS28:		;(BDOS)ランダムな書き込み・その2
DA44 CD D3 E1       	CALL	SETDRV
DA47 CD 41 E6       	CALL	PUSHRR
DA4A FD 6E 21       	LD	L,(IY+33)	;(FCB)Random record
DA4D FD 66 22       	LD	H,(IY+34)
DA50                
DA50 CD 8F E6       	CALL	RB_WRITE
DA53 E5             	PUSH	HL
DA54 CD 6C E6       	CALL	POPRR
DA57 18 92          	JR	SWRITE
DA59                
DA59                _SYS18:		;(BDOS)ログインベクトルの獲得
DA59 21 FF 00       	LD	HL,000FFH
DA5C AF             	XOR	A
DA5D C9             	RET
DA5E                
DA5E                _SYS19:		;(BDOS)カレントドライブ番号の獲得
DA5E 3A 87 EF       	LD	A,(_DVSW)
DA61 A7             	AND	A
DA62 C9             	RET
DA63                
DA63                _SYS1A:		;(BDOS)DTAの設定
DA63 ED 53 8A EF    	LD	(_DTA),DE
DA67 AF             	XOR	A
DA68 C9             	RET
DA69                
DA69                _SYS1B:		;(BDOS)ディスク情報の獲得
DA69 7B             	LD	A,E
DA6A CD E6 E1       	CALL	GETDRV
DA6D CD DC EF       	CALL	_GETDPB
DA70 D4 E2 EF       	CALL	NC,_RDFATX
DA73 21 00 00       	LD	HL,0
DA76 D4 ED E5       	CALL	NC,DSKF
DA79                
DA79 ED 5B EE E5    	LD	DE,(MAXCLP+1)	;DPB_08_MAXCL-1
DA7D 1B             	DEC	DE		;DE←クラスタの総数
DA7E FD 2A 7C F0    	LD	IY,(_FATBF)	;IY←メモリ上のFATの先頭アドレス
DA82 9F             	SBC	A,A
DA83 D8             	RET	C
DA84 4F             	LD	C,A		;C=0
DA85 DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS
DA88 E6 0F          	AND	00FH
DA8A 47             	LD	B,A
DA8B DD 7E 07       	LD	A,(IX+7)	;DPB_07_SECPCL
DA8E C9             	RET
DA8F                
DA8F                _SYS1D:		;(BDOS)書き込みが禁止されているディスクの調査
DA8F AF             	XOR	A
DA90 67             	LD	H,A
DA91 6F             	LD	L,A
DA92 C9             	RET
DA93                
DA93                _SYS1F:		;(BDOS)ディスク装置のパラメータの読み出し
DA93 21 00 F1       	LD	HL,DEVICE
DA96 7B             	LD	A,E
DA97 C3 DC EF       	JP	_GETDPB
DA9A                
DA9A                _SYS23:		;(BDOS)ファイルサイズの獲得
DA9A E5             	PUSH	HL
DA9B 2A 1E F0       	LD	HL,(STABLE+2*00FH)	;ファイルのオープン
DA9E CD 0F 00       	CALL	JP_HL
DAA1 38 14          	JR	C,_S23X1
DAA3                
DAA3 D5             	PUSH	DE		;EX DE,IY
DAA4 FD E3          	EX	(SP),IY		;
DAA6                ;	POP	DE		;
DAA6                ;	PUSH	DE		;DEを破壊しないように注意vv
DAA6 CD 72 E6       	CALL	GETSIZE
DAA9                _S24X1:
DAA9 FD 75 21       	LD	(IY+33),L	;(FCB)Random record
DAAC FD 74 22       	LD	(IY+34),H
DAAF FD 36 23 00    	LD	(IY+35),0
DAB3                ;	POP	DE		;^^^^^^^^^^^^^^^^^^^^^^^^
DAB3                ;	PUSH	DE		;EX DE,IY
DAB3 FD E3          	EX	(SP),IY		;
DAB5 D1             	POP	DE		;
DAB6                
DAB6 AF             	XOR	A
DAB7                _S23X1:
DAB7 E1             	POP	HL
DAB8 C9             	RET
DAB9                
DAB9                _SYS24:		;(BDOS)ランダムレコードフィールドの設定
DAB9 E5             	PUSH	HL
DABA D5             	PUSH	DE		;EX DE,IY
DABB FD E3          	EX	(SP),IY		;
DABD                ;	POP	DE		;
DABD                ;	PUSH	DE		;DEを破壊しないように注意vv
DABD CD 82 E6       	CALL	GETSEQ
DAC0 18 E7          	JR	_S24X1		;^^^^^^^^^^^^^^^^^^^^^^^^
DAC2                
DAC2                _SYS5C:		;(BDOS)ファイル名の解析
DAC2 C5             	PUSH	BC
DAC3 E5             	PUSH	HL
DAC4 CD EA E0       	CALL	FILE
DAC7 E1             	POP	HL
DAC8 C1             	POP	BC
DAC9                S29X1:
DAC9 C5             	PUSH	BC
DACA D5             	PUSH	DE
DACB E5             	PUSH	HL
DACC EB             	EX	DE,HL
DACD 21 14 EF       	LD	HL,FDRV
DAD0 01 0D 00       	LD	BC,13
DAD3 ED B0          	LDIR
DAD5 70             	LD	(HL),B		;B=0
DAD6 0E 03          	LD	C,3
DAD8 ED B0          	LDIR
DADA E1             	POP	HL
DADB D1             	POP	DE
DADC C1             	POP	BC
DADD AF             	XOR	A
DADE C9             	RET
DADF                
DADF                _SYS30:		;(BDOS)論理セクタを用いた書き込み
DADF C5             	PUSH	BC
DAE0 01 EC EB       	LD	BC,DWT24B
DAE3 18 04          	JR	S2FX
DAE5                _SYS2F:
DAE5 C5             	PUSH	BC
DAE6 01 DC EB       	LD	BC,DRD24B
DAE9                S2FX:
DAE9 ED 43 FF DA    	LD	(S2FPAT+1),BC
DAED CD DF EF       	CALL	_FFLUSH
DAF0                
DAF0 D5             	PUSH	DE
DAF1 E5             	PUSH	HL
DAF2 7D             	LD	A,L		;Drive
DAF3 CD D9 EF       	CALL	_CHGDRV
DAF6 38 09          	JR	C,S30X2
DAF8 44             	LD	B,H		;Number of clusters
DAF9 2A 8A EF       	LD	HL,(_DTA)
DAFC                
DAFC 0E 00          	LD	C,0
DAFE CD DC EB       S2FPAT:	CALL	DRD24B
DB01                S30X2:
DB01 E1             	POP	HL
DB02 D1             	POP	DE
DB03 C1             	POP	BC
DB04 9F             	SBC	A,A
DB05 C9             	RET
DB06                
DB06                _SYS5A:		;(BDOS)カレントディレクトリの変更
DB06 C5             	PUSH	BC
DB07 D5             	PUSH	DE
DB08 E5             	PUSH	HL
DB09 CD DF E0       	CALL	FILEC
DB0C 21 00 00       	LD	HL,0
DB0F 11 14 EF       	LD	DE,FDRV
DB12 2A 4E F0       	LD	HL,(STABLE+2*027H)	;ランダムブロック読み込み
DB15 CD 0F 00       	CALL	JP_HL
DB18 18 E7          	JR	S30X2
DB1A                	INCLUDE	"X1IO.ASM"
DB1A                
DB1A                ;	LSX-Dodgers IO
DB1A                ;	X1/turbo/Z
DB1A                
DB1A 00 00 D8 5D    _SYS04	EQU	_ERROR		;(BDOS)外部出力
DB1A 00 00 D8 5D    _SYS05	EQU	_ERROR		;(BDOS)プリンタ出力
DB1A 00 00 D8 5D    _SYS1C	EQU	_ERROR		;(BDOS)ディスクの書き込み禁止化
DB1A 00 00 D8 5D    _SYS1E	EQU	_ERROR		;(BDOS)ファイル属性の設定
DB1A 00 00 D8 5D    _SYS20	EQU	_ERROR		;(BDOS)利用者番号の設定と読み出し
DB1A 00 00 D8 5D    _SYS2E	EQU	_ERROR		;(BDOS)ベリファイ・フラグの設定
DB1A                
DB1A                BIOS:
DB1A E5             	PUSH	HL
DB1B 21 10 80       	LD	HL,08010H
DB1E 39             	ADD	HL,SP
DB1F E1             	POP	HL
DB20 30 0E          	JR	NC,BIOS2
DB22                BIOS1:
DB22 CD 2A DB       	CALL	BIOS3
DB25 06 1E          	LD	B,01EH
DB27 ED 79          	OUT	(C),A
DB29 C9             	RET
DB2A                BIOS3:
DB2A C5             	PUSH	BC
DB2B 06 1D          	LD	B,01DH
DB2D ED 79          	OUT	(C),A
DB2F C9             	RET
DB30                BIOS2:
DB30 ED 73 3B DB    	LD	(SPPAT+1),SP	;スタックがBIOS-ROMと被っている場合
DB34 31 CA FF       	LD	SP,EXTSP
DB37 CD 22 DB       	CALL	BIOS1
DB3A 31 00 00       SPPAT:	LD	SP,0
DB3D C9             	RET
DB3E                
DB3E                INT:
DB3E F5             	PUSH	AF
DB3F E5             	PUSH	HL
DB40 ED 73 51 DB    	LD	(INTSP+1),SP
DB44 21 00 01       	LD	HL,00100H
DB47 39             	ADD	HL,SP
DB48 38 03          	JR	C,INTP1X
DB4A 31 CA FF       	LD	SP,EXTSP
DB4D                INTP1X:
DB4D CD 58 DB       	CALL	INTP1
DB50 31 00 00       INTSP:	LD	SP,0
DB53                INTPE:
DB53 E1             	POP	HL
DB54                INTPE2:
DB54 F1             	POP	AF
DB55                INTCTCE:
DB55 FB             	EI
DB56 ED 4D          	RETI
DB58                INTP1:
DB58 C5             	PUSH	BC
DB59                
DB59 CD 25 DF       	CALL	IN49SB
DB5C 67             	LD	H,A
DB5D CD 25 DF       	CALL	IN49SB
DB60 6F             	LD	L,A
DB61                
DB61 FE 08          	CP	8		;DELキー
DB63 20 05          	JR	NZ,SCEXE
DB65 7C             	LD	A,H
DB66 E6 11          	AND	011H		;CTRLキー + GRAPHキー
DB68 28 08          	JR	Z,RESET
DB6A                SCEXE:
DB6A 22 92 EF       	LD	(_KEYD),HL
DB6D CD 9E DB       	CALL	KEYSET1
DB70                
DB70 C1             	POP	BC
DB71 C9             	RET
DB72                
DB72                RESET:
DB72 3E 1D          	LD	A,01DH
DB74 D3 00          	OUT	(0),A
DB76 C7             	RST	0
DB77                
DB77                INTCTC2:
DB77 F5             	PUSH	AF
DB78 3E 00          INTCPAT:LD	A,000H
DB7A 3D             	DEC	A
DB7B 32 79 DB       	LD	(INTCPAT+1),A
DB7E 20 D4          	JR	NZ,INTPE2
DB80                
DB80 3A 92 EF       	LD	A,(_KEYD)
DB83 B7             	OR	A
DB84 28 CE          	JR	Z,INTPE2
DB86                KEYSET0:
DB86 E5             	PUSH	HL
DB87 2A 90 EF       	LD	HL,(_KEYPS)
DB8A 7C             	LD	A,H
DB8B AD             	XOR	L
DB8C 20 06          	JR	NZ,INTC2A
DB8E                
DB8E 2A 92 EF       	LD	HL,(_KEYD)
DB91 CD C8 DB       	CALL	KEYSET
DB94                INTC2A:
DB94 3A 94 EF       	LD	A,(_KEYSP)
DB97 E6 0F          	AND	00FH
DB99 32 79 DB       	LD	(INTCPAT+1),A
DB9C                
DB9C 18 B5          	JR	INTPE
DB9E                
DB9E                KEYSET1:
DB9E CB 6C          	BIT	5,H
DBA0 F5             	PUSH	AF
DBA1 ED 4B 8C EF    	LD	BC,(_CTC)
DBA5 78             	LD	A,B
DBA6 B1             	OR	C
DBA7 20 06          	JR	NZ,KEYS10E
DBA9                
DBA9 F1             	POP	AF
DBAA 20 1C          	JR	NZ,KEYSET
DBAC F5             	PUSH	AF
DBAD 18 D7          	JR	KEYSET0
DBAF                KEYS10E:
DBAF F1             	POP	AF
DBB0 C8             	RET	Z
DBB1 F5             	PUSH	AF
DBB2 3E 03          	LD	A,3		;CTC STOP
DBB4 ED 79          	OUT	(C),A
DBB6 F1             	POP	AF
DBB7                
DBB7 B7             	OR	A
DBB8 C8             	RET	Z
DBB9                
DBB9 E5             	PUSH	HL
DBBA 2A 94 EF       	LD	HL,(_KEYSP)
DBBD 3E A7          	LD	A,0A7H
DBBF ED 79          	OUT	(C),A
DBC1 ED 69          	OUT	(C),L
DBC3 7C             	LD	A,H
DBC4 32 79 DB       	LD	(INTCPAT+1),A
DBC7 E1             	POP	HL
DBC8                
DBC8                KEYSET:
DBC8 7D             	LD	A,L
DBC9 CB 7C          	BIT	7,H
DBCB CC F9 DB       	CALL	Z,FKEY
DBCE CB 74          	BIT	6,H
DBD0 C0             	RET	NZ
DBD1                KEYBS:
DBD1 B7             	OR	A
DBD2 C8             	RET	Z
DBD3                KEYBS1:
DBD3 CD E9 DB       	CALL	KEYBC_IFBREAK
DBD6 E5             	PUSH	HL
DBD7 F5             	PUSH	AF
DBD8 2A 90 EF       	LD	HL,(_KEYPS)
DBDB 2C             	INC	L
DBDC 7D             	LD	A,L
DBDD BC             	CP	H
DBDE 28 15          	JR	Z,POP_AF_HL_SCF_RET
DBE0 32 90 EF       	LD	(_KEYPS),A
DBE3 26 FE          	LD	H,KEYBF/256
DBE5 F1             	POP	AF
DBE6 77             	LD	(HL),A
DBE7 E1             	POP	HL
DBE8 C9             	RET
DBE9                KEYBC_IFBREAK:
DBE9 FE 03          	CP	3
DBEB C0             	RET	NZ
DBEC                KEYBC:
DBEC E5             	PUSH	HL
DBED 21 00 00       	LD	HL,0
DBF0 22 90 EF       	LD	(_KEYPS),HL
DBF3 E1             	POP	HL
DBF4 C9             	RET
DBF5                
DBF5                POP_AF_HL_SCF_RET:
DBF5 F1             	POP	AF
DBF6 E1             	POP	HL
DBF7 37             	SCF
DBF8 C9             	RET
DBF9                
DBF9                FKEY:
DBF9 CB 75          	BIT	6,L
DBFB C8             	RET	Z
DBFC 3E 1B          	LD	A,01BH
DBFE CD D3 DB       	CALL	KEYBS1
DC01 7D             	LD	A,L
DC02 C6 AF          	ADD	A,020H-'q'
DC04 CB 7D          	BIT	7,L
DC06 C8             	RET	Z
DC07 2E 50          	LD	L,'P'
DC09 D6 90          	SUB	0E1H+020H-'q'
DC0B 28 10          	JR	Z,KEYBSL
DC0D 2C             	INC	L
DC0E 3D             	DEC	A
DC0F 28 0C          	JR	Z,KEYBSL
DC11 2C             	INC	L
DC12 D6 09          	SUB	0EBH-0E2H
DC14 28 07          	JR	Z,KEYBSL
DC16 2E 43          	LD	L,'C'
DC18 3D             	DEC	A
DC19 28 02          	JR	Z,KEYBSL
DC1B 2E 58          	LD	L,'X'
DC1D                KEYBSL:
DC1D 7D             	LD	A,L
DC1E 18 B3          	JR	KEYBS1
DC20                
DC20                _SYS01:		;(BDOS)コンソール入力
DC20 CD 09 EF       	CALL	_SYS07
DC23                MSG_A:
DC23 F5             	PUSH	AF
DC24 D5             	PUSH	DE
DC25 5F             	LD	E,A
DC26 CD 2C DC       	CALL	_SYS02
DC29 D1             	POP	DE
DC2A F1             	POP	AF
DC2B C9             	RET
DC2C                
DC2C                _SYS02:		;(BDOS)コンソール出力
DC2C CD 3E DC       	CALL	BREAK
DC2F 18 05          	JR	PRINTX
DC31                
DC31                _SYS06:		;(BDOS)コンソール直接入出力
DC31 7B             	LD	A,E
DC32 3C             	INC	A
DC33 CA CA EF       	JP	Z,_INKEY
DC36                PRINTX:
DC36 C3 CD EF       	JP	_PRINT
DC39                
DC39                _SYS08:		;(BDOS)エコーなしコンソール入力
DC39 CD 09 EF       	CALL	_SYS07
DC3C 18 04          	JR	BREAK1
DC3E                BREAK:
DC3E FB             	EI
DC3F 3A 92 EF       	LD	A,(_KEYD)
DC42                BREAK1:
DC42 FE 03          	CP	3		;CTRL+C
DC44 CA 00 EF       	JP	Z,CPM_BOOT
DC47 FE 13          	CP	013H		;CTRL+S
DC49 C0             	RET	NZ
DC4A                
DC4A                PAUSE:
DC4A CD EC DB       	CALL	KEYBC
DC4D                
DC4D                FLGET:
DC4D CD DF EF       	CALL	_FFLUSH
DC50 C5             	PUSH	BC
DC51 E5             	PUSH	HL
DC52 ED 4B 8E EF    	LD	BC,(_TXADR)
DC56 CB E8          	SET	5,B
DC58 ED 60          	IN	H,(C)
DC5A                FLGET1:
DC5A 3A 93 EF       	LD	A,(_KEYD+1)
DC5D 0F             	RRCA
DC5E 0F             	RRCA
DC5F E6 10          	AND	010H
DC61 F6 08          	OR	8
DC63 ED 68          	IN	L,(C)
DC65 B5             	OR	L
DC66 ED 79          	OUT	(C),A
DC68 CD CA EF       	CALL	_INKEY
DC6B 28 ED          	JR	Z,FLGET1
DC6D ED 61          	OUT	(C),H
DC6F E1             	POP	HL
DC70 C1             	POP	BC
DC71 C9             	RET
DC72                
DC72                _SYS0A:		;(BDOS)文字列入力
DC72 C5             	PUSH	BC
DC73 E5             	PUSH	HL
DC74 D5             	PUSH	DE
DC75 CD 70 E0       	CALL	GETL
DC78 11 00 FF       	LD	DE,KBUF
DC7B E1             	POP	HL
DC7C E5             	PUSH	HL
DC7D 0E 00          	LD	C,0
DC7F 30 04          	JR	NC,SAX0
DC81 23             	INC	HL
DC82 23             	INC	HL
DC83 18 08          	JR	SAX4
DC85                SAX0:
DC85 46             	LD	B,(HL)
DC86 23             	INC	HL
DC87                SAX1:
DC87 23             	INC	HL
DC88 1A             	LD	A,(DE)
DC89 13             	INC	DE
DC8A B7             	OR	A
DC8B 20 04          	JR	NZ,SAX2
DC8D                SAX4:
DC8D 36 0D          	LD	(HL),00DH
DC8F 18 04          	JR	SAX3
DC91                SAX2:
DC91 77             	LD	(HL),A
DC92 0C             	INC	C
DC93 10 F2          	DJNZ	SAX1
DC95                SAX3:
DC95 D1             	POP	DE
DC96 79             	LD	A,C
DC97 13             	INC	DE
DC98 12             	LD	(DE),A
DC99 1B             	DEC	DE
DC9A E1             	POP	HL
DC9B C1             	POP	BC
DC9C A7             	AND	A
DC9D C9             	RET
DC9E                
DC9E                _SYS0B:		;(BDOS)コンソール状態のチェック
DC9E CD 3E DC       	CALL	BREAK
DCA1 3A 92 EF       	LD	A,(_KEYD)
DCA4 B7             	OR	A
DCA5 C8             	RET	Z
DCA6                CONSTX:
DCA6 CD DF EF       	CALL	_FFLUSH
DCA9 E5             	PUSH	HL
DCAA 2A 90 EF       	LD	HL,(_KEYPS)
DCAD 7C             	LD	A,H
DCAE AD             	XOR	L
DCAF E1             	POP	HL
DCB0 C6 FF          	ADD	A,0FFH
DCB2 9F             	SBC	A,A
DCB3 C9             	RET
DCB4                
DCB4                _SYS2A:		;(BDOS)日付の獲得
DCB4 C5             	PUSH	BC
DCB5 3E ED          	LD	A,0EDH		;Read calendar
DCB7 CD 40 DF       	CALL	COMOUT
DCBA CD D7 DC       	CALL	IN49SB_BCD	;YY
DCBD 6F             	LD	L,A
DCBE 26 00          	LD	H,0
DCC0                ;	LD	DE,1900		;0076CH
DCC0                ;	CP	90		;90以上は1900年代 1990-1999
DCC0                ;	JR	NC,RDDATE1	;90未満は2000年代 2000-2089
DCC0                ;	LD	E,0D0H		;2000 & 0FFH D=007H
DCC0 11 D0 07       	LD	DE,2000		;すべて2000年代で処理 2000-2099
DCC3                RDDATE1:
DCC3 19             	ADD	HL,DE
DCC4 CD 25 DF       	CALL	IN49SB		;MM
DCC7 57             	LD	D,A
DCC8 CD D7 DC       	CALL	IN49SB_BCD	;DD
DCCB 5F             	LD	E,A
DCCC 7A             	LD	A,D
DCCD E6 07          	AND	7
DCCF 06 04          	LD	B,4
DCD1                RDDATE2:
DCD1 CB 3A          	SRL	D
DCD3 10 FC          	DJNZ	RDDATE2
DCD5 C1             	POP	BC
DCD6 C9             	RET
DCD7                IN49SB_BCD:
DCD7 CD 25 DF       	CALL	IN49SB
DCDA                ;------------------------
DCDA                ;BCDの10進数化
DCDA                ;in
DCDA                ;	A  : BCD
DCDA                ;out
DCDA                ;	A  : 10進数
DCDA                ;------------------------
DCDA 4F             	LD	C,A
DCDB E6 F0          	AND	0F0H	;10の位
DCDD 0F             	RRCA
DCDE 47             	LD	B,A
DCDF 0F             	RRCA
DCE0 0F             	RRCA
DCE1 80             	ADD	A,B
DCE2 47             	LD	B,A
DCE3 79             	LD	A,C
DCE4 E6 0F          	AND	00FH	;1の位
DCE6 80             	ADD	A,B
DCE7 C9             	RET
DCE8                
DCE8                _SYS2C:		;(BDOS)時刻の獲得
DCE8 C5             	PUSH	BC
DCE9 3E EF          	LD	A,0EFH		;Read time
DCEB CD 40 DF       	CALL	COMOUT
DCEE CD D7 DC       	CALL	IN49SB_BCD	;TT
DCF1 67             	LD	H,A
DCF2 CD D7 DC       	CALL	IN49SB_BCD	;MM
DCF5 6F             	LD	L,A
DCF6 CD D7 DC       	CALL	IN49SB_BCD	;SS
DCF9 57             	LD	D,A
DCFA C1             	POP	BC
DCFB AF             	XOR	A
DCFC C9             	RET
DCFD                
DCFD                ESC1:
DCFD 7B             	LD	A,E
DCFE FE 41          	CP	'A'
DD00 CA 41 DE       	JP	Z,CTRL1E
DD03 FE 42          	CP	'B'
DD05 CA AB DF       	JP	Z,CTRL1F
DD08 FE 43          	CP	'C'
DD0A CA 4C DE       	JP	Z,CTRL1C
DD0D FE 44          	CP	'D'
DD0F CA 38 DE       	JP	Z,CTRL1D
DD12 FE 45          	CP	'E'
DD14 28 02          	JR	Z,CT0CX
DD16 FE 6A          	CP	'j'
DD18                CT0CX:
DD18 CA 7E DF       	JP	Z,CTRL0C
DD1B FE 48          	CP	'H'
DD1D CA C6 DE       	JP	Z,CTRL0B
DD20 FE 4A          	CP	'J'
DD22 CA 81 DF       	JP	Z,CTRL06
DD25 FE 4B          	CP	'K'
DD27 CA 85 DE       	JP	Z,CTRL05
DD2A FE 4C          	CP	'L'
DD2C CA C0 DF       	JP	Z,CTRL0E
DD2F FE 54          	CP	'T'
DD31 CA 85 DE       	JP	Z,CTRL05
DD34 FE 78          	CP	'x'
DD36 28 04          	JR	Z,ESC1X
DD38 FE 79          	CP	'y'
DD3A 20 02          	JR	NZ,ESC1Y
DD3C                ESC1X:
DD3C 36 01          	LD	(HL),1
DD3E                ESC1Y:
DD3E FE 3D          	CP	'='
DD40 28 04          	JR	Z,ESC1W
DD42 FE 59          	CP	'Y'
DD44 20 02          	JR	NZ,ESC1Z
DD46                ESC1W:
DD46 36 02          	LD	(HL),2
DD48                ESC1Z:
DD48 FE 20          	CP	020H
DD4A 38 02          	JR	C,ESC1C
DD4C 87             	ADD	A,A
DD4D D0             	RET	NC
DD4E                ESC1C:
DD4E E1             	POP	HL
DD4F 18 49          	JR	ANK
DD51                
DD51                ESC:
DD51 21 AB DD       	LD	HL,PRINTE5
DD54 E5             	PUSH	HL
DD55 21 77 DD       	LD	HL,ESCFLG+1
DD58 36 00          	LD	(HL),0
DD5A 3D             	DEC	A
DD5B 28 A0          	JR	Z,ESC1
DD5D 3D             	DEC	A
DD5E 20 09          	JR	NZ,ESC2
DD60 36 03          	LD	(HL),3
DD62 7B             	LD	A,E
DD63 D6 20          	SUB	020H
DD65 32 6C DD       	LD	(ESCYP+1),A
DD68 C9             	RET
DD69                ESC2:
DD69 3D             	DEC	A
DD6A C0             	RET	NZ
DD6B 26 00          ESCYP:	LD	H,0
DD6D 7B             	LD	A,E
DD6E D6 20          	SUB	020H
DD70 6F             	LD	L,A
DD71 C3 D6 EF       	JP	_LOC
DD74                
DD74                PRINT:
DD74 C5             	PUSH	BC
DD75 E5             	PUSH	HL
DD76 3E 00          ESCFLG:	LD	A,000H
DD78 B7             	OR	A
DD79 20 D6          	JR	NZ,ESC
DD7B                
DD7B 3E 1F          	LD	A,01FH
DD7D BB             	CP	E
DD7E 30 2F          	JR	NC,CTRL
DD80 01 49 DF       INSFLG:	LD	BC,INSERT
DD83                
DD83 3E 00          KANFLG:	LD	A,000H
DD85 B7             	OR	A
DD86 20 3A          	JR	NZ,KANJI2
DD88 7B             X1KPAT:	LD	A,E
DD89 FE 80          	CP	080H
DD8B 38 0D          	JR	C,ANK
DD8D FE A0          	CP	0A0H
DD8F 38 04          	JR	C,KANJI1
DD91 FE E0          	CP	0E0H
DD93 38 05          	JR	C,ANK
DD95                KANJI1:
DD95 32 84 DD       	LD	(KANFLG+1),A
DD98 18 11          	JR	PRINTE5
DD9A                ANK:
DD9A ED 4B 8E EF    	LD	BC,(_TXADR)
DD9E 78             	LD	A,B
DD9F F6 38          	OR	038H
DDA1 47             	LD	B,A
DDA2 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DDA4 CB 98          	RES	3,B
DDA6 ED 59          	OUT	(C),E		;Text
DDA8                KANJIE:
DDA8 CD 0D DE       	CALL	PRINTE7
DDAB                PRINTE5:
DDAB E1             	POP	HL
DDAC C1             	POP	BC
DDAD AF             	XOR	A
DDAE C9             	RET
DDAF                
DDAF                CTRL:
DDAF CD F4 DD       	CALL	KANCLR
DDB2 7B             	LD	A,E
DDB3 87             	ADD	A,A
DDB4 F6 80          	OR	080H
DDB6 6F             	LD	L,A
DDB7 26 F0          	LD	H,CTRLTB/256
DDB9 7E             	LD	A,(HL)
DDBA 2C             	INC	L
DDBB 66             	LD	H,(HL)
DDBC 6F             	LD	L,A
DDBD CD 0F 00       	CALL	JP_HL
DDC0 18 E9          	JR	PRINTE5
DDC2                
DDC2                KANJI2:
DDC2 D5             	PUSH	DE
DDC3 57             	LD	D,A
DDC4 01 81 2F       	LD	BC,02F81H	;SFTJIS
DDC7 DF             	RST	018H
DDC8 01 C3 2F       	LD	BC,02FC3H	;Instead or JISVRM
DDCB DF             	RST	018H
DDCC                
DDCC ED 4B 8E EF    	LD	BC,(_TXADR)
DDD0 78             	LD	A,B
DDD1 F6 38          	OR	038H
DDD3 47             	LD	B,A
DDD4 ED 51          	OUT	(C),D		;kanji
DDD6 CB 98          	RES	3,B
DDD8 ED 59          	OUT	(C),E		;Text
DDDA CD 0D DE       	CALL	PRINTE7
DDDD ED 4B 8E EF    	LD	BC,(_TXADR)
DDE1 78             	LD	A,B
DDE2 F6 38          	OR	038H
DDE4 47             	LD	B,A
DDE5 CB F2          	SET	6,D
DDE7 ED 51          	OUT	(C),D		;Kanji
DDE9 CB 98          	RES	3,B
DDEB ED 59          	OUT	(C),E		;Text
DDED D1             	POP	DE
DDEE AF             	XOR	A
DDEF 32 84 DD       	LD	(KANFLG+1),A
DDF2 18 B4          	JR	KANJIE
DDF4                
DDF4                KANCLR:
DDF4 3A 84 DD       	LD	A,(KANFLG+1)
DDF7 B7             	OR	A
DDF8 C8             	RET	Z
DDF9 ED 4B 8E EF    	LD	BC,(_TXADR)
DDFD 78             	LD	A,B
DDFE F6 38          	OR	038H
DE00 47             	LD	B,A
DE01 AF             	XOR	A
DE02 32 84 DD       	LD	(KANFLG+1),A
DE05 ED 79          	OUT	(C),A		;Kanji
DE07 CB 98          	RES	3,B
DE09 3E 20          	LD	A,020H
DE0B ED 79          	OUT	(C),A		;Text
DE0D                PRINTE7:
DE0D CB A0          	RES	4,B
DE0F                PRINTE6:
DE0F 3A 96 EF       	LD	A,(_COLORF)
DE12                PRINTE4:
DE12 ED 79          	OUT	(C),A		;Color
DE14 78             	LD	A,B
DE15 E6 07          	AND	7
DE17 47             	LD	B,A
DE18                PRINTE2:
DE18 03             	INC	BC
DE19                PRINTE3:
DE19 2A BA EF       	LD	HL,(CRTCD+10)
DE1C A7             	AND	A
DE1D ED 4A          	ADC	HL,BC
DE1F                PRINTE8:
DE1F 28 05          	JR	Z,PRINT2
DE21 ED 43 8E EF    	LD	(_TXADR),BC
DE25                CTRL00:
DE25 C9             	RET
DE26                
DE26                PRINT2:
DE26 CD C6 DF       	CALL	SCR
DE29 2A BC EF       	LD	HL,(CRTCD+12)
DE2C 09             	ADD	HL,BC
DE2D                SET_TXADR_HL:
DE2D 22 8E EF       	LD	(_TXADR),HL
DE30 C9             	RET
DE31                
DE31                CTRL08:
DE31 3A 80 DD       	LD	A,(INSFLG)
DE34 FE CD          	CP	0CDH		;CALL ????
DE36 28 29          	JR	Z,CTRL02
DE38                CTRL1D:
DE38 2A 8E EF       	LD	HL,(_TXADR)
DE3B 7C             	LD	A,H
DE3C B5             	OR	L
DE3D C8             	RET	Z
DE3E 2B             	DEC	HL
DE3F 18 EC          	JR	SET_TXADR_HL
DE41                
DE41                CTRL1E:
DE41 ED 4B 8E EF    	LD	BC,(_TXADR)
DE45 2A BC EF       	LD	HL,(CRTCD+12)
DE48 09             	ADD	HL,BC
DE49 D0             	RET	NC
DE4A 18 E1          	JR	SET_TXADR_HL
DE4C                
DE4C                CTRL1C:
DE4C ED 4B 8E EF    	LD	BC,(_TXADR)
DE50 18 C6          	JR	PRINTE2
DE52                
DE52                CTRL09:
DE52 ED 4B 8E EF    	LD	BC,(_TXADR)
DE56 79             	LD	A,C
DE57 E6 F8          	AND	0F8H
DE59 C6 08          	ADD	A,8
DE5B 4F             	LD	C,A
DE5C 88             	ADC	A,B
DE5D 91             	SUB	C
DE5E 47             	LD	B,A
DE5F 18 B8          	JR	PRINTE3
DE61                
DE61                CTRL02:
DE61 CD 38 DE       	CALL	CTRL1D
DE64 C8             	RET	Z
DE65 D5             	PUSH	DE
DE66 CD D3 EF       	CALL	_POS
DE69 3A B1 EF       	LD	A,(CRTCD+1)
DE6C 95             	SUB	L
DE6D 4F             	LD	C,A
DE6E 0D             	DEC	C
DE6F 06 38          	LD	B,038H
DE71 2A 8E EF       	LD	HL,(_TXADR)
DE74 09             	ADD	HL,BC
DE75 44             	LD	B,H
DE76 4D             	LD	C,L
DE77 11 00 20       	LD	DE,02000H	;D:Text E:kanji
DE7A 2A 96 EF       	LD	HL,(_COLORF)	;L:Color
DE7D                C8X1:
DE7D CD 65 DF       	CALL	C12S
DE80 0B             	DEC	BC
DE81 20 FA          	JR	NZ,C8X1
DE83 D1             	POP	DE
DE84 C9             	RET
DE85                
DE85                CTRL05:
DE85 CD D3 EF       	CALL	_POS
DE88 3A B1 EF       	LD	A,(CRTCD+1)
DE8B 95             	SUB	L
DE8C 6F             	LD	L,A
DE8D                C08X1:
DE8D ED 4B 8E EF    	LD	BC,(_TXADR)
DE91                LINECL:
DE91 26 20          	LD	H,020H
DE93 3A 96 EF       	LD	A,(_COLORF)
DE96 CB E8          	SET	5,B
DE98                LINECL1:
DE98 CB D8          	SET	3,B
DE9A CB E0          	SET	4,B
DE9C ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DE9E CB 98          	RES	3,B
DEA0 ED 61          	OUT	(C),H		;Text
DEA2 CB A0          	RES	4,B
DEA4 ED 79          	OUT	(C),A		;Color
DEA6 03             	INC	BC
DEA7 2D             	DEC	L
DEA8 20 EE          	JR	NZ,LINECL1
DEAA C9             	RET
DEAB                
DEAB                CTRL0D:
DEAB CD D3 EF       	CALL	_POS
DEAE 2E 00          	LD	L,0
DEB0                LOC:
DEB0 C5             	PUSH	BC
DEB1 E5             	PUSH	HL
DEB2 CD F4 DD       	CALL	KANCLR
DEB5 CD D3 DE       	CALL	LOC1
DEB8 22 8E EF       	LD	(_TXADR),HL
DEBB E1             	POP	HL
DEBC C1             	POP	BC
DEBD C9             	RET
DEBE                
DEBE                CTRL12:
DEBE 21 80 DD       	LD	HL,INSFLG
DEC1 7E             	LD	A,(HL)
DEC2 EE CC          	XOR	0CCH		;CD:CALL ???? 1:LD BC,????
DEC4 77             	LD	(HL),A
DEC5 C9             	RET
DEC6                
DEC6                CTRL0B:
DEC6 21 00 00       	LD	HL,0
DEC9 22 8E EF       	LD	(_TXADR),HL
DECC C9             	RET
DECD                
DECD                CTRL1B:
DECD 3E 01          	LD	A,1
DECF 32 77 DD       	LD	(ESCFLG+1),A
DED2 C9             	RET
DED3                
DED3                LOC1:
DED3 D5             	PUSH	DE
DED4 4D             	LD	C,L
DED5 06 08          	LD	B,8
DED7 5C             	LD	E,H
DED8 16 00          	LD	D,0
DEDA 2A B0 EF       	LD	HL,(CRTCD)
DEDD 6A             	LD	L,D
DEDE                LOC2:
DEDE 29             	ADD	HL,HL
DEDF 30 01          	JR	NC,LOC3
DEE1 19             	ADD	HL,DE
DEE2                LOC3:
DEE2 10 FA          	DJNZ	LOC2
DEE4 09             	ADD	HL,BC
DEE5 D1             	POP	DE
DEE6 C9             	RET
DEE7                
DEE7                CONOUT1:
DEE7 CD F9 DE       	CALL	CURSOR
DEEA 59             	LD	E,C
DEEB CD CD EF       	CALL	_PRINT
DEEE 7B             	LD	A,E
DEEF FE 0A          	CP	00AH
DEF1 20 06          	JR	NZ,CURSOR
DEF3 CD AB DE       	CALL	CTRL0D
DEF6 CD 85 DE       	CALL	CTRL05
DEF9                CURSOR:
DEF9 C5             	PUSH	BC
DEFA ED 4B 8E EF    	LD	BC,(_TXADR)
DEFE CB E8          	SET	5,B
DF00 ED 78          	IN	A,(C)
DF02 EE 18          	XOR	018H
DF04 ED 79          	OUT	(C),A
DF06 C1             	POP	BC
DF07 C9             	RET
DF08                
DF08                CTRL07:
DF08 21 61 EF       	LD	HL,BEEPD
DF0B                BEEP1:
DF0B 7E             	LD	A,(HL)
DF0C 23             	INC	HL
DF0D FE FF          	CP	0FFH
DF0F C8             	RET	Z
DF10 F3             	DI
DF11 06 1C          	LD	B,01CH
DF13 ED 79          	OUT	(C),A
DF15 ED A3          	OUTI
DF17 FB             	EI
DF18 18 F1          	JR	BEEP1
DF1A                
DF1A                OT49SB:
DF1A C5             	PUSH	BC
DF1B CD 36 DF       	CALL	CANW
DF1E 01 00 19       	LD	BC,01900H
DF21 ED 79          	OUT	(C),A
DF23 C1             	POP	BC
DF24 C9             	RET
DF25                
DF25                IN49SB:
DF25 C5             	PUSH	BC
DF26 01 01 1A       	LD	BC,01A01H
DF29                CANR:
DF29 ED 78          	IN	A,(C)
DF2B E6 20          	AND	020H
DF2D 20 FA          	JR	NZ,CANR
DF2F 01 00 19       	LD	BC,01900H
DF32 ED 78          	IN	A,(C)
DF34 C1             	POP	BC
DF35 C9             	RET
DF36                
DF36                CANW:
DF36 01 01 1A       	LD	BC,01A01H
DF39 ED 48          	IN	C,(C)
DF3B CB 71          	BIT	6,C
DF3D 20 F7          	JR	NZ,CANW
DF3F C9             	RET
DF40                
DF40                COMOUT:
DF40 FB             	EI
DF41 CD 1A DF       	CALL	OT49SB
DF44 CD 36 DF       	CALL	CANW
DF47 F3             	DI
DF48 C9             	RET
DF49                
DF49                INSERT:
DF49 D5             	PUSH	DE
DF4A CD D3 EF       	CALL	_POS
DF4D 3A B1 EF       	LD	A,(CRTCD+1)
DF50 95             	SUB	L
DF51 ED 4B 8E EF    	LD	BC,(_TXADR)
DF55 11 00 20       	LD	DE,02000H	;D:Text E:Kanji
DF58 2A 96 EF       	LD	HL,(_COLORF)	;L:Color
DF5B CB E8          	SET	5,B
DF5D                C12X1:
DF5D CD 65 DF       	CALL	C12S
DF60 03             	INC	BC
DF61 20 FA          	JR	NZ,C12X1
DF63 D1             	POP	DE
DF64 C9             	RET
DF65                
DF65                C12S:
DF65 CB E0          	SET	4,B
DF67 CB D8          	SET	3,B
DF69 ED 60          	IN	H,(C)
DF6B ED 59          X1PAT:	OUT	(C),E
DF6D 5C             	LD	E,H
DF6E CB 98          	RES	3,B
DF70 ED 60          	IN	H,(C)
DF72 ED 51          	OUT	(C),D
DF74 54             	LD	D,H
DF75 CB A0          	RES	4,B
DF77 ED 60          	IN	H,(C)
DF79 ED 69          	OUT	(C),L
DF7B 6C             	LD	L,H
DF7C 3D             	DEC	A
DF7D C9             	RET
DF7E                
DF7E                CTRL0C:
DF7E CD C6 DE       	CALL	CTRL0B
DF81                CTRL06:
DF81 ED 4B 8E EF    	LD	BC,(_TXADR)
DF85                C1AX1:
DF85 78             	LD	A,B
DF86 F6 38          	OR	038H
DF88 47             	LD	B,A
DF89 ED 71          	DB	0EDH,071H	;OUT (C),0	Z80未定義命令	kanji
DF8B CB 98          	RES	3,B
DF8D 3E 20          	LD	A,020H
DF8F ED 79          	OUT	(C),A		;Text
DF91 CB A0          	RES	4,B
DF93 3A 96 EF       	LD	A,(_COLORF)
DF96 ED 79          	OUT	(C),A		;Color
DF98 03             	INC	BC
DF99 CB A8          	RES	5,B
DF9B 2A BA EF       	LD	HL,(CRTCD+10)
DF9E 09             	ADD	HL,BC
DF9F 30 E4          	JR	NC,C1AX1
DFA1 C9             	RET
DFA2                
DFA2                CTRL04:
DFA2 CD D3 EF       	CALL	_POS
DFA5 7D             	LD	A,L
DFA6 B7             	OR	A
DFA7 C8             	RET	Z
DFA8                CTRL03:
DFA8 CD AB DE       	CALL	CTRL0D
DFAB                CTRL0A:
DFAB                CTRL1F:
DFAB ED 4B 8E EF    	LD	BC,(_TXADR)
DFAF 2A B1 EF       	LD	HL,(CRTCD+1)
DFB2 26 00          	LD	H,0
DFB4 09             	ADD	HL,BC
DFB5 44             	LD	B,H
DFB6 4D             	LD	C,L
DFB7 2A BA EF       	LD	HL,(CRTCD+10)
DFBA 09             	ADD	HL,BC
DFBB 3F             	CCF
DFBC 9F             	SBC	A,A
DFBD C3 1F DE       	JP	PRINTE8
DFC0                
DFC0                CTRL0E:
DFC0 CD D3 EF       	CALL	_POS
DFC3 7C             	LD	A,H
DFC4 18 04          	JR	SCR1
DFC6                SCR:
DFC6 3A 97 EF       	LD	A,(_LINE)
DFC9 3D             	DEC	A
DFCA                SCR1:
DFCA C5             	PUSH	BC
DFCB D5             	PUSH	DE
DFCC F5             	PUSH	AF
DFCD 3E 07          	LD	A,7
DFCF 21 00 E0       	LD	HL,SCRDMAD
DFD2 CD F6 DF       	CALL	SETDMA
DFD5 F1             	POP	AF
DFD6 21 00 38       	LD	HL,03800H
DFD9                
DFD9                SCRUP1:
DFD9 B7             	OR	A
DFDA 28 4D          	JR	Z,SCRCL
DFDC F5             	PUSH	AF
DFDD CD 07 E0       	CALL	UPSUB		;kanji
DFE0 3A BC EF       	LD	A,(CRTCD+12)
DFE3 5F             	LD	E,A
DFE4 16 F7          	LD	D,0F7H
DFE6 19             	ADD	HL,DE
DFE7 D5             	PUSH	DE
DFE8 CD 07 E0       	CALL	UPSUB		;Text
DFEB D1             	POP	DE
DFEC 19             	ADD	HL,DE
DFED CD 07 E0       	CALL	UPSUB		;Color
DFF0 CB E4          	SET	4,H
DFF2 F1             	POP	AF
DFF3 3D             	DEC	A
DFF4 18 E3          	JR	SCRUP1
DFF6                
DFF6                SETDMA:
DFF6 01 87 1F       	LD	BC,01F87H
DFF9                SDMA:
DFF9 04             	INC	B
DFFA ED A3          	OUTI
DFFC 3D             	DEC	A
DFFD 20 FA          	JR	NZ,SDMA
DFFF C9             	RET
E000                
E000                SCRDMAD:
E000 C3             	DB	0C3H		;WR6 リセット
E001 9A             	DB	09AH		;WR5 ストップ WAIT READY:HIGH
E002 65             	DB	065H		;WR0 ブロック長(LH)
E003 4F 00          	DW	79
E005 1C             	DB	01CH		;WR1 ポートAインクリメント I/O
E006 18             	DB	018H		;WR0 ポートAアドレス(LH)
E007                
E007                UPSUB:
E007 3A B1 EF       	LD	A,(CRTCD+1)
E00A 5F             	LD	E,A
E00B 16 00          	LD	D,0
E00D 3E CD          	LD	A,0CDH		;WR4 バースト ポートB開始アドレス(LH)
E00F ED 79          	OUT	(C),A
E011 ED 69          	OUT	(C),L		;SOURCE
E013 ED 61          	OUT	(C),H
E015 19             	ADD	HL,DE
E016 3E 1D          	LD	A,01DH		;WR0 ポートA開始アドレス(LH) ポートA→ポートB 転送
E018 ED 79          	OUT	(C),A
E01A ED 69          	OUT	(C),L		;DEST
E01C ED 61          	OUT	(C),H
E01E                GO_DMA:
E01E 3E CF          	LD	A,0CFH
E020 ED 79          	OUT	(C),A		;WR6 ロード
E022 3E B3          	LD	A,0B3H
E024 ED 79          	OUT	(C),A		;WR6 強制RDY
E026 ED 49          	OUT	(C),C		;WR6 イネーブル
E028 C9             	RET
E029                
E029                SCRCL:
E029 44             	LD	B,H
E02A 4D             	LD	C,L
E02B 2A B1 EF       	LD	HL,(CRTCD+1)
E02E CD 91 DE       	CALL	LINECL
E031 D1             	POP	DE
E032 C1             	POP	BC
E033 C9             	RET
E034                
E034                SCRN:
E034 D5             	PUSH	DE
E035 ED 58          	IN	E,(C)		;Text
E037 CB D8          	SET	3,B
E039 ED 50          	IN	D,(C)		;Kanji
E03B 28 19          	JR	Z,SCRNE
E03D AF             	XOR	A
E03E C5             	PUSH	BC
E03F 01 37 30       	LD	BC,03037H	;VRMJIS
E042 DF             	RST	018H
E043 01 52 2F       	LD	BC,02F52H	;JISSFT
E046 DF             	RST	018H
E047 C1             	POP	BC
E048 ED 78          	IN	A,(C)
E04A CB 98          	RES	3,B
E04C E6 40          	AND	040H
E04E 20 03          	JR	NZ,SCRN1
E050 7A             	LD	A,D
E051 D1             	POP	DE
E052 C9             	RET
E053                SCRN1:
E053 7B             	LD	A,E
E054 D1             	POP	DE
E055 C9             	RET
E056                
E056                SCRNE:
E056 D1             	POP	DE
E057 CB 98          	RES	3,B
E059                SCRNX:
E059 ED 78          	IN	A,(C)
E05B C9             	RET
E05C                
E05C                POS:
E05C 2A 8E EF       	LD	HL,(_TXADR)
E05F C5             	PUSH	BC
E060 ED 4B BC EF    	LD	BC,(CRTCD+12)
E064 AF             	XOR	A
E065                POS1:
E065 09             	ADD	HL,BC
E066 3C             	INC	A
E067 38 FC          	JR	C,POS1
E069 ED 42          	SBC	HL,BC
E06B 3D             	DEC	A
E06C 67             	LD	H,A
E06D C1             	POP	BC
E06E A7             	AND	A
E06F C9             	RET
E070                
E070                GETL:
E070 CD D3 EF       	CALL	_POS
E073 E5             	PUSH	HL
E074 3E CD          	LD	A,0CDH		;CALL ????
E076 32 80 DD       	LD	(INSFLG),A
E079                GETL1:
E079 CD 39 DC       	CALL	_SYS08
E07C FE 09          	CP	9
E07E 20 08          	JR	NZ,GETL1V
E080 21 00 FF       	LD	HL,KBUF
E083 CD 6E D8       	CALL	MSX
E086 18 F1          	JR	GETL1
E088                GETL1V:
E088 5F             	LD	E,A
E089 CD CD EF       	CALL	_PRINT
E08C                
E08C 7B             	LD	A,E
E08D FE 0D          	CP	00DH
E08F 20 E8          	JR	NZ,GETL1
E091 3E 01          	LD	A,1		;LD BC,????
E093 32 80 DD       	LD	(INSFLG),A
E096 11 00 FF       	LD	DE,KBUF
E099 3A B1 EF       	LD	A,(CRTCD+1)
E09C 47             	LD	B,A
E09D CD 05 D5       	CALL	ZERO_MEMORY_DE
E0A0                
E0A0 D1             	POP	DE
E0A1 CD D3 EF       	CALL	_POS
E0A4 6B             	LD	L,E
E0A5 3A B1 EF       	LD	A,(CRTCD+1)
E0A8 95             	SUB	L
E0A9 57             	LD	D,A
E0AA CD D3 DE       	CALL	LOC1
E0AD 4D             	LD	C,L
E0AE 7C             	LD	A,H
E0AF F6 30          	OR	030H
E0B1 47             	LD	B,A
E0B2 5A             	LD	E,D
E0B3 21 00 FF       	LD	HL,KBUF
E0B6                GETL2:
E0B6 CD D0 EF       	CALL	_SCRN
E0B9 03             	INC	BC
E0BA 77             	LD	(HL),A
E0BB 23             	INC	HL
E0BC 1D             	DEC	E
E0BD 20 F7          	JR	NZ,GETL2
E0BF                GETL3:
E0BF 2B             	DEC	HL
E0C0 7E             	LD	A,(HL)
E0C1 FE 21          	CP	021H
E0C3 D0             	RET	NC
E0C4 36 00          	LD	(HL),0
E0C6 15             	DEC	D
E0C7 20 F6          	JR	NZ,GETL3
E0C9 C9             	RET
E0CA                
E0CA                INKEY:
E0CA FB             	EI
E0CB E5             	PUSH	HL
E0CC 2A 90 EF       	LD	HL,(_KEYPS)
E0CF 7C             	LD	A,H
E0D0 AD             	XOR	L
E0D1 28 09          	JR	Z,INKEY1
E0D3 7C             	LD	A,H
E0D4 3C             	INC	A
E0D5 32 91 EF       	LD	(_KEYPS+1),A
E0D8 6F             	LD	L,A
E0D9 26 FE          	LD	H,KEYBF/256
E0DB 7E             	LD	A,(HL)
E0DC                INKEY1:
E0DC E1             	POP	HL
E0DD B7             	OR	A
E0DE C9             	RET
E0DF                
E0DF 00 00 10 BA    AT_RS	EQU	SCR1-AT_SCR1
E0DF                	INCLUDE	"LDFILE.ASM"
E0DF                
E0DF                ;	LSX-Dodgers FILE
E0DF                
E0DF                FILEC:
E0DF CD EA E0       	CALL	FILE
E0E2                FILEC2:
E0E2 3A 15 EF       	LD	A,(FDRV+1)
E0E5 FE 20          	CP	020H
E0E7 C8             	RET	Z
E0E8 18 39          	JR	SETDIR1
E0EA                
E0EA                FILE:
E0EA AF             	XOR	A
E0EB 32 14 EF       	LD	(FDRV),A
E0EE 67             	LD	H,A
E0EF 6F             	LD	L,A
E0F0 22 22 EF       	LD	(FDRV+14),HL
E0F3 CD C1 E1       	CALL	SPCUT
E0F6 CD A6 E1       	CALL	CCHK3
E0F9 28 12          	JR	Z,DEVI1
E0FB 13             	INC	DE
E0FC 1A             	LD	A,(DE)
E0FD 1B             	DEC	DE
E0FE FE 3A          	CP	':'
E100 20 0B          	JR	NZ,DEVI1
E102 1A             	LD	A,(DE)		;DRIVE
E103 CD F6 E3       	CALL	CAP
E106 D6 40          	SUB	'@'
E108 13             	INC	DE
E109 13             	INC	DE
E10A 32 14 EF       	LD	(FDRV),A
E10D                DEVI1:
E10D 1A             	LD	A,(DE)
E10E D6 5C          	SUB	05CH		;\
E110 20 09          	JR	NZ,NOROOT
E112 6F             	LD	L,A		;A=0でH=0のはずなのでHL=0
E113 22 2E EF       	LD	(FDRV+26),HL
E116 2C             	INC	L
E117 22 22 EF       	LD	(FDRV+14),HL
E11A 13             	INC	DE
E11B                NOROOT:
E11B                
E11B                SETDIR:
E11B CD 47 E1       	CALL	FILED
E11E 1A             	LD	A,(DE)
E11F FE 5C          	CP	05CH		;\
E121 C0             	RET	NZ
E122 13             	INC	DE
E123                SETDIR1:
E123 3E 10          	LD	A,010H		;Directory
E125 32 21 EF       	LD	(FDRV+13),A
E128 D5             	PUSH	DE
E129 11 14 EF       	LD	DE,FDRV
E12C 2A 1E F0       	LD	HL,(STABLE+2*00FH)
E12F CD 0F 00       	CALL	JP_HL
E132 D1             	POP	DE
E133 B7             	OR	A
E134 C0             	RET	NZ
E135                
E135 3A 21 EF       	LD	A,(FDRV+13)
E138 CB 67          	BIT	4,A
E13A C8             	RET	Z
E13B                
E13B CD 8E E1       	CALL	FILEI
E13E 2A 2E EF       	LD	HL,(FDRV+26)
E141 23             	INC	HL
E142 22 22 EF       	LD	(FDRV+14),HL
E145 18 D4          	JR	SETDIR
E147                
E147                FILED:
E147 CD 8E E1       	CALL	FILEI
E14A 21 15 EF       	LD	HL,FNAME
E14D                
E14D 06 08          	LD	B,8
E14F                FILE2:
E14F CD 9B E1       	CALL	CCHKF
E152 C8             	RET	Z
E153 FE 2A          	CP	'*'
E155 28 2E          	JR	Z,FILE9
E157 FE 2E          	CP	'.'
E159 28 0C          	JR	Z,FILE4
E15B 77             	LD	(HL),A
E15C 23             	INC	HL
E15D 10 F0          	DJNZ	FILE2
E15F                
E15F                FILE3:
E15F CD 9B E1       	CALL	CCHKF
E162 C8             	RET	Z
E163 FE 2E          	CP	'.'
E165 20 F8          	JR	NZ,FILE3
E167                
E167                FILE4:
E167 21 1D EF       	LD	HL,FNAME+8
E16A 06 03          	LD	B,3
E16C                
E16C                FILE4L:
E16C CD 9B E1       	CALL	CCHKF
E16F C8             	RET	Z
E170 FE 2E          	CP	'.'
E172 20 08          	JR	NZ,FILE12
E174 32 15 EF       	LD	(FNAME),A	;Parent directory(..)
E177 32 16 EF       	LD	(FNAME+1),A
E17A 3E 20          	LD	A,020H
E17C                FILE12:
E17C FE 2A          	CP	'*'
E17E 28 0A          	JR	Z,FILE10
E180 77             	LD	(HL),A
E181 23             	INC	HL
E182 10 E8          	DJNZ	FILE4L
E184 C9             	RET
E185                
E185                FILE9:				;名前の*処理、名前の残りを?で埋める
E185 CD 8A E1       	CALL	FILE10
E188 18 D5          	JR	FILE3
E18A                
E18A                FILE10:
E18A 3E 3F          	LD	A,'?'
E18C 18 08          	JR	FILL_MEMORY
E18E                FILEI:				;名前＋拡張子をスペースで初期化
E18E 3E 20          	LD	A,020H
E190 01 00 0B       	LD	BC,11*256	;C=0にしておく
E193 21 15 EF       	LD	HL,FNAME
E196                FILL_MEMORY:			;HLからBバイトAで埋める
E196 77             	LD	(HL),A
E197 23             	INC	HL
E198 10 FC          	DJNZ	FILL_MEMORY
E19A C9             	RET
E19B                
E19B                CCHKF:
E19B 1A             	LD	A,(DE)
E19C CD A3 E1       	CALL	CCHK2
E19F C8             	RET	Z
E1A0 C3 0E E5       	JP	FKAN
E1A3                
E1A3                CCHK2:
E1A3 0C             	INC	C
E1A4 0D             	DEC	C
E1A5 C0             	RET	NZ
E1A6                CCHK3:				;ZF=1 で使えない文字
E1A6 FE 2B          	CP	'+'
E1A8 C8             	RET	Z
E1A9 FE 2C          	CP	','
E1AB C8             	RET	Z
E1AC FE 2F          	CP	'/'
E1AE C8             	RET	Z
E1AF FE 3A          	CP	':'
E1B1 C8             	RET	Z
E1B2 FE 3B          	CP	';'
E1B4 C8             	RET	Z
E1B5 FE 3D          	CP	'='
E1B7 C8             	RET	Z
E1B8 FE 5C          	CP	05CH	;\
E1BA C8             	RET	Z
E1BB FE 20          	CP	020H
E1BD D0             	RET	NC
E1BE BF             	CP	A		;Z=1
E1BF C9             	RET
E1C0                
E1C0                SS1:
E1C0 13             	INC	DE
E1C1                SPCUT:				;スペースをカット
E1C1 1A             	LD	A,(DE)
E1C2 FE 20          	CP	020H
E1C4 28 FA          	JR	Z,SS1
E1C6 C9             	RET
E1C7                
E1C7                SETDRVF:
E1C7 11 14 EF       	LD	DE,FDRV
E1CA                SETDRV0:
E1CA CD D3 E1       	CALL	SETDRV
E1CD FD E1          	POP	IY
E1CF C1             	POP	BC
E1D0 D1             	POP	DE
E1D1 E1             	POP	HL
E1D2 C9             	RET
E1D3                
E1D3                SETDRV:
E1D3 E3             	EX	(SP),HL		;HL=RETRN ADDRESS
E1D4 D5             	PUSH	DE		;PUSH HL/DE/BC/IY
E1D5 C5             	PUSH	BC
E1D6 1A             	LD	A,(DE)
E1D7 D5             	PUSH	DE
E1D8 FD E3          	EX	(SP),IY
E1DA                
E1DA CD E6 E1       	CALL	GETDRV
E1DD 3C             	INC	A
E1DE FD 77 00       	LD	(IY+0),A	;(FCB)ドライブ番号
E1E1 3D             	DEC	A
E1E2 CD D9 EF       	CALL	_CHGDRV
E1E5                
E1E5 E9             	JP	(HL)
E1E6                
E1E6                GETDRV:
E1E6 E6 7F          	AND	07FH
E1E8 D6 01          	SUB	001H
E1EA 30 03          	JR	NC,GETDRV1
E1EC 3A 87 EF       	LD	A,(_DVSW)	;Current Drive
E1EF                GETDRV1:
E1EF 32 88 EF       	LD	(_DRV),A
E1F2 C9             	RET
E1F3                
E1F3                SOPENX:
E1F3 11 39 EF       	LD	DE,SFILE
E1F6 1A             	LD	A,(DE)
E1F7 FD BE 00       	CP	(IY+0)		;(FCB)ドライブ番号
E1FA 20 24          	JR	NZ,SOPEN
E1FC 13             	INC	DE
E1FD FD E5          	PUSH	IY
E1FF E1             	POP	HL
E200 23             	INC	HL
E201 CD 8E E3       	CALL	CPFILE
E204 20 1A          	JR	NZ,SOPEN
E206                
E206 2A F4 F0       	LD	HL,(SCDIR)
E209 FD 75 0E       	LD	(IY+14),L	;(FCB)アクセスするディレクトリのクラスタ番号+1
E20C FD 74 0F       	LD	(IY+15),H
E20F                
E20F 2A F8 F0       	LD	HL,(SFNDF)	;Direcroty location and Flags
E212 22 9F EF       	LD	(_FILEN),HL
E215                
E215 ED 5B F6 F0    	LD	DE,(SFBPS)
E219 21 39 EF       	LD	HL,SFILE
E21C 36 FF          	LD	(HL),0FFH
E21E 23             	INC	HL
E21F C9             	RET
E220                SOPEN:
E220 21 36 E3       	LD	HL,FILESE
E223                SOPENC:
E223 22 5C E2       	LD	(OPENPAT+1),HL
E226                
E226 CD E2 EF       	CALL	_RDFATX		;Detect Media
E229 38 56          	JR	C,RDDERR
E22B                
E22B AF             	XOR	A
E22C 32 9F EF       	LD	(_FILEN),A
E22F CD 3B E4       	CALL	LDDIRX1		;A=0で呼び出す
E232 28 18          	JR	Z,SDIRX1
E234                
E234 CD 27 E3       	CALL	READ_DIR	;Sub Directory
E237 38 08          	JR	C,SDIRX0
E239 2A 7E F0       	LD	HL,(_DTBUF)
E23C 7E             	LD	A,(HL)
E23D FE 2E          	CP	'.'
E23F 28 0F          	JR	Z,SOPEN1
E241                SDIRX0:
E241 AF             	XOR	A
E242 32 A0 EF       	LD	(_DIRF),A
E245 FD 36 0E 01    	LD	(IY+14),1	;(FCB)レコードサイズ
E249 FD 77 0F       	LD	(IY+15),A
E24C                SDIRX1:
E24C ED 5B FC F0    	LD	DE,(_DIRPS)	;Root Directory
E250                SOPEN1:
E250 0E 20          SDECPAT:LD	C,32		;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
E252                SOPEN1X:
E252 CD 27 E3       	CALL	READ_DIR	;FILE SEARCH
E255 38 2A          	JR	C,RDDERR
E257 2A 7E F0       	LD	HL,(_DTBUF)
E25A                SOPEN2:
E25A D5             	PUSH	DE
E25B CD 36 E3       OPENPAT:CALL	FILESE		;(self-modifying code)
E25E D1             	POP	DE
E25F 38 6E          	JR	C,SOPENE
E261 28 1B          	JR	Z,SCF_FF_RET
E263                SOPEN3:
E263 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E266 B7             	OR	A
E267 20 0C          	JR	NZ,SOPEN5
E269 13             	INC	DE		;ルートディレクトリ
E26A E5             	PUSH	HL
E26B 21 0C 00       MD_PAT:	LD	HL,12		;(self-modifying code)MAXDIR
E26E ED 52          	SBC	HL,DE		;CF=0 なので SUB HL,DE
E270 E1             	POP	HL
E271 20 DD          	JR	NZ,SOPEN1
E273 18 07          	JR	SOPEN6
E275                SOPEN5:
E275 CD 86 EA       	CALL	GNCLX		;END DIR
E278 D8             	RET	C
E279 CD EE E3       	CALL	ENDCL
E27C                SOPEN6:
E27C 38 D2          	JR	C,SOPEN1
E27E                SCF_FF_RET:
E27E 37             	SCF			;CF=1
E27F 9F             	SBC	A,A		;A=0FFH
E280 C9             	RET
E281                
E281                RDDERR:
E281 BF             	CP	A		;READ ERR CF=1 ZF=1
E282 37             	SCF
E283 C9             	RET
E284                
E284                NOPEN:
E284 21 36 E3       	LD	HL,FILESE
E287 22 5C E2       	LD	(OPENPAT+1),HL
E28A FD 2A 98 EF    	LD	IY,(_FCB)
E28E CD 21 E5       	CALL	CHKWILDX
E291 30 EB          	JR	NC,SCF_FF_RET
E293 FD 7E 00       	LD	A,(IY+0)	;(FCB)ドライブ番号
E296 3D             	DEC	A
E297 32 88 EF       	LD	(_DRV),A
E29A CD D9 EF       	CALL	_CHGDRV
E29D D8             	RET	C
E29E 2A F8 F0       	LD	HL,(SFNDF)	;Direcroty location and Flags
E2A1 22 9F EF       	LD	(_FILEN),HL
E2A4                
E2A4 CD 36 E4       	CALL	LDDIRX
E2A7 ED 5B 9A EF    	LD	DE,(_FBPS)
E2AB CD 27 E3       	CALL	READ_DIR
E2AE 38 D1          	JR	C,RDDERR
E2B0 3A 9E EF       	LD	A,(_FBCNT)
E2B3 3D             	DEC	A
E2B4 28 AD          	JR	Z,SOPEN3
E2B6                NOPEN2:
E2B6 2A 9C EF       	LD	HL,(_FBAD)
E2B9 01 20 00       	LD	BC,020H
E2BC 09             	ADD	HL,BC
E2BD 4F             	LD	C,A
E2BE 18 9A          	JR	SOPEN2
E2C0                
E2C0                SOPENE2:
E2C0 22 9C EF       	LD	(_FBAD),HL
E2C3 79             	LD	A,C
E2C4 32 9E EF       	LD	(_FBCNT),A
E2C7 ED 53 9A EF    	LD	(_FBPS),DE
E2CB FD 22 98 EF    	LD	(_FCB),IY
E2CF                SOPENE:
E2CF AF             	XOR	A
E2D0 C9             	RET
E2D1                
E2D1                COPEN:
E2D1 FD 36 0D 20    	LD	(IY+13),020H	;(FCB)属性(アトリビュート)
E2D5                
E2D5 21 53 E3       	LD	HL,NEXTSE
E2D8 CD 23 E2       	CALL	SOPENC
E2DB D0             	RET	NC
E2DC C8             	RET	Z
E2DD 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E2E0 B7             	OR	A
E2E1 37             	SCF
E2E2 C8             	RET	Z		;ルートディレクトリ
E2E3 06 01          	LD	B,1
E2E5 CD 7D E5       	CALL	WRDF
E2E8 D8             	RET	C
E2E9 ED 5B FE F0    	LD	DE,(_CLPS)
E2ED D5             	PUSH	DE
E2EE CD B7 E3       	CALL	DCPAT
E2F1 CD 11 E9       	CALL	DRDNX
E2F4 2A 7E F0       	LD	HL,(_DTBUF)	;ディレクトリエントリを0クリア
E2F7 3A 8C E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E2FA 47             	LD	B,A
E2FB AF             	XOR	A
E2FC 4F             	LD	C,A
E2FD                COPENCL:
E2FD 77             	LD	(HL),A
E2FE ED A1          	CPI			;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
E300 EA FD E2       	JP	PE,COPENCL
E303                
E303 3A D5 E3       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ数
E306 3D             	DEC	A
E307 28 19          	JR	Z,COPENE
E309 3E 01          	LD	A,1		;1セクタ辺りのセクタ数が2以上の場合
E30B 32 7E EA       	LD	(_SECPS+1),A
E30E D1             	POP	DE		;DE=(_CLPS)
E30F D5             	PUSH	DE
E310                COPEN1:
E310 D5             	PUSH	DE		;データバッファに入らないセクタもゼロクリア
E311 C5             	PUSH	BC
E312 2A 7E F0       	LD	HL,(_DTBUF)
E315 CD D1 E3       	CALL	CLUSTX
E318 CD EA EB       	CALL	DWT24
E31B C1             	POP	BC
E31C D1             	POP	DE
E31D CD 7D EA       	CALL	NEXTX
E320 20 EE          	JR	NZ,COPEN1
E322                COPENE:
E322 2A 7E F0       	LD	HL,(_DTBUF)
E325 D1             	POP	DE
E326 C9             	RET
E327                
E327                READ_DIR:
E327 ED 53 FE F0    	LD	(_CLPS),DE
E32B C5             	PUSH	BC
E32C D5             	PUSH	DE
E32D CD B7 E3       	CALL	DCPAT
E330 CD F1 E8       	CALL	DRDX
E333 D1             	POP	DE
E334 C1             	POP	BC
E335 C9             	RET
E336                
E336                FILESE:
E336 7E             	LD	A,(HL)
E337 B7             	OR	A
E338 C8             	RET	Z		;END:ZF=1 CF=0
E339 FE E5          	CP	0E5H
E33B 28 0E          	JR	Z,FILESE1
E33D FD E5          	PUSH	IY
E33F D1             	POP	DE
E340 13             	INC	DE
E341 E5             	PUSH	HL
E342 CD 8E E3       	CALL	CPFILE
E345 CC AF E3       	CALL	Z,CPFILE2
E348 E1             	POP	HL
E349 37             	SCF
E34A C8             	RET	Z		;!!!:(ZF=1) CF=1
E34B                FILESE1:
E34B CD 62 E3       	CALL	FNEXT
E34E 20 E6          	JR	NZ,FILESE
E350                ZF0_CF0_AFF_RET:
E350 F6 FF          	OR	0FFH		;ZF=0 CF=0
E352 C9             	RET
E353                
E353                NEXTSE:
E353 7E             	LD	A,(HL)
E354 B7             	OR	A
E355 37             	SCF
E356 C8             	RET	Z		;!!!:ZF=1 CF=1
E357 FE E5          	CP	0E5H
E359 37             	SCF
E35A C8             	RET	Z		;!!!:(ZF=1) CF=1
E35B CD 62 E3       	CALL	FNEXT
E35E 20 F3          	JR	NZ,NEXTSE
E360 18 EE          	JR	ZF0_CF0_AFF_RET
E362                
E362                FNEXT:
E362 E5             	PUSH	HL
E363 21 9F EF       	LD	HL,_FILEN
E366 34             	INC	(HL)
E367 E1             	POP	HL
E368 11 20 00       	LD	DE,020H
E36B 19             	ADD	HL,DE
E36C 0D             	DEC	C
E36D C9             	RET
E36E                
E36E                CPNAME:
E36E C5             	PUSH	BC
E36F D5             	PUSH	DE
E370 E5             	PUSH	HL
E371 CD 88 E3       	CALL	CPFILE4
E374 E1             	POP	HL
E375 23             	INC	HL
E376 23             	INC	HL
E377 23             	INC	HL
E378 23             	INC	HL
E379 D1             	POP	DE
E37A C1             	POP	BC
E37B 20 05          	JR	NZ,CPNAME1
E37D 7E             	LD	A,(HL)
E37E 23             	INC	HL
E37F 66             	LD	H,(HL)
E380 6F             	LD	L,A
E381 C9             	RET
E382                CPNAME1:
E382 23             	INC	HL
E383 23             	INC	HL
E384 10 E8          	DJNZ	CPNAME
E386 37             	SCF
E387 C9             	RET
E388                
E388                CPFILE4:
E388 C5             	PUSH	BC
E389 01 00 04       	LD	BC,00400H
E38C 18 04          	JR	CPSTR1
E38E                CPFILE:
E38E C5             	PUSH	BC
E38F 01 00 0B       	LD	BC,00B00H
E392                CPSTR1:
E392 1A             	LD	A,(DE)
E393 FE 3F          	CP	'?'		;Wild card
E395 28 12          	JR	Z,CPSTR2
E397 7E             	LD	A,(HL)
E398 CD 07 E5       	CALL	FKANC
E39B E5             	PUSH	HL
E39C 67             	LD	H,A
E39D 1A             	LD	A,(DE)
E39E CB 01          	RLC	C
E3A0 CD 07 E5       	CALL	FKANC
E3A3 CB 09          	RRC	C
E3A5 BC             	CP	H		;CP (HL),(DE)
E3A6 E1             	POP	HL
E3A7 20 04          	JR	NZ,CPSTR3
E3A9                CPSTR2:
E3A9 13             	INC	DE
E3AA 23             	INC	HL
E3AB 10 E5          	DJNZ	CPSTR1
E3AD                CPSTR3:
E3AD C1             	POP	BC
E3AE C9             	RET
E3AF                
E3AF                CPFILE2:
E3AF FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E3B2 F6 E1          	OR	0E1H
E3B4 2F             	CPL
E3B5 A6             	AND	(HL)
E3B6 C9             	RET
E3B7                
E3B7                DCPAT:
E3B7 0E 00          	LD	C,0
E3B9 2A 7E F0       	LD	HL,(_DTBUF)
E3BC 3A A0 EF       	LD	A,(_DIRF)	;ディレクトリか判別
E3BF B7             	OR	A
E3C0 C8             	RET	Z		;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
E3C1 3A D5 E3       	LD	A,(SPCPAT+1)
E3C4 4F             	LD	C,A
E3C5 3A 7E EA       	LD	A,(_SECPS+1)
E3C8 B9             	CP	C
E3C9 38 01          	JR	C,DC1
E3CB AF             	XOR	A
E3CC                DC1:
E3CC F6 80          	OR	080H
E3CE 32 A0 EF       	LD	(_DIRF),A	;bit0-6:セクタインデックス
E3D1                CLUSTX:
E3D1 E5             	PUSH	HL
E3D2 EB             	EX	DE,HL
E3D3 AF             	XOR	A
E3D4 0E 01          SPCPAT:	LD	C,1		;自己書き換え（1クラスタの論理セクタ数）
E3D6                L_CLDBL:
E3D6 CB 19          	RR	C		;->CF
E3D8 38 04          	JR	C,E_CLDBL
E3DA 29             	ADD	HL,HL		;*2
E3DB 8F             	ADC	A,A
E3DC 18 F8          	JR	L_CLDBL
E3DE                E_CLDBL:
E3DE 4F             	LD	C,A
E3DF 3A 7E EA       	LD	A,(_SECPS+1)
E3E2 B5             	OR	L
E3E3 6F             	LD	L,A
E3E4 11 08 00       CLSPAT:	LD	DE,8	;+8 (2D)  !ADDCL (self-modifying code)
E3E7 AF             	XOR	A
E3E8 19             	ADD	HL,DE	;データ格納領域の先頭論理セクタ番号
E3E9 89             	ADC	A,C
E3EA 4F             	LD	C,A
E3EB EB             	EX	DE,HL
E3EC E1             	POP	HL
E3ED C9             	RET
E3EE                
E3EE                ENDCL:
E3EE 7A             	LD	A,D	;END CLUSTER
E3EF FE 01          CLPAT1:	CP	1	;164=356	(self-modifying code)
E3F1 C0             	RET	NZ
E3F2 7B             	LD	A,E
E3F3 FE 64          CLPAT2:	CP	064H	;		(self-modifying code)
E3F5 C9             	RET
E3F6                
E3F6                CAP:
E3F6 FE 61          	CP	'a'
E3F8 D8             	RET	C
E3F9 FE 7B          	CP	'z'+1
E3FB D0             	RET	NC
E3FC D6 20          	SUB	020H
E3FE C9             	RET
E3FF                CAP2:
E3FF CD F6 E3       	CALL	CAP
E402                CAP3:
E402 CD 0B E4       	CALL	CAP4
E405 FE 21          	CP	021H
E407 D0             	RET	NC
E408 3E A0          	LD	A,0A0H
E40A C9             	RET
E40B                CAP4:
E40B FE 05          	CP	5
E40D C0             	RET	NZ
E40E 3E E5          	LD	A,0E5H
E410 C9             	RET
E411                
E411                CHDIR:
E411 CD 21 ED       	CALL	GETDPBD
E414 38 1D          	JR	C,CHDIR2
E416 DD 75 1A       	LD	(IX+01AH),L		;_SDIR_
E419 DD 74 1B       	LD	(IX+01BH),H		;_SDIR_+1
E41C 18 15          	JR	CHDIR2		;POP_IX_RET
E41E                
E41E                LDDIR:
E41E CD 21 ED       	CALL	GETDPBD
E421 DD 5E 1A       	LD	E,(IX+01AH)		;_SDIR_
E424 DD 56 1B       	LD	D,(IX+01BH)		;_SDIR_+1
E427 13             	INC	DE
E428 FD 73 0E       	LD	(IY+14),E	;(FCB)アクセスするディレクトリのクラスタ番号+1
E42B FD 72 0F       	LD	(IY+15),D
E42E 1B             	DEC	DE
E42F AF             	XOR	A
E430 32 A0 EF       	LD	(_DIRF),A
E433                CHDIR2:
E433 DD E1          	POP	IX
E435 C9             	RET
E436                
E436                LDDIRX:
E436 3A A0 EF       	LD	A,(_DIRF)	;(FCB)アクセスするディレクトリのセクタインデックス
E439 E6 7F          	AND	07FH
E43B                LDDIRX1:
E43B 32 7E EA       	LD	(_SECPS+1),A
E43E FD 5E 0E       	LD	E,(IY+14)	;(FCB)アクセスするディレクトリのクラスタ番号+1
E441 FD 56 0F       	LD	D,(IY+15)
E444 1B             	DEC	DE
E445 CD EE E3       	CALL	ENDCL
E448 D4 1E E4       	CALL	NC,LDDIR
E44B                LDDIRS:
E44B 7A             	LD	A,D
E44C B3             	OR	E
E44D 32 A0 EF       	LD	(_DIRF),A	;ディレクトリか判別
E450 C9             	RET
E451                
E451                KILL:
E451 CD 21 E5       	CALL	CHKWILDX
E454 38 34          	JR	C,KILLW
E456 CD F3 E1       	CALL	SOPENX
E459                KILLS:
E459 3E 1F          	LD	A,01FH
E45B D4 9D E4       	CALL	NC,CHKATT
E45E D8             	RET	C
E45F                KILLSX:
E45F 36 E5          	LD	(HL),0E5H	;DIR
E461 CD FB E4       	CALL	WTDB
E464 11 1A 00       	LD	DE,01AH
E467 19             	ADD	HL,DE
E468 5E             	LD	E,(HL)
E469 23             	INC	HL
E46A 56             	LD	D,(HL)
E46B                KILLS1:
E46B CD EE E3       	CALL	ENDCL
E46E D0             	RET	NC		;CF=0
E46F 21 FE FF       	LD	HL,0-2
E472 19             	ADD	HL,DE
E473 D0             	RET	NC		;DE= 0 or 1
E474 D5             	PUSH	DE
E475 CD F7 EF       	CALL	_GNCL
E478 ED 53 FE F0    	LD	(_CLPS),DE
E47C D1             	POP	DE
E47D 21 00 00       	LD	HL,0
E480 D4 FA EF       	CALL	NC,_SNCL
E483 D8             	RET	C
E484 ED 5B FE F0    	LD	DE,(_CLPS)	;FAT
E488 18 E1          	JR	KILLS1
E48A                
E48A                KILLW:
E48A CD 20 E2       	CALL	SOPEN
E48D                KILLW1:
E48D 38 0B          	JR	C,KILLW2
E48F CD C0 E2       	CALL	SOPENE2
E492 CD 59 E4       	CALL	KILLS
E495 CD 84 E2       	CALL	NOPEN
E498 18 F3          	JR	KILLW1
E49A                KILLW2:
E49A C8             	RET	Z
E49B 3F             	CCF
E49C C9             	RET
E49D                
E49D                CHKATT:
E49D E5             	PUSH	HL
E49E 11 0B 00       	LD	DE,00BH
E4A1 19             	ADD	HL,DE
E4A2 A6             	AND	(HL)
E4A3 E1             	POP	HL
E4A4 C8             	RET	Z
E4A5 37             	SCF
E4A6 C9             	RET
E4A7                
E4A7                NAME:
E4A7 CD 21 E5       	CALL	CHKWILDX
E4AA D8             	RET	C
E4AB 11 04 00       	LD	DE,4
E4AE 19             	ADD	HL,DE
E4AF 22 C7 E4       	LD	(NAMEP+2),HL
E4B2 23             	INC	HL
E4B3 CD 25 E5       	CALL	CHKWILD
E4B6 D8             	RET	C
E4B7                
E4B7 CD F3 E1       	CALL	SOPENX
E4BA 3E 0F          	LD	A,00FH
E4BC D4 9D E4       	CALL	NC,CHKATT
E4BF D8             	RET	C
E4C0                
E4C0 FD 7E 00       	LD	A,(IY+0)
E4C3 FD E5          	PUSH	IY
E4C5 FD 21 00 00    NAMEP:	LD	IY,0		;自己書き換え
E4C9 FD 77 00       	LD	(IY+0),A
E4CC CD F3 E1       	CALL	SOPENX
E4CF FD E3          	EX	(SP),IY
E4D1 3F             	CCF
E4D2 D4 20 E2       	CALL	NC,SOPEN
E4D5 EB             	EX	DE,HL
E4D6 E1             	POP	HL
E4D7 D8             	RET	C
E4D8                
E4D8                SETNAME:
E4D8 01 00 0B       	LD	BC,11*256
E4DB 23             	INC	HL
E4DC 7E             	LD	A,(HL)
E4DD FE E5          	CP	0E5H
E4DF 20 04          	JR	NZ,SNAME1
E4E1 3E 05          	LD	A,5
E4E3 18 0E          	JR	SNAME3
E4E5                SNAME1:
E4E5 7E             	LD	A,(HL)
E4E6 0C             	INC	C
E4E7 0D             	DEC	C
E4E8 20 09          	JR	NZ,SNAME3
E4EA CD F6 E3       	CALL	CAP
E4ED FE A0          	CP	0A0H
E4EF 20 02          	JR	NZ,SNAME3
E4F1 3E 20          	LD	A,020H
E4F3                SNAME3:
E4F3 12             	LD	(DE),A
E4F4 7E             	LD	A,(HL)
E4F5 23             	INC	HL
E4F6 CD 0E E5       	CALL	FKAN
E4F9 10 EA          	DJNZ	SNAME1
E4FB                WTDB:
E4FB 3E FF          	LD	A,0FFH
E4FD 32 39 EF       	LD	(SFILE),A
E500                SWTDBF:
E500 3E 01          	LD	A,1
E502 32 A4 EF       	LD	(_WTDBF),A
E505 AF             	XOR	A
E506 C9             	RET
E507                
E507                FKANC:
E507 CB 41          	BIT	0,C
E509 CC FF E3       	CALL	Z,CAP2
E50C 18 01          	JR	FKANX
E50E                FKAN:			;漢字チェック
E50E 13             	INC	DE
E50F                FKANX:
E50F CB 41          	BIT	0,C
E511 CB 81          	RES	0,C
E513 C0             	RET	NZ
E514 FE 80          	CP	080H
E516 D8             	RET	C
E517 FE A0          	CP	0A0H
E519 38 03          	JR	C,FKAN1
E51B FE E0          	CP	0E0H
E51D D8             	RET	C
E51E                FKAN1:
E51E 0C             	INC	C
E51F A7             	AND	A
E520 C9             	RET
E521                
E521                CHKWILDX:
E521 FD E5          	PUSH	IY
E523 E1             	POP	HL
E524 23             	INC	HL
E525                CHKWILD:
E525 06 0B          	LD	B,11
E527 3E 3F          	LD	A,'?'
E529                CHKWIL1:
E529 BE             	CP	(HL)
E52A 23             	INC	HL
E52B 37             	SCF
E52C C8             	RET	Z
E52D 10 FA          	DJNZ	CHKWIL1
E52F AF             	XOR	A
E530 C9             	RET
E531                
E531                SDIRENT:		;IY=FCB HL=DIR
E531 D5             	PUSH	DE
E532 E5             	PUSH	HL
E533 FD E5          	PUSH	IY
E535 D1             	POP	DE
E536 EB             	EX	DE,HL
E537 CD D8 E4       	CALL	SETNAME
E53A                ;				Attribute
E53A FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E53D 12             	LD	(DE),A
E53E 13             	INC	DE
E53F                ;				Reserved
E53F AF             	XOR	A
E540 06 0A          	LD	B,10
E542                SDE1:
E542 12             	LD	(DE),A
E543 13             	INC	DE
E544 10 FC          	DJNZ	SDE1
E546                					;(FCB)更新時刻
E546 21 EA F0       	LD	HL,SDDATA		;(FCB)更新年月日
E549 06 0A          	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
E54B                SDLOOP:					;(FCB)ファイルのサイズ(バイト単位)
E54B 7E             	LD	A,(HL)
E54C 23             	INC	HL
E54D 32 52 E5       	LD	(SDPAT+2),A
E550 FD 7E 00       SDPAT:	LD	A,(IY+0)	;LD A,(IY+A)
E553 12             	LD	(DE),A
E554 13             	INC	DE
E555 10 F4          	DJNZ	SDLOOP
E557                
E557 AF             	XOR	A
E558 E1             	POP	HL
E559 D1             	POP	DE
E55A C9             	RET
E55B                
E55B                WOPEN:
E55B FD 7E 0D       	LD	A,(IY+13)	;(FCB)属性(アトリビュート)
E55E E6 1F          	AND	01FH
E560 37             	SCF
E561 C0             	RET	NZ
E562 FD 36 1C FE    	LD	(IY+28),0FEH	;(FCB)オープンモード
E566                TOPEN2:
E566 AF             	XOR	A
E567                TOPEN:				;Initializes the time stamp
E567 FD 36 17 FF    	LD	(IY+23),0FFH	;(FCB)更新時刻
E56B C9             	RET
E56C                
E56C                WRDFX:
E56C 3A D5 E3       	LD	A,(SPCPAT+1)	;1クラスタの論理セクタ
E56F                L_WRFX:
E56F 1F             	RRA		;->CF
E570 38 04          	JR	C,E_WRFX
E572 CB 39          	SRL	C	;C=C/2
E574 18 F9          	JR	L_WRFX
E576                E_WRFX:
E576 41             	LD	B,C
E577 04             	INC	B
E578 3E 37          	LD	A,037H		;SCF
E57A 32 0E E9       	LD	(DRDN1),A
E57D                
E57D                WRDF:				;Bクラスタ分FATを確保する
E57D 11 02 00       	LD	DE,2
E580 AF             	XOR	A
E581 32 7E EA       	LD	(_SECPS+1),A
E584                WRDF1:
E584 C5             	PUSH	BC
E585 D5             	PUSH	DE
E586 CD F7 EF       	CALL	_GNCL
E589 38 1C          	JR	C,WRDF3
E58B 7A             	LD	A,D		;空いているかチェック
E58C B3             	OR	E
E58D 20 27          	JR	NZ,WRDF4
E58F E1             	POP	HL		;HL=空いているクラスタ
E590 E5             	PUSH	HL
E591 ED 5B FE F0    	LD	DE,(_CLPS)	;DE=元の(_CLPS)
E595 22 FE F0       	LD	(_CLPS),HL
E598 7A             	LD	A,D		;元の(_CLPS)が 0 か?
E599 B3             	OR	E
E59A 20 08          	JR	NZ,WRDF2
E59C FD 75 1A       	LD	(IY+26),L	;(FCB)ファイルの先頭クラスタ
E59F FD 74 1B       	LD	(IY+27),H	;元が空の場合はFCBにクラスタをセットする
E5A2 18 03          	JR	WRDF3
E5A4                WRDF2:
E5A4 CD FA EF       	CALL	_SNCL
E5A7                WRDF3:
E5A7 D1             	POP	DE
E5A8 C1             	POP	BC
E5A9 D8             	RET	C
E5AA 10 0C          	DJNZ	WRDF5		;ここでループカウンタチェック
E5AC ED 5B FE F0    	LD	DE,(_CLPS)
E5B0 21 FF FF       	LD	HL,0FFFFH	;FATエントリ終了(EOCマーク)
E5B3 C3 FA EF       	JP	_SNCL
E5B6                
E5B6                WRDF4:				;DEクラスタが空じゃないので次に移動する
E5B6 D1             	POP	DE
E5B7 C1             	POP	BC
E5B8                WRDF5:
E5B8 13             	INC	DE
E5B9 CD EE E3       	CALL	ENDCL
E5BC 38 C6          	JR	C,WRDF1
E5BE 37             	SCF
E5BF C9             	RET
E5C0                
E5C0                RWXR:
E5C0 3A 8C E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E5C3                L_RWX:
E5C3 1F             	RRA		;->CF
E5C4 38 06          	JR	C,E_RWX
E5C6 CB 38          	SRL	B	;BC=BC/2
E5C8 CB 19          	RR	C	;
E5CA 18 F7          	JR	L_RWX
E5CC                E_RWX:
E5CC FD 5E 1A       	LD	E,(IY+26)	;(FCB)ファイルの先頭クラスタ
E5CF FD 56 1B       	LD	D,(IY+27)
E5D2 AF             	XOR	A
E5D3 32 7E EA       	LD	(_SECPS+1),A
E5D6                RWX1:
E5D6 ED 53 FE F0    	LD	(_CLPS),DE
E5DA 7A             	LD	A,D
E5DB B3             	OR	E
E5DC 28 0D          	JR	Z,SCF_RET	;RET DE==0 => CF=1
E5DE                
E5DE 78             	LD	A,B
E5DF B1             	OR	C
E5E0 C8             	RET	Z		;RET BC==0 => CF=0
E5E1                
E5E1 CD 86 EA       	CALL	GNCLX
E5E4 D8             	RET	C
E5E5 0B             	DEC	BC
E5E6                
E5E6 CD EE E3       	CALL	ENDCL
E5E9 38 EB          	JR	C,RWX1
E5EB                SCF_RET:
E5EB 37             	SCF
E5EC C9             	RET
E5ED                
E5ED                DSKF:
E5ED 11 00 00       MAXCLP:	LD	DE,0
E5F0 2A AC EF       	LD	HL,(_FAKEFREE)
E5F3 7C             	LD	A,H
E5F4 B5             	OR	L
E5F5 28 03          	JR	Z,DSKF1
E5F7 11 01 00       	LD	DE,1
E5FA                DSKF1:
E5FA D5             	PUSH	DE
E5FB CD F7 EF       	CALL	_GNCL
E5FE 38 0C          	JR	C,POPSCF
E600 7A             	LD	A,D
E601 B3             	OR	E
E602 20 01          	JR	NZ,DSKF2
E604 23             	INC	HL
E605                DSKF2:
E605 D1             	POP	DE
E606 1B             	DEC	DE
E607 7A             	LD	A,D
E608 B3             	OR	E
E609 20 EF          	JR	NZ,DSKF1
E60B C9             	RET
E60C                
E60C                POPSCF:
E60C F1             	POP	AF
E60D 37             	SCF
E60E C9             	RET
E60F                
E60F                SETTMS:
E60F FD 7E 17       	LD	A,(IY+23)	;(FCB)ファイルを最後に変更した時刻
E612 3C             	INC	A
E613 C0             	RET	NZ		;ファイルが更新されていない
E614                SETTMSX:			;FCBに日付時刻をセットする
E614 CD E8 DC       	CALL	_SYS2C		;(BDOS)時刻の獲得
E617                				;H←時  L←分  D←秒
E617 CB 25          	SLA	L		;   *2
E619 CB 25          	SLA	L		;   *4
E61B 29             	ADD	HL,HL		;*2 *8
E61C 29             	ADD	HL,HL		;*4 *16
E61D 29             	ADD	HL,HL		;*8 *32
E61E 7A             	LD	A,D
E61F 0F             	RRCA			;bit.0->7->->->0->C
E620 E6 1F          	AND	01FH
E622 B5             	OR	L
E623 FD 77 16       	LD	(IY+22),A	;(FCB)ファイルを最後に変更した時刻
E626 FD 74 17       	LD	(IY+23),H
E629                
E629 CD B4 DC       	CALL	_SYS2A		;(BDOS)日付の獲得
E62C                				;HL←年  D←月  E←日
E62C 01 44 F8       	LD	BC,0-1980
E62F 09             	ADD	HL,BC
E630 65             	LD	H,L
E631                
E631 7A             	LD	A,D
E632 87             	ADD	A,A		;*2
E633 87             	ADD	A,A		;*4
E634 87             	ADD	A,A		;*8
E635 87             	ADD	A,A		;*16
E636 6F             	LD	L,A
E637 29             	ADD	HL,HL		;*32
E638 7D             	LD	A,L
E639 B3             	OR	E
E63A FD 77 14       	LD	(IY+20),A	;(FCB)ファイルを最後に変更した日付
E63D FD 74 15       	LD	(IY+21),H
E640 C9             	RET
E641                
E641                PUSHRR:
E641 CD 47 E6       	CALL	SUBRR
E644                POPRR1:
E644 ED B0          	LDIR
E646 C9             	RET
E647                
E647                SUBRR:
E647 FD E5          	PUSH	IY
E649 E1             	POP	HL
E64A 11 21 00       	LD	DE,33
E64D 19             	ADD	HL,DE
E64E 11 5A EF       	LD	DE,HLBUF
E651 01 03 00       	LD	BC,3
E654 C9             	RET
E655                
E655                SETSEQ:
E655 F5             	PUSH	AF		;AHL=Random record
E656 FD 7E 21       	LD	A,(IY+33)	;(FCB)ランダムレコード
E659 FD 6E 22       	LD	L,(IY+34)
E65C FD 66 23       	LD	H,(IY+35)
E65F                
E65F CD 7B E6       	CALL	SSQ1
E662                
E662 29             	ADD	HL,HL
E663 CB 3D          	SRL	L		;L=L/2
E665 FD 75 20       	LD	(IY+32),L	;(FCB)カレントレコード
E668 FD 74 0C       	LD	(IY+12),H	;(FCB)カレントブロック
E66B F1             	POP	AF
E66C                
E66C                POPRR:
E66C CD 47 E6       	CALL	SUBRR
E66F EB             	EX	DE,HL
E670 18 D2          	JR	POPRR1
E672                
E672                GETSIZE:
E672 FD 7E 10       	LD	A,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
E675 FD 6E 11       	LD	L,(IY+17)
E678 FD 66 12       	LD	H,(IY+18)
E67B                SSQ1:				;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
E67B 87             	ADD	A,A		;in HLA => out HL
E67C ED 6A          	ADC	HL,HL
E67E B7             	OR	A
E67F C8             	RET	Z
E680 23             	INC	HL
E681 C9             	RET
E682                
E682                GETSEQ:
E682 FD 6E 20       	LD	L,(IY+32)	;(FCB)カレントレコード
E685 FD 66 0C       	LD	H,(IY+12)	;(FCB)カレントブロック
E688                
E688 CB 25          	SLA	L	;L=L*2
E68A                
E68A CB 3C          	SRL	H	;HL=HL/2
E68C CB 1D          	RR	L	;
E68E C9             	RET
E68F                
E68F                RB_WRITE:
E68F C5             	PUSH	BC
E690 ED 4B 4C F0    	LD	BC,(STABLE+2*026H)	;(BDOS)ランダムブロック書き込み
E694 18 05          	JR	RBRW
E696                RB_READ:
E696 C5             	PUSH	BC
E697 ED 4B 4E F0    	LD	BC,(STABLE+2*027H)	;(BDOS)ランダムブロック読み込み
E69B                RBRW:
E69B AF             	XOR	A	;HLA = HL*128
E69C CB 3C          	SRL	H	;HL=HL/2
E69E CB 1D          	RR	L	;
E6A0 1F             	RRA			;HLA
E6A1 FD 77 21       	LD	(IY+33),A	;(FCB)ランダムレコード
E6A4 FD 75 22       	LD	(IY+34),L
E6A7 FD 74 23       	LD	(IY+35),H
E6AA 21 80 00       	LD	HL,128
E6AD                
E6AD FD E5          	PUSH	IY
E6AF D1             	POP	DE
E6B0 D5             	PUSH	DE
E6B1 CD B8 E6       	CALL	JP_BC
E6B4 FD E1          	POP	IY
E6B6 C1             	POP	BC
E6B7 C9             	RET
E6B8                JP_BC:
E6B8 C5             	PUSH	BC
E6B9 C9             	RET
E6BA                
E6BA 00 00 E2 7E    _SYS03	EQU	SCF_FF_RET	;(BDOS)外部入力
E6BA 00 00 E2 7E    _SYS2B	EQU	SCF_FF_RET	;(BDOS)日付の設定
E6BA 00 00 E2 7E    _SYS2D	EQU	SCF_FF_RET	;(BDOS)時刻の設定
E6BA 00 00 E2 7E    _SYS39	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの作成
E6BA 00 00 E2 7E    _SYS3A	EQU	SCF_FF_RET	;(BDOS)サブディレクトリの削除
E6BA                
E6BA                	INCLUDE	"LDFILE2.ASM"
E6BA                
E6BA                ;	LSX-Dodgers FILE2
E6BA                
E6BA                				;Write random block
E6BA                _SYS26:		;(BDOS)ランダムブロック書き込み
E6BA AF             	XOR	A
E6BB 32 0E E9       	LD	(DRDN1),A	;NOP
E6BE 22 CF E8       	LD	(LEFT+1),HL	;HL←書き込むレコード数
E6C1 22 5D EF       	LD	(LEFTX),HL
E6C4 CD D3 E1       	CALL	SETDRV
E6C7                
E6C7 CD 37 E8       	CALL	RBX0
E6CA DA 60 E7       	JP	C,RBWERR
E6CD CD 5B E5       	CALL	WOPEN
E6D0 DA 60 E7       	JP	C,RBWERR
E6D3 7C             	LD	A,H
E6D4 B5             	OR	L
E6D5 CA 59 E7       	JP	Z,RBW1
E6D8                
E6D8 2B             	DEC	HL
E6D9                
E6D9 CD E7 E8       	CALL	GET_RR_CDE	;CDE=Random record
E6DC                
E6DC AF             	XOR	A	;AHL=HL+CDE
E6DD 19             	ADD	HL,DE
E6DE 89             	ADC	A,C
E6DF                
E6DF 47             	LD	B,A
E6E0 4C             	LD	C,H
E6E1                
E6E1 CD C0 E5       	CALL	RWXR
E6E4 DC 6C E5       	CALL	C,WRDFX
E6E7 DA 60 E7       	JP	C,RBWERR
E6EA                
E6EA CD 60 E8       	CALL	RBX2
E6ED 28 1A          	JR	Z,RBWB		;NZ=セクタ以下の端数がある
E6EF CD 74 E8       	CALL	RBXA
E6F2 38 6C          	JR	C,RBWERR
E6F4 EB             	EX	DE,HL
E6F5 C5             	PUSH	BC
E6F6 ED B0          	LDIR
E6F8 22 5F EF       	LD	(DTAX),HL
E6FB                
E6FB CD 00 E5       	CALL	SWTDBF		;バッファデータは更新された
E6FE                
E6FE 2A 5D EF       	LD	HL,(LEFTX)
E701 D1             	POP	DE
E702 ED 52          	SBC	HL,DE
E704 22 5D EF       	LD	(LEFTX),HL
E707 28 30          	JR	Z,RBWEND
E709                
E709                RBWB:
E709 CD AA E8       	CALL	RBXB
E70C 28 13          	JR	Z,RBWC
E70E                RBWB1:
E70E C5             	PUSH	BC
E70F D5             	PUSH	DE
E710 CD D1 E3       	CALL	CLUSTX
E713 CD EA EB       	CALL	DWT24
E716 D1             	POP	DE
E717 C1             	POP	BC
E718 38 46          	JR	C,RBWERR
E71A CD 86 EA       	CALL	GNCLX
E71D 38 41          	JR	C,RBWERR
E71F 10 ED          	DJNZ	RBWB1
E721                RBWC:
E721 CD C2 E8       	CALL	RBXC
E724 28 13          	JR	Z,RBWEND
E726 C5             	PUSH	BC
E727 CD D1 E3       	CALL	CLUSTX
E72A CD 0D E9       	CALL	DRDN
E72D C1             	POP	BC
E72E 38 30          	JR	C,RBWERR
E730 ED 5B 7E F0    	LD	DE,(_DTBUF)
E734 ED B0          	LDIR
E736 CD 00 E5       	CALL	SWTDBF		;バッファデータは更新された
E739                RBWEND:
E739 CD CE E8       	CALL	RBXEND
E73C                
E73C CD 46 E8       	CALL	RBX1
E73F 30 18          	JR	NC,RBW1
E741 2A CF E8       	LD	HL,(LEFT+1)
E744 FD 5E 10       	LD	E,(IY+16)	;(FCB)ファイルのサイズ(バイト単位)
E747 FD 56 11       	LD	D,(IY+17)	;CDE=File size
E74A FD 4E 12       	LD	C,(IY+18)
E74D AF             	XOR	A
E74E 19             	ADD	HL,DE
E74F 89             	ADC	A,C
E750 FD 75 10       	LD	(IY+16),L	;(FCB)ファイルのサイズ(バイト単位)
E753 FD 74 11       	LD	(IY+17),H
E756 FD 77 12       	LD	(IY+18),A
E759                RBW1:
E759 FD E1          	POP	IY
E75B C1             	POP	BC
E75C D1             	POP	DE
E75D E1             	POP	HL
E75E                DD_NUL:
E75E AF             	XOR	A
E75F C9             	RET
E760                
E760                RBWERR:
E760 FD E5          	PUSH	IY
E762 D1             	POP	DE
E763 2A 20 F0       	LD	HL,(STABLE+2*010H)
E766 CD 0F 00       	CALL	JP_HL
E769                RBRERR1:
E769 3E 01          	LD	A,001H
E76B                RBRERR2:
E76B FD E1          	POP	IY
E76D C1             	POP	BC
E76E D1             	POP	DE
E76F E1             	POP	HL
E770 37             	SCF
E771 21 00 00       	LD	HL,0
E774 C9             	RET
E775                
E775                RBRERR:
E775 3E FF          	LD	A,0FFH
E777 18 F2          	JR	RBRERR2
E779                
E779                RBRFL:
E779 3E 00          RBRFLP:	LD	A,000H
E77B FE 0D          	CP	00DH
E77D 20 05          	JR	NZ,RBRFL1
E77F D5             	PUSH	DE
E780 1E 0A          	LD	E,00AH
E782 18 05          	JR	RBRFL2
E784                RBRFL1:
E784 D5             	PUSH	DE
E785 CD 09 EF       	CALL	_SYS07
E788 5F             	LD	E,A
E789                RBRFL2:
E789 CD CD EF       	CALL	_PRINT
E78C 7B             	LD	A,E
E78D D1             	POP	DE
E78E 32 7A E7       	LD	(RBRFLP+1),A
E791 C9             	RET
E792                DDX:
E792 FD 7E 01       	LD	A,(IY+1)	;(FCB)主ファイル名
E795 CD F6 E3       	CALL	CAP
E798 FE 41          	CP	'A'
E79A C9             	RET
E79B                
E79B                				;Read random block
E79B                _SYS27:		;(BDOS)ランダムブロック読み込み
E79B 22 5D EF       	LD	(LEFTX),HL
E79E CD D3 E1       	CALL	SETDRV
E7A1                
E7A1 FD CB 0D 66    	BIT	4,(IY+13)	;(FCB)属性(アトリビュート)
E7A5 C2 25 E8       	JP	NZ,RBRDIR	;ディレクトリ
E7A8 CD 37 E8       	CALL	RBX0
E7AB DA 75 E7       	JP	C,RBRERR
E7AE CD 46 E8       	CALL	RBX1
E7B1 DA 69 E7       	JP	C,RBRERR1
E7B4 79             	LD	A,C
E7B5 EB             	EX	DE,HL
E7B6 ED 52          	SBC	HL,DE		;CP 0HL,CDE
E7B8 19             	ADD	HL,DE
E7B9 DE 00          	SBC	A,000H
E7BB 38 01          	JR	C,RBR1
E7BD EB             	EX	DE,HL
E7BE                RBR1:
E7BE 9F             	SBC	A,A
E7BF E6 01          	AND	1
E7C1 32 23 E8       	LD	(RBRAP+1),A
E7C4                
E7C4 7C             	LD	A,H
E7C5 B5             	OR	L
E7C6 28 54          	JR	Z,RBREND0
E7C8                
E7C8 22 CF E8       	LD	(LEFT+1),HL	;Read record byte
E7CB 22 5D EF       	LD	(LEFTX),HL
E7CE                
E7CE CD 60 E8       	CALL	RBX2
E7D1 28 19          	JR	Z,RBRB
E7D3 CD 74 E8       	CALL	RBXA
E7D6 DA 75 E7       	JP	C,RBRERR
E7D9 C5             	PUSH	BC
E7DA ED B0          	LDIR
E7DC ED 53 5F EF    	LD	(DTAX),DE
E7E0 2A 5D EF       	LD	HL,(LEFTX)
E7E3 D1             	POP	DE
E7E4 A7             	AND	A
E7E5 ED 52          	SBC	HL,DE
E7E7 22 5D EF       	LD	(LEFTX),HL
E7EA 28 2D          	JR	Z,RBREND
E7EC                
E7EC                RBRB:
E7EC CD AA E8       	CALL	RBXB
E7EF 28 12          	JR	Z,RBRC
E7F1                RBRB1:
E7F1 C5             	PUSH	BC
E7F2 D5             	PUSH	DE
E7F3 CD D1 E3       	CALL	CLUSTX
E7F6 CD DA EB       	CALL	DRD24
E7F9 D1             	POP	DE
E7FA C1             	POP	BC
E7FB D4 86 EA       	CALL	NC,GNCLX
E7FE DA 75 E7       	JP	C,RBRERR
E801 10 EE          	DJNZ	RBRB1
E803                RBRC:
E803 CD C2 E8       	CALL	RBXC
E806 28 11          	JR	Z,RBREND
E808 C5             	PUSH	BC
E809 CD D1 E3       	CALL	CLUSTX
E80C CD F1 E8       	CALL	DRDX
E80F C1             	POP	BC
E810 DA 75 E7       	JP	C,RBRERR
E813 EB             	EX	DE,HL
E814 2A 7E F0       	LD	HL,(_DTBUF)
E817 ED B0          	LDIR
E819                RBREND:
E819 CD CE E8       	CALL	RBXEND
E81C                RBREND0:
E81C FD E1          	POP	IY
E81E C1             	POP	BC
E81F D1             	POP	DE
E820 F1             	POP	AF	;(HL)
E821 AF             	XOR	A
E822 3E 00          RBRAP:	LD	A,000H
E824 C9             	RET
E825                
E825                RBRDIR:
E825 FD 6E 1A       	LD	L,(IY+26)	;(FCB)ファイルの先頭クラスタ
E828 FD 66 1B       	LD	H,(IY+27)
E82B CD 11 E4       	CALL	CHDIR
E82E AF             	XOR	A
E82F 67             	LD	H,A
E830 6F             	LD	L,A
E831 3C             	INC	A
E832 32 23 E8       	LD	(RBRAP+1),A
E835 18 E5          	JR	RBREND0
E837                
E837                RBX0:
E837 2A 8A EF       	LD	HL,(_DTA)
E83A 22 5F EF       	LD	(DTAX),HL
E83D 2A 5D EF       	LD	HL,(LEFTX)
E840 FD 7E 1C       	LD	A,(IY+28)	;(FCB)オープンモード
E843 D6 FD          	SUB	0FDH
E845 C9             	RET
E846                
E846                RBX1:
E846 E5             	PUSH	HL		;Record byte
E847                				;AHL=File size
E847 FD 6E 10       	LD	L,(IY+16)	;ファイルのサイズ(バイト単位)
E84A FD 66 11       	LD	H,(IY+17)
E84D FD 7E 12       	LD	A,(IY+18)
E850                
E850 CD E7 E8       	CALL	GET_RR_CDE	;CDE=Random record
E853                
E853 A7             	AND	A
E854 ED 52          	SBC	HL,DE
E856 99             	SBC	A,C
E857 D1             	POP	DE
E858                
E858 D8             	RET	C
E859 4F             	LD	C,A
E85A EB             	EX	DE,HL	;CDE=File byte	HL=Record byte
E85B B2             	OR	D
E85C B3             	OR	E
E85D C0             	RET	NZ
E85E 37             	SCF
E85F C9             	RET
E860                
E860                RBX2:				;Cluster settings
E860 FD 4E 22       	LD	C,(IY+34)	;(+33)(FCB)ランダムレコード
E863 FD 46 23       	LD	B,(IY+35)
E866 CD C0 E5       	CALL	RWXR
E869 3A 8C E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E86C 3D             	DEC	A
E86D FD A6 22       	AND	(IY+34)
E870 FD B6 21       	OR	(IY+33)
E873 C9             	RET
E874                
E874                RBXA:
E874 C5             	PUSH	BC
E875 D5             	PUSH	DE
E876 CD D1 E3       	CALL	CLUSTX
E879 CD F1 E8       	CALL	DRDX
E87C D1             	POP	DE
E87D C1             	POP	BC
E87E D8             	RET	C
E87F CD 86 EA       	CALL	GNCLX
E882 D8             	RET	C
E883 ED 53 FE F0    	LD	(_CLPS),DE
E887                
E887 FD 4E 21       	LD	C,(IY+33)	;(FCB)ランダムレコード
E88A 21 00 04       SECSZ:	LD	HL,0400H	;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
E88D 7C             	LD	A,H
E88E 3D             	DEC	A		;1024=3 / 512=1
E88F FD A6 22       	AND	(IY+34)		;(FCB)ランダムレコード
E892 47             	LD	B,A		;BCに1セクタ以下の端数が入る
E893 ED 42          	SBC	HL,BC		;残りを計算
E895                
E895 ED 5B 5D EF    	LD	DE,(LEFTX)
E899 ED 52          	SBC	HL,DE		;CP HL,DE
E89B 19             	ADD	HL,DE		;
E89C 38 01          	JR	C,RBXA1		;DEとHLを比較して大きい方をHLに
E89E EB             	EX	DE,HL
E89F                RBXA1:
E89F E5             	PUSH	HL
E8A0 2A 7E F0       	LD	HL,(_DTBUF)
E8A3 09             	ADD	HL,BC
E8A4 ED 5B 5F EF    	LD	DE,(DTAX)
E8A8 C1             	POP	BC
E8A9 C9             	RET
E8AA                
E8AA                RBXB:
E8AA 2A 5F EF       	LD	HL,(DTAX)
E8AD ED 5B FE F0    	LD	DE,(_CLPS)
E8B1 3A 5E EF       	LD	A,(LEFTX+1)
E8B4 47             	LD	B,A
E8B5 3A 8C E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8B8                RBXB1:
E8B8 1F             	RRA		;->CF
E8B9 38 04          	JR	C,RBXB2
E8BB CB 38          	SRL	B	;B=B/2
E8BD 18 F9          	JR	RBXB1
E8BF                RBXB2:
E8BF 78             	LD	A,B
E8C0 B7             	OR	A
E8C1 C9             	RET
E8C2                
E8C2                RBXC:
E8C2 ED 4B 5D EF    	LD	BC,(LEFTX)
E8C6 3A 8C E8       	LD	A,(SECSZ+2)	;1024=4 / 512=2 / 256=1
E8C9 3D             	DEC	A
E8CA A0             	AND	B
E8CB 47             	LD	B,A		;1セクタ以下の端数がない場合はZ
E8CC B1             	OR	C
E8CD C9             	RET
E8CE                
E8CE                RBXEND:
E8CE 11 00 00       LEFT:	LD	DE,0
E8D1 AF             	XOR	A
E8D2 FD 6E 21       	LD	L,(IY+33)	;(FCB)ランダムレコード
E8D5 FD 66 22       	LD	H,(IY+34)
E8D8 19             	ADD	HL,DE
E8D9 FD 8E 23       	ADC	A,(IY+35)
E8DC FD 75 21       	LD	(IY+33),L	;(FCB)ランダムレコード
E8DF FD 74 22       	LD	(IY+34),H
E8E2 FD 77 23       	LD	(IY+35),A
E8E5 EB             	EX	DE,HL		;HL=Read byte
E8E6 C9             	RET
E8E7                
E8E7                GET_RR_CDE:			;CDE=Random record
E8E7 FD 5E 21       	LD	E,(IY+33)	;(FCB)ランダムレコード
E8EA FD 56 22       	LD	D,(IY+34)
E8ED FD 4E 23       	LD	C,(IY+35)
E8F0 C9             	RET
E8F1                
E8F1                	INCLUDE	"LDDIO.ASM"
E8F1                
E8F1                ;	LSX-Dodgers DIO
E8F1                
E8F1                DRDX:
E8F1 CD 2F E9       	CALL	DRDY
E8F4 C8             	RET	Z
E8F5 CD 15 E9       	CALL	DRDX1		;データバッファの情報を保存
E8F8 D8             	RET	C
E8F9 E5             	PUSH	HL
E8FA C5             	PUSH	BC
E8FB D5             	PUSH	DE
E8FC 2A 7E F0       	LD	HL,(_DTBUF)
E8FF 3A 58 E9       	LD	A,(_DBS24+1)
E902 4F             	LD	C,A
E903 CD DA EB       	CALL	DRD24
E906 DC 2A E9       	CALL	C,DRDNE
E909                POP_DE_BC_HL_RET:
E909 D1             	POP	DE
E90A C1             	POP	BC
E90B E1             	POP	HL
E90C C9             	RET
E90D                
E90D                ;	CDE:セクタ番号
E90D                DRDN:
E90D AF             	XOR	A
E90E 00             DRDN1:	NOP			;自己書き換え NOP / SCF
E90F 30 E0          	JR	NC,DRDX
E911                DRDNX:
E911 CD 2F E9       	CALL	DRDY
E914 C8             	RET	Z
E915                DRDX1:
E915 CD 45 E9       	CALL	DWTX
E918                				;データバッファの読み込んだドライブ・セクタ情報を保存
E918 ED 53 A6 EF    	LD	(_DBSEC),DE
E91C 79             	LD	A,C
E91D 32 58 E9       	LD	(_DBS24+1),A
E920                
E920 3A 88 EF       	LD	A,(_DRV)
E923 32 A5 EF       	LD	(_DBDRV),A
E926 CD D9 EF       	CALL	_CHGDRV
E929 D0             	RET	NC
E92A                DRDNE:
E92A 9F             	SBC	A,A		;CF=1ならばA=0FFH
E92B 32 A5 EF       	LD	(_DBDRV),A
E92E C9             	RET
E92F                
E92F                ;	CDE:セクタ番号
E92F                DRDY:
E92F 3A 58 E9       	LD	A,(_DBS24+1)
E932 B9             	CP	C
E933 C0             	RET	NZ
E934                
E934 E5             	PUSH	HL
E935 3A 88 EF       	LD	A,(_DRV)
E938 21 A5 EF       	LD	HL,_DBDRV
E93B AE             	XOR	(HL)
E93C 20 05          	JR	NZ,POP_HL_RET
E93E                
E93E 2A A6 EF       	LD	HL,(_DBSEC)
E941 ED 52          	SBC	HL,DE		;CF=0
E943                POP_HL_RET:
E943 E1             	POP	HL
E944 C9             	RET
E945                
E945                DWTX:
E945 3A A4 EF       	LD	A,(_WTDBF)
E948 B7             	OR	A
E949 C8             	RET	Z
E94A AF             	XOR	A
E94B 32 A4 EF       	LD	(_WTDBF),A
E94E                
E94E E5             	PUSH	HL
E94F C5             	PUSH	BC
E950 D5             	PUSH	DE
E951 3A A5 EF       	LD	A,(_DBDRV)
E954 CD D9 EF       	CALL	_CHGDRV
E957 0E 00          _DBS24:	LD	C,0
E959 ED 5B A6 EF    	LD	DE,(_DBSEC)
E95D 2A 7E F0       	LD	HL,(_DTBUF)
E960 D4 EA EB       	CALL	NC,DWT24
E963                POP_DE_BC_HL_RET2:
E963 18 A4          	JR	POP_DE_BC_HL_RET
E965                
E965                RDFATX:
E965 E5             	PUSH	HL
E966 3A 88 EF       	LD	A,(_DRV)
E969 21 AA EF       	LD	HL,_FATDRV
E96C AE             	XOR	(HL)
E96D 28 D4          	JR	Z,POP_HL_RET
E96F                
E96F C5             	PUSH	BC
E970 D5             	PUSH	DE
E971 DD E5          	PUSH	IX
E973 CD 8F E9       	CALL	WTFATX
E976 38 13          	JR	C,POP_IX_DE_BC_HL_RET
E978                
E978 AF             	XOR	A
E979 32 AB EF       	LD	(_FATIX),A
E97C 3A 88 EF       	LD	A,(_DRV)
E97F 32 AA EF       	LD	(_FATDRV),A
E982 CD E5 EF       	CALL	_RDFAT
E985                RDFATE2:
E985 30 04          	JR	NC,POP_IX_DE_BC_HL_RET
E987 9F             	SBC	A,A		;A=0xFF
E988 32 AA EF       	LD	(_FATDRV),A
E98B                POP_IX_DE_BC_HL_RET:
E98B DD E1          	POP	IX
E98D 18 D4          	JR	POP_DE_BC_HL_RET2
E98F                
E98F                WTFATX:
E98F 3A A2 EF       	LD	A,(_WTFATF)
E992 B7             	OR	A
E993 C8             	RET	Z
E994 E5             	PUSH	HL
E995 3A AA EF       	LD	A,(_FATDRV)
E998 21 A5 EF       	LD	HL,_DBDRV
E99B AE             	XOR	(HL)
E99C CC 45 E9       	CALL	Z,DWTX
E99F 38 A2          	JR	C,POP_HL_RET
E9A1 C5             	PUSH	BC
E9A2 D5             	PUSH	DE
E9A3 DD E5          	PUSH	IX
E9A5 CD F7 EB       	CALL	WTFAT
E9A8 AF             	XOR	A
E9A9 32 A2 EF       	LD	(_WTFATF),A
E9AC 18 DD          	JR	POP_IX_DE_BC_HL_RET
E9AE                
E9AE                NCL1:
E9AE 7A             	LD	A,D
E9AF B3             	OR	E
E9B0 37             	SCF
E9B1 C8             	RET	Z
E9B2                
E9B2 7A             	LD	A,D
E9B3 CB 3F          	SRL	A	;/2
E9B5 CB 3F          	SRL	A	;/2
E9B7                
E9B7 E5             	PUSH	HL
E9B8 32 D7 E9       	LD	(NCLPAT+2),A	;_FATIX
E9BB 2A AA EF       	LD	HL,(_FATDRV)	;L=_FATDRV H=_FATIX
E9BE BC             	CP	H
E9BF 3A 88 EF       	LD	A,(_DRV)	;この間でフラグは変化しない
E9C2 32 D6 E9       	LD	(NCLPAT+1),A	;_FATDRV
E9C5 20 05          	JR	NZ,NCL2		;FATIXが違う
E9C7 BD             	CP	L
E9C8 20 02          	JR	NZ,NCL2		;ドライブが違う
E9CA E1             	POP	HL
E9CB C9             	RET
E9CC                NCL2:
E9CC C5             	PUSH	BC
E9CD D5             	PUSH	DE
E9CE DD E5          	PUSH	IX
E9D0 CD 8F E9       	CALL	WTFATX
E9D3 38 B6          	JR	C,POP_IX_DE_BC_HL_RET
E9D5 01 00 00       NCLPAT:	LD	BC,0		;自己書き換え C=_FATDRV B=_FATIX
E9D8 ED 43 AA EF    	LD	(_FATDRV),BC
E9DC CD CC EB       	CALL	RDFATS
E9DF 18 A4          	JR	RDFATE2
E9E1                
E9E1                NCL3:
E9E1 CB 9A          	RES	3,D
E9E3 CB 92          	RES	2,D
E9E5 6B             	LD	L,E
E9E6 62             	LD	H,D
E9E7 CB 3C          	SRL	H	;
E9E9 CB 1D          	RR	L	;HLA=HLA/2
E9EB 1F             	RRA		;
E9EC F5             	PUSH	AF
E9ED 3A AB EF       	LD	A,(_FATIX)
E9F0 0F             	RRCA
E9F1 30 0B          	JR	NC,NCL3X1
E9F3 3A 8C E8       	LD	A,(SECSZ+2)
E9F6 FE 04          	CP	4		;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
E9F8 20 04          	JR	NZ,NCL3X1
E9FA 01 00 02       	LD	BC,512
E9FD 09             	ADD	HL,BC
E9FE                NCL3X1:
E9FE F1             	POP	AF
E9FF ED 4B 7C F0    	LD	BC,(_FATBF)
EA03 19             	ADD	HL,DE
EA04 09             	ADD	HL,BC
EA05 17             	RLA
EA06 C9             	RET
EA07                
EA07                GNCL:
EA07 CD AE E9       	CALL	NCL1		;GET NEXT CLUSTER
EA0A D8             	RET	C
EA0B C5             	PUSH	BC
EA0C E5             	PUSH	HL
EA0D CD E1 E9       	CALL	NCL3
EA10 38 09          	JR	C,GNC1
EA12 5E             	LD	E,(HL)
EA13 23             	INC	HL
EA14 7E             	LD	A,(HL)
EA15 E6 0F          	AND	00FH
EA17 57             	LD	D,A
EA18 E1             	POP	HL
EA19 C1             	POP	BC
EA1A C9             	RET
EA1B                GNC1:
EA1B 7E             	LD	A,(HL)
EA1C 23             	INC	HL
EA1D 56             	LD	D,(HL)
EA1E 06 04          	LD	B,4
EA20                GNC1L:
EA20 CB 3A          	SRL	D	;DA=DA/2
EA22 1F             	RRA		;
EA23 10 FB          	DJNZ	GNC1L
EA25                
EA25 5F             	LD	E,A
EA26 E1             	POP	HL
EA27 C1             	POP	BC
EA28 A7             	AND	A
EA29 C9             	RET
EA2A                
EA2A                SNCL:
EA2A CD AE E9       	CALL	NCL1
EA2D D8             	RET	C
EA2E                ;				SET NEXT CLUSTER
EA2E E5             	PUSH	HL
EA2F C5             	PUSH	BC
EA30 D5             	PUSH	DE
EA31 E5             	PUSH	HL
EA32 CD E1 E9       	CALL	NCL3
EA35 D1             	POP	DE
EA36                ;CF=ODD
EA36 7E             	LD	A,(HL)
EA37 73             	LD	(HL),E
EA38 38 06          	JR	C,SNC1
EA3A                ;EVEN
EA3A                ;M[0] = E
EA3A                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
EA3A 23             	INC	HL
EA3B ED 67          	RRD		;M={A[3:0],E[3:0]}
EA3D 7A             	LD	A,D
EA3E 18 04          	JR	SNC11
EA40                SNC1:
EA40                ;ODD
EA40                ;HL[0] = (HL[0]&0x0F) | (E<<4)
EA40                ;HL[1] = DE>>4
EA40 ED 6F          	RLD		;M={D[3:0],E[7:4]}
EA42 23             	INC	HL
EA43 72             	LD	(HL),D	;M={D[3:0],E[7:4]}
EA44                SNC11:
EA44 ED 6F          	RLD		;M={M[7:4],D[3:0]}
EA46 B7             	OR	A
EA47 D1             	POP	DE
EA48 C1             	POP	BC
EA49 E1             	POP	HL
EA4A                FAT_CHANGED:
EA4A 3E 01          	LD	A,1
EA4C 32 A2 EF       	LD	(_WTFATF),A
EA4F C9             	RET
EA50                
EA50                N16CL3:
EA50 C5             	PUSH	BC
EA51 6B             	LD	L,E
EA52 7A             	LD	A,D
EA53 E6 03          	AND	3
EA55 67             	LD	H,A
EA56 29             	ADD	HL,HL
EA57 ED 4B 7C F0    	LD	BC,(_FATBF)
EA5B 09             	ADD	HL,BC
EA5C C1             	POP	BC
EA5D C9             	RET
EA5E                
EA5E                GNCL16:
EA5E CD AE E9       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EA61 D8             	RET	C
EA62 E5             	PUSH	HL
EA63 CD 50 EA       	CALL	N16CL3
EA66 5E             	LD	E,(HL)
EA67 23             	INC	HL
EA68 56             	LD	D,(HL)
EA69 E1             	POP	HL
EA6A C9             	RET
EA6B                
EA6B                SNCL16:
EA6B CD AE E9       	CALL	NCL1		;GET NEXT CLUSTER for FAT16
EA6E D8             	RET	C
EA6F D5             	PUSH	DE
EA70 E5             	PUSH	HL
EA71 CD 50 EA       	CALL	N16CL3
EA74 D1             	POP	DE		;HL
EA75 73             	LD	(HL),E
EA76 23             	INC	HL
EA77 72             	LD	(HL),D
EA78 6B             	LD	L,E
EA79 62             	LD	H,D
EA7A D1             	POP	DE
EA7B 18 CD          	JR	FAT_CHANGED
EA7D                
EA7D                ;------------------------
EA7D                ;次のセクタを探す際に_SECPSの値をチェック
EA7D                ;in
EA7D                ;	DE : セクタ番号
EA7D                ;out
EA7D                ;	DE : 次のセクタ番号
EA7D                ;note
EA7D                ;
EA7D                ;------------------------
EA7D                NEXTX:
EA7D 3E 00          _SECPS:	LD	A,0	;自己書き換え
EA7F 3C             	INC	A
EA80 E6 00          NCPAT:	AND	0	;自己書き換え　1クラスタの論理セクタ数-1
EA82 32 7E EA       	LD	(_SECPS+1),A
EA85 C9             	RET
EA86                
EA86                GNCLX:
EA86 CD 7D EA       	CALL	NEXTX
EA89 C0             	RET	NZ	;1クラスタのセクタ未満の場合は戻る
EA8A C3 F7 EF       	JP	_GNCL	;次のクラスタを探す
EA8D                
EA8D                RDFAT:
EA8D 3E 80          	LD	A,080H
EA8F 32 70 EF       	LD	(CHECK),A
EA92                RDFAT1:
EA92 3A 88 EF       	LD	A,(_DRV)
EA95 CD 2A ED       	CALL	CHGDRVR
EA98 D8             	RET	C
EA99 DD 7E 12       	LD	A,(IX+012H)	;DPB_12_DEVICE
EA9C CB 6F          	BIT	5,A
EA9E 28 43          	JR	Z,RDFAT0X
EAA0 21 70 EF       	LD	HL,CHECK
EAA3 A6             	AND	(HL)
EAA4 77             	LD	(HL),A
EAA5 11 00 00       	LD	DE,0		;BPB
EAA8 2A 7C F0       	LD	HL,(_FATBF)
EAAB CD D8 EB       	CALL	DRD16
EAAE 30 24          	JR	NC,GETBPB
EAB0 21 70 EF       	LD	HL,CHECK
EAB3 CB 06          	RLC	(HL)
EAB5 3F             	CCF
EAB6 D8             	RET	C
EAB7 DD CB 0A 1E    	RR	(IX+00AH)	;DPB_0A_FDMODE
EABB 3F             	CCF			;フロッピーディスクのMFMモードを切り替える
EABC DD CB 0A 16    	RL	(IX+00AH)	;DPB_0A_FDMODE
EAC0 3E FF          	LD	A,0FFH
EAC2 32 89 EF       	LD	(_DSK),A
EAC5 3A 84 EF       	LD	A,(_DRIVE)
EAC8 E6 03          	AND	3
EACA F6 80          	OR	080H
EACC 6F             	LD	L,A
EACD 26 EF          	LD	H,_CYL0/256
EACF 3E FF          	LD	A,0FFH
EAD1 77             	LD	(HL),A
EAD2 18 BE          	JR	RDFAT1
EAD4                GETBPB:
EAD4 FD E5          	PUSH	IY
EAD6 FD 2A 7C F0    	LD	IY,(_FATBF)	;BPB
EADA CD F1 EF       	CALL	_BPB2DPB
EADD FD E1          	POP	IY
EADF D8             	RET	C
EAE0 CD 80 EC       	CALL	CHGDRV2
EAE3                RDFAT0X:
EAE3 CD CC EB       	CALL	RDFATS
EAE6 D8             	RET	C
EAE7 DD BE 06       	CP	(IX+6)		;DPB_06_FATID
EAEA C8             	RET	Z
EAEB DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
EAEF C0             	RET	NZ		;BPBを取得している場合はFATIDをチェックしない
EAF0 37             	SCF
EAF1 C9             	RET
EAF2                
EAF2                BPB2DPB:
EAF2 FD 7E 00       	LD	A,(IY+0)	;BS_JmpBoot
EAF5 FE EB          	CP	0EBH		;Short jump
EAF7 28 08          	JR	Z,BPBOK
EAF9 FE E9          	CP	0E9H		;Near jump
EAFB 28 04          	JR	Z,BPBOK
EAFD FE 60          	CP	060H		;X68k
EAFF 37             	SCF
EB00 C0             	RET	NZ
EB01                BPBOK:
EB01 FD 7E 0D       	LD	A,(IY+13)	;BPB_SecPerClus
EB04 DD 77 07       	LD	(IX+7),A	;DPB_07_SECPCL
EB07                
EB07 FD 7E 16       	LD	A,(IY+22)	;BPB_FATSz16
EB0A DD 77 00       	LD	(IX+0),A	;DPB_00_FATLN
EB0D FD 7E 17       	LD	A,(IY+23)	;BPB_FATSz16
EB10 DD 77 01       	LD	(IX+1),A	;DPB_00_FATLN
EB13                
EB13 FD 6E 0E       	LD	L,(IY+14)	;BPB_RsvdSecCnt
EB16 FD 66 0F       	LD	H,(IY+15)
EB19 DD 75 0E       	LD	(IX+00EH),L	;DPB_0E_FATPS
EB1C FD 5E 16       	LD	E,(IY+22)	;BPB_FATSz16
EB1F FD 56 17       	LD	D,(IY+23)
EB22 FD 46 10       	LD	B,(IY+16)	;BPB_NumFATs
EB25                BPBDP1:				;BPB_FATSz16 * BPB_NumFATs
EB25 19             	ADD	HL,DE
EB26 10 FD          	DJNZ	BPBDP1
EB28                BPBDP2:
EB28 DD 75 10       	LD	(IX+010H),L	;DPB_10_DIRPS
EB2B DD 74 11       	LD	(IX+011H),H
EB2E E5             	PUSH	HL
EB2F                
EB2F FD 6E 11       	LD	L,(IY+17)	;BPB_RootEntCnt
EB32 FD 66 12       	LD	H,(IY+18)
EB35 FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EB38 06 06          	LD	B,6
EB3A                BPBBPS1:
EB3A 05             	DEC	B
EB3B 0F             	RRCA
EB3C 30 FC          	JR	NC,BPBBPS1
EB3E                BPBDE1:
EB3E 29             	ADD	HL,HL
EB3F 10 FD          	DJNZ	BPBDE1
EB41                
EB41 7C             	LD	A,H
EB42 DD 77 0B       	LD	(IX+00BH),A	;DPB_0B_DIRSCNT
EB45                
EB45 D1             	POP	DE		;DPB_10_DIRPS
EB46 6C             	LD	L,H
EB47 26 00          	LD	H,0
EB49 19             	ADD	HL,DE		;MAXDIR
EB4A E5             	PUSH	HL
EB4B FD 4E 0D       	LD	C,(IY+13)	;BPB_SecPerClus
EB4E CB 21          	SLA	C		;*2
EB50 AF             	XOR	A
EB51 47             	LD	B,A
EB52 ED 42          	SBC	HL,BC
EB54 DD 75 14       	LD	(IX+014H),L	;DPB_14_ADDCL16
EB57 DD 74 15       	LD	(IX+015H),H
EB5A                
EB5A D1             	POP	DE		;DE=DPB_0B_MAXDIR
EB5B FD 6E 13       	LD	L,(IY+19)	;BPB_TotSec16
EB5E FD 66 14       	LD	H,(IY+20)
EB61 7C             	LD	A,H
EB62 B5             	OR	L
EB63 3E 00          	LD	A,0		;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
EB65 20 10          	JR	NZ,BPB16BIT	;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
EB67 FD 7E 23       	LD	A,(IY+35)	;念のために総セクタ数が24ビットを超える場合はエラーを返す
EB6A B7             	OR	A
EB6B 37             	SCF
EB6C C0             	RET	NZ
EB6D FD 6E 20       	LD	L,(IY+32)	;BPB_TotSec32 は AHL の24ビットで扱う
EB70 FD 66 21       	LD	H,(IY+33)	;1クラスタの論理セクタ数(DPB_07_SECPCL)が最大128なので
EB73 FD 7E 22       	LD	A,(IY+34)	;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
EB76 A7             	AND	A		;CF=0
EB77                BPB16BIT:
EB77 ED 52          	SBC	HL,DE
EB79 DE 00          	SBC	A,0
EB7B FD 46 0D       	LD	B,(IY+13)	;BPB_SecPerClus
EB7E                BPBTC1:				;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
EB7E CB 18          	RR	B		;->CY
EB80 38 08          	JR	C,BPBTC2
EB82 CB 3F          	SRL	A
EB84 CB 1C          	RR	H		;AHL=AHL/2
EB86 CB 1D          	RR	L
EB88 18 F4          	JR	BPBTC1
EB8A                BPBTC2:
EB8A B7             	OR	A
EB8B 37             	SCF
EB8C C0             	RET	NZ		;念のため(クラスタ数が16ビットを超える場合)
EB8D 23             	INC	HL
EB8E 23             	INC	HL
EB8F DD 75 08       	LD	(IX+8),L	;DPB_08_MAXCL
EB92 DD 74 09       	LD	(IX+9),H
EB95                
EB95 FD 7E 15       	LD	A,(IY+21)	;BPB_Media
EB98 DD 77 06       	LD	(IX+6),A	;DPB_06_FATID
EB9B                
EB9B DD CB 0A 7E    	BIT	7,(IX+00AH)	;DPB_0A_FDMODE
EB9F 28 17          	JR	Z,NOT_FD
EBA1 2E 28          	LD	L,40		;MAXCYLの設定（要検討）ここから下はフロッピーのみ書き換える
EBA3 FE FD          	CP	0FDH	;2D
EBA5 28 08          	JR	Z,SETCYL
EBA7 2E 4D          	LD	L,77
EBA9 FE FE          	CP	0FEH	;2HD
EBAB 28 02          	JR	Z,SETCYL
EBAD 2E 50          	LD	L,80	;その他2DD等
EBAF                SETCYL:
EBAF DD 75 0C       	LD	(IX+00CH),L	;DPB_0C_MAXCYL
EBB2 FD 7E 18       	LD	A,(IY+24)	;BPB_SecPerTr
EBB5 DD 77 0D       	LD	(IX+00DH),A	;DPB_0D_MAXSEC	;ここまでフロッピー専用
EBB8                NOT_FD:
EBB8 FD 7E 10       	LD	A,(IY+16)	;BPB_NumFATs
EBBB FE 02          	CP	2		;>2:NC
EBBD FD 7E 0C       	LD	A,(IY+12)	;BPB_BytsPerSec
EBC0 38 02          	JR	C,BPBFAT1
EBC2 F6 80          	OR	080H
EBC4                BPBFAT1:
EBC4 DD 77 0F       	LD	(IX+00FH),A	;DPB_0F_BPS
EBC7                
EBC7 E6 7F          	AND	07FH		;セクタバッファが1KBしかないので1KBを超える場合はCF=1でエラーにする
EBC9 C6 FB          	ADD	A,0-5		;0-4:CF=0 5以上:CF=1
EBCB C9             	RET
EBCC                
EBCC                RDFATS:
EBCC CD 12 EC       	CALL	FATSETUP
EBCF D8             	RET	C
EBD0 CD DC EB       	CALL	DRD24B
EBD3 2A 7C F0       	LD	HL,(_FATBF)
EBD6 7E             	LD	A,(HL)
EBD7 C9             	RET
EBD8                
EBD8                DRD16:
EBD8 0E 00          	LD	C,0
EBDA                DRD24:
EBDA 06 01          	LD	B,1
EBDC                DRD24B:
EBDC DD E5          	PUSH	IX
EBDE DD 2A A8 EF    	LD	IX,(_DPB)
EBE2 CD 4A EE       DRDPAT:	CALL	FDRD		;自己書き換え（ディスク読み込み）
EBE5                POP_IX_RET:
EBE5 DD E1          	POP	IX
EBE7 C9             	RET
EBE8                
EBE8                DWT16:
EBE8 0E 00          	LD	C,0
EBEA                DWT24:
EBEA 06 01          	LD	B,1
EBEC                DWT24B:
EBEC DD E5          	PUSH	IX
EBEE DD 2A A8 EF    	LD	IX,(_DPB)
EBF2 CD 3C EE       DWTPAT:	CALL	FDWT		;自己書き換え（ディスク書き込み）
EBF5 18 EE          	JR	POP_IX_RET
EBF7                
EBF7                WTFAT:
EBF7 CD 12 EC       	CALL	FATSETUP
EBFA D4 EC EB       	CALL	NC,DWT24B
EBFD D8             	RET	C
EBFE DD CB 0F 7E    	BIT	7,(IX+00FH)	;DPB_0F_BPS
EC02 C8             	RET	Z		;予備FATが無い
EC03 CD 19 EC       	CALL	FATS2
EC06 E5             	PUSH	HL		;予備FAT
EC07 DD 6E 00       	LD	L,(IX+0)	;DPB_00_FATLN
EC0A DD 66 01       	LD	H,(IX+1)
EC0D 19             	ADD	HL,DE
EC0E EB             	EX	DE,HL
EC0F E1             	POP	HL
EC10 18 DA          	JR	DWT24B
EC12                ;------------------------
EC12                ;FATのセットアップ
EC12                ;out
EC12                ;	B  : FATセクタ数
EC12                ;	DE : FAT先頭セクタ番号
EC12                ;	HL : FATバッファポインタ
EC12                ;	CF : 1=ドライブ切り替えエラー
EC12                ;note
EC12                ;	FATサイズがFATバッファを超える場合は
EC12                ;	対象クラスタ領域==(_FATIX)によって
EC12                ;	FAT12:対象クラスタ1024毎に1.5KBを切り替える
EC12                ;	FAT16:対象クラスタ1024毎に2KBを切り替える
EC12                ;------------------------
EC12                FATSETUP:
EC12 3A AA EF       	LD	A,(_FATDRV)
EC15 CD 2A ED       	CALL	CHGDRVR		;ドライブ切り替え
EC18 D8             	RET	C
EC19                FATS2:
EC19 DD 7E 0F       	LD	A,(IX+00FH)	;DPB_0F_BPS 512=2 1024=4
EC1C 0F             	RRCA
EC1D CD 46 EC       FATSX:	CALL	FATSETUP12	;自己書き換え
EC20 21 00 00       	LD	HL,0
EC23 4A             	LD	C,D
EC24 54             	LD	D,H
EC25 3A AB EF       	LD	A,(_FATIX)	;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
EC28 47             	LD	B,A
EC29 04             	INC	B
EC2A DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
EC2D                FAT_SKP:
EC2D 05             	DEC	B
EC2E 28 05          	JR	Z,FAT1
EC30 19             	ADD	HL,DE
EC31 93             	SUB	E
EC32 30 F9          	JR	NC,FAT_SKP
EC34 C9             	RET
EC35                FAT1:
EC35 EB             	EX	DE,HL
EC36 B9             	CP	C		;C=FATバッファに読み込めるセクタ数
EC37 38 01          	JR	C,FAT2
EC39 79             	LD	A,C
EC3A                FAT2:
EC3A 47             	LD	B,A
EC3B                
EC3B 2A FA F0       	LD	HL,(_FATPS)	;fat sector pos
EC3E 19             	ADD	HL,DE
EC3F EB             	EX	DE,HL
EC40 2A 7C F0       	LD	HL,(_FATBF)
EC43 AF             	XOR	A		;CF=0
EC44 4F             	LD	C,A
EC45 C9             	RET
EC46                ;
EC46                ;	FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
EC46                ;	FATSETUP* (FAT12/FAT16)
EC46                ;out
EC46                ;	D : FATバッファに読み込める最大のセクタ数
EC46                ;	E : _FATIXで進めるセクタ数
EC46                FATSETUP12:
EC46 11 06 06       	LD	DE,0606H	;256
EC49 D8             	RET	C
EC4A 11 03 03       	LD	DE,0303H	;512
EC4D 0F             	RRCA
EC4E D8             	RET	C
EC4F 11 01 02       	LD	DE,0201H	;1024
EC52 C9             	RET
EC53                
EC53                FATSETUP16:
EC53 11 08 08       	LD	DE,0808H	;256
EC56 D8             	RET	C
EC57 11 04 04       	LD	DE,0404H
EC5A 0F             	RRCA			;512
EC5B D8             	RET	C
EC5C 11 02 02       	LD	DE,0202H	;1024
EC5F C9             	RET
EC60                
EC60                CHGDRV:
EC60 E5             	PUSH	HL
EC61 21 89 EF       	LD	HL,_DSK
EC64 BE             	CP	(HL)
EC65 28 0A          	JR	Z,CHGDRVE
EC67                CHGDRV1:
EC67 DD E5          	PUSH	IX
EC69 CD 73 EC       	CALL	CHGDRV0
EC6C 3A 89 EF       	LD	A,(_DSK)
EC6F DD E1          	POP	IX
EC71                CHGDRVE:
EC71 E1             	POP	HL
EC72 C9             	RET
EC73                
EC73                CHGDRV0:
EC73 6F             	LD	L,A
EC74 CD DC EF       	CALL	_GETDPB
EC77 D8             	RET	C
EC78 DD 22 A8 EF    	LD	(_DPB),IX
EC7C 7D             	LD	A,L
EC7D 32 89 EF       	LD	(_DSK),A
EC80                CHGDRV2:
EC80 C5             	PUSH	BC
EC81 D5             	PUSH	DE
EC82 ED 73 DF EC    	LD	(SPPAT2+1),SP
EC86 F3             	DI
EC87 DD F9          	LD	SP,IX
EC89                
EC89 E1             	POP	HL		;DPB_00_FATLN
EC8A E1             	POP	HL		;DPB_02_DRD
EC8B 22 E3 EB       	LD	(DRDPAT+1),HL
EC8E                
EC8E E1             	POP	HL
EC8F 22 F3 EB       	LD	(DWTPAT+1),HL	;DPB_04_DWT
EC92                
EC92 E1             	POP	HL		;L=DPB_06_FATID H=DPB_07_SECPCL
EC93 7C             	LD	A,H
EC94 32 D5 E3       	LD	(SPCPAT+1),A	;1クラスタの論理セクタ数
EC97 3D             	DEC	A
EC98 32 81 EA       	LD	(NCPAT+1),A
EC9B                
EC9B E1             	POP	HL		;DPB_08_MAXCL
EC9C 7D             	LD	A,L
EC9D 32 F4 E3       	LD	(CLPAT2+1),A
ECA0 7C             	LD	A,H
ECA1 32 F0 E3       	LD	(CLPAT1+1),A
ECA4 2B             	DEC	HL
ECA5 22 EE E5       	LD	(MAXCLP+1),HL
ECA8                
ECA8 E1             	POP	HL		;L=DPB_0A_FDMODE H=DPB_0B_DIRSCNT
ECA9 7D             	LD	A,L
ECAA F6 FE          	OR	0FEH
ECAC 32 E5 ED       	LD	(FDMODE+1),A
ECAF 07             	RLCA
ECB0 E6 03          	AND	3
ECB2 32 CD ED       	LD	(FSPAT+1),A
ECB5 4C             	LD	C,H
ECB6                
ECB6 E1             	POP	HL		;L=DPB_0C_MAXCYL H=DPB_0D_MAXSEC
ECB7 7D             	LD	A,L
ECB8 32 A1 EF       	LD	(_MAXCYL),A
ECBB 7C             	LD	A,H
ECBC 32 76 ED       	LD	(MAXSEC+1),A
ECBF                
ECBF E1             	POP	HL		;L=DPB_0E_FATPS H=DPB_0F_BPS
ECC0 7C             	LD	A,H		;DPB_0F_BPS
ECC1 E6 07          	AND	7
ECC3 32 8C E8       	LD	(SECSZ+2),A	;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
ECC6                				;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM等
ECC6                				;1セクタ1024 2HD/2HDE98
ECC6                				;1セクタ256 GRAM等
ECC6                				;1024	512	256
ECC6                				;4	2	1
ECC6 87             	ADD	A,A		;8	4	2
ECC7 87             	ADD	A,A		;010H	8	4
ECC8 87             	ADD	A,A		;020H	010H	8
ECC9 32 51 E2       	LD	(SDECPAT+1),A	;1セクタ辺りのディレクトリエントリ数
ECCC                
ECCC 26 00          	LD	H,0
ECCE 22 FA F0       	LD	(_FATPS),HL
ECD1                
ECD1 E1             	POP	HL		;L=DPB_10_DIRPS
ECD2 22 FC F0       	LD	(_DIRPS),HL
ECD5                
ECD5 E1             	POP	HL		;L=DPB_12_DEVICE H=DPB_13_UNITNO
ECD6 7C             	LD	A,H
ECD7 32 84 EF       	LD	(_DRIVE),A
ECDA                
ECDA E1             	POP	HL		;DPB_14_ADDCL16
ECDB 22 E5 E3       	LD	(CLSPAT+1),HL
ECDE                
ECDE 31 00 00       SPPAT2:	LD	SP,0		;元のSPを復元
ECE1 FB             	EI
ECE2 2A FC F0       	LD	HL,(_DIRPS)
ECE5 06 00          	LD	B,0
ECE7 09             	ADD	HL,BC
ECE8 22 6C E2       	LD	(MD_PAT+1),HL
ECEB                
ECEB 2A EE E5       	LD	HL,(MAXCLP+1);
ECEE 11 F6 0F       	LD	DE,4086
ECF1 B7             	OR	A
ECF2 ED 52          	SBC	HL,DE
ECF4 30 0F          	JR	NC,SETFAT16
ECF6 21 07 EA       	LD	HL,GNCL		;FAT12
ECF9 11 2A EA       	LD	DE,SNCL
ECFC 01 46 EC       	LD	BC,FATSETUP12
ECFF DD CB 0F AE    	RES	5,(IX+00FH)	;DPB_0F_BPS(FAT12)
ED03 18 0D          	JR	EXTRA1
ED05                SETFAT16:
ED05 21 5E EA       	LD	HL,GNCL16	;FAT16
ED08 11 6B EA       	LD	DE,SNCL16
ED0B 01 53 EC       	LD	BC,FATSETUP16
ED0E DD CB 0F EE    	SET	5,(IX+00FH)	;DPB_0F_BPS(FAT16)
ED12                EXTRA1:
ED12 22 F8 EF       	LD	(GNCPAT+1),HL
ED15 ED 53 FB EF    	LD	(SNCPAT+1),DE
ED19 ED 43 1E EC    	LD	(FATSX+1),BC
ED1D D1             	POP	DE
ED1E C1             	POP	BC
ED1F AF             	XOR	A
ED20 C9             	RET
ED21                
ED21                GETDPBD:
ED21 DD E3          	EX	(SP),IX
ED23 DD E5          	PUSH	IX
ED25 3A 88 EF       	LD	A,(_DRV)
ED28 18 07          	JR	GETDPB1
ED2A                
ED2A                CHGDRVR:
ED2A CD D9 EF       	CALL	_CHGDRV
ED2D D8             	RET	C
ED2E 3A 89 EF       	LD	A,(_DSK)
ED31                GETDPB1:
ED31 C3 DC EF       	JP	_GETDPB
ED34                
ED34                GETDPB:
ED34 FE 08          	CP	8
ED36 3F             	CCF
ED37 D8             	RET	C
ED38 0F             	RRCA
ED39 0F             	RRCA
ED3A 0F             	RRCA
ED3B DD             	DB	0DDH		;Z80未定義命令
ED3C 6F             	LD	L,A		;LD	IXL,A
ED3D DD             	DB	0DDH		;Z80未定義命令
ED3E 26 F1          	LD	H,DEVICE/256	;LD	IXH,DEVICE/256
ED40 DD 7E 00       	LD	A,(IX+0)	;DPB_00_FATLN
ED43 B7             	OR	A		;CF=0の為
ED44 DD CB 0F 6E    	BIT	5,(IX+00FH)	;DPB_0F_BPS
ED48 C0             	RET	NZ		;FAT16
ED49 DD CB 12 6E    	BIT	5,(IX+012H)	;DPB_12_DEVICE
ED4D C0             	RET	NZ		;BPB
ED4E FE 01          	CP	001H		;A=0 THEN CF=1
ED50 C9             	RET
ED51                
ED51                _SYS5F:
ED51 AF             	XOR	A
ED52                FFLUSH:
ED52 F5             	PUSH	AF
ED53 3E FF          	LD	A,0FFH
ED55 32 39 EF       	LD	(SFILE),A
ED58 CD 45 E9       	CALL	DWTX
ED5B 3E FF          	LD	A,0FFH
ED5D 32 A5 EF       	LD	(_DBDRV),A
ED60 CD 8F E9       	CALL	WTFATX
ED63 AF             	XOR	A
ED64 32 AB EF       	LD	(_FATIX),A
ED67 2F             	CPL
ED68 32 AA EF       	LD	(_FATDRV),A
ED6B F1             	POP	AF
ED6C C9             	RET
ED6D                
ED6D                	INCLUDE	"X1DISK.ASM"
ED6D                
ED6D                ;	LSX-Dodgers DISK
ED6D                ;	X1/turbo/Z
ED6D                
ED6D                SEEK:
ED6D 7A             	LD	A,D
ED6E B3             	OR	E
ED6F 3E 01          	LD	A,001H
ED71 28 11          	JR	Z,DIV3
ED73                
ED73 06 10          	LD	B,16
ED75 0E 00          MAXSEC:	LD	C,000H
ED77 AF             	XOR	A
ED78 EB             	EX	DE,HL
ED79                DIV1:
ED79 29             	ADD	HL,HL
ED7A 8F             	ADC	A,A
ED7B B9             	CP	C
ED7C 38 02          	JR	C,DIV2
ED7E 91             	SUB	C
ED7F 2C             	INC	L
ED80                DIV2:
ED80 10 F7          	DJNZ	DIV1
ED82                
ED82 3C             	INC	A	;最小のセクタは１固定
ED83 55             	LD	D,L	;Quotient(TRACK)
ED84                DIV3:
ED84 5F             	LD	E,A	;Remainder
ED85 CB 3A          	SRL	D	;CYLINDER
ED87 9F             	SBC	A,A
ED88 E6 10          	AND	010H	;SIDE
ED8A 4F             	LD	C,A
ED8B                
ED8B 3A 84 EF       	LD	A,(_DRIVE)
ED8E FE 04          	CP	4
ED90 3F             	CCF
ED91 D8             	RET	C
ED92 B1             	OR	C
ED93 32 11 EE       	LD	(MOPAT+1),A	;Motor off data
ED96 01 FC 0F       	LD	BC,00FFCH
ED99 F6 80          	OR	080H		;Motor on
ED9B ED 79          	OUT	(C),A
ED9D                
ED9D CD E3 ED       	CALL	SETMODE
EDA0 D8             	RET	C
EDA1                
EDA1 CD 26 EE       	CALL	DRIVE
EDA4 FE FF          	CP	0FFH		;A=0FFH Unknown CYLINDER
EDA6 CC 05 EE       	CALL	Z,FDCRES	;Restore
EDA9 0E F9          	LD	C,0F9H
EDAB ED 79          	OUT	(C),A		;Currrent CYLINDER
EDAD 92             	SUB	D
EDAE C8             	RET	Z		;No seek
EDAF                
EDAF 3A 86 EF       	LD	A,(_ISEEK)
EDB2 4F             	LD	C,A
EDB3                
EDB3 3A A1 EF       	LD	A,(_MAXCYL)	;Max CYLINDER
EDB6 3D             	DEC	A
EDB7 BA             	CP	D		;Over CYLINDER
EDB8 D8             	RET	C
EDB9                
EDB9 B9             	CP	C		;for Built-in 2DD
EDBA 38 03          	JR	C,SETM2
EDBC 78             	LD	A,B		;B=00FH
EDBD DB FE          	IN	A,(0FEH)		;2HD mode for 2DD seek
EDBF                SETM2:
EDBF 78             	LD	A,B
EDC0 DB FD          	IN	A,(0FDH)		;MFM mode
EDC2                
EDC2 0E FB          	LD	C,0FBH
EDC4 ED 51          	OUT	(C),D
EDC6 72             	LD	(HL),D
EDC7 0E 18          	LD	C,018H		;Seek
EDC9                FDCCMD2:
EDC9 3A 85 EF       	LD	A,(_SEEKSP)
EDCC E6 FF          FSPAT:	AND	0FFH
EDCE B1             	OR	C
EDCF                
EDCF                FDCCMD:
EDCF CD 1C EE       	CALL	COMSET
EDD2                
EDD2 3E 80          FDCPAT:	LD	A,080H		;FDC COMMAND(Self-modifying code)
EDD4 E6 20          	AND	020H		;Write data Write track
EDD6 3C             	INC	A
EDD7                
EDD7                SST:
EDD7 0E 00          	LD	C,0
EDD9                SST1:
EDD9 0D             	DEC	C		; 4
EDDA 20 FD          	JR	NZ,SST1		;12 * 256 / 4 = About 1ms
EDDC 3D             	DEC	A
EDDD 20 FA          	JR	NZ,SST1
EDDF                
EDDF 3C             	INC	A		;A=1
EDE0 CD EE ED       	CALL	READY
EDE3                SETMODE:
EDE3 78             	LD	A,B		;B=00FH
EDE4 DB FF          FDMODE:	IN	A,(0FFH)	;Floppy mode(2D/2HD) (Self-modifying code)
EDE6                
EDE6 78             	LD	A,B
EDE7 DB FD          	IN	A,(0FDH)	;MFM mode
EDE9                
EDE9 CD 20 EE       	CALL	DELAY0		;Head select time
EDEC 3E 81          	LD	A,081H
EDEE                READY:
EDEE 32 F8 ED       	LD	(WAITA+1),A
EDF1 E5             	PUSH	HL
EDF2 0E F8          	LD	C,0F8H
EDF4 61             	LD	H,C
EDF5                READY2:
EDF5 ED 78          	IN	A,(C)
EDF7 E6 81          WAITA:	AND	081H		;NOT READY,BUSY
EDF9 28 08          	JR	Z,READYE
EDFB E3             	EX	(SP),HL		;wait 19clock
EDFC E3             	EX	(SP),HL		; //
EDFD 2B             	DEC	HL
EDFE 7C             	LD	A,H
EDFF B5             	OR	L
EE00 20 F3          	JR	NZ,READY2
EE02 37             	SCF
EE03                READYE:
EE03 E1             	POP	HL
EE04 C9             	RET
EE05                
EE05                FDCRES:
EE05 36 00          	LD	(HL),0
EE07 0E 08          	LD	C,8
EE09 18 BE          	JR	FDCCMD2
EE0B                
EE0B                FDMOFF:
EE0B F5             	PUSH	AF
EE0C C5             	PUSH	BC
EE0D 01 FC 0F       	LD	BC,00FFCH	;Motor off
EE10 3E 00          MOPAT:	LD	A,000H		;(Self-rewriting)
EE12 ED 79          	OUT	(C),A
EE14 C1             	POP	BC
EE15 F1             	POP	AF
EE16 C9             	RET
EE17                
EE17                SECSET:
EE17 01 FA 0F       	LD	BC,00FFAH
EE1A ED 59          	OUT	(C),E
EE1C                COMSET:
EE1C 0E F8          	LD	C,0F8H
EE1E ED 79          	OUT	(C),A
EE20                DELAY0:
EE20 3E 1A          	LD	A,26
EE22                DELAY:
EE22 3D             	DEC	A
EE23 20 FD          	JR	NZ,DELAY
EE25 C9             	RET
EE26                
EE26                DRIVE:
EE26 2A 84 EF       	LD	HL,(_DRIVE)
EE29 26 EF          	LD	H,_CYL0/256
EE2B CB FD          	SET	7,L
EE2D 7E             	LD	A,(HL)
EE2E C9             	RET
EE2F                
EE2F                RNF:
EE2F CD 26 EE       	CALL	DRIVE
EE32 36 FF          	LD	(HL),0FFH
EE34 C9             	RET
EE35                
EE35 02             RETRY:	DB	2
EE36                
EE36                
EE36                ;	FLOPPY DISK DRIVER(DMA)
EE36                
EE36                
EE36                WTTRK:
EE36 06 01          	LD	B,1
EE38 3E F4          	LD	A,0F4H
EE3A 18 02          	JR	WTTRK1
EE3C                FDWT:
EE3C 3E A0          	LD	A,0A0H
EE3E                WTTRK1:
EE3E 32 D3 ED       	LD	(FDCPAT+1),A
EE41 3E 10          	LD	A,16
EE43 18 0C          	JR	DISK
EE45                
EE45                DISKOK:
EE45 06 01          FDCNT:	LD	B,1
EE47 10 0B          	DJNZ	DISK1
EE49 C9             	RET
EE4A                
EE4A                FDRD:
EE4A 3E 80          	LD	A,080H
EE4C 32 D3 ED       	LD	(FDCPAT+1),A
EE4F 3E 0E          	LD	A,14
EE51                
EE51                DISK:
EE51 32 68 EE       	LD	(DMAPAT+1),A
EE54                DISK1:
EE54 78             	LD	A,B
EE55 32 46 EE       	LD	(FDCNT+1),A
EE58 22 EA EE       	LD	(DMAD+11),HL
EE5B                DISKR:
EE5B 3E 02          	LD	A,2		;Retry count
EE5D 32 35 EE       	LD	(RETRY),A
EE60                DISK2:
EE60 D5             	PUSH	DE
EE61 CD 6D ED       	CALL	SEEK
EE64 38 43          	JR	C,ERRF
EE66 F3             	DI
EE67                
EE67 3E 0E          DMAPAT:	LD	A,14		;自己書き換え
EE69 21 DF EE       	LD	HL,DMAD
EE6C CD F6 DF       	CALL	SETDMA
EE6F ED 49          	OUT	(C),C		;OUT 01F87H,087H WR6 イネーブル
EE71 3A D3 ED       	LD	A,(FDCPAT+1)
EE74 C5             	PUSH	BC
EE75 CD 17 EE       	CALL	SECSET
EE78 2A EA EE       	LD	HL,(DMAHL)
EE7B 23             	INC	HL
EE7C 11 06 BB       	LD	DE,0BB06H	;READ DMA
EE7F                
EE7F 3E 03          	LD	A,3
EE81 CD EE ED       	CALL	READY
EE84 ED 78          	IN	A,(C)
EE86                
EE86 C1             	POP	BC
EE87 ED 51          	OUT	(C),D		;読み出しマスク設定
EE89 ED 59          	OUT	(C),E		;バイトカウンタ(LH)
EE8B ED 58          	IN	E,(C)
EE8D ED 50          	IN	D,(C)
EE8F 19             	ADD	HL,DE
EE90 D1             	POP	DE
EE91 13             	INC	DE
EE92 FB             	EI
EE93 CD 0B EE       	CALL	FDMOFF
EE96 B7             	OR	A
EE97 28 AC          	JR	Z,DISKOK
EE99 1B             	DEC	DE
EE9A CB 67          	BIT	4,A
EE9C C4 2F EE       	CALL	NZ,RNF
EE9F                DISKE2:
EE9F 21 35 EE       	LD	HL,RETRY
EEA2 35             	DEC	(HL)
EEA3 20 BB          	JR	NZ,DISK2
EEA5 B7             	OR	A
EEA6 28 34          	JR	Z,ERR
EEA8 D5             	PUSH	DE
EEA9                ERRF:
EEA9 D1             	POP	DE
EEAA                DELP:
EEAA CD 2F EE       	CALL	RNF
EEAD CD 0B EE       	CALL	FDMOFF
EEB0 3A 85 EF       	LD	A,(_SEEKSP)
EEB3 87             	ADD	A,A
EEB4 9F             	SBC	A,A
EEB5 38 25          	JR	C,ERR
EEB7                DELP1:
EEB7 D5             	PUSH	DE
EEB8 21 C0 F0       	LD	HL,DEMES
EEBB CD 6E D8       	CALL	MSX
EEBE CD EC DB       	CALL	KEYBC
EEC1                DELP2:
EEC1 CD CA EF       	CALL	_INKEY
EEC4 28 FB          	JR	Z,DELP2
EEC6                
EEC6 D1             	POP	DE
EEC7 CD F6 E3       	CALL	CAP
EECA FE 52          	CP	'R'		;Retry
EECC CA 5B EE       	JP	Z,DISKR
EECF FE 49          	CP	'I'		;Ignore
EED1 28 07          	JR	Z,IGNORE
EED3 FE 41          	CP	'A'		;Abort
EED5 20 E0          	JR	NZ,DELP1
EED7 C3 00 EF       	JP	CPM_BOOT
EEDA                IGNORE:
EEDA 3E FF          	LD	A,0FFH
EEDC                ERR:
EEDC BF             	CP	A
EEDD 37             	SCF
EEDE C9             	RET
EEDF                
EEDF                			;X1turbo DISK DMA
EEDF C3             DMAD:	DB	0C3H	;WR6 リセット
EEE0 7D             	DB	07DH	;WR0 ポートA→ポートB 転送
EEE1 FB 0F          	DW	00FFBH	;ポートA開始アドレス FDC データレジスタ
EEE3 FF FF          	DW	0FFFFH	;ブロック長(転送サイズ-1)
EEE5 2C             	DB	02CH	;WR1 ポートAアドレス固定 I/O
EEE6 10             	DB	010H	;WR2 ポートBインクリメント
EEE7 80             	DB	080H	;WR3
EEE8 92             	DB	092H	;WR5 WAIT RDY:LOW
EEE9 8D             	DB	08DH	;WR4 バイト ポートB開始アドレス(LH)
EEEA 00 00          DMAHL:	DW	0	;ポートB開始アドレス
EEEC CF             	DB	0CFH	;WR6 ロード
EEED 01             	DB	001H	;WR0 ポートB←ポートB 転送
EEEE CF             	DB	0CFH	;WR6 ロード
EEEF                
EEEF                DMAE:
EEEF                
EEEF 00 00 1E 98    AT_R	EQU	WTTRK-AT_WTTRK
EEEF                
EEEF                	INCLUDE	"LDWORK.ASM"
EEEF                
EEEF                ;	LSX-Dodgers WORK0
EEEF                ;
EEEF                ;	CP/M互換BIOS
EEEF                ;	BOOT:アドレス下位1バイトが0になるように
EEEF                AT_WORK:
EEEF                	DS	WORKAD-AT_WORK
EF00                
EF00                CPM_BOOT:
EF00 C3 00 00       	JP	0
EF03                _SYS00:		;(BDOS)プログラム終了
EF03                CPM_WBOOT:
EF03 C3 09 D1       	JP	WBOOT1
EF06                CPM_CONST:
EF06 C3 A6 DC       	JP	CONSTX
EF09                _SYS07:		;(BDOS)コンソール直接入力
EF09                CPM_CONIN:
EF09 C3 4D DC       	JP	FLGET
EF0C                CPM_CONOUT:
EF0C C3 E7 DE       	JP	CONOUT1
EF0F                
EF0F                DECBF:
EF0F                	DS	5
EF14 00             FDRV	DB	0
EF15                FNAME	DS	36
EF39                SFILE:	DS	33		;DRV FILENAME
EF5A                HLBUF:	DS	3		;Random record buffer
EF5D                
EF5D 00 00          LEFTX:	DW	0
EF5F 00 00          DTAX:	DW	0
EF61                
EF61 00 8E 01 00    BEEPD:	DB	0,08EH,1,0,00BH,0,00CH,010H
EF65 0B 00 0C 10
EF69 07 3E 08 10    	DB	007H,03EH,008H,010H,00DH,0,0FFH
EF6D 0D 00 FF
EF70                
EF70 00             CHECK:	DB	0
EF71                
EF71 4F 4B 24       OK:	DB	"OK$"
EF74 53 6B 69 70    SKIP:	DB	"Skip$"
EF78 24
EF79 45 72 72 6F    COMERM:	DB	"Error!$"
EF7D 72 21 24
EF80                ;	システムワークエリア
EF80                ;	_CYL0:アドレス下位1バイトが080Hになるように
EF80 FF             _CYL0:	DB	0FFH	;Cylinder
EF81 FF             _CYL1:	DB	0FFH	;Cylinder
EF82 FF             _CYL2:	DB	0FFH	;Cylinder
EF83 FF             _CYL3:	DB	0FFH	;Cylinder
EF84 00             _DRIVE:	DB	0	;unit number
EF85 00             _SEEKSP:DB	0	;Seek speed
EF86 FF             _ISEEK:	DB	0FFH	;
EF87 00             _DVSW:	DB	0
EF88 00             _DRV:	DB	0
EF89 FF             _DSK:	DB	0FFH
EF8A 80 00          _DTA:	DW	00080H
EF8C 00 00          _CTC:	DW	0
EF8E 00 00          _TXADR:	DW	0
EF90 00 00          _KEYPS:	DW	0
EF92 00 FF          _KEYD:	DW	0FF00H	;キーデータ
EF94 C2 10          _KEYSP:	DW	010C2H
EF96 07             _COLORF:DB	COLORF	;色
EF97 18             _LINE:	DB	LINE
EF98                
EF98 00 00          _FCB:	DW	0
EF9A 00 00          _FBPS:	DW	0	;SEARCH FILES
EF9C 00 00          _FBAD:	DW	0	;    //
EF9E 00             _FBCNT:	DB	0	;    //
EF9F 00             _FILEN:	DB	0
EFA0 00             _DIRF:	DB	0	;bit7:ディレクトリ bit0-6:セクタインデックス
EFA1 00             _MAXCYL:DB	0
EFA2 00             _WTFATF:DB	0	;FATバッファの更新フラグ
EFA3                		DS	1
EFA4 00             _WTDBF:	DB	0	;データバッファの更新フラグ
EFA5 FF             _DBDRV:	DB	0FFH	;データバッファにあるデータを読み込んだドライブ
EFA6 00 00          _DBSEC:	DW	0	;データバッファにあるデータを読み込んだセクタ番号
EFA8 00 00          _DPB:	DW	0
EFAA                _FATDRV:
EFAA FF             	DB	0FFH	;FATバッファに読み込んでいるドライブ
EFAB 00             _FATIX:	DB	0	;FATバッファに読み込んでいるインデックス
EFAC                _FAKEFREE:
EFAC 00 00          	DW	0	;偽の残量（FATサイズが大きくなると重くなるのでその対策）
EFAE                
EFAE                	DS	2
EFB0                
EFB0 6F 50 59 38    CRTCD:	DB	06FH,WIDTH,059H,038H,01FH,002H,019H,01CH
EFB4 1F 02 19 1C
EFB8 00 07          	DB	000H,007H
EFBA 80 F8 B0 FF    	DW	0-WIDTH*LINE,0-WIDTH
EFBE 0C             	DB	00CH
EFBF 20             WK1FD0:	DB	020H
EFC0                
EFC0 55 DB          CTC0:	DW	INTCTCE
EFC2 55 DB          CTC1:	DW	INTCTCE
EFC4 77 DB          CTC2:	DW	INTCTC2
EFC6 55 DB          CTC3:	DW	INTCTCE
EFC8 3E DB          INTVEC:	DW	INT
EFCA                
EFCA                ;	LSX-Dodgers 独自BIOS
EFCA                
EFCA C3 CA E0       _INKEY:	JP	INKEY
EFCD C3 74 DD       _PRINT:	JP	PRINT
EFD0 C3 34 E0       _SCRN:	JP	SCRN
EFD3 C3 5C E0       _POS:	JP	POS
EFD6 C3 B0 DE       _LOC:	JP	LOC
EFD9                _CHGDRV:
EFD9 C3 60 EC       	JP	CHGDRV
EFDC                _GETDPB:
EFDC C3 34 ED       	JP	GETDPB
EFDF                _FFLUSH:
EFDF C3 52 ED       	JP	FFLUSH
EFE2                _RDFATX:
EFE2 C3 65 E9       	JP	RDFATX
EFE5 C3 8D EA       _RDFAT:	JP	RDFAT
EFE8 C3 36 EE       _WTTRK:	JP	WTTRK
EFEB C3 4A EE       _FDRD:	JP	FDRD
EFEE C3 3C EE       _FDWT:	JP	FDWT
EFF1                _BPB2DPB:
EFF1 C3 F2 EA       	JP	BPB2DPB
EFF4                	DS	3
EFF7                _GNCL:
EFF7 C3 07 EA       GNCPAT:	JP	GNCL		; self-modifying code
EFFA                _SNCL:
EFFA C3 2A EA       SNCPAT:	JP	SNCL		; self-modifying code
EFFD C3 87 D1       _COMANL:JP	COMANL
F000                
F000                _WE:
F000                	INCLUDE	"LDCALL.ASM"
F000                
F000                ;	LSX-Dodgers システムコール(BDOS)
F000                ;
F000                ;	LSX-Dodgers SYSTEM CALL
F000                ;	STABLE:アドレス下位1バイトが0になるように
F000                
F000                STABLE:
F000                ;0
F000 03 EF 20 DC    	DW	_SYS00,_SYS01,_SYS02,_SYS03
F004 2C DC 7E E2
F008 5D D8 5D D8    	DW	_SYS04,_SYS05,_SYS06,_SYS07
F00C 31 DC 09 EF
F010 39 DC 5F D8    	DW	_SYS08,_SYS09,_SYS0A,_SYS0B
F014 72 DC 9E DC
F018 74 D8 79 D8    	DW	_SYS0C,_SYS0D,_SYS0E,_SYS0F
F01C 88 D8 9B D8
F020                ;1
F020 EF D8 36 D9    	DW	_SYS10,_SYS11,_SYS12,_SYS13
F024 7F D9 B5 D9
F028 BD D9 DB D9    	DW	_SYS14,_SYS15,_SYS16,_SYS17
F02C F8 D9 F0 D9
F030 59 DA 5E DA    	DW	_SYS18,_SYS19,_SYS1A,_SYS1B
F034 63 DA 69 DA
F038 5D D8 8F DA    	DW	_SYS1C,_SYS1D,_SYS1E,_SYS1F
F03C 5D D8 93 DA
F040                ;2
F040 5D D8 2F DA    	DW	_SYS20,_SYS21,_SYS22,_SYS23
F044 44 DA 9A DA
F048 B9 DA 5D D8    	DW	_SYS24,_ERROR,_SYS26,_SYS27
F04C BA E6 9B E7
F050 44 DA C2 DA    	DW	_SYS28,_SYS5C,_SYS2A,_SYS2B
F054 B4 DC 7E E2
F058 E8 DC 7E E2    	DW	_SYS2C,_SYS2D,_SYS2E,_SYS2F
F05C 5D D8 E5 DA
F060                ;3
F060 DF DA 5D D8    	DW	_SYS30,_ERROR,_ERROR,_ERROR
F064 5D D8 5D D8
F068 5D D8 5D D8    	DW	_ERROR,_ERROR,_ERROR,_ERROR
F06C 5D D8 5D D8
F070 5D D8 7E E2    	DW	_ERROR,_SYS39,_SYS3A,_SYS5A
F074 7E E2 06 DB
F078                ;DOS2
F078 40 D8          	DW	_DOS2
F07A                
F07A                	DS	2
F07C 00 F2          _FATBF:	DW	FATBF
F07E 00 FA          _DTBUF:	DW	DTBUF
F080                
F080                ;	コントロールコードテーブル
F080                ;	CTRLTB:アドレス下位1バイトが080Hになるように
F080                
F080                CTRLTB:
F080 25 DE 25 DE    	DW	CTRL00,CTRL00,CTRL02,CTRL03	;  A,B,C
F084 61 DE A8 DF
F088 A2 DF 85 DE    	DW	CTRL04,CTRL05,CTRL06,CTRL07	;D,E,F,G
F08C 81 DF 08 DF
F090 31 DE 52 DE    	DW	CTRL08,CTRL09,CTRL0A,CTRL0B	;H,I,J,K
F094 AB DF C6 DE
F098 7E DF AB DE    	DW	CTRL0C,CTRL0D,CTRL0E,CTRL00	;L,M,N,O
F09C C0 DF 25 DE
F0A0 25 DE 25 DE    	DW	CTRL00,CTRL00,CTRL12,CTRL00	;P,Q,R,S
F0A4 BE DE 25 DE
F0A8 25 DE 25 DE    	DW	CTRL00,CTRL00,CTRL00,CTRL00	;T,U,V,W
F0AC 25 DE 25 DE
F0B0 25 DE 25 DE    	DW	CTRL00,CTRL00,CTRL0C,CTRL1B	;X,Y,Z,ESC
F0B4 7E DF CD DE
F0B8 4C DE 38 DE    	DW	CTRL1C,CTRL1D,CTRL1E,CTRL1F	;→,←,↑,↓
F0BC 41 DE AB DF
F0C0                
F0C0 03 07          DEMES:	DB	3,7
F0C2 44 65 76 69    	DB	"Device I/O Error",5,3
F0C6 63 65 20 49
F0CA 2F 4F 20 45
F0CE 72 72 6F 72
F0D2 05 03
F0D4 41 62 6F 72    	DB	"Abort Retry Ignore?",5,3,0
F0D8 74 20 52 65
F0DC 74 72 79 20
F0E0 49 67 6E 6F
F0E4 72 65 3F 05
F0E8 03 00
F0EA                
F0EA 16 17          SDDATA:	DB	22,23		;(FCB)ファイルを最後に変更した時刻
F0EC 14 15          	DB	20,21		;(FCB)ファイルを最後に変更した日付
F0EE 1A 1B          	DB	26,27		;(FCB)ファイルの先頭クラスタ
F0F0 10 11 12 13    	DB	16,17,18,19	;(FCB)ファイルのサイズ(バイト単位)
F0F4                SDDATAE:
F0F4                
F0F4                SCDIR:	DS	2		;+14 +15
F0F6                SFBPS:	DS	2		;FBPS
F0F8                SFNDF:	DS	2		;FILEN DIRF
F0FA                
F0FA 00 00          _FATPS:	DW	0
F0FC 00 00          _DIRPS:	DW	0
F0FE 00 00          _CLPS:	DW	0
F100                
F100                _PE:
F100                	INCLUDE	"X1DPB.ASM"
F100                
F100                ;	LSX-Dodgers DPB
F100                ;	X1/turbo/Z
F100                
F100                DEVICE:
F100                
F100                ;	A:
F100                
F100 02 00          	DW	2	;DPB_00_FATLN
F102 EB EF          	DW	_FDRD	;DPB_02_DRD
F104 EE EF          	DW	_FDWT	;DPB_04_DWT
F106 FD             	DB	0FDH	;DPB_06_FATID
F107 02             	DB	2	;DPB_07_SECPCL
F108 64 01          	DW	356	;DPB_08_MAXCL
F10A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F10B 07             	DB	7	;DPB_0B_DIRSCNT
F10C 28             	DB	40	;DPB_0C_MAXCYL
F10D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F10E 01             	DB	1	;DPB_0E_FATPS
F10F 82             	DB	082H	;DPB_0F_BPS
F110 05 00          	DW	5	;DPB_10_DIRPS
F112 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F113 00             	DB	0	;DPB_13_UNITNO
F114 08 00          	DW	8	;DPB_14_ADDCL16
F116 00 00          	DW	0	;DPB_16
F118 00 00          	DW	0	;DPB_18
F11A 00 00          	DW	0	;DPB_1A_SDIR
F11C 46 44 44 30    	DB	"FDD0"	;DPB_1C_NAME
F120                
F120                ;	B:
F120                
F120 02 00          	DW	2	;DPB_00_FATLN
F122 EB EF          	DW	_FDRD	;DPB_02_DRD
F124 EE EF          	DW	_FDWT	;DPB_04_DWT
F126 FD             	DB	0FDH	;DPB_06_FATID
F127 02             	DB	2	;DPB_07_SECPCL
F128 64 01          	DW	356	;DPB_08_MAXCL
F12A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F12B 07             	DB	7	;DPB_0B_DIRSCNT
F12C 28             	DB	40	;DPB_0C_MAXCYL
F12D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F12E 01             	DB	1	;DPB_0E_FATPS
F12F 82             	DB	082H	;DPB_0F_BPS
F130 05 00          	DW	5	;DPB_10_DIRPS
F132 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F133 01             	DB	1	;DPB_13_UNITNO
F134 08 00          	DW	8	;DPB_14_ADDCL16
F136 00 00          	DW	0	;DPB_16
F138 00 00          	DW	0	;DPB_18
F13A 00 00          	DW	0	;DPB_1A_SDIR
F13C 46 44 44 31    	DB	"FDD1"	;DPB_1C_NAME
F140                
F140                ;	C:
F140                
F140 02 00          	DW	2	;DPB_00_FATLN
F142 EB EF          	DW	_FDRD	;DPB_02_DRD
F144 EE EF          	DW	_FDWT	;DPB_04_DWT
F146 FD             	DB	0FDH	;DPB_06_FATID
F147 02             	DB	2	;DPB_07_SECPCL
F148 64 01          	DW	356	;DPB_08_MAXCL
F14A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F14B 07             	DB	7	;DPB_0B_DIRSCNT
F14C 28             	DB	40	;DPB_0C_MAXCYL
F14D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F14E 01             	DB	1	;DPB_0E_FATPS
F14F 82             	DB	082H	;DPB_0F_BPS
F150 05 00          	DW	5	;DPB_10_DIRPS
F152 A7             	DB	0A7H	;DPB_12_DEVICE	Device Number
F153 02             	DB	2	;DPB_13_UNITNO
F154 08 00          	DW	8	;DPB_14_ADDCL16
F156 00 00          	DW	0	;DPB_16
F158 00 00          	DW	0	;DPB_18
F15A 00 00          	DW	0	;DPB_1A_SDIR
F15C 46 44 44 32    	DB	"FDD2"	;DPB_1C_NAME
F160                
F160                ;	D:
F160                
F160 02 00          	DW	2	;DPB_00_FATLN
F162 EB EF          	DW	_FDRD	;DPB_02_DRD
F164 EE EF          	DW	_FDWT	;DPB_04_DWT
F166 FD             	DB	0FDH	;DPB_06_FATID
F167 02             	DB	2	;DPB_07_SECPCL
F168 64 01          	DW	356	;DPB_08_MAXCL
F16A FF             	DB	0FFH	;DPB_0A_FDMODE	0FFH=2D / 0FEH=2HD
F16B 07             	DB	7	;DPB_0B_DIRSCNT
F16C 28             	DB	40	;DPB_0C_MAXCYL
F16D 09             	DB	9	;DPB_0D_MAXSEC	Number of sectors
F16E 01             	DB	1	;DPB_0E_FATPS
F16F 82             	DB	082H	;DPB_0F_BPS
F170 05 00          	DW	5	;DPB_10_DIRPS
F172 A7             	DB	0A7H	;DPB_12_DEVICE
F173 03             	DB	3	;DPB_13_UNITNO
F174 08 00          	DW	8	;DPB_14_ADDCL16
F176 00 00          	DW	0	;DPB_16
F178 00 00          	DW	0	;DPB_18
F17A 00 00          	DW	0	;DPB_1A_SDIR
F17C 46 44 44 33    	DB	"FDD3"	;DPB_1C_NAME
F180                
F180                ;	E:
F180                
F180 00 00          EMMFL:	DW	0	;DPB_00_FATLN
F182 D0 D7          EMMRD:	DW	EDRD	;DPB_02_DRD
F184 CC D7          EMMWR:	DW	EDWT	;DPB_04_DWT
F186 FE             	DB	0FEH	;DPB_06_FATID
F187 02             	DB	2	;DPB_07_SECPCL
F188 00 00          EMMCL:	DW	0	;DPB_08_MAXCL
F18A 00             	DB	0	;DPB_0A_FDMODE
F18B 0C             	DB	12	;DPB_0B_DIRSCNT
F18C 00             	DB	0	;DPB_0C_MAXCYL
F18D 00             	DB	0	;DPB_0D_MAXSEC
F18E 02             	DB	2	;DPB_0E_FATPS
F18F 02             	DB	2	;DPB_0F_BPS
F190 0A 00          	DW	10	;DPB_10_DIRPS
F192 06             	DB	6	;DPB_12_DEVICE
F193 00             	DB	0	;DPB_13_UNITNO
F194 12 00          	DW	18	;DPB_14_ADDCL16
F196 00 00          	DW	0	;DPB_16
F198 00 00          	DW	0	;DPB_18
F19A 00 00          	DW	0	;DPB_1A_SDIR
F19C 45 4D 4D 30    	DB	"EMM0"	;DPB_1C_NAME
F1A0                
F1A0                ;	F:
F1A0                
F1A0 00 00          BANKFL:	DW	0	;DPB_00_FATLN
F1A2 67 D7          	DW	BDRD	;DPB_02_DRD
F1A4 63 D7          	DW	BDWT	;DPB_04_DWT
F1A6 F9             	DB	0F9H	;DPB_06_FATID
F1A7 02             	DB	2	;DPB_07_SECPCL
F1A8 00 00          BANKCL:	DW	0	;DPB_08_MAXCL
F1AA 00             	DB	0	;DPB_0A_FDMODE
F1AB 08             	DB	8	;DPB_0B_DIRSCNT
F1AC 00             	DB	0	;DPB_0C_MAXCYL
F1AD 01             	DB	1	;DPB_0D_MAXSEC
F1AE 00             	DB	0	;DPB_0E_FATPS
F1AF 02             	DB	2	;DPB_0F_BPS
F1B0 02 00          	DW	2	;DPB_10_DIRPS
F1B2 0B             	DB	00BH	;DPB_12_DEVICE
F1B3 00             	DB	0	;DPB_13_UNITNO
F1B4 06 00          	DW	6	;DPB_14_ADDCL16
F1B6 00 00          	DW	0	;DPB_16
F1B8 00 00          	DW	0	;DPB_18
F1BA 00 00          	DW	0	;DPB_1A_SDIR
F1BC 42 52 41 4D    	DB	"BRAM"	;DPB_1C_NAME
F1C0                
F1C0                ;	G:
F1C0                
F1C0 02 00          	DW	2	;DPB_00_FATLN
F1C2 24 D7          	DW	GDRD	;DPB_02_DRD
F1C4 3B D7          	DW	GDWT	;DPB_04_DWT
F1C6 FA             	DB	0FAH	;DPB_06_FATID
F1C7 01             	DB	1	;DPB_07_SECPCL
F1C8 B8 00          	DW	184	;DPB_08_MAXCL
F1CA 00             	DB	0	;DPB_0A_FDMODE
F1CB 07             	DB	7	;DPB_0B_DIRSCNT
F1CC 00             	DB	0	;DPB_0C_MAXCYL
F1CD 01             	DB	1	;DPB_0D_MAXSEC
F1CE 01             	DB	1	;DPB_0E_FATPS
F1CF 01             	DB	1	;DPB_0F_BPS
F1D0 03 00          	DW	3	;DPB_10_DIRPS
F1D2 05             	DB	5	;DPB_12_DEVICE
F1D3 01             	DB	1	;DPB_13_UNITNO
F1D4 08 00          	DW	8	;DPB_14_ADDCL16
F1D6 00 00          	DW	0	;DPB_16
F1D8 00 00          	DW	0	;DPB_18
F1DA 00 00          	DW	0	;DPB_1A_SDIR
F1DC 47 52 41 4D    	DB	"GRAM"	;DPB_1C_NAME
F1E0                
F1E0                ;	H:
F1E0                	DS	31
F1FF 00             	DB	0
F200                
F200                LAST_ADR:
F200                
F200                	END
F200                
