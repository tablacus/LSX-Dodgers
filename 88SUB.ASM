
;	LSX-Dodgers SUB DISK SYSTEM
;	PC-8801mkIISR

AT_DSS:
	ORG	DSS,AT_DSS-OFFSET
READDISKEX:
	CALL	GETPARAMS
	XOR	A
	LD	(RETRY_RDDISK),A
	LD	HL,(S_PARAMS+2)
	LD	A,L
	DEC	A
	OR	H
	JR	NZ,RDDISK0
	LD	HL,(S_PARAMS+5)
	LD	A,H
	CP	L
	JR	NZ,RDDISK0
	LD	A,3
	LD	(RETRY_RDDISK),A
RDDISK0:
	LD	A,46H		;READ DATA
	CALL	FDCOMMAND
	JR	C,FINISH_DISK
	CALL	RDDISK1
WRDISK3:
	LD	A,B
	OR	D
	LD	(S_LEFT),A
	IN	A,(0F8H)	;FDC μPD765A TC入力
	EI
	HALT
	CALL	CHECKRESULT
	JR	NC,FINISH_DISK0
RETRY_RDDISK	EQU	$+1
	LD	A,0
	OR	A
	JR	Z,FINISH_DISK0
	DEC	A
	LD	(RETRY_RDDISK),A
	LD	A,(S_PARAMS+5)
	CP	4
	JR	NC,RETRY_RDDISK1
	ADD	A,A
	JR	RETRY_RDDISK2
RETRY_RDDISK1:
	LD	A,1
RETRY_RDDISK2:
	LD	H,A
	LD	L,A
	LD	(S_PARAMS+5),HL
	JP	RDDISK0
FINISH_DISK0:
	LD	A,(S_LEFT)
	SUB	1
	CCF
FINISH_DISK:
	SBC	A,A
	LD	(S_CMD_STATUS),A
	JP	MAIN

WRITEDISKEX:
	XOR	A
	LD	(RETRY_RDDISK),A
	CALL	GETPARAMS
	LD	A,45H		;WRITE DATA
	CALL	FDCOMMAND
	JR	C,FINISH_DISK
	CALL	WRDISK1
	JR	WRDISK3

GETPARAMS:
	LD	B,8
	PUSH	HL
	LD	HL,S_PARAMS
GETPARAMS1:
	RST	10H
	LD	(HL),A
	INC	HL
	DJNZ	GETPARAMS1
	POP	HL
	RET

FDCOMMAND:
	PUSH	AF
	LD	A,(S_PARAMS+4)	;MFMモード切り替え $FF:2D/2DD $FE:2HD
	RRA
	CCF
	SBC	A,A
	PUSH	AF
	AND	5
	LD	C,A
	LD	A,(S_PARAMS+7)	;シリンダ数
	ADD	A,0-45		;オーバートラックを考慮して40+α
	SBC	A,A
	AND	4
	OR	C
	LD	C,0FFH-5	;マスク
	LD	B,A
	LD	A,(S_PARAMS)	;0:ドライブA 1:ドライブB
	OR	A
	JR	Z,SET_WKF4
	SLA	B
	RLC	C
SET_WKF4:
	LD	A,(S_WKF4)
	AND	C
	OR	B
	AND	0FFH-020H	;CLKの分は抜いておく
	LD	B,A
	POP	AF
	AND	020H		;bit5:CLK
	LD	C,A
	LD	A,(S_WKF4)
	AND	0FFH-020H	;020Hのマスク
	OR	C
	OUT	(0F4H),A	;ドライブ制御(TPIが1になる場合はTPIを切り替える前(8ステート以上)にCLKを設定しておく必要がある)
	LD	A,B		;T=4
	OR	C		;T=4
	OUT	(0F4H),A	;ドライブ制御
	LD	A,B		;T=4
	LD	(S_WKF4),A	;T=13
	OUT	(0F4H),A	;ドライブ制御(CLK=0)

	LD	BC,(S_PARAMS)
	LD	DE,(S_PARAMS+2)
	LD	A,D		;TRACK
	SRL	A		;CYLINDER
	LD	A,00FH		;SEEK
	JR	NZ,SEEK1	;0シリンダの場合はRECALIBRATE、それ以外はSEEKを使う
	LD	A,7		;RECALIBRATE
SEEK1:
	RST	20H
	LD	A,C		;DR/HD
	RST	20H
	LD	A,D		;TRACK
	SRL	A		;CYLINDER
	CALL	NZ,20H		;SEEKの場合だけ呼ぶ(0シリンダの場合はRECALIBRATEを使うのでシリンダの設定は不要)
	EI
	HALT
	LD	A,8		;SENSE
	RST	20H
	CALL	RDFDC		;ST0
	CALL	RDFDC		;PCN(CYLINDER)
	PUSH	HL
	LD	HL,04000H
WAIT_SEEK:
	CALL	GETDEVSTAT
	AND	8
	JR	NZ,SEEK_OK
	DEC	HL
	LD	A,H
	OR	L
	JR	NZ,WAIT_SEEK
	POP	HL
	POP	AF
	SCF
	RET
SEEK_OK:
	POP	HL
	POP	AF
	RST	20H
	LD	A,D		;HD US1 US0
	AND	1
	ADD	A,A
	ADD	A,A
	OR	C
	RST	20H
	LD	A,D		;C
	SRL	A
	RST	20H
	LD	A,D		;H
	AND	1
	RST	20H
	LD	A,E		;R
	RST	20H
	LD	A,(S_PARAMS+5)	;N
	CP	4
	JR	C,FDCOMMAND2

	LD	A,3
FDCOMMAND2:
	LD	E,020H		;NO SERVICE
	RST	20H

	LD	HL,DSS_DATA	;開始アドレス
	LD	A,B		;EOT
	RST	20H

	LD	BC,000FBH	;B:バイト数L C:FDC μPD765A データレジスタ
	LD	A,054H		;GSL
	RST	20H

	LD	A,(S_PARAMS+6)
	LD	D,A		;バイト数H

	XOR	A		;DTL
	RST	20H
	AND	A
	RET

RDDISK1:			;高速化の為にループ展開x8
	EI
	HALT
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	AND	E		;NO SERVICE
	RET	Z
	INI

	EI
	HALT
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	AND	E		;NO SERVICE
	RET	Z
	INI

	EI
	HALT
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	AND	E		;NO SERVICE
	RET	Z
	INI

	EI
	HALT
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	AND	E		;NO SERVICE
	RET	Z
	INI

	EI
	HALT
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	AND	E		;NO SERVICE
	RET	Z
	INI

	EI
	HALT
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	AND	E		;NO SERVICE
	RET	Z
	INI

	EI
	HALT
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	AND	E		;NO SERVICE
	RET	Z
	INI

	EI
	HALT
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	AND	E		;NO SERVICE
	RET	Z
	INI

	JR	NZ,RDDISK1
	DEC	D
	JP	NZ,RDDISK1
	RET

WRDISK1:			;高速化の為にループ展開x8
	EI
	HALT
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	AND	E
	RET	Z
	OUTI

	EI
	HALT
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	AND	E
	RET	Z
	OUTI

	EI
	HALT
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	AND	E
	RET	Z
	OUTI

	EI
	HALT
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	AND	E
	RET	Z
	OUTI

	EI
	HALT
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	AND	E
	RET	Z
	OUTI

	EI
	HALT
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	AND	E
	RET	Z
	OUTI

	EI
	HALT
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	AND	E
	RET	Z
	OUTI

	EI
	HALT
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	AND	E
	RET	Z
	OUTI

	JR	NZ,WRDISK1
	DEC	D
	JP	NZ,WRDISK1
	RET

RESULTEX:
	LD	A,(S_CMD_STATUS)
	INC	A
	JR	Z,RESULTEX1
	LD	A,(S_PARAMS+6)	;バイト数H
RESULTEX1:
	RST	18H
	JP	MAIN

CHECKRESULT:
	PUSH	BC
	CALL	RDFDC		;ST0
	AND	0D8H
	LD	C,A
	CALL	RDFDC		;ST1
	AND	0B7H
	OR	C
	LD	C,A
	CALL	RDFDC		;ST2
	AND	073H
	OR	C
	LD	C,A
	LD	B,4
CHECKRESULT1:			;C H R N
	CALL	RDFDC
	DJNZ	CHECKRESULT1
	LD	A,C
	AND	A
	POP	BC
	RET	Z
	SCF
	RET

GETDEVSTAT:
	LD	A,4
	RST	20H
	LD	A,C
	RST	20H

RDFDC:
	IN	A,(0FAH)	;FDC μPD765A ステータスレジスタリード
	CPL
	AND	0C0H		;RQMとDIOが両方1になるまで待つ
	JR	NZ,RDFDC
	IN	A,(0FBH)	;FDC μPD765A データレジスタリード
	RET

S_PARAMS:
	DS	8
S_CMD_STATUS:
	DB	0
S_LEFT:
	DB	0
S_WKF4:
	DB	0

	ORG	$$+OFFSET	;$DEPHASE
AT_DSSE:
INITE:
	DS	BDOS-INITE
	JP	BDOS_RF
