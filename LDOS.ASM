
;	LSX-Dodgers OS

BDOS0:
	LD	A,C
	CP	031H
	JR	NC,_ERROR
	LD	(BDSP+1),SP
	LD	SP,EXTSP
	PUSH	HL
	PUSH	BC
	SLA	C
	LD	B,STABLE/256
	LD	A,(BC)
	LD	L,A
	INC	BC
	LD	A,(BC)
	LD	H,A
	LD	(BDOS1+1),HL
	POP	BC
	POP	HL
BDOS1:	CALL	0

BDSP:	LD	SP,0
	RET

_ERROR:
	LD	BC,00132H
	LD	DE,VER
_SYS1C:
_SYS1E:
_SYS20:
_SYS2E:
	XOR	A
	RET

_SYS09:
	PUSH	DE
_SX09:
	LD	A,(DE)
	INC	DE
	CP	"$"
	JR	Z,SX0E2
	PUSH	DE
	LD	E,A
	CALL	_SYS02
	POP	DE
	JR	_SX09

_SYS0C:
	LD	HL,00022H
	XOR	A
	LD	A,L
	RET

_SYS0D:
	CALL	_FFLUSH
	PUSH	HL
	LD	HL,00080H
	LD	(_DTA),HL
	POP	HL
	PUSH	DE
	LD	E,0
	DB	03EH

_SYS0E:
	PUSH	DE
	LD	A,E
	PUSH	IX
	CALL	_GETDPB
	POP	IX
	JR	C,SX0E2
	LD	A,E
	LD	(_DVSW),A
SX0E2:
	LD	A,8
	POP	DE
	RET

_SYS0F:
	CALL	SETDRV
	LD	A,(IY+28)	;Open
	ADD	A,002H		;Write
	JR	Z,FEND0F
	CALL	CHKWILDX

	CALL	NC,SOPENX
_S16XX:
	JR	C,FEND0F
				;Directory location
	LD	A,(_FILEN)
	LD	(IY+25),A
;				_DIRF
	LD	A,(_DIRF)
	LD	(IY+29),A
;				_FBPS
	LD	(IY+30),E
	LD	(IY+31),D
;				Open(Read)
	LD	(IY+28),0FFH
;				FILENAME
	PUSH	IY
	POP	DE
	INC	DE
	LD	BC,11
	LDIR
;				Attribute
	LD	A,(HL)
	LD	(IY+13),A
;				TIME
	LD	DE,11
	ADD	HL,DE
	LD	A,(HL)
	INC	HL
	LD	(IY+22),A
	LD	A,(HL)
	INC	HL
	LD	(IY+23),A
;				DATE
	LD	A,(HL)
	INC	HL
	LD	(IY+20),A
	LD	A,(HL)
	INC	HL
	LD	(IY+21),A
;				First cluster
	LD	A,(HL)
	INC	HL
	LD	(IY+26),A
	LD	A,(HL)
	INC	HL
	LD	(IY+27),A
;				SIZE
	LD	A,(HL)
	INC	HL
	LD	(IY+16),A
	LD	A,(HL)
	INC	HL
	LD	(IY+17),A
	LD	A,(HL)
	INC	HL
	LD	(IY+18),A
	LD	A,(HL)
	LD	(IY+19),A
	XOR	A
	LD	(IY+12),A
	LD	(OFCB+1),IY
FEND0F:
	JP	FEND

_SYS10:
	CALL	SETDRV
	LD	A,(IY+28)	;Open
	SUB	0FEH
	SCF
	CCF
	JR	NZ,FEND10
_S10A:				;Write
	LD	(IY+14),A
	LD	(IY+15),A

	INC	(IY+28)		;0FEH->0FFH
	CALL	SETTMS

	LD	A,(IY+29)
	LD	(_DIRF),A
	LD	E,(IY+30)
	LD	D,(IY+31)
	CALL	DC
	JR	C,FEND

	LD	A,(IY+25)
	ADD	A,A
	ADD	A,A
	ADD	A,A
IBM2:	AND	0FFH		;ooo 07FH
	LD	L,A
	LD	H,0
	ADD	HL,HL
	ADD	HL,HL
	LD	BC,(_DTBUF)
	ADD	HL,BC

	CALL	SDIRENT
FEND10:
	JR	FEND

OPENDD:
	LD	(IY+28),0FDH
	LD	(IY+13),020H
	CALL	SETTMSX
	JR	FEND

_SYS11:
	CALL	SETDRV
	CALL	CHKDDX
	JR	C,_S11A
	PUSH	IY
	POP	HL
	LD	DE,(_DTA)
	LD	BC,12
	LDIR
	LD	A,020H
	LD	(DE),A
	INC	DE
	LD	H,D
	LD	L,E
	INC	DE
	LD	C,19
	LD	(HL),B
	JR	_S11B
_S11A:
	CALL	SOPEN
_S12X1:
	JR	C,FEND
	CALL	SOPENE2
	LD	DE,(_DTA)
	LD	A,(_DRV)
	INC	A
	LD	(DE),A
	PUSH	DE
	INC	DE
	LD	BC,32
	LDIR
	LD	L,(IY+14)
	LD	H,(IY+15)
	LD	(SCDIR),HL
	LD	HL,(_FBPS)
	LD	(SFBPS),HL
	LD	HL,(_FILEN)
	LD	(SFNDF),HL	;Directory position and Flags
	POP	HL
	LD	DE,SFILE
	LD	C,33
_S11B:
	LDIR
FEND:
	SBC	A,A		;CF=0 A=0 : CF=1 A=0FFH
FENDE:
	POP	IY
	POP	BC
	POP	DE
	POP	HL
	RET

_SYS12:
	PUSH	HL
	PUSH	DE
	PUSH	BC
	PUSH	IY
	CALL	NOPEN
	JR	_S12X1

_S16K:
	LD	A,(IY+28)	;Device
	CP	0FDH
	SCF
	RET	Z

OFCB:	LD	DE,0
	PUSH	DE
	LD	B,26		;First cluster
S16K1:
	INC	DE
	INC	HL
	DJNZ	S16K1

	LD	A,(DE)
	CP	(HL)
	JR	NZ,S16K2
	INC	DE
	INC	HL
	LD	A,(DE)
	CP	(HL)
	JR	NZ,S16K2

	POP	HL
	PUSH	IY
	POP	DE
	LD	A,(DE)		;Drive
	CP	(HL)
	JR	NZ,S16K2

	SBC	HL,DE		;CP HL,DE
	SCF
	RET	NZ
	PUSH	HL
S16K2:
	POP	HL
	PUSH	IY
	POP	DE
_SYS13:
	CALL	SETDRV
	CALL	KILL
FEND13:
	JR	FEND

_SYS14:
	CALL	SETDRV
	CALL	PUSHRR
	CALL	GETSEQ
	CALL	SETRBR

	CALL	[DE27]

	PUSH	HL
	CALL	SETSEQ
SREAD:
	POP	HL

	ADD	A,001H
	JR	C,FEND

	LD	A,L
	SUB	001H
FENDX:
	SBC	A,A
	AND	3
	RRA
	JR	FENDE

_SYS15:
	CALL	SETDRV
	CALL	PUSHRR
	CALL	GETSEQ
	CALL	SETRBR

	CALL	[DE26]
	PUSH	HL
	CALL	SETSEQ
SWRITE:
	POP	HL

	ADD	A,0FFH
	JR	FENDX

_SYS17:
	CALL	SETDRV
	CALL	NAME
	JR	FEND13

_SYS16:
	CALL	SETDRV

	CALL	CHKWILDX
	JR	C,FEND13
	LD	A,(IY+1)
	CP	5
	JR	Z,_S16X2
	CP	021H
	JP	C,FEND13
_S16X2:
;				Clear FCB
	PUSH	IY
	POP	HL
	LD	BC,16
	ADD	HL,BC
_S16X1:
	LD	(HL),B
	INC	HL
	DEC	C
	JR	NZ,_S16X1

	CALL	SETTMSX
	LD	(IY+13),0FFH	;Attribute
	CALL	SOPENX
	CCF
	CALL	Z,_S16K
	CALL	NC,COPEN
	CALL	NC,SDIRENT
	JP	_S16XX

_SYS21:
	CALL	SETDRV
	CALL	PUSHRR
	LD	L,(IY+33)	;Random record
	LD	H,(IY+34)
	CALL	SETRBR

	CALL	[DE27]
	PUSH	HL
	CALL	POPRR
	JR	SREAD

_SYS22:
_SYS28:
	CALL	SETDRV
	CALL	PUSHRR
	LD	L,(IY+33)	;Random record
	LD	H,(IY+34)
	CALL	SETRBR

	CALL	[DE26]
	PUSH	HL
	CALL	POPRR
	JR	SWRITE

_SYS18:
	LD	HL,000FFH
	XOR	A
	RET

_SYS19:
	LD	A,(_DVSW)
	AND	A
	RET

_SYS1A:
	LD	(_DTA),DE
	XOR	A
	RET

_SYS1B:
	LD	A,E
	CALL	GETDRV
	CALL	_GETDPB
	CALL	NC,_RDFATX
	LD	HL,0
	CALL	NC,DSKF

	LD	E,(IX+8)
	LD	D,(IX+9)	;¿³¸×½À
	DEC	DE
	DEC	DE
	LD	IY,(_FATBF)
	SBC	A,A
	RET	C
	LD	A,(IX+7)
	OR	A
	LD	BC,00200H
	LD	A,B		;A=2
	RET	NZ
	DEC	A		;A=1
	BIT	7,(IX+00FH)
	RET	NZ
	LD	B,004H
	RET

_SYS1D:
	XOR	A
	LD	H,A
	LD	L,A
	RET

_SYS1F:
	LD	HL,DEVICE
	XOR	A
	RET

_SYS23:
	PUSH	HL
	LD	HL,(STABLE+2*00FH)
	CALL	[HL]
	JR	C,FSIZE1
;	EX	DE,IY
	PUSH	DE
	EX	(SP),IY
	POP	DE
;
	PUSH	DE
	CALL	GETSIZE
	LD	(IY+33),L	;Random record
	LD	(IY+34),H
	POP	DE
;	EX	DE,IY
	PUSH	DE
	EX	(SP),IY
	POP	DE
;
	XOR	A
FSIZE1:
	POP	HL
	RET

_SYS24:
	PUSH	BC
;	EX	DE,IY
	PUSH	DE
	EX	(SP),IY
	POP	DE
;
	PUSH	DE
	CALL	GETSEQ
	LD	(IY+33),L	;Random record
	LD	(IY+34),H
	LD	(IY+35),0
	POP	DE
;	EX	DE,IY
	PUSH	DE
	EX	(SP),IY
	POP	DE
;
	POP	BC
	XOR	A
	RET

_SYS29:
	PUSH	BC
	PUSH	HL
	CALL	FILE
	POP	HL
	POP	BC
S29X1:
	PUSH	BC
	PUSH	DE
	PUSH	HL
	EX	DE,HL
	LD	HL,FDRV
	LD	BC,13
	LDIR
	LD	(HL),B
	LD	C,3
	LDIR
	POP	HL
	POP	DE
	POP	BC
	XOR	A
	RET

_SYS30:
	PUSH	BC
	LD	BC,_DWT
	JR	S2FX
_SYS2F:
	PUSH	BC
	LD	BC,_DRD
S2FX:
	LD	(S2FPAT+1),BC
	CALL	FFLUSH

	PUSH	DE
	PUSH	HL
	LD	A,L		;Drive
	CALL	_CHGDRV
	JR	C,S30X2
	LD	B,H		;Number of clusters
	LD	HL,(_DTA)
S30X:
	PUSH	BC
S2FPAT:	CALL	_DRD
	POP	BC
	JR	C,S30X2
	DJNZ	S30X
S30X2:
	POP	HL
	POP	DE
	POP	BC
	SBC	A,A
	RET

