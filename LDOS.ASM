
;	LSX-Dodgers OS

BOOT:
	JP	0
_SYS00:		;(BDOS)プログラム終了
WBOOT:
	JP	WBOOT1
CONST_:
	JP	CONSTX
_SYS07:		;(BDOS)コンソール直接入力
CONIN:
	JP	FLGET
CONOUT:
	JP	CONOUT1

BDOS0:
	PUSH	HL
	LD	HL,00100H
	ADD	HL,SP
	JR	C,BDOS1X	;EXTSP = 0FFD4H
BDOS2:
	POP	HL
	LD	(BDSP+1),SP
	LD	SP,EXTSP
	CALL	BDOS1
BDSP:	LD	SP,0
	RET
BDOS1:
	PUSH	HL
BDOS1X:
	LD	A,C
	CP	031H
	JR	NC,OVERFN
	ADD	A,A
	LD	L,A
	LD	H,STABLE/256
	LD	A,(HL)
	INC	L
	LD	H,(HL)
	LD	L,A
	EX	(SP),HL
	RET
OVERFN
	POP	HL
_ERROR:
_SYS2B:		;(BDOS)日付の設定
_SYS2D:		;(BDOS)時刻の設定
_SYS05:		;(BDOS)プリンタ出力
	SCF			;CF=1
	SBC	A,A		;A=0FFH
	RET
_SYS1C:		;(BDOS)ディスクの書き込み禁止化
_SYS1E:		;(BDOS)ファイル属性の設定
_SYS20:		;(BDOS)利用者番号の設定と読み出し
_SYS2E:		;(BDOS)ベリファイ・フラグの設定
	XOR	A
	RET

_SYS09:		;文字列出力
	PUSH	DE
_SX09:
	LD	A,(DE)
	INC	DE
	CP	'$'
	JR	Z,SX0E2
	PUSH	DE
	LD	E,A
	CALL	_SYS02
	POP	DE
	JR	_SX09

_SYS0C:		;(BDOS)バージョン番号の獲得
	LD	HL,00022H
	XOR	A
	LD	A,L
	RET

_SYS0D:		;(BDOS)ディスク・リセット
	CALL	_FFLUSH
	PUSH	HL
	LD	HL,00080H
	LD	(_DTA),HL
	POP	HL
	PUSH	DE
	LD	E,0
	DB	03EH

_SYS0E:		;(BDOS)カレント・ドライブの設定
	PUSH	DE
	LD	A,E
	PUSH	IX
	CALL	_GETDPB
	POP	IX
	JR	C,SX0E2
	LD	A,E
	LD	(_DVSW),A
SX0E2:
	LD	A,8
	POP	DE
	RET

_SYS0F:		;(BDOS)ファイルのオープン
	CALL	SETDRV
	LD	A,(IY+28)	;(FCB)オープン・モード
	ADD	A,002H		;Write
	JR	Z,FEND0F
	CALL	CHKWILDX

	CALL	NC,SOPENX
_S16XX:
	JR	C,FEND0F
				;Directory location
	LD	A,(_FILEN)
	LD	(IY+25),A	;(FCB)ディレクトリ・ロケーション
;				_DIRF
	LD	A,(_DIRF)
	LD	(IY+29),A	;(FCB)ディレクトリ・モード
;				_FBPS
	LD	(IY+30),E	;(FCB)ディレクトリ・ポジション
	LD	(IY+31),D
;				Open(Read)
	LD	(IY+28),0FFH	;(FCB)オープン・モード
;				FILENAME
	PUSH	IY
	POP	DE
	INC	DE
	LD	BC,11
	LDIR
;				Attribute
	LD	A,(HL)
	LD	(IY+13),A	;(FCB)属性(アトリビュート)
	LD	DE,11		;Reserved
	ADD	HL,DE
					;(FCB)ファイルを最後に変更した時刻
	LD	DE,SDDATA		;(FCB)ファイルを最後に変更した日付
	LD	B,SDDATAE-SDDATA	;(FCB)ファイルの先頭クラスタ
S16LOOP:				;(FCB)ファイルのサイズ(バイト単位)
	LD	A,(DE)
	INC	DE
	LD	(S16PAT+2),A
	LD	A,(HL)
	INC	HL
S16PAT:	LD	(IY+0),A
	DJNZ	S16LOOP

	XOR	A
	LD	(IY+12),A	;(FCB)カレント・ブロック
	LD	(OFCB+1),IY
FEND0F:
	JP	FEND

_SYS10:		;(BDOS)ファイルのクローズ
	CALL	SETDRV
	LD	A,(IY+28)	;(FCB)オープン・モード
	SUB	0FEH
	SCF
	CCF
	JR	NZ,FEND10
_S10A:				;Write
	LD	(IY+14),A	;(FCB)レコード・サイズ/アクセスするディレクトリのクラスタ番号+1
	LD	(IY+15),A

	INC	(IY+28)		;0FEH->0FFH ;オープン・モード
	CALL	SETTMS

	LD	A,(IY+29)	;(FCB)ディレクトリ・モード
	LD	(_DIRF),A
	LD	E,(IY+30)	;(FCB)ディレクトリ・ポジション
	LD	D,(IY+31)
	CALL	DC
	JR	C,FEND

	LD	A,(IY+25)	;(FCB)ディレクトリ・ロケーション
SDECM1:	AND	01FH		;自己書き換え(1セクタ辺りのディレクトリエントリ数-1) 1024=01FH / 512=00FH / 256=7
	LD	L,A
	LD	H,0
	ADD	HL,HL		;*2
	ADD	HL,HL		;*4
	ADD	HL,HL		;*8
	ADD	HL,HL		;*16
	ADD	HL,HL		;*32
	LD	BC,(_DTBUF)
	ADD	HL,BC

	CALL	SDIRENT
FEND10:
	JR	FEND

OPENDD:
	LD	(IY+28),0FDH	;(FCB)オープン・モード
	LD	(IY+13),020H	;(FCB)属性(アトリビュート)
	CALL	SETTMSX
	JR	FEND

_SYS11:		;(BDOS)最初のファイルの検索
	CALL	SETDRV
	CALL	CHKDDX
	JR	C,_S11A
	PUSH	IY
	POP	HL
	LD	DE,(_DTA)
	LD	BC,12
	LDIR
	LD	A,020H
	LD	(DE),A
	INC	DE
	LD	H,D
	LD	L,E
	INC	DE
	LD	C,19
	LD	(HL),B
	JR	_S11B
_S11A:
	CALL	SOPEN
_S12X1:
	JR	C,FEND
	CALL	SOPENE2
	LD	DE,(_DTA)
	LD	A,(_DRV)
	INC	A
	LD	(DE),A
	PUSH	DE
	INC	DE
	LD	BC,32
	LDIR
	LD	L,(IY+14)	;(FCB)レコード・サイズ/アクセスするディレクトリのクラスタ番号+1
	LD	H,(IY+15)
	LD	(SCDIR),HL
	LD	HL,(_FBPS)
	LD	(SFBPS),HL
	LD	HL,(_FILEN)
	LD	(SFNDF),HL	;Directory position and Flags
	POP	HL
	LD	DE,SFILE
	LD	C,33
_S11B:
	LDIR
FEND:
	SBC	A,A		;CF=0 A=0 : CF=1 A=0FFH
FENDE:
	POP	IY
	POP	BC
	POP	DE
	POP	HL
	RET

_SYS12:		;(BDOS)次のファイルの検索
	PUSH	HL
	PUSH	DE
	PUSH	BC
	PUSH	IY
	CALL	NOPEN
	JR	_S12X1

_S16K:
	LD	A,(IY+28)	;(FCB)オープン・モード
	CP	0FDH		;Device(0FDH)
	SCF
	RET	Z

OFCB:	LD	DE,0
	PUSH	DE
	LD	B,26		;First cluster
S16K1:
	INC	DE
	INC	HL
	DJNZ	S16K1

	LD	A,(DE)
	CP	(HL)
	JR	NZ,S16K2
	INC	DE
	INC	HL
	LD	A,(DE)
	CP	(HL)
	JR	NZ,S16K2

	POP	HL
	PUSH	IY
	POP	DE
	LD	A,(DE)		;Drive
	CP	(HL)
	JR	NZ,S16K2
				;ここはCFが必ず0
	SBC	HL,DE		;CP HL,DE
	SCF
	RET	NZ
	PUSH	HL
S16K2:
	POP	HL
	PUSH	IY
	POP	DE
_SYS13:		;(BDOS)ファイルの削除
	CALL	SETDRV
	CALL	KILL
FEND13:
	JR	FEND

_SYS14:		;(BDOS)シーケンシャルな読み出し
	CALL	SETDRV
	CALL	PUSHRR
	CALL	GETSEQ

	CALL	RB_READ
	PUSH	HL
	CALL	SETSEQ
SREAD:
	POP	HL

	ADD	A,001H
	JR	C,FEND

	LD	A,L
	SUB	001H
FENDX:
	SBC	A,A
	AND	3
	RRA
	JR	FENDE

_SYS15:		;(BDOS)シーケンシャルな書き込み
	CALL	SETDRV
	CALL	PUSHRR
	CALL	GETSEQ

	CALL	RB_WRITE
	PUSH	HL
	CALL	SETSEQ
SWRITE:
	POP	HL

	ADD	A,0FFH
	JR	FENDX

_SYS17:		;(BDOS)ファイル名の変更
	CALL	SETDRV
	CALL	NAME
	JR	FEND13

_SYS16:		;(BDOS)ファイルの作成
	CALL	SETDRV

	CALL	CHKWILDX
	JR	C,FEND13
	LD	A,(IY+1)	;(FCB)主ファイル名
	CP	5
	JR	Z,_S16X2
	CP	021H
	JP	C,FEND13
_S16X2:
;				Clear FCB
	PUSH	IY
	POP	HL
	LD	BC,16
	ADD	HL,BC
_S16X1:
	LD	(HL),B		;B=0
	INC	HL
	DEC	C
	JR	NZ,_S16X1

	CALL	SETTMSX
	LD	(IY+13),0FFH	;(FCB)Attribute
	CALL	SOPENX
	CCF
	CALL	Z,_S16K
	CALL	NC,COPEN
	CALL	NC,SDIRENT
	JP	_S16XX

_SYS21:		;(BDOS)ランダムな読み出し

	CALL	SETDRV
	CALL	PUSHRR
	LD	L,(IY+33)	;(FCB)Random record
	LD	H,(IY+34)

	CALL	RB_READ
	PUSH	HL
	CALL	POPRR
	JR	SREAD

_SYS22:		;(BDOS)ランダムな書き込み
_SYS28:		;(BDOS)ランダムな書き込み・その2
	CALL	SETDRV
	CALL	PUSHRR
	LD	L,(IY+33)	;(FCB)Random record
	LD	H,(IY+34)

	CALL	RB_WRITE
	PUSH	HL
	CALL	POPRR
	JR	SWRITE

_SYS18:		;(BDOS)ログイン・ベクトルの獲得
	LD	HL,000FFH
	XOR	A
	RET

_SYS19:		;(BDOS)カレント・ドライブ番号の獲得
	LD	A,(_DVSW)
	AND	A
	RET

_SYS1A:		;(BDOS)DTAの設定
	LD	(_DTA),DE
	XOR	A
	RET

_SYS1B:		;(BDOS)ディスク情報の獲得
	LD	A,E
	CALL	GETDRV
	CALL	_GETDPB
	CALL	NC,_RDFATX
	LD	HL,0
	CALL	NC,DSKF

	LD	DE,(MAXCLP+1)	;DPB_08_MAXCL-1
	DEC	DE		;DE←クラスタの総数
	LD	IY,(_FATBF)	;IY←メモリ上のFATの先頭アドレス
	SBC	A,A
	RET	C
	LD	C,A		;C=0
	LD	A,(IX+00FH)	;DPB_0F_BPS
	AND	00FH
	LD	B,A
	LD	A,(IX+7)	;DPB_07_SECPCL
	RET

_SYS1D:		;(BDOS)書き込みが禁止されているディスクの調査
	XOR	A
	LD	H,A
	LD	L,A
	RET

_SYS1F:		;(BDOS)ディスク装置のパラメータの読み出し
	LD	HL,DEVICE
	LD	A,E
	JP	_GETDPB

_SYS23:		;(BDOS)ファイル・サイズの獲得
	PUSH	HL
	LD	HL,(STABLE+2*00FH)	;ファイルのオープン
	CALL	JP_HL
	JR	C,_S23X1

	PUSH	DE		;EX DE,IY
	EX	(SP),IY		;
;	POP	DE		;
;	PUSH	DE		;DEを破壊しないように注意vv
	CALL	GETSIZE
_S24X1:
	LD	(IY+33),L	;(FCB)Random record
	LD	(IY+34),H
	LD	(IY+35),0
;	POP	DE		;^^^^^^^^^^^^^^^^^^^^^^^^
;	PUSH	DE		;EX DE,IY
	EX	(SP),IY		;
	POP	DE		;

	XOR	A
_S23X1:
	POP	HL
	RET

_SYS24:		;(BDOS)ランダム・レコード・フィールドの設定
	PUSH	HL
	PUSH	DE		;EX DE,IY
	EX	(SP),IY		;
;	POP	DE		;
;	PUSH	DE		;DEを破壊しないように注意vv
	CALL	GETSEQ
	JR	_S24X1		;^^^^^^^^^^^^^^^^^^^^^^^^

_SYS29:		;(BDOS)ファイル名の解析
	PUSH	BC
	PUSH	HL
	CALL	FILE
	POP	HL
	POP	BC
S29X1:
	PUSH	BC
	PUSH	DE
	PUSH	HL
	EX	DE,HL
	LD	HL,FDRV
	LD	BC,13
	LDIR
	LD	(HL),B
	LD	C,3
	LDIR
	POP	HL
	POP	DE
	POP	BC
	XOR	A
	RET

_SYS30:		;(BDOS)論理セクタを用いた書き込み
	PUSH	BC
	LD	BC,DWT16
	JR	S2FX
_SYS2F:
	PUSH	BC
	LD	BC,DRD16
S2FX:
	LD	(S2FPAT+1),BC
	CALL	_FFLUSH

	PUSH	DE
	PUSH	HL
	LD	A,L		;Drive
	CALL	_CHGDRV
	JR	C,S30X2
	LD	B,H		;Number of clusters
	LD	HL,(_DTA)
S30X:
	PUSH	BC
S2FPAT:	CALL	DRD16
	POP	BC
	JR	C,S30X2
	DJNZ	S30X
S30X2:
	POP	HL
	POP	DE
	POP	BC
	SBC	A,A
	RET
