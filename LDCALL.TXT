・LSX-Dodgers  MSX-DOS  CP/M80
・システムコール一覧


  システムコールは
  Cレジスタにファンクション番号を入れ
  $0005番地を呼び出すことにより実行されます。


ファンクション
 番号

$00	プログラム終了(_TERM0) CP/M MSX-DOS

  設定:
  なし

  戻り値:
  --

  備考:
  実行中のプログラムを終了させ、システムの再立ち上げを行なう
  0番地へのジャンプによるプログラム終了と同じ


$01	コンソール入力(_CONIN) CP/M MSX-DOS

  設定:
  なし

  戻り値:
  A←コンソールから入力した1文字

  備考:
  入力なき場合入力待ち。入力文字はコンソールに表示する
  [CTRL]+[C]、[CTRL]+[S]の入力があれば処理を行う


$02	コンソール出力(_CONOUT) CP/M MSX-DOS

  設定:
  E←コンソールに出力する文字コード

  戻り値:
  なし

  備考:
  [CTRL]+[C]、[CTRL]+[S]の入力があれば処理を行う


$03	*4 外部入力(_AUXIN) CP/M MSX-DOS

  設定:
  なし

  戻り値:
  A←AUXデバイスから読み込んだ1文字


$04	*4 外部出力(_AUXOUT) CP/M MSX-DOS

  設定:
  E←AUXデバイスに出力する1文字

  戻り値:
  なし


$05	*4 プリンタ出力(_LSTOUT) CP/M MSX-DOS

  設定:
  E←プリンタに出力する1文字

  戻り値:
  なし

$06	コンソール直接入出力(_DIRIO) CP/M MSX-DOS

  設定:
  E←$FF       コンソール入力
  E←$FF以外   その値を文字コードとしてコンソール出力

  戻り値:
  入力の場合  A←入力した1文字(入力のない場合  A←0)
  出力の場合  なし

  備考:
  [CTRL]+[C]、[CTRL]+[S]の処理やエコーバックは行わない


$07	コンソール直接入力(_DIRIN) *1 MSX-DOS

  設定:
  なし

  戻り値:
  A←コンソールから入力した1文字

  備考:
  入力なき場合入力待ち。コンソールにエコーバックしない
  [CTRL]+[C]、[CTRL]+[S]の処理は行わない

  CP/M80の場合、I/Oバイトの読み出し
  戻り値:
  A←I/Oバイト


$08	エコーなしコンソール入力(_INNOE) *1 MSX-DOS

  設定:
  なし

  戻り値:
  A←コンソールから入力した1文字

  備考:
  入力なき場合入力待ち。コンソールにエコーバックしない
  [CTRL]+[C]、[CTRL]+[S]の入力があれば処理を行う

  CP/M80の場合、I/Oバイトの設定
  設定:E←I/Oバイト


$09	文字列出力(_STROUT) CP/M MSX-DOS

  設定:
  DE←メモリ上に用意した、コンソールに出力する文字列の先頭アドレス

  戻り値:
  なし

  備考:
  文字列の最後に$を付ける。$は表示しない


$0A  文字列入力(_BUFIN) CP/M MSX-DOS

  設定:
  DE←最大入力文字数(1～$FF)をセットしたメモリのアドレス

  戻り値:
  DEにセットしたアドレス+1←実際に入力された文字列

  備考:
  入力文字数が指定した最大に満たない場合、$0Dを入力の終端とみなす。
  入力時にスクリーンエディットによる編集可
  [CTRL]+[C]の入力があれば処理を行う


$0B	コンソール状態のチェック(_CONST) CP/M MSX-DOS

  設定:
  なし

  戻り値:
  キーが押されている場合、A←$FF
  押されていない場合、A←0


$0C	バージョン番号の獲得(_CPMVER) CP/M MSX-DOS

  設定:
  なし

  戻り値:
  HL←$0022

  備考:
  CP/Mとの互換用


$0D	ディスクリセット(_DSKRST) CP/M MSX-DOS

  設定:
  なし

  戻り値:
  なし

  備考:
  変更されたがまだディスクに書き込まれていないデータがあれば書き込み、
  カレントドライブをドライブAに設定しDTAを$0080にセットする。
  ファイルの大きさに変更がある場合はファイルのクローズも必要


$0E	カレントドライブの設定(_SELDSK) CP/M MSX-DOS

  設定:
  E←カレントドライブ番号
  (A:0,B:1,……H:7)

  戻り値:
  なし


$0F	ファイルのオープン(_FOPEN) CP/M MSX-DOS

  設定:
  DE←オープンされていないファイルのFCBの先頭アドレス

  戻り値:
  成功した場合  A←0(～3)
    指定のFCB←各フィールドの設定

  失敗した場合  A←$FF


$10	ファイルのクローズ(_FCLOSE) CP/M MSX-DOS

  設定:
  DE←オープンされたファイルのFCBの先頭アドレス

  戻り値:
  成功した場合  A←0

  失敗した場合  A←$FF


$11	ファイル検索(_SFIRST) CP/M MSX-DOS

  設定:
  DE←オープンされていないファイルのFCBの先頭アドレス

  戻り値:
  見つかった場合  A←0
    DTAで示される領域←そのファイルのドライブ番号とディレクトリエントリ32バイト
    FCBにドライブ番号をセット

  失敗した場合  A←$FF

  備考:
  DTAに返ってくるのはFCBではなくドライブ番号とディレクトリエントリ
　そのままオープンしていないFCBとして使える


$12	次のファイル検索(_SNEXT) CP/M MSX-DOS

  設定:
  なし

  戻り値:
  見つかった場合  A←0
    DTAで示される領域←そのファイルのドライブ番号とディレクトリエントリ32バイト

  失敗した場合  A←$FF


$13	ファイルの削除(_FDEL) CP/M MSX-DOS

  設定:
  DE←削除するファイルのFCBの先頭アドレス

  戻り値:
  成功した場合  A←0

  失敗した場合  A←$FF

  備考:
  ワイルドカード指定可


$14	シーケンシャルな読み出し(_RDSEQ) CP/M MSX-DOS

  設定:
  DE←オープンされたファイルのFCBの先頭アドレス
  FCBのカレントブロック←読み出し開始ブロック
  FCBのカレントレコード←読み出し開始レコード

  戻り値:
  成功した場合    A←0
    DTAで示される領域←読み込んだ1レコード

  EOFの場合       A←1

  失敗した場合    A←$FF

  備考:
  1レコードの大きさは128バイト


$15	シーケンシャルな書き込み(_WRSQEQ) CP/M MSX-DOS

  設定:
  DE←オープンされたファイルのFCBの先頭アドレス
  FCBのカレントブロック←書き込み開始ブロック
  FCBのカレントレコード←書き込み開始レコード
  DTAで以降のメモリ領域←書き込むデータ

  戻り値:
  成功した場合  A←0

  失敗した場合  A←1

  備考:
  1レコードの大きさは128バイト


$16	ファイルの作成(_FMAKE) CP/M MSX-DOS

  設定:
  DE←オープンされていないファイルのFCBの先頭アドレス

  戻り値:
  成功した場合  A←0(～3)

  失敗した場合  A←$FF


$17	ファイル名の変更(_FREN) CP/M MSX-DOS

  設定:
  DE←ファイル名を変更したいファイルのFCBの先頭アドレス
  FCBの先頭アドレス+$11←新ファイル名

  戻り値:
  成功した場合  A←0

  失敗した場合  A←$FF

  備考:
  ワイルドカード指定不可(MSX-DOSではワイルドカード指定可)
  ディレクトリも名前の変更を行う場合はFCB +13(属性)にディレクトリもセットする


$18	ログインベクトルの獲得(_LOGIN) CP/M MSX-DOS

  設定:
  なし

  戻り値:
  HL←オンラインドライブ情報

  備考:
  戻り値のうち、Lレジスタの各ビットがドライブ番号に対応、1ならオンライン、0ならオフライン
  LSX-DodgersではHL←$00FF(簡易処理)


$19	カレントドライブ番号の獲得(_CURDRV) CP/M MSX-DOS

  設定:
  なし

  戻り値:
  A←カレントドライブ番号
  (A:0,B:1,……H:7)


$1A  DTAの設定(_SETDTA) CP/M MSX-DOS

  設定:
  DE←転送先アドレス(DTAアドレス)

  戻り値:
  なし


$1B	ディスク情報の獲得(_ALLOC) MSX-DOS

  設定:
  E←目的のディスクが入っているドライブ番号
  (カレントドライブ:0,A:1,B:2,……H:8)

  戻り値:
  A←1クラスタ辺りの論理セクタ数
  BC←論理セクタのサイズ
  DE←クラスタの総数
  HL←未使用クラスタの総数
  IX←DPBの先頭アドレス
  IY←メモリ上のFATの先頭アドレス
  A←1クラスタのセクタ数

  失敗した場合  A←$FF

  備考:
  CP/M80の場合、ファイル割り当て情報の読み出し
  戻り値:
  HL←カレントディスクのどの領域がファイルに割り当てられているかを示すメモリ領域の先頭アドレス


$1C	ディスクの書き込み禁止化	*4 CP/M

  備考:
  このシステムコール発行以降、再びシステムがブートされるまで、
  カレントディスクへの書き込みを禁止する


$1D	書き込みが禁止されているディスクの調査　CP/M

  設定:
  なし

  戻り値:
  HL←書き込み禁止ドライブ情報

  備考:
  戻り値のうち、Lレジスタの各ビットがドライブ番号に対応、1なら書き込み禁止、0なら書き込み可
  LSX-DodgersではHL←$0000(簡易処理)


$1E	ファイル属性の設定	*4 CP/M

  設定:
  FCBの拡張子の1文字目と2文字目の最上位ビット←ファイルの属性情報

  備考:
  拡張子の1文字目の最上位ビットが0→読み書き可能 1→読み込み専用
  拡張子の2文字目の最上位ビットが0→通常ファイル 1→システムファイル


$1F	ディスク装置のパラメータの読み出し

  設定:
  E←DPBを取得したいドライブ番号
  (A:0,B:1,……H:7)

  戻り値:
  HL←DPBの先頭アドレス(ドライブA:)
  IX←DPBの先頭アドレス(Eで指定したドライブ)
  A←FATのセクタ数(Eで指定したドライブ)

  備考:
  LSX-DodgersのDPBの構造はCP/M80ともMSX-DOSとも異なる
　バージョン1.29以前はIXに値は帰らなく、Aは必ず0になる


$20	利用者番号の設定と読み出し CP/M

  設定:
  E←$FF  利用者番号の読み出し
  E←$FF以外  その値の下位5ビットを利用者番号として設定

  戻り値:
  入力の場合  A←現在の利用者番号
  出力の場合  なし

  備考:
  LSX-Dodgersでは利用者番号の設定は無視され読み出しの処理はA←0


$21	ランダムな読み出し(_RDRND) CP/M MSX-DOS

  設定:
  DE←オープンされたファイルのFCBの先頭アドレス
  FCBのランダムレコード←読み出し開始レコード

  戻り値:
  成功した場合  A←0
    DTAで示される領域←読み込んだ1レコード

  失敗した場合  A←1

  備考:1レコードの大きさは128バイト


$22	ランダムな書き込み(_WRRND) CP/M MSX-DOS

  設定:
  DE←オープンされたファイルのFCBの先頭アドレス
  FCBのランダムレコード←書き込み開始レコード
  DTA以降のメモリ領域←書き込むデータ

  戻り値:
  成功した場合  A←0
  失敗した場合  A←1

  備考:
  1レコードの大きさは128バイト


$23	ファイルサイズの獲得(_FSIZE) CP/M MSX-DOS

  設定:
  DE←オープンしていないファイルのFCBの先頭アドレス

  戻り値:
  成功した場合  A←0
  FCBのランダムレコードフィールド←指定されたファイルのサイズ

  失敗した場合  A←$FF

  備考:
  ファイルサイズは128バイト単位で計算する。127バイトなら1で300バイトなら3となる


$24	ランダムレコードフィールドの設定(_SETRND) CP/M MSX-DOS

  設定:
  DE←オープンされたファイルのFCBの先頭アドレス
  FCBのカレントブロック←目的のブロック
  FCBのカレントレコード←目的のレコード

  戻り値:
  FCBのランダムレコードフィールド←指定されたファイルのカレントブロックフィールド
  及びカレントレコードフィールドから計算したレコードポジション


$26	ランダムブロック書き込み(_WRBLK)	*1 MSX-DOS

  設定:
  DE←オープンされたファイルのFCBの先頭アドレス
  FCBのランダムレコード←書き込み開始レコード
  FCBのレコードサイズ←1(MSX-DOSでは自由に設定できる)
  HL←書き込むレコード数
  DTA以降のメモリ領域←書き込むデータ

  戻り値:
  成功した場合  A←0

  失敗した場合  A←1

  備考:
  1レコードの大きさは1バイトとして動作(MSX-DOSでは自由に設定できる)


$27	ランダムブロック読み出し(_RDBLK)	*1 MSX-DOS

  設定:
  DE←オープンされたファイルのFCBの先頭アドレス
  FCBのランダムレコード←読み出し開始レコード
  FCBのレコードサイズ←1(MSX-DOSでは自由に設定できる)
  HL←読み込むレコード数

  戻り値:
  指定したレコード数読み込めた場合  A←0
    HL←実際に読み込んだレコード数
    DTAで示される領域←読み込んだデータ

  指定したレコード数読み込めなかった場合  A←1
    HL←実際に読み込んだレコード数
    DTAで示される領域←読み込んだデータ

  失敗した場合  A←$FF

  備考:1レコードの大きさは1バイトとして動作(MSX-DOSでは自由に設定できる)


$28	ランダムな書き込み・その2(_WRZER)	*4 CP/M MSX-DOS

  設定:
  DE←オープンされたファイルのFCBの先頭アドレス
  FCBのランダムレコード←書き込み開始レコード
  DTA以降のメモリ領域←書き込むデータ

  戻り値:
  成功した場合  A←0

  失敗した場合  A←1

  備考:LSX-Dodgersでは「$22 ランダムな書き込み」と同じ処理を行っている。


$29	ファイル名の解析(_PPATH)	*1 *3 LSX-Dodgers

  設定:
  DE←解析するファイル名の入っている先頭アドレス
  HL←解析されたファイルを格納するFCBの先頭アドレス

  備考:
  このシステムコールを使うと階層ディレクトリにも対応する。
  $5Cと今のところ機能は同じ、$5Cの方だとMSX-DOS2でも動作すると思っていたが微妙にMSX-DOS2と仕様が違ったのでこちらを推奨


$2A	日付の獲得(_GDATE)	*1 MSX-DOS

  設定:
  なし

  戻り値:
  HL←年  D←月  E←日  A←曜日(0:日～6:土)

  備考:
  MZ-700/1500:サポートしていない


$2B	日付の設定(_SDATE)	*1 *4 MSX-DOS

  設定:
  HL←年  D←月  E←日

  戻り値:
  成功した場合  A←0

  失敗した場合  A←$FF

  備考:
  サポートしていない


$2C	時刻の獲得(_GTIME)	*1 MSX-DOS

  設定:
  なし

  戻り値:
  H←時  L←分  D←秒  E←1/100秒

  備考:
  X1/turbo/Z PC-8801mkIISR:仕様によりE←0
  MZ-700/1500:サポートしていない


$2D	時刻の設定(_STIME)	*1 *4 MSX-DOS

  設定:
  H←時  L←分  D←秒  E=1/100秒

  戻り値:
  成功した場合  A←0

  失敗した場合  A←$FF

  備考:
  サポートしていない


$2E	ベリファイフラグの設定(_VERIFY)	*1 *4 MSX-DOS

  設定:
  E←0    ベリファイフラグをセット
  E←$FF  ベリファイフラグをリセット

  戻り値:
  なし

  備考:
  サポートしていない


$2F	論理セクタを用いた読み出し(_RDABS)	*1 MSX-DOS

  設定:
  DE←読み出しを開始する論理セクタ番号
  H←読み出す論理セクタの数
  L←読み出すディスクドライブの番号
  (A:0,B:1,……H:7)

  戻り値:
  成功した場合  A←0
    DTAで示される領域←読み込んだデータ

  失敗した場合  A←$FF


$30	論理セクタを用いた書き込み(_WRABS)	*1 MSX-DOS

  設定:
  DE←書き込みを開始する論理セクタ番号
  H←書き込む論理セクタの数
  L←書き込むディスクドライブの番号
  (A:0,B:1,……H:7)
  DTAで示される領域←書き込むデータ

  戻り値:
  成功した場合  A←0

  失敗した場合  A←$FF


$39 サブディレクトリの作成 *1 *4 *3

  設定:
  DE←作成するディレクトリ名の入っている先頭アドレス

  戻り値:
  成功した場合  A←0

  失敗した場合  A←$FF

  備考:
  標準ではサポートしていない。仕様は仮


$3A サブディレクトリの削除 *1 *4 *3

  設定:
  DE←削除するディレクトリ名の入っている先頭アドレス

  戻り値:
  成功した場合  A←0

  失敗した場合  A←$FF

  備考:
  標準ではサポートしていない。仕様は仮


$5A カレントディレクトリの変更(_CHDIR) *1 *2 MSX-DOS2

  設定:
  DE←ディレクトリ名の入っている先頭アドレス

  戻り値:
  成功した場合  A←0

  失敗した場合  A←$FF

  備考:
  番号をMSX-DOS2に合わせた。$3Bでも同じ機能となる。
  ※LSX-Dodgers 1.42以降


$5C	ファイル名の解析(_PFILE)	*1 *2 (※MSX-DOS2と微妙に仕様が違うので非推奨 $29使ってください)

  設定:
  DE←解析するファイル名の入っている先頭アドレス
  HL←解析されたファイルを格納するFCBの先頭アドレス

  戻り値:
  A←0
  B←解析フラグ
  DE←終了文字の番地

  備考:
  LSX-Dodgersではこのシステムコールを使うと階層ディレクトリにも対応する
  Bの解析フラグはLSX-Dodgersでは不定
  番号をMSX-DOS2に合わせたが微妙にMSX-DOS2と仕様が違うことが判明。$29でも同じ機能となるのでそちらを推奨
  ※LSX-Dodgers 1.42以降


$5F ディスクバッファのフラッシュ(_FLUSH) *1 *2 MSX-DOS2

  設定:
  B←ドライブ番号 0:カレント $FF:すべてのドライブ
　D←0:フラッシュのみ $FF:フラッシュして無効化

  戻り値:
  A←0

  備考:
  LSX-Dodgersでは設定にかかわらず必ずすべてのバッファをフラッシュして無効化する。戻り値は必ず0
  ※LSX-Dodgers 1.42以降


$6F MSX-DOS のバージョン番号の獲得(_DOSVER) *1 MSX-DOS

  戻り値:
  BC←$011D(MSX-DOSのバージョン)MSXの場合は($001D)を返す
  DE←LSX-Dodgersのバージョン
  H←デバイスフラグ
  L←機種ID
  A←0

  デバイスフラグ
  bit0: 0:FDCがMB8877系 1:その他(不明)

  機種ID
  0: X1/turbo/Z
  1: MZ-700/1500
  2: PC-8801mkIISR

  備考:
  MSX-DOS1の場合はBが2未満で判別するのだが、0か否かで判別しているものがあった。
  CP/M80の場合はCF=1で返るのでCFで判別可能
  バージョン表記は $1234 であれば 12.34 (BCD 形式)


*1	CP/M80と互換性がないもの(MSX-DOS互換)
*2  MSX-DOS2互換
*3	LSX-Dodgers独自機能
*4	標準のLSX-Dodgersでサポートしていないもの

  ※システムコール備考

  [CTRL]+[C]は[SHIFT]+[BREAK]でも良い
  [CTRL]+[S]は[BREAK]でも良い(X1/turbo/Zのみ)

  LSX-Dodgersでは戻り値として使用するレジスタとAレジスタ、フラグ以外は保存する。
  MSX版は内部でインタースロットコールを使っている場合は裏レジスタを破壊する。
  CP/M80やMSX-DOSでは基本的にレジスタを破壊されるようなので、CP/M80やMSX-DOSで
  動くように作るためにはシステムコールの際、必要なレジスタは保存するように作る。

eof
