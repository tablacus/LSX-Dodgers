
;	LSX-Dodgers DISK2


;	GRAPHIC RAM DISK DRIVER


GDRD:
	CALL	GADR
GDRDC1:
	INI
	INC	B
	INC	C
	JR	NZ,GDRDC1
	JR	S1FD0

GDWT:
	CALL	GADR
GDWTC1:
	INC	B
	OUTI
	INC	C
	JR	NZ,GDWTC1
	JR	S1FD0

GADR:
	LD	C,0
	LD	A,E
	ADD	A,040H
	LD	B,A
	INC	DE
	LD	A,(WK1FD0)
	OR	010H		;BANK1
S1FD0:
	PUSH	BC
	LD	(WK1FD0),A
	LD	BC,01FD0H
	OUT	(C),A
	POP	BC
	AND	0EFH		;BANK0
	RET


;	BANK RAM DISK DRIVER


BDRDC:
	LD	(BANKSP+1),SP
	LD	A,(BANKSP+2)
	ADD	A,A
	JR	C,BDRDC1
	LD	SP,EXTSP
BDRDC1:
	PUSH	DE
	EXX
	 PUSH	 BC
	 PUSH	 DE
	 CALL	 BADR
	CALL	BTFR
	EXX
BDWTCE:
	 POP	 DE
	 POP	 BC
	 EXX
	POP	DE
	INC	DE
	XOR	A
BANKSP:	LD	SP,0
	EI
	RET

BDWTC:
	LD	(BANKSP+1),SP
	LD	A,(BANKSP+2)
	ADD	A,A
	JR	C,BDWTC1
	LD	SP,EXTSP
BDWTC1:
	PUSH	DE
	EXX
	 PUSH	 BC
	 PUSH	 DE
	 CALL	 BADR
	EXX
	 LD	D,E
	 LD	E,A
	 EXX
	EX	DE,HL
	CALL	BTFR
	EX	DE,HL
	EXX
	 OUT	 (C),D	 ;MAIN
	 JR	 BDWTCE

BADR:
	 EXX
	LD	A,E
	ADD	A,A
	RL	D
	ADD	A,A
	RL	D
	PUSH	AF
	ADD	A,A
	LD	A,D
	ADC	A,A
	AND	00FH
	EXX
	 LD	 BC,00B00H
	 LD	 D,A	  ;BANK
	 LD	 E,010H	  ;MAIN
	 EXX
	POP	DE
	LD	B,0
	LD	E,B
	RES	7,D
	RET

BTFR:
	PUSH	DE
	DI

BTFR1:
	EXX
	 OUT	 (C),D	 ;BANK(MAIN)
	 EXX
	EX	(SP),HL
	LD	A,(HL)
	INC	HL
	LD	C,(HL)
	INC	HL
	LD	D,(HL)
	INC	HL
	LD	E,(HL)
	INC	HL
	EX	(SP),HL
	EXX
	 OUT	 (C),E	 ;MAIN(BANK)
	 EXX
	LD	(HL),A
	INC	HL
	LD	(HL),C
	INC	HL
	LD	(HL),D
	INC	HL
	LD	(HL),E
	INC	HL
	DJNZ	BTFR1
	POP	DE
	RET


;	EMM DRIVER(DMA)


EDWTC:
	LD	A,15
	DB	1
EDRDC:
	LD	A,14
EDWTC1:
	PUSH	DE
	LD	(DMAB),HL
	EX	DE,HL
	ADD	HL,HL
	ADD	HL,HL
	LD	BC,(_MAXCYL-1)
	LD	C,0
	ADD	HL,BC
	LD	BC,(_DRIVE)
	LD	B,00DH
	OUT	(C),C
	INC	C
	OUT	(C),L
	INC	C
	OUT	(C),H

	LD	HL,EDMAD
	CALL	SETDMA
	CALL	GO_DMA
	EX	DE,HL
	INC	H
	INC	H
	INC	H
	INC	H
	POP	DE
	INC	DE
	XOR	A
	RET

EDMAD:	DB	0C3H	;WR6 リセット
	DB	07DH	;WR0 ポートA→ポートB 転送
	DW	00D03H	;ポートA開始アドレス EMMリード/ライト
	DW	003FFH	;ブロック長(転送サイズ-1)
	DB	02CH	;WR1 ポートAアドレス固定 I/O
	DB	050H	;WR2 ポートBアドレスインクリメント メモリ
	DB	002H	;ポートBタイミング
	DB	080H	;WR3
	DB	09AH	;WR5 WAIT RDY:HIGH
	DB	0ADH	;WR4 連続 ポートB開始アドレス
DMAB:	DW	0
	DB	001H	;WR0 ポートB←ポートB 転送

EMME:

AT_RE	EQU	EDWTC-AT_EDWTC

