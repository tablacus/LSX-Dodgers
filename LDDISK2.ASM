
;	LSX-Dodgers DISK2


;	GRAPHIC RAM DISK DRIVER


GDRD:
	PUSH	BC
	CALL	GADR
	POP	AF
GDRD1:
	INI
	INC	B
	INC	C
	JR	NZ,GDRD1
	INC	B
	INC	DE
	DEC	A
	JR	NZ,GDRD1
GBANK0:
	LD	A,(WK1FD0)
	AND	0EFH		;BANK0
	JR	S1FD0

GDWT:
	PUSH	BC
	CALL	GADR
	POP	AF
GDWT1:
	INC	B
	OUTI
	INC	C
	JR	NZ,GDWT1
	INC	B
	INC	DE
	DEC	A
	JR	NZ,GDWT1
	JR	GBANK0

GADR:
	LD	C,0
	LD	A,E
	ADD	A,040H
	LD	B,A
	LD	A,(WK1FD0)
	OR	010H		;BANK1
S1FD0:
	PUSH	BC
	LD	(WK1FD0),A
	LD	BC,01FD0H
	OUT	(C),A
	POP	BC
	RET


;	BANK RAM DISK DRIVER

BDWT:
	DB	03EH	;LD A,??
	SCF
	JR	BRW

BDRD:
	DB	03EH	;LD A,??
	AND	A
BRW:
	DI
	LD	(BRWPAT),A
	LD	(BANKSP+1),SP
	LD	A,(BANKSP+2)
	ADD	A,A
	JR	C,BRW0
	LD	SP,EXTSP
BRW0:
	EXX		;裏レジスタ
	 PUSH	 BC
	 PUSH	 DE
	 LD	 BC,00B00H	 ;バンクメモリ
	 LD	 DE,01010H
	 EXX		;表レジスタ
BRW1:
	PUSH	BC
	PUSH	DE
	EX	DE,HL
	ADD	HL,HL
	ADD	HL,HL
	LD	A,H
	AND	00FH	;バンク
	LD	H,L
	SRL	H	;/2
	LD	L,0
	EXX		;裏レジスタ
BRWPAT:	 AND	 A	;自己書き換え(AND A:読み出し/SCF:書き込み)
	 JR	 C,BRWT
	 LD	 D,A	 ;D=バンク
	 EXX		;表レジスタ
	EX	DE,HL
	CALL	BTFR
	JR	BRW2
BRWT:
	 LD	E,A	 ;E=バンク
	 EXX		;表レジスタ
	CALL	BTFR
	EX	DE,HL
BRW2:
	POP	DE
	POP	BC
	INC	DE
	DJNZ	BRW1

	EXX		;裏レジスタ
	 LD	 A,10H
	 OUT	 (C),A		;メインメモリに切り替える
	 POP	 DE
	 POP	 BC
	 EXX		;表レジスタ
	XOR	A
BANKSP:	LD	SP,0
	EI
	RET

;メインメモリ←→バンクメモリ 512バイトの転送を行う
; DE:転送元アドレス
; HL:転送先アドレス
; 裏BC:バンク切り替えポート(0B00H)
; 裏D:転送元バンク(0-0FH:10Hはメインメモリ)
; 裏E:転送先バンク(0-0FH:10Hはメインメモリ)

BTFR:
	LD	B,0	;256回ループ(256*2)
BTFR1:
	EXX		;裏レジスタ
	 OUT	 (C),D	 ;BANK(MAIN)
	 EXX		;表レジスタ
	LD	A,(DE)
	LD	C,A
	INC	DE
	LD	A,(DE)
	INC	DE
	EXX		;裏レジスタ
	 OUT	 (C),E	 ;MAIN(BANK)
	 EXX		;表レジスタ
	LD	(HL),C
	INC	HL
	LD	(HL),A
	INC	HL
	DJNZ	BTFR1
	RET

;	EMM DRIVER(DMA)


EDWT:
	LD	C,15
	JR	EDWT1
EDRD:
	LD	C,14
EDWT1:
	PUSH	BC
	PUSH	DE
	LD	(DMAB),HL
	LD	A,B
	ADD	A,A
	DEC	A
	LD	(DMALEN+1),A
	INC	A
	ADD	A,H	;HL(アドレス)を先に進めておく
	LD	H,A
	LD	A,C
	EX	DE,HL
	ADD	HL,HL
	LD	BC,(_MAXCYL-1)
	LD	C,0
	ADD	HL,BC
	LD	BC,(_DRIVE)
	LD	B,00DH
	OUT	(C),C
	INC	C
	OUT	(C),L
	INC	C
	OUT	(C),H

	LD	HL,EDMAD
	CALL	SETDMA
	CALL	GO_DMA
	EX	DE,HL
	POP	DE
	POP	BC
DMA_ADD_SEC:
	INC	DE
	DJNZ	DMA_ADD_SEC
	XOR	A
	RET

EDMAD:
	DB	0C3H	;WR6 リセット
	DB	07DH	;WR0 ポートA→ポートB 転送
	DW	00D03H	;ポートA開始アドレス EMMリード/ライト
DMALEN:	DW	001FFH	;ブロック長(転送サイズ-1)
	DB	02CH	;WR1 ポートAアドレス固定 I/O
	DB	050H	;WR2 ポートBアドレスインクリメント メモリ
	DB	002H	;ポートBタイミング
	DB	080H	;WR3
	DB	09AH	;WR5 WAIT RDY:HIGH
	DB	0ADH	;WR4 連続 ポートB開始アドレス
DMAB:	DW	0
	DB	001H	;WR0 ポートA←ポートB 転送
EMME:

AT_RE	EQU	EDWT-AT_EDWT

