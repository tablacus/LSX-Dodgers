                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for MZ-700/1500
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "M7DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MZ-700/1500
                                
       0001                     MAC EQU 1   ;MZ-700/1500
       0000                     DEV EQU 0
                                
       011D                     VER_6F  EQU 0011DH
                                
       8080                     RUN EQU 08080H
       8000                     OFFSET  EQU RUN-128
       CF06                     BDOS    EQU 0CF06H
       ED40                     TABLEAD EQU 0ED40H
       F300                     KEYBF   EQU 0F300H
       F330                     FATBF   EQU 0F330H
       FB30                     DTBUF   EQU 0FB30H
       FF30                     KBUF    EQU 0FF30H
       FFD9                     TRAP38  EQU 0FFD9H
       0028                     WIDTH   EQU 40
       0019                     LINE    EQU 25
       0070                     COLORF  EQU 070H
       0010                     KEYSP_H EQU 16
       0083                     KEYSP_L EQU 131
       0009                     COMS    EQU 9
       0004                     MAX_SEC_SZ_H    EQU 4       ;1セクタ1024バイトのサポート(2:off 4:on)
       0100                     BUFFER  EQU 00100H
       D0E4                     S27BUF_COM  EQU S27BUF
[EOF:M7DEF.ASM:UTF_8]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0001                     VER_3   EQU 1
       1D01                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0001                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0161                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 8000                         ORG OFFSET
                                                    ;MZTヘッダ128バイト
000000 8000 01                      DB  1           ;ファイルモード
000001 8001 4C44202020202020        DB  "LD           "     ;ファイル名(13)
            2020202020          
00000E 800E 535953                  DB  "SYS"           ;拡張子(3)
000011 8011 0D                      DB  $0D
000012 8012 3D25                    DW  LAST_ADR-RUN        ;サイズ
000014 8014 8080                    DW  RUN         ;開始アドレス
000016 8016 8080                    DW  RUN         ;実行アドレス
000018 8018                         DS  104
                                
                                    INCLUDE "M7INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   MZ-700/1500
                                
000080 8080 C38780          10      JP  START
000083 8083 011D                    DW  MACW
000085 8085 6101                    DW  VER
                                
       8087                     START:
000087 8087 F3               4      DI
000088 8088 ED56             8      IM  1
00008A 808A 318780          10      LD  SP,START
00008D 808D CD9B80          17      CALL    INIT        ;NZならAUTOEXECを実行
000090 8090 210000          10      LD  HL,0
000093 8093 E5              11      PUSH    HL
000094 8094 C8              11      RET Z
000095 8095 117981          10      LD  DE,AUTOD
000098 8098 C3FDF0          10      JP  _COMANL
                                
       809B                     INIT:
00009B 809B D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFFH)
00009D 809D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00009F 809F 21DF81          10      LD  HL,INITE
0000A2 80A2 1106CF          10      LD  DE,BDOS
0000A5 80A5 01DE23          10      LD  BC,LAST_ADR-INITE
0000A8 80A8 EDB0                    LDIR
0000AA 80AA 21B081          10      LD  HL,M7BEEPD
0000AD 80AD 1162F0          10      LD  DE,BEEPD+1
0000B0 80B0 010800          10      LD  BC,M7BEEPE-M7BEEPD
0000B3 80B3 EDB0                    LDIR
                                
0000B5 80B5 210000          10      LD  HL,0
0000B8 80B8 065C             7      LD  B,05CH
0000BA 80BA 3E                      DB  03EH    ;LD A,??
0000BB 80BB EF              12      RST 28H
0000BC 80BC CD48DC          17      CALL    FILL_MEMORY
0000BF 80BF 06A4             7      LD  B,0A4H
0000C1 80C1 AF               4      XOR A
0000C2 80C2 320400          13      LD  (_DVSW),A
0000C5 80C5 CD48DC          17      CALL    FILL_MEMORY
                                
0000C8 80C8 3EC3             7      LD  A,0C3H      ;JP
0000CA 80CA 2103F0          10      LD  HL,CPM_WBOOT
0000CD 80CD 320000          13      LD  (00000H),A
0000D0 80D0 220100          16      LD  (00001H),HL ;IPL
                                
0000D3 80D3 2106CF          10      LD  HL,BDOS
0000D6 80D6 320500          13      LD  (00005H),A
0000D9 80D9 220600          16      LD  (00006H),HL ;BDOS
                                
0000DC 80DC 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000DF 80DF 322800          13      LD  (00028H),A
0000E2 80E2 222900          16      LD  (00029H),HL ;RST 028H
                                
0000E5 80E5 323800          13      LD  (00038H),A
0000E8 80E8 210ECF          10      LD  HL,IO_INT8253
0000EB 80EB 223900          16      LD  (00039H),HL
                                
0000EE 80EE 215BF0          10      LD  HL,_DISKE+1
0000F1 80F1 2223F3          16      LD  (DISKVE),HL
0000F4 80F4 21F5F0          10      LD  HL,_BREAK+1
0000F7 80F7 2225F3          16      LD  (BREAKV),HL
                                
0000FA 80FA 3EF0             7      LD  A,CPM_BOOT/256
0000FC 80FC 320B00          13      LD  (0000BH),A
                                
0000FF 80FF 3EE9             7      LD  A,0E9H      ;JP (HL)
000101 8101 320F00          13      LD  (0000FH),A
                                                ;CHECK PCG(MZ-1500)
000104 8104 2100E8          10      LD  HL,0E800H
000107 8107 46               7      LD  B,(HL)
000108 8108 F3               4      DI
000109 8109 3E01             7      LD  A,1
00010B 810B D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00010D 810D 4E               7      LD  C,(HL)
00010E 810E 79               4      LD  A,C
00010F 810F C6A5             7      ADD A,0A5H
000111 8111 5F               4      LD  E,A
000112 8112 73               7      LD  (HL),E
000113 8113 D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
000115 8115 71               7      LD  (HL),C
000116 8116 3E01             7      LD  A,1
000118 8118 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00011A 811A 7E               7      LD  A,(HL)
00011B 811B BB               4      CP  E
00011C 811C D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
00011E 811E 70               7      LD  (HL),B
00011F 811F FB               4      EI
000120 8120 2804            12      JR  Z,MZ1500
000122 8122 AF               4      XOR A       ;MZ-700はPCGバンクが存在しない
000123 8123 32C0F2          13      LD  (GRAMFL),A
       8126                     MZ1500:
000126 8126 DD2180F2        14      LD  IX,EMMFL
00012A 812A CD6E81          17      CALL    CHECK_EMM_BPB
00012D 812D FEEB             7      CP  0EBH
00012F 812F 2810            12      JR  Z,EMM_BPB
000131 8131 DD360D02        19      LD  (IX+DPB_MAXSEC),2   ;BPBが512バイト目から始まる場合を調べる
000135 8135 CD6E81          17      CALL    CHECK_EMM_BPB
000138 8138 DDBE06          19      CP  (IX+DPB_FATID)
00013B 813B 2004            12      JR  NZ,EMM_BPB
00013D 813D DD360D00        19      LD  (IX+DPB_MAXSEC),0   ;BPBが先頭の場合に戻す
       8141                     EMM_BPB:
000141 8141 218581          10      LD  HL,INIMES
000144 8144 CD88D4          17      CALL    MSX
       8147                     INIT1:
000147 8147 F3               4      DI
000148 8148 1100FF          10      LD  DE,0FF00H
00014B 814B 0600             7      LD  B,0
00014D 814D CD26D3          17      CALL    ZERO_MEMORY_DE
000150 8150 21CAFF          10      LD  HL,EXTBIO
000153 8153 36C9            10      LD  (HL),0C9H   ;RET
000155 8155 23               6      INC HL
000156 8156 060E             7      LD  B,TRAP38-EXTBIO-1
000158 8158 3E                      DB  03EH    ;LD A,??
000159 8159 EF              12      RST 28H
00015A 815A CD48DC          17      CALL    FILL_MEMORY
00015D 815D 21B881          10      LD  HL,AT_TRAP38
000160 8160 11D9FF          10      LD  DE,TRAP38
000163 8163 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
000166 8166 EDB0                    LDIR
                                
000168 8168 CD13DB          17      CALL    CHKEY
00016B 816B FE03             7      CP  3
00016D 816D C9              10      RET
                                
       816E                     CHECK_EMM_BPB:
00016E 816E D5              11      PUSH    DE
00016F 816F 110000          10      LD  DE,0
000172 8172 CD74EA          17      CALL    EADR
000175 8175 D1              10      POP DE
000176 8176 ED78            12      IN  A,(C)
000178 8178 C9              10      RET
                                
000179 8179 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000182 8182 413A00              AUTODV: DB  "A:",0
                                
000185 8185 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MZ-700/1500 v"
            6765727320666F72    
            204D5A2D3730302F    
            313530302076        
0001A3 81A3 312E                    DB  030H + VER_1, '.'
0001A5 81A5 3631                    DB  030H + VER_2 ,030H + VER_3
0001A7 81A7 66                      DB  'f'
0001A8 81A8 2047616B750D0A          DB  " Gaku",0DH,0AH
0001AF 81AF 00                      DB  0
                                
       81B0                     M7BEEPD:
0001B0 81B0 0801                    DB  8,1
0001B2 81B2 0736                    DB  7,036H
0001B4 81B4 04F9                    DB  4,0F9H
0001B6 81B6 0403                    DB  4,3
       81B8                     M7BEEPE:
                                
       81B8                     AT_TRAP38:
0001B8 FFD9                         ORG TRAP38,AT_TRAP38-OFFSET
0001B8 FFD9 210000          10      LD  HL,0
0001BB FFDC E3              19      EX  (SP),HL
0001BC FFDD 3E24             7      LD  A,'$'
0001BE FFDF CD71D7          17      CALL    MSG_A
0001C1 FFE2 2B               6      DEC HL
0001C2 FFE3 7C               4      LD  A,H
0001C3 FFE4 CDE8FF          17      CALL    PRHX
0001C6 FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
0001C7 FFE8 F5              11      PUSH    AF
0001C8 FFE9 07               4      RLCA
0001C9 FFEA 07               4      RLCA
0001CA FFEB 07               4      RLCA
0001CB FFEC 07               4      RLCA
0001CC FFED CDF1FF          17      CALL    PRHX2
0001CF FFF0 F1              10      POP AF
       FFF1                     PRHX2:
0001D0 FFF1 E60F             7      AND 00FH
0001D2 FFF3 FE0A             7      CP  10
0001D4 FFF5 3F               4      CCF
0001D5 FFF6 CE30             7      ADC A,'0'
0001D7 FFF8 27               4      DAA
0001D8 FFF9 C371D7          10      JP  MSG_A
0001DB FFFC                         DS  4
0001DF 81DF                         ORG $$+OFFSET,$$    ;$DEPHASE
       81DF                     AT_TRAPE:
                                
       81DF                     INITE:
0001DF CF06                         ORG BDOS,INITE-OFFSET
                                
0001DF CF06 C309CF          10      JP  IO_BDOS
[EOF:M7INIT.ASM:SHIFT_JIS]
                                    INCLUDE "M7BANK.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                ;   VRAM/KEY/TIMER(0D000H-0EFFFH)にアクセスするので0D000H-0FFFFHに置けない部分
                                ;
                                
       CF09                     IO_BDOS:
0001E2 CF09 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001E4 CF0B C348D4          10      JP  BDOS0
                                
       CF0E                     IO_INT8253:
0001E7 CF0E F3               4      DI
0001E8 CF0F F5              11      PUSH    AF
0001E9 CF10 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001EB CF12 3E01             7      LD  A,1
0001ED CF14 3206E0          13      LD  (0E006H),A  ;8253 Ch.2 カウンタ
0001F0 CF17 AF               4      XOR A
0001F1 CF18 3206E0          13      LD  (0E006H),A  ;8253 Ch.2 カウンタ
0001F4 CF1B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001F6 CF1D C320D7          10      JP  INT8253
                                
       CF20                     RDKEYDATA:
0001F9 CF20 F3               4      DI
0001FA CF21 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001FC CF23 3200E0          13      LD  (0E000H),A
0001FF CF26 3A01E0          13      LD  A,(E001H)
000202 CF29 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000204 CF2B FB               4      EI
000205 CF2C C9              10      RET
                                
       CF2D                     RD556VSYNC:
000206 CF2D F3               4      DI
000207 CF2E D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000209 CF30 3A02E0          13      LD  A,(0E002H)
00020C CF33 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00020E CF35 FB               4      EI
00020F CF36 C9              10      RET
                                
       CF37                     RDMMIO:
000210 CF37 F3               4      DI
000211 CF38 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000213 CF3A 7E               7      LD  A,(HL)
000214 CF3B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000216 CF3D FB               4      EI
000217 CF3E C9              10      RET
                                
       CF3F                     WRMMIO:
000218 CF3F F3               4      DI
000219 CF40 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00021B CF42 77               7      LD  (HL),A
00021C CF43 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00021E CF45 FB               4      EI
00021F CF46 C9              10      RET
                                
       CF47                     RDMMIO_BC:
000220 CF47 F3               4      DI
000221 CF48 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000223 CF4A 0A               7      LD  A,(BC)
000224 CF4B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000226 CF4D FB               4      EI
000227 CF4E C9              10      RET
                                
       CF4F                     WRMMIO_BC:
000228 CF4F F3               4      DI
000229 CF50 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00022B CF52 02               7      LD  (BC),A
00022C CF53 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00022E CF55 FB               4      EI
00022F CF56 C9              10      RET
                                
       CF57                     IO_PRINT:
000230 CF57 F3               4      DI
000231 CF58 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000233 CF5A 77               7      LD  (HL),A
000234 CF5B CBDC             8      SET 3,H
000236 CF5D 71               7      LD  (HL),C
000237 CF5E D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000239 CF60 FB               4      EI
00023A CF61 C9              10      RET
                                
       CF62                     IO_CLR:
00023B CF62 F3               4      DI
00023C CF63 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF65                     C1AX1:
00023E CF65 7A               4      LD  A,D
00023F CF66 C6D0             7      ADD A,0D0H
000241 CF68 57               4      LD  D,A
000242 CF69 AF               4      XOR A
000243 CF6A 12               7      LD  (DE),A      ;Text
000244 CF6B CBDA             8      SET 3,D
       CF6E                     ICSMC   EQU $+1
000246 CF6D 3E00             7      LD  A,0     ;自己書き換え
000248 CF6F 12               7      LD  (DE),A      ;Color
000249 CF70 13               6      INC DE
00024A CF71 7A               4      LD  A,D
00024B CF72 D6D8             7      SUB 0D8H
00024D CF74 57               4      LD  D,A
00024E CF75 2118FC          10      LD  HL,0-WIDTH*LINE
000251 CF78 19              11      ADD HL,DE
000252 CF79 30EA            12      JR  NC,C1AX1
000254 CF7B E1              10      POP HL
000255 CF7C D1              10      POP DE
000256 CF7D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000258 CF7F FB               4      EI
000259 CF80 C9              10      RET
                                
       CF81                     IO_CLLINE:
00025A CF81 F3               4      DI
00025B CF82 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF84                     CLLINE1:
00025D CF84 CB9C             8      RES 3,H
00025F CF86 77               7      LD  (HL),A      ;Text
000260 CF87 CBDC             8      SET 3,H
000262 CF89 71               7      LD  (HL),C      ;Color
000263 CF8A 23               6      INC HL
000264 CF8B 10F7            13      DJNZ    CLLINE1
000266 CF8D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000268 CF8F FB               4      EI
000269 CF90 C9              10      RET
                                
       CF91                     IO_INSBS:
00026A CF91 F3               4      DI
00026B CF92 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF94                     IO_INSBS1:
00026D CF94 CB9C             8      RES 3,H
00026F CF96 5E               7      LD  E,(HL)
000270 CF97 77               7      LD  (HL),A
000271 CF98 7B               4      LD  A,E
000272 CF99 CBDC             8      SET 3,H
000274 CF9B 5E               7      LD  E,(HL)
000275 CF9C 71               7      LD  (HL),C
000276 CF9D 4B               4      LD  C,E
       CF9E                     IO_INCDEC   EQU $   ; 自己書き換え
000277 CF9E 23               6      INC HL      ;INS->INC HL or BS->DEC HL
000278 CF9F 10F3            13      DJNZ    IO_INSBS1
00027A CFA1 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00027C CFA3 FB               4      EI
00027D CFA4 C9              10      RET
                                
       CFA5                     IO_SCRUP:
00027E CFA5 F3               4      DI
00027F CFA6 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CFA8                     SCRUP1:
000281 CFA8 2815            12      JR  Z,SCRCL
000283 CFAA D5              11      PUSH    DE
000284 CFAB E5              11      PUSH    HL
000285 CFAC CBDA             8      SET 3,D
000287 CFAE CBDC             8      SET 3,H
000289 CFB0 012800          10      LD  BC,WIDTH
00028C CFB3 EDB0                    LDIR
00028E CFB5 E1              10      POP HL
00028F CFB6 D1              10      POP DE
000290 CFB7 012800          10      LD  BC,WIDTH
000293 CFBA EDB0                    LDIR
000295 CFBC 3D               4      DEC A
000296 CFBD 18E9            12      JR  SCRUP1
                                
       CFBF                     SCRCL:
000298 CFBF 0628             7      LD  B,WIDTH
00029A CFC1 EB               4      EX  DE,HL
00029B CFC2 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00029D CFC4 CD6AD9          17      CALL    CLLINE
0002A0 CFC7 E1              10      POP HL
0002A1 CFC8 D1              10      POP DE
0002A2 CFC9 C1              10      POP BC
0002A3 CFCA C9              10      RET
                                
       CFCB                     RD_PCG:
0002A4 CFCB F3               4      DI
0002A5 CFCC D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
0002A7 CFCE 4E               7      LD  C,(HL)
       CFCF                     RW_PCG:
0002A8 CFCF D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
0002AA CFD1 FB               4      EI
0002AB CFD2 C9              10      RET
                                
       CFD3                     WR_PCG:
0002AC CFD3 F3               4      DI
0002AD CFD4 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
0002AF CFD6 71               7      LD  (HL),C
0002B0 CFD7 18F6            12      JR  RW_PCG
                                
       CFD9                     IO_MON:
0002B2 CFD9 D3E4            11      OUT (0E4H),A    ;MONITOR ROM(0000H-0FFFH) & VRAM/KEY/TIMER(D000H-FFFFH)
0002B4 CFDB C7              12      RST 0
                                
       CFDC                     INITINT:
0002B5 CFDC D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0002B7 CFDE 2107E0          10      LD  HL,0E007H   ;HL=0E007H 8253 コントロール
0002BA CFE1 36B0            10      LD  (HL),0B0H   ;Ch.2 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 0 16ビットバイナリ
0002BC CFE3 3674            10      LD  (HL),074H   ;Ch.1 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 2 16ビットバイナリ
0002BE CFE5 2D               4      DEC L       ;0E006H 8253 Ch.2 カウンタ
0002BF CFE6 3602            10      LD  (HL),2
0002C1 CFE8 3600            10      LD  (HL),0
0002C3 CFEA 2D               4      DEC L       ;0E005H 8253 Ch.1 カウンタ
0002C4 CFEB 77               7      LD  (HL),A
0002C5 CFEC 3600            10      LD  (HL),0
0002C7 CFEE 7D               4      LD  A,L     ;L=5
0002C8 CFEF 3203E0          13      LD  (0E003H),A  ;8255 コントロールポートでポートC(0E002H)のINTMSKを1にする
0002CB CFF2 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0002CD CFF4 C9              10      RET
                                
       CFF5                     BANKE:
0002CE CFF5                         DS  0CFFEH-BANKE
[EOF:M7BANK.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MZ-700/1500
                                
       CFFE                     WBOOT1:
0002D7 CFFE D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)　ここは0CFFEH
0002D9 D000 D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFHH)
0002DB D002 F3               4      DI
0002DC D003 3A94F0          13      LD  A,(_KEYSP)
0002DF D006 CDDCCF          17      CALL    INITINT
0002E2 D009 ED7B0600        20      LD  SP,(SYSTEM+1)
0002E6 D00D FB               4      EI
0002E7 D00E 2192F0          10      LD  HL,_KEYD
0002EA D011 3600            10      LD  (HL),0
0002EC D013 CD13DB          17      CALL    CHKEY
0002EF D016 CD5ED7          17      CALL    KEYBC_IFBREAK
0002F2 D019 3E04             7      LD  A,4
0002F4 D01B CD71D7          17      CALL    MSG_A
[EOF:M7CCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D01E                     COMMAND:
0002F7 D01E 3A72EB          13      LD  A,(FCB_BAT)
0002FA D021 B7               4      OR  A
0002FB D022 C260D1          10      JP  NZ,C_BAT1
0002FE D025 CDD4D0          17      CALL    SETDTA1
000301 D028 3A0400          13      LD  A,(_DVSW)
000304 D02B C641             7      ADD A,'A'
000306 D02D CD71D7          17      CALL    MSG_A
000309 D030 3E3E             7      LD  A,'>'
00030B D032 CD71D7          17      CALL    MSG_A
00030E D035 3E50             7      LD  A,80
000310 D037 12               7      LD  (DE),A
000311 D038 CDD1D7          17      CALL    _SYS0A      ;(BDOS)文字列入力
000314 D03B CD55D2          17      CALL    LTNL
       D03E                     COMMAND2:
000317 D03E 118200          10      LD  DE,DTA1+2
00031A D041 CDFDF0          17      CALL    _COMANL
00031D D044 DC0CD7          17      CALL    C,SHOW_ERROR
000320 D047 18D5            12      JR  COMMAND
                                
       D049                     COMANL:
000322 D049 CD9DDB          17      CALL    FILE
000325 D04C 3A19F0          13      LD  A,(FNAME+4)
000328 D04F FE20             7      CP  020H
00032A D051 201C            12      JR  NZ,COMB2
00032C D053 D5              11      PUSH    DE
00032D D054 1115F0          10      LD  DE,FNAME
000330 D057 1A               7      LD  A,(DE)
000331 D058 FE20             7      CP  020H
000333 D05A 2844            12      JR  Z,SDVSW
000335 D05C 1B               6      DEC DE
000336 D05D 1A               7      LD  A,(DE)
000337 D05E C6FF             7      ADD A,0FFH
000339 D060 3809            12      JR  C,COMB
00033B D062 13               6      INC DE
                                
00033C D063 2112D4          10      LD  HL,COMTB
00033F D066 0609             7      LD  B,COMS
000341 D068 CD2ADE          17      CALL    CPNAME
       D06B                     COMB:
000344 D06B D1              10      POP DE
000345 D06C D20BD7          10      JP  NC,JPHL
       D06F                     COMB2:
000348 D06F EB               4      EX  DE,HL
000349 D070 223DD1          16      LD  (COMSWC),HL
00034C D073 F5              11      PUSH    AF
00034D D074 CDF5D0          17      CALL    CEXE4
000350 D077 F1              10      POP AF
000351 D078 2115F0          10      LD  HL,FNAME
000354 D07B 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
000357 D07E 010B00          10      LD  BC,11
00035A D081 EDB0                    LDIR
00035C D083 1111EB          10      LD  DE,PATHD
       D086                     CEX1:
00035F D086 1A               7      LD  A,(DE)
000360 D087 FE20             7      CP  020H
000362 D089 D8              11      RET C
000363 D08A CD92DB          17      CALL    FILEC
000366 D08D D5              11      PUSH    DE
000367 D08E 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
00036A D091 1115F0          10      LD  DE,FNAME
00036D D094 010B00          10      LD  BC,11
000370 D097 EDB0                    LDIR
000372 D099 CDF5D0          17      CALL    CEXE4
000375 D09C D1              10      POP DE
000376 D09D 13               6      INC DE
000377 D09E 18E6            12      JR  CEX1
                                
       D0A0                     SDVSW:
000379 D0A0 F1              10      POP AF
00037A D0A1 3A14F0          13      LD  A,(FDRV)
00037D D0A4 3D               4      DEC A
00037E D0A5 5F               4      LD  E,A
00037F D0A6 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
000381 D0A8 1831            12      JR  SYSTEM0
                                
       D0AA                     OPEN1:
000383 D0AA 2114F0          10      LD  HL,FDRV
       D0AD                     OPEN:
000386 D0AD 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D0AF                     OPEN3:
000388 D0AF D5              11      PUSH    DE
000389 D0B0 114DEB          10      LD  DE,DTA_CCP
00038C D0B3 CDD1D0          17      CALL    SETDTA
00038F D0B6 EB               4      EX  DE,HL
000390 D0B7 CDDBD0          17      CALL    SYSTEM0
000393 D0BA D1              10      POP DE
000394 D0BB C9              10      RET
                                
       D0BC                     OPEN2:
000395 D0BC 0E12             7      LD  C,012H
000397 D0BE 18EF            12      JR  OPEN3
                                
       D0C0                     DEFCB:              ;Z=Ok NZ=Error
000399 D0C0 114DEB          10      LD  DE,DTA_CCP
00039C D0C3 CDD9D0          17      CALL    SYSC0F
                                
00039F D0C6 116EEB          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0003A2 D0C9 0604             7      LD  B,4
0003A4 D0CB CD26D3          17      CALL    ZERO_MEMORY_DE
       D0CE                     SETDTA100:
0003A7 D0CE 110001          10      LD  DE,BUFFER
       D0D1                     SETDTA:
0003AA D0D1 C34CD6          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D0D4                     SETDTA1:
0003AD D0D4 118000          10      LD  DE,DTA1
0003B0 D0D7 18F8            12      JR  SETDTA
                                
       D0D9                     SYSC0F:
0003B2 D0D9 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D0DB                     SYSTEM0:
0003B4 D0DB CD0500          17      CALL    SYSTEM
0003B7 D0DE B7               4      OR  A
0003B8 D0DF C9              10      RET
                                
       D0E0                     C_CD:
0003B9 D0E0 0E5A             7      LD  C,05AH
0003BB D0E2 18F7            12      JR  SYSTEM0
                                
       D0E4                     S27BUF:
0003BD D0E4 2100FE          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       D0E7                     S27BUF2:
0003C0 D0E7 39              11      ADD HL,SP
0003C1 D0E8 2E00             7      LD  L,0
0003C3 D0EA 7C               4      LD  A,H
0003C4 D0EB E6F8             7      AND 0F8H
0003C6 D0ED 67               4      LD  H,A
       D0EE                     S27DTA:
0003C7 D0EE 114DEB          10      LD  DE,DTA_CCP
       D0F1                     S27:
0003CA D0F1 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
0003CC D0F3 18E6            12      JR  SYSTEM0
                                
       D0F5                     CEXE4:
0003CE D0F5 211DF0          10      LD  HL,FNAME+8
0003D1 D0F8 7E               7      LD  A,(HL)
0003D2 D0F9 FE20             7      CP  020H
0003D4 D0FB 2007            12      JR  NZ,CEXE7
0003D6 D0FD 3E3F             7      LD  A,'?'
0003D8 D0FF 77               7      LD  (HL),A
0003D9 D100 23               6      INC HL
0003DA D101 77               7      LD  (HL),A
0003DB D102 23               6      INC HL
0003DC D103 77               7      LD  (HL),A
       D104                     CEXE7:
0003DD D104 CDAAD0          17      CALL    OPEN1
       D107                     CEXE5:
0003E0 D107 C0              11      RET NZ
0003E1 D108 2A57EB          16      LD  HL,(DTA_CCP+1+9)
0003E4 D10B 7C               4      LD  A,H
0003E5 D10C CDB9DE          17      CALL    CAP
0003E8 D10F 67               4      LD  H,A
0003E9 D110 7D               4      LD  A,L
0003EA D111 CDB9DE          17      CALL    CAP
0003ED D114 6F               4      LD  L,A
0003EE D115 3A56EB          13      LD  A,(DTA_CCP+1+8)
0003F1 D118 CDB9DE          17      CALL    CAP
0003F4 D11B D642             7      SUB 'B'
0003F6 D11D 282C            12      JR  Z,C_BAT
0003F8 D11F 3D               4      DEC A       ;'C'
0003F9 D120 2805            12      JR  Z,C_EXE
       D122                     CEXE6:
0003FB D122 CDBCD0          17      CALL    OPEN2
0003FE D125 18E0            12      JR  CEXE5
                                
       D127                     C_EXE:
000400 D127 7C               4      LD  A,H
000401 D128 FE4D             7      CP  'M'
000403 D12A 20F6            12      JR  NZ,CEXE6
                                
000405 D12C CDC0D0          17      CALL    DEFCB
000408 D12F CDE4D0          17      CALL    S27BUF_COM
00040B D132 3D               4      DEC A
00040C D133 37               4      SCF
00040D D134 C0              11      RET NZ
00040E D135 7C               4      LD  A,H
00040F D136 B5               4      OR  L
000410 D137 37               4      SCF
000411 D138 C8              11      RET Z
000412 D139 CDD4D0          17      CALL    SETDTA1
000415 D13C 110000          10      LD  DE,0                ; self-modifying code
       D13D                     COMSWC  EQU $-2
000418 D13F ED7B0600        20      LD  SP,(SYSTEM+1)
00041C D143 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
00041D D144 6F               4      LD  L,A
00041E D145 E5              11      PUSH    HL              ; push $0000 (reboot address)
00041F D146 24               4      INC H
000420 D147 E5              11      PUSH    HL              ; push $0100 (TPA address)
000421 D148 C3F1D2          10      JP  SETFCB              ; and JP $0100
                                
       D14B                     C_BAT:
000424 D14B 114154          10      LD  DE,'A'+'T'*256
000427 D14E ED52            15      SBC HL,DE
000429 D150 20D0            12      JR  NZ,CEXE6
                                
00042B D152 CDC0D0          17      CALL    DEFCB
                                
00042E D155 214DEB          10      LD  HL,DTA_CCP
000431 D158 1172EB          10      LD  DE,FCB_BAT
000434 D15B 012500          10      LD  BC,37
000437 D15E EDB0                    LDIR
       D160                     C_BAT1:
000439 D160 CDCED0          17      CALL    SETDTA100
00043C D163 CD97D1          17      CALL    FGETC_BAT
00043F D166 218100          10      LD  HL,DTA1+1
000442 D169 2025            12      JR  NZ,END_BATCH
000444 D16B FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
000446 D16D 38F1            12      JR  C,C_BAT1
000448 D16F 3620            10      LD  (HL),' '
00044A D171 23               6      INC HL
       D172                     C_BAT2:
00044B D172 77               7      LD  (HL),A
00044C D173 23               6      INC HL
00044D D174 7D               4      LD  A,L
00044E D175 3C               4      INC A       ;L==0FFH
00044F D176 2809            12      JR  Z,RUN_BATCH
000451 D178 CD97D1          17      CALL    FGETC_BAT
000454 D17B 2004            12      JR  NZ,RUN_BATCH
000456 D17D FE20             7      CP  020H
000458 D17F 30F1            12      JR  NC,C_BAT2
       D181                     RUN_BATCH:
00045A D181 7D               4      LD  A,L
00045B D182 D67F             7      SUB DTA1-1
00045D D184 328000          13      LD  (DTA1),A
000460 D187 FE04             7      CP  4
000462 D189 3805            12      JR  C,END_BATCH
000464 D18B 3600            10      LD  (HL),0
000466 D18D C33ED0          10      JP  COMMAND2
       D190                     END_BATCH:
000469 D190 AF               4      XOR A       ;バッチファイルを閉じる
00046A D191 3272EB          13      LD  (FCB_BAT),A
00046D D194 C300F0          10      JP  CPM_BOOT
                                
       D197                     FGETC_BAT:
000470 D197 1172EB          10      LD  DE,FCB_BAT
       D19A                     FGETC:              ;1文字ずつ読み込む
000473 D19A E5              11      PUSH    HL      ;Z:成功
000474 D19B 210100          10      LD  HL,1
000477 D19E CDF1D0          17      CALL    S27
00047A D1A1 E1              10      POP HL
00047B D1A2 3A0001          13      LD  A,(BUFFER)
00047E D1A5 C9              10      RET
                                
       D1A6                     C_DEL:
00047F D1A6 CDF1D2          17      CALL    SETFCB
000482 D1A9 CD87D7          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
000485 D1AC 0E13             7      LD  C,013H
000487 D1AE 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D1B0                     C_REN:
000489 D1B0 CDF1D2          17      CALL    SETFCB
00048C D1B3 3E10             7      LD  A,010H      ;ディレクトリも対象にする
00048E D1B5 326900          13      LD  (FCB1+13),A ;属性
000491 D1B8 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D1BA                     CDEL1:
000493 D1BA 115C00          10      LD  DE,FCB1
000496 D1BD CD0500          17      CALL    SYSTEM
000499 D1C0 C6FF             7      ADD A,0FFH
00049B D1C2 C9              10      RET
                                
       D1C3                     C_DIR:
00049C D1C3 CD92DB          17      CALL    FILEC
00049F D1C6 2115F0          10      LD  HL,FDRV+1
0004A2 D1C9 CD07D4          17      CALL    CWILD1
0004A5 D1CC 3EF1             7      LD  A,0F1H
0004A7 D1CE 3221F0          13      LD  (FDRV+13),A
0004AA D1D1 CDAAD0          17      CALL    OPEN1
       D1D4                     CDIR1:
0004AD D1D4 B7               4      OR  A
0004AE D1D5 2008            12      JR  NZ,PDSKF
0004B0 D1D7 CD22D2          17      CALL    P_NAME
0004B3 D1DA CDBCD0          17      CALL    OPEN2
0004B6 D1DD 18F5            12      JR  CDIR1
       D1DF                     PDSKF:
0004B8 D1DF 3A14F0          13      LD  A,(FDRV)
0004BB D1E2 5F               4      LD  E,A
0004BC D1E3 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
0004BE D1E5 CD0500          17      CALL    SYSTEM
0004C1 D1E8 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
0004C2 D1E9 C601             7      ADD A,001H
0004C4 D1EB D8              11      RET C       ;Aが0FFHだった場合
0004C5 D1EC 3E06             7      LD  A,8-2
       D1EE                     PDS1:               ;HL=未使用クラスタの総数
0004C7 D1EE 3C               4      INC A
0004C8 D1EF CB19             8      RR  C
0004CA D1F1 30FB            12      JR  NC,PDS1
       D1F3                     PDS2:               ;B←論理セクタのサイズの上位8ビット
0004CC D1F3 3C               4      INC A
0004CD D1F4 CB18             8      RR  B
0004CF D1F6 30FB            12      JR  NC,PDS2
0004D1 D1F8 47               4      LD  B,A
                                
0004D2 D1F9 110000          10      LD  DE,0
       D1FC                     PDS3:
0004D5 D1FC 29              11      ADD HL,HL
0004D6 D1FD EB               4      EX  DE,HL
0004D7 D1FE ED6A            15      ADC HL,HL
0004D9 D200 EB               4      EX  DE,HL
0004DA D201 10F9            13      DJNZ    PDS3
       D203                     PDSKF1:
0004DC D203 CD8FD2          17      CALL    PRDEC_DEHL
0004DF D206 11A2EB          10      LD  DE,FREE
0004E2 D209 CD79D4          17      CALL    _SYS09      ;(BDOS)文字列出力
0004E5 D20C CD7CD2          17      CALL    PUTDRV
0004E8 D20F 3E5C             7      LD  A,05CH      ;\
0004EA D211 CD71D7          17      CALL    MSG_A
0004ED D214 2A22F0          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
0004F0 D217 AF               4      XOR A
0004F1 D218 11FEFF          10      LD  DE,0-2
0004F4 D21B 19              11      ADD HL,DE
0004F5 D21C 23               6      INC HL
0004F6 D21D DC8CD2          17      CALL    C,PRDEC_HL
0004F9 D220 1833            12      JR  LTNL
                                
       D222                     P_NAME:
0004FB D222 3A4EEB          13      LD  A,(DTA_CCP+1)
0004FE D225 FE2E             7      CP  '.'
000500 D227 C8              11      RET Z
                                
000501 D228 3A59EB          13      LD  A,(DTA_CCP+1+00BH)
000504 D22B F5              11      PUSH    AF
000505 D22C CB67             8      BIT 4,A
000507 D22E 2808            12      JR  Z,DIR3
000509 D230 1197EB          10      LD  DE,DIRMES
00050C D233 CD79D4          17      CALL    _SYS09      ;(BDOS)文字列出力
00050F D236 180A            12      JR  DIR6
       D238                     DIR3:
000511 D238 ED5B6CEB        20      LD  DE,(DTA_CCP+1+01EH)
000515 D23C 2A6AEB          16      LD  HL,(DTA_CCP+1+01CH)
000518 D23F CD8FD2          17      CALL    PRDEC_DEHL
       D242                     DIR6:
00051B D242 F1              10      POP AF
00051C D243 0F               4      RRCA
00051D D244 9F               4      SBC A,A
00051E D245 E60A             7      AND '*'-020H
000520 D247 C620             7      ADD A,020H
000522 D249 CD71D7          17      CALL    MSG_A
000525 D24C CD7CD2          17      CALL    PUTDRV
000528 D24F 214EEB          10      LD  HL,DTA_CCP+1
00052B D252 CDCFD2          17      CALL    FPRNT
                                
       D255                     LTNL:
00052E D255 1E03             7      LD  E,3
000530 D257 C3CDF0          10      JP  _PRINT
                                
       D25A                     C_PATH:
000533 D25A CD73DC          17      CALL    SPCUT
000536 D25D 2111EB          10      LD  HL,PATHD
000539 D260 FE21             7      CP  021H
00053B D262 300C            12      JR  NC,CPATH0
       D264                     CPATHP:
00053D D264 7E               7      LD  A,(HL)
00053E D265 23               6      INC HL
00053F D266 FE20             7      CP  020H
000541 D268 3F               4      CCF
000542 D269 30EA            12      JR  NC,LTNL
000544 D26B CD71D7          17      CALL    MSG_A
000547 D26E 18F4            12      JR  CPATHP
       D270                     CPATH0:
000549 D270 FE3B             7      CP  ';'
00054B D272 2001            12      JR  NZ,CPATH1
00054D D274 13               6      INC DE
       D275                     CPATH1:
00054E D275 EB               4      EX  DE,HL
00054F D276 013B00          10      LD  BC,PATHX
000552 D279 EDB0                    LDIR
000554 D27B C9              10      RET
                                
       D27C                     PUTDRV:
000555 D27C 3A14F0          13      LD  A,(FDRV)
000558 D27F CDA6DC          17      CALL    GETDRV1
00055B D282 C641             7      ADD A,'A'
00055D D284 CD71D7          17      CALL    MSG_A
000560 D287 3E3A             7      LD  A,':'
       D289                     MSG_AR:
000562 D289 C371D7          10      JP  MSG_A
                                
       D28C                     PRDEC_HL:
000565 D28C AF               4      XOR A
000566 D28D 5F               4      LD  E,A
000567 D28E 57               4      LD  D,A
       D28F                     PRDEC_DEHL:
000568 D28F D5              11      PUSH    DE
000569 D290 110FF0          10      LD  DE,DECBF
00056C D293 0605             7      LD  B,5
00056E D295 CD26D3          17      CALL    ZERO_MEMORY_DE  ;A=0
000571 D298 D1              10      POP DE
                                
000572 D299 0E20             7      LD  C,32
       D29B                     DEC1:
000574 D29B 29              11      ADD HL,HL
000575 D29C EB               4      EX  DE,HL
000576 D29D ED6A            15      ADC HL,HL
000578 D29F EB               4      EX  DE,HL
000579 D2A0 E5              11      PUSH    HL
00057A D2A1 2113F0          10      LD  HL,DECBF+4
00057D D2A4 0605             7      LD  B,5
       D2A6                     DEC2:
00057F D2A6 7E               7      LD  A,(HL)
000580 D2A7 8F               4      ADC A,A
000581 D2A8 27               4      DAA
000582 D2A9 77               7      LD  (HL),A
000583 D2AA 2B               6      DEC HL
000584 D2AB 10F9            13      DJNZ    DEC2
000586 D2AD E1              10      POP HL
000587 D2AE 0D               4      DEC C
000588 D2AF 20EA            12      JR  NZ,DEC1
                                
00058A D2B1 210FF0          10      LD  HL,DECBF
00058D D2B4 3E20             7      LD  A,020H
00058F D2B6 0604             7      LD  B,4
       D2B8                     DEC3:
000591 D2B8 CDC5D2          17      CALL    DEC4
000594 D2BB CDC5D2          17      CALL    DEC4
000597 D2BE 23               6      INC HL
000598 D2BF 10F7            13      DJNZ    DEC3
       D2C1                     DECX:
00059A D2C1 CDC5D2          17      CALL    DEC4
00059D D2C4 AF               4      XOR A
       D2C5                     DEC4:
00059E D2C5 ED6F            18      RLD
0005A0 D2C7 FE20             7      CP  020H
0005A2 D2C9 2802            12      JR  Z,DEC5
0005A4 D2CB F630             7      OR  030H
       D2CD                     DEC5:
0005A6 D2CD 18BA            12      JR  MSG_AR
                                
       D2CF                     FPRNT:
0005A8 D2CF 0608             7      LD  B,8 ;ファイル名を表示
0005AA D2D1 CDE0D2          17      CALL    P_N1
0005AD D2D4 7E               7      LD  A,(HL)
0005AE D2D5 CDC5DE          17      CALL    CAP3
0005B1 D2D8 D8              11      RET C   ;拡張子が無い
                                
0005B2 D2D9 3E2E             7      LD  A,'.'
0005B4 D2DB CD71D7          17      CALL    MSG_A
0005B7 D2DE 0603             7      LD  B,3 ;拡張子を表示
       D2E0                     P_N1:
0005B9 D2E0 7E               7      LD  A,(HL)
0005BA D2E1 CDC5DE          17      CALL    CAP3
0005BD D2E4 3807            12      JR  C,P_N2
0005BF D2E6 CD71D7          17      CALL    MSG_A
0005C2 D2E9 23               6      INC HL
0005C3 D2EA 10F4            13      DJNZ    P_N1
0005C5 D2EC C9              10      RET
       D2ED                     P_N2:
0005C6 D2ED 23               6      INC HL
0005C7 D2EE 10FD            13      DJNZ    P_N2
0005C9 D2F0 C9              10      RET
                                
       D2F1                     SETFCB:
0005CA D2F1 CD73DC          17      CALL    SPCUT
0005CD D2F4 1A               7      LD  A,(DE)
0005CE D2F5 FE20             7      CP  020H
0005D0 D2F7 3801            12      JR  C,SETFCBA
0005D2 D2F9 1B               6      DEC DE
       D2FA                     SETFCBA:
0005D3 D2FA 0624             7      LD  B,36
0005D5 D2FC 215C00          10      LD  HL,FCB1
0005D8 D2FF E5              11      PUSH    HL
0005D9 D300 AF               4      XOR A
0005DA D301 CD48DC          17      CALL    FILL_MEMORY
0005DD D304 E1              10      POP HL
0005DE D305 D5              11      PUSH    DE
0005DF D306 CDB2D6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005E2 D309 216C00          10      LD  HL,FCB2
0005E5 D30C CDB2D6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005E8 D30F E1              10      POP HL
0005E9 D310 010050          10      LD  BC,05000H
0005EC D313 118100          10      LD  DE,00081H
       D316                     SETFCB1:
0005EF D316 7E               7      LD  A,(HL)
0005F0 D317 23               6      INC HL
0005F1 D318 FE20             7      CP  020H
0005F3 D31A 3805            12      JR  C,SETFCB2
0005F5 D31C 12               7      LD  (DE),A
0005F6 D31D 13               6      INC DE
0005F7 D31E 0C               4      INC C
0005F8 D31F 10F5            13      DJNZ    SETFCB1
       D321                     SETFCB2:
0005FA D321 79               4      LD  A,C
0005FB D322 328000          13      LD  (DTA1),A
0005FE D325 04               4      INC B
       D326                     ZERO_MEMORY_DE:
0005FF D326 AF               4      XOR A
       D327                     FILL_MEMORY_DE:
000600 D327 12               7      LD  (DE),A
000601 D328 13               6      INC DE
000602 D329 10FC            13      DJNZ    FILL_MEMORY_DE
000604 D32B C9              10      RET
                                
       D32C                     C_COPY:
000605 D32C CDF1D2          17      CALL    SETFCB
                                
000608 D32F 1161F0          10      LD  DE,ZERO
00060B D332 CD95DB          17      CALL    FILEC2
00060E D335 216C00          10      LD  HL,FCB2
000611 D338 CDB9D6          17      CALL    S29X1
                                
000614 D33B 3E10             7      LD  A,010H
000616 D33D 326900          13      LD  (FCB1+13),A
000619 D340 216D00          10      LD  HL,FCB2FN
00061C D343 CD07D4          17      CALL    CWILD1
       D346                     COPY0:
00061F D346 CD04D4          17      CALL    CWILD
000622 D349 215C00          10      LD  HL,FCB1
000625 D34C CDADD0          17      CALL    OPEN
000628 D34F 37               4      SCF
       D350                     COPY1:
000629 D350 C0              11      RET NZ
00062A D351 CDC0D0          17      CALL    DEFCB
                                
00062D D354 3A5AEB          13      LD  A,(DTA_CCP+13)
000630 D357 CB67             8      BIT 4,A
000632 D359 2821            12      JR  Z,COPY1A
                                
000634 D35B 215D00          10      LD  HL,FCB1FN
000637 D35E CDD8DF          17      CALL    CHKWILD
00063A D361 3814            12      JR  C,COPY9
                                
00063C D363 3E20             7      LD  A,020H
00063E D365 325D00          13      LD  (FCB1FN),A
000641 D368 2A67EB          16      LD  HL,(DTA_CCP+26)
000644 D36B 23               6      INC HL
000645 D36C 226A00          16      LD  (FCB1+14),HL
000648 D36F 18D5            12      JR  COPY0
                                
       D371                     COPY8:
00064A D371 CD79D4          17      CALL    _SYS09      ;(BDOS)文字列出力
00064D D374 CD55D2          17      CALL    LTNL
       D377                     COPY9:
000650 D377 CDBCD0          17      CALL    OPEN2
000653 D37A 18D4            12      JR  COPY1
                                
       D37C                     COPY1A:
000655 D37C 216C00          10      LD  HL,FCB2
000658 D37F 1114F0          10      LD  DE,FDRV
00065B D382 014FEB          10      LD  BC,DTA_CCP+2
00065E D385 EDA0            16      LDI
000660 D387 3E0B             7      LD  A,11
       D389                     COPY2:
000662 D389 F5              11      PUSH    AF
000663 D38A 7E               7      LD  A,(HL)
000664 D38B FE3F             7      CP  '?'
000666 D38D 2001            12      JR  NZ,COPY3
000668 D38F 0A               7      LD  A,(BC)
       D390                     COPY3:
000669 D390 12               7      LD  (DE),A
00066A D391 03               6      INC BC
00066B D392 13               6      INC DE
00066C D393 23               6      INC HL
00066D D394 F1              10      POP AF
00066E D395 3D               4      DEC A
00066F D396 20F1            12      JR  NZ,COPY2
000671 D398 010500          10      LD  BC,16-11
000674 D39B EDB0                    LDIR
       D39D                     PUTNAME:
000676 D39D 215D00          10      LD  HL,FCB1FN
000679 D3A0 CDD8DF          17      CALL    CHKWILD
00067C D3A3 300B            12      JR  NC,PUTN1
00067E D3A5 2115F0          10      LD  HL,FDRV+1
000681 D3A8 CDCFD2          17      CALL    FPRNT
000684 D3AB 3E20             7      LD  A,020H
000686 D3AD CD71D7          17      CALL    MSG_A
       D3B0                     PUTN1:
000689 D3B0 1114F0          10      LD  DE,FDRV
00068C D3B3 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
00068E D3B5 CDDBD0          17      CALL    SYSTEM0
000691 D3B8 2048            12      JR  NZ,COPYE2
000693 D3BA 67               4      LD  H,A     ;A=0
000694 D3BB 6F               4      LD  L,A
000695 D3BC 2235F0          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
000698 D3BF 2237F0          16      LD  (FDRV+35),HL
       D3C2                     COPY6:
00069B D3C2 CDE4D0          17      CALL    S27BUF
00069E D3C5 47               4      LD  B,A
00069F D3C6 3C               4      INC A
0006A0 D3C7 2831            12      JR  Z,COPYE
0006A2 D3C9 7C               4      LD  A,H
0006A3 D3CA B5               4      OR  L
0006A4 D3CB 280C            12      JR  Z,COPY7
0006A6 D3CD 1114F0          10      LD  DE,FDRV
0006A9 D3D0 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0006AB D3D2 CDDBD0          17      CALL    SYSTEM0
0006AE D3D5 2023            12      JR  NZ,COPYE
0006B0 D3D7 10E9            13      DJNZ    COPY6
       D3D9                     COPY7:
0006B2 D3D9 3A5AEB          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0006B5 D3DC 3221F0          13      LD  (FDRV+13),A
0006B8 D3DF 2161EB          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
0006BB D3E2 1128F0          10      LD  DE,FDRV+20
0006BE D3E5 010400          10      LD  BC,4
0006C1 D3E8 EDB0                    LDIR
                                
0006C3 D3EA 1114F0          10      LD  DE,FDRV
0006C6 D3ED 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
0006C8 D3EF CDDBD0          17      CALL    SYSTEM0
0006CB D3F2 2006            12      JR  NZ,COPYE
                                
0006CD D3F4 1171F0          10      LD  DE,OK
0006D0 D3F7 C371D3          10      JP  COPY8
                                
       D3FA                     COPYE:
0006D3 D3FA 1114F0          10      LD  DE,FDRV
0006D6 D3FD 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
0006D8 D3FF CD0500          17      CALL    SYSTEM
       D402                     COPYE2:
0006DB D402 37               4      SCF
0006DC D403 C9              10      RET
                                
       D404                     CWILD:
0006DD D404 215D00          10      LD  HL,FCB1FN
       D407                     CWILD1:
0006E0 D407 7E               7      LD  A,(HL)
0006E1 D408 FE20             7      CP  020H
0006E3 D40A C0              11      RET NZ
       D40B                     CWILD2:
0006E4 D40B 3E3F             7      LD  A,'?'
0006E6 D40D 060B             7      LD  B,11
0006E8 D40F C348DC          10      JP  FILL_MEMORY
                                
       D412                     COMTB:
0006EB D412 44202020                DB  "D   "  ;1
0006EF D416 C3D1                    DW  C_DIR
0006F1 D418 44495220                DB  "DIR "  ;2
0006F5 D41C C3D1                    DW  C_DIR
0006F7 D41E 434F5059                DB  "COPY"  ;3
0006FB D422 2CD3                    DW  C_COPY
0006FD D424 43442020                DB  "CD  "  ;4
000701 D428 E0D0                    DW  C_CD
000703 D42A 44454C20                DB  "DEL "  ;5
000707 D42E A6D1                    DW  C_DEL
000709 D430 50415448                DB  "PATH"  ;6
00070D D434 5AD2                    DW  C_PATH
00070F D436 52454E20                DB  "REN "  ;7
000713 D43A B0D1                    DW  C_REN
000715 D43C 52454D20                DB  "REM "  ;8
000719 D440 76D4                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP2.ASM"
                                
                                ;   LSX-Dodgers CCP2
                                ;   MZ-700/1500
                                
00071B D442 4D4F4E20                DB  "MON "  ;9
00071F D446 82DB                    DW  C_MON
[EOF:M7CCP2.ASM:UTF_8]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D448                     BDOS0:
000721 D448 E5              11      PUSH    HL
000722 D449 79               4      LD  A,C
000723 D44A FE3C             7      CP  03CH
000725 D44C 3802            12      JR  C,DOS1
000727 D44E 3E3C             7      LD  A,03CH
       D450                     DOS1:
000729 D450 87               4      ADD A,A
00072A D451 3255D4          13      LD  (DOS1_SWC),A
00072D D454 2A00F1          16      LD  HL,(STABLE)
       D455                     DOS1_SWC    EQU $-2
000730 D457 E3              19      EX  (SP),HL
000731 D458 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
000732 D459 C9              10      RET
       D45A                     _DOS2:
000733 D45A FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000735 D45C CAF4D6          10      JP  Z,_SYS5A
000738 D45F FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
00073A D461 CAB1D6          10      JP  Z,_SYS5C
00073D D464 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
00073F D466 CAD5E8          10      JP  Z,_SYS5F
000742 D469 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000744 D46B 200A            12      JR  NZ,_ERROR
000746 D46D 011D01          10      LD  BC,VER_6F
000749 D470 116101          10      LD  DE,VER
00074C D473 210100          10      LD  HL,MACD
       D476                     C_REM:
00074F D476 AF               4      XOR A
       D477                     _ERROR:
000750 D477 A7               4      AND A
000751 D478 C9              10      RET
                                
       D479                     _SYS09:     ;文字列出力
000752 D479 D5              11      PUSH    DE
       D47A                     _SX09:
000753 D47A 1A               7      LD  A,(DE)
000754 D47B 13               6      INC DE
000755 D47C FE24             7      CP  '$'
000757 D47E 2831            12      JR  Z,SX0E2
000759 D480 CD71D7          17      CALL    MSG_A
00075C D483 18F5            12      JR  _SX09
                                
       D485                     MSX1:
00075E D485 CD71D7          17      CALL    MSG_A
       D488                     MSX:
000761 D488 7E               7      LD  A,(HL)
000762 D489 23               6      INC HL
000763 D48A B7               4      OR  A
000764 D48B 20F8            12      JR  NZ,MSX1
000766 D48D C9              10      RET
                                
       D48E                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000767 D48E 212200          10      LD  HL,00022H
00076A D491 7D               4      LD  A,L
00076B D492 C9              10      RET
                                
       D493                     _SYS0D:     ;(BDOS)ディスクリセット
00076C D493 CDDFF0          17      CALL    _FFLUSH
00076F D496 E5              11      PUSH    HL
000770 D497 218000          10      LD  HL,00080H
000773 D49A 228AF0          16      LD  (_DTA),HL
000776 D49D E1              10      POP HL
000777 D49E D5              11      PUSH    DE
000778 D49F 1E00             7      LD  E,0
00077A D4A1 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D4A2                     _SYS0E:     ;(BDOS)カレントドライブの設定
00077B D4A2 D5              11      PUSH    DE
00077C D4A3 7B               4      LD  A,E
00077D D4A4 DDE5            15      PUSH    IX
00077F D4A6 CDDCF0          17      CALL    _GETDPB
000782 D4A9 DDE1            14      POP IX
000784 D4AB 3804            12      JR  C,SX0E2
000786 D4AD 7B               4      LD  A,E
000787 D4AE 320400          13      LD  (_DVSW),A
       D4B1                     SX0E2:
00078A D4B1 D1              10      POP DE
00078B D4B2 C9              10      RET
                                
       D4B3                     _SYS0F:     ;(BDOS)ファイルのオープン
00078C D4B3 CD85DC          17      CALL    SETDRV
00078F D4B6 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000792 D4B9 C602             7      ADD A,002H      ;Write
000794 D4BB 2848            12      JR  Z,FEND0F
000796 D4BD CDD4DF          17      CALL    CHKWILDX
                                
000799 D4C0 D4AFDC          17      CALL    NC,SOPENX
       D4C3                     _S16XX:
00079C D4C3 3840            12      JR  C,FEND0F
                                                ;Directory location
00079E D4C5 3A9FF0          13      LD  A,(_FILEN)
0007A1 D4C8 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
0007A4 D4CB 3AA0F0          13      LD  A,(_DIRF)
0007A7 D4CE FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
0007AA D4D1 FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
0007AD D4D4 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
0007B0 D4D7 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
0007B4 D4DB FDE5            15      PUSH    IY
0007B6 D4DD D1              10      POP DE
0007B7 D4DE 13               6      INC DE
0007B8 D4DF 010B00          10      LD  BC,11
0007BB D4E2 EDB0                    LDIR
                                ;               Attribute
0007BD D4E4 7E               7      LD  A,(HL)
0007BE D4E5 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
0007C1 D4E8 110B00          10      LD  DE,11       ;Reserved
0007C4 D4EB 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
0007C5 D4EC 11E4F1          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
0007C8 D4EF 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D4F1                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
0007CA D4F1 1A               7      LD  A,(DE)
0007CB D4F2 13               6      INC DE
0007CC D4F3 32FAD4          13      LD  (S16PAT),A
0007CF D4F6 7E               7      LD  A,(HL)
0007D0 D4F7 23               6      INC HL
0007D1 D4F8 FD7700          19      LD  (IY+0),A
       D4FA                     S16PAT  EQU $-1
0007D4 D4FB 10F4            13      DJNZ    S16LOOP
                                
0007D6 D4FD AF               4      XOR A
0007D7 D4FE FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
0007DA D501 FD22A2D5        20      LD  (OFCB_SWC),IY
       D505                     FEND0F:
0007DE D505 1845            12      JR  FEND10
                                
       D507                     _SYS10:     ;(BDOS)ファイルのクローズ
0007E0 D507 CD85DC          17      CALL    SETDRV
0007E3 D50A FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0007E6 D50D D6FE             7      SUB 0FEH
0007E8 D50F 37               4      SCF
0007E9 D510 3F               4      CCF
0007EA D511 2039            12      JR  NZ,FEND10
       D513                     _S10A:              ;Write
0007EC D513 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
0007EF D516 FD770F          19      LD  (IY+15),A
                                
0007F2 D519 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
0007F5 D51C CDD0E0          17      CALL    SETTMS
                                
0007F8 D51F FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
0007FB D522 32A0F0          13      LD  (_DIRF),A
0007FE D525 E67F             7      AND 07FH
000800 D527 32F5E5          13      LD  (_SECPS),A
000803 D52A FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000806 D52D FD561F          19      LD  D,(IY+31)
000809 D530 CDE3DD          17      CALL    READ_DIR
00080C D533 3817            12      JR  C,FEND10
                                
00080E D535 3A0FDD          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000811 D538 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000812 D539 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000815 D53C 6F               4      LD  L,A
000816 D53D 2600             7      LD  H,0
000818 D53F 29              11      ADD HL,HL       ;*2
000819 D540 29              11      ADD HL,HL       ;*4
00081A D541 29              11      ADD HL,HL       ;*8
00081B D542 29              11      ADD HL,HL       ;*16
00081C D543 29              11      ADD HL,HL       ;*32
00081D D544 ED4B7EF1        20      LD  BC,(_DTBUF)
000821 D548 09              11      ADD HL,BC
                                
000822 D549 CDE4DF          17      CALL    SDIRENT
       D54C                     FEND10:
000825 D54C 1842            12      JR  FEND
                                
       D54E                     _SYS11:     ;(BDOS)最初のファイルの検索
000827 D54E CD85DC          17      CALL    SETDRV
00082A D551 CDDEDC          17      CALL    SOPEN
       D554                     _S12X1:
00082D D554 383A            12      JR  C,FEND
00082F D556 CD7DDD          17      CALL    SOPENE2
000832 D559 ED5B8AF0        20      LD  DE,(_DTA)
000836 D55D 3A88F0          13      LD  A,(_DRV)
000839 D560 3C               4      INC A
00083A D561 12               7      LD  (DE),A
00083B D562 D5              11      PUSH    DE
00083C D563 13               6      INC DE
00083D D564 012000          10      LD  BC,32
000840 D567 EDB0                    LDIR
000842 D569 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000845 D56C FD660F          19      LD  H,(IY+15)
000848 D56F 22F4F1          16      LD  (SCDIR),HL
00084B D572 2A9AF0          16      LD  HL,(_FBPS)
00084E D575 22F6F1          16      LD  (SFBPS),HL
000851 D578 2A9FF0          16      LD  HL,(_FILEN)
000854 D57B 7C               4      LD  A,H
000855 D57C B7               4      OR  A
000856 D57D 2806            12      JR  Z,_S12DIR
000858 D57F 3AF5E5          13      LD  A,(_SECPS)
00085B D582 F680             7      OR  080H
00085D D584 67               4      LD  H,A
       D585                     _S12DIR:
00085E D585 22F8F1          16      LD  (SFNDF),HL  ;Directory position and Flags
000861 D588 E1              10      POP HL
000862 D589 1139F0          10      LD  DE,SFILE
000865 D58C 0E21             7      LD  C,33
       D58E                     _S11B:
000867 D58E EDB0                    LDIR
       D590                     FEND:
000869 D590 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D591                     FENDE:
00086A D591 FDE1            14      POP IY
00086C D593 C1              10      POP BC
00086D D594 D1              10      POP DE
00086E D595 E1              10      POP HL
00086F D596 C9              10      RET
                                
       D597                     _SYS12:     ;(BDOS)次のファイルの検索
000870 D597 E5              11      PUSH    HL
000871 D598 D5              11      PUSH    DE
000872 D599 C5              11      PUSH    BC
000873 D59A FDE5            15      PUSH    IY
000875 D59C CD42DD          17      CALL    NOPEN
000878 D59F 18B3            12      JR  _S12X1
                                
       D5A1                     _S16K:
00087A D5A1 110000          10      LD  DE,0
       D5A2                     OFCB_SWC    EQU $-2
00087D D5A4 D5              11      PUSH    DE
00087E D5A5 061A             7      LD  B,26        ;First cluster
       D5A7                     S16K1:
000880 D5A7 13               6      INC DE
000881 D5A8 23               6      INC HL
000882 D5A9 10FC            13      DJNZ    S16K1
                                
000884 D5AB 1A               7      LD  A,(DE)
000885 D5AC BE               7      CP  (HL)
000886 D5AD 2015            12      JR  NZ,S16K2
000888 D5AF 13               6      INC DE
000889 D5B0 23               6      INC HL
00088A D5B1 1A               7      LD  A,(DE)
00088B D5B2 BE               7      CP  (HL)
00088C D5B3 200F            12      JR  NZ,S16K2
                                
00088E D5B5 E1              10      POP HL
00088F D5B6 FDE5            15      PUSH    IY
000891 D5B8 D1              10      POP DE
000892 D5B9 7E               7      LD  A,(HL)
000893 D5BA CD9ADC          17      CALL    IS_SAME_DRV_A_DE
000896 D5BD 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
000898 D5BF ED52            15      SBC HL,DE       ;CP HL,DE
00089A D5C1 37               4      SCF
00089B D5C2 C0              11      RET NZ
00089C D5C3 E5              11      PUSH    HL
       D5C4                     S16K2:
00089D D5C4 E1              10      POP HL
       D5C5                     S16K3:
00089E D5C5 FDE5            15      PUSH    IY
0008A0 D5C7 D1              10      POP DE
       D5C8                     _SYS13:     ;(BDOS)ファイルの削除
0008A1 D5C8 CD85DC          17      CALL    SETDRV
0008A4 D5CB CD0CDF          17      CALL    KILL
       D5CE                     FEND13:
0008A7 D5CE 18C0            12      JR  FEND
                                
       D5D0                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0008A9 D5D0 CD85DC          17      CALL    SETDRV
0008AC D5D3 CD48E4          17      CALL    INIT_SEQ
       D5D6                     SREAD:
0008AF D5D6 CD1AE4          17      CALL    RB_READ
                                
0008B2 D5D9 C601             7      ADD A,001H
0008B4 D5DB 38B3            12      JR  C,FEND
                                
0008B6 D5DD 7D               4      LD  A,L
0008B7 D5DE D601             7      SUB 001H
       D5E0                     FENDX:
0008B9 D5E0 9F               4      SBC A,A
0008BA D5E1 E603             7      AND 3
0008BC D5E3 1F               4      RRA
0008BD D5E4 18AB            12      JR  FENDE
                                
       D5E6                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
0008BF D5E6 CD85DC          17      CALL    SETDRV
0008C2 D5E9 CD48E4          17      CALL    INIT_SEQ
       D5EC                     SWRITE:
0008C5 D5EC CD15E4          17      CALL    RB_WRITE
                                
0008C8 D5EF C6FF             7      ADD A,0FFH
0008CA D5F1 18ED            12      JR  FENDX
                                
       D5F3                     _SYS17:     ;(BDOS)ファイル名の変更
0008CC D5F3 CD85DC          17      CALL    SETDRV
0008CF D5F6 CD62DF          17      CALL    NAME
0008D2 D5F9 18D3            12      JR  FEND13
                                
       D5FB                     _SYS16:     ;(BDOS)ファイルの作成
0008D4 D5FB CD85DC          17      CALL    SETDRV
                                
0008D7 D5FE CDD4DF          17      CALL    CHKWILDX
0008DA D601 38CB            12      JR  C,FEND13
0008DC D603 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
0008DF D606 FE05             7      CP  5
0008E1 D608 2805            12      JR  Z,_S16X2
0008E3 D60A FE21             7      CP  021H
0008E5 D60C DACED5          10      JP  C,FEND13
       D60F                     _S16X2:
                                ;               Clear FCB
0008E8 D60F FDE5            15      PUSH    IY
0008EA D611 E1              10      POP HL
0008EB D612 011000          10      LD  BC,16
0008EE D615 09              11      ADD HL,BC
       D616                     _S16X1:
0008EF D616 70               7      LD  (HL),B      ;B=0
0008F0 D617 23               6      INC HL
0008F1 D618 0D               4      DEC C
0008F2 D619 20FB            12      JR  NZ,_S16X1
                                
0008F4 D61B CDD5E0          17      CALL    SETTMSX
0008F7 D61E FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
0008FB D622 CDAFDC          17      CALL    SOPENX
0008FE D625 3F               4      CCF
0008FF D626 CCA1D5          17      CALL    Z,_S16K
000902 D629 D48EDD          17      CALL    NC,COPEN
000905 D62C D4E4DF          17      CALL    NC,SDIRENT
000908 D62F C3C3D4          10      JP  _S16XX
                                
       D632                     _SYS21:     ;(BDOS)ランダムな読み出し
00090B D632 CD85DC          17      CALL    SETDRV
00090E D635 CD20E1          17      CALL    INIT_RND
000911 D638 189C            12      JR  SREAD
                                
       D63A                     _SYS22:     ;(BDOS)ランダムな書き込み
       D63A                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000913 D63A CD85DC          17      CALL    SETDRV
000916 D63D CD20E1          17      CALL    INIT_RND
000919 D640 18AA            12      JR  SWRITE
                                
       D642                     _SYS18:     ;(BDOS)ログインベクトルの獲得
00091B D642 21FF00          10      LD  HL,000FFH
00091E D645 AF               4      XOR A
00091F D646 C9              10      RET
                                
       D647                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000920 D647 3A0400          13      LD  A,(_DVSW)   ;from LDOS
000923 D64A A7               4      AND A
000924 D64B C9              10      RET
                                
       D64C                     _SYS1A:     ;(BDOS)DTAの設定
000925 D64C ED538AF0        20      LD  (_DTA),DE
000929 D650 AF               4      XOR A
00092A D651 C9              10      RET
                                
       D652                     _SYS1B:     ;(BDOS)ディスク情報の獲得
00092B D652 7B               4      LD  A,E
00092C D653 CD93DC          17      CALL    GETDRV
00092F D656 CDDCF0          17      CALL    _GETDPB
000932 D659 D4E2F0          17      CALL    NC,_RDFATX
000935 D65C 210000          10      LD  HL,0
000938 D65F D4AEE0          17      CALL    NC,DSKF
                                
00093B D662 ED5BAFE0        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
00093F D666 1B               6      DEC DE      ;DE←クラスタの総数
000940 D667 FD2A7CF1        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000944 D66B 9F               4      SBC A,A
000945 D66C D8              11      RET C
000946 D66D 4F               4      LD  C,A     ;C=0
000947 D66E DD7E0F          19      LD  A,(IX+DPB_BPS)
00094A D671 E607             7      AND 7
00094C D673 47               4      LD  B,A
00094D D674 DD7E07          19      LD  A,(IX+DPB_SECPCL)
000950 D677 C9              10      RET
                                
       D678                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000951 D678 AF               4      XOR A
000952 D679 67               4      LD  H,A
000953 D67A 6F               4      LD  L,A
000954 D67B C9              10      RET
                                
       D67C                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000955 D67C 2100F2          10      LD  HL,_DEVICE
000958 D67F 7B               4      LD  A,E
000959 D680 C3DCF0          10      JP  _GETDPB
                                
       D683                     _SYS23:     ;(BDOS)ファイルサイズの獲得
00095C D683 E5              11      PUSH    HL
00095D D684 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
00095F D686 CD48D4          17      CALL    BDOS0
000962 D689 381B            12      JR  C,_S23X1
                                
000964 D68B D5              11      PUSH    DE      ;EX DE,IY
000965 D68C FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000967 D68E FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
00096A D691 FD6E11          19      LD  L,(IY+17)   ;
00096D D694 FD6612          19      LD  H,(IY+18)   ;
000970 D697 C5              11      PUSH    BC      ;
000971 D698 FD4613          19      LD  B,(IY+19)   ;
000974 D69B CD12E1          17      CALL    GET_CPM_R_SIZE
000977 D69E C1              10      POP BC
       D69F                     _S24X1:
000978 D69F CD32E1          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
00097B D6A2 FDE3            23      EX  (SP),IY     ;
00097D D6A4 D1              10      POP DE      ;
                                
00097E D6A5 AF               4      XOR A
       D6A6                     _S23X1:
00097F D6A6 E1              10      POP HL
000980 D6A7 C9              10      RET
                                
       D6A8                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000981 D6A8 E5              11      PUSH    HL
000982 D6A9 D5              11      PUSH    DE      ;EX DE,IY
000983 D6AA FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000985 D6AC CD50E4          17      CALL    GETSEQ
000988 D6AF 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D6B1                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
00098A D6B1 2B               6      DEC HL
       D6B2                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
00098B D6B2 C5              11      PUSH    BC
00098C D6B3 E5              11      PUSH    HL
00098D D6B4 CD9DDB          17      CALL    FILE
000990 D6B7 E1              10      POP HL
000991 D6B8 C1              10      POP BC
       D6B9                     S29X1:
000992 D6B9 C5              11      PUSH    BC
000993 D6BA D5              11      PUSH    DE
000994 D6BB E5              11      PUSH    HL
000995 D6BC EB               4      EX  DE,HL
000996 D6BD AF               4      XOR A
000997 D6BE 3221F0          13      LD  (FDRV+13),A
00099A D6C1 2114F0          10      LD  HL,FDRV
00099D D6C4 011000          10      LD  BC,16
0009A0 D6C7 EDB0                    LDIR
0009A2 D6C9 E1              10      POP HL
0009A3 D6CA D1              10      POP DE
0009A4 D6CB C1              10      POP BC
0009A5 D6CC C9              10      RET
                                
       D6CD                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
0009A6 D6CD C5              11      PUSH    BC
0009A7 D6CE 0196E7          10      LD  BC,DWT24B
0009AA D6D1 1804            12      JR  S2FX
       D6D3                     _SYS2F:
0009AC D6D3 C5              11      PUSH    BC
0009AD D6D4 0188E7          10      LD  BC,DRD24B
       D6D7                     S2FX:
0009B0 D6D7 ED43EDD6        20      LD  (S2F_SWC),BC
0009B4 D6DB CDDFF0          17      CALL    _FFLUSH
                                
0009B7 D6DE D5              11      PUSH    DE
0009B8 D6DF E5              11      PUSH    HL
0009B9 D6E0 7D               4      LD  A,L     ;Drive
0009BA D6E1 CDD9F0          17      CALL    _CHGDRV
0009BD D6E4 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
0009BF D6E6 44               4      LD  B,H     ;Number of clusters
0009C0 D6E7 2A8AF0          16      LD  HL,(_DTA)
                                
0009C3 D6EA 0E00             7      LD  C,0
0009C5 D6EC CD88E7          17      CALL    DRD24B
       D6ED                     S2F_SWC EQU $-2
       D6EF                     POP_HL_DE_BC_SBCAA_RET:
0009C8 D6EF E1              10      POP HL
0009C9 D6F0 D1              10      POP DE
0009CA D6F1 C1              10      POP BC
0009CB D6F2 9F               4      SBC A,A
0009CC D6F3 C9              10      RET
                                
       D6F4                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
0009CD D6F4 C5              11      PUSH    BC
0009CE D6F5 D5              11      PUSH    DE
0009CF D6F6 E5              11      PUSH    HL
0009D0 D6F7 CD92DB          17      CALL    FILEC
0009D3 D6FA 21EFD6          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
0009D6 D6FD E5              11      PUSH    HL
0009D7 D6FE 3A21F0          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
0009DA D701 E610             7      AND 010H        ;ディレクトリ
0009DC D703 37               4      SCF
0009DD D704 C8              11      RET Z
0009DE D705 1114F0          10      LD  DE,FDRV
0009E1 D708 2A4EF1          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       D70B                     JPHL:
0009E4 D70B E9               4      JP  (HL)
                                
       D70C                     SHOW_ERROR:         ;(9)
0009E5 D70C 1179F0          10      LD  DE,COMERM
0009E8 D70F CD79D4          17      CALL    _SYS09      ;(BDOS)文字列出力
0009EB D712 C300F0          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "M7IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                
       D477                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D477                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D477                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D477                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D477                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D477                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       D715                     ARWKEY:
0009EE D715 3D               4      DEC A
0009EF D716 3231D7          13      LD  (KEYAR),A
0009F2 D719 1826            12      JR  INT8253E
       D71B                     SETKEY1:
0009F4 D71B 3A95F0          13      LD  A,(_KEYSP+1)
0009F7 D71E 1815            12      JR  SETKEY
       D720                     INT8253:
0009F9 D720 CD13DB          17      CALL    CHKEY
0009FC D723 FE00             7      CP  0
       D724                     KEYDT   EQU $-1
0009FE D725 20F4            12      JR  NZ,SETKEY1
000A00 D727 E5              11      PUSH    HL
000A01 D728 2A90F0          16      LD  HL,(_KEYPS)
000A04 D72B 7C               4      LD  A,H
000A05 D72C AD               4      XOR L
000A06 D72D E1              10      POP HL
000A07 D72E 2011            12      JR  NZ,INT8253E
000A09 D730 3E00             7      LD  A,0
       D731                     KEYAR   EQU $-1
000A0B D732 B7               4      OR  A
000A0C D733 20E0            12      JR  NZ,ARWKEY
       D735                     SETKEY:
000A0E D735 3231D7          13      LD  (KEYAR),A
000A11 D738 3A92F0          13      LD  A,(_KEYD)
000A14 D73B 3224D7          13      LD  (KEYDT),A
000A17 D73E CD44D7          17      CALL    KEYSET
       D741                     INT8253E:
000A1A D741 F1              10      POP AF
000A1B D742 FB               4      EI
000A1C D743 C9              10      RET
       D744                     KEYSET:
       D744                     KEYBS:
000A1D D744 B7               4      OR  A
000A1E D745 C8              11      RET Z
       D746                     KEYBS1:
000A1F D746 CD5ED7          17      CALL    KEYBC_IFBREAK
000A22 D749 E5              11      PUSH    HL
000A23 D74A F5              11      PUSH    AF
000A24 D74B 2A90F0          16      LD  HL,(_KEYPS)
000A27 D74E 2C               4      INC L
000A28 D74F CBAD             8      RES 5,L
000A2A D751 7D               4      LD  A,L
000A2B D752 BC               4      CP  H
000A2C D753 2815            12      JR  Z,POP_AF_HL_SCF_RET
000A2E D755 3290F0          13      LD  (_KEYPS),A
000A31 D758 26F3             7      LD  H,HIGH KEYBF
000A33 D75A F1              10      POP AF
000A34 D75B 77               7      LD  (HL),A
000A35 D75C E1              10      POP HL
000A36 D75D C9              10      RET
       D75E                     KEYBC_IFBREAK:
000A37 D75E FE03             7      CP  3
000A39 D760 C0              11      RET NZ
       D761                     KEYBC:
000A3A D761 E5              11      PUSH    HL
000A3B D762 210000          10      LD  HL,0
000A3E D765 2290F0          16      LD  (_KEYPS),HL
000A41 D768 E1              10      POP HL
000A42 D769 C9              10      RET
                                
       D76A                     POP_AF_HL_SCF_RET:
000A43 D76A F1              10      POP AF
000A44 D76B E1              10      POP HL
000A45 D76C 37               4      SCF
000A46 D76D C9              10      RET
                                
       D76E                     _SYS01:     ;(BDOS)コンソール入力
000A47 D76E CD09F0          17      CALL    _SYS07
       D771                     MSG_A:
000A4A D771 F5              11      PUSH    AF
000A4B D772 D5              11      PUSH    DE
000A4C D773 5F               4      LD  E,A
000A4D D774 CD7AD7          17      CALL    _SYS02
000A50 D777 D1              10      POP DE
000A51 D778 F1              10      POP AF
000A52 D779 C9              10      RET
                                
       D77A                     _SYS02:     ;(BDOS)コンソール出力
000A53 D77A CD8CD7          17      CALL    BREAK
000A56 D77D 1805            12      JR  PRINTX
                                
       D77F                     _SYS06:     ;(BDOS)コンソール直接入出力
000A58 D77F 7B               4      LD  A,E
000A59 D780 3C               4      INC A
000A5A D781 CACAF0          10      JP  Z,_INKEY
       D784                     PRINTX:
000A5D D784 C3CDF0          10      JP  _PRINT
                                
       D787                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000A60 D787 CD09F0          17      CALL    _SYS07
000A63 D78A 1804            12      JR  BREAK1
       D78C                     BREAK:
000A65 D78C FB               4      EI
000A66 D78D 3A92F0          13      LD  A,(_KEYD)
       D790                     BREAK1:
000A69 D790 FE03             7      CP  3       ;CTRL+C
000A6B D792 CCF4F0          17      CALL    Z,_BREAK
000A6E D795 FE13             7      CP  013H        ;CTRL+S
000A70 D797 C0              11      RET NZ
                                
       D798                     PAUSE:
000A71 D798 CD61D7          17      CALL    KEYBC
                                
       D79B                     FLGET:
000A74 D79B CDDFF0          17      CALL    _FFLUSH
000A77 D79E E5              11      PUSH    HL
000A78 D79F 2A8EF0          16      LD  HL,(_TXADR)
000A7B D7A2 7C               4      LD  A,H
000A7C D7A3 C6D0             7      ADD A,0D0H
000A7E D7A5 67               4      LD  H,A
000A7F D7A6 CD37CF          17      CALL    RDMMIO
000A82 D7A9 32BED7          13      LD  (FLSMC),A
       D7AC                     FLGET1:
000A85 D7AC CD2DCF          17      CALL    RD556VSYNC
000A88 D7AF CB77             8      BIT 6,A
000A8A D7B1 3EEF             7      LD  A,0EFH      ;カーソル
000A8C D7B3 280A            12      JR  Z,FLGET2
000A8E D7B5 3A92F0          13      LD  A,(_KEYD)
000A91 D7B8 B7               4      OR  A
000A92 D7B9 3EEF             7      LD  A,0EFH      ;カーソル
000A94 D7BB 2002            12      JR  NZ,FLGET2
000A96 D7BD 3E00             7      LD  A,0     ;自己書き換え
       D7BE                     FLSMC   EQU $-1
       D7BF                     FLGET2:
000A98 D7BF CD3FCF          17      CALL    WRMMIO
000A9B D7C2 CDCAF0          17      CALL    _INKEY
000A9E D7C5 28E5            12      JR  Z,FLGET1
000AA0 D7C7 F5              11      PUSH    AF
000AA1 D7C8 3ABED7          13      LD  A,(FLSMC)
000AA4 D7CB CD3FCF          17      CALL    WRMMIO
000AA7 D7CE F1              10      POP AF
000AA8 D7CF E1              10      POP HL
000AA9 D7D0 C9              10      RET
                                
       D7D1                     _SYS0A:     ;(BDOS)文字列入力
000AAA D7D1 C5              11      PUSH    BC
000AAB D7D2 E5              11      PUSH    HL
000AAC D7D3 D5              11      PUSH    DE
000AAD D7D4 CD71DA          17      CALL    GETL
000AB0 D7D7 1130FF          10      LD  DE,KBUF
000AB3 D7DA E1              10      POP HL
000AB4 D7DB E5              11      PUSH    HL
000AB5 D7DC 0E00             7      LD  C,0
000AB7 D7DE 3004            12      JR  NC,SAX0
000AB9 D7E0 23               6      INC HL
000ABA D7E1 23               6      INC HL
000ABB D7E2 1808            12      JR  SAX4
       D7E4                     SAX0:
000ABD D7E4 46               7      LD  B,(HL)
000ABE D7E5 23               6      INC HL
       D7E6                     SAX1:
000ABF D7E6 23               6      INC HL
000AC0 D7E7 1A               7      LD  A,(DE)
000AC1 D7E8 13               6      INC DE
000AC2 D7E9 B7               4      OR  A
000AC3 D7EA 2004            12      JR  NZ,SAX2
       D7EC                     SAX4:
000AC5 D7EC 360D            10      LD  (HL),00DH
000AC7 D7EE 1804            12      JR  SAX3
       D7F0                     SAX2:
000AC9 D7F0 77               7      LD  (HL),A
000ACA D7F1 0C               4      INC C
000ACB D7F2 10F2            13      DJNZ    SAX1
       D7F4                     SAX3:
000ACD D7F4 D1              10      POP DE
000ACE D7F5 79               4      LD  A,C
000ACF D7F6 13               6      INC DE
000AD0 D7F7 12               7      LD  (DE),A
000AD1 D7F8 1B               6      DEC DE
000AD2 D7F9 E1              10      POP HL
000AD3 D7FA C1              10      POP BC
000AD4 D7FB A7               4      AND A
000AD5 D7FC C9              10      RET
                                
       D7FD                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000AD6 D7FD CD8CD7          17      CALL    BREAK
000AD9 D800 3A92F0          13      LD  A,(_KEYD)
000ADC D803 B7               4      OR  A
000ADD D804 C8              11      RET Z
       D805                     CONSTX:
000ADE D805 CDDFF0          17      CALL    _FFLUSH
000AE1 D808 E5              11      PUSH    HL
000AE2 D809 2A90F0          16      LD  HL,(_KEYPS)
000AE5 D80C 7C               4      LD  A,H
000AE6 D80D AD               4      XOR L
000AE7 D80E E1              10      POP HL
000AE8 D80F C6FF             7      ADD A,0FFH
000AEA D811 9F               4      SBC A,A
000AEB D812 C9              10      RET
                                
       D813                     _SYS2A:     ;(BDOS)日付の獲得
       D813                     _SYS2C:     ;(BDOS)時刻の獲得
000AEC D813 AF               4      XOR A
000AED D814 57               4      LD  D,A
000AEE D815 5F               4      LD  E,A
000AEF D816 67               4      LD  H,A
000AF0 D817 6F               4      LD  L,A
000AF1 D818 C9              10      RET
                                
       D819                     ESC1:
000AF2 D819 7B               4      LD  A,E
000AF3 D81A FE41             7      CP  'A'
000AF5 D81C CA11D9          10      JP  Z,CTRL1E
000AF8 D81F FE42             7      CP  'B'
000AFA D821 CA34DA          10      JP  Z,CTRL1F
000AFD D824 FE43             7      CP  'C'
000AFF D826 CAE4D8          10      JP  Z,CTRL1C
000B02 D829 FE44             7      CP  'D'
000B04 D82B CA08D9          10      JP  Z,CTRL1D
000B07 D82E FE45             7      CP  'E'
000B09 D830 2802            12      JR  Z,CT0CX
000B0B D832 FE6A             7      CP  'j'
       D834                     CT0CX:
000B0D D834 CA19DA          10      JP  Z,CTRL0C
000B10 D837 FE48             7      CP  'H'
000B12 D839 CA8AD9          10      JP  Z,CTRL0B
000B15 D83C FE4A             7      CP  'J'
000B17 D83E CA1CDA          10      JP  Z,CTRL06
000B1A D841 FE4B             7      CP  'K'
000B1C D843 CA5CD9          10      JP  Z,CTRL05
000B1F D846 FE4C             7      CP  'L'
000B21 D848 CA46DA          10      JP  Z,CTRL0E
000B24 D84B FE54             7      CP  'T'
000B26 D84D CA5CD9          10      JP  Z,CTRL05
000B29 D850 FE78             7      CP  'x'
000B2B D852 2804            12      JR  Z,ESC1X
000B2D D854 FE79             7      CP  'y'
000B2F D856 2002            12      JR  NZ,ESC1Y
       D858                     ESC1X:
000B31 D858 3601            10      LD  (HL),1
       D85A                     ESC1Y:
000B33 D85A FE3D             7      CP  '='
000B35 D85C 2804            12      JR  Z,ESC1W
000B37 D85E FE59             7      CP  'Y'
000B39 D860 2002            12      JR  NZ,ESC1Z
       D862                     ESC1W:
000B3B D862 3602            10      LD  (HL),2
       D864                     ESC1Z:
000B3D D864 FE20             7      CP  020H
000B3F D866 3802            12      JR  C,ESC1C
000B41 D868 87               4      ADD A,A
000B42 D869 D0              11      RET NC
       D86A                     ESC1C:
000B43 D86A E1              10      POP HL
000B44 D86B 1832            12      JR  ANK
                                
       D86D                     ESC:
000B46 D86D 21D0D8          10      LD  HL,PRINTE5
000B49 D870 E5              11      PUSH    HL
000B4A D871 2193D8          10      LD  HL,ESCFLG
000B4D D874 3600            10      LD  (HL),0
000B4F D876 3D               4      DEC A
000B50 D877 28A0            12      JR  Z,ESC1
000B52 D879 3D               4      DEC A
000B53 D87A 2009            12      JR  NZ,ESC2
000B55 D87C 3603            10      LD  (HL),3
000B57 D87E 7B               4      LD  A,E
000B58 D87F D620             7      SUB 020H
000B5A D881 3288D8          13      LD  (ESCYP+1),A
000B5D D884 C9              10      RET
       D885                     ESC2:
000B5E D885 3D               4      DEC A
000B5F D886 C0              11      RET NZ
000B60 D887 2600             7  ESCYP:  LD  H,0
000B62 D889 7B               4      LD  A,E
000B63 D88A D620             7      SUB 020H
000B65 D88C 6F               4      LD  L,A
000B66 D88D C3D6F0          10      JP  _LOC
                                
       D890                     PRINT:
000B69 D890 C5              11      PUSH    BC
000B6A D891 E5              11      PUSH    HL
000B6B D892 3E00             7      LD  A,000H      ;自己書き換え
       D893                     ESCFLG  EQU $-1
000B6D D894 B7               4      OR  A
000B6E D895 20D6            12      JR  NZ,ESC
                                
000B70 D897 3E1F             7      LD  A,01FH
000B72 D899 BB               4      CP  E
000B73 D89A 3038            12      JR  NC,CTRL
       D89C                     INSFLG  EQU $
000B75 D89C 01E2D9          10      LD  BC,INSERT   ;自己書き換え
       D89F                     ANK:
000B78 D89F 3A96F0          13      LD  A,(_COLORF)
000B7B D8A2 4F               4      LD  C,A
000B7C D8A3 7B               4      LD  A,E
000B7D D8A4 FE61             7      CP  'a'     ;英小文字
000B7F D8A6 3806            12      JR  C,PRT1
000B81 D8A8 FE7B             7      CP  'z'+1
000B83 D8AA 3002            12      JR  NC,PRT1
000B85 D8AC CBF9             8      SET 7,C
       D8AE                     PRT1:
000B87 D8AE FE86             7      CP  $86     ;ひらがな1(を－そ)
000B89 D8B0 3806            12      JR  C,PRT2
000B8B D8B2 FEA0             7      CP  $A0
000B8D D8B4 3002            12      JR  NC,PRT2
000B8F D8B6 CBF9             8      SET 7,C
       D8B8                     PRT2:
000B91 D8B8 FEE0             7      CP  $E0     ;ひらがな2(たーん)
000B93 D8BA 3802            12      JR  C,PRT3
000B95 D8BC CBF9             8      SET 7,C
       D8BE                     PRT3:
000B97 D8BE 2A8EF0          16      LD  HL,(_TXADR)
000B9A D8C1 7C               4      LD  A,H
000B9B D8C2 C6D0             7      ADD A,0D0H
000B9D D8C4 67               4      LD  H,A
000B9E D8C5 42               4      LD  B,D
000B9F D8C6 16EE             7      LD  D,HIGH CD_TABLE
000BA1 D8C8 1A               7      LD  A,(DE)
000BA2 D8C9 50               4      LD  D,B
000BA3 D8CA CD57CF          17      CALL    IO_PRINT
000BA6 D8CD CDE4D8          17      CALL    CTRL1C
       D8D0                     PRINTE5:
000BA9 D8D0 E1              10      POP HL
000BAA D8D1 C1              10      POP BC
000BAB D8D2 AF               4      XOR A
000BAC D8D3 C9              10      RET
                                
       D8D4                     CTRL:
000BAD D8D4 7B               4      LD  A,E
000BAE D8D5 87               4      ADD A,A
000BAF D8D6 F680             7      OR  080H
000BB1 D8D8 6F               4      LD  L,A
000BB2 D8D9 26F1             7      LD  H,HIGH CTRLTB
000BB4 D8DB 7E               7      LD  A,(HL)
000BB5 D8DC 2C               4      INC L
000BB6 D8DD 66               7      LD  H,(HL)
000BB7 D8DE 6F               4      LD  L,A
000BB8 D8DF CD0BD7          17      CALL    JPHL
000BBB D8E2 18EC            12      JR  PRINTE5
                                
       D8E4                     CTRL1C:
000BBD D8E4 ED4B8EF0        20      LD  BC,(_TXADR)
000BC1 D8E8 03               6      INC BC
       D8E9                     PRINTE3:
000BC2 D8E9 2118FC          10      LD  HL,0-WIDTH*LINE
000BC5 D8EC A7               4      AND A
000BC6 D8ED ED4A            15      ADC HL,BC
       D8EF                     PRINTE8:
000BC8 D8EF 2805            12      JR  Z,PRINT2
000BCA D8F1 ED438EF0        20      LD  (_TXADR),BC
       D8F5                     CTRL00:
000BCE D8F5 C9              10      RET
                                
       D8F6                     PRINT2:
000BCF D8F6 CD4CDA          17      CALL    SCR
000BD2 D8F9 21D8FF          10      LD  HL,0-WIDTH
000BD5 D8FC 09              11      ADD HL,BC
       D8FD                     SET_TXADR_HL:
000BD6 D8FD 228EF0          16      LD  (_TXADR),HL
000BD9 D900 C9              10      RET
                                
       D901                     CTRL08:
000BDA D901 3A9CD8          13      LD  A,(INSFLG)
000BDD D904 FECD             7      CP  0CDH        ;CALL ????
000BDF D906 2823            12      JR  Z,CTRL02
       D908                     CTRL1D:
000BE1 D908 2A8EF0          16      LD  HL,(_TXADR)
000BE4 D90B 7C               4      LD  A,H
000BE5 D90C B5               4      OR  L
000BE6 D90D C8              11      RET Z
000BE7 D90E 2B               6      DEC HL
000BE8 D90F 18EC            12      JR  SET_TXADR_HL
                                
       D911                     CTRL1E:
000BEA D911 ED4B8EF0        20      LD  BC,(_TXADR)
000BEE D915 21D8FF          10      LD  HL,0-WIDTH
000BF1 D918 09              11      ADD HL,BC
000BF2 D919 D0              11      RET NC
000BF3 D91A 18E1            12      JR  SET_TXADR_HL
                                
       D91C                     CTRL09:
000BF5 D91C ED4B8EF0        20      LD  BC,(_TXADR)
000BF9 D920 79               4      LD  A,C
000BFA D921 E6F8             7      AND 0F8H
000BFC D923 C608             7      ADD A,8
000BFE D925 4F               4      LD  C,A
000BFF D926 88               4      ADC A,B
000C00 D927 91               4      SUB C
000C01 D928 47               4      LD  B,A
000C02 D929 18BE            12      JR  PRINTE3
                                
       D92B                     CTRL02:
000C04 D92B CD08D9          17      CALL    CTRL1D
000C07 D92E C8              11      RET Z
000C08 D92F D5              11      PUSH    DE
000C09 D930 CDD3F0          17      CALL    _POS
000C0C D933 54               4      LD  D,H
000C0D D934 3E28             7      LD  A,WIDTH
000C0F D936 95               4      SUB L
000C10 D937 4F               4      LD  C,A
000C11 D938 0D               4      DEC C
000C12 D939 06D0             7      LD  B,0D0H
000C14 D93B 2A8EF0          16      LD  HL,(_TXADR)
000C17 D93E 09              11      ADD HL,BC
000C18 D93F 47               4      LD  B,A
                                
000C19 D940 3A03DA          13      LD  A,(MULINE)
000C1C D943 BA               4      CP  D
000C1D D944 2007            12      JR  NZ,C02X1
000C1F D946 112800          10      LD  DE,WIDTH
000C22 D949 19              11      ADD HL,DE
000C23 D94A 78               4      LD  A,B
000C24 D94B 83               4      ADD A,E
000C25 D94C 47               4      LD  B,A
       D94D                     C02X1:
000C26 D94D 3A96F0          13      LD  A,(_COLORF) ;C:Color
000C29 D950 4F               4      LD  C,A
000C2A D951 3E                      DB  03EH        ;LD A,?
000C2B D952 2B               6      DEC HL
000C2C D953 329ECF          13      LD  (IO_INCDEC),A
000C2F D956 AF               4      XOR A       ;A:Text
000C30 D957 CD91CF          17      CALL    IO_INSBS
000C33 D95A D1              10      POP DE
000C34 D95B C9              10      RET
                                
       D95C                     CTRL05:
000C35 D95C CDD3F0          17      CALL    _POS
000C38 D95F 3E28             7      LD  A,WIDTH
000C3A D961 95               4      SUB L
000C3B D962 47               4      LD  B,A
       D963                     C08X1:
000C3C D963 2A8EF0          16      LD  HL,(_TXADR)
000C3F D966 7C               4      LD  A,H
000C40 D967 C6D0             7      ADD A,0D0H
000C42 D969 67               4      LD  H,A
       D96A                     CLLINE:
000C43 D96A 3A96F0          13      LD  A,(_COLORF)
000C46 D96D 4F               4      LD  C,A
000C47 D96E AF               4      XOR A
000C48 D96F C381CF          10      JP  IO_CLLINE
                                
       D972                     CTRL0D:
000C4B D972 CDD3F0          17      CALL    _POS
000C4E D975 2E00             7      LD  L,0
       D977                     LOC:
000C50 D977 C5              11      PUSH    BC
000C51 D978 E5              11      PUSH    HL
000C52 D979 CD97D9          17      CALL    LOC1
000C55 D97C 228EF0          16      LD  (_TXADR),HL
000C58 D97F E1              10      POP HL
000C59 D980 C1              10      POP BC
000C5A D981 C9              10      RET
                                
       D982                     CTRL12:
000C5B D982 219CD8          10      LD  HL,INSFLG
000C5E D985 7E               7      LD  A,(HL)
000C5F D986 EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000C61 D988 77               7      LD  (HL),A
000C62 D989 C9              10      RET
                                
       D98A                     CTRL0B:
000C63 D98A 210000          10      LD  HL,0
000C66 D98D 228EF0          16      LD  (_TXADR),HL
000C69 D990 C9              10      RET
                                
       D991                     CTRL1B:
000C6A D991 3E01             7      LD  A,1
000C6C D993 3293D8          13      LD  (ESCFLG),A
000C6F D996 C9              10      RET
                                
       D997                     LOC1:
000C70 D997 D5              11      PUSH    DE
000C71 D998 4D               4      LD  C,L
000C72 D999 0608             7      LD  B,8
000C74 D99B 5C               4      LD  E,H
000C75 D99C 210028          10      LD  HL,WIDTH*256
000C78 D99F 55               4      LD  D,L ;L=0
       D9A0                     LOC2:
000C79 D9A0 29              11      ADD HL,HL
000C7A D9A1 3001            12      JR  NC,LOC3
000C7C D9A3 19              11      ADD HL,DE
       D9A4                     LOC3:
000C7D D9A4 10FA            13      DJNZ    LOC2
000C7F D9A6 09              11      ADD HL,BC
000C80 D9A7 D1              10      POP DE
000C81 D9A8 C9              10      RET
                                
       D9A9                     CONOUT1:
                                ;   CALL    CURSOR
000C82 D9A9 59               4      LD  E,C
000C83 D9AA CDCDF0          17      CALL    _PRINT
000C86 D9AD 7B               4      LD  A,E
000C87 D9AE FE0A             7      CP  00AH
000C89 D9B0 2006            12      JR  NZ,CURSOR
000C8B D9B2 CD72D9          17      CALL    CTRL0D
000C8E D9B5 CD5CD9          17      CALL    CTRL05
       D9B8                     CURSOR:
000C91 D9B8 C9              10      RET
                                
       D9B9                     CTRL07:
000C92 D9B9 06E0             7      LD  B,0E0H
000C94 D9BB 2162F0          10      LD  HL,BEEPD+1
       D9BE                     C07X0:
000C97 D9BE 4E               7      LD  C,(HL)
000C98 D9BF 23               6      INC HL
000C99 D9C0 7E               7      LD  A,(HL)
000C9A D9C1 23               6      INC HL
000C9B D9C2 CD4FCF          17      CALL    WRMMIO_BC
000C9E D9C5 7D               4      LD  A,L
000C9F D9C6 FE6A             7      CP  (BEEPD+1+M7BEEPE-M7BEEPD)&255
000CA1 D9C8 20F4            12      JR  NZ,C07X0
000CA3 D9CA 0610             7      LD  B,16
       D9CC                     C07X1:
000CA5 D9CC CD2DCF          17      CALL    RD556VSYNC
000CA8 D9CF 87               4      ADD A,A
000CA9 D9D0 30FA            12      JR  NC,C07X1
       D9D2                     C07X2:
000CAB D9D2 CD2DCF          17      CALL    RD556VSYNC
000CAE D9D5 87               4      ADD A,A
000CAF D9D6 38FA            12      JR  C,C07X2
000CB1 D9D8 10F2            13      DJNZ    C07X1
                                
000CB3 D9DA AF               4      XOR A
000CB4 D9DB 2108E0          10      LD  HL,0E008H
000CB7 D9DE CD3FCF          17      CALL    WRMMIO
000CBA D9E1 C9              10      RET
                                
       D9E2                     INSERT:
000CBB D9E2 D5              11      PUSH    DE
000CBC D9E3 CDD3F0          17      CALL    _POS
000CBF D9E6 54               4      LD  D,H
000CC0 D9E7 3E28             7      LD  A,WIDTH
000CC2 D9E9 95               4      SUB L
000CC3 D9EA 47               4      LD  B,A
000CC4 D9EB 2A8EF0          16      LD  HL,(_TXADR)
000CC7 D9EE 7C               4      LD  A,H
000CC8 D9EF C6D0             7      ADD A,0D0H
000CCA D9F1 67               4      LD  H,A
000CCB D9F2 3A96F0          13      LD  A,(_COLORF) ;C:Color
000CCE D9F5 4F               4      LD  C,A
000CCF D9F6 3E                      DB  03EH        ;LD A,?
000CD0 D9F7 23               6      INC HL
000CD1 D9F8 329ECF          13      LD  (IO_INCDEC),A
000CD4 D9FB AF               4      XOR A       ;A:Text
000CD5 D9FC CD91CF          17      CALL    IO_INSBS
000CD8 D9FF B7               4      OR  A
000CD9 DA00 2005            12      JR  NZ,INS1
       DA03                     MULINE  EQU $+1
000CDB DA02 3EFF             7      LD  A,-1
000CDD DA04 92               4      SUB D
000CDE DA05 2010            12      JR  NZ,INS2
       DA07                     INS1:
000CE0 DA07 0628             7      LD  B,WIDTH
000CE2 DA09 F5              11      PUSH    AF
000CE3 DA0A 3E                      DB  03EH        ;LD A,?
000CE4 DA0B 23               6      INC HL
000CE5 DA0C 329ECF          13      LD  (IO_INCDEC),A
000CE8 DA0F F1              10      POP AF
000CE9 DA10 CD91CF          17      CALL    IO_INSBS
000CEC DA13 7A               4      LD  A,D
000CED DA14 3203DA          13      LD  (MULINE),A
       DA17                     INS2:
000CF0 DA17 D1              10      POP DE
000CF1 DA18 C9              10      RET
                                
       DA19                     CTRL0C:
000CF2 DA19 CD8AD9          17      CALL    CTRL0B
       DA1C                     CTRL06:
000CF5 DA1C D5              11      PUSH    DE
000CF6 DA1D E5              11      PUSH    HL
000CF7 DA1E ED5B8EF0        20      LD  DE,(_TXADR)
000CFB DA22 3A96F0          13      LD  A,(_COLORF)
000CFE DA25 326ECF          13      LD  (ICSMC),A
000D01 DA28 C362CF          10      JP  IO_CLR
                                
       DA2B                     CTRL04:
000D04 DA2B CDD3F0          17      CALL    _POS
000D07 DA2E 7D               4      LD  A,L
000D08 DA2F B7               4      OR  A
000D09 DA30 C8              11      RET Z
       DA31                     CTRL03:
000D0A DA31 CD72D9          17      CALL    CTRL0D
       DA34                     CTRL0A:
       DA34                     CTRL1F:
000D0D DA34 2A8EF0          16      LD  HL,(_TXADR)
000D10 DA37 012800          10      LD  BC,WIDTH
000D13 DA3A 09              11      ADD HL,BC
000D14 DA3B 44               4      LD  B,H
000D15 DA3C 4D               4      LD  C,L
000D16 DA3D 2118FC          10      LD  HL,0-WIDTH*LINE
000D19 DA40 09              11      ADD HL,BC
000D1A DA41 3F               4      CCF
000D1B DA42 9F               4      SBC A,A
000D1C DA43 C3EFD8          10      JP  PRINTE8
                                
       DA46                     CTRL0E:
000D1F DA46 CDD3F0          17      CALL    _POS
000D22 DA49 7C               4      LD  A,H
000D23 DA4A 1804            12      JR  SCR1
       DA4C                     SCR:
000D25 DA4C 3A97F0          13      LD  A,(_LINE)
000D28 DA4F 3D               4      DEC A
       DA50                     SCR1:
000D29 DA50 C5              11      PUSH    BC
000D2A DA51 D5              11      PUSH    DE
000D2B DA52 E5              11      PUSH    HL
000D2C DA53 1100D0          10      LD  DE,0D000H
000D2F DA56 2128D0          10      LD  HL,0D000H+WIDTH
                                
000D32 DA59 47               4      LD  B,A
000D33 DA5A B7               4      OR  A
000D34 DA5B C3A5CF          10      JP  IO_SCRUP
                                
       DA5E                     POS:
000D37 DA5E 2A8EF0          16      LD  HL,(_TXADR)
000D3A DA61 C5              11      PUSH    BC
000D3B DA62 01D8FF          10      LD  BC,0-WIDTH
000D3E DA65 AF               4      XOR A
       DA66                     POS1:
000D3F DA66 09              11      ADD HL,BC
000D40 DA67 3C               4      INC A
000D41 DA68 38FC            12      JR  C,POS1
000D43 DA6A ED42            15      SBC HL,BC
000D45 DA6C 3D               4      DEC A
000D46 DA6D 67               4      LD  H,A
000D47 DA6E C1              10      POP BC
000D48 DA6F A7               4      AND A
000D49 DA70 C9              10      RET
                                
       DA71                     GETL:
000D4A DA71 CDD3F0          17      CALL    _POS
000D4D DA74 E5              11      PUSH    HL
000D4E DA75 3ECD             7      LD  A,0CDH      ;CALL ????
000D50 DA77 329CD8          13      LD  (INSFLG),A
       DA7A                     GETL1:
000D53 DA7A CD87D7          17      CALL    _SYS08
000D56 DA7D FE09             7      CP  9
000D58 DA7F 2008            12      JR  NZ,GETL1V
000D5A DA81 2130FF          10      LD  HL,KBUF
000D5D DA84 CD88D4          17      CALL    MSX
000D60 DA87 18F1            12      JR  GETL1
       DA89                     GETL1V:
000D62 DA89 5F               4      LD  E,A
000D63 DA8A CDD3F0          17      CALL    _POS
000D66 DA8D CDCDF0          17      CALL    _PRINT
000D69 DA90 7B               4      LD  A,E
000D6A DA91 FE20             7      CP  $20
000D6C DA93 3809            12      JR  C,GETL1V1
000D6E DA95 7D               4      LD  A,L
000D6F DA96 FE27             7      CP  WIDTH-1
000D71 DA98 2004            12      JR  NZ,GETL1V1
000D73 DA9A 7C               4      LD  A,H
000D74 DA9B 3203DA          13      LD  (MULINE),A
       DA9E                     GETL1V1:
000D77 DA9E 7B               4      LD  A,E
000D78 DA9F FE0D             7      CP  00DH
000D7A DAA1 20D7            12      JR  NZ,GETL1
000D7C DAA3 3E01             7      LD  A,1     ;LD BC,????
000D7E DAA5 329CD8          13      LD  (INSFLG),A
000D81 DAA8 1130FF          10      LD  DE,KBUF
000D84 DAAB 0628             7      LD  B,WIDTH
000D86 DAAD CD26D3          17      CALL    ZERO_MEMORY_DE
                                
000D89 DAB0 D1              10      POP DE
000D8A DAB1 CDD3F0          17      CALL    _POS
000D8D DAB4 6B               4      LD  L,E
000D8E DAB5 3E28             7      LD  A,WIDTH
000D90 DAB7 95               4      SUB L
000D91 DAB8 57               4      LD  D,A
                                
000D92 DAB9 3A03DA          13      LD  A,(MULINE)
000D95 DABC 94               4      SUB H
000D96 DABD 2806            12      JR  Z,GL2X
000D98 DABF 3C               4      INC A
000D99 DAC0 200C            12      JR  NZ,GL3X
000D9B DAC2 25               4      DEC H
000D9C DAC3 1805            12      JR  GL4X
       DAC5                     GL2X:
000D9E DAC5 3E1F             7      LD  A,$1F
000DA0 DAC7 CD71D7          17      CALL    MSG_A
       DACA                     GL4X:
000DA3 DACA 7A               4      LD  A,D
000DA4 DACB C628             7      ADD A,WIDTH
000DA6 DACD 57               4      LD  D,A
       DACE                     GL3X:
000DA7 DACE CD97D9          17      CALL    LOC1
000DAA DAD1 4D               4      LD  C,L
000DAB DAD2 7C               4      LD  A,H
000DAC DAD3 C6D0             7      ADD A,0D0H
000DAE DAD5 47               4      LD  B,A
000DAF DAD6 5A               4      LD  E,D
000DB0 DAD7 2130FF          10      LD  HL,KBUF
       DADA                     GETL2:
000DB3 DADA CDD0F0          17      CALL    _SCRN
000DB6 DADD 03               6      INC BC
000DB7 DADE 77               7      LD  (HL),A
000DB8 DADF 23               6      INC HL
000DB9 DAE0 1D               4      DEC E
000DBA DAE1 20F7            12      JR  NZ,GETL2
       DAE3                     GETL3:
000DBC DAE3 2B               6      DEC HL
000DBD DAE4 7E               7      LD  A,(HL)
000DBE DAE5 FE21             7      CP  021H
000DC0 DAE7 D0              11      RET NC
000DC1 DAE8 3600            10      LD  (HL),0
000DC3 DAEA 15               4      DEC D
000DC4 DAEB 20F6            12      JR  NZ,GETL3
000DC6 DAED C9              10      RET
                                
       DAEE                     INKEY:
000DC7 DAEE FB               4      EI
000DC8 DAEF E5              11      PUSH    HL
000DC9 DAF0 2A90F0          16      LD  HL,(_KEYPS)
000DCC DAF3 7C               4      LD  A,H
000DCD DAF4 AD               4      XOR L
000DCE DAF5 280B            12      JR  Z,INKEY1
000DD0 DAF7 7C               4      LD  A,H
000DD1 DAF8 3C               4      INC A
000DD2 DAF9 E61F             7      AND 01FH
000DD4 DAFB 3291F0          13      LD  (_KEYPS+1),A
000DD7 DAFE 6F               4      LD  L,A
000DD8 DAFF 26F3             7      LD  H,HIGH KEYBF
000DDA DB01 7E               7      LD  A,(HL)
       DB02                     INKEY1:
000DDB DB02 E1              10      POP HL
000DDC DB03 B7               4      OR  A
000DDD DB04 C9              10      RET
                                
       DB05                     INKEYB:
000DDE DB05 C1              10      POP BC
000DDF DB06 CB47             8      BIT 0,A
000DE1 DB08 3E08             7      LD  A,8
000DE3 DB0A 2002            12      JR  NZ,INKEYD
000DE5 DB0C 3E03             7      LD  A,3
       DB0E                     INKEYD:
000DE7 DB0E 3292F0          13      LD  (_KEYD),A
000DEA DB11 B7               4      OR  A
000DEB DB12 C9              10      RET
                                
       DB13                     CHKEY:
000DEC DB13 C5              11      PUSH    BC
000DED DB14 3E88             7      LD  A,$88
000DEF DB16 CD20CF          17      CALL    RDKEYDATA
000DF2 DB19 3293F0          13      LD  (_KEYD+1),A
000DF5 DB1C CB7F             8      BIT 7,A
000DF7 DB1E 28E5            12      JR  Z,INKEYB
000DF9 DB20 E5              11      PUSH    HL
000DFA DB21 0E87             7      LD  C,$87
000DFC DB23 2140ED          10      LD  HL,KEY_TABLE
000DFF DB26 CB47             8      BIT 0,A
000E01 DB28 2003            12      JR  NZ,CHKEY0
000E03 DB2A 2180ED          10      LD  HL,SHIFT_TABLE
       DB2D                     CHKEY0:
000E06 DB2D CB77             8      BIT 6,A
000E08 DB2F 2003            12      JR  NZ,CHKEY1
000E0A DB31 21C0ED          10      LD  HL,CTRL_TABLE
       DB34                     CHKEY1:
000E0D DB34 79               4      LD  A,C
000E0E DB35 CD20CF          17      CALL    RDKEYDATA
000E11 DB38 0608             7      LD  B,8
       DB3A                     CHKEY2:
000E13 DB3A 87               4      ADD A,A
000E14 DB3B 300A            12      JR  NC,CHKEY3
000E16 DB3D 23               6      INC HL
000E17 DB3E 10FA            13      DJNZ    CHKEY2
000E19 DB40 0D               4      DEC C
000E1A DB41 CB79             8      BIT 7,C
000E1C DB43 20EF            12      JR  NZ,CHKEY1
000E1E DB45 AF               4      XOR A
000E1F DB46 06                      DB  $06     ;LD B,?? 次の1バイトを飛ばす
       DB47                     CHKEY3:
000E20 DB47 7E               7      LD  A,(HL)
000E21 DB48 E1              10      POP HL
000E22 DB49 C1              10      POP BC
000E23 DB4A 18C2            12      JR  INKEYD
                                
       DB4C                     SCRN:
000E25 DB4C E5              11      PUSH    HL
000E26 DB4D CD47CF          17      CALL    RDMMIO_BC
000E29 DB50 6F               4      LD  L,A
000E2A DB51 26EF             7      LD  H,HIGH DC_TABLE
000E2C DB53 7E               7      LD  A,(HL)
000E2D DB54 FE41             7      CP  'A'     ;英小文字チェック
000E2F DB56 380E            12      JR  C,SCRN1
000E31 DB58 FE5B             7      CP  'Z'+1
000E33 DB5A DC68DB          17      CALL    C,SCRNC
000E36 DB5D FEA6             7      CP  $A6     ;ひらがなチェック
000E38 DB5F 3805            12      JR  C,SCRN1
000E3A DB61 FEE0             7      CP  $E0
000E3C DB63 DC68DB          17      CALL    C,SCRNC
       DB66                     SCRN1:
000E3F DB66 E1              10      POP HL
000E40 DB67 C9              10      RET
                                
       DB68                     SCRNC:
000E41 DB68 6F               4      LD  L,A
000E42 DB69 60               4      LD  H,B
000E43 DB6A CBD8             8      SET 3,B
000E45 DB6C CD47CF          17      CALL    RDMMIO_BC
000E48 DB6F 44               4      LD  B,H
000E49 DB70 CB7F             8      BIT 7,A
000E4B DB72 7D               4      LD  A,L
000E4C DB73 C8              11      RET Z
000E4D DB74 FE5B             7      CP  'Z'+1
000E4F DB76 3804            12      JR  C,SCRNC_ADD
000E51 DB78 FEC0             7      CP  $C0
000E53 DB7A 3803            12      JR  C,SCRNC_SUB
       DB7C                     SCRNC_ADD:
000E55 DB7C C620             7      ADD A,$20
000E57 DB7E C9              10      RET
       DB7F                     SCRNC_SUB:
000E58 DB7F D620             7      SUB $20
000E5A DB81 C9              10      RET
       DB82                     C_MON:
000E5B DB82 2100D8          10      LD  HL,0D800H
       DB85                     MON1:
000E5E DB85 3E71             7      LD  A,071H
000E60 DB87 CD3FCF          17      CALL    WRMMIO
000E63 DB8A 23               6      INC HL
000E64 DB8B CB54             8      BIT 2,H
000E66 DB8D 28F6            12      JR  Z,MON1
000E68 DB8F C3D9CF          10      JP  IO_MON
[EOF:M7IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       DB92                     FILEC:
000E6B DB92 CD9DDB          17      CALL    FILE
       DB95                     FILEC2:
000E6E DB95 3A15F0          13      LD  A,(FDRV+1)
000E71 DB98 FE20             7      CP  020H
000E73 DB9A C8              11      RET Z
000E74 DB9B 1839            12      JR  SETDIR1
                                
       DB9D                     FILE:
000E76 DB9D AF               4      XOR A
000E77 DB9E 3214F0          13      LD  (FDRV),A
000E7A DBA1 67               4      LD  H,A
000E7B DBA2 6F               4      LD  L,A
000E7C DBA3 2222F0          16      LD  (FDRV+14),HL
000E7F DBA6 CD73DC          17      CALL    SPCUT
000E82 DBA9 CD58DC          17      CALL    CCHK3
000E85 DBAC 2812            12      JR  Z,DEVI1
000E87 DBAE 13               6      INC DE
000E88 DBAF 1A               7      LD  A,(DE)
000E89 DBB0 1B               6      DEC DE
000E8A DBB1 FE3A             7      CP  ':'
000E8C DBB3 200B            12      JR  NZ,DEVI1
000E8E DBB5 1A               7      LD  A,(DE)      ;DRIVE
000E8F DBB6 CDB9DE          17      CALL    CAP
000E92 DBB9 D640             7      SUB '@'
000E94 DBBB 13               6      INC DE
000E95 DBBC 13               6      INC DE
000E96 DBBD 3214F0          13      LD  (FDRV),A
       DBC0                     DEVI1:
000E99 DBC0 1A               7      LD  A,(DE)
000E9A DBC1 D65C             7      SUB 05CH        ;\
000E9C DBC3 2009            12      JR  NZ,NOROOT
000E9E DBC5 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
000E9F DBC6 222EF0          16      LD  (FDRV+26),HL
000EA2 DBC9 2C               4      INC L
000EA3 DBCA 2222F0          16      LD  (FDRV+14),HL
000EA6 DBCD 13               6      INC DE
       DBCE                     NOROOT:
                                
       DBCE                     SETDIR:
000EA7 DBCE CDF9DB          17      CALL    FILED
000EAA DBD1 1A               7      LD  A,(DE)
000EAB DBD2 FE5C             7      CP  05CH        ;\
000EAD DBD4 C0              11      RET NZ
000EAE DBD5 13               6      INC DE
       DBD6                     SETDIR1:
000EAF DBD6 3E10             7      LD  A,010H      ;Directory
000EB1 DBD8 3221F0          13      LD  (FDRV+13),A
000EB4 DBDB D5              11      PUSH    DE
000EB5 DBDC 1114F0          10      LD  DE,FDRV
000EB8 DBDF 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000EBA DBE1 CD48D4          17      CALL    BDOS0
000EBD DBE4 D1              10      POP DE
000EBE DBE5 B7               4      OR  A
000EBF DBE6 C0              11      RET NZ
                                
000EC0 DBE7 3A21F0          13      LD  A,(FDRV+13)
000EC3 DBEA E610             7      AND 010H        ;ディレクトリ
000EC5 DBEC C8              11      RET Z
                                
000EC6 DBED CD40DC          17      CALL    FILEI
000EC9 DBF0 2A2EF0          16      LD  HL,(FDRV+26)
000ECC DBF3 23               6      INC HL
000ECD DBF4 2222F0          16      LD  (FDRV+14),HL
000ED0 DBF7 18D5            12      JR  SETDIR
                                
       DBF9                     FILED:
000ED2 DBF9 CD40DC          17      CALL    FILEI
000ED5 DBFC 2115F0          10      LD  HL,FNAME
                                
000ED8 DBFF 0608             7      LD  B,8
       DC01                     FILE2:
000EDA DC01 CD4DDC          17      CALL    CCHKF
000EDD DC04 C8              11      RET Z
000EDE DC05 FE2A             7      CP  '*'
000EE0 DC07 282E            12      JR  Z,FILE9
000EE2 DC09 FE2E             7      CP  '.'
000EE4 DC0B 280C            12      JR  Z,FILE4
000EE6 DC0D 77               7      LD  (HL),A
000EE7 DC0E 23               6      INC HL
000EE8 DC0F 10F0            13      DJNZ    FILE2
                                
       DC11                     FILE3:
000EEA DC11 CD4DDC          17      CALL    CCHKF
000EED DC14 C8              11      RET Z
000EEE DC15 FE2E             7      CP  '.'
000EF0 DC17 20F8            12      JR  NZ,FILE3
                                
       DC19                     FILE4:
000EF2 DC19 211DF0          10      LD  HL,FNAME+8
000EF5 DC1C 0603             7      LD  B,3
                                
       DC1E                     FILE4L:
000EF7 DC1E CD4DDC          17      CALL    CCHKF
000EFA DC21 C8              11      RET Z
000EFB DC22 FE2E             7      CP  '.'
000EFD DC24 2008            12      JR  NZ,FILE12
000EFF DC26 3215F0          13      LD  (FNAME),A   ;Parent directory(..)
000F02 DC29 3216F0          13      LD  (FNAME+1),A
000F05 DC2C 3E20             7      LD  A,020H
       DC2E                     FILE12:
000F07 DC2E FE2A             7      CP  '*'
000F09 DC30 280A            12      JR  Z,FILE10
000F0B DC32 77               7      LD  (HL),A
000F0C DC33 23               6      INC HL
000F0D DC34 10E8            13      DJNZ    FILE4L
000F0F DC36 C9              10      RET
                                
       DC37                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000F10 DC37 CD3CDC          17      CALL    FILE10
000F13 DC3A 18D5            12      JR  FILE3
                                
       DC3C                     FILE10:
000F15 DC3C 3E3F             7      LD  A,'?'
000F17 DC3E 1808            12      JR  FILL_MEMORY
       DC40                     FILEI:              ;名前＋拡張子をスペースで初期化
000F19 DC40 3E20             7      LD  A,020H
000F1B DC42 01000B          10      LD  BC,11*256   ;C=0にしておく
000F1E DC45 2115F0          10      LD  HL,FNAME
       DC48                     FILL_MEMORY:            ;HLからBバイトAで埋める
000F21 DC48 77               7      LD  (HL),A
000F22 DC49 23               6      INC HL
000F23 DC4A 10FC            13      DJNZ    FILL_MEMORY
000F25 DC4C C9              10      RET
                                
       DC4D                     CCHKF:
000F26 DC4D 1A               7      LD  A,(DE)
000F27 DC4E CD55DC          17      CALL    CCHK2
000F2A DC51 C8              11      RET Z
000F2B DC52 C3C1DF          10      JP  FKAN
                                
       DC55                     CCHK2:
000F2E DC55 0C               4      INC C
000F2F DC56 0D               4      DEC C
000F30 DC57 C0              11      RET NZ
       DC58                     CCHK3:              ;ZF=1 で使えない文字
000F31 DC58 FE2B             7      CP  '+'
000F33 DC5A C8              11      RET Z
000F34 DC5B FE2C             7      CP  ','
000F36 DC5D C8              11      RET Z
000F37 DC5E FE2F             7      CP  '/'
000F39 DC60 C8              11      RET Z
000F3A DC61 FE3A             7      CP  ':'
000F3C DC63 C8              11      RET Z
000F3D DC64 FE3B             7      CP  ';'
000F3F DC66 C8              11      RET Z
000F40 DC67 FE3D             7      CP  '='
000F42 DC69 C8              11      RET Z
000F43 DC6A FE5C             7      CP  05CH    ;\
000F45 DC6C C8              11      RET Z
000F46 DC6D FE20             7      CP  020H
000F48 DC6F D0              11      RET NC
000F49 DC70 BF               4      CP  A       ;Z=1
000F4A DC71 C9              10      RET
                                
       DC72                     SS1:
000F4B DC72 13               6      INC DE
       DC73                     SPCUT:              ;スペースをカット
000F4C DC73 1A               7      LD  A,(DE)
000F4D DC74 FE20             7      CP  020H
000F4F DC76 28FA            12      JR  Z,SS1
000F51 DC78 C9              10      RET
                                
       DC79                     SETDRVF:
000F52 DC79 1114F0          10      LD  DE,FDRV
       DC7C                     SETDRV0:
000F55 DC7C CD85DC          17      CALL    SETDRV
000F58 DC7F FDE1            14      POP IY
000F5A DC81 C1              10      POP BC
000F5B DC82 D1              10      POP DE
000F5C DC83 E1              10      POP HL
000F5D DC84 C9              10      RET
                                
       DC85                     SETDRV:
000F5E DC85 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
000F5F DC86 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
000F60 DC87 C5              11      PUSH    BC
000F61 DC88 1A               7      LD  A,(DE)
000F62 DC89 D5              11      PUSH    DE
000F63 DC8A FDE3            23      EX  (SP),IY
                                
000F65 DC8C CD93DC          17      CALL    GETDRV
000F68 DC8F CDD9F0          17      CALL    _CHGDRV
                                
000F6B DC92 E9               4      JP  (HL)
                                
       DC93                     GETDRV:
000F6C DC93 CDA6DC          17      CALL    GETDRV1
000F6F DC96 3288F0          13      LD  (_DRV),A
000F72 DC99 C9              10      RET
                                
       DC9A                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
000F73 DC9A CDA6DC          17      CALL    GETDRV1
000F76 DC9D C5              11      PUSH    BC
000F77 DC9E 4F               4      LD  C,A
000F78 DC9F 1A               7      LD  A,(DE)
000F79 DCA0 CDA6DC          17      CALL    GETDRV1
000F7C DCA3 A9               4      XOR C
000F7D DCA4 C1              10      POP BC
000F7E DCA5 C9              10      RET
       DCA6                     GETDRV1:
000F7F DCA6 E67F             7      AND 07FH
000F81 DCA8 D601             7      SUB 001H
000F83 DCAA D0              11      RET NC
000F84 DCAB 3A0400          13      LD  A,(_DVSW)   ;Current Drive
000F87 DCAE C9              10      RET
                                
       DCAF                     SOPENX:
000F88 DCAF 1139F0          10      LD  DE,SFILE
000F8B DCB2 FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
000F8E DCB5 CD9ADC          17      CALL    IS_SAME_DRV_A_DE
000F91 DCB8 2024            12      JR  NZ,SOPEN
000F93 DCBA 13               6      INC DE
000F94 DCBB FDE5            15      PUSH    IY
000F96 DCBD E1              10      POP HL
000F97 DCBE 23               6      INC HL
000F98 DCBF CD4ADE          17      CALL    CPFILE
000F9B DCC2 201A            12      JR  NZ,SOPEN
                                
000F9D DCC4 2AF4F1          16      LD  HL,(SCDIR)
000FA0 DCC7 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
000FA3 DCCA FD740F          19      LD  (IY+15),H
                                
000FA6 DCCD 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
000FA9 DCD0 229FF0          16      LD  (_FILEN),HL
                                
000FAC DCD3 ED5BF6F1        20      LD  DE,(SFBPS)
000FB0 DCD7 2139F0          10      LD  HL,SFILE
000FB3 DCDA 36FF            10      LD  (HL),0FFH
000FB5 DCDC 23               6      INC HL
000FB6 DCDD C9              10      RET
       DCDE                     SOPEN:
000FB7 DCDE 21F2DD          10      LD  HL,FILESE
       DCE1                     SOPENC:
000FBA DCE1 221ADD          16      LD  (OPENPAT),HL
                                
000FBD DCE4 CDE2F0          17      CALL    _RDFATX     ;Detect Media
000FC0 DCE7 3856            12      JR  C,RDDERR
                                
000FC2 DCE9 AF               4      XOR A
000FC3 DCEA 329FF0          13      LD  (_FILEN),A
000FC6 DCED CDF6DE          17      CALL    LDDIRX1     ;A=0で呼び出す
000FC9 DCF0 2818            12      JR  Z,SDIRX1
                                
000FCB DCF2 CDE3DD          17      CALL    READ_DIR    ;Sub Directory
000FCE DCF5 3808            12      JR  C,SDIRX0
000FD0 DCF7 2A7EF1          16      LD  HL,(_DTBUF)
000FD3 DCFA 7E               7      LD  A,(HL)
000FD4 DCFB FE2E             7      CP  '.'
000FD6 DCFD 280F            12      JR  Z,SOPEN1
       DCFF                     SDIRX0:
000FD8 DCFF AF               4      XOR A
000FD9 DD00 32A0F0          13      LD  (_DIRF),A
000FDC DD03 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
000FE0 DD07 FD770F          19      LD  (IY+15),A
       DD0A                     SDIRX1:
000FE3 DD0A ED5BFCF1        20      LD  DE,(_DIRPS) ;Root Directory
       DD0E                     SOPEN1:
000FE7 DD0E 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       DD0F                     SDECPAT EQU $-1
       DD10                     SOPEN1X:
000FE9 DD10 CDE3DD          17      CALL    READ_DIR    ;FILE SEARCH
000FEC DD13 382A            12      JR  C,RDDERR
000FEE DD15 2A7EF1          16      LD  HL,(_DTBUF)
       DD18                     SOPEN2:
000FF1 DD18 D5              11      PUSH    DE
000FF2 DD19 CDF2DD          17      CALL    FILESE      ;(self-modifying code)
       DD1A                     OPENPAT EQU $-2
000FF5 DD1C D1              10      POP DE
000FF6 DD1D 386D            12      JR  C,SOPENE
000FF8 DD1F 281B            12      JR  Z,SCF_FF_RET
       DD21                     SOPEN3:
000FFA DD21 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
000FFD DD24 B7               4      OR  A
000FFE DD25 200C            12      JR  NZ,SOPEN5
001000 DD27 13               6      INC DE      ;ルートディレクトリ
001001 DD28 E5              11      PUSH    HL
001002 DD29 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       DD2A                     MD_PAT  EQU $-2
001005 DD2C ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
001007 DD2E E1              10      POP HL
001008 DD2F 20DD            12      JR  NZ,SOPEN1
00100A DD31 1807            12      JR  SOPEN6
       DD33                     SOPEN5:
00100C DD33 CDFDE5          17      CALL    GNCLX       ;END DIR
00100F DD36 D8              11      RET C
001010 DD37 CDAADE          17      CALL    ENDCL
       DD3A                     SOPEN6:
001013 DD3A 38D2            12      JR  C,SOPEN1
       DD3C                     SCF_FF_RET:
001015 DD3C 37               4      SCF         ;CF=1
001016 DD3D 9F               4      SBC A,A     ;A=0FFH
001017 DD3E C9              10      RET
                                
       DD3F                     RDDERR:
001018 DD3F BF               4      CP  A       ;READ ERR CF=1 ZF=1
001019 DD40 37               4      SCF
00101A DD41 C9              10      RET
                                
       DD42                     NOPEN:
00101B DD42 21F2DD          10      LD  HL,FILESE
00101E DD45 221ADD          16      LD  (OPENPAT),HL
001021 DD48 FD2A98F0        20      LD  IY,(_FCB)
001025 DD4C CDD4DF          17      CALL    CHKWILDX
001028 DD4F 30EB            12      JR  NC,SCF_FF_RET
00102A DD51 FD7E00          19      LD  A,(IY+0)
00102D DD54 CD93DC          17      CALL    GETDRV
001030 DD57 CDD9F0          17      CALL    _CHGDRV
001033 DD5A D8              11      RET C
001034 DD5B 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
001037 DD5E 229FF0          16      LD  (_FILEN),HL
                                
00103A DD61 CDF1DE          17      CALL    LDDIRX
00103D DD64 ED5B9AF0        20      LD  DE,(_FBPS)
001041 DD68 CDE3DD          17      CALL    READ_DIR
001044 DD6B 38D2            12      JR  C,RDDERR
001046 DD6D 3A9EF0          13      LD  A,(_FBCNT)
001049 DD70 3D               4      DEC A
00104A DD71 28AE            12      JR  Z,SOPEN3
       DD73                     NOPEN2:
00104C DD73 2A9CF0          16      LD  HL,(_FBAD)
00104F DD76 012000          10      LD  BC,020H
001052 DD79 09              11      ADD HL,BC
001053 DD7A 4F               4      LD  C,A
001054 DD7B 189B            12      JR  SOPEN2
                                
       DD7D                     SOPENE2:
001056 DD7D 229CF0          16      LD  (_FBAD),HL
001059 DD80 79               4      LD  A,C
00105A DD81 329EF0          13      LD  (_FBCNT),A
00105D DD84 ED539AF0        20      LD  (_FBPS),DE
001061 DD88 FD2298F0        20      LD  (_FCB),IY
       DD8C                     SOPENE:
001065 DD8C AF               4      XOR A
001066 DD8D C9              10      RET
                                
       DD8E                     COPEN:
001067 DD8E FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
00106B DD92 210FDE          10      LD  HL,NEXTSE
00106E DD95 CDE1DC          17      CALL    SOPENC
001071 DD98 D0              11      RET NC
001072 DD99 C8              11      RET Z
001073 DD9A 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
001076 DD9D B7               4      OR  A
001077 DD9E 37               4      SCF
001078 DD9F C8              11      RET Z       ;ルートディレクトリ
001079 DDA0 0601             7      LD  B,1
00107B DDA2 CD33E0          17      CALL    WRDF
00107E DDA5 D8              11      RET C
00107F DDA6 ED5BFEF1        20      LD  DE,(_CLPS)
001083 DDAA D5              11      PUSH    DE
001084 DDAB CD73DE          17      CALL    DCPAT
001087 DDAE CD7EE4          17      CALL    DRDNX
00108A DDB1 2A7EF1          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
00108D DDB4 ED4B69E3        20      LD  BC,(SECSZ)  ;1セクタのサイズ
001091 DDB8 AF               4      XOR A
       DDB9                     COPENCL:
001092 DDB9 77               7      LD  (HL),A
001093 DDBA EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001095 DDBC EAB9DD          10      JP  PE,COPENCL
                                
001098 DDBF 3A91DE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
00109B DDC2 3D               4      DEC A
00109C DDC3 2819            12      JR  Z,COPENE
00109E DDC5 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
0010A0 DDC7 32F5E5          13      LD  (_SECPS),A
0010A3 DDCA D1              10      POP DE      ;DE=(_CLPS)
0010A4 DDCB D5              11      PUSH    DE
       DDCC                     COPEN1:
0010A5 DDCC D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
0010A6 DDCD C5              11      PUSH    BC
0010A7 DDCE 2A7EF1          16      LD  HL,(_DTBUF)
0010AA DDD1 CD8DDE          17      CALL    CLUSTX
0010AD DDD4 CD94E7          17      CALL    DWT24
0010B0 DDD7 C1              10      POP BC
0010B1 DDD8 D1              10      POP DE
0010B2 DDD9 CDF4E5          17      CALL    NEXTX
0010B5 DDDC 20EE            12      JR  NZ,COPEN1
       DDDE                     COPENE:
0010B7 DDDE 2A7EF1          16      LD  HL,(_DTBUF)
0010BA DDE1 D1              10      POP DE
0010BB DDE2 C9              10      RET
                                
       DDE3                     READ_DIR:
0010BC DDE3 ED53FEF1        20      LD  (_CLPS),DE
0010C0 DDE7 C5              11      PUSH    BC
0010C1 DDE8 D5              11      PUSH    DE
0010C2 DDE9 CD73DE          17      CALL    DCPAT
0010C5 DDEC CD5EE4          17      CALL    DRDX
0010C8 DDEF D1              10      POP DE
0010C9 DDF0 C1              10      POP BC
0010CA DDF1 C9              10      RET
                                
       DDF2                     FILESE:
0010CB DDF2 7E               7      LD  A,(HL)
0010CC DDF3 B7               4      OR  A
0010CD DDF4 C8              11      RET Z       ;END:ZF=1 CF=0
0010CE DDF5 FEE5             7      CP  0E5H
0010D0 DDF7 280E            12      JR  Z,FILESE1
0010D2 DDF9 FDE5            15      PUSH    IY
0010D4 DDFB D1              10      POP DE
0010D5 DDFC 13               6      INC DE
0010D6 DDFD E5              11      PUSH    HL
0010D7 DDFE CD4ADE          17      CALL    CPFILE
0010DA DE01 CC6BDE          17      CALL    Z,CPFILE2
0010DD DE04 E1              10      POP HL
0010DE DE05 37               4      SCF
0010DF DE06 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       DE07                     FILESE1:
0010E0 DE07 CD1EDE          17      CALL    FNEXT
0010E3 DE0A 20E6            12      JR  NZ,FILESE
       DE0C                     ZF0_CF0_AFF_RET:
0010E5 DE0C F6FF             7      OR  0FFH        ;ZF=0 CF=0
0010E7 DE0E C9              10      RET
                                
       DE0F                     NEXTSE:
0010E8 DE0F 7E               7      LD  A,(HL)
0010E9 DE10 B7               4      OR  A
0010EA DE11 37               4      SCF
0010EB DE12 C8              11      RET Z       ;!!!:ZF=1 CF=1
0010EC DE13 FEE5             7      CP  0E5H
0010EE DE15 37               4      SCF
0010EF DE16 C8              11      RET Z       ;!!!:(ZF=1) CF=1
0010F0 DE17 CD1EDE          17      CALL    FNEXT
0010F3 DE1A 20F3            12      JR  NZ,NEXTSE
0010F5 DE1C 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       DE1E                     FNEXT:
0010F7 DE1E E5              11      PUSH    HL
0010F8 DE1F 219FF0          10      LD  HL,_FILEN
0010FB DE22 34              11      INC (HL)
0010FC DE23 E1              10      POP HL
0010FD DE24 112000          10      LD  DE,020H
001100 DE27 19              11      ADD HL,DE
001101 DE28 0D               4      DEC C
001102 DE29 C9              10      RET
                                
       DE2A                     CPNAME:
001103 DE2A C5              11      PUSH    BC
001104 DE2B D5              11      PUSH    DE
001105 DE2C E5              11      PUSH    HL
001106 DE2D CD44DE          17      CALL    CPFILE4
001109 DE30 E1              10      POP HL
00110A DE31 23               6      INC HL
00110B DE32 23               6      INC HL
00110C DE33 23               6      INC HL
00110D DE34 23               6      INC HL
00110E DE35 D1              10      POP DE
00110F DE36 C1              10      POP BC
001110 DE37 2005            12      JR  NZ,CPNAME1
001112 DE39 7E               7      LD  A,(HL)
001113 DE3A 23               6      INC HL
001114 DE3B 66               7      LD  H,(HL)
001115 DE3C 6F               4      LD  L,A
001116 DE3D C9              10      RET
       DE3E                     CPNAME1:
001117 DE3E 23               6      INC HL
001118 DE3F 23               6      INC HL
001119 DE40 10E8            13      DJNZ    CPNAME
00111B DE42 37               4      SCF
00111C DE43 C9              10      RET
                                
       DE44                     CPFILE4:
00111D DE44 C5              11      PUSH    BC
00111E DE45 010004          10      LD  BC,00400H
001121 DE48 1804            12      JR  CPSTR1
       DE4A                     CPFILE:
001123 DE4A C5              11      PUSH    BC
001124 DE4B 01000B          10      LD  BC,00B00H
       DE4E                     CPSTR1:
001127 DE4E 1A               7      LD  A,(DE)
001128 DE4F FE3F             7      CP  '?'     ;Wild card
00112A DE51 2812            12      JR  Z,CPSTR2
00112C DE53 7E               7      LD  A,(HL)
00112D DE54 CDBADF          17      CALL    FKANC
001130 DE57 E5              11      PUSH    HL
001131 DE58 67               4      LD  H,A
001132 DE59 1A               7      LD  A,(DE)
001133 DE5A CB01             8      RLC C
001135 DE5C CDBADF          17      CALL    FKANC
001138 DE5F CB09             8      RRC C
00113A DE61 BC               4      CP  H       ;CP (HL),(DE)
00113B DE62 E1              10      POP HL
00113C DE63 2004            12      JR  NZ,CPSTR3
       DE65                     CPSTR2:
00113E DE65 13               6      INC DE
00113F DE66 23               6      INC HL
001140 DE67 10E5            13      DJNZ    CPSTR1
       DE69                     CPSTR3:
001142 DE69 C1              10      POP BC
001143 DE6A C9              10      RET
                                
       DE6B                     CPFILE2:
001144 DE6B FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001147 DE6E F6E1             7      OR  0E1H
001149 DE70 2F               4      CPL
00114A DE71 A6               7      AND (HL)
00114B DE72 C9              10      RET
                                
       DE73                     DCPAT:
00114C DE73 0E00             7      LD  C,0
00114E DE75 2A7EF1          16      LD  HL,(_DTBUF)
001151 DE78 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
001154 DE7B B7               4      OR  A
001155 DE7C C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
001156 DE7D 3A91DE          13      LD  A,(SPCPAT)
001159 DE80 4F               4      LD  C,A
00115A DE81 3AF5E5          13      LD  A,(_SECPS)
00115D DE84 B9               4      CP  C
00115E DE85 3801            12      JR  C,DC1
001160 DE87 AF               4      XOR A
       DE88                     DC1:
001161 DE88 F680             7      OR  080H
001163 DE8A 32A0F0          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       DE8D                     CLUSTX:
001166 DE8D E5              11      PUSH    HL
001167 DE8E EB               4      EX  DE,HL
001168 DE8F AF               4      XOR A
001169 DE90 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       DE91                     SPCPAT  EQU $-1
       DE92                     L_CLDBL:
00116B DE92 CB19             8      RR  C       ;->CF
00116D DE94 3804            12      JR  C,E_CLDBL
00116F DE96 29              11      ADD HL,HL       ;*2
001170 DE97 8F               4      ADC A,A
001171 DE98 18F8            12      JR  L_CLDBL
       DE9A                     E_CLDBL:
001173 DE9A 4F               4      LD  C,A
001174 DE9B 3AF5E5          13      LD  A,(_SECPS)
001177 DE9E B5               4      OR  L
001178 DE9F 6F               4      LD  L,A
001179 DEA0 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       DEA1                     CLSPAT  EQU $-2
00117C DEA3 AF               4      XOR A
00117D DEA4 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
00117E DEA5 89               4      ADC A,C
00117F DEA6 4F               4      LD  C,A
001180 DEA7 EB               4      EX  DE,HL
001181 DEA8 E1              10      POP HL
001182 DEA9 C9              10      RET
                                ;(8)
       DEAA                     ENDCL:
001183 DEAA 7A               4      LD  A,D ;END CLUSTER
001184 DEAB FE01             7      CP  1   ;164=356    (self-modifying code)
       DEAC                     CLPAT1  EQU $-1
001186 DEAD C0              11      RET NZ
001187 DEAE 7B               4      LD  A,E
001188 DEAF FE64             7      CP  064H    ;       (self-modifying code)
       DEB0                     CLPAT2  EQU $-1
00118A DEB1 C9              10      RET
                                ;(3)
       DEB2                     CAP4:
00118B DEB2 3EE5             7      LD  A,0E5H
00118D DEB4 C9              10      RET
                                                    ;for X1/88 ワークエリア
00118E DEB5 5BF0                    DW  _DISKE+1        ;DISKVE($F323)
001190 DEB7 F5F0                    DW  _BREAK+1        ;BREAKV($F325)
                                
       DEB9                     CAP:            ;(9)
001192 DEB9 FE61             7      CP  'a'
001194 DEBB D8              11      RET C
001195 DEBC FE7B             7      CP  'z'+1
001197 DEBE D0              11      RET NC
001198 DEBF D620             7      SUB 020H
00119A DEC1 C9              10      RET
                                ;(10)
       DEC2                     CAP2:
00119B DEC2 CDB9DE          17      CALL    CAP
       DEC5                     CAP3:               ;
00119E DEC5 FE05             7      CP  5
0011A0 DEC7 28E9            12      JR  Z,CAP4
0011A2 DEC9 FE21             7      CP  021H
0011A4 DECB C9              10      RET
                                                    ;
       DECC                     CHDIR:
0011A5 DECC CDA5E8          17      CALL    GETDPBD
0011A8 DECF 381D            12      JR  C,CHDIR2
0011AA DED1 DD751A          19      LD  (IX+DPB_SDIR),L
0011AD DED4 DD741B          19      LD  (IX+DPB_SDIR+1),H
0011B0 DED7 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       DED9                     LDDIR:
0011B2 DED9 CDA5E8          17      CALL    GETDPBD
0011B5 DEDC DD5E1A          19      LD  E,(IX+DPB_SDIR)
0011B8 DEDF DD561B          19      LD  D,(IX+DPB_SDIR+1)
0011BB DEE2 13               6      INC DE
0011BC DEE3 FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011BF DEE6 FD720F          19      LD  (IY+15),D
0011C2 DEE9 1B               6      DEC DE
0011C3 DEEA AF               4      XOR A
0011C4 DEEB 32A0F0          13      LD  (_DIRF),A
       DEEE                     CHDIR2:
0011C7 DEEE DDE1            14      POP IX
0011C9 DEF0 C9              10      RET
                                
       DEF1                     LDDIRX:
0011CA DEF1 3AA0F0          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
0011CD DEF4 E67F             7      AND 07FH
       DEF6                     LDDIRX1:
0011CF DEF6 32F5E5          13      LD  (_SECPS),A
0011D2 DEF9 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011D5 DEFC FD560F          19      LD  D,(IY+15)
0011D8 DEFF 1B               6      DEC DE
0011D9 DF00 CDAADE          17      CALL    ENDCL
0011DC DF03 D4D9DE          17      CALL    NC,LDDIR
       DF06                     LDDIRS:
0011DF DF06 7A               4      LD  A,D
0011E0 DF07 B3               4      OR  E
0011E1 DF08 32A0F0          13      LD  (_DIRF),A   ;ディレクトリか判別
0011E4 DF0B C9              10      RET
                                
       DF0C                     KILL:
0011E5 DF0C CDD4DF          17      CALL    CHKWILDX
0011E8 DF0F 3834            12      JR  C,KILLW
0011EA DF11 CDAFDC          17      CALL    SOPENX
       DF14                     KILLS:
0011ED DF14 3E1F             7      LD  A,01FH
0011EF DF16 D458DF          17      CALL    NC,CHKATT
0011F2 DF19 D8              11      RET C
       DF1A                     KILLSX:
0011F3 DF1A 36E5            10      LD  (HL),0E5H   ;DIR
0011F5 DF1C CDB0DF          17      CALL    WTDB
0011F8 DF1F 111A00          10      LD  DE,01AH
0011FB DF22 19              11      ADD HL,DE
0011FC DF23 5E               7      LD  E,(HL)
0011FD DF24 23               6      INC HL
0011FE DF25 56               7      LD  D,(HL)
       DF26                     KILLS1:
0011FF DF26 CDAADE          17      CALL    ENDCL
001202 DF29 D0              11      RET NC      ;CF=0
001203 DF2A 21FEFF          10      LD  HL,0-2
001206 DF2D 19              11      ADD HL,DE
001207 DF2E D0              11      RET NC      ;DE= 0 or 1
001208 DF2F D5              11      PUSH    DE
001209 DF30 CDF7F0          17      CALL    _GNCL
00120C DF33 ED53FEF1        20      LD  (_CLPS),DE
001210 DF37 D1              10      POP DE
001211 DF38 210000          10      LD  HL,0
001214 DF3B D4FAF0          17      CALL    NC,_SNCL
001217 DF3E D8              11      RET C
001218 DF3F ED5BFEF1        20      LD  DE,(_CLPS)  ;FAT
00121C DF43 18E1            12      JR  KILLS1
                                
       DF45                     KILLW:
00121E DF45 CDDEDC          17      CALL    SOPEN
       DF48                     KILLW1:
001221 DF48 380B            12      JR  C,KILLW2
001223 DF4A CD7DDD          17      CALL    SOPENE2
001226 DF4D CD14DF          17      CALL    KILLS
001229 DF50 CD42DD          17      CALL    NOPEN
00122C DF53 18F3            12      JR  KILLW1
       DF55                     KILLW2:
00122E DF55 C8              11      RET Z
00122F DF56 3F               4      CCF
001230 DF57 C9              10      RET
                                
       DF58                     CHKATT:
001231 DF58 E5              11      PUSH    HL
001232 DF59 110B00          10      LD  DE,00BH
001235 DF5C 19              11      ADD HL,DE
001236 DF5D A6               7      AND (HL)
001237 DF5E E1              10      POP HL
001238 DF5F C8              11      RET Z
001239 DF60 37               4      SCF
00123A DF61 C9              10      RET
                                
       DF62                     NAME:
00123B DF62 CDD4DF          17      CALL    CHKWILDX
00123E DF65 D8              11      RET C
00123F DF66 110400          10      LD  DE,4
001242 DF69 19              11      ADD HL,DE
001243 DF6A 227FDF          16      LD  (NAMEP),HL
001246 DF6D 23               6      INC HL
001247 DF6E CDD8DF          17      CALL    CHKWILD
00124A DF71 D8              11      RET C
                                
00124B DF72 CDAFDC          17      CALL    SOPENX
00124E DF75 3E0F             7      LD  A,00FH
001250 DF77 D458DF          17      CALL    NC,CHKATT
001253 DF7A D8              11      RET C
                                
001254 DF7B FDE5            15      PUSH    IY
001256 DF7D FD210000        14      LD  IY,0        ;自己書き換え
       DF7F                     NAMEP   EQU $-2
00125A DF81 CDAFDC          17      CALL    SOPENX
00125D DF84 FDE3            23      EX  (SP),IY
00125F DF86 3F               4      CCF
001260 DF87 D4DEDC          17      CALL    NC,SOPEN
001263 DF8A EB               4      EX  DE,HL
001264 DF8B E1              10      POP HL
001265 DF8C D8              11      RET C
                                
       DF8D                     SETNAME:
001266 DF8D 01000B          10      LD  BC,11*256
001269 DF90 23               6      INC HL
00126A DF91 7E               7      LD  A,(HL)
00126B DF92 FEE5             7      CP  0E5H
00126D DF94 2004            12      JR  NZ,SNAME1
00126F DF96 3E05             7      LD  A,5
001271 DF98 180E            12      JR  SNAME3
       DF9A                     SNAME1:
001273 DF9A 7E               7      LD  A,(HL)
001274 DF9B 0C               4      INC C
001275 DF9C 0D               4      DEC C
001276 DF9D 2009            12      JR  NZ,SNAME3
001278 DF9F CDB9DE          17      CALL    CAP
00127B DFA2 FEA0             7      CP  0A0H
00127D DFA4 2002            12      JR  NZ,SNAME3
00127F DFA6 3E20             7      LD  A,020H
       DFA8                     SNAME3:
001281 DFA8 12               7      LD  (DE),A
001282 DFA9 7E               7      LD  A,(HL)
001283 DFAA 23               6      INC HL
001284 DFAB CDC1DF          17      CALL    FKAN
001287 DFAE 10EA            13      DJNZ    SNAME1
       DFB0                     WTDB:               ;バッファデータが更新された
001289 DFB0 3EFF             7      LD  A,0FFH
00128B DFB2 3239F0          13      LD  (SFILE),A
00128E DFB5 32A4F0          13      LD  (_WTDBF),A
001291 DFB8 AF               4      XOR A
001292 DFB9 C9              10      RET
                                
       DFBA                     FKANC:
001293 DFBA CB41             8      BIT 0,C
001295 DFBC CCC2DE          17      CALL    Z,CAP2
001298 DFBF 1801            12      JR  FKANX
       DFC1                     FKAN:           ;漢字チェック
00129A DFC1 13               6      INC DE
       DFC2                     FKANX:
00129B DFC2 CB41             8      BIT 0,C
00129D DFC4 CB81             8      RES 0,C
00129F DFC6 C0              11      RET NZ
0012A0 DFC7 FE80             7      CP  080H
0012A2 DFC9 D8              11      RET C
0012A3 DFCA FEA0             7      CP  0A0H
0012A5 DFCC 3803            12      JR  C,FKAN1
0012A7 DFCE FEE0             7      CP  0E0H
0012A9 DFD0 D8              11      RET C
       DFD1                     FKAN1:
0012AA DFD1 0C               4      INC C
0012AB DFD2 A7               4      AND A
0012AC DFD3 C9              10      RET
                                
       DFD4                     CHKWILDX:
0012AD DFD4 FDE5            15      PUSH    IY
0012AF DFD6 E1              10      POP HL
0012B0 DFD7 23               6      INC HL
       DFD8                     CHKWILD:
0012B1 DFD8 060B             7      LD  B,11
0012B3 DFDA 3E3F             7      LD  A,'?'
       DFDC                     CHKWIL1:
0012B5 DFDC BE               7      CP  (HL)
0012B6 DFDD 23               6      INC HL
0012B7 DFDE 37               4      SCF
0012B8 DFDF C8              11      RET Z
0012B9 DFE0 10FA            13      DJNZ    CHKWIL1
0012BB DFE2 AF               4      XOR A
0012BC DFE3 C9              10      RET
                                
       DFE4                     SDIRENT:        ;IY=FCB HL=DIR
0012BD DFE4 D5              11      PUSH    DE
0012BE DFE5 E5              11      PUSH    HL
0012BF DFE6 FDE5            15      PUSH    IY
0012C1 DFE8 D1              10      POP DE
0012C2 DFE9 EB               4      EX  DE,HL
0012C3 DFEA CD8DDF          17      CALL    SETNAME
                                ;               Attribute
0012C6 DFED FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0012C9 DFF0 12               7      LD  (DE),A
0012CA DFF1 13               6      INC DE
                                ;               Reserved
0012CB DFF2 AF               4      XOR A
0012CC DFF3 060A             7      LD  B,10
       DFF5                     SDE1:
0012CE DFF5 12               7      LD  (DE),A
0012CF DFF6 13               6      INC DE
0012D0 DFF7 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
0012D2 DFF9 21E4F1          10      LD  HL,SDDATA       ;(FCB)更新年月日
0012D5 DFFC 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DFFE                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
0012D7 DFFE 7E               7      LD  A,(HL)
0012D8 DFFF 23               6      INC HL
0012D9 E000 3205E0          13      LD  (SDPAT),A
0012DC E003 FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       E005                     SDPAT   EQU $-1
0012DF E006 12               7      LD  (DE),A
0012E0 E007 13               6      INC DE
0012E1 E008 10F4            13      DJNZ    SDLOOP
                                
0012E3 E00A AF               4      XOR A
0012E4 E00B E1              10      POP HL
0012E5 E00C D1              10      POP DE
0012E6 E00D C9              10      RET
                                
       E00E                     WOPEN:
0012E7 E00E FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0012EA E011 E61F             7      AND 01FH
0012EC E013 37               4      SCF
0012ED E014 C0              11      RET NZ
0012EE E015 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E019                     TOPEN2:
0012F2 E019 AF               4      XOR A
       E01A                     TOPEN:              ;Initializes the time stamp
0012F3 E01A FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
0012F7 E01E C9              10      RET
                                
       E01F                     WRDFX:
0012F8 E01F 3A91DE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       E022                     L_WRFX:
0012FB E022 1F               4      RRA         ;->CF
0012FC E023 3806            12      JR  C,E_WRFX
0012FE E025 CB39             8      SRL C
001300 E027 CB1C             8      RR  H       ;CH=CH/2
001302 E029 18F7            12      JR  L_WRFX
       E02B                     E_WRFX:
001304 E02B 41               4      LD  B,C
001305 E02C 4C               4      LD  C,H
001306 E02D 03               6      INC BC
001307 E02E 3E37             7      LD  A,037H      ;SCF
001309 E030 327BE4          13      LD  (DRDN1),A
                                
       E033                     WRDF:               ;BCクラスタ分FATを確保する
00130C E033 110200          10      LD  DE,2
00130F E036 AF               4      XOR A
001310 E037 32F5E5          13      LD  (_SECPS),A
       E03A                     WRDF1:
001313 E03A C5              11      PUSH    BC
001314 E03B D5              11      PUSH    DE
001315 E03C CDF7F0          17      CALL    _GNCL
001318 E03F 381C            12      JR  C,WRDF3
00131A E041 7A               4      LD  A,D     ;空いているかチェック
00131B E042 B3               4      OR  E
00131C E043 202A            12      JR  NZ,WRDF4
00131E E045 E1              10      POP HL      ;HL=空いているクラスタ
00131F E046 E5              11      PUSH    HL
001320 E047 ED5BFEF1        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
001324 E04B 22FEF1          16      LD  (_CLPS),HL
001327 E04E 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
001328 E04F B3               4      OR  E
001329 E050 2008            12      JR  NZ,WRDF2
00132B E052 FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
00132E E055 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
001331 E058 1803            12      JR  WRDF3
       E05A                     WRDF2:
001333 E05A CDFAF0          17      CALL    _SNCL
       E05D                     WRDF3:
001336 E05D D1              10      POP DE
001337 E05E C1              10      POP BC
001338 E05F D8              11      RET C
001339 E060 0B               6      DEC BC
00133A E061 78               4      LD  A,B
00133B E062 B1               4      OR  C
00133C E063 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
00133E E065 ED5BFEF1        20      LD  DE,(_CLPS)
001342 E069 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
001345 E06C C3FAF0          10      JP  _SNCL
                                
       E06F                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
001348 E06F D1              10      POP DE
001349 E070 C1              10      POP BC
       E071                     WRDF5:
00134A E071 13               6      INC DE
00134B E072 CDAADE          17      CALL    ENDCL
00134E E075 38C3            12      JR  C,WRDF1
001350 E077 37               4      SCF
001351 E078 C9              10      RET
                                
       E079                     RWXR:
001352 E079 3A6AE3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E07C                     L_RWX:
001355 E07C 1F               4      RRA     ;->CF
001356 E07D 3808            12      JR  C,E_RWX
001358 E07F CB38             8      SRL B   ;BCH=BCH/2
00135A E081 CB19             8      RR  C   ;
00135C E083 CB1C             8      RR  H   ;
00135E E085 18F5            12      JR  L_RWX
       E087                     E_RWX:
001360 E087 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001363 E08A FD561B          19      LD  D,(IY+27)
001366 E08D AF               4      XOR A
001367 E08E 32F5E5          13      LD  (_SECPS),A
       E091                     RWX1:
00136A E091 ED53FEF1        20      LD  (_CLPS),DE
00136E E095 7A               4      LD  A,D
00136F E096 B3               4      OR  E
001370 E097 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
001372 E099 78               4      LD  A,B
001373 E09A B1               4      OR  C
001374 E09B B4               4      OR  H
001375 E09C C8              11      RET Z       ;RET BCH==0 => CF=0
                                
001376 E09D CDFDE5          17      CALL    GNCLX
001379 E0A0 D8              11      RET C
00137A E0A1 7C               4      LD  A,H     ;
00137B E0A2 25               4      DEC H       ;
00137C E0A3 B7               4      OR  A       ;DEC BCH
00137D E0A4 2001            12      JR  NZ,RWX2     ;
00137F E0A6 0B               6      DEC BC      ;
       E0A7                     RWX2:
001380 E0A7 CDAADE          17      CALL    ENDCL
001383 E0AA 38E5            12      JR  C,RWX1
       E0AC                     SCF_RET:
001385 E0AC 37               4      SCF
001386 E0AD C9              10      RET
                                
       E0AE                     DSKF:
001387 E0AE 110000          10      LD  DE,0
       E0AF                     MAXCLP  EQU $-2
00138A E0B1 2AACF0          16      LD  HL,(_FAKEFREE)
00138D E0B4 7C               4      LD  A,H
00138E E0B5 B5               4      OR  L
00138F E0B6 2803            12      JR  Z,DSKF1
001391 E0B8 110100          10      LD  DE,1
       E0BB                     DSKF1:
001394 E0BB D5              11      PUSH    DE
001395 E0BC CDF7F0          17      CALL    _GNCL
001398 E0BF 380C            12      JR  C,POPSCF
00139A E0C1 7A               4      LD  A,D
00139B E0C2 B3               4      OR  E
00139C E0C3 2001            12      JR  NZ,DSKF2
00139E E0C5 23               6      INC HL
       E0C6                     DSKF2:
00139F E0C6 D1              10      POP DE
0013A0 E0C7 1B               6      DEC DE
0013A1 E0C8 7A               4      LD  A,D
0013A2 E0C9 B3               4      OR  E
0013A3 E0CA 20EF            12      JR  NZ,DSKF1
0013A5 E0CC C9              10      RET
                                
       E0CD                     POPSCF:
0013A6 E0CD F1              10      POP AF
0013A7 E0CE 37               4      SCF
0013A8 E0CF C9              10      RET
                                
       E0D0                     SETTMS:
0013A9 E0D0 FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
0013AC E0D3 3C               4      INC A
0013AD E0D4 C0              11      RET NZ      ;ファイルが更新されていない
       E0D5                     SETTMSX:            ;FCBに日付時刻をセットする
0013AE E0D5 CD13D8          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
0013B1 E0D8 CB25             8      SLA L       ;   *2
0013B3 E0DA CB25             8      SLA L       ;   *4
0013B5 E0DC 29              11      ADD HL,HL       ;*2 *8
0013B6 E0DD 29              11      ADD HL,HL       ;*4 *16
0013B7 E0DE 29              11      ADD HL,HL       ;*8 *32
0013B8 E0DF 7A               4      LD  A,D
0013B9 E0E0 0F               4      RRCA            ;bit.0->7->->->0->C
0013BA E0E1 E61F             7      AND 01FH
0013BC E0E3 B5               4      OR  L
0013BD E0E4 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
0013C0 E0E7 FD7417          19      LD  (IY+23),H
                                
0013C3 E0EA CD13D8          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
0013C6 E0ED 0144F8          10      LD  BC,0-1980
0013C9 E0F0 09              11      ADD HL,BC
0013CA E0F1 65               4      LD  H,L
                                
0013CB E0F2 7A               4      LD  A,D
0013CC E0F3 87               4      ADD A,A     ;*2
0013CD E0F4 87               4      ADD A,A     ;*4
0013CE E0F5 87               4      ADD A,A     ;*8
0013CF E0F6 87               4      ADD A,A     ;*16
0013D0 E0F7 6F               4      LD  L,A
0013D1 E0F8 29              11      ADD HL,HL       ;*32
0013D2 E0F9 7D               4      LD  A,L
0013D3 E0FA B3               4      OR  E
0013D4 E0FB FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
0013D7 E0FE FD7415          19      LD  (IY+21),H
0013DA E101 C9              10      RET
                                ;(16)
       E102                     PUSHRR:
0013DB E102 322EE4          13      LD  (SETSEQ_SWC_RND),A
0013DE E105 2240E4          16      LD  (SETSEQ_SWC_SEQ_RR),HL
0013E1 E108 CD28E1          17      CALL    GET_RR_AHL
0013E4 E10B 220FF0          16      LD  (RR_BUF_HL),HL
0013E7 E10E 3211F0          13      LD  (RR_BUF_A),A
0013EA E111 C9              10      RET
                                ;(14)
       E112                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
0013EB E112 87               4      ADD A,A     ;in BHLA => out AHL
0013EC E113 ED6A            15      ADC HL,HL
0013EE E115 CB18             8      RR  B
0013F0 E117 B7               4      OR  A
0013F1 E118 78               4      LD  A,B     ;ここでフラグは変化しない
0013F2 E119 C8              11      RET Z
0013F3 E11A 2C               4      INC L       ;INC AHL
0013F4 E11B C0              11      RET NZ      ;
0013F5 E11C 24               4      INC H       ;
0013F6 E11D C0              11      RET NZ      ;
0013F7 E11E 3C               4      INC A       ;
0013F8 E11F C9              10      RET
                                ;(18)
       E120                     INIT_RND:
0013F9 E120 3ECD             7      LD  A,0CDH      ;CALL ????
0013FB E122 213FE1          10      LD  HL,POPRR
0013FE E125 CD02E1          17      CALL    PUSHRR
       E128                     GET_RR_AHL:
001401 E128 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001404 E12B FD6622          19      LD  H,(IY+34)   ;
001407 E12E FD7E23          19      LD  A,(IY+35)   ;
00140A E131 C9              10      RET
                                ;(10)
       E132                     SET_RR_AHL:
00140B E132 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
00140E E135 FD7422          19      LD  (IY+34),H   ;
001411 E138 FD7723          19      LD  (IY+35),A   ;
001414 E13B C9              10      RET
                                ;(17)
       E13C                     SETSEQ:
001415 E13C CD61E1          17      CALL    SETSEQ1
       E13F                     POPRR:
001418 E13F F5              11      PUSH    AF
001419 E140 E5              11      PUSH    HL
00141A E141 2A0FF0          16      LD  HL,(RR_BUF_HL)
00141D E144 3A11F0          13      LD  A,(RR_BUF_A)
001420 E147 CD32E1          17      CALL    SET_RR_AHL
001423 E14A E1              10      POP HL
001424 E14B F1              10      POP AF
001425 E14C C9              10      RET
                                ;(20)
       E14D                     GET_RR_BCDE:            ;BCDE=Random record
001426 E14D FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
001429 E150 FD5622          19      LD  D,(IY+34)
00142C E153 FD4E23          19      LD  C,(IY+35)
00142F E156 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
001431 E158 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001435 E15C C0              11      RET NZ
001436 E15D FD4624          19      LD  B,(IY+36)
001439 E160 C9              10      RET
                                
       E161                     SETSEQ1:
00143A E161 F5              11      PUSH    AF
00143B E162 E5              11      PUSH    HL      ;AHL=Random record
00143C E163 CD28E1          17      CALL    GET_RR_AHL
00143F E166 47               4      LD  B,A     ;AHL→HLA
001440 E167 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
001441 E168 6C               4      LD  L,H     ;(IY+34)
001442 E169 60               4      LD  H,B     ;(IY+35)
001443 E16A 0600             7      LD  B,0
                                
001445 E16C CD12E1          17      CALL    GET_CPM_R_SIZE
                                
001448 E16F 29              11      ADD HL,HL
001449 E170 CB3D             8      SRL L       ;L=L/2
00144B E172 FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
00144E E175 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
001451 E178 E1              10      POP HL
001452 E179 F1              10      POP AF
001453 E17A C9              10      RET
                                
                                ;(23)
       E17B                     RBXEND:             ;レコード数だけランダムレコードを進める
001454 E17B 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       E17C                     RBSIZE  EQU $-2
001457 E17E CD28E1          17      CALL    GET_RR_AHL
00145A E181 19              11      ADD HL,DE
00145B E182 CE00             7      ADC A,0
00145D E184 CD32E1          17      CALL    SET_RR_AHL
001460 E187 EB               4      EX  DE,HL       ;HL=進めるレコード数
001461 E188 D0              11      RET NC
001462 E189 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001466 E18D C0              11      RET NZ
001467 E18E FD3424          23      INC (IY+36)
00146A E191 C9              10      RET
       E192                     FILE_E:
                                
       DD3C                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       DD3C                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       DD3C                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       DD3C                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       DD3C                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E192                     _SYS26:     ;(BDOS)ランダムブロック書き込み
00146B E192 AF               4      XOR A
00146C E193 327BE4          13      LD  (DRDN1),A   ;NOP
00146F E196 227CE1          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
001472 E199 225DF0          16      LD  (LEFTX),HL
001475 E19C CD85DC          17      CALL    SETDRV
                                
001478 E19F CD05E3          17      CALL    RBX0
00147B E1A2 DA2FE2          10      JP  C,RBWERR
00147E E1A5 CD0EE0          17      CALL    WOPEN
001481 E1A8 DA2FE2          10      JP  C,RBWERR
001484 E1AB 7C               4      LD  A,H
001485 E1AC B5               4      OR  L
001486 E1AD CA28E2          10      JP  Z,RBW1
                                
001489 E1B0 2B               6      DEC HL
                                
00148A E1B1 CD4DE1          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
00148D E1B4 19              11      ADD HL,DE       ;BCHL=HL+BCDE
00148E E1B5 3001            12      JR  NC,S26X1    ;
001490 E1B7 03               6      INC BC      ;
       E1B8                     S26X1:
001491 E1B8 CD79E0          17      CALL    RWXR
001494 E1BB DC1FE0          17      CALL    C,WRDFX
001497 E1BE DA2FE2          10      JP  C,RBWERR
                                
00149A E1C1 CD34E3          17      CALL    RBX2
00149D E1C4 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
00149F E1C6 CD53E3          17      CALL    RBXA
0014A2 E1C9 3864            12      JR  C,RBWERR
0014A4 E1CB EB               4      EX  DE,HL
0014A5 E1CC C5              11      PUSH    BC
0014A6 E1CD EDB0                    LDIR
0014A8 E1CF 225FF0          16      LD  (DTAX),HL
                                
0014AB E1D2 CDB0DF          17      CALL    WTDB        ;バッファデータは更新された
                                
0014AE E1D5 2A5DF0          16      LD  HL,(LEFTX)
0014B1 E1D8 D1              10      POP DE
0014B2 E1D9 ED52            15      SBC HL,DE
0014B4 E1DB 225DF0          16      LD  (LEFTX),HL
0014B7 E1DE 2831            12      JR  Z,RBWEND
                                
       E1E0                     RBWB:
0014B9 E1E0 CD88E3          17      CALL    RBXB
0014BC E1E3 2814            12      JR  Z,RBWC
       E1E5                     RBWB1:
0014BE E1E5 C5              11      PUSH    BC
0014BF E1E6 D5              11      PUSH    DE
0014C0 E1E7 CD8DDE          17      CALL    CLUSTX
0014C3 E1EA CDACE3          17      CALL    DWTC
0014C6 E1ED D1              10      POP DE
0014C7 E1EE C1              10      POP BC
0014C8 E1EF D4FDE5          17      CALL    NC,GNCLX
0014CB E1F2 383B            12      JR  C,RBWERR
0014CD E1F4 10EF            13      DJNZ    RBWB1
0014CF E1F6 CDFCE3          17      CALL    DRW_FLUSH
       E1F9                     RBWC:
0014D2 E1F9 CDA0E3          17      CALL    RBXC
0014D5 E1FC 2813            12      JR  Z,RBWEND
0014D7 E1FE C5              11      PUSH    BC
0014D8 E1FF CD8DDE          17      CALL    CLUSTX
0014DB E202 CD7AE4          17      CALL    DRDN
0014DE E205 C1              10      POP BC
0014DF E206 3827            12      JR  C,RBWERR
0014E1 E208 ED5B7EF1        20      LD  DE,(_DTBUF)
0014E5 E20C EDB0                    LDIR
0014E7 E20E CDB0DF          17      CALL    WTDB        ;バッファデータは更新された
       E211                     RBWEND:
0014EA E211 CD7BE1          17      CALL    RBXEND
                                
0014ED E214 CD14E3          17      CALL    RBX1
0014F0 E217 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
0014F2 E219 CD4DE1          17      CALL    GET_RR_BCDE ;BCDE=Random record
0014F5 E21C FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
0014F8 E21F FD7211          19      LD  (IY+17),D   ;
0014FB E222 FD7112          19      LD  (IY+18),C   ;
0014FE E225 FD7013          19      LD  (IY+19),B   ;
       E228                     RBW1:
001501 E228 FDE1            14      POP IY
001503 E22A C1              10      POP BC
001504 E22B D1              10      POP DE
001505 E22C E1              10      POP HL
       E22D                     DD_NUL:
001506 E22D AF               4      XOR A
       E22E                     DRDF0:
       E22E                     DWTF0:
001507 E22E C9              10      RET
                                
       E22F                     RBWERR:
001508 E22F FDE5            15      PUSH    IY
00150A E231 D1              10      POP DE
00150B E232 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
00150D E234 CD48D4          17      CALL    BDOS0
       E237                     RBRERR1:
001510 E237 3E01             7      LD  A,001H
       E239                     RBRERR2:
001512 E239 FDE1            14      POP IY
001514 E23B C1              10      POP BC
001515 E23C D1              10      POP DE
001516 E23D E1              10      POP HL
001517 E23E 37               4      SCF
001518 E23F 210000          10      LD  HL,0
00151B E242 C9              10      RET
                                
       E243                     RBRERR:
00151C E243 3EFF             7      LD  A,0FFH
00151E E245 18F2            12      JR  RBRERR2
                                
       E247                     RBRFL:
001520 E247 3E00             7  RBRFLP: LD  A,000H
001522 E249 FE0D             7      CP  00DH
001524 E24B 2005            12      JR  NZ,RBRFL1
001526 E24D D5              11      PUSH    DE
001527 E24E 1E0A             7      LD  E,00AH
001529 E250 1805            12      JR  RBRFL2
       E252                     RBRFL1:
00152B E252 D5              11      PUSH    DE
00152C E253 CD09F0          17      CALL    _SYS07
00152F E256 5F               4      LD  E,A
       E257                     RBRFL2:
001530 E257 CDCDF0          17      CALL    _PRINT
001533 E25A 7B               4      LD  A,E
001534 E25B D1              10      POP DE
001535 E25C 3248E2          13      LD  (RBRFLP+1),A
001538 E25F C9              10      RET
                                
                                                ;Read random block
       E260                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001539 E260 225DF0          16      LD  (LEFTX),HL
00153C E263 CD85DC          17      CALL    SETDRV
                                
00153F E266 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
001543 E26A C2F3E2          10      JP  NZ,RBRDIR   ;ディレクトリ
001546 E26D CD05E3          17      CALL    RBX0
001549 E270 DA43E2          10      JP  C,RBRERR
00154C E273 CD14E3          17      CALL    RBX1
00154F E276 D42CE3          17      CALL    NC,RBX1R
001552 E279 DA37E2          10      JP  C,RBRERR1
001555 E27C EB               4      EX  DE,HL
001556 E27D ED52            15      SBC HL,DE       ;CP 00HL,BCDE
001558 E27F 19              11      ADD HL,DE
001559 E280 79               4      LD  A,C
00155A E281 DE00             7      SBC A,0
00155C E283 78               4      LD  A,B
00155D E284 DE00             7      SBC A,0
00155F E286 3801            12      JR  C,RBR1
001561 E288 EB               4      EX  DE,HL
       E289                     RBR1:
001562 E289 9F               4      SBC A,A
001563 E28A E601             7      AND 1
001565 E28C 32F1E2          13      LD  (RBRA_SWC),A
                                
001568 E28F 7C               4      LD  A,H
001569 E290 B5               4      OR  L
00156A E291 2857            12      JR  Z,RBREND0
                                
00156C E293 227CE1          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
00156F E296 225DF0          16      LD  (LEFTX),HL
                                
001572 E299 CD34E3          17      CALL    RBX2
001575 E29C 2819            12      JR  Z,RBRB
001577 E29E CD53E3          17      CALL    RBXA
00157A E2A1 DA43E2          10      JP  C,RBRERR
00157D E2A4 C5              11      PUSH    BC
00157E E2A5 EDB0                    LDIR
001580 E2A7 ED535FF0        20      LD  (DTAX),DE
001584 E2AB 2A5DF0          16      LD  HL,(LEFTX)
001587 E2AE D1              10      POP DE
001588 E2AF A7               4      AND A
001589 E2B0 ED52            15      SBC HL,DE
00158B E2B2 225DF0          16      LD  (LEFTX),HL
00158E E2B5 2830            12      JR  Z,RBREND
                                
       E2B7                     RBRB:
001590 E2B7 CD88E3          17      CALL    RBXB
001593 E2BA 2815            12      JR  Z,RBRC
       E2BC                     RBRB1:
001595 E2BC C5              11      PUSH    BC
001596 E2BD D5              11      PUSH    DE
001597 E2BE CD8DDE          17      CALL    CLUSTX
00159A E2C1 CDB2E3          17      CALL    DRDC
00159D E2C4 D1              10      POP DE
00159E E2C5 C1              10      POP BC
00159F E2C6 D4FDE5          17      CALL    NC,GNCLX
0015A2 E2C9 DA43E2          10      JP  C,RBRERR
0015A5 E2CC 10EE            13      DJNZ    RBRB1
0015A7 E2CE CDFCE3          17      CALL    DRW_FLUSH
       E2D1                     RBRC:
0015AA E2D1 CDA0E3          17      CALL    RBXC
0015AD E2D4 2811            12      JR  Z,RBREND
0015AF E2D6 C5              11      PUSH    BC
0015B0 E2D7 CD8DDE          17      CALL    CLUSTX
0015B3 E2DA CD5EE4          17      CALL    DRDX
0015B6 E2DD C1              10      POP BC
0015B7 E2DE DA43E2          10      JP  C,RBRERR
0015BA E2E1 EB               4      EX  DE,HL
0015BB E2E2 2A7EF1          16      LD  HL,(_DTBUF)
0015BE E2E5 EDB0                    LDIR
       E2E7                     RBREND:
0015C0 E2E7 CD7BE1          17      CALL    RBXEND
       E2EA                     RBREND0:
0015C3 E2EA FDE1            14      POP IY
0015C5 E2EC C1              10      POP BC
0015C6 E2ED D1              10      POP DE
0015C7 E2EE F1              10      POP AF  ;(HL)
0015C8 E2EF AF               4      XOR A
0015C9 E2F0 3E00             7      LD  A,000H
       E2F1                     RBRA_SWC    EQU $-1
0015CB E2F2 C9              10      RET
                                
       E2F3                     RBRDIR:
0015CC E2F3 FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0015CF E2F6 FD661B          19      LD  H,(IY+27)
0015D2 E2F9 CDCCDE          17      CALL    CHDIR
0015D5 E2FC AF               4      XOR A
0015D6 E2FD 67               4      LD  H,A
0015D7 E2FE 6F               4      LD  L,A
0015D8 E2FF 3C               4      INC A
0015D9 E300 32F1E2          13      LD  (RBRA_SWC),A
0015DC E303 18E5            12      JR  RBREND0
                                ;(15)
       E305                     RBX0:
0015DE E305 2A8AF0          16      LD  HL,(_DTA)
0015E1 E308 225FF0          16      LD  (DTAX),HL
0015E4 E30B 2A5DF0          16      LD  HL,(LEFTX)
0015E7 E30E FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0015EA E311 D6FD             7      SUB 0FDH
0015EC E313 C9              10      RET
                                
       E314                     RBX1:               ;ファイルサイズとランダムレコードを比べる
0015ED E314 E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
0015EE E315 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
0015F1 E318 FD6611          19      LD  H,(IY+17)   ;
0015F4 E31B FD7E12          19      LD  A,(IY+18)   ;
                                
0015F7 E31E CD4DE1          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0015FA E321 A7               4      AND A
0015FB E322 ED52            15      SBC HL,DE
0015FD E324 99               4      SBC A,C
0015FE E325 4F               4      LD  C,A
0015FF E326 FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
001602 E329 98               4      SBC A,B
001603 E32A D1              10      POP DE
001604 E32B C9              10      RET
       E32C                     RBX1R:              ;(8)
001605 E32C 47               4      LD  B,A
001606 E32D B1               4      OR  C
001607 E32E EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
001608 E32F B2               4      OR  D
001609 E330 B3               4      OR  E
00160A E331 C0              11      RET NZ
00160B E332 37               4      SCF
00160C E333 C9              10      RET
                                
       E334                     RBX2:               ;Cluster settings
00160D E334 FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001610 E337 FD4E23          19      LD  C,(IY+35)
001613 E33A 0600             7      LD  B,0
001615 E33C FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001619 E340 2003            12      JR  NZ,RBX3
00161B E342 FD4624          19      LD  B,(IY+36)
       E345                     RBX3:
00161E E345 CD79E0          17      CALL    RWXR
001621 E348 3A6AE3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001624 E34B 3D               4      DEC A
001625 E34C FDA622          19      AND (IY+34)
001628 E34F FDB621          19      OR  (IY+33)
00162B E352 C9              10      RET
                                
       E353                     RBXA:
00162C E353 C5              11      PUSH    BC
00162D E354 D5              11      PUSH    DE
00162E E355 CD8DDE          17      CALL    CLUSTX
001631 E358 CD5EE4          17      CALL    DRDX
001634 E35B D1              10      POP DE
001635 E35C C1              10      POP BC
001636 E35D D4FDE5          17      CALL    NC,GNCLX
001639 E360 D8              11      RET C
00163A E361 ED53FEF1        20      LD  (_CLPS),DE
                                
00163E E365 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
001641 E368 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       E369                     SECSZ   EQU $-2
       E36A                     SECSZ_H EQU $-1
001644 E36B 7C               4      LD  A,H
001645 E36C 3D               4      DEC A       ;1024=3 / 512=1
001646 E36D FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
001649 E370 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
00164A E371 ED42            15      SBC HL,BC       ;残りを計算
                                
00164C E373 ED5B5DF0        20      LD  DE,(LEFTX)
001650 E377 ED52            15      SBC HL,DE       ;CP HL,DE
001652 E379 19              11      ADD HL,DE       ;
001653 E37A 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
001655 E37C EB               4      EX  DE,HL
       E37D                     RBXA1:
001656 E37D E5              11      PUSH    HL
001657 E37E 2A7EF1          16      LD  HL,(_DTBUF)
00165A E381 09              11      ADD HL,BC
00165B E382 ED5B5FF0        20      LD  DE,(DTAX)
00165F E386 C1              10      POP BC
001660 E387 C9              10      RET
                                
       E388                     RBXB:
001661 E388 2A5FF0          16      LD  HL,(DTAX)
001664 E38B ED5BFEF1        20      LD  DE,(_CLPS)
001668 E38F 3A5EF0          13      LD  A,(LEFTX+1)
00166B E392 47               4      LD  B,A
00166C E393 3A6AE3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E396                     RBXB1:
00166F E396 1F               4      RRA     ;->CF
001670 E397 3804            12      JR  C,RBXB2
001672 E399 CB38             8      SRL B   ;B=B/2
001674 E39B 18F9            12      JR  RBXB1
       E39D                     RBXB2:
001676 E39D 78               4      LD  A,B
001677 E39E B7               4      OR  A
001678 E39F C9              10      RET
                                ;(12)
       E3A0                     RBXC:
001679 E3A0 ED4B5DF0        20      LD  BC,(LEFTX)
00167D E3A4 3A6AE3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001680 E3A7 3D               4      DEC A
001681 E3A8 A0               4      AND B
001682 E3A9 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
001683 E3AA B1               4      OR  C
001684 E3AB C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E3AC                     DWTC:
001685 E3AC E5              11      PUSH    HL
001686 E3AD 2196E7          10      LD  HL,DWT24B
001689 E3B0 1804            12      JR  DWTC1
       E3B2                     DRDC:
00168B E3B2 E5              11      PUSH    HL
00168C E3B3 2188E7          10      LD  HL,DRD24B
       E3B6                     DWTC1:
00168F E3B6 2210E4          16      LD  (DRWF_MODE),HL
001692 E3B9 E1              10      POP HL
001693 E3BA 3A00E4          13      LD  A,(DRWF_B)
001696 E3BD B7               4      OR  A
001697 E3BE 200F            12      JR  NZ,DRDC1
       E3C0                     SAVE_DRWC:
001699 E3C0 0601             7      LD  B,1
00169B E3C2 ED43FFE3        20      LD  (DRWF_C),BC
00169F E3C6 ED5306E4        20      LD  (DRWF_E),DE
0016A3 E3CA 2209E4          16      LD  (DRWF_HL),HL
0016A6 E3CD 1820            12      JR  INC_HL_DRWC
       E3CF                     DRDC1:
0016A8 E3CF E5              11      PUSH    HL
0016A9 E3D0 2106E4          10      LD  HL,DRWF_E
0016AC E3D3 86               7      ADD A,(HL)
0016AD E3D4 F5              11      PUSH    AF
0016AE E3D5 BB               4      CP  E
0016AF E3D6 201D            12      JR  NZ,DRDC2
0016B1 E3D8 F1              10      POP AF
0016B2 E3D9 23               6      INC HL
0016B3 E3DA 7E               7      LD  A,(HL)
0016B4 E3DB CE00             7      ADC A,0
0016B6 E3DD F5              11      PUSH    AF
0016B7 E3DE BA               4      CP  D
0016B8 E3DF 2014            12      JR  NZ,DRDC2
0016BA E3E1 F1              10      POP AF
0016BB E3E2 3AFFE3          13      LD  A,(DRWF_C)
0016BE E3E5 CE00             7      ADC A,0
0016C0 E3E7 B9               4      CP  C
0016C1 E3E8 200C            12      JR  NZ,DRDC3
0016C3 E3EA 2100E4          10      LD  HL,DRWF_B
0016C6 E3ED 34              11      INC (HL)
0016C7 E3EE E1              10      POP HL
       E3EF                     INC_HL_DRWC:
0016C8 E3EF 3A6AE3          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
0016CB E3F2 84               4      ADD A,H
0016CC E3F3 67               4      LD  H,A
0016CD E3F4 C9              10      RET
       E3F5                     DRDC2:
0016CE E3F5 F1              10      POP AF
       E3F6                     DRDC3:
0016CF E3F6 CDFCE3          17      CALL    DRW_FLUSH
0016D2 E3F9 E1              10      POP HL
0016D3 E3FA 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E3FC                     DRW_FLUSH:
0016D5 E3FC C5              11      PUSH    BC
0016D6 E3FD D5              11      PUSH    DE
0016D7 E3FE 010000          10      LD  BC,0
       E3FF                     DRWF_C  EQU $-2
       E400                     DRWF_B  EQU $-1
0016DA E401 78               4      LD  A,B
0016DB E402 B7               4      OR  A
0016DC E403 280D            12      JR  Z,DRDF1
0016DE E405 110000          10      LD  DE,0
       E406                     DRWF_E  EQU $-2
       E407                     DRWF_D  EQU $-1
0016E1 E408 210000          10      LD  HL,0
       E409                     DRWF_HL EQU $-2
0016E4 E40B AF               4      XOR A
0016E5 E40C 3200E4          13      LD  (DRWF_B),A
0016E8 E40F CD88E7          17      CALL    DRD24B
       E410                     DRWF_MODE   EQU $-2
       E412                     DRDF1:
0016EB E412 D1              10      POP DE
0016EC E413 C1              10      POP BC
0016ED E414 C9              10      RET
                                
       E415                     RB_WRITE:
0016EE E415 C5              11      PUSH    BC
0016EF E416 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0016F1 E418 1803            12      JR  RBRW
       E41A                     RB_READ:
0016F3 E41A C5              11      PUSH    BC
0016F4 E41B 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       E41D                     RBRW:
0016F6 E41D 1F               4      RRA     ;AHL = AHL*128
0016F7 E41E 7C               4      LD  A,H ;AHL = AHL0/2
0016F8 E41F 1F               4      RRA     ;A
0016F9 E420 65               4      LD  H,L ;
0016FA E421 CB1C             8      RR  H   ;H
0016FC E423 2E00             7      LD  L,0 ;
0016FE E425 CB1D             8      RR  L   ;L
001700 E427 CD32E1          17      CALL    SET_RR_AHL
001703 E42A 218000          10      LD  HL,128
001706 E42D C5              11      PUSH    BC
       E42E                     SETSEQ_SWC_RND:
001707 E42E CD61E1          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
00170A E431 C1              10      POP BC
00170B E432 FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
00170F E436 FDE5            15      PUSH    IY
001711 E438 D1              10      POP DE
001712 E439 D5              11      PUSH    DE
001713 E43A CD48D4          17      CALL    BDOS0
001716 E43D FDE1            14      POP IY
001718 E43F CD3CE1          17      CALL    SETSEQ      ;SETSEQ or POPRR
       E440                     SETSEQ_SWC_SEQ_RR   EQU $-2
00171B E442 FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
00171F E446 C1              10      POP BC
001720 E447 C9              10      RET
                                
                                ;(22)
       E448                     INIT_SEQ:
001721 E448 3E01             7      LD  A,1     ;LD BC,????
001723 E44A 213CE1          10      LD  HL,SETSEQ
001726 E44D CD02E1          17      CALL    PUSHRR
       E450                     GETSEQ:
001729 E450 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
00172C E453 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
00172F E456 AF               4      XOR A
                                
001730 E457 CB25             8      SLA L   ;L=L*2
                                
001732 E459 CB3C             8      SRL H   ;HL=HL/2
001734 E45B CB1D             8      RR  L   ;
001736 E45D C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E45E                     DRDX:
001737 E45E CD9CE4          17      CALL    DRDY
00173A E461 C8              11      RET Z
00173B E462 CD82E4          17      CALL    DRDX1       ;データバッファの情報を保存
00173E E465 D8              11      RET C
00173F E466 E5              11      PUSH    HL
001740 E467 C5              11      PUSH    BC
001741 E468 D5              11      PUSH    DE
001742 E469 2A7EF1          16      LD  HL,(_DTBUF)
001745 E46C 3AC5E4          13      LD  A,(_DBS24)
001748 E46F 4F               4      LD  C,A
001749 E470 CD86E7          17      CALL    DRD24
00174C E473 DC97E4          17      CALL    C,DRDNE
       E476                     POP_DE_BC_HL_RET:
00174F E476 D1              10      POP DE
001750 E477 C1              10      POP BC
001751 E478 E1              10      POP HL
001752 E479 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E47A                     DRDN:
001753 E47A AF               4      XOR A
001754 E47B 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
001755 E47C 30E0            12      JR  NC,DRDX
       E47E                     DRDNX:
001757 E47E CD9CE4          17      CALL    DRDY
00175A E481 C8              11      RET Z
       E482                     DRDX1:
00175B E482 CDB2E4          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
00175E E485 ED53A6F0        20      LD  (_DBSEC),DE
001762 E489 79               4      LD  A,C
001763 E48A 32C5E4          13      LD  (_DBS24),A
                                
001766 E48D 3A88F0          13      LD  A,(_DRV)
001769 E490 32A5F0          13      LD  (_DBDRV),A
00176C E493 CDD9F0          17      CALL    _CHGDRV
00176F E496 D0              11      RET NC
       E497                     DRDNE:
001770 E497 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001771 E498 32A5F0          13      LD  (_DBDRV),A
001774 E49B C9              10      RET
                                
                                ;   CDE:セクタ番号
       E49C                     DRDY:
001775 E49C 3AC5E4          13      LD  A,(_DBS24)
001778 E49F B9               4      CP  C
001779 E4A0 C0              11      RET NZ
                                
00177A E4A1 E5              11      PUSH    HL
00177B E4A2 3A88F0          13      LD  A,(_DRV)
00177E E4A5 21A5F0          10      LD  HL,_DBDRV
001781 E4A8 AE               7      XOR (HL)
001782 E4A9 2005            12      JR  NZ,POP_HL_RET
                                
001784 E4AB 2AA6F0          16      LD  HL,(_DBSEC)
001787 E4AE ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E4B0                     POP_HL_RET:
001789 E4B0 E1              10      POP HL
00178A E4B1 C9              10      RET
                                
       E4B2                     DWTX:
00178B E4B2 3AA4F0          13      LD  A,(_WTDBF)
00178E E4B5 B7               4      OR  A
00178F E4B6 C8              11      RET Z
001790 E4B7 AF               4      XOR A
001791 E4B8 32A4F0          13      LD  (_WTDBF),A
                                
001794 E4BB E5              11      PUSH    HL
001795 E4BC C5              11      PUSH    BC
001796 E4BD D5              11      PUSH    DE
001797 E4BE 3AA5F0          13      LD  A,(_DBDRV)
00179A E4C1 CDD9F0          17      CALL    _CHGDRV
00179D E4C4 0E00             7      LD  C,0
       E4C5                     _DBS24  EQU $-1
00179F E4C6 ED5BA6F0        20      LD  DE,(_DBSEC)
0017A3 E4CA 2A7EF1          16      LD  HL,(_DTBUF)
0017A6 E4CD D494E7          17      CALL    NC,DWT24
       E4D0                     POP_DE_BC_HL_RET2:
0017A9 E4D0 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E4D2                     RDFATX:
0017AB E4D2 E5              11      PUSH    HL
0017AC E4D3 3A88F0          13      LD  A,(_DRV)
0017AF E4D6 21AAF0          10      LD  HL,_FATDRV
0017B2 E4D9 AE               7      XOR (HL)
0017B3 E4DA 28D4            12      JR  Z,POP_HL_RET
                                
0017B5 E4DC C5              11      PUSH    BC
0017B6 E4DD D5              11      PUSH    DE
0017B7 E4DE DDE5            15      PUSH    IX
0017B9 E4E0 CDFCE4          17      CALL    WTFATX
0017BC E4E3 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
0017BE E4E5 AF               4      XOR A
0017BF E4E6 32ABF0          13      LD  (_FATIX),A
0017C2 E4E9 3A88F0          13      LD  A,(_DRV)
0017C5 E4EC 32AAF0          13      LD  (_FATDRV),A
0017C8 E4EF CDE5F0          17      CALL    _RDFAT
       E4F2                     RDFATE2:
0017CB E4F2 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
0017CD E4F4 9F               4      SBC A,A     ;A=0xFF
0017CE E4F5 32AAF0          13      LD  (_FATDRV),A
       E4F8                     POP_IX_DE_BC_HL_RET:
0017D1 E4F8 DDE1            14      POP IX
0017D3 E4FA 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E4FC                     WTFATX:
0017D5 E4FC 3AA2F0          13      LD  A,(_WTFATF)
0017D8 E4FF B7               4      OR  A
0017D9 E500 C8              11      RET Z
0017DA E501 AF               4      XOR A
0017DB E502 32A2F0          13      LD  (_WTFATF),A
                                
0017DE E505 E5              11      PUSH    HL
0017DF E506 3AAAF0          13      LD  A,(_FATDRV)
0017E2 E509 21A5F0          10      LD  HL,_DBDRV
0017E5 E50C AE               7      XOR (HL)
0017E6 E50D CCB2E4          17      CALL    Z,DWTX
0017E9 E510 389E            12      JR  C,POP_HL_RET
0017EB E512 C5              11      PUSH    BC
0017EC E513 D5              11      PUSH    DE
0017ED E514 DDE5            15      PUSH    IX
0017EF E516 CDA5E7          17      CALL    FATSETUP
0017F2 E519 D496E7          17      CALL    NC,DWT24B
0017F5 E51C 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E51E                     N16CL1:
0017F7 E51E 7A               4      LD  A,D
0017F8 E51F B3               4      OR  E
0017F9 E520 37               4      SCF
0017FA E521 C8              11      RET Z
                                
0017FB E522 7A               4      LD  A,D
0017FC E523 1807            12      JR  NCL1X
       E525                     NCL1:
0017FE E525 7A               4      LD  A,D
0017FF E526 B3               4      OR  E
001800 E527 37               4      SCF
001801 E528 C8              11      RET Z
                                
001802 E529 7A               4      LD  A,D
001803 E52A CB3F             8      SRL A   ;/2
       E52C                     NCL1X:
001805 E52C CB3F             8      SRL A   ;/2
                                
001807 E52E E5              11      PUSH    HL
001808 E52F 324EE5          13      LD  (NCLPAT_FATIX),A    ;_FATIX
00180B E532 2AAAF0          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
00180E E535 BC               4      CP  H
00180F E536 3A88F0          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001812 E539 324DE5          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001815 E53C 2005            12      JR  NZ,NCL2     ;FATIXが違う
001817 E53E BD               4      CP  L
001818 E53F 2002            12      JR  NZ,NCL2     ;ドライブが違う
00181A E541 E1              10      POP HL
00181B E542 C9              10      RET
       E543                     NCL2:
00181C E543 C5              11      PUSH    BC
00181D E544 D5              11      PUSH    DE
00181E E545 DDE5            15      PUSH    IX
001820 E547 CDFCE4          17      CALL    WTFATX
001823 E54A 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
001825 E54C 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E54E                     NCLPAT_FATIX    EQU $-1
       E54D                     NCLPAT_FATDRV   EQU $-2
001828 E54F ED43AAF0        20      LD  (_FATDRV),BC
00182C E553 CD7AE7          17      CALL    RDFATS
00182F E556 189A            12      JR  RDFATE2
                                
       E558                     NCL3:
001831 E558 CB9A             8      RES 3,D
001833 E55A CB92             8      RES 2,D
001835 E55C 6B               4      LD  L,E
001836 E55D 62               4      LD  H,D
001837 E55E CB3C             8      SRL H   ;
001839 E560 CB1D             8      RR  L   ;HLA=HLA/2
00183B E562 1F               4      RRA     ;
00183C E563 F5              11      PUSH    AF
00183D E564 3AABF0          13      LD  A,(_FATIX)
001840 E567 0F               4      RRCA
001841 E568 300B            12      JR  NC,NCL3X1
001843 E56A 3A6AE3          13      LD  A,(SECSZ_H)
001846 E56D FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
001848 E56F 2004            12      JR  NZ,NCL3X1
00184A E571 010002          10      LD  BC,512
00184D E574 09              11      ADD HL,BC
       E575                     NCL3X1:
00184E E575 F1              10      POP AF
00184F E576 ED4B7CF1        20      LD  BC,(_FATBF)
001853 E57A 19              11      ADD HL,DE
001854 E57B 09              11      ADD HL,BC
001855 E57C 17               4      RLA
001856 E57D C9              10      RET
                                
       E57E                     GNCL:
001857 E57E CD25E5          17      CALL    NCL1        ;GET NEXT CLUSTER
00185A E581 D8              11      RET C
00185B E582 C5              11      PUSH    BC
00185C E583 E5              11      PUSH    HL
00185D E584 CD58E5          17      CALL    NCL3
001860 E587 3809            12      JR  C,GNC1
001862 E589 5E               7      LD  E,(HL)
001863 E58A 23               6      INC HL
001864 E58B 7E               7      LD  A,(HL)
001865 E58C E60F             7      AND 00FH
001867 E58E 57               4      LD  D,A
001868 E58F E1              10      POP HL
001869 E590 C1              10      POP BC
00186A E591 C9              10      RET
       E592                     GNC1:
00186B E592 7E               7      LD  A,(HL)
00186C E593 23               6      INC HL
00186D E594 56               7      LD  D,(HL)
00186E E595 0604             7      LD  B,4
       E597                     GNC1L:
001870 E597 CB3A             8      SRL D   ;DA=DA/2
001872 E599 1F               4      RRA     ;
001873 E59A 10FB            13      DJNZ    GNC1L
                                
001875 E59C 5F               4      LD  E,A
001876 E59D E1              10      POP HL
001877 E59E C1              10      POP BC
001878 E59F A7               4      AND A
001879 E5A0 C9              10      RET
                                
       E5A1                     SNCL:
00187A E5A1 CD25E5          17      CALL    NCL1
00187D E5A4 D8              11      RET C
                                ;               SET NEXT CLUSTER
00187E E5A5 E5              11      PUSH    HL
00187F E5A6 C5              11      PUSH    BC
001880 E5A7 D5              11      PUSH    DE
001881 E5A8 E5              11      PUSH    HL
001882 E5A9 CD58E5          17      CALL    NCL3
001885 E5AC D1              10      POP DE
                                ;CF=ODD
001886 E5AD 7E               7      LD  A,(HL)
001887 E5AE 73               7      LD  (HL),E
001888 E5AF 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
00188A E5B1 23               6      INC HL
00188B E5B2 ED67            18      RRD     ;M={A[3:0],E[3:0]}
00188D E5B4 7A               4      LD  A,D
00188E E5B5 1804            12      JR  SNC11
       E5B7                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
001890 E5B7 ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001892 E5B9 23               6      INC HL
001893 E5BA 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E5BB                     SNC11:
001894 E5BB ED6F            18      RLD     ;M={M[7:4],D[3:0]}
001896 E5BD B7               4      OR  A
001897 E5BE D1              10      POP DE
001898 E5BF C1              10      POP BC
001899 E5C0 E1              10      POP HL
       E5C1                     FAT_CHANGED:
00189A E5C1 3EFF             7      LD  A,0FFH
00189C E5C3 32A2F0          13      LD  (_WTFATF),A
00189F E5C6 C9              10      RET
                                
       E5C7                     N16CL3:
0018A0 E5C7 C5              11      PUSH    BC
0018A1 E5C8 6B               4      LD  L,E
0018A2 E5C9 7A               4      LD  A,D
0018A3 E5CA E601             7      AND 1
0018A5 E5CC 67               4      LD  H,A
0018A6 E5CD 29              11      ADD HL,HL
0018A7 E5CE ED4B7CF1        20      LD  BC,(_FATBF)
0018AB E5D2 09              11      ADD HL,BC
0018AC E5D3 C1              10      POP BC
0018AD E5D4 C9              10      RET
                                
       E5D5                     GNCL16:
0018AE E5D5 CD1EE5          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
0018B1 E5D8 D8              11      RET C
0018B2 E5D9 E5              11      PUSH    HL
0018B3 E5DA CDC7E5          17      CALL    N16CL3
0018B6 E5DD 5E               7      LD  E,(HL)
0018B7 E5DE 23               6      INC HL
0018B8 E5DF 56               7      LD  D,(HL)
0018B9 E5E0 E1              10      POP HL
0018BA E5E1 C9              10      RET
                                
       E5E2                     SNCL16:
0018BB E5E2 CD1EE5          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
0018BE E5E5 D8              11      RET C
0018BF E5E6 D5              11      PUSH    DE
0018C0 E5E7 E5              11      PUSH    HL
0018C1 E5E8 CDC7E5          17      CALL    N16CL3
0018C4 E5EB D1              10      POP DE      ;HL
0018C5 E5EC 73               7      LD  (HL),E
0018C6 E5ED 23               6      INC HL
0018C7 E5EE 72               7      LD  (HL),D
0018C8 E5EF 6B               4      LD  L,E
0018C9 E5F0 62               4      LD  H,D
0018CA E5F1 D1              10      POP DE
0018CB E5F2 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E5F4                     NEXTX:
0018CD E5F4 3E00             7      LD  A,0 ;自己書き換え
       E5F5                     _SECPS  EQU $-1
0018CF E5F6 3C               4      INC A
0018D0 E5F7 E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E5F8                     _NCPAT  EQU $-1
0018D2 E5F9 32F5E5          13      LD  (_SECPS),A
0018D5 E5FC C9              10      RET
                                
       E5FD                     GNCLX:
0018D6 E5FD CDF4E5          17      CALL    NEXTX
0018D9 E600 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
0018DA E601 C3F7F0          10      JP  _GNCL   ;次のクラスタを探す
                                
       E604                     RDFAT:
0018DD E604 3E80             7      LD  A,080H
0018DF E606 3270F0          13      LD  (CHECK),A
       E609                     RDFAT1:
0018E2 E609 3A88F0          13      LD  A,(_DRV)
0018E5 E60C CDAEE8          17      CALL    CHGDRVR
0018E8 E60F D8              11      RET C
0018E9 E610 DD7E12          19      LD  A,(IX+DPB_DEVICE)
0018EC E613 CB6F             8      BIT 5,A
0018EE E615 286E            12      JR  Z,RDFAT0X
0018F0 E617 2170F0          10      LD  HL,CHECK
0018F3 E61A A6               7      AND (HL)
0018F4 E61B 77               7      LD  (HL),A
0018F5 E61C 110000          10      LD  DE,0        ;BPB
0018F8 E61F 2A7CF1          16      LD  HL,(_FATBF)
0018FB E622 0E00             7      LD  C,0
0018FD E624 CD86E7          17      CALL    DRD24
001900 E627 3024            12      JR  NC,GETBPB
001902 E629 2170F0          10      LD  HL,CHECK
001905 E62C CB06            15      RLC (HL)
001907 E62E 3F               4      CCF
001908 E62F D8              11      RET C
001909 E630 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
00190D E634 3F               4      CCF         ;フロッピーディスクのFDモードを切り替える
00190E E635 DDCB0A16        23      RL  (IX+DPB_FDMODE)
001912 E639 3EFF             7      LD  A,0FFH
001914 E63B 3289F0          13      LD  (_DSK),A
001917 E63E 3A84F0          13      LD  A,(_DRIVE)
00191A E641 E603             7      AND 3
00191C E643 F680             7      OR  080H
00191E E645 6F               4      LD  L,A
00191F E646 26F0             7      LD  H,_CYL0/256
001921 E648 3EFF             7      LD  A,0FFH
001923 E64A 77               7      LD  (HL),A
001924 E64B 18BC            12      JR  RDFAT1
       E64D                     GETBPB:
001926 E64D FDE5            15      PUSH    IY
001928 E64F FD2A7CF1        20      LD  IY,(_FATBF) ;BPB
00192C E653 CDF1F0          17      CALL    _BPB2DPB
00192F E656 FDE1            14      POP IY
001931 E658 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001934 E65B 3025            12      JR  NC,GETBPBOK
001936 E65D E60F             7      AND 00FH
001938 E65F FE07             7      CP  7
00193A E661 37               4      SCF
00193B E662 C0              11      RET NZ
00193C E663 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001940 E667 21C0F1          10      LD  HL,M2D
001943 E66A 2006            12      JR  NZ,SETFDMODE
001945 E66C CD5FE7          17      CALL    CHECK1024
001948 E66F D8              11      RET C
001949 E670 2ED2             7      LD  L,M2HD-STABLE
       E672                     SETFDMODE:
00194B E672 DDE5            15      PUSH    IX
00194D E674 D1              10      POP DE
00194E E675 EDA0            16      LDI
001950 E677 EDA0            16      LDI
001952 E679 13               6      INC DE
001953 E67A 13               6      INC DE
001954 E67B 13               6      INC DE
001955 E67C 13               6      INC DE
001956 E67D 010C00          10      LD  BC,12
001959 E680 EDB0                    LDIR
       E682                     GETBPBOK:
00195B E682 CD1AE8          17      CALL    CHGDRV2
       E685                     RDFAT0X:
00195E E685 CD7AE7          17      CALL    RDFATS
001961 E688 D8              11      RET C
001962 E689 DDAE06          19      XOR (IX+DPB_FATID)
001965 E68C C8              11      RET Z
001966 E68D DD7E12          19      LD  A,(IX+DPB_DEVICE)
001969 E690 CB5F             8      BIT 3,A
00196B E692 2803            12      JR  Z,RDFAT0X1
00196D E694 CB6F             8      BIT 5,A
00196F E696 C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E697                     RDFAT0X1:
001970 E697 37               4      SCF
001971 E698 C9              10      RET
                                
       E699                     POP_HL_SCF_RET:
001972 E699 E1              10      POP HL
001973 E69A 37               4      SCF
001974 E69B C9              10      RET
                                
       E69C                     BPB2DPB:
001975 E69C FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
001978 E69F B7               4      OR  A
001979 E6A0 37               4      SCF
00197A E6A1 C0              11      RET NZ
       E6A2                     BPBOK:
00197B E6A2 FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
00197E E6A5 DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001981 E6A8 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001984 E6AB DD7700          19      LD  (IX+DPB_FATLN),A
001987 E6AE FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
00198A E6B1 DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
00198D E6B4 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001990 E6B7 FD660F          19      LD  H,(IY+15)
001993 E6BA DD750E          19      LD  (IX+DPB_FATPS),L
001996 E6BD FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001999 E6C0 FD5617          19      LD  D,(IY+23)
00199C E6C3 FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E6C6                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
00199F E6C6 19              11      ADD HL,DE
0019A0 E6C7 10FD            13      DJNZ    BPBDP1
       E6C9                     BPBDP2:
0019A2 E6C9 DD7510          19      LD  (IX+DPB_DIRPS),L
0019A5 E6CC DD7411          19      LD  (IX+DPB_DIRPS+1),H
0019A8 E6CF E5              11      PUSH    HL
                                
0019A9 E6D0 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
0019AC E6D3 FD6612          19      LD  H,(IY+18)
0019AF E6D6 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
0019B2 E6D9 B7               4      OR  A
0019B3 E6DA 28BD            12      JR  Z,POP_HL_SCF_RET
0019B5 E6DC 0606             7      LD  B,6
       E6DE                     BPBBPS1:
0019B7 E6DE 05               4      DEC B
0019B8 E6DF 0F               4      RRCA
0019B9 E6E0 30FC            12      JR  NC,BPBBPS1
       E6E2                     BPBDE1:
0019BB E6E2 29              11      ADD HL,HL
0019BC E6E3 10FD            13      DJNZ    BPBDE1
                                
0019BE E6E5 7C               4      LD  A,H
0019BF E6E6 DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
0019C2 E6E9 D1              10      POP DE      ;DPB_DIRPS
0019C3 E6EA 6C               4      LD  L,H
0019C4 E6EB 2600             7      LD  H,0
0019C6 E6ED 19              11      ADD HL,DE       ;MAXDIR
0019C7 E6EE E5              11      PUSH    HL
0019C8 E6EF FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
0019CB E6F2 CB21             8      SLA C       ;*2
0019CD E6F4 AF               4      XOR A
0019CE E6F5 47               4      LD  B,A
0019CF E6F6 ED42            15      SBC HL,BC
0019D1 E6F8 DD7514          19      LD  (IX+DPB_ADDCL),L
0019D4 E6FB DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
0019D7 E6FE D1              10      POP DE      ;DE=DPB_MAXDIR
0019D8 E6FF FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
0019DB E702 FD6614          19      LD  H,(IY+20)
                                
0019DE E705 DD7E12          19      LD  A,(IX+DPB_DEVICE)
0019E1 E708 E60F             7      AND 00FH
0019E3 E70A FE07             7      CP  7       ;フロッピー
0019E5 E70C 2019            12      JR  NZ,NOT_FD
0019E7 E70E E5              11      PUSH    HL
0019E8 E70F FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
0019EB E712 DD710D          19      LD  (IX+DPB_MAXSEC),C
0019EE E715 AF               4      XOR A
0019EF E716 CB21             8      SLA C       ;両面なのでセクタ数を２倍
0019F1 E718 0610             7      LD  B,16
       E71A                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
0019F3 E71A 29              11      ADD HL,HL
0019F4 E71B 17               4      RLA
0019F5 E71C B9               4      CP  C
0019F6 E71D 3802            12      JR  C,DIVSEC1
0019F8 E71F 91               4      SUB C
0019F9 E720 2C               4      INC L
       E721                     DIVSEC1:
0019FA E721 10F7            13      DJNZ    DIVSEC
0019FC E723 DD750C          19      LD  (IX+DPB_MAXCYL),L
0019FF E726 E1              10      POP HL  ;ここまでフロッピー専用
       E727                     NOT_FD:
001A00 E727 7C               4      LD  A,H
001A01 E728 B5               4      OR  L
001A02 E729 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001A04 E72B 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001A06 E72D 2F               4      CPL         ;A=0FFH
001A07 E72E FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001A0A E731 D8              11      RET C
001A0B E732 FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001A0E E735 FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001A11 E738 FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E73B                     BPB16BIT:
001A14 E73B ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001A16 E73D DE00             7      SBC A,0
001A18 E73F FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E742                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001A1B E742 CB18             8      RR  B       ;->CY
001A1D E744 3808            12      JR  C,BPBTC2
001A1F E746 CB3F             8      SRL A
001A21 E748 CB1C             8      RR  H       ;AHL=AHL/2
001A23 E74A CB1D             8      RR  L
001A25 E74C 18F4            12      JR  BPBTC1
       E74E                     BPBTC2:
001A27 E74E C6FF             7      ADD A,0FFH
001A29 E750 D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001A2A E751 23               6      INC HL
001A2B E752 23               6      INC HL
001A2C E753 DD7508          19      LD  (IX+DPB_MAXCL),L
001A2F E756 DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001A32 E759 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001A35 E75C DD7706          19      LD  (IX+DPB_FATID),A
       E75F                     CHECK1024:
001A38 E75F FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001A3B E762 C6FE             7      ADD A,0-2       ;>2:CF=1
001A3D E764 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001A40 E767 6F               4      LD  L,A
001A41 E768 3002            12      JR  NC,BPBFAT1
001A43 E76A F680             7      OR  080H
       E76C                     BPBFAT1:            ;ここではCF=0
001A45 E76C DD770F          19      LD  (IX+DPB_BPS),A
001A48 E76F 3A7BF1          13      LD  A,(_MAX_SEC_SZ_H)
001A4B E772 BD               4      CP  L
001A4C E773 C8              11      RET Z       ;1セクタ1024バイト
001A4D E774 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001A4E E775 C8              11      RET Z       ;1セクタ256バイト
001A4F E776 2D               4      DEC L
001A50 E777 C8              11      RET Z       ;1セクタ512バイト
001A51 E778 37               4      SCF
001A52 E779 C9              10      RET
                                
       E77A                     RDFATS:
001A53 E77A CDA5E7          17      CALL    FATSETUP
001A56 E77D D8              11      RET C
001A57 E77E CD88E7          17      CALL    DRD24B
001A5A E781 2A7CF1          16      LD  HL,(_FATBF)
001A5D E784 7E               7      LD  A,(HL)
001A5E E785 C9              10      RET
                                
       E786                     DRD24:
001A5F E786 0601             7      LD  B,1
       E788                     DRD24B:
001A61 E788 DDE5            15      PUSH    IX
001A63 E78A DD2AA8F0        20      LD  IX,(_DPB)
001A67 E78E CDEEE9          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E78F                     DRDPAT  EQU $-2
001A6A E791 DDE1            14      POP IX
001A6C E793 C9              10      RET
                                
       E794                     DWT24:
001A6D E794 0601             7      LD  B,1
       E796                     DWT24B:
001A6F E796 DDE5            15      PUSH    IX
001A71 E798 DD2AA8F0        20      LD  IX,(_DPB)
001A75 E79C CD97E9          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E79D                     DWTPAT  EQU $-2
001A78 E79F DDE1            14      POP IX
001A7A E7A1 D0              11      RET NC
001A7B E7A2 C35AF0          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E7A5                     FATSETUP:
001A7E E7A5 3AAAF0          13      LD  A,(_FATDRV)
001A81 E7A8 CDAEE8          17      CALL    CHGDRVR     ;ドライブ切り替え
001A84 E7AB D8              11      RET C
       E7AC                     FATS2:
001A85 E7AC DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001A88 E7AF 0F               4      RRCA
001A89 E7B0 CDE0E7          17      CALL    FATSETUP12  ;自己書き換え
       E7B1                     FATSX   EQU $-2
001A8C E7B3 210000          10      LD  HL,0
001A8F E7B6 4A               4      LD  C,D
001A90 E7B7 54               4      LD  D,H
001A91 E7B8 3AABF0          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
001A94 E7BB 47               4      LD  B,A
001A95 E7BC 04               4      INC B
001A96 E7BD DD7E00          19      LD  A,(IX+DPB_FATLN)
       E7C0                     FAT_SKP:
001A99 E7C0 05               4      DEC B
001A9A E7C1 2809            12      JR  Z,FAT1
001A9C E7C3 19              11      ADD HL,DE
001A9D E7C4 93               4      SUB E
001A9E E7C5 30F9            12      JR  NC,FAT_SKP
001AA0 E7C7 DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
001AA4 E7CB C8              11      RET Z
       E7CC                     FAT1:
001AA5 E7CC EB               4      EX  DE,HL
001AA6 E7CD B7               4      OR  A       ;0の場合は0100Hとして扱う
001AA7 E7CE 2803            12      JR  Z,FAT3
001AA9 E7D0 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001AAA E7D1 3801            12      JR  C,FAT2
       E7D3                     FAT3:
001AAC E7D3 79               4      LD  A,C
       E7D4                     FAT2:
001AAD E7D4 47               4      LD  B,A
                                
001AAE E7D5 2AFAF1          16      LD  HL,(_FATPS) ;fat sector pos
001AB1 E7D8 19              11      ADD HL,DE
001AB2 E7D9 EB               4      EX  DE,HL
001AB3 E7DA 2A7CF1          16      LD  HL,(_FATBF)
001AB6 E7DD AF               4      XOR A       ;CF=0
001AB7 E7DE 4F               4      LD  C,A
001AB8 E7DF C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E7E0                     FATSETUP12:
001AB9 E7E0 110606          10      LD  DE,0606H    ;256
001ABC E7E3 D8              11      RET C
001ABD E7E4 110303          10      LD  DE,0303H    ;512
001AC0 E7E7 0F               4      RRCA
001AC1 E7E8 D8              11      RET C
001AC2 E7E9 110102          10      LD  DE,0201H    ;1024
001AC5 E7EC C9              10      RET
                                
       E7ED                     FATSETUP16:
001AC6 E7ED 110404          10      LD  DE,0404H    ;256
001AC9 E7F0 D8              11      RET C
001ACA E7F1 110202          10      LD  DE,0202H    ;512
001ACD E7F4 0F               4      RRCA
001ACE E7F5 D8              11      RET C
001ACF E7F6 110101          10      LD  DE,0101H    ;1024
001AD2 E7F9 C9              10      RET
                                
       E7FA                     CHGDRV:
001AD3 E7FA E5              11      PUSH    HL
001AD4 E7FB 2189F0          10      LD  HL,_DSK
001AD7 E7FE BE               7      CP  (HL)
001AD8 E7FF 280A            12      JR  Z,CHGDRVE
       E801                     CHGDRV1:
001ADA E801 DDE5            15      PUSH    IX
001ADC E803 CD0DE8          17      CALL    CHGDRV0
001ADF E806 3A89F0          13      LD  A,(_DSK)
001AE2 E809 DDE1            14      POP IX
       E80B                     CHGDRVE:
001AE4 E80B E1              10      POP HL
001AE5 E80C C9              10      RET
                                
       E80D                     CHGDRV0:
001AE6 E80D 6F               4      LD  L,A
001AE7 E80E CDDCF0          17      CALL    _GETDPB
001AEA E811 D8              11      RET C
001AEB E812 DD22A8F0        20      LD  (_DPB),IX
001AEF E816 7D               4      LD  A,L
001AF0 E817 3289F0          13      LD  (_DSK),A
       E81A                     CHGDRV2:
001AF3 E81A C5              11      PUSH    BC
001AF4 E81B D5              11      PUSH    DE
001AF5 E81C ED7365E8        20      LD  (SPPAT2),SP
001AF9 E820 F3               4      DI
001AFA E821 DDF9            10      LD  SP,IX
                                
001AFC E823 E1              10      POP HL      ;00:DPB_FATLN
001AFD E824 E1              10      POP HL      ;02:DPB_DRD
001AFE E825 228FE7          16      LD  (DRDPAT),HL
                                
001B01 E828 E1              10      POP HL
001B02 E829 229DE7          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001B05 E82C E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001B06 E82D 7C               4      LD  A,H
001B07 E82E 3291DE          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001B0A E831 3D               4      DEC A
001B0B E832 32F8E5          13      LD  (_NCPAT),A
                                
001B0E E835 E1              10      POP HL      ;08:DPB_MAXCL
001B0F E836 7D               4      LD  A,L
001B10 E837 32B0DE          13      LD  (CLPAT2),A
001B13 E83A 7C               4      LD  A,H
001B14 E83B 32ACDE          13      LD  (CLPAT1),A
001B17 E83E 2B               6      DEC HL
001B18 E83F 22AFE0          16      LD  (MAXCLP),HL
                                
001B1B E842 E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001B1C E843 4C               4      LD  C,H
                                
001B1D E844 E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001B1E E845 E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001B1F E846 7C               4      LD  A,H     ;DPB_BPS
001B20 E847 E607             7      AND 7
001B22 E849 326AE3          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001B25 E84C 87               4      ADD A,A     ;8  4   2
001B26 E84D 87               4      ADD A,A     ;010H   8   4
001B27 E84E 87               4      ADD A,A     ;020H   010H    8
001B28 E84F 320FDD          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001B2B E852 2600             7      LD  H,0
001B2D E854 22FAF1          16      LD  (_FATPS),HL
                                
001B30 E857 E1              10      POP HL      ;10:DPB_DIRPS
001B31 E858 22FCF1          16      LD  (_DIRPS),HL
                                
001B34 E85B E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001B35 E85C 7C               4      LD  A,H
001B36 E85D 3284F0          13      LD  (_DRIVE),A
                                
001B39 E860 E1              10      POP HL      ;14:DPB_ADDCL
001B3A E861 22A1DE          16      LD  (CLSPAT),HL
                                
001B3D E864 310000          10      LD  SP,0        ;元のSPを復元
       E865                     SPPAT2  EQU $-2
001B40 E867 FB               4      EI
001B41 E868 2AFCF1          16      LD  HL,(_DIRPS)
001B44 E86B 0600             7      LD  B,0
001B46 E86D 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001B47 E86E 222ADD          16      LD  (MD_PAT),HL
                                
001B4A E871 2AAFE0          16      LD  HL,(MAXCLP)
001B4D E874 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001B50 E877 19              11      ADD HL,DE
001B51 E878 380F            12      JR  C,SETFAT16
001B53 E87A 217EE5          10      LD  HL,GNCL     ;FAT12
001B56 E87D 11A1E5          10      LD  DE,SNCL
001B59 E880 01E0E7          10      LD  BC,FATSETUP12
001B5C E883 DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001B60 E887 180D            12      JR  EXTRA1
       E889                     SETFAT16:
001B62 E889 21D5E5          10      LD  HL,GNCL16   ;FAT16
001B65 E88C 11E2E5          10      LD  DE,SNCL16
001B68 E88F 01EDE7          10      LD  BC,FATSETUP16
001B6B E892 DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       E896                     EXTRA1:
001B6F E896 22F8F0          16      LD  (GNCPAT),HL
001B72 E899 ED53FBF0        20      LD  (SNCPAT),DE
001B76 E89D ED43B1E7        20      LD  (FATSX),BC
001B7A E8A1 D1              10      POP DE
001B7B E8A2 C1              10      POP BC
001B7C E8A3 AF               4      XOR A
001B7D E8A4 C9              10      RET
                                
       E8A5                     GETDPBD:
001B7E E8A5 DDE3            23      EX  (SP),IX
001B80 E8A7 DDE5            15      PUSH    IX
001B82 E8A9 3A88F0          13      LD  A,(_DRV)
001B85 E8AC 1807            12      JR  GETDPB1
                                
       E8AE                     CHGDRVR:
001B87 E8AE CDD9F0          17      CALL    _CHGDRV
001B8A E8B1 D8              11      RET C
001B8B E8B2 3A89F0          13      LD  A,(_DSK)
       E8B5                     GETDPB1:
001B8E E8B5 C3DCF0          10      JP  _GETDPB
                                
       E8B8                     GETDPB:
001B91 E8B8 FE08             7      CP  8
001B93 E8BA 3F               4      CCF
001B94 E8BB D8              11      RET C
001B95 E8BC 0F               4      RRCA
001B96 E8BD 0F               4      RRCA
001B97 E8BE 0F               4      RRCA
001B98 E8BF DD                      DB  0DDH        ;Z80未定義命令
001B99 E8C0 6F               4      LD  L,A     ;LD IXL,A
001B9A E8C1 DD                      DB  0DDH        ;Z80未定義命令
001B9B E8C2 26F2             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001B9D E8C4 DD7E00          19      LD  A,(IX+DPB_FATLN)
001BA0 E8C7 A7               4      AND A       ;CF=0の為
001BA1 E8C8 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001BA5 E8CC C0              11      RET NZ      ;FAT16
001BA6 E8CD DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001BAA E8D1 C0              11      RET NZ      ;BPB
001BAB E8D2 FE01             7      CP  001H        ;A=0 THEN CF=1
001BAD E8D4 C9              10      RET
                                
       E8D5                     _SYS5F:
001BAE E8D5 AF               4      XOR A
       E8D6                     FFLUSH:
001BAF E8D6 F5              11      PUSH    AF
001BB0 E8D7 CDFCE4          17      CALL    WTFATX
001BB3 E8DA AF               4      XOR A
001BB4 E8DB 32ABF0          13      LD  (_FATIX),A
001BB7 E8DE 2F               4      CPL         ;0FFH
001BB8 E8DF 32AAF0          13      LD  (_FATDRV),A
001BBB E8E2 3E                      DB  03EH        ;次のPUSH AFをスキップ
       E8E3                     FFLUSHBUF:
001BBC E8E3 F5              11      PUSH    AF
001BBD E8E4 CDB2E4          17      CALL    DWTX
001BC0 E8E7 3EFF             7      LD  A,0FFH
001BC2 E8E9 3239F0          13      LD  (SFILE),A
001BC5 E8EC 32A5F0          13      LD  (_DBDRV),A
001BC8 E8EF F1              10      POP AF
001BC9 E8F0 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MZ-700/1500
                                
       E8F1                     SEEK:
001BCA E8F1 0610             7      LD  B,16
001BCC E8F3 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001BCF E8F6 AF               4      XOR A
001BD0 E8F7 EB               4      EX  DE,HL
       E8F8                     DIV1:
001BD1 E8F8 29              11      ADD HL,HL
001BD2 E8F9 8F               4      ADC A,A
001BD3 E8FA B9               4      CP  C
001BD4 E8FB 3802            12      JR  C,DIV2
001BD6 E8FD 91               4      SUB C
001BD7 E8FE 2C               4      INC L
       E8FF                     DIV2:
001BD8 E8FF 10F7            13      DJNZ    DIV1
                                
001BDA E901 3C               4      INC A   ;最小のセクタは１固定
001BDB E902 55               4      LD  D,L ;TRACK
001BDC E903 5F               4      LD  E,A ;SECTOR
                                
001BDD E904 3A84F0          13      LD  A,(_DRIVE)
001BE0 E907 FE04             7      CP  4
001BE2 E909 3F               4      CCF
001BE3 E90A D8              11      RET C
001BE4 E90B F684             7      OR  084H        ;Motor on + ドライブセレクト有効
001BE6 E90D D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001BE8 E90F CB3A             8      SRL D       ;CYLINDER
001BEA E911 9F               4      SBC A,A
001BEB E912 D3DD            11      OUT (0DDH),A    ;ヘッドセレクト制御レジスタ
                                
001BED E914 CD4CE9          17      CALL    SETMODE
001BF0 E917 D8              11      RET C
                                
001BF1 E918 CD81E9          17      CALL    DRIVE
001BF4 E91B FEFF             7      CP  0FFH        ;A=0FFH Unknown CYLINDER
001BF6 E91D CC63E9          17      CALL    Z,FDCRES    ;Restore
001BF9 E920 2F               4      CPL         ;データバスが負論理
001BFA E921 D3D9            11      OUT (0D9H),A    ;MB8876 トラックレジスタ
001BFC E923 2F               4      CPL         ;データバスが負論理
001BFD E924 92               4      SUB D
001BFE E925 C8              11      RET Z       ;No seek
                                
001BFF E926 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)
001C02 E929 3D               4      DEC A
001C03 E92A BA               4      CP  D       ;Over CYLINDER
001C04 E92B D8              11      RET C
                                
001C05 E92C 7A               4      LD  A,D
001C06 E92D 2F               4      CPL         ;データバスが負論理
001C07 E92E D3DB            11      OUT (0DBH),A    ;MB8876 データレジスタ
001C09 E930 72               7      LD  (HL),D
                                
001C0A E931 0E18             7      LD  C,018H      ;FDC TypeIコマンド Seek
       E933                     FDCCMD2:
001C0C E933 3A85F0          13      LD  A,(_SEEKSP)
001C0F E936 B1               4      OR  C
                                
       E937                     FDCCMD:
001C10 E937 CD78E9          17      CALL    COMSET
001C13 E93A 3E80             7      LD  A,080H      ;FDC COMMAND(Self-modifying code)
       E93B                     FDCSMC  EQU $-1
001C15 E93C E620             7      AND 020H        ;Write data Write track
001C17 E93E 3C               4      INC A
                                
       E93F                     SST:
001C18 E93F 0E00             7      LD  C,0
       E941                     SST1:
001C1A E941 0D               4      DEC C       ; 4
001C1B E942 20FD            12      JR  NZ,SST1     ;12 * 256 / 4 = About 1ms
001C1D E944 3D               4      DEC A
001C1E E945 20FA            12      JR  NZ,SST1
                                
001C20 E947 0E01             7      LD  C,1
001C22 E949 CD51E9          17      CALL    READY
       E94C                     SETMODE:
001C25 E94C CD7BE9          17      CALL    DELAY0      ;Head select time
001C28 E94F 0E81             7      LD  C,081H
       E951                     READY:
001C2A E951 0680             7      LD  B,128
       E953                     READY2:
001C2C E953 DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001C2E E955 2F               4      CPL         ;データバスが負論理
001C2F E956 A1               4      AND C       ;NOT READY,BUSY
001C30 E957 C8              11      RET Z
001C31 E958 CD2DCF          17      CALL    RD556VSYNC
001C34 E95B 07               4      RLCA
001C35 E95C A8               4      XOR B
001C36 E95D 0F               4      RRCA
001C37 E95E 30F3            12      JR  NC,READY2
001C39 E960 10F1            13      DJNZ    READY2
001C3B E962 C9              10      RET
                                
       E963                     FDCRES:
001C3C E963 3600            10      LD  (HL),0
001C3E E965 0E08             7      LD  C,8     ;FDC TypeIコマンド Restore
001C40 E967 18CA            12      JR  FDCCMD2
                                
       E969                     FDMOFF:
001C42 E969 F5              11      PUSH    AF
001C43 E96A AF               4      XOR A       ;Motor off(ドライブセレクト無効)
001C44 E96B D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001C46 E96D F1              10      POP AF
001C47 E96E C9              10      RET
                                
       E96F                     SECSET_FDCCMD:
001C48 E96F 3A3BE9          13      LD  A,(FDCSMC)
       E972                     SECSET:
001C4B E972 F5              11      PUSH    AF
001C4C E973 7B               4      LD  A,E
001C4D E974 2F               4      CPL         ;データバスが負論理
001C4E E975 D3DA            11      OUT (0DAH),A    ;MB8876 セクタレジスタ
001C50 E977 F1              10      POP AF
       E978                     COMSET:
001C51 E978 2F               4      CPL         ;データバスが負論理
001C52 E979 D3D8            11      OUT (0D8H),A    ;MB8876 ステータス/コマンドレジスタ
       E97B                     DELAY0:
001C54 E97B 3E1A             7      LD  A,26
       E97D                     DELAY:
001C56 E97D 3D               4      DEC A
001C57 E97E 20FD            12      JR  NZ,DELAY
001C59 E980 C9              10      RET
                                
       E981                     DRIVE:                  ;ドライブのシリンダを得る
001C5A E981 2A84F0          16      LD  HL,(_DRIVE)
001C5D E984 26F0             7      LD  H,_CYL0/256
001C5F E986 CBFD             8      SET 7,L
001C61 E988 7E               7      LD  A,(HL)
001C62 E989 C9              10      RET
                                
       E98A                     RNF:                    ;ドライブのシリンダをリセット
001C63 E98A CD81E9          17      CALL    DRIVE
001C66 E98D 36FF            10      LD  (HL),0FFH
001C68 E98F C9              10      RET
                                
001C69 E990 02                  RETRY:  DB  2
                                
                                
                                ;   FLOPPY DISK DRIVER
                                
       E991                     WTTRK:
001C6A E991 0601             7      LD  B,1
001C6C E993 3EF4             7      LD  A,0F4H      ;FDC TypeIIIコマンド Write Track
001C6E E995 1802            12      JR  WTTRK1
       E997                     FDWT:
001C70 E997 3EA0             7      LD  A,0A0H      ;FDC TypeIIコマンド Write Sector
       E999                     WTTRK1:
001C72 E999 323BE9          13      LD  (FDCSMC),A
       E99C                     DWTBL:
001C75 E99C 78               4      LD  A,B
001C76 E99D 32D9E9          13      LD  (WTBSMC),A
001C79 E9A0 3E02             7      LD  A,2     ;Retry count
001C7B E9A2 3290E9          13      LD  (RETRY),A
                                
       E9A5                     DWT0:
001C7E E9A5 D5              11      PUSH    DE
001C7F E9A6 E5              11      PUSH    HL
001C80 E9A7 CDF1E8          17      CALL    SEEK        ;Write disk
001C83 E9AA E1              10      POP HL
001C84 E9AB 3837            12      JR  C,ERRDW
001C86 E9AD F3               4      DI
001C87 E9AE CD6FE9          17      CALL    SECSET_FDCCMD
001C8A E9B1 0EDB             7      LD  C,0DBH      ;MB8876 データレジスタ
       E9B3                     DWT1:
001C8C E9B3 7E               7      LD  A,(HL)
001C8D E9B4 2F               4      CPL         ;データバスが負論理
001C8E E9B5 57               4      LD  D,A
                                
       E9B6                     DWT2:
001C8F E9B6 DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001C91 E9B8 2F               4      CPL         ;データバスが負論理
001C92 E9B9 0F               4      RRCA
001C93 E9BA 3008            12      JR  NC,DWT4
001C95 E9BC 0F               4      RRCA
001C96 E9BD 30F7            12      JR  NC,DWT2
       E9BF                     DWT3:
001C98 E9BF ED51            12      OUT (C),D       ;MB8876 データレジスタ
001C9A E9C1 23               6      INC HL
001C9B E9C2 18EF            12      JR  DWT1
                                
       E9C4                     DWT4:
001C9D E9C4 3D               4      DEC A
001C9E E9C5 28F8            12      JR  Z,DWT3
001CA0 E9C7 3C               4      INC A
001CA1 E9C8 FB               4      EI
001CA2 E9C9 D1              10      POP DE
001CA3 E9CA 13               6      INC DE
001CA4 E9CB CD69E9          17      CALL    FDMOFF
001CA7 E9CE 2808            12      JR  Z,DISKOK_WT
001CA9 E9D0 CD38EA          17      CALL    DISKC
001CAC E9D3 20D0            12      JR  NZ,DWT0
001CAE E9D5 B7               4      OR  A
001CAF E9D6 2005            12      JR  NZ,ERRW
                                
       E9D8                     DISKOK_WT:
001CB1 E9D8 0601             7      LD  B,1
       E9D9                     WTBSMC  EQU $-1
001CB3 E9DA 10C0            13      DJNZ    DWTBL
001CB5 E9DC C9              10      RET
                                
       E9DD                     ERRW:
001CB6 E9DD 3EFF             7      LD  A,0FFH
       E9DF                     ERRZ:
001CB8 E9DF BF               4      CP  A       ;ZF=1
001CB9 E9E0 37               4      SCF
001CBA E9E1 C369E9          10      JP  FDMOFF
                                
       E9E4                     ERRDW:
001CBD E9E4 D1              10      POP DE
001CBE E9E5 CD49EA          17      CALL    DELP
001CC1 E9E8 20BB            12      JR  NZ,DWT0
001CC3 E9EA B7               4      OR  A
001CC4 E9EB 20F0            12      JR  NZ,ERRW
001CC6 E9ED C9              10      RET
                                
       E9EE                     FDRD:
001CC7 E9EE 3E80             7      LD  A,080H      ;FDC TypeIIコマンド Read Sector
001CC9 E9F0 323BE9          13      LD  (FDCSMC),A
       E9F3                     DRDBL:
001CCC E9F3 78               4      LD  A,B
001CCD E9F4 322AEA          13      LD  (RDBSMC),A
001CD0 E9F7 3E02             7      LD  A,2     ;Retry count
001CD2 E9F9 3290E9          13      LD  (RETRY),A
       E9FC                     DRD0:
001CD5 E9FC D5              11      PUSH    DE
001CD6 E9FD E5              11      PUSH    HL
001CD7 E9FE CDF1E8          17      CALL    SEEK        ;Read disk
001CDA EA01 E1              10      POP HL
001CDB EA02 382A            12      JR  C,ERRDR
001CDD EA04 F3               4      DI
001CDE EA05 CD6FE9          17      CALL    SECSET_FDCCMD
       EA08                     DRD1:
001CE1 EA08 DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001CE3 EA0A 2F               4      CPL         ;データバスが負論理
001CE4 EA0B 0F               4      RRCA
001CE5 EA0C 300A            12      JR  NC,DRD3
001CE7 EA0E 0F               4      RRCA
001CE8 EA0F 30F7            12      JR  NC,DRD1
001CEA EA11 DBDB            11      IN  A,(0DBH)    ;MB8876 データレジスタ
001CEC EA13 2F               4      CPL         ;データバスが負論理
001CED EA14 77               7      LD  (HL),A
001CEE EA15 23               6      INC HL
001CEF EA16 18F0            12      JR  DRD1
                                
       EA18                     DRD3:
001CF1 EA18 B7               4      OR  A
001CF2 EA19 FB               4      EI
001CF3 EA1A D1              10      POP DE
001CF4 EA1B 13               6      INC DE
001CF5 EA1C CD69E9          17      CALL    FDMOFF
001CF8 EA1F 2808            12      JR  Z,DISKOK_RD
001CFA EA21 CD38EA          17      CALL    DISKC
001CFD EA24 20D6            12      JR  NZ,DRD0
001CFF EA26 B7               4      OR  A
001D00 EA27 20B4            12      JR  NZ,ERRW
                                
       EA29                     DISKOK_RD:
001D02 EA29 0601             7      LD  B,1
       EA2A                     RDBSMC  EQU $-1
001D04 EA2B 10C6            13      DJNZ    DRDBL
001D06 EA2D C9              10      RET
                                
       EA2E                     ERRDR:
001D07 EA2E D1              10      POP DE
001D08 EA2F CD49EA          17      CALL    DELP
001D0B EA32 20C8            12      JR  NZ,DRD0
001D0D EA34 B7               4      OR  A
001D0E EA35 20A6            12      JR  NZ,ERRW
001D10 EA37 C9              10      RET
       EA38                     DISKC:
001D11 EA38 1B               6      DEC DE
001D12 EA39 CB5F             8      BIT 3,A
001D14 EA3B C48AE9          17      CALL    NZ,RNF
       EA3E                     DISKD:
001D17 EA3E E5              11      PUSH    HL
001D18 EA3F 2190E9          10      LD  HL,RETRY
001D1B EA42 35              11      DEC (HL)
001D1C EA43 E1              10      POP HL
001D1D EA44 200C            12      JR  NZ,ERR      ;Retry
001D1F EA46 B7               4      OR  A
001D20 EA47 2809            12      JR  Z,ERR       ;Error
                                
       EA49                     DELP:
001D22 EA49 CD8AE9          17      CALL    RNF
001D25 EA4C CD69E9          17      CALL    FDMOFF
001D28 EA4F 3EFF             7      LD  A,0FFH
       EA51                     AERRZ:
001D2A EA51 BF               4      CP  A
       EA52                     ERR:
001D2B EA52 3EFF             7      LD  A,0FFH
001D2D EA54 C9              10      RET
[EOF:M7DISK.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MZ-700/1500
                                
                                ;   EMM DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       EA55                     EDWT:
001D2E EA55 F5              11      PUSH    AF
001D2F EA56 CD74EA          17      CALL    EADR
001D32 EA59 0600             7      LD  B,0
       EA5B                     EDWT1:
001D34 EA5B EDB3                    OTIR
001D36 EA5D 3D               4      DEC A
001D37 EA5E 20FB            12      JR  NZ,EDWT1
001D39 EA60 180B            12      JR  EDRW1
                                
       EA62                     EDRD:
001D3B EA62 C5              11      PUSH    BC
001D3C EA63 CD74EA          17      CALL    EADR
001D3F EA66 0600             7      LD  B,0
       EA68                     EDRD1:
001D41 EA68 EDB2                    INIR
001D43 EA6A 3D               4      DEC A
001D44 EA6B 20FB            12      JR  NZ,EDRD1
       EA6D                     EDRW1:
001D46 EA6D F1              10      POP AF
001D47 EA6E 83               4      ADD A,E ;セクタを進める
001D48 EA6F 5F               4      LD  E,A
001D49 EA70 8A               4      ADC A,D
001D4A EA71 93               4      SUB E
001D4B EA72 57               4      LD  D,A
001D4C EA73 C9              10      RET
                                
       EA74                     EADR:
001D4D EA74 D5              11      PUSH    DE
001D4E EA75 EB               4      EX  DE,HL
001D4F EA76 78               4      LD  A,B
001D50 EA77 DD460F          19      LD  B,(IX+DPB_BPS)
       EA7A                     EADR1:              ;読み込むセクタ数と1クラスタのセクタ数を掛ける
001D53 EA7A CB18             8      RR  B
001D55 EA7C 3804            12      JR  C,EADR2
001D57 EA7E 87               4      ADD A,A
001D58 EA7F 29              11      ADD HL,HL
001D59 EA80 18F8            12      JR  EADR1
       EA82                     EADR2:
001D5B EA82 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001D5E EA85 DD460C          19      LD  B,(IX+DPB_MAXCYL)
001D61 EA88 09              11      ADD HL,BC
001D62 EA89 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D65 EA8C ED71            12      OUT (C),0       ;Z80未定義命令
001D67 EA8E 0C               4      INC C
001D68 EA8F ED69            12      OUT (C),L
001D6A EA91 0C               4      INC C
001D6B EA92 ED61            12      OUT (C),H
001D6D EA94 0C               4      INC C
001D6E EA95 EB               4      EX  DE,HL
001D6F EA96 D1              10      POP DE
001D70 EA97 C9              10      RET
                                
                                ;   CMOS BACKUP MEMORY DRIVER(32KB)
                                ;   1セクタ256
                                
       EA98                     CDWT:
001D71 EA98 78               4      LD  A,B
001D72 EA99 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D75 EA9C ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001D77 EA9E ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001D79 EAA0 01FA00          10      LD  BC,000FAH
       EAA3                     CDWT1:
001D7C EAA3 EDB3                    OTIR            ;W)データ書き込み・アドレスカウンタ+1
001D7E EAA5 13               6      INC DE
001D7F EAA6 3D               4      DEC A
001D80 EAA7 20FA            12      JR  NZ,CDWT1
001D82 EAA9 A7               4      AND A
001D83 EAAA C9              10      RET
                                
       EAAB                     CDRD:
001D84 EAAB 78               4      LD  A,B
001D85 EAAC DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D88 EAAF ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001D8A EAB1 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001D8C EAB3 01F900          10      LD  BC,000F9H
       EAB6                     CDRD1:
001D8F EAB6 EDB2                    INIR            ;R)データ読み出し・アドレスカウンタ+1
001D91 EAB8 13               6      INC DE
001D92 EAB9 3D               4      DEC A
001D93 EABA 20FA            12      JR  NZ,CDRD1
001D95 EABC A7               4      AND A
001D96 EABD C9              10      RET
                                
                                ;   RAM DISK DRIVER (64KB)
                                ;   1セクタ256
                                
       EABE                     RDWT:
001D97 EABE 3EB3             7      LD  A,0B3H      ;OTIR
001D99 EAC0 1802            12      JR  RDRW
       EAC2                     RDRD:
001D9B EAC2 3EB2             7      LD  A,0B2H      ;INIR
       EAC4                     RDRW:
001D9D EAC4 32D1EA          13      LD  (RDRW_SWC),A
                                
001DA0 EAC7 78               4      LD  A,B
001DA1 EAC8 43               4      LD  B,E     ;B=アドレスカウンタ上位(X1の様な16bitのI/Oアクセス)
001DA2 EAC9 0EEB             7      LD  C,0EBH
001DA4 EACB ED71            12      OUT (C),0       ;0=アドレスカウンタ下位
001DA6 EACD 0D               4      DEC C       ;EA(R)データ読み出し・アドレスカウンタ+1
001DA7 EACE 0600             7      LD  B,0
       EAD0                     RDRW1:
001DA9 EAD0 EDB2                    INIR            ;自己書き換え(INIR/OTIR)
       EAD1                     RDRW_SWC    EQU $-1
001DAB EAD2 13               6      INC DE
001DAC EAD3 3D               4      DEC A
001DAD EAD4 20FA            12      JR  NZ,RDRW1
001DAF EAD6 A7               4      AND A
001DB0 EAD7 C9              10      RET
                                
                                ;   G-RAM(PCG) DISK DRIVER (24KB)
                                ;   1セクタ256
                                
       EAD8                     GDWT:
001DB1 EAD8 C5              11      PUSH    BC
001DB2 EAD9 D5              11      PUSH    DE
001DB3 EADA CD02EB          17      CALL    GADR
       EADD                     GDWT2:
001DB6 EADD 4E               7      LD  C,(HL)
001DB7 EADE 23               6      INC HL
001DB8 EADF EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001DB9 EAE0 CDD3CF          17      CALL    WR_PCG
001DBC EAE3 23               6      INC HL
001DBD EAE4 EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001DBE EAE5 10F6            13      DJNZ    GDWT2
001DC0 EAE7 D1              10      POP DE
001DC1 EAE8 1C               4      INC E
001DC2 EAE9 C1              10      POP BC
001DC3 EAEA 10EC            13      DJNZ    GDWT
001DC5 EAEC C9              10      RET
       EAED                     GDRD:
001DC6 EAED C5              11      PUSH    BC
001DC7 EAEE D5              11      PUSH    DE
001DC8 EAEF CD02EB          17      CALL    GADR
       EAF2                     GDRD2:
001DCB EAF2 EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001DCC EAF3 CDCBCF          17      CALL    RD_PCG
001DCF EAF6 23               6      INC HL
001DD0 EAF7 EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001DD1 EAF8 71               7      LD  (HL),C
001DD2 EAF9 23               6      INC HL
001DD3 EAFA 10F6            13      DJNZ    GDRD2
001DD5 EAFC D1              10      POP DE
001DD6 EAFD 1C               4      INC E
001DD7 EAFE C1              10      POP BC
001DD8 EAFF 10EC            13      DJNZ    GDRD
001DDA EB01 C9              10      RET
                                
       EB02                     GADR:
001DDB EB02 7B               4      LD  A,E
001DDC EB03 E61F             7      AND 01FH
001DDE EB05 C6D0             7      ADD A,0D0H
001DE0 EB07 57               4      LD  D,A
001DE1 EB08 7B               4      LD  A,E
001DE2 EB09 07               4      RLCA
001DE3 EB0A 07               4      RLCA
001DE4 EB0B 07               4      RLCA
001DE5 EB0C 3C               4      INC A
001DE6 EB0D 0600             7      LD  B,0
001DE8 EB0F 58               4      LD  E,B
001DE9 EB10 C9              10      RET
[EOF:M7DISK2.ASM:UTF_8]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001DEA EB11                     PATHD:  DS  PATHX
001E25 EB4C 00                  PATHE:  DB  0
                                
       EB4D                     DTA_CCP:
001E26 EB4D                         DS  37
                                
       EB72                     FCB_BAT:
001E4B EB72                         DS  37
                                
001E70 EB97 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001E7B EBA2 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "M7TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE 表示関連のテーブル
                                ;   MZ-700/1500
                                
       EBA9                     AT_TABLE:
001E82 EBA9                         DS  TABLEAD-AT_TABLE
                                
       ED40                     KEY_TABLE:
002019 ED40 12081E1F1C1D5C2F        DB  12H,08H,1EH,1FH,1CH,1DH,5CH,'/'
002021 ED48 5C5E2D2030392C2E        DB  5CH,'^','-',20H,'0','9',',','.'
002029 ED50 3132333435363738        DB  '1','2','3','4','5','6','7','8'
002031 ED58 6162636465666768        DB  'a','b','c','d','e','f','g','h'
002039 ED60 696A6B6C6D6E6F70        DB  'i','j','k','l','m','n','o','p'
002041 ED68 7172737475767778        DB  'q','r','s','t','u','v','w','x'
002049 ED70 797A405B5D000000        DB  'y','z','@','[',']',00H,00H,00H
002051 ED78 001B3D09003B3A0D        DB  00H,1BH,'=',09H,00H,';',':',0DH
       ED80                     SHIFT_TABLE:
002059 ED80 12081E1F1C1D5F3F        DB  12H,08H,1EH,1FH,1CH,1DH,'_','?'
002061 ED88 7C7E3D2030293C3E        DB  '|','~','=',20H,'0',')','<','>'
002069 ED90 2122232425262728        DB  '!','"','#','$','%','&',27H,'('
002071 ED98 4142434445464748        DB  'A','B','C','D','E','F','G','H'
002079 EDA0 494A4B4C4D4E4F50        DB  'I','J','K','L','M','N','O','P'
002081 EDA8 5152535455565758        DB  'Q','R','S','T','U','V','W','X'
002089 EDB0 595A607B7D000000        DB  'Y','Z','`','{','}',00H,00H,00H
002091 EDB8 00003D09002B2A0D        DB  00H,00H,'=',09H,00H,'+','*',0DH
       EDC0                     CTRL_TABLE:
002099 EDC0 12081E1F1C1D3F2F        DB  12H,08H,1EH,1FH,1CH,1DH,'?','/'
0020A1 EDC8 2A2B2D2030392C2E        DB  '*','+','-',20H,'0','9',',','.'
0020A9 EDD0 3132333435363738        DB  '1','2','3','4','5','6','7','8'
0020B1 EDD8 0102030405060708        DB  01H,02H,03H,04H,05H,06H,07H,08H
0020B9 EDE0 090A0B0C0D0E0F10        DB  09H,0AH,0BH,0CH,0DH,0EH,0FH,10H
0020C1 EDE8 1112131415161718        DB  11H,12H,13H,14H,15H,16H,17H,18H
0020C9 EDF0 191A1B5B5D000000        DB  19H,1AH,1BH,'[',']',00H,00H,00H
0020D1 EDF8 00003D09003B3A0D        DB  00H,00H,'=',09H,00H,';',':',0DH
                                
                                ;   アドレス下位1バイトが0になるように
       EE00                     CD_TABLE:
0020D9 EE00 00D1D2D3D4D5D6D0        DB  $00,$D1,$D2,$D3,$D4,$D5,$D6,$D0 ;月火水木金土日
0020E1 EE08 D8DCD9DADBD7CFCE        DB  $D8,$DC,$D9,$DA,$DB,$D7,$CF,$CE ;年円時分秒
0020E9 EE10 601F5F5E1E1B7978        DB  $60,$1F,$5F,$5E,$1E,$1B,$79,$78 ;
0020F1 EE18 5C5D1C1D6DCACDC7        DB  $5C,$5D,$1C,$1D,$6D,$CA,$CD,$C7 ;
0020F9 EE20 0061626364656667        DB  $00,$61,$62,$63,$64,$65,$66,$67 ; !"#$%&'
002101 EE28 68696B6A2F2A2E2D        DB  $68,$69,$6B,$6A,$2F,$2A,$2E,$2D ;()*+,-./
002109 EE30 2021222324252627        DB  $20,$21,$22,$23,$24,$25,$26,$27 ;01234567
002111 EE38 28294F2C512B5749        DB  $28,$29,$4F,$2C,$51,$2B,$57,$49 ;89:;<=>?
002119 EE40 5501020304050607        DB  $55,$01,$02,$03,$04,$05,$06,$07 ;@ABCDEFG
002121 EE48 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;HIJKLMNO
002129 EE50 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;PQRSTUVW
002131 EE58 18191A52DD54E37C        DB  $18,$19,$1A,$52,$DD,$54,$E3,$7C ;XYZ[\]^_
002139 EE60 5901020304050607        DB  $59,$01,$02,$03,$04,$05,$06,$07 ;`abcdefg   ATB:1
002141 EE68 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;hijklmno   ATB:1
002149 EE70 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;pqrstuvw   ATB:1
002151 EE78 18191ACB35CC705A        DB  $18,$19,$1A,$CB,$35,$CC,$70,$5A ;xyz{|}~    ATB:1
002159 EE80 415346444847B49E        DB  $41,$53,$46,$44,$48,$47,$B4,$9E ;トランプ〇●をぁ   ATB:1
002161 EE88 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ぃぅぇぉゃゅょっ   ATB:1
002169 EE90 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーあいうえおかき   ATB:1
002171 EE98 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;くけこさしすせそ   ATB:1
002179 EEA0 F0BD9DB1B5B9B49E        DB  $F0,$BD,$9D,$B1,$B5,$B9,$B4,$9E ;　。「」、・ヲァ
002181 EEA8 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ィゥェォャョュッ
002189 EEB0 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーアイウエオカキ
002191 EEB8 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;クケコサシスセソ
002199 EEC0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;タチツテトナニヌ
0021A1 EEC8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ネノハヒフヘホマ
0021A9 EED0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;ミムメモヤユヨラ
0021B1 EED8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;リルレロワン゛゜
0021B9 EEE0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;たちつてとねにぬ   ATB:1
0021C1 EEE8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ねのはひふへほま   ATB:1
0021C9 EEF0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;みむめもやゆよら   ATB:1
0021D1 EEF8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;りるれろわん゛゜   ATB:1
       EF00                     DC_TABLE:
0021D9 EF00 2041424344454647        DB  $20,$41,$42,$43,$44,$45,$46,$47 ;0
0021E1 EF08 48494A4B4C4D4E4F        DB  $48,$49,$4A,$4B,$4C,$4D,$4E,$4F
0021E9 EF10 5051525354555657        DB  $50,$51,$52,$53,$54,$55,$56,$57 ;1
0021F1 EF18 58595A151A1B1411        DB  $58,$59,$5A,$15,$1A,$1B,$14,$11
0021F9 EF20 3031323334353637        DB  $30,$31,$32,$33,$34,$35,$36,$37 ;2
002201 EF28 38392D3D3B2F2E2C        DB  $38,$39,$2D,$3D,$3B,$2F,$2E,$2C
002209 EF30 00000000007C0000        DB  $00,$00,$00,$00,$00,$7C,$00,$00 ;3
002211 EF38 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
002219 EF40 0080000083008285        DB  $00,$80,$00,$00,$83,$00,$82,$85 ;4
002221 EF48 843F00000000003A        DB  $84,$3F,$00,$00,$00,$00,$00,$3A
002229 EF50 5E3C5B815D40003E        DB  $5E,$3C,$5B,$81,$5D,$40,$00,$3E ;5
002231 EF58 00607F0018191312        DB  $00,$60,$7F,$00,$18,$19,$13,$12
002239 EF60 1021222324252627        DB  $10,$21,$22,$23,$24,$25,$26,$27 ;6
002241 EF68 28292B2A001C0000        DB  $28,$29,$2B,$2A,$00,$1C,$00,$00
002249 EF70 7E00000000000000        DB  $7E,$00,$00,$00,$00,$00,$00,$00 ;7
002251 EF78 171600005F000000        DB  $17,$16,$00,$00,$5F,$00,$00,$00
002259 EF80 00C19A9F9C92CA97        DB  $00,$C1,$9A,$9F,$9C,$92,$CA,$97 ;8
002261 EF88 98C6CFC9D8D3D0D7        DB  $98,$C6,$CF,$C9,$D8,$D3,$D0,$D7
002269 EF90 9EC09DC496C5CBC3        DB  $9E,$C0,$9D,$C4,$96,$C5,$CB,$C3 ;9
002271 EF98 9BDDC2DB99A2878C        DB  $9B,$DD,$C2,$DB,$99,$A2,$87,$8C
002279 EFA0 DCC7CC91939495D4        DB  $DC,$C7,$CC,$91,$93,$94,$95,$D4 ;A
002281 EFA8 D5D6CECDDAD2D9C8        DB  $D5,$D6,$CE,$CD,$DA,$D2,$D9,$C8
002289 EFB0 D1A3888D86A4898E        DB  $D1,$A3,$88,$8D,$86,$A4,$89,$8E ;B
002291 EFB8 DFA58A8FDEA18B90        DB  $DF,$A5,$8A,$8F,$DE,$A1,$8B,$90
002299 EFC0 000000000000001F        DB  $00,$00,$00,$00,$00,$00,$00,$1F ;C
0022A1 EFC8 00001D7B7D1E0F0E        DB  $00,$00,$1D,$7B,$7D,$1E,$0F,$0E
0022A9 EFD0 070102030405060D        DB  $07,$01,$02,$03,$04,$05,$06,$0D ;D
0022B1 EFD8 080A0B0C095C0000        DB  $08,$0A,$0B,$0C,$09,$5C,$00,$00
0022B9 EFE0 0000005E00000000        DB  $00,$00,$00,$5E,$00,$00,$00,$00 ;E
0022C1 EFE8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
0022C9 EFF0 A000000000000000        DB  $A0,$00,$00,$00,$00,$00,$00,$00 ;F
0022D1 EFF8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
[EOF:M7TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
       F000                         ALIGN   256
                                
       F000                     CPM_BOOT:
0022D9 F000 C30000          10      JP  0
       F003                     _SYS00:     ;(BDOS)プログラム終了
       F003                     CPM_WBOOT:
0022DC F003 C3FECF          10      JP  WBOOT1
       F006                     CPM_CONST:
0022DF F006 C305D8          10      JP  CONSTX
       F009                     _SYS07:     ;(BDOS)コンソール直接入力
       F009                     CPM_CONIN:
0022E2 F009 C39BD7          10      JP  FLGET
       F00C                     CPM_CONOUT:
0022E5 F00C C3A9D9          10      JP  CONOUT1
                                
       F00F                     DECBF:              ;10進数表示時のバッファ(5バイト)
0022E8 F00F                         DS  5
       F00F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       F011                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       F014                     FDRV:
0022ED F014 00                      DB  0
       F015                     FNAME:
0022EE F015                         DS  36
       F039                     SFILE:
002312 F039                         DS  33      ;DRV FILENAME
       F05A                     _DISKE:
002333 F05A C30CD7          10      JP  SHOW_ERROR
                                
002336 F05D 0000                LEFTX:  DW  0
002338 F05F 0000                DTAX:   DW  0
                                
       F061                     ZERO:
       F061                     BEEPD:
00233A F061 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
002342 F069 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
       F062                     RTC_YY  EQU BEEPD+1
       F063                     RTC_MW  EQU BEEPD+2
       F064                     RTC_DD  EQU BEEPD+3
       F065                     RTC_TT  EQU BEEPD+4
       F066                     RTC_MM  EQU BEEPD+5
       F067                     RTC_SS  EQU BEEPD+6
       F062                     ROM_SLT EQU BEEPD+1
                                
       F070                     CHECK:
002349 F070 00                      DB  0
                                
       F071                     OK:
00234A F071 4F4B24                  DB  "OK$"
00234D F074                         DS  5
       F079                     COMERM:
002352 F079 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       F080                     _CYL0:
002359 F080 FF                      DB  0FFH    ;Cylinder
       F081                     _CYL1:
00235A F081 FF                      DB  0FFH    ;Cylinder
       F082                     _CYL2:
00235B F082 FF                      DB  0FFH    ;Cylinder
       F083                     _CYL3:
00235C F083 FF                      DB  0FFH    ;Cylinder
       F084                     _DRIVE:
00235D F084 00                      DB  0   ;unit number
       F085                     _SEEKSP:
00235E F085 00                      DB  0   ;Seek speed
       F086                     _ISEEK:
00235F F086 32                      DB  50  ;
002360 F087                         DS  1
       F088                     _DRV:
002361 F088 00                      DB  0
       F089                     _DSK:
002362 F089 FF                      DB  0FFH
       F08A                     _DTA:
002363 F08A 8000                    DW  00080H
       F08C                     _CTC:
002365 F08C 0000                    DW  0
       F08E                     _TXADR:
002367 F08E 0000                    DW  0
       F090                     _KEYPS:
002369 F090 0000                    DW  0
       F092                     _KEYD:
00236B F092 00FF                    DW  0FF00H  ;キーデータ
       F094                     _KEYSP:
00236D F094 8310                    DB  KEYSP_L,KEYSP_H ;オートリピートの速度
       F096                     _COLORF:
00236F F096 70                      DB  COLORF  ;色
       F097                     _LINE:
002370 F097 19                      DB  LINE
                                
       F098                     _FCB:
002371 F098 0000                    DW  0   ;SEARCH FILES
       F09A                     _FBPS:
002373 F09A 0000                    DW  0   ;    //
       F09C                     _FBAD:
002375 F09C 0000                    DW  0   ;    //
       F09E                     _FBCNT:
002377 F09E 00                      DB  0   ;    //
       F09F                     _FILEN:
002378 F09F 00                      DB  0   ;    //
       F0A0                     _DIRF:
002379 F0A0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
00237A F0A1                         DS  1
       F0A2                     _WTFATF:
00237B F0A2 00                      DB  0   ;FATバッファの更新フラグ
00237C F0A3                         DS  1
       F0A4                     _WTDBF:
00237D F0A4 00                      DB  0   ;データバッファの更新フラグ
       F0A5                     _DBDRV:
00237E F0A5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       F0A6                     _DBSEC:
00237F F0A6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       F0A8                     _DPB:
002381 F0A8 0000                    DW  0
       F0AA                     _FATDRV:
002383 F0AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       F0AB                     _FATIX:
002384 F0AB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       F0AC                     _FAKEFREE:
002385 F0AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
002387 F0AE                         DS  2
                                
       F0B0                     CRTCD:
002389 F0B0 6F                      DB  06FH
       F0B1                     _WIDTH:
00238A F0B1 28                      DB  WIDTH
       F0B2                     TVRAMTOP:
00238B F0B2 5938                    DB  059H,038H
00238D F0B4 1F02                    DB  01FH,002H
       F0B6                     _LINE2:
00238F F0B6 19                      DB  019H
       F0B7                     WKE4:
002390 F0B7 1C                      DB  01CH
       F0B8                     WKE6:
002391 F0B8 00                      DB  000H
       F0B9                     WK40:
002392 F0B9 07                      DB  007H
       F0BA                     _PAGE_MINUS:
002393 F0BA 18FC                    DW  0-WIDTH*LINE
       F0BC                     _WIDTH_MINUS:
002395 F0BC D8FF                    DW  0-WIDTH
       F0BE                     WK30:
002397 F0BE 0C                      DB  00CH
       F0BF                     WK31:
       F0BF                     WK1FD0:
002398 F0BF 20                      DB  020H
                                
002399 F0C0 0000                CTC0:   DW  INTCTCE
00239B F0C2 0000                CTC1:   DW  INTCTCE
00239D F0C4 0000                CTC2:   DW  INTCTCE
00239F F0C6 0000                CTC3:   DW  INTCTCE
0023A1 F0C8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
0023A3 F0CA C3EEDA          10  _INKEY: JP  INKEY
0023A6 F0CD C390D8          10  _PRINT: JP  PRINT
0023A9 F0D0 C34CDB          10  _SCRN:  JP  SCRN
0023AC F0D3 C35EDA          10  _POS:   JP  POS
0023AF F0D6 C377D9          10  _LOC:   JP  LOC
       F0D9                     _CHGDRV:
0023B2 F0D9 C3FAE7          10      JP  CHGDRV
       F0DC                     _GETDPB:
0023B5 F0DC C3B8E8          10      JP  GETDPB
       F0DF                     _FFLUSH:
0023B8 F0DF C3D6E8          10      JP  FFLUSH
       F0E2                     _RDFATX:
0023BB F0E2 C3D2E4          10      JP  RDFATX
0023BE F0E5 C304E6          10  _RDFAT: JP  RDFAT
0023C1 F0E8 C391E9          10  _WTTRK: JP  WTTRK
0023C4 F0EB C3EEE9          10  _FDRD:  JP  FDRD
0023C7 F0EE C397E9          10  _FDWT:  JP  FDWT
       F0F1                     _BPB2DPB:
0023CA F0F1 C39CE6          10      JP  BPB2DPB
       F0F4                     _BREAK:
0023CD F0F4 C390D1          10      JP  END_BATCH
       F0F7                     _GNCL:
0023D0 F0F7 C37EE5          10      JP  GNCL        ; self-modifying code
       F0F8                     GNCPAT  EQU $-2
       F0FA                     _SNCL:
0023D3 F0FA C3A1E5          10      JP  SNCL        ; self-modifying code
       F0FB                     SNCPAT  EQU $-2
       F0FD                     _COMANL:
0023D6 F0FD C349D0          10      JP  COMANL
                                
       F100                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F100                     STABLE:
                                ;0
0023D9 F100 03F06ED77AD73CDD        DW  _SYS00,_SYS01,_SYS02,_SYS03
0023E1 F108 77D477D47FD709F0        DW  _SYS04,_SYS05,_SYS06,_SYS07
0023E9 F110 87D779D4D1D7FDD7        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
0023F1 F118 8ED493D4A2D4B3D4        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
0023F9 F120 07D54ED597D5C8D5        DW  _SYS10,_SYS11,_SYS12,_SYS13
002401 F128 D0D5E6D5FBD5F3D5        DW  _SYS14,_SYS15,_SYS16,_SYS17
002409 F130 42D647D64CD652D6        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
002411 F138 77D478D677D47CD6        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
002419 F140 77D432D63AD683D6        DW  _SYS20,_SYS21,_SYS22,_SYS23
002421 F148 A8D677D492E160E2        DW  _SYS24,_ERROR,_SYS26,_SYS27
002429 F150 3AD6B2D613D83CDD        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
002431 F158 13D83CDD77D4D3D6        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
002439 F160 CDD677D477D477D4        DW  _SYS30,_ERROR,_ERROR,_ERROR
002441 F168 77D477D477D477D4        DW  _ERROR,_ERROR,_ERROR,_ERROR
002449 F170 77D43CDD3CDDF4D6        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
002451 F178 5AD4                    DW  _DOS2
                                
002453 F17A                         DS  1
       F17B                     _MAX_SEC_SZ_H:
002454 F17B 04                      DB  MAX_SEC_SZ_H
       F17C                     _FATBF:
002455 F17C 30F3                    DW  FATBF
       F17E                     _DTBUF:
002457 F17E 30FB                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F180                     CTRLTB:
002459 F180 F5D8F5D82BD931DA        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
002461 F188 2BDA5CD91CDAB9D9        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002469 F190 01D91CD934DA8AD9        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
002471 F198 19DA72D946DAF5D8        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
002479 F1A0 F5D8F5D882D9F5D8        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
002481 F1A8 F5D8F5D8F5D8F5D8        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
002489 F1B0 F5D8F5D819DA91D9        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
002491 F1B8 E4D808D911D934DA        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
002499 F1C0 0200                M2D:    DW  2
00249B F1C2 FD02                    DB  0FDH,2
00249D F1C4 6401                    DW  356
00249F F1C6 FF0728090182            DB  0FFH,7,40,9,1,082H
0024A5 F1CC 0500A7000800            DW  5,0A7H,8
                                
0024AB F1D2 0200                M2HD:   DW  2
0024AD F1D4 FE01                    DB  0FEH,1
0024AF F1D6 C704                    DW  1223
0024B1 F1D8 FE064D080184            DB  0FEH,6,77,8,1,084H
0024B7 F1DE 0500A7000900            DW  5,0A7H,9
                                
0024BD F1E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
0024BF F1E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
0024C1 F1E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
0024C3 F1EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F1EE                     SDDATAE:
                                
0024C7 F1EE                         DS  2
       F1F0                     _FCB_BAT:
0024C9 F1F0 72EB                    DW  FCB_BAT
       F1F2                     _PATH:
0024CB F1F2 11EB                    DW  PATHD
                                
0024CD F1F4                     SCDIR:  DS  2       ;+14 +15
0024CF F1F6                     SFBPS:  DS  2       ;FBPS
0024D1 F1F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
0024D3 F1FA 0000                _FATPS: DW  0
0024D5 F1FC 0000                _DIRPS: DW  0
0024D7 F1FE 0000                _CLPS:  DW  0
                                
       F200                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "M7DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MZ-700/1500
                                
       F200                     _DEVICE:
                                
                                ;   A:
                                
0024D9 F200 0200                    DW  2   ;DPB_FATLN
0024DB F202 EBF0                    DW  _FDRD   ;DPB_DRD
0024DD F204 EEF0                    DW  _FDWT   ;DPB_DWT
0024DF F206 FD                      DB  0FDH    ;DPB_FATID
0024E0 F207 02                      DB  2   ;DPB_SECPCL
0024E1 F208 6401                    DW  356 ;DPB_MAXCL
0024E3 F20A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
0024E4 F20B 07                      DB  7   ;DPB_DIRSCNT
0024E5 F20C 28                      DB  40  ;DPB_MAXCYL
0024E6 F20D 09                      DB  9   ;DPB_MAXSEC Number of sectors
0024E7 F20E 01                      DB  1   ;DPB_FATPS
0024E8 F20F 82                      DB  082H    ;DPB_BPS
0024E9 F210 0500                    DW  5   ;DPB_DIRPS
0024EB F212 27                      DB  027H    ;DPB_DEVICE Device Number
0024EC F213 00                      DB  0   ;DPB_UNITNO
0024ED F214 0800                    DW  8   ;DPB_ADDCL
0024EF F216 0000                    DW  0   ;DPB_16
0024F1 F218 0000                    DW  0   ;DPB_18
0024F3 F21A 0000                    DW  0   ;DPB_SDIR
0024F5 F21C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
0024F9 F220 0200                    DW  2   ;DPB_FATLN
0024FB F222 EBF0                    DW  _FDRD   ;DPB_DRD
0024FD F224 EEF0                    DW  _FDWT   ;DPB_DWT
0024FF F226 FD                      DB  0FDH    ;DPB_FATID
002500 F227 02                      DB  2   ;DPB_SECPCL
002501 F228 6401                    DW  356 ;DPB_MAXCL
002503 F22A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
002504 F22B 07                      DB  7   ;DPB_DIRSCNT
002505 F22C 28                      DB  40  ;DPB_MAXCYL
002506 F22D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002507 F22E 01                      DB  1   ;DPB_FATPS
002508 F22F 82                      DB  082H    ;DPB_BPS
002509 F230 0500                    DW  5   ;DPB_DIRPS
00250B F232 27                      DB  027H    ;DPB_DEVICE Device Number
00250C F233 01                      DB  1   ;DPB_UNITNO
00250D F234 0800                    DW  8   ;DPB_ADDCL
00250F F236 0000                    DW  0   ;DPB_16
002511 F238 0000                    DW  0   ;DPB_18
002513 F23A 0000                    DW  0   ;DPB_SDIR
002515 F23C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002519 F240 0100                    DW  1   ;DPB_FATLN
00251B F242 ABEA                    DW  CDRD    ;DPB_DRD
00251D F244 98EA                    DW  CDWT    ;DPB_DWT
00251F F246 FA                      DB  0FAH    ;DPB_FATID
002520 F247 01                      DB  1   ;DPB_SECPCL
002521 F248 7A00                    DW  122 ;DPB_MAXCL
002523 F24A 00                      DB  0   ;DPB_FDMODE
002524 F24B 06                      DB  6   ;DPB_DIRSCNT
002525 F24C 00                      DB  0   ;DPB_MAXCYL
002526 F24D 00                      DB  0   ;DPB_MAXSEC
002527 F24E 01                      DB  1   ;DPB_FATPS
002528 F24F 01                      DB  1   ;DPB_BPS
002529 F250 0200                    DW  2   ;DPB_DIRPS
00252B F252 0C                      DB  00CH    ;DPB_DEVICE
00252C F253 F8                      DB  0F8H    ;DPB_UNITNO
00252D F254 0600                    DW  6   ;DPB_ADDCL
00252F F256 0000                    DW  0   ;DPB_16
002531 F258 0000                    DW  0   ;DPB_18
002533 F25A 0000                    DW  0   ;DPB_SDIR
002535 F25C 434D4F53                DB  "CMOS"  ;DPB_NAME
                                
                                ;   D:
                                
002539 F260                         DS  32
                                
                                ;   E:
                                
       F280                     EMMFL:
002559 F280 0000                    DW  0   ;DPB_FATLN
00255B F282 62EA                    DW  EDRD    ;DPB_DRD
00255D F284 55EA                    DW  EDWT    ;DPB_DWT
00255F F286 FA                      DB  0FAH    ;DPB_FATID
002560 F287 02                      DB  2   ;DPB_SECPCL
002561 F288 0000                    DW  0   ;DPB_MAXCL
002563 F28A 00                      DB  0   ;DPB_FDMODE
002564 F28B 10                      DB  16  ;DPB_DIRSCNT
002565 F28C 00                      DB  0   ;DPB_MAXCYL
002566 F28D 00                      DB  0   ;DPB_MAXSEC
002567 F28E 01                      DB  1   ;DPB_FATPS
002568 F28F 01                      DB  1   ;DPB_BPS
002569 F290 0000                    DW  0   ;DPB_DIRPS
00256B F292 26                      DB  026H    ;DPB_DEVICE
00256C F293 00                      DB  0   ;DPB_UNITNO
00256D F294 0000                    DW  0   ;DPB_ADDCL
00256F F296 0000                    DW  0   ;DPB_16
002571 F298 0000                    DW  0   ;DPB_18
002573 F29A 0000                    DW  0   ;DPB_SDIR
002575 F29C 454D4D30                DB  "EMM0"  ;DPB_NAME
                                
                                ;   F:
                                
002579 F2A0 0200                    DW  2   ;DPB_FATLN
00257B F2A2 C2EA                    DW  RDRD    ;DPB_DRD
00257D F2A4 BEEA                    DW  RDWT    ;DPB_DWT
00257F F2A6 FA                      DB  0FAH    ;DPB_FATID
002580 F2A7 01                      DB  1   ;DPB_SECPCL
002581 F2A8 F600                    DW  246 ;DPB_MAXCL
002583 F2AA 00                      DB  0   ;DPB_FDMODE
002584 F2AB 09                      DB  9   ;DPB_DIRSCNT
002585 F2AC 00                      DB  0   ;DPB_MAXCYL
002586 F2AD 00                      DB  0   ;DPB_MAXSEC
002587 F2AE 01                      DB  1   ;DPB_FATPS
002588 F2AF 01                      DB  1   ;DPB_BPS
002589 F2B0 0300                    DW  3   ;DPB_DIRPS
00258B F2B2 0F                      DB  00FH    ;DPB_DEVICE
00258C F2B3 00                      DB  0   ;DPB_UNITNO
00258D F2B4 0A00                    DW  10  ;DPB_ADDCL
00258F F2B6 0000                    DW  0   ;DPB_16
002591 F2B8 0000                    DW  0   ;DPB_18
002593 F2BA 0000                    DW  0   ;DPB_SDIR
002595 F2BC 52414D46                DB  "RAMF"  ;DPB_NAME
                                
                                ;   G:
       F2C0                     GRAMFL:
002599 F2C0 0100                    DW  1   ;DPB_FATLN
00259B F2C2 EDEA                    DW  GDRD    ;DPB_DRD
00259D F2C4 D8EA                    DW  GDWT    ;DPB_DWT
00259F F2C6 FA                      DB  0FAH    ;DPB_FATID
0025A0 F2C7 01                      DB  1   ;DPB_SECPCL
0025A1 F2C8 5A00                    DW  90  ;DPB_MAXCL
0025A3 F2CA 00                      DB  0   ;DPB_FDMODE
0025A4 F2CB 06                      DB  6   ;DPB_DIRSCNT
0025A5 F2CC 00                      DB  0   ;DPB_MAXCYL
0025A6 F2CD 00                      DB  0   ;DPB_MAXSEC
0025A7 F2CE 01                      DB  1   ;DPB_FATPS
0025A8 F2CF 01                      DB  1   ;DPB_BPS
0025A9 F2D0 0200                    DW  2   ;DPB_DIRPS
0025AB F2D2 05                      DB  005H    ;DPB_DEVICE
0025AC F2D3 F8                      DB  0F8H    ;DPB_UNITNO
0025AD F2D4 0600                    DW  6   ;DPB_ADDCL
0025AF F2D6 0000                    DW  0   ;DPB_16
0025B1 F2D8 0000                    DW  0   ;DPB_18
0025B3 F2DA 0000                    DW  0   ;DPB_SDIR
0025B5 F2DC 4752414D                DB  "GRAM"  ;DPB_NAME
                                
                                ;   H:
0025B9 F2E0                         DS  3
0025BC F2E3 00                      DB  0
[EOF:M7DPB.ASM:UTF_8]
                                
       A5BD                     LAST_ADR    EQU $$+OFFSET
                                
                                    END
[EOF:M7.ASM:UTF_8]
