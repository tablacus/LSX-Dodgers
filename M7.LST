                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for MZ-700/1500
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "M7DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MZ-700/1500
                                
       0001                     MAC EQU 1   ;MZ-700/1500
       0000                     DEV EQU 0
                                
       011D                     VER_6F  EQU 0011DH
                                
       8080                     RUN EQU 08080H
       8000                     OFFSET  EQU RUN-128
       CF06                     BDOS    EQU 0CF06H
       F000                     WORKAD  EQU 0F000H
       ED40                     TABLEAD EQU 0ED40H
       F300                     KEYBF   EQU 0F300H
       F330                     FATBF   EQU 0F330H
       FB30                     DTBUF   EQU 0FB30H
       FF30                     KBUF    EQU 0FF30H
       FFD9                     TRAP38  EQU 0FFD9H
       0028                     WIDTH   EQU 40
       0019                     LINE    EQU 25
       0070                     COLORF  EQU 070H
       0014                     KEYSP_H EQU 20
       0083                     KEYSP_L EQU 131
       0009                     COMS    EQU 9
       0004                     MAX_SEC_SZ_H    EQU 4       ;1セクタ1024バイトのサポート(2:off 4:on)
       0100                     BUFFER  EQU 00100H
       D0E7                     S27BUF_COM  EQU S27BUF
[EOF:M7DEF.ASM:SHIFT_JIS]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0002                     VER_3   EQU 2
       1D01                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0001                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0162                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 8000                         ORG OFFSET
                                                    ;MZTヘッダ128バイト
000000 8000 01                      DB  1           ;ファイルモード
000001 8001 4C44202020202020        DB  "LD           "     ;ファイル名(13)
            2020202020          
00000E 800E 535953                  DB  "SYS"           ;拡張子(3)
000011 8011 0D                      DB  $0D
000012 8012 4625                    DW  LAST_ADR-RUN        ;サイズ
000014 8014 8080                    DW  RUN         ;開始アドレス
000016 8016 8080                    DW  RUN         ;実行アドレス
000018 8018                         DS  104
                                
                                    INCLUDE "M7INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   MZ-700/1500
                                
000080 8080 C38780          10      JP  START
000083 8083 011D                    DW  MACW
000085 8085 6201                    DW  VER
                                
       8087                     START:
000087 8087 F3               4      DI
000088 8088 ED56             8      IM  1
00008A 808A 318780          10      LD  SP,START
00008D 808D CD9B80          17      CALL    INIT        ;NZならAUTOEXECを実行
000090 8090 210000          10      LD  HL,0
000093 8093 E5              11      PUSH    HL
000094 8094 C8              11      RET Z
000095 8095 118081          10      LD  DE,AUTOD
000098 8098 C3FDF0          10      JP  _COMANL
                                
       809B                     INIT:
00009B 809B D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFFH)
00009D 809D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00009F 809F 21E881          10      LD  HL,INITE
0000A2 80A2 1106CF          10      LD  DE,BDOS
0000A5 80A5 01DE23          10      LD  BC,LAST_ADR-INITE
0000A8 80A8 EDB0                    LDIR
0000AA 80AA 21B781          10      LD  HL,M7BEEPD
0000AD 80AD 1162F0          10      LD  DE,BEEPD+1
0000B0 80B0 010A00          10      LD  BC,M7BEEPE-M7BEEPD
0000B3 80B3 EDB0                    LDIR
                                
0000B5 80B5 210000          10      LD  HL,0
0000B8 80B8 065C             7      LD  B,05CH
0000BA 80BA 3E                      DB  03EH    ;LD A,??
0000BB 80BB EF              12      RST 28H
0000BC 80BC CD3FDC          17      CALL    FILL_MEMORY
0000BF 80BF 06A4             7      LD  B,0A4H
0000C1 80C1 AF               4      XOR A
0000C2 80C2 320400          13      LD  (_DVSW),A
0000C5 80C5 CD3FDC          17      CALL    FILL_MEMORY
                                
0000C8 80C8 3EC3             7      LD  A,0C3H      ;JP
0000CA 80CA 2103F0          10      LD  HL,CPM_WBOOT
0000CD 80CD 320000          13      LD  (00000H),A
0000D0 80D0 220100          16      LD  (00001H),HL ;IPL
                                
0000D3 80D3 2106CF          10      LD  HL,BDOS
0000D6 80D6 320500          13      LD  (00005H),A
0000D9 80D9 220600          16      LD  (00006H),HL ;BDOS
                                
0000DC 80DC 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000DF 80DF 322800          13      LD  (00028H),A
0000E2 80E2 222900          16      LD  (00029H),HL ;RST 028H
                                
0000E5 80E5 323800          13      LD  (00038H),A
0000E8 80E8 21C9CF          10      LD  HL,IO_INT8253
0000EB 80EB 223900          16      LD  (00039H),HL
                                
0000EE 80EE 215BF0          10      LD  HL,_DISKE+1
0000F1 80F1 2223F3          16      LD  (DISKVE),HL
0000F4 80F4 21F5F0          10      LD  HL,_BREAK+1
0000F7 80F7 2225F3          16      LD  (BREAKV),HL
                                
0000FA 80FA 3EF0             7      LD  A,CPM_BOOT/256
0000FC 80FC 320B00          13      LD  (0000BH),A
                                
0000FF 80FF 3EE9             7      LD  A,0E9H      ;JP (HL)
000101 8101 320F00          13      LD  (0000FH),A
                                                ;CHECK PCG(MZ-1500)
000104 8104 2100E8          10      LD  HL,0E800H
000107 8107 46               7      LD  B,(HL)
000108 8108 F3               4      DI
000109 8109 3E01             7      LD  A,1
00010B 810B D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00010D 810D 4E               7      LD  C,(HL)
00010E 810E 79               4      LD  A,C
00010F 810F C6A5             7      ADD A,0A5H
000111 8111 5F               4      LD  E,A
000112 8112 73               7      LD  (HL),E
000113 8113 D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
000115 8115 71               7      LD  (HL),C
000116 8116 3E01             7      LD  A,1
000118 8118 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00011A 811A 7E               7      LD  A,(HL)
00011B 811B BB               4      CP  E
00011C 811C D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
00011E 811E 70               7      LD  (HL),B
00011F 811F FB               4      EI
000120 8120 2804            12      JR  Z,MZ1500
000122 8122 AF               4      XOR A       ;MZ-700はPCGバンクが存在しない
000123 8123 32C0F2          13      LD  (GRAMFL),A
       8126                     MZ1500:
000126 8126 DD2180F2        14      LD  IX,EMMFL
00012A 812A CD7581          17      CALL    CHECK_EMM_BPB
00012D 812D FEEB             7      CP  0EBH
00012F 812F 2817            12      JR  Z,EMM_BPB
000131 8131 DD360D02        19      LD  (IX+DPB_MAXSEC),2   ;BPBが512バイト目から始まる場合を調べる
000135 8135 CD7581          17      CALL    CHECK_EMM_BPB
000138 8138 DDBE06          19      CP  (IX+DPB_FATID)
00013B 813B 200B            12      JR  NZ,EMM_BPB
00013D 813D DD360D00        19      LD  (IX+DPB_MAXSEC),0   ;BPBが先頭の場合に戻す
                                
000141 8141 2103E0          10      LD  HL,0E003H       ;SOUND MASK (MZ-1500)
000144 8144 AF               4      XOR A
000145 8145 CD4BCF          17      CALL    WRMMIO
       8148                     EMM_BPB:
000148 8148 218C81          10      LD  HL,INIMES
00014B 814B CD8AD4          17      CALL    MSX
       814E                     INIT1:
00014E 814E F3               4      DI
00014F 814F 1100FF          10      LD  DE,0FF00H
000152 8152 0600             7      LD  B,0
000154 8154 CD29D3          17      CALL    ZERO_MEMORY_DE
000157 8157 21CAFF          10      LD  HL,EXTBIO
00015A 815A 36C9            10      LD  (HL),0C9H   ;RET
00015C 815C 23               6      INC HL
00015D 815D 060E             7      LD  B,TRAP38-EXTBIO-1
00015F 815F 3E                      DB  03EH    ;LD A,??
000160 8160 EF              12      RST 28H
000161 8161 CD3FDC          17      CALL    FILL_MEMORY
000164 8164 21C181          10      LD  HL,AT_TRAP38
000167 8167 11D9FF          10      LD  DE,TRAP38
00016A 816A 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
00016D 816D EDB0                    LDIR
                                
00016F 816F CDF2DA          17      CALL    CHKEY
000172 8172 FE03             7      CP  3
000174 8174 C9              10      RET
                                
       8175                     CHECK_EMM_BPB:
000175 8175 D5              11      PUSH    DE
000176 8176 110000          10      LD  DE,0
000179 8179 CD6BEA          17      CALL    EADR
00017C 817C D1              10      POP DE
00017D 817D ED78            12      IN  A,(C)
00017F 817F C9              10      RET
                                
000180 8180 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000189 8189 413A00              AUTODV: DB  "A:",0
                                
00018C 818C 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MZ-700/1500 v"
            6765727320666F72    
            204D5A2D3730302F    
            313530302076        
0001AA 81AA 312E                    DB  030H + VER_1, '.'
0001AC 81AC 3632                    DB  030H + VER_2 ,030H + VER_3
0001AE 81AE 62                      DB  'b'
0001AF 81AF 2047616B750D0A          DB  " Gaku",0DH,0AH
0001B6 81B6 00                      DB  0
                                
       81B7                     M7BEEPD:
0001B7 81B7 0801                    DB  8,1
0001B9 81B9 0736                    DB  7,036H
0001BB 81BB 04F9                    DB  4,0F9H
0001BD 81BD 0403                    DB  4,3
0001BF 81BF 0301                    DB  3,1         ;SOUND MASK(MZ-1500)
       81C1                     M7BEEPE:
                                
       81C1                     AT_TRAP38:
0001C1 FFD9                         ORG TRAP38,AT_TRAP38-OFFSET
0001C1 FFD9 210000          10      LD  HL,0
0001C4 FFDC E3              19      EX  (SP),HL
0001C5 FFDD 3E24             7      LD  A,'$'
0001C7 FFDF CD1ED7          17      CALL    MSG_A
0001CA FFE2 2B               6      DEC HL
0001CB FFE3 7C               4      LD  A,H
0001CC FFE4 CDE8FF          17      CALL    PRHX
0001CF FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
0001D0 FFE8 F5              11      PUSH    AF
0001D1 FFE9 07               4      RLCA
0001D2 FFEA 07               4      RLCA
0001D3 FFEB 07               4      RLCA
0001D4 FFEC 07               4      RLCA
0001D5 FFED CDF1FF          17      CALL    PRHX2
0001D8 FFF0 F1              10      POP AF
       FFF1                     PRHX2:
0001D9 FFF1 E60F             7      AND 00FH
0001DB FFF3 FE0A             7      CP  10
0001DD FFF5 3F               4      CCF
0001DE FFF6 CE30             7      ADC A,'0'
0001E0 FFF8 27               4      DAA
0001E1 FFF9 C31ED7          10      JP  MSG_A
0001E4 FFFC                         DS  4
0001E8 81E8                         ORG $$+OFFSET,$$    ;$DEPHASE
       81E8                     AT_TRAPE:
                                
       81E8                     INITE:
0001E8 CF06                         ORG BDOS,INITE-OFFSET
                                
0001E8 CF06 C309CF          10      JP  IO_BDOS
[EOF:M7INIT.ASM:SHIFT_JIS]
                                    INCLUDE "M7BANK.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                ;   VRAM/KEY/TIMER(0D000H-0EFFFH)にアクセスするので0D000H-0FFFFHに置けない部分
                                ;
                                
       CF09                     IO_BDOS:
0001EB CF09 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001ED CF0B C34BD4          10      JP  BDOS0
                                
       CF0E                     IO_CLR:
0001F0 CF0E D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF10                     C1AX1:
0001F2 CF10 7A               4      LD  A,D
0001F3 CF11 C6D0             7      ADD A,0D0H
0001F5 CF13 57               4      LD  D,A
0001F6 CF14 AF               4      XOR A
0001F7 CF15 12               7      LD  (DE),A      ;Text
0001F8 CF16 CBDA             8      SET 3,D
0001FA CF18 3E00             7      LD  A,0     ;自己書き換え
                                                ;BDOS0+13Hが外部から書き換えされても動くようにする
       CF19                     ICSMC   EQU $-1
0001FC CF1A 12               7      LD  (DE),A      ;Color
0001FD CF1B 13               6      INC DE
0001FE CF1C 7A               4      LD  A,D
0001FF CF1D D6D8             7      SUB 0D8H
000201 CF1F 57               4      LD  D,A
000202 CF20 2118FC          10      LD  HL,0-WIDTH*LINE
       CF21                     _NEG_PAGE_SWC   EQU $-2
000205 CF23 19              11      ADD HL,DE
000206 CF24 30EA            12      JR  NC,C1AX1
000208 CF26 E1              10      POP HL
000209 CF27 D1              10      POP DE
00020A CF28 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00020C CF2A FB               4      EI
00020D CF2B C9              10      RET
                                
       CF2C                     RDKEYDATA:
00020E CF2C F3               4      DI
00020F CF2D D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000211 CF2F 3200E0          13      LD  (0E000H),A
000214 CF32 3A01E0          13      LD  A,(E001H)
000217 CF35 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000219 CF37 FB               4      EI
00021A CF38 C9              10      RET
                                
       CF39                     RD556VSYNC:
00021B CF39 F3               4      DI
00021C CF3A D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00021E CF3C 3A02E0          13      LD  A,(0E002H)
000221 CF3F D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000223 CF41 FB               4      EI
000224 CF42 C9              10      RET
                                
       CF43                     RDMMIO:
000225 CF43 F3               4      DI
000226 CF44 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000228 CF46 7E               7      LD  A,(HL)
000229 CF47 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00022B CF49 FB               4      EI
00022C CF4A C9              10      RET
                                
       CF4B                     WRMMIO:
00022D CF4B F3               4      DI
00022E CF4C D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000230 CF4E 77               7      LD  (HL),A
000231 CF4F D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000233 CF51 FB               4      EI
000234 CF52 C9              10      RET
                                
       CF53                     RDMMIO_BC:
000235 CF53 F3               4      DI
000236 CF54 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000238 CF56 0A               7      LD  A,(BC)
000239 CF57 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00023B CF59 FB               4      EI
00023C CF5A C9              10      RET
                                
       CF5B                     WRMMIO_BC:
00023D CF5B F3               4      DI
00023E CF5C D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000240 CF5E 02               7      LD  (BC),A
000241 CF5F D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000243 CF61 FB               4      EI
000244 CF62 C9              10      RET
                                
       CF63                     IO_PRINT:
000245 CF63 F3               4      DI
000246 CF64 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000248 CF66 77               7      LD  (HL),A
000249 CF67 CBDC             8      SET 3,H
00024B CF69 71               7      LD  (HL),C
00024C CF6A D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00024E CF6C FB               4      EI
00024F CF6D C9              10      RET
                                
       CF6E                     IO_CLLINE:
000250 CF6E F3               4      DI
000251 CF6F D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF71                     CLLINE1:
000253 CF71 CB9C             8      RES 3,H
000255 CF73 77               7      LD  (HL),A      ;Text
000256 CF74 CBDC             8      SET 3,H
000258 CF76 71               7      LD  (HL),C      ;Color
000259 CF77 23               6      INC HL
00025A CF78 10F7            13      DJNZ    CLLINE1
00025C CF7A D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00025E CF7C FB               4      EI
00025F CF7D C9              10      RET
                                
       CF7E                     IO_INSBS:
000260 CF7E F3               4      DI
000261 CF7F D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF81                     IO_INSBS1:
000263 CF81 CB9C             8      RES 3,H
000265 CF83 5E               7      LD  E,(HL)
000266 CF84 77               7      LD  (HL),A
000267 CF85 7B               4      LD  A,E
000268 CF86 CBDC             8      SET 3,H
00026A CF88 5E               7      LD  E,(HL)
00026B CF89 71               7      LD  (HL),C
00026C CF8A 4B               4      LD  C,E
       CF8B                     IO_INCDEC   EQU $   ; 自己書き換え
00026D CF8B 23               6      INC HL      ;INS->INC HL or BS->DEC HL
00026E CF8C 10F3            13      DJNZ    IO_INSBS1
000270 CF8E D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000272 CF90 FB               4      EI
000273 CF91 C9              10      RET
                                
       CF92                     IO_SCRUP:
000274 CF92 F3               4      DI
000275 CF93 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF95                     SCRUP1:
000277 CF95 2815            12      JR  Z,SCRCL
000279 CF97 D5              11      PUSH    DE
00027A CF98 E5              11      PUSH    HL
00027B CF99 CBDA             8      SET 3,D
00027D CF9B CBDC             8      SET 3,H
00027F CF9D 012800          10      LD  BC,WIDTH
000282 CFA0 EDB0                    LDIR
000284 CFA2 E1              10      POP HL
000285 CFA3 D1              10      POP DE
000286 CFA4 012800          10      LD  BC,WIDTH
000289 CFA7 EDB0                    LDIR
00028B CFA9 3D               4      DEC A
00028C CFAA 18E9            12      JR  SCRUP1
                                
       CFAC                     SCRCL:
00028E CFAC 0628             7      LD  B,WIDTH
000290 CFAE EB               4      EX  DE,HL
000291 CFAF D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000293 CFB1 CD10D9          17      CALL    CLLINE
000296 CFB4 E1              10      POP HL
000297 CFB5 D1              10      POP DE
000298 CFB6 C1              10      POP BC
000299 CFB7 C9              10      RET
                                
       CFB8                     RD_PCG:
00029A CFB8 F3               4      DI
00029B CFB9 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00029D CFBB 4E               7      LD  C,(HL)
       CFBC                     RW_PCG:
00029E CFBC D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
0002A0 CFBE FB               4      EI
0002A1 CFBF C9              10      RET
                                
       CFC0                     WR_PCG:
0002A2 CFC0 F3               4      DI
0002A3 CFC1 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
0002A5 CFC3 71               7      LD  (HL),C
0002A6 CFC4 18F6            12      JR  RW_PCG
                                
       CFC6                     IO_MON:
0002A8 CFC6 D3E4            11      OUT (0E4H),A    ;MONITOR ROM(0000H-0FFFH) & VRAM/KEY/TIMER(D000H-FFFFH)
0002AA CFC8 C7              12      RST 0
                                
                                #IF EXISTS USE_8253
                                INITINT:
                                    OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
                                    LD  HL,0E007H   ;HL=0E007H 8253 コントロール
                                    LD  (HL),0B0H   ;Ch.2 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 0 16ビットバイナリ
                                    LD  (HL),074H   ;Ch.1 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 2 16ビットバイナリ
                                    DEC L       ;0E006H 8253 Ch.2 カウンタ
                                    LD  (HL),2
                                    LD  (HL),0
                                    DEC L       ;0E005H 8253 Ch.1 カウンタ
                                    LD  (HL),A
                                    LD  (HL),0
                                    LD  A,L     ;L=5
                                    LD  (0E003H),A  ;8255 コントロールポートでポートC(0E002H)のINTMSKを1にする
                                    OUT (0E1H),A    ;DRAM(D000H-FFFFH)
                                    RET
                                #ENDIF
                                
       CFC9                     IO_INT8253:
                                #IF EXISTS USE_8253
                                    PUSH    AF
                                    LD  A,(EXTBIO)
                                    LD  (INTMEM_SWC),A
                                    OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
                                    LD  A,1
                                    LD  (0E006H),A  ;8253 Ch.2 カウンタ
                                    XOR A
                                    LD  (0E006H),A  ;8253 Ch.2 カウンタ
                                    OUT (0E1H),A    ;DRAM(D000H-FFFFH)
                                    JP  INT8253
                                ROM8253E:
                                    OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
                                    POP AF
                                #ENDIF
0002AB CFC9 C9              10      RET
                                
       CFCA                     BANKE:
0002AC CFCA                         DS  0CFFEH-BANKE
[EOF:M7BANK.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MZ-700/1500
                                
       CFFE                     WBOOT1:
0002E0 CFFE D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)　ここは0CFFEH
0002E2 D000 D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFHH)
0002E4 D002 F3               4      DI
0002E5 D003 3A94F0          13      LD  A,(_KEYSP_L)
                                #IF EXISTS USE_8253
                                    CALL    INITINT
                                #ENDIF
0002E8 D006 ED7B0600        20      LD  SP,(SYSTEM+1)
0002EC D00A FB               4      EI
0002ED D00B 2ABAF0          16      LD  HL,(_PAGE_MINUS)
0002F0 D00E 2221CF          16      LD  (_NEG_PAGE_SWC),HL
0002F3 D011 2192F0          10      LD  HL,_KEYD
0002F6 D014 3600            10      LD  (HL),0
0002F8 D016 CDF2DA          17      CALL    CHKEY
0002FB D019 CD1AD7          17      CALL    KEYBC_IFBREAK
0002FE D01C 3E04             7      LD  A,4
000300 D01E CD1ED7          17      CALL    MSG_A
[EOF:M7CCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D021                     COMMAND:
000303 D021 3A69EB          13      LD  A,(FCB_BAT)
000306 D024 B7               4      OR  A
000307 D025 C263D1          10      JP  NZ,C_BAT1
00030A D028 CDD7D0          17      CALL    SETDTA1
00030D D02B 3A0400          13      LD  A,(_DVSW)
000310 D02E C641             7      ADD A,'A'
000312 D030 CD1ED7          17      CALL    MSG_A
000315 D033 3E3E             7      LD  A,'>'
000317 D035 CD1ED7          17      CALL    MSG_A
00031A D038 3E50             7      LD  A,80
00031C D03A 12               7      LD  (DE),A
00031D D03B CD7AD7          17      CALL    _SYS0A      ;(BDOS)文字列入力
000320 D03E CD58D2          17      CALL    LTNL
       D041                     COMMAND2:
000323 D041 118200          10      LD  DE,DTA1+2
000326 D044 CDFDF0          17      CALL    _COMANL
000329 D047 DC0ED7          17      CALL    C,SHOW_ERROR
00032C D04A 18D5            12      JR  COMMAND
                                
       D04C                     COMANL:
00032E D04C CD94DB          17      CALL    FILE
000331 D04F 3A19F0          13      LD  A,(FNAME+4)
000334 D052 FE20             7      CP  020H
000336 D054 201C            12      JR  NZ,COMB2
000338 D056 D5              11      PUSH    DE
000339 D057 1115F0          10      LD  DE,FNAME
00033C D05A 1A               7      LD  A,(DE)
00033D D05B FE20             7      CP  020H
00033F D05D 2844            12      JR  Z,SDVSW
000341 D05F 1B               6      DEC DE
000342 D060 1A               7      LD  A,(DE)
000343 D061 C6FF             7      ADD A,0FFH
000345 D063 3809            12      JR  C,COMB
000347 D065 13               6      INC DE
                                
000348 D066 2115D4          10      LD  HL,COMTB
00034B D069 0609             7      LD  B,COMS
00034D D06B CD21DE          17      CALL    CPNAME
       D06E                     COMB:
000350 D06E D1              10      POP DE
000351 D06F D20DD7          10      JP  NC,JPHL
       D072                     COMB2:
000354 D072 EB               4      EX  DE,HL
000355 D073 2240D1          16      LD  (COMSWC),HL
000358 D076 F5              11      PUSH    AF
000359 D077 CDF8D0          17      CALL    CEXE4
00035C D07A F1              10      POP AF
00035D D07B 2115F0          10      LD  HL,FNAME
000360 D07E 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
000363 D081 010B00          10      LD  BC,11
000366 D084 EDB0                    LDIR
000368 D086 1108EB          10      LD  DE,PATHD
       D089                     CEX1:
00036B D089 1A               7      LD  A,(DE)
00036C D08A FE20             7      CP  020H
00036E D08C D8              11      RET C
00036F D08D CD89DB          17      CALL    FILEC
000372 D090 D5              11      PUSH    DE
000373 D091 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
000376 D094 1115F0          10      LD  DE,FNAME
000379 D097 010B00          10      LD  BC,11
00037C D09A EDB0                    LDIR
00037E D09C CDF8D0          17      CALL    CEXE4
000381 D09F D1              10      POP DE
000382 D0A0 13               6      INC DE
000383 D0A1 18E6            12      JR  CEX1
                                
       D0A3                     SDVSW:
000385 D0A3 F1              10      POP AF
000386 D0A4 3A14F0          13      LD  A,(FDRV)
000389 D0A7 3D               4      DEC A
00038A D0A8 5F               4      LD  E,A
00038B D0A9 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
00038D D0AB 1831            12      JR  SYSTEM0
                                
       D0AD                     OPEN1:
00038F D0AD 2114F0          10      LD  HL,FDRV
       D0B0                     OPEN:
000392 D0B0 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D0B2                     OPEN3:
000394 D0B2 D5              11      PUSH    DE
000395 D0B3 1144EB          10      LD  DE,DTA_CCP
000398 D0B6 CDD4D0          17      CALL    SETDTA
00039B D0B9 EB               4      EX  DE,HL
00039C D0BA CDDED0          17      CALL    SYSTEM0
00039F D0BD D1              10      POP DE
0003A0 D0BE C9              10      RET
                                
       D0BF                     OPEN2:
0003A1 D0BF 0E12             7      LD  C,012H
0003A3 D0C1 18EF            12      JR  OPEN3
                                
       D0C3                     DEFCB:              ;Z=Ok NZ=Error
0003A5 D0C3 1144EB          10      LD  DE,DTA_CCP
0003A8 D0C6 CDDCD0          17      CALL    SYSC0F
                                
0003AB D0C9 1165EB          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0003AE D0CC 0604             7      LD  B,4
0003B0 D0CE CD29D3          17      CALL    ZERO_MEMORY_DE
       D0D1                     SETDTA100:
0003B3 D0D1 110001          10      LD  DE,BUFFER
       D0D4                     SETDTA:
0003B6 D0D4 C34ED6          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D0D7                     SETDTA1:
0003B9 D0D7 118000          10      LD  DE,DTA1
0003BC D0DA 18F8            12      JR  SETDTA
                                
       D0DC                     SYSC0F:
0003BE D0DC 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D0DE                     SYSTEM0:
0003C0 D0DE CD0500          17      CALL    SYSTEM
0003C3 D0E1 B7               4      OR  A
0003C4 D0E2 C9              10      RET
                                
       D0E3                     C_CD:
0003C5 D0E3 0E5A             7      LD  C,05AH
0003C7 D0E5 18F7            12      JR  SYSTEM0
                                
       D0E7                     S27BUF:
0003C9 D0E7 2100FE          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       D0EA                     S27BUF2:
0003CC D0EA 39              11      ADD HL,SP
0003CD D0EB 2E00             7      LD  L,0
0003CF D0ED 7C               4      LD  A,H
0003D0 D0EE E6F8             7      AND 0F8H
0003D2 D0F0 67               4      LD  H,A
       D0F1                     S27DTA:
0003D3 D0F1 1144EB          10      LD  DE,DTA_CCP
       D0F4                     S27:
0003D6 D0F4 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
0003D8 D0F6 18E6            12      JR  SYSTEM0
                                
       D0F8                     CEXE4:
0003DA D0F8 211DF0          10      LD  HL,FNAME+8
0003DD D0FB 7E               7      LD  A,(HL)
0003DE D0FC FE20             7      CP  020H
0003E0 D0FE 2007            12      JR  NZ,CEXE7
0003E2 D100 3E3F             7      LD  A,'?'
0003E4 D102 77               7      LD  (HL),A
0003E5 D103 23               6      INC HL
0003E6 D104 77               7      LD  (HL),A
0003E7 D105 23               6      INC HL
0003E8 D106 77               7      LD  (HL),A
       D107                     CEXE7:
0003E9 D107 CDADD0          17      CALL    OPEN1
       D10A                     CEXE5:
0003EC D10A C0              11      RET NZ
0003ED D10B 2A4EEB          16      LD  HL,(DTA_CCP+1+9)
0003F0 D10E 7C               4      LD  A,H
0003F1 D10F CDB0DE          17      CALL    CAP
0003F4 D112 67               4      LD  H,A
0003F5 D113 7D               4      LD  A,L
0003F6 D114 CDB0DE          17      CALL    CAP
0003F9 D117 6F               4      LD  L,A
0003FA D118 3A4DEB          13      LD  A,(DTA_CCP+1+8)
0003FD D11B CDB0DE          17      CALL    CAP
000400 D11E D642             7      SUB 'B'
000402 D120 282C            12      JR  Z,C_BAT
000404 D122 3D               4      DEC A       ;'C'
000405 D123 2805            12      JR  Z,C_EXE
       D125                     CEXE6:
000407 D125 CDBFD0          17      CALL    OPEN2
00040A D128 18E0            12      JR  CEXE5
                                
       D12A                     C_EXE:
00040C D12A 7C               4      LD  A,H
00040D D12B FE4D             7      CP  'M'
00040F D12D 20F6            12      JR  NZ,CEXE6
                                
000411 D12F CDC3D0          17      CALL    DEFCB
000414 D132 CDE7D0          17      CALL    S27BUF_COM
000417 D135 3D               4      DEC A
000418 D136 37               4      SCF
000419 D137 C0              11      RET NZ
00041A D138 7C               4      LD  A,H
00041B D139 B5               4      OR  L
00041C D13A 37               4      SCF
00041D D13B C8              11      RET Z
00041E D13C CDD7D0          17      CALL    SETDTA1
000421 D13F 110000          10      LD  DE,0                ; self-modifying code
       D140                     COMSWC  EQU $-2
000424 D142 ED7B0600        20      LD  SP,(SYSTEM+1)
000428 D146 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000429 D147 6F               4      LD  L,A
00042A D148 E5              11      PUSH    HL              ; push $0000 (reboot address)
00042B D149 24               4      INC H
00042C D14A E5              11      PUSH    HL              ; push $0100 (TPA address)
00042D D14B C3F4D2          10      JP  SETFCB              ; and JP $0100
                                
       D14E                     C_BAT:
000430 D14E 114154          10      LD  DE,'A'+'T'*256
000433 D151 ED52            15      SBC HL,DE
000435 D153 20D0            12      JR  NZ,CEXE6
                                
000437 D155 CDC3D0          17      CALL    DEFCB
                                
00043A D158 2144EB          10      LD  HL,DTA_CCP
00043D D15B 1169EB          10      LD  DE,FCB_BAT
000440 D15E 012500          10      LD  BC,37
000443 D161 EDB0                    LDIR
       D163                     C_BAT1:
000445 D163 CDD1D0          17      CALL    SETDTA100
000448 D166 CD9AD1          17      CALL    FGETC_BAT
00044B D169 218100          10      LD  HL,DTA1+1
00044E D16C 2025            12      JR  NZ,END_BATCH
000450 D16E FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
000452 D170 38F1            12      JR  C,C_BAT1
000454 D172 3620            10      LD  (HL),' '
000456 D174 23               6      INC HL
       D175                     C_BAT2:
000457 D175 77               7      LD  (HL),A
000458 D176 23               6      INC HL
000459 D177 7D               4      LD  A,L
00045A D178 3C               4      INC A       ;L==0FFH
00045B D179 2809            12      JR  Z,RUN_BATCH
00045D D17B CD9AD1          17      CALL    FGETC_BAT
000460 D17E 2004            12      JR  NZ,RUN_BATCH
000462 D180 FE20             7      CP  020H
000464 D182 30F1            12      JR  NC,C_BAT2
       D184                     RUN_BATCH:
000466 D184 7D               4      LD  A,L
000467 D185 D67F             7      SUB DTA1-1
000469 D187 328000          13      LD  (DTA1),A
00046C D18A FE04             7      CP  4
00046E D18C 3805            12      JR  C,END_BATCH
000470 D18E 3600            10      LD  (HL),0
000472 D190 C341D0          10      JP  COMMAND2
       D193                     END_BATCH:
000475 D193 AF               4      XOR A       ;バッチファイルを閉じる
000476 D194 3269EB          13      LD  (FCB_BAT),A
000479 D197 C300F0          10      JP  CPM_BOOT
                                
       D19A                     FGETC_BAT:
00047C D19A 1169EB          10      LD  DE,FCB_BAT
       D19D                     FGETC:              ;1文字ずつ読み込む
00047F D19D E5              11      PUSH    HL      ;Z:成功
000480 D19E 210100          10      LD  HL,1
000483 D1A1 CDF4D0          17      CALL    S27
000486 D1A4 E1              10      POP HL
000487 D1A5 3A0001          13      LD  A,(BUFFER)
00048A D1A8 C9              10      RET
                                
       D1A9                     C_DEL:
00048B D1A9 CDF4D2          17      CALL    SETFCB
00048E D1AC CD34D7          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
000491 D1AF 0E13             7      LD  C,013H
000493 D1B1 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D1B3                     C_REN:
000495 D1B3 CDF4D2          17      CALL    SETFCB
000498 D1B6 3E10             7      LD  A,010H      ;ディレクトリも対象にする
00049A D1B8 326900          13      LD  (FCB1+13),A ;属性
00049D D1BB 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D1BD                     CDEL1:
00049F D1BD 115C00          10      LD  DE,FCB1
0004A2 D1C0 CD0500          17      CALL    SYSTEM
0004A5 D1C3 C6FF             7      ADD A,0FFH
0004A7 D1C5 C9              10      RET
                                
       D1C6                     C_DIR:
0004A8 D1C6 CD89DB          17      CALL    FILEC
0004AB D1C9 2115F0          10      LD  HL,FDRV+1
0004AE D1CC CD0AD4          17      CALL    CWILD1
0004B1 D1CF 3EF1             7      LD  A,0F1H
0004B3 D1D1 3221F0          13      LD  (FDRV+13),A
0004B6 D1D4 CDADD0          17      CALL    OPEN1
       D1D7                     CDIR1:
0004B9 D1D7 B7               4      OR  A
0004BA D1D8 2008            12      JR  NZ,PDSKF
0004BC D1DA CD25D2          17      CALL    P_NAME
0004BF D1DD CDBFD0          17      CALL    OPEN2
0004C2 D1E0 18F5            12      JR  CDIR1
       D1E2                     PDSKF:
0004C4 D1E2 3A14F0          13      LD  A,(FDRV)
0004C7 D1E5 5F               4      LD  E,A
0004C8 D1E6 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
0004CA D1E8 CD0500          17      CALL    SYSTEM
0004CD D1EB 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
0004CE D1EC C601             7      ADD A,001H
0004D0 D1EE D8              11      RET C       ;Aが0FFHだった場合
0004D1 D1EF 3E06             7      LD  A,8-2
       D1F1                     PDS1:               ;HL=未使用クラスタの総数
0004D3 D1F1 3C               4      INC A
0004D4 D1F2 CB19             8      RR  C
0004D6 D1F4 30FB            12      JR  NC,PDS1
       D1F6                     PDS2:               ;B←論理セクタのサイズの上位8ビット
0004D8 D1F6 3C               4      INC A
0004D9 D1F7 CB18             8      RR  B
0004DB D1F9 30FB            12      JR  NC,PDS2
0004DD D1FB 47               4      LD  B,A
                                
0004DE D1FC 110000          10      LD  DE,0
       D1FF                     PDS3:
0004E1 D1FF 29              11      ADD HL,HL
0004E2 D200 EB               4      EX  DE,HL
0004E3 D201 ED6A            15      ADC HL,HL
0004E5 D203 EB               4      EX  DE,HL
0004E6 D204 10F9            13      DJNZ    PDS3
       D206                     PDSKF1:
0004E8 D206 CD92D2          17      CALL    PRDEC_DEHL
0004EB D209 1199EB          10      LD  DE,FREE
0004EE D20C CD7BD4          17      CALL    _SYS09      ;(BDOS)文字列出力
0004F1 D20F CD7FD2          17      CALL    PUTDRV
0004F4 D212 3E5C             7      LD  A,05CH      ;\
0004F6 D214 CD1ED7          17      CALL    MSG_A
0004F9 D217 2A22F0          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
0004FC D21A AF               4      XOR A
0004FD D21B 11FEFF          10      LD  DE,0-2
000500 D21E 19              11      ADD HL,DE
000501 D21F 23               6      INC HL
000502 D220 DC8FD2          17      CALL    C,PRDEC_HL
000505 D223 1833            12      JR  LTNL
                                
       D225                     P_NAME:
000507 D225 3A45EB          13      LD  A,(DTA_CCP+1)
00050A D228 FE2E             7      CP  '.'
00050C D22A C8              11      RET Z
                                
00050D D22B 3A50EB          13      LD  A,(DTA_CCP+1+00BH)
000510 D22E F5              11      PUSH    AF
000511 D22F CB67             8      BIT 4,A
000513 D231 2808            12      JR  Z,DIR3
000515 D233 118EEB          10      LD  DE,DIRMES
000518 D236 CD7BD4          17      CALL    _SYS09      ;(BDOS)文字列出力
00051B D239 180A            12      JR  DIR6
       D23B                     DIR3:
00051D D23B ED5B63EB        20      LD  DE,(DTA_CCP+1+01EH)
000521 D23F 2A61EB          16      LD  HL,(DTA_CCP+1+01CH)
000524 D242 CD92D2          17      CALL    PRDEC_DEHL
       D245                     DIR6:
000527 D245 F1              10      POP AF
000528 D246 0F               4      RRCA
000529 D247 9F               4      SBC A,A
00052A D248 E60A             7      AND '*'-020H
00052C D24A C620             7      ADD A,020H
00052E D24C CD1ED7          17      CALL    MSG_A
000531 D24F CD7FD2          17      CALL    PUTDRV
000534 D252 2145EB          10      LD  HL,DTA_CCP+1
000537 D255 CDD2D2          17      CALL    FPRNT
                                
       D258                     LTNL:
00053A D258 1E03             7      LD  E,3
00053C D25A C3CDF0          10      JP  _PRINT
                                
       D25D                     C_PATH:
00053F D25D CD6ADC          17      CALL    SPCUT
000542 D260 2108EB          10      LD  HL,PATHD
000545 D263 FE21             7      CP  021H
000547 D265 300C            12      JR  NC,CPATH0
       D267                     CPATHP:
000549 D267 7E               7      LD  A,(HL)
00054A D268 23               6      INC HL
00054B D269 FE20             7      CP  020H
00054D D26B 3F               4      CCF
00054E D26C 30EA            12      JR  NC,LTNL
000550 D26E CD1ED7          17      CALL    MSG_A
000553 D271 18F4            12      JR  CPATHP
       D273                     CPATH0:
000555 D273 FE3B             7      CP  ';'
000557 D275 2001            12      JR  NZ,CPATH1
000559 D277 13               6      INC DE
       D278                     CPATH1:
00055A D278 EB               4      EX  DE,HL
00055B D279 013B00          10      LD  BC,PATHX
00055E D27C EDB0                    LDIR
000560 D27E C9              10      RET
                                
       D27F                     PUTDRV:
000561 D27F 3A14F0          13      LD  A,(FDRV)
000564 D282 CD9DDC          17      CALL    GETDRV1
000567 D285 C641             7      ADD A,'A'
000569 D287 CD1ED7          17      CALL    MSG_A
00056C D28A 3E3A             7      LD  A,':'
       D28C                     MSG_AR:
00056E D28C C31ED7          10      JP  MSG_A
                                
       D28F                     PRDEC_HL:
000571 D28F AF               4      XOR A
000572 D290 5F               4      LD  E,A
000573 D291 57               4      LD  D,A
       D292                     PRDEC_DEHL:
000574 D292 D5              11      PUSH    DE
000575 D293 110FF0          10      LD  DE,DECBF
000578 D296 0605             7      LD  B,5
00057A D298 CD29D3          17      CALL    ZERO_MEMORY_DE  ;A=0
00057D D29B D1              10      POP DE
                                
00057E D29C 0E20             7      LD  C,32
       D29E                     DEC1:
000580 D29E 29              11      ADD HL,HL
000581 D29F EB               4      EX  DE,HL
000582 D2A0 ED6A            15      ADC HL,HL
000584 D2A2 EB               4      EX  DE,HL
000585 D2A3 E5              11      PUSH    HL
000586 D2A4 2113F0          10      LD  HL,DECBF+4
000589 D2A7 0605             7      LD  B,5
       D2A9                     DEC2:
00058B D2A9 7E               7      LD  A,(HL)
00058C D2AA 8F               4      ADC A,A
00058D D2AB 27               4      DAA
00058E D2AC 77               7      LD  (HL),A
00058F D2AD 2B               6      DEC HL
000590 D2AE 10F9            13      DJNZ    DEC2
000592 D2B0 E1              10      POP HL
000593 D2B1 0D               4      DEC C
000594 D2B2 20EA            12      JR  NZ,DEC1
                                
000596 D2B4 210FF0          10      LD  HL,DECBF
000599 D2B7 3E20             7      LD  A,020H
00059B D2B9 0604             7      LD  B,4
       D2BB                     DEC3:
00059D D2BB CDC8D2          17      CALL    DEC4
0005A0 D2BE CDC8D2          17      CALL    DEC4
0005A3 D2C1 23               6      INC HL
0005A4 D2C2 10F7            13      DJNZ    DEC3
       D2C4                     DECX:
0005A6 D2C4 CDC8D2          17      CALL    DEC4
0005A9 D2C7 AF               4      XOR A
       D2C8                     DEC4:
0005AA D2C8 ED6F            18      RLD
0005AC D2CA FE20             7      CP  020H
0005AE D2CC 2802            12      JR  Z,DEC5
0005B0 D2CE F630             7      OR  030H
       D2D0                     DEC5:
0005B2 D2D0 18BA            12      JR  MSG_AR
                                
       D2D2                     FPRNT:
0005B4 D2D2 0608             7      LD  B,8 ;ファイル名を表示
0005B6 D2D4 CDE3D2          17      CALL    P_N1
0005B9 D2D7 7E               7      LD  A,(HL)
0005BA D2D8 CDBCDE          17      CALL    CAP3
0005BD D2DB D8              11      RET C   ;拡張子が無い
                                
0005BE D2DC 3E2E             7      LD  A,'.'
0005C0 D2DE CD1ED7          17      CALL    MSG_A
0005C3 D2E1 0603             7      LD  B,3 ;拡張子を表示
       D2E3                     P_N1:
0005C5 D2E3 7E               7      LD  A,(HL)
0005C6 D2E4 CDBCDE          17      CALL    CAP3
0005C9 D2E7 3807            12      JR  C,P_N2
0005CB D2E9 CD1ED7          17      CALL    MSG_A
0005CE D2EC 23               6      INC HL
0005CF D2ED 10F4            13      DJNZ    P_N1
0005D1 D2EF C9              10      RET
       D2F0                     P_N2:
0005D2 D2F0 23               6      INC HL
0005D3 D2F1 10FD            13      DJNZ    P_N2
0005D5 D2F3 C9              10      RET
                                
       D2F4                     SETFCB:
0005D6 D2F4 CD6ADC          17      CALL    SPCUT
0005D9 D2F7 1A               7      LD  A,(DE)
0005DA D2F8 FE20             7      CP  020H
0005DC D2FA 3801            12      JR  C,SETFCBA
0005DE D2FC 1B               6      DEC DE
       D2FD                     SETFCBA:
0005DF D2FD 0624             7      LD  B,36
0005E1 D2FF 215C00          10      LD  HL,FCB1
0005E4 D302 E5              11      PUSH    HL
0005E5 D303 AF               4      XOR A
0005E6 D304 CD3FDC          17      CALL    FILL_MEMORY
0005E9 D307 E1              10      POP HL
0005EA D308 D5              11      PUSH    DE
0005EB D309 CDB4D6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005EE D30C 216C00          10      LD  HL,FCB2
0005F1 D30F CDB4D6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005F4 D312 E1              10      POP HL
0005F5 D313 010050          10      LD  BC,05000H
0005F8 D316 118100          10      LD  DE,00081H
       D319                     SETFCB1:
0005FB D319 7E               7      LD  A,(HL)
0005FC D31A 23               6      INC HL
0005FD D31B FE20             7      CP  020H
0005FF D31D 3805            12      JR  C,SETFCB2
000601 D31F 12               7      LD  (DE),A
000602 D320 13               6      INC DE
000603 D321 0C               4      INC C
000604 D322 10F5            13      DJNZ    SETFCB1
       D324                     SETFCB2:
000606 D324 79               4      LD  A,C
000607 D325 328000          13      LD  (DTA1),A
00060A D328 04               4      INC B
       D329                     ZERO_MEMORY_DE:
00060B D329 AF               4      XOR A
       D32A                     FILL_MEMORY_DE:
00060C D32A 12               7      LD  (DE),A
00060D D32B 13               6      INC DE
00060E D32C 10FC            13      DJNZ    FILL_MEMORY_DE
000610 D32E C9              10      RET
                                
       D32F                     C_COPY:
000611 D32F CDF4D2          17      CALL    SETFCB
                                
000614 D332 1161F0          10      LD  DE,ZERO
000617 D335 CD8CDB          17      CALL    FILEC2
00061A D338 216C00          10      LD  HL,FCB2
00061D D33B CDBBD6          17      CALL    S29X1
                                
000620 D33E 3E10             7      LD  A,010H
000622 D340 326900          13      LD  (FCB1+13),A
000625 D343 216D00          10      LD  HL,FCB2FN
000628 D346 CD0AD4          17      CALL    CWILD1
       D349                     COPY0:
00062B D349 CD07D4          17      CALL    CWILD
00062E D34C 215C00          10      LD  HL,FCB1
000631 D34F CDB0D0          17      CALL    OPEN
000634 D352 37               4      SCF
       D353                     COPY1:
000635 D353 C0              11      RET NZ
000636 D354 CDC3D0          17      CALL    DEFCB
                                
000639 D357 3A51EB          13      LD  A,(DTA_CCP+13)
00063C D35A CB67             8      BIT 4,A
00063E D35C 2821            12      JR  Z,COPY1A
                                
000640 D35E 215D00          10      LD  HL,FCB1FN
000643 D361 CDCFDF          17      CALL    CHKWILD
000646 D364 3814            12      JR  C,COPY9
                                
000648 D366 3E20             7      LD  A,020H
00064A D368 325D00          13      LD  (FCB1FN),A
00064D D36B 2A5EEB          16      LD  HL,(DTA_CCP+26)
000650 D36E 23               6      INC HL
000651 D36F 226A00          16      LD  (FCB1+14),HL
000654 D372 18D5            12      JR  COPY0
                                
       D374                     COPY8:
000656 D374 CD7BD4          17      CALL    _SYS09      ;(BDOS)文字列出力
000659 D377 CD58D2          17      CALL    LTNL
       D37A                     COPY9:
00065C D37A CDBFD0          17      CALL    OPEN2
00065F D37D 18D4            12      JR  COPY1
                                
       D37F                     COPY1A:
000661 D37F 216C00          10      LD  HL,FCB2
000664 D382 1114F0          10      LD  DE,FDRV
000667 D385 0146EB          10      LD  BC,DTA_CCP+2
00066A D388 EDA0            16      LDI
00066C D38A 3E0B             7      LD  A,11
       D38C                     COPY2:
00066E D38C F5              11      PUSH    AF
00066F D38D 7E               7      LD  A,(HL)
000670 D38E FE3F             7      CP  '?'
000672 D390 2001            12      JR  NZ,COPY3
000674 D392 0A               7      LD  A,(BC)
       D393                     COPY3:
000675 D393 12               7      LD  (DE),A
000676 D394 03               6      INC BC
000677 D395 13               6      INC DE
000678 D396 23               6      INC HL
000679 D397 F1              10      POP AF
00067A D398 3D               4      DEC A
00067B D399 20F1            12      JR  NZ,COPY2
00067D D39B 010500          10      LD  BC,16-11
000680 D39E EDB0                    LDIR
       D3A0                     PUTNAME:
000682 D3A0 215D00          10      LD  HL,FCB1FN
000685 D3A3 CDCFDF          17      CALL    CHKWILD
000688 D3A6 300B            12      JR  NC,PUTN1
00068A D3A8 2115F0          10      LD  HL,FDRV+1
00068D D3AB CDD2D2          17      CALL    FPRNT
000690 D3AE 3E20             7      LD  A,020H
000692 D3B0 CD1ED7          17      CALL    MSG_A
       D3B3                     PUTN1:
000695 D3B3 1114F0          10      LD  DE,FDRV
000698 D3B6 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
00069A D3B8 CDDED0          17      CALL    SYSTEM0
00069D D3BB 2048            12      JR  NZ,COPYE2
00069F D3BD 67               4      LD  H,A     ;A=0
0006A0 D3BE 6F               4      LD  L,A
0006A1 D3BF 2235F0          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
0006A4 D3C2 2237F0          16      LD  (FDRV+35),HL
       D3C5                     COPY6:
0006A7 D3C5 CDE7D0          17      CALL    S27BUF
0006AA D3C8 47               4      LD  B,A
0006AB D3C9 3C               4      INC A
0006AC D3CA 2831            12      JR  Z,COPYE
0006AE D3CC 7C               4      LD  A,H
0006AF D3CD B5               4      OR  L
0006B0 D3CE 280C            12      JR  Z,COPY7
0006B2 D3D0 1114F0          10      LD  DE,FDRV
0006B5 D3D3 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0006B7 D3D5 CDDED0          17      CALL    SYSTEM0
0006BA D3D8 2023            12      JR  NZ,COPYE
0006BC D3DA 10E9            13      DJNZ    COPY6
       D3DC                     COPY7:
0006BE D3DC 3A51EB          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0006C1 D3DF 3221F0          13      LD  (FDRV+13),A
0006C4 D3E2 2158EB          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
0006C7 D3E5 1128F0          10      LD  DE,FDRV+20
0006CA D3E8 010400          10      LD  BC,4
0006CD D3EB EDB0                    LDIR
                                
0006CF D3ED 1114F0          10      LD  DE,FDRV
0006D2 D3F0 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
0006D4 D3F2 CDDED0          17      CALL    SYSTEM0
0006D7 D3F5 2006            12      JR  NZ,COPYE
                                
0006D9 D3F7 1171F0          10      LD  DE,OK
0006DC D3FA C374D3          10      JP  COPY8
                                
       D3FD                     COPYE:
0006DF D3FD 1114F0          10      LD  DE,FDRV
0006E2 D400 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
0006E4 D402 CD0500          17      CALL    SYSTEM
       D405                     COPYE2:
0006E7 D405 37               4      SCF
0006E8 D406 C9              10      RET
                                
       D407                     CWILD:
0006E9 D407 215D00          10      LD  HL,FCB1FN
       D40A                     CWILD1:
0006EC D40A 7E               7      LD  A,(HL)
0006ED D40B FE20             7      CP  020H
0006EF D40D C0              11      RET NZ
       D40E                     CWILD2:
0006F0 D40E 3E3F             7      LD  A,'?'
0006F2 D410 060B             7      LD  B,11
0006F4 D412 C33FDC          10      JP  FILL_MEMORY
                                
       D415                     COMTB:
0006F7 D415 44202020                DB  "D   "  ;1
0006FB D419 C6D1                    DW  C_DIR
0006FD D41B 44495220                DB  "DIR "  ;2
000701 D41F C6D1                    DW  C_DIR
000703 D421 434F5059                DB  "COPY"  ;3
000707 D425 2FD3                    DW  C_COPY
000709 D427 43442020                DB  "CD  "  ;4
00070D D42B E3D0                    DW  C_CD
00070F D42D 44454C20                DB  "DEL "  ;5
000713 D431 A9D1                    DW  C_DEL
000715 D433 50415448                DB  "PATH"  ;6
000719 D437 5DD2                    DW  C_PATH
00071B D439 52454E20                DB  "REN "  ;7
00071F D43D B3D1                    DW  C_REN
000721 D43F 52454D20                DB  "REM "  ;8
000725 D443 79D4                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP2.ASM"
                                
                                ;   LSX-Dodgers CCP2
                                ;   MZ-700/1500
                                
000727 D445 4D4F4E20                DB  "MON "  ;9
00072B D449 79DB                    DW  C_MON
[EOF:M7CCP2.ASM:UTF_8]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D44B                     BDOS0:
00072D D44B E5              11      PUSH    HL
00072E D44C 79               4      LD  A,C
00072F D44D FE3C             7      CP  03CH
000731 D44F 3802            12      JR  C,DOS1
000733 D451 3E3C             7      LD  A,03CH
       D453                     DOS1:
000735 D453 87               4      ADD A,A
000736 D454 3258D4          13      LD  (DOS1_SWC),A
000739 D457 2A00F1          16      LD  HL,(STABLE)
       D458                     DOS1_SWC    EQU $-2
00073C D45A E3              19      EX  (SP),HL
00073D D45B 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
00073E D45C C9              10      RET
       D45D                     _DOS2:
00073F D45D FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
000741 D45F CAF6D6          10      JP  Z,_SYS5A
000744 D462 FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000746 D464 CAB3D6          10      JP  Z,_SYS5C
000749 D467 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
00074B D469 CACCE8          10      JP  Z,_SYS5F
00074E D46C FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000750 D46E 2009            12      JR  NZ,_ERROR
000752 D470 011D01          10      LD  BC,VER_6F
000755 D473 116201          10      LD  DE,VER
000758 D476 210100          10      LD  HL,MACD
       D479                     C_REM:
       D479                     _ERROR:
00075B D479 AF               4      XOR A
00075C D47A C9              10      RET
                                
       D47B                     _SYS09:     ;文字列出力
00075D D47B D5              11      PUSH    DE
       D47C                     _SX09:
00075E D47C 1A               7      LD  A,(DE)
00075F D47D 13               6      INC DE
000760 D47E FE24             7      CP  '$'
000762 D480 2831            12      JR  Z,SX0E2
000764 D482 CD1ED7          17      CALL    MSG_A
000767 D485 18F5            12      JR  _SX09
                                
       D487                     MSX1:
000769 D487 CD1ED7          17      CALL    MSG_A
       D48A                     MSX:
00076C D48A 7E               7      LD  A,(HL)
00076D D48B 23               6      INC HL
00076E D48C B7               4      OR  A
00076F D48D 20F8            12      JR  NZ,MSX1
000771 D48F C9              10      RET
                                
       D490                     _SYS0C:     ;(BDOS)バージョン番号の獲得
000772 D490 212200          10      LD  HL,00022H
000775 D493 7D               4      LD  A,L
000776 D494 C9              10      RET
                                
       D495                     _SYS0D:     ;(BDOS)ディスクリセット
000777 D495 CDDFF0          17      CALL    _FFLUSH
00077A D498 E5              11      PUSH    HL
00077B D499 218000          10      LD  HL,00080H
00077E D49C 228AF0          16      LD  (_DTA),HL
000781 D49F E1              10      POP HL
000782 D4A0 D5              11      PUSH    DE
000783 D4A1 1E00             7      LD  E,0
000785 D4A3 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D4A4                     _SYS0E:     ;(BDOS)カレントドライブの設定
000786 D4A4 D5              11      PUSH    DE
000787 D4A5 7B               4      LD  A,E
000788 D4A6 DDE5            15      PUSH    IX
00078A D4A8 CDDCF0          17      CALL    _GETDPB
00078D D4AB DDE1            14      POP IX
00078F D4AD 3804            12      JR  C,SX0E2
000791 D4AF 7B               4      LD  A,E
000792 D4B0 320400          13      LD  (_DVSW),A
       D4B3                     SX0E2:
000795 D4B3 D1              10      POP DE
000796 D4B4 C9              10      RET
                                
       D4B5                     _SYS0F:     ;(BDOS)ファイルのオープン
000797 D4B5 CD7CDC          17      CALL    SETDRV
00079A D4B8 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
00079D D4BB C602             7      ADD A,002H      ;Write
00079F D4BD 2848            12      JR  Z,FEND0F
0007A1 D4BF CDCBDF          17      CALL    CHKWILDX
                                
0007A4 D4C2 D4A6DC          17      CALL    NC,SOPENX
       D4C5                     _S16XX:
0007A7 D4C5 3840            12      JR  C,FEND0F
                                                ;Directory location
0007A9 D4C7 3A9FF0          13      LD  A,(_FILEN)
0007AC D4CA FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
0007AF D4CD 3AA0F0          13      LD  A,(_DIRF)
0007B2 D4D0 FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
0007B5 D4D3 FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
0007B8 D4D6 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
0007BB D4D9 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
0007BF D4DD FDE5            15      PUSH    IY
0007C1 D4DF D1              10      POP DE
0007C2 D4E0 13               6      INC DE
0007C3 D4E1 010B00          10      LD  BC,11
0007C6 D4E4 EDB0                    LDIR
                                ;               Attribute
0007C8 D4E6 7E               7      LD  A,(HL)
0007C9 D4E7 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
0007CC D4EA 110B00          10      LD  DE,11       ;Reserved
0007CF D4ED 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
0007D0 D4EE 11E4F1          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
0007D3 D4F1 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D4F3                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
0007D5 D4F3 1A               7      LD  A,(DE)
0007D6 D4F4 13               6      INC DE
0007D7 D4F5 32FCD4          13      LD  (S16PAT),A
0007DA D4F8 7E               7      LD  A,(HL)
0007DB D4F9 23               6      INC HL
0007DC D4FA FD7700          19      LD  (IY+0),A
       D4FC                     S16PAT  EQU $-1
0007DF D4FD 10F4            13      DJNZ    S16LOOP
                                
0007E1 D4FF AF               4      XOR A
0007E2 D500 FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
0007E5 D503 FD22A4D5        20      LD  (OFCB_SWC),IY
       D507                     FEND0F:
0007E9 D507 1845            12      JR  FEND10
                                
       D509                     _SYS10:     ;(BDOS)ファイルのクローズ
0007EB D509 CD7CDC          17      CALL    SETDRV
0007EE D50C FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0007F1 D50F D6FE             7      SUB 0FEH
0007F3 D511 37               4      SCF
0007F4 D512 3F               4      CCF
0007F5 D513 2039            12      JR  NZ,FEND10
       D515                     _S10A:              ;Write
0007F7 D515 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
0007FA D518 FD770F          19      LD  (IY+15),A
                                
0007FD D51B FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
000800 D51E CDC7E0          17      CALL    SETTMS
                                
000803 D521 FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000806 D524 32A0F0          13      LD  (_DIRF),A
000809 D527 E67F             7      AND 07FH
00080B D529 32ECE5          13      LD  (_SECPS),A
00080E D52C FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
000811 D52F FD561F          19      LD  D,(IY+31)
000814 D532 CDDADD          17      CALL    READ_DIR
000817 D535 3817            12      JR  C,FEND10
                                
000819 D537 3A06DD          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
00081C D53A 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
00081D D53B FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
000820 D53E 6F               4      LD  L,A
000821 D53F 2600             7      LD  H,0
000823 D541 29              11      ADD HL,HL       ;*2
000824 D542 29              11      ADD HL,HL       ;*4
000825 D543 29              11      ADD HL,HL       ;*8
000826 D544 29              11      ADD HL,HL       ;*16
000827 D545 29              11      ADD HL,HL       ;*32
000828 D546 ED4B7EF1        20      LD  BC,(_DTBUF)
00082C D54A 09              11      ADD HL,BC
                                
00082D D54B CDDBDF          17      CALL    SDIRENT
       D54E                     FEND10:
000830 D54E 1842            12      JR  FEND
                                
       D550                     _SYS11:     ;(BDOS)最初のファイルの検索
000832 D550 CD7CDC          17      CALL    SETDRV
000835 D553 CDD5DC          17      CALL    SOPEN
       D556                     _S12X1:
000838 D556 383A            12      JR  C,FEND
00083A D558 CD74DD          17      CALL    SOPENE2
00083D D55B ED5B8AF0        20      LD  DE,(_DTA)
000841 D55F 3A88F0          13      LD  A,(_DRV)
000844 D562 3C               4      INC A
000845 D563 12               7      LD  (DE),A
000846 D564 D5              11      PUSH    DE
000847 D565 13               6      INC DE
000848 D566 012000          10      LD  BC,32
00084B D569 EDB0                    LDIR
00084D D56B FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
000850 D56E FD660F          19      LD  H,(IY+15)
000853 D571 22F4F1          16      LD  (SCDIR),HL
000856 D574 2A9AF0          16      LD  HL,(_FBPS)
000859 D577 22F6F1          16      LD  (SFBPS),HL
00085C D57A 2A9FF0          16      LD  HL,(_FILEN)
00085F D57D 7C               4      LD  A,H
000860 D57E B7               4      OR  A
000861 D57F 2806            12      JR  Z,_S12DIR
000863 D581 3AECE5          13      LD  A,(_SECPS)
000866 D584 F680             7      OR  080H
000868 D586 67               4      LD  H,A
       D587                     _S12DIR:
000869 D587 22F8F1          16      LD  (SFNDF),HL  ;Directory position and Flags
00086C D58A E1              10      POP HL
00086D D58B 1139F0          10      LD  DE,SFILE
000870 D58E 0E21             7      LD  C,33
       D590                     _S11B:
000872 D590 EDB0                    LDIR
       D592                     FEND:
000874 D592 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D593                     FENDE:
000875 D593 FDE1            14      POP IY
000877 D595 C1              10      POP BC
000878 D596 D1              10      POP DE
000879 D597 E1              10      POP HL
00087A D598 C9              10      RET
                                
       D599                     _SYS12:     ;(BDOS)次のファイルの検索
00087B D599 E5              11      PUSH    HL
00087C D59A D5              11      PUSH    DE
00087D D59B C5              11      PUSH    BC
00087E D59C FDE5            15      PUSH    IY
000880 D59E CD39DD          17      CALL    NOPEN
000883 D5A1 18B3            12      JR  _S12X1
                                
       D5A3                     _S16K:
000885 D5A3 110000          10      LD  DE,0
       D5A4                     OFCB_SWC    EQU $-2
000888 D5A6 D5              11      PUSH    DE
000889 D5A7 061A             7      LD  B,26        ;First cluster
       D5A9                     S16K1:
00088B D5A9 13               6      INC DE
00088C D5AA 23               6      INC HL
00088D D5AB 10FC            13      DJNZ    S16K1
                                
00088F D5AD 1A               7      LD  A,(DE)
000890 D5AE BE               7      CP  (HL)
000891 D5AF 2015            12      JR  NZ,S16K2
000893 D5B1 13               6      INC DE
000894 D5B2 23               6      INC HL
000895 D5B3 1A               7      LD  A,(DE)
000896 D5B4 BE               7      CP  (HL)
000897 D5B5 200F            12      JR  NZ,S16K2
                                
000899 D5B7 E1              10      POP HL
00089A D5B8 FDE5            15      PUSH    IY
00089C D5BA D1              10      POP DE
00089D D5BB 7E               7      LD  A,(HL)
00089E D5BC CD91DC          17      CALL    IS_SAME_DRV_A_DE
0008A1 D5BF 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
0008A3 D5C1 ED52            15      SBC HL,DE       ;CP HL,DE
0008A5 D5C3 37               4      SCF
0008A6 D5C4 C0              11      RET NZ
0008A7 D5C5 E5              11      PUSH    HL
       D5C6                     S16K2:
0008A8 D5C6 E1              10      POP HL
       D5C7                     S16K3:
0008A9 D5C7 FDE5            15      PUSH    IY
0008AB D5C9 D1              10      POP DE
       D5CA                     _SYS13:     ;(BDOS)ファイルの削除
0008AC D5CA CD7CDC          17      CALL    SETDRV
0008AF D5CD CD03DF          17      CALL    KILL
       D5D0                     FEND13:
0008B2 D5D0 18C0            12      JR  FEND
                                
       D5D2                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0008B4 D5D2 CD7CDC          17      CALL    SETDRV
0008B7 D5D5 CD3FE4          17      CALL    INIT_SEQ
       D5D8                     SREAD:
0008BA D5D8 CD11E4          17      CALL    RB_READ
                                
0008BD D5DB C601             7      ADD A,001H
0008BF D5DD 38B3            12      JR  C,FEND
                                
0008C1 D5DF 7D               4      LD  A,L
0008C2 D5E0 D601             7      SUB 001H
       D5E2                     FENDX:
0008C4 D5E2 9F               4      SBC A,A
0008C5 D5E3 E603             7      AND 3
0008C7 D5E5 1F               4      RRA
0008C8 D5E6 18AB            12      JR  FENDE
                                
       D5E8                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
0008CA D5E8 CD7CDC          17      CALL    SETDRV
0008CD D5EB CD3FE4          17      CALL    INIT_SEQ
       D5EE                     SWRITE:
0008D0 D5EE CD0CE4          17      CALL    RB_WRITE
                                
0008D3 D5F1 C6FF             7      ADD A,0FFH
0008D5 D5F3 18ED            12      JR  FENDX
                                
       D5F5                     _SYS17:     ;(BDOS)ファイル名の変更
0008D7 D5F5 CD7CDC          17      CALL    SETDRV
0008DA D5F8 CD59DF          17      CALL    NAME
0008DD D5FB 18D3            12      JR  FEND13
                                
       D5FD                     _SYS16:     ;(BDOS)ファイルの作成
0008DF D5FD CD7CDC          17      CALL    SETDRV
                                
0008E2 D600 CDCBDF          17      CALL    CHKWILDX
0008E5 D603 38CB            12      JR  C,FEND13
0008E7 D605 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
0008EA D608 FE05             7      CP  5
0008EC D60A 2805            12      JR  Z,_S16X2
0008EE D60C FE21             7      CP  021H
0008F0 D60E DAD0D5          10      JP  C,FEND13
       D611                     _S16X2:
                                ;               Clear FCB
0008F3 D611 FDE5            15      PUSH    IY
0008F5 D613 E1              10      POP HL
0008F6 D614 011000          10      LD  BC,16
0008F9 D617 09              11      ADD HL,BC
       D618                     _S16X1:
0008FA D618 70               7      LD  (HL),B      ;B=0
0008FB D619 23               6      INC HL
0008FC D61A 0D               4      DEC C
0008FD D61B 20FB            12      JR  NZ,_S16X1
                                
0008FF D61D CDCCE0          17      CALL    SETTMSX
000902 D620 FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000906 D624 CDA6DC          17      CALL    SOPENX
000909 D627 3F               4      CCF
00090A D628 CCA3D5          17      CALL    Z,_S16K
00090D D62B D485DD          17      CALL    NC,COPEN
000910 D62E D4DBDF          17      CALL    NC,SDIRENT
000913 D631 C3C5D4          10      JP  _S16XX
                                
       D634                     _SYS21:     ;(BDOS)ランダムな読み出し
000916 D634 CD7CDC          17      CALL    SETDRV
000919 D637 CD17E1          17      CALL    INIT_RND
00091C D63A 189C            12      JR  SREAD
                                
       D63C                     _SYS22:     ;(BDOS)ランダムな書き込み
       D63C                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
00091E D63C CD7CDC          17      CALL    SETDRV
000921 D63F CD17E1          17      CALL    INIT_RND
000924 D642 18AA            12      JR  SWRITE
                                
       D644                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000926 D644 21FF00          10      LD  HL,000FFH
000929 D647 AF               4      XOR A
00092A D648 C9              10      RET
                                
       D649                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
00092B D649 3A0400          13      LD  A,(_DVSW)   ;from LDOS
00092E D64C A7               4      AND A
00092F D64D C9              10      RET
                                
       D64E                     _SYS1A:     ;(BDOS)DTAの設定
000930 D64E ED538AF0        20      LD  (_DTA),DE
000934 D652 AF               4      XOR A
000935 D653 C9              10      RET
                                
       D654                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000936 D654 7B               4      LD  A,E
000937 D655 CD8ADC          17      CALL    GETDRV
00093A D658 CDDCF0          17      CALL    _GETDPB
00093D D65B D4E2F0          17      CALL    NC,_RDFATX
000940 D65E 210000          10      LD  HL,0
000943 D661 D4A5E0          17      CALL    NC,DSKF
                                
000946 D664 ED5BA6E0        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
00094A D668 1B               6      DEC DE      ;DE←クラスタの総数
00094B D669 FD2A7CF1        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
00094F D66D 9F               4      SBC A,A
000950 D66E D8              11      RET C
000951 D66F 4F               4      LD  C,A     ;C=0
000952 D670 DD7E0F          19      LD  A,(IX+DPB_BPS)
000955 D673 E607             7      AND 7
000957 D675 47               4      LD  B,A
000958 D676 DD7E07          19      LD  A,(IX+DPB_SECPCL)
00095B D679 C9              10      RET
                                
       D67A                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
00095C D67A AF               4      XOR A
00095D D67B 67               4      LD  H,A
00095E D67C 6F               4      LD  L,A
00095F D67D C9              10      RET
                                
       D67E                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
000960 D67E 2100F2          10      LD  HL,_DEVICE
000963 D681 7B               4      LD  A,E
000964 D682 C3DCF0          10      JP  _GETDPB
                                
       D685                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000967 D685 E5              11      PUSH    HL
000968 D686 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
00096A D688 CD4BD4          17      CALL    BDOS0
00096D D68B 381B            12      JR  C,_S23X1
                                
00096F D68D D5              11      PUSH    DE      ;EX DE,IY
000970 D68E FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000972 D690 FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000975 D693 FD6E11          19      LD  L,(IY+17)   ;
000978 D696 FD6612          19      LD  H,(IY+18)   ;
00097B D699 C5              11      PUSH    BC      ;
00097C D69A FD4613          19      LD  B,(IY+19)   ;
00097F D69D CD09E1          17      CALL    GET_CPM_R_SIZE
000982 D6A0 C1              10      POP BC
       D6A1                     _S24X1:
000983 D6A1 CD29E1          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000986 D6A4 FDE3            23      EX  (SP),IY     ;
000988 D6A6 D1              10      POP DE      ;
                                
000989 D6A7 AF               4      XOR A
       D6A8                     _S23X1:
00098A D6A8 E1              10      POP HL
00098B D6A9 C9              10      RET
                                
       D6AA                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
00098C D6AA E5              11      PUSH    HL
00098D D6AB D5              11      PUSH    DE      ;EX DE,IY
00098E D6AC FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
000990 D6AE CD47E4          17      CALL    GETSEQ
000993 D6B1 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D6B3                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000995 D6B3 2B               6      DEC HL
       D6B4                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000996 D6B4 C5              11      PUSH    BC
000997 D6B5 E5              11      PUSH    HL
000998 D6B6 CD94DB          17      CALL    FILE
00099B D6B9 E1              10      POP HL
00099C D6BA C1              10      POP BC
       D6BB                     S29X1:
00099D D6BB C5              11      PUSH    BC
00099E D6BC D5              11      PUSH    DE
00099F D6BD E5              11      PUSH    HL
0009A0 D6BE EB               4      EX  DE,HL
0009A1 D6BF AF               4      XOR A
0009A2 D6C0 3221F0          13      LD  (FDRV+13),A
0009A5 D6C3 2114F0          10      LD  HL,FDRV
0009A8 D6C6 011000          10      LD  BC,16
0009AB D6C9 EDB0                    LDIR
0009AD D6CB E1              10      POP HL
0009AE D6CC D1              10      POP DE
0009AF D6CD C1              10      POP BC
0009B0 D6CE C9              10      RET
                                
       D6CF                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
0009B1 D6CF C5              11      PUSH    BC
0009B2 D6D0 018DE7          10      LD  BC,DWT24B
0009B5 D6D3 1804            12      JR  S2FX
       D6D5                     _SYS2F:
0009B7 D6D5 C5              11      PUSH    BC
0009B8 D6D6 017FE7          10      LD  BC,DRD24B
       D6D9                     S2FX:
0009BB D6D9 ED43EFD6        20      LD  (S2F_SWC),BC
0009BF D6DD CDDFF0          17      CALL    _FFLUSH
                                
0009C2 D6E0 D5              11      PUSH    DE
0009C3 D6E1 E5              11      PUSH    HL
0009C4 D6E2 7D               4      LD  A,L     ;Drive
0009C5 D6E3 CDD9F0          17      CALL    _CHGDRV
0009C8 D6E6 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
0009CA D6E8 44               4      LD  B,H     ;Number of clusters
0009CB D6E9 2A8AF0          16      LD  HL,(_DTA)
                                
0009CE D6EC 0E00             7      LD  C,0
0009D0 D6EE CD7FE7          17      CALL    DRD24B
       D6EF                     S2F_SWC EQU $-2
       D6F1                     POP_HL_DE_BC_SBCAA_RET:
0009D3 D6F1 E1              10      POP HL
0009D4 D6F2 D1              10      POP DE
0009D5 D6F3 C1              10      POP BC
0009D6 D6F4 9F               4      SBC A,A
0009D7 D6F5 C9              10      RET
                                
       D6F6                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
0009D8 D6F6 C5              11      PUSH    BC
0009D9 D6F7 D5              11      PUSH    DE
0009DA D6F8 E5              11      PUSH    HL
0009DB D6F9 CD89DB          17      CALL    FILEC
0009DE D6FC 21F1D6          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
0009E1 D6FF E5              11      PUSH    HL
0009E2 D700 3A21F0          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
0009E5 D703 E610             7      AND 010H        ;ディレクトリ
0009E7 D705 37               4      SCF
0009E8 D706 C8              11      RET Z
0009E9 D707 1114F0          10      LD  DE,FDRV
0009EC D70A 2A4EF1          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       D70D                     JPHL:
0009EF D70D E9               4      JP  (HL)
                                
       D70E                     SHOW_ERROR:         ;(9)
0009F0 D70E 1179F0          10      LD  DE,COMERM
0009F3 D711 CD7BD4          17      CALL    _SYS09      ;(BDOS)文字列出力
0009F6 D714 C300F0          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "M7IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                
       D479                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D479                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D479                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D479                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D479                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D479                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
                                #IF EXISTS USE_8253
                                ARWKEY:
                                    DEC A
                                    LD  (KEYAR),A
                                    JR  INT8253E
                                SETKEY1:
                                    LD  A,(_KEYSP_H)
                                    JR  SETKEY
                                INT8253:
                                    CALL    CHKEY
                                    CP  0
                                KEYDT   EQU $-1
                                    JR  NZ,SETKEY1
                                    PUSH    HL
                                    LD  HL,(_KEYPS)
                                    LD  A,H
                                    XOR L
                                    POP HL
                                    JR  NZ,INT8253E
                                    LD  A,0
                                KEYAR   EQU $-1
                                    OR  A
                                    JR  NZ,ARWKEY
                                SETKEY:
                                    LD  (KEYAR),A
                                    CALL    GETKEYD
                                    LD  (KEYDT),A
                                    CALL    KEYSET
                                INT8253E:
                                    LD  A,0
                                INTMEM_SWC  EQU $-1
                                    CP  0C9H        ;RAMの場合はEXTBIOにRETが入っている
                                    JP  NZ,ROM8253E
                                    POP AF
                                    EI
                                    RET
                                KEYSET:
                                KEYBS:
                                    OR  A
                                    RET Z
                                KEYBS1:
                                    CALL    KEYBC_IFBREAK
                                    PUSH    HL
                                    PUSH    AF
                                    LD  HL,(_KEYPS)
                                    INC L
                                    RES 5,L
                                    LD  A,L
                                    CP  H
                                    JR  Z,POP_AF_HL_SCF_RET
                                    LD  (_KEYPS),A
                                    LD  H,HIGH KEYBF
                                    POP AF
                                    LD  (HL),A
                                    POP HL
                                    RET
                                KEYBC_IFBREAK:
                                    CP  3
                                    RET NZ
                                KEYBC:
                                    PUSH    HL
                                    LD  HL,0
                                    LD  (_KEYPS),HL
                                    POP HL
                                    RET
                                #ENDIF
                                
       D717                     POP_AF_HL_SCF_RET:
0009F9 D717 F1              10      POP AF
0009FA D718 E1              10      POP HL
0009FB D719 37               4      SCF
                                #IF EXISTS USE_8253
                                #ELSE
       D71A                     KEYBC_IFBREAK:
                                #ENDIF
0009FC D71A C9              10      RET
                                
       D71B                     _SYS01:     ;(BDOS)コンソール入力
0009FD D71B CD09F0          17      CALL    _SYS07
       D71E                     MSG_A:
000A00 D71E F5              11      PUSH    AF
000A01 D71F D5              11      PUSH    DE
000A02 D720 5F               4      LD  E,A
000A03 D721 CD27D7          17      CALL    _SYS02
000A06 D724 D1              10      POP DE
000A07 D725 F1              10      POP AF
000A08 D726 C9              10      RET
                                
       D727                     _SYS02:     ;(BDOS)コンソール出力
000A09 D727 CD39D7          17      CALL    BREAK
000A0C D72A 1805            12      JR  PRINTX
                                
       D72C                     _SYS06:     ;(BDOS)コンソール直接入出力
000A0E D72C 7B               4      LD  A,E
000A0F D72D 3C               4      INC A
000A10 D72E CACAF0          10      JP  Z,_INKEY
       D731                     PRINTX:
000A13 D731 C3CDF0          10      JP  _PRINT
                                
       D734                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000A16 D734 CD09F0          17      CALL    _SYS07
000A19 D737 1803            12      JR  BREAK1
       D739                     BREAK:
                                #IF EXISTS USE_8253
                                    EI
                                    LD  A,(_KEYD)
                                #ELSE
000A1B D739 CDF2DA          17      CALL    CHKEY
                                #ENDIF
       D73C                     BREAK1:
000A1E D73C FE03             7      CP  3       ;CTRL+C
000A20 D73E CCF4F0          17      CALL    Z,_BREAK
000A23 D741 FE13             7      CP  013H        ;CTRL+S
000A25 D743 C0              11      RET NZ
                                
       D744                     PAUSE:
                                #IF EXISTS USE_8253
                                    CALL    KEYBC
                                #ENDIF
                                
       D744                     FLGET:
000A26 D744 CDDFF0          17      CALL    _FFLUSH
000A29 D747 E5              11      PUSH    HL
000A2A D748 2A8EF0          16      LD  HL,(_TXADR)
000A2D D74B 7C               4      LD  A,H
000A2E D74C C6D0             7      ADD A,0D0H
000A30 D74E 67               4      LD  H,A
000A31 D74F CD43CF          17      CALL    RDMMIO
000A34 D752 3267D7          13      LD  (FLSMC),A
       D755                     FLGET1:
000A37 D755 CD39CF          17      CALL    RD556VSYNC
000A3A D758 CB77             8      BIT 6,A
000A3C D75A 3EEF             7      LD  A,0EFH      ;カーソル
000A3E D75C 280A            12      JR  Z,FLGET2
000A40 D75E CDA9DA          17      CALL    GETKEYD
000A43 D761 B7               4      OR  A
000A44 D762 3EEF             7      LD  A,0EFH      ;カーソル
000A46 D764 2002            12      JR  NZ,FLGET2
000A48 D766 3E00             7      LD  A,0     ;自己書き換え
       D767                     FLSMC   EQU $-1
       D768                     FLGET2:
000A4A D768 CD4BCF          17      CALL    WRMMIO
000A4D D76B CDCAF0          17      CALL    _INKEY
000A50 D76E 28E5            12      JR  Z,FLGET1
000A52 D770 F5              11      PUSH    AF
000A53 D771 3A67D7          13      LD  A,(FLSMC)
000A56 D774 CD4BCF          17      CALL    WRMMIO
000A59 D777 F1              10      POP AF
000A5A D778 E1              10      POP HL
000A5B D779 C9              10      RET
                                
       D77A                     _SYS0A:     ;(BDOS)文字列入力
000A5C D77A C5              11      PUSH    BC
000A5D D77B E5              11      PUSH    HL
000A5E D77C D5              11      PUSH    DE
000A5F D77D CD1CDA          17      CALL    GETL
000A62 D780 1130FF          10      LD  DE,KBUF
000A65 D783 E1              10      POP HL
000A66 D784 E5              11      PUSH    HL
000A67 D785 0E00             7      LD  C,0
000A69 D787 3004            12      JR  NC,SAX0
000A6B D789 23               6      INC HL
000A6C D78A 23               6      INC HL
000A6D D78B 1808            12      JR  SAX4
       D78D                     SAX0:
000A6F D78D 46               7      LD  B,(HL)
000A70 D78E 23               6      INC HL
       D78F                     SAX1:
000A71 D78F 23               6      INC HL
000A72 D790 1A               7      LD  A,(DE)
000A73 D791 13               6      INC DE
000A74 D792 B7               4      OR  A
000A75 D793 2004            12      JR  NZ,SAX2
       D795                     SAX4:
000A77 D795 360D            10      LD  (HL),00DH
000A79 D797 1804            12      JR  SAX3
       D799                     SAX2:
000A7B D799 77               7      LD  (HL),A
000A7C D79A 0C               4      INC C
000A7D D79B 10F2            13      DJNZ    SAX1
       D79D                     SAX3:
000A7F D79D D1              10      POP DE
000A80 D79E 79               4      LD  A,C
000A81 D79F 13               6      INC DE
000A82 D7A0 12               7      LD  (DE),A
000A83 D7A1 1B               6      DEC DE
000A84 D7A2 E1              10      POP HL
000A85 D7A3 C1              10      POP BC
000A86 D7A4 A7               4      AND A
000A87 D7A5 C9              10      RET
                                
       D7A6                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000A88 D7A6 CD39D7          17      CALL    BREAK
000A8B D7A9 B7               4      OR  A
000A8C D7AA C8              11      RET Z
                                
       D7AB                     CONSTX:
000A8D D7AB CDDFF0          17      CALL    _FFLUSH
                                #IF EXISTS USE_8253
                                    PUSH    HL
                                    LD  HL,(_KEYPS)
                                    LD  A,H
                                    XOR L
                                    POP HL
                                    ADD A,0FFH
                                #ELSE
000A90 D7AE CDB8DA          17      CALL    INKEY
000A93 D7B1 C8              11      RET Z
000A94 D7B2 AF               4      XOR A
000A95 D7B3 32C0DA          13      LD  (SKIP_KEYWAIT),A
000A98 D7B6 37               4      SCF
                                #ENDIF
000A99 D7B7 9F               4      SBC A,A
000A9A D7B8 C9              10      RET
                                
       D7B9                     _SYS2A:     ;(BDOS)日付の獲得
       D7B9                     _SYS2C:     ;(BDOS)時刻の獲得
000A9B D7B9 AF               4      XOR A
000A9C D7BA 57               4      LD  D,A
000A9D D7BB 5F               4      LD  E,A
000A9E D7BC 67               4      LD  H,A
000A9F D7BD 6F               4      LD  L,A
000AA0 D7BE C9              10      RET
                                
       D7BF                     ESC1:
000AA1 D7BF 7B               4      LD  A,E
000AA2 D7C0 FE41             7      CP  'A'
000AA4 D7C2 CAB7D8          10      JP  Z,CTRL1E
000AA7 D7C5 FE42             7      CP  'B'
000AA9 D7C7 CADFD9          10      JP  Z,CTRL1F
000AAC D7CA FE43             7      CP  'C'
000AAE D7CC CA8AD8          10      JP  Z,CTRL1C
000AB1 D7CF FE44             7      CP  'D'
000AB3 D7D1 CAAED8          10      JP  Z,CTRL1D
000AB6 D7D4 FE45             7      CP  'E'
000AB8 D7D6 2802            12      JR  Z,CT0CX
000ABA D7D8 FE6A             7      CP  'j'
       D7DA                     CT0CX:
000ABC D7DA CAC3D9          10      JP  Z,CTRL0C
000ABF D7DD FE48             7      CP  'H'
000AC1 D7DF CA30D9          10      JP  Z,CTRL0B
000AC4 D7E2 FE4A             7      CP  'J'
000AC6 D7E4 CAC6D9          10      JP  Z,CTRL06
000AC9 D7E7 FE4B             7      CP  'K'
000ACB D7E9 CA02D9          10      JP  Z,CTRL05
000ACE D7EC FE4C             7      CP  'L'
000AD0 D7EE CAF1D9          10      JP  Z,CTRL0E
000AD3 D7F1 FE54             7      CP  'T'
000AD5 D7F3 CA02D9          10      JP  Z,CTRL05
000AD8 D7F6 FE78             7      CP  'x'
000ADA D7F8 2804            12      JR  Z,ESC1X
000ADC D7FA FE79             7      CP  'y'
000ADE D7FC 2002            12      JR  NZ,ESC1Y
       D7FE                     ESC1X:
000AE0 D7FE 3601            10      LD  (HL),1
       D800                     ESC1Y:
000AE2 D800 FE3D             7      CP  '='
000AE4 D802 2804            12      JR  Z,ESC1W
000AE6 D804 FE59             7      CP  'Y'
000AE8 D806 2002            12      JR  NZ,ESC1Z
       D808                     ESC1W:
000AEA D808 3602            10      LD  (HL),2
       D80A                     ESC1Z:
000AEC D80A FE20             7      CP  020H
000AEE D80C 3802            12      JR  C,ESC1C
000AF0 D80E 87               4      ADD A,A
000AF1 D80F D0              11      RET NC
       D810                     ESC1C:
000AF2 D810 E1              10      POP HL
000AF3 D811 1832            12      JR  ANK
                                
       D813                     ESC:
000AF5 D813 2176D8          10      LD  HL,PRINTE5
000AF8 D816 E5              11      PUSH    HL
000AF9 D817 2139D8          10      LD  HL,ESCFLG
000AFC D81A 3600            10      LD  (HL),0
000AFE D81C 3D               4      DEC A
000AFF D81D 28A0            12      JR  Z,ESC1
000B01 D81F 3D               4      DEC A
000B02 D820 2009            12      JR  NZ,ESC2
000B04 D822 3603            10      LD  (HL),3
000B06 D824 7B               4      LD  A,E
000B07 D825 D620             7      SUB 020H
000B09 D827 322ED8          13      LD  (ESCYP+1),A
000B0C D82A C9              10      RET
       D82B                     ESC2:
000B0D D82B 3D               4      DEC A
000B0E D82C C0              11      RET NZ
000B0F D82D 2600             7  ESCYP:  LD  H,0
000B11 D82F 7B               4      LD  A,E
000B12 D830 D620             7      SUB 020H
000B14 D832 6F               4      LD  L,A
000B15 D833 C3D6F0          10      JP  _LOC
                                
       D836                     PRINT:
000B18 D836 C5              11      PUSH    BC
000B19 D837 E5              11      PUSH    HL
000B1A D838 3E00             7      LD  A,000H      ;自己書き換え
       D839                     ESCFLG  EQU $-1
000B1C D83A B7               4      OR  A
000B1D D83B 20D6            12      JR  NZ,ESC
                                
000B1F D83D 3E1F             7      LD  A,01FH
000B21 D83F BB               4      CP  E
000B22 D840 3038            12      JR  NC,CTRL
       D842                     INSFLG  EQU $
000B24 D842 018CD9          10      LD  BC,INSERT   ;自己書き換え
       D845                     ANK:
000B27 D845 3A96F0          13      LD  A,(_COLORF)
000B2A D848 4F               4      LD  C,A
000B2B D849 7B               4      LD  A,E
000B2C D84A FE61             7      CP  'a'     ;英小文字
000B2E D84C 3806            12      JR  C,PRT1
000B30 D84E FE7B             7      CP  'z'+1
000B32 D850 3002            12      JR  NC,PRT1
000B34 D852 CBF9             8      SET 7,C
       D854                     PRT1:
000B36 D854 FE86             7      CP  $86     ;ひらがな1(を－そ)
000B38 D856 3806            12      JR  C,PRT2
000B3A D858 FEA0             7      CP  $A0
000B3C D85A 3002            12      JR  NC,PRT2
000B3E D85C CBF9             8      SET 7,C
       D85E                     PRT2:
000B40 D85E FEE0             7      CP  $E0     ;ひらがな2(たーん)
000B42 D860 3802            12      JR  C,PRT3
000B44 D862 CBF9             8      SET 7,C
       D864                     PRT3:
000B46 D864 2A8EF0          16      LD  HL,(_TXADR)
000B49 D867 7C               4      LD  A,H
000B4A D868 C6D0             7      ADD A,0D0H
000B4C D86A 67               4      LD  H,A
000B4D D86B 42               4      LD  B,D
000B4E D86C 16EE             7      LD  D,HIGH CD_TABLE
000B50 D86E 1A               7      LD  A,(DE)
000B51 D86F 50               4      LD  D,B
000B52 D870 CD63CF          17      CALL    IO_PRINT
000B55 D873 CD8AD8          17      CALL    CTRL1C
       D876                     PRINTE5:
000B58 D876 E1              10      POP HL
000B59 D877 C1              10      POP BC
000B5A D878 AF               4      XOR A
000B5B D879 C9              10      RET
                                
       D87A                     CTRL:
000B5C D87A 7B               4      LD  A,E
000B5D D87B 87               4      ADD A,A
000B5E D87C F680             7      OR  080H
000B60 D87E 6F               4      LD  L,A
000B61 D87F 26F1             7      LD  H,HIGH CTRLTB
000B63 D881 7E               7      LD  A,(HL)
000B64 D882 2C               4      INC L
000B65 D883 66               7      LD  H,(HL)
000B66 D884 6F               4      LD  L,A
000B67 D885 CD0DD7          17      CALL    JPHL
000B6A D888 18EC            12      JR  PRINTE5
                                
       D88A                     CTRL1C:
000B6C D88A ED4B8EF0        20      LD  BC,(_TXADR)
000B70 D88E 03               6      INC BC
       D88F                     PRINTE3:
000B71 D88F 2ABAF0          16      LD  HL,(_PAGE_MINUS)
000B74 D892 A7               4      AND A
000B75 D893 ED4A            15      ADC HL,BC
       D895                     PRINTE8:
000B77 D895 2805            12      JR  Z,PRINT2
000B79 D897 ED438EF0        20      LD  (_TXADR),BC
       D89B                     CTRL00:
000B7D D89B C9              10      RET
                                
       D89C                     PRINT2:
000B7E D89C CDF7D9          17      CALL    SCR
000B81 D89F 21D8FF          10      LD  HL,0-WIDTH
000B84 D8A2 09              11      ADD HL,BC
       D8A3                     SET_TXADR_HL:
000B85 D8A3 228EF0          16      LD  (_TXADR),HL
000B88 D8A6 C9              10      RET
                                
       D8A7                     CTRL08:
000B89 D8A7 3A42D8          13      LD  A,(INSFLG)
000B8C D8AA FECD             7      CP  0CDH        ;CALL ????
000B8E D8AC 2823            12      JR  Z,CTRL02
       D8AE                     CTRL1D:
000B90 D8AE 2A8EF0          16      LD  HL,(_TXADR)
000B93 D8B1 7C               4      LD  A,H
000B94 D8B2 B5               4      OR  L
000B95 D8B3 C8              11      RET Z
000B96 D8B4 2B               6      DEC HL
000B97 D8B5 18EC            12      JR  SET_TXADR_HL
                                
       D8B7                     CTRL1E:
000B99 D8B7 ED4B8EF0        20      LD  BC,(_TXADR)
000B9D D8BB 21D8FF          10      LD  HL,0-WIDTH
000BA0 D8BE 09              11      ADD HL,BC
000BA1 D8BF D0              11      RET NC
000BA2 D8C0 18E1            12      JR  SET_TXADR_HL
                                
       D8C2                     CTRL09:
000BA4 D8C2 ED4B8EF0        20      LD  BC,(_TXADR)
000BA8 D8C6 79               4      LD  A,C
000BA9 D8C7 E6F8             7      AND 0F8H
000BAB D8C9 C608             7      ADD A,8
000BAD D8CB 4F               4      LD  C,A
000BAE D8CC 88               4      ADC A,B
000BAF D8CD 91               4      SUB C
000BB0 D8CE 47               4      LD  B,A
000BB1 D8CF 18BE            12      JR  PRINTE3
                                
       D8D1                     CTRL02:
000BB3 D8D1 CDAED8          17      CALL    CTRL1D
000BB6 D8D4 C8              11      RET Z
000BB7 D8D5 D5              11      PUSH    DE
000BB8 D8D6 CDD3F0          17      CALL    _POS
000BBB D8D9 54               4      LD  D,H
000BBC D8DA 3E28             7      LD  A,WIDTH
000BBE D8DC 95               4      SUB L
000BBF D8DD 4F               4      LD  C,A
000BC0 D8DE 0D               4      DEC C
000BC1 D8DF 06D0             7      LD  B,0D0H
000BC3 D8E1 2A8EF0          16      LD  HL,(_TXADR)
000BC6 D8E4 09              11      ADD HL,BC
000BC7 D8E5 47               4      LD  B,A
                                
000BC8 D8E6 3AADD9          13      LD  A,(MULINE)
000BCB D8E9 BA               4      CP  D
000BCC D8EA 2007            12      JR  NZ,C02X1
000BCE D8EC 112800          10      LD  DE,WIDTH
000BD1 D8EF 19              11      ADD HL,DE
000BD2 D8F0 78               4      LD  A,B
000BD3 D8F1 83               4      ADD A,E
000BD4 D8F2 47               4      LD  B,A
       D8F3                     C02X1:
000BD5 D8F3 3A96F0          13      LD  A,(_COLORF) ;C:Color
000BD8 D8F6 4F               4      LD  C,A
000BD9 D8F7 3E                      DB  03EH        ;LD A,?
000BDA D8F8 2B               6      DEC HL
000BDB D8F9 328BCF          13      LD  (IO_INCDEC),A
000BDE D8FC AF               4      XOR A       ;A:Text
000BDF D8FD CD7ECF          17      CALL    IO_INSBS
000BE2 D900 D1              10      POP DE
000BE3 D901 C9              10      RET
                                
       D902                     CTRL05:
000BE4 D902 CDD3F0          17      CALL    _POS
000BE7 D905 3E28             7      LD  A,WIDTH
000BE9 D907 95               4      SUB L
000BEA D908 47               4      LD  B,A
       D909                     C08X1:
000BEB D909 2A8EF0          16      LD  HL,(_TXADR)
000BEE D90C 7C               4      LD  A,H
000BEF D90D C6D0             7      ADD A,0D0H
000BF1 D90F 67               4      LD  H,A
       D910                     CLLINE:
000BF2 D910 3A96F0          13      LD  A,(_COLORF)
000BF5 D913 4F               4      LD  C,A
000BF6 D914 AF               4      XOR A
000BF7 D915 C36ECF          10      JP  IO_CLLINE
                                
       D918                     CTRL0D:
000BFA D918 CDD3F0          17      CALL    _POS
000BFD D91B 2E00             7      LD  L,0
       D91D                     LOC:
000BFF D91D C5              11      PUSH    BC
000C00 D91E E5              11      PUSH    HL
000C01 D91F CD3DD9          17      CALL    LOC1
000C04 D922 228EF0          16      LD  (_TXADR),HL
000C07 D925 E1              10      POP HL
000C08 D926 C1              10      POP BC
000C09 D927 C9              10      RET
                                
       D928                     CTRL12:
000C0A D928 2142D8          10      LD  HL,INSFLG
000C0D D92B 7E               7      LD  A,(HL)
000C0E D92C EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000C10 D92E 77               7      LD  (HL),A
000C11 D92F C9              10      RET
                                
       D930                     CTRL0B:
000C12 D930 210000          10      LD  HL,0
000C15 D933 228EF0          16      LD  (_TXADR),HL
000C18 D936 C9              10      RET
                                
       D937                     CTRL1B:
000C19 D937 3E01             7      LD  A,1
000C1B D939 3239D8          13      LD  (ESCFLG),A
000C1E D93C C9              10      RET
                                
       D93D                     LOC1:
000C1F D93D D5              11      PUSH    DE
000C20 D93E 4D               4      LD  C,L
000C21 D93F 0608             7      LD  B,8
000C23 D941 5C               4      LD  E,H
000C24 D942 210028          10      LD  HL,WIDTH*256
000C27 D945 55               4      LD  D,L ;L=0
       D946                     LOC2:
000C28 D946 29              11      ADD HL,HL
000C29 D947 3001            12      JR  NC,LOC3
000C2B D949 19              11      ADD HL,DE
       D94A                     LOC3:
000C2C D94A 10FA            13      DJNZ    LOC2
000C2E D94C 09              11      ADD HL,BC
000C2F D94D D1              10      POP DE
000C30 D94E C9              10      RET
                                
       D94F                     CONOUT1:
                                ;   CALL    CURSOR
000C31 D94F 59               4      LD  E,C
000C32 D950 CDCDF0          17      CALL    _PRINT
000C35 D953 7B               4      LD  A,E
000C36 D954 FE0A             7      CP  00AH
000C38 D956 2006            12      JR  NZ,CURSOR
000C3A D958 CD18D9          17      CALL    CTRL0D
000C3D D95B CD02D9          17      CALL    CTRL05
       D95E                     CURSOR:
000C40 D95E C9              10      RET
                                
       D95F                     CTRL07:
000C41 D95F 06E0             7      LD  B,0E0H
000C43 D961 2162F0          10      LD  HL,BEEPD+1
       D964                     C07X0:
000C46 D964 4E               7      LD  C,(HL)
000C47 D965 23               6      INC HL
000C48 D966 7E               7      LD  A,(HL)
000C49 D967 23               6      INC HL
000C4A D968 CD5BCF          17      CALL    WRMMIO_BC
000C4D D96B 7D               4      LD  A,L
000C4E D96C FE6C             7      CP  (BEEPD+1+M7BEEPE-M7BEEPD)&255
000C50 D96E 20F4            12      JR  NZ,C07X0
000C52 D970 0610             7      LD  B,16
       D972                     C07X1:
000C54 D972 CD39CF          17      CALL    RD556VSYNC
000C57 D975 87               4      ADD A,A
000C58 D976 30FA            12      JR  NC,C07X1
       D978                     C07X2:
000C5A D978 CD39CF          17      CALL    RD556VSYNC
000C5D D97B 87               4      ADD A,A
000C5E D97C 38FA            12      JR  C,C07X2
000C60 D97E 10F2            13      DJNZ    C07X1
                                
000C62 D980 AF               4      XOR A
000C63 D981 2108E0          10      LD  HL,0E008H
000C66 D984 CD4BCF          17      CALL    WRMMIO
000C69 D987 2E03             7      LD  L,003H      ;SOUND MASK (MZ-1500)
000C6B D989 C34BCF          10      JP  WRMMIO
                                
       D98C                     INSERT:
000C6E D98C D5              11      PUSH    DE
000C6F D98D CDD3F0          17      CALL    _POS
000C72 D990 54               4      LD  D,H
000C73 D991 3E28             7      LD  A,WIDTH
000C75 D993 95               4      SUB L
000C76 D994 47               4      LD  B,A
000C77 D995 2A8EF0          16      LD  HL,(_TXADR)
000C7A D998 7C               4      LD  A,H
000C7B D999 C6D0             7      ADD A,0D0H
000C7D D99B 67               4      LD  H,A
000C7E D99C 3A96F0          13      LD  A,(_COLORF) ;C:Color
000C81 D99F 4F               4      LD  C,A
000C82 D9A0 3E                      DB  03EH        ;LD A,?
000C83 D9A1 23               6      INC HL
000C84 D9A2 328BCF          13      LD  (IO_INCDEC),A
000C87 D9A5 AF               4      XOR A       ;A:Text
000C88 D9A6 CD7ECF          17      CALL    IO_INSBS
000C8B D9A9 B7               4      OR  A
000C8C D9AA 2005            12      JR  NZ,INS1
       D9AD                     MULINE  EQU $+1
000C8E D9AC 3EFF             7      LD  A,-1
000C90 D9AE 92               4      SUB D
000C91 D9AF 2010            12      JR  NZ,INS2
       D9B1                     INS1:
000C93 D9B1 0628             7      LD  B,WIDTH
000C95 D9B3 F5              11      PUSH    AF
000C96 D9B4 3E                      DB  03EH        ;LD A,?
000C97 D9B5 23               6      INC HL
000C98 D9B6 328BCF          13      LD  (IO_INCDEC),A
000C9B D9B9 F1              10      POP AF
000C9C D9BA CD7ECF          17      CALL    IO_INSBS
000C9F D9BD 7A               4      LD  A,D
000CA0 D9BE 32ADD9          13      LD  (MULINE),A
       D9C1                     INS2:
000CA3 D9C1 D1              10      POP DE
000CA4 D9C2 C9              10      RET
                                
       D9C3                     CTRL0C:
000CA5 D9C3 CD30D9          17      CALL    CTRL0B
       D9C6                     CTRL06:
000CA8 D9C6 D5              11      PUSH    DE
000CA9 D9C7 E5              11      PUSH    HL
000CAA D9C8 ED5B8EF0        20      LD  DE,(_TXADR)
000CAE D9CC 3A96F0          13      LD  A,(_COLORF)
000CB1 D9CF 3219CF          13      LD  (ICSMC),A
000CB4 D9D2 F3               4      DI
000CB5 D9D3 C30ECF          10      JP  IO_CLR
                                
       D9D6                     CTRL04:
000CB8 D9D6 CDD3F0          17      CALL    _POS
000CBB D9D9 7D               4      LD  A,L
000CBC D9DA B7               4      OR  A
000CBD D9DB C8              11      RET Z
       D9DC                     CTRL03:
000CBE D9DC CD18D9          17      CALL    CTRL0D
       D9DF                     CTRL0A:
       D9DF                     CTRL1F:
000CC1 D9DF 2A8EF0          16      LD  HL,(_TXADR)
000CC4 D9E2 012800          10      LD  BC,WIDTH
000CC7 D9E5 09              11      ADD HL,BC
000CC8 D9E6 44               4      LD  B,H
000CC9 D9E7 4D               4      LD  C,L
000CCA D9E8 2ABAF0          16      LD  HL,(_PAGE_MINUS)
000CCD D9EB 09              11      ADD HL,BC
000CCE D9EC 3F               4      CCF
000CCF D9ED 9F               4      SBC A,A
000CD0 D9EE C395D8          10      JP  PRINTE8
                                
       D9F1                     CTRL0E:
000CD3 D9F1 CDD3F0          17      CALL    _POS
000CD6 D9F4 7C               4      LD  A,H
000CD7 D9F5 1804            12      JR  SCR1
       D9F7                     SCR:
000CD9 D9F7 3A97F0          13      LD  A,(_LINE)
000CDC D9FA 3D               4      DEC A
       D9FB                     SCR1:
000CDD D9FB C5              11      PUSH    BC
000CDE D9FC D5              11      PUSH    DE
000CDF D9FD E5              11      PUSH    HL
000CE0 D9FE 1100D0          10      LD  DE,0D000H
000CE3 DA01 2128D0          10      LD  HL,0D000H+WIDTH
                                
000CE6 DA04 47               4      LD  B,A
000CE7 DA05 B7               4      OR  A
000CE8 DA06 C392CF          10      JP  IO_SCRUP
                                
       DA09                     POS:
000CEB DA09 2A8EF0          16      LD  HL,(_TXADR)
000CEE DA0C C5              11      PUSH    BC
000CEF DA0D 01D8FF          10      LD  BC,0-WIDTH
000CF2 DA10 AF               4      XOR A
       DA11                     POS1:
000CF3 DA11 09              11      ADD HL,BC
000CF4 DA12 3C               4      INC A
000CF5 DA13 38FC            12      JR  C,POS1
000CF7 DA15 ED42            15      SBC HL,BC
000CF9 DA17 3D               4      DEC A
000CFA DA18 67               4      LD  H,A
000CFB DA19 C1              10      POP BC
000CFC DA1A A7               4      AND A
000CFD DA1B C9              10      RET
                                
       DA1C                     GETL:
000CFE DA1C CDD3F0          17      CALL    _POS
000D01 DA1F E5              11      PUSH    HL
000D02 DA20 3ECD             7      LD  A,0CDH      ;CALL ????
000D04 DA22 3242D8          13      LD  (INSFLG),A
       DA25                     GETL1:
000D07 DA25 CD34D7          17      CALL    _SYS08
000D0A DA28 FE09             7      CP  9
000D0C DA2A 2008            12      JR  NZ,GETL1V
000D0E DA2C 2130FF          10      LD  HL,KBUF
000D11 DA2F CD8AD4          17      CALL    MSX
000D14 DA32 18F1            12      JR  GETL1
       DA34                     GETL1V:
000D16 DA34 5F               4      LD  E,A
000D17 DA35 CDD3F0          17      CALL    _POS
000D1A DA38 CDCDF0          17      CALL    _PRINT
000D1D DA3B 7B               4      LD  A,E
000D1E DA3C FE20             7      CP  $20
000D20 DA3E 3809            12      JR  C,GETL1V1
000D22 DA40 7D               4      LD  A,L
000D23 DA41 FE27             7      CP  WIDTH-1
000D25 DA43 2004            12      JR  NZ,GETL1V1
000D27 DA45 7C               4      LD  A,H
000D28 DA46 32ADD9          13      LD  (MULINE),A
       DA49                     GETL1V1:
000D2B DA49 7B               4      LD  A,E
000D2C DA4A FE0D             7      CP  00DH
000D2E DA4C 20D7            12      JR  NZ,GETL1
000D30 DA4E 3E01             7      LD  A,1     ;LD BC,????
000D32 DA50 3242D8          13      LD  (INSFLG),A
000D35 DA53 1130FF          10      LD  DE,KBUF
000D38 DA56 0628             7      LD  B,WIDTH
000D3A DA58 CD29D3          17      CALL    ZERO_MEMORY_DE
                                
000D3D DA5B D1              10      POP DE
000D3E DA5C CDD3F0          17      CALL    _POS
000D41 DA5F 6B               4      LD  L,E
000D42 DA60 3E28             7      LD  A,WIDTH
000D44 DA62 95               4      SUB L
000D45 DA63 57               4      LD  D,A
                                
000D46 DA64 3AADD9          13      LD  A,(MULINE)
000D49 DA67 94               4      SUB H
000D4A DA68 280A            12      JR  Z,GL2X
000D4C DA6A 3C               4      INC A
000D4D DA6B 2010            12      JR  NZ,GL3X
000D4F DA6D 7C               4      LD  A,H
000D50 DA6E B7               4      OR  A
000D51 DA6F 280C            12      JR  Z,GL3X
000D53 DA71 25               4      DEC H
000D54 DA72 1805            12      JR  GL4X
       DA74                     GL2X:
000D56 DA74 3E1F             7      LD  A,$1F
000D58 DA76 CD1ED7          17      CALL    MSG_A
       DA79                     GL4X:
000D5B DA79 7A               4      LD  A,D
000D5C DA7A C628             7      ADD A,WIDTH
000D5E DA7C 57               4      LD  D,A
       DA7D                     GL3X:
000D5F DA7D CD3DD9          17      CALL    LOC1
000D62 DA80 4D               4      LD  C,L
000D63 DA81 7C               4      LD  A,H
000D64 DA82 C6D0             7      ADD A,0D0H
000D66 DA84 47               4      LD  B,A
000D67 DA85 5A               4      LD  E,D
000D68 DA86 2130FF          10      LD  HL,KBUF
       DA89                     GETL2:
000D6B DA89 CDD0F0          17      CALL    _SCRN
000D6E DA8C 03               6      INC BC
000D6F DA8D 77               7      LD  (HL),A
000D70 DA8E 23               6      INC HL
000D71 DA8F 1D               4      DEC E
000D72 DA90 20F7            12      JR  NZ,GETL2
       DA92                     GETL3:
000D74 DA92 2B               6      DEC HL
000D75 DA93 7E               7      LD  A,(HL)
000D76 DA94 FE21             7      CP  021H
000D78 DA96 D0              11      RET NC
000D79 DA97 3600            10      LD  (HL),0
000D7B DA99 15               4      DEC D
000D7C DA9A 20F6            12      JR  NZ,GETL3
000D7E DA9C C9              10      RET
                                
       DA9D                     INKEYB:
000D7F DA9D C1              10      POP BC
000D80 DA9E CB47             8      BIT 0,A
000D82 DAA0 3E08             7      LD  A,8
000D84 DAA2 2002            12      JR  NZ,SETKEYD
000D86 DAA4 3E03             7      LD  A,3
       DAA6                     SETKEYD:
000D88 DAA6 3292F0          13      LD  (_KEYD),A
       DAA9                     GETKEYD:
000D8B DAA9 3A92F0          13      LD  A,(_KEYD)
000D8E DAAC B7               4      OR  A
       DAAD                     GETKEYD_SWC:            ;ここがSCFの場合はキーを離すまで戻り値は0になる（自己書き換え）
000D8F DAAD A7               4      AND A
000D90 DAAE D0              11      RET NC
000D91 DAAF 2005            12      JR  NZ,GETKEYD1
000D93 DAB1 3E                      DB  03EH
000D94 DAB2 A7               4      AND A
000D95 DAB3 32ADDA          13      LD  (GETKEYD_SWC),A
       DAB6                     GETKEYD1:
000D98 DAB6 AF               4      XOR A
000D99 DAB7 C9              10      RET
                                
       DAB8                     INKEY:
                                #IF EXISTS USE_8253
                                    EI
                                    PUSH    HL
                                    LD  HL,(_KEYPS)
                                    LD  A,H
                                    XOR L
                                    JR  Z,INKEY1
                                    LD  A,H
                                    INC A
                                    AND 01FH
                                    LD  (_KEYPS+1),A
                                    LD  L,A
                                    LD  H,HIGH KEYBF
                                    LD  A,(HL)
                                INKEY1:
                                    POP HL
                                    OR  A
                                    RET
                                #ELSE
000D9A DAB8 E5              11      PUSH    HL
       DAB9                     GETKEY:
000D9B DAB9 CDA9DA          17      CALL    GETKEYD
000D9E DABC 6F               4      LD  L,A
000D9F DABD 2610             7      LD  H,16
       DABE                     GKSMC   EQU $-1
       DABF                     GETKEY1:
000DA1 DABF 3E01             7      LD  A,1
       DAC0                     SKIP_KEYWAIT:   EQU $-1
000DA3 DAC1 B7               4      OR  A
000DA4 DAC2 C4F2DA          17      CALL    NZ,CHKEY    ;キーを離すまで待つ
000DA7 DAC5 281E            12      JR  Z,GETKEY2
000DA9 DAC7 BD               4      CP  L
000DAA DAC8 201B            12      JR  NZ,GETKEY2
000DAC DACA CD39CF          17      CALL    RD556VSYNC
000DAF DACD 87               4      ADD A,A
000DB0 DACE 30EF            12      JR  NC,GETKEY1
       DAD0                     GETKEY1X:
000DB2 DAD0 CDF2DA          17      CALL    CHKEY       ;キーを離すまで待つ
000DB5 DAD3 2810            12      JR  Z,GETKEY2
000DB7 DAD5 BD               4      CP  L
000DB8 DAD6 200D            12      JR  NZ,GETKEY2
000DBA DAD8 CD39CF          17      CALL    RD556VSYNC
000DBD DADB 87               4      ADD A,A
000DBE DADC 38F2            12      JR  C,GETKEY1X
000DC0 DADE 25               4      DEC H
000DC1 DADF 20DE            12      JR  NZ,GETKEY1
000DC3 DAE1 3E01             7      LD  A,1
000DC5 DAE3 1805            12      JR  GETKEY3
       DAE5                     GETKEY2:
000DC7 DAE5 3E10             7      LD  A,16
000DC9 DAE7 32C0DA          13      LD  (SKIP_KEYWAIT),A
       DAEA                     GETKEY3:
000DCC DAEA 32BEDA          13      LD  (GKSMC),A
000DCF DAED CDA9DA          17      CALL    GETKEYD
000DD2 DAF0 E1              10      POP HL
000DD3 DAF1 C9              10      RET
                                #ENDIF
       DAF2                     CHKEY:
000DD4 DAF2 C5              11      PUSH    BC
000DD5 DAF3 3E88             7      LD  A,$88
000DD7 DAF5 CD2CCF          17      CALL    RDKEYDATA
000DDA DAF8 4F               4      LD  C,A
000DDB DAF9 3A93F0          13      LD  A,(_KEYST)
000DDE DAFC B9               4      CP  C
000DDF DAFD 79               4      LD  A,C
000DE0 DAFE 3293F0          13      LD  (_KEYST),A
000DE3 DB01 280F            12      JR  Z,KEYST2
000DE5 DB03 CDA9DA          17      CALL    GETKEYD
000DE8 DB06 2809            12      JR  Z,KEYST1
000DEA DB08 AF               4      XOR A
000DEB DB09 3292F0          13      LD  (_KEYD),A
000DEE DB0C 3E                      DB  03EH
000DEF DB0D 37               4      SCF
000DF0 DB0E 32ADDA          13      LD  (GETKEYD_SWC),A
       DB11                     KEYST1:
000DF3 DB11 79               4      LD  A,C
       DB12                     KEYST2:
000DF4 DB12 CB7F             8      BIT 7,A
000DF6 DB14 2887            12      JR  Z,INKEYB
000DF8 DB16 E5              11      PUSH    HL
000DF9 DB17 0E87             7      LD  C,$87
000DFB DB19 2140ED          10      LD  HL,KEY_TABLE
000DFE DB1C CB47             8      BIT 0,A
000E00 DB1E 2003            12      JR  NZ,CHKEY0
000E02 DB20 2180ED          10      LD  HL,SHIFT_TABLE
       DB23                     CHKEY0:
000E05 DB23 CB77             8      BIT 6,A
000E07 DB25 2003            12      JR  NZ,CHKEY1
000E09 DB27 21C0ED          10      LD  HL,CTRL_TABLE
       DB2A                     CHKEY1:
000E0C DB2A 79               4      LD  A,C
000E0D DB2B CD2CCF          17      CALL    RDKEYDATA
000E10 DB2E 0608             7      LD  B,8
       DB30                     CHKEY2:
000E12 DB30 87               4      ADD A,A
000E13 DB31 300A            12      JR  NC,CHKEY3
000E15 DB33 23               6      INC HL
000E16 DB34 10FA            13      DJNZ    CHKEY2
000E18 DB36 0D               4      DEC C
000E19 DB37 CB79             8      BIT 7,C
000E1B DB39 20EF            12      JR  NZ,CHKEY1
000E1D DB3B AF               4      XOR A
000E1E DB3C 06                      DB  $06     ;LD B,?? 次の1バイトを飛ばす
       DB3D                     CHKEY3:
000E1F DB3D 7E               7      LD  A,(HL)
000E20 DB3E E1              10      POP HL
000E21 DB3F C1              10      POP BC
000E22 DB40 C3A6DA          10      JP  SETKEYD
                                
       DB43                     SCRN:
000E25 DB43 E5              11      PUSH    HL
000E26 DB44 CD53CF          17      CALL    RDMMIO_BC
000E29 DB47 6F               4      LD  L,A
000E2A DB48 26EF             7      LD  H,HIGH DC_TABLE
000E2C DB4A 7E               7      LD  A,(HL)
000E2D DB4B FE41             7      CP  'A'     ;英小文字チェック
000E2F DB4D 380E            12      JR  C,SCRN1
000E31 DB4F FE5B             7      CP  'Z'+1
000E33 DB51 DC5FDB          17      CALL    C,SCRNC
000E36 DB54 FEA6             7      CP  $A6     ;ひらがなチェック
000E38 DB56 3805            12      JR  C,SCRN1
000E3A DB58 FEE0             7      CP  $E0
000E3C DB5A DC5FDB          17      CALL    C,SCRNC
       DB5D                     SCRN1:
000E3F DB5D E1              10      POP HL
000E40 DB5E C9              10      RET
                                
       DB5F                     SCRNC:
000E41 DB5F 6F               4      LD  L,A
000E42 DB60 60               4      LD  H,B
000E43 DB61 CBD8             8      SET 3,B
000E45 DB63 CD53CF          17      CALL    RDMMIO_BC
000E48 DB66 44               4      LD  B,H
000E49 DB67 CB7F             8      BIT 7,A
000E4B DB69 7D               4      LD  A,L
000E4C DB6A C8              11      RET Z
000E4D DB6B FE5B             7      CP  'Z'+1
000E4F DB6D 3804            12      JR  C,SCRNC_ADD
000E51 DB6F FEC0             7      CP  $C0
000E53 DB71 3803            12      JR  C,SCRNC_SUB
       DB73                     SCRNC_ADD:
000E55 DB73 C620             7      ADD A,$20
000E57 DB75 C9              10      RET
       DB76                     SCRNC_SUB:
000E58 DB76 D620             7      SUB $20
000E5A DB78 C9              10      RET
       DB79                     C_MON:
000E5B DB79 2100D8          10      LD  HL,0D800H
       DB7C                     MON1:
000E5E DB7C 3E71             7      LD  A,071H
000E60 DB7E CD4BCF          17      CALL    WRMMIO
000E63 DB81 23               6      INC HL
000E64 DB82 CB54             8      BIT 2,H
000E66 DB84 28F6            12      JR  Z,MON1
000E68 DB86 C3C6CF          10      JP  IO_MON
[EOF:M7IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       DB89                     FILEC:
000E6B DB89 CD94DB          17      CALL    FILE
       DB8C                     FILEC2:
000E6E DB8C 3A15F0          13      LD  A,(FDRV+1)
000E71 DB8F FE20             7      CP  020H
000E73 DB91 C8              11      RET Z
000E74 DB92 1839            12      JR  SETDIR1
                                
       DB94                     FILE:
000E76 DB94 AF               4      XOR A
000E77 DB95 3214F0          13      LD  (FDRV),A
000E7A DB98 67               4      LD  H,A
000E7B DB99 6F               4      LD  L,A
000E7C DB9A 2222F0          16      LD  (FDRV+14),HL
000E7F DB9D CD6ADC          17      CALL    SPCUT
000E82 DBA0 CD4FDC          17      CALL    CCHK3
000E85 DBA3 2812            12      JR  Z,DEVI1
000E87 DBA5 13               6      INC DE
000E88 DBA6 1A               7      LD  A,(DE)
000E89 DBA7 1B               6      DEC DE
000E8A DBA8 FE3A             7      CP  ':'
000E8C DBAA 200B            12      JR  NZ,DEVI1
000E8E DBAC 1A               7      LD  A,(DE)      ;DRIVE
000E8F DBAD CDB0DE          17      CALL    CAP
000E92 DBB0 D640             7      SUB '@'
000E94 DBB2 13               6      INC DE
000E95 DBB3 13               6      INC DE
000E96 DBB4 3214F0          13      LD  (FDRV),A
       DBB7                     DEVI1:
000E99 DBB7 1A               7      LD  A,(DE)
000E9A DBB8 D65C             7      SUB 05CH        ;\
000E9C DBBA 2009            12      JR  NZ,NOROOT
000E9E DBBC 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
000E9F DBBD 222EF0          16      LD  (FDRV+26),HL
000EA2 DBC0 2C               4      INC L
000EA3 DBC1 2222F0          16      LD  (FDRV+14),HL
000EA6 DBC4 13               6      INC DE
       DBC5                     NOROOT:
                                
       DBC5                     SETDIR:
000EA7 DBC5 CDF0DB          17      CALL    FILED
000EAA DBC8 1A               7      LD  A,(DE)
000EAB DBC9 FE5C             7      CP  05CH        ;\
000EAD DBCB C0              11      RET NZ
000EAE DBCC 13               6      INC DE
       DBCD                     SETDIR1:
000EAF DBCD 3E10             7      LD  A,010H      ;Directory
000EB1 DBCF 3221F0          13      LD  (FDRV+13),A
000EB4 DBD2 D5              11      PUSH    DE
000EB5 DBD3 1114F0          10      LD  DE,FDRV
000EB8 DBD6 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000EBA DBD8 CD4BD4          17      CALL    BDOS0
000EBD DBDB D1              10      POP DE
000EBE DBDC B7               4      OR  A
000EBF DBDD C0              11      RET NZ
                                
000EC0 DBDE 3A21F0          13      LD  A,(FDRV+13)
000EC3 DBE1 E610             7      AND 010H        ;ディレクトリ
000EC5 DBE3 C8              11      RET Z
                                
000EC6 DBE4 CD37DC          17      CALL    FILEI
000EC9 DBE7 2A2EF0          16      LD  HL,(FDRV+26)
000ECC DBEA 23               6      INC HL
000ECD DBEB 2222F0          16      LD  (FDRV+14),HL
000ED0 DBEE 18D5            12      JR  SETDIR
                                
       DBF0                     FILED:
000ED2 DBF0 CD37DC          17      CALL    FILEI
000ED5 DBF3 2115F0          10      LD  HL,FNAME
                                
000ED8 DBF6 0608             7      LD  B,8
       DBF8                     FILE2:
000EDA DBF8 CD44DC          17      CALL    CCHKF
000EDD DBFB C8              11      RET Z
000EDE DBFC FE2A             7      CP  '*'
000EE0 DBFE 282E            12      JR  Z,FILE9
000EE2 DC00 FE2E             7      CP  '.'
000EE4 DC02 280C            12      JR  Z,FILE4
000EE6 DC04 77               7      LD  (HL),A
000EE7 DC05 23               6      INC HL
000EE8 DC06 10F0            13      DJNZ    FILE2
                                
       DC08                     FILE3:
000EEA DC08 CD44DC          17      CALL    CCHKF
000EED DC0B C8              11      RET Z
000EEE DC0C FE2E             7      CP  '.'
000EF0 DC0E 20F8            12      JR  NZ,FILE3
                                
       DC10                     FILE4:
000EF2 DC10 211DF0          10      LD  HL,FNAME+8
000EF5 DC13 0603             7      LD  B,3
                                
       DC15                     FILE4L:
000EF7 DC15 CD44DC          17      CALL    CCHKF
000EFA DC18 C8              11      RET Z
000EFB DC19 FE2E             7      CP  '.'
000EFD DC1B 2008            12      JR  NZ,FILE12
000EFF DC1D 3215F0          13      LD  (FNAME),A   ;Parent directory(..)
000F02 DC20 3216F0          13      LD  (FNAME+1),A
000F05 DC23 3E20             7      LD  A,020H
       DC25                     FILE12:
000F07 DC25 FE2A             7      CP  '*'
000F09 DC27 280A            12      JR  Z,FILE10
000F0B DC29 77               7      LD  (HL),A
000F0C DC2A 23               6      INC HL
000F0D DC2B 10E8            13      DJNZ    FILE4L
000F0F DC2D C9              10      RET
                                
       DC2E                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000F10 DC2E CD33DC          17      CALL    FILE10
000F13 DC31 18D5            12      JR  FILE3
                                
       DC33                     FILE10:
000F15 DC33 3E3F             7      LD  A,'?'
000F17 DC35 1808            12      JR  FILL_MEMORY
       DC37                     FILEI:              ;名前＋拡張子をスペースで初期化
000F19 DC37 3E20             7      LD  A,020H
000F1B DC39 01000B          10      LD  BC,11*256   ;C=0にしておく
000F1E DC3C 2115F0          10      LD  HL,FNAME
       DC3F                     FILL_MEMORY:            ;HLからBバイトAで埋める
000F21 DC3F 77               7      LD  (HL),A
000F22 DC40 23               6      INC HL
000F23 DC41 10FC            13      DJNZ    FILL_MEMORY
000F25 DC43 C9              10      RET
                                
       DC44                     CCHKF:
000F26 DC44 1A               7      LD  A,(DE)
000F27 DC45 CD4CDC          17      CALL    CCHK2
000F2A DC48 C8              11      RET Z
000F2B DC49 C3B8DF          10      JP  FKAN
                                
       DC4C                     CCHK2:
000F2E DC4C 0C               4      INC C
000F2F DC4D 0D               4      DEC C
000F30 DC4E C0              11      RET NZ
       DC4F                     CCHK3:              ;ZF=1 で使えない文字
000F31 DC4F FE2B             7      CP  '+'
000F33 DC51 C8              11      RET Z
000F34 DC52 FE2C             7      CP  ','
000F36 DC54 C8              11      RET Z
000F37 DC55 FE2F             7      CP  '/'
000F39 DC57 C8              11      RET Z
000F3A DC58 FE3A             7      CP  ':'
000F3C DC5A C8              11      RET Z
000F3D DC5B FE3B             7      CP  ';'
000F3F DC5D C8              11      RET Z
000F40 DC5E FE3D             7      CP  '='
000F42 DC60 C8              11      RET Z
000F43 DC61 FE5C             7      CP  05CH    ;\
000F45 DC63 C8              11      RET Z
000F46 DC64 FE20             7      CP  020H
000F48 DC66 D0              11      RET NC
000F49 DC67 BF               4      CP  A       ;Z=1
000F4A DC68 C9              10      RET
                                
       DC69                     SS1:
000F4B DC69 13               6      INC DE
       DC6A                     SPCUT:              ;スペースをカット
000F4C DC6A 1A               7      LD  A,(DE)
000F4D DC6B FE20             7      CP  020H
000F4F DC6D 28FA            12      JR  Z,SS1
000F51 DC6F C9              10      RET
                                
       DC70                     SETDRVF:
000F52 DC70 1114F0          10      LD  DE,FDRV
       DC73                     SETDRV0:
000F55 DC73 CD7CDC          17      CALL    SETDRV
000F58 DC76 FDE1            14      POP IY
000F5A DC78 C1              10      POP BC
000F5B DC79 D1              10      POP DE
000F5C DC7A E1              10      POP HL
000F5D DC7B C9              10      RET
                                
       DC7C                     SETDRV:
000F5E DC7C E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
000F5F DC7D D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
000F60 DC7E C5              11      PUSH    BC
000F61 DC7F 1A               7      LD  A,(DE)
000F62 DC80 D5              11      PUSH    DE
000F63 DC81 FDE3            23      EX  (SP),IY
                                
000F65 DC83 CD8ADC          17      CALL    GETDRV
000F68 DC86 CDD9F0          17      CALL    _CHGDRV
                                
000F6B DC89 E9               4      JP  (HL)
                                
       DC8A                     GETDRV:
000F6C DC8A CD9DDC          17      CALL    GETDRV1
000F6F DC8D 3288F0          13      LD  (_DRV),A
000F72 DC90 C9              10      RET
                                
       DC91                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
000F73 DC91 CD9DDC          17      CALL    GETDRV1
000F76 DC94 C5              11      PUSH    BC
000F77 DC95 4F               4      LD  C,A
000F78 DC96 1A               7      LD  A,(DE)
000F79 DC97 CD9DDC          17      CALL    GETDRV1
000F7C DC9A A9               4      XOR C
000F7D DC9B C1              10      POP BC
000F7E DC9C C9              10      RET
       DC9D                     GETDRV1:
000F7F DC9D E67F             7      AND 07FH
000F81 DC9F D601             7      SUB 001H
000F83 DCA1 D0              11      RET NC
000F84 DCA2 3A0400          13      LD  A,(_DVSW)   ;Current Drive
000F87 DCA5 C9              10      RET
                                
       DCA6                     SOPENX:
000F88 DCA6 1139F0          10      LD  DE,SFILE
000F8B DCA9 FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
000F8E DCAC CD91DC          17      CALL    IS_SAME_DRV_A_DE
000F91 DCAF 2024            12      JR  NZ,SOPEN
000F93 DCB1 13               6      INC DE
000F94 DCB2 FDE5            15      PUSH    IY
000F96 DCB4 E1              10      POP HL
000F97 DCB5 23               6      INC HL
000F98 DCB6 CD41DE          17      CALL    CPFILE
000F9B DCB9 201A            12      JR  NZ,SOPEN
                                
000F9D DCBB 2AF4F1          16      LD  HL,(SCDIR)
000FA0 DCBE FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
000FA3 DCC1 FD740F          19      LD  (IY+15),H
                                
000FA6 DCC4 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
000FA9 DCC7 229FF0          16      LD  (_FILEN),HL
                                
000FAC DCCA ED5BF6F1        20      LD  DE,(SFBPS)
000FB0 DCCE 2139F0          10      LD  HL,SFILE
000FB3 DCD1 36FF            10      LD  (HL),0FFH
000FB5 DCD3 23               6      INC HL
000FB6 DCD4 C9              10      RET
       DCD5                     SOPEN:
000FB7 DCD5 21E9DD          10      LD  HL,FILESE
       DCD8                     SOPENC:
000FBA DCD8 2211DD          16      LD  (OPENPAT),HL
                                
000FBD DCDB CDE2F0          17      CALL    _RDFATX     ;Detect Media
000FC0 DCDE 3856            12      JR  C,RDDERR
                                
000FC2 DCE0 AF               4      XOR A
000FC3 DCE1 329FF0          13      LD  (_FILEN),A
000FC6 DCE4 CDEDDE          17      CALL    LDDIRX1     ;A=0で呼び出す
000FC9 DCE7 2818            12      JR  Z,SDIRX1
                                
000FCB DCE9 CDDADD          17      CALL    READ_DIR    ;Sub Directory
000FCE DCEC 3808            12      JR  C,SDIRX0
000FD0 DCEE 2A7EF1          16      LD  HL,(_DTBUF)
000FD3 DCF1 7E               7      LD  A,(HL)
000FD4 DCF2 FE2E             7      CP  '.'
000FD6 DCF4 280F            12      JR  Z,SOPEN1
       DCF6                     SDIRX0:
000FD8 DCF6 AF               4      XOR A
000FD9 DCF7 32A0F0          13      LD  (_DIRF),A
000FDC DCFA FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
000FE0 DCFE FD770F          19      LD  (IY+15),A
       DD01                     SDIRX1:
000FE3 DD01 ED5BFCF1        20      LD  DE,(_DIRPS) ;Root Directory
       DD05                     SOPEN1:
000FE7 DD05 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       DD06                     SDECPAT EQU $-1
       DD07                     SOPEN1X:
000FE9 DD07 CDDADD          17      CALL    READ_DIR    ;FILE SEARCH
000FEC DD0A 382A            12      JR  C,RDDERR
000FEE DD0C 2A7EF1          16      LD  HL,(_DTBUF)
       DD0F                     SOPEN2:
000FF1 DD0F D5              11      PUSH    DE
000FF2 DD10 CDE9DD          17      CALL    FILESE      ;(self-modifying code)
       DD11                     OPENPAT EQU $-2
000FF5 DD13 D1              10      POP DE
000FF6 DD14 386D            12      JR  C,SOPENE
000FF8 DD16 281B            12      JR  Z,SCF_FF_RET
       DD18                     SOPEN3:
000FFA DD18 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
000FFD DD1B B7               4      OR  A
000FFE DD1C 200C            12      JR  NZ,SOPEN5
001000 DD1E 13               6      INC DE      ;ルートディレクトリ
001001 DD1F E5              11      PUSH    HL
001002 DD20 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       DD21                     MD_PAT  EQU $-2
001005 DD23 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
001007 DD25 E1              10      POP HL
001008 DD26 20DD            12      JR  NZ,SOPEN1
00100A DD28 1807            12      JR  SOPEN6
       DD2A                     SOPEN5:
00100C DD2A CDF4E5          17      CALL    GNCLX       ;END DIR
00100F DD2D D8              11      RET C
001010 DD2E CDA1DE          17      CALL    ENDCL
       DD31                     SOPEN6:
001013 DD31 38D2            12      JR  C,SOPEN1
       DD33                     SCF_FF_RET:
001015 DD33 37               4      SCF         ;CF=1
001016 DD34 9F               4      SBC A,A     ;A=0FFH
001017 DD35 C9              10      RET
                                
       DD36                     RDDERR:
001018 DD36 BF               4      CP  A       ;READ ERR CF=1 ZF=1
001019 DD37 37               4      SCF
00101A DD38 C9              10      RET
                                
       DD39                     NOPEN:
00101B DD39 21E9DD          10      LD  HL,FILESE
00101E DD3C 2211DD          16      LD  (OPENPAT),HL
001021 DD3F FD2A98F0        20      LD  IY,(_FCB)
001025 DD43 CDCBDF          17      CALL    CHKWILDX
001028 DD46 30EB            12      JR  NC,SCF_FF_RET
00102A DD48 FD7E00          19      LD  A,(IY+0)
00102D DD4B CD8ADC          17      CALL    GETDRV
001030 DD4E CDD9F0          17      CALL    _CHGDRV
001033 DD51 D8              11      RET C
001034 DD52 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
001037 DD55 229FF0          16      LD  (_FILEN),HL
                                
00103A DD58 CDE8DE          17      CALL    LDDIRX
00103D DD5B ED5B9AF0        20      LD  DE,(_FBPS)
001041 DD5F CDDADD          17      CALL    READ_DIR
001044 DD62 38D2            12      JR  C,RDDERR
001046 DD64 3A9EF0          13      LD  A,(_FBCNT)
001049 DD67 3D               4      DEC A
00104A DD68 28AE            12      JR  Z,SOPEN3
       DD6A                     NOPEN2:
00104C DD6A 2A9CF0          16      LD  HL,(_FBAD)
00104F DD6D 012000          10      LD  BC,020H
001052 DD70 09              11      ADD HL,BC
001053 DD71 4F               4      LD  C,A
001054 DD72 189B            12      JR  SOPEN2
                                
       DD74                     SOPENE2:
001056 DD74 229CF0          16      LD  (_FBAD),HL
001059 DD77 79               4      LD  A,C
00105A DD78 329EF0          13      LD  (_FBCNT),A
00105D DD7B ED539AF0        20      LD  (_FBPS),DE
001061 DD7F FD2298F0        20      LD  (_FCB),IY
       DD83                     SOPENE:
001065 DD83 AF               4      XOR A
001066 DD84 C9              10      RET
                                
       DD85                     COPEN:
001067 DD85 FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
00106B DD89 2106DE          10      LD  HL,NEXTSE
00106E DD8C CDD8DC          17      CALL    SOPENC
001071 DD8F D0              11      RET NC
001072 DD90 C8              11      RET Z
001073 DD91 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
001076 DD94 B7               4      OR  A
001077 DD95 37               4      SCF
001078 DD96 C8              11      RET Z       ;ルートディレクトリ
001079 DD97 0601             7      LD  B,1
00107B DD99 CD2AE0          17      CALL    WRDF
00107E DD9C D8              11      RET C
00107F DD9D ED5BFEF1        20      LD  DE,(_CLPS)
001083 DDA1 D5              11      PUSH    DE
001084 DDA2 CD6ADE          17      CALL    DCPAT
001087 DDA5 CD75E4          17      CALL    DRDNX
00108A DDA8 2A7EF1          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
00108D DDAB ED4B60E3        20      LD  BC,(SECSZ)  ;1セクタのサイズ
001091 DDAF AF               4      XOR A
       DDB0                     COPENCL:
001092 DDB0 77               7      LD  (HL),A
001093 DDB1 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
001095 DDB3 EAB0DD          10      JP  PE,COPENCL
                                
001098 DDB6 3A88DE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
00109B DDB9 3D               4      DEC A
00109C DDBA 2819            12      JR  Z,COPENE
00109E DDBC 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
0010A0 DDBE 32ECE5          13      LD  (_SECPS),A
0010A3 DDC1 D1              10      POP DE      ;DE=(_CLPS)
0010A4 DDC2 D5              11      PUSH    DE
       DDC3                     COPEN1:
0010A5 DDC3 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
0010A6 DDC4 C5              11      PUSH    BC
0010A7 DDC5 2A7EF1          16      LD  HL,(_DTBUF)
0010AA DDC8 CD84DE          17      CALL    CLUSTX
0010AD DDCB CD8BE7          17      CALL    DWT24
0010B0 DDCE C1              10      POP BC
0010B1 DDCF D1              10      POP DE
0010B2 DDD0 CDEBE5          17      CALL    NEXTX
0010B5 DDD3 20EE            12      JR  NZ,COPEN1
       DDD5                     COPENE:
0010B7 DDD5 2A7EF1          16      LD  HL,(_DTBUF)
0010BA DDD8 D1              10      POP DE
0010BB DDD9 C9              10      RET
                                
       DDDA                     READ_DIR:
0010BC DDDA ED53FEF1        20      LD  (_CLPS),DE
0010C0 DDDE C5              11      PUSH    BC
0010C1 DDDF D5              11      PUSH    DE
0010C2 DDE0 CD6ADE          17      CALL    DCPAT
0010C5 DDE3 CD55E4          17      CALL    DRDX
0010C8 DDE6 D1              10      POP DE
0010C9 DDE7 C1              10      POP BC
0010CA DDE8 C9              10      RET
                                
       DDE9                     FILESE:
0010CB DDE9 7E               7      LD  A,(HL)
0010CC DDEA B7               4      OR  A
0010CD DDEB C8              11      RET Z       ;END:ZF=1 CF=0
0010CE DDEC FEE5             7      CP  0E5H
0010D0 DDEE 280E            12      JR  Z,FILESE1
0010D2 DDF0 FDE5            15      PUSH    IY
0010D4 DDF2 D1              10      POP DE
0010D5 DDF3 13               6      INC DE
0010D6 DDF4 E5              11      PUSH    HL
0010D7 DDF5 CD41DE          17      CALL    CPFILE
0010DA DDF8 CC62DE          17      CALL    Z,CPFILE2
0010DD DDFB E1              10      POP HL
0010DE DDFC 37               4      SCF
0010DF DDFD C8              11      RET Z       ;!!!:(ZF=1) CF=1
       DDFE                     FILESE1:
0010E0 DDFE CD15DE          17      CALL    FNEXT
0010E3 DE01 20E6            12      JR  NZ,FILESE
       DE03                     ZF0_CF0_AFF_RET:
0010E5 DE03 F6FF             7      OR  0FFH        ;ZF=0 CF=0
0010E7 DE05 C9              10      RET
                                
       DE06                     NEXTSE:
0010E8 DE06 7E               7      LD  A,(HL)
0010E9 DE07 B7               4      OR  A
0010EA DE08 37               4      SCF
0010EB DE09 C8              11      RET Z       ;!!!:ZF=1 CF=1
0010EC DE0A FEE5             7      CP  0E5H
0010EE DE0C 37               4      SCF
0010EF DE0D C8              11      RET Z       ;!!!:(ZF=1) CF=1
0010F0 DE0E CD15DE          17      CALL    FNEXT
0010F3 DE11 20F3            12      JR  NZ,NEXTSE
0010F5 DE13 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       DE15                     FNEXT:
0010F7 DE15 E5              11      PUSH    HL
0010F8 DE16 219FF0          10      LD  HL,_FILEN
0010FB DE19 34              11      INC (HL)
0010FC DE1A E1              10      POP HL
0010FD DE1B 112000          10      LD  DE,020H
001100 DE1E 19              11      ADD HL,DE
001101 DE1F 0D               4      DEC C
001102 DE20 C9              10      RET
                                
       DE21                     CPNAME:
001103 DE21 C5              11      PUSH    BC
001104 DE22 D5              11      PUSH    DE
001105 DE23 E5              11      PUSH    HL
001106 DE24 CD3BDE          17      CALL    CPFILE4
001109 DE27 E1              10      POP HL
00110A DE28 23               6      INC HL
00110B DE29 23               6      INC HL
00110C DE2A 23               6      INC HL
00110D DE2B 23               6      INC HL
00110E DE2C D1              10      POP DE
00110F DE2D C1              10      POP BC
001110 DE2E 2005            12      JR  NZ,CPNAME1
001112 DE30 7E               7      LD  A,(HL)
001113 DE31 23               6      INC HL
001114 DE32 66               7      LD  H,(HL)
001115 DE33 6F               4      LD  L,A
001116 DE34 C9              10      RET
       DE35                     CPNAME1:
001117 DE35 23               6      INC HL
001118 DE36 23               6      INC HL
001119 DE37 10E8            13      DJNZ    CPNAME
00111B DE39 37               4      SCF
00111C DE3A C9              10      RET
                                
       DE3B                     CPFILE4:
00111D DE3B C5              11      PUSH    BC
00111E DE3C 010004          10      LD  BC,00400H
001121 DE3F 1804            12      JR  CPSTR1
       DE41                     CPFILE:
001123 DE41 C5              11      PUSH    BC
001124 DE42 01000B          10      LD  BC,00B00H
       DE45                     CPSTR1:
001127 DE45 1A               7      LD  A,(DE)
001128 DE46 FE3F             7      CP  '?'     ;Wild card
00112A DE48 2812            12      JR  Z,CPSTR2
00112C DE4A 7E               7      LD  A,(HL)
00112D DE4B CDB1DF          17      CALL    FKANC
001130 DE4E E5              11      PUSH    HL
001131 DE4F 67               4      LD  H,A
001132 DE50 1A               7      LD  A,(DE)
001133 DE51 CB01             8      RLC C
001135 DE53 CDB1DF          17      CALL    FKANC
001138 DE56 CB09             8      RRC C
00113A DE58 BC               4      CP  H       ;CP (HL),(DE)
00113B DE59 E1              10      POP HL
00113C DE5A 2004            12      JR  NZ,CPSTR3
       DE5C                     CPSTR2:
00113E DE5C 13               6      INC DE
00113F DE5D 23               6      INC HL
001140 DE5E 10E5            13      DJNZ    CPSTR1
       DE60                     CPSTR3:
001142 DE60 C1              10      POP BC
001143 DE61 C9              10      RET
                                
       DE62                     CPFILE2:
001144 DE62 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001147 DE65 F6E1             7      OR  0E1H
001149 DE67 2F               4      CPL
00114A DE68 A6               7      AND (HL)
00114B DE69 C9              10      RET
                                
       DE6A                     DCPAT:
00114C DE6A 0E00             7      LD  C,0
00114E DE6C 2A7EF1          16      LD  HL,(_DTBUF)
001151 DE6F 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
001154 DE72 B7               4      OR  A
001155 DE73 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
001156 DE74 3A88DE          13      LD  A,(SPCPAT)
001159 DE77 4F               4      LD  C,A
00115A DE78 3AECE5          13      LD  A,(_SECPS)
00115D DE7B B9               4      CP  C
00115E DE7C 3801            12      JR  C,DC1
001160 DE7E AF               4      XOR A
       DE7F                     DC1:
001161 DE7F F680             7      OR  080H
001163 DE81 32A0F0          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       DE84                     CLUSTX:
001166 DE84 E5              11      PUSH    HL
001167 DE85 EB               4      EX  DE,HL
001168 DE86 AF               4      XOR A
001169 DE87 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       DE88                     SPCPAT  EQU $-1
       DE89                     L_CLDBL:
00116B DE89 CB19             8      RR  C       ;->CF
00116D DE8B 3804            12      JR  C,E_CLDBL
00116F DE8D 29              11      ADD HL,HL       ;*2
001170 DE8E 8F               4      ADC A,A
001171 DE8F 18F8            12      JR  L_CLDBL
       DE91                     E_CLDBL:
001173 DE91 4F               4      LD  C,A
001174 DE92 3AECE5          13      LD  A,(_SECPS)
001177 DE95 B5               4      OR  L
001178 DE96 6F               4      LD  L,A
001179 DE97 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       DE98                     CLSPAT  EQU $-2
00117C DE9A AF               4      XOR A
00117D DE9B 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
00117E DE9C 89               4      ADC A,C
00117F DE9D 4F               4      LD  C,A
001180 DE9E EB               4      EX  DE,HL
001181 DE9F E1              10      POP HL
001182 DEA0 C9              10      RET
                                ;(8)
       DEA1                     ENDCL:
001183 DEA1 7A               4      LD  A,D ;END CLUSTER
001184 DEA2 FE01             7      CP  1   ;164=356    (self-modifying code)
       DEA3                     CLPAT1  EQU $-1
001186 DEA4 C0              11      RET NZ
001187 DEA5 7B               4      LD  A,E
001188 DEA6 FE64             7      CP  064H    ;       (self-modifying code)
       DEA7                     CLPAT2  EQU $-1
00118A DEA8 C9              10      RET
                                ;(3)
       DEA9                     CAP4:
00118B DEA9 3EE5             7      LD  A,0E5H
00118D DEAB C9              10      RET
                                                    ;for X1/88 ワークエリア
00118E DEAC 5BF0                    DW  _DISKE+1        ;DISKVE($F323)
001190 DEAE F5F0                    DW  _BREAK+1        ;BREAKV($F325)
                                
       DEB0                     CAP:            ;(9)
001192 DEB0 FE61             7      CP  'a'
001194 DEB2 D8              11      RET C
001195 DEB3 FE7B             7      CP  'z'+1
001197 DEB5 D0              11      RET NC
001198 DEB6 D620             7      SUB 020H
00119A DEB8 C9              10      RET
                                ;(10)
       DEB9                     CAP2:
00119B DEB9 CDB0DE          17      CALL    CAP
       DEBC                     CAP3:               ;
00119E DEBC FE05             7      CP  5
0011A0 DEBE 28E9            12      JR  Z,CAP4
0011A2 DEC0 FE21             7      CP  021H
0011A4 DEC2 C9              10      RET
                                                    ;
       DEC3                     CHDIR:
0011A5 DEC3 CD9CE8          17      CALL    GETDPBD
0011A8 DEC6 381D            12      JR  C,CHDIR2
0011AA DEC8 DD751A          19      LD  (IX+DPB_SDIR),L
0011AD DECB DD741B          19      LD  (IX+DPB_SDIR+1),H
0011B0 DECE 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       DED0                     LDDIR:
0011B2 DED0 CD9CE8          17      CALL    GETDPBD
0011B5 DED3 DD5E1A          19      LD  E,(IX+DPB_SDIR)
0011B8 DED6 DD561B          19      LD  D,(IX+DPB_SDIR+1)
0011BB DED9 13               6      INC DE
0011BC DEDA FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011BF DEDD FD720F          19      LD  (IY+15),D
0011C2 DEE0 1B               6      DEC DE
0011C3 DEE1 AF               4      XOR A
0011C4 DEE2 32A0F0          13      LD  (_DIRF),A
       DEE5                     CHDIR2:
0011C7 DEE5 DDE1            14      POP IX
0011C9 DEE7 C9              10      RET
                                
       DEE8                     LDDIRX:
0011CA DEE8 3AA0F0          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
0011CD DEEB E67F             7      AND 07FH
       DEED                     LDDIRX1:
0011CF DEED 32ECE5          13      LD  (_SECPS),A
0011D2 DEF0 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011D5 DEF3 FD560F          19      LD  D,(IY+15)
0011D8 DEF6 1B               6      DEC DE
0011D9 DEF7 CDA1DE          17      CALL    ENDCL
0011DC DEFA D4D0DE          17      CALL    NC,LDDIR
       DEFD                     LDDIRS:
0011DF DEFD 7A               4      LD  A,D
0011E0 DEFE B3               4      OR  E
0011E1 DEFF 32A0F0          13      LD  (_DIRF),A   ;ディレクトリか判別
0011E4 DF02 C9              10      RET
                                
       DF03                     KILL:
0011E5 DF03 CDCBDF          17      CALL    CHKWILDX
0011E8 DF06 3834            12      JR  C,KILLW
0011EA DF08 CDA6DC          17      CALL    SOPENX
       DF0B                     KILLS:
0011ED DF0B 3E1F             7      LD  A,01FH
0011EF DF0D D44FDF          17      CALL    NC,CHKATT
0011F2 DF10 D8              11      RET C
       DF11                     KILLSX:
0011F3 DF11 36E5            10      LD  (HL),0E5H   ;DIR
0011F5 DF13 CDA7DF          17      CALL    WTDB
0011F8 DF16 111A00          10      LD  DE,01AH
0011FB DF19 19              11      ADD HL,DE
0011FC DF1A 5E               7      LD  E,(HL)
0011FD DF1B 23               6      INC HL
0011FE DF1C 56               7      LD  D,(HL)
       DF1D                     KILLS1:
0011FF DF1D CDA1DE          17      CALL    ENDCL
001202 DF20 D0              11      RET NC      ;CF=0
001203 DF21 21FEFF          10      LD  HL,0-2
001206 DF24 19              11      ADD HL,DE
001207 DF25 D0              11      RET NC      ;DE= 0 or 1
001208 DF26 D5              11      PUSH    DE
001209 DF27 CDF7F0          17      CALL    _GNCL
00120C DF2A ED53FEF1        20      LD  (_CLPS),DE
001210 DF2E D1              10      POP DE
001211 DF2F 210000          10      LD  HL,0
001214 DF32 D4FAF0          17      CALL    NC,_SNCL
001217 DF35 D8              11      RET C
001218 DF36 ED5BFEF1        20      LD  DE,(_CLPS)  ;FAT
00121C DF3A 18E1            12      JR  KILLS1
                                
       DF3C                     KILLW:
00121E DF3C CDD5DC          17      CALL    SOPEN
       DF3F                     KILLW1:
001221 DF3F 380B            12      JR  C,KILLW2
001223 DF41 CD74DD          17      CALL    SOPENE2
001226 DF44 CD0BDF          17      CALL    KILLS
001229 DF47 CD39DD          17      CALL    NOPEN
00122C DF4A 18F3            12      JR  KILLW1
       DF4C                     KILLW2:
00122E DF4C C8              11      RET Z
00122F DF4D 3F               4      CCF
001230 DF4E C9              10      RET
                                
       DF4F                     CHKATT:
001231 DF4F E5              11      PUSH    HL
001232 DF50 110B00          10      LD  DE,00BH
001235 DF53 19              11      ADD HL,DE
001236 DF54 A6               7      AND (HL)
001237 DF55 E1              10      POP HL
001238 DF56 C8              11      RET Z
001239 DF57 37               4      SCF
00123A DF58 C9              10      RET
                                
       DF59                     NAME:
00123B DF59 CDCBDF          17      CALL    CHKWILDX
00123E DF5C D8              11      RET C
00123F DF5D 110400          10      LD  DE,4
001242 DF60 19              11      ADD HL,DE
001243 DF61 2276DF          16      LD  (NAMEP),HL
001246 DF64 23               6      INC HL
001247 DF65 CDCFDF          17      CALL    CHKWILD
00124A DF68 D8              11      RET C
                                
00124B DF69 CDA6DC          17      CALL    SOPENX
00124E DF6C 3E0F             7      LD  A,00FH
001250 DF6E D44FDF          17      CALL    NC,CHKATT
001253 DF71 D8              11      RET C
                                
001254 DF72 FDE5            15      PUSH    IY
001256 DF74 FD210000        14      LD  IY,0        ;自己書き換え
       DF76                     NAMEP   EQU $-2
00125A DF78 CDA6DC          17      CALL    SOPENX
00125D DF7B FDE3            23      EX  (SP),IY
00125F DF7D 3F               4      CCF
001260 DF7E D4D5DC          17      CALL    NC,SOPEN
001263 DF81 EB               4      EX  DE,HL
001264 DF82 E1              10      POP HL
001265 DF83 D8              11      RET C
                                
       DF84                     SETNAME:
001266 DF84 01000B          10      LD  BC,11*256
001269 DF87 23               6      INC HL
00126A DF88 7E               7      LD  A,(HL)
00126B DF89 FEE5             7      CP  0E5H
00126D DF8B 2004            12      JR  NZ,SNAME1
00126F DF8D 3E05             7      LD  A,5
001271 DF8F 180E            12      JR  SNAME3
       DF91                     SNAME1:
001273 DF91 7E               7      LD  A,(HL)
001274 DF92 0C               4      INC C
001275 DF93 0D               4      DEC C
001276 DF94 2009            12      JR  NZ,SNAME3
001278 DF96 CDB0DE          17      CALL    CAP
00127B DF99 FEA0             7      CP  0A0H
00127D DF9B 2002            12      JR  NZ,SNAME3
00127F DF9D 3E20             7      LD  A,020H
       DF9F                     SNAME3:
001281 DF9F 12               7      LD  (DE),A
001282 DFA0 7E               7      LD  A,(HL)
001283 DFA1 23               6      INC HL
001284 DFA2 CDB8DF          17      CALL    FKAN
001287 DFA5 10EA            13      DJNZ    SNAME1
       DFA7                     WTDB:               ;バッファデータが更新された
001289 DFA7 3EFF             7      LD  A,0FFH
00128B DFA9 3239F0          13      LD  (SFILE),A
00128E DFAC 32A4F0          13      LD  (_WTDBF),A
001291 DFAF AF               4      XOR A
001292 DFB0 C9              10      RET
                                
       DFB1                     FKANC:
001293 DFB1 CB41             8      BIT 0,C
001295 DFB3 CCB9DE          17      CALL    Z,CAP2
001298 DFB6 1801            12      JR  FKANX
       DFB8                     FKAN:           ;漢字チェック
00129A DFB8 13               6      INC DE
       DFB9                     FKANX:
00129B DFB9 CB41             8      BIT 0,C
00129D DFBB CB81             8      RES 0,C
00129F DFBD C0              11      RET NZ
0012A0 DFBE FE80             7      CP  080H
0012A2 DFC0 D8              11      RET C
0012A3 DFC1 FEA0             7      CP  0A0H
0012A5 DFC3 3803            12      JR  C,FKAN1
0012A7 DFC5 FEE0             7      CP  0E0H
0012A9 DFC7 D8              11      RET C
       DFC8                     FKAN1:
0012AA DFC8 0C               4      INC C
0012AB DFC9 A7               4      AND A
0012AC DFCA C9              10      RET
                                
       DFCB                     CHKWILDX:
0012AD DFCB FDE5            15      PUSH    IY
0012AF DFCD E1              10      POP HL
0012B0 DFCE 23               6      INC HL
       DFCF                     CHKWILD:
0012B1 DFCF 060B             7      LD  B,11
0012B3 DFD1 3E3F             7      LD  A,'?'
       DFD3                     CHKWIL1:
0012B5 DFD3 BE               7      CP  (HL)
0012B6 DFD4 23               6      INC HL
0012B7 DFD5 37               4      SCF
0012B8 DFD6 C8              11      RET Z
0012B9 DFD7 10FA            13      DJNZ    CHKWIL1
0012BB DFD9 AF               4      XOR A
0012BC DFDA C9              10      RET
                                
       DFDB                     SDIRENT:        ;IY=FCB HL=DIR
0012BD DFDB D5              11      PUSH    DE
0012BE DFDC E5              11      PUSH    HL
0012BF DFDD FDE5            15      PUSH    IY
0012C1 DFDF D1              10      POP DE
0012C2 DFE0 EB               4      EX  DE,HL
0012C3 DFE1 CD84DF          17      CALL    SETNAME
                                ;               Attribute
0012C6 DFE4 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0012C9 DFE7 12               7      LD  (DE),A
0012CA DFE8 13               6      INC DE
                                ;               Reserved
0012CB DFE9 AF               4      XOR A
0012CC DFEA 060A             7      LD  B,10
       DFEC                     SDE1:
0012CE DFEC 12               7      LD  (DE),A
0012CF DFED 13               6      INC DE
0012D0 DFEE 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
0012D2 DFF0 21E4F1          10      LD  HL,SDDATA       ;(FCB)更新年月日
0012D5 DFF3 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DFF5                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
0012D7 DFF5 7E               7      LD  A,(HL)
0012D8 DFF6 23               6      INC HL
0012D9 DFF7 32FCDF          13      LD  (SDPAT),A
0012DC DFFA FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       DFFC                     SDPAT   EQU $-1
0012DF DFFD 12               7      LD  (DE),A
0012E0 DFFE 13               6      INC DE
0012E1 DFFF 10F4            13      DJNZ    SDLOOP
                                
0012E3 E001 AF               4      XOR A
0012E4 E002 E1              10      POP HL
0012E5 E003 D1              10      POP DE
0012E6 E004 C9              10      RET
                                
       E005                     WOPEN:
0012E7 E005 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0012EA E008 E61F             7      AND 01FH
0012EC E00A 37               4      SCF
0012ED E00B C0              11      RET NZ
0012EE E00C FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E010                     TOPEN2:
0012F2 E010 AF               4      XOR A
       E011                     TOPEN:              ;Initializes the time stamp
0012F3 E011 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
0012F7 E015 C9              10      RET
                                
       E016                     WRDFX:
0012F8 E016 3A88DE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       E019                     L_WRFX:
0012FB E019 1F               4      RRA         ;->CF
0012FC E01A 3806            12      JR  C,E_WRFX
0012FE E01C CB39             8      SRL C
001300 E01E CB1C             8      RR  H       ;CH=CH/2
001302 E020 18F7            12      JR  L_WRFX
       E022                     E_WRFX:
001304 E022 41               4      LD  B,C
001305 E023 4C               4      LD  C,H
001306 E024 03               6      INC BC
001307 E025 3E37             7      LD  A,037H      ;SCF
001309 E027 3272E4          13      LD  (DRDN1),A
                                
       E02A                     WRDF:               ;BCクラスタ分FATを確保する
00130C E02A 110200          10      LD  DE,2
00130F E02D AF               4      XOR A
001310 E02E 32ECE5          13      LD  (_SECPS),A
       E031                     WRDF1:
001313 E031 C5              11      PUSH    BC
001314 E032 D5              11      PUSH    DE
001315 E033 CDF7F0          17      CALL    _GNCL
001318 E036 381C            12      JR  C,WRDF3
00131A E038 7A               4      LD  A,D     ;空いているかチェック
00131B E039 B3               4      OR  E
00131C E03A 202A            12      JR  NZ,WRDF4
00131E E03C E1              10      POP HL      ;HL=空いているクラスタ
00131F E03D E5              11      PUSH    HL
001320 E03E ED5BFEF1        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
001324 E042 22FEF1          16      LD  (_CLPS),HL
001327 E045 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
001328 E046 B3               4      OR  E
001329 E047 2008            12      JR  NZ,WRDF2
00132B E049 FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
00132E E04C FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
001331 E04F 1803            12      JR  WRDF3
       E051                     WRDF2:
001333 E051 CDFAF0          17      CALL    _SNCL
       E054                     WRDF3:
001336 E054 D1              10      POP DE
001337 E055 C1              10      POP BC
001338 E056 D8              11      RET C
001339 E057 0B               6      DEC BC
00133A E058 78               4      LD  A,B
00133B E059 B1               4      OR  C
00133C E05A 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
00133E E05C ED5BFEF1        20      LD  DE,(_CLPS)
001342 E060 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
001345 E063 C3FAF0          10      JP  _SNCL
                                
       E066                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
001348 E066 D1              10      POP DE
001349 E067 C1              10      POP BC
       E068                     WRDF5:
00134A E068 13               6      INC DE
00134B E069 CDA1DE          17      CALL    ENDCL
00134E E06C 38C3            12      JR  C,WRDF1
001350 E06E 37               4      SCF
001351 E06F C9              10      RET
                                
       E070                     RWXR:
001352 E070 3A61E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E073                     L_RWX:
001355 E073 1F               4      RRA     ;->CF
001356 E074 3808            12      JR  C,E_RWX
001358 E076 CB38             8      SRL B   ;BCH=BCH/2
00135A E078 CB19             8      RR  C   ;
00135C E07A CB1C             8      RR  H   ;
00135E E07C 18F5            12      JR  L_RWX
       E07E                     E_RWX:
001360 E07E FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001363 E081 FD561B          19      LD  D,(IY+27)
001366 E084 AF               4      XOR A
001367 E085 32ECE5          13      LD  (_SECPS),A
       E088                     RWX1:
00136A E088 ED53FEF1        20      LD  (_CLPS),DE
00136E E08C 7A               4      LD  A,D
00136F E08D B3               4      OR  E
001370 E08E 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
001372 E090 78               4      LD  A,B
001373 E091 B1               4      OR  C
001374 E092 B4               4      OR  H
001375 E093 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
001376 E094 CDF4E5          17      CALL    GNCLX
001379 E097 D8              11      RET C
00137A E098 7C               4      LD  A,H     ;
00137B E099 25               4      DEC H       ;
00137C E09A B7               4      OR  A       ;DEC BCH
00137D E09B 2001            12      JR  NZ,RWX2     ;
00137F E09D 0B               6      DEC BC      ;
       E09E                     RWX2:
001380 E09E CDA1DE          17      CALL    ENDCL
001383 E0A1 38E5            12      JR  C,RWX1
       E0A3                     SCF_RET:
001385 E0A3 37               4      SCF
001386 E0A4 C9              10      RET
                                
       E0A5                     DSKF:
001387 E0A5 110000          10      LD  DE,0
       E0A6                     MAXCLP  EQU $-2
00138A E0A8 2AACF0          16      LD  HL,(_FAKEFREE)
00138D E0AB 7C               4      LD  A,H
00138E E0AC B5               4      OR  L
00138F E0AD 2803            12      JR  Z,DSKF1
001391 E0AF 110100          10      LD  DE,1
       E0B2                     DSKF1:
001394 E0B2 D5              11      PUSH    DE
001395 E0B3 CDF7F0          17      CALL    _GNCL
001398 E0B6 380C            12      JR  C,POPSCF
00139A E0B8 7A               4      LD  A,D
00139B E0B9 B3               4      OR  E
00139C E0BA 2001            12      JR  NZ,DSKF2
00139E E0BC 23               6      INC HL
       E0BD                     DSKF2:
00139F E0BD D1              10      POP DE
0013A0 E0BE 1B               6      DEC DE
0013A1 E0BF 7A               4      LD  A,D
0013A2 E0C0 B3               4      OR  E
0013A3 E0C1 20EF            12      JR  NZ,DSKF1
0013A5 E0C3 C9              10      RET
                                
       E0C4                     POPSCF:
0013A6 E0C4 F1              10      POP AF
0013A7 E0C5 37               4      SCF
0013A8 E0C6 C9              10      RET
                                
       E0C7                     SETTMS:
0013A9 E0C7 FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
0013AC E0CA 3C               4      INC A
0013AD E0CB C0              11      RET NZ      ;ファイルが更新されていない
       E0CC                     SETTMSX:            ;FCBに日付時刻をセットする
0013AE E0CC CDB9D7          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
0013B1 E0CF CB25             8      SLA L       ;   *2
0013B3 E0D1 CB25             8      SLA L       ;   *4
0013B5 E0D3 29              11      ADD HL,HL       ;*2 *8
0013B6 E0D4 29              11      ADD HL,HL       ;*4 *16
0013B7 E0D5 29              11      ADD HL,HL       ;*8 *32
0013B8 E0D6 7A               4      LD  A,D
0013B9 E0D7 0F               4      RRCA            ;bit.0->7->->->0->C
0013BA E0D8 E61F             7      AND 01FH
0013BC E0DA B5               4      OR  L
0013BD E0DB FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
0013C0 E0DE FD7417          19      LD  (IY+23),H
                                
0013C3 E0E1 CDB9D7          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
0013C6 E0E4 0144F8          10      LD  BC,0-1980
0013C9 E0E7 09              11      ADD HL,BC
0013CA E0E8 65               4      LD  H,L
                                
0013CB E0E9 7A               4      LD  A,D
0013CC E0EA 87               4      ADD A,A     ;*2
0013CD E0EB 87               4      ADD A,A     ;*4
0013CE E0EC 87               4      ADD A,A     ;*8
0013CF E0ED 87               4      ADD A,A     ;*16
0013D0 E0EE 6F               4      LD  L,A
0013D1 E0EF 29              11      ADD HL,HL       ;*32
0013D2 E0F0 7D               4      LD  A,L
0013D3 E0F1 B3               4      OR  E
0013D4 E0F2 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
0013D7 E0F5 FD7415          19      LD  (IY+21),H
0013DA E0F8 C9              10      RET
                                ;(16)
       E0F9                     PUSHRR:
0013DB E0F9 3225E4          13      LD  (SETSEQ_SWC_RND),A
0013DE E0FC 2237E4          16      LD  (SETSEQ_SWC_SEQ_RR),HL
0013E1 E0FF CD1FE1          17      CALL    GET_RR_AHL
0013E4 E102 220FF0          16      LD  (RR_BUF_HL),HL
0013E7 E105 3211F0          13      LD  (RR_BUF_A),A
0013EA E108 C9              10      RET
                                ;(14)
       E109                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
0013EB E109 87               4      ADD A,A     ;in BHLA => out AHL
0013EC E10A ED6A            15      ADC HL,HL
0013EE E10C CB18             8      RR  B
0013F0 E10E B7               4      OR  A
0013F1 E10F 78               4      LD  A,B     ;ここでフラグは変化しない
0013F2 E110 C8              11      RET Z
0013F3 E111 2C               4      INC L       ;INC AHL
0013F4 E112 C0              11      RET NZ      ;
0013F5 E113 24               4      INC H       ;
0013F6 E114 C0              11      RET NZ      ;
0013F7 E115 3C               4      INC A       ;
0013F8 E116 C9              10      RET
                                ;(18)
       E117                     INIT_RND:
0013F9 E117 3ECD             7      LD  A,0CDH      ;CALL ????
0013FB E119 2136E1          10      LD  HL,POPRR
0013FE E11C CDF9E0          17      CALL    PUSHRR
       E11F                     GET_RR_AHL:
001401 E11F FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
001404 E122 FD6622          19      LD  H,(IY+34)   ;
001407 E125 FD7E23          19      LD  A,(IY+35)   ;
00140A E128 C9              10      RET
                                ;(10)
       E129                     SET_RR_AHL:
00140B E129 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
00140E E12C FD7422          19      LD  (IY+34),H   ;
001411 E12F FD7723          19      LD  (IY+35),A   ;
001414 E132 C9              10      RET
                                ;(17)
       E133                     SETSEQ:
001415 E133 CD58E1          17      CALL    SETSEQ1
       E136                     POPRR:
001418 E136 F5              11      PUSH    AF
001419 E137 E5              11      PUSH    HL
00141A E138 2A0FF0          16      LD  HL,(RR_BUF_HL)
00141D E13B 3A11F0          13      LD  A,(RR_BUF_A)
001420 E13E CD29E1          17      CALL    SET_RR_AHL
001423 E141 E1              10      POP HL
001424 E142 F1              10      POP AF
001425 E143 C9              10      RET
                                ;(20)
       E144                     GET_RR_BCDE:            ;BCDE=Random record
001426 E144 FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
001429 E147 FD5622          19      LD  D,(IY+34)
00142C E14A FD4E23          19      LD  C,(IY+35)
00142F E14D 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
001431 E14F FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001435 E153 C0              11      RET NZ
001436 E154 FD4624          19      LD  B,(IY+36)
001439 E157 C9              10      RET
                                
       E158                     SETSEQ1:
00143A E158 F5              11      PUSH    AF
00143B E159 E5              11      PUSH    HL      ;AHL=Random record
00143C E15A CD1FE1          17      CALL    GET_RR_AHL
00143F E15D 47               4      LD  B,A     ;AHL→HLA
001440 E15E 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
001441 E15F 6C               4      LD  L,H     ;(IY+34)
001442 E160 60               4      LD  H,B     ;(IY+35)
001443 E161 0600             7      LD  B,0
                                
001445 E163 CD09E1          17      CALL    GET_CPM_R_SIZE
                                
001448 E166 29              11      ADD HL,HL
001449 E167 CB3D             8      SRL L       ;L=L/2
00144B E169 FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
00144E E16C FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
001451 E16F E1              10      POP HL
001452 E170 F1              10      POP AF
001453 E171 C9              10      RET
                                
                                ;(23)
       E172                     RBXEND:             ;レコード数だけランダムレコードを進める
001454 E172 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       E173                     RBSIZE  EQU $-2
001457 E175 CD1FE1          17      CALL    GET_RR_AHL
00145A E178 19              11      ADD HL,DE
00145B E179 CE00             7      ADC A,0
00145D E17B CD29E1          17      CALL    SET_RR_AHL
001460 E17E EB               4      EX  DE,HL       ;HL=進めるレコード数
001461 E17F D0              11      RET NC
001462 E180 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001466 E184 C0              11      RET NZ
001467 E185 FD3424          23      INC (IY+36)
00146A E188 C9              10      RET
       E189                     FILE_E:
                                
       DD33                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       DD33                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       DD33                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       DD33                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       DD33                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E189                     _SYS26:     ;(BDOS)ランダムブロック書き込み
00146B E189 AF               4      XOR A
00146C E18A 3272E4          13      LD  (DRDN1),A   ;NOP
00146F E18D 2273E1          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
001472 E190 225DF0          16      LD  (LEFTX),HL
001475 E193 CD7CDC          17      CALL    SETDRV
                                
001478 E196 CDFCE2          17      CALL    RBX0
00147B E199 DA26E2          10      JP  C,RBWERR
00147E E19C CD05E0          17      CALL    WOPEN
001481 E19F DA26E2          10      JP  C,RBWERR
001484 E1A2 7C               4      LD  A,H
001485 E1A3 B5               4      OR  L
001486 E1A4 CA1FE2          10      JP  Z,RBW1
                                
001489 E1A7 2B               6      DEC HL
                                
00148A E1A8 CD44E1          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
00148D E1AB 19              11      ADD HL,DE       ;BCHL=HL+BCDE
00148E E1AC 3001            12      JR  NC,S26X1    ;
001490 E1AE 03               6      INC BC      ;
       E1AF                     S26X1:
001491 E1AF CD70E0          17      CALL    RWXR
001494 E1B2 DC16E0          17      CALL    C,WRDFX
001497 E1B5 DA26E2          10      JP  C,RBWERR
                                
00149A E1B8 CD2BE3          17      CALL    RBX2
00149D E1BB 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
00149F E1BD CD4AE3          17      CALL    RBXA
0014A2 E1C0 3864            12      JR  C,RBWERR
0014A4 E1C2 EB               4      EX  DE,HL
0014A5 E1C3 C5              11      PUSH    BC
0014A6 E1C4 EDB0                    LDIR
0014A8 E1C6 225FF0          16      LD  (DTAX),HL
                                
0014AB E1C9 CDA7DF          17      CALL    WTDB        ;バッファデータは更新された
                                
0014AE E1CC 2A5DF0          16      LD  HL,(LEFTX)
0014B1 E1CF D1              10      POP DE
0014B2 E1D0 ED52            15      SBC HL,DE
0014B4 E1D2 225DF0          16      LD  (LEFTX),HL
0014B7 E1D5 2831            12      JR  Z,RBWEND
                                
       E1D7                     RBWB:
0014B9 E1D7 CD7FE3          17      CALL    RBXB
0014BC E1DA 2814            12      JR  Z,RBWC
       E1DC                     RBWB1:
0014BE E1DC C5              11      PUSH    BC
0014BF E1DD D5              11      PUSH    DE
0014C0 E1DE CD84DE          17      CALL    CLUSTX
0014C3 E1E1 CDA3E3          17      CALL    DWTC
0014C6 E1E4 D1              10      POP DE
0014C7 E1E5 C1              10      POP BC
0014C8 E1E6 D4F4E5          17      CALL    NC,GNCLX
0014CB E1E9 383B            12      JR  C,RBWERR
0014CD E1EB 10EF            13      DJNZ    RBWB1
0014CF E1ED CDF3E3          17      CALL    DRW_FLUSH
       E1F0                     RBWC:
0014D2 E1F0 CD97E3          17      CALL    RBXC
0014D5 E1F3 2813            12      JR  Z,RBWEND
0014D7 E1F5 C5              11      PUSH    BC
0014D8 E1F6 CD84DE          17      CALL    CLUSTX
0014DB E1F9 CD71E4          17      CALL    DRDN
0014DE E1FC C1              10      POP BC
0014DF E1FD 3827            12      JR  C,RBWERR
0014E1 E1FF ED5B7EF1        20      LD  DE,(_DTBUF)
0014E5 E203 EDB0                    LDIR
0014E7 E205 CDA7DF          17      CALL    WTDB        ;バッファデータは更新された
       E208                     RBWEND:
0014EA E208 CD72E1          17      CALL    RBXEND
                                
0014ED E20B CD0BE3          17      CALL    RBX1
0014F0 E20E 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
0014F2 E210 CD44E1          17      CALL    GET_RR_BCDE ;BCDE=Random record
0014F5 E213 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
0014F8 E216 FD7211          19      LD  (IY+17),D   ;
0014FB E219 FD7112          19      LD  (IY+18),C   ;
0014FE E21C FD7013          19      LD  (IY+19),B   ;
       E21F                     RBW1:
001501 E21F FDE1            14      POP IY
001503 E221 C1              10      POP BC
001504 E222 D1              10      POP DE
001505 E223 E1              10      POP HL
       E224                     DD_NUL:
001506 E224 AF               4      XOR A
       E225                     DRDF0:
       E225                     DWTF0:
001507 E225 C9              10      RET
                                
       E226                     RBWERR:
001508 E226 FDE5            15      PUSH    IY
00150A E228 D1              10      POP DE
00150B E229 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
00150D E22B CD4BD4          17      CALL    BDOS0
       E22E                     RBRERR1:
001510 E22E 3E01             7      LD  A,001H
       E230                     RBRERR2:
001512 E230 FDE1            14      POP IY
001514 E232 C1              10      POP BC
001515 E233 D1              10      POP DE
001516 E234 E1              10      POP HL
001517 E235 37               4      SCF
001518 E236 210000          10      LD  HL,0
00151B E239 C9              10      RET
                                
       E23A                     RBRERR:
00151C E23A 3EFF             7      LD  A,0FFH
00151E E23C 18F2            12      JR  RBRERR2
                                
       E23E                     RBRFL:
001520 E23E 3E00             7  RBRFLP: LD  A,000H
001522 E240 FE0D             7      CP  00DH
001524 E242 2005            12      JR  NZ,RBRFL1
001526 E244 D5              11      PUSH    DE
001527 E245 1E0A             7      LD  E,00AH
001529 E247 1805            12      JR  RBRFL2
       E249                     RBRFL1:
00152B E249 D5              11      PUSH    DE
00152C E24A CD09F0          17      CALL    _SYS07
00152F E24D 5F               4      LD  E,A
       E24E                     RBRFL2:
001530 E24E CDCDF0          17      CALL    _PRINT
001533 E251 7B               4      LD  A,E
001534 E252 D1              10      POP DE
001535 E253 323FE2          13      LD  (RBRFLP+1),A
001538 E256 C9              10      RET
                                
                                                ;Read random block
       E257                     _SYS27:     ;(BDOS)ランダムブロック読み込み
001539 E257 225DF0          16      LD  (LEFTX),HL
00153C E25A CD7CDC          17      CALL    SETDRV
                                
00153F E25D FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
001543 E261 C2EAE2          10      JP  NZ,RBRDIR   ;ディレクトリ
001546 E264 CDFCE2          17      CALL    RBX0
001549 E267 DA3AE2          10      JP  C,RBRERR
00154C E26A CD0BE3          17      CALL    RBX1
00154F E26D D423E3          17      CALL    NC,RBX1R
001552 E270 DA2EE2          10      JP  C,RBRERR1
001555 E273 EB               4      EX  DE,HL
001556 E274 ED52            15      SBC HL,DE       ;CP 00HL,BCDE
001558 E276 19              11      ADD HL,DE
001559 E277 79               4      LD  A,C
00155A E278 DE00             7      SBC A,0
00155C E27A 78               4      LD  A,B
00155D E27B DE00             7      SBC A,0
00155F E27D 3801            12      JR  C,RBR1
001561 E27F EB               4      EX  DE,HL
       E280                     RBR1:
001562 E280 9F               4      SBC A,A
001563 E281 E601             7      AND 1
001565 E283 32E8E2          13      LD  (RBRA_SWC),A
                                
001568 E286 7C               4      LD  A,H
001569 E287 B5               4      OR  L
00156A E288 2857            12      JR  Z,RBREND0
                                
00156C E28A 2273E1          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
00156F E28D 225DF0          16      LD  (LEFTX),HL
                                
001572 E290 CD2BE3          17      CALL    RBX2
001575 E293 2819            12      JR  Z,RBRB
001577 E295 CD4AE3          17      CALL    RBXA
00157A E298 DA3AE2          10      JP  C,RBRERR
00157D E29B C5              11      PUSH    BC
00157E E29C EDB0                    LDIR
001580 E29E ED535FF0        20      LD  (DTAX),DE
001584 E2A2 2A5DF0          16      LD  HL,(LEFTX)
001587 E2A5 D1              10      POP DE
001588 E2A6 A7               4      AND A
001589 E2A7 ED52            15      SBC HL,DE
00158B E2A9 225DF0          16      LD  (LEFTX),HL
00158E E2AC 2830            12      JR  Z,RBREND
                                
       E2AE                     RBRB:
001590 E2AE CD7FE3          17      CALL    RBXB
001593 E2B1 2815            12      JR  Z,RBRC
       E2B3                     RBRB1:
001595 E2B3 C5              11      PUSH    BC
001596 E2B4 D5              11      PUSH    DE
001597 E2B5 CD84DE          17      CALL    CLUSTX
00159A E2B8 CDA9E3          17      CALL    DRDC
00159D E2BB D1              10      POP DE
00159E E2BC C1              10      POP BC
00159F E2BD D4F4E5          17      CALL    NC,GNCLX
0015A2 E2C0 DA3AE2          10      JP  C,RBRERR
0015A5 E2C3 10EE            13      DJNZ    RBRB1
0015A7 E2C5 CDF3E3          17      CALL    DRW_FLUSH
       E2C8                     RBRC:
0015AA E2C8 CD97E3          17      CALL    RBXC
0015AD E2CB 2811            12      JR  Z,RBREND
0015AF E2CD C5              11      PUSH    BC
0015B0 E2CE CD84DE          17      CALL    CLUSTX
0015B3 E2D1 CD55E4          17      CALL    DRDX
0015B6 E2D4 C1              10      POP BC
0015B7 E2D5 DA3AE2          10      JP  C,RBRERR
0015BA E2D8 EB               4      EX  DE,HL
0015BB E2D9 2A7EF1          16      LD  HL,(_DTBUF)
0015BE E2DC EDB0                    LDIR
       E2DE                     RBREND:
0015C0 E2DE CD72E1          17      CALL    RBXEND
       E2E1                     RBREND0:
0015C3 E2E1 FDE1            14      POP IY
0015C5 E2E3 C1              10      POP BC
0015C6 E2E4 D1              10      POP DE
0015C7 E2E5 F1              10      POP AF  ;(HL)
0015C8 E2E6 AF               4      XOR A
0015C9 E2E7 3E00             7      LD  A,000H
       E2E8                     RBRA_SWC    EQU $-1
0015CB E2E9 C9              10      RET
                                
       E2EA                     RBRDIR:
0015CC E2EA FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0015CF E2ED FD661B          19      LD  H,(IY+27)
0015D2 E2F0 CDC3DE          17      CALL    CHDIR
0015D5 E2F3 AF               4      XOR A
0015D6 E2F4 67               4      LD  H,A
0015D7 E2F5 6F               4      LD  L,A
0015D8 E2F6 3C               4      INC A
0015D9 E2F7 32E8E2          13      LD  (RBRA_SWC),A
0015DC E2FA 18E5            12      JR  RBREND0
                                ;(15)
       E2FC                     RBX0:
0015DE E2FC 2A8AF0          16      LD  HL,(_DTA)
0015E1 E2FF 225FF0          16      LD  (DTAX),HL
0015E4 E302 2A5DF0          16      LD  HL,(LEFTX)
0015E7 E305 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0015EA E308 D6FD             7      SUB 0FDH
0015EC E30A C9              10      RET
                                
       E30B                     RBX1:               ;ファイルサイズとランダムレコードを比べる
0015ED E30B E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
0015EE E30C FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
0015F1 E30F FD6611          19      LD  H,(IY+17)   ;
0015F4 E312 FD7E12          19      LD  A,(IY+18)   ;
                                
0015F7 E315 CD44E1          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0015FA E318 A7               4      AND A
0015FB E319 ED52            15      SBC HL,DE
0015FD E31B 99               4      SBC A,C
0015FE E31C 4F               4      LD  C,A
0015FF E31D FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
001602 E320 98               4      SBC A,B
001603 E321 D1              10      POP DE
001604 E322 C9              10      RET
       E323                     RBX1R:              ;(8)
001605 E323 47               4      LD  B,A
001606 E324 B1               4      OR  C
001607 E325 EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
001608 E326 B2               4      OR  D
001609 E327 B3               4      OR  E
00160A E328 C0              11      RET NZ
00160B E329 37               4      SCF
00160C E32A C9              10      RET
                                
       E32B                     RBX2:               ;Cluster settings
00160D E32B FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001610 E32E FD4E23          19      LD  C,(IY+35)
001613 E331 0600             7      LD  B,0
001615 E333 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001619 E337 2003            12      JR  NZ,RBX3
00161B E339 FD4624          19      LD  B,(IY+36)
       E33C                     RBX3:
00161E E33C CD70E0          17      CALL    RWXR
001621 E33F 3A61E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001624 E342 3D               4      DEC A
001625 E343 FDA622          19      AND (IY+34)
001628 E346 FDB621          19      OR  (IY+33)
00162B E349 C9              10      RET
                                
       E34A                     RBXA:
00162C E34A C5              11      PUSH    BC
00162D E34B D5              11      PUSH    DE
00162E E34C CD84DE          17      CALL    CLUSTX
001631 E34F CD55E4          17      CALL    DRDX
001634 E352 D1              10      POP DE
001635 E353 C1              10      POP BC
001636 E354 D4F4E5          17      CALL    NC,GNCLX
001639 E357 D8              11      RET C
00163A E358 ED53FEF1        20      LD  (_CLPS),DE
                                
00163E E35C FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
001641 E35F 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       E360                     SECSZ   EQU $-2
       E361                     SECSZ_H EQU $-1
001644 E362 7C               4      LD  A,H
001645 E363 3D               4      DEC A       ;1024=3 / 512=1
001646 E364 FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
001649 E367 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
00164A E368 ED42            15      SBC HL,BC       ;残りを計算
                                
00164C E36A ED5B5DF0        20      LD  DE,(LEFTX)
001650 E36E ED52            15      SBC HL,DE       ;CP HL,DE
001652 E370 19              11      ADD HL,DE       ;
001653 E371 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
001655 E373 EB               4      EX  DE,HL
       E374                     RBXA1:
001656 E374 E5              11      PUSH    HL
001657 E375 2A7EF1          16      LD  HL,(_DTBUF)
00165A E378 09              11      ADD HL,BC
00165B E379 ED5B5FF0        20      LD  DE,(DTAX)
00165F E37D C1              10      POP BC
001660 E37E C9              10      RET
                                
       E37F                     RBXB:
001661 E37F 2A5FF0          16      LD  HL,(DTAX)
001664 E382 ED5BFEF1        20      LD  DE,(_CLPS)
001668 E386 3A5EF0          13      LD  A,(LEFTX+1)
00166B E389 47               4      LD  B,A
00166C E38A 3A61E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E38D                     RBXB1:
00166F E38D 1F               4      RRA     ;->CF
001670 E38E 3804            12      JR  C,RBXB2
001672 E390 CB38             8      SRL B   ;B=B/2
001674 E392 18F9            12      JR  RBXB1
       E394                     RBXB2:
001676 E394 78               4      LD  A,B
001677 E395 B7               4      OR  A
001678 E396 C9              10      RET
                                ;(12)
       E397                     RBXC:
001679 E397 ED4B5DF0        20      LD  BC,(LEFTX)
00167D E39B 3A61E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001680 E39E 3D               4      DEC A
001681 E39F A0               4      AND B
001682 E3A0 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
001683 E3A1 B1               4      OR  C
001684 E3A2 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E3A3                     DWTC:
001685 E3A3 E5              11      PUSH    HL
001686 E3A4 218DE7          10      LD  HL,DWT24B
001689 E3A7 1804            12      JR  DWTC1
       E3A9                     DRDC:
00168B E3A9 E5              11      PUSH    HL
00168C E3AA 217FE7          10      LD  HL,DRD24B
       E3AD                     DWTC1:
00168F E3AD 2207E4          16      LD  (DRWF_MODE),HL
001692 E3B0 E1              10      POP HL
001693 E3B1 3AF7E3          13      LD  A,(DRWF_B)
001696 E3B4 B7               4      OR  A
001697 E3B5 200F            12      JR  NZ,DRDC1
       E3B7                     SAVE_DRWC:
001699 E3B7 0601             7      LD  B,1
00169B E3B9 ED43F6E3        20      LD  (DRWF_C),BC
00169F E3BD ED53FDE3        20      LD  (DRWF_E),DE
0016A3 E3C1 2200E4          16      LD  (DRWF_HL),HL
0016A6 E3C4 1820            12      JR  INC_HL_DRWC
       E3C6                     DRDC1:
0016A8 E3C6 E5              11      PUSH    HL
0016A9 E3C7 21FDE3          10      LD  HL,DRWF_E
0016AC E3CA 86               7      ADD A,(HL)
0016AD E3CB F5              11      PUSH    AF
0016AE E3CC BB               4      CP  E
0016AF E3CD 201D            12      JR  NZ,DRDC2
0016B1 E3CF F1              10      POP AF
0016B2 E3D0 23               6      INC HL
0016B3 E3D1 7E               7      LD  A,(HL)
0016B4 E3D2 CE00             7      ADC A,0
0016B6 E3D4 F5              11      PUSH    AF
0016B7 E3D5 BA               4      CP  D
0016B8 E3D6 2014            12      JR  NZ,DRDC2
0016BA E3D8 F1              10      POP AF
0016BB E3D9 3AF6E3          13      LD  A,(DRWF_C)
0016BE E3DC CE00             7      ADC A,0
0016C0 E3DE B9               4      CP  C
0016C1 E3DF 200C            12      JR  NZ,DRDC3
0016C3 E3E1 21F7E3          10      LD  HL,DRWF_B
0016C6 E3E4 34              11      INC (HL)
0016C7 E3E5 E1              10      POP HL
       E3E6                     INC_HL_DRWC:
0016C8 E3E6 3A61E3          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
0016CB E3E9 84               4      ADD A,H
0016CC E3EA 67               4      LD  H,A
0016CD E3EB C9              10      RET
       E3EC                     DRDC2:
0016CE E3EC F1              10      POP AF
       E3ED                     DRDC3:
0016CF E3ED CDF3E3          17      CALL    DRW_FLUSH
0016D2 E3F0 E1              10      POP HL
0016D3 E3F1 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E3F3                     DRW_FLUSH:
0016D5 E3F3 C5              11      PUSH    BC
0016D6 E3F4 D5              11      PUSH    DE
0016D7 E3F5 010000          10      LD  BC,0
       E3F6                     DRWF_C  EQU $-2
       E3F7                     DRWF_B  EQU $-1
0016DA E3F8 78               4      LD  A,B
0016DB E3F9 B7               4      OR  A
0016DC E3FA 280D            12      JR  Z,DRDF1
0016DE E3FC 110000          10      LD  DE,0
       E3FD                     DRWF_E  EQU $-2
       E3FE                     DRWF_D  EQU $-1
0016E1 E3FF 210000          10      LD  HL,0
       E400                     DRWF_HL EQU $-2
0016E4 E402 AF               4      XOR A
0016E5 E403 32F7E3          13      LD  (DRWF_B),A
0016E8 E406 CD7FE7          17      CALL    DRD24B
       E407                     DRWF_MODE   EQU $-2
       E409                     DRDF1:
0016EB E409 D1              10      POP DE
0016EC E40A C1              10      POP BC
0016ED E40B C9              10      RET
                                
       E40C                     RB_WRITE:
0016EE E40C C5              11      PUSH    BC
0016EF E40D 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0016F1 E40F 1803            12      JR  RBRW
       E411                     RB_READ:
0016F3 E411 C5              11      PUSH    BC
0016F4 E412 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       E414                     RBRW:
0016F6 E414 1F               4      RRA     ;AHL = AHL*128
0016F7 E415 7C               4      LD  A,H ;AHL = AHL0/2
0016F8 E416 1F               4      RRA     ;A
0016F9 E417 65               4      LD  H,L ;
0016FA E418 CB1C             8      RR  H   ;H
0016FC E41A 2E00             7      LD  L,0 ;
0016FE E41C CB1D             8      RR  L   ;L
001700 E41E CD29E1          17      CALL    SET_RR_AHL
001703 E421 218000          10      LD  HL,128
001706 E424 C5              11      PUSH    BC
       E425                     SETSEQ_SWC_RND:
001707 E425 CD58E1          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
00170A E428 C1              10      POP BC
00170B E429 FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
00170F E42D FDE5            15      PUSH    IY
001711 E42F D1              10      POP DE
001712 E430 D5              11      PUSH    DE
001713 E431 CD4BD4          17      CALL    BDOS0
001716 E434 FDE1            14      POP IY
001718 E436 CD33E1          17      CALL    SETSEQ      ;SETSEQ or POPRR
       E437                     SETSEQ_SWC_SEQ_RR   EQU $-2
00171B E439 FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
00171F E43D C1              10      POP BC
001720 E43E C9              10      RET
                                
                                ;(22)
       E43F                     INIT_SEQ:
001721 E43F 3E01             7      LD  A,1     ;LD BC,????
001723 E441 2133E1          10      LD  HL,SETSEQ
001726 E444 CDF9E0          17      CALL    PUSHRR
       E447                     GETSEQ:
001729 E447 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
00172C E44A FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
00172F E44D AF               4      XOR A
                                
001730 E44E CB25             8      SLA L   ;L=L*2
                                
001732 E450 CB3C             8      SRL H   ;HL=HL/2
001734 E452 CB1D             8      RR  L   ;
001736 E454 C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E455                     DRDX:
001737 E455 CD93E4          17      CALL    DRDY
00173A E458 C8              11      RET Z
00173B E459 CD79E4          17      CALL    DRDX1       ;データバッファの情報を保存
00173E E45C D8              11      RET C
00173F E45D E5              11      PUSH    HL
001740 E45E C5              11      PUSH    BC
001741 E45F D5              11      PUSH    DE
001742 E460 2A7EF1          16      LD  HL,(_DTBUF)
001745 E463 3ABCE4          13      LD  A,(_DBS24)
001748 E466 4F               4      LD  C,A
001749 E467 CD7DE7          17      CALL    DRD24
00174C E46A DC8EE4          17      CALL    C,DRDNE
       E46D                     POP_DE_BC_HL_RET:
00174F E46D D1              10      POP DE
001750 E46E C1              10      POP BC
001751 E46F E1              10      POP HL
001752 E470 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E471                     DRDN:
001753 E471 AF               4      XOR A
001754 E472 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
001755 E473 30E0            12      JR  NC,DRDX
       E475                     DRDNX:
001757 E475 CD93E4          17      CALL    DRDY
00175A E478 C8              11      RET Z
       E479                     DRDX1:
00175B E479 CDA9E4          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
00175E E47C ED53A6F0        20      LD  (_DBSEC),DE
001762 E480 79               4      LD  A,C
001763 E481 32BCE4          13      LD  (_DBS24),A
                                
001766 E484 3A88F0          13      LD  A,(_DRV)
001769 E487 32A5F0          13      LD  (_DBDRV),A
00176C E48A CDD9F0          17      CALL    _CHGDRV
00176F E48D D0              11      RET NC
       E48E                     DRDNE:
001770 E48E 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001771 E48F 32A5F0          13      LD  (_DBDRV),A
001774 E492 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E493                     DRDY:
001775 E493 3ABCE4          13      LD  A,(_DBS24)
001778 E496 B9               4      CP  C
001779 E497 C0              11      RET NZ
                                
00177A E498 E5              11      PUSH    HL
00177B E499 3A88F0          13      LD  A,(_DRV)
00177E E49C 21A5F0          10      LD  HL,_DBDRV
001781 E49F AE               7      XOR (HL)
001782 E4A0 2005            12      JR  NZ,POP_HL_RET
                                
001784 E4A2 2AA6F0          16      LD  HL,(_DBSEC)
001787 E4A5 ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E4A7                     POP_HL_RET:
001789 E4A7 E1              10      POP HL
00178A E4A8 C9              10      RET
                                
       E4A9                     DWTX:
00178B E4A9 3AA4F0          13      LD  A,(_WTDBF)
00178E E4AC B7               4      OR  A
00178F E4AD C8              11      RET Z
001790 E4AE AF               4      XOR A
001791 E4AF 32A4F0          13      LD  (_WTDBF),A
                                
001794 E4B2 E5              11      PUSH    HL
001795 E4B3 C5              11      PUSH    BC
001796 E4B4 D5              11      PUSH    DE
001797 E4B5 3AA5F0          13      LD  A,(_DBDRV)
00179A E4B8 CDD9F0          17      CALL    _CHGDRV
00179D E4BB 0E00             7      LD  C,0
       E4BC                     _DBS24  EQU $-1
00179F E4BD ED5BA6F0        20      LD  DE,(_DBSEC)
0017A3 E4C1 2A7EF1          16      LD  HL,(_DTBUF)
0017A6 E4C4 D48BE7          17      CALL    NC,DWT24
       E4C7                     POP_DE_BC_HL_RET2:
0017A9 E4C7 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E4C9                     RDFATX:
0017AB E4C9 E5              11      PUSH    HL
0017AC E4CA 3A88F0          13      LD  A,(_DRV)
0017AF E4CD 21AAF0          10      LD  HL,_FATDRV
0017B2 E4D0 AE               7      XOR (HL)
0017B3 E4D1 28D4            12      JR  Z,POP_HL_RET
                                
0017B5 E4D3 C5              11      PUSH    BC
0017B6 E4D4 D5              11      PUSH    DE
0017B7 E4D5 DDE5            15      PUSH    IX
0017B9 E4D7 CDF3E4          17      CALL    WTFATX
0017BC E4DA 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
0017BE E4DC AF               4      XOR A
0017BF E4DD 32ABF0          13      LD  (_FATIX),A
0017C2 E4E0 3A88F0          13      LD  A,(_DRV)
0017C5 E4E3 32AAF0          13      LD  (_FATDRV),A
0017C8 E4E6 CDE5F0          17      CALL    _RDFAT
       E4E9                     RDFATE2:
0017CB E4E9 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
0017CD E4EB 9F               4      SBC A,A     ;A=0xFF
0017CE E4EC 32AAF0          13      LD  (_FATDRV),A
       E4EF                     POP_IX_DE_BC_HL_RET:
0017D1 E4EF DDE1            14      POP IX
0017D3 E4F1 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E4F3                     WTFATX:
0017D5 E4F3 3AA2F0          13      LD  A,(_WTFATF)
0017D8 E4F6 B7               4      OR  A
0017D9 E4F7 C8              11      RET Z
0017DA E4F8 AF               4      XOR A
0017DB E4F9 32A2F0          13      LD  (_WTFATF),A
                                
0017DE E4FC E5              11      PUSH    HL
0017DF E4FD 3AAAF0          13      LD  A,(_FATDRV)
0017E2 E500 21A5F0          10      LD  HL,_DBDRV
0017E5 E503 AE               7      XOR (HL)
0017E6 E504 CCA9E4          17      CALL    Z,DWTX
0017E9 E507 389E            12      JR  C,POP_HL_RET
0017EB E509 C5              11      PUSH    BC
0017EC E50A D5              11      PUSH    DE
0017ED E50B DDE5            15      PUSH    IX
0017EF E50D CD9CE7          17      CALL    FATSETUP
0017F2 E510 D48DE7          17      CALL    NC,DWT24B
0017F5 E513 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E515                     N16CL1:
0017F7 E515 7A               4      LD  A,D
0017F8 E516 B3               4      OR  E
0017F9 E517 37               4      SCF
0017FA E518 C8              11      RET Z
                                
0017FB E519 7A               4      LD  A,D
0017FC E51A 1807            12      JR  NCL1X
       E51C                     NCL1:
0017FE E51C 7A               4      LD  A,D
0017FF E51D B3               4      OR  E
001800 E51E 37               4      SCF
001801 E51F C8              11      RET Z
                                
001802 E520 7A               4      LD  A,D
001803 E521 CB3F             8      SRL A   ;/2
       E523                     NCL1X:
001805 E523 CB3F             8      SRL A   ;/2
                                
001807 E525 E5              11      PUSH    HL
001808 E526 3245E5          13      LD  (NCLPAT_FATIX),A    ;_FATIX
00180B E529 2AAAF0          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
00180E E52C BC               4      CP  H
00180F E52D 3A88F0          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001812 E530 3244E5          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
001815 E533 2005            12      JR  NZ,NCL2     ;FATIXが違う
001817 E535 BD               4      CP  L
001818 E536 2002            12      JR  NZ,NCL2     ;ドライブが違う
00181A E538 E1              10      POP HL
00181B E539 C9              10      RET
       E53A                     NCL2:
00181C E53A C5              11      PUSH    BC
00181D E53B D5              11      PUSH    DE
00181E E53C DDE5            15      PUSH    IX
001820 E53E CDF3E4          17      CALL    WTFATX
001823 E541 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
001825 E543 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E545                     NCLPAT_FATIX    EQU $-1
       E544                     NCLPAT_FATDRV   EQU $-2
001828 E546 ED43AAF0        20      LD  (_FATDRV),BC
00182C E54A CD71E7          17      CALL    RDFATS
00182F E54D 189A            12      JR  RDFATE2
                                
       E54F                     NCL3:
001831 E54F CB9A             8      RES 3,D
001833 E551 CB92             8      RES 2,D
001835 E553 6B               4      LD  L,E
001836 E554 62               4      LD  H,D
001837 E555 CB3C             8      SRL H   ;
001839 E557 CB1D             8      RR  L   ;HLA=HLA/2
00183B E559 1F               4      RRA     ;
00183C E55A F5              11      PUSH    AF
00183D E55B 3AABF0          13      LD  A,(_FATIX)
001840 E55E 0F               4      RRCA
001841 E55F 300B            12      JR  NC,NCL3X1
001843 E561 3A61E3          13      LD  A,(SECSZ_H)
001846 E564 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの際に先頭を512バイトずらす
001848 E566 2004            12      JR  NZ,NCL3X1
00184A E568 010002          10      LD  BC,512
00184D E56B 09              11      ADD HL,BC
       E56C                     NCL3X1:
00184E E56C F1              10      POP AF
00184F E56D ED4B7CF1        20      LD  BC,(_FATBF)
001853 E571 19              11      ADD HL,DE
001854 E572 09              11      ADD HL,BC
001855 E573 17               4      RLA
001856 E574 C9              10      RET
                                
       E575                     GNCL:
001857 E575 CD1CE5          17      CALL    NCL1        ;GET NEXT CLUSTER
00185A E578 D8              11      RET C
00185B E579 C5              11      PUSH    BC
00185C E57A E5              11      PUSH    HL
00185D E57B CD4FE5          17      CALL    NCL3
001860 E57E 3809            12      JR  C,GNC1
001862 E580 5E               7      LD  E,(HL)
001863 E581 23               6      INC HL
001864 E582 7E               7      LD  A,(HL)
001865 E583 E60F             7      AND 00FH
001867 E585 57               4      LD  D,A
001868 E586 E1              10      POP HL
001869 E587 C1              10      POP BC
00186A E588 C9              10      RET
       E589                     GNC1:
00186B E589 7E               7      LD  A,(HL)
00186C E58A 23               6      INC HL
00186D E58B 56               7      LD  D,(HL)
00186E E58C 0604             7      LD  B,4
       E58E                     GNC1L:
001870 E58E CB3A             8      SRL D   ;DA=DA/2
001872 E590 1F               4      RRA     ;
001873 E591 10FB            13      DJNZ    GNC1L
                                
001875 E593 5F               4      LD  E,A
001876 E594 E1              10      POP HL
001877 E595 C1              10      POP BC
001878 E596 A7               4      AND A
001879 E597 C9              10      RET
                                
       E598                     SNCL:
00187A E598 CD1CE5          17      CALL    NCL1
00187D E59B D8              11      RET C
                                ;               SET NEXT CLUSTER
00187E E59C E5              11      PUSH    HL
00187F E59D C5              11      PUSH    BC
001880 E59E D5              11      PUSH    DE
001881 E59F E5              11      PUSH    HL
001882 E5A0 CD4FE5          17      CALL    NCL3
001885 E5A3 D1              10      POP DE
                                ;CF=ODD
001886 E5A4 7E               7      LD  A,(HL)
001887 E5A5 73               7      LD  (HL),E
001888 E5A6 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
00188A E5A8 23               6      INC HL
00188B E5A9 ED67            18      RRD     ;M={A[3:0],E[3:0]}
00188D E5AB 7A               4      LD  A,D
00188E E5AC 1804            12      JR  SNC11
       E5AE                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
001890 E5AE ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001892 E5B0 23               6      INC HL
001893 E5B1 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E5B2                     SNC11:
001894 E5B2 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
001896 E5B4 B7               4      OR  A
001897 E5B5 D1              10      POP DE
001898 E5B6 C1              10      POP BC
001899 E5B7 E1              10      POP HL
       E5B8                     FAT_CHANGED:
00189A E5B8 3EFF             7      LD  A,0FFH
00189C E5BA 32A2F0          13      LD  (_WTFATF),A
00189F E5BD C9              10      RET
                                
       E5BE                     N16CL3:
0018A0 E5BE C5              11      PUSH    BC
0018A1 E5BF 6B               4      LD  L,E
0018A2 E5C0 7A               4      LD  A,D
0018A3 E5C1 E601             7      AND 1
0018A5 E5C3 67               4      LD  H,A
0018A6 E5C4 29              11      ADD HL,HL
0018A7 E5C5 ED4B7CF1        20      LD  BC,(_FATBF)
0018AB E5C9 09              11      ADD HL,BC
0018AC E5CA C1              10      POP BC
0018AD E5CB C9              10      RET
                                
       E5CC                     GNCL16:
0018AE E5CC CD15E5          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
0018B1 E5CF D8              11      RET C
0018B2 E5D0 E5              11      PUSH    HL
0018B3 E5D1 CDBEE5          17      CALL    N16CL3
0018B6 E5D4 5E               7      LD  E,(HL)
0018B7 E5D5 23               6      INC HL
0018B8 E5D6 56               7      LD  D,(HL)
0018B9 E5D7 E1              10      POP HL
0018BA E5D8 C9              10      RET
                                
       E5D9                     SNCL16:
0018BB E5D9 CD15E5          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
0018BE E5DC D8              11      RET C
0018BF E5DD D5              11      PUSH    DE
0018C0 E5DE E5              11      PUSH    HL
0018C1 E5DF CDBEE5          17      CALL    N16CL3
0018C4 E5E2 D1              10      POP DE      ;HL
0018C5 E5E3 73               7      LD  (HL),E
0018C6 E5E4 23               6      INC HL
0018C7 E5E5 72               7      LD  (HL),D
0018C8 E5E6 6B               4      LD  L,E
0018C9 E5E7 62               4      LD  H,D
0018CA E5E8 D1              10      POP DE
0018CB E5E9 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E5EB                     NEXTX:
0018CD E5EB 3E00             7      LD  A,0 ;自己書き換え
       E5EC                     _SECPS  EQU $-1
0018CF E5ED 3C               4      INC A
0018D0 E5EE E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E5EF                     _NCPAT  EQU $-1
0018D2 E5F0 32ECE5          13      LD  (_SECPS),A
0018D5 E5F3 C9              10      RET
                                
       E5F4                     GNCLX:
0018D6 E5F4 CDEBE5          17      CALL    NEXTX
0018D9 E5F7 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
0018DA E5F8 C3F7F0          10      JP  _GNCL   ;次のクラスタを探す
                                
       E5FB                     RDFAT:
0018DD E5FB 3E80             7      LD  A,080H
0018DF E5FD 3270F0          13      LD  (CHECK),A
       E600                     RDFAT1:
0018E2 E600 3A88F0          13      LD  A,(_DRV)
0018E5 E603 CDA5E8          17      CALL    CHGDRVR
0018E8 E606 D8              11      RET C
0018E9 E607 DD7E12          19      LD  A,(IX+DPB_DEVICE)
0018EC E60A CB6F             8      BIT 5,A
0018EE E60C 286E            12      JR  Z,RDFAT0X
0018F0 E60E 2170F0          10      LD  HL,CHECK
0018F3 E611 A6               7      AND (HL)
0018F4 E612 77               7      LD  (HL),A
0018F5 E613 110000          10      LD  DE,0        ;BPB
0018F8 E616 2A7CF1          16      LD  HL,(_FATBF)
0018FB E619 0E00             7      LD  C,0
0018FD E61B CD7DE7          17      CALL    DRD24
001900 E61E 3022            12      JR  NC,GETBPB
001902 E620 2170F0          10      LD  HL,CHECK
001905 E623 CB06            15      RLC (HL)
001907 E625 3F               4      CCF
001908 E626 D8              11      RET C
001909 E627 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
00190D E62B 3F               4      CCF         ;フロッピーディスクのFDモード(2D/2HD)を切り替える
00190E E62C DDCB0A16        23      RL  (IX+DPB_FDMODE)
001912 E630 3A84F0          13      LD  A,(_DRIVE)
001915 E633 E603             7      AND 3
001917 E635 F680             7      OR  080H
001919 E637 6F               4      LD  L,A
00191A E638 26F0             7      LD  H,_CYL0/256
00191C E63A 3EFF             7      LD  A,0FFH
00191E E63C 3289F0          13      LD  (_DSK),A
001921 E63F 77               7      LD  (HL),A
001922 E640 18BE            12      JR  RDFAT1
       E642                     GETBPB:
001924 E642 FDE5            15      PUSH    IY
001926 E644 FD2A7CF1        20      LD  IY,(_FATBF) ;BPB
00192A E648 CDF1F0          17      CALL    _BPB2DPB
00192D E64B FDE1            14      POP IY
00192F E64D DD7E12          19      LD  A,(IX+DPB_DEVICE)
001932 E650 3027            12      JR  NC,GETBPBOK
001934 E652 E60F             7      AND 00FH
001936 E654 FE07             7      CP  7
001938 E656 37               4      SCF
001939 E657 C0              11      RET NZ
00193A E658 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
00193E E65C 21C0F1          10      LD  HL,M2D
001941 E65F 2008            12      JR  NZ,SETFDMODE
001943 E661 2E04             7      LD  L,4
001945 E663 CD66E7          17      CALL    CHECK_MAXSECSZ
001948 E666 D8              11      RET C
001949 E667 2ED2             7      LD  L,M2HD-STABLE
       E669                     SETFDMODE:
00194B E669 DDE5            15      PUSH    IX
00194D E66B D1              10      POP DE
00194E E66C EDA0            16      LDI
001950 E66E EDA0            16      LDI
001952 E670 13               6      INC DE
001953 E671 13               6      INC DE
001954 E672 13               6      INC DE
001955 E673 13               6      INC DE
001956 E674 010C00          10      LD  BC,12
001959 E677 EDB0                    LDIR
       E679                     GETBPBOK:
00195B E679 CD11E8          17      CALL    CHGDRV2
       E67C                     RDFAT0X:
00195E E67C CD71E7          17      CALL    RDFATS
001961 E67F D8              11      RET C
001962 E680 DDAE06          19      XOR (IX+DPB_FATID)
001965 E683 C8              11      RET Z
001966 E684 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001969 E687 CB5F             8      BIT 3,A
00196B E689 2803            12      JR  Z,RDFAT0X1
00196D E68B CB6F             8      BIT 5,A
00196F E68D C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E68E                     RDFAT0X1:
001970 E68E 37               4      SCF
001971 E68F C9              10      RET
                                
       E690                     POP_HL_SCF_RET:
001972 E690 E1              10      POP HL
001973 E691 37               4      SCF
001974 E692 C9              10      RET
                                
       E693                     BPB2DPB:
001975 E693 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
001978 E696 B7               4      OR  A
001979 E697 37               4      SCF
00197A E698 C0              11      RET NZ
       E699                     BPBOK:
00197B E699 FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
00197E E69C DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001981 E69F FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001984 E6A2 DD7700          19      LD  (IX+DPB_FATLN),A
001987 E6A5 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
00198A E6A8 DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
00198D E6AB FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001990 E6AE FD660F          19      LD  H,(IY+15)
001993 E6B1 DD750E          19      LD  (IX+DPB_FATPS),L
001996 E6B4 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
001999 E6B7 FD5617          19      LD  D,(IY+23)
00199C E6BA FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E6BD                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
00199F E6BD 19              11      ADD HL,DE
0019A0 E6BE 10FD            13      DJNZ    BPBDP1
       E6C0                     BPBDP2:
0019A2 E6C0 DD7510          19      LD  (IX+DPB_DIRPS),L
0019A5 E6C3 DD7411          19      LD  (IX+DPB_DIRPS+1),H
0019A8 E6C6 E5              11      PUSH    HL
                                
0019A9 E6C7 FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
0019AC E6CA FD6612          19      LD  H,(IY+18)
0019AF E6CD FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
0019B2 E6D0 B7               4      OR  A
0019B3 E6D1 28BD            12      JR  Z,POP_HL_SCF_RET
0019B5 E6D3 0606             7      LD  B,6
       E6D5                     BPBBPS1:
0019B7 E6D5 05               4      DEC B
0019B8 E6D6 0F               4      RRCA
0019B9 E6D7 30FC            12      JR  NC,BPBBPS1
       E6D9                     BPBDE1:
0019BB E6D9 29              11      ADD HL,HL
0019BC E6DA 10FD            13      DJNZ    BPBDE1
                                
0019BE E6DC 7C               4      LD  A,H
0019BF E6DD DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
0019C2 E6E0 D1              10      POP DE      ;DPB_DIRPS
0019C3 E6E1 6C               4      LD  L,H
0019C4 E6E2 2600             7      LD  H,0
0019C6 E6E4 19              11      ADD HL,DE       ;MAXDIR
0019C7 E6E5 E5              11      PUSH    HL
0019C8 E6E6 FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
0019CB E6E9 CB21             8      SLA C       ;*2
0019CD E6EB AF               4      XOR A
0019CE E6EC 47               4      LD  B,A
0019CF E6ED ED42            15      SBC HL,BC
0019D1 E6EF DD7514          19      LD  (IX+DPB_ADDCL),L
0019D4 E6F2 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
0019D7 E6F5 D1              10      POP DE      ;DE=DPB_MAXDIR
0019D8 E6F6 FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
0019DB E6F9 FD6614          19      LD  H,(IY+20)
                                
0019DE E6FC DD7E12          19      LD  A,(IX+DPB_DEVICE)
0019E1 E6FF E60F             7      AND 00FH
0019E3 E701 FE07             7      CP  7       ;フロッピー
0019E5 E703 2019            12      JR  NZ,NOT_FD
0019E7 E705 E5              11      PUSH    HL
0019E8 E706 FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
0019EB E709 DD710D          19      LD  (IX+DPB_MAXSEC),C
0019EE E70C AF               4      XOR A
0019EF E70D CB21             8      SLA C       ;両面なのでセクタ数を２倍
0019F1 E70F 0610             7      LD  B,16
       E711                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
0019F3 E711 29              11      ADD HL,HL
0019F4 E712 17               4      RLA
0019F5 E713 B9               4      CP  C
0019F6 E714 3802            12      JR  C,DIVSEC1
0019F8 E716 91               4      SUB C
0019F9 E717 2C               4      INC L
       E718                     DIVSEC1:
0019FA E718 10F7            13      DJNZ    DIVSEC
0019FC E71A DD750C          19      LD  (IX+DPB_MAXCYL),L
0019FF E71D E1              10      POP HL  ;ここまでフロッピー専用
       E71E                     NOT_FD:
001A00 E71E 7C               4      LD  A,H
001A01 E71F B5               4      OR  L
001A02 E720 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001A04 E722 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001A06 E724 2F               4      CPL         ;A=0FFH
001A07 E725 FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
001A0A E728 D8              11      RET C
001A0B E729 FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001A0E E72C FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001A11 E72F FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E732                     BPB16BIT:
001A14 E732 ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001A16 E734 DE00             7      SBC A,0
001A18 E736 FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E739                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001A1B E739 CB18             8      RR  B       ;->CY
001A1D E73B 3808            12      JR  C,BPBTC2
001A1F E73D CB3F             8      SRL A
001A21 E73F CB1C             8      RR  H       ;AHL=AHL/2
001A23 E741 CB1D             8      RR  L
001A25 E743 18F4            12      JR  BPBTC1
       E745                     BPBTC2:
001A27 E745 C6FF             7      ADD A,0FFH
001A29 E747 D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001A2A E748 23               6      INC HL
001A2B E749 23               6      INC HL
001A2C E74A DD7508          19      LD  (IX+DPB_MAXCL),L
001A2F E74D DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001A32 E750 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001A35 E753 DD7706          19      LD  (IX+DPB_FATID),A
                                
001A38 E756 FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001A3B E759 C6FE             7      ADD A,0-2       ;>2:CF=1
001A3D E75B FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001A40 E75E 6F               4      LD  L,A
001A41 E75F 3002            12      JR  NC,BPBFAT1
001A43 E761 F680             7      OR  080H
       E763                     BPBFAT1:            ;ここではCF=0
001A45 E763 DD770F          19      LD  (IX+DPB_BPS),A
       E766                     CHECK_MAXSECSZ:
001A48 E766 3A7BF1          13      LD  A,(_MAX_SEC_SZ_H)
001A4B E769 BD               4      CP  L
001A4C E76A C8              11      RET Z       ;1セクタ1024バイト
001A4D E76B 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001A4E E76C C8              11      RET Z       ;1セクタ256バイト
001A4F E76D 2D               4      DEC L
001A50 E76E C8              11      RET Z       ;1セクタ512バイト
001A51 E76F 37               4      SCF
001A52 E770 C9              10      RET
                                
       E771                     RDFATS:
001A53 E771 CD9CE7          17      CALL    FATSETUP
001A56 E774 D8              11      RET C
001A57 E775 CD7FE7          17      CALL    DRD24B
001A5A E778 2A7CF1          16      LD  HL,(_FATBF)
001A5D E77B 7E               7      LD  A,(HL)
001A5E E77C C9              10      RET
                                
       E77D                     DRD24:
001A5F E77D 0601             7      LD  B,1
       E77F                     DRD24B:
001A61 E77F DDE5            15      PUSH    IX
001A63 E781 DD2AA8F0        20      LD  IX,(_DPB)
001A67 E785 CDE5E9          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E786                     DRDPAT  EQU $-2
001A6A E788 DDE1            14      POP IX
001A6C E78A C9              10      RET
                                
       E78B                     DWT24:
001A6D E78B 0601             7      LD  B,1
       E78D                     DWT24B:
001A6F E78D DDE5            15      PUSH    IX
001A71 E78F DD2AA8F0        20      LD  IX,(_DPB)
001A75 E793 CD8EE9          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E794                     DWTPAT  EQU $-2
001A78 E796 DDE1            14      POP IX
001A7A E798 D0              11      RET NC
001A7B E799 C35AF0          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E79C                     FATSETUP:
001A7E E79C 3AAAF0          13      LD  A,(_FATDRV)
001A81 E79F CDA5E8          17      CALL    CHGDRVR     ;ドライブ切り替え
001A84 E7A2 D8              11      RET C
       E7A3                     FATS2:
001A85 E7A3 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001A88 E7A6 0F               4      RRCA
001A89 E7A7 CDD7E7          17      CALL    FATSETUP12  ;自己書き換え
       E7A8                     FATSX   EQU $-2
001A8C E7AA 210000          10      LD  HL,0
001A8F E7AD 4A               4      LD  C,D
001A90 E7AE 54               4      LD  D,H
001A91 E7AF 3AABF0          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
001A94 E7B2 47               4      LD  B,A
001A95 E7B3 04               4      INC B
001A96 E7B4 DD7E00          19      LD  A,(IX+DPB_FATLN)
       E7B7                     FAT_SKP:
001A99 E7B7 05               4      DEC B
001A9A E7B8 2809            12      JR  Z,FAT1
001A9C E7BA 19              11      ADD HL,DE
001A9D E7BB 93               4      SUB E
001A9E E7BC 30F9            12      JR  NC,FAT_SKP
001AA0 E7BE DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
001AA4 E7C2 C8              11      RET Z
       E7C3                     FAT1:
001AA5 E7C3 EB               4      EX  DE,HL
001AA6 E7C4 B7               4      OR  A       ;0の場合は0100Hとして扱う
001AA7 E7C5 2803            12      JR  Z,FAT3
001AA9 E7C7 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001AAA E7C8 3801            12      JR  C,FAT2
       E7CA                     FAT3:
001AAC E7CA 79               4      LD  A,C
       E7CB                     FAT2:
001AAD E7CB 47               4      LD  B,A
                                
001AAE E7CC 2AFAF1          16      LD  HL,(_FATPS) ;fat sector pos
001AB1 E7CF 19              11      ADD HL,DE
001AB2 E7D0 EB               4      EX  DE,HL
001AB3 E7D1 2A7CF1          16      LD  HL,(_FATBF)
001AB6 E7D4 AF               4      XOR A       ;CF=0
001AB7 E7D5 4F               4      LD  C,A
001AB8 E7D6 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E7D7                     FATSETUP12:
001AB9 E7D7 110606          10      LD  DE,0606H    ;256
001ABC E7DA D8              11      RET C
001ABD E7DB 110303          10      LD  DE,0303H    ;512
001AC0 E7DE 0F               4      RRCA
001AC1 E7DF D8              11      RET C
001AC2 E7E0 110102          10      LD  DE,0201H    ;1024
001AC5 E7E3 C9              10      RET
                                
       E7E4                     FATSETUP16:
001AC6 E7E4 110404          10      LD  DE,0404H    ;256
001AC9 E7E7 D8              11      RET C
001ACA E7E8 110202          10      LD  DE,0202H    ;512
001ACD E7EB 0F               4      RRCA
001ACE E7EC D8              11      RET C
001ACF E7ED 110101          10      LD  DE,0101H    ;1024
001AD2 E7F0 C9              10      RET
                                
       E7F1                     CHGDRV:
001AD3 E7F1 E5              11      PUSH    HL
001AD4 E7F2 2189F0          10      LD  HL,_DSK
001AD7 E7F5 BE               7      CP  (HL)
001AD8 E7F6 280A            12      JR  Z,CHGDRVE
       E7F8                     CHGDRV1:
001ADA E7F8 DDE5            15      PUSH    IX
001ADC E7FA CD04E8          17      CALL    CHGDRV0
001ADF E7FD 3A89F0          13      LD  A,(_DSK)
001AE2 E800 DDE1            14      POP IX
       E802                     CHGDRVE:
001AE4 E802 E1              10      POP HL
001AE5 E803 C9              10      RET
                                
       E804                     CHGDRV0:
001AE6 E804 6F               4      LD  L,A
001AE7 E805 CDDCF0          17      CALL    _GETDPB
001AEA E808 D8              11      RET C
001AEB E809 DD22A8F0        20      LD  (_DPB),IX
001AEF E80D 7D               4      LD  A,L
001AF0 E80E 3289F0          13      LD  (_DSK),A
       E811                     CHGDRV2:
001AF3 E811 C5              11      PUSH    BC
001AF4 E812 D5              11      PUSH    DE
001AF5 E813 ED735CE8        20      LD  (SPPAT2),SP
001AF9 E817 F3               4      DI
001AFA E818 DDF9            10      LD  SP,IX
                                
001AFC E81A E1              10      POP HL      ;00:DPB_FATLN
001AFD E81B E1              10      POP HL      ;02:DPB_DRD
001AFE E81C 2286E7          16      LD  (DRDPAT),HL
                                
001B01 E81F E1              10      POP HL
001B02 E820 2294E7          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001B05 E823 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001B06 E824 7C               4      LD  A,H
001B07 E825 3288DE          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001B0A E828 3D               4      DEC A
001B0B E829 32EFE5          13      LD  (_NCPAT),A
                                
001B0E E82C E1              10      POP HL      ;08:DPB_MAXCL
001B0F E82D 7D               4      LD  A,L
001B10 E82E 32A7DE          13      LD  (CLPAT2),A
001B13 E831 7C               4      LD  A,H
001B14 E832 32A3DE          13      LD  (CLPAT1),A
001B17 E835 2B               6      DEC HL
001B18 E836 22A6E0          16      LD  (MAXCLP),HL
                                
001B1B E839 E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001B1C E83A 4C               4      LD  C,H
                                
001B1D E83B E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001B1E E83C E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001B1F E83D 7C               4      LD  A,H     ;DPB_BPS
001B20 E83E E607             7      AND 7
001B22 E840 3261E3          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001B25 E843 87               4      ADD A,A     ;8  4   2
001B26 E844 87               4      ADD A,A     ;010H   8   4
001B27 E845 87               4      ADD A,A     ;020H   010H    8
001B28 E846 3206DD          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001B2B E849 2600             7      LD  H,0
001B2D E84B 22FAF1          16      LD  (_FATPS),HL
                                
001B30 E84E E1              10      POP HL      ;10:DPB_DIRPS
001B31 E84F 22FCF1          16      LD  (_DIRPS),HL
                                
001B34 E852 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001B35 E853 7C               4      LD  A,H
001B36 E854 3284F0          13      LD  (_DRIVE),A
                                
001B39 E857 E1              10      POP HL      ;14:DPB_ADDCL
001B3A E858 2298DE          16      LD  (CLSPAT),HL
                                
001B3D E85B 310000          10      LD  SP,0        ;元のSPを復元
       E85C                     SPPAT2  EQU $-2
001B40 E85E FB               4      EI
001B41 E85F 2AFCF1          16      LD  HL,(_DIRPS)
001B44 E862 0600             7      LD  B,0
001B46 E864 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001B47 E865 2221DD          16      LD  (MD_PAT),HL
                                
001B4A E868 2AA6E0          16      LD  HL,(MAXCLP)
001B4D E86B 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001B50 E86E 19              11      ADD HL,DE
001B51 E86F 380F            12      JR  C,SETFAT16
001B53 E871 2175E5          10      LD  HL,GNCL     ;FAT12
001B56 E874 1198E5          10      LD  DE,SNCL
001B59 E877 01D7E7          10      LD  BC,FATSETUP12
001B5C E87A DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001B60 E87E 180D            12      JR  EXTRA1
       E880                     SETFAT16:
001B62 E880 21CCE5          10      LD  HL,GNCL16   ;FAT16
001B65 E883 11D9E5          10      LD  DE,SNCL16
001B68 E886 01E4E7          10      LD  BC,FATSETUP16
001B6B E889 DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       E88D                     EXTRA1:
001B6F E88D 22F8F0          16      LD  (GNCPAT),HL
001B72 E890 ED53FBF0        20      LD  (SNCPAT),DE
001B76 E894 ED43A8E7        20      LD  (FATSX),BC
001B7A E898 D1              10      POP DE
001B7B E899 C1              10      POP BC
001B7C E89A AF               4      XOR A
001B7D E89B C9              10      RET
                                
       E89C                     GETDPBD:
001B7E E89C DDE3            23      EX  (SP),IX
001B80 E89E DDE5            15      PUSH    IX
001B82 E8A0 3A88F0          13      LD  A,(_DRV)
001B85 E8A3 1807            12      JR  GETDPB1
                                
       E8A5                     CHGDRVR:
001B87 E8A5 CDD9F0          17      CALL    _CHGDRV
001B8A E8A8 D8              11      RET C
001B8B E8A9 3A89F0          13      LD  A,(_DSK)
       E8AC                     GETDPB1:
001B8E E8AC C3DCF0          10      JP  _GETDPB
                                
       E8AF                     GETDPB:
001B91 E8AF FE08             7      CP  8
001B93 E8B1 3F               4      CCF
001B94 E8B2 D8              11      RET C
001B95 E8B3 0F               4      RRCA
001B96 E8B4 0F               4      RRCA
001B97 E8B5 0F               4      RRCA
001B98 E8B6 DD                      DB  0DDH        ;Z80未定義命令
001B99 E8B7 6F               4      LD  L,A     ;LD IXL,A
001B9A E8B8 DD                      DB  0DDH        ;Z80未定義命令
001B9B E8B9 26F2             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001B9D E8BB DD7E00          19      LD  A,(IX+DPB_FATLN)
001BA0 E8BE A7               4      AND A       ;CF=0の為
001BA1 E8BF DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001BA5 E8C3 C0              11      RET NZ      ;FAT16
001BA6 E8C4 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001BAA E8C8 C0              11      RET NZ      ;BPB
001BAB E8C9 FE01             7      CP  001H        ;A=0 THEN CF=1
001BAD E8CB C9              10      RET
                                
       E8CC                     _SYS5F:
001BAE E8CC AF               4      XOR A
       E8CD                     FFLUSH:
001BAF E8CD F5              11      PUSH    AF
001BB0 E8CE CDF3E4          17      CALL    WTFATX
001BB3 E8D1 AF               4      XOR A
001BB4 E8D2 32ABF0          13      LD  (_FATIX),A
001BB7 E8D5 2F               4      CPL         ;0FFH
001BB8 E8D6 32AAF0          13      LD  (_FATDRV),A
001BBB E8D9 3E                      DB  03EH        ;次のPUSH AFをスキップ
       E8DA                     FFLUSHBUF:
001BBC E8DA F5              11      PUSH    AF
001BBD E8DB CDA9E4          17      CALL    DWTX
001BC0 E8DE 3EFF             7      LD  A,0FFH
001BC2 E8E0 3239F0          13      LD  (SFILE),A
001BC5 E8E3 32A5F0          13      LD  (_DBDRV),A
001BC8 E8E6 F1              10      POP AF
001BC9 E8E7 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MZ-700/1500
                                
       E8E8                     SEEK:
001BCA E8E8 0610             7      LD  B,16
001BCC E8EA DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001BCF E8ED AF               4      XOR A
001BD0 E8EE EB               4      EX  DE,HL
       E8EF                     DIV1:
001BD1 E8EF 29              11      ADD HL,HL
001BD2 E8F0 8F               4      ADC A,A
001BD3 E8F1 B9               4      CP  C
001BD4 E8F2 3802            12      JR  C,DIV2
001BD6 E8F4 91               4      SUB C
001BD7 E8F5 2C               4      INC L
       E8F6                     DIV2:
001BD8 E8F6 10F7            13      DJNZ    DIV1
                                
001BDA E8F8 3C               4      INC A   ;最小のセクタは１固定
001BDB E8F9 55               4      LD  D,L ;TRACK
001BDC E8FA 5F               4      LD  E,A ;SECTOR
                                
001BDD E8FB 3A84F0          13      LD  A,(_DRIVE)
001BE0 E8FE FE04             7      CP  4
001BE2 E900 3F               4      CCF
001BE3 E901 D8              11      RET C
001BE4 E902 F684             7      OR  084H        ;Motor on + ドライブセレクト有効
001BE6 E904 D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001BE8 E906 CB3A             8      SRL D       ;CYLINDER
001BEA E908 9F               4      SBC A,A
001BEB E909 D3DD            11      OUT (0DDH),A    ;ヘッドセレクト制御レジスタ
                                
001BED E90B CD43E9          17      CALL    SETMODE
001BF0 E90E D8              11      RET C
                                
001BF1 E90F CD78E9          17      CALL    DRIVE
001BF4 E912 FEFF             7      CP  0FFH        ;A=0FFH Unknown CYLINDER
001BF6 E914 CC5AE9          17      CALL    Z,FDCRES    ;Restore
001BF9 E917 2F               4      CPL         ;データバスが負論理
001BFA E918 D3D9            11      OUT (0D9H),A    ;MB8876 トラックレジスタ
001BFC E91A 2F               4      CPL         ;データバスが負論理
001BFD E91B 92               4      SUB D
001BFE E91C C8              11      RET Z       ;No seek
                                
001BFF E91D DD7E0C          19      LD  A,(IX+DPB_MAXCYL)
001C02 E920 3D               4      DEC A
001C03 E921 BA               4      CP  D       ;Over CYLINDER
001C04 E922 D8              11      RET C
                                
001C05 E923 7A               4      LD  A,D
001C06 E924 2F               4      CPL         ;データバスが負論理
001C07 E925 D3DB            11      OUT (0DBH),A    ;MB8876 データレジスタ
001C09 E927 72               7      LD  (HL),D
                                
001C0A E928 0E18             7      LD  C,018H      ;FDC TypeIコマンド Seek
       E92A                     FDCCMD2:
001C0C E92A 3A85F0          13      LD  A,(_SEEKSP)
001C0F E92D B1               4      OR  C
                                
       E92E                     FDCCMD:
001C10 E92E CD6FE9          17      CALL    COMSET
001C13 E931 3E80             7      LD  A,080H      ;FDC COMMAND(Self-modifying code)
       E932                     FDCSMC  EQU $-1
001C15 E933 E620             7      AND 020H        ;Write data Write track
001C17 E935 3C               4      INC A
                                
       E936                     SST:
001C18 E936 0E00             7      LD  C,0
       E938                     SST1:
001C1A E938 0D               4      DEC C       ; 4
001C1B E939 20FD            12      JR  NZ,SST1     ;12 * 256 / 4 = About 1ms
001C1D E93B 3D               4      DEC A
001C1E E93C 20FA            12      JR  NZ,SST1
                                
001C20 E93E 0E01             7      LD  C,1
001C22 E940 CD48E9          17      CALL    READY
       E943                     SETMODE:
001C25 E943 CD72E9          17      CALL    DELAY0      ;Head select time
001C28 E946 0E81             7      LD  C,081H
       E948                     READY:
001C2A E948 0680             7      LD  B,128
       E94A                     READY2:
001C2C E94A DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001C2E E94C 2F               4      CPL         ;データバスが負論理
001C2F E94D A1               4      AND C       ;NOT READY,BUSY
001C30 E94E C8              11      RET Z
001C31 E94F CD39CF          17      CALL    RD556VSYNC
001C34 E952 07               4      RLCA
001C35 E953 A8               4      XOR B
001C36 E954 0F               4      RRCA
001C37 E955 30F3            12      JR  NC,READY2
001C39 E957 10F1            13      DJNZ    READY2
001C3B E959 C9              10      RET
                                
       E95A                     FDCRES:
001C3C E95A 3600            10      LD  (HL),0
001C3E E95C 0E08             7      LD  C,8     ;FDC TypeIコマンド Restore
001C40 E95E 18CA            12      JR  FDCCMD2
                                
       E960                     FDMOFF:
001C42 E960 F5              11      PUSH    AF
001C43 E961 AF               4      XOR A       ;Motor off(ドライブセレクト無効)
001C44 E962 D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001C46 E964 F1              10      POP AF
001C47 E965 C9              10      RET
                                
       E966                     SECSET_FDCCMD:
001C48 E966 3A32E9          13      LD  A,(FDCSMC)
       E969                     SECSET:
001C4B E969 F5              11      PUSH    AF
001C4C E96A 7B               4      LD  A,E
001C4D E96B 2F               4      CPL         ;データバスが負論理
001C4E E96C D3DA            11      OUT (0DAH),A    ;MB8876 セクタレジスタ
001C50 E96E F1              10      POP AF
       E96F                     COMSET:
001C51 E96F 2F               4      CPL         ;データバスが負論理
001C52 E970 D3D8            11      OUT (0D8H),A    ;MB8876 ステータス/コマンドレジスタ
       E972                     DELAY0:
001C54 E972 3E1A             7      LD  A,26
       E974                     DELAY:
001C56 E974 3D               4      DEC A
001C57 E975 20FD            12      JR  NZ,DELAY
001C59 E977 C9              10      RET
                                
       E978                     DRIVE:                  ;ドライブのシリンダを得る
001C5A E978 2A84F0          16      LD  HL,(_DRIVE)
001C5D E97B 26F0             7      LD  H,_CYL0/256
001C5F E97D CBFD             8      SET 7,L
001C61 E97F 7E               7      LD  A,(HL)
001C62 E980 C9              10      RET
                                
       E981                     RNF:                    ;ドライブのシリンダをリセット
001C63 E981 CD78E9          17      CALL    DRIVE
001C66 E984 36FF            10      LD  (HL),0FFH
001C68 E986 C9              10      RET
                                
001C69 E987 02                  RETRY:  DB  2
                                
                                
                                ;   FLOPPY DISK DRIVER
                                
       E988                     WTTRK:
001C6A E988 0601             7      LD  B,1
001C6C E98A 3EF4             7      LD  A,0F4H      ;FDC TypeIIIコマンド Write Track
001C6E E98C 1802            12      JR  WTTRK1
       E98E                     FDWT:
001C70 E98E 3EA0             7      LD  A,0A0H      ;FDC TypeIIコマンド Write Sector
       E990                     WTTRK1:
001C72 E990 3232E9          13      LD  (FDCSMC),A
       E993                     DWTBL:
001C75 E993 78               4      LD  A,B
001C76 E994 32D0E9          13      LD  (WTBSMC),A
001C79 E997 3E02             7      LD  A,2     ;Retry count
001C7B E999 3287E9          13      LD  (RETRY),A
                                
       E99C                     DWT0:
001C7E E99C D5              11      PUSH    DE
001C7F E99D E5              11      PUSH    HL
001C80 E99E CDE8E8          17      CALL    SEEK        ;Write disk
001C83 E9A1 E1              10      POP HL
001C84 E9A2 3837            12      JR  C,ERRDW
001C86 E9A4 F3               4      DI
001C87 E9A5 CD66E9          17      CALL    SECSET_FDCCMD
001C8A E9A8 0EDB             7      LD  C,0DBH      ;MB8876 データレジスタ
       E9AA                     DWT1:
001C8C E9AA 7E               7      LD  A,(HL)
001C8D E9AB 2F               4      CPL         ;データバスが負論理
001C8E E9AC 57               4      LD  D,A
                                
       E9AD                     DWT2:
001C8F E9AD DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001C91 E9AF 2F               4      CPL         ;データバスが負論理
001C92 E9B0 0F               4      RRCA
001C93 E9B1 3008            12      JR  NC,DWT4
001C95 E9B3 0F               4      RRCA
001C96 E9B4 30F7            12      JR  NC,DWT2
       E9B6                     DWT3:
001C98 E9B6 ED51            12      OUT (C),D       ;MB8876 データレジスタ
001C9A E9B8 23               6      INC HL
001C9B E9B9 18EF            12      JR  DWT1
                                
       E9BB                     DWT4:
001C9D E9BB 3D               4      DEC A
001C9E E9BC 28F8            12      JR  Z,DWT3
001CA0 E9BE 3C               4      INC A
001CA1 E9BF FB               4      EI
001CA2 E9C0 D1              10      POP DE
001CA3 E9C1 13               6      INC DE
001CA4 E9C2 CD60E9          17      CALL    FDMOFF
001CA7 E9C5 2808            12      JR  Z,DISKOK_WT
001CA9 E9C7 CD2FEA          17      CALL    DISKC
001CAC E9CA 20D0            12      JR  NZ,DWT0
001CAE E9CC B7               4      OR  A
001CAF E9CD 2005            12      JR  NZ,ERRW
                                
       E9CF                     DISKOK_WT:
001CB1 E9CF 0601             7      LD  B,1
       E9D0                     WTBSMC  EQU $-1
001CB3 E9D1 10C0            13      DJNZ    DWTBL
001CB5 E9D3 C9              10      RET
                                
       E9D4                     ERRW:
001CB6 E9D4 3EFF             7      LD  A,0FFH
       E9D6                     ERRZ:
001CB8 E9D6 BF               4      CP  A       ;ZF=1
001CB9 E9D7 37               4      SCF
001CBA E9D8 C360E9          10      JP  FDMOFF
                                
       E9DB                     ERRDW:
001CBD E9DB D1              10      POP DE
001CBE E9DC CD40EA          17      CALL    DELP
001CC1 E9DF 20BB            12      JR  NZ,DWT0
001CC3 E9E1 B7               4      OR  A
001CC4 E9E2 20F0            12      JR  NZ,ERRW
001CC6 E9E4 C9              10      RET
                                
       E9E5                     FDRD:
001CC7 E9E5 3E80             7      LD  A,080H      ;FDC TypeIIコマンド Read Sector
001CC9 E9E7 3232E9          13      LD  (FDCSMC),A
       E9EA                     DRDBL:
001CCC E9EA 78               4      LD  A,B
001CCD E9EB 3221EA          13      LD  (RDBSMC),A
001CD0 E9EE 3E02             7      LD  A,2     ;Retry count
001CD2 E9F0 3287E9          13      LD  (RETRY),A
       E9F3                     DRD0:
001CD5 E9F3 D5              11      PUSH    DE
001CD6 E9F4 E5              11      PUSH    HL
001CD7 E9F5 CDE8E8          17      CALL    SEEK        ;Read disk
001CDA E9F8 E1              10      POP HL
001CDB E9F9 382A            12      JR  C,ERRDR
001CDD E9FB F3               4      DI
001CDE E9FC CD66E9          17      CALL    SECSET_FDCCMD
       E9FF                     DRD1:
001CE1 E9FF DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001CE3 EA01 2F               4      CPL         ;データバスが負論理
001CE4 EA02 0F               4      RRCA
001CE5 EA03 300A            12      JR  NC,DRD3
001CE7 EA05 0F               4      RRCA
001CE8 EA06 30F7            12      JR  NC,DRD1
001CEA EA08 DBDB            11      IN  A,(0DBH)    ;MB8876 データレジスタ
001CEC EA0A 2F               4      CPL         ;データバスが負論理
001CED EA0B 77               7      LD  (HL),A
001CEE EA0C 23               6      INC HL
001CEF EA0D 18F0            12      JR  DRD1
                                
       EA0F                     DRD3:
001CF1 EA0F B7               4      OR  A
001CF2 EA10 FB               4      EI
001CF3 EA11 D1              10      POP DE
001CF4 EA12 13               6      INC DE
001CF5 EA13 CD60E9          17      CALL    FDMOFF
001CF8 EA16 2808            12      JR  Z,DISKOK_RD
001CFA EA18 CD2FEA          17      CALL    DISKC
001CFD EA1B 20D6            12      JR  NZ,DRD0
001CFF EA1D B7               4      OR  A
001D00 EA1E 20B4            12      JR  NZ,ERRW
                                
       EA20                     DISKOK_RD:
001D02 EA20 0601             7      LD  B,1
       EA21                     RDBSMC  EQU $-1
001D04 EA22 10C6            13      DJNZ    DRDBL
001D06 EA24 C9              10      RET
                                
       EA25                     ERRDR:
001D07 EA25 D1              10      POP DE
001D08 EA26 CD40EA          17      CALL    DELP
001D0B EA29 20C8            12      JR  NZ,DRD0
001D0D EA2B B7               4      OR  A
001D0E EA2C 20A6            12      JR  NZ,ERRW
001D10 EA2E C9              10      RET
       EA2F                     DISKC:
001D11 EA2F 1B               6      DEC DE
001D12 EA30 CB5F             8      BIT 3,A
001D14 EA32 C481E9          17      CALL    NZ,RNF
       EA35                     DISKD:
001D17 EA35 E5              11      PUSH    HL
001D18 EA36 2187E9          10      LD  HL,RETRY
001D1B EA39 35              11      DEC (HL)
001D1C EA3A E1              10      POP HL
001D1D EA3B 200C            12      JR  NZ,ERR      ;Retry
001D1F EA3D B7               4      OR  A
001D20 EA3E 2809            12      JR  Z,ERR       ;Error
                                
       EA40                     DELP:
001D22 EA40 CD81E9          17      CALL    RNF
001D25 EA43 CD60E9          17      CALL    FDMOFF
001D28 EA46 3EFF             7      LD  A,0FFH
       EA48                     AERRZ:
001D2A EA48 BF               4      CP  A
       EA49                     ERR:
001D2B EA49 3EFF             7      LD  A,0FFH
001D2D EA4B C9              10      RET
[EOF:M7DISK.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MZ-700/1500
                                
                                ;   EMM DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       EA4C                     EDWT:
001D2E EA4C F5              11      PUSH    AF
001D2F EA4D CD6BEA          17      CALL    EADR
001D32 EA50 0600             7      LD  B,0
       EA52                     EDWT1:
001D34 EA52 EDB3                    OTIR
001D36 EA54 3D               4      DEC A
001D37 EA55 20FB            12      JR  NZ,EDWT1
001D39 EA57 180B            12      JR  EDRW1
                                
       EA59                     EDRD:
001D3B EA59 C5              11      PUSH    BC
001D3C EA5A CD6BEA          17      CALL    EADR
001D3F EA5D 0600             7      LD  B,0
       EA5F                     EDRD1:
001D41 EA5F EDB2                    INIR
001D43 EA61 3D               4      DEC A
001D44 EA62 20FB            12      JR  NZ,EDRD1
       EA64                     EDRW1:
001D46 EA64 F1              10      POP AF
001D47 EA65 83               4      ADD A,E ;セクタを進める
001D48 EA66 5F               4      LD  E,A
001D49 EA67 8A               4      ADC A,D
001D4A EA68 93               4      SUB E
001D4B EA69 57               4      LD  D,A
001D4C EA6A C9              10      RET
                                
       EA6B                     EADR:
001D4D EA6B D5              11      PUSH    DE
001D4E EA6C EB               4      EX  DE,HL
001D4F EA6D 78               4      LD  A,B
001D50 EA6E DD460F          19      LD  B,(IX+DPB_BPS)
       EA71                     EADR1:              ;読み込むセクタ数と1クラスタのセクタ数を掛ける
001D53 EA71 CB18             8      RR  B
001D55 EA73 3804            12      JR  C,EADR2
001D57 EA75 87               4      ADD A,A
001D58 EA76 29              11      ADD HL,HL
001D59 EA77 18F8            12      JR  EADR1
       EA79                     EADR2:
001D5B EA79 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001D5E EA7C DD460C          19      LD  B,(IX+DPB_MAXCYL)
001D61 EA7F 09              11      ADD HL,BC
001D62 EA80 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D65 EA83 ED71            12      OUT (C),0       ;Z80未定義命令
001D67 EA85 0C               4      INC C
001D68 EA86 ED69            12      OUT (C),L
001D6A EA88 0C               4      INC C
001D6B EA89 ED61            12      OUT (C),H
001D6D EA8B 0C               4      INC C
001D6E EA8C EB               4      EX  DE,HL
001D6F EA8D D1              10      POP DE
001D70 EA8E C9              10      RET
                                
                                ;   CMOS BACKUP MEMORY DRIVER(32KB)
                                ;   1セクタ256
                                
       EA8F                     CDWT:
001D71 EA8F 78               4      LD  A,B
001D72 EA90 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D75 EA93 ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001D77 EA95 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001D79 EA97 01FA00          10      LD  BC,000FAH
       EA9A                     CDWT1:
001D7C EA9A EDB3                    OTIR            ;W)データ書き込み・アドレスカウンタ+1
001D7E EA9C 13               6      INC DE
001D7F EA9D 3D               4      DEC A
001D80 EA9E 20FA            12      JR  NZ,CDWT1
001D82 EAA0 A7               4      AND A
001D83 EAA1 C9              10      RET
                                
       EAA2                     CDRD:
001D84 EAA2 78               4      LD  A,B
001D85 EAA3 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D88 EAA6 ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001D8A EAA8 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001D8C EAAA 01F900          10      LD  BC,000F9H
       EAAD                     CDRD1:
001D8F EAAD EDB2                    INIR            ;R)データ読み出し・アドレスカウンタ+1
001D91 EAAF 13               6      INC DE
001D92 EAB0 3D               4      DEC A
001D93 EAB1 20FA            12      JR  NZ,CDRD1
001D95 EAB3 A7               4      AND A
001D96 EAB4 C9              10      RET
                                
                                ;   RAM DISK DRIVER (64KB)
                                ;   1セクタ256
                                
       EAB5                     RDWT:
001D97 EAB5 3EB3             7      LD  A,0B3H      ;OTIR
001D99 EAB7 1802            12      JR  RDRW
       EAB9                     RDRD:
001D9B EAB9 3EB2             7      LD  A,0B2H      ;INIR
       EABB                     RDRW:
001D9D EABB 32C8EA          13      LD  (RDRW_SWC),A
                                
001DA0 EABE 78               4      LD  A,B
001DA1 EABF 43               4      LD  B,E     ;B=アドレスカウンタ上位(X1の様な16bitのI/Oアクセス)
001DA2 EAC0 0EEB             7      LD  C,0EBH
001DA4 EAC2 ED71            12      OUT (C),0       ;0=アドレスカウンタ下位
001DA6 EAC4 0D               4      DEC C       ;EA(R)データ読み出し・アドレスカウンタ+1
001DA7 EAC5 0600             7      LD  B,0
       EAC7                     RDRW1:
001DA9 EAC7 EDB2                    INIR            ;自己書き換え(INIR/OTIR)
       EAC8                     RDRW_SWC    EQU $-1
001DAB EAC9 13               6      INC DE
001DAC EACA 3D               4      DEC A
001DAD EACB 20FA            12      JR  NZ,RDRW1
001DAF EACD A7               4      AND A
001DB0 EACE C9              10      RET
                                
                                ;   G-RAM(PCG) DISK DRIVER (24KB)
                                ;   1セクタ256
                                
       EACF                     GDWT:
001DB1 EACF C5              11      PUSH    BC
001DB2 EAD0 D5              11      PUSH    DE
001DB3 EAD1 CDF9EA          17      CALL    GADR
       EAD4                     GDWT2:
001DB6 EAD4 4E               7      LD  C,(HL)
001DB7 EAD5 23               6      INC HL
001DB8 EAD6 EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001DB9 EAD7 CDC0CF          17      CALL    WR_PCG
001DBC EADA 23               6      INC HL
001DBD EADB EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001DBE EADC 10F6            13      DJNZ    GDWT2
001DC0 EADE D1              10      POP DE
001DC1 EADF 1C               4      INC E
001DC2 EAE0 C1              10      POP BC
001DC3 EAE1 10EC            13      DJNZ    GDWT
001DC5 EAE3 C9              10      RET
       EAE4                     GDRD:
001DC6 EAE4 C5              11      PUSH    BC
001DC7 EAE5 D5              11      PUSH    DE
001DC8 EAE6 CDF9EA          17      CALL    GADR
       EAE9                     GDRD2:
001DCB EAE9 EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001DCC EAEA CDB8CF          17      CALL    RD_PCG
001DCF EAED 23               6      INC HL
001DD0 EAEE EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001DD1 EAEF 71               7      LD  (HL),C
001DD2 EAF0 23               6      INC HL
001DD3 EAF1 10F6            13      DJNZ    GDRD2
001DD5 EAF3 D1              10      POP DE
001DD6 EAF4 1C               4      INC E
001DD7 EAF5 C1              10      POP BC
001DD8 EAF6 10EC            13      DJNZ    GDRD
001DDA EAF8 C9              10      RET
                                
       EAF9                     GADR:
001DDB EAF9 7B               4      LD  A,E
001DDC EAFA E61F             7      AND 01FH
001DDE EAFC C6D0             7      ADD A,0D0H
001DE0 EAFE 57               4      LD  D,A
001DE1 EAFF 7B               4      LD  A,E
001DE2 EB00 07               4      RLCA
001DE3 EB01 07               4      RLCA
001DE4 EB02 07               4      RLCA
001DE5 EB03 3C               4      INC A
001DE6 EB04 0600             7      LD  B,0
001DE8 EB06 58               4      LD  E,B
001DE9 EB07 C9              10      RET
[EOF:M7DISK2.ASM:UTF_8]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001DEA EB08                     PATHD:  DS  PATHX
001E25 EB43 00                  PATHE:  DB  0
                                
       EB44                     DTA_CCP:
001E26 EB44                         DS  37
                                
       EB69                     FCB_BAT:
001E4B EB69                         DS  37
                                
001E70 EB8E 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001E7B EB99 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "M7TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE 表示関連のテーブル
                                ;   MZ-700/1500
                                
       EBA0                     AT_TABLE:
001E82 EBA0                         DS  TABLEAD-AT_TABLE
                                
       ED40                     KEY_TABLE:
002022 ED40 12081E1F1C1D5C2F        DB  12H,08H,1EH,1FH,1CH,1DH,5CH,'/'
00202A ED48 5C5E2D2030392C2E        DB  5CH,'^','-',20H,'0','9',',','.'
002032 ED50 3132333435363738        DB  '1','2','3','4','5','6','7','8'
00203A ED58 6162636465666768        DB  'a','b','c','d','e','f','g','h'
002042 ED60 696A6B6C6D6E6F70        DB  'i','j','k','l','m','n','o','p'
00204A ED68 7172737475767778        DB  'q','r','s','t','u','v','w','x'
002052 ED70 797A405B5D000000        DB  'y','z','@','[',']',00H,00H,00H
00205A ED78 001B3D09003B3A0D        DB  00H,1BH,'=',09H,00H,';',':',0DH
       ED80                     SHIFT_TABLE:
002062 ED80 12081E1F1C1D5F3F        DB  12H,08H,1EH,1FH,1CH,1DH,'_','?'
00206A ED88 7C7E3D2030293C3E        DB  '|','~','=',20H,'0',')','<','>'
002072 ED90 2122232425262728        DB  '!','"','#','$','%','&',27H,'('
00207A ED98 4142434445464748        DB  'A','B','C','D','E','F','G','H'
002082 EDA0 494A4B4C4D4E4F50        DB  'I','J','K','L','M','N','O','P'
00208A EDA8 5152535455565758        DB  'Q','R','S','T','U','V','W','X'
002092 EDB0 595A607B7D000000        DB  'Y','Z','`','{','}',00H,00H,00H
00209A EDB8 00003D09002B2A0D        DB  00H,00H,'=',09H,00H,'+','*',0DH
       EDC0                     CTRL_TABLE:
0020A2 EDC0 12081E1F1C1D3F2F        DB  12H,08H,1EH,1FH,1CH,1DH,'?','/'
0020AA EDC8 2A2B2D2030392C2E        DB  '*','+','-',20H,'0','9',',','.'
0020B2 EDD0 3132333435363738        DB  '1','2','3','4','5','6','7','8'
0020BA EDD8 0102030405060708        DB  01H,02H,03H,04H,05H,06H,07H,08H
0020C2 EDE0 090A0B0C0D0E0F10        DB  09H,0AH,0BH,0CH,0DH,0EH,0FH,10H
0020CA EDE8 1112131415161718        DB  11H,12H,13H,14H,15H,16H,17H,18H
0020D2 EDF0 191A1B5B5D000000        DB  19H,1AH,1BH,'[',']',00H,00H,00H
0020DA EDF8 00003D09003B3A0D        DB  00H,00H,'=',09H,00H,';',':',0DH
                                
                                ;   アドレス下位1バイトが0になるように
       EE00                     CD_TABLE:
0020E2 EE00 00D1D2D3D4D5D6D0        DB  $00,$D1,$D2,$D3,$D4,$D5,$D6,$D0 ;月火水木金土日
0020EA EE08 D8DCD9DADBD7CFCE        DB  $D8,$DC,$D9,$DA,$DB,$D7,$CF,$CE ;年円時分秒
0020F2 EE10 601F5F5E1E1B7978        DB  $60,$1F,$5F,$5E,$1E,$1B,$79,$78 ;
0020FA EE18 5C5D1C1D6DCACDC7        DB  $5C,$5D,$1C,$1D,$6D,$CA,$CD,$C7 ;
002102 EE20 0061626364656667        DB  $00,$61,$62,$63,$64,$65,$66,$67 ; !"#$%&'
00210A EE28 68696B6A2F2A2E2D        DB  $68,$69,$6B,$6A,$2F,$2A,$2E,$2D ;()*+,-./
002112 EE30 2021222324252627        DB  $20,$21,$22,$23,$24,$25,$26,$27 ;01234567
00211A EE38 28294F2C512B5749        DB  $28,$29,$4F,$2C,$51,$2B,$57,$49 ;89:;<=>?
002122 EE40 5501020304050607        DB  $55,$01,$02,$03,$04,$05,$06,$07 ;@ABCDEFG
00212A EE48 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;HIJKLMNO
002132 EE50 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;PQRSTUVW
00213A EE58 18191A52DD54E37C        DB  $18,$19,$1A,$52,$DD,$54,$E3,$7C ;XYZ[\]^_
002142 EE60 5901020304050607        DB  $59,$01,$02,$03,$04,$05,$06,$07 ;`abcdefg   ATB:1
00214A EE68 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;hijklmno   ATB:1
002152 EE70 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;pqrstuvw   ATB:1
00215A EE78 18191ACB35CC705A        DB  $18,$19,$1A,$CB,$35,$CC,$70,$5A ;xyz{|}~    ATB:1
002162 EE80 415346444847B49E        DB  $41,$53,$46,$44,$48,$47,$B4,$9E ;トランプ〇●をぁ   ATB:1
00216A EE88 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ぃぅぇぉゃゅょっ   ATB:1
002172 EE90 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーあいうえおかき   ATB:1
00217A EE98 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;くけこさしすせそ   ATB:1
002182 EEA0 F0BD9DB1B5B9B49E        DB  $F0,$BD,$9D,$B1,$B5,$B9,$B4,$9E ;　。「」、・ヲァ
00218A EEA8 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ィゥェォャョュッ
002192 EEB0 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーアイウエオカキ
00219A EEB8 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;クケコサシスセソ
0021A2 EEC0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;タチツテトナニヌ
0021AA EEC8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ネノハヒフヘホマ
0021B2 EED0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;ミムメモヤユヨラ
0021BA EED8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;リルレロワン゛゜
0021C2 EEE0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;たちつてとねにぬ   ATB:1
0021CA EEE8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ねのはひふへほま   ATB:1
0021D2 EEF0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;みむめもやゆよら   ATB:1
0021DA EEF8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;りるれろわん゛゜   ATB:1
       EF00                     DC_TABLE:
0021E2 EF00 2041424344454647        DB  $20,$41,$42,$43,$44,$45,$46,$47 ;0
0021EA EF08 48494A4B4C4D4E4F        DB  $48,$49,$4A,$4B,$4C,$4D,$4E,$4F
0021F2 EF10 5051525354555657        DB  $50,$51,$52,$53,$54,$55,$56,$57 ;1
0021FA EF18 58595A151A1B1411        DB  $58,$59,$5A,$15,$1A,$1B,$14,$11
002202 EF20 3031323334353637        DB  $30,$31,$32,$33,$34,$35,$36,$37 ;2
00220A EF28 38392D3D3B2F2E2C        DB  $38,$39,$2D,$3D,$3B,$2F,$2E,$2C
002212 EF30 00000000007C0000        DB  $00,$00,$00,$00,$00,$7C,$00,$00 ;3
00221A EF38 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
002222 EF40 0080000083008285        DB  $00,$80,$00,$00,$83,$00,$82,$85 ;4
00222A EF48 843F00000000003A        DB  $84,$3F,$00,$00,$00,$00,$00,$3A
002232 EF50 5E3C5B815D40003E        DB  $5E,$3C,$5B,$81,$5D,$40,$00,$3E ;5
00223A EF58 00607F0018191312        DB  $00,$60,$7F,$00,$18,$19,$13,$12
002242 EF60 1021222324252627        DB  $10,$21,$22,$23,$24,$25,$26,$27 ;6
00224A EF68 28292B2A001C0000        DB  $28,$29,$2B,$2A,$00,$1C,$00,$00
002252 EF70 7E00000000000000        DB  $7E,$00,$00,$00,$00,$00,$00,$00 ;7
00225A EF78 171600005F000000        DB  $17,$16,$00,$00,$5F,$00,$00,$00
002262 EF80 00C19A9F9C92CA97        DB  $00,$C1,$9A,$9F,$9C,$92,$CA,$97 ;8
00226A EF88 98C6CFC9D8D3D0D7        DB  $98,$C6,$CF,$C9,$D8,$D3,$D0,$D7
002272 EF90 9EC09DC496C5CBC3        DB  $9E,$C0,$9D,$C4,$96,$C5,$CB,$C3 ;9
00227A EF98 9BDDC2DB99A2878C        DB  $9B,$DD,$C2,$DB,$99,$A2,$87,$8C
002282 EFA0 DCC7CC91939495D4        DB  $DC,$C7,$CC,$91,$93,$94,$95,$D4 ;A
00228A EFA8 D5D6CECDDAD2D9C8        DB  $D5,$D6,$CE,$CD,$DA,$D2,$D9,$C8
002292 EFB0 D1A3888D86A4898E        DB  $D1,$A3,$88,$8D,$86,$A4,$89,$8E ;B
00229A EFB8 DFA58A8FDEA18B90        DB  $DF,$A5,$8A,$8F,$DE,$A1,$8B,$90
0022A2 EFC0 000000000000001F        DB  $00,$00,$00,$00,$00,$00,$00,$1F ;C
0022AA EFC8 00001D7B7D1E0F0E        DB  $00,$00,$1D,$7B,$7D,$1E,$0F,$0E
0022B2 EFD0 070102030405060D        DB  $07,$01,$02,$03,$04,$05,$06,$0D ;D
0022BA EFD8 080A0B0C095C0000        DB  $08,$0A,$0B,$0C,$09,$5C,$00,$00
0022C2 EFE0 0000005E00000000        DB  $00,$00,$00,$5E,$00,$00,$00,$00 ;E
0022CA EFE8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
0022D2 EFF0 A000000000000000        DB  $A0,$00,$00,$00,$00,$00,$00,$00 ;F
0022DA EFF8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
[EOF:M7TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
                                ;   ALIGN   256
       F000                     AT_WORK:
0022E2 F000                         DS  WORKAD-AT_WORK
                                
       F000                     CPM_BOOT:
0022E2 F000 C30000          10      JP  0
       F003                     _SYS00:     ;(BDOS)プログラム終了
       F003                     CPM_WBOOT:
0022E5 F003 C3FECF          10      JP  WBOOT1
       F006                     CPM_CONST:
0022E8 F006 C3ABD7          10      JP  CONSTX
       F009                     _SYS07:     ;(BDOS)コンソール直接入力
       F009                     CPM_CONIN:
0022EB F009 C344D7          10      JP  FLGET
       F00C                     CPM_CONOUT:
0022EE F00C C34FD9          10      JP  CONOUT1
                                
       F00F                     DECBF:              ;10進数表示時のバッファ(5バイト)
0022F1 F00F                         DS  5
       F00F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       F011                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       F014                     FDRV:
0022F6 F014 00                      DB  0
       F015                     FNAME:
0022F7 F015                         DS  36
       F039                     SFILE:
00231B F039                         DS  33      ;DRV FILENAME
       F05A                     _DISKE:
00233C F05A C30ED7          10      JP  SHOW_ERROR
                                
00233F F05D 0000                LEFTX:  DW  0
002341 F05F 0000                DTAX:   DW  0
                                
                                ;   PSGのビープ音のデータ(X1)
       F061                     BEEPD:
002343 F061 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
00234B F069 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                ;
       F062                     RTC_YY  EQU BEEPD+1 ;RTCのバッファ年(88)
       F063                     RTC_MW  EQU BEEPD+2 ;RTCのバッファ月(88)
       F064                     RTC_DD  EQU BEEPD+3 ;RTCのバッファ日(88)
       F065                     RTC_TT  EQU BEEPD+4 ;RTCのバッファ時(88)
       F066                     RTC_MM  EQU BEEPD+5 ;RTCのバッファ分(88)
       F067                     RTC_SS  EQU BEEPD+6 ;RTCのバッファ秒(88)
       F062                     ROM_SLT EQU BEEPD+1 ;ROMのスロット(MSX)
       F061                     ZERO    EQU BEEPD
                                
       F070                     CHECK:
002352 F070 00                      DB  0
                                
       F071                     OK:
002353 F071 4F4B24                  DB  "OK$"
002356 F074                         DS  5
       F079                     COMERM:
00235B F079 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       F080                     _CYL0:
002362 F080 FF                      DB  0FFH    ;Cylinder
       F081                     _CYL1:
002363 F081 FF                      DB  0FFH    ;Cylinder
       F082                     _CYL2:
002364 F082 FF                      DB  0FFH    ;Cylinder
       F083                     _CYL3:
002365 F083 FF                      DB  0FFH    ;Cylinder
       F084                     _DRIVE:
002366 F084 00                      DB  0   ;unit number
       F085                     _SEEKSP:
002367 F085 00                      DB  0   ;Seek speed
       F086                     _ISEEK:
002368 F086 32                      DB  50  ;
002369 F087                         DS  1
       F088                     _DRV:
00236A F088 00                      DB  0
       F089                     _DSK:
00236B F089 FF                      DB  0FFH
       F08A                     _DTA:
00236C F08A 8000                    DW  00080H
       F08C                     _CTC:
00236E F08C 0000                    DW  0
       F08E                     _TXADR:
002370 F08E 0000                    DW  0
       F090                     _KEYPS:
002372 F090 0000                    DW  0
       F092                     _KEYD:
002374 F092 00                      DB  000H    ;キーデータ
       F093                     _KEYST:
002375 F093 FF                      DB  0FFH    ;キーステータス(SHIFT,CTRLの状態)
       F094                     _KEYSP_L:
002376 F094 83                      DB  KEYSP_L ;オートリピートの速度
       F095                     _KEYSP_H:
002377 F095 14                      DB  KEYSP_H ;オートリピートの速度
       F096                     _COLORF:
002378 F096 70                      DB  COLORF  ;色
       F097                     _LINE:
002379 F097 19                      DB  LINE
                                
                                            ;次のファイルの検索(C=12)で使用するFCB
       F098                     _FCB:
00237A F098 0000                    DW  0   ;SEARCH FILES
       F09A                     _FBPS:
00237C F09A 0000                    DW  0   ;    //
       F09C                     _FBAD:
00237E F09C 0000                    DW  0   ;    //
       F09E                     _FBCNT:
002380 F09E 00                      DB  0   ;    //
       F09F                     _FILEN:
002381 F09F 00                      DB  0   ;    //
       F0A0                     _DIRF:
002382 F0A0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
002383 F0A1                         DS  1
       F0A2                     _WTFATF:
002384 F0A2 00                      DB  0   ;FATバッファの更新フラグ
002385 F0A3                         DS  1
       F0A4                     _WTDBF:
002386 F0A4 00                      DB  0   ;データバッファの更新フラグ
       F0A5                     _DBDRV:
002387 F0A5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       F0A6                     _DBSEC:
002388 F0A6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       F0A8                     _DPB:
00238A F0A8 0000                    DW  0
       F0AA                     _FATDRV:
00238C F0AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       F0AB                     _FATIX:
00238D F0AB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       F0AC                     _FAKEFREE:
00238E F0AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
002390 F0AE                         DS  2
                                ;   画面周りのデータ
       F0B0                     CRTCD:
002392 F0B0 6F                      DB  06FH
       F0B1                     _WIDTH:
002393 F0B1 28                      DB  WIDTH
       F0B2                     TVRAMTOP:
002394 F0B2 5938                    DB  059H,038H
002396 F0B4 1F02                    DB  01FH,002H
       F0B6                     _LINE2:
002398 F0B6 19                      DB  019H
       F0B7                     WKE4:
002399 F0B7 1C                      DB  01CH
       F0B8                     WKE6:
00239A F0B8 00                      DB  000H
       F0B9                     WK40:
00239B F0B9 07                      DB  007H
       F0BA                     _PAGE_MINUS:
00239C F0BA 18FC                    DW  0-WIDTH*LINE
       F0BC                     _WIDTH_MINUS:
00239E F0BC D8FF                    DW  0-WIDTH
       F0BE                     WK30:
0023A0 F0BE 0C                      DB  00CH
       F0BF                     WK31:
       F0BF                     WK1FD0:
0023A1 F0BF 20                      DB  020H
                                
                                ;   割り込みベクタ(X1)
0023A2 F0C0 0000                CTC0:   DW  INTCTCE
0023A4 F0C2 0000                CTC1:   DW  INTCTCE
0023A6 F0C4 0000                CTC2:   DW  INTCTCE
0023A8 F0C6 0000                CTC3:   DW  INTCTCE
0023AA F0C8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
0023AC F0CA C3B8DA          10  _INKEY: JP  INKEY
0023AF F0CD C336D8          10  _PRINT: JP  PRINT
0023B2 F0D0 C343DB          10  _SCRN:  JP  SCRN
0023B5 F0D3 C309DA          10  _POS:   JP  POS
0023B8 F0D6 C31DD9          10  _LOC:   JP  LOC
       F0D9                     _CHGDRV:
0023BB F0D9 C3F1E7          10      JP  CHGDRV
       F0DC                     _GETDPB:
0023BE F0DC C3AFE8          10      JP  GETDPB
       F0DF                     _FFLUSH:
0023C1 F0DF C3CDE8          10      JP  FFLUSH
       F0E2                     _RDFATX:
0023C4 F0E2 C3C9E4          10      JP  RDFATX
0023C7 F0E5 C3FBE5          10  _RDFAT: JP  RDFAT
0023CA F0E8 C388E9          10  _WTTRK: JP  WTTRK
0023CD F0EB C3E5E9          10  _FDRD:  JP  FDRD
0023D0 F0EE C38EE9          10  _FDWT:  JP  FDWT
       F0F1                     _BPB2DPB:
0023D3 F0F1 C393E6          10      JP  BPB2DPB
       F0F4                     _BREAK:
0023D6 F0F4 C393D1          10      JP  END_BATCH
       F0F7                     _GNCL:
0023D9 F0F7 C375E5          10      JP  GNCL        ; self-modifying code
       F0F8                     GNCPAT  EQU $-2
       F0FA                     _SNCL:
0023DC F0FA C398E5          10      JP  SNCL        ; self-modifying code
       F0FB                     SNCPAT  EQU $-2
       F0FD                     _COMANL:
0023DF F0FD C34CD0          10      JP  COMANL
                                
       F100                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F100                     STABLE:
                                ;0
0023E2 F100 03F01BD727D733DD        DW  _SYS00,_SYS01,_SYS02,_SYS03
0023EA F108 79D479D42CD709F0        DW  _SYS04,_SYS05,_SYS06,_SYS07
0023F2 F110 34D77BD47AD7A6D7        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
0023FA F118 90D495D4A4D4B5D4        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
002402 F120 09D550D599D5CAD5        DW  _SYS10,_SYS11,_SYS12,_SYS13
00240A F128 D2D5E8D5FDD5F5D5        DW  _SYS14,_SYS15,_SYS16,_SYS17
002412 F130 44D649D64ED654D6        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
00241A F138 79D47AD679D47ED6        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
002422 F140 79D434D63CD685D6        DW  _SYS20,_SYS21,_SYS22,_SYS23
00242A F148 AAD679D489E157E2        DW  _SYS24,_ERROR,_SYS26,_SYS27
002432 F150 3CD6B4D6B9D733DD        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
00243A F158 B9D733DD79D4D5D6        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
002442 F160 CFD679D479D479D4        DW  _SYS30,_ERROR,_ERROR,_ERROR
00244A F168 79D479D479D479D4        DW  _ERROR,_ERROR,_ERROR,_ERROR
002452 F170 79D433DD33DDF6D6        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
00245A F178 5DD4                    DW  _DOS2
                                
00245C F17A                         DS  1
       F17B                     _MAX_SEC_SZ_H:
00245D F17B 04                      DB  MAX_SEC_SZ_H
                                
                                ;   FATバッファのアドレス
       F17C                     _FATBF:
00245E F17C 30F3                    DW  FATBF
                                
                                ;   データバッファのアドレス
       F17E                     _DTBUF:
002460 F17E 30FB                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F180                     CTRLTB:
002462 F180 9BD89BD8D1D8DCD9        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
00246A F188 D6D902D9C6D95FD9        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002472 F190 A7D8C2D8DFD930D9        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
00247A F198 C3D918D9F1D99BD8        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
002482 F1A0 9BD89BD828D99BD8        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
00248A F1A8 9BD89BD89BD89BD8        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
002492 F1B0 9BD89BD8C3D937D9        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
00249A F1B8 8AD8AED8B7D8DFD9        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
                                ;   2D/2DDでBPBがない場合のデフォルト値(2D/360KB/9セクタ1024バイト)
0024A2 F1C0 0200                M2D:    DW  2
0024A4 F1C2 FD02                    DB  0FDH,2
0024A6 F1C4 6401                    DW  356
0024A8 F1C6 FF0728090182            DB  0FFH,7,40,9,1,082H
0024AE F1CC 0500A7000800            DW  5,0A7H,8
                                
                                ;   2HDでBPBがない場合のデフォルト値(2HD/1.23MB/8セクタ1024バイト)
0024B4 F1D2 0200                M2HD:   DW  2
0024B6 F1D4 FE01                    DB  0FEH,1
0024B8 F1D6 C704                    DW  1223
0024BA F1D8 FE064D080184            DB  0FEH,6,77,8,1,084H
0024C0 F1DE 0500A7000900            DW  5,0A7H,9
                                
                                ;   ディレクトリエントリとFCBの変換テーブル(日付+時刻+サイズ)
0024C6 F1E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
0024C8 F1E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
0024CA F1E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
0024CC F1EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F1EE                     SDDATAE:
                                
0024D0 F1EE                         DS  2
                                
                                ;   バッチファイルのFCB
       F1F0                     _FCB_BAT:
0024D2 F1F0 69EB                    DW  FCB_BAT
       F1F2                     _PATH:
0024D4 F1F2 08EB                    DW  PATHD
                                
0024D6 F1F4                     SCDIR:  DS  2       ;+14 +15
0024D8 F1F6                     SFBPS:  DS  2       ;FBPS
0024DA F1F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
0024DC F1FA 0000                _FATPS: DW  0
0024DE F1FC 0000                _DIRPS: DW  0
0024E0 F1FE 0000                _CLPS:  DW  0
                                
       F200                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "M7DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MZ-700/1500
                                
       F200                     _DEVICE:
                                
                                ;   A:
                                
0024E2 F200 0200                    DW  2   ;DPB_FATLN
0024E4 F202 EBF0                    DW  _FDRD   ;DPB_DRD
0024E6 F204 EEF0                    DW  _FDWT   ;DPB_DWT
0024E8 F206 FD                      DB  0FDH    ;DPB_FATID
0024E9 F207 02                      DB  2   ;DPB_SECPCL
0024EA F208 6401                    DW  356 ;DPB_MAXCL
0024EC F20A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
0024ED F20B 07                      DB  7   ;DPB_DIRSCNT
0024EE F20C 28                      DB  40  ;DPB_MAXCYL
0024EF F20D 09                      DB  9   ;DPB_MAXSEC Number of sectors
0024F0 F20E 01                      DB  1   ;DPB_FATPS
0024F1 F20F 82                      DB  082H    ;DPB_BPS
0024F2 F210 0500                    DW  5   ;DPB_DIRPS
0024F4 F212 27                      DB  027H    ;DPB_DEVICE Device Number
0024F5 F213 00                      DB  0   ;DPB_UNITNO
0024F6 F214 0800                    DW  8   ;DPB_ADDCL
0024F8 F216 0000                    DW  0   ;DPB_16
0024FA F218 0000                    DW  0   ;DPB_18
0024FC F21A 0000                    DW  0   ;DPB_SDIR
0024FE F21C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002502 F220 0200                    DW  2   ;DPB_FATLN
002504 F222 EBF0                    DW  _FDRD   ;DPB_DRD
002506 F224 EEF0                    DW  _FDWT   ;DPB_DWT
002508 F226 FD                      DB  0FDH    ;DPB_FATID
002509 F227 02                      DB  2   ;DPB_SECPCL
00250A F228 6401                    DW  356 ;DPB_MAXCL
00250C F22A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
00250D F22B 07                      DB  7   ;DPB_DIRSCNT
00250E F22C 28                      DB  40  ;DPB_MAXCYL
00250F F22D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002510 F22E 01                      DB  1   ;DPB_FATPS
002511 F22F 82                      DB  082H    ;DPB_BPS
002512 F230 0500                    DW  5   ;DPB_DIRPS
002514 F232 27                      DB  027H    ;DPB_DEVICE Device Number
002515 F233 01                      DB  1   ;DPB_UNITNO
002516 F234 0800                    DW  8   ;DPB_ADDCL
002518 F236 0000                    DW  0   ;DPB_16
00251A F238 0000                    DW  0   ;DPB_18
00251C F23A 0000                    DW  0   ;DPB_SDIR
00251E F23C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002522 F240 0100                    DW  1   ;DPB_FATLN
002524 F242 A2EA                    DW  CDRD    ;DPB_DRD
002526 F244 8FEA                    DW  CDWT    ;DPB_DWT
002528 F246 FA                      DB  0FAH    ;DPB_FATID
002529 F247 01                      DB  1   ;DPB_SECPCL
00252A F248 7A00                    DW  122 ;DPB_MAXCL
00252C F24A 00                      DB  0   ;DPB_FDMODE
00252D F24B 06                      DB  6   ;DPB_DIRSCNT
00252E F24C 00                      DB  0   ;DPB_MAXCYL
00252F F24D 00                      DB  0   ;DPB_MAXSEC
002530 F24E 01                      DB  1   ;DPB_FATPS
002531 F24F 01                      DB  1   ;DPB_BPS
002532 F250 0200                    DW  2   ;DPB_DIRPS
002534 F252 0C                      DB  00CH    ;DPB_DEVICE
002535 F253 F8                      DB  0F8H    ;DPB_UNITNO
002536 F254 0600                    DW  6   ;DPB_ADDCL
002538 F256 0000                    DW  0   ;DPB_16
00253A F258 0000                    DW  0   ;DPB_18
00253C F25A 0000                    DW  0   ;DPB_SDIR
00253E F25C 434D4F53                DB  "CMOS"  ;DPB_NAME
                                
                                ;   D:
                                
002542 F260                         DS  32
                                
                                ;   E:
                                
       F280                     EMMFL:
002562 F280 0000                    DW  0   ;DPB_FATLN
002564 F282 59EA                    DW  EDRD    ;DPB_DRD
002566 F284 4CEA                    DW  EDWT    ;DPB_DWT
002568 F286 FA                      DB  0FAH    ;DPB_FATID
002569 F287 02                      DB  2   ;DPB_SECPCL
00256A F288 0000                    DW  0   ;DPB_MAXCL
00256C F28A 00                      DB  0   ;DPB_FDMODE
00256D F28B 10                      DB  16  ;DPB_DIRSCNT
00256E F28C 00                      DB  0   ;DPB_MAXCYL
00256F F28D 00                      DB  0   ;DPB_MAXSEC
002570 F28E 01                      DB  1   ;DPB_FATPS
002571 F28F 01                      DB  1   ;DPB_BPS
002572 F290 0000                    DW  0   ;DPB_DIRPS
002574 F292 26                      DB  026H    ;DPB_DEVICE
002575 F293 00                      DB  0   ;DPB_UNITNO
002576 F294 0000                    DW  0   ;DPB_ADDCL
002578 F296 0000                    DW  0   ;DPB_16
00257A F298 0000                    DW  0   ;DPB_18
00257C F29A 0000                    DW  0   ;DPB_SDIR
00257E F29C 454D4D30                DB  "EMM0"  ;DPB_NAME
                                
                                ;   F:
                                
002582 F2A0 0200                    DW  2   ;DPB_FATLN
002584 F2A2 B9EA                    DW  RDRD    ;DPB_DRD
002586 F2A4 B5EA                    DW  RDWT    ;DPB_DWT
002588 F2A6 FA                      DB  0FAH    ;DPB_FATID
002589 F2A7 01                      DB  1   ;DPB_SECPCL
00258A F2A8 F600                    DW  246 ;DPB_MAXCL
00258C F2AA 00                      DB  0   ;DPB_FDMODE
00258D F2AB 09                      DB  9   ;DPB_DIRSCNT
00258E F2AC 00                      DB  0   ;DPB_MAXCYL
00258F F2AD 00                      DB  0   ;DPB_MAXSEC
002590 F2AE 01                      DB  1   ;DPB_FATPS
002591 F2AF 01                      DB  1   ;DPB_BPS
002592 F2B0 0300                    DW  3   ;DPB_DIRPS
002594 F2B2 0F                      DB  00FH    ;DPB_DEVICE
002595 F2B3 00                      DB  0   ;DPB_UNITNO
002596 F2B4 0A00                    DW  10  ;DPB_ADDCL
002598 F2B6 0000                    DW  0   ;DPB_16
00259A F2B8 0000                    DW  0   ;DPB_18
00259C F2BA 0000                    DW  0   ;DPB_SDIR
00259E F2BC 52414D46                DB  "RAMF"  ;DPB_NAME
                                
                                ;   G:
       F2C0                     GRAMFL:
0025A2 F2C0 0100                    DW  1   ;DPB_FATLN
0025A4 F2C2 E4EA                    DW  GDRD    ;DPB_DRD
0025A6 F2C4 CFEA                    DW  GDWT    ;DPB_DWT
0025A8 F2C6 FA                      DB  0FAH    ;DPB_FATID
0025A9 F2C7 01                      DB  1   ;DPB_SECPCL
0025AA F2C8 5A00                    DW  90  ;DPB_MAXCL
0025AC F2CA 00                      DB  0   ;DPB_FDMODE
0025AD F2CB 06                      DB  6   ;DPB_DIRSCNT
0025AE F2CC 00                      DB  0   ;DPB_MAXCYL
0025AF F2CD 00                      DB  0   ;DPB_MAXSEC
0025B0 F2CE 01                      DB  1   ;DPB_FATPS
0025B1 F2CF 01                      DB  1   ;DPB_BPS
0025B2 F2D0 0200                    DW  2   ;DPB_DIRPS
0025B4 F2D2 05                      DB  005H    ;DPB_DEVICE
0025B5 F2D3 F8                      DB  0F8H    ;DPB_UNITNO
0025B6 F2D4 0600                    DW  6   ;DPB_ADDCL
0025B8 F2D6 0000                    DW  0   ;DPB_16
0025BA F2D8 0000                    DW  0   ;DPB_18
0025BC F2DA 0000                    DW  0   ;DPB_SDIR
0025BE F2DC 4752414D                DB  "GRAM"  ;DPB_NAME
                                
                                ;   H:
0025C2 F2E0                         DS  3
0025C5 F2E3 00                      DB  0
[EOF:M7DPB.ASM:UTF_8]
                                
       A5C6                     LAST_ADR    EQU $$+OFFSET
                                
                                    END
[EOF:M7.ASM:UTF_8]
