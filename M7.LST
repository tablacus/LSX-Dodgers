                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.21.0, LST:Full:4
                                ;   LSX-Dodgers for MZ-700/1500
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "M7DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MZ-700/1500
                                
       0001                     MAC EQU 1   ;MZ-700/1500
       0000                     DEV EQU 0
                                
       011D                     VER_6F  EQU 0011DH
                                
       8080                     RUN EQU 08080H
       8000                     OFFSET  EQU RUN-128
       CF06                     BDOS    EQU 0CF06H
       F000                     WORKAD  EQU 0F000H
       ED40                     TABLEAD EQU 0ED40H
       F300                     KEYBF   EQU 0F300H
       F330                     FATBF   EQU 0F330H
       FB30                     DTBUF   EQU 0FB30H
       FF30                     KBUF    EQU 0FF30H
       FFD9                     TRAP38  EQU 0FFD9H
       0028                     WIDTH   EQU 40
       0019                     LINE    EQU 25
       0070                     COLORF  EQU 070H
       0014                     KEYSP_H EQU 20
       0083                     KEYSP_L EQU 131
       0009                     COMS    EQU 9
       0004                     MAX_SEC_SZ_H    EQU 4       ;1セクタ1024バイトのサポート(2:off 4:on)
       0100                     BUFFER  EQU 00100H
       D0E1                     S27BUF_COM  EQU S27BUF
[EOF:M7DEF.ASM:SHIFT_JIS]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0006                     VER_2   EQU 6
       0001                     VER_3   EQU 1
       1D01                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0001                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0161                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0004                     _DVSW   EQU 00004H
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       F323                     DISKVE  EQU 0F323H
       F325                     BREAKV  EQU 0F325H
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 8000                         ORG OFFSET
                                                    ;MZTヘッダ128バイト
000000 8000 01                      DB  1           ;ファイルモード
000001 8001 4C44202020202020        DB  "LD           "     ;ファイル名(13)
            2020202020          
00000E 800E 535953                  DB  "SYS"           ;拡張子(3)
000011 8011 0D                      DB  $0D
000012 8012 4625                    DW  LAST_ADR-RUN        ;サイズ
000014 8014 8080                    DW  RUN         ;開始アドレス
000016 8016 8080                    DW  RUN         ;実行アドレス
000018 8018                         DS  104
                                
                                    INCLUDE "M7INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   MZ-700/1500
                                
000080 8080 C38780          10      JP  START
000083 8083 011D                    DW  MACW
000085 8085 6101                    DW  VER
                                
       8087                     START:
000087 8087 F3               4      DI
000088 8088 ED56             8      IM  1
00008A 808A 318780          10      LD  SP,START
00008D 808D CD9B80          17      CALL    INIT        ;NZならAUTOEXECを実行
000090 8090 210000          10      LD  HL,0
000093 8093 E5              11      PUSH    HL
000094 8094 C8              11      RET Z
000095 8095 118081          10      LD  DE,AUTOD
000098 8098 C3FDF0          10      JP  _COMANL
                                
       809B                     INIT:
00009B 809B D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFFH)
00009D 809D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00009F 809F 21E881          10      LD  HL,INITE
0000A2 80A2 1106CF          10      LD  DE,BDOS
0000A5 80A5 01DE23          10      LD  BC,LAST_ADR-INITE
0000A8 80A8 EDB0                    LDIR
0000AA 80AA 21B781          10      LD  HL,M7BEEPD
0000AD 80AD 1162F0          10      LD  DE,BEEPD+1
0000B0 80B0 010A00          10      LD  BC,M7BEEPE-M7BEEPD
0000B3 80B3 EDB0                    LDIR
                                
0000B5 80B5 210000          10      LD  HL,0
0000B8 80B8 065C             7      LD  B,05CH
0000BA 80BA 3E                      DB  03EH    ;LD A,??
0000BB 80BB EF              12      RST 28H
0000BC 80BC CD35DC          17      CALL    FILL_MEMORY
0000BF 80BF 06A4             7      LD  B,0A4H
0000C1 80C1 AF               4      XOR A
0000C2 80C2 320400          13      LD  (_DVSW),A
0000C5 80C5 CD35DC          17      CALL    FILL_MEMORY
                                
0000C8 80C8 3EC3             7      LD  A,0C3H      ;JP
0000CA 80CA 2103F0          10      LD  HL,CPM_WBOOT
0000CD 80CD 320000          13      LD  (00000H),A
0000D0 80D0 220100          16      LD  (00001H),HL ;IPL
                                
0000D3 80D3 2106CF          10      LD  HL,BDOS
0000D6 80D6 320500          13      LD  (00005H),A
0000D9 80D9 220600          16      LD  (00006H),HL ;BDOS
                                
0000DC 80DC 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000DF 80DF 322800          13      LD  (00028H),A
0000E2 80E2 222900          16      LD  (00029H),HL ;RST 028H
                                
0000E5 80E5 323800          13      LD  (00038H),A
0000E8 80E8 211ACF          10      LD  HL,IO_INT8253
0000EB 80EB 223900          16      LD  (00039H),HL
                                
0000EE 80EE 215BF0          10      LD  HL,_DISKE+1
0000F1 80F1 2223F3          16      LD  (DISKVE),HL
0000F4 80F4 21F5F0          10      LD  HL,_BREAK+1
0000F7 80F7 2225F3          16      LD  (BREAKV),HL
                                
0000FA 80FA 3EF0             7      LD  A,CPM_BOOT/256
0000FC 80FC 320B00          13      LD  (0000BH),A
                                
0000FF 80FF 3EE9             7      LD  A,0E9H      ;JP (HL)
000101 8101 320F00          13      LD  (0000FH),A
                                                ;CHECK PCG(MZ-1500)
000104 8104 2100E8          10      LD  HL,0E800H
000107 8107 46               7      LD  B,(HL)
000108 8108 F3               4      DI
000109 8109 3E01             7      LD  A,1
00010B 810B D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00010D 810D 4E               7      LD  C,(HL)
00010E 810E 79               4      LD  A,C
00010F 810F C6A5             7      ADD A,0A5H
000111 8111 5F               4      LD  E,A
000112 8112 73               7      LD  (HL),E
000113 8113 D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
000115 8115 71               7      LD  (HL),C
000116 8116 3E01             7      LD  A,1
000118 8118 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00011A 811A 7E               7      LD  A,(HL)
00011B 811B BB               4      CP  E
00011C 811C D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
00011E 811E 70               7      LD  (HL),B
00011F 811F FB               4      EI
000120 8120 2804            12      JR  Z,MZ1500
000122 8122 AF               4      XOR A       ;MZ-700はPCGバンクが存在しない
000123 8123 32C0F2          13      LD  (GRAMFL),A
       8126                     MZ1500:
000126 8126 DD2180F2        14      LD  IX,EMMFL
00012A 812A CD7581          17      CALL    CHECK_EMM_BPB
00012D 812D FEEB             7      CP  0EBH
00012F 812F 2817            12      JR  Z,EMM_BPB
000131 8131 DD360D02        19      LD  (IX+DPB_MAXSEC),2   ;BPBが512バイト目から始まる場合を調べる
000135 8135 CD7581          17      CALL    CHECK_EMM_BPB
000138 8138 DDBE06          19      CP  (IX+DPB_FATID)
00013B 813B 200B            12      JR  NZ,EMM_BPB
00013D 813D DD360D00        19      LD  (IX+DPB_MAXSEC),0   ;BPBが先頭の場合に戻す
                                
000141 8141 2103E0          10      LD  HL,0E003H       ;SOUND MASK (MZ-1500)
000144 8144 AF               4      XOR A
000145 8145 CD2DCF          17      CALL    WRMMIO
       8148                     EMM_BPB:
000148 8148 218C81          10      LD  HL,INIMES
00014B 814B CD85D4          17      CALL    MSX
       814E                     INIT1:
00014E 814E F3               4      DI
00014F 814F 1100FF          10      LD  DE,0FF00H
000152 8152 0600             7      LD  B,0
000154 8154 CD23D3          17      CALL    ZERO_MEMORY_DE
000157 8157 21CAFF          10      LD  HL,EXTBIO
00015A 815A 36C9            10      LD  (HL),0C9H   ;RET
00015C 815C 23               6      INC HL
00015D 815D 060E             7      LD  B,TRAP38-EXTBIO-1
00015F 815F 3E                      DB  03EH    ;LD A,??
000160 8160 EF              12      RST 28H
000161 8161 CD35DC          17      CALL    FILL_MEMORY
000164 8164 21C181          10      LD  HL,AT_TRAP38
000167 8167 11D9FF          10      LD  DE,TRAP38
00016A 816A 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
00016D 816D EDB0                    LDIR
                                
00016F 816F CDE8DA          17      CALL    CHKEY
000172 8172 FE03             7      CP  3
000174 8174 C9              10      RET
                                
       8175                     CHECK_EMM_BPB:
000175 8175 D5              11      PUSH    DE
000176 8176 110000          10      LD  DE,0
000179 8179 CD5FEA          17      CALL    EADR
00017C 817C D1              10      POP DE
00017D 817D ED78            12      IN  A,(C)
00017F 817F C9              10      RET
                                
000180 8180 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000189 8189 413A00              AUTODV: DB  "A:",0
                                
00018C 818C 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MZ-700/1500 v"
            6765727320666F72    
            204D5A2D3730302F    
            313530302076        
0001AA 81AA 312E                    DB  030H + VER_1, '.'
0001AC 81AC 3631                    DB  030H + VER_2 ,030H + VER_3
0001AE 81AE 68                      DB  'h'
0001AF 81AF 2047616B750D0A          DB  " Gaku",0DH,0AH
0001B6 81B6 00                      DB  0
                                
       81B7                     M7BEEPD:
0001B7 81B7 0801                    DB  8,1
0001B9 81B9 0736                    DB  7,036H
0001BB 81BB 04F9                    DB  4,0F9H
0001BD 81BD 0403                    DB  4,3
0001BF 81BF 0301                    DB  3,1         ;SOUND MASK(MZ-1500)
       81C1                     M7BEEPE:
                                
       81C1                     AT_TRAP38:
0001C1 FFD9                         ORG TRAP38,AT_TRAP38-OFFSET
0001C1 FFD9 210000          10      LD  HL,0
0001C4 FFDC E3              19      EX  (SP),HL
0001C5 FFDD 3E24             7      LD  A,'$'
0001C7 FFDF CD19D7          17      CALL    MSG_A
0001CA FFE2 2B               6      DEC HL
0001CB FFE3 7C               4      LD  A,H
0001CC FFE4 CDE8FF          17      CALL    PRHX
0001CF FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
0001D0 FFE8 F5              11      PUSH    AF
0001D1 FFE9 07               4      RLCA
0001D2 FFEA 07               4      RLCA
0001D3 FFEB 07               4      RLCA
0001D4 FFEC 07               4      RLCA
0001D5 FFED CDF1FF          17      CALL    PRHX2
0001D8 FFF0 F1              10      POP AF
       FFF1                     PRHX2:
0001D9 FFF1 E60F             7      AND 00FH
0001DB FFF3 FE0A             7      CP  10
0001DD FFF5 3F               4      CCF
0001DE FFF6 CE30             7      ADC A,'0'
0001E0 FFF8 27               4      DAA
0001E1 FFF9 C319D7          10      JP  MSG_A
0001E4 FFFC                         DS  4
0001E8 81E8                         ORG $$+OFFSET,$$    ;$DEPHASE
       81E8                     AT_TRAPE:
                                
       81E8                     INITE:
0001E8 CF06                         ORG BDOS,INITE-OFFSET
                                
0001E8 CF06 C309CF          10      JP  IO_BDOS
[EOF:M7INIT.ASM:SHIFT_JIS]
                                    INCLUDE "M7BANK.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                ;   VRAM/KEY/TIMER(0D000H-0EFFFH)にアクセスするので0D000H-0FFFFHに置けない部分
                                ;
                                
       CF09                     IO_BDOS:
0001EB CF09 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001ED CF0B C345D4          10      JP  BDOS0
                                
                                #IF EXISTS USE_8253
                                IO_INT8253:
                                    PUSH    AF
                                    LD  A,(EXTBIO)
                                    LD  (INTMEM_SWC),A
                                    OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
                                    LD  A,1
                                    LD  (0E006H),A  ;8253 Ch.2 カウンタ
                                    XOR A
                                    LD  (0E006H),A  ;8253 Ch.2 カウンタ
                                    OUT (0E1H),A    ;DRAM(D000H-FFFFH)
                                    JP  INT8253
                                ROM8253E:
                                    OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
                                    POP AF
                                    RET
                                
                                INITINT:
                                    OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
                                    LD  HL,0E007H   ;HL=0E007H 8253 コントロール
                                    LD  (HL),0B0H   ;Ch.2 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 0 16ビットバイナリ
                                    LD  (HL),074H   ;Ch.1 カウンタの下位バイト→上位バイトの順に連続してアクセス Mode 2 16ビットバイナリ
                                    DEC L       ;0E006H 8253 Ch.2 カウンタ
                                    LD  (HL),2
                                    LD  (HL),0
                                    DEC L       ;0E005H 8253 Ch.1 カウンタ
                                    LD  (HL),A
                                    LD  (HL),0
                                    LD  A,L     ;L=5
                                    LD  (0E003H),A  ;8255 コントロールポートでポートC(0E002H)のINTMSKを1にする
                                    OUT (0E1H),A    ;DRAM(D000H-FFFFH)
                                    RET
                                #ENDIF
                                
       CF0E                     RDKEYDATA:
0001F0 CF0E F3               4      DI
0001F1 CF0F D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001F3 CF11 3200E0          13      LD  (0E000H),A
0001F6 CF14 3A01E0          13      LD  A,(E001H)
0001F9 CF17 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001FB CF19 FB               4      EI
                                #IF EXISTS USE_8253
                                #ELSE
       CF1A                     IO_INT8253:
                                #ENDIF
0001FC CF1A C9              10      RET
                                
       CF1B                     RD556VSYNC:
0001FD CF1B F3               4      DI
0001FE CF1C D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000200 CF1E 3A02E0          13      LD  A,(0E002H)
000203 CF21 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000205 CF23 FB               4      EI
000206 CF24 C9              10      RET
                                
       CF25                     RDMMIO:
000207 CF25 F3               4      DI
000208 CF26 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00020A CF28 7E               7      LD  A,(HL)
00020B CF29 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00020D CF2B FB               4      EI
00020E CF2C C9              10      RET
                                
       CF2D                     WRMMIO:
00020F CF2D F3               4      DI
000210 CF2E D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000212 CF30 77               7      LD  (HL),A
000213 CF31 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000215 CF33 FB               4      EI
000216 CF34 C9              10      RET
                                
       CF35                     RDMMIO_BC:
000217 CF35 F3               4      DI
000218 CF36 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00021A CF38 0A               7      LD  A,(BC)
00021B CF39 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00021D CF3B FB               4      EI
00021E CF3C C9              10      RET
                                
       CF3D                     WRMMIO_BC:
00021F CF3D F3               4      DI
000220 CF3E D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000222 CF40 02               7      LD  (BC),A
000223 CF41 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000225 CF43 FB               4      EI
000226 CF44 C9              10      RET
                                
       CF45                     IO_PRINT:
000227 CF45 F3               4      DI
000228 CF46 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00022A CF48 77               7      LD  (HL),A
00022B CF49 CBDC             8      SET 3,H
00022D CF4B 71               7      LD  (HL),C
00022E CF4C D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000230 CF4E FB               4      EI
000231 CF4F C9              10      RET
                                
       CF50                     IO_CLR:
000232 CF50 F3               4      DI
000233 CF51 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF53                     C1AX1:
000235 CF53 7A               4      LD  A,D
000236 CF54 C6D0             7      ADD A,0D0H
000238 CF56 57               4      LD  D,A
000239 CF57 AF               4      XOR A
00023A CF58 12               7      LD  (DE),A      ;Text
00023B CF59 CBDA             8      SET 3,D
       CF5C                     ICSMC   EQU $+1
00023D CF5B 3E00             7      LD  A,0     ;自己書き換え
00023F CF5D 12               7      LD  (DE),A      ;Color
000240 CF5E 13               6      INC DE
000241 CF5F 7A               4      LD  A,D
000242 CF60 D6D8             7      SUB 0D8H
000244 CF62 57               4      LD  D,A
000245 CF63 2118FC          10      LD  HL,0-WIDTH*LINE
000248 CF66 19              11      ADD HL,DE
000249 CF67 30EA            12      JR  NC,C1AX1
00024B CF69 E1              10      POP HL
00024C CF6A D1              10      POP DE
00024D CF6B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00024F CF6D FB               4      EI
000250 CF6E C9              10      RET
                                
       CF6F                     IO_CLLINE:
000251 CF6F F3               4      DI
000252 CF70 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF72                     CLLINE1:
000254 CF72 CB9C             8      RES 3,H
000256 CF74 77               7      LD  (HL),A      ;Text
000257 CF75 CBDC             8      SET 3,H
000259 CF77 71               7      LD  (HL),C      ;Color
00025A CF78 23               6      INC HL
00025B CF79 10F7            13      DJNZ    CLLINE1
00025D CF7B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00025F CF7D FB               4      EI
000260 CF7E C9              10      RET
                                
       CF7F                     IO_INSBS:
000261 CF7F F3               4      DI
000262 CF80 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF82                     IO_INSBS1:
000264 CF82 CB9C             8      RES 3,H
000266 CF84 5E               7      LD  E,(HL)
000267 CF85 77               7      LD  (HL),A
000268 CF86 7B               4      LD  A,E
000269 CF87 CBDC             8      SET 3,H
00026B CF89 5E               7      LD  E,(HL)
00026C CF8A 71               7      LD  (HL),C
00026D CF8B 4B               4      LD  C,E
       CF8C                     IO_INCDEC   EQU $   ; 自己書き換え
00026E CF8C 23               6      INC HL      ;INS->INC HL or BS->DEC HL
00026F CF8D 10F3            13      DJNZ    IO_INSBS1
000271 CF8F D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000273 CF91 FB               4      EI
000274 CF92 C9              10      RET
                                
       CF93                     IO_SCRUP:
000275 CF93 F3               4      DI
000276 CF94 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF96                     SCRUP1:
000278 CF96 2815            12      JR  Z,SCRCL
00027A CF98 D5              11      PUSH    DE
00027B CF99 E5              11      PUSH    HL
00027C CF9A CBDA             8      SET 3,D
00027E CF9C CBDC             8      SET 3,H
000280 CF9E 012800          10      LD  BC,WIDTH
000283 CFA1 EDB0                    LDIR
000285 CFA3 E1              10      POP HL
000286 CFA4 D1              10      POP DE
000287 CFA5 012800          10      LD  BC,WIDTH
00028A CFA8 EDB0                    LDIR
00028C CFAA 3D               4      DEC A
00028D CFAB 18E9            12      JR  SCRUP1
                                
       CFAD                     SCRCL:
00028F CFAD 0628             7      LD  B,WIDTH
000291 CFAF EB               4      EX  DE,HL
000292 CFB0 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000294 CFB2 CD0BD9          17      CALL    CLLINE
000297 CFB5 E1              10      POP HL
000298 CFB6 D1              10      POP DE
000299 CFB7 C1              10      POP BC
00029A CFB8 C9              10      RET
                                
       CFB9                     RD_PCG:
00029B CFB9 F3               4      DI
00029C CFBA D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00029E CFBC 4E               7      LD  C,(HL)
       CFBD                     RW_PCG:
00029F CFBD D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
0002A1 CFBF FB               4      EI
0002A2 CFC0 C9              10      RET
                                
       CFC1                     WR_PCG:
0002A3 CFC1 F3               4      DI
0002A4 CFC2 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
0002A6 CFC4 71               7      LD  (HL),C
0002A7 CFC5 18F6            12      JR  RW_PCG
                                
       CFC7                     IO_MON:
0002A9 CFC7 D3E4            11      OUT (0E4H),A    ;MONITOR ROM(0000H-0FFFH) & VRAM/KEY/TIMER(D000H-FFFFH)
0002AB CFC9 C7              12      RST 0
                                
       CFCA                     BANKE:
0002AC CFCA                         DS  0CFFEH-BANKE
[EOF:M7BANK.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MZ-700/1500
                                
       CFFE                     WBOOT1:
0002E0 CFFE D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)　ここは0CFFEH
0002E2 D000 D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFHH)
0002E4 D002 F3               4      DI
0002E5 D003 3A94F0          13      LD  A,(_KEYSP_L)
                                #IF EXISTS USE_8253
                                    CALL    INITINT
                                #ENDIF
0002E8 D006 ED7B0600        20      LD  SP,(SYSTEM+1)
0002EC D00A FB               4      EI
0002ED D00B 2192F0          10      LD  HL,_KEYD
0002F0 D00E 3600            10      LD  (HL),0
0002F2 D010 CDE8DA          17      CALL    CHKEY
0002F5 D013 CD15D7          17      CALL    KEYBC_IFBREAK
0002F8 D016 3E04             7      LD  A,4
0002FA D018 CD19D7          17      CALL    MSG_A
[EOF:M7CCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D01B                     COMMAND:
0002FD D01B 3A5DEB          13      LD  A,(FCB_BAT)
000300 D01E B7               4      OR  A
000301 D01F C25DD1          10      JP  NZ,C_BAT1
000304 D022 CDD1D0          17      CALL    SETDTA1
000307 D025 3A0400          13      LD  A,(_DVSW)
00030A D028 C641             7      ADD A,'A'
00030C D02A CD19D7          17      CALL    MSG_A
00030F D02D 3E3E             7      LD  A,'>'
000311 D02F CD19D7          17      CALL    MSG_A
000314 D032 3E50             7      LD  A,80
000316 D034 12               7      LD  (DE),A
000317 D035 CD75D7          17      CALL    _SYS0A      ;(BDOS)文字列入力
00031A D038 CD52D2          17      CALL    LTNL
       D03B                     COMMAND2:
00031D D03B 118200          10      LD  DE,DTA1+2
000320 D03E CDFDF0          17      CALL    _COMANL
000323 D041 DC09D7          17      CALL    C,SHOW_ERROR
000326 D044 18D5            12      JR  COMMAND
                                
       D046                     COMANL:
000328 D046 CD8ADB          17      CALL    FILE
00032B D049 3A19F0          13      LD  A,(FNAME+4)
00032E D04C FE20             7      CP  020H
000330 D04E 201C            12      JR  NZ,COMB2
000332 D050 D5              11      PUSH    DE
000333 D051 1115F0          10      LD  DE,FNAME
000336 D054 1A               7      LD  A,(DE)
000337 D055 FE20             7      CP  020H
000339 D057 2844            12      JR  Z,SDVSW
00033B D059 1B               6      DEC DE
00033C D05A 1A               7      LD  A,(DE)
00033D D05B C6FF             7      ADD A,0FFH
00033F D05D 3809            12      JR  C,COMB
000341 D05F 13               6      INC DE
                                
000342 D060 210FD4          10      LD  HL,COMTB
000345 D063 0609             7      LD  B,COMS
000347 D065 CD17DE          17      CALL    CPNAME
       D068                     COMB:
00034A D068 D1              10      POP DE
00034B D069 D208D7          10      JP  NC,JPHL
       D06C                     COMB2:
00034E D06C EB               4      EX  DE,HL
00034F D06D 223AD1          16      LD  (COMSWC),HL
000352 D070 F5              11      PUSH    AF
000353 D071 CDF2D0          17      CALL    CEXE4
000356 D074 F1              10      POP AF
000357 D075 2115F0          10      LD  HL,FNAME
00035A D078 116D00          10      LD  DE,FCB2FN   ;COMMAND NAME
00035D D07B 010B00          10      LD  BC,11
000360 D07E EDB0                    LDIR
000362 D080 11FCEA          10      LD  DE,PATHD
       D083                     CEX1:
000365 D083 1A               7      LD  A,(DE)
000366 D084 FE20             7      CP  020H
000368 D086 D8              11      RET C
000369 D087 CD7FDB          17      CALL    FILEC
00036C D08A D5              11      PUSH    DE
00036D D08B 216D00          10      LD  HL,FCB2FN   ;COMMAND NAME
000370 D08E 1115F0          10      LD  DE,FNAME
000373 D091 010B00          10      LD  BC,11
000376 D094 EDB0                    LDIR
000378 D096 CDF2D0          17      CALL    CEXE4
00037B D099 D1              10      POP DE
00037C D09A 13               6      INC DE
00037D D09B 18E6            12      JR  CEX1
                                
       D09D                     SDVSW:
00037F D09D F1              10      POP AF
000380 D09E 3A14F0          13      LD  A,(FDRV)
000383 D0A1 3D               4      DEC A
000384 D0A2 5F               4      LD  E,A
000385 D0A3 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
000387 D0A5 1831            12      JR  SYSTEM0
                                
       D0A7                     OPEN1:
000389 D0A7 2114F0          10      LD  HL,FDRV
       D0AA                     OPEN:
00038C D0AA 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D0AC                     OPEN3:
00038E D0AC D5              11      PUSH    DE
00038F D0AD 1138EB          10      LD  DE,DTA_CCP
000392 D0B0 CDCED0          17      CALL    SETDTA
000395 D0B3 EB               4      EX  DE,HL
000396 D0B4 CDD8D0          17      CALL    SYSTEM0
000399 D0B7 D1              10      POP DE
00039A D0B8 C9              10      RET
                                
       D0B9                     OPEN2:
00039B D0B9 0E12             7      LD  C,012H
00039D D0BB 18EF            12      JR  OPEN3
                                
       D0BD                     DEFCB:              ;Z=Ok NZ=Error
00039F D0BD 1138EB          10      LD  DE,DTA_CCP
0003A2 D0C0 CDD6D0          17      CALL    SYSC0F
                                
0003A5 D0C3 1159EB          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
0003A8 D0C6 0604             7      LD  B,4
0003AA D0C8 CD23D3          17      CALL    ZERO_MEMORY_DE
       D0CB                     SETDTA100:
0003AD D0CB 110001          10      LD  DE,BUFFER
       D0CE                     SETDTA:
0003B0 D0CE C349D6          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D0D1                     SETDTA1:
0003B3 D0D1 118000          10      LD  DE,DTA1
0003B6 D0D4 18F8            12      JR  SETDTA
                                
       D0D6                     SYSC0F:
0003B8 D0D6 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D0D8                     SYSTEM0:
0003BA D0D8 CD0500          17      CALL    SYSTEM
0003BD D0DB B7               4      OR  A
0003BE D0DC C9              10      RET
                                
       D0DD                     C_CD:
0003BF D0DD 0E5A             7      LD  C,05AH
0003C1 D0DF 18F7            12      JR  SYSTEM0
                                
       D0E1                     S27BUF:
0003C3 D0E1 2100FE          10      LD  HL,0-BUFFER-00100H  ;バッファー+スタック予備(0100H)
       D0E4                     S27BUF2:
0003C6 D0E4 39              11      ADD HL,SP
0003C7 D0E5 2E00             7      LD  L,0
0003C9 D0E7 7C               4      LD  A,H
0003CA D0E8 E6F8             7      AND 0F8H
0003CC D0EA 67               4      LD  H,A
       D0EB                     S27DTA:
0003CD D0EB 1138EB          10      LD  DE,DTA_CCP
       D0EE                     S27:
0003D0 D0EE 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
0003D2 D0F0 18E6            12      JR  SYSTEM0
                                
       D0F2                     CEXE4:
0003D4 D0F2 211DF0          10      LD  HL,FNAME+8
0003D7 D0F5 7E               7      LD  A,(HL)
0003D8 D0F6 FE20             7      CP  020H
0003DA D0F8 2007            12      JR  NZ,CEXE7
0003DC D0FA 3E3F             7      LD  A,'?'
0003DE D0FC 77               7      LD  (HL),A
0003DF D0FD 23               6      INC HL
0003E0 D0FE 77               7      LD  (HL),A
0003E1 D0FF 23               6      INC HL
0003E2 D100 77               7      LD  (HL),A
       D101                     CEXE7:
0003E3 D101 CDA7D0          17      CALL    OPEN1
       D104                     CEXE5:
0003E6 D104 C0              11      RET NZ
0003E7 D105 2A42EB          16      LD  HL,(DTA_CCP+1+9)
0003EA D108 7C               4      LD  A,H
0003EB D109 CDA6DE          17      CALL    CAP
0003EE D10C 67               4      LD  H,A
0003EF D10D 7D               4      LD  A,L
0003F0 D10E CDA6DE          17      CALL    CAP
0003F3 D111 6F               4      LD  L,A
0003F4 D112 3A41EB          13      LD  A,(DTA_CCP+1+8)
0003F7 D115 CDA6DE          17      CALL    CAP
0003FA D118 D642             7      SUB 'B'
0003FC D11A 282C            12      JR  Z,C_BAT
0003FE D11C 3D               4      DEC A       ;'C'
0003FF D11D 2805            12      JR  Z,C_EXE
       D11F                     CEXE6:
000401 D11F CDB9D0          17      CALL    OPEN2
000404 D122 18E0            12      JR  CEXE5
                                
       D124                     C_EXE:
000406 D124 7C               4      LD  A,H
000407 D125 FE4D             7      CP  'M'
000409 D127 20F6            12      JR  NZ,CEXE6
                                
00040B D129 CDBDD0          17      CALL    DEFCB
00040E D12C CDE1D0          17      CALL    S27BUF_COM
000411 D12F 3D               4      DEC A
000412 D130 37               4      SCF
000413 D131 C0              11      RET NZ
000414 D132 7C               4      LD  A,H
000415 D133 B5               4      OR  L
000416 D134 37               4      SCF
000417 D135 C8              11      RET Z
000418 D136 CDD1D0          17      CALL    SETDTA1
00041B D139 110000          10      LD  DE,0                ; self-modifying code
       D13A                     COMSWC  EQU $-2
00041E D13C ED7B0600        20      LD  SP,(SYSTEM+1)
000422 D140 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000423 D141 6F               4      LD  L,A
000424 D142 E5              11      PUSH    HL              ; push $0000 (reboot address)
000425 D143 24               4      INC H
000426 D144 E5              11      PUSH    HL              ; push $0100 (TPA address)
000427 D145 C3EED2          10      JP  SETFCB              ; and JP $0100
                                
       D148                     C_BAT:
00042A D148 114154          10      LD  DE,'A'+'T'*256
00042D D14B ED52            15      SBC HL,DE
00042F D14D 20D0            12      JR  NZ,CEXE6
                                
000431 D14F CDBDD0          17      CALL    DEFCB
                                
000434 D152 2138EB          10      LD  HL,DTA_CCP
000437 D155 115DEB          10      LD  DE,FCB_BAT
00043A D158 012500          10      LD  BC,37
00043D D15B EDB0                    LDIR
       D15D                     C_BAT1:
00043F D15D CDCBD0          17      CALL    SETDTA100
000442 D160 CD94D1          17      CALL    FGETC_BAT
000445 D163 218100          10      LD  HL,DTA1+1
000448 D166 2025            12      JR  NZ,END_BATCH
00044A D168 FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
00044C D16A 38F1            12      JR  C,C_BAT1
00044E D16C 3620            10      LD  (HL),' '
000450 D16E 23               6      INC HL
       D16F                     C_BAT2:
000451 D16F 77               7      LD  (HL),A
000452 D170 23               6      INC HL
000453 D171 7D               4      LD  A,L
000454 D172 3C               4      INC A       ;L==0FFH
000455 D173 2809            12      JR  Z,RUN_BATCH
000457 D175 CD94D1          17      CALL    FGETC_BAT
00045A D178 2004            12      JR  NZ,RUN_BATCH
00045C D17A FE20             7      CP  020H
00045E D17C 30F1            12      JR  NC,C_BAT2
       D17E                     RUN_BATCH:
000460 D17E 7D               4      LD  A,L
000461 D17F D67F             7      SUB DTA1-1
000463 D181 328000          13      LD  (DTA1),A
000466 D184 FE04             7      CP  4
000468 D186 3805            12      JR  C,END_BATCH
00046A D188 3600            10      LD  (HL),0
00046C D18A C33BD0          10      JP  COMMAND2
       D18D                     END_BATCH:
00046F D18D AF               4      XOR A       ;バッチファイルを閉じる
000470 D18E 325DEB          13      LD  (FCB_BAT),A
000473 D191 C300F0          10      JP  CPM_BOOT
                                
       D194                     FGETC_BAT:
000476 D194 115DEB          10      LD  DE,FCB_BAT
       D197                     FGETC:              ;1文字ずつ読み込む
000479 D197 E5              11      PUSH    HL      ;Z:成功
00047A D198 210100          10      LD  HL,1
00047D D19B CDEED0          17      CALL    S27
000480 D19E E1              10      POP HL
000481 D19F 3A0001          13      LD  A,(BUFFER)
000484 D1A2 C9              10      RET
                                
       D1A3                     C_DEL:
000485 D1A3 CDEED2          17      CALL    SETFCB
000488 D1A6 CD2FD7          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
00048B D1A9 0E13             7      LD  C,013H
00048D D1AB 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D1AD                     C_REN:
00048F D1AD CDEED2          17      CALL    SETFCB
000492 D1B0 3E10             7      LD  A,010H      ;ディレクトリも対象にする
000494 D1B2 326900          13      LD  (FCB1+13),A ;属性
000497 D1B5 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D1B7                     CDEL1:
000499 D1B7 115C00          10      LD  DE,FCB1
00049C D1BA CD0500          17      CALL    SYSTEM
00049F D1BD C6FF             7      ADD A,0FFH
0004A1 D1BF C9              10      RET
                                
       D1C0                     C_DIR:
0004A2 D1C0 CD7FDB          17      CALL    FILEC
0004A5 D1C3 2115F0          10      LD  HL,FDRV+1
0004A8 D1C6 CD04D4          17      CALL    CWILD1
0004AB D1C9 3EF1             7      LD  A,0F1H
0004AD D1CB 3221F0          13      LD  (FDRV+13),A
0004B0 D1CE CDA7D0          17      CALL    OPEN1
       D1D1                     CDIR1:
0004B3 D1D1 B7               4      OR  A
0004B4 D1D2 2008            12      JR  NZ,PDSKF
0004B6 D1D4 CD1FD2          17      CALL    P_NAME
0004B9 D1D7 CDB9D0          17      CALL    OPEN2
0004BC D1DA 18F5            12      JR  CDIR1
       D1DC                     PDSKF:
0004BE D1DC 3A14F0          13      LD  A,(FDRV)
0004C1 D1DF 5F               4      LD  E,A
0004C2 D1E0 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
0004C4 D1E2 CD0500          17      CALL    SYSTEM
0004C7 D1E5 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
0004C8 D1E6 C601             7      ADD A,001H
0004CA D1E8 D8              11      RET C       ;Aが0FFHだった場合
0004CB D1E9 3E06             7      LD  A,8-2
       D1EB                     PDS1:               ;HL=未使用クラスタの総数
0004CD D1EB 3C               4      INC A
0004CE D1EC CB19             8      RR  C
0004D0 D1EE 30FB            12      JR  NC,PDS1
       D1F0                     PDS2:               ;B←論理セクタのサイズの上位8ビット
0004D2 D1F0 3C               4      INC A
0004D3 D1F1 CB18             8      RR  B
0004D5 D1F3 30FB            12      JR  NC,PDS2
0004D7 D1F5 47               4      LD  B,A
                                
0004D8 D1F6 110000          10      LD  DE,0
       D1F9                     PDS3:
0004DB D1F9 29              11      ADD HL,HL
0004DC D1FA EB               4      EX  DE,HL
0004DD D1FB ED6A            15      ADC HL,HL
0004DF D1FD EB               4      EX  DE,HL
0004E0 D1FE 10F9            13      DJNZ    PDS3
       D200                     PDSKF1:
0004E2 D200 CD8CD2          17      CALL    PRDEC_DEHL
0004E5 D203 118DEB          10      LD  DE,FREE
0004E8 D206 CD76D4          17      CALL    _SYS09      ;(BDOS)文字列出力
0004EB D209 CD79D2          17      CALL    PUTDRV
0004EE D20C 3E5C             7      LD  A,05CH      ;\
0004F0 D20E CD19D7          17      CALL    MSG_A
0004F3 D211 2A22F0          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
0004F6 D214 AF               4      XOR A
0004F7 D215 11FEFF          10      LD  DE,0-2
0004FA D218 19              11      ADD HL,DE
0004FB D219 23               6      INC HL
0004FC D21A DC89D2          17      CALL    C,PRDEC_HL
0004FF D21D 1833            12      JR  LTNL
                                
       D21F                     P_NAME:
000501 D21F 3A39EB          13      LD  A,(DTA_CCP+1)
000504 D222 FE2E             7      CP  '.'
000506 D224 C8              11      RET Z
                                
000507 D225 3A44EB          13      LD  A,(DTA_CCP+1+00BH)
00050A D228 F5              11      PUSH    AF
00050B D229 CB67             8      BIT 4,A
00050D D22B 2808            12      JR  Z,DIR3
00050F D22D 1182EB          10      LD  DE,DIRMES
000512 D230 CD76D4          17      CALL    _SYS09      ;(BDOS)文字列出力
000515 D233 180A            12      JR  DIR6
       D235                     DIR3:
000517 D235 ED5B57EB        20      LD  DE,(DTA_CCP+1+01EH)
00051B D239 2A55EB          16      LD  HL,(DTA_CCP+1+01CH)
00051E D23C CD8CD2          17      CALL    PRDEC_DEHL
       D23F                     DIR6:
000521 D23F F1              10      POP AF
000522 D240 0F               4      RRCA
000523 D241 9F               4      SBC A,A
000524 D242 E60A             7      AND '*'-020H
000526 D244 C620             7      ADD A,020H
000528 D246 CD19D7          17      CALL    MSG_A
00052B D249 CD79D2          17      CALL    PUTDRV
00052E D24C 2139EB          10      LD  HL,DTA_CCP+1
000531 D24F CDCCD2          17      CALL    FPRNT
                                
       D252                     LTNL:
000534 D252 1E03             7      LD  E,3
000536 D254 C3CDF0          10      JP  _PRINT
                                
       D257                     C_PATH:
000539 D257 CD60DC          17      CALL    SPCUT
00053C D25A 21FCEA          10      LD  HL,PATHD
00053F D25D FE21             7      CP  021H
000541 D25F 300C            12      JR  NC,CPATH0
       D261                     CPATHP:
000543 D261 7E               7      LD  A,(HL)
000544 D262 23               6      INC HL
000545 D263 FE20             7      CP  020H
000547 D265 3F               4      CCF
000548 D266 30EA            12      JR  NC,LTNL
00054A D268 CD19D7          17      CALL    MSG_A
00054D D26B 18F4            12      JR  CPATHP
       D26D                     CPATH0:
00054F D26D FE3B             7      CP  ';'
000551 D26F 2001            12      JR  NZ,CPATH1
000553 D271 13               6      INC DE
       D272                     CPATH1:
000554 D272 EB               4      EX  DE,HL
000555 D273 013B00          10      LD  BC,PATHX
000558 D276 EDB0                    LDIR
00055A D278 C9              10      RET
                                
       D279                     PUTDRV:
00055B D279 3A14F0          13      LD  A,(FDRV)
00055E D27C CD93DC          17      CALL    GETDRV1
000561 D27F C641             7      ADD A,'A'
000563 D281 CD19D7          17      CALL    MSG_A
000566 D284 3E3A             7      LD  A,':'
       D286                     MSG_AR:
000568 D286 C319D7          10      JP  MSG_A
                                
       D289                     PRDEC_HL:
00056B D289 AF               4      XOR A
00056C D28A 5F               4      LD  E,A
00056D D28B 57               4      LD  D,A
       D28C                     PRDEC_DEHL:
00056E D28C D5              11      PUSH    DE
00056F D28D 110FF0          10      LD  DE,DECBF
000572 D290 0605             7      LD  B,5
000574 D292 CD23D3          17      CALL    ZERO_MEMORY_DE  ;A=0
000577 D295 D1              10      POP DE
                                
000578 D296 0E20             7      LD  C,32
       D298                     DEC1:
00057A D298 29              11      ADD HL,HL
00057B D299 EB               4      EX  DE,HL
00057C D29A ED6A            15      ADC HL,HL
00057E D29C EB               4      EX  DE,HL
00057F D29D E5              11      PUSH    HL
000580 D29E 2113F0          10      LD  HL,DECBF+4
000583 D2A1 0605             7      LD  B,5
       D2A3                     DEC2:
000585 D2A3 7E               7      LD  A,(HL)
000586 D2A4 8F               4      ADC A,A
000587 D2A5 27               4      DAA
000588 D2A6 77               7      LD  (HL),A
000589 D2A7 2B               6      DEC HL
00058A D2A8 10F9            13      DJNZ    DEC2
00058C D2AA E1              10      POP HL
00058D D2AB 0D               4      DEC C
00058E D2AC 20EA            12      JR  NZ,DEC1
                                
000590 D2AE 210FF0          10      LD  HL,DECBF
000593 D2B1 3E20             7      LD  A,020H
000595 D2B3 0604             7      LD  B,4
       D2B5                     DEC3:
000597 D2B5 CDC2D2          17      CALL    DEC4
00059A D2B8 CDC2D2          17      CALL    DEC4
00059D D2BB 23               6      INC HL
00059E D2BC 10F7            13      DJNZ    DEC3
       D2BE                     DECX:
0005A0 D2BE CDC2D2          17      CALL    DEC4
0005A3 D2C1 AF               4      XOR A
       D2C2                     DEC4:
0005A4 D2C2 ED6F            18      RLD
0005A6 D2C4 FE20             7      CP  020H
0005A8 D2C6 2802            12      JR  Z,DEC5
0005AA D2C8 F630             7      OR  030H
       D2CA                     DEC5:
0005AC D2CA 18BA            12      JR  MSG_AR
                                
       D2CC                     FPRNT:
0005AE D2CC 0608             7      LD  B,8 ;ファイル名を表示
0005B0 D2CE CDDDD2          17      CALL    P_N1
0005B3 D2D1 7E               7      LD  A,(HL)
0005B4 D2D2 CDB2DE          17      CALL    CAP3
0005B7 D2D5 D8              11      RET C   ;拡張子が無い
                                
0005B8 D2D6 3E2E             7      LD  A,'.'
0005BA D2D8 CD19D7          17      CALL    MSG_A
0005BD D2DB 0603             7      LD  B,3 ;拡張子を表示
       D2DD                     P_N1:
0005BF D2DD 7E               7      LD  A,(HL)
0005C0 D2DE CDB2DE          17      CALL    CAP3
0005C3 D2E1 3807            12      JR  C,P_N2
0005C5 D2E3 CD19D7          17      CALL    MSG_A
0005C8 D2E6 23               6      INC HL
0005C9 D2E7 10F4            13      DJNZ    P_N1
0005CB D2E9 C9              10      RET
       D2EA                     P_N2:
0005CC D2EA 23               6      INC HL
0005CD D2EB 10FD            13      DJNZ    P_N2
0005CF D2ED C9              10      RET
                                
       D2EE                     SETFCB:
0005D0 D2EE CD60DC          17      CALL    SPCUT
0005D3 D2F1 1A               7      LD  A,(DE)
0005D4 D2F2 FE20             7      CP  020H
0005D6 D2F4 3801            12      JR  C,SETFCBA
0005D8 D2F6 1B               6      DEC DE
       D2F7                     SETFCBA:
0005D9 D2F7 0624             7      LD  B,36
0005DB D2F9 215C00          10      LD  HL,FCB1
0005DE D2FC E5              11      PUSH    HL
0005DF D2FD AF               4      XOR A
0005E0 D2FE CD35DC          17      CALL    FILL_MEMORY
0005E3 D301 E1              10      POP HL
0005E4 D302 D5              11      PUSH    DE
0005E5 D303 CDAFD6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005E8 D306 216C00          10      LD  HL,FCB2
0005EB D309 CDAFD6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005EE D30C E1              10      POP HL
0005EF D30D 010050          10      LD  BC,05000H
0005F2 D310 118100          10      LD  DE,00081H
       D313                     SETFCB1:
0005F5 D313 7E               7      LD  A,(HL)
0005F6 D314 23               6      INC HL
0005F7 D315 FE20             7      CP  020H
0005F9 D317 3805            12      JR  C,SETFCB2
0005FB D319 12               7      LD  (DE),A
0005FC D31A 13               6      INC DE
0005FD D31B 0C               4      INC C
0005FE D31C 10F5            13      DJNZ    SETFCB1
       D31E                     SETFCB2:
000600 D31E 79               4      LD  A,C
000601 D31F 328000          13      LD  (DTA1),A
000604 D322 04               4      INC B
       D323                     ZERO_MEMORY_DE:
000605 D323 AF               4      XOR A
       D324                     FILL_MEMORY_DE:
000606 D324 12               7      LD  (DE),A
000607 D325 13               6      INC DE
000608 D326 10FC            13      DJNZ    FILL_MEMORY_DE
00060A D328 C9              10      RET
                                
       D329                     C_COPY:
00060B D329 CDEED2          17      CALL    SETFCB
                                
00060E D32C 1161F0          10      LD  DE,ZERO
000611 D32F CD82DB          17      CALL    FILEC2
000614 D332 216C00          10      LD  HL,FCB2
000617 D335 CDB6D6          17      CALL    S29X1
                                
00061A D338 3E10             7      LD  A,010H
00061C D33A 326900          13      LD  (FCB1+13),A
00061F D33D 216D00          10      LD  HL,FCB2FN
000622 D340 CD04D4          17      CALL    CWILD1
       D343                     COPY0:
000625 D343 CD01D4          17      CALL    CWILD
000628 D346 215C00          10      LD  HL,FCB1
00062B D349 CDAAD0          17      CALL    OPEN
00062E D34C 37               4      SCF
       D34D                     COPY1:
00062F D34D C0              11      RET NZ
000630 D34E CDBDD0          17      CALL    DEFCB
                                
000633 D351 3A45EB          13      LD  A,(DTA_CCP+13)
000636 D354 CB67             8      BIT 4,A
000638 D356 2821            12      JR  Z,COPY1A
                                
00063A D358 215D00          10      LD  HL,FCB1FN
00063D D35B CDC5DF          17      CALL    CHKWILD
000640 D35E 3814            12      JR  C,COPY9
                                
000642 D360 3E20             7      LD  A,020H
000644 D362 325D00          13      LD  (FCB1FN),A
000647 D365 2A52EB          16      LD  HL,(DTA_CCP+26)
00064A D368 23               6      INC HL
00064B D369 226A00          16      LD  (FCB1+14),HL
00064E D36C 18D5            12      JR  COPY0
                                
       D36E                     COPY8:
000650 D36E CD76D4          17      CALL    _SYS09      ;(BDOS)文字列出力
000653 D371 CD52D2          17      CALL    LTNL
       D374                     COPY9:
000656 D374 CDB9D0          17      CALL    OPEN2
000659 D377 18D4            12      JR  COPY1
                                
       D379                     COPY1A:
00065B D379 216C00          10      LD  HL,FCB2
00065E D37C 1114F0          10      LD  DE,FDRV
000661 D37F 013AEB          10      LD  BC,DTA_CCP+2
000664 D382 EDA0            16      LDI
000666 D384 3E0B             7      LD  A,11
       D386                     COPY2:
000668 D386 F5              11      PUSH    AF
000669 D387 7E               7      LD  A,(HL)
00066A D388 FE3F             7      CP  '?'
00066C D38A 2001            12      JR  NZ,COPY3
00066E D38C 0A               7      LD  A,(BC)
       D38D                     COPY3:
00066F D38D 12               7      LD  (DE),A
000670 D38E 03               6      INC BC
000671 D38F 13               6      INC DE
000672 D390 23               6      INC HL
000673 D391 F1              10      POP AF
000674 D392 3D               4      DEC A
000675 D393 20F1            12      JR  NZ,COPY2
000677 D395 010500          10      LD  BC,16-11
00067A D398 EDB0                    LDIR
       D39A                     PUTNAME:
00067C D39A 215D00          10      LD  HL,FCB1FN
00067F D39D CDC5DF          17      CALL    CHKWILD
000682 D3A0 300B            12      JR  NC,PUTN1
000684 D3A2 2115F0          10      LD  HL,FDRV+1
000687 D3A5 CDCCD2          17      CALL    FPRNT
00068A D3A8 3E20             7      LD  A,020H
00068C D3AA CD19D7          17      CALL    MSG_A
       D3AD                     PUTN1:
00068F D3AD 1114F0          10      LD  DE,FDRV
000692 D3B0 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
000694 D3B2 CDD8D0          17      CALL    SYSTEM0
000697 D3B5 2048            12      JR  NZ,COPYE2
000699 D3B7 67               4      LD  H,A     ;A=0
00069A D3B8 6F               4      LD  L,A
00069B D3B9 2235F0          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
00069E D3BC 2237F0          16      LD  (FDRV+35),HL
       D3BF                     COPY6:
0006A1 D3BF CDE1D0          17      CALL    S27BUF
0006A4 D3C2 47               4      LD  B,A
0006A5 D3C3 3C               4      INC A
0006A6 D3C4 2831            12      JR  Z,COPYE
0006A8 D3C6 7C               4      LD  A,H
0006A9 D3C7 B5               4      OR  L
0006AA D3C8 280C            12      JR  Z,COPY7
0006AC D3CA 1114F0          10      LD  DE,FDRV
0006AF D3CD 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0006B1 D3CF CDD8D0          17      CALL    SYSTEM0
0006B4 D3D2 2023            12      JR  NZ,COPYE
0006B6 D3D4 10E9            13      DJNZ    COPY6
       D3D6                     COPY7:
0006B8 D3D6 3A45EB          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0006BB D3D9 3221F0          13      LD  (FDRV+13),A
0006BE D3DC 214CEB          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
0006C1 D3DF 1128F0          10      LD  DE,FDRV+20
0006C4 D3E2 010400          10      LD  BC,4
0006C7 D3E5 EDB0                    LDIR
                                
0006C9 D3E7 1114F0          10      LD  DE,FDRV
0006CC D3EA 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
0006CE D3EC CDD8D0          17      CALL    SYSTEM0
0006D1 D3EF 2006            12      JR  NZ,COPYE
                                
0006D3 D3F1 1171F0          10      LD  DE,OK
0006D6 D3F4 C36ED3          10      JP  COPY8
                                
       D3F7                     COPYE:
0006D9 D3F7 1114F0          10      LD  DE,FDRV
0006DC D3FA 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
0006DE D3FC CD0500          17      CALL    SYSTEM
       D3FF                     COPYE2:
0006E1 D3FF 37               4      SCF
0006E2 D400 C9              10      RET
                                
       D401                     CWILD:
0006E3 D401 215D00          10      LD  HL,FCB1FN
       D404                     CWILD1:
0006E6 D404 7E               7      LD  A,(HL)
0006E7 D405 FE20             7      CP  020H
0006E9 D407 C0              11      RET NZ
       D408                     CWILD2:
0006EA D408 3E3F             7      LD  A,'?'
0006EC D40A 060B             7      LD  B,11
0006EE D40C C335DC          10      JP  FILL_MEMORY
                                
       D40F                     COMTB:
0006F1 D40F 44202020                DB  "D   "  ;1
0006F5 D413 C0D1                    DW  C_DIR
0006F7 D415 44495220                DB  "DIR "  ;2
0006FB D419 C0D1                    DW  C_DIR
0006FD D41B 434F5059                DB  "COPY"  ;3
000701 D41F 29D3                    DW  C_COPY
000703 D421 43442020                DB  "CD  "  ;4
000707 D425 DDD0                    DW  C_CD
000709 D427 44454C20                DB  "DEL "  ;5
00070D D42B A3D1                    DW  C_DEL
00070F D42D 50415448                DB  "PATH"  ;6
000713 D431 57D2                    DW  C_PATH
000715 D433 52454E20                DB  "REN "  ;7
000719 D437 ADD1                    DW  C_REN
00071B D439 52454D20                DB  "REM "  ;8
00071F D43D 73D4                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP2.ASM"
                                
                                ;   LSX-Dodgers CCP2
                                ;   MZ-700/1500
                                
000721 D43F 4D4F4E20                DB  "MON "  ;9
000725 D443 6FDB                    DW  C_MON
[EOF:M7CCP2.ASM:UTF_8]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D445                     BDOS0:
000727 D445 E5              11      PUSH    HL
000728 D446 79               4      LD  A,C
000729 D447 FE3C             7      CP  03CH
00072B D449 3802            12      JR  C,DOS1
00072D D44B 3E3C             7      LD  A,03CH
       D44D                     DOS1:
00072F D44D 87               4      ADD A,A
000730 D44E 3252D4          13      LD  (DOS1_SWC),A
000733 D451 2A00F1          16      LD  HL,(STABLE)
       D452                     DOS1_SWC    EQU $-2
000736 D454 E3              19      EX  (SP),HL
000737 D455 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
000738 D456 C9              10      RET
       D457                     _DOS2:
000739 D457 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
00073B D459 CAF1D6          10      JP  Z,_SYS5A
00073E D45C FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
000740 D45E CAAED6          10      JP  Z,_SYS5C
000743 D461 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
000745 D463 CAC0E8          10      JP  Z,_SYS5F
000748 D466 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
00074A D468 200A            12      JR  NZ,_ERROR
00074C D46A 011D01          10      LD  BC,VER_6F
00074F D46D 116101          10      LD  DE,VER
000752 D470 210100          10      LD  HL,MACD
       D473                     C_REM:
000755 D473 AF               4      XOR A
       D474                     _ERROR:
000756 D474 A7               4      AND A
000757 D475 C9              10      RET
                                
       D476                     _SYS09:     ;文字列出力
000758 D476 D5              11      PUSH    DE
       D477                     _SX09:
000759 D477 1A               7      LD  A,(DE)
00075A D478 13               6      INC DE
00075B D479 FE24             7      CP  '$'
00075D D47B 2831            12      JR  Z,SX0E2
00075F D47D CD19D7          17      CALL    MSG_A
000762 D480 18F5            12      JR  _SX09
                                
       D482                     MSX1:
000764 D482 CD19D7          17      CALL    MSG_A
       D485                     MSX:
000767 D485 7E               7      LD  A,(HL)
000768 D486 23               6      INC HL
000769 D487 B7               4      OR  A
00076A D488 20F8            12      JR  NZ,MSX1
00076C D48A C9              10      RET
                                
       D48B                     _SYS0C:     ;(BDOS)バージョン番号の獲得
00076D D48B 212200          10      LD  HL,00022H
000770 D48E 7D               4      LD  A,L
000771 D48F C9              10      RET
                                
       D490                     _SYS0D:     ;(BDOS)ディスクリセット
000772 D490 CDDFF0          17      CALL    _FFLUSH
000775 D493 E5              11      PUSH    HL
000776 D494 218000          10      LD  HL,00080H
000779 D497 228AF0          16      LD  (_DTA),HL
00077C D49A E1              10      POP HL
00077D D49B D5              11      PUSH    DE
00077E D49C 1E00             7      LD  E,0
000780 D49E 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D49F                     _SYS0E:     ;(BDOS)カレントドライブの設定
000781 D49F D5              11      PUSH    DE
000782 D4A0 7B               4      LD  A,E
000783 D4A1 DDE5            15      PUSH    IX
000785 D4A3 CDDCF0          17      CALL    _GETDPB
000788 D4A6 DDE1            14      POP IX
00078A D4A8 3804            12      JR  C,SX0E2
00078C D4AA 7B               4      LD  A,E
00078D D4AB 320400          13      LD  (_DVSW),A
       D4AE                     SX0E2:
000790 D4AE D1              10      POP DE
000791 D4AF C9              10      RET
                                
       D4B0                     _SYS0F:     ;(BDOS)ファイルのオープン
000792 D4B0 CD72DC          17      CALL    SETDRV
000795 D4B3 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000798 D4B6 C602             7      ADD A,002H      ;Write
00079A D4B8 2848            12      JR  Z,FEND0F
00079C D4BA CDC1DF          17      CALL    CHKWILDX
                                
00079F D4BD D49CDC          17      CALL    NC,SOPENX
       D4C0                     _S16XX:
0007A2 D4C0 3840            12      JR  C,FEND0F
                                                ;Directory location
0007A4 D4C2 3A9FF0          13      LD  A,(_FILEN)
0007A7 D4C5 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
0007AA D4C8 3AA0F0          13      LD  A,(_DIRF)
0007AD D4CB FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
0007B0 D4CE FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
0007B3 D4D1 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
0007B6 D4D4 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
0007BA D4D8 FDE5            15      PUSH    IY
0007BC D4DA D1              10      POP DE
0007BD D4DB 13               6      INC DE
0007BE D4DC 010B00          10      LD  BC,11
0007C1 D4DF EDB0                    LDIR
                                ;               Attribute
0007C3 D4E1 7E               7      LD  A,(HL)
0007C4 D4E2 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
0007C7 D4E5 110B00          10      LD  DE,11       ;Reserved
0007CA D4E8 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
0007CB D4E9 11E4F1          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
0007CE D4EC 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D4EE                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
0007D0 D4EE 1A               7      LD  A,(DE)
0007D1 D4EF 13               6      INC DE
0007D2 D4F0 32F7D4          13      LD  (S16PAT),A
0007D5 D4F3 7E               7      LD  A,(HL)
0007D6 D4F4 23               6      INC HL
0007D7 D4F5 FD7700          19      LD  (IY+0),A
       D4F7                     S16PAT  EQU $-1
0007DA D4F8 10F4            13      DJNZ    S16LOOP
                                
0007DC D4FA AF               4      XOR A
0007DD D4FB FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
0007E0 D4FE FD229FD5        20      LD  (OFCB_SWC),IY
       D502                     FEND0F:
0007E4 D502 1845            12      JR  FEND10
                                
       D504                     _SYS10:     ;(BDOS)ファイルのクローズ
0007E6 D504 CD72DC          17      CALL    SETDRV
0007E9 D507 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0007EC D50A D6FE             7      SUB 0FEH
0007EE D50C 37               4      SCF
0007EF D50D 3F               4      CCF
0007F0 D50E 2039            12      JR  NZ,FEND10
       D510                     _S10A:              ;Write
0007F2 D510 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
0007F5 D513 FD770F          19      LD  (IY+15),A
                                
0007F8 D516 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
0007FB D519 CDBDE0          17      CALL    SETTMS
                                
0007FE D51C FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
000801 D51F 32A0F0          13      LD  (_DIRF),A
000804 D522 E67F             7      AND 07FH
000806 D524 32E2E5          13      LD  (_SECPS),A
000809 D527 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
00080C D52A FD561F          19      LD  D,(IY+31)
00080F D52D CDD0DD          17      CALL    READ_DIR
000812 D530 3817            12      JR  C,FEND10
                                
000814 D532 3AFCDC          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000817 D535 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000818 D536 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
00081B D539 6F               4      LD  L,A
00081C D53A 2600             7      LD  H,0
00081E D53C 29              11      ADD HL,HL       ;*2
00081F D53D 29              11      ADD HL,HL       ;*4
000820 D53E 29              11      ADD HL,HL       ;*8
000821 D53F 29              11      ADD HL,HL       ;*16
000822 D540 29              11      ADD HL,HL       ;*32
000823 D541 ED4B7EF1        20      LD  BC,(_DTBUF)
000827 D545 09              11      ADD HL,BC
                                
000828 D546 CDD1DF          17      CALL    SDIRENT
       D549                     FEND10:
00082B D549 1842            12      JR  FEND
                                
       D54B                     _SYS11:     ;(BDOS)最初のファイルの検索
00082D D54B CD72DC          17      CALL    SETDRV
000830 D54E CDCBDC          17      CALL    SOPEN
       D551                     _S12X1:
000833 D551 383A            12      JR  C,FEND
000835 D553 CD6ADD          17      CALL    SOPENE2
000838 D556 ED5B8AF0        20      LD  DE,(_DTA)
00083C D55A 3A88F0          13      LD  A,(_DRV)
00083F D55D 3C               4      INC A
000840 D55E 12               7      LD  (DE),A
000841 D55F D5              11      PUSH    DE
000842 D560 13               6      INC DE
000843 D561 012000          10      LD  BC,32
000846 D564 EDB0                    LDIR
000848 D566 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
00084B D569 FD660F          19      LD  H,(IY+15)
00084E D56C 22F4F1          16      LD  (SCDIR),HL
000851 D56F 2A9AF0          16      LD  HL,(_FBPS)
000854 D572 22F6F1          16      LD  (SFBPS),HL
000857 D575 2A9FF0          16      LD  HL,(_FILEN)
00085A D578 7C               4      LD  A,H
00085B D579 B7               4      OR  A
00085C D57A 2806            12      JR  Z,_S12DIR
00085E D57C 3AE2E5          13      LD  A,(_SECPS)
000861 D57F F680             7      OR  080H
000863 D581 67               4      LD  H,A
       D582                     _S12DIR:
000864 D582 22F8F1          16      LD  (SFNDF),HL  ;Directory position and Flags
000867 D585 E1              10      POP HL
000868 D586 1139F0          10      LD  DE,SFILE
00086B D589 0E21             7      LD  C,33
       D58B                     _S11B:
00086D D58B EDB0                    LDIR
       D58D                     FEND:
00086F D58D 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D58E                     FENDE:
000870 D58E FDE1            14      POP IY
000872 D590 C1              10      POP BC
000873 D591 D1              10      POP DE
000874 D592 E1              10      POP HL
000875 D593 C9              10      RET
                                
       D594                     _SYS12:     ;(BDOS)次のファイルの検索
000876 D594 E5              11      PUSH    HL
000877 D595 D5              11      PUSH    DE
000878 D596 C5              11      PUSH    BC
000879 D597 FDE5            15      PUSH    IY
00087B D599 CD2FDD          17      CALL    NOPEN
00087E D59C 18B3            12      JR  _S12X1
                                
       D59E                     _S16K:
000880 D59E 110000          10      LD  DE,0
       D59F                     OFCB_SWC    EQU $-2
000883 D5A1 D5              11      PUSH    DE
000884 D5A2 061A             7      LD  B,26        ;First cluster
       D5A4                     S16K1:
000886 D5A4 13               6      INC DE
000887 D5A5 23               6      INC HL
000888 D5A6 10FC            13      DJNZ    S16K1
                                
00088A D5A8 1A               7      LD  A,(DE)
00088B D5A9 BE               7      CP  (HL)
00088C D5AA 2015            12      JR  NZ,S16K2
00088E D5AC 13               6      INC DE
00088F D5AD 23               6      INC HL
000890 D5AE 1A               7      LD  A,(DE)
000891 D5AF BE               7      CP  (HL)
000892 D5B0 200F            12      JR  NZ,S16K2
                                
000894 D5B2 E1              10      POP HL
000895 D5B3 FDE5            15      PUSH    IY
000897 D5B5 D1              10      POP DE
000898 D5B6 7E               7      LD  A,(HL)
000899 D5B7 CD87DC          17      CALL    IS_SAME_DRV_A_DE
00089C D5BA 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
00089E D5BC ED52            15      SBC HL,DE       ;CP HL,DE
0008A0 D5BE 37               4      SCF
0008A1 D5BF C0              11      RET NZ
0008A2 D5C0 E5              11      PUSH    HL
       D5C1                     S16K2:
0008A3 D5C1 E1              10      POP HL
       D5C2                     S16K3:
0008A4 D5C2 FDE5            15      PUSH    IY
0008A6 D5C4 D1              10      POP DE
       D5C5                     _SYS13:     ;(BDOS)ファイルの削除
0008A7 D5C5 CD72DC          17      CALL    SETDRV
0008AA D5C8 CDF9DE          17      CALL    KILL
       D5CB                     FEND13:
0008AD D5CB 18C0            12      JR  FEND
                                
       D5CD                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
0008AF D5CD CD72DC          17      CALL    SETDRV
0008B2 D5D0 CD35E4          17      CALL    INIT_SEQ
       D5D3                     SREAD:
0008B5 D5D3 CD07E4          17      CALL    RB_READ
                                
0008B8 D5D6 C601             7      ADD A,001H
0008BA D5D8 38B3            12      JR  C,FEND
                                
0008BC D5DA 7D               4      LD  A,L
0008BD D5DB D601             7      SUB 001H
       D5DD                     FENDX:
0008BF D5DD 9F               4      SBC A,A
0008C0 D5DE E603             7      AND 3
0008C2 D5E0 1F               4      RRA
0008C3 D5E1 18AB            12      JR  FENDE
                                
       D5E3                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
0008C5 D5E3 CD72DC          17      CALL    SETDRV
0008C8 D5E6 CD35E4          17      CALL    INIT_SEQ
       D5E9                     SWRITE:
0008CB D5E9 CD02E4          17      CALL    RB_WRITE
                                
0008CE D5EC C6FF             7      ADD A,0FFH
0008D0 D5EE 18ED            12      JR  FENDX
                                
       D5F0                     _SYS17:     ;(BDOS)ファイル名の変更
0008D2 D5F0 CD72DC          17      CALL    SETDRV
0008D5 D5F3 CD4FDF          17      CALL    NAME
0008D8 D5F6 18D3            12      JR  FEND13
                                
       D5F8                     _SYS16:     ;(BDOS)ファイルの作成
0008DA D5F8 CD72DC          17      CALL    SETDRV
                                
0008DD D5FB CDC1DF          17      CALL    CHKWILDX
0008E0 D5FE 38CB            12      JR  C,FEND13
0008E2 D600 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
0008E5 D603 FE05             7      CP  5
0008E7 D605 2805            12      JR  Z,_S16X2
0008E9 D607 FE21             7      CP  021H
0008EB D609 DACBD5          10      JP  C,FEND13
       D60C                     _S16X2:
                                ;               Clear FCB
0008EE D60C FDE5            15      PUSH    IY
0008F0 D60E E1              10      POP HL
0008F1 D60F 011000          10      LD  BC,16
0008F4 D612 09              11      ADD HL,BC
       D613                     _S16X1:
0008F5 D613 70               7      LD  (HL),B      ;B=0
0008F6 D614 23               6      INC HL
0008F7 D615 0D               4      DEC C
0008F8 D616 20FB            12      JR  NZ,_S16X1
                                
0008FA D618 CDC2E0          17      CALL    SETTMSX
0008FD D61B FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
000901 D61F CD9CDC          17      CALL    SOPENX
000904 D622 3F               4      CCF
000905 D623 CC9ED5          17      CALL    Z,_S16K
000908 D626 D47BDD          17      CALL    NC,COPEN
00090B D629 D4D1DF          17      CALL    NC,SDIRENT
00090E D62C C3C0D4          10      JP  _S16XX
                                
       D62F                     _SYS21:     ;(BDOS)ランダムな読み出し
000911 D62F CD72DC          17      CALL    SETDRV
000914 D632 CD0DE1          17      CALL    INIT_RND
000917 D635 189C            12      JR  SREAD
                                
       D637                     _SYS22:     ;(BDOS)ランダムな書き込み
       D637                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000919 D637 CD72DC          17      CALL    SETDRV
00091C D63A CD0DE1          17      CALL    INIT_RND
00091F D63D 18AA            12      JR  SWRITE
                                
       D63F                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000921 D63F 21FF00          10      LD  HL,000FFH
000924 D642 AF               4      XOR A
000925 D643 C9              10      RET
                                
       D644                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000926 D644 3A0400          13      LD  A,(_DVSW)   ;from LDOS
000929 D647 A7               4      AND A
00092A D648 C9              10      RET
                                
       D649                     _SYS1A:     ;(BDOS)DTAの設定
00092B D649 ED538AF0        20      LD  (_DTA),DE
00092F D64D AF               4      XOR A
000930 D64E C9              10      RET
                                
       D64F                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000931 D64F 7B               4      LD  A,E
000932 D650 CD80DC          17      CALL    GETDRV
000935 D653 CDDCF0          17      CALL    _GETDPB
000938 D656 D4E2F0          17      CALL    NC,_RDFATX
00093B D659 210000          10      LD  HL,0
00093E D65C D49BE0          17      CALL    NC,DSKF
                                
000941 D65F ED5B9CE0        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000945 D663 1B               6      DEC DE      ;DE←クラスタの総数
000946 D664 FD2A7CF1        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
00094A D668 9F               4      SBC A,A
00094B D669 D8              11      RET C
00094C D66A 4F               4      LD  C,A     ;C=0
00094D D66B DD7E0F          19      LD  A,(IX+DPB_BPS)
000950 D66E E607             7      AND 7
000952 D670 47               4      LD  B,A
000953 D671 DD7E07          19      LD  A,(IX+DPB_SECPCL)
000956 D674 C9              10      RET
                                
       D675                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000957 D675 AF               4      XOR A
000958 D676 67               4      LD  H,A
000959 D677 6F               4      LD  L,A
00095A D678 C9              10      RET
                                
       D679                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
00095B D679 2100F2          10      LD  HL,_DEVICE
00095E D67C 7B               4      LD  A,E
00095F D67D C3DCF0          10      JP  _GETDPB
                                
       D680                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000962 D680 E5              11      PUSH    HL
000963 D681 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000965 D683 CD45D4          17      CALL    BDOS0
000968 D686 381B            12      JR  C,_S23X1
                                
00096A D688 D5              11      PUSH    DE      ;EX DE,IY
00096B D689 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00096D D68B FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000970 D68E FD6E11          19      LD  L,(IY+17)   ;
000973 D691 FD6612          19      LD  H,(IY+18)   ;
000976 D694 C5              11      PUSH    BC      ;
000977 D695 FD4613          19      LD  B,(IY+19)   ;
00097A D698 CDFFE0          17      CALL    GET_CPM_R_SIZE
00097D D69B C1              10      POP BC
       D69C                     _S24X1:
00097E D69C CD1FE1          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000981 D69F FDE3            23      EX  (SP),IY     ;
000983 D6A1 D1              10      POP DE      ;
                                
000984 D6A2 AF               4      XOR A
       D6A3                     _S23X1:
000985 D6A3 E1              10      POP HL
000986 D6A4 C9              10      RET
                                
       D6A5                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000987 D6A5 E5              11      PUSH    HL
000988 D6A6 D5              11      PUSH    DE      ;EX DE,IY
000989 D6A7 FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00098B D6A9 CD3DE4          17      CALL    GETSEQ
00098E D6AC 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D6AE                     _SYS5C:     ;(BDOS)ファイル名の解析(_PFILE)
000990 D6AE 2B               6      DEC HL
       D6AF                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000991 D6AF C5              11      PUSH    BC
000992 D6B0 E5              11      PUSH    HL
000993 D6B1 CD8ADB          17      CALL    FILE
000996 D6B4 E1              10      POP HL
000997 D6B5 C1              10      POP BC
       D6B6                     S29X1:
000998 D6B6 C5              11      PUSH    BC
000999 D6B7 D5              11      PUSH    DE
00099A D6B8 E5              11      PUSH    HL
00099B D6B9 EB               4      EX  DE,HL
00099C D6BA AF               4      XOR A
00099D D6BB 3221F0          13      LD  (FDRV+13),A
0009A0 D6BE 2114F0          10      LD  HL,FDRV
0009A3 D6C1 011000          10      LD  BC,16
0009A6 D6C4 EDB0                    LDIR
0009A8 D6C6 E1              10      POP HL
0009A9 D6C7 D1              10      POP DE
0009AA D6C8 C1              10      POP BC
0009AB D6C9 C9              10      RET
                                
       D6CA                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
0009AC D6CA C5              11      PUSH    BC
0009AD D6CB 0181E7          10      LD  BC,DWT24B
0009B0 D6CE 1804            12      JR  S2FX
       D6D0                     _SYS2F:
0009B2 D6D0 C5              11      PUSH    BC
0009B3 D6D1 0173E7          10      LD  BC,DRD24B
       D6D4                     S2FX:
0009B6 D6D4 ED43EAD6        20      LD  (S2F_SWC),BC
0009BA D6D8 CDDFF0          17      CALL    _FFLUSH
                                
0009BD D6DB D5              11      PUSH    DE
0009BE D6DC E5              11      PUSH    HL
0009BF D6DD 7D               4      LD  A,L     ;Drive
0009C0 D6DE CDD9F0          17      CALL    _CHGDRV
0009C3 D6E1 3809            12      JR  C,POP_HL_DE_BC_SBCAA_RET
0009C5 D6E3 44               4      LD  B,H     ;Number of clusters
0009C6 D6E4 2A8AF0          16      LD  HL,(_DTA)
                                
0009C9 D6E7 0E00             7      LD  C,0
0009CB D6E9 CD73E7          17      CALL    DRD24B
       D6EA                     S2F_SWC EQU $-2
       D6EC                     POP_HL_DE_BC_SBCAA_RET:
0009CE D6EC E1              10      POP HL
0009CF D6ED D1              10      POP DE
0009D0 D6EE C1              10      POP BC
0009D1 D6EF 9F               4      SBC A,A
0009D2 D6F0 C9              10      RET
                                
       D6F1                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
0009D3 D6F1 C5              11      PUSH    BC
0009D4 D6F2 D5              11      PUSH    DE
0009D5 D6F3 E5              11      PUSH    HL
0009D6 D6F4 CD7FDB          17      CALL    FILEC
0009D9 D6F7 21ECD6          10      LD  HL,POP_HL_DE_BC_SBCAA_RET
0009DC D6FA E5              11      PUSH    HL
0009DD D6FB 3A21F0          13      LD  A,(FDRV+13) ;(FCB)属性(アトリビュート))
0009E0 D6FE E610             7      AND 010H        ;ディレクトリ
0009E2 D700 37               4      SCF
0009E3 D701 C8              11      RET Z
0009E4 D702 1114F0          10      LD  DE,FDRV
0009E7 D705 2A4EF1          16      LD  HL,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       D708                     JPHL:
0009EA D708 E9               4      JP  (HL)
                                
       D709                     SHOW_ERROR:         ;(9)
0009EB D709 1179F0          10      LD  DE,COMERM
0009EE D70C CD76D4          17      CALL    _SYS09      ;(BDOS)文字列出力
0009F1 D70F C300F0          10      JP  CPM_BOOT
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "M7IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                
       D474                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D474                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D474                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D474                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D474                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D474                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
                                #IF EXISTS USE_8253
                                ARWKEY:
                                    DEC A
                                    LD  (KEYAR),A
                                    JR  INT8253E
                                SETKEY1:
                                    LD  A,(_KEYSP_H)
                                    JR  SETKEY
                                INT8253:
                                    CALL    CHKEY
                                    CP  0
                                KEYDT   EQU $-1
                                    JR  NZ,SETKEY1
                                    PUSH    HL
                                    LD  HL,(_KEYPS)
                                    LD  A,H
                                    XOR L
                                    POP HL
                                    JR  NZ,INT8253E
                                    LD  A,0
                                KEYAR   EQU $-1
                                    OR  A
                                    JR  NZ,ARWKEY
                                SETKEY:
                                    LD  (KEYAR),A
                                    CALL    GETKEYD
                                    LD  (KEYDT),A
                                    CALL    KEYSET
                                INT8253E:
                                    LD  A,0
                                INTMEM_SWC  EQU $-1
                                    CP  0C9H        ;RAMの場合はEXTBIOにRETが入っている
                                    JP  NZ,ROM8253E
                                    POP AF
                                    EI
                                    RET
                                KEYSET:
                                KEYBS:
                                    OR  A
                                    RET Z
                                KEYBS1:
                                    CALL    KEYBC_IFBREAK
                                    PUSH    HL
                                    PUSH    AF
                                    LD  HL,(_KEYPS)
                                    INC L
                                    RES 5,L
                                    LD  A,L
                                    CP  H
                                    JR  Z,POP_AF_HL_SCF_RET
                                    LD  (_KEYPS),A
                                    LD  H,HIGH KEYBF
                                    POP AF
                                    LD  (HL),A
                                    POP HL
                                    RET
                                KEYBC_IFBREAK:
                                    CP  3
                                    RET NZ
                                KEYBC:
                                    PUSH    HL
                                    LD  HL,0
                                    LD  (_KEYPS),HL
                                    POP HL
                                    RET
                                #ENDIF
                                
       D712                     POP_AF_HL_SCF_RET:
0009F4 D712 F1              10      POP AF
0009F5 D713 E1              10      POP HL
0009F6 D714 37               4      SCF
                                #IF EXISTS USE_8253
                                #ELSE
       D715                     KEYBC_IFBREAK:
                                #ENDIF
0009F7 D715 C9              10      RET
                                
       D716                     _SYS01:     ;(BDOS)コンソール入力
0009F8 D716 CD09F0          17      CALL    _SYS07
       D719                     MSG_A:
0009FB D719 F5              11      PUSH    AF
0009FC D71A D5              11      PUSH    DE
0009FD D71B 5F               4      LD  E,A
0009FE D71C CD22D7          17      CALL    _SYS02
000A01 D71F D1              10      POP DE
000A02 D720 F1              10      POP AF
000A03 D721 C9              10      RET
                                
       D722                     _SYS02:     ;(BDOS)コンソール出力
000A04 D722 CD34D7          17      CALL    BREAK
000A07 D725 1805            12      JR  PRINTX
                                
       D727                     _SYS06:     ;(BDOS)コンソール直接入出力
000A09 D727 7B               4      LD  A,E
000A0A D728 3C               4      INC A
000A0B D729 CACAF0          10      JP  Z,_INKEY
       D72C                     PRINTX:
000A0E D72C C3CDF0          10      JP  _PRINT
                                
       D72F                     _SYS08:     ;(BDOS)エコーなしコンソール入力
000A11 D72F CD09F0          17      CALL    _SYS07
000A14 D732 1803            12      JR  BREAK1
       D734                     BREAK:
                                #IF EXISTS USE_8253
                                    EI
                                    LD  A,(_KEYD)
                                #ELSE
000A16 D734 CDE8DA          17      CALL    CHKEY
                                #ENDIF
       D737                     BREAK1:
000A19 D737 FE03             7      CP  3       ;CTRL+C
000A1B D739 CCF4F0          17      CALL    Z,_BREAK
000A1E D73C FE13             7      CP  013H        ;CTRL+S
000A20 D73E C0              11      RET NZ
                                
       D73F                     PAUSE:
                                #IF EXISTS USE_8253
                                    CALL    KEYBC
                                #ENDIF
                                
       D73F                     FLGET:
000A21 D73F CDDFF0          17      CALL    _FFLUSH
000A24 D742 E5              11      PUSH    HL
000A25 D743 2A8EF0          16      LD  HL,(_TXADR)
000A28 D746 7C               4      LD  A,H
000A29 D747 C6D0             7      ADD A,0D0H
000A2B D749 67               4      LD  H,A
000A2C D74A CD25CF          17      CALL    RDMMIO
000A2F D74D 3262D7          13      LD  (FLSMC),A
       D750                     FLGET1:
000A32 D750 CD1BCF          17      CALL    RD556VSYNC
000A35 D753 CB77             8      BIT 6,A
000A37 D755 3EEF             7      LD  A,0EFH      ;カーソル
000A39 D757 280A            12      JR  Z,FLGET2
000A3B D759 CD9FDA          17      CALL    GETKEYD
000A3E D75C B7               4      OR  A
000A3F D75D 3EEF             7      LD  A,0EFH      ;カーソル
000A41 D75F 2002            12      JR  NZ,FLGET2
000A43 D761 3E00             7      LD  A,0     ;自己書き換え
       D762                     FLSMC   EQU $-1
       D763                     FLGET2:
000A45 D763 CD2DCF          17      CALL    WRMMIO
000A48 D766 CDCAF0          17      CALL    _INKEY
000A4B D769 28E5            12      JR  Z,FLGET1
000A4D D76B F5              11      PUSH    AF
000A4E D76C 3A62D7          13      LD  A,(FLSMC)
000A51 D76F CD2DCF          17      CALL    WRMMIO
000A54 D772 F1              10      POP AF
000A55 D773 E1              10      POP HL
000A56 D774 C9              10      RET
                                
       D775                     _SYS0A:     ;(BDOS)文字列入力
000A57 D775 C5              11      PUSH    BC
000A58 D776 E5              11      PUSH    HL
000A59 D777 D5              11      PUSH    DE
000A5A D778 CD16DA          17      CALL    GETL
000A5D D77B 1130FF          10      LD  DE,KBUF
000A60 D77E E1              10      POP HL
000A61 D77F E5              11      PUSH    HL
000A62 D780 0E00             7      LD  C,0
000A64 D782 3004            12      JR  NC,SAX0
000A66 D784 23               6      INC HL
000A67 D785 23               6      INC HL
000A68 D786 1808            12      JR  SAX4
       D788                     SAX0:
000A6A D788 46               7      LD  B,(HL)
000A6B D789 23               6      INC HL
       D78A                     SAX1:
000A6C D78A 23               6      INC HL
000A6D D78B 1A               7      LD  A,(DE)
000A6E D78C 13               6      INC DE
000A6F D78D B7               4      OR  A
000A70 D78E 2004            12      JR  NZ,SAX2
       D790                     SAX4:
000A72 D790 360D            10      LD  (HL),00DH
000A74 D792 1804            12      JR  SAX3
       D794                     SAX2:
000A76 D794 77               7      LD  (HL),A
000A77 D795 0C               4      INC C
000A78 D796 10F2            13      DJNZ    SAX1
       D798                     SAX3:
000A7A D798 D1              10      POP DE
000A7B D799 79               4      LD  A,C
000A7C D79A 13               6      INC DE
000A7D D79B 12               7      LD  (DE),A
000A7E D79C 1B               6      DEC DE
000A7F D79D E1              10      POP HL
000A80 D79E C1              10      POP BC
000A81 D79F A7               4      AND A
000A82 D7A0 C9              10      RET
                                
       D7A1                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000A83 D7A1 CD34D7          17      CALL    BREAK
000A86 D7A4 B7               4      OR  A
000A87 D7A5 C8              11      RET Z
                                
       D7A6                     CONSTX:
000A88 D7A6 CDDFF0          17      CALL    _FFLUSH
                                #IF EXISTS USE_8253
                                    PUSH    HL
                                    LD  HL,(_KEYPS)
                                    LD  A,H
                                    XOR L
                                    POP HL
                                    ADD A,0FFH
                                #ELSE
000A8B D7A9 AF               4      XOR A
000A8C D7AA 32B6DA          13      LD  (SKIP_KEYWAIT),A
000A8F D7AD CDE8DA          17      CALL    CHKEY
000A92 D7B0 C8              11      RET Z
000A93 D7B1 37               4      SCF
                                #ENDIF
000A94 D7B2 9F               4      SBC A,A
000A95 D7B3 C9              10      RET
                                
       D7B4                     _SYS2A:     ;(BDOS)日付の獲得
       D7B4                     _SYS2C:     ;(BDOS)時刻の獲得
000A96 D7B4 AF               4      XOR A
000A97 D7B5 57               4      LD  D,A
000A98 D7B6 5F               4      LD  E,A
000A99 D7B7 67               4      LD  H,A
000A9A D7B8 6F               4      LD  L,A
000A9B D7B9 C9              10      RET
                                
       D7BA                     ESC1:
000A9C D7BA 7B               4      LD  A,E
000A9D D7BB FE41             7      CP  'A'
000A9F D7BD CAB2D8          10      JP  Z,CTRL1E
000AA2 D7C0 FE42             7      CP  'B'
000AA4 D7C2 CAD9D9          10      JP  Z,CTRL1F
000AA7 D7C5 FE43             7      CP  'C'
000AA9 D7C7 CA85D8          10      JP  Z,CTRL1C
000AAC D7CA FE44             7      CP  'D'
000AAE D7CC CAA9D8          10      JP  Z,CTRL1D
000AB1 D7CF FE45             7      CP  'E'
000AB3 D7D1 2802            12      JR  Z,CT0CX
000AB5 D7D3 FE6A             7      CP  'j'
       D7D5                     CT0CX:
000AB7 D7D5 CABED9          10      JP  Z,CTRL0C
000ABA D7D8 FE48             7      CP  'H'
000ABC D7DA CA2BD9          10      JP  Z,CTRL0B
000ABF D7DD FE4A             7      CP  'J'
000AC1 D7DF CAC1D9          10      JP  Z,CTRL06
000AC4 D7E2 FE4B             7      CP  'K'
000AC6 D7E4 CAFDD8          10      JP  Z,CTRL05
000AC9 D7E7 FE4C             7      CP  'L'
000ACB D7E9 CAEBD9          10      JP  Z,CTRL0E
000ACE D7EC FE54             7      CP  'T'
000AD0 D7EE CAFDD8          10      JP  Z,CTRL05
000AD3 D7F1 FE78             7      CP  'x'
000AD5 D7F3 2804            12      JR  Z,ESC1X
000AD7 D7F5 FE79             7      CP  'y'
000AD9 D7F7 2002            12      JR  NZ,ESC1Y
       D7F9                     ESC1X:
000ADB D7F9 3601            10      LD  (HL),1
       D7FB                     ESC1Y:
000ADD D7FB FE3D             7      CP  '='
000ADF D7FD 2804            12      JR  Z,ESC1W
000AE1 D7FF FE59             7      CP  'Y'
000AE3 D801 2002            12      JR  NZ,ESC1Z
       D803                     ESC1W:
000AE5 D803 3602            10      LD  (HL),2
       D805                     ESC1Z:
000AE7 D805 FE20             7      CP  020H
000AE9 D807 3802            12      JR  C,ESC1C
000AEB D809 87               4      ADD A,A
000AEC D80A D0              11      RET NC
       D80B                     ESC1C:
000AED D80B E1              10      POP HL
000AEE D80C 1832            12      JR  ANK
                                
       D80E                     ESC:
000AF0 D80E 2171D8          10      LD  HL,PRINTE5
000AF3 D811 E5              11      PUSH    HL
000AF4 D812 2134D8          10      LD  HL,ESCFLG
000AF7 D815 3600            10      LD  (HL),0
000AF9 D817 3D               4      DEC A
000AFA D818 28A0            12      JR  Z,ESC1
000AFC D81A 3D               4      DEC A
000AFD D81B 2009            12      JR  NZ,ESC2
000AFF D81D 3603            10      LD  (HL),3
000B01 D81F 7B               4      LD  A,E
000B02 D820 D620             7      SUB 020H
000B04 D822 3229D8          13      LD  (ESCYP+1),A
000B07 D825 C9              10      RET
       D826                     ESC2:
000B08 D826 3D               4      DEC A
000B09 D827 C0              11      RET NZ
000B0A D828 2600             7  ESCYP:  LD  H,0
000B0C D82A 7B               4      LD  A,E
000B0D D82B D620             7      SUB 020H
000B0F D82D 6F               4      LD  L,A
000B10 D82E C3D6F0          10      JP  _LOC
                                
       D831                     PRINT:
000B13 D831 C5              11      PUSH    BC
000B14 D832 E5              11      PUSH    HL
000B15 D833 3E00             7      LD  A,000H      ;自己書き換え
       D834                     ESCFLG  EQU $-1
000B17 D835 B7               4      OR  A
000B18 D836 20D6            12      JR  NZ,ESC
                                
000B1A D838 3E1F             7      LD  A,01FH
000B1C D83A BB               4      CP  E
000B1D D83B 3038            12      JR  NC,CTRL
       D83D                     INSFLG  EQU $
000B1F D83D 0187D9          10      LD  BC,INSERT   ;自己書き換え
       D840                     ANK:
000B22 D840 3A96F0          13      LD  A,(_COLORF)
000B25 D843 4F               4      LD  C,A
000B26 D844 7B               4      LD  A,E
000B27 D845 FE61             7      CP  'a'     ;英小文字
000B29 D847 3806            12      JR  C,PRT1
000B2B D849 FE7B             7      CP  'z'+1
000B2D D84B 3002            12      JR  NC,PRT1
000B2F D84D CBF9             8      SET 7,C
       D84F                     PRT1:
000B31 D84F FE86             7      CP  $86     ;ひらがな1(を－そ)
000B33 D851 3806            12      JR  C,PRT2
000B35 D853 FEA0             7      CP  $A0
000B37 D855 3002            12      JR  NC,PRT2
000B39 D857 CBF9             8      SET 7,C
       D859                     PRT2:
000B3B D859 FEE0             7      CP  $E0     ;ひらがな2(たーん)
000B3D D85B 3802            12      JR  C,PRT3
000B3F D85D CBF9             8      SET 7,C
       D85F                     PRT3:
000B41 D85F 2A8EF0          16      LD  HL,(_TXADR)
000B44 D862 7C               4      LD  A,H
000B45 D863 C6D0             7      ADD A,0D0H
000B47 D865 67               4      LD  H,A
000B48 D866 42               4      LD  B,D
000B49 D867 16EE             7      LD  D,HIGH CD_TABLE
000B4B D869 1A               7      LD  A,(DE)
000B4C D86A 50               4      LD  D,B
000B4D D86B CD45CF          17      CALL    IO_PRINT
000B50 D86E CD85D8          17      CALL    CTRL1C
       D871                     PRINTE5:
000B53 D871 E1              10      POP HL
000B54 D872 C1              10      POP BC
000B55 D873 AF               4      XOR A
000B56 D874 C9              10      RET
                                
       D875                     CTRL:
000B57 D875 7B               4      LD  A,E
000B58 D876 87               4      ADD A,A
000B59 D877 F680             7      OR  080H
000B5B D879 6F               4      LD  L,A
000B5C D87A 26F1             7      LD  H,HIGH CTRLTB
000B5E D87C 7E               7      LD  A,(HL)
000B5F D87D 2C               4      INC L
000B60 D87E 66               7      LD  H,(HL)
000B61 D87F 6F               4      LD  L,A
000B62 D880 CD08D7          17      CALL    JPHL
000B65 D883 18EC            12      JR  PRINTE5
                                
       D885                     CTRL1C:
000B67 D885 ED4B8EF0        20      LD  BC,(_TXADR)
000B6B D889 03               6      INC BC
       D88A                     PRINTE3:
000B6C D88A 2118FC          10      LD  HL,0-WIDTH*LINE
000B6F D88D A7               4      AND A
000B70 D88E ED4A            15      ADC HL,BC
       D890                     PRINTE8:
000B72 D890 2805            12      JR  Z,PRINT2
000B74 D892 ED438EF0        20      LD  (_TXADR),BC
       D896                     CTRL00:
000B78 D896 C9              10      RET
                                
       D897                     PRINT2:
000B79 D897 CDF1D9          17      CALL    SCR
000B7C D89A 21D8FF          10      LD  HL,0-WIDTH
000B7F D89D 09              11      ADD HL,BC
       D89E                     SET_TXADR_HL:
000B80 D89E 228EF0          16      LD  (_TXADR),HL
000B83 D8A1 C9              10      RET
                                
       D8A2                     CTRL08:
000B84 D8A2 3A3DD8          13      LD  A,(INSFLG)
000B87 D8A5 FECD             7      CP  0CDH        ;CALL ????
000B89 D8A7 2823            12      JR  Z,CTRL02
       D8A9                     CTRL1D:
000B8B D8A9 2A8EF0          16      LD  HL,(_TXADR)
000B8E D8AC 7C               4      LD  A,H
000B8F D8AD B5               4      OR  L
000B90 D8AE C8              11      RET Z
000B91 D8AF 2B               6      DEC HL
000B92 D8B0 18EC            12      JR  SET_TXADR_HL
                                
       D8B2                     CTRL1E:
000B94 D8B2 ED4B8EF0        20      LD  BC,(_TXADR)
000B98 D8B6 21D8FF          10      LD  HL,0-WIDTH
000B9B D8B9 09              11      ADD HL,BC
000B9C D8BA D0              11      RET NC
000B9D D8BB 18E1            12      JR  SET_TXADR_HL
                                
       D8BD                     CTRL09:
000B9F D8BD ED4B8EF0        20      LD  BC,(_TXADR)
000BA3 D8C1 79               4      LD  A,C
000BA4 D8C2 E6F8             7      AND 0F8H
000BA6 D8C4 C608             7      ADD A,8
000BA8 D8C6 4F               4      LD  C,A
000BA9 D8C7 88               4      ADC A,B
000BAA D8C8 91               4      SUB C
000BAB D8C9 47               4      LD  B,A
000BAC D8CA 18BE            12      JR  PRINTE3
                                
       D8CC                     CTRL02:
000BAE D8CC CDA9D8          17      CALL    CTRL1D
000BB1 D8CF C8              11      RET Z
000BB2 D8D0 D5              11      PUSH    DE
000BB3 D8D1 CDD3F0          17      CALL    _POS
000BB6 D8D4 54               4      LD  D,H
000BB7 D8D5 3E28             7      LD  A,WIDTH
000BB9 D8D7 95               4      SUB L
000BBA D8D8 4F               4      LD  C,A
000BBB D8D9 0D               4      DEC C
000BBC D8DA 06D0             7      LD  B,0D0H
000BBE D8DC 2A8EF0          16      LD  HL,(_TXADR)
000BC1 D8DF 09              11      ADD HL,BC
000BC2 D8E0 47               4      LD  B,A
                                
000BC3 D8E1 3AA8D9          13      LD  A,(MULINE)
000BC6 D8E4 BA               4      CP  D
000BC7 D8E5 2007            12      JR  NZ,C02X1
000BC9 D8E7 112800          10      LD  DE,WIDTH
000BCC D8EA 19              11      ADD HL,DE
000BCD D8EB 78               4      LD  A,B
000BCE D8EC 83               4      ADD A,E
000BCF D8ED 47               4      LD  B,A
       D8EE                     C02X1:
000BD0 D8EE 3A96F0          13      LD  A,(_COLORF) ;C:Color
000BD3 D8F1 4F               4      LD  C,A
000BD4 D8F2 3E                      DB  03EH        ;LD A,?
000BD5 D8F3 2B               6      DEC HL
000BD6 D8F4 328CCF          13      LD  (IO_INCDEC),A
000BD9 D8F7 AF               4      XOR A       ;A:Text
000BDA D8F8 CD7FCF          17      CALL    IO_INSBS
000BDD D8FB D1              10      POP DE
000BDE D8FC C9              10      RET
                                
       D8FD                     CTRL05:
000BDF D8FD CDD3F0          17      CALL    _POS
000BE2 D900 3E28             7      LD  A,WIDTH
000BE4 D902 95               4      SUB L
000BE5 D903 47               4      LD  B,A
       D904                     C08X1:
000BE6 D904 2A8EF0          16      LD  HL,(_TXADR)
000BE9 D907 7C               4      LD  A,H
000BEA D908 C6D0             7      ADD A,0D0H
000BEC D90A 67               4      LD  H,A
       D90B                     CLLINE:
000BED D90B 3A96F0          13      LD  A,(_COLORF)
000BF0 D90E 4F               4      LD  C,A
000BF1 D90F AF               4      XOR A
000BF2 D910 C36FCF          10      JP  IO_CLLINE
                                
       D913                     CTRL0D:
000BF5 D913 CDD3F0          17      CALL    _POS
000BF8 D916 2E00             7      LD  L,0
       D918                     LOC:
000BFA D918 C5              11      PUSH    BC
000BFB D919 E5              11      PUSH    HL
000BFC D91A CD38D9          17      CALL    LOC1
000BFF D91D 228EF0          16      LD  (_TXADR),HL
000C02 D920 E1              10      POP HL
000C03 D921 C1              10      POP BC
000C04 D922 C9              10      RET
                                
       D923                     CTRL12:
000C05 D923 213DD8          10      LD  HL,INSFLG
000C08 D926 7E               7      LD  A,(HL)
000C09 D927 EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000C0B D929 77               7      LD  (HL),A
000C0C D92A C9              10      RET
                                
       D92B                     CTRL0B:
000C0D D92B 210000          10      LD  HL,0
000C10 D92E 228EF0          16      LD  (_TXADR),HL
000C13 D931 C9              10      RET
                                
       D932                     CTRL1B:
000C14 D932 3E01             7      LD  A,1
000C16 D934 3234D8          13      LD  (ESCFLG),A
000C19 D937 C9              10      RET
                                
       D938                     LOC1:
000C1A D938 D5              11      PUSH    DE
000C1B D939 4D               4      LD  C,L
000C1C D93A 0608             7      LD  B,8
000C1E D93C 5C               4      LD  E,H
000C1F D93D 210028          10      LD  HL,WIDTH*256
000C22 D940 55               4      LD  D,L ;L=0
       D941                     LOC2:
000C23 D941 29              11      ADD HL,HL
000C24 D942 3001            12      JR  NC,LOC3
000C26 D944 19              11      ADD HL,DE
       D945                     LOC3:
000C27 D945 10FA            13      DJNZ    LOC2
000C29 D947 09              11      ADD HL,BC
000C2A D948 D1              10      POP DE
000C2B D949 C9              10      RET
                                
       D94A                     CONOUT1:
                                ;   CALL    CURSOR
000C2C D94A 59               4      LD  E,C
000C2D D94B CDCDF0          17      CALL    _PRINT
000C30 D94E 7B               4      LD  A,E
000C31 D94F FE0A             7      CP  00AH
000C33 D951 2006            12      JR  NZ,CURSOR
000C35 D953 CD13D9          17      CALL    CTRL0D
000C38 D956 CDFDD8          17      CALL    CTRL05
       D959                     CURSOR:
000C3B D959 C9              10      RET
                                
       D95A                     CTRL07:
000C3C D95A 06E0             7      LD  B,0E0H
000C3E D95C 2162F0          10      LD  HL,BEEPD+1
       D95F                     C07X0:
000C41 D95F 4E               7      LD  C,(HL)
000C42 D960 23               6      INC HL
000C43 D961 7E               7      LD  A,(HL)
000C44 D962 23               6      INC HL
000C45 D963 CD3DCF          17      CALL    WRMMIO_BC
000C48 D966 7D               4      LD  A,L
000C49 D967 FE6C             7      CP  (BEEPD+1+M7BEEPE-M7BEEPD)&255
000C4B D969 20F4            12      JR  NZ,C07X0
000C4D D96B 0610             7      LD  B,16
       D96D                     C07X1:
000C4F D96D CD1BCF          17      CALL    RD556VSYNC
000C52 D970 87               4      ADD A,A
000C53 D971 30FA            12      JR  NC,C07X1
       D973                     C07X2:
000C55 D973 CD1BCF          17      CALL    RD556VSYNC
000C58 D976 87               4      ADD A,A
000C59 D977 38FA            12      JR  C,C07X2
000C5B D979 10F2            13      DJNZ    C07X1
                                
000C5D D97B AF               4      XOR A
000C5E D97C 2108E0          10      LD  HL,0E008H
000C61 D97F CD2DCF          17      CALL    WRMMIO
000C64 D982 2E03             7      LD  L,003H      ;SOUND MASK (MZ-1500)
000C66 D984 C32DCF          10      JP  WRMMIO
                                
       D987                     INSERT:
000C69 D987 D5              11      PUSH    DE
000C6A D988 CDD3F0          17      CALL    _POS
000C6D D98B 54               4      LD  D,H
000C6E D98C 3E28             7      LD  A,WIDTH
000C70 D98E 95               4      SUB L
000C71 D98F 47               4      LD  B,A
000C72 D990 2A8EF0          16      LD  HL,(_TXADR)
000C75 D993 7C               4      LD  A,H
000C76 D994 C6D0             7      ADD A,0D0H
000C78 D996 67               4      LD  H,A
000C79 D997 3A96F0          13      LD  A,(_COLORF) ;C:Color
000C7C D99A 4F               4      LD  C,A
000C7D D99B 3E                      DB  03EH        ;LD A,?
000C7E D99C 23               6      INC HL
000C7F D99D 328CCF          13      LD  (IO_INCDEC),A
000C82 D9A0 AF               4      XOR A       ;A:Text
000C83 D9A1 CD7FCF          17      CALL    IO_INSBS
000C86 D9A4 B7               4      OR  A
000C87 D9A5 2005            12      JR  NZ,INS1
       D9A8                     MULINE  EQU $+1
000C89 D9A7 3EFF             7      LD  A,-1
000C8B D9A9 92               4      SUB D
000C8C D9AA 2010            12      JR  NZ,INS2
       D9AC                     INS1:
000C8E D9AC 0628             7      LD  B,WIDTH
000C90 D9AE F5              11      PUSH    AF
000C91 D9AF 3E                      DB  03EH        ;LD A,?
000C92 D9B0 23               6      INC HL
000C93 D9B1 328CCF          13      LD  (IO_INCDEC),A
000C96 D9B4 F1              10      POP AF
000C97 D9B5 CD7FCF          17      CALL    IO_INSBS
000C9A D9B8 7A               4      LD  A,D
000C9B D9B9 32A8D9          13      LD  (MULINE),A
       D9BC                     INS2:
000C9E D9BC D1              10      POP DE
000C9F D9BD C9              10      RET
                                
       D9BE                     CTRL0C:
000CA0 D9BE CD2BD9          17      CALL    CTRL0B
       D9C1                     CTRL06:
000CA3 D9C1 D5              11      PUSH    DE
000CA4 D9C2 E5              11      PUSH    HL
000CA5 D9C3 ED5B8EF0        20      LD  DE,(_TXADR)
000CA9 D9C7 3A96F0          13      LD  A,(_COLORF)
000CAC D9CA 325CCF          13      LD  (ICSMC),A
000CAF D9CD C350CF          10      JP  IO_CLR
                                
       D9D0                     CTRL04:
000CB2 D9D0 CDD3F0          17      CALL    _POS
000CB5 D9D3 7D               4      LD  A,L
000CB6 D9D4 B7               4      OR  A
000CB7 D9D5 C8              11      RET Z
       D9D6                     CTRL03:
000CB8 D9D6 CD13D9          17      CALL    CTRL0D
       D9D9                     CTRL0A:
       D9D9                     CTRL1F:
000CBB D9D9 2A8EF0          16      LD  HL,(_TXADR)
000CBE D9DC 012800          10      LD  BC,WIDTH
000CC1 D9DF 09              11      ADD HL,BC
000CC2 D9E0 44               4      LD  B,H
000CC3 D9E1 4D               4      LD  C,L
000CC4 D9E2 2118FC          10      LD  HL,0-WIDTH*LINE
000CC7 D9E5 09              11      ADD HL,BC
000CC8 D9E6 3F               4      CCF
000CC9 D9E7 9F               4      SBC A,A
000CCA D9E8 C390D8          10      JP  PRINTE8
                                
       D9EB                     CTRL0E:
000CCD D9EB CDD3F0          17      CALL    _POS
000CD0 D9EE 7C               4      LD  A,H
000CD1 D9EF 1804            12      JR  SCR1
       D9F1                     SCR:
000CD3 D9F1 3A97F0          13      LD  A,(_LINE)
000CD6 D9F4 3D               4      DEC A
       D9F5                     SCR1:
000CD7 D9F5 C5              11      PUSH    BC
000CD8 D9F6 D5              11      PUSH    DE
000CD9 D9F7 E5              11      PUSH    HL
000CDA D9F8 1100D0          10      LD  DE,0D000H
000CDD D9FB 2128D0          10      LD  HL,0D000H+WIDTH
                                
000CE0 D9FE 47               4      LD  B,A
000CE1 D9FF B7               4      OR  A
000CE2 DA00 C393CF          10      JP  IO_SCRUP
                                
       DA03                     POS:
000CE5 DA03 2A8EF0          16      LD  HL,(_TXADR)
000CE8 DA06 C5              11      PUSH    BC
000CE9 DA07 01D8FF          10      LD  BC,0-WIDTH
000CEC DA0A AF               4      XOR A
       DA0B                     POS1:
000CED DA0B 09              11      ADD HL,BC
000CEE DA0C 3C               4      INC A
000CEF DA0D 38FC            12      JR  C,POS1
000CF1 DA0F ED42            15      SBC HL,BC
000CF3 DA11 3D               4      DEC A
000CF4 DA12 67               4      LD  H,A
000CF5 DA13 C1              10      POP BC
000CF6 DA14 A7               4      AND A
000CF7 DA15 C9              10      RET
                                
       DA16                     GETL:
000CF8 DA16 CDD3F0          17      CALL    _POS
000CFB DA19 E5              11      PUSH    HL
000CFC DA1A 3ECD             7      LD  A,0CDH      ;CALL ????
000CFE DA1C 323DD8          13      LD  (INSFLG),A
       DA1F                     GETL1:
000D01 DA1F CD2FD7          17      CALL    _SYS08
000D04 DA22 FE09             7      CP  9
000D06 DA24 2008            12      JR  NZ,GETL1V
000D08 DA26 2130FF          10      LD  HL,KBUF
000D0B DA29 CD85D4          17      CALL    MSX
000D0E DA2C 18F1            12      JR  GETL1
       DA2E                     GETL1V:
000D10 DA2E 5F               4      LD  E,A
000D11 DA2F CDD3F0          17      CALL    _POS
000D14 DA32 CDCDF0          17      CALL    _PRINT
000D17 DA35 7B               4      LD  A,E
000D18 DA36 FE20             7      CP  $20
000D1A DA38 3809            12      JR  C,GETL1V1
000D1C DA3A 7D               4      LD  A,L
000D1D DA3B FE27             7      CP  WIDTH-1
000D1F DA3D 2004            12      JR  NZ,GETL1V1
000D21 DA3F 7C               4      LD  A,H
000D22 DA40 32A8D9          13      LD  (MULINE),A
       DA43                     GETL1V1:
000D25 DA43 7B               4      LD  A,E
000D26 DA44 FE0D             7      CP  00DH
000D28 DA46 20D7            12      JR  NZ,GETL1
000D2A DA48 3E01             7      LD  A,1     ;LD BC,????
000D2C DA4A 323DD8          13      LD  (INSFLG),A
000D2F DA4D 1130FF          10      LD  DE,KBUF
000D32 DA50 0628             7      LD  B,WIDTH
000D34 DA52 CD23D3          17      CALL    ZERO_MEMORY_DE
                                
000D37 DA55 D1              10      POP DE
000D38 DA56 CDD3F0          17      CALL    _POS
000D3B DA59 6B               4      LD  L,E
000D3C DA5A 3E28             7      LD  A,WIDTH
000D3E DA5C 95               4      SUB L
000D3F DA5D 57               4      LD  D,A
                                
000D40 DA5E 3AA8D9          13      LD  A,(MULINE)
000D43 DA61 94               4      SUB H
000D44 DA62 2806            12      JR  Z,GL2X
000D46 DA64 3C               4      INC A
000D47 DA65 200C            12      JR  NZ,GL3X
000D49 DA67 25               4      DEC H
000D4A DA68 1805            12      JR  GL4X
       DA6A                     GL2X:
000D4C DA6A 3E1F             7      LD  A,$1F
000D4E DA6C CD19D7          17      CALL    MSG_A
       DA6F                     GL4X:
000D51 DA6F 7A               4      LD  A,D
000D52 DA70 C628             7      ADD A,WIDTH
000D54 DA72 57               4      LD  D,A
       DA73                     GL3X:
000D55 DA73 CD38D9          17      CALL    LOC1
000D58 DA76 4D               4      LD  C,L
000D59 DA77 7C               4      LD  A,H
000D5A DA78 C6D0             7      ADD A,0D0H
000D5C DA7A 47               4      LD  B,A
000D5D DA7B 5A               4      LD  E,D
000D5E DA7C 2130FF          10      LD  HL,KBUF
       DA7F                     GETL2:
000D61 DA7F CDD0F0          17      CALL    _SCRN
000D64 DA82 03               6      INC BC
000D65 DA83 77               7      LD  (HL),A
000D66 DA84 23               6      INC HL
000D67 DA85 1D               4      DEC E
000D68 DA86 20F7            12      JR  NZ,GETL2
       DA88                     GETL3:
000D6A DA88 2B               6      DEC HL
000D6B DA89 7E               7      LD  A,(HL)
000D6C DA8A FE21             7      CP  021H
000D6E DA8C D0              11      RET NC
000D6F DA8D 3600            10      LD  (HL),0
000D71 DA8F 15               4      DEC D
000D72 DA90 20F6            12      JR  NZ,GETL3
000D74 DA92 C9              10      RET
                                
       DA93                     INKEYB:
000D75 DA93 C1              10      POP BC
000D76 DA94 CB47             8      BIT 0,A
000D78 DA96 3E08             7      LD  A,8
000D7A DA98 2002            12      JR  NZ,SETKEYD
000D7C DA9A 3E03             7      LD  A,3
       DA9C                     SETKEYD:
000D7E DA9C 3292F0          13      LD  (_KEYD),A
       DA9F                     GETKEYD:
000D81 DA9F 3A92F0          13      LD  A,(_KEYD)
000D84 DAA2 B7               4      OR  A
       DAA3                     GETKEYD_SWC:            ;ここがSCFの場合はキーを離すまで戻り値は0になる（自己書き換え）
000D85 DAA3 A7               4      AND A
000D86 DAA4 D0              11      RET NC
000D87 DAA5 2005            12      JR  NZ,GETKEYD1
000D89 DAA7 3E                      DB  03EH
000D8A DAA8 A7               4      AND A
000D8B DAA9 32A3DA          13      LD  (GETKEYD_SWC),A
       DAAC                     GETKEYD1:
000D8E DAAC AF               4      XOR A
000D8F DAAD C9              10      RET
                                
       DAAE                     INKEY:
                                #IF EXISTS USE_8253
                                    EI
                                    PUSH    HL
                                    LD  HL,(_KEYPS)
                                    LD  A,H
                                    XOR L
                                    JR  Z,INKEY1
                                    LD  A,H
                                    INC A
                                    AND 01FH
                                    LD  (_KEYPS+1),A
                                    LD  L,A
                                    LD  H,HIGH KEYBF
                                    LD  A,(HL)
                                INKEY1:
                                    POP HL
                                    OR  A
                                    RET
                                #ELSE
000D90 DAAE E5              11      PUSH    HL
       DAAF                     GETKEY:
000D91 DAAF CD9FDA          17      CALL    GETKEYD
000D94 DAB2 6F               4      LD  L,A
000D95 DAB3 2610             7      LD  H,16
       DAB4                     GKSMC   EQU $-1
       DAB5                     GETKEY1:
000D97 DAB5 3E01             7      LD  A,1
       DAB6                     SKIP_KEYWAIT:   EQU $-1
000D99 DAB7 B7               4      OR  A
000D9A DAB8 C4E8DA          17      CALL    NZ,CHKEY    ;キーを離すまで待つ
000D9D DABB 281E            12      JR  Z,GETKEY2
000D9F DABD BD               4      CP  L
000DA0 DABE 201B            12      JR  NZ,GETKEY2
000DA2 DAC0 CD1BCF          17      CALL    RD556VSYNC
000DA5 DAC3 87               4      ADD A,A
000DA6 DAC4 30EF            12      JR  NC,GETKEY1
       DAC6                     GETKEY1X:
000DA8 DAC6 CDE8DA          17      CALL    CHKEY       ;キーを離すまで待つ
000DAB DAC9 2810            12      JR  Z,GETKEY2
000DAD DACB BD               4      CP  L
000DAE DACC 200D            12      JR  NZ,GETKEY2
000DB0 DACE CD1BCF          17      CALL    RD556VSYNC
000DB3 DAD1 87               4      ADD A,A
000DB4 DAD2 38F2            12      JR  C,GETKEY1X
000DB6 DAD4 25               4      DEC H
000DB7 DAD5 20DE            12      JR  NZ,GETKEY1
000DB9 DAD7 3E01             7      LD  A,1
000DBB DAD9 1805            12      JR  GETKEY3
       DADB                     GETKEY2:
000DBD DADB 3E10             7      LD  A,16
000DBF DADD 32B6DA          13      LD  (SKIP_KEYWAIT),A
       DAE0                     GETKEY3:
000DC2 DAE0 32B4DA          13      LD  (GKSMC),A
000DC5 DAE3 CD9FDA          17      CALL    GETKEYD
000DC8 DAE6 E1              10      POP HL
000DC9 DAE7 C9              10      RET
                                #ENDIF
       DAE8                     CHKEY:
000DCA DAE8 C5              11      PUSH    BC
000DCB DAE9 3E88             7      LD  A,$88
000DCD DAEB CD0ECF          17      CALL    RDKEYDATA
000DD0 DAEE 4F               4      LD  C,A
000DD1 DAEF 3A93F0          13      LD  A,(_KEYST)
000DD4 DAF2 B9               4      CP  C
000DD5 DAF3 79               4      LD  A,C
000DD6 DAF4 3293F0          13      LD  (_KEYST),A
000DD9 DAF7 280F            12      JR  Z,KEYST2
000DDB DAF9 CD9FDA          17      CALL    GETKEYD
000DDE DAFC 2809            12      JR  Z,KEYST1
000DE0 DAFE AF               4      XOR A
000DE1 DAFF 3292F0          13      LD  (_KEYD),A
000DE4 DB02 3E                      DB  03EH
000DE5 DB03 37               4      SCF
000DE6 DB04 32A3DA          13      LD  (GETKEYD_SWC),A
       DB07                     KEYST1:
000DE9 DB07 79               4      LD  A,C
       DB08                     KEYST2:
000DEA DB08 CB7F             8      BIT 7,A
000DEC DB0A 2887            12      JR  Z,INKEYB
000DEE DB0C E5              11      PUSH    HL
000DEF DB0D 0E87             7      LD  C,$87
000DF1 DB0F 2140ED          10      LD  HL,KEY_TABLE
000DF4 DB12 CB47             8      BIT 0,A
000DF6 DB14 2003            12      JR  NZ,CHKEY0
000DF8 DB16 2180ED          10      LD  HL,SHIFT_TABLE
       DB19                     CHKEY0:
000DFB DB19 CB77             8      BIT 6,A
000DFD DB1B 2003            12      JR  NZ,CHKEY1
000DFF DB1D 21C0ED          10      LD  HL,CTRL_TABLE
       DB20                     CHKEY1:
000E02 DB20 79               4      LD  A,C
000E03 DB21 CD0ECF          17      CALL    RDKEYDATA
000E06 DB24 0608             7      LD  B,8
       DB26                     CHKEY2:
000E08 DB26 87               4      ADD A,A
000E09 DB27 300A            12      JR  NC,CHKEY3
000E0B DB29 23               6      INC HL
000E0C DB2A 10FA            13      DJNZ    CHKEY2
000E0E DB2C 0D               4      DEC C
000E0F DB2D CB79             8      BIT 7,C
000E11 DB2F 20EF            12      JR  NZ,CHKEY1
000E13 DB31 AF               4      XOR A
000E14 DB32 06                      DB  $06     ;LD B,?? 次の1バイトを飛ばす
       DB33                     CHKEY3:
000E15 DB33 7E               7      LD  A,(HL)
000E16 DB34 E1              10      POP HL
000E17 DB35 C1              10      POP BC
000E18 DB36 C39CDA          10      JP  SETKEYD
                                
       DB39                     SCRN:
000E1B DB39 E5              11      PUSH    HL
000E1C DB3A CD35CF          17      CALL    RDMMIO_BC
000E1F DB3D 6F               4      LD  L,A
000E20 DB3E 26EF             7      LD  H,HIGH DC_TABLE
000E22 DB40 7E               7      LD  A,(HL)
000E23 DB41 FE41             7      CP  'A'     ;英小文字チェック
000E25 DB43 380E            12      JR  C,SCRN1
000E27 DB45 FE5B             7      CP  'Z'+1
000E29 DB47 DC55DB          17      CALL    C,SCRNC
000E2C DB4A FEA6             7      CP  $A6     ;ひらがなチェック
000E2E DB4C 3805            12      JR  C,SCRN1
000E30 DB4E FEE0             7      CP  $E0
000E32 DB50 DC55DB          17      CALL    C,SCRNC
       DB53                     SCRN1:
000E35 DB53 E1              10      POP HL
000E36 DB54 C9              10      RET
                                
       DB55                     SCRNC:
000E37 DB55 6F               4      LD  L,A
000E38 DB56 60               4      LD  H,B
000E39 DB57 CBD8             8      SET 3,B
000E3B DB59 CD35CF          17      CALL    RDMMIO_BC
000E3E DB5C 44               4      LD  B,H
000E3F DB5D CB7F             8      BIT 7,A
000E41 DB5F 7D               4      LD  A,L
000E42 DB60 C8              11      RET Z
000E43 DB61 FE5B             7      CP  'Z'+1
000E45 DB63 3804            12      JR  C,SCRNC_ADD
000E47 DB65 FEC0             7      CP  $C0
000E49 DB67 3803            12      JR  C,SCRNC_SUB
       DB69                     SCRNC_ADD:
000E4B DB69 C620             7      ADD A,$20
000E4D DB6B C9              10      RET
       DB6C                     SCRNC_SUB:
000E4E DB6C D620             7      SUB $20
000E50 DB6E C9              10      RET
       DB6F                     C_MON:
000E51 DB6F 2100D8          10      LD  HL,0D800H
       DB72                     MON1:
000E54 DB72 3E71             7      LD  A,071H
000E56 DB74 CD2DCF          17      CALL    WRMMIO
000E59 DB77 23               6      INC HL
000E5A DB78 CB54             8      BIT 2,H
000E5C DB7A 28F6            12      JR  Z,MON1
000E5E DB7C C3C7CF          10      JP  IO_MON
[EOF:M7IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
                                ;   【注意】バイナリサイズを下位1バイトを0丁度に調整する必要あり(X1/88)
       0000                     CHECK_FILE_SIZE EQU (FILEC-FILE_E) & 0FFH
       DB7F                     FILEC:
000E61 DB7F CD8ADB          17      CALL    FILE
       DB82                     FILEC2:
000E64 DB82 3A15F0          13      LD  A,(FDRV+1)
000E67 DB85 FE20             7      CP  020H
000E69 DB87 C8              11      RET Z
000E6A DB88 1839            12      JR  SETDIR1
                                
       DB8A                     FILE:
000E6C DB8A AF               4      XOR A
000E6D DB8B 3214F0          13      LD  (FDRV),A
000E70 DB8E 67               4      LD  H,A
000E71 DB8F 6F               4      LD  L,A
000E72 DB90 2222F0          16      LD  (FDRV+14),HL
000E75 DB93 CD60DC          17      CALL    SPCUT
000E78 DB96 CD45DC          17      CALL    CCHK3
000E7B DB99 2812            12      JR  Z,DEVI1
000E7D DB9B 13               6      INC DE
000E7E DB9C 1A               7      LD  A,(DE)
000E7F DB9D 1B               6      DEC DE
000E80 DB9E FE3A             7      CP  ':'
000E82 DBA0 200B            12      JR  NZ,DEVI1
000E84 DBA2 1A               7      LD  A,(DE)      ;DRIVE
000E85 DBA3 CDA6DE          17      CALL    CAP
000E88 DBA6 D640             7      SUB '@'
000E8A DBA8 13               6      INC DE
000E8B DBA9 13               6      INC DE
000E8C DBAA 3214F0          13      LD  (FDRV),A
       DBAD                     DEVI1:
000E8F DBAD 1A               7      LD  A,(DE)
000E90 DBAE D65C             7      SUB 05CH        ;\
000E92 DBB0 2009            12      JR  NZ,NOROOT
000E94 DBB2 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
000E95 DBB3 222EF0          16      LD  (FDRV+26),HL
000E98 DBB6 2C               4      INC L
000E99 DBB7 2222F0          16      LD  (FDRV+14),HL
000E9C DBBA 13               6      INC DE
       DBBB                     NOROOT:
                                
       DBBB                     SETDIR:
000E9D DBBB CDE6DB          17      CALL    FILED
000EA0 DBBE 1A               7      LD  A,(DE)
000EA1 DBBF FE5C             7      CP  05CH        ;\
000EA3 DBC1 C0              11      RET NZ
000EA4 DBC2 13               6      INC DE
       DBC3                     SETDIR1:
000EA5 DBC3 3E10             7      LD  A,010H      ;Directory
000EA7 DBC5 3221F0          13      LD  (FDRV+13),A
000EAA DBC8 D5              11      PUSH    DE
000EAB DBC9 1114F0          10      LD  DE,FDRV
000EAE DBCC 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
000EB0 DBCE CD45D4          17      CALL    BDOS0
000EB3 DBD1 D1              10      POP DE
000EB4 DBD2 B7               4      OR  A
000EB5 DBD3 C0              11      RET NZ
                                
000EB6 DBD4 3A21F0          13      LD  A,(FDRV+13)
000EB9 DBD7 E610             7      AND 010H        ;ディレクトリ
000EBB DBD9 C8              11      RET Z
                                
000EBC DBDA CD2DDC          17      CALL    FILEI
000EBF DBDD 2A2EF0          16      LD  HL,(FDRV+26)
000EC2 DBE0 23               6      INC HL
000EC3 DBE1 2222F0          16      LD  (FDRV+14),HL
000EC6 DBE4 18D5            12      JR  SETDIR
                                
       DBE6                     FILED:
000EC8 DBE6 CD2DDC          17      CALL    FILEI
000ECB DBE9 2115F0          10      LD  HL,FNAME
                                
000ECE DBEC 0608             7      LD  B,8
       DBEE                     FILE2:
000ED0 DBEE CD3ADC          17      CALL    CCHKF
000ED3 DBF1 C8              11      RET Z
000ED4 DBF2 FE2A             7      CP  '*'
000ED6 DBF4 282E            12      JR  Z,FILE9
000ED8 DBF6 FE2E             7      CP  '.'
000EDA DBF8 280C            12      JR  Z,FILE4
000EDC DBFA 77               7      LD  (HL),A
000EDD DBFB 23               6      INC HL
000EDE DBFC 10F0            13      DJNZ    FILE2
                                
       DBFE                     FILE3:
000EE0 DBFE CD3ADC          17      CALL    CCHKF
000EE3 DC01 C8              11      RET Z
000EE4 DC02 FE2E             7      CP  '.'
000EE6 DC04 20F8            12      JR  NZ,FILE3
                                
       DC06                     FILE4:
000EE8 DC06 211DF0          10      LD  HL,FNAME+8
000EEB DC09 0603             7      LD  B,3
                                
       DC0B                     FILE4L:
000EED DC0B CD3ADC          17      CALL    CCHKF
000EF0 DC0E C8              11      RET Z
000EF1 DC0F FE2E             7      CP  '.'
000EF3 DC11 2008            12      JR  NZ,FILE12
000EF5 DC13 3215F0          13      LD  (FNAME),A   ;Parent directory(..)
000EF8 DC16 3216F0          13      LD  (FNAME+1),A
000EFB DC19 3E20             7      LD  A,020H
       DC1B                     FILE12:
000EFD DC1B FE2A             7      CP  '*'
000EFF DC1D 280A            12      JR  Z,FILE10
000F01 DC1F 77               7      LD  (HL),A
000F02 DC20 23               6      INC HL
000F03 DC21 10E8            13      DJNZ    FILE4L
000F05 DC23 C9              10      RET
                                
       DC24                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000F06 DC24 CD29DC          17      CALL    FILE10
000F09 DC27 18D5            12      JR  FILE3
                                
       DC29                     FILE10:
000F0B DC29 3E3F             7      LD  A,'?'
000F0D DC2B 1808            12      JR  FILL_MEMORY
       DC2D                     FILEI:              ;名前＋拡張子をスペースで初期化
000F0F DC2D 3E20             7      LD  A,020H
000F11 DC2F 01000B          10      LD  BC,11*256   ;C=0にしておく
000F14 DC32 2115F0          10      LD  HL,FNAME
       DC35                     FILL_MEMORY:            ;HLからBバイトAで埋める
000F17 DC35 77               7      LD  (HL),A
000F18 DC36 23               6      INC HL
000F19 DC37 10FC            13      DJNZ    FILL_MEMORY
000F1B DC39 C9              10      RET
                                
       DC3A                     CCHKF:
000F1C DC3A 1A               7      LD  A,(DE)
000F1D DC3B CD42DC          17      CALL    CCHK2
000F20 DC3E C8              11      RET Z
000F21 DC3F C3AEDF          10      JP  FKAN
                                
       DC42                     CCHK2:
000F24 DC42 0C               4      INC C
000F25 DC43 0D               4      DEC C
000F26 DC44 C0              11      RET NZ
       DC45                     CCHK3:              ;ZF=1 で使えない文字
000F27 DC45 FE2B             7      CP  '+'
000F29 DC47 C8              11      RET Z
000F2A DC48 FE2C             7      CP  ','
000F2C DC4A C8              11      RET Z
000F2D DC4B FE2F             7      CP  '/'
000F2F DC4D C8              11      RET Z
000F30 DC4E FE3A             7      CP  ':'
000F32 DC50 C8              11      RET Z
000F33 DC51 FE3B             7      CP  ';'
000F35 DC53 C8              11      RET Z
000F36 DC54 FE3D             7      CP  '='
000F38 DC56 C8              11      RET Z
000F39 DC57 FE5C             7      CP  05CH    ;\
000F3B DC59 C8              11      RET Z
000F3C DC5A FE20             7      CP  020H
000F3E DC5C D0              11      RET NC
000F3F DC5D BF               4      CP  A       ;Z=1
000F40 DC5E C9              10      RET
                                
       DC5F                     SS1:
000F41 DC5F 13               6      INC DE
       DC60                     SPCUT:              ;スペースをカット
000F42 DC60 1A               7      LD  A,(DE)
000F43 DC61 FE20             7      CP  020H
000F45 DC63 28FA            12      JR  Z,SS1
000F47 DC65 C9              10      RET
                                
       DC66                     SETDRVF:
000F48 DC66 1114F0          10      LD  DE,FDRV
       DC69                     SETDRV0:
000F4B DC69 CD72DC          17      CALL    SETDRV
000F4E DC6C FDE1            14      POP IY
000F50 DC6E C1              10      POP BC
000F51 DC6F D1              10      POP DE
000F52 DC70 E1              10      POP HL
000F53 DC71 C9              10      RET
                                
       DC72                     SETDRV:
000F54 DC72 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
000F55 DC73 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
000F56 DC74 C5              11      PUSH    BC
000F57 DC75 1A               7      LD  A,(DE)
000F58 DC76 D5              11      PUSH    DE
000F59 DC77 FDE3            23      EX  (SP),IY
                                
000F5B DC79 CD80DC          17      CALL    GETDRV
000F5E DC7C CDD9F0          17      CALL    _CHGDRV
                                
000F61 DC7F E9               4      JP  (HL)
                                
       DC80                     GETDRV:
000F62 DC80 CD93DC          17      CALL    GETDRV1
000F65 DC83 3288F0          13      LD  (_DRV),A
000F68 DC86 C9              10      RET
                                
       DC87                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
000F69 DC87 CD93DC          17      CALL    GETDRV1
000F6C DC8A C5              11      PUSH    BC
000F6D DC8B 4F               4      LD  C,A
000F6E DC8C 1A               7      LD  A,(DE)
000F6F DC8D CD93DC          17      CALL    GETDRV1
000F72 DC90 A9               4      XOR C
000F73 DC91 C1              10      POP BC
000F74 DC92 C9              10      RET
       DC93                     GETDRV1:
000F75 DC93 E67F             7      AND 07FH
000F77 DC95 D601             7      SUB 001H
000F79 DC97 D0              11      RET NC
000F7A DC98 3A0400          13      LD  A,(_DVSW)   ;Current Drive
000F7D DC9B C9              10      RET
                                
       DC9C                     SOPENX:
000F7E DC9C 1139F0          10      LD  DE,SFILE
000F81 DC9F FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
000F84 DCA2 CD87DC          17      CALL    IS_SAME_DRV_A_DE
000F87 DCA5 2024            12      JR  NZ,SOPEN
000F89 DCA7 13               6      INC DE
000F8A DCA8 FDE5            15      PUSH    IY
000F8C DCAA E1              10      POP HL
000F8D DCAB 23               6      INC HL
000F8E DCAC CD37DE          17      CALL    CPFILE
000F91 DCAF 201A            12      JR  NZ,SOPEN
                                
000F93 DCB1 2AF4F1          16      LD  HL,(SCDIR)
000F96 DCB4 FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
000F99 DCB7 FD740F          19      LD  (IY+15),H
                                
000F9C DCBA 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
000F9F DCBD 229FF0          16      LD  (_FILEN),HL
                                
000FA2 DCC0 ED5BF6F1        20      LD  DE,(SFBPS)
000FA6 DCC4 2139F0          10      LD  HL,SFILE
000FA9 DCC7 36FF            10      LD  (HL),0FFH
000FAB DCC9 23               6      INC HL
000FAC DCCA C9              10      RET
       DCCB                     SOPEN:
000FAD DCCB 21DFDD          10      LD  HL,FILESE
       DCCE                     SOPENC:
000FB0 DCCE 2207DD          16      LD  (OPENPAT),HL
                                
000FB3 DCD1 CDE2F0          17      CALL    _RDFATX     ;Detect Media
000FB6 DCD4 3856            12      JR  C,RDDERR
                                
000FB8 DCD6 AF               4      XOR A
000FB9 DCD7 329FF0          13      LD  (_FILEN),A
000FBC DCDA CDE3DE          17      CALL    LDDIRX1     ;A=0で呼び出す
000FBF DCDD 2818            12      JR  Z,SDIRX1
                                
000FC1 DCDF CDD0DD          17      CALL    READ_DIR    ;Sub Directory
000FC4 DCE2 3808            12      JR  C,SDIRX0
000FC6 DCE4 2A7EF1          16      LD  HL,(_DTBUF)
000FC9 DCE7 7E               7      LD  A,(HL)
000FCA DCE8 FE2E             7      CP  '.'
000FCC DCEA 280F            12      JR  Z,SOPEN1
       DCEC                     SDIRX0:
000FCE DCEC AF               4      XOR A
000FCF DCED 32A0F0          13      LD  (_DIRF),A
000FD2 DCF0 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
000FD6 DCF4 FD770F          19      LD  (IY+15),A
       DCF7                     SDIRX1:
000FD9 DCF7 ED5BFCF1        20      LD  DE,(_DIRPS) ;Root Directory
       DCFB                     SOPEN1:
000FDD DCFB 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       DCFC                     SDECPAT EQU $-1
       DCFD                     SOPEN1X:
000FDF DCFD CDD0DD          17      CALL    READ_DIR    ;FILE SEARCH
000FE2 DD00 382A            12      JR  C,RDDERR
000FE4 DD02 2A7EF1          16      LD  HL,(_DTBUF)
       DD05                     SOPEN2:
000FE7 DD05 D5              11      PUSH    DE
000FE8 DD06 CDDFDD          17      CALL    FILESE      ;(self-modifying code)
       DD07                     OPENPAT EQU $-2
000FEB DD09 D1              10      POP DE
000FEC DD0A 386D            12      JR  C,SOPENE
000FEE DD0C 281B            12      JR  Z,SCF_FF_RET
       DD0E                     SOPEN3:
000FF0 DD0E 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
000FF3 DD11 B7               4      OR  A
000FF4 DD12 200C            12      JR  NZ,SOPEN5
000FF6 DD14 13               6      INC DE      ;ルートディレクトリ
000FF7 DD15 E5              11      PUSH    HL
000FF8 DD16 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       DD17                     MD_PAT  EQU $-2
000FFB DD19 ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
000FFD DD1B E1              10      POP HL
000FFE DD1C 20DD            12      JR  NZ,SOPEN1
001000 DD1E 1807            12      JR  SOPEN6
       DD20                     SOPEN5:
001002 DD20 CDEAE5          17      CALL    GNCLX       ;END DIR
001005 DD23 D8              11      RET C
001006 DD24 CD97DE          17      CALL    ENDCL
       DD27                     SOPEN6:
001009 DD27 38D2            12      JR  C,SOPEN1
       DD29                     SCF_FF_RET:
00100B DD29 37               4      SCF         ;CF=1
00100C DD2A 9F               4      SBC A,A     ;A=0FFH
00100D DD2B C9              10      RET
                                
       DD2C                     RDDERR:
00100E DD2C BF               4      CP  A       ;READ ERR CF=1 ZF=1
00100F DD2D 37               4      SCF
001010 DD2E C9              10      RET
                                
       DD2F                     NOPEN:
001011 DD2F 21DFDD          10      LD  HL,FILESE
001014 DD32 2207DD          16      LD  (OPENPAT),HL
001017 DD35 FD2A98F0        20      LD  IY,(_FCB)
00101B DD39 CDC1DF          17      CALL    CHKWILDX
00101E DD3C 30EB            12      JR  NC,SCF_FF_RET
001020 DD3E FD7E00          19      LD  A,(IY+0)
001023 DD41 CD80DC          17      CALL    GETDRV
001026 DD44 CDD9F0          17      CALL    _CHGDRV
001029 DD47 D8              11      RET C
00102A DD48 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
00102D DD4B 229FF0          16      LD  (_FILEN),HL
                                
001030 DD4E CDDEDE          17      CALL    LDDIRX
001033 DD51 ED5B9AF0        20      LD  DE,(_FBPS)
001037 DD55 CDD0DD          17      CALL    READ_DIR
00103A DD58 38D2            12      JR  C,RDDERR
00103C DD5A 3A9EF0          13      LD  A,(_FBCNT)
00103F DD5D 3D               4      DEC A
001040 DD5E 28AE            12      JR  Z,SOPEN3
       DD60                     NOPEN2:
001042 DD60 2A9CF0          16      LD  HL,(_FBAD)
001045 DD63 012000          10      LD  BC,020H
001048 DD66 09              11      ADD HL,BC
001049 DD67 4F               4      LD  C,A
00104A DD68 189B            12      JR  SOPEN2
                                
       DD6A                     SOPENE2:
00104C DD6A 229CF0          16      LD  (_FBAD),HL
00104F DD6D 79               4      LD  A,C
001050 DD6E 329EF0          13      LD  (_FBCNT),A
001053 DD71 ED539AF0        20      LD  (_FBPS),DE
001057 DD75 FD2298F0        20      LD  (_FCB),IY
       DD79                     SOPENE:
00105B DD79 AF               4      XOR A
00105C DD7A C9              10      RET
                                
       DD7B                     COPEN:
00105D DD7B FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
001061 DD7F 21FCDD          10      LD  HL,NEXTSE
001064 DD82 CDCEDC          17      CALL    SOPENC
001067 DD85 D0              11      RET NC
001068 DD86 C8              11      RET Z
001069 DD87 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
00106C DD8A B7               4      OR  A
00106D DD8B 37               4      SCF
00106E DD8C C8              11      RET Z       ;ルートディレクトリ
00106F DD8D 0601             7      LD  B,1
001071 DD8F CD20E0          17      CALL    WRDF
001074 DD92 D8              11      RET C
001075 DD93 ED5BFEF1        20      LD  DE,(_CLPS)
001079 DD97 D5              11      PUSH    DE
00107A DD98 CD60DE          17      CALL    DCPAT
00107D DD9B CD6BE4          17      CALL    DRDNX
001080 DD9E 2A7EF1          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
001083 DDA1 ED4B56E3        20      LD  BC,(SECSZ)  ;1セクタのサイズ
001087 DDA5 AF               4      XOR A
       DDA6                     COPENCL:
001088 DDA6 77               7      LD  (HL),A
001089 DDA7 EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00108B DDA9 EAA6DD          10      JP  PE,COPENCL
                                
00108E DDAC 3A7EDE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
001091 DDAF 3D               4      DEC A
001092 DDB0 2819            12      JR  Z,COPENE
001094 DDB2 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
001096 DDB4 32E2E5          13      LD  (_SECPS),A
001099 DDB7 D1              10      POP DE      ;DE=(_CLPS)
00109A DDB8 D5              11      PUSH    DE
       DDB9                     COPEN1:
00109B DDB9 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
00109C DDBA C5              11      PUSH    BC
00109D DDBB 2A7EF1          16      LD  HL,(_DTBUF)
0010A0 DDBE CD7ADE          17      CALL    CLUSTX
0010A3 DDC1 CD7FE7          17      CALL    DWT24
0010A6 DDC4 C1              10      POP BC
0010A7 DDC5 D1              10      POP DE
0010A8 DDC6 CDE1E5          17      CALL    NEXTX
0010AB DDC9 20EE            12      JR  NZ,COPEN1
       DDCB                     COPENE:
0010AD DDCB 2A7EF1          16      LD  HL,(_DTBUF)
0010B0 DDCE D1              10      POP DE
0010B1 DDCF C9              10      RET
                                
       DDD0                     READ_DIR:
0010B2 DDD0 ED53FEF1        20      LD  (_CLPS),DE
0010B6 DDD4 C5              11      PUSH    BC
0010B7 DDD5 D5              11      PUSH    DE
0010B8 DDD6 CD60DE          17      CALL    DCPAT
0010BB DDD9 CD4BE4          17      CALL    DRDX
0010BE DDDC D1              10      POP DE
0010BF DDDD C1              10      POP BC
0010C0 DDDE C9              10      RET
                                
       DDDF                     FILESE:
0010C1 DDDF 7E               7      LD  A,(HL)
0010C2 DDE0 B7               4      OR  A
0010C3 DDE1 C8              11      RET Z       ;END:ZF=1 CF=0
0010C4 DDE2 FEE5             7      CP  0E5H
0010C6 DDE4 280E            12      JR  Z,FILESE1
0010C8 DDE6 FDE5            15      PUSH    IY
0010CA DDE8 D1              10      POP DE
0010CB DDE9 13               6      INC DE
0010CC DDEA E5              11      PUSH    HL
0010CD DDEB CD37DE          17      CALL    CPFILE
0010D0 DDEE CC58DE          17      CALL    Z,CPFILE2
0010D3 DDF1 E1              10      POP HL
0010D4 DDF2 37               4      SCF
0010D5 DDF3 C8              11      RET Z       ;!!!:(ZF=1) CF=1
       DDF4                     FILESE1:
0010D6 DDF4 CD0BDE          17      CALL    FNEXT
0010D9 DDF7 20E6            12      JR  NZ,FILESE
       DDF9                     ZF0_CF0_AFF_RET:
0010DB DDF9 F6FF             7      OR  0FFH        ;ZF=0 CF=0
0010DD DDFB C9              10      RET
                                
       DDFC                     NEXTSE:
0010DE DDFC 7E               7      LD  A,(HL)
0010DF DDFD B7               4      OR  A
0010E0 DDFE 37               4      SCF
0010E1 DDFF C8              11      RET Z       ;!!!:ZF=1 CF=1
0010E2 DE00 FEE5             7      CP  0E5H
0010E4 DE02 37               4      SCF
0010E5 DE03 C8              11      RET Z       ;!!!:(ZF=1) CF=1
0010E6 DE04 CD0BDE          17      CALL    FNEXT
0010E9 DE07 20F3            12      JR  NZ,NEXTSE
0010EB DE09 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       DE0B                     FNEXT:
0010ED DE0B E5              11      PUSH    HL
0010EE DE0C 219FF0          10      LD  HL,_FILEN
0010F1 DE0F 34              11      INC (HL)
0010F2 DE10 E1              10      POP HL
0010F3 DE11 112000          10      LD  DE,020H
0010F6 DE14 19              11      ADD HL,DE
0010F7 DE15 0D               4      DEC C
0010F8 DE16 C9              10      RET
                                
       DE17                     CPNAME:
0010F9 DE17 C5              11      PUSH    BC
0010FA DE18 D5              11      PUSH    DE
0010FB DE19 E5              11      PUSH    HL
0010FC DE1A CD31DE          17      CALL    CPFILE4
0010FF DE1D E1              10      POP HL
001100 DE1E 23               6      INC HL
001101 DE1F 23               6      INC HL
001102 DE20 23               6      INC HL
001103 DE21 23               6      INC HL
001104 DE22 D1              10      POP DE
001105 DE23 C1              10      POP BC
001106 DE24 2005            12      JR  NZ,CPNAME1
001108 DE26 7E               7      LD  A,(HL)
001109 DE27 23               6      INC HL
00110A DE28 66               7      LD  H,(HL)
00110B DE29 6F               4      LD  L,A
00110C DE2A C9              10      RET
       DE2B                     CPNAME1:
00110D DE2B 23               6      INC HL
00110E DE2C 23               6      INC HL
00110F DE2D 10E8            13      DJNZ    CPNAME
001111 DE2F 37               4      SCF
001112 DE30 C9              10      RET
                                
       DE31                     CPFILE4:
001113 DE31 C5              11      PUSH    BC
001114 DE32 010004          10      LD  BC,00400H
001117 DE35 1804            12      JR  CPSTR1
       DE37                     CPFILE:
001119 DE37 C5              11      PUSH    BC
00111A DE38 01000B          10      LD  BC,00B00H
       DE3B                     CPSTR1:
00111D DE3B 1A               7      LD  A,(DE)
00111E DE3C FE3F             7      CP  '?'     ;Wild card
001120 DE3E 2812            12      JR  Z,CPSTR2
001122 DE40 7E               7      LD  A,(HL)
001123 DE41 CDA7DF          17      CALL    FKANC
001126 DE44 E5              11      PUSH    HL
001127 DE45 67               4      LD  H,A
001128 DE46 1A               7      LD  A,(DE)
001129 DE47 CB01             8      RLC C
00112B DE49 CDA7DF          17      CALL    FKANC
00112E DE4C CB09             8      RRC C
001130 DE4E BC               4      CP  H       ;CP (HL),(DE)
001131 DE4F E1              10      POP HL
001132 DE50 2004            12      JR  NZ,CPSTR3
       DE52                     CPSTR2:
001134 DE52 13               6      INC DE
001135 DE53 23               6      INC HL
001136 DE54 10E5            13      DJNZ    CPSTR1
       DE56                     CPSTR3:
001138 DE56 C1              10      POP BC
001139 DE57 C9              10      RET
                                
       DE58                     CPFILE2:
00113A DE58 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
00113D DE5B F6E1             7      OR  0E1H
00113F DE5D 2F               4      CPL
001140 DE5E A6               7      AND (HL)
001141 DE5F C9              10      RET
                                
       DE60                     DCPAT:
001142 DE60 0E00             7      LD  C,0
001144 DE62 2A7EF1          16      LD  HL,(_DTBUF)
001147 DE65 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
00114A DE68 B7               4      OR  A
00114B DE69 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
00114C DE6A 3A7EDE          13      LD  A,(SPCPAT)
00114F DE6D 4F               4      LD  C,A
001150 DE6E 3AE2E5          13      LD  A,(_SECPS)
001153 DE71 B9               4      CP  C
001154 DE72 3801            12      JR  C,DC1
001156 DE74 AF               4      XOR A
       DE75                     DC1:
001157 DE75 F680             7      OR  080H
001159 DE77 32A0F0          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       DE7A                     CLUSTX:
00115C DE7A E5              11      PUSH    HL
00115D DE7B EB               4      EX  DE,HL
00115E DE7C AF               4      XOR A
00115F DE7D 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       DE7E                     SPCPAT  EQU $-1
       DE7F                     L_CLDBL:
001161 DE7F CB19             8      RR  C       ;->CF
001163 DE81 3804            12      JR  C,E_CLDBL
001165 DE83 29              11      ADD HL,HL       ;*2
001166 DE84 8F               4      ADC A,A
001167 DE85 18F8            12      JR  L_CLDBL
       DE87                     E_CLDBL:
001169 DE87 4F               4      LD  C,A
00116A DE88 3AE2E5          13      LD  A,(_SECPS)
00116D DE8B B5               4      OR  L
00116E DE8C 6F               4      LD  L,A
00116F DE8D 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       DE8E                     CLSPAT  EQU $-2
001172 DE90 AF               4      XOR A
001173 DE91 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
001174 DE92 89               4      ADC A,C
001175 DE93 4F               4      LD  C,A
001176 DE94 EB               4      EX  DE,HL
001177 DE95 E1              10      POP HL
001178 DE96 C9              10      RET
                                ;(8)
       DE97                     ENDCL:
001179 DE97 7A               4      LD  A,D ;END CLUSTER
00117A DE98 FE01             7      CP  1   ;164=356    (self-modifying code)
       DE99                     CLPAT1  EQU $-1
00117C DE9A C0              11      RET NZ
00117D DE9B 7B               4      LD  A,E
00117E DE9C FE64             7      CP  064H    ;       (self-modifying code)
       DE9D                     CLPAT2  EQU $-1
001180 DE9E C9              10      RET
                                ;(3)
       DE9F                     CAP4:
001181 DE9F 3EE5             7      LD  A,0E5H
001183 DEA1 C9              10      RET
                                                    ;for X1/88 ワークエリア
001184 DEA2 5BF0                    DW  _DISKE+1        ;DISKVE($F323)
001186 DEA4 F5F0                    DW  _BREAK+1        ;BREAKV($F325)
                                
       DEA6                     CAP:            ;(9)
001188 DEA6 FE61             7      CP  'a'
00118A DEA8 D8              11      RET C
00118B DEA9 FE7B             7      CP  'z'+1
00118D DEAB D0              11      RET NC
00118E DEAC D620             7      SUB 020H
001190 DEAE C9              10      RET
                                ;(10)
       DEAF                     CAP2:
001191 DEAF CDA6DE          17      CALL    CAP
       DEB2                     CAP3:               ;
001194 DEB2 FE05             7      CP  5
001196 DEB4 28E9            12      JR  Z,CAP4
001198 DEB6 FE21             7      CP  021H
00119A DEB8 C9              10      RET
                                                    ;
       DEB9                     CHDIR:
00119B DEB9 CD90E8          17      CALL    GETDPBD
00119E DEBC 381D            12      JR  C,CHDIR2
0011A0 DEBE DD751A          19      LD  (IX+DPB_SDIR),L
0011A3 DEC1 DD741B          19      LD  (IX+DPB_SDIR+1),H
0011A6 DEC4 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       DEC6                     LDDIR:
0011A8 DEC6 CD90E8          17      CALL    GETDPBD
0011AB DEC9 DD5E1A          19      LD  E,(IX+DPB_SDIR)
0011AE DECC DD561B          19      LD  D,(IX+DPB_SDIR+1)
0011B1 DECF 13               6      INC DE
0011B2 DED0 FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011B5 DED3 FD720F          19      LD  (IY+15),D
0011B8 DED6 1B               6      DEC DE
0011B9 DED7 AF               4      XOR A
0011BA DED8 32A0F0          13      LD  (_DIRF),A
       DEDB                     CHDIR2:
0011BD DEDB DDE1            14      POP IX
0011BF DEDD C9              10      RET
                                
       DEDE                     LDDIRX:
0011C0 DEDE 3AA0F0          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
0011C3 DEE1 E67F             7      AND 07FH
       DEE3                     LDDIRX1:
0011C5 DEE3 32E2E5          13      LD  (_SECPS),A
0011C8 DEE6 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
0011CB DEE9 FD560F          19      LD  D,(IY+15)
0011CE DEEC 1B               6      DEC DE
0011CF DEED CD97DE          17      CALL    ENDCL
0011D2 DEF0 D4C6DE          17      CALL    NC,LDDIR
       DEF3                     LDDIRS:
0011D5 DEF3 7A               4      LD  A,D
0011D6 DEF4 B3               4      OR  E
0011D7 DEF5 32A0F0          13      LD  (_DIRF),A   ;ディレクトリか判別
0011DA DEF8 C9              10      RET
                                
       DEF9                     KILL:
0011DB DEF9 CDC1DF          17      CALL    CHKWILDX
0011DE DEFC 3834            12      JR  C,KILLW
0011E0 DEFE CD9CDC          17      CALL    SOPENX
       DF01                     KILLS:
0011E3 DF01 3E1F             7      LD  A,01FH
0011E5 DF03 D445DF          17      CALL    NC,CHKATT
0011E8 DF06 D8              11      RET C
       DF07                     KILLSX:
0011E9 DF07 36E5            10      LD  (HL),0E5H   ;DIR
0011EB DF09 CD9DDF          17      CALL    WTDB
0011EE DF0C 111A00          10      LD  DE,01AH
0011F1 DF0F 19              11      ADD HL,DE
0011F2 DF10 5E               7      LD  E,(HL)
0011F3 DF11 23               6      INC HL
0011F4 DF12 56               7      LD  D,(HL)
       DF13                     KILLS1:
0011F5 DF13 CD97DE          17      CALL    ENDCL
0011F8 DF16 D0              11      RET NC      ;CF=0
0011F9 DF17 21FEFF          10      LD  HL,0-2
0011FC DF1A 19              11      ADD HL,DE
0011FD DF1B D0              11      RET NC      ;DE= 0 or 1
0011FE DF1C D5              11      PUSH    DE
0011FF DF1D CDF7F0          17      CALL    _GNCL
001202 DF20 ED53FEF1        20      LD  (_CLPS),DE
001206 DF24 D1              10      POP DE
001207 DF25 210000          10      LD  HL,0
00120A DF28 D4FAF0          17      CALL    NC,_SNCL
00120D DF2B D8              11      RET C
00120E DF2C ED5BFEF1        20      LD  DE,(_CLPS)  ;FAT
001212 DF30 18E1            12      JR  KILLS1
                                
       DF32                     KILLW:
001214 DF32 CDCBDC          17      CALL    SOPEN
       DF35                     KILLW1:
001217 DF35 380B            12      JR  C,KILLW2
001219 DF37 CD6ADD          17      CALL    SOPENE2
00121C DF3A CD01DF          17      CALL    KILLS
00121F DF3D CD2FDD          17      CALL    NOPEN
001222 DF40 18F3            12      JR  KILLW1
       DF42                     KILLW2:
001224 DF42 C8              11      RET Z
001225 DF43 3F               4      CCF
001226 DF44 C9              10      RET
                                
       DF45                     CHKATT:
001227 DF45 E5              11      PUSH    HL
001228 DF46 110B00          10      LD  DE,00BH
00122B DF49 19              11      ADD HL,DE
00122C DF4A A6               7      AND (HL)
00122D DF4B E1              10      POP HL
00122E DF4C C8              11      RET Z
00122F DF4D 37               4      SCF
001230 DF4E C9              10      RET
                                
       DF4F                     NAME:
001231 DF4F CDC1DF          17      CALL    CHKWILDX
001234 DF52 D8              11      RET C
001235 DF53 110400          10      LD  DE,4
001238 DF56 19              11      ADD HL,DE
001239 DF57 226CDF          16      LD  (NAMEP),HL
00123C DF5A 23               6      INC HL
00123D DF5B CDC5DF          17      CALL    CHKWILD
001240 DF5E D8              11      RET C
                                
001241 DF5F CD9CDC          17      CALL    SOPENX
001244 DF62 3E0F             7      LD  A,00FH
001246 DF64 D445DF          17      CALL    NC,CHKATT
001249 DF67 D8              11      RET C
                                
00124A DF68 FDE5            15      PUSH    IY
00124C DF6A FD210000        14      LD  IY,0        ;自己書き換え
       DF6C                     NAMEP   EQU $-2
001250 DF6E CD9CDC          17      CALL    SOPENX
001253 DF71 FDE3            23      EX  (SP),IY
001255 DF73 3F               4      CCF
001256 DF74 D4CBDC          17      CALL    NC,SOPEN
001259 DF77 EB               4      EX  DE,HL
00125A DF78 E1              10      POP HL
00125B DF79 D8              11      RET C
                                
       DF7A                     SETNAME:
00125C DF7A 01000B          10      LD  BC,11*256
00125F DF7D 23               6      INC HL
001260 DF7E 7E               7      LD  A,(HL)
001261 DF7F FEE5             7      CP  0E5H
001263 DF81 2004            12      JR  NZ,SNAME1
001265 DF83 3E05             7      LD  A,5
001267 DF85 180E            12      JR  SNAME3
       DF87                     SNAME1:
001269 DF87 7E               7      LD  A,(HL)
00126A DF88 0C               4      INC C
00126B DF89 0D               4      DEC C
00126C DF8A 2009            12      JR  NZ,SNAME3
00126E DF8C CDA6DE          17      CALL    CAP
001271 DF8F FEA0             7      CP  0A0H
001273 DF91 2002            12      JR  NZ,SNAME3
001275 DF93 3E20             7      LD  A,020H
       DF95                     SNAME3:
001277 DF95 12               7      LD  (DE),A
001278 DF96 7E               7      LD  A,(HL)
001279 DF97 23               6      INC HL
00127A DF98 CDAEDF          17      CALL    FKAN
00127D DF9B 10EA            13      DJNZ    SNAME1
       DF9D                     WTDB:               ;バッファデータが更新された
00127F DF9D 3EFF             7      LD  A,0FFH
001281 DF9F 3239F0          13      LD  (SFILE),A
001284 DFA2 32A4F0          13      LD  (_WTDBF),A
001287 DFA5 AF               4      XOR A
001288 DFA6 C9              10      RET
                                
       DFA7                     FKANC:
001289 DFA7 CB41             8      BIT 0,C
00128B DFA9 CCAFDE          17      CALL    Z,CAP2
00128E DFAC 1801            12      JR  FKANX
       DFAE                     FKAN:           ;漢字チェック
001290 DFAE 13               6      INC DE
       DFAF                     FKANX:
001291 DFAF CB41             8      BIT 0,C
001293 DFB1 CB81             8      RES 0,C
001295 DFB3 C0              11      RET NZ
001296 DFB4 FE80             7      CP  080H
001298 DFB6 D8              11      RET C
001299 DFB7 FEA0             7      CP  0A0H
00129B DFB9 3803            12      JR  C,FKAN1
00129D DFBB FEE0             7      CP  0E0H
00129F DFBD D8              11      RET C
       DFBE                     FKAN1:
0012A0 DFBE 0C               4      INC C
0012A1 DFBF A7               4      AND A
0012A2 DFC0 C9              10      RET
                                
       DFC1                     CHKWILDX:
0012A3 DFC1 FDE5            15      PUSH    IY
0012A5 DFC3 E1              10      POP HL
0012A6 DFC4 23               6      INC HL
       DFC5                     CHKWILD:
0012A7 DFC5 060B             7      LD  B,11
0012A9 DFC7 3E3F             7      LD  A,'?'
       DFC9                     CHKWIL1:
0012AB DFC9 BE               7      CP  (HL)
0012AC DFCA 23               6      INC HL
0012AD DFCB 37               4      SCF
0012AE DFCC C8              11      RET Z
0012AF DFCD 10FA            13      DJNZ    CHKWIL1
0012B1 DFCF AF               4      XOR A
0012B2 DFD0 C9              10      RET
                                
       DFD1                     SDIRENT:        ;IY=FCB HL=DIR
0012B3 DFD1 D5              11      PUSH    DE
0012B4 DFD2 E5              11      PUSH    HL
0012B5 DFD3 FDE5            15      PUSH    IY
0012B7 DFD5 D1              10      POP DE
0012B8 DFD6 EB               4      EX  DE,HL
0012B9 DFD7 CD7ADF          17      CALL    SETNAME
                                ;               Attribute
0012BC DFDA FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0012BF DFDD 12               7      LD  (DE),A
0012C0 DFDE 13               6      INC DE
                                ;               Reserved
0012C1 DFDF AF               4      XOR A
0012C2 DFE0 060A             7      LD  B,10
       DFE2                     SDE1:
0012C4 DFE2 12               7      LD  (DE),A
0012C5 DFE3 13               6      INC DE
0012C6 DFE4 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
0012C8 DFE6 21E4F1          10      LD  HL,SDDATA       ;(FCB)更新年月日
0012CB DFE9 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DFEB                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
0012CD DFEB 7E               7      LD  A,(HL)
0012CE DFEC 23               6      INC HL
0012CF DFED 32F2DF          13      LD  (SDPAT),A
0012D2 DFF0 FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       DFF2                     SDPAT   EQU $-1
0012D5 DFF3 12               7      LD  (DE),A
0012D6 DFF4 13               6      INC DE
0012D7 DFF5 10F4            13      DJNZ    SDLOOP
                                
0012D9 DFF7 AF               4      XOR A
0012DA DFF8 E1              10      POP HL
0012DB DFF9 D1              10      POP DE
0012DC DFFA C9              10      RET
                                
       DFFB                     WOPEN:
0012DD DFFB FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0012E0 DFFE E61F             7      AND 01FH
0012E2 E000 37               4      SCF
0012E3 E001 C0              11      RET NZ
0012E4 E002 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       E006                     TOPEN2:
0012E8 E006 AF               4      XOR A
       E007                     TOPEN:              ;Initializes the time stamp
0012E9 E007 FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
0012ED E00B C9              10      RET
                                
       E00C                     WRDFX:
0012EE E00C 3A7EDE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       E00F                     L_WRFX:
0012F1 E00F 1F               4      RRA         ;->CF
0012F2 E010 3806            12      JR  C,E_WRFX
0012F4 E012 CB39             8      SRL C
0012F6 E014 CB1C             8      RR  H       ;CH=CH/2
0012F8 E016 18F7            12      JR  L_WRFX
       E018                     E_WRFX:
0012FA E018 41               4      LD  B,C
0012FB E019 4C               4      LD  C,H
0012FC E01A 03               6      INC BC
0012FD E01B 3E37             7      LD  A,037H      ;SCF
0012FF E01D 3268E4          13      LD  (DRDN1),A
                                
       E020                     WRDF:               ;BCクラスタ分FATを確保する
001302 E020 110200          10      LD  DE,2
001305 E023 AF               4      XOR A
001306 E024 32E2E5          13      LD  (_SECPS),A
       E027                     WRDF1:
001309 E027 C5              11      PUSH    BC
00130A E028 D5              11      PUSH    DE
00130B E029 CDF7F0          17      CALL    _GNCL
00130E E02C 381C            12      JR  C,WRDF3
001310 E02E 7A               4      LD  A,D     ;空いているかチェック
001311 E02F B3               4      OR  E
001312 E030 202A            12      JR  NZ,WRDF4
001314 E032 E1              10      POP HL      ;HL=空いているクラスタ
001315 E033 E5              11      PUSH    HL
001316 E034 ED5BFEF1        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
00131A E038 22FEF1          16      LD  (_CLPS),HL
00131D E03B 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
00131E E03C B3               4      OR  E
00131F E03D 2008            12      JR  NZ,WRDF2
001321 E03F FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
001324 E042 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
001327 E045 1803            12      JR  WRDF3
       E047                     WRDF2:
001329 E047 CDFAF0          17      CALL    _SNCL
       E04A                     WRDF3:
00132C E04A D1              10      POP DE
00132D E04B C1              10      POP BC
00132E E04C D8              11      RET C
00132F E04D 0B               6      DEC BC
001330 E04E 78               4      LD  A,B
001331 E04F B1               4      OR  C
001332 E050 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
001334 E052 ED5BFEF1        20      LD  DE,(_CLPS)
001338 E056 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
00133B E059 C3FAF0          10      JP  _SNCL
                                
       E05C                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
00133E E05C D1              10      POP DE
00133F E05D C1              10      POP BC
       E05E                     WRDF5:
001340 E05E 13               6      INC DE
001341 E05F CD97DE          17      CALL    ENDCL
001344 E062 38C3            12      JR  C,WRDF1
001346 E064 37               4      SCF
001347 E065 C9              10      RET
                                
       E066                     RWXR:
001348 E066 3A57E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E069                     L_RWX:
00134B E069 1F               4      RRA     ;->CF
00134C E06A 3808            12      JR  C,E_RWX
00134E E06C CB38             8      SRL B   ;BCH=BCH/2
001350 E06E CB19             8      RR  C   ;
001352 E070 CB1C             8      RR  H   ;
001354 E072 18F5            12      JR  L_RWX
       E074                     E_RWX:
001356 E074 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001359 E077 FD561B          19      LD  D,(IY+27)
00135C E07A AF               4      XOR A
00135D E07B 32E2E5          13      LD  (_SECPS),A
       E07E                     RWX1:
001360 E07E ED53FEF1        20      LD  (_CLPS),DE
001364 E082 7A               4      LD  A,D
001365 E083 B3               4      OR  E
001366 E084 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
001368 E086 78               4      LD  A,B
001369 E087 B1               4      OR  C
00136A E088 B4               4      OR  H
00136B E089 C8              11      RET Z       ;RET BCH==0 => CF=0
                                
00136C E08A CDEAE5          17      CALL    GNCLX
00136F E08D D8              11      RET C
001370 E08E 7C               4      LD  A,H     ;
001371 E08F 25               4      DEC H       ;
001372 E090 B7               4      OR  A       ;DEC BCH
001373 E091 2001            12      JR  NZ,RWX2     ;
001375 E093 0B               6      DEC BC      ;
       E094                     RWX2:
001376 E094 CD97DE          17      CALL    ENDCL
001379 E097 38E5            12      JR  C,RWX1
       E099                     SCF_RET:
00137B E099 37               4      SCF
00137C E09A C9              10      RET
                                
       E09B                     DSKF:
00137D E09B 110000          10      LD  DE,0
       E09C                     MAXCLP  EQU $-2
001380 E09E 2AACF0          16      LD  HL,(_FAKEFREE)
001383 E0A1 7C               4      LD  A,H
001384 E0A2 B5               4      OR  L
001385 E0A3 2803            12      JR  Z,DSKF1
001387 E0A5 110100          10      LD  DE,1
       E0A8                     DSKF1:
00138A E0A8 D5              11      PUSH    DE
00138B E0A9 CDF7F0          17      CALL    _GNCL
00138E E0AC 380C            12      JR  C,POPSCF
001390 E0AE 7A               4      LD  A,D
001391 E0AF B3               4      OR  E
001392 E0B0 2001            12      JR  NZ,DSKF2
001394 E0B2 23               6      INC HL
       E0B3                     DSKF2:
001395 E0B3 D1              10      POP DE
001396 E0B4 1B               6      DEC DE
001397 E0B5 7A               4      LD  A,D
001398 E0B6 B3               4      OR  E
001399 E0B7 20EF            12      JR  NZ,DSKF1
00139B E0B9 C9              10      RET
                                
       E0BA                     POPSCF:
00139C E0BA F1              10      POP AF
00139D E0BB 37               4      SCF
00139E E0BC C9              10      RET
                                
       E0BD                     SETTMS:
00139F E0BD FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
0013A2 E0C0 3C               4      INC A
0013A3 E0C1 C0              11      RET NZ      ;ファイルが更新されていない
       E0C2                     SETTMSX:            ;FCBに日付時刻をセットする
0013A4 E0C2 CDB4D7          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
0013A7 E0C5 CB25             8      SLA L       ;   *2
0013A9 E0C7 CB25             8      SLA L       ;   *4
0013AB E0C9 29              11      ADD HL,HL       ;*2 *8
0013AC E0CA 29              11      ADD HL,HL       ;*4 *16
0013AD E0CB 29              11      ADD HL,HL       ;*8 *32
0013AE E0CC 7A               4      LD  A,D
0013AF E0CD 0F               4      RRCA            ;bit.0->7->->->0->C
0013B0 E0CE E61F             7      AND 01FH
0013B2 E0D0 B5               4      OR  L
0013B3 E0D1 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
0013B6 E0D4 FD7417          19      LD  (IY+23),H
                                
0013B9 E0D7 CDB4D7          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
0013BC E0DA 0144F8          10      LD  BC,0-1980
0013BF E0DD 09              11      ADD HL,BC
0013C0 E0DE 65               4      LD  H,L
                                
0013C1 E0DF 7A               4      LD  A,D
0013C2 E0E0 87               4      ADD A,A     ;*2
0013C3 E0E1 87               4      ADD A,A     ;*4
0013C4 E0E2 87               4      ADD A,A     ;*8
0013C5 E0E3 87               4      ADD A,A     ;*16
0013C6 E0E4 6F               4      LD  L,A
0013C7 E0E5 29              11      ADD HL,HL       ;*32
0013C8 E0E6 7D               4      LD  A,L
0013C9 E0E7 B3               4      OR  E
0013CA E0E8 FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
0013CD E0EB FD7415          19      LD  (IY+21),H
0013D0 E0EE C9              10      RET
                                ;(16)
       E0EF                     PUSHRR:
0013D1 E0EF 321BE4          13      LD  (SETSEQ_SWC_RND),A
0013D4 E0F2 222DE4          16      LD  (SETSEQ_SWC_SEQ_RR),HL
0013D7 E0F5 CD15E1          17      CALL    GET_RR_AHL
0013DA E0F8 220FF0          16      LD  (RR_BUF_HL),HL
0013DD E0FB 3211F0          13      LD  (RR_BUF_A),A
0013E0 E0FE C9              10      RET
                                ;(14)
       E0FF                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
0013E1 E0FF 87               4      ADD A,A     ;in BHLA => out AHL
0013E2 E100 ED6A            15      ADC HL,HL
0013E4 E102 CB18             8      RR  B
0013E6 E104 B7               4      OR  A
0013E7 E105 78               4      LD  A,B     ;ここでフラグは変化しない
0013E8 E106 C8              11      RET Z
0013E9 E107 2C               4      INC L       ;INC AHL
0013EA E108 C0              11      RET NZ      ;
0013EB E109 24               4      INC H       ;
0013EC E10A C0              11      RET NZ      ;
0013ED E10B 3C               4      INC A       ;
0013EE E10C C9              10      RET
                                ;(18)
       E10D                     INIT_RND:
0013EF E10D 3ECD             7      LD  A,0CDH      ;CALL ????
0013F1 E10F 212CE1          10      LD  HL,POPRR
0013F4 E112 CDEFE0          17      CALL    PUSHRR
       E115                     GET_RR_AHL:
0013F7 E115 FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
0013FA E118 FD6622          19      LD  H,(IY+34)   ;
0013FD E11B FD7E23          19      LD  A,(IY+35)   ;
001400 E11E C9              10      RET
                                ;(10)
       E11F                     SET_RR_AHL:
001401 E11F FD7521          19      LD  (IY+33),L   ;(FCB)Random record
001404 E122 FD7422          19      LD  (IY+34),H   ;
001407 E125 FD7723          19      LD  (IY+35),A   ;
00140A E128 C9              10      RET
                                ;(17)
       E129                     SETSEQ:
00140B E129 CD4EE1          17      CALL    SETSEQ1
       E12C                     POPRR:
00140E E12C F5              11      PUSH    AF
00140F E12D E5              11      PUSH    HL
001410 E12E 2A0FF0          16      LD  HL,(RR_BUF_HL)
001413 E131 3A11F0          13      LD  A,(RR_BUF_A)
001416 E134 CD1FE1          17      CALL    SET_RR_AHL
001419 E137 E1              10      POP HL
00141A E138 F1              10      POP AF
00141B E139 C9              10      RET
                                ;(20)
       E13A                     GET_RR_BCDE:            ;BCDE=Random record
00141C E13A FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
00141F E13D FD5622          19      LD  D,(IY+34)
001422 E140 FD4E23          19      LD  C,(IY+35)
001425 E143 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
001427 E145 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00142B E149 C0              11      RET NZ
00142C E14A FD4624          19      LD  B,(IY+36)
00142F E14D C9              10      RET
                                
       E14E                     SETSEQ1:
001430 E14E F5              11      PUSH    AF
001431 E14F E5              11      PUSH    HL      ;AHL=Random record
001432 E150 CD15E1          17      CALL    GET_RR_AHL
001435 E153 47               4      LD  B,A     ;AHL→HLA
001436 E154 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
001437 E155 6C               4      LD  L,H     ;(IY+34)
001438 E156 60               4      LD  H,B     ;(IY+35)
001439 E157 0600             7      LD  B,0
                                
00143B E159 CDFFE0          17      CALL    GET_CPM_R_SIZE
                                
00143E E15C 29              11      ADD HL,HL
00143F E15D CB3D             8      SRL L       ;L=L/2
001441 E15F FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
001444 E162 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
001447 E165 E1              10      POP HL
001448 E166 F1              10      POP AF
001449 E167 C9              10      RET
                                
                                ;(23)
       E168                     RBXEND:             ;レコード数だけランダムレコードを進める
00144A E168 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       E169                     RBSIZE  EQU $-2
00144D E16B CD15E1          17      CALL    GET_RR_AHL
001450 E16E 19              11      ADD HL,DE
001451 E16F CE00             7      ADC A,0
001453 E171 CD1FE1          17      CALL    SET_RR_AHL
001456 E174 EB               4      EX  DE,HL       ;HL=進めるレコード数
001457 E175 D0              11      RET NC
001458 E176 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00145C E17A C0              11      RET NZ
00145D E17B FD3424          23      INC (IY+36)
001460 E17E C9              10      RET
       E17F                     FILE_E:
                                
       DD29                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       DD29                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       DD29                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       DD29                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       DD29                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E17F                     _SYS26:     ;(BDOS)ランダムブロック書き込み
001461 E17F AF               4      XOR A
001462 E180 3268E4          13      LD  (DRDN1),A   ;NOP
001465 E183 2269E1          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
001468 E186 225DF0          16      LD  (LEFTX),HL
00146B E189 CD72DC          17      CALL    SETDRV
                                
00146E E18C CDF2E2          17      CALL    RBX0
001471 E18F DA1CE2          10      JP  C,RBWERR
001474 E192 CDFBDF          17      CALL    WOPEN
001477 E195 DA1CE2          10      JP  C,RBWERR
00147A E198 7C               4      LD  A,H
00147B E199 B5               4      OR  L
00147C E19A CA15E2          10      JP  Z,RBW1
                                
00147F E19D 2B               6      DEC HL
                                
001480 E19E CD3AE1          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001483 E1A1 19              11      ADD HL,DE       ;BCHL=HL+BCDE
001484 E1A2 3001            12      JR  NC,S26X1    ;
001486 E1A4 03               6      INC BC      ;
       E1A5                     S26X1:
001487 E1A5 CD66E0          17      CALL    RWXR
00148A E1A8 DC0CE0          17      CALL    C,WRDFX
00148D E1AB DA1CE2          10      JP  C,RBWERR
                                
001490 E1AE CD21E3          17      CALL    RBX2
001493 E1B1 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
001495 E1B3 CD40E3          17      CALL    RBXA
001498 E1B6 3864            12      JR  C,RBWERR
00149A E1B8 EB               4      EX  DE,HL
00149B E1B9 C5              11      PUSH    BC
00149C E1BA EDB0                    LDIR
00149E E1BC 225FF0          16      LD  (DTAX),HL
                                
0014A1 E1BF CD9DDF          17      CALL    WTDB        ;バッファデータは更新された
                                
0014A4 E1C2 2A5DF0          16      LD  HL,(LEFTX)
0014A7 E1C5 D1              10      POP DE
0014A8 E1C6 ED52            15      SBC HL,DE
0014AA E1C8 225DF0          16      LD  (LEFTX),HL
0014AD E1CB 2831            12      JR  Z,RBWEND
                                
       E1CD                     RBWB:
0014AF E1CD CD75E3          17      CALL    RBXB
0014B2 E1D0 2814            12      JR  Z,RBWC
       E1D2                     RBWB1:
0014B4 E1D2 C5              11      PUSH    BC
0014B5 E1D3 D5              11      PUSH    DE
0014B6 E1D4 CD7ADE          17      CALL    CLUSTX
0014B9 E1D7 CD99E3          17      CALL    DWTC
0014BC E1DA D1              10      POP DE
0014BD E1DB C1              10      POP BC
0014BE E1DC D4EAE5          17      CALL    NC,GNCLX
0014C1 E1DF 383B            12      JR  C,RBWERR
0014C3 E1E1 10EF            13      DJNZ    RBWB1
0014C5 E1E3 CDE9E3          17      CALL    DRW_FLUSH
       E1E6                     RBWC:
0014C8 E1E6 CD8DE3          17      CALL    RBXC
0014CB E1E9 2813            12      JR  Z,RBWEND
0014CD E1EB C5              11      PUSH    BC
0014CE E1EC CD7ADE          17      CALL    CLUSTX
0014D1 E1EF CD67E4          17      CALL    DRDN
0014D4 E1F2 C1              10      POP BC
0014D5 E1F3 3827            12      JR  C,RBWERR
0014D7 E1F5 ED5B7EF1        20      LD  DE,(_DTBUF)
0014DB E1F9 EDB0                    LDIR
0014DD E1FB CD9DDF          17      CALL    WTDB        ;バッファデータは更新された
       E1FE                     RBWEND:
0014E0 E1FE CD68E1          17      CALL    RBXEND
                                
0014E3 E201 CD01E3          17      CALL    RBX1
0014E6 E204 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
0014E8 E206 CD3AE1          17      CALL    GET_RR_BCDE ;BCDE=Random record
0014EB E209 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
0014EE E20C FD7211          19      LD  (IY+17),D   ;
0014F1 E20F FD7112          19      LD  (IY+18),C   ;
0014F4 E212 FD7013          19      LD  (IY+19),B   ;
       E215                     RBW1:
0014F7 E215 FDE1            14      POP IY
0014F9 E217 C1              10      POP BC
0014FA E218 D1              10      POP DE
0014FB E219 E1              10      POP HL
       E21A                     DD_NUL:
0014FC E21A AF               4      XOR A
       E21B                     DRDF0:
       E21B                     DWTF0:
0014FD E21B C9              10      RET
                                
       E21C                     RBWERR:
0014FE E21C FDE5            15      PUSH    IY
001500 E21E D1              10      POP DE
001501 E21F 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
001503 E221 CD45D4          17      CALL    BDOS0
       E224                     RBRERR1:
001506 E224 3E01             7      LD  A,001H
       E226                     RBRERR2:
001508 E226 FDE1            14      POP IY
00150A E228 C1              10      POP BC
00150B E229 D1              10      POP DE
00150C E22A E1              10      POP HL
00150D E22B 37               4      SCF
00150E E22C 210000          10      LD  HL,0
001511 E22F C9              10      RET
                                
       E230                     RBRERR:
001512 E230 3EFF             7      LD  A,0FFH
001514 E232 18F2            12      JR  RBRERR2
                                
       E234                     RBRFL:
001516 E234 3E00             7  RBRFLP: LD  A,000H
001518 E236 FE0D             7      CP  00DH
00151A E238 2005            12      JR  NZ,RBRFL1
00151C E23A D5              11      PUSH    DE
00151D E23B 1E0A             7      LD  E,00AH
00151F E23D 1805            12      JR  RBRFL2
       E23F                     RBRFL1:
001521 E23F D5              11      PUSH    DE
001522 E240 CD09F0          17      CALL    _SYS07
001525 E243 5F               4      LD  E,A
       E244                     RBRFL2:
001526 E244 CDCDF0          17      CALL    _PRINT
001529 E247 7B               4      LD  A,E
00152A E248 D1              10      POP DE
00152B E249 3235E2          13      LD  (RBRFLP+1),A
00152E E24C C9              10      RET
                                
                                                ;Read random block
       E24D                     _SYS27:     ;(BDOS)ランダムブロック読み込み
00152F E24D 225DF0          16      LD  (LEFTX),HL
001532 E250 CD72DC          17      CALL    SETDRV
                                
001535 E253 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
001539 E257 C2E0E2          10      JP  NZ,RBRDIR   ;ディレクトリ
00153C E25A CDF2E2          17      CALL    RBX0
00153F E25D DA30E2          10      JP  C,RBRERR
001542 E260 CD01E3          17      CALL    RBX1
001545 E263 D419E3          17      CALL    NC,RBX1R
001548 E266 DA24E2          10      JP  C,RBRERR1
00154B E269 EB               4      EX  DE,HL
00154C E26A ED52            15      SBC HL,DE       ;CP 00HL,BCDE
00154E E26C 19              11      ADD HL,DE
00154F E26D 79               4      LD  A,C
001550 E26E DE00             7      SBC A,0
001552 E270 78               4      LD  A,B
001553 E271 DE00             7      SBC A,0
001555 E273 3801            12      JR  C,RBR1
001557 E275 EB               4      EX  DE,HL
       E276                     RBR1:
001558 E276 9F               4      SBC A,A
001559 E277 E601             7      AND 1
00155B E279 32DEE2          13      LD  (RBRA_SWC),A
                                
00155E E27C 7C               4      LD  A,H
00155F E27D B5               4      OR  L
001560 E27E 2857            12      JR  Z,RBREND0
                                
001562 E280 2269E1          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
001565 E283 225DF0          16      LD  (LEFTX),HL
                                
001568 E286 CD21E3          17      CALL    RBX2
00156B E289 2819            12      JR  Z,RBRB
00156D E28B CD40E3          17      CALL    RBXA
001570 E28E DA30E2          10      JP  C,RBRERR
001573 E291 C5              11      PUSH    BC
001574 E292 EDB0                    LDIR
001576 E294 ED535FF0        20      LD  (DTAX),DE
00157A E298 2A5DF0          16      LD  HL,(LEFTX)
00157D E29B D1              10      POP DE
00157E E29C A7               4      AND A
00157F E29D ED52            15      SBC HL,DE
001581 E29F 225DF0          16      LD  (LEFTX),HL
001584 E2A2 2830            12      JR  Z,RBREND
                                
       E2A4                     RBRB:
001586 E2A4 CD75E3          17      CALL    RBXB
001589 E2A7 2815            12      JR  Z,RBRC
       E2A9                     RBRB1:
00158B E2A9 C5              11      PUSH    BC
00158C E2AA D5              11      PUSH    DE
00158D E2AB CD7ADE          17      CALL    CLUSTX
001590 E2AE CD9FE3          17      CALL    DRDC
001593 E2B1 D1              10      POP DE
001594 E2B2 C1              10      POP BC
001595 E2B3 D4EAE5          17      CALL    NC,GNCLX
001598 E2B6 DA30E2          10      JP  C,RBRERR
00159B E2B9 10EE            13      DJNZ    RBRB1
00159D E2BB CDE9E3          17      CALL    DRW_FLUSH
       E2BE                     RBRC:
0015A0 E2BE CD8DE3          17      CALL    RBXC
0015A3 E2C1 2811            12      JR  Z,RBREND
0015A5 E2C3 C5              11      PUSH    BC
0015A6 E2C4 CD7ADE          17      CALL    CLUSTX
0015A9 E2C7 CD4BE4          17      CALL    DRDX
0015AC E2CA C1              10      POP BC
0015AD E2CB DA30E2          10      JP  C,RBRERR
0015B0 E2CE EB               4      EX  DE,HL
0015B1 E2CF 2A7EF1          16      LD  HL,(_DTBUF)
0015B4 E2D2 EDB0                    LDIR
       E2D4                     RBREND:
0015B6 E2D4 CD68E1          17      CALL    RBXEND
       E2D7                     RBREND0:
0015B9 E2D7 FDE1            14      POP IY
0015BB E2D9 C1              10      POP BC
0015BC E2DA D1              10      POP DE
0015BD E2DB F1              10      POP AF  ;(HL)
0015BE E2DC AF               4      XOR A
0015BF E2DD 3E00             7      LD  A,000H
       E2DE                     RBRA_SWC    EQU $-1
0015C1 E2DF C9              10      RET
                                
       E2E0                     RBRDIR:
0015C2 E2E0 FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0015C5 E2E3 FD661B          19      LD  H,(IY+27)
0015C8 E2E6 CDB9DE          17      CALL    CHDIR
0015CB E2E9 AF               4      XOR A
0015CC E2EA 67               4      LD  H,A
0015CD E2EB 6F               4      LD  L,A
0015CE E2EC 3C               4      INC A
0015CF E2ED 32DEE2          13      LD  (RBRA_SWC),A
0015D2 E2F0 18E5            12      JR  RBREND0
                                ;(15)
       E2F2                     RBX0:
0015D4 E2F2 2A8AF0          16      LD  HL,(_DTA)
0015D7 E2F5 225FF0          16      LD  (DTAX),HL
0015DA E2F8 2A5DF0          16      LD  HL,(LEFTX)
0015DD E2FB FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0015E0 E2FE D6FD             7      SUB 0FDH
0015E2 E300 C9              10      RET
                                
       E301                     RBX1:               ;ファイルサイズとランダムレコードを比べる
0015E3 E301 E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
0015E4 E302 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
0015E7 E305 FD6611          19      LD  H,(IY+17)   ;
0015EA E308 FD7E12          19      LD  A,(IY+18)   ;
                                
0015ED E30B CD3AE1          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0015F0 E30E A7               4      AND A
0015F1 E30F ED52            15      SBC HL,DE
0015F3 E311 99               4      SBC A,C
0015F4 E312 4F               4      LD  C,A
0015F5 E313 FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
0015F8 E316 98               4      SBC A,B
0015F9 E317 D1              10      POP DE
0015FA E318 C9              10      RET
       E319                     RBX1R:              ;(8)
0015FB E319 47               4      LD  B,A
0015FC E31A B1               4      OR  C
0015FD E31B EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
0015FE E31C B2               4      OR  D
0015FF E31D B3               4      OR  E
001600 E31E C0              11      RET NZ
001601 E31F 37               4      SCF
001602 E320 C9              10      RET
                                
       E321                     RBX2:               ;Cluster settings
001603 E321 FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
001606 E324 FD4E23          19      LD  C,(IY+35)
001609 E327 0600             7      LD  B,0
00160B E329 FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00160F E32D 2003            12      JR  NZ,RBX3
001611 E32F FD4624          19      LD  B,(IY+36)
       E332                     RBX3:
001614 E332 CD66E0          17      CALL    RWXR
001617 E335 3A57E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
00161A E338 3D               4      DEC A
00161B E339 FDA622          19      AND (IY+34)
00161E E33C FDB621          19      OR  (IY+33)
001621 E33F C9              10      RET
                                
       E340                     RBXA:
001622 E340 C5              11      PUSH    BC
001623 E341 D5              11      PUSH    DE
001624 E342 CD7ADE          17      CALL    CLUSTX
001627 E345 CD4BE4          17      CALL    DRDX
00162A E348 D1              10      POP DE
00162B E349 C1              10      POP BC
00162C E34A D4EAE5          17      CALL    NC,GNCLX
00162F E34D D8              11      RET C
001630 E34E ED53FEF1        20      LD  (_CLPS),DE
                                
001634 E352 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
001637 E355 210004          10      LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
       E356                     SECSZ   EQU $-2
       E357                     SECSZ_H EQU $-1
00163A E358 7C               4      LD  A,H
00163B E359 3D               4      DEC A       ;1024=3 / 512=1
00163C E35A FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
00163F E35D 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
001640 E35E ED42            15      SBC HL,BC       ;残りを計算
                                
001642 E360 ED5B5DF0        20      LD  DE,(LEFTX)
001646 E364 ED52            15      SBC HL,DE       ;CP HL,DE
001648 E366 19              11      ADD HL,DE       ;
001649 E367 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
00164B E369 EB               4      EX  DE,HL
       E36A                     RBXA1:
00164C E36A E5              11      PUSH    HL
00164D E36B 2A7EF1          16      LD  HL,(_DTBUF)
001650 E36E 09              11      ADD HL,BC
001651 E36F ED5B5FF0        20      LD  DE,(DTAX)
001655 E373 C1              10      POP BC
001656 E374 C9              10      RET
                                
       E375                     RBXB:
001657 E375 2A5FF0          16      LD  HL,(DTAX)
00165A E378 ED5BFEF1        20      LD  DE,(_CLPS)
00165E E37C 3A5EF0          13      LD  A,(LEFTX+1)
001661 E37F 47               4      LD  B,A
001662 E380 3A57E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
       E383                     RBXB1:
001665 E383 1F               4      RRA     ;->CF
001666 E384 3804            12      JR  C,RBXB2
001668 E386 CB38             8      SRL B   ;B=B/2
00166A E388 18F9            12      JR  RBXB1
       E38A                     RBXB2:
00166C E38A 78               4      LD  A,B
00166D E38B B7               4      OR  A
00166E E38C C9              10      RET
                                ;(12)
       E38D                     RBXC:
00166F E38D ED4B5DF0        20      LD  BC,(LEFTX)
001673 E391 3A57E3          13      LD  A,(SECSZ_H) ;1024=4 / 512=2 / 256=1
001676 E394 3D               4      DEC A
001677 E395 A0               4      AND B
001678 E396 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
001679 E397 B1               4      OR  C
00167A E398 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E399                     DWTC:
00167B E399 E5              11      PUSH    HL
00167C E39A 2181E7          10      LD  HL,DWT24B
00167F E39D 1804            12      JR  DWTC1
       E39F                     DRDC:
001681 E39F E5              11      PUSH    HL
001682 E3A0 2173E7          10      LD  HL,DRD24B
       E3A3                     DWTC1:
001685 E3A3 22FDE3          16      LD  (DRWF_MODE),HL
001688 E3A6 E1              10      POP HL
001689 E3A7 3AEDE3          13      LD  A,(DRWF_B)
00168C E3AA B7               4      OR  A
00168D E3AB 200F            12      JR  NZ,DRDC1
       E3AD                     SAVE_DRWC:
00168F E3AD 0601             7      LD  B,1
001691 E3AF ED43ECE3        20      LD  (DRWF_C),BC
001695 E3B3 ED53F3E3        20      LD  (DRWF_E),DE
001699 E3B7 22F6E3          16      LD  (DRWF_HL),HL
00169C E3BA 1820            12      JR  INC_HL_DRWC
       E3BC                     DRDC1:
00169E E3BC E5              11      PUSH    HL
00169F E3BD 21F3E3          10      LD  HL,DRWF_E
0016A2 E3C0 86               7      ADD A,(HL)
0016A3 E3C1 F5              11      PUSH    AF
0016A4 E3C2 BB               4      CP  E
0016A5 E3C3 201D            12      JR  NZ,DRDC2
0016A7 E3C5 F1              10      POP AF
0016A8 E3C6 23               6      INC HL
0016A9 E3C7 7E               7      LD  A,(HL)
0016AA E3C8 CE00             7      ADC A,0
0016AC E3CA F5              11      PUSH    AF
0016AD E3CB BA               4      CP  D
0016AE E3CC 2014            12      JR  NZ,DRDC2
0016B0 E3CE F1              10      POP AF
0016B1 E3CF 3AECE3          13      LD  A,(DRWF_C)
0016B4 E3D2 CE00             7      ADC A,0
0016B6 E3D4 B9               4      CP  C
0016B7 E3D5 200C            12      JR  NZ,DRDC3
0016B9 E3D7 21EDE3          10      LD  HL,DRWF_B
0016BC E3DA 34              11      INC (HL)
0016BD E3DB E1              10      POP HL
       E3DC                     INC_HL_DRWC:
0016BE E3DC 3A57E3          13      LD  A,(SECSZ_H)     ;1セクタのサイズの上位1バイト
0016C1 E3DF 84               4      ADD A,H
0016C2 E3E0 67               4      LD  H,A
0016C3 E3E1 C9              10      RET
       E3E2                     DRDC2:
0016C4 E3E2 F1              10      POP AF
       E3E3                     DRDC3:
0016C5 E3E3 CDE9E3          17      CALL    DRW_FLUSH
0016C8 E3E6 E1              10      POP HL
0016C9 E3E7 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E3E9                     DRW_FLUSH:
0016CB E3E9 C5              11      PUSH    BC
0016CC E3EA D5              11      PUSH    DE
0016CD E3EB 010000          10      LD  BC,0
       E3EC                     DRWF_C  EQU $-2
       E3ED                     DRWF_B  EQU $-1
0016D0 E3EE 78               4      LD  A,B
0016D1 E3EF B7               4      OR  A
0016D2 E3F0 280D            12      JR  Z,DRDF1
0016D4 E3F2 110000          10      LD  DE,0
       E3F3                     DRWF_E  EQU $-2
       E3F4                     DRWF_D  EQU $-1
0016D7 E3F5 210000          10      LD  HL,0
       E3F6                     DRWF_HL EQU $-2
0016DA E3F8 AF               4      XOR A
0016DB E3F9 32EDE3          13      LD  (DRWF_B),A
0016DE E3FC CD73E7          17      CALL    DRD24B
       E3FD                     DRWF_MODE   EQU $-2
       E3FF                     DRDF1:
0016E1 E3FF D1              10      POP DE
0016E2 E400 C1              10      POP BC
0016E3 E401 C9              10      RET
                                
       E402                     RB_WRITE:
0016E4 E402 C5              11      PUSH    BC
0016E5 E403 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
0016E7 E405 1803            12      JR  RBRW
       E407                     RB_READ:
0016E9 E407 C5              11      PUSH    BC
0016EA E408 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
       E40A                     RBRW:
0016EC E40A 1F               4      RRA     ;AHL = AHL*128
0016ED E40B 7C               4      LD  A,H ;AHL = AHL0/2
0016EE E40C 1F               4      RRA     ;A
0016EF E40D 65               4      LD  H,L ;
0016F0 E40E CB1C             8      RR  H   ;H
0016F2 E410 2E00             7      LD  L,0 ;
0016F4 E412 CB1D             8      RR  L   ;L
0016F6 E414 CD1FE1          17      CALL    SET_RR_AHL
0016F9 E417 218000          10      LD  HL,128
0016FC E41A C5              11      PUSH    BC
       E41B                     SETSEQ_SWC_RND:
0016FD E41B CD4EE1          17      CALL    SETSEQ1     ;CALL SETSEQ1 or LD BC,SETSEQ1
001700 E41E C1              10      POP BC
001701 E41F FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
001705 E423 FDE5            15      PUSH    IY
001707 E425 D1              10      POP DE
001708 E426 D5              11      PUSH    DE
001709 E427 CD45D4          17      CALL    BDOS0
00170C E42A FDE1            14      POP IY
00170E E42C CD29E1          17      CALL    SETSEQ      ;SETSEQ or POPRR
       E42D                     SETSEQ_SWC_SEQ_RR   EQU $-2
001711 E42F FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
001715 E433 C1              10      POP BC
001716 E434 C9              10      RET
                                
                                ;(22)
       E435                     INIT_SEQ:
001717 E435 3E01             7      LD  A,1     ;LD BC,????
001719 E437 2129E1          10      LD  HL,SETSEQ
00171C E43A CDEFE0          17      CALL    PUSHRR
       E43D                     GETSEQ:
00171F E43D FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
001722 E440 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
001725 E443 AF               4      XOR A
                                
001726 E444 CB25             8      SLA L   ;L=L*2
                                
001728 E446 CB3C             8      SRL H   ;HL=HL/2
00172A E448 CB1D             8      RR  L   ;
00172C E44A C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E44B                     DRDX:
00172D E44B CD89E4          17      CALL    DRDY
001730 E44E C8              11      RET Z
001731 E44F CD6FE4          17      CALL    DRDX1       ;データバッファの情報を保存
001734 E452 D8              11      RET C
001735 E453 E5              11      PUSH    HL
001736 E454 C5              11      PUSH    BC
001737 E455 D5              11      PUSH    DE
001738 E456 2A7EF1          16      LD  HL,(_DTBUF)
00173B E459 3AB2E4          13      LD  A,(_DBS24)
00173E E45C 4F               4      LD  C,A
00173F E45D CD71E7          17      CALL    DRD24
001742 E460 DC84E4          17      CALL    C,DRDNE
       E463                     POP_DE_BC_HL_RET:
001745 E463 D1              10      POP DE
001746 E464 C1              10      POP BC
001747 E465 E1              10      POP HL
001748 E466 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E467                     DRDN:
001749 E467 AF               4      XOR A
00174A E468 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
00174B E469 30E0            12      JR  NC,DRDX
       E46B                     DRDNX:
00174D E46B CD89E4          17      CALL    DRDY
001750 E46E C8              11      RET Z
       E46F                     DRDX1:
001751 E46F CD9FE4          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
001754 E472 ED53A6F0        20      LD  (_DBSEC),DE
001758 E476 79               4      LD  A,C
001759 E477 32B2E4          13      LD  (_DBS24),A
                                
00175C E47A 3A88F0          13      LD  A,(_DRV)
00175F E47D 32A5F0          13      LD  (_DBDRV),A
001762 E480 CDD9F0          17      CALL    _CHGDRV
001765 E483 D0              11      RET NC
       E484                     DRDNE:
001766 E484 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001767 E485 32A5F0          13      LD  (_DBDRV),A
00176A E488 C9              10      RET
                                
                                ;   CDE:セクタ番号
       E489                     DRDY:
00176B E489 3AB2E4          13      LD  A,(_DBS24)
00176E E48C B9               4      CP  C
00176F E48D C0              11      RET NZ
                                
001770 E48E E5              11      PUSH    HL
001771 E48F 3A88F0          13      LD  A,(_DRV)
001774 E492 21A5F0          10      LD  HL,_DBDRV
001777 E495 AE               7      XOR (HL)
001778 E496 2005            12      JR  NZ,POP_HL_RET
                                
00177A E498 2AA6F0          16      LD  HL,(_DBSEC)
00177D E49B ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E49D                     POP_HL_RET:
00177F E49D E1              10      POP HL
001780 E49E C9              10      RET
                                
       E49F                     DWTX:
001781 E49F 3AA4F0          13      LD  A,(_WTDBF)
001784 E4A2 B7               4      OR  A
001785 E4A3 C8              11      RET Z
001786 E4A4 AF               4      XOR A
001787 E4A5 32A4F0          13      LD  (_WTDBF),A
                                
00178A E4A8 E5              11      PUSH    HL
00178B E4A9 C5              11      PUSH    BC
00178C E4AA D5              11      PUSH    DE
00178D E4AB 3AA5F0          13      LD  A,(_DBDRV)
001790 E4AE CDD9F0          17      CALL    _CHGDRV
001793 E4B1 0E00             7      LD  C,0
       E4B2                     _DBS24  EQU $-1
001795 E4B3 ED5BA6F0        20      LD  DE,(_DBSEC)
001799 E4B7 2A7EF1          16      LD  HL,(_DTBUF)
00179C E4BA D47FE7          17      CALL    NC,DWT24
       E4BD                     POP_DE_BC_HL_RET2:
00179F E4BD 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E4BF                     RDFATX:
0017A1 E4BF E5              11      PUSH    HL
0017A2 E4C0 3A88F0          13      LD  A,(_DRV)
0017A5 E4C3 21AAF0          10      LD  HL,_FATDRV
0017A8 E4C6 AE               7      XOR (HL)
0017A9 E4C7 28D4            12      JR  Z,POP_HL_RET
                                
0017AB E4C9 C5              11      PUSH    BC
0017AC E4CA D5              11      PUSH    DE
0017AD E4CB DDE5            15      PUSH    IX
0017AF E4CD CDE9E4          17      CALL    WTFATX
0017B2 E4D0 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
0017B4 E4D2 AF               4      XOR A
0017B5 E4D3 32ABF0          13      LD  (_FATIX),A
0017B8 E4D6 3A88F0          13      LD  A,(_DRV)
0017BB E4D9 32AAF0          13      LD  (_FATDRV),A
0017BE E4DC CDE5F0          17      CALL    _RDFAT
       E4DF                     RDFATE2:
0017C1 E4DF 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
0017C3 E4E1 9F               4      SBC A,A     ;A=0xFF
0017C4 E4E2 32AAF0          13      LD  (_FATDRV),A
       E4E5                     POP_IX_DE_BC_HL_RET:
0017C7 E4E5 DDE1            14      POP IX
0017C9 E4E7 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E4E9                     WTFATX:
0017CB E4E9 3AA2F0          13      LD  A,(_WTFATF)
0017CE E4EC B7               4      OR  A
0017CF E4ED C8              11      RET Z
0017D0 E4EE AF               4      XOR A
0017D1 E4EF 32A2F0          13      LD  (_WTFATF),A
                                
0017D4 E4F2 E5              11      PUSH    HL
0017D5 E4F3 3AAAF0          13      LD  A,(_FATDRV)
0017D8 E4F6 21A5F0          10      LD  HL,_DBDRV
0017DB E4F9 AE               7      XOR (HL)
0017DC E4FA CC9FE4          17      CALL    Z,DWTX
0017DF E4FD 389E            12      JR  C,POP_HL_RET
0017E1 E4FF C5              11      PUSH    BC
0017E2 E500 D5              11      PUSH    DE
0017E3 E501 DDE5            15      PUSH    IX
0017E5 E503 CD90E7          17      CALL    FATSETUP
0017E8 E506 D481E7          17      CALL    NC,DWT24B
0017EB E509 18DA            12      JR  POP_IX_DE_BC_HL_RET
                                
       E50B                     N16CL1:
0017ED E50B 7A               4      LD  A,D
0017EE E50C B3               4      OR  E
0017EF E50D 37               4      SCF
0017F0 E50E C8              11      RET Z
                                
0017F1 E50F 7A               4      LD  A,D
0017F2 E510 1807            12      JR  NCL1X
       E512                     NCL1:
0017F4 E512 7A               4      LD  A,D
0017F5 E513 B3               4      OR  E
0017F6 E514 37               4      SCF
0017F7 E515 C8              11      RET Z
                                
0017F8 E516 7A               4      LD  A,D
0017F9 E517 CB3F             8      SRL A   ;/2
       E519                     NCL1X:
0017FB E519 CB3F             8      SRL A   ;/2
                                
0017FD E51B E5              11      PUSH    HL
0017FE E51C 323BE5          13      LD  (NCLPAT_FATIX),A    ;_FATIX
001801 E51F 2AAAF0          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
001804 E522 BC               4      CP  H
001805 E523 3A88F0          13      LD  A,(_DRV)    ;LDではフラグは変化しない
001808 E526 323AE5          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
00180B E529 2005            12      JR  NZ,NCL2     ;FATIXが違う
00180D E52B BD               4      CP  L
00180E E52C 2002            12      JR  NZ,NCL2     ;ドライブが違う
001810 E52E E1              10      POP HL
001811 E52F C9              10      RET
       E530                     NCL2:
001812 E530 C5              11      PUSH    BC
001813 E531 D5              11      PUSH    DE
001814 E532 DDE5            15      PUSH    IX
001816 E534 CDE9E4          17      CALL    WTFATX
001819 E537 38AC            12      JR  C,POP_IX_DE_BC_HL_RET
00181B E539 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E53B                     NCLPAT_FATIX    EQU $-1
       E53A                     NCLPAT_FATDRV   EQU $-2
00181E E53C ED43AAF0        20      LD  (_FATDRV),BC
001822 E540 CD65E7          17      CALL    RDFATS
001825 E543 189A            12      JR  RDFATE2
                                
       E545                     NCL3:
001827 E545 CB9A             8      RES 3,D
001829 E547 CB92             8      RES 2,D
00182B E549 6B               4      LD  L,E
00182C E54A 62               4      LD  H,D
00182D E54B CB3C             8      SRL H   ;
00182F E54D CB1D             8      RR  L   ;HLA=HLA/2
001831 E54F 1F               4      RRA     ;
001832 E550 F5              11      PUSH    AF
001833 E551 3AABF0          13      LD  A,(_FATIX)
001836 E554 0F               4      RRCA
001837 E555 300B            12      JR  NC,NCL3X1
001839 E557 3A57E3          13      LD  A,(SECSZ_H)
00183C E55A FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの際に先頭を512バイトずらす
00183E E55C 2004            12      JR  NZ,NCL3X1
001840 E55E 010002          10      LD  BC,512
001843 E561 09              11      ADD HL,BC
       E562                     NCL3X1:
001844 E562 F1              10      POP AF
001845 E563 ED4B7CF1        20      LD  BC,(_FATBF)
001849 E567 19              11      ADD HL,DE
00184A E568 09              11      ADD HL,BC
00184B E569 17               4      RLA
00184C E56A C9              10      RET
                                
       E56B                     GNCL:
00184D E56B CD12E5          17      CALL    NCL1        ;GET NEXT CLUSTER
001850 E56E D8              11      RET C
001851 E56F C5              11      PUSH    BC
001852 E570 E5              11      PUSH    HL
001853 E571 CD45E5          17      CALL    NCL3
001856 E574 3809            12      JR  C,GNC1
001858 E576 5E               7      LD  E,(HL)
001859 E577 23               6      INC HL
00185A E578 7E               7      LD  A,(HL)
00185B E579 E60F             7      AND 00FH
00185D E57B 57               4      LD  D,A
00185E E57C E1              10      POP HL
00185F E57D C1              10      POP BC
001860 E57E C9              10      RET
       E57F                     GNC1:
001861 E57F 7E               7      LD  A,(HL)
001862 E580 23               6      INC HL
001863 E581 56               7      LD  D,(HL)
001864 E582 0604             7      LD  B,4
       E584                     GNC1L:
001866 E584 CB3A             8      SRL D   ;DA=DA/2
001868 E586 1F               4      RRA     ;
001869 E587 10FB            13      DJNZ    GNC1L
                                
00186B E589 5F               4      LD  E,A
00186C E58A E1              10      POP HL
00186D E58B C1              10      POP BC
00186E E58C A7               4      AND A
00186F E58D C9              10      RET
                                
       E58E                     SNCL:
001870 E58E CD12E5          17      CALL    NCL1
001873 E591 D8              11      RET C
                                ;               SET NEXT CLUSTER
001874 E592 E5              11      PUSH    HL
001875 E593 C5              11      PUSH    BC
001876 E594 D5              11      PUSH    DE
001877 E595 E5              11      PUSH    HL
001878 E596 CD45E5          17      CALL    NCL3
00187B E599 D1              10      POP DE
                                ;CF=ODD
00187C E59A 7E               7      LD  A,(HL)
00187D E59B 73               7      LD  (HL),E
00187E E59C 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
001880 E59E 23               6      INC HL
001881 E59F ED67            18      RRD     ;M={A[3:0],E[3:0]}
001883 E5A1 7A               4      LD  A,D
001884 E5A2 1804            12      JR  SNC11
       E5A4                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
001886 E5A4 ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001888 E5A6 23               6      INC HL
001889 E5A7 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E5A8                     SNC11:
00188A E5A8 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
00188C E5AA B7               4      OR  A
00188D E5AB D1              10      POP DE
00188E E5AC C1              10      POP BC
00188F E5AD E1              10      POP HL
       E5AE                     FAT_CHANGED:
001890 E5AE 3EFF             7      LD  A,0FFH
001892 E5B0 32A2F0          13      LD  (_WTFATF),A
001895 E5B3 C9              10      RET
                                
       E5B4                     N16CL3:
001896 E5B4 C5              11      PUSH    BC
001897 E5B5 6B               4      LD  L,E
001898 E5B6 7A               4      LD  A,D
001899 E5B7 E601             7      AND 1
00189B E5B9 67               4      LD  H,A
00189C E5BA 29              11      ADD HL,HL
00189D E5BB ED4B7CF1        20      LD  BC,(_FATBF)
0018A1 E5BF 09              11      ADD HL,BC
0018A2 E5C0 C1              10      POP BC
0018A3 E5C1 C9              10      RET
                                
       E5C2                     GNCL16:
0018A4 E5C2 CD0BE5          17      CALL    N16CL1      ;GET NEXT CLUSTER for FAT16
0018A7 E5C5 D8              11      RET C
0018A8 E5C6 E5              11      PUSH    HL
0018A9 E5C7 CDB4E5          17      CALL    N16CL3
0018AC E5CA 5E               7      LD  E,(HL)
0018AD E5CB 23               6      INC HL
0018AE E5CC 56               7      LD  D,(HL)
0018AF E5CD E1              10      POP HL
0018B0 E5CE C9              10      RET
                                
       E5CF                     SNCL16:
0018B1 E5CF CD0BE5          17      CALL    N16CL1      ;SET NEXT CLUSTER for FAT16
0018B4 E5D2 D8              11      RET C
0018B5 E5D3 D5              11      PUSH    DE
0018B6 E5D4 E5              11      PUSH    HL
0018B7 E5D5 CDB4E5          17      CALL    N16CL3
0018BA E5D8 D1              10      POP DE      ;HL
0018BB E5D9 73               7      LD  (HL),E
0018BC E5DA 23               6      INC HL
0018BD E5DB 72               7      LD  (HL),D
0018BE E5DC 6B               4      LD  L,E
0018BF E5DD 62               4      LD  H,D
0018C0 E5DE D1              10      POP DE
0018C1 E5DF 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E5E1                     NEXTX:
0018C3 E5E1 3E00             7      LD  A,0 ;自己書き換え
       E5E2                     _SECPS  EQU $-1
0018C5 E5E3 3C               4      INC A
0018C6 E5E4 E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E5E5                     _NCPAT  EQU $-1
0018C8 E5E6 32E2E5          13      LD  (_SECPS),A
0018CB E5E9 C9              10      RET
                                
       E5EA                     GNCLX:
0018CC E5EA CDE1E5          17      CALL    NEXTX
0018CF E5ED C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
0018D0 E5EE C3F7F0          10      JP  _GNCL   ;次のクラスタを探す
                                
       E5F1                     RDFAT:
0018D3 E5F1 3E80             7      LD  A,080H
0018D5 E5F3 3270F0          13      LD  (CHECK),A
       E5F6                     RDFAT1:
0018D8 E5F6 3A88F0          13      LD  A,(_DRV)
0018DB E5F9 CD99E8          17      CALL    CHGDRVR
0018DE E5FC D8              11      RET C
0018DF E5FD DD7E12          19      LD  A,(IX+DPB_DEVICE)
0018E2 E600 CB6F             8      BIT 5,A
0018E4 E602 286C            12      JR  Z,RDFAT0X
0018E6 E604 2170F0          10      LD  HL,CHECK
0018E9 E607 A6               7      AND (HL)
0018EA E608 77               7      LD  (HL),A
0018EB E609 110000          10      LD  DE,0        ;BPB
0018EE E60C 2A7CF1          16      LD  HL,(_FATBF)
0018F1 E60F 0E00             7      LD  C,0
0018F3 E611 CD71E7          17      CALL    DRD24
0018F6 E614 3022            12      JR  NC,GETBPB
0018F8 E616 2170F0          10      LD  HL,CHECK
0018FB E619 CB06            15      RLC (HL)
0018FD E61B 3F               4      CCF
0018FE E61C D8              11      RET C
0018FF E61D DDCB0A1E        23      RR  (IX+DPB_FDMODE)
001903 E621 3F               4      CCF         ;フロッピーディスクのFDモード(2D/2HD)を切り替える
001904 E622 DDCB0A16        23      RL  (IX+DPB_FDMODE)
001908 E626 3A84F0          13      LD  A,(_DRIVE)
00190B E629 E603             7      AND 3
00190D E62B F680             7      OR  080H
00190F E62D 6F               4      LD  L,A
001910 E62E 26F0             7      LD  H,_CYL0/256
001912 E630 3EFF             7      LD  A,0FFH
001914 E632 3289F0          13      LD  (_DSK),A
001917 E635 77               7      LD  (HL),A
001918 E636 18BE            12      JR  RDFAT1
       E638                     GETBPB:
00191A E638 FDE5            15      PUSH    IY
00191C E63A FD2A7CF1        20      LD  IY,(_FATBF) ;BPB
001920 E63E CDF1F0          17      CALL    _BPB2DPB
001923 E641 FDE1            14      POP IY
001925 E643 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001928 E646 3025            12      JR  NC,GETBPBOK
00192A E648 E60F             7      AND 00FH
00192C E64A FE07             7      CP  7
00192E E64C 37               4      SCF
00192F E64D C0              11      RET NZ
001930 E64E DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
001934 E652 21C0F1          10      LD  HL,M2D
001937 E655 2006            12      JR  NZ,SETFDMODE
001939 E657 CD4AE7          17      CALL    CHECK1024
00193C E65A D8              11      RET C
00193D E65B 2ED2             7      LD  L,M2HD-STABLE
       E65D                     SETFDMODE:
00193F E65D DDE5            15      PUSH    IX
001941 E65F D1              10      POP DE
001942 E660 EDA0            16      LDI
001944 E662 EDA0            16      LDI
001946 E664 13               6      INC DE
001947 E665 13               6      INC DE
001948 E666 13               6      INC DE
001949 E667 13               6      INC DE
00194A E668 010C00          10      LD  BC,12
00194D E66B EDB0                    LDIR
       E66D                     GETBPBOK:
00194F E66D CD05E8          17      CALL    CHGDRV2
       E670                     RDFAT0X:
001952 E670 CD65E7          17      CALL    RDFATS
001955 E673 D8              11      RET C
001956 E674 DDAE06          19      XOR (IX+DPB_FATID)
001959 E677 C8              11      RET Z
00195A E678 DD7E12          19      LD  A,(IX+DPB_DEVICE)
00195D E67B CB5F             8      BIT 3,A
00195F E67D 2803            12      JR  Z,RDFAT0X1
001961 E67F CB6F             8      BIT 5,A
001963 E681 C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
       E682                     RDFAT0X1:
001964 E682 37               4      SCF
001965 E683 C9              10      RET
                                
       E684                     POP_HL_SCF_RET:
001966 E684 E1              10      POP HL
001967 E685 37               4      SCF
001968 E686 C9              10      RET
                                
       E687                     BPB2DPB:
001969 E687 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
00196C E68A B7               4      OR  A
00196D E68B 37               4      SCF
00196E E68C C0              11      RET NZ
       E68D                     BPBOK:
00196F E68D FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001972 E690 DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001975 E693 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001978 E696 DD7700          19      LD  (IX+DPB_FATLN),A
00197B E699 FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
00197E E69C DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
001981 E69F FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001984 E6A2 FD660F          19      LD  H,(IY+15)
001987 E6A5 DD750E          19      LD  (IX+DPB_FATPS),L
00198A E6A8 FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
00198D E6AB FD5617          19      LD  D,(IY+23)
001990 E6AE FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E6B1                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001993 E6B1 19              11      ADD HL,DE
001994 E6B2 10FD            13      DJNZ    BPBDP1
       E6B4                     BPBDP2:
001996 E6B4 DD7510          19      LD  (IX+DPB_DIRPS),L
001999 E6B7 DD7411          19      LD  (IX+DPB_DIRPS+1),H
00199C E6BA E5              11      PUSH    HL
                                
00199D E6BB FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
0019A0 E6BE FD6612          19      LD  H,(IY+18)
0019A3 E6C1 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
0019A6 E6C4 B7               4      OR  A
0019A7 E6C5 28BD            12      JR  Z,POP_HL_SCF_RET
0019A9 E6C7 0606             7      LD  B,6
       E6C9                     BPBBPS1:
0019AB E6C9 05               4      DEC B
0019AC E6CA 0F               4      RRCA
0019AD E6CB 30FC            12      JR  NC,BPBBPS1
       E6CD                     BPBDE1:
0019AF E6CD 29              11      ADD HL,HL
0019B0 E6CE 10FD            13      DJNZ    BPBDE1
                                
0019B2 E6D0 7C               4      LD  A,H
0019B3 E6D1 DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
0019B6 E6D4 D1              10      POP DE      ;DPB_DIRPS
0019B7 E6D5 6C               4      LD  L,H
0019B8 E6D6 2600             7      LD  H,0
0019BA E6D8 19              11      ADD HL,DE       ;MAXDIR
0019BB E6D9 E5              11      PUSH    HL
0019BC E6DA FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
0019BF E6DD CB21             8      SLA C       ;*2
0019C1 E6DF AF               4      XOR A
0019C2 E6E0 47               4      LD  B,A
0019C3 E6E1 ED42            15      SBC HL,BC
0019C5 E6E3 DD7514          19      LD  (IX+DPB_ADDCL),L
0019C8 E6E6 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
0019CB E6E9 D1              10      POP DE      ;DE=DPB_MAXDIR
0019CC E6EA FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
0019CF E6ED FD6614          19      LD  H,(IY+20)
                                
0019D2 E6F0 DD7E12          19      LD  A,(IX+DPB_DEVICE)
0019D5 E6F3 E60F             7      AND 00FH
0019D7 E6F5 FE07             7      CP  7       ;フロッピー
0019D9 E6F7 2019            12      JR  NZ,NOT_FD
0019DB E6F9 E5              11      PUSH    HL
0019DC E6FA FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
0019DF E6FD DD710D          19      LD  (IX+DPB_MAXSEC),C
0019E2 E700 AF               4      XOR A
0019E3 E701 CB21             8      SLA C       ;両面なのでセクタ数を２倍
0019E5 E703 0610             7      LD  B,16
       E705                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
0019E7 E705 29              11      ADD HL,HL
0019E8 E706 17               4      RLA
0019E9 E707 B9               4      CP  C
0019EA E708 3802            12      JR  C,DIVSEC1
0019EC E70A 91               4      SUB C
0019ED E70B 2C               4      INC L
       E70C                     DIVSEC1:
0019EE E70C 10F7            13      DJNZ    DIVSEC
0019F0 E70E DD750C          19      LD  (IX+DPB_MAXCYL),L
0019F3 E711 E1              10      POP HL  ;ここまでフロッピー専用
       E712                     NOT_FD:
0019F4 E712 7C               4      LD  A,H
0019F5 E713 B5               4      OR  L
0019F6 E714 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
0019F8 E716 200E            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
0019FA E718 2F               4      CPL         ;A=0FFH
0019FB E719 FD8623          19      ADD A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
0019FE E71C D8              11      RET C
0019FF E71D FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
001A02 E720 FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので、
001A05 E723 FD7E22          19      LD  A,(IY+34)   ;FAT12,FAT16では総セクタ数が24ビットを超えることは無い
       E726                     BPB16BIT:
001A08 E726 ED52            15      SBC HL,DE       ;DE=DPB_MAXDIR
001A0A E728 DE00             7      SBC A,0
001A0C E72A FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E72D                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
001A0F E72D CB18             8      RR  B       ;->CY
001A11 E72F 3808            12      JR  C,BPBTC2
001A13 E731 CB3F             8      SRL A
001A15 E733 CB1C             8      RR  H       ;AHL=AHL/2
001A17 E735 CB1D             8      RR  L
001A19 E737 18F4            12      JR  BPBTC1
       E739                     BPBTC2:
001A1B E739 C6FF             7      ADD A,0FFH
001A1D E73B D8              11      RET C       ;念のため(クラスタ数が16ビットを超える場合)
001A1E E73C 23               6      INC HL
001A1F E73D 23               6      INC HL
001A20 E73E DD7508          19      LD  (IX+DPB_MAXCL),L
001A23 E741 DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
001A26 E744 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
001A29 E747 DD7706          19      LD  (IX+DPB_FATID),A
       E74A                     CHECK1024:
001A2C E74A FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
001A2F E74D C6FE             7      ADD A,0-2       ;>2:CF=1
001A31 E74F FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001A34 E752 6F               4      LD  L,A
001A35 E753 3002            12      JR  NC,BPBFAT1
001A37 E755 F680             7      OR  080H
       E757                     BPBFAT1:            ;ここではCF=0
001A39 E757 DD770F          19      LD  (IX+DPB_BPS),A
001A3C E75A 3A7BF1          13      LD  A,(_MAX_SEC_SZ_H)
001A3F E75D BD               4      CP  L
001A40 E75E C8              11      RET Z       ;1セクタ1024バイト
001A41 E75F 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
001A42 E760 C8              11      RET Z       ;1セクタ256バイト
001A43 E761 2D               4      DEC L
001A44 E762 C8              11      RET Z       ;1セクタ512バイト
001A45 E763 37               4      SCF
001A46 E764 C9              10      RET
                                
       E765                     RDFATS:
001A47 E765 CD90E7          17      CALL    FATSETUP
001A4A E768 D8              11      RET C
001A4B E769 CD73E7          17      CALL    DRD24B
001A4E E76C 2A7CF1          16      LD  HL,(_FATBF)
001A51 E76F 7E               7      LD  A,(HL)
001A52 E770 C9              10      RET
                                
       E771                     DRD24:
001A53 E771 0601             7      LD  B,1
       E773                     DRD24B:
001A55 E773 DDE5            15      PUSH    IX
001A57 E775 DD2AA8F0        20      LD  IX,(_DPB)
001A5B E779 CDD9E9          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E77A                     DRDPAT  EQU $-2
001A5E E77C DDE1            14      POP IX
001A60 E77E C9              10      RET
                                
       E77F                     DWT24:
001A61 E77F 0601             7      LD  B,1
       E781                     DWT24B:
001A63 E781 DDE5            15      PUSH    IX
001A65 E783 DD2AA8F0        20      LD  IX,(_DPB)
001A69 E787 CD82E9          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E788                     DWTPAT  EQU $-2
001A6C E78A DDE1            14      POP IX
001A6E E78C D0              11      RET NC
001A6F E78D C35AF0          10      JP  _DISKE
                                
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ512毎に1KBを切り替える
                                ;------------------------
       E790                     FATSETUP:
001A72 E790 3AAAF0          13      LD  A,(_FATDRV)
001A75 E793 CD99E8          17      CALL    CHGDRVR     ;ドライブ切り替え
001A78 E796 D8              11      RET C
       E797                     FATS2:
001A79 E797 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001A7C E79A 0F               4      RRCA
001A7D E79B CDCBE7          17      CALL    FATSETUP12  ;自己書き換え
       E79C                     FATSX   EQU $-2
001A80 E79E 210000          10      LD  HL,0
001A83 E7A1 4A               4      LD  C,D
001A84 E7A2 54               4      LD  D,H
001A85 E7A3 3AABF0          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-127(0-07FH):65535*2/1024
001A88 E7A6 47               4      LD  B,A
001A89 E7A7 04               4      INC B
001A8A E7A8 DD7E00          19      LD  A,(IX+DPB_FATLN)
       E7AB                     FAT_SKP:
001A8D E7AB 05               4      DEC B
001A8E E7AC 2809            12      JR  Z,FAT1
001A90 E7AE 19              11      ADD HL,DE
001A91 E7AF 93               4      SUB E
001A92 E7B0 30F9            12      JR  NC,FAT_SKP
001A94 E7B2 DDCB0146        20      BIT 0,(IX+DPB_FATLN+1)  ;FATサイズが0100H(256)の場合
001A98 E7B6 C8              11      RET Z
       E7B7                     FAT1:
001A99 E7B7 EB               4      EX  DE,HL
001A9A E7B8 B7               4      OR  A       ;0の場合は0100Hとして扱う
001A9B E7B9 2803            12      JR  Z,FAT3
001A9D E7BB B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001A9E E7BC 3801            12      JR  C,FAT2
       E7BE                     FAT3:
001AA0 E7BE 79               4      LD  A,C
       E7BF                     FAT2:
001AA1 E7BF 47               4      LD  B,A
                                
001AA2 E7C0 2AFAF1          16      LD  HL,(_FATPS) ;fat sector pos
001AA5 E7C3 19              11      ADD HL,DE
001AA6 E7C4 EB               4      EX  DE,HL
001AA7 E7C5 2A7CF1          16      LD  HL,(_FATBF)
001AAA E7C8 AF               4      XOR A       ;CF=0
001AAB E7C9 4F               4      LD  C,A
001AAC E7CA C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E7CB                     FATSETUP12:
001AAD E7CB 110606          10      LD  DE,0606H    ;256
001AB0 E7CE D8              11      RET C
001AB1 E7CF 110303          10      LD  DE,0303H    ;512
001AB4 E7D2 0F               4      RRCA
001AB5 E7D3 D8              11      RET C
001AB6 E7D4 110102          10      LD  DE,0201H    ;1024
001AB9 E7D7 C9              10      RET
                                
       E7D8                     FATSETUP16:
001ABA E7D8 110404          10      LD  DE,0404H    ;256
001ABD E7DB D8              11      RET C
001ABE E7DC 110202          10      LD  DE,0202H    ;512
001AC1 E7DF 0F               4      RRCA
001AC2 E7E0 D8              11      RET C
001AC3 E7E1 110101          10      LD  DE,0101H    ;1024
001AC6 E7E4 C9              10      RET
                                
       E7E5                     CHGDRV:
001AC7 E7E5 E5              11      PUSH    HL
001AC8 E7E6 2189F0          10      LD  HL,_DSK
001ACB E7E9 BE               7      CP  (HL)
001ACC E7EA 280A            12      JR  Z,CHGDRVE
       E7EC                     CHGDRV1:
001ACE E7EC DDE5            15      PUSH    IX
001AD0 E7EE CDF8E7          17      CALL    CHGDRV0
001AD3 E7F1 3A89F0          13      LD  A,(_DSK)
001AD6 E7F4 DDE1            14      POP IX
       E7F6                     CHGDRVE:
001AD8 E7F6 E1              10      POP HL
001AD9 E7F7 C9              10      RET
                                
       E7F8                     CHGDRV0:
001ADA E7F8 6F               4      LD  L,A
001ADB E7F9 CDDCF0          17      CALL    _GETDPB
001ADE E7FC D8              11      RET C
001ADF E7FD DD22A8F0        20      LD  (_DPB),IX
001AE3 E801 7D               4      LD  A,L
001AE4 E802 3289F0          13      LD  (_DSK),A
       E805                     CHGDRV2:
001AE7 E805 C5              11      PUSH    BC
001AE8 E806 D5              11      PUSH    DE
001AE9 E807 ED7350E8        20      LD  (SPPAT2),SP
001AED E80B F3               4      DI
001AEE E80C DDF9            10      LD  SP,IX
                                
001AF0 E80E E1              10      POP HL      ;00:DPB_FATLN
001AF1 E80F E1              10      POP HL      ;02:DPB_DRD
001AF2 E810 227AE7          16      LD  (DRDPAT),HL
                                
001AF5 E813 E1              10      POP HL
001AF6 E814 2288E7          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001AF9 E817 E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001AFA E818 7C               4      LD  A,H
001AFB E819 327EDE          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001AFE E81C 3D               4      DEC A
001AFF E81D 32E5E5          13      LD  (_NCPAT),A
                                
001B02 E820 E1              10      POP HL      ;08:DPB_MAXCL
001B03 E821 7D               4      LD  A,L
001B04 E822 329DDE          13      LD  (CLPAT2),A
001B07 E825 7C               4      LD  A,H
001B08 E826 3299DE          13      LD  (CLPAT1),A
001B0B E829 2B               6      DEC HL
001B0C E82A 229CE0          16      LD  (MAXCLP),HL
                                
001B0F E82D E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001B10 E82E 4C               4      LD  C,H
                                
001B11 E82F E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001B12 E830 E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001B13 E831 7C               4      LD  A,H     ;DPB_BPS
001B14 E832 E607             7      AND 7
001B16 E834 3257E3          13      LD  (SECSZ_H),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98等
                                                ;1セクタ256 GRAM/RAMF/CMOS等
                                                ;1024   512 256
                                                ;4  2   1
001B19 E837 87               4      ADD A,A     ;8  4   2
001B1A E838 87               4      ADD A,A     ;010H   8   4
001B1B E839 87               4      ADD A,A     ;020H   010H    8
001B1C E83A 32FCDC          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001B1F E83D 2600             7      LD  H,0
001B21 E83F 22FAF1          16      LD  (_FATPS),HL
                                
001B24 E842 E1              10      POP HL      ;10:DPB_DIRPS
001B25 E843 22FCF1          16      LD  (_DIRPS),HL
                                
001B28 E846 E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001B29 E847 7C               4      LD  A,H
001B2A E848 3284F0          13      LD  (_DRIVE),A
                                
001B2D E84B E1              10      POP HL      ;14:DPB_ADDCL
001B2E E84C 228EDE          16      LD  (CLSPAT),HL
                                
001B31 E84F 310000          10      LD  SP,0        ;元のSPを復元
       E850                     SPPAT2  EQU $-2
001B34 E852 FB               4      EI
001B35 E853 2AFCF1          16      LD  HL,(_DIRPS)
001B38 E856 0600             7      LD  B,0
001B3A E858 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001B3B E859 2217DD          16      LD  (MD_PAT),HL
                                
001B3E E85C 2A9CE0          16      LD  HL,(MAXCLP)
001B41 E85F 110AF0          10      LD  DE,0-4086   ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001B44 E862 19              11      ADD HL,DE
001B45 E863 380F            12      JR  C,SETFAT16
001B47 E865 216BE5          10      LD  HL,GNCL     ;FAT12
001B4A E868 118EE5          10      LD  DE,SNCL
001B4D E86B 01CBE7          10      LD  BC,FATSETUP12
001B50 E86E DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001B54 E872 180D            12      JR  EXTRA1
       E874                     SETFAT16:
001B56 E874 21C2E5          10      LD  HL,GNCL16   ;FAT16
001B59 E877 11CFE5          10      LD  DE,SNCL16
001B5C E87A 01D8E7          10      LD  BC,FATSETUP16
001B5F E87D DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       E881                     EXTRA1:
001B63 E881 22F8F0          16      LD  (GNCPAT),HL
001B66 E884 ED53FBF0        20      LD  (SNCPAT),DE
001B6A E888 ED439CE7        20      LD  (FATSX),BC
001B6E E88C D1              10      POP DE
001B6F E88D C1              10      POP BC
001B70 E88E AF               4      XOR A
001B71 E88F C9              10      RET
                                
       E890                     GETDPBD:
001B72 E890 DDE3            23      EX  (SP),IX
001B74 E892 DDE5            15      PUSH    IX
001B76 E894 3A88F0          13      LD  A,(_DRV)
001B79 E897 1807            12      JR  GETDPB1
                                
       E899                     CHGDRVR:
001B7B E899 CDD9F0          17      CALL    _CHGDRV
001B7E E89C D8              11      RET C
001B7F E89D 3A89F0          13      LD  A,(_DSK)
       E8A0                     GETDPB1:
001B82 E8A0 C3DCF0          10      JP  _GETDPB
                                
       E8A3                     GETDPB:
001B85 E8A3 FE08             7      CP  8
001B87 E8A5 3F               4      CCF
001B88 E8A6 D8              11      RET C
001B89 E8A7 0F               4      RRCA
001B8A E8A8 0F               4      RRCA
001B8B E8A9 0F               4      RRCA
001B8C E8AA DD                      DB  0DDH        ;Z80未定義命令
001B8D E8AB 6F               4      LD  L,A     ;LD IXL,A
001B8E E8AC DD                      DB  0DDH        ;Z80未定義命令
001B8F E8AD 26F2             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001B91 E8AF DD7E00          19      LD  A,(IX+DPB_FATLN)
001B94 E8B2 A7               4      AND A       ;CF=0の為
001B95 E8B3 DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001B99 E8B7 C0              11      RET NZ      ;FAT16
001B9A E8B8 DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001B9E E8BC C0              11      RET NZ      ;BPB
001B9F E8BD FE01             7      CP  001H        ;A=0 THEN CF=1
001BA1 E8BF C9              10      RET
                                
       E8C0                     _SYS5F:
001BA2 E8C0 AF               4      XOR A
       E8C1                     FFLUSH:
001BA3 E8C1 F5              11      PUSH    AF
001BA4 E8C2 CDE9E4          17      CALL    WTFATX
001BA7 E8C5 AF               4      XOR A
001BA8 E8C6 32ABF0          13      LD  (_FATIX),A
001BAB E8C9 2F               4      CPL         ;0FFH
001BAC E8CA 32AAF0          13      LD  (_FATDRV),A
001BAF E8CD 3E                      DB  03EH        ;次のPUSH AFをスキップ
       E8CE                     FFLUSHBUF:
001BB0 E8CE F5              11      PUSH    AF
001BB1 E8CF CD9FE4          17      CALL    DWTX
001BB4 E8D2 3EFF             7      LD  A,0FFH
001BB6 E8D4 3239F0          13      LD  (SFILE),A
001BB9 E8D7 32A5F0          13      LD  (_DBDRV),A
001BBC E8DA F1              10      POP AF
001BBD E8DB C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MZ-700/1500
                                
       E8DC                     SEEK:
001BBE E8DC 0610             7      LD  B,16
001BC0 E8DE DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001BC3 E8E1 AF               4      XOR A
001BC4 E8E2 EB               4      EX  DE,HL
       E8E3                     DIV1:
001BC5 E8E3 29              11      ADD HL,HL
001BC6 E8E4 8F               4      ADC A,A
001BC7 E8E5 B9               4      CP  C
001BC8 E8E6 3802            12      JR  C,DIV2
001BCA E8E8 91               4      SUB C
001BCB E8E9 2C               4      INC L
       E8EA                     DIV2:
001BCC E8EA 10F7            13      DJNZ    DIV1
                                
001BCE E8EC 3C               4      INC A   ;最小のセクタは１固定
001BCF E8ED 55               4      LD  D,L ;TRACK
001BD0 E8EE 5F               4      LD  E,A ;SECTOR
                                
001BD1 E8EF 3A84F0          13      LD  A,(_DRIVE)
001BD4 E8F2 FE04             7      CP  4
001BD6 E8F4 3F               4      CCF
001BD7 E8F5 D8              11      RET C
001BD8 E8F6 F684             7      OR  084H        ;Motor on + ドライブセレクト有効
001BDA E8F8 D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001BDC E8FA CB3A             8      SRL D       ;CYLINDER
001BDE E8FC 9F               4      SBC A,A
001BDF E8FD D3DD            11      OUT (0DDH),A    ;ヘッドセレクト制御レジスタ
                                
001BE1 E8FF CD37E9          17      CALL    SETMODE
001BE4 E902 D8              11      RET C
                                
001BE5 E903 CD6CE9          17      CALL    DRIVE
001BE8 E906 FEFF             7      CP  0FFH        ;A=0FFH Unknown CYLINDER
001BEA E908 CC4EE9          17      CALL    Z,FDCRES    ;Restore
001BED E90B 2F               4      CPL         ;データバスが負論理
001BEE E90C D3D9            11      OUT (0D9H),A    ;MB8876 トラックレジスタ
001BF0 E90E 2F               4      CPL         ;データバスが負論理
001BF1 E90F 92               4      SUB D
001BF2 E910 C8              11      RET Z       ;No seek
                                
001BF3 E911 DD7E0C          19      LD  A,(IX+DPB_MAXCYL)
001BF6 E914 3D               4      DEC A
001BF7 E915 BA               4      CP  D       ;Over CYLINDER
001BF8 E916 D8              11      RET C
                                
001BF9 E917 7A               4      LD  A,D
001BFA E918 2F               4      CPL         ;データバスが負論理
001BFB E919 D3DB            11      OUT (0DBH),A    ;MB8876 データレジスタ
001BFD E91B 72               7      LD  (HL),D
                                
001BFE E91C 0E18             7      LD  C,018H      ;FDC TypeIコマンド Seek
       E91E                     FDCCMD2:
001C00 E91E 3A85F0          13      LD  A,(_SEEKSP)
001C03 E921 B1               4      OR  C
                                
       E922                     FDCCMD:
001C04 E922 CD63E9          17      CALL    COMSET
001C07 E925 3E80             7      LD  A,080H      ;FDC COMMAND(Self-modifying code)
       E926                     FDCSMC  EQU $-1
001C09 E927 E620             7      AND 020H        ;Write data Write track
001C0B E929 3C               4      INC A
                                
       E92A                     SST:
001C0C E92A 0E00             7      LD  C,0
       E92C                     SST1:
001C0E E92C 0D               4      DEC C       ; 4
001C0F E92D 20FD            12      JR  NZ,SST1     ;12 * 256 / 4 = About 1ms
001C11 E92F 3D               4      DEC A
001C12 E930 20FA            12      JR  NZ,SST1
                                
001C14 E932 0E01             7      LD  C,1
001C16 E934 CD3CE9          17      CALL    READY
       E937                     SETMODE:
001C19 E937 CD66E9          17      CALL    DELAY0      ;Head select time
001C1C E93A 0E81             7      LD  C,081H
       E93C                     READY:
001C1E E93C 0680             7      LD  B,128
       E93E                     READY2:
001C20 E93E DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001C22 E940 2F               4      CPL         ;データバスが負論理
001C23 E941 A1               4      AND C       ;NOT READY,BUSY
001C24 E942 C8              11      RET Z
001C25 E943 CD1BCF          17      CALL    RD556VSYNC
001C28 E946 07               4      RLCA
001C29 E947 A8               4      XOR B
001C2A E948 0F               4      RRCA
001C2B E949 30F3            12      JR  NC,READY2
001C2D E94B 10F1            13      DJNZ    READY2
001C2F E94D C9              10      RET
                                
       E94E                     FDCRES:
001C30 E94E 3600            10      LD  (HL),0
001C32 E950 0E08             7      LD  C,8     ;FDC TypeIコマンド Restore
001C34 E952 18CA            12      JR  FDCCMD2
                                
       E954                     FDMOFF:
001C36 E954 F5              11      PUSH    AF
001C37 E955 AF               4      XOR A       ;Motor off(ドライブセレクト無効)
001C38 E956 D3DC            11      OUT (0DCH),A    ;モータ/ドライブセレクト制御レジスタ
001C3A E958 F1              10      POP AF
001C3B E959 C9              10      RET
                                
       E95A                     SECSET_FDCCMD:
001C3C E95A 3A26E9          13      LD  A,(FDCSMC)
       E95D                     SECSET:
001C3F E95D F5              11      PUSH    AF
001C40 E95E 7B               4      LD  A,E
001C41 E95F 2F               4      CPL         ;データバスが負論理
001C42 E960 D3DA            11      OUT (0DAH),A    ;MB8876 セクタレジスタ
001C44 E962 F1              10      POP AF
       E963                     COMSET:
001C45 E963 2F               4      CPL         ;データバスが負論理
001C46 E964 D3D8            11      OUT (0D8H),A    ;MB8876 ステータス/コマンドレジスタ
       E966                     DELAY0:
001C48 E966 3E1A             7      LD  A,26
       E968                     DELAY:
001C4A E968 3D               4      DEC A
001C4B E969 20FD            12      JR  NZ,DELAY
001C4D E96B C9              10      RET
                                
       E96C                     DRIVE:                  ;ドライブのシリンダを得る
001C4E E96C 2A84F0          16      LD  HL,(_DRIVE)
001C51 E96F 26F0             7      LD  H,_CYL0/256
001C53 E971 CBFD             8      SET 7,L
001C55 E973 7E               7      LD  A,(HL)
001C56 E974 C9              10      RET
                                
       E975                     RNF:                    ;ドライブのシリンダをリセット
001C57 E975 CD6CE9          17      CALL    DRIVE
001C5A E978 36FF            10      LD  (HL),0FFH
001C5C E97A C9              10      RET
                                
001C5D E97B 02                  RETRY:  DB  2
                                
                                
                                ;   FLOPPY DISK DRIVER
                                
       E97C                     WTTRK:
001C5E E97C 0601             7      LD  B,1
001C60 E97E 3EF4             7      LD  A,0F4H      ;FDC TypeIIIコマンド Write Track
001C62 E980 1802            12      JR  WTTRK1
       E982                     FDWT:
001C64 E982 3EA0             7      LD  A,0A0H      ;FDC TypeIIコマンド Write Sector
       E984                     WTTRK1:
001C66 E984 3226E9          13      LD  (FDCSMC),A
       E987                     DWTBL:
001C69 E987 78               4      LD  A,B
001C6A E988 32C4E9          13      LD  (WTBSMC),A
001C6D E98B 3E02             7      LD  A,2     ;Retry count
001C6F E98D 327BE9          13      LD  (RETRY),A
                                
       E990                     DWT0:
001C72 E990 D5              11      PUSH    DE
001C73 E991 E5              11      PUSH    HL
001C74 E992 CDDCE8          17      CALL    SEEK        ;Write disk
001C77 E995 E1              10      POP HL
001C78 E996 3837            12      JR  C,ERRDW
001C7A E998 F3               4      DI
001C7B E999 CD5AE9          17      CALL    SECSET_FDCCMD
001C7E E99C 0EDB             7      LD  C,0DBH      ;MB8876 データレジスタ
       E99E                     DWT1:
001C80 E99E 7E               7      LD  A,(HL)
001C81 E99F 2F               4      CPL         ;データバスが負論理
001C82 E9A0 57               4      LD  D,A
                                
       E9A1                     DWT2:
001C83 E9A1 DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001C85 E9A3 2F               4      CPL         ;データバスが負論理
001C86 E9A4 0F               4      RRCA
001C87 E9A5 3008            12      JR  NC,DWT4
001C89 E9A7 0F               4      RRCA
001C8A E9A8 30F7            12      JR  NC,DWT2
       E9AA                     DWT3:
001C8C E9AA ED51            12      OUT (C),D       ;MB8876 データレジスタ
001C8E E9AC 23               6      INC HL
001C8F E9AD 18EF            12      JR  DWT1
                                
       E9AF                     DWT4:
001C91 E9AF 3D               4      DEC A
001C92 E9B0 28F8            12      JR  Z,DWT3
001C94 E9B2 3C               4      INC A
001C95 E9B3 FB               4      EI
001C96 E9B4 D1              10      POP DE
001C97 E9B5 13               6      INC DE
001C98 E9B6 CD54E9          17      CALL    FDMOFF
001C9B E9B9 2808            12      JR  Z,DISKOK_WT
001C9D E9BB CD23EA          17      CALL    DISKC
001CA0 E9BE 20D0            12      JR  NZ,DWT0
001CA2 E9C0 B7               4      OR  A
001CA3 E9C1 2005            12      JR  NZ,ERRW
                                
       E9C3                     DISKOK_WT:
001CA5 E9C3 0601             7      LD  B,1
       E9C4                     WTBSMC  EQU $-1
001CA7 E9C5 10C0            13      DJNZ    DWTBL
001CA9 E9C7 C9              10      RET
                                
       E9C8                     ERRW:
001CAA E9C8 3EFF             7      LD  A,0FFH
       E9CA                     ERRZ:
001CAC E9CA BF               4      CP  A       ;ZF=1
001CAD E9CB 37               4      SCF
001CAE E9CC C354E9          10      JP  FDMOFF
                                
       E9CF                     ERRDW:
001CB1 E9CF D1              10      POP DE
001CB2 E9D0 CD34EA          17      CALL    DELP
001CB5 E9D3 20BB            12      JR  NZ,DWT0
001CB7 E9D5 B7               4      OR  A
001CB8 E9D6 20F0            12      JR  NZ,ERRW
001CBA E9D8 C9              10      RET
                                
       E9D9                     FDRD:
001CBB E9D9 3E80             7      LD  A,080H      ;FDC TypeIIコマンド Read Sector
001CBD E9DB 3226E9          13      LD  (FDCSMC),A
       E9DE                     DRDBL:
001CC0 E9DE 78               4      LD  A,B
001CC1 E9DF 3215EA          13      LD  (RDBSMC),A
001CC4 E9E2 3E02             7      LD  A,2     ;Retry count
001CC6 E9E4 327BE9          13      LD  (RETRY),A
       E9E7                     DRD0:
001CC9 E9E7 D5              11      PUSH    DE
001CCA E9E8 E5              11      PUSH    HL
001CCB E9E9 CDDCE8          17      CALL    SEEK        ;Read disk
001CCE E9EC E1              10      POP HL
001CCF E9ED 382A            12      JR  C,ERRDR
001CD1 E9EF F3               4      DI
001CD2 E9F0 CD5AE9          17      CALL    SECSET_FDCCMD
       E9F3                     DRD1:
001CD5 E9F3 DBD8            11      IN  A,(0D8H)    ;MB8876 ステータス/コマンドレジスタ
001CD7 E9F5 2F               4      CPL         ;データバスが負論理
001CD8 E9F6 0F               4      RRCA
001CD9 E9F7 300A            12      JR  NC,DRD3
001CDB E9F9 0F               4      RRCA
001CDC E9FA 30F7            12      JR  NC,DRD1
001CDE E9FC DBDB            11      IN  A,(0DBH)    ;MB8876 データレジスタ
001CE0 E9FE 2F               4      CPL         ;データバスが負論理
001CE1 E9FF 77               7      LD  (HL),A
001CE2 EA00 23               6      INC HL
001CE3 EA01 18F0            12      JR  DRD1
                                
       EA03                     DRD3:
001CE5 EA03 B7               4      OR  A
001CE6 EA04 FB               4      EI
001CE7 EA05 D1              10      POP DE
001CE8 EA06 13               6      INC DE
001CE9 EA07 CD54E9          17      CALL    FDMOFF
001CEC EA0A 2808            12      JR  Z,DISKOK_RD
001CEE EA0C CD23EA          17      CALL    DISKC
001CF1 EA0F 20D6            12      JR  NZ,DRD0
001CF3 EA11 B7               4      OR  A
001CF4 EA12 20B4            12      JR  NZ,ERRW
                                
       EA14                     DISKOK_RD:
001CF6 EA14 0601             7      LD  B,1
       EA15                     RDBSMC  EQU $-1
001CF8 EA16 10C6            13      DJNZ    DRDBL
001CFA EA18 C9              10      RET
                                
       EA19                     ERRDR:
001CFB EA19 D1              10      POP DE
001CFC EA1A CD34EA          17      CALL    DELP
001CFF EA1D 20C8            12      JR  NZ,DRD0
001D01 EA1F B7               4      OR  A
001D02 EA20 20A6            12      JR  NZ,ERRW
001D04 EA22 C9              10      RET
       EA23                     DISKC:
001D05 EA23 1B               6      DEC DE
001D06 EA24 CB5F             8      BIT 3,A
001D08 EA26 C475E9          17      CALL    NZ,RNF
       EA29                     DISKD:
001D0B EA29 E5              11      PUSH    HL
001D0C EA2A 217BE9          10      LD  HL,RETRY
001D0F EA2D 35              11      DEC (HL)
001D10 EA2E E1              10      POP HL
001D11 EA2F 200C            12      JR  NZ,ERR      ;Retry
001D13 EA31 B7               4      OR  A
001D14 EA32 2809            12      JR  Z,ERR       ;Error
                                
       EA34                     DELP:
001D16 EA34 CD75E9          17      CALL    RNF
001D19 EA37 CD54E9          17      CALL    FDMOFF
001D1C EA3A 3EFF             7      LD  A,0FFH
       EA3C                     AERRZ:
001D1E EA3C BF               4      CP  A
       EA3D                     ERR:
001D1F EA3D 3EFF             7      LD  A,0FFH
001D21 EA3F C9              10      RET
[EOF:M7DISK.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MZ-700/1500
                                
                                ;   EMM DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       EA40                     EDWT:
001D22 EA40 F5              11      PUSH    AF
001D23 EA41 CD5FEA          17      CALL    EADR
001D26 EA44 0600             7      LD  B,0
       EA46                     EDWT1:
001D28 EA46 EDB3                    OTIR
001D2A EA48 3D               4      DEC A
001D2B EA49 20FB            12      JR  NZ,EDWT1
001D2D EA4B 180B            12      JR  EDRW1
                                
       EA4D                     EDRD:
001D2F EA4D C5              11      PUSH    BC
001D30 EA4E CD5FEA          17      CALL    EADR
001D33 EA51 0600             7      LD  B,0
       EA53                     EDRD1:
001D35 EA53 EDB2                    INIR
001D37 EA55 3D               4      DEC A
001D38 EA56 20FB            12      JR  NZ,EDRD1
       EA58                     EDRW1:
001D3A EA58 F1              10      POP AF
001D3B EA59 83               4      ADD A,E ;セクタを進める
001D3C EA5A 5F               4      LD  E,A
001D3D EA5B 8A               4      ADC A,D
001D3E EA5C 93               4      SUB E
001D3F EA5D 57               4      LD  D,A
001D40 EA5E C9              10      RET
                                
       EA5F                     EADR:
001D41 EA5F D5              11      PUSH    DE
001D42 EA60 EB               4      EX  DE,HL
001D43 EA61 78               4      LD  A,B
001D44 EA62 DD460F          19      LD  B,(IX+DPB_BPS)
       EA65                     EADR1:              ;読み込むセクタ数と1クラスタのセクタ数を掛ける
001D47 EA65 CB18             8      RR  B
001D49 EA67 3804            12      JR  C,EADR2
001D4B EA69 87               4      ADD A,A
001D4C EA6A 29              11      ADD HL,HL
001D4D EA6B 18F8            12      JR  EADR1
       EA6D                     EADR2:
001D4F EA6D DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001D52 EA70 DD460C          19      LD  B,(IX+DPB_MAXCYL)
001D55 EA73 09              11      ADD HL,BC
001D56 EA74 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D59 EA77 ED71            12      OUT (C),0       ;Z80未定義命令
001D5B EA79 0C               4      INC C
001D5C EA7A ED69            12      OUT (C),L
001D5E EA7C 0C               4      INC C
001D5F EA7D ED61            12      OUT (C),H
001D61 EA7F 0C               4      INC C
001D62 EA80 EB               4      EX  DE,HL
001D63 EA81 D1              10      POP DE
001D64 EA82 C9              10      RET
                                
                                ;   CMOS BACKUP MEMORY DRIVER(32KB)
                                ;   1セクタ256
                                
       EA83                     CDWT:
001D65 EA83 78               4      LD  A,B
001D66 EA84 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D69 EA87 ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001D6B EA89 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001D6D EA8B 01FA00          10      LD  BC,000FAH
       EA8E                     CDWT1:
001D70 EA8E EDB3                    OTIR            ;W)データ書き込み・アドレスカウンタ+1
001D72 EA90 13               6      INC DE
001D73 EA91 3D               4      DEC A
001D74 EA92 20FA            12      JR  NZ,CDWT1
001D76 EA94 A7               4      AND A
001D77 EA95 C9              10      RET
                                
       EA96                     CDRD:
001D78 EA96 78               4      LD  A,B
001D79 EA97 DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D7C EA9A ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001D7E EA9C ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001D80 EA9E 01F900          10      LD  BC,000F9H
       EAA1                     CDRD1:
001D83 EAA1 EDB2                    INIR            ;R)データ読み出し・アドレスカウンタ+1
001D85 EAA3 13               6      INC DE
001D86 EAA4 3D               4      DEC A
001D87 EAA5 20FA            12      JR  NZ,CDRD1
001D89 EAA7 A7               4      AND A
001D8A EAA8 C9              10      RET
                                
                                ;   RAM DISK DRIVER (64KB)
                                ;   1セクタ256
                                
       EAA9                     RDWT:
001D8B EAA9 3EB3             7      LD  A,0B3H      ;OTIR
001D8D EAAB 1802            12      JR  RDRW
       EAAD                     RDRD:
001D8F EAAD 3EB2             7      LD  A,0B2H      ;INIR
       EAAF                     RDRW:
001D91 EAAF 32BCEA          13      LD  (RDRW_SWC),A
                                
001D94 EAB2 78               4      LD  A,B
001D95 EAB3 43               4      LD  B,E     ;B=アドレスカウンタ上位(X1の様な16bitのI/Oアクセス)
001D96 EAB4 0EEB             7      LD  C,0EBH
001D98 EAB6 ED71            12      OUT (C),0       ;0=アドレスカウンタ下位
001D9A EAB8 0D               4      DEC C       ;EA(R)データ読み出し・アドレスカウンタ+1
001D9B EAB9 0600             7      LD  B,0
       EABB                     RDRW1:
001D9D EABB EDB2                    INIR            ;自己書き換え(INIR/OTIR)
       EABC                     RDRW_SWC    EQU $-1
001D9F EABD 13               6      INC DE
001DA0 EABE 3D               4      DEC A
001DA1 EABF 20FA            12      JR  NZ,RDRW1
001DA3 EAC1 A7               4      AND A
001DA4 EAC2 C9              10      RET
                                
                                ;   G-RAM(PCG) DISK DRIVER (24KB)
                                ;   1セクタ256
                                
       EAC3                     GDWT:
001DA5 EAC3 C5              11      PUSH    BC
001DA6 EAC4 D5              11      PUSH    DE
001DA7 EAC5 CDEDEA          17      CALL    GADR
       EAC8                     GDWT2:
001DAA EAC8 4E               7      LD  C,(HL)
001DAB EAC9 23               6      INC HL
001DAC EACA EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001DAD EACB CDC1CF          17      CALL    WR_PCG
001DB0 EACE 23               6      INC HL
001DB1 EACF EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001DB2 EAD0 10F6            13      DJNZ    GDWT2
001DB4 EAD2 D1              10      POP DE
001DB5 EAD3 1C               4      INC E
001DB6 EAD4 C1              10      POP BC
001DB7 EAD5 10EC            13      DJNZ    GDWT
001DB9 EAD7 C9              10      RET
       EAD8                     GDRD:
001DBA EAD8 C5              11      PUSH    BC
001DBB EAD9 D5              11      PUSH    DE
001DBC EADA CDEDEA          17      CALL    GADR
       EADD                     GDRD2:
001DBF EADD EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001DC0 EADE CDB9CF          17      CALL    RD_PCG
001DC3 EAE1 23               6      INC HL
001DC4 EAE2 EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001DC5 EAE3 71               7      LD  (HL),C
001DC6 EAE4 23               6      INC HL
001DC7 EAE5 10F6            13      DJNZ    GDRD2
001DC9 EAE7 D1              10      POP DE
001DCA EAE8 1C               4      INC E
001DCB EAE9 C1              10      POP BC
001DCC EAEA 10EC            13      DJNZ    GDRD
001DCE EAEC C9              10      RET
                                
       EAED                     GADR:
001DCF EAED 7B               4      LD  A,E
001DD0 EAEE E61F             7      AND 01FH
001DD2 EAF0 C6D0             7      ADD A,0D0H
001DD4 EAF2 57               4      LD  D,A
001DD5 EAF3 7B               4      LD  A,E
001DD6 EAF4 07               4      RLCA
001DD7 EAF5 07               4      RLCA
001DD8 EAF6 07               4      RLCA
001DD9 EAF7 3C               4      INC A
001DDA EAF8 0600             7      LD  B,0
001DDC EAFA 58               4      LD  E,B
001DDD EAFB C9              10      RET
[EOF:M7DISK2.ASM:UTF_8]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001DDE EAFC                     PATHD:  DS  PATHX
001E19 EB37 00                  PATHE:  DB  0
                                
       EB38                     DTA_CCP:
001E1A EB38                         DS  37
                                
       EB5D                     FCB_BAT:
001E3F EB5D                         DS  37
                                
001E64 EB82 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001E6F EB8D 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "M7TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE 表示関連のテーブル
                                ;   MZ-700/1500
                                
       EB94                     AT_TABLE:
001E76 EB94                         DS  TABLEAD-AT_TABLE
                                
       ED40                     KEY_TABLE:
002022 ED40 12081E1F1C1D5C2F        DB  12H,08H,1EH,1FH,1CH,1DH,5CH,'/'
00202A ED48 5C5E2D2030392C2E        DB  5CH,'^','-',20H,'0','9',',','.'
002032 ED50 3132333435363738        DB  '1','2','3','4','5','6','7','8'
00203A ED58 6162636465666768        DB  'a','b','c','d','e','f','g','h'
002042 ED60 696A6B6C6D6E6F70        DB  'i','j','k','l','m','n','o','p'
00204A ED68 7172737475767778        DB  'q','r','s','t','u','v','w','x'
002052 ED70 797A405B5D000000        DB  'y','z','@','[',']',00H,00H,00H
00205A ED78 001B3D09003B3A0D        DB  00H,1BH,'=',09H,00H,';',':',0DH
       ED80                     SHIFT_TABLE:
002062 ED80 12081E1F1C1D5F3F        DB  12H,08H,1EH,1FH,1CH,1DH,'_','?'
00206A ED88 7C7E3D2030293C3E        DB  '|','~','=',20H,'0',')','<','>'
002072 ED90 2122232425262728        DB  '!','"','#','$','%','&',27H,'('
00207A ED98 4142434445464748        DB  'A','B','C','D','E','F','G','H'
002082 EDA0 494A4B4C4D4E4F50        DB  'I','J','K','L','M','N','O','P'
00208A EDA8 5152535455565758        DB  'Q','R','S','T','U','V','W','X'
002092 EDB0 595A607B7D000000        DB  'Y','Z','`','{','}',00H,00H,00H
00209A EDB8 00003D09002B2A0D        DB  00H,00H,'=',09H,00H,'+','*',0DH
       EDC0                     CTRL_TABLE:
0020A2 EDC0 12081E1F1C1D3F2F        DB  12H,08H,1EH,1FH,1CH,1DH,'?','/'
0020AA EDC8 2A2B2D2030392C2E        DB  '*','+','-',20H,'0','9',',','.'
0020B2 EDD0 3132333435363738        DB  '1','2','3','4','5','6','7','8'
0020BA EDD8 0102030405060708        DB  01H,02H,03H,04H,05H,06H,07H,08H
0020C2 EDE0 090A0B0C0D0E0F10        DB  09H,0AH,0BH,0CH,0DH,0EH,0FH,10H
0020CA EDE8 1112131415161718        DB  11H,12H,13H,14H,15H,16H,17H,18H
0020D2 EDF0 191A1B5B5D000000        DB  19H,1AH,1BH,'[',']',00H,00H,00H
0020DA EDF8 00003D09003B3A0D        DB  00H,00H,'=',09H,00H,';',':',0DH
                                
                                ;   アドレス下位1バイトが0になるように
       EE00                     CD_TABLE:
0020E2 EE00 00D1D2D3D4D5D6D0        DB  $00,$D1,$D2,$D3,$D4,$D5,$D6,$D0 ;月火水木金土日
0020EA EE08 D8DCD9DADBD7CFCE        DB  $D8,$DC,$D9,$DA,$DB,$D7,$CF,$CE ;年円時分秒
0020F2 EE10 601F5F5E1E1B7978        DB  $60,$1F,$5F,$5E,$1E,$1B,$79,$78 ;
0020FA EE18 5C5D1C1D6DCACDC7        DB  $5C,$5D,$1C,$1D,$6D,$CA,$CD,$C7 ;
002102 EE20 0061626364656667        DB  $00,$61,$62,$63,$64,$65,$66,$67 ; !"#$%&'
00210A EE28 68696B6A2F2A2E2D        DB  $68,$69,$6B,$6A,$2F,$2A,$2E,$2D ;()*+,-./
002112 EE30 2021222324252627        DB  $20,$21,$22,$23,$24,$25,$26,$27 ;01234567
00211A EE38 28294F2C512B5749        DB  $28,$29,$4F,$2C,$51,$2B,$57,$49 ;89:;<=>?
002122 EE40 5501020304050607        DB  $55,$01,$02,$03,$04,$05,$06,$07 ;@ABCDEFG
00212A EE48 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;HIJKLMNO
002132 EE50 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;PQRSTUVW
00213A EE58 18191A52DD54E37C        DB  $18,$19,$1A,$52,$DD,$54,$E3,$7C ;XYZ[\]^_
002142 EE60 5901020304050607        DB  $59,$01,$02,$03,$04,$05,$06,$07 ;`abcdefg   ATB:1
00214A EE68 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;hijklmno   ATB:1
002152 EE70 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;pqrstuvw   ATB:1
00215A EE78 18191ACB35CC705A        DB  $18,$19,$1A,$CB,$35,$CC,$70,$5A ;xyz{|}~    ATB:1
002162 EE80 415346444847B49E        DB  $41,$53,$46,$44,$48,$47,$B4,$9E ;トランプ〇●をぁ   ATB:1
00216A EE88 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ぃぅぇぉゃゅょっ   ATB:1
002172 EE90 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーあいうえおかき   ATB:1
00217A EE98 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;くけこさしすせそ   ATB:1
002182 EEA0 F0BD9DB1B5B9B49E        DB  $F0,$BD,$9D,$B1,$B5,$B9,$B4,$9E ;　。「」、・ヲァ
00218A EEA8 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ィゥェォャョュッ
002192 EEB0 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーアイウエオカキ
00219A EEB8 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;クケコサシスセソ
0021A2 EEC0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;タチツテトナニヌ
0021AA EEC8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ネノハヒフヘホマ
0021B2 EED0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;ミムメモヤユヨラ
0021BA EED8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;リルレロワン゛゜
0021C2 EEE0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;たちつてとねにぬ   ATB:1
0021CA EEE8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ねのはひふへほま   ATB:1
0021D2 EEF0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;みむめもやゆよら   ATB:1
0021DA EEF8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;りるれろわん゛゜   ATB:1
       EF00                     DC_TABLE:
0021E2 EF00 2041424344454647        DB  $20,$41,$42,$43,$44,$45,$46,$47 ;0
0021EA EF08 48494A4B4C4D4E4F        DB  $48,$49,$4A,$4B,$4C,$4D,$4E,$4F
0021F2 EF10 5051525354555657        DB  $50,$51,$52,$53,$54,$55,$56,$57 ;1
0021FA EF18 58595A151A1B1411        DB  $58,$59,$5A,$15,$1A,$1B,$14,$11
002202 EF20 3031323334353637        DB  $30,$31,$32,$33,$34,$35,$36,$37 ;2
00220A EF28 38392D3D3B2F2E2C        DB  $38,$39,$2D,$3D,$3B,$2F,$2E,$2C
002212 EF30 00000000007C0000        DB  $00,$00,$00,$00,$00,$7C,$00,$00 ;3
00221A EF38 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
002222 EF40 0080000083008285        DB  $00,$80,$00,$00,$83,$00,$82,$85 ;4
00222A EF48 843F00000000003A        DB  $84,$3F,$00,$00,$00,$00,$00,$3A
002232 EF50 5E3C5B815D40003E        DB  $5E,$3C,$5B,$81,$5D,$40,$00,$3E ;5
00223A EF58 00607F0018191312        DB  $00,$60,$7F,$00,$18,$19,$13,$12
002242 EF60 1021222324252627        DB  $10,$21,$22,$23,$24,$25,$26,$27 ;6
00224A EF68 28292B2A001C0000        DB  $28,$29,$2B,$2A,$00,$1C,$00,$00
002252 EF70 7E00000000000000        DB  $7E,$00,$00,$00,$00,$00,$00,$00 ;7
00225A EF78 171600005F000000        DB  $17,$16,$00,$00,$5F,$00,$00,$00
002262 EF80 00C19A9F9C92CA97        DB  $00,$C1,$9A,$9F,$9C,$92,$CA,$97 ;8
00226A EF88 98C6CFC9D8D3D0D7        DB  $98,$C6,$CF,$C9,$D8,$D3,$D0,$D7
002272 EF90 9EC09DC496C5CBC3        DB  $9E,$C0,$9D,$C4,$96,$C5,$CB,$C3 ;9
00227A EF98 9BDDC2DB99A2878C        DB  $9B,$DD,$C2,$DB,$99,$A2,$87,$8C
002282 EFA0 DCC7CC91939495D4        DB  $DC,$C7,$CC,$91,$93,$94,$95,$D4 ;A
00228A EFA8 D5D6CECDDAD2D9C8        DB  $D5,$D6,$CE,$CD,$DA,$D2,$D9,$C8
002292 EFB0 D1A3888D86A4898E        DB  $D1,$A3,$88,$8D,$86,$A4,$89,$8E ;B
00229A EFB8 DFA58A8FDEA18B90        DB  $DF,$A5,$8A,$8F,$DE,$A1,$8B,$90
0022A2 EFC0 000000000000001F        DB  $00,$00,$00,$00,$00,$00,$00,$1F ;C
0022AA EFC8 00001D7B7D1E0F0E        DB  $00,$00,$1D,$7B,$7D,$1E,$0F,$0E
0022B2 EFD0 070102030405060D        DB  $07,$01,$02,$03,$04,$05,$06,$0D ;D
0022BA EFD8 080A0B0C095C0000        DB  $08,$0A,$0B,$0C,$09,$5C,$00,$00
0022C2 EFE0 0000005E00000000        DB  $00,$00,$00,$5E,$00,$00,$00,$00 ;E
0022CA EFE8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
0022D2 EFF0 A000000000000000        DB  $A0,$00,$00,$00,$00,$00,$00,$00 ;F
0022DA EFF8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
[EOF:M7TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
                                ;   ALIGN   256
       F000                     AT_WORK:
0022E2 F000                         DS  WORKAD-AT_WORK
                                
       F000                     CPM_BOOT:
0022E2 F000 C30000          10      JP  0
       F003                     _SYS00:     ;(BDOS)プログラム終了
       F003                     CPM_WBOOT:
0022E5 F003 C3FECF          10      JP  WBOOT1
       F006                     CPM_CONST:
0022E8 F006 C3A6D7          10      JP  CONSTX
       F009                     _SYS07:     ;(BDOS)コンソール直接入力
       F009                     CPM_CONIN:
0022EB F009 C33FD7          10      JP  FLGET
       F00C                     CPM_CONOUT:
0022EE F00C C34AD9          10      JP  CONOUT1
                                
       F00F                     DECBF:              ;10進数表示時のバッファ(5バイト)
0022F1 F00F                         DS  5
       F00F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       F011                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
       F014                     FDRV:
0022F6 F014 00                      DB  0
       F015                     FNAME:
0022F7 F015                         DS  36
       F039                     SFILE:
00231B F039                         DS  33      ;DRV FILENAME
       F05A                     _DISKE:
00233C F05A C309D7          10      JP  SHOW_ERROR
                                
00233F F05D 0000                LEFTX:  DW  0
002341 F05F 0000                DTAX:   DW  0
                                
                                ;   PSGのビープ音のデータ(X1)
       F061                     BEEPD:
002343 F061 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
00234B F069 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
                                ;
       F062                     RTC_YY  EQU BEEPD+1 ;RTCのバッファ年(88)
       F063                     RTC_MW  EQU BEEPD+2 ;RTCのバッファ月(88)
       F064                     RTC_DD  EQU BEEPD+3 ;RTCのバッファ日(88)
       F065                     RTC_TT  EQU BEEPD+4 ;RTCのバッファ時(88)
       F066                     RTC_MM  EQU BEEPD+5 ;RTCのバッファ分(88)
       F067                     RTC_SS  EQU BEEPD+6 ;RTCのバッファ秒(88)
       F062                     ROM_SLT EQU BEEPD+1 ;ROMのスロット(MSX)
       F061                     ZERO    EQU BEEPD
                                
       F070                     CHECK:
002352 F070 00                      DB  0
                                
       F071                     OK:
002353 F071 4F4B24                  DB  "OK$"
002356 F074                         DS  5
       F079                     COMERM:
00235B F079 4572726F722124          DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
       F080                     _CYL0:
002362 F080 FF                      DB  0FFH    ;Cylinder
       F081                     _CYL1:
002363 F081 FF                      DB  0FFH    ;Cylinder
       F082                     _CYL2:
002364 F082 FF                      DB  0FFH    ;Cylinder
       F083                     _CYL3:
002365 F083 FF                      DB  0FFH    ;Cylinder
       F084                     _DRIVE:
002366 F084 00                      DB  0   ;unit number
       F085                     _SEEKSP:
002367 F085 00                      DB  0   ;Seek speed
       F086                     _ISEEK:
002368 F086 32                      DB  50  ;
002369 F087                         DS  1
       F088                     _DRV:
00236A F088 00                      DB  0
       F089                     _DSK:
00236B F089 FF                      DB  0FFH
       F08A                     _DTA:
00236C F08A 8000                    DW  00080H
       F08C                     _CTC:
00236E F08C 0000                    DW  0
       F08E                     _TXADR:
002370 F08E 0000                    DW  0
       F090                     _KEYPS:
002372 F090 0000                    DW  0
       F092                     _KEYD:
002374 F092 00                      DB  000H    ;キーデータ
       F093                     _KEYST:
002375 F093 FF                      DB  0FFH    ;キーステータス(SHIFT,CTRLの状態)
       F094                     _KEYSP_L:
002376 F094 83                      DB  KEYSP_L ;オートリピートの速度
       F095                     _KEYSP_H:
002377 F095 14                      DB  KEYSP_H ;オートリピートの速度
       F096                     _COLORF:
002378 F096 70                      DB  COLORF  ;色
       F097                     _LINE:
002379 F097 19                      DB  LINE
                                
                                            ;次のファイルの検索(C=12)で使用するFCB
       F098                     _FCB:
00237A F098 0000                    DW  0   ;SEARCH FILES
       F09A                     _FBPS:
00237C F09A 0000                    DW  0   ;    //
       F09C                     _FBAD:
00237E F09C 0000                    DW  0   ;    //
       F09E                     _FBCNT:
002380 F09E 00                      DB  0   ;    //
       F09F                     _FILEN:
002381 F09F 00                      DB  0   ;    //
       F0A0                     _DIRF:
002382 F0A0 00                      DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
002383 F0A1                         DS  1
       F0A2                     _WTFATF:
002384 F0A2 00                      DB  0   ;FATバッファの更新フラグ
002385 F0A3                         DS  1
       F0A4                     _WTDBF:
002386 F0A4 00                      DB  0   ;データバッファの更新フラグ
       F0A5                     _DBDRV:
002387 F0A5 FF                      DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
       F0A6                     _DBSEC:
002388 F0A6 0000                    DW  0   ;データバッファにあるデータを読み込んだセクタ番号
       F0A8                     _DPB:
00238A F0A8 0000                    DW  0
       F0AA                     _FATDRV:
00238C F0AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
       F0AB                     _FATIX:
00238D F0AB 00                      DB  0   ;FATバッファに読み込んでいるインデックス
       F0AC                     _FAKEFREE:
00238E F0AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
002390 F0AE                         DS  2
                                ;   画面周りのデータ
       F0B0                     CRTCD:
002392 F0B0 6F                      DB  06FH
       F0B1                     _WIDTH:
002393 F0B1 28                      DB  WIDTH
       F0B2                     TVRAMTOP:
002394 F0B2 5938                    DB  059H,038H
002396 F0B4 1F02                    DB  01FH,002H
       F0B6                     _LINE2:
002398 F0B6 19                      DB  019H
       F0B7                     WKE4:
002399 F0B7 1C                      DB  01CH
       F0B8                     WKE6:
00239A F0B8 00                      DB  000H
       F0B9                     WK40:
00239B F0B9 07                      DB  007H
       F0BA                     _PAGE_MINUS:
00239C F0BA 18FC                    DW  0-WIDTH*LINE
       F0BC                     _WIDTH_MINUS:
00239E F0BC D8FF                    DW  0-WIDTH
       F0BE                     WK30:
0023A0 F0BE 0C                      DB  00CH
       F0BF                     WK31:
       F0BF                     WK1FD0:
0023A1 F0BF 20                      DB  020H
                                
                                ;   割り込みベクタ(X1)
0023A2 F0C0 0000                CTC0:   DW  INTCTCE
0023A4 F0C2 0000                CTC1:   DW  INTCTCE
0023A6 F0C4 0000                CTC2:   DW  INTCTCE
0023A8 F0C6 0000                CTC3:   DW  INTCTCE
0023AA F0C8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
0023AC F0CA C3AEDA          10  _INKEY: JP  INKEY
0023AF F0CD C331D8          10  _PRINT: JP  PRINT
0023B2 F0D0 C339DB          10  _SCRN:  JP  SCRN
0023B5 F0D3 C303DA          10  _POS:   JP  POS
0023B8 F0D6 C318D9          10  _LOC:   JP  LOC
       F0D9                     _CHGDRV:
0023BB F0D9 C3E5E7          10      JP  CHGDRV
       F0DC                     _GETDPB:
0023BE F0DC C3A3E8          10      JP  GETDPB
       F0DF                     _FFLUSH:
0023C1 F0DF C3C1E8          10      JP  FFLUSH
       F0E2                     _RDFATX:
0023C4 F0E2 C3BFE4          10      JP  RDFATX
0023C7 F0E5 C3F1E5          10  _RDFAT: JP  RDFAT
0023CA F0E8 C37CE9          10  _WTTRK: JP  WTTRK
0023CD F0EB C3D9E9          10  _FDRD:  JP  FDRD
0023D0 F0EE C382E9          10  _FDWT:  JP  FDWT
       F0F1                     _BPB2DPB:
0023D3 F0F1 C387E6          10      JP  BPB2DPB
       F0F4                     _BREAK:
0023D6 F0F4 C38DD1          10      JP  END_BATCH
       F0F7                     _GNCL:
0023D9 F0F7 C36BE5          10      JP  GNCL        ; self-modifying code
       F0F8                     GNCPAT  EQU $-2
       F0FA                     _SNCL:
0023DC F0FA C38EE5          10      JP  SNCL        ; self-modifying code
       F0FB                     SNCPAT  EQU $-2
       F0FD                     _COMANL:
0023DF F0FD C346D0          10      JP  COMANL
                                
       F100                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F100                     STABLE:
                                ;0
0023E2 F100 03F016D722D729DD        DW  _SYS00,_SYS01,_SYS02,_SYS03
0023EA F108 74D474D427D709F0        DW  _SYS04,_SYS05,_SYS06,_SYS07
0023F2 F110 2FD776D475D7A1D7        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
0023FA F118 8BD490D49FD4B0D4        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
002402 F120 04D54BD594D5C5D5        DW  _SYS10,_SYS11,_SYS12,_SYS13
00240A F128 CDD5E3D5F8D5F0D5        DW  _SYS14,_SYS15,_SYS16,_SYS17
002412 F130 3FD644D649D64FD6        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
00241A F138 74D475D674D479D6        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
002422 F140 74D42FD637D680D6        DW  _SYS20,_SYS21,_SYS22,_SYS23
00242A F148 A5D674D47FE14DE2        DW  _SYS24,_ERROR,_SYS26,_SYS27
002432 F150 37D6AFD6B4D729DD        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
00243A F158 B4D729DD74D4D0D6        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
002442 F160 CAD674D474D474D4        DW  _SYS30,_ERROR,_ERROR,_ERROR
00244A F168 74D474D474D474D4        DW  _ERROR,_ERROR,_ERROR,_ERROR
002452 F170 74D429DD29DDF1D6        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
00245A F178 57D4                    DW  _DOS2
                                
00245C F17A                         DS  1
       F17B                     _MAX_SEC_SZ_H:
00245D F17B 04                      DB  MAX_SEC_SZ_H
                                
                                ;   FATバッファのアドレス
       F17C                     _FATBF:
00245E F17C 30F3                    DW  FATBF
                                
                                ;   データバッファのアドレス
       F17E                     _DTBUF:
002460 F17E 30FB                    DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F180                     CTRLTB:
002462 F180 96D896D8CCD8D6D9        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
00246A F188 D0D9FDD8C1D95AD9        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
002472 F190 A2D8BDD8D9D92BD9        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
00247A F198 BED913D9EBD996D8        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
002482 F1A0 96D896D823D996D8        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
00248A F1A8 96D896D896D896D8        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
002492 F1B0 96D896D8BED932D9        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
00249A F1B8 85D8A9D8B2D8D9D9        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
                                ;   2D/2DDでBPBがない場合のデフォルト値(2D/360KB/9セクタ1024バイト)
0024A2 F1C0 0200                M2D:    DW  2
0024A4 F1C2 FD02                    DB  0FDH,2
0024A6 F1C4 6401                    DW  356
0024A8 F1C6 FF0728090182            DB  0FFH,7,40,9,1,082H
0024AE F1CC 0500A7000800            DW  5,0A7H,8
                                
                                ;   2HDでBPBがない場合のデフォルト値(2HD/1.23MB/8セクタ1024バイト)
0024B4 F1D2 0200                M2HD:   DW  2
0024B6 F1D4 FE01                    DB  0FEH,1
0024B8 F1D6 C704                    DW  1223
0024BA F1D8 FE064D080184            DB  0FEH,6,77,8,1,084H
0024C0 F1DE 0500A7000900            DW  5,0A7H,9
                                
                                ;   ディレクトリエントリとFCBの変換テーブル(日付+時刻+サイズ)
0024C6 F1E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
0024C8 F1E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
0024CA F1E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
0024CC F1EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F1EE                     SDDATAE:
                                
0024D0 F1EE                         DS  2
                                
                                ;   バッチファイルのFCB
       F1F0                     _FCB_BAT:
0024D2 F1F0 5DEB                    DW  FCB_BAT
       F1F2                     _PATH:
0024D4 F1F2 FCEA                    DW  PATHD
                                
0024D6 F1F4                     SCDIR:  DS  2       ;+14 +15
0024D8 F1F6                     SFBPS:  DS  2       ;FBPS
0024DA F1F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
0024DC F1FA 0000                _FATPS: DW  0
0024DE F1FC 0000                _DIRPS: DW  0
0024E0 F1FE 0000                _CLPS:  DW  0
                                
       F200                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "M7DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MZ-700/1500
                                
       F200                     _DEVICE:
                                
                                ;   A:
                                
0024E2 F200 0200                    DW  2   ;DPB_FATLN
0024E4 F202 EBF0                    DW  _FDRD   ;DPB_DRD
0024E6 F204 EEF0                    DW  _FDWT   ;DPB_DWT
0024E8 F206 FD                      DB  0FDH    ;DPB_FATID
0024E9 F207 02                      DB  2   ;DPB_SECPCL
0024EA F208 6401                    DW  356 ;DPB_MAXCL
0024EC F20A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
0024ED F20B 07                      DB  7   ;DPB_DIRSCNT
0024EE F20C 28                      DB  40  ;DPB_MAXCYL
0024EF F20D 09                      DB  9   ;DPB_MAXSEC Number of sectors
0024F0 F20E 01                      DB  1   ;DPB_FATPS
0024F1 F20F 82                      DB  082H    ;DPB_BPS
0024F2 F210 0500                    DW  5   ;DPB_DIRPS
0024F4 F212 27                      DB  027H    ;DPB_DEVICE Device Number
0024F5 F213 00                      DB  0   ;DPB_UNITNO
0024F6 F214 0800                    DW  8   ;DPB_ADDCL
0024F8 F216 0000                    DW  0   ;DPB_16
0024FA F218 0000                    DW  0   ;DPB_18
0024FC F21A 0000                    DW  0   ;DPB_SDIR
0024FE F21C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
002502 F220 0200                    DW  2   ;DPB_FATLN
002504 F222 EBF0                    DW  _FDRD   ;DPB_DRD
002506 F224 EEF0                    DW  _FDWT   ;DPB_DWT
002508 F226 FD                      DB  0FDH    ;DPB_FATID
002509 F227 02                      DB  2   ;DPB_SECPCL
00250A F228 6401                    DW  356 ;DPB_MAXCL
00250C F22A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
00250D F22B 07                      DB  7   ;DPB_DIRSCNT
00250E F22C 28                      DB  40  ;DPB_MAXCYL
00250F F22D 09                      DB  9   ;DPB_MAXSEC Number of sectors
002510 F22E 01                      DB  1   ;DPB_FATPS
002511 F22F 82                      DB  082H    ;DPB_BPS
002512 F230 0500                    DW  5   ;DPB_DIRPS
002514 F232 27                      DB  027H    ;DPB_DEVICE Device Number
002515 F233 01                      DB  1   ;DPB_UNITNO
002516 F234 0800                    DW  8   ;DPB_ADDCL
002518 F236 0000                    DW  0   ;DPB_16
00251A F238 0000                    DW  0   ;DPB_18
00251C F23A 0000                    DW  0   ;DPB_SDIR
00251E F23C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
002522 F240 0100                    DW  1   ;DPB_FATLN
002524 F242 96EA                    DW  CDRD    ;DPB_DRD
002526 F244 83EA                    DW  CDWT    ;DPB_DWT
002528 F246 FA                      DB  0FAH    ;DPB_FATID
002529 F247 01                      DB  1   ;DPB_SECPCL
00252A F248 7A00                    DW  122 ;DPB_MAXCL
00252C F24A 00                      DB  0   ;DPB_FDMODE
00252D F24B 06                      DB  6   ;DPB_DIRSCNT
00252E F24C 00                      DB  0   ;DPB_MAXCYL
00252F F24D 00                      DB  0   ;DPB_MAXSEC
002530 F24E 01                      DB  1   ;DPB_FATPS
002531 F24F 01                      DB  1   ;DPB_BPS
002532 F250 0200                    DW  2   ;DPB_DIRPS
002534 F252 0C                      DB  00CH    ;DPB_DEVICE
002535 F253 F8                      DB  0F8H    ;DPB_UNITNO
002536 F254 0600                    DW  6   ;DPB_ADDCL
002538 F256 0000                    DW  0   ;DPB_16
00253A F258 0000                    DW  0   ;DPB_18
00253C F25A 0000                    DW  0   ;DPB_SDIR
00253E F25C 434D4F53                DB  "CMOS"  ;DPB_NAME
                                
                                ;   D:
                                
002542 F260                         DS  32
                                
                                ;   E:
                                
       F280                     EMMFL:
002562 F280 0000                    DW  0   ;DPB_FATLN
002564 F282 4DEA                    DW  EDRD    ;DPB_DRD
002566 F284 40EA                    DW  EDWT    ;DPB_DWT
002568 F286 FA                      DB  0FAH    ;DPB_FATID
002569 F287 02                      DB  2   ;DPB_SECPCL
00256A F288 0000                    DW  0   ;DPB_MAXCL
00256C F28A 00                      DB  0   ;DPB_FDMODE
00256D F28B 10                      DB  16  ;DPB_DIRSCNT
00256E F28C 00                      DB  0   ;DPB_MAXCYL
00256F F28D 00                      DB  0   ;DPB_MAXSEC
002570 F28E 01                      DB  1   ;DPB_FATPS
002571 F28F 01                      DB  1   ;DPB_BPS
002572 F290 0000                    DW  0   ;DPB_DIRPS
002574 F292 26                      DB  026H    ;DPB_DEVICE
002575 F293 00                      DB  0   ;DPB_UNITNO
002576 F294 0000                    DW  0   ;DPB_ADDCL
002578 F296 0000                    DW  0   ;DPB_16
00257A F298 0000                    DW  0   ;DPB_18
00257C F29A 0000                    DW  0   ;DPB_SDIR
00257E F29C 454D4D30                DB  "EMM0"  ;DPB_NAME
                                
                                ;   F:
                                
002582 F2A0 0200                    DW  2   ;DPB_FATLN
002584 F2A2 ADEA                    DW  RDRD    ;DPB_DRD
002586 F2A4 A9EA                    DW  RDWT    ;DPB_DWT
002588 F2A6 FA                      DB  0FAH    ;DPB_FATID
002589 F2A7 01                      DB  1   ;DPB_SECPCL
00258A F2A8 F600                    DW  246 ;DPB_MAXCL
00258C F2AA 00                      DB  0   ;DPB_FDMODE
00258D F2AB 09                      DB  9   ;DPB_DIRSCNT
00258E F2AC 00                      DB  0   ;DPB_MAXCYL
00258F F2AD 00                      DB  0   ;DPB_MAXSEC
002590 F2AE 01                      DB  1   ;DPB_FATPS
002591 F2AF 01                      DB  1   ;DPB_BPS
002592 F2B0 0300                    DW  3   ;DPB_DIRPS
002594 F2B2 0F                      DB  00FH    ;DPB_DEVICE
002595 F2B3 00                      DB  0   ;DPB_UNITNO
002596 F2B4 0A00                    DW  10  ;DPB_ADDCL
002598 F2B6 0000                    DW  0   ;DPB_16
00259A F2B8 0000                    DW  0   ;DPB_18
00259C F2BA 0000                    DW  0   ;DPB_SDIR
00259E F2BC 52414D46                DB  "RAMF"  ;DPB_NAME
                                
                                ;   G:
       F2C0                     GRAMFL:
0025A2 F2C0 0100                    DW  1   ;DPB_FATLN
0025A4 F2C2 D8EA                    DW  GDRD    ;DPB_DRD
0025A6 F2C4 C3EA                    DW  GDWT    ;DPB_DWT
0025A8 F2C6 FA                      DB  0FAH    ;DPB_FATID
0025A9 F2C7 01                      DB  1   ;DPB_SECPCL
0025AA F2C8 5A00                    DW  90  ;DPB_MAXCL
0025AC F2CA 00                      DB  0   ;DPB_FDMODE
0025AD F2CB 06                      DB  6   ;DPB_DIRSCNT
0025AE F2CC 00                      DB  0   ;DPB_MAXCYL
0025AF F2CD 00                      DB  0   ;DPB_MAXSEC
0025B0 F2CE 01                      DB  1   ;DPB_FATPS
0025B1 F2CF 01                      DB  1   ;DPB_BPS
0025B2 F2D0 0200                    DW  2   ;DPB_DIRPS
0025B4 F2D2 05                      DB  005H    ;DPB_DEVICE
0025B5 F2D3 F8                      DB  0F8H    ;DPB_UNITNO
0025B6 F2D4 0600                    DW  6   ;DPB_ADDCL
0025B8 F2D6 0000                    DW  0   ;DPB_16
0025BA F2D8 0000                    DW  0   ;DPB_18
0025BC F2DA 0000                    DW  0   ;DPB_SDIR
0025BE F2DC 4752414D                DB  "GRAM"  ;DPB_NAME
                                
                                ;   H:
0025C2 F2E0                         DS  3
0025C5 F2E3 00                      DB  0
[EOF:M7DPB.ASM:UTF_8]
                                
       A5C6                     LAST_ADR    EQU $$+OFFSET
                                
                                    END
[EOF:M7.ASM:UTF_8]
