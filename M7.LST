                                ;*** AILZ80ASM *** Z-80 Assembler, version 1.0.0.0, LST:Full:4
                                ;   LSX-Dodgers for MZ-700/1500
                                ;   Programmed by
                                ;   Gaku (Lovers/Tablacus)
                                
                                    INCLUDE "M7DEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                ;   MZ-700/1500
                                
       0001                     MAC EQU 1   ;MZ-700/1500
       0000                     DEV EQU 0
                                
       011D                     VER_6F  EQU 0011DH
                                
       8080                     RUN EQU 08080H
       8000                     OFFSET  EQU RUN-128
       CF06                     BDOS    EQU 0CF06H
       ED40                     TABLEAD EQU 0ED40H
       F000                     WORKAD  EQU 0F000H
       F300                     FATBF   EQU 0F300H
       FB00                     DTBUF   EQU 0FB00H
       FF00                     KEYBF   EQU 0FF00H
       FF20                     KBUF    EQU 0FF20H
       FFD9                     TRAP38  EQU 0FFD9H
       0028                     WIDTH   EQU 40
       0019                     LINE    EQU 25
       0070                     COLORF  EQU 070H
       0010                     KEYSP_H EQU 16
       0083                     KEYSP_L EQU 131
       0009                     COMS    EQU 9
[EOF:M7DEF.ASM:UTF_8]
                                    INCLUDE "LDDEF.ASM"
                                
                                ;   LSX-Dodgers DEF
                                
       0001                     VER_1   EQU 1
       0005                     VER_2   EQU 5
       0009                     VER_3   EQU 9
       1D01                     MACW    EQU MAC + 01D00H    ;機種フラグとLD判別フラグ
       0001                     MACD    EQU MAC + DEV * 256 ;機種フラグとデバイスフラグ
       0159                     VER EQU VER_1 * 256 + VER_2 * 16 + VER_3
                                
       0005                     SYSTEM  EQU 00005H
       000F                     JP_HL   EQU 0000FH
       005C                     FCB1    EQU 0005CH
       006C                     FCB2    EQU 0006CH
       005D                     FCB1FN  EQU FCB1+1
       006D                     FCB2FN  EQU FCB2+1
       0080                     DTA1    EQU 00080H
                                
       FFCA                     EXTBIO  EQU 0FFCAH
                                
       0000                     DPB_FATLN   EQU 00H
       0002                     DPB_DRD     EQU 02H
       0004                     DPB_DWT     EQU 04H
       0006                     DPB_FATID   EQU 06H
       0007                     DPB_SECPCL  EQU 07H
       0008                     DPB_MAXCL   EQU 08H
       000A                     DPB_FDMODE  EQU 0AH
       000B                     DPB_DIRSCNT EQU 0BH
       000C                     DPB_MAXCYL  EQU 0CH
       000D                     DPB_MAXSEC  EQU 0DH
       000E                     DPB_FATPS   EQU 0EH
       000F                     DPB_BPS     EQU 0FH
       0010                     DPB_DIRPS   EQU 10H
       0012                     DPB_DEVICE  EQU 12H
       0013                     DPB_UNITNO  EQU 13H
       0014                     DPB_ADDCL   EQU 14H
                                
       001A                     DPB_SDIR    EQU 1AH
       001C                     DPB_NAME    EQU 1CH
                                
[EOF:LDDEF.ASM:SHIFT_JIS]
                                
000000 8000                         ORG OFFSET
                                                    ;MZTヘッダ128バイト
000000 8000 01                      DB  1           ;ファイルモード
000001 8001 4C44202020202020        DB  "LD           "     ;ファイル名(13)
            2020202020          
00000E 800E 535953                  DB  "SYS"           ;拡張子(3)
000011 8011 0D                      DB  $0D
000012 8012 3325                    DW  LAST_ADR-RUN        ;サイズ
000014 8014 8080                    DW  RUN         ;開始アドレス
000016 8016 8080                    DW  RUN         ;実行アドレス
000018 8018                         DS  104
                                
                                    INCLUDE "M7INIT.ASM"
                                
                                ;   LSX-Dodgers INIT
                                ;   MZ-700/1500
                                
000080 8080 C38780          10      JP  START
000083 8083 011D                    DW  MACW
000085 8085 5901                    DW  VER
                                
       8087                     START:
000087 8087 F3               4      DI
000088 8088 ED56             8      IM  1
00008A 808A 318780          10      LD  SP,START
00008D 808D CD9B80          17      CALL    INIT        ;NZならAUTOEXECを実行
000090 8090 210000          10      LD  HL,0
000093 8093 E5              11      PUSH    HL
000094 8094 C8              11      RET Z
000095 8095 117081          10      LD  DE,AUTOD
000098 8098 C3FDF0          10      JP  _COMANL
                                
       809B                     INIT:
00009B 809B D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFFH)
00009D 809D D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00009F 809F 21D581          10      LD  HL,INITE
0000A2 80A2 1106CF          10      LD  DE,BDOS
0000A5 80A5 01DE23          10      LD  BC,LAST_ADR-INITE
0000A8 80A8 EDB0                    LDIR
0000AA 80AA 21A681          10      LD  HL,M7BEEPD
0000AD 80AD 1162F0          10      LD  DE,BEEPD+1
0000B0 80B0 010800          10      LD  BC,M7BEEPE-M7BEEPD
0000B3 80B3 EDB0                    LDIR
                                
0000B5 80B5 210000          10      LD  HL,0
0000B8 80B8 065C             7      LD  B,05CH
0000BA 80BA 3E                      DB  03EH    ;LD A,??
0000BB 80BB EF              12      RST 28H
0000BC 80BC CDEBDB          17      CALL    FILL_MEMORY
0000BF 80BF 06A4             7      LD  B,0A4H
0000C1 80C1 AF               4      XOR A
0000C2 80C2 CDEBDB          17      CALL    FILL_MEMORY
                                
0000C5 80C5 3EC3             7      LD  A,0C3H      ;JP
0000C7 80C7 2103F0          10      LD  HL,CPM_WBOOT
0000CA 80CA 320000          13      LD  (00000H),A
0000CD 80CD 220100          16      LD  (00001H),HL ;IPL
                                
0000D0 80D0 21011D          10      LD  HL,MACW     ;3 bit7  DPB Compatible LA(1)
0000D3 80D3 220300          16      LD  (00003H),HL ;  bit6-0 Machine
                                ;               ;4 LSX-Dodgers(01DH)
0000D6 80D6 2106CF          10      LD  HL,BDOS
0000D9 80D9 320500          13      LD  (00005H),A
0000DC 80DC 220600          16      LD  (00006H),HL ;BDOS
                                
0000DF 80DF 21D9FF          10      LD  HL,TRAP38   ;TRAP38
0000E2 80E2 322800          13      LD  (00028H),A
0000E5 80E5 222900          16      LD  (00029H),HL ;RST 028H
                                
0000E8 80E8 323800          13      LD  (00038H),A
0000EB 80EB 211ACF          10      LD  HL,IO_INT8253
0000EE 80EE 223900          16      LD  (00039H),HL
                                
0000F1 80F1 3EF0             7      LD  A,CPM_BOOT/256
0000F3 80F3 320B00          13      LD  (0000BH),A
                                
0000F6 80F6 3EE9             7      LD  A,0E9H      ;JP (HL)
0000F8 80F8 320F00          13      LD  (0000FH),A
                                                    ;CHECK PCG(MZ-1500)
0000FB 80FB 2100E8          10      LD  HL,0E800H
0000FE 80FE 46               7      LD  B,(HL)
0000FF 80FF F3               4      DI
000100 8100 3E01             7      LD  A,1
000102 8102 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
000104 8104 4E               7      LD  C,(HL)
000105 8105 79               4      LD  A,C
000106 8106 C6A5             7      ADD A,0A5H
000108 8108 5F               4      LD  E,A
000109 8109 73               7      LD  (HL),E
00010A 810A D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
00010C 810C 71               7      LD  (HL),C
00010D 810D 3E01             7      LD  A,1
00010F 810F D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
000111 8111 7E               7      LD  A,(HL)
000112 8112 BB               4      CP  E
000113 8113 D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
000115 8115 70               7      LD  (HL),B
000116 8116 FB               4      EI
000117 8117 2804            12      JR  Z,MZ1500
000119 8119 AF               4      XOR A       ;MZ-700はPCGバンクが存在しない
00011A 811A 32C0F2          13      LD  (GRAMFL),A
       811D                     MZ1500:
00011D 811D DD2180F2        14      LD  IX,EMMFL
000121 8121 CD6581          17      CALL    CHECK_EMM_BPB
000124 8124 FEEB             7      CP  0EBH
000126 8126 2810            12      JR  Z,EMM_BPB
000128 8128 DD360D02        19      LD  (IX+DPB_MAXSEC),2   ;BPBが512バイト目から始まる場合を調べる
00012C 812C CD6581          17      CALL    CHECK_EMM_BPB
00012F 812F DDBE06           7      CP  (IX+DPB_FATID)
000132 8132 2004            12      JR  NZ,EMM_BPB
000134 8134 DD360D00        19      LD  (IX+DPB_MAXSEC),0   ;BPBが先頭の場合に戻す
       8138                     EMM_BPB:
000138 8138 217C81          10      LD  HL,INIMES
00013B 813B CD87D4          17      CALL    MSX
       813E                     INIT1:
00013E 813E F3               4      DI
00013F 813F 1100FF          10      LD  DE,0FF00H
000142 8142 0600             7      LD  B,0
000144 8144 CD24D3          17      CALL    ZERO_MEMORY_DE
000147 8147 21CAFF          10      LD  HL,EXTBIO
00014A 814A 36C9            10      LD  (HL),0C9H   ;RET
00014C 814C 23               6      INC HL
00014D 814D 060E             7      LD  B,TRAP38-EXTBIO-1
00014F 814F 3E                      DB  03EH    ;LD A,??
000150 8150 EF              12      RST 28H
000151 8151 CDEBDB          17      CALL    FILL_MEMORY
000154 8154 21AE81          10      LD  HL,AT_TRAP38
000157 8157 11D9FF          10      LD  DE,TRAP38
00015A 815A 012700          10      LD  BC,AT_TRAPE-AT_TRAP38
00015D 815D EDB0                    LDIR
                                
00015F 815F CDC6DA          17      CALL    CHKEY
000162 8162 FE03             7      CP  3
000164 8164 C9              10      RET
                                
       8165                     CHECK_EMM_BPB:
000165 8165 D5              11      PUSH    DE
000166 8166 110000          10      LD  DE,0
000169 8169 CD37EA          17      CALL    EADR
00016C 816C D1              10      POP DE
00016D 816D ED78            12      IN  A,(C)
00016F 816F C9              10      RET
                                
000170 8170 4155544F45584543    AUTOD:  DB  "AUTOEXEC "
            20                  
000179 8179 413A00              AUTODV: DB  "A:",0
                                
00017C 817C 0C4C53582D446F64    INIMES: DB  00CH,"LSX-Dodgers for MZ-700/1500 v"
            6765727320666F72    
            204D5A2D3730302F    
            313530302076        
00019A 819A 312E                    DB  030H + VER_1, '.'
00019C 819C 3539                    DB  030H + VER_2 ,030H + VER_3
                                ;   DB  ""
00019E 819E 2047616B750D0A          DB  ' Gaku',0DH,0AH
0001A5 81A5 00                      DB  0
                                
       81A6                     M7BEEPD:
0001A6 81A6 0801                    DB  8,1
0001A8 81A8 0736                    DB  7,036H
0001AA 81AA 04F9                    DB  4,0F9H
0001AC 81AC 0403                    DB  4,3
       81AE                     M7BEEPE:
                                
       81AE                     AT_TRAP38:
0001AE FFD9                         ORG TRAP38,AT_TRAP38-OFFSET
0001AE FFD9 210000          10      LD  HL,0
0001B1 FFDC E3              19      EX  (SP),HL
0001B2 FFDD 3E24             7      LD  A,'$'
0001B4 FFDF CD0ED7          17      CALL    MSG_A
0001B7 FFE2 2B               6      DEC HL
0001B8 FFE3 7C               4      LD  A,H
0001B9 FFE4 CDE8FF          17      CALL    PRHX
0001BC FFE7 7D               4      LD  A,L
       FFE8                     PRHX:
0001BD FFE8 F5              11      PUSH    AF
0001BE FFE9 07               4      RLCA
0001BF FFEA 07               4      RLCA
0001C0 FFEB 07               4      RLCA
0001C1 FFEC 07               4      RLCA
0001C2 FFED CDF1FF          17      CALL    PRHX2
0001C5 FFF0 F1              10      POP AF
       FFF1                     PRHX2:
0001C6 FFF1 E60F             7      AND 00FH
0001C8 FFF3 FE0A             7      CP  10
0001CA FFF5 3F               4      CCF
0001CB FFF6 CE30             7      ADC A,'0'
0001CD FFF8 27               4      DAA
0001CE FFF9 C30ED7          10      JP  MSG_A
0001D1 FFFC                         DS  4
       81D5                         ORG $$+OFFSET   ;$DEPHASE
       81D5                     AT_TRAPE:
                                
       81D5                     INITE:
0001D5 CF06                         ORG BDOS,INITE-OFFSET
                                
0001D5 CF06 C309CF          10      JP  IO_BDOS
[EOF:M7INIT.ASM:SHIFT_JIS]
                                    INCLUDE "M7BANK.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                ;   VRAM/KEY/TIMER(0D000H-0EFFFH)にアクセスするので0D000H-0FFFFHに置けない部分
                                ;
                                
       CF09                     IO_BDOS:
0001D8 CF09 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001DA CF0B C346D4          10      JP  BDOS0
                                
       CF0E                     RDKEYDATA:
0001DD CF0E F3               4      DI
0001DE CF0F D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001E0 CF11 3200E0          13      LD  (0E000H),A
0001E3 CF14 3A01E0          13      LD  A,(E001H)
0001E6 CF17 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001E8 CF19 FB               4      EI
       CF1A                     IO_INT8253:
0001E9 CF1A C9              10      RET
                                
       CF1B                     RD556VSYNC:
0001EA CF1B F3               4      DI
0001EB CF1C D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001ED CF1E 3A02E0          13      LD  A,(0E002H)
0001F0 CF21 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001F2 CF23 FB               4      EI
0001F3 CF24 C9              10      RET
                                
       CF25                     RDMMIO:
0001F4 CF25 F3               4      DI
0001F5 CF26 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001F7 CF28 7E               7      LD  A,(HL)
0001F8 CF29 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
0001FA CF2B FB               4      EI
0001FB CF2C C9              10      RET
                                
       CF2D                     WRMMIO:
0001FC CF2D F3               4      DI
0001FD CF2E D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
0001FF CF30 77               7      LD  (HL),A
000200 CF31 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000202 CF33 FB               4      EI
000203 CF34 C9              10      RET
                                
       CF35                     RDMMIO_BC:
000204 CF35 F3               4      DI
000205 CF36 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000207 CF38 0A               7      LD  A,(BC)
000208 CF39 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00020A CF3B FB               4      EI
00020B CF3C C9              10      RET
                                
       CF3D                     WRMMIO_BC:
00020C CF3D F3               4      DI
00020D CF3E D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
00020F CF40 02               7      LD  (BC),A
000210 CF41 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000212 CF43 FB               4      EI
000213 CF44 C9              10      RET
                                
       CF45                     IO_PRINT:
000214 CF45 F3               4      DI
000215 CF46 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
000217 CF48 77               7      LD  (HL),A
000218 CF49 CBDC             8      SET 3,H
00021A CF4B 71               7      LD  (HL),C
00021B CF4C D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00021D CF4E FB               4      EI
00021E CF4F C9              10      RET
                                
       CF50                     IO_CLR:
00021F CF50 F3               4      DI
000220 CF51 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF53                     C1AX1:
000222 CF53 7A               4      LD  A,D
000223 CF54 C6D0             7      ADD A,0D0H
000225 CF56 57               4      LD  D,A
000226 CF57 AF               4      XOR A
000227 CF58 12               7      LD  (DE),A      ;Text
000228 CF59 CBDA             8      SET 3,D
       CF5C                     ICSMC   EQU $+1
00022A CF5B 3E00             7      LD  A,0     ;自己書き換え
00022C CF5D 12               7      LD  (DE),A      ;Color
00022D CF5E 13               6      INC DE
00022E CF5F 7A               4      LD  A,D
00022F CF60 D6D8             7      SUB 0D8H
000231 CF62 57               4      LD  D,A
000232 CF63 2118FC          10      LD  HL,0-WIDTH*LINE
000235 CF66 19              11      ADD HL,DE
000236 CF67 30EA            12      JR  NC,C1AX1
000238 CF69 E1              10      POP HL
000239 CF6A D1              10      POP DE
00023A CF6B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00023C CF6D FB               4      EI
00023D CF6E C9              10      RET
                                
       CF6F                     IO_CLLINE:
00023E CF6F F3               4      DI
00023F CF70 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF72                     CLLINE1:
000241 CF72 CB9C             8      RES 3,H
000243 CF74 77               7      LD  (HL),A      ;Text
000244 CF75 CBDC             8      SET 3,H
000246 CF77 71               7      LD  (HL),C      ;Color
000247 CF78 23               6      INC HL
000248 CF79 10F7            13      DJNZ    CLLINE1
00024A CF7B D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
00024C CF7D FB               4      EI
00024D CF7E C9              10      RET
                                
       CF7F                     IO_INS:
00024E CF7F F3               4      DI
00024F CF80 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF82                     IO_INS1:
000251 CF82 CD99CF          17      CALL    C12S
000254 CF85 23               6      INC HL
000255 CF86 10FA            13      DJNZ    IO_INS1
000257 CF88 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000259 CF8A FB               4      EI
00025A CF8B C9              10      RET
                                
       CF8C                     IO_BS:
00025B CF8C F3               4      DI
00025C CF8D D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CF8F                     IO_BS1:
00025E CF8F CD99CF          17      CALL    C12S
000261 CF92 2B               6      DEC HL
000262 CF93 10F7            13      DJNZ    IO_BS
000264 CF95 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000266 CF97 FB               4      EI
000267 CF98 C9              10      RET
                                
       CF99                     C12S:
000268 CF99 CB9C             8      RES 3,H
00026A CF9B 5E               7      LD  E,(HL)
00026B CF9C 77               7      LD  (HL),A
00026C CF9D 7B               4      LD  A,E
00026D CF9E CBDC             8      SET 3,H
00026F CFA0 5E               7      LD  E,(HL)
000270 CFA1 71               7      LD  (HL),C
000271 CFA2 4B               4      LD  C,E
000272 CFA3 C9              10      RET
                                
       CFA4                     IO_SCRUP:
000273 CFA4 F3               4      DI
000274 CFA5 D3E3            11      OUT (0E3H),A    ;VRAM/KEY/TIMER(D000H-FFFFH)
       CFA7                     SCRUP1:
000276 CFA7 2815            12      JR  Z,SCRCL
000278 CFA9 D5              11      PUSH    DE
000279 CFAA E5              11      PUSH    HL
00027A CFAB CBDA             8      SET 3,D
00027C CFAD CBDC             8      SET 3,H
00027E CFAF 012800          10      LD  BC,WIDTH
000281 CFB2 EDB0                    LDIR
000283 CFB4 E1              10      POP HL
000284 CFB5 D1              10      POP DE
000285 CFB6 012800          10      LD  BC,WIDTH
000288 CFB9 EDB0                    LDIR
00028A CFBB 3D               4      DEC A
00028B CFBC 18E9            12      JR  SCRUP1
                                
       CFBE                     SCRCL:
00028D CFBE 0628             7      LD  B,WIDTH
00028F CFC0 EB               4      EX  DE,HL
000290 CFC1 D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)
000292 CFC3 CD04D9          17      CALL    CLLINE
000295 CFC6 E1              10      POP HL
000296 CFC7 D1              10      POP DE
000297 CFC8 C1              10      POP BC
000298 CFC9 C9              10      RET
                                
       CFCA                     RD_PCG:
000299 CFCA F3               4      DI
00029A CFCB D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
00029C CFCD 4E               7      LD  C,(HL)
       CFCE                     RW_PCG:
00029D CFCE D3E6            11      OUT (0E6H),A    ;MZ-1500: PCGバンクを閉じる
00029F CFD0 FB               4      EI
0002A0 CFD1 C9              10      RET
                                
       CFD2                     WR_PCG:
0002A1 CFD2 F3               4      DI
0002A2 CFD3 D3E5            11      OUT (0E5H),A    ;MZ-1500: PCGバンク切り替え
0002A4 CFD5 71               7      LD  (HL),C
0002A5 CFD6 18F6            12      JR  RW_PCG
                                
       CFD8                     C_MON:
0002A7 CFD8 D3E4            11      OUT (0E4H),A    ;MONITOR ROM(0000H-0FFFH) & VRAM/KEY/TIMER(D000H-FFFFH)
0002A9 CFDA C7              12      RST 0
                                
       CFDB                     BANKE:
0002AA CFDB                         DS  0CFFEH-BANKE
[EOF:M7BANK.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                ;   MZ-700/1500
                                
       CFFE                     WBOOT1:
0002CD CFFE D3E1            11      OUT (0E1H),A    ;DRAM(D000H-FFFFH)　ここは0CFFEH
0002CF D000 D3E0            11      OUT (0E0H),A    ;DRAM(0000H-0FFHH)
0002D1 D002 F3               4      DI
0002D2 D003 3A94F0          13      LD  A,(_KEYSP)
0002D5 D006 ED7B0600        20      LD  SP,(SYSTEM+1)
0002D9 D00A FB               4      EI
0002DA D00B 2192F0          10      LD  HL,_KEYD
0002DD D00E 3600            10      LD  (HL),0
0002DF D010 CDC6DA          17      CALL    CHKEY
0002E2 D013 CD0AD7          17      CALL    KEYBC_IFBREAK
0002E5 D016 3E04             7      LD  A,4
0002E7 D018 CD0ED7          17      CALL    MSG_A
[EOF:M7CCP.ASM:UTF_8]
                                    INCLUDE "LDCCP.ASM"
                                
                                ;   LSX-Dodgers CCP
                                
       D01B                     COMMAND:
0002EA D01B 3A35EB          13      LD  A,(FCB_BAT)
0002ED D01E B7               4      OR  A
0002EE D01F C261D1          10      JP  NZ,C_BAT1
0002F1 D022 CDD5D0          17      CALL    SETDTA1
0002F4 D025 3A87F0          13      LD  A,(_DVSW)
0002F7 D028 C641             7      ADD A,'A'
0002F9 D02A CD0ED7          17      CALL    MSG_A
0002FC D02D 3E3E             7      LD  A,'>'
0002FE D02F CD0ED7          17      CALL    MSG_A
000301 D032 3E50             7      LD  A,80
000303 D034 12               7      LD  (DE),A
000304 D035 CD6AD7          17      CALL    _SYS0A      ;(BDOS)文字列入力
000307 D038 CD56D2          17      CALL    LTNL
       D03B                     COMMAND2:
00030A D03B 118200          10      LD  DE,DTA1+2
00030D D03E CDFDF0          17      CALL    _COMANL
000310 D041 30D8            12      JR  NC,COMMAND
000312 D043 1179F0          10      LD  DE,COMERM
000315 D046 CD78D4          17      CALL    _SYS09      ;(BDOS)文字列出力
000318 D049 C7              12      RST 0
                                
       D04A                     COMANL:
000319 D04A CD3FDB          17      CALL    FILE
00031C D04D 3A19F0          13      LD  A,(FNAME+4)
00031F D050 FE20             7      CP  020H
000321 D052 201C            12      JR  NZ,COMB2
000323 D054 D5              11      PUSH    DE
000324 D055 1115F0          10      LD  DE,FNAME
000327 D058 1A               7      LD  A,(DE)
000328 D059 FE20             7      CP  020H
00032A D05B 2844            12      JR  Z,SDVSW
00032C D05D 1B               6      DEC DE
00032D D05E 1A               7      LD  A,(DE)
00032E D05F C6FF             7      ADD A,0FFH
000330 D061 3809            12      JR  C,COMB
000332 D063 13               6      INC DE
                                
000333 D064 2110D4          10      LD  HL,COMTB
000336 D067 0609             7      LD  B,COMS
000338 D069 CDCEDD          17      CALL    CPNAME
       D06C                     COMB:
00033B D06C D1              10      POP DE
00033C D06D D20F00          10      JP  NC,JP_HL
       D070                     COMB2:
00033F D070 EB               4      EX  DE,HL
000340 D071 223ED1          16      LD  (COMSWC),HL
000343 D074 F5              11      PUSH    AF
000344 D075 CDF6D0          17      CALL    CEXE4
000347 D078 F1              10      POP AF
000348 D079 2115F0          10      LD  HL,FNAME
00034B D07C 116D00          10      LD  DE,FCB2+1   ;COMMAND NAME
00034E D07F 010B00          10      LD  BC,11
000351 D082 EDB0                    LDIR
000353 D084 11D4EA          10      LD  DE,PATHD
       D087                     CEX1:
000356 D087 1A               7      LD  A,(DE)
000357 D088 FE20             7      CP  020H
000359 D08A D8              11      RET C
00035A D08B CD34DB          17      CALL    FILEC
00035D D08E D5              11      PUSH    DE
00035E D08F 216D00          10      LD  HL,FCB2+1   ;COMMAND NAME
000361 D092 1115F0          10      LD  DE,FNAME
000364 D095 010B00          10      LD  BC,11
000367 D098 EDB0                    LDIR
000369 D09A CDF6D0          17      CALL    CEXE4
00036C D09D D1              10      POP DE
00036D D09E 13               6      INC DE
00036E D09F 18E6            12      JR  CEX1
                                
       D0A1                     SDVSW:
000370 D0A1 F1              10      POP AF
000371 D0A2 3A14F0          13      LD  A,(FDRV)
000374 D0A5 3D               4      DEC A
000375 D0A6 5F               4      LD  E,A
000376 D0A7 0E0E             7      LD  C,00EH      ;(BDOS)カレントドライブの設定
000378 D0A9 1831            12      JR  SYSTEM0
                                
       D0AB                     OPEN1:
00037A D0AB 2114F0          10      LD  HL,FDRV
       D0AE                     OPEN:
00037D D0AE 0E11             7      LD  C,011H      ;(BDOS)ファイルの検索
       D0B0                     OPEN3:
00037F D0B0 D5              11      PUSH    DE
000380 D0B1 1110EB          10      LD  DE,DTA_CCP
000383 D0B4 CDD2D0          17      CALL    SETDTA
000386 D0B7 EB               4      EX  DE,HL
000387 D0B8 CDDCD0          17      CALL    SYSTEM0
00038A D0BB D1              10      POP DE
00038B D0BC C9              10      RET
                                
       D0BD                     OPEN2:
00038C D0BD 0E12             7      LD  C,012H
00038E D0BF 18EF            12      JR  OPEN3
                                
       D0C1                     DEFCB:              ;Z=Ok NZ=Error
000390 D0C1 1110EB          10      LD  DE,DTA_CCP
000393 D0C4 CDDAD0          17      CALL    SYSC0F
                                
000396 D0C7 1131EB          10      LD  DE,DTA_CCP+33   ;(FCB)ランダムレコード
000399 D0CA 0604             7      LD  B,4
00039B D0CC CD24D3          17      CALL    ZERO_MEMORY_DE
       D0CF                     SETDTA100:
00039E D0CF 110001          10      LD  DE,00100H
       D0D2                     SETDTA:
0003A1 D0D2 C34BD6          10      JP  _SYS1A      ;(BDOS)DTAの設定
                                
       D0D5                     SETDTA1:
0003A4 D0D5 118000          10      LD  DE,DTA1
0003A7 D0D8 18F8            12      JR  SETDTA
                                
       D0DA                     SYSC0F:
0003A9 D0DA 0E0F             7      LD  C,00FH      ;(BDOS)ファイルのオープン
       D0DC                     SYSTEM0:
0003AB D0DC CD0500          17      CALL    SYSTEM
0003AE D0DF B7               4      OR  A
0003AF D0E0 C9              10      RET
                                
       D0E1                     C_CD:
0003B0 D0E1 0E5A             7      LD  C,05AH
0003B2 D0E3 18F7            12      JR  SYSTEM0
                                
       D0E5                     S27BUF:
0003B4 D0E5 2100FE          10      LD  HL,-00200H  ;スクラッチエリア(0100H)+スタック予備(0100H)
0003B7 D0E8 39              11      ADD HL,SP
0003B8 D0E9 2E00             7      LD  L,0
0003BA D0EB 7C               4      LD  A,H
0003BB D0EC E6F8             7      AND 0F8H
0003BD D0EE 67               4      LD  H,A
       D0EF                     S27DTA:
0003BE D0EF 1110EB          10      LD  DE,DTA_CCP
       D0F2                     S27:
0003C1 D0F2 0E27             7      LD  C,027H      ;(BDOS)ランダムブロック読み込み
0003C3 D0F4 18E6            12      JR  SYSTEM0
                                
       D0F6                     CEXE4:
0003C5 D0F6 211DF0          10      LD  HL,FNAME+8
0003C8 D0F9 7E               7      LD  A,(HL)
0003C9 D0FA FE20             7      CP  020H
0003CB D0FC 2007            12      JR  NZ,CEXE7
0003CD D0FE 3E3F             7      LD  A,'?'
0003CF D100 77               7      LD  (HL),A
0003D0 D101 23               6      INC HL
0003D1 D102 77               7      LD  (HL),A
0003D2 D103 23               6      INC HL
0003D3 D104 77               7      LD  (HL),A
       D105                     CEXE7:
0003D4 D105 CDABD0          17      CALL    OPEN1
       D108                     CEXE5:
0003D7 D108 C0              11      RET NZ
0003D8 D109 2A1AEB          16      LD  HL,(DTA_CCP+1+9)
0003DB D10C 7C               4      LD  A,H
0003DC D10D CD56DE          17      CALL    CAP
0003DF D110 67               4      LD  H,A
0003E0 D111 7D               4      LD  A,L
0003E1 D112 CD56DE          17      CALL    CAP
0003E4 D115 6F               4      LD  L,A
0003E5 D116 3A19EB          13      LD  A,(DTA_CCP+1+8)
0003E8 D119 CD56DE          17      CALL    CAP
0003EB D11C D642             7      SUB 'B'
0003ED D11E 282C            12      JR  Z,C_BAT
0003EF D120 3D               4      DEC A       ;'C'
0003F0 D121 2805            12      JR  Z,C_EXE
       D123                     CEXE6:
0003F2 D123 CDBDD0          17      CALL    OPEN2
0003F5 D126 18E0            12      JR  CEXE5
                                
       D128                     C_EXE:
0003F7 D128 7C               4      LD  A,H
0003F8 D129 FE4D             7      CP  'M'
0003FA D12B 20F6            12      JR  NZ,CEXE6
                                
0003FC D12D CDC1D0          17      CALL    DEFCB
0003FF D130 CDE5D0          17      CALL    S27BUF
000402 D133 3D               4      DEC A
000403 D134 37               4      SCF
000404 D135 C0              11      RET NZ
000405 D136 7C               4      LD  A,H
000406 D137 B5               4      OR  L
000407 D138 37               4      SCF
000408 D139 C8              11      RET Z
000409 D13A CDD5D0          17      CALL    SETDTA1
00040C D13D 110000          10      LD  DE,0                ; self-modifying code
       D13E                     COMSWC  EQU $-2
00040F D140 ED7B0600        20      LD  SP,(SYSTEM+1)
000413 D144 67               4      LD  H,A             ; A=0 in SETDTA1(_SYS1A)
000414 D145 6F               4      LD  L,A
000415 D146 E5              11      PUSH    HL              ; push $0000 (reboot address)
000416 D147 24               4      INC H
000417 D148 E5              11      PUSH    HL              ; push $0100 (TPA address)
000418 D149 C3EFD2          10      JP  SETFCB              ; and JP $0100
                                
       D14C                     C_BAT:
00041B D14C 114154          10      LD  DE,'A'+'T'*256
00041E D14F ED52            15      SBC HL,DE
000420 D151 20D0            12      JR  NZ,CEXE6
                                
000422 D153 CDC1D0          17      CALL    DEFCB
                                
000425 D156 2110EB          10      LD  HL,DTA_CCP
000428 D159 1135EB          10      LD  DE,FCB_BAT
00042B D15C 012500          10      LD  BC,37
00042E D15F EDB0                    LDIR
       D161                     C_BAT1:
000430 D161 CDCFD0          17      CALL    SETDTA100
000433 D164 CD98D1          17      CALL    FGETC_BAT
000436 D167 218100          10      LD  HL,DTA1+1
000439 D16A 2025            12      JR  NZ,END_BATCH
00043B D16C FE21             7      CP  021H        ;スペースや改行など制御文字を飛ばす
00043D D16E 38F1            12      JR  C,C_BAT1
00043F D170 3620            10      LD  (HL),' '
000441 D172 23               6      INC HL
       D173                     C_BAT2:
000442 D173 77               7      LD  (HL),A
000443 D174 23               6      INC HL
000444 D175 7D               4      LD  A,L
000445 D176 3C               4      INC A       ;L==0FFH
000446 D177 2809            12      JR  Z,RUN_BATCH
000448 D179 CD98D1          17      CALL    FGETC_BAT
00044B D17C 2004            12      JR  NZ,RUN_BATCH
00044D D17E FE20             7      CP  020H
00044F D180 30F1            12      JR  NC,C_BAT2
       D182                     RUN_BATCH:
000451 D182 7D               4      LD  A,L
000452 D183 D67F             7      SUB DTA1-1
000454 D185 328000          13      LD  (DTA1),A
000457 D188 FE04             7      CP  4
000459 D18A 3805            12      JR  C,END_BATCH
00045B D18C 3600            10      LD  (HL),0
00045D D18E C33BD0          10      JP  COMMAND2
       D191                     END_BATCH:
000460 D191 AF               4      XOR A       ;バッチファイルを閉じる
000461 D192 3235EB          13      LD  (FCB_BAT),A
000464 D195 C300F0          10      JP  CPM_BOOT
                                
       D198                     FGETC_BAT:
000467 D198 1135EB          10      LD  DE,FCB_BAT
       D19B                     FGETC:              ;1文字ずつ読み込む
00046A D19B E5              11      PUSH    HL      ;Z:成功
00046B D19C 210100          10      LD  HL,1
00046E D19F CDF2D0          17      CALL    S27
000471 D1A2 E1              10      POP HL
000472 D1A3 3A0001          13      LD  A,(00100H)
000475 D1A6 C9              10      RET
                                
       D1A7                     C_DEL:
000476 D1A7 CDEFD2          17      CALL    SETFCB
000479 D1AA CD24D7          17      CALL    _SYS08      ;(BDOS)エコーなしコンソール入力
                                
00047C D1AD 0E13             7      LD  C,013H
00047E D1AF 180A            12      JR  CDEL1       ;(BDOS)ファイルの削除
                                
       D1B1                     C_REN:
000480 D1B1 CDEFD2          17      CALL    SETFCB
000483 D1B4 3E10             7      LD  A,010H      ;ディレクトリも対象にする
000485 D1B6 326900          13      LD  (FCB1+13),A ;属性
000488 D1B9 0E17             7      LD  C,017H      ;(BDOS)ファイル名の変更
       D1BB                     CDEL1:
00048A D1BB 115C00          10      LD  DE,FCB1
00048D D1BE CD0500          17      CALL    SYSTEM
000490 D1C1 C6FF             7      ADD A,0FFH
000492 D1C3 C9              10      RET
                                
       D1C4                     C_DIR:
000493 D1C4 CD34DB          17      CALL    FILEC
000496 D1C7 2115F0          10      LD  HL,FDRV+1
000499 D1CA CD05D4          17      CALL    CWILD1
00049C D1CD 3EF1             7      LD  A,0F1H
00049E D1CF 3221F0          13      LD  (FDRV+13),A
0004A1 D1D2 CDABD0          17      CALL    OPEN1
       D1D5                     CDIR1:
0004A4 D1D5 B7               4      OR  A
0004A5 D1D6 2008            12      JR  NZ,PDSKF
0004A7 D1D8 CD23D2          17      CALL    P_NAME
0004AA D1DB CDBDD0          17      CALL    OPEN2
0004AD D1DE 18F5            12      JR  CDIR1
       D1E0                     PDSKF:
0004AF D1E0 3A14F0          13      LD  A,(FDRV)
0004B2 D1E3 5F               4      LD  E,A
0004B3 D1E4 0E1B             7      LD  C,01BH      ;(BDOS)ディスク情報の獲得
0004B5 D1E6 CD0500          17      CALL    SYSTEM
0004B8 D1E9 4F               4      LD  C,A     ;C←1クラスタ辺りの論理セクタ数
0004B9 D1EA C601             7      ADD A,001H
0004BB D1EC D8              11      RET C       ;Aが0FFHだった場合
0004BC D1ED 3E06             7      LD  A,8-2
       D1EF                     PDS1:               ;HL=未使用クラスタの総数
0004BE D1EF 3C               4      INC A
0004BF D1F0 CB19             8      RR  C
0004C1 D1F2 30FB            12      JR  NC,PDS1
       D1F4                     PDS2:               ;B←論理セクタのサイズの上位8ビット
0004C3 D1F4 3C               4      INC A
0004C4 D1F5 CB18             8      RR  B
0004C6 D1F7 30FB            12      JR  NC,PDS2
0004C8 D1F9 47               4      LD  B,A
                                
0004C9 D1FA 110000          10      LD  DE,0
       D1FD                     PDS3:
0004CC D1FD 29              11      ADD HL,HL
0004CD D1FE EB               4      EX  DE,HL
0004CE D1FF ED6A            15      ADC HL,HL
0004D0 D201 EB               4      EX  DE,HL
0004D1 D202 10F9            13      DJNZ    PDS3
       D204                     PDSKF1:
0004D3 D204 CD8DD2          17      CALL    PRDEC_DEHL
0004D6 D207 1165EB          10      LD  DE,FREE
0004D9 D20A CD78D4          17      CALL    _SYS09      ;(BDOS)文字列出力
0004DC D20D CD7DD2          17      CALL    PUTDRV
0004DF D210 3E5C             7      LD  A,05CH      ;\
0004E1 D212 CD0ED7          17      CALL    MSG_A
0004E4 D215 2A22F0          16      LD  HL,(FDRV+14)    ;ディレクトリのクラスタ番号
0004E7 D218 AF               4      XOR A
0004E8 D219 11FEFF          10      LD  DE,0-2
0004EB D21C 19              11      ADD HL,DE
0004EC D21D 23               6      INC HL
0004ED D21E DC8AD2          17      CALL    C,PRDEC_HL
0004F0 D221 1833            12      JR  LTNL
                                
       D223                     P_NAME:
0004F2 D223 3A11EB          13      LD  A,(DTA_CCP+1)
0004F5 D226 FE2E             7      CP  '.'
0004F7 D228 C8              11      RET Z
                                
0004F8 D229 3A1CEB          13      LD  A,(DTA_CCP+1+00BH)
0004FB D22C F5              11      PUSH    AF
0004FC D22D CB67             8      BIT 4,A
0004FE D22F 2808            12      JR  Z,DIR3
000500 D231 115AEB          10      LD  DE,DIRMES
000503 D234 CD78D4          17      CALL    _SYS09      ;(BDOS)文字列出力
000506 D237 180A            12      JR  DIR6
       D239                     DIR3:
000508 D239 ED5B2FEB        20      LD  DE,(DTA_CCP+1+01EH)
00050C D23D 2A2DEB          16      LD  HL,(DTA_CCP+1+01CH)
00050F D240 CD8DD2          17      CALL    PRDEC_DEHL
       D243                     DIR6:
000512 D243 F1              10      POP AF
000513 D244 0F               4      RRCA
000514 D245 9F               4      SBC A,A
000515 D246 E60A             7      AND '*'-020H
000517 D248 C620             7      ADD A,020H
000519 D24A CD0ED7          17      CALL    MSG_A
00051C D24D CD7DD2          17      CALL    PUTDRV
00051F D250 2111EB          10      LD  HL,DTA_CCP+1
000522 D253 CDCDD2          17      CALL    FPRNT
                                
       D256                     LTNL:
000525 D256 1E03             7      LD  E,3
000527 D258 C3CDF0          10      JP  _PRINT
                                
       D25B                     C_PATH:
00052A D25B CD16DC          17      CALL    SPCUT
00052D D25E 21D4EA          10      LD  HL,PATHD
000530 D261 FE21             7      CP  021H
000532 D263 300C            12      JR  NC,CPATH0
       D265                     CPATHP:
000534 D265 7E               7      LD  A,(HL)
000535 D266 23               6      INC HL
000536 D267 FE20             7      CP  020H
000538 D269 3F               4      CCF
000539 D26A 30EA            12      JR  NC,LTNL
00053B D26C CD0ED7          17      CALL    MSG_A
00053E D26F 18F4            12      JR  CPATHP
       D271                     CPATH0:
000540 D271 FE3B             7      CP  ';'
000542 D273 2001            12      JR  NZ,CPATH1
000544 D275 13               6      INC DE
       D276                     CPATH1:
000545 D276 EB               4      EX  DE,HL
000546 D277 013B00          10      LD  BC,PATHX
000549 D27A EDB0                    LDIR
00054B D27C C9              10      RET
                                
       D27D                     PUTDRV:
00054C D27D 3A89F0          13      LD  A,(_DSK)
00054F D280 C641             7      ADD A,'A'
000551 D282 CD0ED7          17      CALL    MSG_A
000554 D285 3E3A             7      LD  A,':'
       D287                     MSG_AR:
000556 D287 C30ED7          10      JP  MSG_A
                                
       D28A                     PRDEC_HL:
000559 D28A AF               4      XOR A
00055A D28B 5F               4      LD  E,A
00055B D28C 57               4      LD  D,A
       D28D                     PRDEC_DEHL:
00055C D28D D5              11      PUSH    DE
00055D D28E 110FF0          10      LD  DE,DECBF
000560 D291 0605             7      LD  B,5
000562 D293 CD24D3          17      CALL    ZERO_MEMORY_DE  ;A=0
000565 D296 D1              10      POP DE
                                
000566 D297 0E20             7      LD  C,32
       D299                     DEC1:
000568 D299 29              11      ADD HL,HL
000569 D29A EB               4      EX  DE,HL
00056A D29B ED6A            15      ADC HL,HL
00056C D29D EB               4      EX  DE,HL
00056D D29E E5              11      PUSH    HL
00056E D29F 2113F0          10      LD  HL,DECBF+4
000571 D2A2 0605             7      LD  B,5
       D2A4                     DEC2:
000573 D2A4 7E               7      LD  A,(HL)
000574 D2A5 8F               4      ADC A,A
000575 D2A6 27               4      DAA
000576 D2A7 77               7      LD  (HL),A
000577 D2A8 2B               6      DEC HL
000578 D2A9 10F9            13      DJNZ    DEC2
00057A D2AB E1              10      POP HL
00057B D2AC 0D               4      DEC C
00057C D2AD 20EA            12      JR  NZ,DEC1
                                
00057E D2AF 210FF0          10      LD  HL,DECBF
000581 D2B2 3E20             7      LD  A,020H
000583 D2B4 0604             7      LD  B,4
       D2B6                     DEC3:
000585 D2B6 CDC3D2          17      CALL    DEC4
000588 D2B9 CDC3D2          17      CALL    DEC4
00058B D2BC 23               6      INC HL
00058C D2BD 10F7            13      DJNZ    DEC3
       D2BF                     DECX:
00058E D2BF CDC3D2          17      CALL    DEC4
000591 D2C2 AF               4      XOR A
       D2C3                     DEC4:
000592 D2C3 ED6F            18      RLD
000594 D2C5 FE20             7      CP  020H
000596 D2C7 2802            12      JR  Z,DEC5
000598 D2C9 F630             7      OR  030H
       D2CB                     DEC5:
00059A D2CB 18BA            12      JR  MSG_AR
                                
       D2CD                     FPRNT:
00059C D2CD 0608             7      LD  B,8 ;ファイル名を表示
00059E D2CF CDDED2          17      CALL    P_N1
0005A1 D2D2 7E               7      LD  A,(HL)
0005A2 D2D3 CD62DE          17      CALL    CAP3
0005A5 D2D6 D8              11      RET C   ;拡張子が無い
                                
0005A6 D2D7 3E2E             7      LD  A,'.'
0005A8 D2D9 CD0ED7          17      CALL    MSG_A
0005AB D2DC 0603             7      LD  B,3 ;拡張子を表示
       D2DE                     P_N1:
0005AD D2DE 7E               7      LD  A,(HL)
0005AE D2DF CD62DE          17      CALL    CAP3
0005B1 D2E2 3807            12      JR  C,P_N2
0005B3 D2E4 CD0ED7          17      CALL    MSG_A
0005B6 D2E7 23               6      INC HL
0005B7 D2E8 10F4            13      DJNZ    P_N1
0005B9 D2EA C9              10      RET
       D2EB                     P_N2:
0005BA D2EB 23               6      INC HL
0005BB D2EC 10FD            13      DJNZ    P_N2
0005BD D2EE C9              10      RET
                                
       D2EF                     SETFCB:
0005BE D2EF CD16DC          17      CALL    SPCUT
0005C1 D2F2 1A               7      LD  A,(DE)
0005C2 D2F3 FE20             7      CP  020H
0005C4 D2F5 3801            12      JR  C,SETFCBA
0005C6 D2F7 1B               6      DEC DE
       D2F8                     SETFCBA:
0005C7 D2F8 0624             7      LD  B,36
0005C9 D2FA 215C00          10      LD  HL,FCB1
0005CC D2FD E5              11      PUSH    HL
0005CD D2FE AF               4      XOR A
0005CE D2FF CDEBDB          17      CALL    FILL_MEMORY
0005D1 D302 E1              10      POP HL
0005D2 D303 D5              11      PUSH    DE
0005D3 D304 CDB1D6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005D6 D307 216C00          10      LD  HL,FCB2
0005D9 D30A CDB1D6          17      CALL    _SYS29      ;(BDOS)ファイル名の解析
0005DC D30D E1              10      POP HL
0005DD D30E 010050          10      LD  BC,05000H
0005E0 D311 118100          10      LD  DE,00081H
       D314                     SETFCB1:
0005E3 D314 7E               7      LD  A,(HL)
0005E4 D315 23               6      INC HL
0005E5 D316 FE20             7      CP  020H
0005E7 D318 3805            12      JR  C,SETFCB2
0005E9 D31A 12               7      LD  (DE),A
0005EA D31B 13               6      INC DE
0005EB D31C 0C               4      INC C
0005EC D31D 10F5            13      DJNZ    SETFCB1
       D31F                     SETFCB2:
0005EE D31F 79               4      LD  A,C
0005EF D320 328000          13      LD  (DTA1),A
0005F2 D323 04               4      INC B
       D324                     ZERO_MEMORY_DE:
0005F3 D324 AF               4      XOR A
       D325                     FILL_MEMORY_DE:
0005F4 D325 12               7      LD  (DE),A
0005F5 D326 13               6      INC DE
0005F6 D327 10FC            13      DJNZ    FILL_MEMORY_DE
0005F8 D329 C9              10      RET
                                
       D32A                     C_COPY:
0005F9 D32A CDEFD2          17      CALL    SETFCB
                                
0005FC D32D 1161F0          10      LD  DE,ZERO
0005FF D330 CD37DB          17      CALL    FILEC2
000602 D333 216C00          10      LD  HL,FCB2
000605 D336 CDB8D6          17      CALL    S29X1
                                
000608 D339 3E10             7      LD  A,010H
00060A D33B 326900          13      LD  (FCB1+13),A
00060D D33E 216D00          10      LD  HL,FCB2+1
000610 D341 CD05D4          17      CALL    CWILD1
       D344                     COPY0:
000613 D344 CD02D4          17      CALL    CWILD
000616 D347 215C00          10      LD  HL,FCB1
000619 D34A CDAED0          17      CALL    OPEN
00061C D34D 37               4      SCF
       D34E                     COPY1:
00061D D34E C0              11      RET NZ
00061E D34F CDC1D0          17      CALL    DEFCB
                                
000621 D352 3A1DEB          13      LD  A,(DTA_CCP+13)
000624 D355 CB67             8      BIT 4,A
000626 D357 2821            12      JR  Z,COPY1A
                                
000628 D359 215D00          10      LD  HL,FCB1+1
00062B D35C CD7ADF          17      CALL    CHKWILD
00062E D35F 3814            12      JR  C,COPY9
                                
000630 D361 3E20             7      LD  A,020H
000632 D363 325D00          13      LD  (FCB1+1),A
000635 D366 2A2AEB          16      LD  HL,(DTA_CCP+26)
000638 D369 23               6      INC HL
000639 D36A 226A00          16      LD  (FCB1+14),HL
00063C D36D 18D5            12      JR  COPY0
                                
       D36F                     COPY8:
00063E D36F CD78D4          17      CALL    _SYS09      ;(BDOS)文字列出力
000641 D372 CD56D2          17      CALL    LTNL
       D375                     COPY9:
000644 D375 CDBDD0          17      CALL    OPEN2
000647 D378 18D4            12      JR  COPY1
                                
       D37A                     COPY1A:
000649 D37A 216C00          10      LD  HL,FCB2
00064C D37D 1114F0          10      LD  DE,FDRV
00064F D380 0112EB          10      LD  BC,DTA_CCP+2
000652 D383 EDA0            16      LDI
000654 D385 3E0B             7      LD  A,11
       D387                     COPY2:
000656 D387 F5              11      PUSH    AF
000657 D388 7E               7      LD  A,(HL)
000658 D389 FE3F             7      CP  '?'
00065A D38B 2001            12      JR  NZ,COPY3
00065C D38D 0A               7      LD  A,(BC)
       D38E                     COPY3:
00065D D38E 12               7      LD  (DE),A
00065E D38F 03               6      INC BC
00065F D390 13               6      INC DE
000660 D391 23               6      INC HL
000661 D392 F1              10      POP AF
000662 D393 3D               4      DEC A
000663 D394 20F1            12      JR  NZ,COPY2
000665 D396 010500          10      LD  BC,16-11
000668 D399 EDB0                    LDIR
       D39B                     PUTNAME:
00066A D39B 215D00          10      LD  HL,FCB1+1
00066D D39E CD7ADF          17      CALL    CHKWILD
000670 D3A1 300B            12      JR  NC,PUTN1
000672 D3A3 2115F0          10      LD  HL,FDRV+1
000675 D3A6 CDCDD2          17      CALL    FPRNT
000678 D3A9 3E20             7      LD  A,020H
00067A D3AB CD0ED7          17      CALL    MSG_A
       D3AE                     PUTN1:
00067D D3AE 1114F0          10      LD  DE,FDRV
000680 D3B1 0E16             7      LD  C,016H      ;(BDOS)ファイルの作成
000682 D3B3 CDDCD0          17      CALL    SYSTEM0
000685 D3B6 2048            12      JR  NZ,COPYE2
000687 D3B8 67               4      LD  H,A     ;A=0
000688 D3B9 6F               4      LD  L,A
000689 D3BA 2235F0          16      LD  (FDRV+33),HL    ;(FCB)ランダムレコード
00068C D3BD 2237F0          16      LD  (FDRV+35),HL
       D3C0                     COPY6:
00068F D3C0 CDE5D0          17      CALL    S27BUF
000692 D3C3 47               4      LD  B,A
000693 D3C4 3C               4      INC A
000694 D3C5 2831            12      JR  Z,COPYE
000696 D3C7 7C               4      LD  A,H
000697 D3C8 B5               4      OR  L
000698 D3C9 280C            12      JR  Z,COPY7
00069A D3CB 1114F0          10      LD  DE,FDRV
00069D D3CE 0E26             7      LD  C,026H      ;(BDOS)ランダムブロック書き込み
00069F D3D0 CDDCD0          17      CALL    SYSTEM0
0006A2 D3D3 2023            12      JR  NZ,COPYE
0006A4 D3D5 10E9            13      DJNZ    COPY6
       D3D7                     COPY7:
0006A6 D3D7 3A1DEB          13      LD  A,(DTA_CCP+13)  ;(FCB)属性
0006A9 D3DA 3221F0          13      LD  (FDRV+13),A
0006AC D3DD 2124EB          10      LD  HL,DTA_CCP+20   ;(FCB)タイムスタンプ
0006AF D3E0 1128F0          10      LD  DE,FDRV+20
0006B2 D3E3 010400          10      LD  BC,4
0006B5 D3E6 EDB0                    LDIR
                                
0006B7 D3E8 1114F0          10      LD  DE,FDRV
0006BA D3EB 0E10             7      LD  C,010H      ;(BDOS)ファイルのクローズ
0006BC D3ED CDDCD0          17      CALL    SYSTEM0
0006BF D3F0 2006            12      JR  NZ,COPYE
                                
0006C1 D3F2 1171F0          10      LD  DE,OK
0006C4 D3F5 C36FD3          10      JP  COPY8
                                
       D3F8                     COPYE:
0006C7 D3F8 1114F0          10      LD  DE,FDRV
0006CA D3FB 0E13             7      LD  C,013H      ;(BDOS)ファイルの削除
0006CC D3FD CD0500          17      CALL    SYSTEM
       D400                     COPYE2:
0006CF D400 37               4      SCF
0006D0 D401 C9              10      RET
                                
       D402                     CWILD:
0006D1 D402 215D00          10      LD  HL,FCB1+1
       D405                     CWILD1:
0006D4 D405 7E               7      LD  A,(HL)
0006D5 D406 FE20             7      CP  020H
0006D7 D408 C0              11      RET NZ
       D409                     CWILD2:
0006D8 D409 3E3F             7      LD  A,'?'
0006DA D40B 060B             7      LD  B,11
0006DC D40D C3EBDB          10      JP  FILL_MEMORY
                                
       D410                     COMTB:
0006DF D410 44202020                DB  "D   "  ;1
0006E3 D414 C4D1                    DW  C_DIR
0006E5 D416 44495220                DB  "DIR "  ;2
0006E9 D41A C4D1                    DW  C_DIR
0006EB D41C 434F5059                DB  "COPY"  ;3
0006EF D420 2AD3                    DW  C_COPY
0006F1 D422 43442020                DB  "CD  "  ;4
0006F5 D426 E1D0                    DW  C_CD
0006F7 D428 44454C20                DB  "DEL "  ;5
0006FB D42C A7D1                    DW  C_DEL
0006FD D42E 50415448                DB  "PATH"  ;6
000701 D432 5BD2                    DW  C_PATH
000703 D434 52454E20                DB  "REN "  ;7
000707 D438 B1D1                    DW  C_REN
000709 D43A 52454D20                DB  "REM "  ;8
00070D D43E 75D4                    DW  C_REM
[EOF:LDCCP.ASM:SHIFT_JIS]
                                    INCLUDE "M7CCP2.ASM"
                                
                                ;   LSX-Dodgers CCP2
                                ;   MZ-700/1500
                                
00070F D440 4D4F4E20                DB  "MON "  ;10
000713 D444 D8CF                    DW  C_MON
[EOF:M7CCP2.ASM:UTF_8]
                                    INCLUDE "LDOS.ASM"
                                
                                ;   LSX-Dodgers OS
                                
       D446                     BDOS0:
000715 D446 E5              11      PUSH    HL
000716 D447 79               4      LD  A,C
000717 D448 FE3C             7      CP  03CH
000719 D44A 3802            12      JR  C,DOS1
00071B D44C 3E3C             7      LD  A,03CH
       D44E                     DOS1:
00071D D44E 87               4      ADD A,A
00071E D44F 6F               4      LD  L,A
00071F D450 26F1             7      LD  H,STABLE/256
000721 D452 7E               7      LD  A,(HL)
000722 D453 2C               4      INC L
000723 D454 66               7      LD  H,(HL)
000724 D455 6F               4      LD  L,A
000725 D456 E3              19      EX  (SP),HL
000726 D457 79               4      LD  A,C
                                ;確認用
                                ;   LD  (0050H),A
000727 D458 C9              10      RET
       D459                     _DOS2:
000728 D459 FE5A             7      CP  05AH        ;(BDOS)カレントディレクトリの変更(_CHDIR)
00072A D45B CAF3D6          10      JP  Z,_SYS5A
00072D D45E FE5C             7      CP  05CH        ;(BDOS)ファイル名の解析(_PFILE)
00072F D460 CAB1D6          10      JP  Z,_SYS29
000732 D463 FE5F             7      CP  05FH        ;(BDOS)ディスクバッファのフラッシュ(_FLUSH)
000734 D465 CA87E8          10      JP  Z,_SYS5F
000737 D468 FE6F             7      CP  06FH        ;(BDOS)MSX-DOS のバージョン番号の獲得(_DOSVER)
000739 D46A 200A            12      JR  NZ,_ERROR
00073B D46C 011D01          10      LD  BC,VER_6F
00073E D46F 115901          10      LD  DE,VER
000741 D472 210100          10      LD  HL,MACD
       D475                     C_REM:
000744 D475 AF               4      XOR A
       D476                     _ERROR:
000745 D476 A7               4      AND A
000746 D477 C9              10      RET
                                
       D478                     _SYS09:     ;文字列出力
000747 D478 D5              11      PUSH    DE
       D479                     _SX09:
000748 D479 1A               7      LD  A,(DE)
000749 D47A 13               6      INC DE
00074A D47B FE24             7      CP  '$'
00074C D47D 2831            12      JR  Z,SX0E2
00074E D47F CD0ED7          17      CALL    MSG_A
000751 D482 18F5            12      JR  _SX09
                                
       D484                     MSX1:
000753 D484 CD0ED7          17      CALL    MSG_A
       D487                     MSX:
000756 D487 7E               7      LD  A,(HL)
000757 D488 23               6      INC HL
000758 D489 B7               4      OR  A
000759 D48A 20F8            12      JR  NZ,MSX1
00075B D48C C9              10      RET
                                
       D48D                     _SYS0C:     ;(BDOS)バージョン番号の獲得
00075C D48D 212200          10      LD  HL,00022H
00075F D490 7D               4      LD  A,L
000760 D491 C9              10      RET
                                
       D492                     _SYS0D:     ;(BDOS)ディスクリセット
000761 D492 CDDFF0          17      CALL    _FFLUSH
000764 D495 E5              11      PUSH    HL
000765 D496 218000          10      LD  HL,00080H
000768 D499 228AF0          16      LD  (_DTA),HL
00076B D49C E1              10      POP HL
00076C D49D D5              11      PUSH    DE
00076D D49E 1E00             7      LD  E,0
00076F D4A0 3E                      DB  03EH    ;次の PUSH DE をスキップ
                                
       D4A1                     _SYS0E:     ;(BDOS)カレントドライブの設定
000770 D4A1 D5              11      PUSH    DE
000771 D4A2 7B               4      LD  A,E
000772 D4A3 DDE5            15      PUSH    IX
000774 D4A5 CDDCF0          17      CALL    _GETDPB
000777 D4A8 DDE1            14      POP IX
000779 D4AA 3804            12      JR  C,SX0E2
00077B D4AC 7B               4      LD  A,E
00077C D4AD 3287F0          13      LD  (_DVSW),A
       D4B0                     SX0E2:
00077F D4B0 D1              10      POP DE
000780 D4B1 C9              10      RET
                                
       D4B2                     _SYS0F:     ;(BDOS)ファイルのオープン
000781 D4B2 CD28DC          17      CALL    SETDRV
000784 D4B5 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
000787 D4B8 C602             7      ADD A,002H      ;Write
000789 D4BA 2848            12      JR  Z,FEND0F
00078B D4BC CD76DF          17      CALL    CHKWILDX
                                
00078E D4BF D452DC          17      CALL    NC,SOPENX
       D4C2                     _S16XX:
000791 D4C2 3840            12      JR  C,FEND0F
                                                ;Directory location
000793 D4C4 3A9FF0          13      LD  A,(_FILEN)
000796 D4C7 FD7719          19      LD  (IY+25),A   ;(FCB)ディレクトリロケーション
                                ;               _DIRF
000799 D4CA 3AA0F0          13      LD  A,(_DIRF)
00079C D4CD FD771D          19      LD  (IY+29),A   ;(FCB)ディレクトリモード
                                ;               _FBPS
00079F D4D0 FD731E          19      LD  (IY+30),E   ;(FCB)ディレクトリポジション
0007A2 D4D3 FD721F          19      LD  (IY+31),D
                                ;               Open(Read)
0007A5 D4D6 FD361CFF        19      LD  (IY+28),0FFH    ;(FCB)オープンモード
                                ;               FILENAME
0007A9 D4DA FDE5            15      PUSH    IY
0007AB D4DC D1              10      POP DE
0007AC D4DD 13               6      INC DE
0007AD D4DE 010B00          10      LD  BC,11
0007B0 D4E1 EDB0                    LDIR
                                ;               Attribute
0007B2 D4E3 7E               7      LD  A,(HL)
0007B3 D4E4 FD770D          19      LD  (IY+13),A   ;(FCB)属性(アトリビュート)
0007B6 D4E7 110B00          10      LD  DE,11       ;Reserved
0007B9 D4EA 19              11      ADD HL,DE
                                                    ;(FCB)ファイルを最後に変更した時刻
0007BA D4EB 11E4F1          10      LD  DE,SDDATA       ;(FCB)ファイルを最後に変更した日付
0007BD D4EE 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       D4F0                     S16LOOP:                ;(FCB)ファイルのサイズ(バイト単位)
0007BF D4F0 1A               7      LD  A,(DE)
0007C0 D4F1 13               6      INC DE
0007C1 D4F2 32F9D4          13      LD  (S16PAT),A
0007C4 D4F5 7E               7      LD  A,(HL)
0007C5 D4F6 23               6      INC HL
0007C6 D4F7 FD7700          19      LD  (IY+0),A
       D4F9                     S16PAT  EQU $-1
0007C9 D4FA 10F4            13      DJNZ    S16LOOP
                                
0007CB D4FC AF               4      XOR A
0007CC D4FD FD770C          19      LD  (IY+12),A   ;(FCB)カレントブロック
0007CF D500 FD22A1D5        20      LD  (OFCB_SWC),IY
       D504                     FEND0F:
0007D3 D504 1845            12      JR  FEND10
                                
       D506                     _SYS10:     ;(BDOS)ファイルのクローズ
0007D5 D506 CD28DC          17      CALL    SETDRV
0007D8 D509 FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0007DB D50C D6FE             7      SUB 0FEH
0007DD D50E 37               4      SCF
0007DE D50F 3F               4      CCF
0007DF D510 2039            12      JR  NZ,FEND10
       D512                     _S10A:              ;Write
0007E1 D512 FD770E          19      LD  (IY+14),A   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
0007E4 D515 FD770F          19      LD  (IY+15),A
                                
0007E7 D518 FD341C          23      INC (IY+28)     ;(FCB)オープンモード 0FEH->0FFH
0007EA D51B CD72E0          17      CALL    SETTMS
                                
0007ED D51E FD7E1D          19      LD  A,(IY+29)   ;(FCB)ディレクトリモード
0007F0 D521 32A0F0          13      LD  (_DIRF),A
0007F3 D524 E67F             7      AND 07FH
0007F5 D526 329DE5          13      LD  (_SECPS),A
0007F8 D529 FD5E1E          19      LD  E,(IY+30)   ;(FCB)ディレクトリポジション
0007FB D52C FD561F          19      LD  D,(IY+31)
0007FE D52F CD87DD          17      CALL    READ_DIR
000801 D532 3817            12      JR  C,FEND10
                                
000803 D534 3AB2DC          13  SDECM1: LD  A,(SDECPAT) ;1セクタ辺りのディレクトリエントリ数
000806 D537 3D               4      DEC A       ;1024=01FH / 512=00FH / 256=7
000807 D538 FDA619          19      AND (IY+25)     ;(FCB)ディレクトリロケーション
00080A D53B 6F               4      LD  L,A
00080B D53C 2600             7      LD  H,0
00080D D53E 29              11      ADD HL,HL       ;*2
00080E D53F 29              11      ADD HL,HL       ;*4
00080F D540 29              11      ADD HL,HL       ;*8
000810 D541 29              11      ADD HL,HL       ;*16
000811 D542 29              11      ADD HL,HL       ;*32
000812 D543 ED4B7EF1        20      LD  BC,(_DTBUF)
000816 D547 09              11      ADD HL,BC
                                
000817 D548 CD86DF          17      CALL    SDIRENT
       D54B                     FEND10:
00081A D54B 1842            12      JR  FEND
                                
       D54D                     _SYS11:     ;(BDOS)最初のファイルの検索
00081C D54D CD28DC          17      CALL    SETDRV
00081F D550 CD81DC          17      CALL    SOPEN
       D553                     _S12X1:
000822 D553 383A            12      JR  C,FEND
000824 D555 CD20DD          17      CALL    SOPENE2
000827 D558 ED5B8AF0        20      LD  DE,(_DTA)
00082B D55C 3A88F0          13      LD  A,(_DRV)
00082E D55F 3C               4      INC A
00082F D560 12               7      LD  (DE),A
000830 D561 D5              11      PUSH    DE
000831 D562 13               6      INC DE
000832 D563 012000          10      LD  BC,32
000835 D566 EDB0                    LDIR
000837 D568 FD6E0E          19      LD  L,(IY+14)   ;(FCB)レコードサイズ/アクセスするディレクトリのクラスタ番号+1
00083A D56B FD660F          19      LD  H,(IY+15)
00083D D56E 22F4F1          16      LD  (SCDIR),HL
000840 D571 2A9AF0          16      LD  HL,(_FBPS)
000843 D574 22F6F1          16      LD  (SFBPS),HL
000846 D577 2A9FF0          16      LD  HL,(_FILEN)
000849 D57A 7C               4      LD  A,H
00084A D57B B7               4      OR  A
00084B D57C 2806            12      JR  Z,_S12DIR
00084D D57E 3A9DE5          13      LD  A,(_SECPS)
000850 D581 F680             7      OR  080H
000852 D583 67               4      LD  H,A
       D584                     _S12DIR:
000853 D584 22F8F1          16      LD  (SFNDF),HL  ;Directory position and Flags
000856 D587 E1              10      POP HL
000857 D588 1139F0          10      LD  DE,SFILE
00085A D58B 0E21             7      LD  C,33
       D58D                     _S11B:
00085C D58D EDB0                    LDIR
       D58F                     FEND:
00085E D58F 9F               4      SBC A,A     ;CF=0 A=0 : CF=1 A=0FFH
       D590                     FENDE:
00085F D590 FDE1            14      POP IY
000861 D592 C1              10      POP BC
000862 D593 D1              10      POP DE
000863 D594 E1              10      POP HL
000864 D595 C9              10      RET
                                
       D596                     _SYS12:     ;(BDOS)次のファイルの検索
000865 D596 E5              11      PUSH    HL
000866 D597 D5              11      PUSH    DE
000867 D598 C5              11      PUSH    BC
000868 D599 FDE5            15      PUSH    IY
00086A D59B CDE5DC          17      CALL    NOPEN
00086D D59E 18B3            12      JR  _S12X1
                                
       D5A0                     _S16K:
00086F D5A0 110000          10      LD  DE,0
       D5A1                     OFCB_SWC    EQU $-2
000872 D5A3 D5              11      PUSH    DE
000873 D5A4 061A             7      LD  B,26        ;First cluster
       D5A6                     S16K1:
000875 D5A6 13               6      INC DE
000876 D5A7 23               6      INC HL
000877 D5A8 10FC            13      DJNZ    S16K1
                                
000879 D5AA 1A               7      LD  A,(DE)
00087A D5AB BE               7      CP  (HL)
00087B D5AC 2015            12      JR  NZ,S16K2
00087D D5AE 13               6      INC DE
00087E D5AF 23               6      INC HL
00087F D5B0 1A               7      LD  A,(DE)
000880 D5B1 BE               7      CP  (HL)
000881 D5B2 200F            12      JR  NZ,S16K2
                                
000883 D5B4 E1              10      POP HL
000884 D5B5 FDE5            15      PUSH    IY
000886 D5B7 D1              10      POP DE
000887 D5B8 7E               7      LD  A,(HL)
000888 D5B9 CD3DDC          17      CALL    IS_SAME_DRV_A_DE
00088B D5BC 2006            12      JR  NZ,S16K3
                                                ;ここはCFが必ず0
00088D D5BE ED52            15      SBC HL,DE       ;CP HL,DE
00088F D5C0 37               4      SCF
000890 D5C1 C0              11      RET NZ
000891 D5C2 E5              11      PUSH    HL
       D5C3                     S16K2:
000892 D5C3 E1              10      POP HL
       D5C4                     S16K3:
000893 D5C4 FDE5            15      PUSH    IY
000895 D5C6 D1              10      POP DE
       D5C7                     _SYS13:     ;(BDOS)ファイルの削除
000896 D5C7 CD28DC          17      CALL    SETDRV
000899 D5CA CDACDE          17      CALL    KILL
       D5CD                     FEND13:
00089C D5CD 18C0            12      JR  FEND
                                
       D5CF                     _SYS14:     ;(BDOS)シーケンシャルな読み出し
00089E D5CF CD28DC          17      CALL    SETDRV
0008A1 D5D2 CDDEE0          17      CALL    INIT_SEQ
       D5D5                     SREAD:
0008A4 D5D5 CD26E1          17      CALL    RB_READ
                                
0008A7 D5D8 C601             7      ADD A,001H
0008A9 D5DA 38B3            12      JR  C,FEND
                                
0008AB D5DC 7D               4      LD  A,L
0008AC D5DD D601             7      SUB 001H
       D5DF                     FENDX:
0008AE D5DF 9F               4      SBC A,A
0008AF D5E0 E603             7      AND 3
0008B1 D5E2 1F               4      RRA
0008B2 D5E3 18AB            12      JR  FENDE
                                
       D5E5                     _SYS15:     ;(BDOS)シーケンシャルな書き込み
0008B4 D5E5 CD28DC          17      CALL    SETDRV
0008B7 D5E8 CDDEE0          17      CALL    INIT_SEQ
       D5EB                     SWRITE:
0008BA D5EB CD1FE1          17      CALL    RB_WRITE
                                
0008BD D5EE C6FF             7      ADD A,0FFH
0008BF D5F0 18ED            12      JR  FENDX
                                
       D5F2                     _SYS17:     ;(BDOS)ファイル名の変更
0008C1 D5F2 CD28DC          17      CALL    SETDRV
0008C4 D5F5 CD02DF          17      CALL    NAME
0008C7 D5F8 18D3            12      JR  FEND13
                                
       D5FA                     _SYS16:     ;(BDOS)ファイルの作成
0008C9 D5FA CD28DC          17      CALL    SETDRV
                                
0008CC D5FD CD76DF          17      CALL    CHKWILDX
0008CF D600 38CB            12      JR  C,FEND13
0008D1 D602 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
0008D4 D605 FE05             7      CP  5
0008D6 D607 2805            12      JR  Z,_S16X2
0008D8 D609 FE21             7      CP  021H
0008DA D60B DACDD5          10      JP  C,FEND13
       D60E                     _S16X2:
                                ;               Clear FCB
0008DD D60E FDE5            15      PUSH    IY
0008DF D610 E1              10      POP HL
0008E0 D611 011000          10      LD  BC,16
0008E3 D614 09              11      ADD HL,BC
       D615                     _S16X1:
0008E4 D615 70               7      LD  (HL),B      ;B=0
0008E5 D616 23               6      INC HL
0008E6 D617 0D               4      DEC C
0008E7 D618 20FB            12      JR  NZ,_S16X1
                                
0008E9 D61A CD77E0          17      CALL    SETTMSX
0008EC D61D FD360DFF        19      LD  (IY+13),0FFH    ;(FCB)Attribute
0008F0 D621 CD52DC          17      CALL    SOPENX
0008F3 D624 3F               4      CCF
0008F4 D625 CCA0D5          17      CALL    Z,_S16K
0008F7 D628 D431DD          17      CALL    NC,COPEN
0008FA D62B D486DF          17      CALL    NC,SDIRENT
0008FD D62E C3C2D4          10      JP  _S16XX
                                
       D631                     _SYS21:     ;(BDOS)ランダムな読み出し
000900 D631 CD28DC          17      CALL    SETDRV
000903 D634 CDC2E0          17      CALL    INIT_RND
000906 D637 189C            12      JR  SREAD
                                
       D639                     _SYS22:     ;(BDOS)ランダムな書き込み
       D639                     _SYS28:     ;(BDOS)ランダムな書き込み・その2
000908 D639 CD28DC          17      CALL    SETDRV
00090B D63C CDC2E0          17      CALL    INIT_RND
00090E D63F 18AA            12      JR  SWRITE
                                
       D641                     _SYS18:     ;(BDOS)ログインベクトルの獲得
000910 D641 21FF00          10      LD  HL,000FFH
000913 D644 AF               4      XOR A
000914 D645 C9              10      RET
                                
       D646                     _SYS19:     ;(BDOS)カレントドライブ番号の獲得
000915 D646 3A87F0          13      LD  A,(_DVSW)
000918 D649 A7               4      AND A
000919 D64A C9              10      RET
                                
       D64B                     _SYS1A:     ;(BDOS)DTAの設定
00091A D64B ED538AF0        20      LD  (_DTA),DE
00091E D64F AF               4      XOR A
00091F D650 C9              10      RET
                                
       D651                     _SYS1B:     ;(BDOS)ディスク情報の獲得
000920 D651 7B               4      LD  A,E
000921 D652 CD36DC          17      CALL    GETDRV
000924 D655 CDDCF0          17      CALL    _GETDPB
000927 D658 D4E2F0          17      CALL    NC,_RDFATX
00092A D65B 210000          10      LD  HL,0
00092D D65E D450E0          17      CALL    NC,DSKF
                                
000930 D661 ED5B51E0        20      LD  DE,(MAXCLP) ;DPB_MAXCL-1
000934 D665 1B               6      DEC DE      ;DE←クラスタの総数
000935 D666 FD2A7CF1        20      LD  IY,(_FATBF) ;IY←メモリ上のFATの先頭アドレス
000939 D66A 9F               4      SBC A,A
00093A D66B D8              11      RET C
00093B D66C 4F               4      LD  C,A     ;C=0
00093C D66D DD7E0F          19      LD  A,(IX+DPB_BPS)
00093F D670 E607             7      AND 7
000941 D672 47               4      LD  B,A
000942 D673 DD7E07          19      LD  A,(IX+DPB_SECPCL)
000945 D676 C9              10      RET
                                
       D677                     _SYS1D:     ;(BDOS)書き込みが禁止されているディスクの調査
000946 D677 AF               4      XOR A
000947 D678 67               4      LD  H,A
000948 D679 6F               4      LD  L,A
000949 D67A C9              10      RET
                                
       D67B                     _SYS1F:     ;(BDOS)ディスク装置のパラメータの読み出し
00094A D67B 2100F2          10      LD  HL,_DEVICE
00094D D67E 7B               4      LD  A,E
00094E D67F C3DCF0          10      JP  _GETDPB
                                
       D682                     _SYS23:     ;(BDOS)ファイルサイズの獲得
000951 D682 E5              11      PUSH    HL
000952 D683 2A1EF1          16      LD  HL,(STABLE+2*00FH)  ;ファイルのオープン
000955 D686 CD0F00          17      CALL    JP_HL
000958 D689 381B            12      JR  C,_S23X1
                                
00095A D68B D5              11      PUSH    DE      ;EX DE,IY
00095B D68C FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00095D D68E FD7E10          19      LD  A,(IY+16)   ;(FCB)ファイルのサイズ(バイト単位)
000960 D691 FD6E11          19      LD  L,(IY+17)   ;
000963 D694 FD6612          19      LD  H,(IY+18)   ;
000966 D697 C5              11      PUSH    BC      ;
000967 D698 FD4613          19      LD  B,(IY+19)   ;
00096A D69B CDB4E0          17      CALL    GET_CPM_R_SIZE
00096D D69E C1              10      POP BC
       D69F                     _S24X1:
00096E D69F CDD4E0          17      CALL    SET_RR_AHL
                                ;   POP DE      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                ;   PUSH    DE      ;EX DE,IY
000971 D6A2 FDE3            23      EX  (SP),IY     ;
000973 D6A4 D1              10      POP DE      ;
                                
000974 D6A5 AF               4      XOR A
       D6A6                     _S23X1:
000975 D6A6 E1              10      POP HL
000976 D6A7 C9              10      RET
                                
       D6A8                     _SYS24:     ;(BDOS)ランダムレコードフィールドの設定
000977 D6A8 E5              11      PUSH    HL
000978 D6A9 D5              11      PUSH    DE      ;EX DE,IY
000979 D6AA FDE3            23      EX  (SP),IY     ;
                                ;   POP DE      ;
                                ;   PUSH    DE      ;DEを破壊しないように注意vv
00097B D6AC CDE6E0          17      CALL    GETSEQ
00097E D6AF 18EE            12      JR  _S24X1      ;^^^^^^^^^^^^^^^^^^^^^^^^
                                
       D6B1                     _SYS29:     ;(BDOS)ファイル名の解析(_PPATH)
000980 D6B1 C5              11      PUSH    BC
000981 D6B2 E5              11      PUSH    HL
000982 D6B3 CD3FDB          17      CALL    FILE
000985 D6B6 E1              10      POP HL
000986 D6B7 C1              10      POP BC
       D6B8                     S29X1:
000987 D6B8 C5              11      PUSH    BC
000988 D6B9 D5              11      PUSH    DE
000989 D6BA E5              11      PUSH    HL
00098A D6BB EB               4      EX  DE,HL
00098B D6BC AF               4      XOR A
00098C D6BD 3221F0          13      LD  (FDRV+13),A
00098F D6C0 2114F0          10      LD  HL,FDRV
000992 D6C3 011000          10      LD  BC,16
000995 D6C6 EDB0                    LDIR
000997 D6C8 E1              10      POP HL
000998 D6C9 D1              10      POP DE
000999 D6CA C1              10      POP BC
00099A D6CB C9              10      RET
                                
       D6CC                     _SYS30:     ;(BDOS)論理セクタを用いた書き込み
00099B D6CC C5              11      PUSH    BC
00099C D6CD 0137E7          10      LD  BC,DWT24B
00099F D6D0 1804            12      JR  S2FX
       D6D2                     _SYS2F:
0009A1 D6D2 C5              11      PUSH    BC
0009A2 D6D3 0127E7          10      LD  BC,DRD24B
       D6D6                     S2FX:
0009A5 D6D6 ED43ECD6        20      LD  (S2FPAT+1),BC
0009A9 D6DA CDDFF0          17      CALL    _FFLUSH
                                
0009AC D6DD D5              11      PUSH    DE
0009AD D6DE E5              11      PUSH    HL
0009AE D6DF 7D               4      LD  A,L     ;Drive
0009AF D6E0 CDD9F0          17      CALL    _CHGDRV
0009B2 D6E3 3809            12      JR  C,S30X2
0009B4 D6E5 44               4      LD  B,H     ;Number of clusters
0009B5 D6E6 2A8AF0          16      LD  HL,(_DTA)
                                
0009B8 D6E9 0E00             7      LD  C,0
0009BA D6EB CD27E7          17  S2FPAT: CALL    DRD24B
       D6EE                     S30X2:
0009BD D6EE E1              10      POP HL
0009BE D6EF D1              10      POP DE
0009BF D6F0 C1              10      POP BC
0009C0 D6F1 9F               4      SBC A,A
0009C1 D6F2 C9              10      RET
                                
       D6F3                     _SYS5A:     ;(BDOS)カレントディレクトリの変更
0009C2 D6F3 C5              11      PUSH    BC
0009C3 D6F4 D5              11      PUSH    DE
0009C4 D6F5 E5              11      PUSH    HL
0009C5 D6F6 CD34DB          17      CALL    FILEC
0009C8 D6F9 210000          10      LD  HL,0
0009CB D6FC 1114F0          10      LD  DE,FDRV
0009CE D6FF 2A4EF1          16      LD  HL,(STABLE+2*027H)  ;ランダムブロック読み込み
0009D1 D702 CD0F00          17      CALL    JP_HL
0009D4 D705 18E7            12      JR  S30X2
[EOF:LDOS.ASM:SHIFT_JIS]
                                    INCLUDE "M7IO.ASM"
                                
                                ;   LSX-Dodgers IO
                                ;   MZ-700/1500
                                
       D476                     _SYS04  EQU _ERROR      ;(BDOS)外部出力
       D476                     _SYS05  EQU _ERROR      ;(BDOS)プリンタ出力
       D476                     _SYS1C  EQU _ERROR      ;(BDOS)ディスクの書き込み禁止化
       D476                     _SYS1E  EQU _ERROR      ;(BDOS)ファイル属性の設定
       D476                     _SYS20  EQU _ERROR      ;(BDOS)利用者番号の設定と読み出し
       D476                     _SYS2E  EQU _ERROR      ;(BDOS)ベリファイ・フラグの設定
                                
       0000                     INT EQU 0
       0000                     INTCTCE EQU 0
       0000                     INTCTC2 EQU 0
                                
       D707                     POP_AF_HL_SCF_RET:
0009D6 D707 F1              10      POP AF
0009D7 D708 E1              10      POP HL
0009D8 D709 37               4      SCF
       D70A                     KEYBC_IFBREAK:
0009D9 D70A C9              10      RET
                                
       D70B                     _SYS01:     ;(BDOS)コンソール入力
0009DA D70B CD09F0          17      CALL    _SYS07
       D70E                     MSG_A:
0009DD D70E F5              11      PUSH    AF
0009DE D70F D5              11      PUSH    DE
0009DF D710 5F               4      LD  E,A
0009E0 D711 CD17D7          17      CALL    _SYS02
0009E3 D714 D1              10      POP DE
0009E4 D715 F1              10      POP AF
0009E5 D716 C9              10      RET
                                
       D717                     _SYS02:     ;(BDOS)コンソール出力
0009E6 D717 CD29D7          17      CALL    BREAK
0009E9 D71A 1805            12      JR  PRINTX
                                
       D71C                     _SYS06:     ;(BDOS)コンソール直接入出力
0009EB D71C 7B               4      LD  A,E
0009EC D71D 3C               4      INC A
0009ED D71E CACAF0          10      JP  Z,_INKEY
       D721                     PRINTX:
0009F0 D721 C3CDF0          10      JP  _PRINT
                                
       D724                     _SYS08:     ;(BDOS)エコーなしコンソール入力
0009F3 D724 CD09F0          17      CALL    _SYS07
0009F6 D727 1803            12      JR  BREAK1
       D729                     BREAK:
0009F8 D729 CDC6DA          17      CALL    CHKEY
       D72C                     BREAK1:
0009FB D72C FE03             7      CP  3       ;CTRL+C
0009FD D72E CA00F0          10      JP  Z,CPM_BOOT
000A00 D731 FE13             7      CP  013H        ;CTRL+S
000A02 D733 C0              11      RET NZ
                                
       D734                     PAUSE:
       D734                     FLGET:
000A03 D734 CDDFF0          17      CALL    _FFLUSH
000A06 D737 E5              11      PUSH    HL
000A07 D738 2A8EF0          16      LD  HL,(_TXADR)
000A0A D73B 7C               4      LD  A,H
000A0B D73C C6D0             7      ADD A,0D0H
000A0D D73E 67               4      LD  H,A
000A0E D73F CD25CF          17      CALL    RDMMIO
000A11 D742 3257D7          13      LD  (FLSMC),A
       D745                     FLGET1:
000A14 D745 CD1BCF          17      CALL    RD556VSYNC
000A17 D748 CB77             8      BIT 6,A
000A19 D74A 3EEF             7      LD  A,0EFH      ;カーソル
000A1B D74C 200A            12      JR  NZ,FLGET2
000A1D D74E 3A92F0          13      LD  A,(_KEYD)
000A20 D751 B7               4      OR  A
000A21 D752 3EEF             7      LD  A,0EFH      ;カーソル
000A23 D754 2002            12      JR  NZ,FLGET2
000A25 D756 3E00             7      LD  A,0     ;自己書き換え
       D757                     FLSMC   EQU $-1
       D758                     FLGET2:
000A27 D758 CD2DCF          17      CALL    WRMMIO
000A2A D75B CDCAF0          17      CALL    _INKEY
000A2D D75E 28E5            12      JR  Z,FLGET1
000A2F D760 F5              11      PUSH    AF
000A30 D761 3A57D7          13      LD  A,(FLSMC)
000A33 D764 CD2DCF          17      CALL    WRMMIO
000A36 D767 F1              10      POP AF
000A37 D768 E1              10      POP HL
000A38 D769 C9              10      RET
                                
       D76A                     _SYS0A:     ;(BDOS)文字列入力
000A39 D76A C5              11      PUSH    BC
000A3A D76B E5              11      PUSH    HL
000A3B D76C D5              11      PUSH    DE
000A3C D76D CDFFD9          17      CALL    GETL
000A3F D770 1120FF          10      LD  DE,KBUF
000A42 D773 E1              10      POP HL
000A43 D774 E5              11      PUSH    HL
000A44 D775 0E00             7      LD  C,0
000A46 D777 3004            12      JR  NC,SAX0
000A48 D779 23               6      INC HL
000A49 D77A 23               6      INC HL
000A4A D77B 1808            12      JR  SAX4
       D77D                     SAX0:
000A4C D77D 46               7      LD  B,(HL)
000A4D D77E 23               6      INC HL
       D77F                     SAX1:
000A4E D77F 23               6      INC HL
000A4F D780 1A               7      LD  A,(DE)
000A50 D781 13               6      INC DE
000A51 D782 B7               4      OR  A
000A52 D783 2004            12      JR  NZ,SAX2
       D785                     SAX4:
000A54 D785 360D            10      LD  (HL),00DH
000A56 D787 1804            12      JR  SAX3
       D789                     SAX2:
000A58 D789 77               7      LD  (HL),A
000A59 D78A 0C               4      INC C
000A5A D78B 10F2            13      DJNZ    SAX1
       D78D                     SAX3:
000A5C D78D D1              10      POP DE
000A5D D78E 79               4      LD  A,C
000A5E D78F 13               6      INC DE
000A5F D790 12               7      LD  (DE),A
000A60 D791 1B               6      DEC DE
000A61 D792 E1              10      POP HL
000A62 D793 C1              10      POP BC
000A63 D794 A7               4      AND A
000A64 D795 C9              10      RET
                                
       D796                     _SYS0B:     ;(BDOS)コンソール状態のチェック
000A65 D796 CD29D7          17      CALL    BREAK
000A68 D799 AF               4      XOR A
000A69 D79A 3293DA          13      LD  (SKIP_KEYWAIT),A
000A6C D79D 3A92F0          13      LD  A,(_KEYD)
000A6F D7A0 B7               4      OR  A
000A70 D7A1 C8              11      RET Z
       D7A2                     CONSTX:
000A71 D7A2 CDDFF0          17      CALL    _FFLUSH
000A74 D7A5 CDC6DA          17      CALL    CHKEY
000A77 D7A8 C6FF             7      ADD A,0FFH
000A79 D7AA 9F               4      SBC A,A
000A7A D7AB C9              10      RET
                                
       D7AC                     _SYS2A:     ;(BDOS)日付の獲得
000A7B D7AC AF               4      XOR A
000A7C D7AD 57               4      LD  D,A
000A7D D7AE 5F               4      LD  E,A
000A7E D7AF 67               4      LD  H,A
000A7F D7B0 6F               4      LD  L,A
000A80 D7B1 C9              10      RET
                                
       D7B2                     _SYS2C:     ;(BDOS)時刻の獲得
000A81 D7B2 AF               4      XOR A
000A82 D7B3 57               4      LD  D,A
000A83 D7B4 5F               4      LD  E,A
000A84 D7B5 67               4      LD  H,A
000A85 D7B6 6F               4      LD  L,A
000A86 D7B7 C9              10      RET
                                
       D7B8                     ESC1:
000A87 D7B8 7B               4      LD  A,E
000A88 D7B9 FE41             7      CP  'A'
000A8A D7BB CAB0D8          10      JP  Z,CTRL1E
000A8D D7BE FE42             7      CP  'B'
000A8F D7C0 CAC2D9          10      JP  Z,CTRL1F
000A92 D7C3 FE43             7      CP  'C'
000A94 D7C5 CA83D8          10      JP  Z,CTRL1C
000A97 D7C8 FE44             7      CP  'D'
000A99 D7CA CAA7D8          10      JP  Z,CTRL1D
000A9C D7CD FE45             7      CP  'E'
000A9E D7CF 2802            12      JR  Z,CT0CX
000AA0 D7D1 FE6A             7      CP  'j'
       D7D3                     CT0CX:
000AA2 D7D3 CAA7D9          10      JP  Z,CTRL0C
000AA5 D7D6 FE48             7      CP  'H'
000AA7 D7D8 CA24D9          10      JP  Z,CTRL0B
000AAA D7DB FE4A             7      CP  'J'
000AAC D7DD CAAAD9          10      JP  Z,CTRL06
000AAF D7E0 FE4B             7      CP  'K'
000AB1 D7E2 CAF6D8          10      JP  Z,CTRL05
000AB4 D7E5 FE4C             7      CP  'L'
000AB6 D7E7 CAD4D9          10      JP  Z,CTRL0E
000AB9 D7EA FE54             7      CP  'T'
000ABB D7EC CAF6D8          10      JP  Z,CTRL05
000ABE D7EF FE78             7      CP  'x'
000AC0 D7F1 2804            12      JR  Z,ESC1X
000AC2 D7F3 FE79             7      CP  'y'
000AC4 D7F5 2002            12      JR  NZ,ESC1Y
       D7F7                     ESC1X:
000AC6 D7F7 3601            10      LD  (HL),1
       D7F9                     ESC1Y:
000AC8 D7F9 FE3D             7      CP  '='
000ACA D7FB 2804            12      JR  Z,ESC1W
000ACC D7FD FE59             7      CP  'Y'
000ACE D7FF 2002            12      JR  NZ,ESC1Z
       D801                     ESC1W:
000AD0 D801 3602            10      LD  (HL),2
       D803                     ESC1Z:
000AD2 D803 FE20             7      CP  020H
000AD4 D805 3802            12      JR  C,ESC1C
000AD6 D807 87               4      ADD A,A
000AD7 D808 D0              11      RET NC
       D809                     ESC1C:
000AD8 D809 E1              10      POP HL
000AD9 D80A 1832            12      JR  ANK
                                
       D80C                     ESC:
000ADB D80C 216FD8          10      LD  HL,PRINTE5
000ADE D80F E5              11      PUSH    HL
000ADF D810 2132D8          10      LD  HL,ESCFLG
000AE2 D813 3600            10      LD  (HL),0
000AE4 D815 3D               4      DEC A
000AE5 D816 28A0            12      JR  Z,ESC1
000AE7 D818 3D               4      DEC A
000AE8 D819 2009            12      JR  NZ,ESC2
000AEA D81B 3603            10      LD  (HL),3
000AEC D81D 7B               4      LD  A,E
000AED D81E D620             7      SUB 020H
000AEF D820 3227D8          13      LD  (ESCYP+1),A
000AF2 D823 C9              10      RET
       D824                     ESC2:
000AF3 D824 3D               4      DEC A
000AF4 D825 C0              11      RET NZ
000AF5 D826 2600             7  ESCYP:  LD  H,0
000AF7 D828 7B               4      LD  A,E
000AF8 D829 D620             7      SUB 020H
000AFA D82B 6F               4      LD  L,A
000AFB D82C C3D6F0          10      JP  _LOC
                                
       D82F                     PRINT:
000AFE D82F C5              11      PUSH    BC
000AFF D830 E5              11      PUSH    HL
000B00 D831 3E00             7      LD  A,000H      ;自己書き換え
       D832                     ESCFLG  EQU $-1
000B02 D833 B7               4      OR  A
000B03 D834 20D6            12      JR  NZ,ESC
                                
000B05 D836 3E1F             7      LD  A,01FH
000B07 D838 BB               4      CP  E
000B08 D839 3038            12      JR  NC,CTRL
       D83B                     INSFLG  EQU $
000B0A D83B 017CD9          10      LD  BC,INSERT   ;自己書き換え
       D83E                     ANK:
000B0D D83E 3A96F0          13      LD  A,(_COLORF)
000B10 D841 4F               4      LD  C,A
000B11 D842 7B               4      LD  A,E
000B12 D843 FE61             7      CP  'a'     ;英小文字
000B14 D845 3806            12      JR  C,PRT1
000B16 D847 FE7B             7      CP  'z'+1
000B18 D849 3002            12      JR  NC,PRT1
000B1A D84B CBF9             8      SET 7,C
       D84D                     PRT1:
000B1C D84D FE86             7      CP  $86     ;ひらがな1(を－そ)
000B1E D84F 3806            12      JR  C,PRT2
000B20 D851 FEA0             7      CP  $A0
000B22 D853 3002            12      JR  NC,PRT2
000B24 D855 CBF9             8      SET 7,C
       D857                     PRT2:
000B26 D857 FEE0             7      CP  $E0     ;ひらがな2(たーん)
000B28 D859 3802            12      JR  C,PRT3
000B2A D85B CBF9             8      SET 7,C
       D85D                     PRT3:
000B2C D85D 2A8EF0          16      LD  HL,(_TXADR)
000B2F D860 7C               4      LD  A,H
000B30 D861 C6D0             7      ADD A,0D0H
000B32 D863 67               4      LD  H,A
000B33 D864 42               4      LD  B,D
000B34 D865 16EE             7      LD  D,CD_TABLE/256
000B36 D867 1A               7      LD  A,(DE)
000B37 D868 50               4      LD  D,B
000B38 D869 CD45CF          17      CALL    IO_PRINT
000B3B D86C CD83D8          17      CALL    CTRL1C
       D86F                     PRINTE5:
000B3E D86F E1              10      POP HL
000B3F D870 C1              10      POP BC
000B40 D871 AF               4      XOR A
000B41 D872 C9              10      RET
                                
       D873                     CTRL:
000B42 D873 7B               4      LD  A,E
000B43 D874 87               4      ADD A,A
000B44 D875 F680             7      OR  080H
000B46 D877 6F               4      LD  L,A
000B47 D878 26F1             7      LD  H,CTRLTB/256
000B49 D87A 7E               7      LD  A,(HL)
000B4A D87B 2C               4      INC L
000B4B D87C 66               7      LD  H,(HL)
000B4C D87D 6F               4      LD  L,A
000B4D D87E CD0F00          17      CALL    JP_HL
000B50 D881 18EC            12      JR  PRINTE5
                                
       D883                     CTRL1C:
000B52 D883 ED4B8EF0        20      LD  BC,(_TXADR)
000B56 D887 03               6      INC BC
       D888                     PRINTE3:
000B57 D888 2118FC          10      LD  HL,0-WIDTH*LINE
000B5A D88B A7               4      AND A
000B5B D88C ED4A            15      ADC HL,BC
       D88E                     PRINTE8:
000B5D D88E 2805            12      JR  Z,PRINT2
000B5F D890 ED438EF0        20      LD  (_TXADR),BC
       D894                     CTRL00:
000B63 D894 C9              10      RET
                                
       D895                     PRINT2:
000B64 D895 CDDAD9          17      CALL    SCR
000B67 D898 21D8FF          10      LD  HL,0-WIDTH
000B6A D89B 09              11      ADD HL,BC
       D89C                     SET_TXADR_HL:
000B6B D89C 228EF0          16      LD  (_TXADR),HL
000B6E D89F C9              10      RET
                                
       D8A0                     CTRL08:
000B6F D8A0 3A3BD8          13      LD  A,(INSFLG)
000B72 D8A3 FECD             7      CP  0CDH        ;CALL ????
000B74 D8A5 2823            12      JR  Z,CTRL02
       D8A7                     CTRL1D:
000B76 D8A7 2A8EF0          16      LD  HL,(_TXADR)
000B79 D8AA 7C               4      LD  A,H
000B7A D8AB B5               4      OR  L
000B7B D8AC C8              11      RET Z
000B7C D8AD 2B               6      DEC HL
000B7D D8AE 18EC            12      JR  SET_TXADR_HL
                                
       D8B0                     CTRL1E:
000B7F D8B0 ED4B8EF0        20      LD  BC,(_TXADR)
000B83 D8B4 21D8FF          10      LD  HL,0-WIDTH
000B86 D8B7 09              11      ADD HL,BC
000B87 D8B8 D0              11      RET NC
000B88 D8B9 18E1            12      JR  SET_TXADR_HL
                                
       D8BB                     CTRL09:
000B8A D8BB ED4B8EF0        20      LD  BC,(_TXADR)
000B8E D8BF 79               4      LD  A,C
000B8F D8C0 E6F8             7      AND 0F8H
000B91 D8C2 C608             7      ADD A,8
000B93 D8C4 4F               4      LD  C,A
000B94 D8C5 88               4      ADC A,B
000B95 D8C6 91               4      SUB C
000B96 D8C7 47               4      LD  B,A
000B97 D8C8 18BE            12      JR  PRINTE3
                                
       D8CA                     CTRL02:
000B99 D8CA CDA7D8          17      CALL    CTRL1D
000B9C D8CD C8              11      RET Z
000B9D D8CE D5              11      PUSH    DE
000B9E D8CF CDD3F0          17      CALL    _POS
000BA1 D8D2 54               4      LD  D,H
000BA2 D8D3 3E28             7      LD  A,WIDTH
000BA4 D8D5 95               4      SUB L
000BA5 D8D6 4F               4      LD  C,A
000BA6 D8D7 0D               4      DEC C
000BA7 D8D8 06D0             7      LD  B,0D0H
000BA9 D8DA 2A8EF0          16      LD  HL,(_TXADR)
000BAC D8DD 09              11      ADD HL,BC
000BAD D8DE 47               4      LD  B,A
                                
000BAE D8DF 3A98D9          13      LD  A,(MULINE)
000BB1 D8E2 BA               4      CP  D
000BB2 D8E3 2007            12      JR  NZ,C02X1
000BB4 D8E5 112800          10      LD  DE,WIDTH
000BB7 D8E8 19              11      ADD HL,DE
000BB8 D8E9 78               4      LD  A,B
000BB9 D8EA 83               4      ADD A,E
000BBA D8EB 47               4      LD  B,A
       D8EC                     C02X1:
000BBB D8EC 3A96F0          13      LD  A,(_COLORF) ;C:Color
000BBE D8EF 4F               4      LD  C,A
000BBF D8F0 AF               4      XOR A       ;A:Text
000BC0 D8F1 CD8CCF          17      CALL    IO_BS
000BC3 D8F4 D1              10      POP DE
000BC4 D8F5 C9              10      RET
                                
       D8F6                     CTRL05:
000BC5 D8F6 CDD3F0          17      CALL    _POS
000BC8 D8F9 3E28             7      LD  A,WIDTH
000BCA D8FB 95               4      SUB L
000BCB D8FC 47               4      LD  B,A
       D8FD                     C08X1:
000BCC D8FD 2A8EF0          16      LD  HL,(_TXADR)
000BCF D900 7C               4      LD  A,H
000BD0 D901 C6D0             7      ADD A,0D0H
000BD2 D903 67               4      LD  H,A
       D904                     CLLINE:
000BD3 D904 3A96F0          13      LD  A,(_COLORF)
000BD6 D907 4F               4      LD  C,A
000BD7 D908 AF               4      XOR A
000BD8 D909 C36FCF          10      JP  IO_CLLINE
                                
       D90C                     CTRL0D:
000BDB D90C CDD3F0          17      CALL    _POS
000BDE D90F 2E00             7      LD  L,0
       D911                     LOC:
000BE0 D911 C5              11      PUSH    BC
000BE1 D912 E5              11      PUSH    HL
000BE2 D913 CD31D9          17      CALL    LOC1
000BE5 D916 228EF0          16      LD  (_TXADR),HL
000BE8 D919 E1              10      POP HL
000BE9 D91A C1              10      POP BC
000BEA D91B C9              10      RET
                                
       D91C                     CTRL12:
000BEB D91C 213BD8          10      LD  HL,INSFLG
000BEE D91F 7E               7      LD  A,(HL)
000BEF D920 EECC             7      XOR 0CCH        ;CD:CALL ???? 1:LD BC,????
000BF1 D922 77               7      LD  (HL),A
000BF2 D923 C9              10      RET
                                
       D924                     CTRL0B:
000BF3 D924 210000          10      LD  HL,0
000BF6 D927 228EF0          16      LD  (_TXADR),HL
000BF9 D92A C9              10      RET
                                
       D92B                     CTRL1B:
000BFA D92B 3E01             7      LD  A,1
000BFC D92D 3232D8          13      LD  (ESCFLG),A
000BFF D930 C9              10      RET
                                
       D931                     LOC1:
000C00 D931 D5              11      PUSH    DE
000C01 D932 4D               4      LD  C,L
000C02 D933 0608             7      LD  B,8
000C04 D935 5C               4      LD  E,H
000C05 D936 210028          10      LD  HL,WIDTH*256
000C08 D939 55               4      LD  D,L ;L=0
       D93A                     LOC2:
000C09 D93A 29              11      ADD HL,HL
000C0A D93B 3001            12      JR  NC,LOC3
000C0C D93D 19              11      ADD HL,DE
       D93E                     LOC3:
000C0D D93E 10FA            13      DJNZ    LOC2
000C0F D940 09              11      ADD HL,BC
000C10 D941 D1              10      POP DE
000C11 D942 C9              10      RET
                                
       D943                     CONOUT1:
                                ;   CALL    CURSOR
000C12 D943 59               4      LD  E,C
000C13 D944 CDCDF0          17      CALL    _PRINT
000C16 D947 7B               4      LD  A,E
000C17 D948 FE0A             7      CP  00AH
000C19 D94A 2006            12      JR  NZ,CURSOR
000C1B D94C CD0CD9          17      CALL    CTRL0D
000C1E D94F CDF6D8          17      CALL    CTRL05
       D952                     CURSOR:
000C21 D952 C9              10      RET
                                
       D953                     CTRL07:
000C22 D953 06E0             7      LD  B,0E0H
000C24 D955 2162F0          10      LD  HL,BEEPD+1
       D958                     C07X0:
000C27 D958 4E               7      LD  C,(HL)
000C28 D959 23               6      INC HL
000C29 D95A 7E               7      LD  A,(HL)
000C2A D95B 23               6      INC HL
000C2B D95C CD3DCF          17      CALL    WRMMIO_BC
000C2E D95F 7D               4      LD  A,L
000C2F D960 FE6A             7      CP  (BEEPD+1+M7BEEPE-M7BEEPD)&255
000C31 D962 20F4            12      JR  NZ,C07X0
000C33 D964 0610             7      LD  B,16
       D966                     C07X1:
000C35 D966 CD1BCF          17      CALL    RD556VSYNC
000C38 D969 87               4      ADD A,A
000C39 D96A 30FA            12      JR  NC,C07X1
       D96C                     C07X2:
000C3B D96C CD1BCF          17      CALL    RD556VSYNC
000C3E D96F 87               4      ADD A,A
000C3F D970 38FA            12      JR  C,C07X2
000C41 D972 10F2            13      DJNZ    C07X1
                                
000C43 D974 AF               4      XOR A
000C44 D975 2108E0          10      LD  HL,0E008H
000C47 D978 CD2DCF          17      CALL    WRMMIO
000C4A D97B C9              10      RET
                                
       D97C                     INSERT:
000C4B D97C D5              11      PUSH    DE
000C4C D97D CDD3F0          17      CALL    _POS
000C4F D980 54               4      LD  D,H
000C50 D981 3E28             7      LD  A,WIDTH
000C52 D983 95               4      SUB L
000C53 D984 47               4      LD  B,A
000C54 D985 2A8EF0          16      LD  HL,(_TXADR)
000C57 D988 7C               4      LD  A,H
000C58 D989 C6D0             7      ADD A,0D0H
000C5A D98B 67               4      LD  H,A
000C5B D98C 3A96F0          13      LD  A,(_COLORF) ;C:Color
000C5E D98F 4F               4      LD  C,A
000C5F D990 AF               4      XOR A       ;A:Text
000C60 D991 CD7FCF          17      CALL    IO_INS
000C63 D994 B7               4      OR  A
000C64 D995 2005            12      JR  NZ,INS1
       D998                     MULINE  EQU $+1
000C66 D997 3EFF             7      LD  A,-1
000C68 D999 92               4      SUB D
000C69 D99A 2009            12      JR  NZ,INS2
       D99C                     INS1:
000C6B D99C 0628             7      LD  B,WIDTH
000C6D D99E CD7FCF          17      CALL    IO_INS
000C70 D9A1 7A               4      LD  A,D
000C71 D9A2 3298D9          13      LD  (MULINE),A
       D9A5                     INS2:
000C74 D9A5 D1              10      POP DE
000C75 D9A6 C9              10      RET
                                
       D9A7                     CTRL0C:
000C76 D9A7 CD24D9          17      CALL    CTRL0B
       D9AA                     CTRL06:
000C79 D9AA D5              11      PUSH    DE
000C7A D9AB E5              11      PUSH    HL
000C7B D9AC ED5B8EF0        20      LD  DE,(_TXADR)
000C7F D9B0 3A96F0          13      LD  A,(_COLORF)
000C82 D9B3 325CCF          13      LD  (ICSMC),A
000C85 D9B6 C350CF          10      JP  IO_CLR
                                
       D9B9                     CTRL04:
000C88 D9B9 CDD3F0          17      CALL    _POS
000C8B D9BC 7D               4      LD  A,L
000C8C D9BD B7               4      OR  A
000C8D D9BE C8              11      RET Z
       D9BF                     CTRL03:
000C8E D9BF CD0CD9          17      CALL    CTRL0D
       D9C2                     CTRL0A:
       D9C2                     CTRL1F:
000C91 D9C2 2A8EF0          16      LD  HL,(_TXADR)
000C94 D9C5 012800          10      LD  BC,WIDTH
000C97 D9C8 09              11      ADD HL,BC
000C98 D9C9 44               4      LD  B,H
000C99 D9CA 4D               4      LD  C,L
000C9A D9CB 2118FC          10      LD  HL,0-WIDTH*LINE
000C9D D9CE 09              11      ADD HL,BC
000C9E D9CF 3F               4      CCF
000C9F D9D0 9F               4      SBC A,A
000CA0 D9D1 C38ED8          10      JP  PRINTE8
                                
       D9D4                     CTRL0E:
000CA3 D9D4 CDD3F0          17      CALL    _POS
000CA6 D9D7 7C               4      LD  A,H
000CA7 D9D8 1804            12      JR  SCR1
       D9DA                     SCR:
000CA9 D9DA 3A97F0          13      LD  A,(_LINE)
000CAC D9DD 3D               4      DEC A
       D9DE                     SCR1:
000CAD D9DE C5              11      PUSH    BC
000CAE D9DF D5              11      PUSH    DE
000CAF D9E0 E5              11      PUSH    HL
000CB0 D9E1 1100D0          10      LD  DE,0D000H
000CB3 D9E4 2128D0          10      LD  HL,0D000H+WIDTH
                                
000CB6 D9E7 47               4      LD  B,A
000CB7 D9E8 B7               4      OR  A
000CB8 D9E9 C3A4CF          10      JP  IO_SCRUP
                                
       D9EC                     POS:
000CBB D9EC 2A8EF0          16      LD  HL,(_TXADR)
000CBE D9EF C5              11      PUSH    BC
000CBF D9F0 01D8FF          10      LD  BC,0-WIDTH
000CC2 D9F3 AF               4      XOR A
       D9F4                     POS1:
000CC3 D9F4 09              11      ADD HL,BC
000CC4 D9F5 3C               4      INC A
000CC5 D9F6 38FC            12      JR  C,POS1
000CC7 D9F8 ED42            15      SBC HL,BC
000CC9 D9FA 3D               4      DEC A
000CCA D9FB 67               4      LD  H,A
000CCB D9FC C1              10      POP BC
000CCC D9FD A7               4      AND A
000CCD D9FE C9              10      RET
                                
       D9FF                     GETL:
000CCE D9FF CDD3F0          17      CALL    _POS
000CD1 DA02 E5              11      PUSH    HL
000CD2 DA03 3ECD             7      LD  A,0CDH      ;CALL ????
000CD4 DA05 323BD8          13      LD  (INSFLG),A
       DA08                     GETL1:
000CD7 DA08 CD24D7          17      CALL    _SYS08
000CDA DA0B FE09             7      CP  9
000CDC DA0D 2008            12      JR  NZ,GETL1V
000CDE DA0F 2120FF          10      LD  HL,KBUF
000CE1 DA12 CD87D4          17      CALL    MSX
000CE4 DA15 18F1            12      JR  GETL1
       DA17                     GETL1V:
000CE6 DA17 5F               4      LD  E,A
000CE7 DA18 CDD3F0          17      CALL    _POS
000CEA DA1B CDCDF0          17      CALL    _PRINT
000CED DA1E 7B               4      LD  A,E
000CEE DA1F FE20             7      CP  $20
000CF0 DA21 3809            12      JR  C,GETL1V1
000CF2 DA23 7D               4      LD  A,L
000CF3 DA24 FE27             7      CP  WIDTH-1
000CF5 DA26 2004            12      JR  NZ,GETL1V1
000CF7 DA28 7C               4      LD  A,H
000CF8 DA29 3298D9          13      LD  (MULINE),A
       DA2C                     GETL1V1:
000CFB DA2C 7B               4      LD  A,E
000CFC DA2D FE0D             7      CP  00DH
000CFE DA2F 20D7            12      JR  NZ,GETL1
000D00 DA31 3E01             7      LD  A,1     ;LD BC,????
000D02 DA33 323BD8          13      LD  (INSFLG),A
000D05 DA36 1120FF          10      LD  DE,KBUF
000D08 DA39 0628             7      LD  B,WIDTH
000D0A DA3B CD24D3          17      CALL    ZERO_MEMORY_DE
                                
000D0D DA3E D1              10      POP DE
000D0E DA3F CDD3F0          17      CALL    _POS
000D11 DA42 6B               4      LD  L,E
000D12 DA43 3E28             7      LD  A,WIDTH
000D14 DA45 95               4      SUB L
000D15 DA46 57               4      LD  D,A
                                
000D16 DA47 3A98D9          13      LD  A,(MULINE)
000D19 DA4A 94               4      SUB H
000D1A DA4B 2806            12      JR  Z,GL2X
000D1C DA4D 3C               4      INC A
000D1D DA4E 200C            12      JR  NZ,GL3X
000D1F DA50 25               4      DEC H
000D20 DA51 1805            12      JR  GL4X
       DA53                     GL2X:
000D22 DA53 3E1F             7      LD  A,$1F
000D24 DA55 CD0ED7          17      CALL    MSG_A
       DA58                     GL4X:
000D27 DA58 7A               4      LD  A,D
000D28 DA59 C628             7      ADD A,WIDTH
000D2A DA5B 57               4      LD  D,A
       DA5C                     GL3X:
000D2B DA5C CD31D9          17      CALL    LOC1
000D2E DA5F 4D               4      LD  C,L
000D2F DA60 7C               4      LD  A,H
000D30 DA61 C6D0             7      ADD A,0D0H
000D32 DA63 47               4      LD  B,A
000D33 DA64 5A               4      LD  E,D
000D34 DA65 2120FF          10      LD  HL,KBUF
       DA68                     GETL2:
000D37 DA68 CDD0F0          17      CALL    _SCRN
000D3A DA6B 03               6      INC BC
000D3B DA6C 77               7      LD  (HL),A
000D3C DA6D 23               6      INC HL
000D3D DA6E 1D               4      DEC E
000D3E DA6F 20F7            12      JR  NZ,GETL2
       DA71                     GETL3:
000D40 DA71 2B               6      DEC HL
000D41 DA72 7E               7      LD  A,(HL)
000D42 DA73 FE21             7      CP  021H
000D44 DA75 D0              11      RET NC
000D45 DA76 3600            10      LD  (HL),0
000D47 DA78 15               4      DEC D
000D48 DA79 20F6            12      JR  NZ,GETL3
000D4A DA7B C9              10      RET
                                
       DA7C                     INKEYB:
000D4B DA7C C1              10      POP BC
000D4C DA7D CB47             8      BIT 0,A
000D4E DA7F 3E08             7      LD  A,8
000D50 DA81 2002            12      JR  NZ,INKEYD
000D52 DA83 3E03             7      LD  A,3
       DA85                     INKEYD:
000D54 DA85 3292F0          13      LD  (_KEYD),A
000D57 DA88 B7               4      OR  A
000D58 DA89 C9              10      RET
       DA8A                     INKEY:
000D59 DA8A E5              11      PUSH    HL
       DA8B                     GETKEY:
000D5A DA8B 3A92F0          13      LD  A,(_KEYD)
000D5D DA8E B7               4      OR  A
000D5E DA8F 6F               4      LD  L,A
000D5F DA90 2610             7  GKSMC:  LD  H,16
       DA92                     GETKEY1:
000D61 DA92 3E01             7      LD  A,1
       DA93                     SKIP_KEYWAIT:   EQU $-1
000D63 DA94 B7               4      OR  A
000D64 DA95 C4C6DA          17      CALL    NZ,CHKEY    ;キーを離すまで待つ
000D67 DA98 281E            12      JR  Z,GETKEY2
000D69 DA9A BD               4      CP  L
000D6A DA9B 201B            12      JR  NZ,GETKEY2
000D6C DA9D CD1BCF          17      CALL    RD556VSYNC
000D6F DAA0 87               4      ADD A,A
000D70 DAA1 30EF            12      JR  NC,GETKEY1
       DAA3                     GETKEY1X:
000D72 DAA3 CDC6DA          17      CALL    CHKEY       ;キーを離すまで待つ
000D75 DAA6 2810            12      JR  Z,GETKEY2
000D77 DAA8 BD               4      CP  L
000D78 DAA9 200D            12      JR  NZ,GETKEY2
000D7A DAAB CD1BCF          17      CALL    RD556VSYNC
000D7D DAAE 87               4      ADD A,A
000D7E DAAF 38F2            12      JR  C,GETKEY1X
000D80 DAB1 25               4      DEC H
000D81 DAB2 20DE            12      JR  NZ,GETKEY1
000D83 DAB4 3E01             7      LD  A,1
000D85 DAB6 1805            12      JR  GETKEY3
       DAB8                     GETKEY2:
000D87 DAB8 3E10             7      LD  A,16
000D89 DABA 3293DA          13      LD  (SKIP_KEYWAIT),A
       DABD                     GETKEY3:
000D8C DABD 3291DA          13      LD  (GKSMC+1),A
000D8F DAC0 3A92F0          13      LD  A,(_KEYD)
000D92 DAC3 B7               4      OR  A
000D93 DAC4 E1              10      POP HL
000D94 DAC5 C0              11      RET NZ
       DAC6                     CHKEY:
000D95 DAC6 C5              11      PUSH    BC
000D96 DAC7 3E08             7      LD  A,8
000D98 DAC9 CD0ECF          17      CALL    RDKEYDATA
000D9B DACC 3293F0          13      LD  (_KEYD+1),A
000D9E DACF CB7F             8      BIT 7,A
000DA0 DAD1 28A9            12      JR  Z,INKEYB
000DA2 DAD3 E5              11      PUSH    HL
000DA3 DAD4 0E07             7      LD  C,7
000DA5 DAD6 2140ED          10      LD  HL,KEY_TABLE
000DA8 DAD9 CB47             8      BIT 0,A
000DAA DADB 2003            12      JR  NZ,CHKEY0
000DAC DADD 2180ED          10      LD  HL,SHIFT_TABLE
       DAE0                     CHKEY0:
000DAF DAE0 CB77             8      BIT 6,A
000DB1 DAE2 2003            12      JR  NZ,CHKEY1
000DB3 DAE4 21C0ED          10      LD  HL,CTRL_TABLE
       DAE7                     CHKEY1:
000DB6 DAE7 79               4      LD  A,C
000DB7 DAE8 CD0ECF          17      CALL    RDKEYDATA
000DBA DAEB 0608             7      LD  B,8
       DAED                     CHKEY2:
000DBC DAED 87               4      ADD A,A
000DBD DAEE 3009            12      JR  NC,CHKEY3
000DBF DAF0 23               6      INC HL
000DC0 DAF1 10FA            13      DJNZ    CHKEY2
000DC2 DAF3 0D               4      DEC C
000DC3 DAF4 79               4      LD  A,C
000DC4 DAF5 3C               4      INC A
000DC5 DAF6 20EF            12      JR  NZ,CHKEY1
000DC7 DAF8 06                      DB  $06     ;LD B,?? 次の1バイトを飛ばす
       DAF9                     CHKEY3:
000DC8 DAF9 7E               7      LD  A,(HL)
000DC9 DAFA E1              10      POP HL
000DCA DAFB C1              10      POP BC
000DCB DAFC 1887            12      JR  INKEYD
                                
       DAFE                     SCRN:
000DCD DAFE E5              11      PUSH    HL
000DCE DAFF CD35CF          17      CALL    RDMMIO_BC
000DD1 DB02 6F               4      LD  L,A
000DD2 DB03 26EF             7      LD  H,DC_TABLE/256
000DD4 DB05 7E               7      LD  A,(HL)
000DD5 DB06 FE41             7      CP  'A'     ;英小文字チェック
000DD7 DB08 380E            12      JR  C,SCRN1
000DD9 DB0A FE5B             7      CP  'Z'+1
000DDB DB0C DC1ADB          17      CALL    C,SCRNC
000DDE DB0F FEA6             7      CP  $A6     ;ひらがなチェック
000DE0 DB11 3805            12      JR  C,SCRN1
000DE2 DB13 FEE0             7      CP  $E0
000DE4 DB15 DC1ADB          17      CALL    C,SCRNC
       DB18                     SCRN1:
000DE7 DB18 E1              10      POP HL
000DE8 DB19 C9              10      RET
                                
       DB1A                     SCRNC:
000DE9 DB1A 6F               4      LD  L,A
000DEA DB1B 60               4      LD  H,B
000DEB DB1C CBD8             8      SET 3,B
000DED DB1E CD35CF          17      CALL    RDMMIO_BC
000DF0 DB21 44               4      LD  B,H
000DF1 DB22 CB7F             8      BIT 7,A
000DF3 DB24 7D               4      LD  A,L
000DF4 DB25 C8              11      RET Z
000DF5 DB26 FE5B             7      CP  'Z'+1
000DF7 DB28 3804            12      JR  C,SCRNC_ADD
000DF9 DB2A FEC0             7      CP  $C0
000DFB DB2C 3803            12      JR  C,SCRNC_SUB
       DB2E                     SCRNC_ADD:
000DFD DB2E C620             7      ADD A,$20
000DFF DB30 C9              10      RET
       DB31                     SCRNC_SUB:
000E00 DB31 D620             7      SUB $20
000E02 DB33 C9              10      RET
[EOF:M7IO.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE.ASM"
                                
                                ;   LSX-Dodgers FILE
                                
       DB34                     FILEC:
000E03 DB34 CD3FDB          17      CALL    FILE
       DB37                     FILEC2:
000E06 DB37 3A15F0          13      LD  A,(FDRV+1)
000E09 DB3A FE20             7      CP  020H
000E0B DB3C C8              11      RET Z
000E0C DB3D 1839            12      JR  SETDIR1
                                
       DB3F                     FILE:
000E0E DB3F AF               4      XOR A
000E0F DB40 3214F0          13      LD  (FDRV),A
000E12 DB43 67               4      LD  H,A
000E13 DB44 6F               4      LD  L,A
000E14 DB45 2222F0          16      LD  (FDRV+14),HL
000E17 DB48 CD16DC          17      CALL    SPCUT
000E1A DB4B CDFBDB          17      CALL    CCHK3
000E1D DB4E 2812            12      JR  Z,DEVI1
000E1F DB50 13               6      INC DE
000E20 DB51 1A               7      LD  A,(DE)
000E21 DB52 1B               6      DEC DE
000E22 DB53 FE3A             7      CP  ':'
000E24 DB55 200B            12      JR  NZ,DEVI1
000E26 DB57 1A               7      LD  A,(DE)      ;DRIVE
000E27 DB58 CD56DE          17      CALL    CAP
000E2A DB5B D640             7      SUB '@'
000E2C DB5D 13               6      INC DE
000E2D DB5E 13               6      INC DE
000E2E DB5F 3214F0          13      LD  (FDRV),A
       DB62                     DEVI1:
000E31 DB62 1A               7      LD  A,(DE)
000E32 DB63 D65C             7      SUB 05CH        ;\
000E34 DB65 2009            12      JR  NZ,NOROOT
000E36 DB67 6F               4      LD  L,A     ;A=0でH=0のはずなのでHL=0
000E37 DB68 222EF0          16      LD  (FDRV+26),HL
000E3A DB6B 2C               4      INC L
000E3B DB6C 2222F0          16      LD  (FDRV+14),HL
000E3E DB6F 13               6      INC DE
       DB70                     NOROOT:
                                
       DB70                     SETDIR:
000E3F DB70 CD9CDB          17      CALL    FILED
000E42 DB73 1A               7      LD  A,(DE)
000E43 DB74 FE5C             7      CP  05CH        ;\
000E45 DB76 C0              11      RET NZ
000E46 DB77 13               6      INC DE
       DB78                     SETDIR1:
000E47 DB78 3E10             7      LD  A,010H      ;Directory
000E49 DB7A 3221F0          13      LD  (FDRV+13),A
000E4C DB7D D5              11      PUSH    DE
000E4D DB7E 1114F0          10      LD  DE,FDRV
000E50 DB81 2A1EF1          16      LD  HL,(STABLE+2*00FH)
000E53 DB84 CD0F00          17      CALL    JP_HL
000E56 DB87 D1              10      POP DE
000E57 DB88 B7               4      OR  A
000E58 DB89 C0              11      RET NZ
                                
000E59 DB8A 3A21F0          13      LD  A,(FDRV+13)
000E5C DB8D CB67             8      BIT 4,A
000E5E DB8F C8              11      RET Z
                                
000E5F DB90 CDE3DB          17      CALL    FILEI
000E62 DB93 2A2EF0          16      LD  HL,(FDRV+26)
000E65 DB96 23               6      INC HL
000E66 DB97 2222F0          16      LD  (FDRV+14),HL
000E69 DB9A 18D4            12      JR  SETDIR
                                
       DB9C                     FILED:
000E6B DB9C CDE3DB          17      CALL    FILEI
000E6E DB9F 2115F0          10      LD  HL,FNAME
                                
000E71 DBA2 0608             7      LD  B,8
       DBA4                     FILE2:
000E73 DBA4 CDF0DB          17      CALL    CCHKF
000E76 DBA7 C8              11      RET Z
000E77 DBA8 FE2A             7      CP  '*'
000E79 DBAA 282E            12      JR  Z,FILE9
000E7B DBAC FE2E             7      CP  '.'
000E7D DBAE 280C            12      JR  Z,FILE4
000E7F DBB0 77               7      LD  (HL),A
000E80 DBB1 23               6      INC HL
000E81 DBB2 10F0            13      DJNZ    FILE2
                                
       DBB4                     FILE3:
000E83 DBB4 CDF0DB          17      CALL    CCHKF
000E86 DBB7 C8              11      RET Z
000E87 DBB8 FE2E             7      CP  '.'
000E89 DBBA 20F8            12      JR  NZ,FILE3
                                
       DBBC                     FILE4:
000E8B DBBC 211DF0          10      LD  HL,FNAME+8
000E8E DBBF 0603             7      LD  B,3
                                
       DBC1                     FILE4L:
000E90 DBC1 CDF0DB          17      CALL    CCHKF
000E93 DBC4 C8              11      RET Z
000E94 DBC5 FE2E             7      CP  '.'
000E96 DBC7 2008            12      JR  NZ,FILE12
000E98 DBC9 3215F0          13      LD  (FNAME),A   ;Parent directory(..)
000E9B DBCC 3216F0          13      LD  (FNAME+1),A
000E9E DBCF 3E20             7      LD  A,020H
       DBD1                     FILE12:
000EA0 DBD1 FE2A             7      CP  '*'
000EA2 DBD3 280A            12      JR  Z,FILE10
000EA4 DBD5 77               7      LD  (HL),A
000EA5 DBD6 23               6      INC HL
000EA6 DBD7 10E8            13      DJNZ    FILE4L
000EA8 DBD9 C9              10      RET
                                
       DBDA                     FILE9:              ;名前の*処理、名前の残りを?で埋める
000EA9 DBDA CDDFDB          17      CALL    FILE10
000EAC DBDD 18D5            12      JR  FILE3
                                
       DBDF                     FILE10:
000EAE DBDF 3E3F             7      LD  A,'?'
000EB0 DBE1 1808            12      JR  FILL_MEMORY
       DBE3                     FILEI:              ;名前＋拡張子をスペースで初期化
000EB2 DBE3 3E20             7      LD  A,020H
000EB4 DBE5 01000B          10      LD  BC,11*256   ;C=0にしておく
000EB7 DBE8 2115F0          10      LD  HL,FNAME
       DBEB                     FILL_MEMORY:            ;HLからBバイトAで埋める
000EBA DBEB 77               7      LD  (HL),A
000EBB DBEC 23               6      INC HL
000EBC DBED 10FC            13      DJNZ    FILL_MEMORY
000EBE DBEF C9              10      RET
                                
       DBF0                     CCHKF:
000EBF DBF0 1A               7      LD  A,(DE)
000EC0 DBF1 CDF8DB          17      CALL    CCHK2
000EC3 DBF4 C8              11      RET Z
000EC4 DBF5 C363DF          10      JP  FKAN
                                
       DBF8                     CCHK2:
000EC7 DBF8 0C               4      INC C
000EC8 DBF9 0D               4      DEC C
000EC9 DBFA C0              11      RET NZ
       DBFB                     CCHK3:              ;ZF=1 で使えない文字
000ECA DBFB FE2B             7      CP  '+'
000ECC DBFD C8              11      RET Z
000ECD DBFE FE2C             7      CP  ','
000ECF DC00 C8              11      RET Z
000ED0 DC01 FE2F             7      CP  '/'
000ED2 DC03 C8              11      RET Z
000ED3 DC04 FE3A             7      CP  ':'
000ED5 DC06 C8              11      RET Z
000ED6 DC07 FE3B             7      CP  ';'
000ED8 DC09 C8              11      RET Z
000ED9 DC0A FE3D             7      CP  '='
000EDB DC0C C8              11      RET Z
000EDC DC0D FE5C             7      CP  05CH    ;\
000EDE DC0F C8              11      RET Z
000EDF DC10 FE20             7      CP  020H
000EE1 DC12 D0              11      RET NC
000EE2 DC13 BF               4      CP  A       ;Z=1
000EE3 DC14 C9              10      RET
                                
       DC15                     SS1:
000EE4 DC15 13               6      INC DE
       DC16                     SPCUT:              ;スペースをカット
000EE5 DC16 1A               7      LD  A,(DE)
000EE6 DC17 FE20             7      CP  020H
000EE8 DC19 28FA            12      JR  Z,SS1
000EEA DC1B C9              10      RET
                                
       DC1C                     SETDRVF:
000EEB DC1C 1114F0          10      LD  DE,FDRV
       DC1F                     SETDRV0:
000EEE DC1F CD28DC          17      CALL    SETDRV
000EF1 DC22 FDE1            14      POP IY
000EF3 DC24 C1              10      POP BC
000EF4 DC25 D1              10      POP DE
000EF5 DC26 E1              10      POP HL
000EF6 DC27 C9              10      RET
                                
       DC28                     SETDRV:
000EF7 DC28 E3              19      EX  (SP),HL     ;HL=RETRN ADDRESS
000EF8 DC29 D5              11      PUSH    DE      ;PUSH HL/DE/BC/IY
000EF9 DC2A C5              11      PUSH    BC
000EFA DC2B 1A               7      LD  A,(DE)
000EFB DC2C D5              11      PUSH    DE
000EFC DC2D FDE3            23      EX  (SP),IY
                                
000EFE DC2F CD36DC          17      CALL    GETDRV
000F01 DC32 CDD9F0          17      CALL    _CHGDRV
                                
000F04 DC35 E9               4      JP  (HL)
                                
       DC36                     GETDRV:
000F05 DC36 CD49DC          17      CALL    GETDRV1
000F08 DC39 3288F0          13      LD  (_DRV),A
000F0B DC3C C9              10      RET
                                
       DC3D                     IS_SAME_DRV_A_DE:
                                ;   A と (DE) が同じドライブか調べる
                                ;   ZF=1ならば同じドライブ
000F0C DC3D CD49DC          17      CALL    GETDRV1
000F0F DC40 C5              11      PUSH    BC
000F10 DC41 4F               4      LD  C,A
000F11 DC42 1A               7      LD  A,(DE)
000F12 DC43 CD49DC          17      CALL    GETDRV1
000F15 DC46 A9               4      XOR C
000F16 DC47 C1              10      POP BC
000F17 DC48 C9              10      RET
       DC49                     GETDRV1:
000F18 DC49 E67F             7      AND 07FH
000F1A DC4B D601             7      SUB 001H
000F1C DC4D D0              11      RET NC
000F1D DC4E 3A87F0          13      LD  A,(_DVSW)   ;Current Drive
000F20 DC51 C9              10      RET
                                
       DC52                     SOPENX:
000F21 DC52 1139F0          10      LD  DE,SFILE
000F24 DC55 FD7E00          19      LD  A,(IY+0)        ;(FCB)ドライブ番号
000F27 DC58 CD3DDC          17      CALL    IS_SAME_DRV_A_DE
000F2A DC5B 2024            12      JR  NZ,SOPEN
000F2C DC5D 13               6      INC DE
000F2D DC5E FDE5            15      PUSH    IY
000F2F DC60 E1              10      POP HL
000F30 DC61 23               6      INC HL
000F31 DC62 CDEEDD          17      CALL    CPFILE
000F34 DC65 201A            12      JR  NZ,SOPEN
                                
000F36 DC67 2AF4F1          16      LD  HL,(SCDIR)
000F39 DC6A FD750E          19      LD  (IY+14),L   ;(FCB)アクセスするディレクトリのクラスタ番号+1
000F3C DC6D FD740F          19      LD  (IY+15),H
                                
000F3F DC70 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
000F42 DC73 229FF0          16      LD  (_FILEN),HL
                                
000F45 DC76 ED5BF6F1        20      LD  DE,(SFBPS)
000F49 DC7A 2139F0          10      LD  HL,SFILE
000F4C DC7D 36FF            10      LD  (HL),0FFH
000F4E DC7F 23               6      INC HL
000F4F DC80 C9              10      RET
       DC81                     SOPEN:
000F50 DC81 2196DD          10      LD  HL,FILESE
       DC84                     SOPENC:
000F53 DC84 22BDDC          16      LD  (OPENPAT),HL
                                
000F56 DC87 CDE2F0          17      CALL    _RDFATX     ;Detect Media
000F59 DC8A 3856            12      JR  C,RDDERR
                                
000F5B DC8C AF               4      XOR A
000F5C DC8D 329FF0          13      LD  (_FILEN),A
000F5F DC90 CD96DE          17      CALL    LDDIRX1     ;A=0で呼び出す
000F62 DC93 2818            12      JR  Z,SDIRX1
                                
000F64 DC95 CD87DD          17      CALL    READ_DIR    ;Sub Directory
000F67 DC98 3808            12      JR  C,SDIRX0
000F69 DC9A 2A7EF1          16      LD  HL,(_DTBUF)
000F6C DC9D 7E               7      LD  A,(HL)
000F6D DC9E FE2E             7      CP  '.'
000F6F DCA0 280F            12      JR  Z,SOPEN1
       DCA2                     SDIRX0:
000F71 DCA2 AF               4      XOR A
000F72 DCA3 32A0F0          13      LD  (_DIRF),A
000F75 DCA6 FD360E01        19      LD  (IY+14),1   ;(FCB)レコードサイズ
000F79 DCAA FD770F          19      LD  (IY+15),A
       DCAD                     SDIRX1:
000F7C DCAD ED5BFCF1        20      LD  DE,(_DIRPS) ;Root Directory
       DCB1                     SOPEN1:
000F80 DCB1 0E20             7      LD  C,32        ;自己書き換え 1セクタ辺りのディレクトリエントリ数  1024=32 / 512=16 / 256=8
       DCB2                     SDECPAT EQU $-1
       DCB3                     SOPEN1X:
000F82 DCB3 CD87DD          17      CALL    READ_DIR    ;FILE SEARCH
000F85 DCB6 382A            12      JR  C,RDDERR
000F87 DCB8 2A7EF1          16      LD  HL,(_DTBUF)
       DCBB                     SOPEN2:
000F8A DCBB D5              11      PUSH    DE
000F8B DCBC CD96DD          17      CALL    FILESE      ;(self-modifying code)
       DCBD                     OPENPAT EQU $-2
000F8E DCBF D1              10      POP DE
000F8F DCC0 386D            12      JR  C,SOPENE
000F91 DCC2 281B            12      JR  Z,SCF_FF_RET
       DCC4                     SOPEN3:
000F93 DCC4 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
000F96 DCC7 B7               4      OR  A
000F97 DCC8 200C            12      JR  NZ,SOPEN5
000F99 DCCA 13               6      INC DE      ;ルートディレクトリ
000F9A DCCB E5              11      PUSH    HL
000F9B DCCC 210C00          10      LD  HL,12       ;(self-modifying code)MAXDIR
       DCCD                     MD_PAT  EQU $-2
000F9E DCCF ED52            15      SBC HL,DE       ;CF=0 なので SUB HL,DE
000FA0 DCD1 E1              10      POP HL
000FA1 DCD2 20DD            12      JR  NZ,SOPEN1
000FA3 DCD4 1807            12      JR  SOPEN6
       DCD6                     SOPEN5:
000FA5 DCD6 CDA5E5          17      CALL    GNCLX       ;END DIR
000FA8 DCD9 D8              11      RET C
000FA9 DCDA CD4EDE          17      CALL    ENDCL
       DCDD                     SOPEN6:
000FAC DCDD 38D2            12      JR  C,SOPEN1
       DCDF                     SCF_FF_RET:
000FAE DCDF 37               4      SCF         ;CF=1
000FAF DCE0 9F               4      SBC A,A     ;A=0FFH
000FB0 DCE1 C9              10      RET
                                
       DCE2                     RDDERR:
000FB1 DCE2 BF               4      CP  A       ;READ ERR CF=1 ZF=1
000FB2 DCE3 37               4      SCF
000FB3 DCE4 C9              10      RET
                                
       DCE5                     NOPEN:
000FB4 DCE5 2196DD          10      LD  HL,FILESE
000FB7 DCE8 22BDDC          16      LD  (OPENPAT),HL
000FBA DCEB FD2A98F0        20      LD  IY,(_FCB)
000FBE DCEF CD76DF          17      CALL    CHKWILDX
000FC1 DCF2 30EB            12      JR  NC,SCF_FF_RET
000FC3 DCF4 FD7E00          19      LD  A,(IY+0)
000FC6 DCF7 CD36DC          17      CALL    GETDRV
000FC9 DCFA CDD9F0          17      CALL    _CHGDRV
000FCC DCFD D8              11      RET C
000FCD DCFE 2AF8F1          16      LD  HL,(SFNDF)  ;Direcroty location and Flags
000FD0 DD01 229FF0          16      LD  (_FILEN),HL
                                
000FD3 DD04 CD91DE          17      CALL    LDDIRX
000FD6 DD07 ED5B9AF0        20      LD  DE,(_FBPS)
000FDA DD0B CD87DD          17      CALL    READ_DIR
000FDD DD0E 38D2            12      JR  C,RDDERR
000FDF DD10 3A9EF0          13      LD  A,(_FBCNT)
000FE2 DD13 3D               4      DEC A
000FE3 DD14 28AE            12      JR  Z,SOPEN3
       DD16                     NOPEN2:
000FE5 DD16 2A9CF0          16      LD  HL,(_FBAD)
000FE8 DD19 012000          10      LD  BC,020H
000FEB DD1C 09              11      ADD HL,BC
000FEC DD1D 4F               4      LD  C,A
000FED DD1E 189B            12      JR  SOPEN2
                                
       DD20                     SOPENE2:
000FEF DD20 229CF0          16      LD  (_FBAD),HL
000FF2 DD23 79               4      LD  A,C
000FF3 DD24 329EF0          13      LD  (_FBCNT),A
000FF6 DD27 ED539AF0        20      LD  (_FBPS),DE
000FFA DD2B FD2298F0        20      LD  (_FCB),IY
       DD2F                     SOPENE:
000FFE DD2F AF               4      XOR A
000FFF DD30 C9              10      RET
                                
       DD31                     COPEN:
001000 DD31 FD360D20        19      LD  (IY+13),020H    ;(FCB)属性(アトリビュート)
                                
001004 DD35 21B3DD          10      LD  HL,NEXTSE
001007 DD38 CD84DC          17      CALL    SOPENC
00100A DD3B D0              11      RET NC
00100B DD3C C8              11      RET Z
00100C DD3D 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
00100F DD40 B7               4      OR  A
001010 DD41 37               4      SCF
001011 DD42 C8              11      RET Z       ;ルートディレクトリ
001012 DD43 0601             7      LD  B,1
001014 DD45 CDD5DF          17      CALL    WRDF
001017 DD48 D8              11      RET C
001018 DD49 ED5BFEF1        20      LD  DE,(_CLPS)
00101C DD4D D5              11      PUSH    DE
00101D DD4E CD17DE          17      CALL    DCPAT
001020 DD51 CD30E4          17      CALL    DRDNX
001023 DD54 2A7EF1          16      LD  HL,(_DTBUF) ;ディレクトリエントリを0クリア
001026 DD57 3A3AE3          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
001029 DD5A 47               4      LD  B,A
00102A DD5B AF               4      XOR A
00102B DD5C 4F               4      LD  C,A
       DD5D                     COPENCL:
00102C DD5D 77               7      LD  (HL),A
00102D DD5E EDA1            16      CPI         ;HL=HL+1 BC=BC-1 BCが0の場合にP/V=0
00102F DD60 EA5DDD          10      JP  PE,COPENCL
                                
001032 DD63 3A35DE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ数
001035 DD66 3D               4      DEC A
001036 DD67 2819            12      JR  Z,COPENE
001038 DD69 3E01             7      LD  A,1     ;1セクタ辺りのセクタ数が2以上の場合
00103A DD6B 329DE5          13      LD  (_SECPS),A
00103D DD6E D1              10      POP DE      ;DE=(_CLPS)
00103E DD6F D5              11      PUSH    DE
       DD70                     COPEN1:
00103F DD70 D5              11      PUSH    DE      ;データバッファに入らないセクタもゼロクリア
001040 DD71 C5              11      PUSH    BC
001041 DD72 2A7EF1          16      LD  HL,(_DTBUF)
001044 DD75 CD31DE          17      CALL    CLUSTX
001047 DD78 CD35E7          17      CALL    DWT24
00104A DD7B C1              10      POP BC
00104B DD7C D1              10      POP DE
00104C DD7D CD9CE5          17      CALL    NEXTX
00104F DD80 20EE            12      JR  NZ,COPEN1
       DD82                     COPENE:
001051 DD82 2A7EF1          16      LD  HL,(_DTBUF)
001054 DD85 D1              10      POP DE
001055 DD86 C9              10      RET
                                
       DD87                     READ_DIR:
001056 DD87 ED53FEF1        20      LD  (_CLPS),DE
00105A DD8B C5              11      PUSH    BC
00105B DD8C D5              11      PUSH    DE
00105C DD8D CD17DE          17      CALL    DCPAT
00105F DD90 CD10E4          17      CALL    DRDX
001062 DD93 D1              10      POP DE
001063 DD94 C1              10      POP BC
001064 DD95 C9              10      RET
                                
       DD96                     FILESE:
001065 DD96 7E               7      LD  A,(HL)
001066 DD97 B7               4      OR  A
001067 DD98 C8              11      RET Z       ;END:ZF=1 CF=0
001068 DD99 FEE5             7      CP  0E5H
00106A DD9B 280E            12      JR  Z,FILESE1
00106C DD9D FDE5            15      PUSH    IY
00106E DD9F D1              10      POP DE
00106F DDA0 13               6      INC DE
001070 DDA1 E5              11      PUSH    HL
001071 DDA2 CDEEDD          17      CALL    CPFILE
001074 DDA5 CC0FDE          17      CALL    Z,CPFILE2
001077 DDA8 E1              10      POP HL
001078 DDA9 37               4      SCF
001079 DDAA C8              11      RET Z       ;!!!:(ZF=1) CF=1
       DDAB                     FILESE1:
00107A DDAB CDC2DD          17      CALL    FNEXT
00107D DDAE 20E6            12      JR  NZ,FILESE
       DDB0                     ZF0_CF0_AFF_RET:
00107F DDB0 F6FF             7      OR  0FFH        ;ZF=0 CF=0
001081 DDB2 C9              10      RET
                                
       DDB3                     NEXTSE:
001082 DDB3 7E               7      LD  A,(HL)
001083 DDB4 B7               4      OR  A
001084 DDB5 37               4      SCF
001085 DDB6 C8              11      RET Z       ;!!!:ZF=1 CF=1
001086 DDB7 FEE5             7      CP  0E5H
001088 DDB9 37               4      SCF
001089 DDBA C8              11      RET Z       ;!!!:(ZF=1) CF=1
00108A DDBB CDC2DD          17      CALL    FNEXT
00108D DDBE 20F3            12      JR  NZ,NEXTSE
00108F DDC0 18EE            12      JR  ZF0_CF0_AFF_RET
                                
       DDC2                     FNEXT:
001091 DDC2 E5              11      PUSH    HL
001092 DDC3 219FF0          10      LD  HL,_FILEN
001095 DDC6 34              11      INC (HL)
001096 DDC7 E1              10      POP HL
001097 DDC8 112000          10      LD  DE,020H
00109A DDCB 19              11      ADD HL,DE
00109B DDCC 0D               4      DEC C
00109C DDCD C9              10      RET
                                
       DDCE                     CPNAME:
00109D DDCE C5              11      PUSH    BC
00109E DDCF D5              11      PUSH    DE
00109F DDD0 E5              11      PUSH    HL
0010A0 DDD1 CDE8DD          17      CALL    CPFILE4
0010A3 DDD4 E1              10      POP HL
0010A4 DDD5 23               6      INC HL
0010A5 DDD6 23               6      INC HL
0010A6 DDD7 23               6      INC HL
0010A7 DDD8 23               6      INC HL
0010A8 DDD9 D1              10      POP DE
0010A9 DDDA C1              10      POP BC
0010AA DDDB 2005            12      JR  NZ,CPNAME1
0010AC DDDD 7E               7      LD  A,(HL)
0010AD DDDE 23               6      INC HL
0010AE DDDF 66               7      LD  H,(HL)
0010AF DDE0 6F               4      LD  L,A
0010B0 DDE1 C9              10      RET
       DDE2                     CPNAME1:
0010B1 DDE2 23               6      INC HL
0010B2 DDE3 23               6      INC HL
0010B3 DDE4 10E8            13      DJNZ    CPNAME
0010B5 DDE6 37               4      SCF
0010B6 DDE7 C9              10      RET
                                
       DDE8                     CPFILE4:
0010B7 DDE8 C5              11      PUSH    BC
0010B8 DDE9 010004          10      LD  BC,00400H
0010BB DDEC 1804            12      JR  CPSTR1
       DDEE                     CPFILE:
0010BD DDEE C5              11      PUSH    BC
0010BE DDEF 01000B          10      LD  BC,00B00H
       DDF2                     CPSTR1:
0010C1 DDF2 1A               7      LD  A,(DE)
0010C2 DDF3 FE3F             7      CP  '?'     ;Wild card
0010C4 DDF5 2812            12      JR  Z,CPSTR2
0010C6 DDF7 7E               7      LD  A,(HL)
0010C7 DDF8 CD5CDF          17      CALL    FKANC
0010CA DDFB E5              11      PUSH    HL
0010CB DDFC 67               4      LD  H,A
0010CC DDFD 1A               7      LD  A,(DE)
0010CD DDFE CB01             4      RLC C
0010CF DE00 CD5CDF          17      CALL    FKANC
0010D2 DE03 CB09             4      RRC C
0010D4 DE05 BC               4      CP  H       ;CP (HL),(DE)
0010D5 DE06 E1              10      POP HL
0010D6 DE07 2004            12      JR  NZ,CPSTR3
       DE09                     CPSTR2:
0010D8 DE09 13               6      INC DE
0010D9 DE0A 23               6      INC HL
0010DA DE0B 10E5            13      DJNZ    CPSTR1
       DE0D                     CPSTR3:
0010DC DE0D C1              10      POP BC
0010DD DE0E C9              10      RET
                                
       DE0F                     CPFILE2:
0010DE DE0F FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
0010E1 DE12 F6E1             7      OR  0E1H
0010E3 DE14 2F               4      CPL
0010E4 DE15 A6               7      AND (HL)
0010E5 DE16 C9              10      RET
                                
       DE17                     DCPAT:
0010E6 DE17 0E00             7      LD  C,0
0010E8 DE19 2A7EF1          16      LD  HL,(_DTBUF)
0010EB DE1C 3AA0F0          13      LD  A,(_DIRF)   ;ディレクトリか判別
0010EE DE1F B7               4      OR  A
0010EF DE20 C8              11      RET Z       ;ルートディレクトリの場合はCレジスタを0にしておく(CDEがセクタ番号)
0010F0 DE21 3A35DE          13      LD  A,(SPCPAT)
0010F3 DE24 4F               4      LD  C,A
0010F4 DE25 3A9DE5          13      LD  A,(_SECPS)
0010F7 DE28 B9               4      CP  C
0010F8 DE29 3801            12      JR  C,DC1
0010FA DE2B AF               4      XOR A
       DE2C                     DC1:
0010FB DE2C F680             7      OR  080H
0010FD DE2E 32A0F0          13      LD  (_DIRF),A   ;bit0-6:セクタインデックス
       DE31                     CLUSTX:
001100 DE31 E5              11      PUSH    HL
001101 DE32 EB               4      EX  DE,HL
001102 DE33 AF               4      XOR A
001103 DE34 0E01             7      LD  C,1     ;自己書き換え（1クラスタの論理セクタ数）
       DE35                     SPCPAT  EQU $-1
       DE36                     L_CLDBL:
001105 DE36 CB19             8      RR  C       ;->CF
001107 DE38 3804            12      JR  C,E_CLDBL
001109 DE3A 29              11      ADD HL,HL       ;*2
00110A DE3B 8F               4      ADC A,A
00110B DE3C 18F8            12      JR  L_CLDBL
       DE3E                     E_CLDBL:
00110D DE3E 4F               4      LD  C,A
00110E DE3F 3A9DE5          13      LD  A,(_SECPS)
001111 DE42 B5               4      OR  L
001112 DE43 6F               4      LD  L,A
001113 DE44 110800          10      LD  DE,8    ;+8 (2D)  !ADDCL (self-modifying code)
       DE45                     CLSPAT  EQU $-2
001116 DE47 AF               4      XOR A
001117 DE48 19              11      ADD HL,DE   ;データ格納領域の先頭論理セクタ番号
001118 DE49 89               4      ADC A,C
001119 DE4A 4F               4      LD  C,A
00111A DE4B EB               4      EX  DE,HL
00111B DE4C E1              10      POP HL
00111C DE4D C9              10      RET
                                
       DE4E                     ENDCL:
00111D DE4E 7A               4      LD  A,D ;END CLUSTER
00111E DE4F FE01             7      CP  1   ;164=356    (self-modifying code)
       DE50                     CLPAT1  EQU $-1
001120 DE51 C0              11      RET NZ
001121 DE52 7B               4      LD  A,E
001122 DE53 FE64             7      CP  064H    ;       (self-modifying code)
       DE54                     CLPAT2  EQU $-1
001124 DE55 C9              10      RET
                                
       DE56                     CAP:
001125 DE56 FE61             7      CP  'a'
001127 DE58 D8              11      RET C
001128 DE59 FE7B             7      CP  'z'+1
00112A DE5B D0              11      RET NC
00112B DE5C D620             7      SUB 020H
00112D DE5E C9              10      RET
       DE5F                     CAP2:
00112E DE5F CD56DE          17      CALL    CAP
       DE62                     CAP3:               ;
001131 DE62 FE05             7      CP  5
001133 DE64 2803            12      JR  Z,CAP4
001135 DE66 FE21             7      CP  021H
001137 DE68 C9              10      RET
       DE69                     CAP4:
001138 DE69 3EE5             7      LD  A,0E5H
00113A DE6B C9              10      RET
                                
       DE6C                     CHDIR:
00113B DE6C CD57E8          17      CALL    GETDPBD
00113E DE6F 381D            12      JR  C,CHDIR2
001140 DE71 DD751A          19      LD  (IX+DPB_SDIR),L
001143 DE74 DD741B          19      LD  (IX+DPB_SDIR+1),H
001146 DE77 1815            12      JR  CHDIR2      ;POP_IX_RET
                                
       DE79                     LDDIR:
001148 DE79 CD57E8          17      CALL    GETDPBD
00114B DE7C DD5E1A          19      LD  E,(IX+DPB_SDIR)
00114E DE7F DD561B          19      LD  D,(IX+DPB_SDIR+1)
001151 DE82 13               6      INC DE
001152 DE83 FD730E          19      LD  (IY+14),E   ;(FCB)アクセスするディレクトリのクラスタ番号+1
001155 DE86 FD720F          19      LD  (IY+15),D
001158 DE89 1B               6      DEC DE
001159 DE8A AF               4      XOR A
00115A DE8B 32A0F0          13      LD  (_DIRF),A
       DE8E                     CHDIR2:
00115D DE8E DDE1            14      POP IX
00115F DE90 C9              10      RET
                                
       DE91                     LDDIRX:
001160 DE91 3AA0F0          13      LD  A,(_DIRF)   ;(FCB)アクセスするディレクトリのセクタインデックス
001163 DE94 E67F             7      AND 07FH
       DE96                     LDDIRX1:
001165 DE96 329DE5          13      LD  (_SECPS),A
001168 DE99 FD5E0E          19      LD  E,(IY+14)   ;(FCB)アクセスするディレクトリのクラスタ番号+1
00116B DE9C FD560F          19      LD  D,(IY+15)
00116E DE9F 1B               6      DEC DE
00116F DEA0 CD4EDE          17      CALL    ENDCL
001172 DEA3 D479DE          17      CALL    NC,LDDIR
       DEA6                     LDDIRS:
001175 DEA6 7A               4      LD  A,D
001176 DEA7 B3               4      OR  E
001177 DEA8 32A0F0          13      LD  (_DIRF),A   ;ディレクトリか判別
00117A DEAB C9              10      RET
                                
       DEAC                     KILL:
00117B DEAC CD76DF          17      CALL    CHKWILDX
00117E DEAF 3834            12      JR  C,KILLW
001180 DEB1 CD52DC          17      CALL    SOPENX
       DEB4                     KILLS:
001183 DEB4 3E1F             7      LD  A,01FH
001185 DEB6 D4F8DE          17      CALL    NC,CHKATT
001188 DEB9 D8              11      RET C
       DEBA                     KILLSX:
001189 DEBA 36E5            10      LD  (HL),0E5H   ;DIR
00118B DEBC CD50DF          17      CALL    WTDB
00118E DEBF 111A00          10      LD  DE,01AH
001191 DEC2 19              11      ADD HL,DE
001192 DEC3 5E               7      LD  E,(HL)
001193 DEC4 23               6      INC HL
001194 DEC5 56               7      LD  D,(HL)
       DEC6                     KILLS1:
001195 DEC6 CD4EDE          17      CALL    ENDCL
001198 DEC9 D0              11      RET NC      ;CF=0
001199 DECA 21FEFF          10      LD  HL,0-2
00119C DECD 19              11      ADD HL,DE
00119D DECE D0              11      RET NC      ;DE= 0 or 1
00119E DECF D5              11      PUSH    DE
00119F DED0 CDF7F0          17      CALL    _GNCL
0011A2 DED3 ED53FEF1        20      LD  (_CLPS),DE
0011A6 DED7 D1              10      POP DE
0011A7 DED8 210000          10      LD  HL,0
0011AA DEDB D4FAF0          17      CALL    NC,_SNCL
0011AD DEDE D8              11      RET C
0011AE DEDF ED5BFEF1        20      LD  DE,(_CLPS)  ;FAT
0011B2 DEE3 18E1            12      JR  KILLS1
                                
       DEE5                     KILLW:
0011B4 DEE5 CD81DC          17      CALL    SOPEN
       DEE8                     KILLW1:
0011B7 DEE8 380B            12      JR  C,KILLW2
0011B9 DEEA CD20DD          17      CALL    SOPENE2
0011BC DEED CDB4DE          17      CALL    KILLS
0011BF DEF0 CDE5DC          17      CALL    NOPEN
0011C2 DEF3 18F3            12      JR  KILLW1
       DEF5                     KILLW2:
0011C4 DEF5 C8              11      RET Z
0011C5 DEF6 3F               4      CCF
0011C6 DEF7 C9              10      RET
                                
       DEF8                     CHKATT:
0011C7 DEF8 E5              11      PUSH    HL
0011C8 DEF9 110B00          10      LD  DE,00BH
0011CB DEFC 19              11      ADD HL,DE
0011CC DEFD A6               7      AND (HL)
0011CD DEFE E1              10      POP HL
0011CE DEFF C8              11      RET Z
0011CF DF00 37               4      SCF
0011D0 DF01 C9              10      RET
                                
       DF02                     NAME:
0011D1 DF02 CD76DF          17      CALL    CHKWILDX
0011D4 DF05 D8              11      RET C
0011D5 DF06 110400          10      LD  DE,4
0011D8 DF09 19              11      ADD HL,DE
0011D9 DF0A 221FDF          16      LD  (NAMEP),HL
0011DC DF0D 23               6      INC HL
0011DD DF0E CD7ADF          17      CALL    CHKWILD
0011E0 DF11 D8              11      RET C
                                
0011E1 DF12 CD52DC          17      CALL    SOPENX
0011E4 DF15 3E0F             7      LD  A,00FH
0011E6 DF17 D4F8DE          17      CALL    NC,CHKATT
0011E9 DF1A D8              11      RET C
                                
0011EA DF1B FDE5            15      PUSH    IY
0011EC DF1D FD210000        14      LD  IY,0        ;自己書き換え
       DF1F                     NAMEP   EQU $-2
0011F0 DF21 CD52DC          17      CALL    SOPENX
0011F3 DF24 FDE3            23      EX  (SP),IY
0011F5 DF26 3F               4      CCF
0011F6 DF27 D481DC          17      CALL    NC,SOPEN
0011F9 DF2A EB               4      EX  DE,HL
0011FA DF2B E1              10      POP HL
0011FB DF2C D8              11      RET C
                                
       DF2D                     SETNAME:
0011FC DF2D 01000B          10      LD  BC,11*256
0011FF DF30 23               6      INC HL
001200 DF31 7E               7      LD  A,(HL)
001201 DF32 FEE5             7      CP  0E5H
001203 DF34 2004            12      JR  NZ,SNAME1
001205 DF36 3E05             7      LD  A,5
001207 DF38 180E            12      JR  SNAME3
       DF3A                     SNAME1:
001209 DF3A 7E               7      LD  A,(HL)
00120A DF3B 0C               4      INC C
00120B DF3C 0D               4      DEC C
00120C DF3D 2009            12      JR  NZ,SNAME3
00120E DF3F CD56DE          17      CALL    CAP
001211 DF42 FEA0             7      CP  0A0H
001213 DF44 2002            12      JR  NZ,SNAME3
001215 DF46 3E20             7      LD  A,020H
       DF48                     SNAME3:
001217 DF48 12               7      LD  (DE),A
001218 DF49 7E               7      LD  A,(HL)
001219 DF4A 23               6      INC HL
00121A DF4B CD63DF          17      CALL    FKAN
00121D DF4E 10EA            13      DJNZ    SNAME1
       DF50                     WTDB:
00121F DF50 3EFF             7      LD  A,0FFH
001221 DF52 3239F0          13      LD  (SFILE),A
       DF55                     SWTDBF:
001224 DF55 3E01             7      LD  A,1
001226 DF57 32A4F0          13      LD  (_WTDBF),A
001229 DF5A AF               4      XOR A
00122A DF5B C9              10      RET
                                
       DF5C                     FKANC:
00122B DF5C CB41             8      BIT 0,C
00122D DF5E CC5FDE          17      CALL    Z,CAP2
001230 DF61 1801            12      JR  FKANX
       DF63                     FKAN:           ;漢字チェック
001232 DF63 13               6      INC DE
       DF64                     FKANX:
001233 DF64 CB41             8      BIT 0,C
001235 DF66 CB81             8      RES 0,C
001237 DF68 C0              11      RET NZ
001238 DF69 FE80             7      CP  080H
00123A DF6B D8              11      RET C
00123B DF6C FEA0             7      CP  0A0H
00123D DF6E 3803            12      JR  C,FKAN1
00123F DF70 FEE0             7      CP  0E0H
001241 DF72 D8              11      RET C
       DF73                     FKAN1:
001242 DF73 0C               4      INC C
001243 DF74 A7               4      AND A
001244 DF75 C9              10      RET
                                
       DF76                     CHKWILDX:
001245 DF76 FDE5            15      PUSH    IY
001247 DF78 E1              10      POP HL
001248 DF79 23               6      INC HL
       DF7A                     CHKWILD:
001249 DF7A 060B             7      LD  B,11
00124B DF7C 3E3F             7      LD  A,'?'
       DF7E                     CHKWIL1:
00124D DF7E BE               7      CP  (HL)
00124E DF7F 23               6      INC HL
00124F DF80 37               4      SCF
001250 DF81 C8              11      RET Z
001251 DF82 10FA            13      DJNZ    CHKWIL1
001253 DF84 AF               4      XOR A
001254 DF85 C9              10      RET
                                
       DF86                     SDIRENT:        ;IY=FCB HL=DIR
001255 DF86 D5              11      PUSH    DE
001256 DF87 E5              11      PUSH    HL
001257 DF88 FDE5            15      PUSH    IY
001259 DF8A D1              10      POP DE
00125A DF8B EB               4      EX  DE,HL
00125B DF8C CD2DDF          17      CALL    SETNAME
                                ;               Attribute
00125E DF8F FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001261 DF92 12               7      LD  (DE),A
001262 DF93 13               6      INC DE
                                ;               Reserved
001263 DF94 AF               4      XOR A
001264 DF95 060A             7      LD  B,10
       DF97                     SDE1:
001266 DF97 12               7      LD  (DE),A
001267 DF98 13               6      INC DE
001268 DF99 10FC            13      DJNZ    SDE1
                                                    ;(FCB)更新時刻
00126A DF9B 21E4F1          10      LD  HL,SDDATA       ;(FCB)更新年月日
00126D DF9E 060A             7      LD  B,SDDATAE-SDDATA    ;(FCB)ファイルの先頭クラスタ
       DFA0                     SDLOOP:                 ;(FCB)ファイルのサイズ(バイト単位)
00126F DFA0 7E               7      LD  A,(HL)
001270 DFA1 23               6      INC HL
001271 DFA2 32A7DF          13      LD  (SDPAT),A
001274 DFA5 FD7E00          19      LD  A,(IY+0)    ;LD A,(IY+A)
       DFA7                     SDPAT   EQU $-1
001277 DFA8 12               7      LD  (DE),A
001278 DFA9 13               6      INC DE
001279 DFAA 10F4            13      DJNZ    SDLOOP
                                
00127B DFAC AF               4      XOR A
00127C DFAD E1              10      POP HL
00127D DFAE D1              10      POP DE
00127E DFAF C9              10      RET
                                
       DFB0                     WOPEN:
00127F DFB0 FD7E0D          19      LD  A,(IY+13)   ;(FCB)属性(アトリビュート)
001282 DFB3 E61F             7      AND 01FH
001284 DFB5 37               4      SCF
001285 DFB6 C0              11      RET NZ
001286 DFB7 FD361CFE        19      LD  (IY+28),0FEH    ;(FCB)オープンモード
       DFBB                     TOPEN2:
00128A DFBB AF               4      XOR A
       DFBC                     TOPEN:              ;Initializes the time stamp
00128B DFBC FD3617FF        19      LD  (IY+23),0FFH    ;(FCB)更新時刻
00128F DFC0 C9              10      RET
                                
       DFC1                     WRDFX:
001290 DFC1 3A35DE          13      LD  A,(SPCPAT)  ;1クラスタの論理セクタ
       DFC4                     L_WRFX:
001293 DFC4 1F               4      RRA         ;->CF
001294 DFC5 3806            12      JR  C,E_WRFX
001296 DFC7 CB39             8      SRL C
001298 DFC9 CB1C             8      RR  H       ;CH=CH/2
00129A DFCB 18F7            12      JR  L_WRFX
       DFCD                     E_WRFX:
00129C DFCD 41               4      LD  B,C
00129D DFCE 4C               4      LD  C,H
00129E DFCF 03               6      INC BC
00129F DFD0 3E37             7      LD  A,037H      ;SCF
0012A1 DFD2 322DE4          13      LD  (DRDN1),A
                                
       DFD5                     WRDF:               ;BCクラスタ分FATを確保する
0012A4 DFD5 110200          10      LD  DE,2
0012A7 DFD8 AF               4      XOR A
0012A8 DFD9 329DE5          13      LD  (_SECPS),A
       DFDC                     WRDF1:
0012AB DFDC C5              11      PUSH    BC
0012AC DFDD D5              11      PUSH    DE
0012AD DFDE CDF7F0          17      CALL    _GNCL
0012B0 DFE1 381C            12      JR  C,WRDF3
0012B2 DFE3 7A               4      LD  A,D     ;空いているかチェック
0012B3 DFE4 B3               4      OR  E
0012B4 DFE5 202A            12      JR  NZ,WRDF4
0012B6 DFE7 E1              10      POP HL      ;HL=空いているクラスタ
0012B7 DFE8 E5              11      PUSH    HL
0012B8 DFE9 ED5BFEF1        20      LD  DE,(_CLPS)  ;DE=元の(_CLPS)
0012BC DFED 22FEF1          16      LD  (_CLPS),HL
0012BF DFF0 7A               4      LD  A,D     ;元の(_CLPS)が 0 か?
0012C0 DFF1 B3               4      OR  E
0012C1 DFF2 2008            12      JR  NZ,WRDF2
0012C3 DFF4 FD751A          19      LD  (IY+26),L   ;(FCB)ファイルの先頭クラスタ
0012C6 DFF7 FD741B          19      LD  (IY+27),H   ;元が空の場合はFCBにクラスタをセットする
0012C9 DFFA 1803            12      JR  WRDF3
       DFFC                     WRDF2:
0012CB DFFC CDFAF0          17      CALL    _SNCL
       DFFF                     WRDF3:
0012CE DFFF D1              10      POP DE
0012CF E000 C1              10      POP BC
0012D0 E001 D8              11      RET C
0012D1 E002 0B               6      DEC BC
0012D2 E003 78               4      LD  A,B
0012D3 E004 B1               4      OR  C
0012D4 E005 200C            12      JR  NZ,WRDF5    ;ここでループカウンタチェック
0012D6 E007 ED5BFEF1        20      LD  DE,(_CLPS)
0012DA E00B 21FFFF          10      LD  HL,0FFFFH   ;FATエントリ終了(EOCマーク)
0012DD E00E C3FAF0          10      JP  _SNCL
                                
       E011                     WRDF4:              ;DEクラスタが空じゃないので次に移動する
0012E0 E011 D1              10      POP DE
0012E1 E012 C1              10      POP BC
       E013                     WRDF5:
0012E2 E013 13               6      INC DE
0012E3 E014 CD4EDE          17      CALL    ENDCL
0012E6 E017 38C3            12      JR  C,WRDF1
0012E8 E019 37               4      SCF
0012E9 E01A C9              10      RET
                                
       E01B                     RWXR:
0012EA E01B 3A3AE3          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E01E                     L_RWX:
0012ED E01E 1F               4      RRA     ;->CF
0012EE E01F 3808            12      JR  C,E_RWX
0012F0 E021 CB38             8      SRL B   ;BCH=BCH/2
0012F2 E023 CB19             8      RR  C   ;
0012F4 E025 CB1C             8      RR  H   ;
0012F6 E027 18F5            12      JR  L_RWX
       E029                     E_RWX:
0012F8 E029 FD5E1A          19      LD  E,(IY+26)   ;(FCB)ファイルの先頭クラスタ
0012FB E02C FD561B          19      LD  D,(IY+27)
0012FE E02F AF               4      XOR A
0012FF E030 329DE5          13      LD  (_SECPS),A
       E033                     RWX1:
001302 E033 ED53FEF1        20      LD  (_CLPS),DE
001306 E037 7A               4      LD  A,D
001307 E038 B3               4      OR  E
001308 E039 2813            12      JR  Z,SCF_RET   ;RET DE==0 => CF=1
                                
00130A E03B 78               4      LD  A,B
00130B E03C B1               4      OR  C
00130C E03D B4               4      OR  H
00130D E03E C8              11      RET Z       ;RET BCH==0 => CF=0
                                
00130E E03F CDA5E5          17      CALL    GNCLX
001311 E042 D8              11      RET C
001312 E043 7C               4      LD  A,H     ;
001313 E044 25               4      DEC H       ;
001314 E045 B7               4      OR  A       ;DEC BCH
001315 E046 2001            12      JR  NZ,RWX2     ;
001317 E048 0B               6      DEC BC      ;
       E049                     RWX2:
001318 E049 CD4EDE          17      CALL    ENDCL
00131B E04C 38E5            12      JR  C,RWX1
       E04E                     SCF_RET:
00131D E04E 37               4      SCF
00131E E04F C9              10      RET
                                
       E050                     DSKF:
00131F E050 110000          10      LD  DE,0
       E051                     MAXCLP  EQU $-2
001322 E053 2AACF0          16      LD  HL,(_FAKEFREE)
001325 E056 7C               4      LD  A,H
001326 E057 B5               4      OR  L
001327 E058 2803            12      JR  Z,DSKF1
001329 E05A 110100          10      LD  DE,1
       E05D                     DSKF1:
00132C E05D D5              11      PUSH    DE
00132D E05E CDF7F0          17      CALL    _GNCL
001330 E061 380C            12      JR  C,POPSCF
001332 E063 7A               4      LD  A,D
001333 E064 B3               4      OR  E
001334 E065 2001            12      JR  NZ,DSKF2
001336 E067 23               6      INC HL
       E068                     DSKF2:
001337 E068 D1              10      POP DE
001338 E069 1B               6      DEC DE
001339 E06A 7A               4      LD  A,D
00133A E06B B3               4      OR  E
00133B E06C 20EF            12      JR  NZ,DSKF1
00133D E06E C9              10      RET
                                
       E06F                     POPSCF:
00133E E06F F1              10      POP AF
00133F E070 37               4      SCF
001340 E071 C9              10      RET
                                
       E072                     SETTMS:
001341 E072 FD7E17          19      LD  A,(IY+23)   ;(FCB)ファイルを最後に変更した時刻
001344 E075 3C               4      INC A
001345 E076 C0              11      RET NZ      ;ファイルが更新されていない
       E077                     SETTMSX:            ;FCBに日付時刻をセットする
001346 E077 CDB2D7          17      CALL    _SYS2C      ;(BDOS)時刻の獲得
                                                ;H←時  L←分  D←秒
001349 E07A CB25             8      SLA L       ;   *2
00134B E07C CB25             8      SLA L       ;   *4
00134D E07E 29              11      ADD HL,HL       ;*2 *8
00134E E07F 29              11      ADD HL,HL       ;*4 *16
00134F E080 29              11      ADD HL,HL       ;*8 *32
001350 E081 7A               4      LD  A,D
001351 E082 0F               4      RRCA            ;bit.0->7->->->0->C
001352 E083 E61F             7      AND 01FH
001354 E085 B5               4      OR  L
001355 E086 FD7716          19      LD  (IY+22),A   ;(FCB)ファイルを最後に変更した時刻
001358 E089 FD7417          19      LD  (IY+23),H
                                
00135B E08C CDACD7          17      CALL    _SYS2A      ;(BDOS)日付の獲得
                                                ;HL←年  D←月  E←日
00135E E08F 0144F8          10      LD  BC,0-1980
001361 E092 09              11      ADD HL,BC
001362 E093 65               4      LD  H,L
                                
001363 E094 7A               4      LD  A,D
001364 E095 87               4      ADD A,A     ;*2
001365 E096 87               4      ADD A,A     ;*4
001366 E097 87               4      ADD A,A     ;*8
001367 E098 87               4      ADD A,A     ;*16
001368 E099 6F               4      LD  L,A
001369 E09A 29              11      ADD HL,HL       ;*32
00136A E09B 7D               4      LD  A,L
00136B E09C B3               4      OR  E
00136C E09D FD7714          19      LD  (IY+20),A   ;(FCB)ファイルを最後に変更した日付
00136F E0A0 FD7415          19      LD  (IY+21),H
001372 E0A3 C9              10      RET
                                
       E0A4                     PUSHRR:
001373 E0A4 323CE1          13      LD  (SETSEQ_SWC_RND),A
001376 E0A7 224EE1          16      LD  (SETSEQ_SWC_SEQ_RR),HL
001379 E0AA CDCAE0          17      CALL    GET_RR_AHL
00137C E0AD 220FF0          16      LD  (RR_BUF_HL),HL
00137F E0B0 3211F0          13      LD  (RR_BUF_A),A
001382 E0B3 C9              10      RET
                                
       E0B4                     GET_CPM_R_SIZE:     ;バイト単位からCP/Mのレコード単位を求める（1レコード=128バイト）
001383 E0B4 87               4      ADD A,A     ;in BHLA => out AHL
001384 E0B5 ED6A            15      ADC HL,HL
001386 E0B7 CB18             8      RR  B
001388 E0B9 B7               4      OR  A
001389 E0BA 78               4      LD  A,B     ;ここでフラグは変化しない
00138A E0BB C8              11      RET Z
00138B E0BC 2C               4      INC L       ;INC AHL
00138C E0BD C0              11      RET NZ      ;
00138D E0BE 24               4      INC H       ;
00138E E0BF C0              11      RET NZ      ;
00138F E0C0 3C               4      INC A       ;
001390 E0C1 C9              10      RET
                                
       E0C2                     INIT_RND:
001391 E0C2 3ECD             7      LD  A,0CDH      ;CALL ????
001393 E0C4 2111E1          10      LD  HL,POPRR
001396 E0C7 CDA4E0          17      CALL    PUSHRR
       E0CA                     GET_RR_AHL:
001399 E0CA FD6E21          19      LD  L,(IY+33)   ;(FCB)Random record
00139C E0CD FD6622          19      LD  H,(IY+34)   ;
00139F E0D0 FD7E23          19      LD  A,(IY+35)   ;
0013A2 E0D3 C9              10      RET
       E0D4                     SET_RR_AHL:
0013A3 E0D4 FD7521          19      LD  (IY+33),L   ;(FCB)Random record
0013A6 E0D7 FD7422          19      LD  (IY+34),H
0013A9 E0DA FD7723          19      LD  (IY+35),A
0013AC E0DD C9              10      RET
       E0DE                     INIT_SEQ:
0013AD E0DE 3E01             7      LD  A,1     ;LD BC,????
0013AF E0E0 210EE1          10      LD  HL,SETSEQ
0013B2 E0E3 CDA4E0          17      CALL    PUSHRR
       E0E6                     GETSEQ:
0013B5 E0E6 FD6E20          19      LD  L,(IY+32)   ;(FCB)カレントレコード
0013B8 E0E9 FD660C          19      LD  H,(IY+12)   ;(FCB)カレントブロック
0013BB E0EC AF               4      XOR A
                                
0013BC E0ED CB25             8      SLA L   ;L=L*2
                                
0013BE E0EF CB3C             8      SRL H   ;HL=HL/2
0013C0 E0F1 CB1D             8      RR  L   ;
0013C2 E0F3 C9              10      RET
                                
       E0F4                     SETSEQ1:
0013C3 E0F4 F5              11      PUSH    AF
0013C4 E0F5 E5              11      PUSH    HL      ;AHL=Random record
0013C5 E0F6 CDCAE0          17      CALL    GET_RR_AHL
0013C8 E0F9 47               4      LD  B,A     ;AHL→HLA
0013C9 E0FA 7D               4      LD  A,L     ;(IY+33)(FCB)ランダムレコード
0013CA E0FB 6C               4      LD  L,H     ;(IY+34)
0013CB E0FC 60               4      LD  H,B     ;(IY+35)
0013CC E0FD 0600             7      LD  B,0
                                
0013CE E0FF CDB4E0          17      CALL    GET_CPM_R_SIZE
                                
0013D1 E102 29              11      ADD HL,HL
0013D2 E103 CB3D             8      SRL L       ;L=L/2
0013D4 E105 FD7520          19      LD  (IY+32),L   ;(FCB)カレントレコード
0013D7 E108 FD740C          19      LD  (IY+12),H   ;(FCB)カレントブロック
0013DA E10B E1              10      POP HL
0013DB E10C F1              10      POP AF
0013DC E10D C9              10      RET
       E10E                     SETSEQ:
0013DD E10E CDF4E0          17      CALL    SETSEQ1
       E111                     POPRR:
0013E0 E111 F5              11      PUSH    AF
0013E1 E112 E5              11      PUSH    HL
0013E2 E113 2A0FF0          16      LD  HL,(RR_BUF_HL)
0013E5 E116 3A11F0          13      LD  A,(RR_BUF_A)
0013E8 E119 CDD4E0          17      CALL    SET_RR_AHL
0013EB E11C E1              10      POP HL
0013EC E11D F1              10      POP AF
0013ED E11E C9              10      RET
                                
       E11F                     RB_WRITE:
0013EE E11F C5              11      PUSH    BC
0013EF E120 ED4B4CF1        20      LD  BC,(STABLE+2*026H)  ;(BDOS)ランダムブロック書き込み
0013F3 E124 1805            12      JR  RBRW
       E126                     RB_READ:
0013F5 E126 C5              11      PUSH    BC
0013F6 E127 ED4B4EF1        20      LD  BC,(STABLE+2*027H)  ;(BDOS)ランダムブロック読み込み
       E12B                     RBRW:
0013FA E12B 1F               4      RRA     ;AHL = AHL*128
0013FB E12C 7C               4      LD  A,H ;AHL = AHL0/2
0013FC E12D 1F               4      RRA     ;A
0013FD E12E 65               4      LD  H,L ;
0013FE E12F CB1C             8      RR  H   ;H
001400 E131 2E00             7      LD  L,0 ;
001402 E133 CB1D             8      RR  L   ;L
001404 E135 CDD4E0          17      CALL    SET_RR_AHL
001407 E138 218000          10      LD  HL,128
00140A E13B C5              11      PUSH    BC
       E13C                     SETSEQ_SWC_RND:
00140B E13C CDF4E0          17      CALL    SETSEQ1
00140E E13F C1              10      POP BC
00140F E140 FDCB20FE        23      SET 7,(IY+32)   ;(FCB)カレントレコード
001413 E144 FDE5            15      PUSH    IY
001415 E146 D1              10      POP DE
001416 E147 D5              11      PUSH    DE
001417 E148 CD56E1          17      CALL    JP_BC
00141A E14B FDE1            14      POP IY
00141C E14D CD0EE1          17      CALL    SETSEQ
       E14E                     SETSEQ_SWC_SEQ_RR   EQU $-2
00141F E150 FDCB20BE        23      RES 7,(IY+32)   ;(FCB)カレントレコード
                                
001423 E154 C1              10      POP BC
001424 E155 C9              10      RET
       E156                     JP_BC:
001425 E156 C5              11      PUSH    BC
001426 E157 C9              10      RET
                                
       DCDF                     _SYS03  EQU SCF_FF_RET  ;(BDOS)外部入力
       DCDF                     _SYS2B  EQU SCF_FF_RET  ;(BDOS)日付の設定
       DCDF                     _SYS2D  EQU SCF_FF_RET  ;(BDOS)時刻の設定
       DCDF                     _SYS39  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの作成
       DCDF                     _SYS3A  EQU SCF_FF_RET  ;(BDOS)サブディレクトリの削除
                                
[EOF:LDFILE.ASM:SHIFT_JIS]
                                    INCLUDE "LDFILE2.ASM"
                                
                                ;   LSX-Dodgers FILE2
                                
                                                ;Write random block
       E158                     _SYS26:     ;(BDOS)ランダムブロック書き込み
001427 E158 AF               4      XOR A
001428 E159 322DE4          13      LD  (DRDN1),A   ;NOP
00142B E15C 227DE3          16      LD  (RBSIZE),HL ;HL←書き込むレコード数
00142E E15F 225DF0          16      LD  (LEFTX),HL
001431 E162 CD28DC          17      CALL    SETDRV
                                
001434 E165 CDD5E2          17      CALL    RBX0
001437 E168 DAF5E1          10      JP  C,RBWERR
00143A E16B CDB0DF          17      CALL    WOPEN
00143D E16E DAF5E1          10      JP  C,RBWERR
001440 E171 7C               4      LD  A,H
001441 E172 B5               4      OR  L
001442 E173 CAEEE1          10      JP  Z,RBW1
                                
001445 E176 2B               6      DEC HL
                                
001446 E177 CD93E3          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
001449 E17A 19              11      ADD HL,DE       ;BCHL=HL+BCDE
00144A E17B 3001            12      JR  NC,S26X1    ;
00144C E17D 03               6      INC BC      ;
       E17E                     S26X1:
00144D E17E CD1BE0          17      CALL    RWXR
001450 E181 DCC1DF          17      CALL    C,WRDFX
001453 E184 DAF5E1          10      JP  C,RBWERR
                                
001456 E187 CD04E3          17      CALL    RBX2
001459 E18A 281A            12      JR  Z,RBWB      ;NZ=セクタ以下の端数がある
00145B E18C CD23E3          17      CALL    RBXA
00145E E18F 3864            12      JR  C,RBWERR
001460 E191 EB               4      EX  DE,HL
001461 E192 C5              11      PUSH    BC
001462 E193 EDB0                    LDIR
001464 E195 225FF0          16      LD  (DTAX),HL
                                
001467 E198 CD55DF          17      CALL    SWTDBF      ;バッファデータは更新された
                                
00146A E19B 2A5DF0          16      LD  HL,(LEFTX)
00146D E19E D1              10      POP DE
00146E E19F ED52            15      SBC HL,DE
001470 E1A1 225DF0          16      LD  (LEFTX),HL
001473 E1A4 2831            12      JR  Z,RBWEND
                                
       E1A6                     RBWB:
001475 E1A6 CD58E3          17      CALL    RBXB
001478 E1A9 2814            12      JR  Z,RBWC
       E1AB                     RBWB1:
00147A E1AB C5              11      PUSH    BC
00147B E1AC D5              11      PUSH    DE
00147C E1AD CD31DE          17      CALL    CLUSTX
00147F E1B0 CDA7E3          17      CALL    DWTC
001482 E1B3 D1              10      POP DE
001483 E1B4 C1              10      POP BC
001484 E1B5 D4A5E5          17      CALL    NC,GNCLX
001487 E1B8 383B            12      JR  C,RBWERR
001489 E1BA 10EF            13      DJNZ    RBWB1
00148B E1BC CDF7E3          17      CALL    DRW_FLUSH
       E1BF                     RBWC:
00148E E1BF CD70E3          17      CALL    RBXC
001491 E1C2 2813            12      JR  Z,RBWEND
001493 E1C4 C5              11      PUSH    BC
001494 E1C5 CD31DE          17      CALL    CLUSTX
001497 E1C8 CD2CE4          17      CALL    DRDN
00149A E1CB C1              10      POP BC
00149B E1CC 3827            12      JR  C,RBWERR
00149D E1CE ED5B7EF1        20      LD  DE,(_DTBUF)
0014A1 E1D2 EDB0                    LDIR
0014A3 E1D4 CD55DF          17      CALL    SWTDBF      ;バッファデータは更新された
       E1D7                     RBWEND:
0014A6 E1D7 CD7CE3          17      CALL    RBXEND
                                
0014A9 E1DA CDE4E2          17      CALL    RBX1
0014AC E1DD 300F            12      JR  NC,RBW1     ;ランダムレコードの方が大きい場合はサイズを合わせる
0014AE E1DF CD93E3          17      CALL    GET_RR_BCDE ;BCDE=Random record
0014B1 E1E2 FD7310          19      LD  (IY+16),E   ;ファイルのサイズ(バイト単位)
0014B4 E1E5 FD7211          19      LD  (IY+17),D   ;
0014B7 E1E8 FD7112          19      LD  (IY+18),C   ;
0014BA E1EB FD7013          19      LD  (IY+19),B   ;
       E1EE                     RBW1:
0014BD E1EE FDE1            14      POP IY
0014BF E1F0 C1              10      POP BC
0014C0 E1F1 D1              10      POP DE
0014C1 E1F2 E1              10      POP HL
       E1F3                     DD_NUL:
0014C2 E1F3 AF               4      XOR A
       E1F4                     DRDF0:
       E1F4                     DWTF0:
0014C3 E1F4 C9              10      RET
                                
       E1F5                     RBWERR:
0014C4 E1F5 FDE5            15      PUSH    IY
0014C6 E1F7 D1              10      POP DE
0014C7 E1F8 2A20F1          16      LD  HL,(STABLE+2*010H)
0014CA E1FB CD0F00          17      CALL    JP_HL
       E1FE                     RBRERR1:
0014CD E1FE 3E01             7      LD  A,001H
       E200                     RBRERR2:
0014CF E200 FDE1            14      POP IY
0014D1 E202 C1              10      POP BC
0014D2 E203 D1              10      POP DE
0014D3 E204 E1              10      POP HL
0014D4 E205 37               4      SCF
0014D5 E206 210000          10      LD  HL,0
0014D8 E209 C9              10      RET
                                
       E20A                     RBRERR:
0014D9 E20A 3EFF             7      LD  A,0FFH
0014DB E20C 18F2            12      JR  RBRERR2
                                
       E20E                     RBRFL:
0014DD E20E 3E00             7  RBRFLP: LD  A,000H
0014DF E210 FE0D             7      CP  00DH
0014E1 E212 2005            12      JR  NZ,RBRFL1
0014E3 E214 D5              11      PUSH    DE
0014E4 E215 1E0A             7      LD  E,00AH
0014E6 E217 1805            12      JR  RBRFL2
       E219                     RBRFL1:
0014E8 E219 D5              11      PUSH    DE
0014E9 E21A CD09F0          17      CALL    _SYS07
0014EC E21D 5F               4      LD  E,A
       E21E                     RBRFL2:
0014ED E21E CDCDF0          17      CALL    _PRINT
0014F0 E221 7B               4      LD  A,E
0014F1 E222 D1              10      POP DE
0014F2 E223 320FE2          13      LD  (RBRFLP+1),A
0014F5 E226 C9              10      RET
       E227                     DDX:
0014F6 E227 FD7E01          19      LD  A,(IY+1)    ;(FCB)主ファイル名
0014F9 E22A CD56DE          17      CALL    CAP
0014FC E22D FE41             7      CP  'A'
0014FE E22F C9              10      RET
                                
                                                ;Read random block
       E230                     _SYS27:     ;(BDOS)ランダムブロック読み込み
0014FF E230 225DF0          16      LD  (LEFTX),HL
001502 E233 CD28DC          17      CALL    SETDRV
                                
001505 E236 FDCB0D66        20      BIT 4,(IY+13)   ;(FCB)属性(アトリビュート)
001509 E23A C2C3E2          10      JP  NZ,RBRDIR   ;ディレクトリ
00150C E23D CDD5E2          17      CALL    RBX0
00150F E240 DA0AE2          10      JP  C,RBRERR
001512 E243 CDE4E2          17      CALL    RBX1
001515 E246 D4FCE2          17      CALL    NC,RBX1R
001518 E249 DAFEE1          10      JP  C,RBRERR1
00151B E24C EB               4      EX  DE,HL
00151C E24D ED52            15      SBC HL,DE       ;CP 00HL,BCDE
00151E E24F 19              11      ADD HL,DE
00151F E250 79               4      LD  A,C
001520 E251 DE00             7      SBC A,0
001522 E253 78               4      LD  A,B
001523 E254 DE00             7      SBC A,0
001525 E256 3801            12      JR  C,RBR1
001527 E258 EB               4      EX  DE,HL
       E259                     RBR1:
001528 E259 9F               4      SBC A,A
001529 E25A E601             7      AND 1
00152B E25C 32C1E2          13      LD  (RBRAP+1),A
                                
00152E E25F 7C               4      LD  A,H
00152F E260 B5               4      OR  L
001530 E261 2857            12      JR  Z,RBREND0
                                
001532 E263 227DE3          16      LD  (RBSIZE),HL ;HL←読み込むレコード数
001535 E266 225DF0          16      LD  (LEFTX),HL
                                
001538 E269 CD04E3          17      CALL    RBX2
00153B E26C 2819            12      JR  Z,RBRB
00153D E26E CD23E3          17      CALL    RBXA
001540 E271 DA0AE2          10      JP  C,RBRERR
001543 E274 C5              11      PUSH    BC
001544 E275 EDB0                    LDIR
001546 E277 ED535FF0        20      LD  (DTAX),DE
00154A E27B 2A5DF0          16      LD  HL,(LEFTX)
00154D E27E D1              10      POP DE
00154E E27F A7               4      AND A
00154F E280 ED52            15      SBC HL,DE
001551 E282 225DF0          16      LD  (LEFTX),HL
001554 E285 2830            12      JR  Z,RBREND
                                
       E287                     RBRB:
001556 E287 CD58E3          17      CALL    RBXB
001559 E28A 2815            12      JR  Z,RBRC
       E28C                     RBRB1:
00155B E28C C5              11      PUSH    BC
00155C E28D D5              11      PUSH    DE
00155D E28E CD31DE          17      CALL    CLUSTX
001560 E291 CDADE3          17      CALL    DRDC
001563 E294 D1              10      POP DE
001564 E295 C1              10      POP BC
001565 E296 D4A5E5          17      CALL    NC,GNCLX
001568 E299 DA0AE2          10      JP  C,RBRERR
00156B E29C 10EE            13      DJNZ    RBRB1
00156D E29E CDF7E3          17      CALL    DRW_FLUSH
       E2A1                     RBRC:
001570 E2A1 CD70E3          17      CALL    RBXC
001573 E2A4 2811            12      JR  Z,RBREND
001575 E2A6 C5              11      PUSH    BC
001576 E2A7 CD31DE          17      CALL    CLUSTX
001579 E2AA CD10E4          17      CALL    DRDX
00157C E2AD C1              10      POP BC
00157D E2AE DA0AE2          10      JP  C,RBRERR
001580 E2B1 EB               4      EX  DE,HL
001581 E2B2 2A7EF1          16      LD  HL,(_DTBUF)
001584 E2B5 EDB0                    LDIR
       E2B7                     RBREND:
001586 E2B7 CD7CE3          17      CALL    RBXEND
       E2BA                     RBREND0:
001589 E2BA FDE1            14      POP IY
00158B E2BC C1              10      POP BC
00158C E2BD D1              10      POP DE
00158D E2BE F1              10      POP AF  ;(HL)
00158E E2BF AF               4      XOR A
00158F E2C0 3E00             7  RBRAP:  LD  A,000H
001591 E2C2 C9              10      RET
                                
       E2C3                     RBRDIR:
001592 E2C3 FD6E1A          19      LD  L,(IY+26)   ;(FCB)ファイルの先頭クラスタ
001595 E2C6 FD661B          19      LD  H,(IY+27)
001598 E2C9 CD6CDE          17      CALL    CHDIR
00159B E2CC AF               4      XOR A
00159C E2CD 67               4      LD  H,A
00159D E2CE 6F               4      LD  L,A
00159E E2CF 3C               4      INC A
00159F E2D0 32C1E2          13      LD  (RBRAP+1),A
0015A2 E2D3 18E5            12      JR  RBREND0
                                
       E2D5                     RBX0:
0015A4 E2D5 2A8AF0          16      LD  HL,(_DTA)
0015A7 E2D8 225FF0          16      LD  (DTAX),HL
0015AA E2DB 2A5DF0          16      LD  HL,(LEFTX)
0015AD E2DE FD7E1C          19      LD  A,(IY+28)   ;(FCB)オープンモード
0015B0 E2E1 D6FD             7      SUB 0FDH
0015B2 E2E3 C9              10      RET
                                
       E2E4                     RBX1:               ;ファイルサイズとランダムレコードを比べる
0015B3 E2E4 E5              11      PUSH    HL      ;Record byte
                                                ;AHL=File size
0015B4 E2E5 FD6E10          19      LD  L,(IY+16)   ;ファイルのサイズ(バイト単位)
0015B7 E2E8 FD6611          19      LD  H,(IY+17)   ;
0015BA E2EB FD7E12          19      LD  A,(IY+18)   ;
                                
0015BD E2EE CD93E3          17      CALL    GET_RR_BCDE ;BCDE=Random record
                                
0015C0 E2F1 A7               4      AND A
0015C1 E2F2 ED52            15      SBC HL,DE
0015C3 E2F4 99               4      SBC A,C
0015C4 E2F5 4F               4      LD  C,A
0015C5 E2F6 FD7E13          19      LD  A,(IY+19)   ;ファイルのサイズ
0015C8 E2F9 98               4      SBC A,B
0015C9 E2FA D1              10      POP DE
0015CA E2FB C9              10      RET
       E2FC                     RBX1R:
0015CB E2FC 47               4      LD  B,A
0015CC E2FD B1               4      OR  C
0015CD E2FE EB               4      EX  DE,HL   ;BCDE=File byte HL=Record byte
0015CE E2FF B2               4      OR  D
0015CF E300 B3               4      OR  E
0015D0 E301 C0              11      RET NZ
0015D1 E302 37               4      SCF
0015D2 E303 C9              10      RET
                                
       E304                     RBX2:               ;Cluster settings
0015D3 E304 FD6622          19      LD  H,(IY+34)   ;(+33)(FCB)ランダムレコード
0015D6 E307 FD4E23          19      LD  C,(IY+35)
0015D9 E30A 0600             7      LD  B,0
0015DB E30C FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
0015DF E310 2003            12      JR  NZ,RBX3
0015E1 E312 FD4624          19      LD  B,(IY+36)
       E315                     RBX3:
0015E4 E315 CD1BE0          17      CALL    RWXR
0015E7 E318 3A3AE3          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
0015EA E31B 3D               4      DEC A
0015EB E31C FDA622          19      AND (IY+34)
0015EE E31F FDB621          19      OR  (IY+33)
0015F1 E322 C9              10      RET
                                
       E323                     RBXA:
0015F2 E323 C5              11      PUSH    BC
0015F3 E324 D5              11      PUSH    DE
0015F4 E325 CD31DE          17      CALL    CLUSTX
0015F7 E328 CD10E4          17      CALL    DRDX
0015FA E32B D1              10      POP DE
0015FB E32C C1              10      POP BC
0015FC E32D D4A5E5          17      CALL    NC,GNCLX
0015FF E330 D8              11      RET C
001600 E331 ED53FEF1        20      LD  (_CLPS),DE
                                
001604 E335 FD4E21          19      LD  C,(IY+33)   ;(FCB)ランダムレコード
001607 E338 210004          10  SECSZ:  LD  HL,0400H    ;自己書き換え 1024=0400H / 512=0200H ここに1セクタのサイズが格納される
00160A E33B 7C               4      LD  A,H
00160B E33C 3D               4      DEC A       ;1024=3 / 512=1
00160C E33D FDA622          19      AND (IY+34)     ;(FCB)ランダムレコード
00160F E340 47               4      LD  B,A     ;BCに1セクタ以下の端数が入る
001610 E341 ED42            15      SBC HL,BC       ;残りを計算
                                
001612 E343 ED5B5DF0        20      LD  DE,(LEFTX)
001616 E347 ED52            15      SBC HL,DE       ;CP HL,DE
001618 E349 19              11      ADD HL,DE       ;
001619 E34A 3801            12      JR  C,RBXA1     ;DEとHLを比較して大きい方をHLに
00161B E34C EB               4      EX  DE,HL
       E34D                     RBXA1:
00161C E34D E5              11      PUSH    HL
00161D E34E 2A7EF1          16      LD  HL,(_DTBUF)
001620 E351 09              11      ADD HL,BC
001621 E352 ED5B5FF0        20      LD  DE,(DTAX)
001625 E356 C1              10      POP BC
001626 E357 C9              10      RET
                                
       E358                     RBXB:
001627 E358 2A5FF0          16      LD  HL,(DTAX)
00162A E35B ED5BFEF1        20      LD  DE,(_CLPS)
00162E E35F 3A5EF0          13      LD  A,(LEFTX+1)
001631 E362 47               4      LD  B,A
001632 E363 3A3AE3          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
       E366                     RBXB1:
001635 E366 1F               4      RRA     ;->CF
001636 E367 3804            12      JR  C,RBXB2
001638 E369 CB38             8      SRL B   ;B=B/2
00163A E36B 18F9            12      JR  RBXB1
       E36D                     RBXB2:
00163C E36D 78               4      LD  A,B
00163D E36E B7               4      OR  A
00163E E36F C9              10      RET
                                
       E370                     RBXC:
00163F E370 ED4B5DF0        20      LD  BC,(LEFTX)
001643 E374 3A3AE3          13      LD  A,(SECSZ+2) ;1024=4 / 512=2 / 256=1
001646 E377 3D               4      DEC A
001647 E378 A0               4      AND B
001648 E379 47               4      LD  B,A     ;1セクタ以下の端数がない場合はZ
001649 E37A B1               4      OR  C
00164A E37B C9              10      RET
                                
       E37C                     RBXEND:             ;レコード数だけランダムレコードを進める
00164B E37C 110000          10      LD  DE,0        ;進めるレコード数(RBSIZE)
       E37D                     RBSIZE  EQU $-2
00164E E37F CDCAE0          17      CALL    GET_RR_AHL
001651 E382 19              11      ADD HL,DE
001652 E383 CE00             7      ADC A,0
001654 E385 CDD4E0          17      CALL    SET_RR_AHL
001657 E388 EB               4      EX  DE,HL       ;HL=進めるレコード数
001658 E389 D0              11      RET NC
001659 E38A FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
00165D E38E C0              11      RET NZ
00165E E38F FD3424          23      INC (IY+36)
001661 E392 C9              10      RET
                                
       E393                     GET_RR_BCDE:            ;BCDE=Random record
001662 E393 FD5E21          19      LD  E,(IY+33)   ;(FCB)ランダムレコード
001665 E396 FD5622          19      LD  D,(IY+34)
001668 E399 FD4E23          19      LD  C,(IY+35)
00166B E39C 0600             7      LD  B,0     ;CP/M互換のアクセスの場合はFCBは36バイト
00166D E39E FDCB207E        20      BIT 7,(IY+32)   ;(FCB)カレントレコード
001671 E3A2 C0              11      RET NZ
001672 E3A3 FD4624          19      LD  B,(IY+36)
001675 E3A6 C9              10      RET
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめる
                                
       E3A7                     DWTC:
001676 E3A7 E5              11      PUSH    HL
001677 E3A8 2137E7          10      LD  HL,DWT24B
00167A E3AB 1804            12      JR  DWTC1
       E3AD                     DRDC:
00167C E3AD E5              11      PUSH    HL
00167D E3AE 2127E7          10      LD  HL,DRD24B
       E3B1                     DWTC1:
001680 E3B1 220BE4          16      LD  (DRWF_MODE),HL
001683 E3B4 E1              10      POP HL
001684 E3B5 3AFBE3          13      LD  A,(DRWF_B)
001687 E3B8 B7               4      OR  A
001688 E3B9 200F            12      JR  NZ,DRDC1
       E3BB                     SAVE_DRWC:
00168A E3BB 0601             7      LD  B,1
00168C E3BD ED43FAE3        20      LD  (DRWF_C),BC
001690 E3C1 ED5301E4        20      LD  (DRWF_E),DE
001694 E3C5 2204E4          16      LD  (DRWF_HL),HL
001697 E3C8 1820            12      JR  INC_HL_DRWC
       E3CA                     DRDC1:
001699 E3CA E5              11      PUSH    HL
00169A E3CB 2101E4          10      LD  HL,DRWF_E
00169D E3CE 86               7      ADD A,(HL)
00169E E3CF F5              11      PUSH    AF
00169F E3D0 BB               4      CP  E
0016A0 E3D1 201D            12      JR  NZ,DRDC2
0016A2 E3D3 F1              10      POP AF
0016A3 E3D4 23               6      INC HL
0016A4 E3D5 7E               7      LD  A,(HL)
0016A5 E3D6 CE00             7      ADC A,0
0016A7 E3D8 F5              11      PUSH    AF
0016A8 E3D9 BA               4      CP  D
0016A9 E3DA 2014            12      JR  NZ,DRDC2
0016AB E3DC F1              10      POP AF
0016AC E3DD 3AFAE3          13      LD  A,(DRWF_C)
0016AF E3E0 CE00             7      ADC A,0
0016B1 E3E2 B9               4      CP  C
0016B2 E3E3 200C            12      JR  NZ,DRDC3
0016B4 E3E5 21FBE3          10      LD  HL,DRWF_B
0016B7 E3E8 34              11      INC (HL)
0016B8 E3E9 E1              10      POP HL
       E3EA                     INC_HL_DRWC:
0016B9 E3EA 3A3AE3          13      LD  A,(SECSZ+2)     ;1セクタのサイズの上位1バイト
0016BC E3ED 84               4      ADD A,H
0016BD E3EE 67               4      LD  H,A
0016BE E3EF C9              10      RET
       E3F0                     DRDC2:
0016BF E3F0 F1              10      POP AF
       E3F1                     DRDC3:
0016C0 E3F1 CDF7E3          17      CALL    DRW_FLUSH
0016C3 E3F4 E1              10      POP HL
0016C4 E3F5 18C4            12      JR  SAVE_DRWC
                                
                                ;   ランダムブロックアクセスの連続したセクタをまとめたものをフラッシュする
       E3F7                     DRW_FLUSH:
0016C6 E3F7 C5              11      PUSH    BC
0016C7 E3F8 D5              11      PUSH    DE
0016C8 E3F9 010000          10      LD  BC,0
       E3FA                     DRWF_C  EQU $-2
       E3FB                     DRWF_B  EQU $-1
0016CB E3FC 78               4      LD  A,B
0016CC E3FD B7               4      OR  A
0016CD E3FE 280D            12      JR  Z,DRDF1
0016CF E400 110000          10      LD  DE,0
       E401                     DRWF_E  EQU $-2
       E402                     DRWF_D  EQU $-1
0016D2 E403 210000          10      LD  HL,0
       E404                     DRWF_HL EQU $-2
0016D5 E406 AF               4      XOR A
0016D6 E407 32FBE3          13      LD  (DRWF_B),A
0016D9 E40A CD27E7          17      CALL    DRD24B
       E40B                     DRWF_MODE   EQU $-2
       E40D                     DRDF1:
0016DC E40D D1              10      POP DE
0016DD E40E C1              10      POP BC
0016DE E40F C9              10      RET
[EOF:LDFILE2.ASM:SHIFT_JIS]
                                    INCLUDE "LDDIO.ASM"
                                
                                ;   LSX-Dodgers DIO
                                
       E410                     DRDX:
0016DF E410 CD4EE4          17      CALL    DRDY
0016E2 E413 C8              11      RET Z
0016E3 E414 CD34E4          17      CALL    DRDX1       ;データバッファの情報を保存
0016E6 E417 D8              11      RET C
0016E7 E418 E5              11      PUSH    HL
0016E8 E419 C5              11      PUSH    BC
0016E9 E41A D5              11      PUSH    DE
0016EA E41B 2A7EF1          16      LD  HL,(_DTBUF)
0016ED E41E 3A77E4          13      LD  A,(_DBS24)
0016F0 E421 4F               4      LD  C,A
0016F1 E422 CD25E7          17      CALL    DRD24
0016F4 E425 DC49E4          17      CALL    C,DRDNE
       E428                     POP_DE_BC_HL_RET:
0016F7 E428 D1              10      POP DE
0016F8 E429 C1              10      POP BC
0016F9 E42A E1              10      POP HL
0016FA E42B C9              10      RET
                                
                                ;   CDE:セクタ番号
       E42C                     DRDN:
0016FB E42C AF               4      XOR A
0016FC E42D 00               4  DRDN1:  NOP         ;自己書き換え NOP / SCF
0016FD E42E 30E0            12      JR  NC,DRDX
       E430                     DRDNX:
0016FF E430 CD4EE4          17      CALL    DRDY
001702 E433 C8              11      RET Z
       E434                     DRDX1:
001703 E434 CD64E4          17      CALL    DWTX
                                                ;データバッファの読み込んだドライブ・セクタ情報を保存
001706 E437 ED53A6F0        20      LD  (_DBSEC),DE
00170A E43B 79               4      LD  A,C
00170B E43C 3277E4          13      LD  (_DBS24),A
                                
00170E E43F 3A88F0          13      LD  A,(_DRV)
001711 E442 32A5F0          13      LD  (_DBDRV),A
001714 E445 CDD9F0          17      CALL    _CHGDRV
001717 E448 D0              11      RET NC
       E449                     DRDNE:
001718 E449 9F               4      SBC A,A     ;CF=1ならばA=0FFH
001719 E44A 32A5F0          13      LD  (_DBDRV),A
00171C E44D C9              10      RET
                                
                                ;   CDE:セクタ番号
       E44E                     DRDY:
00171D E44E 3A77E4          13      LD  A,(_DBS24)
001720 E451 B9               4      CP  C
001721 E452 C0              11      RET NZ
                                
001722 E453 E5              11      PUSH    HL
001723 E454 3A88F0          13      LD  A,(_DRV)
001726 E457 21A5F0          10      LD  HL,_DBDRV
001729 E45A AE               7      XOR (HL)
00172A E45B 2005            12      JR  NZ,POP_HL_RET
                                
00172C E45D 2AA6F0          16      LD  HL,(_DBSEC)
00172F E460 ED52            15      SBC HL,DE       ;上でXORを使っているのでCF=0のはず
       E462                     POP_HL_RET:
001731 E462 E1              10      POP HL
001732 E463 C9              10      RET
                                
       E464                     DWTX:
001733 E464 3AA4F0          13      LD  A,(_WTDBF)
001736 E467 B7               4      OR  A
001737 E468 C8              11      RET Z
001738 E469 AF               4      XOR A
001739 E46A 32A4F0          13      LD  (_WTDBF),A
                                
00173C E46D E5              11      PUSH    HL
00173D E46E C5              11      PUSH    BC
00173E E46F D5              11      PUSH    DE
00173F E470 3AA5F0          13      LD  A,(_DBDRV)
001742 E473 CDD9F0          17      CALL    _CHGDRV
001745 E476 0E00             7      LD  C,0
       E477                     _DBS24  EQU $-1
001747 E478 ED5BA6F0        20      LD  DE,(_DBSEC)
00174B E47C 2A7EF1          16      LD  HL,(_DTBUF)
00174E E47F D435E7          17      CALL    NC,DWT24
       E482                     POP_DE_BC_HL_RET2:
001751 E482 18A4            12      JR  POP_DE_BC_HL_RET
                                
       E484                     RDFATX:
001753 E484 E5              11      PUSH    HL
001754 E485 3A88F0          13      LD  A,(_DRV)
001757 E488 21AAF0          10      LD  HL,_FATDRV
00175A E48B AE               7      XOR (HL)
00175B E48C 28D4            12      JR  Z,POP_HL_RET
                                
00175D E48E C5              11      PUSH    BC
00175E E48F D5              11      PUSH    DE
00175F E490 DDE5            15      PUSH    IX
001761 E492 CDAEE4          17      CALL    WTFATX
001764 E495 3813            12      JR  C,POP_IX_DE_BC_HL_RET
                                
001766 E497 AF               4      XOR A
001767 E498 32ABF0          13      LD  (_FATIX),A
00176A E49B 3A88F0          13      LD  A,(_DRV)
00176D E49E 32AAF0          13      LD  (_FATDRV),A
001770 E4A1 CDE5F0          17      CALL    _RDFAT
       E4A4                     RDFATE2:
001773 E4A4 3004            12      JR  NC,POP_IX_DE_BC_HL_RET
001775 E4A6 9F               4      SBC A,A     ;A=0xFF
001776 E4A7 32AAF0          13      LD  (_FATDRV),A
       E4AA                     POP_IX_DE_BC_HL_RET:
001779 E4AA DDE1            14      POP IX
00177B E4AC 18D4            12      JR  POP_DE_BC_HL_RET2
                                
       E4AE                     WTFATX:
00177D E4AE 3AA2F0          13      LD  A,(_WTFATF)
001780 E4B1 B7               4      OR  A
001781 E4B2 C8              11      RET Z
001782 E4B3 E5              11      PUSH    HL
001783 E4B4 3AAAF0          13      LD  A,(_FATDRV)
001786 E4B7 21A5F0          10      LD  HL,_DBDRV
001789 E4BA AE               7      XOR (HL)
00178A E4BB CC64E4          17      CALL    Z,DWTX
00178D E4BE 38A2            12      JR  C,POP_HL_RET
00178F E4C0 C5              11      PUSH    BC
001790 E4C1 D5              11      PUSH    DE
001791 E4C2 DDE5            15      PUSH    IX
001793 E4C4 CD42E7          17      CALL    WTFAT
001796 E4C7 AF               4      XOR A
001797 E4C8 32A2F0          13      LD  (_WTFATF),A
00179A E4CB 18DD            12      JR  POP_IX_DE_BC_HL_RET
                                
       E4CD                     NCL1:
00179C E4CD 7A               4      LD  A,D
00179D E4CE B3               4      OR  E
00179E E4CF 37               4      SCF
00179F E4D0 C8              11      RET Z
                                
0017A0 E4D1 7A               4      LD  A,D
0017A1 E4D2 CB3F             8      SRL A   ;/2
0017A3 E4D4 CB3F             8      SRL A   ;/2
                                
0017A5 E4D6 E5              11      PUSH    HL
0017A6 E4D7 32F6E4          13      LD  (NCLPAT_FATIX),A    ;_FATIX
0017A9 E4DA 2AAAF0          16      LD  HL,(_FATDRV)    ;L=_FATDRV H=_FATIX
0017AC E4DD BC               4      CP  H
0017AD E4DE 3A88F0          13      LD  A,(_DRV)    ;LDではフラグは変化しない
0017B0 E4E1 32F5E4          13      LD  (NCLPAT_FATDRV),A   ;_FATDRV
0017B3 E4E4 2005            12      JR  NZ,NCL2     ;FATIXが違う
0017B5 E4E6 BD               4      CP  L
0017B6 E4E7 2002            12      JR  NZ,NCL2     ;ドライブが違う
0017B8 E4E9 E1              10      POP HL
0017B9 E4EA C9              10      RET
       E4EB                     NCL2:
0017BA E4EB C5              11      PUSH    BC
0017BB E4EC D5              11      PUSH    DE
0017BC E4ED DDE5            15      PUSH    IX
0017BE E4EF CDAEE4          17      CALL    WTFATX
0017C1 E4F2 38B6            12      JR  C,POP_IX_DE_BC_HL_RET
0017C3 E4F4 010000          10      LD  BC,0        ;自己書き換え C=_FATDRV B=_FATIX
       E4F6                     NCLPAT_FATIX    EQU $-1
       E4F5                     NCLPAT_FATDRV   EQU $-2
0017C6 E4F7 ED43AAF0        20      LD  (_FATDRV),BC
0017CA E4FB CD17E7          17      CALL    RDFATS
0017CD E4FE 18A4            12      JR  RDFATE2
                                
       E500                     NCL3:
0017CF E500 CB9A             8      RES 3,D
0017D1 E502 CB92             8      RES 2,D
0017D3 E504 6B               4      LD  L,E
0017D4 E505 62               4      LD  H,D
0017D5 E506 CB3C             8      SRL H   ;
0017D7 E508 CB1D             8      RR  L   ;HLA=HLA/2
0017D9 E50A 1F               4      RRA     ;
0017DA E50B F5              11      PUSH    AF
0017DB E50C 3AABF0          13      LD  A,(_FATIX)
0017DE E50F 0F               4      RRCA
0017DF E510 300B            12      JR  NC,NCL3X1
0017E1 E512 3A3AE3          13      LD  A,(SECSZ+2)
0017E4 E515 FE04             7      CP  4       ;1セクタ1024バイトの場合は奇数インデックスの場合に先頭を512バイトずらす
0017E6 E517 2004            12      JR  NZ,NCL3X1
0017E8 E519 010002          10      LD  BC,512
0017EB E51C 09              11      ADD HL,BC
       E51D                     NCL3X1:
0017EC E51D F1              10      POP AF
0017ED E51E ED4B7CF1        20      LD  BC,(_FATBF)
0017F1 E522 19              11      ADD HL,DE
0017F2 E523 09              11      ADD HL,BC
0017F3 E524 17               4      RLA
0017F4 E525 C9              10      RET
                                
       E526                     GNCL:
0017F5 E526 CDCDE4          17      CALL    NCL1        ;GET NEXT CLUSTER
0017F8 E529 D8              11      RET C
0017F9 E52A C5              11      PUSH    BC
0017FA E52B E5              11      PUSH    HL
0017FB E52C CD00E5          17      CALL    NCL3
0017FE E52F 3809            12      JR  C,GNC1
001800 E531 5E               7      LD  E,(HL)
001801 E532 23               6      INC HL
001802 E533 7E               7      LD  A,(HL)
001803 E534 E60F             7      AND 00FH
001805 E536 57               4      LD  D,A
001806 E537 E1              10      POP HL
001807 E538 C1              10      POP BC
001808 E539 C9              10      RET
       E53A                     GNC1:
001809 E53A 7E               7      LD  A,(HL)
00180A E53B 23               6      INC HL
00180B E53C 56               7      LD  D,(HL)
00180C E53D 0604             7      LD  B,4
       E53F                     GNC1L:
00180E E53F CB3A             8      SRL D   ;DA=DA/2
001810 E541 1F               4      RRA     ;
001811 E542 10FB            13      DJNZ    GNC1L
                                
001813 E544 5F               4      LD  E,A
001814 E545 E1              10      POP HL
001815 E546 C1              10      POP BC
001816 E547 A7               4      AND A
001817 E548 C9              10      RET
                                
       E549                     SNCL:
001818 E549 CDCDE4          17      CALL    NCL1
00181B E54C D8              11      RET C
                                ;               SET NEXT CLUSTER
00181C E54D E5              11      PUSH    HL
00181D E54E C5              11      PUSH    BC
00181E E54F D5              11      PUSH    DE
00181F E550 E5              11      PUSH    HL
001820 E551 CD00E5          17      CALL    NCL3
001823 E554 D1              10      POP DE
                                ;CF=ODD
001824 E555 7E               7      LD  A,(HL)
001825 E556 73               7      LD  (HL),E
001826 E557 3806            12      JR  C,SNC1
                                ;EVEN
                                ;M[0] = E
                                ;M[1] = (M[1] & 0xF0) | (D & 0x0F)
001828 E559 23               6      INC HL
001829 E55A ED67            18      RRD     ;M={A[3:0],E[3:0]}
00182B E55C 7A               4      LD  A,D
00182C E55D 1804            12      JR  SNC11
       E55F                     SNC1:
                                ;ODD
                                ;HL[0] = (HL[0]&0x0F) | (E<<4)
                                ;HL[1] = DE>>4
00182E E55F ED6F            18      RLD     ;M={D[3:0],E[7:4]}
001830 E561 23               6      INC HL
001831 E562 72               7      LD  (HL),D  ;M={D[3:0],E[7:4]}
       E563                     SNC11:
001832 E563 ED6F            18      RLD     ;M={M[7:4],D[3:0]}
001834 E565 B7               4      OR  A
001835 E566 D1              10      POP DE
001836 E567 C1              10      POP BC
001837 E568 E1              10      POP HL
       E569                     FAT_CHANGED:
001838 E569 3E01             7      LD  A,1
00183A E56B 32A2F0          13      LD  (_WTFATF),A
00183D E56E C9              10      RET
                                
       E56F                     N16CL3:
00183E E56F C5              11      PUSH    BC
00183F E570 6B               4      LD  L,E
001840 E571 7A               4      LD  A,D
001841 E572 E603             7      AND 3
001843 E574 67               4      LD  H,A
001844 E575 29              11      ADD HL,HL
001845 E576 ED4B7CF1        20      LD  BC,(_FATBF)
001849 E57A 09              11      ADD HL,BC
00184A E57B C1              10      POP BC
00184B E57C C9              10      RET
                                
       E57D                     GNCL16:
00184C E57D CDCDE4          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
00184F E580 D8              11      RET C
001850 E581 E5              11      PUSH    HL
001851 E582 CD6FE5          17      CALL    N16CL3
001854 E585 5E               7      LD  E,(HL)
001855 E586 23               6      INC HL
001856 E587 56               7      LD  D,(HL)
001857 E588 E1              10      POP HL
001858 E589 C9              10      RET
                                
       E58A                     SNCL16:
001859 E58A CDCDE4          17      CALL    NCL1        ;GET NEXT CLUSTER for FAT16
00185C E58D D8              11      RET C
00185D E58E D5              11      PUSH    DE
00185E E58F E5              11      PUSH    HL
00185F E590 CD6FE5          17      CALL    N16CL3
001862 E593 D1              10      POP DE      ;HL
001863 E594 73               7      LD  (HL),E
001864 E595 23               6      INC HL
001865 E596 72               7      LD  (HL),D
001866 E597 6B               4      LD  L,E
001867 E598 62               4      LD  H,D
001868 E599 D1              10      POP DE
001869 E59A 18CD            12      JR  FAT_CHANGED
                                
                                ;------------------------
                                ;次のセクタを探す際に_SECPSの値をチェック
                                ;in
                                ;   DE : セクタ番号
                                ;out
                                ;   DE : 次のセクタ番号
                                ;note
                                ;
                                ;------------------------
       E59C                     NEXTX:
00186B E59C 3E00             7      LD  A,0 ;自己書き換え
       E59D                     _SECPS  EQU $-1
00186D E59E 3C               4      INC A
00186E E59F E600             7      AND 0   ;自己書き換え　1クラスタの論理セクタ数-1
       E5A0                     _NCPAT  EQU $-1
001870 E5A1 329DE5          13      LD  (_SECPS),A
001873 E5A4 C9              10      RET
                                
       E5A5                     GNCLX:
001874 E5A5 CD9CE5          17      CALL    NEXTX
001877 E5A8 C0              11      RET NZ  ;1クラスタのセクタ未満の場合は戻る
001878 E5A9 C3F7F0          10      JP  _GNCL   ;次のクラスタを探す
                                
       E5AC                     RDFAT:
00187B E5AC 3E80             7      LD  A,080H
00187D E5AE 3270F0          13      LD  (CHECK),A
       E5B1                     RDFAT1:
001880 E5B1 3A88F0          13      LD  A,(_DRV)
001883 E5B4 CD60E8          17      CALL    CHGDRVR
001886 E5B7 D8              11      RET C
001887 E5B8 DD7E12          19      LD  A,(IX+DPB_DEVICE)
00188A E5BB CB6F             8      BIT 5,A
00188C E5BD 2868            12      JR  Z,RDFAT0X
00188E E5BF 2170F0          10      LD  HL,CHECK
001891 E5C2 A6               7      AND (HL)
001892 E5C3 77               7      LD  (HL),A
001893 E5C4 110000          10      LD  DE,0        ;BPB
001896 E5C7 2A7CF1          16      LD  HL,(_FATBF)
001899 E5CA CD23E7          17      CALL    DRD16
00189C E5CD 3024            12      JR  NC,GETBPB
00189E E5CF 2170F0          10      LD  HL,CHECK
0018A1 E5D2 CB06            15      RLC (HL)
0018A3 E5D4 3F               4      CCF
0018A4 E5D5 D8              11      RET C
0018A5 E5D6 DDCB0A1E        23      RR  (IX+DPB_FDMODE)
0018A9 E5DA 3F               4      CCF         ;フロッピーディスクのFDモードを切り替える
0018AA E5DB DDCB0A16        23      RL  (IX+DPB_FDMODE)
0018AE E5DF 3EFF             7      LD  A,0FFH
0018B0 E5E1 3289F0          13      LD  (_DSK),A
0018B3 E5E4 3A84F0          13      LD  A,(_DRIVE)
0018B6 E5E7 E603             7      AND 3
0018B8 E5E9 F680             7      OR  080H
0018BA E5EB 6F               4      LD  L,A
0018BB E5EC 26F0             7      LD  H,_CYL0/256
0018BD E5EE 3EFF             7      LD  A,0FFH
0018BF E5F0 77               7      LD  (HL),A
0018C0 E5F1 18BE            12      JR  RDFAT1
       E5F3                     GETBPB:
0018C2 E5F3 FDE5            15      PUSH    IY
0018C4 E5F5 FD2A7CF1        20      LD  IY,(_FATBF) ;BPB
0018C8 E5F9 CDF1F0          17      CALL    _BPB2DPB
0018CB E5FC FDE1            14      POP IY
0018CD E5FE DD7E12          19      LD  A,(IX+DPB_DEVICE)
0018D0 E601 3021            12      JR  NC,GETBPBOK
0018D2 E603 E60F             7      AND 00FH
0018D4 E605 FE07             7      CP  7
0018D6 E607 37               4      SCF
0018D7 E608 C0              11      RET NZ
0018D8 E609 DDCB0A46        20      BIT 0,(IX+DPB_FDMODE)
0018DC E60D 21C0F1          10      LD  HL,M2D
0018DF E610 2002            12      JR  NZ,SETFDMODE
0018E1 E612 2ED2             7      LD  L,M2HD-STABLE
       E614                     SETFDMODE:
0018E3 E614 DDE5            15      PUSH    IX
0018E5 E616 D1              10      POP DE
0018E6 E617 EDA0            16      LDI
0018E8 E619 EDA0            16      LDI
0018EA E61B 13               6      INC DE
0018EB E61C 13               6      INC DE
0018EC E61D 13               6      INC DE
0018ED E61E 13               6      INC DE
0018EE E61F 010C00          10      LD  BC,12
0018F1 E622 EDB0                    LDIR
       E624                     GETBPBOK:
0018F3 E624 CDCBE7          17      CALL    CHGDRV2
       E627                     RDFAT0X:
0018F6 E627 CD17E7          17      CALL    RDFATS
0018F9 E62A D8              11      RET C
0018FA E62B DDAE06          19      XOR (IX+DPB_FATID)
0018FD E62E C8              11      RET Z
0018FE E62F DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001902 E633 C0              11      RET NZ      ;BPBを取得している場合はFATIDをチェックしない
001903 E634 37               4      SCF
001904 E635 C9              10      RET
                                
       E636                     POP_HL_SCF_RET:
001905 E636 E1              10      POP HL
001906 E637 37               4      SCF
001907 E638 C9              10      RET
                                
       E639                     BPB2DPB:
001908 E639 FD7E0B          19      LD  A,(IY+11)   ;BPB_BytsPerSec
00190B E63C B7               4      OR  A
00190C E63D 37               4      SCF
00190D E63E C0              11      RET NZ
       E63F                     BPBOK:
00190E E63F FD7E0D          19      LD  A,(IY+13)   ;BPB_SecPerClus
001911 E642 DD7707          19      LD  (IX+DPB_SECPCL),A
                                
001914 E645 FD7E16          19      LD  A,(IY+22)   ;BPB_FATSz16
001917 E648 DD7700          19      LD  (IX+DPB_FATLN),A
00191A E64B FD7E17          19      LD  A,(IY+23)   ;BPB_FATSz16
00191D E64E DD7701          19      LD  (IX+DPB_FATLN+1),A
                                
001920 E651 FD6E0E          19      LD  L,(IY+14)   ;BPB_RsvdSecCnt
001923 E654 FD660F          19      LD  H,(IY+15)
001926 E657 DD750E          19      LD  (IX+DPB_FATPS),L
001929 E65A FD5E16          19      LD  E,(IY+22)   ;BPB_FATSz16
00192C E65D FD5617          19      LD  D,(IY+23)
00192F E660 FD4610          19      LD  B,(IY+16)   ;BPB_NumFATs
       E663                     BPBDP1:             ;BPB_FATSz16 * BPB_NumFATs
001932 E663 19              11      ADD HL,DE
001933 E664 10FD            13      DJNZ    BPBDP1
       E666                     BPBDP2:
001935 E666 DD7510          19      LD  (IX+DPB_DIRPS),L
001938 E669 DD7411          19      LD  (IX+DPB_DIRPS+1),H
00193B E66C E5              11      PUSH    HL
                                
00193C E66D FD6E11          19      LD  L,(IY+17)   ;BPB_RootEntCnt
00193F E670 FD6612          19      LD  H,(IY+18)
001942 E673 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
001945 E676 B7               4      OR  A
001946 E677 28BD            12      JR  Z,POP_HL_SCF_RET
001948 E679 0606             7      LD  B,6
       E67B                     BPBBPS1:
00194A E67B 05               4      DEC B
00194B E67C 0F               4      RRCA
00194C E67D 30FC            12      JR  NC,BPBBPS1
       E67F                     BPBDE1:
00194E E67F 29              11      ADD HL,HL
00194F E680 10FD            13      DJNZ    BPBDE1
                                
001951 E682 7C               4      LD  A,H
001952 E683 DD770B          19      LD  (IX+DPB_DIRSCNT),A  ;
                                
001955 E686 D1              10      POP DE      ;DPB_DIRPS
001956 E687 6C               4      LD  L,H
001957 E688 2600             7      LD  H,0
001959 E68A 19              11      ADD HL,DE       ;MAXDIR
00195A E68B E5              11      PUSH    HL
00195B E68C FD4E0D          19      LD  C,(IY+13)   ;BPB_SecPerClus
00195E E68F CB21             8      SLA C       ;*2
001960 E691 AF               4      XOR A
001961 E692 47               4      LD  B,A
001962 E693 ED42            15      SBC HL,BC
001964 E695 DD7514          19      LD  (IX+DPB_ADDCL),L
001967 E698 DD7415          19      LD  (IX+DPB_ADDCL+1),H
                                
00196A E69B D1              10      POP DE      ;DE=DPB_MAXDIR
00196B E69C FD6E13          19      LD  L,(IY+19)   ;BPB_TotSec16
00196E E69F FD6614          19      LD  H,(IY+20)
                                
001971 E6A2 DD7E12          19      LD  A,(IX+DPB_DEVICE)
001974 E6A5 E60F             7      AND 00FH
001976 E6A7 FE07             7      CP  7       ;フロッピー
001978 E6A9 2019            12      JR  NZ,NOT_FD
00197A E6AB E5              11      PUSH    HL
00197B E6AC FD4E18          19      LD  C,(IY+24)   ;BPB_SecPerTr
00197E E6AF DD710D          19      LD  (IX+DPB_MAXSEC),C
001981 E6B2 AF               4      XOR A
001982 E6B3 CB21             8      SLA C       ;両面なのでセクタ数を２倍
001984 E6B5 0610             7      LD  B,16
       E6B7                     DIVSEC:             ;MAXCYL = BPB_TotSec16 / (BPB_SecPerTr * 2)
001986 E6B7 29              11      ADD HL,HL
001987 E6B8 17               4      RLA
001988 E6B9 B9               4      CP  C
001989 E6BA 3802            12      JR  C,DIVSEC1
00198B E6BC 91               4      SUB C
00198C E6BD 2C               4      INC L
       E6BE                     DIVSEC1:
00198D E6BE 10F7            13      DJNZ    DIVSEC
00198F E6C0 DD750C          19      LD  (IX+DPB_MAXCYL),L
001992 E6C3 E1              10      POP HL  ;ここまでフロッピー専用
       E6C4                     NOT_FD:
001993 E6C4 7C               4      LD  A,H
001994 E6C5 B5               4      OR  L
001995 E6C6 3E00             7      LD  A,0     ;LDでフラグは変化しない。BPB_TotSec16を AHL で扱う為、Aに0を入れる
001997 E6C8 2010            12      JR  NZ,BPB16BIT ;BPB_TotSec16が「0」の場合はBPB_TotSec32で計算
001999 E6CA FD7E23          19      LD  A,(IY+35)   ;念のために総セクタ数が24ビットを超える場合はエラーを返す
00199C E6CD B7               4      OR  A
00199D E6CE 37               4      SCF
00199E E6CF C0              11      RET NZ
00199F E6D0 FD6E20          19      LD  L,(IY+32)   ;BPB_TotSec32 は AHL の24ビットで扱う
0019A2 E6D3 FD6621          19      LD  H,(IY+33)   ;1クラスタの論理セクタ数(DPB_SECPCL)が最大128なので
0019A5 E6D6 FD7E22          19      LD  A,(IY+34)   ;24ビットを超えると必ずクラスタ数が16ビットを超えてしまうのでこれで十分
0019A8 E6D9 A7               4      AND A       ;CF=0
       E6DA                     BPB16BIT:
0019A9 E6DA ED52            15      SBC HL,DE
0019AB E6DC DE00             7      SBC A,0
0019AD E6DE FD460D          19      LD  B,(IY+13)   ;BPB_SecPerClus
       E6E1                     BPBTC1:             ;総クラスタ数(AHL) = 総セクタ数(AHL) / セクタサイズ(B)
0019B0 E6E1 CB18             8      RR  B       ;->CY
0019B2 E6E3 3808            12      JR  C,BPBTC2
0019B4 E6E5 CB3F             8      SRL A
0019B6 E6E7 CB1C             8      RR  H       ;AHL=AHL/2
0019B8 E6E9 CB1D             8      RR  L
0019BA E6EB 18F4            12      JR  BPBTC1
       E6ED                     BPBTC2:
0019BC E6ED B7               4      OR  A
0019BD E6EE 37               4      SCF
0019BE E6EF C0              11      RET NZ      ;念のため(クラスタ数が16ビットを超える場合)
0019BF E6F0 23               6      INC HL
0019C0 E6F1 23               6      INC HL
0019C1 E6F2 DD7508          19      LD  (IX+DPB_MAXCL),L
0019C4 E6F5 DD7409          19      LD  (IX+DPB_MAXCL+1),H
                                
0019C7 E6F8 FD7E15          19      LD  A,(IY+21)   ;BPB_Media
0019CA E6FB DD7706          19      LD  (IX+DPB_FATID),A
                                
0019CD E6FE FD7E10          19      LD  A,(IY+16)   ;BPB_NumFATs
0019D0 E701 C6FE             7      ADD A,0-2       ;>2:CF=1
0019D2 E703 FD7E0C          19      LD  A,(IY+12)   ;BPB_BytsPerSec
0019D5 E706 6F               4      LD  L,A
0019D6 E707 3002            12      JR  NC,BPBFAT1
0019D8 E709 F680             7      OR  080H
       E70B                     BPBFAT1:            ;ここではCF=0
0019DA E70B DD770F          19      LD  (IX+DPB_BPS),A
0019DD E70E 2D               4      DEC L       ;以下のセクタサイズに合致しない場合はCF=1でエラーにする
0019DE E70F C8              11      RET Z       ;1セクタ256バイト
0019DF E710 2D               4      DEC L
0019E0 E711 C8              11      RET Z       ;1セクタ512バイト
0019E1 E712 2D               4      DEC L
0019E2 E713 2D               4      DEC L
0019E3 E714 C8              11      RET Z       ;1セクタ1024バイト
0019E4 E715 37               4      SCF
0019E5 E716 C9              10      RET
                                
       E717                     RDFATS:
0019E6 E717 CD5DE7          17      CALL    FATSETUP
0019E9 E71A D8              11      RET C
0019EA E71B CD27E7          17      CALL    DRD24B
0019ED E71E 2A7CF1          16      LD  HL,(_FATBF)
0019F0 E721 7E               7      LD  A,(HL)
0019F1 E722 C9              10      RET
                                
       E723                     DRD16:
0019F2 E723 0E00             7      LD  C,0
       E725                     DRD24:
0019F4 E725 0601             7      LD  B,1
       E727                     DRD24B:
0019F6 E727 DDE5            15      PUSH    IX
0019F8 E729 DD2AA8F0        20      LD  IX,(_DPB)
0019FC E72D CDAEE9          17      CALL    FDRD        ;自己書き換え（ディスク読み込み）
       E72E                     DRDPAT  EQU $-2
       E730                     POP_IX_RET:
0019FF E730 DDE1            14      POP IX
001A01 E732 C9              10      RET
                                
       E733                     DWT16:
001A02 E733 0E00             7      LD  C,0
       E735                     DWT24:
001A04 E735 0601             7      LD  B,1
       E737                     DWT24B:
001A06 E737 DDE5            15      PUSH    IX
001A08 E739 DD2AA8F0        20      LD  IX,(_DPB)
001A0C E73D CD54E9          17      CALL    FDWT        ;自己書き換え（ディスク書き込み）
       E73E                     DWTPAT  EQU $-2
001A0F E740 18EE            12      JR  POP_IX_RET
                                
       E742                     WTFAT:
001A11 E742 CD5DE7          17      CALL    FATSETUP
001A14 E745 D437E7          17      CALL    NC,DWT24B
001A17 E748 D8              11      RET C
001A18 E749 DDCB0F7E        20      BIT 7,(IX+DPB_BPS)
001A1C E74D C8              11      RET Z       ;予備FATが無い
001A1D E74E CD64E7          17      CALL    FATS2
001A20 E751 E5              11      PUSH    HL      ;予備FAT
001A21 E752 DD6E00          19      LD  L,(IX+DPB_FATLN)
001A24 E755 DD6601          19      LD  H,(IX+DPB_FATLN+1)
001A27 E758 19              11      ADD HL,DE
001A28 E759 EB               4      EX  DE,HL
001A29 E75A E1              10      POP HL
001A2A E75B 18DA            12      JR  DWT24B
                                ;------------------------
                                ;FATのセットアップ
                                ;out
                                ;   B  : FATセクタ数
                                ;   DE : FAT先頭セクタ番号
                                ;   HL : FATバッファポインタ
                                ;   CF : 1=ドライブ切り替えエラー
                                ;note
                                ;   FATサイズがFATバッファを超える場合は
                                ;   対象クラスタ領域==(_FATIX)によって
                                ;   FAT12:対象クラスタ1024毎に1.5KBを切り替える
                                ;   FAT16:対象クラスタ1024毎に2KBを切り替える
                                ;------------------------
       E75D                     FATSETUP:
001A2C E75D 3AAAF0          13      LD  A,(_FATDRV)
001A2F E760 CD60E8          17      CALL    CHGDRVR     ;ドライブ切り替え
001A32 E763 D8              11      RET C
       E764                     FATS2:
001A33 E764 DD7E0F          19      LD  A,(IX+DPB_BPS)  ;512=2 1024=4
001A36 E767 0F               4      RRCA
001A37 E768 CD91E7          17      CALL    FATSETUP12  ;自己書き換え
       E769                     FATSX   EQU $-2
001A3A E76B 210000          10      LD  HL,0
001A3D E76E 4A               4      LD  C,D
001A3E E76F 54               4      LD  D,H
001A3F E770 3AABF0          13      LD  A,(_FATIX)  ;範囲FAT12:0-3/FAT16:0-63(0-03FH):65535*2/2048
001A42 E773 47               4      LD  B,A
001A43 E774 04               4      INC B
001A44 E775 DD7E00          19      LD  A,(IX+DPB_FATLN)
       E778                     FAT_SKP:
001A47 E778 05               4      DEC B
001A48 E779 2805            12      JR  Z,FAT1
001A4A E77B 19              11      ADD HL,DE
001A4B E77C 93               4      SUB E
001A4C E77D 30F9            12      JR  NC,FAT_SKP
001A4E E77F C9              10      RET
       E780                     FAT1:
001A4F E780 EB               4      EX  DE,HL
001A50 E781 B9               4      CP  C       ;C=FATバッファに読み込めるセクタ数
001A51 E782 3801            12      JR  C,FAT2
001A53 E784 79               4      LD  A,C
       E785                     FAT2:
001A54 E785 47               4      LD  B,A
                                
001A55 E786 2AFAF1          16      LD  HL,(_FATPS) ;fat sector pos
001A58 E789 19              11      ADD HL,DE
001A59 E78A EB               4      EX  DE,HL
001A5A E78B 2A7CF1          16      LD  HL,(_FATBF)
001A5D E78E AF               4      XOR A       ;CF=0
001A5E E78F 4F               4      LD  C,A
001A5F E790 C9              10      RET
                                ;
                                ;   FATバッファに読み込める最大のセクタ数と_FATIXで進めるセクタ数
                                ;   FATSETUP* (FAT12/FAT16)
                                ;out
                                ;   D : FATバッファに読み込める最大のセクタ数
                                ;   E : _FATIXで進めるセクタ数
       E791                     FATSETUP12:
001A60 E791 110606          10      LD  DE,0606H    ;256
001A63 E794 D8              11      RET C
001A64 E795 110303          10      LD  DE,0303H    ;512
001A67 E798 0F               4      RRCA
001A68 E799 D8              11      RET C
001A69 E79A 110102          10      LD  DE,0201H    ;1024
001A6C E79D C9              10      RET
                                
       E79E                     FATSETUP16:
001A6D E79E 110808          10      LD  DE,0808H    ;256
001A70 E7A1 D8              11      RET C
001A71 E7A2 110404          10      LD  DE,0404H
001A74 E7A5 0F               4      RRCA            ;512
001A75 E7A6 D8              11      RET C
001A76 E7A7 110202          10      LD  DE,0202H    ;1024
001A79 E7AA C9              10      RET
                                
       E7AB                     CHGDRV:
001A7A E7AB E5              11      PUSH    HL
001A7B E7AC 2189F0          10      LD  HL,_DSK
001A7E E7AF BE               7      CP  (HL)
001A7F E7B0 280A            12      JR  Z,CHGDRVE
       E7B2                     CHGDRV1:
001A81 E7B2 DDE5            15      PUSH    IX
001A83 E7B4 CDBEE7          17      CALL    CHGDRV0
001A86 E7B7 3A89F0          13      LD  A,(_DSK)
001A89 E7BA DDE1            14      POP IX
       E7BC                     CHGDRVE:
001A8B E7BC E1              10      POP HL
001A8C E7BD C9              10      RET
                                
       E7BE                     CHGDRV0:
001A8D E7BE 6F               4      LD  L,A
001A8E E7BF CDDCF0          17      CALL    _GETDPB
001A91 E7C2 D8              11      RET C
001A92 E7C3 DD22A8F0        20      LD  (_DPB),IX
001A96 E7C7 7D               4      LD  A,L
001A97 E7C8 3289F0          13      LD  (_DSK),A
       E7CB                     CHGDRV2:
001A9A E7CB C5              11      PUSH    BC
001A9B E7CC D5              11      PUSH    DE
001A9C E7CD ED7316E8        20      LD  (SPPAT2),SP
001AA0 E7D1 F3               4      DI
001AA1 E7D2 DDF9            10      LD  SP,IX
                                
001AA3 E7D4 E1              10      POP HL      ;00:DPB_FATLN
001AA4 E7D5 E1              10      POP HL      ;02:DPB_DRD
001AA5 E7D6 222EE7          16      LD  (DRDPAT),HL
                                
001AA8 E7D9 E1              10      POP HL
001AA9 E7DA 223EE7          16      LD  (DWTPAT),HL ;04:DPB_DWT
                                
001AAC E7DD E1              10      POP HL      ;L=06:DPB_FATID H=07:DPB_SECPCL
001AAD E7DE 7C               4      LD  A,H
001AAE E7DF 3235DE          13      LD  (SPCPAT),A  ;1クラスタの論理セクタ数
001AB1 E7E2 3D               4      DEC A
001AB2 E7E3 32A0E5          13      LD  (_NCPAT),A
                                
001AB5 E7E6 E1              10      POP HL      ;08:DPB_MAXCL
001AB6 E7E7 7D               4      LD  A,L
001AB7 E7E8 3254DE          13      LD  (CLPAT2),A
001ABA E7EB 7C               4      LD  A,H
001ABB E7EC 3250DE          13      LD  (CLPAT1),A
001ABE E7EF 2B               6      DEC HL
001ABF E7F0 2251E0          16      LD  (MAXCLP),HL
                                
001AC2 E7F3 E1              10      POP HL      ;L=0A:DPB_FDMODE H=0B:DPB_DIRSCNT
001AC3 E7F4 4C               4      LD  C,H
                                
001AC4 E7F5 E1              10      POP HL      ;L=0C:DPB_MAXCYL H=0D:DPB_MAXSEC
                                
001AC5 E7F6 E1              10      POP HL      ;L=0E:DPB_FATPS H=0F:DPB_BPS
001AC6 E7F7 7C               4      LD  A,H     ;DPB_BPS
001AC7 E7F8 E607             7      AND 7
001AC9 E7FA 323AE3          13      LD  (SECSZ+2),A ;1セクタのサイズの上位1バイト 0x400 - 0x200 - 0x100
                                                ;1セクタ512 2D/2DD/2HC/2HQ(2HD1.44MB)/EMM/BRAM/EMEM等
                                                ;1セクタ1024 2HD/2HDE98
                                                ;1セクタ256 GRAM/RAMF/CMOS/等
                                                ;1024   512 256
                                                ;4  2   1
001ACC E7FD 87               4      ADD A,A     ;8  4   2
001ACD E7FE 87               4      ADD A,A     ;010H   8   4
001ACE E7FF 87               4      ADD A,A     ;020H   010H    8
001ACF E800 32B2DC          13      LD  (SDECPAT),A ;1セクタ辺りのディレクトリエントリ数
                                
001AD2 E803 2600             7      LD  H,0
001AD4 E805 22FAF1          16      LD  (_FATPS),HL
                                
001AD7 E808 E1              10      POP HL      ;10:DPB_DIRPS
001AD8 E809 22FCF1          16      LD  (_DIRPS),HL
                                
001ADB E80C E1              10      POP HL      ;L=12:DPB_DEVICE H=13:DPB_UNITNO
001ADC E80D 7C               4      LD  A,H
001ADD E80E 3284F0          13      LD  (_DRIVE),A
                                
001AE0 E811 E1              10      POP HL      ;14:DPB_ADDCL
001AE1 E812 2245DE          16      LD  (CLSPAT),HL
                                
001AE4 E815 310000          10      LD  SP,0        ;元のSPを復元
       E816                     SPPAT2  EQU $-2
001AE7 E818 FB               4      EI
001AE8 E819 2AFCF1          16      LD  HL,(_DIRPS)
001AEB E81C 0600             7      LD  B,0
001AED E81E 09              11      ADD HL,BC       ;C=DPB_DIRSCNT
001AEE E81F 22CDDC          16      LD  (MD_PAT),HL
                                
001AF1 E822 2A51E0          16      LD  HL,(MAXCLP);
001AF4 E825 11F60F          10      LD  DE,4086     ;クラスタ数が4086未満:FAT12 4086以上:FAT16
001AF7 E828 ED52            15      SBC HL,DE       ;CF=0のはず
001AF9 E82A 300F            12      JR  NC,SETFAT16
001AFB E82C 2126E5          10      LD  HL,GNCL     ;FAT12
001AFE E82F 1149E5          10      LD  DE,SNCL
001B01 E832 0191E7          10      LD  BC,FATSETUP12
001B04 E835 DDCB0FAE        23      RES 5,(IX+DPB_BPS)  ;DPB_BPS(FAT12)
001B08 E839 180D            12      JR  EXTRA1
       E83B                     SETFAT16:
001B0A E83B 217DE5          10      LD  HL,GNCL16   ;FAT16
001B0D E83E 118AE5          10      LD  DE,SNCL16
001B10 E841 019EE7          10      LD  BC,FATSETUP16
001B13 E844 DDCB0FEE        23      SET 5,(IX+DPB_BPS)  ;DPB_BPS(FAT16)
       E848                     EXTRA1:
001B17 E848 22F8F0          16      LD  (GNCPAT),HL
001B1A E84B ED53FBF0        20      LD  (SNCPAT),DE
001B1E E84F ED4369E7        20      LD  (FATSX),BC
001B22 E853 D1              10      POP DE
001B23 E854 C1              10      POP BC
001B24 E855 AF               4      XOR A
001B25 E856 C9              10      RET
                                
       E857                     GETDPBD:
001B26 E857 DDE3            23      EX  (SP),IX
001B28 E859 DDE5            15      PUSH    IX
001B2A E85B 3A88F0          13      LD  A,(_DRV)
001B2D E85E 1807            12      JR  GETDPB1
                                
       E860                     CHGDRVR:
001B2F E860 CDD9F0          17      CALL    _CHGDRV
001B32 E863 D8              11      RET C
001B33 E864 3A89F0          13      LD  A,(_DSK)
       E867                     GETDPB1:
001B36 E867 C3DCF0          10      JP  _GETDPB
                                
       E86A                     GETDPB:
001B39 E86A FE08             7      CP  8
001B3B E86C 3F               4      CCF
001B3C E86D D8              11      RET C
001B3D E86E 0F               4      RRCA
001B3E E86F 0F               4      RRCA
001B3F E870 0F               4      RRCA
001B40 E871 DD                      DB  0DDH        ;Z80未定義命令
001B41 E872 6F               4      LD  L,A     ;LD IXL,A
001B42 E873 DD                      DB  0DDH        ;Z80未定義命令
001B43 E874 26F2             7      LD  H,_DEVICE/256   ;LD IXH,_DEVICE/256
001B45 E876 DD7E00          19      LD  A,(IX+DPB_FATLN)
001B48 E879 A7               4      AND A       ;CF=0の為
001B49 E87A DDCB0F6E        20      BIT 5,(IX+DPB_BPS)
001B4D E87E C0              11      RET NZ      ;FAT16
001B4E E87F DDCB126E        20      BIT 5,(IX+DPB_DEVICE)
001B52 E883 C0              11      RET NZ      ;BPB
001B53 E884 FE01             7      CP  001H        ;A=0 THEN CF=1
001B55 E886 C9              10      RET
                                
       E887                     _SYS5F:
001B56 E887 AF               4      XOR A
       E888                     FFLUSH:
001B57 E888 F5              11      PUSH    AF
001B58 E889 CDAEE4          17      CALL    WTFATX
001B5B E88C AF               4      XOR A
001B5C E88D 32ABF0          13      LD  (_FATIX),A
001B5F E890 2F               4      CPL         ;0FFH
001B60 E891 32AAF0          13      LD  (_FATDRV),A
001B63 E894 3E                      DB  03EH        ;次のPUSH AFをスキップ
       E895                     FFLUSHBUF:
001B64 E895 F5              11      PUSH    AF
001B65 E896 CD64E4          17      CALL    DWTX
001B68 E899 3EFF             7      LD  A,0FFH
001B6A E89B 3239F0          13      LD  (SFILE),A
001B6D E89E 32A5F0          13      LD  (_DBDRV),A
001B70 E8A1 F1              10      POP AF
001B71 E8A2 C9              10      RET
                                
[EOF:LDDIO.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK.ASM"
                                
                                ;   LSX-Dodgers DISK
                                ;   MZ-700/1500
                                
       E8A3                     SEEK:
001B72 E8A3 0610             7      LD  B,16
001B74 E8A5 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001B77 E8A8 AF               4      XOR A
001B78 E8A9 EB               4      EX  DE,HL
       E8AA                     DIV1:
001B79 E8AA 29              11      ADD HL,HL
001B7A E8AB 8F               4      ADC A,A
001B7B E8AC B9               4      CP  C
001B7C E8AD 3802            12      JR  C,DIV2
001B7E E8AF 91               4      SUB C
001B7F E8B0 2C               4      INC L
       E8B1                     DIV2:
001B80 E8B1 10F7            13      DJNZ    DIV1
                                
001B82 E8B3 3C               4      INC A   ;最小のセクタは１固定
001B83 E8B4 55               4      LD  D,L ;TRACK
001B84 E8B5 5F               4      LD  E,A ;SECTOR
                                
001B85 E8B6 3A84F0          13      LD  A,(_DRIVE)
001B88 E8B9 FE04             7      CP  4
001B8A E8BB 3F               4      CCF
001B8B E8BC D8              11      RET C
001B8C E8BD F684             7      OR  084H        ;Motor on + ドライブセレクト有効
001B8E E8BF D3DC            11      OUT (0DCH),A
001B90 E8C1 CB3A             8      SRL D       ;CYLINDER
001B92 E8C3 9F               4      SBC A,A
001B93 E8C4 D3DD            11      OUT (0DDH),A    ;SIDE
                                
001B95 E8C6 CD02E9          17      CALL    SETMODE
001B98 E8C9 D8              11      RET C
                                
001B99 E8CA CD3EE9          17      CALL    DRIVE
001B9C E8CD FEFF             7      CP  0FFH        ;A=0FFH Unknown CYLINDER
001B9E E8CF CC23E9          17      CALL    Z,FDCRES    ;Restore
001BA1 E8D2 2F               4      CPL         ;データバスが負論理
001BA2 E8D3 D3D9            11      OUT (0D9H),A    ;Currrent CYLINDER
001BA4 E8D5 2F               4      CPL         ;データバスが負論理
001BA5 E8D6 92               4      SUB D
001BA6 E8D7 C8              11      RET Z       ;No seek
                                
001BA7 E8D8 3A86F0          13      LD  A,(_ISEEK)
001BAA E8DB 4F               4      LD  C,A
                                
001BAB E8DC DD7E0C          19      LD  A,(IX+DPB_MAXCYL)
001BAE E8DF 3D               4      DEC A
001BAF E8E0 BA               4      CP  D       ;Over CYLINDER
001BB0 E8E1 D8              11      RET C
                                
001BB1 E8E2 7A               4      LD  A,D
001BB2 E8E3 2F               4      CPL         ;データバスが負論理
001BB3 E8E4 D3DB            11      OUT (0DBH),A
001BB5 E8E6 72               7      LD  (HL),D
                                
001BB6 E8E7 0E18             7      LD  C,018H      ;Seek
       E8E9                     FDCCMD2:
001BB8 E8E9 3A85F0          13      LD  A,(_SEEKSP)
001BBB E8EC B1               4      OR  C
                                
       E8ED                     FDCCMD:
001BBC E8ED CD35E9          17      CALL    COMSET
       E8F1                     FDCSMC  EQU $+1
001BBF E8F0 3E80             7      LD  A,080H      ;FDC COMMAND(Self-modifying code)
001BC1 E8F2 E620             7      AND 020H        ;Write data Write track
001BC3 E8F4 3C               4      INC A
                                
       E8F5                     SST:
001BC4 E8F5 0E00             7      LD  C,0
       E8F7                     SST1:
001BC6 E8F7 0D               4      DEC C       ; 4
001BC7 E8F8 20FD            12      JR  NZ,SST1     ;12 * 256 / 4 = About 1ms
001BC9 E8FA 3D               4      DEC A
001BCA E8FB 20FA            12      JR  NZ,SST1
                                
001BCC E8FD 0E01             7      LD  C,1
001BCE E8FF CD07E9          17      CALL    READY
       E902                     SETMODE:
001BD1 E902 CD38E9          17      CALL    DELAY0      ;Head select time
001BD4 E905 0E81             7      LD  C,081H
       E907                     READY:
001BD6 E907 0680             7      LD  B,128
       E909                     READY2:
001BD8 E909 DBD8            11      IN  A,(0D8H)
001BDA E90B 2F               4      CPL         ;データバスが負論理
001BDB E90C A1               4      AND C       ;NOT READY,BUSY
001BDC E90D C8              11      RET Z
001BDD E90E CD1BCF          17      CALL    RD556VSYNC
001BE0 E911 87               4      ADD A,A
001BE1 E912 30F5            12      JR  NC,READY2
       E914                     READY3:
001BE3 E914 DBD8            11      IN  A,(0D8H)
001BE5 E916 2F               4      CPL         ;データバスが負論理
001BE6 E917 A1               4      AND C       ;NOT READY,BUSY
001BE7 E918 C8              11      RET Z
001BE8 E919 CD1BCF          17      CALL    RD556VSYNC
001BEB E91C 87               4      ADD A,A
001BEC E91D 38F5            12      JR  C,READY3
001BEE E91F 10E8            13      DJNZ    READY2
001BF0 E921 37               4      SCF
001BF1 E922 C9              10      RET
                                
       E923                     FDCRES:
001BF2 E923 3600            10      LD  (HL),0
001BF4 E925 0E08             7      LD  C,8
001BF6 E927 18C0            12      JR  FDCCMD2
                                
       E929                     FDMOFF:
001BF8 E929 F5              11      PUSH    AF
001BF9 E92A AF               4      XOR A       ;Motor off(ドライブセレクト無効)
001BFA E92B D3DC            11      OUT (0DCH),A
001BFC E92D F1              10      POP AF
001BFD E92E C9              10      RET
                                
       E92F                     SECSET:
001BFE E92F F5              11      PUSH    AF
001BFF E930 7B               4      LD  A,E
001C00 E931 2F               4      CPL         ;データバスが負論理
001C01 E932 D3DA            11      OUT (0DAH),A
001C03 E934 F1              10      POP AF
       E935                     COMSET:
001C04 E935 2F               4      CPL         ;データバスが負論理
001C05 E936 D3D8            11      OUT (0D8H),A
       E938                     DELAY0:
001C07 E938 3E1A             7      LD  A,26
       E93A                     DELAY:
001C09 E93A 3D               4      DEC A
001C0A E93B 20FD            12      JR  NZ,DELAY
001C0C E93D C9              10      RET
                                
       E93E                     DRIVE:
001C0D E93E 2A84F0          16      LD  HL,(_DRIVE)
001C10 E941 26F0             7      LD  H,_CYL0/256
001C12 E943 CBFD             8      SET 7,L
001C14 E945 7E               7      LD  A,(HL)
001C15 E946 C9              10      RET
                                
       E947                     RNF:
001C16 E947 CD3EE9          17      CALL    DRIVE
001C19 E94A 36FF            10      LD  (HL),0FFH
001C1B E94C C9              10      RET
                                
001C1C E94D 02                  RETRY:  DB  2
                                
                                
                                ;   FLOPPY DISK DRIVER
                                
       E94E                     WTTRK:
001C1D E94E 0601             7      LD  B,1
001C1F E950 3EF4             7      LD  A,0F4H
001C21 E952 1802            12      JR  WTTRK1
       E954                     FDWT:
001C23 E954 3EA0             7      LD  A,0A0H
       E956                     WTTRK1:
001C25 E956 32F1E8          13      LD  (FDCSMC),A
       E959                     DWTBL:
001C28 E959 78               4      LD  A,B
001C29 E95A 3299E9          13      LD  (WTBSMC),A
001C2C E95D 3E02             7      LD  A,2     ;Retry count
001C2E E95F 324DE9          13      LD  (RETRY),A
                                
       E962                     DWT0:
001C31 E962 D5              11      PUSH    DE
001C32 E963 E5              11      PUSH    HL
001C33 E964 CDA3E8          17      CALL    SEEK        ;Write disk
001C36 E967 E1              10      POP HL
001C37 E968 383A            12      JR  C,ERRDW
001C39 E96A F3               4      DI
001C3A E96B 3AF1E8          13      LD  A,(FDCSMC)
001C3D E96E CD2FE9          17      CALL    SECSET
001C40 E971 0EDB             7      LD  C,0DBH
       E973                     DWT1:
001C42 E973 7E               7      LD  A,(HL)
001C43 E974 2F               4      CPL         ;データバスが負論理
001C44 E975 57               4      LD  D,A
                                
       E976                     DWT2:
001C45 E976 DBD8            11      IN  A,(0D8H)
001C47 E978 2F               4      CPL         ;データバスが負論理
001C48 E979 0F               4      RRCA
001C49 E97A 3008            12      JR  NC,DWT4
001C4B E97C 0F               4      RRCA
001C4C E97D 30F7            12      JR  NC,DWT2
       E97F                     DWT3:
001C4E E97F ED51            12      OUT (C),D
001C50 E981 23               6      INC HL
001C51 E982 18EF            12      JR  DWT1
                                
       E984                     DWT4:
001C53 E984 3D               4      DEC A
001C54 E985 28F8            12      JR  Z,DWT3
001C56 E987 3C               4      INC A
001C57 E988 FB               4      EI
001C58 E989 D1              10      POP DE
001C59 E98A 13               6      INC DE
001C5A E98B CD29E9          17      CALL    FDMOFF
001C5D E98E 2808            12      JR  Z,DISKOK_WT
001C5F E990 CDFBE9          17      CALL    DISKC
001C62 E993 20CD            12      JR  NZ,DWT0
001C64 E995 B7               4      OR  A
001C65 E996 2005            12      JR  NZ,ERRW
                                
       E998                     DISKOK_WT:
       E999                     WTBSMC  EQU $+1
001C67 E998 0601             7      LD  B,1
001C69 E99A 10BD            13      DJNZ    DWTBL
001C6B E99C C9              10      RET
                                
       E99D                     ERRW:
001C6C E99D 3EFF             7      LD  A,0FFH
       E99F                     ERRZ:
001C6E E99F BF               4      CP  A
001C6F E9A0 37               4      SCF
001C70 E9A1 C329E9          10      JP  FDMOFF
                                
       E9A4                     ERRDW:
001C73 E9A4 D1              10      POP DE
001C74 E9A5 CD0CEA          17      CALL    DELP
001C77 E9A8 20B8            12      JR  NZ,DWT0
001C79 E9AA B7               4      OR  A
001C7A E9AB 20F0            12      JR  NZ,ERRW
001C7C E9AD C9              10      RET
                                
       E9AE                     FDRD:
001C7D E9AE 3E80             7      LD  A,080H
001C7F E9B0 32F1E8          13      LD  (FDCSMC),A
       E9B3                     DRDBL:
001C82 E9B3 78               4      LD  A,B
001C83 E9B4 32EDE9          13      LD  (RDBSMC),A
001C86 E9B7 3E02             7      LD  A,2     ;Retry count
001C88 E9B9 324DE9          13      LD  (RETRY),A
       E9BC                     DRD0:
001C8B E9BC D5              11      PUSH    DE
001C8C E9BD E5              11      PUSH    HL
001C8D E9BE CDA3E8          17      CALL    SEEK        ;Read disk
001C90 E9C1 E1              10      POP HL
001C91 E9C2 382D            12      JR  C,ERRDR
001C93 E9C4 F3               4      DI
001C94 E9C5 3AF1E8          13      LD  A,(FDCSMC)
001C97 E9C8 CD2FE9          17      CALL    SECSET
       E9CB                     DRD1:
001C9A E9CB DBD8            11      IN  A,(0D8H)
001C9C E9CD 2F               4      CPL         ;データバスが負論理
001C9D E9CE 0F               4      RRCA
001C9E E9CF 300A            12      JR  NC,DRD3
001CA0 E9D1 0F               4      RRCA
001CA1 E9D2 30F7            12      JR  NC,DRD1
001CA3 E9D4 DBDB            11      IN  A,(0DBH)
001CA5 E9D6 2F               4      CPL         ;データバスが負論理
001CA6 E9D7 77               7      LD  (HL),A
001CA7 E9D8 23               6      INC HL
001CA8 E9D9 18F0            12      JR  DRD1
                                
       E9DB                     DRD3:
001CAA E9DB B7               4      OR  A
001CAB E9DC FB               4      EI
001CAC E9DD D1              10      POP DE
001CAD E9DE 13               6      INC DE
001CAE E9DF CD29E9          17      CALL    FDMOFF
001CB1 E9E2 2808            12      JR  Z,DISKOK_RD
001CB3 E9E4 CDFBE9          17      CALL    DISKC
001CB6 E9E7 20D3            12      JR  NZ,DRD0
001CB8 E9E9 B7               4      OR  A
001CB9 E9EA 20B1            12      JR  NZ,ERRW
                                
       E9EC                     DISKOK_RD:
       E9ED                     RDBSMC  EQU $+1
001CBB E9EC 0601             7      LD  B,1
001CBD E9EE 10C3            13      DJNZ    DRDBL
001CBF E9F0 C9              10      RET
                                
       E9F1                     ERRDR:
001CC0 E9F1 D1              10      POP DE
001CC1 E9F2 CD0CEA          17      CALL    DELP
001CC4 E9F5 20C5            12      JR  NZ,DRD0
001CC6 E9F7 B7               4      OR  A
001CC7 E9F8 20A3            12      JR  NZ,ERRW
001CC9 E9FA C9              10      RET
       E9FB                     DISKC:
001CCA E9FB 1B               6      DEC DE
001CCB E9FC CB5F             8      BIT 3,A
001CCD E9FE C447E9          17      CALL    NZ,RNF
       EA01                     DISKD:
001CD0 EA01 E5              11      PUSH    HL
001CD1 EA02 214DE9          10      LD  HL,RETRY
001CD4 EA05 35              11      DEC (HL)
001CD5 EA06 E1              10      POP HL
001CD6 EA07 200C            12      JR  NZ,ERR      ;Retry
001CD8 EA09 B7               4      OR  A
001CD9 EA0A 2809            12      JR  Z,ERR       ;Error
                                
       EA0C                     DELP:
001CDB EA0C CD47E9          17      CALL    RNF
001CDE EA0F CD29E9          17      CALL    FDMOFF
001CE1 EA12 3EFF             7      LD  A,0FFH
       EA14                     AERRZ:
001CE3 EA14 BF               4      CP  A
       EA15                     ERR:
001CE4 EA15 3EFF             7      LD  A,0FFH
001CE6 EA17 C9              10      RET
[EOF:M7DISK.ASM:SHIFT_JIS]
                                    INCLUDE "M7DISK2.ASM"
                                
                                ;   LSX-Dodgers DISK2
                                ;   MZ-700/1500
                                
                                ;   EMM DRIVER
                                ;   1セクタ可変(256/512/1024)
                                
       EA18                     EDWT:
001CE7 EA18 F5              11      PUSH    AF
001CE8 EA19 CD37EA          17      CALL    EADR
001CEB EA1C 0600             7      LD  B,0
       EA1E                     EDWT1:
001CED EA1E EDB3                    OTIR
001CEF EA20 3D               4      DEC A
001CF0 EA21 20FB            12      JR  NZ,EDWT1
001CF2 EA23 180B            12      JR  EDRW1
                                
       EA25                     EDRD:
001CF4 EA25 C5              11      PUSH    BC
001CF5 EA26 CD37EA          17      CALL    EADR
001CF8 EA29 0600             7      LD  B,0
       EA2B                     EDRD1:
001CFA EA2B EDB2                    INIR
001CFC EA2D 3D               4      DEC A
001CFD EA2E 20FB            12      JR  NZ,EDRD1
       EA30                     EDRW1:
001CFF EA30 F1              10      POP AF
001D00 EA31 83               4      ADD A,E ;セクタを進める
001D01 EA32 5F               4      LD  E,A
001D02 EA33 8A               4      ADC A,D
001D03 EA34 93               4      SUB E
001D04 EA35 57               4      LD  D,A
001D05 EA36 C9              10      RET
                                
       EA37                     EADR:
001D06 EA37 D5              11      PUSH    DE
001D07 EA38 EB               4      EX  DE,HL
001D08 EA39 78               4      LD  A,B
001D09 EA3A DD460F          19      LD  B,(IX+DPB_BPS)
       EA3D                     EADR1:              ;読み込むセクタ数と1クラスタのセクタ数を掛ける
001D0C EA3D CB18             8      RR  B
001D0E EA3F 3804            12      JR  C,EADR2
001D10 EA41 87               4      ADD A,A
001D11 EA42 29              11      ADD HL,HL
001D12 EA43 18F8            12      JR  EADR1
       EA45                     EADR2:
001D14 EA45 DD4E0D          19      LD  C,(IX+DPB_MAXSEC)
001D17 EA48 DD460C          19      LD  B,(IX+DPB_MAXCYL)
001D1A EA4B 09              11      ADD HL,BC
001D1B EA4C DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D1E EA4F ED71                    DB  0EDH,071H   ;OUT (C),0  Z80未定義命令
001D20 EA51 0C               4      INC C
001D21 EA52 ED69            12      OUT (C),L
001D23 EA54 0C               4      INC C
001D24 EA55 ED61            12      OUT (C),H
001D26 EA57 0C               4      INC C
001D27 EA58 EB               4      EX  DE,HL
001D28 EA59 D1              10      POP DE
001D29 EA5A C9              10      RET
                                
                                ;   CMOS BACKUP MEMORY DRIVER(32KB)
                                ;   1セクタ256
                                
       EA5B                     CDWT:
001D2A EA5B 78               4      LD  A,B
001D2B EA5C DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D2E EA5F ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001D30 EA61 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001D32 EA63 01FA00          10      LD  BC,000FAH
       EA66                     CDWT1:
001D35 EA66 EDB3                    OTIR            ;W)データ書き込み・アドレスカウンタ+1
001D37 EA68 13               6      INC DE
001D38 EA69 3D               4      DEC A
001D39 EA6A 20FA            12      JR  NZ,CDWT1
001D3B EA6C A7               4      AND A
001D3C EA6D C9              10      RET
                                
       EA6E                     CDRD:
001D3D EA6E 78               4      LD  A,B
001D3E EA6F DD4E13          19      LD  C,(IX+DPB_UNITNO)
001D41 EA72 ED40            12      IN  B,(C)       ;アドレスカウンタを0000にリセット
001D43 EA74 ED59            12      OUT (C),E       ;W)アドレスカウンタ上位
001D45 EA76 01F900          10      LD  BC,000F9H
       EA79                     CDRD1:
001D48 EA79 EDB2                    INIR            ;R)データ読み出し・アドレスカウンタ+1
001D4A EA7B 13               6      INC DE
001D4B EA7C 3D               4      DEC A
001D4C EA7D 20FA            12      JR  NZ,CDRD1
001D4E EA7F A7               4      AND A
001D4F EA80 C9              10      RET
                                
                                ;   RAM DISK DRIVER (64KB)
                                ;   1セクタ256
                                
       EA81                     RDWT:
001D50 EA81 3EB3             7      LD  A,0B3H      ;OTIR
001D52 EA83 1802            12      JR  RDRW
       EA85                     RDRD:
001D54 EA85 3EB2             7      LD  A,0B2H      ;INIR
       EA87                     RDRW:
001D56 EA87 3294EA          13      LD  (RDRW1+1),A
                                
001D59 EA8A 78               4      LD  A,B
001D5A EA8B 43               4      LD  B,E     ;B=アドレスカウンタ上位(X1の様な16bitのI/Oアクセス)
001D5B EA8C 0EEB             7      LD  C,0EBH
001D5D EA8E ED71            12      OUT (C),0       ;0=アドレスカウンタ下位
001D5F EA90 0D               4      DEC C       ;EA(R)データ読み出し・アドレスカウンタ+1
001D60 EA91 0600             7      LD  B,0
       EA93                     RDRW1:
001D62 EA93 EDB2                    INIR            ;自己書き換え(INIR/OTIR)
001D64 EA95 13               6      INC DE
001D65 EA96 3D               4      DEC A
001D66 EA97 20FA            12      JR  NZ,RDRW1
001D68 EA99 A7               4      AND A
001D69 EA9A C9              10      RET
                                
                                ;   G-RAM(PCG) DISK DRIVER (24KB)
                                ;   1セクタ256
                                
       EA9B                     GDWT:
001D6A EA9B C5              11      PUSH    BC
001D6B EA9C D5              11      PUSH    DE
001D6C EA9D CDC5EA          17      CALL    GADR
       EAA0                     GDWT2:
001D6F EAA0 4E               7      LD  C,(HL)
001D70 EAA1 23               6      INC HL
001D71 EAA2 EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001D72 EAA3 CDD2CF          17      CALL    WR_PCG
001D75 EAA6 23               6      INC HL
001D76 EAA7 EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001D77 EAA8 10F6            13      DJNZ    GDWT2
001D79 EAAA D1              10      POP DE
001D7A EAAB 1C               4      INC E
001D7B EAAC C1              10      POP BC
001D7C EAAD 10EC            13      DJNZ    GDWT
001D7E EAAF C9              10      RET
       EAB0                     GDRD:
001D7F EAB0 C5              11      PUSH    BC
001D80 EAB1 D5              11      PUSH    DE
001D81 EAB2 CDC5EA          17      CALL    GADR
       EAB5                     GDRD2:
001D84 EAB5 EB               4      EX  DE,HL   ;HL=PCG,DE=メモリ
001D85 EAB6 CDCACF          17      CALL    RD_PCG
001D88 EAB9 23               6      INC HL
001D89 EABA EB               4      EX  DE,HL   ;HL=メモリ,DE=PCG
001D8A EABB 71               7      LD  (HL),C
001D8B EABC 23               6      INC HL
001D8C EABD 10F6            13      DJNZ    GDRD2
001D8E EABF D1              10      POP DE
001D8F EAC0 1C               4      INC E
001D90 EAC1 C1              10      POP BC
001D91 EAC2 10EC            13      DJNZ    GDRD
001D93 EAC4 C9              10      RET
                                
       EAC5                     GADR:
001D94 EAC5 7B               4      LD  A,E
001D95 EAC6 E61F             7      AND 01FH
001D97 EAC8 C6D0             7      ADD A,0D0H
001D99 EACA 57               4      LD  D,A
001D9A EACB 7B               4      LD  A,E
001D9B EACC 07               4      RLCA
001D9C EACD 07               4      RLCA
001D9D EACE 07               4      RLCA
001D9E EACF 3C               4      INC A
001D9F EAD0 0600             7      LD  B,0
001DA1 EAD2 58               4      LD  E,B
001DA2 EAD3 C9              10      RET
[EOF:M7DISK2.ASM:UTF_8]
                                    INCLUDE "LDCCPWK.ASM"
                                
                                ;   LSX-Dodgers CCP WORK
                                
       003B                     PATHX   EQU 59
001DA3 EAD4                     PATHD:  DS  PATHX
001DDE EB0F 00                  PATHE:  DB  0
                                
       EB10                     DTA_CCP:
001DDF EB10                         DS  37
                                
       EB35                     FCB_BAT:
001E04 EB35                         DS  37
                                
001E29 EB5A 2020203C4449523E    DIRMES: DB  "   <DIR>  $"
            202024              
001E34 EB65 20667265652024      FREE:   DB  " free $"
[EOF:LDCCPWK.ASM:UTF_8]
                                    INCLUDE "M7TABLE.ASM"
                                
                                ;   LSX-Dodgers TABLE 表示関連のテーブル
                                ;   MZ-700/1500
                                
       EB6C                     AT_TABLE:
001E3B EB6C                         DS  TABLEAD-AT_TABLE
                                
       ED40                     KEY_TABLE:
00200F ED40 12081E1F1C1D5C2F        DB  12H,08H,1EH,1FH,1CH,1DH,5CH,'/'
002017 ED48 5C5E2D2030392C2E        DB  5CH,'^','-',20H,'0','9',',','.'
00201F ED50 3132333435363738        DB  '1','2','3','4','5','6','7','8'
002027 ED58 6162636465666768        DB  'a','b','c','d','e','f','g','h'
00202F ED60 696A6B6C6D6E6F70        DB  'i','j','k','l','m','n','o','p'
002037 ED68 7172737475767778        DB  'q','r','s','t','u','v','w','x'
00203F ED70 797A405B5D000000        DB  'y','z','@','[',']',00H,00H,00H
002047 ED78 001B3D09003B3A0D        DB  00H,1BH,'=',09H,00H,';',':',0DH
       ED80                     SHIFT_TABLE:
00204F ED80 12081E1F1C1D5F3F        DB  12H,08H,1EH,1FH,1CH,1DH,'_','?'
002057 ED88 7C7E3D2030293C3E        DB  '|','~','=',20H,'0',')','<','>'
00205F ED90 2122232425262728        DB  '!','"','#','$','%','&',27H,'('
002067 ED98 4142434445464748        DB  'A','B','C','D','E','F','G','H'
00206F EDA0 494A4B4C4D4E4F50        DB  'I','J','K','L','M','N','O','P'
002077 EDA8 5152535455565758        DB  'Q','R','S','T','U','V','W','X'
00207F EDB0 595A607B7D000000        DB  'Y','Z','`','{','}',00H,00H,00H
002087 EDB8 00003D09002B2A0D        DB  00H,00H,'=',09H,00H,'+','*',0DH
       EDC0                     CTRL_TABLE:
00208F EDC0 12081E1F1C1D3F2F        DB  12H,08H,1EH,1FH,1CH,1DH,'?','/'
002097 EDC8 2A2B2D2030392C2E        DB  '*','+','-',20H,'0','9',',','.'
00209F EDD0 3132333435363738        DB  '1','2','3','4','5','6','7','8'
0020A7 EDD8 0102030405060708        DB  01H,02H,03H,04H,05H,06H,07H,08H
0020AF EDE0 090A0B0C0D0E0F10        DB  09H,0AH,0BH,0CH,0DH,0EH,0FH,10H
0020B7 EDE8 1112131415161718        DB  11H,12H,13H,14H,15H,16H,17H,18H
0020BF EDF0 191A1B5B5D000000        DB  19H,1AH,1BH,'[',']',00H,00H,00H
0020C7 EDF8 00003D09003B3A0D        DB  00H,00H,'=',09H,00H,';',':',0DH
                                
                                ;   アドレス下位1バイトが0になるように
       EE00                     CD_TABLE:
0020CF EE00 00D1D2D3D4D5D6D0        DB  $00,$D1,$D2,$D3,$D4,$D5,$D6,$D0 ;月火水木金土日
0020D7 EE08 D8DCD9DADBD7CFCE        DB  $D8,$DC,$D9,$DA,$DB,$D7,$CF,$CE ;年円時分秒
0020DF EE10 601F5F5E1E1B7978        DB  $60,$1F,$5F,$5E,$1E,$1B,$79,$78 ;
0020E7 EE18 5C5D1C1D6DCACDC7        DB  $5C,$5D,$1C,$1D,$6D,$CA,$CD,$C7 ;
0020EF EE20 0061626364656667        DB  $00,$61,$62,$63,$64,$65,$66,$67 ; !"#$%&'
0020F7 EE28 68696B6A2F2A2E2D        DB  $68,$69,$6B,$6A,$2F,$2A,$2E,$2D ;()*+,-./
0020FF EE30 2021222324252627        DB  $20,$21,$22,$23,$24,$25,$26,$27 ;01234567
002107 EE38 28294F2C512B5749        DB  $28,$29,$4F,$2C,$51,$2B,$57,$49 ;89:;<=>?
00210F EE40 5501020304050607        DB  $55,$01,$02,$03,$04,$05,$06,$07 ;@ABCDEFG
002117 EE48 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;HIJKLMNO
00211F EE50 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;PQRSTUVW
002127 EE58 18191A52DD54507C        DB  $18,$19,$1A,$52,$DD,$54,$50,$7C ;XYZ[\]^_
00212F EE60 5901020304050607        DB  $59,$01,$02,$03,$04,$05,$06,$07 ;`abcdefg   ATB:1
002137 EE68 08090A0B0C0D0E0F        DB  $08,$09,$0A,$0B,$0C,$0D,$0E,$0F ;hijklmno   ATB:1
00213F EE70 1011121314151617        DB  $10,$11,$12,$13,$14,$15,$16,$17 ;pqrstuvw   ATB:1
002147 EE78 18191ACB35CC705A        DB  $18,$19,$1A,$CB,$35,$CC,$70,$5A ;xyz{|}~    ATB:1
00214F EE80 415346444847B49E        DB  $41,$53,$46,$44,$48,$47,$B4,$9E ;トランプ〇●をぁ   ATB:1
002157 EE88 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ぃぅぇぉゃゅょっ   ATB:1
00215F EE90 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーあいうえおかき   ATB:1
002167 EE98 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;くけこさしすせそ   ATB:1
00216F EEA0 F0BD9DB1B5B9B49E        DB  $F0,$BD,$9D,$B1,$B5,$B9,$B4,$9E ;　。「」、・ヲァ
002177 EEA8 B2B6BABE9FB3B7BB        DB  $B2,$B6,$BA,$BE,$9F,$B3,$B7,$BB ;ィゥェォャョュッ
00217F EEB0 BFA385A4A5A69487        DB  $BF,$A3,$85,$A4,$A5,$A6,$94,$87 ;ーアイウエオカキ
002187 EEB8 889C829884929083        DB  $88,$9C,$82,$98,$84,$92,$90,$83 ;クケコサシスセソ
00218F EEC0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;タチツテトナニヌ
002197 EEC8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ネノハヒフヘホマ
00219F EED0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;ミムメモヤユヨラ
0021A7 EED8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;リルレロワン゛゜
0021AF EEE0 91819A97939589A1        DB  $91,$81,$9A,$97,$93,$95,$89,$A1 ;たちつてとねにぬ   ATB:1
0021B7 EEE8 AF8B8696A2ABAA8A        DB  $AF,$8B,$86,$96,$A2,$AB,$AA,$8A ;ねのはひふへほま   ATB:1
0021BF EEF0 8EB0AD8DA7A8A98F        DB  $8E,$B0,$AD,$8D,$A7,$A8,$A9,$8F ;みむめもやゆよら   ATB:1
0021C7 EEF8 8CAEAC9BA099BCB8        DB  $8C,$AE,$AC,$9B,$A0,$99,$BC,$B8 ;りるれろわん゛゜   ATB:1
       EF00                     DC_TABLE:
0021CF EF00 2041424344454647        DB  $20,$41,$42,$43,$44,$45,$46,$47 ;0
0021D7 EF08 48494A4B4C4D4E4F        DB  $48,$49,$4A,$4B,$4C,$4D,$4E,$4F
0021DF EF10 5051525354555657        DB  $50,$51,$52,$53,$54,$55,$56,$57 ;1
0021E7 EF18 58595A151A1B1411        DB  $58,$59,$5A,$15,$1A,$1B,$14,$11
0021EF EF20 3031323334353637        DB  $30,$31,$32,$33,$34,$35,$36,$37 ;2
0021F7 EF28 38392D3D3B2F2E2C        DB  $38,$39,$2D,$3D,$3B,$2F,$2E,$2C
0021FF EF30 00000000007C0000        DB  $00,$00,$00,$00,$00,$7C,$00,$00 ;3
002207 EF38 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
00220F EF40 0080000083008285        DB  $00,$80,$00,$00,$83,$00,$82,$85 ;4
002217 EF48 843F00000000003A        DB  $84,$3F,$00,$00,$00,$00,$00,$3A
00221F EF50 5E3C5B815D40003E        DB  $5E,$3C,$5B,$81,$5D,$40,$00,$3E ;5
002227 EF58 00607F0018191312        DB  $00,$60,$7F,$00,$18,$19,$13,$12
00222F EF60 1021222324252627        DB  $10,$21,$22,$23,$24,$25,$26,$27 ;6
002237 EF68 28292B2A001C0000        DB  $28,$29,$2B,$2A,$00,$1C,$00,$00
00223F EF70 7E00000000000000        DB  $7E,$00,$00,$00,$00,$00,$00,$00 ;7
002247 EF78 171600005F000000        DB  $17,$16,$00,$00,$5F,$00,$00,$00
00224F EF80 00C19A9F9C92CA97        DB  $00,$C1,$9A,$9F,$9C,$92,$CA,$97 ;8
002257 EF88 98C6CFC9D8D3D0D7        DB  $98,$C6,$CF,$C9,$D8,$D3,$D0,$D7
00225F EF90 9EC09DC496C5CBC3        DB  $9E,$C0,$9D,$C4,$96,$C5,$CB,$C3 ;9
002267 EF98 9BDDC2DB99A2878C        DB  $9B,$DD,$C2,$DB,$99,$A2,$87,$8C
00226F EFA0 DCC7CC91939495D4        DB  $DC,$C7,$CC,$91,$93,$94,$95,$D4 ;A
002277 EFA8 D5D6CECDDAD2D9C8        DB  $D5,$D6,$CE,$CD,$DA,$D2,$D9,$C8
00227F EFB0 D1A3888D86A4898E        DB  $D1,$A3,$88,$8D,$86,$A4,$89,$8E ;B
002287 EFB8 DFA58A8FDEA18B90        DB  $DF,$A5,$8A,$8F,$DE,$A1,$8B,$90
00228F EFC0 000000000000001F        DB  $00,$00,$00,$00,$00,$00,$00,$1F ;C
002297 EFC8 00001D7B7D1E0F0E        DB  $00,$00,$1D,$7B,$7D,$1E,$0F,$0E
00229F EFD0 070102030405060D        DB  $07,$01,$02,$03,$04,$05,$06,$0D ;D
0022A7 EFD8 080A0B0C095C0000        DB  $08,$0A,$0B,$0C,$09,$5C,$00,$00
0022AF EFE0 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00 ;E
0022B7 EFE8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
0022BF EFF0 A000000000000000        DB  $A0,$00,$00,$00,$00,$00,$00,$00 ;F
0022C7 EFF8 0000000000000000        DB  $00,$00,$00,$00,$00,$00,$00,$00
[EOF:M7TABLE.ASM:SHIFT_JIS]
                                    INCLUDE "LDWORK.ASM"
                                
                                ;   LSX-Dodgers WORK0
                                ;
                                ;   CP/M互換BIOS
                                ;   BOOT:アドレス下位1バイトが0になるように
       F000                     AT_WORK:
0022CF F000                         DS  WORKAD-AT_WORK
                                
       F000                     CPM_BOOT:
0022CF F000 C30000          10      JP  0
       F003                     _SYS00:     ;(BDOS)プログラム終了
       F003                     CPM_WBOOT:
0022D2 F003 C3FECF          10      JP  WBOOT1
       F006                     CPM_CONST:
0022D5 F006 C3A2D7          10      JP  CONSTX
       F009                     _SYS07:     ;(BDOS)コンソール直接入力
       F009                     CPM_CONIN:
0022D8 F009 C334D7          10      JP  FLGET
       F00C                     CPM_CONOUT:
0022DB F00C C343D9          10      JP  CONOUT1
                                
       F00F                     DECBF:              ;10進数表示時のバッファ(5バイト)
0022DE F00F                         DS  5
       F00F                     RR_BUF_HL   EQU DECBF   ;CP/M互換ファイルアクセスの際のランダムレコードの一時的な保管場所
       F011                     RR_BUF_A    EQU DECBF+2 ;計3バイト
                                
0022E3 F014 00                  FDRV:   DB  0
0022E4 F015                     FNAME:  DS  36
002308 F039                     SFILE:  DS  33      ;DRV FILENAME
                                
002329 F05A                         DS  3
                                
00232C F05D 0000                LEFTX:  DW  0
00232E F05F 0000                DTAX:   DW  0
                                
       F061                     ZERO:
       F061                     BEEPD:
002330 F061 008E01000B000C10        DB  0,08EH,1,0,00BH,0,00CH,010H
002338 F069 073E08100D00FF          DB  007H,03EH,008H,010H,00DH,0,0FFH
       F062                     RTC_YY  EQU BEEPD+1
       F063                     RTC_MW  EQU BEEPD+2
       F064                     RTC_DD  EQU BEEPD+3
       F065                     RTC_TT  EQU BEEPD+4
       F066                     RTC_MM  EQU BEEPD+5
       F067                     RTC_SS  EQU BEEPD+6
       F062                     ROM_SLT EQU BEEPD+1
                                
00233F F070 00                  CHECK:  DB  0
                                
002340 F071 4F4B24              OK: DB  "OK$"
002343 F074                         DS  5
002348 F079 4572726F722124      COMERM: DB  "Error!$"
                                ;   システムワークエリア
                                ;   _CYL0:アドレス下位1バイトが080Hになるように
00234F F080 FF                  _CYL0:  DB  0FFH    ;Cylinder
002350 F081 FF                  _CYL1:  DB  0FFH    ;Cylinder
002351 F082 FF                  _CYL2:  DB  0FFH    ;Cylinder
002352 F083 FF                  _CYL3:  DB  0FFH    ;Cylinder
002353 F084 00                  _DRIVE: DB  0   ;unit number
002354 F085 00                  _SEEKSP:DB  0   ;Seek speed
002355 F086 FF                  _ISEEK: DB  0FFH    ;
002356 F087 00                  _DVSW:  DB  0
002357 F088 00                  _DRV:   DB  0
002358 F089 FF                  _DSK:   DB  0FFH
002359 F08A 8000                _DTA:   DW  00080H
00235B F08C 0000                _CTC:   DW  0
00235D F08E 0000                _TXADR: DW  0
00235F F090 0000                _KEYPS: DW  0
002361 F092 00FF                _KEYD:  DW  0FF00H  ;キーデータ
002363 F094 8310                _KEYSP: DB  KEYSP_L,KEYSP_H ;オートリピートの速度
002365 F096 70                  _COLORF:DB  COLORF  ;色
002366 F097 19                  _LINE:  DB  LINE
                                
002367 F098 0000                _FCB:   DW  0   ;SEARCH FILES
002369 F09A 0000                _FBPS:  DW  0   ;    //
00236B F09C 0000                _FBAD:  DW  0   ;    //
00236D F09E 00                  _FBCNT: DB  0   ;    //
00236E F09F 00                  _FILEN: DB  0   ;    //
00236F F0A0 00                  _DIRF:  DB  0   ;bit7:ディレクトリ bit0-6:セクタインデックス
002370 F0A1                         DS  1
002371 F0A2 00                  _WTFATF:DB  0   ;FATバッファの更新フラグ
002372 F0A3                         DS  1
002373 F0A4 00                  _WTDBF: DB  0   ;データバッファの更新フラグ
002374 F0A5 FF                  _DBDRV: DB  0FFH    ;データバッファにあるデータを読み込んだドライブ
002375 F0A6 0000                _DBSEC: DW  0   ;データバッファにあるデータを読み込んだセクタ番号
002377 F0A8 0000                _DPB:   DW  0
       F0AA                     _FATDRV:
002379 F0AA FF                      DB  0FFH    ;FATバッファに読み込んでいるドライブ
00237A F0AB 00                  _FATIX: DB  0   ;FATバッファに読み込んでいるインデックス
       F0AC                     _FAKEFREE:
00237B F0AC 0000                    DW  0   ;偽の残量（FATサイズが大きくなると重くなるのでその対策）
                                
00237D F0AE                         DS  2
                                
       F0B0                     CRTCD:
00237F F0B0 6F                      DB  06FH
       F0B1                     _WIDTH:
002380 F0B1 28                      DB  WIDTH
       F0B2                     TVRAMTOP:
002381 F0B2 5938                    DB  059H,038H
002383 F0B4 1F02                    DB  01FH,002H
       F0B6                     _LINE2:
002385 F0B6 19                      DB  019H
       F0B7                     WKE4:
002386 F0B7 1C                      DB  01CH
       F0B8                     WKE6:
002387 F0B8 00                      DB  000H
       F0B9                     WK40:
002388 F0B9 07                      DB  007H
       F0BA                     _PAGE_MINUS:
002389 F0BA 18FC                    DW  0-WIDTH*LINE
       F0BC                     _WIDTH_MINUS:
00238B F0BC D8FF                    DW  0-WIDTH
       F0BE                     WK30:
00238D F0BE 0C                      DB  00CH
       F0BF                     WK31:
       F0BF                     WK1FD0:
00238E F0BF 20                      DB  020H
                                
00238F F0C0 0000                CTC0:   DW  INTCTCE
002391 F0C2 0000                CTC1:   DW  INTCTCE
002393 F0C4 0000                CTC2:   DW  INTCTCE
002395 F0C6 0000                CTC3:   DW  INTCTCE
002397 F0C8 0000                INTVEC: DW  INT
                                
                                ;   LSX-Dodgers 独自BIOS
                                
002399 F0CA C38ADA          10  _INKEY: JP  INKEY
00239C F0CD C32FD8          10  _PRINT: JP  PRINT
00239F F0D0 C3FEDA          10  _SCRN:  JP  SCRN
0023A2 F0D3 C3ECD9          10  _POS:   JP  POS
0023A5 F0D6 C311D9          10  _LOC:   JP  LOC
       F0D9                     _CHGDRV:
0023A8 F0D9 C3ABE7          10      JP  CHGDRV
       F0DC                     _GETDPB:
0023AB F0DC C36AE8          10      JP  GETDPB
       F0DF                     _FFLUSH:
0023AE F0DF C388E8          10      JP  FFLUSH
       F0E2                     _RDFATX:
0023B1 F0E2 C384E4          10      JP  RDFATX
0023B4 F0E5 C3ACE5          10  _RDFAT: JP  RDFAT
0023B7 F0E8 C34EE9          10  _WTTRK: JP  WTTRK
0023BA F0EB C3AEE9          10  _FDRD:  JP  FDRD
0023BD F0EE C354E9          10  _FDWT:  JP  FDWT
       F0F1                     _BPB2DPB:
0023C0 F0F1 C339E6          10      JP  BPB2DPB
       F0F4                     _BREAK:
0023C3 F0F4 C391D1          10      JP  END_BATCH
       F0F7                     _GNCL:
0023C6 F0F7 C326E5          10      JP  GNCL        ; self-modifying code
       F0F8                     GNCPAT  EQU $-2
       F0FA                     _SNCL:
0023C9 F0FA C349E5          10      JP  SNCL        ; self-modifying code
       F0FB                     SNCPAT  EQU $-2
0023CC F0FD C34AD0          10  _COMANL:JP  COMANL
                                
       F100                     _WE:
[EOF:LDWORK.ASM:SHIFT_JIS]
                                    INCLUDE "LDCALL.ASM"
                                
                                ;   LSX-Dodgers システムコール(BDOS)
                                ;
                                ;   LSX-Dodgers SYSTEM CALL
                                ;   STABLE:アドレス下位1バイトが0になるように
                                
       F100                     STABLE:
                                ;0
0023CF F100 03F00BD717D7DFDC        DW  _SYS00,_SYS01,_SYS02,_SYS03
0023D7 F108 76D476D41CD709F0        DW  _SYS04,_SYS05,_SYS06,_SYS07
0023DF F110 24D778D46AD796D7        DW  _SYS08,_SYS09,_SYS0A,_SYS0B
0023E7 F118 8DD492D4A1D4B2D4        DW  _SYS0C,_SYS0D,_SYS0E,_SYS0F
                                ;1
0023EF F120 06D54DD596D5C7D5        DW  _SYS10,_SYS11,_SYS12,_SYS13
0023F7 F128 CFD5E5D5FAD5F2D5        DW  _SYS14,_SYS15,_SYS16,_SYS17
0023FF F130 41D646D64BD651D6        DW  _SYS18,_SYS19,_SYS1A,_SYS1B
002407 F138 76D477D676D47BD6        DW  _SYS1C,_SYS1D,_SYS1E,_SYS1F
                                ;2
00240F F140 76D431D639D682D6        DW  _SYS20,_SYS21,_SYS22,_SYS23
002417 F148 A8D676D458E130E2        DW  _SYS24,_ERROR,_SYS26,_SYS27
00241F F150 39D6B1D6ACD7DFDC        DW  _SYS28,_SYS29,_SYS2A,_SYS2B
002427 F158 B2D7DFDC76D4D2D6        DW  _SYS2C,_SYS2D,_SYS2E,_SYS2F
                                ;3
00242F F160 CCD676D476D476D4        DW  _SYS30,_ERROR,_ERROR,_ERROR
002437 F168 76D476D476D476D4        DW  _ERROR,_ERROR,_ERROR,_ERROR
00243F F170 76D4DFDCDFDCF3D6        DW  _ERROR,_SYS39,_SYS3A,_SYS5A
                                ;DOS2
002447 F178 59D4                    DW  _DOS2
                                
002449 F17A                         DS  2
00244B F17C 00F3                _FATBF: DW  FATBF
00244D F17E 00FB                _DTBUF: DW  DTBUF
                                
                                ;   コントロールコードテーブル
                                ;   CTRLTB:アドレス下位1バイトが080Hになるように
                                
       F180                     CTRLTB:
00244F F180 94D894D8CAD8BFD9        DW  CTRL00,CTRL00,CTRL02,CTRL03 ;  A,B,C
002457 F188 B9D9F6D8AAD953D9        DW  CTRL04,CTRL05,CTRL06,CTRL07 ;D,E,F,G
00245F F190 A0D8BBD8C2D924D9        DW  CTRL08,CTRL09,CTRL0A,CTRL0B ;H,I,J,K
002467 F198 A7D90CD9D4D994D8        DW  CTRL0C,CTRL0D,CTRL0E,CTRL00 ;L,M,N,O
00246F F1A0 94D894D81CD994D8        DW  CTRL00,CTRL00,CTRL12,CTRL00 ;P,Q,R,S
002477 F1A8 94D894D894D894D8        DW  CTRL00,CTRL00,CTRL00,CTRL00 ;T,U,V,W
00247F F1B0 94D894D8A7D92BD9        DW  CTRL00,CTRL00,CTRL0C,CTRL1B ;X,Y,Z,ESC
002487 F1B8 83D8A7D8B0D8C2D9        DW  CTRL1C,CTRL1D,CTRL1E,CTRL1F ;→,←,↑,↓
                                
00248F F1C0 0200                M2D:    DW  2
002491 F1C2 FD02                    DB  0FDH,2
002493 F1C4 6401                    DW  356
002495 F1C6 FF0728090182            DB  0FFH,7,40,9,1,082H
00249B F1CC 0500A7000800            DW  5,0A7H,8
                                
0024A1 F1D2 0200                M2HD:   DW  2
0024A3 F1D4 FE01                    DB  0FEH,1
0024A5 F1D6 C704                    DW  1223
0024A7 F1D8 FE064D080184            DB  0FEH,6,77,8,1,084H
0024AD F1DE 0500A7000900            DW  5,0A7H,9
                                
0024B3 F1E4 1617                SDDATA: DB  22,23       ;(FCB)ファイルを最後に変更した時刻
0024B5 F1E6 1415                    DB  20,21       ;(FCB)ファイルを最後に変更した日付
0024B7 F1E8 1A1B                    DB  26,27       ;(FCB)ファイルの先頭クラスタ
0024B9 F1EA 10111213                DB  16,17,18,19 ;(FCB)ファイルのサイズ(バイト単位)
       F1EE                     SDDATAE:
                                
0024BD F1EE                         DS  2
       F1F0                     _FCB_BAT:
0024BF F1F0 35EB                    DW  FCB_BAT
       F1F2                     _PATH:
0024C1 F1F2 D4EA                    DW  PATHD
                                
0024C3 F1F4                     SCDIR:  DS  2       ;+14 +15
0024C5 F1F6                     SFBPS:  DS  2       ;FBPS
0024C7 F1F8                     SFNDF:  DS  2       ;FILEN DIRF
                                
0024C9 F1FA 0000                _FATPS: DW  0
0024CB F1FC 0000                _DIRPS: DW  0
0024CD F1FE 0000                _CLPS:  DW  0
                                
       F200                     _PE:
[EOF:LDCALL.ASM:SHIFT_JIS]
                                    INCLUDE "M7DPB.ASM"
                                
                                ;   LSX-Dodgers DPB
                                ;   MZ-700/1500
                                
       F200                     _DEVICE:
                                
                                ;   A:
                                
0024CF F200 0200                    DW  2   ;DPB_FATLN
0024D1 F202 EBF0                    DW  _FDRD   ;DPB_DRD
0024D3 F204 EEF0                    DW  _FDWT   ;DPB_DWT
0024D5 F206 FD                      DB  0FDH    ;DPB_FATID
0024D6 F207 02                      DB  2   ;DPB_SECPCL
0024D7 F208 6401                    DW  356 ;DPB_MAXCL
0024D9 F20A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
0024DA F20B 07                      DB  7   ;DPB_DIRSCNT
0024DB F20C 28                      DB  40  ;DPB_MAXCYL
0024DC F20D 09                      DB  9   ;DPB_MAXSEC Number of sectors
0024DD F20E 01                      DB  1   ;DPB_FATPS
0024DE F20F 82                      DB  082H    ;DPB_BPS
0024DF F210 0500                    DW  5   ;DPB_DIRPS
0024E1 F212 27                      DB  027H    ;DPB_DEVICE Device Number
0024E2 F213 00                      DB  0   ;DPB_UNITNO
0024E3 F214 0800                    DW  8   ;DPB_ADDCL
0024E5 F216 0000                    DW  0   ;DPB_16
0024E7 F218 0000                    DW  0   ;DPB_18
0024E9 F21A 0000                    DW  0   ;DPB_SDIR
0024EB F21C 46444430                DB  "FDD0"  ;DPB_NAME
                                
                                ;   B:
                                
0024EF F220 0200                    DW  2   ;DPB_FATLN
0024F1 F222 EBF0                    DW  _FDRD   ;DPB_DRD
0024F3 F224 EEF0                    DW  _FDWT   ;DPB_DWT
0024F5 F226 FD                      DB  0FDH    ;DPB_FATID
0024F6 F227 02                      DB  2   ;DPB_SECPCL
0024F7 F228 6401                    DW  356 ;DPB_MAXCL
0024F9 F22A FF                      DB  0FFH    ;DPB_FDMODE 0FFH=2D / 0FEH=2HD
0024FA F22B 07                      DB  7   ;DPB_DIRSCNT
0024FB F22C 28                      DB  40  ;DPB_MAXCYL
0024FC F22D 09                      DB  9   ;DPB_MAXSEC Number of sectors
0024FD F22E 01                      DB  1   ;DPB_FATPS
0024FE F22F 82                      DB  082H    ;DPB_BPS
0024FF F230 0500                    DW  5   ;DPB_DIRPS
002501 F232 27                      DB  027H    ;DPB_DEVICE Device Number
002502 F233 01                      DB  1   ;DPB_UNITNO
002503 F234 0800                    DW  8   ;DPB_ADDCL
002505 F236 0000                    DW  0   ;DPB_16
002507 F238 0000                    DW  0   ;DPB_18
002509 F23A 0000                    DW  0   ;DPB_SDIR
00250B F23C 46444431                DB  "FDD1"  ;DPB_NAME
                                
                                ;   C:
                                
00250F F240 0100                    DW  1   ;DPB_FATLN
002511 F242 6EEA                    DW  CDRD    ;DPB_DRD
002513 F244 5BEA                    DW  CDWT    ;DPB_DWT
002515 F246 FA                      DB  0FAH    ;DPB_FATID
002516 F247 01                      DB  1   ;DPB_SECPCL
002517 F248 7A00                    DW  122 ;DPB_MAXCL
002519 F24A 00                      DB  0   ;DPB_FDMODE
00251A F24B 06                      DB  6   ;DPB_DIRSCNT
00251B F24C 00                      DB  0   ;DPB_MAXCYL
00251C F24D 00                      DB  0   ;DPB_MAXSEC
00251D F24E 01                      DB  1   ;DPB_FATPS
00251E F24F 01                      DB  1   ;DPB_BPS
00251F F250 0200                    DW  2   ;DPB_DIRPS
002521 F252 0C                      DB  00CH    ;DPB_DEVICE
002522 F253 F8                      DB  0F8H    ;DPB_UNITNO
002523 F254 0600                    DW  6   ;DPB_ADDCL
002525 F256 0000                    DW  0   ;DPB_16
002527 F258 0000                    DW  0   ;DPB_18
002529 F25A 0000                    DW  0   ;DPB_SDIR
00252B F25C 434D4F53                DB  "CMOS"  ;DPB_NAME
                                
                                ;   D:
                                
00252F F260                         DS  32
                                
                                ;   E:
                                
       F280                     EMMFL:
00254F F280 0000                    DW  0   ;DPB_FATLN
002551 F282 25EA                    DW  EDRD    ;DPB_DRD
002553 F284 18EA                    DW  EDWT    ;DPB_DWT
002555 F286 FA                      DB  0FAH    ;DPB_FATID
002556 F287 02                      DB  2   ;DPB_SECPCL
002557 F288 0000                    DW  0   ;DPB_MAXCL
002559 F28A 00                      DB  0   ;DPB_FDMODE
00255A F28B 10                      DB  16  ;DPB_DIRSCNT
00255B F28C 00                      DB  0   ;DPB_MAXCYL
00255C F28D 00                      DB  0   ;DPB_MAXSEC
00255D F28E 01                      DB  1   ;DPB_FATPS
00255E F28F 01                      DB  1   ;DPB_BPS
00255F F290 0000                    DW  0   ;DPB_DIRPS
002561 F292 26                      DB  026H    ;DPB_DEVICE
002562 F293 00                      DB  0   ;DPB_UNITNO
002563 F294 0000                    DW  0   ;DPB_ADDCL
002565 F296 0000                    DW  0   ;DPB_16
002567 F298 0000                    DW  0   ;DPB_18
002569 F29A 0000                    DW  0   ;DPB_SDIR
00256B F29C 454D4D30                DB  "EMM0"  ;DPB_NAME
                                
                                ;   F:
                                
00256F F2A0 0200                    DW  2   ;DPB_FATLN
002571 F2A2 85EA                    DW  RDRD    ;DPB_DRD
002573 F2A4 81EA                    DW  RDWT    ;DPB_DWT
002575 F2A6 FA                      DB  0FAH    ;DPB_FATID
002576 F2A7 01                      DB  1   ;DPB_SECPCL
002577 F2A8 F600                    DW  246 ;DPB_MAXCL
002579 F2AA 00                      DB  0   ;DPB_FDMODE
00257A F2AB 09                      DB  9   ;DPB_DIRSCNT
00257B F2AC 00                      DB  0   ;DPB_MAXCYL
00257C F2AD 00                      DB  0   ;DPB_MAXSEC
00257D F2AE 01                      DB  1   ;DPB_FATPS
00257E F2AF 01                      DB  1   ;DPB_BPS
00257F F2B0 0300                    DW  3   ;DPB_DIRPS
002581 F2B2 0F                      DB  00FH    ;DPB_DEVICE
002582 F2B3 00                      DB  0   ;DPB_UNITNO
002583 F2B4 0A00                    DW  10  ;DPB_ADDCL
002585 F2B6 0000                    DW  0   ;DPB_16
002587 F2B8 0000                    DW  0   ;DPB_18
002589 F2BA 0000                    DW  0   ;DPB_SDIR
00258B F2BC 52414D46                DB  "RAMF"  ;DPB_NAME
                                
                                ;   G:
       F2C0                     GRAMFL:
00258F F2C0 0100                    DW  1   ;DPB_FATLN
002591 F2C2 B0EA                    DW  GDRD    ;DPB_DRD
002593 F2C4 9BEA                    DW  GDWT    ;DPB_DWT
002595 F2C6 FA                      DB  0FAH    ;DPB_FATID
002596 F2C7 01                      DB  1   ;DPB_SECPCL
002597 F2C8 5A00                    DW  90  ;DPB_MAXCL
002599 F2CA 00                      DB  0   ;DPB_FDMODE
00259A F2CB 06                      DB  6   ;DPB_DIRSCNT
00259B F2CC 00                      DB  0   ;DPB_MAXCYL
00259C F2CD 00                      DB  0   ;DPB_MAXSEC
00259D F2CE 01                      DB  1   ;DPB_FATPS
00259E F2CF 01                      DB  1   ;DPB_BPS
00259F F2D0 0200                    DW  2   ;DPB_DIRPS
0025A1 F2D2 05                      DB  005H    ;DPB_DEVICE
0025A2 F2D3 F8                      DB  0F8H    ;DPB_UNITNO
0025A3 F2D4 0600                    DW  6   ;DPB_ADDCL
0025A5 F2D6 0000                    DW  0   ;DPB_16
0025A7 F2D8 0000                    DW  0   ;DPB_18
0025A9 F2DA 0000                    DW  0   ;DPB_SDIR
0025AB F2DC 4752414D                DB  "GRAM"  ;DPB_NAME
                                
                                ;   H:
0025AF F2E0                         DS  3
0025B2 F2E3 00                      DB  0
[EOF:M7DPB.ASM:UTF_8]
                                
       A5B3                         ORG $$+OFFSET   ;$DEPHASE
       A5B3                     LAST_ADR:
                                
                                    END
[EOF:M7.ASM:UTF_8]
